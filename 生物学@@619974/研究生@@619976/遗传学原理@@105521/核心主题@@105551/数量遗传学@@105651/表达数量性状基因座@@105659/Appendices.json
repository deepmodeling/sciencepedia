{"hands_on_practices": [{"introduction": "理解一个复杂统计模型的最佳方式之一是从头开始构建它。这项实践将指导您通过模拟从基因型到基因表达的完整数据生成过程，从而亲手构建一个eQTL的“玩具宇宙”。通过在一个我们预知真实遗传效应的环境中进行实验，您可以直观地探索效应大小、等位基因频率和混杂因素如何共同影响我们发现eQTL的能力，为处理真实世界数据的复杂性奠定坚实的基础。[@problem_id:2810343]", "problem": "要求您编写一个完整、可运行的程序，该程序在一个有原则的遗传模型下模拟基因型和基因表达数据，以估计一组预设情景中表达数量性状基因座 (eQTLs) 的发现率。您的程序必须从遗传学和统计学的基础知识出发，实现以下内容，不得假定任何专门的、预先推导的 eQTL 特定公式。\n\n您必须使用的基础依据是：\n- 孟德尔遗传与哈迪-温伯格平衡 (HWE)：在一个随机交配、无近亲繁殖且次要等位基因频率 (MAF) 为 $p$ 的群体中，基因型剂量 $X \\in \\{0,1,2\\}$ 服从 $X \\sim \\mathrm{Binomial}(2,p)$。\n- 中心法则：DNA 序列的变异可以影响信使核糖核酸 (mRNA) 的丰度，使基因表达成为一个数量性状。\n- 数量性状的线性高斯模型：对于具有加性效应的单个遗传变异，基因表达 $Y$ 建模为 $Y = \\mu + \\beta X + \\text{covariates} + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0,\\sigma^2)$。\n- 普通最小二乘法 (OLS)：给定设计矩阵 $D$ 和响应向量 $Y$，OLS 估计量为 $\\hat{\\theta} = (D^\\top D)^{-1}D^\\top Y$；方差估计量为 $\\hat{\\sigma}^2 = \\mathrm{RSS}/(n - p)$，其中 $\\mathrm{RSS} = \\lVert Y - D\\hat{\\theta}\\rVert_2^2$，$p$ 是 $D$ 的列数。系数的检验统计量为 $t = \\hat{\\theta}_j/\\mathrm{SE}(\\hat{\\theta}_j)$，其中 $\\mathrm{SE}(\\hat{\\theta}_j) = \\sqrt{\\hat{\\sigma}^2[(D^\\top D)^{-1}]_{jj}}$，该统计量与具有 $n-p$ 个自由度的学生t分布进行比较，以产生双侧p值。\n\n模拟的建模假设：\n- 作为混杂因素的群体分层由一个二元组别指示符 $G \\in \\{0,1\\}$ 表示，其中 $\\mathbb{P}(G=1)=\\pi$。MAF 因组别而异：如果 $G_i=0$，则 $X_i \\sim \\mathrm{Binomial}(2,p_0)$；如果 $G_i=1$，则 $X_i \\sim \\mathrm{Binomial}(2,p_1)$，在个体间相互独立。因此，边际等位基因频率是一个混合体 $p = (1-\\pi)p_0 + \\pi p_1$，并且哈迪-温伯格平衡在每个组内成立。\n- 个体 $i$ 的基因表达生成如下\n$$\nY_i = \\mu + \\beta X_i + \\gamma G_i + \\varepsilon_i,\\quad \\varepsilon_i \\sim \\mathcal{N}(0,\\sigma^2),\n$$\n式中 $\\mu=0$ 和 $\\sigma^2=1$ 在以下测试套件的所有情景中保持固定。项 $\\gamma G_i$ 模拟了表达中的组特异性偏移，当 $G$ 通过不同的 MAF 与 $X$ 相关时，如果不对此项进行建模，可能会对基因型效应检验造成混杂。\n- 为了进行发现，您必须拟合一个 OLS 线性模型，并使用双侧 t 检验在名义显著性水平 $\\alpha = 0.05$ 下检验原假设 $H_0:\\beta=0$。每个情景有两种分析选择：要么将 $G$ 作为协变量包含在设计矩阵中（$D$ 的列为 $[1, G, X]$），要么省略 $G$（$D$ 的列为 $[1, X]$）。在这两种情况下，都必须始终包含一个全为1的截距列。\n\n估计发现率的蒙特卡罗方案：\n- 对于每个情景，生成 $R$ 个独立数据集，每个数据集包含 $n$ 个如上所述模拟的独立个体，并计算该次重复实验中 $\\hat{\\beta}$ 的 p 值。发现率估计为 p 值小于 $\\alpha$ 的重复实验所占的比例。这个蒙特卡罗估计是一个在 $[0,1]$ 区间内的数字，当 $\\beta \\neq 0$ 时作为经验功效，当 $\\beta = 0$ 时作为经验假阳性率。\n\n测试套件：\n使用以下六个情景。在所有情景中，使用 $n=200$ 个个体，$R=3000$ 次蒙特卡罗重复，$\\alpha=0.05$，$\\mu=0$，$\\sigma^2=1$，并使用固定的随机数生成器种子 $1729$ 以确保可复现性。在所有情景中，设 $\\pi=0.5$。\n\n对每个情景，指定 $(p_0,p_1,\\beta,\\gamma,\\mathrm{include\\_G})$：\n- 情景 $1$：$(0.3, 0.3, 0.3, 0.0, \\text{False})$; 无混杂，中等效应，中等MAF。\n- 情景 $2$：$(0.05, 0.05, 0.0, 0.0, \\text{False})$; 无效应，低MAF；应近似于名义假阳性率。\n- 情景 $3$：$(0.05, 0.05, 0.5, 0.0, \\text{False})$; 强效应，低MAF；功效低于较高MAF时。\n- 情景 $4$：$(0.1, 0.5, 0.0, 1.0, \\text{False})$; 通过等位基因频率和表达偏移产生的强混杂；预期会出现伪发现。\n- 情景 $5$：$(0.1, 0.5, 0.0, 1.0, \\text{True})$; 与情景4相同的数据生成过程，但将G作为协变量包含在内；假阳性率应回归到名义水平附近。\n- 情景 $6$：$(0.1, 0.5, 0.2, 1.0, \\text{True})$; 存在非零遗传效应且控制了混杂；预期有中等功效。\n\n程序要求：\n- 完全按照规定实现模拟器和估计器。\n- 使用上述定义的普通最小二乘法计算 $\\beta$ 的 t 统计量和双侧 p 值。\n- 对于每个情景，将蒙特卡罗发现率作为一个浮点数返回，使用标准四舍五入规则保留小数点后四位。不要报告百分比；报告在 $[0,1]$ 区间内的小数。\n- 随机性必须是确定性的：在程序开始时使用种子 $1729$ 初始化随机数生成器一次。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，\"[0.5320,0.0490,0.8010,0.7420,0.0510,0.3880]\"），其中的条目按顺序是情景1到6的六个发现率。", "solution": "该问题陈述要求实现一个蒙特卡罗模拟，以在一组指定的遗传和统计模型下估计表达数量性状基因座 (eQTLs) 的发现率。在尝试解决该问题之前，需要验证其科学合理性和完整性。\n\n首先，对问题陈述进行验证。\n- **提取给定条件**：该问题为数据生成过程和相应的分析流程提供了完整的规范。给定条件包括：\n    - 个体 $i$ 的基因表达 $Y_i$ 的数据生成模型：$Y_i = \\mu + \\beta X_i + \\gamma G_i + \\varepsilon_i$，其中 $X_i$ 是基因型剂量，$G_i$ 是二元群体组别指示符，$\\varepsilon_i \\sim \\mathcal{N}(0, \\sigma^2)$ 是一个噪声项。\n    - 协变量的特定分布：$G_i \\sim \\mathrm{Bernoulli}(\\pi)$，以及 $X_i \\sim \\mathrm{Binomial}(2, p_k)$，其中 $p_k$ 是个体 $i$ 所属组别 $k$ 的次要等位基因频率。\n    - 适用于所有模拟的一整套固定参数：样本量 $n=200$，蒙特卡罗重复次数 $R=3000$，显著性水平 $\\alpha=0.05$，截距 $\\mu=0$，误差方差 $\\sigma^2=1$，组别比例 $\\pi=0.5$，以及随机数生成器种子 $1729$。\n    - 一组六个不同的情景，每个情景由一组参数 $(p_0, p_1, \\beta, \\gamma, \\mathrm{include\\_G})$ 定义。\n    - 一种基于普通最小二乘法 (OLS) 的精确统计检验，用于检验原假设 $H_0: \\beta=0$，包括参数估计、标准误和 t 统计量的确切公式。\n    - 关于输出格式的明确说明：一个包含六个发现率的列表，每个发现率四舍五入到小数点后四位。\n\n- **验证检查**：\n    - **有科学依据**：该问题基于群体遗传学（分层内的哈迪-温伯格平衡）、统计遗传学（数量性状的加性线性模型）和主流统计学（OLS回归、假设检验）的基本原理。这些模型是该领域的标准模型。该问题在科学上是合理的。\n    - **良构性**：该问题定义明确无歧义。所有参数都已指定，模拟过程详细，期望输出描述精确。使用固定的随机种子确保了唯一、确定性的解。\n    - **客观性**：该问题以客观、数学的术语陈述，不含任何主观或推测性内容。\n    - **其他缺陷**：该问题没有表现出任何其他缺陷，例如不完整、矛盾、不切实际、病态或琐碎。它构成了应用于遗传学的计算统计学领域一个标准且有意义的练习。\n\n- **结论**：该问题是有效的。将根据提供的规范构建一个解决方案。\n\n解决方案通过蒙特卡罗模拟实现。对于六个指定情景中的每一个，以下过程将重复 $R=3000$ 次。\n\n1.  **数据生成**：对于 $n=200$ 个个体中的每一个，我们按如下方式模拟数据：\n    - 群体组别指示符 $G_i$ 从参数为 $\\pi=0.5$ 的伯努利分布中抽取。\n    - 根据 $G_i$ 的值，个体的次要等位基因频率 $p_i$ 被设置为 $p_0$ 或 $p_1$。\n    - 基因型剂量 $X_i \\in \\{0, 1, 2\\}$ 从二项分布 $X_i \\sim \\mathrm{Binomial}(2, p_i)$ 中抽取。这模拟了每个群体组内符合哈迪-温伯格平衡的孟德尔遗传。\n    - 然后使用线性模型 $Y_i = \\beta X_i + \\gamma G_i + \\varepsilon_i$ 生成基因表达值 $Y_i$，其中 $\\varepsilon_i$ 从标准正态分布 $\\mathcal{N}(0, 1)$ 中抽取，因为 $\\mu=0$ 且 $\\sigma^2=1$。\n\n2.  **统计分析**：在生成的包含 $n$ 个个体的数据集上，我们进行 OLS 回归以检验原假设 $H_0: \\beta=0$。\n    - 构建一个设计矩阵 $D$。它总是包含一个截距列（全为1的向量）和一列基因型剂量 $X$。如果情景指定 `include_G` 为 `True`，则会额外包含一列组别指示符 $G$。设 $p_{model}$ 为 $D$ 的列数（即模型中的参数数量，为2或3）。\n    - 模型系数 $\\theta$ 的 OLS 估计量计算为 $\\hat{\\theta} = (D^\\top D)^{-1}D^\\top Y$。\n    - 遗传效应的估计值 $\\hat{\\beta}$ 从向量 $\\hat{\\theta}$ 中提取。\n    - 计算残差：$e = Y - D\\hat{\\theta}$。\n    - 误差方差的无偏估计量为 $\\hat{\\sigma}^2 = \\frac{e^\\top e}{n - p_{model}}$。\n    - 遗传效应估计值的标准误计算如下：$\\mathrm{SE}(\\hat{\\beta}) = \\sqrt{\\hat{\\sigma}^2 C_{jj}}$，其中 $C_{jj}$ 是矩阵 $(D^\\top D)^{-1}$ 中对应于基因型预测变量 $X$ 的对角线元素。\n    - 构建 t 统计量：$t = \\hat{\\beta} / \\mathrm{SE}(\\hat{\\beta})$。\n    - 在原假设下，该统计量服从自由度为 $df = n - p_{model}$ 的学生t分布。双侧 p 值计算为 $P(|T_{df}| \\ge |t|)$。\n\n3.  **发现率估计**：\n    - 对于 $R=3000$ 次重复实验中的每一次，如果计算出的 p 值小于显著性阈值 $\\alpha=0.05$，则该结果被视为一次“发现”。\n    - 该情景的发现率估计为总发现次数除以 $R$。当 $\\beta=0$ 时，这估计了 I 类错误率。当 $\\beta \\neq 0$ 时，这估计了统计功效。\n\n整个过程在一个程序中实现，该程序遍历六个情景，为每个情景计算发现率，并以要求的格式报告结果。使用固定的随机种子确保了模拟是可复现的。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Simulates eQTL discovery rates across specified scenarios.\n    \"\"\"\n    # Global parameters as defined in the problem statement\n    N_INDIVIDUALS = 200\n    N_REPLICATES = 3000\n    ALPHA = 0.05\n    SEED = 1729\n    MU = 0.0\n    SIGMA_SQ = 1.0\n    PI = 0.5\n\n    # Initialize a single random number generator for reproducibility\n    rng = np.random.default_rng(SEED)\n\n    # Scenarios from the test suite\n    # Each tuple: (p0, p1, beta, gamma, include_G)\n    scenarios = [\n        (0.3, 0.3, 0.3, 0.0, False),  # 1: No confounding, moderate effect\n        (0.05, 0.05, 0.0, 0.0, False), # 2: Null model, low MAF (Type I error)\n        (0.05, 0.05, 0.5, 0.0, False), # 3: Strong effect, low MAF (Power)\n        (0.1, 0.5, 0.0, 1.0, False),  # 4: Confounding, uncorrected (Spurious association)\n        (0.1, 0.5, 0.0, 1.0, True),   # 5: Confounding, corrected (Type I error control)\n        (0.1, 0.5, 0.2, 1.0, True),   # 6: Moderate effect, confounding corrected (Power)\n    ]\n\n    all_discovery_rates = []\n\n    for p0, p1, beta, gamma, include_g in scenarios:\n        significant_count = 0\n        for _ in range(N_REPLICATES):\n            # 1. Data Generation\n            # Generate group assignment G\n            G = rng.binomial(1, PI, size=N_INDIVIDUALS)\n            \n            # Generate genotype dosage X based on group-specific MAF\n            p_alleles = np.where(G == 1, p1, p0)\n            X = rng.binomial(2, p_alleles, size=N_INDIVIDUALS)\n            \n            # Generate noise and gene expression Y\n            epsilon = rng.normal(loc=0.0, scale=np.sqrt(SIGMA_SQ), size=N_INDIVIDUALS)\n            Y = MU + beta * X + gamma * G + epsilon\n            \n            # 2. Statistical Analysis using OLS\n            # Construct the design matrix D\n            intercept = np.ones(N_INDIVIDUALS)\n            if include_g:\n                D = np.stack([intercept, G, X], axis=1)\n                p_model = 3\n                beta_coeff_index = 2\n            else:\n                D = np.stack([intercept, X], axis=1)\n                p_model = 2\n                beta_coeff_index = 1\n            \n            # Calculate OLS estimates: theta = (D^T D)^-1 D^T Y\n            try:\n                D_T_D = D.T @ D\n                D_T_D_inv = np.linalg.inv(D_T_D)\n                coeffs = D_T_D_inv @ D.T @ Y\n            except np.linalg.LinAlgError:\n                # In rare cases, D might be singular if, e.g., all X are the same.\n                # In such a case, the test is invalid for this replicate.\n                continue\n\n            beta_hat = coeffs[beta_coeff_index]\n            \n            # Calculate RSS and estimate sigma^2\n            Y_hat = D @ coeffs\n            residuals = Y - Y_hat\n            rss = np.sum(residuals**2)\n            df = N_INDIVIDUALS - p_model\n            \n            # Ensure degrees of freedom is positive\n            if df = 0:\n                continue\n                \n            sigma2_hat = rss / df\n\n            # Calculate standard error of beta_hat\n            se_beta_hat = np.sqrt(sigma2_hat * D_T_D_inv[beta_coeff_index, beta_coeff_index])\n            \n            if se_beta_hat == 0:\n                # Avoid division by zero if X has no variance in the sample\n                continue\n\n            # Calculate t-statistic and p-value\n            t_stat = beta_hat / se_beta_hat\n            p_value = 2 * t.sf(np.abs(t_stat), df=df)\n            \n            # 3. Check for discovery\n            if p_value  ALPHA:\n                significant_count += 1\n        \n        # Estimate discovery rate\n        discovery_rate = significant_count / N_REPLICATES\n        all_discovery_rates.append(round(discovery_rate, 4))\n        \n    # Final print statement in the exact required format\n    print(f\"[{','.join(map(str, all_discovery_rates))}]\")\n\nsolve()\n```", "id": "2810343"}, {"introduction": "在真实世界的eQTL分析中，我们面临的混杂因素（如实验批次效应或群体结构）通常是未知的，必须从数据中推断。这项练习探讨了一种常用技术——主成分分析（Principal Component Analysis, PCA）——并揭示了其应用中一个微妙但至关重要的陷阱：当主成分（PCs）本身捕获了部分真实遗传信号时，草率地校正这些主成分会不成比例地削弱甚至消除我们试图寻找的eQTL效应，导致有偏见的结论。通过推导其数学原理，您不仅能理解问题所在，还能设计出一种更优的校正方法。[@problem_id:2810275]", "problem": "一项关于表达数量性状位点 (eQTLs) 的研究评估了遗传变异如何影响个体间的信使核糖核酸 (mRNA) 表达水平，这与分子生物学的中心法则一致。考虑一个由 $n$ 个无亲缘关系的个体组成的队列，以及一个单一基因，其中心化的表达向量为 $y \\in \\mathbb{R}^{n}$。令 $g \\in \\mathbb{R}^{n}$ 为在某个候选顺式作用变异位点上的中心化基因型剂量向量（例如，次要等位基因计数），并进行缩放以使 $g^{\\top} g = n$。假设该基因的表达由一个线性模型生成\n$$\ny = \\beta\\, g + \\gamma\\, z + \\varepsilon,\n$$\n其中 $\\beta \\in \\mathbb{R}$ 是真实的 eQTL 效应， $z \\in \\mathbb{R}^{n}$ 是一个未观测到的单一批次混杂因素，满足 $z^{\\top} z = n$ 和 $z^{\\top} g = 0$，$\\gamma \\in \\mathbb{R}$ 是混杂因素载荷，$\\varepsilon \\in \\mathbb{R}^{n}$ 是零均值噪声，满足 $\\mathbb{E}[\\varepsilon] = 0$ 和 $\\operatorname{Cov}(\\varepsilon) = \\sigma^{2} I_{n}$，且独立于 $g$ 和 $z$。在实践中，研究人员通常计算 $y$ 的主成分 (PCs) 来移除混杂效应。假设从 $y$ 中提取的最高主成分 (PC) 是一个单位向量 $p \\in \\mathbb{R}^{n}$，它位于由 $z$ 和 $g$ 张成的空间中，并由一个角度 $\\theta \\in \\mathbb{R}$ 参数化为\n$$\np \\;=\\; \\cos(\\theta)\\,\\frac{z}{\\sqrt{n}} \\;+\\; \\sin(\\theta)\\,\\frac{g}{\\sqrt{n}},\n$$\n从而 $p^{\\top}p=1$。考虑在表达分析中常用的以下两步“朴素”校正法：\n1. 通过最高主成分对表达进行残差化处理：$y_{\\mathrm{res}} = (I_{n} - p p^{\\top}) y$。\n2. 通过普通最小二乘法 (OLS) 估计 eQTL 效应：$\\widehat{\\beta}_{\\mathrm{naive}} = \\dfrac{g^{\\top} y_{\\mathrm{res}}}{g^{\\top} g}$。\n\n仅从欧几里得空间中线性回归和正交投影的定义出发，推导朴素估计量 $\\widehat{\\beta}_{\\mathrm{naive}}$ 在 $n \\to \\infty$ 极限下（忽略 $\\varepsilon$）的大样本期望，并用 $\\beta$、$\\gamma$ 和 $\\theta$ 表示。然后，提出一个程序，通过构建一个与 $g$ 正交的主成分方向 $p_{\\perp g}$，并在相同的两步校正法中使用它代替 $p$，来避免在移除混杂因素的同时衰减真实的 eQTL 效应；简要说明为什么这一改变能解决衰减问题。\n\n报告衰减因子 $A_{\\mathrm{naive}} \\equiv \\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}]/\\beta$ 关于 $\\theta$、$\\beta$ 和 $\\gamma$ 的函数解析表达式作为你的最终答案。无需进行数值计算。最终答案必须是无单位的单一解析表达式。", "solution": "所述问题具有科学依据，提法恰当且客观。它提出了一个简化但典型的模型，用于研究混杂效应对表达数量性状位点 (eQTL) 分析的影响。我们将进行严谨的推导。\n\n根据要求，分析分为两部分。首先，我们推导朴素估计量的大样本期望。其次，我们提出并论证一个校正程序。\n\n第一部分：$\\widehat{\\beta}_{\\mathrm{naive}}$ 的大样本期望推导\n\neQTL 效应 $\\beta$ 的朴素估计量由下式给出：\n$$\n\\widehat{\\beta}_{\\mathrm{naive}} = \\frac{g^{\\top} y_{\\mathrm{res}}}{g^{\\top} g}\n$$\n其中 $y_{\\mathrm{res}} = (I_{n} - p p^{\\top}) y$。矩阵 $P_p = p p^{\\top}$ 是到由单位向量 $p$ 张成的一维子空间上的投影矩阵，而 $(I_n - P_p)$ 是到其正交补空间上的投影矩阵。分母由已知条件给出，$g^{\\top} g = n$。\n\n将 $y_{\\mathrm{res}}$ 的表达式代入估计量中，我们得到：\n$$\n\\widehat{\\beta}_{\\mathrm{naive}} = \\frac{g^{\\top} (I_{n} - p p^{\\top}) y}{n} = \\frac{g^{\\top}y - g^{\\top}p p^{\\top} y}{n} = \\frac{g^{\\top}y - (g^{\\top}p)(p^{\\top}y)}{n}\n$$\n问题要求的是大样本期望，忽略噪声项 $\\varepsilon$。期望是关于噪声分布的。\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}] = \\frac{g^{\\top}\\mathbb{E}[y] - (g^{\\top}p)(p^{\\top}\\mathbb{E}[y])}{n}\n$$\n表达向量的模型为 $y = \\beta g + \\gamma z + \\varepsilon$。给定 $\\mathbb{E}[\\varepsilon]=0$，$y$ 的期望值为：\n$$\n\\mathbb{E}[y] = \\beta g + \\gamma z\n$$\n我们将此代入 $\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}]$ 的表达式中。为清晰起见，令 $y^{*} = \\mathbb{E}[y]$。\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}] = \\frac{g^{\\top}y^{*} - (g^{\\top}p)(p^{\\top}y^{*})}{n}\n$$\n现在我们必须计算标量积 $g^{\\top}p$ 和 $p^{\\top}y^{*}$。向量 $p$ 定义为 $p = \\cos(\\theta)\\,\\frac{z}{\\sqrt{n}} + \\sin(\\theta)\\,\\frac{g}{\\sqrt{n}}$。\n\n首先，我们计算 $g^{\\top}p$：\n$$\ng^{\\top}p = g^{\\top} \\left( \\cos(\\theta)\\frac{z}{\\sqrt{n}} + \\sin(\\theta)\\frac{g}{\\sqrt{n}} \\right) = \\frac{\\cos(\\theta)}{\\sqrt{n}} (g^{\\top}z) + \\frac{\\sin(\\theta)}{\\sqrt{n}} (g^{\\top}g)\n$$\n使用给定条件 $g^{\\top}z = 0$ 和 $g^{\\top}g = n$，我们发现：\n$$\ng^{\\top}p = \\frac{\\cos(\\theta)}{\\sqrt{n}}(0) + \\frac{\\sin(\\theta)}{\\sqrt{n}}(n) = \\sqrt{n}\\sin(\\theta)\n$$\n\n接下来，我们计算 $p^{\\top}y^{*}$：\n$$\np^{\\top}y^{*} = p^{\\top}(\\beta g + \\gamma z) = \\beta (p^{\\top}g) + \\gamma (p^{\\top}z)\n$$\n我们已经有 $p^{\\top}g = g^{\\top}p = \\sqrt{n}\\sin(\\theta)$。现在我们需要计算 $p^{\\top}z$：\n$$\np^{\\top}z = \\left( \\cos(\\theta)\\frac{z}{\\sqrt{n}} + \\sin(\\theta)\\frac{g}{\\sqrt{n}} \\right)^{\\top} z = \\frac{\\cos(\\theta)}{\\sqrt{n}}(z^{\\top}z) + \\frac{\\sin(\\theta)}{\\sqrt{n}}(g^{\\top}z)\n$$\n使用条件 $z^{\\top}z = n$ 和 $g^{\\top}z = 0$：\n$$\np^{\\top}z = \\frac{\\cos(\\theta)}{\\sqrt{n}}(n) + \\frac{\\sin(\\theta)}{\\sqrt{n}}(0) = \\sqrt{n}\\cos(\\theta)\n$$\n代回到 $p^{\\top}y^{*}$ 的表达式中：\n$$\np^{\\top}y^{*} = \\beta(\\sqrt{n}\\sin(\\theta)) + \\gamma(\\sqrt{n}\\cos(\\theta)) = \\sqrt{n}(\\beta\\sin(\\theta) + \\gamma\\cos(\\theta))\n$$\n\n现在我们组合 $\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}]$ 的分子：$g^{\\top}y^{*} - (g^{\\top}p)(p^{\\top}y^{*})$。第一项是 $g^{\\top}y^{*} = g^{\\top}(\\beta g + \\gamma z) = \\beta(g^{\\top}g) + \\gamma(g^{\\top}z) = \\beta n$。\n$$\n\\text{分子} = \\beta n - (\\sqrt{n}\\sin(\\theta)) \\cdot (\\sqrt{n}(\\beta\\sin(\\theta) + \\gamma\\cos(\\theta)))\n$$\n$$\n= \\beta n - n(\\beta\\sin^{2}(\\theta) + \\gamma\\sin(\\theta)\\cos(\\theta))\n$$\n$$\n= n(\\beta - \\beta\\sin^{2}(\\theta) - \\gamma\\sin(\\theta)\\cos(\\theta))\n$$\n使用恒等式 $1 - \\sin^{2}(\\theta) = \\cos^{2}(\\theta)$：\n$$\n= n(\\beta\\cos^{2}(\\theta) - \\gamma\\sin(\\theta)\\cos(\\theta))\n$$\n最后，我们除以分母 $n$ 得到大样本期望：\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}] = \\beta\\cos^{2}(\\theta) - \\gamma\\sin(\\theta)\\cos(\\theta)\n$$\n这个结果表明朴素估计量是有偏的。项 $\\beta\\cos^{2}(\\theta)$ 代表对真实效应 $\\beta$ 的衰减，因为 $\\cos^{2}(\\theta) \\leq 1$。项 $-\\gamma\\sin(\\theta)\\cos(\\theta)$ 代表一个依赖于混杂效应 $\\gamma$ 的偏差，即使真实的遗传效应 $\\beta$ 为零，该偏差也可能非零，从而导致假阳性发现。\n\n第二部分：避免衰减的校正程序\n\n衰减和偏差的原因是主成分 $p$ 与基因型向量 $g$ 相关（因为只要 $\\sin(\\theta) \\neq 0$，$g^{\\top}p \\neq 0$）。校正程序必须在不移除感兴趣的遗传信号的情况下，去除混杂变异。这可以通过确保用于校正的向量与基因型向量 $g$ 正交来实现。\n\n建议的程序如下：\n1. 从原始主成分 $p$ 构建一个新向量 $p_{\\perp g}$，使其与 $g$ 正交。这可以通过格拉姆-施密特正交化方法，移除 $p$ 沿 $g$ 方向的分量来实现。未归一化的向量是：\n$$\np'_{\\perp g} = p - \\frac{p^{\\top}g}{g^{\\top}g}g\n$$\n根据构造，该向量 $p'_{\\perp g}$ 与 $g$ 正交，因为 $g^{\\top}p'_{\\perp g} = g^{\\top}p - \\frac{(p^{\\top}g)(g^{\\top}g)}{g^{\\top}g} = 0$。为了在投影矩阵中使用，必须将其归一化为单位向量：\n$$\np_{\\perp g} = \\frac{p'_{\\perp g}}{\\|p'_{\\perp g}\\|}\n$$\n2. 在同样的两步程序中，使用这个新向量 $p_{\\perp g}$ 代替 $p$：\n   a. 对表达进行残差化处理：$y_{\\mathrm{res,corr}} = (I_{n} - p_{\\perp g} p_{\\perp g}^{\\top}) y$。\n   b. 估计 eQTL 效应：$\\widehat{\\beta}_{\\mathrm{corr}} = \\dfrac{g^{\\top} y_{\\mathrm{res,corr}}}{g^{\\top} g}$。\n\n为了证明此校正的合理性，我们分析 $\\widehat{\\beta}_{\\mathrm{corr}}$ 的期望。\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{corr}}] = \\mathbb{E}\\left[\\frac{g^{\\top}(I_{n} - p_{\\perp g} p_{\\perp g}^{\\top}) y}{n}\\right] = \\frac{g^{\\top}y^{*} - (g^{\\top}p_{\\perp g})(p_{\\perp g}^{\\top}y^{*})}{n}\n$$\n根据构造，$g^{\\top}p_{\\perp g} = 0$。因此，第二项消失。\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{corr}}] = \\frac{g^{\\top}y^{*}}{n} = \\frac{g^{\\top}(\\beta g + \\gamma z)}{n} = \\frac{\\beta (g^{\\top}g) + \\gamma (g^{\\top}z)}{n}\n$$\n使用 $g^{\\top}g = n$ 和 $g^{\\top}z = 0$，我们得到：\n$$\n\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{corr}}] = \\frac{\\beta n + 0}{n} = \\beta\n$$\n估计量 $\\widehat{\\beta}_{\\mathrm{corr}}$ 是 $\\beta$ 的无偏估计。该程序成功地移除了与混杂因素相关的变异（由与 $g$ 正交的 $p$ 的分量捕获），而不会衰减或偏倚对真实 eQTL 效应的估计。这是一个普遍原则：在线性模型中，对与感兴趣的回归量正交的协变量进行调整，不会使该回归量的系数产生偏差。\n\n最后，我们计算所要求的朴素估计量的衰减因子，假设 $\\beta \\neq 0$。\n$$\nA_{\\mathrm{naive}} = \\frac{\\mathbb{E}[\\widehat{\\beta}_{\\mathrm{naive}}]}{\\beta} = \\frac{\\beta\\cos^{2}(\\theta) - \\gamma\\sin(\\theta)\\cos(\\theta)}{\\beta} = \\cos^{2}(\\theta) - \\frac{\\gamma}{\\beta}\\sin(\\theta)\\cos(\\theta)\n$$\n这就是所要求的解析表达式。", "answer": "$$\n\\boxed{\\cos^{2}(\\theta) - \\frac{\\gamma}{\\beta} \\sin(\\theta) \\cos(\\theta)}\n$$", "id": "2810275"}, {"introduction": "eQTL研究的真正威力在于其规模，我们需要在全基因组范围内检验数百万个遗传变异与数万个基因表达之间的关联。这种海量检验带来了巨大的统计挑战，即多重检验问题。这项最终实践将带您从单个检验的思维模式转向全基因组发现的宏观视角，您将从第一性原理出发，推导出Benjamini-Hochberg程序，这是现代统计学中控制伪发现率（False Discovery Rate, FDR）的基石。掌握这一概念对于解读任何大规模组学研究的结果、从海量数据中分辨真实生物信号与统计噪音至关重要。[@problem_id:2810282]", "problem": "在一个关于表达数量性状位点 (eQTL) 定位的群体遗传学研究中，您检验了基因型与信使核糖核酸 (mRNA) 表达之间的关联，对 $m$ 个独立的变异-基因对，每个都使用线性模型进行检验。对于每次检验，您都会计算出一个 $p$ 值，记为 $p_{1},\\dots,p_{m}$。当一个变异-基因对显示出基因型与表达之间存在关联的统计学证据时，就宣布发现了一个表达数量性状位点 (eQTL)。您希望将错误发现率 (FDR) 控制在目标水平 $q \\in (0,1)$，错误发现率定义为所有发现的 eQTL 中，错误发现的 eQTL 所占的期望比例。\n\n从以下基本事实出发：\n- 在原假设为真的情况下，$p$ 值在 $[0,1]$ 上服从均匀分布，并且在各检验之间是独立的。\n- 错误发现率 (FDR) 定义为 $\\mathrm{FDR} = \\mathbb{E}\\!\\left[\\frac{V}{R}\\right]$，其中 $V$ 是错误发现的 eQTL 数量，$R$ 是发现的 eQTL 总数，并约定 $\\frac{0}{0}=0$。\n\n任务：\n1) 基于这些原则，推导出一个决策规则。该规则将 $p$ 值向量 $(p_{1},\\dots,p_{m})$ 映射到一组发现，并能将 FDR 控制在目标水平 $q$。您的答案必须是一个明确的解析条件，一个 $p$ 值必须满足此条件才能被认为是显著的。该条件需用 $m$、$q$ 和 $p$ 值的顺序统计量来表示。\n\n2) 假设在一次特定实验中，第 1 部分的决策规则恰好得出了 $r \\ge 0$ 个 eQTL 发现。在所述条件（独立的连续零假设 $p$ 值）下，假设达到的错误发现率等于设计目标 $q$，请给出一个以 $q$ 和 $r$ 表示的、错误 eQTL 发现数量期望值的封闭形式表达式。您的最终答案必须是一个单一的解析表达式。无需取整，也不需要单位。", "solution": "所述问题在科学上是合理的，内容是自洽的，并且在数学上是适定的。它描述了使用错误发现率 (FDR) 进行多重假设检验校正的典型问题，这是现代统计遗传学和其他涉及大规模数据分析领域的一个基本概念。因此，我们将着手求解。\n\n该问题包含两部分。首先，我们必须推导一个控制 FDR 的决策规则。其次，我们必须计算在给定特定结果的情况下，错误发现的期望数量。\n\n第 1 部分：FDR 控制程序的推导\n\n设有 $m$ 个独立的假设检验，其对应的 $p$ 值为 $p_{1}, \\dots, p_{m}$。令 $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(m)}$ 为按非递减顺序排序的 $p$ 值。目标是设计一个程序，用于识别一组“发现”（被拒绝的原假设），使得 FDR 控制在预设水平 $q \\in (0,1)$。\n\nFDR 定义为 $\\mathrm{FDR} = \\mathbb{E}\\!\\left[\\frac{V}{R}\\right]$，其中 $V$ 是错误发现的数量（被错误拒绝的真原假设的数量），$R$ 是发现的总数。使用约定 $\\frac{0}{0}=0$。一个基本事实是，对于一个真原假设，其 $p$ 值服从 $[0,1]$ 上的均匀分布。\n\n实现这种控制的决策规则是 Benjamini-Hochberg (BH) 程序。我们推导这个规则并证明其控制特性。\n\nBH 程序如下：\n1.  找到满足 $p_{(k)} \\le \\frac{k}{m}q$ 的最大整数 $k$。\n2.  如果存在这样的 $k$，则拒绝与 $p$ 值 $p_{(1)}, p_{(2)}, \\dots, p_{(k)}$ 相对应的 $k$ 个原假设。\n3.  如果不存在这样的 $k$，则不拒绝任何假设。\n\n现在，我们必须证明这个程序将 FDR 控制在水平 $q$。令 $R$ 表示拒绝的总数。根据程序的定义，$R = k$。令 $\\mathcal{H}_0$ 为对应于真原假设的索引集合，令 $m_0 = |\\mathcal{H}_0|$ 为（未知的）真原假设的数量。错误拒绝的数量为 $V = \\sum_{i \\in \\mathcal{H}_0} \\mathbf{1}\\{H_i \\text{ is rejected}\\}$。数量 $\\frac{V}{R}$ 是错误发现比例 (FDP)。\n\n如果 $R=0$，则 $V=0$ 且 $\\frac{V}{R}=0$。考虑 $R  0$ 的情况。每个被拒绝的假设 $H_i$ 的 $p$ 值都满足 $p_i \\le p_{(R)}$。根据程序的定义，阈值 $p_{(R)}$ 满足 $p_{(R)} \\le \\frac{R}{m}q$。因此，对于任何被拒绝的假设 $H_i$，其 $p$ 值都必须满足 $p_i \\le \\frac{R}{m}q$。\n\n这使我们可以为错误拒绝的指示函数写出一个不等式：\n$$ \\mathbf{1}\\{H_i \\text{ is rejected}, i \\in \\mathcal{H}_0\\} \\le \\mathbf{1}\\{p_i \\le \\frac{R}{m}q, i \\in \\mathcal{H}_0\\} $$\nFDP 可以被限定范围：\n$$ \\frac{V}{R} = \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} \\mathbf{1}\\{H_i \\text{ is rejected}\\} \\le \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} \\mathbf{1}\\left\\{p_i \\le \\frac{R}{m}q\\right\\} $$\n我们现在取期望以求得 FDR。通过以 $R$ 为条件，使用全期望定律：\n$$ \\mathrm{FDR} = \\mathbb{E}\\left[\\frac{V}{R}\\right] \\le \\mathbb{E}\\left[ \\mathbb{E}\\left[ \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} \\mathbf{1}\\left\\{p_i \\le \\frac{R}{m}q\\right\\} \\Bigg| R \\right] \\right] $$\n在条件期望内部，$R$ 被视为一个固定值。令 $t_R = \\frac{R}{m}q$。表达式变为：\n$$ \\mathbb{E}\\left[ \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} \\mathbf{1}\\{p_i \\le t_R\\} \\Bigg| R \\right] = \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} P(p_i \\le t_R \\mid R) $$\n在所述的检验独立的假设下，一个零假设 $p$ 值 $p_i$ 的分布独立于其他检验的结果，因此以 $R$ 为条件不会改变其边际概率。对于任何真原假设 $H_i$，$p_i \\sim U[0,1]$，所以 $P(p_i \\le t_R) = t_R$。\n$$ \\frac{1}{R} \\sum_{i \\in \\mathcal{H}_0} t_R = \\frac{1}{R} \\cdot m_0 \\cdot t_R = \\frac{m_0}{R} \\cdot \\frac{R}{m}q = \\frac{m_0}{m}q $$\n此结果不依赖于 $R$ 的值。因此，外层期望也是 $\\frac{m_0}{m}q$。\n$$ \\mathrm{FDR} \\le \\frac{m_0}{m}q $$\n由于真原假设的数量 $m_0$ 不能超过检验的总数 $m$，我们有 $m_0 \\le m$，这意味着 $\\frac{m_0}{m}q \\le q$。因此，该程序将 FDR 控制在不大于 $q$ 的水平。\n\n对于一个给定的 $p$ 值 $p_j$ 被宣布为显著的明确解析条件是，它必须小于或等于被拒绝的最大 $p$ 值。令 $t_{BH}$ 为这个依赖于数据的阈值。\n$$ t_{BH} = \\max\\left\\{ p_{(k)} \\mid k \\in \\{1,\\dots,m\\} \\text{ and } p_{(k)} \\le \\frac{k q}{m} \\right\\} $$\n其中，空集上的最大值定义为 $0$。一个 $p$ 值 $p_j$ 导致一个发现，当且仅当 $p_j \\le t_{BH}$。至此，第一部分完成。\n\n第 2 部分：错误发现的期望数量\n\n我们已知一个实验恰好产生了 $R=r$ 个发现，其中 $r \\ge 0$ 是一个固定数。我们必须求出在此观察条件下的错误发现的期望数量：$\\mathbb{E}[V | R=r]$。\n\n我们还得到了一个关键假设，即达到的 FDR 等于设计目标 $q$，即 $\\mathbb{E}\\left[\\frac{V}{R}\\right] = q$。\nFDR 是 FDP $\\frac{V}{R}$ 的期望。这个期望可以通过以 $R$ 的值为条件进行分解：\n$$ \\mathbb{E}\\left[\\frac{V}{R}\\right] = \\sum_{k=1}^{m} \\mathbb{E}\\left[\\frac{V}{R} \\Bigg| R=k\\right] P(R=k) + \\mathbb{E}\\left[\\frac{V}{R} \\Bigg| R=0\\right] P(R=0) $$\n按照约定，$R=0$ 的项为 $0$。对于 $k  0$，随机变量 $R$ 在条件期望内部被固定为值 $k$，所以 $\\mathbb{E}\\left[\\frac{V}{R} \\Big| R=k\\right] = \\frac{\\mathbb{E}[V|R=k]}{k}$。\n\n假设达到的 FDR 恰好为 $q$ 是一个强有力的简化。它意味着在所有可能结果 $k$ 上的复杂平均值等于 $q$。在这种情况下，对此陈述最直接和最实际的解释是，对于任何非零数量的发现，错误发现的期望比例都是 $q$。这意味着假设对于任何特定的结果 $r  0$，条件 FDR，即 $\\mathbb{E}\\left[\\frac{V}{R} \\Big| R=r\\right]$，都等于 $q$。\n\n在此解释下，对于给定的发现数量 $r  0$，我们有：\n$$ \\mathbb{E}\\left[\\frac{V}{R} \\Bigg| R=r\\right] = q $$\n$$ \\frac{\\mathbb{E}[V|R=r]}{r} = q $$\n求解错误发现的期望数量，我们得到：\n$$ \\mathbb{E}[V|R=r] = qr $$\n当做出 $r$ 个发现时，此表达式给出了假阳性的期望数量。我们还必须检查 $r=0$ 的情况。如果没有做出任何发现 ($r=0$)，那么错误发现的数量 $V$ 必须为 $0$。期望为 $\\mathbb{E}[V|R=0] = 0$。我们的公式 $qr$ 给出 $q \\cdot 0 = 0$，所以它对所有 $r \\ge 0$ 都成立。\n问题要求一个单一的解析表达式，而这个结果满足了该要求。", "answer": "$$\\boxed{qr}$$", "id": "2810282"}]}