{"hands_on_practices": [{"introduction": "本节的第一个练习将带您实践最经典的祖先状态重建方法之一：最大简约法。对于离散性状，Fitch算法提供了一个高效的计算框架，用以推断在给定系统发育树上解释观察数据所需的最少演化改变次数。通过这个练习[@problem_id:2545589]，您将亲手应用该算法，为后续更复杂的基于模型的方法打下坚实的基础。", "problem": "在比较动物学和植物学中，最大简约法下的祖先状态重建旨在推断祖先的性状状态，以最小化系统发育树上性状变化的总次数。考虑一个无序的二元性状，这意味着转换 $0 \\leftrightarrow 1$ 各自具有相等的代价。给定一个具有拓扑结构 $((A,B),C)$ 的有根三分类单元树，其中观察到的叶节点状态为 $A=0$，$B=1$ 和 $C=1$。使用简约性准则和 Fitch 算法，确定两个内部节点处所有可能的祖先状态集：连接 A 和 B 的内部节点（称此节点为 $v$），以及连接 $(A,B)$ 与 C 的根节点（称此节点为 $r$）。然后，计算在该重建下树所隐含的最小状态变化总数。将最小变化总数以单个整数的形式作为您的最终答案。无需四舍五入。", "solution": "其基本原则是最大简约性准则：在所有与观察到的叶节点状态一致的祖先性状状态分配中，选择那些能最小化状态变化总次数的分配。对于无序二元性状，转换 $0 \\to 1$ 和 $1 \\to 0$ 各自具有相同的代价（计为 1），并且没有方向性偏差。\n\nFitch 算法提供了一个构造性过程，用于为每个内部节点计算一个可能的状态集，这些状态的分配不会增加最小步数，并同时得出最小的变化次数。该算法分两遍进行。\n\n向上遍历（后序），以计算祖先状态集并统计变化次数：\n- 对于叶节点，分配观察到的单元集：$S_A=\\{0\\}$，$S_B=\\{1\\}$，$S_C=\\{1\\}$。\n- 考虑连接 A 和 B 的内部节点 $v$。如果子节点集合的交集非空，则将该交集赋给 $S_v$；否则，将并集赋给 $S_v$。此处，$S_A \\cap S_B = \\{0\\} \\cap \\{1\\} = \\varnothing$，因此交集为空。所以，分配 $S_v = S_A \\cup S_B = \\{0,1\\}$，并且由于此处的交集为空，将简约步数加 1。\n- 考虑连接 $v$ 和 C 的根节点 $r$。我们有 $S_v=\\{0,1\\}$ 和 $S_C=\\{1\\}$。其交集为 $S_v \\cap S_C = \\{0,1\\} \\cap \\{1\\} = \\{1\\}$，非空。因此，分配 $S_r=\\{1\\}$，且不在此节点增加步数。\n\n向上遍历得出的祖先状态集为 $S_v=\\{0,1\\}$ 和 $S_r=\\{1\\}$。从空交集累积的最小变化总数为 1。\n\n向下遍历（前序），以实现一个最小分配并验证步数：\n- 从 $S_r$ 中为根节点选择任一状态；此处 $S_r=\\{1\\}$，因此将根节点的状态设为 1。\n- 对于子节点 $v$（其状态集 $S_v=\\{0,1\\}$），选择一个能最小化沿边 $(r,v)$ 的变化的状态。在 $v$ 处选择状态 1 与父节点匹配，在边 $(r,v)$ 上产生 0 次变化。\n- 传播至叶节点：从 $v=1$ 到 $B=1$，在边 $(v,B)$ 上无变化；从 $v=1$ 到 $A=0$，在边 $(v,A)$ 上有一次变化。\n\n这个明确的分配方案恰好实现了 1 次变化，与向上遍历得到的计数相符。根据简约性原则和 Fitch 算法，这是可能的最小变化数。\n\n因此，内部节点的祖先状态集为 $S_v=\\{0,1\\}$ 和 $S_r=\\{1\\}$，最小总变化数为 1。", "answer": "$$\\boxed{1}$$", "id": "2545589"}, {"introduction": "在处理如体型大小等连续性状时，简约法不再适用，我们需要转向基于概率模型的统计推断。本练习将介绍系统发育比较方法中一个核心模型——布朗运动（Brownian Motion, $BM$）模型，并指导您如何利用该模型估计祖先节点的性状值及其不确定性。这个实践[@problem_id:2545572]将帮助您掌握在系统发育框架下进行统计估计的关键技能。", "problem": "考虑一个连续性状在具有拓扑结构 $\\big((A:1, B:1):1, C:2\\big)$ 的有根系统发育树上，遵循布朗运动模型进行演化。在布朗运动模型下，以父节点状态为条件，沿着长度为 $t$ 的分支发生的变化服从均值为 $0$、方差为 $\\sigma^{2} t$ 的高斯分布，且不同分支上的变化是相互独立的。假设根节点状态的先验分布为平坦先验（非正常均匀分布），因此所有节点状态的联合分布是通过复合这些高斯增量得到的，而没有在根节点引入额外信息。观测到的叶节点性状值为 $A=2.0$，$B=3.0$ 和 $C=5.0$，扩散率为 $\\sigma^{2}=1$。\n\n仅使用所述的布朗运动假设、多元高斯分布的性质以及树上的条件独立性，从第一性原理出发，推导A和B的最近共同祖先这个内部节点上祖先性状的最大似然估计（等价于平坦根节点先验下的后验均值）及其相关的条件方差。请以精确的有理数形式表示最终答案，不要四舍五入，并将估计值和方差按此顺序作为一个单行向量一起提供。无需单位。", "solution": "设节点表示如下：$A$、$B$、$C$ 为叶节点，$D$ 为 $A$ 和 $B$ 的最近共同祖先（MRCA），$R$ 为树的根节点。这些节点上的状态分别为 $x_A$、$x_B$、$x_C$、$x_D$ 和 $x_R$。观测到的叶节点数据为 $x_A=2$，$x_B=3$，$x_C=5$。扩散率为 $\\sigma^2=1$。\n\n该问题可以使用系统发育数据的广义最小二乘法（GLS）框架来解决。观测到的叶节点状态向量 $X = \\begin{pmatrix} x_A & x_B & x_C \\end{pmatrix}^T = \\begin{pmatrix} 2 & 3 & 5 \\end{pmatrix}^T$ 服从多元正态分布。在根节点状态 $x_R$ 固定的布朗运动模型下，叶节点状态的期望值为 $\\mathbb{E}[X] = x_R \\mathbf{1}$，其中 $\\mathbf{1}$ 是一个全为1的列向量。假设根节点状态为平坦先验，等价于从数据中估计 $x_R$。\n\n首先，我们必须构建系统发育方差-协方差矩阵 $V$。元素 $V_{ij}$ 是扩散率 $\\sigma^2$ 与从根节点到叶节点 $i$ 和 $j$ 的最近共同祖先的共享路径长度的乘积。给定树 `((A:1, B:1):1, C:2)`，根节点 $R$ 位于时间 $0$。节点 $D$ 位于时间 $t_{RD}=1$。叶节点 $A$ 和 $B$ 位于时间 $1+1=2$，叶节点 $C$ 位于时间 $2$。\n矩阵 $V$ 的元素为：\n$V_{AA} = \\sigma^2 \\times (\\text{从根到A的时间}) = 1 \\times (t_{RD} + t_{DA}) = 1 \\times (1+1) = 2$。\n$V_{BB} = \\sigma^2 \\times (\\text{从根到B的时间}) = 1 \\times (t_{RD} + t_{DB}) = 1 \\times (1+1) = 2$。\n$V_{CC} = \\sigma^2 \\times (\\text{从根到C的时间}) = 1 \\times t_{RC} = 1 \\times 2 = 2$。\n$V_{AB} = \\sigma^2 \\times (\\text{从根到MRCA(A,B)的时间}) = 1 \\times (\\text{节点D的时间}) = 1 \\times 1 = 1$。\n$V_{AC} = \\sigma^2 \\times (\\text{从根到MRCA(A,C)的时间}) = 1 \\times (\\text{节点R的时间}) = 1 \\times 0 = 0$。\n$V_{BC} = \\sigma^2 \\times (\\text{从根到MRCA(B,C)的时间}) = 1 \\times (\\text{节点R的时间}) = 1 \\times 0 = 0$。\n\n因此，矩阵 $V$ 为：\n$$V = \\begin{pmatrix} 2 & 1 & 0 \\\\ 1 & 2 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix}$$\n接下来，我们求解其逆矩阵 $V^{-1}$。该矩阵是块对角矩阵。\n左上角 $2 \\times 2$ 块 $\\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix}$ 的逆矩阵是 $\\frac{1}{2 \\cdot 2 - 1 \\cdot 1} \\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix} = \\frac{1}{3}\\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix}$。\n右下角 $1 \\times 1$ 块 $[2]$ 的逆矩阵是 $[1/2]$。\n所以，\n$$V^{-1} = \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix}$$\n给定叶节点数据 $X$ 时，祖先状态 $x_i$ 的后验均值（等价于最大似然估计）由以下公式给出：\n$$\\hat{x}_i = \\hat{x}_R + \\mathbf{c}_i^T V^{-1}(X - \\hat{x}_R \\mathbf{1})$$\n其中 $\\hat{x}_R$ 是根节点状态的GLS估计值，$\\mathbf{c}_i$ 是节点 $i$ 与叶节点之间的协方差向量。\n根节点状态的GLS估计值为：\n$$\\hat{x}_R = \\frac{\\mathbf{1}^T V^{-1} X}{\\mathbf{1}^T V^{-1} \\mathbf{1}}$$\n我们计算各个组成部分：\n$\\mathbf{1}^T V^{-1} = \\begin{pmatrix} 1 & 1 & 1 \\end{pmatrix} \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix}$。\n$\\mathbf{1}^T V^{-1} \\mathbf{1} = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 1 \\end{pmatrix} = 1/3 + 1/3 + 1/2 = 2/3 + 1/2 = 7/6$。\n$\\mathbf{1}^T V^{-1} X = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 2 \\\\ 3 \\\\ 5 \\end{pmatrix} = 2/3 + 3/3 + 5/2 = 2/3 + 1 + 5/2 = 4/6 + 6/6 + 15/6 = 25/6$。\n所以，$\\hat{x}_R = \\frac{25/6}{7/6} = 25/7$。\n\n现在，我们求解节点 $D$ 的估计值 $\\hat{x}_D$。我们需要节点 $D$ 与叶节点 $A,B,C$ 之间的协方差向量 $\\mathbf{c}_D$：\n$c_{DA} = \\sigma^2 \\times (\\text{从根到MRCA(D,A)=D的时间}) = 1 \\times 1 = 1$。\n$c_{DB} = \\sigma^2 \\times (\\text{从根到MRCA(D,B)=D的时间}) = 1 \\times 1 = 1$。\n$c_{DC} = \\sigma^2 \\times (\\text{从根到MRCA(D,C)=R的时间}) = 1 \\times 0 = 0$。\n所以，$\\mathbf{c}_D = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix}^T$。\n\n我们计算项 $\\mathbf{c}_D^T V^{-1}$：\n$\\mathbf{c}_D^T V^{-1} = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix} \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix}$。\n校正项为 $\\mathbf{c}_D^T V^{-1}(X - \\hat{x}_R \\mathbf{1})$：\n$X - \\hat{x}_R \\mathbf{1} = \\begin{pmatrix} 2 \\\\ 3 \\\\ 5 \\end{pmatrix} - \\frac{25}{7}\\begin{pmatrix} 1 \\\\ 1 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 14/7 - 25/7 \\\\ 21/7 - 25/7 \\\\ 35/7 - 25/7 \\end{pmatrix} = \\begin{pmatrix} -11/7 \\\\ -4/7 \\\\ 10/7 \\end{pmatrix}$。\n$\\mathbf{c}_D^T V^{-1}(X - \\hat{x}_R \\mathbf{1}) = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix} \\begin{pmatrix} -11/7 \\\\ -4/7 \\\\ 10/7 \\end{pmatrix} = -\\frac{11}{21} - \\frac{4}{21} = -\\frac{15}{21} = -\\frac{5}{7}$。\n最终，$\\hat{x}_D = \\hat{x}_R - 5/7 = 25/7 - 5/7 = 20/7$。\n\n接下来，我们计算 $x_D$ 估计值的条件方差。公式为：\n$$\\text{Var}(x_D | X) = \\sigma^2 T_D - \\mathbf{c}_D^T V^{-1} \\mathbf{c}_D + \\frac{(1 - \\mathbf{1}^T V^{-1} \\mathbf{c}_D)^2}{\\mathbf{1}^T V^{-1} \\mathbf{1}}$$\n这里，$T_D$ 是从根节点到节点 $D$ 的时间，为 $1$。所以 $\\sigma^2 T_D = 1$。\n我们计算新的各项：\n$\\mathbf{c}_D^T V^{-1} \\mathbf{c}_D = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\end{pmatrix} = 1/3 + 1/3 = 2/3$。\n$\\mathbf{1}^T V^{-1} \\mathbf{c}_D = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\end{pmatrix} = 1/3 + 1/3 = 2/3$。\n最后一项的分子是 $(1 - 2/3)^2 = (1/3)^2 = 1/9$。\n分母是 $\\mathbf{1}^T V^{-1} \\mathbf{1} = 7/6$。\n将它们组合起来：\n$\\text{Var}(x_D | X) = 1 - 2/3 + \\frac{1/9}{7/6} = 1/3 + \\frac{1}{9} \\cdot \\frac{6}{7} = 1/3 + \\frac{2}{21} = \\frac{7}{21} + \\frac{2}{21} = \\frac{9}{21} = \\frac{3}{7}$。\n\n节点 $D$ 状态的最大似然估计为 $20/7$，其条件方差为 $3/7$。", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{20}{7} & \\frac{3}{7} \\end{pmatrix}}$$", "id": "2545572"}, {"introduction": "任何祖先状态重建的可靠性都取决于背后演化模型的恰当性，因此，选择和验证模型是研究中的关键一步。本练习[@problem_id:2545588]将向您展示如何使用似然比检验（Likelihood Ratio Test, $LRT$）来比较嵌套的演化模型，例如，检验性状的演化速率是否对称。掌握这一方法，您将能够为自己的分析选择提供有力的统计支持。", "problem": "一个二元性状在一个固定的、超度量的系统发育树上，遵循一个瞬时速率矩阵为 $Q$ 的连续时间马尔可夫链进行演化，其叶尖状态的观测无误差。考虑一对嵌套模型：一个对称模型 $M_{0}$，其中 $q_{01} = q_{10}$；一个非对称模型 $M_{1}$，其中 $q_{01} \\neq q_{10}$。假设根节点的状态频率由 $Q$ 所蕴含的平稳分布给出，并且似然值是通过使用 Felsenstein 的剪枝递归算法对所有可能的祖先状态求和来精确计算的。\n\n给定一个具有五个分类单元的有根系统发育树，其枝长（单位为任意时间单位）如下：$((A:0.40,B:0.40):0.20,(C:0.30,(D:0.20,E:0.20):0.10):0.30);$ 观测到的叶尖状态为 $A=0$，$B=1$，$C=0$，$D=1$，$E=1$。在 $M_{0}$ 和 $M_{1}$ 模型下进行最大似然优化，得到以下最大化对数似然值：对于 $M_{0}$ 为 $\\widehat{\\ell}_{0} = -29.842$，对于 $M_{1}$ 为 $\\widehat{\\ell}_{1} = -27.314$。相应的速率参数的最大似然估计值为：对于 $M_{0}$ 是 $\\widehat{q} = 0.73$，对于 $M_{1}$ 是 $(\\widehat{q}_{01}, \\widehat{q}_{10}) = (1.10, 0.42)$。\n\n请仅使用树上连续时间马尔可夫过程似然的基本定义以及嵌套模型的标准大样本似然理论，构建用于比较 $M_{0}$ 与 $M_{1}$ 的似然比检验。在正则性条件下，确定该检验统计量的近似零分布，并计算检验统计量 $2\\Delta \\ell$ 的数值。将您的最终数值答案 $2\\Delta \\ell$ 四舍五入到四位有效数字。", "solution": "该问题要求构建一个似然比检验来比较两种嵌套的性状演化模型，确定检验统计量的零分布，并计算其值。\n\n所考虑的两个模型描述了一个二元性状（0 或 1）沿着系统发育树的演化过程，该过程为一个连续时间马尔可夫过程。\n零模型 $M_{0}$ 是一个对称模型，其中从状态 0 变为状态 1 的速率 $q_{01}$ 等于从状态 1 变为状态 0 的速率 $q_{10}$。我们可以定义一个单一的速率参数 $q = q_{01} = q_{10}$。该模型的自由速率参数数量为 $k_{0} = 1$。该模型的瞬时速率矩阵 $Q$ 为：\n$$\nQ = \\begin{pmatrix} -q & q \\\\ q & -q \\end{pmatrix}\n$$\n\n备择模型 $M_{1}$ 是一个非对称模型，其中两个速率被允许不同，即 $q_{01} \\neq q_{10}$。该模型有两个自由速率参数，$q_{01}$ 和 $q_{10}$。该模型的自由参数数量为 $k_{1} = 2$。该模型的瞬时速率矩阵 $Q$ 为：\n$$\nQ = \\begin{pmatrix} -q_{01} & q_{01} \\\\ q_{10} & -q_{10} \\end{pmatrix}\n$$\n\n模型 $M_{0}$ 是模型 $M_{1}$ 在施加了 $q_{01} = q_{10}$ 约束下的一个特例。因此，这两个模型是嵌套的，这是应用似然比检验（LRT）的先决条件。\n\n似然比检验统计量（在此表示为 $2\\Delta \\ell$）定义为更复杂的（备择）模型的最大化对数似然与更简单的（零）模型的最大化对数似然之差的两倍。\n令 $L_{0}$ 为模型 $M_{0}$ 下的最大似然，令 $L_{1}$ 为模型 $M_{1}$ 下的最大似然。对数似然分别为 $\\widehat{\\ell}_{0} = \\ln(L_{0})$ 和 $\\widehat{\\ell}_{1} = \\ln(L_{1})$。检验统计量由下式给出：\n$$\n2\\Delta \\ell = 2(\\widehat{\\ell}_{1} - \\widehat{\\ell}_{0}) = 2 \\ln \\left(\\frac{L_{1}}{L_{0}}\\right)\n$$\n由于模型 $M_{1}$ 的约束比 $M_{0}$ 少，它对数据的拟合至少会一样好，这意味着 $\\widehat{\\ell}_{1} \\ge \\widehat{\\ell}_{0}$，因此 $2\\Delta \\ell \\ge 0$。\n\n根据 Wilks 定理，对于大样本，在某些正则性条件下（对于此类系统发育模型，这些条件通常被假定成立），LRT 统计量在零假设（$H_{0}: M_{0}$ 是真实模型）下的分布会渐近趋近于卡方（$\\chi^2$）分布。该分布的自由度（$df$）等于备择模型与零模型之间自由参数数量的差值：\n$$\ndf = k_{1} - k_{0}\n$$\n在这个问题中，$M_{1}$ 的参数数量为 $k_{1}=2$（对应于 $q_{01}$ 和 $q_{10}$），而 $M_{0}$ 的参数数量为 $k_{0}=1$（对应于 $q$）。因此，自由度为：\n$$\ndf = 2 - 1 = 1\n$$\n因此，检验统计量 $2\\Delta \\ell$ 的近似零分布是一个自由度为 1 的卡方分布，记为 $\\chi^2_1$。\n\n我们从分析中得到了最大化对数似然值：\n- 对于零模型 $M_{0}$：$\\widehat{\\ell}_{0} = -29.842$\n- 对于备择模型 $M_{1}$：$\\widehat{\\ell}_{1} = -27.314$\n\n我们现在可以计算检验统计量 $2\\Delta \\ell$ 的数值：\n$$\n2\\Delta \\ell = 2(\\widehat{\\ell}_{1} - \\widehat{\\ell}_{0}) = 2(-27.314 - (-29.842))\n$$\n$$\n2\\Delta \\ell = 2(-27.314 + 29.842)\n$$\n$$\n2\\Delta \\ell = 2(2.528)\n$$\n$$\n2\\Delta \\ell = 5.056\n$$\n题目要求将答案四舍五入到四位有效数字。计算出的值 $5.056$ 已经有四位有效数字。\n提供的关于特定系统发育树、枝长、叶尖状态以及速率参数的最大似然估计值 $(\\widehat{q}=0.73, (\\widehat{q}_{01}, \\widehat{q}_{10}) = (1.10, 0.42))$ 的信息对于建立问题的背景和有效性至关重要，但最终计算只需要最大化对数似然值。", "answer": "$$\n\\boxed{5.056}\n$$", "id": "2545588"}]}