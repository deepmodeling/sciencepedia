{"hands_on_practices": [{"introduction": "香农熵 ($H$) 是衡量多样性的基石，但其数值的直观含义是什么？本练习旨在通过一个思想实验来阐明这一问题。通过计算一个极端不均匀群落的熵，并将其与理想的完全均匀情况进行比较，你将亲身体会到香农熵如何对稀有物种的存在表现出其独特的敏感性，从而深刻理解多样性指数背后的生态学意义。[@problem_id:2472830]", "problem": "一个陆生植物群落包含两种形态上不同的物种。从一个大型随机个体样本中，估计出的相对丰度为 $p=(0.99,\\,0.01)$。考虑作用于离散群落的一类多样性泛函，其满足以下广为接受的要求：关于各 $p_i$ 的连续性，关于物种标签的对称性，可扩展性（增加一个 $p_i=0$ 的物种不改变其值），以及在群落的概率划分下的递归性（可分解性）。这些公理唯一地确定了该泛函的形式，只相差一个正的乘法常数和对数底的选择。采用惯例，令乘法常数为 $1$，对数为自然对数 $\\ln$。\n\n基于这些前提，完成以下任务：\n\n1. 对于给定的群落 $p=(0.99,\\,0.01)$，计算其多样性值 $H$。\n2. 对于一个物种丰富度 $S=2$ 的完全均匀群落（即 $p=(0.5,\\,0.5)$），计算其对应的多样性值，记为 $H_{\\mathrm{even}}$。\n3. 报告比值 $R=H/H_{\\mathrm{even}}$，并将您最终报告的 $R$ 值四舍五入到 $4$ 位有效数字。\n\n在您的推理过程中（而非在最终的数值报告中），解释您获得的数值如何说明该多样性测度相对于一个 $S=2$ 的完全均匀分布而言，对稀有物种存在的敏感性。您提供的最终答案必须是唯一的、四舍五入后的 $R$ 值（无量纲）。", "solution": "在尝试任何解答之前，将首先对问题陈述进行严格的验证程序。\n\n提供了以下信息：\n- 一个群落包含两个物种（$S=2$）。\n- 相对丰度向量为 $p=(0.99,\\,0.01)$。\n- 一类多样性泛函必须满足连续性、对称性、可扩展性和递归性的公理。\n- 陈述指出，这些公理唯一地确定了该泛函的形式，只相差一个正的乘法常数和对数底的选择。\n- 指定的惯例是乘法常数为 $1$，并使用自然对数 $\\ln$。\n- 任务1：计算给定群落的多样性值 $H$。\n- 任务2：计算一个物种丰富度 $S=2$ 的完全均匀群落（其中 $p=(0.5,\\,0.5)$）的多样性值 $H_{\\mathrm{even}}$。\n- 任务3：计算比值 $R=H/H_{\\mathrm{even}}$ 并将结果四舍五入到 $4$ 位有效数字。\n\n根据既定标准对该问题进行验证。\n1.  **科学依据**：该问题基于信息论和理论生态学的公理化基础。所列出的公理——连续性、对称性、可扩展性和递归性——是 Khinchin 公理（或一个密切相关的公理集），它们唯一地定义了香农熵。这是一个基石性概念，其作为多样性指数的应用是标准做法。该问题在科学上是合理的。\n2.  **适定性**：该问题提供了所有必要信息。公理和惯例唯一地确定了要使用的多样性泛函。群落的组成被明确定义。任务清晰，并能导出一个唯一的、无歧义的数值结果。该问题是适定的。\n3.  **客观性**：问题以精确、客观的语言陈述，没有歧义或主观论断。\n\n该问题没有科学上不合理、不完整或含糊不清等缺陷。它是一个在定量生态学中有效且可形式化的问题。因此，我们可以继续进行求解。\n\n所提供的公理唯一地将多样性指数的泛函形式定义为香农熵 $H$。根据指定的惯例（乘法常数为 $1$ 和使用自然对数），其公式为：\n$$ H = - \\sum_{i=1}^{S} p_i \\ln(p_i) $$\n其中 $S$ 是物种数量（物种丰富度），$p_i$ 是第 $i$ 个物种的比例丰度。\n\n首先，我们计算给定群落（$S=2$，丰度为 $p_1=0.99$ 和 $p_2=0.01$）的多样性 $H$。\n$$ H = - \\left( p_1 \\ln(p_1) + p_2 \\ln(p_2) \\right) $$\n$$ H = - \\left( 0.99 \\ln(0.99) + 0.01 \\ln(0.01) \\right) $$\n利用对数的性质，我们可以计算这个表达式。\n$$ H \\approx - \\left( 0.99 \\times (-0.0100503) + 0.01 \\times (-4.6051702) \\right) $$\n$$ H \\approx - \\left( -0.0099498 + -0.0460517 \\right) $$\n$$ H \\approx -(-0.0560015) $$\n$$ H \\approx 0.0560015 $$\n\n接下来，我们计算一个 $S=2$ 的完全均匀群落的多样性 $H_{\\mathrm{even}}$。在这种情况下，丰度为 $p_1=0.5$ 和 $p_2=0.5$。\n$$ H_{\\mathrm{even}} = - \\left( 0.5 \\ln(0.5) + 0.5 \\ln(0.5) \\right) $$\n$$ H_{\\mathrm{even}} = - \\left( 2 \\times 0.5 \\ln(0.5) \\right) $$\n$$ H_{\\mathrm{even}} = - \\ln(0.5) = - \\ln\\left(\\frac{1}{2}\\right) = \\ln(2) $$\n$H_{\\mathrm{even}}$ 的值代表了具有两个物种的群落可能的最大香农多样性。\n$$ H_{\\mathrm{even}} = \\ln(2) \\approx 0.6931472 $$\n\n最后，我们计算比值 $R = H/H_{\\mathrm{even}}$。这个比值是均匀度的一种度量，它量化了所观察群落的多样性与相同物种数量下可能的最大多样性的接近程度。\n$$ R = \\frac{H}{H_{\\mathrm{even}}} = \\frac{- \\left( 0.99 \\ln(0.99) + 0.01 \\ln(0.01) \\right)}{\\ln(2)} $$\n$$ R \\approx \\frac{0.0560015}{0.6931472} \\approx 0.0807934 $$\n问题要求将此值四舍五入到 $4$ 位有效数字。\n$$ R \\approx 0.08079 $$\n\n这些数值揭示了香农指数的一个关键特性。对于 $S=2$，最大多样性为 $H_{\\mathrm{even}} = \\ln(2) \\approx 0.693$。给定的群落极其不均匀，导致其多样性值要低得多，为 $H \\approx 0.056$。比值 $R \\approx 0.08079$ 表明该群落的多样性仅为两个物种理论最大多样性的大约 $8.1\\%$。这反映了在识别一个随机抽样的个体时，不确定性很低，因为它几乎肯定属于优势物种。\n\n然而，考察每个物种对总多样性的单独贡献是很有启发性的。一个物种的贡献由 $-p_i \\ln(p_i)$ 这一项给出。\n对于优势物种（$p_1=0.99$）：$-0.99 \\ln(0.99) \\approx 0.010$。\n对于稀有物种（$p_2=0.01$）：$-0.01 \\ln(0.01) \\approx 0.046$。\n该指数的一个关键特征是，丰度仅为 $1\\%$ 的稀有物种对 $H$ 值的贡献，大约是丰度为 $99\\%$ 的优势物种的 $4.6$ 倍。这是因为函数 $f(p) = -p \\ln(p)$ 在 $p = 1/e \\approx 0.368$ 时达到峰值。非常稀有（$p \\to 0$）和非常占优势（$p \\to 1$）的物种贡献都很小，但该指数对稀有物种的存在特别敏感，因为它们的存在可以防止多样性值趋近于零，并且它们的贡献相对于其丰度而言不成比例地大。这证明了香农指数对物种均匀度和稀有物种存在的敏感性。", "answer": "$$\n\\boxed{0.08079}\n$$", "id": "2472830"}, {"introduction": "在生态学实践中，我们几乎总是通过样本而非普查来研究群落，这带来了样本量依赖性的挑战。本练习将引导你探索稀疏化 (rarefaction) 这一关键技术，以解决不同样本量下的多样性比较问题。通过从第一性原理推导 Simpson 指数无偏估计量的期望值，你将理解为何某些指数形式在生态学中被广泛采用，因为它能提供与取样深度无关的、可比较的度量。[@problem_id:2472851]", "problem": "一个单一的完整群落样本包含总共 $N=100$ 个个体，分布在 $S=4$ 个物种中，其观测计数为 $(N_{1},N_{2},N_{3},N_{4})=(40,30,20,10)$。考虑从此固定样本中无放回地抽取 $n$ 个个体进行随机稀疏化，得到稀疏化计数向量 $(X_{1},X_{2},X_{3},X_{4})$，其中 $\\sum_{i=1}^{4} X_{i}=n$。对于一个物种频率向量为 $\\{p_{i}\\}_{i=1}^{S}$ 的群落，辛普森集中度（也称为辛普森集中度指数）定义为 $D=\\sum_{i=1}^{S} p_{i}^{2}$，该值等于随机抽取的两个个体（对于有限样本是无放回抽样，或者当 $N$ 很大时对于潜在总体是有放回抽样）属于同一物种的概率。\n\n将从稀疏化样本计算出的辛普森集中度的插入式、成对形式定义为\n$$\n\\hat{D}_{n}=\\sum_{i=1}^{4} \\frac{X_{i}(X_{i}-1)}{n(n-1)}.\n$$\n从 $D$ 作为同物种共现概率的定义以及从有限瓮中进行无放回抽样的基本性质出发，推导出在稀疏化条件下期望值 $\\mathbb{E}[\\hat{D}_{n}]$ 的表达式，用原始计数 $(N_{1},\\dots,N_{4})$ 和 $N$ 来表示。然后，当 $n=20$ 时，根据给定的计数数值计算该期望值。将最终数值表示为一个精确的有理数。不要进行任何舍入，也不要包含任何单位。\n\n在您的推理中，请明确论证在无放回抽样条件下，$\\mathbb{E}[\\hat{D}_{n}]$ 对 $n$ 的依赖性（或无关性）是如何产生的。", "solution": "该问题是良定的，并且在科学上是合理的。它要求在超几何抽样模型（稀疏化）下，推导辛普森集中度的一个标准估计量的期望值。\n\n目标是计算 $\\mathbb{E}[\\hat{D}_{n}]$，其中估计量 $\\hat{D}_{n}$ 是针对大小为 $n$ 的稀疏化样本定义的：\n$$\n\\hat{D}_{n} = \\sum_{i=1}^{S} \\frac{X_{i}(X_{i}-1)}{n(n-1)}\n$$\n在这里，$(X_{1}, \\dots, X_{S})$ 是从计数为 $(N_{1}, \\dots, N_{S})$、总大小为 $N = \\sum_{i=1}^{S} N_{i}$ 的原始样本中无放回抽取的稀疏化样本中各物种的计数。稀疏化样本的大小为 $n$，其中 $n \\geq 2$。\n\n解决此问题的最直接途径是采用概率论证，正如问题陈述中提及的同物种共现概率所示。量 $\\hat{D}_{n}$ 精确地是从大小为 $n$ 的稀疏化样本中随机、无放回地选取的两个个体属于同一物种的概率。这是因为可以从稀疏化样本中抽取的不同个体对的总数为 $\\binom{n}{2} = \\frac{n(n-1)}{2}$，而属于物种 $i$ 的个体对数量为 $\\binom{X_{i}}{2} = \\frac{X_{i}(X_{i}-1)}{2}$。其比率为：\n$$\n\\frac{\\sum_{i=1}^{S} \\binom{X_{i}}{2}}{\\binom{n}{2}} = \\frac{\\sum_{i=1}^{S} \\frac{X_{i}(X_{i}-1)}{2}}{\\frac{n(n-1)}{2}} = \\sum_{i=1}^{S} \\frac{X_{i}(X_{i}-1)}{n(n-1)} = \\hat{D}_{n}\n$$\n我们被要求求出这个量的期望 $\\mathbb{E}[\\hat{D}_{n}]$。根据全期望定律，这个条件概率（以抽取的特定稀疏化样本为条件）的期望值等于该事件的无条件概率。该事件是：“两个个体属于同一物种”。\n\n让我们考虑整个抽样过程。我们进行一个两阶段实验：\n1. 从包含 $N$ 个个体的初始集合中无放回地抽取一个大小为 $n$ 的随机子样本。\n2. 从这个大小为 $n$ 的子样本中无放回地抽取一对随机个体。\n\n这个两阶段过程在概率上等价于一个单阶段实验：\n- 直接从包含 $N$ 个个体的初始集合中无放回地抽取一对随机个体。\n\n这种等价性成立，因为来自 $N$ 个个体的原始样本中任何可能的个体对最终被选中的概率是相等的。来自原始集合的任何特定个体对 $\\{a, b\\}$ 成为被选中对的概率是 $a$ 和 $b$ 都被包含在大小为 $n$ 的稀疏化样本中的概率，乘以从这 $n$ 个个体中选择该特定对的概率。这个概率是 $\\frac{\\binom{N-2}{n-2}}{\\binom{N}{n}} \\times \\frac{1}{\\binom{n}{2}} = \\frac{n(n-1)}{N(N-1)} \\times \\frac{1}{n(n-1)/2} = \\frac{1}{N(N-1)/2} = \\frac{1}{\\binom{N}{2}}$。这正是直接从 $N$ 个个体中选择对 $\\{a,b\\}$ 的概率。\n\n因此，$\\mathbb{E}[\\hat{D}_{n}]$ 必须等于直接从包含 $N$ 个个体的原始样本中抽取到同物种对的概率。我们将这个量称为 $D_{N}$。原始样本中的总对数为 $\\binom{N}{2}$。物种 $i$ 的同物种对的数量为 $\\binom{N_{i}}{2}$。\n因此，概率 $D_{N}$ 为：\n$$\nD_{N} = \\frac{\\sum_{i=1}^{S} \\binom{N_{i}}{2}}{\\binom{N}{2}} = \\frac{\\sum_{i=1}^{S} \\frac{N_{i}(N_{i}-1)}{2}}{\\frac{N(N-1)}{2}} = \\sum_{i=1}^{S} \\frac{N_{i}(N_{i}-1)}{N(N-1)}\n$$\n根据等价性论证，我们得出结论：\n$$\n\\mathbb{E}[\\hat{D}_{n}] = D_{N} = \\sum_{i=1}^{S} \\frac{N_{i}(N_{i}-1)}{N(N-1)}\n$$\n这一推导直接解决了关于对 $n$ 依赖性的先验论证。推导出的期望值表达式显然与稀疏化样本大小 $n$ 无关。这种无关性之所以产生，是因为 $\\hat{D}_{n}$ 是有限源总体真实辛普森集中度 $D_{N}$ 的一个无偏估计量。该估计量的结构是专门为确保这一点而设计的。分子 $\\sum_{i} X_{i}(X_{i}-1)$ 计的是同物种对的数量，其期望与 $n(n-1)$ 成正比。估计量的分母也是 $n(n-1)$，因此对 $n$ 的依赖性被完全抵消了。只要 $n \\geq 2$，期望值就保持恒定且等于 $D_N$。\n\n现在我们必须根据给定的数据对该表达式进行数值计算：\n总个体数：$N=100$。\n物种计数：$(N_{1}, N_{2}, N_{3}, N_{4}) = (40, 30, 20, 10)$。\n如前所述，稀疏化样本大小 $n=20$ 与期望值无关。\n\n分母为 $N(N-1) = 100 \\times (100-1) = 100 \\times 99 = 9900$。\n\n分子是和 $\\sum_{i=1}^{4} N_{i}(N_{i}-1)$：\n对于 $i=1$：$N_{1}(N_{1}-1) = 40 \\times (40-1) = 40 \\times 39 = 1560$。\n对于 $i=2$：$N_{2}(N_{2}-1) = 30 \\times (30-1) = 30 \\times 29 = 870$。\n对于 $i=3$：$N_{3}(N_{3}-1) = 20 \\times (20-1) = 20 \\times 19 = 380$。\n对于 $i=4$：$N_{4}(N_{4}-1) = 10 \\times (10-1) = 10 \\times 9 = 90$。\n\n和为 $1560 + 870 + 380 + 90 = 2900$。\n\n因此，期望值为：\n$$\n\\mathbb{E}[\\hat{D}_{n}] = \\frac{2900}{9900}\n$$\n为将其表示为一个精确有理数，我们简化此分数：\n$$\n\\frac{2900}{9900} = \\frac{29}{99}\n$$\n数字 $29$ 是一个素数，而 $99 = 3^{2} \\times 11$。它们没有公因数，所以该分数是不可约的。", "answer": "$$\n\\boxed{\\frac{29}{99}}\n$$", "id": "2472851"}, {"introduction": "获得一个点估计值（即使是无偏的）只是分析的第一步；量化其不确定性同样至关重要。本练习将引领你进入现代计算统计学的核心，使用自助法 (bootstrap) 为多样性指数构建置信区间。你将亲手实现并比较两种不同的自助法策略，从而不仅掌握量化不确定性的实用技能，还能学会批判性地评估不同统计方法背后的假设与权衡，这是高级生态学研究的必备能力。[@problem_id:2472860]", "problem": "给定一个有限的生物类别（物种）群落，其观测值为整数计数。设个体总数为 $n$，类别数量为 $K$，观测到的计数向量为 $\\mathbf{x} = (x_1,\\dots,x_K)$，其中 $\\sum_{i=1}^K x_i = n$ 且每个 $x_i \\in \\{0,1,2,\\dots\\}$。目标量是典型的基于熵的多样性指数 $H$，它唯一满足不确定性的标准连续性、对称性和分组（遞歸性）公理，并且在类别概率上是 Schur-凹的。您必须基于一个基本前提进行处理：观测数据来自于对已声明类别上的一个未知分类分布 $\\mathbf{p} = (p_1,\\dots,p_K)$ 进行的独立同分布抽样，且 $\\mathbf{p}$ 的充分统计量是计数 $\\mathbf{x}$。\n\n任务。从 $\\mathbf{x}$ 出发，提出并论证一个非参数自助法程序，为多样性指数 $H$ 构建一个名义覆盖水平等于 $0.95$ 的双侧置信区间，并量化由重抽样零值引入的潜在偏差。您的程序必须实现以下内容：\n\n1) 个体的非参数自助法。使用经验分布（观测到的相对频率）作为生成分布，通过有放回抽样抽取 $B$ 个大小为 $n$ 的自助法复制样本，以获得 $H$ 的置入估计量的自助法分布。使用百分位数法构建置信水平为 $0.95$ 的置信区间。同时，计算自助法偏差估计（统计量的自助法均值与观测到的置入值之差），以及在一个大小为 $n$ 的自助法重抽样样本中，至少一个原始非零类别获得零计数的经验概率。\n\n2) 一种旨在减轻零值影响的平滑自助法变体。在已声明的 $K$ 个类别上使用对称平滑：从一个对称狄利克雷分布中抽取 $B$ 个独立的概率向量，其集中度参数等于 $x_i + \\alpha$，并使用 $\\alpha = 1/2$（即 Jeffreys 先验选择）。对于每次抽取，直接从抽取的概率向量计算 $H$，并报告均值和 $0.95$ 百分位数区间。此构造保留了已声明的零计数类别，从而允许在重抽样期间为它们分配非零的概率质量。对于平滑变体，仅报告这些摘要统计量。\n\n3) 对于这两种程序，均使用自然对数，因此 $H$ 以奈特（nats）为单位度量。没有物理单位。所有数值输出必须是实数。\n\n您不能假设 $H$ 的置入估计量有任何闭式抽样分布。相反，必须遵循上述的自助法构造。所有随机化过程必须按如下方式可复现。设 $B = 100000$。对于测试用例索引 $i \\in \\{1,2,3,4\\}$，为个体的非参数自助法初始化一个伪随机数生成器，种子等于 $123456 + 1000\\,i$；为平滑自助法变体初始化一个伪随机数生成器，种子等于 $123463 + 1000\\,i$。必须完全按照规定，为每个测试用例和每个程序使用独立的流。\n\n对于每个测试用例，您的程序必须返回一个包含八个数字的有序列表：\n- 从 $\\mathbf{x}$ 计算的 $H$ 的观测置入估计值，\n- 非参数自助法 $0.95$ 百分位数区间的下端点，\n- 非参数自助法 $0.95$ 百分位数区间的上端点，\n- 非参数自助法的自助法偏差估计（自助法均值减去观测值），\n- 在自助法重抽样样本中，至少一个原始非零类别获得零计数的经验概率（以 $[0,1]$ 范围的小数表示），\n- 在平滑狄利克雷程序下 $H$ 的均值，\n- 平滑 $0.95$ 百分位数区间的下端点，\n- 平滑 $0.95$ 百分位数区间的上端点。\n\n测试套件。您的程序必须计算并汇总以下四个测试用例的结果，每个用例都以计数向量 $\\mathbf{x}$ 的形式给出：\n- 用例 1（无已声明零值的基线）：$\\mathbf{x} = (40,30,20,10)$。\n- 用例 2（由已声明零值增强的基线）：$\\mathbf{x} = (40,30,20,10,0,0)$。\n- 用例 3（退化的单类别主导）：$\\mathbf{x} = (100,0,0,0)$。\n- 用例 4（跨类别的极端稀有性）：$\\mathbf{x} = (1,1,1,1,1)$。\n\n最终输出格式。您的程序应生成单行输出，其中包含一个列表，该列表有四个内部列表，每个内部列表对应一个测试用例，按索引顺序 $i=1,2,3,4$ 排列。每个内部列表必须按指定顺序包含上述八个浮点数，并四舍五入到小数点后六位。输出必须是包含在方括号内的逗号分隔列表，例如：[[h1,l1,u1,b1,q1,ms1,ls1,us1],[h2,l2,u2,b2,q2,ms2,ls2,us2],[h3,l3,u3,b3,q3,ms3,ls3,us3],[h4,l4,u4,b4,q4,ms4,ls4,us4]]，其中每个占位符代表一个四舍五入到六位小数的实数。不应打印任何其他文本。", "solution": "所提出的问题是有效的。它在科学上基于统计生态学和计算统计学的既定原则，其所有必要的参数和约束都已明确定义，问题是适定的，并且以客观、正式的语言表述。任务是使用两种不同的自助法程序估计香non多样性指数的置信区间，并在几个测试用例上分析它们的属性。我将开始解决此问题。\n\n该问题要求估计一个典型的基于熵的多样性指数 $H$ 的置信区间。所提供的公理——连续性、对称性、分组（遞歸性）和 Schur-凹性——在相差一个缩放常数的情况下，唯一地将此指数确定为香non熵。根据使用自然对数的指令，该指数定义为：\n$$H(\\mathbf{p}) = - \\sum_{i=1}^{K} p_i \\ln(p_i)$$\n其中 $\\mathbf{p} = (p_1, \\dots, p_K)$ 是 $K$ 个类别的真实、未知概率向量，满足 $\\sum p_i = 1$ 和 $p_i \\ge 0$。使用约定 $0 \\ln(0) = 0$。数据由一个来自大小为 $n = \\sum x_i$ 的样本的观测计数向量 $\\mathbf{x} = (x_1, \\dots, x_K)$ 组成。\n\n对 $H$ 最直接的估计是置入估计量，其中未知的概率 $\\mathbf{p}$ 被数据中的经验估计值 $\\hat{\\mathbf{p}} = \\mathbf{x}/n$ 替代。\n$$\\hat{H} = H(\\hat{\\mathbf{p}}) = - \\sum_{i=1}^{K} \\frac{x_i}{n} \\ln\\left(\\frac{x_i}{n}\\right)$$\n已知该估计量是有偏的，通常会低估真实的熵，尤其是在小样本量 $n$ 的情况下。我们现在将构建所要求的两种自助法程序来构造置信区间并评估偏差。\n\n**程序 1：个体的非参数自助法**\n\n该程序通过从数据本身进行重抽样来模拟抽样过程。它在经验分布 $\\hat{\\mathbf{p}}$ 是真实潜在分布 $\\mathbf{p}$ 的一个良好近似的假设下运行。\n\n1.  原理：我们从原始样本中有放回地抽取 $B$ 个大小为 $n$ 的新样本。这等同于通过从参数为 $n$ 和 $\\hat{\\mathbf{p}}$ 的多项分布中抽样来生成 $B$ 个自助法计数向量 $\\mathbf{x}^*_j$：\n    $$\\mathbf{x}^*_j \\sim \\text{Multinomial}(n, \\hat{\\mathbf{p}})$$\n2.  统计量计算：对于每个自助法计数向量 $\\mathbf{x}^*_j$，我们应用置入公式计算相应的统计量的自助法复制值 $\\hat{H}^*_j$：\n    $$\\hat{H}^*_j = - \\sum_{i=1}^{K} \\frac{x^*_{ij}}{n} \\ln\\left(\\frac{x^*_{ij}}{n}\\right)$$\n    集合 $\\{\\hat{H}^*_j\\}_{j=1}^{B}$ 构成了估计量 $\\hat{H}$ 的经验自助法分布。\n3.  置信区间：通过取有序自助法分布 $\\{\\hat{H}^*_j\\}$ 的第 $2.5$ 和第 $97.5$ 百分位数来构建 $95\\%$ 百分位置信区间。\n4.  偏差估计：自助法偏差估计是自助法分布的均值与原始观测统计量之差：\n    $$\\text{Bias}_{\\text{boot}} = \\left(\\frac{1}{B} \\sum_{j=1}^{B} \\hat{H}^*_j\\right) - \\hat{H}_{\\text{obs}}$$\n5.  零计数事件：一个关键问题是，尤其对于小样本量 $n$ 或稀有物种，一个观测计数 $x_i > 0$ 的类别在自助法重抽样样本中可能会得到一个 $x_i^*=0$ 的计数。这会人为地降低重抽样样本中观测到的丰富度，并导致熵估计量的负偏差。我们通过计算在 $B$ 个复制样本中此事件的经验概率来量化这一点，具体来说，就是至少有一个 $x_i > 0$ 的类别其 $x_i^*=0$ 的自助法样本所占的比例。\n\n**程序 2：平滑自助法（狄利克雷抽样）**\n\n该程序采用贝叶斯框架来解释潜在概率 $\\mathbf{p}$ 的不确定性，并对观测计数进行平滑处理，以减轻零值问题。\n\n1.  原理：我们不从固定的经验分布中重抽样，而是使用概率分布来为我们关于 $\\mathbf{p}$ 的不确定性建模。狄利克雷分布是多项似然的共轭先验。给定一个狄利克雷先验 $\\mathbf{p} \\sim \\text{Dir}(\\mathbf{\\alpha}_{\\text{prior}})$，在观测到计数 $\\mathbf{x}$ 后的后验分布也是一个狄利克雷分布：\n    $$\\mathbf{p} | \\mathbf{x} \\sim \\text{Dir}(\\mathbf{x} + \\mathbf{\\alpha}_{\\text{prior}})$$\n    问题指定使用 Jeffreys 先验，这对应于对所有 $i=1, \\dots, K$ 都有 $\\alpha_{\\text{prior}, i} = 1/2$。这是无信息先验的一个常见选择。因此，我们从后验分布中抽样概率向量 $\\mathbf{p}^*$：\n    $$\\mathbf{p}^*_j \\sim \\text{Dir}(x_1 + 1/2, x_2 + 1/2, \\dots, x_K + 1/2)$$\n2.  统计量计算：对于 $B$ 个抽样得到的概率向量中的每一个 $\\mathbf{p}^*_j$，我们直接计算其熵：\n    $$H_j^* = H(\\mathbf{p}^*_j) = - \\sum_{i=1}^{K} p^*_{ij} \\ln(p^*_{ij})$$\n    由于狄利克雷分布的所有参数都是正的 ($x_i + 1/2 > 0$)，每个抽样得到的概率 $p^*_{ij}$ 都将严格为正，从而避免了 $0\\ln(0)$ 的问题，并“激活”了在原始样本中计数为零的类别。\n3.  摘要统计量：得到的集合 $\\{H_j^*\\}_{j=1}^{B}$ 是来自熵 $H$ 的后验分布的一个样本。我们计算其均值，该均值可作为 $H$ 的偏差校正的点估计；并计算其 $95\\%$ 百分位数区间（在贝叶斯意义上是一个可信区间），该区间代表了真实熵 $H$ 的可能取值范围。\n\n对于这两种程序，自助法复制样本的数量为 $B=100000$。随机化过程由为每个测试用例和程序指定的种子设定协议控制，以确保可复现性。", "answer": "```python\nimport numpy as np\n\ndef calculate_shannon_entropy(props):\n    \"\"\"\n    Calculates Shannon entropy for a vector of proportions.\n    H = -sum(p * log(p)) for p > 0.\n    \"\"\"\n    # Ensure proportions is a numpy array for vectorized operations\n    props = np.asarray(props)\n    \n    # Use np.log's `where` argument to handle p=0, avoiding warnings and ensuring 0*log(0)=0.\n    log_p = np.log(props, where=(props > 0))\n    return -np.sum(props * log_p, axis=-1)\n\ndef solve():\n    \"\"\"\n    Main solver function to execute the problem's requirements for all test cases.\n    \"\"\"\n    test_cases = [\n        (40, 30, 20, 10),\n        (40, 30, 20, 10, 0, 0),\n        (100, 0, 0, 0),\n        (1, 1, 1, 1, 1),\n    ]\n    B = 100000\n    all_results = []\n\n    for i, x_tuple in enumerate(test_cases, 1):\n        x = np.array(x_tuple, dtype=np.float64)\n        n = np.sum(x)\n        K = len(x)\n        \n        # Calculate observed plug-in estimate\n        if n == 0:\n            # Handle case of empty sample, though not in test suite.\n            p_hat = np.zeros_like(x)\n        else:\n            p_hat = x / n\n        h_obs = calculate_shannon_entropy(p_hat)\n\n        # 1. Nonparametric bootstrap of individuals\n        seed_np = 123456 + 1000 * i\n        rng_np = np.random.default_rng(seed_np)\n        \n        h_boot_values = np.zeros(B)\n        prob_zero_disappearance = 0.0\n\n        if n > 0:\n            # Generate B bootstrap samples from multinomial distribution\n            boot_counts = rng_np.multinomial(int(n), p_hat, size=B)\n            \n            # Calculate entropy for each bootstrap sample\n            boot_props = boot_counts / n\n            h_boot_values = calculate_shannon_entropy(boot_props)\n            \n            # Calculate CI and bias\n            l_np, u_np = np.percentile(h_boot_values, [2.5, 97.5])\n            bias_np = np.mean(h_boot_values) - h_obs\n            \n            # Calculate probability of zero-count disappearance\n            nonzero_indices = np.where(x > 0)[0]\n            if nonzero_indices.size > 0:\n                # Check if any originally non-zero category becomes zero\n                sub_boot_counts = boot_counts[:, nonzero_indices]\n                num_disappearances = np.sum(np.any(sub_boot_counts == 0, axis=1))\n                prob_zero_disappearance = num_disappearances / B\n        else: # Handle n=0 case explicitly\n            l_np, u_np = h_obs, h_obs\n            bias_np = 0.0\n            prob_zero_disappearance = 0.0\n\n        # 2. Smoothed bootstrap variant (Dirichlet sampling)\n        seed_smooth = 123463 + 1000 * i\n        rng_smooth = np.random.default_rng(seed_smooth)\n        \n        # Define Dirichlet parameters (posterior from Jeffreys prior)\n        dir_params = x + 0.5\n        \n        # Generate B probability vectors from the Dirichlet distribution\n        boot_probs_smooth = rng_smooth.dirichlet(dir_params, size=B)\n        \n        # Calculate entropy for each probability vector\n        h_smooth_values = calculate_shannon_entropy(boot_probs_smooth)\n        \n        # Calculate mean and CI\n        mean_s = np.mean(h_smooth_values)\n        l_s, u_s = np.percentile(h_smooth_values, [2.5, 97.5])\n\n        # Aggregate results for this case\n        case_results = [h_obs, l_np, u_np, bias_np, prob_zero_disappearance, mean_s, l_s, u_s]\n        all_results.append(case_results)\n\n    # Format the final output string as per requirements\n    output_str = \"[\" + \",\".join([\n        \"[\" + \",\".join([f\"{num:.6f}\" for num in res]) + \"]\" \n        for res in all_results\n    ]) + \"]\"\n    \n    print(output_str)\n\nsolve()\n```", "id": "2472860"}]}