{"hands_on_practices": [{"introduction": "性状置换的核心机制是竞争强度与生态位重叠成正比。为了将这一概念形式化，理论生态学家常将竞争强度建模为物种间资源利用的重叠函数。本练习 [@problem_id:2475761] 将引导你推导这个重叠积分的经典表达式，帮助你建立关于性状分离如何直接降低潜在竞争的量化直觉。", "problem": "在一个经典的关于种间竞争的消费者-资源框架中，假设两个（$2$）物种由一个连续的生态位位置性状 $z$ 来表征，该性状决定了它们沿一维（$1$-D）非生物资源轴 $R \\in \\mathbb{R}$ 的资源利用均值。设生态位位置为 $z$ 的物种的资源利用函数是高斯函数，并归一化使其积分为 $1$，因此可以解释为资源上的一个概率密度：\n$$\nu(z,R) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\!\\left(-\\frac{(R - z)^{2}}{2\\,\\omega^{2}}\\right),\n$$\n其中 $\\omega>0$ 是生态位宽度（标准差），并假设在物种间是相等的。\n\n定义重叠积分\n$$\nO(z_{1},z_{2}) \\;=\\; \\int_{-\\infty}^{\\infty} u(z_{1},R)\\,u(z_{2},R)\\,dR,\n$$\n该积分通过共享资源利用来量化潜在种间竞争的程度，并被广泛用于将竞争强度与资源重叠联系起来的理论中。\n\n仅从 $u(z,R)$ 的归一化、指数法则以及对任意 $a>0$ 成立的标准高斯积分 $\\int_{-\\infty}^{\\infty} \\exp\\!\\left(-a\\,(x-b)^{2}\\right)\\,dx \\,=\\, \\sqrt{\\pi/a}$ 出发，推导出一个关于性状分离 $|z_{1}-z_{2}|$ 和生态位宽度 $\\omega$ 的 $O(z_{1},z_{2})$ 的闭式表达式。然后，利用生态竞争理论中的典范假设，即人均竞争影响随 $O(z_{1},z_{2})$ 单调增加，解释在频率依赖选择下 $O$ 的进化最小化如何与性状替换和性状分化相关联，并明确指出 $\\omega$ 作为尺度参数在性状空间中对重叠强度和空间范围的作用。\n\n你最终报告的答案必须是 $O$ 关于 $|z_{1}-z_{2}|$ 和 $\\omega$ 的单一闭式解析表达式。不需要进行数值评估或四舍五入，也不需要报告任何单位。", "solution": "问题陈述呈现了理论生态学中的一个经典表述，它具有科学依据、是良定的且客观的。它包含了进行严格数学推导和基于已建立的生态学原理进行后续解释所需的所有必要信息和定义。因此，该问题被认为是有效的，并将提供完整的解答。\n\n目标是推导重叠积分 $O(z_{1}, z_{2})$ 的闭式表达式，其定义为：\n$$\nO(z_{1}, z_{2}) = \\int_{-\\infty}^{\\infty} u(z_{1},R)\\,u(z_{2},R)\\,dR\n$$\n其中，生态位位置为 $z$ 的物种的资源利用函数 $u(z,R)$ 由高斯概率密度函数给出：\n$$\nu(z,R) = \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z)^{2}}{2\\,\\omega^{2}}\\right)\n$$\n我们首先将 $u(z,R)$ 的表达式代入具有生态位位置 $z_1$ 和 $z_2$ 的两个物种的重叠积分定义中：\n$$\nO(z_1, z_2) = \\int_{-\\infty}^{\\infty} \\left[ \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z_1)^{2}}{2\\omega^{2}}\\right) \\right] \\left[ \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z_2)^{2}}{2\\omega^{2}}\\right) \\right] dR\n$$\n我们合并常数前置因子，并使用指数性质 $\\exp(A)\\exp(B) = \\exp(A+B)$ 来合并指数项：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{(R - z_1)^2}{2\\omega^2} - \\frac{(R - z_2)^2}{2\\omega^2} \\right) dR\n$$\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{(R-z_1)^2 + (R-z_2)^2}{2\\omega^2} \\right) dR\n$$\n为了继续进行，我们必须将指数的自变量处理成与所给的标准高斯积分相匹配的形式。我们通过对包含积分变量 $R$ 的项进行配方来完成此操作。让我们展开指数自变量分子中的二次项：\n$$\n(R-z_1)^2 + (R-z_2)^2 = (R^2 - 2Rz_1 + z_1^2) + (R^2 - 2Rz_2 + z_2^2) = 2R^2 - 2R(z_1+z_2) + (z_1^2 + z_2^2)\n$$\n现在我们对含 $R$ 的项进行配方：\n$$\n2R^2 - 2R(z_1+z_2) + (z_1^2 + z_2^2) = 2\\left[ R^2 - R(z_1+z_2) + \\frac{z_1^2+z_2^2}{2} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\left(\\frac{z_1+z_2}{2}\\right)^2 + \\frac{z_1^2+z_2^2}{2} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{z_1^2+2z_1z_2+z_2^2}{4} + \\frac{2z_1^2+2z_2^2}{4} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{z_1^2-2z_1z_2+z_2^2}{4} \\right] = 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{(z_1-z_2)^2}{4} \\right]\n$$\n将此结果代回指数函数的自变量中：\n$$\n-\\frac{1}{2\\omega^2} \\left( 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{(z_1-z_2)^2}{4} \\right] \\right) = -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{(z_1-z_2)^2}{4\\omega^2}\n$$\n$O(z_1, z_2)$ 的积分现在变为：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{(z_1-z_2)^2}{4\\omega^2} \\right) dR\n$$\n项 $\\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right)$ 不依赖于积分变量 $R$，可以移到积分号外：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right) \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 \\right) dR\n$$\n剩下的积分是标准高斯形式 $\\int_{-\\infty}^{\\infty} \\exp(-a(x-b)^2)dx = \\sqrt{\\pi/a}$，其中 $x=R$，$a = 1/\\omega^2$，$b = (z_1+z_2)/2$。该积分的值为：\n$$\n\\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 \\right) dR = \\sqrt{\\frac{\\pi}{1/\\omega^2}} = \\sqrt{\\pi\\omega^2} = \\omega\\sqrt{\\pi}\n$$\n将此结果代回 $O(z_1, z_2)$ 的表达式中：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right) \\left(\\omega\\sqrt{\\pi}\\right)\n$$\n最后，简化前置因子得到重叠积分的闭式表达式：\n$$\nO(z_1, z_2) = \\frac{1}{2\\omega\\sqrt{\\pi}} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right)\n$$\n该表达式依赖于生态位位置的差的平方 $(z_1-z_2)^2$，因此是性状分离 $|z_1 - z_2|$ 和生态位宽度 $\\omega$ 的函数，符合要求。\n\n现在进行解释。问题指出，人均竞争影响是 $O(z_1, z_2)$ 的单调递增函数。在由种间竞争引起的频率依赖选择下，自然选择将偏好那些其性状能够最小化这种竞争压力的个体。为了最小化 $O(z_1, z_2)$，指数函数的自变量（为负值）的绝对值必须尽可能大。这需要最大化项 $\\frac{(z_1-z_2)^2}{4\\omega^2}$。对于固定的生态位宽度 $\\omega$而言，这通过最大化性状分离 $|z_1-z_2|$ 来实现。种间竞争驱动竞争物种的性状变得更加不同的进化过程被称为**性状分异**。由此产生的 $|z_1-z_2|$ 的增加即为**性状分化**。因此，重叠积分 $O$ 的进化最小化直接对应于性状分异的过程。\n\n生态位宽度 $\\omega$ 作为一个尺度参数扮演着关键角色。指数的自变量 $-\\left(\\frac{|z_1-z_2|}{2\\omega}\\right)^2$ 揭示了竞争重叠并非绝对性状分离 $|z_1-z_2|$ 的函数，而是该分离经生态位宽度缩放后的函数。\n$1$. $\\omega$ 定义了性状空间中竞争相互作用的特征尺度或“空间范围”。当 $|z_1-z_2|$ 与 $\\omega$ 处于同一数量级时，会发生显著的竞争，从而产生显著的分化选择压力。如果 $|z_1-z_2| \\gg 2\\omega$，重叠变得可以忽略不计，选择压力也随之消失。\n$2$. $\\omega$ 调节竞争的强度。前置因子 $1/(2\\omega\\sqrt{\\pi})$ 表明，对于完全重叠的生态位（$z_1=z_2$），生态位较窄（$\\omega$ 较小）的物种之间的竞争更强，因为它们的资源利用更为集中。相反，指数项表明，对于固定的分离度 $|z_1-z_2|$，较大的 $\\omega$ 会导致重叠更缓慢地减小。这意味着广食性物种（大 $\\omega$）的竞争强度较低，但在更宽的生态位分离范围内进行竞争；相比之下，专食性物种（小 $\\omega$）的竞争非常激烈，但仅当它们的生态位非常相似时才会如此。因此，$\\omega$ 对性状空间中竞争的强度和范围都进行了缩放，从而从根本上塑造了性状分异的动态过程。", "answer": "$$\\boxed{\\frac{1}{2\\omega\\sqrt{\\pi}}\\exp\\left(-\\frac{(z_{1}-z_{2})^{2}}{4\\omega^{2}}\\right)}$$", "id": "2475761"}, {"introduction": "性状置换为何对生态群落至关重要？一个关键原因是它在促进物种共存中的作用。通过减弱种间竞争，性状分化可以使那些原本可能因竞争排斥而无法共存的物种得以持续存在。本练习 [@problem_id:2475710] 应用了共存理论的原理，使用一个离散时间种群模型，让你判断观察到的性状值变化是否足以跨过从竞争排斥到稳定共存的关键阈值。", "problem": "两个生态学上相似的一年生植物物种经历了性状替换，通过性状分异降低了它们的生态位重叠。您需要确定该系统是否跨过了共存阈值，即每个物种在稀有时都能够入侵。\n\n假设一个用于描述一年生植物的双物种 Beverton–Holt (BH) 竞争模型，其人均有限增长率（内禀增长率）为 $\\lambda_{1}$ 和 $\\lambda_{2}$，成对竞争系数为 $\\alpha_{ij}$：\n$$\nN_{i,t+1} \\;=\\; \\frac{\\lambda_{i}\\,N_{i,t}}{1 \\;+\\; \\alpha_{ii}\\,N_{i,t} \\;+\\; \\alpha_{ij}\\,N_{j,t}}\\,, \\quad i\\neq j,\\; i,j\\in\\{1,2\\}.\n$$\n假设种内竞争被缩放，使得 $\\alpha_{11}=\\alpha_{22}=1$，且经验生态位重叠是对称的，因此 $\\alpha_{12}=\\alpha_{21}=\\rho$，其中 $0<\\rho<1$。在这些假设下，物种共存由相互入侵准则定义：每个物种在另一个物种处于其单物种平衡状态下，当自身稀有时必须具有正增长。\n\n性状分异前（历史同域分布）和性状分异后（现代同域分布）的经验估计值如下：\n- 性状分异前：$\\rho_{\\mathrm{b}}=0.75$, $\\lambda_{1,\\mathrm{b}}=2.0$, $\\lambda_{2,\\mathrm{b}}=1.5$。\n- 性状分异后：$\\rho_{\\mathrm{a}}=0.50$, $\\lambda_{1,\\mathrm{a}}=1.8$, $\\lambda_{2,\\mathrm{a}}=1.6$。\n\n从 Beverton–Holt 方程、稀有入侵的定义以及 BH 模型的单物种平衡出发，推导出以 $\\rho$ 和内禀增长率表示的相互入侵条件。然后，对“之前”和“之后”的参数集评估这些条件，以确定系统是否因性状分异而跨过共存阈值，即从不满足相互入侵（“之前”）转变为满足相互入侵（“之后”）。\n\n设 $X$ 是一个指示变量，定义为如果系统按此意义跨过共存阈值，则 $X=1$，否则 $X=0$。报告 $X$ 的单一数值。无需四舍五入。答案是无量纲的；将 $X$ 报告为一个纯数。", "solution": "该问题要求推导并应用双物种 Beverton-Holt 竞争模型的相互入侵准则，以确定性状替换是否促成了共存。我们必须首先验证问题陈述。\n\n该问题提供了一个明确定义的数学模型：\n$$\nN_{i,t+1} \\;=\\; \\frac{\\lambda_{i}\\,N_{i,t}}{1 \\;+\\; \\alpha_{ii}\\,N_{i,t} \\;+\\; \\alpha_{ij}\\,N_{j,t}}\n$$\n其中物种 $i,j \\in \\{1,2\\}$ 且 $i \\neq j$。参数被定义为内禀增长率 $\\lambda_i$ 和竞争系数 $\\alpha_{ij}$。给出了特定的约束条件：$\\alpha_{11} = \\alpha_{22} = 1$ 和 $\\alpha_{12} = \\alpha_{21} = \\rho$，其中 $0 < \\rho < 1$。提供了两组参数，分别对应于性状分异“之前”和“之后”的状态。共存的定义被明确表述为相互入侵准则。目标是根据系统是否从非共存状态过渡到共存状态来计算指示变量 $X$。\n\n问题陈述具有科学依据，使用了理论生态学的标准模型和概念。它的数学表述是适定的，提供了所有必要的信息和一个明确的目标。参数在生物学上是合理的范围内（例如，所有的 $\\lambda > 1$，这是种群持续生存所必需的）。没有内部矛盾、模糊之处或伪科学主张。因此，该问题被视为有效。我们继续进行求解。\n\n相互入侵准则指出，为了实现稳定共存，每个物种在自身稀少而另一物种处于其单物种平衡环境承载力时，其种群数量必须能够增加。\n\n首先，我们确定物种 $i$ 的单物种平衡密度，记为 $N_i^*$。这可以通过在物种 $i$ 的模型中设 $N_j=0$ 并求解非平凡平衡点 $N_{i,t+1} = N_{i,t} = N_i^*$ 来找到。\n$$\nN_i^* = \\frac{\\lambda_i N_i^*}{1 + \\alpha_{ii} N_i^*}\n$$\n当 $N_i^* > 0$ 时，我们可以两边同除以 $N_i^*$：\n$$\n1 = \\frac{\\lambda_i}{1 + \\alpha_{ii} N_i^*}\n$$\n$$\n1 + \\alpha_{ii} N_i^* = \\lambda_i\n$$\n$$\nN_i^* = \\frac{\\lambda_i - 1}{\\alpha_{ii}}\n$$\n根据 $\\alpha_{11} = \\alpha_{22} = 1$ 的假设，单物种平衡点为：\n$$\nN_1^* = \\lambda_1 - 1\n$$\n$$\nN_2^* = \\lambda_2 - 1\n$$\n为了使这些平衡点为正且稳定，要求 $\\lambda_i > 1$，所有提供的经验估计值都满足此条件。\n\n接下来，我们建立一个物种入侵另一个物种的条件。物种 $j$ 能够入侵物种 $i$ 的稳定种群（处于其平衡点 $N_i^*$），当且仅当物种 $j$ 的密度极小（$N_j \\to 0$）时，其人均增长率大于1。在物种 $i$ 存在的情况下，物种 $j$ 的人均增长率为：\n$$\n\\frac{N_{j,t+1}}{N_{j,t}} = \\frac{\\lambda_j}{1 + \\alpha_{jj} N_{j,t} + \\alpha_{ji} N_{i,t}}\n$$\n设 $N_j \\to 0$ 且 $N_i = N_i^*$，物种 $j$ 的入侵增长率为 $\\frac{\\lambda_j}{1 + \\alpha_{ji} N_i^*}$。成功入侵的条件是：\n$$\n\\frac{\\lambda_j}{1 + \\alpha_{ji} N_i^*} > 1 \\implies \\lambda_j > 1 + \\alpha_{ji} N_i^*\n$$\n为了实现相互入侵，两个物种都必须能够入侵对方。我们将这个一般条件应用于我们的具体系统。\n\n条件1：物种2入侵物种1。\n这要求物种2在一个处于平衡点 $N_1^* = \\lambda_1 - 1$ 的物种1种群中，当自身稀有时能够增长。\n$$\n\\lambda_2 > 1 + \\alpha_{21} N_1^*\n$$\n代入 $N_1^*$ 并使用假设 $\\alpha_{21}=\\rho$：\n$$\n\\lambda_2 > 1 + \\rho (\\lambda_1 - 1)\n$$\n\n条件2：物种1入侵物种2。\n这要求物种1在一个处于平衡点 $N_2^* = \\lambda_2 - 1$ 的物种2种群中，当自身稀有时能够增长。\n$$\n\\lambda_1 > 1 + \\alpha_{12} N_2^*\n$$\n代入 $N_2^*$ 并使用假设 $\\alpha_{12}=\\rho$：\n$$\n\\lambda_1 > 1 + \\rho (\\lambda_2 - 1)\n$$\n当且仅当这两个不等式都满足时，共存才可能。\n\n现在，我们对给定的两个参数集评估这些条件。\n\n情况1：性状分异前。\n参数为 $\\rho_{\\mathrm{b}} = 0.75$，$\\lambda_{1,\\mathrm{b}} = 2.0$ 和 $\\lambda_{2,\\mathrm{b}} = 1.5$。\n我们检查这两个条件。\n条件1（物种2入侵1）：\n$\\lambda_{2,\\mathrm{b}} > 1 + \\rho_{\\mathrm{b}} (\\lambda_{1,\\mathrm{b}} - 1)$ 是否成立？\n$$\n1.5 > 1 + 0.75 (2.0 - 1)\n$$\n$$\n1.5 > 1 + 0.75 (1)\n$$\n$$\n1.5 > 1.75\n$$\n这个不等式不成立。\n\n由于相互入侵的一个条件未被满足，我们可以得出结论，在这种情况下共存是不可能的。为了完整性，我们检查第二个条件。\n条件2（物种1入侵2）：\n$\\lambda_{1,\\mathrm{b}} > 1 + \\rho_{\\mathrm{b}} (\\lambda_{2,\\mathrm{b}} - 1)$ 是否成立？\n$$\n2.0 > 1 + 0.75 (1.5 - 1)\n$$\n$$\n2.0 > 1 + 0.75 (0.5)\n$$\n$$\n2.0 > 1 + 0.375\n$$\n$$\n2.0 > 1.375\n$$\n这个不等式成立。然而，由于条件1不成立，相互入侵条件未被满足。该系统在性状分异前不存在共存。\n\n情况2：性状分异后。\n参数为 $\\rho_{\\mathrm{a}} = 0.50$，$\\lambda_{1,\\mathrm{a}} = 1.8$ 和 $\\lambda_{2,\\mathrm{a}} = 1.6$。\n我们用新的参数再次检查这两个条件。\n条件1（物种2入侵1）：\n$\\lambda_{2,\\mathrm{a}} > 1 + \\rho_{\\mathrm{a}} (\\lambda_{1,\\mathrm{a}} - 1)$ 是否成立？\n$$\n1.6 > 1 + 0.50 (1.8 - 1)\n$$\n$$\n1.6 > 1 + 0.50 (0.8)\n$$\n$$\n1.6 > 1 + 0.4\n$$\n$$\n1.6 > 1.4\n$$\n这个不等式成立。\n\n条件2（物种1入侵2）：\n$\\lambda_{1,\\mathrm{a}} > 1 + \\rho_{\\mathrm{a}} (\\lambda_{2,\\mathrm{a}} - 1)$ 是否成立？\n$$\n1.8 > 1 + 0.50 (1.6 - 1)\n$$\n$$\n1.8 > 1 + 0.50 (0.6)\n$$\n$$\n1.8 > 1 + 0.3\n$$\n$$\n1.8 > 1.3\n$$\n这个不等式也成立。\n\n由于两个条件都满足，相互入侵条件被满足。该系统在性状分异后表现出共存。\n\n问题要求指示变量 $X$ 的值，其中如果系统跨过共存阈值，则 $X=1$，否则 $X=0$。“跨过阈值”被定义为从不满足相互入侵（“之前”）转变为满足相互入侵（“之后”）。\n我们的分析表明：\n- 分异前：不满足共存条件。\n- 分异后：满足共存条件。\n\n该系统已经从非共存状态过渡到共存状态。因此，系统跨过了共存阈值。这对应的值为 $X=1$。", "answer": "$$\\boxed{1}$$", "id": "2475710"}, {"introduction": "观察到同域分布的物种性状比异域分布时分化更大，是性状置换的经典模式，但我们如何确定该模式并非偶然？现代生态学依赖于稳健的统计方法来回答这一问题。这个实践性很强的练习 [@problem_id:2475692] 将介绍零模型和置换检验的逻辑，指导你实现一种计算方法，以严格评估观察到的性状分化模式的统计显著性。", "problem": "考虑一对生态互作物种，在多个位点测量其单一连续形态性状。每个位点要么是同域（两种物种共同出现），要么是异域（每种物种在没有另一种的情况下出现，但有可比较的性状测量值）。性状置换假说认为，由于种间竞争，同域中的性状分化大于异域。请构建一个零模型和置换检验，以评估在保留位点内经验性状分布的同时，观察到的同域性状分化是否超过异域。\n\n使用以下内容作为基本依据：\n- 零假设陈述，同域与异域的标签在各位点间是可交换的，这意味着共存条件与性状分化之间没有系统的关联。在此零假设下，位点级的经验性状分布得以保留，仅置换其标签。\n- 某个物种在某个位点的样本均值为 $\\bar{x} = \\frac{1}{n}\\sum_{j=1}^{n} x_j$。\n- 当 $n \\ge 2$ 时，某个物种在某个位点的无偏样本方差为 $s^2 = \\frac{1}{n-1}\\sum_{j=1}^{n} (x_j - \\bar{x})^2$；如果 $n < 2$，则定义 $s^2 = 0$。\n- 对于一个物种特异性样本量为 $n_{iA}$ 和 $n_{iB}$、无偏方差为 $s^2_{iA}$ 和 $s^2_{iB}$ 的位点 $i$，其位点内合并标准差为\n$$\ns_{p,i} = \n\\begin{cases}\n\\sqrt{\\dfrac{(n_{iA}-1)s^2_{iA} + (n_{iB}-1)s^2_{iB}}{n_{iA}+n_{iB}-2}}, & \\text{若 } n_{iA}+n_{iB}-2 > 0,\\\\\n0, & \\text{其他情况。}\n\\end{cases}\n$$\n- 位点级标准化分化为\n$$\nd_i = \n\\begin{cases}\n\\dfrac{\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|}{s_{p,i}}, & \\text{若 } s_{p,i} > 0,\\\\\n\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|, & \\text{若 } s_{p,i} = 0.\n\\end{cases}\n$$\n\n将检验统计量定义为同域和异域位点之间平均标准化分化的差异，\n$$\nT_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}},\n$$\n其中 $\\overline{d}_{\\text{sym}}$ 是标记为同域的位点上 $d_i$ 的均值，而 $\\overline{d}_{\\text{allo}}$ 是标记为异域的位点上 $d_i$ 的均值。\n\n零模型和置换检验规范：\n- 保留每个位点两种物种的经验性状值（及其均值和方差）。\n- 仅随机化同域与异域标签在各位点间的分配，并保留观察到的同域和异域位点的数量。\n- 通过枚举所有具有与观察值相同数量的同域和异域标签的不同位点重标记，来计算检验统计量的精确零分布。\n- 计算用于评估同域分化富集的单尾 $p$ 值，公式如下\n$$\np = \\frac{1}{N}\\sum_{b=1}^{N} \\mathbf{1}\\!\\left(T^{(b)} \\ge T_{\\text{obs}}\\right),\n$$\n其中 $N$ 是标签置换的总数，$T^{(b)}$ 是置换 $b$ 下的检验统计量，$\\mathbf{1}(\\cdot)$ 是指示函数。相等情况计为支持备择假设，这使得检验是保守的。\n\n实现一个程序，对以下测试套件执行此精确置换检验。对于下方的每个数据集，程序必须：\n- 为每个位点计算 $d_i$。\n- 计算 $T_{\\text{obs}}$。\n- 枚举所有保留观察到的同域和异域位点数量的标签置换。\n- 按上述方法计算单尾精确 $p$ 值。\n- 报告四舍五入到六位小数的 $p$ 值。\n\n测试套件（每个位点列出物种A和物种B的性状值）：\n\n数据集1（清晰的同域分化信号；$6$个位点，$3$个同域，$3$个异域）：\n- 同域位点：\n  - 位点 S1：物种A $\\{9.8, 10.1, 10.2, 9.9\\}$，物种B $\\{6.1, 6.3, 5.9, 6.0\\}$。\n  - 位点 S2：物种A $\\{9.2, 9.0, 9.1, 9.3\\}$，物种B $\\{5.0, 5.3, 4.9, 5.1\\}$。\n  - 位点 S3：物种A $\\{8.4, 8.6, 8.7, 8.5\\}$，物种B $\\{4.6, 4.4, 4.5, 4.7\\}$。\n- 异域位点：\n  - 位点 A1：物种A $\\{7.0, 7.1, 7.2, 6.9\\}$，物种B $\\{6.7, 6.6, 6.5, 6.8\\}$。\n  - 位点 A2：物种A $\\{7.3, 7.2, 7.1, 7.4\\}$，物种B $\\{6.9, 7.0, 6.8, 6.7\\}$。\n  - 位点 A3：物种A $\\{6.8, 7.0, 6.9, 6.7\\}$，物种B $\\{6.5, 6.6, 6.4, 6.7\\}$。\n\n数据集2（边界情况；$4$个位点，$2$个同域，$2$个异域）：\n- 同域位点：\n  - 位点 S1：物种A $\\{7.0, 7.1, 6.9, 7.0\\}$，物种B $\\{6.6, 6.7, 6.5, 6.6\\}$。\n  - 位点 S2：物种A $\\{8.0, 8.1, 7.9, 8.05\\}$，物种B $\\{7.6, 7.7, 7.5, 7.6\\}$。\n- 异域位点：\n  - 位点 A1：物种A $\\{9.0, 9.1, 8.9, 9.05\\}$，物种B $\\{8.6, 8.7, 8.5, 8.6\\}$。\n  - 位点 A2：物种A $\\{6.0, 6.1, 5.9, 6.05\\}$，物种B $\\{5.6, 5.7, 5.5, 5.6\\}$。\n\n数据集3（小样本边缘案例；$3$个位点，$1$个同域，$2$个异域）：\n- 同域位点：\n  - 位点 S1：物种A $\\{5.0, 5.1\\}$，物种B $\\{5.0, 5.1\\}$。\n- 异域位点：\n  - 位点 A1：物种A $\\{5.0, 5.05\\}$，物种B $\\{5.5, 5.45\\}$。\n  - 位点 A2：物种A $\\{7.0\\}$，物种B $\\{7.0\\}$。\n\n程序要求：\n- 为每个数据集实现上述的精确置换检验。\n- 您的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$\\texttt{[result1,result2,result3]}$），每个结果是对应数据集的单尾精确 $p$ 值，四舍五入到六位小数。\n- 运行时不提供输入；将测试套件嵌入程序中。输出中不需要物理单位，因为结果是无量纲的概率。", "solution": "问题陈述提出了一个在演化生态学中定义明确且具有科学依据的问题，我们现在将着手解决。任务是实现一个精确置换检验，以评估性状置换假说。该假说预测，与异域相比，同域中的种间竞争导致了更大的形态性状分化。我们将验证该问题，然后构建一个严谨的解决方案。\n\n**问题验证**\n\n首先，我们提取指定的所有已知条件。\n\n**提取的已知条件：**\n*   **零假设 ($H_0$):** “同域”和“异域”的标签在各位点间是可交换的。这意味着共存对性状分化没有系统性影响。\n*   **样本均值:** $\\bar{x} = \\frac{1}{n}\\sum_{j=1}^{n} x_j$。\n*   **无偏样本方差:** 对于 $n \\ge 2$，$s^2 = \\frac{1}{n-1}\\sum_{j=1}^{n} (x_j - \\bar{x})^2$，并定义当 $n < 2$ 时 $s^2 = 0$。\n*   **位点内合并标准差 ($s_{p,i}$):** 对于一个样本量为 $n_{iA}$ 和 $n_{iB}$、方差为 $s^2_{iA}$ 和 $s^2_{iB}$ 的位点 $i$：\n    $$\n    s_{p,i} = \n    \\begin{cases}\n    \\sqrt{\\dfrac{(n_{iA}-1)s^2_{iA} + (n_{iB}-1)s^2_{iB}}{n_{iA}+n_{iB}-2}}, & \\text{若 } n_{iA}+n_{iB}-2 > 0,\\\\\n    0, & \\text{其他情况。}\n    \\end{cases}\n    $$\n*   **位点级标准化分化 ($d_i$):**\n    $$\n    d_i = \n    \\begin{cases}\n    \\dfrac{\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|}{s_{p,i}}, & \\text{若 } s_{p,i} > 0,\\\\\n    \\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|, & \\text{若 } s_{p,i} = 0.\n    \\end{cases}\n    $$\n*   **检验统计量 ($T$):** 同域和异域位点之间平均标准化分化的差异：\n    $$\n    T_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}}\n    $$\n*   **置换检验程序:** 一种精确检验，基于枚举所有不同的位点重标记，同时保留同域和异域位点的数量。\n*   **单尾 P 值:** 置换中检验统计量大于或等于观察值的比例：\n    $$\n    p = \\frac{1}{N}\\sum_{b=1}^{N} \\mathbf{1}\\!\\left(T^{(b)} \\ge T_{\\text{obs}}\\right)\n    $$\n*   **数据:** 提供了三个不同的数据集用于测试。\n\n**验证结论:**\n该问题是**有效的**。它在科学上基于成熟的生态学理论，数学上表述清晰，并且解决问题所需的所有组成部分都已明确规定，没有歧义或矛盾。它提出了一个生物统计学中的标准任务，尽管在计算上具有特定性。该问题是自包含且客观的。因此，我们可以着手构建解决方案。\n\n**求解方法论**\n\n实现将遵循从问题陈述中推导出的精确、分步的程序。对于每个数据集，我们执行以下操作。\n\n**步骤 1：计算位点级分化 ($d_i$)**\n对于给定数据集中的每个位点 $i$，我们计算标准化分化指标 $d_i$。这需要对该位点上的每个物种对（A 和 B）进行一系列计算。\n1.  计算每个物种性状值的样本量（$n_{iA}$, $n_{iB}$）和样本均值（$\\bar{x}_{iA}$, $\\bar{x}_{iB}$）。\n2.  计算无偏样本方差（$s^2_{iA}$, $s^2_{iB}$）。如果一个物种的样本量 $n < 2$，其方差定义为 $0$。否则，使用分母为 $n-1$ 的标准公式。\n3.  计算位点内合并标准差 $s_{p,i}$。该指标通过物种内的共同变异来标准化均值差异。必须严格遵守所提供的公式，包括如果总自由度 $n_{iA}+n_{iB}-2 \\le 0$，则 $s_{p,i}$ 定义为 $0$ 的条件。\n4.  计算标准化分化 $d_i$。这是物种均值之间的绝对差，通过 $s_{p,i}$ 进行归一化。问题明确规定，如果 $s_{p,i} = 0$，则必须使用未经标准化的均值绝对差。这将创建一个固定的分化值向量 $\\{d_1, d_2, \\dots, d_{N_{\\text{total}}}\\}$，其中 $N_{\\text{total}}$ 是总位点数。\n\n**步骤 2：计算观察到的检验统计量 ($T_{\\text{obs}}$)**\n假设的核心在于比较同域和异域环境下的分化。\n1.  使用数据集中提供的原始标签，我们将计算出的 $d_i$ 值划分为两组：同域位点的 $\\{d_i\\}_{\\text{sym}}$ 和异域位点的 $\\{d_i\\}_{\\text{allo}}$。\n2.  我们计算每组的均值，$\\overline{d}_{\\text{sym}}$ 和 $\\overline{d}_{\\text{allo}}$。\n3.  观察到的检验统计量是这些均值之间的差：$T_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}}$。一个大的正值 $T_{\\text{obs}}$ 支持性状置换假说。\n\n**步骤 3：枚举零分布**\n零假设陈述位点标签是无意义的。为了生成在此零假设下的检验统计量分布，我们执行一个置换程序。\n1.  我们固定 $d_i$ 值向量以及同域（$N_{\\text{sym}}$）和异域（$N_{\\text{allo}}$）位点的数量。\n2.  我们枚举将 $N_{\\text{sym}}$ 个“同域”标签分配给 $N_{\\text{total}}$ 个位点的所有可能方式。这种不同置换的数量由二项式系数 $N = \\binom{N_{\\text{total}}}{N_{\\text{sym}}}$ 给出。\n3.  对于每个置换 $b$（从 $1$ 到 $N$），我们将固定的 $d_i$ 值形成一个新的划分为“同域”组和“异域”组。然后我们为这个重标记计算检验统计量 $T^{(b)}$。\n4.  所有 $N$ 个 $T^{(b)}$ 值的集合构成了检验统计量的精确零分布。\n\n**步骤 4：计算 P 值**\n最后一步是确定我们观察结果的统计显著性。\n1.  我们将观察到的统计量 $T_{\\text{obs}}$ 与零分布进行比较。\n2.  单尾 $p$ 值是置换统计量 $T^{(b)}$ 大于或等于 $T_{\\text{obs}}$ 的比例。这对应于在零假设为真的情况下，获得至少与观察结果一样极端的结果的概率。包含相等情况（$T^{(b)} = T_{\\text{obs}}$）确保了检验的保守性。\n$$\np = \\frac{\\text{其中 } T^{(b)} \\ge T_{\\text{obs}} \\text{ 的置换数}}{\\text{总置换数}}\n$$\n此程序独立应用于所提供的三个数据集中的每一个。最终输出是所得 $p$ 值的列表，按要求四舍五入。", "answer": "```python\nimport numpy as np\nfrom itertools import combinations\n\ndef solve():\n    \"\"\"\n    Main function to run the exact permutation test for character displacement\n    on the provided test suite.\n    \"\"\"\n    \n    # Define the test suite. Each item is a dataset structured as:\n    # ( [list of sympatric sites], [list of allopatric sites] )\n    # Each site is a tuple: ( [species A traits], [species B traits] )\n    test_cases = [\n        # Dataset 1\n        (\n            [\n                (np.array([9.8, 10.1, 10.2, 9.9]), np.array([6.1, 6.3, 5.9, 6.0])), # S1\n                (np.array([9.2, 9.0, 9.1, 9.3]), np.array([5.0, 5.3, 4.9, 5.1])), # S2\n                (np.array([8.4, 8.6, 8.7, 8.5]), np.array([4.6, 4.4, 4.5, 4.7])), # S3\n            ],\n            [\n                (np.array([7.0, 7.1, 7.2, 6.9]), np.array([6.7, 6.6, 6.5, 6.8])), # A1\n                (np.array([7.3, 7.2, 7.1, 7.4]), np.array([6.9, 7.0, 6.8, 6.7])), # A2\n                (np.array([6.8, 7.0, 6.9, 6.7]), np.array([6.5, 6.6, 6.4, 6.7])), # A3\n            ],\n        ),\n        # Dataset 2\n        (\n            [\n                (np.array([7.0, 7.1, 6.9, 7.0]), np.array([6.6, 6.7, 6.5, 6.6])), # S1\n                (np.array([8.0, 8.1, 7.9, 8.05]), np.array([7.6, 7.7, 7.5, 7.6])), # S2\n            ],\n            [\n                (np.array([9.0, 9.1, 8.9, 9.05]), np.array([8.6, 8.7, 8.5, 8.6])), # A1\n                (np.array([6.0, 6.1, 5.9, 6.05]), np.array([5.6, 5.7, 5.5, 5.6])), # A2\n            ]\n        ),\n        # Dataset 3\n        (\n            [\n                (np.array([5.0, 5.1]), np.array([5.0, 5.1])), # S1\n            ],\n            [\n                (np.array([5.0, 5.05]), np.array([5.5, 5.45])), # A1\n                (np.array([7.0]), np.array([7.0])), # A2\n            ]\n        )\n    ]\n\n    def calculate_site_divergence(traits_A, traits_B):\n        \"\"\"\n        Calculates the standardized divergence d_i for a single site.\n        \"\"\"\n        n_A = len(traits_A)\n        n_B = len(traits_B)\n\n        mean_A = np.mean(traits_A)\n        mean_B = np.mean(traits_B)\n\n        # Unbiased sample variance with edge case for n < 2\n        var_A = np.var(traits_A, ddof=1) if n_A >= 2 else 0\n        var_B = np.var(traits_B, ddof=1) if n_B >= 2 else 0\n\n        # Pooled standard deviation with edge case for degrees of freedom <= 0\n        df = n_A + n_B - 2\n        if df > 0:\n            pooled_var = ((n_A - 1) * var_A + (n_B - 1) * var_B) / df\n            s_p = np.sqrt(pooled_var)\n        else:\n            s_p = 0\n            \n        # Standardized divergence with edge case for s_p = 0\n        mean_diff = np.abs(mean_A - mean_B)\n        if s_p > 0:\n            d_i = mean_diff / s_p\n        else:\n            d_i = mean_diff\n            \n        return d_i\n\n    p_values = []\n    \n    for sympatric_sites, allopatric_sites in test_cases:\n        all_sites = sympatric_sites + allopatric_sites\n        n_sym = len(sympatric_sites)\n        n_allo = len(allopatric_sites)\n        n_total = n_sym + n_allo\n\n        # Step 1: Calculate d_i for all sites\n        d_values = np.array([calculate_site_divergence(site[0], site[1]) for site in all_sites])\n        \n        # Step 2: Calculate observed test statistic T_obs\n        d_sym_obs = d_values[:n_sym]\n        d_allo_obs = d_values[n_sym:]\n        \n        mean_d_sym_obs = np.mean(d_sym_obs) if n_sym > 0 else 0\n        mean_d_allo_obs = np.mean(d_allo_obs) if n_allo > 0 else 0\n        \n        t_obs = mean_d_sym_obs - mean_d_allo_obs\n\n        # Step 3: Enumerate permutations and build null distribution\n        ge_obs_count = 0\n        total_perms = 0\n        \n        # `itertools.combinations` provides the indices for the 'sympatric' group in each permutation\n        site_indices = range(n_total)\n        for permuted_sym_indices in combinations(site_indices, n_sym):\n            total_perms += 1\n\n            permuted_sym_indices = set(permuted_sym_indices)\n            permuted_allo_indices = set(site_indices) - permuted_sym_indices\n            \n            d_sym_perm = d_values[list(permuted_sym_indices)] if n_sym > 0 else np.array([])\n            d_allo_perm = d_values[list(permuted_allo_indices)] if n_allo > 0 else np.array([])\n\n            mean_d_sym_perm = np.mean(d_sym_perm) if n_sym > 0 else 0\n            mean_d_allo_perm = np.mean(d_allo_perm) if n_allo > 0 else 0\n\n            t_perm = mean_d_sym_perm - mean_d_allo_perm\n            \n            # Use a small tolerance for float comparison, though >= is robust for most cases.\n            if t_perm >= t_obs:\n                ge_obs_count += 1\n        \n        # Step 4: Calculate p-value\n        p_value = ge_obs_count / total_perms if total_perms > 0 else 1.0 # Handle case with 0 permutations\n        \n        p_values.append(p_value)\n\n    # Format the results as specified\n    formatted_results = [f\"{p:.6f}\" for p in p_values]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2475692"}]}