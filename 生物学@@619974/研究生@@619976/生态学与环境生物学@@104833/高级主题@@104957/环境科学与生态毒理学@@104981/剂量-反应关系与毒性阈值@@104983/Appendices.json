{"hands_on_practices": [{"introduction": "好的科学研究始于好的实验设计。在着手收集数据之前，我们必须确保实验有足够的统计功效来回答我们的研究问题，例如，我们能否可靠地检测到两个处理组之间 $EC_{50}$ 值的两倍差异？本练习将指导您完成功效分析（power analysis）的整个过程，通过推导 Fisher 信息并构建 Wald 检验，来计算检测特定效应大小的概率。这对于有效分配实验资源和避免“阴性”结果的模糊性至关重要。[@problem_id:2481284]", "problem": "你的任务是构建一个程序，在一组特定的假设下，对一个归一化的剂量-反应实验执行基于设计的功效分析，以检测两种处理之间在半数有效浓度 (EC50) 上的两倍差异。你的方法必须从统计建模和信息论的基本原理出发，并最终形成一个适合计算的、详尽指定的算法。\n\n假设与模型结构：\n- 在处理 $t \\in \\{\\mathrm{A},\\mathrm{B}\\}$ 中，剂量为 $x$ 时的生物学反应被建模为\n$$\nY \\mid x,t \\sim \\mathcal{N}\\!\\big(\\mu(x;\\theta_t),\\,\\sigma^2\\big),\n$$\n其残差独立同分布，具有恒定方差 $\\sigma^2$，且在不同处理和剂量之间相互独立。反应被归一化到 $0$ 到 $1$ 的范围内，因此不需要额外的尺度参数。\n- 均值函数是一个具有固定顶部和底部渐近线的 Hill 型剂量-反应函数：\n$$\n\\mu(x;\\theta) \\;=\\; \\frac{1}{1 + \\left(\\frac{x}{\\mathrm{EC}_{50}}\\right)^h} \\;=\\; \\frac{1}{1 + \\exp\\!\\big(h(\\ln x - \\theta)\\big)},\n$$\n其中 $\\theta = \\ln(\\mathrm{EC}_{50})$，$h$ 是一个已知的 Hill 斜率，两种处理共用此值。顶部渐近线固定为 $1$，底部为 $0$。\n- 处理 $\\mathrm{A}$ 的参数为 $\\theta_{\\mathrm{A}} = \\ln(\\mathrm{EC}_{50,\\mathrm{A}})$，处理 $\\mathrm{B}$ 的参数为 $\\theta_{\\mathrm{B}} = \\theta_{\\mathrm{A}} + \\ln f$，其中 $f$ 是 EC50 的倍数变化。原假设为 $H_0: \\theta_{\\mathrm{B}} - \\theta_{\\mathrm{A}} = 0$，备择假设为 $H_1: \\theta_{\\mathrm{B}} - \\theta_{\\mathrm{A}} = \\ln f$。你必须在显著性水平为 $\\alpha$ 的双边 Wald 检验下，计算在 $H_1$ 成立时的功效。\n- 实验设计由一组剂量 $\\{x_i\\}_{i=1}^m$ 指定，在每种处理中，每个剂量有 $r_i$ 个独立重复。假设两种处理使用相同的分配方案 $\\{(x_i, r_i)\\}$。\n\n推导的基本原理：\n- 对于已知方差的高斯模型下的非线性均值函数，单个观测值对标量参数 $\\theta$ 的 Fisher 信息为\n$$\n\\mathcal{I}(\\theta) \\;=\\; \\frac{1}{\\sigma^2} \\left(\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta}\\right)^2.\n$$\n- 对于独立观测，Fisher 信息在观测值之间和剂量组之间（通过重复计数）是可加的。在大样本情况下，最大似然估计量的方差约等于 Fisher 信息的逆。\n- 用于检验 $H_0: \\delta = 0$ 的 Wald 统计量（其估计量为 $\\widehat{\\delta}$）满足\n$$\nZ \\;=\\; \\frac{\\widehat{\\delta}}{\\mathrm{SE}(\\widehat{\\delta})} \\;\\approx\\; \\mathcal{N}\\!\\big(\\delta/\\mathrm{SE}(\\widehat{\\delta}),\\,1\\big),\n$$\n因此，在真实 $\\delta \\neq 0$ 的情况下，显著性水平为 $\\alpha$ 的双边检验的功效为\n$$\n\\text{Power} \\;=\\; \\Pr\\big(|Z| > z_{1-\\alpha/2}\\big) \\;=\\; 1 - \\Phi\\!\\big(z_{1-\\alpha/2} - \\lambda\\big) + \\Phi\\!\\big(-z_{1-\\alpha/2} - \\lambda\\big),\n$$\n其中 $\\lambda = |\\delta|/\\mathrm{SE}(\\widehat{\\delta})$ 是非中心化参数，$\\Phi$ 是标准正态累积分布函数。\n\n需要的推导和实现的算法步骤：\n1. 使用指定的均值函数，推导出 $\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta}$，并用 $\\{x_i,r_i\\}$、$h$ 和 $\\sigma^2$ 表示给定处理中 $\\theta$ 的总 Fisher 信息。\n2. 将每个处理 $t \\in \\{\\mathrm{A},\\mathrm{B}\\}$ 的 $\\widehat{\\theta}_t$ 的渐近方差表示为在 $H_1$ 下，于真实 $\\theta_t$ 处求值的 Fisher 信息的逆。\n3. 由于在给定假设下，两种处理是独立测量的，差值估计量 $\\widehat{\\delta} = \\widehat{\\theta}_{\\mathrm{B}} - \\widehat{\\theta}_{\\mathrm{A}}$ 的方差是两个方差之和。因此，\n$$\n\\mathrm{SE}(\\widehat{\\delta}) \\;=\\; \\sqrt{\\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{A}}) + \\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{B}})}.\n$$\n4. 计算非中心化参数 $\\lambda = |\\ln f| / \\mathrm{SE}(\\widehat{\\delta})$、临界值 $z_{1-\\alpha/2}$，并最终使用上述双边正态公式计算功效。\n\n角度单位不适用。如果任何数量需要以百分比表示，你必须将其表示为小数。你的程序必须将每个功效值作为 $[0,1]$ 范围内的小数输出，四舍五入到四位小数。\n\n测试套件：\n对于以下每种情况，计算用于检测两倍偏移的双边检验功效，即使用 $f=2$。\n\n- 情况1（均衡，信息量大，中等方差）：\n  - 剂量（单位 $\\mu\\mathrm{M}$）：$\\{1,\\,3,\\,10,\\,30,\\,100\\}$\n  - 每处理每剂量的重复次数：$\\{6,\\,6,\\,6,\\,6,\\,6\\}$\n  - 残差标准差：$\\sigma = 0.1$\n  - Hill 斜率：$h = 1.2$\n  - 基线 $\\mathrm{EC}_{50,\\mathrm{A}} = 10\\,\\mu\\mathrm{M}$，所以 $\\theta_{\\mathrm{A}} = \\ln(10)$\n  - 显著性水平：$\\alpha = 0.05$\n\n- 情况2（剂量远低于基线 $\\mathrm{EC}_{50}$，信息量较低）：\n  - 剂量（单位 $\\mu\\mathrm{M}$）：$\\{0.01,\\,0.03,\\,0.1,\\,0.3,\\,1\\}$\n  - 每处理每剂量的重复次数：$\\{4,\\,4,\\,4,\\,4,\\,4\\}$\n  - 残差标准差：$\\sigma = 0.15$\n  - Hill 斜率：$h = 1.2$\n  - 基线 $\\mathrm{EC}_{50,\\mathrm{A}} = 10\\,\\mu\\mathrm{M}$，所以 $\\theta_{\\mathrm{A}} = \\ln(10)$\n  - 显著性水平：$\\alpha = 0.05$\n\n- 情况3（在 $\\mathrm{EC}_{50}$ 附近信息量高，方差小）：\n  - 剂量（单位 $\\mu\\mathrm{M}$）：$\\{6,\\,8,\\,10,\\,12,\\,15\\}$\n  - 每处理每剂量的重复次数：$\\{20,\\,20,\\,20,\\,20,\\,20\\}$\n  - 残差标准差：$\\sigma = 0.05$\n  - Hill 斜率：$h = 2.0$\n  - 基线 $\\mathrm{EC}_{50,\\mathrm{A}} = 10\\,\\mu\\mathrm{M}$，所以 $\\theta_{\\mathrm{A}} = \\ln(10)$\n  - 显著性水平：$\\alpha = 0.05$\n\n- 情况4（稀疏设计，最少重复次数）：\n  - 剂量（单位 $\\mu\\mathrm{M}$）：$\\{5,\\,10,\\,20\\}$\n  - 每处理每剂量的重复次数：$\\{1,\\,1,\\,1\\}$\n  - 残差标准差：$\\sigma = 0.1$\n  - Hill 斜率：$h = 1.0$\n  - 基线 $\\mathrm{EC}_{50,\\mathrm{A}} = 10\\,\\mu\\mathrm{M}$，所以 $\\theta_{\\mathrm{A}} = \\ln(10)$\n  - 显著性水平：$\\alpha = 0.05$\n\n最终输出格式：\n- 你的程序必须生成单行输出，其中包含与上述四种情况相对应的四个功效值，按顺序排列，形式为用方括号括起来的逗号分隔列表，例如 $[\\;0.8021,\\,0.0543,\\,0.9999,\\,0.4120\\;]$。每个值必须四舍五入到四位小数，并表示为小数（无百分号）。", "solution": "该问题已经过验证，并被确定为有效。它在科学上基于非线性回归和功效分析的既定统计理论。模型、假设和所需的推导都定义清晰、客观且自成体系。该问题是适定的，并且为指定的测试用例提供了所有必要的参数。不存在不一致、模糊或事实不健全之处。因此，我们可以着手解决。\n\n任务是计算在剂量-反应实验中，检测 A 和 B 两种处理间 $\\mathrm{EC}_{50}$ 参数存在两倍差异的统计功效。推导和计算将遵循基于最大似然估计量的大样本性质和 Fisher 信息矩阵的结构化方法。\n\n对于给定的剂量 $x$ 和处理 $t$，生物学反应 $Y$ 由正态分布 $Y \\mid x,t \\sim \\mathcal{N}(\\mu(x;\\theta_t), \\sigma^2)$ 建模，其中均值反应函数 $\\mu(x;\\theta)$ 遵循一个四参数逻辑模型（Hill 方程），其顶部和底部渐近线分别固定为 1 和 0。均值函数由下式给出：\n$$\n\\mu(x;\\theta) = \\frac{1}{1 + \\exp(h(\\ln x - \\theta))}\n$$\n此处，$\\theta = \\ln(\\mathrm{EC}_{50})$ 是我们感兴趣的参数，表示产生 $50\\%$ 反应的有效浓度的自然对数，$h$ 是 Hill 斜率，假设为已知并在各处理间保持不变。\n\n分析按规定的四个步骤进行。\n\n**第1步：偏导数和 Fisher 信息的推导**\n\n首先，我们推导均值函数 $\\mu(x;\\theta)$ 关于参数 $\\theta$ 的偏导数。这个导数对于计算 Fisher 信息至关重要。使用链式法则，设 $u(x;\\theta) = h(\\ln x - \\theta)$。则 $\\mu = (1 + e^u)^{-1}$。\n$$\n\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta} = -\\frac{1}{(1 + e^u)^2} \\cdot \\frac{\\partial}{\\partial \\theta}(e^u) = -\\frac{e^u}{(1 + e^u)^2} \\cdot \\frac{\\partial u}{\\partial \\theta}\n$$\n$u$ 关于 $\\theta$ 的导数是：\n$$\n\\frac{\\partial u}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(h(\\ln x - \\theta)) = -h\n$$\n将此代回，我们得到：\n$$\n\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta} = -\\frac{\\exp(h(\\ln x - \\theta))}{(1 + \\exp(h(\\ln x - \\theta)))^2} \\cdot (-h) = \\frac{h \\exp(h(\\ln x - \\theta))}{(1 + \\exp(h(\\ln x - \\theta)))^2}\n$$\n通过观察 $\\mu(x;\\theta) = \\frac{1}{1 + e^u}$ 和 $1 - \\mu(x;\\theta) = \\frac{e^u}{1 + e^u}$，这个表达式可以被优雅地简化。因此，导数为：\n$$\n\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta} = h \\cdot \\left(\\frac{1}{1+e^u}\\right) \\cdot \\left(\\frac{e^u}{1+e^u}\\right) = h \\cdot \\mu(x;\\theta) \\cdot (1 - \\mu(x;\\theta))\n$$\n在给定剂量 $x$ 下，单个观测值对 $\\theta$ 的 Fisher 信息定义为 $\\mathcal{I}(\\theta; x) = \\frac{1}{\\sigma^2} \\left(\\frac{\\partial \\mu(x;\\theta)}{\\partial \\theta}\\right)^2$。代入我们的导数，我们得到：\n$$\n\\mathcal{I}(\\theta; x) = \\frac{1}{\\sigma^2} \\left[ h \\cdot \\mu(x;\\theta)(1 - \\mu(x;\\theta)) \\right]^2 = \\frac{h^2}{\\sigma^2} [\\mu(x;\\theta)(1 - \\mu(x;\\theta))]^2\n$$\n对于一个由 $m$ 个剂量 $\\{x_i\\}_{i=1}^m$ 组成的实验设计，每个剂量有 $r_i$ 次重复，单个处理的总 Fisher 信息是所有独立观测值的总和：\n$$\n\\mathcal{I}_{\\text{total}}(\\theta) = \\sum_{i=1}^{m} r_i \\cdot \\mathcal{I}(\\theta; x_i) = \\frac{h^2}{\\sigma^2} \\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta)(1 - \\mu(x_i;\\theta))]^2\n$$\n\n**第2步：参数估计量的渐近方差**\n\n根据大样本理论，最大似然估计量 $\\widehat{\\theta}$ 的方差近似于总 Fisher 信息的逆，$\\mathrm{Var}(\\widehat{\\theta}) \\approx [\\mathcal{I}_{\\text{total}}(\\theta)]^{-1}$。我们为每个处理计算这个方差，该方差在备择假设 $H_1$ 下的真实参数值处求值。\n\n在 $H_1$ 下，真实参数为处理 A 的 $\\theta_{\\mathrm{A}} = \\ln(\\mathrm{EC}_{50,\\mathrm{A}})$ 和处理 B 的 $\\theta_{\\mathrm{B}} = \\theta_{\\mathrm{A}} + \\ln f$，其中 $f$ 是倍数变化，给定为 $f=2$。\n\n$\\theta_{\\mathrm{A}}$ 估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{A}}) \\approx \\left( \\frac{h^2}{\\sigma^2} \\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{A}})(1 - \\mu(x_i;\\theta_{\\mathrm{A}}))]^2 \\right)^{-1}\n$$\n类似地，$\\theta_{\\mathrm{B}}$ 估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{B}}) \\approx \\left( \\frac{h^2}{\\sigma^2} \\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{B}})(1 - \\mu(x_i;\\theta_{\\mathrm{B}}))]^2 \\right)^{-1}\n$$\n\n**第3步：差值的标准误**\n\n我们正在检验差值 $\\delta = \\theta_{\\mathrm{B}} - \\theta_{\\mathrm{A}}$。这个差值的估计量是 $\\widehat{\\delta} = \\widehat{\\theta}_{\\mathrm{B}} - \\widehat{\\theta}_{\\mathrm{A}}$。由于处理 A 和 B 的实验是独立的，$\\widehat{\\delta}$ 的方差是各自方差的和：\n$$\n\\mathrm{Var}(\\widehat{\\delta}) = \\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{A}}) + \\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{B}})\n$$\n差值的标准误 $\\mathrm{SE}(\\widehat{\\delta})$ 是此方差的平方根：\n$$\n\\mathrm{SE}(\\widehat{\\delta}) = \\sqrt{\\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{A}}) + \\mathrm{Var}(\\widehat{\\theta}_{\\mathrm{B}})}\n$$\n代入方差的表达式，我们有：\n$$\n\\mathrm{SE}(\\widehat{\\delta}) = \\sqrt{ \\frac{\\sigma^2}{h^2} \\left(\\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{A}})(1-\\mu(x_i;\\theta_{\\mathrm{A}}))]^2\\right)^{-1} + \\frac{\\sigma^2}{h^2} \\left(\\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{B}})(1-\\mu(x_i;\\theta_{\\mathrm{B}}))]^2\\right)^{-1} }\n$$\n这可以简化为：\n$$\n\\mathrm{SE}(\\widehat{\\delta}) = \\frac{\\sigma}{h} \\sqrt{ \\left(\\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{A}})(1-\\mu(x_i;\\theta_{\\mathrm{A}}))]^2\\right)^{-1} + \\left(\\sum_{i=1}^{m} r_i [\\mu(x_i;\\theta_{\\mathrm{B}})(1-\\mu(x_i;\\theta_{\\mathrm{B}}))]^2\\right)^{-1} }\n$$\n\n**第4步：功效计算**\n\n最后一步是计算双边 Wald 检验的功效。在 $H_1$ 下，检验统计量近似服从正态分布：$Z = \\frac{\\widehat{\\delta}}{\\mathrm{SE}(\\widehat{\\delta})} \\approx \\mathcal{N}(\\lambda, 1)$，其中 $\\lambda = \\frac{\\delta}{\\mathrm{SE}(\\widehat{\\delta})}$ 是非中心化参数。在 $H_1$ 下的真实差值为 $\\delta = \\ln f$。\n$$\n\\lambda = \\frac{|\\ln f|}{\\mathrm{SE}(\\widehat{\\delta})}\n$$\n在显著性水平 $\\alpha$ 下，双边检验的功效是在备择假设 $H_1$ 为真时，拒绝原假设 $H_0: \\delta=0$ 的概率。这个概率是：\n$$\n\\text{Power} = \\Pr\\big(|Z| > z_{1-\\alpha/2} \\mid H_1\\big)\n$$\n其中 $z_{1-\\alpha/2}$ 是标准正态分布的 $(1-\\alpha/2)$-分位数。这可以使用标准正态累积分布函数 $\\Phi$ 来计算：\n$$\n\\text{Power} = 1 - (\\Phi(z_{1-\\alpha/2} - \\lambda) - \\Phi(-z_{1-\\alpha/2} - \\lambda))\n$$\n这是功效的最终公式。实现将遵循这些推导出的步骤。对于每个测试用例，我们将代入给定的 $\\{x_i, r_i\\}$、$\\sigma$、$h$、$\\mathrm{EC}_{50,\\mathrm{A}}$、$f=2$ 和 $\\alpha=0.05$ 的值来计算功效。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves for the statistical power in four dose-response experiment scenarios.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: balanced, informative, moderate variance\n        {\n            \"doses\": np.array([1.0, 3.0, 10.0, 30.0, 100.0]),\n            \"replicates\": np.array([6, 6, 6, 6, 6]),\n            \"sigma\": 0.1,\n            \"h\": 1.2,\n            \"ec50_a\": 10.0,\n            \"f\": 2.0,\n            \"alpha\": 0.05\n        },\n        # Case 2: doses far below baseline EC50, lower information\n        {\n            \"doses\": np.array([0.01, 0.03, 0.1, 0.3, 1.0]),\n            \"replicates\": np.array([4, 4, 4, 4, 4]),\n            \"sigma\": 0.15,\n            \"h\": 1.2,\n            \"ec50_a\": 10.0,\n            \"f\": 2.0,\n            \"alpha\": 0.05\n        },\n        # Case 3: highly informative near EC50, small variance\n        {\n            \"doses\": np.array([6.0, 8.0, 10.0, 12.0, 15.0]),\n            \"replicates\": np.array([20, 20, 20, 20, 20]),\n            \"sigma\": 0.05,\n            \"h\": 2.0,\n            \"ec50_a\": 10.0,\n            \"f\": 2.0,\n            \"alpha\": 0.05\n        },\n        # Case 4: sparse design, minimal replication\n        {\n            \"doses\": np.array([5.0, 10.0, 20.0]),\n            \"replicates\": np.array([1, 1, 1]),\n            \"sigma\": 0.1,\n            \"h\": 1.0,\n            \"ec50_a\": 10.0,\n            \"f\": 2.0,\n            \"alpha\": 0.05\n        }\n    ]\n\n    def calculate_power(doses, replicates, sigma, h, ec50_a, f, alpha):\n        \"\"\"\n        Calculates statistical power based on Fisher information for a given design.\n        \"\"\"\n        # Step 1: Define parameters and mean function\n        theta_a = np.log(ec50_a)\n        theta_b = theta_a + np.log(f)\n\n        def mean_response(x, theta):\n            # Hill-type dose-response function\n            return 1.0 / (1.0 + np.exp(h * (np.log(x) - theta)))\n\n        # Step 2: Calculate total Fisher Information components\n        def get_fisher_info_summand(theta):\n            # Calculates the sum part of the Fisher Information formula\n            # Sum over i of r_i * [mu_i * (1-mu_i)]^2\n            sum_val = 0.0\n            for i in range(len(doses)):\n                mu = mean_response(doses[i], theta)\n                # The weight for each observation is [mu * (1-mu)]^2\n                weight = (mu * (1.0 - mu))**2\n                sum_val += replicates[i] * weight\n            return sum_val\n\n        sum_fisher_a = get_fisher_info_summand(theta_a)\n        sum_fisher_b = get_fisher_info_summand(theta_b)\n        \n        # Step 3: Calculate variances and standard error of the difference\n        # Var(theta_hat) = 1 / I_total(theta) = (sigma^2/h^2) / Sum(...)\n        if sum_fisher_a = 0 or sum_fisher_b = 0:\n            # Avoid division by zero for non-informative designs\n            return 0.0\n            \n        var_theta_a = (sigma**2 / h**2) / sum_fisher_a\n        var_theta_b = (sigma**2 / h**2) / sum_fisher_b\n        \n        se_delta = np.sqrt(var_theta_a + var_theta_b)\n\n        # Step 4: Calculate noncentrality parameter and power\n        delta = np.log(f)\n        if se_delta = 0:\n             return 1.0 if delta != 0 else alpha\n        \n        noncentrality_param = np.abs(delta) / se_delta\n        \n        z_crit = norm.ppf(1.0 - alpha / 2.0)\n        \n        power = 1.0 - (norm.cdf(z_crit - noncentrality_param) - norm.cdf(-z_crit - noncentrality_param))\n        \n        return power\n\n    results = []\n    for case in test_cases:\n        power = calculate_power(\n            doses=case[\"doses\"],\n            replicates=case[\"replicates\"],\n            sigma=case[\"sigma\"],\n            h=case[\"h\"],\n            ec50_a=case[\"ec50_a\"],\n            f=case[\"f\"],\n            alpha=case[\"alpha\"]\n        )\n        # Round to four decimal places\n        results.append(round(power, 4))\n    \n    # Format results as a string with no spaces as per template\n    # Example format required: \"[0.8021,0.0543,0.9999,0.4120]\"\n    formatted_results = [f\"{res:.4f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2481284"}, {"introduction": "真实世界的数据很少像教科书中的例子那样完美。在使用诸如逻辑斯蒂回归 $logit(p_i) = \\alpha + \\beta x_i$ 的广义线性模型分析二元毒性数据时，一个常见的陷阱是“完全分离”（complete separation）。当低剂量完全无效而高剂量完全有效时，最大似然估计会失效，导致参数估计发散。本练习挑战您在面对这种看似棘手的数据时，辨别出最符合统计学原则的解决方案，从临时的数据修正转向更稳健的正则化估计方法。[@problem_id:2481181]", "problem": "一个生态毒理学团队对一种淡水端足类动物进行了一项静态更新毒性测试，以量化其在 $48$ 小时后失活动能力的半数最大效应浓度（EC50）。在每个浓度 $d_i$ (单位为 mg L$^{-1}$) 下，有 $n_i$ 个个体被暴露，并记录到 $y_i$ 个体失活动能力。实验设计对所有 $i$ 使用 $n_i = 20$，剂量 $d \\in \\{0.1, 0.3, 1, 3, 10\\}$ mg L$^{-1}$。观测结果如下：\n- 在 $d=0.1$ mg L$^{-1}$ 时，$y/n = 0/20$，\n- 在 $d=0.3$ mg L$^{-1}$ 时，$y/n = 0/20$，\n- 在 $d=1$ mg L$^{-1}$ 时，$y/n = 0/20$，\n- 在 $d=3$ mg L$^{-1}$ 时，$y/n = 20/20$，\n- 在 $d=10$ mg L$^{-1}$ 时，$y/n = 20/20$。\n\n假设使用广义线性模型（GLM）来拟合失活动能力概率作为对数剂量 $x_i = \\log d_i$ 的函数，该模型具有二项似然和 logit 链接函数：\n$$\nY_i \\sim \\text{Binomial}(n_i, p_i), \\quad \\text{logit}(p_i) = \\log\\left( \\frac{p_i}{1-p_i} \\right) = \\alpha + \\beta x_i,\n$$\n其中 $\\text{logit}(p) = \\log\\left( \\frac{p}{1-p} \\right)$ 是常规定义。将半数最大效应浓度 $\\mathrm{EC}_{50}$ 定义为模型下预期失活动能力概率等于 $0.5$ 时的剂量 $d_{50}$；在该参数化下，这意味着 $x_{50} = \\log d_{50}$ 满足 $\\alpha + \\beta x_{50} = 0$。\n\n仅从上述定义和二项GLM公式出发，推断在观测到的完全分离模式（低剂量下全部无反应，高剂量下全部有反应）下最大似然估计量的存在性和行为。然后，确定以下哪种方法同时满足 (i) 在此情况下能够得出 $\\mathrm{EC}_{50}$ 的有限且可解释的估计值，以及 (ii) 在不借助临时数据修改的情况下，支持基于似然或后验理论的有效不确定性量化。\n\n选择唯一的最佳选项。\n\nA. 通过标准最大似然法对 $x_i = \\log d_i$ 拟合所述的逻辑斯谛回归，如果出现无穷大斜率则接受该结果，并将 $\\mathrm{EC}_{50}$ 定义为 $y_i = 0$ 的最大剂量与 $y_i = n_i$ 的最小剂量之间的算术中点。\n\nB. 添加一个小的连续性校正（例如，为每个 $y_i$ 和 $n_i - y_i$ 添加 $0.5$ 个伪事件和 $0.5$ 个伪非事件），然后通过最大似然法拟合标准逻辑斯谛回归，并通过 $d_{50} = \\exp(-\\alpha/\\beta)$ 计算 $\\mathrm{EC}_{50}$，其 Wald 区间从校正后的拟合中获得。\n\nC. 在逻辑斯谛GLM中使用惩罚似然来减少偏差，具体而言，最大化惩罚对数似然 $\\ell^{\\ast}(\\alpha,\\beta) = \\ell(\\alpha,\\beta) + \\frac{1}{2}\\log |I(\\alpha,\\beta)|$，其中 $\\ell$ 是二项对数似然， $I$ 是观测到的Fisher信息，这等效于使用 Jeffreys 先验。然后计算 $d_{50} = \\exp(-\\hat{\\alpha}/\\hat{\\beta})$，并通过对变换后参数的惩罚轮廓似然或通过使用 $(\\alpha,\\beta)$ 的弱信息先验的贝叶斯方法，来获得 $d_{50}$ 的置信区间。\n\nD. 将链接函数从 logit 切换到 probit，并用标准最大似然法重新拟合；因为 probit 函数不那么陡峭，所以不会发生分离，并且根据所述设计，由此产生的 $\\mathrm{EC}_{50}$ 及其置信区间是良定且无偏的。", "solution": "在尝试任何解答之前，必须首先严格验证问题陈述的科学性和逻辑合理性。\n\n第一步：提取已知条件。\n- 实验是对一种淡水端足类动物进行的静态更新毒性测试。\n- 终点是 $48$ 小时后的失活动能力。\n- 目标量是半数最大效应浓度 $\\mathrm{EC}_{50}$。\n- 实验设计对所有剂量组 $i$ 使用 $n_i = 20$ 个个体。\n- 剂量为 $d \\in \\{0.1, 0.3, 1, 3, 10\\}$，单位是 mg L$^{-1}$。\n- 观测结果 $(y_i/n_i)$ 如下：\n  - 在 $d=0.1$ mg L$^{-1}$ 时为 $0/20$\n  - 在 $d=0.3$ mg L$^{-1}$ 时为 $0/20$\n  - 在 $d=1$ mg L$^{-1}$ 时为 $0/20$\n  - 在 $d=3$ mg L$^{-1}$ 时为 $20/20$\n  - 在 $d=10$ mg L$^{-1}$ 时为 $20/20$\n- 提出的模型是一个广义线性模型 (GLM)，其中在剂量 $d_i$ 下的失活动个体数 $Y_i$ 服从二项分布：\n$$\nY_i \\sim \\text{Binomial}(n_i, p_i)\n$$\n- 失活动能力概率 $p_i$ 通过 logit 链接函数与对数转换后的剂量 $x_i = \\log d_i$ 相关：\n$$\n\\text{logit}(p_i) = \\log\\left( \\frac{p_i}{1-p_i} \\right) = \\alpha + \\beta x_i\n$$\n- $\\mathrm{EC}_{50}$ 定义为失活动能力概率 $p=0.5$ 时的剂量 $d_{50}$。这意味着线性预测变量为零：$\\alpha + \\beta x_{50} = 0$，其中 $x_{50} = \\log d_{50}$。\n\n第二步：使用提取的条件进行验证。\n- **科学依据**：该问题在生态毒理学和生物统计学方面有充分的依据。使用二项GLM（逻辑斯谛回归）进行剂量-反应建模是一项标准和基础的技术。数据中描述的现象——完全分离——是此类模型中一个已知的统计问题。$\\mathrm{EC}_{50}$ 的定义是正确的。该问题在科学上是合理的。\n- **适定性**：该问题要求确定一种合适的统计方法，以处理导致标准方法失效的特定、真实世界数据模式。问题的结构旨在评估不同的既定方法或启发式方法。这是一个适定问题。\n- **客观性**：问题陈述使用了统计学和毒理学中精确、客观和标准的术语。没有主观性语言。\n- **完整性与一致性**：所提供的数据、模型和参数定义均是完整的，并且内部一致。剂量的对数转换是标准做法。数据模式呈现了一个清晰的完全分离案例：在 $x_i = \\log d_i$ 的尺度上，所有无反应（$y_i=0$）都发生在 $x = \\log(1) = 0$ 或以下，而所有反应（$y_i=n_i$）都发生在 $x = \\log(3) \\approx 1.0986$ 或以上。由于零反应组的预测变量值集合与完全反应组的预测变量值集合不相交，并且完全低于后者，这是一个完全分离的典型案例。\n- **结论**：问题陈述是有效的。它描述了一个不简单但标准的统计问题，并要求采用适当的——即理论上合理的——方法来解决它。\n\n接下来进行解题推导。\n\n问题的核心在于**完全分离**现象。对于逻辑斯谛回归模型，对数似然函数由下式给出：\n$$\n\\ell(\\alpha, \\beta) = \\sum_{i=1}^{k} \\left[ y_i \\log(p_i) + (n_i - y_i) \\log(1 - p_i) \\right]\n$$\n其中 $p_i = \\frac{\\exp(\\alpha + \\beta x_i)}{1 + \\exp(\\alpha + \\beta x_i)}$。\n\n在我们的案例中，数据显示对于所有低于某一阈值（例如，$\\log(1)$ 和 $\\log(3)$ 之间的任意值）的 $x_i$，我们观察到 $y_i=0$；而对于所有高于此阈值的 $x_i$，我们观察到 $y_i=n_i=20$。一个完美的拟合将使得前三个剂量组的 $p_i \\to 0$，而后两个剂量组的 $p_i \\to 1$。\n为了实现 $p_i \\to 0$，我们需要线性预测变量 $\\alpha + \\beta x_i \\to -\\infty$。\n为了实现 $p_i \\to 1$，我们需要线性预测变量 $\\alpha + \\beta x_i \\to +\\infty$。\n这可以通过让斜率参数 $\\beta \\to \\infty$ 来实现。如果我们将转换点 $x_{50} = -\\alpha/\\beta$ 固定在分离区间 $(\\log(1), \\log(3))$ 内的任何值，那么我们可以写出 $\\alpha = -\\beta x_{50}$。线性预测变量变为 $\\beta (x_i - x_{50})$。当 $\\beta \\to \\infty$ 时，对于 $x_i  x_{50}$，该项趋近于 $-\\infty$；对于 $x_i  x_{50}$，该项趋近于 $+\\infty$。这种配置对于区间内 $x_{50}$ 的任何选择都能使似然函数最大化。\n因此，最大似然估计（MLE）在参数空间 $(\\alpha, \\beta)$ 中不存在有限解。参数是发散的，虽然它们的比率 $-\\alpha/\\beta$ 被限制在区间 $(\\log(1), \\log(3))$ 内，但它并不是唯一确定的。标准的最高似然估计程序无法为模型参数生成唯一、有限的估计，因此也无法为 $\\mathrm{EC}_{50}$ 生成唯一、有限的估计。\n\n因此，我们必须评估所提出的选项，看它们是否能以一种符合统计学原理的方式解决这个问题。\n\n**选项A分析**：\n该选项首先建议通过标准最大似然法拟合模型，如前所述，这会导致斜率 $\\beta$ 为无穷大。然后，它建议将 $\\mathrm{EC}_{50}$ 定义为界定分离区间的剂量（即 $d=1$ mg L$^{-1}$ 和 $d=3$ mg L$^{-1}$）的算术中点。这将得到一个估计值 $\\mathrm{EC}_{50} = (1+3)/2 = 2$ mg L$^{-1}$。\n这个程序有根本性的缺陷。第一部分（拟合模型）会失败。第二部分则是一个纯粹的*临时*规则，与统计模型脱节。它忽略了对数尺度上的剂量间距，而对数尺度才是该模型的相关尺度。更关键的是，它没有为问题提示所要求的“基于似然理论的有效不确定性量化”提供任何基础。这是一种启发式猜测，而非统计推断。\n结论：**错误**。\n\n**选项B分析**：\n该选项建议添加“连续性校正”，这涉及到通过添加伪计数来修改数据。例如，向每个观测计数 $y_i$ 和每个无反应计数 $n_i - y_i$ 中都加上 $0.5$。这将数据从 $\\{0, 20\\}$ 转换为 $\\{0.5, 20.5\\}$（总数 $n_i$ 变为 $21$）。这种修改打破了完全分离，使得标准的MLE算法能够收敛到有限的估计值 $\\hat{\\alpha}$ 和 $\\hat{\\beta}$。基于这些估计，可以计算出 $\\mathrm{EC}_{50}$ 及其置信区间。\n然而，问题明确要求一种“不借助临时数据修改”的方法。添加伪计数正是这样一种修改。选择 $0.5$ 是任意的；选择其他值会导致不同的结果。虽然在实践中有时被用作快速修复方法，但它并非一个源于原始数据和模型的、有原则的解决方案。\n结论：**错误**。\n\n**选项C分析**：\n该选项提议使用一种惩罚似然方法。具体来说，它提到最大化 $\\ell^{\\ast}(\\alpha,\\beta) = \\ell(\\alpha,\\beta) + \\frac{1}{2}\\log |I(\\alpha,\\beta)|$，其中 $I$ 是Fisher信息矩阵。这是著名的 Firth 逻辑斯谛回归，它是在贝叶斯上下文中使用 Jeffreys 先验的结果。\n该方法是解决分离问题的一个有原则的统计解决方案。惩罚项 $\\frac{1}{2}\\log |I(\\alpha,\\beta)|$ 对似然函数进行正则化，防止参数发散到无穷大。即使在完全分离的情况下，它也保证能为 $\\alpha$ 和 $\\beta$ 生成有限的估计。与MLE相比，所得的估计量偏差更小。从这些有限的估计 $(\\hat{\\alpha}, \\hat{\\beta})$ 出发，可以计算出点估计 $d_{50} = \\exp(-\\hat{\\alpha}/\\hat{\\beta})$。\n关键的是，这种方法也支持有效的的不确定性量化。可以使用惩罚轮廓似然或相关方法来构建参数的置信区间，从而得到 $\\mathrm{EC}_{50}$ 的置信区间。该选项正确地指出了其等价于使用 Jeffreys 先验的贝叶斯分析，或更一般地，使用弱信息先验的贝叶斯分析。这些方法为参数提供了完整的后验分布，从中可以推导出 $\\mathrm{EC}_{50}$ 的可信区间。这种方法不是“临时数据修改”，而是对估计目标函数本身的修改，它植根于坚实的统计理论（偏差缩减、贝叶斯推断）。\n结论：**正确**。\n\n**选项D分析**：\n该选项建议将链接函数从 logit 切换到 probit，后者使用标准正态累积分布函数的逆函数 $\\Phi^{-1}(p)$。该选项声称，因为 probit 函数“不那么陡峭”，所以不会发生分离。\n这个说法是错误的。分离问题并非 logit 链接所特有。只要预测变量能完美地分离二元结果，任何S型剂量-反应曲线（probit、cloglog等）都会出现这个问题。就像 logit 链接一样，对于存在分离数据的 probit 模型，其似然函数会通过使曲线变为无限陡峭的阶跃函数来最大化。这对应于斜率参数 $\\beta \\to \\infty$。因此，切换到 probit 链接并不能解决MLE不存在的根本问题。“不会发生分离”的说法是明显错误的。\n结论：**错误**。\n\n基于对统计理论的全面分析，只有选项C提出了一种既理论上合理又满足问题陈述中所有条件的方法。", "answer": "$$\\boxed{C}$$", "id": "2481181"}, {"introduction": "生态毒理学的一个核心任务是理解和预测不同物种对污染物的敏感性。分层贝叶斯模型提供了一个强大的框架来完成这项任务，它假设每个物种的对数敏感度（例如 $\\log(EC50_s)$）是从一个共同的群体分布 $\\mathcal{N}(\\mu, \\tau^2)$ 中抽取的。本练习将指导您构建这样一个模型，利用已有物种的数据来推断群体分布的参数，并进一步预测一个全新物种的 $EC50$ 值及其不确定性。这是现代生态风险评估中用于物种敏感性分布（Species Sensitivity Distributions, SSD）分析的基础。[@problem_id:2481192]", "problem": "您正在使用分层贝叶斯框架，在对数尺度上对一种污染物的半数最大效应浓度 (EC50) 的种间变异进行建模，以保证浓度的正性并稳定变异性。设 $S$ 表示从精心设计的实验中获得可用剂量-反应总结的物种数量。对于每个物种 $s \\in \\{1,\\dots,S\\}$，设 $y_s$ 为其观测到的效应浓度 (单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$)，并定义 $x_s = \\log(y_s)$，其中 $\\log(\\cdot)$ 是自然对数。假设以下分层模型：潜在的物种水平对数效应 $x_s$ 是独立同分布的，服从 $x_s \\mid \\mu,\\tau^2 \\sim \\mathcal{N}(\\mu,\\tau^2)$，其中 $\\mu$ 是跨物种平均对数效应，$\\tau^2$ 是对数尺度上的跨物种方差。为 $(\\mu,\\tau^2)$ 设置一个共轭正态-逆伽马先验，具体为 $\\mu \\mid \\tau^2 \\sim \\mathcal{N}(m_0,\\tau^2/\\kappa_0)$ 和 $\\tau^2 \\sim \\mathrm{Inv\\mbox{-}Gamma}(a_0,b_0)$，其中逆伽马密度参数化为 $p(\\tau^2) \\propto (\\tau^2)^{-(a_0+1)} \\exp(-b_0/\\tau^2)$，当 $\\tau^2gt;0$ 时。\n\n您的任务是：\n- 仅从所述模型和先验出发，推导在给定数据 $\\{x_s\\}_{s=1}^S$ 的条件下 $(\\mu,\\tau^2)$ 的后验分布，然后推导新物种对数效应 $x_{\\mathrm{new}} = \\log(\\mathrm{EC50}_{\\mathrm{new}})$ 的后验预测分布，该分布通过对 $(\\mu,\\tau^2)$ 进行边缘化得到。从对数尺度上的该后验预测分布，通过应用适当的单调变换，推导出在原始浓度尺度上 $\\mathrm{EC50}_{\\mathrm{new}}$ 的后验中位数以及水平为 $q$ 的中心可信区间的表达式。\n- 在一个程序中实现这些表达式，该程序为下述每个测试用例计算：\n  1. $\\mathrm{EC50}_{\\mathrm{new}}$ 的后验中位数，单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$，以及\n  2. $\\mathrm{EC50}_{\\mathrm{new}}$ 的水平为 $q = 0.90$ 的中心可信区间的下界和上界，单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$，\n  其中报告的三个值都必须以 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$ 为单位表示，并四舍五入到 $6$ 位小数。可信区间概率水平 $q$ 必须解释为中心区间，即每个尾部的概率为 $(1-q)/2$，因此下分位数和上分位数分别对应于概率 $0.05$ 和 $0.95$。\n\n测试套件（每个测试用例指定观测浓度 $\\{y_s\\}_{s=1}^S$，单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$，您必须通过 $x_s=\\log(y_s)$ 对其进行转换，以及对数尺度上的先验超参数 $(m_0,\\kappa_0,a_0,b_0)$）：\n- 测试用例 1：\n  - 数据（单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$）： $[\\,1.0,\\,1.5,\\,2.0,\\,0.8,\\,1.2\\,]$。\n  - 先验： $m_0=\\log(1.0)$, $\\kappa_0=1.0$, $a_0=2.0$, $b_0=0.1$。\n- 测试用例 2：\n  - 数据（单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$）： $[\\,0.5,\\,0.6\\,]$。\n  - 先验： $m_0=\\log(0.7)$, $\\kappa_0=5.0$, $a_0=3.0, b_0=0.05$。\n- 测试用例 3：\n  - 数据（单位为 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$）： $[\\,0.05,\\,0.08,\\,0.07,\\,0.06,\\,0.09,\\,0.10\\,]$。\n  - 先验： $m_0=\\log(0.07)$, $\\kappa_0=0.1$, $a_0=1.0$, $b_0=0.01$。\n\n最终输出格式：\n- 对于每个测试用例，您的程序必须计算三元组 $[\\,\\mathrm{median},\\,\\mathrm{lower},\\,\\mathrm{upper}\\,]$，其中 $\\mathrm{median}$ 是 $\\mathrm{EC50}_{\\mathrm{new}}$ 的后验中位数，$(\\mathrm{lower},\\mathrm{upper})$ 是水平为 $q=0.90$ 的中心可信区间的界限，所有值都以 $\\mathrm{mg}\\,\\mathrm{L}^{-1}$ 为单位并四舍五入到 $6$ 位小数。\n- 将这三个案例各自的三元组按测试用例的顺序汇总成一个单一列表，并打印一行，其中仅包含此汇总结果，格式为方括号括起来的逗号分隔列表，例如 $[[v_{11},v_{12},v_{13}],[v_{21},v_{22},v_{23}],[v_{31},v_{32},v_{33}]]$, 不含任何额外文本。", "solution": "所提出的问题是分层贝叶斯建模中的一个标准练习，并且完全有效。它有科学依据、提法恰当，且解决问题所需的所有信息均已提供。我们将进行推导和后续计算。\n\n该问题要求我们基于对 $S$ 个其他物种的观测值，推导一个新物种的半数最大效应浓度 $\\mathrm{EC50}_{\\mathrm{new}}$ 的后验预测分布。建模是在浓度的自然对数上进行的，这是一种标准且合理的做法，以适应浓度的正值域并稳定方差。\n\n设 $S$ 个物种的观测浓度为 $\\{y_s\\}_{s=1}^S$。我们将对数浓度定义为 $x_s = \\log(y_s)$。分层模型规定如下：\n- **似然**：物种水平的对数效应 $x_s$ 被假定为在给定分层参数 $\\mu$ 和 $\\tau^2$ 的条件下，从一个正态分布中进行的独立同分布抽样：\n$$x_s \\mid \\mu, \\tau^2 \\sim \\mathcal{N}(\\mu, \\tau^2)$$\n- **先验**：在参数 $(\\mu, \\tau^2)$ 上设置一个共轭正态-逆伽马先验：\n$$\\mu \\mid \\tau^2 \\sim \\mathcal{N}(m_0, \\tau^2/\\kappa_0)$$\n$$\\tau^2 \\sim \\mathrm{Inv\\mbox{-}Gamma}(a_0, b_0)$$\n联合先验密度为 $p(\\mu, \\tau^2) = p(\\mu \\mid \\tau^2)p(\\tau^2)$。\n\n**1. $(\\mu, \\tau^2)$ 的后验分布推导**\n\n后验分布正比于似然与先验的乘积，即 $p(\\mu, \\tau^2 \\mid \\mathbf{x}) \\propto p(\\mathbf{x} \\mid \\mu, \\tau^2) p(\\mu, \\tau^2)$。\n数据 $\\mathbf{x} = \\{x_s\\}_{s=1}^S$ 的似然函数为：\n$$p(\\mathbf{x} \\mid \\mu, \\tau^2) = \\prod_{s=1}^S \\frac{1}{\\sqrt{2\\pi\\tau^2}} \\exp\\left(-\\frac{(x_s - \\mu)^2}{2\\tau^2}\\right) \\propto (\\tau^2)^{-S/2} \\exp\\left(-\\frac{1}{2\\tau^2} \\sum_{s=1}^S (x_s - \\mu)^2\\right)$$\n平方和可以分解为 $\\sum_{s=1}^S (x_s - \\mu)^2 = \\sum_{s=1}^S (x_s - \\bar{x})^2 + S(\\bar{x} - \\mu)^2$，其中 $\\bar{x} = \\frac{1}{S}\\sum_{s=1}^S x_s$ 是样本均值。\n\n联合先验密度为：\n$$p(\\mu, \\tau^2) \\propto (\\tau^2)^{-1/2} \\exp\\left(-\\frac{\\kappa_0(\\mu-m_0)^2}{2\\tau^2}\\right) \\cdot (\\tau^2)^{-(a_0+1)} \\exp\\left(-\\frac{b_0}{\\tau^2}\\right)$$\n$$p(\\mu, \\tau^2) \\propto (\\tau^2)^{-(a_0 + 3/2)} \\exp\\left(-\\frac{1}{2\\tau^2} [2b_0 + \\kappa_0(\\mu-m_0)^2]\\right)$$\n\n结合似然和先验，后验核为：\n$$p(\\mu, \\tau^2 \\mid \\mathbf{x}) \\propto (\\tau^2)^{-S/2} \\exp\\left(-\\frac{1}{2\\tau^2} \\left[\\sum(x_s-\\bar{x})^2 + S(\\bar{x}-\\mu)^2\\right]\\right) \\cdot (\\tau^2)^{-(a_0+3/2)} \\exp\\left(-\\frac{1}{2\\tau^2} [2b_0 + \\kappa_0(\\mu-m_0)^2]\\right)$$\n$$p(\\mu, \\tau^2 \\mid \\mathbf{x}) \\propto (\\tau^2)^{-(a_0+S/2+3/2)} \\exp\\left(-\\frac{1}{2\\tau^2} \\left[2b_0 + \\sum(x_s-\\bar{x})^2 + S(\\bar{x}-\\mu)^2 + \\kappa_0(\\mu-m_0)^2\\right]\\right)$$\n通过对指数部分中含 $\\mu$ 的项进行配方，我们可以确定后验的形式。$\\mu$ 的二次项构成了 $\\mu \\mid \\tau^2, \\mathbf{x}$ 的新高斯核，而其余项则更新了 $\\tau^2$ 的逆伽马分布的参数。\n由于正态-逆伽马先验对于正态似然具有共轭性，后验分布 $p(\\mu, \\tau^2 \\mid \\mathbf{x})$ 也是一个正态-逆伽马分布，即 $\\mathrm{NIG}(m_S, \\kappa_S, a_S, b_S)$，其更新后的超参数为：\n$$ \\kappa_S = \\kappa_0 + S $$\n$$ m_S = \\frac{\\kappa_0 m_0 + S\\bar{x}}{\\kappa_0 + S} $$\n$$ a_S = a_0 + \\frac{S}{2} $$\n$$ b_S = b_0 + \\frac{1}{2}\\sum_{s=1}^S (x_s - \\bar{x})^2 + \\frac{S\\kappa_0}{2(S+\\kappa_0)}(\\bar{x} - m_0)^2 $$\n\n**2. $x_{\\mathrm{new}}$ 的后验预测分布推导**\n\n新物种的对数效应 $x_{\\mathrm{new}}$ 的后验预测分布是通过对参数的后验分布进行边缘化得到的：\n$$p(x_{\\mathrm{new}} \\mid \\mathbf{x}) = \\int_0^\\infty \\int_{-\\infty}^\\infty p(x_{\\mathrm{new}} \\mid \\mu, \\tau^2) p(\\mu, \\tau^2 \\mid \\mathbf{x}) \\,d\\mu \\,d\\tau^2$$\n其中 $p(x_{\\mathrm{new}} \\mid \\mu, \\tau^2) = \\mathcal{N}(x_{\\mathrm{new}} \\mid \\mu, \\tau^2)$ 且 $p(\\mu, \\tau^2 \\mid \\mathbf{x})$ 是上文推导的后验分布。\n\n这是贝叶斯统计中的一个标准积分。我们首先对 $\\mu$ 进行积分：\n$$p(x_{\\mathrm{new}} \\mid \\tau^2, \\mathbf{x}) = \\int_{-\\infty}^\\infty p(x_{\\mathrm{new}} \\mid \\mu, \\tau^2) p(\\mu \\mid \\tau^2, \\mathbf{x}) \\,d\\mu$$\n这是两个正态分布的卷积：$x_{\\mathrm{new}} \\sim \\mathcal{N}(\\mu, \\tau^2)$ 和 $\\mu \\sim \\mathcal{N}(m_S, \\tau^2/\\kappa_S)$。结果是另一个正态分布：\n$$p(x_{\\mathrm{new}} \\mid \\tau^2, \\mathbf{x}) \\sim \\mathcal{N}\\left(m_S, \\tau^2 + \\frac{\\tau^2}{\\kappa_S}\\right) = \\mathcal{N}\\left(m_S, \\tau^2 \\frac{\\kappa_S+1}{\\kappa_S}\\right)$$\n接下来，我们将 $\\tau^2$ 积分掉：\n$$p(x_{\\mathrm{new}} \\mid \\mathbf{x}) = \\int_0^\\infty p(x_{\\mathrm{new}} \\mid \\tau^2, \\mathbf{x}) p(\\tau^2 \\mid \\mathbf{x}) \\,d\\tau^2$$\n其中 $\\tau^2 \\mid \\mathbf{x} \\sim \\mathrm{Inv\\mbox{-}Gamma}(a_S, b_S)$。这个积分产生一个非标准化的学生t分布。$x_{\\mathrm{new}}$ 的结果分布是一个位置-尺度 t 分布，即 $t_{\\nu}(\\mu_{\\text{pred}}, \\sigma^2_{\\text{pred}})$，其参数为：\n- 自由度：$\\nu = 2a_S$\n- 位置（均值）：$\\mu_{\\text{pred}} = m_S$\n- 尺度平方：$\\sigma^2_{\\text{pred}} = \\frac{b_S}{a_S} \\left(1 + \\frac{1}{\\kappa_S}\\right) = \\frac{b_S(\\kappa_S+1)}{a_S\\kappa_S}$\n因此，$(x_{\\mathrm{new}} - m_S) / \\sqrt{\\sigma^2_{\\text{pred}}}$ 服从一个自由度为 $2a_S$ 的标准学生t分布。\n\n**3. $\\mathrm{EC50}_{\\mathrm{new}}$ 的估计量推导**\n\n我们关心 $\\mathrm{EC50}_{\\mathrm{new}} = \\exp(x_{\\mathrm{new}})$ 的性质。由于指数函数是严格单调的，我们可以变换 $x_{\\mathrm{new}}$ 的后验预测分布的分位数，以找到 $\\mathrm{EC50}_{\\mathrm{new}}$ 的相应分位数。\n\n- **后验中位数**：学生t分布关于其位置参数是对称的。因此，$x_{\\mathrm{new}}$ 的后验预测分布的中位数是其均值 $m_S$。$\\mathrm{EC50}_{\\mathrm{new}}$ 的后验中位数是：\n$$\\mathrm{Median}(\\mathrm{EC50}_{\\mathrm{new}}) = \\exp(\\mathrm{Median}(x_{\\mathrm{new}})) = \\exp(m_S)$$\n\n- **中心可信区间**：$x_{\\mathrm{new}}$ 的一个水平为 $q$ 的中心可信区间由 $[L, U]$ 给出，其中 $L$ 和 $U$ 分别是其后验预测分布的 $(1-q)/2$ 和 $(1+q)/2$ 分位数。设 $t^*_{\\nu}(\\alpha)$ 表示自由度为 $\\nu$ 的标准学生t分布的 $\\alpha$-分位数。$x_{\\mathrm{new}}$ 的分位数为：\n$$L = m_S + \\sqrt{\\sigma^2_{\\text{pred}}} \\cdot t^*_{2a_S}\\left(\\frac{1-q}{2}\\right)$$\n$$U = m_S + \\sqrt{\\sigma^2_{\\text{pred}}} \\cdot t^*_{2a_S}\\left(\\frac{1+q}{2}\\right)$$\n$\\mathrm{EC50}_{\\mathrm{new}}$ 相应的水平为 $q$ 的中心可信区间是 $[\\exp(L), \\exp(U)]$。对于所要求的水平 $q=0.90$，分位数位于概率 $0.05$ 和 $0.95$ 处。区间界限的最终表达式为：\n$$\\text{Lower bound} = \\exp\\left(m_S + \\sqrt{\\frac{b_S(\\kappa_S+1)}{a_S\\kappa_S}} \\cdot t^*_{2a_S}(0.05)\\right)$$\n$$\\text{Upper bound} = \\exp\\left(m_S + \\sqrt{\\frac{b_S(\\kappa_S+1)}{a_S\\kappa_S}} \\cdot t^*_{2a_S}(0.95)\\right)$$\n这些公式为问题提供了完整的解析解，我们现在将对其进行实现。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Solves the hierarchical Bayesian modeling problem for the given test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1\n        {\n            \"data\": [1.0, 1.5, 2.0, 0.8, 1.2],\n            \"prior\": {\"m0\": np.log(1.0), \"k0\": 1.0, \"a0\": 2.0, \"b0\": 0.1}\n        },\n        # Test case 2\n        {\n            \"data\": [0.5, 0.6],\n            \"prior\": {\"m0\": np.log(0.7), \"k0\": 5.0, \"a0\": 3.0, \"b0\": 0.05}\n        },\n        # Test case 3\n        {\n            \"data\": [0.05, 0.08, 0.07, 0.06, 0.09, 0.10],\n            \"prior\": {\"m0\": np.log(0.07), \"k0\": 0.1, \"a0\": 1.0, \"b0\": 0.01}\n        }\n    ]\n\n    q = 0.90\n    results = []\n\n    for case in test_cases:\n        y_data = np.array(case[\"data\"])\n        prior = case[\"prior\"]\n        m0, k0, a0, b0 = prior[\"m0\"], prior[\"k0\"], prior[\"a0\"], prior[\"b0\"]\n\n        # Step 1: Log-transform the data\n        x_data = np.log(y_data)\n        \n        # Step 2: Calculate summary statistics for the data\n        S = len(x_data)\n        x_bar = np.mean(x_data)\n        # Sum of squared differences from the mean\n        ss = np.sum((x_data - x_bar)**2)\n\n        # Step 3: Calculate the posterior hyperparameters for the Normal-Inverse-Gamma distribution\n        kS = k0 + S\n        mS = (k0 * m0 + S * x_bar) / kS\n        aS = a0 + S / 2.0\n        bS = b0 + 0.5 * ss + (S * k0 / (2.0 * kS)) * (x_bar - m0)**2\n\n        # Step 4: Calculate the parameters for the posterior predictive t-distribution of x_new\n        # Degrees of freedom\n        nu = 2 * aS\n        # Location (mean)\n        mu_pred = mS\n        # Scale\n        sigma_pred_sq = (bS / aS) * (kS + 1.0) / kS\n        sigma_pred = np.sqrt(sigma_pred_sq)\n        \n        # Step 5: Compute the posterior median of EC50_new\n        median_ec50 = np.exp(mu_pred)\n\n        # Step 6: Compute the central credible interval for EC50_new\n        # Get the quantiles from the standard t-distribution\n        alpha = (1.0 - q) / 2.0  # tail probability, e.g., 0.05 for q=0.90\n        t_quantile_lower = t.ppf(alpha, df=nu)\n        t_quantile_upper = t.ppf(1.0 - alpha, df=nu)\n\n        # Calculate interval bounds for x_new\n        x_new_lower = mu_pred + sigma_pred * t_quantile_lower\n        x_new_upper = mu_pred + sigma_pred * t_quantile_upper\n\n        # Transform bounds back to the original concentration scale\n        lower_bound_ec50 = np.exp(x_new_lower)\n        upper_bound_ec50 = np.exp(x_new_upper)\n\n        # Step 7: Format results to 6 decimal places\n        result_triple = [\n            round(median_ec50, 6),\n            round(lower_bound_ec50, 6),\n            round(upper_bound_ec50, 6)\n        ]\n        results.append(result_triple)\n        \n    # Final print statement in the exact required format.\n    # The format requires no spaces after commas.\n    case_results_str = [f\"[{r[0]:.6f},{r[1]:.6f},{r[2]:.6f}]\" for r in results]\n    final_output_str = f\"[{','.join(case_results_str)}]\"\n    print(final_output_str)\n\nsolve()\n```", "id": "2481192"}]}