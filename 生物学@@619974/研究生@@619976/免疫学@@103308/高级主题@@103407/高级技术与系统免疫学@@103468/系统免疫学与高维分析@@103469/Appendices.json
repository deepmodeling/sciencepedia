{"hands_on_practices": [{"introduction": "理论知识通过实践得以升华。本章提供了一系列动手实践练习，旨在巩固您在系统免疫学和高维数据分析方面的核心技能。这些练习将引导您完成一个典型的系统免疫学研究项目从设计到分析的关键步骤。第一个练习关注的是任何严谨科学研究的基石：实验设计。在收集任何数据之前，我们必须确保实验有足够的能力来回答我们的研究问题，尤其是在试图识别罕见的细胞群体时。本练习将通过第一性原理推导，向您展示如何利用基本的概率论来确定研究所需的最小样本量，这是设计任何单细胞研究时至关重要的一步 [@problem_id:2892322]。", "problem": "一个系统免疫学小组设计了一项单细胞RNA测序 (scRNA-seq) 研究，用以检测一个罕见的免疫细胞群。该细胞群在一个混合均匀的大组织中以真实频率 $f \\in (0,1)$ 存在。实验将精确地获得 $n$ 个成功测序的单细胞，这些细胞从组织中独立抽样，因此适用二项模型。如果在 $n$ 个测序细胞中至少有一个属于该罕见细胞群，该小组将宣布成功检测到此细胞群。设 $\\alpha \\in (0,1)$ 表示当该细胞群以频率 $f$ 存在时，未能成功检测的预设容错率。\n\n请仅从基本概率模型（即从一个成功概率为 $f$ 的大总体中进行独立抽取会得到一个二项成功计数）出发，推导出一个闭式表达式，用于计算最小整数样本量 $n^{\\ast}(f,\\alpha)$。该样本量需保证检测到罕见细胞群的概率（即在 $n$ 个测序细胞中观察到至少一个此类细胞）至少为 $1-\\alpha$。\n\n你的最终答案应为仅含 $f$ 和 $\\alpha$ 的 $n^{\\ast}(f,\\alpha)$ 的一个解析表达式。无需进行数值计算或四舍五入。", "solution": "合适的起点是针对从大总体中进行独立抽样的二项模型。定义指示随机变量 $X_{i}$，对于 $i \\in \\{1,\\dots,n\\}$，如果第 $i$ 个测序细胞属于该罕见细胞群，则 $X_{i}=1$，否则 $X_{i}=0$。根据所述假设，$X_{i}$ 是独立同分布的，满足 $\\mathbb{P}(X_{i}=1)=f$ 和 $\\mathbb{P}(X_{i}=0)=1-f$。在 $n$ 个测序细胞中，罕见细胞的总数为\n$$\nS_{n} \\equiv \\sum_{i=1}^{n} X_{i} \\sim \\mathrm{Binomial}(n,f).\n$$\n检测到该细胞群的事件对应于观察到至少一个罕见细胞，即事件 $\\{S_{n} \\ge 1\\}$。其概率为\n$$\n\\mathbb{P}(S_{n} \\ge 1) \\;=\\; 1 - \\mathbb{P}(S_{n} = 0) \\;=\\; 1 - (1-f)^{n},\n$$\n其中最后一个等式成立是因为根据独立性，$\\mathbb{P}(S_{n}=0)=\\mathbb{P}(X_{1}=0,\\dots,X_{n}=0)=(1-f)^{n}$。\n\n我们要求这个检测概率至少为 $1-\\alpha$，即\n$$\n1 - (1-f)^{n} \\;\\ge\\; 1 - \\alpha.\n$$\n整理可得\n$$\n(1-f)^{n} \\;\\le\\; \\alpha,\n$$\n其中 $\\alpha \\in (0,1)$ 且 $f \\in (0,1)$。对两边取自然对数，并利用在 $(0,1)$ 上 $\\ln(1-f) < 0$ 的性质，可得\n$$\nn \\,\\ln(1-f) \\;\\le\\; \\ln(\\alpha).\n$$\n由于 $\\ln(1-f) < 0$，用 $\\ln(1-f)$ 除以不等式两边会使不等号方向反转：\n$$\nn \\;\\ge\\; \\frac{\\ln(\\alpha)}{\\ln(1-f)}.\n$$\n因此，满足该不等式的最小整数 $n^{\\ast}(f,\\alpha)$ 可通过取上取整得到：\n$$\nn^{\\ast}(f,\\alpha) \\;=\\; \\left\\lceil \\frac{\\ln(\\alpha)}{\\ln(1-f)} \\right\\rceil.\n$$\n\n这是精确的二项结果。为了在 $f$ 很小的罕见事件情景中获得直观理解，可以注意到近似式 $\\ln(1-f) \\approx -f$，这给出了 $n^{\\ast}(f,\\alpha) \\approx \\left\\lceil \\ln(\\alpha^{-1})/f \\right\\rceil$，但所要求的精确表达式是上面那个。", "answer": "$$\\boxed{\\left\\lceil \\frac{\\ln(\\alpha)}{\\ln(1 - f)} \\right\\rceil}$$", "id": "2892322"}, {"introduction": "在成功设计并执行实验后，下一步是处理原始数据，而数据质量控制是其中不可或缺的一环。高维数据中普遍存在着可能影响生物学解释的技术性伪影。这个练习将带您直面单细胞RNA测序中最常见的挑战之一：环境RNA污染。您将学习如何构建一个原则性的工作流程来量化这种污染，并推导出一个最大似然估计量，将对技术伪影的理解转化为一个强大的定量校正工具 [@problem_id:2892311]。", "problem": "一项基于液滴的单细胞RNA测序（scRNA-seq；单细胞核糖核酸测序）实验在外周血单个核细胞（PBMC；peripheral blood mononuclear cells）上进行，由于悬浮液中的细胞裂解，怀疑存在环境RNA污染。环境RNA是指并非源自捕获细胞内源性表达，而是从细胞外溶液中随机进入液滴的转录本。在使用独特分子标识符（UMI；unique molecular identifiers）的液滴方法中，未包裹细胞的条形码（空液滴）和低含量条形码（无细胞条形码）只捕获环境RNA。目标是建立一个有原则的检测工作流程，并在此流程中，为一个T细胞推导并评估一个简单的环境RNA贡献估计量。\n\n构建一个概念上最简化、科学上可辩护的工作流程，该流程利用空液滴和低含量条形码来估计环境RNA的组分，然后量化每个细胞中的环境RNA分数。之后，专注于单个T细胞的估计步骤，按如下方式进行。\n\n建模假设（基于标准的液滴scRNA-seq实践）：\n- 设 $G$ 为基因的索引集合，设 $x_{g}$ 表示特定T细胞中基因 $g$ 的观测UMI计数，总计数为 $m=\\sum_{g\\in G} x_{g}$。\n- 设 $a=(a_{g})_{g\\in G}$ 为环境RNA组分，通过汇总空液滴和无细胞条形码的数据进行估计，并归一化以使 $\\sum_{g\\in G} a_{g}=1$。\n- 在此T细胞中，考虑一个基因集 $D\\subset G$，它由T细胞不进行内源性表达的免疫球蛋白重链和轻链基因组成。假设对于该细胞， $g\\in D$ 中基因的内源性表达为 $0$。\n- 对于该T细胞，假设观测计数由细胞的真实表达和环境RNA混合而成，因此从基因 $g$ 中抽样一个UMI的概率为 $(1-\\alpha) s_{g} + \\alpha a_{g}$，其中 $s=(s_{g})_{g\\in G}$ 是未知的细胞内源组分（$\\sum_{g\\in G} s_{g}=1$），而 $\\alpha\\in[0,1]$ 是待估计的细胞特异性环境RNA分数。\n- 假设在总计数 $m$ 已知的条件下，计数向量服从一个以上述概率定义的多项式抽样模型。\n\n任务：\n1. 根据建模假设，并且只使用基因集 $D$ 中的基因，为该T细胞的环境RNA分数 $\\alpha$ 推导一个最大似然估计量。该估计量应依赖于 $x_{g}$, $m$, 和 $a_{g}$，但不依赖于未知的 $s_{g}$。\n2. 对于一个特定的T细胞，假设总UMI计数为 $m=5200$，分配给基因集 $D$ 中基因的总计数为 $\\sum_{g\\in D} x_{g} = 8$，并且在 $D$ 中估计的环境RNA质量为 $\\sum_{g\\in D} a_{g} = 0.015$。为该细胞数值化地评估你的估计量。将最终答案表示为一个纯数（无量纲），并四舍五入到三位有效数字。", "solution": "所提出的问题具有科学依据、阐述清晰，并包含足够的信息以进行严谨的求解。我们将直接开始构建工作流程并推导估计量。\n\n一个用于估计和校正环境RNA污染的有原则的工作流程包括以下步骤：\n$1$. 估计环境RNA谱：必须估计环境RNA的基因表达谱，记为向量 $a=(a_g)_{g\\in G}$，其中 $\\sum_{g \\in G} a_g = 1$。这通过识别未包裹细胞的液滴来完成。这些“空”液滴，以及与极低UMI计数（表明是无细胞RNA或碎片）相关的条形码，被假定为完全从环境池中取样。将所有这些条形码的RNA计数进行汇总，并归一化使其总和为1。这个归一化后的向量作为 $a$ 的经验估计。\n$2$. 识别污染标记基因：对于每种感兴趣的细胞类型，必须预先确定一组在该细胞类型中已知内源性表达为零的基因。对于T细胞，如问题所述，免疫球蛋白基因集 $D$ 是一个合适的选择，因为这些基因由B细胞表达，而不是T细胞。因此，在T细胞中观察到的任何来自这些基因的读数都被归因于环境RNA污染。\n$3. $估计细胞特异性环境RNA分数 $\\alpha$：对于每个单独的细胞，使用一个统计模型来估计其总UMI计数中来自环境池的分数 $\\alpha$。该模型利用步骤2中标记基因的观测计数和步骤1中的环境RNA谱。这个估计量的推导是本次的主要任务。\n$4$. 校正表达谱：一旦为某个细胞估计了 $\\alpha$，就可以计算每个基因 $g$ 的预期环境RNA计数（$m \\alpha a_g$），并用它来校正观测计数 $x_g$。这个“去污染”步骤可以更准确地表示细胞的内源性转录组，尽管这最后一步超出了当前任务的范围。\n\n我们现在专注于任务1：推导环境RNA分数 $\\alpha$ 的最大似然估计量（MLE）。\n问题指出，对于总UMI计数为 $m = \\sum_{g \\in G} x_g$ 的单个细胞，其观测UMI计数向量 $x = (x_g)_{g \\in G}$ 来自一个多项式分布：\n$$ x \\sim \\text{Multinomial}(m, p) $$\n其中 $p=(p_g)_{g \\in G}$ 是抽样概率向量，且 $p_g = (1-\\alpha)s_g + \\alpha a_g$。这里，$s_g$ 代表细胞对基因 $g$ 的真实、未知的表达比例，而 $a_g$ 是已知的环境RNA中基因 $g$ 的比例。\n\n关键假设是存在一个基因集 $D$，对于其中所有的基因 $g \\in D$，其内源性表达为零，即 $s_g=0$。对于这些基因，抽样概率简化为：\n$$ p_g = (1-\\alpha) \\cdot 0 + \\alpha a_g = \\alpha a_g, \\quad \\text{for } g \\in D $$\n为了推导出一个不依赖于未知谱 $s$ 的 $\\alpha$ 估计量，我们可以通过将所有基因划分为两类来重构此问题：属于标记基因集 $D$ 的基因和不属于 $D$ 的基因（表示为其补集 $D^c = G \\setminus D$）。\n\n令 $X_D = \\sum_{g \\in D} x_g$ 为在标记基因集 $D$ 中观测到的UMI总计数。\n令 $P_D$ 为观测到来自 $D$ 中任一基因的UMI的概率。这是各项概率之和：\n$$ P_D = \\sum_{g \\in D} p_g = \\sum_{g \\in D} \\alpha a_g = \\alpha \\sum_{g \\in D} a_g $$\n我们定义 $A_D = \\sum_{g \\in D} a_g$ 为对应于标记基因集 $D$ 的环境RNA总分数。因此，$P_D = \\alpha A_D$。\n\n总试验次数是总UMI计数 $m$。 “成功”次数（在 $D$ 中的计数）是 $X_D$。这种情况可以用二项分布来描述：\n$$ X_D \\sim \\text{Binomial}(m, P_D) = \\text{Binomial}(m, \\alpha A_D) $$\n给定观测值 $X_D$ 时，$\\alpha$ 的似然函数 $L$ 是二项分布的概率质量函数：\n$$ L(\\alpha | X_D, m, A_D) = \\binom{m}{X_D} (P_D)^{X_D} (1-P_D)^{m-X_D} $$\n代入 $P_D = \\alpha A_D$：\n$$ L(\\alpha) = \\binom{m}{X_D} (\\alpha A_D)^{X_D} (1 - \\alpha A_D)^{m-X_D} $$\n为了找到最大似然估计量 $\\hat{\\alpha}$，我们最大化对数似然函数 $\\ln L(\\alpha)$：\n$$ \\ln L(\\alpha) = \\ln \\binom{m}{X_D} + X_D \\ln(\\alpha A_D) + (m-X_D) \\ln(1 - \\alpha A_D) $$\n$$ \\ln L(\\alpha) = \\text{const} + X_D (\\ln \\alpha + \\ln A_D) + (m-X_D) \\ln(1 - \\alpha A_D) $$\n我们对 $\\alpha$ 求导并令其为零：\n$$ \\frac{d \\ln L}{d\\alpha} = \\frac{X_D}{\\alpha} + (m-X_D) \\frac{-A_D}{1 - \\alpha A_D} = 0 $$\n$$ \\frac{X_D}{\\hat{\\alpha}} = \\frac{(m-X_D)A_D}{1 - \\hat{\\alpha} A_D} $$\n求解 $\\hat{\\alpha}$：\n$$ X_D(1 - \\hat{\\alpha} A_D) = \\hat{\\alpha}(m-X_D)A_D $$\n$$ X_D - \\hat{\\alpha} X_D A_D = \\hat{\\alpha} m A_D - \\hat{\\alpha} X_D A_D $$\n$$ X_D = \\hat{\\alpha} m A_D $$\n这就得到了 $\\alpha$ 的最大似然估计量：\n$$ \\hat{\\alpha} = \\frac{X_D}{m A_D} = \\frac{\\sum_{g \\in D} x_g}{m \\sum_{g \\in D} a_g} $$\n正如所要求，该表达式仅依赖于标记基因集中的观测计数、总UMI计数以及标记基因集的聚合环境RNA分数。\n\n对于任务2，我们对该估计量进行数值计算。给定的值为：\n- 总UMI计数，$m = 5200$。\n- 基因集 $D$ 中的总计数，$\\sum_{g \\in D} x_g = 8$。\n- 基因集 $D$ 中的总环境RNA质量，$\\sum_{g \\in D} a_g = 0.015$。\n\n将这些值代入我们推导出的估计量中：\n$$ \\hat{\\alpha} = \\frac{8}{5200 \\times 0.015} $$\n首先，我们计算分母：\n$$ 5200 \\times 0.015 = 5200 \\times \\frac{15}{1000} = 5.2 \\times 15 = 78 $$\n现在，我们计算 $\\hat{\\alpha}$ 的值：\n$$ \\hat{\\alpha} = \\frac{8}{78} = \\frac{4}{39} $$\n其小数值约为 $0.1025641...$。\n问题要求答案四舍五入到三位有效数字。前三位有效数字是 $1$、$0$ 和 $2$。第四位数字是 $5$，因此我们将第三位数字向上取整。\n$$ \\hat{\\alpha} \\approx 0.103 $$\n该值表示估计的环境RNA污染分数为 $10.3\\%$。", "answer": "$$\\boxed{0.103}$$", "id": "2892311"}, {"introduction": "在完成实验设计和数据净化之后，我们便进入了系统免疫学研究的核心目标：比较不同条件下（例如，健康与疾病）的细胞群体。这个高级练习将向您介绍一种前沿的计算方法——熵正则化最优传输（Optimal Transport）。该方法为比较和对齐复杂的细胞状态分布提供了一个强大而有原则的框架。通过这个练习，您将从零开始推导解决该问题的核心算法（Sinkhorn算法），并将其应用于一个具体的免疫学场景，从而揭开这一强大分析工具的神秘面纱 [@problem_id:2892437]。", "problem": "考虑用单细胞 RNA 测序 (scRNA-seq) 测量的两个细胞群，每个细胞群都被概括为在粗粒化细胞状态上的离散概率分布，这些状态是通过变分自编码器学习的共同潜在嵌入获得的。您希望使用熵正则化最优输运来耦合这些分布，以推断不同条件之间的随机映射，同时考虑到生物随机性，避免过于尖锐的耦合。设源分布为 $a \\in \\mathbb{R}_{+}^{n}$，目标分布为 $b \\in \\mathbb{R}_{+}^{m}$，且满足 $\\sum_{i=1}^{n} a_{i} = 1$ 和 $\\sum_{j=1}^{m} b_{j} = 1$。设 $C \\in \\mathbb{R}^{n \\times m}$ 是一个由状态间的转录差异导出的非负成本矩阵，$\\varepsilon > 0$ 是熵正则化强度。\n\n任务 A (公式化表述)：仅使用概率分布和 Kullback–Leibler 散度 (KLD) 的核心定义，定义熵正则化最优输运问题。该问题旨在寻找一个耦合矩阵 $\\Pi \\in \\mathbb{R}_{+}^{n \\times m}$，在满足边际条件 $a$ 和 $b$ 的情况下，最小化输运成本加熵惩罚。您的定义必须写成一个关于 $\\Pi$ 的约束优化问题，该问题依赖于 $C$、$a$、$b$ 和 $\\varepsilon$。\n\n任务 B (推导)：从任务 A 中的约束优化问题出发，进行拉格朗日分析，并导出在严格为正的情况下刻画唯一最优解的定点缩放方程。证明最优耦合允许分解为 $\\Pi^{\\star} = \\operatorname{diag}(u)\\,K\\,\\operatorname{diag}(v)$ 的形式，其中 Gibbs 核 $K$ 由 $C$ 和 $\\varepsilon$ 决定，并为缩放向量 $u \\in \\mathbb{R}_{+}^{n}$ 和 $v \\in \\mathbb{R}_{+}^{m}$ 推导出强制执行边际约束的迭代更新方程。除了正性和可行性之外，不要对 $a$、$b$ 或 $C$ 的具体形式做任何假设。\n\n任务 C (计算)：现在，将问题具体化到一个最小的免疫学场景，其中有 $n = m = 2$ 个粗粒化状态，代表两种条件下静息和活化的 T 细胞表型。假设\n$$\na = \\begin{pmatrix} 0.6 \\\\ 0.4 \\end{pmatrix}, \n\\quad\nb = \\begin{pmatrix} 0.5 \\\\ 0.5 \\end{pmatrix},\n\\quad\nC = \\begin{pmatrix} 0 & \\ln(2) \\\\ \\ln(2) & 0 \\end{pmatrix},\n\\quad\n\\varepsilon = 1.\n$$\n使用您推导出的缩放更新直至收敛，计算通过任务 A 和 B 中的熵正则化最优输运获得的最优耦合 $\\,\\Pi^{\\star}\\,$ 的第 $(1,2)$ 个元素。将最终数值答案四舍五入到四位有效数字。只给出数值，不带单位。", "solution": "在尝试求解之前，需对问题进行验证。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n- 源概率分布：$a \\in \\mathbb{R}_{+}^{n}$，且 $\\sum_{i=1}^{n} a_{i} = 1$。\n- 目标概率分布：$b \\in \\mathbb{R}_{+}^{m}$，且 $\\sum_{j=1}^{m} b_{j} = 1$。\n- 成本矩阵：$C \\in \\mathbb{R}^{n \\times m}$，其元素为非负值 $C_{ij} \\geq 0$。\n- 熵正则化强度：$\\varepsilon > 0$。\n- 耦合矩阵 (输运方案)：$\\Pi \\in \\mathbb{R}_{+}^{n \\times m}$。\n- $\\Pi$ 的边际约束：对所有 $i \\in \\{1, \\dots, n\\}$，$\\sum_{j=1}^{m} \\Pi_{ij} = a_{i}$；对所有 $j \\in \\{1, \\dots, m\\}$，$\\sum_{i=1}^{n} \\Pi_{ij} = b_{j}$。\n- **任务 A**：将熵正则化最优输运问题表述为关于 $\\Pi$ 的约束优化问题。\n- **任务 B**：通过拉格朗日分析推导定点缩放方程 (Sinkhorn 算法)。\n- **任务 C**：对于一个 $n=m=2$ 的特定情况，给定 $a$、$b$、$C$、$\\varepsilon$，计算 $\\Pi^{\\star}_{12}$ 的值。\n- 任务 C 的数值：\n$$\na = \\begin{pmatrix} 0.6 \\\\ 0.4 \\end{pmatrix}, \n\\quad\nb = \\begin{pmatrix} 0.5 \\\\ 0.5 \\end{pmatrix},\n\\quad\nC = \\begin{pmatrix} 0 & \\ln(2) \\\\ \\ln(2) & 0 \\end{pmatrix},\n\\quad\n\\varepsilon = 1.\n$$\n\n**步骤 2：使用提取的已知条件进行验证**\n- **科学依据**：该问题是熵正则化最优输运的标准表述，这是应用数学和计算机科学中一个成熟的课题。其在单细胞数据分析中的应用是系统免疫学的一个重要研究领域，这使得该问题的背景具有科学相关性和合理性。\n- **适定性**：该问题是一个凸优化问题。当 $\\varepsilon > 0$ 时，目标函数是严格凸函数，约束集（输运多胞体）是一个非空、凸且紧的集合。这保证了解的存在性和唯一性。\n- **客观性**：该问题使用精确的数学语言和定义进行陈述，没有歧义或主观内容。\n\n**步骤 3：结论与行动**\n该问题具有科学依据、适定、客观且自洽。判定为**有效**。将提供解答。\n\n### 解答\n\n**任务 A：公式化表述**\n\n经典的最优输运问题旨在最小化总输运成本 $\\langle C, \\Pi \\rangle = \\sum_{i,j} C_{ij} \\Pi_{ij}$，并满足边际约束。熵正则化为此目标函数引入了一个惩罚项，该惩罚项鼓励更平滑、非确定性更强的耦合。正则化问题可以使用 Kullback-Leibler (KL) 散度进行优雅地表述。\n\n设 $U(a,b)$ 表示输运多胞体，它是所有满足边际约束的矩阵 $\\Pi \\in \\mathbb{R}_{+}^{n \\times m}$ 的集合：\n$$\nU(a,b) = \\left\\{ \\Pi \\in \\mathbb{R}_{+}^{n \\times m} \\mid \\sum_{j=1}^{m} \\Pi_{ij} = a_i, \\forall i; \\quad \\sum_{i=1}^{n} \\Pi_{ij} = b_j, \\forall j \\right\\}\n$$\n熵正则化最优输运问题等价于在 KL 散度的意义下，寻找一个耦合 $\\Pi \\in U(a,b)$，使其最接近由成本矩阵 $C$ 和正则化强度 $\\varepsilon$ 定义的 Gibbs 核矩阵 $K \\in \\mathbb{R}_{+}^{n \\times m}$。Gibbs 核定义为：\n$$\nK_{ij} = \\exp\\left(-\\frac{C_{ij}}{\\varepsilon}\\right)\n$$\n两个离散分布 $P$ 和 $Q$ 之间的 KL 散度为 $\\text{KL}(P || Q) = \\sum_{k} P_k \\ln(P_k/Q_k)$。将其应用于矩阵，问题就变成了最小化 $\\text{KL}(\\Pi || K)$。\n\n因此，约束优化问题为：\n$$\n\\min_{\\Pi \\in U(a,b)} \\text{KL}(\\Pi || K) = \\min_{\\Pi \\in U(a,b)} \\sum_{i=1}^{n} \\sum_{j=1}^{m} \\Pi_{ij} \\ln\\left(\\frac{\\Pi_{ij}}{K_{ij}}\\right)\n$$\n展开此目标函数，可以揭示其与输运成本和熵的联系：\n$$\n\\sum_{i,j} \\Pi_{ij} \\ln\\left(\\frac{\\Pi_{ij}}{K_{ij}}\\right) = \\sum_{i,j} \\Pi_{ij} \\ln(\\Pi_{ij}) - \\sum_{i,j} \\Pi_{ij} \\ln(K_{ij}) = \\sum_{i,j} \\Pi_{ij} \\ln(\\Pi_{ij}) + \\frac{1}{\\varepsilon} \\sum_{i,j} C_{ij} \\Pi_{ij}\n$$\n最小化此表达式等价于最小化 $\\frac{1}{\\varepsilon}\\langle C, \\Pi \\rangle + \\sum_{i,j} \\Pi_{ij} \\ln(\\Pi_{ij})$，即缩放后的输运成本与一个负熵项之和，这与问题描述中的“输运成本加熵惩罚”一致。\n\n**任务 B：推导**\n\n我们通过使用拉格朗日乘子法分析任务 A 中的优化问题，来推导最优耦合 $\\Pi^{\\star}$ 的结构。目标函数是 $J(\\Pi) = \\text{KL}(\\Pi || K)$。约束条件是边际 $\\sum_{j} \\Pi_{ij} = a_i$ 和 $\\sum_{i} \\Pi_{ij} = b_j$。设 $f_i \\in \\mathbb{R}$ 和 $g_j \\in \\mathbb{R}$ 分别是与源边际和目标边际相关的拉格朗日乘子。拉格朗日函数 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}(\\Pi, f, g) = \\sum_{i,j} \\Pi_{ij} \\ln\\left(\\frac{\\Pi_{ij}}{K_{ij}}\\right) - \\sum_{i=1}^{n} f_i \\left(\\sum_{j=1}^{m} \\Pi_{ij} - a_i\\right) - \\sum_{j=1}^{m} g_j \\left(\\sum_{i=1}^{n} \\Pi_{ij} - b_j\\right)\n$$\n通过将 $\\mathcal{L}$ 对 $\\Pi_{ij}$ 的偏导数设为零，可以找到最优性条件。非负约束 $\\Pi_{ij} \\ge 0$ 已被对数函数的定义域隐式满足。\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\Pi_{ij}} = \\ln\\left(\\frac{\\Pi_{ij}}{K_{ij}}\\right) + 1 - f_i - g_j = 0\n$$\n求解 $\\Pi_{ij}$：\n$$\n\\ln\\left(\\frac{\\Pi_{ij}}{K_{ij}}\\right) = f_i + g_j - 1 \\implies \\frac{\\Pi_{ij}}{K_{ij}} = \\exp(f_i + g_j - 1)\n$$\n$$\n\\Pi_{ij} = K_{ij} \\exp(f_i-1) \\exp(g_j)\n$$\n对于常数 $\\exp(-1)$ 如何分配，其形式是任意的。为了对称性，我们可以写成 $\\Pi_{ij} = K_{ij} \\exp(f_i-1/2) \\exp(g_j-1/2)$。让我们定义两个缩放向量 $u \\in \\mathbb{R}_{+}^{n}$ 和 $v \\in \\mathbb{R}_{+}^{m}$，使得：\n$$\nu_i = \\exp(f_i - 1/2) \\quad \\text{和} \\quad v_j = \\exp(g_j - 1/2)\n$$\n因此，最优耦合 $\\Pi^{\\star}$ 必须具有以下结构：\n$$\n\\Pi^{\\star}_{ij} = u_i K_{ij} v_j\n$$\n这等价于矩阵形式 $\\Pi^{\\star} = \\operatorname{diag}(u)\\,K\\,\\operatorname{diag}(v)$，其中 $\\operatorname{diag}(u)$ 和 $\\operatorname{diag}(v)$ 是对角矩阵，其对角线上的元素分别为 $u$ 和 $v$ 的元素。\n\n缩放向量 $u$ 和 $v$ 是通过对这种形式的 $\\Pi^{\\star}$ 强制施加边际约束来确定的：\n1.  源边际约束：$\\sum_{j=1}^{m} \\Pi^{\\star}_{ij} = a_i$\n$$\n\\sum_{j=1}^{m} u_i K_{ij} v_j = a_i \\implies u_i \\left( \\sum_{j=1}^{m} K_{ij} v_j \\right) = a_i \\implies u_i = \\frac{a_i}{\\sum_{j=1}^{m} K_{ij} v_j}\n$$\n用向量表示法，即为 $u = a \\oslash (Kv)$，其中 $\\oslash$ 表示逐元素除法。\n2.  目标边际约束：$\\sum_{i=1}^{n} \\Pi^{\\star}_{ij} = b_j$\n$$\n\\sum_{i=1}^{n} u_i K_{ij} v_j = b_j \\implies v_j \\left( \\sum_{i=1}^{n} u_i K_{ij} \\right) = b_j \\implies v_j = \\frac{b_j}{\\sum_{i=1}^{n} K_{ij} u_i}\n$$\n用向量表示法，即为 $v = b \\oslash (K^T u)$。\n\n这两个耦合方程定义了缩放向量。可以使用 Sinkhorn 算法迭代求解。从一个初始猜测（通常是 $v^{(0)} = \\mathbf{1}_m$，即全 1 向量）开始，对 $k \\ge 1$ 进行以下更新迭代，直至收敛：\n$$\nu^{(k)} = a \\oslash (K v^{(k-1)})\n$$\n$$\nv^{(k)} = b \\oslash (K^T u^{(k)})\n$$\n\n**任务 C：计算**\n\n我们已知 $n=m=2$，$\\varepsilon=1$，且：\n$$\na = \\begin{pmatrix} 0.6 \\\\ 0.4 \\end{pmatrix}, \\quad b = \\begin{pmatrix} 0.5 \\\\ 0.5 \\end{pmatrix}, \\quad C = \\begin{pmatrix} 0 & \\ln(2) \\\\ \\ln(2) & 0 \\end{pmatrix}\n$$\n首先，我们计算 Gibbs 核 $K = \\exp(-C/\\varepsilon) = \\exp(-C)$：\n$$\nK_{11} = \\exp(-0) = 1\n$$\n$$\nK_{12} = \\exp(-\\ln(2)) = \\frac{1}{2} = 0.5\n$$\n$$\nK_{21} = \\exp(-\\ln(2)) = \\frac{1}{2} = 0.5\n$$\n$$\nK_{22} = \\exp(-0) = 1\n$$\n所以，核矩阵为 $K = \\begin{pmatrix} 1 & 0.5 \\\\ 0.5 & 1 \\end{pmatrix}$。\n\n接下来，我们应用 Sinkhorn 迭代更新。我们初始化 $v^{(0)} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$。\n\n**迭代 $k=1$**：\n- 更新 $u$：\n$u_1^{(1)} = \\frac{a_1}{K_{11} v_1^{(0)} + K_{12} v_2^{(0)}} = \\frac{0.6}{1(1) + 0.5(1)} = \\frac{0.6}{1.5} = 0.4$\n$u_2^{(1)} = \\frac{a_2}{K_{21} v_1^{(0)} + K_{22} v_2^{(0)}} = \\frac{0.4}{0.5(1) + 1(1)} = \\frac{0.4}{1.5} = \\frac{4}{15} \\approx 0.266667$\n- 更新 $v$：\n$v_1^{(1)} = \\frac{b_1}{K_{11} u_1^{(1)} + K_{21} u_2^{(1)}} = \\frac{0.5}{1(0.4) + 0.5(4/15)} = \\frac{0.5}{0.4 + 2/15} = \\frac{0.5}{8/15} = \\frac{15}{16} = 0.9375$\n$v_2^{(1)} = \\frac{b_2}{K_{12} u_1^{(1)} + K_{22} u_2^{(1)}} = \\frac{0.5}{0.5(0.4) + 1(4/15)} = \\frac{0.5}{0.2 + 4/15} = \\frac{0.5}{7/15} = \\frac{15}{14} \\approx 1.071429$\n\n**迭代 $k=2$**：\n- 更新 $u$：\n$u_1^{(2)} = \\frac{0.6}{1(15/16) + 0.5(15/14)} = \\frac{0.6}{15/16 + 15/28} \\approx 0.407273$\n$u_2^{(2)} = \\frac{0.4}{0.5(15/16) + 1(15/14)} = \\frac{0.4}{15/32 + 15/14} \\approx 0.259710$\n- 更新 $v$：\n$v_1^{(2)} = \\frac{0.5}{1(0.407273) + 0.5(0.259710)} \\approx 0.930870$\n$v_2^{(2)} = \\frac{0.5}{0.5(0.407273) + 1(0.259710)} \\approx 1.079137$\n\n继续这个过程直到收敛（前 5-6 位小数稳定）：\n$u^{(0)} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}, v^{(0)} = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$\n$k=1: u^{(1)} \\approx \\begin{pmatrix} 0.4 \\\\ 0.266667 \\end{pmatrix}, v^{(1)} \\approx \\begin{pmatrix} 0.9375 \\\\ 1.071429 \\end{pmatrix}$\n$k=2: u^{(2)} \\approx \\begin{pmatrix} 0.407273 \\\\ 0.259710 \\end{pmatrix}, v^{(2)} \\approx \\begin{pmatrix} 0.930870 \\\\ 1.079137 \\end{pmatrix}$\n$k=3: u^{(3)} \\approx \\begin{pmatrix} 0.408284 \\\\ 0.258828 \\end{pmatrix}, v^{(3)} \\approx \\begin{pmatrix} 0.930066 \\\\ 1.079822 \\end{pmatrix}$\n$k=4: u^{(4)} \\approx \\begin{pmatrix} 0.408401 \\\\ 0.258728 \\end{pmatrix}, v^{(4)} \\approx \\begin{pmatrix} 0.929986 \\\\ 1.079901 \\end{pmatrix}$\n$k=5: u^{(5)} \\approx \\begin{pmatrix} 0.408415 \\\\ 0.258716 \\end{pmatrix}, v^{(5)} \\approx \\begin{pmatrix} 0.929978 \\\\ 1.079910 \\end{pmatrix}$\n$k=6: u^{(6)} \\approx \\begin{pmatrix} 0.408417 \\\\ 0.258714 \\end{pmatrix}, v^{(6)} \\approx \\begin{pmatrix} 0.929977 \\\\ 1.079911 \\end{pmatrix}$\n这些值已充分收敛。设收敛后的缩放向量为 $u^{\\star} \\approx \\begin{pmatrix} 0.408417 \\\\ 0.258714 \\end{pmatrix}$ 和 $v^{\\star} \\approx \\begin{pmatrix} 0.929977 \\\\ 1.079911 \\end{pmatrix}$。\n\n任务是计算最优耦合矩阵的第 $(1,2)$ 个元素，$\\Pi^{\\star}_{12}$。\n$$\n\\Pi^{\\star}_{12} = u^{\\star}_1 K_{12} v^{\\star}_2\n$$\n代入收敛值和 $K_{12}=0.5$：\n$$\n\\Pi^{\\star}_{12} \\approx (0.408417) \\times (0.5) \\times (1.079911)\n$$\n$$\n\\Pi^{\\star}_{12} \\approx 0.22052825\n$$\n四舍五入到四位有效数字，得到 $0.2205$。", "answer": "$$\\boxed{0.2205}$$", "id": "2892437"}]}