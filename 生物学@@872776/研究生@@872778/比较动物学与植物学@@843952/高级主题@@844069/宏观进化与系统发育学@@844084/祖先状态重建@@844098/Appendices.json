{"hands_on_practices": [{"introduction": "在祖先状态重建中，最大简约法是一个基础且直观的准则。其核心思想是，在所有可能的进化历史中，我们偏好需要最少进化改变（例如，性状状态的转变）的那一个。Fitch算法为无序性状（例如，状态0与状态1之间的转换成本相等）提供了一个高效的计算框架，能够精确计算出最小的改变次数并确定祖先节点的可能状态集。通过这个练习[@problem_id:2545589]，你将亲手应用Fitch算法，在一个简单的系统发育树上，自下而上（post-order）和自上而下（pre-order）地推演祖先状态，从而掌握简约法重建的根本逻辑。", "problem": "在比较动物学和植物学中，最大简约法下的祖先状态重建旨在推断祖先的性状状态，以最小化系统发育树上状态变化的总数。考虑一个无序的二元性状，这意味着转换 $0 \\leftrightarrow 1$ 的代价相等。给定一个拓扑结构为 `((A,B),C)` 的有根三分类单元树，其观察到的叶尖状态为 $A=0$、$B=1$ 和 $C=1$。使用简约法准则和 Fitch 算法，确定两个内部节点所有可能的祖先状态集：连接 $A$ 和 $B$ 的内部节点（称之为节点 $v$），以及连接 $(A,B)$ 与 $C$ 的根节点（称之为节点 $r$）。然后计算在该重建下，树上所隐含的状态变化的最小总数。将变化的最小总数作为一个整数报告为最终答案。无需四舍五入。", "solution": "基本原则是最大简约法准则：在所有与观察到的叶尖状态一致的祖先性状状态分配中，选择那些使状态变化总数最小化的分配。对于无序的二元性状，转换 $0 \\to 1$ 和 $1 \\to 0$ 的代价相同，计为 $1$，并且没有方向性偏差。\n\nFitch 算法提供了一个构造性过程，用于为每个内部节点计算一组可能的状态，这些状态可以在不增加最小步数的情况下被分配，并同时得出变化的最小数量。该算法分两次遍历进行。\n\n上行遍历（后序）以计算祖先状态集并统计变化次数：\n- 对于叶节点，分配观察到的单元素集合：$S_A=\\{0\\}$、$S_B=\\{1\\}$、$S_C=\\{1\\}$。\n- 考虑连接 $A$ 和 $B$ 的内部节点 $v$。如果子节点集合的交集非空，则计算 $S_v$ 为该交集；否则为并集。在这里，$S_A \\cap S_B = \\{0\\} \\cap \\{1\\} = \\varnothing$，所以交集为空。因此，分配 $S_v = S_A \\cup S_B = \\{0,1\\}$，并因此节点处的交集为空而将简约步数加 $1$。\n- 考虑连接 $v$ 和 $C$ 的根节点 $r$。我们有 $S_v=\\{0,1\\}$ 和 $S_C=\\{1\\}$。交集为 $S_v \\cap S_C = \\{0,1\\} \\cap \\{1\\} = \\{1\\}$，非空。因此，分配 $S_r=\\{1\\}$ 并且不在此节点增加步数。\n\n上行遍历得出的祖先状态集为 $S_v=\\{0,1\\}$ 和 $S_r=\\{1\\}$。从空交集累积的变化的最小总数为 $1$。\n\n下行遍历（前序）以实现一种最小分配并验证步数：\n- 从 $S_r$ 中为根节点选择任意状态；这里 $S_r=\\{1\\}$，所以将根节点设为 $1$。\n- 对于子节点 $v$（其状态集为 $S_v=\\{0,1\\}$），选择一个能最小化沿边 $(r,v)$ 的变化的状态。在节点 $v$ 处选择状态 $1$ 与父节点匹配，在边 $(r,v)$ 上产生 $0$ 次变化。\n- 向下传播到叶节点：从 $v=1$到 $B=1$ 在边 $(v,B)$ 上无变化；从 $v=1$ 到 $A=0$ 在边 $(v,A)$ 上有一次变化。\n\n这种显式分配恰好实现 $1$ 次变化，与上行遍历的计数相符。根据简约法准则和 Fitch 算法，这是可能的变化的最小数量。\n\n因此，内部节点的祖先状态集为 $S_v=\\{0,1\\}$ 和 $S_r=\\{1\\}$，且变化的最小总数为 $1$。", "answer": "$$\\boxed{1}$$", "id": "2545589"}, {"introduction": "与简约法不同，基于模型的系统发育比较方法将进化过程视为一个随机过程，从而能够利用分支长度信息并量化重建结果的不确定性。对于体型、骨骼长度等连续性状，布朗运动（Brownian motion）是一个核心的基准模型，它假设性状的变化是随机且无方向的。这个练习[@problem_id:2545572]将指导你从第一性原理出发，在一个给定的系统发育树和末端物种性状值的条件下，推导内部节点性状的最大似然估计及其方差。这不仅能让你掌握布朗运动模型的应用，还能加深对系统发育信号和广义最小二乘法（GLS）在比较方法中作用的理解。", "problem": "考虑一个连续性状，它在一个具有拓扑结构 `((A:1, B:1):1, C:2)` 的有根系统发育树上，遵循布朗运动模型进行演化。在布朗运动模型下，以父节点状态为条件，沿着长度为 $t$ 的分支的变化服从均值为 $0$、方差为 $\\sigma^{2} t$ 的高斯分布，并且不同分支上的变化是相互独立的。假设根节点状态的先验是平坦的（非正常均匀分布），因此所有节点状态的联合分布是通过复合这些高斯增量得到的，而没有在根节点引入额外信息。观测到的叶节点性状值为 $A=2.0$、$B=3.0$ 和 $C=5.0$，扩散速率为 $\\sigma^{2}=1$。\n\n仅使用所述的布朗运动假设、多元高斯分布的性质以及树上的条件独立性，从第一性原理出发，推导 $A$ 和 $B$ 的最近共同祖先这一内部节点的祖先性状的最大似然估计（等价于在平坦根节点先验下的后验均值）及其相关的条件方差。请将您的最终答案表示为精确的有理数，不要四舍五入，并按顺序将估计值和方差一并作为一个单行向量提供。不需要单位。", "solution": "我们将节点表示如下：$A$、$B$、$C$ 为叶节点，$D$ 为 $A$ 和 $B$ 的最近共同祖先（MRCA），$R$ 为树的根节点。这些节点上的状态分别为 $x_A$、$x_B$、$x_C$、$x_D$ 和 $x_R$。观测到的叶节点数据为 $x_A=2$、$x_B=3$ 和 $x_C=5$。扩散速率为 $\\sigma^2=1$。\n\n此问题可以使用系统发育数据的广义最小二乘法（GLS）框架来解决。观测到的叶节点状态向量，$X = \\begin{pmatrix} x_A & x_B & x_C \\end{pmatrix}^T = \\begin{pmatrix} 2 & 3 & 5 \\end{pmatrix}^T$，服从多元正态分布。在一个具有固定根节点状态 $x_R$ 的布朗运动模型下，叶节点状态的期望值为 $\\mathbb{E}[X] = x_R \\mathbf{1}$，其中 $\\mathbf{1}$ 是一个全为1的列向量。假设根节点具有平坦先验等同于从数据中估计 $x_R$。\n\n首先，我们必须构建系统发育方差-协方差矩阵 $V$。元素 $V_{ij}$ 是扩散速率 $\\sigma^2$ 与从根节点到叶节点 $i$ 和 $j$ 的最近共同祖先的共享路径长度的乘积。给定树 `((A:1, B:1):1, C:2)`，根节点 $R$ 位于时间 $0$。节点 $D$ 位于时间 $t_{RD}=1$。叶节点 $A$ 和 $B$ 位于时间 $1+1=2$，叶节点 $C$ 位于时间 $2$。\n$V$ 的元素是：\n$V_{AA} = \\sigma^2 \\times (\\text{从根到A的时间}) = 1 \\times (t_{RD} + t_{DA}) = 1 \\times (1+1) = 2$。\n$V_{BB} = \\sigma^2 \\times (\\text{从根到B的时间}) = 1 \\times (t_{RD} + t_{DB}) = 1 \\times (1+1) = 2$。\n$V_{CC} = \\sigma^2 \\times (\\text{从根到C的时间}) = 1 \\times t_{RC} = 1 \\times 2 = 2$。\n$V_{AB} = \\sigma^2 \\times (\\text{从根到MRCA}(A,B)\\text{的时间}) = 1 \\times (\\text{节点D的时间}) = 1 \\times 1 = 1$。\n$V_{AC} = \\sigma^2 \\times (\\text{从根到MRCA}(A,C)\\text{的时间}) = 1 \\times (\\text{节点R的时间}) = 1 \\times 0 = 0$。\n$V_{BC} = \\sigma^2 \\times (\\text{从根到MRCA}(B,C)\\text{的时间}) = 1 \\times (\\text{节点R的时间}) = 1 \\times 0 = 0$。\n\n因此，矩阵 $V$ 为：\n$$V = \\begin{pmatrix} 2 & 1 & 0 \\\\ 1 & 2 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix}$$\n接下来，我们求逆矩阵 $V^{-1}$。该矩阵是块对角矩阵。\n左上角 $2 \\times 2$ 块 $\\begin{pmatrix} 2 & 1 \\\\ 1 & 2 \\end{pmatrix}$ 的逆矩阵是 $\\frac{1}{2 \\cdot 2 - 1 \\cdot 1} \\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix} = \\frac{1}{3}\\begin{pmatrix} 2 & -1 \\\\ -1 & 2 \\end{pmatrix}$。\n右下角 $1 \\times 1$ 块 $[2]$ 的逆矩阵是 $[1/2]$。\n所以，\n$$V^{-1} = \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix}$$\n给定叶节点数据 $X$，祖先状态 $x_i$ 的后验均值（等同于最大似然估计）由以下公式给出：\n$$\\hat{x}_i = \\hat{x}_R + \\mathbf{c}_i^T V^{-1}(X - \\hat{x}_R \\mathbf{1})$$\n其中 $\\hat{x}_R$ 是根节点状态的GLS估计值，$\\mathbf{c}_i$ 是节点 $i$ 与叶节点之间的协方差向量。\n根节点状态的GLS估计值为：\n$$\\hat{x}_R = \\frac{\\mathbf{1}^T V^{-1} X}{\\mathbf{1}^T V^{-1} \\mathbf{1}}$$\n我们计算各个组成部分：\n$\\mathbf{1}^T V^{-1} = \\begin{pmatrix} 1 & 1 & 1 \\end{pmatrix} \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix}$。\n$\\mathbf{1}^T V^{-1} \\mathbf{1} = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 1 \\end{pmatrix} = 1/3 + 1/3 + 1/2 = 2/3 + 1/2 = 7/6$。\n$\\mathbf{1}^T V^{-1} X = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 2 \\\\ 3 \\\\ 5 \\end{pmatrix} = 2/3 + 3/3 + 5/2 = 2/3 + 1 + 5/2 = 4/6 + 6/6 + 15/6 = 25/6$。\n所以，$\\hat{x}_R = \\frac{25/6}{7/6} = 25/7$。\n\n现在，我们求解节点 $D$ 的估计值 $\\hat{x}_D$。我们需要节点 $D$ 与叶节点 $A,B,C$ 之间的协方差向量 $\\mathbf{c}_D$：\n$c_{DA} = \\sigma^2 \\times (\\text{从根到MRCA(D,A)=D的时间}) = 1 \\times 1 = 1$。\n$c_{DB} = \\sigma^2 \\times (\\text{从根到MRCA(D,B)=D的时间}) = 1 \\times 1 = 1$。\n$c_{DC} = \\sigma^2 \\times (\\text{从根到MRCA(D,C)=R的时间}) = 1 \\times 0 = 0$。\n所以，$\\mathbf{c}_D = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix}^T$。\n\n我们计算 $\\mathbf{c}_D^T V^{-1}$ 项：\n$\\mathbf{c}_D^T V^{-1} = \\begin{pmatrix} 1 & 1 & 0 \\end{pmatrix} \\begin{pmatrix} 2/3 & -1/3 & 0 \\\\ -1/3 & 2/3 & 0 \\\\ 0 & 0 & 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix}$。\n校正项为 $\\mathbf{c}_D^T V^{-1}(X - \\hat{x}_R \\mathbf{1})$：\n$X - \\hat{x}_R \\mathbf{1} = \\begin{pmatrix} 2 \\\\ 3 \\\\ 5 \\end{pmatrix} - \\frac{25}{7}\\begin{pmatrix} 1 \\\\ 1 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 14/7 - 25/7 \\\\ 21/7 - 25/7 \\\\ 35/7 - 25/7 \\end{pmatrix} = \\begin{pmatrix} -11/7 \\\\ -4/7 \\\\ 10/7 \\end{pmatrix}$。\n$\\mathbf{c}_D^T V^{-1}(X - \\hat{x}_R \\mathbf{1}) = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix} \\begin{pmatrix} -11/7 \\\\ -4/7 \\\\ 10/7 \\end{pmatrix} = -\\frac{11}{21} - \\frac{4}{21} = -\\frac{15}{21} = -\\frac{5}{7}$。\n最后，$\\hat{x}_D = \\hat{x}_R - 5/7 = 25/7 - 5/7 = 20/7$。\n\n接下来，我们计算 $x_D$ 估计的条件方差。公式为：\n$$\\text{Var}(x_D | X) = \\sigma^2 T_D - \\mathbf{c}_D^T V^{-1} \\mathbf{c}_D + \\frac{(1 - \\mathbf{1}^T V^{-1} \\mathbf{c}_D)^2}{\\mathbf{1}^T V^{-1} \\mathbf{1}}$$\n这里，$T_D$ 是从根节点到节点 $D$ 的时间，为 $1$。所以 $\\sigma^2 T_D = 1$。\n我们计算新的项：\n$\\mathbf{c}_D^T V^{-1} \\mathbf{c}_D = \\begin{pmatrix} 1/3 & 1/3 & 0 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\end{pmatrix} = 1/3 + 1/3 = 2/3$。\n$\\mathbf{1}^T V^{-1} \\mathbf{c}_D = \\begin{pmatrix} 1/3 & 1/3 & 1/2 \\end{pmatrix} \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\end{pmatrix} = 1/3 + 1/3 = 2/3$。\n最后一项的分子是 $(1 - 2/3)^2 = (1/3)^2 = 1/9$。\n分母是 $\\mathbf{1}^T V^{-1} \\mathbf{1} = 7/6$。\n将它们组合起来：\n$\\text{Var}(x_D | X) = 1 - 2/3 + \\frac{1/9}{7/6} = 1/3 + \\frac{1}{9} \\cdot \\frac{6}{7} = 1/3 + \\frac{2}{21} = \\frac{7}{21} + \\frac{2}{21} = \\frac{9}{21} = \\frac{3}{7}$。\n\n节点 $D$ 状态的最大似然估计为 $20/7$，其条件方差为 $3/7$。", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{20}{7} & \\frac{3}{7} \\end{pmatrix}}$$", "id": "2545572"}, {"introduction": "在采用基于模型的祖先状态重建方法时，一个关键步骤是选择一个能够恰当描述数据背后进化过程的模型。不同的模型代表了不同的进化假设（例如，性状获得和丢失的速率是否对称）。似然比检验（Likelihood Ratio Test, LRT）是比较嵌套模型拟合优度的标准统计工具，它使我们能量化一个更复杂的模型是否比一个更简单的模型提供了显著更好的解释。在此练习[@problem_id:2545588]中，你将利用已有的最大似然值，对一个对称进化模型（$M_{0}$）和一个非对称模型（$M_{1}$）进行比较，计算检验统计量并确定其零分布。这个实践将使你熟悉在系统发育背景下进行模型选择和假设检验的基本流程。", "problem": "一个二元性状在一个固定的、超度量系统发育树上，根据瞬时速率矩阵为 $Q$ 的连续时间马尔可夫链演化，且叶尖状态的观测没有误差。考虑一对嵌套模型：对称模型 $M_{0}$，其中 $q_{01} = q_{10}$；以及非对称模型 $M_{1}$，其中 $q_{01} \\neq q_{10}$。假设根节点的状态频率由 $Q$ 所蕴含的平稳分布给出，并且似然值是通过使用 Felsenstein 的剪枝递归算法对所有可能的祖先状态求和来精确计算的。\n\n给定一个包含五个分类单元的有根系统发育树及其枝长（单位为任意时间单位）：`((A:0.40,B:0.40):0.20,(C:0.30,(D:0.20,E:0.20):0.10):0.30);` 观测到的叶尖状态为 $A=0$, $B=1$, $C=0$, $D=1$, $E=1$。在 $M_{0}$ 和 $M_{1}$ 模型下进行最大似然优化，得到以下最大化对数似然值：$M_{0}$ 模型为 $\\widehat{\\ell}_{0} = -29.842$，$M_{1}$ 模型为 $\\widehat{\\ell}_{1} = -27.314$。相应的速率参数的最大似然估计值为：$M_{0}$ 模型为 $\\widehat{q} = 0.73$，$M_{1}$ 模型为 $(\\widehat{q}_{01}, \\widehat{q}_{10}) = (1.10, 0.42)$。\n\n仅使用树上连续时间马尔可夫过程似然的基本定义和嵌套模型的标准大样本似然理论，构建用于比较 $M_{0}$ 与 $M_{1}$ 的似然比检验。在正则性条件下，确定检验统计量的近似零分布，并计算检验统计量 $2\\Delta \\ell$ 的数值。将 $2\\Delta \\ell$ 的最终数值答案四舍五入到四位有效数字。", "solution": "该问题要求构建一个似然比检验来比较两种嵌套的性状演化模型，确定检验统计量的零分布，并计算其值。\n\n所考虑的两个模型描述了一个二元性状（$0$ 或 $1$）沿系统发育树作为一个连续时间马尔可夫过程的演化。\n零模型 $M_{0}$ 是一个对称模型，其中从状态 $0$ 变为状态 $1$ 的速率 $q_{01}$ 等于从状态 $1$ 变为状态 $0$ 的速率 $q_{10}$。我们可以定义一个单一速率参数 $q = q_{01} = q_{10}$。该模型的自由速率参数数量为 $k_{0} = 1$。此模型的瞬时速率矩阵 $Q$ 为：\n$$\nQ = \\begin{pmatrix} -q & q \\\\ q & -q \\end{pmatrix}\n$$\n\n备择模型 $M_{1}$ 是一个非对称模型，其中两个速率可以不同，即 $q_{01} \\neq q_{10}$。该模型有两个自由速率参数，$q_{01}$ 和 $q_{10}$。该模型的自由参数数量为 $k_{1} = 2$。此模型的瞬时速率矩阵 $Q$ 为：\n$$\nQ = \\begin{pmatrix} -q_{01} & q_{01} \\\\ q_{10} & -q_{10} \\end{pmatrix}\n$$\n\n模型 $M_{0}$ 是模型 $M_{1}$ 在施加约束 $q_{01} = q_{10}$ 时的特例。因此，这两个模型是嵌套的，这是应用似然比检验（LRT）的前提条件。\n\n似然比检验统计量，此处表示为 $2\\Delta \\ell$，定义为更复杂的（备择）模型的最大化对数似然与更简单的（零）模型的最大化对数似然之差的两倍。\n设 $L_{0}$ 为模型 $M_{0}$ 下的最大似然值，$L_{1}$ 为模型 $M_{1}$ 下的最大似然值。对数似然值分别为 $\\widehat{\\ell}_{0} = \\ln(L_{0})$ 和 $\\widehat{\\ell}_{1} = \\ln(L_{1})$。检验统计量由下式给出：\n$$\n2\\Delta \\ell = 2(\\widehat{\\ell}_{1} - \\widehat{\\ell}_{0}) = 2 \\ln \\left(\\frac{L_{1}}{L_{0}}\\right)\n$$\n由于 $M_{1}$ 比 $M_{0}$ 的约束更少，它对数据的拟合程度总是至少一样好，这意味着 $\\widehat{\\ell}_{1} \\ge \\widehat{\\ell}_{0}$，因此 $2\\Delta \\ell \\ge 0$。\n\n根据 Wilks 定理，对于大样本且在某些正则性条件下（通常假定这些条件对此类系统发育模型成立），LRT 统计量在零假设（$H_{0}$：$M_{0}$ 是真实模型）下的分布渐近趋近于卡方（$\\chi^2$）分布。该分布的自由度（$df$）等于备择模型和零模型之间自由参数数量的差异：\n$$\ndf = k_1 - k_0\n$$\n在此问题中，$M_{1}$ 的参数数量为 $k_1=2$（对应于 $q_{01}$ 和 $q_{10}$），$M_{0}$ 的参数数量为 $k_0=1$（对应于 $q$）。因此，自由度为：\n$$\ndf = 2 - 1 = 1\n$$\n因此，检验统计量 $2\\Delta \\ell$ 的近似零分布是自由度为 $1$ 的卡方分布，记为 $\\chi^2_1$。\n\n我们从分析中得知了最大化对数似然值：\n- 零模型 $M_{0}$：$\\widehat{\\ell}_{0} = -29.842$\n- 备择模型 $M_{1}$：$\\widehat{\\ell}_{1} = -27.314$\n\n现在我们可以计算检验统计量 $2\\Delta \\ell$ 的数值：\n$$\n2\\Delta \\ell = 2(\\widehat{\\ell}_{1} - \\widehat{\\ell}_{0}) = 2(-27.314 - (-29.842))\n$$\n$$\n2\\Delta \\ell = 2(-27.314 + 29.842)\n$$\n$$\n2\\Delta \\ell = 2(2.528)\n$$\n$$\n2\\Delta \\ell = 5.056\n$$\n问题要求将答案四舍五入到四位有效数字。计算出的值 $5.056$ 已经有四位有效数字。\n所提供的关于特定系统发育树、枝长、叶尖状态以及速率参数的最大似然估计值 $(\\widehat{q}=0.73, (\\widehat{q}_{01}, \\widehat{q}_{10}) = (1.10, 0.42))$ 对于建立问题的背景和有效性至关重要，但最终计算仅需最大化对数似然值。", "answer": "$$\n\\boxed{5.056}\n$$", "id": "2545588"}]}