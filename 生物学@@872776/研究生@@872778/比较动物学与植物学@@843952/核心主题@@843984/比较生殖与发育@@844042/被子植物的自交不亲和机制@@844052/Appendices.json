{"hands_on_practices": [{"introduction": "要量化理解自交不亲和性（SI）的群体遗传学效应，我们必须首先掌握其最基本的概率规则。这个练习将指导你计算在一个给定的花粉环境中，一个特定母本植物能够接受的花粉比例。这是一个基础但至关重要的步骤，它将基因识别的分子规则转化为可用于预测交配结果的数学语言。[@problem_id:2609412]", "problem": "在许多被子植物中，配子体自交不亲和性（GSI）由一个多等位基因座（$S$基因座）控制，其中每个花粉粒表达其单倍体$S$等位基因，而雌蕊会拒绝任何其$S$等位基因与母体花柱中存在的两个$S$等位基因之一相匹配的花粉。假设在一个大种群中，有$k$个同等有效的$S$等位基因在分离（无显性关系，所有等位基因对称地强制执行不亲和性）。一个目标母本植株具有二倍体$S$基因型$S_{a}/S_{b}$，其中$a \\neq b$。该植株接收到一个大的混合花粉云，其$S$等位基因组成由等位基因频率向量$\\mathbf{p} = (p_{1}, p_{2}, \\ldots, p_{k})$表征，其中$\\sum_{i=1}^{k} p_{i} = 1$。假设：\n- 花粉粒独立到达，其$S$等位基因根据$\\mathbf{p}$分布。\n- 亲和性完全由经典GSI规则确定：一个携带等位基因$S_{i}$的花粉粒当且仅当$i \\notin \\{a,b\\}$时被拒绝；否则被接受。\n- 所有亲和的花粉粒有同等机会完成受精，且不发生亲和后偏好。\n\n从GSI的核心定义和概率公理出发，推导一个闭式表达式，用于计算到达该目标植株的花粉中亲和花粉粒的期望比例，该表达式应以$\\mathbf{p}$和索引$a$、$b$表示。您的最终答案必须是单一的解析表达式。", "solution": "该问题陈述被评估为有效。它具有科学依据，定义明确，客观，并包含推导唯一解所需的所有必要信息。所描述的模型是群体遗传学中配子体自交不亲和性（GSI）的标准表示。\n\n任务是找到到达基因型为$S_{a}/S_{b}$（其中$a \\neq b$）的目标母本植株的亲和花粉粒的期望比例。花粉云的特征是$k$个不同$S$等位基因的频率向量$\\mathbf{p} = (p_{1}, p_{2}, \\ldots, p_{k})$，其中$p_{i}$是$S_{i}$等位基因的频率，且$\\sum_{i=1}^{k} p_{i} = 1$。\n\n让我们考虑一个到达目标植株柱头的单个花粉粒。该花粉粒携带的$S$等位基因的身份是一个随机变量。可能的等位基因的样本空间为$\\{S_{1}, S_{2}, \\ldots, S_{k}\\}$。根据问题陈述，一个随机选择的花粉粒携带等位基因$S_{i}$的概率由其在花粉云中的频率$p_{i}$给出。\n\nGSI的亲和性规则有明确说明：一个携带等位基因$S_{i}$的花粉粒是亲和的，当且仅当其等位基因与母本二倍体花柱中存在的两个等位基因都不匹配。对于基因型为$S_{a}/S_{b}$的母本植株，这意味着一个携带等位基因$S_{i}$的花粉粒是亲和的，当且仅当$i \\notin \\{a, b\\}$。\n\n设$C$为单个随机选中的花粉粒是亲和的事件。我们需要找到亲和花粉的期望比例，根据大数定律，对于一个大的花粉云，这等价于该事件的概率$P(C)$。\n\n我们可以通过考虑其互补事件$C'$来计算$P(C)$，即花粉粒不亲和的事件。如果一个花粉粒的$S$等位基因与母本的等位基因之一相匹配，则它是不亲和的。这意味着携带等位基因$S_{i}$的花粉粒在$i \\in \\{a, b\\}$时是不亲和的。\n\n事件$C'$对应于花粉粒携带等位基因$S_{a}$或$S_{b}$。由于单个花粉粒是单倍体，只能携带一个$S$等位基因，因此携带$S_{a}$和携带$S_{b}$的事件是互斥的。所以，花粉不亲和的概率是这两个事件概率的总和：\n$$P(C') = P(\\text{pollen is } S_{a}) + P(\\text{pollen is } S_{b})$$\n根据问题定义，遇到携带等位基因$S_{a}$和$S_{b}$的花粉的概率分别是它们在花粉云中的频率$p_{a}$和$p_{b}$。\n$$P(C') = p_{a} + p_{b}$$\n亲和事件$C$是不亲和事件$C'$的补集。互补事件的概率之和必须为1。\n$$P(C) + P(C') = 1$$\n因此，一个花粉粒是亲和的概率为：\n$$P(C) = 1 - P(C')$$\n代入$P(C')$的表达式，我们得到：\n$$P(C) = 1 - (p_{a} + p_{b})$$\n该表达式可以写作：\n$$P(C) = 1 - p_{a} - p_{b}$$\n这个概率代表了来自花粉云的花粉粒中将与$S_{a}/S_{b}$母本植株亲和的期望比例。这就是所要求的闭式表达式。\n\n或者，我们也可以通过直接对所有亲和结果的概率求和来得到相同的结果。亲和的等位基因是所有满足$i \\in \\{1, 2, \\ldots, k\\} \\setminus \\{a, b\\}$的等位基因$S_{i}$。亲和的概率是所有这些亲和等位基因频率的总和：\n$$P(C) = \\sum_{i \\in \\{1, 2, \\ldots, k\\} \\setminus \\{a, b\\}} p_{i}$$\n我们知道所有等位基因频率的总和为1：\n$$\\sum_{i=1}^{k} p_{i} = 1$$\n这个总和可以分割为亲和等位基因的频率之和与不亲和等位基因的频率之和：\n$$\\left( \\sum_{i \\in \\{1, 2, \\ldots, k\\} \\setminus \\{a, b\\}} p_{i} \\right) + \\left( \\sum_{i \\in \\{a, b\\}} p_{i} \\right) = 1$$\n由于$a \\neq b$，不亲和等位基因的频率之和就是$p_{a} + p_{b}$。所以，\n$$P(C) + (p_{a} + p_{b}) = 1$$\n整理这个方程，得到与之前相同的结果：\n$$P(C) = 1 - p_{a} - p_{b}$$\n这是亲和花粉期望比例的最终解析表达式。正如所要求，它仅取决于母本植株中存在的两个特定$S$等位基因的频率。", "answer": "$$\\boxed{1 - p_{a} - p_{b}}$$", "id": "2609412"}, {"introduction": "在自然界中，生物系统很少是完美的，“渗漏”或部分自交不亲和性是理解SI系统演化和崩溃的关键概念。这个练习让你能够量化这种渗漏性对植物繁殖成功率（适应度）的影响，通过直接比较在完全和部分SI机制下预期的种子产量。这种计算对于评估不同交配策略的进化优势至关重要。[@problem_id:2609421]", "problem": "被子植物的自交不亲和性（Self-incompatibility, SI）是一种遗传控制的障碍，它通过排斥自体花粉来阻止自花受精。考虑一个雌雄同体的被子植物物种，在单次传粉事件中，一朵花上接收了混合的花粉负载。这朵花有 $N$ 个胚珠。在单次访问中，总共有 $P$ 粒花粉落在柱头上。花粉粒中的一部分比例 $f_{s}$ 是自体花粉，剩余的比例 $1 - f_{s}$ 是非自体（亲和）花粉。每一粒落在柱头上的亲和花粉，在有可用胚珠的情况下，能独立成功受精并发育成有活力的种子的概率为 $p$。假设在下面计算的预期成功受精数的规模上，胚珠不是限制因素；如果您计算的期望值超过 $N$，则将预期种子数上限设为 $N$。\n\n考虑两种SI机制：\n- 完全SI：自体花粉从不亲和，因此从不贡献于结籽。\n- 具有渗漏性的部分SI：一个渗漏参数 $\\ell \\in [0,1]$ 乘以自体花粉的单粒成功率，使得自体花粉的单粒成功概率为 $\\ell p$，而非自体花粉的单粒成功概率保持为 $p$。\n\n给定参数值 $N = 100$，$P = 80$，$f_{s} = 0.6$，$p = 0.3$，以及 $\\ell = 0.2$：\n- 计算完全SI下的预期结籽数。\n- 计算在指定渗漏性 $\\ell$ 下的部分SI的预期结籽数。\n- 将倍数变化 $R$ 定义为部分SI下的预期结籽数与完全SI下的预期结籽数之比，并计算 $R$。\n\n以单一数字 $R$ 作为您的最终答案。如果您计算的 $R$ 不是一个精确的有限小数，则四舍五入到四位有效数字。报告 $R$ 时不带任何单位。", "solution": "首先必须严格验证问题陈述。\n\n步骤1：提取已知条件。\n明确的数据和条件如下：\n- 花中的胚珠数量：$N = 100$。\n- 沉积的花粉粒总数：$P = 80$。\n- 花粉负载中自体花粉的比例：$f_{s} = 0.6$。\n- 亲和（非自体）花粉的单粒成功概率：$p = 0.3$。\n- 部分自交不亲和性（SI）的渗漏参数：$\\ell = 0.2$。\n- 完全SI的定义：自体花粉的成功概率为 $0$。\n- 部分SI的定义：自体花粉的成功概率为 $\\ell p$。非自体花粉的成功概率保持为 $p$。\n- 关于胚珠的假设：胚珠不是限制因素，但如果计算出的预期种子数超过 $N$，则期望值上限为 $N$。\n- 任务：计算完全SI下的预期结籽数、部分SI下的预期结籽数以及它们的比率 $R$。\n\n步骤2：使用提取的已知条件进行验证。\n根据所需标准对问题进行评估：\n- **科学依据：**该问题基于已确立的被子植物自交不亲和性的生物学现象。该模型虽然是一种简化，但使用了群体遗传学和进化生态学中常见的标准概率推理。花粉竞争、花粉限制和“渗漏性”SI系统的概念在科学上是有效的。\n- **良构性：**该问题定义明确。计算所需的所有参数（$N, P, f_{s}, p, \\ell$）都已提供。目标陈述清晰。处理胚珠限制的规则虽然是简化，但是明确的。可以推导出一个唯一、稳定且有意义的解。\n- **客观性：**该问题以精确、定量和无偏见的语言表述。\n\n该问题没有违反任何指定的无效标准。它在科学上是合理的、可形式化的、完整的和良构的。\n\n步骤3：结论与行动。\n该问题被判定为**有效**。将推导解答。\n\n问题的核心是计算两种不同自交不亲和性机制下成功受精（种子）的预期数量。该期望值是根据每种类型（自体和非自体）花粉的数量及其各自的成功概率计算的。期望的线性性质允许我们将每种花粉类型的预期贡献相加。\n\n首先，让我们确定自体和非自体花粉的数量。\n花粉粒总数为 $P = 80$。\n自体花粉粒的数量 $P_{s}$ 由总数的一部分比例 $f_{s}$ 给出：\n$$P_{s} = P \\times f_{s} = 80 \\times 0.6 = 48$$\n非自体（亲和）花粉粒的数量 $P_{ns}$ 是剩余部分：\n$$P_{ns} = P \\times (1 - f_{s}) = 80 \\times (1 - 0.6) = 80 \\times 0.4 = 32$$\n\n接下来，我们将计算每种SI机制的预期结籽数。\n\n**1. 完全SI下的预期结籽数 ($E_{comp}$)**\n在完全SI下，自体花粉完全没有功能。\n- 单个自体花粉粒的成功概率为 $0$。\n- 单个非自体花粉粒的成功概率为 $p = 0.3$。\n\n来自自体花粉的预期种子数是 $P_{s} \\times 0 = 0$。\n来自非自体花粉的预期种子数是非自体花粉粒数乘以其成功概率：\n$$E_{ns, comp} = P_{ns} \\times p = 32 \\times 0.3 = 9.6$$\n完全SI下的总预期结籽数 $E_{comp}$ 是期望值的总和：\n$$E_{comp} = (P_{s} \\times 0) + (P_{ns} \\times p) = P(1 - f_{s})p = 0 + 9.6 = 9.6$$\n我们必须对照胚珠限制 $N = 100$ 进行检查。由于 $9.6  100$，不应用上限。\n因此，$E_{comp} = 9.6$。\n\n**2. 部分SI下的预期结籽数 ($E_{part}$)**\n在具有渗漏性 $\\ell$ 的部分SI下，自体花粉的成功概率降低但非零。\n- 单个自体花粉粒的成功概率为 $\\ell p = 0.2 \\times 0.3 = 0.06$。\n- 单个非自体花粉粒的成功概率保持为 $p = 0.3$。\n\n来自自体花粉的预期种子数是：\n$$E_{s, part} = P_{s} \\times (\\ell p) = 48 \\times 0.06 = 2.88$$\n来自非自体花粉的预期种子数是：\n$$E_{ns, part} = P_{ns} \\times p = 32 \\times 0.3 = 9.6$$\n部分SI下的总预期结籽数 $E_{part}$ 是这些贡献的总和：\n$$E_{part} = E_{s, part} + E_{ns, part} = (P_{s} \\ell p) + (P_{ns} p) = P f_{s} \\ell p + P(1-f_{s})p$$\n$$E_{part} = 2.88 + 9.6 = 12.48$$\n我们必须再次对照胚珠限制 $N = 100$ 进行检查。由于 $12.48  100$，不应用上限。\n因此，$E_{part} = 12.48$。\n\n**3. 倍数变化比率 ($R$)**\n倍数变化 $R$ 定义为部分SI下的预期结籽数与完全SI下的预期结籽数之比。\n$$R = \\frac{E_{part}}{E_{comp}}$$\n使用计算出的值：\n$$R = \\frac{12.48}{9.6} = 1.3$$\n\n或者，我们可以推导 $R$ 的符号表达式：\n$$R = \\frac{P f_{s} \\ell p + P(1-f_{s})p}{P(1-f_{s})p} = \\frac{P p [f_{s} \\ell + (1-f_{s})]}{P p (1-f_{s})} = \\frac{f_{s} \\ell + 1 - f_{s}}{1 - f_{s}} = 1 + \\frac{f_{s} \\ell}{1 - f_{s}}$$\n将给定参数代入此简化表达式中：\n$$R = 1 + \\frac{0.6 \\times 0.2}{1 - 0.6} = 1 + \\frac{0.12}{0.4} = 1 + 0.3 = 1.3$$\n结果是一致的。值 $1.3$ 是一个精确的有限小数，因此根据问题说明，不需要四舍五入。\n最终答案是单一数字 $R$。", "answer": "$$\n\\boxed{1.3}\n$$", "id": "2609421"}, {"introduction": "真实的植物种群在空间上并非均匀分布，花粉的传播也受到距离的限制。这个高级练习将SI的遗传规则与生态学现实（如植物密度和花粉传播距离）结合起来。通过构建一个空间显式模拟模型，你将探索这些因素如何相互作用，共同决定整个种群的繁殖成功率——这是一个通常难以用简单解析模型解决的复杂问题。[@problem_id:2609415]", "problem": "要求您设计并实现一个在二维周期性晶格上的自交不亲和被子植物种群的空间显式模拟，并计算在指定参数下种群的单株平均结实率。该模拟必须基于以下基础且经过充分检验的建模假设，不得另行创建额外的简化公式。\n\n定义与假设：\n1. 种群占据一个边长为 $L$ 的二维环面（周期性正方形），该环面被离散化为 $L \\times L$ 个晶格单元。一小部分比例 $\\rho$ 的单元格被一株雌雄同株的植物占据，因此植物数量为 $n = \\mathrm{round}(\\rho L^2)$。被占据的单元格是从所有单元格中均匀随机抽样且不放回选出的。\n2. 繁殖系统遵循配子体自交不亲和性（GSI）。种群中有 $k$ 个共显性的 $S$-等位基因。每株植物在 $S$-基因座上是二倍体，并携带两个从 $\\{0,1,\\dots,k-1\\}$ 中均匀随机抽样且不放回选出的不同等位基因。自花花粉总是不亲和的。对于供体植物 $j$ 和受体植物 $i$，设 $S_i$ 和 $S_j$ 分别表示它们各自的两个 $S$-等位基因集合。来自 $j$ 的花粉在 $i$ 上亲和的比例为 $f_{ij} = 1 - \\frac{|S_i \\cap S_j|}{2}$，这反映了GSI规则：携带与任何母本等位基因相同的 $S$-等位基因的花粉粒将被拒绝。\n3. 在有效授粉窗口期内，每株植物产生 $P$ 粒花粉。花粉传播遵循平面上的各向同性高斯核，其标准差为 $\\sigma$，由下式给出：\n$$\nK(d) = \\frac{1}{2\\pi \\sigma^2} \\exp\\left(-\\frac{d^2}{2\\sigma^2}\\right),\n$$\n其中 $d$ 是环面上供体和受体之间的最短欧几里得距离。一个固定的捕获系数 $c$ 将核密度转换为柱头上的期望到达率，因此植物 $i$ 的期望亲和花粉到达率为：\n$$\n\\lambda_i = c \\sum_{j \\neq i} P \\, K(d_{ij}) \\, f_{ij}.\n$$\n环面上的距离必须使用最小镜像约定：对于坐标 $(x_i,y_i)$ 和 $(x_j,y_j)$（均在 $\\{0,1,\\dots,L-1\\}$ 内），$\\Delta_x = \\min(|x_i - x_j|, L - |x_i - x_j|)$，$\\Delta_y$ 同理，则 $d_{ij} = \\sqrt{\\Delta_x^2 + \\Delta_y^2}$。\n4. 每株植物的花粉到达过程被建模为均值为 $\\lambda_i$ 的泊松过程。每株植物有 $O$ 个胚珠。植物 $i$ 产生的种子数量为随机变量 $\\min(O, X_i)$，其中 $X_i \\sim \\mathrm{Poisson}(\\lambda_i)$。要求计算的量是期望单株平均结实率，定义为所有植物的 $\\mathbb{E}[\\min(O, X_i)]$ 的平均值。此期望值必须根据泊松分布精确计算，而不是通过蒙特卡洛抽样。\n\n需实现的任务：\na) 构建晶格，将 $n$ 株植物均匀随机地放置在不同的单元格上，并按照上述规定分配 $S$-基因型。\nb) 计算所有成对的环面距离 $d_{ij}$、核权重 $K(d_{ij})$、亲和度分数 $f_{ij}$ 以及到达率 $\\lambda_i$。\nc) 对每株植物 $i$，使用恒等式计算 $\\mathbb{E}[\\min(O, X_i)]$，其中 $X_i \\sim \\mathrm{Poisson}(\\lambda_i)$：\n$$\n\\mathbb{E}[\\min(O,X_i)] = \\sum_{x=0}^{O-1} x \\, \\Pr[X_i = x] + O \\, \\Pr[X_i \\ge O],\n$$\n计算中需使用泊松概率质量函数和累积分布函数。\nd) 针对每个测试用例，报告种群的单株平均结实率，结果为浮点数，四舍五入到恰好 $6$ 位小数。\n\n测试集：\n为保证可复现性，请对每个用例使用给定的伪随机种子。对于所有用例，距离以晶格单位计算，不需要物理单位。对每个用例，输出一个浮点数，即上文定义的单株平均结实率，四舍五入到恰好 $6$ 位小数。\n\n- 用例 1 (通用基线)：$L = 40$, $\\rho = 0.3$, $\\sigma = 2.0$, $k = 20$, $P = 1000$, $O = 50$, $c = 1.0$, 种子 $= 1$。\n- 用例 2 (低 $S$-等位基因多样性边界)：$L = 40$, $\\rho = 0.3$, $\\sigma = 2.0$, $k = 2$, $P = 1000$, $O = 50$, $c = 1.0$, 种子 $= 1$。\n- 用例 3 (高 $S$-等位基因多样性)：$L = 40$, $\\rho = 0.3$, $\\sigma = 2.0$, $k = 100$, $P = 1000$, $O = 50$, $c = 1.0$, 种子 $= 1$。\n- 用例 4 (较高密度下的极局部传播)：$L = 40$, $\\rho = 0.5$, $\\sigma = 0.5$, $k = 20$, $P = 1000$, $O = 50$, $c = 1.0$, 种子 $= 2$。\n- 用例 5 (低密度下的广泛传播)：$L = 40$, $\\rho = 0.05$, $\\sigma = 10.0$, $k = 20$, $P = 1000$, $O = 50$, $c = 1.0$, 种子 $= 3$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,result3,result4,result5]”）。每个结果必须是对应测试用例的、四舍五入后的单株平均结实率，顺序与上文相同，表示为小数点后恰好有 $6$ 位数字的十进制数。", "solution": "我们从基本定义和经过充分检验的公式出发，推导出一个可计算的算法，用于计算空间显式晶格中配子体自交不亲和性下的期望单株平均结实率。\n\n基本原理与定义：\n1. 在配子体自交不亲和性（GSI）下，亲和性取决于单倍体花粉的 $S$-等位基因和母本的二倍体 $S$-基因型。如果供体的二倍体基因型是集合 $S_j = \\{a,b\\}$，母本基因型是 $S_i = \\{A,B\\}$，且等位基因为共显性，那么供体 $j$ 的花粉一半携带 $a$，一半携带 $b$。如果花粉粒的等位基因与 $A$ 或 $B$ 匹配，则该花粉粒被拒绝。因此，供体 $j$ 的花粉在 $i$ 上亲和的比例是 $f_{ij} = 1 - \\frac{|S_i \\cap S_j|}{2}$，其取值范围为 $\\{0, \\frac{1}{2}, 1\\}$；自花花粉有 $|S_i \\cap S_i| = 2$，因此 $f_{ii} = 0$。\n2. 花粉传播使用高斯核进行建模\n$$\nK(d) = \\frac{1}{2 \\pi \\sigma^2} \\exp\\left(-\\frac{d^2}{2 \\sigma^2}\\right),\n$$\n这是一个广泛使用的各向同性核，其在整个平面上的积分为 $1$。在边长为 $L$ 的周期性正方形上，位于 $(x_i, y_i)$ 和 $(x_j, y_j)$ 的植物之间的最短距离通过最小镜像约定计算：$\\Delta_x = \\min(|x_i - x_j|, L - |x_i - x_j|)$ 和 $\\Delta_y = \\min(|y_i - y_j|, L - |y_i - y_j|)$，从而得到 $d_{ij} = \\sqrt{\\Delta_x^2 + \\Delta_y^2}$。\n3. 将花粉到达建模为泊松过程：如果供体 $j$ 产生 $P$ 粒花粉，并且在目标柱头上的沉积量与 $K(d_{ij})$ 成正比，捕获系数为 $c$，那么植物 $i$ 上亲和花粉的期望到达率为\n$$\n\\lambda_i = c \\sum_{j \\ne i} P \\, K(d_{ij}) \\, f_{ij}.\n$$\n这种质量作用近似是授粉生态学中的标准方法，它将许多微观事件抽象为一个由距离控制的平均速率。\n4. 基于泊松到达的结实量：设 $X_i \\sim \\mathrm{Poisson}(\\lambda_i)$ 是在有效时期内到达植物 $i$ 的亲和花粉总数，并设 $O$ 为胚珠数量。因为每个亲和花粉最多能使一个胚珠受精，而最多只有 $O$ 个胚珠，所以实际的结实量是 $\\min(O, X_i)$。期望结实量使用泊松分布的概率质量函数精确计算：\n$$\n\\mathbb{E}[\\min(O, X_i)] = \\sum_{x=0}^{O-1} x \\, \\Pr[X_i = x] + O \\, \\Pr[X_i \\ge O].\n$$\n此处，$\\Pr[X_i = x] = e^{-\\lambda_i} \\lambda_i^x / x!$ 且 $\\Pr[X_i \\ge O] = 1 - F_{\\mathrm{Pois}}(O-1; \\lambda_i)$，其中 $F_{\\mathrm{Pois}}$ 是泊松分布的累积分布函数。这个恒等式是通过将结果空间划分为 $x  O$ 和 $x \\ge O$ 并使用期望的定义得出的。\n\n算法设计：\na) 种群构建：给定 $L$ 和 $\\rho$，计算 $n = \\mathrm{round}(\\rho L^2)$。从晶格中不放回地均匀抽样 $n$ 个不同的单元格，并分配坐标 $(x_i, y_i)$。对每株植物，从 $\\{0,1,\\dots,k-1\\}$ 中不放回地均匀抽样两个不同的 $S$-等位基因；这将产生具有共显性等位基因的二倍体基因型，与初始化时等位基因频率相等条件下的哈迪-温伯格(Hardy-Weinberg)比例一致。\nb) 距离与核函数：使用最小镜像约定构建成对距离矩阵。通过高斯核从 $\\sigma$ 计算矩阵 $K(d_{ij})$。这可以通过向量化的数组操作高效完成。\nc) 亲和度分数：构建一个形状为 $n \\times k$ 的二元等位基因关联矩阵 $A$，如果植物 $i$ 携带等位基因 $a$，则 $A_{i,a} = 1$，否则为 $0$。矩阵乘积 $S = A A^\\top$ 得到 $S_{ij} = |S_i \\cap S_j| \\in \\{0,1,2\\}$。然后逐元素定义 $F = 1 - \\frac{1}{2} S$，并将 $F$ 的对角线元素设置为 $0$ 以强制 $f_{ii} = 0$。\nd) 到达率：计算 $\\lambda = c \\, P \\cdot (K \\odot F) \\mathbf{1}$，其中 $\\odot$ 表示逐元素乘积，$\\mathbf{1}$ 是一个由 1 构成的 $n$ 维向量。这对每个受体执行了对所有供体的求和。\ne) 期望结实率：对于每个 $\\lambda_i$，使用上述的泊松概率质量函数和累积分布函数计算 $\\mathbb{E}[\\min(O, X_i)]$。通过堆叠 $x = 0, 1, \\dots, O-1$ 的概率，可以使用向量化评估。单株平均结实率是这些期望值在所有植物中的平均值。\nf) 可复现性：使用特定用例的种子初始化伪随机数生成器，以确保每次运行的植物位置和基因型分配完全相同。\ng) 输出：对于测试集，计算每个用例的单株平均结实率，并四舍五入到恰好 $6$ 位小数。按照指定顺序汇总结果，并以单个方括号括起来的逗号分隔列表形式打印。\n\n测试集覆盖范围：\n- 用例 1 提供了一个通用基线，具有中等密度、中等传播距离和中等 $S$-等位基因多样性 ($k = 20$) 。\n- 用例 2 将 $S$-等位基因多样性降低到 $k = 2$，用于探究许多供体不亲和、结实率受配偶可得性限制的边界情况。\n- 用例 3 将多样性增加到 $k = 100$，用于测试高配偶可得性的影响。\n- 用例 4 在较高密度下使用极局部传播 ($\\sigma = 0.5$)，以测试局部拥挤和亲和性之间的相互作用，强调邻域效应。\n- 用例 5 在低密度下使用广泛传播 ($\\sigma = 10.0$)，以探究通过远程传播来对抗稀疏邻域导致的花粉限制。\n\n该设计遵循 GSI 亲和性的核心定义、作为经过充分检验的核的高斯传播，以及带有截断计数的精确期望的泊松到达过程，从而确保了科学真实性和确定性的、可测试的计算。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import poisson\n\ndef minimum_image_distances(x, y, L):\n    # x, y are integer coordinate arrays of shape (n,)\n    # Returns pairwise distances on a torus using minimum-image convention.\n    dx = np.abs(x[:, None] - x[None, :])\n    dx = np.minimum(dx, L - dx)\n    dy = np.abs(y[:, None] - y[None, :])\n    dy = np.minimum(dy, L - dy)\n    d = np.hypot(dx, dy)\n    return d\n\ndef gaussian_kernel(distances, sigma):\n    coef = 1.0 / (2.0 * np.pi * sigma * sigma)\n    K = coef * np.exp(- (distances ** 2) / (2.0 * sigma * sigma))\n    return K\n\ndef assign_genotypes(n, k, rng):\n    # Each plant gets two distinct S-alleles\n    # Return allele incidence matrix A of shape (n, k) with 0/1 entries\n    A = np.zeros((n, k), dtype=np.int8)\n    # For efficiency, sample all pairs at once if possible\n    # Use rng.choice for each plant\n    for i in range(n):\n        alleles = rng.choice(k, size=2, replace=False)\n        A[i, alleles[0]] = 1\n        A[i, alleles[1]] = 1\n    return A\n\ndef expected_truncated_poisson(lam, O):\n    # lam: array of shape (n,)\n    # O: integer ovule count\n    # Compute E[min(O, X)] where X ~ Poisson(lam)\n    lam = np.asarray(lam, dtype=np.float64)\n    n = lam.shape[0]\n    x_vals = np.arange(O, dtype=np.int32)  # 0..O-1\n    # pmf shape: (n, O)\n    pmf = poisson.pmf(x_vals[None, :], lam[:, None])\n    term1 = (pmf * x_vals[None, :]).sum(axis=1)\n    tail = 1.0 - poisson.cdf(O - 1, lam)\n    return term1 + O * tail\n\ndef run_case(L, rho, sigma, k, P, O, c, seed):\n    rng = np.random.default_rng(seed)\n    total_cells = L * L\n    n = int(np.round(rho * total_cells))\n    n = max(0, min(n, total_cells))\n    if n == 0:\n        return 0.0\n    # Place plants on unique cells\n    chosen = rng.choice(total_cells, size=n, replace=False)\n    x = (chosen % L).astype(np.int32)\n    y = (chosen // L).astype(np.int32)\n    # Assign genotypes\n    A = assign_genotypes(n, k, rng)\n    # Pairwise shared allele counts S = A A^T\n    # Use integer dot product\n    S_shared = A @ A.T  # shape (n, n), entries in {0,1,2}\n    # Compatibility fractions f_ij = 1 - 0.5 * S_shared\n    F = 1.0 - 0.5 * S_shared.astype(np.float64)\n    # Self-pollen incompatible\n    np.fill_diagonal(F, 0.0)\n    # Distances and kernel\n    D = minimum_image_distances(x, y, L)\n    K = gaussian_kernel(D, sigma)\n    # Arrival rates\n    W = K * F\n    lam = c * P * W.sum(axis=1)\n    # Expected seed set per plant\n    e_seeds = expected_truncated_poisson(lam, O)\n    mean_seed_set = float(e_seeds.mean())\n    return mean_seed_set\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (L, rho, sigma, k, P, O, c, seed)\n    test_cases = [\n        (40, 0.3, 2.0, 20, 1000, 50, 1.0, 1),   # Case 1\n        (40, 0.3, 2.0, 2,  1000, 50, 1.0, 1),   # Case 2\n        (40, 0.3, 2.0, 100,1000, 50, 1.0, 1),   # Case 3\n        (40, 0.5, 0.5, 20, 1000, 50, 1.0, 2),   # Case 4\n        (40, 0.05,10.0, 20, 1000, 50, 1.0, 3),  # Case 5\n    ]\n\n    results = []\n    for L, rho, sigma, k, P, O, c, seed in test_cases:\n        mean_seed = run_case(L, rho, sigma, k, P, O, c, seed)\n        results.append(f\"{mean_seed:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2609415"}]}