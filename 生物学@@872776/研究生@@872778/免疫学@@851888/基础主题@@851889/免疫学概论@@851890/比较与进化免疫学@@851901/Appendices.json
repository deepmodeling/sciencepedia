{"hands_on_practices": [{"introduction": "比较与进化免疫学的一个核心技能是量化作用于免疫相关基因上的选择压力。本练习聚焦于非同义替换率 ($d_N$) 与同义替换率 ($d_S$) 之比，这是一个用于区分驱动适应的正选择与维持功能的纯化选择的强大工具。通过将此概念应用于适应性免疫的基石——主要组织相容性复合体 (MHC)，您将理解为何同一蛋白质的不同区域会以截然不同的速率演化 [@problem_id:2842372]。", "problem": "在许多脊椎动物中，主要组织相容性复合体（MHC）的肽结合区是宿主-病原体协同进化的一个焦点。考虑一个MHC II类基因，其来自两个近缘灵长类物种的直系同源编码序列已进行比对，并被划分为肽结合区（PBR）和非肽结合区的其余部分（non-PBR）。令$d_N$表示每个非同义位点的非同义替换数，$d_S$表示每个同义位点的同义替换数。假设序列分歧足够低，可以忽略多次突变的影响，因此通过计算观察到的固定差异数除以相应的位点类别数，是估算$d_N$和$d_S$的合适方法。对于每个区域，给定以下数据：\n- PBR：非同义位点数 $L_N = 420$，同义位点数 $L_S = 180$，观察到的固定非同义差异数 $N = 58$，观察到的固定同义差异数 $S = 6$。\n- 非PBR：非同义位点数 $L_N = 2880$，同义位点数 $L_S = 960$，观察到的固定非同义差异数 $N = 35$，观察到的固定同义差异数 $S = 20$。\n\n仅使用核心定义（非同义与同义，以及每位点的替换数），计算特定区域的$d_N/d_S$值，并在比较与进化免疫学的背景下，解释每个区域的结果与哪种选择模式最为一致。对于最终报告值，计算比率\n$$\nR \\equiv \\frac{(d_N/d_S)_{\\mathrm{PBR}}}{(d_N/d_S)_{\\mathrm{non\\text{-}PBR}}}.\n$$\n将$R$的最终答案四舍五入至三位有效数字。最终报告值中不要包含任何单位。", "solution": "所提出的问题是分子进化中的一个标准练习，要求计算并解释非同义替换率与同义替换率之比。该问题具有科学依据，表述清晰，并包含了所有必要信息。因此，我将着手解决它。\n\n问题的核心在于通过比较非同义替换率（$d_N$）与同义替换率（$d_S$），来分析作用于基因不同区域的选择压力。率$d_S$是每个同义位点（$L_S$）的同义替换数（$S$），它可作为中性进化条件下突变率的基线估计，因为这些替换不改变氨基酸序列，因此在很大程度上不受自然选择的影响。率$d_N$是每个非同义位点（$L_N$）的非同义替换数（$N$）。\n\n根据问题陈述，我们使用简单的估计方法，即替换率等于观察到的差异数除以位点数。\n对于基因的任何给定区域，这些率的定义如下：\n$$\nd_N = \\frac{N}{L_N}\n$$\n$$\nd_S = \\frac{S}{L_S}\n$$\n比率 $\\omega = d_N/d_S$ 是作用于蛋白质编码序列的选择模式的经典指标。$\\omega = 1$ 表明中性进化，即非同义突变与同义突变以相同的速率被固定。$\\omega  1$ 表明纯化选择（或负选择），即非同义突变是有害的，并会从群体中被清除。$\\omega > 1$ 是正选择（或多样化选择）的强信号，即非同义突变是有利的，并以比中性突变更高的速率被驱动至固定。\n\n首先，我们分析肽结合区（PBR）。PBR 的给定数据如下：\n- 非同义位点数，$L_{N, \\mathrm{PBR}} = 420$\n- 同义位点数，$L_{S, \\mathrm{PBR}} = 180$\n- 非同义差异数，$N_{\\mathrm{PBR}} = 58$\n- 同义差异数，$S_{\\mathrm{PBR}} = 6$\n\n我们计算 PBR 的替换率：\n$$\n(d_N)_{\\mathrm{PBR}} = \\frac{N_{\\mathrm{PBR}}}{L_{N, \\mathrm{PBR}}} = \\frac{58}{420}\n$$\n$$\n(d_S)_{\\mathrm{PBR}} = \\frac{S_{\\mathrm{PBR}}}{L_{S, \\mathrm{PBR}}} = \\frac{6}{180} = \\frac{1}{30}\n$$\n现在，我们计算比率 $\\omega_{\\mathrm{PBR}} = (d_N/d_S)_{\\mathrm{PBR}}$：\n$$\n\\omega_{\\mathrm{PBR}} = \\frac{(d_N)_{\\mathrm{PBR}}}{(d_S)_{\\mathrm{PBR}}} = \\frac{58/420}{1/30} = \\frac{58}{420} \\times 30 = \\frac{58}{14} = \\frac{29}{7}\n$$\n数值上，$\\omega_{\\mathrm{PBR}} \\approx 4.14$。由于该值远大于 $1$，它表明存在强烈的正选择。对于MHC基因的PBR而言，这是一个预期的结果。该区域直接参与结合并呈递来自病原体的肽。宿主-病原体协同进化产生了强烈的选择压力，迫使宿主识别多样化且不断进化的病原体肽，从而驱动PBR中新氨基酸变体的快速进化。\n\n接下来，我们分析非肽结合区（non-PBR）。该区域的给定数据如下：\n- 非同义位点数，$L_{N, \\text{non-PBR}} = 2880$\n- 同义位点数，$L_{S, \\text{non-PBR}} = 960$\n- 非同义差异数，$N_{\\text{non-PBR}} = 35$\n- 同义差异数，$S_{\\text{non-PBR}} = 20$\n\n我们计算 non-PBR 的替换率：\n$$\n(d_N)_{\\text{non-PBR}} = \\frac{N_{\\text{non-PBR}}}{L_{N, \\text{non-PBR}}} = \\frac{35}{2880}\n$$\n$$\n(d_S)_{\\text{non-PBR}} = \\frac{S_{\\text{non-PBR}}}{L_{S, \\text{non-PBR}}} = \\frac{20}{960} = \\frac{1}{48}\n$$\n现在，我们计算比率 $\\omega_{\\text{non-PBR}} = (d_N/d_S)_{\\text{non-PBR}}$：\n$$\n\\omega_{\\text{non-PBR}} = \\frac{(d_N)_{\\text{non-PBR}}}{(d_S)_{\\text{non-PBR}}} = \\frac{35/2880}{1/48} = \\frac{35}{2880} \\times 48 = \\frac{35 \\times 48}{2880}\n$$\n注意到 $2880 = 60 \\times 48$，计算可以简化为：\n$$\n\\omega_{\\text{non-PBR}} = \\frac{35}{60} = \\frac{7}{12}\n$$\n数值上，$\\omega_{\\text{non-PBR}} \\approx 0.583$。由于该值小于 $1$，它表明存在纯化选择。这也是预期的。MHC分子的非PBR部分具有必须被保守的关键结构和信号传导功能。这些区域中的大多数氨基酸改变很可能是有害的，会破坏蛋白质的整体结构或其与免疫系统其他组分（如T细胞受体或CD4共受体）的相互作用，因此会受到选择性清除。\n\n最后，问题要求计算比率 $R$，它对比了PBR与non-PBR中选择强度的差异。\n$$\nR \\equiv \\frac{(d_N/d_S)_{\\mathrm{PBR}}}{(d_N/d_S)_{\\mathrm{non\\text{-}PBR}}} = \\frac{\\omega_{\\mathrm{PBR}}}{\\omega_{\\text{non-PBR}}}\n$$\n代入我们计算出的精确分数值：\n$$\nR = \\frac{29/7}{7/12} = \\frac{29}{7} \\times \\frac{12}{7} = \\frac{29 \\times 12}{7 \\times 7} = \\frac{348}{49}\n$$\n为了得到最终的数值答案，我们进行除法运算，并按要求四舍五入到三位有效数字。\n$$\nR = \\frac{348}{49} \\approx 7.1020408...\n$$\n四舍五入到三位有效数字得到 $7.10$。\n这个较大的 $R$ 值定量地表明，作用于MHC蛋白不同功能域的选择压力存在显著差异，肽结合区在强正选择下进化的速率（以 $\\omega$ 比率衡量）比功能受限的非PBR区域的背景速率快 $7$ 倍以上。", "answer": "$$\n\\boxed{7.10}\n$$", "id": "2842372"}, {"introduction": "在分析了进化模式之后，我们转向对潜在生物学机制的建模。本练习深入探讨了胸腺中的中枢耐受过程，这是预防自身免疫的关键检查点。通过从基本原理出发构建一个随机模型，您将学习如何将单个分子（如自身免疫调节因子 Aire）的表达水平与系统性的自身免疫疾病风险联系起来，从而洞悉定量建模如何揭示免疫调控的概率性本质 [@problem_id:2842341]。", "problem": "在脊椎动物中，中枢免疫耐受是在胸腺中通过阴性选择过程建立的，该过程会清除其T细胞受体（TCR）与自身肽-主要组织相容性复合体（MHC）复合物强力结合的胸腺细胞。由胸腺髓质上皮细胞表达的自身免疫调节因子（Aire）会诱导组织限制性抗原（TRAs）的异位表达，从而能够将这些抗原呈递给发育中的T细胞。考虑两个亲缘关系很近的哺乳动物物种，它们在所有胸腺选择参数上都相同，唯一的区别是：物种B表达Aire的相对水平为 $A \\in (0,1]$，而物种A的表达水平为 $A=1$。假设以下建模假设，这些假设基于胸腺选择原理以及对抗原呈递和T细胞扫描的广泛使用的随机性描述：\n\n1. 对于一个代表性抗原呈递细胞（APC）上的给定TRA，可用于触发清除的同源肽-MHC复合物的数量是一个泊松随机变量，其均值为 $\\mu(A) = \\mu_{0} A$，其中 $\\mu_{0}$ 是野生型Aire（$A=1$）下的均值。\n2. 一个发育中的胸腺细胞在其可被阴性选择的时间窗口内，与不同的APC进行 $M$ 次独立的连续接触。在任何一次接触中，如果存在至少一个针对该克隆自身表位的同源肽-MHC复合物，则由于信号传导的可变性，会以概率 $\\sigma \\in (0,1)$ 触发清除；否则，该克隆在这次接触中不会被清除。\n3. 在一个包含 $T$ 个不同选择前胸腺细胞克隆的群体中，对任何一个特定TRA表位具有特异性（并可能具有自身反应性）的克隆比例 $f$ 很小。存在 $N$ 个不同的、不重叠的TRA，其中枢耐受主要依赖于Aire。您可以假设 $N f \\ll 1$，因此在此尺度上双重特异性可以忽略不计，并且稀有事件的独立性近似适用于不同克隆和TRA。\n\n任务：\na) 从这些假设和阴性选择的定义出发，推导物种B中自身免疫风险 $R(A)$ 的一个闭式表达式。该风险定义为：至少有一个针对 $N$ 个TRA中任意一个的自身反应性克隆逃脱阴性选择的概率。表达式应由 $A$、$\\mu_{0}$、$M$、$\\sigma$、$T$、$N$ 和 $f$ 表示。\n\nb) 使用您推导的表达式，当 $A = \\frac{1}{2}$ 时，使用以下经验上合理且假设在这些物种中保守的参数来计算物种B的 $R(A)$：$\\mu_{0} = 0.02$，$M = 800$，$\\sigma = 0.4$，$T = 10^{6}$，$N = 10^{3}$ 以及 $f = 5 \\times 10^{-9}$。将 $R\\!\\left(\\tfrac{1}{2}\\right)$ 的最终数值报告为无单位小数，并四舍五入到四位有效数字。", "solution": "问题陈述是连贯的，并且基于已确立的免疫学和随机建模原理。假设陈述清晰，允许进行严谨的推导。该问题是有效的。我们按要求分两部分进行求解。\n\na) 自身免疫风险 $R(A)$ 的推导。\n\n推导过程是首先计算单个自身反应性胸腺细胞逃脱阴性选择的概率，然后将此风险汇总到整个相关的T细胞库中。\n\n让我们考虑一个对 $N$ 个组织限制性抗原（TRA）之一具有特异性的单个自身反应性胸腺细胞克隆。\n根据假设1，单个抗原呈递细胞（APC）上的同源肽-MHC（pMHC）复合物数量 $K$ 服从泊松分布，其均值为 $\\mu(A) = \\mu_0 A$。其概率质量函数为 $P(K=k) = \\frac{\\exp(-\\mu_0 A)(\\mu_0 A)^k}{k!}$。\n\n一个APC呈递零个同源pMHC复合物的概率是：\n$$ P(K=0) = \\exp(-\\mu_0 A) $$\n一个APC呈递至少一个同源pMHC复合物的概率是：\n$$ P(K \\geq 1) = 1 - P(K=0) = 1 - \\exp(-\\mu_0 A) $$\n根据假设2，胸腺细胞在与APC的单次相遇中被清除，只有在 $K \\geq 1$ 时才可能发生。如果 $K \\geq 1$，则以概率 $\\sigma$ 触发清除。因此，如果在这次相遇中胸腺细胞*未被*清除，要么是因为 $K=0$（无信号），要么是因为 $K \\geq 1$ 但清除信号失败（概率为 $1-\\sigma$）。\n\n一个胸腺细胞在与APC单次相遇中未被清除的概率，记为 $p_{nd,1}$，是这两个互斥事件的概率之和：\n$$ p_{nd,1} = P(K=0) + P(K \\geq 1) \\times (1-\\sigma) $$\n代入从泊松分布推导出的表达式：\n$$ p_{nd,1} = \\exp(-\\mu_0 A) + (1 - \\exp(-\\mu_0 A))(1-\\sigma) $$\n$$ p_{nd,1} = \\exp(-\\mu_0 A) + 1 - \\sigma - \\exp(-\\mu_0 A) + \\sigma \\exp(-\\mu_0 A) $$\n$$ p_{nd,1} = 1 - \\sigma + \\sigma \\exp(-\\mu_0 A) = 1 - \\sigma(1 - \\exp(-\\mu_0 A)) $$\n一个胸腺细胞会经历 $M$ 次这样的独立相遇。为了使该克隆逃脱阴性选择，它必须在所有 $M$ 次相遇中都存活下来。因此，单个自身反应性克隆的逃脱概率 $P_{\\text{esc,clone}}$ 为：\n$$ P_{\\text{esc,clone}} = (p_{nd,1})^M = \\left[ 1 - \\sigma(1 - \\exp(-\\mu_0 A)) \\right]^M $$\n自身免疫风险 $R(A)$ 是至少有一个自身反应性克隆逃脱阴性选择的概率。选择前胸腺细胞克隆的总数为 $T$。对单个TRA具有特异性的克隆比例为 $f$。存在 $N$ 个这样的TRA。因此，针对所有 $N$ 个TRA的潜在自身反应性克隆的总数为 $N \\times T \\times f$。\n这些克隆中任何单个克隆的逃脱概率 $P_{\\text{esc,clone}}$ 是一个很小的值。而这类克隆的总数 $N T f$ 可能很大。逃脱的克隆数量可以用泊松分布来建模，其合理性在于克隆的独立性（假设 $Nf \\ll 1$）和逃脱事件的稀有性。\n\n这个泊松分布的均值（或参数 $\\lambda$）代表了期望的逃脱自身反应性克隆数量，其值为：\n$$ \\lambda_{\\text{total}} = (\\text{自身反应性克隆总数}) \\times (\\text{每个克隆的逃脱概率}) $$\n$$ \\lambda_{\\text{total}} = (N T f) \\times P_{\\text{esc,clone}} $$\n$$ \\lambda_{\\text{total}} = N T f \\left[ 1 - \\sigma(1 - \\exp(-\\mu_0 A)) \\right]^M $$\n风险 $R(A)$ 是逃脱克隆数量至少为一个的概率。对于一个均值为 $\\lambda$ 的泊松分布随机变量 $X$，有 $P(X \\geq 1) = 1 - P(X=0) = 1 - \\exp(-\\lambda)$。\n因此，自身免疫风险为：\n$$ R(A) = 1 - \\exp(-\\lambda_{\\text{total}}) $$\n代入 $\\lambda_{\\text{total}}$ 的表达式，我们得到自身免疫风险的最终闭式表达式：\n$$ R(A) = 1 - \\exp\\left(-N T f \\left[1 - \\sigma\\left(1 - \\exp(-\\mu_0 A)\\right)\\right]^M\\right) $$\n\nb) 对给定参数计算 $R(A)$。\n\n我们需要用以下参数计算当 $A = \\frac{1}{2}$ 时的 $R(A)$：$\\mu_{0} = 0.02$，$M = 800$，$\\sigma = 0.4$，$T = 10^{6}$，$N = 10^{3}$ 以及 $f = 5 \\times 10^{-9}$。\n\n首先，我们计算内部指数项的指数：\n$$ \\mu_0 A = (0.02) \\times \\left(\\frac{1}{2}\\right) = 0.01 $$\n接下来，我们计算单次相遇中不被清除的概率 $p_{nd,1}$：\n$$ p_{nd,1} = 1 - \\sigma(1 - \\exp(-\\mu_0 A)) = 1 - 0.4(1 - \\exp(-0.01)) $$\n这可以重写为 $0.6 + 0.4 \\exp(-0.01)$。\n使用 $\\exp(-0.01) \\approx 0.99004983$：\n$$ p_{nd,1} \\approx 0.6 + 0.4 \\times 0.99004983 = 0.6 + 0.39601993 = 0.99601993 $$\n现在，我们计算单个克隆的逃脱概率 $P_{\\text{esc,clone}}$：\n$$ P_{\\text{esc,clone}} = (p_{nd,1})^M = (0.99601993)^{800} $$\n取自然对数：\n$$ \\ln(P_{\\text{esc,clone}}) = 800 \\ln(0.99601993) \\approx 800 \\times (-0.00398807) \\approx -3.190456 $$\n$$ P_{\\text{esc,clone}} = \\exp(-3.190456) \\approx 0.0411516 $$\n接着，我们计算逃脱克隆的平均数量 $\\lambda_{\\text{total}}$。首先，我们计算相关克隆的总数：\n$$ N T f = (10^3) \\times (10^6) \\times (5 \\times 10^{-9}) = 5 $$\n所以，$\\lambda_{\\text{total}} = 5 \\times P_{\\text{esc,clone}}$：\n$$ \\lambda_{\\text{total}} \\approx 5 \\times 0.0411516 = 0.205758 $$\n最后，我们计算自身免疫风险 $R(\\frac{1}{2})$：\n$$ R\\!\\left(\\frac{1}{2}\\right) = 1 - \\exp(-\\lambda_{\\text{total}}) \\approx 1 - \\exp(-0.205758) $$\n$$ R\\!\\left(\\frac{1}{2}\\right) \\approx 1 - 0.8140321 = 0.1859679 $$\n按要求将结果四舍五入到四位有效数字：\n$$ R\\!\\left(\\frac{1}{2}\\right) \\approx 0.1860 $$\n这表明，对于Aire水平降低了50%的物种B个体，对于这组 $N$ 个依赖于Aire的抗原，至少有一个自身反应性T细胞克隆逃脱中枢耐受的概率约为18.6%。", "answer": "$$\\boxed{0.1860}$$", "id": "2842341"}, {"introduction": "最后的实践通过解决一个疫苗学中的实际优化问题，将理论与应用联系起来。该问题聚焦于婴儿的“易感窗口期”，在此期间，衰减的母源抗体水平已不足以提供保护，但仍高到足以干扰疫苗接种。此练习要求您根据经验数据拟合一个动态模型，并用它来确定最佳疫苗接种时机，展示了比较与进化免疫学的原理如何直接为公共卫生策略提供信息 [@problem_id:2842338]。", "problem": "您会获得一些比较数据集，这些数据集反映了物种特异性的被动免疫动态和环境暴露情况。您的任务是编写一个完整的程序，为每个数据集，根据滴度-时间观测数据拟合一个被动抗体衰减模型，在一个分段恒定的感染力下对风险泛函进行积分，并计算出最佳疫苗接种年龄（以天为单位的整数），以最小化婴儿在固定时间范围内的预期感染概率。程序必须使用所有提供的数据集作为其测试套件，并生成一行输出，其中包含所有最佳接种年龄，格式为方括号内以逗号分隔的列表。\n\n基础背景：\n- 在许多哺乳动物和其他脊椎动物中，被动免疫由母源免疫球蛋白G (IgG) 提供。根据经验，通过新生儿Fc受体 (FcRn) 进行的IgG分解代谢和再循环，导致出生后循环IgG浓度近似呈一级衰减。因此，通常将母源IgG滴度建模为指数衰减。\n- 新生儿体内高滴度的母源抗体，会因抗原遮蔽和反馈机制而抑制疫苗诱导的主动免疫。当滴度高于一个依赖于滴度的干扰阈值时，疫苗接种会失败。疫苗接种成功后，需要经过一段有限的成熟延迟期，主动保护才会开始生效。\n- 在标准生存分析中，对于一个具有感染力的短时间区间，感染概率会根据风险积分进行累积。对于分段恒定的风险率，可以通过对每日风险求和来计算累积风险。\n\n需要实现的模型规格：\n1) 被动滴度模型：拟合指数模型\n$$\nM(t) = M_0 \\, e^{-k t},\n$$\n的参数，其中 $M(t)$ 是年龄为 $t$（天）时的母源抗体滴度，$M_0$ 是出生时的滴度，$k$ 是衰减常数（单位为天$^{-1}$）。$M_0$ 和 $k$ 都必须使用提供的滴度观测值 $(t_i, y_i)$，通过非线性最小二乘法进行估计。\n\n2) 保护和干扰阈值：\n- 在任何一天 $d$，如果满足 $M(d) \\geq P_{\\mathrm{prot}}$，则存在被动保护，其中 $P_{\\mathrm{prot}}$ 是一个给定的保护性滴度阈值。\n- 疫苗干扰：在整数天 $t_{\\mathrm{vac}}$ 接种的疫苗，仅当 $M(t_{\\mathrm{vac}}) \\leq T_{\\mathrm{block}}$ 时才会成功（即疫苗生效），其中 $T_{\\mathrm{block}}$ 是一个给定的干扰阈值。如果疫苗未生效，则永远不会建立主动保护。\n- 主动保护的开始：如果在第 $t_{\\mathrm{vac}}$ 天疫苗生效，主动保护将在固定的延迟 $L$ 天后开始，即对于所有天数 $d \\geq t_{\\mathrm{vac}} + L$。假设一旦主动保护开始，它会持续到时间范围结束。\n\n3) 感染力：\n- 每个数据集都提供区间 $[a_j, b_j)$ 以及免疫幼稚的新生儿在该区间内对应的感染概率 $r_j$。将每个区间的风险转换为一个恒定的每日风险率\n$$\n\\lambda_j = -\\frac{\\ln(1 - r_j)}{b_j - a_j}.\n$$\n构建一个每日风险函数 $\\lambda(d)$，对于每个 $d \\in \\{a_j, a_j + 1, \\ldots, b_j - 1\\}$，其值等于 $\\lambda_j$。\n\n4) 时间范围内的预期感染概率：\n- 对于一个给定的候选接种日 $t_{\\mathrm{vac}} \\in \\{0, 1, 2, \\ldots, T_{\\mathrm{end}}\\}$，定义每日未受保护的指示函数\n$$\nI_{\\mathrm{unprot}}(d; t_{\\mathrm{vac}}) =\n\\begin{cases}\n1,  \\text{if } M(d)  P_{\\mathrm{prot}} \\text{ and there is no active protection on day } d, \\\\\n0,  \\text{otherwise.}\n\\end{cases}\n$$\n- 在时间范围 $\\{0,1,\\ldots, T_{\\mathrm{end}}-1\\}$ 内的累积感染风险为\n$$\nH(t_{\\mathrm{vac}}) = \\sum_{d=0}^{T_{\\mathrm{end}}-1} \\lambda(d) \\, I_{\\mathrm{unprot}}(d; t_{\\mathrm{vac}}).\n$$\n- 预期感染概率为\n$$\n\\pi(t_{\\mathrm{vac}}) = 1 - e^{-H(t_{\\mathrm{vac}})}.\n$$\n\n5) 优化：\n- 搜索所有整数天 $t_{\\mathrm{vac}} \\in \\{0, 1, \\ldots, T_{\\mathrm{end}}\\}$，并选择 $\\pi(t_{\\mathrm{vac}})$ 的任意一个最小值点。如果存在多个最小值点（即平局），则选择最小的 $t_{\\mathrm{vac}}$。\n\n6) 单位和输出：\n- 所有时间都以天为单位。将每个最佳接种年龄报告为整数天数。\n- 您的程序应生成单行输出，其中包含一个方括号括起来的逗号分隔列表（例如，“[$x_1,x_2,x_3$]”），其中 $x_i$ 是数据集 $i$ 的最佳接种日。\n\n测试套件（三个数据集，反映了被动免疫和暴露的比较和进化差异）：\n\n数据集 A（具有中等半衰期的胎盘哺乳动物）：\n- 滴度观测值 $(t_i, y_i)$ （天，任意单位）： $(0, 1.2)$, $(30, 0.755952621)$, $(60, 0.476220316)$, $(90, 0.3)$。\n- 保护阈值： $P_{\\mathrm{prot}} = 0.25$。\n- 干扰阈值： $T_{\\mathrm{block}} = 0.4$。\n- 主动保护延迟： $L = 14$。\n- 时间范围： $T_{\\mathrm{end}} = 180$。\n- 免疫幼稚个体在各区间的感染风险：\n  - $[0, 30)$，其中 $r = 0.05$，\n  - $[30, 90)$，其中 $r = 0.10$，\n  - $[90, 180)$，其中 $r = 0.20$。\n\n数据集 B（通过初乳获得抗体且半衰期较短的有蹄类动物）：\n- 滴度观测值 $(t_i, y_i)$： $(0, 2.0)$, $(7, 1.337480)$, $(14, 1.0)$, $(28, 0.5)$, $(42, 0.25)$。\n- 保护阈值： $P_{\\mathrm{prot}} = 0.3$。\n- 干扰阈值： $T_{\\mathrm{block}} = 0.6$。\n- 主动保护延迟： $L = 7$。\n- 时间范围： $T_{\\mathrm{end}} = 84$。\n- 免疫幼稚个体在各区间的感染风险：\n  - $[0, 14)$，其中 $r = 0.15$，\n  - $[14, 42)$，其中 $r = 0.25$，\n  - $[42, 84)$，其中 $r = 0.40$。\n\n数据集 C（初始滴度低且保护期非常短的物种）：\n- 滴度观测值 $(t_i, y_i)$： $(0, 0.3)$, $(10, 0.15)$, $(20, 0.075)$, $(30, 0.0375)$。\n- 保护阈值： $P_{\\mathrm{prot}} = 0.2$。\n- 干扰阈值： $T_{\\mathrm{block}} = 0.25$。\n- 主动保护延迟： $L = 10$。\n- 时间范围： $T_{\\mathrm{end}} = 90$。\n- 免疫幼稚个体在各区间的感染风险：\n  - $[0, 30)$，其中 $r = 0.30$，\n  - $[30, 90)$，其中 $r = 0.35$。\n\n要求和约束：\n- 对于每个数据集，使用提供的滴度数据通过非线性最小二乘法拟合 $M_0$ 和 $k$。约束 $M_0 > 0$ 和 $k > 0$。\n- 使用上述定义，不要引入其他模型。\n- 将天数离散化为整数，并在整数天 $d$ 处评估 $M(d)$。\n- 为每个数据集返回最佳接种日（以天为单位的整数），并遵循所描述的精确输出格式。", "solution": "所述问题在科学上是合理的，在数学上是适定的。它反映了疫苗学中的一个经典优化问题：确定为婴儿接种疫苗的最佳年龄以最小化感染风险，同时考虑到母源抗体的双重作用——既提供短暂的保护，又干扰疫苗效力。该模型建立在免疫学和流行病学的既定原则之上。问题陈述中没有不一致或含糊不清之处。该问题是有效的，我们将着手解决它。\n\n对每个数据集，该方法通过一系列计算步骤来执行。\n\n1.  **被动免疫模型拟合**：母源抗体滴度 $M(t)$ 的衰减由一级动力学模型 $M(t) = M_0 e^{-k t}$ 描述。参数 $M_0$（初始滴度）和 $k$（衰减速率常数）必须根据提供的滴度观测值 $(t_i, y_i)$ 进行估计。这是一个参数估计任务，我们采用非线性最小二乘法来完成。该方法找到的参数值能够最小化模型预测值与经验数据之间的平方差之和。我们必须强制施加物理约束 $M_0 > 0$ 和 $k > 0$。`scipy.optimize.curve_fit` 函数适合此目的。\n\n2.  **感染力计算**：问题为免疫幼稚个体在给定的时间区间 $[a_j, b_j)$ 内指定了感染概率 $r_j$。为了对风险累积进行建模，我们将这些概率转换为每日的分段恒定感染力（或称风险率）$\\lambda(d)$。恒定风险率 $\\lambda_j$ 与在持续时间为 $\\Delta t = b_j - a_j$ 的区间内保持未感染的概率之间的关系由 $1 - r_j = e^{-\\lambda_j \\Delta t}$ 给出。由此，我们为每个区间推导出每日风险率：$\\lambda_j = -\\frac{\\ln(1 - r_j)}{b_j - a_j}$。然后我们构建一个向量，表示在时间范围 $\\{0, 1, \\dots, T_{\\mathrm{end}}-1\\}$ 内每一天 $d$ 的 $\\lambda(d)$。\n\n3.  **优化公式**：我们的目标是从整数集合 $\\{0, 1, \\dots, T_{\\mathrm{end}}\\}$ 中找到一个接种年龄 $t_{\\mathrm{vac}}$，以最小化总感染概率 $\\pi(t_{\\mathrm{vac}})$。概率 $\\pi(t_{\\mathrm{vac}}) = 1 - e^{-H(t_{\\mathrm{vac}})}$ 是累积风险 $H(t_{\\mathrm{vac}})$ 的一个单调变换。因此，最小化感染概率等价于最小化累积风险。累积风险是在易感期内每日风险的总和：\n$$\nH(t_{\\mathrm{vac}}) = \\sum_{d=0}^{T_{\\mathrm{end}}-1} \\lambda(d) \\, I_{\\mathrm{unprot}}(d; t_{\\mathrm{vac}})\n$$\n指示函数 $I_{\\mathrm{unprot}}(d; t_{\\mathrm{vac}})$ 在婴儿于第 $d$ 天未受保护时为 $1$，否则为 $0$。\n\n4.  **定义未保护状态**：如果一个婴儿在第 $d$ 天同时缺乏被动和主动免疫，则其处于未保护状态。\n    -   当滴度降至阈值以下时，被动保护丧失：$M(d)  P_{\\mathrm{prot}}$。\n    -   主动保护取决于疫苗是否成功。在 $t_{\\mathrm{vac}}$ 接种的疫苗只有在母源滴度足够低（$M(t_{\\mathrm{vac}}) \\leq T_{\\mathrm{block}}$）时才成功。如果成功，主动保护在延迟 $L$ 天后开始，即对于 $d \\geq t_{\\mathrm{vac}} + L$。如果疫苗失败，则永远不会获得主动保护。\n\n5.  **计算搜索**：最佳的 $t_{\\mathrm{vac}}$ 通过对所有可能的接种日（一个离散且有限的集合）进行简单而穷举的搜索来找到。对于每个候选的 $t_{\\mathrm{vac}}$，我们计算总累积风险 $H(t_{\\mathrm{vac}})$。然后，我们确定与计算出的最小风险相对应的 $t_{\\mathrm{vac}}$。如果出现多个年龄产生相同的最小风险，问题规定选择最小的年龄，这个规则可以通过有序搜索自然地处理。\n\n这个综合过程在一个程序中实现，该程序处理所有三个数据集，为每个数据集计算最佳接种年龄，并以要求的格式呈现结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import curve_fit\n\ndef find_optimal_vaccination_age(case):\n    \"\"\"\n    Calculates the optimal vaccination age for a single dataset by minimizing\n    the cumulative infection hazard over a finite horizon.\n    \"\"\"\n    # Step 1: Extract data and parameters from the provided case\n    titer_obs = case[\"titer_obs\"]\n    t_obs, y_obs = titer_obs[:, 0], titer_obs[:, 1]\n    P_prot = case[\"P_prot\"]\n    T_block = case[\"T_block\"]\n    L = case[\"L\"]\n    T_end = case[\"T_end\"]\n    risks = case[\"risks\"]\n\n    # Step 2: Fit the passive titer model M(t) = M0 * exp(-k*t)\n    def titer_model(t, M0, k):\n        return M0 * np.exp(-k * t)\n\n    # Use nonlinear least squares with positivity constraints on parameters\n    popt, _ = curve_fit(titer_model, t_obs, y_obs, p0=[y_obs[0], 0.1], bounds=([0, 0], [np.inf, np.inf]))\n    M0_fit, k_fit = popt\n\n    # Step 3: Construct the piecewise-constant daily hazard array\n    daily_hazards = np.zeros(T_end)\n    for a, b, r in risks:\n        # The interval [a, b) corresponds to indices from a up to b-1\n        if b > a:\n            hazard_rate = -np.log(1 - r) / (b - a)\n            daily_hazards[a:b] = hazard_rate\n\n    # Step 4: Pre-calculate daily maternal titers over the horizon\n    days_horizon = np.arange(T_end)\n    maternal_titers_horizon = titer_model(days_horizon, M0_fit, k_fit)\n\n    # Pre-calculate passive protection status for each day in the horizon\n    passively_protected = maternal_titers_horizon >= P_prot\n\n    # Pre-calculate titers for all possible vaccination days {0, ..., T_end}\n    vac_days_candidates = np.arange(T_end + 1)\n    titers_at_vac_time = titer_model(vac_days_candidates, M0_fit, k_fit)\n    \n    # Step 5: Search for the optimal vaccination day by minimizing cumulative hazard\n    min_hazard = float('inf')\n    optimal_tvac = -1\n\n    for t_vac in vac_days_candidates:\n        # Determine if the vaccine takes based on the interference threshold\n        vaccine_takes = titers_at_vac_time[t_vac] = T_block\n\n        # Determine the period of active protection if the vaccine takes\n        if vaccine_takes:\n            active_protection_starts = t_vac + L\n            actively_protected = days_horizon >= active_protection_starts\n        else:\n            # If vaccine fails, there is no active protection\n            actively_protected = np.zeros_like(days_horizon, dtype=bool)\n\n        # An infant is protected if either passive or active immunity is present\n        is_protected = np.logical_or(passively_protected, actively_protected)\n        \n        # The unprotected indicator is the logical negation of being protected\n        unprotected_indicator = np.logical_not(is_protected)\n        \n        # Calculate the cumulative hazard H(t_vac) for this choice of t_vac\n        cumulative_hazard = np.dot(daily_hazards, unprotected_indicator)\n\n        # If this hazard is lower than the minimum found so far, update the optimum.\n        # The loop's ascending order ensures the smallest t_vac is chosen in a tie.\n        if cumulative_hazard  min_hazard:\n            min_hazard = cumulative_hazard\n            optimal_tvac = t_vac\n    \n    return optimal_tvac\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run the optimization for each,\n    and print the results in the specified format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"name\": \"A (placental mammal)\",\n            \"titer_obs\": np.array([\n                (0, 1.2), \n                (30, 0.755952621), \n                (60, 0.476220316), \n                (90, 0.3)\n            ]),\n            \"P_prot\": 0.25,\n            \"T_block\": 0.4,\n            \"L\": 14,\n            \"T_end\": 180,\n            \"risks\": [\n                (0, 30, 0.05),\n                (30, 90, 0.10),\n                (90, 180, 0.20),\n            ]\n        },\n        {\n            \"name\": \"B (ungulate)\",\n            \"titer_obs\": np.array([\n                (0, 2.0), \n                (7, 1.337480), \n                (14, 1.0), \n                (28, 0.5), \n                (42, 0.25)\n            ]),\n            \"P_prot\": 0.3,\n            \"T_block\": 0.6,\n            \"L\": 7,\n            \"T_end\": 84,\n            \"risks\": [\n                (0, 14, 0.15),\n                (14, 42, 0.25),\n                (42, 84, 0.40),\n            ]\n        },\n        {\n            \"name\": \"C (low initial titer species)\",\n            \"titer_obs\": np.array([\n                (0, 0.3), \n                (10, 0.15), \n                (20, 0.075), \n                (30, 0.0375)\n            ]),\n            \"P_prot\": 0.2,\n            \"T_block\": 0.25,\n            \"L\": 10,\n            \"T_end\": 90,\n            \"risks\": [\n                (0, 30, 0.30),\n                (30, 90, 0.35),\n            ]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        optimal_age = find_optimal_vaccination_age(case)\n        results.append(optimal_age)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\n# Execute the main solver function.\nsolve()\n```", "id": "2842338"}]}