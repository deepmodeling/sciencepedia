{"hands_on_practices": [{"introduction": "要从根本上理解NK细胞的细胞毒性，我们需要将微观的细胞相互作用与宏观的实验测量结果联系起来。这个练习将引导我们从第一性原理出发，建立一个概率模型。通过将效应细胞与靶细胞的相遇过程模拟为泊松分布，并应用“单次打击”致死模型，我们将推导出在抗体依赖性细胞介导的细胞毒性（ADCC）分析中预期的靶细胞裂解比例 [@problem_id:2875036]。这项练习旨在锻炼我们利用核心概率概念来构建和解析免疫学过程的能力。", "problem": "进行了一项为时 4 小时的抗体依赖性细胞介导的细胞毒性 (ADCC) 分析，其中使用人类自然杀伤 (NK) 细胞作为效应细胞，使用同质肿瘤细胞系作为靶细胞。在分析开始时，一部分比例为 $f$ 的靶细胞被免疫球蛋白 G (IgG) 调理，从而能够通过 Fcγ 受体 IIIa (CD16) 进行识别。在分析过程中，每个 NK 细胞与一个随机选择的靶细胞形成一个稳定的结合体，且不同 NK 细胞的结合事件是相互独立的。设效应细胞和靶细胞的总数分别为 $E$ 和 $T$，效应细胞与靶细胞之比（效靶比）为 $R = E/T$。假设 $T$ 足够大，以至于任何给定靶细胞接收到的 NK 结合体的数量可以用独立随机分配的适当大总体极限来建模。\n\n对于任何接收到 $n$ 个 NK 结合体的调理化靶细胞，在 4 小时的时间窗内，每个结合体都以概率 $p$ 独立地触发一次致死打击。如果在此时间窗内至少发生一次致死打击，则认为该靶细胞被裂解。在此时间尺度上，未经调理的靶细胞不会被 ADCC 裂解，其他细胞毒性途径可以忽略不计。您可以假设，在给定调理状态的条件下，不同效应细胞和靶细胞之间的结合事件和触发事件是统计独立的。\n\n仅使用这些假设和针对大 $T$ 的标准概率极限，从第一性原理出发，推导出 4 小时后被裂解靶细胞的期望比例，用 $R$、$f$ 和 $p$ 表示。然后，计算当 $R = 8$，$f = 0.6$ 和 $p = 0.18$ 时该期望比例的值。将您的最终结果表示为小数，并四舍五入到四位有效数字。", "solution": "所述问题具有科学依据，提法明确，客观且自成体系。它提出了一个免疫学中标准的概率建模情景。因此，我将进行完整的推导。\n\n目标是推导在 4 小时孵育期后被裂解的靶细胞的期望比例。这需要基于给定假设进行逐步的概率分析。\n\n首先，我们必须确定每个靶细胞上自然杀伤（NK）细胞结合体的统计分布。给定 $E$ 个效应细胞（NK 细胞）和 $T$ 个靶细胞。每个 NK 细胞与一个随机且独立选择的靶细胞形成一个结合体。这是一个经典的“球入箱”问题，其中 $E$ 个球被放入 $T$ 个箱子中。单个靶细胞接收到的结合体数量 $N$ 服从二项分布，$N \\sim B(E, 1/T)$。问题指出 $T$ 足够大，我们应使用“适当的大总体极限”。当 $T \\rightarrow \\infty$ 和 $E \\rightarrow \\infty$ 且比率 $R = E/T$ 保持不变时，二项分布 $B(E, 1/T)$ 收敛于均值为 $\\lambda = E \\times (1/T) = R$ 的泊松分布。因此，一个随机选择的靶细胞接收到 $n$ 个 NK 细胞结合体的概率由泊松概率质量函数给出：\n$$ P(N=n) = \\frac{e^{-R} R^n}{n!} \\quad \\text{for } n = 0, 1, 2, \\dots $$\n这里，$R$ 是效靶比。\n\n接下来，我们确定单个靶细胞的裂解概率。靶细胞的命运取决于两个因素：其调理状态和它接收到的 NK 结合体数量。\n问题指出，比例为 $f$ 的靶细胞被调理，剩余比例为 $1-f$ 的靶细胞未被调理。未调理的靶细胞不会被裂解。因此，未调理靶细胞的裂解概率为 $0$。\n\n现在，考虑一个被调理的靶细胞。如果该细胞接收到 $n$ 个结合体，每个结合体都有独立的概率 $p$ 触发一次致死打击。如果至少发生一次致死打击，靶细胞就会被裂解。计算其互补事件的概率更为直接：没有发生致死打击。对于单个结合体，*不*触发致死打击的概率是 $1-p$。由于 $n$ 次触发是独立的，因此 $n$ 个结合体*都*不产生致死打击的概率是 $(1-p)^n$。\n因此，一个已形成 $n$ 个结合体的调理化靶细胞的裂解概率 $P(L|N=n, \\text{opsonized})$ 为：\n$$ P(L \\,|\\, N=n, \\text{opsonized}) = 1 - (1-p)^n $$\n这个概率是在接收到恰好 $n$ 个结合体条件下的条件概率。为了求出任何给定调理化靶细胞的总裂解概率，我们必须对所有可能的 $n$ 值，根据泊松分布 $P(N=n)$ 进行加权平均：\n$$ P(L \\,|\\, \\text{opsonized}) = \\sum_{n=0}^{\\infty} P(L \\,|\\, N=n, \\text{opsonized}) P(N=n) $$\n代入上面推导出的表达式：\n$$ P(L \\,|\\, \\text{opsonized}) = \\sum_{n=0}^{\\infty} [1 - (1-p)^n] \\frac{e^{-R} R^n}{n!} $$\n我们可以将这个和式分成两部分：\n$$ P(L \\,|\\, \\text{opsonized}) = \\sum_{n=0}^{\\infty} \\frac{e^{-R} R^n}{n!} - \\sum_{n=0}^{\\infty} (1-p)^n \\frac{e^{-R} R^n}{n!} $$\n第一项是泊松分布所有概率的总和，等于 $1$。第二项可以通过提出常数 $e^{-R}$ 来改写：\n$$ \\sum_{n=0}^{\\infty} (1-p)^n \\frac{e^{-R} R^n}{n!} = e^{-R} \\sum_{n=0}^{\\infty} \\frac{[R(1-p)]^n}{n!} $$\n该求和是指数函数的麦克劳林级数，$\\sum_{k=0}^{\\infty} \\frac{x^k}{k!} = e^x$。当 $x = R(1-p)$ 时，该和式的值为 $\\exp(R(1-p))$。\n所以，第二项变为：\n$$ e^{-R} \\exp(R(1-p)) = \\exp(-R + R(1-p)) = \\exp(-R + R - Rp) = \\exp(-Rp) $$\n因此，一个调理化靶细胞的裂解概率是：\n$$ P(L \\,|\\, \\text{opsonized}) = 1 - \\exp(-Rp) $$\n\n最后，我们计算被裂解靶细胞的总期望比例 $L_{frac}$。这是调理化和非调理化亚群裂解概率的加权平均。使用全概率公式：\n$$ L_{frac} = P(L) = P(L \\,|\\, \\text{opsonized})P(\\text{opsonized}) + P(L \\,|\\, \\text{non-opsonized})P(\\text{non-opsonized}) $$\n给定 $P(\\text{opsonized}) = f$（因此 $P(\\text{non-opsonized}) = 1-f$）和 $P(L \\,|\\, \\text{non-opsonized}) = 0$。将这些值以及我们推导出的 $P(L \\,|\\, \\text{opsonized})$ 的表达式代入：\n$$ L_{frac} = (1 - \\exp(-Rp)) \\cdot f + (0) \\cdot (1-f) $$\n这就给出了被裂解靶细胞期望比例的最终解析表达式：\n$$ L_{frac} = f(1 - \\exp(-Rp)) $$\n这是从第一性原理推导出的通用解。\n\n现在，我们必须用给定的数值计算这个表达式的值：$R = 8$，$f = 0.6$ 和 $p = 0.18$。\n首先，计算指数部分：\n$$ -Rp = -(8)(0.18) = -1.44 $$\n现在将这些值代入推导出的公式中：\n$$ L_{frac} = 0.6 \\times (1 - \\exp(-1.44)) $$\n计算数值：\n$$ \\exp(-1.44) \\approx 0.23692776... $$\n$$ 1 - \\exp(-1.44) \\approx 1 - 0.23692776 = 0.76307224... $$\n$$ L_{frac} \\approx 0.6 \\times 0.76307224 = 0.457843344... $$\n问题要求将结果四舍五入到四位有效数字。\n$$ L_{frac} \\approx 0.4578 $$\n这是最终的数值答案。", "answer": "$$\\boxed{0.4578}$$", "id": "2875036"}, {"introduction": "理论模型为我们提供了框架，但免疫学研究的核心在于对实验数据的严谨分析。在获得例如铬-51释放实验的数据后，我们需要标准化的方法来量化和比较细胞毒性效力。这项练习 [@problem_id:2875114] 介绍了一个广泛使用的度量单位——“裂解单位”（Lytic Unit, LU），并要求我们通过对剂量反应曲线进行插值计算来确定它。这不仅是一项解读实验结果的关键技能，也让我们能够客观地评估不同条件下（例如抑制性受体被阻断时）NK细胞功能的增强程度。", "problem": "自然杀伤（NK）细胞整合激活和抑制信号，对易感靶细胞执行细胞毒性作用。在一个标准的4小时铬-51 (chromium-51) 释放实验中，细胞毒性读数是比裂解率（specific lysis）随效应细胞与靶细胞（E:T）比率变化的函数。考虑一个实验，其中每孔有 $T = 10^4$ 个靶细胞，比较两种条件：对照条件（无受体扰动）和抑制性受体阻断条件。测试的效靶比为$1:1$、$3:1$、$10:1$、$30:1$和$100:1$。每个条件下测得的比裂解值（分数形式，非百分比）为：\n\n- 对照组：$1:1 \\rightarrow 0.06$，$3:1 \\rightarrow 0.14$，$10:1 \\rightarrow 0.31$，$30:1 \\rightarrow 0.56$，$100:1 \\rightarrow 0.77$。\n- 阻断组：$1:1 \\rightarrow 0.09$，$3:1 \\rightarrow 0.22$，$10:1 \\rightarrow 0.46$，$30:1 \\rightarrow 0.71$，$100:1 \\rightarrow 0.87$。\n\n假设如下：\n- 在测试的效靶比之间，比裂解率随效靶比的常用对数（以10为底）单调近似线性变化（这是细胞毒性剂量反应曲线的一个常见经验特性）。\n- 在0.20比裂解率下的一个裂解单位（记为LU$_{20}$）定义为：在实验条件下，实现对$T$个靶细胞的$0.20$比裂解所需的效应细胞数量。“每$10^7$个效应细胞的裂解单位数”是指$10^7$个效应细胞中所包含的LU$_{20}$单位的数量。\n\n仅使用上述定义和数据，计算阻断条件下相对于对照条件的每$10^7$个效应细胞的LU$_{20}$的倍数变化。将最终答案四舍五入至三位有效数字。最终答案以无单位数字形式表示（无单位，无百分号）。", "solution": "首先对问题进行严格验证。\n\n**步骤1：提取已知条件**\n- 实验：4小时铬-51释放实验。\n- 每孔靶细胞数：$T = 10^4$。\n- 测试的效靶比（E:T ratios）（$R$）：$1:1$、$3:1$、$10:1$、$30:1$和$100:1$。\n- 对照条件下的比裂解数据（$L_{\\text{ctrl}}$）：\n  - 当 $R=1$ 时，$L_{\\text{ctrl}} = 0.06$。\n  - 当 $R=3$ 时，$L_{\\text{ctrl}} = 0.14$。\n  - 当 $R=10$ 时，$L_{\\text{ctrl}} = 0.31$。\n  - 当 $R=30$ 时，$L_{\\text{ctrl}} = 0.56$。\n  - 当 $R=100$ 时，$L_{\\text{ctrl}} = 0.77$。\n- 阻断条件下的比裂解数据（$L_{\\text{block}}$）：\n  - 当 $R=1$ 时，$L_{\\text{block}} = 0.09$。\n  - 当 $R=3$ 时，$L_{\\text{block}} = 0.22$。\n  - 当 $R=10$ 时，$L_{\\text{block}} = 0.46$。\n  - 当 $R=30$ 时，$L_{\\text{block}} = 0.71$。\n  - 当 $R=100$ 时，$L_{\\text{block}} = 0.87$。\n- 假设：比裂解率（$L$）随$\\log_{10}(R)$近似线性变化。\n- 定义1：在$0.20$比裂解率下的一个裂解单位（LU$_{20}$）是达到$0.20$比裂解所需的效应细胞数量（$E_{20}$）。\n- 定义2：每$10^7$个效应细胞的裂解单位数由公式$\\frac{10^7}{E_{20}}$给出。\n- 目标：计算阻断条件下相对于对照条件的每$10^7$个细胞的LU$_{20}$的倍数变化。\n- 最终答案要求：四舍五入至三位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题描述了一个标准的免疫细胞毒性实验。裂解单位的概念和剂量反应曲线的半对数线性近似是分析此类数据的既定方法。所提供的数值在此类实验的合理范围内。该问题具有科学依据。\n- **问题的良构性**：该问题是自洽的。计算所需的所有必要数据、定义和假设均已提供。目标裂解值$0.20$位于两种条件的实验数据点之间，可以使用插值法计算。该问题是良构的。\n- **客观性**：问题陈述是定量的、客观的，没有主观或含糊不清的语言。\n\n**步骤3：结论与行动**\n问题有效。将推导解答。\n\n任务是计算倍数变化，即阻断条件下每$10^7$个细胞的裂解单位数与对照条件下该值的比率。设$U$表示每$10^7$个细胞的裂解单位数。\n$$ \\text{倍数变化} = \\frac{U_{\\text{阻断}}}{U_{\\text{对照}}} $$\n根据定义，$U = \\frac{10^7}{E_{20}}$，其中$E_{20}$是实现$0.20$比裂解所需的效应细胞数量。将此代入倍数变化的表达式中可得：\n$$ \\text{倍数变化} = \\frac{10^7 / E_{20, \\text{阻断}}}{10^7 / E_{20, \\text{对照}}} = \\frac{E_{20, \\text{对照}}}{E_{20, \\text{阻断}}} $$\n效应细胞数$E$与效靶比$R$以及靶细胞数$T$的关系为$E = R \\times T$。因此，$E_{20} = R_{20} \\times T$，其中$R_{20}$是产生$0.20$比裂解的效靶比。倍数变化的表达式变为：\n$$ \\text{倍数变化} = \\frac{R_{20, \\text{对照}} \\times T}{R_{20, \\text{阻断}} \\times T} = \\frac{R_{20, \\text{对照}}}{R_{20, \\text{阻断}}} $$\n问题现在简化为求出每种条件下的效靶比（$R_{20}$）。我们使用给定的假设，即比裂解率$L$是$x = \\log_{10}(R)$的线性函数。我们应用线性插值法来找到对应于$L=0.20$的$x$值。用于在给定$y$的情况下求$x$的线性插值公式为：\n$$ x = x_1 + (y - y_1) \\frac{x_2 - x_1}{y_2 - y_1} $$\n这里，$x = \\log_{10}(R)$且$y=L$。\n\n**1. 对照条件的计算**\n我们求解$R_{20, \\text{control}}$。目标裂解率为$L=0.20$。从数据中可知，该值位于$L_1=0.14$（此时$R_1=3$）和$L_2=0.31$（此时$R_2=10$）之间。对应的对数点为$x_1 = \\log_{10}(3)$和$x_2 = \\log_{10}(10)=1$。\n我们进行插值计算以求得$x_{20, \\text{control}} = \\log_{10}(R_{20, \\text{control}})$：\n$$ x_{20, \\text{control}} = \\log_{10}(3) + (0.20 - 0.14) \\frac{1 - \\log_{10}(3)}{0.31 - 0.14} $$\n$$ x_{20, \\text{control}} = \\log_{10}(3) + \\frac{0.06}{0.17} (1 - \\log_{10}(3)) $$\n计算该表达式：\n$$ x_{20, \\text{control}} \\approx 0.477121 + \\frac{0.06}{0.17} (1 - 0.477121) \\approx 0.477121 + (0.352941)(0.522879) \\approx 0.661667 $$\n那么，效靶比为：\n$$ R_{20, \\text{control}} = 10^{x_{20, \\text{control}}} \\approx 10^{0.661667} \\approx 4.5885 $$\n\n**2. 阻断条件的计算**\n我们求解$R_{20, \\text{blockade}}$。目标裂解率为$L=0.20$。该值位于$L_1=0.09$（此时$R_1=1$）和$L_2=0.22$（此时$R_2=3$）之间。对应的对数点为$x_1 = \\log_{10}(1)=0$和$x_2 = \\log_{10}(3)$。\n我们进行插值计算以求得$x_{20, \\text{blockade}} = \\log_{10}(R_{20, \\text{blockade}})$：\n$$ x_{20, \\text{blockade}} = 0 + (0.20 - 0.09) \\frac{\\log_{10}(3) - 0}{0.22 - 0.09} $$\n$$ x_{20, \\text{blockade}} = \\frac{0.11}{0.13} \\log_{10}(3) $$\n计算该表达式：\n$$ x_{20, \\text{blockade}} \\approx \\frac{0.11}{0.13} \\times 0.477121 \\approx (0.846154)(0.477121) \\approx 0.403786 $$\n那么，效靶比为：\n$$ R_{20, \\text{blockade}} = 10^{x_{20, \\text{blockade}}} \\approx 10^{0.403786} \\approx 2.5339 $$\n\n**3. 最终倍数变化计算**\n倍数变化是这两个效靶比的比值：\n$$ \\text{倍数变化} = \\frac{R_{20, \\text{control}}}{R_{20, \\text{blockade}}} \\approx \\frac{4.5885}{2.5339} \\approx 1.81085 $$\n根据问题要求，四舍五入到三位有效数字，得到$1.81$。", "answer": "$$\\boxed{1.81}$$", "id": "2875114"}, {"introduction": "NK细胞系统的强大之处不仅在于单个细胞的功能，更在于其整个细胞群体的多样性。为了探索这种系统层面的特性，计算模拟成为不可或缺的工具。最后一个练习 [@problem_id:2875099] 要求我们构建一个计算机程序，模拟一个多样化的NK细胞库如何能够更有效地“覆盖”一个异质性的肿瘤细胞群体。通过将NK细胞的整合信号决策规则转化为定量模型，这项练习展示了计算生物学方法在理解复杂免疫系统行为中的强大威力，并突显了细胞库多样性在免疫监视中的重要作用。", "problem": "构建一个完整、可运行的程序，使用基于第一性原理的整合法则，模拟增加自然杀伤（NK）细胞库多样性如何提高对具有异质性主要组织相容性复合体I类（MHC I）和应激配体表达的肿瘤变体的覆盖率。该模拟必须基于以下基本原理构建：(i) NK细胞整合激活和抑制信号；(ii) MHC I与抑制性受体结合会降低NK细胞的激活（当MHC I水平低时，“自我缺失”会增加激活）；(iii) 应激诱导的配体与激活受体结合会增加NK细胞的激活（“诱导自我”）；(iv) 当净信号超过一个阈值时，激活发生。您的程序必须将这些规则转化为一个依赖于克隆特异性敏感度和肿瘤配体水平的定量决策函数，并且必须计算在一个异质性肿瘤分布中，能被细胞库中至少一个克隆识别（杀死）的肿瘤变体所占的比例。\n\n模型规格：\n- 肿瘤变体由两个连续变量表示：MHC I水平 $m \\in [0,1]$ 和应激配体水平 $s \\in [0,1]$。肿瘤群体的异质性通过为 $m$ 和 $s$ 设置独立的Beta分布来建模，其参数分别为 $(\\beta_m^1,\\beta_m^2)$ 和 $(\\beta_s^1,\\beta_s^2)$。\n- 每个NK克隆 $i$ 由一个激活敏感度 $\\alpha_i > 0$、一个抑制敏感度 $\\kappa_i > 0$ 和一个激活阈值 $\\theta_i \\ge 0$ 来表征。克隆 $i$ 针对肿瘤变体 $(m,s)$ 产生的净信号定义为 $x_i(m,s) = \\alpha_i s - \\kappa_i m - \\theta_i$。当且仅当 $x_i(m,s) > 0$ 时，克隆 $i$ 识别（杀死）该变体。如果任何一个克隆能识别某个变体，则认为该变体被细胞库覆盖。\n- 为了使用单一参数 $D \\in \\mathbb{N}$（不同克隆的数量）对细胞库多样性进行建模，构建一个包含 $D$ 个克隆的集合，这些克隆的 $(\\alpha_i,\\kappa_i)$ 值在一个对抗性权衡关系下，均匀地分布在预设范围 $[\\alpha_{\\min},\\alpha_{\\max}]$ 和 $[\\kappa_{\\min},\\kappa_{\\max}]$ 内：当 $D \\ge 2$ 时，令 $t_j = j/(D-1)$，其中 $j \\in \\{0,1,\\dots,D-1\\}$；当 $D=1$ 时，令 $t_0 = 1/2$。然后定义 $\\alpha_j = \\alpha_{\\min} + t_j(\\alpha_{\\max}-\\alpha_{\\min})$ 和 $\\kappa_j = \\kappa_{\\max} - t_j(\\kappa_{\\max}-\\kappa_{\\min})$。所有克隆共享相同的阈值 $\\theta$。\n- 将覆盖率定义为在整个肿瘤分布上识别事件的期望指示函数，即在 $(m,s) \\in [0,1]^2$ 上对“任何克隆能识别 $(m,s)$”这一事件的指示函数进行积分，并以联合密度（由于独立性，为两个Beta密度的乘积）加权。通过在一个大小为 $G \\times G$ 的均匀网格上使用中点进行黎曼和，来数值近似这个期望值。将覆盖率表示为 $[0,1]$ 范围内的一个小数。\n\n您的程序必须：\n- 实现决策规则 $x_i(m,s) = \\alpha_i s - \\kappa_i m - \\theta$。\n- 根据指定的 $D$, $\\alpha_{\\min}$, $\\alpha_{\\max}$, $\\kappa_{\\min}$, $\\kappa_{\\max}$ 和 $\\theta$ 构建克隆集。\n- 使用 $[0,1]^2$ 上一个 $G \\times G$ 的均匀网格中点，以及参数分别为 $(\\beta_m^1,\\beta_m^2)$ 和 $(\\beta_s^1,\\beta_s^2)$ 的 $m$ 和 $s$ 的Beta概率密度函数，来近似覆盖率。\n- 生成单行输出，其中包含所有请求测试用例的覆盖率，四舍五入到恰好三位小数，并以逗号分隔的列表形式放在方括号内。这些值必须是小数，而不是百分比。\n\n测试套件：\n除特别注明外，所有测试用例均使用 $\\alpha_{\\min} = 0.5$, $\\alpha_{\\max} = 2.0$, $\\kappa_{\\min} = 0.5$, $\\kappa_{\\max} = 2.0$, $\\theta = 0.3$ 和 $G = 121$。\n- 测试 1：$D=1$, $(\\beta_m^1,\\beta_m^2)=(2,2)$, $(\\beta_s^1,\\beta_s^2)=(2,2)$。\n- 测试 2：$D=8$, $(\\beta_m^1,\\beta_m^2)=(2,2)$, $(\\beta_s^1,\\beta_s^2)=(2,2)$。\n- 测试 3：$D=1$, $(\\beta_m^1,\\beta_m^2)=(5,1)$, $(\\beta_s^1,\\beta_s^2)=(1,5)$。\n- 测试 4：$D=8$, $(\\beta_m^1,\\beta_m^2)=(5,1)$, $(\\beta_s^1,\\beta_s^2)=(1,5)$。\n- 测试 5：$D=1$, $(\\beta_m^1,\\beta_m^2)=(1,5)$, $(\\beta_s^1,\\beta_s^2)=(5,1)$。\n- 测试 6：$D=8$, $(\\beta_m^1,\\beta_m^2)=(1,5)$, $(\\beta_s^1,\\beta_s^2)=(5,1)$。\n- 测试 7：$D=4$, $(\\beta_m^1,\\beta_m^2)=(1,1)$, $(\\beta_s^1,\\beta_s^2)=(1,1)$。\n- 测试 8：$D=16$, $(\\beta_m^1,\\beta_m^2)=(1,1)$, $(\\beta_s^1,\\beta_s^2)=(1,1)$，使用 $\\theta=0.6$ 和 $G=151$。\n\n最终输出格式：\n- 您的程序应生成单行输出，按顺序包含测试1到测试8的覆盖率，四舍五入到恰好三位小数，并以逗号分隔的列表形式放在方括号内（例如，$[0.123,0.456,0.789]$）。", "solution": "该问题陈述已经过严格验证，并被确定为有效。它在科学上基于免疫学原理，在数学上是适定的，并为构建计算模型提供了一套完整且无歧义的规范。不存在逻辑矛盾、科学不准确之处或数据缺失。任务是构建一个程序，模拟自然杀伤（NK）细胞库针对异质性肿瘤群体的覆盖情况，这是计算生物学中一个不平凡的问题。\n\n解决方案首先将生物学原理转化为精确的数学框架，其次将此框架实现为数值算法。\n\n首先，我们对模型进行形式化。肿瘤细胞变体的状态由二维特征空间中的一个点 $(m, s) \\in [0,1] \\times [0,1]$ 定义，其中 $m$ 是主要组织相容性复合体I类（MHC I）的水平， $s$ 是应激配体的水平。肿瘤的异质性通过假设 $m$ 和 $s$ 是遵循Beta分布的独立随机变量来建模。$m$ 的概率密度函数是 $p_m(m) = \\text{Beta}(m; \\beta_m^1, \\beta_m^2)$ ，而 $s$ 的概率密度函数是 $p_s(s) = \\text{Beta}(s; \\beta_s^1, \\beta_s^2)$ 。联合概率密度为 $p(m,s) = p_m(m) p_s(s)$ 。Beta分布的概率密度函数（PDF）由以下公式给出：\n$$\nf(x; \\alpha, \\beta) = \\frac{x^{\\alpha-1}(1-x)^{\\beta-1}}{B(\\alpha, \\beta)}\n$$\n其中 $B(\\alpha, \\beta)$ 是Beta函数，用作归一化常数。\n\n接下来，我们对NK细胞库进行建模。该细胞库由 $D$ 个不同的克隆组成，索引为 $j \\in \\{0, 1, \\dots, D-1\\}$ 。每个克隆由其激活敏感度 $\\alpha_j > 0$ 和抑制敏感度 $\\kappa_j > 0$ 定义。所有克隆共享一个共同的激活阈值 $\\theta$ 。敏感度是基于一个对抗性权衡关系构建的。定义一个参数 $t_j = j/(D-1)$ （对于 $D \\ge 2$ ），以及在 $D=1$ 的特殊情况下 $t_0 = 1/2$ 。然后通过在指定范围内的线性插值来确定敏感度：\n$$\n\\alpha_j = \\alpha_{\\min} + t_j(\\alpha_{\\max} - \\alpha_{\\min})\n$$\n$$\n\\kappa_j = \\kappa_{\\max} - t_j(\\kappa_{\\max} - \\kappa_{\\min})\n$$\n克隆 $j$ 从一个肿瘤细胞 $(m,s)$ 接收到的净激活信号是输入的线性整合：\n$$\nx_j(m,s) = \\alpha_j s - \\kappa_j m - \\theta\n$$\n如果这个信号为正，即 $x_j(m,s) > 0$ ，则克隆 $j$ 被激活并杀死该肿瘤细胞。如果至少有一个克隆被激活，则认为该肿瘤细胞被细胞库“覆盖”或识别。令 $\\mathcal{I}(m,s)$ 为此事件的指示函数：\n$$\n\\mathcal{I}(m,s) =\n\\begin{cases}\n1  \\text{if } \\exists j \\in \\{0, \\dots, D-1\\} \\text{ such that } x_j(m,s) > 0 \\\\\n0  \\text{otherwise}\n\\end{cases}\n$$\n总覆盖率 $C$ 是该指示函数在整个肿瘤群体上的期望值，通过在状态空间上进行积分，并由联合概率密度加权计算得出：\n$$\nC = \\mathbb{E}[\\mathcal{I}(m,s)] = \\int_{0}^{1} \\int_{0}^{1} \\mathcal{I}(m,s) p_m(m) p_s(s) \\,dm\\,ds\n$$\n这个积分通常没有简单的解析解。因此，需要进行数值近似。问题指定了在单位正方形 $[0,1]^2$ 上，在一个均匀的 $G \\times G$ 网格上使用黎曼和进行计算。网格单元的维度为 $\\Delta m = \\Delta s = 1/G$ 。我们使用这些单元的中点进行评估：\n$m_k = (k + 0.5)/G$ for $k=0, \\dots, G-1$\n$s_l = (l + 0.5)/G$ for $l=0, \\dots, G-1$\n覆盖率随后通过以下总和来近似：\n$$\nC \\approx \\sum_{k=0}^{G-1} \\sum_{l=0}^{G-1} \\mathcal{I}(m_k, s_l) p_m(m_k) p_s(s_l) (\\Delta m \\Delta s)\n$$\n其中面积元为 $(\\Delta m \\Delta s) = (1/G)^2$ 。\n\n在实现方面，为了效率，必须使用 `numpy` 的矢量化方法。首先，我们生成 $D$ 个克隆参数对 $(\\alpha_j, \\kappa_j)$ 。其次，我们创建两个一维数组，分别表示 $m$ 轴和 $s$ 轴的中点坐标，然后使用 `np.meshgrid` 生成两个形状为 $(G, G)$ 的二维数组 `m_grid` 和 `s_grid` ，其中包含所有网格点的坐标。使用 `scipy.stats.beta.pdf` 为每个网格点计算概率密度 $p_m(m_k)$ 和 $p_s(s_l)$ ，从而得到两个二维数组 `pdf_m` 和 `pdf_s` 。每个网格单元的权重则为 `(pdf_m * pdf_s) / (G*G)` 。\n\n计算上最密集的步骤是为所有 $(k,l)$ 评估 $\\mathcal{I}(m_k, s_l)$ 。这可以使用广播进行矢量化。克隆参数 `alphas` 和 `kappas` （形状为 $(D,)$ ）以及网格坐标 `m_grid` 和 `s_grid` （形状为 $(G,G)$ ）被重塑以兼容广播，例如，`alphas` 重塑为 $(D, 1, 1)$ ，网格重塑为 $(1, G, G)$ 。所有克隆在所有网格点上的净信号可以通过一次操作计算出来：\n`signals = alphas[:, None, None] * s_grid[None, :, :] - kappas[:, None, None] * m_grid[None, :, :] - theta`\n这将产生一个形状为 $(D, G, G)$ 的三维数组。然后，沿克隆轴（轴0）应用逻辑或运算 `np.any(signals > 0, axis=0)` ，以计算形状为 $(G, G)$ 的指示数组 $\\mathcal{I}(m_k, s_l)$ 。最后，总覆盖率是该指示数组与预先计算的权重数组的逐元素乘积之和。对每个测试用例重复此过程。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import beta\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print the results.\n    \"\"\"\n    \n    # Common parameters for tests 1-7\n    common_params = {\n        'alpha_min': 0.5, 'alpha_max': 2.0,\n        'kappa_min': 0.5, 'kappa_max': 2.0,\n        'theta': 0.3, 'G': 121\n    }\n\n    test_cases = [\n        {'D': 1, 'beta_m': (2, 2), 'beta_s': (2, 2), **common_params},\n        {'D': 8, 'beta_m': (2, 2), 'beta_s': (2, 2), **common_params},\n        {'D': 1, 'beta_m': (5, 1), 'beta_s': (1, 5), **common_params},\n        {'D': 8, 'beta_m': (5, 1), 'beta_s': (1, 5), **common_params},\n        {'D': 1, 'beta_m': (1, 5), 'beta_s': (5, 1), **common_params},\n        {'D': 8, 'beta_m': (1, 5), 'beta_s': (5, 1), **common_params},\n        {'D': 4, 'beta_m': (1, 1), 'beta_s': (1, 1), **common_params},\n        # Test 8 has custom parameters\n        {\n            'D': 16, 'beta_m': (1, 1), 'beta_s': (1, 1),\n            'alpha_min': 0.5, 'alpha_max': 2.0,\n            'kappa_min': 0.5, 'kappa_max': 2.0,\n            'theta': 0.6, 'G': 151\n        },\n    ]\n\n    results = []\n    for params in test_cases:\n        coverage = calculate_coverage(**params)\n        results.append(coverage)\n    \n    # Format the output as specified: a list of strings rounded to 3 decimal places.\n    formatted_results = [f'{r:.3f}' for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef calculate_coverage(D, beta_m, beta_s, alpha_min, alpha_max, kappa_min, kappa_max, theta, G):\n    \"\"\"\n    Calculates the NK cell repertoire coverage for a given set of parameters.\n\n    Args:\n        D (int): Number of distinct NK clones.\n        beta_m (tuple): Parameters (a, b) for the Beta distribution of MHC I levels.\n        beta_s (tuple): Parameters (a, b) for the Beta distribution of stress-ligand levels.\n        alpha_min (float): Minimum activating sensitivity.\n        alpha_max (float): Maximum activating sensitivity.\n        kappa_min (float): Minimum inhibitory sensitivity.\n        kappa_max (float): Maximum inhibitory sensitivity.\n        theta (float): Activation threshold.\n        G (int): Grid size for numerical integration.\n\n    Returns:\n        float: The calculated coverage, a value between 0 and 1.\n    \"\"\"\n    \n    # Step 1: Generate NK clone repertoire\n    if D == 1:\n        t = np.array([0.5])\n    else:\n        t = np.linspace(0, 1, num=D)\n    \n    alphas = alpha_min + t * (alpha_max - alpha_min)\n    kappas = kappa_max - t * (kappa_max - kappa_min)\n\n    # Step 2: Set up the numerical grid\n    h = 1.0 / G\n    grid_coords = np.linspace(0, 1, num=G, endpoint=False) + h / 2.0\n    m_grid, s_grid = np.meshgrid(grid_coords, grid_coords)\n\n    # Step 3: Calculate weights from probability density functions\n    pdf_m = beta.pdf(m_grid, a=beta_m[0], b=beta_m[1])\n    pdf_s = beta.pdf(s_grid, a=beta_s[0], b=beta_s[1])\n    \n    # The area element dA = dm * ds\n    dA = h * h\n    weights = pdf_m * pdf_s * dA\n\n    # Step 4: Evaluate recognition condition for all clones and grid points\n    # Use broadcasting for efficiency.\n    # alphas -> (D, 1, 1)\n    # s_grid -> (1, G, G)\n    # kappas -> (D, 1, 1)\n    # m_grid -> (1, G, G)\n    # The result 'signals' will have shape (D, G, G)\n    signals = (alphas[:, np.newaxis, np.newaxis] * s_grid[np.newaxis, :, :] - \n               kappas[:, np.newaxis, np.newaxis] * m_grid[np.newaxis, :, :] - \n               theta)\n    \n    # A tumor variant is recognized if ANY clone's signal is > 0.\n    # This reduces the D-dimension to a boolean (G, G) grid.\n    recognition_grid = np.any(signals > 0, axis=0)\n\n    # Step 5: Compute the coverage by summing weights where recognition occurs.\n    coverage = np.sum(recognition_grid * weights)\n    \n    return coverage\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2875099"}]}