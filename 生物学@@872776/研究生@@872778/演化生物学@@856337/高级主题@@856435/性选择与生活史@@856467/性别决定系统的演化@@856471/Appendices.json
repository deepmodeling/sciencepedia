{"hands_on_practices": [{"introduction": "在演化生物学中，一个核心问题是生物体如何做出最优的繁殖决策。Trivers-Willard假说提出，当父母的状况（如健康、资源）影响其后代的繁殖成功率，并且这种影响对不同性别是不同的时候，自然选择会偏爱那些能够根据自身状况调整后代性别比的父母。这项练习 [@problem_id:2709580] 提供了一个经典的场景，要求你通过数学建模，推导出决定生产雄性而非雌性后代的最佳“转换点”，这是建立演化模型的一项基本技能。", "problem": "在一个一夫多妻制的脊椎动物物种中，母体的生理状况 $c \\in [0,1]$ 会影响后代的预期繁殖成功率，其衡量标准为单个后代所产生的孙代的预期数量。经验研究表明，雄性的繁殖成功率比雌性的繁殖成功率对状况更敏感。假设这由函数 $W_{m}(c) = \\lambda c^{\\alpha}$ 和 $W_{f}(c) = \\mu c^{\\beta}$ 描述，其中 $\\lambda > 0$，$\\mu > 0$ 且 $\\alpha > \\beta > 0$。繁殖种群中母体的状况分布为 $g(c) = \\theta c^{\\theta - 1}$，定义在区间 $[0,1]$ 上，其中 $\\theta > 0$。母亲能观察到自身的 $c$ 值，但观察不到其他个体的 $c$ 值。性别分配策略由基因编码为一个单一阈值 $t \\in (0,1)$：如果 $c \\ge t$，母亲产生一个雄性后代；如果 $c  t$，则产生一个雌性后代。假设种群数量大且均匀混合，因此繁殖成功率函数 $W_{m}(c)$ 和 $W_{f}(c)$ 在与稀有突变策略相关的边际上不具有频率依赖性，并且一个策略对未来世代的预期贡献与其预期的孙代数量成正比。\n\n从期望值的定义以及“对于稀有突变体，自然选择会偏好在 $c$ 的整个分布范围内使预期孙代数量最大化的策略”这一原理出发，推导出使采用阈值 $t$ 的稀有突变体的预期孙代数量最大化的阈值 $t^{\\ast}$。假设参数值满足 $0  \\mu  \\lambda$ 和 $\\alpha > \\beta > 0$，从而最优解是位于 $(0,1)$ 内的内部解。\n\n请以 $t^{\\ast}$ 的单一闭式表达式给出你的答案。不需要进行数值近似。最终答案中不应包含单位。如果在推导过程中引入任何角度，则必须以弧度为单位。最终答案必须是单一的闭式解析表达式。", "solution": "所提出的问题是演化博弈论中的一个经典练习，具体涉及关于性别分配的 Trivers-Willard 假说。该问题具有科学依据，提法严谨，并包含了进行严格求解所需的所有必要信息。因此，它被认为是有效的。\n\n目标是找到性别分配阈值 $t^{\\ast}$，该阈值能使种群中一个稀有突变策略的预期孙代数量最大化。一个生理状况为 $c$ 的母亲采用一个由阈值 $t \\in (0,1)$ 定义的策略：如果她的状况 $c \\ge t$，她就产生一个雄性后代；如果她的状况 $c  t$，她就产生一个雌性后代。\n\n设 $E(t)$ 为采用此策略的个体所产生的孙代总数的期望值。这个期望值是通过在母体状况分布 $g(c)$ 上对产生雄性后代与雌性后代的适应度回报进行积分来计算的。由状况为 $c$ 的母亲所产生的雄性后代的适应度为 $W_{m}(c) = \\lambda c^{\\alpha}$，雌性后代的适应度为 $W_{f}(c) = \\mu c^{\\beta}$。母体状况的分布由 $g(c) = \\theta c^{\\theta - 1}$ 给出，其中 $c \\in [0,1]$。\n\n预期孙代数量 $E(t)$ 是产生雌性后代（当 $c  t$ 时）的预期适应度与产生雄性后代（当 $c \\ge t$ 时）的预期适应度之和。这可以表示为以下积分：\n$$\nE(t) = \\int_{0}^{t} W_{f}(c) g(c) \\,dc + \\int_{t}^{1} W_{m}(c) g(c) \\,dc\n$$\n\n为了找到使 $E(t)$ 最大化的最优阈值 $t^{\\ast}$，我们必须对 $E(t)$ 关于 $t$ 求导，并将导数设为零。我们应用莱布尼茨积分法则（微积分基本定理的一个推论），该法则表明 $\\frac{d}{dx} \\int_{a}^{x} f(y) \\,dy = f(x)$ 和 $\\frac{d}{dx} \\int_{x}^{b} f(y) \\,dy = -f(x)$。\n\n将此法则应用于我们对 $E(t)$ 的表达式：\n$$\n\\frac{dE(t)}{dt} = \\frac{d}{dt} \\left( \\int_{0}^{t} W_{f}(c) g(c) \\,dc \\right) + \\frac{d}{dt} \\left( \\int_{t}^{1} W_{m}(c) g(c) \\,dc \\right)\n$$\n$$\n\\frac{dE(t)}{dt} = W_{f}(t) g(t) - W_{m}(t) g(t)\n$$\n\n我们可以提出公因子 $g(t)$：\n$$\n\\frac{dE(t)}{dt} = \\left( W_{f}(t) - W_{m}(t) \\right) g(t)\n$$\n\n为求临界点，我们将此导数设为零：\n$$\n\\left( W_{f}(t) - W_{m}(t) \\right) g(t) = 0\n$$\n\n由于分布 $g(t) = \\theta t^{\\theta - 1}$ 对于任何 $t \\in (0,1)$ 都严格为正（给定 $\\theta > 0$），因此极值条件简化为：\n$$\nW_{f}(t) = W_{m}(t)\n$$\n\n这是性别分配理论中经典的转换点条件：最优策略是在适应度回报相等的点上，从产生一种性别转换到产生另一种性别。现在我们将 $W_{f}$ 和 $W_{m}$ 的给定函数形式代入此方程：\n$$\n\\mu t^{\\beta} = \\lambda t^{\\alpha}\n$$\n\n我们寻找一个解 $t^{\\ast} \\in (0,1)$。我们可以用 $t^{\\beta}$ 除以等式两边，这是允许的，因为 $t \\neq 0$：\n$$\n\\mu = \\lambda t^{\\alpha - \\beta}\n$$\n\n现在，我们解出 $t$：\n$$\nt^{\\alpha - \\beta} = \\frac{\\mu}{\\lambda}\n$$\n\n将两边同时取 $\\frac{1}{\\alpha - \\beta}$ 次幂，得到最优阈值 $t^{\\ast}$。这是可行的，因为问题陈述中给出了 $\\alpha > \\beta$，所以 $\\alpha - \\beta > 0$。\n$$\nt^{\\ast} = \\left( \\frac{\\mu}{\\lambda} \\right)^{\\frac{1}{\\alpha - \\beta}}\n$$\n\n问题指明在 $(0,1)$ 中存在一个内部解，这与给定的参数 $0  \\mu  \\lambda$ 相符，这保证了 $0  \\frac{\\mu}{\\lambda}  1$，因此 $0  t^{\\ast}  1$。为确认这是一个最大值，我们检查二阶导数条件。在 $t=t^{\\ast}$ 处，$\\frac{d^2E(t)}{dt^2}$ 的符号由 $W'_{f}(t^{\\ast}) - W'_{m}(t^{\\ast})$ 的符号决定。最大值要求此项为负。$W'_{m}(c) = \\lambda \\alpha c^{\\alpha - 1}$ 且 $W'_{f}(c) = \\mu \\beta c^{\\beta - 1}$。条件变为 $\\mu \\beta (t^{\\ast})^{\\beta - 1}  \\lambda \\alpha (t^{\\ast})^{\\alpha - 1}$。代入 $\\mu = \\lambda (t^{\\ast})^{\\alpha - \\beta}$ 得到 $\\lambda \\beta (t^{\\ast})^{\\alpha-1}  \\lambda \\alpha (t^{\\ast})^{\\alpha-1}$，这简化为 $\\beta  \\alpha$。这在问题陈述中已给出（$\\alpha > \\beta > 0$），证实了 $t^{\\ast}$ 确实是一个最大值。", "answer": "$$\\boxed{\\left( \\frac{\\mu}{\\lambda} \\right)^{\\frac{1}{\\alpha - \\beta}}}$$", "id": "2709580"}, {"introduction": "理论模型为我们理解自然世界提供了框架，但它们的价值最终取决于它们预测和解释真实数据的能力。这项练习 [@problem_id:2709542] 让你从理论走向数据分析，挑战你比较两种关于性别比演化的竞争模型：经典的费雪（Fisherian）模型和局域配偶竞争（Local Mate Competition, LMC）模型。你将使用基于似然的方法来判断哪个模型能更好地解释一组假设的观测数据，这是现代演化生物学研究中的一项核心技能。", "problem": "一种单倍二倍性寄生蜂在空间上不相连的斑块上产下后代。在每个斑块上，已知数量的雌始祖 $\\{N_i\\}$ 进行产卵，其后代在扩散前进行交配（本地交配），其程度由参数 $\\phi \\in [0,1]$ 量化，其中 $\\phi = 0$ 对应于完全随机交配（panmixia），$\\phi = 1$ 对应于完全本地交配。假设遵循以下被广泛接受的基本原则：\n- 在 Fisherian 随机交配（对雄性和雌性后代的投入相等）下，每个后代的性别是一个独立的伯努利试验，雄性概率为 $p_F = \\frac{1}{2}$。\n- 在完全本地交配竞争（LMC）下，对于有 $N_i$ 个雌始祖均等贡献的单倍二倍体，斑块 $i$ 上的进化稳定雄性比例为 $a_i = \\frac{N_i - 1}{2 N_i}$。\n- 在程度为 $\\phi$ 的部分 LMC 下，斑块 $i$ 上的实际雄性概率是凸组合 $p_i(\\phi) = (1 - \\phi)\\,\\frac{1}{2} + \\phi\\, a_i$。\n\n在每个斑块 $i$ 内，假设孵育数量为 $B_i$，观察到的雄性数量为 $m_i$（因此观察到的雌性数量为 $B_i - m_i$）。假设在给定 $p_i$ 的条件下，斑块内部和斑块之间的后代性别是独立的，并且斑块内的计数遵循二项抽样模型。\n\n您观察到 $n = 6$ 个斑块，数据如下：\n- 斑块 1: $N_1 = 1$, $B_1 = 50$, $m_1 = 8$.\n- 斑块 2: $N_2 = 2$, $B_2 = 48$, $m_2 = 16$.\n- 斑块 3: $N_3 = 3$, $B_3 = 52$, $m_3 = 20$.\n- 斑块 4: $N_4 = 4$, $B_4 = 47$, $m_4 = 19$.\n- 斑块 5: $N_5 = 5$, $B_5 = 55$, $m_5 = 24$.\n- 斑块 6: $N_6 = 3$, $B_6 = 53$, $m_6 = 21$.\n\n任务：\n1) 从二项抽样模型和上述定义出发，推导数据在 Fisherian 模型下的对数似然 $\\ell_F$ 和在部分 LMC 模型下的对数似然 $\\ell_{LMC}(\\phi)$。\n2) 找出在 $\\phi \\in [0,1]$ 范围内最大化 $\\ell_{LMC}(\\phi)$ 的最大似然估计 $\\hat{\\phi}$。\n3) 计算似然比检验统计量\n$$\n\\Lambda \\;=\\; 2\\big(\\ell_{LMC}(\\hat{\\phi}) - \\ell_F\\big).\n$$\n\n报告 $\\Lambda$ 的数值，四舍五入到四位有效数字。不要报告任何单位。", "solution": "所述问题具有科学依据，提法恰当且客观。它基于演化性别分配理论的既定原则和标准统计方法。数据和参数完整且一致。因此，该问题被认为是有效的，并将提供解答。\n\n分析按照问题陈述分三个阶段进行。首先，我们推导对数似然函数。其次，我们确定目标参数的最大似然估计。第三，我们计算似然比检验统计量。\n\n**1. 对数似然函数**\n\n基本模型是针对斑块 $i$ 上大小为 $B_i$ 的孵育群体中雄性数量 $m_i$ 的二项抽样。单个斑块的似然由二项概率质量函数给出：\n$$\nL_i(p_i) = \\binom{B_i}{m_i} p_i^{m_i} (1 - p_i)^{B_i - m_i}\n$$\n其中 $p_i$ 是斑块 $i$ 上后代为雄性的概率。\n\n所有 $n$ 个独立斑块的总似然是个体似然的乘积，$L = \\prod_{i=1}^{n} L_i(p_i)$。总对数似然 $\\ell$ 是个体对数似然的和：\n$$\n\\ell = \\sum_{i=1}^{n} \\ln\\left(L_i(p_i)\\right) = \\sum_{i=1}^{n} \\left[ \\ln\\binom{B_i}{m_i} + m_i \\ln(p_i) + (B_i - m_i) \\ln(1 - p_i) \\right]\n$$\n\n我们现在为所考虑的两个模型指定这种一般形式。\n\n**Fisherian 模型 ($\\ell_F$)**:\n在 Fisherian 随机交配模型下，所有斑块的雄性比例是恒定的，$p_i = p_F = \\frac{1}{2}$。将此代入通用对数似然表达式中，得到：\n$$\n\\ell_F = \\sum_{i=1}^{n} \\left[ \\ln\\binom{B_i}{m_i} + m_i \\ln\\left(\\frac{1}{2}\\right) + (B_i - m_i) \\ln\\left(\\frac{1}{2}\\right) \\right]\n$$\n这可以简化为：\n$$\n\\ell_F = \\sum_{i=1}^{n} \\ln\\binom{B_i}{m_i} + \\sum_{i=1}^{n} (m_i + B_i - m_i) \\ln\\left(\\frac{1}{2}\\right) = \\sum_{i=1}^{n} \\ln\\binom{B_i}{m_i} - \\ln(2) \\sum_{i=1}^{n} B_i\n$$\n\n**部分本地交配竞争 (LMC) 模型 ($\\ell_{LMC}(\\phi)$)**:\n在部分 LMC 模型下，斑块 $i$ 上的雄性概率是本地交配参数 $\\phi$ 和雌始祖数量 $N_i$ 的函数：\n$$\np_i(\\phi) = (1 - \\phi)\\,\\frac{1}{2} + \\phi\\, a_i\n$$\n其中 $a_i = \\frac{N_i - 1}{2 N_i}$ 是在完全 LMC 下的进化稳定雄性比例。将 $p_i(\\phi)$ 代入通用对数似然表达式中，得到部分 LMC 模型的对数似然：\n$$\n\\ell_{LMC}(\\phi) = \\sum_{i=1}^{n} \\left[ \\ln\\binom{B_i}{m_i} + m_i \\ln(p_i(\\phi)) + (B_i - m_i) \\ln(1 - p_i(\\phi)) \\right]\n$$\n\n**2. $\\phi$ 的最大似然估计**\n\n为了找到最大似然估计 (MLE) $\\hat{\\phi}$，我们在区间 $\\phi \\in [0,1]$ 上对 $\\ell_{LMC}(\\phi)$ 关于 $\\phi$ 进行最大化。这等同于最大化对数似然中依赖于 $\\phi$ 的部分：\n$$\n\\ell_{LMC}^*(\\phi) = \\sum_{i=1}^{n} \\left[ m_i \\ln(p_i(\\phi)) + (B_i - m_i) \\ln(1 - p_i(\\phi)) \\right]\n$$\n我们求其关于 $\\phi$ 的导数并令其为零。首先，我们求 $p_i(\\phi)$ 的导数：\n$$\n\\frac{dp_i(\\phi)}{d\\phi} = \\frac{d}{d\\phi} \\left( \\frac{1}{2} + \\phi\\left(a_i - \\frac{1}{2}\\right) \\right) = a_i - \\frac{1}{2}\n$$\n对数似然的导数则为：\n$$\n\\frac{d\\ell_{LMC}^*(\\phi)}{d\\phi} = \\sum_{i=1}^{n} \\left[ \\frac{m_i}{p_i(\\phi)} \\frac{dp_i(\\phi)}{d\\phi} - \\frac{B_i - m_i}{1-p_i(\\phi)} \\frac{dp_i(\\phi)}{d\\phi} \\right] = \\sum_{i=1}^{n} \\left(\\frac{m_i}{p_i(\\phi)} - \\frac{B_i - m_i}{1 - p_i(\\phi)}\\right) \\left(a_i - \\frac{1}{2}\\right)\n$$\n将此导数设为零，得到得分方程：\n$$\n\\sum_{i=1}^{n} \\frac{m_i - B_i p_i(\\phi)}{p_i(\\phi)(1 - p_i(\\phi))} \\left(a_i - \\frac{1}{2}\\right) = 0\n$$\n这是一个关于 $\\phi$ 的非线性方程，必须通过数值方法求解。对数似然关于 $\\phi$ 的二阶导数是非正的，这确保了得分方程的任何解都对应于一个最大值。对于给定的数据，我们计算 $a_i$ 的值：\n$a_1 = \\frac{1-1}{2(1)} = 0$\n$a_2 = \\frac{2-1}{2(2)} = \\frac{1}{4} = 0.25$\n$a_3 = \\frac{3-1}{2(3)} = \\frac{1}{3}$\n$a_4 = \\frac{4-1}{2(4)} = \\frac{3}{8} = 0.375$\n$a_5 = \\frac{5-1}{2(5)} = \\frac{2}{5} = 0.4$\n$a_6 = \\frac{3-1}{2(3)} = \\frac{1}{3}$\n\n注意，对于斑块 1，$a_1=0$。由于 $m_1=8 > 0$，如果 $p_1(\\phi)=0$，似然值为零。当 $\\phi=1$ 时会发生这种情况，因为 $p_1(1) = 0$。因此，$\\ell_{LMC}(1) = -\\infty$，并且 MLE $\\hat{\\phi}$ 必须在区间 $[0,1)$ 内。得分方程的数值解给出 MLE：\n$$\n\\hat{\\phi} \\approx 0.6707\n$$\n\n**3. 似然比检验统计量**\n\n似然比检验统计量 $\\Lambda$ 定义为：\n$$\n\\Lambda = 2\\big(\\ell_{LMC}(\\hat{\\phi}) - \\ell_F\\big)\n$$\n代入对数似然的表达式：\n$$\n\\Lambda = 2 \\left( \\sum_{i=1}^{n} \\left[ \\ln\\binom{B_i}{m_i} + m_i \\ln(p_i(\\hat{\\phi})) + (B_i - m_i) \\ln(1 - p_i(\\hat{\\phi})) \\right] - \\sum_{i=1}^{n} \\left[ \\ln\\binom{B_i}{m_i} - B_i \\ln(2) \\right] \\right)\n$$\n组合项 $\\ln\\binom{B_i}{m_i}$ 被消掉：\n$$\n\\Lambda = 2 \\left( \\sum_{i=1}^{n} \\left[ m_i \\ln(p_i(\\hat{\\phi})) + (B_i - m_i) \\ln(1 - p_i(\\hat{\\phi})) \\right] + \\ln(2) \\sum_{i=1}^{n} B_i \\right)\n$$\n这可以重新整理以便更直接地计算：\n$$\n\\Lambda = 2 \\sum_{i=1}^{n} \\left[ m_i \\ln(p_i(\\hat{\\phi})) + (B_i - m_i) \\ln(1 - p_i(\\hat{\\phi})) + B_i \\ln(2) \\right]\n$$\n$$\n\\Lambda = 2 \\sum_{i=1}^{n} \\left[ m_i \\ln(2p_i(\\hat{\\phi})) + (B_i - m_i) \\ln(2(1 - p_i(\\hat{\\phi}))) \\right]\n$$\n使用 $\\hat{\\phi} \\approx 0.6707$，我们首先计算预测的雄性概率 $p_i(\\hat{\\phi})$：\n$p_1(\\hat{\\phi}) \\approx 0.1647$\n$p_2(\\hat{\\phi}) \\approx 0.3323$\n$p_3(\\hat{\\phi}) \\approx 0.3882$\n$p_4(\\hat{\\phi}) \\approx 0.4162$\n$p_5(\\hat{\\phi}) \\approx 0.4329$\n$p_6(\\hat{\\phi}) \\approx 0.3882$\n\n我们现在为每个斑块 $i$ 计算加和：\n对于 $i=1$: $2[8 \\ln(2 \\times 0.1647) + (50-8) \\ln(2 \\times (1-0.1647))] \\approx 2[12.67] = 25.34$\n对于 $i=2$: $2[16 \\ln(2 \\times 0.3323) + (48-16) \\ln(2 \\times (1-0.3323))] \\approx 2[2.719] = 5.438$\n对于 $i=3$: $2[20 \\ln(2 \\times 0.3882) + (52-20) \\ln(2 \\times (1-0.3882))] \\approx 2[1.397] = 2.794$\n对于 $i=4$: $2[19 \\ln(2 \\times 0.4162) + (47-19) \\ln(2 \\times (1-0.4162))] \\approx 2[0.853] = 1.706$\n对于 $i=5$: $2[24 \\ln(2 \\times 0.4329) + (55-24) \\ln(2 \\times (1-0.4329))] \\approx 2[0.447] = 0.894$\n对于 $i=6$: $2[21 \\ln(2 \\times 0.3882) + (53-21) \\ln(2 \\times (1-0.3882))] \\approx 2[1.144] = 2.288$\n\n将这些贡献相加，得到 $\\Lambda$ 的总值：\n$$\n\\Lambda \\approx 25.34 + 5.438 + 2.794 + 1.706 + 0.894 + 2.288 \\approx 38.46\n$$\n使用更高精度的中间计算得出 $\\Lambda \\approx 38.4617$。四舍五入到四位有效数字，结果是 $38.46$。", "answer": "$$\\boxed{38.46}$$", "id": "2709542"}, {"introduction": "除了在种群内部研究性别分配策略，我们还可以在更宏大的演化尺度上探究性别决定系统本身的演变。这项练习 [@problem_id:2709560] 将介绍系统发育比较方法，具体来说，是使用连续时间马尔可夫链（CTMC）来模拟不同系统（如同态与异态性染色体）之间的转变。通过在系统发育树上进行演化模拟，并将其与数据进行比较，你将练习评估宏观演化模型的充分性，这是理解生物多样性起源的关键一步。", "problem": "一个基于有根系统发育树的连续时间马尔可夫链 (CTMC) 可以模拟性染色体同形与异形随时间转换的过程。考虑一个状态空间为 $\\{0,1\\}$ 的双态 CTMC，其中状态 $0$ 表示同形，状态 $1$ 表示异形。该过程沿着一个已知分支长度的、有根的系统发育树演化。其瞬时速率矩阵为\n$$\n\\mathbf{Q} \\;=\\;\n\\begin{pmatrix}\n- q_{01}  q_{01} \\\\\nq_{10}  - q_{10}\n\\end{pmatrix},\n$$\n其中 $q_{01} \\ge 0$ 是从同形到异形的转换速率，$q_{10} \\ge 0$ 是从异形到同形的转换速率。对于一个长度为 $t \\ge 0$ 的分支，其转移概率矩阵为 $\\mathbf{P}(t) = \\exp(\\mathbf{Q} t)$，其中 $\\exp$ 表示矩阵指数。根节点状态从一个指定的先验分布 $\\boldsymbol{\\pi} = (\\pi_0, \\pi_1)$ 中抽取，其中 $\\pi_0 \\ge 0$、$\\pi_1 \\ge 0$ 且 $\\pi_0 + \\pi_1 = 1$。该过程从根节点传播至末端节点，对于每个分支，使用 $\\mathbf{P}(t)$ 在给定父节点状态的情况下独立抽样子节点状态。我们关注的汇总统计量是末端异形的比例，\n$$\n\\hat{p} \\;=\\; \\frac{1}{|L|} \\sum_{i \\in L} \\mathbb{I}\\{X_i = 1\\},\n$$\n其中 $L$ 是末端节点集合，$X_i$ 是末端节点 $i$ 的状态。给定一个包含 $|L|$ 个末端节点中 $k_{\\mathrm{emp}}$ 个异形末端节点的经验数据集，其经验比例为 $\\hat{p}_{\\mathrm{emp}} = k_{\\mathrm{emp}} / |L|$（将此比例表示为小数，而非百分比）。\n\n可以通过在指定模型下进行模拟的后验预测检验来评估模型关于此汇总统计量的充分性。具体而言，在给定的系统发育树上模拟 $M$ 个独立的数据集，计算出 $M$ 个模拟比例 $\\{\\hat{p}^{(m)}\\}_{m=1}^M$，计算模拟均值 $\\bar{p} = \\frac{1}{M} \\sum_{m=1}^M \\hat{p}^{(m)}$，然后计算双侧尾部概率\n$$\np\\text{-value} \\;=\\; \\frac{1}{M} \\sum_{m=1}^M \\mathbb{I}\\Big\\{\\, \\big| \\hat{p}^{(m)} - \\bar{p} \\big| \\;\\ge\\; \\big| \\hat{p}_{\\mathrm{emp}} - \\bar{p} \\big| \\,\\Big\\}。\n$$\n这将产生一个在 $[0,1]$ 区间内的值，用以量化经验统计量相对于模型下的模拟分布的极端程度。\n\n编写一个程序，为下方的每个测试用例执行以下步骤：构建 $\\mathbf{Q}$，为每个分支长度 $t$ 计算 $\\mathbf{P}(t)$，从根先验 $\\boldsymbol{\\pi}$ 开始沿系统发育树模拟 $M$ 个数据集，计算模拟比例 $\\{\\hat{p}^{(m)}\\}_{m=1}^M$，然后返回如上定义的 $p$ 值。您的程序必须为每个测试用例输出一个 $p$ 值。\n\n系统发育树以一组从父节点到子节点的有向边及其相关分支长度、根节点索引和末端节点索引集的形式提供。所有索引均为整数，分支长度为非负实数。为确保模拟的可复现性，每个测试用例应使用指定的随机种子。这里没有物理单位；分支长度是 CTMC 中的无量纲时间。\n\n测试套件：\n- 测试用例 A (正常路径，平衡树，中等速率):\n  - 边: $E_A = \\{(0,1,1.0),\\,(0,2,1.2),\\,(1,3,0.7),\\,(1,4,0.8),\\,(2,5,0.5),\\,(2,6,0.6)\\}$。\n  - 根: $r_A = 0$。\n  - 末端: $L_A = \\{3,4,5,6\\}$。\n  - 速率: $q_{01} = 0.04$, $q_{10} = 0.02$。\n  - 根先验: $\\boldsymbol{\\pi}_A = (0.6,\\,0.4)$。\n  - 模拟次数: $M_A = 2000$。\n  - 经验异形计数: $k_A = 2$。\n  - 随机种子: $s_A = 42$。\n- 测试用例 B (边缘情况，零长度分支，对同形的强偏向):\n  - 边: $E_B = \\{(0,1,0.0),\\,(0,2,0.9),\\,(1,3,1.1),\\,(1,4,1.3)\\}$。\n  - 根: $r_B = 0$。\n  - 末端: $L_B = \\{2,3,4\\}$。\n  - 速率: $q_{01} = 0.005$, $q_{10} = 0.5$。\n  - 根先验: $\\boldsymbol{\\pi}_B = (0.9,\\,0.1)$。\n  - 模拟次数: $M_B = 2000$。\n  - 经验异形计数: $k_B = 0$。\n  - 随机种子: $s_B = 123$。\n- 测试用例 C (边界情况，不可逆的异形获得):\n  - 边: $E_C = \\{(0,1,0.5),\\,(0,2,0.5),\\,(1,3,0.5),\\,(1,4,0.5),\\,(2,5,0.5),\\,(2,6,0.5)\\}$。\n  - 根: $r_C = 0$。\n  - 末端: $L_C = \\{3,4,5,6\\}$。\n  - 速率: $q_{01} = 0.1$, $q_{10} = 0.0$。\n  - 根先验: $\\boldsymbol{\\pi}_C = (1.0,\\,0.0)$。\n  - 模拟次数: $M_C = 2000$。\n  - 经验异形计数: $k_C = 3$。\n  - 随机种子: $s_C = 2025$。\n\n您的程序应生成单行输出，其中包含一个方括号括起来的逗号分隔列表（例如，$[\\text{x},\\text{y},\\text{z}]$），列表中的每个条目是对应测试用例的 $p$ 值，四舍五入到 $6$ 位小数。所有比例必须是小数，而不是百分比。不涉及角度，无需指定为弧度或度。", "solution": "所述问题是有效的。它提出了一个在系统发育比较方法领域中定义明确的计算练习，其基础是树上连续时间马尔可夫链的标准理论。其参数和目标都以足够的清晰度和精确度被指定，从而能够得到一个唯一且可验证的解。问题的所有组成部分——模型、模拟过程和统计检验——都是计算进化生物学中的标准元素。因此，我们将着手构建解决方案。\n\n问题的核心是执行一次后验预测检验，以评估一个双态连续时间马尔可夫链 (CTMC) 性状演化模型在给定系统发育树上的充分性。这两个状态是 $\\{0, 1\\}$，分别代表同形和异形。\n\n首先，我们定义这个双态模型的瞬时速率矩阵 $\\mathbf{Q}$：\n$$\n\\mathbf{Q} \\;=\\;\n\\begin{pmatrix}\n- q_{01}  q_{01} \\\\\nq_{10}  - q_{10}\n\\end{pmatrix}\n$$\n其中 $q_{01}$ 是从状态 $0$ 到状态 $1$ 的转换速率，$q_{10}$ 是从状态 $1$ 到状态 $0$ 的转换速率。每个测试用例都给定了这些速率。\n\n该过程沿着一个有根系统发育树的分支进行演化。对于一个长度为 $t$ 的分支，转移概率矩阵 $\\mathbf{P}(t)$ 给出在时间 $t$ 内从状态 $i$ 转移到状态 $j$ 的概率。该矩阵是速率矩阵乘以时间后的指数：\n$$\n\\mathbf{P}(t) \\;=\\; \\exp(\\mathbf{Q} t) \\;=\\; \\begin{pmatrix} P_{00}(t)  P_{01}(t) \\\\ P_{10}(t)  P_{11}(t) \\end{pmatrix}\n$$\n这里，$P_{ij}(t)$ 是在起始状态为 $i$ 的条件下，结束状态为 $j$ 的概率。虽然这个矩阵指数存在解析解，但在 $q_{01} + q_{10} = 0$ 的情况下需要特殊处理。为确保数值稳定性和通用性，我们将使用一个数值矩阵指数函数来计算 $\\mathbf{P}(t)$，具体来说是 `scipy.linalg.expm`，这是一个适用于此目的的稳健算法。\n\n在系统发育树上模拟单个数据集的过程如下：\n1.  **表示系统发育树**：系统发育树以边集 $(u, v, t)$ 的形式给出，其中 $u$ 是 $v$ 的父节点，$t$ 是分支长度。首先将其转换为邻接表表示。这是一个将每个父节点映射到其子节点列表及相应分支长度的字典。\n2.  **抽样根节点状态**：从指定的先验分布 $\\boldsymbol{\\pi} = (\\pi_0, \\pi_1)$ 中抽取根节点的状态。抽取一个伪随机数 $u \\sim U(0,1)$；如果 $u  \\pi_0$，根状态为 $0$，否则为 $1$。\n3.  **沿树向下传播状态**：从根节点开始，采用一种树遍历算法，如广度优先搜索 (BFS)。对于遍历中的每个节点，其状态被用来决定其子节点的状态。对于一个状态为 $i$ 的父节点和一个由长度为 $t$ 的分支连接的子节点，子节点的状态从 $\\mathbf{P}(t)$ 的第 $i$ 行给出的分布 $(P_{i0}(t), P_{i1}(t))$ 中抽样。这同样通过抽取一个伪随机数来实现。\n4.  **记忆化**：为了优化计算，每个唯一分支长度 $t$ 的转移矩阵 $\\mathbf{P}(t)$ 只计算一次，并存储以备重用。\n\n对每个测试用例，此模拟过程重复 $M$ 次。对于每次模拟 $m \\in \\{1, \\dots, M\\}$，我们得到系统发育树末端节点上的一组状态。根据这些状态，我们计算关注的汇总统计量，即处于状态 1 (异形) 的末端节点比例：\n$$\n\\hat{p}^{(m)} \\;=\\; \\frac{1}{|L|} \\sum_{i \\in L} \\mathbb{I}\\{X_i^{(m)} = 1\\}\n$$\n其中 $L$ 是末端节点集合，$X_i^{(m)}$ 是在模拟 $m$ 中末端节点 $i$ 的模拟状态。\n\n最后，我们计算后验预测 $p$ 值。这需要用到模拟比例的集合 $\\{\\hat{p}^{(m)}\\}_{m=1}^M$、由所提供数据得出的经验比例 $\\hat{p}_{\\mathrm{emp}} = k_{\\mathrm{emp}} / |L|$，以及模拟比例的均值 $\\bar{p} = \\frac{1}{M} \\sum_{m=1}^M \\hat{p}^{(m)}$。$p$ 值是在模拟中，汇总统计量相对于模拟分布中心，其极端程度至少与观测到的经验统计量相当的模拟所占的比例：\n$$\np\\text{-value} \\;=\\; \\frac{1}{M} \\sum_{m=1}^M \\mathbb{I}\\Big\\{\\, \\big| \\hat{p}^{(m)} - \\bar{p} \\big| \\;\\ge\\; \\big| \\hat{p}_{\\mathrm{emp}} - \\bar{p} \\big| \\,\\Big\\}\n$$\n每个测试用例都使用指定的随机种子，以确保模拟的可复现性，并因此保证最终 $p$ 值的可复现性。实现代码封装了这整个过程，通过遍历每个测试用例来产生所需的输出。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the solution for all test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case A\n        {\n            \"edges\": [(0, 1, 1.0), (0, 2, 1.2), (1, 3, 0.7), (1, 4, 0.8), (2, 5, 0.5), (2, 6, 0.6)],\n            \"root\": 0,\n            \"tips\": {3, 4, 5, 6},\n            \"q01\": 0.04,\n            \"q10\": 0.02,\n            \"pi_prior\": (0.6, 0.4),\n            \"M\": 2000,\n            \"k_emp\": 2,\n            \"seed\": 42\n        },\n        # Test Case B\n        {\n            \"edges\": [(0, 1, 0.0), (0, 2, 0.9), (1, 3, 1.1), (1, 4, 1.3)],\n            \"root\": 0,\n            \"tips\": {2, 3, 4},\n            \"q01\": 0.005,\n            \"q10\": 0.5,\n            \"pi_prior\": (0.9, 0.1),\n            \"M\": 2000,\n            \"k_emp\": 0,\n            \"seed\": 123\n        },\n        # Test Case C\n        {\n            \"edges\": [(0, 1, 0.5), (0, 2, 0.5), (1, 3, 0.5), (1, 4, 0.5), (2, 5, 0.5), (2, 6, 0.5)],\n            \"root\": 0,\n            \"tips\": {3, 4, 5, 6},\n            \"q01\": 0.1,\n            \"q10\": 0.0,\n            \"pi_prior\": (1.0, 0.0),\n            \"M\": 2000,\n            \"k_emp\": 3,\n            \"seed\": 2025\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        p_value = run_simulation_case(**case)\n        results.append(f\"{p_value:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\ndef run_simulation_case(edges, root, tips, q01, q10, pi_prior, M, k_emp, seed):\n    \"\"\"\n    Runs the simulation and computes the p-value for a single test case.\n    \"\"\"\n    # Initialize the random number generator for reproducibility.\n    rng = np.random.default_rng(seed)\n\n    # Build phylogeny as an adjacency list.\n    adj = {}\n    for u, v, t in edges:\n        if u not in adj:\n            adj[u] = []\n        adj[u].append((v, t))\n\n    # Construct the instantaneous rate matrix Q.\n    Q = np.array([[-q01, q01], [q10, -q10]])\n\n    # Memoization cache for transition probability matrices P(t).\n    P_memo = {}\n    \n    simulated_proportions = []\n    \n    for _ in range(M):\n        # Dictionary to store states of nodes for the current simulation.\n        states = {}\n\n        # 1. Sample root state from the prior distribution.\n        u_root = rng.random()\n        states[root] = 0 if u_root  pi_prior[0] else 1\n\n        # 2. Propagate states down the tree using BFS.\n        queue = [root]\n        head = 0\n        while head  len(queue):\n            parent = queue[head]\n            head += 1\n\n            if parent in adj:\n                for child, t in adj[parent]:\n                    # Compute P(t) if not already memoized.\n                    if t not in P_memo:\n                        P_memo[t] = expm(Q * t)\n                    P_t = P_memo[t]\n                    \n                    parent_state = states[parent]\n                    # Probability of child being in state 0, given parent state.\n                    prob_child_is_0 = P_t[parent_state, 0]\n                    \n                    # Sample child state.\n                    u_child = rng.random()\n                    states[child] = 0 if u_child  prob_child_is_0 else 1\n                    \n                    queue.append(child)\n        \n        # 3. Compute the tip proportion of heteromorphy (state 1).\n        num_tips = len(tips)\n        tip_states_1 = sum(1 for tip in tips if states[tip] == 1)\n        p_hat = tip_states_1 / num_tips\n        simulated_proportions.append(p_hat)\n\n    # 4. Compute the posterior predictive p-value.\n    simulated_proportions = np.array(simulated_proportions)\n    \n    # Mean of simulated proportions.\n    p_bar = np.mean(simulated_proportions)\n    \n    # Empirical proportion.\n    p_emp = k_emp / len(tips)\n\n    # Absolute deviation of empirical data from the simulated mean.\n    d_emp = abs(p_emp - p_bar)\n    \n    # Absolute deviations of simulated data from the simulated mean.\n    d_sim = np.abs(simulated_proportions - p_bar)\n    \n    # Count how many simulated deviations are at least as large as the empirical one.\n    num_extreme = np.sum(d_sim = d_emp)\n    \n    p_value = num_extreme / M\n    \n    return p_value\n\nif __name__ == '__main__':\n    solve()\n```", "id": "2709560"}]}