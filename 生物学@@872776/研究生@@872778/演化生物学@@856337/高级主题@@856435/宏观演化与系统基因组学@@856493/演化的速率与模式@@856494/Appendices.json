{"hands_on_practices": [{"introduction": "为了深刻理解渐进式演化和静态演化之间的区别，我们必须首先将它们形式化为数学模型。这项练习将引导你推导出两种基本模型的关键属性：布朗运动（$BM$）和奥恩斯坦-乌伦贝克过程（$OU$）。通过分析它们方差随时间变化的动态，你将亲眼看到这两种模型如何分别代表无约束的连续扩散和受约束的随机波动，从而揭示它们在宏观演化时间尺度上截然不同的长期行为。[@problem_id:2755285]", "problem": "在宏观演化性状建模中，考虑沿一个谱系的单个数量性状，其起始时间为 $t=0$，初始条件为 $X_{0}=Y_{0}=\\theta=0$。提出了两种典型的随机模型来描述演化的节奏和模式。模型 A 是一个无偏随机游走，等价于布朗运动，其随机微分方程为 $dX_{t}=\\sigma_{B}\\,dW_{t}$，其中 $W_{t}$ 是一个标准维纳过程，$\\sigma_{B}>0$ 是一个常数扩散参数。模型 B 是 Ornstein–Uhlenbeck (OU) 过程，其随机微分方程为 $dY_{t}=-\\alpha\\left(Y_{t}-\\theta\\right)\\,dt+\\sigma_{O}\\,dW_{t}$，其中 $\\alpha>0$ 是向长期均值 $\\theta$ 吸引的强度，$\\sigma_{O}>0$ 是扩散参数。\n\n从这些定义和维纳过程的标准性质（独立、平稳的高斯增量，均值为 $0$，方差与 $dt$ 成正比）出发，完成以下任务：\n\n1) 分别在模型 A 和模型 B 下，推导方差 $\\operatorname{Var}[X_{t}]$ 和 $\\operatorname{Var}[Y_{t}]$ 的时间依赖性，过程中不使用任何预先记忆的公式。清晰地陈述二阶矩所服从的常微分方程（如果存在）并求解。\n\n2) 使用您对模型 B 的结果，将 $t_{0.95}$ 定义为 OU 方差达到其长期稳态值的 $0.95$ 分数时的时间。解析求解 $t_{0.95}$，用 $\\alpha$ 表示。\n\n3) 定义诊断比率\n$$\nQ \\equiv \\frac{\\operatorname{Var}[X_{t_{0.95}}]}{\\lim_{t\\to\\infty}\\operatorname{Var}[Y_{t}]}\\,,\n$$\n该比率比较了在 OU 过程有效达到稳态时，无偏随机游走已经扩散了多远。当 $\\alpha=0.2$，$\\sigma_{B}=\\sigma_{O}=0.1$ 时，计算 $Q$ 的值。将您的最终答案 $Q$ 四舍五入到四位有效数字。\n\n4) 用文字简要解释，并以您的方差结果为依据，$\\operatorname{Var}[X_{t}]$ 和 $\\operatorname{Var}[Y_{t}]$ 随时间变化的鲜明对比如何为宏观演化时间序列中的停滞与连续扩散提供诊断依据。您的解释不应涉及任何数值计算。\n\n只需提供 $Q$ 的数值（四舍五入到四位有效数字）作为您的最终答案。$Q$ 是无量纲的，因此不需要单位。", "solution": "所陈述的问题在数学和科学上是合理的、适定的，并包含唯一解所需的所有信息。我们将按要求进行推导。\n\n该任务分为 $4$ 个部分。我们按顺序处理它们。\n\n1) 推导方差 $\\operatorname{Var}[X_{t}]$ 和 $\\operatorname{Var}[Y_{t}]$。\n\n对于模型 A（布朗运动），随机微分方程 (SDE) 为 $dX_{t}=\\sigma_{B}\\,dW_{t}$，初始条件为 $X_{0}=0$。过程 $X_t$ 是一个缩放的维纳过程。其均值为 $\\operatorname{E}[X_{t}]=\\operatorname{E}[\\sigma_{B}W_{t}]=\\sigma_{B}\\operatorname{E}[W_{t}]=0$。因此，方差等于二阶矩，即 $\\operatorname{Var}[X_{t}] = \\operatorname{E}[X_{t}^2]$。\n令 $V_X(t) = \\operatorname{E}[X_{t}^2]$。为求 $V_X(t)$ 的常微分方程 (ODE)，我们将 Itô 引理应用于函数 $f(X_{t}) = X_{t}^2$。其微分为 $d(X_{t}^2) = 2X_{t}\\,dX_{t} + \\frac{1}{2}(2)(dX_{t})^2$。\n使用 SDE $dX_{t}=\\sigma_{B}\\,dW_{t}$ 和维纳过程的二次变分 $(dW_t)^2 = dt$，我们得到 $(dX_t)^2 = (\\sigma_B dW_t)^2 = \\sigma_B^2 dt$。\n将这些代入 Itô 微分中：\n$$d(X_{t}^2) = 2X_{t}(\\sigma_{B}\\,dW_{t}) + \\sigma_{B}^2\\,dt$$\n对两边取期望，我们注意到随机积分项的期望为零，即 $\\operatorname{E}[X_{t}\\,dW_{t}]=0$。这得到：\n$$d\\operatorname{E}[X_{t}^2] = \\sigma_{B}^2\\,dt$$\n这就是二阶矩 $V_X(t) = \\operatorname{E}[X_t^2]$ 的 ODE：\n$$\\frac{dV_X}{dt} = \\sigma_{B}^2$$\n在初始条件 $V_X(0) = \\operatorname{E}[X_{0}^2] = 0^2 = 0$ 下，从 $s=0$ 积分到 $s=t$，我们得到：\n$$V_X(t) - V_X(0) = \\int_0^t \\sigma_{B}^2 \\,ds \\implies V_X(t) = \\sigma_{B}^2 t$$\n因此，模型 A 的方差为 $\\operatorname{Var}[X_{t}] = \\sigma_{B}^2 t$。\n\n对于模型 B (Ornstein–Uhlenbeck 过程)，SDE 为 $dY_{t}=-\\alpha(Y_{t}-\\theta)\\,dt+\\sigma_{O}\\,dW_{t}$。在给定条件 $\\theta=0$ 和 $Y_{0}=0$ 下，SDE 简化为 $dY_{t}=-\\alpha Y_{t}\\,dt+\\sigma_{O}\\,dW_{t}$。\n首先，我们求均值 $\\mu_Y(t) = \\operatorname{E}[Y_{t}]$。对 SDE 取期望得到 $d\\operatorname{E}[Y_{t}] = -\\alpha\\operatorname{E}[Y_{t}]\\,dt$，即 $\\frac{d\\mu_Y}{dt} = -\\alpha\\mu_Y$。由于 $\\mu_Y(0) = \\operatorname{E}[Y_0] = 0$，解为对所有 $t$ 都有 $\\mu_Y(t) = 0$。\n因此，方差为 $\\operatorname{Var}[Y_{t}] = \\operatorname{E}[Y_{t}^2]$。令 $V_Y(t) = \\operatorname{E}[Y_{t}^2]$。\n对 $f(Y_{t}) = Y_{t}^2$ 应用 Itô 引理：$d(Y_{t}^2) = 2Y_{t}\\,dY_{t} + (dY_{t})^2$。\n二次变分为 $(dY_{t})^2 = (-\\alpha Y_{t}\\,dt+\\sigma_{O}\\,dW_{t})^2 = \\sigma_{O}^2(dW_t)^2 = \\sigma_{O}^2\\,dt$，因为包含 $dt^2$ 和 $dt\\,dW_t$ 的项是低阶项。\n代入 Itô 微分中：\n$$d(Y_{t}^2) = 2Y_{t}(-\\alpha Y_{t}\\,dt+\\sigma_{O}\\,dW_{t}) + \\sigma_{O}^2\\,dt = -2\\alpha Y_{t}^2\\,dt + 2\\sigma_{O}Y_{t}\\,dW_{t} + \\sigma_{O}^2\\,dt$$\n取期望得到 $V_Y(t)$ 的 ODE：\n$$d\\operatorname{E}[Y_{t}^2] = -2\\alpha\\operatorname{E}[Y_{t}^2]\\,dt + \\sigma_{O}^2\\,dt \\implies \\frac{dV_Y}{dt} = -2\\alpha V_Y + \\sigma_{O}^2$$\n这是一个一阶线性 ODE。我们使用积分因子 $I(t) = \\exp(\\int 2\\alpha\\,dt) = \\exp(2\\alpha t)$ 求解。将整理后的 ODE $\\frac{dV_Y}{dt} + 2\\alpha V_Y = \\sigma_{O}^2$ 乘以 $I(t)$ 得到：\n$$\\frac{d}{dt}(V_Y(t)\\exp(2\\alpha t)) = \\sigma_{O}^2\\exp(2\\alpha t)$$\n在初始条件 $V_Y(0) = \\operatorname{E}[Y_{0}^2] = 0$ 下，从 $s=0$ 积分到 $s=t$：\n$$V_Y(t)\\exp(2\\alpha t) - V_Y(0)\\exp(0) = \\int_0^t \\sigma_{O}^2\\exp(2\\alpha s)\\,ds = \\sigma_{O}^2 \\left[ \\frac{\\exp(2\\alpha s)}{2\\alpha} \\right]_0^t = \\frac{\\sigma_{O}^2}{2\\alpha} (\\exp(2\\alpha t) - 1)$$\n求解 $V_Y(t)$：\n$$V_Y(t) = \\frac{\\sigma_{O}^2}{2\\alpha} (1 - \\exp(-2\\alpha t))$$\n这就是 OU 过程的方差表达式，$\\operatorname{Var}[Y_t]$。\n\n2) $t_{0.95}$ 的解析解。\n\nOU 过程的长期稳态方差为 $\\lim_{t\\to\\infty} \\operatorname{Var}[Y_{t}]$。\n$$\\lim_{t\\to\\infty} \\frac{\\sigma_{O}^2}{2\\alpha} (1 - \\exp(-2\\alpha t)) = \\frac{\\sigma_{O}^2}{2\\alpha}$$\n时间 $t_{0.95}$ 由条件 $\\operatorname{Var}[Y_{t_{0.95}}] = 0.95 \\times \\lim_{t\\to\\infty} \\operatorname{Var}[Y_{t}]$ 定义。\n$$\\frac{\\sigma_{O}^2}{2\\alpha} (1 - \\exp(-2\\alpha t_{0.95})) = 0.95 \\cdot \\frac{\\sigma_{O}^2}{2\\alpha}$$\n$$(1 - \\exp(-2\\alpha t_{0.95})) = 0.95$$\n$$\\exp(-2\\alpha t_{0.95}) = 1 - 0.95 = 0.05$$\n$$-2\\alpha t_{0.95} = \\ln(0.05)$$\n$$t_{0.95} = -\\frac{\\ln(0.05)}{2\\alpha} = \\frac{\\ln(1/0.05)}{2\\alpha} = \\frac{\\ln(20)}{2\\alpha}$$\n\n3) 计算诊断比率 $Q$。\n\n该比率定义为：\n$$Q \\equiv \\frac{\\operatorname{Var}[X_{t_{0.95}}]}{\\lim_{t\\to\\infty}\\operatorname{Var}[Y_{t}]}$$\n代入先前推导的表达式：\n分子：$\\operatorname{Var}[X_{t_{0.95}}] = \\sigma_{B}^2 t_{0.95} = \\sigma_{B}^2 \\frac{\\ln(20)}{2\\alpha}$。\n分母：$\\lim_{t\\to\\infty}\\operatorname{Var}[Y_{t}] = \\frac{\\sigma_{O}^2}{2\\alpha}$。\n因此，比率 $Q$ 为：\n$$Q = \\frac{\\sigma_{B}^2 \\frac{\\ln(20)}{2\\alpha}}{\\frac{\\sigma_{O}^2}{2\\alpha}} = \\frac{\\sigma_{B}^2}{\\sigma_{O}^2}\\ln(20)$$\n现在我们代入给定的数值：$\\alpha=0.2$, $\\sigma_{B}=0.1$, $\\sigma_{O}=0.1$。\n$$Q = \\left(\\frac{0.1}{0.1}\\right)^2 \\ln(20) = 1^2 \\ln(20) = \\ln(20)$$\n$\\ln(20)$ 的数值约为 $2.995732...$\n四舍五入到四位有效数字，我们得到 $Q = 2.996$。\n\n4) 诊断效用的解释。\n\n方差随时间变化的鲜明对比行为，为区分两种基本的演化模式提供了有力的诊断工具。\n在模型 A（布朗运动）下，方差 $\\operatorname{Var}[X_{t}] = \\sigma_B^2 t$ 随着时间的推移线性且无界地增加。这一数学性质反映了一个生物学场景，即性状的连续、无方向的扩散或“随机游走”。与祖先状态的期望差异会无限增长。该模型是系统渐变论的定量表示，其中演化变化是缓慢、连续和累积的。\n在模型 B (Ornstein-Uhlenbeck) 下，方差 $\\operatorname{Var}[Y_{t}] = \\frac{\\sigma_O^2}{2\\alpha}(1 - \\exp(-2\\alpha t))$ 最初增加，但渐近地趋近于一个有限的稳态值 $\\frac{\\sigma_O^2}{2\\alpha}$。这种数学上的有界性反映了一个生物过程，其中性状被约束在一个最优值 $\\theta$ 周围，通常是通过稳定选择。虽然存在随机波动，但有一个强度为 $\\alpha$ 的“恢复力”阻止性状无限发散。方差达到一个平台期意味着该过程已达到统计平衡。这种受约束的波动模式是停滞的特征，而停滞是间断平衡演化模型的核心组成部分。\n因此，一个显示方差随时间线性增加的古生物学时间序列，是扩散性、类似 BM 过程的证据。相反，一个方差稳定在平台期的古生物学时间序列，是受约束的、类似 OU 过程的证据，表明存在停滞。", "answer": "$$\\boxed{2.996}$$", "id": "2755285"}, {"introduction": "“间断平衡”模型的一个核心论点是，大部分显著的形态演化都集中在物种形成事件中。这项练习提供了一个定量框架来探索这一观点。你将构建一个混合模型，该模型结合了沿谱系分支的缓慢、连续的变化（渐变成分）和物种形成时的不连续跳跃（间断成分），并推导出在总演化变异中，由物种形成事件贡献的期望比例。[@problem_id:2755303]", "problem": "一个单一的数量性状沿着一个谱系演化，该谱系嵌入在一个纯生尤尔(Yule)过程中，其中每个谱系的物种形成速率为$\\lambda$，且没有灭绝。设从根到现在的谱系总经历时间为$T$。该性状的演化模型包含两个部分：\n\n- 渐变演化部分：在每个分支上，性状遵循布朗运动，方差累积速率为$\\sigma^2$，因此在经过时间$t$后，其增量的均值为$0$，方差为$\\sigma^2 t$。\n\n- 分支演化部分：在每次物种形成事件（分支演化）中，每个子谱系都以概率$p$独立地经历一次瞬时跳跃。如果发生跳跃，该跳跃的均值为$0$，方差为$J^2$。如果该子谱系没有发生跳跃，其分支演化增量为$0$。所有不同事件和谱系间的跳跃彼此独立，也与渐变演化的布朗运动独立。\n\n将从根到现在的焦点谱系上的总形态变化定义为时间$T$后性状净位移的期望方差。将此期望方差加性地分解为分支演化跳跃的贡献和渐变演化布朗运动的贡献。仅使用布朗运动方差随时间线性累积以及物种形成事件沿谱系以速率$\\lambda$发生为泊松过程这两个基本事实，推导在物种形成事件中发生的总形态变化所占的期望分数$F$的封闭形式表达式。你的最终答案必须只表示为$\\lambda$、$p$、$J$和$\\sigma^2$的函数，并且必须是一个单一的封闭形式解析表达式。将$F$表示为一个无量纲的小数分数。不需要进行数值四舍五入。", "solution": "问题要求的是由分支演化事件引起的总形态变化的期望分数。总形态变化被定义为时间间隔$T$内性状净位移的期望方差。我们将通过对演化过程建模并分解总方差来解决这个问题。\n\n设$X(t)$为时间$t$时数量性状的值。由于我们关心的是位移的方差，因此可以不失一般性地将根部的初始性状值设为$X(0) = 0$。时间$T$后的净性状位移为$X(T)$。\n\n总位移$X(T)$是两个独立分量的和：渐变演化变化$X_A(T)$和分支演化变化$X_C(T)$。\n$$X(T) = X_A(T) + X_C(T)$$\n因为规定渐变演化（布朗运动）和分支演化（跳跃）过程是独立的，所以它们的和的方差是它们方差的和。因此，我们记为$V_{total}$的总方差是：\n$$V_{total} = \\text{Var}(X(T)) = \\text{Var}(X_A(T)) + \\text{Var}(X_C(T))$$\n我们将分别计算每个分量的方差。\n\n首先，我们分析渐变演化分量，$V_A = \\text{Var}(X_A(T))$。问题指出，性状沿谱系以方差累积速率$\\sigma^2$的布朗运动过程演化。这意味着对于任何持续时间为$t$的时间间隔，性状的变化均值为$0$，方差为$\\sigma^2 t$。对于总经历时间$T$，渐变演化分量的方差由该定义直接给出：\n$$V_A = \\sigma^2 T$$\n\n接下来，我们分析分支演化分量，$V_C = \\text{Var}(X_C(T))$。焦点谱系上的物种形成事件以速率$\\lambda$的泊松过程发生。设$N(T)$为到时间$T$为止谱系上已发生的物种形成事件的数量。随机变量$N(T)$遵循泊松分布，其均值为$\\operatorname{E}[N(T)] = \\lambda T$。\n在每次物种形成事件（比如事件$i$）中，会发生一次跳跃$\\Delta_i$。总的分支演化变化是到时间$T$为止所有跳跃的总和：\n$$X_C(T) = \\sum_{i=1}^{N(T)} \\Delta_i$$\n这是一个随机数量的随机变量之和。为了求其方差，我们应用全方差公式（也称为Eve定律）：\n$$\\text{Var}(X_C(T)) = \\operatorname{E}[\\text{Var}(X_C(T) | N(T))] + \\text{Var}(\\operatorname{E}[X_C(T) | N(T)])$$\n我们必须首先确定单次跳跃$\\Delta_i$的均值和方差。以概率$p$发生一次跳跃，其均值为$0$，方差为$J^2$。以概率$1-p$不发生跳跃，因此变化为$0$。\n单次跳跃$\\Delta_i$的均值为：\n$$\\operatorname{E}[\\Delta_i] = p \\cdot 0 + (1-p) \\cdot 0 = 0$$\n单次跳跃$\\Delta_i$的方差为$\\text{Var}(\\Delta_i) = \\operatorname{E}[\\Delta_i^2] - (\\operatorname{E}[\\Delta_i])^2 = \\operatorname{E}[\\Delta_i^2]$。\n$$\\operatorname{E}[\\Delta_i^2] = p \\cdot \\operatorname{E}[\\text{jump value}^2] + (1-p) \\cdot 0^2$$\n给定发生一次跳跃，其方差为$J^2$，均值为$0$。因此，$\\operatorname{E}[\\text{jump value}^2] = \\text{Var}(\\text{jump value}) + (\\operatorname{E}[\\text{jump value}])^2 = J^2 + 0^2 = J^2$。\n因此，单次跳跃$\\Delta_i$的方差为：\n$$\\text{Var}(\\Delta_i) = \\operatorname{E}[\\Delta_i^2] = p J^2$$\n现在我们可以计算全方差公式中的两项。\n\n第一项：$\\operatorname{E}[\\text{Var}(X_C(T) | N(T))]$。\n在给定$N(T) = n$个事件的条件下，总变化是$n$个独立同分布跳跃的和，$X_C(T)|_{N(T)=n} = \\sum_{i=1}^n \\Delta_i$。由于跳跃是独立的，和的方差是方差的和：\n$$\\text{Var}(X_C(T) | N(T)=n) = \\sum_{i=1}^n \\text{Var}(\\Delta_i) = n \\cdot (p J^2)$$\n这意味着$\\text{Var}(X_C(T) | N(T)) = N(T) \\cdot p J^2$。对$N(T)$取期望：\n$$\\operatorname{E}[\\text{Var}(X_C(T) | N(T))] = \\operatorname{E}[N(T) \\cdot p J^2] = p J^2 \\operatorname{E}[N(T)]$$\n由于$N(T)$是均值为$\\lambda T$的泊松随机变量，我们有：\n$$\\operatorname{E}[\\text{Var}(X_C(T) | N(T))] = p J^2 (\\lambda T) = \\lambda p J^2 T$$\n\n第二项：$\\text{Var}(\\operatorname{E}[X_C(T) | N(T)])$。\n在给定$N(T) = n$个事件的条件下，总变化的均值是单个跳跃均值的和：\n$$\\operatorname{E}[X_C(T) | N(T)=n] = \\operatorname{E}\\left[\\sum_{i=1}^n \\Delta_i\\right] = \\sum_{i=1}^n \\operatorname{E}[\\Delta_i] = \\sum_{i=1}^n 0 = 0$$\n所以，对于$N(T)$的任何值，$\\operatorname{E}[X_C(T) | N(T)] = 0$。常数（$0$）的方差为$0$：\n$$\\text{Var}(\\operatorname{E}[X_C(T) | N(T)]) = \\text{Var}(0) = 0$$\n\n结合这两项，来自分支演化跳跃的总方差为：\n$$V_C = \\text{Var}(X_C(T)) = \\lambda p J^2 T + 0 = \\lambda p J^2 T$$\n\n现在我们可以计算在时间$T$内性状位移的总方差：\n$$V_{total} = V_A + V_C = \\sigma^2 T + \\lambda p J^2 T = (\\sigma^2 + \\lambda p J^2)T$$\n\n问题要求在物种形成事件中发生的总形态变化所占的期望分数$F$。这是分支演化方差与总方差的比率：\n$$F = \\frac{V_C}{V_{total}} = \\frac{\\lambda p J^2 T}{(\\sigma^2 + \\lambda p J^2) T}$$\n时间参数$T$被消去，这对于这样一个比率是预期的。最终的表达式是：\n$$F = \\frac{\\lambda p J^2}{\\sigma^2 + \\lambda p J^2}$$\n该表达式是无量纲的，符合要求。项$\\sigma^2$的单位是[性状]$^2$/[时间]，而项$\\lambda p J^2$的单位是($1$/[时间]) $\\cdot$ [性状]$^2$ = [性状]$^2$/[时间]。因此，分子和分母在量纲上是一致的。", "answer": "$$\\boxed{\\frac{\\lambda p J^2}{\\sigma^2 + \\lambda p J^2}}$$", "id": "2755303"}, {"introduction": "理论模型最终需要通过数据来检验，而古生物学数据通常以化石测量的时间序列形式出现。这项实践将理论与数据分析联系起来，向你展示如何检验不同的演化节奏。你将通过编程实现一个似然比检验，以统计学方法区分恒定速率的渐进模型和可变速率的模型，从而学习如何从时间序列数据中识别间断变化的信号。[@problem_id:2755226]", "problem": "构建一个程序，该程序使用基本统计学原理和霍尔丹速率的标准定义，来操作化推断离散化时间上的进化速率。该程序必须接收在连续时间点上对一个数量性状的重复测量，这些测量定义了 $k$ 个具有已知世代时间的连续时间区间，然后估计各区间特定的霍尔丹速率，并通过使用似然比检验（LRT）比较恒定速率模型与区间特定速率模型，来检验各区间之间的速率异质性。解决方案必须完全基于以下基本原理从头推导和实现：\n\n- 霍尔丹速率定义为每代性状均值的变化，以种群内表型标准差为单位进行度量。\n- 中心极限定理证明了样本均值的抽样分布可以近似为高斯分布，其方差等于时间点内的表型方差除以样本量。\n- 多个时间点的合并组内表型方差通过跨时间点的无偏合并方差来估计。\n- 对于独立观测，高斯似然在对数似然中是可加的。\n- 似然比检验通过最大化对数似然值的两倍差值来比较嵌套模型，并且该统计量渐近服从卡方分布，其自由度等于自由参数数量之差。\n\n对于每个测试用例，您将获得：\n- 跨越 $k+1$ 个连续时间点的性状样本均值序列，记为 $\\{ \\bar{z}_0, \\bar{z}_1, \\ldots, \\bar{z}_k \\}$。\n- 相应的时间点内样本标准差序列，记为 $\\{ s_0, s_1, \\ldots, s_k \\}$。\n- 相应的样本量序列，记为 $\\{ n_0, n_1, \\ldots, n_k \\}$。\n- 每个区间的世代数序列，记为 $\\{ g_0, g_1, \\ldots, g_{k-1} \\}$。\n\n请为每个测试用例实现以下步骤，且仅从上述原理出发：\n\n1) 使用跨所有时间点计算的无偏合并方差，从 $\\{ s_j \\}$ 和 $\\{ n_j \\}$ 估计合并组内表型标准差 $S$，然后取其平方根。\n\n2) 对于每个区间 $i \\in \\{0,1,\\ldots,k-1\\}$，通过使用合并标准差 $S$ 和世代数 $g_i$ 对观察到的样本均值变化进行标准化，计算区间特定的霍尔丹速率估计值 $h_i$。\n\n3) 仅使用样本均值的抽样不确定性来量化每个 $h_i$ 的观测方差。利用时间点 $j$ 的样本均值抽样方差为 $s_j^2 / n_j$ 这一事实，并假设不同时间点之间相互独立。将此不确定性传播到差值 $\\bar{z}_{i+1} - \\bar{z}_i$，从而传播到 $h_i$。\n\n4) 为具有已知方差的观测值 $\\{ h_i \\}$ 指定一个高斯似然：\n   - 在零假设（恒定速率；谱系渐变论）下，所有区间共享一个共同的真实速率 $r$，因此 $h_i$ 是具有共同均值 $r$ 和已知方差的独立高斯观测值。\n   - 在备择假设（速率异质性；与间断动态一致）下，每个区间都有其自身的均值 $r_i$。\n\n5) 最大化两个似然函数以获得最大似然估计（通过推导，而非假设），并计算似然比统计量，其定义为最大化对数似然值之差的两倍。在正则性条件下，该统计量渐近服从自由度为 $k-1$ 的 $\\chi^2$ 分布。计算相应的尾部概率（用小数表示，而非百分比），该概率被解释为拒绝恒定速率模型而支持速率异质性模型的 $p$ 值。\n\n您的程序必须将上述步骤应用于以下测试套件。每个测试用例由四元组 $(\\{\\bar{z}_j\\}, \\{s_j\\}, \\{n_j\\}, \\{g_i\\})$ 完全指定。下述所有数值均需按原样使用：\n\n- 测试用例 A（近似恒定的霍尔丹速率；$k=4$）：\n  - 性状均值：$\\{ 10.0, 10.2, 10.4, 10.6, 10.8 \\}$ \n  - 标准差：$\\{ 1.0, 1.0, 1.0, 1.0, 1.0 \\}$ \n  - 样本量：$\\{ 50, 50, 50, 50, 50 \\}$ \n  - 每个区间的世代数：$\\{ 5, 5, 5, 5 \\}$\n\n- 测试用例 B（一次跳跃式变化；$k=3$）：\n  - 性状均值：$\\{ 10.0, 10.0, 12.0, 12.0 \\}$\n  - 标准差：$\\{ 1.0, 1.0, 1.0, 1.0 \\}$\n  - 样本量：$\\{ 50, 50, 50, 50 \\}$\n  - 每个区间的世代数：$\\{ 10, 1, 10 \\}$\n\n- 测试用例 C（异方差抽样；最小自由度；$k=2$）：\n  - 性状均值：$\\{ 10.0, 10.5, 11.0 \\}$\n  - 标准差：$\\{ 1.0, 2.0, 1.0 \\}$\n  - 样本量：$\\{ 100, 5, 100 \\}$\n  - 每个区间的世代数：$\\{ 10, 10 \\}$\n\n最终输出格式：\n- 对于每个测试用例，输出一个列表，其中按顺序包含所有区间特定的霍尔丹速率，然后是似然比统计量和相应的上尾 $\\chi^2$ $p$ 值。将所有报告的数字四舍五入到恰好六位小数。\n- 将三个测试用例的列表聚合到一个单一列表中，并将其作为单行打印，例如：\n  - $[ [h_{A,0}, h_{A,1}, h_{A,2}, h_{A,3}, \\mathrm{LR}_A, p_A], [h_{B,0}, h_{B,1}, h_{B,2}, \\mathrm{LR}_B, p_B], [h_{C,0}, h_{C,1}, \\mathrm{LR}_C, p_C] ]$\n- 确保程序严格按照此格式生成一行输出，数字四舍五入至六位小数，且无任何附加文本。", "solution": "该问题具有科学依据，提法明确，客观，并包含了获得唯一解所需的所有信息。这是数量进化生物学中的一个有效问题。我现在将提供完整的推导和解法。\n\n该问题要求使用一种统计检验来区分两种进化模式：谱系渐变论（phyletic gradualism），模型化为恒定的变化速率；以及与间断平衡论（punctuated equilibria）一致的模式，模型化为跨时间区间的可变变化速率。该分析基于在离散时间点上对一个种群进行的一系列性状测量。方法的核心是应用于进化速率嵌套高斯模型的似然比检验（LRT）。推导过程严格遵循指定的第一性原理。\n\n设在不同的时间点有一系列 $k+1$ 个性状测量值，索引为 $j=0, 1, \\ldots, k$。这些测量值定义了 $k$ 个连续的区间，索引为 $i=0, 1, \\ldots, k-1$。对于每个时间点 $j$，我们给定了样本均值 $\\bar{z}_j$、样本标准差 $s_j$ 和样本量 $n_j$。对于每个区间 $i$，我们给定了以世代为单位的持续时间 $g_i$。\n\n步骤 1：估计合并的种群内标准差 $S$。\n霍尔丹速率是一个标准化速率，因此我们必须首先估计标准化的单位，即共同的种群内表型标准差 $\\sigma$。我们通过合并所有 $k+1$ 个时间点的样本方差来估计它。无偏合并方差 $S_p^2$ 是各个样本方差 $s_j^2$ 的加权平均值，权重由自由度 $(n_j-1)$ 决定：\n$$ S_p^2 = \\frac{\\sum_{j=0}^{k} (n_j-1)s_j^2}{\\sum_{j=0}^{k} (n_j-1)} $$\n合并标准差 $S$ 是合并方差的平方根：\n$$ S = \\sqrt{S_p^2} $$\n这个 $S$ 值将作为我们对潜在表型标准差的最佳估计，并将用于标准化性状均值的所有变化。\n\n步骤 2：计算各区间特定的霍尔丹速率估计值 $h_i$。\n霍尔丹速率定义为每代性状均值的变化，以种群内标准差为单位。对于区间 $i$（即测量点 $i$ 和 $i+1$ 之间的时间），观察到的样本均值变化为 $\\Delta \\bar{z}_i = \\bar{z}_{i+1} - \\bar{z}_i$。这个变化发生在 $g_i$ 个世代内。因此，该区间的估计霍尔丹速率 $h_i$ 为：\n$$ h_i = \\frac{\\bar{z}_{i+1} - \\bar{z}_i}{S \\cdot g_i} $$\n对每个区间 $i \\in \\{0, 1, \\ldots, k-1\\}$ 进行此计算，得到一组观测速率 $\\{h_0, h_1, \\ldots, h_{k-1}\\}$。\n\n步骤 3：量化每个霍尔丹速率估计值的观测方差 $\\sigma_{h_i}^2$。\n每个估计值 $h_i$ 都受到抽样误差的影响，因为均值 $\\bar{z}_i$ 和 $\\bar{z}_{i+1}$ 本身就是估计值。根据中心极限定理，样本均值 $\\bar{z}_j$ 的抽样分布近似为高斯分布，其方差为 $\\sigma_j^2/n_j$，其中 $\\sigma_j^2$ 是时间点 $j$ 性状的真实方差。我们用 $s_j^2/n_j$ 来估计 $\\mathrm{Var}(\\bar{z}_j)$。鉴于来自不同时间点的样本是独立的，两个均值之差的方差是它们方差之和：\n$$ \\mathrm{Var}(\\bar{z}_{i+1} - \\bar{z}_i) = \\mathrm{Var}(\\bar{z}_{i+1}) + \\mathrm{Var}(\\bar{z}_i) \\approx \\frac{s_{i+1}^2}{n_{i+1}} + \\frac{s_i^2}{n_i} $$\n使用标准误差传播方法，通过将 $S$ 和 $g_i$ 视为常数，可以推导出霍尔丹速率估计值 $h_i$ 的方差：\n$$ \\sigma_{h_i}^2 \\equiv \\mathrm{Var}(h_i) = \\mathrm{Var}\\left(\\frac{\\bar{z}_{i+1} - \\bar{z}_i}{S \\cdot g_i}\\right) = \\frac{1}{(S \\cdot g_i)^2} \\mathrm{Var}(\\bar{z}_{i+1} - \\bar{z}_i) $$\n代入差值的估计方差，可得：\n$$ \\sigma_{h_i}^2 = \\frac{1}{(S \\cdot g_i)^2} \\left(\\frac{s_{i+1}^2}{n_{i+1}} + \\frac{s_i^2}{n_i}\\right) $$\n在接下来的似然分析中，这些观测方差 $\\{\\sigma_{h_0}^2, \\sigma_{h_1}^2, \\ldots, \\sigma_{h_{k-1}}^2\\}$ 被视为已知。\n\n步骤 4：高斯似然的设定与最大化。\n我们将每个观测到的霍尔丹速率 $h_i$ 建模为来自高斯分布 $h_i \\sim \\mathcal{N}(r_i, \\sigma_{h_i}^2)$ 的独立抽样，其中 $r_i$ 是区间 $i$ 的真实（但未知）霍尔丹速率。观测到集合 $\\{h_i\\}$ 的对数似然是各个对数似然之和：\n$$ \\ln L(\\{h_i\\} | \\{r_i\\}) = \\sum_{i=0}^{k-1} \\ln \\left( \\mathcal{N}(h_i | r_i, \\sigma_{h_i}^2) \\right) = C - \\frac{1}{2}\\sum_{i=0}^{k-1}\\frac{(h_i - r_i)^2}{\\sigma_{h_i}^2} $$\n其中 $C = -\\frac{k}{2}\\ln(2\\pi) - \\frac{1}{2}\\sum_{i=0}^{k-1}\\ln(\\sigma_{h_i}^2)$ 是一个不依赖于参数 $\\{r_i\\}$ 的常数。\n\n零假设 ($H_0$)：恒定速率（谱系渐变论）。所有区间的真实速率相同，即对所有 $i$ 都有 $r_i = r$。该模型有一个自由参数 $r$。为了找到最大似然估计（MLE）$\\hat{r}$，我们通过将其关于 $r$ 的导数设为零来最大化对数似然：\n$$ \\frac{\\partial \\ln L}{\\partial r} = \\sum_{i=0}^{k-1}\\frac{h_i - r}{\\sigma_{h_i}^2} = 0 \\implies \\hat{r} = \\frac{\\sum_{i=0}^{k-1} (h_i / \\sigma_{h_i}^2)}{\\sum_{i=0}^{k-1} (1 / \\sigma_{h_i}^2)} $$\nMLE $\\hat{r}$ 是观测速率 $\\{h_i\\}$ 的逆方差加权平均值。在 $H_0$ 下最大化的对数似然为 $\\ln \\hat{L}_{null} = C - \\frac{1}{2}\\sum_{i=0}^{k-1}\\frac{(h_i - \\hat{r})^2}{\\sigma_{h_i}^2}$。\n\n备择假设 ($H_A$)：可变速率。每个区间都有自己的速率 $r_i$。该模型有 $k$ 个自由参数，即 $\\{r_0, \\ldots, r_{k-1}\\}$。为了找到 MLE $\\{\\hat{r}_i\\}$，我们分别对每个 $r_j$ 最大化对数似然。对于每个 $j$，$\\frac{\\partial \\ln L}{\\partial r_j} = \\frac{h_j - r_j}{\\sigma_{h_j}^2} = 0$，得出 $\\hat{r}_j = h_j$。每个区间速率的 MLE 就是该区间的观测速率。\n在 $H_A$ 下最大化的对数似然为 $\\ln \\hat{L}_{alt} = C - \\frac{1}{2}\\sum_{i=0}^{k-1}\\frac{(h_i - h_i)^2}{\\sigma_{h_i}^2} = C$。\n\n步骤 5：似然比检验。\nLRT 统计量比较了两个嵌套模型（$H_0$ 嵌套在 $H_A$ 内）的拟合优度。该统计量定义为它们最大化对数似然之差的两倍：\n$$ \\mathrm{LR} = 2 (\\ln \\hat{L}_{alt} - \\ln \\hat{L}_{null}) = 2 \\left( C - \\left(C - \\frac{1}{2}\\sum_{i=0}^{k-1}\\frac{(h_i - \\hat{r})^2}{\\sigma_{h_i}^2}\\right) \\right) = \\sum_{i=0}^{k-1}\\frac{(h_i - \\hat{r})^2}{\\sigma_{h_i}^2} $$\n该统计量是观测速率与最佳拟合恒定速率之间偏差平方的加权和。在零假设下，该统计量渐近服从卡方（$\\chi^2$）随机变量分布。分布的自由度（$df$）是模型之间自由参数数量的差值：$df = k - 1$。\n$p$ 值是在假设 $H_0$ 为真的情况下，观测到至少与计算出的 LR 统计量一样大的统计量的概率。这由 $\\chi^2_{df}$ 分布的上尾概率给出：$p = P(\\chi^2_{k-1} \\ge \\mathrm{LR})$。一个小的 $p$ 值（例如 $0.05$）提供了拒绝恒定速率模型而支持速率异质性模型的证据。\n\n至此，所需统计程序的推导完成。实现将为每个测试用例精确地遵循这些步骤。", "answer": "```python\nimport numpy as np\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Main function to run the analysis on all test cases and print the final result.\n    \"\"\"\n    test_cases = [\n        # Test case A: Approximately constant haldane rates\n        {\n            \"means\": [10.0, 10.2, 10.4, 10.6, 10.8],\n            \"sds\": [1.0, 1.0, 1.0, 1.0, 1.0],\n            \"sizes\": [50, 50, 50, 50, 50],\n            \"gens\": [5, 5, 5, 5],\n        },\n        # Test case B: One punctuated jump\n        {\n            \"means\": [10.0, 10.0, 12.0, 12.0],\n            \"sds\": [1.0, 1.0, 1.0, 1.0],\n            \"sizes\": [50, 50, 50, 50],\n            \"gens\": [10, 1, 10],\n        },\n        # Test case C: Heteroscedastic sampling\n        {\n            \"means\": [10.0, 10.5, 11.0],\n            \"sds\": [1.0, 2.0, 1.0],\n            \"sizes\": [100, 5, 100],\n            \"gens\": [10, 10],\n        },\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result_list = process_case(case)\n        all_results.append(result_list)\n\n    # The final output must be a single line representing the list of lists.\n    # The str() conversion of a list automatically handles the formatting.\n    # The template's join(map(str,...)) correctly builds this string representation.\n    # Example: str([[1, 2], [3, 4]]) -> \"[[1, 2], [3, 4]]\"\n    # join map: '[' + ','.join(['[1, 2]', '[3, 4]']) + ']' -> '[[1, 2],[3, 4]]'\n    # The output is slightly different (no spaces), but both are valid Python representations.\n    # The template's proposal is more robust.\n    print(f\"[[{', '.join(map(str, all_results[0]))}], [{', '.join(map(str, all_results[1]))}], [{', '.join(map(str, all_results[2]))}]]\".replace(\" \", \"\"))\n\n\ndef process_case(case):\n    \"\"\"\n    Analyzes a single test case according to the derived steps.\n    \n    Args:\n        case (dict): A dictionary containing 'means', 'sds', 'sizes', and 'gens'.\n        \n    Returns:\n        list: A list containing calculated haldane rates, the LR statistic, \n              and the p-value, with all numbers rounded to six decimal places.\n    \"\"\"\n    z = np.array(case[\"means\"])\n    s = np.array(case[\"sds\"])\n    n = np.array(case[\"sizes\"])\n    g = np.array(case[\"gens\"])\n\n    k = len(g)  # Number of intervals\n    \n    # --- Step 1: Estimate pooled within-time phenotypic standard deviation S ---\n    s_sq = s**2\n    numerator = np.sum((n - 1) * s_sq)\n    denominator = np.sum(n - 1)\n    S_p_sq = numerator / denominator\n    S = np.sqrt(S_p_sq)\n    \n    # --- Step 2: Compute interval-specific haldane estimates h_i ---\n    h = np.zeros(k)\n    for i in range(k):\n        delta_z = z[i+1] - z[i]\n        h[i] = delta_z / (S * g[i])\n        \n    # --- Step 3: Quantify the observation variance of each h_i ---\n    var_h = np.zeros(k)\n    for i in range(k):\n        var_delta_z = (s_sq[i+1] / n[i+1]) + (s_sq[i] / n[i])\n        var_h[i] = var_delta_z / (S * g[i])**2\n        \n    # --- Step 4: Maximize likelihood under the constant-rate model (H0) ---\n    # The MLE is the inverse-variance weighted mean of the h_i.\n    weights = 1.0 / var_h\n    r_hat = np.sum(weights * h) / np.sum(weights)\n\n    # --- Step 5: Compute the Likelihood Ratio (LR) statistic ---\n    # LR = sum( w_i * (h_i - r_hat)^2 )\n    lr_statistic = np.sum(weights * (h - r_hat)**2)\n    \n    # --- Step 6: Compute the p-value ---\n    # Degrees of freedom is k (params in H_A) - 1 (param in H_0)\n    df = k - 1\n    # The p-value is the upper-tail probability of the chi-square distribution.\n    # For df=0, chi2.sf is 0 for LR>0 and 1 for LR=0\n    if df > 0:\n        p_value = chi2.sf(lr_statistic, df)\n    else: # Edge case, e.g., k=1 interval\n        p_value = 1.0 if np.isclose(lr_statistic, 0) else 0.0\n\n    # --- Prepare final output for this case ---\n    results_raw = list(h) + [lr_statistic, p_value]\n    results_rounded = [f'{val:.6f}' for val in results_raw]\n    \n    return results_rounded\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "2755226"}]}