{"hands_on_practices": [{"introduction": "实验设计的成功是进化和重测序（E&R）研究的基石。在投入时间和资源之前，至关重要的是要确保实验有足够的统计功效来检测预期的选择信号。本练习将指导您进行功效分析，以确定所需的最小重复群体数量，这是任何稳健 E&R 研究设计的关键第一步 [@problem_id:2711888]。通过这个过程，您将学会如何量化权衡选择强度、遗传漂变和测序噪声之间的关系。", "problem": "一项实验演化研究使用演化与重测序 (E&R) 设计，其中有 $R$ 个独立的重复群体，每个群体的有效群体大小 $N_{e}$ 恒定，从同一个基础群体开始，该基础群体中一个目标单核苷酸多态性 (SNP) 的衍生等位基因初始频率为 $p_{0}$。每个重复群体在一个二倍体 Wright–Fisher 群体中演化 $T$ 个离散世代，期间受到基因选择作用，该选择有利于衍生等位基因，选择系数为 $s$。在第 $0$ 代和第 $T$ 代，对每个重复群体进行混合全群体测序，每个位点的覆盖度为 $C$，并从测序读数中估计每个重复群体在这两个时间点的衍生等位基因频率。假设在不同时间点和不同重复群体之间，测序读数的抽样是独立的，并且遵循二项分布模型。\n\n您需要设计一个单侧检验，用于检验原假设 $H_{0}: \\Delta = 0$ 与备择假设 $H_{1}: \\Delta > 0$，其中 $\\Delta$ 表示第 $T$ 代和第 $0$ 代之间衍生等位基因频率的变化。在显著性水平 $\\alpha$ 下，使用 Wald $Z$ 检验。您的推导应基于以下经过充分检验的基础：\n\n- 无选择作用下 Wright–Fisher 漂变的扩散近似给出了 $T$ 代后等位基因频率的方差为 $\\operatorname{Var}(p_{T}\\mid p_{0}) \\approx p_{0}(1-p_{0})\\left(1-\\exp\\left(-\\frac{T}{2 N_{e}}\\right)\\right)$，您可以用此公式来近似遗传漂变对变化量 $\\Delta$ 的重复群体间方差贡献。\n- 在弱选择下，连续时间中基因选择的预期确定性轨迹满足 $\\frac{d p}{d t} = s\\,p(1-p)$，其解意味着 $T$ 代后的预期等位基因频率为 $p_{T} \\approx \\frac{1}{1 + \\left(\\frac{1-p_{0}}{p_{0}}\\right)\\exp(-s T)}$。\n- 覆盖度为 $C$ 的混合测序在每个时间点产生一个等位基因频率的无偏估计量，其二项抽样方差为 $p(1-p)/C$，且在不同时间点和重复群体之间是独立的。\n\n假设漂变和测序的贡献以及所有重复群体都是独立的，并用正态分布来近似重复群体平均变化的抽样分布。请从第一性原理推导出一个解析表达式，用于计算在 $H_{1}$ 下达到统计功效 $1-\\beta$ 所需的最小重复群体数量 $R$，该表达式用 $s$、$p_{0}$、$T$、$N_{e}$、$C$、$\\alpha$ 和 $\\beta$ 表示。然后，使用参数 $s = 0.02$、$p_{0} = 0.10$、$T = 30$、$N_{e} = 1000$、$C = 100$、$\\alpha = 0.05$ 和目标功效 $1-\\beta = 0.80$，计算满足此要求的最小整数 $R$。将最终的 $R$ 以无单位的整数形式给出。如果需要中间数值近似，请至少保留 4 位有效数字；最终的 $R$ 必须是满足标准的最小整数，不需要四舍五入。", "solution": "该问题要求推导一个演化与重测序实验为达到期望的统计功效所需的最小重复群体数量 $R$。该问题具有科学依据，提法明确，客观，并包含足够信息以获得唯一解。因此，该问题是有效的。\n\n我们首先建立统计框架。假设检验关注的是衍生等位基因频率的平均变化 $\\Delta = p_T - p_0$。原假设为 $H_0: \\Delta = 0$，单侧备择假设为 $H_1: \\Delta > 0$。我们使用基于 $R$ 个重复群体中估计频率变化的均值（记为 $\\bar{\\hat{\\Delta}}$）的 Wald $Z$ 检验。\n\n设 $\\hat{p}_{i,0}$ 和 $\\hat{p}_{i,T}$ 分别为重复群体 $i$ 在第 $0$ 代和第 $T$ 代的估计等位基因频率。重复群体 $i$ 的估计变化量为 $\\hat{\\Delta}_i = \\hat{p}_{i,T} - \\hat{p}_{i,0}$。检验统计量基于所有 $R$ 个重复群体的这些估计值的平均值：\n$$ \\bar{\\hat{\\Delta}} = \\frac{1}{R} \\sum_{i=1}^{R} \\hat{\\Delta}_i $$\n根据中心极限定理，对于足够大的 $R$，$\\bar{\\hat{\\Delta}}$ 的抽样分布近似为正态分布。\n\nWald Z-统计量由下式给出：\n$$ Z = \\frac{\\bar{\\hat{\\Delta}} - E[\\bar{\\hat{\\Delta}} | H_0]}{\\sqrt{\\operatorname{Var}(\\bar{\\hat{\\Delta}} | H_0)}} $$\n在原假设 $H_0$ 下，没有选择（$s=0$），因此预期的等位基因频率不变。因此，$E[p_T|H_0] = p_0$，且预期的变化量为 $E[\\bar{\\hat{\\Delta}} | H_0] = 0$。\n\n为了构建检验并进行功效分析，我们必须确定在原假设 ($H_0$) 和备择假设 ($H_1$) 下 $\\bar{\\hat{\\Delta}}$ 的方差。均值估计的方差为 $\\operatorname{Var}(\\bar{\\hat{\\Delta}}) = \\frac{1}{R} \\operatorname{Var}(\\hat{\\Delta}_i)$。我们必须首先求出单个重复群体的方差 $\\sigma_{\\hat{\\Delta}}^2 = \\operatorname{Var}(\\hat{\\Delta}_i)$。\n\n估计变化量 $\\hat{\\Delta}_i$ 的总方差来自两个独立的过程：$T$ 个世代的遗传漂变以及在两个时间点测序时读数的二项抽样。由于第 $0$ 代和第 $T$ 代的测序估计是独立的，我们有：\n$$ \\operatorname{Var}(\\hat{\\Delta}_i) = \\operatorname{Var}(\\hat{p}_{i,T} - \\hat{p}_{i,0}) = \\operatorname{Var}(\\hat{p}_{i,T}) + \\operatorname{Var}(\\hat{p}_{i,0}) $$\n初始频率 $p_0$ 是固定的，因此其估计量的方差完全来自测序：\n$$ \\operatorname{Var}(\\hat{p}_{i,0}) = \\frac{p_0(1-p_0)}{C} $$\n由于漂变，重复群体 $i$ 在第 $T$ 代的频率 $p_{i,T}$ 是一个随机变量。我们使用全方差公式来求解 $\\operatorname{Var}(\\hat{p}_{i,T})$：\n$$ \\operatorname{Var}(\\hat{p}_{i,T}) = E[\\operatorname{Var}(\\hat{p}_{i,T} | p_{i,T})] + \\operatorname{Var}(E[\\hat{p}_{i,T} | p_{i,T}]) $$\n给定真实频率 $p_{i,T}$，测序估计量是无偏的，$E[\\hat{p}_{i,T} | p_{i,T}] = p_{i,T}$，其方差为 $\\operatorname{Var}(\\hat{p}_{i,T} | p_{i,T}) = \\frac{p_{i,T}(1-p_{i,T})}{C}$。\n$\\operatorname{Var}(\\hat{p}_{i,T})$ 的表达式变为：\n$$ \\operatorname{Var}(\\hat{p}_{i,T}) = E\\left[\\frac{p_{i,T}(1-p_{i,T})}{C}\\right] + \\operatorname{Var}(p_{i,T}) $$\n我们使用 $p_{i,T}$ 的期望值来近似第一项。设 $p_T^{\\text{exp}} = E[p_{i,T}]$。那么 $E\\left[\\frac{p_{i,T}(1-p_{i,T})}{C}\\right] \\approx \\frac{p_T^{\\text{exp}}(1-p_T^{\\text{exp}})}{C}$。第二项 $\\operatorname{Var}(p_{i,T})$ 是由遗传漂变引起的方差，问题中给出其值为 $\\operatorname{Var}(p_T | p_0) \\approx p_0(1-p_0)\\left(1-\\exp\\left(-\\frac{T}{2N_e}\\right)\\right)$。\n\n因此，每个重复群体的总方差为：\n$$ \\sigma_{\\hat{\\Delta}}^2 = \\operatorname{Var}(\\hat{\\Delta}_i) \\approx p_0(1-p_0)\\left(1-\\exp\\left(-\\frac{T}{2N_e}\\right)\\right) + \\frac{p_T^{\\text{exp}}(1-p_T^{\\text{exp}})}{C} + \\frac{p_0(1-p_0)}{C} $$\n在 $H_0$ 下，$s=0$，所以 $p_T^{\\text{exp}} = p_0$。原假设下的方差 $\\sigma_0^2$ 简化为：\n$$ \\sigma_0^2 = p_0(1-p_0)\\left(1-\\exp\\left(-\\frac{T}{2N_e}\\right)\\right) + \\frac{2p_0(1-p_0)}{C} = p_0(1-p_0)\\left[1-\\exp\\left(-\\frac{T}{2N_e}\\right) + \\frac{2}{C}\\right] $$\n在 $H_1$ 下，选择系数 $s > 0$，预期的频率为 $p_T^{\\text{exp}} \\approx \\frac{1}{1 + \\left(\\frac{1-p_0}{p_0}\\right)\\exp(-sT)}$。备择假设下的方差 $\\sigma_1^2$ 为：\n$$ \\sigma_1^2 = p_0(1-p_0)\\left(1-\\exp\\left(-\\frac{T}{2N_e}\\right)\\right) + \\frac{p_T^{\\text{exp}}(1-p_T^{\\text{exp}})}{C} + \\frac{p_0(1-p_0)}{C} $$\n备择假设下的预期变化量为 $\\mu_{\\Delta} = E[\\bar{\\hat{\\Delta}}|H_1] = p_T^{\\text{exp}} - p_0$。\n\n对于显著性水平为 $\\alpha$ 的单侧检验，如果 $Z > z_{\\alpha}$，我们拒绝 $H_0$，其中 $z_{\\alpha}$ 是标准正态分布的上 $\\alpha$-分位数。这等价于如果 $\\bar{\\hat{\\Delta}} > z_{\\alpha}\\sqrt{\\sigma_0^2/R}$ 则拒绝 $H_0$。\n\n统计功效 $1-\\beta$ 是在 $H_1$ 为真时拒绝 $H_0$ 的概率：\n$$ 1-\\beta = P\\left(\\bar{\\hat{\\Delta}} > z_{\\alpha}\\sqrt{\\frac{\\sigma_0^2}{R}} \\;\\middle|\\; H_1\\right) $$\n在 $H_1$ 下，$\\bar{\\hat{\\Delta}} \\sim N(\\mu_{\\Delta}, \\sigma_1^2/R)$。我们对不等式进行标准化：\n$$ 1-\\beta = P\\left( \\frac{\\bar{\\hat{\\Delta}} - \\mu_{\\Delta}}{\\sqrt{\\sigma_1^2/R}} > \\frac{z_{\\alpha}\\sqrt{\\sigma_0^2/R} - \\mu_{\\Delta}}{\\sqrt{\\sigma_1^2/R}} \\right) $$\n左边是一个标准正态变量。为了使概率为 $1-\\beta$，右边的阈值必须是 $-z_{\\beta}$，其中 $z_{\\beta}$ 是上 $\\beta$-分位数。\n$$ -z_{\\beta} = \\frac{z_{\\alpha}\\sqrt{\\sigma_0^2} - \\mu_{\\Delta}\\sqrt{R}}{\\sqrt{\\sigma_1^2}} $$\n求解 $\\sqrt{R}$：\n$$ \\mu_{\\Delta}\\sqrt{R} = z_{\\alpha}\\sqrt{\\sigma_0^2} + z_{\\beta}\\sqrt{\\sigma_1^2} $$\n$$ \\sqrt{R} = \\frac{z_{\\alpha}\\sqrt{\\sigma_0^2} + z_{\\beta}\\sqrt{\\sigma_1^2}}{\\mu_{\\Delta}} $$\n这就得到了所需重复群体数量的解析表达式：\n$$ R = \\left( \\frac{z_{\\alpha}\\sqrt{\\sigma_0^2} + z_{\\beta}\\sqrt{\\sigma_1^2}}{\\mu_{\\Delta}} \\right)^2 $$\n\n现在，我们使用给定的参数计算 $R$ 的数值：\n$s=0.02$、$p_0=0.10$、$T=30$、$N_e=1000$、$C=100$、$\\alpha=0.05$、$1-\\beta=0.80$。\n对应的分位数为 $z_{\\alpha} = z_{0.05} \\approx 1.6449$ 和 $z_{\\beta} = z_{0.20} \\approx 0.8416$。\n\n1.  计算 $H_1$ 下的预期频率和变化量：\n    $p_T^{\\text{exp}} = \\frac{1}{1 + \\left(\\frac{1-0.10}{0.10}\\right)\\exp(-0.02 \\times 30)} = \\frac{1}{1 + 9\\exp(-0.6)} \\approx \\frac{1}{1 + 9(0.54881)} \\approx 0.16837$。\n    $\\mu_{\\Delta} = p_T^{\\text{exp}} - p_0 \\approx 0.16837 - 0.10 = 0.06837$。\n\n2.  计算 $H_0$ 下的方差：\n    $\\frac{T}{2N_e} = \\frac{30}{2000} = 0.015$。\n    $\\sigma_0^2 = 0.1(0.9)\\left[1-\\exp(-0.015) + \\frac{2}{100}\\right] \\approx 0.09[1 - 0.98511 + 0.02] = 0.09[0.01489 + 0.02] = 0.09(0.03489) \\approx 0.0031401$。\n    $\\sqrt{\\sigma_0^2} \\approx 0.056037$。\n\n3.  计算 $H_1$ 下的方差：\n    漂变分量：$0.1(0.9)(1-\\exp(-0.015)) \\approx 0.0013401$。\n    时间点 $0$ 的测序分量：$\\frac{0.1(0.9)}{100} = 0.0009$。\n    时间点 $T$ 的测序分量：$\\frac{p_T^{\\text{exp}}(1-p_T^{\\text{exp}})}{C} \\approx \\frac{0.16837(1-0.16837)}{100} \\approx \\frac{0.14002}{100} = 0.0014002$。\n    $\\sigma_1^2 \\approx 0.0013401 + 0.0014002 + 0.0009 = 0.0036403$。\n    $\\sqrt{\\sigma_1^2} \\approx 0.060335$。\n\n4.  计算 $R$：\n    $R = \\left( \\frac{1.6449 \\times 0.056037 + 0.8416 \\times 0.060335}{0.06837} \\right)^2$\n    $R \\approx \\left( \\frac{0.092174 + 0.050786}{0.06837} \\right)^2 = \\left( \\frac{0.14296}{0.06837} \\right)^2 \\approx (2.0910)^2 \\approx 4.372$。\n\n由于重复群体的数量必须是整数，我们取该值的天花板函数（向上取整）以确保满足功效要求。\n$R = \\lceil 4.372 \\rceil = 5$。\n所需的最小整数重复群体数量为 $5$。", "answer": "$$\n\\boxed{5}\n$$", "id": "2711888"}, {"introduction": "从测序数据中获得准确的等位基因频率估计是 E&R 分析的核心，但这常常受到技术偏差的挑战。一个常见的问题是参考序列作图偏差，即参考等位基因和替代等位基因的读段（reads）被成功作图和识别的概率可能不同。本练习将向您展示如何应用最大似然估计这一严谨的统计方法，来纠正这种偏差，从而获得更真实的等位基因频率 [@problem_id:2711877]。掌握这种校正技术对于确保后续进化推断的准确性至关重要。", "problem": "您正在分析一个演化和重测序（evolve-and-resequence）实验中，通过混合测序（pool-seq）得到的等位基因频率估计值。由于参考序列比对偏差和碱基识别错误，一个真实的参考染色体或变异染色体产生一个被正确比对和识别的读段（read）的概率在不同等位基因之间可能存在差异。您的目标是基于群体遗传学抽样和测序错误模型，为这种偏差实现一个有原则的校正方法，并为一组指定的测试用例计算校正后的真实变异等位基因频率的最大似然估计值。\n\n从以下基本假设开始：\n- 测序读段是独立抽样的，并且在给定其来自真实的参考染色体或变异染色体的情况下，具有等位基因特异性的检测概率。设 $p_{\\mathrm{ref}} \\in (0,1]$ 和 $p_{\\mathrm{alt}} \\in (0,1]$ 分别表示一个真实的参考染色体或变异染色体产生一个被正确比对并识别为其真实等位基因的读段的概率。\n- 给定真实变异等位基因频率 $f \\in [0,1]$，一个比对上的读段支持变异等位基因的概率为\n$$\nq(f) \\;=\\; \\frac{f \\, p_{\\mathrm{alt}}}{f \\, p_{\\mathrm{alt}} + (1-f)\\, p_{\\mathrm{ref}}} \\, .\n$$\n- 在给定 $q(f)$ 和某位点的总比对读段深度 $D \\in \\mathbb{N}$ 的条件下，观测到的支持变异等位基因的读段数 $k \\in \\{0,1,\\ldots,D\\}$ 服从参数为 $q(f)$ 的二项分布。\n- 在仅提供重校准 Phred 碱基质量的测试用例中，使用 $e(Q) = 10^{-Q/10}$ 将重校准的 Phred 质量 $Q$ 转换为错误概率 $e(Q)$，然后将相应等位基因的单位等位基因检测概率设置为 $p = 1 - e(Q)$。\n\n对于每个测试用例，您将获得：\n- 直接基于合成比对（synthetic-mapping）的等位基因特异性检测概率 $(p_{\\mathrm{ref}}, p_{\\mathrm{alt}})$，或重校准的碱基质量 $(Q_{\\mathrm{ref}}, Q_{\\mathrm{alt}})$，您必须从中计算出 $(p_{\\mathrm{ref}}, p_{\\mathrm{alt}})$。\n- 总比对读段深度 $D$ 和支持变异等位基因的读段数 $k$。\n\n您的任务：\n- 仅使用上述基本假设，推导并实现给定 $(D,k)$ 和 $(p_{\\mathrm{ref}}, p_{\\mathrm{alt}})$ 时真实变异等位基因频率 $f$ 的最大似然估计 $\\hat{f}$。在仅有 $(Q_{\\mathrm{ref}}, Q_{\\mathrm{alt}})$ 的测试中，首先按规定计算 $(p_{\\mathrm{ref}}, p_{\\mathrm{alt}})$，然后估计 $\\hat{f}$。\n- 数值稳定性要求：以与似然函数极限行为一致的方式处理边界观测值 $k=0$ 和 $k=D$。\n- 将每个 $\\hat{f}$ 以标准小数（而非分数）形式报告，并四舍五入到 $6$ 位小数。\n\n测试套件（每个项目都是一个指定方法和参数的元组）：\n- 合成比对（SM）用例，参数为 $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}})$：\n  1. SM: $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,40,0.95,0.85)$\n  2. SM: $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,40,0.90,0.90)$\n  3. SM: $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,40,0.95,0.50)$\n  4. SM: $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,40,0.80,0.95)$\n  5. SM (边界): $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,0,0.90,0.80)$\n  6. SM (边界): $(D,k,p_{\\mathrm{ref}},p_{\\mathrm{alt}}) = (100,100,0.90,0.80)$\n- 碱基质量重校准（BQSR）用例，参数为 $(D,k,Q_{\\mathrm{ref}},Q_{\\mathrm{alt}})$ 且 $p_{\\mathrm{ref}}=1-10^{-Q_{\\mathrm{ref}}/10}$，$p_{\\mathrm{alt}}=1-10^{-Q_{\\mathrm{alt}}/10}$：\n  7. BQSR: $(D,k,Q_{\\mathrm{ref}},Q_{\\mathrm{alt}}) = (200,80,30,28)$\n  8. BQSR: $(D,k,Q_{\\mathrm{ref}},Q_{\\mathrm{alt}}) = (200,80,35,20)$\n  9. BQSR: $(D,k,Q_{\\mathrm{ref}},Q_{\\mathrm{alt}}) = (10,1,40,10)$\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔结果列表，每个结果四舍五入到 $6$ 位小数，顺序与测试套件相同，例如：\"[0.123456,0.234567,0.345678]\"。", "solution": "该问题要求在一个 pool-seq 实验中，推导并实现真实变异等位基因频率 $f$ 的最大似然估计（MLE），同时考虑到参考等位基因和变异等位基因的差异性检测概率。所提供的模型是解决此类测量偏差的一个标准框架。\n\n让我们从形式化似然函数开始。数据包括总比对读段深度 $D$ 中支持变异等位基因的读段数 $k$。问题假定，在给定总深度 $D$ 和一个随机抽样的比对读段支持变异等位基因的概率 $q(f)$ 的条件下，读段的抽样服从二项分布。因此，似然函数 $L(f; D, k)$ 由下式给出：\n$$\nL(f; D, k) = P(k | D, f) = \\binom{D}{k} [q(f)]^k [1 - q(f)]^{D-k}\n$$\n概率 $q(f)$ 是真实等位基因频率 $f \\in [0,1]$ 和等位基因特异性检测概率 $p_{\\mathrm{ref}} \\in (0,1]$ 及 $p_{\\mathrm{alt}} \\in (0,1]$ 的函数：\n$$\nq(f) = \\frac{f \\, p_{\\mathrm{alt}}}{f(p_{\\mathrm{alt}} - p_{\\mathrm{ref}}) + p_{\\mathrm{ref}}}\n$$\n为了找到最大似然估计 $\\hat{f}$，我们对 $L(f; D, k)$ 关于 $f$ 进行最大化。在计算和分析上，最大化对数似然函数 $\\ell(f; D, k) = \\ln L(f; D, k)$ 更为方便：\n$$\n\\ell(f) = \\ln\\binom{D}{k} + k \\ln[q(f)] + (D-k) \\ln[1-q(f)]\n$$\n项 $\\ln\\binom{D}{k}$ 相对于 $f$ 是一个常数，在最大化过程中可以忽略。我们通过将对数似然函数关于 $f$ 的导数设为零来找到临界点。\n$$\n\\frac{d\\ell}{df} = \\left( \\frac{k}{q(f)} - \\frac{D-k}{1-q(f)} \\right) \\frac{dq}{df} = 0\n$$\n由于 $p_{\\mathrm{ref}}, p_{\\mathrm{alt}} > 0$，导数 $\\frac{dq}{df}$ 恒为正，因此 $q(f)$ 是 $f$ 的严格单调递增函数。这意味着为了使总导数为零，括号中的项必须为零：\n$$\n\\frac{k}{q(f)} = \\frac{D-k}{1-q(f)} \\quad \\implies \\quad q(f) = \\frac{k}{D}\n$$\n这表明 $q(f)$ 的最大似然估计是观测到的变异读段频率 $\\hat{q} = k/D$。为了找到 $\\hat{f}$，我们现在必须解方程 $q(\\hat{f}) = \\hat{q}$ 以求出 $\\hat{f}$：\n$$\n\\frac{\\hat{f} \\, p_{\\mathrm{alt}}}{\\hat{f} \\, p_{\\mathrm{alt}} + (1-\\hat{f})\\, p_{\\mathrm{ref}}} = \\frac{k}{D}\n$$\n重新整理各项以分离出 $\\hat{f}$：\n$$\nD \\cdot \\hat{f} \\cdot p_{\\mathrm{alt}} = k \\cdot (\\hat{f} \\, p_{\\mathrm{alt}} + (1-\\hat{f})\\, p_{\\mathrm{ref}})\n$$\n$$\n\\hat{f} (D \\cdot p_{\\mathrm{alt}} - k \\cdot p_{\\mathrm{alt}} + k \\cdot p_{\\mathrm{ref}}) = k \\cdot p_{\\mathrm{ref}}\n$$\n$$\n\\hat{f} (p_{\\mathrm{alt}}(D-k) + p_{\\mathrm{ref}}k) = k \\cdot p_{\\mathrm{ref}}\n$$\n这就得出了真实变异等位基因频率最大似然估计的最终表达式：\n$$\n\\hat{f} = \\frac{k \\, p_{\\mathrm{ref}}}{k \\, p_{\\mathrm{ref}} + (D-k) \\, p_{\\mathrm{alt}}}\n$$\n该估计量是良定义的，并被约束在有效区间 $[0,1]$ 内。对于边界情况：\n- 如果 $k=0$，$\\hat{f} = \\frac{0 \\cdot p_{\\mathrm{ref}}}{0 + D \\cdot p_{\\mathrm{alt}}} = 0$。\n- 如果 $k=D$，$\\hat{f} = \\frac{D \\cdot p_{\\mathrm{ref}}}{D \\cdot p_{\\mathrm{ref}} + 0 \\cdot p_{\\mathrm{alt}}} = 1$。\n对于涉及重校准 Phred 碱基质量 $(Q_{\\mathrm{ref}}, Q_{\\mathrm{alt}})$ 的测试用例，首先使用标准公式 $p = 1 - 10^{-Q/10}$ 计算检测概率，然后将这些计算出的概率用于推导出的 $\\hat{f}$ 公式中。\n\n以下是实现此计算的 Python 代码：\n```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the maximum likelihood estimate of the true alternate allele frequency\n    for a series of test cases, accounting for allele-specific detection bias.\n    \"\"\"\n\n    test_cases = [\n        # Synthetic mapping (SM) cases: (type, D, k, p_ref, p_alt)\n        ('SM', 100, 40, 0.95, 0.85),\n        ('SM', 100, 40, 0.90, 0.90),\n        ('SM', 100, 40, 0.95, 0.50),\n        ('SM', 100, 40, 0.80, 0.95),\n        ('SM', 100, 0, 0.90, 0.80),\n        ('SM', 100, 100, 0.90, 0.80),\n        # Base-quality recalibration (BQSR) cases: (type, D, k, Q_ref, Q_alt)\n        ('BQSR', 200, 80, 30, 28),\n        ('BQSR', 200, 80, 35, 20),\n        ('BQSR', 10, 1, 40, 10),\n    ]\n\n    results = []\n\n    def calculate_f_hat(D, k, p_ref, p_alt):\n        if k == 0:\n            return 0.0\n        if k == D:\n            return 1.0\n\n        numerator = k * p_ref\n        denominator = k * p_ref + (D - k) * p_alt\n        \n        return numerator / denominator\n\n    for case in test_cases:\n        case_type = case[0]\n        D, k = case[1], case[2]\n\n        if case_type == 'SM':\n            p_ref, p_alt = case[3], case[4]\n        elif case_type == 'BQSR':\n            Q_ref, Q_alt = case[3], case[4]\n            p_ref = 1.0 - 10**(-Q_ref / 10.0)\n            p_alt = 1.0 - 10**(-Q_alt / 10.0)\n        \n        f_hat = calculate_f_hat(D, k, p_ref, p_alt)\n        results.append(f_hat)\n\n    # The problem asks for the output of the program, which is the list of results.\n    # This function is executed to produce the result for the answer tag.\n    # For clarity in the solution, we can print it.\n    # print(f\"[{','.join([f'{r:.6f}' for r in results])}]\")\n\nsolve()\n```\n实现过程将把这个推导出的表达式应用于每个测试用例。", "answer": "$$\n\\boxed{\\text{[0.426966,0.400000,0.558824,0.359551,0.000000,1.000000,0.400131,0.402334,0.109880]}}\n$$", "id": "2711877"}, {"introduction": "拥有准确的时间序列等位基因频率数据后，我们便可以探究适应性进化的动态过程。一个核心问题是，群体中的适应是由单个有益突变的席卷（sweep）驱动，还是由多个同时出现的有益突变（即克隆竞争）共同作用的结果。本练习将教您如何将这些不同的生物学假说形式化为统计模型，并使用贝叶斯信息准则（BIC）等模型选择方法来判断哪种情景能更好地解释您的时间序列数据 [@problem_id:2711890]。这种方法对于从 E&R 数据中揭示适应过程的复杂性至关重要。", "problem": "在一项无性繁殖种群的演化和重测序 (E&R) 实验中，位于不同位置的两个单核苷酸变异 (SNV)，记为谱系标记 $A$ 和 $B$，标记了两个可能在不同单倍型上出现的相互竞争的有益谱系。在 $i \\in \\{1,\\dots,T\\}$ 的取样时间 $t_{i}$，短读长测序对每个谱系标记 $\\ell \\in \\{A,B\\}$，在该基因座和时间点，从总共 $n_{i\\ell}$ 条读数中，得到支持该谱系特异性等位基因的读数计数 $x_{i\\ell}$。假设在时间 $t_{i}$，以谱系特异性等位基因的真实潜在种群频率 $p_{i\\ell}$ 为条件，读数计数满足 $x_{i\\ell} \\sim \\mathrm{Binomial}(n_{i\\ell},p_{i\\ell})$，且在给定 $(p_{i\\ell})$ 的情况下，这些观测在 $(i,\\ell)$ 上是独立的。\n\n对于大种群中恒定选择下的适应性扫描的早期至中期阶段，假设每个谱系的等位基因频率遵循确定性的逻辑斯蒂轨迹，因此其对数优势比随时间近似线性演化：$\\mathrm{logit}(p_{i\\ell}) = \\alpha_{\\ell} + s_{\\ell} t_{i}$，其中 $\\alpha_{\\ell} \\in \\mathbb{R}$ 是谱系特异性截距，而 $s_{\\ell} \\in \\mathbb{R}$ 是对数优势比尺度上的有效选择系数。\n\n考虑以下嵌套模型：\n- 模型 $\\mathcal{M}_{1}$ (单一扫描)：谱系 $A$ 是有益的，具有自由参数 $(\\alpha_{A}, s_{A})$；谱系 $B$ 在对数优势比尺度上非递增，即 $s_{B} = 0$，并具有自由截距 $\\alpha_{B}$。因此，$\\mathcal{M}_{1}$ 有 $k_{1} = 3$ 个自由参数。\n- 模型 $\\mathcal{M}_{2}$ (复合扫描)：两个谱系都可能是有益的，具有自由参数 $(\\alpha_{A}, s_{A}, \\alpha_{B}, s_{B})$。因此，$\\mathcal{M}_{2}$ 有 $k_{2} = 4$ 个自由参数。\n\n使用所述的二项抽样模型和对数优势比线性频率模型，提出一个有原则的方法，通过在 $\\mathcal{M}_{1}$ 和 $\\mathcal{M}_{2}$ 之间进行选择，来检测是否存在两个相互竞争的有益谱系。使用贝叶斯信息准则 (BIC)，将此问题形式化为一个显式的模型选择准则，其中独立观测值的数量为 $I = 2T$ (在 $T$ 个时间点上，每个谱系各有一个二项观测值)。令 $\\widehat{p}_{i\\ell}^{(m)}$ 表示在模型 $\\mathcal{M}_{m}$ 下，通过最大似然估计得到的、在时间 $t_{i}$ 谱系 $\\ell$ 的拟合概率。推导 BIC 差值\n$\\Delta \\mathrm{BIC} \\equiv \\mathrm{BIC}(\\mathcal{M}_{2}) - \\mathrm{BIC}(\\mathcal{M}_{1})$\n的一个闭式解析表达式，该表达式应使用 $(x_{i\\ell}, n_{i\\ell})$、$(\\widehat{p}_{i\\ell}^{(1)}, \\widehat{p}_{i\\ell}^{(2)})$、$T$ 和标准函数表示，并可用于判断数据是否支持复合扫描情景而非单一扫描情景。你的最终答案必须是单一的闭式表达式。不要报告任何中间值。不需要进行数值近似或四舍五入。使用自然对数表示对数。", "solution": "所述问题在科学上是合理的、定义明确且客观的。它提出了一个统计基因组学中标准的模型选择任务。我将开始推导。\n\n模型 $\\mathcal{M}$ 的贝叶斯信息准则 (BIC) 由以下公式给出：\n$$ \\mathrm{BIC}(\\mathcal{M}) = k \\ln(N) - 2 \\hat{\\mathcal{L}} $$\n其中 $k$ 是模型中自由参数的数量，$N$ 是独立观测值的总数，$\\hat{\\mathcal{L}}$ 是该模型对数似然函数的最大化值。\n\n问题定义了两个嵌套模型，$\\mathcal{M}_{1}$ 和 $\\mathcal{M}_{2}$。\n对于模型 $\\mathcal{M}_{1}$ (单一扫描)，自由参数的数量为 $k_{1} = 3$，对应于 $(\\alpha_{A}, s_{A}, \\alpha_{B})$，并有约束条件 $s_{B} = 0$。\n对于模型 $\\mathcal{M}_{2}$ (复合扫描)，自由参数的数量为 $k_{2} = 4$，对应于 $(\\alpha_{A}, s_{A}, \\alpha_{B}, s_{B})$。\n独立观测值的总数给定为 $N = I = 2T$，因为在 $T$ 个时间点上，2 个谱系中的每一个都有一个二项观测值。\n\n使用这些定义，每个模型的 BIC 为：\n$$ \\mathrm{BIC}(\\mathcal{M}_{1}) = k_{1} \\ln(I) - 2 \\hat{\\mathcal{L}}_{1} = 3 \\ln(2T) - 2 \\hat{\\mathcal{L}}_{1} $$\n$$ \\mathrm{BIC}(\\mathcal{M}_{2}) = k_{2} \\ln(I) - 2 \\hat{\\mathcal{L}}_{2} = 4 \\ln(2T) - 2 \\hat{\\mathcal{L}}_{2} $$\n其中 $\\hat{\\mathcal{L}}_{m}$ 是在模型 $\\mathcal{M}_{m}$ 下的最大化对数似然。\n\n问题要求计算差值 $\\Delta \\mathrm{BIC} \\equiv \\mathrm{BIC}(\\mathcal{M}_{2}) - \\mathrm{BIC}(\\mathcal{M}_{1})$。我们计算如下：\n$$ \\Delta \\mathrm{BIC} = (4 \\ln(2T) - 2 \\hat{\\mathcal{L}}_{2}) - (3 \\ln(2T) - 2 \\hat{\\mathcal{L}}_{1}) $$\n$$ \\Delta \\mathrm{BIC} = (4 - 3) \\ln(2T) - 2 (\\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1}) $$\n$$ \\Delta \\mathrm{BIC} = \\ln(2T) - 2 (\\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1}) $$\n\n为了完成这个表达式，我们必须求出最大化对数似然之间的差值。数据由在时间 $t_{i}$（$i \\in \\{1, \\dots, T\\}$）谱系 $\\ell \\in \\{A, B\\}$ 的读数计数 $x_{i\\ell}$ 组成，其来自总共 $n_{i\\ell}$ 条读数。抽样模型给定为 $x_{i\\ell} \\sim \\mathrm{Binomial}(n_{i\\ell}, p_{i\\ell})$。单个观测值的概率质量函数为：\n$$ P(X_{i\\ell} = x_{i\\ell} | n_{i\\ell}, p_{i\\ell}) = \\binom{n_{i\\ell}}{x_{i\\ell}} p_{i\\ell}^{x_{i\\ell}} (1 - p_{i\\ell})^{n_{i\\ell} - x_{i\\ell}} $$\n这个单个观测值的对数似然为：\n$$ \\ln P(X_{i\\ell} = x_{i\\ell}) = \\ln\\binom{n_{i\\ell}}{x_{i\\ell}} + x_{i\\ell} \\ln(p_{i\\ell}) + (n_{i\\ell} - x_{i\\ell}) \\ln(1 - p_{i\\ell}) $$\n由于观测值在所有 $i$ 和 $\\ell$ 上都是独立的，总对数似然是所有 $2T$ 个观测值的总和：\n$$ \\mathcal{L} = \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ \\ln\\binom{n_{i\\ell}}{x_{i\\ell}} + x_{i\\ell} \\ln(p_{i\\ell}) + (n_{i\\ell} - x_{i\\ell}) \\ln(1 - p_{i\\ell}) \\right] $$\n模型 $\\mathcal{M}_{m}$ 的最大化对数似然，记为 $\\hat{\\mathcal{L}}_{m}$，是通过代入由最大似然估计得到的拟合概率 $\\widehat{p}_{i\\ell}^{(m)}$ 来找到的：\n$$ \\hat{\\mathcal{L}}_{m} = \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ \\ln\\binom{n_{i\\ell}}{x_{i\\ell}} + x_{i\\ell} \\ln(\\widehat{p}_{i\\ell}^{(m)}) + (n_{i\\ell} - x_{i\\ell}) \\ln(1 - \\widehat{p}_{i\\ell}^{(m)}) \\right] $$\n现在我们计算差值 $\\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1}$。项 $\\ln\\binom{n_{i\\ell}}{x_{i\\ell}}$ 相对于模型参数是一个常数，因此在差值计算中被消去。\n$$ \\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1} = \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ \\left( x_{i\\ell} \\ln(\\widehat{p}_{i\\ell}^{(2)}) + (n_{i\\ell} - x_{i\\ell}) \\ln(1 - \\widehat{p}_{i\\ell}^{(2)}) \\right) - \\left( x_{i\\ell} \\ln(\\widehat{p}_{i\\ell}^{(1)}) + (n_{i\\ell} - x_{i\\ell}) \\ln(1 - \\widehat{p}_{i\\ell}^{(1)}) \\right) \\right] $$\n按 $x_{i\\ell}$ 和 $(n_{i\\ell} - x_{i\\ell})$ 对各项进行分组：\n$$ \\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1} = \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ x_{i\\ell} \\left(\\ln(\\widehat{p}_{i\\ell}^{(2)}) - \\ln(\\widehat{p}_{i\\ell}^{(1)})\\right) + (n_{i\\ell} - x_{i\\ell}) \\left(\\ln(1 - \\widehat{p}_{i\\ell}^{(2)}) - \\ln(1 - \\widehat{p}_{i\\ell}^{(1)})\\right) \\right] $$\n使用对数恒等式 $\\ln(a) - \\ln(b) = \\ln(a/b)$，我们得到：\n$$ \\hat{\\mathcal{L}}_{2} - \\hat{\\mathcal{L}}_{1} = \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ x_{i\\ell} \\ln\\left(\\frac{\\widehat{p}_{i\\ell}^{(2)}}{\\widehat{p}_{i\\ell}^{(1)}}\\right) + (n_{i\\ell} - x_{i\\ell}) \\ln\\left(\\frac{1 - \\widehat{p}_{i\\ell}^{(2)}}{1 - \\widehat{p}_{i\\ell}^{(1)}}\\right) \\right] $$\n最后，我们将这个对数似然差值的表达式代回到我们的 $\\Delta \\mathrm{BIC}$ 方程中：\n$$ \\Delta \\mathrm{BIC} = \\ln(2T) - 2 \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ x_{i\\ell} \\ln\\left(\\frac{\\widehat{p}_{i\\ell}^{(2)}}{\\widehat{p}_{i\\ell}^{(1)}}\\right) + (n_{i\\ell} - x_{i\\ell}) \\ln\\left(\\frac{1 - \\widehat{p}_{i\\ell}^{(2)}}{1 - \\widehat{p}_{i\\ell}^{(1)}}\\right) \\right] $$\n这就是复合扫描模型和单一扫描模型之间 BIC 差值的所要求的闭式解析表达式。$\\Delta \\mathrm{BIC}$ 的负值将构成支持模型 $\\mathcal{M}_{2}$ 的统计证据。", "answer": "$$ \\boxed{ \\ln(2T) - 2 \\sum_{i=1}^{T} \\sum_{\\ell \\in \\{A, B\\}} \\left[ x_{i\\ell} \\ln\\left(\\frac{\\widehat{p}_{i\\ell}^{(2)}}{\\widehat{p}_{i\\ell}^{(1)}}\\right) + (n_{i\\ell} - x_{i\\ell}) \\ln\\left(\\frac{1 - \\widehat{p}_{i\\ell}^{(2)}}{1 - \\widehat{p}_{i\\ell}^{(1)}}\\right) \\right] } $$", "id": "2711890"}]}