{"hands_on_practices": [{"introduction": "直接对无限晶格中的所有离子相互作用进行求和是一项艰巨的任务。为了建立基本直觉，我们从最简单的模型——一维无限离子链——开始，通过只考虑最近的三对邻居来近似计算马德隆常数[@problem_id:1818815]。这个练习清晰地揭示了晶格求和的基本思想，并展示了正负电荷的交替排布如何导致一个收敛且有意义的能量值。", "problem": "考虑一个假设的一维（1D）离子晶体，它被建模为一个由正负点电荷交替排列组成的无限长链。每个电荷的电荷量大小为 $q$，离子等间距排列，任意两个相邻离子之间的距离为 $R$。\n\n由于链中所有其他离子的电场，单个参考离子的静电势能 $U_i$ 由成对势能之和给出：$U_i = \\sum_{j \\neq i} \\frac{k_e q_i q_j}{r_{ij}}$。在这里，$k_e$ 是库仑常数，$q_i$ 和 $q_j$ 是离子 $i$ 和 $j$ 的电荷，而 $r_{ij}$ 是它们之间的距离。对于这样的周期性结构，这个能量可以方便地用一个称为马德隆常数 $\\alpha$ 的无量纲量来表示，通过关系式 $U_i = -\\frac{k_e q^2}{R} \\alpha$。\n\n通过只考虑单个参考离子与其第一、第二和第三最近邻对之间的静电相互作用，计算此马德隆常数的近似值。将您的答案表示为最简精确分数形式。", "solution": "我们考虑一个由电荷量大小为 $q$、间距为 $R$ 的点电荷交替排列组成的无限长一维链。选择带电荷 $+q$ 的参考离子位于原点。根据库仑定律，参考离子与距离为 $r_{ij}$、电荷为 $q_j$ 的离子之间的成对势能为 $U_{ij} = k_{e} q_i q_j / r_{ij}$。\n\n在这个交替链中，位于位置 $\\pm nR$ （其中 $n \\in \\mathbb{N}$）的离子带有电荷 $(-1)^{n} q$。因此，与距离为 $nR$ 的两个离子的相互作用能为\n$$\nU_{n} = 2 \\cdot \\frac{k_{e} \\left(+q\\right)\\left[(-1)^{n} q\\right]}{nR} = \\frac{2 k_{e} q^{2}}{R} \\frac{(-1)^{n}}{n}.\n$$\n只保留第一、第二和第三最近邻对，对应于 $n=1,2,3$。因此，参考离子的截断势能为\n$$\nU_{i}^{(3)} = \\sum_{n=1}^{3} U_{n} = \\frac{2 k_{e} q^{2}}{R} \\left[ -1 + \\frac{1}{2} - \\frac{1}{3} \\right] = \\frac{2 k_{e} q^{2}}{R} \\left( -\\frac{5}{6} \\right) = -\\frac{5}{3} \\frac{k_{e} q^{2}}{R}.\n$$\n根据马德隆常数 $\\alpha$ 的定义，能量写为 $U_{i} = - \\frac{k_{e} q^{2}}{R} \\alpha$。将其与截断结果相等，可得\n$$\n-\\frac{k_{e} q^{2}}{R} \\alpha^{(3)} = -\\frac{5}{3} \\frac{k_{e} q^{2}}{R} \\quad \\Longrightarrow \\quad \\alpha^{(3)} = \\frac{5}{3}.\n$$\n这是一个最简精确分数。", "answer": "$$\\boxed{\\frac{5}{3}}$$", "id": "1818815"}, {"introduction": "在对无穷级数进行近似计算后，一个自然的问题是：我们能否得到它的精确值？本练习探讨了一种半无限长链的特殊情况，在这种情况下，无限的静电相互作用之和可以被精确地计算出来[@problem_id:1818837]。它巧妙地揭示了物理问题与著名数学级数之间的深刻联系，表明马德隆常数可以是一个基本的数学常数，如 $\\ln 2$。", "problem": "考虑一个假设的一维离子晶体。该晶体被建模为位于x轴上的一个半无限点电荷链。一个带电荷 $+q$ 的离子被置于原点 $x=0$ 处。其他离子位于位置 $x_n = na$ 处，其中 $n$ 为所有正整数 $n=1, 2, 3, \\dots$，$a$ 是一个代表最近邻距离的常数。这些离子的电荷交替变化，使得位置 $x_n$ 处的离子的电荷为 $(-1)^n q$。\n\n由于链中所有其他离子，原点处离子的总静电势能 $U$ 通常写成以下形式：\n$$U = -\\alpha \\frac{k_e q^2}{a}$$\n其中 $k_e$ 是库仑常数，$\\alpha$ 是一个无量纲的值，称为此特定构型的马德隆常数。\n\n计算此半无限链的马德隆常数 $\\alpha$ 的精确值。", "solution": "两个相距为 $r$ 的点电荷 $q_{1}$ 和 $q_{2}$ 之间的静电势能由下式给出\n$$\nU=\\frac{k_{e}q_{1}q_{2}}{r}.\n$$\n对于原点处电荷为 $+q$ 的离子，其与位置 $x_{n}=na$ 处（电荷为 $(-1)^{n}q$）的离子的相互作用贡献为\n$$\nU_{n}=\\frac{k_{e}\\,q\\,\\big((-1)^{n}q\\big)}{na}=\\frac{k_{e}q^{2}}{a}\\frac{(-1)^{n}}{n}.\n$$\n对半无限链中的所有离子求和，得到总势能\n$$\nU=\\sum_{n=1}^{\\infty}U_{n}=\\frac{k_{e}q^{2}}{a}\\sum_{n=1}^{\\infty}\\frac{(-1)^{n}}{n}.\n$$\n使用自然对数的幂级数展开式，\n$$\n\\ln(1+x)=\\sum_{n=1}^{\\infty}\\frac{(-1)^{n+1}x^{n}}{n}\\quad\\text{for }|x|\\leq 1,\n$$\n代入 $x=1$ 可得\n$$\n\\sum_{n=1}^{\\infty}\\frac{(-1)^{n+1}}{n}=\\ln 2,\n$$\n所以\n$$\n\\sum_{n=1}^{\\infty}\\frac{(-1)^{n}}{n}=-\\ln 2.\n$$\n因此，\n$$\nU=\\frac{k_{e}q^{2}}{a}\\left(-\\ln 2\\right)=-\\left(\\ln 2\\right)\\frac{k_{e}q^{2}}{a}.\n$$\n与定义 $U=-\\alpha\\,\\frac{k_{e}q^{2}}{a}$ 相比较，我们确定\n$$\n\\alpha=\\ln 2.\n$$", "answer": "$$\\boxed{\\ln 2}$$", "id": "1818837"}, {"introduction": "我们之前使用的直接求和法在处理真实的三维晶体时会遇到收敛极其缓慢的问题，因此并不实用。这项高级实践将向你介绍强大的埃瓦尔德求和（Ewald summation）技术，它通过将一个求和分解为在实空间和倒易空间中均快速收敛的两部分来实现精确计算[@problem_id:2424435]。通过为氯化钠（NaCl）和氯化铯（CsCl）等真实晶体结构实现此方法，你将接触到现代计算物理学中用于确定材料性质的核心工具。", "problem": "要求您实现一种数值稳定的 Ewald 求和方法，用以计算在周期性边界条件下两种三维离子晶体的无量纲马德隆常数：氯化钠（NaCl，岩盐结构）和氯化铯（CsCl，体心立方结构）。您的任务是从一个周期性的、电中性的晶胞的库仑能量出发，使用由 Ewald 分裂参数 $\\alpha$ 控制宽度的高斯屏蔽进行 Ewald 分解，然后设计一个程序来评估所得到的具有可控截断半径的实空间和倒易空间求和。\n\n基本原理和目标：\n- 从最小镜像约定下一个周期性的、中性的点电荷集的库仑相互作用能的定义开始。每个晶胞的总静电能是晶格所有镜像上的成对库仑相互作用之和，不包括自相互作用。\n- 引入高斯屏蔽，将 $1/r$ 核分裂为一个在实空间中处理的短程部分和一个在倒易空间中处理的平滑长程部分。使用平滑部分的傅里叶表示来获得一个快速收敛的倒易空间求和。\n- 实现因加减高斯分布而产生的自相互作用的移除。如果晶胞总电荷为零，则中和背景项为零。\n- 对于电荷为 $\\pm 1$ 的二元离子晶体，马德隆常数 $\\mathcal{M}$ 由每个离子的能量 $U/N$ 定义（其中库仑常数设为 $1$，因此对势为 $1/r$）：$\\mathcal{M} = - (U/N) r_0$，其中 $r_0$ 是最近邻距离。这个 $\\mathcal{M}$ 是无量纲的，它表征了晶格的几何结构。\n\n要建模的晶体：\n- 氯化钠（NaCl，岩盐结构）：使用边长为 $a = 1$ 的常规立方晶胞，包含 $8$ 个离子，其分数坐标在 $[0,1)$ 内：\n  - 负离子亚晶格位于 $(0,0,0)$、$(0,\\tfrac{1}{2},\\tfrac{1}{2})$、$(\\tfrac{1}{2},0,\\tfrac{1}{2})$、$(\\tfrac{1}{2},\\tfrac{1}{2},0)$，每个电荷为 $-1$。\n  - 正离子亚晶格位于 $(\\tfrac{1}{2},0,0)$、$(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$、$(0,0,\\tfrac{1}{2})$、$(0,\\tfrac{1}{2},0)$，每个电荷为 $+1$。\n  - 最近邻距离为 $r_0 = a/2 = 0.5$。\n- 氯化铯（CsCl，体心立方）：使用边长为 $a = 1$ 的常规立方晶胞，包含两个电荷：\n  - 位置 $(0,0,0)$ 处电荷为 $+1$，位置 $(\\tfrac{1}{2},\\tfrac{1}{2},\\tfrac{1}{2})$ 处电荷为 $-1$。\n  - 最近邻距离为 $r_0 = \\sqrt{3} a/2 = \\sqrt{3}/2$。\n\n待实现的算法规范：\n- 实空间求和：对晶格矢量 $\\mathbf{R} = a (n_x, n_y, n_z)$（其中 $n_x, n_y, n_z$ 为整数且 $|\\mathbf{R}| \\le R_{\\mathrm{cut}}$）以及所有基底对 $(i,j)$（其中 $i$ 和 $j$ 为晶胞内电荷的索引）进行求和。排除 $i=j, \\mathbf{R}=\\mathbf{0}$ 的自能项。要求和的短程对势为 $\\operatorname{erfc}(\\alpha r)/r$，其中 $r = |\\mathbf{r}_j - \\mathbf{r}_i + \\mathbf{R}|$，$\\operatorname{erfc}$ 是互补误差函数。包含因子 $\\tfrac{1}{2}$ 以避免对离子对的重复计数。\n- 倒易空间求和：对倒易晶格矢量 $\\mathbf{k} = 2\\pi (h_x, h_y, h_z)/a$（其中 $h_x, h_y, h_z$ 为整数，不包括 $\\mathbf{k}=\\mathbf{0}$，且 $|\\mathbf{k}| \\le K_{\\mathrm{max}}$）进行求和。定义结构因子 $S(\\mathbf{k}) = \\sum_j q_j e^{i \\mathbf{k}\\cdot\\mathbf{r}_j}$。对每个晶胞能量的贡献为\n  $$ \\frac{1}{2 V} \\sum_{\\mathbf{k}\\ne \\mathbf{0}} \\frac{4\\pi}{k^2} e^{-k^2/(4\\alpha^2)} \\lvert S(\\mathbf{k})\\rvert^2,$$\n  其中 $V = a^3$ 是晶胞体积。\n- 自相互作用校正：减去 $\\alpha/\\sqrt{\\pi} \\sum_i q_i^2$。\n- 中和背景：包含 $-\\pi \\, Q^2 /(2 \\alpha^2 V)$，其中 $Q = \\sum_i q_i$。对于指定的测试晶体，$Q=0$，因此该项恰好为零。\n\n目标量：\n- 计算每个晶胞的总能量 $U$，然后计算每个离子的能量 $U/N$，最后计算马德隆常数 $\\mathcal{M} = - (U/N) r_0$。马德隆常数是无量纲的。将所有数值结果报告为四舍五入到六位小数的浮点数。\n\n测试套件和要求的输出：\n- 使用 $a = 1$。\n- 使用实空间截断半径 $R_{\\mathrm{cut}} = 6.0$ 和倒易空间截断半径 $K_{\\mathrm{max}} = 25.0$。\n- 为每个结构评估 Ewald 分裂参数 $\\alpha$ 的三个值：$\\{1.6, 2.4, 3.2\\}$。\n- 有六个基本测试用例：\n  1. $(\\text{NaCl}, \\alpha = 1.6)$\n  2. $(\\text{NaCl}, \\alpha = 2.4)$\n  3. $(\\text{NaCl}, \\alpha = 3.2)$\n  4. $(\\text{CsCl}, \\alpha = 1.6)$\n  5. $(\\text{CsCl}, \\alpha = 2.4)$\n  6. $(\\text{CsCl}, \\alpha = 3.2)$\n- 关于 $\\alpha$ 的收敛性研究：对于每个结构，计算三个 $\\alpha$ 值结果与平均值之间的最大绝对偏差，即，对于结构 $X$ 定义\n  $$\\Delta_X = \\max_{\\alpha \\in \\{1.6,2.4,3.2\\}} \\left| \\mathcal{M}_X(\\alpha) - \\overline{\\mathcal{M}_X} \\right|,$$\n  其中 $\\overline{\\mathcal{M}_X}$ 是三个值的算术平均值。\n- 最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。顺序必须是\n  $$[\\mathcal{M}_{\\mathrm{NaCl}}(1.6),\\ \\mathcal{M}_{\\mathrm{NaCl}}(2.4),\\ \\mathcal{M}_{\\mathrm{NaCl}}(3.2),\\ \\Delta_{\\mathrm{NaCl}},\\ \\mathcal{M}_{\\mathrm{CsCl}}(1.6),\\ \\mathcal{M}_{\\mathrm{CsCl}}(2.4),\\ \\mathcal{M}_{\\mathrm{CsCl}}(3.2),\\ \\Delta_{\\mathrm{CsCl}}],$$\n  每个浮点数四舍五入到六位小数。马德隆常数是无量纲的，必须不带单位报告。", "solution": "所述问题是有效的。它具有科学依据、是良定的、客观的，并为得出唯一且可验证的解提供了所有必要信息。这是计算凝聚态物理学中的一个标准问题，要求实现 Ewald 求和方法来计算两种标志性晶体结构 NaCl 和 CsCl 的马德隆常数。我将继续提供完整的解法。\n\n基本任务是计算无限周期性晶格中每个晶胞的静电能 $U$。对于一个包含 $N$ 个点电荷 $q_i$（位于由矢量 $\\mathbf{a}_1, \\mathbf{a}_2, \\mathbf{a}_3$ 定义的晶格内的分数位置 $\\mathbf{f}_i$）的电中性晶胞，每个晶胞的总能量由所有相互作用对（包括周期性镜像）的和给出。将库仑常数设为 1，则表达式为：\n$$\nU = \\frac{1}{2} \\sum_{i=1}^{N} \\sum_{j=1}^{N} \\sum_{\\mathbf{R}}' \\frac{q_i q_j}{|\\mathbf{r}_j - \\mathbf{r}_i + \\mathbf{R}|}\n$$\n此处，$\\mathbf{r}_i = a \\mathbf{f}_i$ 是参考晶胞（对于边长为 $a$ 的立方晶胞）内的绝对坐标，$\\mathbf{R} = n_x \\mathbf{a}_1 + n_y \\mathbf{a}_2 + n_z \\mathbf{a}_3$ 是所有整数三元组 $(n_x, n_y, n_z)$ 对应的晶格矢量，求和符号上的撇号表示当 $\\mathbf{R}=\\mathbf{0}$ 时排除 $i=j$ 的项，以避免点电荷的无限自能。此求和是出了名的慢收敛和条件收敛。\n\nEwald 求和方法提供了一个优雅的解决方案，它利用恒等式 $1 = \\operatorname{erf}(\\alpha r) + \\operatorname{erfc}(\\alpha r)$ 将 $1/r$ 势分解为一个短程分量和一个长程分量，其中 $\\operatorname{erf}$ 是误差函数，$\\operatorname{erfc}$ 是互补误差函数。参数 $\\alpha$ 控制分解的宽度。\n$$\n\\frac{1}{r} = \\frac{\\operatorname{erfc}(\\alpha r)}{r} + \\frac{\\operatorname{erf}(\\alpha r)}{r}\n$$\n第一项 $\\operatorname{erfc}(\\alpha r)/r$ 随 $r$ 快速衰减，使其适合在实空间中进行直接的截断求和。第二项 $\\operatorname{erf}(\\alpha r)/r$ 是一个平滑的长程函数，其傅里叶变换快速收敛。这部分在倒易空间中进行评估。\n\n这种分解是通过在每个点电荷 $q_j$ 周围放置一个符号相反的中和高斯电荷分布 $-\\rho_j(\\mathbf{r}) = -q_j (\\alpha/\\sqrt{\\pi})^3 e^{-\\alpha^2 r^2}$，然后再加回一个符号相同的相同分布 $\\rho_j(\\mathbf{r}) = q_j (\\alpha/\\sqrt{\\pi})^3 e^{-\\alpha^2 r^2}$ 来实现的。第一步屏蔽了点电荷，从而得到短程的实空间求和。第二步校正了这种屏蔽，并在倒易空间中处理。\n\n因此，总能量 $U$ 被分解为三个部分：$U = U_{\\text{real}} + U_{\\text{recip}} + U_{\\text{self}}$。\n\n1.  **实空间能量 ($U_{\\text{real}}$)**：这是由中和高斯云屏蔽的点电荷之间的相互作用能。求和是对模拟盒子内的离子对及其周期性镜像进行的，直至截断距离 $R_{\\mathrm{cut}}$。\n    $$\n    U_{\\text{real}} = \\frac{1}{2} \\sum_{i=1}^{N} \\sum_{j=1}^{N} q_i q_j \\sum_{\\mathbf{R}, |\\mathbf{r}_{ij}+\\mathbf{R}| \\le R_{\\mathrm{cut}}}' \\frac{\\operatorname{erfc}(\\alpha |\\mathbf{r}_j - \\mathbf{r}_i + \\mathbf{R}|)}{|\\mathbf{r}_j - \\mathbf{r}_i + \\mathbf{R}|}\n    $$\n    其中 $\\mathbf{r}_{ij} = \\mathbf{r}_j - \\mathbf{r}_i$。撇号再次表示省略奇异的 $i=j, \\mathbf{R}=\\mathbf{0}$ 项。对于足够大的 $\\alpha$，此和快速收敛。\n\n2.  **倒易空间能量 ($U_{\\text{recip}}$)**：该项抵消了屏蔽云的影响。高斯分布的平滑性质使得可以通过对倒易晶格矢量 $\\mathbf{k}$ 的傅里叶级数来高效评估它们的相互作用能。\n    $$\n    U_{\\text{recip}} = \\frac{1}{2V} \\sum_{\\mathbf{k} \\ne \\mathbf{0}, |\\mathbf{k}| \\le K_{\\mathrm{max}}} \\frac{4\\pi}{k^2} e^{-k^2 / (4\\alpha^2)} |S(\\mathbf{k})|^2\n    $$\n    此处，$V=a^3$ 是立方晶胞的体积，求和是对倒易晶格矢量 $\\mathbf{k} = (2\\pi/a)(h_x, h_y, h_z)$（其中 $(h_x, h_y, h_z)$ 是整数三元组）进行的，直至截断半径 $K_{\\mathrm{max}}$。$\\mathbf{k}=\\mathbf{0}$ 项被排除。$S(\\mathbf{k})$ 是结构因子，定义为：\n    $$\n    S(\\mathbf{k}) = \\sum_{j=1}^{N} q_j e^{i \\mathbf{k} \\cdot \\mathbf{r}_j}\n    $$\n    对于电中性系统（$Q = \\sum_j q_j = 0$），对应于均匀中和背景的项 $-\\pi Q^2 / (2 \\alpha^2 V)$ 为零，对于指定的晶体即是如此。\n\n3.  **自相互作用校正 ($U_{\\text{self}}$)**：为每个电荷引入屏蔽高斯分布会导致电荷与其自身屏蔽云之间产生非物理的相互作用。这必须被减去。校正项为：\n    $$\n    U_{\\text{self}} = - \\frac{\\alpha}{\\sqrt{\\pi}} \\sum_{i=1}^{N} q_i^2\n    $$\n\n马德隆常数 $\\mathcal{M}$ 是一个无量纲的量，它表征了晶体中一个离子的静电能。对于电荷为 $\\pm 1$ 的二元离子晶体，它通过每个离子对的能量，或更普遍地，通过每个离子的能量 $U/N$ 来定义。当库仑常数设为 $1$ 时，定义为：\n$$\n\\mathcal{M} = - \\frac{U/N}{1/r_0} = - \\frac{U \\cdot r_0}{N}\n$$\n其中 $r_0$ 是最近邻距离。\n\n在计算中，我们使用指定的参数：晶格常数 $a=1$，实空间截断半径 $R_{\\mathrm{cut}}=6.0$，以及倒易空间截断半径 $K_{\\mathrm{max}}=25.0$。我们对 $\\alpha \\in \\{1.6, 2.4, 3.2\\}$ 进行评估。\n\n**对于 NaCl（岩盐结构）：**\n晶胞包含 $N=8$ 个离子。给出了负离子（$q=-1$）和正离子（$q=+1$）的分数坐标。最近邻距离是 $r_0 = a/2 = 0.5$。\n\n**对于 CsCl（体心立方结构）：**\n晶胞包含 $N=2$ 个离子，$q=+1$ 位于 $(0,0,0)$，$q=-1$ 位于 $(\\frac{1}{2},\\frac{1}{2},\\frac{1}{2})$。最近邻距离是 $r_0 = a\\sqrt{3}/2 = \\sqrt{3}/2$。\n\n数值实现的过程是：构建遍历实空间晶格矢量和倒易空间矢量的循环，直至指定的截断半径；计算三个能量分量；将它们相加得到总能量 $U$；最后计算马德隆常数 $\\mathcal{M}$。通过计算每种晶体结构的结果与平均值之间的最大绝对偏差 $\\Delta_X$，来评估计算相对于 $\\alpha$ 的稳定性。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import erfc\n\ndef calculate_madelung(structure_name, alpha):\n    \"\"\"\n    Computes the Madelung constant for a given crystal structure using Ewald summation.\n    \"\"\"\n    if structure_name == \"NaCl\":\n        a = 1.0\n        r_neg = np.array([[0.0, 0.0, 0.0], [0.0, 0.5, 0.5], [0.5, 0.0, 0.5], [0.5, 0.5, 0.0]])\n        r_pos = np.array([[0.5, 0.0, 0.0], [0.5, 0.5, 0.5], [0.0, 0.0, 0.5], [0.0, 0.5, 0.0]])\n        positions = a * np.vstack((r_neg, r_pos))\n        charges = np.array([-1.0] * 4 + [1.0] * 4)\n        N = 8\n        r0 = a / 2.0\n    elif structure_name == \"CsCl\":\n        a = 1.0\n        positions = a * np.array([[0.0, 0.0, 0.0], [0.5, 0.5, 0.5]])\n        charges = np.array([1.0, -1.0])\n        N = 2\n        r0 = a * np.sqrt(3.0) / 2.0\n    else:\n        raise ValueError(\"Unknown structure\")\n\n    R_cut = 6.0\n    K_max = 25.0\n    V = a**3\n\n    # Real-space sum\n    U_real = 0.0\n    R_max_int = int(np.floor(R_cut / a))\n    for nx in range(-R_max_int, R_max_int + 1):\n        for ny in range(-R_max_int, R_max_int + 1):\n            for nz in range(-R_max_int, R_max_int + 1):\n                R_vec = a * np.array([nx, ny, nz])\n                if np.linalg.norm(R_vec) > R_cut:\n                    continue\n                \n                for i in range(N):\n                    for j in range(N):\n                        if i == j and nx == 0 and ny == 0 and nz == 0:\n                            continue\n                        \n                        r_ij_vec = positions[j] - positions[i] + R_vec\n                        r_mag = np.linalg.norm(r_ij_vec)\n                        \n                        if r_mag > 0:\n                            U_real += charges[i] * charges[j] * erfc(alpha * r_mag) / r_mag\n    U_real *= 0.5\n\n    # Reciprocal-space sum\n    U_recip = 0.0\n    h_max_int = int(np.floor(a * K_max / (2 * np.pi)))\n    for hx in range(-h_max_int, h_max_int + 1):\n        for hy in range(-h_max_int, h_max_int + 1):\n            for hz in range(-h_max_int, h_max_int + 1):\n                if hx == 0 and hy == 0 and hz == 0:\n                    continue\n                \n                k_vec = (2 * np.pi / a) * np.array([hx, hy, hz])\n                k_sq = np.dot(k_vec, k_vec)\n                \n                if k_sq > K_max**2:\n                    continue\n                \n                # Structure factor S(k)\n                k_dot_r = np.dot(positions, k_vec)\n                S_k = np.sum(charges * np.exp(1j * k_dot_r))\n                S_k_sq = np.abs(S_k)**2\n                \n                U_recip += (4 * np.pi / k_sq) * np.exp(-k_sq / (4 * alpha**2)) * S_k_sq\n    U_recip *= 1.0 / (2.0 * V)\n\n    # Self-interaction correction\n    sum_q_sq = np.sum(charges**2)\n    U_self = -(alpha / np.sqrt(np.pi)) * sum_q_sq\n\n    # Total energy\n    U_total = U_real + U_recip + U_self\n\n    # Madelung constant\n    madelung = - (U_total / N) * r0\n    \n    return madelung\n\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and produce the final output.\n    \"\"\"\n    alphas = [1.6, 2.4, 3.2]\n    \n    # Run test cases for NaCl\n    m_nacl_results = []\n    for alpha in alphas:\n        m_nacl = calculate_madelung(\"NaCl\", alpha)\n        m_nacl_results.append(m_nacl)\n    \n    mean_m_nacl = np.mean(m_nacl_results)\n    delta_nacl = np.max(np.abs(np.array(m_nacl_results) - mean_m_nacl))\n    \n    # Run test cases for CsCl\n    m_cscl_results = []\n    for alpha in alphas:\n        m_cscl = calculate_madelung(\"CsCl\", alpha)\n        m_cscl_results.append(m_cscl)\n        \n    mean_m_cscl = np.mean(m_cscl_results)\n    delta_cscl = np.max(np.abs(np.array(m_cscl_results) - mean_m_cscl))\n    \n    # Combine all results for final output\n    final_results = m_nacl_results + [delta_nacl] + m_cscl_results + [delta_cscl]\n    \n    # Format and print the final output\n    output_str = \",\".join([f\"{x:.6f}\" for x in final_results])\n    print(f\"[{output_str}]\")\n\nsolve()\n\n```", "id": "2424435"}]}