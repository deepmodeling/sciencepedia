## 引言
免疫系统的功能深刻地根植于其细胞在组织内的精确空间排布。从[淋巴结](@entry_id:191498)中[T细胞和B细胞](@entry_id:154345)的有序[区室化](@entry_id:270828)，到[肿瘤微环境](@entry_id:152167)中免疫细胞与癌细胞的相互作用，细胞的位置决定了其功能和命运。然而，传统的组学技术，如[批量RNA测序](@entry_id:203183)，虽能提供全景式的基因表达谱，却丢失了所有空间信息；而[单细胞RNA测序](@entry_id:142269)在揭示[细胞异质性](@entry_id:262569)方面取得了革命性突破，但同样以牺牲组织原位环境为代价。这一知识鸿沟限制了我们对免疫过程在完整组织背景下如何被调控的理解。

空间转录组学作为一项突破性技术，正填补这一鸿沟，它能够以前所未有的分辨率同时捕获基因表达信息及其在组织切片上的精确空间坐标。本文旨在为免疫学领域的研究生和科研人员提供一份关于免疫组织[空间转录组学分析](@entry_id:173771)的全面指南。我们将带领读者穿越从原始数据到生物学洞见的完整旅程。

- 在“**原理与机制**”一章中，我们将深入探讨空间转录组数据的独特结构和统计特性，并介绍从[数据标准化](@entry_id:147200)、质量控制到识别空间模式和解构细胞组成的核心计算方法。
- 随后，在“**应用与跨学科[交叉](@entry_id:147634)**”一章中，我们将展示这些技术如何应用于剖析免疫微观解剖、绘制细胞通讯网络，以及在[肿瘤免疫学](@entry_id:155285)和免疫治疗等前沿领域解决关键科学问题。
- 最后，通过“**上手实践**”部分，读者将有机会亲手操作，应用所学知识解决真实的生物信息学挑战，巩固对核心概念的理解。

通过学习本文，您将掌握在空间维度上理解免疫系统所必需的理论知识和分析技能，为在您自己的研究中利用这一强大技术奠定坚实的基础。

## 原理与机制

本章将深入探讨在免疫组织背景下，[空间转录组学](@entry_id:270096)研究的核心原理与关键机制。我们将从数据的基本构成与固有属性出发，系统性地介绍数据处理、分析方法，并最终落脚于如何利用这些工具，从空间分辨的基因表达数据中提取深刻的生物学机制性见解。

### 空间[转录组](@entry_id:274025)数据的本质

要有效利用空间转录组数据，首先必须理解其独特的结构、物理限制以及统计学特性。

#### 数据结构与物理属性

基于捕获点的[空间转录组学](@entry_id:270096)实验，其原始数据主要由两个相互关联的部分构成：一个基因表达矩阵和一个空间坐标矩阵 [@problem_id:2890020]。基因表达矩阵通常表示为 $X \in \mathbb{N}_{0}^{G \times S}$，其中 $G$ 是基因的数量，$S$ 是空间捕获点的数量。矩阵中的每个元素 $X_{g,s}$ 代表在捕获点 $s$ 处检测到的基因 $g$ 的独特分子标识（Unique Molecular Identifier, UMI）计数，这是一个非负整数。每个捕获点 $s$（即矩阵的每一列）都对应一个物理空间坐标 $\mathbf{r}_{s} = (x_{s},y_{s})$，该坐标记录了该点在组织切片上的精确位置，通常以微米（$\mu m$）为单位。

这些数据的解释受到技术物理参数的严格制约。其中两个核心概念是 **捕获点尺寸（spot size）** 和 **有效分辨率（effective resolution）** [@problem_id:2890041]。**捕获点尺寸** 是指技术平台在载玻片上制造的单个条形码[捕获区域](@entry_id:266038)的物理大小，例如，一个直径为 $55 \, \mu m$ 的圆形区域。然而，**有效分辨率** 才是决定我们能分辨多小组织特征的关键。由于 mRNA 分子在被捕获前会从其来源细胞发生一定程度的侧向[扩散](@entry_id:141445)，因此最终的信号源于一个比物理捕获点更广的区域。有效分辨率由一个“[点扩散函数](@entry_id:183154)”（point-spread function）的宽度定义，该函数是捕获点几何形状与 mRNA [扩散](@entry_id:141445)效应的卷积。因此，有效分辨率通常劣于（即大于）物理捕获点尺寸。

这种有限的分辨率直接导致了 **部分容积效应（partial volume effect）**，即单个捕获点的信号是其捕获范围内所有细胞转录本的混合体。在像淋巴结这样细胞密集的免疫组织中，一个直径 $55 \, \mu m$ 的捕获点区域内可能包含多个甚至数十个细胞。例如，在一个二维细胞质心密度为 $\rho = 0.0042 \, \text{cells}/\mu m^2$ 的[淋巴结](@entry_id:191498)区域，一个直径 $55 \, \mu m$ 的圆形捕获点（面积 $A \approx 2376 \, \mu m^2$）预计会覆盖大约 $\lambda = \rho \times A \approx 10$ 个细胞。如果该区域由 60% 的 B 细胞和 40% 的 T 细胞组成，那么一个捕获点几乎肯定（概率约 0.98）会同时捕获到这两种细胞的转录本，其测量值便成为这两种细胞特征的线性叠加 [@problem_id:2890041]。理解这一点对于后续的数据解构至关重要。

#### 统计学特性

从统计学角度看，UMI 计数数据是离散的计数数据，反映了对组织中潜在 mRNA 分子库的[随机抽样](@entry_id:175193)过程。作为第一近似，可以将 UMI [计数过程](@entry_id:260664)建模为泊松（Poisson）[分布](@entry_id:182848)。然而，真实的测序数据几乎普遍存在 **[过度离散](@entry_id:263748)（overdispersion）** 现象，即数据的[方差](@entry_id:200758)显著大于其均值。这种额外的变异性源于多方面因素，包括基因表达的内在随机性（如[转录爆发](@entry_id:156205)）和未被建模的技术噪声 [@problem_id:2890020] [@problem_id:2890104]。

因此，**负二项（Negative Binomial, NB）[分布](@entry_id:182848)** 成为了描述 UMI 计数数据更为精确和稳健的模型。[负二项分布](@entry_id:262151)是[泊松分布](@entry_id:147769)的一个推广，它包含一个额外的离散参数，用以描述超出泊松模型预期的变异程度。NB [分布](@entry_id:182848)可以被看作是一个 Gamma-Poisson [混合模型](@entry_id:266571)，这为[过度离散](@entry_id:263748)提供了一个优雅的生成性解释：每个基因的“真实”表达率本身是在不同细胞或不同时间点波动的（遵循 Gamma [分布](@entry_id:182848)），而我们观测到的 UMI 计数是在给定该表达率下的一个泊松抽样。这一统计学原理是许多高级分析方法（如 sctransform 标准化和细胞类型去卷积）的基石。

### 基础数据处理与质量控制

原始的 UMI 计数矩阵不能直接用于生物学比较，因为它同时包含了生物学信号和显著的技术变异。严谨的数据处理旨在最大限度地分离这两者。

#### 标准化

[标准化](@entry_id:637219)的首要目标是校正不同捕获点之间由于捕获效率和[测序深度](@entry_id:178191)不同而引入的技术差异。

最简单的方法是 **文库大小标准化（library-size normalization）**，即每个捕获点的所有基因计数都除以该点的总 UMI 计数（即文库大小 $D_s$）。**每百万计数（Counts Per Million, CPM）** 与此类似，只是在[标准化](@entry_id:637219)的基础上乘以一个固定的比例因子（如 $10^6$）。这些方法都是线性的，其优点是保留了捕获点内部基因与基因之间的表达比例。然而，它们假设总 RNA 含量与细胞类型或状态无关，并且无法校正数据中的[异方差性](@entry_id:136378)（即[方差](@entry_id:200758)随均值变化的趋势）[@problem_id:2890020]。

**sctransform** 是一种更先进的基于模型的[标准化](@entry_id:637219)方法。它为每个基因拟合一个负二项[广义线性模型](@entry_id:171019)（NB-GLM），其中将文库大小的对数（$\ln D_s$）作为一个协变量（具体来说是“偏移量”，其系数固定为 1），从而直接在模型中解释了[测序深度](@entry_id:178191)的影响。该方法产生的“[标准化](@entry_id:637219)值”是模型的皮尔逊残差（Pearson residuals）。这些残差有几个关键优势：它们近似实现了[方差](@entry_id:200758)稳定（即[方差](@entry_id:200758)不再依赖于均值），这对于许多下游的线性分析方法（如主成分分析 PCA）是理想的输入；它们的值可正可负，代表了偏离模型期望的程度。但需要注意的是，这种[非线性变换](@entry_id:636115)不再保持点内的基因表达比率 [@problem_id:2890020]。

#### 混杂因素

混杂因素是与我们感兴趣的生物学变量和我们测量的结果都相关的变量，如果不对其进行校正，就会导致虚假的关联。

一个在[空间分析](@entry_id:183208)中尤为重要的混杂是 **空间混杂（spatial confounding）**。它通常源于组织固有的、与我们研究问题无关的生物学结构差异。一个典型的例子是细胞密度的空间变异 [@problem_id:2890070]。例如，在淋巴结中，生发中心暗区（DZ）的细胞密度远高于副皮质区（PC）。假设我们正在比较这两个区域的一个基因的表达。即使该基因在每个细胞中的平均表达水平在两个区域是完全相同的，但由于 DZ 区域的捕获点（spots）平均包含更多的细胞（即更高的细胞数 $N_s$），我们观测到的原始 UMI 计数 $Y_{sg}$ 在 DZ 区域也会系统性地更高。如果我们忽略细胞数 $N_s$ 这个变量，直接比较两区域的 $Y_{sg}$，就会错误地推断该基因在 DZ 中“上调”。在这里，$N_s$ 就是一个混杂因素，因为它既与区域（“暴露”）相关，又会因果性地影响 UMI 计数（“结果”），构成了一条需要被阻断的“后门路径”。因此，在进行[差异表达分析](@entry_id:266370)时，必须在[统计模型](@entry_id:165873)中对细胞数（或其代理变量，如总 UMI 计数）进行校正。

另一个常见的混杂是 **批次效应（batch effects）**。当实验涉及多个样本、多张切片或多次测序运行时，这些在不同“批次”中处理的样本之间会产生系统性的、非生物学来源的差异。将[批次效应](@entry_id:265859)与真实的生物学变异区分开来至关重要 [@problem_id:2889963]。
- **批次效应的特征**：[批次效应](@entry_id:265859)通常表现为数据中一个或多个主要变异轴（如 PCA 的主成分）与技术协变量（如切片 ID、测序泳道）高度相关。它们会引起许多基因（包括本应稳定的管家基因和定量添加的 spike-in 对照）在不同批次间发生系统性的表达平移。
- **真实生物学变异的特征**：与此相反，真实的生物学空间变异通常与组织微观解剖结构高度吻合，具有很高的[空间自相关](@entry_id:177050)性（例如，B 细胞标志物基因在淋巴滤泡区域聚集）。这种模式在不同的生物学重复（如不同供体）的相应组织区域中是保守和可复现的，并且通常集中于特定的、与细胞谱系或功能相关的基因集，而不是影响所有基因。

### 分析空间模式与组织结构

在对数据进行预处理后，下一步是识别并量化基因表达的空间模式。

#### 量化空间结构

**[空间自相关](@entry_id:177050)（spatial autocorrelation）** 是一个核心概念，用以衡量一个基因的表达模式是聚集的、分散的还是随机的。

**[莫兰指数](@entry_id:192667) I（[Moran's I](@entry_id:192667)）** 和 **基里指数 C（Geary's C）** 是两个经典的全局[空间自相关](@entry_id:177050)统计量 [@problem_id:2889936]。它们都基于一个预先定义的空间邻近图（例如，[k-近邻图](@entry_id:751051)），该图定义了哪些捕获点是“邻居”。
- **[莫兰指数](@entry_id:192667) I** 类似于一个空间化的相关系数，衡量的是相邻位置上变量值（减去均值后）的协[方差](@entry_id:200758)。其定义为：
$$ I = \frac{N}{S_{0}} \frac{\sum_{i=1}^{N}\sum_{j=1}^{N} w_{ij}(x_i - \bar{x})(x_j - \bar{x})}{\sum_{i=1}^{N} (x_i - \bar{x})^2} $$
其中，$x_i$ 是基因在点 $i$ 的表达值，$N$ 是总点数，$w_{ij}$ 是空间权重矩阵的元素，$S_0$ 是所有权重的总和。在无空间结构的[零假设](@entry_id:265441)下，其[期望值](@entry_id:153208)约为 0。$I > 0$ 表示正[自相关](@entry_id:138991)（相似的值聚集在一起，如高-高或低-低），例如，在生发中心内富集的趋化[因子基](@entry_id:637504)因。$I < 0$ 表示负自相关（不相似的值相邻，呈棋盘状），例如，在 T 细胞区和 B 细胞区清晰界线两侧交替出现高低表达的基因。

- **基里指数 C** 则关注相邻位置值的差异。其定义为：
$$ C = \frac{N-1}{2 S_{0}} \frac{\sum_{i=1}^{N}\sum_{j=1}^{N} w_{ij}(x_i - x_j)^2}{\sum_{i=1}^{N} (x_i - \bar{x})^2} $$
在零假设下，其[期望值](@entry_id:153208)为 1。$C < 1$ 表示正自相关（邻居间差异小），而 $C > 1$ 表示负[自相关](@entry_id:138991)（邻居间差异大）。这两个指数从不同角度为基因表达的“空间性”提供了量化指标。

#### 识别空间域

超越单个基因，一个关键任务是识别 **空间域（spatial domains）**，即由多个基因共同定义、具有一致表达特征的连续组织区域。

识别空间域的方法大致可分为两类 [@problem_id:2890018]：
1.  **概率模型方法**：这类方法的代表是 **隐[马尔可夫随机场](@entry_id:751685)（Hidden Markov Random Field, HMRF）**。HMRF 将空间域的识别问题构建为一个统计推断问题。它假设每个捕获点属于一个未知的（“隐藏的”）离散状态或域，并且每个域有其特定的基因表达谱。该模型包含两个核心部分：一个数据似然项，描述了给定域标签时观测到基因表达的概率；一个空间先验项（如 Potts 模型），它对分配给相邻捕获点的不同标签施加惩罚。这个先验项鼓励了域的连通性和平滑性。通过最大化[后验概率](@entry_id:153467)，HMRF 能够同时利用表达信息和空间信息来推断域的划分。由于其模型驱动的特性和对空间连续性的明确建模，HMRF 在信噪比较低的情况下通常比纯算法方法更为稳健。
2.  **[基于图的聚类](@entry_id:174462)方法**：这类方法将空间捕获点网络视为一个图，并应用[社区发现](@entry_id:143791)算法来寻找图中的模块化结构。常用的算法如 Louvain 或 Leiden，它们通过优化一个名为“模块度”（modularity）的目标函数来对节点（即捕获点）进行划分。这些方法速度快，易于实现，但其结果可能受分辨率参数的影响，并且在默认情况下，它们仅利用了空间邻近信息，而没有直接整合基因表达的统计模型。

这两种方法各有优势。例如，当真实域的形状是细长的、各向异性的（如沿着血管[排列](@entry_id:136432)的基质细胞走廊），一个使用了相应各向异性权重图的[社区发现](@entry_id:143791)算法可能能更好地捕捉这种几何形状。另一方面，HMRF 模型可以通过使其空间先验依赖于数据本身（例如，表达相似的邻居之间有更强的连接先验）而变得更具适应性，从而能够识别具有不同清晰度边界的复杂域结构 [@problem_id:2890018]。

### 解构细胞组成与功能

由于大多数空间转录组学技术（尤其是基于捕获点的方法）的分辨率是多细胞级别的，因此一个核心的分析挑战是 **细胞类型去卷积（cell type deconvolution）**：即从混合信号中推断出每个捕获点内部的细胞类型组成。

#### 去卷积的原理

这项任务通常依赖于一个高分辨率的单细胞 RNA 测序（[scRNA-seq](@entry_id:155798)）数据集作为“参考”。该参考数据集提供了各种细胞类型（如 B 细胞、T 细胞、巨噬细胞等）的“纯净”的基因表达特征谱，记为 $\mu_{gc}$（基因 $g$ 在细胞类型 $c$ 中的平均表达）。其核心思想是，我们在空间捕获点 $s$ 观测到的表达向量 $Y_s$ 可以被建模为这些参考特征谱的[线性组合](@entry_id:154743)，其权重正比于各种细胞类型在点 $s$ 的丰度 $\theta_{sc}$。整个模型可以写作：
$$ Y_{sg} \sim \text{NB} \left( L_s \sum_c \theta_{sc} \mu_{gc}, \phi_g \right) $$
其中，$L_s$ 是捕获点特异性的技术比例因子，$\phi_g$ 是基因特异性的离散参数，而 NB 代表负二项分布，它能恰当地处理计数的[过度离散](@entry_id:263748)特性 [@problem_id:2890104]。去卷积的目标就是利用已知的 $Y_{sg}$ 和 $\mu_{gc}$ 来推断未知的丰度 $\theta_{sc}$。

#### 去卷积方法比较

现有多种方法来实现这一目标，它们在[概率模型](@entry_id:265150)的具体设定、约束条件和推断策略上有所不同 [@problem_id:2890104]。
- **RCTD (Robust Cell Type Decomposition)**：该方法使用泊松（Poisson）似然，并在模型中包含一个额外的平台校正因子 $h_g$ 来解释空间和单细胞平台间的技术差异。它通常使用频率派的[期望最大化](@entry_id:273892)（EM）算法进行推断，并估计细胞类型的**相对比例**（即 $\sum_c \pi_{sc} = 1$）。

- **Stereoscope**：此方法采用负二项（NB）[似然](@entry_id:167119)，这通常能更好地拟合[过度离散](@entry_id:263748)的 UMI 数据。它也估计细胞类型的**相对比例**（$\sum_c \theta_{sc} = 1$），并使用[变分推断](@entry_id:634275)（variational inference）这一贝叶斯[近似推断](@entry_id:746496)方法来学习参数。

- **cell2location**：这是一个功能更为强大的贝叶斯[分层模型](@entry_id:274952)。它同样基于 NB [分布](@entry_id:182848)，但其关键创新在于它估计的是每种细胞类型的**绝对丰度**（$w_{sc}$），而不是受限于总和为 1 的相对比例。这意味着 cell2location 不仅能告诉我们一个捕获点中 B 细胞占多少比例，还能估计出那里大概有多少个 B 细胞，从而提供了对细胞密度的直接推断。它通过复杂的贝叶斯分层结构和[变分推断](@entry_id:634275)来实现这一点。

选择哪种方法取决于具体的生物学问题，例如，我们是更关心细胞类型的相对组成还是它们的绝对数量和空间密度。

### 从免疫组织的空间基因表达中获得机制性见解

空间转录组学的最终目标是超越描述性的模式发现，深入探究驱动组织形成和功能的生物学机制。免疫组织，特别是[淋巴结](@entry_id:191498)，为展示这一能力提供了绝佳的舞台。

#### 将解剖结构映射到[转录组](@entry_id:274025)

空间转录组数据就像一张分子层面的解剖图谱。通过识别在特定区域共表达的基因模块，我们可以精确地描绘出免疫组织的微观结构 [@problem_id:2890005]。在响应免疫的[淋巴结](@entry_id:191498)中，我们可以清晰地辨认出：
- **被膜下窦（Subcapsular Sinus）**：由表达[淋巴](@entry_id:189656)管内皮标志物（如 `Lyve1`, `Prox1`）的细胞构成，并富含表达 `Siglec1` 的被膜下窦巨噬细胞。
- **T 细胞区（副皮质区）**：其结构由成纤维网状细胞（FRC）网络支撑，这些细胞高表达 `Pdpn` 以及趋化因子 `Ccl19` 和 `Ccl21`。该区域因此富含表达这些趋化因子受体 `Ccr7` 的 T 细胞（高 `Trac`, `Cd3d`）。
- **B 细胞滤泡**：由表达趋化因子 `Cxcl13` 的[滤泡树突状细胞](@entry_id:200858)（FDC）组织，吸引并留住表达其受体 `Cxcr5` 的 B 细胞。
- **生发中心（Germinal Center, GC）**：在 B 细胞滤泡内形成，并进一步细分为：
    - **暗区（Dark Zone）**：B 细胞在此快速增殖（高 `Mki67`），并进行[体细胞高频突变](@entry_id:150461)。此处的 B 细胞高表达 `Cxcr4`，并受到 `Cxcl12` 趋化因子的吸引。关键的[诱变](@entry_id:273841)酶 AID（由 `Aicda` 基因编码）的表达在此达到峰值。
    - **亮区（Light Zone）**：增殖停止，B 细胞在此接受 T 细胞的筛选。此处的 B 细胞和 T 滤泡辅助细胞（Tfh）高表达 `Cxcr5` 和相互作用分子（如 `Cd83`, `Cd40`）。
- **髓质（Medulla）**：靠近[淋巴结](@entry_id:191498)的门部，包含由表达 `Jchain`、`Xbp1` 等基因的[浆细胞](@entry_id:164894)组成的[髓索](@entry_id:181221)，以及用于[淋巴细胞](@entry_id:185166)流出的髓窦。

#### 推断动态过程

空间快照不仅能揭示静态结构，还能为我们理解其背后的动态过程提供线索。

**细胞迁移与[区室化](@entry_id:270828)**：[淋巴结](@entry_id:191498)中 T 细胞区和 B 细胞区的泾渭分明，并非静态的隔离，而是一个由趋化因子梯度维持的动态平衡。我们可以通过生物物理模型来理解这一机制 [@problem_id:2890195]。其核心在于，T 细胞区和 B 细胞区分别产生不同的趋化因子（T 区的 `CCL19/21` 和 B 区的 `CXCL13`），而 T 细胞和 B 细胞又差异性地表达相应的受体（T 细胞的 `CCR7` 和 B 细胞的 `CXCR5`）。当一个 T 细胞偶然漫步到 T/B 边界时，它感受到的来自 T 区的“[拉回](@entry_id:160816)”信号（`CCL19/21` 梯度）远强于来自 B 区的“推斥”信号（`CXCL13` 梯度），从而被有效地限制在 T 区内。B 细胞的情况则正好相反。这种稳定的区室化得以维持，需要满足几个条件：首先，细胞必须能感知到梯度，这意味着趋化因子浓度不能过高以至于受体饱和；其次，细胞的响应必须足够持久，即受体在介导细胞返回其“家园”之前不能过快地脱敏。

**原位细胞功能**：空间表达谱还能揭示特定微环境中细胞正在执行的复杂生物化学功能。生发中心暗区就是一个绝佳的例子 [@problem_id:2890153]。我们观察到 `Aicda` 基因（编码[诱变](@entry_id:273841)酶 AID）的表达在暗区达到峰值。这背后的机制是，暗区是 B 细胞快速增殖的场所（高 `MKI67`），而 AID 酶的作用底物是活跃转录的免疫球蛋白（Ig）基因上的单链 DNA。细胞将[诱变](@entry_id:273841)酶的表达与底物最丰富的[细胞周期阶段](@entry_id:170415)和空间位置耦合起来，是实现高效[体细胞高频突变](@entry_id:150461)的逻辑结果。更进一步，我们可以预测，要将 AID 制造的 C-U 错配碱基对转化为最终的[基因突变](@entry_id:262628)，细胞必须同时高表达一套特定的、倾向于出错的 DNA 修复通路。因此，我们预期在 `Aicda` 高表达的暗区捕获点中，也应富含来自[碱基切除修复通路](@entry_id:192136)（如 `Ung`）、[错配修复](@entry_id:140802)通路（如 `Msh2`, `Msh6`, `Exo1`）以及[跨损伤合成](@entry_id:149383)聚合酶（如 `Polh`, `Rev1`）的基因转录本。空间转录组学实验精准地证实了这种[功能模块](@entry_id:275097)的[共定位](@entry_id:187613)，为我们提供了在完整组织背景下研究复杂[生物过程](@entry_id:164026)的有力证据。