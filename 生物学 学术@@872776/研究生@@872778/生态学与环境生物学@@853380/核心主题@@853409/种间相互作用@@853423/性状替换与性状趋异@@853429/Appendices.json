{"hands_on_practices": [{"introduction": "性状置换是由种间竞争驱动的。为了对这一过程进行建模，我们首先需要一种方法，根据竞争物种在资源利用上的重叠程度来量化竞争强度。这项练习将指导您推导一个经典的竞争度量——生态位重叠积分 [@problem_id:2475761]。通过计算具有高斯形资源利用曲线的物种间的该积分，您将深刻理解性状分离度 ($|z_1 - z_2|$) 和生态位宽度 ($\\omega$) 如何共同决定竞争互作的强度。", "problem": "在一个经典的消费者-资源框架下的种间竞争模型中，假设有两个（$2$）物种，其特征由一个连续的生态位位置性状 $z$ 决定。该性状 $z$ 决定了它们沿一维（$1$-D）非生物资源轴 $R \\in \\mathbb{R}$ 的资源利用均值。设具有生态位位置 $z$ 的物种的资源利用函数为高斯函数，且归一化后积分为 $1$，因此可以解释为资源上的概率密度：\n$$\nu(z,R) \\;=\\; \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\!\\left(-\\frac{(R - z)^{2}}{2\\,\\omega^{2}}\\right),\n$$\n其中 $\\omega0$ 是生态位宽度（标准差），并假设在物种间是相等的。\n\n定义重叠积分\n$$\nO(z_{1},z_{2}) \\;=\\; \\int_{-\\infty}^{\\infty} u(z_{1},R)\\,u(z_{2},R)\\,dR,\n$$\n该积分通过共享资源利用来可操作化地定义了潜在种间竞争的程度，在将竞争强度与资源重叠联系起来的理论中被广泛使用。\n\n仅从 $u(z,R)$ 的归一化、指数法则以及对任意 $a0$ 成立的标准高斯积分 $\\int_{-\\infty}^{\\infty} \\exp\\!\\left(-a\\,(x-b)^{2}\\right)\\,dx \\,=\\, \\sqrt{\\pi/a}$ 出发，推导 $O(z_{1},z_{2})$ 作为性状分离度 $|z_{1}-z_{2}|$ 和生态位宽度 $\\omega$ 的函数的闭式表达式。然后，使用生态竞争理论中的经典假设，即人均竞争影响随 $O(z_{1},z_{2})$ 单调增加，解释在频率依赖性选择下 $O$ 的进化最小化如何与性状替换和性状趋异相关，并明确指出 $\\omega$ 作为标度参数在性状空间中决定重叠强度和空间范围的作用。\n\n你最终报告的答案必须是 $O$ 关于 $|z_{1}-z_{2}|$ 和 $\\omega$ 的单一闭式解析表达式。不需要进行数值计算或四舍五入，也不需要报告单位。", "solution": "该问题陈述提出了一个理论生态学中的经典表述，具有科学依据、提法恰当且客观。它包含了进行严谨数学推导以及随后基于已确立的生态学原理进行解释所需的所有必要信息和定义。因此，该问题被认为是有效的，并将提供完整的解答。\n\n目标是推导重叠积分 $O(z_{1}, z_{2})$ 的闭式表达式，其定义为：\n$$\nO(z_{1}, z_{2}) = \\int_{-\\infty}^{\\infty} u(z_{1},R)\\,u(z_{2},R)\\,dR\n$$\n其中，具有生态位位置 $z$ 的物种的资源利用函数 $u(z,R)$ 由高斯概率密度函数给出：\n$$\nu(z,R) = \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z)^{2}}{2\\,\\omega^{2}}\\right)\n$$\n我们首先将两种生态位位置分别为 $z_1$ 和 $z_2$ 的物种的资源利用函数 $u(z,R)$ 的表达式代入重叠积分的定义中：\n$$\nO(z_1, z_2) = \\int_{-\\infty}^{\\infty} \\left[ \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z_1)^{2}}{2\\omega^{2}}\\right) \\right] \\left[ \\frac{1}{\\sqrt{2\\pi}\\,\\omega}\\,\\exp\\left(-\\frac{(R - z_2)^{2}}{2\\omega^{2}}\\right) \\right] dR\n$$\n我们合并常数前置因子，并利用指数性质 $\\exp(A)\\exp(B) = \\exp(A+B)$ 来合并指数项：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{(R - z_1)^2}{2\\omega^2} - \\frac{(R - z_2)^2}{2\\omega^2} \\right) dR\n$$\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{(R-z_1)^2 + (R-z_2)^2}{2\\omega^2} \\right) dR\n$$\n为了继续进行，我们必须将指数的自变量整理成与所提供的标准高斯积分相匹配的形式。我们通过对包含积分变量 $R$ 的项进行配方来完成此操作。让我们展开指数自变量分子中的二次项：\n$$\n(R-z_1)^2 + (R-z_2)^2 = (R^2 - 2Rz_1 + z_1^2) + (R^2 - 2Rz_2 + z_2^2) = 2R^2 - 2R(z_1+z_2) + (z_1^2 + z_2^2)\n$$\n现在我们对含 $R$ 的项进行配方：\n$$\n2R^2 - 2R(z_1+z_2) + (z_1^2 + z_2^2) = 2\\left[ R^2 - R(z_1+z_2) + \\frac{z_1^2+z_2^2}{2} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\left(\\frac{z_1+z_2}{2}\\right)^2 + \\frac{z_1^2+z_2^2}{2} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{z_1^2+2z_1z_2+z_2^2}{4} + \\frac{2z_1^2+2z_2^2}{4} \\right]\n$$\n$$\n= 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{z_1^2-2z_1z_2+z_2^2}{4} \\right] = 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{(z_1-z_2)^2}{4} \\right]\n$$\n将此结果代回指数函数的自变量中：\n$$\n-\\frac{1}{2\\omega^2} \\left( 2\\left[ \\left(R - \\frac{z_1+z_2}{2}\\right)^2 + \\frac{(z_1-z_2)^2}{4} \\right] \\right) = -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{(z_1-z_2)^2}{4\\omega^2}\n$$\n现在 $O(z_1, z_2)$ 的积分变为：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 - \\frac{(z_1-z_2)^2}{4\\omega^2} \\right) dR\n$$\n项 $\\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right)$ 不依赖于积分变量 $R$，可以移到积分号外：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right) \\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 \\right) dR\n$$\n剩下的积分是标准高斯形式 $\\int_{-\\infty}^{\\infty} \\exp(-a(x-b)^2)dx = \\sqrt{\\pi/a}$，其中 $x=R$，$a = 1/\\omega^2$，$b = (z_1+z_2)/2$。该积分的值为：\n$$\n\\int_{-\\infty}^{\\infty} \\exp\\left( -\\frac{1}{\\omega^2}\\left(R - \\frac{z_1+z_2}{2}\\right)^2 \\right) dR = \\sqrt{\\frac{\\pi}{1/\\omega^2}} = \\sqrt{\\pi\\omega^2} = \\omega\\sqrt{\\pi}\n$$\n将此结果代回 $O(z_1, z_2)$ 的表达式中：\n$$\nO(z_1, z_2) = \\frac{1}{2\\pi\\omega^2} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right) \\left(\\omega\\sqrt{\\pi}\\right)\n$$\n最后，简化前置因子得到重叠积分的闭式表达式：\n$$\nO(z_1, z_2) = \\frac{1}{2\\omega\\sqrt{\\pi}} \\exp\\left(-\\frac{(z_1-z_2)^2}{4\\omega^2}\\right)\n$$\n该表达式依赖于生态位位置的差的平方 $(z_1-z_2)^2$，因此是性状分离度 $|z_1 - z_2|$ 和生态位宽度 $\\omega$ 的函数，符合要求。\n\n现在进行解释。问题陈述指出，人均竞争影响是 $O(z_1, z_2)$ 的单调递增函数。在源于种间竞争的频率依赖性选择下，自然选择将偏好那些性状能最小化这种竞争压力的个体。为了最小化 $O(z_1, z_2)$，指数函数的自变量是负数，必须使其绝对值尽可能大。这需要最大化项 $\\frac{(z_1-z_2)^2}{4\\omega^2}$。对于固定的生态位宽度 $\\omega$，这可以通过最大化性状分离度 $|z_1-z_2|$ 来实现。种间竞争驱动竞争物种的性状变得更加不同的进化过程被称为**性状替换**。由此导致的 $|z_1-z_2|$ 的增加即为**性状趋异**。因此，重叠积分 $O$ 的进化最小化直接对应于性状替换的过程。\n\n生态位宽度 $\\omega$ 作为一个标度参数扮演着关键角色。指数的自变量 $-\\left(\\frac{|z_1-z_2|}{2\\omega}\\right)^2$ 揭示了竞争重叠不是绝对性状分离度 $|z_1-z_2|$ 的函数，而是由生态位宽度标度的分离度的函数。\n$1$. $\\omega$ 定义了性状空间中竞争相互作用的特征尺度或“空间范围”。当 $|z_1-z_2|$ 与 $\\omega$ 是同一量级时，会发生显著的竞争，从而产生显著的趋异选择压力。如果 $|z_1-z_2| \\gg 2\\omega$，重叠变得可以忽略不计，选择压力也随之消失。\n$2$. $\\omega$ 调节竞争的强度。前置因子 $1/(2\\omega\\sqrt{\\pi})$ 表明，对于完全重叠的生态位（$z_1=z_2$），生态位较窄（$\\omega$ 较小）的物种竞争更强，因为它们的资源利用更加集中。相反，指数项表明，对于固定的分离度 $|z_1-z_2|$，较大的 $\\omega$ 会导致重叠的下降更平缓。这意味着泛化种（大 $\\omega$）的竞争强度较小，但竞争的生态位分离度范围更广；而特化种（小 $\\omega$）的竞争激烈，但仅当其生态位非常相似时才如此。因此，$\\omega$ 对性状空间中竞争的强度和范围都进行标度，从根本上塑造了性状替换的动力学。", "answer": "$$\\boxed{\\frac{1}{2\\omega\\sqrt{\\pi}}\\exp\\left(-\\frac{(z_{1}-z_{2})^{2}}{4\\omega^{2}}\\right)}$$", "id": "2475761"}, {"introduction": "在同域观察到性状分歧后，一个关键的步骤是确定其原因。这种分歧可能是一种演化上的改变（遗传性状置换），也可能是一种灵活的、非遗传的响应（表型可塑性）。本题要求您解读互换移植实验的结果，这是区分遗传响应与可塑性响应的黄金标准方法 [@problem_id:1834479]。通过分析来自这个公共花园研究的假设数据，您将提升自己设计实验和就生态模式背后的机制得出严谨结论的能力。", "problem": "两种相互竞争的多年生草本植物，*物种A*和*物种B*，分布在一个区域景观中。在某些地区，只有一个物种存在（异域分布），而在其他地区，它们共存（同域分布）。野外观察显示，在异域分布的地点，两种物种的根系结构相似，平均最大根深为35厘米。然而，在同域分布的地点，*物种A*发展出显著更深的根系，而*物种B*则发展出更浅、须根更发达的根系。\n\n为了确定这种根深度的分化是由于对竞争的进化响应（遗传性状置换）还是对竞争者存在的非进化性、即时响应（表型可塑性），一位生态学家在同质园中进行了一项交互移植实验。研究人员从每个物种的异域种群和同域种群中收集种子。然后，这些种子在两种条件下生长：单一种植（单独生长）和竞争种植（与另一物种一起种植）。经过一个生长季后，测量每个处理组中植物的平均最大根深。结果总结在下表中。\n\n| 目标物种 | 来源种群 | 生长条件 | 平均根深 (厘米) |\n|---|---|---|:---:|\n| 物种A | 异域 | 单一栽培 | 35.0 |\n| 物种A | 异域 | 与B竞争 | 40.0 |\n| 物种A | 同域 | 单一栽培 | 50.0 |\n| 物种A | 同域 | 与B竞争 | 55.0 |\n| 物种B | 异域 | 单一栽培 | 35.0 |\n| 物种B | 异域 | 与A竞争 | 31.0 |\n| 物种B | 同域 | 单一栽培 | 25.0 |\n| 物种B | 同域 | 与A竞争 | 21.0 |\n\n基于对这些实验结果的全面分析，以下哪个结论得到了最有力的支持？\n\nA. 根深度的分化几乎完全是由于表型可塑性，几乎没有或完全没有遗传性状置换的证据。\nB. 根深度的分化几乎完全是由于遗传性状置换，几乎没有或完全没有表型可塑性的证据。\nC. 表型可塑性和遗传性状置换都对分化有贡献，但表型可塑性是主导机制。\nD. 表型可塑性和遗传性状置换都对分化有贡献，但遗传性状置换是主导机制。\nE. 实验不具结论性；数据没有为表型可塑性或遗传性状置换提供明确证据。", "solution": "为了使用同质园实验区分表型可塑性与遗传性状置换，应用以下原则：\n1) 在一个共同的环境中，相同生长条件下不同来源种群（异域 vs 同域）之间存在的一致性差异表明存在遗传差异（性状置换），因为环境变异得到了控制。\n2) 在相同来源种群内部，不同生长条件（单一种植 vs 竞争）之间的差异表明存在表型可塑性，因为相同的遗传背景会根据竞争者的即时存在而表达出不同的表型。\n\n对于物种A，通过比较在有B和无B生长条件下种群内部的变化来评估其可塑性：\n- 异域来源：可塑性变化为 $40.0-35.0=5.0$ 厘米。\n- 同域来源：可塑性变化为 $55.0-50.0=5.0$ 厘米。\n因此，物种A表现出明显的表型可塑性：竞争诱导了更深的根系。\n\n通过比较相同生长条件下的不同来源种群来评估遗传性状置换：\n- 单一种植：遗传差异为 $50.0-35.0=15.0$ 厘米。\n- 竞争种植：遗传差异为 $55.0-40.0=15.0$ 厘米。\n因此，物种A表现出显著的、与条件无关的遗传差异；同域基因型的根系在构造上就更深。\n\n对于物种B，通过比较在有A和无A生长条件下种群内部的变化来评估其可塑性：\n- 异域来源：可塑性变化为 $31.0-35.0=-4.0$ 厘米。\n- 同域来源：可塑性变化为 $21.0-25.0=-4.0$ 厘米。\n因此，物种B表现出表型可塑性：竞争诱导了更浅、须根更发达的根系。\n\n通过比较相同生长条件下的不同来源种群来评估遗传性状置换：\n- 单一种植：遗传差异为 $25.0-35.0=-10.0$ 厘米。\n- 竞争种植：遗传差异为 $21.0-31.0=-10.0$ 厘米。\n因此，物种B表现出显著的、与条件无关的遗传差异；同域基因型的根系在构造上就更浅。\n\n跨物种综合分析：\n- 两种物种都在单一种植和竞争种植之间表现出来源种群内部的变化，这表明存在表型可塑性。\n- 两种物种都在共同环境中表现出异域和同域来源之间巨大且一致的差异，这表明存在遗传性状置换。\n- 对于两种物种，遗传差异的幅度都超过了可塑性变化的幅度：对于物种A，遗传差异为 $15.0$ 厘米，而可塑性变化为 $5.0$ 厘米；对于物种B，遗传差异为 $10.0$ 厘米，而可塑性变化为 $4.0$ 厘米。因此，两种机制都有贡献，但遗传性状置换是主导机制。\n\n因此，得到最有力支持的结论是，表型可塑性和遗传性状置换都有贡献，但遗传性状置换是主导机制。", "answer": "$$\\boxed{D}$$", "id": "1834479"}, {"introduction": "发现在同域中的性状分歧比异域中更大是支持性状置换假说的证据，但这种模式也可能由偶然因素产生。为了提出有力的科学论断，我们必须用一个合理构建的零假设来检验观察到的模式。这项计算练习向您介绍零模型和置换检验的强大功能，它们是现代生态学中不可或缺的工具 [@problem_id:2475692]。通过实施一个随机化样点标签（同域 vs. 异域）的检验，您将学会如何严格评估一个观察到的生态模式是否具有统计显著性，或者仅仅是随机过程的产物。", "problem": "考虑一对在生态上相互作用的物种，它们在多个地点测量了单一的连续形态性状。每个地点要么是同域（两种物种共同出现），要么是异域（每种物种在没有另一种物种的情况下出现，但有可比较的性状测量数据）。性状替换假说认为，由于种间竞争，同域中的性状分化程度大于异域。请构建一个零模型和一个置换检验，以评估在保留每个地点内的经验性状分布的同时，观测到的同域性状分化是否超过异域。\n\n使用以下内容作为基本依据：\n- 零假设陈述，同域与异域的标签在不同地点间是可交换的，这意味着共存条件与性状分化之间没有系统性关联。在此零假设下，地点层面的经验性状分布得以保留，只有标签被置换。\n- 某个地点上一个物种的样本均值为 $\\bar{x} = \\frac{1}{n}\\sum_{j=1}^{n} x_j$。\n- 某个地点上一个物种的无偏样本方差为 $s^2 = \\frac{1}{n-1}\\sum_{j=1}^{n} (x_j - \\bar{x})^2$（当 $n \\ge 2$ 时），如果 $n  2$，则定义 $s^2 = 0$。\n- 对于地点 $i$，其物种特定样本量为 $n_{iA}$ 和 $n_{iB}$，无偏方差为 $s^2_{iA}$ 和 $s^2_{iB}$，其点内合并标准差为\n$$\ns_{p,i} = \n\\begin{cases}\n\\sqrt{\\dfrac{(n_{iA}-1)s^2_{iA} + (n_{iB}-1)s^2_{iB}}{n_{iA}+n_{iB}-2}},  \\text{若 } n_{iA}+n_{iB}-2  0,\\\\\n0,  \\text{其他情况。}\n\\end{cases}\n$$\n- 点级标准化分化为\n$$\nd_i = \n\\begin{cases}\n\\dfrac{\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|}{s_{p,i}},  \\text{若 } s_{p,i}  0,\\\\\n\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|,  \\text{若 } s_{p,i} = 0.\n\\end{cases}\n$$\n\n将检验统计量定义为同域地点与异域地点之间平均标准化分化的差异，\n$$\nT_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}},\n$$\n其中 $\\overline{d}_{\\text{sym}}$ 是标记为同域的地点上 $d_i$ 的均值，$\\overline{d}_{\\text{allo}}$ 是标记为异域的地点上 $d_i$ 的均值。\n\n零模型和置换检验的规范：\n- 保留每个地点两个物种的经验性状值（从而保留其均值和方差）。\n- 仅随机化同域与异域标签在各个点之间的分配，同时保留观测到的同域和异域地点的数量。\n- 通过枚举所有与观测到的同域和异域标签数量相同的不同重新标记方式，计算检验统计量的精确零分布。\n- 计算用于检验同域中分化富集的单尾p值，公式如下：\n$$\np = \\frac{1}{N}\\sum_{b=1}^{N} \\mathbf{1}\\!\\left(T^{(b)} \\ge T_{\\text{obs}}\\right),\n$$\n其中 $N$ 是标签置换的总数，$T^{(b)}$ 是置换 $b$ 下的检验统计量，$\\mathbf{1}(\\cdot)$ 是指示函数。相等的情况被计为支持备择假设，这使得检验更为保守。\n\n实现一个程序，对以下测试套件执行此精确置换检验。对于下面的每个数据集，程序必须：\n- 计算每个地点的 $d_i$。\n- 计算 $T_{\\text{obs}}$。\n- 枚举所有保留观测到的同域和异域地点数量的标签置换。\n- 按上述方式计算单尾精确 $p$-值。\n- 报告四舍五入到六位小数的 $p$-值。\n\n测试套件（每个地点列出物种A和物种B的性状值）：\n\n数据集1（有明显的同域分化信号；6个地点，3个同域，3个异域）：\n- 同域地点：\n  - 地点S1：物种A $\\{9.8, 10.1, 10.2, 9.9\\}$，物种B $\\{6.1, 6.3, 5.9, 6.0\\}$。\n  - 地点S2：物种A $\\{9.2, 9.0, 9.1, 9.3\\}$，物种B $\\{5.0, 5.3, 4.9, 5.1\\}$。\n  - 地点S3：物种A $\\{8.4, 8.6, 8.7, 8.5\\}$，物种B $\\{4.6, 4.4, 4.5, 4.7\\}$。\n- 异域地点：\n  - 地点A1：物种A $\\{7.0, 7.1, 7.2, 6.9\\}$，物种B $\\{6.7, 6.6, 6.5, 6.8\\}$。\n  - 地点A2：物种A $\\{7.3, 7.2, 7.1, 7.4\\}$，物种B $\\{6.9, 7.0, 6.8, 6.7\\}$。\n  - 地点A3：物种A $\\{6.8, 7.0, 6.9, 6.7\\}$，物种B $\\{6.5, 6.6, 6.4, 6.7\\}$。\n\n数据集2（边界情况；4个地点，2个同域，2个异域）：\n- 同域地点：\n  - 地点S1：物种A $\\{7.0, 7.1, 6.9, 7.0\\}$，物种B $\\{6.6, 6.7, 6.5, 6.6\\}$。\n  - 地点S2：物种A $\\{8.0, 8.1, 7.9, 8.05\\}$，物种B $\\{7.6, 7.7, 7.5, 7.6\\}$。\n- 异域地点：\n  - 地点A1：物种A $\\{9.0, 9.1, 8.9, 9.05\\}$，物种B $\\{8.6, 8.7, 8.5, 8.6\\}$。\n  - 地点A2：物种A $\\{6.0, 6.1, 5.9, 6.05\\}$，物种B $\\{5.6, 5.7, 5.5, 5.6\\}$。\n\n数据集3（小样本边缘情况；3个地点，1个同域，2个异域）：\n- 同域地点：\n  - 地点S1：物种A $\\{5.0, 5.1\\}$，物种B $\\{5.0, 5.1\\}$。\n- 异域地点：\n  - 地点A1：物种A $\\{5.0, 5.05\\}$，物种B $\\{5.5, 5.45\\}$。\n  - 地点A2：物种A $\\{7.0\\}$，物种B $\\{7.0\\}$。\n\n程序要求：\n- 为每个数据集实现上述的精确置换检验。\n- 你的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$\\texttt{[result1,result2,result3]}$），其中每个结果是对应数据集的单尾精确 $p$-值，四舍五入到六位小数。\n- 运行时不提供输入；将测试套件嵌入程序中。输出中不需要物理单位，因为结果是无量纲的概率。", "solution": "问题陈述提出了一个定义明确且具有科学依据的进化生态学问题，我们现在将对此进行阐述。任务是实现一个精确置换检验，以评估性状替换假说。该假说预测，与异域相比，同域中的种间竞争会导致更显著的形态性状分化。我们将对问题进行验证，然后构建一个严谨的解决方案。\n\n**问题验证**\n\n首先，我们提取指定的所有已知条件。\n\n**提取的已知条件：**\n*   **零假设 ($H_0$)：** “同域”和“异域”的标签在不同地点间是可交换的。这意味着共存对性状分化没有系统性影响。\n*   **样本均值：** $\\bar{x} = \\frac{1}{n}\\sum_{j=1}^{n} x_j$。\n*   **无偏样本方差：** $s^2 = \\frac{1}{n-1}\\sum_{j=1}^{n} (x_j - \\bar{x})^2$（当 $n \\ge 2$ 时），并定义当 $n  2$ 时 $s^2 = 0$。\n*   **点内合并标准差 ($s_{p,i}$):** 对于一个地点 $i$，其样本量为 $n_{iA}$ 和 $n_{iB}$，方差为 $s^2_{iA}$ 和 $s^2_{iB}$：\n    $$\n    s_{p,i} = \n    \\begin{cases}\n    \\sqrt{\\dfrac{(n_{iA}-1)s^2_{iA} + (n_{iB}-1)s^2_{iB}}{n_{iA}+n_{iB}-2}},  \\text{若 } n_{iA}+n_{iB}-2  0,\\\\\n    0,  \\text{其他情况。}\n    \\end{cases}\n    $$\n*   **点级标准化分化 ($d_i$):**\n    $$\n    d_i = \n    \\begin{cases}\n    \\dfrac{\\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|}{s_{p,i}},  \\text{若 } s_{p,i}  0,\\\\\n    \\left|\\bar{x}_{iA}-\\bar{x}_{iB}\\right|,  \\text{若 } s_{p,i} = 0.\n    \\end{cases}\n    $$\n*   **检验统计量 ($T$):** 同域地点与异域地点之间平均标准化分化的差异：\n    $$\n    T_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}}\n    $$\n*   **置换检验程序：** 基于枚举所有不同的地点重新标记方式的精确检验，同时保留同域和异域地点的数量。\n*   **单尾P值：** 置换检验统计量大于或等于观测值的比例：\n    $$\n    p = \\frac{1}{N}\\sum_{b=1}^{N} \\mathbf{1}\\!\\left(T^{(b)} \\ge T_{\\text{obs}}\\right)\n    $$\n*   **数据：** 提供了三个不同的数据集用于测试。\n\n**验证结论：**\n该问题是**有效的**。它在科学上基于成熟的生态学理论，数学上表述清晰，并且解决问题所需的所有组成部分都已明确规定，没有歧义或矛盾。它提出了一个生物统计学中的标准任务，尽管在计算上较为具体。该问题是自包含且客观的。因此，我们可以着手构建解决方案。\n\n**求解方法**\n\n实现将遵循一个源自问题陈述的精确、分步的过程。对于每个数据集，我们执行以下操作。\n\n**步骤1：计算点级分化 ($d_i$)**\n对于给定数据集中的每个地点 $i$，我们计算标准化分化指标 $d_i$。这需要在该地点的每个物种对（A和B）上进行一系列计算。\n1.  计算每个物种性状值的样本量（$n_{iA}$、$n_{iB}$）和样本均值（$\\bar{x}_{iA}$、$\\bar{x}_{iB}$）。\n2.  计算无偏样本方差（$s^2_{iA}$、$s^2_{iB}$）。如果某个物种的样本量 $n  2$，其方差定义为 $0$。否则，使用分母为 $n-1$ 的标准公式。\n3.  计算点内合并标准差 $s_{p,i}$。该指标通过物种内的共同变异来标准化均值差异。必须严格遵循所提供的公式，包括当总自由度 $n_{iA}+n_{iB}-2 \\le 0$ 时，$s_{p,i}$ 定义为 $0$ 的条件。\n4.  计算标准化分化 $d_i$。这是物种均值之间的绝对差，通过 $s_{p,i}$ 进行归一化。问题规定，如果 $s_{p,i} = 0$，则必须使用非标准化的均值绝对差。这将创建一个固定的分化值向量 $\\{d_1, d_2, \\dots, d_{N_{\\text{total}}}\\}$，其中 $N_{\\text{total}}$ 是地点总数。\n\n**步骤2：计算观测到的检验统计量 ($T_{\\text{obs}}$)**\n该假说的核心在于比较同域和异域环境下的分化。\n1.  使用数据集中提供的原始标签，我们将计算出的 $d_i$ 值分为两组：同域地点的 $\\{d_i\\}_{\\text{sym}}$ 和异域地点的 $\\{d_i\\}_{\\text{allo}}$。\n2.  我们计算每组的均值，$\\overline{d}_{\\text{sym}}$ 和 $\\overline{d}_{\\text{allo}}$。\n3.  观测到的检验统计量是这些均值之间的差：$T_{\\text{obs}} = \\overline{d}_{\\text{sym}} - \\overline{d}_{\\text{allo}}$。一个大的正值 $T_{\\text{obs}}$ 支持性状替换的假说。\n\n**步骤3：枚举零分布**\n零假设陈述地点标签是无意义的。为了生成在此零假设下的检验统计量分布，我们执行一个置换程序。\n1.  我们固定 $d_i$ 值的向量以及同域（$N_{\\text{sym}}$）和异域（$N_{\\text{allo}}$）地点的数量。\n2.  我们枚举将 $N_{\\text{sym}}$ 个“同域”标签分配给 $N_{\\text{total}}$ 个地点的所有可能方式。这种不同置换的数量由二项式系数 $N = \\binom{N_{\\text{total}}}{N_{\\text{sym}}}$ 给出。\n3.  对于每个置换 $b$（从 $1$ 到 $N$），我们将固定的 $d_i$ 值重新划分为一个“同域”组和一个“异域”组。然后我们为这个重新标记计算检验统计量 $T^{(b)}$。\n4.  所有 $N$ 个 $T^{(b)}$ 值的集合构成了检验统计量的精确零分布。\n\n**步骤4：计算P值**\n最后一步是确定我们观测结果的统计显著性。\n1.  我们将观测到的统计量 $T_{\\text{obs}}$ 与零分布进行比较。\n2.  单尾p值是置换统计量 $T^{(b)}$ 大于或等于 $T_{\\text{obs}}$ 的比例。这对应于在零假设为真的情况下，获得一个至少与观测结果一样极端的结果的概率。包含相等情况（$T^{(b)} = T_{\\text{obs}}$）确保了检验的保守性。\n$$\np = \\frac{\\text{满足 } T^{(b)} \\ge T_{\\text{obs}} \\text{ 的置换数}}{\\text{总置换数}}\n$$\n此过程独立应用于提供的三个数据集。最终输出是得到的p值列表，按要求进行四舍五入。", "answer": "```python\nimport numpy as np\nfrom itertools import combinations\n\ndef solve():\n    \"\"\"\n    Main function to run the exact permutation test for character displacement\n    on the provided test suite.\n    \"\"\"\n    \n    # Define the test suite. Each item is a dataset structured as:\n    # ( [list of sympatric sites], [list of allopatric sites] )\n    # Each site is a tuple: ( [species A traits], [species B traits] )\n    test_cases = [\n        # Dataset 1\n        (\n            [\n                (np.array([9.8, 10.1, 10.2, 9.9]), np.array([6.1, 6.3, 5.9, 6.0])), # S1\n                (np.array([9.2, 9.0, 9.1, 9.3]), np.array([5.0, 5.3, 4.9, 5.1])), # S2\n                (np.array([8.4, 8.6, 8.7, 8.5]), np.array([4.6, 4.4, 4.5, 4.7])), # S3\n            ],\n            [\n                (np.array([7.0, 7.1, 7.2, 6.9]), np.array([6.7, 6.6, 6.5, 6.8])), # A1\n                (np.array([7.3, 7.2, 7.1, 7.4]), np.array([6.9, 7.0, 6.8, 6.7])), # A2\n                (np.array([6.8, 7.0, 6.9, 6.7]), np.array([6.5, 6.6, 6.4, 6.7])), # A3\n            ],\n        ),\n        # Dataset 2\n        (\n            [\n                (np.array([7.0, 7.1, 6.9, 7.0]), np.array([6.6, 6.7, 6.5, 6.6])), # S1\n                (np.array([8.0, 8.1, 7.9, 8.05]), np.array([7.6, 7.7, 7.5, 7.6])), # S2\n            ],\n            [\n                (np.array([9.0, 9.1, 8.9, 9.05]), np.array([8.6, 8.7, 8.5, 8.6])), # A1\n                (np.array([6.0, 6.1, 5.9, 6.05]), np.array([5.6, 5.7, 5.5, 5.6])), # A2\n            ]\n        ),\n        # Dataset 3\n        (\n            [\n                (np.array([5.0, 5.1]), np.array([5.0, 5.1])), # S1\n            ],\n            [\n                (np.array([5.0, 5.05]), np.array([5.5, 5.45])), # A1\n                (np.array([7.0]), np.array([7.0])), # A2\n            ]\n        )\n    ]\n\n    def calculate_site_divergence(traits_A, traits_B):\n        \"\"\"\n        Calculates the standardized divergence d_i for a single site.\n        \"\"\"\n        n_A = len(traits_A)\n        n_B = len(traits_B)\n\n        mean_A = np.mean(traits_A)\n        mean_B = np.mean(traits_B)\n\n        # Unbiased sample variance with edge case for n  2\n        var_A = np.var(traits_A, ddof=1) if n_A >= 2 else 0\n        var_B = np.var(traits_B, ddof=1) if n_B >= 2 else 0\n\n        # Pooled standard deviation with edge case for degrees of freedom = 0\n        df = n_A + n_B - 2\n        if df > 0:\n            pooled_var = ((n_A - 1) * var_A + (n_B - 1) * var_B) / df\n            s_p = np.sqrt(pooled_var)\n        else:\n            s_p = 0\n            \n        # Standardized divergence with edge case for s_p = 0\n        mean_diff = np.abs(mean_A - mean_B)\n        if s_p > 0:\n            d_i = mean_diff / s_p\n        else:\n            d_i = mean_diff\n            \n        return d_i\n\n    p_values = []\n    \n    for sympatric_sites, allopatric_sites in test_cases:\n        all_sites = sympatric_sites + allopatric_sites\n        n_sym = len(sympatric_sites)\n        n_allo = len(allopatric_sites)\n        n_total = n_sym + n_allo\n\n        # Step 1: Calculate d_i for all sites\n        d_values = np.array([calculate_site_divergence(site[0], site[1]) for site in all_sites])\n        \n        # Step 2: Calculate observed test statistic T_obs\n        d_sym_obs = d_values[:n_sym]\n        d_allo_obs = d_values[n_sym:]\n        \n        mean_d_sym_obs = np.mean(d_sym_obs) if n_sym > 0 else 0\n        mean_d_allo_obs = np.mean(d_allo_obs) if n_allo > 0 else 0\n        \n        t_obs = mean_d_sym_obs - mean_d_allo_obs\n\n        # Step 3: Enumerate permutations and build null distribution\n        ge_obs_count = 0\n        total_perms = 0\n        \n        # `itertools.combinations` provides the indices for the 'sympatric' group in each permutation\n        site_indices = range(n_total)\n        for permuted_sym_indices in combinations(site_indices, n_sym):\n            total_perms += 1\n\n            permuted_sym_indices = set(permuted_sym_indices)\n            permuted_allo_indices = set(site_indices) - permuted_sym_indices\n            \n            d_sym_perm = d_values[list(permuted_sym_indices)] if n_sym > 0 else np.array([])\n            d_allo_perm = d_values[list(permuted_allo_indices)] if n_allo > 0 else np.array([])\n\n            mean_d_sym_perm = np.mean(d_sym_perm) if n_sym > 0 else 0\n            mean_d_allo_perm = np.mean(d_allo_perm) if n_allo > 0 else 0\n\n            t_perm = mean_d_sym_perm - mean_d_allo_perm\n            \n            # Use a small tolerance for float comparison, though >= is robust for most cases.\n            if t_perm >= t_obs:\n                ge_obs_count += 1\n        \n        # Step 4: Calculate p-value\n        p_value = ge_obs_count / total_perms if total_perms > 0 else 1.0 # Handle case with 0 permutations\n        \n        p_values.append(p_value)\n\n    # Format the results as specified\n    formatted_results = [f\"{p:.6f}\" for p in p_values]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2475692"}]}