{"hands_on_practices": [{"introduction": "本练习旨在探讨种群规模的波动如何随时间影响遗传多样性。通过从第一性原理推导并计算谐波平均有效种群大小（$N_e$），您将对种群瓶颈为何对遗传变异的丧失产生不成比例的巨大影响，获得更深刻的定量理解。这个练习将巩固您对保护遗传学中一个基本概念的掌握 ([@problem_id:2472477])。", "problem": "一个随机交配的二倍体种群遵循Wright-Fisher模型，具有离散、不重叠的世代，没有突变，也没有迁移。设第 $t$ 代的普查规模为 $N_t$。在 $T$ 代的有限时间窗口内，将有效种群大小（$N_e$）定义为能产生与观察到的时变普查规模相同的中性杂合度预期累积下降的恒定种群大小。\n\n你观测到一个时间序列 $N_1 = 50$，$N_2 = 200$ 和 $N_3 = 100$（因此 $T=3$）。仅从Wright-Fisher繁殖模型下，单世代内预期中性杂合度与普查规模之间的基本关系出发，推导出一个用 $\\{N_t\\}_{t=1}^T$ 表示的 $T$ 代内的 $N_e$ 表达式，并用它计算给定序列的调和平均有效大小。以精确有理数的形式报告最终的数值答案（单位为个体）；不要四舍五入。\n\n在你的推理中，解释为什么 $\\{N_t\\}$ 的时间变化会相对于 $\\{N_t\\}$ 的算术平均值降低 $N_e$，从而随时间推移降低中性遗传多样性。", "solution": "该问题陈述具有科学依据，表述清晰，并包含足够的信息以得出唯一解。这是基于Wright-Fisher模型的一个群体遗传学标准练习。因此，该问题被认为是有效的，并将提供解答。\n\n推导始于描述在Wright-Fisher模型下，由于遗传漂变导致的单世代内预期杂合度衰减的基本关系。对于一个在第 $t$ 代普查规模为 $N_t$ 的随机交配二倍体种群，下一代（$H_{t+1}$）的预期杂合度与第 $t$ 代（$H_t$）的杂合度关系如下：\n$$E[H_{t+1}] = \\left(1 - \\frac{1}{2N_t}\\right) H_t$$\n这种关系源于这样一个事实：从第 $t$ 代的基因库中有放回地抽取两个等位基因以形成第 $t+1$ 代的个体时，这两个等位基因同源相同的概率为 $\\frac{1}{2N_t}$。因此，项 $\\left(1 - \\frac{1}{2N_t}\\right)$ 是它们不同源相同的概率，也即杂合度预期下降的因子。\n\n为了确定在时变普查规模 $\\{N_t\\}_{t=1}^T$ 下 $T$ 个世代的累积效应，我们迭代地应用这个递推关系。设 $H_1$ 为过程开始时（即第1代）的杂合度。经过 $T$ 个世代后，在第 $T+1$ 代开始时的预期杂合度为：\n$$E[H_{T+1}] = H_1 \\prod_{t=1}^{T} \\left(1 - \\frac{1}{2N_t}\\right)$$\n问题将有效种群大小 $N_e$ 定义为一个理想化的恒定种群的大小，该种群在相同的 $T$ 个世代内会经历相同的杂合度累积下降。对于一个大小为 $N_e$ 的恒定种群，经过 $T$ 个世代后的预期杂合度为：\n$$E[H_{T+1}] = H_1 \\left(1 - \\frac{1}{2N_e}\\right)^T$$\n根据定义，这两个累积下降因子必须相等：\n$$\\left(1 - \\frac{1}{2N_e}\\right)^T = \\prod_{t=1}^{T} \\left(1 - \\frac{1}{2N_t}\\right)$$\n对于远大于1的普查规模 $N_t$（这是此类模型中的一个标准假设），当 $x$ 很小时，我们可以使用近似 $1-x \\approx \\exp(-x)$。在我们的情况中，$x = \\frac{1}{2N_t}$ 非常小。将此近似应用于方程两边，得到：\n$$\\left(\\exp\\left(-\\frac{1}{2N_e}\\right)\\right)^T \\approx \\prod_{t=1}^{T} \\exp\\left(-\\frac{1}{2N_t}\\right)$$\n使用指数的性质 $\\exp(a)\\exp(b) = \\exp(a+b)$，右边可以简化为：\n$$\\exp\\left(-\\frac{T}{2N_e}\\right) \\approx \\exp\\left(-\\sum_{t=1}^{T} \\frac{1}{2N_t}\\right)$$\n为了使两边相等，它们的指数必须相等：\n$$\\frac{T}{2N_e} = \\sum_{t=1}^{T} \\frac{1}{2N_t}$$\n两边乘以 $2$ 并重新整理以求解 $N_e$，得到有效种群大小的表达式：\n$$\\frac{T}{N_e} = \\sum_{t=1}^{T} \\frac{1}{N_t}$$\n$$N_e = \\frac{T}{\\sum_{t=1}^{T} \\frac{1}{N_t}}$$\n这个表达式表明，在普查规模波动的时期内，有效种群大小是这些普查规模的调和平均数。\n\n现在，我们为给定的时间序列计算 $N_e$ 的值：$T=3$，$N_1 = 50$，$N_2 = 200$ 和 $N_3 = 100$。\n将这些值代入推导出的公式中：\n$$N_e = \\frac{3}{\\frac{1}{50} + \\frac{1}{200} + \\frac{1}{100}}$$\n为了计算分母，我们找到一个公分母，即 $200$：\n$$\\sum_{t=1}^{3} \\frac{1}{N_t} = \\frac{4}{200} + \\frac{1}{200} + \\frac{2}{200} = \\frac{4+1+2}{200} = \\frac{7}{200}$$\n将此结果代回 $N_e$ 的表达式中：\n$$N_e = \\frac{3}{\\frac{7}{200}} = 3 \\times \\frac{200}{7} = \\frac{600}{7}$$\n\n最后，我们必须解释为什么 $\\{N_t\\}$ 的时间变化会相对于 $\\{N_t\\}$ 的算术平均值降低 $N_e$。算术平均值由 $\\bar{N}_{\\text{arith}} = \\frac{1}{T}\\sum_{t=1}^T N_t$ 给出。有效大小 $N_e$ 是调和平均数。根据算术平均-调和平均（AM-HM）不等式，对于任何一组正数 $\\{N_t\\}$，算术平均值总是大于或等于调和平均值：\n$$\\frac{1}{T}\\sum_{t=1}^T N_t \\ge \\frac{T}{\\sum_{t=1}^T \\frac{1}{N_t}}$$\n仅当所有 $N_t$ 都相等时，等号才成立。因此，$\\bar{N}_{\\text{arith}} \\ge N_e$，并且种群大小的任何时间变化都会导致有效大小严格小于算术平均值。\n\n其生物学原因是，在任何给定世代中，杂合度丢失的速率与种群大小成反比（$\\frac{1}{2N_t}$）。种群规模小的世代（称为瓶颈）对遗传多样性的累积损失贡献尤为巨大。短暂的小 $N_t$ 时期会导致 $\\frac{1}{2N_t}$ 的值很大，从而导致杂合度的严重下降。随后的种群规模大的世代无法逆转这种损失；它们只能减缓未来损失的速率。因此，长期的漂变速率受最极端瓶颈的支配。调和平均数是一个数学构造，它被序列中的最小值严重加权，因此它正确地捕捉了这一生物学现象。对于给定的序列，算术平均值为 $\\frac{50+200+100}{3} = \\frac{350}{3} \\approx 116.7$，而有效大小为 $N_e = \\frac{600}{7} \\approx 85.7$。第一代 $50$ 的低普查规模产生了不成比例的影响，将有效大小拉低到远低于算术平均值的水平，并导致种群以比平均大小所预示的快得多的速率丢失遗传多样性。", "answer": "$$\\boxed{\\frac{600}{7}}$$", "id": "2472477"}, {"introduction": "在理解了种群内部遗传变异的基础上，本练习将探讨数据分析中的一个常见挑战：潜在的种群结构。您将研究瓦伦德效应（Wahlund effect），即合并来自不同亚群的样本会在遗传数据中产生一种虚假的近交信号。此练习 ([@problem_id:2472498]) 强调了恰当的取样设计和分层分析（例如$F$-统计量）对于准确解释遗传多样性模式的至关重要性。", "problem": "一种沿海植物物种占据了由微生境组成的镶嵌体，其地方亚群（deme）之间的扩散有限，但田野证据表明，在繁殖季节，每个亚群内部的交配是随机的。一个研究团队对来自两个亚群的、具有等位基因 $A$ 和 $a$ 的双等位基因标记进行了基因分型，每个亚群的样本量为 $n=100$，并获得了以下基因型计数：\n\n- 亚群 $D_1$：$AA=4$, $Aa=32$, $aa=64$。\n- 亚群 $D_2$：$AA=64$, $Aa=32$, $aa=4$。\n\n后来，另一位分析师无意中合并了这 $n=200$ 个个体，并将合并后的基因型当作是从一个随机交配（panmictic）群体中抽取的样本进行评估。\n\n仅使用哈迪-温伯格平衡的基本定义（亚群内的随机交配意味着基因型频率由该亚群的等位基因频率决定）和 Wright 的固定指数（基于杂合度的近交和结构系数，由在适当的种群聚合水平上观察到的杂合度与期望杂合度定义），从第一性原理出发，诊断为什么合并样本会产生近交的表观信号，并设计一个能够区分瓦伦德效应和真实近交的抽样和分析方案。然后，根据数据和这些原理，选择所有正确的陈述。\n\nA. 仅从合并样本来看，估计的亚群内近交系数 $F_{IS}$ 约为 $0.36$，这表明亚群内存在强烈的近交；不需要进一步的分层。\n\nB. 合并两个亚群会产生杂合子缺失，即使亚群内部交配是随机的，因为亚群间的等位基因频率不同（瓦伦德效应）。采用按亚群标记个体的分层抽样设计，并通过分层分析估计亚群内的 $F_{IS}$ 和亚群间的 $F_{ST}$，将能正确地归因这种缺失；如果 $F_{IS}\\approx 0$ 但 $F_{ST}>0$，则该缺失是由于种群结构而非近交造成的。\n\nC. 对于一个双等位基因座，根据合并的等位基因频率计算的总期望杂合度与各亚群平均期望杂合度之间的差值等于亚群间等位基因频率方差的两倍，即 $2\\,\\mathrm{Var}(p)$；认识到合并样本的杂合子缺失等于这个差值，表明无需用亚群内的真实近交来解释这些数据。\n\nD. 在一个允许位点特异性无效等位基因的模型下分析合并的基因型是足够的；如果在该模型下杂合子缺失消失，则其原因就是瓦伦德效应而非近交。\n\n选择所有适用的选项。", "solution": "我们从核心定义开始。在一个符合哈迪-温伯格平衡的亚群中，若等位基因 $A$ 的频率为 $p$，则期望的基因型频率为：$AA$ 为 $p^2$，$Aa$ 为 $2p(1-p)$，$aa$ 为 $(1-p)^2$。期望杂合度为 $H=2p(1-p)$。Wright 的固定指数（通常表示为 F-统计量）量化了不同层级上的杂合子缺失：亚群内的 $F_{IS}=1-\\dfrac{H_O}{H_E}$（亚群水平的观察杂合度 $H_O$ 对比亚群水平的哈迪-温伯格期望杂合度 $H_E$），亚群间的 $F_{ST}=\\dfrac{H_T-H_S}{H_T}$（基于合并等位基因频率的总期望杂合度 $H_T$ 对比亚群内平均期望杂合度 $H_S$），以及总样本的 $F_{IT}=1-\\dfrac{H_O^{\\mathrm{pooled}}}{H_T}$。这些指数满足恒等式 $1-F_{IT}=(1-F_{IS})(1-F_{ST})$。\n\n步骤 1：计算亚群内的等位基因频率和杂合度。对于亚群 $D_1$（$n=100$），等位基因 $A$ 的计数为 $2\\times 4 + 32 = 40$，所以 $p_1=\\dfrac{40}{2\\times 100}=0.20$。观察杂合度为 $H_{O,1}=\\dfrac{32}{100}=0.32$。在 $p_1=0.20$ 时，哈迪-温伯格期望杂合度为 $H_{E,1}=2\\times 0.20\\times 0.80=0.32$。因此 $F_{IS,1}=1-\\dfrac{0.32}{0.32}=0$。\n\n对于亚群 $D_2$（$n=100$），等位基因 $A$ 的计数为 $2\\times 64 + 32 = 160$，所以 $p_2=\\dfrac{160}{200}=0.80$。观察杂合度为 $H_{O,2}=\\dfrac{32}{100}=0.32$。在 $p_2=0.80$ 时，哈迪-温伯格期望杂合度为 $H_{E,2}=2\\times 0.80\\times 0.20=0.32$。因此 $F_{IS,2}=1-\\dfrac{0.32}{0.32}=0$。\n\n对大小相等的亚群进行平均，得到亚群内平均期望杂合度 $H_S=\\dfrac{H_{E,1}+H_{E,2}}{2}=\\dfrac{0.32+0.32}{2}=0.32$ 和亚群内平均观察杂合度 $H_O^{\\mathrm{within}}=\\dfrac{0.32+0.32}{2}=0.32$；亚群内近交系数为 $F_{IS}=0$（亚群内没有杂合子缺失）。\n\n步骤 2：计算合并后的量。合并样本有 $n=200$ 个个体，基因型计数为 $AA=4+64=68$, $Aa=32+32=64$, $aa=64+4=68$。合并后的观察杂合度为 $H_O^{\\mathrm{pooled}}=\\dfrac{64}{200}=0.32$。合并后等位基因 $A$ 的频率为 $\\bar p=\\dfrac{40+160}{400}=0.50$。在合并等位基因频率下，随机交配的总期望杂合度为 $H_T=2\\bar p(1-\\bar p)=2\\times 0.50\\times 0.50=0.50$。总固定指数为 $F_{IT}=1-\\dfrac{H_O^{\\mathrm{pooled}}}{H_T}=1-\\dfrac{0.32}{0.50}=1-0.64=0.36$。\n\n根据恒等式 $1-F_{IT}=(1-F_{IS})(1-F_{ST})$ 以及 $F_{IS}=0$ 的事实，可得 $F_{IT}=F_{ST}=0.36$。因此，在合并样本中观察到的全部杂合子缺失都可归因于亚群间的结构，而非亚群内的近交。\n\n步骤 3：从机理上解释为什么合并会降低杂合度。对于一个双等位基因座，杂合度作为 $p$ 的函数是 $H(p)=2p(1-p)$，这是在 $[0,1]$ 区间上关于 $p$ 的一个凹函数。根据琴生不等式（Jensen’s inequality），对于在均值为 $\\bar p$ 的亚群间变化的 $p$，亚群内平均杂合度满足 $\\overline{H(p)} \\le H(\\bar p)$，除非所有亚群具有相同的 $p$ 值，否则为严格不等式。实际上，可以推导出\n$$\nH_T - H_S \\;=\\; 2\\,\\bar p(1-\\bar p) - \\overline{2p(1-p)} \\;=\\; 2\\left(\\overline{p^2} - \\bar p^2\\right) \\;=\\; 2\\,\\mathrm{Var}(p),\n$$\n当亚群间等位基因频率不同时，该值严格为正。当 $p_1=0.20$ 和 $p_2=0.80$ 时，我们有 $\\bar p=0.50$，$\\overline{p^2}=\\dfrac{0.20^2+0.80^2}{2}=\\dfrac{0.04+0.64}{2}=0.34$，所以 $H_T-H_S=2\\times (0.34-0.25)=0.18$，因此 $F_{ST}=\\dfrac{H_T-H_S}{H_T}=\\dfrac{0.18}{0.50}=0.36$，与上面一致。\n\n步骤 4：设计一个抽样和分析方案来区分瓦伦德效应和真实近交。关键在于将计算期望杂合度的水平与生物学上的交配单元对齐。一个科学合理的设计是：\n\n- 按假定的亚群（微生境或局部邻域）进行分层抽样，并为每个个体记录亚群标签；对 $k\\ge 3$ 个亚群进行抽样，每个亚群的样本量 $n$ 大致相等，以避免加权偏差。\n- 在每个亚群内，检验哈迪-温伯格平衡并估计 $H_{O}$ 和 $H_{E}$，从而估计 $F_{IS}=1-\\dfrac{H_O}{H_E}$；将亚群间的平均 $H_E$ 估计为 $H_S$，并计算合并的等位基因频率 $\\bar p$ 和 $H_T=2\\bar p(1-\\bar p)$。\n- 估计 $F_{ST}=\\dfrac{H_T-H_S}{H_T}$ 和 $F_{IT}=1-\\dfrac{H_O^{\\mathrm{pooled}}}{H_T}$；验证 $1-F_{IT}=(1-F_{IS})(1-F_{ST})$。\n- 解释：如果亚群内的 $F_{IS}\\approx 0$ 但 $F_{ST}>0$，则在合并样本中观察到的杂合子缺失是瓦伦德效应。如果亚群内的 $F_{IS}>0$（并且在考虑了基因分型错误后仍然存在），则支持亚群内存在真实近交。像分子方差分析（Analysis of Molecular Variance, AMOVA）这样的方差分解框架可以在多个位点上实现这种分层分析。\n\n根据这些推导，我们现在评估每个选项：\n\n选项 A：它声称合并后的估计表明存在亚群内近交，并报告 $F_{IS}\\approx 0.36$。在数值上，$0.36$ 是总缺失 $F_{IT}$（在此情况下等同于 $F_{ST}$），而不是亚群内系数。通过直接计算，每个亚群内的 $F_{IS}=0$。其推论和参数归因都是错误的。结论 — 错误。\n\n选项 B：该选项指出，合并等位基因频率不同的亚群会通过瓦伦德效应产生杂合子缺失，并规定采用分层的、层次化的分析来估计亚群内的 $F_{IS}$ 和亚群间的 $F_{ST}$；诊断模式 $F_{IS}\\approx 0$ 且 $F_{ST}>0$ 正确地将缺失归因于种群结构。这与我们的推导和正确的抽样逻辑相符。结论 — 正确。\n\n选项 C：该选项引用了双等位基因座的恒等式 $H_T-H_S=2\\,\\mathrm{Var}(p)$，并指出合并样本的杂合子缺失等于此差值，从而表明无需近交来解释数据。我们推导并数值验证了此恒等式；它正确地解释了其机理。结论 — 正确。\n\n选项 D：该选项建议对合并数据拟合一个无效等位基因模型，作为诊断瓦伦德效应的充分方法。无效等位基因也可能导致表观的杂合子缺失，但考虑无效等位基因并不能诊断或消除种群结构的影响；此外，这种方法不能区分亚群内近交和亚群间结构。对于所述目的，这不是一个有效的设计。结论 — 错误。", "answer": "$$\\boxed{BC}$$", "id": "2472498"}, {"introduction": "本练习将视角从遗传多样性提升到群落层面，介绍作为理解生态过程关键的功能多样性。您将通过实现一个基于功能离散度（Functional Dispersion, FDis）的零模型分析，来检验群落构建是受环境过滤还是限制相似性主导。这项计算实践 ([@problem_id:2472458]) 将为您提供一个强大的现代生态学方法的实践经验，以连接物种性状和生态系统水平的模式。", "problem": "给定沿环境梯度的物种-性状数据和地点-物种群落成员关系。目标是使用功能离散度的标准化效应量，实现一个原则性的零模型检验，以区分环境过滤和限制性相似。所有定义和步骤必须源于性状空间中距离的核心定义，以及在保持群落丰富度的同时破坏物种-性状关联的零假设下的随机化。\n\n用作基础的定义：\n- 每个物种的功能性状向量是维度为 $D$ 的欧几里得空间中的一个元素，对于物种索引 $i \\in \\{1,\\dots,S\\}$，记作 $\\mathbf{t}_i \\in \\mathbb{R}^D$。\n- 对于一个地点的群落，设 $\\mathbf{a} \\in \\{0,1\\}^S$ 是大小为 $S$ 的物种库中的存在-缺失向量。该群落包含索引集 $I = \\{ i \\mid a_i = 1 \\}$，其丰富度为 $m = \\sum_{i=1}^S a_i$。\n- 质心（群落加权平均性状）为 $\\mathbf{c} = \\left(\\sum_{i \\in I} w_i \\mathbf{t}_i\\right) \\Big/ \\left(\\sum_{i \\in I} w_i\\right)$，其中对于所有 $i \\in I$，存在权重 $w_i = 1$。\n- 对于 $i \\in I$，从 $\\mathbf{t}_i$ 到 $\\mathbf{c}$ 的欧几里得距离为 $d_i = \\lVert \\mathbf{t}_i - \\mathbf{c} \\rVert_2$。\n- 功能离散度 (FDis) 是到质心的加权平均距离，$\\mathrm{FDis} = \\left(\\sum_{i \\in I} w_i d_i\\right) \\Big/ \\left(\\sum_{i \\in I} w_i\\right)$。当使用存在权重时，这是 $\\{ d_i \\}_{i \\in I}$ 的简单平均值。\n- 零模型在保留每个地点的群落成员向量 $\\mathbf{a}$ 的同时，随机化了物种身份与性状向量之间的映射。具体来说，对于每个零模型重复，对性状矩阵的行应用一个均匀随机置换 $\\pi$，生成一个置换后的性状集 $\\{\\mathbf{t}_{\\pi(1)},\\dots,\\mathbf{t}_{\\pi(S)}\\}$，然后对于重复索引 $r \\in \\{1,\\dots,R\\}$，使用相同的 $\\mathbf{a}$ 计算 $\\mathrm{FDis}^{(r)}$。\n- 标准化效应量为 $\\mathrm{SES} = \\left(\\mathrm{FDis}_{\\mathrm{obs}} - \\mu_{\\mathrm{null}}\\right) \\Big/ \\sigma_{\\mathrm{null}}$，其中 $\\mu_{\\mathrm{null}}$ 是零模型重复的均值，$\\sigma_{\\mathrm{null}}$ 是其标准差。如果 $\\sigma_{\\mathrm{null}} = 0$，则按惯例定义 $\\mathrm{SES} = 0$ 以避免除以零。负的 $\\mathrm{SES}$ 表明性状聚类，与环境过滤一致；正的 $\\mathrm{SES}$ 表明性状过度分散，与限制性相似一致。\n\n算法要求：\n- 使用上述定义在 $\\mathbb{R}^D$ 中实现 $\\mathrm{FDis}$ 的计算。\n- 实现具有 $R$ 次重复和固定随机种子的性状-标签随机化零模型，以确保可复现性。\n- 计算每个地点的 $\\mathrm{SES}$，输出时四舍五入至三位小数。\n- 仅将双尾解释性阈值 $\\alpha = 0.10$ 和临界值 $z_{\\alpha/2} = 1.645$ 用于解释；不要在要求的输出中包含分类。\n\n测试套件规范：\n- 使用以下两种情况。\n\n情况 A（单变量性状，$D = 1$，$S = 8$，$5$ 个地点）：\n- 性状向量 $\\mathbf{t} \\in \\mathbb{R}^8$：\n  $\\mathbf{t} = [\\,0.05,\\,0.12,\\,0.20,\\,0.50,\\,0.60,\\,0.80,\\,0.92,\\,0.97\\,]$.\n- 地点-物种存在矩阵 $\\mathbf{A} \\in \\{0,1\\}^{5 \\times 8}$，行代表地点 $1$ 到 $5$：\n  - 地点 $1$：$[\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0,\\,0\\,]$.\n  - 地点 $2$：$[\\,0,\\,1,\\,0,\\,1,\\,1,\\,0,\\,0,\\,0\\,]$.\n  - 地点 $3$：$[\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1\\,]$.\n  - 地点 $4$：$[\\,1,\\,0,\\,0,\\,1,\\,0,\\,0,\\,0,\\,1\\,]$.\n  - 地点 $5$：$[\\,0,\\,0,\\,0,\\,1,\\,0,\\,0,\\,0,\\,0\\,]$.\n- 环境梯度值（不用于计算，仅为提供背景信息）：$\\mathbf{E} = [\\,0.10,\\,0.50,\\,0.90,\\,0.60,\\,0.50\\,]$。\n\n情况 B（双变量性状，$D = 2$，$S = 6$，$3$ 个地点）：\n- 性状矩阵 $\\mathbf{T} \\in \\mathbb{R}^{6 \\times 2}$，行代表物种 $1$ 到 $6$：\n  $\\big[\\, [\\,0.10,\\,0.10\\,],\\; [\\,0.20,\\,0.20\\,],\\; [\\,0.30,\\,0.30\\,],\\; [\\,0.70,\\,0.70\\,],\\; [\\,0.80,\\,0.80\\,],\\; [\\,0.90,\\,0.90\\,] \\,\\big]$.\n- 地点-物种存在矩阵 $\\mathbf{A} \\in \\{0,1\\}^{3 \\times 6}$，行代表地点 $1$ 到 $3$：\n  - 地点 $1$：$[\\,1,\\,1,\\,1,\\,0,\\,0,\\,0\\,]$.\n  - 地点 $2$：$[\\,1,\\,0,\\,0,\\,0,\\,0,\\,1\\,]$.\n  - 地点 $3$：$[\\,0,\\,1,\\,0,\\,1,\\,0,\\,1\\,]$.\n- 环境梯度值（不用于计算，仅为提供背景信息）：$\\mathbf{E} = [\\,0.15,\\,0.85,\\,0.50\\,]$。\n\n零模型设置与可复现性：\n- 零模型重复次数：$R = 499$。\n- 随机种子：$123$。\n\n角度单位不适用。不涉及物理单位。所有输出均为纯数。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含两个案例中所有地点的 $\\mathrm{SES}$ 值的串接列表，按情况 A 的地点 1 到 5，后接情况 B 的地点 1 到 3 的顺序排列，每个值四舍五入至三位小数，以逗号分隔并用方括号括起来。例如：$[\\mathrm{ses}_1,\\mathrm{ses}_2,\\dots,\\mathrm{ses}_8]$。", "solution": "对问题陈述进行验证。\n\n步骤1：提取给定信息。\n- **功能性状向量**：对于每个物种 $i \\in \\{1, \\dots, S\\}$，性状向量为 $\\mathbf{t}_i \\in \\mathbb{R}^D$。\n- **群落组成**：对于一个给定的地点，存在-缺失向量为 $\\mathbf{a} \\in \\{0, 1\\}^S$。存在的物种集合为 $I = \\{ i \\mid a_i = 1 \\}$。群落丰富度为 $m = \\sum_{i=1}^S a_i$。\n- **群落质心**：质心定义为 $\\mathbf{c} = \\left(\\sum_{i \\in I} w_i \\mathbf{t}_i\\right) \\Big/ \\left(\\sum_{i \\in I} w_i\\right)$，其中仅存在物种的权重 $w_i = 1$，对于所有 $i \\in I$。这简化为存在物种的性状向量的算术平均值。\n- **欧几里得距离**：物种性状向量与质心之间的距离为 $d_i = \\lVert \\mathbf{t}_i - \\mathbf{c} \\rVert_2$，对于 $i \\in I$。\n- **功能离散度 (FDis)**：$\\mathrm{FDis} = \\left(\\sum_{i \\in I} w_i d_i\\right) \\Big/ \\left(\\sum_{i \\in I} w_i\\right)$。对于 $w_i=1$，这是距离 $\\{d_i\\}_{i \\in I}$ 的算术平均值。\n- **零模型**：物种身份与性状向量之间的映射被随机化。对于每次重复 $r \\in \\{1, \\dots, R\\}$，对性状矩阵的行应用一个均匀随机置换 $\\pi$，创建一个置换后的集合 $\\{\\mathbf{t}_{\\pi(1)}, \\dots, \\mathbf{t}_{\\pi(S)}\\}$。然后使用原始的存在-缺失向量 $\\mathbf{a}$ 为每个地点计算 $\\mathrm{FDis}^{(r)}$。\n- **标准化效应量 (SES)**：$\\mathrm{SES} = (\\mathrm{FDis}_{\\mathrm{obs}} - \\mu_{\\mathrm{null}}) / \\sigma_{\\mathrm{null}}$，其中 $\\mu_{\\mathrm{null}}$ 和 $\\sigma_{\\mathrm{null}}$ 是 $R$ 次零模型重复 FDis 值的均值和标准差。如果 $\\sigma_{\\mathrm{null}} = 0$，则定义 $\\mathrm{SES}$ 为 $0$。\n- **情况 A 数据**：\n    - 维度 $D = 1$，物种数 $S = 8$，地点数 $= 5$。\n    - 性状向量 $\\mathbf{t} = [\\,0.05,\\,0.12,\\,0.20,\\,0.50,\\,0.60,\\,0.80,\\,0.92,\\,0.97\\,]$。\n    - 存在矩阵 $\\mathbf{A} \\in \\{0,1\\}^{5 \\times 8}$：\n        - 地点 $1$：$[\\,1,\\,1,\\,1,\\,0,\\,0,\\,0,\\,0,\\,0\\,]$。\n        - 地点 $2$：$[\\,0,\\,1,\\,0,\\,1,\\,1,\\,0,\\,0,\\,0\\,]$。\n        - 地点 $3$：$[\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1\\,]$。\n        - 地点 $4$：$[\\,1,\\,0,\\,0,\\,1,\\,0,\\,0,\\,0,\\,1\\,]$。\n        - 地点 $5$：$[\\,0,\\,0,\\,0,\\,1,\\,0,\\,0,\\,0,\\,0\\,]$。\n- **情况 B 数据**：\n    - 维度 $D = 2$，物种数 $S = 6$，地点数 $= 3$。\n    - 性状矩阵 $\\mathbf{T} \\in \\mathbb{R}^{6 \\times 2}$：$\\big[\\, [\\,0.10,\\,0.10\\,],\\; [\\,0.20,\\,0.20\\,],\\; [\\,0.30,\\,0.30\\,],\\; [\\,0.70,\\,0.70\\,],\\; [\\,0.80,\\,0.80\\,],\\; [\\,0.90,\\,0.90\\,] \\,\\big]$。\n    - 存在矩阵 $\\mathbf{A} \\in \\{0,1\\}^{3 \\times 6}$：\n        - 地点 $1$：$[\\,1,\\,1,\\,1,\\,0,\\,0,\\,0\\,]$。\n        - 地点 $2$：$[\\,1,\\,0,\\,0,\\,0,\\,0,\\,1\\,]$。\n        - 地点 $3$：$[\\,0,\\,1,\\,0,\\,1,\\,0,\\,1\\,]$。\n- **零模型参数**：重复次数 $R = 499$。随机种子为 $123$。\n- **输出要求**：一个包含所有地点 SES 值的单一列表，四舍五入至三位小数。\n\n步骤2：使用提取的给定信息进行验证。\n对问题陈述的有效性进行审查。\n- **科学依据**：该问题使用了群落生态学和功能生物地理学中已确立的概念和度量，即功能离散度（FDis）和零模型检验。这些定义与主要文献（例如，Laliberté  Legendre，$2010$，Ecology）一致。所检验的生态学假设（环境过滤与限制性相似）是该领域的核心。该问题具有科学合理性。\n- **适定性**：该问题以数学精度进行了规定。所有必要的数据（性状和群落矩阵）、参数（$R$，随机种子）以及所有计算（质心、FDis、SES）的明确公式都已提供。指定固定的随机种子确保了唯一的、可复现的数值结果。该问题是适定的。\n- **客观性**：该问题以客观的数学语言表述。它没有主观性或歧义。背景信息（环境梯度值）被明确标记为不参与计算。\n- **其他缺陷**：该问题是自洽的、内部一致的，并且需要进行非平凡的计算，因此它不是一个同义反复。其参数和数据对于生态学研究是现实的。\n\n步骤3：结论与行动。\n问题有效。现在制定一个合理的解决方案。\n\n目标是为几个生态群落计算功能离散度（$\\mathrm{FDis}$）的标准化效应量（$\\mathrm{SES}$）。这对每个群落都需要一个三阶段过程：（1）计算观测到的 $\\mathrm{FDis}$，（2）生成 $\\mathrm{FDis}$ 值的零分布，以及（3）从观测值和零分布中计算 $\\mathrm{SES}$。\n\n阶段1：计算观测的功能离散度（$\\mathrm{FDis}_{\\mathrm{obs}}$）。\n对于一个特定地点由存在-缺失向量 $\\mathbf{a}$ 定义的给定群落，我们首先确定存在的物种集合 $I = \\{i \\mid a_i = 1\\}$ 及其对应的性状向量 $\\{\\mathbf{t}_i\\}_{i \\in I}$。存在的物种数量即为丰富度 $m = |I|$。\n如果 $m \\le 1$，根据公理，离散度为零，因此 $\\mathrm{FDis} = 0$。对于 $m > 1$ 的情况，我们继续。\n首先，计算群落性状空间的质心。由于权重 $w_i$ 均为 $1$，质心 $\\mathbf{c}$ 是存在物种性状向量的算术平均值：\n$$ \\mathbf{c} = \\frac{1}{m} \\sum_{i \\in I} \\mathbf{t}_i $$\n接下来，对于每个存在的物种 $i \\in I$，计算其性状向量 $\\mathbf{t}_i$ 到质心 $\\mathbf{c}$ 的欧几里得距离 $d_i$：\n$$ d_i = \\lVert \\mathbf{t}_i - \\mathbf{c} \\rVert_2 = \\sqrt{\\sum_{k=1}^D (t_{ik} - c_k)^2} $$\n其中 $D$ 是性状的数量（空间的维度）。\n最后，功能离散度 $\\mathrm{FDis}$ 是这些距离的算术平均值。这个使用原始、未置换的性状数据计算出的值，即为观测到的功能离散度 $\\mathrm{FDis}_{\\mathrm{obs}}$。\n$$ \\mathrm{FDis}_{\\mathrm{obs}} = \\frac{1}{m} \\sum_{i \\in I} d_i $$\n此过程将应用于情况 A 和情况 B 中的每个地点。\n\n阶段2：生成零分布。\n零假设假定，观测到的群落组装相对于物种性状是随机的。所选的零模型通过随机化物种身份与其性状向量之间的关联来操作化此假设。该过程重复 $R$ 次，以创建一个在随机性下预期的 $\\mathrm{FDis}$ 值分布。\n对于从 $1$ 到 $R = 499$ 的每次重复 $r$：\n1. 生成物种索引 $\\{1, \\dots, S\\}$ 的一个随机置换 $\\pi$。固定的随机种子 $123$ 确保每次执行的置换序列都相同。\n2. 此置换应用于全局物种-性状矩阵 $\\mathbf{T}$ 的行，创建一个置换后的性状矩阵 $\\mathbf{T}^{(r)}$。因此，物种 $i$ 现在被赋予原属于物种 $\\pi(i)$ 的性状向量。\n3. 对于每个地点，使用原始固定的存在-缺失向量 $\\mathbf{a}$，但使用来自 $\\mathbf{T}^{(r)}$ 的置换性状，重新计算功能离散度 $\\mathrm{FDis}^{(r)}$。\n该过程为每个地点填充了一个包含 $R$ 个零模型 $\\mathrm{FDis}$ 值的向量：$\\{\\mathrm{FDis}^{(1)}, \\mathrm{FDis}^{(2)}, \\dots, \\mathrm{FDis}^{(R)}\\}$。\n\n阶段3：计算标准化效应量（$\\mathrm{SES}$）。\n$\\mathrm{SES}$ 以标准差为单位，量化了观测值 $\\mathrm{FDis}_{\\mathrm{obs}}$ 与零期望值的偏差。\n对于每个地点，我们首先计算在阶段2中生成的零分布的均值 $\\mu_{\\mathrm{null}}$ 和标准差 $\\sigma_{\\mathrm{null}}$：\n$$ \\mu_{\\mathrm{null}} = \\frac{1}{R} \\sum_{r=1}^R \\mathrm{FDis}^{(r)} $$\n$$ \\sigma_{\\mathrm{null}} = \\sqrt{\\frac{1}{R-1} \\sum_{r=1}^R (\\mathrm{FDis}^{(r)} - \\mu_{\\mathrm{null}})^2} $$\n此处适用样本标准差（分母为 $R-1$）。\n然后 $\\mathrm{SES}$ 计算如下：\n$$ \\mathrm{SES} = \\frac{\\mathrm{FDis}_{\\mathrm{obs}} - \\mu_{\\mathrm{null}}}{\\sigma_{\\mathrm{null}}} $$\n为 $\\sigma_{\\mathrm{null}} = 0$ 的情况定义了一个特殊条件。如果所有零模型重复都产生相同的 $\\mathrm{FDis}$ 值，就会发生这种情况，这在丰富度 $m \\le 1$ 的群落中是预期的。在这种情况下，$\\mathrm{SES}$ 定义为 $0$ 以避免除以零。\n负的 $\\mathrm{SES}$ 表明观测到的性状比随机预期的更聚类（$\\mathrm{FDis}_{\\mathrm{obs}}  \\mu_{\\mathrm{null}}$），这被解释为环境过滤的证据。正的 $\\mathrm{SES}$ 表明性状比随机预期的更分散（$\\mathrm{FDis}_{\\mathrm{obs}} > \\mu_{\\mathrm{null}}$），这被解释为限制性相似的证据。\n最终输出是情况 A 的所有 5 个地点和情况 B 的所有 3 个地点的 $\\mathrm{SES}$ 值列表，四舍五入到三位小数。\n\n实现将严格遵循这些阶段。为保证可复现性，将使用指定的种子 $123$ 初始化 `numpy` 随机数生成器。整个过程是确定性的。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating the standardized effect size of functional dispersion\n    for two test cases based on a trait-label randomization null model.\n    \"\"\"\n\n    # --- Define Test Cases ---\n\n    # Case A (univariate traits, D=1, S=8, 5 sites)\n    traits_A = np.array([0.05, 0.12, 0.20, 0.50, 0.60, 0.80, 0.92, 0.97]).reshape(-1, 1)\n    presences_A = np.array([\n        [1, 1, 1, 0, 0, 0, 0, 0],  # Site 1\n        [0, 1, 0, 1, 1, 0, 0, 0],  # Site 2\n        [0, 0, 0, 0, 0, 1, 1, 1],  # Site 3\n        [1, 0, 0, 1, 0, 0, 0, 1],  # Site 4\n        [0, 0, 0, 1, 0, 0, 0, 0],  # Site 5\n    ])\n\n    # Case B (bivariate traits, D=2, S=6, 3 sites)\n    traits_B = np.array([\n        [0.10, 0.10], [0.20, 0.20], [0.30, 0.30],\n        [0.70, 0.70], [0.80, 0.80], [0.90, 0.90]\n    ])\n    presences_B = np.array([\n        [1, 1, 1, 0, 0, 0],  # Site 1\n        [1, 0, 0, 0, 0, 1],  # Site 2\n        [0, 1, 0, 1, 0, 1],  # Site 3\n    ])\n\n    test_cases = [\n        (traits_A, presences_A),\n        (traits_B, presences_B),\n    ]\n\n    # --- Null Model Settings ---\n    R = 499\n    RANDOM_SEED = 123\n    rng = np.random.default_rng(RANDOM_SEED)\n\n    # --- Main Calculation Logic ---\n\n    def calculate_fdis(traits, presence_vector):\n        \"\"\"\n        Calculates Functional Dispersion (FDis) for a single community.\n        \"\"\"\n        present_indices = np.where(presence_vector == 1)[0]\n        richness = len(present_indices)\n\n        if richness <= 1:\n            return 0.0\n\n        present_traits = traits[present_indices]\n        \n        # Calculate centroid (community-weighted mean trait)\n        centroid = np.mean(present_traits, axis=0)\n\n        # Calculate Euclidean distances to the centroid\n        distances = np.linalg.norm(present_traits - centroid, axis=1)\n\n        # FDis is the mean distance to the centroid\n        fdis = np.mean(distances)\n        \n        return fdis\n\n    all_ses_results = []\n\n    for traits, presences_matrix in test_cases:\n        num_species = traits.shape[0]\n        \n        for site_presence_vector in presences_matrix:\n            # 1. Calculate observed FDis\n            fdis_obs = calculate_fdis(traits, site_presence_vector)\n\n            # 2. Generate null distribution of FDis\n            fdis_null = np.zeros(R)\n            for r in range(R):\n                permuted_indices = rng.permutation(num_species)\n                permuted_traits = traits[permuted_indices]\n                fdis_null[r] = calculate_fdis(permuted_traits, site_presence_vector)\n            \n            # 3. Calculate SES\n            mu_null = np.mean(fdis_null)\n            # Use ddof=1 for sample standard deviation, as specified in the solution.\n            sigma_null = np.std(fdis_null, ddof=1)\n\n            if sigma_null == 0.0:\n                ses = 0.0\n            else:\n                ses = (fdis_obs - mu_null) / sigma_null\n\n            all_ses_results.append(round(ses, 3))\n\n    # --- Final Output Formatting ---\n    # The final print statement must produce only the specified single-line format.\n    formatted_results = [f\"{res:.3f}\" for res in all_ses_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\n# Execute the main function.\nsolve()\n```", "id": "2472458"}]}