{"hands_on_practices": [{"introduction": "理解种群如何在基因流的同质化效应下适应不同的局域环境，是演化生物学的一个核心问题。第一个实践练习 [@problem_id:2734061] 将引导你分析一个具有相异选择（divergent selection）的经典双种群模型（two-deme model）。通过推导平衡状态下的等位基因频率差异，你将亲身体验用于量化局域选择和迁移之间拉锯战的数学工具，并理解它们的相对强度，即比率 $m/s$，如何决定遗传分化的程度。", "problem": "考虑一个单一的双等位基因座，其等位基因为 $A$ 和 $a$，存在于一个空间结构化的种群中。该种群由两个无限大的亚种群组成，亚种群之间通过对称迁移相连，每代迁移率为 $m$。在每个亚种群内部，每代通过随机交配恢复哈迪-温伯格平衡比例，其生命周期为选择后迁移。选择是加性的和发散的：在亚种群 1 中，基因型 $AA$、$Aa$、$aa$ 的生存力依次为 $1+s$、$1+\\frac{s}{2}$、$1$；在亚种群 2 中，顺序相反，基因型 $AA$、$Aa$、$aa$ 的生存力分别为 $1$、$1+\\frac{s}{2}$、$1+s$。假设 $s0$，$m0$，且 $m \\ll s \\ll 1$，因此弱选择和弱迁移近似适用，并且在主导阶上可以忽略小参数的乘积。\n\n设 $p_{1}$ 和 $p_{2}$ 分别表示在选择前，亚种群 1 和 2 中等位基因 $A$ 的频率。在迁移-选择平衡状态下，设 $\\Delta p^*=p_{1}^*-p_{2}^*$ 表示两个亚种群之间的平衡等位基因频率差异。\n\n仅从生存力选择和迁移的标准定义出发，并使用由 $m \\ll s \\ll 1$ 所证实的领先阶近似，推导在 $m/s \\to 0$ 极限下，$\\Delta p^*$ 作为 $m$ 和 $s$ 函数的渐近表达式，并解释其对 $m/s$ 的主导依赖关系如何反映迁移对局域分化的侵蚀作用。\n\n以 $m$ 和 $s$ 的单个闭式解析表达式形式给出你的最终结果，该表达式在小比率 $m/s$ 的主导阶上有效。不要包含高阶余项。不需要单位。", "solution": "对问题陈述进行验证。\n\n**步骤 1：提取已知条件**\n- **模型：** 单一双等位基因座，等位基因 $A$ 和 $a$。\n- **种群：** 两个无限大的亚种群。\n- **迁移：** 对称，每代迁移率为 $m$。\n- **交配：** 亚种群内随机交配。\n- **生命周期：** 选择后迁移。\n- **选择：** 加性的和发散的。\n- **生存力，亚种群 1：** $w_{AA,1} = 1+s$, $w_{Aa,1} = 1+\\frac{s}{2}$, $w_{aa,1} = 1$。\n- **生存力，亚种群 2：** $w_{AA,2} = 1$, $w_{Aa,2} = 1+\\frac{s}{2}$, $w_{aa,2} = 1+s$。\n- **参数：** $s0$, $m0$。\n- **近似：** $m \\ll s \\ll 1$ （弱选择，弱迁移）。在主导阶上忽略小参数的乘积。\n- **变量：** $p_{1}$ 和 $p_{2}$ 是选择前亚种群 1 和 2 中等位基因 $A$ 的频率。\n- **目标：** 在 $m/s \\to 0$ 的极限下，求出平衡等位基因频率差异 $\\Delta p^* = p_{1}^* - p_{2}^*$ 的渐近表达式。\n\n**步骤 2：使用提取的已知条件进行验证**\n- **科学依据：** 该问题描述了一个标准的迁移-选择平衡双亚种群模型（Levene 模型的一个变体），这是理论种群遗传学的基石。生存力选择、迁移和等位基因频率动态等概念在根本上是合理的。\n- **适定性：** 该问题是适定的。它指定了一个确定性动力系统，并要求在特定、明确定义的参数范围（$m \\ll s$）下求一个稳定平衡态。已知在这些条件下存在一个唯一的、稳定的多态性平衡。\n- **客观性：** 该问题以精确、客观的数学语言陈述，没有歧义或主观论断。\n\n**步骤 3：结论和行动**\n问题是有效的。这是数理演化理论中一个标准的、不平凡的练习。将推导解答。\n\n等位基因频率的动态由每代中选择和迁移的相继过程决定。设 $p_1$ 和 $p_2$ 分别为一代开始时（选择前）亚种群 1 和 2 中等位基因 $A$ 的频率。\n\n首先，我们分析选择的影响。在亚种群 1 中，选择有利于等位基因 $A$。基因型 $AA$、$Aa$ 和 $aa$ 的适合度分别为 $1+s$、$1+s/2$ 和 $1$。亚种群 1 的平均适合度为 $\\bar{w}_1 = p_1^2(1+s) + 2p_1(1-p_1)(1+s/2) + (1-p_1)^2(1) = 1+sp_1$。选择后等位基因 $A$ 的频率 $p'_1$ 由下式给出：\n$$p'_1 = \\frac{p_1^2(1+s) + p_1(1-p_1)(1+s/2)}{\\bar{w}_1} = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1)}{1+sp_1}$$\n由于选择引起的等位基因频率变化为 $\\Delta_s p_1 = p'_1 - p_1$：\n$$\\Delta_s p_1 = \\frac{p_1 + \\frac{s}{2}p_1(1+p_1) - p_1(1+sp_1)}{1+sp_1} = \\frac{\\frac{s}{2}p_1 - \\frac{s}{2}p_1^2}{1+sp_1} = \\frac{\\frac{s}{2}p_1(1-p_1)}{1+sp_1}$$\n鉴于选择是弱的（$s \\ll 1$）这一假设，我们可以近似分母 $1+sp_1 \\approx 1$。因此，在 $s$ 的主导阶上，变化为：\n$$\\Delta_s p_1 \\approx \\frac{s}{2}p_1(1-p_1)$$\n在亚种群 2 中，选择有利于等位基因 $a$。基因型 $AA$、$Aa$ 和 $aa$ 的适合度分别为 $1$、$1+s/2$ 和 $1+s$。等位基因 $A$ 的动态与亚种群 1 中等位基因 $a$ 的动态等价。令 $q_2 = 1-p_2$ 为亚种群 2 中等位基因 $a$ 的频率，其频率变化为 $\\Delta_s q_2 \\approx \\frac{s}{2}q_2(1-q_2)$。因此，等位基因 $A$ 的频率变化为 $\\Delta_s p_2 = -\\Delta_s q_2$。\n$$\\Delta_s p_2 \\approx -\\frac{s}{2}q_2(1-q_2) = -\\frac{s}{2}(1-p_2)p_2$$\n接下来，我们考虑迁移。生命周期是选择后迁移。迁移以对称的速率 $m$ 在亚种群之间发生。迁移后的等位基因频率 $p_1''$ 和 $p_2''$ 为：\n$$p_1'' = (1-m)p'_1 + m p'_2$$\n$$p_2'' = (1-m)p'_2 + m p'_1$$\n亚种群 1 在一代中的总等位基因频率变化为 $\\Delta p_1 = p_1'' - p_1$：\n$$\\Delta p_1 = (1-m)(p_1 + \\Delta_s p_1) + m(p_2 + \\Delta_s p_2) - p_1$$\n$$\\Delta p_1 = \\Delta_s p_1 - m(p_1 - p_2) - m\\Delta_s p_1 + m\\Delta_s p_2$$\n问题陈述指出，小参数（$m$ 和 $s$）的乘积在主导阶上可以忽略不计。$m\\Delta_s p_1$ 和 $m\\Delta_s p_2$ 项的量级为 $ms$，因此被忽略。$p_1$ 的递推关系简化为：\n$$\\Delta p_1 \\approx \\Delta_s p_1 - m(p_1 - p_2)$$\n在平衡状态下，$\\Delta p_1 = 0$。设 $p_1^*$ 和 $p_2^*$ 表示平衡频率。该条件变为：\n$$\\Delta_s p_1(p_1^*) \\approx m(p_1^* - p_2^*)$$\n$$\\frac{s}{2}p_1^*(1-p_1^*) \\approx m(p_1^* - p_2^*)$$\n对亚种群 2 进行类似分析可得 $\\Delta p_2 \\approx \\Delta_s p_2 + m(p_1 - p_2)$，在平衡状态下得到：\n$$\\Delta_s p_2(p_2^*) \\approx -m(p_1^* - p_2^*) = m(p_2^* - p_1^*)$$\n$$-\\frac{s}{2}p_2^*(1-p_2^*) \\approx m(p_2^* - p_1^*)$$\n这两个平衡条件是一致的，并意味着 $p_1^*(1-p_1^*) = p_2^*(1-p_2^*)$。该等式有两个解：一个是在发散选择下不稳定的平凡解 $p_1^*=p_2^*$，另一个是对称解 $p_1^* = 1 - p_2^*$，即 $p_1^* + p_2^* = 1$。后一个解对应于由迁移-选择平衡维持的稳定多态性平衡。\n\n我们将对称条件 $p_2^* = 1 - p_1^*$ 代入亚种群 1 的平衡方程中：\n$$m(p_1^* - (1-p_1^*)) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\n$$m(2p_1^* - 1) \\approx \\frac{s}{2}p_1^*(1-p_1^*)$$\n我们感兴趣的是 $m/s \\to 0$ 的极限，此时选择远强于迁移。在这种情况下，我们预期局域有利的等位基因在每个亚种群中都接近固定。因此，$p_1^* \\to 1$ 且 $p_2^* \\to 0$。设 $p_1^* = 1-\\epsilon$ 和 $p_2^* = \\epsilon$，其中 $\\epsilon$ 是某个小的正数。条件 $p_1^*+p_2^* = 1$ 自动满足。将 $p_1^* = 1-\\epsilon$ 代入平衡方程：\n$$m(2(1-\\epsilon) - 1) \\approx \\frac{s}{2}(1-\\epsilon)(1 - (1-\\epsilon))$$\n$$m(1 - 2\\epsilon) \\approx \\frac{s}{2}(1-\\epsilon)\\epsilon$$\n由于 $m/s \\to 0$，我们预期 $\\epsilon$ 会很小。因此，我们可以通过在括号内取 $\\epsilon \\to 0$ 来进行主导阶近似：\n$$m(1) \\approx \\frac{s}{2}(1)\\epsilon$$\n这得出了 $\\epsilon$ 的一阶近似：\n$$\\epsilon \\approx \\frac{2m}{s}$$\n这证实了当 $m/s$ 很小时，$\\epsilon$ 也很小。\n因此，平衡等位基因频率近似为：\n$$p_1^* \\approx 1 - \\frac{2m}{s}$$\n$$p_2^* \\approx \\frac{2m}{s}$$\n问题要求的是平衡等位基因频率差异 $\\Delta p^* = p_1^* - p_2^*$：\n$$\\Delta p^* \\approx \\left(1 - \\frac{2m}{s}\\right) - \\frac{2m}{s} = 1 - \\frac{4m}{s}$$\n这就是在小比率 $m/s$ 的主导阶上有效的 $\\Delta p^*$ 的渐近表达式。\n\n解释：量 $\\Delta p^*$ 衡量了两个亚种群之间的遗传分化程度。在没有迁移（$m=0$）的情况下，选择将驱动局域有利的等位基因达到固定，导致 $p_1^*=1$ 和 $p_2^*=0$，因此分化将达到最大值 $\\Delta p^*=1$。迁移作为一种均质化力量，通过从另一个亚种群引入等位基因来对抗选择。推导出的表达式 $\\Delta p^* \\approx 1 - 4m/s$ 精确地展示了这一过程是如何发生的。与最大分化的偏差为 $-4m/s$。这种主导阶的依赖关系表明，局域分化的侵蚀程度与迁移率和选择强度的比率成正比。当迁移相对于选择较弱时（$m/s \\ll 1$），分化程度保持很高，接近于 1。", "answer": "$$\\boxed{1 - \\frac{4m}{s}}$$", "id": "2734061"}, {"introduction": "任何理论模型的预测都关键性地依赖于其底层假设。在本练习 [@problem_id:2734031] 中，我们将通过检验一个单倍体大陆-岛屿模型来探讨这一原则，该模型是研究非适应性基因流的关键情景。你将比较此模型的两个变体，它们唯一的区别在于一个世代内选择和迁移的发生顺序，从而揭示生命周期中这个看似微小的细节如何改变一个局域适应等位基因的平衡频率。", "problem": "一个单倍体种群栖息在一个岛屿上，每个离散的世代都会从一个大得多的陆地接收迁移者。大陆种群中等位基因 $a$ 已固定。在岛屿上，单个基因座上有两个等位基因：$A$（本地适应型）和 $a$（适应不良型）。在生存选择和迁移之后，岛屿的种群统计学特征被调节至恒定大小。假设种群大小无限，且没有突变或遗传漂变。\n\n岛屿上的生存选择作用方式如下：$A$ 的适合度为 $1$，$a$ 的适合度为 $1 - s$，其中 $0  s  1$。每一代，岛屿上比例为 $m$ 的个体被来自大陆的迁移者所替代，其中 $0  m  1$。令 $p_t$ 表示在第 $t$ 代，在该代迁移和选择发生之前，岛屿上 $A$ 的频率。\n\n考虑两种生命周期，它们仅在每一代内迁移和选择的顺序上有所不同：\n- 先迁移后选择（将此顺序表示为 $\\mathrm{MS}$）：首先发生迁移，然后是生存选择。\n- 先选择后迁移（将此顺序表示为 $\\mathrm{SM}$）：首先发生生存选择，然后是迁移。\n\n仅从单倍体生存选择和单向迁移（大陆-岛屿模型）的第一性原理以及上述定义出发，推导每种生命周期下 $p_{t+1}$ 的精确确定性递推关系式，并求解每种顺序下岛屿上等位基因 $A$ 的非平凡平衡频率 $p^{*}$，分别表示为 $p^{*}_{\\mathrm{MS}}$ 和 $p^{*}_{\\mathrm{SM}}$。然后，在迁移相对于选择较弱的渐近区域（即 $0  m \\ll s \\ll 1$）下，确定前导项差异\n$$\n\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}\n$$\n到 $m$ 和 $s$ 的一阶，明确忽略所有小参数的乘积及更高阶项（即，舍弃所有 $m^{2}$、$s^{2}$、$m s$ 及更高阶的项）。请用一个关于 $m$ 和 $s$ 的解析表达式表示您的最终答案。不需要四舍五入，最终答案不得包含百分号。", "solution": "必须首先验证问题陈述的科学合理性、一致性和完整性。\n\n**步骤1：提取已知条件**\n- 种群：单倍体，无限大小，种群动态后大小恒定。\n- 模型：大陆-岛屿模型。\n- 等位基因：$A$（本地适应型）和 $a$（适应不良型）。\n- 大陆：等位基因 $a$ 已固定，$A$ 的频率为 $0$。\n- 岛屿上的适合度：$w_A = 1$，$w_a = 1-s$，其中 $0  s  1$。\n- 迁移：从大陆到岛屿的单向迁移。每一代，岛屿种群中比例为 $m$ 的个体被迁移者替换，其中 $0  m  1$。\n- 变量：$p_t$ 是第 $t$ 代迁移和选择前岛屿上等位基因 $A$ 的频率。\n- 生命周期：\n    1. 先迁移后选择 $(\\mathrm{MS})$。\n    2. 先选择后迁移 $(\\mathrm{SM})$。\n- 目标：\n    1. 推导每种生命周期下 $p_{t+1}$ 的递推关系式。\n    2. 求解每种生命周期下的非平凡平衡频率 $p^*$（$p^{*}_{\\mathrm{MS}}$ 和 $p^{*}_{\\mathrm{SM}}$）。\n    3. 在渐近区域 $0  m \\ll s \\ll 1$ 下，确定前导项差异 $\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}$。\n    4. 近似到 $m$ 和 $s$ 的一阶，忽略所有 $m^2$、$s^2$、$ms$ 及更高阶的项。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题是理论群体遗传学中的一个标准练习，特别是关于迁移-选择平衡的分析。\n- **科学依据**：该模型是进化生物学中研究局域适应和基因流相互作用的一个经典和基础的构架。它是科学合理的。\n- **良态问题**：该问题以数学精度进行了规定。所有参数和变量（$m, s, p_t$）都得到了明确定义。目标是具体的，并允许唯一的数学解。\n- **客观性**：语言是技术性的，没有主观或非科学内容。\n\n所有其他验证标准均已满足。该问题不包含任何矛盾、歧义或事实错误。\n\n**步骤3：结论和行动**\n问题是有效的。我将进行完整的推导和求解。\n\n**递推关系式和平衡点的推导**\n\n首先，我们将等位基因 $A$ 频率为 $p$ 的种群的平均适合度定义为 $\\bar{w}$。对于单倍体种群，其表达式为：\n$$\n\\bar{w} = p \\cdot w_A + (1-p) \\cdot w_a = p(1) + (1-p)(1-s) = 1 - s(1-p)\n$$\n选择之后，等位基因 $A$ 的新频率（表示为 $p'$）由下式给出：\n$$\np' = \\frac{p \\cdot w_A}{\\bar{w}} = \\frac{p}{1 - s(1-p)}\n$$\n来自大陆的迁移（其中 $A$ 的频率为 $0$）将岛屿上迁移前的频率 $p$ 转换为迁移后的频率 $p''$：\n$$\np'' = (1-m)p + m(0) = (1-m)p\n$$\n\n我们现在分析两种指定的生命周期。\n\n**1. 先迁移后选择 (MS) 生命周期**\n在这种情况下，首先发生迁移，然后是选择。\n- 设 $p_t$ 为第 $t$ 代开始时 $A$ 的频率。\n- 迁移后，$A$ 的频率（我们称之为 $p_t'$）变为：\n$$\np_t' = (1-m)p_t\n$$\n- 然后选择作用于这个迁移后的种群。第 $t+1$ 代开始时 $A$ 的频率，即 $p_{t+1}$，是：\n$$\np_{t+1} = \\frac{p_t' \\cdot w_A}{p_t' \\cdot w_A + (1-p_t') \\cdot w_a} = \\frac{(1-m)p_t}{1 - s(1-p_t')} = \\frac{(1-m)p_t}{1 - s(1 - (1-m)p_t)}\n$$\n这就是 MS 模型的递推关系式。\n\n为了求平衡频率 $p^{*}_{\\mathrm{MS}}$，我们令 $p_{t+1} = p_t = p^*$：\n$$\np^* = \\frac{(1-m)p^*}{1 - s(1 - (1-m)p^*)}\n$$\n这个方程有一个平凡解 $p^* = 0$。对于非平凡解（$p^* \\neq 0$），我们可以两边同除以 $p^*$：\n$$\n1 = \\frac{1-m}{1 - s(1 - (1-m)p^*)}\n$$\n$$\n1 - s(1 - (1-m)p^*) = 1-m\n$$\n$$\n1 - s + s(1-m)p^* = 1-m\n$$\n$$\ns(1-m)p^* = s-m\n$$\n求解 $p^*$，我们得到 MS 模型的非平凡平衡频率：\n$$\np^{*}_{\\mathrm{MS}} = \\frac{s-m}{s(1-m)}\n$$\n\n**2. 先选择后迁移 (SM) 生命周期**\n在这种情况下，首先发生选择，然后是迁移。\n- 设 $p_t$ 为第 $t$ 代开始时 $A$ 的频率。\n- 选择后，$A$ 的频率（我们称之为 $p_t''$）变为：\n$$\np_t'' = \\frac{p_t \\cdot w_A}{\\bar{w}} = \\frac{p_t}{1-s(1-p_t)}\n$$\n- 然后迁移作用于这个选择后的种群。第 $t+1$ 代开始时 $A$ 的频率是：\n$$\np_{t+1} = (1-m)p_t'' = (1-m)\\frac{p_t}{1-s(1-p_t)}\n$$\n这就是 SM 模型的递推关系式。\n\n为了求平衡频率 $p^{*}_{\\mathrm{SM}}$，我们令 $p_{t+1} = p_t = p^*$：\n$$\np^* = (1-m)\\frac{p^*}{1-s(1-p^*)}\n$$\n这个方程同样有一个平凡解 $p^*=0$。对于非平凡解（$p^* \\neq 0$），我们两边同除以 $p^*$：\n$$\n1 = \\frac{1-m}{1-s(1-p^*)}\n$$\n$$\n1-s(1-p^*) = 1-m\n$$\n$$\n1-s+sp^* = 1-m\n$$\n$$\nsp^* = s-m\n$$\n求解 $p^*$，我们得到 SM 模型的非平凡平衡频率：\n$$\np^{*}_{\\mathrm{SM}} = \\frac{s-m}{s} = 1 - \\frac{m}{s}\n$$\n\n**平衡频率差异分析**\n我们需要在区域 $0  m \\ll s \\ll 1$ 中找到前导项差异 $\\Delta p^{*} \\equiv p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}}$。首先，我们计算精确的差异：\n$$\n\\Delta p^{*} = p^{*}_{\\mathrm{MS}} - p^{*}_{\\mathrm{SM}} = \\frac{s-m}{s(1-m)} - \\frac{s-m}{s}\n$$\n提取公因式 $\\frac{s-m}{s}$：\n$$\n\\Delta p^{*} = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1}{1-m} - 1\\right) = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1 - (1-m)}{1-m}\\right) = \\left(\\frac{s-m}{s}\\right) \\left(\\frac{m}{1-m}\\right)\n$$\n这就给出了差异的精确解析表达式：\n$$\n\\Delta p^{*} = \\frac{m(s-m)}{s(1-m)}\n$$\n现在，我们必须在条件 $0  m \\ll s \\ll 1$ 下找到该表达式的前导项近似。这个条件意味着 $m$，$s$，以及比率 $m/s$ 都是远小于 $1$ 的小参数。我们可以根据这些小参数展开 $\\Delta p^{*}$ 的表达式。\n让我们将表达式重写为：\n$$\n\\Delta p^{*} = \\frac{ms - m^2}{s - sm}\n$$\n为了找到前导项行为，我们可以对分子和分母进行近似。\n在分子 $ms - m^2$ 中，由于 $m \\ll s \\implies m^2 \\ll ms$，项 $m^2$ 远小于 $ms$。因此，分子近似为 $ms$。\n在分母 $s - sm$ 中，由于 $m \\ll 1$，项 $sm$ 远小于 $s$。因此，分母近似为 $s$。\n结合这些近似，我们找到了差异的前导项行为：\n$$\n\\Delta p^{*} \\approx \\frac{ms}{s} = m\n$$\n或者，我们可以进行泰勒展开。我们有 $\\Delta p^{*} = m \\left(\\frac{s-m}{s}\\right) \\left(\\frac{1}{1-m}\\right) = m \\left(1-\\frac{m}{s}\\right) (1-m)^{-1}$。\n对于小的 $m$，使用几何级数展开 $(1-m)^{-1} = 1+m+m^2+\\dots$：\n$$\n\\Delta p^{*} = m \\left(1-\\frac{m}{s}\\right) (1+m+O(m^2)) = m \\left(1+m - \\frac{m}{s} - \\frac{m^2}{s} + \\dots \\right)\n$$\n$$\n\\Delta p^{*} = m + m^2 - \\frac{m^2}{s} - \\frac{m^3}{s} + \\dots\n$$\n问题要求的是前导项差异，即在约束 $m \\ll s$ 下，当 $m, s \\to 0$ 时此展开式中的主导项。这些项是 $m$、$m^2$ 和 $-m^2/s$。\n- $m$ 项是关于 $m$ 的一阶项。\n- $m^2$ 项是关于 $m$ 的二阶项。\n- 项 $-m^2/s = -m(m/s)$ 是两个小量 $m$ 和 $m/s$ 的乘积。它比 $m$ 的阶数更高。\n指令要求忽略 $m^2$、$s^2$、$ms$ 及更高阶的项。与 $m$ 相比，$m^2$ 和 $m^2/s$ 都是高阶项。具体来说，根据指令的意图，$m^2/s$ 可以被认为是 $m \\cdot (m/s)$ 阶，即小参数的乘积。因此，这些项被忽略。\n前导项就是 $m$。\n这个结果表明，在一阶近似下，当选择先于迁移时，本地适应等位基因的平衡频率要高出 $m$。这是因为在被适应不良的迁移者稀释之前，选择可以更有效地增加适应等位基因的频率。", "answer": "$$\n\\boxed{m}\n$$", "id": "2734031"}, {"introduction": "既然已经确定不同的生命周期顺序会产生不同的理论预测，我们如何判断哪个模型能更好地描述一个真实种群呢？最后的这个实践练习 [@problem_id:2734038] 将从纯理论过渡到计算统计学，这是现代演化生物学研究中的一项至关重要的技能。你将使用贝叶斯模型比较来评估“先迁移后选择”与“先选择后迁移”模型的证据，学习如何用数据检验模型假设，并评估诸如迁移率 $m$ 和选择系数 $s$ 等参数推断的稳健性。", "problem": "考虑一个单一位点、两个等位基因的单倍体岛屿模型，该模型涉及迁移和生存力选择。在一个大型驻留种群中，个体与一个已知等位基因频率的外部移民池进行交换。设目标等位基因为 $A$，其在每个驻留亚群中的频率为 $p$，在移民池中的频率为 $p_{\\mathrm{m}}$。设驻留亚群的索引为 $j \\in \\{1,\\dots,D\\}$。假设如下。\n\n- 基本原理：\n  - 单倍体的生存力选择由等位基因特异性的相对适应度定义。如果等位基因 $A$ 的相对适应度为 $1+s$，而另一个等位基因的适应度为 $1$，则选择后的等位基因频率与适应度加权的频率成正比。具体而言，选择后的频率是通过相对适应度对 $A$ 的频率进行加权，然后通过平均适应度进行归一化得到的频率。\n  - 被动迁移是质量作用混合：迁移率为 $m \\in [0,1]$，一部分比例为 $m$ 的等位基因被频率为 $p_{\\mathrm{m}}$ 的移民所取代，剩余比例为 $1-m$ 的等位基因保持为驻留。\n  - 观测值由二项抽样生成：如果在抽样时亚群 $j$ 的期望等位基因频率为 $p'_j$，那么在大小为 $n_j$ 的样本中观测到 $x_j$ 个 $A$ 等位基因拷贝的概率由成功概率为 $p'_j$ 的二项分布给出。\n- 考虑两种竞争性的生活史模型：\n  - 模型 $\\mathcal{M}_{\\mathrm{ms}}$：每一代中，迁移先于选择发生。\n  - 模型 $\\mathcal{M}_{\\mathrm{sm}}$：每一代中，选择先于迁移发生。\n\n假设对于每个亚群 $j$，您观测到目标生活史阶段之前的初始驻留等位基因频率 $p_{0,j}$，与亚群 $j$ 相关的移民池等位基因频率 $p_{\\mathrm{m},j}$（可能在各亚群间相同），以及在目标生活史阶段之后立即抽样的 $n_j$ 个个体中等位基因 $A$ 的样本计数 $x_j$。假设在给定参数的情况下，各亚群是条件独立的。\n\n您的任务是：在 $\\mathcal{M}_{\\mathrm{ms}}$ 和 $\\mathcal{M}_{\\mathrm{sm}}$ 之间进行贝叶斯模型比较，并评估所推断的迁移率 $m$ 和选择系数 $s$ 对于迁移和选择顺序的稳健性。\n\n要求：\n\n- 先验：\n  - 对 $m$ 在 $[0,0.5]$ 区间上设置均匀先验，对 $s$ 在 $[-0.2,0.5]$ 区间上设置均匀先验。假设两种模型的先验概率相等，即 $\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$。\n- 给定模型下的似然：\n  - 对于每个亚群 $j$，根据模型指定的顺序组合选择和迁移，从基本原理定义中推导出阶段结束后的期望频率 $p'_j$。然后，计算在给定 $p'_j$ 的情况下观测到 $n_j$ 中有 $x_j$ 的二项抽样似然，并假设各亚群间相互独立以获得完整似然。所有概率均以小数表示，而非百分比。\n- 证据和后验：\n  - 通过在指定的均匀先验下对似然函数在 $(m,s)$ 上进行数值积分，计算每个模型的边际似然（证据）。使用一个矩形网格，其中 $m \\in [0,0.5]$ 上有 $201$ 个均匀间隔的点，$s \\in [-0.2,0.5]$ 上有 $251$ 个均匀间隔的点。通过网格上的黎曼和执行数值积分，并确保数值稳定性（例如，通过在对数空间中操作并使用 log-sum-exp 方法）。\n  - 根据证据和相等的模型先验，计算后验模型概率 $\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data})$ 和 $\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data})$。\n  - 在每个模型下，使用相同的网格和与似然乘以先验成正比的后验权重，计算后验均值 $\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}]$ 和 $\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}]$。\n- 输出格式：\n  - 对于下面测试套件中的每个测试用例，按以下顺序输出一个包含六个浮点数的列表：$[\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}), \\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}), \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{ms}}], \\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}], \\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_{\\mathrm{sm}}]]$.\n  - 您的程序应生成单行输出，其中包含所有测试用例的结果。结果为一个用方括号括起来的逗号分隔列表，其中每个元素是针对一个测试用例的六浮点数列表，每个浮点数四舍五入到 $6$ 位小数，例如：$[[0.500000,0.500000,0.100000,0.200000,0.100000,0.200000],\\dots]$。\n\n测试套件：\n\n- 用例 1（迁移先于选择生成数据）：\n  - 亚群：$D=3$。\n  - 初始驻留频率：$p_{0} = [0.2, 0.4, 0.6]$。\n  - 移民池频率：$p_{\\mathrm{m}} = 0.8$（所有亚群相同）。\n  - 样本量：$n = [100, 100, 100]$。\n  - 观测计数：$x = [30, 49, 66]$。\n\n- 用例 2（选择先于迁移生成数据）：\n  - 亚群：$D=3$。\n  - 初始驻留频率：$p_{0} = [0.1, 0.5, 0.9]$。\n  - 移民池频率：$p_{\\mathrm{m}} = 0.2$。\n  - 样本量：$n = [200, 200, 200]$。\n  - 观测计数：$x = [24, 104, 175]$。\n\n- 用例 3（中性选择，顺序无关的边界情况）：\n  - 亚群：$D=2$。\n  - 初始驻留频率：$p_{0} = [0.3, 0.7]$。\n  - 移民池频率：$p_{\\mathrm{m}} = 0.5$。\n  - 样本量：$n = [150, 150]$。\n  - 观测计数：$x = [51, 99]$。\n\n- 用例 4（高迁移率主导，顺序效应弱）：\n  - 亚群：$D=3$。\n  - 初始驻留频率：$p_{0} = [0.0, 0.2, 0.4]$。\n  - 移民池频率：$p_{\\mathrm{m}} = 0.6$。\n  - 样本量：$n = [100, 100, 100]$。\n  - 观测计数：$x = [29, 42, 55]$。\n\n角度单位不适用。不涉及物理单位。所有概率必须是小数。您的程序必须实现上述规范，并按所描述的精确格式生成单行聚合列表输出，每个浮点数四舍五入到 $6$ 位小数。", "solution": "该问题已经过验证，被认为是科学上合理的、适定的和完整的。它代表了计算群体遗传学中的一个标准练习，涉及贝叶斯模型比较和参数估计。所有必需的数据、模型和先验分布都已指定。没有矛盾或含糊之处。因此，我将着手提供一个完整的解决方案。\n\n问题的核心是比较两种竞争模型，这两种模型描述了迁移和自然选择在单倍体种群中的联合作用。这些模型在每一代中这两个进化过程的发生顺序上有所不同。\n\n首先，我们定义选择和迁移的算子。\n设 $p$ 是进化过程发生前等位基因 $A$ 的频率。\n在生存力选择之后，频率变为 $p_s$。设 $A$ 的相对适应度为 $1+s$，另一个等位基因的适应度为 $1$，则 $p_s$ 由以下公式给出：\n$$p_s = \\mathcal{S}(p, s) = \\frac{p(1+s)}{p(1+s) + (1-p)(1)} = \\frac{p(1+s)}{1+ps}$$\n在迁移之后，频率变为 $p_m$。其中，比例为 $m$ 的种群被等位基因频率为 $p_{\\mathrm{m}}$ 的移民所替代，则 $p_m$ 由以下公式给出：\n$$p_m = \\mathcal{M}(p, m, p_{\\mathrm{m}}) = (1-m)p + m p_{\\mathrm{m}}$$\n这些定义在 $s  -1$、$m \\in [0,1]$ 以及频率 $p, p_{\\mathrm{m}} \\in [0,1]$ 时有效。问题对 $s \\in [-0.2, 0.5]$ 和 $m \\in [0, 0.5]$ 的约束确保了这些表达式的有效性。\n\n接下来，我们为两种模型构建每个亚群 $j$ 在阶段结束后的期望等位基因频率 $p'_j$。初始等位基因频率为 $p_{0,j}$，移民频率为 $p_{\\mathrm{m},j}$。\n\n模型 $\\mathcal{M}_{\\mathrm{ms}}$ (迁移先于选择)：\n等位基因频率首先受迁移影响，然后受选择影响。\n$$p'_{\\mathrm{ms}, j}(m, s) = \\mathcal{S}(\\mathcal{M}(p_{0,j}, m, p_{\\mathrm{m},j}), s) = \\frac{((1-m)p_{0,j} + m p_{\\mathrm{m},j})(1+s)}{1 + s((1-m)p_{0,j} + m p_{\\mathrm{m},j})}$$\n\n模型 $\\mathcal{M}_{\\mathrm{sm}}$ (选择先于迁移)：\n等位基因频率首先受选择影响，然后受迁移影响。\n$$p'_{\\mathrm{sm}, j}(m, s) = \\mathcal{M}(\\mathcal{S}(p_{0,j}, s), m, p_{\\mathrm{m},j}) = (1-m)\\left(\\frac{p_{0,j}(1+s)}{1+p_{0,j}s}\\right) + m p_{\\mathrm{m},j}$$\n\n对于给定模型 $\\mathcal{M}_k$（其中 $k \\in \\{\\text{ms, sm}\\}$）和参数 $(m, s)$，观测到数据的似然是基于二项抽样的。假设 $D$ 个亚群之间相互独立，总似然是各个二项概率的乘积：\n$$L(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\prod_{j=1}^D P(x_j \\mid n_j, p'_{k,j}(m,s)) = \\prod_{j=1}^D \\binom{n_j}{x_j} (p'_{k,j})^{x_j} (1-p'_{k,j})^{n_j - x_j}$$\n为便于数值计算，我们使用对数似然。涉及二项式系数的项 $\\sum_j \\log\\binom{n_j}{x_j}$ 对于模型参数而言是常数，并且对于两个模型是相同的。因此，在计算后验模型概率时它会抵消，在计算后验均值时可以忽略。我们将部分对数似然 $J_k(m,s)$ 定义为：\n$$J_k(m,s) = \\log L^*(m,s \\mid \\text{data}, \\mathcal{M}_k) = \\sum_{j=1}^D \\left[ x_j \\log(p'_{k,j}(m,s)) + (n_j-x_j)\\log(1-p'_{k,j}(m,s)) \\right]$$\n分析在参数值的离散网格上进行：$m$ 在 $[0, 0.5]$ 区间的 $N_m = 201$ 个点上取值，$s$ 在 $[-0.2, 0.5]$ 区间的 $N_s = 251$ 个点上取值。\n\n为了进行贝叶斯模型比较，我们计算每个模型的边际似然（证据）$\\Pr(\\text{data} \\mid \\mathcal{M}_k)$。这是通过对似然函数在先验分布上积分得到的。\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) = \\int_{-0.2}^{0.5} \\int_0^{0.5} L(m,s \\mid \\text{data}, \\mathcal{M}_k) \\pi(m,s) \\,dm \\,ds$$\n在均匀先验下，$\\pi(m,s)$ 是一个常数。该积分通过参数网格上的黎曼和来近似：\n$$\\Pr(\\text{data} \\mid \\mathcal{M}_k) \\propto \\sum_i \\sum_l L(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$$\n令 $U_k = \\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$。由于模型先验相等，$\\Pr(\\mathcal{M}_{\\mathrm{ms}}) = \\Pr(\\mathcal{M}_{\\mathrm{sm}}) = 0.5$，模型的后验概率与其证据成正比：\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{U_{\\mathrm{ms}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\n$$\\Pr(\\mathcal{M}_{\\mathrm{sm}} \\mid \\text{data}) = \\frac{U_{\\mathrm{sm}}}{U_{\\mathrm{ms}} + U_{\\mathrm{sm}}}$$\n为了稳定地计算这些和，我们使用 log-sum-exp 技巧。我们计算对数似然网格 $J_k(m_i, s_l)$，找到最大值 $J_{k, \\text{max}}$，然后计算相对于此最大值的指数化值的总和。令 $\\log U_k = J_{k, \\text{max}} + \\log\\left(\\sum_{i,l} \\exp(J_k(m_i, s_l) - J_{k, \\text{max}})\\right)$。那么 $\\mathcal{M}_{\\mathrm{ms}}$ 的后验概率变为：\n$$\\Pr(\\mathcal{M}_{\\mathrm{ms}} \\mid \\text{data}) = \\frac{1}{1 + \\exp(\\log U_{\\mathrm{sm}} - \\log U_{\\mathrm{ms}})}$$\n\n在模型 $\\mathcal{M}_k$ 下，参数（例如 $m$）的后验均值是通过在网格上进行加权平均来计算的，其中权重是每个网格点上的后验概率，该概率与似然值 $L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)$ 成正比。\n$$\\mathbb{E}[m \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} m_i L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\n$$\\mathbb{E}[s \\mid \\text{data}, \\mathcal{M}_k] \\approx \\frac{\\sum_{i,l} s_l L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}{\\sum_{i,l} L^*(m_i, s_l \\mid \\text{data}, \\mathcal{M}_k)}$$\n这些计算也使用从对数似然网格导出的数值稳定的权重来执行。为了提高效率，实现过程将通过在参数网格上向量化这些计算来进行。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Bayesian model comparison problem for all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (migration-before-selection generates the data)\n        {\n            \"p0\": np.array([0.2, 0.4, 0.6]),\n            \"pm\": 0.8,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([30, 49, 66]),\n        },\n        # Case 2 (selection-before-migration generates the data)\n        {\n            \"p0\": np.array([0.1, 0.5, 0.9]),\n            \"pm\": 0.2,\n            \"n\": np.array([200, 200, 200]),\n            \"x\": np.array([24, 104, 175]),\n        },\n        # Case 3 (neutral selection, order irrelevance edge case)\n        {\n            \"p0\": np.array([0.3, 0.7]),\n            \"pm\": 0.5,\n            \"n\": np.array([150, 150]),\n            \"x\": np.array([51, 99]),\n        },\n        # Case 4 (high migration dominates, weak order effect)\n        {\n            \"p0\": np.array([0.0, 0.2, 0.4]),\n            \"pm\": 0.6,\n            \"n\": np.array([100, 100, 100]),\n            \"x\": np.array([29, 42, 55]),\n        },\n    ]\n\n    # Define the parameter grid\n    m_grid = np.linspace(0, 0.5, 201)\n    s_grid = np.linspace(-0.2, 0.5, 251)\n    M, S = np.meshgrid(m_grid, s_grid, indexing='ij')\n\n    results = []\n    for case in test_cases:\n        p0, pm, n, x = case[\"p0\"], case[\"pm\"], case[\"n\"], case[\"x\"]\n\n        # Analyze Model M_ms (migration-before-selection)\n        log_evidence_sum_ms, E_m_ms, E_s_ms = analyze_model(\n            p_prime_ms, p0, pm, n, x, M, S\n        )\n\n        # Analyze Model M_sm (selection-before-migration)\n        log_evidence_sum_sm, E_m_sm, E_s_sm = analyze_model(\n            p_prime_sm, p0, pm, n, x, M, S\n        )\n\n        # Calculate posterior model probabilities\n        # Pr(M_ms | data) = E_ms / (E_ms + E_sm) = 1 / (1 + E_sm/E_ms)\n        # log(E_sm/E_ms) = log(E_sm) - log(E_ms)\n        log_ratio = log_evidence_sum_sm - log_evidence_sum_ms\n        \n        # Handle potential overflow/underflow if differences are very large\n        if log_ratio > 700: # exp(700) is large\n            p_ms = 0.0\n        elif log_ratio  -700:\n            p_ms = 1.0\n        else:\n            p_ms = 1.0 / (1.0 + np.exp(log_ratio))\n        \n        p_sm = 1.0 - p_ms\n\n        case_results = [p_ms, p_sm, E_m_ms, E_s_ms, E_m_sm, E_s_sm]\n        results.append(case_results)\n\n    # Format output\n    formatted_results = []\n    for res_list in results:\n        formatted_list_str = \"[\" + \",\".join([f\"{val:.6f}\" for val in res_list]) + \"]\"\n        formatted_results.append(formatted_list_str)\n\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef p_prime_ms(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Migration-before-Selection model.\"\"\"\n    p_post_mig = (1 - M) * p0_deme + M * pm\n    # Denominator 1 + p_post_mig * S is always > 0 for s > -1\n    return (p_post_mig * (1 + S)) / (1 + p_post_mig * S)\n\ndef p_prime_sm(p0_deme, pm, M, S):\n    \"\"\"Calculates final allele frequency for the Selection-before-Migration model.\"\"\"\n    # Denominator 1 + p0_deme * S is always > 0 for s > -1\n    p_post_sel = (p0_deme * (1 + S)) / (1 + p0_deme * S)\n    return (1 - M) * p_post_sel + M * pm\n\ndef analyze_model(model_func, p0, pm, n, x, M, S):\n    \"\"\"\n    Computes log-evidence sum and posterior means for a given model.\n    \"\"\"\n    total_log_likelihood = np.zeros_like(M)\n\n    for j in range(len(p0)):\n        # Calculate expected frequency grid for deme j\n        p_prime_grid = model_func(p0[j], pm, M, S)\n        \n        # Clip for numerical stability of log\n        p_prime_grid = np.clip(p_prime_grid, 1e-12, 1.0 - 1e-12)\n        \n        # Calculate log-likelihood for deme j and add to total\n        deme_log_L = x[j] * np.log(p_prime_grid) + (n[j] - x[j]) * np.log(1.0 - p_prime_grid)\n        total_log_likelihood += deme_log_L\n    \n    # Use log-sum-exp for stable computation of evidence and posterior means\n    log_L_max = np.max(total_log_likelihood)\n    weights = np.exp(total_log_likelihood - log_L_max)\n    total_weight = np.sum(weights)\n\n    log_evidence_sum = log_L_max + np.log(total_weight)\n\n    # Posterior means\n    E_m = np.sum(weights * M) / total_weight\n    E_s = np.sum(weights * S) / total_weight\n\n    return log_evidence_sum, E_m, E_s\n\nsolve()\n```", "id": "2734038"}]}