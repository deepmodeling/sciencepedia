{"hands_on_practices": [{"introduction": "杂合度是衡量群体遗传多样性的核心指标。在实践中，我们通常使用样本频率直接代入公式来估算杂合度，即所谓的“代入式”估计量。然而，这种直观的方法在样本量有限时会产生系统性偏差，这个练习将引导你从第一性原理出发，推导该偏差并构建一个无偏估计量，从而揭示统计遗传学中一个至关重要且普遍存在的问题。[@problem_id:2690203]", "problem": "在一个大的随机交配种群中，某单位点有 $G$ 种可区分的基因型，其真实基因型频率为 $\\{f_{g}\\}_{g=1}^{G}$，其中 $\\sum_{g=1}^{G} f_{g} = 1$ 且对所有 $g$ 都有 $f_{g} \\ge 0$。种群基因型杂合度定义为 $H \\equiv 1 - \\sum_{g=1}^{G} f_{g}^{2}$，即两个独立抽取的个体具有不同基因型的概率。从该种群中独立抽取一个大小为 $N \\ge 2$ 的样本，得到计数 $\\{n_{g}\\}_{g=1}^{G}$，其中 $\\sum_{g=1}^{G} n_{g} = N$，经验频率为 $\\hat{f}_{g} \\equiv n_{g}/N$。考虑置换估计量 $\\hat{H} \\equiv 1 - \\sum_{g=1}^{G} \\hat{f}_{g}^{2}$。\n\n请仅从多项式抽样下的期望和独立性定义出发，推导精确偏差 $\\operatorname{Bias}(\\hat{H}) \\equiv \\mathbb{E}[\\hat{H}] - H$，并将其表示为 $N$ 和真实频率 $\\{f_{g}\\}$ 的函数。然后，为有限的 $N$ 构建一个无偏估计量 $\\tilde{H}$，该估计量是观测到的经验频率 $\\{\\hat{f}_{g}\\}$ 和 $N$ 的函数，并从第一性原理出发验证其无偏性。\n\n你的最终答案必须是一个单一的符号表达式，包含一个单行矩阵，其中第一个元素等于偏差，第二个元素等于无偏估计量，并以 $N$、$\\{f_{g}\\}$ 和 $\\{\\hat{f}_{g}\\}$ 表示。最终答案中不应包含任何文字。如果你选择以多种等价形式呈现 $\\tilde{H}$，请给出用 $N$ 和 $\\{\\hat{f}_{g}\\}$ 表示的版本。无需进行数值四舍五入。", "solution": "问题陈述已经过评估并被确定为有效。这是一个在统计群体遗传学中提法恰当、有科学依据的问题，没有歧义或矛盾。我们可以开始求解。\n\n问题要求推导基因型杂合度的置换估计量的偏差，并构建一个相应的无偏估计量。让我们从第一性原理出发。\n\n从基因型频率为 $\\{f_{g}\\}_{g=1}^{G}$ 的种群中有放回地抽取大小为 $N$ 的样本，其样本计数 $\\{n_{g}\\}_{g=1}^{G}$ 服从多项式分布 $(n_1, \\dots, n_G) \\sim \\operatorname{Multinomial}(N; f_1, \\dots, f_G)$。对于任何特定的基因型 $g$，其计数 $n_g$ 服从二项分布 $n_g \\sim \\operatorname{Binomial}(N, f_g)$。因此 $n_g$ 的矩是已知的：\n期望为 $\\mathbb{E}[n_g] = N f_g$。\n方差为 $\\operatorname{Var}(n_g) = N f_g (1 - f_g)$。\n\n方差也定义为 $\\operatorname{Var}(n_g) = \\mathbb{E}[n_g^2] - (\\mathbb{E}[n_g])^2$。由此，我们可以求出 $n_g^2$ 的期望：\n$$ \\mathbb{E}[n_g^2] = \\operatorname{Var}(n_g) + (\\mathbb{E}[n_g])^2 = N f_g (1 - f_g) + (N f_g)^2 = N f_g - N f_g^2 + N^2 f_g^2 $$\n\n杂合度的置换估计量是 $\\hat{H} = 1 - \\sum_{g=1}^{G} \\hat{f}_g^2$，其中 $\\hat{f}_g = n_g/N$。我们计算其期望 $\\mathbb{E}[\\hat{H}]$。\n$$ \\mathbb{E}[\\hat{H}] = \\mathbb{E}\\left[1 - \\sum_{g=1}^{G} \\left(\\frac{n_g}{N}\\right)^2\\right] = 1 - \\frac{1}{N^2} \\mathbb{E}\\left[\\sum_{g=1}^{G} n_g^2\\right] $$\n根据期望的线性性质，上式变为：\n$$ \\mathbb{E}[\\hat{H}] = 1 - \\frac{1}{N^2} \\sum_{g=1}^{G} \\mathbb{E}[n_g^2] $$\n代入上面推导出的 $\\mathbb{E}[n_g^2]$ 的表达式：\n$$ \\sum_{g=1}^{G} \\mathbb{E}[n_g^2] = \\sum_{g=1}^{G} (N f_g - N f_g^2 + N^2 f_g^2) = N \\sum_{g=1}^{G} f_g - N \\sum_{g=1}^{G} f_g^2 + N^2 \\sum_{g=1}^{G} f_g^2 $$\n根据约束条件 $\\sum_{g=1}^{G} f_g = 1$，上式简化为：\n$$ \\sum_{g=1}^{G} \\mathbb{E}[n_g^2] = N(1) - N \\sum_{g=1}^{G} f_g^2 + N^2 \\sum_{g=1}^{G} f_g^2 = N + (N^2 - N) \\sum_{g=1}^{G} f_g^2 $$\n现在，我们将其代回 $\\mathbb{E}[\\hat{H}]$ 的表达式中：\n$$ \\mathbb{E}[\\hat{H}] = 1 - \\frac{1}{N^2} \\left[ N + (N^2 - N) \\sum_{g=1}^{G} f_g^2 \\right] = 1 - \\frac{N}{N^2} - \\frac{N^2 - N}{N^2} \\sum_{g=1}^{G} f_g^2 $$\n$$ \\mathbb{E}[\\hat{H}] = 1 - \\frac{1}{N} - \\frac{N-1}{N} \\sum_{g=1}^{G} f_g^2 $$\n真实杂合度为 $H = 1 - \\sum_{g=1}^{G} f_g^2$，这意味着 $\\sum_{g=1}^{G} f_g^2 = 1 - H$。代入此式：\n$$ \\mathbb{E}[\\hat{H}] = 1 - \\frac{1}{N} - \\frac{N-1}{N} (1 - H) = 1 - \\frac{1}{N} - \\left(\\frac{N-1}{N} - \\frac{N-1}{N}H\\right) $$\n$$ \\mathbb{E}[\\hat{H}] = \\frac{N - 1 - (N-1)}{N} + \\frac{N-1}{N}H = \\frac{N-1-N+1}{N} + \\frac{N-1}{N}H = \\frac{N-1}{N}H $$\n该估计量的期望是 $\\mathbb{E}[\\hat{H}] = \\frac{N-1}{N}H$。\n\n估计量 $\\hat{H}$ 的偏差定义为 $\\operatorname{Bias}(\\hat{H}) = \\mathbb{E}[\\hat{H}] - H$。\n$$ \\operatorname{Bias}(\\hat{H}) = \\frac{N-1}{N}H - H = \\left(\\frac{N-1}{N} - 1\\right)H = -\\frac{1}{N}H $$\n作为 $N$ 和真实频率 $\\{f_g\\}$ 的函数，其偏差为：\n$$ \\operatorname{Bias}(\\hat{H}) = -\\frac{1}{N}\\left(1 - \\sum_{g=1}^{G} f_g^2\\right) $$\n估计量 $\\hat{H}$ 是有偏的，它系统性地低估了真实的杂合度 $H$。\n\n为了构建一个无偏估计量 $\\tilde{H}$，我们必须校正这个偏差。从关系式 $\\mathbb{E}[\\hat{H}] = \\frac{N-1}{N}H$ 可以清楚地看到，我们可以通过对 $\\hat{H}$ 进行缩放来定义一个无偏估计量 $\\tilde{H}$。设\n$$ \\tilde{H} = \\frac{N}{N-1}\\hat{H} $$\n这个新估计量的期望是：\n$$ \\mathbb{E}[\\tilde{H}] = \\mathbb{E}\\left[\\frac{N}{N-1}\\hat{H}\\right] = \\frac{N}{N-1}\\mathbb{E}[\\hat{H}] = \\frac{N}{N-1}\\left(\\frac{N-1}{N}H\\right) = H $$\n因此，$\\tilde{H}$ 是 $H$ 的一个无偏估计量。将其表示为经验频率 $\\{\\hat{f}_g\\}$ 和样本大小 $N$ 的函数，即为：\n$$ \\tilde{H} = \\frac{N}{N-1}\\left(1 - \\sum_{g=1}^{G} \\hat{f}_g^2\\right) $$\n\n最后，我们按照要求从第一性原理出发验证其无偏性。\n$$ \\tilde{H} = \\frac{N}{N-1}\\left(1 - \\sum_{g=1}^{G} \\frac{n_g^2}{N^2}\\right) = \\frac{N}{N-1} - \\frac{N}{N-1} \\frac{1}{N^2} \\sum_{g=1}^{G} n_g^2 = \\frac{N}{N-1} - \\frac{1}{N(N-1)}\\sum_{g=1}^{G} n_g^2 $$\n取期望：\n$$ \\mathbb{E}[\\tilde{H}] = \\frac{N}{N-1} - \\frac{1}{N(N-1)}\\mathbb{E}\\left[\\sum_{g=1}^{G} n_g^2\\right] = \\frac{N}{N-1} - \\frac{1}{N(N-1)}\\sum_{g=1}^{G}\\mathbb{E}[n_g^2] $$\n使用我们之前的结果 $\\sum_{g=1}^{G} \\mathbb{E}[n_g^2] = N + N(N-1) \\sum_{g=1}^{G} f_g^2$：\n$$ \\mathbb{E}[\\tilde{H}] = \\frac{N}{N-1} - \\frac{1}{N(N-1)}\\left[N + N(N-1)\\sum_{g=1}^{G} f_g^2\\right] $$\n$$ \\mathbb{E}[\\tilde{H}] = \\frac{N}{N-1} - \\frac{N}{N(N-1)} - \\frac{N(N-1)}{N(N-1)}\\sum_{g=1}^{G} f_g^2 $$\n$$ \\mathbb{E}[\\tilde{H}] = \\frac{N}{N-1} - \\frac{1}{N-1} - \\sum_{g=1}^{G} f_g^2 = \\frac{N-1}{N-1} - \\sum_{g=1}^{G} f_g^2 $$\n$$ \\mathbb{E}[\\tilde{H}] = 1 - \\sum_{g=1}^{G} f_g^2 = H $$\n验证完成。对于任何有限的样本大小 $N \\ge 2$，估计量 $\\tilde{H}$ 确实是无偏的。", "answer": "$$\\boxed{\\begin{pmatrix} -\\frac{1}{N} \\left(1 - \\sum_{g=1}^{G} f_{g}^{2}\\right)  \\frac{N}{N-1} \\left(1 - \\sum_{g=1}^{G} \\hat{f}_{g}^{2}\\right) \\end{pmatrix}}$$", "id": "2690203"}, {"introduction": "贝叶斯推断为群体遗传学中的参数估计提供了另一种强大的范式。与频率学派方法不同，贝叶斯方法将参数视为随机变量，并结合先验知识与观测数据来更新我们对参数的认知。本练习将使用经典的贝塔-二项共轭模型，推导等位基因频率的后验分布，让你亲身体验如何将先验信念与数据证据相结合，从而得到对参数不确定性的完整描述。[@problem_id:2690200]", "problem": "一个二倍体种群在单个基因座上拥有两个等位基因，分别表示为等位基因 $A$ 和等位基因 $a$。令 $p$ 表示种群中等位基因 $A$ 的（未知）频率。在观察数据之前，您对 $p$ 的先验信念是它服从形状参数为 $\\alpha$ 和 $\\beta$ 的贝塔分布，即 $p \\sim \\mathrm{Beta}(\\alpha,\\beta)$。然后，您从一个非常大的、充分混合的种群中随机抽取 $N$ 个二倍体个体，因此这 $2N$ 个抽样得到的等位基因可以被视为从基因库中的独立抽取。您对所有个体进行基因分型，观察到基因型 $AA$ 的计数为 $n_{AA}$，基因型 $Aa$ 的计数为 $n_{Aa}$，基因型 $aa$ 的计数为 $n_{aa}$。抽样得到的等位基因总数为 $n=2N$，观察到的等位基因 $A$ 的数量为 $k = 2 n_{AA} + n_{Aa}$。\n\n仅从 (i) 连续参数的贝叶斯定理，(ii) 给定 $p$ 和 $n$ 时 $k$ 的二项似然，以及 (iii) 贝塔分布的定义（包括其归一化的贝塔函数）出发，完成以下任务：\n- 推导在给定数据 $(k,n)$ 的情况下 $p$ 的后验密度。\n- 推导后验均值和后验方差关于 $\\alpha$、$\\beta$、$k$ 和 $n$ 的闭式表达式。\n- 将您的结果应用于具体案例：$\\alpha = 3$，$\\beta = 2$，$N = 150$，$n_{AA} = 60$，$n_{Aa} = 70$，$n_{aa} = 20$。计算后验均值和后验方差的数值。将您的答案四舍五入至四位有效数字。将最终答案表示为单个行矩阵，首先是均值，然后是方差。不要使用百分号；所有量都以小数表示。", "solution": "所提出的问题是贝叶斯推断中的一个标准练习，具体涉及使用样本数据估计种群参数——等位基因频率。我们首先验证问题陈述的有效性。\n\n给定条件如下：\n- 参数 $p$ 表示等位基因 $A$ 的频率。\n- $p$ 的先验分布是贝塔分布：$p \\sim \\mathrm{Beta}(\\alpha, \\beta)$。\n- 数据是 $N$ 个二倍体个体的样本。\n- 基因型计数为 $n_{AA}$、$n_{Aa}$ 和 $n_{aa}$。\n- 抽样得到的等位基因总数为 $n = 2N$。\n- 观察到的等位基因 $A$ 的数量为 $k = 2 n_{AA} + n_{Aa}$。\n- 分析必须从以下几点出发：(i) 连续参数的贝叶斯定理，(ii) 给定 $p$ 和 $n$ 时 $k$ 的二项似然，以及 (iii) 贝塔分布的定义。\n- 对于数值应用：$\\alpha = 3$，$\\beta = 2$，$N = 150$，$n_{AA} = 60$，$n_{Aa} = 70$，$n_{aa} = 20$。\n\n该问题具有科学依据，提法明确且客观。它描述了群体遗传学和贝叶斯统计中的一个典型模型。提供的数值数据是一致的，因为个体总数 $n_{AA} + n_{Aa} + n_{aa} = 60 + 70 + 20 = 150 = N$。因此，该问题是有效的。我们继续进行解答。\n\n首先，我们推导 $p$ 的后验密度。根据连续参数的贝叶斯定理，后验概率密度函数（PDF）与似然函数和先验概率密度函数的乘积成正比：\n$$f(p | k, n) \\propto L(p; k, n) \\cdot f(p; \\alpha, \\beta)$$\n其中 $f(p | k, n)$ 是后验概率密度函数，$L(p; k, n)$ 是在给定参数 $p$ 的情况下观察到数据的似然函数，而 $f(p; \\alpha, \\beta)$ 是 $p$ 的先验概率密度函数。\n\n问题陈述中提到，抽样得到的 $n=2N$ 个等位基因是独立抽取的。在总共 $n$ 个等位基因中观察到 $k$ 个 $A$ 型等位基因，而 $A$ 的种群频率为 $p$，这是一个二项过程。因此，似然函数由二项概率质量函数给出：\n$$L(p; k, n) = P(k | p, n) = \\binom{n}{k} p^k (1-p)^{n-k}$$\n\n关于 $p$ 的先验信念由贝塔分布描述，$p \\sim \\mathrm{Beta}(\\alpha, \\beta)$。其概率密度函数为：\n$$f(p; \\alpha, \\beta) = \\frac{p^{\\alpha-1}(1-p)^{\\beta-1}}{B(\\alpha, \\beta)}$$\n其中 $B(\\alpha, \\beta)$ 是贝塔函数，作为归一化常数。\n\n我们将似然函数和先验分布结合起来求后验分布，将任何不含 $p$ 的项都视为比例常数的一部分：\n$$f(p | k, n) \\propto \\left[ \\binom{n}{k} p^k (1-p)^{n-k} \\right] \\cdot \\left[ \\frac{p^{\\alpha-1}(1-p)^{\\beta-1}}{B(\\alpha, \\beta)} \\right]$$\n$$f(p | k, n) \\propto p^k (1-p)^{n-k} \\cdot p^{\\alpha-1}(1-p)^{\\beta-1}$$\n合并 $p$ 和 $(1-p)$ 的幂：\n$$f(p | k, n) \\propto p^{k+\\alpha-1} (1-p)^{n-k+\\beta-1}$$\n这个表达式是贝塔分布的核。我们可以识别出函数形式 $p^{A-1}(1-p)^{B-1}$ 对应于一个 $\\mathrm{Beta}(A,B)$ 分布。通过观察，后验分布的参数是 $\\alpha' = k+\\alpha$ 和 $\\beta' = n-k+\\beta$。\n因此，$p$ 的后验分布是一个贝塔分布：\n$$p | (k,n) \\sim \\mathrm{Beta}(k+\\alpha, n-k+\\beta)$$\n完整的后验概率密度函数是：\n$$f(p | k, n) = \\frac{p^{k+\\alpha-1} (1-p)^{n-k+\\beta-1}}{B(k+\\alpha, n-k+\\beta)}$$\n\n接下来，我们推导后验均值和方差。对于一个一般的贝塔分布 $X \\sim \\mathrm{Beta}(a,b)$，其均值和方差由以下公式给出：\n$$E[X] = \\frac{a}{a+b}$$\n$$\\mathrm{Var}(X) = \\frac{ab}{(a+b)^2 (a+b+1)}$$\n将这些公式应用于我们的后验分布 $\\mathrm{Beta}(\\alpha', \\beta') = \\mathrm{Beta}(k+\\alpha, n-k+\\beta)$，我们得到后验均值 $E[p | k,n]$：\n$$E[p | k,n] = \\frac{k+\\alpha}{(k+\\alpha) + (n-k+\\beta)} = \\frac{k+\\alpha}{n+\\alpha+\\beta}$$\n以及后验方差 $\\mathrm{Var}(p | k,n)$：\n$$\\mathrm{Var}(p | k,n) = \\frac{(k+\\alpha)(n-k+\\beta)}{((k+\\alpha) + (n-k+\\beta))^2 ((k+\\alpha) + (n-k+\\beta) + 1)} = \\frac{(k+\\alpha)(n-k+\\beta)}{(n+\\alpha+\\beta)^2 (n+\\alpha+\\beta+1)}$$\n这些就是所要求的闭式表达式。\n\n最后，我们将这些结果应用于所提供的具体案例。参数如下：\n先验参数：$\\alpha = 3$，$\\beta = 2$。\n样本数据：$N = 150$，$n_{AA} = 60$，$n_{Aa} = 70$，$n_{aa} = 20$。\n\n根据样本数据，我们计算抽样得到的等位基因总数 $n$ 和观察到的等位基因 $A$ 的数量 $k$：\n$$n = 2N = 2(150) = 300$$\n$$k = 2 n_{AA} + n_{Aa} = 2(60) + 70 = 120 + 70 = 190$$\n等位基因 $a$ 的数量是 $n_{Aa} + 2n_{aa} = 70 + 2(20) = 110$。总和为 $190+110=300=n$，结果一致。\n\n现在，我们计算后验均值和方差的数值。\n后验均值为：\n$$E[p | k,n] = \\frac{k+\\alpha}{n+\\alpha+\\beta} = \\frac{190+3}{300+3+2} = \\frac{193}{305} \\approx 0.6327868...$$\n后验方差为：\n$$\\mathrm{Var}(p | k,n) = \\frac{(k+\\alpha)(n-k+\\beta)}{(n+\\alpha+\\beta)^2(n+\\alpha+\\beta+1)} = \\frac{(190+3)(300-190+2)}{(300+3+2)^2(300+3+2+1)}$$\n$$\\mathrm{Var}(p | k,n) = \\frac{(193)(112)}{(305)^2(306)} = \\frac{21616}{93025 \\times 306} = \\frac{21616}{28465650} \\approx 0.00075936...$$\n按照要求将这些结果四舍五入至四位有效数字：\n后验均值 $\\approx 0.6328$\n后验方差 $\\approx 0.0007594$", "answer": "$$\n\\boxed{\\begin{pmatrix} 0.6328  0.0007594 \\end{pmatrix}}\n$$", "id": "2690200"}, {"introduction": "现实世界中的种群往往具有复杂的结构，等位基因频率在不同亚群间存在差异。这个高级练习将单一群体的贝叶斯模型扩展到一个层级框架中，从而能够同时估算局部和全局的等位基因频率。通过这个练习，你将接触到“收缩估计”这一强大概念，并需要通过编程实现数值计算，这真实地反映了现代群体遗传学分析的实践。[@problem_id:2690165]", "problem": "您正在对一个复合种群中的多个亚群体（demes）的单个双等位基因座进行建模。设目标等位基因为等位基因 $A$。在亚群体 $d$ 中，设真实等位基因频率为 $\\theta_d \\in (0,1)$，观测到的等位基因计数为 $x_d$，样本大小为 $n_d$ 个基因拷贝（假设为单倍体计数，或将二倍体计数汇总为基因拷贝计数），因此 $x_d \\in \\{0,1,\\dots,n_d\\}$。在给定各亚群体特定频率的情况下，跨亚群体的数据是条件独立的。在亚群体之间，由于种群结构和遗传漂变，假定等位基因频率围绕一个全局均值变化。\n\n仅从核心定义出发，构建一个包含以下要素的分层模型：\n\n- 每个亚群体的局部抽样模型：在给定 $\\theta_d$ 的条件下，观测计数 $x_d$ 服从参数为 $n_d$ 和 $\\theta_d$ 的二项分布。\n- 亚群体间变异：在给定全局平均等位基因频率 $p$ 和集中参数 $\\kappa  0$ 的条件下，每个 $\\theta_d$ 均独立地从一个由均值 $p$ 和集中参数 $\\kappa$ 参数化的 Beta 分布中抽取，即 $\\theta_d \\sim \\mathrm{Beta}(\\kappa p,\\kappa(1-p))$。\n- 全局先验：全局平均等位基因频率 $p$ 具有一个超参数为 $\\alpha_0  0$ 和 $\\beta_0  0$ 的 Beta 先验，即 $p \\sim \\mathrm{Beta}(\\alpha_0,\\beta_0)$。\n\n您的任务是：\n\n1. 根据上述模型设定以及二项分布和 Beta 分布的核心定义，通过对 $\\theta_d$ 进行积分，推导出在给定 $p$ 和 $\\kappa$ 的情况下 $x_d$ 的边际似然。然后，推导出在给定所有观测计数 $\\{(x_d,n_d)\\}_{d=1}^D$ 的情况下 $p$ 的联合后验密度，结果可以忽略比例常数。除了二项分布、Beta 分布和 Beta 函数的定义外，不要假定任何快捷公式。\n2. 推导出在给定 $(p,x_d,n_d,\\kappa)$ 的情况下每个 $\\theta_d$ 的条件后验的闭式表达式，然后用 $\\mathbb{E}[p \\mid \\{(x_j,n_j)\\}_{j=1}^D,\\alpha_0,\\beta_0,\\kappa]$ 来表示后验均值 $\\mathbb{E}[\\theta_d \\mid \\{(x_j,n_j)\\}_{j=1}^D,\\alpha_0,\\beta_0,\\kappa]$ 的公式。\n3. 实现一个程序，为下面的每个测试用例计算以下输出：\n   - $p$ 的后验均值，即 $\\mathbb{E}[p \\mid \\{(x_d,n_d)\\}_{d=1}^D,\\alpha_0,\\beta_0,\\kappa]$，该值通过对解析推导出的 $p$ 的未归一化后验密度在 $p \\in (0,1)$ 上进行数值积分获得。\n   - 使用您在任务2中推导的结果计算每个 $\\theta_d$ 的后验均值。\n\n数值要求和限制：\n\n- 您对 $\\mathbb{E}[p \\mid \\cdot]$ 的数值计算必须基于对解析推导出的 $p$ 的未归一化后验密度在 $p \\in (0,1)$ 上进行的一维数值积分。您可以使用任何稳定的变量替换或缩放来确保数值稳定性，但不要使用诸如马尔可夫链蒙特卡洛 (MCMC)之类的黑箱采样方法。您可以使用对数形式的 Beta 函数的特殊函数来确保稳定性。\n- 所有输出必须四舍五入到恰好 $6$ 位小数。\n- 所有输出必须是没有任何单位的纯数字，并且必须表示为小数（不含百分号）。\n- 最终输出格式必须是单行，包含一个由各测试用例列表组成的列表。对于每个测试用例，输出一个列表，其第一个元素是 $p$ 的后验均值，后续元素是与输入亚群体顺序相同的各 $\\theta_d$ 值的后验均值。外层列表必须按下面提供的顺序包含这些用例列表。整行不得包含任何空白字符。例如，一个有效的格式是 $[[0.500000,0.500000,0.500000],[0.600000,0.590000,0.610000]]$。\n\n您可以使用的基础定义：\n\n- 二项概率质量函数的定义：对于 $x \\in \\{0,1,\\dots,n\\}$，$n \\in \\mathbb{N}$，$\\theta \\in (0,1)$，$\\Pr(X=x \\mid n,\\theta) = \\binom{n}{x} \\theta^x (1-\\theta)^{n-x}$。\n- Beta 密度函数的定义：对于 $a0$，$b0$，$f(\\theta \\mid a,b) = \\dfrac{\\theta^{a-1} (1-\\theta)^{b-1}}{B(a,b)}$ 在 $\\theta \\in (0,1)$ 上，其中 $B(a,b) = \\dfrac{\\Gamma(a)\\Gamma(b)}{\\Gamma(a+b)}$ 是 Beta 函数。\n- 上述指定的独立性假设。\n- 积分和期望的基本性质。\n\n测试套件：\n\n为以下五个测试用例提供输出。每个测试用例由元组 $(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n})$ 指定，其中 $\\mathbf{x}$ 和 $\\mathbf{n}$ 是跨亚群体的对齐列表。\n\n- 测试用例 1：$(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n}) = (\\,\\,$$2$$,$$2$$,$$20$$,\\, [$$12$$,$$15$$,$$8$$],\\, [$$20$$,$$20$$,$$20$$]\\,)$。\n- 测试用例 2：$(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n}) = (\\,\\,$$1$$,$$4$$,$$10$$,\\, [$$0$$,$$1$$,$$0$$],\\, [$$20$$,$$20$$,$$20$$]\\,)$。\n- 测试用例 3：$(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n}) = (\\,\\,$$4$$,$$1$$,$$10$$,\\, [$$20$$,$$19$$,$$20$$],\\, [$$20$$,$$20$$,$$20$$]\\,)$。\n- 测试用例 4：$(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n}) = (\\,\\,$$2$$,$$2$$,$$50$$,\\, [$$5$$,$$30$$,$$1$$,$$18$$],\\, [$$10$$,$$50$$,$$2$$,$$20$$]\\,)$。\n- 测试用例 5：$(\\alpha_0,\\beta_0,\\kappa,\\mathbf{x},\\mathbf{n}) = (\\,\\,$$2$$,$$2$$,$$5$$,\\, [$$1$$],\\, [$$1$$]\\,)$。\n\n您的程序应生成单行输出，其中包含一个无空格、逗号分隔的列表的列表形式的结果，顺序与测试套件的顺序完全一致。对于测试用例 $d$，内层列表必须是 $[$ $p$ 的后验均值, $\\theta_1$ 的后验均值, $\\theta_2$ 的后验均值, $\\dots$, $\\theta_D$ 的后验均值 $]$，每个值都四舍五入到 $6$ 位小数。", "solution": "所提出的问题在科学上是合理的，在数学上是明确定义的，并包含了获得唯一解所需的所有信息。这是贝叶斯分层建模在群体遗传学中应用的一个标准问题。该问题是有效的。我们着手进行推导和求解。\n\n分层模型规定如下：\n1.  **似然**：对于每个亚群体 $d \\in \\{1, \\dots, D\\}$，在给定真实亚群体特异性等位基因频率 $\\theta_d$ 的情况下，观测到的等位基因计数 $x_d$ 服从二项分布。\n    $$P(x_d \\mid n_d, \\theta_d) = \\binom{n_d}{x_d} \\theta_d^{x_d} (1-\\theta_d)^{n_d-x_d}$$\n2.  **亚群体水平先验**：亚群体特异性等位基因频率 $\\theta_d$ 从一个共同的 Beta 分布中抽取，该分布以全局平均频率 $p$ 和集中参数 $\\kappa$ 为条件。该 Beta 分布由均值 $p$ 和集中参数 $\\kappa$ 参数化，对应于形状参数 $a = \\kappa p$ 和 $b = \\kappa(1-p)$。\n    $$P(\\theta_d \\mid p, \\kappa) = \\frac{\\theta_d^{\\kappa p-1} (1-\\theta_d)^{\\kappa(1-p)-1}}{B(\\kappa p, \\kappa(1-p))}$$\n    其中 $B(a,b) = \\frac{\\Gamma(a)\\Gamma(b)}{\\Gamma(a+b)}$ 是 Beta 函数。\n3.  **全局超先验**：全局平均等位基因频率 $p$ 服从一个超参数为 $\\alpha_0$ 和 $\\beta_0$ 的 Beta 分布。\n    $$P(p \\mid \\alpha_0, \\beta_0) = \\frac{p^{\\alpha_0-1} (1-p)^{\\beta_0-1}}{B(\\alpha_0, \\beta_0)}$$\n\n给定条件是，跨亚群体的数据 $\\{(x_d, n_d)\\}_{d=1}^D$ 在给定其各自频率 $\\theta_d$ 的情况下是条件独立的，并且频率 $\\theta_d$ 在给定 $p$ 和 $\\kappa$ 的情况下是条件独立的。\n\n### 第1部分：$p$ 的边际似然和联合后验\n\n首先，我们通过对未知的局部频率 $\\theta_d$ 进行积分，来推导单个亚群体 $d$ 中观测计数 $x_d$ 的边际似然。这是在给定全局参数 $p$ 和 $\\kappa$ 的情况下观测到 $x_d$ 的概率。\n$$P(x_d \\mid n_d, p, \\kappa) = \\int_0^1 P(x_d \\mid n_d, \\theta_d) P(\\theta_d \\mid p, \\kappa) \\, d\\theta_d$$\n代入二项概率质量函数和 Beta 概率密度函数：\n$$P(x_d \\mid n_d, p, \\kappa) = \\int_0^1 \\left[ \\binom{n_d}{x_d} \\theta_d^{x_d} (1-\\theta_d)^{n_d-x_d} \\right] \\left[ \\frac{\\theta_d^{\\kappa p - 1} (1-\\theta_d)^{\\kappa(1-p) - 1}}{B(\\kappa p, \\kappa(1-p))} \\right] \\, d\\theta_d$$\n我们将不依赖于 $\\theta_d$ 的项移到积分之外：\n$$P(x_d \\mid n_d, p, \\kappa) = \\frac{\\binom{n_d}{x_d}}{B(\\kappa p, \\kappa(1-p))} \\int_0^1 \\theta_d^{x_d + \\kappa p - 1} (1-\\theta_d)^{n_d - x_d + \\kappa(1-p) - 1} \\, d\\theta_d$$\n该积分具有 Beta 函数的形式。具体来说，$\\int_0^1 t^{a-1}(1-t)^{b-1} dt = B(a,b)$。在我们的例子中，等价的参数是 $a = x_d + \\kappa p$ 和 $b = n_d - x_d + \\kappa(1-p)$。因此，该积分的值为 $B(x_d + \\kappa p, n_d - x_d + \\kappa(1-p))$。\n得到的边际似然是 Beta-二项分布的概率质量函数：\n$$P(x_d \\mid n_d, p, \\kappa) = \\binom{n_d}{x_d} \\frac{B(x_d + \\kappa p, n_d - x_d + \\kappa(1-p))}{B(\\kappa p, \\kappa(1-p))}$$\n接下来，我们推导在给定所有观测数据和固定超参数的情况下，全局平均频率 $p$ 的联合后验密度。令 $\\mathbf{x} = \\{x_1, \\dots, x_D\\}$ 且 $\\mathbf{n} = \\{n_1, \\dots, n_D\\}$。\n根据贝叶斯定理，$p$ 的后验与给定 $p$ 的数据似然和 $p$ 的先验的乘积成正比：\n$$P(p \\mid \\mathbf{x}, \\mathbf{n}, \\alpha_0, \\beta_0, \\kappa) \\propto P(\\mathbf{x} \\mid \\mathbf{n}, p, \\kappa) P(p \\mid \\alpha_0, \\beta_0)$$\n由于在给定 $p$ 和 $\\kappa$ 的情况下，跨亚群体的观测是条件独立的，联合似然是每个亚群体边际似然的乘积：\n$$P(\\mathbf{x} \\mid \\mathbf{n}, p, \\kappa) = \\prod_{d=1}^D P(x_d \\mid n_d, p, \\kappa)$$\n结合这些， $p$ 的后验密度为：\n$$P(p \\mid \\cdot) \\propto \\left[ \\prod_{d=1}^D P(x_d \\mid n_d, p, \\kappa) \\right] P(p \\mid \\alpha_0, \\beta_0)$$\n代入推导出的表达式：\n$$P(p \\mid \\cdot) \\propto \\left[ \\prod_{d=1}^D \\binom{n_d}{x_d} \\frac{B(x_d + \\kappa p, n_d - x_d + \\kappa(1-p))}{B(\\kappa p, \\kappa(1-p))} \\right] \\left[ \\frac{p^{\\alpha_0-1} (1-p)^{\\beta_0-1}}{B(\\alpha_0, \\beta_0)} \\right]$$\n对于未归一化的后验密度，我们可以省略所有不依赖于 $p$ 的项。这些项包括二项式系数 $\\binom{n_d}{x_d}$ 和先验归一化常数 $B(\\alpha_0, \\beta_0)$。\n因此，$p$ 的未归一化后验密度是：\n$$f(p) \\propto p^{\\alpha_0-1} (1-p)^{\\beta_0-1} \\prod_{d=1}^D \\frac{B(x_d + \\kappa p, n_d - x_d + \\kappa(1-p))}{B(\\kappa p, \\kappa(1-p))}$$\n\n### 第2部分：$\\theta_d$ 的条件后验及其均值\n\n首先，我们求出在给定全局参数 $p$ 及其局部数据 $(x_d, n_d)$ 的情况下，单个亚群体频率 $\\theta_d$ 的条件后验分布。\n$$P(\\theta_d \\mid p, x_d, n_d, \\kappa) \\propto P(x_d \\mid n_d, \\theta_d) P(\\theta_d \\mid p, \\kappa)$$\n这种关系成立是因为，在给定 $p$ 和 $\\kappa$ 的情况下，$\\theta_d$ 与来自其他亚群体的数据无关。代入似然和先验：\n$$P(\\theta_d \\mid \\cdot) \\propto \\left[ \\theta_d^{x_d} (1-\\theta_d)^{n_d-x_d} \\right] \\left[ \\theta_d^{\\kappa p - 1} (1-\\theta_d)^{\\kappa(1-p) - 1} \\right]$$\n合并指数：\n$$P(\\theta_d \\mid \\cdot) \\propto \\theta_d^{x_d + \\kappa p - 1} (1-\\theta_d)^{n_d - x_d + \\kappa(1-p) - 1}$$\n这是一个 Beta 分布的核，是 Beta 先验和二项似然之间共轭性的结果。条件后验分布是：\n$$\\theta_d \\mid p, x_d, n_d, \\kappa \\sim \\mathrm{Beta}(x_d + \\kappa p, n_d - x_d + \\kappa(1-p))$$\n接下来，我们推导 $\\theta_d$ 的后验均值，这需要对 $p$ 的不确定性进行边际化处理。令 $\\mathcal{D} = \\{(\\mathbf{x}, \\mathbf{n}), \\alpha_0, \\beta_0, \\kappa\\}$。我们使用全期望定律：\n$$\\mathbb{E}[\\theta_d \\mid \\mathcal{D}] = \\mathbb{E}_{p \\mid \\mathcal{D}} \\left[ \\mathbb{E}[\\theta_d \\mid p, \\mathcal{D}] \\right]$$\n内部期望是条件后验分布 $\\mathrm{Beta}(\\alpha, \\beta)$ 的均值，即 $\\alpha/(\\alpha+\\beta)$。\n$$\\mathbb{E}[\\theta_d \\mid p, \\mathcal{D}] = \\mathbb{E}[\\theta_d \\mid p, x_d, n_d, \\kappa] = \\frac{x_d + \\kappa p}{(x_d + \\kappa p) + (n_d - x_d + \\kappa(1-p))} = \\frac{x_d + \\kappa p}{n_d + \\kappa}$$\n将此代回外部期望：\n$$\\mathbb{E}[\\theta_d \\mid \\mathcal{D}] = \\mathbb{E}_{p \\mid \\mathcal{D}} \\left[ \\frac{x_d + \\kappa p}{n_d + \\kappa} \\right]$$\n根据期望的线性性质，我们可以写出：\n$$\\mathbb{E}[\\theta_d \\mid \\mathcal{D}] = \\frac{1}{n_d + \\kappa} \\mathbb{E}_{p \\mid \\mathcal{D}}[x_d + \\kappa p] = \\frac{x_d + \\kappa \\, \\mathbb{E}[p \\mid \\mathcal{D}]}{n_d + \\kappa}$$\n这个简洁的公式表明，$\\theta_d$ 的后验均值是局部经验频率 $\\frac{x_d}{n_d}$ 和后验全局平均频率 $\\mathbb{E}[p \\mid \\mathcal{D}]$ 的加权平均值。参数 $\\kappa$ 控制了这种向全局均值“收缩”的强度。\n\n### 第3部分：数值实现\n\n后验 $P(p \\mid \\mathcal{D})$ 的解析形式很复杂，不属于任何标准分布族。因此，其后验均值 $\\mathbb{E}[p \\mid \\mathcal{D}]$ 必须通过数值方法计算。\n$$\\mathbb{E}[p \\mid \\mathcal{D}] = \\frac{\\int_0^1 p \\cdot f(p) \\, dp}{\\int_0^1 f(p) \\, dp}$$\n其中 $f(p)$ 是在第1部分中推导的未归一化后验密度。为避免 Beta 函数乘积导致的数值下溢/上溢问题，计算在对数空间中进行。未归一化的后验核的对数是：\n$$\\log f(p) = (\\alpha_0-1)\\log p + (\\beta_0-1)\\log(1-p) + \\sum_{d=1}^D \\left[ \\log B(x_d + \\kappa p, n_d - x_d + \\kappa(1-p)) - \\log B(\\kappa p, \\kappa(1-p)) \\right]$$\n这可以使用 `gammaln` 函数（对数-gamma 函数）高效计算。为了在积分过程中保持数值稳定性，被积函数通过其最大值进行归一化。这可以通过数值优化找到 $p$ 的后验众数，计算对数后验最大值 $L_{\\max}$，然后计算 $\\exp(\\log f(p) - L_{\\max})$ 和 $p \\cdot \\exp(\\log f(p) - L_{\\max})$ 的积分来实现。这两个积分的比值即为 $\\mathbb{E}[p \\mid \\mathcal{D}]$。一旦求得此值，便可使用第2部分推导的收缩公式计算后验均值 $\\mathbb{E}[\\theta_d \\mid \\mathcal{D}]$。", "answer": "[[0.584165,0.592083,0.667083,0.492083],[0.088665,0.065775,0.082442,0.065775],[0.941916,0.980639,0.947305,0.980639],[0.612089,0.595074,0.609407,0.518407,0.803374],[0.690553,0.825461]]", "id": "2690165"}]}