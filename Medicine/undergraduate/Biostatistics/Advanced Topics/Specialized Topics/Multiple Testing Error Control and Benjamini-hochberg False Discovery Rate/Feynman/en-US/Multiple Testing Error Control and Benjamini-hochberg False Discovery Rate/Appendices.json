{
    "hands_on_practices": [
        {
            "introduction": "To truly master the control of the false discovery rate (FDR), we must move from theory to practice. This first exercise  provides a foundational hands-on calculation, guiding you through the transformation of raw $p$-values into their corresponding $q$-values. By working through this process, you will gain a concrete understanding of how the Benjamini-Hochberg (BH) procedure operates and see how a $q$-value represents the minimum FDR at which a test result can be deemed significant.",
            "id": "4930965",
            "problem": "A biostatistician analyzes gene-wise associations in a cohort study and obtains a family of $m=15$ independent hypothesis tests with ordered $p$-values $p_{(1)} \\leq p_{(2)} \\leq \\dots \\leq p_{(15)}$ given by\n$$\np_{(1)}=0.0008,\\quad p_{(2)}=0.003,\\quad p_{(3)}=0.0065,\\quad p_{(4)}=0.012,\\quad p_{(5)}=0.018,\n$$\n$$\np_{(6)}=0.021,\\quad p_{(7)}=0.044,\\quad p_{(8)}=0.051,\\quad p_{(9)}=0.062,\\quad p_{(10)}=0.078,\n$$\n$$\np_{(11)}=0.13,\\quad p_{(12)}=0.21,\\quad p_{(13)}=0.27,\\quad p_{(14)}=0.38,\\quad p_{(15)}=0.49.\n$$\nStarting from the core definition that a $q$-value for a test is the minimal false discovery rate (FDR) level at which that test would be included in the rejection set under the Benjamini-Hochberg (BH) procedure, compute the vector of $q$-values associated with these ordered $p$-values. Then, using the computed $q$-values, select the discoveries at target $q$-value level $q^{\\star}=0.09$, and explain, from first principles, why this selection is equivalent to applying the BH procedure once at level $q^{\\star}$.\n\nReport, as your final answer, the total number of discoveries at level $q^{\\star}=0.09$. No rounding is required, and the final answer must be a single real-valued number.",
            "solution": "The problem is subjected to validation and is deemed valid as it is scientifically grounded in the established biostatistical theory of multiple comparison correction, is well-posed with all necessary data provided, and is stated in objective, formal language.\n\nThe problem requires the computation of $q$-values for a given set of $p$-values and the determination of the number of significant discoveries at a specified false discovery rate (FDR) level. It also requires an explanation of the equivalence between using pre-computed $q$-values and applying the Benjamini-Hochberg (BH) procedure directly.\n\nLet $m$ be the total number of independent hypothesis tests. We are given $m=15$.\nLet the ordered $p$-values from these tests be $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(m)}$. The given values are:\n$p_{(1)}=0.0008$, $p_{(2)}=0.003$, $p_{(3)}=0.0065$, $p_{(4)}=0.012$, $p_{(5)}=0.018$, $p_{(6)}=0.021$, $p_{(7)}=0.044$, $p_{(8)}=0.051$, $p_{(9)}=0.062$, $p_{(10)}=0.078$, $p_{(11)}=0.13$, $p_{(12)}=0.21$, $p_{(13)}=0.27$, $p_{(14)}=0.38$, $p_{(15)}=0.49$.\n\nThe BH procedure to control the FDR at a level $\\alpha$ is as follows: Find the largest integer $k \\in \\{1, \\dots, m\\}$ such that $p_{(k)} \\le \\frac{k}{m}\\alpha$. If such a $k$ exists, reject the null hypotheses corresponding to $p_{(1)}, p_{(2)}, \\dots, p_{(k)}$.\n\nThe problem defines the $q$-value for a test as the minimal FDR level at which that test would be declared significant. For the $i$-th ordered test, its $q$-value, denoted $q_{(i)}$, is the smallest $\\alpha$ for which the test is rejected. Following the BH procedure, the test corresponding to $p_{(i)}$ is rejected if there exists some index $j \\ge i$ such that $p_{(j)} \\le \\frac{j}{m}\\alpha$. This is equivalent to $\\alpha \\ge \\frac{m \\cdot p_{(j)}}{j}$. To find the minimum $\\alpha$ that allows rejection of the $i$-th test, we must find the minimum of these thresholds for all possible rejection sets that include the $i$-th test. This leads to the definition of the BH-adjusted $p$-value, which is the $q$-value in this context:\n$$q_{(i)} = \\min_{j=i, \\dots, m} \\left( \\frac{m \\cdot p_{(j)}}{j} \\right)$$\nThis definition ensures that the resulting $q$-values are monotonically non-decreasing, i.e., $q_{(1)} \\le q_{(2)} \\le \\dots \\le q_{(m)}$.\n\nFirst, we compute the intermediate values $v_i = \\frac{m \\cdot p_{(i)}}{i}$ for $i=1, \\dots, 15$.\n$v_1 = \\frac{15}{1}(0.0008) = 0.012$\n$v_2 = \\frac{15}{2}(0.003) = 0.0225$\n$v_3 = \\frac{15}{3}(0.0065) = 0.0325$\n$v_4 = \\frac{15}{4}(0.012) = 0.045$\n$v_5 = \\frac{15}{5}(0.018) = 0.054$\n$v_6 = \\frac{15}{6}(0.021) = 0.0525$\n$v_7 = \\frac{15}{7}(0.044) = \\frac{0.66}{7} \\approx 0.094286$\n$v_8 = \\frac{15}{8}(0.051) = 0.095625$\n$v_9 = \\frac{15}{9}(0.062) = \\frac{0.93}{9} \\approx 0.103333$\n$v_{10} = \\frac{15}{10}(0.078) = 0.117$\n$v_{11} = \\frac{15}{11}(0.13) = \\frac{1.95}{11} \\approx 0.177273$\n$v_{12} = \\frac{15}{12}(0.21) = 0.2625$\n$v_{13} = \\frac{15}{13}(0.27) = \\frac{4.05}{13} \\approx 0.311538$\n$v_{14} = \\frac{15}{14}(0.38) = \\frac{5.7}{14} \\approx 0.407143$\n$v_{15} = \\frac{15}{15}(0.49) = 0.49$\n\nNext, we compute the $q$-values by taking the cumulative minimum from right to left (from $i=m$ down to $1$): $q_{(i)} = \\min(v_i, q_{(i+1)})$, with $q_{(m)} = v_m$.\n$q_{(15)} = v_{15} = 0.49$\n$q_{(14)} = \\min(v_{14}, q_{(15)}) = \\min(0.4071..., 0.49) = 0.4071... = \\frac{57}{140}$\n$q_{(13)} = \\min(v_{13}, q_{(14)}) = \\min(0.3115..., 0.4071...) = 0.3115... = \\frac{81}{260}$\n$q_{(12)} = \\min(v_{12}, q_{(13)}) = \\min(0.2625, 0.3115...) = 0.2625$\n$q_{(11)} = \\min(v_{11}, q_{(12)}) = \\min(0.1772..., 0.2625) = 0.1772... = \\frac{39}{220}$\n$q_{(10)} = \\min(v_{10}, q_{(11)}) = \\min(0.117, 0.1772...) = 0.117$\n$q_{(9)} = \\min(v_9, q_{(10)}) = \\min(0.1033..., 0.117) = 0.1033... = \\frac{31}{300}$\n$q_{(8)} = \\min(v_8, q_{(9)}) = \\min(0.095625, 0.1033...) = 0.095625$\n$q_{(7)} = \\min(v_7, q_{(8)}) = \\min(0.0942..., 0.095625) = 0.0942... = \\frac{33}{350}$\n$q_{(6)} = \\min(v_6, q_{(7)}) = \\min(0.0525, 0.0942...) = 0.0525$\n$q_{(5)} = \\min(v_5, q_{(6)}) = \\min(0.054, 0.0525) = 0.0525$\n$q_{(4)} = \\min(v_4, q_{(5)}) = \\min(0.045, 0.0525) = 0.045$\n$q_{(3)} = \\min(v_3, q_{(4)}) = \\min(0.0325, 0.045) = 0.0325$\n$q_{(2)} = \\min(v_2, q_{(3)}) = \\min(0.0225, 0.0325) = 0.0225$\n$q_{(1)} = \\min(v_1, q_{(2)}) = \\min(0.012, 0.0225) = 0.012$\n\nThe resulting vector of $q$-values is:\n$q_{(1)}=0.012$, $q_{(2)}=0.0225$, $q_{(3)}=0.0325$, $q_{(4)}=0.045$, $q_{(5)}=0.0525$, $q_{(6)}=0.0525$, $q_{(7)} \\approx 0.0943$, $q_{(8)}=0.095625$, $q_{(9)} \\approx 0.1033$, $q_{(10)}=0.117$, $q_{(11)} \\approx 0.1773$, $q_{(12)}=0.2625$, $q_{(13)} \\approx 0.3115$, $q_{(14)} \\approx 0.4071$, $q_{(15)}=0.49$.\n\nTo select discoveries at the target level $q^{\\star}=0.09$, we reject all hypotheses for which $q_{(i)} \\le q^{\\star}$.\n$q_{(1)} = 0.012 \\le 0.09$ (Reject)\n$q_{(2)} = 0.0225 \\le 0.09$ (Reject)\n$q_{(3)} = 0.0325 \\le 0.09$ (Reject)\n$q_{(4)} = 0.045 \\le 0.09$ (Reject)\n$q_{(5)} = 0.0525 \\le 0.09$ (Reject)\n$q_{(6)} = 0.0525 \\le 0.09$ (Reject)\n$q_{(7)} \\approx 0.0943 > 0.09$ (Do not reject)\nSince the $q$-values are non-decreasing, all subsequent tests from $i=7$ to $i=15$ will also not be rejected. The total number of discoveries is $6$.\n\nNext, we explain why this is equivalent to applying the BH procedure at level $\\alpha = q^{\\star}=0.09$.\nApplying the BH procedure directly, we seek the largest $k$ such that $p_{(k)} \\le \\frac{k}{m}q^{\\star} = \\frac{k}{15}(0.09) = 0.006k$.\nFor $k=1: p_{(1)}=0.0008 \\le 0.006(1)=0.006$ (True)\nFor $k=2: p_{(2)}=0.003 \\le 0.006(2)=0.012$ (True)\nFor $k=3: p_{(3)}=0.0065 \\le 0.006(3)=0.018$ (True)\nFor $k=4: p_{(4)}=0.012 \\le 0.006(4)=0.024$ (True)\nFor $k=5: p_{(5)}=0.018 \\le 0.006(5)=0.030$ (True)\nFor $k=6: p_{(6)}=0.021 \\le 0.006(6)=0.036$ (True)\nFor $k=7: p_{(7)}=0.044 > 0.006(7)=0.042$ (False)\nThe largest $k$ satisfying the condition is $k=6$. The BH procedure rejects the first $6$ hypotheses, which matches the result from the $q$-value method.\n\nThe formal explanation for this equivalence is as follows.\nLet $q^{\\star}$ be the desired FDR level.\nMethod 1 (q-value rule): Reject all hypotheses $H_{(i)}$ for which $q_{(i)} \\le q^{\\star}$. Let $k_q = \\max\\{i: q_{(i)} \\le q^{\\star}\\}$. Since $q_{(i)}$ is non-decreasing, the rejected set is $\\{H_{(1)}, \\dots, H_{(k_q)}\\}$.\nMethod 2 (BH procedure): Find $k_{BH} = \\max\\{i: p_{(i)} \\le \\frac{i}{m}q^{\\star}\\}$. The rejected set is $\\{H_{(1)}, \\dots, H_{(k_{BH})}\\}$.\nWe must show that $k_q = k_{BH}$.\n\nFirst, let's show $q_{(k_{BH})} \\le q^{\\star}$. By definition of $k_{BH}$, we have $p_{(k_{BH})} \\le \\frac{k_{BH}}{m}q^{\\star}$, which implies $\\frac{m \\cdot p_{(k_{BH})}}{k_{BH}} \\le q^{\\star}$.\nThe $q$-value is $q_{(k_{BH})} = \\min_{j=k_{BH}, \\dots, m} \\left(\\frac{m \\cdot p_{(j)}}{j}\\right)$.\nSince one of the terms in the minimization (the one for $j=k_{BH}$) is less than or equal to $q^{\\star}$, the minimum itself must be less than or equal to $q^{\\star}$. Thus, $q_{(k_{BH})} \\le q^{\\star}$.\nBy the $q$-value rule, hypothesis $H_{(k_{BH})}$ is rejected. As the $q$-values are non-decreasing, all $H_{(i)}$ for $i \\le k_{BH}$ are also rejected. This implies $k_q \\ge k_{BH}$.\n\nNext, let's examine $q_{(k_{BH}+1)}$. By the definition of $k_{BH}$ as the maximum index, for any $j > k_{BH}$, we must have $p_{(j)} > \\frac{j}{m}q^{\\star}$, which is equivalent to $\\frac{m \\cdot p_{(j)}}{j} > q^{\\star}$.\nThe $q$-value is $q_{(k_{BH}+1)} = \\min_{j=k_{BH}+1, \\dots, m} \\left(\\frac{m \\cdot p_{(j)}}{j}\\right)$.\nSince every term in this minimization is strictly greater than $q^{\\star}$, the minimum itself must be strictly greater than $q^{\\star}$. So, $q_{(k_{BH}+1)} > q^{\\star}$.\nBy the $q$-value rule, hypothesis $H_{(k_{BH}+1)}$ is not rejected. This implies that the largest index of a rejected hypothesis is $k_{BH}$, so $k_q \\le k_{BH}$.\n\nCombining $k_q \\ge k_{BH}$ and $k_q \\le k_{BH}$, we conclude that $k_q = k_{BH}$. The two procedures are therefore equivalent. The number of discoveries is $6$.",
            "answer": "$$\\boxed{6}$$"
        },
        {
            "introduction": "The standard BH procedure is powerful, but its guarantee of FDR control relies on assumptions about the tests being independent or having a specific type of positive dependence. This practice  introduces a crucial alternative, the Benjamini-Yekutieli (BY) procedure, which controls the FDR under any dependency structure. By directly comparing the number of discoveries from both methods on the same hypothetical dataset, you will develop an intuition for the concept of statistical conservativeness and learn to appreciate the trade-offs involved when assumptions about your data change.",
            "id": "4930944",
            "problem": "A biostatistician is analyzing differential expression across $m = 12$ genes from an RNA sequencing experiment. For each gene, a hypothesis test for no differential expression is performed, yielding the following unsorted $p$-values:\n$$\n0.02,\\ 0.12,\\ 0.006,\\ 0.0008,\\ 0.08,\\ 0.2,\\ 0.04,\\ 0.025,\\ 0.012,\\ 0.002,\\ 0.06,\\ 0.0045.\n$$\nAssume that the tests may be arbitrarily dependent. The biostatistician wishes to control the False Discovery Rate (FDR) at level $q = 0.05$ and considers two standard step-up procedures: the Benjamini-Hochberg (BH) procedure and the Benjamini-Yekutieli (BY) procedure. Starting from the core definition that the FDR is the expected proportion of false discoveries among all discoveries, and using the standard step-up framework that orders the $p$-values and compares them to increasing critical values, determine the following:\n\n1. For the Benjamini-Yekutieli procedure, compute the rejection cutoff (i.e., identify the largest rank $k$ for which the corresponding ordered $p$-value is declared significant, and report the associated BY critical value at that rank).\n\n2. For the Benjamini-Hochberg procedure, compute the number of rejections.\n\n3. Quantify the relative conservativeness of BY compared to BH as the ratio of the number of rejections under BY to the number of rejections under BH.\n\nExpress the final measure of relative conservativeness as a decimal rounded to four significant figures. No percentage signs are permitted.",
            "solution": "The posed problem is subjected to a rigorous validation process before any attempt at a solution.\n\n### Step 1: Extract Givens\nThe explicit data and conditions provided in the problem statement are:\n- Total number of hypothesis tests (genes): $m = 12$.\n- Unsorted $p$-values: $\\{0.02, 0.12, 0.006, 0.0008, 0.08, 0.2, 0.04, 0.025, 0.012, 0.002, 0.06, 0.0045\\}$.\n- Desired False Discovery Rate (FDR) control level: $q = 0.05$.\n- Assumed dependence structure of the tests: Arbitrarily dependent.\n- Procedures to be used: Benjamini-Hochberg (BH) and Benjamini-Yekutieli (BY).\n- Task 1: For the BY procedure, find the rejection cutoff, specified as the largest rank $k$ of a significant test and the corresponding critical value.\n- Task 2: For the BH procedure, find the number of rejections.\n- Task 3: Calculate the ratio of the number of rejections under BY to the number of rejections under BH, rounded to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientific Grounding**: The problem is well-grounded in the established statistical theory of multiple hypothesis testing. The False Discovery Rate, the Benjamini-Hochberg procedure, and the Benjamini-Yekutieli procedure are cornerstone concepts in modern biostatistics, particularly in the analysis of high-throughput data like RNA sequencing. The distinction between BH (for independence/positive dependency) and BY (for arbitrary dependency) is a critical and standard topic. The problem is a direct application of these principles.\n- **Well-Posedness**: The problem is clearly stated and provides all necessary information for a unique solution. The set of $p$-values, the total number of tests $m$, and the desired FDR level $q$ are all specified. The three tasks are unambiguous computational exercises based on the provided data and standard algorithms.\n- **Objectivity**: The problem is framed in objective, quantitative language. It refers to standard statistical procedures without subjective interpretation.\n\n### Step 3: Verdict and Action\nThe problem is scientifically sound, self-contained, and well-posed. There are no contradictions, ambiguities, or factual errors. Therefore, the problem is **valid**, and a solution will be furnished.\n\nThe solution requires the application of two standard step-up procedures for controlling the False Discovery Rate. Both procedures begin by ordering the $m$ p-values from smallest to largest, denoted $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(m)}$.\n\nFirst, we sort the provided $p$-values:\n$p_{(1)} = 0.0008$\n$p_{(2)} = 0.002$\n$p_{(3)} = 0.0045$\n$p_{(4)} = 0.006$\n$p_{(5)} = 0.012$\n$p_{(6)} = 0.02$\n$p_{(7)} = 0.025$\n$p_{(8)} = 0.04$\n$p_{(9)} = 0.06$\n$p_{(10)} = 0.08$\n$p_{(11)} = 0.12$\n$p_{(12)} = 0.2$\n\nThe total number of tests is $m=12$ and the desired FDR level is $q=0.05$.\n\n**Task 1: Benjamini-Yekutieli (BY) Procedure**\n\nThe BY procedure is designed to control the FDR under any form of dependence among the test statistics. It modifies the BH procedure by introducing a correction factor, $c(m)$, which is the $m$-th harmonic number. The procedure is to find the largest integer $k$, from $1$ to $m$, such that:\n$$\np_{(k)} \\le \\frac{k}{m \\cdot c(m)}q\n$$\nFor $m=12$, the correction factor $c(12)$ is the $12$-th harmonic number, $H_{12}$:\n$$\nc(12) = \\sum_{i=1}^{12} \\frac{1}{i} = 1 + \\frac{1}{2} + \\frac{1}{3} + \\dots + \\frac{1}{12} = \\frac{86021}{27720} \\approx 3.10321\n$$\nThe critical value for the $i$-th ordered $p$-value is $\\alpha_{BY,(i)} = \\frac{i}{12 \\cdot c(12)} (0.05)$. We seek the largest $k$ such that $p_{(k)} \\le \\alpha_{BY,(k)}$.\n\nLet's compare each $p_{(i)}$ with its corresponding critical value $\\alpha_{BY,(i)}$:\n- For $i=1$: $p_{(1)} = 0.0008$. The critical value is $\\alpha_{BY,(1)} = \\frac{1}{12 \\cdot c(12)}(0.05) \\approx \\frac{0.05}{37.2385} \\approx 0.00134$. Since $0.0008 \\le 0.00134$, the condition holds.\n- For $i=2$: $p_{(2)} = 0.002$. The critical value is $\\alpha_{BY,(2)} = \\frac{2}{12 \\cdot c(12)}(0.05) \\approx 2 \\cdot 0.00134 = 0.00268$. Since $0.002 \\le 0.00268$, the condition holds.\n- For $i=3$: $p_{(3)} = 0.0045$. The critical value is $\\alpha_{BY,(3)} = \\frac{3}{12 \\cdot c(12)}(0.05) \\approx 3 \\cdot 0.00134 = 0.00402$. Since $0.0045 > 0.00402$, the condition fails.\n\nThe largest rank for which the condition $p_{(k)} \\le \\alpha_{BY,(k)}$ holds is $k_{BY} = 2$. Following the step-up procedure, hypotheses with ranks $i=1, \\dots, k_{BY}$ are rejected. Thus, $2$ hypotheses are rejected. The rejection cutoff, as requested, is the critical value at this largest rank $k_{BY}=2$:\n$$\n\\alpha_{BY,(2)} = \\frac{2 \\cdot q}{m \\cdot c(m)} = \\frac{2 \\cdot (0.05)}{12 \\cdot \\frac{86021}{27720}} = \\frac{0.1 \\cdot 27720}{12 \\cdot 86021} = \\frac{2772}{1032252} \\approx 0.0026854\n$$\nThe number of rejections under the BY procedure is $N_{BY} = 2$.\n\n**Task 2: Benjamini-Hochberg (BH) Procedure**\n\nThe BH procedure, which controls FDR under independence or positive regression dependence, does not use the $c(m)$ correction factor. The procedure is to find the largest integer $k$, from $1$ to $m$, such that:\n$$\np_{(k)} \\le \\frac{k}{m}q\n$$\nThe critical value for the $i$-th ordered $p$-value is $\\alpha_{BH,(i)} = \\frac{i}{12}(0.05)$. We seek the largest $k$ such that $p_{(k)} \\le \\alpha_{BH,(k)}$.\n\nLet's compare each $p_{(i)}$ with its corresponding critical value $\\alpha_{BH,(i)}$:\n- For $i=1$: $p_{(1)} = 0.0008 \\le \\frac{1}{12}(0.05) \\approx 0.00417$. Condition holds.\n- For $i=2$: $p_{(2)} = 0.002 \\le \\frac{2}{12}(0.05) \\approx 0.00833$. Condition holds.\n- For $i=3$: $p_{(3)} = 0.0045 \\le \\frac{3}{12}(0.05) = 0.0125$. Condition holds.\n- For $i=4$: $p_{(4)} = 0.006 \\le \\frac{4}{12}(0.05) \\approx 0.01667$. Condition holds.\n- For $i=5$: $p_{(5)} = 0.012 \\le \\frac{5}{12}(0.05) \\approx 0.02083$. Condition holds.\n- For $i=6$: $p_{(6)} = 0.02 \\le \\frac{6}{12}(0.05) = 0.025$. Condition holds.\n- For $i=7$: $p_{(7)} = 0.025 \\le \\frac{7}{12}(0.05) \\approx 0.02917$. Condition holds.\n- For $i=8$: $p_{(8)} = 0.04 > \\frac{8}{12}(0.05) \\approx 0.03333$. Condition fails.\n\nThe largest rank for which the condition holds is $k_{BH} = 7$. According to the BH procedure, all null hypotheses $H_{(i)}$ for $i=1, \\dots, k_{BH}$ are rejected.\nThe number of rejections under the BH procedure is $N_{BH} = 7$.\n\n**Task 3: Relative Conservativeness**\n\nThe relative conservativeness is quantified by the ratio of the number of rejections under the BY procedure to the number of rejections under the BH procedure.\n$$\n\\text{Ratio} = \\frac{N_{BY}}{N_{BH}} = \\frac{2}{7}\n$$\nConverting this fraction to a decimal gives approximately $0.28571428...$. Rounding to four significant figures as required by the problem statement, we obtain $0.2857$. This ratio being less than $1$ confirms the expected higher conservativeness of the BY procedure, which rejects fewer hypotheses due to its stricter control for arbitrary dependence.",
            "answer": "$$\n\\boxed{0.2857}\n$$"
        },
        {
            "introduction": "Scientific discovery rarely involves a simple, flat list of hypotheses. More often, questions are structured hierarchically, such as analyzing individual genes nested within biological pathways. This final coding exercise  simulates this common scenario, challenging you to implement a hierarchical testing strategy that applies the BH logic at multiple levels. This not only solidifies your understanding of the core algorithm but also demonstrates how to adapt it to complex, realistic experimental designs while maintaining statistical rigor.",
            "id": "4930969",
            "problem": "You are given a two-level multiple testing problem that reflects pathway-level and gene-level hypotheses, which is common in biostatistics. At the top level, there are $m$ pathway hypotheses with pathway-level $p$-values $\\{p^{(P)}_1,\\dots,p^{(P)}_m\\}$. Within each pathway $j \\in \\{1,\\dots,m\\}$, there is a family of gene-level $p$-values $\\{p^{(G)}_{j1},\\dots,p^{(G)}_{j n_j}\\}$. The goal is to perform hierarchical multiple testing using the Benjamini-Hochberg (BH) procedure to control the False Discovery Rate (FDR) at both the pathway and gene levels, using a principled adjustment for the second stage that accounts for data-dependent selection.\n\nBase definitions and rules:\n- The False Discovery Rate (FDR) is defined as $\\mathrm{FDR} = \\mathbb{E}\\left[\\frac{V}{\\max(R,1)}\\right]$, where $R$ is the number of rejections and $V$ is the number of false rejections.\n- The Benjamini-Hochberg (BH) step-up rule at nominal level $q \\in (0,1)$ for $n$ hypotheses with $p$-values $p_{(1)} \\le \\dots \\le p_{(n)}$ selects the largest $k \\in \\{0,1,\\dots,n\\}$ such that $p_{(k)} \\le \\frac{q k}{n}$ (with the convention $p_{(0)}=0$). It rejects all hypotheses with $p_i \\le p_{(k)}$. When $k=0$, no hypothesis is rejected.\n- To preserve valid false discovery rate guarantees under data-dependent selection of families, apply the Benjamini-Bogomolov (BB) adjustment: after selecting $R$ families at level $q_1$ at the top level, apply BH within each selected family at the adjusted level $q_2^\\star = q_2 \\cdot \\frac{R}{m}$, where $q_1$ is the pathway-level nominal level and $q_2$ is the target within-family nominal level.\n\nYour program must implement the following hierarchical procedure from first principles:\n1. Apply the BH step-up rule at the pathway level at nominal level $q_1$ to the $m$ pathway $p$-values $\\{p^{(P)}_1,\\dots,p^{(P)}_m\\}$. Let $S \\subseteq \\{1,\\dots,m\\}$ be the set of selected pathway indices, and let $R = |S|$. Define the pathway BH cutoff $t_P$ as $p^{(P)}_{(k)}$ where $k$ is the BH index; when $R=0$, set $t_P=0$.\n2. If $R>0$, compute the adjusted within-family level $q_2^\\star = q_2 \\cdot \\frac{R}{m}$. For each selected pathway $j \\in S$, apply the BH step-up rule at level $q_2^\\star$ to its gene-level $p$-values $\\{p^{(G)}_{j1},\\dots,p^{(G)}_{j n_j}\\}$. Let $r_j$ be the number of rejected genes in pathway $j$, and let $t^{(G)}_j$ be the gene-level BH cutoff in pathway $j$ (set $t^{(G)}_j=0$ if $r_j=0$). For any unselected pathway $j \\notin S$, do not perform any gene-level testing.\n3. All comparisons in the BH rule are inclusive; that is, $p \\le \\frac{q k}{n}$ is a rejection. In the presence of ties equal to the cutoff, reject all hypotheses with $p \\le t$.\n\nOutput specification:\n- For each test case, output a list composed of:\n  - The integer number of rejected pathways $R$.\n  - The pathway-level BH cutoff $t_P$ as a float.\n  - The adjusted within-family level $q_2^\\star$ as a float.\n  - A list of integers giving $[r_j]_{j \\in S}$ in ascending order of pathway index.\n  - A list of floats giving $[t^{(G)}_j]_{j \\in S}$ in the same order.\n- All floats must be rounded to $6$ decimal places.\n- Your program should produce a single line of output containing the results for all provided test cases as a comma-separated list of per-case results, enclosed in square brackets, with no extra whitespace. For example: \"[[case1_result],[case2_result],...]\".\n\nTest suite:\nProvide code that solves the following three test cases exactly as specified. All $p$-values are decimals in $(0,1)$.\n\n- Test case A (happy path):\n  - $m=5$, pathway $p$-values $[0.20,0.012,0.18,0.031,0.40]$, families of genes:\n    - Pathway $1$: $[0.010,0.200,0.300]$\n    - Pathway $2$: $[0.002,0.015,0.70,0.50]$\n    - Pathway $3$: $[0.040,0.060]$\n    - Pathway $4$: $[0.005,0.010,0.020,0.200]$\n    - Pathway $5$: $[]$\n  - Use $q_1 = 0.1$ and $q_2 = 0.05$.\n- Test case B (boundary case, no selected pathways):\n  - $m=4$, pathway $p$-values $[0.20,0.21,0.50,0.07]$, families of genes:\n    - Pathway $1$: $[0.90]$\n    - Pathway $2$: $[0.60,0.70]$\n    - Pathway $3$: $[0.80,0.90,0.95]$\n    - Pathway $4$: $[0.30,0.40]$\n  - Use $q_1 = 0.05$ and $q_2 = 0.10$.\n- Test case C (all selected; equality at threshold within families):\n  - $m=3$, pathway $p$-values $[0.02,0.10,0.18]$, families of genes:\n    - Pathway $1$: $[0.02,0.005,0.20,0.016,0.010]$\n    - Pathway $2$: $[0.08,0.01,0.02,0.05]$\n    - Pathway $3$: $[0.081,0.08,0.07]$\n  - Use $q_1 = 0.2$ and $q_2 = 0.08$.\n\nImportant implementation details:\n- Implement the Benjamini-Hochberg step-up rule directly from its definition for any input list of $p$-values and any nominal level $q \\in [0,1]$.\n- When a family has zero hypotheses, define its number of rejections as $0$ and its cutoff as $0$.\n- Round all floating-point outputs to $6$ decimal places.\n- Your program must not read any input; it should embed the test suite internally and print only the single required output line in the exact format described.",
            "solution": "The user-provided problem has been rigorously validated and is determined to be **valid**. It is scientifically sound, well-posed, and contains all necessary information and definitions to construct a unique, verifiable solution. The problem asks for the implementation of a hierarchical multiple testing procedure based on the Benjamini-Hochberg (BH) method, a standard and well-established technique in biostatistics for controlling the False Discovery Rate (FDR).\n\nThe solution proceeds by first implementing the core Benjamini-Hochberg procedure from its fundamental definition, and then applying it within the specified hierarchical structure which involves a Benjamini-Bogomolov (BB) adjustment for the second-stage testing level.\n\n### 1. The Benjamini-Hochberg (BH) Step-Up Procedure\n\nThe BH procedure is a method to control the FDR when performing multiple simultaneous hypothesis tests. For a family of $n$ hypotheses with corresponding p-values $\\{p_1, p_2, \\dots, p_n\\}$, and a desired nominal FDR level $q \\in (0,1)$, the procedure is as follows:\n\n1.  Order the $p$-values from smallest to largest: $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(n)}$.\n2.  Find the largest integer index $k$, where $1 \\le k \\le n$, such that the $k$-th ordered $p$-value, $p_{(k)}$, satisfies the condition:\n    $$ p_{(k)} \\le \\frac{k \\cdot q}{n} $$\n3.  If such a $k$ exists, a significance cutoff $t$ is defined as $t=p_{(k)}$. All original hypotheses $H_i$ for which the corresponding p-value $p_i \\le t$ are rejected. Note that due to ties, the number of rejected hypotheses may be greater than $k$.\n4.  If no such $k$ exists (i.e., $p_{(i)} > \\frac{i \\cdot q}{n}$ for all $i=1, \\dots, n$), then no hypotheses are rejected, and the cutoff $t$ is defined as $0$. The number of rejections is $0$.\n\nAn algorithm, `bh_procedure(p_values, q)`, will be implemented based on these steps. It will take a list of p-values and a nominal level $q$ as input, and will return the total number of rejections and the calculated cutoff $t$.\n\n### 2. Hierarchical Testing Procedure\n\nThe problem specifies a two-level testing structure: pathways at the top level and genes within pathways at the second level. The BH procedure is applied hierarchically.\n\n**Step 2.1: Pathway-Level Analysis**\nFirst, we address the $m$ pathway-level hypotheses. Let their p-values be $\\{p^{(P)}_1, \\dots, p^{(P)}_m\\}$ and the desired pathway-level FDR be $q_1$. We apply the `bh_procedure`:\n- `(R, t_P) = bh_procedure({p^{(P)}_1, ..., p^{(P)}_m}, q_1)`\nHere, $R$ is the number of rejected pathway hypotheses, and $t_P$ is the significance cutoff at the pathway level. The set of selected pathways is $S = \\{j \\mid p^{(P)}_j \\le t_P\\}$.\n\n**Step 2.2: Gene-Level Analysis with Adjustment**\nIf $R=0$, no pathways are selected, and no further testing is performed. The number of rejected genes is $0$ for all pathways.\n\nIf $R>0$, we proceed to test the gene-level hypotheses, but only for the pathways in the selected set $S$. A crucial aspect of this hierarchical procedure is adjusting the significance level for this second stage of testing. The problem specifies the Benjamini-Bogomolov (BB) adjustment, which preserves FDR control under this data-dependent selection. The adjusted nominal level for the within-family tests, $q_2^\\star$, is calculated as:\n$$ q_2^\\star = q_2 \\cdot \\frac{R}{m} $$\nwhere $q_2$ is the target within-family nominal level.\n\nFor each selected pathway $j \\in S$, we apply the `bh_procedure` to its family of $n_j$ gene-level p-values, $\\{p^{(G)}_{j1}, \\dots, p^{(G)}_{jn_j}\\}$, using the adjusted level $q_2^\\star$:\n- `(r_j, t_j^{(G)}) = bh_procedure({p^{(G)}_{j1}, ..., p^{(G)}_{jn_j}}, q_2^\\star)`\nHere, $r_j$ is the number of rejected genes in pathway $j$, and $t_j^{(G)}$ is the gene-level cutoff for that pathway. For any unselected pathway $j \\notin S$, all gene-level results are trivial (zero rejections).\n\n### 3. Output Generation\n\nFor each test case, the program will calculate and assemble the following results into a list:\n1.  The number of rejected pathways, $R$ (integer).\n2.  The pathway-level BH cutoff, $t_P$ (float).\n3.  The adjusted within-family nominal level, $q_2^\\star$ (float).\n4.  A list of the number of rejected genes, $[r_j]_{j \\in S}$, for each selected pathway, ordered by the pathway index $j$.\n5.  A list of the gene-level cutoffs, $[t^{(G)}_j]_{j \\in S}$, for each selected pathway, in the same order.\n\nAll floating-point numbers in the final output will be rounded to $6$ decimal places as specified. The results from all test cases are then formatted into a single line of text according to the problem's strict output specification.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that defines test cases and prints the final\n    formatted result.\n    \"\"\"\n\n    def bh_procedure(p_values, q):\n        \"\"\"\n        Implements the Benjamini-Hochberg (BH) step-up procedure.\n\n        Args:\n            p_values (list or np.ndarray): A list of p-values.\n            q (float): The nominal False Discovery Rate (FDR) level.\n\n        Returns:\n            tuple: A tuple containing:\n                - int: The number of rejected hypotheses.\n                - float: The p-value cutoff.\n        \"\"\"\n        p_values_np = np.array(p_values)\n        n = len(p_values_np)\n        if n == 0:\n            return 0, 0.0\n\n        sorted_p = np.sort(p_values_np)\n        \n        # Calculate BH thresholds for each ordered p-value\n        thresholds = (np.arange(1, n + 1) * q) / n\n\n        # Find all p-values that are less than or equal to their corresponding BH threshold\n        significant_indices = np.where(sorted_p <= thresholds)[0]\n        \n        if len(significant_indices) == 0:\n            return 0, 0.0\n            \n        # The cutoff is the p-value corresponding to the largest index k that satisfies the condition\n        k_index = significant_indices[-1]\n        cutoff = sorted_p[k_index]\n        \n        # The number of rejections is the count of original p-values less than or equal to the cutoff\n        num_rejections = np.sum(p_values_np <= cutoff)\n        \n        return int(num_rejections), float(cutoff)\n\n    def run_hierarchical_bh(m, p_pathway, p_genes, q1, q2):\n        \"\"\"\n        Performs the hierarchical BH procedure for a single test case.\n\n        Args:\n            m (int): Number of pathways.\n            p_pathway (list): List of pathway-level p-values.\n            p_genes (list of lists): List of lists of gene-level p-values.\n            q1 (float): Nominal FDR for the pathway level.\n            q2 (float): Target nominal FDR for the gene level.\n\n        Returns:\n            list: A list containing the results in the specified format.\n        \"\"\"\n        # Step 1: Pathway-level analysis\n        R, t_P = bh_procedure(p_pathway, q1)\n\n        r_j_list = []\n        t_G_j_list = []\n        q2_star = 0.0\n\n        # Step 2: Gene-level analysis\n        if R > 0:\n            # BB adjustment\n            q2_star = q2 * R / m\n            \n            # Identify indices of selected pathways\n            selected_indices = [i + 1 for i, p in enumerate(p_pathway) if p <= t_P]\n            selected_indices.sort() # Ensure ascending order of pathway index\n            \n            for j in selected_indices:\n                # p_genes is 0-indexed, pathway indices j are 1-indexed\n                current_p_genes = p_genes[j - 1]\n                r_j, t_G_j = bh_procedure(current_p_genes, q2_star)\n                r_j_list.append(r_j)\n                t_G_j_list.append(t_G_j)\n        \n        return [R, t_P, q2_star, r_j_list, t_G_j_list]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case A\n        {\n            \"m\": 5, \"p_pathway\": [0.20, 0.012, 0.18, 0.031, 0.40],\n            \"p_genes\": [\n                [0.010, 0.200, 0.300],\n                [0.002, 0.015, 0.70, 0.50],\n                [0.040, 0.060],\n                [0.005, 0.010, 0.020, 0.200],\n                []\n            ],\n            \"q1\": 0.1, \"q2\": 0.05\n        },\n        # Test case B\n        {\n            \"m\": 4, \"p_pathway\": [0.20, 0.21, 0.50, 0.07],\n            \"p_genes\": [\n                [0.90],\n                [0.60, 0.70],\n                [0.80, 0.90, 0.95],\n                [0.30, 0.40]\n            ],\n            \"q1\": 0.05, \"q2\": 0.10\n        },\n        # Test case C\n        {\n            \"m\": 3, \"p_pathway\": [0.02, 0.10, 0.18],\n            \"p_genes\": [\n                [0.02, 0.005, 0.20, 0.016, 0.010],\n                [0.08, 0.01, 0.02, 0.05],\n                [0.081, 0.08, 0.07]\n            ],\n            \"q1\": 0.2, \"q2\": 0.08\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_hierarchical_bh(\n            case[\"m\"], case[\"p_pathway\"], case[\"p_genes\"], case[\"q1\"], case[\"q2\"]\n        )\n        results.append(result)\n\n    def format_single_result(res):\n        \"\"\"Formats a single case result into the required string format.\"\"\"\n        R, t_P, q2_star, r_j_list, t_G_j_list = res\n        \n        t_P_str = f\"{t_P:.6f}\"\n        q2_star_str = f\"{q2_star:.6f}\"\n        \n        r_j_list_str = f\"[{','.join(map(str, r_j_list))}]\"\n        \n        t_G_j_list_str = f\"[{','.join([f'{t:.6f}' for t in t_G_j_list])}]\"\n\n        return f\"[{R},{t_P_str},{q2_star_str},{r_j_list_str},{t_G_j_list_str}]\"\n\n    # Final print statement in the exact required format.\n    final_output_str = f\"[{','.join(format_single_result(r) for r in results)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}