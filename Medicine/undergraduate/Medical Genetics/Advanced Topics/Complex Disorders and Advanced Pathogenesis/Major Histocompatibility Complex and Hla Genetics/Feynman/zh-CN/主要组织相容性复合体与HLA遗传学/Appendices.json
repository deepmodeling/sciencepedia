{
    "hands_on_practices": [
        {
            "introduction": "HLA单倍型在家族中的传递是器官和干细胞移植成功的遗传基础。本练习将孟德尔遗传定律与MHC区域内的重组概念相结合，要求您从第一性原理推导同胞间HLA完全匹配的概率()。通过这个计算实践，您将掌握将核心遗传学原理应用于临床预测的关键技能。",
            "id": "5055655",
            "problem": "一对夫妇正在就其同胞在经典基因座 $HLA\\text{-}A$、$HLA\\text{-}B$ 和 $HLA\\text{-}DRB1$ 上的人类白细胞抗原（Human Leukocyte Antigen, HLA）匹配情况接受评估。这些基因座位于6号染色体上的主要组织相容性复合体（Major Histocompatibility Complex, MHC）内。每位亲本都携带两个在这些分型基因座上定义的不同HLA单倍型：父亲拥有单倍型 $H_1$ 和 $H_2$，母亲拥有单倍型 $H_3$ 和 $H_4$，且在这几个分型基因座上，$H_1$、$H_2$、$H_3$ 和 $H_4$ 彼此之间均不相同。\n\n使用以下基本原则：\n- 孟德尔分离定律：每个子女独立地从父亲和母亲那里各继承一个单倍型，从每位亲本处继承每个单倍型的概率均为 $1/2$。该原则被重组模型进一步细化。\n- 减数分裂重组：将这三个分型基因座视为一个单一的单倍型块，每次减数分裂的总重组率为 $r$，因此，一个配子是非重组的概率为 $(1-r)$，是重组的概率为 $r$。假设不同受孕过程以及父母双方的减数分裂是相互独立的。\n- 高多态性和基因座密度：假设如果在这个单倍型块内发生重组，所产生的重组单倍型与亲本的非重组单倍型不同，并且两次独立的重组事件在所有分型基因座上产生相同重组单倍型的概率可以忽略不计。\n\n在这些假设下，从第一性原理出发，推导出两个独立受孕的全同胞在 $HLA\\text{-}A$、$HLA\\text{-}B$ 和 $HLA\\text{-}DRB1$ 上完全HLA相同的概率。然后，使用 $r = 0.02$ 计算该概率的数值，并将最终结果表示为小数。将您的答案四舍五入到四位有效数字。",
            "solution": "用户希望我解决一个医学遗传学问题。\n\n这是我的计划：\n1.  **验证问题陈述。**\n    *   **第1步：提取已知条件：**我将列出问题中提供的所有信息。\n        *   亲本：父亲和母亲。\n        *   基因座：位于6号染色体上的 $HLA\\text{-}A$、$HLA\\text{-}B$ 和 $HLA\\text{-}DRB1$。\n        *   父亲的单倍型：$H_1$ 和 $H_2$。它们是不同的。\n        *   母亲的单倍型：$H_3$ 和 $H_4$。它们是不同的。\n        *   所有四个亲本单倍型（$H_1, H_2, H_3, H_4$）彼此都不同。\n        *   孟德尔分离定律：子女从每位亲本处继承一个单倍型，每个单倍型的概率为 $1/2$。该原则被重组模型进一步细化。\n        *   减数分裂重组：三个基因座被视为一个单一的单倍型块。\n        *   重组率：每次减数分裂为 $r$。\n        *   非重组配子的概率：$1-r$。\n        *   重组配子的概率：$r$。\n        *   不同受孕过程和父母双方的减数分裂是独立的。\n        *   关于重组的假设：如果发生重组，产生的单倍型与亲本的非重组单倍型不同。两次独立的重组产生相同重组单倍型的概率可以忽略不计。\n        *   目标：推导两个全同胞在这三个基因座上完全HLA相同的概率。\n        *   数值：当 $r = 0.02$ 时计算此概率。\n        *   最终格式：四舍五入到四位有效数字的小数。\n\n    *   **第2步：使用提取的已知条件进行验证：**\n        *   **有科学依据吗？** 是的。该问题基于孟德尔遗传学的基本原理，包括分离定律、独立分配定律（在父母之间）和减数分裂重组。HLA遗传学的背景对于此类问题是恰当且常见的。指定的基因座是临床HLA分型中的标准基因座。\n        *   **问题定义明确吗？** 是的。所有必要的参数（$r$、亲本单倍型）和简化假设（重组体的唯一性、独立的减数分裂）都已提供。目标陈述清晰。存在唯一的概率解。\n        *   **客观吗？** 是的。语言正式而精确，是典型的科学问题陈述。没有主观性。\n        *   **无效性检查清单：**\n            1.  **科学或事实不健全：** 无。该模型是遗传继承的一个标准（尽管简化了）的表示。\n            2.  **不可形式化或不相关：** 无。该问题可直接使用概率论进行形式化，并与医学遗传学相关。\n            3.  **设置不完整或矛盾：** 无。该问题是自洽且内部一致的。\n            4.  **不切实际或不可行：** 无。$r=0.02$ 的值对于MHC区域来说是一个合理的重组频率。这些假设对于入门遗传学问题是标准的。\n            5.  **定义不当或结构不良：** 无。问题是明确的。\n            6.  **伪深刻、琐碎或同义反复：** 无。该问题需要在非平凡的背景下（即包括重组）仔细应用概率规则。\n            7.  **超出科学可验证性范围：** 无。结果在给定的数学模型内是可验证的。\n\n    *   **第3步：结论与行动：** 问题被判定为**有效**。我将继续进行完整解答。\n\n2.  **解决问题。**\n    问题要求计算两个独立受孕的全同胞完全HLA相同的概率。这意味着他们必须拥有相同的HLA单倍型对。\n\n    设父亲的基因型表示为单倍型对 $(H_1, H_2)$，母亲的基因型表示为 $(H_3, H_4)$。问题陈述，$H_1, H_2, H_3, H_4$ 均不相同。\n\n    子女的基因型通过从父亲和母亲各继承一个单倍型而形成。每位亲本的配子形成过程都会发生减数分裂重组，重组率为 $r$。\n\n    首先，让我们确定单个亲本（例如，基因型为 $(H_1, H_2)$ 的父亲）产生的不同类型配子的概率。根据问题陈述，一个配子是非重组的概率为 $(1-r)$，是重组的概率为 $r$。在该亲本的大量配子库中，单倍型 $H_1$ 和 $H_2$ 预计以相等的比例存在。因此，一个配子含有非重组单倍型 $H_1$ 的概率为 $\\frac{1-r}{2}$，含有非重组单倍型 $H_2$ 的概率为 $\\frac{1-r}{2}$。剩余的概率 $r$ 对应于重组单倍型的形成。我们将来自父亲的重组单倍型表示为 $R_F$。\n\n    所以，对于一个子女，从父亲那里继承特定单倍型的概率是：\n    -   $P(\\text{继承 } H_1) = \\frac{1-r}{2}$\n    -   $P(\\text{继承 } H_2) = \\frac{1-r}{2}$\n    -   $P(\\text{继承任意重组单倍型 } R_F) = r$\n\n    同样地，对于基因型为 $(H_3, H_4)$ 的母亲，概率为：\n    -   $P(\\text{继承 } H_3) = \\frac{1-r}{2}$\n    -   $P(\\text{继承 } H_4) = \\frac{1-r}{2}$\n    -   $P(\\text{继承任意重组单倍型 } R_M) = r$\n\n    设同胞1 ($S_1$) 和同胞2 ($S_2$) 是两个独立受孕的子女。设他们的基因型分别为 $G_1 = (H_{p1}, H_{m1})$ 和 $G_2 = (H_{p2}, H_{m2})$，其中 $H_{pi}$ 是同胞 $i \\in \\{1, 2\\}$ 从父亲处继承的单倍型，$H_{mi}$ 是从母亲处继承的单倍型。\n\n    如果两个同胞的基因型相同，即 $G_1 = G_2$，那么他们就是完全HLA相同的。由于所有亲本单倍型（$H_1, H_2, H_3, H_4$）都不同，并且重组单倍型被假设为唯一的且不同于亲本单倍型，因此父源单倍型永远不可能与母源单倍型相同。因此，要使基因型相同，同胞们必须从父亲那里继承了相同的单倍型，并且从母亲那里也继承了相同的单倍型。也就是说，当且仅当 $H_{p1} = H_{p2}$ 且 $H_{m1} = H_{m2}$ 时，$G_1=G_2$。\n\n    从父亲和母亲处的继承是独立事件。因此，同胞相同的概率是：\n    $P(G_1 = G_2) = P(H_{p1} = H_{p2} \\text{ and } H_{m1} = H_{m2})$\n    $P(G_1 = G_2) = P(H_{p1} = H_{p2}) \\times P(H_{m1} = H_{m2})$\n\n    让我们计算两个同胞都从父亲那里继承相同单倍型的概率，即 $P(H_{p1} = H_{p2})$。这种情况可能发生在两个同胞都继承 $H_1$ 时，或都继承 $H_2$ 时，或都继承*相同*的重组单倍型时。\n    -   两个同胞都继承 $H_1$ 的概率是 $P(H_{p1}=H_1) \\times P(H_{p2}=H_1) = \\left(\\frac{1-r}{2}\\right) \\times \\left(\\frac{1-r}{2}\\right) = \\frac{(1-r)^2}{4}$。\n    -   两个同胞都继承 $H_2$ 的概率是 $P(H_{p1}=H_2) \\times P(H_{p2}=H_2) = \\left(\\frac{1-r}{2}\\right) \\times \\left(\\frac{1-r}{2}\\right) = \\frac{(1-r)^2}{4}$。\n    -   两个同胞都继承重组单倍型的概率是 $P(H_{p1} \\text{ 是重组的且 } H_{p2} \\text{ 是重组的}) = r \\times r = r^2$。然而，问题明确指出，“两次独立的重组事件在所有分型基因座上产生相同重组单倍型的概率可以忽略不计。” 这意味着即使两个同胞都继承了重组单倍型，这两个单倍型相同的概率也为 $0$。因此，这种情况对同胞相同没有贡献。\n\n    从父亲那里继承相同单倍型的总概率是继承 $H_1$ 或 $H_2$ 这两个互斥事件的概率之和：\n    $P(H_{p1} = H_{p2}) = \\frac{(1-r)^2}{4} + \\frac{(1-r)^2}{4} = 2 \\times \\frac{(1-r)^2}{4} = \\frac{(1-r)^2}{2}$。\n\n    母亲的继承过程是相同的。因此，两个同胞都从母亲那里继承相同单倍型的概率也是：\n    $P(H_{m1} = H_{m2}) = \\frac{(1-r)^2}{2}$。\n\n    现在，我们可以计算出两个同胞完全HLA相同的总概率：\n    $P(\\text{相同}) = P(H_{p1} = H_{p2}) \\times P(H_{m1} = H_{m2}) = \\left(\\frac{(1-r)^2}{2}\\right) \\times \\left(\\frac{(1-r)^2}{2}\\right) = \\frac{(1-r)^4}{4}$。\n\n    这是从第一性原理推导出的通用公式。作为检验，在没有重组（$r=0$）的情况下，概率变为 $\\frac{(1-0)^4}{4} = \\frac{1}{4}$，这是完全匹配同胞的经典孟德尔概率。\n\n    现在，我们必须计算 $r = 0.02$ 时的数值。\n    $P(\\text{相同}) = \\frac{(1 - 0.02)^4}{4} = \\frac{(0.98)^4}{4}$。\n    让我们计算这个值：\n    $(0.98)^2 = 0.9604$。\n    $(0.98)^4 = (0.9604)^2 = 0.92236816$。\n    $P(\\text{相同}) = \\frac{0.92236816}{4} = 0.23059204$。\n\n    问题要求答案四舍五入到四位有效数字。前四位有效数字是 $2$、$3$、$0$、$5$。第五位有效数字是 $9$，大于或等于 $5$，所以我们将最后一位有效数字向上取整。\n    $0.23059204 \\approx 0.2306$。",
            "answer": "$$\n\\boxed{0.2306}\n$$"
        },
        {
            "introduction": "准确的HLA分型是临床决策的核心，但不同的技术可能产生看似矛盾的结果。本练习提供了一份真实的临床案例，其中血清学和分子分型结果存在差异，要求您运用分子生物学和免疫遗传学的基本原理来解释这些差异()。这项实践旨在培养您解读复杂实验室数据、识别血清学分型局限性（如空等位基因）的诊断思维能力。",
            "id": "5055675",
            "problem": "一个实验室通过对主要组织相容性复合体 (MHC) 中的人类白细胞抗原 (HLA) 基因进行两种独立的检测来评估器官移植候选人。第一种是使用补体依赖性细胞毒性 (CDC) 的血清学分型，该方法利用抗原特异性抗血清检测细胞表面的蛋白质表位。第二种是通过聚合酶链式反应 (PCR) 基于序列的分型 (SBT) 进行的分子分型，该方法读取编码区的脱氧核糖核酸 (DNA) 序列以推断等位基因。\n\n使用以下基本事实：\n- 根据分子生物学中心法则，DNA 转录为核糖核酸 (RNA) 并翻译成蛋白质，蛋白质在细胞表面的表达需要一个功能性的开放阅读框。\n- 经典的 I 类 HLA 基因座（HLA-A、HLA-B、HLA-C）和 II 类 HLA 基因座（例如，HLA-DRB1、HLA-DQB1）是共显性表达的，因此在没有功能丧失性等位基因的情况下，两个亲代等位基因都存在于细胞表面。\n- 血清学分型检测蛋白质上共享的表位（抗原特异性）；编码相同或高度相似表位结构的不同等位基因可能通过血清学无法区分。分子分型通过 DNA 序列来区分等位基因，包括同义变异和未表达（无效）变异。\n\n患者的结果如下：\n- 血清学分型 (CDC)：\n  - HLA-A: A2\n  - HLA-B: B7, B62\n  - HLA-C: Cw6\n  - HLA-DR: DR4, DR53\n  - HLA-DQ: DQ8\n- 分子分型 (PCR SBT)：\n  - HLA-A: A*02:01, A*02:09\n  - HLA-B: B*07:02, B*15:01\n  - HLA-C: C*06:02, C*07:02N\n  - HLA-DRB1: DRB1*04:01; HLA-DRB4: DRB4*01:03\n  - HLA-DQB1: DQB1*03:02\n\n下列哪一种解释最准确地说明了观察到的模式，并突出了血清学分型相对于分子分型的一个关键局限性？\n\nA. 一个 HLA-C 无效等位基因的存在导致了 HLA-C 在血清学上的表观纯合性，而分子分型检测到了该无效等位基因，并且 A2 血清学组内的两个不同 HLA-A 等位基因通过血清学无法区分。\n\nB. 对于 HLA-B，血清学分型的分辨率天生高于分子分型，并正确识别了 B*07:02 与 B*15:01，而分子分型错过了这一点。\n\nC. HLA-A 处的不一致表明存在测序假象；血清学是区分 A*02:01 和 A*02:09 的金标准。\n\nD. 血清学检测到 DR53 表明存在一个新的 HLA-DRB1 等位基因，而分子分型无法检测到该等位基因。\n\nE. 分子分型无法检测表达差异；只有血清学才能识别无效等位基因。",
            "solution": "用户要求对问题陈述进行严格验证，然后提供详细的解决方案并评估所给选项。\n\n### 问题验证\n\n**步骤 1：提取已知信息**\n\n问题提供了以下信息：\n\n-   **检测 1 (血清学分型 - CDC)：** 使用抗原特异性抗血清检测细胞表面蛋白质表位。\n-   **检测 2 (分子分型 - PCR SBT)：** 读取编码区的脱氧核糖核酸 (DNA) 序列以推断等位基因。\n-   **基本事实 1 (中心法则)：** DNA 转录为核糖核酸 (RNA) 并翻译成蛋白质。细胞表面表达需要一个功能性的开放阅读框。\n-   **基本事实 2 (共显性表达)：** 经典的 I 类 (HLA-A, HLA-B, HLA-C) 和 II 类 (例如, HLA-DRB1, HLA-DQB1) HLA 基因座是共显性表达的。在没有功能丧失性等位基因的情况下，两个亲代等位基因都会表达。\n-   **基本事实 3 (方法比较)：** 血清学检测共享的表位；不同的等位基因可能无法区分。分子分型通过 DNA 序列区分等位基因，包括同义变异和未表达（无效）变异。\n-   **患者结果 (血清学)：**\n    -   HLA-A: A2\n    -   HLA-B: B7, B62\n    -   HLA-C: Cw6\n    -   HLA-DR: DR4, DR53\n    -   HLA-DQ: DQ8\n-   **患者结果 (分子分型)：**\n    -   HLA-A: A*02:01, A*02:09\n    -   HLA-B: B*07:02, B*15:01\n    -   HLA-C: C*06:02, C*07:02N\n    -   HLA-DRB1: DRB1*04:01; HLA-DRB4: DRB4*01:03\n    -   HLA-DQB1: DQB1*03:02\n-   **问题：** 哪种解释最准确地说明了观察到的模式，并突出了血清学分型相对于分子分型的一个关键局限性？\n\n**步骤 2：使用提取的已知信息进行验证**\n\n-   **科学依据：** 该问题基于医学遗传学和免疫学的基本原理，特别是 HLA 系统。对血清学和分子分型方法的描述是准确的。共显性表达、无效等位基因（在标准命名法中以后缀 'N' 表示）、血清学组与特定等位基因的对比，以及 HLA-DR 区域的遗传组织结构（包括像 DRB1 和 DRB4 这样的基因座）等概念都是已确立的科学事实。\n-   **问题明确：** 该问题提出了两组实验数据，并要求根据所提供的原则给出最佳解释。两组数据之间的差异是问题的核心，并且是可以解释的，从而导向一个唯一的正确解释。\n-   **客观性：** 该问题以精确、客观、技术性的语言表述。数据呈现没有偏见。\n-   **完整性和一致性：** 该问题提供了解决明显差异所需的所有必要信息。基本事实作为解释的规则。数据与已知的 HLA 遗传学原理内部一致（例如，血清型 B62 与等位基因组 B15 之间的对应关系，包含多个等位基因的 A*02 血清学组的存在，以及通过 DRB1 和 DRB4 基因座实现的 DR4-DR53 关联）。\n\n**步骤 3：结论和行动**\n\n问题陈述是**有效的**。它科学合理，问题明确，并为推导解决方案提供了清晰的基础。现在可以进行求解过程。\n\n### 推导与选项分析\n\n任务是调和血清学分型和分子分型的结果，重点关注揭示血清学局限性的差异。我们将逐个基因座分析结果。\n\n**1. 逐个基因座分析**\n\n-   **HLA-A：** 血清学报告 A2，表明为纯合子。分子分型揭示了两个不同等位基因 A*02:01 和 A*02:09 的杂合性。这两个等位基因都编码携带 A2 表位的蛋白质。这展示了血清学的一个关键局限性：其分辨率不足以区分表达相同或非常相似表面抗原的不同等位基因。这是一个“抗原拆分”的案例，分子分型提供了更高的分辨率。\n\n-   **HLA-B：** 血清学报告了两种抗原，B7 和 B62。分子分型报告了两个等位基因，B*07:02 和 B*15:01。等位基因 B*07:02 编码 B7 抗原。等位基因 B*15:01 编码 B62 抗原（B62 是更广泛的 B15 抗原组的一个血清学“拆分”）。结果是一致的。\n\n-   **HLA-C：** 血清学仅报告 Cw6，表明为纯合子。然而，分子分型识别出两个不同的等位基因：C*06:02 和 C*07:02N。\n    -   C*06:02 编码 Cw6 蛋白，该蛋白被血清学检测到。\n    -   C*07:02N 是一个*无效等位基因*，由后缀 'N' 表示。如基本事实所述，该等位基因不产生功能性蛋白质。由于血清学检测的是细胞表面蛋白，因此它无法检测到无效等位基因的产物。\n    -   这导致了血清学结果中的“表观纯合性”。这是血清学的一个关键局限性：它无法检测未在细胞表面表达的等位基因。\n\n-   **HLA-DR：** 血清学报告 DR4 和 DR53。分子分型报告 DRB1*04:01 和 DRB4*01:03。DR4 特异性由 DRB1 基因座上的 DRB1*04:01 等位基因编码。DR53 特异性由 DRB4*01:03 等位基因编码，该等位基因位于一个独立的基因座 DRB4 上，通常与某些 DRB1 等位基因（如 DR4）一起遗传。结果是一致的，并说明了 II 类区域复杂的遗传学特性，分子分型对此进行了澄清。报告的单个 DRB1 等位基因可能表明纯合性或部分分型结果；然而，所提供的数据是一致的。\n\n-   **HLA-DQ：** 血清学报告 DQ8。分子分型报告 DQB1*03:02。DQB1*03:02 等位基因编码具有 DQ8 特异性的蛋白质。结果是一致的。\n\n**2. 综合与选项评估**\n\n分析揭示了两个主要的差异，这些差异凸显了血清学的局限性：\n-   在 HLA-A 基因座，血清学的分辨率低于分子分型。\n-   在 HLA-C 基因座，血清学未能检测到一个无效等位基因，从而给出了一个误导性的纯合子结果。\n\n我们现在根据这一理解来评估每个选项。\n\n**A. 一个 HLA-C 无效等位基因的存在导致了 HLA-C 在血清学上的表观纯合性，而分子分型检测到了该无效等位基因，并且 A2 血清学组内的两个不同 HLA-A 等位基因通过血清学无法区分。**\n-   **理由：** 该陈述精确且正确地描述了我们分析得出的两个关键发现。它指出了由无效等位基因 C*07:02N 引起的 HLA-C 的“表观血清学纯合性”，而分子分型正确地识别了该等位基因。它还正确地指出了 HLA-A 的情况，即血清学无法区分同一血清学组 (A2) 内的两个不同等位基因（A*02:01 和 A*02:09）。这个选项完美地捕捉了该模式并突出了血清学的根本局限性。\n-   **结论：** **正确**。\n\n**B. 对于 HLA-B，血清学分型的分辨率天生高于分子分型，并正确识别了 B*07:02 与 B*15:01，而分子分型错过了这一点。**\n-   **理由：** 该陈述在事实上是错误的。首先，分子分型的分辨率天生高于血清学，因为它分析的是底层的 DNA 序列。其次，分子分型并*没有*错过这种区分；它报告了 B*07:02 和 B*15:01，这与血清型 B7 和 B62 完全对应。这个前提是错误的。\n-   **结论：** **错误**。\n\n**C. HLA-A 处的不一致表明存在测序假象；血清学是区分 A*02:01 和 A*02:09 的金标准。**\n-   **理由：** 该陈述颠倒了两种技术的作用。HLA-A 处的不一致是 A2 血清学组的一个众所周知的特征，而不是假象。血清学从根本上无法区分像 A*02:01 和 A*02:09 这样的等位基因，因为它们编码高度相似的蛋白质表位。DNA 测序（分子分型）才是做出这种区分的权威方法——即“金标准”。\n-   **结论：** **错误**。\n\n**D. 血清学检测到 DR53 表明存在一个新的 HLA-DRB1 等位基因，而分子分型无法检测到该等位基因。**\n-   **理由：** 这种解释是错误的。DR53 是一个众所周知的血清学特异性，它并非由 DRB1 基因座编码，而是由 DRB4 基因座编码。分子分型的结果 DRB4*01:03 就是编码 DR53 抗原的特定等位基因。因此，分子分型*确实*检测到了 DR53 血清型的遗传基础；它不是一个新的或被遗漏的等位基因。\n-   **结论：** **错误**。\n\n**E. 分子分型无法检测表达差异；只有血清学才能识别无效等位基因。**\n-   **理由：** 该陈述与事实完全相反。分子分型通过在 DNA 序列中发现已知会阻止蛋白质表达的突变（例如，提前终止密码子、移码）来识别无效等位基因；后缀 'N' 正是这种分子识别的直接结果。相反，血清学*无法*识别无效等位基因，因为它寻找的是蛋白质产物，而无效等位基因的产物是缺失的。从血清学的角度来看，预期抗原的缺失仅仅是提示性而非确定性的证据，表明可能存在无效等位基因。\n-   **结论：** **错误**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "识别与疾病相关的HLA等位基因是理解许多自身免疫性、感染性和炎症性疾病遗传易感性的关键一步。本练习模拟了一项病例-对照关联研究，要求您应用严谨的统计方法，包括Fisher精确检验和多重检验校正，来确定哪些HLA等位基因与疾病显著相关()。通过这个编程实践，您将掌握从群体数据中挖掘有医学价值的遗传关联所必需的计算和统计技能。",
            "id": "5055656",
            "problem": "您需要编写一个完整的程序，该程序实现一个原则性的统计工作流程，以检验主要组织相容性复合体 (MHC) 内的人类白细胞抗原 (HLA) 等位基因与二元疾病状态之间的关联。该任务必须纯粹用数学和算法术语表述如下。\n\n使用的基本原理和定义：\n- 单个等位基因的 $2\\times 2$ 列联表记录了根据等位基因存在与否划分的病例组和对照组的计数：\n  - 设 $a$ 为携带该等位基因的病例数。\n  - 设 $b$ 为携带该等位基因的对照数。\n  - 设 $c$ 为不携带该等位基因的病例数。\n  - 设 $d$ 为不携带该等位基因的对照数。\n  - 设 $N = a + b + c + d$ 为总数， $n = a + c$ 为病例总数， $K = a + b$ 为携带该等位基因的总人数。\n- 在独立性（无关联）的零假设下，并以固定的边际总数 $(N,n,K)$ 为条件，观察到特定左上角单元格计数 $X = x$ 的概率是超几何概率\n  $$P(X=x) = \\frac{\\binom{K}{x}\\binom{N-K}{n-x}}{\\binom{N}{n}}.$$\n- 对于一个观测表格 $X=a$ ，其双边 Fisher 精确检验的 $p$ 值是所有概率小于或等于观测表格概率的可行表格的概率之和：\n  $$p = \\sum_{x \\in \\mathcal{S}} P(X=x), \\quad \\mathcal{S} = \\{x: P(X=x) \\leq P(X=a)\\},$$\n  其中可行支撑集满足 $x \\in [\\max(0, n-(N-K)), \\min(n, K)]$。\n- 比值比 (OR) 量化了关联的方向和强度。计算比值比如下\n  $$\\operatorname{OR} = \\frac{a\\,d}{b\\,c},$$\n  但如果 $a,b,c,d$ 中有任何一个等于 $0$，则应用 Haldane–Anscombe 校正，即为每个单元格加上 $0.5$，然后计算\n  $$\\operatorname{OR}_{\\mathrm{HA}} = \\frac{(a+0.5)(d+0.5)}{(b+0.5)(c+0.5)}.$$\n- 在单个测试用例中对 $m$ 个等位基因进行的多重检验校正必须使用以下方法之一：\n  - Bonferroni 校正，在家族错误率 $\\alpha$ 水平下：将 $p \\leq \\alpha/m$ 的等位基因声明为显著。\n  - Benjamini–Hochberg (BH) 程序，在错误发现率目标 $q$ 水平下：设 $p_{(1)} \\leq \\cdots \\leq p_{(m)}$ 为排序后的 $p$ 值，找到满足 $p_{(k)} \\leq (k/m)\\,q$ 的最大 $k$ 值，并声明与 $k$ 个最小 $p$ 值相对应的 $k$ 个假设为显著。\n\n程序要求：\n- 对于每个测试用例，您必须：\n  $1.$ 使用上述超几何模型为每个等位基因表格计算双边 Fisher 精确检验的 $p$ 值。\n  $2.$ 对该测试用例中的所有等位基因，使用提供的错误率目标（Bonferroni 的 $\\alpha$ 或 BH 的 $q$）应用指定的多重检验程序（Bonferroni 或 BH）。\n  $3.$ 根据统计显著性和比值比指示的方向，将每个等位基因分类为三种整数编码的结果之一：\n    - 如果等位基因显著且 $\\operatorname{OR} > 1$（风险相关），则返回 $+1$。\n    - 如果等位基因显著且 $\\operatorname{OR}  1$（保护性），则返回 $-1$。\n    - 如果等位基因不显著（无论 $\\operatorname{OR}$ 值如何），或者在未校正计算下 $\\operatorname{OR}$ 恰好等于 $1$，或者在需要时应用 Haldane–Anscombe 校正后等于 $1$，则返回 $0$。\n- 此问题不涉及角度单位和物理单位。\n- 所有返回的数值必须是如上定义的整数。\n\n测试套件：\n为您的程序提供以下三个测试用例，每个用例包含一个 $2 \\times 2$ 表格列表和一个多重检验配置。对于每个 $2 \\times 2$ 表格，元组 $(a,b,c,d)$ 按该顺序给出。\n\n- 测试用例 1：\n  - 方法：\"bh\" (Benjamini–Hochberg)。\n  - 目标 $q = 0.05$。\n  - 等位基因表格：\n    $1.$ $(a,b,c,d) = (30, 10, 70, 90)$,\n    $2.$ $(a,b,c,d) = (5, 30, 95, 70)$,\n    $3.$ $(a,b,c,d) = (12, 11, 88, 89)$.\n- 测试用例 2：\n  - 方法：\"bonferroni\"。\n  - 目标 $\\alpha = 0.10$。\n  - 等位基因表格：\n    $1.$ $(a,b,c,d) = (0, 20, 100, 80)$,\n    $2.$ $(a,b,c,d) = (25, 25, 75, 75)$,\n    $3.$ $(a,b,c,d) = (1, 0, 99, 100)$.\n- 测试用例 3：\n  - 方法：\"bh\" (Benjamini–Hochberg)。\n  - 目标 $q = 0.10$。\n  - 等位基因表格：\n    $1.$ $(a,b,c,d) = (35, 15, 65, 85)$,\n    $2.$ $(a,b,c,d) = (30, 18, 70, 82)$,\n    $3.$ $(a,b,c,d) = (26, 20, 74, 80)$,\n    $4.$ $(a,b,c,d) = (18, 22, 82, 78)$.\n\n最终输出规范：\n- 对于每个测试用例，按照输入等位基因表格的相同顺序输出一个整数列表，使用 $+1$ 表示风险，$-1$ 表示保护性， $0$ 表示不显著的编码。\n- 将所有测试用例的列表聚合成一个单一列表，并保持测试用例的顺序。\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。例如，如果一个程序为每个测试用例生成了三个列表 $[1,0]$、$[0,-1,1]$ 和 $[0]$，那么最后一行必须确切为 \"[[1,0],[0,-1,1],[0]]\"。",
            "solution": "用户要求一个程序，该程序能基于一系列 $2 \\times 2$ 列联表对遗传关联数据进行统计分析。该分析涉及计算 Fisher 精确检验的 $p$ 值、计算比值比、应用多重检验校正，并根据结果对等位基因进行分类。\n\n### 基于原则的设计和算法工作流\n\n该解决方案被构建为一系列明确定义的统计和计算步骤，遵循问题陈述中概述的原则。\n\n#### 1. 数据表示和核心统计度量\n\n- **列联表**：每个等位基因的数据以元组 $(a, b, c, d)$ 的形式给出，表示一个 $2 \\times 2$ 表中的计数：\n  - 第 1 行：等位基因存在（病例：$a$，对照：$b$）\n  - 第 2 行：等位基因不存在（病例：$c$，对照：$d$）\n- **比值比 (OR)**：比值比是效应大小的度量。其计算公式为 $\\operatorname{OR} = (a \\cdot d) / (b \\cdot c)$。如果任何单元格计数为零，则应用 Haldane–Anscombe 校正，即为每个单元格加上 $0.5$，得到 $\\operatorname{OR}_{\\mathrm{HA}} = ((a+0.5)(d+0.5)) / ((b+0.5)(c+0.5))$。$\\operatorname{OR} > 1$ 表明存在风险关联，而 $\\operatorname{OR}  1$ 表明存在保护性关联。$\\operatorname{OR} = 1$ 表示无关联。\n\n#### 2. 用于统计显著性检验的 Fisher 精确检验\n\n显著性检验的核心是 Fisher 精确检验，该检验适用于列联表，尤其是在单元格计数较小的情况下。该检验基于超几何分布。\n\n- **零假设 ($H_0$)**：等位基因的存在与否与疾病状态（病例 vs. 对照）无关。\n- **条件模型**：在 $H_0$ 下，如果我们固定表格的边际总数（病例总数、对照总数、携带等位基因总数、不携带等位基因总数），则携带等位基因的病例数（计数 $a$）遵循超几何分布。\n- **超几何概率**：在左上角单元格中观察到计数 $x$ 的概率由以下公式给出：\n  $$P(X=x) = \\frac{\\binom{K}{x}\\binom{N-K}{n-x}}{\\binom{N}{n}}$$\n  其中 $n = a+c$ 是病例总数， $K = a+b$ 是携带该等位基因的个体总数， $N = a+b+c+d$ 是总人数。变量 $x$ 的取值范围是其可行支撑集 $[\\max(0, n-(N-K)), \\min(n, K)]$。在计算上，这个概率质量函数 (PMF) 是使用 `scipy.stats.hypergeom.pmf` 来实现的。\n- **双边 $p$ 值**：$p$ 值表示在零假设为真的前提下，观察到与实际观测表格同样极端或更极端结果的概率。对于双边检验，其计算方法是，将所有概率等于或小于观测表格概率的可能表格（即 $x$ 的所有可行值）的概率相加：\n  $$p = \\sum_{x \\in \\mathcal{S}} P(X=x), \\quad \\text{where } \\mathcal{S} = \\{x: P(X=x) \\leq P(X=a)\\}$$\n  此求和是在分布的整个支撑集上进行的。\n\n#### 3. 多重检验校正\n\n当同时进行多个统计检验时（每个等位基因一个），在整个检验族中犯第一类错误（假阳性）的概率会增加。为了控制这一点，必须采用校正程序。\n\n- **Bonferroni 校正**：此方法控制家族错误率 (FWER)，即犯至少一个第一类错误的概率。这是一种保守的方法，其中每个独立检验的显著性阈值 $\\alpha_{\\text{ind}}$ 被调整为 $\\alpha / m$，其中 $\\alpha$ 是期望的 FWER，$m$ 是检验次数。如果一个等位基因的 $p$ 值小于或等于这个调整后的阈值，即 $p \\leq \\alpha/m$，则声明其为显著。\n- **Benjamini–Hochberg (BH) 程序**：此方法控制错误发现率 (FDR)，即所有显著结果中假阳性的预期比例。它通常比 Bonferroni 校正更具效力。该程序如下：\n  1. 将 $m$ 个 $p$ 值按升序排列：$p_{(1)} \\leq p_{(2)} \\leq \\cdots \\leq p_{(m)}$。\n  2. 找到满足第 $k$ 位排序的 $p$ 值 $p_{(k)} \\leq \\frac{k}{m}q$ 的最大整数 $k$，其中 $q$ 是目标 FDR。\n  3. 声明与最小的 $k$ 个 $p$ 值（$p_{(1)}, \\dots, p_{(k)}$）相对应的 $k$ 个等位基因为统计学显著。\n\n#### 4. 等位基因分类\n\n根据统计显著性和效应方向（由比值比得出），每个等位基因被分为三类之一：\n\n- **风险 ($+1$)**：经过多重检验校正后，关联具有统计显著性，并且比值比大于 $1$。\n- **保护性 ($-1$)**：关联具有统计显著性，并且比值比小于 $1$。\n- **无关联 ($0$)**：关联不具有统计显著性，或者比值比恰好等于 $1$。$\\operatorname{OR}=1$ 的条件优先，因为它代表完美的零效应，使得显著性检验没有意义。\n\n### 实现策略\n\n程序为每个提供的测试用例系统地实现此工作流程。\n\n1.  一个 `solve()` 函数封装了整个过程。\n2.  对于每个测试用例，它初始化列表以存储计算出的 $p$ 值和比值比。\n3.  它遍历测试用例中的每个等位基因表格：\n    a. 一个辅助函数 `calculate_or` 计算比值比，并对零值单元格正确应用 Haldane-Anscombe 校正。\n    b. 一个辅助函数 `fisher_exact_p_value` 按照定义实现双边 Fisher 检验，通过在适当的集合 $\\mathcal{S}$ 上对超几何 PMF 的概率求和。\n4.  在处理完一个测试用例中的所有等位基因后，它对收集到的 $p$ 值应用指定的多重检验校正（`bonferroni` 或 `bh`），以生成一个指示显著性的布尔值列表。BH 程序需要仔细处理 $p$ 值的排序和原始索引，以确保将显著性正确映射回原始等位基因。\n5.  最后，它遍历结果，应用分类规则，为该测试用例生成最终的整数编码输出。\n6.  来自所有测试用例的结果被聚合成一个列表的列表，并格式化为最终答案所需的精确字符串表示形式。\n\n这种结构化的、基于原则的方法确保了正确性、鲁棒性，并遵守了问题的严格要求。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import hypergeom\n\ndef solve():\n    \"\"\"\n    Main function to run the HLA association analysis for the given test suite.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"method\": \"bh\",\n            \"target\": 0.05,\n            \"tables\": [\n                (30, 10, 70, 90),\n                (5, 30, 95, 70),\n                (12, 11, 88, 89),\n            ]\n        },\n        {\n            \"method\": \"bonferroni\",\n            \"target\": 0.10,\n            \"tables\": [\n                (0, 20, 100, 80),\n                (25, 25, 75, 75),\n                (1, 0, 99, 100),\n            ]\n        },\n        {\n            \"method\": \"bh\",\n            \"target\": 0.10,\n            \"tables\": [\n                (35, 15, 65, 85),\n                (30, 18, 70, 82),\n                (26, 20, 74, 80),\n                (18, 22, 82, 78),\n            ]\n        }\n    ]\n\n    final_results = []\n\n    for case in test_cases:\n        method = case[\"method\"]\n        target_level = case[\"target\"]\n        tables = case[\"tables\"]\n        num_alleles = len(tables)\n\n        p_values = []\n        odds_ratios = []\n\n        for a, b, c, d in tables:\n            # 1. Compute Odds Ratio\n            odds_ratios.append(calculate_or(a, b, c, d))\n\n            # 2. Compute Fisher's Exact Test P-value\n            p_values.append(fisher_exact_p_value(a, b, c, d))\n\n        # 3. Apply Multiple Testing Correction\n        is_significant = apply_multiple_testing_correction(p_values, method, target_level)\n\n        # 4. Classify alleles\n        case_results = []\n        for i in range(num_alleles):\n            or_val = odds_ratios[i]\n            is_sig = is_significant[i]\n\n            # Rule: OR=1 is always classified as 0.\n            if or_val == 1.0:\n                classification = 0\n            elif not is_sig:\n                classification = 0\n            elif is_sig and or_val > 1.0:\n                classification = 1\n            elif is_sig and or_val  1.0:\n                classification = -1\n            else: # Should not be reached with valid inputs\n                classification = 0\n            \n            case_results.append(classification)\n        \n        final_results.append(case_results)\n    \n    # Final print statement in the exact required format '[[...],[...]]'\n    print(str(final_results).replace(\" \", \"\"))\n\ndef calculate_or(a, b, c, d):\n    \"\"\"\n    Computes the odds ratio for a 2x2 contingency table.\n    Applies Haldane-Anscombe correction if any cell is zero.\n    \"\"\"\n    if a == 0 or b == 0 or c == 0 or d == 0:\n        # Haldane-Anscombe correction\n        or_val = ((a + 0.5) * (d + 0.5)) / ((b + 0.5) * (c + 0.5))\n    else:\n        or_val = (a * d) / (b * c)\n    return or_val\n\ndef fisher_exact_p_value(a, b, c, d):\n    \"\"\"\n    Computes the two-sided Fisher's exact test p-value using the hypergeometric distribution.\n    The p-value is the sum of probabilities of all tables with a probability\n    less than or equal to the observed table's probability.\n    \"\"\"\n    N_total = a + b + c + d\n    n_cases_total = a + c\n    K_allele_total = a + b\n\n    # Map to scipy's hypergeom(M, n, N) notation:\n    # M: total number of objects (population size)\n    # n: total number of type I objects (alleles in population)\n    # N: size of the sample (number of cases)\n    M_pop, n_typeI, N_sample = N_total, K_allele_total, n_cases_total\n\n    # Define the support of the distribution for the top-left cell count 'x'\n    support_min = max(0, N_sample - (M_pop - n_typeI))\n    support_max = min(N_sample, n_typeI)\n\n    # Probability of the observed table (X=a)\n    # Use a small tolerance for floating-point comparisons\n    p_observed = hypergeom.pmf(a, M_pop, n_typeI, N_sample)\n    \n    p_value = 0.0\n    for x in range(support_min, support_max + 1):\n        p_x = hypergeom.pmf(x, M_pop, n_typeI, N_sample)\n        if p_x = p_observed + 1e-12:  # Sum probabilities of tables as or more extreme\n            p_value += p_x\n            \n    return p_value\n\ndef apply_multiple_testing_correction(p_values, method, target_level):\n    \"\"\"\n    Applies the specified multiple testing correction procedure.\n    \"\"\"\n    m = len(p_values)\n    is_significant = [False] * m\n\n    if method == \"bonferroni\":\n        threshold = target_level / m\n        for i in range(m):\n            if p_values[i] = threshold:\n                is_significant[i] = True\n    \n    elif method == \"bh\":\n        # Sort p-values while keeping track of original indices\n        indexed_p_values = sorted(enumerate(p_values), key=lambda x: x[1])\n        \n        q = target_level\n        largest_k = 0\n        # Find the largest k such that p(k) = (k/m)*q\n        for i in range(m - 1, -1, -1):\n            rank = i + 1\n            original_index, p_val = indexed_p_values[i]\n            if p_val = (rank / m) * q:\n                largest_k = rank\n                break\n        \n        # Mark the k smallest p-values as significant\n        for i in range(largest_k):\n            original_index, _ = indexed_p_values[i]\n            is_significant[original_index] = True\n            \n    return is_significant\n\nsolve()\n```"
        }
    ]
}