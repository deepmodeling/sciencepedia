{
    "hands_on_practices": [
        {
            "introduction": "在处理真实的电子健康记录（EHR）数据时，数据缺失是一个普遍存在且棘手的挑战。一种看似简单直接的处理方法是“完整病例分析”（complete-case analysis），即只分析那些信息完整的记录。然而，当数据缺失的原因与患者的病情本身相关时，这种看似无害的方法可能会引入严重的系统性偏差。本练习将引导你从第一性原理出发，运用概率论的工具，精确地推导出当结果变量的缺失与患者的疾病严重程度相关时，完整病例分析会给关联性研究带来怎样的偏差 。",
            "id": "4841120",
            "problem": "一个医院的电子健康记录数据集被用来研究二元用药指标 $M \\in \\{0,1\\}$ 与二元结局 $Y \\in \\{0,1\\}$ 之间的关联。疾病严重程度由一个二元协变量 $S \\in \\{0,1\\}$ 概括，其中 $S=1$ 表示高严重程度。假设以下数据生成过程：\n- 高严重程度的边际患病率为 $\\mathbb{P}(S=1)=p$，其中 $0  p  1$。\n- 给定严重程度，用药概率为 $\\mathbb{P}(M=1 \\mid S=1) = a$ 和 $\\mathbb{P}(M=1 \\mid S=0) = b$。\n- 给定用药和严重程度，结局的条件期望为 $\\mathbb{E}[Y \\mid M=m, S=s] = \\theta_{0} + \\theta_{M} m + \\theta_{S} s + \\theta_{MS} m s$。\n- 结局 $Y$ 的可观测性 $R \\in \\{0,1\\}$ (其中 $R=1$ 表示可观测到) 仅取决于严重程度，$\\mathbb{P}(R=1 \\mid S=1)=r_1$ 和 $\\mathbb{P}(R=1 \\mid S=0)=r_0$，且 $r_1 > r_0$。\n\n在这些假设下，推导完整病例分析所估计的关联性对比（风险差异）$\\Delta_{\\text{cc}} = \\mathbb{E}[Y \\mid M=1, R=1] - \\mathbb{E}[Y \\mid M=0, R=1]$ 与真实关联性对比 $\\Delta_{\\text{true}} = \\mathbb{E}[Y \\mid M=1] - \\mathbb{E}[Y \\mid M=0]$ 之间的偏差。将偏差表示为模型参数 ($\\theta_0, \\theta_M, \\theta_S, \\theta_{MS}$) 和数据生成参数 ($p, a, b, r_1, r_0$) 的函数。",
            "solution": "我们从条件期望和全期望定律的基本定义以及贝叶斯法则出发。目标是计算完整病例风险差异与真实风险差异之间的差值。在整个过程中，我们保持参数为符号形式。\n\n首先，我们计算每个用药组内严重程度的分布。使用贝叶斯法则，\n\n$$\n\\mathbb{P}(S=1 \\mid M=1) \\equiv \\pi_{1} = \\frac{\\mathbb{P}(M=1 \\mid S=1)\\,\\mathbb{P}(S=1)}{\\mathbb{P}(M=1)} = \\frac{p\\,a}{p\\,a + (1-p)\\,b},\n$$\n\n其中\n\n$$\n\\mathbb{P}(M=1) = \\mathbb{P}(M=1 \\mid S=1)\\,\\mathbb{P}(S=1) + \\mathbb{P}(M=1 \\mid S=0)\\,\\mathbb{P}(S=0) = p\\,a + (1-p)\\,b.\n$$\n\n类似地，\n\n$$\n\\mathbb{P}(S=1 \\mid M=0) \\equiv \\pi_{0} = \\frac{\\mathbb{P}(M=0 \\mid S=1)\\,\\mathbb{P}(S=1)}{\\mathbb{P}(M=0)} = \\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)},\n$$\n\n其中 $\\mathbb{P}(M=0) = p\\,(1-a) + (1-p)\\,(1-b)$。\n\n接下来，我们使用线性概率模型和全期望定律计算全人群中每个用药组的期望结局。对于 $m \\in \\{0,1\\}$，\n\n$$\n\\mathbb{E}[Y \\mid M=m] = \\sum_{s \\in \\{0,1\\}} \\mathbb{E}[Y \\mid M=m, S=s]\\,\\mathbb{P}(S=s \\mid M=m).\n$$\n\n由于 $\\mathbb{E}[Y \\mid M=m, S=s] = \\theta_{0} + \\theta_{M} m + \\theta_{S} s + \\theta_{MS} m s$，我们有\n\n$$\n\\mathbb{E}[Y \\mid M=1] = \\theta_{0} + \\theta_{M} + (\\theta_{S} + \\theta_{MS})\\,\\pi_{1},\n$$\n\n\n$$\n\\mathbb{E}[Y \\mid M=0] = \\theta_{0} + \\theta_{S}\\,\\pi_{0}.\n$$\n\n因此，真实的关联对比（风险差异）是\n\n$$\n\\Delta_{\\text{true}} = \\mathbb{E}[Y \\mid M=1] - \\mathbb{E}[Y \\mid M=0] = \\theta_{M} + \\theta_{S}(\\pi_{1} - \\pi_{0}) + \\theta_{MS}\\,\\pi_{1}.\n$$\n\n\n现在我们转向完整病例对比，它以 $R=1$ 为条件。我们需要完整病例中各用药组内的严重程度分布。通过对仅依赖于 $S$ 的 $R=1$ 进行选择，并应用贝叶斯法则，\n\n$$\n\\mathbb{P}(S=1 \\mid M=m, R=1) \\equiv q_{m} = \\frac{\\mathbb{P}(R=1 \\mid S=1)\\,\\mathbb{P}(S=1 \\mid M=m)}{\\sum_{s \\in \\{0,1\\}} \\mathbb{P}(R=1 \\mid S=s)\\,\\mathbb{P}(S=s \\mid M=m)} = \\frac{r_{1}\\,\\pi_{m}}{r_{1}\\,\\pi_{m} + r_{0}\\,(1-\\pi_{m})}.\n$$\n\n使用相同的线性概率模型，并通过 $S$ 的分布以 $R=1$ 为条件，我们有\n\n$$\n\\mathbb{E}[Y \\mid M=1, R=1] = \\theta_{0} + \\theta_{M} + (\\theta_{S} + \\theta_{MS})\\,q_{1},\n$$\n\n\n$$\n\\mathbb{E}[Y \\mid M=0, R=1] = \\theta_{0} + \\theta_{S}\\,q_{0}.\n$$\n\n因此，完整病例关联对比是\n\n$$\n\\Delta_{\\text{cc}} = \\mathbb{E}[Y \\mid M=1, R=1] - \\mathbb{E}[Y \\mid M=0, R=1] = \\theta_{M} + \\theta_{S}(q_{1}-q_{0}) + \\theta_{MS}\\,q_{1}.\n$$\n\n\n偏差是完整病例对比与真实对比之间的差值：\n\n$$\n\\text{Bias} \\equiv \\Delta_{\\text{cc}} - \\Delta_{\\text{true}} = \\left[\\theta_{M} + \\theta_{S}(q_{1}-q_{0}) + \\theta_{MS}\\,q_{1}\\right] - \\left[\\theta_{M} + \\theta_{S}(\\pi_{1}-\\pi_{0}) + \\theta_{MS}\\,\\pi_{1}\\right].\n$$\n\n消去 $\\theta_{M}$ 并重新整理各项，得到\n\n$$\n\\text{Bias} = \\theta_{S}\\left[(q_{1}-q_{0}) - (\\pi_{1}-\\pi_{0})\\right] + \\theta_{MS}\\left(q_{1} - \\pi_{1}\\right),\n$$\n\n其中\n\n$$\n\\pi_{1} = \\frac{p\\,a}{p\\,a + (1-p)\\,b}, \\quad \\pi_{0} = \\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)},\n$$\n\n\n$$\nq_{m} = \\frac{r_{1}\\,\\pi_{m}}{r_{1}\\,\\pi_{m} + r_{0}\\,(1-\\pi_{m})} \\quad \\text{for } m \\in \\{0,1\\}.\n$$\n\n该表达式表明，偏差源于两个部分：一是完整病例相对于全人群而言，用药组之间严重程度分布的偏移，由 $\\theta_{S}$ 加权；二是在治疗组中由选择引起的交互作用贡献的变化，由 $\\theta_{MS}$ 加权。值得注意的是，$\\theta_{0}$ 被消掉了，因为它对两个用药组的贡献是相等的。\n\n将 $q_{1}$ 和 $q_{0}$ 的定义明确代入，偏差可以写成一个单一的闭式解析表达式：\n\n$$\n\\text{Bias} = \\theta_{S}\\left[\\frac{r_{1}\\,\\pi_{1}}{r_{1}\\,\\pi_{1} + r_{0}\\,(1-\\pi_{1})} - \\frac{r_{1}\\,\\pi_{0}}{r_{1}\\,\\pi_{0} + r_{0}\\,(1-\\pi_{0})} - (\\pi_{1}-\\pi_{0})\\right] + \\theta_{MS}\\left[\\frac{r_{1}\\,\\pi_{1}}{r_{1}\\,\\pi_{1} + r_{0}\\,(1-\\pi_{1})} - \\pi_{1}\\right],\n$$\n\n其中 $\\pi_{1}$ 和 $\\pi_{0}$ 如上文所示，用 $p$、$a$ 和 $b$ 表示。这样就完成了使用基本概率定律的推导。",
            "answer": "$$\\boxed{\\theta_{S}\\left[\\frac{r_{1}\\left(\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right)}{r_{1}\\left(\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right) + r_{0}\\left(1-\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right)} - \\frac{r_{1}\\left(\\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)}\\right)}{r_{1}\\left(\\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)}\\right) + r_{0}\\left(1-\\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)}\\right)} - \\left(\\frac{p\\,a}{p\\,a + (1-p)\\,b} - \\frac{p\\,(1-a)}{p\\,(1-a) + (1-p)\\,(1-b)}\\right)\\right] + \\theta_{MS}\\left[\\frac{r_{1}\\left(\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right)}{r_{1}\\left(\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right) + r_{0}\\left(1-\\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right)} - \\frac{p\\,a}{p\\,a + (1-p)\\,b}\\right]}$$"
        },
        {
            "introduction": "在评估分类模型的性能时，受试者工作特征曲线下面积（AUROC）是一个广受欢迎的指标。然而，一个高 AUROC 值是否就等同于一个在临床上有用的模型呢？本练习旨在深入探讨模型性能评估中的一个核心议题：辨别能力（discrimination）与校准度（calibration）之间的区别。你将通过一个精心设计的思想实验，为一个生物标志物推导其 AUROC，并揭示即使一个模型能输出完全可靠的概率（即完美校准），它也可能在区分患病与健康人群方面表现得非常糟糕 。",
            "id": "4841086",
            "problem": "一家医院正在开发一个败血症风险模型，该模型使用单一的连续实验室生物标志物。设二元结果为 $Y \\in \\{0,1\\}$，其中 $Y=1$ 表示患者在 $48$ 小时内出现败血症。生物标志物是 $X \\in \\mathbb{R}$。在目标人群中，类别先验概率（患病率）为 $p = \\mathbb{P}(Y=1) = 0.01$。根据经验，类别条件下的特征分布可以很好地用等方差的正态分布来描述：$X \\mid Y=1 \\sim \\mathcal{N}(\\mu_1,\\sigma^2)$ 和 $X \\mid Y=0 \\sim \\mathcal{N}(\\mu_0,\\sigma^2)$，其中 $\\mu_0 = 0$，$\\mu_1 = 0.1$，$\\sigma = 1$。模型输出后验概率得分 $S = s(X)$，其中 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$ 是使用贝叶斯定理以及真实的参数和真实的先验概率 $p$ 计算得出的。因此，该模型的分数在数值上等于给定 $X$ 下结果的真实条件概率。\n\n仅使用概率论和统计学中的基本定义：校准度的定义为，对于几乎所有的 $s$，都有 $\\mathbb{P}(Y=1 \\mid S=s) = s$；贝叶斯定理；以及受试者工作特征（AUROC）曲线下面积的定义为，当评分相等的概率为零时，随机抽取的阳性病例的得分严格高于随机抽取的阴性病例的得分的概率。假设抽取一个阳性病例和一个阴性病例时是相互独立的。\n\n从这些定义出发（不使用任何预先记下的“捷径”公式），推导并评估该模型在所述数据生成机制下的 AUROC。然后解释该值如何表明，在类别严重不平衡和类别条件分布区分度较弱的情况下，一个模型可以被完美校准，但其区分能力却很差。\n\n以一个四位有效数字的实数形式给出最终的 AUROC。不需要单位。",
            "solution": "首先根据指定标准验证问题。\n\n**步骤1：提取已知条件**\n-   结果变量：$Y \\in \\{0,1\\}$，其中 $Y=1$ 表示败血症。\n-   连续生物标志物：$X \\in \\mathbb{R}$。\n-   败血症的类别先验概率：$p = \\mathbb{P}(Y=1) = 0.01$。\n-   阳性病例（$Y=1$）的类别条件分布：$X \\mid Y=1 \\sim \\mathcal{N}(\\mu_1, \\sigma^2)$。\n-   阴性病例（$Y=0$）的类别条件分布：$X \\mid Y=0 \\sim \\mathcal{N}(\\mu_0, \\sigma^2)$。\n-   参数：$\\mu_0 = 0$，$\\mu_1 = 0.1$，$\\sigma = 1$。\n-   模型得分：$S = s(X)$，其中 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$ 使用真实参数计算。\n-   AUROC 的定义：随机抽取的阳性病例得分严格高于随机抽取的阴性病例得分的概率，即 $\\mathbb{P}(S_1  S_0)$，其中 $S_1$ 是阳性病例的得分，$S_0$ 是阴性病例的得分。\n-   假设：随机抽取的阳性病例和阴性病例之间相互独立。\n-   任务：根据这些定义推导和评估 AUROC，并解释结果。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题在科学上和数学上是合理的。它呈现了统计分类和模型评估中的一个标准场景，使用了贝叶斯定理、正态分布、类别不平衡、校准度和 AUROC 等既定概念。所提供的信息是完整、一致且定义明确的，允许从第一性原理推导出唯一的解。对于一个使用弱生物标志物的医学诊断问题，这些参数是符合实际的。该问题是适定且客观的。\n\n**步骤3：结论与行动**\n该问题被判定为**有效**。将推导完整的解答。\n\n**AUROC 的推导**\n\n受试者工作特征（AUROC）曲线下面积定义为随机选择的阳性病例比随机选择的阴性病例具有更高风险评分的概率。设 $X_1$ 是从阳性类别（$Y=1$）的生物标志物分布中随机抽取的一个样本，而 $X_0$ 是从阴性类别（$Y=0$）的分布中随机抽取的一个样本。相应的得分是 $S_1 = s(X_1)$ 和 $S_0 = s(X_0)$。那么 AUROC 就是 $\\mathbb{P}(S_1  S_0)$。\n\n首先，我们必须描述得分函数 $s(x) = \\mathbb{P}(Y=1 \\mid X=x)$。使用贝叶斯定理：\n$$s(x) = \\frac{f(x \\mid Y=1) \\mathbb{P}(Y=1)}{f(x \\mid Y=1) \\mathbb{P}(Y=1) + f(x \\mid Y=0) \\mathbb{P}(Y=0)}$$\n其中 $f(x \\mid Y=1)$ 和 $f(x \\mid Y=0)$ 是类别条件分布的概率密度函数 (PDF)。设 $p = \\mathbb{P}(Y=1)=0.01$，因此 $\\mathbb{P}(Y=0) = 1-p = 0.99$。其概率密度函数为正态分布：\n$$f(x \\mid Y=1) = f_1(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(x-\\mu_1)^2}{2\\sigma^2}\\right)$$\n$$f(x \\mid Y=0) = f_0(x) = \\frac{1}{\\sqrt{2\\pi}\\sigma} \\exp\\left(-\\frac{(x-\\mu_0)^2}{2\\sigma^2}\\right)$$\n得分函数可以写成：\n$$s(x) = \\frac{p f_1(x)}{p f_1(x) + (1-p) f_0(x)} = \\frac{1}{1 + \\frac{1-p}{p} \\frac{f_0(x)}{f_1(x)}}$$\n\n我们必须确定 $s(x)$ 是否是 $x$ 的单调函数。$\\mathbb{P}(S_1  S_0)$ 的关系取决于 $s(x)$ 的单调性。概率密度函数的比值为：\n$$\\frac{f_0(x)}{f_1(x)} = \\frac{\\exp\\left(-\\frac{(x-\\mu_0)^2}{2\\sigma^2}\\right)}{\\exp\\left(-\\frac{(x-\\mu_1)^2}{2\\sigma^2}\\right)} = \\exp\\left(\\frac{(x-\\mu_1)^2 - (x-\\mu_0)^2}{2\\sigma^2}\\right)$$\n指数中的项是：\n$$\\frac{1}{2\\sigma^2} \\left( (x^2 - 2x\\mu_1 + \\mu_1^2) - (x^2 - 2x\\mu_0 + \\mu_0^2) \\right) = \\frac{1}{2\\sigma^2} \\left( 2x(\\mu_0 - \\mu_1) + \\mu_1^2 - \\mu_0^2 \\right) = \\frac{\\mu_0 - \\mu_1}{\\sigma^2} x + \\frac{\\mu_1^2 - \\mu_0^2}{2\\sigma^2}$$\n这是 $x$ 的一个线性函数。设 $g(x) = \\frac{f_0(x)}{f_1(x)}$。其对数对 $x$ 的导数是 $\\frac{d}{dx} \\ln(g(x)) = \\frac{\\mu_0 - \\mu_1}{\\sigma^2}$。\n给定 $\\mu_1 = 0.1$ 和 $\\mu_0 = 0$，该导数为 $\\frac{0 - 0.1}{1^2} = -0.1$，是负数。因此，$\\ln(g(x))$ 是 $x$ 的严格递减函数，这意味着 $g(x) = \\frac{f_0(x)}{f_1(x)}$ 也是 $x$ 的严格递减函数。\n\n得分函数是 $s(x) = \\left(1 + \\frac{1-p}{p}g(x)\\right)^{-1}$。因为 $g(x)$ 是一个正的严格递减函数，并且对于 $c0, z0$，$z \\mapsto (1+c z)^{-1}$ 是一个严格递减函数，所以复合函数 $s(x)$ 是一个严格**递增**的 $x$ 函数。\n\n因为 $s(x)$ 是严格单调的，不等式 $s(X_1)  s(X_0)$ 等价于不等式 $X_1  X_0$。因此，AUROC 可以计算为：\n$$\\text{AUROC} = \\mathbb{P}(S_1  S_0) = \\mathbb{P}(X_1  X_0)$$\n我们已知 $X_1$ 和 $X_0$ 是独立的随机变量，其分布为：\n$$X_1 \\sim \\mathcal{N}(\\mu_1, \\sigma^2)$$\n$$X_0 \\sim \\mathcal{N}(\\mu_0, \\sigma^2)$$\n令差值为 $D = X_1 - X_0$。由于 $X_1$ 和 $X_0$ 是独立的服从正态分布的变量，它们的差 $D$ 也服从正态分布。\n$D$ 的均值是 $\\mathbb{E}[D] = \\mathbb{E}[X_1] - \\mathbb{E}[X_0] = \\mu_1 - \\mu_0$。\n$D$ 的方差是 $\\text{Var}(D) = \\text{Var}(X_1) + \\text{Var}(-X_0) = \\text{Var}(X_1) + (-1)^2 \\text{Var}(X_0) = \\sigma^2 + \\sigma^2 = 2\\sigma^2$。\n所以，$D \\sim \\mathcal{N}(\\mu_1 - \\mu_0, 2\\sigma^2)$。\n\n我们需要计算 $\\mathbb{P}(D  0)$。为此，我们对变量 $D$ 进行标准化：\n$$\\mathbb{P}(D  0) = \\mathbb{P}\\left(\\frac{D - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}  \\frac{0 - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}\\right)$$\n设 $Z = \\frac{D - \\mathbb{E}[D]}{\\sqrt{\\text{Var}(D)}}$，其中 $Z \\sim \\mathcal{N}(0,1)$ 是一个标准正态变量。\n$$\\mathbb{P}(D  0) = \\mathbb{P}\\left(Z  \\frac{-(\\mu_1 - \\mu_0)}{\\sqrt{2\\sigma^2}}\\right) = \\mathbb{P}\\left(Z  -\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)$$\n根据标准正态分布的对称性，$\\mathbb{P}(Z  -z) = \\mathbb{P}(Z  z)$。设 $\\Phi(z)$ 为标准正态分布的累积分布函数 (CDF)。\n$$\\text{AUROC} = \\mathbb{P}\\left(Z  \\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right) = \\Phi\\left(\\frac{\\mu_1 - \\mu_0}{\\sigma\\sqrt{2}}\\right)$$\n\n现在，我们代入给定的数值：$\\mu_1 = 0.1$，$\\mu_0 = 0$，$\\sigma = 1$。\n$$\\text{AUROC} = \\Phi\\left(\\frac{0.1 - 0}{1 \\cdot \\sqrt{2}}\\right) = \\Phi\\left(\\frac{0.1}{\\sqrt{2}}\\right)$$\n数值上，自变量是 $\\frac{0.1}{\\sqrt{2}} \\approx 0.070710678$。\n在此值处计算标准正态 CDF 得到：\n$$\\text{AUROC} = \\Phi(0.070710678) \\approx 0.528186$$\n四舍五入到四位有效数字，我们得到 $0.5282$。\n\n**解释**\n\n问题指出模型是完美校准的。这是通过构造得出的：得分 $s(x)$ 被定义为真实的条件概率 $\\mathbb{P}(Y=1 \\mid X=x)$。这意味着对于任何一组模型输出得分为（例如）$s=0.05$ 的患者，这些患者中将发展为败血症的真实比例恰好是 $5\\%$。校准度衡量模型概率输出的可靠性。\n\n计算出的 AUROC 约为 $0.5282$。AUROC 是衡量模型**区分能力**的指标，即其区分阳性类别和阴性类别的能力。AUROC 为 $1.0$ 意味着完美区分，而 AUROC 为 $0.5$ 则意味着模型的区分能力不比随机猜测好。我们得到的值 $0.5282$ 非常接近 $0.5$，表明其区分能力非常差。在将随机选择的败血症患者的排名排在随机选择的非败血症患者之前这一点上，该模型仅比抛硬币稍好一点。\n\n这个结果展示了模型评估中的一个关键原则：**完美的校准度并不意味着良好的区分能力**。区分能力差的根本原因在于数据生成机制本身。类别条件分布 $\\mathcal{N}(0.1, 1)$ 和 $\\mathcal{N}(0, 1)$ 是“弱可分的”，因为它们的均值（$\\mu_1=0.1, \\mu_0=0$）相对于它们的标准差（$\\sigma=1$）非常接近。这导致败血症患者和非败血症患者的生物标志物数值之间存在大量重叠，使得仅根据生物标志物 $X$ 本身就很难区分这两个群体。严重的类别不平衡（$p=0.01$）进一步意味着，无论结果如何，大多数患者的生物标志物值都很低，这使得区分变得具有挑战性。\n\n模型正确地学习了生物标志物和结果之间真实的（但有限的）关系，从而产生了完全可靠的概率得分。然而，由于数据中的内在信号如此之弱，这些可靠的概率无法有效地分离类别，导致 AUROC 值很低。这种情况在医学中很常见，其中风险因素可能具有统计学意义，但效应量很小，从而导致模型虽然经过校准，但区分能力不强。",
            "answer": "$$\\boxed{0.5282}$$"
        },
        {
            "introduction": "当机器学习模型被用于像决定患者是否应转入重症监护室（ICU）这样的高风险决策时，透明度和可解释性变得至关重要。仅仅知道模型“为什么”做出某个决定是不够的，临床医生和患者更关心“如何做”才能改变这个结果。本练习将带领你构建一个强大的解释工具，用于生成“反事实解释”（counterfactual explanations），即在遵守临床合理性约束的前提下，找到能够逆转模型预测结果的最小特征改动 。这种方法不仅揭示了模型的决策逻辑，更提供了具有实际指导意义的可行建议。",
            "id": "4841103",
            "problem": "在医疗保健场景中，您将获得一个用于重症监护室（ICU）转诊的二元决策模型，该模型由一个逻辑回归分类器表示。该模型根据逻辑函数 $\\sigma(z) = \\frac{1}{1 + e^{-z}}$ 输出接受概率，其中 $z = \\mathbf{w}^\\top \\mathbf{x} + b$。当 $\\sigma(z) \\geq 0.5$ 时，转诊被接受，这等同于阈值条件 $\\mathbf{w}^\\top \\mathbf{x} + b \\geq 0$。反事实解释是一个经过最小程度改变的特征向量 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$，它在遵守临床合理性约束的同时，将拒绝的决策翻转为接受。\n\n在以下基于临床的约束条件下，构建对输入特征进行最小程度改变的反事实解释：\n- 不可变特征：某些特征完全不能被改变。\n- 单调方向约束：某些特征只能增加（例如，提高氧饱和度），而其他特征只能减少（例如，降低乳酸）。\n- 生理学上合理的范围：每个特征在改变后必须保持在预定义的下限和上限之内。\n\n形式上，给定一个患者特征向量 $\\mathbf{x} \\in \\mathbb{R}^n$，找到一个 $\\boldsymbol{\\delta} \\in \\mathbb{R}^n$ 来解决以下约束最小化问题\n$$\n\\begin{aligned}\n\\min_{\\boldsymbol{\\delta}} \\quad  \\|\\boldsymbol{\\delta}\\|_2 \\\\\n\\text{约束条件} \\quad  \\mathbf{w}^\\top(\\mathbf{x} + \\boldsymbol{\\delta}) + b \\geq 0, \\\\\n x_i + \\delta_i \\in [\\ell_i, u_i] \\quad \\forall i \\in \\{1,\\dots,n\\}, \\\\\n \\delta_i = 0 \\quad \\text{如果特征 } i \\text{ 是不可变的}, \\\\\n \\delta_i \\geq 0 \\quad \\text{如果特征 } i \\text{ 被限制为只能增加}, \\\\\n \\delta_i \\leq 0 \\quad \\text{如果特征 } i \\text{ 被限制为只能减少}.\n\\end{aligned}\n$$\n使用以下模型参数、特征顺序和约束。所有特征都归一化到区间 $[0,1]$。\n\n特征顺序和含义（已归一化）：\n$1$: 年龄（不可变），$2$: 合并症指数（不可变），$3$: 心率（仅限减少），$4$: 氧饱和度（仅限增加），$5$: 乳酸（仅限减少），$6$: 平均动脉压（仅限增加），$7$: 尿量（仅限增加），$8$: 吸入氧分数（仅限减少）。\n\n模型参数：\n$\\mathbf{w} = [-1.0,-0.8,-0.5,0.9,-1.2,1.0,0.7,-0.9]$ 和 $b = -0.4$。\n\n生理学上合理的范围（每个特征的下限和上限）：\n$\\boldsymbol{\\ell} = [0.0, 0.0, 0.3, 0.85, 0.0, 0.4, 0.2, 0.3]$，$\\boldsymbol{u} = [1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.9, 0.9]$。\n\n单调方向和不可变性：\n- 不可变：特征 $1$ 和 $2$ 满足 $\\delta_1 = 0$ 和 $\\delta_2 = 0$。\n- 仅限减少：特征 $3$、 $5$、 $8$ 满足 $\\delta_3 \\leq 0$、 $\\delta_5 \\leq 0$、 $\\delta_8 \\leq 0$。\n- 仅限增加：特征 $4$、 $6$、 $7$ 满足 $\\delta_4 \\geq 0$、 $\\delta_6 \\geq 0$、 $\\delta_7 \\geq 0$。\n\n患者特征向量 $\\mathbf{x}$ 的测试套件：\n- 案例 $1$（被拒绝但接近阈值）：$\\mathbf{x}^{(1)} = [0.6, 0.5, 0.6, 0.95, 0.4, 0.6, 0.5, 0.4]$。\n- 案例 $2$（已被接受）：$\\mathbf{x}^{(2)} = [0.3, 0.2, 0.5, 0.98, 0.2, 0.8, 0.7, 0.3]$。\n- 案例 $3$（被拒绝且可能不可行）：$\\mathbf{x}^{(3)} = [0.95, 0.9, 0.8, 0.88, 0.95, 0.5, 0.3, 0.85]$。\n\n对于每种情况，您的程序必须计算一个满足上述约束的反事实特征向量 $\\mathbf{x}_{\\mathrm{cf}}$，该向量通过最小程度地改变 $\\mathbf{x}$ 来获得接受结果。如果患者已被接受，则返回原始的 $\\mathbf{x}$。如果在约束条件下不存在可行的反事实，则为该案例返回一个空列表。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。列表中的每个元素要么是一个代表案例 $\\mathbf{x}_{\\mathrm{cf}}$ 的浮点数方括号列表，要么在不可行时是一个空列表，例如 $[[x_{1},\\dots,x_{8}],[],[x_{1},\\dots,x_{8}]]$. 不应打印任何其他文本。",
            "solution": "该问题要求为在临床决策环境中使用的逻辑回归模型计算一个反事实解释 $\\mathbf{x}_{\\mathrm{cf}}$。反事实解释是原始特征向量 $\\mathbf{x}$ 的一个最小扰动版本，记为 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$，它在满足一系列合理性约束的条件下，将模型的预测结果从“拒绝”变为“接受”。目标是找到具有最小欧几里得范数 $\\|\\boldsymbol{\\delta}\\|_2$ 的变化向量 $\\boldsymbol{\\delta}$。\n\n这个问题可以严格地表述为一个约束优化问题。具体来说，它是一个二次规划（Quadratic Program, QP）问题，涉及在线性约束条件下最小化一个二次目标函数。\n\n首先，我们来分析目标函数。目标是最小化欧几里得范数 $\\|\\boldsymbol{\\delta}\\|_2 = \\sqrt{\\sum_{i=1}^n \\delta_i^2}$。最小化这个范数等同于最小化其平方 $\\|\\boldsymbol{\\delta}\\|_2^2 = \\sum_{i=1}^n \\delta_i^2 = \\boldsymbol{\\delta}^\\top \\boldsymbol{\\delta}$，因为平方根函数对于非负值是严格单调的。平方形式是一个凸二次函数，对于标准优化求解器来说更为理想。因此，我们的目标函数是：\n$$\n\\min_{\\boldsymbol{\\delta}} \\quad f(\\boldsymbol{\\delta}) = \\boldsymbol{\\delta}^\\top \\boldsymbol{\\delta}\n$$\n\n接下来，我们形式化这些约束。问题对扰动向量 $\\boldsymbol{\\delta}$ 指定了几种类型的约束。\n\n1.  **决策边界约束**：反事实点 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}$ 必须导致“接受”的决策。当 $\\mathbf{w}^\\top \\mathbf{x}_{\\mathrm{cf}} + b \\geq 0$ 时，模型接受转诊。代入 $\\mathbf{x}_{\\mathrm{cf}}$ 可得：\n    $$\n    \\mathbf{w}^\\top (\\mathbf{x} + \\boldsymbol{\\delta}) + b \\geq 0\n    $$\n    这可以重排为关于 $\\boldsymbol{\\delta}$ 的线性不等式约束：\n    $$\n    \\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -(\\mathbf{w}^\\top \\mathbf{x} + b)\n    $$\n    令 $z = \\mathbf{w}^\\top \\mathbf{x} + b$ 为模型对原始向量 $\\mathbf{x}$ 的线性得分。对于被拒绝的案例，$z  0$。该约束变为 $\\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -z$。这是一个单一的线性不等式约束。\n\n2.  **组合合理性约束**：问题定义了三种特定于特征的约束：生理学上合理的范围、不可变性和单调方向。这些可以组合成一组箱式约束，即向量 $\\boldsymbol{\\delta}$ 的每个分量 $\\delta_i$ 的下限和上限。\n    - 范围约束为 $x_i + \\delta_i \\in [\\ell_i, u_i]$，这意味着 $\\ell_i - x_i \\leq \\delta_i \\leq u_i - x_i$。\n    - 对于不可变特征（$i \\in \\{1, 2\\}$），$\\delta_i = 0$。这将 $\\delta_i$ 的下限和上限都设置为 $0$。因此，$\\delta_i \\in [0, 0]$。\n    - 对于仅限增加的特征（$i \\in \\{4, 6, 7\\}$），$\\delta_i \\geq 0$。这修改了范围约束的下限。最终的界限是 $\\max(\\ell_i - x_i, 0) \\leq \\delta_i \\leq u_i - x_i$。\n    - 对于仅限减少的特征（$i \\in \\{3, 5, 8\\}$），$\\delta_i \\leq 0$。这修改了上限。最终的界限是 $\\ell_i - x_i \\leq \\delta_i \\leq \\min(u_i - x_i, 0)$。\n\n令每个 $\\delta_i$ 的最终下限和上限分别为 $L_i$ 和 $U_i$。完整的优化问题是：\n$$\n\\begin{aligned}\n\\min_{\\boldsymbol{\\delta}} \\quad  \\sum_{i=1}^{8} \\delta_i^2 \\\\\n\\text{约束条件} \\quad  \\mathbf{w}^\\top \\boldsymbol{\\delta} \\geq -(\\mathbf{w}^\\top \\mathbf{x} + b) \\\\\n L_i \\leq \\delta_i \\leq U_i \\quad \\forall i \\in \\{1,\\dots,8\\}\n\\end{aligned}\n$$\n\n对于每个给定的患者向量 $\\mathbf{x}$，解决策略如下：\n1.  首先，评估初始线性得分 $z = \\mathbf{w}^\\top \\mathbf{x} + b$。如果 $z \\geq 0$，则该患者已被分类为“接受”，无需进行反事实解释。返回原始向量 $\\mathbf{x}$。\n2.  如果 $z  0$，则构建优化问题。我们根据给定的 $\\mathbf{x}$、$\\boldsymbol{\\ell}$、$\\boldsymbol{u}$ 和指定的特征约束，为每个 $\\delta_i$ 计算具体的界限 $[L_i, U_i]$。\n3.  使用合适的数值求解器求解得到的 QP 问题。序列最小二乘规划（Sequential Least Squares Programming, SLSQP）方法适用于此任务，因为它可以处理不等式约束和箱式约束。我们使用 `scipy.optimize.minimize` 函数，并指定 `'SLSQP'` 方法。\n4.  求解器的输出决定了结果。如果求解器找到一个可行解（由成功状态指示），则使用最优扰动 $\\boldsymbol{\\delta}^*$ 来计算反事实 $\\mathbf{x}_{\\mathrm{cf}} = \\mathbf{x} + \\boldsymbol{\\delta}^*$。如果约束条件相互不兼容（即可行集为空），求解器将无法找到解。在这种情况下，不存在可行的反事实，并返回一个空列表，正如案例 3 所规定的。这可以通过预先检查箱式约束下 $\\mathbf{w}^\\top\\boldsymbol{\\delta}$ 的最大可能值是否足以满足决策边界要求来验证。对于案例 3，$\\max(\\mathbf{w}^\\top\\boldsymbol{\\delta}) \\approx 2.813$，而要求是 $\\mathbf{w}^\\top\\boldsymbol{\\delta} \\geq 2.873$，这证实了其不可行性。\n实现封装了这一逻辑，遍历每个测试案例并应用适当的程序。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Computes counterfactual explanations for a logistic regression model\n    by solving a constrained quadratic optimization problem.\n    \"\"\"\n    # Model parameters and constraints\n    w = np.array([-1.0, -0.8, -0.5, 0.9, -1.2, 1.0, 0.7, -0.9])\n    b = -0.4\n    \n    # Physiologically plausible ranges (lower and upper bounds)\n    l_bounds = np.array([0.0, 0.0, 0.3, 0.85, 0.0, 0.4, 0.2, 0.3])\n    u_bounds = np.array([1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.9, 0.9])\n    \n    # Feature constraint definitions (0-indexed)\n    immutable_idx = [0, 1]\n    decrease_only_idx = [2, 4, 7]\n    increase_only_idx = [3, 5, 6]\n    \n    # Test suite of patient feature vectors\n    test_cases = [\n        [0.6, 0.5, 0.6, 0.95, 0.4, 0.6, 0.5, 0.4],\n        [0.3, 0.2, 0.5, 0.98, 0.2, 0.8, 0.7, 0.3],\n        [0.95, 0.9, 0.8, 0.88, 0.95, 0.5, 0.3, 0.85],\n    ]\n\n    results = []\n    \n    for x_list in test_cases:\n        x = np.array(x_list)\n        z = w.T @ x + b\n        \n        # Case: Already accepted, no counterfactual needed\n        if z = 0:\n            results.append(x.tolist())\n            continue\n            \n        # Case: Denied, find a counterfactual by solving the optimization problem\n        \n        # 1. Define bounds for the perturbation vector delta\n        delta_bounds = []\n        for i in range(len(x)):\n            # Base bounds from plausible ranges\n            lower_delta = l_bounds[i] - x[i]\n            upper_delta = u_bounds[i] - x[i]\n            \n            if i in immutable_idx:\n                delta_bounds.append((0.0, 0.0))\n            elif i in decrease_only_idx:\n                # delta must be = 0 and within range\n                delta_bounds.append((lower_delta, min(upper_delta, 0.0)))\n            elif i in increase_only_idx:\n                # delta must be >= 0 and within range\n                delta_bounds.append((max(lower_delta, 0.0), upper_delta))\n            else:\n                # Should not be reached given problem definition\n                delta_bounds.append((lower_delta, upper_delta))\n        \n        # 2. Define objective function (||delta||_2^2) and its jacobian\n        objective_fn = lambda delta: np.dot(delta, delta)\n        objective_jac = lambda delta: 2 * delta\n        \n        # 3. Define the linear inequality constraint: w.T @ (x + delta) + b >= 0\n        # This simplifies to: w.T @ delta >= -(w.T @ x + b) which is w.T @ delta >= -z\n        # For scipy's 'ineq' type, which is C(x) >= 0, our function is C(delta) = w.T @ delta + z\n        constraint_fun = lambda delta: w.T @ delta + z\n        constraint_jac = lambda delta: w\n        \n        constraints = [{'type': 'ineq', 'fun': constraint_fun, 'jac': constraint_jac}]\n        \n        # 4. Initial guess for delta\n        delta0 = np.zeros(len(x))\n        \n        # 5. Solve the Quadratic Program\n        opt_result = minimize(\n            fun=objective_fn,\n            x0=delta0,\n            jac=objective_jac,\n            bounds=delta_bounds,\n            constraints=constraints,\n            method='SLSQP'\n        )\n        \n        # 6. Process the result\n        if opt_result.success:\n            delta_sol = opt_result.x\n            x_cf = x + delta_sol\n            results.append(x_cf.tolist())\n        else:\n            # If optimization fails, no feasible counterfactual was found\n            results.append([])\n            \n    # Format the final output string exactly as specified\n    output_parts = []\n    for res in results:\n        if not res:\n            output_parts.append(\"[]\")\n        else:\n            output_parts.append(f\"[{','.join(f'{val:.8f}' for val in res)}]\")\n            \n    final_output_str = f\"[{','.join(output_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}