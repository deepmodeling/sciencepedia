{
    "hands_on_practices": [
        {
            "introduction": "At the heart of many medical digital twins is a pharmacokinetic (PK) model that describes how a drug moves through the body. This exercise grounds you in the fundamentals by asking you to derive a one-compartment PK model from the first principle of mass conservation. Mastering this derivation ensures you understand not just what the model is, but why it takes its form, a crucial step before applying it to predict patient-specific drug concentrations .",
            "id": "4836357",
            "problem": "A hospital deploys a patient-specific computational digital twin to support dose individualization of a small-molecule therapy. For this patient, the twin assumes a one-compartment Pharmacokinetics (PK) model with an Intravenous (IV) bolus at time $t=0$ and first-order elimination. The twin represents the body as a single, instantaneously and homogeneously mixed compartment with volume of distribution $V$, drug amount in the body $A(t)$, plasma concentration $C(t)$ related by $C(t)=A(t)/V$, and uses the clinical definition of clearance $CL$ as the proportionality constant between concentration and elimination rate under well-mixed conditions.\n\nStarting only from (i) conservation of mass for the drug in the compartment, and (ii) the definition of clearance as elimination rate equal to $CL$ times concentration, derive a closed-form expression for $C(t)$ for $t \\ge 0$ after an IV bolus dose $D$ is administered at $t=0$.\n\nThen, the digital twin estimates $V$ and $CL$ for this patient as $V=40$ L and $CL=3.0$ L/h. A single IV bolus dose of $D=500$ mg is given at $t=0$. Using your derived expression, compute the model-predicted plasma concentration $C(t)$ at $t=2$ h. Round your answer to three significant figures. Express the final concentration in mg/L.",
            "solution": "The problem is valid as it is scientifically grounded in standard pharmacokinetic principles, well-posed with a complete and consistent set of definitions and data, and objectively stated.\n\nThe solution requires two steps. First, the derivation of a closed-form expression for the plasma concentration $C(t)$. Second, the calculation of a numerical value for the concentration at a specified time using the derived expression.\n\nThe derivation begins from the principle of conservation of mass for the drug within the single, well-mixed compartment. The rate of change of the amount of drug, $A(t)$, is the rate of administration minus the rate of elimination:\n$$\n\\frac{dA(t)}{dt} = \\text{Rate In} - \\text{Rate Out}\n$$\nFor an intravenous (IV) bolus dose given at time $t=0$, the administration rate is zero for any subsequent time $t>0$.\n$$\n\\text{Rate In} = 0 \\quad (\\text{for } t>0)\n$$\nThe problem defines the elimination rate as the product of clearance, $CL$, and plasma concentration, $C(t)$.\n$$\n\\text{Rate Out} = CL \\cdot C(t)\n$$\nCombining these gives the mass balance equation:\n$$\n\\frac{dA(t)}{dt} = -CL \\cdot C(t)\n$$\nThe relationship between drug amount $A(t)$, concentration $C(t)$, and volume of distribution $V$ is given as $C(t) = \\frac{A(t)}{V}$. Substituting this into the mass balance equation allows us to express it entirely in terms of $A(t)$:\n$$\n\\frac{dA(t)}{dt} = -CL \\cdot \\frac{A(t)}{V} = -\\left(\\frac{CL}{V}\\right)A(t)\n$$\nThis is a first-order, linear, homogeneous ordinary differential equation. The term $\\left(\\frac{CL}{V}\\right)$ represents the first-order elimination rate constant, which can be denoted as $k_e$. The equation to solve is thus $\\frac{dA(t)}{dt} = -k_e A(t)$.\n\nAn initial condition is required. At $t=0$, a bolus dose $D$ is administered and instantaneously distributes in the volume $V$. Thus, the initial amount of drug in the body is $A(0) = D$. The solution to this initial value problem is found by separation of variables:\n$$\n\\int_{A(0)}^{A(t)} \\frac{dA}{A} = \\int_{0}^{t} -k_e d\\tau \\implies \\ln\\left(\\frac{A(t)}{A(0)}\\right) = -k_e t\n$$\nSolving for $A(t)$ by exponentiating both sides yields:\n$$\nA(t) = A(0) \\exp(-k_e t)\n$$\nSubstituting $A(0)=D$ and $k_e = \\frac{CL}{V}$, we get the amount of drug over time:\n$$\nA(t) = D \\exp\\left(-\\frac{CL}{V} t\\right)\n$$\nThe problem asks for the concentration profile $C(t)$. Using $C(t) = \\frac{A(t)}{V}$, we obtain the final closed-form expression:\n$$\nC(t) = \\frac{D}{V} \\exp\\left(-\\frac{CL}{V} t\\right)\n$$\nThis equation describes the plasma concentration at any time $t \\ge 0$.\n\nFor the second part of the problem, we compute the concentration at a specific time using the given parameters. The parameters are: dose $D=500$ mg, volume of distribution $V=40$ L, and clearance $CL=3.0$ L/h. We need to find the concentration $C(t)$ at time $t=2$ h.\n\nThe units of the parameters are consistent. The ratio $\\frac{D}{V}$ has units of mg/L. The exponent term must be dimensionless; the elimination rate constant $k_e = \\frac{CL}{V}$ has units of $\\frac{\\text{L/h}}{\\text{L}} = \\text{h}^{-1}$, which when multiplied by time $t$ in hours, results in a dimensionless quantity. The final concentration will be in mg/L.\n\nWe substitute the numerical values into the derived expression:\n$$\nC(2) = \\frac{500}{40} \\exp\\left(-\\frac{3.0}{40} \\times 2\\right)\n$$\nFirst, calculate the initial concentration $C(0) = \\frac{D}{V}$:\n$$\nC(0) = \\frac{500}{40} = 12.5\n$$\nNext, calculate the value of the exponent:\n$$\n-\\frac{CL}{V} t = -\\frac{3.0}{40} \\times 2 = -0.075 \\times 2 = -0.15\n$$\nNow, substitute these calculated parts back into the main equation:\n$$\nC(2) = 12.5 \\times \\exp(-0.15)\n$$\nEvaluating the exponential function:\n$$\n\\exp(-0.15) \\approx 0.860707976\n$$\nFinally, we compute the concentration at $t=2$ h:\n$$\nC(2) \\approx 12.5 \\times 0.860707976 \\approx 10.7588497\n$$\nThe problem specifies that the answer should be rounded to three significant figures. Rounding $10.7588497$ to three significant figures gives $10.8$.",
            "answer": "$$\\boxed{10.8}$$"
        },
        {
            "introduction": "A digital twin is only as reliable as the assumptions it is built upon, and mathematical models must respect the underlying physiological reality. This practice shifts focus from calculation to critical evaluation, using the fundamental relationship between cardiac output ($CO$), heart rate ($HR$), and stroke volume ($SV$) as a case study. By learning to identify and reject assumptions that violate physiological constraints, you develop the essential skill of model validation, ensuring your digital twin behaves plausibly and safely .",
            "id": "4836326",
            "problem": "A hospital deploys a patient-specific Digital Twin (DT) of the cardiovascular system to support closed-loop therapy. The DT must estimate cardiac output $CO$ from streaming sensors that yield heart rate $HR$ and stroke volume $SV$ in near real-time. The modeling team insists the DT start from a fundamental mechanistic base so that constraints are transparent and can be enforced. Use the following fundamental definitions and laws to construct the minimal mechanistic model linking $CO$ to $HR$ and $SV$, and then evaluate assumption sets for physiological validity.\n\nThe fundamental base you may use for your construction is:\n- The definition of instantaneous volumetric flow rate $Q(t)$ as the time rate of change of volume through the aortic valve, and the one-minute average cardiac output $CO$ as $CO = \\dfrac{1}{\\Delta t} \\displaystyle\\int_{0}^{\\Delta t} Q(t)\\,dt$ with $\\Delta t = 60$ seconds.\n- The definition of heart rate $HR$ as beats per unit time, $HR = \\dfrac{N}{\\Delta t}$, where $N$ is the number of heartbeats over the interval $\\Delta t$.\n- The definition of stroke volume $SV$ for a single beat as the net ejected volume during that beat, $SV = \\displaystyle\\int_{\\text{one beat}} Q(t)\\,dt$.\n- Conservation of mass in a closed circulatory loop under steady-state conditions, which requires equality of flows: $CO = VR$, where $VR$ is venous return to the left heart in steady state.\n\nStarting only from these bases, construct the minimal mechanistic model that expresses $CO$ as a function of $HR$ and $SV$. Then, consider the following assumption sets that analysts may impose on the constructed model within the DT. Select all sets that would cause the model to violate physiological constraints.\n\nA. Assume $SV$ is constant and independent of $HR$, permit $HR$ to take any positive real value without bound, and allow $SV$ to exceed the End-Diastolic Volume $V_{\\text{ED}}$.\n\nB. Impose $SV \\le V_{\\text{ED}} - V_{\\text{ES}}$, where $V_{\\text{ES}}$ is End-Systolic Volume, bound heart rate by a refractory-period limit $HR \\le \\dfrac{1}{t_{\\text{ref}}}$ for some $t_{\\text{ref}} > 0$, and enforce $CO = VR$ in steady state.\n\nC. Let $SV(HR) = S_0 - k\\,HR$ with $S_0 > 0$ and $k > 0$ for all $HR$ and do not impose any non-negativity constraint on $SV$.\n\nD. Model arrhythmias by assuming a fraction $n$ of beats are non-ejecting with $0 \\le n < 1$, so the effective heart rate is $HR_{\\text{eff}} = (1-n)\\,HR$, with $SV \\ge 0$, $HR \\le \\dfrac{1}{t_{\\text{ref}}}$, and $CO = VR$ in steady state.\n\nE. In steady state, allow $CO$ to exceed venous return by a fixed margin: $CO = VR + \\delta$ with $\\delta > 0$.\n\nSelect all correct options.",
            "solution": "The problem requires a two-step process: first, to derive the minimal mechanistic model for cardiac output ($CO$) based on the provided fundamental definitions, and second, to evaluate several sets of assumptions for physiological validity.\n\n**Part 1: Derivation of the Minimal Mechanistic Model**\n\nThe problem provides the following definitions and principles:\n1.  Average cardiac output: $CO = \\dfrac{1}{\\Delta t} \\displaystyle\\int_{0}^{\\Delta t} Q(t)\\,dt$ with $\\Delta t = 60$ seconds.\n2.  Heart rate: $HR = \\dfrac{N}{\\Delta t}$, where $N$ is the number of beats in the interval $\\Delta t$.\n3.  Stroke volume: $SV = \\displaystyle\\int_{\\text{one beat}} Q(t)\\,dt$.\n\nWe begin with the definition of average cardiac output over the interval $\\Delta t$.\n$$CO = \\dfrac{1}{\\Delta t} \\int_{0}^{\\Delta t} Q(t)\\,dt$$\nThe total integral of flow over the interval $\\Delta t$ can be expressed as the sum of the integrals of flow over each of the $N$ individual heartbeats that occur within that interval.\n$$\\int_{0}^{\\Delta t} Q(t)\\,dt = \\sum_{i=1}^{N} \\left( \\int_{\\text{beat}_i} Q(t)\\,dt \\right)$$\nAccording to definition 3, the integral of flow over a single beat is the stroke volume, $SV$. For this derivation, we can either assume that the stroke volume is constant for each beat within the interval $\\Delta t$, or we can define $SV$ as the *average* stroke volume over the interval. In either case, the sum becomes:\n$$\\sum_{i=1}^{N} \\left( \\int_{\\text{beat}_i} Q(t)\\,dt \\right) = N \\times SV$$\nSubstituting this result back into the equation for $CO$:\n$$CO = \\dfrac{1}{\\Delta t} (N \\times SV)$$\nThis can be rearranged as:\n$$CO = \\left( \\dfrac{N}{\\Delta t} \\right) \\times SV$$\nFrom definition 2, we know that heart rate $HR$ is given by $HR = \\dfrac{N}{\\Delta t}$.\nSubstituting this into the equation for $CO$ yields the minimal mechanistic model:\n$$CO = HR \\times SV$$\nThis fundamental relationship connects cardiac output to heart rate and stroke volume.\n\n**Part 2: Evaluation of Assumption Sets**\n\nThe task is to identify which of the following assumption sets would cause the model to violate physiological constraints.\n\n**Option A:** Assume $SV$ is constant and independent of $HR$, permit $HR$ to take any positive real value without bound, and allow $SV$ to exceed the End-Diastolic Volume $V_{\\text{ED}}$.\n\nThis set contains multiple physiological violations.\n1.  **Unbounded Heart Rate ($HR$)**: The heart rate is physiologically limited. The refractory period of myocardial cells and the conduction delay of the atrioventricular (AV) node impose an upper limit on how fast the heart can beat. A typical maximum heart rate for a young adult is around $220$ beats per minute, and it declines with age. Allowing $HR$ to be unbounded (e.g., $HR \\to \\infty$) is a physical impossibility.\n2.  **Stroke Volume ($SV$) Exceeding End-Diastolic Volume ($V_{\\text{ED}}$)**: Stroke volume is the volume of blood ejected from a ventricle during one contraction. It is defined as the difference between the End-Diastolic Volume ($V_{\\text{ED}}$, the volume of blood in the ventricle at the end of filling) and the End-Systolic Volume ($V_{\\text{ES}}$, the volume of blood remaining after ejection). That is, $SV = V_{\\text{ED}} - V_{\\text{ES}}$. Since the remaining volume $V_{\\text{ES}}$ must be non-negative ($V_{\\text{ES}} \\ge 0$), it is a direct consequence that $SV \\le V_{\\text{ED}}$. It is physically impossible for the ventricle to eject more blood than it contains at its fullest.\nTherefore, this assumption set introduces at least two fundamental violations of physiological constraints.\n\nVerdict on A: **Correct**.\n\n**Option B:** Impose $SV \\le V_{\\text{ED}} - V_{\\text{ES}}$, where $V_{\\text{ES}}$ is End-Systolic Volume, bound heart rate by a refractory-period limit $HR \\le \\dfrac{1}{t_{\\text{ref}}}$ for some $t_{\\text{ref}} > 0$, and enforce $CO = VR$ in steady state.\n\nThis set describes constraints that make the model *more* physiologically realistic.\n1.  **$SV \\le V_{\\text{ED}} - V_{\\text{ES}}$**: The strict physiological definition is $SV = V_{\\text{ED}} - V_{\\text{ES}}$. The use of \"$\\le$\" is slightly imprecise but does not introduce a violation; it correctly bounds the stroke volume. More importantly, this implies $SV \\le V_{\\text{ED}}$, which is a valid constraint.\n2.  **$HR \\le \\dfrac{1}{t_{\\text{ref}}}$**: This correctly imposes a biophysical upper limit on the heart rate based on the myocardial refractory period $t_{\\text{ref}}$.\n3.  **$CO = VR$ in steady state**: This is a statement of the conservation of mass for a closed circulatory system in steady state, a fundamental principle of physiology also provided in the problem statement.\nAll constraints in this set are physiologically valid and necessary for a realistic model. They do not cause a violation.\n\nVerdict on B: **Incorrect**.\n\n**Option C:** Let $SV(HR) = S_0 - k\\,HR$ with $S_0 > 0$ and $k > 0$ for all $HR$ and do not impose any non-negativity constraint on $SV$.\n\nThis set presents a simplified linear model for the relationship between $SV$ and $HR$. While the inverse relationship is qualitatively correct (at high heart rates, filling time decreases, thus reducing $SV$), the lack of a non-negativity constraint is a critical flaw.\n1.  **Possibility of Negative Stroke Volume**: Stroke volume is a physical volume and cannot be negative. The model $SV(HR) = S_0 - k\\,HR$ will predict a negative stroke volume for any heart rate $HR > \\dfrac{S_0}{k}$. Since the assumption states this model holds \"for all $HR$\" and heart rate is physiologically allowed to vary over a wide range, there will exist a physiologically attainable heart rate for which the model predicts $SV < 0$. A negative stroke volume would imply blood flowing backward from the aorta into the ventricle during systole, which is a physical and physiological impossibility. The absence of a non-negativity constraint ($SV \\ge 0$) makes this model invalid.\n\nVerdict on C: **Correct**.\n\n**Option D:** Model arrhythmias by assuming a fraction $n$ of beats are non-ejecting with $0 \\le n < 1$, so the effective heart rate is $HR_{\\text{eff}} = (1-n)\\,HR$, with $SV \\ge 0$, $HR \\le \\dfrac{1}{t_{\\text{ref}}}$, and $CO = VR$ in steady state.\n\nThis set describes a more advanced, but physiologically plausible, model for certain types of arrhythmias where some electrical activations of the heart do not result in effective mechanical contractions (e.g., some premature ventricular contractions).\n1.  **Effective Heart Rate ($HR_{\\text{eff}}$)**: The concept of an effective heart rate that contributes to cardiac output is a valid way to model such phenomena. The resulting cardiac output would be $CO = HR_{\\text{eff}} \\times SV = (1-n) \\times HR \\times SV$.\n2.  **$SV \\ge 0$**: This is a valid and necessary physiological constraint.\n3.  **$HR \\le \\dfrac{1}{t_{\\text{ref}}}$**: This is a valid biophysical limit.\n4.  **$CO = VR$**: This is the correct steady-state condition.\nThis set of assumptions builds a physiologically reasonable, though simplified, model. It does not introduce violations.\n\nVerdict on D: **Incorrect**.\n\n**Option E:** In steady state, allow $CO$ to exceed venous return by a fixed margin: $CO = VR + \\delta$ with $\\delta > 0$.\n\nThis assumption directly violates a fundamental principle of physics and physiology for a closed system in steady state.\n1.  **Violation of Conservation of Mass**: The circulatory system is a closed loop. In a steady state, the rate of flow out of any component must equal the rate of flow into it. The left heart pumps blood out to the body ($CO$), and this blood eventually returns to the heart as venous return ($VR$). For the system to be in steady state, the volume of blood in the arterial and venous compartments must remain constant over time. This requires that the flow out of the heart equals the flow into the heart, i.e., $CO = VR$. The assumption $CO = VR + \\delta$ with $\\delta > 0$ means that more blood is leaving the heart per unit time than is returning. This would cause a continuous depletion of blood from the venous side and a continuous accumulation on the arterial side, a catastrophic and non-steady-state condition. This violates the principle of conservation of mass, which was explicitly provided as a valid basis.\n\nVerdict on E: **Correct**.\n\nIn summary, assumption sets A, C, and E would cause the model to violate fundamental physiological and physical constraints.",
            "answer": "$$\\boxed{ACE}$$"
        },
        {
            "introduction": "The ultimate goal of a medical digital twin is often to provide decision support, such as personalizing a therapy regimen, which requires integrating models into a practical, goal-oriented workflow. This exercise challenges you to build a complete optimization engine that couples a PK model with a pharmacodynamic (PD) objectiveâ€”minimizing toxicity while achieving a therapeutic target. By creating a program that simulates different dosing strategies and selects the best one, you will gain hands-on experience with the core components of a decision-making digital twin, bridging the gap from theory to application .",
            "id": "4836348",
            "problem": "You are building a simplified patient-specific digital twin that couples Pharmacokinetics (PK) and Pharmacodynamics (PD) to design an intravenous bolus dosing regimen. The PK is modeled as a one-compartment system with first-order elimination, and the PD toxicity surrogate is the total time that the concentration exceeds a toxicity threshold. The goal is to choose a dosing regimen that achieves a target exposure band while minimizing toxicity, subject to dosing constraints, for multiple patient-specific digital twins.\n\nFundamental base and core definitions:\n- The drug amount in the central compartment, denoted by $A(t)$ in $\\mathrm{mg}$, follows the mass balance Ordinary Differential Equation (ODE): $$\\frac{dA}{dt} = -k \\, A(t),$$ where $k = \\frac{\\mathrm{CL}}{V}$ in $\\mathrm{h}^{-1}$ is the first-order elimination rate constant, $\\mathrm{CL}$ is clearance in $\\mathrm{L}/\\mathrm{h}$, and $V$ is volume of distribution in $\\mathrm{L}$. The concentration is $C(t) = \\frac{A(t)}{V}$ in $\\mathrm{mg}/\\mathrm{L}$.\n- Intravenous bolus dosing at time $t = t_d$ instantaneously increases the amount by $D$ in $\\mathrm{mg}$, so that $A(t_d^+) = A(t_d^-) + D$. Equivalently, $C(t_d^+) = C(t_d^-) + \\frac{D}{V}$.\n- Exposure is quantified by the area under the concentration-time curve: $$\\mathrm{AUC}_{[0,T]} = \\int_{0}^{T} C(t) \\, dt,$$ in $\\mathrm{mg}\\cdot\\mathrm{h}/\\mathrm{L}$.\n- Toxicity surrogate is the time-above-toxicity-threshold: $$\\mathrm{TAT}_{[0,T]} = \\int_{0}^{T} \\mathbb{1}\\!\\left(C(t) > C_{\\mathrm{tox}}\\right) \\, dt,$$ in $\\mathrm{h}$, where $\\mathbb{1}(\\cdot)$ is the indicator function and $C_{\\mathrm{tox}}$ is the toxicity threshold in $\\mathrm{mg}/\\mathrm{L}$.\n\nDesign task:\n- Consider a finite dosing regimen defined by per-dose amount $D$ in $\\mathrm{mg}$, an inter-dose interval $\\tau$ in $\\mathrm{h}$, and a number of doses $N$ (a positive integer). Doses occur at times $t = 0, \\tau, 2\\tau, \\ldots, (N-1)\\tau$.\n- The simulation horizon is $$T_{\\mathrm{end}} = N \\tau + T_{\\mathrm{tail}},$$ where $T_{\\mathrm{tail}}$ in $\\mathrm{h}$ is specified per patient to capture the elimination tail after the last dose.\n- The primary objective is to minimize $\\mathrm{TAT}_{[0,T_{\\mathrm{end}}]}$ subject to the exposure (AUC) constraint $$\\mathrm{AUC}_{\\min} \\le \\mathrm{AUC}_{[0,T_{\\mathrm{end}}]} \\le \\mathrm{AUC}_{\\max}.$$ If multiple regimens satisfy the AUC constraint with identical $\\mathrm{TAT}$ (to numerical tolerance), choose the one with the smallest total administered dose $D_{\\mathrm{tot}} = N D$. If still tied, prefer the regimen with the largest $\\tau$.\n- If no regimen satisfies the AUC constraint, pick the regimen that minimizes the absolute deviation from the target band center, i.e., $$\\left| \\mathrm{AUC}_{[0,T_{\\mathrm{end}}]} - \\frac{\\mathrm{AUC}_{\\min} + \\mathrm{AUC}_{\\max}}{2} \\right|,$$ and use $\\mathrm{TAT}$ and then $D_{\\mathrm{tot}}$ and then $\\tau$ as tie-breakers in that order.\n- Dosing constraints: maximum daily dosing rate constraint $$D \\cdot \\frac{24}{\\tau} \\le D_{\\mathrm{daily, max}},$$ in $\\mathrm{mg}/\\mathrm{day}$, in addition to explicit feasible sets for $D$, $\\tau$, and $N$ given below.\n\nNumerical simulation requirement:\n- Use a fixed-step forward simulation to approximate $C(t)$, $\\mathrm{AUC}$, and $\\mathrm{TAT}$ over $[0, T_{\\mathrm{end}}]$. Choose a fixed time step $\\Delta t$ in $\\mathrm{h}$ and update by the exact decay over a step: if no dose occurs within the step, $C(t + \\Delta t) = C(t) \\exp(-k \\Delta t)$. Apply bolus doses at step boundaries when $t$ matches a scheduled dosing time. Use the rectangle rule for numerical integration of $\\mathrm{AUC}$ and $\\mathrm{TAT}$ over each step.\n\nTest suite:\nImplement your program to solve the optimization problem for the following four patient-specific digital twins. For each case, all units must be interpreted exactly as specified, and your program must compute and return the optimized regimen and associated metrics.\n\n- Case $1$:\n  - $\\mathrm{CL} = 5 \\ \\mathrm{L}/\\mathrm{h}$, $V = 50 \\ \\mathrm{L}$, $C_{\\mathrm{tox}} = 8 \\ \\mathrm{mg}/\\mathrm{L}$.\n  - Allowed per-dose amounts $D \\in \\{100, 200, 300, 400, 500\\}$ in $\\mathrm{mg}$.\n  - Allowed inter-dose intervals $\\tau \\in \\{12, 24\\}$ in $\\mathrm{h}$.\n  - Allowed number of doses $N \\in \\{2, 3, 4\\}$.\n  - Daily dosing limit $D_{\\mathrm{daily, max}} = 800$ in $\\mathrm{mg}/\\mathrm{day}$.\n  - Exposure target band: $\\mathrm{AUC}_{\\min} = 60$, $\\mathrm{AUC}_{\\max} = 80$ in $\\mathrm{mg}\\cdot\\mathrm{h}/\\mathrm{L}$.\n  - Tail time $T_{\\mathrm{tail}} = 48$ in $\\mathrm{h}$.\n- Case $2$:\n  - $\\mathrm{CL} = 12 \\ \\mathrm{L}/\\mathrm{h}$, $V = 40 \\ \\mathrm{L}$, $C_{\\mathrm{tox}} = 7 \\ \\mathrm{mg}/\\mathrm{L}$.\n  - Allowed per-dose amounts $D \\in \\{100, 200, 300, 400, 500\\}$ in $\\mathrm{mg}$.\n  - Allowed inter-dose intervals $\\tau \\in \\{8, 12\\}$ in $\\mathrm{h}$.\n  - Allowed number of doses $N \\in \\{3, 4\\}$.\n  - Daily dosing limit $D_{\\mathrm{daily, max}} = 1000$ in $\\mathrm{mg}/\\mathrm{day}$.\n  - Exposure target band: $\\mathrm{AUC}_{\\min} = 80$, $\\mathrm{AUC}_{\\max} = 100$ in $\\mathrm{mg}\\cdot\\mathrm{h}/\\mathrm{L}$.\n  - Tail time $T_{\\mathrm{tail}} = 48$ in $\\mathrm{h}$.\n- Case $3$:\n  - $\\mathrm{CL} = 6 \\ \\mathrm{L}/\\mathrm{h}$, $V = 20 \\ \\mathrm{L}$, $C_{\\mathrm{tox}} = 9 \\ \\mathrm{mg}/\\mathrm{L}$.\n  - Allowed per-dose amounts $D \\in \\{100, 200, 300, 400, 500\\}$ in $\\mathrm{mg}$.\n  - Allowed inter-dose intervals $\\tau \\in \\{8, 12, 24\\}$ in $\\mathrm{h}$.\n  - Allowed number of doses $N \\in \\{2, 3, 4\\}$.\n  - Daily dosing limit $D_{\\mathrm{daily, max}} = 800$ in $\\mathrm{mg}/\\mathrm{day}$.\n  - Exposure target band: $\\mathrm{AUC}_{\\min} = 50$, $\\mathrm{AUC}_{\\max} = 60$ in $\\mathrm{mg}\\cdot\\mathrm{h}/\\mathrm{L}$.\n  - Tail time $T_{\\mathrm{tail}} = 48$ in $\\mathrm{h}$.\n- Case $4$:\n  - $\\mathrm{CL} = 2 \\ \\mathrm{L}/\\mathrm{h}$, $V = 60 \\ \\mathrm{L}$, $C_{\\mathrm{tox}} = 6 \\ \\mathrm{mg}/\\mathrm{L}$.\n  - Allowed per-dose amounts $D \\in \\{100, 200, 300, 400, 500\\}$ in $\\mathrm{mg}$.\n  - Allowed inter-dose intervals $\\tau \\in \\{24\\}$ in $\\mathrm{h}$.\n  - Allowed number of doses $N \\in \\{1, 2\\}$.\n  - Daily dosing limit $D_{\\mathrm{daily, max}} = 400$ in $\\mathrm{mg}/\\mathrm{day}$.\n  - Exposure target band: $\\mathrm{AUC}_{\\min} = 50$, $\\mathrm{AUC}_{\\max} = 60$ in $\\mathrm{mg}\\cdot\\mathrm{h}/\\mathrm{L}$.\n  - Tail time $T_{\\mathrm{tail}} = 72$ in $\\mathrm{h}$.\n\nImplementation details:\n- Use a fixed time step $\\Delta t = 0.05$ in $\\mathrm{h}$ for all cases.\n- For each candidate regimen $(D, \\tau, N)$ that satisfies the daily dosing limit, simulate $C(t)$ over $[0, T_{\\mathrm{end}}]$, calculate $\\mathrm{AUC}$ and $\\mathrm{TAT}$, and select the optimal regimen according to the stated objective and tie-breakers.\n- Express all final concentrations in $\\mathrm{mg}/\\mathrm{L}$, times in $\\mathrm{h}$, and doses in $\\mathrm{mg}$.\n- Your program should produce a single line of output containing the results for all four cases as a comma-separated list enclosed in square brackets, where each case is reported as a list of the form $[D, \\tau, N, \\mathrm{AUC}, \\mathrm{TAT}]$. Round $\\mathrm{AUC}$ and $\\mathrm{TAT}$ to three decimal places. For example, a valid output line might look like: $[[200,24,2,75.123,1.500],[\\ldots],\\ldots]$.",
            "solution": "The user-provided problem is a well-posed optimization task in the domain of clinical pharmacokinetics and pharmacodynamics (PK/PD). It is scientifically grounded in established one-compartment PK modeling principles and presents a clear, objective, and solvable problem. All necessary parameters and constraints are provided, making the problem self-contained and free of ambiguity. The task is to find an optimal intravenous bolus dosing regimen by minimizing a toxicity metric while satisfying an exposure target, searching over a finite set of possible regimens.\n\nThe solution methodology involves an exhaustive search over the discrete parameter space of possible dosing regimens, defined by the per-dose amount $D$, the inter-dose interval $\\tau$, and the number of doses $N$. For each patient-specific case, we iterate through all combinations of these three parameters.\n\nFirst, each potential regimen $(D, \\tau, N)$ is validated against the maximum daily dosing rate constraint:\n$$D \\cdot \\frac{24}{\\tau} \\le D_{\\mathrm{daily, max}}$$\nRegimens that violate this constraint are discarded.\n\nFor each valid regimen, a numerical simulation is performed to determine the resulting pharmacokinetic profile and associated metrics. The simulation models the drug concentration in a single compartment, $C(t)$, over the time horizon $[0, T_{\\mathrm{end}}]$, where $T_{\\mathrm{end}} = N \\tau + T_{\\mathrm{tail}}$. The simulation proceeds in discrete time steps of size $\\Delta t = 0.05 \\ \\mathrm{h}$.\n\nThe concentration dynamics are governed by the following rules:\n1.  **First-Order Elimination**: In the absence of a dose, the concentration decays exponentially. The concentration at the end of a time step, $C(t+\\Delta t)$, is related to the concentration at the start, $C(t)$, by:\n    $$C(t + \\Delta t) = C(t) \\exp(-k \\Delta t)$$\n    where $k = \\mathrm{CL}/V$ is the elimination rate constant.\n2.  **Bolus Dosing**: At scheduled dosing times $t_d = 0, \\tau, 2\\tau, \\ldots, (N-1)\\tau$, the concentration is instantaneously increased:\n    $$C(t_d^+) = C(t_d^-) + \\frac{D}{V}$$\n    where $C(t_d^-)$ is the concentration just before the dose and $C(t_d^+)$ is the concentration just after.\n\nDuring the simulation, two key metrics are integrated using the left-rectangle rule:\n1.  **Area Under the Curve (Exposure)**:\n    $$\\mathrm{AUC}_{[0,T_{\\mathrm{end}}]} = \\sum_{i} C(t_i) \\Delta t$$\n2.  **Time Above Toxicity Threshold (Toxicity Surrogate)**:\n    $$\\mathrm{TAT}_{[0,T_{\\mathrm{end}}]} = \\sum_{i} \\mathbb{1}(C(t_i) > C_{\\mathrm{tox}}) \\Delta t$$\n    where $\\mathbb{1}(\\cdot)$ is the indicator function.\n\nAfter simulating all valid regimens for a given patient, the results are collected. The optimal regimen is selected based on a two-tiered objective function:\n\n1.  **Primary Objective**: If there are regimens whose calculated $\\mathrm{AUC}_{[0,T_{\\mathrm{end}}]}$ falls within the target band $[\\mathrm{AUC}_{\\min}, \\mathrm{AUC}_{\\max}]$, the selection is made from this subset. The goal is to find the regimen that minimizes $\\mathrm{TAT}_{[0,T_{\\mathrm{end}}]}}$. Ties are broken by selecting the regimen with the smallest total dose, $D_{\\mathrm{tot}} = N D$, and then by the largest inter-dose interval $\\tau$. This implies sorting the valid regimens by the tuple $(\\mathrm{TAT}, D_{\\mathrm{tot}}, -\\tau)$.\n\n2.  **Secondary Objective**: If no regimen satisfies the $\\mathrm{AUC}$ target, the selection is made from all simulated regimens. The goal is to find the regimen that minimizes the absolute deviation of its $\\mathrm{AUC}$ from the center of the target band, i.e., minimizes $|\\mathrm{AUC}_{[0,T_{\\mathrm{end}}]} - (\\mathrm{AUC}_{\\min} + \\mathrm{AUC}_{\\max})/2|$. Ties are resolved sequentially by minimizing $\\mathrm{TAT}$, then minimizing $D_{\\mathrm{tot}}$, and finally by maximizing $\\tau$. This implies sorting by the tuple $(\\text{deviation}, \\mathrm{TAT}, D_{\\mathrm{tot}}, -\\tau)$.\n\nThis entire procedure is independently applied to each of the four patient-specific cases provided. The final output is a list containing the optimal regimen parameters $(D, \\tau, N)$ and the corresponding calculated metrics $(\\mathrm{AUC}, \\mathrm{TAT})$ for each case, with the metrics rounded to three decimal places.",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(D, tau, N, CL, V, C_tox, T_tail, dt):\n    \"\"\"\n    Simulates a one-compartment PK model for a given dosing regimen.\n\n    Args:\n        D (float): Dose amount (mg).\n        tau (float): Dosing interval (h).\n        N (int): Number of doses.\n        CL (float): Clearance (L/h).\n        V (float): Volume of distribution (L).\n        C_tox (float): Toxicity threshold (mg/L).\n        T_tail (float): Simulation tail time after last dose (h).\n        dt (float): Simulation time step (h).\n\n    Returns:\n        tuple[float, float]: Calculated AUC and TAT.\n    \"\"\"\n    k = CL / V\n    T_end = N * tau + T_tail\n    \n    num_steps = int(round(T_end / dt))\n    # Using a set for efficient lookup of dose time indices\n    dose_indices = {int(round(i * tau / dt)) for i in range(N)}\n    dose_concentration = D / V\n    \n    C_current = 0.0\n    total_auc = 0.0\n    total_tat = 0.0\n    decay_factor = np.exp(-k * dt)\n    \n    # Step-by-step simulation using the exact solution over the interval dt\n    for i in range(num_steps):\n        # Apply dose at the beginning of the step interval\n        if i in dose_indices:\n            C_current += dose_concentration\n        \n        # Accumulate metrics based on the concentration at the start of the interval (left-rectangle rule)\n        total_auc += C_current * dt\n        if C_current > C_tox:\n            total_tat += dt\n            \n        # Calculate concentration for the start of the next step\n        C_current *= decay_factor\n    \n    return total_auc, total_tat\n\ndef solve():\n    \"\"\"\n    Finds the optimal dosing regimen for multiple patient cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"CL\": 5.0, \"V\": 50.0, \"C_tox\": 8.0,\n            \"D_set\": [100, 200, 300, 400, 500],\n            \"tau_set\": [12, 24],\n            \"N_set\": [2, 3, 4],\n            \"D_daily_max\": 800.0,\n            \"AUC_min\": 60.0, \"AUC_max\": 80.0,\n            \"T_tail\": 48.0,\n        },\n        {\n            \"CL\": 12.0, \"V\": 40.0, \"C_tox\": 7.0,\n            \"D_set\": [100, 200, 300, 400, 500],\n            \"tau_set\": [8, 12],\n            \"N_set\": [3, 4],\n            \"D_daily_max\": 1000.0,\n            \"AUC_min\": 80.0, \"AUC_max\": 100.0,\n            \"T_tail\": 48.0,\n        },\n        {\n            \"CL\": 6.0, \"V\": 20.0, \"C_tox\": 9.0,\n            \"D_set\": [100, 200, 300, 400, 500],\n            \"tau_set\": [8, 12, 24],\n            \"N_set\": [2, 3, 4],\n            \"D_daily_max\": 800.0,\n            \"AUC_min\": 50.0, \"AUC_max\": 60.0,\n            \"T_tail\": 48.0,\n        },\n        {\n            \"CL\": 2.0, \"V\": 60.0, \"C_tox\": 6.0,\n            \"D_set\": [100, 200, 300, 400, 500],\n            \"tau_set\": [24],\n            \"N_set\": [1, 2],\n            \"D_daily_max\": 400.0,\n            \"AUC_min\": 50.0, \"AUC_max\": 60.0,\n            \"T_tail\": 72.0,\n        },\n    ]\n\n    dt = 0.05\n    all_final_results = []\n\n    for params in test_cases:\n        candidate_regimens = []\n        \n        # Iterate over the discrete search space for the regimen\n        for D in params[\"D_set\"]:\n            for tau in params[\"tau_set\"]:\n                for N in params[\"N_set\"]:\n                    # Check the daily dosing rate constraint\n                    if D * (24.0 / tau) > params[\"D_daily_max\"]:\n                        continue\n\n                    AUC, TAT = run_simulation(\n                        D=D, tau=tau, N=N,\n                        CL=params[\"CL\"], V=params[\"V\"], C_tox=params[\"C_tox\"],\n                        T_tail=params[\"T_tail\"], dt=dt\n                    )\n                    \n                    candidate_regimens.append({\n                        \"D\": D, \"tau\": tau, \"N\": N,\n                        \"AUC\": AUC, \"TAT\": TAT, \"D_tot\": D * N\n                    })\n        \n        in_target_regimens = []\n        out_of_target_regimens = []\n        \n        AUC_min, AUC_max = params[\"AUC_min\"], params[\"AUC_max\"]\n        AUC_center = (AUC_min + AUC_max) / 2.0\n\n        for reg in candidate_regimens:\n            if AUC_min <= reg[\"AUC\"] <= AUC_max:\n                in_target_regimens.append(reg)\n            else:\n                reg[\"dev\"] = abs(reg[\"AUC\"] - AUC_center)\n                out_of_target_regimens.append(reg)\n\n        if in_target_regimens:\n            # Primary Objective: in-target, minimize TAT, then D_tot, then maximize tau\n            in_target_regimens.sort(key=lambda r: (r[\"TAT\"], r[\"D_tot\"], -r[\"tau\"]))\n            best_regimen = in_target_regimens[0]\n        else:\n            # Secondary Objective: out-of-target, minimize deviation, then TAT, then D_tot, then maximize tau\n            out_of_target_regimens.sort(key=lambda r: (r[\"dev\"], r[\"TAT\"], r[\"D_tot\"], -r[\"tau\"]))\n            best_regimen = out_of_target_regimens[0]\n            \n        final_result_for_case = [\n            best_regimen[\"D\"],\n            best_regimen[\"tau\"],\n            best_regimen[\"N\"],\n            round(best_regimen[\"AUC\"], 3),\n            round(best_regimen[\"TAT\"], 3)\n        ]\n        all_final_results.append(final_result_for_case)\n\n    # Convert each inner list to its string representation\n    results_as_strings = [str(res) for res in all_final_results]\n    print(f\"[{','.join(results_as_strings)}]\")\n\nsolve()\n```"
        }
    ]
}