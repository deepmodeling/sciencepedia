{
    "hands_on_practices": [
        {
            "introduction": "掌握标准化摄取值（SUV）的第一步是学会如何从原始临床数据中进行计算。本练习将指导您完成一个核心计算任务，即计算体重标准化的SUV（$SUV_{bw}$）。通过这个练习，您将实践如何考虑注射后的残留活性以及放射性核素的衰变，这是确保SUV计算准确性的两个基本步骤。",
            "id": "4555037",
            "problem": "对一名体重为 $m_{bw}=70\\,\\mathrm{kg}$ 的患者进行了一项使用氟-18 ($^{18}\\mathrm{F}$) 的全身正电子发射断层扫描 (PET) 研究。在时间 $t=0$ 注射前即刻，测得注射器活度为 $A_{pre}=310\\,\\mathrm{MBq}$，注射后即刻（相对于 $t=0$ 的延迟可忽略不计），测得注射器残余活度为 $A_{post}=7\\,\\mathrm{MBq}$。扫描在注射后 $t=60\\,\\mathrm{min}$ 开始。PET 图像经过重建并进行衰变校正至扫描开始时间，报告显示在扫描开始时，一个病灶的平均活度浓度为 $C_t=8.5\\,\\mathrm{kBq}/\\mathrm{ml}$。$^{18}\\mathrm{F}$ 的物理半衰期为 $T_{1/2}=109.77\\,\\mathrm{min}$。假设软组织密度约为 $1\\,\\mathrm{g}/\\mathrm{ml}$。\n\n仅使用放射性活度衰变定律和体重归一化标准摄取值 (SUV) 的定义（即组织活度浓度与每单位体重的注射活度之比，且所有量均参考同一时间点，即扫描开始时间），计算该病灶的体重归一化标准摄取值 $SUV_{bw}$，计算中需将净注射活度进行适当的衰变校正至扫描开始时间。\n\n将最终的 $SUV_{bw}$ 表示为一个纯数（无单位），并将答案四舍五入至三位有效数字。",
            "solution": "该问题提法恰当且有科学依据。我们将进行完整的解答。\n\n目标是计算在正电子发射断层扫描 (PET) 中观察到的病灶的体重归一化标准摄取值 ($SUV_{bw}$)。问题将此量定义为组织活度浓度与每单位体重的注射活度之比，且所有量均参考同一时间点。指定的时间点是扫描开始时间 $t$。\n\n因此，$SUV_{bw}$ 的公式为：\n$$\nSUV_{bw} = \\frac{C_{t}}{\\left(\\frac{A_{inj,t}}{m_{bw}}\\right)}\n$$\n其中：\n-   $C_{t}$ 是在扫描开始时间 $t$ 时病灶中的平均活度浓度。\n-   $A_{inj,t}$ 是净注射放射性剂量，经过衰变校正至扫描开始时间 $t$。\n-   $m_{bw}$ 是患者的体重。\n\n为确保 $SUV_{bw}$ 是一个无量纲量，分子和分母的单位必须等效。分子 $C_t$ 的单位是活度每体积（$\\mathrm{kBq}/\\mathrm{ml}$）。分母在进行单位换算后的单位是活度每质量（$\\mathrm{kBq}/\\mathrm{g}$）。问题中假设软组织密度为 $\\rho = 1\\,\\mathrm{g}/\\mathrm{ml}$，这在毫升（$\\mathrm{ml}$）的体积和克（$\\mathrm{g}$）的质量之间建立了等效关系。\n\n解题步骤如下：\n1.  计算注射时（$t = 0$）的净注射活度。\n2.  使用放射性衰变定律将此活度校正至扫描开始时间 $t = 60\\,\\mathrm{min}$。\n3.  将所有具有一致单位的量代入 $SUV_{bw}$ 公式，并计算最终值。\n\n**步骤 1：$t=0$ 时的净注射活度**\n\n净注射活度 $A_{inj,0}$ 是注射前注射器活度 $A_{pre}$ 与注射后残余活度 $A_{post}$ 之差。\n已知：\n-   $A_{pre} = 310\\,\\mathrm{MBq}$\n-   $A_{post} = 7\\,\\mathrm{MBq}$\n\n$$\nA_{inj,0} = A_{pre} - A_{post} = 310\\,\\mathrm{MBq} - 7\\,\\mathrm{MBq} = 303\\,\\mathrm{MBq}\n$$\n\n**步骤 2：注射活度的衰变校正**\n\n根据放射性衰变定律，放射性核素的活度随时间指数衰减：\n$$\nA(t) = A_0 \\exp(-\\lambda t)\n$$\n其中 $A_0$ 是初始活度，$t$ 是经过的时间，$\\lambda$ 是衰变常数。衰变常数与半衰期 $T_{1/2}$ 的关系为：\n$$\n\\lambda = \\frac{\\ln(2)}{T_{1/2}}\n$$\n我们需要根据 $t=0$ 时的活度 $A_{inj,0}$，求出扫描开始时间时的注射活度 $A_{inj,t}$。\n已知：\n-   扫描开始时间：$t = 60\\,\\mathrm{min}$\n-   $^{18}\\mathrm{F}$ 的半衰期：$T_{1/2} = 109.77\\,\\mathrm{min}$\n\n将 $\\lambda$ 的表达式代入衰变定律：\n$$\nA_{inj,t} = A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)\n$$\n代入数值：\n$$\nA_{inj,t} = (303\\,\\mathrm{MBq}) \\exp\\left(-\\frac{\\ln(2) \\cdot 60\\,\\mathrm{min}}{109.77\\,\\mathrm{min}}\\right)\n$$\n\n**步骤 3：计算 $SUV_{bw}$**\n\n现在我们可以组合出 $SUV_{bw}$ 的完整表达式：\n$$\nSUV_{bw} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,t}} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)}\n$$\n在代入数值之前，我们必须确保所有单位一致。让我们将所有量转换为一个统一的单位体系：\n-   病灶活度浓度：$C_t = 8.5\\,\\mathrm{kBq}/\\mathrm{ml}$\n-   患者体重：$m_{bw} = 70\\,\\mathrm{kg} = 70 \\times 10^3\\,\\mathrm{g} = 70000\\,\\mathrm{g}$\n-   $t=0$ 时的净注射活度：$A_{inj,0} = 303\\,\\mathrm{MBq} = 303 \\times 10^3\\,\\mathrm{kBq} = 303000\\,\\mathrm{kBq}$\n-   时间：$t=60\\,\\mathrm{min}$\n-   半衰期：$T_{1/2}=109.77\\,\\mathrm{min}$\n\n将这些值代入 $SUV_{bw}$ 的表达式中：\n$$\nSUV_{bw} = \\frac{(8.5\\,\\mathrm{kBq}/\\mathrm{ml}) \\cdot (70000\\,\\mathrm{g})}{(303000\\,\\mathrm{kBq}) \\cdot \\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right)}\n$$\n如前所述，由于密度的假设，$\\mathrm{g}/\\mathrm{ml}$ 这一项实际上等于 1，而活度单位（$\\mathrm{kBq}$）相互抵消，从而得到一个无量纲的结果。\n\n首先，我们计算指数项（衰变因子）：\n$$\n\\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right) \\approx \\exp\\left(-\\frac{0.693147 \\cdot 60}{109.77}\\right) \\approx \\exp(-0.37884) \\approx 0.684654\n$$\n现在，将此结果代回主方程：\n$$\nSUV_{bw} \\approx \\frac{8.5 \\cdot 70000}{303000 \\cdot 0.684654}\n$$\n$$\nSUV_{bw} \\approx \\frac{595000}{207439.84} \\approx 2.86828\n$$\n问题要求将最终答案四舍五入到三位有效数字。\n$$\nSUV_{bw} \\approx 2.87\n$$\n该病灶的体重归一化标准摄取值为 $2.87$。",
            "answer": "$$\\boxed{2.87}$$"
        },
        {
            "introduction": "在真实世界的临床实践中，测量过程并非总是完美的，技术误差可能会影响定量结果的准确性。本练习聚焦于一个常见问题——药物外渗，即部分放射性示踪剂未能进入全身循环。您将学习如何量化这种技术误差对最终SUV值的影响，并理解由此产生的测量偏差的概念。",
            "id": "4555058",
            "problem": "一项使用葡萄糖类似物示踪剂的正电子发射断层扫描 (PET) 研究中，标准摄取值 (SUV) 由一个基础关系定义，该关系将测量的活度浓度归一化为单位体重的注射活度：SUV 与感兴趣体积内测得的活度浓度除以单位体重的注射活度所得的商成正比。在常规实践中，注射活度由注射前注射器检测和注射后残余检测计算得出，两者都经过衰变校正至注射时间。考虑一种情况，注射部位发生外渗，导致部分示踪剂局部残留在注射点附近，未参与全身分布。假设无论注射活度的计算是否校正了外渗，目标病灶中测得的组织活度浓度和患者体重都保持不变，并且所有检测值都经过衰变校正至注射时间。\n\n设注射前注射器活度为 $A_{\\mathrm{pre}} = 300\\,\\mathrm{MBq}$，注射后注射器残余活度为 $A_{\\mathrm{post}} = 5\\,\\mathrm{MBq}$，以及注射点附近外渗的活度为 $A_{\\mathrm{ex}} = 10\\,\\mathrm{MBq}$。标准 SUV 计算中使用的名义注射活度（忽略外渗）是 $A_{\\mathrm{nom}} = A_{\\mathrm{pre}} - A_{\\mathrm{post}}$，而可供全身循环利用的有效活度是 $A_{\\mathrm{eff}} = A_{\\mathrm{nom}} - A_{\\mathrm{ex}}$。\n\n将因忽略外渗而引入的 SUV 分数偏差 $b$ 定义为使用 $A_{\\mathrm{nom}}$ 计算的 SUV 与使用正确的 $A_{\\mathrm{eff}}$ 将获得的 SUV 之间的相对差异：\n$$\nb \\equiv \\frac{\\mathrm{SUV}_{\\mathrm{meas}} - \\mathrm{SUV}_{\\mathrm{true}}}{\\mathrm{SUV}_{\\mathrm{true}}}.\n$$\n负值表示对真实 SUV 的低估。仅使用上述定义和基本原理，根据给定的 $A_{\\mathrm{pre}}$、$A_{\\mathrm{post}}$ 和 $A_{\\mathrm{ex}}$ 值计算 $b$。将您的最终结果表示为一个无单位的纯小数，并四舍五入到四位有效数字。",
            "solution": "该问题经核实是自洽的、有科学依据且表述清晰的。所有必要的数据和定义均已提供，不存在矛盾或歧义。所描述的情景是定量PET成像中的一个标准考虑因素。\n\n标准摄取值 (SUV) 定义为与测量的组织活度浓度 $C_{\\mathrm{tissue}}$ 与单位体重的注射活度之比成正比。设患者体重为 $M$，注射活度为 $A_{\\mathrm{inj}}$。该关系可表示为：\n$$\n\\mathrm{SUV} = \\kappa \\frac{C_{\\mathrm{tissue}}}{A_{\\mathrm{inj}} / M}\n$$\n其中 $\\kappa$ 是一个比例常数，当单位得到适当处理时（例如，$C_{\\mathrm{tissue}}$ 的单位为 $\\mathrm{kBq/mL}$，$A_{\\mathrm{inj}}/M$ 的单位为 $\\mathrm{kBq/g}$，并假设组织密度为 $1\\,\\mathrm{g/mL}$），其值通常等于 $1$。问题指出，无论是否存在外渗，$C_{\\mathrm{tissue}}$ 和 $M$ 都是恒定的。因此，我们可以将所有常数项合并为一个单一常数 $K$：\n$$\nK = \\kappa C_{\\mathrm{tissue}} M\n$$\n这使得 SUV 可以表示为与注射活度的更简单的反比关系：\n$$\n\\mathrm{SUV} = \\frac{K}{A_{\\mathrm{inj}}}\n$$\n问题根据两种不同的注射活度计算方式定义了两个不同的 SUV 值。测量的 SUV，即 $\\mathrm{SUV}_{\\mathrm{meas}}$，是使用名义注射活度 $A_{\\mathrm{nom}}$ 计算的。这是标准的计算方法，它错误地假设所有离开注射器的活度都进入了全身循环。\n$$\n\\mathrm{SUV}_{\\mathrm{meas}} = \\frac{K}{A_{\\mathrm{nom}}}\n$$\n真实的 SUV，即 $\\mathrm{SUV}_{\\mathrm{true}}$，是在计算中正确考虑了外渗活度 $A_{\\mathrm{ex}}$ 的情况下得到的值。这意味着使用有效活度 $A_{\\mathrm{eff}}$，即实际到达全身循环的示踪剂部分。\n$$\n\\mathrm{SUV}_{\\mathrm{true}} = \\frac{K}{A_{\\mathrm{eff}}}\n$$\n分数偏差 $b$ 定义为：\n$$\nb \\equiv \\frac{\\mathrm{SUV}_{\\mathrm{meas}} - \\mathrm{SUV}_{\\mathrm{true}}}{\\mathrm{SUV}_{\\mathrm{true}}}\n$$\n将 $\\mathrm{SUV}_{\\mathrm{meas}}$ 和 $\\mathrm{SUV}_{\\mathrm{true}}$ 的表达式代入偏差的定义中：\n$$\nb = \\frac{\\frac{K}{A_{\\mathrm{nom}}} - \\frac{K}{A_{\\mathrm{eff}}}}{\\frac{K}{A_{\\mathrm{eff}}}}\n$$\n常数 $K$ 从分子和分母中约去，证实了偏差与患者体重和组织活度浓度无关，这与预期相符。\n$$\nb = \\frac{\\frac{1}{A_{\\mathrm{nom}}} - \\frac{1}{A_{\\mathrm{eff}}}}{\\frac{1}{A_{\\mathrm{eff}}}}\n$$\n通过将分子和分母同乘以 $A_{\\mathrm{eff}}$，可以简化此表达式：\n$$\nb = \\left( \\frac{1}{A_{\\mathrm{nom}}} - \\frac{1}{A_{\\mathrm{eff}}} \\right) A_{\\mathrm{eff}} = \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{nom}}} - \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{eff}}} = \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{nom}}} - 1\n$$\n现在，我们使用给定数据计算 $A_{\\mathrm{nom}}$ 和 $A_{\\mathrm{eff}}$ 的数值：\n- 注射前注射器活度： $A_{\\mathrm{pre}} = 300\\,\\mathrm{MBq}$\n- 注射后注射器残余活度： $A_{\\mathrm{post}} = 5\\,\\mathrm{MBq}$\n- 外渗活度： $A_{\\mathrm{ex}} = 10\\,\\mathrm{MBq}$\n\n名义注射活度为：\n$$\nA_{\\mathrm{nom}} = A_{\\mathrm{pre}} - A_{\\mathrm{post}} = 300\\,\\mathrm{MBq} - 5\\,\\mathrm{MBq} = 295\\,\\mathrm{MBq}\n$$\n可供全身循环利用的有效活度是此名义活度减去外渗部分：\n$$\nA_{\\mathrm{eff}} = A_{\\mathrm{nom}} - A_{\\mathrm{ex}} = 295\\,\\mathrm{MBq} - 10\\,\\mathrm{MBq} = 285\\,\\mathrm{MBq}\n$$\n现在，将这些值代入导出的偏差 $b$ 的表达式中：\n$$\nb = \\frac{285}{295} - 1\n$$\n进行计算：\n$$\nb \\approx 0.9661016949... - 1 = -0.033898305...\n$$\n问题要求结果四舍五入到四位有效数字。第一个非零数字是百分位上的 $3$，所以我们保留它和接下来的三位数字。第五位有效数字是 $8$，它 $\\ge 5$，所以我们将第四位有效数字 ($9$) 向上舍入。\n$$\nb \\approx -0.03390\n$$\n负号表示测量的 SUV 是对真实 SUV 的低估，这与在 SUV 计算的分母中使用了比实际注射活度更大的值（$A_{\\mathrm{nom}} > A_{\\mathrm{eff}}$）是一致的。",
            "answer": "$$\\boxed{-0.03390}$$"
        },
        {
            "introduction": "现代放射组学分析通常需要计算一系列相关的定量指标，而不仅仅是单一的SUV值。这个综合性练习将作为一个顶石项目，引导您系统地实现一个包含多种SUV指标的计算流程。您将根据第一性原理，编写程序来计算$SUV_{bw}$、$SUV_{lbm}$、$SUV_{peak}$和$SUV_{max}$，模拟医学物理师或数据科学家在处理PET图像时面临的真实任务。",
            "id": "4554997",
            "problem": "一名开发者需要实现一个程序，用于计算正电子发射断层扫描（Positron Emission Tomography, PET）中分割后病灶的四个定量放射组学指标。其中，PET代表正电子发射断层扫描，SUV（Standardized Uptake Value）代表标准化摄取值。要求计算的指标是：体重归一化SUV（$SUV_{bw}$）、瘦体重归一化SUV（$SUV_{lbm}$）、峰值SUV（$SUV_{peak}$）和最大值SUV（$SUV_{max}$）。该程序必须从第一性原理出发：指数放射性衰变定律，以及通过每单位参考质量的注射活度对活度浓度进行单位一致的归一化，并且必须将残留活度和到扫描时间的衰变校正纳入计算。所有计算必须符合科学真实性并正确处理单位。\n\n基本原理：\n- 半衰期为 $T_{1/2}$ 的放射性核素的放射性衰变：如果在参考时间测得的活度为 $A_0$，则在时间 $t$ 的活度为 $$A(t) = A_0 \\cdot 2^{-t/T_{1/2}}.$$\n- 扫描时测得的活度浓度 $C_t$ 是一个物理量，单位为千贝可勒尔/毫升（kBq/mL）。\n- 注射时的净注射活度是注射前活度与注射后残留活度之差，两者均在注射时测量。必须使用指数衰变定律将此净活度进行衰变校正至扫描时间。\n- 体重归一化SUV定义为组织活度浓度与每单位体重的注射活度之比。为与毫升（假设1毫升约对应1克组织）具有可比性，单位一致性要求质量以克为单位。瘦体重归一化SUV则用瘦体重代替总体重。\n- 瘦体重（Lean Body Mass, LBM）应使用 Janmahasatian 公式计算，其中体重以千克为单位，身高以米为单位，然后转换为克以保证单位一致性：\n  - 男性： $$LBM = \\frac{9270 \\cdot W}{6680 + 216 \\cdot BMI},$$\n  - 女性： $$LBM = \\frac{9270 \\cdot W}{8780 + 244 \\cdot BMI},$$\n  其中 $$BMI = \\frac{W}{H^2},$$ W的单位是千克，H的单位是米。\n\n需精确应用的定义：\n- 设 $A_{pre}$ 和 $A_{post}$ 分别为注射时测量的注射前活度和注射后残留活度，单位均为兆贝可勒尔（MBq）。注射时的净注射活度为 $$A_{inj} = A_{pre} - A_{post}.$$ 为了获得扫描时间（摄取时间）$t$（分钟）时的注射活度，需进行衰变校正 $$A_{scan} = A_{inj} \\cdot 2^{-t/T_{1/2}}.$$ 将 $A_{scan}$ 乘以 $1000$ 转换为千贝可勒尔（kBq）。\n- 给定一个扫描时间时单位为 kBq/mL 的 $C_t$ 图，以及一个相同形状的二值病灶掩模，将所有空间汇总统计限制在掩模值为 $1$ 的体素上。\n- 计算逐体素的体重归一化SUV图 $$SUV_{bw}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot M_{g}}{A_{scan,kBq}},$$ 其中 $M_{g}$ 是以克为单位的总体重（$kg \\times 1000$）。\n- 计算逐体素的瘦体重归一化SUV图 $$SUV_{lbm}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot LBM_{g}}{A_{scan,kBq}},$$ 其中 $LBM_{g}$ 是以克为单位的瘦体重（$kg \\times 1000$）。\n- 计算 $$SUV_{max} = \\max_{\\mathbf{r} \\in \\text{lesion}} SUV_{bw}(\\mathbf{r}).$$\n- 计算 $$SUV_{peak}$$ 为在所有完全包含在病灶掩模内的连续 $3 \\times 3 \\times 3$ 体素核心中，$SUV_{bw}$ 平均值的最大值。如果病灶掩模中不包含任何完全包含的 $3 \\times 3 \\times 3$ 核心，则定义 $$SUV_{peak} = SUV_{max}.$$\n\n所有物理量及其单位：\n- $C_t$ 图的条目单位为 kBq/mL，是在扫描时间测得的。\n- $A_{pre}$ 和 $A_{post}$ 的单位为 MBq，是在注射时间测得的。\n- 摄取时间 $t$ 的单位为分钟。\n- 半衰期 $T_{1/2}$ 的单位为分钟。\n- 体重单位为千克，身高单位为厘米；计算身体质量指数（BMI）时使用米。\n- 将所有最终的SUV指标表示为无单位的浮点数，并四舍五入到小数点后四位。\n\n测试套件：\n实现您的程序，为以下三组参数集中的每一组计算 $SUV_{bw}$、$SUV_{lbm}$、$SUV_{peak}$ 和 $SUV_{max}$。每个测试用例提供：\n- 一个 $C_t$ 图（以 $z \\times y \\times x$ 数组形式），\n- 一个相同形状的病灶掩模，\n- $A_{pre}$ (MBq)，\n- $A_{post}$ (MBq)，\n- 体重 (kg)，\n- 身高 (cm)，\n- 性别（$\\text{male}$ 或 $\\text{female}$），\n- 摄取时间 $t$（分钟），\n- 半衰期 $T_{1/2}$（分钟）。\n\n案例 $1$ (一般情况，男性，非零残留，非零摄取):\n- $A_{pre} = 370$ MBq, $A_{post} = 5$ MBq, $M = 80$ kg, $H = 180$ cm, sex $=$ male, $t = 60$ 分钟, $T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图 ($4 \\times 4 \\times 4$):\n  - $z=0$:\n    - $y=0$: $[2.2, 2.4, 2.5, 2.3]$,\n    - $y=1$: $[2.5, 3.0, 3.2, 2.6]$,\n    - $y=2$: $[2.3, 2.9, 3.1, 2.4]$,\n    - $y=3$: $[2.1, 2.2, 2.3, 2.0]$.\n  - $z=1$:\n    - $y=0$: $[2.4, 3.1, 3.5, 2.6]$,\n    - $y=1$: $[3.2, 8.5, 12.0, 4.0]$,\n    - $y=2$: $[3.1, 10.0, 14.5, 4.2]$,\n    - $y=3$: $[2.6, 4.3, 5.0, 3.0]$.\n  - $z=2$:\n    - $y=0$: $[2.3, 3.0, 3.4, 2.5]$,\n    - $y=1$: $[3.1, 9.0, 13.0, 4.1]$,\n    - $y=2$: $[3.0, 11.5, 16.0, 4.4]$,\n    - $y=3$: $[2.5, 4.5, 5.2, 3.1]$.\n  - $z=3$:\n    - $y=0$: $[2.2, 2.8, 3.0, 2.3]$,\n    - $y=1$: $[2.9, 4.0, 4.5, 3.2]$,\n    - $y=2$: $[2.8, 4.2, 4.8, 3.3]$,\n    - $y=3$: $[2.3, 3.2, 3.5, 2.6]$.\n- 病灶掩模 ($4 \\times 4 \\times 4$): 当索引 $z \\in \\{1,2,3\\}$，$y \\in \\{1,2,3\\}$，$x \\in \\{1,2,3\\}$ 时为1；其他位置为0。\n\n案例 $2$ (边界情况：零残留，零摄取，女性):\n- $A_{pre} = 185$ MBq, $A_{post} = 0$ MBq, $M = 55$ kg, $H = 165$ cm, sex $=$ female, $t = 0$ 分钟, $T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图 ($3 \\times 3 \\times 3$):\n  - $z=0$:\n    - $y=0$: $[6.0, 7.0, 6.5]$,\n    - $y=1$: $[6.8, 8.0, 7.2]$,\n    - $y=2$: $[6.2, 7.5, 6.7]$.\n  - $z=1$:\n    - $y=0$: $[7.0, 9.0, 7.5]$,\n    - $y=1$: $[8.5, 12.5, 9.0]$,\n    - $y=2$: $[7.2, 9.5, 7.8]$.\n  - $z=2$:\n    - $y=0$: $[6.5, 7.8, 7.0]$,\n    - $y=1$: $[7.5, 10.5, 8.2]$,\n    - $y=2$: $[6.8, 8.7, 7.1]$.\n- 病灶掩模 ($3 \\times 3 \\times 3$): 全部为1。\n\n案例 $3$ (边缘情况：极高的残留导致净活度很小，非零摄取，男性；病灶太小，无法容纳 $3 \\times 3 \\times 3$ 核心，因此 $SUV_{peak}$ 回退为 $SUV_{max}$):\n- $A_{pre} = 100$ MBq, $A_{post} = 90$ MBq, $M = 100$ kg, $H = 175$ cm, sex $=$ male, $t = 120$ 分钟, $T_{1/2} = 109.77$ 分钟。\n- $C_t$ 图 ($3 \\times 3 \\times 3$):\n  - $z=0$:\n    - $y=0$: $[3.0, 4.0, 3.5]$,\n    - $y=1$: $[4.5, 6.0, 5.0]$,\n    - $y=2$: $[3.2, 4.8, 3.8]$.\n  - $z=1$:\n    - $y=0$: $[4.0, 5.0, 4.3]$,\n    - $y=1$: $[6.5, 9.0, 7.5]$,\n    - $y=2$: $[4.0, 6.2, 5.0]$.\n  - $z=2$:\n    - $y=0$: $[3.5, 4.2, 3.7]$,\n    - $y=1$: $[5.2, 7.0, 6.0]$,\n    - $y=2$: $[3.6, 5.5, 4.2]$.\n- 病灶掩模 ($3 \\times 3 \\times 3$): 当索引 $z \\in \\{0,1\\}$，$y \\in \\{0,1\\}$，$x \\in \\{0,1\\}$ 时为1；其他位置为0。\n\n要求的最终输出：\n- 对于每个测试用例，计算并四舍五入到小数点后四位，得出四个浮点数 $[SUV_{bw}, SUV_{lbm}, SUV_{peak}, SUV_{max}]$。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个元素是对应一个测试用例的列表。例如，输出格式必须严格符合 $$\\texttt{[[s11,s12,s13,s14],[s21,s22,s23,s24],[s31,s32,s33,s34]]}$$ 的形式，其中每个 $s_{ij}$ 是一个十进制表示的浮点数（四舍五入到小数点后四位）。",
            "solution": "问题陈述经评估有效。它在科学上基于核医学和定量成像的原理，特别是正电子发射断层扫描（PET）。该问题定义明确，提供了所有必需的物理常数、患者数据、影像数据，以及待计算的放射组学指标的明确数学公式。标准化摄取值（SUV）的定义，包括体重和瘦体重归一化、放射性衰变和峰值SUV，是精确的，并与该领域的实践相一致。使用 Janmahasatian 公式计算瘦体重是一个具体且有效的选择。单位被清晰地说明，其处理方式，特别是基于假设的组织密度 $1 \\text{ g/mL}$ 在质量和体积之间进行转换，得到了明确的论证并且是正确的。测试用例定义良好，涵盖了一般、边界和边缘条件，确保了对实现的全面测试。不存在矛盾、歧义或事实错误。\n\n解决方案首先基于所提供的定义和原则建立一个通用的计算框架。然后将此框架系统地应用于三个测试用例中的每一个。对于 $SUV_{bw}$ 和 $SUV_{lbm}$ 的输出规范中存在的一个歧义（它们被定义为逐体素的图，但要求输出为单个浮点数），通过最科学合理的解释得以解决：这些值代表整个病灶体积内的平均SUV。\n\n### 通用计算方法\n\n对于每个测试用例，执行以下计算序列：\n\n1.  **活度计算**: 在注射时的净注射活度 $A_{inj}$，以兆贝可勒尔（$MBq$）为单位计算：\n    $$A_{inj} = A_{pre} - A_{post}$$\n    然后使用提供的半衰期 $T_{1/2}$ 将该活度衰变校正至扫描时间 $t$：\n    $$A_{scan} [MBq] = A_{inj} \\cdot 2^{-t/T_{1/2}}$$\n    为了在SUV公式中使用，该活度被转换为千贝可勒尔（$kBq$）：\n    $$A_{scan,kBq} = A_{scan} [MBq] \\cdot 1000$$\n\n2.  **质量和瘦体重计算**: 将患者的体重 $M$（单位：千克 $kg$）和身高 $H$（单位：厘米 $cm$）分别转换为克（$g$）和米（$m$）。\n    $$M_g = M [kg] \\cdot 1000$$\n    $$H_m = H [cm] / 100$$\n    身体质量指数（$BMI$）计算如下：\n    $$BMI = \\frac{M [kg]}{H_m^2}$$\n    使用针对性别的 Janmahasatian 公式计算瘦体重（$LBM$），单位为千克（$kg$）：\n    $$LBM_{male} [kg] = \\frac{9270 \\cdot M [kg]}{6680 + 216 \\cdot BMI}$$\n    $$LBM_{female} [kg] = \\frac{9270 \\cdot M [kg]}{8780 + 244 \\cdot BMI}$$\n    然后将$LBM$转换为克，以确保SUV计算中的单位一致性：\n    $$LBM_g = LBM [kg] \\cdot 1000$$\n\n3.  **SUV计算**: 计算逐体素的 $SUV_{bw}$ 图。首先计算一个转换因子 $F_{bw}$ 会很方便：\n    $$F_{bw} = \\frac{M_g}{A_{scan,kBq}}$$\n    然后，对于位于位置 $\\mathbf{r}$ 的每个体素：\n    $$SUV_{bw}(\\mathbf{r}) = C_t(\\mathbf{r}) \\cdot F_{bw}$$\n    其中 $C_t(\\mathbf{r})$ 是活度浓度，单位为 $kBq/mL$。$SUV_{lbm}$ 的值通过缩放 $SUV_{bw}$ 的值得到：\n    $$SUV_{lbm}(\\mathbf{r}) = SUV_{bw}(\\mathbf{r}) \\cdot \\frac{LBM_g}{M_g}$$\n\n4.  **放射组学指标计算**: 从 $SUV_{bw}$ 图和病灶掩模计算所需的四个指标。\n    -   $SUV_{bw,mean}$：病灶内（掩模为 $1$ 的地方）所有体素 $\\mathbf{r}$ 的 $SUV_{bw}(\\mathbf{r})$ 的平均值。\n    -   $SUV_{lbm,mean}$：病灶内所有体素 $\\mathbf{r}$ 的 $SUV_{lbm}(\\mathbf{r})$ 的平均值。这等同于 $SUV_{bw,mean} \\cdot \\frac{LBM_g}{M_g}$。\n    -   $SUV_{max}$：病灶内所有体素 $\\mathbf{r}$ 的 $SUV_{bw}(\\mathbf{r})$ 的最大值。\n    -   $SUV_{peak}$：在所有完全包含在病灶内的连续 $3 \\times 3 \\times 3$ 体素核心上计算的平均 $SUV_{bw}$ 值的最大值。如果不存在这样的核心，则 $SUV_{peak} = SUV_{max}$。\n\n### 测试用例应用\n\n#### 案例 1\n- **输入**：$A_{pre} = 370$ MBq, $A_{post} = 5$ MBq, $M = 80$ kg, $H = 180$ cm, sex=male, $t = 60$ min, $T_{1/2} = 109.77$ min。\n- **活度**：$A_{inj} = 370 - 5 = 365$ MBq。$A_{scan} = 365 \\cdot 2^{-60/109.77} \\approx 250.40096$ MBq。$A_{scan,kBq} \\approx 250400.96$ kBq。\n- **质量**：$M_g = 80000$ g。$H_m = 1.8$ m。$BMI = 80 / (1.8^2) \\approx 24.6914$。$LBM \\approx \\frac{9270 \\cdot 80}{6680 + 216 \\cdot 24.6914} \\approx 61.7284$ kg。$LBM_g \\approx 61728.4$ g。\n- **SUV因子**：$F_{bw} = 80000 / 250400.96 \\approx 0.319488$。比率 $\\frac{LBM_g}{M_g} \\approx 0.771605$。\n- **病灶数据**：病灶是一个 $3 \\times 3 \\times 3$ 的子体积。病灶内 $C_t$ 值的总和为 $169.6$ kBq/mL，共 $27$ 个体素。平均 $C_t = 169.6 / 27 \\approx 6.2815$ kBq/mL。最大 $C_t$ 是 $16.0$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = 6.2815 \\cdot 0.319488 \\approx 2.0068$。\n    -   $SUV_{lbm,mean} = 2.0068 \\cdot 0.771605 \\approx 1.5485$。\n    -   $SUV_{max} = 16.0 \\cdot 0.319488 \\approx 5.1118$。\n    -   $SUV_{peak}$：病灶是一个 $3 \\times 3 \\times 3$ 的体积，因此只有一个 $3 \\times 3 \\times 3$ 的核心能被完全包含。其平均值就是病灶的平均值。因此，$SUV_{peak} = SUV_{bw,mean} \\approx 2.0068$。\n- **结果**：$[2.0068, 1.5485, 2.0068, 5.1118]$\n\n#### 案例 2\n- **输入**：$A_{pre} = 185$ MBq, $A_{post} = 0$ MBq, $M = 55$ kg, $H = 165$ cm, sex=female, $t = 0$ min, $T_{1/2} = 109.77$ min。\n- **活度**：$A_{inj} = 185 - 0 = 185$ MBq。由于 $t=0$，$A_{scan} = 185$ MBq。$A_{scan,kBq} = 185000$ kBq。\n- **质量**：$M_g = 55000$ g。$H_m = 1.65$ m。$BMI = 55 / (1.65^2) \\approx 20.2020$。$LBM \\approx \\frac{9270 \\cdot 55}{8780 + 244 \\cdot 20.2020} \\approx 37.1901$ kg。$LBM_g \\approx 37190.1$ g。\n- **SUV因子**：$F_{bw} = 55000 / 185000 = 11/37 \\approx 0.297297$。比率 $\\frac{LBM_g}{M_g} \\approx 0.676184$。\n- **病灶数据**：病灶是整个 $3 \\times 3 \\times 3$ 的体积。$C_t$ 的总和为 $210.0$ kBq/mL，共 $27$ 个体素。平均 $C_t = 210.0 / 27 \\approx 7.7778$ kBq/mL。最大 $C_t = 12.5$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = (210/27) \\cdot (11/37) \\approx 2.3123$。\n    -   $SUV_{lbm,mean} = 2.3123 \\cdot 0.676184 \\approx 1.5635$。\n    -   $SUV_{max} = 12.5 \\cdot (11/37) \\approx 3.7162$。\n    -   $SUV_{peak}$：与案例1类似，病灶是一个 $3 \\times 3 \\times 3$ 的体积，所以 $SUV_{peak} = SUV_{bw,mean} \\approx 2.3123$。\n- **结果**：$[2.3123, 1.5635, 2.3123, 3.7162]$\n\n#### 案例 3\n- **输入**：$A_{pre} = 100$ MBq, $A_{post} = 90$ MBq, $M = 100$ kg, $H = 175$ cm, sex=male, $t = 120$ min, $T_{1/2} = 109.77$ min。\n- **活度**：$A_{inj} = 100 - 90 = 10$ MBq。$A_{scan} = 10 \\cdot 2^{-120/109.77} \\approx 4.68840$ MBq。$A_{scan,kBq} \\approx 4688.40$ kBq。\n- **质量**：$M_g = 100000$ g。$H_m = 1.75$ m。$BMI = 100 / (1.75^2) \\approx 32.6531$。$LBM \\approx \\frac{9270 \\cdot 100}{6680 + 216 \\cdot 32.6531} \\approx 67.5020$ kg。$LBM_g \\approx 67502.0$ g。\n- **SUV因子**：$F_{bw} = 100000 / 4688.40 \\approx 21.3292$。比率 $\\frac{LBM_g}{M_g} \\approx 0.675020$。\n- **病灶数据**：病灶是一个 $2 \\times 2 \\times 2$ 的子体积。$C_t$ 的总和为 $42.0$ kBq/mL，共 $8$ 个体素。平均 $C_t = 42.0 / 8 = 5.25$ kBq/mL。最大 $C_t = 9.0$ kBq/mL。\n- **指标**：\n    -   $SUV_{bw,mean} = 5.25 \\cdot 21.3292 \\approx 111.9785$。\n    -   $SUV_{lbm,mean} = 111.9785 \\cdot 0.675020 \\approx 75.5881$。\n    -   $SUV_{max} = 9.0 \\cdot 21.3292 \\approx 191.9632$。\n    -   $SUV_{peak}$：病灶大小为 $2 \\times 2 \\times 2$，小于 $3 \\times 3 \\times 3$ 的核心。没有这样的核心能被完全包含。根据问题定义，$SUV_{peak} = SUV_{max} \\approx 191.9632$。\n- **结果**：$[111.9785, 75.5881, 191.9632, 191.9632]$\n\n以下程序实现了这一逻辑。",
            "answer": "```python\nimport numpy as np\n\ndef compute_metrics(C_t_map, lesion_mask, A_pre, A_post, M_kg, H_cm, sex, t_min, T_half_min):\n    \"\"\"\n    Computes SUV-based radiomics metrics for a single PET lesion case.\n    \n    Args:\n        C_t_map (np.ndarray): 3D array of activity concentration in kBq/mL.\n        lesion_mask (np.ndarray): 3D binary mask of the lesion.\n        A_pre (float): Pre-injection activity in MBq.\n        A_post (float): Post-injection residual activity in MBq.\n        M_kg (float): Patient body mass in kg.\n        H_cm (float): Patient height in cm.\n        sex (str): Patient sex, 'male' or 'female'.\n        t_min (float): Uptake time from injection to scan in minutes.\n        T_half_min (float): Radionuclide half-life in minutes.\n        \n    Returns:\n        list: A list of four floats [SUV_bw_mean, SUV_lbm_mean, SUV_peak, SUV_max].\n    \"\"\"\n    # Step 1: Activity Calculation\n    A_inj_MBq = A_pre - A_post\n    A_scan_MBq = A_inj_MBq * (2**(-t_min / T_half_min))\n    A_scan_kBq = A_scan_MBq * 1000\n\n    if A_scan_kBq == 0:\n        # Avoid division by zero if there's no activity\n        return [0.0, 0.0, 0.0, 0.0]\n\n    # Step 2: Mass and LBM Calculation\n    M_g = M_kg * 1000\n    H_m = H_cm / 100\n    \n    BMI = M_kg / (H_m**2)\n\n    if sex == 'male':\n        LBM_kg = (9270 * M_kg) / (6680 + 216 * BMI)\n    elif sex == 'female':\n        LBM_kg = (9270 * M_kg) / (8780 + 244 * BMI)\n    else:\n        raise ValueError(\"Sex must be 'male' or 'female'\")\n    LBM_g = LBM_kg * 1000\n\n    # Step 3: SUV Calculation\n    F_bw = M_g / A_scan_kBq\n    suv_bw_map = C_t_map * F_bw\n    \n    # Step 4: Radiomic Metrics Calculation\n    lesion_suv_bw_voxels = suv_bw_map[lesion_mask == 1]\n    \n    # Check if lesion is empty\n    if lesion_suv_bw_voxels.size == 0:\n        return [0.0, 0.0, 0.0, 0.0]\n\n    suv_bw_mean = np.mean(lesion_suv_bw_voxels)\n    \n    lbm_to_bw_ratio = LBM_g / M_g\n    suv_lbm_mean = suv_bw_mean * lbm_to_bw_ratio\n    \n    suv_max = np.max(lesion_suv_bw_voxels)\n\n    # SUV_peak calculation\n    kernel_means = []\n    # Iterate through all possible top-left-front corners of a 3x3x3 kernel\n    lim_z, lim_y, lim_x = [dim - 2 for dim in lesion_mask.shape]\n    if lim_z > 0 and lim_y > 0 and lim_x > 0:\n        for z in range(lim_z):\n            for y in range(lim_y):\n                for x in range(lim_x):\n                    # Define kernel regions for mask and SUV map\n                    mask_kernel = lesion_mask[z:z+3, y:y+3, x:x+3]\n                    \n                    # Check if the kernel is fully contained within the lesion\n                    if np.all(mask_kernel == 1):\n                        suv_kernel = suv_bw_map[z:z+3, y:y+3, x:x+3]\n                        kernel_means.append(np.mean(suv_kernel))\n\n    if not kernel_means:\n        suv_peak = suv_max\n    else:\n        suv_peak = max(kernel_means)\n\n    return [suv_bw_mean, suv_lbm_mean, suv_peak, suv_max]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"C_t_map\": np.array([\n                [[2.2, 2.4, 2.5, 2.3], [2.5, 3.0, 3.2, 2.6], [2.3, 2.9, 3.1, 2.4], [2.1, 2.2, 2.3, 2.0]],\n                [[2.4, 3.1, 3.5, 2.6], [3.2, 8.5, 12.0, 4.0], [3.1, 10.0, 14.5, 4.2], [2.6, 4.3, 5.0, 3.0]],\n                [[2.3, 3.0, 3.4, 2.5], [3.1, 9.0, 13.0, 4.1], [3.0, 11.5, 16.0, 4.4], [2.5, 4.5, 5.2, 3.1]],\n                [[2.2, 2.8, 3.0, 2.3], [2.9, 4.0, 4.5, 3.2], [2.8, 4.2, 4.8, 3.3], [2.3, 3.2, 3.5, 2.6]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [1, 2, 3], [1, 2, 3], [1, 2, 3]),\n            \"A_pre\": 370.0, \"A_post\": 5.0, \"M_kg\": 80.0, \"H_cm\": 180.0, \"sex\": \"male\", \"t_min\": 60.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[6.0, 7.0, 6.5], [6.8, 8.0, 7.2], [6.2, 7.5, 6.7]],\n                [[7.0, 9.0, 7.5], [8.5, 12.5, 9.0], [7.2, 9.5, 7.8]],\n                [[6.5, 7.8, 7.0], [7.5, 10.5, 8.2], [6.8, 8.7, 7.1]]\n            ]),\n            \"lesion_mask_def\": (\"all\",),\n            \"A_pre\": 185.0, \"A_post\": 0.0, \"M_kg\": 55.0, \"H_cm\": 165.0, \"sex\": \"female\", \"t_min\": 0.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[3.0, 4.0, 3.5], [4.5, 6.0, 5.0], [3.2, 4.8, 3.8]],\n                [[4.0, 5.0, 4.3], [6.5, 9.0, 7.5], [4.0, 6.2, 5.0]],\n                [[3.5, 4.2, 3.7], [5.2, 7.0, 6.0], [3.6, 5.5, 4.2]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [0, 1], [0, 1], [0, 1]),\n            \"A_pre\": 100.0, \"A_post\": 90.0, \"M_kg\": 100.0, \"H_cm\": 175.0, \"sex\": \"male\", \"t_min\": 120.0, \"T_half_min\": 109.77\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        shape = case[\"C_t_map\"].shape\n        mask = np.zeros(shape, dtype=int)\n        mask_def = case[\"lesion_mask_def\"]\n        if mask_def[0] == \"all\":\n            mask.fill(1)\n        elif mask_def[0] == \"indices\":\n            z_indices, y_indices, x_indices = mask_def[1], mask_def[2], mask_def[3]\n            for z in z_indices:\n                for y in y_indices:\n                    for x in x_indices:\n                        mask[z, y, x] = 1\n\n        results = compute_metrics(\n            case[\"C_t_map\"], mask, case[\"A_pre\"], case[\"A_post\"],\n            case[\"M_kg\"], case[\"H_cm\"], case[\"sex\"],\n            case[\"t_min\"], case[\"T_half_min\"]\n        )\n        all_results.append(results)\n    \n    # Format the final output string exactly as required\n    outer_parts = []\n    for res in all_results:\n        inner_parts = [f\"{val:.4f}\" for val in res]\n        outer_parts.append(f\"[{','.join(inner_parts)}]\")\n    \n    final_output_str = f\"[{','.join(outer_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}