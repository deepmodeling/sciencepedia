{
    "hands_on_practices": [
        {
            "introduction": "To describe the spatial relationships between medical images, we need a robust mathematical framework. This practice focuses on using homogeneous transformation matrices, a cornerstone of 3D computer vision and robotics that elegantly combines rotation and translation into a single matrix operation. By mastering the composition and inversion of these transforms , you will gain a fundamental skill for navigating between different coordinate systems, a common task in multimodal image fusion.",
            "id": "4892855",
            "problem": "A rigid image registration workflow in a multimodal study relates coordinates among three right-handed frames: a computed tomography (CT) image frame $\\mathcal{F}_{\\mathrm{CT}}$, a patient anatomical frame $\\mathcal{F}_{\\mathrm{P}}$, and a magnetic resonance imaging (MRI) frame $\\mathcal{F}_{\\mathrm{MRI}}$. Points are represented in homogeneous coordinates as $4 \\times 1$ column vectors with the last entry equal to $1$, and rigid transforms act by left-multiplication. By convention, a rigid transform with rotation matrix $\\mathbf{R} \\in \\mathbb{R}^{3 \\times 3}$ and translation vector $\\mathbf{t} \\in \\mathbb{R}^{3}$ maps a point $\\mathbf{x} \\in \\mathbb{R}^{3}$ as $\\mathbf{x}' = \\mathbf{R}\\,\\mathbf{x} + \\mathbf{t}$, encoded in the homogeneous form as the $4 \\times 4$ matrix\n$$\n\\mathbf{T} = \\begin{pmatrix}\n\\mathbf{R} & \\mathbf{t} \\\\\n\\mathbf{0}^{\\top} & 1\n\\end{pmatrix}.\n$$\nLet $\\mathbf{T}_1$ denote the rigid transform that maps coordinates from $\\mathcal{F}_{\\mathrm{CT}}$ to $\\mathcal{F}_{\\mathrm{P}}$ and let $\\mathbf{T}_2$ denote the rigid transform that maps coordinates from $\\mathcal{F}_{\\mathrm{P}}$ to $\\mathcal{F}_{\\mathrm{MRI}}$. Assume the following physically plausible specifications:\n- $\\mathbf{T}_1$ rotates by angle $\\alpha$ about the $z$-axis of $\\mathcal{F}_{\\mathrm{CT}}$ and then translates by $\\mathbf{t}_1 = \\begin{pmatrix} 10 \\\\ -5 \\\\ 2 \\end{pmatrix}$ in millimeters.\n- $\\mathbf{T}_2$ rotates by angle $\\beta$ about the $x$-axis of $\\mathcal{F}_{\\mathrm{P}}$ and then translates by $\\mathbf{t}_2 = \\begin{pmatrix} -3 \\\\ 4 \\\\ 1 \\end{pmatrix}$ in millimeters.\n\nAngles must be treated in radians. Start from the fundamental definitions above (rigid-body mapping in Cartesian coordinates and its homogeneous embedding). Derive, with careful attention to frame consistency, the explicit $4 \\times 4$ matrix of $\\mathbf{T}_2 \\mathbf{T}_1$ and the explicit $4 \\times 4$ matrix of $(\\mathbf{T}_2 \\mathbf{T}_1)^{-1}$ in terms of $\\alpha$, $\\beta$, $\\mathbf{t}_1$, and $\\mathbf{t}_2$. Then specialize to the numerical case $\\alpha = \\frac{\\pi}{6}$ and $\\beta = \\frac{\\pi}{4}$.\n\nFinally, compute the third component of the translation vector of $(\\mathbf{T}_2 \\mathbf{T}_1)^{-1}$, which is the $(3,4)$ entry of the $4 \\times 4$ inverse homogeneous matrix, and report its value in millimeters. Round your final numeric answer to four significant figures. Express angles in radians as specified, and distances in millimeters.",
            "solution": "The problem is first validated to ensure it is self-contained, scientifically grounded, and well-posed. The givens are:\n- Three right-handed frames: $\\mathcal{F}_{\\mathrm{CT}}$, $\\mathcal{F}_{\\mathrm{P}}$, $\\mathcal{F}_{\\mathrm{MRI}}$.\n- Points are $4 \\times 1$ homogeneous column vectors.\n- A rigid transform $\\mathbf{T}$ is a $4 \\times 4$ matrix of the form $\\mathbf{T} = \\begin{pmatrix} \\mathbf{R} & \\mathbf{t} \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix}$.\n- $\\mathbf{T}_1$: maps coordinates from $\\mathcal{F}_{\\mathrm{CT}}$ to $\\mathcal{F}_{\\mathrm{P}}$. It consists of a rotation by angle $\\alpha$ about the $z$-axis of $\\mathcal{F}_{\\mathrm{CT}}$ followed by a translation $\\mathbf{t}_1 = \\begin{pmatrix} 10 \\\\ -5 \\\\ 2 \\end{pmatrix}$.\n- $\\mathbf{T}_2$: maps coordinates from $\\mathcal{F}_{\\mathrm{P}}$ to $\\mathcal{F}_{\\mathrm{MRI}}$. It consists of a rotation by angle $\\beta$ about the $x$-axis of $\\mathcal{F}_{\\mathrm{P}}$ followed by a translation $\\mathbf{t}_2 = \\begin{pmatrix} -3 \\\\ 4 \\\\ 1 \\end{pmatrix}$.\n- Numerical values for specialization: $\\alpha = \\frac{\\pi}{6}$ and $\\beta = \\frac{\\pi}{4}$.\nThe problem is scientifically sound, resting on fundamental principles of rigid-body kinematics and their representation in homogeneous coordinates, a standard practice in medical imaging and robotics. It is well-posed, with all necessary information provided for a unique solution. The language is objective and precise. Therefore, the problem is valid.\n\nWe proceed with the derivation.\n\nFirst, we construct the matrix for $\\mathbf{T}_1$. The rotation is about the $z$-axis by an angle $\\alpha$, so the rotation matrix $\\mathbf{R}_1$ is:\n$$ \\mathbf{R}_1 = \\mathbf{R}_z(\\alpha) = \\begin{pmatrix} \\cos(\\alpha) & -\\sin(\\alpha) & 0 \\\\ \\sin(\\alpha) & \\cos(\\alpha) & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\nThe translation vector is $\\mathbf{t}_1 = \\begin{pmatrix} 10 \\\\ -5 \\\\ 2 \\end{pmatrix}$. The homogeneous transformation matrix $\\mathbf{T}_1$ is:\n$$ \\mathbf{T}_1 = \\begin{pmatrix} \\mathbf{R}_1 & \\mathbf{t}_1 \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix} = \\begin{pmatrix} \\cos(\\alpha) & -\\sin(\\alpha) & 0 & 10 \\\\ \\sin(\\alpha) & \\cos(\\alpha) & 0 & -5 \\\\ 0 & 0 & 1 & 2 \\\\ 0 & 0 & 0 & 1 \\end{pmatrix} $$\n\nNext, we construct the matrix for $\\mathbf{T}_2$. The rotation is about the $x$-axis by an angle $\\beta$, so the rotation matrix $\\mathbf{R}_2$ is:\n$$ \\mathbf{R}_2 = \\mathbf{R}_x(\\beta) = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(\\beta) & -\\sin(\\beta) \\\\ 0 & \\sin(\\beta) & \\cos(\\beta) \\end{pmatrix} $$\nThe translation vector is $\\mathbf{t}_2 = \\begin{pmatrix} -3 \\\\ 4 \\\\ 1 \\end{pmatrix}$. The homogeneous transformation matrix $\\mathbf{T}_2$ is:\n$$ \\mathbf{T}_2 = \\begin{pmatrix} \\mathbf{R}_2 & \\mathbf{t}_2 \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix} = \\begin{pmatrix} 1 & 0 & 0 & -3 \\\\ 0 & \\cos(\\beta) & -\\sin(\\beta) & 4 \\\\ 0 & \\sin(\\beta) & \\cos(\\beta) & 1 \\\\ 0 & 0 & 0 & 1 \\end{pmatrix} $$\n\nThe overall transformation from $\\mathcal{F}_{\\mathrm{CT}}$ to $\\mathcal{F}_{\\mathrm{MRI}}$ is the composition $\\mathbf{T}_{\\mathrm{comp}} = \\mathbf{T}_2 \\mathbf{T}_1$. A point $\\mathbf{p}_{\\mathrm{CT}}$ is mapped to $\\mathbf{p}_{\\mathrm{MRI}}$ by $\\mathbf{p}_{\\mathrm{MRI}} = \\mathbf{T}_2 (\\mathbf{T}_1 \\mathbf{p}_{\\mathrm{CT}}) = (\\mathbf{T}_2 \\mathbf{T}_1) \\mathbf{p}_{\\mathrm{CT}}$.\nLet $\\mathbf{T}_{\\mathrm{comp}} = \\begin{pmatrix} \\mathbf{R}_{\\mathrm{comp}} & \\mathbf{t}_{\\mathrm{comp}} \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix}$. The composite rotation is $\\mathbf{R}_{\\mathrm{comp}} = \\mathbf{R}_2 \\mathbf{R}_1$ and the composite translation is $\\mathbf{t}_{\\mathrm{comp}} = \\mathbf{R}_2 \\mathbf{t}_1 + \\mathbf{t}_2$.\n\n$$ \\mathbf{R}_{\\mathrm{comp}} = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(\\beta) & -\\sin(\\beta) \\\\ 0 & \\sin(\\beta) & \\cos(\\beta) \\end{pmatrix} \\begin{pmatrix} \\cos(\\alpha) & -\\sin(\\alpha) & 0 \\\\ \\sin(\\alpha) & \\cos(\\alpha) & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\begin{pmatrix} \\cos(\\alpha) & -\\sin(\\alpha) & 0 \\\\ \\cos(\\beta)\\sin(\\alpha) & \\cos(\\beta)\\cos(\\alpha) & -\\sin(\\beta) \\\\ \\sin(\\beta)\\sin(\\alpha) & \\sin(\\beta)\\cos(\\alpha) & \\cos(\\beta) \\end{pmatrix} $$\n$$ \\mathbf{t}_{\\mathrm{comp}} = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(\\beta) & -\\sin(\\beta) \\\\ 0 & \\sin(\\beta) & \\cos(\\beta) \\end{pmatrix} \\begin{pmatrix} 10 \\\\ -5 \\\\ 2 \\end{pmatrix} + \\begin{pmatrix} -3 \\\\ 4 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 10 \\\\ -5\\cos(\\beta) - 2\\sin(\\beta) \\\\ -5\\sin(\\beta) + 2\\cos(\\beta) \\end{pmatrix} + \\begin{pmatrix} -3 \\\\ 4 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 7 \\\\ 4-5\\cos(\\beta)-2\\sin(\\beta) \\\\ 1-5\\sin(\\beta)+2\\cos(\\beta) \\end{pmatrix} $$\nThe explicit matrix for $\\mathbf{T}_2 \\mathbf{T}_1$ is:\n$$ \\mathbf{T}_2 \\mathbf{T}_1 = \\begin{pmatrix} \\cos(\\alpha) & -\\sin(\\alpha) & 0 & 7 \\\\ \\cos(\\beta)\\sin(\\alpha) & \\cos(\\beta)\\cos(\\alpha) & -\\sin(\\beta) & 4-5\\cos(\\beta)-2\\sin(\\beta) \\\\ \\sin(\\beta)\\sin(\\alpha) & \\sin(\\beta)\\cos(\\alpha) & \\cos(\\beta) & 1-5\\sin(\\beta)+2\\cos(\\beta) \\\\ 0 & 0 & 0 & 1 \\end{pmatrix} $$\n\nNext, we derive the inverse transformation $(\\mathbf{T}_2 \\mathbf{T}_1)^{-1}$. The inverse of a homogeneous transform $\\mathbf{T} = \\begin{pmatrix} \\mathbf{R} & \\mathbf{t} \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix}$ is $\\mathbf{T}^{-1} = \\begin{pmatrix} \\mathbf{R}^{\\top} & -\\mathbf{R}^{\\top}\\mathbf{t} \\\\ \\mathbf{0}^{\\top} & 1 \\end{pmatrix}$.\nFor $\\mathbf{T}_{\\mathrm{comp}} = \\mathbf{T}_2 \\mathbf{T}_1$, the inverse rotation is $\\mathbf{R}_{\\mathrm{inv}} = \\mathbf{R}_{\\mathrm{comp}}^{\\top} = (\\mathbf{R}_2 \\mathbf{R}_1)^{\\top} = \\mathbf{R}_1^{\\top} \\mathbf{R}_2^{\\top}$.\nThe inverse translation is $\\mathbf{t}_{\\mathrm{inv}} = -\\mathbf{R}_{\\mathrm{comp}}^{\\top}\\mathbf{t}_{\\mathrm{comp}} = -(\\mathbf{R}_2\\mathbf{R}_1)^\\top (\\mathbf{R}_2 \\mathbf{t}_1 + \\mathbf{t}_2) = -(\\mathbf{R}_1^\\top \\mathbf{R}_2^\\top)(\\mathbf{R}_2 \\mathbf{t}_1 + \\mathbf{t}_2) = -\\mathbf{R}_1^{\\top}(\\mathbf{t}_1 + \\mathbf{R}_2^{\\top}\\mathbf{t}_2)$.\nThe third component of the inverse translation vector, $(\\mathbf{t}_{\\mathrm{inv}})_3$, is the third row of $-\\mathbf{R}_1^\\top$ multiplied by the vector $(\\mathbf{t}_1 + \\mathbf{R}_2^{\\top}\\mathbf{t}_2)$. The third row of $-\\mathbf{R}_1^\\top = -\\begin{pmatrix} \\cos(\\alpha) & \\sin(\\alpha) & 0 \\\\ -\\sin(\\alpha) & \\cos(\\alpha) & 0 \\\\ 0 & 0 & 1 \\end{pmatrix}$ is $(0, 0, -1)$.\nLet $\\mathbf{v} = \\mathbf{t}_1 + \\mathbf{R}_2^{\\top}\\mathbf{t}_2$. Then $(\\mathbf{t}_{\\mathrm{inv}})_3 = (0, 0, -1) \\cdot \\mathbf{v} = -v_3$.\nWe compute $v_3$, which is the third component of $\\mathbf{t}_1 + \\mathbf{R}_2^{\\top}\\mathbf{t}_2$.\nThe third component of $\\mathbf{t}_1$ is $2$.\nThe third component of $\\mathbf{R}_2^{\\top}\\mathbf{t}_2$ is the dot product of the third row of $\\mathbf{R}_2^\\top$ and $\\mathbf{t}_2$.\nThe third row of $\\mathbf{R}_2^\\top = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(\\beta) & \\sin(\\beta) \\\\ 0 & -\\sin(\\beta) & \\cos(\\beta) \\end{pmatrix}$ is $(0, -\\sin(\\beta), \\cos(\\beta))$.\nSo, the third component is $0 \\cdot (-3) - \\sin(\\beta) \\cdot 4 + \\cos(\\beta) \\cdot 1 = -4\\sin(\\beta) + \\cos(\\beta)$.\nThus, $v_3 = 2 - 4\\sin(\\beta) + \\cos(\\beta)$.\nThe component we seek is $(\\mathbf{t}_{\\mathrm{inv}})_3 = -v_3 = -(2 - 4\\sin(\\beta) + \\cos(\\beta)) = -2 + 4\\sin(\\beta) - \\cos(\\beta)$.\n\nWe now specialize to the case $\\beta = \\frac{\\pi}{4}$. The required value only depends on $\\beta$.\n$$ (\\mathbf{t}_{\\mathrm{inv}})_3 = -2 + 4\\sin\\left(\\frac{\\pi}{4}\\right) - \\cos\\left(\\frac{\\pi}{4}\\right) $$\nUsing $\\sin(\\frac{\\pi}{4}) = \\frac{\\sqrt{2}}{2}$ and $\\cos(\\frac{\\pi}{4}) = \\frac{\\sqrt{2}}{2}$:\n$$ (\\mathbf{t}_{\\mathrm{inv}})_3 = -2 + 4\\left(\\frac{\\sqrt{2}}{2}\\right) - \\frac{\\sqrt{2}}{2} = -2 + 2\\sqrt{2} - \\frac{1}{2}\\sqrt{2} = -2 + \\frac{3}{2}\\sqrt{2} $$\nTo find the numerical value, we use $\\sqrt{2} \\approx 1.41421356...$:\n$$ (\\mathbf{t}_{\\mathrm{inv}})_3 \\approx -2 + \\frac{3}{2}(1.41421356) = -2 + 2.12132034 = 0.12132034 $$\nRounding to four significant figures, we get $0.1213$. The units are millimeters.",
            "answer": "$$\\boxed{0.1213}$$"
        },
        {
            "introduction": "Moving from abstract transformations to a practical registration task, this exercise simulates a common clinical scenario: aligning two images using a set of corresponding anatomical landmarks. You will apply the principles of least-squares optimization to find the optimal rigid transformation that maps one set of points to another. This practice  is crucial for understanding how to not only perform a registration but also to quantitatively evaluate its accuracy using the concept of Target Registration Error (TRE), a key metric for assessing clinical utility.",
            "id": "4892896",
            "problem": "A two-dimensional rigid registration is performed between a pre-operative axial slice and an intra-operative axial slice of the same patient. The rigid transform from the pre-operative coordinate system to the intra-operative coordinate system is of the form $\\mathbf{x}' = \\mathbf{R}\\mathbf{x} + \\mathbf{t}$, where $\\mathbf{R} \\in \\mathbb{R}^{2 \\times 2}$ is a rotation matrix with $\\det(\\mathbf{R}) = 1$ and $\\mathbf{t} \\in \\mathbb{R}^{2}$ is a translation vector. The transform is estimated by minimizing the sum of squared distances between corresponding fiducial landmarks (least squares). Use only the following foundational facts: a rigid transform preserves distances and angles; a least-squares rigid alignment that minimizes the sum of squared inter-landmark distances is achieved by aligning centroids and then finding the rotation that best aligns centered point sets.\n\nYou are given the following fiducial correspondences (all coordinates are in millimeters), where the first coordinate in each pair is in the pre-operative frame and the second is in the intra-operative frame:\n- $\\mathbf{p}_{1} = (0,\\,0)$ corresponds to $\\mathbf{q}_{1} = (1,\\,2)$,\n- $\\mathbf{p}_{2} = (1,\\,0)$ corresponds to $\\mathbf{q}_{2} = (1,\\,3)$,\n- $\\mathbf{p}_{3} = (0,\\,2)$ corresponds to $\\mathbf{q}_{3} = (-1,\\,2)$.\n\nAfter estimating the rigid transform from these fiducials, you will evaluate the Root Mean Square Target Registration Error (RMS-TRE) on two independent target landmarks (not used in the estimation). The target landmarks are:\n- $\\mathbf{t}_{1} = (2,\\,1)$ in the pre-operative frame corresponds to $\\mathbf{u}_{1} = (0.2,\\,3.8)$ in the intra-operative frame,\n- $\\mathbf{t}_{2} = (-1,\\,1)$ in the pre-operative frame corresponds to $\\mathbf{u}_{2} = (0.2,\\,1.2)$ in the intra-operative frame.\n\nTasks:\n1. From first principles of rigid alignment, determine the least-squares rigid transform parameters $(\\mathbf{R}, \\mathbf{t})$ that map the pre-operative frame to the intra-operative frame using the fiducials $\\{\\mathbf{p}_{i}\\} \\leftrightarrow \\{\\mathbf{q}_{i}\\}$.\n2. Apply the estimated transform to the target landmarks $\\{\\mathbf{t}_{j}\\}$ to obtain transformed points $\\{\\hat{\\mathbf{u}}_{j}\\}$ in the intra-operative frame. Compute the Root Mean Square Target Registration Error (RMS-TRE) defined as\n$$\n\\mathrm{RMS\\mbox{-}TRE} \\;=\\; \\sqrt{\\frac{1}{M}\\sum_{j=1}^{M} \\lVert \\hat{\\mathbf{u}}_{j} - \\mathbf{u}_{j} \\rVert^{2}},\n$$\nwhere $\\lVert \\cdot \\rVert$ denotes the Euclidean norm and $M$ is the number of target landmarks.\n3. Compute the pre-registration RMS error on the same targets, defined as\n$$\n\\mathrm{RMS\\mbox{-}pre} \\;=\\; \\sqrt{\\frac{1}{M}\\sum_{j=1}^{M} \\lVert \\mathbf{t}_{j} - \\mathbf{u}_{j} \\rVert^{2}},\n$$\nwhich corresponds to evaluating the error under the identity mapping (no registration).\n4. Report the single dimensionless ratio\n$$\nr \\;=\\; \\frac{\\mathrm{RMS\\mbox{-}TRE}}{\\mathrm{RMS\\mbox{-}pre}}.\n$$\n\nRound your final answer for $r$ to four significant figures. Do not include any unit with your final answer. Angles, if any are used internally, must be treated in radians, but no angle is requested in the final answer.",
            "solution": "The problem requires finding a 2D rigid transformation and then evaluating its performance using target landmarks. The solution follows the principle of least-squares rigid alignment, which involves aligning the centroids of the point sets and then finding the optimal rotation.\n\n**1. Determine the Rigid Transform $(\\mathbf{R}, \\mathbf{t})$**\n\nFirst, we compute the centroids of the source (pre-operative) fiducial points $\\{\\mathbf{p}_i\\}$ and the target (intra-operative) fiducial points $\\{\\mathbf{q}_i\\}$.\n$$ \\bar{\\mathbf{p}} = \\frac{1}{3} \\sum_{i=1}^{3} \\mathbf{p}_{i} = \\frac{1}{3} \\left( \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 0 \\\\ 2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/3 \\\\ 2/3 \\end{pmatrix} $$\n$$ \\bar{\\mathbf{q}} = \\frac{1}{3} \\sum_{i=1}^{3} \\mathbf{q}_{i} = \\frac{1}{3} \\left( \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} -1 \\\\ 2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} $$\nThe given fiducials correspond to a perfect rigid transformation (inter-point distances are preserved), which means the least-squares error on these points is zero. This allows us to determine the rotation matrix $\\mathbf{R}$ exactly. Consider the vectors formed by the fiducials:\nA vector $\\mathbf{v}_1 = \\mathbf{p}_2 - \\mathbf{p}_1 = (1, 0)^{\\top}$ must be rotated to become $\\mathbf{w}_1 = \\mathbf{q}_2 - \\mathbf{q}_1 = (0, 1)^{\\top}$.\nA vector $\\mathbf{v}_2 = \\mathbf{p}_3 - \\mathbf{p}_1 = (0, 2)^{\\top}$ must be rotated to become $\\mathbf{w}_2 = \\mathbf{q}_3 - \\mathbf{q}_1 = (-2, 0)^{\\top}$.\nThe rotation that maps $(1,0)^{\\top}$ to $(0,1)^{\\top}$ is a rotation by $+\\pi/2$ radians (or 90 degrees). The corresponding rotation matrix is:\n$$ \\mathbf{R} = \\begin{pmatrix} \\cos(\\pi/2) & -\\sin(\\pi/2) \\\\ \\sin(\\pi/2) & \\cos(\\pi/2) \\end{pmatrix} = \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} $$\nWe verify this with the second pair of vectors: $\\mathbf{R}\\mathbf{v}_2 = \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} = \\mathbf{w}_2$. The rotation is correct.\n\nThe translation vector $\\mathbf{t}$ is found by ensuring the centroids align after rotation: $\\mathbf{t} = \\bar{\\mathbf{q}} - \\mathbf{R}\\bar{\\mathbf{p}}$.\n$$ \\mathbf{t} = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} - \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} \\begin{pmatrix} 1/3 \\\\ 2/3 \\end{pmatrix} = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} - \\begin{pmatrix} -2/3 \\\\ 1/3 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} $$\nSo the complete transformation is $\\mathbf{x}' = \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} \\mathbf{x} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix}$.\n\n**2. Compute the Root Mean Square Target Registration Error (RMS-TRE)**\n\nWe apply the estimated transform to the pre-operative target landmarks $\\{\\mathbf{t}_j\\}$ to get the predicted intra-operative positions $\\{\\hat{\\mathbf{u}}_j\\}$.\nFor $\\mathbf{t}_1 = (2, 1)^{\\top}$:\n$$ \\hat{\\mathbf{u}}_1 = \\mathbf{R}\\mathbf{t}_1 + \\mathbf{t} = \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} \\begin{pmatrix} 2 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ 2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 4 \\end{pmatrix} $$\nFor $\\mathbf{t}_2 = (-1, 1)^{\\top}$:\n$$ \\hat{\\mathbf{u}}_2 = \\mathbf{R}\\mathbf{t}_2 + \\mathbf{t} = \\begin{pmatrix} 0 & -1 \\\\ 1 & 0 \\end{pmatrix} \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ -1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} $$\nNow we compute the squared Euclidean distance to the true intra-operative positions $\\mathbf{u}_1 = (0.2, 3.8)^{\\top}$ and $\\mathbf{u}_2 = (0.2, 1.2)^{\\top}$.\n$$ \\lVert \\hat{\\mathbf{u}}_1 - \\mathbf{u}_1 \\rVert^2 = \\lVert (0, 4) - (0.2, 3.8) \\rVert^2 = (-0.2)^2 + (0.2)^2 = 0.04 + 0.04 = 0.08 $$\n$$ \\lVert \\hat{\\mathbf{u}}_2 - \\mathbf{u}_2 \\rVert^2 = \\lVert (0, 1) - (0.2, 1.2) \\rVert^2 = (-0.2)^2 + (-0.2)^2 = 0.04 + 0.04 = 0.08 $$\nThe RMS-TRE is:\n$$ \\mathrm{RMS\\mbox{-}TRE} = \\sqrt{\\frac{1}{2}(0.08 + 0.08)} = \\sqrt{0.08} $$\n\n**3. Compute the Pre-registration RMS Error (RMS-pre)**\n\nThis is the RMS error without any registration, i.e., assuming an identity transform.\n$$ \\lVert \\mathbf{t}_1 - \\mathbf{u}_1 \\rVert^2 = \\lVert (2, 1) - (0.2, 3.8) \\rVert^2 = (1.8)^2 + (-2.8)^2 = 3.24 + 7.84 = 11.08 $$\n$$ \\lVert \\mathbf{t}_2 - \\mathbf{u}_2 \\rVert^2 = \\lVert (-1, 1) - (0.2, 1.2) \\rVert^2 = (-1.2)^2 + (-0.2)^2 = 1.44 + 0.04 = 1.48 $$\nThe pre-registration RMS error is:\n$$ \\mathrm{RMS\\mbox{-}pre} = \\sqrt{\\frac{1}{2}(11.08 + 1.48)} = \\sqrt{\\frac{12.56}{2}} = \\sqrt{6.28} $$\n\n**4. Report the Ratio**\n\nFinally, we compute the ratio $r$:\n$$ r = \\frac{\\mathrm{RMS\\mbox{-}TRE}}{\\mathrm{RMS\\mbox{-}pre}} = \\frac{\\sqrt{0.08}}{\\sqrt{6.28}} = \\sqrt{\\frac{0.08}{6.28}} = \\sqrt{\\frac{2}{157}} \\approx 0.1128665... $$\nRounding to four significant figures, we get $r = 0.1129$.",
            "answer": "$$ \\boxed{0.1129} $$"
        },
        {
            "introduction": "While rigid registration corrects for patient position, many scenarios require accounting for tissue deformation, which necessitates more flexible, non-rigid models. This practice introduces you to Free-Form Deformations (FFD) based on B-splines, a powerful tool for deformable registration. You will investigate a key property of any deformation—its local invertibility—by calculating the Jacobian determinant to ensure the transformation is physically plausible and does not \"fold\" space onto itself .",
            "id": "4892868",
            "problem": "Consider a two-dimensional Free-Form Deformation (FFD) based on tensor-product cubic B-splines for image registration. Let the spatial transform be defined as a displacement field superposed on the identity mapping, where the deformed position is given by $\\mathbf{T}(x,y) = (x,y) + \\mathbf{u}(x,y)$. The displacement field is constructed from a uniform control lattice of spacing $h$ using the tensor-product cubic B-spline basis functions. Within any lattice cell, introduce the parametric coordinates $s \\in [0,1]$ and $t \\in [0,1]$, and let the local displacement be $\\mathbf{u}(x,y) = \\sum_{p=0}^{3} \\sum_{q=0}^{3} B_{p}(s) B_{q}(t) \\,\\mathbf{d}_{p,q}$, where $\\mathbf{d}_{p,q} = (d^{x}_{p,q}, d^{y}_{p,q})$ are the control point displacements.\n\nThe cubic B-spline basis functions on $[0,1]$ are defined by\n$$\nB_{0}(r) = \\frac{(1-r)^{3}}{6}, \\quad\nB_{1}(r) = \\frac{3r^{3} - 6r^{2} + 4}{6}, \\quad\nB_{2}(r) = \\frac{-3r^{3} + 3r^{2} + 3r + 1}{6}, \\quad\nB_{3}(r) = \\frac{r^{3}}{6},\n$$\nfor any scalar argument $r \\in [0,1]$.\n\nAssume a single nonzero control displacement within the $4 \\times 4$ neighborhood influencing the evaluation point: specifically, $\\mathbf{d}_{1,2} = (a,b)$ with $a = 2$ mm and $b = -1$ mm, and all other $\\mathbf{d}_{p,q} = (0,0)$. The control lattice spacing is $h = 20$ mm. Evaluate at the center of the cell, where $s = 0.5$ and $t = 0.5$.\n\nStarting from the definitions above and basic multivariable calculus (chain rule), compute the Jacobian determinant $J(x,y) = \\det\\!\\left(\\nabla \\mathbf{T}(x,y)\\right)$ at the evaluation point. Then, determine whether the mapping is locally invertible by checking the sign of $J(x,y)$. Express the final answer as a single exact value for the Jacobian determinant (dimensionless). No rounding is required.",
            "solution": "The problem requires the computation of the Jacobian determinant for a Free-Form Deformation (FFD) at a specific point to assess its local invertibility.\n\nThe transformation is defined as $\\mathbf{T}(x,y) = (x,y) + \\mathbf{u}(x,y)$. Its Jacobian matrix is $\\nabla \\mathbf{T} = \\mathbf{I} + \\nabla \\mathbf{u}$. Since only the control point displacement $\\mathbf{d}_{1,2} = (a, b)$ is non-zero, the displacement field simplifies to:\n$$ \\mathbf{u}(x,y) = B_{1}(s) B_{2}(t) \\mathbf{d}_{1,2} $$\nwhere $s$ and $t$ are local parametric coordinates within a grid cell of spacing $h$. The spatial derivatives of $s$ and $t$ are $\\frac{\\partial s}{\\partial x} = \\frac{1}{h}$, $\\frac{\\partial t}{\\partial y} = \\frac{1}{h}$, and other partials are zero.\n\nUsing the chain rule, the Jacobian matrix of the displacement field $\\nabla \\mathbf{u}$ is:\n$$ \\nabla \\mathbf{u}(x,y) = \\begin{pmatrix} \\frac{\\partial u_x}{\\partial x} & \\frac{\\partial u_x}{\\partial y} \\\\ \\frac{\\partial u_y}{\\partial x} & \\frac{\\partial u_y}{\\partial y} \\end{pmatrix} = \\frac{1}{h} \\begin{pmatrix} a B'_{1}(s) B_{2}(t) & a B_{1}(s) B'_{2}(t) \\\\ b B'_{1}(s) B_{2}(t) & b B_{1}(s) B'_{2}(t) \\end{pmatrix} $$\nwhere $B'_k(r) = \\frac{dB_k}{dr}$. The Jacobian determinant of the full transformation $\\mathbf{T}$ is $J = \\det(\\mathbf{I} + \\nabla \\mathbf{u})$.\n$$ J = \\left(1 + \\frac{a}{h} B'_{1}(s) B_{2}(t)\\right) \\left(1 + \\frac{b}{h} B_{1}(s) B'_{2}(t)\\right) - \\left(\\frac{a}{h} B_{1}(s) B'_{2}(t)\\right) \\left(\\frac{b}{h} B'_{1}(s) B_{2}(t)\\right) $$\nExpanding and simplifying, the cross-product terms cancel out, leaving:\n$$ J = 1 + \\frac{a}{h} B'_{1}(s) B_{2}(t) + \\frac{b}{h} B_{1}(s) B'_{2}(t) $$\nNext, we evaluate the B-spline basis functions and their derivatives at the specified point $s = 0.5$ and $t = 0.5$. Let $r=0.5$.\nThe required functions are $B_1(r)$ and $B_2(r)$, and their derivatives $B'_1(r)$ and $B'_2(r)$.\n$$ B_{1}(r) = \\frac{3r^{3} - 6r^{2} + 4}{6} \\implies B_{1}(0.5) = \\frac{3(0.125) - 6(0.25) + 4}{6} = \\frac{0.375 - 1.5 + 4}{6} = \\frac{2.875}{6} = \\frac{23/8}{6} = \\frac{23}{48} $$\n$$ B_{2}(r) = \\frac{-3r^{3} + 3r^{2} + 3r + 1}{6} \\implies B_{2}(0.5) = \\frac{-3(0.125) + 3(0.25) + 3(0.5) + 1}{6} = \\frac{-0.375 + 0.75 + 1.5 + 1}{6} = \\frac{2.875}{6} = \\frac{23}{48} $$\nThe derivatives are:\n$$ B'_{1}(r) = \\frac{9r^2 - 12r}{6} \\implies B'_{1}(0.5) = \\frac{9(0.25) - 12(0.5)}{6} = \\frac{2.25 - 6}{6} = \\frac{-3.75}{6} = -\\frac{15}{24} = -\\frac{5}{8} $$\n$$ B'_{2}(r) = \\frac{-9r^2 + 6r + 3}{6} \\implies B'_{2}(0.5) = \\frac{-9(0.25) + 6(0.5) + 3}{6} = \\frac{-2.25 + 3 + 3}{6} = \\frac{3.75}{6} = \\frac{15}{24} = \\frac{5}{8} $$\nNow substitute these values along with $a=2$, $b=-1$, and $h=20$ into the expression for $J$:\n$$ J = 1 + \\frac{2}{20} B'_{1}(0.5) B_{2}(0.5) + \\frac{-1}{20} B_{1}(0.5) B'_{2}(0.5) $$\n$$ J = 1 + \\frac{1}{10} \\left(-\\frac{5}{8}\\right) \\left(\\frac{23}{48}\\right) - \\frac{1}{20} \\left(\\frac{23}{48}\\right) \\left(\\frac{5}{8}\\right) $$\n$$ J = 1 - \\frac{115}{3840} - \\frac{115}{7680} = 1 - \\frac{230}{7680} - \\frac{115}{7680} = 1 - \\frac{345}{7680} $$\nSimplify the fraction:\n$$ \\frac{345}{7680} = \\frac{69}{1536} = \\frac{23}{512} $$\nTherefore, the Jacobian determinant is:\n$$ J = 1 - \\frac{23}{512} = \\frac{512 - 23}{512} = \\frac{489}{512} $$\nSince $J = 489/512 > 0$, the transformation is locally invertible (it preserves orientation and does not fold space) at the evaluated point. The final answer is the exact value of the determinant.",
            "answer": "$$\n\\boxed{\\frac{489}{512}}\n$$"
        }
    ]
}