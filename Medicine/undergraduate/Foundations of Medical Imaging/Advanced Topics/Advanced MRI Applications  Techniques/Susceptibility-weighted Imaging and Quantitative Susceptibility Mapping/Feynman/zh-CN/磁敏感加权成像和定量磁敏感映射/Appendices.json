{
    "hands_on_practices": [
        {
            "introduction": "这第一个练习将巩固您对相位衬度磁共振成像最基本原理的理解。我们将演示一个静态的磁场偏移（无论其来源如何）如何导致一个随回波时间（$TE$）线性增长的相位偏移。这项练习对于掌握相位缠绕（phase wrapping）的概念至关重要，这是SWI和QSM中的一个关键技术挑战，直接决定了成像参数的选择。",
            "id": "4929425",
            "problem": "在磁敏感加权成像 (SWI) 和定量磁敏感图 (QSM) 中，梯度回波相位反映了由磁敏感性变化引起的局部离共振。考虑在主磁场强度为 $3\\,\\mathrm{T}$ 的条件下进行的一次扰相梯度回波采集，其中一个局部磁敏感源产生了一个静态的离共振场偏移，该偏移在一个体素内空间上是均匀的。设该偏移记为 $\\Delta B$，并假定在回波形成期间以及在时间上是恒定的。在回波时间 $TE$ 测得的相位 $\\phi$（单位为弧度）完全由该离共振引起，忽略所有其他相位贡献（例如，射频相位、梯度矩不完美和化学位移）。\n\n请仅从 Larmor 关系式 $\\omega=\\gamma B$ 以及相位是角频率的时间积分这一定义出发，证明当 $\\Delta B$ 在体素内不随时间变化且空间均匀时，$\\phi$ 与 $TE$ 成线性关系。然后，对于在 $3\\,\\mathrm{T}$ 场下给定的离共振幅度 $\\Delta B=0.20\\,\\mu\\mathrm{T}$，确定最大回波时间 $TE_{\\max}$，使得 $|\\phi|\\leq \\pi$（弧度），以避免相位缠绕。使用质子旋磁比 $\\gamma = 2\\pi\\times 42.577\\times 10^{6}\\,\\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$。请将最终的 $TE_{\\max}$ 以 $\\mathrm{ms}$ 为单位表示，并将答案四舍五入到三位有效数字。",
            "solution": "该问题是有效的，因为它基于核磁共振的科学原理，在数学上是适定的，并且以客观、明确的语言呈现。求解唯一解所需的所有数据和常数均已提供。我们将首先在给定条件下证明相位和回波时间之间的线性关系，然后计算避免相位缠绕的最大回波时间。\n\n问题的第一部分要求证明累积相位 $\\phi$ 与回波时间 $TE$ 成线性关系。我们从 Larmor 关系式开始，该关系式指出，核自旋的角进动频率 $\\omega$ 与其所经历的磁场强度 $B$ 成正比：\n$$ \\omega = \\gamma B $$\n其中 $\\gamma$ 是旋磁比。\n\n在磁共振成像实验中，一个体素内核自spin所经历的总磁场可以写为主静态磁场 $B_0$ 与一个小的、位置相关且可能随时间变化的场偏移 $\\Delta B(\\vec{r}, t)$ 之和。此处，问题指明了一个局部的离共振场偏移 $\\Delta B$，它在体素内空间均匀且不随时间变化。因此，总磁场为 $B = B_0 + \\Delta B$。相应的角频率为：\n$$ \\omega = \\gamma (B_0 + \\Delta B) = \\gamma B_0 + \\gamma \\Delta B $$\n这可以表示为 Larmor 频率 $\\omega_0 = \\gamma B_0$ 和角频率偏移 $\\Delta\\omega = \\gamma \\Delta B$ 的和。\n\n横向磁化强度的相位定义为角频率的时间积分。在以 Larmor 频率 $\\omega_0$ 旋转的旋转坐标系中，相位演化完全由频率偏移 $\\Delta\\omega$ 决定。问题指出，测量的相位 $\\phi$ 完全由该离共振分量产生。因此，从时间 $t=0$ 到回波时间 $t=TE$ 累积的相位由以下积分给出：\n$$ \\phi(TE) = \\int_{0}^{TE} \\Delta\\omega(t) \\,dt $$\n根据问题陈述，场偏移 $\\Delta B$ 不随时间变化。由于 $\\gamma$ 是一个基本常数，频率偏移 $\\Delta\\omega = \\gamma \\Delta B$ 也相对于时间是恒定的。这使我们可以将 $\\Delta\\omega$ 从积分中提出来：\n$$ \\phi(TE) = \\Delta\\omega \\int_{0}^{TE} dt = (\\gamma \\Delta B) [t]_{0}^{TE} $$\n计算该定积分得出：\n$$ \\phi(TE) = (\\gamma \\Delta B) \\cdot TE $$\n这个方程明确地证明了采集到的相位 $\\phi$ 是回波时间 $TE$ 的线性函数，其比例常数为乘积 $\\gamma \\Delta B$。这完成了问题的第一部分。\n\n问题的第二部分要求计算最大回波时间 $TE_{\\max}$，使得相位的大小不超过 $\\pi$ 弧度。这个条件 $|\\phi| \\leq \\pi$ 对于避免相位模糊或“缠绕”至关重要，在相位缠绕的情况下，$\\pi+\\epsilon$ 和 $-\\pi+\\epsilon$ 的相位变得无法区分。\n\n使用上面导出的关系，条件是：\n$$ |(\\gamma \\Delta B) \\cdot TE| \\leq \\pi $$\n鉴于旋磁比 $\\gamma$、场偏移 $\\Delta B$ 和回波时间 $TE$ 都是非负量，可以去掉绝对值符号：\n$$ (\\gamma \\Delta B) \\cdot TE \\leq \\pi $$\n为了找到最大回波时间 $TE_{\\max}$，我们考虑等式成立的情况：\n$$ (\\gamma \\Delta B) \\cdot TE_{\\max} = \\pi $$\n解出 $TE_{\\max}$ 可得：\n$$ TE_{\\max} = \\frac{\\pi}{\\gamma \\Delta B} $$\n我们已知以下数值：\n质子旋磁比，$\\gamma = 2\\pi \\times 42.577 \\times 10^{6}\\,\\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$。\n离共振场偏移，$\\Delta B = 0.20\\,\\mu\\mathrm{T} = 0.20 \\times 10^{-6}\\,\\mathrm{T}$。\n\n将这些值代入 $TE_{\\max}$ 的表达式中：\n$$ TE_{\\max} = \\frac{\\pi}{(2\\pi \\times 42.577 \\times 10^{6}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}) \\times (0.20 \\times 10^{-6}\\,\\mathrm{T})} $$\n分子和分母中的 $\\pi$ 因子可以消掉。$10^{6}$ 和 $10^{-6}$ 的因子也可以消掉：\n$$ TE_{\\max} = \\frac{1}{(2 \\times 42.577) \\times 0.20}\\,\\mathrm{s} $$\n$$ TE_{\\max} = \\frac{1}{85.154 \\times 0.20}\\,\\mathrm{s} = \\frac{1}{17.0308}\\,\\mathrm{s} $$\n计算数值结果：\n$$ TE_{\\max} \\approx 0.0587173\\,\\mathrm{s} $$\n问题要求答案以毫秒（$\\mathrm{ms}$）表示，并四舍五入到三位有效数字。\n$$ TE_{\\max} \\approx 0.0587173 \\times 1000\\,\\mathrm{ms} \\approx 58.7173\\,\\mathrm{ms} $$\n四舍五入到三位有效数字，我们得到：\n$$ TE_{\\max} = 58.7\\,\\mathrm{ms} $$",
            "answer": "$$\\boxed{58.7}$$"
        },
        {
            "introduction": "在相位累积概念的基础上，接下来的练习将抽象的相位概念与组织的磁化率（$\\chi$）直接联系起来。您将使用不同脑组织的实际磁化率值来计算一个实用的成像参数——回波时间（$TE$）。这项练习阐明了组织成分的差异（例如铁含量或钙化）如何能被转化为磁共振实验中可测量的信号变化。",
            "id": "4929364",
            "problem": "在磁共振成像 (MRI) 中，磁敏感加权成像 (SWI) 和定量磁敏感图 (QSM) 利用磁化率的空间变化来生成图像对比度并估计组织的磁特性。考虑一个 $B_0 = 3$ T 的系统，并专注于生物学上符合实际的、大块的、各向同性的组织区域，在这些区域中，宏观几何形状和退磁效应可以忽略不计，因此均匀区域内的局部场扰动可以近似为 $\\Delta B \\approx B_0 \\,\\Delta \\chi$，其中 $\\Delta \\chi$ 是该区域与参考区域之间的体磁化率差异。\n\nA部分：利用静磁学以及磁化强度与磁场之间的本构关系，解释为什么体磁化率 $\\chi$ 是一个无量纲量。\n\nB部分：采用四种组织类型的代表性体磁化率（相对于脑脊液），以百万分率 (ppm) 表示，其中 $1$ ppm $= 1 \\times 10^{-6}$：\n- 富含髓鞘的白质：$\\chi_{\\mathrm{wm}} = -0.03$ ppm。\n- 皮层灰质：$\\chi_{\\mathrm{gm}} = +0.03$ ppm。\n- 富含铁的深部灰质核团：$\\chi_{\\mathrm{iron}} = +0.15$ ppm。\n- 钙化（磷酸钙沉积）：$\\chi_{\\mathrm{calc}} = -1.00$ ppm。\n\n假设局部 Larmor 角频率满足 $\\omega = \\gamma B$，其中 $\\gamma = 2\\pi \\times 42.577 \\times 10^{6}$ s$^{-1}$T$^{-1}$ 是质子旋磁比。在一个区域中的自旋在回波时间 $\\mathrm{TE}$ 内累积的梯度回波相位与局部角频率的关系为 $\\Delta \\phi = \\Delta \\omega \\,\\mathrm{TE}$。\n\n在体近似 $\\Delta B \\approx B_0 \\,\\Delta \\chi$ 且忽略背景场的条件下，计算在富铁区域和钙化区域之间产生 $\\pi$ 弧度累积相位差所需的回波时间 $\\mathrm{TE}$（以毫秒为单位）。将您的答案四舍五入到四位有效数字，并以毫秒表示。从第一性原理出发，清晰地陈述所有中间推理过程，并论证使用体近似进行这些估计的合理性。",
            "solution": "此问题包括两部分。A部分要求从理论上解释为什么磁化率是无量纲量。B部分要求根据给定的组织特性，定量计算MRI实验中的回波时间。\n\nA部分：体磁化率的量纲\n\n体磁化率，用符号 $\\chi$ 表示，是衡量材料对外加磁场响应程度的物理量。其量纲可以从静磁学的基本本构关系中严格确定。在国际单位制 (SI) 中，磁通量密度 $\\mathbf{B}$、磁场强度 $\\mathbf{H}$ 和材料的磁化强度 $\\mathbf{M}$（定义为单位体积内的磁偶极矩）由以下方程关联：\n$$\n\\mathbf{B} = \\mu_0 (\\mathbf{H} + \\mathbf{M})\n$$\n其中 $\\mu_0$ 是真空磁导率。\n\n对于线性、各向同性的磁性材料，感应磁化强度 $\\mathbf{M}$ 与外加磁场强度 $\\mathbf{H}$ 成正比。它们的关系由体磁化率 $\\chi$ 定义：\n$$\n\\mathbf{M} = \\chi \\mathbf{H}\n$$\n为了确定 $\\chi$ 的量纲，我们必须分析这个定义方程中各物理量的单位。在国际单位制中：\n- 磁化强度 $\\mathbf{M}$ 的单位是安培每米 (A/m)。这是根据其定义——单位体积 (单位: m$^3$) 内的磁偶极矩 (单位: A$\\cdot$m$^2$) ——得出的。\n- 磁场强度 $\\mathbf{H}$ 的单位也是安培每米 (A/m)。\n\n将这些单位代入 $\\chi$ 的定义方程：\n$$\n[\\text{units of } \\mathbf{M}] = [\\text{units of } \\chi] \\times [\\text{units of } \\mathbf{H}]\n$$\n$$\n\\frac{\\text{A}}{\\text{m}} = [\\text{units of } \\chi] \\times \\frac{\\text{A}}{\\text{m}}\n$$\n为使此等式成立，$[\\text{units of } \\chi]$ 项必须等于 $1$。因此，体磁化率 $\\chi$ 是一个无量纲量。它通常以百万分率 (ppm) 表示，其中 $1 \\text{ ppm} = 1 \\times 10^{-6}$，以便于表示生物组织中常见的微小数值。\n\nB部分：回波时间 $\\mathrm{TE}$ 的计算\n\n问题的这一部分要求我们计算富铁组织区域与钙化区域之间的相位差达到 $\\pi$ 弧度时的具体回波时间 $\\mathrm{TE}$。\n\n首先，我们分析梯度回波MRI序列中磁化率与观测相位之间的关系。质子自旋的 Larmor 角频率 $\\omega$ 与其所经历的局部磁场 $B$ 成正比：\n$$\n\\omega = \\gamma B\n$$\n其中 $\\gamma$ 是质子旋磁比。\n\n问题陈述，对于一个均匀区域，由组织磁化率引起的局部场扰动 $\\Delta B$ 可近似为 $\\Delta B \\approx B_0 \\Delta\\chi$。此处，$\\Delta\\chi$ 是组织相对于参考介质（CSF，脑脊液）的磁化率差异，$B_0$ 是主磁场强度。如问题所述，这种体近似的理由是基于“可忽略宏观几何形状和退磁效应的大块、各向同性组织区域”的假设。实际上，场扰动与形状有关（一种退磁效应），但对于大的、几何形状简单的或内部的体积，这种领头阶近似是进行估算的合理起点。\n\n组织区域 'i' 内的局部磁场为 $B_i = B_0 + \\Delta B_i \\approx B_0 (1 + \\Delta \\chi_i)$，其中 $\\Delta \\chi_i$ 是组织 'i' 相对于参考介质的磁化率。因此，该区域相对于参考 Larmor 频率 $\\omega_0 = \\gamma B_0$ 的频率偏移 $\\Delta \\omega_i$ 为：\n$$\n\\Delta \\omega_i = \\omega_i - \\omega_0 = \\gamma (B_i - B_0) = \\gamma \\Delta B_i \\approx \\gamma B_0 \\Delta \\chi_i\n$$\n这个频率偏移在回波时间 $\\mathrm{TE}$ 内引起相位累积 $\\Delta \\phi_i$：\n$$\n\\Delta \\phi_i = \\Delta \\omega_i \\cdot \\mathrm{TE}\n$$\n我们关心的是富铁区域和钙化区域之间的相位差。这个差值，我们记作 $\\Delta \\phi_{\\text{diff}}$，是：\n$$\n\\Delta \\phi_{\\text{diff}} = \\Delta \\phi_{\\text{iron}} - \\Delta \\phi_{\\text{calc}} = (\\Delta \\omega_{\\text{iron}} - \\Delta \\omega_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\n代入频率偏移的表达式：\n$$\n\\Delta \\phi_{\\text{diff}} \\approx (\\gamma B_0 \\Delta \\chi_{\\text{iron}} - \\gamma B_0 \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE} = \\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\n我们已知这个相位差是 $\\pi$ 弧度。现在我们可以求解 $\\mathrm{TE}$：\n$$\n\\pi = \\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\n$$\n\\mathrm{TE} = \\frac{\\pi}{\\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}})}\n$$\n我们已知以下数值：\n- $B_0 = 3$ T\n- $\\gamma = 2\\pi \\times 42.577 \\times 10^{6}$ s$^{-1}$T$^{-1}$\n- $\\Delta \\chi_{\\text{iron}} = +0.15 \\text{ ppm} = 0.15 \\times 10^{-6}$\n- $\\Delta \\chi_{\\text{calc}} = -1.00 \\text{ ppm} = -1.00 \\times 10^{-6}$\n\n首先，我们计算磁化率的差异：\n$$\n\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}} = (0.15 \\times 10^{-6}) - (-1.00 \\times 10^{-6}) = 1.15 \\times 10^{-6}\n$$\n现在，将数值代入 $\\mathrm{TE}$ 的表达式中：\n$$\n\\mathrm{TE} = \\frac{\\pi}{(2\\pi \\times 42.577 \\times 10^{6} \\text{ s}^{-1}\\text{T}^{-1}) \\times (3 \\text{ T}) \\times (1.15 \\times 10^{-6})}\n$$\n分子和分母中的因子 $\\pi$相互抵消，因子 $10^6$ 和 $10^{-6}$ 也相互抵消：\n$$\n\\mathrm{TE} = \\frac{1}{(2 \\times 42.577) \\times 3 \\times 1.15} \\text{ s}\n$$\n$$\n\\mathrm{TE} = \\frac{1}{85.154 \\times 3.45} \\text{ s}\n$$\n$$\n\\mathrm{TE} = \\frac{1}{293.7813} \\text{ s} \\approx 0.00340389 \\text{ s}\n$$\n问题要求答案以毫秒 (ms) 为单位，并四舍五入到四位有效数字。\n$$\n\\mathrm{TE} \\approx 3.40389 \\text{ ms}\n$$\n四舍五入到四位有效数字，我们得到：\n$$\n\\mathrm{TE} \\approx 3.404 \\text{ ms}\n$$",
            "answer": "$$\\boxed{3.404}$$"
        },
        {
            "introduction": "在探索了磁化率和相位之间的理论联系之后，我们现在转向一个全面的计算实践。这项练习将指导您构建一个简化但完整的定量磁化率成像（QSM）流程，从模拟正向物理过程到执行反向重建。通过亲手实现核心算法，您将对如何从原始的MRI相位数据生成磁化率图，以及正则化在解决这个具有挑战性的反演问题中的作用，获得深刻而实际的理解。",
            "id": "4929383",
            "problem": "您的任务是在磁化率加权成像 (SWI) 的更广泛框架内，为定量磁化率成像 (QSM) 实现一个完整的数值一致性检查。从一个已知的磁化率 $\\chi(\\mathbf{r})$ 的三维 ($3\\text{-}\\mathrm{D}$) 分布（无量纲，通常以百万分率表示）开始，您必须模拟正演静磁场扰动 $\\Delta B(\\mathbf{r})$，将其转换为磁共振相位 $\\phi(\\mathbf{r})$，并使用正则化方法反演回 $\\chi(\\mathbf{r})$。最终交付成果是一个单独的 Python 程序，该程序能对指定的测试套件执行完整的流程并打印量化的误差指标。\n\n需要使用的基础理论：\n- 弱顺磁性介质的静磁线性响应表明，由磁化率分布 $\\chi(\\mathbf{r})$ 和沿 $z$ 轴方向的主磁场 $B_0$ 引起的局部静态场扰动 $\\Delta B(\\mathbf{r})$ 由一个空间卷积给出。在傅里叶域中，这表示为\n$$\n\\mathcal{F}\\{\\Delta B(\\mathbf{r})\\}(\\mathbf{k}) = B_0\\, D(\\mathbf{k})\\, \\mathcal{F}\\{\\chi(\\mathbf{r})\\}(\\mathbf{k}),\n$$\n其中 $\\mathcal{F}\\{\\cdot\\}$ 表示傅里叶变换，$D(\\mathbf{k})$ 是无量纲的偶极核。对于沿 $z$ 轴的主磁场，\n$$\nD(\\mathbf{k}) = \\frac{1}{3} - \\frac{k_z^2}{k_x^2 + k_y^2 + k_z^2},\n$$\n约定 $D(\\mathbf{0}) = 0$。\n- 对于梯度回波采集，在回波时间 $\\mathrm{TE}$ 时的相位累积与场扰动相关：\n$$\n\\phi(\\mathbf{r}) = \\gamma\\, \\Delta B(\\mathbf{r})\\, \\mathrm{TE},\n$$\n其中 $\\gamma$ 是质子旋磁比，单位为弧度/秒/特斯拉。\n\n您必须：\n1. 在立方网格上构建指定的磁化率分布 $\\chi(\\mathbf{r})$，并将 $\\chi$ 视为无量纲，但按题目要求以百万分率 (ppm) 报告磁化率。\n2. 通过使用快速傅里叶变换 (FFT) 实现的傅里叶域偶极正演模型计算 $\\Delta B(\\mathbf{r})$。\n3. 使用给定的 $\\gamma$ 和 $\\mathrm{TE}$ 将 $\\Delta B(\\mathbf{r})$ 转换为相位 $\\phi(\\mathbf{r})$，相位以弧度表示。\n4. 首先恢复磁场 $\\Delta B(\\mathbf{r})$，然后在傅里叶域中求解 Tikhonov 正则化最小二乘问题，从而从相位反演回 $\\chi(\\mathbf{r})$。在对角化的傅里叶基中，给定 $\\mathcal{F}\\{\\Delta B\\}(\\mathbf{k}) = A(\\mathbf{k})\\,\\mathcal{F}\\{\\chi\\}(\\mathbf{k})$，其中 $A(\\mathbf{k}) = B_0\\,D(\\mathbf{k})$，正则化的估计为\n$$\n\\widehat{\\chi}(\\mathbf{k}) = \\frac{A(\\mathbf{k})\\, \\mathcal{F}\\{\\Delta B\\}(\\mathbf{k})}{A(\\mathbf{k})^2 + \\lambda^2},\n$$\n其中 $\\lambda$ 是 Tikhonov 正则化参数，其物理单位与 $A(\\mathbf{k})$ 相同（特斯拉）。然后通过逆 FFT 获得 $\\widehat{\\chi}(\\mathbf{r})$。\n\n5. 通过计算真实磁化率与重建磁化率之间的均方根误差 (RMSE) 来量化误差，结果以百万分率 (ppm) 表示：\n$$\n\\mathrm{RMSE}_{\\mathrm{ppm}} = 10^6 \\times \\sqrt{\\frac{1}{N} \\sum_{n=1}^{N} \\left( \\chi_{\\text{true}}(\\mathbf{r}_n) - \\chi_{\\text{est}}(\\mathbf{r}_n) \\right)^2 },\n$$\n其中 $N$ 是体素总数，$10^6$ 将无量纲磁化率转换为 ppm。\n\n使用以下常数和单位：\n- 质子旋磁比 $\\gamma = 2\\pi \\times 42.577 \\times 10^6$ 弧度/秒/特斯拉。\n- 主磁场大小 $B_0 = 3.0$ 特斯拉。\n- 相位 $\\phi$ 必须以弧度计算和处理。\n- 回波时间 $\\mathrm{TE}$ 必须以秒为单位提供。\n- 输入中的磁化率值以百万分率 (ppm) 指定，但在内部使用时必须乘以 $10^{-6}$ 作为无量纲值。\n\n网格规格：\n- 使用大小为 $N_x = N_y = N_z = 32$ 体素的立方网格。体素间距可视为均匀的，无需明确指定，因为偶极核只需要傅里叶分量的比率。\n\n几何规格：\n- 网格中心位于索引 $(c_x, c_y, c_z)$ 处，其中 $c_x = c_y = c_z = \\lfloor N/2 \\rfloor$。\n- 一个以 $(c_x, c_y, c_z)$ 为中心、半径为 $r$ 体素的球体，使用指示函数 $(x-c_x)^2 + (y-c_y)^2 + (z-c_z)^2 \\le r^2$。\n- 一个与 $z$ 轴对齐、在 $x$-$y$ 平面上以 $(c_x, c_y)$ 为中心、半径为 $r$ 体素的直立圆柱体，对所有 $z$ 使用指示函数 $(x-c_x)^2 + (y-c_y)^2 \\le r^2$。\n\n测试套件（每个案例都是独立的，必须端到端处理）：\n- 案例 1（球体，正磁化率）：\n  - $N_x=N_y=N_z=32$，半径 $r=8$ 体素。\n  - 内部磁化率 $\\chi_{\\text{in}} = +0.3$ ppm，外部磁化率 $0.0$ ppm。\n  - $B_0 = 3.0$ 特斯拉，$\\mathrm{TE} = 0.020$ 秒，$\\lambda = 1.0 \\times 10^{-3}$ 特斯拉。\n- 案例 2（圆柱体，负磁化率）：\n  - $N_x=N_y=N_z=32$，半径 $r=6$ 体素，轴沿 $z$ 轴。\n  - 内部磁化率 $\\chi_{\\text{in}} = -0.2$ ppm，外部磁化率 $0.0$ ppm。\n  - $B_0 = 3.0$ 特斯拉，$\\mathrm{TE} = 0.015$ 秒，$\\lambda = 5.0 \\times 10^{-4}$ 特斯拉。\n- 案例 3（均匀零磁化率，边界健全性检查）：\n  - $N_x=N_y=N_z=32$，处处为均匀磁化率 $\\chi = 0.0$ ppm。\n  - $B_0 = 3.0$ 特斯拉，$\\mathrm{TE} = 0.010$ 秒，$\\lambda = 1.0 \\times 10^{-3}$ 特斯拉。\n\n要求的程序行为：\n- 实现正演模型，使用傅里叶域偶极核从 $\\chi(\\mathbf{r})$ 计算 $\\Delta B(\\mathbf{r})$。\n- 使用给定的 $\\gamma$ 和 $\\mathrm{TE}$ 将 $\\Delta B(\\mathbf{r})$ 转换为以弧度为单位的相位 $\\phi(\\mathbf{r})$。\n- 使用指定的 Tikhonov 正则化公式从相位反演估计 $\\widehat{\\chi}(\\mathbf{r})$。\n- 对每个测试案例，在整个网格上计算以 ppm 为单位的 RMSE。\n- 最终输出格式：您的程序应生成单行输出，其中包含三个测试案例的 RMSE 结果，形式为用方括号括起来的逗号分隔列表（例如，$[\\text{result1},\\text{result2},\\text{result3}]$）。每个结果必须是表示相应案例的 $\\mathrm{RMSE}_{\\mathrm{ppm}}$ 的浮点数。\n\n角度必须以弧度为单位。物理单位必须严格按照上述规定处理。输出的数值应为具有合理精度的浮点数。不允许外部输入或文件；所有参数必须严格按照上述规定在程序内部定义。",
            "solution": "该问题要求实现并验证一个完整的定量磁化率成像 (QSM) 流水线，从一个已知的磁化率分布 $\\chi(\\mathbf{r})$ 到模拟的相位测量值 $\\phi(\\mathbf{r})$，再返回到磁化率的正则化估计值 $\\widehat{\\chi}(\\mathbf{r})$。此过程构成了一次数值一致性检查，是任何计算成像算法的基本验证步骤。该解决方案基于三个核心原则：相位生成的正演模型、磁化率重建的正则化逆模型以及量化误差度量。\n\n**原则1：从磁化率到相位的正演模型**\n\n正演模型基于给定的潜在组织磁化率分布 $\\chi(\\mathbf{r})$，模拟磁共振信号的相位演化。该过程涉及两个物理步骤。\n\n首先，磁化率分布 $\\chi(\\mathbf{r})$（一种衡量材料被磁化能力的无量纲量）会扰动主静态磁场 $B_0$。对于沿 $z$ 轴方向的主磁场 $B_0 \\hat{\\mathbf{z}}$，感应出的场扰动 $\\Delta B(\\mathbf{r})$ 通过与偶极核的空间卷积与 $\\chi(\\mathbf{r})$ 相关联。这种关系在傅里叶域中表达最为方便：\n$$\n\\mathcal{F}\\{\\Delta B(\\mathbf{r})\\}(\\mathbf{k}) = B_0\\, D(\\mathbf{k})\\, \\mathcal{F}\\{\\chi(\\mathbf{r})\\}(\\mathbf{k})\n$$\n其中 $\\mathcal{F}\\{\\cdot\\}$ 表示三维傅里叶变换，$\\mathbf{k} = (k_x, k_y, k_z)$ 是空间频率向量。$D(\\mathbf{k})$ 项是傅里叶域中的无量纲偶极核，由下式给出：\n$$\nD(\\mathbf{k}) = \\frac{1}{3} - \\frac{k_z^2}{k_x^2 + k_y^2 + k_z^2}\n$$\n该核在原点 $\\mathbf{k} = \\mathbf{0}$ 处无定义，按照惯例设置为 $D(\\mathbf{0}) = 0$，这反映了平均磁化率值在物体内部平均不产生场扰动。在算法上，此正向步骤通过对离散磁化率图 $\\chi(\\mathbf{r})$ 进行快速傅里叶变换 (FFT)，将其与预先计算的离散偶极核 $D(\\mathbf{k})$ 和主磁场强度 $B_0$ 进行逐点相乘，然后应用逆 FFT 来获得场扰动 $\\Delta B(\\mathbf{r})$。\n\n其次，这种静态场扰动 $\\Delta B(\\mathbf{r})$ 导致磁共振自旋以局部偏移的拉莫尔频率进行进动。在回波时间 $\\mathrm{TE}$ 的过程中，这种频率偏移累积成一个可测量的相移 $\\phi(\\mathbf{r})$。该关系是线性的：\n$$\n\\phi(\\mathbf{r}) = \\gamma\\, \\Delta B(\\mathbf{r})\\, \\mathrm{TE}\n$$\n这里，$\\gamma$ 是质子旋磁比。此步骤是在空间域中简单的逐点相乘，以将磁场图转换为相位图。\n\n**原则2：从相位到磁化率的正则化逆模型**\n\n逆问题，或称 QSM 重建，旨在从测量的相位图 $\\phi(\\mathbf{r})$ 估计潜在的磁化率分布 $\\chi(\\mathbf{r})$。\n\n第一步是反转相位-磁场关系以恢复场扰动：\n$$\n\\Delta B(\\mathbf{r}) = \\frac{\\phi(\\mathbf{r})}{\\gamma \\mathrm{TE}}\n$$\n第二步，也是更具挑战性的一步，是反转场-磁化率关系。一种朴素的反演方法将涉及在傅里叶域中除以偶极核。然而，这是一个不适定问题，因为对于所有位于 $k_z^2 / |\\mathbf{k}|^2 = 1/3$ 的圆锥表面上的 $\\mathbf{k}$ 向量，偶极核 $D(\\mathbf{k})$ 均为零。试图在这些空间频率上除以零会放大噪声并导致不稳定的解。\n\n为解决此问题，题目指定了 Tikhonov 正则化方案。此方法通过添加一个惩罚项来稳定解。在对角化的傅里叶基中，磁化率的正则化估计值，记为 $\\widehat{\\chi}(\\mathbf{k})$，由下式给出：\n$$\n\\widehat{\\chi}(\\mathbf{k}) = \\frac{A(\\mathbf{k})\\, \\mathcal{F}\\{\\Delta B\\}(\\mathbf{k})}{A(\\mathbf{k})^2 + \\lambda^2}\n$$\n其中 $A(\\mathbf{k}) = B_0\\,D(\\mathbf{k})$ 是系统在傅里叶域中的正演算子，$\\lambda$ 是 Tikhonov 正则化参数。参数 $\\lambda$ 的单位是特斯拉，它确保分母永远不会为零，从而产生一个稳定且唯一的解。$\\lambda$ 的选择在数据保真度与解的光滑度之间取得平衡。较大的 $\\lambda$ 提供更强的正则化，但代价是可能过度平滑结果并低估磁化率值。在算法上，我们计算恢复的磁场图的 FFT，在傅里叶域中逐点应用此正则化滤波器，然后计算逆 FFT 以获得估计的磁化率图 $\\widehat{\\chi}(\\mathbf{r})$。由于数值精度问题，逆 FFT 的结果可能有一个很小的虚部，通过取实部将其丢弃。\n\n**原则3：量化误差评估**\n\n为完成数值一致性检查，必须将重建的磁化率估计值 $\\widehat{\\chi}(\\mathbf{r})$ 与原始的基准真实分布 $\\chi_{\\text{true}}(\\mathbf{r})$ 进行比较。题目指定使用均方根误差 (RMSE)，这是一种量化两个数据集之间差异的标准度量。磁化率值 $\\chi$ 是无量纲的，但为了报告，通常以百万分率 (ppm) 表示。因此，RMSE 的计算和缩放如下：\n$$\n\\mathrm{RMSE}_{\\mathrm{ppm}} = 10^6 \\times \\sqrt{\\frac{1}{N} \\sum_{n=1}^{N} \\left( \\chi_{\\text{true}}(\\mathbf{r}_n) - \\widehat{\\chi}(\\mathbf{r}_n) \\right)^2 }\n$$\n其中 $N$ 是网格中的体素总数，求和是对所有体素进行的。计算使用无量纲的磁化率值进行，最终结果乘以 $10^6$ 以 ppm 为单位表示。\n\n这整个流程——从创建基准真实值 $\\chi_{\\text{true}}$，执行正演模拟得到 $\\phi$，执行正则化反演得到 $\\widehat{\\chi}$，最后计算 RMSE——将针对三个指定的测试案例（球体、圆柱体和零场）中的每一个进行实施，以验证 QSM 方法的数值完整性。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Performs a full numerical consistency check for Quantitative Susceptibility Mapping (QSM).\n    This involves:\n    1. Generating a ground-truth susceptibility map (chi).\n    2. Simulating the measured MR phase via the dipole forward model.\n    3. Reconstructing the susceptibility map using Tikhonov-regularized inversion.\n    4. Calculating the Root-Mean-Square Error (RMSE) between the truth and reconstruction.\n    \"\"\"\n\n    # Physical constants\n    GAMMA = 2 * np.pi * 42.577e6  # Proton gyromagnetic ratio in rad/s/T\n    B0 = 3.0  # Main magnetic field strength in Tesla\n\n    # Grid specification\n    N = 32\n    GRID_SHAPE = (N, N, N)\n\n    # Test suite definition\n    test_cases = [\n        {\n            \"geom\": \"sphere\",\n            \"radius\": 8,\n            \"chi_in_ppm\": 0.3,\n            \"TE\": 0.020,\n            \"lambda_reg\": 1.0e-3,\n        },\n        {\n            \"geom\": \"cylinder\",\n            \"radius\": 6,\n            \"chi_in_ppm\": -0.2,\n            \"TE\": 0.015,\n            \"lambda_reg\": 5.0e-4,\n        },\n        {\n            \"geom\": \"uniform\",\n            \"radius\": 0,\n            \"chi_in_ppm\": 0.0,\n            \"TE\": 0.010,\n            \"lambda_reg\": 1.0e-3,\n        },\n    ]\n\n    results = []\n\n    # --- Pre-computation of k-space kernel ---\n    freq_vec = np.fft.fftfreq(N)\n    # Using 'ij' indexing to match numpy's (z, y, x) array axis order\n    kz, ky, kx = np.meshgrid(freq_vec, freq_vec, freq_vec, indexing='ij')\n\n    k2 = kx**2 + ky**2 + kz**2\n\n    # Compute Dipole Kernel D(k) safely\n    dipole_kernel = np.zeros(GRID_SHAPE)\n    nonzero_k = k2 != 0\n    dipole_kernel[nonzero_k] = (1/3) - (kz[nonzero_k]**2 / k2[nonzero_k])\n\n    for case in test_cases:\n        # --- 1. Construct True Susceptibility Distribution ---\n        chi_true = np.zeros(GRID_SHAPE, dtype=np.float64)\n        center = N // 2\n        z, y, x = np.indices(GRID_SHAPE)\n        \n        if case[\"geom\"] == \"sphere\":\n            radius_sq = case[\"radius\"]**2\n            mask = (x - center)**2 + (y - center)**2 + (z - center)**2 = radius_sq\n            chi_true[mask] = case[\"chi_in_ppm\"] * 1e-6\n        elif case[\"geom\"] == \"cylinder\":\n            radius_sq = case[\"radius\"]**2\n            mask = (x - center)**2 + (y - center)**2 = radius_sq\n            chi_true[mask] = case[\"chi_in_ppm\"] * 1e-6\n        # For \"uniform\" case, chi_true remains all zeros.\n\n        # --- 2. Forward Model: chi -> Delta_B -> phi ---\n        chi_k = np.fft.fftn(chi_true)\n        \n        delta_B_k = B0 * dipole_kernel * chi_k\n        delta_B_r = np.fft.ifftn(delta_B_k)\n        \n        # The true field is real; take real part to discard numerical noise.\n        phi_r = GAMMA * np.real(delta_B_r) * case[\"TE\"]\n\n        # --- 3. Inverse Model: phi -> Delta_B -> chi_est ---\n        delta_B_from_phi = phi_r / (GAMMA * case[\"TE\"])\n        delta_B_from_phi_k = np.fft.fftn(delta_B_from_phi)\n        \n        lambda_val = case[\"lambda_reg\"]\n        A_k = B0 * dipole_kernel\n        \n        numerator = A_k * delta_B_from_phi_k\n        denominator = A_k**2 + lambda_val**2\n        \n        chi_est_k = numerator / denominator\n        chi_est = np.fft.ifftn(chi_est_k)\n        \n        # Susceptibility is a real quantity.\n        chi_est_real = np.real(chi_est)\n\n        # --- 4. Quantify Error (RMSE in ppm) ---\n        squared_error = (chi_true - chi_est_real)**2\n        mean_squared_error = np.mean(squared_error)\n        rmse = np.sqrt(mean_squared_error)\n        \n        rmse_ppm = rmse * 1e6\n        results.append(rmse_ppm)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}