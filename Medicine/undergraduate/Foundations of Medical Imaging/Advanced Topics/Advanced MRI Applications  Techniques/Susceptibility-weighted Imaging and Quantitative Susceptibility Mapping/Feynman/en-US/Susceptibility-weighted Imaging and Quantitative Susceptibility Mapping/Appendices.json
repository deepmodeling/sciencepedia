{
    "hands_on_practices": [
        {
            "introduction": "The cornerstone of quantitative susceptibility mapping is the direct, physical link between a tissue's intrinsic magnetic susceptibility and the phase signal measured in a gradient-echo MRI scan. This first exercise bridges that conceptual gap by tasking you with a fundamental calculation. By working through the steps to determine the echo time required to distinguish between different biologically relevant tissues, you will solidify your understanding of how susceptibility creates contrast in phase images .",
            "id": "4929364",
            "problem": "In Magnetic Resonance Imaging (MRI), Susceptibility Weighted Imaging (SWI) and Quantitative Susceptibility Mapping (QSM) exploit spatial variations in magnetic susceptibility to generate image contrast and estimate tissue magnetic properties. Consider a $B_0 = 3 \\text{ T}$ system and focus on biologically realistic, bulk, isotropic tissue regions where macroscopic geometry and demagnetization effects can be neglected so that the local field perturbation within a homogeneous region can be approximated by $\\Delta B \\approx B_0 \\,\\Delta \\chi$, with $\\Delta \\chi$ the volume magnetic susceptibility difference between the region and a reference.\n\nPart A: Using magnetostatics and the constitutive relation between magnetization and magnetic field, explain why the volume magnetic susceptibility $\\chi$ is a dimensionless quantity.\n\nPart B: Adopt representative bulk volume magnetic susceptibilities (relative to cerebrospinal fluid) for four tissue classes, expressed in parts per million (ppm), where $1 \\text{ ppm} = 1 \\times 10^{-6}$:\n- Myelin-rich white matter: $\\chi_{\\mathrm{wm}} = -0.03$ ppm.\n- Cortical gray matter: $\\chi_{\\mathrm{gm}} = +0.03$ ppm.\n- Iron-rich deep gray nuclei: $\\chi_{\\mathrm{iron}} = +0.15$ ppm.\n- Calcifications (calcium phosphate deposits): $\\chi_{\\mathrm{calc}} = -1.00$ ppm.\n\nAssume the local Larmor angular frequency satisfies $\\omega = \\gamma B$, where $\\gamma = 2\\pi \\times 42.577 \\times 10^{6} \\text{ s}^{-1}\\text{T}^{-1}$ is the proton gyromagnetic ratio. The gradient-echo phase accrued by spins in a region over an echo time $\\mathrm{TE}$ is related to the local angular frequency by $\\Delta \\phi = \\Delta \\omega \\,\\mathrm{TE}$.\n\nCompute the echo time $\\mathrm{TE}$ (in milliseconds) that yields an accrued phase difference of $\\pi$ radians between the iron-rich region and the calcification, under the bulk approximation $\\Delta B \\approx B_0 \\,\\Delta \\chi$ and neglecting background fields. Round your answer to four significant figures and express it in milliseconds. State all intermediate reasoning clearly, starting from first principles, and justify the use of the bulk approximation for these estimates.",
            "solution": "This problem consists of two parts. Part A requires a theoretical explanation of why magnetic susceptibility is a dimensionless quantity. Part B requires a quantitative calculation of an echo time in an MRI experiment based on given tissue properties.\n\nPart A: Dimensionality of Volume Magnetic Susceptibility\n\nThe volume magnetic susceptibility, denoted by the symbol $\\chi$, is a measure of how a material responds to an applied magnetic field. Its dimensionality can be rigorously determined from the fundamental constitutive relations of magnetostatics. In the International System of Units (SI), the magnetic flux density $\\mathbf{B}$, the magnetic field strength $\\mathbf{H}$, and the material's magnetization $\\mathbf{M}$ (defined as magnetic dipole moment per unit volume) are linked by the following equation:\n$$\n\\mathbf{B} = \\mu_0 (\\mathbf{H} + \\mathbf{M})\n$$\nwhere $\\mu_0$ is the magnetic permeability of free space.\n\nFor a linear, isotropic magnetic material, the induced magnetization $\\mathbf{M}$ is directly proportional to the applied magnetic field strength $\\mathbf{H}$. Their relationship is defined by the volume magnetic susceptibility $\\chi$:\n$$\n\\mathbf{M} = \\chi \\mathbf{H}\n$$\nTo determine the dimensions of $\\chi$, we must analyze the units of the quantities in this defining equation.\nIn the SI system:\n- The unit of magnetization $\\mathbf{M}$ is amperes per meter (A/m). This follows from its definition as magnetic dipole moment (unit: A$\\cdot$m$^2$) per unit volume (unit: m$^3$).\n- The unit of magnetic field strength $\\mathbf{H}$ is also amperes per meter (A/m).\n\nSubstituting these units into the definitional equation for $\\chi$:\n$$\n[\\text{units of } \\mathbf{M}] = [\\text{units of } \\chi] \\times [\\text{units of } \\mathbf{H}]\n$$\n$$\n\\frac{\\text{A}}{\\text{m}} = [\\text{units of } \\chi] \\times \\frac{\\text{A}}{\\text{m}}\n$$\nFor this equality to hold true, the term $[\\text{units of } \\chi]$ must be equal to $1$. Consequently, the volume magnetic susceptibility $\\chi$ is a dimensionless quantity. It is often expressed in parts per million (ppm), where $1 \\text{ ppm} = 1 \\times 10^{-6}$, to conveniently represent the small values typical for biological tissues.\n\nPart B: Calculation of Echo Time $\\mathrm{TE}$\n\nThis part of the problem requires us to calculate the specific echo time, $\\mathrm{TE}$, at which the phase difference between an iron-rich tissue region and a calcification reaches $\\pi$ radians.\n\nFirst, we analyze the relationship between magnetic susceptibility and the observed phase in a gradient-echo MRI sequence. The Larmor angular frequency $\\omega$ of a proton spin is proportional to the local magnetic field $B$ that it experiences:\n$$\n\\omega = \\gamma B\n$$\nwhere $\\gamma$ is the proton gyromagnetic ratio.\n\nThe problem states that for a homogeneous region, the local field perturbation $\\Delta B$ due to tissue susceptibility can be approximated by $\\Delta B \\approx B_0 \\Delta\\chi$. Here, $\\Delta\\chi$ is the susceptibility difference of the tissue relative to a reference medium (CSF), and $B_0$ is the main magnetic field strength. The justification for this bulk approximation, as stated in the problem, is the assumption of 'bulk, isotropic tissue regions where macroscopic geometry and demagnetization effects can be neglected.' In reality, the field perturbation is shape-dependent (a demagnetization effect), but for large, geometrically simple, or internally located volumes, this leading-order approximation is a reasonable starting point for estimation.\n\nThe local field within a tissue region 'i' is $B_i = B_0 + \\Delta B_i \\approx B_0 (1 + \\Delta \\chi_i)$, where $\\Delta \\chi_i$ is the susceptibility of tissue 'i' relative to the reference. The frequency shift $\\Delta \\omega_i$ in that region, relative to the reference Larmor frequency $\\omega_0 = \\gamma B_0$, is therefore:\n$$\n\\Delta \\omega_i = \\omega_i - \\omega_0 = \\gamma (B_i - B_0) = \\gamma \\Delta B_i \\approx \\gamma B_0 \\Delta \\chi_i\n$$\nThis frequency shift causes a phase accrual $\\Delta \\phi_i$ over the echo time $\\mathrm{TE}$:\n$$\n\\Delta \\phi_i = \\Delta \\omega_i \\cdot \\mathrm{TE}\n$$\nWe are interested in the phase difference between the iron-rich region and the calcification region. This difference, which we denote $\\Delta \\phi_{\\text{diff}}$, is:\n$$\n\\Delta \\phi_{\\text{diff}} = \\Delta \\phi_{\\text{iron}} - \\Delta \\phi_{\\text{calc}} = (\\Delta \\omega_{\\text{iron}} - \\Delta \\omega_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\nSubstituting the expression for the frequency shift:\n$$\n\\Delta \\phi_{\\text{diff}} \\approx (\\gamma B_0 \\Delta \\chi_{\\text{iron}} - \\gamma B_0 \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE} = \\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\nWe are given that this phase difference is $\\pi$ radians. We can now solve for $\\mathrm{TE}$:\n$$\n\\pi = \\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}}) \\cdot \\mathrm{TE}\n$$\n$$\n\\mathrm{TE} = \\frac{\\pi}{\\gamma B_0 (\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}})}\n$$\nWe are given the following values:\n- $B_0 = 3$ T\n- $\\gamma = 2\\pi \\times 42.577 \\times 10^{6} \\text{ s}^{-1}\\text{T}^{-1}$\n- $\\Delta \\chi_{\\text{iron}} = +0.15 \\text{ ppm} = 0.15 \\times 10^{-6}$\n- $\\Delta \\chi_{\\text{calc}} = -1.00 \\text{ ppm} = -1.00 \\times 10^{-6}$\n\nFirst, we compute the difference in susceptibility:\n$$\n\\Delta \\chi_{\\text{iron}} - \\Delta \\chi_{\\text{calc}} = (0.15 \\times 10^{-6}) - (-1.00 \\times 10^{-6}) = 1.15 \\times 10^{-6}\n$$\nNow, substitute the numerical values into the expression for $\\mathrm{TE}$:\n$$\n\\mathrm{TE} = \\frac{\\pi}{(2\\pi \\times 42.577 \\times 10^{6} \\text{ s}^{-1}\\text{T}^{-1}) \\times (3 \\text{ T}) \\times (1.15 \\times 10^{-6})}\n$$\nThe factor of $\\pi$ in the numerator and denominator cancels, as do the factors of $10^6$ and $10^{-6}$:\n$$\n\\mathrm{TE} = \\frac{1}{(2 \\times 42.577) \\times 3 \\times 1.15} \\text{ s}\n$$\n$$\n\\mathrm{TE} = \\frac{1}{85.154 \\times 3.45} \\text{ s}\n$$\n$$\n\\mathrm{TE} = \\frac{1}{293.7813} \\text{ s} \\approx 0.00340389 \\text{ s}\n$$\nThe problem requires the answer to be in milliseconds (ms) and rounded to four significant figures.\n$$\n\\mathrm{TE} \\approx 3.40389 \\text{ ms}\n$$\nRounding to four significant figures, we get:\n$$\n\\mathrm{TE} \\approx 3.404 \\text{ ms}\n$$",
            "answer": "$$\\boxed{3.404}$$"
        },
        {
            "introduction": "Real biological tissues are rarely homogeneous; a single imaging voxel often contains a mixture of substances with different, sometimes opposing, magnetic properties. This practice explores a common challenge in neuroimaging where paramagnetic iron and diamagnetic calcium coexist, demonstrating how the net susceptibility measured by QSM can be ambiguous. You will develop a model that cleverly combines the sign-sensitive information from QSM with magnitude-sensitive data from R2* maps to separate these underlying sources, a powerful technique in advanced quantitative analysis .",
            "id": "4929405",
            "problem": "In Magnetic Resonance Imaging (MRI) at static field strength $3\\,\\text{T}$, Susceptibility-Weighted Imaging (SWI) phase and Quantitative Susceptibility Mapping (QSM) provide access to tissue magnetic susceptibility, while multi-echo magnitude images provide the effective transverse relaxation rate (R2*) map. Consider a scenario in which a single imaging voxel contains two mixed microscopic source classes: paramagnetic iron and diamagnetic calcium salts (calcification). The microstructure is assumed to be dilute, approximately spherical, and randomly distributed, and diffusion during the echo time is negligible. Background fields have been removed from the phase prior to QSM. The gradient-echo echo time $T_E$ is sufficiently long that the voxel phase reflects the quasi-static local field shift.\n\nYou acquire the following measurements:\n- A calibration voxel dominated by only paramagnetic iron microinclusions shows a QSM susceptibility of $+0.150\\,\\text{ppm}$ and an effective transverse relaxation rate of $45\\,\\text{s}^{-1}$ under the same acquisition and microstructural regime.\n- A calibration voxel dominated by only diamagnetic calcification shows a QSM susceptibility of $-0.120\\,\\text{ppm}$ and an effective transverse relaxation rate of $36\\,\\text{s}^{-1}$, consistent with the same regime.\n- A target mixed voxel shows a QSM susceptibility of $+0.030\\,\\text{ppm}$ and an effective transverse relaxation rate of $90\\,\\text{s}^{-1}$.\n\nStarting from the definitions that the local Larmor frequency shift is $\\Delta \\omega = \\gamma \\Delta B$ and that for small, dilute spherical inclusions the voxelwise bulk susceptibility is the volume-fraction-weighted algebraic sum of paramagnetic and diamagnetic contributions, and using the well-tested observation that in the static dephasing regime the effective transverse relaxation rate increases approximately linearly with the magnitude of susceptibility-induced intravoxel field variations and adds for independent source classes, derive a source-separation model that uses phase/QSM (sign-sensitive) and R2* (magnitude-sensitive) information. Then use it to compute the iron-attributable susceptibility in the mixed voxel.\n\nReport the iron-attributable susceptibility as a single number in $\\text{ppm}$, rounded to three significant figures. State your final answer in $\\text{ppm}$.",
            "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It is based on established principles of magnetic resonance imaging, specifically Quantitative Susceptibility Mapping (QSM) and R2* mapping. The problem statement is self-contained, and the provided data are sufficient and consistent for deriving a unique solution.\n\nThe task is to determine the iron-attributable susceptibility in a mixed voxel containing paramagnetic iron and diamagnetic calcium salts. We are given measurements of total QSM susceptibility ($\\chi_{mix}$) and effective transverse relaxation rate ($R2^*_{mix}$) for this voxel, along with calibration measurements for voxels containing only one of the components.\n\nFirst, we must formalize the source-separation model based on the principles described in the problem statement. Let $\\chi_i$ and $\\chi_c$ be the susceptibility contributions from the iron and calcium components in the mixed voxel, respectively.\n\nThe problem states that the voxelwise bulk susceptibility is the volume-fraction-weighted algebraic sum of the contributions. This implies a linear mixing model for the measured susceptibilities:\n$$ \\chi_{mix} = \\chi_i + \\chi_c $$\nUsing the value for the target mixed voxel, $\\chi_{mix} = +0.030\\,\\text{ppm}$, we have our first equation:\n$$ \\chi_i + \\chi_c = 0.030 \\quad (1) $$\n\nNext, we model the effective transverse relaxation rate, $R2^*$. The problem states that the *increase* in $R2^*$ is approximately linear with the *magnitude* of susceptibility-induced intravoxel field variations, and these increases add for independent source classes. Let $R2^*_{base}$ be the background relaxation rate of the tissue matrix without any susceptibility inclusions. The total measured $R2^*$ is the sum of this baseline and the increases from each component, $\\Delta R2^*_i$ and $\\Delta R2^*_c$.\n$$ R2^* = R2^*_{base} + \\Delta R2^*_i + \\Delta R2^*_c $$\nThe linear relationship between the $R2^*$ increase and the magnitude of the susceptibility contribution can be written as:\n$$ \\Delta R2^* = k |\\chi| $$\nwhere $k$ is a constant of proportionality that depends on the microstructure and acquisition parameters, but is assumed to be the same for both components as they share the same microstructural regime. Based on the problem description, iron is paramagnetic, so its susceptibility contribution $\\chi_i$ will be positive. Calcium salts (calcification) are diamagnetic, so their contribution $\\chi_c$ will be negative.\n\nWe can determine the unknown parameters $k$ and $R2^*_{base}$ using the provided calibration data.\nFor the iron-only calibration voxel:\n$\\chi_{cal,i} = +0.150\\,\\text{ppm}$ and $R2^*_{cal,i} = 45\\,\\text{s}^{-1}$.\n$$ 45 = R2^*_{base} + k |+0.150| = R2^*_{base} + 0.150k $$\nFor the calcium-only calibration voxel:\n$\\chi_{cal,c} = -0.120\\,\\text{ppm}$ and $R2^*_{cal,c} = 36\\,\\text{s}^{-1}$.\n$$ 36 = R2^*_{base} + k |-0.120| = R2^*_{base} + 0.120k $$\n\nWe now have a system of two linear equations for $R2^*_{base}$ and $k$:\n$$ R2^*_{base} + 0.150k = 45 \\quad (A) $$\n$$ R2^*_{base} + 0.120k = 36 \\quad (B) $$\nSubtracting equation (B) from equation (A):\n$$ (R2^*_{base} + 0.150k) - (R2^*_{base} + 0.120k) = 45 - 36 $$\n$$ 0.030k = 9 $$\n$$ k = \\frac{9}{0.030} = 300\\,\\text{s}^{-1}/\\text{ppm} $$\nSubstituting $k$ back into equation (A) to find $R2^*_{base}$:\n$$ R2^*_{base} + 0.150(300) = 45 $$\n$$ R2^*_{base} + 45 = 45 $$\n$$ R2^*_{base} = 0\\,\\text{s}^{-1} $$\nThe background relaxation rate is $0\\,\\text{s}^{-1}$, meaning the measured $R2^*$ values are entirely due to the susceptibility inclusions. This simplifies our model for the total $R2^*$ in the mixed voxel to the sum of the individual increases:\n$$ R2^*_{mix} = \\Delta R2^*_i + \\Delta R2^*_c = k|\\chi_i| + k|\\chi_c| $$\n\nNow we apply this model to the target mixed voxel, for which $R2^*_{mix} = 90\\,\\text{s}^{-1}$.\n$$ 90 = 300 \\left( |\\chi_i| + |\\chi_c| \\right) $$\nDividing by $300$ gives our second equation, which links the magnitude of the susceptibility contributions:\n$$ |\\chi_i| + |\\chi_c| = \\frac{90}{300} = 0.300 \\quad (2) $$\n\nWe now have a system of two equations with two unknowns, $\\chi_i$ and $\\chi_c$:\n$$ \\chi_i + \\chi_c = 0.030 \\quad (1) $$\n$$ |\\chi_i| + |\\chi_c| = 0.300 \\quad (2) $$\nAs established, the iron contribution is paramagnetic ($\\chi_i > 0$) and the calcium contribution is diamagnetic ($\\chi_c  0$). This allows us to resolve the absolute values: $|\\chi_i| = \\chi_i$ and $|\\chi_c| = -\\chi_c$.\nThe system becomes a well-defined linear system:\n$$ \\chi_i + \\chi_c = 0.030 \\quad (1') $$\n$$ \\chi_i - \\chi_c = 0.300 \\quad (2') $$\nThis is the derived source-separation model, which uses the sign-sensitive QSM susceptibility for one equation and the magnitude-sensitive R2* relation for the other. To solve for $\\chi_i$, we add the two equations:\n$$ (\\chi_i + \\chi_c) + (\\chi_i - \\chi_c) = 0.030 + 0.300 $$\n$$ 2\\chi_i = 0.330 $$\n$$ \\chi_i = \\frac{0.330}{2} = 0.165 $$\nThe iron-attributable susceptibility in the mixed voxel is thus $0.165\\,\\text{ppm}$.\nFor completeness, we can also calculate the calcium-attributable susceptibility:\n$$ \\chi_c = 0.030 - \\chi_i = 0.030 - 0.165 = -0.135\\,\\text{ppm} $$\nThe signs of the results, $\\chi_i > 0$ and $\\chi_c  0$, are consistent with their known magnetic properties. The problem asks for the iron-attributable susceptibility, reported in $\\text{ppm}$ and rounded to three significant figures. Our result $0.165$ is already in this form.",
            "answer": "$$\n\\boxed{0.165}\n$$"
        },
        {
            "introduction": "The ultimate test of understanding an imaging technique is the ability to model it from end to end. This computational practice guides you through simulating the entire QSM workflow, from a ground-truth susceptibility map to the final reconstructed image. By implementing the forward physics model and a regularized inverse algorithm, you will gain invaluable, hands-on insight into the practical challenges of QSM, such as the ill-posed nature of the dipole inversion and the critical role of regularization in achieving a stable solution .",
            "id": "4929383",
            "problem": "You are tasked with implementing a complete numerical consistency check for Quantitative Susceptibility Mapping (QSM) within the broader framework of Susceptibility-Weighted Imaging (SWI). Starting from a known three-dimensional distribution of magnetic susceptibility $\\chi(\\mathbf{r})$ (dimensionless, often expressed in parts per million), you must simulate the forward magnetostatic field perturbation $\\Delta B(\\mathbf{r})$, convert it to magnetic resonance phase $\\phi(\\mathbf{r})$, and invert back to $\\chi(\\mathbf{r})$ using a regularized approach. The final deliverable is a single Python program that executes the full pipeline for a specified test suite and prints quantitative error metrics.\n\nFoundational base to use:\n- The magnetostatic linear response of a weakly paramagnetic medium states that the local static field perturbation $\\Delta B(\\mathbf{r})$ induced by a susceptibility distribution $\\chi(\\mathbf{r})$ and a main field $B_0$ oriented along the $z$-axis is given by a spatial convolution. In the Fourier domain, this is represented by\n$$\n\\mathcal{F}\\{\\Delta B(\\mathbf{r})\\}(\\mathbf{k}) = B_0\\, D(\\mathbf{k})\\, \\mathcal{F}\\{\\chi(\\mathbf{r})\\}(\\mathbf{k}),\n$$\nwhere $\\mathcal{F}\\{\\cdot\\}$ denotes the Fourier Transform and $D(\\mathbf{k})$ is the unitless dipole kernel. For a main field along the $z$-axis,\n$$\nD(\\mathbf{k}) = \\frac{1}{3} - \\frac{k_z^2}{k_x^2 + k_y^2 + k_z^2},\n$$\nwith the convention $D(\\mathbf{0}) = 0$.\n- For a gradient-echo acquisition, the phase accrual at echo time $\\mathrm{TE}$ is related to the field perturbation by\n$$\n\\phi(\\mathbf{r}) = \\gamma\\, \\Delta B(\\mathbf{r})\\, \\mathrm{TE},\n$$\nwhere $\\gamma$ is the proton gyromagnetic ratio in radians per second per Tesla.\n\nYou must:\n1. Construct the specified susceptibility distributions $\\chi(\\mathbf{r})$ on a cubic grid and treat $\\chi$ as dimensionless, but report susceptibility in parts per million (ppm) where required by the problem.\n2. Compute $\\Delta B(\\mathbf{r})$ via the Fourier-domain dipole forward model using a Fast Fourier Transform (FFT) implementation.\n3. Convert $\\Delta B(\\mathbf{r})$ to phase $\\phi(\\mathbf{r})$ using the given $\\gamma$ and $\\mathrm{TE}$, with phase expressed in radians.\n4. Invert from phase back to $\\chi(\\mathbf{r})$ by first recovering the field $\\Delta B(\\mathbf{r})$ and then solving a Tikhonov-regularized least squares problem in the Fourier domain. In the diagonalized Fourier basis, given $\\mathcal{F}\\{\\Delta B\\}(\\mathbf{k}) = A(\\mathbf{k})\\,\\mathcal{F}\\{\\chi\\}(\\mathbf{k})$ with $A(\\mathbf{k}) = B_0\\,D(\\mathbf{k})$, the regularized estimate is\n$$\n\\widehat{\\chi}(\\mathbf{k}) = \\frac{A(\\mathbf{k})\\, \\mathcal{F}\\{\\Delta B\\}(\\mathbf{k})}{A(\\mathbf{k})^2 + \\lambda^2},\n$$\nwhere $\\lambda$ is the Tikhonov regularization parameter having the same physical units as $A(\\mathbf{k})$ (Tesla). Then obtain $\\widehat{\\chi}(\\mathbf{r})$ by inverse FFT.\n\n5. Quantify errors by computing the root-mean-square error (RMSE) between the true susceptibility and the reconstructed susceptibility, expressed in parts per million (ppm):\n$$\n\\mathrm{RMSE}_{\\mathrm{ppm}} = 10^6 \\times \\sqrt{\\frac{1}{N} \\sum_{n=1}^{N} \\left( \\chi_{\\text{true}}(\\mathbf{r}_n) - \\chi_{\\text{est}}(\\mathbf{r}_n) \\right)^2 },\n$$\nwhere $N$ is the total number of voxels and $10^6$ converts a dimensionless susceptibility to ppm.\n\nUse the following constants and units:\n- Proton gyromagnetic ratio $\\gamma = 2\\pi \\times 42.577 \\times 10^6$ radians per second per Tesla.\n- Main magnetic field magnitude $B_0 = 3.0$ Tesla.\n- Phase $\\phi$ must be computed and treated in radians.\n- Echo time $\\mathrm{TE}$ must be provided in seconds.\n- Susceptibility values in the input are specified in parts per million (ppm) but must be used internally as dimensionless values by multiplying by $10^{-6}$.\n\nGrid specification:\n- Use a cubic grid of size $N_x = N_y = N_z = 32$ voxels. The voxel spacing may be treated as uniform and does not need to be explicitly specified, as only ratios of Fourier components are required for the dipole kernel.\n\nGeometry specifications:\n- The center of the grid is at index $(c_x, c_y, c_z)$ with $c_x = c_y = c_z = \\lfloor N/2 \\rfloor$.\n- A sphere of radius $r$ voxels centered at $(c_x, c_y, c_z)$ uses the indicator $(x-c_x)^2 + (y-c_y)^2 + (z-c_z)^2 \\le r^2$.\n- A right circular cylinder aligned with the $z$-axis of radius $r$ voxels centered at $(c_x, c_y)$ in the $x$-$y$ plane uses the indicator $(x-c_x)^2 + (y-c_y)^2 \\le r^2$ for all $z$.\n\nTest suite (each case is independent and must be processed end-to-end):\n- Case $1$ (sphere, positive susceptibility):\n  - $N_x=N_y=N_z=32$, radius $r=8$ voxels.\n  - Interior susceptibility $\\chi_{\\text{in}} = +0.3$ ppm, exterior susceptibility $0.0$ ppm.\n  - $B_0 = 3.0$ Tesla, $\\mathrm{TE} = 0.020$ seconds, $\\lambda = 1.0 \\times 10^{-3}$ Tesla.\n- Case $2$ (cylinder, negative susceptibility):\n  - $N_x=N_y=N_z=32$, radius $r=6$ voxels, axis along $z$.\n  - Interior susceptibility $\\chi_{\\text{in}} = -0.2$ ppm, exterior susceptibility $0.0$ ppm.\n  - $B_0 = 3.0$ Tesla, $\\mathrm{TE} = 0.015$ seconds, $\\lambda = 5.0 \\times 10^{-4}$ Tesla.\n- Case $3$ (uniform zero susceptibility, boundary sanity check):\n  - $N_x=N_y=N_z=32$, uniform susceptibility $\\chi = 0.0$ ppm everywhere.\n  - $B_0 = 3.0$ Tesla, $\\mathrm{TE} = 0.010$ seconds, $\\lambda = 1.0 \\times 10^{-3}$ Tesla.\n\nRequired program behavior:\n- Implement the forward model to compute $\\Delta B(\\mathbf{r})$ from $\\chi(\\mathbf{r})$ using the Fourier-domain dipole kernel.\n- Convert $\\Delta B(\\mathbf{r})$ to phase $\\phi(\\mathbf{r})$ in radians using the given $\\gamma$ and $\\mathrm{TE}$.\n- Invert from phase to estimate $\\widehat{\\chi}(\\mathbf{r})$ using the specified Tikhonov-regularized formula.\n- Compute the RMSE in ppm for each test case over the entire grid.\n- Final output format: Your program should produce a single line of output containing the RMSE results for the three test cases as a comma-separated list enclosed in square brackets (e.g., $[\\text{result1},\\text{result2},\\text{result3}]$). Each result must be a floating-point number representing $\\mathrm{RMSE}_{\\mathrm{ppm}}$ for the corresponding case.\n\nAngles must be in radians. Physical units must be handled exactly as specified above. The output numerical values should be floats with reasonable precision. No external input or files are allowed; all parameters must be defined within the program exactly as above.",
            "solution": "The problem requires the implementation and verification of a complete Quantitative Susceptibility Mapping (QSM) pipeline, from a known susceptibility distribution $\\chi(\\mathbf{r})$ to a simulated phase measurement $\\phi(\\mathbf{r})$ and back to a regularized estimate of the susceptibility $\\widehat{\\chi}(\\mathbf{r})$. This process constitutes a numerical consistency check, a fundamental validation step for any computational imaging algorithm. The solution rests on three core principles: the forward model of phase generation, the regularized inverse model for susceptibility reconstruction, and a quantitative error metric.\n\n**Principle 1: The Forward Model from Susceptibility to Phase**\n\nThe forward model simulates the magnetic resonance signal's phase evolution based on a given underlying tissue magnetic susceptibility distribution $\\chi(\\mathbf{r})$. This process involves two physical steps.\n\nFirst, the susceptibility distribution $\\chi(\\mathbf{r})$, which is a dimensionless measure of a material's ability to be magnetized, perturbs the main static magnetic field $B_0$. For a main field oriented along the $z$-axis, $B_0 \\hat{\\mathbf{z}}$, the induced field perturbation $\\Delta B(\\mathbf{r})$ is related to $\\chi(\\mathbf{r})$ through a spatial convolution with a dipole kernel. This relationship is most conveniently expressed in the Fourier domain:\n$$\n\\mathcal{F}\\{\\Delta B(\\mathbf{r})\\}(\\mathbf{k}) = B_0\\, D(\\mathbf{k})\\, \\mathcal{F}\\{\\chi(\\mathbf{r})\\}(\\mathbf{k})\n$$\nwhere $\\mathcal{F}\\{\\cdot\\}$ denotes the three-dimensional Fourier Transform, and $\\mathbf{k} = (k_x, k_y, k_z)$ is the spatial frequency vector. The term $D(\\mathbf{k})$ is the unitless dipole kernel in the Fourier domain, given by:\n$$\nD(\\mathbf{k}) = \\frac{1}{3} - \\frac{k_z^2}{k_x^2 + k_y^2 + k_z^2}\n$$\nThis kernel is undefined at the origin $\\mathbf{k} = \\mathbf{0}$, where it is set to $D(\\mathbf{0}) = 0$ by convention, reflecting that the mean susceptibility value does not create a field perturbation inside the object on average. Algorithmically, this forward step is implemented by taking the Fast Fourier Transform (FFT) of the discrete susceptibility map $\\chi(\\mathbf{r})$, multiplying it point-wise by the pre-computed discrete dipole kernel $D(\\mathbf{k})$ and the main field strength $B_0$, and then applying an inverse FFT to obtain the field perturbation $\\Delta B(\\mathbf{r})$.\n\nSecond, this static field perturbation $\\Delta B(\\mathbf{r})$ causes magnetic resonance spins to precess at a locally shifted Larmor frequency. Over the course of an echo time $\\mathrm{TE}$, this frequency shift accumulates into a measurable phase shift $\\phi(\\mathbf{r})$ in the MR signal. The relationship is linear:\n$$\n\\phi(\\mathbf{r}) = \\gamma\\, \\Delta B(\\mathbf{r})\\, \\mathrm{TE}\n$$\nHere, $\\gamma$ is the proton gyromagnetic ratio. This step is a simple point-wise multiplication in the spatial domain to convert the field map to a phase map.\n\n**Principle 2: The Regularized Inverse Model from Phase to Susceptibility**\n\nThe inverse problem, or QSM reconstruction, aims to estimate the underlying susceptibility distribution $\\chi(\\mathbf{r})$ from the measured phase map $\\phi(\\mathbf{r})$.\n\nThe first step is to invert the phase-field relationship to recover the field perturbation:\n$$\n\\Delta B(\\mathbf{r}) = \\frac{\\phi(\\mathbf{r})}{\\gamma \\mathrm{TE}}\n$$\nThe second, more challenging step is to invert the field-susceptibility relationship. A naive inversion would involve dividing by the dipole kernel in the Fourier domain. However, this is an ill-posed problem because the kernel $D(\\mathbf{k})$ has zeros for all $\\mathbf{k}$ vectors that lie on the surface of a cone where $k_z^2 / |\\mathbf{k}|^2 = 1/3$. Attempting to divide by zero at these spatial frequencies would amplify noise and lead to an unstable solution.\n\nTo address this, the problem specifies a Tikhonov regularization scheme. This method adds a penalty term to stabilize the solution. In the diagonalized Fourier basis, the regularized estimate of the susceptibility, denoted $\\widehat{\\chi}(\\mathbf{k})$, is given by:\n$$\n\\widehat{\\chi}(\\mathbf{k}) = \\frac{A(\\mathbf{k})\\, \\mathcal{F}\\{\\Delta B\\}(\\mathbf{k})}{A(\\mathbf{k})^2 + \\lambda^2}\n$$\nwhere $A(\\mathbf{k}) = B_0\\,D(\\mathbf{k})$ is the system's forward operator in the Fourier domain and $\\lambda$ is the Tikhonov regularization parameter. The parameter $\\lambda$ has units of Tesla and ensures that the denominator never becomes zero, thus yielding a stable and unique solution. The choice of $\\lambda$ balances fidelity to the data against the smoothness of the solution. A larger $\\lambda$ provides more regularization at the cost of potentially oversmoothing the result and underestimating susceptibility values. Algorithmically, one computes the FFT of the recovered field map, applies this regularized filter point-wise in the Fourier domain, and then computes the inverse FFT to obtain the estimated susceptibility map $\\widehat{\\chi}(\\mathbf{r})$. Due to numerical precision, the result of the inverse FFT may have a small imaginary component, which is discarded by taking the real part.\n\n**Principle 3: Quantitative Error Assessment**\n\nTo complete the numerical consistency check, the reconstructed susceptibility estimate $\\widehat{\\chi}(\\mathbf{r})$ must be compared to the original ground-truth distribution $\\chi_{\\text{true}}(\\mathbf{r})$. The problem specifies the use of the root-mean-square error (RMSE), a standard metric for quantifying the difference between two datasets. The susceptibility values $\\chi$ are dimensionless, but for reporting, they are conventionally expressed in parts per million (ppm). The RMSE is thus calculated and scaled accordingly:\n$$\n\\mathrm{RMSE}_{\\mathrm{ppm}} = 10^6 \\times \\sqrt{\\frac{1}{N} \\sum_{n=1}^{N} \\left( \\chi_{\\text{true}}(\\mathbf{r}_n) - \\widehat{\\chi}(\\mathbf{r}_n) \\right)^2 }\n$$\nwhere $N$ is the total number of voxels in the grid, and the sum is performed over all voxels. The calculation is performed using the dimensionless susceptibility values, with the final result scaled by $10^6$ to be expressed in ppm.\n\nThis entire pipeline—from creating the ground truth $\\chi_{\\text{true}}$, performing the forward simulation to get $\\phi$, executing the regularized inversion to get $\\widehat{\\chi}$, and finally computing the RMSE—will be implemented for each of the three specified test cases (sphere, cylinder, and zero-field) to validate the numerical integrity of the QSM method.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Performs a full numerical consistency check for Quantitative Susceptibility Mapping (QSM).\n    This involves:\n    1. Generating a ground-truth susceptibility map (chi).\n    2. Simulating the measured MR phase via the dipole forward model.\n    3. Reconstructing the susceptibility map using Tikhonov-regularized inversion.\n    4. Calculating the Root-Mean-Square Error (RMSE) between the truth and reconstruction.\n    \"\"\"\n\n    # Physical constants\n    GAMMA = 2 * np.pi * 42.577e6  # Proton gyromagnetic ratio in rad/s/T\n    B0 = 3.0  # Main magnetic field strength in Tesla\n\n    # Grid specification\n    N = 32\n    GRID_SHAPE = (N, N, N)\n\n    # Test suite definition\n    test_cases = [\n        {\n            \"geom\": \"sphere\",\n            \"radius\": 8,\n            \"chi_in_ppm\": 0.3,\n            \"TE\": 0.020,\n            \"lambda_reg\": 1.0e-3,\n        },\n        {\n            \"geom\": \"cylinder\",\n            \"radius\": 6,\n            \"chi_in_ppm\": -0.2,\n            \"TE\": 0.015,\n            \"lambda_reg\": 5.0e-4,\n        },\n        {\n            \"geom\": \"uniform\",\n            \"radius\": 0,\n            \"chi_in_ppm\": 0.0,\n            \"TE\": 0.010,\n            \"lambda_reg\": 1.0e-3,\n        },\n    ]\n\n    results = []\n\n    # --- Pre-computation of k-space kernel ---\n    freq_vec = np.fft.fftfreq(N)\n    # Using 'ij' indexing to match numpy's (z, y, x) array axis order\n    kz, ky, kx = np.meshgrid(freq_vec, freq_vec, freq_vec, indexing='ij')\n\n    k2 = kx**2 + ky**2 + kz**2\n\n    # Compute Dipole Kernel D(k) safely\n    dipole_kernel = np.zeros(GRID_SHAPE)\n    nonzero_k = k2 != 0\n    dipole_kernel[nonzero_k] = (1/3) - (kz[nonzero_k]**2 / k2[nonzero_k])\n\n    for case in test_cases:\n        # --- 1. Construct True Susceptibility Distribution ---\n        chi_true = np.zeros(GRID_SHAPE, dtype=np.float64)\n        center = N // 2\n        z, y, x = np.indices(GRID_SHAPE)\n        \n        if case[\"geom\"] == \"sphere\":\n            radius_sq = case[\"radius\"]**2\n            mask = (x - center)**2 + (y - center)**2 + (z - center)**2 = radius_sq\n            chi_true[mask] = case[\"chi_in_ppm\"] * 1e-6\n        elif case[\"geom\"] == \"cylinder\":\n            radius_sq = case[\"radius\"]**2\n            mask = (x - center)**2 + (y - center)**2 = radius_sq\n            chi_true[mask] = case[\"chi_in_ppm\"] * 1e-6\n        # For \"uniform\" case, chi_true remains all zeros.\n\n        # --- 2. Forward Model: chi - Delta_B - phi ---\n        chi_k = np.fft.fftn(chi_true)\n        \n        delta_B_k = B0 * dipole_kernel * chi_k\n        delta_B_r = np.fft.ifftn(delta_B_k)\n        \n        # The true field is real; take real part to discard numerical noise.\n        phi_r = GAMMA * np.real(delta_B_r) * case[\"TE\"]\n\n        # --- 3. Inverse Model: phi - Delta_B - chi_est ---\n        delta_B_from_phi = phi_r / (GAMMA * case[\"TE\"])\n        delta_B_from_phi_k = np.fft.fftn(delta_B_from_phi)\n        \n        lambda_val = case[\"lambda_reg\"]\n        A_k = B0 * dipole_kernel\n        \n        numerator = A_k * delta_B_from_phi_k\n        denominator = A_k**2 + lambda_val**2\n        \n        chi_est_k = np.divide(numerator, denominator, out=np.zeros_like(numerator), where=denominator!=0)\n        chi_est = np.fft.ifftn(chi_est_k)\n        \n        # Susceptibility is a real quantity.\n        chi_est_real = np.real(chi_est)\n\n        # --- 4. Quantify Error (RMSE in ppm) ---\n        squared_error = (chi_true - chi_est_real)**2\n        mean_squared_error = np.mean(squared_error)\n        rmse = np.sqrt(mean_squared_error)\n        \n        rmse_ppm = rmse * 1e6\n        results.append(rmse_ppm)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}