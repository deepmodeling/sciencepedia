{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握自旋回波序列，第一步是能够从布洛赫方程 (Bloch equations) 这一基本原理出发，推导出其信号方程。这项练习将引导你完成这一关键推导，从而为理解图像对比度如何由序列参数（如$TR$和$TE$）与组织内在属性（$T_1$、$T_2$和质子密度$\\rho$）共同决定奠定坚实的理论基础。通过分析极限情况，你将进一步揭示不同权重成像的本质。",
            "id": "4935739",
            "problem": "考虑一个理想的双脉冲自旋回波（SE）序列，该序列应用于一个置于静磁场 $B_0$ 中的静态、均匀样本，该样本具有均匀的质子密度 $\\rho$。该序列由一个在 $t=0$ 时刻施加的 $90^{\\circ}$ 射频（RF）脉冲和一个在 $t = TE/2$ 时刻施加的 $180^{\\circ}$ 射频脉冲组成，其中 $TE$ 是回波时间。该序列以重复时间 $TR$ 重复。假设翻转角完美，扩散可忽略不计，$180^{\\circ}$ 脉冲能完美地重聚相位（因此只有不可逆的横向弛豫对回波幅度有贡献），并且在两次重复之间，任何剩余的横向磁化强度都被完全破坏，从而使得每个 $90^{\\circ}$ 脉冲刚结束后的纵向磁化强度为零。样本的纵向弛豫由纵向弛豫时间 $T_1$ 表征，横向弛豫由横向弛豫时间 $T_2$ 表征。接收链将横向磁化强度以单位比例线性地映射到信号幅度。\n\n从布洛赫方程的纵向分量和所述的物理假设出发，推导回波时刻的 SE 信号 $S(TE)$，使其成为 $\\rho$、$TR$、$T_1$ 和 $T_2$ 的函数。然后，解析地评估当 $TE \\to 0$ 时 $S(TE)$ 的极限。将最终答案表示为仅含 $\\rho$、$TR$ 和 $T_1$ 的单一闭合形式解析表达式。不需要进行数值评估。",
            "solution": "该问题具有科学依据，提法明确，并包含足够的信息以获得唯一解。这些假设虽然是理想化的，但是是该主题入门级处理的标准假设，并且内部一致。因此，该问题被认为是有效的。\n\n推导过程主要分为两个阶段：首先，通过求解纵向布洛赫方程，确定脉冲序列重复开始时可用的纵向磁化强度；其次，计算回波时间的横向磁化强度，它构成了信号。\n\n描述纵向磁化强度 $M_z$ 向其热平衡值 $M_0$ 恢复的时间演化的布洛赫方程的纵向分量由下式给出：\n$$\n\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}\n$$\n其中 $T_1$ 是纵向弛豫时间。问题指出样本具有均匀的质子密度 $\\rho$。平衡磁化强度 $M_0$ 与此密度成正比。鉴于接收链中单位比例的假设，我们可以设定 $M_0 = \\rho$。\n\n脉冲序列以重复时间 $TR$ 重复。我们在稳态条件下分析该系统。在每个周期的开始（我们设其为 $t=0$），施加一个 $90^\\circ$ 射频脉冲。该脉冲将可用的纵向磁化强度旋转到横向平面。问题明确指出“每个 $90^\\circ$ 脉冲刚结束后的纵向磁化强度为零”。这是一个完美的 $90^\\circ$ 脉冲的直接结果，因为脉冲后的纵向磁化强度 $M_z(0^+)$ 与脉冲前的磁化强度 $M_z(0^-)$ 之间的关系为 $M_z(0^+) = M_z(0^-)\\cos(90^\\circ) = 0$。\n\n这为我们提供了重复间隔期间纵向弛豫的初始条件。在 $t=0$ 时刻的 $90^\\circ$ 脉冲之后，纵向磁化强度 $M_z$ 从 $M_z(0) = 0$ 向 $M_0$ 恢复。我们用这个初始条件求解微分方程。\n$$\n\\int_{0}^{M_z(t)} \\frac{dM_z'}{M_0 - M_z'} = \\int_{0}^{t} \\frac{dt'}{T_1}\n$$\n积分得出：\n$$\n[-\\ln(M_0 - M_z')]_{0}^{M_z(t)} = \\frac{t}{T_1}\n$$\n$$\n\\ln\\left(\\frac{M_0 - M_z(t)}{M_0 - 0}\\right) = -\\frac{t}{T_1}\n$$\n求解 $M_z(t)$：\n$$\nM_z(t) = M_0 \\left( 1 - \\exp\\left(-\\frac{t}{T_1}\\right) \\right)\n$$\n关于完全破坏横向磁化强度的假设确保了有一个完整的 $TR$ 周期可用于纵向恢复，而不受 $180^\\circ$ 脉冲或回波时间的影响。因此，在重复间隔结束时，即在下一个 $90^\\circ$ 脉冲之前，纵向磁化强度已恢复到：\n$$\nM_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n这是可用于下一次激发的纵向磁化强度。下一个周期开始时的 $90^\\circ$ 脉冲将这个全部量翻转到横向平面。因此，横向磁化强度的初始大小为：\n$$\nM_{xy}(0^+) = M_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n在此激发之后，由于不可逆的自旋-自旋相互作用，横向磁化强度开始衰减，该过程由横向弛豫时间 $T_2$ 表征。$90^\\circ$ 脉冲后 $t$ 时刻的横向磁化强度大小由下式给出：\n$$\nM_{xy}(t) = M_{xy}(0^+) \\exp\\left(-\\frac{t}{T_2}\\right)\n$$\n$t=TE/2$ 时刻的 $180^\\circ$ 脉冲完美地重聚了由外部场不均匀性引起的失相，但它不影响由 $T_2$ 控制的衰减包络。自旋回波信号 $S(TE)$ 是在 $t=TE$ 时刻测量的。由于单位比例的假设，$S(TE) = M_{xy}(TE)$。\n$$\nS(TE) = M_{xy}(0^+) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\n代入 $M_{xy}(0^+)$ 和 $M_0 = \\rho$ 的表达式：\n$$\nS(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\n这是理想自旋回波序列中信号的通用表达式。\n\n问题的第二部分要求我们评估当回波时间 $TE$ 趋近于零时该信号的极限。\n$$\n\\lim_{TE \\to 0} S(TE) = \\lim_{TE \\to 0} \\left[ \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\n项 $\\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)$ 与 $TE$ 无关，在此极限中可视为常数。\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\lim_{TE \\to 0} \\left[ \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\n指数项的极限评估如下：\n$$\n\\lim_{TE \\to 0} \\exp\\left(-\\frac{TE}{T_2}\\right) = \\exp(0) = 1\n$$\n将此结果代回信号极限的表达式，我们得到最终答案：\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\n如题所求，该表达式仅取决于 $\\rho$、$TR$ 和 $T_1$。它代表了通过选择极小的回波时间来消除 $T_2$ 衰减影响的“质子密度加权”或“$T_1$ 加权”图像的信号。",
            "answer": "$$\n\\boxed{\\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right)}\n$$"
        },
        {
            "introduction": "理想的自旋回波假设自旋在回波时间内保持静止，但真实情况并非如此，例如血流或患者的轻微移动。本练习探讨了当这一核心假设被打破时会发生什么，通过一个简化的宏观运动模型来量化其对回波信号的衰减效应。掌握这一原理对于理解和识别临床成像中的运动伪影至关重要。",
            "id": "4935706",
            "problem": "Hahn自旋回波由一个在时间 $t=0$ 施加的 $90^\\circ$ 射频脉冲和一个接着在时间 $t=T_E/2$ 施加的 $180^\\circ$ 射频脉冲形成，自旋回波在时间 $t=T_E$ 处被观测到。考虑一个位于主磁场中的全同氢核系综，该主磁场的空间不均匀性可以建模为沿 $z$ 轴的静态、均匀线性场梯度，因此局部拉莫尔角频率偏移为 $\\omega(z)=\\gamma G z$，其中 $\\gamma$ 是旋磁比，$G$ 是沿 $z$ 轴的恒定梯度幅度。假设射频脉冲是理想且瞬时的，并且内在横向弛豫（自旋-自旋弛豫）时间与回波时间相比很长，因此在区间 $[0,T_E]$ 内可以忽略不计。\n\n从相位的定义（瞬时角频率的时间积分）和 $180^\\circ$ 脉冲效应（反转累积相位）出发，并根据第一性原理进行推导，说明在 $90^\\circ$ 和 $180^\\circ$ 脉冲之间的刚性整体运动如何导致在 $t=T_E$ 时出现不完全重聚相。\n\n现在考虑一个简单的双室模型：\n- 在区间 $0 \\le t \\le T_E/2$ 内，比例为 $f$ 的自旋沿 $+\\hat{z}$ 方向以恒定速度 $v$ 进行刚性平移，然后在 $T_E/2 \\le t \\le T_E$ 内在其新位置保持静止。\n- 剩余比例为 $1-f$ 的自旋在 $0 \\le t \\le T_E$ 内保持静止。\n\n设系综在回波时间 $t=T_E$ 时的复数横向信号为静止室和运动室横向磁化相量的矢量和。定义回波衰减因子 $A$ 为该复数和的模，并用所有自旋均静止时所能获得的幅度（即在相同 $G$ 和 $T_E$ 条件下无运动时的回波幅度）进行归一化。\n\n仅使用上述原理，推导出 $A$ 的表达式，然后根据以下参数计算其数值：\n- $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$ (弧度 秒⁻¹ 特斯拉⁻¹)，\n- $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$ (特斯拉 米⁻¹)，\n- $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$ (米 秒⁻¹)，\n- $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$ (秒)，\n- $f = 0.40$。\n\n将最终衰减因子 $A$ 表示为无量纲比率。所有角度均使用弧度制，并将最终答案四舍五入到四位有效数字。",
            "solution": "首先根据指定标准对用户提供的问题进行验证。\n\n### 问题验证\n\n#### 步骤1：提取已知条件\n- **序列**：Hahn自旋回波由一个在 $t=0$ 施加的 $90^\\circ$ 射频脉冲和一个在 $t=T_E/2$ 施加的 $180^\\circ$ 射频脉冲组成。回波在 $t=T_E$ 处被观测到。\n- **场梯度**：沿 $z$ 轴的静态、均匀线性场梯度，幅度为 $G$。\n- **拉莫尔频率偏移**：局部拉莫尔角频率偏移为 $\\omega(z)=\\gamma G z$，其中 $\\gamma$ 是旋磁比。\n- **假设**：\n    1.  射频脉冲是理想且瞬时的。\n    2.  在区间 $[0, T_E]$ 内，内在横向弛豫（$T_2$ 衰减）可忽略不计。\n- **相位定义**：相位是瞬时角频率的时间积分。\n- **$180^\\circ$ 脉冲效应**：反转累积相位。\n- **双室模型**：\n    - 比例为 $f$ 的自旋在 $0 \\le t \\le T_E/2$ 期间沿 $+\\hat{z}$ 方向以恒定速度 $v$ 进行刚性平移，然后在 $T_E/2 \\le t \\le T_E$ 期间保持静止。\n    - 剩余比例 $1-f$ 的自旋在 $0 \\le t \\le T_E$ 期间保持静止。\n- **回波衰减因子（$A$）**：在 $t=T_E$ 时，静止室和运动室的横向磁化强度复数和的模，并用所有自旋均静止时所能获得的幅度进行归一化。\n- **数值计算参数**：\n    - $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$\n    - $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$\n    - $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$\n    - $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$\n    - $f = 0.40$\n\n#### 步骤2：使用提取的已知条件进行验证\n- **科学基础（关键）**：该问题牢固地植根于核磁共振（NMR）和磁共振成像（MRI）的原理。Hahn自旋回波、拉莫尔频率、场梯度以及运动对相位的影响都是该领域的标准概念。该模型是一个简化但有效的表示，用于理解与运动相关的信号衰减（例如，在扩散加权或灌注加权成像中）。该问题在科学上是合理的。\n- **适定性**：该问题提供了所有必要的定义、参数和一个明确的目标。模型定义明确，问题要求一个可推导的表达式和相应的数值。存在唯一解。\n- **客观性（关键）**：该问题以精确、定量且无偏见的语言陈述。所有术语都在物理学背景下定义。没有主观或基于意见的陈述。\n\n该问题没有任何无效性缺陷。它在MRI物理建模的背景下是自洽、一致、现实且结构良好的。\n\n#### 步骤3：结论和行动\n问题有效。可以进行求解过程。\n\n### 推导与求解\n\n问题的核心在于计算自旋在回波时间 $t=T_E$ 累积的相位。一个自旋的相位 $\\phi$ 是其瞬时角频率偏移 $\\omega(t)$ 的时间积分。在 $t=0$ 处施加初始 $90^\\circ$ 脉冲将净磁化强度翻转到横向平面后，每个自旋根据其在磁场梯度中的位置 $z(t)$ 累积相位。\n\n一个自旋从 $t=0$ 到时间 $t_{acq}$ 累积的相位由下式给出：\n$$ \\phi(t_{acq}) = \\int_0^{t_{acq}} \\omega(z(\\tau)) d\\tau = \\int_0^{t_{acq}} \\gamma G z(\\tau) d\\tau $$\n在自旋回波序列中，总演化过程被 $t=T_E/2$ 处的 $180^\\circ$ 脉冲分成两个区间。$180^\\circ$ 脉冲的作用是对横向磁化强度进行共轭，这等效于反转截至该点累积的相位。因此，在回波时间 $t=T_E$ 的总相位 $\\phi_{total}(T_E)$ 是第一个区间反转相位与第二个区间累积相位之和：\n$$ \\phi_{total}(T_E) = -\\int_0^{T_E/2} \\gamma G z(\\tau) d\\tau + \\int_{T_E/2}^{T_E} \\gamma G z(\\tau) d\\tau $$\n\n对于一个静止自旋，其位置是恒定的，$z(t) = z_0$。总相位为：\n$$ \\phi_{stationary}(T_E) = -\\int_0^{T_E/2} \\gamma G z_0 d\\tau + \\int_{T_E/2}^{T_E} \\gamma G z_0 d\\tau = -\\gamma G z_0 \\frac{T_E}{2} + \\gamma G z_0 \\frac{T_E}{2} = 0 $$\n这种完美的重聚相与初始位置 $z_0$ 无关，这是自旋回波用于处理静态不均匀性的原理。所有静止自旋都对回波信号做出相干贡献。\n\n对于一个运动自旋，其位置 $z(t)$ 不是恒定的，这两个积分可能不会抵消。这导致在 $t=T_E$ 时产生净相移，在对具有不同运动路径的自旋系综进行平均时，会引起不完全重聚相和信号衰减。\n\n我们现在将此框架应用于给定的双室模型。\n\n**静止室（比例 $1-f$）：**\n如上所述，对于任何在位置 $z_0$ 保持静止的自旋，其在 $t=T_E$ 时的总相位累积为 $\\phi_S = 0$。来自该室的复数信号贡献（相对于初始信号归一化）为 $(1-f)e^{i\\phi_S} = (1-f)e^{i \\cdot 0} = 1-f$。\n\n**运动室（比例 $f$）：**\n该室中的一个自旋在 $t=0$ 时从 $z_0$ 开始。\n1.  在 $0 \\le t \\le T_E/2$ 期间，它以恒定速度 $v$ 运动，因此其位置为 $z(t) = z_0 + v t$。\n2.  在 $T_E/2 \\le t \\le T_E$ 期间，它在 $t=T_E/2$ 时到达的位置保持静止，该位置为 $z(T_E/2) = z_0 + v (T_E/2)$。\n\n第一个区间（$0$ 到 $T_E/2$）累积的相位为：\n$$ \\phi_1 = \\int_0^{T_E/2} \\gamma G (z_0 + v\\tau) d\\tau = \\gamma G \\left[ z_0\\tau + \\frac{1}{2}v\\tau^2 \\right]_0^{T_E/2} = \\gamma G \\left( z_0 \\frac{T_E}{2} + \\frac{1}{2}v \\left(\\frac{T_E}{2}\\right)^2 \\right) = \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{8} \\right) $$\n第二个区间（$T_E/2$ 到 $T_E$）累积的相位为：\n$$ \\phi_2 = \\int_{T_E/2}^{T_E} \\gamma G \\left(z_0 + v\\frac{T_E}{2}\\right) d\\tau = \\gamma G \\left(z_0 + v\\frac{T_E}{2}\\right) \\left( T_E - \\frac{T_E}{2} \\right) = \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{4} \\right) $$\n一个运动自旋的总相位 $\\phi_M$ 为 $\\phi_{total}(T_E) = -\\phi_1 + \\phi_2$：\n$$ \\phi_M = -\\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{8} \\right) + \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{4} \\right) $$\n$$ \\phi_M = \\left( -\\frac{\\gamma G z_0 T_E}{2} + \\frac{\\gamma G z_0 T_E}{2} \\right) + \\left( -\\frac{\\gamma G v T_E^2}{8} + \\frac{\\gamma G v T_E^2}{4} \\right) = \\frac{\\gamma G v T_E^2}{8} $$\n相位与初始位置 $z_0$ 无关，但取决于运动参数 $v$、$G$ 和 $T_E$。来自该室的复数信号贡献为 $f e^{i\\phi_M}$。\n\n**总信号和衰减因子 $A$：**\n在 $t=T_E$ 时的总复数信号 $S_{total}$ 是来自两个室的信号的加权矢量和：\n$$ S_{total} = (1-f)e^{i\\phi_S} + f e^{i\\phi_M} = (1-f) + f e^{i(\\frac{1}{8}\\gamma G v T_E^2)} $$\n衰减因子 $A$ 是该信号的模 $|S_{total}|$，并用无运动时的信号幅度进行归一化。如果所有自旋都静止（运动部分的 $v=0$），则 $\\phi_M=0$，信号幅度将为 $|(1-f)+f|=1$。因此，$A = |S_{total}|$。\n我们计算模的平方：\n$$ A^2 = |(1-f) + f e^{i\\phi_M}|^2 = \\left( (1-f) + f\\cos(\\phi_M) \\right)^2 + \\left( f\\sin(\\phi_M) \\right)^2 $$\n$$ A^2 = (1-f)^2 + 2f(1-f)\\cos(\\phi_M) + f^2\\cos^2(\\phi_M) + f^2\\sin^2(\\phi_M) $$\n$$ A^2 = (1-f)^2 + f^2 + 2f(1-f)\\cos(\\phi_M) $$\n因此，衰减因子的表达式为：\n$$ A = \\sqrt{(1-f)^2 + f^2 + 2f(1-f)\\cos\\left(\\frac{1}{8}\\gamma G v T_E^2\\right)} $$\n\n**数值计算：**\n首先，我们使用给定参数计算相位 $\\phi_M$：\n- $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$\n- $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$\n- $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$\n- $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$\n\n$$ \\phi_M = \\frac{1}{8} \\gamma G v T_E^2 = \\frac{1}{8} (2.675 \\times 10^8) (5 \\times 10^{-3}) (5 \\times 10^{-3}) (3.0 \\times 10^{-2})^2 $$\n$$ \\phi_M = \\frac{1}{8} (2.675 \\times 5 \\times 5 \\times 9.0) \\times 10^{8-3-3-4} = \\frac{601.875}{8} \\times 10^{-2} $$\n$$ \\phi_M = 75.234375 \\times 10^{-2} = 0.75234375\\ \\text{rad} $$\n\n接下来，我们用 $f = 0.40$（因此 $1-f = 0.60$）计算衰减因子 $A$：\n$$ A^2 = (0.60)^2 + (0.40)^2 + 2(0.40)(0.60)\\cos(0.75234375) $$\n$$ A^2 = 0.36 + 0.16 + 0.48 \\cos(0.75234375) $$\n$$ A^2 = 0.52 + 0.48 \\times (0.730145155...) $$\n$$ A^2 = 0.52 + 0.350469674... = 0.870469674... $$\n$$ A = \\sqrt{0.870469674...} = 0.933000361... $$\n\n四舍五入到四位有效数字，最终的衰减因子为 $0.9330$。",
            "answer": "$$\\boxed{0.9330}$$"
        },
        {
            "introduction": "真实MRI扫描仪中的磁场并非完美均匀，射频场（$B_1$）和主磁场（$B_0$）的不均匀性是信号失真和伪影的常见来源。这项计算实践将指导你通过编程模拟这些不完美之处，并亲眼观察它们对回波信号的影响。更进一步，你还将探索并量化绝热脉冲 (adiabatic pulse) 这一高等技术在补偿$B_1$不均匀性方面的优势，从而连接起基础理论与前沿的脉冲序列设计。",
            "id": "4935662",
            "problem": "要求您编写一个完整的程序，模拟在存在位置相关的射频场不均匀性（表示为 $B_1$）和静磁场不均匀性（表示为 $B_0$）的情况下，磁共振成像 (MRI) 中的单次自旋回波，并量化绝热重聚焦脉冲相对于传统重聚焦脉冲如何减轻 $B_1$ 敏感性。模拟必须基于旋转坐标系中的布洛赫方程，对射频 (RF) 脉冲使用硬脉冲、瞬时旋转模型，并在演化期间使用带有横向弛豫的自由进动。\n\n从以下基本原理开始：\n- 旋转坐标系中的布洛赫方程：$\\frac{d\\mathbf{M}}{dt} = \\gamma \\mathbf{M} \\times \\mathbf{B}_{\\text{eff}}$，其中 $\\mathbf{M}$ 是磁化矢量，$\\mathbf{B}_{\\text{eff}}$ 是有效场。\n- 一个共振、瞬时硬射频脉冲（绕笛卡尔坐标轴）被建模为磁化矢量绕该轴旋转一个角度 $\\theta$，由一个适当的旋转矩阵表示。\n- 在角频率偏移 $\\Delta \\omega$ 下自由进动期间的离共振，会在时间间隔 $\\tau$ 内引起绕 $z$ 轴旋转角度 $\\phi = \\Delta \\omega \\, \\tau$，同时横向分量上伴随着由指数因子 $e^{-\\tau/T_2}$ 描述的横向弛豫，其中 $T_2$ 是自旋-自旋弛豫时间。假设重复时间很长，初始磁化强度为 $\\mathbf{M}_0 = [0,0,M_0]^\\top$ 且 $M_0$ 为常数，从而忽略纵向弛豫 ($T_1$)。\n- 一个自旋回波序列由一个激发脉冲和两个等长的自由进动期组成，在它们的中点施加一个重聚焦脉冲。使用绕 $x$ 轴的 $90^\\circ$ 激发和绕 $y$ 轴的 $180^\\circ$ 重聚焦作为标称脉冲方向。\n\n将视场 (FOV) 建模为一维位置 $x \\in [-L, L]$，其中 $L = 0.1 \\, \\text{m}$。在每个位置 $x$，设相对 $B_1$ 缩放因子为 $s(x)$，静态频率偏移为 $\\Delta f(x)$（单位赫兹），对应的角频率偏移为 $\\Delta \\omega(x) = 2 \\pi \\, \\Delta f(x)$。$B_1$ 不均匀性会缩放激发和重聚焦脉冲的翻转角。重聚焦脉冲的模型如下：\n- 传统重聚焦：绕 $y$ 轴的瞬时旋转，角度为 $\\beta(x) = s(x) \\, \\pi$。\n- 绝热重聚焦（简化模型）：当局部 $B_1$ 缩放因子超过一个阈值时，进行稳健的 $\\pi$ 旋转，即如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$，否则 $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$。为保持模型的可比性，两种情况均使用相同的旋转轴（$y$ 轴）。\n\n设激发脉冲是绕 $x$ 轴的 $90^\\circ$ 旋转，并由 $s(x)$ 缩放，即 $\\alpha(x) = s(x)\\,\\pi/2$。在重聚焦脉冲前后，自由进动持续时间为 $\\tau = \\text{TE}/2$，每次都建模为绕 $z$ 轴旋转角度 $\\phi(x) = \\Delta \\omega(x)\\, \\tau$ 并伴随横向衰减 $e^{-\\tau/T_2}$。\n\n算法要求：\n1. 将 $\\mathbf{M}(x)$ 初始化为 $\\mathbf{M}_0 = [0,0,M_0]^\\top$，其中 $M_0 = 1$。\n2. 应用激发旋转 $R_x(\\alpha(x))$，得到紧随激发之后的 $\\mathbf{M}$。\n3. 应用持续时间为 $\\tau = \\text{TE}/2$ 的自由进动：旋转 $R_z(\\phi(x))$ 并将横向分量乘以 $e^{-\\tau/T_2}$。\n4. 应用重聚焦旋转：\n   - 对于传统情况：$R_y(\\beta(x))$，其中 $\\beta(x) = s(x)\\,\\pi$。\n   - 对于绝热情况：$R_y(\\beta_{\\text{adiab}}(x))$，其中如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$，否则 $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$。\n5. 应用第二次持续时间为 $\\tau = \\text{TE}/2$ 的自由进动：旋转 $R_z(\\phi(x))$ 并将横向分量乘以 $e^{-\\tau/T_2}$。\n6. 在回波时间，计算复数横向信号 $S(x) = M_x(x) + i M_y(x)$。将理想脉冲（无不均匀性）下的理想回波幅度定义为 $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$。\n7. 对于每种情况（传统和绝热），计算两个空间汇总指标：\n   - 平均归一化幅度：$\\overline{A} = \\frac{1}{N}\\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}}$ (无量纲)。\n   - 以弧度为单位的平均绝对相位偏差：首先计算循环平均相位 $\\bar{\\phi} = \\arg\\left(\\frac{1}{N}\\sum_x e^{i \\arg S(x)}\\right)$，然后计算 $\\frac{1}{N}\\sum_x \\left| \\arg\\left(e^{i(\\arg S(x) - \\bar{\\phi})}\\right) \\right|$。\n\n角度必须以弧度处理。报告涉及物理单位的参数时，请严格遵守下面指定的单位。\n\n测试套件：\n在 $x \\in [-L, L]$（其中 $L = 0.1 \\, \\text{m}$）上使用 $N = 101$ 个均匀间隔的位置。对于每个测试用例，定义 $s(x) = 1 + a \\, (x/L)$ 和 $\\Delta f(x) = b \\, (x/L)$（单位赫兹），并使用固定的绝热阈值 $s_{\\min} = 0.7$。对于每个测试用例，按指定的顺序和单位计算四个输出：$(\\overline{A}_\\text{conv}, \\overline{A}_\\text{adiab}, \\overline{P}_\\text{conv}, \\overline{P}_\\text{adiab})$，其中 $\\overline{P}$ 表示以弧度为单位的平均绝对相位偏差。使用：\n- 情况 1 (理想路径)：$\\text{TE} = 60 \\, \\text{ms}$， $T_2 = 70 \\, \\text{ms}$， $a = -0.2$， $b = 80 \\, \\text{Hz}$。\n- 情况 2 (具有严重 $B_1$ 和 $B_0$ 的边缘情况)：$\\text{TE} = 80 \\, \\text{ms}$， $T_2 = 60 \\, \\text{ms}$， $a = -0.5$， $b = 120 \\, \\text{Hz}$。\n- 情况 3 (边界情况，无不均匀性)：$\\text{TE} = 50 \\, \\text{ms}$， $T_2 = 100 \\, \\text{ms}$， $a = 0.0$， $b = 0 \\, \\text{Hz}$。\n\n您的程序必须：\n- 仅使用瞬时旋转和带横向衰减的自由进动来实现上述物理过程。\n- 内部以秒表示时间，输入以毫秒为单位。\n- 所有角度均使用弧度。\n- 输出一行，其中包含一个由方括号括起来的逗号分隔列表，其中按此确切顺序列出 12 个浮点数结果：\n  $[\\overline{A}_\\text{conv}^{(1)}, \\overline{A}_\\text{adiab}^{(1)}, \\overline{P}_\\text{conv}^{(1)}, \\overline{P}_\\text{adiab}^{(1)}, \\overline{A}_\\text{conv}^{(2)}, \\overline{A}_\\text{adiab}^{(2)}, \\overline{P}_\\text{conv}^{(2)}, \\overline{P}_\\text{adiab}^{(2)}, \\overline{A}_\\text{conv}^{(3)}, \\overline{A}_\\text{adiab}^{(3)}, \\overline{P}_\\text{conv}^{(3)}, \\overline{P}_\\text{adiab}^{(3)}]$。\n- 将每个值四舍五入到恰好 6 位小数。\n- 单位：对于 $\\overline{A}$ 使用无量纲归一化，对于 $\\overline{P}$ 报告弧度。\n\n科学真实性要求：\n- 不要假设任何 $T_1$ 效应。\n- 不要假设除指定的 $\\Delta f(x)$ 外任何由梯度引起的失相。\n- 射频脉冲是瞬时的；自由进动仅在两个持续时间为 TE/2 的演化窗口中发生。\n\n您的程序应生成单行输出，其中包含以方括号括起来的逗号分隔列表形式的结果（例如，$[0.123456,0.234567,0.012345,0.023456, \\ldots]$）。不允许有任何其他输出。",
            "solution": "问题陈述已经过分析并被确定为有效。它在科学上基于核磁共振 (NMR) 的原理，问题定义清晰，指令明确且确定，语言客观。所有参数和模型都已指定，从而可以得出一个唯一且有意义的解。因此，我们可以进行正式求解。\n\n自旋回波序列的模拟基于旋转坐标系中的布洛赫方程，该方程控制宏观磁化矢量 $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$ 的动力学。该问题将连续演化简化为一系列离散事件：瞬时射频 (RF) 脉冲和自由进动周期。每个事件都被建模为应用于磁化矢量的矩阵变换。\n\n根据长重复时间的假设，系统的初始状态是与主磁场（$z$ 轴）对齐的热平衡磁化强度。我们将此初始磁化强度归一化为 $M_0 = 1$，因此 $\\mathbf{M}_0 = [0, 0, 1]^\\top$。\n\n旋转坐标系中绕轴 $\\mathbf{u}$（例如 $x$ 或 $y$）、翻转角为 $\\theta$ 的瞬时射频脉冲被建模为磁化矢量的旋转。$x$ 轴和 $y$ 轴对应的旋转矩阵为：\n$$\nR_x(\\theta) = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos\\theta & -\\sin\\theta \\\\ 0 & \\sin\\theta & \\cos\\theta \\end{pmatrix} \\quad \\text{和} \\quad R_y(\\theta) = \\begin{pmatrix} \\cos\\theta & 0 & \\sin\\theta \\\\ 0 & 1 & 0 \\\\ -\\sin\\theta & 0 & \\cos\\theta \\end{pmatrix}\n$$\n这些矩阵将用于模拟激发和重聚焦脉冲。\n\n在存在静态场偏移 $\\Delta \\omega$ 和横向弛豫时间 $T_2$ 的情况下，持续时间为 $\\tau$ 的自由进动由两个并发过程建模：绕 $z$ 轴旋转角度 $\\phi = \\Delta \\omega \\, \\tau$，以及横向磁化分量 ($M_x, M_y$) 的指数衰减。由于忽略了纵向弛豫 ($T_1$)，假定 $z$ 分量 $M_z$ 保持不变。这个组合操作可以用一个变换矩阵 $P(\\phi, \\tau, T_2)$ 表示：\n$$\nP(\\phi, \\tau, T_2) = \\begin{pmatrix} e^{-\\tau/T_2} & 0 & 0 \\\\ 0 & e^{-\\tau/T_2} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\begin{pmatrix} \\cos\\phi & -\\sin\\phi & 0 \\\\ \\sin\\phi & \\cos\\phi & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\begin{pmatrix} e^{-\\tau/T_2}\\cos\\phi & -e^{-\\tau/T_2}\\sin\\phi & 0 \\\\ e^{-\\tau/T_2}\\sin\\phi & e^{-\\tau/T_2}\\cos\\phi & 0 \\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n衰减和旋转的顺序是可交换的，因此一次矩阵乘法就足够了。\n\n自旋回波序列由按顺序应用于初始磁化强度 $\\mathbf{M}_0$ 的五个不同步骤组成。模拟是针对一组 $N=101$ 个空间位置 $x \\in [-L, L]$ 进行的，其中 $L=0.1 \\, \\text{m}$。射频脉冲的翻转角和离共振频率是位置 $x$ 的函数：\n1.  $B_1$ 不均匀性因子为 $s(x) = 1 + a (x/L)$。\n2.  离共振频率为 $\\Delta f(x) = b (x/L)$，导致角频率偏移 $\\Delta \\omega(x) = 2\\pi \\Delta f(x)$。\n\n变换序列如下：\n1.  **激发脉冲**：绕 $x$ 轴的 $90^\\circ$ 脉冲，由 $B_1$ 不均匀性缩放。翻转角为 $\\alpha(x) = s(x) \\frac{\\pi}{2}$。变换为 $R_x(\\alpha(x))$。\n    $$ \\mathbf{M}_1(x) = R_x(\\alpha(x)) \\mathbf{M}_0 $$\n2.  **第一次自由进动**：演化持续时间为 $\\tau = \\text{TE}/2$。进动角为 $\\phi(x) = \\Delta \\omega(x) \\tau$。变换为 $P(\\phi(x), \\tau, T_2)$。\n    $$ \\mathbf{M}_2(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_1(x) $$\n3.  **重聚焦脉冲**：绕 $y$ 轴的 $180^\\circ$ 脉冲。翻转角 $\\beta(x)$ 取决于脉冲类型：\n    -   **传统**：$\\beta_{\\text{conv}}(x) = s(x) \\pi$。\n    -   **绝热（简化模型）**：如果 $s(x) \\ge s_{\\min}$，则 $\\beta_{\\text{adiab}}(x) = \\pi$，否则 $\\beta_{\\text{adiab}}(x) = s(x)\\pi$，其中 $s_{\\min} = 0.7$。\n    变换为 $R_y(\\beta(x))$。\n    $$ \\mathbf{M}_3(x) = R_y(\\beta(x)) \\mathbf{M}_2(x) $$\n4.  **第二次自由进动**：与第一个进动周期相同，演化持续时间为 $\\tau = \\text{TE}/2$。\n    $$ \\mathbf{M}_4(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_3(x) $$\n\n回波时间 TE 时的最终磁化矢量为 $\\mathbf{M}_{\\text{final}}(x) = \\mathbf{M}_4(x)$。复数横向信号 $S(x)$ 由其分量构成：\n$$ S(x) = M_{x, \\text{final}}(x) + i M_{y, \\text{final}}(x) $$\n对传统和绝热重聚焦脉冲模型都执行此计算。\n\n最后，对所有空间位置 $x$ 计算两个汇总指标：\n1.  **平均归一化幅度 ($\\overline{A}$)**：该指标量化相对于没有任何场不均匀性或脉冲不完美性的理想情况的平均信号强度。理想信号幅度为 $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$。\n    $$ \\overline{A} = \\frac{1}{N} \\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}} $$\n2.  **平均绝对相位偏差 ($\\overline{P}$)**：该指标量化信号的空间相位离散度，这会在重建图像中引起伪影。其计算方法是：首先找到信号相位的循环平均值 $\\bar{\\phi}$，然后计算每个相位与该平均值的绝对循环距离的平均值。\n    $$ \\bar{\\phi} = \\arg\\left( \\frac{1}{N} \\sum_x e^{i \\arg S(x)} \\right) $$\n    $$ \\overline{P} = \\frac{1}{N} \\sum_x \\left| \\arg\\left( e^{i(\\arg S(x) - \\bar{\\phi})} \\right) \\right| $$\n    其中 $\\arg(e^{i\\theta})$ 操作确保相位差被包裹在 $(-\\pi, \\pi]$ 范围内。\n\n该实现将对提供的三个测试用例中的每一个执行这些计算，每个用例生成四个指标。为了计算效率，该过程在空间维度上进行了矢量化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the spin-echo simulation for the given test cases.\n    \"\"\"\n\n    def get_rotation_matrix(axis, theta):\n        \"\"\"\n        Generates a stack of 3x3 rotation matrices for a given axis and a vector of angles.\n        \n        Args:\n            axis (str): 'x', 'y', or 'z'.\n            theta (np.ndarray): A 1D array of angles in radians.\n\n        Returns:\n            np.ndarray: A (3, 3, N) array of rotation matrices, where N is the size of theta.\n        \"\"\"\n        num_pts = theta.size\n        c = np.cos(theta)\n        s = np.sin(theta)\n        R = np.zeros((3, 3, num_pts))\n\n        if axis == 'x':\n            R[0, 0, :] = 1.0\n            R[1, 1, :] = c\n            R[1, 2, :] = -s\n            R[2, 1, :] = s\n            R[2, 2, :] = c\n        elif axis == 'y':\n            R[0, 0, :] = c\n            R[0, 2, :] = s\n            R[1, 1, :] = 1.0\n            R[2, 0, :] = -s\n            R[2, 2, :] = c\n        elif axis == 'z':\n            R[0, 0, :] = c\n            R[0, 1, :] = -s\n            R[1, 0, :] = s\n            R[1, 1, :] = c\n            R[2, 2, :] = 1.0\n        return R\n\n    def run_simulation(TE, T2, a, b, s_min, L, N):\n        \"\"\"\n        Runs one full spin-echo simulation for both conventional and adiabatic pulses.\n        \n        Returns:\n            A tuple of four floats: (A_conv, A_adiab, P_conv, P_adiab).\n        \"\"\"\n        # Convert times to seconds\n        TE_s = TE / 1000.0\n        T2_s = T2 / 1000.0\n        tau = TE_s / 2.0\n        \n        # 1. Setup spatial grid and inhomogeneity profiles\n        x_pos = np.linspace(-L, L, N)\n        s_x = 1.0 + a * (x_pos / L)\n        delta_f_x = b * (x_pos / L)\n        delta_omega_x = 2.0 * np.pi * delta_f_x\n\n        # Calculate ideal signal magnitude for normalization\n        ideal_mag = np.exp(-TE_s / T2_s) if T2_s > 0 else 0.0\n\n        # Define pulse flip angles\n        alpha_x = s_x * np.pi / 2.0\n        beta_conv_x = s_x * np.pi\n        beta_adiab_x = np.where(s_x >= s_min, np.pi, s_x * np.pi)\n\n        results = []\n        for pulse_type in ['conventional', 'adiabatic']:\n            # 2. Initialize magnetization vectors\n            M = np.zeros((3, N))\n            M[2, :] = 1.0  # M0 is normalized to 1\n\n            # 3. Excitation pulse (90_x)\n            Rx = get_rotation_matrix('x', alpha_x)\n            M = np.einsum('ijk,jk->ik', Rx, M)\n\n            # 4. First free precession\n            phi_x = delta_omega_x * tau\n            Rz = get_rotation_matrix('z', phi_x)\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 5. Refocusing pulse (180_y)\n            if pulse_type == 'conventional':\n                beta_x = beta_conv_x\n            else: # adiabatic\n                beta_x = beta_adiab_x\n            \n            Ry = get_rotation_matrix('y', beta_x)\n            M = np.einsum('ijk,jk->ik', Ry, M)\n\n            # 6. Second free precession\n            # Note: Rz is the same as before\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 7. Compute signal and metrics\n            S_complex = M[0, :] + 1j * M[1, :]\n            \n            # Mean Normalized Magnitude\n            magnitudes = np.abs(S_complex)\n            A_bar = np.mean(magnitudes / ideal_mag) if ideal_mag > 0 else 0.0\n\n            # Mean Absolute Phase Deviation\n            phases = np.angle(S_complex)\n            mean_unit_vector = np.mean(np.exp(1j * phases))\n            phi_bar = np.angle(mean_unit_vector)\n            \n            phase_diffs = phases - phi_bar\n            wrapped_phase_diffs = np.angle(np.exp(1j * phase_diffs))\n            P_bar = np.mean(np.abs(wrapped_phase_diffs))\n\n            results.extend([A_bar, P_bar])\n\n        # Return (A_conv, P_conv, A_adiab, P_adiab) -> reorder to (A_conv, A_adiab, P_conv, P_adiab)\n        return results[0], results[2], results[1], results[3]\n\n    # Define test cases from the problem statement\n    test_cases = [\n        # (TE_ms, T2_ms, a, b_Hz)\n        (60.0, 70.0, -0.2, 80.0),\n        (80.0, 60.0, -0.5, 120.0),\n        (50.0, 100.0, 0.0, 0.0),\n    ]\n\n    L = 0.1  # meters\n    N = 101\n    s_min = 0.7\n\n    all_results = []\n    for case in test_cases:\n        TE_ms, T2_ms, a, b_Hz = case\n        metrics = run_simulation(TE_ms, T2_ms, a, b_Hz, s_min, L, N)\n        all_results.extend(metrics)\n    \n    # Format and print the final output\n    formatted_results = [f\"{val:.6f}\" for val in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}