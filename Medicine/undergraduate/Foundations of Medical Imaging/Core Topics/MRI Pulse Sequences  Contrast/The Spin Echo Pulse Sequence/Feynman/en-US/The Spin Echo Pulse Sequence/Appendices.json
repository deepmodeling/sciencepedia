{
    "hands_on_practices": [
        {
            "introduction": "This foundational exercise guides you through the derivation of the classic spin echo signal equation from first principles. By connecting the abstract Bloch equations to the final signal expression, you will gain a deeper appreciation for how image contrast arises from the interplay of tissue properties ($T_1$, $T_2$, and proton density) and sequence parameters ($TR$, $TE$). This practice is essential for mastering the ability to predict and control the appearance of different tissues in an image. ",
            "id": "4935739",
            "problem": "Consider an ideal two-pulse Spin Echo (SE) sequence in a stationary, homogeneous sample with uniform proton density $\\rho$ placed in a static magnetic field $B_0$. The sequence consists of a $90^{\\circ}$ Radio Frequency (RF) pulse at $t=0$ followed by a $180^{\\circ}$ RF pulse at $t = TE/2$, where $TE$ is the echo time. The sequence is repeated with repetition time $TR$. Assume perfect flip angles, negligible diffusion, perfect refocusing of phase by the $180^{\\circ}$ pulse (so that only irreversible transverse relaxation contributes to the echo amplitude), and complete spoiling of any residual transverse magnetization between repetitions so that the longitudinal magnetization immediately after each $90^{\\circ}$ pulse is zero. The sample’s longitudinal relaxation is characterized by the longitudinal relaxation time $T_1$, and transverse relaxation is characterized by the transverse relaxation time $T_2$. The receive chain maps transverse magnetization linearly to signal amplitude with unit proportionality.\n\nStarting from the longitudinal component of the Bloch equations and the stated physical assumptions, derive the SE signal $S(TE)$ at the echo as a function of $\\rho$, $TR$, $T_1$, and $T_2$. Then, analytically evaluate the limit of $S(TE)$ as $TE \\to 0$. Express the final answer as a single closed-form analytic expression in terms of $\\rho$, $TR$, and $T_1$ only. No numerical evaluation is required.",
            "solution": "The problem is scientifically grounded, well-posed, and contains sufficient information for a unique solution. The assumptions, while idealizations, are standard for introductory treatments of this topic and are internally consistent. The problem is therefore deemed valid.\n\nThe derivation proceeds in two main stages: first, determining the longitudinal magnetization available at the start of a pulse sequence repetition by solving the longitudinal Bloch equation, and second, calculating the transverse magnetization at the echo time, which constitutes the signal.\n\nThe longitudinal component of the Bloch equation, which describes the time evolution of the longitudinal magnetization $M_z$ back towards its thermal equilibrium value $M_0$, is given by:\n$$\n\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}\n$$\nwhere $T_1$ is the longitudinal relaxation time. The problem states that the sample has a uniform proton density $\\rho$. The equilibrium magnetization $M_0$ is directly proportional to this density. Given the assumption of unit proportionality in the receive chain, we can set $M_0 = \\rho$.\n\nThe pulse sequence is repeated with a repetition time $TR$. We analyze the system in a steady-state condition. At the beginning of each cycle (let's set this as $t=0$), a $90^\\circ$ RF pulse is applied. This pulse rotates the available longitudinal magnetization into the transverse plane. The problem explicitly states that \"the longitudinal magnetization immediately after each $90^\\circ$ pulse is zero\". This is a direct consequence of a perfect $90^\\circ$ pulse, as the post-pulse longitudinal magnetization $M_z(0^+)$ is related to the pre-pulse magnetization $M_z(0^-)$ by $M_z(0^+) = M_z(0^-)\\cos(90^\\circ) = 0$.\n\nThis gives us the initial condition for the longitudinal relaxation during the repetition interval. After the $90^\\circ$ pulse at $t=0$, the longitudinal magnetization $M_z$ recovers from $M_z(0) = 0$ towards $M_0$. We solve the differential equation with this initial condition.\n$$\n\\int_{0}^{M_z(t)} \\frac{dM_z'}{M_0 - M_z'} = \\int_{0}^{t} \\frac{dt'}{T_1}\n$$\nThe integration yields:\n$$\n[-\\ln(M_0 - M_z')]_{0}^{M_z(t)} = \\frac{t}{T_1}\n$$\n$$\n\\ln\\left(\\frac{M_0 - M_z(t)}{M_0 - 0}\\right) = -\\frac{t}{T_1}\n$$\nSolving for $M_z(t)$:\n$$\nM_z(t) = M_0 \\left( 1 - \\exp\\left(-\\frac{t}{T_1}\\right) \\right)\n$$\nThe assumption of complete spoiling of transverse magnetization ensures that a full $TR$ period is available for longitudinal recovery, unaffected by the timing of the $180^\\circ$ pulse or the echo. Thus, at the end of the repetition interval, just before the next $90^\\circ$ pulse, the longitudinal magnetization has recovered to:\n$$\nM_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\nThis is the longitudinal magnetization available for the next excitation. The $90^\\circ$ pulse at the beginning of the next cycle flips this entire amount into the transverse plane. The initial magnitude of the transverse magnetization is therefore:\n$$\nM_{xy}(0^+) = M_z(TR^-) = M_0 \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\nFollowing this excitation, the transverse magnetization decays due to irreversible spin-spin interactions, characterized by the transverse relaxation time $T_2$. The magnitude of the transverse magnetization at a time $t$ after the $90^\\circ$ pulse is given by:\n$$\nM_{xy}(t) = M_{xy}(0^+) \\exp\\left(-\\frac{t}{T_2}\\right)\n$$\nThe $180^\\circ$ pulse at $t=TE/2$ perfectly refocuses dephasing due to external field inhomogeneities, but it does not affect the decay envelope governed by $T_2$. The spin echo signal, $S(TE)$, is measured at $t=TE$. Due to the unit proportionality assumption, $S(TE) = M_{xy}(TE)$.\n$$\nS(TE) = M_{xy}(0^+) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\nSubstituting the expressions for $M_{xy}(0^+)$ and $M_0 = \\rho$:\n$$\nS(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right)\n$$\nThis is the general expression for the signal in an ideal spin echo sequence.\n\nThe second part of the problem requires us to evaluate the limit of this signal as the echo time $TE$ approaches zero.\n$$\n\\lim_{TE \\to 0} S(TE) = \\lim_{TE \\to 0} \\left[ \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\nThe term $\\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)$ is independent of $TE$ and can be treated as a constant in this limit.\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right) \\lim_{TE \\to 0} \\left[ \\exp\\left(-\\frac{TE}{T_2}\\right) \\right]\n$$\nThe limit of the exponential term is evaluated as:\n$$\n\\lim_{TE \\to 0} \\exp\\left(-\\frac{TE}{T_2}\\right) = \\exp(0) = 1\n$$\nSubstituting this result back into the expression for the signal limit, we obtain the final answer:\n$$\n\\lim_{TE \\to 0} S(TE) = \\rho \\left( 1 - \\exp\\left(-\\frac{TR}{T_1}\\right) \\right)\n$$\nThis expression depends only on $\\rho$, $TR$, and $T_1$, as requested. It represents the signal from a \"proton-density weighted\" or \"$T_1$-weighted\" image where the effects of $T_2$ decay have been eliminated by choosing a minimal echo time.",
            "answer": "$$\n\\boxed{\\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right)}\n$$"
        },
        {
            "introduction": "The spin echo sequence perfectly refocuses phase shifts from static field variations, but this mechanism breaks down when spins are in motion. This practice explores the important real-world scenario of moving spins, such as those in flowing blood, and how their movement leads to incomplete rephasing and signal loss. By calculating the motion-induced phase error, you will understand the origin of common motion artifacts and the physical principle underlying advanced techniques like MR angiography and diffusion imaging. ",
            "id": "4935706",
            "problem": "A Hahn spin echo is formed by a $90^\\circ$ radiofrequency pulse at time $t=0$ followed by a $180^\\circ$ radiofrequency pulse at time $t=T_E/2$, with the spin echo observed at time $t=T_E$. Consider an ensemble of identical hydrogen nuclei in a main magnetic field whose spatial inhomogeneity can be modeled as a static, uniform, linear field gradient along the $z$-axis, so that the local Larmor angular frequency offset is $\\omega(z)=\\gamma G z$, where $\\gamma$ is the gyromagnetic ratio and $G$ is the constant gradient amplitude along $z$. Assume the radiofrequency pulses are ideal and instantaneous, and intrinsic transverse relaxation (spin-spin relaxation) is long compared to the echo time so that it can be neglected over the interval $[0,T_E]$.\n\nStart from the definition of phase as the time integral of the instantaneous angular frequency and the effect of the $180^\\circ$ pulse as inverting the accumulated phase, and reason from first principles to show how rigid bulk motion between the $90^\\circ$ and $180^\\circ$ pulses can lead to incomplete rephasing at $t=T_E$.\n\nNow consider a simple two-compartment model:\n- A fraction $f$ of the spins translates rigidly with constant velocity $v$ along $+\\hat{z}$ during the interval $0 \\le t  T_E/2$, and then remains stationary at its new position for $T_E/2 \\le t \\le T_E$.\n- The remaining fraction $1-f$ is stationary for $0 \\le t \\le T_E$.\n\nLet the ensemble’s complex transverse signal at the echo time $t=T_E$ be the vector sum of the stationary and moving compartments’ transverse magnetization phasors. Define the echo attenuation factor $A$ as the magnitude of this complex sum normalized by the magnitude that would be obtained if all spins were stationary (i.e., the no-motion echo magnitude under the same $G$ and $T_E$).\n\nUsing only the principles described above, derive an expression for $A$ and then compute its numerical value for the following parameters:\n- $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$,\n- $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$,\n- $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$,\n- $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$,\n- $f = 0.40$.\n\nExpress the final attenuation factor $A$ as a dimensionless ratio. Use radians for any angles and round your final answer to four significant figures.",
            "solution": "The user-provided problem is first validated against the specified criteria.\n\n### Problem Validation\n\n#### Step 1: Extract Givens\n- **Sequence**: A Hahn spin echo consists of a $90^\\circ$ radiofrequency pulse at $t=0$ and a $180^\\circ$ radiofrequency pulse at $t=T_E/2$. The echo is observed at $t=T_E$.\n- **Field Gradient**: A static, uniform, linear field gradient along the $z$-axis with amplitude $G$.\n- **Larmor Frequency Offset**: The local Larmor angular frequency offset is $\\omega(z)=\\gamma G z$, where $\\gamma$ is the gyromagnetic ratio.\n- **Assumptions**:\n    1.  Radiofrequency pulses are ideal and instantaneous.\n    2.  Intrinsic transverse relaxation ($T_2$ decay) is negligible over the interval $[0, T_E]$.\n- **Phase Definition**: Phase is the time integral of the instantaneous angular frequency.\n- **$180^\\circ$ Pulse Effect**: Inverts the accumulated phase.\n- **Two-Compartment Model**:\n    - A fraction $f$ of spins translates rigidly with constant velocity $v$ along $+\\hat{z}$ during $0 \\le t  T_E/2$, then remains stationary for $T_E/2 \\le t \\le T_E$.\n    - The remaining fraction $1-f$ is stationary for $0 \\le t \\le T_E$.\n- **Echo Attenuation Factor ($A$)**: The magnitude of the complex sum of the transverse magnetizations of the stationary and moving compartments at $t=T_E$, normalized by the magnitude that would be obtained if all spins were stationary.\n- **Parameters for Numerical Calculation**:\n    - $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$\n    - $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$\n    - $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$\n    - $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$\n    - $f = 0.40$\n\n#### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded (Critical)**: The problem is firmly rooted in the principles of nuclear magnetic resonance (NMR) and magnetic resonance imaging (MRI). The Hahn spin echo, Larmor frequency, field gradients, and the effect of motion on phase are all standard concepts in this field. The model is a simplified but valid representation used to understand motion-related signal attenuation (e.g., in diffusion-weighted or perfusion-weighted imaging). The problem is scientifically sound.\n- **Well-Posed**: The problem provides all necessary definitions, parameters, and a clear objective. The model is well-defined, and the question asks for a single, derivable expression and a corresponding numerical value. A unique solution exists.\n- **Objective (Critical)**: The problem is stated in precise, quantitative, and unbiased language. All terms are defined within the context of physics. There are no subjective or opinion-based statements.\n\nThe problem does not exhibit any of the invalidity flaws. It is self-contained, consistent, realistic within the context of MRI physics modeling, and well-structured.\n\n#### Step 3: Verdict and Action\nThe problem is valid. The solution process may proceed.\n\n### Derivation and Solution\n\nThe core of the problem lies in calculating the phase accumulated by spins at the echo time, $t=T_E$. The phase $\\phi$ of a spin is the time integral of its instantaneous angular frequency offset, $\\omega(t)$. After an initial $90^\\circ$ pulse at $t=0$, which tips the net magnetization into the transverse plane, each spin precursor accumulates phase according to its position $z(t)$ in the magnetic field gradient.\n\nThe phase accumulated by a spin from $t=0$ until a time $t_{acq}$ is given by:\n$$ \\phi(t_{acq}) = \\int_0^{t_{acq}} \\omega(z(\\tau)) d\\tau = \\int_0^{t_{acq}} \\gamma G z(\\tau) d\\tau $$\nIn the spin echo sequence, the total evolution is split into two intervals by the $180^\\circ$ pulse at $t=T_E/2$. The $180^\\circ$ pulse has the effect of conjugating the transverse magnetization, which is equivalent to inverting the phase accumulated up to that point. Therefore, the total phase $\\phi_{total}(T_E)$ at the echo time $t=T_E$ is the sum of the inverted phase from the first interval and the phase accumulated during the second interval:\n$$ \\phi_{total}(T_E) = -\\int_0^{T_E/2} \\gamma G z(\\tau) d\\tau + \\int_{T_E/2}^{T_E} \\gamma G z(\\tau) d\\tau $$\n\nFor a stationary spin, its position is constant, $z(t) = z_0$. The total phase is:\n$$ \\phi_{stationary}(T_E) = -\\int_0^{T_E/2} \\gamma G z_0 d\\tau + \\int_{T_E/2}^{T_E} \\gamma G z_0 d\\tau = -\\gamma G z_0 \\frac{T_E}{2} + \\gamma G z_0 \\frac{T_E}{2} = 0 $$\nThis perfect rephasing, independent of the initial position $z_0$, is the principle of the spin echo for static inhomogeneities. All stationary spins contribute coherently to the echo signal.\n\nFor a moving spin, the position $z(t)$ is not constant, and the two integrals may not cancel. This leads to a net phase shift at $t=T_E$, causing incomplete rephasing and signal attenuation when averaged over an ensemble of spins with different motion paths.\n\nWe now apply this framework to the given two-compartment model.\n\n**Stationary Compartment (Fraction $1-f$):**\nAs derived above, for any spin that remains stationary at a position $z_0$, its total phase accumulation at $t=T_E$ is $\\phi_S = 0$. The complex signal contribution from this compartment, normalized to the initial signal, is $(1-f)e^{i\\phi_S} = (1-f)e^{i \\cdot 0} = 1-f$.\n\n**Moving Compartment (Fraction $f$):**\nA spin in this compartment starts at $z_0$ at $t=0$.\n1.  For $0 \\le t  T_E/2$, it moves with constant velocity $v$, so its position is $z(t) = z_0 + v t$.\n2.  For $T_E/2 \\le t \\le T_E$, it is stationary at the position it reached at $t=T_E/2$, which is $z(T_E/2) = z_0 + v (T_E/2)$.\n\nThe phase accumulated in the first interval ($0$ to $T_E/2$) is:\n$$ \\phi_1 = \\int_0^{T_E/2} \\gamma G (z_0 + v\\tau) d\\tau = \\gamma G \\left[ z_0\\tau + \\frac{1}{2}v\\tau^2 \\right]_0^{T_E/2} = \\gamma G \\left( z_0 \\frac{T_E}{2} + \\frac{1}{2}v \\left(\\frac{T_E}{2}\\right)^2 \\right) = \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{8} \\right) $$\nThe phase accumulated in the second interval ($T_E/2$ to $T_E$) is:\n$$ \\phi_2 = \\int_{T_E/2}^{T_E} \\gamma G \\left(z_0 + v\\frac{T_E}{2}\\right) d\\tau = \\gamma G \\left(z_0 + v\\frac{T_E}{2}\\right) \\left( T_E - \\frac{T_E}{2} \\right) = \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{4} \\right) $$\nThe total phase for a moving spin, $\\phi_M$, is $\\phi_{total}(T_E) = -\\phi_1 + \\phi_2$:\n$$ \\phi_M = -\\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{8} \\right) + \\gamma G \\left( \\frac{z_0 T_E}{2} + \\frac{v T_E^2}{4} \\right) $$\n$$ \\phi_M = \\left( -\\frac{\\gamma G z_0 T_E}{2} + \\frac{\\gamma G z_0 T_E}{2} \\right) + \\left( -\\frac{\\gamma G v T_E^2}{8} + \\frac{\\gamma G v T_E^2}{4} \\right) = \\frac{\\gamma G v T_E^2}{8} $$\nThe phase is independent of the initial position $z_0$ but depends on the motion parameters $v$, $G$, and $T_E$. The complex signal contribution from this compartment is $f e^{i\\phi_M}$.\n\n**Total Signal and Attenuation Factor $A$:**\nThe total complex signal $S_{total}$ at $t=T_E$ is the weighted vector sum of the signals from the two compartments:\n$$ S_{total} = (1-f)e^{i\\phi_S} + f e^{i\\phi_M} = (1-f) + f e^{i(\\frac{1}{8}\\gamma G v T_E^2)} $$\nThe attenuation factor $A$ is the magnitude of this signal, $|S_{total}|$, normalized by the no-motion signal magnitude. If all spins were stationary ($v=0$ for the moving fraction), then $\\phi_M=0$, and the signal magnitude would be $|(1-f)+f|=1$. Thus, $A = |S_{total}|$.\nWe calculate the magnitude squared:\n$$ A^2 = |(1-f) + f e^{i\\phi_M}|^2 = \\left( (1-f) + f\\cos(\\phi_M) \\right)^2 + \\left( f\\sin(\\phi_M) \\right)^2 $$\n$$ A^2 = (1-f)^2 + 2f(1-f)\\cos(\\phi_M) + f^2\\cos^2(\\phi_M) + f^2\\sin^2(\\phi_M) $$\n$$ A^2 = (1-f)^2 + f^2 + 2f(1-f)\\cos(\\phi_M) $$\nSo, the expression for the attenuation factor is:\n$$ A = \\sqrt{(1-f)^2 + f^2 + 2f(1-f)\\cos\\left(\\frac{1}{8}\\gamma G v T_E^2\\right)} $$\n\n**Numerical Calculation:**\nFirst, we compute the phase $\\phi_M$ using the given parameters:\n- $\\gamma = 2.675 \\times 10^{8}\\ \\text{rad}\\ \\text{s}^{-1}\\ \\text{T}^{-1}$\n- $G = 5 \\times 10^{-3}\\ \\text{T}\\ \\text{m}^{-1}$\n- $v = 5 \\times 10^{-3}\\ \\text{m}\\ \\text{s}^{-1}$\n- $T_E = 3.0 \\times 10^{-2}\\ \\text{s}$\n\n$$ \\phi_M = \\frac{1}{8} \\gamma G v T_E^2 = \\frac{1}{8} (2.675 \\times 10^8) (5 \\times 10^{-3}) (5 \\times 10^{-3}) (3.0 \\times 10^{-2})^2 $$\n$$ \\phi_M = \\frac{1}{8} (2.675 \\times 5 \\times 5 \\times 9.0) \\times 10^{8-3-3-4} = \\frac{601.875}{8} \\times 10^{-2} $$\n$$ \\phi_M = 75.234375 \\times 10^{-2} = 0.75234375\\ \\text{rad} $$\n\nNext, we calculate the attenuation factor $A$ with $f = 0.40$ (so $1-f = 0.60$):\n$$ A^2 = (0.60)^2 + (0.40)^2 + 2(0.40)(0.60)\\cos(0.75234375) $$\n$$ A^2 = 0.36 + 0.16 + 0.48 \\cos(0.75234375) $$\n$$ A^2 = 0.52 + 0.48 \\times (0.730145155...) $$\n$$ A^2 = 0.52 + 0.350469674... = 0.870469674... $$\n$$ A = \\sqrt{0.870469674...} = 0.933000361... $$\n\nRounding to four significant figures, the final attenuation factor is $0.9330$.",
            "answer": "$$\\boxed{0.9330}$$"
        },
        {
            "introduction": "Ideal pulses and perfectly uniform magnetic fields are a convenient fiction; real-world MRI is subject to hardware imperfections. This hands-on computational exercise challenges you to build a Bloch equation simulator to visualize the signal degradation caused by non-uniform static ($B_0$) and RF ($B_1$) fields. Furthermore, you will test a model of an adiabatic refocusing pulse, demonstrating how advanced pulse design can overcome these practical limitations to produce more robust and reliable images. ",
            "id": "4935662",
            "problem": "You are asked to write a complete program that simulates a single spin-echo in Magnetic Resonance Imaging (MRI) under position-dependent radiofrequency field inhomogeneity (denoted as $B_1$) and static field inhomogeneity (denoted as $B_0$), and to quantify how an adiabatic refocusing pulse mitigates $B_1$ sensitivity relative to a conventional refocusing pulse. The simulation must be based on the Bloch equation in the rotating frame, using hard-pulse, instantaneous-rotation models for radiofrequency (RF) pulses, and free precession with transverse relaxation during the evolution periods.\n\nStart from these fundamental bases:\n- The Bloch equation in the rotating frame, $\\frac{d\\mathbf{M}}{dt} = \\gamma \\mathbf{M} \\times \\mathbf{B}_{\\text{eff}}$, where $\\mathbf{M}$ is the magnetization vector and $\\mathbf{B}_{\\text{eff}}$ is the effective field.\n- An on-resonance, instantaneous hard RF pulse about a Cartesian axis is modeled as a rotation of the magnetization vector by an angle $\\theta$ about that axis, represented by a proper rotation matrix.\n- Off-resonance during free precession at angular frequency offset $\\Delta \\omega$ induces a rotation about the $z$-axis by angle $\\phi = \\Delta \\omega \\, \\tau$ over time interval $\\tau$, along with transverse relaxation described by an exponential factor $e^{-\\tau/T_2}$ on the transverse components, where $T_2$ is the spin-spin relaxation time. Longitudinal relaxation ($T_1$) is neglected by assuming a long repetition time such that the initial magnetization is $\\mathbf{M}_0 = [0,0,M_0]^\\top$ with $M_0$ constant.\n- A spin-echo sequence consists of an excitation pulse followed by two free precession periods of equal duration with a refocusing pulse at their midpoint. Use a $90^\\circ$ excitation about the $x$-axis and a $180^\\circ$ refocusing about the $y$-axis as the nominal pulse orientations.\n\nModel the field-of-view (FOV) as one-dimensional positions $x \\in [-L, L]$ with $L = 0.1 \\, \\text{m}$. At each position $x$, let the relative $B_1$ scaling be $s(x)$ and the static frequency offset be $\\Delta f(x)$ in hertz, with angular offset $\\Delta \\omega(x) = 2 \\pi \\, \\Delta f(x)$. The $B_1$ inhomogeneity scales the flip angles of both the excitation and refocusing pulses. The models for the refocusing pulses are:\n- Conventional refocusing: an instantaneous rotation about the $y$-axis by angle $\\beta(x) = s(x) \\, \\pi$.\n- Adiabatic refocusing (simplified): a robust $\\pi$ rotation when the local $B_1$ scale exceeds a threshold, i.e., $\\beta_{\\text{adiab}}(x) = \\pi$ if $s(x) \\ge s_{\\min}$ and $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$ otherwise. Use the same rotation axis ($y$-axis) for both cases to keep the model comparable.\n\nLet the excitation pulse be a $90^\\circ$ rotation about the $x$-axis scaled by $s(x)$, i.e., $\\alpha(x) = s(x)\\,\\pi/2$. Free precession occurs for $\\tau = \\text{TE}/2$ before and after the refocusing pulse, each modeled as a rotation about the $z$-axis by angle $\\phi(x) = \\Delta \\omega(x)\\, \\tau$ along with transverse decay $e^{-\\tau/T_2}$.\n\nAlgorithmic requirements:\n1. Initialize $\\mathbf{M}(x)$ to $\\mathbf{M}_0 = [0,0,M_0]^\\top$ with $M_0 = 1$.\n2. Apply the excitation rotation $R_x(\\alpha(x))$ to obtain $\\mathbf{M}$ immediately after the excitation.\n3. Apply free precession for $\\tau = \\text{TE}/2$: rotate by $R_z(\\phi(x))$ and multiply the transverse components by $e^{-\\tau/T_2}$.\n4. Apply the refocusing rotation:\n   - For the conventional case: $R_y(\\beta(x))$ with $\\beta(x) = s(x)\\,\\pi$.\n   - For the adiabatic case: $R_y(\\beta_{\\text{adiab}}(x))$ with $\\beta_{\\text{adiab}}(x) = \\pi$ if $s(x) \\ge s_{\\min}$, else $\\beta_{\\text{adiab}}(x) = s(x)\\,\\pi$.\n5. Apply the second free precession for $\\tau = \\text{TE}/2$: rotate by $R_z(\\phi(x))$ and multiply the transverse components by $e^{-\\tau/T_2}$.\n6. At echo time, compute the complex transverse signal $S(x) = M_x(x) + i M_y(x)$. Define the ideal echo magnitude for perfect pulses (no inhomogeneity) as $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$.\n7. For each case (conventional and adiabatic), compute two spatial summary metrics:\n   - Mean normalized magnitude: $\\overline{A} = \\frac{1}{N}\\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}}$ (dimensionless).\n   - Mean absolute phase deviation in radians: first compute the circular mean phase $\\bar{\\phi} = \\arg\\left(\\frac{1}{N}\\sum_x e^{i \\arg S(x)}\\right)$, then compute $\\frac{1}{N}\\sum_x \\left| \\arg\\left(e^{i(\\arg S(x) - \\bar{\\phi})}\\right) \\right|$.\n\nAngles must be handled in radians. When reporting parameters that involve physical units, strictly adhere to the specified units below.\n\nTest suite:\nUse $N = 101$ uniformly spaced positions over $[-L, L]$ with $L = 0.1 \\, \\text{m}$. For each test case, define $s(x) = 1 + a \\, (x/L)$ and $\\Delta f(x) = b \\, (x/L)$ in hertz, with a fixed adiabatic threshold $s_{\\min} = 0.7$. For each test case, compute the four outputs: $(\\overline{A}_{\\text{conv}}, \\overline{A}_{\\text{adiab}}, \\overline{P}_{\\text{conv}}, \\overline{P}_{\\text{adiab}})$ in the specified order and units, where $\\overline{P}$ denotes the mean absolute phase deviation in radians. Use:\n- Case $1$ (happy path): $\\text{TE} = 60 \\, \\text{ms}$, $T_2 = 70 \\, \\text{ms}$, $a = -0.2$, $b = 80 \\, \\text{Hz}$.\n- Case $2$ (edge with severe $B_1$ and $B_0$): $\\text{TE} = 80 \\, \\text{ms}$, $T_2 = 60 \\, \\text{ms}$, $a = -0.5$, $b = 120 \\, \\text{Hz}$.\n- Case $3$ (boundary, no inhomogeneity): $\\text{TE} = 50 \\, \\text{ms}$, $T_2 = 100 \\, \\text{ms}$, $a = 0.0$, $b = 0 \\, \\text{Hz}$.\n\nYour program must:\n- Implement the above physics using only instantaneous rotations and free precession with transverse decay.\n- Express times in seconds internally, with inputs given in milliseconds.\n- Use radians for all angles.\n- Output a single line containing a comma-separated list enclosed in square brackets with the $12$ floating-point results in this exact order:\n  $[\\overline{A}_{\\text{conv}}^{(1)}, \\overline{A}_{\\text{adiab}}^{(1)}, \\overline{P}_{\\text{conv}}^{(1)}, \\overline{P}_{\\text{adiab}}^{(1)}, \\overline{A}_{\\text{conv}}^{(2)}, \\overline{A}_{\\text{adiab}}^{(2)}, \\overline{P}_{\\text{conv}}^{(2)}, \\overline{P}_{\\text{adiab}}^{(2)}, \\overline{A}_{\\text{conv}}^{(3)}, \\overline{A}_{\\text{adiab}}^{(3)}, \\overline{P}_{\\text{conv}}^{(3)}, \\overline{P}_{\\text{adiab}}^{(3)}]$.\n- Round each value to exactly $6$ decimal places.\n- Units: for $\\overline{A}$ use dimensionless normalization, and for $\\overline{P}$ report radians.\n\nScientific realism requirements:\n- Do not assume any $T_1$ effects.\n- Do not assume any gradient-induced dephasing beyond the specified $\\Delta f(x)$.\n- RF pulses are instantaneous; free precession occurs only in the two evolution windows of duration $\\text{TE}/2$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[0.123456,0.234567,0.012345,0.023456, \\ldots]$). No other output is permitted.",
            "solution": "The problem statement has been analyzed and is determined to be valid. It is scientifically grounded in the principles of Nuclear Magnetic Resonance (NMR), well-posed with a clear and deterministic set of instructions, and objective in its language. All parameters and models are specified, allowing for a unique and meaningful solution. We may therefore proceed with a formal solution.\n\nThe simulation of the spin-echo sequence is founded on the Bloch equation in the rotating frame, which governs the dynamics of the macroscopic magnetization vector $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$. The problem simplifies the continuous evolution into a sequence of discrete events: instantaneous radiofrequency (RF) pulses and periods of free precession. Each event is modeled as a matrix transformation applied to the magnetization vector.\n\nThe initial state of the system, following the assumption of long repetition time, is thermal equilibrium magnetization aligned with the main magnetic field (the $z$-axis). We normalize this initial magnetization to $M_0 = 1$, so $\\mathbf{M}_0 = [0, 0, 1]^\\top$.\n\nAn instantaneous RF pulse with flip angle $\\theta$ about an axis $\\mathbf{u}$ in the rotating frame (e.g., $x$ or $y$) is modeled as a rotation of the magnetization vector. The corresponding rotation matrices for the $x$ and $y$ axes are:\n$$\nR_x(\\theta) = \\begin{pmatrix} 1  0  0 \\\\ 0  \\cos\\theta  -\\sin\\theta \\\\ 0  \\sin\\theta  \\cos\\theta \\end{pmatrix} \\quad \\text{and} \\quad R_y(\\theta) = \\begin{pmatrix} \\cos\\theta  0  \\sin\\theta \\\\ 0  1  0 \\\\ -\\sin\\theta  0  \\cos\\theta \\end{pmatrix}\n$$\nThese matrices will be used to model the excitation and refocusing pulses.\n\nFree precession for a duration $\\tau$ in the presence of a static field offset $\\Delta \\omega$ and transverse relaxation time $T_2$ is modeled by two concurrent processes: a rotation about the $z$-axis by an angle $\\phi = \\Delta \\omega \\, \\tau$, and an exponential decay of the transverse magnetization components ($M_x, M_y$). The $z$-component $M_z$ is assumed to be constant as longitudinal relaxation ($T_1$) is neglected. This combined operation can be represented by a transformation matrix $P(\\phi, \\tau, T_2)$:\n$$\nP(\\phi, \\tau, T_2) = \\begin{pmatrix} e^{-\\tau/T_2}  0  0 \\\\ 0  e^{-\\tau/T_2}  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} \\cos\\phi  -\\sin\\phi  0 \\\\ \\sin\\phi  \\cos\\phi  0 \\\\ 0  0  1 \\end{pmatrix} = \\begin{pmatrix} e^{-\\tau/T_2}\\cos\\phi  -e^{-\\tau/T_2}\\sin\\phi  0 \\\\ e^{-\\tau/T_2}\\sin\\phi  e^{-\\tau/T_2}\\cos\\phi  0 \\\\ 0  0  1 \\end{pmatrix}\n$$\nThe order of decay and rotation commutes, so a single matrix multiplication suffices.\n\nThe spin-echo sequence consists of five distinct steps applied sequentially to the initial magnetization $\\mathbf{M}_0$. The simulation is performed for a set of $N=101$ spatial positions $x \\in [-L, L]$, where $L=0.1 \\, \\text{m}$. The RF pulse flip angles and the off-resonance frequency are functions of position $x$:\n1.  The $B_1$ inhomogeneity factor is $s(x) = 1 + a (x/L)$.\n2.  The off-resonance frequency is $\\Delta f(x) = b (x/L)$, leading to an angular frequency offset $\\Delta \\omega(x) = 2\\pi \\Delta f(x)$.\n\nThe sequence of transformations is as follows:\n1.  **Excitation Pulse**: A $90^\\circ$ pulse about the $x$-axis, scaled by $B_1$ inhomogeneity. The flip angle is $\\alpha(x) = s(x) \\frac{\\pi}{2}$. The transformation is $R_x(\\alpha(x))$.\n    $$ \\mathbf{M}_1(x) = R_x(\\alpha(x)) \\mathbf{M}_0 $$\n2.  **First Free Precession**: Evolution for a duration $\\tau = \\text{TE}/2$. The precession angle is $\\phi(x) = \\Delta \\omega(x) \\tau$. The transformation is $P(\\phi(x), \\tau, T_2)$.\n    $$ \\mathbf{M}_2(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_1(x) $$\n3.  **Refocusing Pulse**: A $180^\\circ$ pulse about the $y$-axis. The flip angle $\\beta(x)$ depends on the pulse type:\n    -   **Conventional**: $\\beta_{\\text{conv}}(x) = s(x) \\pi$.\n    -   **Adiabatic (simplified model)**: $\\beta_{\\text{adiab}}(x) = \\pi$ if $s(x) \\ge s_{\\min}$, and $\\beta_{\\text{adiab}}(x) = s(x)\\pi$ otherwise, with $s_{\\min} = 0.7$.\n    The transformation is $R_y(\\beta(x))$.\n    $$ \\mathbf{M}_3(x) = R_y(\\beta(x)) \\mathbf{M}_2(x) $$\n4.  **Second Free Precession**: Identical to the first precession period, evolving for $\\tau = \\text{TE}/2$.\n    $$ \\mathbf{M}_4(x) = P(\\phi(x), \\tau, T_2) \\mathbf{M}_3(x) $$\n\nThe final magnetization vector at echo time TE is $\\mathbf{M}_{\\text{final}}(x) = \\mathbf{M}_4(x)$. The complex transverse signal $S(x)$ is constructed from its components:\n$$ S(x) = M_{x, \\text{final}}(x) + i M_{y, \\text{final}}(x) $$\nThis calculation is performed for both the conventional and adiabatic refocusing pulse models.\n\nFinally, two summary metrics are computed over all spatial positions $x$:\n1.  **Mean Normalized Magnitude ($\\overline{A}$)**: This metric quantifies the average signal strength relative to an ideal scenario without any field inhomogeneities or pulse imperfections. The ideal signal magnitude is $|S|_{\\text{ideal}} = e^{-\\text{TE}/T_2}$.\n    $$ \\overline{A} = \\frac{1}{N} \\sum_{x} \\frac{|S(x)|}{|S|_{\\text{ideal}}} $$\n2.  **Mean Absolute Phase Deviation ($\\overline{P}$)**: This metric quantifies the spatial phase dispersion of the signal, which can cause artifacts in the reconstructed image. It is calculated by finding the circular mean of the signal phases, $\\bar{\\phi}$, and then averaging the absolute circular distance of each phase from this mean.\n    $$ \\bar{\\phi} = \\arg\\left( \\frac{1}{N} \\sum_x e^{i \\arg S(x)} \\right) $$\n    $$ \\overline{P} = \\frac{1}{N} \\sum_x \\left| \\arg\\left( e^{i(\\arg S(x) - \\bar{\\phi})} \\right) \\right| $$\n    where the $\\arg(e^{i\\theta})$ operation ensures the phase difference is wrapped into the range $(-\\pi, \\pi]$.\n\nThe implementation will perform these calculations for each of the three test cases provided, generating four metrics per case. The process is vectorized over the spatial dimension for computational efficiency.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the spin-echo simulation for the given test cases.\n    \"\"\"\n\n    def get_rotation_matrix(axis, theta):\n        \"\"\"\n        Generates a stack of 3x3 rotation matrices for a given axis and a vector of angles.\n        \n        Args:\n            axis (str): 'x', 'y', or 'z'.\n            theta (np.ndarray): A 1D array of angles in radians.\n\n        Returns:\n            np.ndarray: A (3, 3, N) array of rotation matrices, where N is the size of theta.\n        \"\"\"\n        num_pts = theta.size\n        c = np.cos(theta)\n        s = np.sin(theta)\n        R = np.zeros((3, 3, num_pts))\n\n        if axis == 'x':\n            R[0, 0, :] = 1.0\n            R[1, 1, :] = c\n            R[1, 2, :] = -s\n            R[2, 1, :] = s\n            R[2, 2, :] = c\n        elif axis == 'y':\n            R[0, 0, :] = c\n            R[0, 2, :] = s\n            R[1, 1, :] = 1.0\n            R[2, 0, :] = -s\n            R[2, 2, :] = c\n        elif axis == 'z':\n            R[0, 0, :] = c\n            R[0, 1, :] = -s\n            R[1, 0, :] = s\n            R[1, 1, :] = c\n            R[2, 2, :] = 1.0\n        return R\n\n    def run_simulation(TE, T2, a, b, s_min, L, N):\n        \"\"\"\n        Runs one full spin-echo simulation for both conventional and adiabatic pulses.\n        \n        Returns:\n            A tuple of four floats: (A_conv, A_adiab, P_conv, P_adiab).\n        \"\"\"\n        # Convert times to seconds\n        TE_s = TE / 1000.0\n        T2_s = T2 / 1000.0\n        tau = TE_s / 2.0\n        \n        # 1. Setup spatial grid and inhomogeneity profiles\n        x_pos = np.linspace(-L, L, N)\n        s_x = 1.0 + a * (x_pos / L)\n        delta_f_x = b * (x_pos / L)\n        delta_omega_x = 2.0 * np.pi * delta_f_x\n\n        # Calculate ideal signal magnitude for normalization\n        ideal_mag = np.exp(-TE_s / T2_s) if T2_s > 0 else 0.0\n\n        # Define pulse flip angles\n        alpha_x = s_x * np.pi / 2.0\n        beta_conv_x = s_x * np.pi\n        beta_adiab_x = np.where(s_x >= s_min, np.pi, s_x * np.pi)\n\n        results = []\n        for pulse_type in ['conventional', 'adiabatic']:\n            # 2. Initialize magnetization vectors\n            M = np.zeros((3, N))\n            M[2, :] = 1.0  # M0 is normalized to 1\n\n            # 3. Excitation pulse (90_x)\n            Rx = get_rotation_matrix('x', alpha_x)\n            M = np.einsum('ijk,jk->ik', Rx, M)\n\n            # 4. First free precession\n            phi_x = delta_omega_x * tau\n            Rz = get_rotation_matrix('z', phi_x)\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            if T2_s > 0:\n                M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 5. Refocusing pulse (180_y)\n            if pulse_type == 'conventional':\n                beta_x = beta_conv_x\n            else: # adiabatic\n                beta_x = beta_adiab_x\n            \n            Ry = get_rotation_matrix('y', beta_x)\n            M = np.einsum('ijk,jk->ik', Ry, M)\n\n            # 6. Second free precession\n            # Note: Rz is the same as before\n            M = np.einsum('ijk,jk->ik', Rz, M)\n            if T2_s > 0:\n                M[:2, :] *= np.exp(-tau / T2_s)\n\n            # 7. Compute signal and metrics\n            S_complex = M[0, :] + 1j * M[1, :]\n            \n            # Mean Normalized Magnitude\n            magnitudes = np.abs(S_complex)\n            A_bar = np.mean(magnitudes / ideal_mag) if ideal_mag > 0 else 0.0\n\n            # Mean Absolute Phase Deviation\n            phases = np.angle(S_complex)\n            mean_unit_vector = np.mean(np.exp(1j * phases))\n            phi_bar = np.angle(mean_unit_vector)\n            \n            phase_diffs = phases - phi_bar\n            wrapped_phase_diffs = np.angle(np.exp(1j * phase_diffs))\n            P_bar = np.mean(np.abs(wrapped_phase_diffs))\n\n            results.extend([A_bar, P_bar])\n\n        # Return (A_conv, P_conv, A_adiab, P_adiab) -> reorder to (A_conv, A_adiab, P_conv, P_adiab)\n        return results[0], results[2], results[1], results[3]\n\n    # Define test cases from the problem statement\n    test_cases = [\n        # (TE_ms, T2_ms, a, b_Hz)\n        (60.0, 70.0, -0.2, 80.0),\n        (80.0, 60.0, -0.5, 120.0),\n        (50.0, 100.0, 0.0, 0.0),\n    ]\n\n    L = 0.1  # meters\n    N = 101\n    s_min = 0.7\n\n    all_results = []\n    for case in test_cases:\n        TE_ms, T2_ms, a, b_Hz = case\n        metrics = run_simulation(TE_ms, T2_ms, a, b_Hz, s_min, L, N)\n        all_results.extend(metrics)\n    \n    # Format and print the final output\n    formatted_results = [f\"{val:.6f}\" for val in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}