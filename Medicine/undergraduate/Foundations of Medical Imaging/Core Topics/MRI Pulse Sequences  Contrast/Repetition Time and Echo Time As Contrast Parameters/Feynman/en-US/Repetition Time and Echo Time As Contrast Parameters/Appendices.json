{
    "hands_on_practices": [
        {
            "introduction": "This exercise demonstrates that ideal contrast weightings are an approximation and that real-world parameter choices involve compromises. By calculating the residual $T_1$ contrast that \"leaks\" into a sequence designed for Proton Density (PD) weighting, you will see quantitatively how even a long Repetition Time ($TR$) does not completely eliminate $T_1$ effects. This practice  provides a crucial lesson in understanding the practical limitations of MRI sequence design.",
            "id": "4931047",
            "problem": "A Magnetic Resonance Imaging (MRI) spin-echo acquisition at $3\\,\\mathrm{T}$ is configured to emphasize Proton Density (PD) weighting by using a long Repetition Time (TR) and a short Echo Time (TE). Consider two tissues whose proton densities and transverse relaxation times are effectively equal for PD-weighting purposes, but whose longitudinal relaxation times differ: one has $T_1=900\\,\\mathrm{ms}$ and the other has $T_1=1300\\,\\mathrm{ms}$. The sequence uses $TR=2000\\,\\mathrm{ms}$ and a near-zero $TE$.\n\nStarting from the longitudinal recovery implied by the Bloch equations and the standard steady-state spin-echo signal model, define the “percent bias in PD-weighted contrast due to residual $T_1$ differences” as the fractional spurious contrast that would appear between these two equal-PD tissues solely because of their different $T_1$ values, normalized by the fully relaxed PD signal amplitude (i.e., the asymptotic signal as $TR\\to\\infty$). Compute this bias for the given parameters. Express the final bias as a decimal (no percentage sign) and round your answer to four significant figures.",
            "solution": "The problem as stated is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. Therefore, it is deemed valid and a solution can be derived.\n\nThe signal intensity, $S$, in a standard spin-echo Magnetic Resonance Imaging (MRI) sequence is described by the signal equation, which is derived from the Bloch equations. For a given tissue, the signal is a function of its intrinsic properties—proton density ($\\rho$), longitudinal relaxation time ($T_1$), and transverse relaxation time ($T_2$)—and the sequence parameters, primarily the Repetition Time ($TR$) and Echo Time ($TE$). The equation is:\n$$S = k \\cdot \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right) \\exp\\left(-\\frac{TE}{T_2}\\right)$$\nwhere $k$ is a proportionality constant that depends on the specifics of the scanner hardware and acquisition.\n\nThe problem describes a Proton Density (PD) weighted acquisition. The goal of PD-weighting is to create an image where the contrast is dominated by differences in proton density, $\\rho$, while minimizing contrast from differences in $T_1$ and $T_2$. This is achieved by using a long $TR$ and a short $TE$. A long $TR$ allows for nearly complete recovery of longitudinal magnetization for all tissues, thus minimizing the $T_1$-dependent term $\\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right)$. A short $TE$ minimizes the signal decay due to transverse relaxation, minimizing the $T_2$-dependent term $\\exp\\left(-\\frac{TE}{T_2}\\right)$.\n\nThe problem states that a \"near-zero $TE$\" is used. Mathematically, we can analyze the effect of this by taking the limit as $TE \\to 0$:\n$$\\lim_{TE \\to 0} \\exp\\left(-\\frac{TE}{T_2}\\right) = \\exp(0) = 1$$\nThus, the $T_2$-dependent term can be neglected, and the signal equation simplifies for this acquisition to:\n$$S \\approx k \\cdot \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right)$$\nWe are given two tissues, which we can label $1$ and $2$. The problem states that their proton densities are equal, $\\rho^{(1)} = \\rho^{(2)} = \\rho$. However, their longitudinal relaxation times differ: $T_1^{(1)} = 900\\,\\mathrm{ms}$ and $T_1^{(2)} = 1300\\,\\mathrm{ms}$. The Repetition Time is given as $TR = 2000\\,\\mathrm{ms}$.\n\nThe signal intensities for the two tissues are therefore:\n$$S_1 = k \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right)\\right)$$\n$$S_2 = k \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right)\\right)$$\nThe problem asks for the \"percent bias in PD-weighted contrast due to residual $T_1$ differences,\" which is defined as the fractional spurious contrast normalized by the fully relaxed PD signal amplitude.\n\nFirst, let's determine the fully relaxed PD signal amplitude, $S_{\\text{full}}$. This represents the ideal signal where there is no $T_1$-weighting, which occurs in the limit of an infinitely long repetition time ($TR \\to \\infty$). In this limit, the longitudinal magnetization fully recovers.\n$$S_{\\text{full}} = \\lim_{TR \\to \\infty} \\left[ k \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1}\\right)\\right) \\right] = k \\rho (1 - 0) = k \\rho$$\nThis is the true proton density signal, free from $T_1$ contamination.\n\nNext, we calculate the spurious contrast, $\\Delta S$, which is the difference in signal between the two tissues that arises because their $T_1$ values are different.\n$$\\Delta S = S_1 - S_2 = k \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right)\\right) - k \\rho \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right)\\right)$$\nFactoring out $k\\rho$ and simplifying gives:\n$$\\Delta S = k \\rho \\left[ \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right)\\right) - \\left(1 - \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right)\\right) \\right]$$\n$$\\Delta S = k \\rho \\left( \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right) - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right) \\right)$$\nThe fractional bias, which we will call $B$, is the spurious contrast $\\Delta S$ normalized by the fully relaxed signal $S_{\\text{full}}$.\n$$B = \\frac{\\Delta S}{S_{\\text{full}}} = \\frac{k \\rho \\left( \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right) - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right) \\right)}{k \\rho}$$\nThe terms $k \\rho$ cancel, leaving an expression that depends only on $TR$ and the $T_1$ values:\n$$B = \\exp\\left(-\\frac{TR}{T_1^{(2)}}\\right) - \\exp\\left(-\\frac{TR}{T_1^{(1)}}\\right)$$\nNow we can substitute the given numerical values: $TR = 2000\\,\\mathrm{ms}$, $T_1^{(1)} = 900\\,\\mathrm{ms}$, and $T_1^{(2)} = 1300\\,\\mathrm{ms}$. The units of milliseconds cancel in the ratios.\n$$B = \\exp\\left(-\\frac{2000}{1300}\\right) - \\exp\\left(-\\frac{2000}{900}\\right)$$\n$$B = \\exp\\left(-\\frac{20}{13}\\right) - \\exp\\left(-\\frac{20}{9}\\right)$$\nNow, we compute the numerical value:\n$$-\\frac{20}{13} \\approx -1.53846$$\n$$-\\frac{20}{9} \\approx -2.22222$$\n$$B \\approx \\exp(-1.53846) - \\exp(-2.22222)$$\n$$B \\approx 0.214713 - 0.108365$$\n$$B \\approx 0.106348$$\nThe problem requires the answer to be rounded to four significant figures. The first four significant figures are $1$, $0$, $6$, $3$. The fifth digit is $4$, so we round down.\n$$B \\approx 0.1063$$\nThis value represents the fractional difference in signal intensity between the two tissues, normalized to the ideal proton density signal. It quantifies the residual $T_1$ contrast that persists even in a sequence designed to be PD-weighted.",
            "answer": "$$\\boxed{0.1063}$$"
        },
        {
            "introduction": "We now shift our focus to gradient-echo (GRE) sequences and the critical role of Echo Time ($TE$). This practice explores how magnetic field inhomogeneities, a common artifact source, cause signal loss that worsens with longer $TE$. By deriving the signal decay from first principles and calculating a critical $TE$ for severe signal loss, you will gain a deeper, quantitative intuition for $T_2^*$ effects and the practical constraints they impose on sequence timing .",
            "id": "4919269",
            "problem": "Consider a gradient-echo acquisition in magnetic resonance imaging (MRI) on a $3\\,\\mathrm{T}$ system where a static, susceptibility-induced field gradient along the slice-select axis $z$ can be approximated as constant over the slice, with $\\Delta B(z) = G_{\\mathrm{sus}} \\, z$. Assume a rectangular slice profile of thickness $L$ with uniform transverse magnetization at excitation, and ignore radiofrequency (RF) inhomogeneity and diffusion. Let the transverse magnetization contributions across the slice sum coherently at the echo time (TE). Use the following foundational facts only: (i) the Larmor angular frequency is proportional to the local field, $\\omega(z) = \\gamma \\, B(z)$, where $\\gamma$ is the proton gyromagnetic ratio; (ii) at time $t$, an isochromat at position $z$ accrues phase $\\phi(z,t) = \\int_{0}^{t} \\omega(z) \\, \\mathrm{d}t' = \\omega(z) \\, t$ if the field is static in time; and (iii) the received complex signal is the integral (sum) of transverse magnetization over the slice, weighted by the accrued phase.\n\nTasks:\n1) Starting from these principles, derive an analytic expression for the magnitude of the through-slice dephasing factor, i.e., the ratio $S(\\mathrm{TE})/S_{0}$, where $S(\\mathrm{TE})$ is the magnitude of the coherent sum at echo time $\\mathrm{TE}$ and $S_{0}$ is the magnitude that would be obtained in the absence of the susceptibility gradient (same slice profile and repetition time). Express your result explicitly as a function of $\\mathrm{TE}$, $G_{\\mathrm{sus}}$, and $L$. You may define standard special functions as needed.\n\n2) Define “severe signal loss” to occur at the earliest $\\mathrm{TE} > 0$ where the through-slice dephasing factor first falls to $S(\\mathrm{TE})/S_{0} = 0.2$. For a slice thickness $L = 5\\,\\mathrm{mm}$ and susceptibility gradient magnitude $G_{\\mathrm{sus}} = 300\\,\\mu\\mathrm{T/m}$, compute the echo time at which this threshold is reached. Assume the proton gyromagnetic ratio satisfies $\\gamma/(2\\pi) = 42.577 \\times 10^{6}\\,\\mathrm{Hz/T}$. State any additional simplifying assumptions you make. Express the final $\\mathrm{TE}$ in milliseconds, and round your answer to four significant figures.\n\nAssume the repetition time (TR) is sufficiently long that longitudinal recovery is effectively complete prior to each excitation, so that $S_{0}$ is independent of $\\mathrm{TE}$ and determined by equilibrium magnetization, and neglect $T_2^*$ decay mechanisms other than the specified through-slice dephasing.",
            "solution": "The problem statement is scientifically grounded, well-posed, and objective. It presents a standard model in magnetic resonance imaging (MRI) physics based on fundamental principles and provides all necessary information for a unique solution. The problem is therefore valid.\n\nThe solution is divided into two parts as requested.\n\n**Part 1: Derivation of the Through-Slice Dephasing Factor**\n\nThe problem asks for an expression for the magnitude of the through-slice dephasing factor, defined as the ratio $|S(\\mathrm{TE})|/S_{0}$, where $S(\\mathrm{TE})$ is the complex signal at echo time $\\mathrm{TE}$ and $S_{0}$ is the signal magnitude in the absence of the susceptibility gradient.\n\nWe are given that a static, susceptibility-induced magnetic field gradient exists along the slice-select axis $z$. This results in a position-dependent field perturbation $\\Delta B(z) = G_{\\mathrm{sus}} z$. The total magnetic field is $B(z) = B_{0} + \\Delta B(z)$, where $B_{0}$ is the main static magnetic field.\n\nAccording to foundational principle (i), the local Larmor angular frequency is proportional to the local field:\n$$\n\\omega(z) = \\gamma B(z) = \\gamma (B_{0} + G_{\\mathrm{sus}} z) = \\omega_{0} + \\gamma G_{\\mathrm{sus}} z\n$$\nwhere $\\omega_{0} = \\gamma B_{0}$ is the nominal Larmor frequency and $\\gamma$ is the proton gyromagnetic ratio.\n\nIn a gradient-echo sequence, imaging gradients are used to dephase and then rephase the transverse magnetization, creating an echo at time $\\mathrm{TE}$. However, this rephasing process does not cancel phase evolution due to persistent, static background field variations like $\\Delta B(z)$. Therefore, at the echo time $\\mathrm{TE}$, the net phase accrued by an isochromat at position $z$ relative to the nominal frequency $\\omega_{0}$ is due entirely to the susceptibility gradient. Using principle (ii) for this static perturbation:\n$$\n\\phi(z, \\mathrm{TE}) = (\\omega(z) - \\omega_{0}) \\mathrm{TE} = (\\gamma G_{\\mathrm{sus}} z) \\mathrm{TE}\n$$\nWe model the slice as having a rectangular profile of thickness $L$. For mathematical convenience, we center the slice at $z=0$, such that it extends from $z = -L/2$ to $z = +L/2$. The problem states that the transverse magnetization at excitation is uniform across the slice. Let this initial transverse magnetization density (per unit length along $z$) be $M_{\\perp,0}$.\n\nAccording to principle (iii), the total complex signal $S(\\mathrm{TE})$ is the coherent sum (integral) of the transverse magnetization contributions from all isochromats across the slice, each weighted by its accrued phase:\n$$\nS(\\mathrm{TE}) = \\int_{-L/2}^{L/2} M_{\\perp,0} \\exp(i \\phi(z, \\mathrm{TE})) \\, \\mathrm{d}z\n$$\nSubstituting the expression for the phase $\\phi(z, \\mathrm{TE})$:\n$$\nS(\\mathrm{TE}) = \\int_{-L/2}^{L/2} M_{\\perp,0} \\exp(i \\gamma G_{\\mathrm{sus}} z \\mathrm{TE}) \\, \\mathrm{d}z\n$$\nSince $M_{\\perp,0}$ is uniform, it can be factored out of the integral:\n$$\nS(\\mathrm{TE}) = M_{\\perp,0} \\int_{-L/2}^{L/2} \\exp(i \\gamma G_{\\mathrm{sus}} \\mathrm{TE} z) \\, \\mathrm{d}z\n$$\nLet's evaluate the integral. Let the constant factor in the exponent be $k = \\gamma G_{\\mathrm{sus}} \\mathrm{TE}$.\n$$\n\\int_{-L/2}^{L/2} \\exp(i k z) \\, \\mathrm{d}z = \\left[ \\frac{\\exp(i k z)}{ik} \\right]_{-L/2}^{L/2} = \\frac{\\exp(i k L/2) - \\exp(-i k L/2)}{ik}\n$$\nUsing the Euler identity $\\sin(x) = (\\exp(ix) - \\exp(-ix))/(2i)$, the numerator is $2i \\sin(kL/2)$. The integral becomes:\n$$\n\\frac{2i \\sin(kL/2)}{ik} = \\frac{2 \\sin(kL/2)}{k} = L \\frac{\\sin(kL/2)}{kL/2}\n$$\nThe signal is therefore:\n$$\nS(\\mathrm{TE}) = M_{\\perp,0} L \\left( \\frac{\\sin(\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}/2)}{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}/2} \\right)\n$$\nWe define the (unnormalized) cardinal sine function as $\\mathrm{sinc}(x) = \\sin(x)/x$. With this definition, the signal is:\n$$\nS(\\mathrm{TE}) = (M_{\\perp,0} L) \\cdot \\mathrm{sinc}\\left(\\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}\\right)\n$$\nThe reference signal $S_{0}$ is the magnitude that would be obtained in the absence of the susceptibility gradient, i.e., for $G_{\\mathrm{sus}}=0$. In this case, the argument of the sinc function is $0$. Since $\\lim_{x\\to0} \\mathrm{sinc}(x) = 1$, the signal is $S(G_{\\mathrm{sus}}=0) = M_{\\perp,0} L$. Thus, $S_{0} = M_{\\perp,0} L$.\n\nThe dephasing factor is the ratio of the signal magnitude $|S(\\mathrm{TE})|$ to the reference signal magnitude $S_{0}$.\n$$\n\\frac{|S(\\mathrm{TE})|}{S_{0}} = \\frac{|(M_{\\perp,0} L) \\cdot \\mathrm{sinc}\\left(\\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}\\right)|}{M_{\\perp,0} L} = \\left|\\mathrm{sinc}\\left(\\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}\\right)\\right|\n$$\nThis is the analytic expression for the magnitude of the through-slice dephasing factor.\n\n**Part 2: Calculation of Echo Time for Severe Signal Loss**\n\nSevere signal loss is defined to occur at the earliest echo time $\\mathrm{TE} > 0$ where the dephasing factor falls to $0.2$.\n$$\n\\left|\\mathrm{sinc}\\left(\\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}\\right)\\right| = 0.2\n$$\nLet the argument of the sinc function be $x = \\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}$. We are looking for the smallest positive value of $x$ that satisfies $|\\sin(x)/x| = 0.2$. The function $\\mathrm{sinc}(x)$ starts at $1$ for $x=0$ and decreases monotonically to its first zero at $x=\\pi \\approx 3.14$. In this interval, $\\mathrm{sinc}(x)$ is positive, so the condition simplifies to $\\sin(x)/x = 0.2$, or $\\sin(x) = 0.2x$.\n\nThis is a transcendental equation that must be solved numerically. We seek the smallest positive root. A numerical solution (e.g., using Newton's method or a computational solver) yields:\n$$\nx \\approx 2.595759\n$$\nNow, we solve for $\\mathrm{TE}$ from the definition of $x$:\n$$\n\\mathrm{TE} = \\frac{2x}{\\gamma G_{\\mathrm{sus}} L}\n$$\nWe are given the following values, which we express in SI units:\n-   $x \\approx 2.595759$ (dimensionless)\n-   $L = 5\\,\\mathrm{mm} = 5 \\times 10^{-3}\\,\\mathrm{m}$\n-   $G_{\\mathrm{sus}} = 300\\,\\mu\\mathrm{T/m} = 300 \\times 10^{-6}\\,\\mathrm{T/m} = 3 \\times 10^{-4}\\,\\mathrm{T/m}$\n-   $\\gamma/(2\\pi) = 42.577 \\times 10^{6}\\,\\mathrm{Hz/T}$, which implies $\\gamma = 2\\pi (42.577 \\times 10^{6})\\,\\mathrm{rad}\\cdot\\mathrm{s}^{-1}\\cdot\\mathrm{T}^{-1}$\n\nSubstituting these values into the expression for $\\mathrm{TE}$:\n$$\n\\mathrm{TE} = \\frac{2(2.595759)}{[2\\pi (42.577 \\times 10^{6}\\,\\mathrm{s^{-1}T^{-1}})] (3 \\times 10^{-4}\\,\\mathrm{T/m}) (5 \\times 10^{-3}\\,\\mathrm{m})}\n$$\n$$\n\\mathrm{TE} = \\frac{5.191518}{2\\pi \\times 42.577 \\times 10^{6} \\times (15 \\times 10^{-7})}\\,\\mathrm{s}\n$$\n$$\n\\mathrm{TE} = \\frac{5.191518}{2\\pi \\times 42.577 \\times 1.5}\\,\\mathrm{s}\n$$\n$$\n\\mathrm{TE} \\approx \\frac{5.191518}{401.273}\\,\\mathrm{s} \\approx 0.012938\\,\\mathrm{s}\n$$\nThe problem asks for the answer in milliseconds, rounded to four significant figures.\n$$\n\\mathrm{TE} \\approx 12.938\\,\\mathrm{ms}\n$$\nRounding to four significant figures gives $\\mathrm{TE} = 12.94\\,\\mathrm{ms}$.\n\nThe additional simplifying assumption made is that the first time the signal magnitude drops to $0.2$ occurs while the sinc function is still positive, allowing us to solve $\\mathrm{sinc}(x)=0.2$ instead of $\\mathrm{sinc}(x)=-0.2$. This is justified as we seek the earliest $\\mathrm{TE} > 0$.",
            "answer": "$$\\boxed{\\begin{pmatrix} \\left|\\mathrm{sinc}\\left(\\frac{\\gamma G_{\\mathrm{sus}} L \\mathrm{TE}}{2}\\right)\\right| & 12.94 \\end{pmatrix}}$$"
        },
        {
            "introduction": "This final practice moves from analyzing individual effects to solving a holistic design problem, a task central to applied MRI physics. You are challenged to synthesize your knowledge of the spin-echo signal equation by developing a numerical optimizer that finds the ideal Repetition Time ($TR$) and Echo Time ($TE$). The goal is to maximize the separability of different tissues, bridging the gap from theoretical formulas to a powerful, practical application in medical imaging .",
            "id": "4919295",
            "problem": "You are asked to design and implement a numerical optimizer for Magnetic Resonance Imaging (MRI) contrast parameters, specifically Repetition Time (TR) and Echo Time (TE), to aid classification between three tissues by maximizing the minimum pairwise Contrast-to-Noise Ratio (CNR). The objective is to derive the necessary expressions from first principles and then compute the optimal $\\mathrm{TR}$ and $\\mathrm{TE}$ over specified ranges for a set of test cases. Your program must produce a single line of output with all test case results aggregated.\n\nStart from the following foundational bases:\n- The Bloch equation implies exponential processes for the longitudinal recovery and transverse decay of magnetization. The longitudinal magnetization recovers toward equilibrium with time constant $T_1$ and the transverse magnetization decays with time constant $T_2$.\n- Consider an ideal spin-echo experiment using a perfect $90^\\circ$ excitation pulse followed by a $180^\\circ$ refocusing pulse. The measured echo amplitude is proportional to the transverse magnetization present at the echo time.\n- Proton density (relative spin density), denoted $M_0$, scales the achievable magnetization linearly.\n- Noise is modeled as Gaussian with standard deviation $\\sigma$ and is independent of $\\mathrm{TR}$ and $\\mathrm{TE}$.\n\nUsing these bases, derive from first principles:\n1. An expression for the steady-state longitudinal magnetization immediately before excitation at time $\\mathrm{TR}$ starting from zero transverse magnetization after the previous readout.\n2. An expression for the spin-echo signal amplitude at time $\\mathrm{TE}$ as a function of $\\mathrm{TR}$, $\\mathrm{TE}$, $M_0$, $T_1$, and $T_2$ for a single tissue under the ideal assumptions stated.\n3. A definition of pairwise CNR between two tissues $i$ and $j$ in terms of their signal amplitudes and the noise standard deviation $\\sigma$.\n4. A scalar objective function over $(\\mathrm{TR}, \\mathrm{TE})$ that equals the minimum of the three pairwise CNRs among the three tissues, to promote balanced separability.\n\nThen implement a numerical search on a discretized grid of $(\\mathrm{TR}, \\mathrm{TE})$ values, enforcing the physically meaningful constraint $ \\mathrm{TE} \\le \\mathrm{TR} $. For each grid point, compute the minimum pairwise CNR and select the $(\\mathrm{TR}, \\mathrm{TE})$ that maximizes this minimum. If there are multiple $(\\mathrm{TR}, \\mathrm{TE})$ pairs that achieve the same maximal minimum CNR within the grid, choose the smallest $\\mathrm{TR}$; if still tied, choose the smallest $\\mathrm{TE}$.\n\nUnits and output requirements:\n- Use milliseconds for all times: $\\mathrm{TR}$, $\\mathrm{TE}$, $T_1$, and $T_2$ are all in $\\mathrm{ms}$.\n- Proton density $M_0$ is dimensionless and $\\sigma$ is in arbitrary signal units consistent with $M_0$.\n- Your program must print a single line containing a list of results for the test suite, where each result is formatted as an inner list $[\\mathrm{TR}, \\mathrm{TE}, \\text{minCNR}]$ with $\\mathrm{TR}$ and $\\mathrm{TE}$ as integers in $\\mathrm{ms}$ and $\\text{minCNR}$ as a decimal rounded to six places. The entire output must be a single comma-separated list of these inner lists enclosed in square brackets, for example $[[300,20,0.123456],[\\dots]]$.\n\nTest suite:\nCompute the optimal $(\\mathrm{TR}, \\mathrm{TE})$ and the maximal minimum pairwise CNR for each of the following cases. In all cases, adhere strictly to the constraint $ \\mathrm{TE} \\le \\mathrm{TR} $. For each case, the grid is defined by uniform steps.\n\n- Case $1$ (general brain tissues, happy path):\n  - Tissue $1$ (white matter): $M_0 = 1.0$, $T_1 = 800\\,\\mathrm{ms}$, $T_2 = 80\\,\\mathrm{ms}$.\n  - Tissue $2$ (gray matter): $M_0 = 1.0$, $T_1 = 1200\\,\\mathrm{ms}$, $T_2 = 100\\,\\mathrm{ms}$.\n  - Tissue $3$ (cerebrospinal fluid): $M_0 = 1.0$, $T_1 = 2500\\,\\mathrm{ms}$, $T_2 = 2000\\,\\mathrm{ms}$.\n  - $\\sigma = 1.0$.\n  - $\\mathrm{TR}$ range: $[300, 3000]\\,\\mathrm{ms}$ with step $5\\,\\mathrm{ms}$.\n  - $\\mathrm{TE}$ range: $[10, 120]\\,\\mathrm{ms}$ with step $5\\,\\mathrm{ms}$.\n\n- Case $2$ (near-degenerate pair, challenging separability):\n  - Tissue $1$: $M_0 = 1.0$, $T_1 = 900\\,\\mathrm{ms}$, $T_2 = 90\\,\\mathrm{ms}$.\n  - Tissue $2$: $M_0 = 1.0$, $T_1 = 900\\,\\mathrm{ms}$, $T_2 = 90\\,\\mathrm{ms}$.\n  - Tissue $3$: $M_0 = 1.0$, $T_1 = 2000\\,\\mathrm{ms}$, $T_2 = 200\\,\\mathrm{ms}$.\n  - $\\sigma = 1.0$.\n  - $\\mathrm{TR}$ range: $[400, 2000]\\,\\mathrm{ms}$ with step $10\\,\\mathrm{ms}$.\n  - $\\mathrm{TE}$ range: $[10, 100]\\,\\mathrm{ms}$ with step $10\\,\\mathrm{ms}$.\n\n- Case $3$ (boundary-dominant $\\mathrm{TE}$, constraint active):\n  - Tissue $1$ (muscle): $M_0 = 0.9$, $T_1 = 1000\\,\\mathrm{ms}$, $T_2 = 50\\,\\mathrm{ms}$.\n  - Tissue $2$ (fat): $M_0 = 1.1$, $T_1 = 350\\,\\mathrm{ms}$, $T_2 = 70\\,\\mathrm{ms}$.\n  - Tissue $3$ (liver): $M_0 = 1.0$, $T_1 = 700\\,\\mathrm{ms}$, $T_2 = 60\\,\\mathrm{ms}$.\n  - $\\sigma = 0.8$.\n  - $\\mathrm{TR}$ range: $[100, 200]\\,\\mathrm{ms}$ with step $5\\,\\mathrm{ms}$.\n  - $\\mathrm{TE}$ range: $[80, 220]\\,\\mathrm{ms}$ with step $5\\,\\mathrm{ms}$.\n\n- Case $4$ (high-noise environment, robustness test):\n  - Tissue $1$ (cartilage): $M_0 = 1.0$, $T_1 = 1200\\,\\mathrm{ms}$, $T_2 = 40\\,\\mathrm{ms}$.\n  - Tissue $2$ (tendon): $M_0 = 0.8$, $T_1 = 1000\\,\\mathrm{ms}$, $T_2 = 30\\,\\mathrm{ms}$.\n  - Tissue $3$ (fluid): $M_0 = 1.0$, $T_1 = 2500\\,\\mathrm{ms}$, $T_2 = 1500\\,\\mathrm{ms}$.\n  - $\\sigma = 5.0$.\n  - $\\mathrm{TR}$ range: $[500, 2500]\\,\\mathrm{ms}$ with step $25\\,\\mathrm{ms}$.\n  - $\\mathrm{TE}$ range: $[10, 200]\\,\\mathrm{ms}$ with step $10\\,\\mathrm{ms}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each inner entry is of the form $[\\mathrm{TR},\\mathrm{TE},\\text{minCNR}]$ as specified above.",
            "solution": "The task requires optimizing MRI contrast parameters Repetition Time (TR) and Echo Time (TE) to maximize the minimum pairwise Contrast-to-Noise Ratio (CNR) among three tissues. The derivation and algorithm rely on fundamental physics underlying nuclear magnetic resonance and the Bloch equation. The following provides the derivation and the algorithmic design.\n\nWe begin with the physical principles. In an MRI spin-echo sequence with an ideal $90^\\circ$ excitation followed by a $180^\\circ$ refocusing, two exponential processes govern the magnetization:\n- Longitudinal recovery toward equilibrium is characterized by the time constant $T_1$: the longitudinal magnetization component increases after excitation as an exponential function approaching $M_0$, the equilibrium magnetization proportional to proton density.\n- Transverse decay is characterized by the time constant $T_2$: after excitation, the transverse magnetization decays exponentially due to dephasing processes, with refocusing recovering the phase coherence at an echo time $\\mathrm{TE}$.\n\nFrom the Bloch equation and steady-state considerations in a repeated spin-echo sequence, immediately before the $90^\\circ$ excitation at time $\\mathrm{TR}$ after the previous readout, the longitudinal magnetization magnitude is recovered toward $M_0$ according to an exponential with time constant $T_1$. After a perfect $90^\\circ$ pulse, the available transverse magnetization is proportional to this recovered longitudinal magnetization. The transverse magnetization then decays between excitation and the echo acquisition with time constant $T_2$, so the measured spin-echo signal amplitude incorporates an additional exponential factor.\n\nThus, for a single tissue characterized by parameters $M_0$, $T_1$, and $T_2$, the spin-echo signal amplitude as a function of $\\mathrm{TR}$ and $\\mathrm{TE}$ can be derived under ideal assumptions as a product of the recovered longitudinal term and the transverse decay term. Denote the signal for tissue $i$ as $S_i(\\mathrm{TR}, \\mathrm{TE})$. Noise is modeled as additive Gaussian with standard deviation $\\sigma$ shared across tissues for a given acquisition.\n\nFor classification between tissues, the pairwise Contrast-to-Noise Ratio between tissue $i$ and tissue $j$ is defined as the absolute difference of their mean signal amplitudes divided by the noise standard deviation. Denote this by $\\mathrm{CNR}_{ij}(\\mathrm{TR}, \\mathrm{TE})$. The optimization objective is to choose $\\mathrm{TR}$ and $\\mathrm{TE}$ that maximize the minimum of the three pairwise CNR values among three tissues, so that the weakest separation is as strong as possible.\n\nFormally, with three tissues labeled $1$, $2$, and $3$, the optimization problem is:\n$$\n\\max_{\\mathrm{TR}, \\mathrm{TE}} \\; J(\\mathrm{TR}, \\mathrm{TE}) \\quad \\text{subject to } \\mathrm{TE} \\le \\mathrm{TR}, \\; \\mathrm{TR} \\in [\\mathrm{TR}_{\\min}, \\mathrm{TR}_{\\max}], \\; \\mathrm{TE} \\in [\\mathrm{TE}_{\\min}, \\mathrm{TE}_{\\max}],\n$$\nwhere\n$$\nJ(\\mathrm{TR}, \\mathrm{TE}) = \\min\\left\\{ \\mathrm{CNR}_{12}(\\mathrm{TR}, \\mathrm{TE}), \\; \\mathrm{CNR}_{13}(\\mathrm{TR}, \\mathrm{TE}), \\; \\mathrm{CNR}_{23}(\\mathrm{TR}, \\mathrm{TE}) \\right\\}.\n$$\n\nDerivation of $S_i(\\mathrm{TR}, \\mathrm{TE})$:\n- The longitudinal magnetization just prior to excitation at time $\\mathrm{TR}$ after the previous readout follows exponential recovery toward $M_0$ with time constant $T_1$, and under steady-state conditions with full spoiling between cycles, its magnitude is proportional to $M_0$ times $(1 - e^{-\\mathrm{TR}/T_1})$.\n- The transverse magnetization at the echo time $\\mathrm{TE}$ decays exponentially from its initial value with time constant $T_2$, yielding a factor of $e^{-\\mathrm{TE}/T_2}$.\n\nCombining these factors under a perfect $90^\\circ$ excitation (unity transverse conversion) and ideal refocusing yields:\n$$\nS_i(\\mathrm{TR}, \\mathrm{TE}) = M_{0,i} \\left( 1 - e^{-\\mathrm{TR}/T_{1,i}} \\right) e^{-\\mathrm{TE}/T_{2,i}}.\n$$\n\nThe pairwise CNR between tissues $i$ and $j$ is:\n$$\n\\mathrm{CNR}_{ij}(\\mathrm{TR}, \\mathrm{TE}) = \\frac{\\left| S_i(\\mathrm{TR}, \\mathrm{TE}) - S_j(\\mathrm{TR}, \\mathrm{TE}) \\right|}{\\sigma}.\n$$\n\nAlgorithmic design:\n- For each test case, construct discrete grids for $\\mathrm{TR}$ and $\\mathrm{TE}$ using the specified ranges and steps. All times are in milliseconds, and consistency is maintained by using the same unit for $T_1$ and $T_2$.\n- Enforce the constraint $\\mathrm{TE} \\le \\mathrm{TR}$ by masking grid points where the constraint is violated.\n- For each tissue, compute $S_i(\\mathrm{TR}, \\mathrm{TE})$ over the grid using the derived formula.\n- Compute the three pairwise $\\mathrm{CNR}_{ij}(\\mathrm{TR}, \\mathrm{TE})$ arrays and then compute $J(\\mathrm{TR}, \\mathrm{TE})$ as their pointwise minimum.\n- Set $J(\\mathrm{TR}, \\mathrm{TE})$ to a sentinel low value (e.g., $-\\infty$) or mask it out where $\\mathrm{TE} > \\mathrm{TR}$.\n- Identify the grid point that maximizes $J(\\mathrm{TR}, \\mathrm{TE})$. If multiple grid points achieve the same maximal value within numerical precision, apply the prescribed tie-breaking: choose the smallest $\\mathrm{TR}$; if still tied, choose the smallest $\\mathrm{TE}$.\n- Report the selected $\\mathrm{TR}$ and $\\mathrm{TE}$ as integers in milliseconds and the maximal minimum CNR rounded to six decimal places.\n\nComputational considerations:\n- The signals are smooth functions of $\\mathrm{TR}$ and $\\mathrm{TE}$, so grid-based search with the provided steps is adequate for deterministic outputs at the advanced undergraduate level without requiring continuous optimization.\n- Broadcasting with numerical arrays can efficiently compute the signal and CNR over the full grid.\n- All test cases are scientifically plausible and vary in difficulty: Case $1$ is a typical brain imaging scenario; Case $2$ has a near-degenerate pair challenging separability; Case $3$ activates the $\\mathrm{TE} \\le \\mathrm{TR}$ constraint strongly; Case $4$ tests robustness under high noise.\n\nThe program implements the above and prints a single line containing a list of inner lists $[\\mathrm{TR}, \\mathrm{TE}, \\text{minCNR}]$ for each case, with $\\mathrm{TR}$ and $\\mathrm{TE}$ in milliseconds and $\\text{minCNR}$ rounded to six decimals.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef optimize_tr_te(tissues, tr_range, tr_step, te_range, te_step, sigma):\n    \"\"\"\n    Optimize TR and TE to maximize the minimum pairwise CNR among three tissues.\n\n    Parameters:\n        tissues: list of dicts with keys 'M0', 'T1', 'T2' (all times in ms).\n        tr_range: (tr_min, tr_max) in ms.\n        tr_step: step for TR in ms.\n        te_range: (te_min, te_max) in ms.\n        te_step: step for TE in ms.\n        sigma: noise standard deviation (arbitrary units consistent with M0).\n\n    Returns:\n        (TR_opt, TE_opt, max_min_cnr) with TR_opt and TE_opt as ints (ms),\n        max_min_cnr as float.\n    \"\"\"\n    tr_vals = np.arange(tr_range[0], tr_range[1] + tr_step, tr_step, dtype=float)\n    te_vals = np.arange(te_range[0], te_range[1] + te_step, te_step, dtype=float)\n\n    # Create grid\n    TR_grid, TE_grid = np.meshgrid(tr_vals, te_vals, indexing='ij')  # shapes: (nTR, nTE)\n\n    # Compute signal for each tissue over the grid\n    signals = []\n    for tissue in tissues:\n        M0 = tissue['M0']\n        T1 = tissue['T1']\n        T2 = tissue['T2']\n        # Signal model: S = M0 * (1 - exp(-TR/T1)) * exp(-TE/T2)\n        S = M0 * (1.0 - np.exp(-TR_grid / T1)) * np.exp(-TE_grid / T2)\n        signals.append(S)\n\n    # Compute pairwise CNRs: |S_i - S_j| / sigma\n    pairwise_cnrs = []\n    n_tissues = len(signals)\n    for i in range(n_tissues):\n        for j in range(i + 1, n_tissues):\n            cnr = np.abs(signals[i] - signals[j]) / sigma\n            pairwise_cnrs.append(cnr)\n\n    # Minimum pairwise CNR over the three pairs\n    min_pairwise_cnr = np.minimum.reduce(pairwise_cnrs)\n\n    # Enforce TE <= TR by masking invalid points\n    valid_mask = TE_grid <= TR_grid\n    # Set invalid points to -inf to exclude them from maximization\n    min_pairwise_cnr_masked = np.where(valid_mask, min_pairwise_cnr, -np.inf)\n\n    # Find maximal minimum CNR\n    max_val = np.max(min_pairwise_cnr_masked)\n\n    # Tie-breaking: smallest TR, then smallest TE among points achieving max_val\n    # Build mask of points achieving max_val (within exact equality)\n    max_mask = (min_pairwise_cnr_masked == max_val)\n    # If no valid points (shouldn't happen), default to first grid element\n    if not np.any(max_mask):\n        tr_opt = int(tr_vals[0])\n        te_opt = int(te_vals[0])\n        return tr_opt, te_opt, float(-np.inf)\n\n    # Extract indices of max points\n    max_indices = np.argwhere(max_mask)\n    # Sort indices by TR (row index), then TE (col index)\n    max_indices_sorted = max_indices[np.lexsort((max_indices[:,1], max_indices[:,0]))]\n    i_opt, j_opt = max_indices_sorted[0]\n    tr_opt = int(round(TR_grid[i_opt, j_opt]))\n    te_opt = int(round(TE_grid[i_opt, j_opt]))\n    max_min_cnr = float(max_val)\n\n    return tr_opt, te_opt, max_min_cnr\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: general brain tissues, happy path\n        (\n            [\n                {'M0': 1.0, 'T1': 800.0, 'T2': 80.0},    # WM\n                {'M0': 1.0, 'T1': 1200.0, 'T2': 100.0},  # GM\n                {'M0': 1.0, 'T1': 2500.0, 'T2': 2000.0}  # CSF\n            ],\n            (300.0, 3000.0), 5.0,\n            (10.0, 120.0), 5.0,\n            1.0\n        ),\n        # Case 2: near-degenerate pair\n        (\n            [\n                {'M0': 1.0, 'T1': 900.0, 'T2': 90.0},\n                {'M0': 1.0, 'T1': 900.0, 'T2': 90.0},\n                {'M0': 1.0, 'T1': 2000.0, 'T2': 200.0}\n            ],\n            (400.0, 2000.0), 10.0,\n            (10.0, 100.0), 10.0,\n            1.0\n        ),\n        # Case 3: boundary-dominant TE, constraint active\n        (\n            [\n                {'M0': 0.9, 'T1': 1000.0, 'T2': 50.0},  # muscle\n                {'M0': 1.1, 'T1': 350.0, 'T2': 70.0},   # fat\n                {'M0': 1.0, 'T1': 700.0, 'T2': 60.0}    # liver\n            ],\n            (100.0, 200.0), 5.0,\n            (80.0, 220.0), 5.0,\n            0.8\n        ),\n        # Case 4: high-noise environment, robustness test\n        (\n            [\n                {'M0': 1.0, 'T1': 1200.0, 'T2': 40.0},   # cartilage\n                {'M0': 0.8, 'T1': 1000.0, 'T2': 30.0},   # tendon\n                {'M0': 1.0, 'T1': 2500.0, 'T2': 1500.0}  # fluid\n            ],\n            (500.0, 2500.0), 25.0,\n            (10.0, 200.0), 10.0,\n            5.0\n        ),\n    ]\n\n    results = []\n    for tissues, tr_rng, tr_step, te_rng, te_step, sigma in test_cases:\n        tr_opt, te_opt, max_min_cnr = optimize_tr_te(\n            tissues, tr_rng, tr_step, te_rng, te_step, sigma\n        )\n        # Format min CNR to 6 decimal places\n        results.append(f\"[{tr_opt},{te_opt},{max_min_cnr:.6f}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}