{
    "hands_on_practices": [
        {
            "introduction": "Understanding the performance of a gamma camera begins with its most fundamental characteristic: spatial resolution. This practice guides you through the process of deriving the geometric resolution from first principles. By applying simple geometric reasoning based on similar triangles, you will develop a model that connects a collimator's physical dimensions—its hole diameter ($d$) and length ($L$)—to the resulting image blur at a specific distance, providing a foundational understanding of collimator design .",
            "id": "4887721",
            "problem": "A parallel-hole collimator in a gamma camera can be idealized as an array of straight, non-diverging channels of physical length $L$ and hole diameter $d$, with negligible septal penetration and negligible septal thickness so that the effective length equals the physical length. Consider the geometric full-width blur at half-maximum (FWHM) at an object plane located a distance $z$ in front of the collimator face. Using first-principles geometric reasoning based on similar triangles that relate the accepted ray envelope to the channel geometry, derive an expression for the geometric blur $R_g(z)$ as a function of $d$, $L$, and $z$. Then use this expression to determine the equality condition for two different parallel-hole designs, $(d_1,L_1)$ and $(d_2,L_2)$, to produce the same geometric FWHM at the same object distance $z$.\n\nNow, let $z=10\\,\\mathrm{cm}$, $d_1=1.5\\,\\mathrm{mm}$, and $L_1=25\\,\\mathrm{mm}$. Using the equality condition you derived, eliminate the common resolution and solve explicitly for $L_2$ as a function of $d_2$ so that the design $(d_2,L_2)$ yields the same geometric FWHM at $z$ as $(d_1,L_1)$. Express your final functional expression $L_2(d_2)$ in millimeters. No rounding is required; give your answer in exact closed form.\n\nIn your solution, briefly interpret the family of equivalent-resolution pairs $(d_2,L_2)$ you obtained in terms of how $d_2$ and $L_2$ co-vary to preserve geometric resolution.",
            "solution": "The problem is validated as scientifically grounded, well-posed, objective, and self-contained. It is a standard problem in the physics of medical imaging, based on an idealized geometric model of a parallel-hole collimator. All necessary parameters and assumptions are provided. I will now proceed with the solution.\n\nThe problem asks for a multi-part derivation and calculation concerning the geometric resolution of a parallel-hole gamma camera collimator.\n\nFirst, we must derive the expression for the geometric full-width blur at half-maximum, $R_g(z)$, at a distance $z$ from the collimator face. The collimator is defined by channels of diameter $d$ and length $L$. The problem specifies using a first-principles geometric argument based on similar triangles.\n\nA standard and direct approach is to consider the Point Spread Function (PSF) for a detector with perfect intrinsic spatial resolution (i.e., a single point detector element). The FWHM of this PSF is the geometric resolution $R_g(z)$. We model a single channel of the collimator. Let the collimator face be at the plane $z=0$ and the detector crystal be at the plane $z=-L$. The source object is in a plane at $z$. Let a point detector element be located at the origin $(0, -L)$ on the crystal, centered at the exit of a channel. This detector element can \"see\" the source plane through the entrance aperture of the channel, which is a circle of diameter $d$ centered at the origin in the $z=0$ plane.\n\nWe can construct two similar triangles in a 2D cross-sectional view.\nTriangle 1 is formed by the point detector at $(0, -L)$ and the diameter of the channel entrance, which lies on the x-axis from $x=-d/2$ to $x=d/2$. The base of this triangle is $d$ and its height is $L$.\nTriangle 2 is formed by the same point detector at $(0, -L)$ and its field of view on the source plane at distance $z$. Let the width of this field of view be $R_g$. The base of this larger triangle is $R_g$ and its height is $L+z$.\n\nBy the property of similar triangles, the ratio of the base to the height is the same for both triangles:\n$$\n\\frac{R_g}{L+z} = \\frac{d}{L}\n$$\nSolving for $R_g$ gives the expression for the geometric blur as a function of $d$, $L$, and $z$:\n$$\nR_g(z) = d \\frac{L+z}{L} = d \\left(1 + \\frac{z}{L}\\right)\n$$\nThis expression represents the FWHM of the PSF for a point source, under the given idealizations.\n\nNext, we must find the equality condition for two different parallel-hole designs, $(d_1, L_1)$ and $(d_2, L_2)$, to produce the same geometric FWHM, $R_g$, at the same object distance $z$. We set their respective resolutions equal:\n$$\nR_{g1}(z) = R_{g2}(z)\n$$\n$$\nd_1 \\frac{L_1+z}{L_1} = d_2 \\frac{L_2+z}{L_2}\n$$\nThis equation, which can also be written as $d_1(1 + z/L_1) = d_2(1 + z/L_2)$, is the required equality condition.\n\nNow, we are given specific values for the first design and the imaging distance: $z=10\\,\\mathrm{cm}$, $d_1=1.5\\,\\mathrm{mm}$, and $L_1=25\\,\\mathrm{mm}$. We must solve for $L_2$ as a function of $d_2$. First, we ensure all units are consistent. We will use millimeters (mm) for all lengths. Thus, $z = 10\\,\\mathrm{cm} = 100\\,\\mathrm{mm}$.\n\nLet's calculate the specific geometric resolution $R_g$ for the first design at the given distance $z$:\n$$\nR_g = d_1 \\frac{L_1+z}{L_1} = (1.5\\,\\mathrm{mm}) \\frac{25\\,\\mathrm{mm} + 100\\,\\mathrm{mm}}{25\\,\\mathrm{mm}} = 1.5 \\times \\frac{125}{25} = 1.5 \\times 5 = 7.5\\,\\mathrm{mm}\n$$\nFor the second design to have the same resolution, we must have:\n$$\nR_g = d_2 \\frac{L_2+z}{L_2} = 7.5\\,\\mathrm{mm}\n$$\nWe now solve this equation for $L_2$ as a function of $d_2$, keeping $z=100\\,\\mathrm{mm}$ and $R_g=7.5\\,\\mathrm{mm}$ as constants.\n$$\n7.5 = d_2 \\left(1 + \\frac{100}{L_2}\\right)\n$$\n$$\n\\frac{7.5}{d_2} = 1 + \\frac{100}{L_2}\n$$\n$$\n\\frac{7.5}{d_2} - 1 = \\frac{100}{L_2}\n$$\n$$\n\\frac{7.5 - d_2}{d_2} = \\frac{100}{L_2}\n$$\nInverting both sides gives:\n$$\n\\frac{d_2}{7.5 - d_2} = \\frac{L_2}{100}\n$$\nFinally, solving for $L_2$ yields the functional expression $L_2(d_2)$:\n$$\nL_2(d_2) = 100 \\frac{d_2}{7.5 - d_2}\n$$\nThis expression gives the required channel length $L_2$ (in mm) for a given channel diameter $d_2$ (in mm) to match the geometric resolution of the first design.\n\nFor this expression to be physically meaningful, $L_2$ must be positive. Since $d_2$ (a diameter) must also be positive, the denominator must be positive: $7.5 - d_2 > 0$, which implies $0  d_2  7.5\\,\\mathrm{mm}$.\n\nFinally, we interpret the family of equivalent-resolution pairs $(d_2, L_2)$. The relationship $L_2(d_2) = 100 \\frac{d_2}{7.5 - d_2}$ shows that as the hole diameter $d_2$ increases, the denominator decreases, and the numerator increases. Both effects cause $L_2$ to increase. Specifically, as $d_2 \\to 7.5\\,\\mathrm{mm}$ from below, $L_2 \\to \\infty$. This co-variance is central to the resolution-sensitivity trade-off in collimator design. The geometric resolution $R_g(z)$ has two conceptual components: an intrinsic blur due to the hole diameter $d$, and a distance-dependent blur that is proportional to $d z/L$. To maintain a constant resolution $R_g$, if one increases the hole diameter $d_2$, the intrinsic blur becomes worse. This must be counteracted by making the collimator channel much longer (increasing $L_2$) to reduce the acceptance angle for photons (proportional to $d_2/L_2$), thereby mitigating the distance-dependent blur.",
            "answer": "$$\n\\boxed{L_2(d_2) = 100 \\frac{d_2}{7.5 - d_2}}\n$$"
        },
        {
            "introduction": "In nuclear medicine, there is an inescapable trade-off between image sharpness (resolution) and the number of photons collected (sensitivity). This exercise explores the direct clinical consequences of this principle. You will analyze a scenario where switching to a different collimator changes the system's sensitivity, and then calculate the necessary adjustment in scan time to preserve the statistical quality of the image. This problem  illustrates how design choices directly impact practical imaging protocols and patient throughput.",
            "id": "4887718",
            "problem": "A planar gamma camera protocol is being modified by replacing a Low-Energy High-Resolution (LEHR) collimator with a Medium-Energy General-Purpose (MEGP) collimator. Under identical source distribution, energy window, and detector settings, the measured system sensitivity with the LEHR collimator is $88.0$ counts per second per megabecquerel (counts per second (cps) per megabecquerel (MBq)), and with the MEGP collimator it is $57.0$ cps/MBq. The current protocol uses an acquisition time of $7.50$ minutes per view with the LEHR collimator.\n\nAssume the following fundamental conditions:\n- Detected photon counts follow a Poisson process.\n- The coefficient of variation (defined as standard deviation divided by mean) of the counts in a pixel is given by $1/\\sqrt{N}$, where $N$ is the expected number of detected counts contributing to that pixel.\n- Deadtime losses are negligible, and all factors other than the collimator sensitivity remain unchanged.\n- The expected number of detected counts is proportional to both the sensitivity and the acquisition time for a fixed activity distribution.\n\nUsing only these premises, determine the acquisition time per view required with the MEGP collimator to achieve the same coefficient of variation in the reconstructed image as with the LEHR collimator. Express your final answer in minutes and round your result to three significant figures.",
            "solution": "The problem has been validated and is determined to be a well-posed, scientifically grounded problem in medical imaging physics. All givens are consistent and sufficient for a unique solution.\n\nThe objective is to determine the acquisition time per view, denoted as $T_{MEGP}$, for the Medium-Energy General-Purpose (MEGP) collimator, such that the resulting image quality, as measured by the coefficient of variation, is identical to that achieved with the Low-Energy High-Resolution (LEHR) collimator.\n\nLet the variables for the LEHR collimator be denoted with the subscript $LEHR$, and for the MEGP collimator with the subscript $MEGP$. The provided data points are:\n- System sensitivity with the LEHR collimator: $S_{LEHR} = 88.0$ counts per second per megabecquerel (cps/MBq).\n- System sensitivity with the MEGP collimator: $S_{MEGP} = 57.0$ cps/MBq.\n- Acquisition time with the LEHR collimator: $T_{LEHR} = 7.50$ minutes.\n\nThe fundamental premises are:\n1. Detected photon counts, $N$, follow a Poisson process. For a Poisson distribution, the variance is equal to the mean, $\\sigma^2 = \\mu$. The standard deviation is thus $\\sigma = \\sqrt{\\mu}$.\n2. The coefficient of variation, $CV$, is defined as the ratio of the standard deviation to the mean: $CV = \\sigma/\\mu$. Given that the expected number of counts is $N$, we have $\\mu = N$ and $\\sigma = \\sqrt{N}$. Therefore, the coefficient of variation is correctly given as $CV = \\sqrt{N}/N = 1/\\sqrt{N}$.\n3. The expected number of counts, $N$, is proportional to the system sensitivity, $S$, and the acquisition time, $T$. We can express this relationship as $N = k \\cdot A \\cdot S \\cdot T$, where $A$ is the activity of the source distribution and $k$ is a proportionality constant that includes all other factors (e.g., geometric efficiency, detector intrinsic efficiency). The problem states that the source distribution and all other factors are identical, so the product $k \\cdot A$ is a constant for both measurements.\n\nThe requirement is that the coefficient of variation be the same for both protocols:\n$$CV_{LEHR} = CV_{MEGP}$$\n\nSubstituting the expression for the coefficient of variation, we get:\n$$\\frac{1}{\\sqrt{N_{LEHR}}} = \\frac{1}{\\sqrt{N_{MEGP}}}$$\n\nSquaring both sides and taking the reciprocal yields the core condition: the total number of detected counts must be equal for both acquisitions.\n$$N_{LEHR} = N_{MEGP}$$\n\nNow we use the proportionality of counts to sensitivity and time. Let the constant of proportionality be $C = k \\cdot A$.\n$$N_{LEHR} = C \\cdot S_{LEHR} \\cdot T'_{LEHR}$$\n$$N_{MEGP} = C \\cdot S_{MEGP} \\cdot T'_{MEGP}$$\nHere, $T'$ must be the time in seconds to match the units of sensitivity (cps). However, since we will form a ratio, the units of time will cancel as long as they are consistent. We can proceed using minutes for time, as the conversion factor would cancel. Let $T$ be time in minutes.\n$$N_{LEHR} \\propto S_{LEHR} \\cdot T_{LEHR}$$\n$$N_{MEGP} \\propto S_{MEGP} \\cdot T_{MEGP}$$\n\nEquating the counts gives:\n$$S_{LEHR} \\cdot T_{LEHR} = S_{MEGP} \\cdot T_{MEGP}$$\n\nWe are asked to find $T_{MEGP}$. Rearranging the equation to solve for $T_{MEGP}$:\n$$T_{MEGP} = T_{LEHR} \\left( \\frac{S_{LEHR}}{S_{MEGP}} \\right)$$\n\nNow, we substitute the given numerical values:\n$$T_{MEGP} = (7.50 \\text{ min}) \\left( \\frac{88.0 \\text{ cps/MBq}}{57.0 \\text{ cps/MBq}} \\right)$$\nThe units of sensitivity (cps/MBq) cancel, leaving the result in minutes.\n$$T_{MEGP} = 7.50 \\times \\frac{88.0}{57.0} \\text{ min}$$\n$$T_{MEGP} \\approx 7.50 \\times 1.5438596... \\text{ min}$$\n$$T_{MEGP} \\approx 11.578947... \\text{ min}$$\n\nThe problem requires the final answer to be rounded to three significant figures. The first three significant figures are $1$, $1$, and $5$. The fourth digit is $7$, which is greater than or equal to $5$, so we round up the third digit.\n$$T_{MEGP} \\approx 11.6 \\text{ min}$$\nThis result is physically expected. The MEGP collimator has a lower sensitivity ($57.0$) than the LEHR collimator ($88.0$). To collect the same number of photons and thus achieve the same statistical quality (noise level), the acquisition time must be increased.",
            "answer": "$$\\boxed{11.6}$$"
        },
        {
            "introduction": "Theoretical models provide the framework for understanding a system, but they must be verified with real-world data. This practice puts you in the role of a medical physicist tasked with characterizing a collimator's performance. Starting with simulated measurement data, you will apply signal processing techniques to extract the resolution and then use linear regression to validate the geometric model explored in a previous exercise . This hands-on coding problem bridges the gap between abstract theory and the practical, data-driven validation of imaging hardware .",
            "id": "4887703",
            "problem": "A gamma camera with a parallel-hole collimator produces a spatial blur that increases with the distance from the collimator face. Consider the one-dimensional edge-spread function (ESF), defined as the detected count profile across a sharp activity edge, and the corresponding line-spread function (LSF), defined as the spatial derivative of the ESF. The geometric resolution at distance $z$, denoted $R_g(z)$, is operationally defined here as the full width at half maximum (FWHM) of the LSF. The foundational base of this problem is the geometric projection of the collimator holes and the one-dimensional signal analysis linking the ESF, the LSF, and the FWHM. Your task is to infer $R_g(z)$ from measured ESFs, fit a linear model $R_g(z) = a z + b$, and validate whether the linear dependence predicted by the geometric model is consistent with the physical collimator parameters.\n\nYou are given three test cases. For each test case, the collimator has a specified effective hole diameter $d$ (in $\\mathrm{mm}$) and hole length $L$ (in $\\mathrm{mm}$). For each test case, ESFs are measured at multiple source-to-collimator distances $z$ (in $\\mathrm{mm}$). The ESFs are approximated by sampling a smooth function of the form\n$$\nE_z(x) = \\frac{1}{2}\\left(1 + \\operatorname{erf}\\left(\\frac{x}{\\sqrt{2}\\,\\sigma(z)}\\right)\\right),\n$$\nwhere $x$ is the lateral coordinate in $\\mathrm{mm}$ and $\\sigma(z)$ is the standard deviation of a Gaussian LSF that yields the FWHM $R_g(z)$ via the well-tested relation\n$$\n\\text{FWHM} = 2\\sqrt{2\\ln 2}\\,\\sigma.\n$$\nA small additive zero-mean noise with standard deviation $0.01$ (dimensionless counts) is present in the ESF measurements. For each test case, the $x$ sampling and the FWHM values used to synthesize the measured ESFs are provided. Your program must:\n\n1. For each $z$ in a test case, estimate $R_g(z)$ in $\\mathrm{mm}$ by computing the LSF $L_z(x) = \\frac{dE_z}{dx}$ numerically and then finding the FWHM of $L_z(x)$ using linear interpolation between samples at half its maximum.\n2. Fit a least-squares linear model $R_g(z) = a z + b$ over the provided $z$ values.\n3. Validate the geometric linear dependence as follows:\n   - Compute the coefficient of determination $R^2$ of the fit; require $R^2 \\geq 0.98$.\n   - Compute the predicted slope and intercept from geometric reasoning using the collimator parameters $d$ and $L$.\n   - Compute the relative errors of the fitted slope $a$ and intercept $b$ with respect to the geometric predictions; require the slope relative error $\\leq 0.10$ (as a decimal) and the intercept relative error $\\leq 0.15$ (as a decimal).\n4. Return a boolean for each test case indicating whether all validation criteria are met.\n\nTest Suite:\n\n- Test Case $1$ (parallel-hole, low-energy high-resolution):\n  - $d = 1.5\\,\\mathrm{mm}$, $L = 25\\,\\mathrm{mm}$.\n  - Distances: $z \\in \\{0, 10, 20, 30\\}\\,\\mathrm{mm}$.\n  - Lateral sampling: $x$ from $-20\\,\\mathrm{mm}$ to $20\\,\\mathrm{mm}$ in steps of $0.2\\,\\mathrm{mm}$.\n  - ESF synthesis FWHM values (used to generate $E_z(x)$): $[1.5, 2.1, 2.7, 3.3]\\,\\mathrm{mm}$.\n\n- Test Case $2$ (parallel-hole, low-energy general-purpose):\n  - $d = 2.4\\,\\mathrm{mm}$, $L = 15\\,\\mathrm{mm}$.\n  - Distances: $z \\in \\{0, 5, 10, 20\\}\\,\\mathrm{mm}$.\n  - Lateral sampling: $x$ from $-20\\,\\mathrm{mm}$ to $20\\,\\mathrm{mm}$ in steps of $0.2\\,\\mathrm{mm}$.\n  - ESF synthesis FWHM values: $[2.4, 3.2, 4.0, 5.6]\\,\\mathrm{mm}$.\n\n- Test Case $3$ (parallel-hole with nonideal high-distance behavior due to additional broadening):\n  - $d = 1.2\\,\\mathrm{mm}$, $L = 20\\,\\mathrm{mm}$.\n  - Distances: $z \\in \\{0, 30, 60, 90\\}\\,\\mathrm{mm}$.\n  - Lateral sampling: $x$ from $-40\\,\\mathrm{mm}$ to $40\\,\\mathrm{mm}$ in steps of $0.5\\,\\mathrm{mm}$.\n  - ESF synthesis FWHM values: $[1.2, 3.9, 8.4, 14.7]\\,\\mathrm{mm}$.\n\nFinal Output Format:\n\nYour program should produce a single line of output containing the validation results for the three test cases as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3]$, where each $r_i$ is a boolean. No additional text should be printed.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically grounded in the principles of medical imaging physics, specifically the characterization of spatial resolution in gamma cameras. The problem is well-posed, objective, and provides a self-contained, if challenging, set of tasks for analysis. The core of the problem lies in linking experimental data (simulated noisy edge-spread functions) to a theoretical model of collimator performance.\n\nThe scientific basis for the solution is the geometric model of a parallel-hole collimator. The geometric resolution, $R_g$, which is the Full Width at Half Maximum (FWHM) of the line-spread function (LSF), exhibits a linear dependence on the distance $z$ from the collimator face. This relationship can be derived using similar triangles, considering the field of view of a single collimator hole. For a hole of diameter $d$ and length $L$, a point source at distance $z$ projects a circle of radiation onto the detector. The diameter of this circle, which is taken as the geometric resolution $R_g(z)$, is given by:\n$$\nR_g(z) = d \\frac{L+z}{L} = \\left(\\frac{d}{L}\\right)z + d\n$$\nThis is a linear equation of the form $R_g(z) = a z + b$, where the theoretically predicted slope is $a_{geo} = d/L$ and the y-intercept is $b_{geo} = d$. The intercept $R_g(0) = d$ represents the intrinsic resolution at the collimator face, which is simply the hole diameter.\n\nThe procedure to solve the problem for each test case is as follows:\n\n1.  **Data Synthesis and FWHM Estimation**: For each distance $z$ provided in a test case, we first synthesize the measured edge-spread function (ESF). The problem states the ESF is modeled as an error function, which is the integral of a Gaussian function. The line-spread function (LSF), being the derivative of the ESF, is therefore a Gaussian. The relationship between the FWHM and the standard deviation $\\sigma$ for a Gaussian is given by $\\text{FWHM} = 2\\sqrt{2\\ln 2}\\,\\sigma$.\n    -   Using the provided synthesis FWHM values, we calculate the corresponding $\\sigma(z)$.\n    -   The ESF, $E_z(x) = \\frac{1}{2}\\left(1 + \\operatorname{erf}\\left(\\frac{x}{\\sqrt{2}\\,\\sigma(z)}\\right)\\right)$, is sampled over the given lateral range $x$.\n    -   Zero-mean Gaussian noise with a standard deviation of $0.01$ is added to the clean ESF to simulate a realistic measurement.\n    -   The LSF is then computed by numerically differentiating the noisy ESF with respect to $x$. We use a second-order accurate central difference method, implemented via `numpy.gradient`.\n    -   The FWHM of the resulting numerical LSF is estimated. This involves finding the maximum value of the LSF, calculating the half-maximum value, and then using linear interpolation between the discrete samples of the LSF to find the two $x$-coordinates where the function crosses this half-maximum threshold. The difference between these two coordinates gives the estimated $R_g(z)$.\n\n2.  **Linear Model Fitting**: A linear model, $R_g(z) = az + b$, is fitted to the set of estimated FWHM values $(\\text{estimated } R_g(z_i))$ versus the corresponding distances $(z_i)$. This is achieved using a least-squares polynomial fit of degree $1$. The fit yields the empirical slope $a$ and intercept $b$.\n\n3.  **Validation**: The results of the fit are validated against the geometric model and statistical criteria.\n    -   **Goodness of Fit**: The coefficient of determination, $R^2$, is calculated for the linear fit. It measures the proportion of the variance in the estimated FWHM that is predictable from the distance $z$. The fit must satisfy $R^2 \\geq 0.98$.\n    -   **Model Parameter Consistency**: The fitted parameters $a$ and $b$ are compared to the theoretical predictions from the geometric model: $a_{geo} = d/L$ and $b_{geo} = d$. The relative errors are computed:\n        $$\n        \\epsilon_a = \\frac{|a - a_{geo}|}{|a_{geo}|}\n        $$\n        $$\n        \\epsilon_b = \\frac{|b - b_{geo}|}{|b_{geo}|}\n        $$\n    -   The validation requires these errors to be within specified tolerances: $\\epsilon_a \\leq 0.10$ and $\\epsilon_b \\leq 0.15$.\n    \nA test case is considered valid (evaluates to `True`) only if all three validation criteria ($R^2$ threshold, slope error threshold, and intercept error threshold) are met. Otherwise, it is invalid (evaluates to `False`). This comprehensive procedure is applied to each of the three test cases.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import erf\n\ndef calculate_fwhm(y, x):\n    \"\"\"\n    Calculates the Full Width at Half Maximum (FWHM) of a 1D signal.\n    \n    Args:\n        y (np.ndarray): The signal amplitude values.\n        x (np.ndarray): The corresponding coordinate values.\n        \n    Returns:\n        float: The calculated FWHM.\n    \"\"\"\n    max_val = np.max(y)\n    half_max = max_val / 2.0\n    \n    # Find indices where the signal is above half maximum\n    above_half_max_indices = np.where(y > half_max)[0]\n    \n    if len(above_half_max_indices)  2:\n        return 0.0 # Peak is too narrow or not present\n\n    # Left crossing point (interpolation)\n    left_idx1 = above_half_max_indices[0] - 1\n    left_idx2 = above_half_max_indices[0]\n    \n    y1, y2 = y[left_idx1], y[left_idx2]\n    x1, x2 = x[left_idx1], x[left_idx2]\n    x_left = x1 + (x2 - x1) * (half_max - y1) / (y2 - y1)\n\n    # Right crossing point (interpolation)\n    right_idx1 = above_half_max_indices[-1]\n    right_idx2 = above_half_max_indices[-1] + 1\n\n    if right_idx2 >= len(y): # Handle edge case\n        return 0.0\n        \n    y1, y2 = y[right_idx1], y[right_idx2]\n    x1, x2 = x[right_idx1], x[right_idx2]\n    x_right = x1 + (x2 - x1) * (half_max - y1) / (y2 - y1)\n    \n    return x_right - x_left\n\ndef solve():\n    \"\"\"\n    Main function to process all test cases and validate collimator performance.\n    \"\"\"\n    test_cases = [\n        # Test Case 1: LEHR\n        {\n            \"d\": 1.5, \"L\": 25,\n            \"z_values\": np.array([0, 10, 20, 30]),\n            \"x_range\": (-20, 20, 0.2),\n            \"fwhm_synthesis\": [1.5, 2.1, 2.7, 3.3]\n        },\n        # Test Case 2: LEGP\n        {\n            \"d\": 2.4, \"L\": 15,\n            \"z_values\": np.array([0, 5, 10, 20]),\n            \"x_range\": (-20, 20, 0.2),\n            \"fwhm_synthesis\": [2.4, 3.2, 4.0, 5.6]\n        },\n        # Test Case 3: Non-ideal behavior\n        {\n            \"d\": 1.2, \"L\": 20,\n            \"z_values\": np.array([0, 30, 60, 90]),\n            \"x_range\": (-40, 40, 0.5),\n            \"fwhm_synthesis\": [1.2, 3.9, 8.4, 14.7]\n        }\n    ]\n    \n    results = []\n    \n    FWHM_TO_SIGMA = 1 / (2 * np.sqrt(2 * np.log(2)))\n    NOISE_STD = 0.01\n\n    # For reproducibility of noise\n    np.random.seed(0)\n\n    for case in test_cases:\n        d = case[\"d\"]\n        L = case[\"L\"]\n        z_values = case[\"z_values\"]\n        x_min, x_max, x_step = case[\"x_range\"]\n        x = np.arange(x_min, x_max + x_step, x_step)\n        \n        estimated_fwhms = []\n        \n        for i, z in enumerate(z_values):\n            # 1. Synthesize ESF data\n            fwhm_true = case[\"fwhm_synthesis\"][i]\n            sigma = fwhm_true * FWHM_TO_SIGMA\n            \n            esf_clean = 0.5 * (1 + erf(x / (np.sqrt(2) * sigma)))\n            noise = np.random.normal(0, NOISE_STD, size=esf_clean.shape)\n            esf_noisy = esf_clean + noise\n            \n            # 2. Estimate Rg(z) by computing LSF and its FWHM\n            lsf = np.gradient(esf_noisy, x)\n            fwhm_est = calculate_fwhm(lsf, x)\n            estimated_fwhms.append(fwhm_est)\n            \n        estimated_fwhms = np.array(estimated_fwhms)\n        \n        # 3. Fit linear model Rg(z) = a*z + b\n        a_fit, b_fit = np.polyfit(z_values, estimated_fwhms, 1)\n\n        # 4. Validate the fit\n        # 4a. Compute R^2\n        y_pred = a_fit * z_values + b_fit\n        ss_res = np.sum((estimated_fwhms - y_pred)**2)\n        ss_tot = np.sum((estimated_fwhms - np.mean(estimated_fwhms))**2)\n        r_squared = 1 - (ss_res / ss_tot) if ss_tot > 0 else 0\n        \n        # 4b. Compute geometric predictions\n        a_geo = d / L\n        b_geo = d\n        \n        # 4c. Compute relative errors\n        err_a = np.abs(a_fit - a_geo) / np.abs(a_geo)\n        err_b = np.abs(b_fit - b_geo) / np.abs(b_geo)\n        \n        # 4d. Check all validation criteria\n        is_valid = (r_squared >= 0.98) and (err_a = 0.10) and (err_b = 0.15)\n        results.append(is_valid)\n\n    # Format the final output\n    print(f\"[{','.join(map(str, [r.item() for r in results]))}]\")\n\nsolve()\n```"
        }
    ]
}