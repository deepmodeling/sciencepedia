{
    "hands_on_practices": [
        {
            "introduction": "Understanding RF excitation begins with the fundamental relationship between the applied RF field and the resulting flip angle of the net magnetization. This first exercise  provides a direct application of the on-resonance Bloch equation, challenging you to calculate the required RF field amplitude, $B_1^+$, to achieve a specific flip angle. This calculation is a foundational skill for designing and calibrating the most basic building blocks of MRI pulse sequences.",
            "id": "4916239",
            "problem": "A radiofrequency (RF) transmit coil in a proton Magnetic Resonance Imaging (MRI) system operating at the Larmor frequency $f_0=64\\,\\text{MHz}$ is used to apply a spatially uniform, on-resonance transverse excitation described by the positive-rotating component of the RF field $B_1^+(t)$. The excitation is a rectangular pulse of duration $T=1\\,\\text{ms}$ with constant amplitude $B_1^+$, and the goal is to produce a $90^\\circ$ flip of the net magnetization. Assume the sample contains protons, the system is exactly on resonance with the static field $B_0$ corresponding to $f_0$, and relaxation is negligible over the pulse duration. Use the angular gyromagnetic ratio $\\gamma = 2\\pi \\cdot 42.58\\,\\text{MHz/T}$.\n\nStarting from the Bloch equation and the rotating-frame picture for on-resonant RF excitation, determine the required amplitude $B_1^+$ that produces the desired flip angle under these conditions. Express your final result in microtesla and round your answer to three significant figures.",
            "solution": "The problem statement is critically validated before proceeding to a solution.\n\n### Step 1: Extract Givens\n- Larmor frequency: $f_0 = 64\\,\\text{MHz}$\n- RF field component: Positive-rotating, $B_1^+(t)$\n- RF pulse shape: Rectangular\n- RF pulse duration: $T = 1\\,\\text{ms}$\n- RF pulse amplitude: Constant, $B_1^+$\n- Desired flip angle: $\\alpha = 90^\\circ$\n- Nucleus: Proton\n- Excitation condition: On-resonance\n- Relaxation: Negligible over the pulse duration\n- Angular gyromagnetic ratio for protons: $\\gamma = 2\\pi \\cdot 42.58\\,\\text{MHz/T}$\n- Required final answer format: Numerical value for $B_1^+$ in microtesla ($\\mu$T), rounded to three significant figures.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientific Grounding**: The problem is grounded in the fundamental principles of Nuclear Magnetic Resonance (NMR), specifically the Bloch equation and the rotating frame formalism, which are cornerstones of Magnetic Resonance Imaging (MRI). The physical quantities and their values (Larmor frequency, gyromagnetic ratio, pulse duration) are typical for clinical proton MRI at a field strength of approximately $1.5\\,\\text{T}$.\n- **Well-Posedness**: The problem is well-posed. It provides sufficient information to determine a unique value for the unknown variable, $B_1^+$. The relationship between flip angle, pulse duration, and RF field amplitude is direct and unambiguous.\n- **Objectivity**: The problem is stated in precise, objective, and technical language, free from ambiguity or subjective content.\n- **Consistency and Completeness**: The provided information is self-consistent and complete. For example, the use of the *angular* gyromagnetic ratio is appropriate for equations involving angular frequency. No essential data is missing, and no constraints are contradictory. The Larmor frequency $f_0$ is consistent with the gyromagnetic ratio for a common static field strength $B_0 = f_0 / (\\gamma/2\\pi) = 64\\,\\text{MHz} / 42.58\\,\\text{MHz/T} \\approx 1.503\\,\\text{T}$.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid** as it is scientifically sound, well-posed, objective, and complete. A solution will be derived.\n\n### Solution Derivation\nThe behavior of the net magnetization vector $\\mathbf{M}$ under the influence of a magnetic field is described by the Bloch equation. In the absence of relaxation, this equation is:\n$$ \\frac{d\\mathbf{M}}{dt} = \\gamma (\\mathbf{M} \\times \\mathbf{B}) $$\nwhere $\\gamma$ is the gyromagnetic ratio and $\\mathbf{B}$ is the total magnetic field. In MRI, this field consists of a large static field $\\mathbf{B}_0 = B_0 \\hat{k}$ and a much smaller time-varying radiofrequency (RF) field $\\mathbf{B}_1(t)$ applied perpendicular to $\\mathbf{B}_0$.\n\nTo simplify the analysis, we transform into a reference frame rotating about the $z$-axis at the Larmor frequency $\\omega_0 = \\gamma B_0$. In this rotating frame, the equation of motion becomes:\n$$ \\frac{d\\mathbf{M}'}{dt} = \\gamma (\\mathbf{M}' \\times \\mathbf{B}_{\\text{eff}}) $$\nwhere $\\mathbf{M}'$ is the magnetization vector in the rotating frame and $\\mathbf{B}_{\\text{eff}}$ is the effective magnetic field. For an RF pulse with carrier frequency $\\omega$, the effective field is:\n$$ \\mathbf{B}_{\\text{eff}} = \\left(B_0 - \\frac{\\omega}{\\gamma}\\right)\\hat{k}' + \\mathbf{B}_1' $$\nHere, $\\mathbf{B}_1'$ is the RF field vector in the rotating frame and the term $(B_0 - \\omega/\\gamma)\\hat{k}'$ represents the effect of any off-resonance condition.\n\nThe problem states that the excitation is \"on-resonance,\" which means the RF frequency $\\omega$ is equal to the Larmor frequency $\\omega_0$. Therefore, $\\omega = \\omega_0 = \\gamma B_0$, and the off-resonance term vanishes:\n$$ B_0 - \\frac{\\omega}{\\gamma} = 0 $$\nThe effective magnetic field simplifies to just the RF field component in the rotating frame:\n$$ \\mathbf{B}_{\\text{eff}} = \\mathbf{B}_1' $$\nThe problem specifies a positive-rotating RF field component of constant amplitude $B_1^+$. In the rotating frame, this component appears as a static magnetic field. By convention, we align this field with the $x'$-axis, so $\\mathbf{B}_1' = B_1^+ \\hat{i}'$.\n\nThe Bloch equation for on-resonance excitation thus becomes:\n$$ \\frac{d\\mathbf{M}'}{dt} = \\mathbf{M}' \\times (\\gamma B_1^+ \\hat{i}') $$\nThis equation describes the precession of the magnetization vector $\\mathbf{M}'$ around the $x'$-axis at an angular frequency of $\\omega_1 = \\gamma B_1^+$.\n\nPrior to the RF pulse, the magnetization is at thermal equilibrium, aligned with the static field $\\mathbf{B}_0$. In the rotating frame, this initial state is $\\mathbf{M}'(0) = M_0 \\hat{k}'$. When the RF pulse of duration $T$ is applied, $\\mathbf{M}'$ rotates around the $x'$-axis. The total angle of this rotation is the flip angle, $\\alpha$, given by the product of the precession frequency and the pulse duration:\n$$ \\alpha = \\omega_1 T $$\nSubstituting the expression for $\\omega_1$, we get the fundamental relationship for a rectangular pulse:\n$$ \\alpha = \\gamma B_1^+ T $$\nWe are tasked with finding the RF field amplitude $B_1^+$ required for a specified flip angle $\\alpha$. Rearranging the equation gives:\n$$ B_1^+ = \\frac{\\alpha}{\\gamma T} $$\nThe given values are:\n- Flip angle: $\\alpha = 90^\\circ$. This must be converted to radians for the calculation: $\\alpha = \\frac{\\pi}{2}\\,\\text{rad}$.\n- Pulse duration: $T = 1\\,\\text{ms} = 1 \\times 10^{-3}\\,\\text{s}$.\n- Angular gyromagnetic ratio: $\\gamma = 2\\pi \\cdot 42.58\\,\\text{MHz/T} = 2\\pi \\cdot 42.58 \\times 10^6\\,\\text{rad}\\cdot\\text{s}^{-1}\\cdot\\text{T}^{-1}$.\n\nSubstituting these values into the equation for $B_1^+$:\n$$ B_1^+ = \\frac{\\frac{\\pi}{2}\\,\\text{rad}}{(2\\pi \\cdot 42.58 \\times 10^6\\,\\text{rad}\\cdot\\text{s}^{-1}\\cdot\\text{T}^{-1}) \\cdot (1 \\times 10^{-3}\\,\\text{s})} $$\nThe factor of $\\pi$ and the units of radians and seconds cancel out, yielding a result in Tesla:\n$$ B_1^+ = \\frac{1/2}{2 \\cdot 42.58 \\times 10^6 \\cdot 10^{-3}}\\,\\text{T} = \\frac{1}{4 \\cdot 42.58 \\times 10^3}\\,\\text{T} $$\n$$ B_1^+ = \\frac{1}{170.32 \\times 10^3}\\,\\text{T} = \\frac{1}{170320}\\,\\text{T} $$\nPerforming the division:\n$$ B_1^+ \\approx 5.871300... \\times 10^{-6}\\,\\text{T} $$\nThe problem requires the answer in microtesla ($\\mu$T). Using the conversion $1\\,\\mu\\text{T} = 10^{-6}\\,\\text{T}$:\n$$ B_1^+ \\approx 5.871300...\\,\\mu\\text{T} $$\nFinally, rounding the result to three significant figures as requested:\n$$ B_1^+ \\approx 5.87\\,\\mu\\text{T} $$",
            "answer": "$$\\boxed{5.87}$$"
        },
        {
            "introduction": "In a real MRI scanner, the transmitted RF field is never perfectly uniform, leading to spatial variations in the flip angle. This practice  contrasts the effect of such an error on a simple pulse with its effect on a more complex \"composite pulse.\" By working through the spin rotations for each case, you will gain a hands-on appreciation for how clever pulse sequence design can overcome hardware limitations and produce more accurate and reliable imaging results.",
            "id": "4920044",
            "problem": "A proton spin system in Magnetic Resonance Imaging (MRI) is modeled in the rotating frame with the net magnetization initially at thermal equilibrium along the longitudinal axis, so the initial magnetization vector is $M(0) = (0, 0, M_0)^T$. In the short, strong radiofrequency (RF) pulse (hard-pulse) limit, assume on-resonance excitation, negligible relaxation during the pulses, and no static field inhomogeneity. A $10\\%$ transmit field ($B_1$) under-rotation is present, meaning every nominal flip angle is reduced by a factor of $0.90$.\n\nConsider two excitation schemes applied to this initial state:\n1. A single nominal $180^{\\circ}$ hard pulse.\n2. A composite nominal $90^{\\circ}_{x}$–$180^{\\circ}_{y}$–$90^{\\circ}_{x}$ sequence, where subscripts indicate the rotation axis of each pulse in the rotating frame.\n\nUsing first principles of magnetization dynamics under RF excitation, determine the residual longitudinal magnetization after each scheme, expressed as a fraction of $M_{0}$. Take all flip angles in degrees. Round each value to four significant figures. Express your answers as dimensionless fractions of $M_{0}$.",
            "solution": "The user wants me to solve a problem from the field of medical imaging, specifically concerning RF excitation in MRI.\n\n### Step 1: Extract Givens\n-   **System:** Proton spin system in a rotating frame.\n-   **Initial State:** Net magnetization at thermal equilibrium along the longitudinal axis, $M(0) = (0, 0, M_{0})^T$.\n-   **Assumptions:**\n    1.  Short, strong radiofrequency (RF) pulse (hard-pulse limit).\n    2.  On-resonance excitation ($\\Delta\\omega = 0$).\n    3.  Negligible relaxation ($T_1$, $T_2$ effects) during the pulses.\n    4.  No static field inhomogeneity.\n-   **Condition:** A $10\\%$ transmit field ($B_1$) under-rotation is present. The actual flip angle $\\alpha_{actual}$ is related to the nominal flip angle $\\alpha_{nom}$ by the factor $0.90$, such that $\\alpha_{actual} = 0.90 \\times \\alpha_{nom}$.\n-   **Scheme 1:** A single nominal $180^{\\circ}$ hard pulse.\n-   **Scheme 2:** A composite nominal $90^{\\circ}_{x}$–$180^{\\circ}_{y}$–$90^{\\circ}_{x}$ sequence.\n-   **Objective:** Determine the residual longitudinal magnetization ($M_z$) after each scheme, expressed as a fraction of the initial longitudinal magnetization $M_0$.\n-   **Numerical Requirement:** Round final values to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded:** The problem is firmly rooted in the fundamental principles of Nuclear Magnetic Resonance (NMR) and its application in MRI. It uses the Bloch equations in the rotating frame under the hard-pulse, on-resonance approximation. The concept of composite pulses (like the $90_x-180_y-90_x$ sequence) for compensating $B_1$ field inhomogeneity is a standard and well-established technique in advanced MRI.\n2.  **Well-Posed:** The problem is well-posed. It provides a clear initial condition, a set of well-defined transformations (RF pulses), and a specific quantity to be calculated. The assumptions simplify the problem to a series of geometric rotations, for which a unique solution exists.\n3.  **Objective:** The problem is stated in precise, objective, and technical language, free from any subjective or ambiguous terms.\n4.  **Completeness:** The problem is self-contained. All necessary information—initial state, pulse sequence, error factor—is provided.\n5.  **Realism:** The scenario of a $10\\%$ error in the $B_1$ field is realistic in practical MRI applications, and composite pulses are a common solution. The problem setup is physically plausible.\n\n### Step 3: Verdict and Action\nThe problem is valid. It is a standard, non-trivial problem in MRI physics that tests the understanding of magnetization dynamics and composite pulses. A full solution will be provided.\n\nThe evolution of the magnetization vector $M$ in the rotating frame under an on-resonance RF pulse is described by a rotation. The effect of a pulse with flip angle $\\alpha$ applied along an axis $\\hat{n}$ (where $\\hat{n}$ is one of $x, y, z$) is given by the application of a rotation matrix $R_{\\hat{n}}(\\alpha)$ to the magnetization vector. The initial magnetization vector is given as $M_{initial} = \\begin{pmatrix} 0 \\\\ 0 \\\\ M_0 \\end{pmatrix}$.\n\nBy convention in MRI, the Bloch equation dynamics result in clockwise rotations of the magnetization vector about the effective field. The rotation matrices for clockwise rotations about the $x$-axis and $y$-axis are:\n$$R_x(\\alpha) = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(\\alpha) & \\sin(\\alpha) \\\\ 0 & -\\sin(\\alpha) & \\cos(\\alpha) \\end{pmatrix}$$\n$$R_y(\\alpha) = \\begin{pmatrix} \\cos(\\alpha) & 0 & -\\sin(\\alpha) \\\\ 0 & 1 & 0 \\\\ \\sin(\\alpha) & 0 & \\cos(\\alpha) \\end{pmatrix}$$\nThe problem also specifies that all flip angles are in degrees. The under-rotation factor is $0.90$.\n\n**Scheme 1: Single nominal $180^{\\circ}$ hard pulse**\n\nFor this scheme, a single RF pulse with a nominal flip angle of $\\alpha_{nom} = 180^{\\circ}$ is applied. The problem does not specify the axis of this pulse; however, for a pure inversion starting from the $z$-axis, the final longitudinal magnetization is independent of the transverse axis of rotation (e.g., $x$ or $y$). We will assume the pulse is applied along the $x$-axis without loss of generality.\n\nThe actual flip angle is $\\alpha_{actual,1} = 0.90 \\times \\alpha_{nom} = 0.90 \\times 180^{\\circ} = 162^{\\circ}$.\n\nThe final magnetization vector, $M_{final,1}$, is obtained by applying the rotation matrix $R_x(162^{\\circ})$ to the initial magnetization vector $M_{initial}$:\n$$M_{final,1} = R_x(162^{\\circ}) M_{initial} = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(162^{\\circ}) & \\sin(162^{\\circ}) \\\\ 0 & -\\sin(162^{\\circ}) & \\cos(162^{\\circ}) \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ M_0 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ M_0 \\sin(162^{\\circ}) \\\\ M_0 \\cos(162^{\\circ}) \\end{pmatrix}$$\nThe residual longitudinal magnetization is the $z$-component of $M_{final,1}$, which is $M_{z,1} = M_0 \\cos(162^{\\circ})$.\nThe fraction of the initial magnetization is:\n$$\\frac{M_{z,1}}{M_0} = \\cos(162^{\\circ})$$\nNumerically, this value is $\\cos(162^{\\circ}) \\approx -0.9510565...$.\nRounding to four significant figures, the result is $-0.9511$.\n\n**Scheme 2: Composite nominal $90^{\\circ}_{x}$–$180^{\\circ}_{y}$–$90^{\\circ}_{x}$ sequence**\n\nThis scheme consists of a sequence of three pulses. The final magnetization vector, $M_{final,2}$, is the result of applying the three corresponding rotation matrices in order:\n$$M_{final,2} = R_x(\\alpha_3) R_y(\\alpha_2) R_x(\\alpha_1) M_{initial}$$\nThe nominal flip angles are $\\alpha_{nom,1}=90^{\\circ}$, $\\alpha_{nom,2}=180^{\\circ}$, and $\\alpha_{nom,3}=90^{\\circ}$.\nThe actual flip angles, incorporating the $10\\%$ under-rotation, are:\n-   $\\alpha_1 = 0.90 \\times 90^{\\circ} = 81^{\\circ}$\n-   $\\alpha_2 = 0.90 \\times 180^{\\circ} = 162^{\\circ}$\n-   $\\alpha_3 = 0.90 \\times 90^{\\circ} = 81^{\\circ}$\n\nWe now compute the final state by applying each rotation sequentially.\n1.  After the first pulse ($R_x(81^{\\circ})$):\n    $$M_1 = R_x(81^{\\circ}) M_{initial} = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(81^{\\circ}) & \\sin(81^{\\circ}) \\\\ 0 & -\\sin(81^{\\circ}) & \\cos(81^{\\circ}) \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ M_0 \\end{pmatrix} = M_0 \\begin{pmatrix} 0 \\\\ \\sin(81^{\\circ}) \\\\ \\cos(81^{\\circ}) \\end{pmatrix}$$\n2.  After the second pulse ($R_y(162^{\\circ})$):\n    $$M_2 = R_y(162^{\\circ}) M_1 = \\begin{pmatrix} \\cos(162^{\\circ}) & 0 & -\\sin(162^{\\circ}) \\\\ 0 & 1 & 0 \\\\ \\sin(162^{\\circ}) & 0 & \\cos(162^{\\circ}) \\end{pmatrix} \\left( M_0 \\begin{pmatrix} 0 \\\\ \\sin(81^{\\circ}) \\\\ \\cos(81^{\\circ}) \\end{pmatrix} \\right) = M_0 \\begin{pmatrix} -\\sin(162^{\\circ})\\cos(81^{\\circ}) \\\\ \\sin(81^{\\circ}) \\\\ \\cos(162^{\\circ})\\cos(81^{\\circ}) \\end{pmatrix}$$\n3.  After the third pulse ($R_x(81^{\\circ})$):\n    $$M_{final,2} = R_x(81^{\\circ}) M_2 = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos(81^{\\circ}) & \\sin(81^{\\circ}) \\\\ 0 & -\\sin(81^{\\circ}) & \\cos(81^{\\circ}) \\end{pmatrix} M_2$$\nWe are interested in the final longitudinal component, $M_{z,2}$, which is the third component of $M_{final,2}$.\n$$M_{z,2} = [M_2]_y \\cdot (-\\sin(81^{\\circ})) + [M_2]_z \\cdot (\\cos(81^{\\circ}))$$\nSubstituting the components of $M_2$:\n$$\\frac{M_{z,2}}{M_0} = (\\sin(81^{\\circ})) \\cdot (-\\sin(81^{\\circ})) + (\\cos(162^{\\circ})\\cos(81^{\\circ})) \\cdot (\\cos(81^{\\circ}))$$\n$$\\frac{M_{z,2}}{M_0} = -\\sin^2(81^{\\circ}) + \\cos(162^{\\circ})\\cos^2(81^{\\circ})$$\nWe can simplify this expression using trigonometric identities. Let $\\theta = 81^{\\circ}$, so $2\\theta = 162^{\\circ}$.\nUsing the identities $\\cos^2(\\theta) = \\frac{1+\\cos(2\\theta)}{2}$ and $\\sin^2(\\theta) = \\frac{1-\\cos(2\\theta)}{2}$:\n$$\\frac{M_{z,2}}{M_0} = -\\frac{1-\\cos(162^{\\circ})}{2} + \\cos(162^{\\circ})\\frac{1+\\cos(162^{\\circ})}{2}$$\n$$\\frac{M_{z,2}}{M_0} = \\frac{-1+\\cos(162^{\\circ}) + \\cos(162^{\\circ}) + \\cos^2(162^{\\circ})}{2} = \\frac{\\cos^2(162^{\\circ}) + 2\\cos(162^{\\circ}) - 1}{2}$$\nLet's evaluate this expression numerically. Let $c = \\cos(162^{\\circ}) \\approx -0.9510565$.\n$$\\frac{M_{z,2}}{M_0} = \\frac{c^2 + 2c - 1}{2} = \\frac{(-0.9510565)^2 + 2(-0.9510565) - 1}{2}$$\n$$\\frac{M_{z,2}}{M_0} = \\frac{0.9045085 - 1.902113 - 1}{2} = \\frac{-1.9976045}{2} = -0.99880225$$\nRounding to four significant figures, the result is $-0.9988$.\nThis demonstrates the effectiveness of the composite pulse, as the final longitudinal magnetization ($-0.9988 M_0$) is much closer to the ideal inversion value of $-M_0$ compared to the single pulse ($-0.9511 M_0$).\n\nThe residual longitudinal magnetization fractions for the two schemes are:\n1.  For the single $180^{\\circ}$ pulse: $\\cos(162^{\\circ}) \\approx -0.9511$\n2.  For the $90^{\\circ}_x$-$180^{\\circ}_y$-$90^{\\circ}_x$ composite pulse: $\\frac{1}{2}(\\cos^2(162^{\\circ}) + 2\\cos(162^{\\circ}) - 1) \\approx -0.9988$",
            "answer": "$$ \\boxed{ \\begin{pmatrix} -0.9511 & -0.9988 \\end{pmatrix} } $$"
        },
        {
            "introduction": "To accurately predict the outcome of an MRI experiment, we must account for both the specific shape of the RF pulse over time and the spatial variations of the RF field. This final practice  is a computational exercise that simulates this exact process by implementing the fundamental flip angle integral, $\\alpha = \\gamma \\int |B_1(t)| dt$. You will calculate and analyze the distribution of flip angles across a volume, providing insight into how pulse designers characterize the performance of their sequences in a realistic, heterogeneous environment.",
            "id": "4920032",
            "problem": "You are given a discrete spatial map of the complex circularly polarized transmit field $B_1^+(x,y,z)$ in Magnetic Resonance Imaging (MRI) and a time-domain radiofrequency (RF) envelope $E(t)$ (in Tesla). Assume on-resonance excitation, negligible relaxation during the pulse, and that the effective nutation rate in the rotating frame is proportional to the magnitude of the transverse $B_1^+$ field. Using first principles (starting from the Bloch equations), design a program that, for each voxel, numerically computes the local flip angle in degrees by integrating the magnitude of the RF envelope over time, scaling by the local $B_1^+$ amplitude, and converting from radians to degrees via the gyromagnetic ratio of hydrogen. Angles must be expressed in degrees, rounded to three decimal places. Use the International System of Units (SI) throughout, with time in seconds and magnetic field in Tesla.\n\nDefinitions and constants:\n- Magnetic Resonance Imaging (MRI) uses a transmit field $B_1^+(x,y,z)$ to tip the net magnetization. The flip angle at a voxel is determined by the time-integral of the effective transverse RF field seen by spins.\n- Radiofrequency (RF) denotes the time-varying magnetic field $E(t)$ applied during excitation.\n- The gyromagnetic ratio for hydrogen is $\\gamma = 2\\pi \\cdot 42.577 \\times 10^{6}\\ \\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$.\n- The program must compute, for each voxel, the flip angle produced by the given RF envelope and the local $B_1^+$ amplitude scaling. Treat $B_1^+(x,y,z)$ as a real, nonnegative scaling factor $s(x,y,z)$ that multiplies the envelope $E(t)$, i.e., $|B_1^+(x,y,z,t)| = s(x,y,z)\\,|E(t)|$.\n\nNumerical integration requirement:\n- Use the trapezoidal rule over the specified discrete time grid to approximate the time integral of the magnitude of the RF envelope $|E(t)|$.\n- Then scale by $s(x,y,z)$ and $\\gamma$, and convert the result from radians to degrees.\n\nYour program must implement the following three test cases (a test suite), each using the specified spatial map, RF envelope, and time grid. For each case, compute the flip angle at every voxel, then compute and output three summary metrics in degrees: the voxel-wise mean, the voxel-wise standard deviation (population standard deviation), and the range (maximum minus minimum). All reported angles must be rounded to three decimal places.\n\nTest Case 1 (uniform $B_1^+$, rectangular pulse):\n- Spatial map: a $3 \\times 3 \\times 1$ grid with $s(x,y,z) = 1$ for all voxels.\n- RF envelope: rectangular pulse with amplitude $B_{1,\\mathrm{amp}} = 10\\,\\mu\\mathrm{T}$ (i.e., $10 \\times 10^{-6}\\ \\mathrm{T}$) for a duration $\\tau = 1\\,\\mathrm{ms}$ (i.e., $1 \\times 10^{-3}\\ \\mathrm{s}$), zero outside.\n- Time grid: $t \\in [0,\\tau]$ with step $\\Delta t = 1\\,\\mu\\mathrm{s}$ (i.e., $1 \\times 10^{-6}\\ \\mathrm{s}$).\n\nTest Case 2 (linearly varying $B_1^+$, Gaussian pulse):\n- Spatial map: a $4 \\times 1 \\times 1$ grid with $s(x,y,z)$ varying linearly along $x$ as $[0.8, 0.933333\\ldots, 1.066666\\ldots, 1.2]$.\n- RF envelope: Gaussian $E(t) = B_{1,\\mathrm{amp}} \\exp\\!\\left(-\\dfrac{t^{2}}{2\\sigma^{2}}\\right)$ with $B_{1,\\mathrm{amp}} = 8\\,\\mu\\mathrm{T}$ and $\\sigma = 0.3\\,\\mathrm{ms}$, truncated to $t \\in [-1.2\\,\\mathrm{ms}, 1.2\\,\\mathrm{ms}]$.\n- Time grid: $\\Delta t = 1\\,\\mu\\mathrm{s}$ over the specified interval.\n\nTest Case 3 (heterogeneous $B_1^+$, half-sine pulse):\n- Spatial map: a $4 \\times 1 \\times 1$ grid with $s(x,y,z) = [0.0, 0.5, 1.0, 1.5]$ along $x$.\n- RF envelope: half-sine $E(t) = B_{1,\\mathrm{amp}} \\sin\\!\\left(\\dfrac{\\pi t}{\\tau}\\right)$ for $t \\in [0,\\tau]$, with $B_{1,\\mathrm{amp}} = 6\\,\\mu\\mathrm{T}$ and $\\tau = 2\\,\\mathrm{ms}$; zero outside.\n- Time grid: $t \\in [0,\\tau]$ with step $\\Delta t = 1\\,\\mu\\mathrm{s}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the nine results for the three test cases (in order: mean, standard deviation, range for Test Case 1, then Test Case 2, then Test Case 3) as a comma-separated list enclosed in square brackets, for example, $[\\text{result1},\\text{result2},\\ldots,\\text{result9}]$, with each value rounded to three decimal places in degrees.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of Nuclear Magnetic Resonance (NMR) physics, specifically the behavior of nuclear spins under radiofrequency (RF) excitation as described by the Bloch equations. The problem is well-posed, with all necessary constants, initial conditions, and functional forms provided, and it is free of contradictions or ambiguities.\n\nThe fundamental principle governing the evolution of the net magnetization vector $\\mathbf{M}$ in a magnetic field is the Bloch equation. In the rotating frame of reference and neglecting relaxation effects (assuming the RF pulse is much shorter than the relaxation times $T_1$ and $T_2$), this equation simplifies to:\n$$\n\\frac{d\\mathbf{M}}{dt} = \\gamma \\mathbf{M} \\times \\mathbf{B}_{\\text{eff}}\n$$\nwhere $\\gamma$ is the gyromagnetic ratio and $\\mathbf{B}_{\\text{eff}}$ is the effective magnetic field in the rotating frame.\n\nFor on-resonance excitation, the Larmor frequency of the spins exactly matches the frequency of the rotating frame, causing the contribution from the main static magnetic field $B_0$ to vanish. The effective field is then solely the applied transverse RF field, $\\mathbf{B}_1(t)$. The equation describes the precession (or nutation) of the magnetization vector $\\mathbf{M}$ about the axis of the $\\mathbf{B}_1(t)$ field. The instantaneous angular frequency of this nutation is given by $\\omega(t) = \\gamma |\\mathbf{B}_1(t)|$.\n\nThe problem specifies that the magnitude of the effective transverse RF field at a spatial location $(x,y,z)$ and time $t$ is given by $|B_1^+(x,y,z,t)| = s(x,y,z) |E(t)|$. Here, $E(t)$ is a nominal RF pulse envelope and $s(x,y,z)$ is a dimensionless, real, non-negative scaling factor that accounts for spatial inhomogeneity of the transmit field.\n\nThe total angle of rotation, known as the flip angle $\\alpha$, is the time integral of the nutation frequency over the duration of the RF pulse. For a voxel at position $(x,y,z)$, this is:\n$$\n\\alpha(x,y,z) = \\int_{\\text{pulse duration}} \\omega(t) dt = \\int \\gamma |B_1^+(x,y,z,t)| dt\n$$\nSubstituting the given relationship for the field magnitude:\n$$\n\\alpha(x,y,z) = \\int \\gamma s(x,y,z) |E(t)| dt\n$$\nSince $\\gamma$ and the spatial scaling factor $s(x,y,z)$ are constant with respect to time, they can be factored out of the integral:\n$$\n\\alpha(x,y,z) = \\gamma s(x,y,z) \\int |E(t)| dt\n$$\nThe value of $\\alpha$ calculated from this formula is in radians. To convert to degrees, we use the conversion factor $\\frac{180}{\\pi}$:\n$$\n\\alpha_{\\text{deg}}(x,y,z) = \\alpha_{\\text{rad}}(x,y,z) \\cdot \\frac{180}{\\pi}\n$$\nThe problem requires the numerical evaluation of the integral $\\int |E(t)| dt$ using the trapezoidal rule. For a function $f(t)$ discretized into $N$ points with a constant time step $\\Delta t$, the integral is approximated as:\n$$\n\\int_{t_0}^{t_N} f(t) dt \\approx \\Delta t \\left( \\frac{f(t_0) + f(t_N)}{2} + \\sum_{i=1}^{N-1} f(t_i) \\right)\n$$\nIn this problem, $f(t) = |E(t)|$.\n\nThe overall algorithm is as follows:\n1.  For each test case, define the time grid $t_i$ and evaluate the RF envelope magnitude $|E(t_i)|$ at each point.\n2.  Compute the time integral of the envelope magnitude, $I_E = \\int |E(t)| dt$, using the trapezoidal rule.\n3.  Define the gyromagnetic ratio for hydrogen: $\\gamma = 2\\pi \\cdot 42.577 \\times 10^{6}\\ \\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$.\n4.  For each voxel in the spatial map $s(x,y,z)$, calculate the local flip angle in degrees: $\\alpha_{\\text{deg}}(x,y,z) = \\gamma \\cdot s(x,y,z) \\cdot I_E \\cdot \\frac{180}{\\pi}$.\n5.  Collect all computed flip angles for the spatial map.\n6.  Calculate the voxel-wise mean, population standard deviation, and range (maximum - minimum) of the flip angles.\n7.  Round the final three metrics to three decimal places.\n\nThis procedure is applied to each of the three test cases provided.\n\n**Test Case 1: Uniform $B_1^+$, Rectangular Pulse**\n-   Spatial map: $3 \\times 3 \\times 1$ grid with $s(x,y,z) = 1$.\n-   RF envelope: $|E(t)| = 10 \\times 10^{-6}\\ \\mathrm{T}$ for $\\tau = 1 \\times 10^{-3}\\ \\mathrm{s}$.\n-   The integral is $I_E = (10 \\times 10^{-6}\\ \\mathrm{T}) \\cdot (1 \\times 10^{-3}\\ \\mathrm{s}) = 10 \\times 10^{-9}\\ \\mathrm{T \\cdot s}$.\n-   The flip angle is constant across all voxels: $\\alpha_{\\text{deg}} = (2\\pi \\cdot 42.577 \\times 10^6) \\cdot 1 \\cdot (10 \\times 10^{-9}) \\cdot \\frac{180}{\\pi} \\approx 153.286^{\\circ}$.\n-   Therefore, the mean is $153.286^{\\circ}$, and the standard deviation and range are both $0$.\n\n**Test Case 2: Linearly Varying $B_1^+$, Gaussian Pulse**\n-   Spatial map: $4 \\times 1 \\times 1$ grid with $s(x,y,z) = [0.8, 0.933..., 1.066..., 1.2]$.\n-   RF envelope: $|E(t)| = (8 \\times 10^{-6}) \\exp(-t^2 / (2\\sigma^2))$ with $\\sigma = 0.3 \\times 10^{-3}\\ \\mathrm{s}$, integrated over $t \\in [-1.2 \\times 10^{-3}, 1.2 \\times 10^{-3}]\\ \\mathrm{s}$.\n-   The integral $I_E$ is computed numerically, and the flip angle at each of the four voxel locations is calculated using its corresponding $s$ value.\n\n**Test Case 3: Heterogeneous $B_1^+$, Half-Sine Pulse**\n-   Spatial map: $4 \\times 1 \\times 1$ grid with $s(x,y,z) = [0.0, 0.5, 1.0, 1.5]$.\n-   RF envelope: $E(t) = (6 \\times 10^{-6}) \\sin(\\pi t / \\tau)$ for $\\tau = 2 \\times 10^{-3}\\ \\mathrm{s}$. Since $\\sin(\\pi t / \\tau) \\ge 0$ for $t \\in [0, \\tau]$, $|E(t)| = E(t)$.\n-   The integral $I_E$ is computed numerically. The analytical integral is $\\int_0^\\tau B_{1,\\mathrm{amp}} \\sin(\\pi t/\\tau) dt = B_{1,\\mathrm{amp}} \\frac{2\\tau}{\\pi}$, which can serve as a validation. The flip angle for each voxel is then computed.\n\nThe final output aggregates the mean, standard deviation, and range for each of the three cases into a single list.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the MRI flip angle calculation problem for three test cases.\n    \"\"\"\n    \n    # Define the gyromagnetic ratio for hydrogen (proton) in rad/s/T\n    GAMMA = 2 * np.pi * 42.577e6\n\n    results = []\n\n    # Wrapper function to process a single test case\n    def process_case(s_map, E_func, t_start, t_end, dt):\n        \"\"\"\n        Computes flip angle statistics for a given test case.\n\n        Args:\n            s_map (np.ndarray): Spatial map of B1+ scaling factors.\n            E_func (callable): Function that returns the RF envelope magnitude |E(t)|.\n            t_start (float): Start time of the integration interval in seconds.\n            t_end (float): End time of the integration interval in seconds.\n            dt (float): Time step in seconds.\n\n        Returns:\n            tuple: (mean, std_dev, range) of flip angles in degrees.\n        \"\"\"\n        # Create the time grid, ensuring the endpoint is included\n        t_grid = np.arange(t_start, t_end + dt / 2, dt)\n        \n        # Evaluate the RF envelope magnitude on the time grid\n        E_t = E_func(t_grid)\n        \n        # Numerically integrate |E(t)| using the trapezoidal rule\n        integral_E = np.trapz(E_t, t_grid)\n        \n        # Calculate the base flip angle in radians (for s=1)\n        alpha_base_rad = GAMMA * integral_E\n        \n        # Calculate the flip angle for each voxel in the spatial map\n        # Flatten the map for easier computation of statistics\n        s_values = s_map.flatten()\n        alpha_map_rad = s_values * alpha_base_rad\n        \n        # Convert flip angles to degrees\n        alpha_map_deg = np.degrees(alpha_map_rad)\n        \n        # Compute summary statistics\n        mean_angle = np.mean(alpha_map_deg)\n        # Population standard deviation (ddof=0 is the default)\n        std_dev_angle = np.std(alpha_map_deg, ddof=0)\n        # Range (max - min)\n        range_angle = np.ptp(alpha_map_deg)\n        \n        return mean_angle, std_dev_angle, range_angle\n\n    # --- Test Case 1: Uniform B1+, Rectangular Pulse ---\n    s_map_1 = np.ones((3, 3, 1))\n    B1_amp_1 = 10e-6  # Tesla\n    tau_1 = 1e-3      # seconds\n    dt_1 = 1e-6       # seconds\n    E_func_1 = lambda t: np.full_like(t, B1_amp_1)\n    \n    metrics_1 = process_case(s_map_1, E_func_1, 0, tau_1, dt_1)\n    results.extend(metrics_1)\n\n    # --- Test Case 2: Linearly Varying B1+, Gaussian Pulse ---\n    s_map_2 = np.array([0.8, 0.8 + 0.4 / 3, 0.8 + 2 * 0.4 / 3, 1.2])\n    B1_amp_2 = 8e-6   # Tesla\n    sigma_2 = 0.3e-3  # seconds\n    t_half_dur_2 = 1.2e-3  # seconds\n    dt_2 = 1e-6       # seconds\n    E_func_2 = lambda t: B1_amp_2 * np.exp(-t**2 / (2 * sigma_2**2))\n\n    metrics_2 = process_case(s_map_2, E_func_2, -t_half_dur_2, t_half_dur_2, dt_2)\n    results.extend(metrics_2)\n\n    # --- Test Case 3: Heterogeneous B1+, Half-Sine Pulse ---\n    s_map_3 = np.array([0.0, 0.5, 1.0, 1.5])\n    B1_amp_3 = 6e-6   # Tesla\n    tau_3 = 2e-3      # seconds\n    dt_3 = 1e-6       # seconds\n    E_func_3 = lambda t: B1_amp_3 * np.sin(np.pi * t / tau_3)\n\n    metrics_3 = process_case(s_map_3, E_func_3, 0, tau_3, dt_3)\n    results.extend(metrics_3)\n    \n    # Format the final output string as required\n    # Each value rounded to three decimal places\n    output_str = f\"[{','.join(f'{x:.3f}' for x in results)}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}