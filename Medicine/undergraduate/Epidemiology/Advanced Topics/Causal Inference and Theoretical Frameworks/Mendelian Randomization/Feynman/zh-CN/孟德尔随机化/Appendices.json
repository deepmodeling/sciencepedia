{
    "hands_on_practices": [
        {
            "introduction": "孟德尔随机化（MR）分析的核心在于利用遗传变异作为工具变量来推断因果关系。本练习将带您实践最基础的孟德尔随机化计算：使用单个遗传变异的汇总统计数据计算瓦尔德比率（Wald ratio）估计值。通过这个练习，您将学会如何利用来自两个独立样本的数据，估算暴露对结局的因果效应，并使用德尔塔方法（delta method）来量化该估计值的不确定性，这是理解双样本MR分析的基石。",
            "id": "4611689",
            "problem": "在一个两样本孟德尔随机化（MR）分析中，一个单个遗传变异被用作一个连续暴露的工具变量。假设标准的工具变量条件成立：相关性（遗传变异影响暴露）、独立性（遗传变异独立于暴露-结局关系的混杂因素）和排他性限定（遗传变异仅通过暴露影响结局）。在来自研究A的一个大样本中，对暴露与遗传变异进行线性回归，得到汇总关联估计值 $\\hat{\\beta}_{XG}$，其标准误为 $SE(\\hat{\\beta}_{XG})$。在来自研究B的另一个独立的大样本中，对二元结局与同一遗传变异进行逻辑斯谛回归，得到对数几率关联估计值 $\\hat{\\beta}_{YG}$，其标准误为 $SE(\\hat{\\beta}_{YG})$。将这两个样本视为独立的，并在对数几率尺度上解释遗传变异对结局的影响。\n\n给定以下汇总统计数据：\n- 研究A：$\\hat{\\beta}_{XG} = 0.08$ 且 $SE(\\hat{\\beta}_{XG}) = 0.01$。\n- 研究B：$\\hat{\\beta}_{YG} = 0.024$ 且 $SE(\\hat{\\beta}_{YG}) = 0.006$。\n\n利用核心的工具变量恒等式，即在这些假设下，因果效应等于遗传与结局的关联除以遗传与暴露的关联，构建暴露对结局的因果对数几率效应的比率估计量。然后，使用针对独立估计量的平滑函数的一阶泰勒级数（delta方法）近似，推导出该比率估计量的近似标准误。最后，计算Wald检验统计量 $z = \\hat{\\beta}_{W} / SE(\\hat{\\beta}_{W})$，用于检验因果效应为零的零假设。\n\n仅报告z的值，四舍五入到四位有效数字。最终答案中不要包含任何单位。",
            "solution": "用户希望计算使用两样本孟德尔随机化（MR）估计的因果效应的Wald检验统计量。\n\n### 步骤1：问题验证\n根据指定标准验证问题陈述。\n\n**1. 提取已知条件：**\n- 一个单个遗传变异是连续暴露（$X$）和二元结局（$Y$）的工具变量（IV）。\n- 假设三个核心IV假设（相关性、独立性、排他性限定）成立。\n- 该分析是一个两样本MR，估计值来自两个独立的研究。\n- 研究A（暴露样本）：\n    - 遗传与暴露的关联：$\\hat{\\beta}_{XG} = 0.08$。\n    - 该关联的标准误：$SE(\\hat{\\beta}_{XG}) = 0.01$。\n- 研究B（结局样本）：\n    - 遗传与结局对数几率的关联：$\\hat{\\beta}_{YG} = 0.024$。\n    - 该关联的标准误：$SE(\\hat{\\beta}_{YG}) = 0.006$。\n- 任务是计算零假设（无因果效应）的Wald检验统计量 $z = \\hat{\\beta}_{W} / SE(\\hat{\\beta}_{W})$，其中 $\\hat{\\beta}_{W}$ 是因果效应的比率估计量。\n\n**2. 使用提取的已知条件进行验证：**\n- **科学依据：** 该问题描述了一个标准的双样本孟德尔随机化分析，这是流行病学中广泛使用和验证的方法。工具变量假设、比率估计量和delta方法的使用都是该方法的核心组成部分。\n- **定义明确：** 该问题提供了所有必要的数据，并明确指定了用于计算单个、明确定义的量（Wald统计量）的方法（比率估计、delta方法）。\n- **客观性：** 该问题使用精确、定量和客观的语言陈述。\n\n**3. 结论与行动：**\n该问题科学合理、定义明确、客观且完整。因此被判定为**有效**。现在开始构建解决方案。\n\n### 步骤2：求解\n暴露 $X$ 对结局 $Y$ 的对数几率的因果效应记为 $\\beta_W$。在工具变量假设下，遗传与结局的关联（$\\beta_{YG}$）是因果效应与遗传与暴露的关联（$\\beta_{XG}$）的乘积：\n$$ \\beta_{YG} = \\beta_W \\cdot \\beta_{XG} $$\n因此，因果效应的比率估计量（也称为Wald估计量）由两个关联估计值的比率给出：\n$$ \\hat{\\beta}_W = \\frac{\\hat{\\beta}_{YG}}{\\hat{\\beta}_{XG}} $$\n使用所提供的值，我们可以计算因果效应的点估计：\n$$ \\hat{\\beta}_W = \\frac{0.024}{0.08} = 0.3 $$\n该值表示暴露每增加一个单位，结局的对数几率估计增加 $0.3$。\n\n为了构建Wald检验统计量，我们需要该估计量的标准误 $SE(\\hat{\\beta}_W)$。问题指定使用一阶泰勒级数近似（delta方法）来求此值。设我们的估计量是两个随机变量的函数 $f(x, y) = y/x$，其中 $x = \\hat{\\beta}_{XG}$ 且 $y = \\hat{\\beta}_{YG}$。该函数的方差可以近似为：\n$$ \\text{Var}(f(x, y)) \\approx \\left(\\frac{\\partial f}{\\partial x}\\right)^2 \\text{Var}(x) + \\left(\\frac{\\partial f}{\\partial y}\\right)^2 \\text{Var}(y) + 2 \\left(\\frac{\\partial f}{\\partial x}\\right) \\left(\\frac{\\partial f}{\\partial y}\\right) \\text{Cov}(x, y) $$\n$f(x, y)$ 的偏导数是：\n$$ \\frac{\\partial f}{\\partial x} = -\\frac{y}{x^2} \\quad \\text{和} \\quad \\frac{\\partial f}{\\partial y} = \\frac{1}{x} $$\n由于估计值 $\\hat{\\beta}_{XG}$ 和 $\\hat{\\beta}_{YG}$ 来自两个独立的样本，它们的协方差为零，即 $\\text{Cov}(\\hat{\\beta}_{XG}, \\hat{\\beta}_{YG}) = 0$。方差公式简化为：\n$$ \\text{Var}(\\hat{\\beta}_W) \\approx \\left(-\\frac{\\hat{\\beta}_{YG}}{\\hat{\\beta}_{XG}^2}\\right)^2 \\text{Var}(\\hat{\\beta}_{XG}) + \\left(\\frac{1}{\\hat{\\beta}_{XG}}\\right)^2 \\text{Var}(\\hat{\\beta}_{YG}) $$\n一个估计量的方差是其标准误的平方，因此 $\\text{Var}(\\hat{\\beta}) = [SE(\\hat{\\beta})]^2$。将此关系代入公式，得到因果效应估计量的平方标准误的表达式：\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{\\hat{\\beta}_{YG}^2}{\\hat{\\beta}_{XG}^4} [SE(\\hat{\\beta}_{XG})]^2 + \\frac{1}{\\hat{\\beta}_{XG}^2} [SE(\\hat{\\beta}_{YG})]^2 $$\n现在我们代入给定的数值：\n- $\\hat{\\beta}_{XG} = 0.08$\n- $SE(\\hat{\\beta}_{XG}) = 0.01$\n- $\\hat{\\beta}_{YG} = 0.024$\n- $SE(\\hat{\\beta}_{YG}) = 0.006$\n\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{(0.024)^2}{(0.08)^4} (0.01)^2 + \\frac{1}{(0.08)^2} (0.006)^2 $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{0.000576}{0.00004096} (0.0001) + \\frac{1}{0.0064} (0.000036) $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx (14.0625) \\times (0.0001) + (156.25) \\times (0.000036) $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx 0.00140625 + 0.005625 $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx 0.00703125 $$\n标准误是方差的平方根：\n$$ SE(\\hat{\\beta}_W) = \\sqrt{0.00703125} \\approx 0.08385256... $$\n最后，我们计算零假设 $H_0: \\beta_W = 0$ 的Wald检验统计量 $z$：\n$$ z = \\frac{\\hat{\\beta}_W}{SE(\\hat{\\beta}_W)} $$\n$$ z = \\frac{0.3}{0.08385256...} \\approx 3.57770876... $$\n四舍五入到四位有效数字，我们得到：\n$$ z \\approx 3.578 $$",
            "answer": "$$\\boxed{3.578}$$"
        },
        {
            "introduction": "一个有效的工具变量必须满足相关性假设，即它必须与暴露因素相关。本练习旨在帮助您掌握如何评估遗传工具变量的强度，这是进行任何孟德尔随机化分析前至关重要的一步。您将学会推导并计算由一组独立单核苷酸多态性（SNPs）解释的暴露变异比例（$R^2$），从而判断这些遗传变异是否是足够强大的工具。",
            "id": "4611703",
            "problem": "一位研究人员正在进行孟德尔随机化分析，使用多个独立的单核苷酸多态性 (SNP) 作为连续暴露的工具变量。第一阶段模型是暴露对每个SNP的线性回归，其中SNP被加性编码为等位基因计数，取值为 $ \\{0,1,2\\} $。假设以下广为接受的事实成立：\n- 在哈迪-温伯格平衡 (HWE) 下，如果效应等位基因频率为 $p$，那么加性基因型的方差为 $\\operatorname{Var}(G)=2p(1-p)$。\n- 在连续暴露 $X$ 对单个回归量 $G$ 的简单线性回归中，由 $G$ 解释的 $X$ 的方差比例为 $R^{2}=\\operatorname{Var}\\left(\\mathbb{E}[X\\mid G]\\right)/\\operatorname{Var}(X)$。\n- 当包含多个独立回归量 $ \\{G_i\\} $ 时，由它们的线性组合解释的方差是各自解释方差的总和，因为协方差为零。\n\n给定来自一项关于暴露的全基因组关联研究 (GWAS) 的4个独立SNP的汇总关联估计值。对于SNP $i$，用 $\\hat{\\beta}_{XG,i}$ 表示与暴露的每个等位基因的估计关联，用 $p_{i}$ 表示效应等位基因频率。GWAS样本中暴露的方差为 $\\operatorname{Var}(X)=0.81$。\n\n数据：\n- SNP A：$p_{A}=0.30$，$\\hat{\\beta}_{XG,A}=0.08$。\n- SNP B：$p_{B}=0.45$，$\\hat{\\beta}_{XG,B}=0.05$。\n- SNP C：$p_{C}=0.15$，$\\hat{\\beta}_{XG,C}=0.10$。\n- SNP D：$p_{D}=0.10$，$\\hat{\\beta}_{XG,D}=0.04$。\n\n任务：\n1. 从上述定义出发，并且不引用任何预先给出的目标公式，推导由单个SNP $i$ 解释的第一阶段方差 $R^{2}_{i}$ 的封闭式表达式，该表达式用 $p_{i}$、$\\hat{\\beta}_{XG,i}$ 和 $\\operatorname{Var}(X)$ 表示。\n2. 利用SNP的独立性，推广你的表达式，以获得由工具变量集 $ \\{\\text{A},\\text{B},\\text{C},\\text{D}\\} $ 解释的组合第一阶段方差 $R^{2}_{\\text{total}}$。\n3. 以小数形式计算 $R^{2}_{\\text{total}}$。将你的最终答案四舍五入到 $4$ 位有效数字。将答案表示为一个纯数（无单位）。",
            "solution": "用户提供了一个遗传流行病学领域的问题，具体涉及孟德尔随机化 (MR)。任务是推导一个由遗传工具变量解释的暴露方差的表达式，然后使用提供的汇总统计数据计算该值。\n\n### 问题验证\n\n首先，必须对问题陈述的科学合理性、清晰度和完整性进行验证。\n\n**步骤1：提取已知条件**\n-   第一阶段模型是连续暴露 $X$ 对单个单核苷酸多态性 (SNP) $G_i$ 的线性回归，其中 $G_i$ 被加性编码为效应等位基因的数量，取值为 $ \\{0, 1, 2\\} $。\n-   在哈迪-温伯格平衡 (HWE) 下，加性基因型 $G$ 的方差由 $\\operatorname{Var}(G)=2p(1-p)$ 给出，其中 $p$ 是效应等位基因频率。\n-   由 $G$ 解释的 $X$ 的方差比例，记为 $R^2$，定义为 $R^{2}=\\operatorname{Var}\\left(\\mathbb{E}[X\\mid G]\\right)/\\operatorname{Var}(X)$。\n-   对于多个独立的SNP $ \\{G_i\\} $，总解释方差是每个SNP单独解释的方差之和。\n-   该分析涉及4个独立的SNP：A、B、C和D。\n-   对于每个SNP $i$，每个等位基因的关联估计值为 $\\hat{\\beta}_{XG,i}$，效应等位基因频率为 $p_i$。\n-   暴露的方差为 $\\operatorname{Var}(X)=0.81$。\n-   提供的数据：\n    -   SNP A：$p_{A}=0.30$，$\\hat{\\beta}_{XG,A}=0.08$。\n    -   SNP B：$p_{B}=0.45$，$\\hat{\\beta}_{XG,B}=0.05$。\n    -   SNP C：$p_{C}=0.15$，$\\hat{\\beta}_{XG,C}=0.10$。\n    -   SNP D：$p_{D}=0.10$，$\\hat{\\beta}_{XG,D}=0.04$。\n\n**步骤2：使用提取的已知条件进行验证**\n-   **科学依据：** 该问题牢固地植根于孟德尔随机化背后的既定统计学和遗传学原理。公式 $\\operatorname{Var}(G)=2p(1-p)$ 是在HWE下加性编码SNP的一个标准结果。$R^2$ 的定义是回归分析中的一个基本概念。合并来自独立预测变量的解释方差的方法也是标准的。所有概念都是遗传流行病学领域的核心。\n-   **适定性：** 该问题清晰地划分为三个任务：推导、推广和计算。所提供的数据足以且有必要完成所有任务。该问题导向一个唯一且有意义的解。\n-   **客观性：** 问题以精确、技术性的语言陈述，没有任何主观性或模糊性。\n\n**步骤3：结论与行动**\n该问题具有科学合理性、适定性和客观性。它满足有效问题的所有标准。因此，将提供一个完整的解答。\n\n---\n\n### 解答推导与计算\n\n**任务1：推导单个SNP的 $R^{2}_{i}$ 的封闭式表达式。**\n\n第一阶段模型是暴露 $X$ 对单个SNP $i$ 的基因型 $G_i$ 的简单线性回归。给定 $G_i$ 时 $X$ 的条件期望是：\n$$\n\\mathbb{E}[X \\mid G_i] = \\alpha_i + \\beta_{XG,i} G_i\n$$\n其中 $\\beta_{XG,i}$ 是SNP与暴露的每个等位基因的关联。\n\n由 $G_i$ 解释的 $X$ 的方差比例，记为 $R^2_i$，由定义给出：\n$$\nR^2_i = \\frac{\\operatorname{Var}(\\mathbb{E}[X \\mid G_i])}{\\operatorname{Var}(X)}\n$$\n\n我们需要求条件期望的方差，即分子。利用方差的性质，其中 $\\alpha_i$ 和 $\\beta_{XG,i}$ 被视为回归中的固定系数：\n$$\n\\operatorname{Var}(\\mathbb{E}[X \\mid G_i]) = \\operatorname{Var}(\\alpha_i + \\beta_{XG,i} G_i) = \\beta_{XG,i}^2 \\operatorname{Var}(G_i)\n$$\n\n问题陈述，在HWE下，加性编码基因型 $G_i$ 的方差为：\n$$\n\\operatorname{Var}(G_i) = 2p_i(1-p_i)\n$$\n其中 $p_i$ 是SNP $i$ 的效应等位基因频率。\n\n将 $\\operatorname{Var}(G_i)$ 的这个表达式代入条件期望的方差方程，我们得到：\n$$\n\\operatorname{Var}(\\mathbb{E}[X \\mid G_i]) = \\beta_{XG,i}^2 [2p_i(1-p_i)]\n$$\n\n最后，将此结果代回 $R^2_i$ 的定义中，我们得到封闭式表达式。在实践中，我们使用来自GWAS的估计系数 $\\hat{\\beta}_{XG,i}$，因此估计的解释方差为：\n$$\nR^2_i = \\frac{2p_i(1-p_i)\\hat{\\beta}_{XG,i}^2}{\\operatorname{Var}(X)}\n$$\n这完成了第一个任务。\n\n**任务2：推广表达式以获得组合的第一阶段解释方差 $R^{2}_{\\text{total}}$。**\n\n问题陈述这4个SNP是独立的。独立随机变量的一个关键性质是，包含它们的线性模型所解释的方差是每个变量单独解释的方差之和。因此，总解释方差比例 $R^2_{\\text{total}}$ 是集合 $ \\{\\text{A}, \\text{B}, \\text{C}, \\text{D}\\} $ 中每个SNP的单个 $R^2_i$ 值之和。\n$$\nR^2_{\\text{total}} = \\sum_{i \\in \\{\\text{A,B,C,D}\\}} R^2_i\n$$\n\n代入任务1中推导的表达式：\n$$\nR^2_{\\text{total}} = \\sum_{i \\in \\{\\text{A,B,C,D}\\}} \\frac{2p_i(1-p_i)\\hat{\\beta}_{XG,i}^2}{\\operatorname{Var}(X)}\n$$\n\n由于 $\\operatorname{Var}(X)$ 和因子 $2$ 对所有项都是公共的，我们可以将表达式写为：\n$$\nR^2_{\\text{total}} = \\frac{2}{\\operatorname{Var}(X)} \\sum_{i \\in \\{\\text{A,B,C,D}\\}} p_i(1-p_i)\\hat{\\beta}_{XG,i}^2\n$$\n这是组合解释方差的推广表达式。\n\n**任务3：以小数形式计算 $R^{2}_{\\text{total}}$，并四舍五入到4位有效数字。**\n\n我们已知 $\\operatorname{Var}(X) = 0.81$。现在我们将为四个SNP中的每一个计算项 $p_i(1-p_i)\\hat{\\beta}_{XG,i}^2$。\n\n-   **SNP A：**\n    $p_A(1-p_A)\\hat{\\beta}_{XG,A}^2 = (0.30)(1-0.30)(0.08)^2 = (0.30)(0.70)(0.0064) = (0.21)(0.0064) = 0.001344$\n\n-   **SNP B：**\n    $p_B(1-p_B)\\hat{\\beta}_{XG,B}^2 = (0.45)(1-0.45)(0.05)^2 = (0.45)(0.55)(0.0025) = (0.2475)(0.0025) = 0.00061875$\n\n-   **SNP C：**\n    $p_C(1-p_C)\\hat{\\beta}_{XG,C}^2 = (0.15)(1-0.15)(0.10)^2 = (0.15)(0.85)(0.01) = (0.1275)(0.01) = 0.001275$\n\n-   **SNP D：**\n    $p_D(1-p_D)\\hat{\\beta}_{XG,D}^2 = (0.10)(1-0.10)(0.04)^2 = (0.10)(0.90)(0.0016) = (0.09)(0.0016) = 0.000144$\n\n接下来，我们对这些值求和：\n$$\n\\sum_{i} p_i(1-p_i)\\hat{\\beta}_{XG,i}^2 = 0.001344 + 0.00061875 + 0.001275 + 0.000144 = 0.00338175\n$$\n\n现在，我们使用 $R^2_{\\text{total}}$ 的公式：\n$$\nR^2_{\\text{total}} = \\frac{2}{\\operatorname{Var}(X)} \\sum_{i} p_i(1-p_i)\\hat{\\beta}_{XG,i}^2 = \\frac{2}{0.81} (0.00338175)\n$$\n$$\nR^2_{\\text{total}} = \\frac{0.0067635}{0.81} = 0.00835\n$$\n结果恰好是 $0.00835$。问题要求将最终答案四舍五入到4位有效数字。非零的有效数字是 $8$、$3$ 和 $5$。为了用四位有效数字表示，我们在末尾加一个零。\n\n$R^2_{\\text{total}} \\approx 0.008350$。",
            "answer": "$$\n\\boxed{0.008350}\n$$"
        },
        {
            "introduction": "在实际研究中，我们通常使用多个遗传变异来增强统计功效。然而，多工具变量的引入也带来了新的挑战，如水平多效性（horizontal pleiotropy）。本练习将指导您通过编程实现一个完整的孟德尔随机化分析流程，从计算标准的因果效应估计值（如反方差加权法，IVW）到实施敏感性分析（如MR-Egger回归），并学习如何通过生成散点图和漏斗图来直观地评估结果的稳健性。",
            "id": "2404096",
            "problem": "在孟德尔随机化 (Mendelian randomization, MR) 的设定下，您将获得来自全基因组关联研究 (Genome-Wide Association Study, GWAS) 的汇总关联数据。这些数据涉及多个工具变量，每个工具变量都是一个单核苷酸多态性 (Single Nucleotide Polymorphism, SNP)。对于每个 SNP，您拥有其与暴露的关联效应值，记为 $ \\beta_{GX,i} $，以及其与结局的关联效应值，记为 $ \\beta_{GY,i} $，同时还有结局关联效应值的标准误 $ \\sigma_{GY,i} $。假设遵循以下基本原则：(i) 暴露-结局关系服从线性因果模型；(ii) 除了任何潜在的水平多效性外，工具变量仅通过暴露影响结局；(iii) $ \\beta_{GY,i} $ 的抽样变异由 $ \\sigma_{GY,i} $ 来量化，并且出于加权目的，$ \\beta_{GX,i} $ 的不确定性相对于 $ \\sigma_{GY,i} $ 可以忽略不计；(iv) 因果效应可以通过使用加权最小二乘法聚合每个变异位点的信息来估计。\n\n您的任务是编写一个完整的程序，为下述每个测试用例计算生成以下图形所需的数值对象：(a) 一个 $ \\beta_{GY} $ 相对于 $ \\beta_{GX} $ 的散点图，图中包含截距约束的逆方差加权 (Inverse-Variance Weighted, IVW) 回归线和孟德尔随机化艾格 (Mendelian randomization Egger, MR-Egger) 回归线；(b) 一个比率估计值相对于其标准误的漏斗图，用于直观地检查异质性和多效性。您的程序无需绘制任何图形，但必须返回定义这些图形的精确数值。\n\n请仅从上述基本原则出发，为每个测试用例实现以下计算：\n- 使用由结局方差的倒数定义的权重 $ w_i $，即 $ w_i $ 与 $ 1 / \\sigma_{GY,i}^2 $ 成正比。\n- 通过求解截距固定为零的加权最小二乘问题，计算截距约束的 IVW 因果斜率估计值，该问题旨在最小化 $ \\sum_i w_i \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right)^2 $（对 $ b $ 进行优化）。\n- 通过最小化 $ \\sum_i w_i \\left( \\beta_{GY,i} - a - b \\, \\beta_{GX,i} \\right)^2 $（对 $ a $ 和 $ b $ 进行优化），计算具有无约束截距的 MR-Egger 加权回归线。\n- 在 IVW 拟合下，计算用于检验异质性的 Cochran’s $ Q $ 统计量和相应的 $ I^2 $ 异质性度量，其中 $ Q $ 比较加权残差的离散程度与其在同质性假设下的期望值。\n- 对于漏斗图，在 $ \\beta_{GX,i} $ 的不确定性相对于 $ \\sigma_{GY,i} $ 可以忽略的假设下，计算每个变异位点的比率估计值 $ \\theta_i $ 及其近似标准误 $ s_i $。然后，围绕合并的 IVW 效应，为每个变异位点计算伪 $ 95\\% $ 漏斗边界，公式为 $ \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i $。\n\n您的程序必须将这些计算应用于以下测试套件。每个测试用例由三个等长的列表定义：$ \\beta_{GX} $、$ \\beta_{GY} $ 和 $ \\sigma_{GY} $。\n\n测试用例 A (理想情况；一致的工具变量)：\n- $ \\beta_{GX} = [\\, 0.08, \\, 0.12, \\, 0.10, \\, 0.15, \\, 0.07, \\, 0.11 \\,] $\n- $ \\beta_{GY} = [\\, 0.040, \\, 0.060, \\, 0.051, \\, 0.072, \\, 0.033, \\, 0.057 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.018, \\, 0.022, \\, 0.019, \\, 0.021, \\, 0.020 \\,] $\n\n测试用例 B (方向性多效性；预期截距非零)：\n- $ \\beta_{GX} = [\\, 0.05, \\, -0.04, \\, 0.09, \\, 0.12, \\, 0.03, \\, 0.07 \\,] $\n- $ \\beta_{GY} = [\\, 0.037, \\, 0.007, \\, 0.048, \\, 0.054, \\, 0.029, \\, 0.042 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.021, \\, 0.019, \\, 0.018, \\, 0.022, \\, 0.020 \\,] $\n\n测试用例 C (异质性和一个弱工具变量)：\n- $ \\beta_{GX} = [\\, 0.20, \\, 0.15, \\, 0.10, \\, 0.05, \\, 0.004 \\,] $\n- $ \\beta_{GY} = [\\, 0.080, \\, 0.070, \\, 0.045, \\, 0.050, \\, 0.010 \\,] $\n- $ \\sigma_{GY} = [\\, 0.015, \\, 0.015, \\, 0.016, \\, 0.020, \\, 0.020 \\,] $\n\n测试用例 D (平衡多效性；存在异质性但截距近似为零)：\n- $ \\beta_{GX} = [\\, 0.10, \\, 0.12, \\, 0.09, \\, 0.11, \\, 0.08 \\,] $\n- $ \\beta_{GY} = [\\, 0.080, \\, 0.052, \\, 0.064, \\, 0.056, \\, 0.048 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.020, \\, 0.020, \\, 0.020, \\, 0.020 \\,] $\n\n实现和数值要求：\n- 将所有权重视为 $ w_i = 1 / \\sigma_{GY,i}^2 $。\n- 对于漏斗图，计算 $ \\theta_i = \\beta_{GY,i} / \\beta_{GX,i} $ 和 $ s_i = \\sigma_{GY,i} / \\lvert \\beta_{GX,i} \\rvert $。\n- 在漏斗图边界 $ \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i $ 中，使用 IVW 斜率作为合并效应。\n- 对于 IVW 拟合下的 Cochran 异质性统计量，计算 $ Q $，然后计算 $ I^2 = \\max \\left( 0, \\, \\dfrac{Q - (M - 1)}{Q} \\right) $，其中 $ M $ 是变异位点的数量。如果 $ Q = 0 $，则设 $ I^2 = 0 $。\n- 对于每个测试用例，您的程序必须按以下顺序输出一个包含九个元素的列表：\n  1. IVW 斜率 (一个浮点数),\n  2. MR-Egger 斜率 (一个浮点数),\n  3. MR-Egger 截距 (一个浮点数),\n  4. IVW Cochran’s $ Q $ (一个浮点数),\n  5. IVW $ I^2 $ (一个浮点数),\n  6. 比率估计值列表 $ [ \\theta_i ] $,\n  7. 比率标准误列表 $ [ s_i ] $,\n  8. 漏斗图下界列表 $ [ \\theta_{\\text{IVW}} - 1.96 \\, s_i ] $,\n  9. 漏斗图上界列表 $ [ \\theta_{\\text{IVW}} + 1.96 \\, s_i ] $。\n- 将所有浮点数四舍五入至六位小数。\n- 最终输出格式：您的程序应生成单行输出，其中包含四个测试用例的结果，这些结果聚合为一个逗号分隔的列表，并用方括号括起来，不含空格。即，形式为 $ [r_A, r_B, r_C, r_D] $ 的单行，其中每个 $ r_\\cdot $ 是上述的九元素列表。\n\n边界条件与科学真实性：\n- 确保 $ \\lvert \\beta_{GX,i} \\rvert $ 不为零，以避免在比率计算中出现除以零的情况。所提供的测试套件满足此条件；一般而言，如果任何 $ \\lvert \\beta_{GX,i} \\rvert $ 低于某个小阈值 $ \\varepsilon $，则应在比率和漏斗图相关计算中排除该变异位点，同时如果处理得当，在回归拟合中保持一致性。在此测试套件中，無需进行排除。",
            "solution": "问题陈述经评估有效。它在科学上基于孟德尔随机化 (Mendelian randomization, MR) 的既定原则，这是一种遗传流行病学中的标准方法。该问题设定良好，提供了所有必要的数据和所需计算的明确数学定义。语言客观、正式，没有歧义或主觀论断。它提出了一个基于可验证的统计学和数学原理的可解计算任务。\n\n我们现在将系统地推导所需的量。背景是使用遗传变异作为工具变量来估计暴露对结局的因果效应。对于 M 个遗传变异（SNP）中的每一个，我们都给出了其与暴露的估计关联效应值 $\\beta_{GX,i}$、与结局的估计关联效应值 $\\beta_{GY,i}$，以及后者的标准误 $\\sigma_{GY,i}$。\n\n所有加权计算的权重由结局方差的倒数定义，并假设为此目的 $\\beta_{GX,i}$ 的不确定性可以忽略不计：\n$$\nw_i = \\frac{1}{\\sigma_{GY,i}^2}\n$$\n\n**1. 截距约束的逆方差加权 (IVW) 斜率**\n\nIVW 方法通过求解一个加权最小二乘问题来估计因果效应 $b$，该问题强制回归线通过原点。这对应于无水平多效性的假设。目标是最小化加权残差平方和：\n$$\nS(b) = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right)^2\n$$\n为了找到最小值，我们将关于 $b$ 的导数设为零：\n$$\n\\frac{dS}{db} = -2 \\sum_{i=1}^{M} w_i \\beta_{GX,i} \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right) = 0\n$$\n求解 $b$ 得到 IVW 估计值，我们记为 $\\theta_{\\text{IVW}}$：\n$$\n\\theta_{\\text{IVW}} = \\frac{\\sum_{i=1}^{M} w_i \\beta_{GX,i} \\beta_{GY,i}}{\\sum_{i=1}^{M} w_i \\beta_{GX,i}^2}\n$$\n\n**2. 孟德尔随机化艾格 (MR-Egger) 回归**\n\nMR-Egger 方法放宽了 IVW 方法的无多效性假设，允许在 $\\beta_{GY,i}$ 对 $\\beta_{GX,i}$ 的回归中存在非零截距。截距 $a$ 可被解释为平均方向性多效性效应的估计值，而斜率 $b$ 仍然是因果效应的估计值。我们在 $a$ 和 $b$ 上最小化以下目标函数：\n$$\nS(a, b) = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - a - b \\, \\beta_{GX,i} \\right)^2\n$$\n这是一个标准的加权线性回归问题。MR-Egger 斜率 ($b_{\\text{Egger}}$) 和截距 ($a_{\\text{Egger}}$) 的解由正规方程给出：\n$$\nb_{\\text{Egger}} = \\frac{ \\left(\\sum w_i\\right) \\left(\\sum w_i \\beta_{GX,i} \\beta_{GY,i}\\right) - \\left(\\sum w_i \\beta_{GX,i}\\right) \\left(\\sum w_i \\beta_{GY,i}\\right) }{ \\left(\\sum w_i\\right) \\left(\\sum w_i \\beta_{GX,i}^2\\right) - \\left(\\sum w_i \\beta_{GX,i}\\right)^2 }\n$$\n$$\na_{\\text{Egger}} = \\frac{\\sum w_i \\beta_{GY,i}}{\\sum w_i} - b_{\\text{Egger}} \\frac{\\sum w_i \\beta_{GX,i}}{\\sum w_i}\n$$\n这些公式对应于加权最小二乘回归系数的标准解。\n\n**3. Cochran’s Q 统计量和 I² 异质性度量**\n\n工具变量特异性因果估计值之间的异质性可能表明违反了 MR 假设（如多效性），或者表明对于不同工具变量所针对的不同人群子集，真实的因果效应有所不同。用于 IVW 模型的 Cochran’s $Q$ 统计量通过对单个比率估计值与合并的 IVW 估计值之间的加权平方差求和来量化这种异质性。其计算公式为：\n$$\nQ = \\sum_{i=1}^{M} w_i \\left( \\frac{\\beta_{GY,i}}{\\beta_{GX,i}} - \\theta_{\\text{IVW}} \\right)^2 \\beta_{GX,i}^2 = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - \\theta_{\\text{IVW}} \\beta_{GX,i} \\right)^2\n$$\n在同质性（即所有工具变量估计相同的因果效应）的原假设下，$Q$ 服从自由度为 $M-1$ 的卡方分布。\n\n$I^2$ 统计量描述了工具变量间的变异中由异质性而非抽样误差所占的百分比。它由 $Q$ 推导而来：\n$$\nI^2 = \\max\\left(0, \\frac{Q - (M-1)}{Q}\\right)\n$$\n如果 $Q=0$（这在实践中极不可能），$I^2$ 定义为 $0$。\n\n**4. 漏斗图组件**\n\n漏斗图是一种用于研究异质性和发表偏倚的可视化工具。它绘制了每个工具变量的效应大小与其精确度的度量之间的关系。\n\n-   **每个变异位点的比率估计值 ($\\theta_i$):** 这是从单个工具变量 $i$ 估计出的因果效应：\n    $$\n    \\theta_i = \\frac{\\beta_{GY,i}}{\\beta_{GX,i}}\n    $$\n-   **比率估计值的标准误 ($s_i$):** 使用 delta 方法，并假设 $\\beta_{GX,i}$ 的测量误差可以忽略不计，$\\theta_i$ 的标准误近似为：\n    $$\n    s_i = \\text{SE}(\\theta_i) \\approx \\frac{\\sigma_{GY,i}}{\\lvert \\beta_{GX,i} \\rvert}\n    $$\n-   **漏斗图边界:** 漏斗围绕合并的 IVW 因果估计值 $\\theta_{\\text{IVW}}$ 构建。对于一个伪 $95\\%$ 置信区间，每个变异位点 $i$ 的边界为：\n    $$\n    \\text{Bounds}_i = \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i\n    $$\n    下界和上界分别为 $\\theta_{\\text{IVW}} - 1.96 \\, s_i$ 和 $\\theta_{\\text{IVW}} + 1.96 \\, s_i$。\n\n实现过程将为每个提供的测试用例计算这九个量：IVW 斜率、MR-Egger 斜率和截距、IVW 拟合的 Cochran's $Q$ 和 $I^2$ 统计量，以及比率估计值列表、它们的标准误以及相应的漏斗图下界和上界。所有浮点数将按要求四舍五入至六位小数。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_mr_metrics(beta_gx: list[float], beta_gy: list[float], sigma_gy: list[float]) -> list:\n    \"\"\"\n    Computes Mendelian randomization metrics for a given set of summary statistics.\n\n    Args:\n        beta_gx: List of SNP-exposure associations.\n        beta_gy: List of SNP-outcome associations.\n        sigma_gy: List of standard errors for SNP-outcome associations.\n\n    Returns:\n        A list containing nine elements as specified in the problem description.\n    \"\"\"\n    # Convert lists to NumPy arrays for vectorized operations\n    bgx = np.array(beta_gx)\n    bgy = np.array(beta_gy)\n    sgy = np.array(sigma_gy)\n    \n    # 1. Weights\n    # w_i = 1 / sigma_GY,i^2\n    w = 1.0 / (sgy**2)\n    \n    # 2. IVW Slope (Intercept-constrained)\n    # theta_ivw = (sum w_i * beta_gx_i * beta_gy_i) / (sum w_i * beta_gx_i^2)\n    ivw_numerator = np.sum(w * bgx * bgy)\n    ivw_denominator = np.sum(w * bgx**2)\n    ivw_slope = ivw_numerator / ivw_denominator\n    \n    # 3. MR-Egger Slope and Intercept\n    # Weighted least squares regression of bgy on bgx with weights w\n    W = np.sum(w)\n    Swx = np.sum(w * bgx)\n    Swy = np.sum(w * bgy)\n    Swxx = np.sum(w * bgx**2)\n    Swxy = np.sum(w * bgx * bgy)\n    \n    egger_denominator = (W * Swxx - Swx**2)\n    if egger_denominator == 0:\n        # This case is unlikely with real data but handle for robustness\n        mr_egger_slope = np.nan\n        mr_egger_intercept = np.nan\n    else:\n        mr_egger_slope = (W * Swxy - Swx * Swy) / egger_denominator\n        mr_egger_intercept = (Swy / W) - mr_egger_slope * (Swx / W)\n\n    # 4. Cochran's Q for IVW\n    # Q = sum w_i * (beta_gy_i - theta_ivw * beta_gx_i)^2\n    cochran_q = np.sum(w * (bgy - ivw_slope * bgx)**2)\n    \n    # 5. I^2 for IVW\n    M = len(bgx)\n    df = M - 1\n    if cochran_q == 0:\n        i_squared = 0.0\n    else:\n        i_squared = max(0.0, (cochran_q - df) / cochran_q)\n\n    # 6. Ratio estimates (theta_i)\n    # theta_i = beta_gy_i / beta_gx_i\n    theta_i = bgy / bgx\n    \n    # 7. Ratio standard errors (s_i)\n    # s_i = sigma_gy_i / |beta_gx_i|\n    s_i = sgy / np.abs(bgx)\n    \n    # 8.  9. Funnel plot bounds\n    # lower/upper = theta_ivw +/- 1.96 * s_i\n    z_score = 1.96\n    funnel_lower_bounds = ivw_slope - z_score * s_i\n    funnel_upper_bounds = ivw_slope + z_score * s_i\n    \n    # Assemble results and round to 6 decimal places\n    results = [\n        round(ivw_slope, 6),\n        round(mr_egger_slope, 6),\n        round(mr_egger_intercept, 6),\n        round(cochran_q, 6),\n        round(i_squared, 6),\n        [round(val, 6) for val in theta_i],\n        [round(val, 6) for val in s_i],\n        [round(val, 6) for val in funnel_lower_bounds],\n        [round(val, 6) for val in funnel_upper_bounds],\n    ]\n    \n    return results\n\ndef format_result_list(res_list: list) -> str:\n    \"\"\"Formats a single test case result list into the required string format.\"\"\"\n    str_parts = []\n    for item in res_list:\n        if isinstance(item, list):\n            formatted_list = f\"[{','.join([f'{x:.6f}' for x in item])}]\"\n            str_parts.append(formatted_list)\n        else:\n            str_parts.append(f\"{item:.6f}\")\n    return f\"[{','.join(str_parts)}]\"\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final output.\n    \"\"\"\n    test_cases = {\n        'A': {\n            \"beta_gx\": [0.08, 0.12, 0.10, 0.15, 0.07, 0.11],\n            \"beta_gy\": [0.040, 0.060, 0.051, 0.072, 0.033, 0.057],\n            \"sigma_gy\": [0.020, 0.018, 0.022, 0.019, 0.021, 0.020]\n        },\n        'B': {\n            \"beta_gx\": [0.05, -0.04, 0.09, 0.12, 0.03, 0.07],\n            \"beta_gy\": [0.037, 0.007, 0.048, 0.054, 0.029, 0.042],\n            \"sigma_gy\": [0.020, 0.021, 0.019, 0.018, 0.022, 0.020]\n        },\n        'C': {\n            \"beta_gx\": [0.20, 0.15, 0.10, 0.05, 0.004],\n            \"beta_gy\": [0.080, 0.070, 0.045, 0.050, 0.010],\n            \"sigma_gy\": [0.015, 0.015, 0.016, 0.020, 0.020]\n        },\n        'D': {\n            \"beta_gx\": [0.10, 0.12, 0.09, 0.11, 0.08],\n            \"beta_gy\": [0.080, 0.052, 0.064, 0.056, 0.048],\n            \"sigma_gy\": [0.020, 0.020, 0.020, 0.020, 0.020]\n        }\n    }\n\n    all_results_str = []\n    # Process cases in alphabetical order to match output format\n    for key in sorted(test_cases.keys()):\n        case = test_cases[key]\n        result = calculate_mr_metrics(case[\"beta_gx\"], case[\"beta_gy\"], case[\"sigma_gy\"])\n        all_results_str.append(format_result_list(result))\n\n    print(f\"[{','.join(all_results_str)}]\")\n\nsolve()\n```"
        }
    ]
}