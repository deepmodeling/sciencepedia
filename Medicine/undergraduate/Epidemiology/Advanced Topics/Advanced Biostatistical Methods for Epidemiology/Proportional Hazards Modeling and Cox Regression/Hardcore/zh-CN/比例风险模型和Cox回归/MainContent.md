## 引言
在医学研究和公共卫生领域，分析“从某个起点到特定事件发生所经历的时间”（即时间-事件数据）是理解疾病进展、评估治疗效果和识别风险因素的核心。然而，这类数据常伴随着一个独特的挑战——删失（censoring），即由于研究结束或个体失访，我们无法观测到所有研究对象的完整事件时间。传统的回归方法无法有效处理这种不完整信息，从而限制了我们从数据中获取洞见的能力。

为了解决这一关键问题，David R. Cox于1972年提出的[比例风险模型](@entry_id:171806)（或称Cox回归）应运而生，并迅速成为生存分析领域的基石。它提供了一个强大而灵活的框架，能够在不预设事件发生时间具体分布的情况下，量化协变量对事件风险的影响。

本文将带领读者系统性地掌握[Cox比例风险模型](@entry_id:174252)。我们将分三个章节展开：

首先，在“原理与机制”一章中，我们将奠定坚实的理论基础，从生存分析的基本概念讲起，深入剖析[Cox模型](@entry_id:164053)的数学构造、核心的[比例风险假设](@entry_id:163597)，以及其独创的参数估计方法——[偏似然](@entry_id:165240)法。

接着，在“应用与跨学科连接”一章中，我们将理论付诸实践，展示该模型在临床试验、流行病学研究中的广泛应用，并探讨其如何与因果推断、机器学习等前沿领域交叉融合，处理时变协变量、[竞争风险](@entry_id:173277)等复杂问题。

最后，在“动手实践”部分，读者将通过具体的计算练习，亲手构建和诊断模型，从而将理论知识内化为实践技能。

现在，让我们从最核心的原理与机制开始，踏上探索Cox比例风险模型的旅程。

## 原理与机制

在深入探讨[比例风险模型](@entry_id:171806)的具体应用之前，我们必须首先建立一个坚实的基础，理解其核心原理与内在机制。本章将系统性地阐述生存分析的基本概念、[Cox比例风险模型](@entry_id:174252)的数学构造、[参数估计](@entry_id:139349)的核心方法——[偏似然](@entry_id:165240)法，以及处理复杂数据结构（如时变协变量、分层和竞争风险）的扩展模型。

### 生存分析的基础概念

生存分析的核心是处理“事件发生时间”数据。与传统回归分析不同，[生存数据](@entry_id:165675)有两个关键特征：事件时间和删失（censoring）。

**事件时间与删失**

对于研究中的每个个体 $i$，我们关心的是一个特定的**事件时间** $T_i$，例如疾病复发、死亡或接受疫苗的时间。然而，由于多种原因（如研究结束、患者失访），我们可能无法观察到所有个体的确切事件时间。当我们在某个时间点之后无法再跟踪个体时，就发生了**右删失**（right censoring）。因此，我们实际观测到的是一个可能被删失的时间 $Y_i = \min(T_i, C_i)$，其中 $C_i$ 是删失时间。为了区分这两种情况，我们引入一个**事件指示变量** $\Delta_i$，如果事件被观察到（即 $T_i \le C_i$），则 $\Delta_i=1$；如果观测被删失（即 $T_i > C_i$），则 $\Delta_i=0$。因此，每个个体的基本数据单元是一个三元组：$(Y_i, \Delta_i, X_i)$，其中 $X_i$ 是协变量向量 。

**风险函数、生存函数与[概率密度函数](@entry_id:140610)**

为了描述事件随时间发生的动态过程，我们引入三个关键函数：

1.  **生存函数 (Survival Function)** $S(t) = \Pr(T > t)$：表示个体生存时间超过时间 $t$ 的概率。它是一个从 $1$（在 $t=0$ 时）单调递减至 $0$（当 $t \to \infty$ 时）的函数。

2.  **[概率密度函数](@entry_id:140610) (Probability Density Function)** $f(t)$：表示事件在时间点 $t$ 发生的瞬时[概率密度](@entry_id:143866)。$f(t) = -\frac{dS(t)}{dt}$。

3.  **[风险函数](@entry_id:166593) (Hazard Function)** $h(t)$：也称为瞬时风险率或[失效率](@entry_id:266388)，是生存分析的核心。它定义为在时间 $t$ 仍然存活（at risk）的条件下，在下一个极小时间间隔 $[t, t+\Delta t)$ 内发生事件的瞬时速率：
    $$
    h(t) = \lim_{\Delta t \to 0^+} \frac{\Pr(t \le T  t + \Delta t \mid T \ge t)}{\Delta t}
    $$
    风险函数描述了在任何给定时间点，对于那些尚未经历事件的个体而言，事件发生的瞬时“强度”。这三个函数紧密相关，其关系为 $h(t) = f(t) / S(t)$。同样，生存函数可以通过风险函数积分得到：$S(t) = \exp\left(-\int_0^t h(u)du\right)$ 。

**非信息性删失假设**

几乎所有生存分析方法都依赖于一个至关重要的假设，即**非信息性删失**（non-informative censoring）。在协变量存在的条件下，最常见的形式是**条件独立右删失**。该假设正式表述为，给定协变量向量 $X$，个体的真实事件时间 $T$ 与其删失时间 $C$ 是相互独立的，即 $C \perp T \mid X$ 。

这个假设的直观含义是，一个人的删失机制不应提供关于其未来事件风险的额外信息，超出协变量已知的信息。例如，如果病情更重的患者更有可能退出研究（一种信息性删失），那么剩余的研究人群将呈现出虚假的较低风险，导致对治疗效果的估计产生偏倚。$C \perp T \mid X$ 假设允许删失依赖于协变量（例如，老年患者的删失率可能不同于年轻患者），但要求在控制了这些协变量后，删失与潜在的事件风险无关。这个假设是后续介绍的[偏似然](@entry_id:165240)估计法有效性的理论基石 。

### Cox比例风险模型

1972年，David R. Cox 爵士提出的[比例风险模型](@entry_id:171806)彻底改变了生存分析领域。该模型的强大之处在于它能够在不指定基准风险函数具体形式的情况下，估计协变量对事件风险的影响。

**模型结构**

[Cox模型](@entry_id:164053)假设一个个体在时间 $t$ 的风险函数 $h(t \mid X)$ 可以分解为两部分：一个不依赖于协变量的**基准[风险函数](@entry_id:166593)** $h_0(t)$，和一个依赖于协变量的指数项 ：
$$
h(t \mid X) = h_0(t) \exp(X^\top \beta)
$$
其中：
-   $h_0(t)$ 是**基准风险函数**，代表当所有协变量 $X$ 均为零时（或处于基准水平时）的风险。它是一个关于时间的任意非负函数，捕捉了事件风险随时间变化的固有模式（例如，术后风险先高后低）。
-   $\exp(X^\top \beta)$ 是**相对风险**或**风险比 (Hazard Ratio, HR)**。$X$ 是协变量向量，$X^\top \beta = \beta_1 X_1 + \beta_2 X_2 + \dots + \beta_p X_p$ 是协变量的[线性组合](@entry_id:155091)。$\beta$ 是需要估计的回归系数向量，$\beta_j$ 代表协变量 $X_j$ 每增加一个单位，对数风险比的变化量。因此，$\exp(\beta_j)$ 是 $X_j$ 每增加一个单位时，风险乘以的倍数。

**[比例风险假设](@entry_id:163597)**

该模型的核心是**[比例风险](@entry_id:166780) (Proportional Hazards, PH) 假设**。考虑两个具有不同协变量向量 $X_1$ 和 $X_2$ 的个体，他们的风险比为：
$$
\frac{h(t \mid X_1)}{h(t \mid X_2)} = \frac{h_0(t)\exp(X_1^\top \beta)}{h_0(t)\exp(X_2^\top \beta)} = \exp((X_1 - X_2)^\top \beta)
$$
观察这个结果，我们发现基准风险函数 $h_0(t)$ 被消掉了。这意味着两个个体之间的风险比不随时间 $t$ 变化，而是一个常数。这就是“[比例风险](@entry_id:166780)”的含义：无论在研究的早期还是晚期，协变量对风险的乘法效应是恒定的  。

**风险比 (HR) vs. 风险比 (RR) 与优势比 (OR)**

必须明确区分 Cox 模型估计的风险比 (HR) 与在其他流行病学研究中常见的风险比 (RR, Risk Ratio) 和优势比 (OR, Odds Ratio)。
-   **HR (Hazard Ratio)** 是一个[瞬时速率](@entry_id:182981)之比，比较的是在任何特定时刻，两个组中尚未发生事件的个体发生事件的瞬时风险。
-   **RR (Risk Ratio)** 和 **OR (Odds Ratio)** 则是基于在**固定时间终点** $\tau$ 的累积概率。RR 比较的是到时间 $\tau$ 为止发生事件的累积概率，而 OR 比较的是相应事件的发生优势。

这三者在概念和数值上都有所不同。只有在事件非常罕见且时间段很短的特殊情况下，三者才可能近似相等。在大多数情况下，直接将从 Cox 模型中获得的 $\exp(\beta)$ 解释为累积风险比或优势比是错误的 。

### [参数估计](@entry_id:139349)：[偏似然](@entry_id:165240)法

Cox 模型的独创性在于其估计方法。由于基准风险函数 $h_0(t)$ 的形式未知，传统的最大似然估计无法直接使用。Cox 提出了一种巧妙的**[偏似然](@entry_id:165240) (Partial Likelihood)** 方法来估计参数 $\beta$，而无需对 $h_0(t)$ 做任何假设。

**半参数性质**

Cox 模型因此被称为**[半参数模型](@entry_id:200031)**：它包含一个需要估计的有限维**参数部分**（[回归系数](@entry_id:634860) $\beta$）和一个形式未知的无限维**非参数部分**（基准[风险函数](@entry_id:166593) $h_0(t)$）。[偏似然](@entry_id:165240)法允许我们首先绕过非参数部分来估计参数部分 。

**[偏似然](@entry_id:165240)的构建**

[偏似然](@entry_id:165240)的思想是，在每个观测到的事件时间点，构建一个条件概率。假设在时间 $t_i$ 观察到一个事件。我们定义**风险集** $R(t_i)$ 为在时间 $t_i$ 之前（包括 $t_i$）所有仍处于“风险中”（即尚未发生事件也未被删失）的个体集合，即 $R(t_i) = \{j : Y_j \ge t_i\}$。

现在，我们考虑这样一个[条件概率](@entry_id:151013)：给定在时间 $t_i$，风险集 $R(t_i)$ 中恰好发生了一个事件，这个事件恰好发生在个体 $i$ 身上的概率是多少？这个概率可以表示为个体 $i$ 的风险占风险集中所有个体总风险的比例：
$$
\Pr(\text{个体 } i \text{ 在 } t_i \text{ 发生事件} \mid \text{在 } R(t_i) \text{ 中有一个事件发生}) = \frac{h(t_i \mid X_i)}{\sum_{j \in R(t_i)} h(t_i \mid X_j)}
$$
将 Cox 模型的形式代入上式：
$$
= \frac{h_0(t_i)\exp(X_i^\top \beta)}{\sum_{j \in R(t_i)} h_0(t_i)\exp(X_j^\top \beta)} = \frac{\exp(X_i^\top \beta)}{\sum_{j \in R(t_i)} \exp(X_j^\top \beta)}
$$
神奇的是，未知的基准风险函数 $h_0(t_i)$ 作为公因子在分子和分母中被约掉了！这意味着该[条件概率](@entry_id:151013)仅依赖于我们想要估计的参数 $\beta$  。

**偏似然函数**

假设数据中没有重复的事件时间（即“无结”假设），**偏似然函数 (Partial Likelihood Function)** $L_p(\beta)$ 就是将所有事件发生时间点的这种条件概率连乘起来：
$$
L_p(\beta) = \prod_{i : \Delta_i=1} \frac{\exp(X_i^\top \beta)}{\sum_{j \in R(T_i)} \exp(X_j^\top \beta)}
$$
这个函数虽然不是一个严格意义上的“似然”，但它具有许多与标准[似然函数](@entry_id:141927)相似的优良统计性质。通过最大化这个偏[似然函数](@entry_id:141927)（通常是最大化其对数形式），我们可以得到 $\beta$ 的估计值 $\hat{\beta}$。

值得强调的是，被删失的观测虽然不直接为偏似然函数的分子提供贡献项，但它们是至关重要的。一个被删失的个体会在其被删失之前的所有事件时间点上，作为风险集的一员出现在分母中，从而为 $\beta$ 的估计提供信息 。

**计算示例**

让我们通过一个具体的例子来理解[偏似然](@entry_id:165240)的计算。假设一项关于疫苗犹豫的研究，旨在评估一种共情式沟通策略（$x=1$）相对于标准信息（$x=0$）能否缩短接受疫苗预约的时间。假设有4位参与者，无删失，事件时间（接受预约的天数）和分组情况如下 ：
-   个体1：$x_1=1$，事件时间 $t_1=2$
-   个体2：$x_2=0$，事件时间 $t_2=3$
-   个体3：$x_3=1$，事件时间 $t_3=5$
-   个体4：$x_4=0$，事件时间 $t_4=7$

事件时间按顺序排列为 $2, 3, 5, 7$。我们依次构建每个事件时间点的[偏似然](@entry_id:165240)贡献项：

1.  **在 $t=2$ 时**，个体1发生事件。风险集 $R(2)=\{1, 2, 3, 4\}$。对应的协变量值为 $\{x_1=1, x_2=0, x_3=1, x_4=0\}$。该时间点的贡献为：
    $$ L_1(\beta) = \frac{\exp(\beta x_1)}{\exp(\beta x_1) + \exp(\beta x_2) + \exp(\beta x_3) + \exp(\beta x_4)} = \frac{\exp(\beta)}{\exp(\beta) + 1 + \exp(\beta) + 1} = \frac{\exp(\beta)}{2\exp(\beta) + 2} $$

2.  **在 $t=3$ 时**，个体2发生事件。风险集 $R(3)=\{2, 3, 4\}$。对应的协变量值为 $\{x_2=0, x_3=1, x_4=0\}$。该时间点的贡献为：
    $$ L_2(\beta) = \frac{\exp(\beta x_2)}{\exp(\beta x_2) + \exp(\beta x_3) + \exp(\beta x_4)} = \frac{\exp(0)}{1 + \exp(\beta) + 1} = \frac{1}{2 + \exp(\beta)} $$

3.  **在 $t=5$ 时**，个体3发生事件。风险集 $R(5)=\{3, 4\}$。对应的协变量值为 $\{x_3=1, x_4=0\}$。该时间点的贡献为：
    $$ L_3(\beta) = \frac{\exp(\beta x_3)}{\exp(\beta x_3) + \exp(\beta x_4)} = \frac{\exp(\beta)}{\exp(\beta) + 1} $$

4.  **在 $t=7$ 时**，个体4发生事件。风险集 $R(7)=\{4\}$。对应的协变量值为 $\{x_4=0\}$。该时间点的贡献为：
    $$ L_4(\beta) = \frac{\exp(\beta x_4)}{\exp(\beta x_4)} = \frac{1}{1} = 1 $$

总的偏[似然函数](@entry_id:141927)是这四项的乘积：
$$
L_p(\beta) = L_1(\beta) \times L_2(\beta) \times L_3(\beta) \times L_4(\beta) = \frac{\exp(\beta)}{2(\exp(\beta)+1)} \times \frac{1}{2+\exp(\beta)} \times \frac{\exp(\beta)}{\exp(\beta)+1} = \frac{\exp(2\beta)}{2(1+\exp(\beta))^2(2+\exp(\beta))}
$$
通过[数值优化方法](@entry_id:752811)找到最大化此函数的 $\beta$ 值，即可得到 $\beta$ 的估计。

### 模型应用与扩展

在实际应用中，标准 Cox 模型可能需要进行检验、修正和扩展以适应更复杂的数据和研究问题。

**检验与处理[比例风险假设](@entry_id:163597)**

由于PH假设是[模型解释](@entry_id:637866)的关键，对其进行检验至关重要。
-   **图形诊断**：一种常用的方法是绘制**对数-负对数生存图** (log-minus-log survival plot)。该图绘制 $\log(-\log(\hat{S}(t)))$ 对 $\log(t)$（或其他时间函数）。如果PH假设成立，不同协变量分组的曲线应该是近似平行的 。另外，如果不同组的[Kaplan-Meier](@entry_id:169317)生存曲线出现交叉，通常提示PH假设可能不成立。
-   **基于残差的检验**：**Schoenfeld残差**是检验PH假设的有力工具。对于每个协变量，其Schoenfeld残差应独立于时间。如果将残差对时间作图，观察到系统性趋势（例如，一条斜线），则表明该协变量的效应是随时变的，违反了PH假设。这可以通过一个正式的统计检验来评估 。
-   **处理非比例风险**：如果发现一个重要的分类协变量（如性别、治疗组）不满足PH假设，一个有效的解决方法是使用**分层[Cox模型](@entry_id:164053) (Stratified Cox Model)**。该模型允许每个层（stratum）有其自己独特的、不受限制的基准[风险函数](@entry_id:166593) $h_{0k}(t)$，同时估计一个跨层共同的协变量效应 $\beta$。模型形式为 $h_k(t \mid X) = h_{0k}(t)\exp(X^\top\beta)$。在构建[偏似然](@entry_id:165240)时，风险集被限制在各层内部。这种方法可以有效控制不满足PH假设的分层变量的混杂效应 。

    例如，在一项匹配配对研究中，每个配对（层）由一名暴露者（$Z=1$）和一名非暴露者（$Z=0$）组成，直至其中一人发生事件。在第 $s$ 个配对中，风险集仅包含这两个人。如果暴露者先发生事件，该层的[偏似然](@entry_id:165240)贡献为 $\frac{\exp(\beta)}{\exp(\beta)+1}$；如果非暴露者先发生，贡献为 $\frac{1}{\exp(\beta)+1}$。整个研究的偏似然函数是所有配对贡献的乘积，这在形式上等价于条件Logistic回归的[似然函数](@entry_id:141927) 。

**时变协变量**

在许多研究中，协变量的值会随时间改变，例如，患者在随访期间开始或停止某种治疗。Cox模型可以自然地扩展以处理**时变协变量 (Time-Dependent Covariates, TDC)**。模型形式保持不变，$h_i(t) = h_0(t)\exp(\beta^\top X_i(t))$，但协变量向量 $X_i(t)$ 本身成为了时间的函数。

为了在软件中实现这一点，数据需要被构造成**[计数过程](@entry_id:260664)格式 (counting process format)**。每个个体的随访历史被分割成多个时间区间 $(t_{\text{start}}, t_{\text{stop}}]$，在每个区间内，所有协变量的值都是恒定的。当协变量值发生变化时，就创建一个新的区间。这种格式确保了在每个事件时间点，风险集中每个个体的协变量都取其当时正确的值 。

处理时变协变量时，必须警惕**不朽时间偏倚 (immortal time bias)**。当一个协变量的定义依赖于未来的信息时（例如，将一个在随访中期才开始用药的患者从一开始就划分为“用药组”），就会引入这种偏倚。正确的做法是将其建模为时变协变量：在用药前，该患者对风险集的贡献是作为未用药者；用药后，其贡献变为用药者 。

此外，对于**延迟进入 (delayed entry)** 或**[左删失](@entry_id:169731) (left truncation)** 的数据（例如，患者在研究时间零点之后才进入队列），也必须使用[计数过程](@entry_id:260664)格式，将每个个体的第一条记录的起始时间设为其进入研究的时间 $E_i$，以确保他们只在 $t \ge E_i$ 时才进入风险集 。

**[竞争风险](@entry_id:173277)**

当个体可能经历多种不同类型且相互排斥的事件时，就出现了**[竞争风险](@entry_id:173277) (Competing Risks)** 的问题。例如，在心脏病研究中，患者可能死于心血管原因（目标事件），也可能死于癌症（竞争事件）。发生竞争事件会阻止目标事件的发生。

在这种情况下，有两种主流的建模策略 ：

1.  **原因别风险 (Cause-Specific Hazard, CSH) 模型**：这是对标准Cox模型的直接应用。为了分析原因 $k$ 的风险，我们将所有其他原因的事件视为在事件发生时间点的删失。这种方法估计的是在某个时间点，对于所有仍处于风险中的个体（即未发生任何类型事件的个体），发生原因 $k$ 事件的瞬时速率。CSH模型适合于探索协变量与特定事件发生机制的“病因学”关联。

2.  **子分布风险 (Subdistribution Hazard, SDH) 模型**：由Fine和Gray提出，这种方法旨在直接对**累积发生率函数 (Cumulative Incidence Function, CIF)** 进行建模，CIF 是指在存在竞争风险的情况下，到时间 $t$ 为止发生原因 $k$ 事件的累积概率。为了做到这一点，SDH模型定义了一个特殊的风险集：经历过竞争事件的个体并**不会**从风险集中移除，而是继续留在其中。这改变了风险的定义，使其不再是纯粹的[瞬时速率](@entry_id:182981)，而是与累积概率直接相关。SDH模型更适合于预测个体的绝对事件风险和临床预后。

这两种模型回答了不同的问题，其估计出的协变量效应（风险比）可能有显著差异，甚至方向相反。选择哪种模型取决于具体的研究目标：是理解疾病的瞬时生物学机制（CSH），还是预测患者的长期临床结局（SDH）。

通过掌握这些原理和机制，研究者可以更深刻地理解[Cox比例风险模型](@entry_id:174252)的强大功能、前提假设以及其在各种复杂流行病学和临床研究场景中的灵活应用。