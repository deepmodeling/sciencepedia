## 引言
在流行病学、临床研究及公共卫生领域，我们经常关注从某个时间点到某个关键事件发生所经历的时间，例如从诊断到康复，或从暴露于风险因素到疾病发作。生存分析（Survival Analysis）正是为分析此类“时间-事件”数据而设计的核心统计方法学。它不仅能处理事件是否发生，更重要的是能够充分利用“何时发生”这一宝贵信息。

然而，真实世界的研究数据往往是不完美的。患者可能在研究结束时仍未发生事件，或因各种原因失访，导致数据出现“删失”（censoring）。简单地忽略这些不完整的数据会造成严重的偏倚。因此，理解并掌握一套能正确处理这些复杂性的分析工具，对于得出可靠的科学结论至关重要。

本文旨在为读者提供一个关于生存分析的全面而系统的入门指南。我们将从三个层面展开：首先，在“原理与机制”一章中，我们将深入探讨生存分析的数学语言，包括生存函数、[风险函数](@entry_id:166593)、删失的类型，并介绍Kaplan-Meier估计和Cox比例风险模型等基石方法。接着，在“应用与跨学科联系”一章中，我们将展示这些理论如何在临床试验评估、公共卫生策略制定和复杂真实世界场景（如[竞争风险](@entry_id:173277)和时依性暴露）中发挥作用。最后，通过“动手实践”部分，读者将有机会亲手演练关键的计算过程。通过这一学习路径，读者将建立起从理论到实践的完整知识体系。

## 原理与机制

在流行病学研究中，我们常常关注从某个明确定义的时间起点（如出生、暴露或诊断）到某个事件发生所经过的时间。这个“时间-事件”数据（time-to-event data）是生存分析的核心。本章将系统地阐述生存分析的基本原理和核心机制，为后续章节中更复杂的应用奠定理论基础。

### 时间-事件数据的语言：生存、风险与删失

为了严谨地分析时间-事件数据，我们需要一套精确的数学语言来描述其关键特征。

#### 生存函数与[风险函数](@entry_id:166593)

最直观的概念是**生存函数 (Survival Function)**，记为 $S(t)$。它定义为个体生存时间 $T$ 超过某一特定时间点 $t$ 的概率：

$$
S(t) = \Pr(T > t)
$$

生存函数是一个非增函数，其值域为 $[0, 1]$，并且 $S(0) = 1$。它描绘了一条随时间推移，群体中未发生事件者比例下降的曲线。

与生存函数密切相关但概念上更微妙的是**风险函数 (Hazard Function)**，记为 $h(t)$。它表示在时间点 $t$ 仍然存活（即 $T \ge t$）的个体，在下一个极小时间间隔 $[t, t+\Delta t)$ 内发生事件的瞬时速率：

$$
h(t) = \lim_{\Delta t \to 0^+} \frac{\Pr(t \le T  t + \Delta t \mid T \ge t)}{\Delta t}
$$

风险函数有时也被称为瞬时死亡率或失效率，它衡量的是在给定生存至时间 $t$ 的条件下，个体在下一瞬间面临的事件风险。与概率不同，风险是一个速率，其取值范围是 $[0, \infty)$。

生存函数和[风险函数](@entry_id:166593)通过以下关系紧密相连。令 $f(t)$ 为事件时间的[概率密度函数](@entry_id:140610)，则 $f(t) = -S'(t)$。根据[风险函数](@entry_id:166593)的定义，我们有 $h(t) = f(t) / S(t)$。通过这个关系，我们可以推导出生存函数与风险函数之间的积分形式：

$$
S(t) = \exp\left(-\int_0^t h(u)du\right)
$$

这个表达式至关重要，它表明生存曲线的形状完全由其背后的风险函数决定。积分项 $\Lambda(t) = \int_0^t h(u)du$ 被称为**[累积风险函数](@entry_id:169734) (Cumulative Hazard Function)**。

#### 不完整观测：删失与截断

在理想情况下，我们能观测到队列中每个研究对象的完整事件时间。然而，在实际的流行病学研究中，由于各种原因，我们获得的信息往往是不完整的。正确处理这些不完整数据是生存分析的关键。我们需要严格区分两种不完整观测类型：删失和截断 ()。

**删失 (Censoring)** 指的是对于已纳入研究的个体，我们只知道其事件时间位于某个时间区间内，但无法获知确切的事件时间。删失的个体仍然为分析提供了宝贵的信息（例如，我们知道他们在删失前一直存活）。删失主要有三种类型：

1.  **[右删失](@entry_id:164686) (Right Censoring)**：这是最常见的删失类型。当研究随访结束或个体因非事件原因失访时，我们只知道其事件时间 $T$ 大于其最后的随访时间 $C$。我们记录的信息是 $T > C$。例如，一个为期五年的临床试验结束时，仍有患者存活，他们的事件时间就被[右删失](@entry_id:164686)了。

2.  **[左删失](@entry_id:169731) (Left Censoring)**：当我们在首次观测时发现事件已经发生，但不知道具体发生时间。例如，在研究某种[传染病](@entry_id:182324)的感染时间时，若在第一次检测时就发现个体已被感染，我们只知道其感染时间 $T$ 小于或等于首次检测时间 $L$，即 $T \le L$。

3.  **[区间删失](@entry_id:636589) (Interval Censoring)**：当事件的发生被确认在两次随访观测之间。例如，对慢性病进行定期筛查，若某人在时间点 $L$ 的检查结果为阴性，但在下一次时间点 $R$ 的检查中呈阳性，我们便知其事件时间 $T$ 发生在区间 $(L, R]$ 内，即 $L  T \le R$。

与删失不同，**截断 (Truncation)** 是一个与样本纳入标准相关的概念。它导致某些具有特定事件时间的个体被系统性地排除在研究之外，观测者甚至不知道这些个体的存在。

1.  **左截断 (Left Truncation)**：也称为**延迟进入 (delayed entry)**。当个体只有在存活至某个时间点 $E$ 后才能被纳入研究时，就会发生左截断。例如，在一个基于职业队列的研究中，工人只有在年满18岁入职后才开始被随访。任何在18岁前死亡的个体都不会进入该队列。因此，所有被观测到的个体都满足条件 $T \ge E$。

2.  **右截断 (Right Truncation)**：这在回顾性研究中较为常见。例如，一个研究利用死亡登记数据来分析某个罕见病。如果该登记系统建立于2000年，研究仅纳入了在2000年至2020年间死亡的患者，那么任何在2020年之后死亡的患者（即 $T > U$，其中 $U$ 是2020年）都不会被包含在样本中。因此，观测样本被限制在满足 $T \le U$ 的个体中。

根本区别在于：**删失**限制了我们对已入组个体事件时间 $T$ 的了解程度，而**截断**则限制了哪些个体能够进入我们的研究样本。

### 生存函数的非参数估计

当我们不想对生存时间的分布做任何特定假设时，可以使用非参数方法来估计生存函数。其中最著名和最广泛使用的方法是 [Kaplan-Meier](@entry_id:169317) 法。

#### 风险集

[Kaplan-Meier](@entry_id:169317) 方法的核心思想是在每个事件发生的时间点，重新评估条件生存概率。为此，我们需要定义**风险集 (Risk Set)**。在任意时间点 $t$，风险集 $R(t)$ 是指在该时刻之前已进入研究（即进入时间 $a_i \le t$）且尚未发生事件或被删失（即观测到的事件或删失时间 $y_i \ge t$）的所有个体的集合 ()。

例如，在一个包含8个个体的队列研究中，数据如下：
- A: 进入时间 $a_A=0$, 事件时间 $t_A=4$
- B: $a_B=2$, 删失时间 $c_B=10$
- C: $a_C=5$, 事件时间 $t_C=8$
- D: $a_D=1$, 事件时间 $t_D=6$
- E: $a_E=7$, 删失时间 $c_E=12$
- F: $a_F=0$, 事件时间 $t_F=11$
- G: $a_G=3$, 事件时间 $t_G=13$
- H: $a_H=9$, 删失时间 $c_H=15$

在第一个事件时间 $t=4$ 时，个体A, B, D, F, G 均已进入研究且尚未退出，所以风险集 $R(4) = \{A, B, D, F, G\}$，其大小 $|R(4)|=5$。而在事件时间 $t=8$ 时，个体A和D已经历事件退出，个体E已进入研究，所以风险集为 $R(8) = \{B, C, E, F, G\}$，大小为 $|R(8)|=5$ ()。正确识别每个事件时间点的风险集是后续计算的基础。

#### Kaplan-Meier 估计量

[Kaplan-Meier](@entry_id:169317) (KM) 估计量，也称**[乘积限估计量](@entry_id:171437) (product-limit estimator)**，其思想是将生存函数 $S(t)$ 分解为一系列条件概率的乘积。令 $t_1  t_2  \dots  t_K$ 为队列中观测到的 $K$ 个不同事件时间。生存至时间 $t$ 的概率可以写作：

$$
S(t) = \Pr(T > t) = \Pr(T > t_1) \times \Pr(T > t_2 \mid T > t_1) \times \dots \times \Pr(T > t_j \mid T > t_{j-1})
$$

其中 $t_j$ 是小于或等于 $t$ 的最后一个事件时间。

在每个事件时间 $t_j$，我们可以从数据中估计条件生存概率。设 $n_j$ 为风险集 $R(t_j)$ 的大小（即在 $t_j$ 时刻处于风险中的人数），$d_j$ 为在 $t_j$ 时刻发生的事件数。那么，在该时刻发生事件的[条件概率](@entry_id:151013)可估计为 $d_j/n_j$，因此存活过该时刻的条件概率可估计为 $(1 - d_j/n_j)$。

将这些估计值代入，我们得到 Kaplan-Meier 估计量：

$$
\widehat{S}(t) = \prod_{j: t_j \le t} \left(1 - \frac{d_j}{n_j}\right)
$$

KM 估计量是一个[阶梯函数](@entry_id:159192)，它在每个事件发生的时间点下降，而在事件之间保持不变。

为了量化 $\widehat{S}(t)$ 的不确定性，我们可以计算其方差。最常用的公式是**格林伍德公式 (Greenwoo[d'](@entry_id:189153)s formula)** ()：

$$
\widehat{\operatorname{Var}}\{\widehat{S}(t)\} = [\widehat{S}(t)]^2 \sum_{j: t_j \le t} \frac{d_j}{n_j(n_j-d_j)}
$$

这个公式的结构很直观：总方差是每个事件时间点引入的方差贡献之和，再乘以生存概率平方进行尺度调整。例如，给定一系列事件时间点的 $(d_j, n_j)$ 数据，如 $t_1=2$ 时 $(d_1=3, n_1=20)$，$t_2=5$ 时 $(d_2=4, n_2=15)$，$t_3=9$ 时 $(d_3=2, n_3=10)$，我们可以逐步计算 $\widehat{S}(9) = (1 - 3/20) \times (1 - 4/15) \times (1 - 2/10) \approx 0.499$，并利用格林伍德公式计算出其方差约为 $0.0144$ ()。

### [风险函数](@entry_id:166593)的建模

虽然非参数方法很有用，但它们无法轻松地评估协变量（如暴露、治疗或[人口统计学](@entry_id:143605)特征）对生存时间的影响。为此，我们需要构建[风险函数](@entry_id:166593)的模型。

#### 参数模型

最直接的方法是假定风险函数 $h(t)$ 或生存函数 $S(t)$ 服从某个特定的数学形式。这些模型被称为**参数生存模型**。不同的模型蕴含了关于风险如何随时间演变的不同假设 ()。

-   **指数模型 (Exponential Model)**：最简单的模型，假设风险恒定不变，$h(t) = \lambda$。这对应于“[无记忆性](@entry_id:201790)”过程，即未来的风险不取决于已经存活了多久。其生存函数为 $S(t) = \exp(-\lambda t)$。

-   **威布尔模型 (Weibull Model)**：这是指数模型的推广，允许风险随时间单调增加或减少。其[风险函数](@entry_id:166593)为 $h(t) = \lambda k t^{k-1}$。[形状参数](@entry_id:270600) $k$ 控制着风险的形态：若 $k > 1$，风险随时间增加（如多数癌症）；若 $0  k  1$，风险随时间减少（如手术后并发症风险）；若 $k = 1$，则退化为指数模型。

-   **贡珀茨模型 (Gompertz Model)**：该模型假设风险呈指数级增长或衰减，$h(t) = \lambda \exp(\gamma t)$。当 $\gamma > 0$ 时，风险加速增长，常用于描述成年后的死亡风险。

-   **对数正态 (Log-normal) 与对数逻辑 (Log-logistic) 模型**：与前述模型不同，这两类模型允许**非单调**的风险函数。例如，[对数正态分布](@entry_id:261888)的风险函数从0开始，上升到一个峰值然后下降，这可能适用于某些感染性疾病或移植后排斥反应的风险模式。对数逻辑分布的风险函数在参数 $\alpha > 1$ 时也呈非单调形态，先增后减。

选择哪种参数模型取决于关于研究现象的先验知识和[数据拟合](@entry_id:149007)的优度。

#### Cox [比例风险模型](@entry_id:171806)

在很多流行病学研究中，我们对协变量的效应最感兴趣，而对基线风险 $h_0(t)$ 的具体形状并无太多先验知识。**Cox [比例风险模型](@entry_id:171806) (Cox Proportional Hazards Model)** 应运而生，它是一种**[半参数模型](@entry_id:200031)**，完美地解决了这个问题。

Cox 模型将[风险函数](@entry_id:166593)分解为两部分：

$$
h(t \mid X) = h_0(t) \exp(\beta^\top X)
$$

其中：
-   $h_0(t)$ 是**基线[风险函数](@entry_id:166593) (baseline hazard function)**，它是一个未指定的非负函数，代表了当所有协变量 $X$ 均为零时（即 $X=\mathbf{0}$）的风险。
-   $\exp(\beta^\top X)$ 是相对风险部分，其中 $X$ 是协变量向量，$\beta$ 是相应的[回归系数](@entry_id:634860)向量。$\beta_k$ 的指数变换 $\exp(\beta_k)$ 就是我们熟知的**风险比 (Hazard Ratio, HR)**。

该模型的关键假设是**[比例风险](@entry_id:166780)假定 (proportional hazards assumption)**，即任意两个个体（例如，暴露组 vs. 非暴露组）的风险函数之比是一个不随时间变化的常数：

$$
\frac{h(t \mid X_1)}{h(t \mid X_0)} = \frac{h_0(t) \exp(\beta^\top X_1)}{h_0(t) \exp(\beta^\top X_0)} = \exp(\beta^\top (X_1 - X_0)) = \text{ constant}
$$

这一巧妙的设定使得我们可以在不估计 $h_0(t)$ 的情况下，估计出系数 $\beta$。这是通过最大化**部分似然 (Partial Likelihood)** 实现的 ()。其推导逻辑如下：在任何一个事件发生的时间 $t_i$，考虑当时的风险集 $\mathcal{R}(t_i)$。假定我们知道在这一刻，风险集中恰好有一人发生了事件，那么这个事件发生在特定个体 $i$ 身上的条件概率是多少？这个概率是：

$$
\frac{\text{个体 } i \text{ 的风险}}{\text{风险集中所有人的风险总和}} = \frac{h_0(t_i) \exp(\beta^\top x_i)}{\sum_{j \in \mathcal{R}(t_i)} h_0(t_i) \exp(\beta^\top x_j)} = \frac{\exp(\beta^\top x_i)}{\sum_{j \in \mathcal{R}(t_i)} \exp(\beta^\top x_j)}
$$

神奇的是，未知的基线风险 $h_0(t_i)$ 在分子和分母中被约掉了。通过将所有事件时间点的这种条件概率连乘起来，就构成了仅依赖于 $\beta$ 和数据的部分似然函数。最大化这个函数就可以得到 $\beta$ 的估计值 $\hat{\beta}$。

在得到 $\hat{\beta}$后，如果我们想估计生存函数，就需要回头来估计基线风险。我们无法直接估计 $h_0(t)$，但可以估计其累积形式，即**累积基线风险函数** $H_0(t) = \int_0^t h_0(u)du$。常用的估计方法是 **Breslow 估计量** ()，其思想是在每个事件时间 $t_j$，将观测到的事件数 $d_j$ 与模型预期的事件数等同起来。在 $t_j$ 时刻，模型预期的事件数是基线风险的增量 $\Delta H_0(t_j)$ 乘以风险集中所有人的相对风险总和。由此，我们可以解出基线风险的增量估计：

$$
\widehat{\Delta H_0(t_j)} = \frac{d_j}{\sum_{k \in \mathcal{R}(t_j)} \exp(\hat{\beta}^\top x_k)}
$$

将所有事件时间点之前的增量累加起来，就得到了 $\widehat{H}_0(t) = \sum_{t_j \le t} \widehat{\Delta H_0(t_j)}$。进而，我们可以估计任何协变量组合下的生存函数：$\widehat{S}(t \mid X) = [\exp(-\widehat{H}_0(t))]^{\exp(\hat{\beta}^\top X)}$。

### 高级主题与解释

生存分析的应用远不止于上述基础模型。理解其背后更深层次的假设和概念对于正确解释结果至关重要。

#### 风险比的解释与非坍缩性

风险比 $\exp(\beta_k)$ 在流行病学中具有明确的病因学解释。在满足一系列因果推断的识别条件（如无未测量混杂、模型设定正确等）下，它衡量了在控制其他协变量不变的情况下，协变量 $X_k$ 每增加一个单位，导致瞬时事件风险变化的乘法效应 ()。

然而，风险比有一个非常独特的统计特性，称为**非坍缩性 (non-collapsibility)**。这意味着，即使一个变量 $Z$ 不是混杂因素（即它与暴露 $E$ 独立），只要 $Z$ 是一个风险预测因子，那么在模型中调整 $Z$ 仍然会改变 $E$ 的风险比。边际风险比（未调整 $Z$）通常不等于条件风险比（调整了 $Z$）。

其根本原因在于，风险比是基于风险集定义的，而风险集的构成是随时间动态变化的。一个强预测因子 $Z$ 会导致不同水平的个体以不同速率离开风险集。例如，如果暴露组中高危人群（$Z=1$）的比例最初与非暴露组相同，但由于他们事件发生得更快，随着时间推移，暴露组风险集中剩下的将主要是低危人群（$Z=0$）。这导致暴露组的平均风险（边际风险）随时间下降，从而使得边际风险比也随时间变化并趋向于1（衰减），即使条件风险比恒定不变。因此，在Cox模型中，即使没有混杂，调整一个强预测因子也会得到一个与粗略估计值不同的、通常更远离1的条件风险比。这并非“偏倚”，而是因为边际风险比和条件风险比是两个本质上不同的度量。

鉴于风险比的解释复杂性，一个良好的实践是在报告经调整的条件风险比以进行病因推断的同时，补充报告一些绝对效应度量，如**限制性平均生存时间 (Restricted Mean Survival Time, RMST)** 的差异。RMST是一个在某个预设时间点之前平均生存时间的度量，它具有可坍缩性，且其差异在临床和公共卫生上更易解释 ()。

#### 竞争风险

在许多研究中，个体可能经历多种不同类型、相互排斥的事件。例如，在老年人群中，我们可能同时关注心血管死亡、癌症死亡和其他原因死亡。这种情况被称为**竞争风险 (Competing Risks)**。

在竞争风险框架下，我们需要区分几个关键概念 ()：

1.  **特定原因风险 (Cause-Specific Hazard, CSH)**, $h_k(t)$：这是在时间 $t$ 仍存活（未发生任何事件）的个体，在下一瞬间发生第 $k$ 类事件的速率。我们可以使用标准[Cox模型](@entry_id:164053)来建模 $h_k(t)$，只需将其他原因的事件视为[右删失](@entry_id:164686)即可。

2.  **累积发生函数 (Cumulative Incidence Function, CIF)**, $F_k(t)$：这是到时间 $t$ 为止，发生第 $k$ 类事件的累积概率，即 $F_k(t) = \Pr(T \le t, K=k)$。CIF通常是流行病学家最关心的终点指标，因为它直接衡量了事件的绝对风险。

CSH和CIF之间有一个至关重要的关系：$F_k(t) = \int_0^t S(u-) h_k(u) du$。这里的 $S(u-)$ 是**总生存函数**（即未发生任何原因事件的概率）。这个公式表明，第 $k$ 类事件的累积发生率不仅取决于其自身的特定原因风险 $h_k(t)$，还取决于所有其他竞争事件的风险（它们共同决定了 $S(u-)$ 的大小）。这就是为什么我们不能简单地通过 Kaplan-Meier 方法（它错误地假设被其他事件“删失”的个体仍有100%的可能经历目标事件）来估计CIF。

3.  **子分布风险 (Subdistribution Hazard)**, $\tilde{h}_k(t)$：为了直接对 CIF 进行[回归建模](@entry_id:170726)（例如，Fine-Gray模型），统计学家引入了子分布风险。它的定义较为抽象，其风险集不仅包括尚未发生任何事件的个体，还包括那些已经发生过竞争事件的个体。

#### 依时性协变量与因果推断

在纵向研究中，协变量的值可能随时间变化，这类变量称为**依时性协变量 (Time-Dependent Covariates)**。对它们的正确分类和处理对于因果推断至关重要 ()。

-   **外部协变量 (External Covariate)**：其路径不受个体事件历史的影响。例如，空气污染水平是一个由外部环境决定的变量。在模型中调整这类变量相对安全，可以像处理基线协变量一样进行解释。

-   **内部协变量 (Internal Covariate)**：其路径会受到个体过去事件或治疗史的影响。例如，反映疾病状态的生物标志物（如肺功能）、根据病情调整的药物剂量、或既往事件的发生次数，都属于内部协变量。

在标准[Cox模型](@entry_id:164053)中直接调整内部协变量会带来巨大的解释困难，并可能导致严重的偏倚。例如，调整一个受既往治疗影响的生物标志物，可能会无意中“调整掉”治疗的部分效果（即通过该生物标志物介导的效果）。更糟的是，如果存在未测量的混杂因素（如个体“脆弱性”）同时影响内部协变量和未来事件风险，调整内部协变量会造成**[碰撞偏倚](@entry_id:163186) (collider bias)**。因此，对涉及内部协变量的因果问题（如时变治疗的效果），需要使用更高级的方法，如边际结构模型。

最后，所有生存分析方法的有效性都依赖于某些基本假设，其中最核心的是**独立删失 (independent censoring)** ()。在最简单的形式中，它假定个体的事件时间 $T$ 与其删失时间 $C$ 相互独立。一个更现实的假设是**条件独立删失**：$T \perp C \mid X$，即在给定协变量 $X$ 的层内，事件时间与删失时间独立。如果一个协变量 $X$ 同时影响事件风险和失访风险（例如，病情更重的患者更可能失访），那么不经调整的Kaplan-Meier分析将会产生偏倚。此时，正确的做法是在 $X$ 的每个分层内部分别计算KM曲线，然后根据样本中 $X$ 的分布对这些曲线进行加权平均（即标准化），才能得到一个无偏的边际生存函数估计。

### 统一框架：[计数过程](@entry_id:260664)

生存分析中的诸多概念，如风险集、删失、截断和依时性协变量，可以通过**[计数过程](@entry_id:260664) (Counting Process)** 的数学框架得到统一和严谨的表述 ()。在这个框架中，我们为每个个体 $i$ 定义一个[计数过程](@entry_id:260664) $N_i(t)$，记录其到时间 $t$ 为止发生的事件次数。我们还定义一个**在风险过程 (at-risk process)** $Y_i(t)$，当个体 $i$ 在时间 $t$ 处于风险中时取值为1，否则为0。

风险函数 $h(t)$ 被推广为**强度过程 (intensity process)** $\lambda_i(t)$，它给出了事件计数的瞬时期望。[Cox模型](@entry_id:164053)可以优雅地写为：

$$
\lambda_i(t) = Y_i(t) h_0(t) \exp(\beta^\top X_i(t))
$$

这里的 $Y_i(t)$ 自然地处理了删失（当个体被删失后 $Y_i(t)$ 变为0）和左截断（在个体进入前 $Y_i(t)$ 为0）的情况。这个强大的数学工具为生存分析的理论发展和软件实现提供了坚实的基础，也构成了我们理解其原理和机制的最终基石。