{
    "hands_on_practices": [
        {
            "introduction": "The design of a high-density probe is a masterclass in engineering trade-offs. This exercise explores the fundamental relationship between the physical layout of recording sites on a probe and the data acquisition system's capacity to handle the resulting data stream. By working through this problem , you will gain a concrete understanding of how factors like channel count, sampling rate, and bus architecture constrain the design and performance of modern electrophysiology systems.",
            "id": "4138200",
            "problem": "A high-density linear array of extracellular recording sites is patterned along a single silicon shank of length $10\\,\\mathrm{mm}$. The centers of adjacent sites are separated along the shank by a uniform pitch of $20\\,\\mu\\mathrm{m}$. Each site is read out using Time-Division Multiplexing (TDM), where multiple channels share a single data bus. The signal chain must preserve single-unit spike waveforms whose energy is mostly confined below $7.5\\,\\mathrm{kHz}$, and the sampling is constrained by the Nyquist sampling theorem and engineering practice to use a per-channel sampling frequency of $30\\,\\mathrm{kHz}$. The shared bus is a single-ended metal line whose maximum symbol rate is limited by its resistance-capacitance product to $12\\,\\mathrm{MHz}$. Due to addressing, synchronization, and settling overhead, only a fraction $(1-\\gamma)$ of bus symbols can be used for actual sample transfers per second, with $\\gamma=0.20$.\n\nStarting from the definitions of pitch and sampling requirements and the constraints of TDM throughput, determine the number of recording sites along the shank and then derive, from first principles, the minimum number of independent parallel TDM buses required to guarantee that every site is sampled at $30\\,\\mathrm{kHz}$ under the stated bus constraints. Express your final answer as a single integer equal to the minimum number of parallel buses needed. No units are required for the final answer. Do not round intermediate steps beyond what is implied by the derivation; the final answer is exact by construction.",
            "solution": "The problem requires the determination of the minimum number of parallel Time-Division Multiplexing (TDM) buses needed to read out all recording sites on a high-density electrophysiology probe. The solution is derived from first principles, based on the provided physical and operational parameters.\n\nThe given parameters are:\n- Shank length: $L = 10\\,\\mathrm{mm}$\n- Pitch between adjacent recording sites: $p = 20\\,\\mu\\mathrm{m}$\n- Per-channel sampling frequency: $f_s = 30\\,\\mathrm{kHz}$\n- Maximum symbol rate of a single bus: $R_{bus,max} = 12\\,\\mathrm{MHz}$\n- Overhead factor for the bus: $\\gamma = 0.20$\n\nThe solution proceeds in four steps:\n1.  Calculate the total number of recording sites, $N_{sites}$.\n2.  Calculate the total required sampling throughput for the entire array, $R_{total, req}$.\n3.  Calculate the effective data throughput available from a single bus, $R_{bus, eff}$.\n4.  Determine the minimum number of parallel buses, $N_{buses}$.\n\n**Step 1: Determine the number of recording sites**\nThe recording sites are arranged in a linear array along the shank of length $L$. The centers of adjacent sites are separated by a uniform pitch $p$. Assuming a site is placed at the beginning (position $0$) and the end (position $L$) of this length, the number of intervals of length $p$ is $\\frac{L}{p}$. The total number of sites is one greater than the number of intervals, a standard result for discrete elements arranged along a continuous dimension.\nFirst, we ensure consistent units. We convert the shank length $L$ from millimeters to micrometers:\n$$L = 10\\,\\mathrm{mm} = 10 \\times 10^3\\,\\mu\\mathrm{m} = 10000\\,\\mu\\mathrm{m}$$\nThe pitch is given as $p = 20\\,\\mu\\mathrm{m}$.\nThe number of sites, $N_{sites}$, is therefore:\n$$N_{sites} = \\frac{L}{p} + 1 = \\frac{10000\\,\\mu\\mathrm{m}}{20\\,\\mu\\mathrm{m}} + 1 = 500 + 1 = 501$$\nThere are $501$ recording sites on the shank.\n\n**Step 2: Determine the total required sampling throughput**\nEach of the $N_{sites}$ channels is sampled at a frequency $f_s = 30\\,\\mathrm{kHz}$. The total required throughput, representing the aggregate number of samples to be transferred per second from all sites, is the product of the number of sites and the per-channel sampling frequency.\n$$R_{total, req} = N_{sites} \\times f_s$$\nThe problem statement provides context that the signal bandwidth is below $7.5\\,\\mathrm{kHz}$. According to the Nyquist sampling theorem, the minimum sampling rate required to avoid aliasing is twice the maximum frequency component, which would be $2 \\times 7.5\\,\\mathrm{kHz} = 15\\,\\mathrm{kHz}$. The chosen sampling frequency $f_s = 30\\,\\mathrm{kHz}$ is greater than this minimum, confirming the scientific validity of the setup.\nSubstituting the values:\n$$R_{total, req} = 501 \\times 30\\,\\mathrm{kHz} = 501 \\times 30 \\times 10^3\\,\\mathrm{s}^{-1} = 15030 \\times 10^3\\,\\mathrm{s}^{-1} = 15.03 \\times 10^6\\,\\mathrm{s}^{-1}$$\nThe total required throughput is $15.03$ million samples per second ($15.03\\,\\mathrm{MSamples/s}$).\n\n**Step 3: Determine the effective throughput of a single bus**\nA single TDM bus has a maximum symbol rate of $R_{bus,max} = 12\\,\\mathrm{MHz}$. In the context of sample transfers, we interpret this as a maximum rate of $12 \\times 10^6$ sample transfers per second. However, a fraction $\\gamma = 0.20$ of this capacity is lost to overhead. The fraction available for data transfer is $(1-\\gamma)$. The effective throughput of a single bus, $R_{bus, eff}$, is:\n$$R_{bus, eff} = R_{bus,max} \\times (1 - \\gamma)$$\nSubstituting the values:\n$$R_{bus, eff} = (12 \\times 10^6\\,\\mathrm{s}^{-1}) \\times (1 - 0.20) = (12 \\times 10^6\\,\\mathrm{s}^{-1}) \\times 0.80 = 9.6 \\times 10^6\\,\\mathrm{s}^{-1}$$\nA single bus can effectively handle $9.6$ million samples per second ($9.6\\,\\mathrm{MSamples/s}$).\n\n**Step 4: Determine the minimum number of parallel buses**\nTo meet the total required throughput $R_{total, req}$ using parallel buses each with an effective throughput of $R_{bus, eff}$, the number of buses must be at least the ratio of the total required rate to the single-bus rate. Since the number of buses must be an integer, we must take the ceiling of this ratio to ensure the capacity is sufficient.\nLet $N_{buses}$ be the minimum number of buses.\n$$N_{buses} = \\left\\lceil \\frac{R_{total, req}}{R_{bus, eff}} \\right\\rceil$$\nSubstituting the calculated throughput values:\n$$N_{buses} = \\left\\lceil \\frac{15.03 \\times 10^6\\,\\mathrm{s}^{-1}}{9.6 \\times 10^6\\,\\mathrm{s}^{-1}} \\right\\rceil = \\left\\lceil \\frac{15.03}{9.6} \\right\\rceil$$\nThe numerical value of the ratio is:\n$$\\frac{15.03}{9.6} = 1.565625$$\nApplying the ceiling function, which gives the smallest integer greater than or equal to its argument:\n$$N_{buses} = \\lceil 1.565625 \\rceil = 2$$\nTherefore, a minimum of $2$ independent parallel TDM buses are required to sample all $501$ sites at the specified frequency, given the bus constraints.",
            "answer": "$$\\boxed{2}$$"
        },
        {
            "introduction": "Raw electrophysiological recordings are rarely clean, often being contaminated by noise sources that affect many channels simultaneously. This practice delves into Common Average Referencing (CAR), a cornerstone technique for mitigating such artifacts. By deriving its effects from first principles , you will learn precisely how CAR enhances signal quality by suppressing common-mode noise and quantify its impact on both signal amplitude and the crucial signal-to-noise ratio.",
            "id": "4138224",
            "problem": "A high-density silicon probe with $M = 384$ recording sites measures extracellular voltage. At a particular time $t_{0}$, a single neuron generates a spike that appears with identical peak amplitude $A$ on exactly $K = 3$ channels and is negligible on all other channels. Let each channel’s observed signal be the sum of a deterministic component and noise, written as $x_{i}(t) = s_{i}(t) + n_{i}(t)$, where the noise $n_{i}(t)$ is zero-mean, temporally white, identically distributed across channels with variance $\\sigma^{2}$, and uncorrelated between channels. The array applies Common Average Referencing (CAR), defined at each time $t$ by\n$$\ny_{i}(t) \\equiv x_{i}(t) - \\frac{1}{M} \\sum_{j=1}^{M} x_{j}(t).\n$$\nAssume CAR uses all $M$ channels, including the one being referenced. Define the signal-to-noise ratio (SNR) on a channel as the ratio of the spike’s peak amplitude to the noise standard deviation on that channel.\n\nStarting only from these definitions and assumptions:\n1) Derive the multiplicative factor by which CAR scales the spike’s peak amplitude on one of the $K$ spike-bearing channels at time $t_{0}$, expressed in terms of $K$ and $M$, and then evaluate it for $K = 3$ and $M = 384$ as an exact expression.\n2) Derive the multiplicative factor by which CAR rescales the SNR on a spike-bearing channel relative to the pre-CAR SNR, expressed in terms of $K$ and $M$, and then evaluate it exactly for $K = 3$ and $M = 384$.\n\nExpress your final answer as two exact unitless expressions ordered as [amplitude scaling factor, SNR scaling factor] in a single row matrix. Do not approximate or round; give exact closed-form expressions.",
            "solution": "The problem asks for two derivations related to the effect of Common Average Referencing (CAR) on a spike signal detected by a high-density electrophysiology probe. The first is the scaling factor for the spike's peak amplitude, and the second is the scaling factor for the signal-to-noise ratio (SNR).\n\nLet the set of all channels be $\\mathcal{M} = \\{1, 2, ..., M\\}$. The signal $x_i(t)$ on channel $i$ at time $t$ is given by $x_i(t) = s_i(t) + n_i(t)$, where $s_i(t)$ is the deterministic signal component and $n_i(t)$ is the noise. The noise $n_i(t)$ is zero-mean, $E[n_i(t)] = 0$, has variance $Var(n_i(t)) = \\sigma^2$ for all $i \\in \\mathcal{M}$, and is uncorrelated between channels, i.e., $E[n_i(t)n_j(t)] = 0$ for $i \\neq j$.\n\nAt the time of the spike peak, $t_0$, the signal from the neuron has amplitude $A$ on a specific set of $K$ channels, and is zero on the remaining $M-K$ channels. Without loss of generality, let the channels $\\{1, ..., K\\}$ be the spike-bearing channels.\nThe signal components at time $t_0$ are:\n$$\ns_i(t_0) =\n\\begin{cases}\nA & \\text{for } i \\in \\{1, ..., K\\} \\\\\n0 & \\text{for } i \\in \\{K+1, ..., M\\}\n\\end{cases}\n$$\nThe CAR-processed signal $y_i(t)$ is defined as:\n$$\ny_i(t) = x_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} x_j(t)\n$$\nWe can separate the signal and noise components of $y_i(t)$:\n$$\ny_i(t) = \\left(s_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} s_j(t)\\right) + \\left(n_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} n_j(t)\\right)\n$$\nLet's define the post-CAR signal component as $s'_i(t) = s_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} s_j(t)$ and the post-CAR noise component as $n'_i(t) = n_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} n_j(t)$.\n\n**1) Amplitude Scaling Factor**\n\nWe need to find the multiplicative factor by which CAR scales the spike's peak amplitude on a spike-bearing channel (e.g., channel $i=1$). The original amplitude is $s_1(t_0) = A$. The post-CAR amplitude is $s'_1(t_0)$.\n\nFirst, calculate the sum of all signal components at $t_0$:\n$$\n\\sum_{j=1}^{M} s_j(t_0) = \\sum_{j=1}^{K} A + \\sum_{j=K+1}^{M} 0 = K A\n$$\nThe post-CAR signal amplitude on a spike-bearing channel ($i \\in \\{1, ..., K\\}$) is:\n$$\ns'_i(t_0) = s_i(t_0) - \\frac{1}{M} \\sum_{j=1}^{M} s_j(t_0) = A - \\frac{1}{M} (K A) = A \\left(1 - \\frac{K}{M}\\right)\n$$\nThe multiplicative scaling factor for the amplitude is the ratio of the post-CAR amplitude to the pre-CAR amplitude:\n$$\n\\text{Amplitude Scaling Factor} = \\frac{s'_i(t_0)}{s_i(t_0)} = \\frac{A \\left(1 - \\frac{K}{M}\\right)}{A} = 1 - \\frac{K}{M}\n$$\nFor the given values $K = 3$ and $M = 384$:\n$$\n\\text{Amplitude Scaling Factor} = 1 - \\frac{3}{384} = 1 - \\frac{1}{128} = \\frac{128 - 1}{128} = \\frac{127}{128}\n$$\n\n**2) SNR Scaling Factor**\n\nThe SNR is defined as the ratio of the peak amplitude to the noise standard deviation.\n\nThe pre-CAR SNR for a spike-bearing channel is:\n$$\n\\text{SNR}_{\\text{pre}} = \\frac{\\text{Amplitude}_{\\text{pre}}}{\\text{StdDev}_{\\text{pre}}} = \\frac{A}{\\sigma}\n$$\nsince the original noise standard deviation is $\\sqrt{\\sigma^2} = \\sigma$.\n\nTo find the post-CAR SNR, we need the standard deviation of the post-CAR noise, $n'_i(t)$. Let's calculate its variance, $Var(n'_i(t))$. Since the noise is zero-mean, the post-CAR noise is also zero-mean:\n$E[n'_i(t)] = E[n_i(t)] - \\frac{1}{M} \\sum_{j=1}^{M} E[n_j(t)] = 0 - 0 = 0$.\nThe variance is:\n$$\nVar(n'_i(t)) = Var\\left(n_i(t) - \\frac{1}{M} \\sum_{j=1}^{M} n_j(t)\\right) = Var\\left(\\left(1-\\frac{1}{M}\\right)n_i(t) - \\frac{1}{M} \\sum_{j \\neq i} n_j(t)\\right)\n$$\nSince the noise signals $n_j(t)$ are uncorrelated, the variance of the sum is the sum of the variances:\n$$\nVar(n'_i(t)) = Var\\left(\\left(1-\\frac{1}{M}\\right)n_i(t)\\right) + \\sum_{j \\neq i} Var\\left(-\\frac{1}{M} n_j(t)\\right)\n$$\nUsing the property $Var(cZ) = c^2 Var(Z)$:\n$$\nVar(n'_i(t)) = \\left(1-\\frac{1}{M}\\right)^2 Var(n_i(t)) + \\sum_{j \\neq i} \\left(\\frac{1}{M}\\right)^2 Var(n_j(t))\n$$\nWe know $Var(n_j(t)) = \\sigma^2$ for all $j$. The sum over $j \\neq i$ has $M-1$ terms.\n$$\nVar(n'_i(t)) = \\left(1-\\frac{2}{M}+\\frac{1}{M^2}\\right)\\sigma^2 + (M-1) \\frac{1}{M^2}\\sigma^2\n$$\n$$\nVar(n'_i(t)) = \\sigma^2 \\left( 1 - \\frac{2}{M} + \\frac{1}{M^2} + \\frac{M-1}{M^2} \\right) = \\sigma^2 \\left( 1 - \\frac{2}{M} + \\frac{1}{M^2} + \\frac{1}{M} - \\frac{1}{M^2} \\right)\n$$\n$$\nVar(n'_i(t)) = \\sigma^2 \\left(1 - \\frac{1}{M}\\right)\n$$\nThe post-CAR noise standard deviation is $\\sigma' = \\sqrt{Var(n'_i(t))} = \\sigma \\sqrt{1 - \\frac{1}{M}}$.\n\nThe post-CAR SNR for a spike-bearing channel is:\n$$\n\\text{SNR}_{\\text{post}} = \\frac{\\text{Amplitude}_{\\text{post}}}{\\text{StdDev}_{\\text{post}}} = \\frac{A \\left(1 - \\frac{K}{M}\\right)}{\\sigma \\sqrt{1 - \\frac{1}{M}}}\n$$\nThe SNR scaling factor is the ratio $\\frac{\\text{SNR}_{\\text{post}}}{\\text{SNR}_{\\text{pre}}}$:\n$$\n\\text{SNR Scaling Factor} = \\frac{A \\left(1 - \\frac{K}{M}\\right) / \\left(\\sigma \\sqrt{1 - \\frac{1}{M}}\\right)}{A / \\sigma} = \\frac{1 - \\frac{K}{M}}{\\sqrt{1 - \\frac{1}{M}}}\n$$\nFor the given values $K = 3$ and $M = 384$:\n$$\n\\text{SNR Scaling Factor} = \\frac{1 - \\frac{3}{384}}{\\sqrt{1 - \\frac{1}{384}}} = \\frac{1 - \\frac{1}{128}}{\\sqrt{\\frac{383}{384}}} = \\frac{\\frac{127}{128}}{\\frac{\\sqrt{383}}{\\sqrt{384}}}\n$$\nWe can simplify $\\sqrt{384} = \\sqrt{64 \\times 6} = 8\\sqrt{6}$.\n$$\n\\text{SNR Scaling Factor} = \\frac{127}{128} \\cdot \\frac{8\\sqrt{6}}{\\sqrt{383}} = \\frac{127\\sqrt{6}}{16\\sqrt{383}}\n$$\nThis is the exact expression for the SNR scaling factor.\n\nThe final results are the amplitude scaling factor, $\\frac{127}{128}$, and the SNR scaling factor, $\\frac{127\\sqrt{6}}{16\\sqrt{383}}$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{127}{128} & \\frac{127\\sqrt{6}}{16\\sqrt{383}}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Once a clean signal is obtained, the next step towards identifying individual neurons is to characterize their unique action potential waveforms. This hands-on computational exercise  guides you through the process of extracting key biophysical features, such as spike width and repolarization dynamics, from a discrete waveform. Mastering this step is essential, as these features form the basis for the sophisticated clustering algorithms used in spike sorting.",
            "id": "4138195",
            "problem": "You are provided with a single-channel extracellular spike waveform segment sampled from a high-density electrophysiology probe. Starting from fundamental discrete-time signal definitions, construct spike features that capture key biophysical characteristics relevant for spike sorting and neuronal electrophysiology analysis. Specifically, you must derive and implement three features from the waveform segment: trough-to-peak time, repolarization slope, and energy, using only principles of discrete-time sampling and numerical differentiation.\n\nUse the following foundational base:\n- Discrete-time signals are samples of a continuous-time process taken at a fixed sampling rate $f_s$ in Hertz (Hertz (Hz) is cycles per second). The sampling period is $T_s = 1/f_s$ seconds. The discrete index $n$ corresponds to time $t = n T_s$ in seconds, or equivalently $t_{\\mathrm{ms}} = n \\cdot (1000/f_s)$ in milliseconds (millisecond (ms) is $10^{-3}$ seconds).\n- Numerical differentiation in discrete time can be approximated by a first-order forward difference: for a signal $w[n]$ in microvolts (microvolt ($\\mu$V) is $10^{-6}$ volts), the discrete-time slope over the interval from sample $n$ to $n+1$ is $\\Delta w / \\Delta t \\approx \\dfrac{w[n+1] - w[n]}{T_s}$, or in microvolts per millisecond $\\dfrac{w[n+1] - w[n]}{1000/f_s}$.\n- Discrete-time signal energy over a finite segment is the Riemann sum approximation to the continuous-time energy integral: $E \\approx \\sum_{n=0}^{N-1} w[n]^2 \\cdot T_s$. If expressed in microvolt-squared milliseconds, use $E_{\\mathrm{ms}} \\approx \\sum_{n=0}^{N-1} w[n]^2 \\cdot (1000/f_s)$.\n\nDefinitions for features to construct:\n1. Trough-to-peak time: Identify the trough sample index $n_{\\mathrm{trough}}$ as the index of the minimum value of $w[n]$ across the segment. Then identify the peak sample index $n_{\\mathrm{peak}}$ as the index of the maximum value of $w[n]$ among samples strictly after the trough, i.e., over $n \\in \\{n_{\\mathrm{trough}}+1, \\dots, N-1\\}$. If there is no sample after $n_{\\mathrm{trough}}$, set $n_{\\mathrm{peak}} = n_{\\mathrm{trough}}$. The trough-to-peak time is $\\Delta t_{\\mathrm{tp,ms}} = (n_{\\mathrm{peak}} - n_{\\mathrm{trough}}) \\cdot (1000/f_s)$, expressed in milliseconds.\n2. Repolarization slope: Over the interval from $n_{\\mathrm{trough}}$ to $n_{\\mathrm{peak}}$, compute the forward-difference slopes $s[n] = \\dfrac{w[n+1] - w[n]}{1000/f_s}$ for indices $n \\in \\{n_{\\mathrm{trough}}, \\dots, \\min(n_{\\mathrm{peak}}-1, N-2)\\}$. The repolarization slope is the maximum nonnegative value in this set. If all such slopes are negative, report $0$. Express the repolarization slope in microvolts per millisecond.\n3. Energy: Compute $E_{\\mathrm{ms}} = \\sum_{n=0}^{N-1} w[n]^2 \\cdot (1000/f_s)$, expressed in microvolt-squared milliseconds.\n\nScientific realism: Extracellular spikes typically exhibit a prominent negative deflection (trough) followed by a positive rebound (peak). Sampling rates for high-density probes commonly range between $20000$ and $40000$ Hertz. Amplitudes are typically in tens to hundreds of microvolts. The definitions above reflect standard discrete-time analyses used in neuroscience data analysis.\n\nYour program must implement these feature computations and apply them to the following test suite. Each waveform is given in microvolts and sampling rate in Hertz. The answer must be expressed in the specified units: trough-to-peak time in milliseconds, repolarization slope in microvolts per millisecond, and energy in microvolt-squared milliseconds. Angles are not involved in this problem. Do not use percentages.\n\nTest Suite:\n- Case $1$ (general realistic spike): $f_s = 30000$ Hertz, waveform $w[n]$ in microvolts:\n$[0,-5,-12,-20,-35,-60,-85,-110,-125,-140,-150,-145,-120,-80,-40,-10,5,20,35,50,60,55,40,20,5]$.\n- Case $2$ (boundary with trough at the last sample): $f_s = 20000$ Hertz, waveform $w[n]$ in microvolts:\n$[0,-1,-2,-3,-4,-5]$.\n- Case $3$ (edge case with a flat signal): $f_s = 30000$ Hertz, waveform $w[n]$ in microvolts:\n$[0,0,0,0,0,0,0,0,0,0]$.\n- Case $4$ (peak immediately follows trough): $f_s = 40000$ Hertz, waveform $w[n]$ in microvolts:\n$[2,0,-10,-50,-100,20,10,0]$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case result must be a list in the order $[\\Delta t_{\\mathrm{tp,ms}}, s_{\\mathrm{rep}}\\,(\\mu\\mathrm{V}/\\mathrm{ms}), E_{\\mathrm{ms}}]$. Aggregate the four case results into a single top-level list. For example, the overall output should look like $[[a_1,b_1,c_1],[a_2,b_2,c_2],[a_3,b_3,c_3],[a_4,b_4,c_4]]$, with numeric values replacing the symbols.",
            "solution": "We begin from the discrete-time representation of a continuous-time electrophysiological signal. Let $w[n]$ denote the waveform samples in microvolts, indexed by integer $n \\in \\{0,1,\\dots,N-1\\}$. The sampling rate is $f_s$ Hertz, hence the sampling period is $T_s = 1/f_s$ seconds. The time associated with index $n$ is $t = n T_s$ seconds, or $t_{\\mathrm{ms}} = n \\cdot (1000/f_s)$ milliseconds.\n\nFeature $1$: Trough-to-peak time. The trough index $n_{\\mathrm{trough}}$ is the minimizer of $w[n]$ across the entire segment:\n$$\nn_{\\mathrm{trough}} = \\operatorname{argmin}_{0 \\le n \\le N-1} w[n].\n$$\nThe peak index $n_{\\mathrm{peak}}$ is defined as the maximizer of $w[n]$ strictly after the trough:\n$$\nn_{\\mathrm{peak}} =\n\\begin{cases}\n\\operatorname{argmax}_{n_{\\mathrm{trough}} < n \\le N-1} w[n], & \\text{if } n_{\\mathrm{trough}} < N-1, \\\\\nn_{\\mathrm{trough}}, & \\text{if } n_{\\mathrm{trough}} = N-1.\n\\end{cases}\n$$\nThe trough-to-peak time difference in milliseconds is therefore\n$$\n\\Delta t_{\\mathrm{tp,ms}} = (n_{\\mathrm{peak}} - n_{\\mathrm{trough}}) \\cdot \\frac{1000}{f_s}.\n$$\nThis definition naturally handles the boundary case where the trough occurs at the last sample: the difference is zero.\n\nFeature $2$: Repolarization slope. Repolarization reflects the recovery from the negative trough toward more positive values. We approximate the derivative using the first-order forward difference, a well-tested numerical method appropriate for discrete-time signals:\n$$\ns[n] = \\frac{w[n+1] - w[n]}{1000/f_s} \\quad \\text{in } \\mu\\mathrm{V}/\\mathrm{ms}.\n$$\nWe compute this over the interval from the trough up to (but not including) the peak, ensuring indices remain valid:\n$$\nn \\in \\left\\{n_{\\mathrm{trough}}, n_{\\mathrm{trough}}+1, \\dots, \\min(n_{\\mathrm{peak}}-1, N-2) \\right\\}.\n$$\nTo capture the steepest repolarization, we take the maximum nonnegative slope in this set:\n$$\ns_{\\mathrm{rep}} = \\max\\left( \\{ s[n] \\}_{n} \\cup \\{0\\} \\right).\n$$\nIncluding $0$ ensures that if all computed slopes are negative (indicating no positive recovery in the specified interval), the reported repolarization slope is $0$.\n\nFeature $3$: Energy. The discrete-time energy is the Riemann sum approximation to the integral of squared amplitude. Expressed in microvolt-squared milliseconds:\n$$\nE_{\\mathrm{ms}} = \\sum_{n=0}^{N-1} w[n]^2 \\cdot \\frac{1000}{f_s}.\n$$\nThis quantity scales with both amplitude and duration and is standard in signal analysis for quantifying activity.\n\nAlgorithmic design:\n1. Compute $n_{\\mathrm{trough}}$ via a single pass to find the minimum of $w[n]$.\n2. If $n_{\\mathrm{trough}} < N-1$, find $n_{\\mathrm{peak}}$ by scanning $w[n]$ for $n > n_{\\mathrm{trough}}$ to locate its maximum. Otherwise set $n_{\\mathrm{peak}} = n_{\\mathrm{trough}}$.\n3. Compute $\\Delta t_{\\mathrm{tp,ms}}$ using the index difference scaled by $1000/f_s$.\n4. For repolarization slope, compute forward differences $s[n]$ over the specified interval. If the interval is empty (e.g., $n_{\\mathrm{peak}} \\le n_{\\mathrm{trough}}$ or $N < 2$), set $s_{\\mathrm{rep}} = 0$. Otherwise take the maximum of $s[n]$ clipped below by $0$.\n5. Compute energy $E_{\\mathrm{ms}}$ via the sum of squared amplitudes scaled by $1000/f_s$.\n\nEdge cases handled:\n- Trough at the last sample ($n_{\\mathrm{trough}} = N-1$): $n_{\\mathrm{peak}} = n_{\\mathrm{trough}}$, hence $\\Delta t_{\\mathrm{tp,ms}} = 0$, and the repolarization slope interval is empty, giving $s_{\\mathrm{rep}} = 0$.\n- Flat signal ($w[n] = 0$ for all $n$): trough and peak indices can be any consistent choice via the minimization and maximization; differences yield $\\Delta t_{\\mathrm{tp,ms}} = 0$, $s_{\\mathrm{rep}} = 0$, and $E_{\\mathrm{ms}} = 0$.\n- Immediate peak following trough: the time difference reduces to a single-sample interval $\\Delta t_{\\mathrm{tp,ms}} = (1000/f_s)$ and the repolarization slope equals the single forward difference over that interval.\n\nApplying the algorithm to the four test cases produces a well-defined list of three values per case $[\\Delta t_{\\mathrm{tp,ms}}, s_{\\mathrm{rep}}, E_{\\mathrm{ms}}]$, aggregated as a single top-level list, printed in the exact format required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_spike_features(waveform_uV: np.ndarray, fs_hz: float):\n    \"\"\"\n    Compute trough-to-peak time (ms), repolarization slope (uV/ms), and energy (uV^2*ms)\n    for a given single-channel waveform segment.\n    \"\"\"\n    N = waveform_uV.size\n    dt_ms = 1000.0 / fs_hz\n\n    # Edge case: empty waveform\n    if N == 0:\n        return [0.0, 0.0, 0.0]\n\n    # Trough index (minimum value)\n    n_trough = int(np.argmin(waveform_uV))\n\n    # Peak index after trough (if possible)\n    if n_trough < N - 1:\n        # Search for maximum strictly after trough\n        sub = waveform_uV[n_trough + 1:]\n        n_peak = n_trough + 1 + int(np.argmax(sub))\n    else:\n        n_peak = n_trough  # no sample after trough\n\n    # Trough-to-peak time in ms\n    t_tp_ms = (n_peak - n_trough) * dt_ms\n\n    # Repolarization slope using forward differences between trough and peak\n    # Valid indices for forward differences: n in [n_trough, min(n_peak-1, N-2)]\n    start = n_trough\n    end = min(n_peak - 1, N - 2)\n    if end >= start:\n        diffs = waveform_uV[start + 1 : end + 2] - waveform_uV[start : end + 1]\n        slopes_uV_per_ms = diffs / dt_ms\n        # Maximum nonnegative slope; if all negative, return 0\n        rep_slope = float(np.maximum(0.0, np.max(slopes_uV_per_ms)))\n    else:\n        rep_slope = 0.0\n\n    # Energy in uV^2 * ms\n    energy_uV2_ms = float(np.sum(waveform_uV.astype(float) ** 2) * dt_ms)\n\n    return [float(t_tp_ms), float(rep_slope), float(energy_uV2_ms)]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: general realistic spike\n        (\n            np.array([0,-5,-12,-20,-35,-60,-85,-110,-125,-140,-150,-145,-120,-80,-40,-10,5,20,35,50,60,55,40,20,5], dtype=float),\n            30000.0\n        ),\n        # Case 2: boundary with trough at the last sample\n        (\n            np.array([0,-1,-2,-3,-4,-5], dtype=float),\n            20000.0\n        ),\n        # Case 3: flat signal\n        (\n            np.array([0,0,0,0,0,0,0,0,0,0], dtype=float),\n            30000.0\n        ),\n        # Case 4: peak immediately follows trough\n        (\n            np.array([2,0,-10,-50,-100,20,10,0], dtype=float),\n            40000.0\n        ),\n    ]\n\n    results = []\n    for waveform, fs in test_cases:\n        t_ms, slope, energy = compute_spike_features(waveform, fs)\n        results.append([t_ms, slope, energy])\n\n    # Format the output exactly as a single-line comma-separated list enclosed in square brackets,\n    # with no spaces for strictness.\n    def fmt_triplet(trip):\n        # Format numbers with up to 6 decimal places to ensure deterministic string output\n        return \"[\" + \",\".join(f\"{x:.6f}\" for x in trip) + \"]\"\n\n    output = \"[\" + \",\".join(fmt_triplet(trip) for trip in results) + \"]\"\n    print(output)\n\nsolve()\n```"
        }
    ]
}