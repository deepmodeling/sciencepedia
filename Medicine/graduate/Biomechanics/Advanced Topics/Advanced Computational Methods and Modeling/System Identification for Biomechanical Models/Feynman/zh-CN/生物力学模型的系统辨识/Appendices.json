{
    "hands_on_practices": [
        {
            "introduction": "任何辨识实验的第一步都是选择合适的输入信号。不同的信号以不同的方式激励系统动态，错误的选择可能导致无法区分不同参数的影响。本练习探讨了各种常见输入——阶跃、扫频和伪随机二进制序列——的频率成分如何影响我们稳健地辨识关节模型的刚度 $k$ 和阻尼 $c$ 的能力。",
            "id": "4207813",
            "problem": "在小幅度的矢状面运动中，人类踝关节可以被建模为一个遵循旋转牛顿第二定律的线性旋转质量-弹簧-阻尼系统。关节角度为 $\\,\\theta(t)\\,$，施加的净力矩为 $\\,\\tau(t)\\,$，转动惯量为 $\\,J\\,$（假设已知），粘性阻尼系数为 $\\,c\\,$，线性刚度系数为 $\\,k\\,$。其控制动力学方程为 $\\,J\\,\\ddot{\\theta}(t)+c\\,\\dot{\\theta}(t)+k\\,\\theta(t)=\\tau(t)\\,$。您需要在一个固定的持续时间 $\\,T\\,$ 内设计一个输入力矩 $\\,\\tau(t)\\,$，该力矩需满足幅值限制 $\\,|\\tau(t)|\\leq A_{\\max}\\,$，并且所有候选输入的能量约束 $\\,\\int_{0}^{T}\\tau^{2}(t)\\,dt=E\\,$ 均相等。\n\n假设踝关节保持在线性范围内，与位形相关的 $\\,J\\,$ 是已知且恒定的，并且力矩和运动学上的测量噪声是零均值、独立、方差有限的近似白噪声。目标是使用标准的线性系统辨识方法，以最小的不确定性同时辨识 $\\,c\\,$ 和 $\\,k\\,$。激励质量的评判标准是实验能在多大程度上覆盖 $\\,c\\,$ 和 $\\,k\\,$ 的二维参数子空间。具体来说，您应该从第一性原理出发，分析 $\\,\\tau(t)\\,$ 中的频率成分分布、由此产生的运动学响应 $\\,\\theta(t)\\,$ 和 $\\,\\dot{\\theta}(t)\\,$，以及这些因素如何影响在控制动力学中区分 $\\,c\\,$ 和 $\\,k\\,$ 各自贡献的能力。\n\n考虑以下几类输入：\n- $\\,\\textbf{阶跃输入 (Step):}\\,$ $\\,\\tau(t)=\\tau_{0}\\,u(t)\\,$，其中 $\\,|\\tau_{0}|\\leq A_{\\max}\\,$，$\\,u(t)\\,$ 是单位阶跃函数。\n- $\\,\\textbf{啁啾信号 (Chirp, 线性频率扫描):}\\,$ $\\,\\tau(t)=A\\,\\sin\\big(2\\pi\\,(f_{0}\\,t+\\tfrac{\\beta}{2}\\,t^{2})\\big)\\,$，其中 $\\,|A|\\leq A_{\\max}\\,$，起始频率 $\\,f_{0}>0\\,$，扫描速率 $\\,\\beta>0\\,$，其选择应使瞬时频率在 $\\,[0,T]\\,$ 期间扫过一个宽频带。\n- $\\,\\textbf{伪随机二进制序列 (PRBS):}\\,$ 一个在 $\\,\\pm A\\,$ 之间以固定比特间隔 $\\,T_{b}\\,$ 切换的平衡序列，其中 $\\,|A|\\leq A_{\\max}\\,$，序列长度的选择应使其频谱在接近 $\\,\\omega_{b}\\approx\\pi/T_{b}\\,$ 的转折频率之前近似平坦，且总持续时间为 $\\,T\\,$。\n\n所有输入在 $\\,[0,T]\\,$ 上的能量 $\\,E\\,$ 都被约束为相同。在所述约束下，哪一类输入能够最鲁棒地激励刚度-阻尼参数子空间，即能够产生用于同时估计 $\\,c\\,$ 和 $\\,k\\,$ 的良态且相关性最小的运动学回归量？\n\nA. 阶跃输入，因为它最大化了低频成分并分离了 $\\,k\\,$ 的贡献。\n\nB. 啁啾输入，因为它扫过多个频率，并顺序地强调了 $\\,c\\,$ 和 $\\,k\\,$ 的效应。\n\nC. 伪随机二进制序列输入，因为其在 $\\,[0,\\omega_{b}]\\,$ 上的近白噪声谱能产生持续激励的运动学，并改善了对 $\\,c\\,$ 和 $\\,k\\,$ 的辨识条件。\n\nD. 以上都不是；在相等的能量和幅值约束下，所有三种输入对参数子空间的激励效果同样好。",
            "solution": "用户希望我解决并分析一个与踝关节生物力学模型相关的系统辨识问题。\n\n### 问题验证\n\n首先，我将验证问题陈述。\n\n**步骤 1：提取已知条件**\n\n- **模型：**一个线性旋转质量-弹簧-阻尼系统。\n- **控制方程：**$J\\,\\ddot{\\theta}(t)+c\\,\\dot{\\theta}(t)+k\\,\\theta(t)=\\tau(t)$。\n- **变量：**$\\theta(t)$ 是关节角度，$\\tau(t)$ 是施加的净力矩。\n- **参数：**$J$ 是转动惯量（已知，恒定），$c$ 是粘性阻尼系数（未知），$k$ 是线性刚度系数（未知）。\n- **输入约束：**\n    - 持续时间：$[0, T]$。\n    - 幅值：$|\\tau(t)|\\leq A_{\\max}$。\n    - 能量：$\\int_{0}^{T}\\tau^{2}(t)\\,dt=E$。\n- **假设：**\n    - 踝关节运动是小幅度的，并保持在线性范围内。\n    - $J$ 是已知且恒定的。\n    - 测量噪声是零均值、独立、方差有限的近似白噪声。\n- **目标：**以最小不确定性同时辨识 $c$ 和 $k$。\n- **标准：**激励质量的评判标准是实验产生的运动学回归量（$\\theta(t)$，$\\dot{\\theta}(t)$）的良态性和最小相关性程度。\n- **输入类别：**\n    - **阶跃：**$\\tau(t)=\\tau_{0}\\,u(t)\\,$，其中 $|\\tau_{0}|\\leq A_{\\max}$。\n    - **啁啾：**$\\tau(t)=A\\,\\sin\\big(2\\pi\\,(f_{0}\\,t+\\tfrac{\\beta}{2}\\,t^{2})\\big)\\,$，其中 $|A|\\leq A_{\\max}$，$f_{0}>0\\,$，$\\beta>0$。\n    - **伪随机二进制序列 (PRBS)：**一个在 $\\pm A\\,$ 之间以固定比特间隔 $T_{b}$ 切换的平衡序列，其中 $|A|\\leq A_{\\max}$，且频谱在达到 $\\omega_{b}\\approx\\pi/T_{b}$ 之前近似平坦。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n- **科学依据：**是。该问题使用了一个标准的二阶线性时不变 (LTI) 模型，这是力学和控制理论的基石。将其应用于小幅度生物力学关节运动是一种常见且有效的简化。系统辨识、持续激励、输入设计以及信息矩阵的条件数等概念都是工程学和应用数学中公认的原理。\n- **适定性：**是。该问题定义明确。它要求对三种标准输入信号进行定性比较，以实现一个具体、清晰的目标（以最小不确定性同时辨识两个参数）。成功的标准——良态且相关性最小的回归量——是系统辨识中一个精确的技术概念。\n- **客观性：**是。语言技术性强、精确，没有主观或含糊的术语。所有约束和假设都已明确说明。\n\n**步骤 3：结论与行动**\n\n问题陈述在科学上是合理的，适定的，客观的，并且是完整的。它提出了一个系统辨识实验设计中的经典且非平凡的问题。因此，该问题是**有效的**。我将继续进行求解。\n\n### 推导与分析\n\n目标是同时估计控制方程中的参数 $c$ 和 $k$：\n$$J\\,\\ddot{\\theta}(t)+c\\,\\dot{\\theta}(t)+k\\,\\theta(t)=\\tau(t)$$\n由于惯量 $J$ 是已知的，我们可以重新排列方程以建立一个线性回归问题。测量的量是力矩 $\\tau(t)$ 和运动学量 $\\theta(t)$、$\\dot{\\theta}(t)$ 和 $\\ddot{\\theta}(t)$（可以通过对 $\\theta(t)$ 的测量值进行微分得到）。我们定义一个方程误差 $e(t)$：\n$$e(t) = c\\,\\dot{\\theta}(t) + k\\,\\theta(t) - (\\tau(t) - J\\,\\ddot{\\theta}(t))$$\n最小二乘辨识的目标是找到参数 $\\hat{c}$ 和 $\\hat{k}$，以最小化误差平方的积分 $\\int_{0}^{T} e(t)^2 dt$。这可以写成标准的线性回归形式 $y(t) = \\mathbf{\\phi}^T \\mathbf{x}(t)$，其中：\n- $\\mathbf{\\phi} = \\begin{bmatrix} c \\\\ k \\end{bmatrix}$ 是未知参数的向量。\n- $\\mathbf{x}(t) = \\begin{bmatrix} \\dot{\\theta}(t) \\\\ \\theta(t) \\end{bmatrix}$ 是回归量（运动学测量值）的向量。\n- $y(t) = \\tau(t) - J\\,\\ddot{\\theta}(t)$ 是计算出的“输出”。\n\n最小二乘估计 $\\hat{\\mathbf{\\phi}}$ 由下式给出：\n$$\\hat{\\mathbf{\\phi}} = \\left( \\int_{0}^{T} \\mathbf{x}(t) \\mathbf{x}(t)^T dt \\right)^{-1} \\left( \\int_{0}^{T} \\mathbf{x}(t) y(t) dt \\right)$$\n在白噪声存在的情况下，此估计的不确定性（协方差）与“信息矩阵” $\\mathbf{M}$ 的逆成正比：\n$$\\mathbf{M} = \\int_{0}^{T} \\mathbf{x}(t) \\mathbf{x}(t)^T dt = \\int_{0}^{T} \\begin{bmatrix} \\dot{\\theta}(t)^2 & \\dot{\\theta}(t)\\theta(t) \\\\ \\dot{\\theta}(t)\\theta(t) & \\theta(t)^2 \\end{bmatrix} dt$$\n为了在 $c$ 和 $k$ 的估计中实现“最小不确定性”，矩阵 $\\mathbf{M}$ 必须在某种意义上被“最大化”，具体来说，它必须是良态的。一个良态的矩阵 $\\mathbf{M}$ 具有两个关键属性：\n1.  **必须可逆。** 这要求其行列式不为零，意味着回归量 $\\dot{\\theta}(t)$ 和 $\\theta(t)$ 不是线性相关的。这就是**持续激励**的条件。输入 $\\tau(t)$ 必须足够丰富，以激励系统的所有模式。\n2.  **其条件数应较小。** 这通常意味着非对角线项（$\\int \\dot{\\theta}\\theta dt$）相对于对角线项（$\\int \\dot{\\theta}^2 dt$ 和 $\\int \\theta^2 dt$）较小。这确保了对 $c$ 和 $k$ 的估计是解耦且鲁棒的。\n\n回归量 $\\dot{\\theta}(t)$ 和 $\\theta(t)$ 的特性由通过系统动力学滤波后的输入 $\\tau(t)$ 决定。该系统的传递函数为 $H(s) = \\frac{\\Theta(s)}{\\Tau(s)} = \\frac{1}{Js^2 + cs + k}$。这是一个二阶低通滤波器。为了区分 $c$ 和 $k$ 的效应，我们必须用能够突显它们各自贡献的频率来激励系统。\n- 刚度 $k$ 主导低频和静态响应（$\\tau \\approx k\\theta$）。\n- 阻尼 $c$ 在系统固有频率附近具有最显著的影响，此时速度相对于位移和力较大。\n\n现在，我们根据每种输入类别产生良态回归量的能力来评估它们。\n\n- **阶跃输入：**$\\tau(t) = \\tau_0 u(t)$。阶跃函数的傅里叶变换集中在零频率，其功率以 $1/f^2$ 的速率衰减。它能强烈激励静态响应，从而可以根据稳态偏转 $\\theta_{ss} = \\tau_0/k$ 很好地估计 $k$。然而，在初始瞬态之后，$\\dot{\\theta}(t) \\to 0$，不再提供关于阻尼 $c$ 的进一步信息。激励不是持续的。虽然它会产生一个 $c$ 和 $k$ 都起作用的瞬态响应，但这个信息丰富阶段的持续时间有限，导致用于同时估计的信息矩阵是病态的。\n\n- **啁啾输入：**$\\tau(t) = A\\sin(\\dots)$。啁啾输入会扫过一个频带。这是一种持续激励的形式。通过设计扫描以覆盖系统的特征频率，可以确保刚度主导（低频）和阻尼主导（中频）的区域都得到激励。这比阶跃输入有了显著改进，因为它在整个实验过程中持续产生关于 $c$ 和 $k$ 的信息。\n\n- **伪随机二进制序列 (PRBS)：**该信号在一个宽频率范围内（从直流到一个与比特间隔 $T_b$ 相关的转折频率）具有近似平坦（“白色”）的功率谱。在宽频带上同时均匀地注入能量是激励线性系统所有动态特性的标准方法。这种持续的宽带激励确保了两个回归量 $\\theta(t)$ 和 $\\dot{\\theta}(t)$ 都具有显著的功率。信号的随机性倾向于在积分时间 $T$ 内使响应与其导数去相关，从而最小化信息矩阵 $\\mathbf{M}$ 的非对角线项。这会产生一个良态矩阵，这是获得鲁棒、最小方差和解耦的 $c$ 和 $k$ 估计的直接数学要求。与顺序激励频率的啁啾信号相比，PRBS 同时激励所有频率，其更平坦的功率谱使其在系统精确动态特性未知时，成为系统辨识中一个更具通用鲁棒性的选择。\n\n**结论：** PRBS 是更优的选择，因为其近白噪声谱在所有相关频率上提供了最均匀和持续的激励，这反过来又为多参数的同时估计产生了条件最好的信息矩阵。\n\n### 逐项分析\n\n**A. 阶跃输入，因为它最大化了低频成分并分离了 $\\,k\\,$ 的贡献。** 这个说法部分正确，因为阶跃输入对于从静态响应中辨识 $k$ 是有效的。但是，它对于辨识 $c$ 效果很差，更关键的是，对于以最小不确定性*同时*辨识 $c$ 和 $k$ 效果很差。它不满足“持续激励”准则，导致用于所述目标的信息矩阵是病态的。**结论：不正确。**\n\n**B. 啁啾输入，因为它扫过多个频率，并顺序地强调了 $\\,c\\,$ 和 $\\,k\\,$ 的效应。** 这个说法正确地描述了啁啾输入的好处。它是一种很好的持续激励方法，远优于阶跃输入。它确实激励了与 $c$ 和 $k$ 相关的动态。然而，必须相对于其他选项来评估这一说法。**结论：不正确。** 虽然它是一个好的输入，但基于上述原因，与 PRBS 相比，它不是*最鲁棒*的。PRBS 的更平坦、更宽的频谱提供了更均匀的激励。\n\n**C. 伪随机二进制序列输入，因为其在 $\\,[0,\\omega_{b}]\\,$ 上的近白噪声谱能产生持续激励的运动学，并改善了对 $\\,c\\,$ 和 $\\,k\\,$ 的辨识条件。** 这个说法准确地抓住了 PRBS 用于线性系统辨识的关键优势。“近白噪声谱”导致“持续激励的运动学”，这又反过来“改善了条件数”。这直接满足了为同时估计产生良态且相关性最小的回归量的标准，从而带来最小的不确定性。这是给定选项中理论上的最优选择。**结论：正确。**\n\n**D. 以上都不是；在相等的能量和幅值约束下，所有三种输入对参数子空间的激励效果同样好。** 这个说法根本上是错误的。系统辨识的一个核心原则是，输入信号的选择对最终参数估计的质量至关重要。这些输入的频率成分差异巨大，导致对系统动态的激励截然不同，因此估计问题的条件数也不同。**结论：不正确。**",
            "answer": "$$\\boxed{C}$$"
        },
        {
            "introduction": "一旦选定了输入信号的类型，我们可以进一步优化实验，以最大化我们收集到的关于特定模型参数的信息。费雪信息矩阵 (Fisher Information Matrix, FIM) 提供了一个强大的数学工具来量化这些信息，并在实验执行前指导实验设计。在本练习中，您将推导肌肉模型输出对其参数的灵敏度，并利用FIM来确定最优的肌肉激活模式，以最好地辨识关键生理学特性。",
            "id": "4207826",
            "problem": "考虑一个单肌、单自由度的铰链关节，其力臂 $r$ 为常数且肌腱为刚性。关节角度 $q(t)$ 是预设的，并且测量没有误差。肌肉肌腱几何结构线性化为 $l_{m}(q) = l_{m,\\mathrm{ref}} - r\\,(q - q_{\\mathrm{ref}})$，其中 $l_{m,\\mathrm{ref}}$ 和 $q_{\\mathrm{ref}}$ 是已知常数。在所考虑的运动范围内，羽状角和被动力均可忽略不计。肌肉被建模为一个 Hill 型致动器，其激活度 $a(t)$ 由肌电图 (EMG) 激励 $u(t)$ 驱动。假设在准静态条件下，$a(t) \\approx u(t)$（一阶激活动力学相对于测量时间足够快），并且肌纤维速度足够小，因此力-速度因子 $f_{v} \\approx 1$。\n\n主动肌力为 $F_{\\mathrm{act}}(t) = a(t)\\,F_{\\max}\\,f_{\\ell}(\\lambda(t))$，其中 $F_{\\max}$ 是肌肉的最大等长力，$l_{0}$ 是最优纤维长度，$\\lambda(t) = l_{m}(t)/l_{0}$ 是归一化纤维长度，主动力-长度曲线指定为\n$$\nf_{\\ell}(\\lambda) = \\exp\\!\\left(-\\frac{(\\lambda - 1)^{2}}{w^{2}}\\right),\n$$\n其中 $w > 0$ 是已知的宽度参数。产生的关节力矩为 $\\tau(t) = r\\,F_{\\mathrm{act}}(t)$。\n\n您将在预设运动过程中的 $t_{1}$ 和 $t_{2}$ 时刻获取两次力矩测量值，其对应的关节角度为 $q_{1} = q(t_{1})$ 和 $q_{2} = q(t_{2})$，由此得到肌肉长度 $l_{m,1} = l_{m}(q_{1})$ 和 $l_{m,2} = l_{m}(q_{2})$，以及归一化长度 $\\lambda_{1} = l_{m,1}/l_{0}$ 和 $\\lambda_{2} = l_{m,2}/l_{0}$。在这些时刻，您将分别施加 EMG 激励幅值 $u_{1}$ 和 $u_{2}$，其中 $0 \\leq u_{k} \\leq 1$。假设每个时刻的力矩测量噪声是独立的、零均值的高斯噪声，其方差为 $\\sigma^{2}$。\n\n任务：\n1. 推导在通用时间 $t$ 时，力矩相对于参数 $\\theta = \\begin{pmatrix} F_{\\max} & l_{0} \\end{pmatrix}^{\\mathsf{T}}$ 的灵敏度向量，即\n$$\ns(t) = \\begin{pmatrix} \\frac{\\partial \\tau(t)}{\\partial F_{\\max}} \\\\[4pt] \\frac{\\partial \\tau(t)}{\\partial l_{0}} \\end{pmatrix},\n$$\n并用 $r$、$a(t)$、$F_{\\max}$、$l_{m}(t)$、$l_{0}$ 和 $w$ 表示。\n\n2. 使用任务 1 的结果，将两次测量实验的费雪信息矩阵写为\n$$\n\\mathcal{I}(\\theta) = \\frac{1}{\\sigma^{2}}\\sum_{k=1}^{2} s(t_{k})\\,s(t_{k})^{\\mathsf{T}},\n$$\n并在给定总激励预算 $A > 0$ 的约束条件 $u_{1}^{2} + u_{2}^{2} = A^{2}$ 下，确定能使 $\\det\\!\\big(\\mathcal{I}(\\theta)\\big)$ 最大化的 $u_{1}$ 和 $u_{2}$ 的选择。假设 $q_{1} \\neq q_{2}$，因此两个灵敏度向量不共线，并假设 $A$ 的值使得最优的 $u_{1}$ 和 $u_{2}$ 位于 $[0,1]$ 区间内。\n\n答案规格：\n- 以 $1 \\times 2$ 行矩阵 $\\begin{pmatrix} u_{1}^{\\star} & u_{2}^{\\star} \\end{pmatrix}$ 的形式，提供两次测量时刻的最优 EMG 激励幅值作为最终答案。\n- 将最终答案表示为仅含 $A$ 的符号函数。在最终的方框答案中不要包含单位。",
            "solution": "用户希望我解决一个与 Hill 型肌肉模型相关的系统辨识问题。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n\n- **模型几何与运动学：**\n  - 关节角度：$q(t)$ (预设，无误差已知)。\n  - 力臂：$r$ (常数)。\n  - 肌腱：刚性。\n  - 肌肉肌腱长度：$l_{m}(q) = l_{m,\\mathrm{ref}} - r\\,(q - q_{\\mathrm{ref}})$，其中 $l_{m,\\mathrm{ref}}$ 和 $q_{\\mathrm{ref}}$ 是已知常数。\n  - 羽状角：可忽略。\n- **肌肉模型 (Hill 型)：**\n  - 激励：$u(t)$，来自肌电图 (EMG)。\n  - 激活度：$a(t)$。\n  - 准静态假设：$a(t) \\approx u(t)$。\n  - 力-速度因子：$f_{v} \\approx 1$。\n  - 被动力：可忽略。\n  - 主动肌力：$F_{\\mathrm{act}}(t) = a(t)\\,F_{\\max}\\,f_{\\ell}(\\lambda(t))$。\n  - 最大等长力：$F_{\\max}$。\n  - 最优纤维长度：$l_{0}$。\n  - 归一化纤维长度：$\\lambda(t) = l_{m}(t)/l_{0}$。\n  - 主动力-长度曲线：$f_{\\ell}(\\lambda) = \\exp\\left(-\\frac{(\\lambda - 1)^{2}}{w^{2}}\\right)$，其中宽度参数 $w > 0$ 已知。\n- **关节力矩：**\n  - 力矩方程：$\\tau(t) = r\\,F_{\\mathrm{act}}(t)$。\n- **实验设置：**\n  - 在时间 $t_{1}$ 和 $t_{2}$ 进行两次测量。\n  - 对应条件：$q_{1} = q(t_{1})$, $l_{m,1} = l_{m}(q_{1})$, $\\lambda_{1} = l_{m,1}/l_{0}$, $u_{1} = u(t_{1})$。\n  - 对应条件：$q_{2} = q(t_{2})$, $l_{m,2} = l_{m}(q_{2})$, $\\lambda_{2} = l_{m,2}/l_{0}$, $u_{2} = u(t_{2})$。\n  - 假设：$q_{1} \\neq q_{2}$。\n  - 测量噪声：独立、零均值的高斯噪声，方差为 $\\sigma^{2}$。\n  - 激励预算约束：$u_{1}^{2} + u_{2}^{2} = A^{2}$，对于给定的 $A > 0$。\n  - 激励范围：$0 \\leq u_{k} \\leq 1$。假设最优的 $u_1, u_2$ 在此范围内。\n- **待辨识参数：**\n  - 参数向量：$\\theta = \\begin{pmatrix} F_{\\max} & l_{0} \\end{pmatrix}^{\\mathsf{T}}$。\n- **任务：**\n  1. 推导灵敏度向量 $s(t) = \\begin{pmatrix} \\frac{\\partial \\tau(t)}{\\partial F_{\\max}} & \\frac{\\partial \\tau(t)}{\\partial l_{0}} \\end{pmatrix}^{\\mathsf{T}}$。\n  2. 定义费雪信息矩阵 $\\mathcal{I}(\\theta) = \\frac{1}{\\sigma^{2}}\\sum_{k=1}^{2} s(t_{k})\\,s(t_{k})^{\\mathsf{T}}$ 并在给定的预算约束下，找到使 $\\det(\\mathcal{I})$ 最大化的最优 $u_{1}, u_{2}$。\n\n**第 2 步：使用提取的已知条件进行验证**\n\n- **科学依据：**该问题使用了一个简化但标准的 Hill 型肌肉模型，这是生物力学的一个基石。系统辨识、灵敏度分析和费雪信息的概念是工程和科学领域中用于参数估计和实验设计的标准方法。在生物力学建模的背景下，所有前提在事实上和科学上都是合理的。\n- **适定性：**问题定义清晰。它要求进行特定的推导和一个具有明确目标函数和约束的优化问题。非共线性假设 ($q_{1} \\neq q_{2}$) 确保费雪信息矩阵是可逆的，从而使优化有意义。\n- **客观性：**问题使用精确的数学和科学语言陈述，没有主观性或个人观点。\n- **完整性和一致性：**所有必需的方程、变量和约束都已提供。假设（例如，准静态、被动力可忽略）被明确说明，并用于创建一个易于处理的问题。设置中没有矛盾之处。\n- **现实性：**虽然是对现实的简化，但该模型和问题结构代表了生物力学领域的实际研究问题。条件在物理上是合理的。\n\n**第 3 步：结论与行动**\n\n该问题在科学上是合理的、适定的、客观的且自洽的。这是一个有效的问题。\n\n### 求解过程\n\n**任务 1：推导灵敏度向量**\n\n关节力矩 $\\tau(t)$ 由力臂 $r$ 和主动肌力 $F_{\\mathrm{act}}(t)$ 的乘积给出。\n首先，我们通过代入给定的模型分量来写出力矩的完整表达式：\n$$\n\\tau(t) = r \\, F_{\\mathrm{act}}(t) = r \\, a(t) \\, F_{\\max} \\, f_{\\ell}(\\lambda(t))\n$$\n使用准静态假设 $a(t) \\approx u(t)$ 以及力-长度关系的定义 $f_{\\ell}(\\lambda)$，我们得到：\n$$\n\\tau(t) = r \\, u(t) \\, F_{\\max} \\, \\exp\\left(-\\frac{(\\lambda(t) - 1)^{2}}{w^{2}}\\right)\n$$\n其中归一化肌纤维长度为 $\\lambda(t) = l_{m}(t)/l_{0}$。待辨识的参数是 $\\theta = \\begin{pmatrix} F_{\\max} & l_{0} \\end{pmatrix}^{\\mathsf{T}}$。我们需要计算灵敏度向量 $s(t) = \\left( \\frac{\\partial \\tau}{\\partial F_{\\max}}, \\frac{\\partial \\tau}{\\partial l_{0}} \\right)^{\\mathsf{T}}$。\n\n1.  **关于 $F_{\\max}$ 的偏导数：**\n    我们将所有其他变量和参数（包括 $l_{0}$）视为常数。\n    $$\n    \\frac{\\partial \\tau(t)}{\\partial F_{\\max}} = \\frac{\\partial}{\\partial F_{\\max}} \\left[ r \\, u(t) \\, F_{\\max} \\, f_{\\ell}(\\lambda(t)) \\right] = r \\, u(t) \\, f_{\\ell}(\\lambda(t))\n    $$\n    这是因为 $\\lambda(t)=l_m(t)/l_0$ 不依赖于 $F_{max}$。\n\n2.  **关于 $l_{0}$ 的偏导数：**\n    这需要使用链式法则，因为 $\\tau(t)$ 通过归一化长度 $\\lambda(t)$ 依赖于 $l_{0}$。\n    $$\n    \\frac{\\partial \\tau(t)}{\\partial l_{0}} = r \\, u(t) \\, F_{\\max} \\, \\frac{\\partial}{\\partial l_{0}} \\left[ f_{\\ell}(\\lambda(t)) \\right]\n    $$\n    使用链式法则：$\\frac{\\partial f_{\\ell}}{\\partial l_{0}} = \\frac{d f_{\\ell}}{d \\lambda} \\frac{\\partial \\lambda}{\\partial l_{0}}$。\n    我们来计算每个部分：\n    - 力-长度曲线 $f_{\\ell}(\\lambda)$ 关于 $\\lambda$ 的导数：\n      $$\n      \\frac{d f_{\\ell}}{d \\lambda} = \\frac{d}{d \\lambda} \\exp\\left(-\\frac{(\\lambda - 1)^{2}}{w^{2}}\\right) = \\exp\\left(-\\frac{(\\lambda - 1)^{2}}{w^{2}}\\right) \\cdot \\left( -\\frac{2(\\lambda - 1)}{w^{2}} \\right) = -f_{\\ell}(\\lambda) \\frac{2(\\lambda - 1)}{w^{2}}\n      $$\n    - $\\lambda(t)$ 关于 $l_{0}$ 的偏导数：\n      $$\n      \\frac{\\partial \\lambda(t)}{\\partial l_{0}} = \\frac{\\partial}{\\partial l_{0}} \\left( \\frac{l_{m}(t)}{l_{0}} \\right) = - \\frac{l_{m}(t)}{l_{0}^{2}} = - \\frac{\\lambda(t)}{l_{0}}\n      $$\n    - 综合这些结果：\n      $$\n      \\frac{\\partial f_{\\ell}}{\\partial l_{0}} = \\left( -f_{\\ell}(\\lambda(t)) \\frac{2(\\lambda(t) - 1)}{w^{2}} \\right) \\left( - \\frac{\\lambda(t)}{l_{0}} \\right) = f_{\\ell}(\\lambda(t)) \\frac{2 \\lambda(t) (\\lambda(t) - 1)}{l_{0} w^{2}}\n      $$\n    - 代回 $\\frac{\\partial \\tau(t)}{\\partial l_{0}}$ 的表达式中：\n      $$\n      \\frac{\\partial \\tau(t)}{\\partial l_{0}} = r \\, u(t) \\, F_{\\max} \\, \\left( f_{\\ell}(\\lambda(t)) \\frac{2 \\lambda(t) (\\lambda(t) - 1)}{l_{0} w^{2}} \\right)\n      $$\n      这可以更紧凑地写为：\n      $$\n      \\frac{\\partial \\tau(t)}{\\partial l_{0}} = \\left( r \\, u(t) \\, f_{\\ell}(\\lambda(t)) \\right) \\frac{2 F_{\\max} \\lambda(t) (\\lambda(t) - 1)}{l_{0} w^{2}}\n      $$\n\n3.  **组合灵敏度向量 $s(t)$：**\n    当 $a(t) = u(t)$ 时，灵敏度向量为：\n    $$\n    s(t) = \\begin{pmatrix} \\frac{\\partial \\tau(t)}{\\partial F_{\\max}} \\\\ \\\\ \\frac{\\partial \\tau(t)}{\\partial l_{0}} \\end{pmatrix} = \\begin{pmatrix} r \\, u(t) \\, f_{\\ell}(\\lambda(t)) \\\\ \\\\ r \\, u(t) \\, F_{\\max} \\, f_{\\ell}(\\lambda(t)) \\frac{2 \\lambda(t) (\\lambda(t) - 1)}{l_{0} w^{2}} \\end{pmatrix}\n    $$\n    我们可以提取公因式：\n    $$\n    s(t) = r \\, u(t) \\, f_{\\ell}(\\lambda(t)) \\begin{pmatrix} 1 \\\\ \\\\ \\frac{2 F_{\\max} \\lambda(t) (\\lambda(t) - 1)}{l_{0} w^{2}} \\end{pmatrix}\n    $$\n    该表达式如题所求，是用 $r$、$a(t)=u(t)$、$F_{\\max}$、$l_{m}(t)$（通过 $\\lambda(t)$）、$l_{0}$ 和 $w$ 表示的。\n\n**任务 2：确定最优 EMG 激励**\n\n两次测量实验的费雪信息矩阵 (FIM) 由以下公式给出：\n$$\n\\mathcal{I}(\\theta) = \\frac{1}{\\sigma^{2}}\\sum_{k=1}^{2} s(t_{k})\\,s(t_{k})^{\\mathsf{T}} = \\frac{1}{\\sigma^{2}} \\left( s_{1}s_{1}^{\\mathsf{T}} + s_{2}s_{2}^{\\mathsf{T}} \\right)\n$$\n其中 $s_{k} = s(t_k)$。从任务 1 可知，灵敏度向量 $s_k$ 在激励 $u_k$ 上是线性的。我们可以写成 $s_k = u_k v_k$，其中 $v_k$ 是一个取决于系统在时间 $t_k$ 的属性，但不取决于控制输入 $u_k$ 的向量：\n$$\nv_k = r \\, f_{\\ell}(\\lambda_k) \\begin{pmatrix} 1 \\\\ \\\\ \\frac{2 F_{\\max} \\lambda_k (\\lambda_k - 1)}{l_{0} w^{2}} \\end{pmatrix}\n$$\n将 $s_k = u_k v_k$ 代入 FIM 表达式：\n$$\n\\mathcal{I} = \\frac{1}{\\sigma^{2}} \\left( (u_{1}v_{1})(u_{1}v_{1})^{\\mathsf{T}} + (u_{2}v_{2})(u_{2}v_{2})^{\\mathsf{T}} \\right) = \\frac{1}{\\sigma^{2}} \\left( u_{1}^{2} v_{1}v_{1}^{\\mathsf{T}} + u_{2}^{2} v_{2}v_{2}^{\\mathsf{T}} \\right)\n$$\n令 $V$ 是一个 $2 \\times 2$ 矩阵，其列为 $v_1$ 和 $v_2$，即 $V = \\begin{pmatrix} v_1 & v_2 \\end{pmatrix}$。令 $U^2$ 是对角矩阵 $\\mathrm{diag}(u_{1}^2, u_{2}^2)$。FIM可以写成 $\\mathcal{I} = \\frac{1}{\\sigma^2} V U^2 V^{\\mathsf{T}}$。\n我们想要最大化 FIM 的行列式 $\\det(\\mathcal{I})$。使用性质 $\\det(ABC) = \\det(A)\\det(B)\\det(C)$：\n$$\n\\det(\\mathcal{I}) = \\det\\left(\\frac{1}{\\sigma^2} V U^2 V^{\\mathsf{T}}\\right) = \\left(\\frac{1}{\\sigma^2}\\right)^2 \\det(V) \\det(U^2) \\det(V^{\\mathsf{T}})\n$$\n因为 $\\det(V^{\\mathsf{T}}) = \\det(V)$ 且 $\\det(U^2) = u_{1}^{2}u_{2}^{2}$：\n$$\n\\det(\\mathcal{I}) = \\frac{1}{\\sigma^4} (\\det(V))^{2} u_{1}^{2}u_{2}^{2}\n$$\n问题陈述 $q_1 \\neq q_2$，这意味着 $\\lambda_1 \\neq \\lambda_2$（除非 $r=0$ 这个平凡情况）。这保证了向量 $v_1$ 和 $v_2$ 不共线，所以 $\\det(V) \\neq 0$。相对于优化变量 $u_1$ 和 $u_2$ 而言，$K = \\frac{(\\det(V))^2}{\\sigma^4}$ 是一个正常数。\n\n优化问题是在约束条件 $g(u_1, u_2) = u_{1}^{2} + u_{2}^{2} - A^2 = 0$ 和 $u_1, u_2 \\ge 0$ 下，最大化目标函数 $f(u_1, u_2) = K u_{1}^{2}u_{2}^{2}$。最大化 $K u_{1}^{2}u_{2}^{2}$ 等价于最大化乘积 $P = u_{1}^{2}u_{2}^{2}$。\n\n令 $x = u_{1}^{2}$ 和 $y = u_{2}^{2}$。问题变为：\n- 最大化 $P = xy$\n- 约束条件为 $x + y = A^2$，$x \\geq 0$，$y \\geq 0$。\n\n这是一个经典问题。根据算术平均值-几何平均值 (AM-GM) 不等式，对于非负的 $x$ 和 $y$：\n$$\n\\frac{x+y}{2} \\geq \\sqrt{xy}\n$$\n代入约束条件 $x+y = A^2$：\n$$\n\\frac{A^2}{2} \\geq \\sqrt{P} \\implies P \\leq \\frac{A^4}{4}\n$$\n$P$ 的最大值在等号成立时达到，这当且仅当 $x=y$ 时发生。\n因此，我们必须有 $u_{1}^{2} = u_{2}^{2}$。因为激励 $u_1$ 和 $u_2$ 必须为非负值 ($0 \\le u_k \\le 1$)，这意味着 $u_1=u_2$。\n\n将 $u_1=u_2$ 代入约束方程：\n$$\nu_{1}^{2} + u_{1}^{2} = A^2 \\implies 2u_{1}^{2} = A^2 \\implies u_{1}^{2} = \\frac{A^2}{2}\n$$\n取正平方根得到最优激励：\n$$\nu_{1}^{\\star} = \\frac{A}{\\sqrt{2}}\n$$\n并且因为 $u_2 = u_1$，我们有：\n$$\nu_{2}^{\\star} = \\frac{A}{\\sqrt{2}}\n$$\n问题陈述中假设 $A$ 的值使得这些最优值位于允许的范围 $[0, 1]$ 内，因此我们不需要考虑边界解。\n\n最优的 EMG 激励幅值为 $\\begin{pmatrix} u_{1}^{\\star} & u_{2}^{\\star} \\end{pmatrix} = \\begin{pmatrix} \\frac{A}{\\sqrt{2}} & \\frac{A}{\\sqrt{2}} \\end{pmatrix}$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{A}{\\sqrt{2}} & \\frac{A}{\\sqrt{2}}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "系统辨识并非在参数估计完成后就结束了；我们还必须验证我们的模型和估计算法是否如预期般运行。归一化估计误差平方 (Normalized Estimation Error Squared, NEES) 是一种统计检验，用于检查诸如扩展卡尔曼滤波器 (Extended Kalman Filter, EKF) 等状态估计器的一致性，确保其报告的不确定性准确反映了真实的估计误差。这个动手编程练习将指导您计算和解释NEES，以诊断用于步态分析任务的EKF的“健康”状况。",
            "id": "4207830",
            "problem": "您正在使用扩展卡尔曼滤波器（EKF）对下肢步态模型进行系统辨识。该EKF估算矢状面内膝关节和踝关节的关节状态。状态向量包含以弧度为单位的角度和以弧度/秒为单位的角速度。在每个离散时间步，EKF会产生一个估计误差向量及相关的误差协方差矩阵。归一化估计误差平方（NEES）通过将估计误差的经验二次型与概率论所隐含的界限进行比较，来评估滤波器的一致性。您的任务是在几个测试案例中计算随时间变化的NEES，并通过与预期的卡方分布界限进行比较，来确定EKF是否在统计上具有一致性。角度必须以弧度处理，角速度以弧度/秒处理，所有结果均为无量纲。最终输出为无量纲，无需单位转换。\n\n此任务的基本依据必须是：牛顿第二运动定律、基本运动学（其中 $v = dx/dt$），以及EKF作为非线性动力学和测量关系的局部线性化的定义。EKF将估计误差近似为一个零均值高斯随机变量，其协方差矩阵等于滤波器自身的误差协方差。NEES是在假定协方差下估计误差的马氏距离平方，并且在正确的建模假设下，其分布由卡方分布决定，其自由度在每个时间步等于状态维度，在多个独立时间步上等于这些自由度之和。\n\n您必须：\n- 对每个时间步，根据给定的估计误差和协方差计算NEES。\n- 对每个测试案例中的序列，计算：\n  1. 所有时间步的平均NEES。\n  2. 在由适当自由度和显著性水平 $0.05$ 的卡方分布定义的双侧中心区间内，单步NEES值的比例（使用 $0.025$ 的下分位数和 $0.975$ 的上分位数）。\n  3. 一个布尔值，指示序列中NEES值的总和是否在自由度等于状态维度与时间步数之积、且显著性水平相同的双侧卡方界限内。\n\n在解释NEES和卡方界限如何产生时，您的推理不应使用或假设超出基本依据的任何公式；推导应源于EKF和高斯误差建模的第一性原理。但是，您的程序必须实现该推导所隐含的计算。\n\n测试套件：\n对于每个测试案例，都指定了状态维度 $n$、时间步数 $N$、估计误差序列 $\\{e_k\\}_{k=1}^N$（对于 $n=4$，状态排序为 $[\\theta_{\\text{knee}}, \\dot{\\theta}_{\\text{knee}}, \\theta_{\\text{ankle}}, \\dot{\\theta}_{\\text{ankle}}]$；对于 $n=1$，为单个标量状态），以及协方差矩阵序列 $\\{P_k\\}_{k=1}^N$（均为对称正定矩阵）。角度单位为弧度，角速度单位为弧度/秒。NEES是无量纲的。\n\n- 案例A（一致性理想路径）：$n=4$, $N=5$,\n  误差：\n  $e_1 = [0.1414, -0.1414, 0.1732, -0.1732]$,\n  $e_2 = [0.1285, 0.1285, 0.1559, 0.1559]$,\n  $e_3 = [0.1556, -0.1556, 0.1905, -0.1905]$,\n  $e_4 = [0.14, 0.12, 0.18, 0.16]$,\n  $e_5 = [0.13, -0.16, 0.17, -0.18]$.\n  协方差（每步对角化，各步相同）：\n  $P_k = \\mathrm{diag}([0.02, 0.02, 0.03, 0.03])$ for $k=1,\\dots,5$.\n\n- 案例B（不一致，协方差被低估）：$n=4$, $N=3$,\n  误差：\n  $e_1 = [0.15, -0.15, 0.15, -0.15]$,\n  $e_2 = [0.16, 0.14, -0.15, 0.17]$,\n  $e_3 = [0.15, 0.15, 0.15, 0.15]$.\n  协方差（每步对角化，各步相同）：\n  $P_k = \\mathrm{diag}([0.005, 0.005, 0.005, 0.005])$ for $k=1,2,3$.\n\n- 案例C（不一致，协方差被高估）：$n=4$, $N=4$,\n  误差：\n  $e_1 = [0.05, -0.05, 0.05, -0.05]$,\n  $e_2 = [0.04, 0.06, -0.05, 0.05]$,\n  $e_3 = [0.05, 0.05, -0.04, 0.06]$,\n  $e_4 = [0.055, -0.045, 0.05, -0.05]$.\n  协方差（每步对角化，各步相同）：\n  $P_k = \\mathrm{diag}([0.2, 0.2, 0.3, 0.3])$ for $k=1,2,3,4$.\n\n- 案例D（边界检查，单自由度）：$n=1$, $N=1$,\n  误差：\n  $e_1 = [0.1]$.\n  协方差：\n  $P_1 = [0.01]$.\n\n输出规格：\n对于每个测试案例，计算并返回一个包含三个项目的列表：\n- 所有时间步的平均NEES（一个浮点数），\n- 一个布尔值，指示批量总NEES是否在自由度为 $nN$ 的双侧卡方界限内，\n- 单步NEES值在自由度为 $n$ 的单步双侧卡方界限内的比例（一个浮点数）。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的每个元素是对应测试案例（按A、B、C、D的顺序）的三个项目组成的列表。例如，一个有效的输出格式如下：\n[[meanA,batchPassA,fractionA],[meanB,batchPassB,fractionB],[meanC,batchPassC,fractionC],[meanD,batchPassD,fractionD]]",
            "solution": "该问题要求计算和评估应用于下肢步态模型的扩展卡尔曼滤波器（EKF）的归一化估计误差平方（NEES）。评估NEES是评估滤波器统计一致性的标准方法。如果一个滤波器对其自身误差不确定性的估计（由误差协方差矩阵 $P_k$ 表示）与实际观测到的估计误差 $e_k$ 相匹配，则该滤波器被认为是一致的。\n\n此分析的基础在于EKF的理论特性。动态系统，即下肢步态的生物力学模型，受经典力学原理（如牛顿第二定律）的支配，这导致了一组非线性微分方程。在状态空间形式中，系统的演化由 $x_{k+1} = f(x_k, u_k) + w_k$ 描述，其中 $x_k$ 是状态向量（关节角度和角速度），$u_k$ 是控制输入，$w_k$ 是过程噪声。EKF通过在每个时间步进行线性化来近似这个非线性动态，以传播状态估计及其协方差。\n\n分析EKF性能的一个关键假设是，对于一个设计良好的滤波器，在时间步 $k$ 的估计误差，定义为真实状态与估计状态之差，$e_k = x_k - \\hat{x}_k$，是一个零均值、白色的高斯随机向量。其分布由滤波器自身计算的误差协方差矩阵 $P_k$ 来表征：\n$$e_k \\sim \\mathcal{N}(0, P_k)$$\n其中 $\\mathcal{N}(0, P_k)$ 表示均值为零、协方差矩阵为 $P_k$ 的多元正态分布。状态向量 $e_k$ 的维度用 $n$ 表示。\n\n为了检验这个假设，我们构建一个归一化的检验统计量。对于一个随机向量 $e_k \\sim \\mathcal{N}(0, P_k)$，我们可以通过变换 $e_k$ 来定义一个归一化向量 $v_k$，使得 $v_k$ 服从标准正态分布，即 $v_k \\sim \\mathcal{N}(0, I)$，其中 $I$ 是 $n \\times n$ 的单位矩阵。这个变换是通过左乘 $P_k$ 的矩阵平方根的逆来实现的。对于一个对称正定矩阵 $P_k$，我们可以使用其Cholesky分解 $P_k = L_k L_k^T$。那么变换就是 $v_k = L_k^{-1} e_k$。$v_k$ 的协方差为 $E[v_k v_k^T] = E[L_k^{-1} e_k e_k^T (L_k^{-1})^T] = L_k^{-1} E[e_k e_k^T] (L_k^T)^{-1} = L_k^{-1} P_k (L_k^T)^{-1} = L_k^{-1} (L_k L_k^T) (L_k^T)^{-1} = I$。\n\nNEES统计量，记为 $\\epsilon_k$，被定义为误差 $e_k$ 的马氏距离平方，这等同于归一化向量 $v_k$ 的欧几里得范数的平方：\n$$\\epsilon_k = v_k^T v_k = (L_k^{-1} e_k)^T (L_k^{-1} e_k) = e_k^T (L_k^{-1})^T L_k^{-1} e_k = e_k^T (L_k L_k^T)^{-1} e_k = e_k^T P_k^{-1} e_k$$\n由于 $v_k$ 是一个 $n$ 维向量，其分量是独立的标准正态随机变量，它们的平方和 $\\epsilon_k = \\sum_{i=1}^n v_{k,i}^2$ 服从自由度为 $n$ 的卡方分布：\n$$\\epsilon_k \\sim \\chi^2_n$$\n一个 $\\chi^2_n$ 随机变量的期望值是 $n$。因此，对于一个一致的滤波器，许多NEES样本的平均值应接近状态维度 $n$。\n\n我们基于这一统计基础执行三个特定的滤波器一致性测试：\n\n1.  **平均NEES**：我们计算 $N$ 个时间步上NEES值的样本均值，$\\bar{\\epsilon} = \\frac{1}{N} \\sum_{k=1}^N \\epsilon_k$。如果滤波器是一致的，我们期望 $\\bar{\\epsilon} \\approx n$。$\\bar{\\epsilon} \\gg n$ 的值表明滤波器过于自信（低估了其协方差 $P_k$），而 $\\bar{\\epsilon} \\ll n$ 的值则表明它过于保守（高估了 $P_k$）。\n\n2.  **单步一致性**：每个单独的NEES值 $\\epsilon_k$ 都是来自 $\\chi^2_n$ 分布的一个样本。我们可以使用 $\\chi^2_n$ 分布的分位数来为 $\\epsilon_k$ 定义一个 $100(1-\\alpha)\\%$ 的置信区间。给定显著性水平 $\\alpha = 0.05$，双侧中心区间为 $[\\chi^2_n(0.025), \\chi^2_n(0.975)]$。我们计算 $N$ 个NEES计算值中落入此区间的比例。对于大量的独立测试，我们期望这个比例大约为 $1-\\alpha = 0.95$。\n\n3.  **批量一致性**：假设估计误差 $e_k$ 在各个时间步之间是独立的，那么NEES值 $\\epsilon_k$ 也是独立的。$N$ 个独立的 $\\chi^2_n$ 随机变量之和是一个 $\\chi^2_{nN}$ 随机变量。因此，序列上的总NEES，$\\epsilon_{total} = \\sum_{k=1}^N \\epsilon_k$，应服从自由度为 $n \\times N$ 的卡方分布。我们测试计算出的 $\\epsilon_{total}$ 是否落在相应的 $95\\%$ 置信区间 $[\\chi^2_{nN}(0.025), \\chi^2_{nN}(0.975)]$ 内。\n\n每个测试案例的计算如下。所有协方差矩阵 $P_k$ 都是对角矩阵，所以它们的逆 $P_k^{-1}$ 也是一个对角矩阵，其对角元素是 $P_k$ 对角元素的倒数。NEES的计算简化为 $\\epsilon_k = \\sum_{i=1}^n \\frac{e_{k,i}^2}{P_{k,ii}}$。\n\n**案例A**：$n=4, N=5$。\n来自 $\\chi^2_4$ 分布的单步界限：$[\\chi^2_4(0.025), \\chi^2_4(0.975)] \\approx [0.484, 11.143]$。\n来自 $\\chi^2_{20}$ 分布的批量界限：$[\\chi^2_{20}(0.025), \\chi^2_{20}(0.975)] \\approx [9.591, 34.170]$。\n计算出的NEES值为 $\\epsilon_1 \\approx 4.000$, $\\epsilon_2 \\approx 3.272$, $\\epsilon_3 \\approx 4.841$, $\\epsilon_4 \\approx 3.633$, $\\epsilon_5 \\approx 4.168$。\n平均NEES：$\\bar{\\epsilon} \\approx 3.983$。这非常接近期望值 $n=4$。\n单步比例：所有 $5$ 个值都落在 $[0.484, 11.143]$ 区间内。比例 = $5/5 = 1.0$。\n批量测试：总NEES $\\epsilon_{total} \\approx 19.914$。该值落在 $[9.591, 34.170]$ 区间内。批量通过为真。\n结论：滤波器看起来是一致的。\n\n**案例B**：$n=4, N=3$。\n来自 $\\chi^2_4$ 分布的单步界限：$[0.484, 11.143]$。\n来自 $\\chi^2_{12}$ 分布的批量界限：$[\\chi^2_{12}(0.025), \\chi^2_{12}(0.975)] \\approx [4.404, 23.337]$。\n计算出的NEES值为 $\\epsilon_1 = 18.0$, $\\epsilon_2 = 19.32$, $\\epsilon_3 = 18.0$。\n平均NEES：$\\bar{\\epsilon} = 18.44$。这远大于 $n=4$。\n单步比例：没有一个值落在 $[0.484, 11.143]$ 区间内。比例 = $0/3 = 0.0$。\n批量测试：总NEES $\\epsilon_{total} = 55.32$。该值在 $[4.404, 23.337]$ 区间之外。批量通过为假。\n结论：滤波器不一致，可能是由于低估了误差协方差。\n\n**案例C**：$n=4, N=4$。\n来自 $\\chi^2_4$ 分布的单步界限：$[0.484, 11.143]$。\n来自 $\\chi^2_{16}$ 分布的批量界限：$[\\chi^2_{16}(0.025), \\chi^2_{16}(0.975)] \\approx [6.908, 28.845]$。\n计算出的NEES值为 $\\epsilon_1 \\approx 0.042$, $\\epsilon_2 \\approx 0.043$, $\\epsilon_3 \\approx 0.042$, $\\epsilon_4 \\approx 0.042$。\n平均NEES：$\\bar{\\epsilon} \\approx 0.042$。这远小于 $n=4$。\n单步比例：没有一个值落在 $[0.484, 11.143]$ 区间内。比例 = $0/4 = 0.0$。\n批量测试：总NEES $\\epsilon_{total} \\approx 0.169$。该值在 $[6.908, 28.845]$ 区间之外。批量通过为假。\n结论：滤波器不一致，可能是由于高估了误差协方差。\n\n**案例D**：$n=1, N=1$。\n来自 $\\chi^2_1$ 分布的单步和批量界限：$[\\chi^2_1(0.025), \\chi^2_1(0.975)] \\approx [0.001, 5.024]$。\n计算出的NEES值为 $\\epsilon_1 = (0.1)^2 / 0.01 = 1.0$。\n平均NEES：$\\bar{\\epsilon} = 1.0$。这等于期望值 $n=1$。\n单步比例：值 $1.0$ 落在 $[0.001, 5.024]$ 区间内。比例 = $1/1 = 1.0$。\n批量测试：总NEES $\\epsilon_{total} = 1.0$。该值落在 $[0.001, 5.024]$ 区间内。批量通过为真。\n结论：滤波器看起来是一致的。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Computes NEES consistency checks for an EKF on several test cases.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"name\": \"Case A\",\n            \"n\": 4, \n            \"N\": 5,\n            \"errors\": [\n                np.array([0.1414, -0.1414, 0.1732, -0.1732]),\n                np.array([0.1285, 0.1285, 0.1559, 0.1559]),\n                np.array([0.1556, -0.1556, 0.1905, -0.1905]),\n                np.array([0.14, 0.12, 0.18, 0.16]),\n                np.array([0.13, -0.16, 0.17, -0.18])\n            ],\n            \"cov_diag\": np.array([0.02, 0.02, 0.03, 0.03])\n        },\n        {\n            \"name\": \"Case B\",\n            \"n\": 4, \n            \"N\": 3,\n            \"errors\": [\n                np.array([0.15, -0.15, 0.15, -0.15]),\n                np.array([0.16, 0.14, -0.15, 0.17]),\n                np.array([0.15, 0.15, 0.15, 0.15])\n            ],\n            \"cov_diag\": np.array([0.005, 0.005, 0.005, 0.005])\n        },\n        {\n            \"name\": \"Case C\",\n            \"n\": 4, \n            \"N\": 4,\n            \"errors\": [\n                np.array([0.05, -0.05, 0.05, -0.05]),\n                np.array([0.04, 0.06, -0.05, 0.05]),\n                np.array([0.05, 0.05, -0.04, 0.06]),\n                np.array([0.055, -0.045, 0.05, -0.05])\n            ],\n            \"cov_diag\": np.array([0.2, 0.2, 0.3, 0.3])\n        },\n        {\n            \"name\": \"Case D\",\n            \"n\": 1, \n            \"N\": 1,\n            \"errors\": [\n                np.array([0.1])\n            ],\n            \"cov_diag\": np.array([0.01])\n        }\n    ]\n\n    results = []\n    alpha = 0.05\n\n    for case in test_cases:\n        n = case[\"n\"]\n        N = case[\"N\"]\n        errors = case[\"errors\"]\n        cov_inv_diag = 1.0 / case[\"cov_diag\"]\n\n        # 1. Compute per-step NEES\n        nees_values = []\n        for e_k in errors:\n            # For a diagonal covariance matrix, NEES = sum(e_i^2 / P_ii)\n            epsilon_k = np.sum(e_k**2 * cov_inv_diag)\n            nees_values.append(epsilon_k)\n        \n        # 2. Compute Mean NEES\n        mean_nees = np.mean(nees_values)\n\n        # 3. Compute fraction of NEES within per-step bounds\n        dof_per_step = n\n        lower_bound_step = chi2.ppf(alpha / 2, df=dof_per_step)\n        upper_bound_step = chi2.ppf(1 - alpha / 2, df=dof_per_step)\n        \n        in_bounds_count = 0\n        for epsilon_k in nees_values:\n            if lower_bound_step = epsilon_k = upper_bound_step:\n                in_bounds_count += 1\n        \n        fraction_in_bounds = float(in_bounds_count) / N\n\n        # 4. Compute batch consistency\n        total_nees = np.sum(nees_values)\n        dof_batch = n * N\n        lower_bound_batch = chi2.ppf(alpha / 2, df=dof_batch)\n        upper_bound_batch = chi2.ppf(1 - alpha / 2, df=dof_batch)\n\n        batch_pass = lower_bound_batch = total_nees = upper_bound_batch\n\n        results.append([mean_nees, bool(batch_pass), fraction_in_bounds])\n    \n    # Format the output exactly as specified, removing all spaces from the repr\n    output_str = repr(results).replace(\" \", \"\").replace(\"True\", \"true\").replace(\"False\", \"false\")\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}