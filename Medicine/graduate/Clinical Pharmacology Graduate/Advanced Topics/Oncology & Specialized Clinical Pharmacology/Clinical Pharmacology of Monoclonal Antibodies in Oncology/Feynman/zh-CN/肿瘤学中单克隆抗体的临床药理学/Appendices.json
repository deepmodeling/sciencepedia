{
    "hands_on_practices": [
        {
            "introduction": "单克隆抗体的治疗效果始于其与靶点的结合。这个练习将引导你从第一性原理出发，推导并计算受体占有率，这是量化靶点参与程度的关键指标。通过这个实践 ()，你将深入理解药物在靶点部位的浓度 ($C$) 和平衡解离常数 ($K_D$) 如何共同决定了治疗的“开关”是否被有效打开，这对于设定治疗浓度目标至关重要。",
            "id": "4538063",
            "problem": "一种用于实体瘤肿瘤学的人类免疫球蛋白G 1 (IgG1)单克隆抗体，与其位于肿瘤细胞表面的靶受体上的单个非协同性表位相结合。在药代动力学稳态下，测得肿瘤间质液中的游离抗体浓度为 $C = 50\\,\\mathrm{nM}$。在生理条件下测定的抗体-受体相互作用的体外平衡解离常数为 $K_D = 5\\,\\mathrm{nM}$。假设：\n- 相对于分布和周转，结合平衡是快速的，因此结合系统可以被视为处于平衡状态。\n- 每个受体只有一个结合位点，并且没有受体协同性。\n- 与受体结合相关的游离配体浓度等于测得的间质游离抗体浓度 $C$。\n- 总受体浓度足够大，以至于在计算每个受体的分数占有率时，配体耗竭可以忽略不计。\n\n从可逆结合系统的质量作用定律和平衡解离常数的定义出发，推导稳态下受体分数占有率 $\\theta$ 作为 $C$ 和 $K_D$ 的函数表达式，然后根据给定值计算 $\\theta$。将最终的 $\\theta$ 表示为无单位的小数，并四舍五入到四位有效数字。\n\n此外，基于药效学第一性原理，简要阐述在这种情况下，受体占有率如何与观察到的肿瘤学药效学效应产生机制上的联系，并指出用于关联占有率与效应的任何假设和典型模型形式。您的解释不应改变上述要求的数值答案。",
            "solution": "该问题要求推导受体分数占有率，根据给定参数进行计算，并简要解释占有率与药效学效应之间的联系。问题陈述具有科学依据，表述清晰，并提供了所有必要信息。因此，该问题是有效的。\n\n**第1部分：受体分数占有率（$\\theta$）的推导**\n\n我们从配体（单克隆抗体，$L$）和受体（$R$）之间形成复合物（$LR$）的可逆双分子结合反应的质量作用定律开始。问题指明了单个非协同性结合位点。\n\n$$\nL + R \\underset{k_{off}}{\\stackrel{k_{on}}{\\rightleftharpoons}} LR\n$$\n\n此处，$k_{on}$ 是结合速率常数，$k_{off}$ 是解离速率常数。\n\n在平衡状态下，结合速率等于解离速率：\n$$\n\\text{Rate}_{association} = \\text{Rate}_{dissociation}\n$$\n$$\nk_{on} [L] [R] = k_{off} [LR]\n$$\n\n其中 $[L]$, $[R]$ 和 $[LR]$ 分别是游离配体、游离受体和配体-受体复合物的摩尔浓度。\n\n平衡解离常数 $K_D$ 定义为解离速率常数与结合速率常数的比值：\n$$\nK_D = \\frac{k_{off}}{k_{on}}\n$$\n\n通过重新排列平衡速率方程，我们可以用浓度来表示 $K_D$：\n$$\nK_D = \\frac{[L] [R]}{[LR]}\n$$\n\n受体分数占有率 $\\theta$ 定义为被配体结合的受体占总受体群体的比例。\n$$\n\\theta = \\frac{\\text{Concentration of bound receptors}}{\\text{Total concentration of receptors}} = \\frac{[LR]}{[R_{total}]}\n$$\n\n总受体浓度 $[R_{total}]$ 是游离受体和结合受体浓度之和：\n$$\n[R_{total}] = [R] + [LR]\n$$\n\n为了将 $\\theta$ 表示为游离配体浓度和 $K_D$ 的函数，我们首先重新排列 $K_D$ 表达式以求解 $[R]$：\n$$\n[R] = \\frac{K_D [LR]}{[L]}\n$$\n\n现在，我们将这个 $[R]$ 的表达式代入 $[R_{total}]$ 的方程中：\n$$\n[R_{total}] = \\frac{K_D [LR]}{[L]} + [LR] = [LR] \\left( \\frac{K_D}{[L]} + 1 \\right) = [LR] \\left( \\frac{K_D + [L]}{[L]} \\right)\n$$\n\n最后，我们将这个 $[R_{total}]$ 的表达式代入 $\\theta$ 的定义中：\n$$\n\\theta = \\frac{[LR]}{[LR] \\left( \\frac{K_D + [L]}{[L]} \\right)} = \\frac{1}{\\frac{K_D + [L]}{[L]}}\n$$\n\n这可以简化为单个结合位点的 Hill-Langmuir 方程：\n$$\n\\theta = \\frac{[L]}{[L] + K_D}\n$$\n\n问题陈述，相关的游离配体浓度是测得的肿瘤间质液中的游离抗体浓度，记为 $C$。因此，我们将 $[L]$ 替换为 $C$：\n$$\n\\theta = \\frac{C}{C + K_D}\n$$\n这就是所要求的受体分数占有率的表达式。\n\n**第2部分：$\\theta$ 的计算**\n\n问题提供了以下数值：\n游离抗体浓度，$C = 50\\,\\mathrm{nM}$\n平衡解离常数，$K_D = 5\\,\\mathrm{nM}$\n\n将这些值代入推导出的表达式：\n$$\n\\theta = \\frac{50\\,\\mathrm{nM}}{50\\,\\mathrm{nM} + 5\\,\\mathrm{nM}} = \\frac{50}{55} = \\frac{10}{11}\n$$\n\n将其表示为四舍五入到四位有效数字的小数：\n$$\n\\theta \\approx 0.909090...\n$$\n$$\n\\theta \\approx 0.9091\n$$\n\n**第3部分：占有率与药效学效应之间的机制联系**\n\n基于药效学第一性原理，受体占有率（$\\theta$）是引发药理反应的主要事件。效应（$E$）的强度是被占有受体数量的函数。这种机制上的联系取决于抗体的作用模式。\n\n1.  **阻断/拮抗作用：** 如果抗体是拮抗剂，它会与受体结合，阻止内源性配体（例如，生长因子）结合并启动信号。诸如抑制肿瘤细胞增殖之类的效应是通过阻断此信号通路实现的。抑制的强度与被阻断的受体分数（$\\theta$）相关。\n\n2.  **激动作用：** 如果抗体是激动剂，其与受体的结合会模拟内源性配体，并直接激活下游信号级联。效应由抗体-受体复合物的形成直接驱动。\n\n3.  **效应子功能：** 对于许多肿瘤学单克隆抗体（如 IgG1），一个关键机制是诱导针对肿瘤细胞的免疫应答。通过与表面受体结合，抗体的Fc区会标记肿瘤细胞，使其被免疫细胞通过抗体依赖性细胞介导的细胞毒性作用（ADCC）等过程摧毁。这种标记的程度与细胞表面结合的抗体密度直接相关，而这又是受体占有率 $\\theta$ 的函数。\n\n关联占有率与效应的最简单模型是**直接Emax模型**。该模型假设效应 $E$ 与分数占有率 $\\theta$ 成正比：\n$$\nE = E_{max} \\cdot \\theta\n$$\n其中 $E_{max}$ 是可能的最大效应。代入我们推导的 $\\theta$ 表达式：\n$$\nE = E_{max} \\frac{C}{C + K_D}\n$$\n在这个简单系统中，产生一半最大效应的浓度（$EC_{50}$）等于平衡解离常数（$K_D$）。观察到的高分数占有率（$\\theta \\approx 0.91$）表明，作用部位的药物浓度远高于 $K_D$，因此预期药理效应接近其可能的最大值（$E \\approx 0.91 \\cdot E_{max}$）。这表明，维持相对于结合亲和力（$K_D$）足够高的游离药物浓度对于实现稳健的治疗效果至关重要。",
            "answer": "$$\\boxed{0.9091}$$"
        },
        {
            "introduction": "在理解了药物-靶点结合的基础后，我们来探讨一个更为复杂的现象：靶点本身可以成为药物的清除途径。这种被称为靶点介导的药物处置 (TMDD) 的机制，导致了非线性的药代动力学特性，并且这种特性会随着疾病状态（如肿瘤负荷）的改变而动态变化。这项练习 () 将通过一个临床情景，挑战你解读动态的血药浓度数据，从而加深对TMDD如何影响药物暴露量和治疗策略的理解。",
            "id": "4538064",
            "problem": "一种针对高丰度肿瘤细胞表面抗原的单克隆抗体，以固定给药间隔 $\\tau$（例如，每 $21$ 天）对初始肿瘤负荷较大的患者进行静脉推注给药，剂量为 $D$。其药代动力学受平行消除途径的控制：一个线性的分解代谢清除率 $CL_L$（通过网状内皮系统蛋白水解和新生儿Fc受体（FcRn）的再循环）和一个可饱和的、由抗原结合、内化和降解引起的靶介导的药物处置（TMDD）组分。该系统可以用一个单室质量平衡模型表示，其分布容积为 $V_d$，浓度为 $C(t)$：\n$$\n\\frac{dC(t)}{dt} \\;=\\; -\\frac{CL_L}{V_d}\\,C(t) \\;-\\; \\frac{V_{\\max}(t)}{V_d}\\,\\frac{C(t)}{K_m + C(t)}\\,,\n$$\n其中 $V_{\\max}(t)$ 是TMDD过程随时间变化的最大能力，$K_m$ 是Michaelis–Menten常数。影像学检查显示，肿瘤负荷 $B(t)$ 在治疗后下降，且抗原池与 $B(t)$ 成正比，因此 $V_{\\max}(t) \\propto B(t)$。\n\n在每次给药前即刻测量的系列谷浓度 $C_{trough}$ 显示，在多个周期内随着肿瘤负荷的减少而单调上升。例如，$C_{trough}$ 从周期 $1$ 结束时的 $8$ $\\mathrm{mg/L}$ 增加到周期 $2$ 结束时的 $14$ $\\mathrm{mg/L}$，再到周期 $3$ 结束时的 $18$ $\\mathrm{mg/L}$，而影像学显示同期肿瘤负荷相应减少。假设 $D$、$\\tau$、$CL_L$、$V_d$ 或 $K_m$ 没有变化，并且没有产生抗药物抗体（ADA）。\n\n以下哪个陈述最能解释观察到的模式，并预测随着治疗的继续，$C_{trough}$ 的未来轨迹？\n\nA. 肿瘤负荷的下降减弱了靶介导的药物处置（TMDD），降低了 $V_{\\max}(t)$，从而减小了非线性清除项；总清除率 $CL_{tot}(t) = CL_L + CL_{TMDD}(t)$ 下降，因此 $C_{trough}$ 将继续增加，但会渐近地接近一个由线性途径决定的平台期，终末半衰期趋向于 $t_{1/2} = \\frac{\\ln 2 \\cdot V_d}{CL_L}$；每个周期的增量将随时间减小。\n\nB. $C_{trough}$ 的上升反映了由于抗药物抗体（ADA）引起的线性清除的诱导，这增加了 $CL_L$，因此随着 $CL_{tot}(t)$ 的增加，$C_{trough}$ 在随后的周期中将开始下降。\n\nC. 无论肿瘤是否缩小，TMDD都保持主导地位；在固定的 $D$ 和 $\\tau$ 下，$C_{trough}$ 将在各个周期内持续线性无限制地增长，因为在较高的 $C(t)$ 下非线性项变得饱和，蓄积是无限的。\n\nD. $C_{trough}$ 的增加表明新生儿Fc受体（FcRn）再循环途径的饱和，这减少了免疫球蛋白G（IgG）的回收并缩短了半衰期；因此，由于 $CL_L$ 在较高浓度下有效增加，$C_{trough}$ 随后会下降。",
            "solution": "在进行求解之前，对问题陈述进行严格评估。\n\n### 步骤1：提取已知条件\n-   **药物和给药方案：** 一种单克隆抗体以静脉推注剂量 $D$、固定给药间隔 $\\tau$ 的方式给药。\n-   **患者与疾病：** 患者具有高丰度的肿瘤细胞表面抗原和初始较大的肿瘤负荷 $B(t)$。\n-   **药代动力学模型：** 一个单室模型，分布容积为 $V_d$，浓度为 $C(t)$。\n-   **控制微分方程：**\n    $$\n    \\frac{dC(t)}{dt} \\;=\\; -\\frac{CL_L}{V_d}\\,C(t) \\;-\\; \\frac{V_{\\max}(t)}{V_d}\\,\\frac{C(t)}{K_m + C(t)}\n    $$\n-   **模型参数：**\n    -   $CL_L$：恒定的线性分解代谢清除率。\n    -   $V_{\\max}(t)$：靶介导的药物处置（TMDD）过程随时间变化的最大能力。\n    -   $K_m$：Michaelis–Menten常数。\n-   **关键关系：** 抗原池与肿瘤负荷成正比，因此 $V_{\\max}(t) \\propto B(t)$。\n-   **观察结果：**\n    1.  肿瘤负荷 $B(t)$ 在治疗后下降。\n    2.  在每次给药前即刻测量的系列谷浓度 $C_{trough}$，在多个周期内呈单调上升。\n    3.  示例数据：$C_{trough}$ 从 $8~\\mathrm{mg/L}$（周期1结束时）增加到 $14~\\mathrm{mg/L}$（周期2结束时），再到 $18~\\mathrm{mg/L}$（周期3结束时）。\n-   **假设：**\n    1.  $D$、$\\tau$、$CL_L$、$V_d$ 和 $K_m$ 是恒定的。\n    2.  未产生抗药物抗体（ADA）。\n\n### 步骤2：使用提取的已知条件进行验证\n-   **科学依据：** 该问题牢固地基于临床药理学和药代动力学的原理。描述平行线性与非线性（TMDD）消除途径的模型是单克隆抗体的标准且被广泛接受的框架，尤其是在肿瘤学中，靶标（抗原）质量随治疗反应而变化。$V_{\\max}(t) \\propto B(t)$ 的关系在此类模型中是常见且合乎逻辑的假设。该问题在科学上是合理的。\n-   **适定性：** 问题呈现了一个清晰的场景，包含一个控制数学模型、明确的假设和一系列观察结果。问题要求解释观察结果并根据所提供的模型预测未来行为。这种结构允许进行唯一的逻辑推导。该问题是适定的。\n-   **客观性：** 问题使用客观、技术性的语言描述。在模型背景下，所有陈述都是事实。没有主观或模糊的措辞。\n\n### 步骤3：结论与行动\n问题陈述有效。它在科学上合理、适定、客观，并包含足够的信息以进行定性分析。可以开始求解过程。\n\n### 求解推导\n所提供的微分方程描述了药物浓度 $C(t)$ 在中央室中的变化率。\n$$\n\\frac{dC(t)}{dt} = \\underbrace{-\\frac{CL_L}{V_d}\\,C(t)}_{\\text{线性消除}} \\underbrace{-\\; \\frac{V_{\\max}(t)}{V_d}\\,\\frac{C(t)}{K_m + C(t)}}_{\\text{非线性 (TMDD) 消除}}\n$$\n总药物消除速率是一个线性（一级）过程与一个非线性（Michaelis-Menten）过程之和。我们可以定义一个有效的总清除率 $CL_{tot}$，它不是恒定的。消除速率为 $-CL_{tot} \\frac{C(t)}{V_d}$。通过比较各项，我们可以将总清除率表示为：\n$$\nCL_{tot}(t, C) = CL_L + CL_{TMDD}(t, C)\n$$\n其中，由TMDD引起的清除率为：\n$$\nCL_{TMDD}(t, C) = \\frac{V_{\\max}(t)}{K_m + C(t)}\n$$\n问题陈述指出，随着治疗生效，肿瘤负荷 $B(t)$ 随时间下降。问题还给出TMDD途径的最大能力与肿瘤负荷成正比：$V_{\\max}(t) \\propto B(t)$。\n\n因此，随着治疗的进行和 $B(t)$ 的减小，$V_{\\max}(t)$ 也必定减小。这直接减少了TMDD途径对总药物清除的贡献。因此，TMDD清除率 $CL_{TMDD}(t, C)$ 在连续的治疗周期中会降低。\n\n这意味着总清除率 $CL_{tot}(t, C)$ 也随时间降低。对于以恒定剂量 $D$ 和间隔 $\\tau$ 给药的药物，总清除率的降低将导致更高的药物暴露量和每个给药间隔结束时更高的浓度（谷浓度，$C_{trough}$）。这一机制完美地解释了观察到的 $C_{trough}$ 从 $8~\\mathrm{mg/L}$ 单调上升至 $14~\\mathrm{mg/L}$ 再到 $18~\\mathrm{mg/L}$ 的现象。\n\n为了预测未来轨迹，我们考虑其长期行为。如果治疗成功，肿瘤负荷 $B(t)$ 可能趋近于零。当 $B(t) \\to 0$ 时，必然有 $V_{\\max}(t) \\to 0$。在此极限情况下，控制方程中的TMDD消除项变得可以忽略不计：\n$$\n\\frac{V_{\\max}(t)}{V_d}\\,\\frac{C(t)}{K_m + C(t)} \\to 0\n$$\n药代动力学模型简化为一个纯线性系统：\n$$\n\\frac{dC(t)}{dt} \\approx -\\frac{CL_L}{V_d}\\,C(t)\n$$\n在这些条件下，随着重复给药，谷浓度将不再无限上升。相反，它们将渐近地接近一个仅由线性清除率 $CL_L$ 决定的新的、更高的稳态谷浓度。当 $C_{trough}$ 接近这个平台期时，其上升速度会减慢。所提供的数据支持了这一点，因为从周期1到周期2的增量是 $6~\\mathrm{mg/L}$，而从周期2到周期3的增量较小，为 $4~\\mathrm{mg/L}$，这表明增长率正在减小。\n\n在这个终末线性阶段，药代动力学由一级消除速率常数 $k_{el} = CL_L / V_d$ 控制。相应的终末半衰期由标准公式给出：\n$$\nt_{1/2} = \\frac{\\ln 2}{k_{el}} = \\frac{\\ln 2 \\cdot V_d}{CL_L}\n$$\n\n### 逐项分析\n\n**A. 肿瘤负荷的下降减弱了靶介导的药物处置（TMDD），降低了 $V_{\\max}(t)$，从而减小了非线性清除项；总清除率 $CL_{tot}(t) = CL_L + CL_{TMDD}(t)$ 下降，因此 $C_{trough}$ 将继续增加，但会渐近地接近一个由线性途径决定的平台期，终末半衰期趋向于 $t_{1/2} = \\frac{\\ln 2 \\cdot V_d}{CL_L}$；每个周期的增量将随时间减小。**\n- **分析：** 该陈述准确地描述了上面推导的整个过程。肿瘤负荷的减少导致 $V_{\\max}(t)$ 的减少，从而导致总清除率下降，解释了 $C_{trough}$ 的上升。它正确地预测，随着TMDD途径的减弱，系统行为将由线性途径主导，导致 $C_{trough}$ 渐近地接近一个平台期。关于终末半衰期的陈述对于线性系统是正确的。每个周期的增量会减小的观察结果与渐近接近平台期以及所提供的数据是一致的。\n- **结论：** 正确。\n\n**B. $C_{trough}$ 的上升反映了由于抗药物抗体（ADA）引起的线性清除的诱导，这增加了 $CL_L$，因此随着 $CL_{tot}(t)$ 的增加，$C_{trough}$ 在随后的周期中将开始下降。**\n- **分析：** 该选项直接与问题中给出的明确假设“未产生抗药物抗体（ADA）”相矛盾。此外，清除率的增加会导致浓度下降，这与观察到的趋势相反。\n- **结论：** 错误。\n\n**C. 无论肿瘤是否缩小，TMDD都保持主导地位；在固定的 $D$ 和 $\\tau$ 下，$C_{trough}$ 将在各个周期内持续线性无限制地增长，因为在较高的 $C(t)$ 下非线性项变得饱和，蓄积是无限的。**\n- **分析：** 这包含多个错误。首先，TMDD并非保持主导地位；其能力 $V_{\\max}(t)$ 随着肿瘤的缩小而减小。其次，只要存在非零的清除途径（$CL_L$ 被声明为恒定的非零清除率），药物蓄积就绝不是无限或无界的。浓度将接近一个有限的稳态平台期。第三，线性无限制的增长在物理上或数学上与该模型不一致。\n- **结论：** 错误。\n\n**D. $C_{trough}$ 的增加表明新生儿Fc受体（FcRn）再循环途径的饱和，这减少了免疫球蛋白G（IgG）的回收并缩短了半衰期；因此，由于 $CL_L$ 在较高浓度下有效增加，$C_{trough}$ 随后会下降。**\n- **分析：** 该选项提出了一个导致与观察结果相反的机制。FcRn的饱和会增加分解代谢，从而有效地增加 $CL_L$ 并因此降低药物浓度。问题陈述指出 $C_{trough}$ 正在增加。此外，问题明确指出我们应假设 $CL_L$ 是恒定的，从而指示我们在本分析中忽略此类浓度依赖性对线性清除率的影响。\n- **结论：** 错误。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "最终，我们将所有药理学概念融会贯通，应用于一个强大的临床工具中：个体化给药。我们如何利用PK/PD模型以及患者自身的血药浓度数据来精确调整剂量？这项实践 () 将引导你实现一个基于贝叶斯预测的算法，这是一种用于模型引导的精准给药的前沿方法。通过编写代码，你将亲身体验如何根据患者的个体参数来优化单抗药物的剂量，以达到预设的治疗目标。",
            "id": "4538006",
            "problem": "要求您实施贝叶斯预测，以根据群体药代动力学参数和患者最近的浓度测量数据，对一种用于肿瘤学的单克隆抗体进行个体化给药。该单克隆抗体以间歇性静脉输注的方式给药，输注持续固定的小时数，每隔一个给药间隔（以小时为单位）重复一次。药代动力学模型为一级消除和线性处置的单室系统。目标是推导并实现一种方法，从群体药代动力学先验和在稳态条件下于一个给药间隔内观测到的浓度出发，估计患者个体的清除率和分布容积，然后计算达到下一个给药间隔末端指定稳态谷浓度所需的下一次剂量。程序中的所有量必须严格遵守指定的单位：清除率（L/h）、容积（L）、剂量（mg）、时间（h）、浓度（mg/L）。您的程序必须为每个测试案例生成推荐的下一次剂量（mg），四舍五入到最接近的整数，并将其作为包含在方括号中的逗号分隔列表打印出来（例如，\"[123,456,789]\"）。\n\n基本原理：\n- 具有零级输入的单室、一级消除模型描述了药物量 $A(t)$ 的变化，其方程为 $$\\frac{dA(t)}{dt} = R_0(t) - CL \\cdot \\frac{A(t)}{V},$$ 其中 $R_0(t)$ 是零级输注速率（输注期间 $R_0 = D/T_{\\text{inf}}$，其他时间 $R_0 = 0$），$CL$ 是清除率（L/h），$V$ 是分布容积（L）。浓度为 $C(t) = A(t)/V$，$k = CL/V$ 是消除速率常数（h$^{-1}$）。\n- 对于从时间 $t=0$ 开始的单次持续时间为 $T_{\\text{inf}}$ 的输注，输注期间（$0 \\le t \\le T_{\\text{inf}}$）的浓度为 $$C_{\\text{single}}(t) = \\frac{R_0}{CL}\\left(1 - e^{-k t}\\right),$$ 输注后（$t > T_{\\text{inf}}$）的浓度为 $$C_{\\text{single}}(t) = \\frac{R_0}{CL}\\left(1 - e^{-k T_{\\text{inf}}}\\right) e^{-k (t - T_{\\text{inf}})}.$$\n- 在稳态下，每 $\\tau$ 小时重复间歇输注，当前输注开始后时间 $t$ 的浓度是所有先前剂量衰减贡献的无穷级数和。稳态浓度的闭合形式解为：\n  - 输注期间（$0 \\le t \\le T_{\\text{inf}}$）：\n    $$C_{\\text{ss}}(t) = \\frac{R_0}{CL}\\left(1 - e^{-k t}\\right) + \\frac{R_0}{CL} \\left(1 - e^{-k T_{\\text{inf}}}\\right) \\frac{e^{-k (t + \\tau - T_{\\text{inf}})}}{1 - e^{-k \\tau}}.$$\n  - 输注后（$t > T_{\\text{inf}}$）：\n    $$C_{\\text{ss}}(t) = \\frac{R_0}{CL}\\left(1 - e^{-k T_{\\text{inf}}}\\right) \\frac{e^{-k (t - T_{\\text{inf}})}}{1 - e^{-k \\tau}}.$$\n- 稳态谷浓度（下一次输注前瞬间）在 $t = \\tau$ 时，等于 $$C_{\\text{trough,ss}} = \\frac{R_0}{CL}\\left(1 - e^{-k T_{\\text{inf}}}\\right) \\frac{e^{-k (\\tau - T_{\\text{inf}})}}{1 - e^{-k \\tau}}.$$\n\n贝叶斯框架：\n- 清除率和分布容积的群体药代动力学先验为对数正态分布：$$\\ln(CL) \\sim \\mathcal{N}\\left(\\ln(CL_{\\text{pop}}), \\omega_{CL}^2\\right), \\quad \\ln(V) \\sim \\mathcal{N}\\left(\\ln(V_{\\text{pop}}), \\omega_V^2\\right),$$ 各分量独立。\n- 测量浓度的残差误差模型为对数正态分布：对于在时间 $t_i$ 观测到的 $C_i$，$$\\ln(C_i) \\sim \\mathcal{N}\\left(\\ln(C_{\\text{ss}}(t_i \\mid CL, V)), \\sigma^2\\right).$$\n- 后验众数（最大后验估计）$(\\hat{CL}, \\hat{V})$ 通过最小化负对数后验函数得到 $$\\mathcal{L}(\\ln CL, \\ln V) = \\sum_i \\frac{\\left[\\ln\\left(C_{\\text{ss}}(t_i \\mid CL, V)\\right) - \\ln(C_i)\\right]^2}{2\\sigma^2} + \\frac{\\left[\\ln(CL) - \\ln(CL_{\\text{pop}})\\right]^2}{2\\omega_{CL}^2} + \\frac{\\left[\\ln(V) - \\ln(V_{\\text{pop}})\\right]^2}{2\\omega_V^2}.$$\n- 一旦找到 $(\\hat{CL}, \\hat{V})$，为达到下一个给药间隔末端（时间 $\\tau$）的目标稳态谷浓度 $C_{\\text{target}}$，并保持相同的输注持续时间 $T_{\\text{inf}}$，所需的下一次剂量 $D_{\\text{next}}$ 通过求解 $C_{\\text{trough,ss}} = C_{\\text{target}}$ 关于 $D$ 的方程得到，结果为\n  $$D_{\\text{next}} = C_{\\text{target}} \\cdot \\hat{CL} \\cdot T_{\\text{inf}} \\cdot \\frac{1 - e^{-\\hat{k}\\tau}}{1 - e^{-\\hat{k} T_{\\text{inf}}}} \\cdot e^{\\hat{k}(\\tau - T_{\\text{inf}})}, \\quad \\text{其中 } \\hat{k} = \\frac{\\hat{CL}}{\\hat{V}}.$$\n\n您的程序必须：\n- 对于每个测试案例，使用提供的群体参数 $(CL_{\\text{pop}}, V_{\\text{pop}}, \\omega_{CL}, \\omega_V)$、给药方案 $(D_{\\text{prev}}, T_{\\text{inf}}, \\tau)$、观测时间 $\\{t_i\\}$、观测浓度 $\\{C_i\\}$ 和残差误差标准差 $\\sigma$，通过在对数空间中进行最大后验估计来计算 $(\\hat{CL}, \\hat{V})$，使用上述稳态浓度表达式计算 $C_{\\text{ss}}(t_i \\mid CL, V)$。\n- 然后使用上述公式计算 $D_{\\text{next}}$（mg），并将其四舍五入到最接近的整数mg。\n- 将所有测试案例的推荐下一次剂量汇总为一行输出，格式为逗号分隔的列表，并用方括号括起来，不含任何其他文本。\n\n所有物理量均按指示表示：$CL$ 单位为 L/h，$V$ 单位为 L，$D$ 单位为 mg，$T_{\\text{inf}}$、$\\tau$ 和 $t_i$ 单位为 h，浓度单位为 mg/L。不使用角度和百分比，所有输出均为整数（mg）。\n\n测试套件：\n- 案例1（典型清除率和两个输注后样本）：\n  - $CL_{\\text{pop}} = 0.010$ L/h, $V_{\\text{pop}} = 3.2$ L, $\\omega_{CL} = 0.30$, $\\omega_V = 0.25$, $\\sigma = 0.20$。\n  - $D_{\\text{prev}} = 200.0$ mg, $T_{\\text{inf}} = 1.0$ h, $\\tau = 336.0$ h。\n  - 观测时间：$t_1 = 24.0$ h, $t_2 = 336.0$ h。观测浓度：$C_1 = 88.0$ mg/L, $C_2 = 28.0$ mg/L。\n  - 目标谷浓度：$C_{\\text{target}} = 30.0$ mg/L。\n- 案例2（较低浓度表明清除率较高）：\n  - $CL_{\\text{pop}} = 0.015$ L/h, $V_{\\text{pop}} = 3.0$ L, $\\omega_{CL} = 0.35$, $\\omega_V = 0.25$, $\\sigma = 0.20$。\n  - $D_{\\text{prev}} = 200.0$ mg, $T_{\\text{inf}} = 1.0$ h, $\\tau = 336.0$ h。\n  - 观测时间：$t_1 = 24.0$ h, $t_2 = 336.0$ h。观测浓度：$C_1 = 60.0$ mg/L, $C_2 = 18.0$ mg/L。\n  - 目标谷浓度：$C_{\\text{target}} = 30.0$ mg/L。\n- 案例3（稀疏数据：单个间隔中点样本）：\n  - $CL_{\\text{pop}} = 0.012$ L/h, $V_{\\text{pop}} = 3.5$ L, $\\omega_{CL} = 0.30$, $\\omega_V = 0.30$, $\\sigma = 0.25$。\n  - $D_{\\text{prev}} = 200.0$ mg, $T_{\\text{inf}} = 1.0$ h, $\\tau = 336.0$ h。\n  - 观测时间：$t_1 = 168.0$ h。观测浓度：$C_1 = 50.0$ mg/L。\n  - 目标谷浓度：$C_{\\text{target}} = 30.0$ mg/L。\n- 案例4（更长的输注时间并包含一个输注期间样本）：\n  - $CL_{\\text{pop}} = 0.010$ L/h, $V_{\\text{pop}} = 2.5$ L, $\\omega_{CL} = 0.30$, $\\omega_V = 0.25$, $\\sigma = 0.20$。\n  - $D_{\\text{prev}} = 200.0$ mg, $T_{\\text{inf}} = 2.0$ h, $\\tau = 504.0$ h。\n  - 观测时间：$t_1 = 1.0$ h（输注期间），$t_2 = 24.0$ h。观测浓度：$C_1 = 52.0$ mg/L, $C_2 = 84.0$ mg/L。\n  - 目标谷浓度：$C_{\\text{target}} = 30.0$ mg/L。\n\n您的程序应生成一行输出，其中包含案例1-4的推荐下一次剂量，格式为逗号分隔的列表并用方括号括起来（例如，\"[d1,d2,d3,d4]\"），每个 $d_i$ 均以整数mg表示。",
            "solution": "所提出的问题是有效的，因为它科学地基于药代动力学的既定原理，问题阐述清晰，并为数学求解提供了完整且一致的信息集。该问题要求实施一种贝叶斯预测算法，以实现单克隆抗体的个体化给药。实现此目标的步骤如下：首先，通过在给定群体数据（先验）和患者特定浓度测量（似然）的情况下，找到最大后验 (MAP) 估计，来估计患者的个体药代动力学参数，即清除率 ($CL$) 和分布容积 ($V$)。其次，使用这些估计出的参数（$\\hat{CL}$ 和 $\\hat{V}$）来计算达到期望的目标谷浓度 ($C_{\\text{target}}$) 所需的下一次剂量 ($D_{\\text{next}}$)。\n\n分析的基础是具有零级输注和一级消除的单室药代动力学模型。药物浓度 $C(t)$ 在时间 $t$ 的变化由微分方程 $\\frac{dC(t)}{dt} = \\frac{R_0(t)}{V} - k \\cdot C(t)$ 控制，其中 $R_0(t)$ 是输注速率（$R_0(t) = D/T_{\\text{inf}}$ for $0 \\le t \\pmod \\tau \\le T_{\\text{inf}}$，其他时间为 $0$），$D$ 是剂量（mg），$T_{\\text{inf}}$ 是输注持续时间（h），$V$ 是分布容积（L），$k$ 是消除速率常数（h$^{-1}$），$\\tau$ 是给药间隔（h）。清除率与 $k$ 和 $V$ 的关系为 $CL = k \\cdot V$。\n\n所提出的问题指定了稳态条件下药物浓度的闭合形式解 $C_{\\text{ss}}(t)$，其中 $t$ 是自最近一次输注开始以来经过的时间。这些方程对于计算给定患者的预测浓度至关重要。\n输注期间（$0 \\le t \\le T_{\\text{inf}}$）：\n$$C_{\\text{ss}}(t \\mid CL, V) = \\frac{R_0}{CL}\\left(1 - e^{-k t}\\right) + \\frac{R_0}{CL} \\left(1 - e^{-k T_{\\text{inf}}}\\right) \\frac{e^{-k (t + \\tau - T_{\\text{inf}})}}{1 - e^{-k \\tau}}$$\n输注后期间（$t > T_{\\text{inf}}$）：\n$$C_{\\text{ss}}(t \\mid CL, V) = \\frac{R_0}{CL}\\left(1 - e^{-k T_{\\text{inf}}}\\right) \\frac{e^{-k (t - T_{\\text{inf}})}}{1 - e^{-k \\tau}}$$\n这里，$R_0 = D_{\\text{prev}} / T_{\\text{inf}}$，其中 $D_{\\text{prev}}$ 是先前施用的剂量。\n\n任务的核心是为患者找到 MAP 估计值 $(\\hat{CL}, \\hat{V})$。贝叶斯框架将关于群体参数的先验知识与患者特定数据相结合。清除率和容积的先验分布被给定为独立的对数正态分布：$\\ln(CL) \\sim \\mathcal{N}(\\ln(CL_{\\text{pop}}), \\omega_{CL}^2)$ 和 $\\ln(V) \\sim \\mathcal{N}(\\ln(V_{\\text{pop}}), \\omega_V^2)$。在时间 $\\{t_i\\}$ 观测到浓度 $\\{C_i\\}$ 的似然基于对数正态残差误差模型：$\\ln(C_i) \\sim \\mathcal{N}(\\ln(C_{\\text{ss}}(t_i \\mid CL, V)), \\sigma^2)$。\n\n为了找到 MAP 估计，我们最大化后验概率，这等同于最小化其对数的负值。这产生了待最小化的目标函数 $\\mathcal{L}(\\ln CL, \\ln V)$：\n$$ \\mathcal{L} = \\sum_{i} \\frac{\\left[\\ln\\left(C_{\\text{ss}}(t_i \\mid CL, V)\\right) - \\ln(C_i)\\right]^2}{\\sigma^2} + \\frac{\\left[\\ln(CL) - \\ln(CL_{\\text{pop}})\\right]^2}{\\omega_{CL}^2} + \\frac{\\left[\\ln(V) - \\ln(V_{\\text{pop}})\\right]^2}{\\omega_V^2} $$\n我们相对于对数参数 $x_1 = \\ln(CL)$ 和 $x_2 = \\ln(V)$ 最小化此函数。这是一个非线性优化问题，可以进行数值求解，我们为此使用 `scipy.optimize.minimize` 函数。优化程序的初始猜测值设置为群体平均值，即 $[\\ln(CL_{\\text{pop}}), \\ln(V_{\\text{pop}})]$。\n\n一旦通过对优化结果进行指数运算确定了患者特定的 MAP 估计值 $(\\hat{CL}, \\hat{V})$，即 $\\hat{CL} = e^{\\hat{x}_1}$ 和 $\\hat{V} = e^{\\hat{x}_2}$，我们就可以计算下一次所需的剂量。目标是在稳态下达到一个特定的目标谷浓度 $C_{\\text{target}}$。稳态谷浓度的公式是：\n$$ C_{\\text{trough,ss}} = \\frac{D/(CL \\cdot T_{\\text{inf}})}{1 - e^{-k \\tau}} \\left(1 - e^{-k T_{\\text{inf}}}\\right) e^{-k (\\tau - T_{\\text{inf}})} $$\n通过设置 $C_{\\text{trough,ss}} = C_{\\text{target}}$ 并求解剂量 $D$，我们得到下一次剂量 $D_{\\text{next}}$ 的公式：\n$$ D_{\\text{next}} = C_{\\text{target}} \\cdot \\hat{CL} \\cdot T_{\\text{inf}} \\cdot \\frac{1 - e^{-\\hat{k}\\tau}}{1 - e^{-\\hat{k} T_{\\text{inf}}}} \\cdot e^{\\hat{k}(\\tau - T_{\\text{inf}})} $$\n其中 $\\hat{k} = \\hat{CL} / \\hat{V}$。然后为每个测试案例计算该值，并四舍五入到最接近的整数，以提供最终推荐的剂量（mg）。\n\n实现过程通过定义稳态浓度模型和目标函数的函数来进行。一个循环遍历每个测试案例，执行数值最小化以找到 $(\\hat{CL}, \\hat{V})$，然后计算 $D_{\\text{next}}$。最终结果被收集并按指定格式化。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Main function to solve the Bayesian forecasting problem for all test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"CL_pop\": 0.010, \"V_pop\": 3.2, \"w_CL\": 0.30, \"w_V\": 0.25, \"sigma\": 0.20,\n            \"D_prev\": 200.0, \"T_inf\": 1.0, \"tau\": 336.0,\n            \"t_obs\": np.array([24.0, 336.0]), \"C_obs\": np.array([88.0, 28.0]),\n            \"C_target\": 30.0\n        },\n        {\n            \"CL_pop\": 0.015, \"V_pop\": 3.0, \"w_CL\": 0.35, \"w_V\": 0.25, \"sigma\": 0.20,\n            \"D_prev\": 200.0, \"T_inf\": 1.0, \"tau\": 336.0,\n            \"t_obs\": np.array([24.0, 336.0]), \"C_obs\": np.array([60.0, 18.0]),\n            \"C_target\": 30.0\n        },\n        {\n            \"CL_pop\": 0.012, \"V_pop\": 3.5, \"w_CL\": 0.30, \"w_V\": 0.30, \"sigma\": 0.25,\n            \"D_prev\": 200.0, \"T_inf\": 1.0, \"tau\": 336.0,\n            \"t_obs\": np.array([168.0]), \"C_obs\": np.array([50.0]),\n            \"C_target\": 30.0\n        },\n        {\n            \"CL_pop\": 0.010, \"V_pop\": 2.5, \"w_CL\": 0.30, \"w_V\": 0.25, \"sigma\": 0.20,\n            \"D_prev\": 200.0, \"T_inf\": 2.0, \"tau\": 504.0,\n            \"t_obs\": np.array([1.0, 24.0]), \"C_obs\": np.array([52.0, 84.0]),\n            \"C_target\": 30.0\n        }\n    ]\n\n    def calculate_ss_concentration(log_CL, log_V, D, T_inf, tau, t_obs):\n        \"\"\"\n        Calculates steady-state concentrations for given PK parameters and dosing.\n        \"\"\"\n        CL = np.exp(log_CL)\n        V = np.exp(log_V)\n        \n        if CL == 0 or V == 0:\n            return np.inf\n\n        k = CL / V\n        R0 = D / T_inf\n\n        k_tau = k * tau\n        k_T_inf = k * T_inf\n\n        # Use -expm1(-x) for 1-exp(-x) to maintain precision for small x\n        one_minus_exp_k_tau = -np.expm1(-k_tau)\n        one_minus_exp_k_T_inf = -np.expm1(-k_T_inf)\n\n        if one_minus_exp_k_tau  1e-9: # Avoid division by zero if tau is very large\n            return np.inf\n\n        common_factor = (R0 / CL) * one_minus_exp_k_T_inf / one_minus_exp_k_tau\n\n        C_pred = np.zeros_like(t_obs)\n\n        for i, t in enumerate(t_obs):\n            if t = T_inf:\n                # During infusion\n                one_minus_exp_kt = -np.expm1(-k * t)\n                C_infusion_part = (R0 / CL) * one_minus_exp_kt\n                \n                # Accumulation part\n                # This is C_trough_ss * exp(-k*t), which is incorrect.\n                # The correct formula for the accumulation term during infusion is complex.\n                # Let's use the provided full formula from the problem description\n                C_accum_part = common_factor * np.exp(-k * (tau - T_inf + t))\n                # The formula in problem is: `(R0/CL) * (1-exp(-k*T_inf)) * exp(-k*(t+tau-T_inf)) / (1-exp(-k*tau))`\n                # which simplifies to `common_factor * exp(-k*(t+tau-T_inf))`\n                # No, it's `exp(-k * (t + tau - T_inf))`. This is wrong in my python implementation comment.\n                # The formula is `... * exp(-k * (t + tau - T_inf))`\n                # common_factor * exp(-k*(t)) * exp(-k*(tau-T_inf)).\n                # Let's re-verify the formula from the problem description.\n                # Css(t) = C_infusion_part + C_ss(t=tau) * exp(k*tau) * exp(-k*(t+tau-T_inf)) which is not quite right.\n                # Let's stick to the formula in the problem statement.\n                # C_ss(t) = Infusion_part + Peak_ss * exp(-k*(t+tau-T_inf)) ? No.\n                # C_ss(t) = Infusion_part + C_ss(t=T_inf) * exp(-k*t) -> from previous cycle.\n                # Let's use the provided formula `C_ss(t) = (R0/CL)*(1-exp(-kt)) + (R0/CL)*(1-exp(-kT_inf))*exp(-k*(t+tau-T_inf))/(1-exp(-k*tau))`\n                term1 = (R0 / CL) * (-np.expm1(-k * t))\n                term2 = common_factor * np.exp(-k * (t + tau - T_inf))\n                C_pred[i] = term1 + term2\n            else:\n                # Post-infusion\n                C_pred[i] = common_factor * np.exp(-k * (t - T_inf))\n\n        return C_pred\n\n    def objective_function(log_params, case_data):\n        \"\"\"\n        Negative log-posterior objective function for MAP estimation.\n        \"\"\"\n        log_CL, log_V = log_params\n        \n        # Unpack case data\n        D, T_inf, tau = case_data[\"D_prev\"], case_data[\"T_inf\"], case_data[\"tau\"]\n        t_obs, C_obs = case_data[\"t_obs\"], case_data[\"C_obs\"]\n        CL_pop, V_pop = case_data[\"CL_pop\"], case_data[\"V_pop\"]\n        w_CL, w_V, sigma = case_data[\"w_CL\"], case_data[\"w_V\"], case_data[\"sigma\"]\n\n        # Calculate predicted concentrations\n        C_pred = calculate_ss_concentration(log_CL, log_V, D, T_inf, tau, t_obs)\n        \n        # Check for non-physical results\n        if np.any(C_pred = 0) or np.any(np.isinf(C_pred)) or np.any(np.isnan(C_pred)):\n            return 1e12 # Return a large number\n\n        # Likelihood term (sum of squared weighted residuals in log-space)\n        log_C_pred = np.log(C_pred)\n        log_C_obs = np.log(C_obs)\n        likelihood_term = np.sum(((log_C_pred - log_C_obs) / sigma)**2)\n\n        # Prior terms (squared deviations from population mean in log-space)\n        log_CL_pop = np.log(CL_pop)\n        log_V_pop = np.log(V_pop)\n        prior_cl_term = ((log_CL - log_CL_pop) / w_CL)**2\n        prior_v_term = ((log_V - log_V_pop) / w_V)**2\n\n        return 0.5 * (likelihood_term + prior_cl_term + prior_v_term)\n\n    def calculate_next_dose(hat_CL, hat_V, T_inf, tau, C_target):\n        \"\"\"\n        Calculates the next dose to achieve the target trough concentration.\n        \"\"\"\n        hat_k = hat_CL / hat_V\n        \n        k_tau = hat_k * tau\n        k_T_inf = hat_k * T_inf\n        \n        if k_T_inf  1e-9: # Should not happen with physical parameters\n            return np.inf\n            \n        # 1 - exp(-x) calculation using expm1 for precision\n        numerator_factor = -np.expm1(-k_tau)\n        denominator_factor = -np.expm1(-k_T_inf)\n        \n        D_next = C_target * hat_CL * T_inf * (numerator_factor / denominator_factor) * np.exp(hat_k * (tau - T_inf))\n        return D_next\n\n    results = []\n    for case in test_cases:\n        # Initial guess from population parameters\n        x0 = [np.log(case[\"CL_pop\"]), np.log(case[\"V_pop\"])]\n\n        # Perform minimization to find MAP estimates\n        opt_result = minimize(\n            objective_function,\n            x0,\n            args=(case,),\n            method='Nelder-Mead',\n            options={'xatol': 1e-8, 'disp': False}\n        )\n        \n        log_CL_hat, log_V_hat = opt_result.x\n        hat_CL = np.exp(log_CL_hat)\n        hat_V = np.exp(log_V_hat)\n\n        # Calculate the next dose\n        D_next = calculate_next_dose(\n            hat_CL, hat_V, case[\"T_inf\"], case[\"tau\"], case[\"C_target\"]\n        )\n\n        # Append rounded integer dose to results\n        results.append(int(round(D_next)))\n    \n    # Print the final result in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}