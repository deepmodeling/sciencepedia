{
    "hands_on_practices": [
        {
            "introduction": "在进行精细定位分析之前，我们首先需要深刻理解连锁不平衡（LD）是如何将真实的因果信号“扩散”到邻近的非因果位点上的。这个练习将指导你从第一性原理出发，推导一个未被观测到的因果变异如何通过连锁不平衡，在周围的标记SNP（单核苷酸多态性）上产生关联信号的模式。通过这个实践，你将掌握关联信号在基因组区域内分布的核心数学机制，这是所有精细定位方法试图解决的根本问题 。",
            "id": "4564206",
            "problem": "一个研究团队正在对一个数量性状进行全基因组关联研究 (GWAS)。他们对一个区域内的 $m=4$ 个单核苷酸多态性 (SNP) 进行了基因分型，并通过将该性状分别对每个 SNP 进行回归，计算了边际 $z$-分数。性状向量 $\\mathbf{y} \\in \\mathbb{R}^{N}$ 被标准化为均值为 0、方差为 1。$N \\times m$ 的观测基因型矩阵 $\\mathbf{X}$ 的每一列都被标准化为均值为 0、方差为 1，观测到的 SNP 之间的经验连锁不平衡 (LD) 矩阵为 $\\mathbf{R} = \\frac{1}{N}\\mathbf{X}^{\\top}\\mathbf{X}$。存在一个单一的未观测到的因果变异，其标准化基因型向量为 $\\mathbf{g}_{u} \\in \\mathbb{R}^{N}$，加性效应大小为 $\\beta_{u}$，因此表型由如下模型生成\n$$\n\\mathbf{y} = \\mathbf{g}_{u}\\,\\beta_{u} + \\boldsymbol{\\varepsilon},\n$$\n其中 $\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\sigma_{e}^{2}\\mathbf{I}_{N})$ 是独立噪声。假设该性状已被标准化，因此 $\\operatorname{Var}(\\mathbf{y}) = 1$，这意味着在 $\\operatorname{Var}(\\mathbf{g}_{u}) = 1$ 的条件下，有 $\\sigma_{e}^{2} = 1 - \\beta_{u}^{2}$。未观测到的基因型可以通过最佳线性预测器从观测到的面板数据中进行部分预测\n$$\n\\mathbf{g}_{u} = \\mathbf{X}\\mathbf{c} + \\boldsymbol{\\eta},\n$$\n其中 $\\boldsymbol{\\eta}$ 的均值为零，与 $\\mathbf{X}$ 的所有列不相关，且 $\\operatorname{Var}(\\boldsymbol{\\eta}) = 1 - \\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}$ 以确保 $\\operatorname{Var}(\\mathbf{g}_{u})=1$。SNP $j$ 的边际 $z$-分数计算公式为 $z_{j} = \\hat{\\beta}_{j}/\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j})$，其中 $\\hat{\\beta}_{j}$ 是将 $\\mathbf{y}$ 对 $\\mathbf{x}_{j}$（$\\mathbf{X}$ 的第 $j$ 列）进行回归得到的普通最小二乘系数，其标准误在大样本中估计为 $\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j}) \\approx \\sigma_{e}/\\sqrt{N}$。在整个问题中，假设 $N$ 很大，因此样本量收敛于其总体极限。\n\n1. 从这些定义出发，且不使用任何未经证明的快捷公式，用 $N$, $\\sigma_{e}^{2}$, $\\beta_{u}$, $\\mathbf{R}$ 和 $\\mathbf{c}$ 来推导边际 $z$-分数向量 $\\mathbf{z} \\in \\mathbb{R}^{m}$ 的渐近联合分布。具体来说，请确定均值向量 $\\mathbb{E}[\\mathbf{z}]$ 和协方差矩阵 $\\operatorname{Cov}(\\mathbf{z})$ 的显式表达式，从而说明一个未观测到的因果变异是如何通过连锁不平衡 (LD) 在观测到的 $z$-分数中体现出来的。\n\n2. 现在，在以下科学上合理且自洽的数值设定下，评估由均值向量所引出的模式。令 $N = 50000$, $\\beta_{u} = 0.05$，且\n$$\n\\mathbf{R} = \\begin{pmatrix}\n1.0  0.6  0.2  0.0 \\\\\n0.6  1.0  0.25  0.1 \\\\\n0.2  0.25  1.0  -0.15 \\\\\n0.0  0.1  -0.15  1.0\n\\end{pmatrix}, \\quad\n\\mathbf{c} = \\begin{pmatrix} 0.5 \\\\ 0.2 \\\\ -0.1 \\\\ 0.0 \\end{pmatrix}.\n$$\n计算在 4 个观测到的 SNP 上的诱导期望 $z$-分数，结果表示为一个 $1 \\times 4$ 的行向量。将您的答案四舍五入到四位有效数字。将最终答案表示为纯数字向量（无单位）。",
            "solution": "首先对问题进行验证，以确保其科学基础扎实、问题定义明确且内容自洽。\n\n### 第 1 步：提取已知条件\n-   SNP 数量，$m=4$。\n-   性状向量 $\\mathbf{y} \\in \\mathbb{R}^{N}$，均值为 0，方差为 1。\n-   基因型矩阵 $\\mathbf{X} \\in \\mathbb{R}^{N \\times m}$，其列被标准化为均值为 0，方差为 1。\n-   连锁不平衡 (LD) 矩阵：$\\mathbf{R} = \\frac{1}{N}\\mathbf{X}^{\\top}\\mathbf{X}$。\n-   表型模型：$\\mathbf{y} = \\mathbf{g}_{u}\\,\\beta_{u} + \\boldsymbol{\\varepsilon}$。\n-   未观测到的因果基因型向量 $\\mathbf{g}_{u} \\in \\mathbb{R}^{N}$，均值为 0，方差为 1。\n-   因果效应大小：$\\beta_{u}$。\n-   噪声项：$\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\sigma_{e}^{2}\\mathbf{I}_{N})$。\n-   噪声方差：$\\sigma_{e}^{2} = 1 - \\beta_{u}^{2}$。\n-   因果基因型的线性预测器：$\\mathbf{g}_{u} = \\mathbf{X}\\mathbf{c} + \\boldsymbol{\\eta}$。\n-   预测误差 $\\boldsymbol{\\eta}$ 均值为零，且与 $\\mathbf{X}$ 的各列不相关。\n-   预测误差项的方差：$\\operatorname{Var}(\\boldsymbol{\\eta}) = 1 - \\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}$。\n-   SNP $j$ 的边际 $z$-分数：$z_{j} = \\hat{\\beta}_{j}/\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j})$。\n-   $\\hat{\\beta}_{j}$ 是将 $\\mathbf{y}$ 对 $\\mathbf{x}_{j}$ 回归得到的 OLS 系数。\n-   大样本标准误近似：$\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j}) \\approx \\sigma_{e}/\\sqrt{N}$。\n-   假设：$N$ 很大，样本量收敛于总体极限。\n-   第 2 部分的数值：$N = 50000$, $\\beta_{u} = 0.05$。\n-   $\\mathbf{R} = \\begin{pmatrix} 1.0  0.6  0.2  0.0 \\\\ 0.6  1.0  0.25  0.1 \\\\ 0.2  0.25  1.0  -0.15 \\\\ 0.0  0.1  -0.15  1.0 \\end{pmatrix}$, $\\mathbf{c} = \\begin{pmatrix} 0.5 \\\\ 0.2 \\\\ -0.1 \\\\ 0.0 \\end{pmatrix}$。\n\n### 第 2 步：使用提取的已知条件进行验证\n该问题描述了一个用于统计遗传学精细定位研究的标准生成模型。该模型假定存在一个单一的未观测到的因果变异，其遗传效应通过连锁不平衡，由一组已进行基因分型的 SNP 间接观测到。其中的数学关系和定义，如 OLS 估计量、z-分数、LD 矩阵和方差分量，都是标准的且被正确地指定。样本量收敛于其总体极限的假设，是推导渐近性质时常用且必要的简化。\n对数值进行一致性检查。矩阵 $\\mathbf{R}$ 是一个有效的相关矩阵（对称、对角线元素为 1，且为正定矩阵）。关于 $\\boldsymbol{\\eta}$ 方差的条件要求 $\\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c} \\le 1$。\n$$\n\\mathbf{R}\\mathbf{c} = \\begin{pmatrix} 1.0  0.6  0.2  0.0 \\\\ 0.6  1.0  0.25  0.1 \\\\ 0.2  0.25  1.0  -0.15 \\\\ 0.0  0.1  -0.15  1.0 \\end{pmatrix} \\begin{pmatrix} 0.5 \\\\ 0.2 \\\\ -0.1 \\\\ 0.0 \\end{pmatrix} = \\begin{pmatrix} 0.5 + 0.12 - 0.02 \\\\ 0.3 + 0.2 - 0.025 \\\\ 0.1 + 0.05 - 0.1 \\\\ 0.02 + 0.015 \\end{pmatrix} = \\begin{pmatrix} 0.6 \\\\ 0.475 \\\\ 0.05 \\\\ 0.035 \\end{pmatrix}\n$$\n$$\n\\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c} = \\begin{pmatrix} 0.5  0.2  -0.1  0.0 \\end{pmatrix} \\begin{pmatrix} 0.6 \\\\ 0.475 \\\\ 0.05 \\\\ 0.035 \\end{pmatrix} = 0.3 + 0.095 - 0.005 = 0.39\n$$\n由于 $0.39  1$，$\\boldsymbol{\\eta}$ 的方差为非负，因此数值参数是一致的。该问题具有科学依据、定义明确、客观且自洽。\n\n### 第 3 步：结论与行动\n问题有效。将提供完整解答。\n\n### 第 1 部分：$\\mathbf{z}$ 的渐近分布推导\n我们首先推导边际 $z$-分数向量 $\\mathbf{z} \\in \\mathbb{R}^{m}$ 的表达式。\n单个 SNP $j$（即 $\\mathbf{x}_{j}$）对性状 $\\mathbf{y}$ 的效应的 OLS 估计量由 $\\hat{\\beta}_{j} = (\\mathbf{x}_{j}^{\\top}\\mathbf{x}_{j})^{-1}\\mathbf{x}_{j}^{\\top}\\mathbf{y}$ 给出。由于每个 SNP 基因型向量 $\\mathbf{x}_{j}$ 都被标准化，其方差为 1，这意味着 $\\frac{1}{N}\\mathbf{x}_{j}^{\\top}\\mathbf{x}_{j} = 1$，因此 $\\mathbf{x}_{j}^{\\top}\\mathbf{x}_{j} = N$。于是，$\\hat{\\beta}_{j} = \\frac{1}{N}\\mathbf{x}_{j}^{\\top}\\mathbf{y}$。\n我们可以将所有这类估计量组成的向量 $\\hat{\\boldsymbol{\\beta}} \\in \\mathbb{R}^{m}$ 写为：\n$$\n\\hat{\\boldsymbol{\\beta}} = \\frac{1}{N}\\mathbf{X}^{\\top}\\mathbf{y}\n$$\nSNP $j$ 的 $z$-分数是 $z_{j} = \\hat{\\beta}_{j}/\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j})$。使用大样本近似 $\\widehat{\\mathrm{SE}}(\\hat{\\beta}_{j}) \\approx \\sigma_{e}/\\sqrt{N}$，$z$-分数向量为：\n$$\n\\mathbf{z} = \\frac{\\sqrt{N}}{\\sigma_{e}}\\hat{\\boldsymbol{\\beta}} = \\frac{\\sqrt{N}}{\\sigma_{e}} \\left( \\frac{1}{N}\\mathbf{X}^{\\top}\\mathbf{y} \\right) = \\frac{1}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}\\mathbf{y}\n$$\n现在，我们代入表型模型 $\\mathbf{y} = \\mathbf{g}_{u}\\beta_{u} + \\boldsymbol{\\varepsilon}$：\n$$\n\\mathbf{z} = \\frac{1}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}(\\mathbf{g}_{u}\\beta_{u} + \\boldsymbol{\\varepsilon})\n$$\n接下来，我们代入未观测到的基因型的线性预测模型 $\\mathbf{g}_{u} = \\mathbf{X}\\mathbf{c} + \\boldsymbol{\\eta}$：\n$$\n\\mathbf{z} = \\frac{1}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}((\\mathbf{X}\\mathbf{c} + \\boldsymbol{\\eta})\\beta_{u} + \\boldsymbol{\\varepsilon}) = \\frac{1}{\\sigma_{e}\\sqrt{N}}(\\beta_{u}\\mathbf{X}^{\\top}\\mathbf{X}\\mathbf{c} + \\beta_{u}\\mathbf{X}^{\\top}\\boldsymbol{\\eta} + \\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon})\n$$\n根据 LD 矩阵的定义 $\\mathbf{R} = \\frac{1}{N}\\mathbf{X}^{\\top}\\mathbf{X}$，我们有 $\\mathbf{X}^{\\top}\\mathbf{X} = N\\mathbf{R}$。将其代入：\n$$\n\\mathbf{z} = \\frac{1}{\\sigma_{e}\\sqrt{N}}(\\beta_{u}N\\mathbf{R}\\mathbf{c} + \\beta_{u}\\mathbf{X}^{\\top}\\boldsymbol{\\eta} + \\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon}) = \\frac{\\sqrt{N}\\beta_{u}}{\\sigma_{e}}\\mathbf{R}\\mathbf{c} + \\frac{\\beta_{u}}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}\\boldsymbol{\\eta} + \\frac{1}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon}\n$$\n这个表达式将 $\\mathbf{z}$ 分为一个确定性部分（第一项，因为我们以 $\\mathbf{X}$ 为条件）和一个随机部分（后两项）。\n\n为了求均值向量 $\\mathbb{E}[\\mathbf{z}]$，我们对该表达式取期望。随机变量是 $\\boldsymbol{\\eta}$ 和 $\\boldsymbol{\\varepsilon}$ 的元素。我们已知 $\\boldsymbol{\\eta}$ 的均值为零，且 $\\boldsymbol{\\varepsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\sigma_{e}^{2}\\mathbf{I}_{N})$，这意味着 $\\mathbb{E}[\\boldsymbol{\\varepsilon}]=\\mathbf{0}$。因此，$\\mathbb{E}[\\mathbf{X}^{\\top}\\boldsymbol{\\eta}] = \\mathbf{X}^{\\top}\\mathbb{E}[\\boldsymbol{\\eta}] = \\mathbf{0}$ 且 $\\mathbb{E}[\\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon}] = \\mathbf{X}^{\\top}\\mathbb{E}[\\boldsymbol{\\varepsilon}] = \\mathbf{0}$。\n因此，均值向量就是确定性部分：\n$$\n\\mathbb{E}[\\mathbf{z}] = \\frac{\\sqrt{N}\\beta_{u}}{\\sigma_{e}}\\mathbf{R}\\mathbf{c}\n$$\n随机项涉及大量随机变量（$\\boldsymbol{\\eta}$ 和 $\\boldsymbol{\\varepsilon}$ 的元素）的线性组合，因此根据中心极限定理，向量 $\\mathbf{z}$ 是渐近多元正态的，即 $\\mathbf{z} \\sim \\mathcal{N}(\\mathbb{E}[\\mathbf{z}], \\operatorname{Cov}(\\mathbf{z}))$。\n\n为了求协方差矩阵 $\\operatorname{Cov}(\\mathbf{z})$，我们计算 $\\mathbf{z}$ 的随机部分的协方差：\n$$\n\\operatorname{Cov}(\\mathbf{z}) = \\operatorname{Cov}\\left(\\frac{\\beta_{u}}{\\sigma_{e}\\sqrt{N}}\\mathbf{X}^{\\top}\\boldsymbol{\\eta} + \\frac{1}{\\sigma_{e}\\sqrt{N}}\\mathbfX^{\\top}\\boldsymbol{\\varepsilon}\\right)\n$$\n假设遗传预测误差 $\\boldsymbol{\\eta}$ 与环境噪声 $\\boldsymbol{\\varepsilon}$ 独立，则和的协方差等于协方差的和：\n$$\n\\operatorname{Cov}(\\mathbf{z}) = \\frac{\\beta_{u}^{2}}{\\sigma_{e}^{2}N}\\operatorname{Cov}(\\mathbf{X}^{\\top}\\boldsymbol{\\eta}) + \\frac{1}{\\sigma_{e}^{2}N}\\operatorname{Cov}(\\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon})\n$$\n$\\boldsymbol{\\varepsilon}$ 的元素是独立同分布的，方差为 $\\sigma_e^2$，所以 $\\operatorname{Cov}(\\boldsymbol{\\varepsilon}) = \\sigma_{e}^{2}\\mathbf{I}_{N}$。\n$$\n\\operatorname{Cov}(\\mathbf{X}^{\\top}\\boldsymbol{\\varepsilon}) = \\mathbf{X}^{\\top}\\operatorname{Cov}(\\boldsymbol{\\varepsilon})\\mathbf{X} = \\mathbf{X}^{\\top}(\\sigma_{e}^{2}\\mathbf{I}_{N})\\mathbf{X} = \\sigma_{e}^{2}\\mathbf{X}^{\\top}\\mathbf{X} = N\\sigma_{e}^{2}\\mathbf{R}\n$$\n类似地，该问题意味着 $\\boldsymbol{\\eta}$ 的元素是独立同分布的，均值为 0，方差为 $\\sigma_{\\eta}^2 = \\operatorname{Var}(\\boldsymbol{\\eta}) = 1 - \\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}$。因此，$\\operatorname{Cov}(\\boldsymbol{\\eta}) = \\sigma_{\\eta}^2\\mathbf{I}_{N}$。\n$$\n\\operatorname{Cov}(\\mathbf{X}^{\\top}\\boldsymbol{\\eta}) = \\mathbf{X}^{\\top}\\operatorname{Cov}(\\boldsymbol{\\eta})\\mathbf{X} = \\mathbf{X}^{\\top}(\\sigma_{\\eta}^{2}\\mathbf{I}_{N})\\mathbf{X} = \\sigma_{\\eta}^{2}\\mathbf{X}^{\\top}\\mathbf{X} = N\\sigma_{\\eta}^{2}\\mathbf{R}\n$$\n将这些代入 $\\operatorname{Cov}(\\mathbf{z})$ 的表达式中：\n$$\n\\operatorname{Cov}(\\mathbf{z}) = \\frac{\\beta_{u}^{2}}{\\sigma_{e}^{2}N}(N\\sigma_{\\eta}^{2}\\mathbf{R}) + \\frac{1}{\\sigma_{e}^{2}N}(N\\sigma_{e}^{2}\\mathbf{R}) = \\left(\\frac{\\beta_{u}^{2}\\sigma_{\\eta}^{2}}{\\sigma_{e}^{2}} + 1\\right)\\mathbf{R}\n$$\n现在，代入 $\\sigma_{\\eta}^2 = 1 - \\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}$ 和 $\\sigma_{e}^2 = 1 - \\beta_{u}^2$：\n$$\n\\operatorname{Cov}(\\mathbf{z}) = \\left(\\frac{\\beta_{u}^{2}(1 - \\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c})}{1 - \\beta_{u}^2} + \\frac{1 - \\beta_{u}^2}{1 - \\beta_{u}^2}\\right)\\mathbf{R} = \\frac{\\beta_{u}^{2} - \\beta_{u}^{2}\\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c} + 1 - \\beta_{u}^2}{1-\\beta_{u}^2}\\mathbf{R} = \\frac{1 - \\beta_{u}^{2}\\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}}{1-\\beta_{u}^2}\\mathbf{R}\n$$\n因此，渐近分布为 $\\mathbf{z} \\sim \\mathcal{N}\\left(\\frac{\\sqrt{N}\\beta_{u}}{\\sigma_{e}}\\mathbf{R}\\mathbf{c}, \\frac{1 - \\beta_{u}^{2}\\mathbf{c}^{\\top}\\mathbf{R}\\mathbf{c}}{1-\\beta_{u}^2}\\mathbf{R}\\right)$。\n\n### 第 2 部分：均值向量的评估\n我们需要使用给定的数值计算期望 $z$-分数 $\\mathbb{E}[\\mathbf{z}]$。公式为：\n$$\n\\mathbb{E}[\\mathbf{z}] = \\frac{\\sqrt{N}\\beta_{u}}{\\sigma_{e}}\\mathbf{R}\\mathbf{c}\n$$\n首先，我们计算必要的分量：\n$N = 50000$, $\\beta_{u} = 0.05$。\n噪声方差为 $\\sigma_{e}^{2} = 1 - \\beta_{u}^{2} = 1 - (0.05)^{2} = 1 - 0.0025 = 0.9975$。\n噪声标准差为 $\\sigma_{e} = \\sqrt{0.9975}$。\n标量乘数为：\n$$\n\\frac{\\sqrt{N}\\beta_{u}}{\\sigma_{e}} = \\frac{\\sqrt{50000} \\times 0.05}{\\sqrt{0.9975}} = \\frac{223.60679... \\times 0.05}{0.998749...} = \\frac{11.180339...}{0.998749...} \\approx 11.19430\n$$\n接下来，我们计算向量积 $\\mathbf{R}\\mathbf{c}$，这在验证阶段已经计算过了：\n$$\n\\mathbf{R}\\mathbf{c} = \\begin{pmatrix} 0.6 \\\\ 0.475 \\\\ 0.05 \\\\ 0.035 \\end{pmatrix}\n$$\n最后，我们将标量与向量相乘：\n$$\n\\mathbb{E}[\\mathbf{z}] = 11.19430 \\times \\begin{pmatrix} 0.6 \\\\ 0.475 \\\\ 0.05 \\\\ 0.035 \\end{pmatrix} = \\begin{pmatrix} 11.19430 \\times 0.6 \\\\ 11.19430 \\times 0.475 \\\\ 11.19430 \\times 0.05 \\\\ 11.19430 \\times 0.035 \\end{pmatrix} = \\begin{pmatrix} 6.71658 \\\\ 5.31729 \\\\ 0.559715 \\\\ 0.3918005 \\end{pmatrix}\n$$\n将这些值四舍五入到四位有效数字，得到最终结果：\n$$\n\\mathbb{E}[\\mathbf{z}]^{\\top} \\approx \\begin{pmatrix} 6.717  5.317  0.5597  0.3918 \\end{pmatrix}\n$$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 6.717  5.317  0.5597  0.3918 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "理论的理解需要通过实践来巩固。这个练习要求你构建一个完整的模拟流程，从真实的单倍型数据出发，生成全基因组关联研究（GWAS）风格的摘要统计数据。亲手实现数据生成过程，是从根本上理解遗传模型、连锁不平衡、遗传度和表型之间复杂关系的最佳方式。这项实践不仅能加深你对数据来源的认识，还能为你评估和比较不同精细定位方法的性能提供关键技能 。",
            "id": "4564276",
            "problem": "设计并实现一个完整的模拟流程，用于在使用单倍型数据和全基因组关联研究（GWAS）风格的汇总统计数据的背景下，对致病性单核苷酸多态性（SNPs）进行精细定位。从加性线性遗传模型的第一性原理和统计遗传学中使用的已验证定义出发，推导模拟表型、生成每个 SNP 的边际关联统计数据以及计算连锁不平衡（LD）相关矩阵所需的每个计算步骤。\n\n使用以下基本依据和核心定义：\n- 加性线性遗传模型指出，对于 $n$ 个个体，表型向量 $y \\in \\mathbb{R}^n$ 可以写作 $y = X \\beta + \\varepsilon$，其中 $X \\in \\mathbb{R}^{n \\times p}$ 是包含 $p$ 个 SNP 的标准化基因型矩阵，$\\beta \\in \\mathbb{R}^p$ 是 SNP 效应值向量，$\\varepsilon \\sim \\mathcal{N}(0, \\sigma_\\varepsilon^2 I_n)$ 是方差为 $\\sigma_\\varepsilon^2$ 的噪声向量。\n- 当 $X$ 的列被标准化为均值为 $0$、方差为 $1$ 时（使用分母为 $n$ 的总体方差定义），连锁不平衡（LD）相关矩阵定义为 $R = \\frac{1}{n} X^\\top X$。\n- 给定标准化的 $X$ 和标准化的 $y$（使用分母为 $n$ 时均值为 $0$，方差为 $1$），定义单个 SNP 的汇总统计数据向量 $z \\in \\mathbb{R}^p$ 为 $z = \\frac{1}{\\sqrt{n}} X^\\top y$。\n- 狭义遗传力 $h^2$ 定义为 $h^2 = \\frac{\\operatorname{Var}(X \\beta)}{\\operatorname{Var}(X \\beta) + \\sigma_\\varepsilon^2}$。在模拟中，可以使用遗传组分 $g = X \\beta$ 的经验方差来设置 $\\sigma_\\varepsilon^2$，以满足目标 $h^2$。\n\n给定单倍型参考面板 $H \\in \\{0,1\\}^{M \\times P}$，其中 $M$ 是单倍型数量，$P$ 是 SNP 数量。为了模拟 $n$ 个二倍体个体，对每个个体有放回地抽样两个单倍型，并将这两个单倍型行相加，形成一个未标准化的基因型矩阵 $G \\in \\{0,1,2\\}^{n \\times P}$。然后：\n1. 对 $G$ 的每个 SNP 列进行中心化和缩放，以构建每列均值为 $0$、方差为 $1$ 的 $X$，使用总体定义：\n   - 对于向量 $v \\in \\mathbb{R}^n$，定义均值 $\\mu(v) = \\frac{1}{n} \\sum_{i=1}^n v_i$ 和方差 $s^2(v) = \\frac{1}{n} \\sum_{i=1}^n (v_i - \\mu(v))^2$。当 $s(v)  0$ 时，标准化为 $v^{\\text{std}} = \\frac{v - \\mu(v) \\mathbf{1}}{s(v)}$。\n   - 如果一个 SNP 的方差为零（在模拟样本中是单态的），则在所有下游计算之前移除该 SNP。\n2. 从保留的 SNP 中均匀随机选择 $k$ 个致病性 SNP，并从一个正态分布中独立抽取它们的效应值，非致病性 SNP 的效应值设为 $0$。设所得效应值向量为 $\\beta$。\n3. 计算遗传组分 $g = X \\beta$。设 $\\widehat{\\operatorname{Var}}(g)$ 为使用分母 $n$ 的经验方差。设置环境噪声方差 $\\sigma_\\varepsilon^2$ 以达到目标遗传力 $h^2 \\in (0,1)$：\n   $$\\sigma_\\varepsilon^2 = \\widehat{\\operatorname{Var}}(g) \\cdot \\frac{1 - h^2}{h^2}。$$\n   从 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma_\\varepsilon^2 I_n)$ 中抽样并设置 $y = g + \\varepsilon$。使用与上述相同的总体定义将 $y$ 标准化为均值为 $0$，方差为 $1$。\n4. 计算 $R = \\frac{1}{n} X^\\top X$ 和 $z = \\frac{1}{\\sqrt{n}} X^\\top y$。\n\n你的任务是实现一个程序，对下面的测试套件执行上述模拟。程序必须通过使用给定的随机种子来保证完全的确定性。\n\n测试套件的输入数据（在程序内部固定；不允许外部输入）：\n- 测试用例 1（正常路径）：\n  - 单倍型参考面板 $H_1 \\in \\{0,1\\}^{8 \\times 6}$：\n    - 行（每行为一个长度为 6 的单倍型）：\n      - $[0,0,0,0,0,0]$\n      - $[0,0,1,1,1,1]$\n      - $[1,1,1,1,0,0]$\n      - $[1,1,0,0,1,1]$\n      - $[0,1,0,1,0,1]$\n      - $[1,0,1,0,1,0]$\n      - $[0,1,1,1,0,1]$\n      - $[1,0,0,0,1,0]$\n  - 个体数量 $n = 50$。\n  - 致病性 SNP 数量 $k = 2$。\n  - 目标遗传力 $h^2 = 0.5$（以小数形式）。\n  - 随机种子 $s = 123$。\n- 测试用例 2（包含必须丢弃的单态 SNP 的边缘情况）：\n  - 单倍型参考面板 $H_2 \\in \\{0,1\\}^{6 \\times 5}$：\n    - 行：\n      - $[0,0,0,0,0]$\n      - $[1,0,1,0,0]$\n      - $[0,1,0,1,0]$\n      - $[1,1,1,1,0]$\n      - $[0,0,1,1,0]$\n      - $[1,0,0,0,0]$\n    - 注意：最后一列是单态的，如果在 $n$ 个抽样个体中仍然是单态的，则必须在模拟基因型后移除。\n  - 个体数量 $n = 10$。\n  - 致病性 SNP 数量 $k = 1$。\n  - 目标遗传力 $h^2 = 0.3$。\n  - 随机种子 $s = 321$。\n- 测试用例 3（具有完全相关 SNP 的强连锁不平衡）：\n  - 单倍型参考面板 $H_3 \\in \\{0,1\\}^{10 \\times 4}$：\n    - 行：\n      - $[0,0,0,1]$\n      - $[1,1,0,0]$\n      - $[0,0,1,1]$\n      - $[1,1,1,0]$\n      - $[0,0,0,0]$\n      - $[1,1,1,1]$\n      - $[0,0,1,0]$\n      - $[1,1,0,1]$\n      - $[0,0,0,1]$\n      - $[1,1,1,0]$\n    - 第 1 列和第 2 列相同，导致完全的连锁不平衡。\n  - 个体数量 $n = 40$。\n  - 致病性 SNP 数量 $k = 2$。\n  - 目标遗传力 $h^2 = 0.7$。\n  - 随机种子 $s = 999$。\n\n实现要求：\n- 对于每个测试用例，通过从给定面板中为每个个体有放回地均匀抽样两个单倍型并将其相加得到 $G \\in \\{0,1,2\\}^{n \\times P}$ 来模拟基因型。\n- 使用总体均值和方差标准化列以构建 $X$；在进一步步骤之前，丢弃任何方差为零的列。如果在丢弃单态 SNP 后，可用 SNP 的数量小于 $k$，则必须从大小为 $p$ 的可用 SNP 集合中无放回地抽样致病性 SNP，并假定在测试套件中 $k \\le p$ 得到满足。\n- 从标准正态分布 $\\mathcal{N}(0,1)$ 中独立抽取 $\\beta$ 的非零项作为致病性 SNP 的效应值，所有其他项设置为 $0$。\n- 计算 $g = X \\beta$，设置 $\\sigma_\\varepsilon^2 = \\widehat{\\operatorname{Var}}(g) \\cdot \\frac{1 - h^2}{h^2}$，从 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma_\\varepsilon^2 I_n)$ 中抽取，设置 $y = g + \\varepsilon$，并使用总体定义将 $y$ 标准化为均值为 $0$、方差为 $1$。\n- 计算 $R = \\frac{1}{n} X^\\top X$ 和 $z = \\frac{1}{\\sqrt{n}} X^\\top y$。\n\n数值和算法细节：\n- 仅使用提供的参数和矩阵；不要求任何外部输入或文件。\n- 所有随机抽样必须使用每个测试用例指定的种子执行，以确保确定性。\n- 不涉及物理单位。遗传力 $h^2$ 必须解释为 $(0,1)$ 内的小数，而不是百分比。\n- 您的实现必须通过丢弃方差恰好为零的列来对其具有鲁棒性。\n\n最终输出规范：\n- 对于每个测试用例，生成一个列表，该列表拼接了 $z$ 的条目，后随 $R$ 的上三角条目（包括对角线），按行主序排列。具体来说，如果 $R \\in \\mathbb{R}^{p \\times p}$，则输出 $[z_1, z_2, \\dots, z_p, R_{11}, R_{12}, \\dots, R_{1p}, R_{22}, R_{23}, \\dots, R_{2p}, \\dots, R_{pp}]$。\n- 将所有测试用例的结果聚合成一个单一的扁平列表，按测试用例 1、2、3 的顺序附加每个测试用例的列表。\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[\\text{result}_1,\\text{result}_2,\\text{result}_3]$）。条目必须是实数（浮点数）。",
            "solution": "问题要求设计并实现一个确定性的模拟流程，用于从单倍型数据生成全基因组关联研究（GWAS）的汇总统计数据。该过程基于统计遗传学的原理，特别是表型的加性线性模型。我们将验证问题陈述，并在确认其有效后，继续详细推导所需的计算步骤。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n\n- **模型**：对于 $n$ 个个体，表型向量 $y \\in \\mathbb{R}^n$ 建模为 $y = X \\beta + \\varepsilon$。\n    - $X \\in \\mathbb{R}^{n \\times p}$ 是 $p$ 个 SNP 的标准化基因型矩阵。\n    - $\\beta \\in \\mathbb{R}^p$ 是 SNP 效应值向量。\n    - $\\varepsilon \\sim \\mathcal{N}(0, \\sigma_\\varepsilon^2 I_n)$ 是环境噪声向量。\n- **连锁不平衡（LD）**：LD 相关矩阵为 $R = \\frac{1}{n} X^\\top X$，其中 $X$ 的列均值为 $0$，方差为 $1$。\n- **汇总统计数据**：单个 SNP 的汇总统计数据向量为 $z = \\frac{1}{\\sqrt{n}} X^\\top y$，其中 $X$ 和 $y$ 都经过标准化（均值为 $0$，方差为 $1$）。\n- **遗传力**：狭义遗传力为 $h^2 = \\frac{\\operatorname{Var}(X \\beta)}{\\operatorname{Var}(X \\beta) + \\sigma_\\varepsilon^2}$。\n- **模拟输入**：\n    - 单倍型参考面板 $H \\in \\{0,1\\}^{M \\times P}$。\n    - 个体数量 $n$。\n    - 致病性 SNP 数量 $k$。\n    - 目标遗传力 $h^2$。\n    - 随机种子 $s$。\n- **模拟步骤**：\n    1. 通过对每个个体从 $H$ 中抽样并相加两个单倍型来生成未标准化的基因型矩阵 $G \\in \\{0,1,2\\}^{n \\times P}$。\n    2. 标准化 $G$ 的列以获得 $X$。标准化使用总体均值 $\\mu(v) = \\frac{1}{n} \\sum_{i=1}^n v_i$ 和方差 $s^2(v) = \\frac{1}{n} \\sum_{i=1}^n (v_i - \\mu(v))^2$。方差为零的 SNP 将被移除。\n    3. 均匀随机选择 $k$ 个致病性 SNP。它们的效应值从 $\\mathcal{N}(0,1)$ 中抽取，而其他 SNP 的效应值设为 $0$。这定义了 $\\beta$。\n    4. 计算遗传组分 $g = X \\beta$。设置噪声方差 $\\sigma_\\varepsilon^2 = \\widehat{\\operatorname{Var}}(g) \\cdot \\frac{1 - h^2}{h^2}$。生成表型 $y = g + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0, \\sigma_\\varepsilon^2 I_n)$。对 $y$ 进行标准化。\n    5. 计算输出 $R = \\frac{1}{n} X^\\top X$ 和 $z = \\frac{1}{\\sqrt{n}} X^\\top y$。\n- **测试用例**：提供了三个具体的测试用例，包含所有必要的参数（$H_1, H_2, H_3, n, k, h^2, s$）。\n- **输出格式**：一个扁平化列表，包含所有测试用例拼接的 $z$ 向量和对应 $R$ 矩阵的上三角部分。\n\n**第 2 步：使用提取的已知条件进行验证**\n\n根据验证标准评估问题。\n\n- **科学上成立**：该问题在根本上是合理的。加性线性模型、遗传力、连锁不平衡和汇总统计数据的定义都是统计遗传学和生物信息学中标准且被广泛接受的。所述的模拟流程是生成合成数据以测试精细定位算法的一种常用且有效的方法。\n- **定义明确**：该问题是适定 (well-posed) 的。它提供了一套完整、有序且无歧义的指令。包含随机种子确保了整个过程是确定性的，并能产生唯一、可验证的解。每个测试用例都提供了所有必需的数据和参数。\n- **客观性**：问题以精确、客观的数学和算法语言陈述，不含任何主观或基于观点的内容。\n\n问题没有表现出任何已定义的缺陷（例如，事实不成立、不完整、模糊性）。测试用例设计良好，涵盖了标准场景（测试用例 1）、含单态变异的边缘情况（测试用例 2）以及含完全连锁不平衡的情况（测试用例 3），这些都是遗传数据分析中的相关挑战。\n\n**第 3 步：结论与行动**\n\n问题是**有效的**。我们将继续提供完整解法。\n\n### 推导与算法设计\n\n该解法按规定实现了模拟流程。为每个测试用例初始化一个确定性的伪随机数生成器，以确保可复现性。\n\n**1. 基因型模拟**\n\n给定一个单倍型参考面板 $H \\in \\{0,1\\}^{M \\times P}$，其中 $M$ 是参考单倍型的数量，$P$ 是 SNP 的数量。为模拟 $n$ 个个体的二倍体基因型矩阵 $G \\in \\{0,1,2\\}^{n \\times P}$，我们对每个个体 $i \\in \\{1, \\dots, n\\}$ 执行以下操作：\n- 从 $\\{1, \\dots, M\\}$ 中有放回地均匀抽样两个单倍型索引 $j_1$ 和 $j_2$。\n- 个体 $i$ 的基因型向量，记为 $G_{i, \\cdot}$，是两个抽样单倍型 $H_{j_1, \\cdot}$ 和 $H_{j_2, \\cdot}$ 的逐元素和。因此，$G$ 的条目在 $\\{0, 1, 2\\}$ 中，表示每个 SNP 处次等位基因的计数。\n\n**2. 基因型标准化与筛选**\n\n原始基因型矩阵 $G$ 必须进行标准化，使其列的均值为零，方差为一。对于每个 SNP（列）$j \\in \\{1, \\dots, P\\}$，令 $G_{\\cdot, j}$ 为对应 $n$ 个个体的基因型向量。\n- 均值计算为 $\\mu_j = \\frac{1}{n} \\sum_{i=1}^n G_{i,j}$。\n- 总体方差计算为 $\\sigma_j^2 = \\frac{1}{n} \\sum_{i=1}^n (G_{i,j} - \\mu_j)^2$。标准差为 $\\sigma_j = \\sqrt{\\sigma_j^2}$。\n\n如果一个 SNP 在样本中是单态的，即所有个体具有相同的基因型，这意味着其方差为 $\\sigma_j^2 = 0$。此类 SNP 不携带关联信息，必须移除。我们筛选 $G$ 以仅保留 $\\sigma_j  0$ 的列。设得到的筛选后基因型矩阵为 $G' \\in \\{0,1,2\\}^{n \\times p}$，其中 $p \\le P$ 是多态性 SNP 的数量。\n\n然后通过标准化 $G'$ 的每一列来构建标准化基因型矩阵 $X \\in \\mathbb{R}^{n \\times p}$：\n$$X_{\\cdot, j} = \\frac{G'_{\\cdot, j} - \\mu_j \\mathbf{1}}{\\sigma_j}$$\n其中 $\\mu_j$ 和 $\\sigma_j$ 分别是 $G'$ 第 $j$ 列的均值和标准差，$\\mathbf{1}$ 是长度为 $n$ 的全一向量。现在 $X$ 的每一列均值为 $0$，方差为 $1$。\n\n**3. 致病性变异与效应值模拟**\n\n我们模拟一个少数 SNP（$k$ 个）为致病性的场景。\n- 我们从 $\\{1, \\dots, p\\}$ 中均匀随机选择一个包含 $k$ 个不同索引的集合 $\\mathcal{C}$。这些是致病性 SNP。\n- 构建效应值向量 $\\beta \\in \\mathbb{R}^p$。对于每个致病性 SNP $j \\in \\mathcal{C}$，其效应值 $\\beta_j$ 从标准正态分布 $\\beta_j \\sim \\mathcal{N}(0, 1)$ 中独立抽取。\n- 对于所有非致病性 SNP $j \\notin \\mathcal{C}$，效应值 $\\beta_j = 0$。\n\n**4. 表型模拟**\n\n表型 $y$ 基于加性线性模型 $y = g + \\varepsilon$ 进行模拟，其中 $g$ 是遗传组分，$\\varepsilon$ 是环境噪声。\n- 所有 $n$ 个个体的遗传组分计算为 $g = X\\beta$。这是一个在 $\\mathbb{R}^n$ 中的向量。\n- 由遗传解释的表型方差比例由狭义遗传力 $h^2$ 决定。根据定义，$h^2 = \\frac{\\operatorname{Var}(g)}{\\operatorname{Var}(g) + \\operatorname{Var}(\\varepsilon)}$。在我们的模拟中，我们使用 $g$ 的经验方差 $\\widehat{\\operatorname{Var}}(g) = \\frac{1}{n}\\sum_{i=1}^n (g_i - \\bar{g})^2$，并设置噪声方差 $\\sigma_\\varepsilon^2 = \\operatorname{Var}(\\varepsilon)$ 以达到目标 $h^2$。这给出：\n  $$\\sigma_\\varepsilon^2 = \\widehat{\\operatorname{Var}}(g) \\left( \\frac{1 - h^2}{h^2} \\right)$$\n  此公式假定 $\\operatorname{Var}(g)  0$。如果 $k=0$ 或所有 $\\beta_j$ 恰好接近 $0$，此方差可能为零。然而，问题设置确保 $k0$，并且随机抽样使得 $\\widehat{\\operatorname{Var}}(g)=0$ 的可能性极低。\n- 环境噪声向量 $\\varepsilon \\in \\mathbb{R}^n$ 的每个分量均从 $\\mathcal{N}(0, \\sigma_\\varepsilon^2)$ 中独立抽取。\n- 最终的表型向量为 $y = g + \\varepsilon$。\n- 为了计算汇总统计数据，该表型向量 $y$ 必须被标准化为均值为 $0$，方差为 $1$，使用与基因型相同的总体定义。设其为 $y_{\\text{std}}$。\n\n**5. 汇总统计数据与连锁不平衡矩阵的计算**\n\n有了标准化的基因型矩阵 $X$ 和标准化的表型向量 $y_{\\text{std}}$，我们计算两个所需的输出。\n- LD 相关矩阵 $R \\in \\mathbb{R}^{p \\times p}$ 定义为：\n  $$R = \\frac{1}{n} X^\\top X$$\n  条目 $R_{ij}$ 表示 SNP $i$ 和 SNP $j$ 之间的相关性。由于 $X$ 的列具有单位方差，对角线上的条目 $R_{ii}$ 都等于 $1$。\n- GWAS 汇总统计数据（Z 分数）向量 $z \\in \\mathbb{R}^p$ 定义为：\n  $$z = \\frac{1}{\\sqrt{n}} X^\\top y_{\\text{std}}$$\n  每个条目 $z_j$ 与 SNP $j$ 和表型之间的边际相关性成正比。\n\n最后，对每个测试用例，通过拼接向量 $z$ 和 $R$ 的上三角元素（包括对角线，按行主序）来格式化结果。然后将所有测试用例的结果聚合成一个单一列表。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation pipeline for all test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"H\": np.array([\n                [0, 0, 0, 0, 0, 0],\n                [0, 0, 1, 1, 1, 1],\n                [1, 1, 1, 1, 0, 0],\n                [1, 1, 0, 0, 1, 1],\n                [0, 1, 0, 1, 0, 1],\n                [1, 0, 1, 0, 1, 0],\n                [0, 1, 1, 1, 0, 1],\n                [1, 0, 0, 0, 1, 0]\n            ], dtype=np.int8),\n            \"n\": 50,\n            \"k\": 2,\n            \"h2\": 0.5,\n            \"seed\": 123\n        },\n        {\n            \"H\": np.array([\n                [0, 0, 0, 0, 0],\n                [1, 0, 1, 0, 0],\n                [0, 1, 0, 1, 0],\n                [1, 1, 1, 1, 0],\n                [0, 0, 1, 1, 0],\n                [1, 0, 0, 0, 0]\n            ], dtype=np.int8),\n            \"n\": 10,\n            \"k\": 1,\n            \"h2\": 0.3,\n            \"seed\": 321\n        },\n        {\n            \"H\": np.array([\n                [0, 0, 0, 1],\n                [1, 1, 0, 0],\n                [0, 0, 1, 1],\n                [1, 1, 1, 0],\n                [0, 0, 0, 0],\n                [1, 1, 1, 1],\n                [0, 0, 1, 0],\n                [1, 1, 0, 1],\n                [0, 0, 0, 1],\n                [1, 1, 1, 0]\n            ], dtype=np.int8),\n            \"n\": 40,\n            \"k\": 2,\n            \"h2\": 0.7,\n            \"seed\": 999\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        H, n, k, h2, seed = case[\"H\"], case[\"n\"], case[\"k\"], case[\"h2\"], case[\"seed\"]\n        M, P = H.shape\n        rng = np.random.default_rng(seed)\n\n        # 1. Genotype Simulation\n        hap1_indices = rng.integers(0, M, size=n)\n        hap2_indices = rng.integers(0, M, size=n)\n        G = H[hap1_indices, :] + H[hap2_indices, :]\n\n        # 2. Genotype Standardization and Filtering\n        # Using population std dev (denominator n), numpy default ddof=0\n        mu_G = G.mean(axis=0)\n        std_G = G.std(axis=0)\n\n        polymorphic_mask = std_G > 0\n        if not np.any(polymorphic_mask):\n             # This case should not happen with the given test data\n             # but is a safe guard.\n            all_results.append([])\n            continue\n\n        G_poly = G[:, polymorphic_mask]\n        mu_G_poly = mu_G[polymorphic_mask]\n        std_G_poly = std_G[polymorphic_mask]\n\n        # Standardize G to get X\n        X = (G_poly - mu_G_poly) / std_G_poly\n        n_individuals, p = X.shape\n\n        # 3. Causal Variant and Effect Size Simulation\n        causal_indices = rng.choice(p, size=k, replace=False)\n        beta = np.zeros(p)\n        beta[causal_indices] = rng.standard_normal(size=k)\n\n        # 4. Phenotype Simulation\n        g = X @ beta\n        var_g = np.var(g) # ddof=0 (population variance)\n        \n        # Handle case where var(g) is zero\n        if var_g == 0:\n            sigma2_eps = 1.0 # arbitrary non-zero variance if no genetic effect\n        else:\n            sigma2_eps = var_g * (1 - h2) / h2\n\n        epsilon = rng.normal(loc=0, scale=np.sqrt(sigma2_eps), size=n_individuals)\n        y = g + epsilon\n        \n        # Standardize phenotype vector y\n        y_std = (y - y.mean()) / y.std() # ddof=0\n\n        # 5. Compute Summary Statistics and LD Matrix\n        R = (X.T @ X) / n_individuals\n        z = (X.T @ y_std) / np.sqrt(n_individuals)\n\n        # Format output for the case\n        upper_tri_indices = np.triu_indices(p)\n        R_upper_tri = R[upper_tri_indices]\n        \n        case_results = list(z) + list(R_upper_tri)\n        all_results.extend(case_results)\n\n    # Final print statement\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "掌握了关联信号的来源和生成方式后，下一步是学习如何分析这些数据以识别因果变异。这个练习将带你深入贝叶斯精细定位的核心计算，在一个简化的双SNP（单核苷酸多态性）场景中，手动计算每个SNP的后验包含概率（PIP）。通过这个计算过程，你将清晰地看到先验信息、连锁不平衡（LD）矩阵和观测到的z-scores是如何结合在一起，最终量化每个变异成为因果位点的置信度的，从而揭开高级精细定位工具的“黑匣子” 。",
            "id": "4564208",
            "problem": "考虑一个包含两个单核苷酸多态性（SNPs）的位点，由 $j \\in \\{1,2\\}$ 索引。设观测到的边际 $z$-分数向量为 $z = (z_{1}, z_{2})^{\\top}$，基因型的 $2 \\times 2$ 配对连锁不平衡相关矩阵为 $R$。假设存在以下基于高斯线性模型和标准汇总统计近似的生成框架：\n\n- 在没有因果效应的零模型下，向量 $z$ 服从均值为零、协方差为 $R$ 的多元正态分布，即 $z \\sim \\mathcal{N}(0, R)$。\n- 对于任何指示所包含的因果 SNPs 索引的子集 $S \\subseteq \\{1,2\\}$，给定效应大小 $\\beta_{S}$ 时 $z$ 的条件分布满足 $z \\mid \\beta_{S} \\sim \\mathcal{N}(R_{:,S} \\beta_{S}, R)$，其中 $R_{:,S}$ 表示由 $S$ 索引的 $R$ 的列。对于包含的效应的先验在各 SNPs 之間是独立的：$\\beta_{S} \\sim \\mathcal{N}(0, \\sigma_{\\beta}^{2} I_{|S|})$，而被排除的效应则固定为零。\n- 先验包含指示变量在各 SNPs 之間是独立的，每个 SNP 的包含概率为 $p$，因此模型 $S$ 的先验概率为 $P(S) = \\prod_{j \\in S} p \\prod_{j \\notin S} (1-p)$。\n- 在模型 $S$ 下，$z$ 的边际似然是通过利用高斯共轭性对 $\\beta_{S}$ 进行积分得到的。\n\n给定以下数据和超参数：\n- $z = \\begin{pmatrix} 3.2 \\\\ 1.8 \\end{pmatrix}$，\n- $R = \\begin{pmatrix} 1  0.6 \\\\ 0.6  1 \\end{pmatrix}$，\n- 先验包含概率 $p = 0.1$，\n- 对包含的效应的先验方差 $\\sigma_{\\beta}^{2} = 0.05$。\n\n使用贝叶斯定理及上述假设，计算每个 SNP 的后验包含概率 (PIP)。PIP 定义为某个给定 SNP 被包含在因果集合中的后验概率，通过对所有包含该 SNP 的模型 $S$ 的后验模型概率求和得到。將您的最终数值答案保留四位有效数字。",
            "solution": "用户希望我基于一个贝叶斯精细定位框架，计算两个 SNP 各自的后验包含概率 (PIP)。\n\n### 步骤 1：问题验证\n\n**1.1. 提取给定信息**\n- SNP 数量：$2$，由 $j \\in \\{1,2\\}$ 索引。\n- 观测到的边际 $z$-分数向量：$z = \\begin{pmatrix} 3.2 \\\\ 1.8 \\end{pmatrix}$。\n- 连锁不平衡 (LD) 相关矩阵：$R = \\begin{pmatrix} 1  0.6 \\\\ 0.6  1 \\end{pmatrix}$。\n- 每个 SNP 的先验包含概率：$p = 0.1$。\n- 对包含的（非零）效应的先验方差：$\\sigma_{\\beta}^{2} = 0.05$。\n\n**1.2. 模型设定**\n- 因果 SNPs 的集合表示为 $S \\subseteq \\{1,2\\}$。\n- 一个模型（因果集合）$S$ 的先验概率为 $P(S) = p^{|S|} (1-p)^{2-|S|}$。\n- 给定模型 $S$ 的因果效应 $\\beta_S$ 时，$z$-分数向量的条件分布为 $z \\mid \\beta_{S} \\sim \\mathcal{N}(R_{:,S} \\beta_{S}, R)$。\n- 因果效应的先验分布为 $\\beta_{S} \\sim \\mathcal{N}(0, \\sigma_{\\beta}^{2} I_{|S|})$。\n- 边际似然 $P(z|S)$ 是通过对 $\\beta_S$ 积分得到的：$P(z|S) = \\int p(z | \\beta_S) p(\\beta_S) d\\beta_S$。\n\n**1.3. 使用提取信息进行验证**\n该问题具有科学依据，定义明确且客观。\n- **科学合理性**：所描述的模型是使用汇总统计量（z-分数）进行贝叶斯精细定位的标准公式。对 z-分数使用多元正态分布、对效应大小和模型概率使用先验，是诸如 FINEMAP 和 SuSiE 等方法的核心。所有假设都与已建立的统计遗传学原理一致。\n- **定义明确性**：该问题提供了计算所需量 (PIPs) 的所有必要数据 ($z$, $R$) 和超参数 ($p$, $\\sigma_{\\beta}^{2}$)。任务在数学上是明确定义的，并且存在唯一解。\n- **客观性**：该问题使用精确的数学和统计语言陈述，没有歧义或主观性。\n\n**1.4. 结论**\n该问题有效。\n\n### 步骤 2：求解推导\n\n目标是计算每个 SNP 的后验包含概率 (PIP)，其定义为 $PIP_j = \\sum_{S: j \\in S} P(S|z)$。我们使用贝叶斯定理来找到每个模型 $S$ 的后验概率：\n$$P(S|z) = \\frac{P(z|S)P(S)}{\\sum_{S'} P(z|S')P(S')}$$\n$P(z|S)$ 项是模型 $S$ 的边际似然。使用贝叶斯因子 (BF) 进行计算会很方便，BF 比较的是模型 $S$ 与零模型 $S_0 = \\emptyset$ 的边际似然。\n$$BF_S = \\frac{P(z|S)}{P(z|S_0)}$$\n那么，后验概率可以写成：\n$$P(S|z) = \\frac{BF_S \\cdot P(S)}{\\sum_{S'} BF_{S'} \\cdot P(S')}$$\n存在 $2^2=4$ 个可能的模型：$S_0 = \\emptyset$、$S_1 = \\{1\\}$、$S_2 = \\{2\\}$ 和 $S_{12} = \\{1,2\\}$。\n\n**2.1. 先验模型概率**\n当 $p=0.1$ 时：\n- $P(S_0) = (1-p)^2 = 0.9^2 = 0.81$\n- $P(S_1) = p(1-p) = 0.1 \\cdot 0.9 = 0.09$\n- $P(S_2) = (1-p)p = 0.9 \\cdot 0.1 = 0.09$\n- $P(S_{12}) = p^2 = 0.1^2 = 0.01$\n\n**2.2. 贝叶斯因子计算**\n边际似然 $P(z|S)$ 是通过对两个高斯分布的乘积进行积分得到的：$p(z | \\beta_S) = \\mathcal{N}(z; R_{:,S} \\beta_S, R)$ 和 $p(\\beta_S) = \\mathcal{N}(\\beta_S; 0, \\sigma_{\\beta}^2 I_{|S|})$。其结果是在模型 $S$ 下 $z$ 的一个多元正态分布：\n$$z \\mid S \\sim \\mathcal{N}(0, V_S) \\quad \\text{其中} \\quad V_S = R + \\sigma_{\\beta}^2 R_{:,S} R_{S,:}$$\n对数边际似然为 $\\log P(z|S) = -\\frac{d}{2}\\log(2\\pi) - \\frac{1}{2}\\log(\\det(V_S)) - \\frac{1}{2}z^T V_S^{-1} z$，其中 $d=2$ 是 $z$ 的维度。\n模型 $S$ 相对于零模型 $S_0$（其中 $V_{S_0}=R$）的对数贝叶斯因子为：\n$$\\log(BF_S) = \\log P(z|S) - \\log P(z|S_0) = \\frac{1}{2}\\left[ \\log\\left(\\frac{\\det(R)}{\\det(V_S)}\\right) - z^T(V_S^{-1} - R^{-1})z \\right]$$\n我们将为每个模型计算此值。\n给定数据：$z = \\begin{pmatrix} 3.2 \\\\ 1.8 \\end{pmatrix}$，$R = \\begin{pmatrix} 1  0.6 \\\\ 0.6  1 \\end{pmatrix}$，$\\sigma_{\\beta}^2=0.05$。\n$\\det(R) = 1 \\cdot 1 - 0.6^2 = 0.64$。\n$R^{-1} = \\frac{1}{0.64} \\begin{pmatrix} 1  -0.6 \\\\ -0.6  1 \\end{pmatrix} = \\begin{pmatrix} 1.5625  -0.9375 \\\\ -0.9375  1.5625 \\end{pmatrix}$。\n\n- **模型 $S_0 = \\emptyset$**：根据定义，$BF_{S_0} = 1$，因此 $\\log(BF_{S_0}) = 0$。\n\n- **模型 $S_1 = \\{1\\}$**：\n对于任何 2x2 相关矩阵，我们有 $\\log(BF_{S_j}) = -\\frac{1}{2}\\log(1+\\sigma_\\beta^2) + \\frac{1}{2} z_j^2 \\frac{\\sigma_\\beta^2}{1+\\sigma_\\beta^2}$。\n对于 $S_1 = \\{1\\}$，我们有 $z_1 = 3.2$：\n$\\log(BF_{S_1}) = -\\frac{1}{2}\\log(1+0.05) + \\frac{1}{2} (3.2)^2 \\frac{0.05}{1+0.05} = -\\frac{1}{2}\\log(1.05) + \\frac{1}{2} (10.24) \\frac{0.05}{1.05}$\n$\\log(BF_{S_1}) \\approx -0.5 \\cdot 0.048790 + 0.5 \\cdot 10.24 \\cdot 0.047619 \\approx 0.2194145$\n$BF_{S_1} = \\exp(0.2194145) \\approx 1.24535$\n\n- **模型 $S_2 = \\{2\\}$**：\n对 $j=2$ 使用相同的公式，其中 $z_2=1.8$：\n$\\log(BF_{S_2}) = -\\frac{1}{2}\\log(1.05) + \\frac{1}{2} (1.8)^2 \\frac{0.05}{1.05} = -\\frac{1}{2}\\log(1.05) + \\frac{1}{2} (3.24) \\frac{0.05}{1.05}$\n$\\log(BF_{S_2}) \\approx -0.024395 + 0.5 \\cdot 3.24 \\cdot 0.047619 \\approx 0.052748$\n$BF_{S_2} = \\exp(0.052748) \\approx 1.05417$\n\n- **模型 $S_{12} = \\{1,2\\}$**：\n$V_{S_{12}} = R + \\sigma_{\\beta}^2 R_{:,S_{12}} R_{S_{12},:} = R + \\sigma_\\beta^2 R I_2 R^T = R + \\sigma_\\beta^2 R^2$。\n$V_{S_{12}} = R + 0.05 \\begin{pmatrix} 1.36  1.2 \\\\ 1.2  1.36 \\end{pmatrix} = \\begin{pmatrix} 1+0.05 \\cdot 1.36  0.6+0.05 \\cdot 1.2 \\\\ 0.6+0.05 \\cdot 1.2  1+0.05 \\cdot 1.36 \\end{pmatrix} = \\begin{pmatrix} 1.068  0.66 \\\\ 0.66  1.068 \\end{pmatrix}$。\n$\\det(V_{S_{12}}) = 1.068^2 - 0.66^2 = 1.140624 - 0.4356 = 0.705024$。\n$\\log\\left(\\frac{\\det(R)}{\\det(V_{S_{12}})}\\right) = \\log\\left(\\frac{0.64}{0.705024}\\right) \\approx -0.09848$。\n$V_{S_{12}}^{-1} = \\frac{1}{0.705024}\\begin{pmatrix} 1.068  -0.66 \\\\ -0.66  1.068 \\end{pmatrix}$。\n$z^T(R^{-1} - V_{S_{12}}^{-1})z \\approx 0.626228$。\n$\\log(BF_{S_{12}}) = \\frac{1}{2}(\\log\\left(\\frac{\\det(R)}{\\det(V_{S_{12}})}\\right) + z^T(R^{-1} - V_{S_{12}}^{-1})z) \\approx \\frac{1}{2}(-0.09848 + 0.626228) \\approx 0.263874$。\n$BF_{S_{12}} = \\exp(0.263874) \\approx 1.30193$。\n\n**2.3. 后验模型概率**\n我们计算未归一化的后验权重 $w_S = BF_S \\cdot P(S)$：\n- $w_{S_0} = 1 \\cdot 0.81 = 0.81$\n- $w_{S_1} = 1.24535 \\cdot 0.09 = 0.1120815$\n- $w_{S_2} = 1.05417 \\cdot 0.09 = 0.0948753$\n- $w_{S_{12}} = 1.30193 \\cdot 0.01 = 0.0130193$\n\n归一化常数为 $C = \\sum_S w_S = 0.81 + 0.1120815 + 0.0948753 + 0.0130193 = 1.0299761$。\n后验概率为 $P(S|z) = w_S/C$：\n- $P(S_0|z) = 0.81 / 1.0299761 \\approx 0.786426$\n- $P(S_1|z) = 0.1120815 / 1.0299761 \\approx 0.108819$\n- $P(S_2|z) = 0.0948753 / 1.0299761 \\approx 0.092114$\n- $P(S_{12}|z) = 0.0130193 / 1.0299761 \\approx 0.012640$\n\n**2.4. 后验包含概率 (PIPs)**\n一个 SNP 的 PIP 是所有包含该 SNP 的模型的后验概率之和。\n- $PIP_1 = P(S_1|z) + P(S_{12}|z) \\approx 0.108819 + 0.012640 = 0.121459$\n- $PIP_2 = P(S_2|z) + P(S_{12}|z) \\approx 0.092114 + 0.012640 = 0.104754$\n\n保留四位有效数字：\n- $PIP_1 \\approx 0.1215$\n- $PIP_2 \\approx 0.1048$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.1215  0.1048\n\\end{pmatrix}\n}\n$$"
        }
    ]
}