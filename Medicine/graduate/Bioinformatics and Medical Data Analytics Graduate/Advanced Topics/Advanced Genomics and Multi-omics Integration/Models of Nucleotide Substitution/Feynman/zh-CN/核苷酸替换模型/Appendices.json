{
    "hands_on_practices": [
        {
            "introduction": "理论的基石是严格的数学推导。本练习将引导您从核苷酸替换模型最基本的组成部分——瞬时速率矩阵 $Q$ 出发，一步步推导出经典的Jukes-Cantor (JC69)距离校正公式。通过这个实践，您将深刻理解如何从一个描述演化过程的微分方程，得到一个联系着不可观测的演化距离 $d$ 与可观测的序列差异比例 $p$ 的关键方程，这构成了后续更复杂模型分析的基础。",
            "id": "2407121",
            "problem": "一个在核苷酸字母表 $\\{A, C, G, T\\}$ 上的连续时间马尔可夫链（CTMC）根据 Jukes–Cantor (JC) 模型演化。JC 瞬时速率矩阵 $Q_{JC}$ 定义为：当 $i \\neq j$ 时 $Q_{ij} = \\alpha$，以及 $Q_{ii} = -3\\alpha$，其中 $\\alpha > 0$ 是一个常数，且 $i,j \\in \\{A, C, G, T\\}$。令 $P(t) = \\exp(Q_{JC} t)$ 表示在时间 $t \\ge 0$ 时的转移概率矩阵。假设该过程是平稳的，具有均匀平稳分布 $\\pi_i = \\frac{1}{4}$（对所有 $i$）。\n\n考虑两个同源 DNA 序列，它们在一个总流逝时间为 $\\tau > 0$ 的路径上（即，分隔这两个序列的分支时长之和为 $\\tau$），根据 JC 模型从一个共同祖先演化而来。令 $p$ 表示在此模型下，两个序列在同源位点上核苷酸差异的期望汉明分数。定义 Jukes–Cantor 演化距离 $d$ 为连接两个序列的路径上每个位点的期望替换数。在 JC 模型下，平稳状态下每个位点的平均瞬时替换率为 $\\mu = \\sum_{i} \\pi_i \\left(-Q_{ii}\\right)$，因此 $d = \\mu \\,\\tau$。\n\n从上述定义和速率矩阵 $Q_{JC}$ 出发，推导出一个仅以 $p$ 为函数的 $d$ 的闭式表达式，消去 $\\alpha$ 和 $\\tau$。将您的最终结果表示为仅含 $p$ 的单个解析表达式。不需要单位。",
            "solution": "问题陈述需经过验证。\n\n**步骤 1：提取已知条件**\n- **模型**：一个在核苷酸字母表 $\\{A, C, G, T\\}$ 上的连续时间马尔可夫链（CTMC）。\n- **模型名称**：Jukes–Cantor (JC)。\n- **瞬时速率矩阵 ($Q_{JC}$)**：当 $i \\neq j$ 时 $Q_{ij} = \\alpha$，以及 $Q_{ii} = -3\\alpha$，其中 $\\alpha > 0$。\n- **转移概率矩阵 ($P(t)$)**：$P(t) = \\exp(Q_{JC} t)$，时间 $t \\ge 0$。\n- **平稳分布 ($\\pi$)**：均匀分布，$\\pi_i = \\frac{1}{4}$，对所有 $i \\in \\{A, C, G, T\\}$。\n- **演化情景**：两个同源序列从一个共同祖先演化而来。\n- **总流逝时间**：$\\tau > 0$，分隔两个序列的分支时长之和。\n- **观测差异 ($p$)**：两个序列之间核苷酸差异的期望汉明分数。\n- **演化距离 ($d$)**：每个位点的期望替换数，定义为 $d = \\mu \\tau$。\n- **平均替换率 ($\\mu$)**：定义为 $\\mu = \\sum_{i} \\pi_i (-Q_{ii})$。\n- **目标**：推导 $d$ 作为 $p$ 的函数的闭式表达式。\n\n**步骤 2：使用提取的已知条件进行验证**\n- **科学依据**：该问题具有科学依据。Jukes-Cantor 模型是分子演化和系统发育学中一个基础且广泛使用的模型。所有给出的定义在该领域内都是标准且正确的。\n- **适定性**：该问题是适定的。它要求根据问题陈述中列出的第一性原理推导一个特定的标准公式（$d$ 作为 $p$ 的函数）。所给的设定足以确定一个唯一的解析解。\n- **客观性**：该问题以精确、客观的数学语言陈述，没有歧义或主观内容。\n\n**步骤 3：结论与行动**\n问题有效。将推导一个完整的解。\n\n目标是推导演化距离 $d$ 关于观测到的差异位点比例 $p$ 的表达式。这需要建立这些量与 JC 模型的基本参数（即替换率参数 $\\alpha$ 和总时间 $\\tau$）之间的关系。\n\n首先，我们确定每个位点的平均替换率 $\\mu$。根据定义，$\\mu = \\sum_{i} \\pi_i (-Q_{ii})$。\n问题给出了所有 4 种核苷酸状态 $i \\in \\{A,C,G,T\\}$ 的平稳分布 $\\pi_i = \\frac{1}{4}$。\n速率矩阵的对角元素给出为 $Q_{ii} = -3\\alpha$。\n因此，速率 $\\mu$ 为：\n$$ \\mu = \\sum_{i \\in \\{A,C,G,T\\}} \\left(\\frac{1}{4}\\right) (-(-3\\alpha)) = 4 \\times \\frac{3\\alpha}{4} = 3\\alpha $$\n演化距离 $d$，定义为每个位点的期望替换数，由 $d = \\mu \\tau$ 给出。代入 $\\mu$ 的表达式，我们得到：\n$$ d = 3\\alpha\\tau $$\n\n接下来，我们必须找到 $p$（核苷酸差异的期望分数）的表达式。对于像 JC 这样的时间可逆马尔可夫模型，观察到两个相隔总分支长度为 $\\tau$ 的序列之间存在差异的概率，等同于单个序列在时间间隔 $\\tau$ 内改变其状态的概率。我们假设过程从平衡状态开始，即初始核苷酸从平稳分布 $\\pi$ 中抽取。那么，差异的概率是在时间 $\\tau$ 后，从任意状态 $i$ 开始并结束于任意其他状态 $j \\neq i$ 的概率。\n$$ p = \\sum_{i} \\pi_i \\left( \\sum_{j \\neq i} P_{ij}(\\tau) \\right) $$\n由于 JC 模型的对称性，从状态 $i$ 变为任何其他状态的概率与起始状态 $i$ 无关。也就是说，对所有 $i$，$\\sum_{j \\neq i} P_{ij}(\\tau)$ 的值是相同的。由于 $\\sum_i \\pi_i = 1$， $p$ 的表达式简化为：\n$$ p = \\sum_{j \\neq i} P_{ij}(\\tau) = 1 - P_{ii}(\\tau) $$\n对于任意选择的状态 $i$。\n\n我们现在必须确定转移概率 $P_{ii}(\\tau)$。转移矩阵 $P(t)$ 是主方程 $\\frac{d P(t)}{dt} = P(t) Q_{JC}$ 在初始条件 $P(0) = I$（单位矩阵）下的解。求解概率向量会更简单。令 $p_k(t)$ 为在时间 $t$ 处于状态 $k$ 的概率。考虑一个在 $t=0$ 时从状态 $i$ 开始的序列。保持在状态 $i$ 的概率变化由以下微分方程描述：\n$$ \\frac{dp_i(t)}{dt} = \\sum_{k} p_k(t) Q_{ki} $$\n使用 JC 矩阵的具体条目，以及 $p_i(0)=1$ 和当 $j \\neq i$ 时 $p_j(0)=0$：\n$$ \\frac{dp_i(t)}{dt} = p_i(t) Q_{ii} + \\sum_{j \\neq i} p_j(t) Q_{ji} = p_i(t)(-3\\alpha) + \\sum_{j \\neq i} p_j(t) \\alpha $$\n由于概率之和必须为 1，所以 $\\sum_{j \\neq i} p_j(t) = 1 - p_i(t)$。将此代入方程中得到：\n$$ \\frac{dp_i(t)}{dt} = -3\\alpha p_i(t) + \\alpha(1 - p_i(t)) = \\alpha - 4\\alpha p_i(t) $$\n这是一个一阶线性常微分方程。我们可以使用积分因子法或分离变量法来求解。让我们重新整理以找到解：\n$$ \\frac{dp_i}{dt} + 4\\alpha p_i = \\alpha $$\n通解是齐次解 $C \\exp(-4\\alpha t)$ 和一个特解的和。对于特解，我们尝试一个常数 $p_i = K$，得到 $4\\alpha K = \\alpha$，所以 $K = \\frac{1}{4}$。\n通解为 $p_i(t) = \\frac{1}{4} + C \\exp(-4\\alpha t)$。\n我们应用初始条件 $p_i(0) = 1$：\n$$ 1 = \\frac{1}{4} + C \\exp(0) \\implies C = \\frac{3}{4} $$\n因此，在时间 $t$ 后保持在同一状态的概率是：\n$$ P_{ii}(t) = p_i(t) = \\frac{1}{4} + \\frac{3}{4} \\exp(-4\\alpha t) $$\n现在我们可以通过代入 $t=\\tau$ 来计算 $p$：\n$$ p = 1 - P_{ii}(\\tau) = 1 - \\left( \\frac{1}{4} + \\frac{3}{4} \\exp(-4\\alpha \\tau) \\right) = \\frac{3}{4} - \\frac{3}{4} \\exp(-4\\alpha \\tau) $$\n$$ p = \\frac{3}{4} \\left( 1 - \\exp(-4\\alpha \\tau) \\right) $$\n\n我们已经建立了两个关系：\n1. $d = 3\\alpha \\tau$\n2. $p = \\frac{3}{4} (1 - \\exp(-4\\alpha \\tau))$\n\n我们的目标是把 $d$ 表示为 $p$ 的函数。从方程（1）我们有 $\\alpha \\tau = \\frac{d}{3}$。我们可以将此代入方程（2）：\n$$ p = \\frac{3}{4} \\left( 1 - \\exp\\left(-4 \\left(\\frac{d}{3}\\right)\\right) \\right) = \\frac{3}{4} \\left( 1 - \\exp\\left(-\\frac{4d}{3}\\right) \\right) $$\n现在，我们必须反转这个表达式来求解 $d$。\n$$ \\frac{4p}{3} = 1 - \\exp\\left(-\\frac{4d}{3}\\right) $$\n$$ \\exp\\left(-\\frac{4d}{3}\\right) = 1 - \\frac{4p}{3} $$\n取两边的自然对数：\n$$ -\\frac{4d}{3} = \\ln\\left(1 - \\frac{4p}{3}\\right) $$\n最后，解出 $d$：\n$$ d = -\\frac{3}{4} \\ln\\left(1 - \\frac{4p}{3}\\right) $$\n这就是 Jukes-Cantor 距离公式，它校正了观测到的差异比例 $p$，以估计每个位点实际发生的替换数。注意，对数的参数要求 $1 - \\frac{4p}{3} > 0$，这意味着 $p  \\frac{3}{4}$。这是符合预期的，因为在无限时间（$\\tau \\to \\infty$）时，一个位点上任何核苷酸的概率都变为 $\\frac{1}{4}$，因此不匹配的概率 $p$ 接近 $\\frac{3}{4}$。",
            "answer": "$$\n\\boxed{-\\frac{3}{4} \\ln\\left(1 - \\frac{4p}{3}\\right)}\n$$"
        },
        {
            "introduction": "任何模型都有其适用边界，理解这些边界与理解模型本身同样重要。本练习通过一个看似极端的思想实验，探讨了当序列差异达到JC69模型的饱和极限时会发生什么 。通过计算并解释为何估计的演化距离趋于无穷，您将亲自揭示“多重替换”如何掩盖真实的演化历史，并理解为何对于高度分化的序列，系统发育信号会丢失，从而深化对距离校正方法内在局限性的认识。",
            "id": "2407141",
            "problem": "给定两条长度为100的同源DNA序列，无空位比对，观测到的汉明距离为75个位点（即观测差异比例为 $\\hat{p} = 0.75$）。假设核苷酸替换遵循 Jukes–Cantor 1969 (JC69) 模型，该模型假定所有核苷酸对之间具有相等的稳态碱基频率和相等的瞬时替换率，并且所有位点独立同分布地演化。使用标准的JC69校正方法，从观测差异比例中估计演化距离（以每个位点的期望替换数表示），以下哪个陈述最好地解释了为什么估计的JC69距离是无限的，以及这对序列的系统发育关系意味着什么？\n\nA. JC69校正距离是无限的，因为 $\\hat{p} = 0.75$ 等于JC69的饱和极限，因此为产生如此大的观测分歧，推断出的每个位点的替换数必须是无界的；这意味着序列已有效饱和（接近随机化），成对比较几乎不能为其关系提供可靠的系统发育信号。\n\nB. JC69校正距离是未定义的，因为该模型不允许差异比例超过 $0.50$；这意味着序列并非同源，不能用于系统发育推断。\n\nC. JC69校正距离是有限的（大约每个位点1.5次替换），这意味着序列是远缘关系，但它们的关系仍然可以通过成对距离可靠地解析。\n\nD. JC69校正距离是无限的，因为不相等的碱基频率迫使分歧估计值发散；这意味着使用通用时间可逆（GTR）模型将产生一个小的有限距离，因此序列是近缘关系。",
            "solution": "该问题陈述已经过验证，被认为是科学上有效且定义良好的。它展示了分子演化中使用Jukes-Cantor模型的一个标准、可计算的场景，提供了所有必要信息，没有内部矛盾或科学缺陷。\n\nJukes-Cantor 1969 (JC69) 模型是一种核苷酸替换模型，它假设碱基频率相等（即 $\\pi_A = \\pi_C = \\pi_G = \\pi_T = 1/4$），并且任何一对不同核苷酸之间的替换率相等。\n\n在此模型下，对于两条已经分化了对应于演化距离 $d$ 的时间的序列，在单个核苷酸位点上观测到差异的概率 $p$ 由以下公式给出：\n$$ p(d) = \\frac{3}{4} \\left( 1 - e^{-\\frac{4}{3}d} \\right) $$\n在这里，距离 $d$ 定义为自从两条谱系从共同祖先分化以来，每个位点上发生的期望替换数。\n\n题目给出了基于长度为100的序列中75个位点的汉明距离得出的观测差异比例 $\\hat{p} = 0.75$。为了估计演化距离 $\\hat{d}$，我们必须反转JC69公式，将观测比例 $\\hat{p}$ 视为真实概率 $p$ 的估计值：\n$$ \\hat{d} = -\\frac{3}{4} \\ln \\left( 1 - \\frac{4}{3}\\hat{p} \\right) $$\n这就是JC69距离校正公式。\n\n我们将给定值 $\\hat{p} = 0.75$ 代入此方程：\n$$ \\hat{d} = -\\frac{3}{4} \\ln \\left( 1 - \\frac{4}{3} \\times 0.75 \\right) $$\n注意到 $0.75$ 等于 $3/4$：\n$$ \\hat{d} = -\\frac{3}{4} \\ln \\left( 1 - \\frac{4}{3} \\times \\frac{3}{4} \\right) $$\n$$ \\hat{d} = -\\frac{3}{4} \\ln (1 - 1) $$\n$$ \\hat{d} = -\\frac{3}{4} \\ln(0) $$\n自然对数函数 $\\ln(x)$ 在其自变量 $x$ 从正方向趋近于0时，函数值趋近于 $-\\infty$。因此，估计的距离 $\\hat{d}$ 为：\n$$ \\hat{d} \\to -\\frac{3}{4} \\times (-\\infty) \\to +\\infty $$\n估计的JC69距离是无限的。\n\n这个结果的产生是因为随着真实距离 $d$ 的增加，可观测差异的比例 $p$ 接近一个饱和极限。取 $p(d)$ 在 $d \\to \\infty$ 时的极限：\n$$ \\lim_{d \\to \\infty} p(d) = \\lim_{d \\to \\infty} \\frac{3}{4} \\left( 1 - e^{-\\frac{4}{3}d} \\right) $$\n当 $d \\to \\infty$ 时，项 $e^{-\\frac{4}{3}d} \\to 0$。因此：\n$$ \\lim_{d \\to \\infty} p(d) = \\frac{3}{4} (1 - 0) = \\frac{3}{4} = 0.75 $$\n在JC69模型下，可以观测到的最大可能差异比例是 $0.75$。这就是饱和极限。此时，序列已经分化得如此之多，以至于对于任何给定位点，一个序列中的核苷酸相对于另一个序列是随机的，有 $1/4$ 的概率相同，有 $3/4$ 的概率不同。当观测到的差异比例 $\\hat{p}$ 达到这个理论最大值时，模型会推断必须发生无限次的替换才能达到这种随机化状态。\n\n从系统发育的角度来看，这意味着序列已经被替换所饱和。同一位点发生了多次替换，掩盖了真实的演化历史。观测到的距离不再反映真实的距离，任何可用于可靠推断两条序列之间关系的系统发育信号都已被抹去。这些序列分化得如此之大，以至于它们彼此之间显得是随机的。\n\n现在，我们评估所提供的选项：\n\nA. JC69校正距离是无限的，因为 $\\hat{p} = 0.75$ 等于JC69的饱和极限，因此为产生如此大的观测分歧，推断出的每个位点的替换数必须是无界的；这意味着序列已有效饱和（接近随机化），成对比较几乎不能为其关系提供可靠的系统发育信号。\n这一陈述与我们的推导完全一致。它正确地指出 $\\hat{p} = 0.75$ 是饱和极限，正确地得出距离是无限的结论，并准确地描述了饱和的含义，即可靠系统发育信号的丢失。\n**结论：正确。**\n\nB. JC69校正距离是未定义的，因为该模型不允许差异比例超过 $0.50$；这意味着序列并非同源，不能用于系统发育推断。\n这个陈述是错误的。JC69的饱和极限是 $0.75$，而不是 $0.50$。距离不是“未定义的”，而是无限的，这是一个定义良好的数学极限。此外，高度分歧（饱和）并不能否定同源性；问题明确说明了序列是同源的。\n**结论：错误。**\n\nC. JC69校正距离是有限的（大约每个位点1.5次替换），这意味着序列是远缘关系，但它们的关系仍然可以通过成对距离可靠地解析。\n这个陈述是错误的。根据计算，距离是无限的，而不是有限的。一个有限的距离 $\\hat{d} = 1.5$ 将对应于一个观测差异比例 $p = \\frac{3}{4} (1 - e^{-4/3 \\times 1.5}) = \\frac{3}{4} (1 - e^{-2}) \\approx 0.75 \\times (1 - 0.1353) \\approx 0.6485$，这不等于 $0.75$。\n**结论：错误。**\n\nD. JC69校正距离是无限的，因为不相等的碱基频率迫使分歧估计值发散；这意味着使用通用时间可逆（GTR）模型将产生一个小的有限距离，因此序列是近缘关系。\n这个陈述因多个原因而错误。首先，JC69模型假设碱基频率*相等*，所以前提是错误的。无限距离是模型达到其饱和极限的一个特征，而不是违反其假设的结果。其次，无法保证更复杂的GTR模型会得出一个小的有限距离；如果序列确实分歧很大，GTR模型同样会估计出一个非常大的距离。得出它们是“近缘关系”的结论与极端分歧的证据相悖。\n**结论：错误。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "从理论到实践的飞跃是掌握一个科学模型的最后一步。本练习将挑战您将一个更复杂且应用广泛的模型——Hasegawa-Kishino-Yano (HKY85)模型——转化为实际的计算机代码 。您需要根据给定的参数构建速率矩阵 $Q$，对其进行标准化，并通过谱分解等高级数值方法计算转移概率矩阵 $P(t)$。这项综合性实践不仅能巩固您对可逆模型、特征结构和矩阵指数的理解，还能让您体验开发系统发育分析工具的核心计算过程。",
            "id": "4585593",
            "problem": "考虑一个关于四种脱氧核糖核酸 (DNA) 核苷酸（腺嘌呤、胞嘧啶、鸟嘌呤、胸腺嘧啶）的时间齐次连续时间马尔可夫链 (CTMC)，其状态空间大小为 $4$，无穷小生成元（速率）矩阵为 $Q \\in \\mathbb{R}^{4 \\times 4}$。在 Hasegawa-Kishino-Yano $1985$ (HKY85) 核苷酸替换模型中，从状态 $i$到状态 $j$ 的瞬时替换速率由平衡碱基频率以及转换或颠换偏倚决定。令 $\\pi = (\\pi_A,\\pi_C,\\pi_G,\\pi_T)$ 表示平稳碱基频率，其中 $\\pi_i  0$ 且 $\\sum_{i} \\pi_i = 1$；令 $\\kappa  0$ 为转换与颠换的速率比。定义转换集合为配对 $\\{A,G\\}$ 和 $\\{C,T\\}$；所有其他配对均为颠换。$Q$ 的非对角线元素满足 $Q_{ij} = s_{ij} \\pi_j$（$i \\neq j$），其中如果 $(i,j)$ 是一个转换对，则 $s_{ij} = \\kappa$，否则 $s_{ij} = 1$。对角线元素由行和为零的要求确定，即 $Q_{ii} = -\\sum_{j \\neq i} Q_{ij}$。期望瞬时替换速率定义为 $\\mu = \\sum_{i} \\pi_i (-Q_{ii})$，矩阵 $Q$ 必须经过缩放以使 $\\mu = 1$。\n\n时间 $t$ 时的转移概率矩阵，记为 $P(t) \\in \\mathbb{R}^{4 \\times 4}$，由矩阵指数 $P(t) = \\exp(Q t)$ 定义。按上述方式构建的 HKY85 生成元关于 $\\pi$ 是可逆的，即它满足细致平衡条件 $\\pi_i Q_{ij} = \\pi_j Q_{ji}$。\n\n你的任务是实现一个程序，对下面提供的每个测试用例，执行以下基于第一性原理的步骤：\n\n- 使用给定的 $\\pi$ 和 $\\kappa$ 构建 HKY85 生成元矩阵 $Q$，强制执行行和为零的约束 $Q \\mathbf{1} = \\mathbf{0}$，并缩放 $Q$ 以使期望速率 $\\mu = 1$。\n- 通过两种独立的方法计算 $P(t)$：\n  1. 利用可逆性的谱分解路径：利用 $Q$ 在相似变换 $H = S Q S^{-1}$（其中 $S = \\mathrm{diag}(\\sqrt{\\pi_A},\\sqrt{\\pi_C},\\sqrt{\\pi_G},\\sqrt{\\pi_T})$）下与对称矩阵 $H$ 相似这一事实，然后使用 $H$ 的标准正交特征分解来获得 $P(t)$。\n  2. 使用稳定的矩阵指数算法的直接数值路径来获得 $P(t)$。\n- 对每个测试用例，使用通过谱分解路径获得的 $P(t)$（除非另有说明）量化和汇总以下四个诊断指标：\n  1. 谱方法和数值方法得到的 $P(t)$ 之间的弗罗贝尼乌斯范数差异，即 $\\lVert P_{\\mathrm{spec}}(t) - P_{\\mathrm{num}}(t) \\rVert_F$。\n  2. 各行随机性的最大违反度，即 $\\max_{i} \\left| \\sum_{j} P_{ij}(t) - 1 \\right|$。\n  3. 在 $\\pi$ 的左作用下平稳性的违反度，即使用欧几里得范数计算的 $\\lVert \\pi P(t) - \\pi \\rVert_2$。\n  4. 行与平稳分布的最大偏差，即 $\\max_{i} \\lVert P_{i\\cdot}(t) - \\pi \\rVert_2$，其中 $P_{i\\cdot}(t)$ 表示 $P(t)$ 的第 $i$ 行。\n\n在你的算法设计和随后的解释中，从概念上说明碱基频率 $\\pi$ 如何决定对称化算子的特征结构以及平稳特征向量。\n\n使用以下测试套件，碱基顺序固定为 $(A,C,G,T)$：\n\n- 测试用例 1（平衡频率，边界时间）：$\\pi = (0.25, 0.25, 0.25, 0.25)$，$\\kappa = 1.0$，$t = 0.0$。\n- 测试用例 2（平衡频率，中度偏倚）：$\\pi = (0.25, 0.25, 0.25, 0.25)$，$\\kappa = 2.0$，$t = 0.5$。\n- 测试用例 3（中度偏斜，较强偏倚，较长时间）：$\\pi = (0.35, 0.15, 0.35, 0.15)$，$\\kappa = 3.0$，$t = 2.0$。\n- 测试用例 4（强度偏斜，极端偏倚，长时间）：$\\pi = (0.70, 0.10, 0.15, 0.05)$，$\\kappa = 10.0$，$t = 5.0$。\n- 测试用例 5（偏斜，极小时间）：$\\pi = (0.40, 0.10, 0.40, 0.10)$，$\\kappa = 20.0$，$t = 10^{-8}$。\n\n本问题中所有量均为无量纲，不适用任何物理单位。\n\n你的程序应生成单行输出，其中包含五个测试用例的串联诊断指标（按顺序排列），每个测试用例贡献一个包含四个浮点数的列表，排列格式为 $[\\lVert P_{\\mathrm{spec}} - P_{\\mathrm{num}} \\rVert_F, \\max \\text{ 行和偏差}, \\lVert \\pi P - \\pi \\rVert_2, \\max \\text{ 与 } \\pi \\text{ 的行偏差}]$。将所有 5 个用例的结果聚合到一个扁平列表中，以逗号分隔的序列形式打印，并用方括号括起来，例如 $[d_{1,1},d_{1,2},d_{1,3},d_{1,4},d_{2,1},\\dots,d_{5,4}]$。输出必须是你的程序计算出的实数，且不得需要任何外部输入。",
            "solution": "所提供的问题是有效的，因为它在科学上基于成熟的 HKY85 核苷酸替换模型，数学上是适定的（提供了所有必要数据），并且使用客观明确的语言进行表述。该任务是分子进化领域一个标准的计算问题，需要应用线性代数和连续时间马尔可夫链理论。\n\n### 算法设计与基本原理\n\n对每个测试用例，解决方案分四个主要阶段进行：构建 HKY85 生成元矩阵 $Q$、通过两种独立方法计算转移概率矩阵 $P(t)$，以及最后计算一组诊断指标。\n\n#### 1. 生成元矩阵 $Q$ 的构建与缩放\n\nHKY85 模型是一个关于四个核苷酸 $\\{A, C, G, T\\}$ 状态空间的连续时间马尔可夫链 (CTMC)，我们将其索引为 $\\{0, 1, 2, 3\\}$。该过程的动力学由无穷小生成元矩阵 $Q \\in \\mathbb{R}^{4 \\times 4}$ 控制。\n\n非对角线元素 $Q_{ij}$（$i \\neq j$）表示从核苷酸 $i$ 到核苷酸 $j$ 的瞬时替换速率。在 HKY85 模型中，该速率定义为 $Q_{ij} = s_{ij} \\pi_j$。其中，$\\pi = (\\pi_A, \\pi_C, \\pi_G, \\pi_T)$ 是平稳（或平衡）碱基频率向量，$s_{ij}$ 是一个速率乘数，取决于替换是转换还是颠换。\n\n-   **转换 (transition)** 是指嘌呤之间 ($A \\leftrightarrow G$) 或嘧啶之间 ($C \\leftrightarrow T$) 的替换。对于这些配对，$s_{ij} = \\kappa$，其中 $\\kappa  0$ 是转换与颠换的速率比。\n-   **颠换 (transversion)** 是指嘌呤和嘧啶之间的替换。对于这些配对，$s_{ij} = 1$。\n\n碱基顺序固定为 $(A, C, G, T)$。非对角线元素的速率乘数矩阵 $S_m$（其中 $i,j \\in \\{0, 1, 2, 3\\}$）为：\n$$\nS_m = \\begin{pmatrix}\n-  1  \\kappa  1 \\\\\n1  -  1  \\kappa \\\\\n\\kappa  1  -  1 \\\\\n1  \\kappa  1  -\n\\end{pmatrix}\n$$\n$Q$ 的对角线元素由生成元矩阵每行之和必须为零的性质确定：$Q_{ii} = -\\sum_{j \\neq i} Q_{ij}$。这确保了概率守恒。\n\n设这个初始构建的矩阵为 $Q'$。问题要求对 $Q$ 进行缩放，使得单位时间内每个位点的期望替换数 $\\mu$ 等于 $1$。该期望速率定义为从每个状态离开的速率的平均值，按其平稳频率加权：$\\mu = -\\sum_{i} \\pi_i Q_{ii}$。我们首先为未缩放的矩阵计算此速率，$\\mu' = -\\sum_{i} \\pi_i Q'_{ii}$，然后将最终缩放后的生成元定义为 $Q = Q' / \\mu'$。这种归一化使得分支长度 $t$ 可以解释为每个位点的期望替换数。\n\n#### 2. 转移概率矩阵 $P(t)$ 的计算\n\n矩阵 $P(t)$（其中 $P_{ij}(t)$ 是在时刻 $0$ 处于状态 $i$ 的条件下，在时刻 $t$ 处于状态 $j$ 的概率）由矩阵指数给出：\n$$\nP(t) = \\exp(Q t)\n$$\n我们使用两种不同的方法计算该矩阵，以交叉验证结果。\n\n**方法一：谱分解**\n\nHKY85 模型被设计成关于 $\\pi$ 是**时间可逆**的，满足细致平衡条件 $\\pi_i Q_{ij} = \\pi_j Q_{ji}$。此性质意味着 $Q$ 与一个对称矩阵相似，从而可以进行稳定而优美的特征分解。令 $S = \\mathrm{diag}(\\sqrt{\\pi_0}, \\sqrt{\\pi_1}, \\sqrt{\\pi_2}, \\sqrt{\\pi_3})$。相似变换由 $H = S Q S^{-1}$ 给出。这个对称化矩阵 $H$ 的元素为：\n$$\nH_{ij} = \\sqrt{\\frac{\\pi_i}{\\pi_j}} Q_{ij} = \\sqrt{\\frac{\\pi_i}{\\pi_j}} (s_{ij} \\pi_j) = s_{ij} \\sqrt{\\pi_i \\pi_j}\n$$\n由于 $s_{ij} = s_{ji}$，很明显 $H_{ij} = H_{ji}$，因此 $H$ 是一个对称矩阵。\n\n对称矩阵拥有一套完备的标准正交特征向量和实特征值。因此，我们可以将其特征分解写为 $H = U \\Lambda U^T$，其中 $U$ 是一个正交矩阵，其列是 $H$ 的特征向量，$\\Lambda = \\mathrm{diag}(\\lambda_0, \\lambda_1, \\lambda_2, \\lambda_3)$ 是相应特征值组成的对角矩阵。\n\n从 $Q = S^{-1} H S$，我们推导出 $P(t)$ 的表达式：\n$$\nP(t) = \\exp(Q t) = \\exp((S^{-1} H S)t) = S^{-1} \\exp(H t) S = S^{-1} (U \\exp(\\Lambda t) U^T) S\n$$\n矩阵 $\\exp(\\Lambda t)$ 只是一个对角矩阵，其元素为 $e^{\\lambda_i t}$。这提供了一种计算 $P(t)$ 的数值稳定且解析上强大的方法。\n\n这种谱方法阐明了平稳频率 $\\pi$ 的核心作用。首先，对称化算子 $H$ 的特征结构（特征值 $\\lambda_i$ 和 $U$ 中的特征向量）由其元素 $s_{ij}\\sqrt{\\pi_i \\pi_j}$ 直接决定，而这些元素是 $\\pi$ 的函数。其次，可逆性意味着 $\\pi$ 是该过程的平稳分布。这意味着 $\\pi$ 是 $Q$ 对应于特征值 $\\lambda=0$ 的左特征向量，满足 $\\pi Q = \\mathbf{0}$。这个零特征值模式支配着系统的长期行为，确保当 $t \\to \\infty$ 时，$P(t)$ 的每一行都收敛到 $\\pi$。\n\n**方法二：直接数值矩阵指数**\n\n作为一种独立验证，我们使用鲁棒的矩阵指数数值算法直接计算 $P(t)$。我们使用 `scipy.linalg.expm` 函数，该函数实现了一种基于帕德逼近的缩放与平方算法。该方法是计算一般方阵指数的标准且高度可靠的方法。\n$$\nP_{\\mathrm{num}}(t) = \\mathrm{expm}(Q t)\n$$\n\n#### 3. 诊断指标\n\n我们通过四个诊断指标来量化计算出的转移矩阵 $P(t) = P_{\\mathrm{spec}}(t)$ 的性质，并将其与数值版本 $P_{\\mathrm{num}}(t)$进行比较：\n\n1.  **弗罗贝尼乌斯范数差异**：$\\lVert P_{\\mathrm{spec}}(t) - P_{\\mathrm{num}}(t) \\rVert_F$。这衡量了两种计算方法之间的总体数值差异。一个较小的值可以验证两种实现的正确性。\n\n2.  **最大行和违反度**：$\\max_{i} \\left| \\sum_{j} P_{ij}(t) - 1 \\right|$。对于任何有效的转移概率矩阵，每一行之和必须为 $1$，因为过程必须转移到*某个*状态。该指标检查由于数值误差导致的对该随机性性质的违反情况。\n\n3.  **平稳性违反度**：$\\lVert \\pi P(t) - \\pi \\rVert_2$。由于 $\\pi$ 是平稳分布，它在 $P(t)$ 的作用下必须是不变的，即 $\\pi P(t) = \\pi$。该诊断指标计算差异的欧几里得范数，以衡量对这一基本性质的任何偏离。\n\n4.  **与平稳状态的最大行偏差**：$\\max_{i} \\lVert P_{i\\cdot}(t) - \\pi \\rVert_2$。转移矩阵的每一行 $P_{i\\cdot}(t)$ 代表从状态 $i$ 出发，在时间 $t$ 时各状态的概率分布。当 $t \\to \\infty$ 时，所有行都应收敛到平稳分布 $\\pi$。该指标衡量任何此类行与 $\\pi$ 之间的最大欧几里得距离，表明系统距离平衡有多近。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Main function to run the HKY85 model simulations for all test cases.\n    \"\"\"\n    \n    # Test cases as specified in the problem statement.\n    # Each tuple contains (pi, kappa, t).\n    # pi is a tuple of (pi_A, pi_C, pi_G, pi_T).\n    test_cases = [\n        # Test case 1 (balanced frequencies, boundary time)\n        ((0.25, 0.25, 0.25, 0.25), 1.0, 0.0),\n        # Test case 2 (balanced frequencies, moderate bias)\n        ((0.25, 0.25, 0.25, 0.25), 2.0, 0.5),\n        # Test case 3 (moderate skew, stronger bias, longer time)\n        ((0.35, 0.15, 0.35, 0.15), 3.0, 2.0),\n        # Test case 4 (strong skew, extreme bias, long time)\n        ((0.70, 0.10, 0.15, 0.05), 10.0, 5.0),\n        # Test case 5 (skewed with very small time)\n        ((0.40, 0.10, 0.40, 0.10), 20.0, 1e-8),\n    ]\n\n    all_diagnostics = []\n\n    for pi_tuple, kappa, t in test_cases:\n        pi = np.array(pi_tuple)\n        \n        # 1. Construct the unscaled HKY85 generator matrix Q'\n        Q_prime = np.zeros((4, 4))\n        \n        # Define transitions {A,G} -> {0,2} and {C,T} -> {1,3}\n        purines = {0, 2}\n        pyrimidines = {1, 3}\n        \n        for i in range(4):\n            for j in range(4):\n                if i == j:\n                    continue\n                \n                # Determine if it's a transition or transversion\n                is_transition = (i in purines and j in purines) or (i in pyrimidines and j in pyrimidines)\n                s_ij = kappa if is_transition else 1.0\n                Q_prime[i, j] = s_ij * pi[j]\n        \n        # Set diagonal elements such that row sums are zero\n        for i in range(4):\n            Q_prime[i, i] = -np.sum(Q_prime[i, :])\n            \n        # 2. Scale Q so that the expected substitution rate mu is 1\n        mu_prime = -np.sum(pi * np.diag(Q_prime))\n\n        # Avoid division by zero if mu_prime is zero (e.g. if all rates are zero)\n        if np.isclose(mu_prime, 0.0):\n            Q = Q_prime # Or handle as an error, but here Q will be a zero matrix\n        else:\n            Q = Q_prime / mu_prime\n            \n        # 3. Compute P(t) via Spectral Decomposition\n        S = np.diag(np.sqrt(pi))\n        S_inv = np.diag(1.0 / np.sqrt(pi))\n        H = S @ Q @ S_inv\n        \n        # Eigendecomposition of the symmetric matrix H\n        # np.linalg.eigh is for hermitian/symmetric matrices and is more stable\n        eigenvalues, U = np.linalg.eigh(H)\n        \n        exp_lambda_t = np.diag(np.exp(eigenvalues * t))\n        \n        P_spec = S_inv @ U @ exp_lambda_t @ U.T @ S\n        \n        # 4. Compute P(t) via Direct Numerical Method\n        P_num = expm(Q * t)\n        \n        # 5. Calculate the four diagnostics\n        \n        # D1: Frobenius norm difference\n        d1 = np.linalg.norm(P_spec - P_num, 'fro')\n        \n        # D2: Maximal row-sum violation\n        row_sums = np.sum(P_spec, axis=1)\n        d2 = np.max(np.abs(row_sums - 1.0))\n\n        # D3: Stationarity violation\n        pi_P = pi @ P_spec\n        d3 = np.linalg.norm(pi_P - pi, 2)\n        \n        # D4: Maximal row deviation from stationarity\n        row_deviations = []\n        for i in range(4):\n            row_i = P_spec[i, :]\n            deviation = np.linalg.norm(row_i - pi, 2)\n            row_deviations.append(deviation)\n        d4 = np.max(row_deviations)\n        \n        all_diagnostics.extend([d1, d2, d3, d4])\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{d:.12e}' for d in all_diagnostics)}]\")\n\nsolve()\n```"
        }
    ]
}