{
    "hands_on_practices": [
        {
            "introduction": "在将RNA测序（RNA-seq）数据与临床结果整合之前，必须解决技术差异，例如不同样本间的测序深度差异。本练习将指导您使用比率中位数归一化方法，这是一种使基因表达计数在样本间具有可比性的稳健技术。通过从基本原理出发推导该方法，您将对这一关键的预处理步骤获得深刻的理解 。",
            "id": "4574649",
            "problem": "您正在将核糖核酸测序 (RNA-seq) 的转录本丰度与一个二元临床表型进行整合，以便使用广义线性模型 (GLM) 进行下游的关联建模。您观察到一个 RNA-seq 计数矩阵 $X \\in \\mathbb{R}^{n \\times p}$，其中有 $n$ 个基因和 $p$ 个样本，第 $g$ 行对应基因 $g$，第 $j$ 列对应样本 $j$。假设 $n = 4$ 且 $p = 3$，观察到的计数为\n$$\nX \\;=\\; \\begin{pmatrix}\n100  200  50 \\\\\n50  100  25 \\\\\n20  40  10 \\\\\n80  160  40\n\\end{pmatrix}.\n$$\n您还记录了一个二元表型向量 $y \\in \\{0,1\\}^{p}$，它表示样本的疾病状态，其中 $y = (0, 1, 0)$。您计划在进行样本间归一化以消除乘性文库大小效应后，拟合一个对数连接的广义线性模型。\n\n仅从以下基本建模原则出发：样本 $j$ 中基因 $g$ 的观测计数来自样本特异性文库大小因子 $s_{j} > 0$ 和基因与样本特异性的基础表达水平 $\\theta_{g,j} > 0$ 的乘性分解；以及一个稳健的归一化程序应对跨样本的逐基因缩放保持不变。请根据这些原则，推导出一个文库大小因子 $\\{s_{j}\\}_{j=1}^{p}$ 的稳健估计量。然后，使用该估计量，通过将 $X$ 逐元素地除以相应的文库大小因子，计算归一化后的计数 $\\tilde{X}$。\n\n最后，报告单个归一化计数值 $\\tilde{x}_{4,2}$，即基因 $g=4$ 在样本 $j=2$ 中的归一化计数。请将您的最终答案表示为一个不带单位的纯数字。无需四舍五入。",
            "solution": "该问题要求基于基本原则，推导并应用一个用于 RNA-seq 数据分析中对文库大小因子进行稳健估计的估计量。\n\n设基因 $g$ 在样本 $j$ 中的观测计数为 $x_{g,j}$，其中 $g \\in \\{1, \\dots, n\\}$ 且 $j \\in \\{1, \\dots, p\\}$。问题提供了一个计数矩阵 $X \\in \\mathbb{R}^{n \\times p}$，其中有 $n=4$ 个基因和 $p=3$ 个样本。\n\n基本建模原则陈述了期望计数的一个乘性分解：\n$$ E[x_{g,j}] \\approx s_{j} \\theta_{g,j} $$\n其中 $s_{j} > 0$ 是样本特异性文库大小因子，$\\theta_{g,j} > 0$ 是基因 $g$ 在样本 $j$ 中的基础表达水平。\n\n第二个原则是，大小因子集合 $\\{s_j\\}_{j=1}^p$ 的估计程序必须对逐基因缩放保持不变。也就是说，如果我们构建一个新的计数矩阵 $X'$，其中每一行 $g$ 都被一个常数 $c_g > 0$ 缩放，使得 $x'_{g,j} = c_g x_{g,j}$，那么得到的大小因子估计值 $s'_j$ 应与原始估计值 $s_j$ 相同。\n\n为了推导满足这些性质的估计量，我们构建一个伪参考样本作为共同的基准。对于这个伪参考样本中基因 $g$ 的表达水平，一个稳健的选择是基因 $g$ 在所有样本中计数的几何平均数，我们将其表示为 $\\mu_g$：\n$$ \\mu_g = \\left( \\prod_{k=1}^{p} x_{g,k} \\right)^{1/p} $$\n我们来验证这个项在逐基因缩放下的行为。如果 $x'_{g,j} = c_g x_{g,j}$，新的几何平均数 $\\mu'_g$ 为：\n$$ \\mu'_g = \\left( \\prod_{k=1}^{p} x'_{g,k} \\right)^{1/p} = \\left( \\prod_{k=1}^{p} c_g x_{g,k} \\right)^{1/p} = \\left( c_g^p \\prod_{k=1}^{p} x_{g,k} \\right)^{1/p} = c_g \\left( \\prod_{k=1}^{p} x_{g,k} \\right)^{1/p} = c_g \\mu_g $$\n所以，基因 $g$ 的伪参考值按相同的因子 $c_g$ 进行缩放。\n\n现在，对于每个样本 $j$ 中的每个基因 $g$，我们计算其观测计数与该基因的伪参考计数的比率：\n$$ r_{g,j} = \\frac{x_{g,j}}{\\mu_g} $$\n如果我们考虑乘性模型，这个比率近似为：\n$$ r_{g,j} \\approx \\frac{s_{j} \\theta_{g,j}}{\\mu_g} $$\n对于许多基因，它们的表达水平在样本所代表的生物学条件下可能不会发生剧烈变化，这意味着对于给定的 $g$，$\\theta_{g,j}$ 是相对恒定的。在这种情况下，$\\mu_g$ 可以看作是与这个共同表达水平成比例的量的估计。那么比率 $r_{g,j}$ 将近似与 $s_j$ 成比例。\n\n关键的是，让我们检查这个比率在逐基因缩放下的行为：\n$$ r'_{g,j} = \\frac{x'_{g,j}}{\\mu'_g} = \\frac{c_g x_{g,j}}{c_g \\mu_g} = \\frac{x_{g,j}}{\\mu_g} = r_{g,j} $$\n这些比率对逐基因缩放因子 $c_g$ 是不变的。\n\n对于一个给定的样本 $j$，我们现在有一组 $n$ 个比率，$\\{r_{1,j}, r_{2,j}, \\dots, r_{n,j}\\}$。这些比率中的每一个都是大小因子 $s_j$ 的一个估计。为了获得 $s_j$ 的单一、稳健的估计，我们取这组比率的中位数。中位数对于离群值是稳健的，例如那些强烈差异表达的基因，对于这些基因，$\\theta_{g,j} \\approx \\theta_{g,k}$ 的假设可能不成立。\n因此，我们对样本 $j$ 的大小因子的稳健估计量是：\n$$ s_j = \\underset{g}{\\text{median}} \\left\\{ \\frac{x_{g,j}}{\\left( \\prod_{k=1}^{p} x_{g,k} \\right)^{1/p}} \\right\\} $$\n这被称为比率中位数法。\n\n我们现在将此程序应用于给定的数据。计数矩阵是：\n$$\nX = \\begin{pmatrix}\n100  200  50 \\\\\n50  100  25 \\\\\n20  40  10 \\\\\n80  160  40\n\\end{pmatrix}\n$$\n其中 $n=4$ 且 $p=3$。\n\n首先，我们计算每个基因（行）的几何平均数 $\\mu_g$：\n$$ \\mu_1 = (100 \\times 200 \\times 50)^{1/3} = (1000000)^{1/3} = 100 $$\n$$ \\mu_2 = (50 \\times 100 \\times 25)^{1/3} = (125000)^{1/3} = 50 $$\n$$ \\mu_3 = (20 \\times 40 \\times 10)^{1/3} = (8000)^{1/3} = 20 $$\n$$ \\mu_4 = (80 \\times 160 \\times 40)^{1/3} = (512000)^{1/3} = 80 $$\n\n接下来，我们计算比率矩阵 $R$，其中 $r_{g,j} = x_{g,j} / \\mu_g$：\n$$\nR = \\begin{pmatrix}\n100/100  200/100  50/100 \\\\\n50/50  100/50  25/50 \\\\\n20/20  40/20  10/20 \\\\\n80/80  160/80  40/80\n\\end{pmatrix}\n= \\begin{pmatrix}\n1.0  2.0  0.5 \\\\\n1.0  2.0  0.5 \\\\\n1.0  2.0  0.5 \\\\\n1.0  2.0  0.5\n\\end{pmatrix}\n$$\n\n现在，我们通过取 $R$ 中相应列的中位数来估计每个样本 $j$ 的大小因子 $s_j$：\n$$ s_1 = \\text{median}\\{1.0, 1.0, 1.0, 1.0\\} = 1.0 $$\n$$ s_2 = \\text{median}\\{2.0, 2.0, 2.0, 2.0\\} = 2.0 $$\n$$ s_3 = \\text{median}\\{0.5, 0.5, 0.5, 0.5\\} = 0.5 $$\n大小因子向量为 $(s_1, s_2, s_3) = (1.0, 2.0, 0.5)$。\n\n最后，我们通过将每个元素 $x_{g,j}$ 除以其对应样本的大小因子 $s_j$ 来计算归一化计数矩阵 $\\tilde{X}$：$\\tilde{x}_{g,j} = x_{g,j} / s_j$。这等同于将 $X$ 的每一列除以相应的大小因子。\n$$\n\\tilde{X} = \\begin{pmatrix}\n100/1.0  200/2.0  50/0.5 \\\\\n50/1.0  100/2.0  25/0.5 \\\\\n20/1.0  40/2.0  10/0.5 \\\\\n80/1.0  160/2.0  40/0.5\n\\end{pmatrix}\n= \\begin{pmatrix}\n100  100  100 \\\\\n50  50  50 \\\\\n20  20  20 \\\\\n80  80  80\n\\end{pmatrix}\n$$\n\n问题要求的是归一化计数值 $\\tilde{x}_{4,2}$，它是 $\\tilde{X}$ 矩阵中第4行第2列的元素。\n$$ \\tilde{x}_{4,2} = \\frac{x_{4,2}}{s_2} = \\frac{160}{2.0} = 80 $$\n从计算出的矩阵 $\\tilde{X}$ 中，我们可以直接读出这个值。\n\n提供表型向量 $y=(0, 1, 0)$ 是为了建立下游分析（GLM）的背景，但它本身并不用于归一化计算，归一化是一个前提步骤。\n最终要求的值是 $\\tilde{x}_{4,2}$。",
            "answer": "$$\n\\boxed{80}\n$$"
        },
        {
            "introduction": "组织块的组学数据反映了来自多种细胞类型的混合信号，这可能掩盖真实的生物学关联。本实践介绍细胞类型反卷积，这是一种强大的特征工程技术，能从组织块的整体表达谱中估计各种细胞类型的比例 。掌握这项技术使您能够为构建临床表型的预测模型生成更具生物学意义的变量。",
            "id": "4574619",
            "problem": "给定一个框架，通过使用单细胞参考、线性混合模型和非负最小二乘法来估计细胞类型比例，从而将核糖核酸测序（RNA-seq）批量基因表达数据与临床表型进行整合。其原理是，批量表达是细胞类型特异性表达谱的混合，这与分子生物学的中心法则以及组织样本内各组成细胞类型的转录本计数的加性一致。由此可得一个线性模型：对于 $G$ 个基因和 $C$ 种细胞类型，批量表达向量 $\\mathbf{y} \\in \\mathbb{R}^{G}$ 可建模为\n$$\n\\mathbf{y} = X \\mathbf{p} + \\boldsymbol{\\varepsilon},\n$$\n其中 $X \\in \\mathbb{R}^{G \\times C}$ 是从单细胞测量中获得的每个基因在每种细胞类型中的平均表达参考矩阵，$\\mathbf{p} \\in \\mathbb{R}^{C}$ 是未知的细胞类型比例非负向量，$\\boldsymbol{\\varepsilon} \\in \\mathbb{R}^{G}$ 是测量噪声。生物学约束意味着对所有 $c$ 都有 $p_c \\geq 0$，并且在将 $\\mathbf{p}$ 解释为分数时，$\\sum_{c=1}^{C} p_c = 1$。在实践中，可以通过求解非负最小二乘问题来估计 $\\mathbf{p}$：\n$$\n\\min_{\\mathbf{p} \\in \\mathbb{R}^{C}} \\|\\;X \\mathbf{p} - \\mathbf{y}\\;\\|_2 \\quad \\text{subject to} \\quad p_c \\geq 0 \\text{ for all } c,\n$$\n然后将 $\\mathbf{p}$ 重新归一化使其总和为一，因为最小二乘法不强制执行总和为一的约束。准确性可以通过与已知比例的模拟混合物进行比较来评估。\n\n实现一个程序，为提供的测试套件完成以下操作：\n- 为每个测试用例，根据用例描述构建指定的单细胞参考矩阵 $X$、真实比例 $\\mathbf{p}^{\\star}$（或其变体）以及批量向量 $\\mathbf{y}$。\n- 通过求解非负最小二乘问题来估计 $\\widehat{\\mathbf{p}}$，并在 $\\sum_{c=1}^{C} \\widehat{p}_c > 0$ 时将其重新归一化以满足 $\\sum_{c=1}^{C} \\widehat{p}_c = 1$，否则对所有 $c$ 设置 $\\widehat{p}_c = \\frac{1}{C}$。\n- 对每个案例，使用以下公式计算 $\\widehat{\\mathbf{p}}$ 与指定的真实比例之间的均方根误差（RMSE）：\n$$\n\\mathrm{RMSE}(\\widehat{\\mathbf{p}}, \\mathbf{p}^{\\dagger}) = \\sqrt{\\frac{1}{C} \\sum_{c=1}^{C} \\left(\\widehat{p}_c - p^{\\dagger}_c\\right)^2}.\n$$\n- 对于临床表型案例，模拟一小组具有已知比例的批量样本，并计算指定细胞类型的估计分数与临床严重程度得分向量 $\\mathbf{s}$ 之间的皮尔逊相关系数。使用以下公式：\n$$\nr = \\frac{\\sum_{t=1}^{T} \\left(\\widehat{p}_{j}^{(t)} - \\overline{\\widehat{p}_{j}}\\right)\\left(s^{(t)} - \\overline{s}\\right)}{\\sqrt{\\sum_{t=1}^{T}\\left(\\widehat{p}_{j}^{(t)} - \\overline{\\widehat{p}_{j}}\\right)^2}\\sqrt{\\sum_{t=1}^{T}\\left(s^{(t)} - \\overline{s}\\right)^2}},\n$$\n其中 $\\widehat{p}_{j}^{(t)}$ 是样本 $t$ 的细胞类型 $j$ 的估计分数，$\\overline{\\widehat{p}_{j}}$ 是其在所有样本中的平均值，$s^{(t)}$ 是样本 $t$ 的临床严重程度，$\\overline{s}$ 是其平均值。比例以小数表示，而非百分比。\n\n测试套件规范：\n- 所有矩阵和向量都是明确给出的。请完全按照指定的方式使用它们，除了上述描述之外，不要进行任何额外的归一化或转换。所有数值均为小数，任何派生值也应视为小数。\n\n案例 $1$（良态参考，无噪声混合）：\n- 基因数 $G = 5$，细胞类型数 $C = 3$。\n- 参考矩阵\n$$\nX_1 = \\begin{bmatrix}\n8  2  1 \\\\\n4  1.5  2 \\\\\n3  3  6 \\\\\n5  1  0.5 \\\\\n7  2.5  1\n\\end{bmatrix}.\n$$\n- 真实比例\n$$\n\\mathbf{p}^{\\star}_1 = \\begin{bmatrix} 0.5 \\\\ 0.3 \\\\ 0.2 \\end{bmatrix}.\n$$\n- 批量向量\n$$\n\\mathbf{y}_1 = X_1 \\mathbf{p}^{\\star}_1 = \\begin{bmatrix} 4.8 \\\\ 2.85 \\\\ 3.6 \\\\ 2.9 \\\\ 4.45 \\end{bmatrix}.\n$$\n- RMSE的真实值：$\\mathbf{p}^{\\dagger} = \\mathbf{p}^{\\star}_1$。\n\n案例 $2$（细胞类型谱之间的近共线性）：\n- 参考矩阵\n$$\nX_2 = \\begin{bmatrix}\n6  6.2  1 \\\\\n3  3.1  2 \\\\\n5  5.1  6 \\\\\n4  4.05  0.5 \\\\\n2  2.02  1\n\\end{bmatrix}.\n$$\n- 真实比例\n$$\n\\mathbf{p}^{\\star}_2 = \\begin{bmatrix} 0.4 \\\\ 0.4 \\\\ 0.2 \\end{bmatrix}.\n$$\n- 批量向量\n$$\n\\mathbf{y}_2 = X_2 \\mathbf{p}^{\\star}_2 = \\begin{bmatrix} 5.08 \\\\ 2.84 \\\\ 5.24 \\\\ 3.32 \\\\ 1.808 \\end{bmatrix}.\n$$\n- RMSE的真实值：$\\mathbf{p}^{\\dagger} = \\mathbf{p}^{\\star}_2$。\n\n案例 $3$（批量样本中存在未建模的细胞类型）：\n- 使用 $X_3 = X_1$。\n- 已知细胞类型比例（总和不为1）\n$$\n\\mathbf{p}^{\\text{known}}_3 = \\begin{bmatrix} 0.5 \\\\ 0.25 \\\\ 0.15 \\end{bmatrix}, \\quad \\text{所以} \\quad \\sum_{c=1}^{3} p^{\\text{known}}_{3,c} = 0.9.\n$$\n- 未知细胞类型分数为 $0.1$，其表达向量为\n$$\n\\mathbf{u} = \\begin{bmatrix} 4 \\\\ 1 \\\\ 3 \\\\ 2 \\\\ 5 \\end{bmatrix}.\n$$\n- 批量向量\n$$\n\\mathbf{y}_3 = X_3 \\mathbf{p}^{\\text{known}}_3 + 0.1 \\cdot \\mathbf{u} = \\begin{bmatrix} 5.05 \\\\ 2.775 \\\\ 3.45 \\\\ 3.025 \\\\ 4.775 \\end{bmatrix}.\n$$\n- RMSE的真实值：将已知比例归一化使其总和为一，\n$$\n\\mathbf{p}^{\\dagger} = \\frac{\\mathbf{p}^{\\text{known}}_3}{0.9} = \\begin{bmatrix} 0.5555555556 \\\\ 0.2777777778 \\\\ 0.1666666667 \\end{bmatrix}.\n$$\n\n案例 $4$（测量噪声）：\n- 使用 $X_4 = X_1$。\n- 真实比例\n$$\n\\mathbf{p}^{\\star}_4 = \\begin{bmatrix} 0.3 \\\\ 0.5 \\\\ 0.2 \\end{bmatrix}.\n$$\n- 无噪声批量数据\n$$\nX_4 \\mathbf{p}^{\\star}_4 = \\begin{bmatrix} 3.6 \\\\ 2.35 \\\\ 3.6 \\\\ 2.1 \\\\ 3.55 \\end{bmatrix}.\n$$\n- 加性噪声向量\n$$\n\\boldsymbol{\\eta} = \\begin{bmatrix} 0.05 \\\\ -0.02 \\\\ 0.03 \\\\ -0.04 \\\\ 0.01 \\end{bmatrix}.\n$$\n- 批量向量\n$$\n\\mathbf{y}_4 = X_4 \\mathbf{p}^{\\star}_4 + \\boldsymbol{\\eta} = \\begin{bmatrix} 3.65 \\\\ 2.33 \\\\ 3.63 \\\\ 2.06 \\\\ 3.56 \\end{bmatrix}.\n$$\n- RMSE的真实值：$\\mathbf{p}^{\\dagger} = \\mathbf{p}^{\\star}_4$。\n\n案例 $5$（文库大小缩放不匹配）：\n- 使用 $X_5 = X_1$。\n- 真实比例\n$$\n\\mathbf{p}^{\\star}_5 = \\mathbf{p}^{\\star}_1 = \\begin{bmatrix} 0.5 \\\\ 0.3 \\\\ 0.2 \\end{bmatrix}.\n$$\n- 批量向量是案例1的缩放版本，\n$$\n\\mathbf{y}_5 = 2 \\cdot \\mathbf{y}_1 = \\begin{bmatrix} 9.6 \\\\ 5.7 \\\\ 7.2 \\\\ 5.8 \\\\ 8.9 \\end{bmatrix}.\n$$\n- RMSE的真实值：$\\mathbf{p}^{\\dagger} = \\mathbf{p}^{\\star}_5$。\n\n案例 $6$（与临床严重程度表型整合）：\n- 使用 $X_6 = X_1$。\n- 样本数 $T = 6$。\n- 每个样本的真实比例（列表示细胞类型1、2、3）：\n$$\n\\mathbf{p}^{\\star (1)} = \\begin{bmatrix} 0.2 \\\\ 0.5 \\\\ 0.3 \\end{bmatrix},\\quad\n\\mathbf{p}^{\\star (2)} = \\begin{bmatrix} 0.1 \\\\ 0.5 \\\\ 0.4 \\end{bmatrix},\\quad\n\\mathbf{p}^{\\star (3)} = \\begin{bmatrix} 0.05 \\\\ 0.45 \\\\ 0.5 \\end{bmatrix},\\quad\n\\mathbf{p}^{\\star (4)} = \\begin{bmatrix} 0.3 \\\\ 0.6 \\\\ 0.1 \\end{bmatrix},\\quad\n\\mathbf{p}^{\\star (5)} = \\begin{bmatrix} 0.05 \\\\ 0.35 \\\\ 0.6 \\end{bmatrix},\\quad\n\\mathbf{p}^{\\star (6)} = \\begin{bmatrix} 0.15 \\\\ 0.55 \\\\ 0.3 \\end{bmatrix}.\n$$\n- 临床严重程度得分向量\n$$\n\\mathbf{s} = \\begin{bmatrix} 0.3 \\\\ 0.5 \\\\ 0.7 \\\\ 0.2 \\\\ 0.9 \\\\ 0.4 \\end{bmatrix}.\n$$\n- 对于每个样本 $t \\in \\{1,\\dots,6\\}$，批量向量为\n$$\n\\mathbf{y}_6^{(t)} = X_6 \\mathbf{p}^{\\star (t)} + \\boldsymbol{\\delta},\n$$\n其中有一个小的固定加性噪声\n$$\n\\boldsymbol{\\delta} = \\begin{bmatrix} 0.01 \\\\ -0.01 \\\\ 0.0 \\\\ 0.02 \\\\ -0.02 \\end{bmatrix}.\n$$\n- 为每个样本估计 $\\widehat{\\mathbf{p}}^{(t)}$，并计算细胞类型3的估计分数（$\\widehat{\\mathbf{p}}^{(t)}$ 的第三个分量）与向量 $\\mathbf{s}$ 之间的皮尔逊相关系数 $r$。将 $r$ 报告为小数。\n\n输出规范：\n- 你的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来，结果按以下顺序排列：案例1的RMSE，案例2的RMSE，案例3的RMSE，案例4的RMSE，案例5的RMSE，以及案例6的皮尔逊相关系数 $r$。每个值必须四舍五入到6位小数。例如，输出应如下所示：\n$$\n[\\text{value}_1,\\text{value}_2,\\text{value}_3,\\text{value}_4,\\text{value}_5,\\text{value}_6].\n$$\n所有比例都应解释为小数（0到1之间的分数），而不是百分比。",
            "solution": "起点是批量基因表达的线性混合模型。由于来自不同细胞类型的转录本计数是相加的，一个基因 $g$ 的批量测量可以表示为\n$$\ny_g = \\sum_{c=1}^{C} X_{gc} p_c + \\varepsilon_g,\n$$\n其中 $X_{gc}$ 是基因 $g$ 在细胞类型 $c$ 中的平均表达量，$p_c$ 是样本中细胞类型 $c$ 的比例，$\\varepsilon_g$ 则捕捉了测量噪声和模型不匹配。由于这些量是计数或分数，我们有 $X_{gc} \\geq 0$，$p_c \\geq 0$，并且在分数解释下 $\\sum_{c=1}^{C} p_c = 1$。跨所有基因的模型可以简洁地写成\n$$\n\\mathbf{y} = X \\mathbf{p} + \\boldsymbol{\\varepsilon}.\n$$\n\n为了估计 $\\mathbf{p}$，我们将其转化为一个凸优化问题。在没有噪声的情况下，最小二乘估计量求解\n$$\n\\min_{\\mathbf{p}} \\left\\| X \\mathbf{p} - \\mathbf{y} \\right\\|_2^2.\n$$\n生物学约束意味着 $\\mathbf{p}$ 的非负性，从而产生非负最小二乘（NNLS）问题：\n$$\n\\min_{\\mathbf{p} \\in \\mathbb{R}^{C}} \\left\\| X \\mathbf{p} - \\mathbf{y} \\right\\|_2 \\quad \\text{subject to} \\quad p_c \\geq 0 \\text{ for all } c.\n$$\n当 $X$ 具有满列秩时，这是一个具有唯一最小化子（minimizer）的凸问题，并且由于非负性和二次目标函数，在近共线性下表现稳定。Karush–Kuhn–Tucker (KKT) 条件确保在最优点，对于活动变量，要么 $\\widehat{p}_c = 0$，要么满足相应的梯度条件。在计算上，我们通过活动集方法（active-set method）（如标准库中实现的）来求解 NNLS，该方法迭代地识别被约束为零的变量子集，并对其余变量求解无约束最小二乘问题，直至达到最优。\n\nNNLS 解 $\\widehat{\\mathbf{p}}$ 并不强制执行总和为一的约束。然而，当将 $\\widehat{\\mathbf{p}}$ 解释为分数时，重新归一化是直接的：\n$$\n\\widehat{\\mathbf{p}} \\leftarrow \\frac{\\widehat{\\mathbf{p}}}{\\sum_{c=1}^{C} \\widehat{p}_c} \\quad \\text{if} \\quad \\sum_{c=1}^{C} \\widehat{p}_c > 0,\n$$\n以确保 $\\sum_{c=1}^{C} \\widehat{p}_c = 1$。如果由于退化（全零估计）导致 $\\sum_{c=1}^{C} \\widehat{p}_c = 0$，一个合理的备用方案是均匀分布\n$$\n\\widehat{p}_c = \\frac{1}{C} \\quad \\text{for all } c.\n$$\n\n准确性通过均方根误差（RMSE）来量化，即 $\\widehat{\\mathbf{p}}$ 与真实值 $\\mathbf{p}^{\\dagger}$ 之间的误差：\n$$\n\\mathrm{RMSE}(\\widehat{\\mathbf{p}}, \\mathbf{p}^{\\dagger}) = \\sqrt{\\frac{1}{C} \\sum_{c=1}^{C} \\left(\\widehat{p}_c - p^{\\dagger}_c\\right)^2}.\n$$\n在案例1中，参考矩阵是良态的，混合物是无噪声的，因此 NNLS 在重新归一化后应能以可忽略的误差恢复 $\\mathbf{p}^{\\star}_1$。在案例2中，$X_2$ 的列几乎是共线的；NNLS 仍然适用，但由于病态条件，解的精度可能会降低，不过重新归一化仍将强制其可解释性。在案例3中，批量样本包含一个未建模的细胞类型。正确的评估应将 $\\widehat{\\mathbf{p}}$ 与归一化后的已知比例 $\\mathbf{p}^{\\dagger} = \\mathbf{p}^{\\text{known}}_3 / 0.9$ 进行比较，因为未知分数在 $X$ 中没有表示。在案例4中，加性噪声扰动 $\\mathbf{y}$，NNLS 通过权衡残差来拟合带噪声的观测值，导致一个虽小但非零的RMSE。在案例5中，$\\mathbf{y}$ 的全局缩放对应于文库大小的差异；NNLS 后跟重新归一化对此类缩放不变，因此 RMSE 应该接近于零。\n\n对于与临床表型整合（案例6），我们为每个样本 $t$ 估计 $\\widehat{\\mathbf{p}}^{(t)}$，并关注特定细胞类型（此处为细胞类型3）的比例。估计的比例 $\\{\\widehat{p}_3^{(t)}\\}_{t=1}^{T}$ 与严重程度得分 $\\{s^{(t)}\\}_{t=1}^{T}$ 之间的皮尔逊相关系数为\n$$\nr = \\frac{\\sum_{t=1}^{T} \\left(\\widehat{p}_{3}^{(t)} - \\overline{\\widehat{p}_{3}}\\right)\\left(s^{(t)} - \\overline{s}\\right)}{\\sqrt{\\sum_{t=1}^{T}\\left(\\widehat{p}_{3}^{(t)} - \\overline{\\widehat{p}_{3}}\\right)^2}\\sqrt{\\sum_{t=1}^{T}\\left(s^{(t)} - \\overline{s}\\right)^2}},\n$$\n该系数衡量了估计的细胞类型3丰度与临床严重程度之间的线性关联，这是将组学衍生的特征与临床表型整合的标准方法。\n\n每个测试用例的算法步骤：\n- 完全按照指定构建 $X$ 和 $\\mathbf{y}$。\n- 求解 NNLS 以获得 $\\widehat{\\mathbf{p}}$。\n- 如果可能，将 $\\widehat{\\mathbf{p}}$ 重新归一化使其总和为一，否则将其设置为均匀分数。\n- 对于案例1–5，根据适当的 $\\mathbf{p}^{\\dagger}$ 计算RMSE；对于案例6，计算皮尔逊相关系数 $r$。\n\n最后，将六个结果汇总到一行，格式为 $[\\text{value}_1,\\dots,\\text{value}_6]$，每个值四舍五入到6位小数并以小数形式表示（无百分号）。这提供了一个关于不同条件下反卷积准确性及其与临床表型整合相关性的紧凑总结。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import nnls\n\ndef nnls_deconvolution(X, y):\n    \"\"\"\n    Solve nonnegative least squares for p in y ≈ X p.\n    Returns p_hat renormalized to sum to 1 (if possible).\n    \"\"\"\n    p_hat, _ = nnls(X, y)\n    s = p_hat.sum()\n    if s > 0:\n        p_hat = p_hat / s\n    else:\n        # Fallback to uniform distribution if degenerate (sum == 0)\n        C = X.shape[1]\n        p_hat = np.full(C, 1.0 / C)\n    return p_hat\n\ndef rmse(p_hat, p_true):\n    \"\"\"\n    Root Mean Squared Error between estimated and true proportions.\n    \"\"\"\n    diff = p_hat - p_true\n    return np.sqrt(np.mean(diff * diff))\n\ndef pearson_correlation(x, y):\n    \"\"\"\n    Pearson correlation coefficient between two 1D arrays.\n    \"\"\"\n    x = np.asarray(x, dtype=float)\n    y = np.asarray(y, dtype=float)\n    x_mean = np.mean(x)\n    y_mean = np.mean(y)\n    x_centered = x - x_mean\n    y_centered = y - y_mean\n    denom = np.sqrt(np.sum(x_centered**2) * np.sum(y_centered**2))\n    if denom == 0:\n        return 0.0\n    return float(np.sum(x_centered * y_centered) / denom)\n\ndef solve():\n    results = []\n\n    # Case 1\n    X1 = np.array([\n        [8.0, 2.0, 1.0],\n        [4.0, 1.5, 2.0],\n        [3.0, 3.0, 6.0],\n        [5.0, 1.0, 0.5],\n        [7.0, 2.5, 1.0]\n    ], dtype=float)\n    p1_true = np.array([0.5, 0.3, 0.2], dtype=float)\n    y1 = np.array([4.8, 2.85, 3.6, 2.9, 4.45], dtype=float)\n    p1_hat = nnls_deconvolution(X1, y1)\n    results.append(rmse(p1_hat, p1_true))\n\n    # Case 2\n    X2 = np.array([\n        [6.0, 6.2, 1.0],\n        [3.0, 3.1, 2.0],\n        [5.0, 5.1, 6.0],\n        [4.0, 4.05, 0.5],\n        [2.0, 2.02, 1.0]\n    ], dtype=float)\n    p2_true = np.array([0.4, 0.4, 0.2], dtype=float)\n    y2 = np.array([5.08, 2.84, 5.24, 3.32, 1.808], dtype=float)\n    p2_hat = nnls_deconvolution(X2, y2)\n    results.append(rmse(p2_hat, p2_true))\n\n    # Case 3 (unmodeled cell type)\n    X3 = X1.copy()\n    p3_known = np.array([0.5, 0.25, 0.15], dtype=float)  # sums to 0.9\n    u = np.array([4.0, 1.0, 3.0, 2.0, 5.0], dtype=float)\n    y3 = X3 @ p3_known + 0.1 * u\n    p3_true_norm = p3_known / 0.9\n    p3_hat = nnls_deconvolution(X3, y3)\n    results.append(rmse(p3_hat, p3_true_norm))\n\n    # Case 4 (measurement noise)\n    X4 = X1.copy()\n    p4_true = np.array([0.3, 0.5, 0.2], dtype=float)\n    y4_noiseless = X4 @ p4_true\n    eta = np.array([0.05, -0.02, 0.03, -0.04, 0.01], dtype=float)\n    y4 = y4_noiseless + eta\n    p4_hat = nnls_deconvolution(X4, y4)\n    results.append(rmse(p4_hat, p4_true))\n\n    # Case 5 (scaling mismatch)\n    X5 = X1.copy()\n    p5_true = p1_true.copy()\n    y5 = 2.0 * y1\n    p5_hat = nnls_deconvolution(X5, y5)\n    results.append(rmse(p5_hat, p5_true))\n\n    # Case 6 (clinical phenotype correlation)\n    X6 = X1.copy()\n    p6_list = [\n        np.array([0.2, 0.5, 0.3], dtype=float),\n        np.array([0.1, 0.5, 0.4], dtype=float),\n        np.array([0.05, 0.45, 0.5], dtype=float),\n        np.array([0.3, 0.6, 0.1], dtype=float),\n        np.array([0.05, 0.35, 0.6], dtype=float),\n        np.array([0.15, 0.55, 0.3], dtype=float),\n    ]\n    delta = np.array([0.01, -0.01, 0.0, 0.02, -0.02], dtype=float)\n    s = np.array([0.3, 0.5, 0.7, 0.2, 0.9, 0.4], dtype=float)\n    est_cell3 = []\n    for p_true in p6_list:\n        y6 = X6 @ p_true + delta\n        p_hat6 = nnls_deconvolution(X6, y6)\n        est_cell3.append(p_hat6[2])\n    r = pearson_correlation(np.array(est_cell3, dtype=float), s)\n    results.append(r)\n\n    # Round each result to 6 decimal places and print in specified format\n    rounded = [f\"{x:.6f}\" for x in results]\n    print(f\"[{','.join(rounded)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "临床数据集常常不完整，而其缺失机制可能会系统性地影响分析结果。本练习旨在解决非随机缺失（MNAR）数据这一高级挑战，您将在此量化一种常用但简单的处理方法——完整病例分析——所引入的偏差 。这项实践将使您具备在真实场景中评估统计模型有效性所需的批判性思维能力。",
            "id": "4574671",
            "problem": "一项蛋白质组学研究使用逻辑斯谛回归，将一个连续的蛋白质组学强度预测变量 $X$（例如，对数转换后的肽丰度）与一个二元临床表型 $Y \\in \\{0,1\\}$（例如，疾病存在与否）相结合。设潜在目标人群中的疾病模型为 $P(Y=1 \\mid X=x) = \\operatorname{expit}(\\beta_{0} + \\beta_{1} x)$，其中 $\\operatorname{expit}(t) = 1/(1+\\exp(-t))$。假设蛋白质组学测量值 $X$ 存在缺失，其缺失情况由一个指示变量 $R \\in \\{0,1\\}$ 来表示，其中当 $X$ 被观测到时 $R=1$，否则 $R=0$。考虑一个非随机缺失 (MNAR) 机制 $P(R=1 \\mid X=x, Y=y) = \\operatorname{expit}(\\alpha + \\gamma x + \\delta y)$，该机制同时依赖于未观测到的值 $x$ 和结果 $y$。\n\n一种常见的做法是完全病例分析，即仅使用 $R=1$ 的观测值对 $Y$ 关于 $X$ 拟合一个逻辑斯谛回归模型。在上述数据生成过程下，分析在进行完全病例分析时，由 MNAR 引起的斜率系数的渐近偏差。使用以下科学上合理的假设和参数值：\n- 疾病机制为 $P(Y=1 \\mid X=x) = \\operatorname{expit}(\\beta_{0} + \\beta_{1} x)$，其中 $\\beta_{1} = 0.8$。\n- 缺失机制为 $P(R=1 \\mid X=x, Y=y) = \\operatorname{expit}(\\alpha + \\gamma x + \\delta y)$，其中 $\\alpha = -1$, $\\gamma = 0.5$, $\\delta = -0.4$。\n- 假设 $\\gamma$ 和 $\\delta$ 的量级为中小尺度，使得关于 $\\gamma$ 和 $\\delta$ 的一阶（线性）近似是合适的；忽略所有二阶及更高阶的项（包括像 $\\gamma^{2}$、$\\delta^{2}$ 以及超出了一阶贡献的 $\\gamma \\delta$ 乘积）。\n\n从条件概率和逻辑斯谛链接函数的基本定义出发，推导在完全病例 $R=1$ 中给定 $X$ 时 $Y$ 的条件对数优势的一阶近似值，并由此推断出完全病例分析中估计的斜率系数 $\\tilde{\\beta}_{1}$ 相对于真实值 $\\beta_{1}$ 的一阶偏差，该偏差定义为 $\\tilde{\\beta}_{1} - \\beta_{1}$。使用给定的参数，计算这个一阶偏差的数值。将最终答案四舍五入到四位有效数字。将最终答案表示为一个无单位的实数。",
            "solution": "该问题要求计算在特定的非随机缺失（MNAR）机制下，通过完全病例估计的逻辑斯谛回归中斜率系数的渐近偏差。我们将真实参数记为 $\\beta_0, \\beta_1$，并将从完全病例分析中估计出的参数记为 $\\tilde{\\beta}_0, \\tilde{\\beta}_1$。\n\n完全病例分析是对预测变量 $X$ 被观测到的子群体（即 $R=1$ 的情况）拟合一个逻辑斯谛回归模型。因此，被估计的模型是基于条件概率 $P(Y=1 \\mid X=x, R=1)$。逻辑斯谛回归将估计该概率的对数优势（logit）的线性模型的参数。我们将其记为 $\\operatorname{logit}_{CC}(x)$：\n$$ \\operatorname{logit}_{CC}(x) = \\ln\\left(\\frac{P(Y=1 \\mid X=x, R=1)}{P(Y=0 \\mid X=x, R=1)}\\right) $$\n使用贝叶斯定理，我们可以将条件概率 $P(Y=y \\mid X=x, R=1)$ 表示为：\n$$ P(Y=y \\mid X=x, R=1) = \\frac{P(R=1 \\mid X=x, Y=y) P(Y=y \\mid X=x)}{P(R=1 \\mid X=x)} $$\n那么，完全病例的优势比为：\n$$ \\frac{P(Y=1 \\mid X=x, R=1)}{P(Y=0 \\mid X=x, R=1)} = \\frac{P(R=1 \\mid X=x, Y=1) P(Y=1 \\mid X=x)}{P(R=1 \\mid X=x, Y=0) P(Y=0 \\mid X=x)} $$\n对上式两边取自然对数，得到完全病例的对数优势：\n$$ \\operatorname{logit}_{CC}(x) = \\ln\\left(\\frac{P(Y=1 \\mid X=x)}{P(Y=0 \\mid X=x)}\\right) + \\ln\\left(\\frac{P(R=1 \\mid X=x, Y=1)}{P(R=1 \\mid X=x, Y=0)}\\right) $$\n第一项是真实的对数优势，$\\operatorname{logit}(P(Y=1 \\mid X=x)) = \\beta_0 + \\beta_1 x$。第二项是由选择过程（即以 $R=1$ 为条件）引起的偏差。我们把整个函数称为 $L(x; \\gamma, \\delta)$。\n代入给定的概率模型：\n$P(Y=1 \\mid X=x) = \\operatorname{expit}(\\beta_0 + \\beta_1 x)$\n$P(R=1 \\mid X=x, Y=y) = \\operatorname{expit}(\\alpha + \\gamma x + \\delta y)$\n完全病例的对数优势表达式变为：\n$$ L(x; \\gamma, \\delta) = (\\beta_0 + \\beta_1 x) + \\ln\\left(\\frac{\\operatorname{expit}(\\alpha + \\gamma x + \\delta \\cdot 1)}{\\operatorname{expit}(\\alpha + \\gamma x + \\delta \\cdot 0)}\\right) $$\n$$ L(x; \\gamma, \\delta) = (\\beta_0 + \\beta_1 x) + \\ln(\\operatorname{expit}(\\alpha + \\gamma x + \\delta)) - \\ln(\\operatorname{expit}(\\alpha + \\gamma x)) $$\n使用恒等式 $\\ln(\\operatorname{expit}(t)) = -\\ln(1+\\exp(-t))$，上式可以重写为：\n$$ L(x; \\gamma, \\delta) = (\\beta_0 + \\beta_1 x) - \\ln(1+\\exp(-(\\alpha + \\gamma x + \\delta))) + \\ln(1+\\exp(-(\\alpha + \\gamma x))) $$\n完全病例逻辑斯谛回归旨在找到 $L(x; \\gamma, \\delta)$ 的最佳线性近似。为了确定在 $\\gamma$ 和 $\\delta$ 很小时的渐近偏差，我们对 $L(x; \\gamma, \\delta)$ 在 $(\\gamma, \\delta) = (0, 0)$ 处进行泰勒级数展开。斜率估计值 $\\tilde{\\beta}_1$ 的偏差来自于该展开式中与 $x$呈线性的项。\n\n如果 $\\gamma=0$（缺失不依赖于 $X$）或 $\\delta=0$（缺失不依赖于 $Y$，即随机缺失 MAR），则斜率的偏差必须为零。这意味着斜率偏差的首项必须包含乘积 $\\gamma\\delta$。因此，我们需要将 $L(x; \\gamma, \\delta)$ 展开到二阶，包括混合偏导数项。\n$$ L(x; \\gamma, \\delta) \\approx L(x; 0, 0) + \\gamma \\frac{\\partial L}{\\partial \\gamma}\\bigg|_{(0,0)} + \\delta \\frac{\\partial L}{\\partial \\delta}\\bigg|_{(0,0)} + \\gamma\\delta \\frac{\\partial^2 L}{\\partial \\gamma \\partial \\delta}\\bigg|_{(0,0)} + \\dots $$\n让我们计算偏导数。\n$L(x; 0, 0) = (\\beta_0 + \\beta_1 x) - \\ln(1+\\exp(-\\alpha)) + \\ln(1+\\exp(-\\alpha)) = \\beta_0 + \\beta_1 x$。\n\n关于 $\\gamma$ 的一阶偏导数：\n$$ \\frac{\\partial L}{\\partial \\gamma} = - \\frac{ -x \\exp(-(\\alpha+\\gamma x+\\delta)) }{1+\\exp(-(\\alpha+\\gamma x+\\delta))} + \\frac{ -x \\exp(-(\\alpha+\\gamma x)) }{1+\\exp(-(\\alpha+\\gamma x))} $$\n$$ \\frac{\\partial L}{\\partial \\gamma} = x(1-\\operatorname{expit}(\\alpha+\\gamma x+\\delta)) - x(1-\\operatorname{expit}(\\alpha+\\gamma x)) = x(\\operatorname{expit}(\\alpha+\\gamma x)-\\operatorname{expit}(\\alpha+\\gamma x+\\delta)) $$\n在 $(\\gamma, \\delta) = (0, 0)$ 处求值：\n$$ \\frac{\\partial L}{\\partial \\gamma}\\bigg|_{(0,0)} = x(\\operatorname{expit}(\\alpha) - \\operatorname{expit}(\\alpha)) = 0 $$\n关于 $\\delta$ 的一阶偏导数：\n$$ \\frac{\\partial L}{\\partial \\delta} = - \\frac{ -\\exp(-(\\alpha+\\gamma x+\\delta)) }{1+\\exp(-(\\alpha+\\gamma x+\\delta))} = 1 - \\operatorname{expit}(\\alpha+\\gamma x+\\delta) $$\n在 $(\\gamma, \\delta) = (0, 0)$ 处求值：\n$$ \\frac{\\partial L}{\\partial \\delta}\\bigg|_{(0,0)} = 1 - \\operatorname{expit}(\\alpha) $$\n该项相对于 $x$ 是一个常数，因此它只对截距的偏差有贡献。\n\n混合二阶偏导数：\n$$ \\frac{\\partial^2 L}{\\partial \\delta \\partial \\gamma} = \\frac{\\partial}{\\partial \\delta} \\left[ x(\\operatorname{expit}(\\alpha+\\gamma x)-\\operatorname{expit}(\\alpha+\\gamma x+\\delta)) \\right] = -x \\frac{\\partial}{\\partial \\delta} \\operatorname{expit}(\\alpha+\\gamma x+\\delta) $$\n使用 $\\frac{d}{dt}\\operatorname{expit}(t) = \\operatorname{expit}(t)(1-\\operatorname{expit}(t))$：\n$$ \\frac{\\partial^2 L}{\\partial \\delta \\partial \\gamma} = -x \\cdot \\operatorname{expit}(\\alpha+\\gamma x+\\delta)(1-\\operatorname{expit}(\\alpha+\\gamma x+\\delta)) $$\n在 $(\\gamma, \\delta) = (0, 0)$ 处求值：\n$$ \\frac{\\partial^2 L}{\\partial \\delta \\partial \\gamma}\\bigg|_{(0,0)} = -x \\cdot \\operatorname{expit}(\\alpha)(1-\\operatorname{expit}(\\alpha)) $$\n将这些代入泰勒展开式：\n$$ L(x; \\gamma, \\delta) \\approx (\\beta_0 + \\beta_1 x) + \\delta(1-\\operatorname{expit}(\\alpha)) - \\gamma\\delta x \\operatorname{expit}(\\alpha)(1-\\operatorname{expit}(\\alpha)) $$\n我们可以重新整理这个表达式，按 $x$ 的幂次对各项进行分组：\n$$ L(x; \\gamma, \\delta) \\approx [\\beta_0 + \\delta(1-\\operatorname{expit}(\\alpha))] + [\\beta_1 - \\gamma\\delta \\operatorname{expit}(\\alpha)(1-\\operatorname{expit}(\\alpha))] x $$\n这表明，在此近似阶下，完全病例的对数优势是 $x$ 的线性函数。完全病例逻辑斯谛回归将相合地估计这个线性函数的截距和斜率。估计的斜率 $\\tilde{\\beta}_1$ 是 $x$ 的系数：\n$$ \\tilde{\\beta}_1 \\approx \\beta_1 - \\gamma\\delta \\operatorname{expit}(\\alpha)(1-\\operatorname{expit}(\\alpha)) $$\n因此，斜率的一阶偏差为：\n$$ \\text{偏差} = \\tilde{\\beta}_1 - \\beta_1 \\approx -\\gamma\\delta \\operatorname{expit}(\\alpha)(1-\\operatorname{expit}(\\alpha)) $$\n现在，我们代入给定的参数值：$\\alpha = -1$, $\\gamma = 0.5$, $\\delta = -0.4$。\n$$ \\text{偏差} \\approx -(0.5)(-0.4) \\operatorname{expit}(-1)(1-\\operatorname{expit}(-1)) $$\n$$ \\text{偏差} \\approx 0.2 \\cdot \\operatorname{expit}(-1)(1-\\operatorname{expit}(-1)) $$\n我们有 $\\operatorname{expit}(-1) = \\frac{1}{1+\\exp(1)}$ 且 $1-\\operatorname{expit}(-1) = 1-\\frac{1}{1+\\exp(1)} = \\frac{\\exp(1)}{1+\\exp(1)}$。\n$$ \\text{偏差} \\approx 0.2 \\cdot \\frac{1}{1+\\exp(1)} \\cdot \\frac{\\exp(1)}{1+\\exp(1)} = \\frac{0.2\\exp(1)}{(1+\\exp(1))^2} $$\n使用数值 $\\exp(1) \\approx 2.71828$：\n$$ \\operatorname{expit}(-1) \\approx \\frac{1}{1+2.71828} = \\frac{1}{3.71828} \\approx 0.26894 $$\n$$ 1-\\operatorname{expit}(-1) \\approx 1 - 0.26894 = 0.73106 $$\n$$ \\text{偏差} \\approx 0.2 \\cdot (0.26894) \\cdot (0.73106) \\approx 0.2 \\cdot 0.19661 \\approx 0.039322 $$\n四舍五入到四位有效数字，偏差为 $0.03932$。",
            "answer": "$$\\boxed{0.03932}$$"
        }
    ]
}