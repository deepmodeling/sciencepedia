{
    "hands_on_practices": [
        {
            "introduction": "在任何单细胞分析流程中，首要步骤都是质量控制（QC），以滤除技术上失败的细胞。本练习将一个常见的、通常凭经验处理的问题形式化：如何设定线粒体读数分数和UMI计数的阈值。通过构建一个基于贝叶斯决策理论的成本敏感模型，您将从第一性原理出发，推导出最优决策阈值，从而超越简单的启发式方法，深入理解保留有效细胞与丢弃失效细胞之间的权衡。",
            "id": "4324377",
            "problem": "单细胞核糖核酸测序（scRNA-seq）预处理流程必须设定两个用于下游细胞类型鉴定和注释的质量控制阈值：线粒体读取分数阈值和独特分子标识（UMI）计数阈值。其目标是排除可能的技术失败（例如，死亡或受损的细胞），同时保留具有生物学信息的细胞。使用从第一性原理推导出的成本敏感贝叶斯决策规则来形式化这种权衡，从贝叶斯定理和期望损失最小化开始。\n\n假设一个随机抽样细胞的生成模型如下。设潜类别为 $Y \\in \\{F, V\\}$，其中 $F$ 表示技术失败细胞，$V$ 表示存活细胞。先验概率为 $\\pi_{F} = 0.05$ 和 $\\pi_{V} = 0.95$。决策为 $D \\in \\{\\text{保留}, \\text{丢弃}\\}$。保留一个失败细胞的损失为 $\\lambda_{F} = 10$，丢弃一个存活细胞的损失为 $\\lambda_{V} = 1$。正确的决策不产生损失。\n\n每个细胞测量两个可观察的质量指标：线粒体读取分数 $m \\in [0, 1]$ 和总 UMI 计数 $c \\in [0, \\infty)$。对于线粒体读取分数，条件密度被建模为 Beta 分布\n$$\nf_{M}(m \\mid F) = \\frac{1}{B(2, 10)} \\, m^{2-1} (1 - m)^{10-1}, \\quad f_{M}(m \\mid V) = \\frac{1}{B(1, 10)} \\, m^{1-1} (1 - m)^{10-1},\n$$\n其中 $B(\\cdot, \\cdot)$ 表示 Beta 函数。对于 UMI 计数，条件密度被建模为指数分布\n$$\nf_{C}(c \\mid F) = \\theta_{F} \\exp(-\\theta_{F} c), \\quad f_{C}(c \\mid V) = \\theta_{V} \\exp(-\\theta_{V} c),\n$$\n其中 $\\theta_{F} = 0.005$ 且 $\\theta_{V} = 0.00125$。\n\n一次只使用一个指标，定义阈值 $m^{\\ast}$ 和 $c^{\\ast}$，使得当 $m > m^{\\ast}$ 或 $c  c^{\\ast}$ 时，细胞被丢弃。从贝叶斯定理和期望损失原则出发，推导决策规则，并解析地求解 $m^{\\ast}$ 和 $c^{\\ast}$（用给定的 $\\pi_{F}$、$\\pi_{V}$、$\\lambda_{F}$、$\\lambda_{V}$ 和分布参数表示）。使用所提供的参数计算 $m^{\\ast}$ 和 $c^{\\ast}$ 的数值。\n\n在最终答案中，将这对值 $(m^{\\ast}, c^{\\ast})$ 报告为行矩阵。将 $m^{\\ast}$ 表示为 0 到 1 之间的无单位小数，将 $c^{\\ast}$ 表示为计数。将两个数字四舍五入至四位有效数字。",
            "solution": "该问题要求基于成本敏感的贝叶斯决策规则，为单细胞 RNA 测序数据中的质量控制推导最佳决策阈值。目标是最小化将细胞错误分类为存活细胞或技术失败细胞所带来的期望损失。\n\n设一个细胞的潜类别为 $Y \\in \\{F, V\\}$，其中 $F$ 表示技术失败，$V$ 表示存活细胞。给定的先验概率为 $\\pi_{F} = P(Y=F) = 0.05$ 和 $\\pi_{V} = P(Y=V) = 0.95$。\n需要做出的决策为 $D \\in \\{\\text{保留}, \\text{丢弃}\\}$。\n损失函数 $\\mathcal{L}(D, Y)$ 由错误决策的成本定义：\n-   保留一个失败细胞的损失：$\\mathcal{L}(\\text{保留}, F) = \\lambda_{F} = 10$。\n-   丢弃一个存活细胞的损失：$\\mathcal{L}(\\text{丢弃}, V) = \\lambda_{V} = 1$。\n-   正确的决策不产生损失：$\\mathcal{L}(\\text{保留}, V) = 0$ 和 $\\mathcal{L}(\\text{丢弃}, F) = 0$。\n\n决策规则是通过最小化以观测值 $x$ 为条件的期望损失来推导的。观测值 $x$ 将是线粒体读取分数 $m$ 或 UMI 计数 $c$。\n\n“丢弃”行为的条件期望损失为：\n$$\nR(\\text{丢弃} \\mid x) = \\mathcal{L}(\\text{丢弃}, V) P(Y=V \\mid x) + \\mathcal{L}(\\text{丢弃}, F) P(Y=F \\mid x) = \\lambda_{V} P(Y=V \\mid x)\n$$\n“保留”行为的条件期望损失为：\n$$\nR(\\text{保留} \\mid x) = \\mathcal{L}(\\text{保留}, V) P(Y=V \\mid x) + \\mathcal{L}(\\text{保留}, F) P(Y=F \\mid x) = \\lambda_{F} P(Y=F \\mid x)\n$$\n贝叶斯决策规则是选择使条件期望损失最小化的行为。因此，如果 $R(\\text{丢弃} \\mid x)  R(\\text{保留} \\mid x)$，我们决定“丢弃”该细胞，这可转化为：\n$$\n\\lambda_{V} P(Y=V \\mid x)  \\lambda_{F} P(Y=F \\mid x)\n$$\n使用贝叶斯定理，后验概率为 $P(Y \\mid x) = \\frac{f(x \\mid Y) P(Y)}{f(x)}$，其中 $f(x \\mid Y)$ 是类条件概率密度（似然），$P(Y)$ 是先验概率，$f(x)$ 是证据的边缘概率。将这些代入不等式得到：\n$$\n\\lambda_{V} \\frac{f(x \\mid V) \\pi_V}{f(x)}  \\lambda_{F} \\frac{f(x \\mid F) \\pi_F}{f(x)}\n$$\n由于 $f(x)$ 是一个密度函数，因此为正，我们可以将两边同乘以 $f(x)$ 并重新排列各项，形成一个似然比检验。丢弃细胞的区域由以下公式给出：\n$$\n\\frac{f(x \\mid F)}{f(x \\mid V)} > \\frac{\\lambda_V \\pi_V}{\\lambda_F \\pi_F}\n$$\n让我们定义决策阈值 $\\tau = \\frac{\\lambda_V \\pi_V}{\\lambda_F \\pi_F}$。我们将分别分析这两个指标。\n\n**1. 线粒体读取分数阈值 ($m^{\\ast}$)**\n\n对于这个指标，观测值为 $x = m$。条件密度由 Beta 分布给出：\n$$\nf_{M}(m \\mid F) = \\frac{1}{B(2, 10)} m^{1} (1 - m)^{9}\n$$\n$$\nf_{M}(m \\mid V) = \\frac{1}{B(1, 10)} m^{0} (1 - m)^{9}\n$$\n似然比为：\n$$\n\\frac{f_{M}(m \\mid F)}{f_{M}(m \\mid V)} = \\frac{\\frac{m(1-m)^9}{B(2, 10)}}{\\frac{(1-m)^9}{B(1, 10)}} = m \\frac{B(1, 10)}{B(2, 10)}\n$$\n使用 Beta 函数的恒等式 $B(a, b) = \\frac{\\Gamma(a)\\Gamma(b)}{\\Gamma(a+b)}$，我们可以简化 Beta 函数的比率：\n$$\n\\frac{B(1, 10)}{B(2, 10)} = \\frac{\\Gamma(1)\\Gamma(10)/\\Gamma(11)}{\\Gamma(2)\\Gamma(10)/\\Gamma(12)} = \\frac{\\Gamma(1)\\Gamma(12)}{\\Gamma(2)\\Gamma(11)} = \\frac{0! \\cdot 11!}{1! \\cdot 10!} = \\frac{11!}{10!} = 11\n$$\n所以，似然比就是 $11m$。决策规则是如果满足以下条件则丢弃：\n$$\n11m > \\tau \\implies m > \\frac{\\tau}{11}\n$$\n这与问题中给出的丢弃条件 $m > m^{\\ast}$ 相匹配。因此，阈值 $m^{\\ast}$ 为：\n$$\nm^{\\ast} = \\frac{\\tau}{11} = \\frac{1}{11} \\left( \\frac{\\lambda_V \\pi_V}{\\lambda_F \\pi_F} \\right)\n$$\n代入给定的数值：$\\lambda_V = 1$, $\\pi_V = 0.95$, $\\lambda_F = 10$, $\\pi_F = 0.05$。\n$$\nm^{\\ast} = \\frac{1}{11} \\left( \\frac{1 \\times 0.95}{10 \\times 0.05} \\right) = \\frac{1}{11} \\left( \\frac{0.95}{0.50} \\right) = \\frac{1.9}{11} \\approx 0.172727...\n$$\n四舍五入到四位有效数字，$m^{\\ast} = 0.1727$。\n\n**2. UMI 计数阈值 ($c^{\\ast}$)**\n\n对于这个指标，观测值为 $x = c$。条件密度由指数分布给出：\n$$\nf_{C}(c \\mid F) = \\theta_{F} \\exp(-\\theta_{F} c)\n$$\n$$\nf_{C}(c \\mid V) = \\theta_{V} \\exp(-\\theta_{V} c)\n$$\n似然比为：\n$$\n\\frac{f_{C}(c \\mid F)}{f_{C}(c \\mid V)} = \\frac{\\theta_{F} \\exp(-\\theta_{F} c)}{\\theta_{V} \\exp(-\\theta_{V} c)} = \\frac{\\theta_{F}}{\\theta_{V}} \\exp(-(\\theta_{F} - \\theta_{V})c)\n$$\n规则是如果该比率大于 $\\tau$ 则丢弃：\n$$\n\\frac{\\theta_{F}}{\\theta_{V}} \\exp(-(\\theta_{F} - \\theta_{V})c) > \\tau\n$$\n给定 $\\theta_{F} = 0.005$ 和 $\\theta_{V} = 0.00125$，我们有 $\\theta_{F} > \\theta_{V}$。因此，项 $\\theta_{F} - \\theta_{V}$ 是正的，函数 $\\exp(-(\\theta_{F} - \\theta_{V})c)$ 是 $c$ 的单调递减函数。这意味着不等式对于*小于*某个阈值的 $c$ 值成立。这与所述的丢弃规则 $c  c^{\\ast}$ 一致。为了找到 $c^{\\ast}$，我们在决策区域的边界求解 $c$：\n$$\n\\frac{\\theta_{F}}{\\theta_{V}} \\exp(-(\\theta_{F} - \\theta_{V})c^{\\ast}) = \\tau\n$$\n$$\n\\exp(-(\\theta_{F} - \\theta_{V})c^{\\ast}) = \\tau \\frac{\\theta_{V}}{\\theta_{F}}\n$$\n对两边取自然对数：\n$$\n-(\\theta_{F} - \\theta_{V})c^{\\ast} = \\ln\\left(\\tau \\frac{\\theta_{V}}{\\theta_{F}}\\right)\n$$\n$$\nc^{\\ast} = -\\frac{1}{\\theta_{F} - \\theta_{V}} \\ln\\left(\\tau \\frac{\\theta_{V}}{\\theta_{F}}\\right) = \\frac{1}{\\theta_{F} - \\theta_{V}} \\ln\\left(\\frac{1}{\\tau} \\frac{\\theta_{F}}{\\theta_{V}}\\right)\n$$\n代入 $\\tau = \\frac{\\lambda_V \\pi_V}{\\lambda_F \\pi_F}$，我们得到 $c^{\\ast}$ 的解析表达式：\n$$\nc^{\\ast} = \\frac{1}{\\theta_{F} - \\theta_{V}} \\ln\\left(\\frac{\\lambda_F \\pi_F \\theta_F}{\\lambda_V \\pi_V \\theta_V}\\right)\n$$\n现在，我们代入数值：\n$$\nc^{\\ast} = \\frac{1}{0.005 - 0.00125} \\ln\\left(\\frac{10 \\times 0.05 \\times 0.005}{1 \\times 0.95 \\times 0.00125}\\right)\n$$\n$$\nc^{\\ast} = \\frac{1}{0.00375} \\ln\\left(\\frac{0.0025}{0.0011875}\\right) = \\frac{1}{0.00375} \\ln\\left(\\frac{40}{19}\\right)\n$$\n$$\nc^{\\ast} \\approx \\frac{1}{0.00375} \\times 0.744432 \\approx 198.5152\n$$\n四舍五入到四位有效数字，$c^{\\ast} = 198.5$。\n\n推导出的阈值为 $m^{\\ast} \\approx 0.1727$ 和 $c^{\\ast} \\approx 198.5$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.1727  198.5 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "即使通过了初步的质量控制，单细胞数据中仍然普遍存在着由细胞周期等生物学过程引入的非目标变异，这可能掩盖真实的细胞类型特异性信号。本练习利用线性回归的框架，将去除混杂效应的过程阐释为数据向量在欧几里得空间中的正交投影。通过这种几何视角，您不仅能学会如何校正数据，还能推导出该过程可能移除多少与混杂因素相关的真实生物信号，从而深刻理解数据校正的效用与潜在风险。",
            "id": "4324318",
            "problem": "考虑单细胞核糖核酸测序 (scRNA-seq) 的测量数据，这些数据被组织成一个矩阵 $X \\in \\mathbb{R}^{n \\times p}$，其中 $n$ 是细胞数量，$p$ 是基因数量。$X$ 的行代表细胞，列代表基因。为了识别和注释细胞类型，人们通常希望去除由细胞周期引起的变异，因为这种变异可能会混淆特定于细胞类型的信号。设 $S \\in \\mathbb{R}^{n \\times q}$ 是一个包含 $q$ 个细胞水平协变量的矩阵，用于量化细胞周期状态（例如，$q=2$ 表示 $\\mathrm{G1/S}$ 和 $\\mathrm{G2/M}$ 程序的得分），并设 $\\mathbf{1} \\in \\mathbb{R}^{n}$ 表示全为1的截距向量。定义设计矩阵 $Z = [\\mathbf{1}\\;\\;S] \\in \\mathbb{R}^{n \\times (q+1)}$。假设 $X$ 已经过变换，达到了一个线性效应适用的尺度，并且每个基因在细胞间的表达变异可以分解为截距、细胞周期协变量和残差的加性贡献。\n\n仅从普通最小二乘法 (ordinary least squares, OLS) 作为残差平方和最小化器的定义以及 $\\mathbb{R}^{n}$ 中欧几里得投影的基本性质出发，完成以下任务：\n\n1. 对于索引为 $j \\in \\{1,\\dots,p\\}$ 的任意基因，推导细胞表达向量 $X_{\\cdot j} \\in \\mathbb{R}^{n}$ 对 $Z$ 的列进行回归的 OLS 解，然后获得一个矩阵表达式，表示对所有基因同时去除细胞周期效应后的残差化表达矩阵 $\\tilde{X} \\in \\mathbb{R}^{n \\times p}$。\n\n2. 为了探究去除细胞周期效应对于真实的类型差异是适宜还是有害，设 $T \\in \\mathbb{R}^{n}$ 是一个中心化的细胞类型对比向量（例如，$T$ 可能表示两种类型，其元素之和为零），代表细胞空间中真实类型身份变化的某个方向。设 $P_{S}$ 表示到 $S$ 的列空间上的正交投影算子，并设 $\\theta \\in [0,\\pi/2]$ 是向量 $T$ 与由 $S$ 的列张成的子空间之间的夹角，定义为 $\\cos(\\theta) = \\|P_{S}T\\|/\\|T\\|$。仅使用欧几里得空间中投影和夹角的定义，推导通过回归去除（并减去）细胞周期协变量而从 $T$ 的真实类型方差中移除的比例 $f(\\theta)$。\n\n以 $f(\\theta)$ 的闭式解析表达式的形式提供您的最终答案。无需进行数值取整。如果您引入任何缩写词，请在首次使用时给出其全称，后跟括号内的缩写。",
            "solution": "所提出的问题具有科学依据、适定且客观。它描述了系统生物医学中的一个标准且有效的程序，即使用线性回归校正单细胞核糖核酸测序 (scRNA-seq) 数据中的混杂变量。该问题使用精确的数学语言和线性代数的定义进行阐述，并包含足够的信息来推导出唯一且有意义的解。因此，该问题被认为是有效的，下面提供完整的解答。\n\n问题分为两部分。第一部分要求在回归去除混杂效应后，推导出残差化表达矩阵。第二部分要求计算通过此过程从特定信号向量中移除的方差比例。\n\n1.  残差化表达矩阵 $\\tilde{X}$ 的推导。\n\n设 $X_{\\cdot j} \\in \\mathbb{R}^{n}$ 表示任意基因 $j$ 的表达向量，其中 $j \\in \\{1, \\dots, p\\}$。该基因的表达作为截距和细胞周期协变量函数的线性模型由下式给出：\n$$X_{\\cdot j} = Z \\beta_j + \\epsilon_j$$\n其中 $Z = [\\mathbf{1}\\;\\;S] \\in \\mathbb{R}^{n \\times (q+1)}$ 是设计矩阵，$\\beta_j \\in \\mathbb{R}^{q+1}$ 是基因 $j$ 的回归系数向量，$\\epsilon_j \\in \\mathbb{R}^{n}$ 是残差向量。\n\n普通最小二乘法 (ordinary least squares, OLS) 旨在找到估计值 $\\hat{\\beta}_j$，以最小化残差平方和 (sum of squared residuals, SSR)，这等价于最小化残差向量 $\\epsilon_j$ 的欧几里得范数的平方。\n$$SSR(\\beta_j) = \\|\\epsilon_j\\|^2 = \\|X_{\\cdot j} - Z\\beta_j\\|^2$$\n为了找到最小值，我们可以展开平方范数并对 $\\beta_j$ 求导。\n$$SSR(\\beta_j) = (X_{\\cdot j} - Z\\beta_j)^T (X_{\\cdot j} - Z\\beta_j) = X_{\\cdot j}^T X_{\\cdot j} - 2 X_{\\cdot j}^T Z \\beta_j + \\beta_j^T Z^T Z \\beta_j$$\nSSR 关于 $\\beta_j$ 的梯度是：\n$$\\frac{\\partial(SSR)}{\\partial \\beta_j} = -2 Z^T X_{\\cdot j} + 2 Z^T Z \\beta_j$$\n将梯度设为零以找到最小值，得到正规方程：\n$$Z^T Z \\hat{\\beta}_j = Z^T X_{\\cdot j}$$\n假设矩阵 $Z^T Z$ 是可逆的（如果 $Z$ 的列是线性无关的，这在 OLS 中是一个标准假设），我们可以解出系数的 OLS 估计值：\n$$\\hat{\\beta}_j = (Z^T Z)^{-1} Z^T X_{\\cdot j}$$\n拟合值向量 $\\hat{X}_{\\cdot j}$ 是原始数据向量 $X_{\\cdot j}$ 在 $Z$ 的列空间 $\\mathrm{col}(Z)$ 上的投影。\n$$\\hat{X}_{\\cdot j} = Z \\hat{\\beta}_j = Z (Z^T Z)^{-1} Z^T X_{\\cdot j}$$\n我们将到 $\\mathrm{col}(Z)$ 上的正交投影矩阵定义为 $P_Z = Z (Z^T Z)^{-1} Z^T$。因此，拟合值为 $\\hat{X}_{\\cdot j} = P_Z X_{\\cdot j}$。\n\n基因 $j$ 的残差向量，代表在去除 $Z$ 中协变量的影响后基因的表达，是观测值与拟合值之间的差：\n$$\\tilde{X}_{\\cdot j} = X_{\\cdot j} - \\hat{X}_{\\cdot j} = X_{\\cdot j} - P_Z X_{\\cdot j} = (I - P_Z) X_{\\cdot j}$$\n其中 $I$ 是 $n \\times n$ 的单位矩阵。矩阵 $I - P_Z$ 是到与 $\\mathrm{col}(Z)$ 正交的子空间上的正交投影矩阵。\n\n为了获得整个残差化表达矩阵 $\\tilde{X} \\in \\mathbb{R}^{n \\times p}$，我们将此操作同时应用于每个基因（即 $X$ 的每一列）。这可以用一个单一的矩阵方程表示：\n$$\\tilde{X} = X - P_Z X = (I - P_Z) X$$\n\n2.  从真实类型对比向量 $T$ 中移除的方差比例的推导。\n\n我们被要求找出，通过回归去除细胞周期协变量（即矩阵 $S \\in \\mathbb{R}^{n \\times q}$ 的列），从中心化对比向量 $T \\in \\mathbb{R}^n$ 的真实类型方差中移除的比例 $f(\\theta)$。\n\n在回归分析的几何背景下，一个向量的“方差”对应于其平方和。由于向量 $T$ 是中心化的（其元素之和为零），其总平方和就是其欧几里得范数的平方，即 $\\|T\\|^2$。\n\n从向量 $T$ 中“回归去除” $S$ 中协变量效应的过程，意味着将 $T$ 投影到 $S$ 的列空间上，记作 $\\mathrm{col}(S)$。由此产生的拟合值向量，代表了 $T$ 中可被细胞周期协变量解释（并因此被“移除”）的部分，由下式给出：\n$$\\hat{T}_S = P_S T$$\n其中 $P_S$ 是到 $\\mathrm{col}(S)$ 上的正交投影矩阵。\n\n这个被移除分量的方差是其平方和，即 $\\|\\hat{T}_S\\|^2 = \\|P_S T\\|^2$。这个量是 $T$ 对 $S$ 回归中的解释平方和。由于 $T$ 是中心化的，这是解释方差的正确表达式。\n\n通过回归从 $T$ 的总方差中移除的比例是被移除方差与总方差的比值：\n$$f = \\frac{\\text{被移除方差}}{\\text{总方差}} = \\frac{\\|P_S T\\|^2}{\\|T\\|^2}$$\n问题提供了向量 $T$ 与子空间 $\\mathrm{col}(S)$ 之间的夹角 $\\theta \\in [0, \\pi/2]$ 的定义：\n$$\\cos(\\theta) = \\frac{\\|P_S T\\|}{\\|T\\|}$$\n这是一个向量与其在子空间上投影之间的夹角的余弦。将两边平方可得：\n$$\\cos^2(\\theta) = \\left( \\frac{\\|P_S T\\|}{\\|T\\|} \\right)^2 = \\frac{\\|P_S T\\|^2}{\\|T\\|^2}$$\n通过直接代入，我们发现被移除的方差比例 $f$ 等于夹角 $\\theta$ 的余弦的平方：\n$$f(\\theta) = \\cos^2(\\theta)$$\n这个结果量化了我们感兴趣的生物信号 ($T$) 与细胞周期信号 ($S$) 混杂的程度。如果 $T$ 与细胞周期子空间正交（$\\theta = \\pi/2$），则 $\\cos^2(\\theta) = 0$，没有方差被移除。如果 $T$ 完全位于细胞周期子空间内（$\\theta = 0$），则 $\\cos^2(\\theta) = 1$，所有方差都被移除，这表明在该模型下，“真实类型”信号与细胞周期效应无法区分。",
            "answer": "$$\\boxed{\\cos^2(\\theta)}$$"
        },
        {
            "introduction": "在完成数据处理和细胞类型注释后，关键一步是评估分类器的性能，尤其是在处理极不平衡的单细胞数据集时，某些稀有细胞类型可能只占极小部分。本练习将指导您从一个混淆矩阵出发，计算宏平均（macro-averaged）和微平均（micro-averaged）F1分数，这两种不同的评估指标。通过亲手推导，您将清晰地看到不同平均策略如何影响对模型性能的解读，并理解为何宏平均F1分数能更好地反映模型在稀有细胞类型上的表现，这对于发现新的或罕见的细胞群体至关重要。",
            "id": "4324372",
            "problem": "在一个单细胞转录组学研究中，一个监督分类器在细胞类型鉴定和注释过程中，将每个细胞分配到四种免疫细胞类型之一：T细胞（$\\mathrm{T}$）、B细胞（$\\mathrm{B}$）、单核细胞（$\\mathrm{Mo}$）和树突状细胞（$\\mathrm{DC}$）。总共有 $400$ 个细胞。真实标签的计数为：$\\mathrm{T}$ 细胞 $250$ 个，$\\mathrm{B}$ 细胞 $100$ 个，$\\mathrm{Mo}$ 细胞 $40$ 个，$\\mathrm{DC}$ 细胞 $10$ 个。得到的混淆矩阵 $M$（行按真实类别 $\\mathrm{T}, \\mathrm{B}, \\mathrm{Mo}, \\mathrm{DC}$ 的顺序索引；列按预测类别以相同顺序索引）如下：\n$$\nM \\;=\\;\n\\begin{pmatrix}\n220  15  10  5 \\\\\n8  85  5  2 \\\\\n4  3  30  3 \\\\\n1  1  3  5\n\\end{pmatrix}.\n$$\n仅从真阳性、假阳性、假阴性、精确率、召回率和调和平均数的核心定义出发，推导出四个类别中每个类别的F1分数，然后计算宏平均F1分数（各类F1分数的未加权算术平均数）和微平均F1分数（在计算精确率和召回率之前，通过汇集所有类别的决策来计算）。将两个最终数值答案四舍五入到 $4$ 位有效数字。在你的推导中，解释哪种平均方案在这种情况下能更好地反映对稀有细胞类型的性能。",
            "solution": "该问题涉及多类单标签分类。其基础由以下核心定义构成。对于给定的类别 $c$：\n- 真阳性（$TP_c$）是类别 $c$ 的实例被正确预测为 $c$ 的数量。\n- 假阳性（$FP_c$）是被预测为类别 $c$ 但实际上不属于 $c$ 的实例数量。\n- 假阴性（$FN_c$）是实际上属于类别 $c$ 但未被预测为 $c$ 的实例数量。\n- 精确率为 $P_c = \\frac{TP_c}{TP_c + FP_c}$。\n- 召回率为 $R_c = \\frac{TP_c}{TP_c + FN_c}$。\n- F1分数是精确率和召回率的调和平均数，根据调和平均数的定义可以写成：\n$$\nF1_c \\;=\\; \\frac{2\\,P_c\\,R_c}{P_c + R_c}.\n$$\n使用 $P_c = \\frac{TP_c}{TP_c + FP_c}$ 和 $R_c = \\frac{TP_c}{TP_c + FN_c}$，通过代入和代数运算可得到等价表达式：\n$$\nF1_c \\;=\\; \\frac{2\\,TP_c}{2\\,TP_c + FP_c + FN_c}.\n$$\n对于宏平均F1分数，我们计算各类别的 $F1_c$ 的未加权平均值。对于微平均F1分数，我们首先将所有类别的 $TP_c$、$FP_c$ 和 $FN_c$ 相加，得到全局的 $TP$、$FP$ 和 $FN$，然后使用相同的定义计算精确率和召回率，最后计算它们的调和平均数。\n\n我们从混淆矩阵 $M$ 中提取每个类别的 $TP_c$、$FP_c$ 和 $FN_c$。设类别顺序为 $\\mathrm{T}, \\mathrm{B}, \\mathrm{Mo}, \\mathrm{DC}$。对于每个类别 $c$：\n- $TP_c$ 是对角线元素 $M_{cc}$。\n- 列和是每个类别的总预测计数，行和是每个类别的总真实标签计数。那么 $FP_c$ 等于类别 $c$ 的列和减去 $TP_c$，$FN_c$ 等于类别 $c$ 的行和减去 $TP_c$。\n\n计算行和（真实标签总数）：$\\mathrm{T}$ 有 $250$ 个，$\\mathrm{B}$ 有 $100$ 个，$\\mathrm{Mo}$ 有 $40$ 个，$\\mathrm{DC}$ 有 $10$ 个；这些与给定的总数相符。计算列和（预测总数）：\n- 预测为 $\\mathrm{T}$ 的数量：$220 + 8 + 4 + 1 = 233$。\n- 预测为 $\\mathrm{B}$ 的数量：$15 + 85 + 3 + 1 = 104$。\n- 预测为 $\\mathrm{Mo}$ 的数量：$10 + 5 + 30 + 3 = 48$。\n- 预测为 $\\mathrm{DC}$ 的数量：$5 + 2 + 3 + 5 = 15$。\n\n现在计算每个类别的量和各类的F1分数。\n\n对于 $\\mathrm{T}$：\n- $TP_{\\mathrm{T}} = 220$。\n- $FP_{\\mathrm{T}} = 233 - 220 = 13$。\n- $FN_{\\mathrm{T}} = 250 - 220 = 30$。\n- $F1_{\\mathrm{T}} = \\frac{2 \\cdot 220}{2 \\cdot 220 + 13 + 30} = \\frac{440}{483}$。\n\n对于 $\\mathrm{B}$：\n- $TP_{\\mathrm{B}} = 85$。\n- $FP_{\\mathrm{B}} = 104 - 85 = 19$。\n- $FN_{\\mathrm{B}} = 100 - 85 = 15$。\n- $F1_{\\mathrm{B}} = \\frac{2 \\cdot 85}{2 \\cdot 85 + 19 + 15} = \\frac{170}{204} = \\frac{5}{6}$。\n\n对于 $\\mathrm{Mo}$：\n- $TP_{\\mathrm{Mo}} = 30$。\n- $FP_{\\mathrm{Mo}} = 48 - 30 = 18$。\n- $FN_{\\mathrm{Mo}} = 40 - 30 = 10$。\n- $F1_{\\mathrm{Mo}} = \\frac{2 \\cdot 30}{2 \\cdot 30 + 18 + 10} = \\frac{60}{88} = \\frac{15}{22}$。\n\n对于 $\\mathrm{DC}$：\n- $TP_{\\mathrm{DC}} = 5$。\n- $FP_{\\mathrm{DC}} = 15 - 5 = 10$。\n- $FN_{\\mathrm{DC}} = 10 - 5 = 5$。\n- $F1_{\\mathrm{DC}} = \\frac{2 \\cdot 5}{2 \\cdot 5 + 10 + 5} = \\frac{10}{25} = \\frac{2}{5}$。\n\n计算宏平均F1分数：\n$$\nF1_{\\mathrm{macro}} \\;=\\; \\frac{1}{4} \\left( \\frac{440}{483} + \\frac{5}{6} + \\frac{15}{22} + \\frac{2}{5} \\right).\n$$\n为了进行数值计算，近似每个项：\n- $\\frac{440}{483} \\approx 0.910971$,\n- $\\frac{5}{6} \\approx 0.833333$,\n- $\\frac{15}{22} \\approx 0.681818$,\n- $\\frac{2}{5} = 0.4$。\n和：$0.910971 + 0.833333 + 0.681818 + 0.4 = 2.826122$。除以 $4$ 得到\n$$\nF1_{\\mathrm{macro}} \\approx 0.7065305.\n$$\n四舍五入到 $4$ 位有效数字：$0.7065$。\n\n对于微平均F1分数，通过对所有类别求和来计算全局的 $TP$、$FP$ 和 $FN$：\n- $TP = 220 + 85 + 30 + 5 = 340$。\n- 总预测数为 $400$，因此 $FP = 400 - TP = 60$。根据单标签属性，$FN$ 也等于 $60$，因为每次错误分类都会为预测的类别贡献一个 $FP$，为真实的类别贡献一个 $FN$。\n全局精确率和召回率为\n$$\nP_{\\mathrm{micro}} = \\frac{TP}{TP + FP} = \\frac{340}{340 + 60} = \\frac{340}{400} = \\frac{17}{20} = 0.85,\n$$\n$$\nR_{\\mathrm{micro}} = \\frac{TP}{TP + FN} = \\frac{340}{340 + 60} = \\frac{340}{400} = \\frac{17}{20} = 0.85.\n$$\n因此\n$$\nF1_{\\mathrm{micro}} = \\frac{2\\,P_{\\mathrm{micro}}\\,R_{\\mathrm{micro}}}{P_{\\mathrm{micro}} + R_{\\mathrm{micro}}} = \\frac{2 \\cdot 0.85 \\cdot 0.85}{0.85 + 0.85} = 0.85,\n$$\n等价地，\n$$\nF1_{\\mathrm{micro}} = \\frac{2\\,TP}{2\\,TP + FP + FN} = \\frac{680}{800} = \\frac{17}{20} = 0.85.\n$$\n四舍五入到 $4$ 位有效数字：$0.8500$。\n\n关于哪种平均方案能更好地反映对稀有细胞类型的性能，宏平均在计算平均值时对每个类别给予相同的权重，而不受类别丰度的影响。在这个数据集中，$\\mathrm{DC}$ 和 $\\mathrm{Mo}$ 分别只有 $10$ 个和 $40$ 个细胞，是稀有类别，但它们的类别F1分数（$\\frac{2}{5}$ 和 $\\frac{15}{22}$）对 $F1_{\\mathrm{macro}}$ 的贡献与更常见的类别相同。相比之下，微平均汇集了所有决策，并由占主导地位的常见类别（$\\mathrm{T}$ 和 $\\mathrm{B}$，共 $350$ 个细胞）决定，得出的高 $F1_{\\mathrm{micro}}$ 主要反映了在丰富类型上的性能。因此，在系统生物医学细胞注释中评估对稀有细胞类型的性能时，$F1_{\\mathrm{macro}}$ 比 $F1_{\\mathrm{micro}}$ 能更好地反映对稀有类别的性能敏感性，而 $F1_{\\mathrm{micro}}$ 则主要反映由常见类别主导的总体准确性。",
            "answer": "$$\\boxed{\\begin{pmatrix}0.7065  0.8500\\end{pmatrix}}$$"
        }
    ]
}