{
    "hands_on_practices": [
        {
            "introduction": "RNA-seq测序产生的许多片段（fragments）可能同时与一个基因的多个转录本亚型（isoforms）兼容。因此，转录本定量的核心挑战在于如何解决这个“混合问题”：将这些模糊的片段归属回它们各自的来源转录本。通过将转录本表达丰度、片段兼容性和观测到的片段计数之间的关系构建为一个线性方程组，我们可以精确地求解此问题。 这项练习将通过一个具体的数值计算，揭示这一过程的神秘面纱，让您亲手将等价类（equivalence classes）的抽象概念转化为对亚型丰度的实际估算。",
            "id": "4393439",
            "problem": "一个与精准肿瘤学基因组合相关的基因表达三种转录本亚型，分别表示为 $T_{1}$、$T_{2}$ 和 $T_{3}$。一个经过偏差校正的RNA测序 (RNA-Seq) 分析流程根据与不同亚型集合的兼容性，将测序片段分为三个等价类，分别表示为 $E_{1}$、$E_{2}$ 和 $E_{3}$。该分析流程报告了每个等价类 $E_{i}$ 的观测片段计数 $c_{i}$，并将片段生成过程建模为一个混合模型：片段由转录本亚型 $T_{j}$ 生成，其比例与其未知的片段计数 $f_{j}$ 成正比；而一个来自 $T_{j}$ 的片段以一个已知的条件概率 $A_{ij}$ 贡献给等价类 $E_{i}$，该概率反映了比对兼容性和有效长度校正。每个等价类中的总期望计数是所有亚型贡献的总和。\n\n利用混合模型的核心定义和计数过程中期望的线性性，推导出一个显式线性系统。该系统通过一个其条目为上述条件概率的矩阵，将观测到的等价类计数与未知的转录本片段计数关联起来。然后，对于以下给出的偏差校正兼容性矩阵和观测计数，\n$$\nA \\;=\\;\n\\begin{pmatrix}\n0.5  0.3  0.2 \\\\\n0.2  0.4  0.4 \\\\\n0.3  0.3  0.4\n\\end{pmatrix},\n\\qquad\nc \\;=\\;\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix},\n$$\n构建相应的线性系统，并确定其是否存在满足非负性约束 $f_{1} \\geq 0$, $f_{2} \\geq 0$, $f_{3} \\geq 0$ 的解。如果可解，计算片段计数向量 $f = (f_{1}, f_{2}, f_{3})$ 的唯一解。将最终的片段计数向量表示为一个行矩阵。无需四舍五入。",
            "solution": "用户要求我解决一个关于转录本亚型定量的问题。\n\n**问题验证**\n\n**步骤1：提取已知条件**\n-   转录本亚型：$T_{1}$、$T_{2}$、$T_{3}$。\n-   等价类：$E_{1}$、$E_{2}$、$E_{3}$。\n-   每个等价类 $E_{i}$ 的观测片段计数由向量 $c$ 给出。\n-   每个转录本亚型 $T_{j}$ 的未知片段计数由向量 $f$ 给出，其分量为 $f_{j}$。\n-   来自 $T_{j}$ 的片段贡献给等价类 $E_{i}$ 的条件概率是 $A_{ij}$。\n-   模型被描述为一个混合模型：每个等价类中的总期望计数是所有亚型贡献的总和。\n-   具体的兼容性矩阵 $A$ 是：\n$$\nA \\;=\\;\n\\begin{pmatrix}\n0.5  0.3  0.2 \\\\\n0.2  0.4  0.4 \\\\\n0.3  0.3  0.4\n\\end{pmatrix}\n$$\n-   具体的观测计数向量 $c$ 是：\n$$\nc \\;=\\;\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\n-   解上施加了非负性约束：$f_{1} \\ge 0$, $f_{2} \\ge 0$, $f_{3} \\ge 0$。\n\n**步骤2：使用提取的已知条件进行验证**\n-   **科学依据：** 该问题描述了一个简化的但标准的、科学上有效的模型，用于从RNA-Seq数据中进行转录本亚型定量。使用等价类和混合模型来解卷积计数是广泛使用的生物信息学工具（例如 RSEM、Kallisto、Salmon）的基石。该公式与计算生物学中的既定原则一致。\n-   **适定性：** 这个问题是适定的。它要求推导并求解一个线性方程组。问题提供了所有必要的数据（一个矩阵 $A$ 和一个向量 $c$）以及清晰的指令。解的存在性和唯一性取决于矩阵 $A$ 的性质。$A$ 的行列式可以计算如下：\n    $$\n    \\det(A) = 0.5(0.4 \\cdot 0.4 - 0.4 \\cdot 0.3) - 0.3(0.2 \\cdot 0.4 - 0.4 \\cdot 0.3) + 0.2(0.2 \\cdot 0.3 - 0.4 \\cdot 0.3)\n    $$\n    $$\n    \\det(A) = 0.5(0.16 - 0.12) - 0.3(0.08 - 0.12) + 0.2(0.06 - 0.12)\n    $$\n    $$\n    \\det(A) = 0.5(0.04) - 0.3(-0.04) + 0.2(-0.06) = 0.02 + 0.012 - 0.012 = 0.02\n    $$\n    由于 $\\det(A) \\neq 0$，矩阵 $A$ 是可逆的，这意味着该线性系统存在唯一解。问题接着正确地要求检查这个唯一解是否满足非负性约束。\n-   **客观性：** 问题使用精确、客观和标准的科学术语陈述。它没有歧义或主观声明。\n-   **其他缺陷：** 问题没有表现出清单中的任何其他缺陷。数据是自洽的；例如，该矩阵的每一列之和都为1，如果 $A_{ij}$ 代表 $P(\\text{类别 } i | \\text{亚型 } j)$ 并且所有片段都被分配到其中一个类别，这是符合预期的。\n\n**步骤3：结论与行动**\n问题是有效的。将提供完整的解决方案。\n\n**求解推导**\n\n问题要求通过兼容性矩阵 $A$ 将观测到的等价类计数 ($c$) 与未知的转录本片段计数 ($f$) 关联起来。\n\n设 $f_{j}$ 是源自转录本亚型 $T_{j}$ 的未知片段数。设 $c_{i}$ 是分配给等价类 $E_{i}$ 的观测片段数。一个源自亚型 $T_{j}$ 的片段与等价类 $E_{i}$ 兼容（并因此贡献于该类）的条件概率由 $A_{ij}$ 给出。\n\n等价类 $E_{i}$ 中的总期望片段数，记为 $\\mathbb{E}[c_{i}]$，是每个转录本亚型期望贡献的总和。亚型 $T_{j}$ 对类别 $E_{i}$ 的期望贡献是来自 $T_{j}$ 的总片段数与分配的条件概率的乘积，即 $f_{j} A_{ij}$。\n\n对所有亚型 $j \\in \\{1, 2, 3\\}$求和，我们得到类别 $E_{i}$ 的总期望计数：\n$$\n\\mathbb{E}[c_{i}] = \\sum_{j=1}^{3} A_{ij} f_{j}\n$$\n在这个建模框架中，观测计数 $c_{i}$ 被视为其期望值 $\\mathbb{E}[c_{i}]$ 的最佳估计。因此，我们建立以下关系：\n$$\nc_{i} = \\sum_{j=1}^{3} A_{ij} f_{j}\n$$\n这组三个方程（对于 $i=1, 2, 3$）可以写成矩阵形式。设 $c$ 为观测计数的列向量，$f$ 为未知亚型计数的列向量。其关系为：\n$$\n\\begin{pmatrix} c_{1} \\\\ c_{2} \\\\ c_{3} \\end{pmatrix} = \\begin{pmatrix}\nA_{11}  A_{12}  A_{13} \\\\\nA_{21}  A_{22}  A_{23} \\\\\nA_{31}  A_{32}  A_{33}\n\\end{pmatrix}\n\\begin{pmatrix} f_{1} \\\\ f_{2} \\\\ f_{3} \\end{pmatrix}\n$$\n这就是线性系统 $c = Af$。\n\n现在，我们代入给定的 $A$ 和 $c$ 的数值：\n$$\n\\begin{pmatrix}\n0.5  0.3  0.2 \\\\\n0.2  0.4  0.4 \\\\\n0.3  0.3  0.4\n\\end{pmatrix}\n\\begin{pmatrix}\nf_{1} \\\\\nf_{2} \\\\\nf_{3}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\n为了求解向量 $f$，我们必须计算矩阵 $A$ 的逆矩阵，记为 $A^{-1}$。解则由 $f = A^{-1}c$ 给出。正如在验证阶段所确定的，$\\det(A) = 0.02$，因此逆矩阵存在。\n\n逆矩阵 $A^{-1}$ 通过公式 $A^{-1} = \\frac{1}{\\det(A)}\\text{adj}(A)$ 计算，其中 $\\text{adj}(A)$ 是 $A$ 的伴随矩阵（其代数余子式矩阵的转置）。\n\n$A$ 的代数余子式矩阵 $C$ 的条目为 $C_{ij} = (-1)^{i+j}M_{ij}$，其中 $M_{ij}$ 是条目 $A_{ij}$ 的余子式。\n$C_{11} = (0.4)(0.4) - (0.4)(0.3) = 0.16 - 0.12 = 0.04$\n$C_{12} = -((0.2)(0.4) - (0.4)(0.3)) = -(0.08 - 0.12) = 0.04$\n$C_{13} = (0.2)(0.3) - (0.4)(0.3) = 0.06 - 0.12 = -0.06$\n$C_{21} = -((0.3)(0.4) - (0.2)(0.3)) = -(0.12 - 0.06) = -0.06$\n$C_{22} = (0.5)(0.4) - (0.2)(0.3) = 0.20 - 0.06 = 0.14$\n$C_{23} = -((0.5)(0.3) - (0.3)(0.3)) = -(0.15 - 0.09) = -0.06$\n$C_{31} = (0.3)(0.4) - (0.2)(0.4) = 0.12 - 0.08 = 0.04$\n$C_{32} = -((0.5)(0.4) - (0.2)(0.2)) = -(0.20 - 0.04) = -0.16$\n$C_{33} = (0.5)(0.4) - (0.3)(0.2) = 0.20 - 0.06 = 0.14$\n\n代数余子式矩阵为 $C = \\begin{pmatrix} 0.04  0.04  -0.06 \\\\ -0.06  0.14  -0.06 \\\\ 0.04  -0.16  0.14 \\end{pmatrix}$。\n伴随矩阵是 $C$ 的转置：$\\text{adj}(A) = C^T = \\begin{pmatrix} 0.04  -0.06  0.04 \\\\ 0.04  0.14  -0.16 \\\\ -0.06  -0.06  0.14 \\end{pmatrix}$。\n\n逆矩阵是：\n$$\nA^{-1} = \\frac{1}{0.02} \\begin{pmatrix} 0.04  -0.06  0.04 \\\\ 0.04  0.14  -0.16 \\\\ -0.06  -0.06  0.14 \\end{pmatrix} = 50 \\begin{pmatrix} 0.04  -0.06  0.04 \\\\ 0.04  0.14  -0.16 \\\\ -0.06  -0.06  0.14 \\end{pmatrix} = \\begin{pmatrix} 2  -3  2 \\\\ 2  7  -8 \\\\ -3  -3  7 \\end{pmatrix}\n$$\n现在我们计算解向量 $f = A^{-1}c$：\n$$\n\\begin{pmatrix}\nf_{1} \\\\\nf_{2} \\\\\nf_{3}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n2  -3  2 \\\\\n2  7  -8 \\\\\n-3  -3  7\n\\end{pmatrix}\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\n$f$ 的分量是：\n$f_{1} = (2)(140) + (-3)(160) + (2)(150) = 280 - 480 + 300 = 100$\n$f_{2} = (2)(140) + (7)(160) + (-8)(150) = 280 + 1120 - 1200 = 200$\n$f_{3} = (-3)(140) + (-3)(160) + (7)(150) = -420 - 480 + 1050 = 150$\n\n片段计数向量的解是 $f = (100, 200, 150)^T$。\n\n最后一步是确定该解是否满足非负性约束：\n$f_{1} = 100 \\ge 0$\n$f_{2} = 200 \\ge 0$\n$f_{3} = 150 \\ge 0$\n所有分量都是非负的，因此该系统存在一个有效的、具有物理意义的解。片段计数向量的唯一解确实是 $(100, 200, 150)$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n100  200  150\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "获得原始片段计数后，必须进行标准化才能在样本间或基因间比较表达水平，但并非所有标准化方法都能胜任此任务。这项练习旨在揭示一度流行的 FPKM/RPKM 指标的一个关键缺陷：即使一个基因的总分子丰度保持不变，其亚型构成的改变也会导致其“平均转录本长度”发生变化，从而人为地改变其 FPKM 值。 通过亲手模拟这一效应，您将深刻而直观地理解为何 TPM 是更稳健的样本间比较指标，以及为何 FPKM 在差异表达分析中可能导致错误的结论。",
            "id": "4393431",
            "problem": "要求您使用模拟数据集，形式化并证明为何当存在差异性亚型使用时，每千碱基每百万映射读数（RPKM）和每千碱基每百万映射片段（FPKM）不适合用于样本间比较。请基于分子计数的基本定义和测序过程中的均匀随机抽样假设，设定背景为精准医疗和基因组诊断，特别是转录本发现和亚型定量。\n\n使用以下基础理论：\n- 分子生物学的中心法则：DNA转录为RNA，RNA分子被片段化并进行测序；测序过程大致均匀地从转录的碱基中抽样片段。\n- 在均匀抽样下，来自一个亚型的预期片段数与其分子数和其长度的乘积成正比；即，对于长度为 $L_j$、分子数为 $A_j$ 的亚型 $j$，其预期片段数 $C_j$ 满足 $C_j \\propto A_j \\cdot L_j$。\n- 每千碱基每百万映射片段（FPKM）的定义：对于一个基因（被视为一个长度为 $L_{\\text{gene}}$ 的单一特征），$$\\mathrm{FPKM}_{\\text{gene}} = \\frac{10^9 \\cdot C_{\\text{gene}}}{L_{\\text{gene}} \\cdot N},$$ 其中 $C_{\\text{gene}}$ 是映射到该基因的片段数，$L_{\\text{gene}}$ 是以碱基为单位的基因长度，$N$ 是样本中映射片段的总数。\n- 样本中亚型 $j$ 的类似长度校正率是 $$R_j = \\frac{C_j}{L_j},$$ 而基因水平的每百万转录本（TPM）可以通过聚合亚型来定义：$$\\mathrm{TPM}_{\\text{gene}} = \\frac{10^6 \\cdot \\sum_{j \\in \\text{gene}} R_j}{\\sum_{k \\in \\text{all isoforms}} R_k}.$$\n\n您将基于上述比例关系，模拟确定性的预期片段数，不考虑随机噪声。每个测试案例考虑两个基因。每个基因有两个亚型，具有指定的长度（以碱基为单位）和样本特定的亚型使用比例。对于样本 $S$，基因 $g$ 的总分子数为 $T_{g}^{S}$，亚型使用比例为 $\\{p_{gj}^{S}\\}$，其中 $\\sum_j p_{gj}^{S} = 1$。样本 $S$ 中的预期总“核苷酸质量”为 $$M_{\\text{total}}^{S} = \\sum_{g} \\sum_{j \\in g} T_{g}^{S} \\cdot p_{gj}^{S} \\cdot L_{gj}.$$ 给定样本 $S$ 中映射片段的总数 $N^{S}$，基因 $g$ 的亚型 $j$ 的预期片段数为 $$C_{gj}^{S} = N^{S} \\cdot \\frac{T_{g}^{S} \\cdot p_{gj}^{S} \\cdot L_{gj}}{M_{\\text{total}}^{S}},$$ 基因 $g$ 的预期片段数为 $$C_{g}^{S} = \\sum_{j \\in g} C_{gj}^{S}.$$\n\n请为每个基因 $g$ 计算两个样本 $A$ 和 $B$ 之间的以下量：\n1. 朴素的基因水平 FPKM 倍数变化 $$\\mathrm{FC}^{\\mathrm{FPKM}}_g = \\frac{\\mathrm{FPKM}_{g}^{B}}{\\mathrm{FPKM}_{g}^{A}},$$ 使用固定的基因长度 $L_{g}^{\\text{union}}$，该长度等于外显子并集长度（在这些测试案例中作为最大亚型长度提供）。\n2. 真实的分子倍数变化 $$\\mathrm{FC}^{\\mathrm{true}}_g = \\frac{T_{g}^{B}}{T_{g}^{A}}.$$\n3. 基因水平的 TPM 倍数变化 $$\\mathrm{FC}^{\\mathrm{TPM}}_g = \\frac{\\mathrm{TPM}_{g}^{B}}{\\mathrm{TPM}_{g}^{A}}.$$\n\n您的程序必须：\n- 实现上述确定性模型以计算样本 $A$ 和 $B$ 中每个基因 $g$ 的 $C_{gj}^{S}$、$C_{g}^{S}$、$\\mathrm{FPKM}_{g}^{S}$ 和 $\\mathrm{TPM}_{g}^{S}$。\n- 对每个测试案例，按 $[\\mathrm{FC}^{\\mathrm{FPKM}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{FPKM}}_{\\text{gene2}}, \\mathrm{FC}^{\\mathrm{true}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{true}}_{\\text{gene2}}, \\mathrm{FC}^{\\mathrm{TPM}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{TPM}}_{\\text{gene2}}]$ 的顺序输出一个包含六个浮点数的列表。\n\n测试套件：\n- 案例 1（一个基因存在强烈差异性亚型使用的理想情况）：\n  - 基因 1：亚型长度 $[800, 3200]$，外显子并集长度 $L_{1}^{\\text{union}} = 3200$。\n  - 基因 2：亚型长度 $[2000, 2000]$，外显子并集长度 $L_{2}^{\\text{union}} = 2000$。\n  - 样本 A：$T_{1}^{A} = 100000$，$T_{2}^{A} = 100000$，比例 $p_{1}^{A} = [0.8, 0.2]$，$p_{2}^{A} = [0.5, 0.5]$，总片段数 $N^{A} = 2000000$。\n  - 样本 B：$T_{1}^{B} = 100000$，$T_{2}^{B} = 100000$，比例 $p_{1}^{B} = [0.2, 0.8]$，$p_{2}^{B} = [0.5, 0.5]$，总片段数 $N^{B} = 2000000$。\n- 案例 2（一个基因的亚型长度相等，但另一个基因不等时的边缘情况）：\n  - 基因 1：亚型长度 $[1000, 1000]$，外显子并集长度 $L_{1}^{\\text{union}} = 1000$。\n  - 基因 2：亚型长度 $[500, 3000]$，外显子并集长度 $L_{2}^{\\text{union}} = 3000$。\n  - 样本 A：$T_{1}^{A} = 150000$，$T_{2}^{A} = 150000$，比例 $p_{1}^{A} = [0.7, 0.3]$，$p_{2}^{A} = [0.9, 0.1]$，总片段数 $N^{A} = 2000000$。\n  - 样本 B：$T_{1}^{B} = 150000$，$T_{2}^{B} = 150000$，比例 $p_{1}^{B} = [0.3, 0.7]$，$p_{2}^{B} = [0.1, 0.9]$，总片段数 $N^{B} = 2000000$。\n- 案例 3（文库大小不同且真实差异表达与亚型使用混淆的边缘情况）：\n  - 基因 1：亚型长度 $[500, 4500]$，外显子并集长度 $L_{1}^{\\text{union}} = 4500$。\n  - 基因 2：亚型长度 $[2500, 2500]$，外显子并集长度 $L_{2}^{\\text{union}} = 2500$。\n  - 样本 A：$T_{1}^{A} = 100000$，$T_{2}^{A} = 200000$，比例 $p_{1}^{A} = [0.9, 0.1]$，$p_{2}^{A} = [0.5, 0.5]$，总片段数 $N^{A} = 3000000$。\n  - 样本 B：$T_{1}^{B} = 50000$，$T_{2}^{B} = 200000$，比例 $p_{1}^{B} = [0.1, 0.9]$，$p_{2}^{B} = [0.5, 0.5]$，总片段数 $N^{B} = 1500000$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个以逗号分隔的列表，用方括号括起来，每个元素对应一个测试案例，本身也是一个按上述顺序排列的六个浮点数的列表，例如：$$[[x_1, x_2, x_3, x_4, x_5, x_6],[y_1, y_2, y_3, y_4, y_5, y_6],[z_1, z_2, z_3, z_4, z_5, z_6]]$$",
            "solution": "问题陈述经过严格验证，被认为是有效的。它在科学上基于转录组学和RNA测序数据分析的原理，问题设定良好，定义和数据完整清晰，表述客观。该问题正确地形式化了一个在 FPKM/RPKM 标准化方法中被广泛记录的偏差，并将其与 TPM 方法的特性进行对比，这是一个在基因组诊断和精准医疗中的关键概念。\n\n任务是通过一个确定性模拟来证明，为什么每千碱基每百万片段（FPKM）不适合用于基因表达的样本间比较，尤其是在发生差异性亚型使用时。我们将把它与分子数的真实倍数变化以及通过每百万转录本（TPM）计算出的倍数变化进行对比。\n\n### 基于原理的设计\n\n解决方案基于所提供的RNA测序模型，该模型假设从一个给定转录本亚型测序得到的预期片段数与其长度和其丰度（分子数）的乘积成正比。我们将实现一个函数，基于此原理计算给定样本的关键指标，然后用它来计算三个测试案例中两个样本（$A$ 和 $B$）之间的倍数变化。\n\n**1. 预期片段数模型**\n\n对于任何给定的样本 $S$，我们已知每个基因 $g$ 的总分子数 $T_g^S$，以及其每个亚型 $j$ 的比例 $p_{gj}^S$。因此，基因 $g$ 的特定亚型 $j$ 的分子数为 $A_{gj}^S = T_g^S \\cdot p_{gj}^S$。\n\n核心假设是片段从所有转录的核苷酸的总池中均匀抽样。一个亚型的总“核苷酸质量”是其丰度乘以其长度，即 $A_{gj}^S \\cdot L_{gj}$。样本中的总核苷酸质量是所有基因的所有亚型的总和：\n$$M_{\\text{total}}^S = \\sum_{\\text{all genes } k} \\sum_{\\text{isoforms } i \\in k} T_k^S \\cdot p_{ki}^S \\cdot L_{ki}$$\n\n对应于亚型 $gj$ 的总文库比例是其核苷酸质量除以总核苷酸质量。因此，给定测序片段总数 $N^S$，亚型 $gj$ 的预期片段数为：\n$$C_{gj}^S = N^S \\cdot \\frac{T_g^S \\cdot p_{gj}^S \\cdot L_{gj}}{M_{\\text{total}}^S}$$\n\n基因 $g$ 的总片段数是其各亚型片段数之和：\n$$C_g^S = \\sum_{j \\in g} C_{gj}^S$$\n\n**2. 定量指标和倍数变化**\n\n我们将为每个基因 $g$ 计算样本 $A$ 和 $B$ 之间的三种倍数变化。\n\n- **真实倍数变化 ($\\mathrm{FC}^{\\mathrm{true}}_g$):** 这是基准事实，定义为两个样本中该基因总分子数的比率。\n  $$\\mathrm{FC}^{\\mathrm{true}}_g = \\frac{T_g^B}{T_g^A}$$\n\n- **FPKM 倍数变化 ($\\mathrm{FC}^{\\mathrm{FPKM}}_g$):** 一个基因的 FPKM 定义为：\n  $$\\mathrm{FPKM}_g^S = \\frac{10^9 \\cdot C_g^S}{L_g^{\\text{union}} \\cdot N^S}$$\n  其中 $L_g^{\\text{union}}$ 是一个固定的、代表性的基因长度（此处为外显子并集长度）。倍数变化是 FPKM 值的比率：\n  $$\\mathrm{FC}^{\\mathrm{FPKM}}_g = \\frac{\\mathrm{FPKM}_g^B}{\\mathrm{FPKM}_g^A} = \\frac{C_g^B / (L_g^{\\text{union}} \\cdot N^B)}{C_g^A / (L_g^{\\text{union}} \\cdot N^A)} = \\frac{C_g^B}{C_g^A} \\cdot \\frac{N^A}{N^B}$$\n  FPKM 的问题在于，$C_g^S$ 不仅取决于样本 $S$ 中基因 $g$ 的*平均转录本长度* $\\bar{L}_g^S = \\sum_{j \\in g} p_{gj}^S L_{gj}$，还取决于整个文库的总核苷酸质量 $M_{\\text{total}}^S$。基因 $g$ 的亚型比例变化会改变 $\\bar{L}_g^S$，而*任何*基因的表达或亚型使用的变化都会改变 $M_{\\text{total}}^S$。这两种效应都会产生非线性偏差，导致 $\\mathrm{FC}^{\\mathrm{FPKM}}_g$ 偏离 $\\mathrm{FC}^{\\mathrm{true}}_g$。\n\n- **TPM 倍数变化 ($\\mathrm{FC}^{\\mathrm{TPM}}_g$):** TPM 旨在表示样本中一个基因转录本的相对摩尔浓度。它基于长度标准化的计数 $R_j = C_j/L_j$ 来定义：\n  $$\\mathrm{TPM}_g^S = \\frac{10^6 \\cdot \\sum_{j \\in g} R_j^S}{\\sum_{\\text{all isoforms } k} R_k^S}$$\n  一个关键的洞见是，这个表达式可以显著简化。由于 $R_j^S = (N^S/M_{\\text{total}}^S) \\cdot A_j^S$，涉及文库大小和组成的项会抵消掉：\n  $$\\mathrm{TPM}_g^S = 10^6 \\cdot \\frac{\\sum_{j \\in g} A_{gj}^S}{\\sum_{\\text{all isoforms } k} A_k^S} = 10^6 \\cdot \\frac{T_g^S}{\\sum_{\\text{all genes } k} T_k^S}$$\n  这表明 TPM 与基因的分子数占样本中总分子数的比例成正比。因此，TPM 的倍数变化为：\n  $$\\mathrm{FC}^{\\mathrm{TPM}}_g = \\frac{\\mathrm{TPM}_g^B}{\\mathrm{TPM}_g^A} = \\frac{T_g^B / \\sum_k T_k^B}{T_g^A / \\sum_k T_k^A} = \\left(\\frac{T_g^B}{T_g^A}\\right) \\cdot \\left(\\frac{\\sum_k T_k^A}{\\sum_k T_k^B}\\right) = \\mathrm{FC}^{\\mathrm{true}}_g \\cdot \\frac{\\text{A中的总分子数}}{\\text{B中的总分子数}}$$\n  TPM 纠正了 FPKM 中基于长度的偏差。然而，它的倍数变化仍然与真实倍数变化不同，除非每个样本的总分子数恒定，这是一个通常不成立的强假设。\n\n**3. 实现**\n\n实现将包括一个主函数，用于遍历所有测试案例。将设计一个辅助函数，为单个样本执行计算，输入包括基因分子数、亚型比例和长度以及总片段数。该函数将计算并返回每个基因的 FPKM 和 TPM 值。主函数将为样本 $A$ 和 $B$ 调用此辅助函数，然后计算并收集每个测试案例所需的六个倍数变化值。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by iterating through test cases and calculating fold-changes\n    for FPKM, true molecule count, and TPM between two samples.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (happy path with strong differential isoform usage in one gene)\n        {\n            \"gene_isoform_lengths\": np.array([[800, 3200], [2000, 2000]], dtype=float),\n            \"union_lengths\": np.array([3200, 2000], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([100000, 100000], dtype=float),\n                \"isoform_proportions\": np.array([[0.8, 0.2], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([100000, 100000], dtype=float),\n                \"isoform_proportions\": np.array([[0.2, 0.8], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            }\n        },\n        # Case 2 (edge case where one gene’s isoforms have equal lengths)\n        {\n            \"gene_isoform_lengths\": np.array([[1000, 1000], [500, 3000]], dtype=float),\n            \"union_lengths\": np.array([1000, 3000], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([150000, 150000], dtype=float),\n                \"isoform_proportions\": np.array([[0.7, 0.3], [0.9, 0.1]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([150000, 150000], dtype=float),\n                \"isoform_proportions\": np.array([[0.3, 0.7], [0.1, 0.9]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            }\n        },\n        # Case 3 (different library sizes and true differential expression)\n        {\n            \"gene_isoform_lengths\": np.array([[500, 4500], [2500, 2500]], dtype=float),\n            \"union_lengths\": np.array([4500, 2500], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([100000, 200000], dtype=float),\n                \"isoform_proportions\": np.array([[0.9, 0.1], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 3000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([50000, 200000], dtype=float),\n                \"isoform_proportions\": np.array([[0.1, 0.9], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 1500000.0\n            }\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # Calculate metrics for Sample A\n        fpkm_A, tpm_A = calculate_metrics(\n            case[\"sample_A\"][\"gene_molecule_counts\"],\n            case[\"sample_A\"][\"isoform_proportions\"],\n            case[\"gene_isoform_lengths\"],\n            case[\"union_lengths\"],\n            case[\"sample_A\"][\"total_mapped_fragments\"]\n        )\n\n        # Calculate metrics for Sample B\n        fpkm_B, tpm_B = calculate_metrics(\n            case[\"sample_B\"][\"gene_molecule_counts\"],\n            case[\"sample_B\"][\"isoform_proportions\"],\n            case[\"gene_isoform_lengths\"],\n            case[\"union_lengths\"],\n            case[\"sample_B\"][\"total_mapped_fragments\"]\n        )\n\n        # Calculate fold-changes\n        fc_fpkm = fpkm_B / fpkm_A\n        fc_true = case[\"sample_B\"][\"gene_molecule_counts\"] / case[\"sample_A\"][\"gene_molecule_counts\"]\n        fc_tpm = tpm_B / tpm_A\n\n        # Assemble results in the specified order\n        case_results = [\n            fc_fpkm[0], fc_fpkm[1],\n            fc_true[0], fc_true[1],\n            fc_tpm[0], fc_tpm[1]\n        ]\n        all_results.append(case_results)\n\n    # Format the final output string\n    output_str = f\"[{','.join([f'[{\",\".join(map(str, res))}]' for res in all_results])}]\"\n    print(output_str)\n\n\ndef calculate_metrics(gene_molecule_counts, isoform_proportions, isoform_lengths, union_lengths, total_mapped_fragments):\n    \"\"\"\n    Calculates FPKM and TPM values for a single sample.\n\n    Args:\n        gene_molecule_counts (np.array): Array of total molecule counts per gene (T_g).\n        isoform_proportions (np.array): 2D array of isoform proportions per gene (p_gj).\n        isoform_lengths (np.array): 2D array of isoform lengths per gene (L_gj).\n        union_lengths (np.array): Array of gene union-of-exons lengths.\n        total_mapped_fragments (float): Total number of mapped fragments in the sample (N).\n\n    Returns:\n        tuple[np.array, np.array]: A tuple containing arrays of FPKM values and TPM values.\n    \"\"\"\n    # Reshape gene_molecule_counts to allow broadcasting\n    T_g = gene_molecule_counts[:, np.newaxis]\n\n    # Calculate molecule count per isoform: A_gj = T_g * p_gj\n    isoform_molecule_counts = T_g * isoform_proportions\n    \n    # Calculate nucleotide mass per isoform: A_gj * L_gj\n    nucleotide_mass_per_isoform = isoform_molecule_counts * isoform_lengths\n    \n    # Calculate total nucleotide mass for the sample: M_total\n    M_total = np.sum(nucleotide_mass_per_isoform)\n    \n    # Calculate expected fragment counts per isoform: C_gj\n    isoform_fragment_counts = total_mapped_fragments * nucleotide_mass_per_isoform / M_total\n    \n    # Calculate expected fragment counts per gene: C_g\n    gene_fragment_counts = np.sum(isoform_fragment_counts, axis=1)\n    \n    # Calculate FPKM for each gene\n    fpkm_values = (1e9 * gene_fragment_counts) / (union_lengths * total_mapped_fragments)\n    \n    # Calculate TPM for each gene using the simplified and stable formula:\n    # TPM_g = 1e6 * (T_g / sum(T_all))\n    # This is mathematically equivalent to the definition based on fragment counts.\n    total_molecules_in_sample = np.sum(gene_molecule_counts)\n    tpm_values = 1e6 * gene_molecule_counts / total_molecules_in_sample\n    \n    return fpkm_values, tpm_values\n\nsolve()\n\n```"
        },
        {
            "introduction": "在实践中，即使有先进的算法，仅凭短读长测序数据（short-read sequencing）仍有一些基因位点存在固有的模糊性，使其不同亚型无法被区分和定量。此问题将这个挑战用线性代数的语言描述为：当量化模型的设计矩阵（design matrix）不是满秩（full rank）时，该问题便变得不可识别（non-identifiable）。 该练习引入了一种现代解决方案——靶向长读长测序（targeted long-read sequencing），它为每个完整的亚型提供了直接、明确的证据。这项高级实践将挑战您像实验设计者一样思考，计算需要多少长读长数据才能以给定的统计置信度解决这种模糊性，从而架起理论上的可识别性与实际实验规划之间的桥梁。",
            "id": "4393520",
            "problem": "在精准医疗的转录本水平定量中，考虑一个发生可变剪接的基因座，该基因座产生 $3$ 种异构体：$\\mathcal{I}_{1}$ 的外显子链为 $E_{1}\\text{-}E_{2}\\text{-}E_{3}$，$\\mathcal{I}_{2}$ 的外显子链为 $E_{1}\\text{-}E_{2b}\\text{-}E_{3}$，以及发生外显子跳跃的 $\\mathcal{I}_{3}$，其外显子链为 $E_{1}\\text{-}E_{3}$。您正在使用短读长核糖核酸测序 (RNA-seq)，其单端读段长度为 $L=75$ 个核苷酸，并且要求剪接点比对时，剪接点两侧至少有 $s=15$ 个核苷酸的锚定区。各外显子的长度为 $|E_{1}|=180$、 $|E_{2}|=12$、 $|E_{2b}|=13$ 和 $|E_{3}|=220$ 个核苷酸。在这些参数下，由于 $|E_2| < s$ 和 $|E_{2b}| < s$，跨越 $E_1-E_2$、$E_2-E_3$、$E_1-E_{2b}$ 或 $E_{2b}-E_3$ 连接点的读段无法被明确比对。因此，只有跨越 $E_1-E_3$ 连接点的读段能唯一地识别 $\\mathcal{I}_3$。所有其他读段（例如，那些完全落在 $E_1$ 或 $E_3$ 内的读段）都与所有三种异构体兼容，从而导致了一个秩亏的、不可识别的定量问题。该问题的设计矩阵为 $A_{\\text{short}}=\\begin{pmatrix} 1 & 1 & 1 \\\\ 0 & 0 & 1 \\end{pmatrix}$，其秩为2，小于异构体的数量3。\n\n为了解决这个问题，您计划通过靶向长读长测序来增强实验，该测序为每个测序的分子提供明确的异构体身份。假设长读长测序过程是从一个分类分布中独立抽样 $n$ 个分子，其中抽取到 $\\mathcal{I}_1, \\mathcal{I}_2, \\mathcal{I}_3$ 的概率分别为 $f_1=0.6, f_2=0.3, f_3=0.1$。为了使整个系统变得可识别（即，增广后的设计矩阵达到满列秩），您需要在长读长数据中至少观测到每种异构体一次。\n\n请计算需要测序的最少长读段数 $n$，以确保观测到所有三种异构体的概率至少为 $0.95$。",
            "solution": "对所述问题进行验证。\n\n### 步骤1：提取已知条件\n- 异构体数量：$3$；记为 $\\mathcal{I}_{1}$、$\\mathcal{I}_{2}$、$\\mathcal{I}_{3}$。\n- 异构体结构：$\\mathcal{I}_{1}$ 为 $E_{1}\\text{-}E_{2}\\text{-}E_{3}$，$\\mathcal{I}_{2}$ 为 $E_{1}\\text{-}E_{2b}\\text{-}E_{3}$，$\\mathcal{I}_{3}$ 为 $E_{1}\\text{-}E_{3}$。\n- 短读段长度：$L=75$ 个核苷酸。\n- 剪接点锚定区大小：$s=15$ 个核苷酸。\n- 外显子长度：$|E_{1}|=180$、$|E_{2}|=12$、$|E_{2b}|=13$、$|E_{3}|=220$ 个核苷酸。\n- 短读长设计矩阵：$A_{\\text{short}}=\\begin{pmatrix} 1  1  1 \\\\ 0  0  1 \\end{pmatrix}$。题目说明该矩阵的秩小于 $3$。\n- 提议的实验变更：通过靶向全长cDNA长读长测序进行增强。\n- 长读段的建模：$n$ 个长读段中的每一个都贡献一个与其观测到的异构体相对应的独热行向量。\n- 异构体比例：$f_{1}=0.6$、$f_{2}=0.3$、$f_{3}=0.1$。\n- 抽样模型：$n$ 个长读段是从概率为 $(f_1, f_2, f_3)$ 的分类分布中进行的独立观测。\n- 目标：找到最小的整数 $n$，使得增广设计矩阵以至少 $0.95$ 的概率具有满列秩。\n- 满列秩的条件：在 $n$ 个长读段中，三种异构体中的每一种都至少被观测到一次。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题描述了基因组学中的一个常见挑战：由于共享外显子和模糊读段，从短读长RNA-seq数据中无法识别异构体丰度。给定的参数（读段长度、外显子大小、锚定区长度）是符合实际的。短读长设计矩阵正确地反映了可用信息：一个特征对与任何异构体体部兼容的读段进行计数，另一个特征对特定于 $\\mathcal{I}_3$ 的外显子跳跃剪接点的读段进行计数。$A_{\\text{short}}$ 的秩为 $2$，小于异构体的数量 ($3$)，这证实了可识别性问题。\n\n提议的解决方案，即用长读长数据进行增强，是解决此类模糊性的标准且强大的技术。将每个长读段建模为一个完美的、异构体分辨的并贡献一个独热向量的观测值，这是对其在线性系统中作用的正确表示。增广矩阵达到满列秩，当且仅当添加的独热向量集合能张成 $\\mathbb{R}^3$。这恰好在基向量 $e_1^T = (1, 0, 0)$、$e_2^T = (0, 1, 0)$ 和 $e_3^T = (0, 0, 1)$ 都存在时发生，意味着每种异构体都至少被观测到一次。\n\n问题的概率部分定义明确。异构体比例作为分类分布的概率给出，并且它们的和正确地等于 $1$ ($0.6+0.3+0.1=1.0$)。任务是找到最小的试验次数 $n$，以给定的概率达到某个成功条件（观测到所有类别）。这是一个经典的概率问题（与赠券收集者问题相关），它被置于一个科学上有效且适定的背景中。该问题是自洽的、客观的且具有科学依据的。\n\n### 步骤3：结论与行动\n问题有效。将提供一个合理的解决方案。\n\n### 解答\n问题是找到最小的整数 $n$，使得从一个包含 $n$ 个独立抽取的分子样本中，观测到 $3$ 种异构体中每一种至少一个分子的概率至少为 $0.95$。抽取到异构体 $\\mathcal{I}_{1}$、$\\mathcal{I}_{2}$ 或 $\\mathcal{I}_{3}$ 的单个分子的概率由它们的比例给出：$p_{1} = 0.6$、$p_{2} = 0.3$ 和 $p_{3} = 0.1$。\n\n设 $E$ 为经过 $n$ 次抽取后，我们观测到每种异构体至少一次的事件。我们正在寻找最小的整数 $n$，使得 $P(E) \\ge 0.95$。\n\n计算其补事件 $E^c$ 的概率更为直接，即至少有一种异构体*未*被观测到的事件。条件 $P(E) \\ge 0.95$ 等价于 $P(E^c) \\le 0.05$。\n\n设 $A_i$ 为在 $n$ 次抽取中未观测到异构体 $\\mathcal{I}_i$ 的事件。事件 $E^c$ 是这些事件的并集：$E^c = A_1 \\cup A_2 \\cup A_3$。\n\n我们使用容斥原理来计算这个并集的概率：\n$$P(E^c) = P(A_1 \\cup A_2 \\cup A_3) = \\sum_{i=1}^3 P(A_i) - \\sum_{1 \\le i  j \\le 3} P(A_i \\cap A_j) + P(A_1 \\cap A_2 \\cap A_3)$$\n\n我们来计算每一项：\n单次抽取*不是*异构体 $\\mathcal{I}_i$ 的概率是 $(1-p_i)$。由于 $n$ 次抽取是独立的，所以在 $n$ 次抽取中都没有抽到异构体 $\\mathcal{I}_i$ 的概率是 $P(A_i) = (1-p_i)^n$。\n- $P(A_1) = (1-p_1)^n = (1-0.6)^n = (0.4)^n$\n- $P(A_2) = (1-p_2)^n = (1-0.3)^n = (0.7)^n$\n- $P(A_3) = (1-p_3)^n = (1-0.1)^n = (0.9)^n$\n\n交集 $P(A_i \\cap A_j)$ 的概率是指既没有观测到异构体 $\\mathcal{I}_i$ 也没有观测到 $\\mathcal{I}_j$ 的概率。这意味着所有 $n$ 次抽取都必须是第三种异构体 $\\mathcal{I}_k$（其中 $k \\neq i, j$）。这个概率是 $p_k^n = (1-p_i-p_j)^n$。\n- $P(A_1 \\cap A_2) = p_3^n = (0.1)^n$\n- $P(A_1 \\cap A_3) = p_2^n = (0.3)^n$\n- $P(A_2 \\cap A_3) = p_1^n = (0.6)^n$\n\n三重交集 $P(A_1 \\cap A_2 \\cap A_3)$ 的概率是三种异构体都没有被观测到的概率。由于这些是仅有的可能性，这个事件是不可能发生的，其概率为 $0$。\n\n将这些代入容斥公式：\n$$P(E^c) = \\left[ (0.4)^n + (0.7)^n + (0.9)^n \\right] - \\left[ (0.1)^n + (0.3)^n + (0.6)^n \\right] + 0$$\n设 $g(n) = P(E^c) = (0.9)^n + (0.7)^n + (0.4)^n - (0.6)^n - (0.3)^n - (0.1)^n$。我们需要找到最小的整数 $n$ 使得 $g(n) \\le 0.05$。\n\n函数 $g(n)$ 是底数小于 $1$ 的指数项之和，因此对于 $n>0$ 它是 $n$ 的单调递减函数。我们可以通过测试整数值来找到所需的 $n$。对于大的 $n$，主导项是 $(0.9)^n$。可以通过求解 $(0.9)^n \\approx 0.05$ 得到一个粗略的估计，这给出 $n \\approx \\frac{\\ln(0.05)}{\\ln(0.9)} \\approx \\frac{-2.9957}{-0.1054} \\approx 28.4$。这表明答案可能在 $n=28$ 或 $n=29$ 附近。\n\n我们来测试 $n=28$：\n$g(28) = (0.9)^{28} + (0.7)^{28} + (0.4)^{28} - (0.6)^{28} - (0.3)^{28} - (0.1)^{28}$\n$g(28) \\approx 0.0523356 + 0.0000401 + (7.2 \\times 10^{-12}) - 0.00000022 - (2.3 \\times 10^{-14}) - (1 \\times 10^{-28})$\n$g(28) \\approx 0.0523755 - 0.00000022 \\approx 0.052375$\n由于 $g(28) > 0.05$，$n=28$ 是不够的。\n\n现在我们来测试 $n=29$：\n$g(29) = (0.9)^{29} + (0.7)^{29} + (0.4)^{29} - (0.6)^{29} - (0.3)^{29} - (0.1)^{29}$\n$g(29) \\approx 0.0471020 + 0.0000281 + (2.9 \\times 10^{-12}) - 0.00000013 - (6.9 \\times 10^{-15}) - (1 \\times 10^{-29})$\n$g(29) \\approx 0.0471301 - 0.00000013 \\approx 0.047130$\n由于 $g(29) \\approx 0.04713 \\le 0.05$，对于 $n=29$，条件得到满足。\n\n由于 $g(n)$ 是一个递减函数，$n=29$ 是使得观测到所有三种异构体的概率至少为 $0.95$ 的最小整数。",
            "answer": "$$\\boxed{29}$$"
        }
    ]
}