{
    "hands_on_practices": [
        {
            "introduction": "在分析RNA测序数据时，原始的读数计数（read counts）会受到测序深度或文库大小差异的影响，因此不能直接比较。第一步关键操作是进行归一化，以确保样本间的比较是公平的。本练习将指导您完成一个核心的归一化步骤——使用比率中位数法（median-of-ratios method）计算样本特异性的“大小因子”（size factors），并将其作为偏移量（offset）纳入一个简化的泊松广义线性模型（GLM）中，从而估算基因在不同条件下的表达差异 ()。这个从头开始的计算过程将帮助您具体地理解归一化如何与统计模型相结合，以揭示真实的生物学效应。",
            "id": "4333076",
            "problem": "一个包含$4$个肿瘤样本的样本组通过高通量测序进行了分析，得到了$5$个基因的整数读数计数。样本$\\{1,2\\}$属于条件$\\mathrm{A}$，样本$\\{3,4\\}$属于条件$\\mathrm{B}$。观测到的计数$K_{ij}$（样本$i$中的基因$j$）如下：\n\n- 基因 $G_{1}$：$(75, 110, 100, 140)$\n- 基因 $G_{2}$：$(225, 330, 300, 420)$\n- 基因 $G_{3}$：$(38, 55, 50, 70)$\n- 基因 $G_{4}$：$(150, 220, 400, 560)$\n- 基因 $G_{5}$：$(90, 132, 120, 168)$\n\n假设标准的比率中位数归一化方法适用于这些数据。仅使用在所有样本中都具有严格为正的计数的基因，通过几何平均法计算样本特异性的大小因子$s_{i}$：对每个基因$j$，计算其跨样本几何平均值$g_{j}$；对每个样本$i$，计算符合条件的基因的比率$r_{ij} = K_{ij} / g_{j}$；将$s_{i}$设置为这些比率的样本特异性中位数。你可以使定义的$s_{i}$相差一个公共乘法常数；不要对它们进行重新缩放。\n\n然后，将这些$s_{i}$作为基因$G_{4}$的广义线性模型（GLM）中的偏移量，该模型具有泊松似然和对数连接函数，拟合模型\n$$\n\\ln \\mu_{i} \\;=\\; \\ln s_{i} \\;+\\; \\beta_{0} \\;+\\; \\beta_{1}\\, x_{i},\n$$\n其中$\\mu_{i}$是样本$i$的期望计数，$x_{i} = 0$对应条件$\\mathrm{A}$，$x_{i} = 1$对应条件$\\mathrm{B}$，而$\\beta_{1}$则编码了条件对基因$G_{4}$的影响。\n\n仅从几何平均值和带对数连接的泊松GLM的核心定义出发，从第一性原理推导出$\\beta_{1}$的最大似然估计量的闭合形式，并使用所提供的计数将其完全简化。将你的最终答案表示为单个精确的解析表达式，不进行数值舍入。不包括单位。",
            "solution": "我们从定义开始。对于在所有样本中计数均严格为正的每个基因$j$，将其在$n=4$个样本中的几何平均值定义为\n$$\ng_{j} \\;=\\; \\left(\\prod_{i=1}^{4} K_{ij}\\right)^{1/4}.\n$$\n对于每个样本$i$，定义比率$r_{ij} = K_{ij}/g_{j}$并设置大小因子\n$$\ns_{i} \\;=\\; \\operatorname{median}_{j\\in\\mathcal{J}} \\left( \\frac{K_{ij}}{g_{j}} \\right),\n$$\n其中$\\mathcal{J}$索引了所有符合条件的基因（在所有样本中计数均严格为正）。在这些数据中，所有$5$个基因在所有样本中的计数均严格为正，因此$\\mathcal{J} = \\{1,2,3,4,5\\}$。\n\n我们注意到给定计数中存在一个经验结构。对于基因$G_{1}, G_{2}, G_{3}, G_{5}$，其样本间的模式在基因间是成比例的：\n- 对于$G_{1}$，样本间的比率为$(75:110:100:140)$，可化简为$(15:22:20:28)$。\n- 对于$G_{2}$，$(225:330:300:420)$同样化简为$(15:22:20:28)$。\n- 对于$G_{3}$，$(38:55:50:70)$同样化简为$(15:22:20:28)$。\n- 对于$G_{5}$，$(90:132:120:168)$同样化简为$(15:22:20:28)$。\n\n这种比例关系表明，对于$j \\in \\{1,2,3,5\\}$，计数可以写成\n$$\nK_{ij} \\;=\\; s_{i}\\, m_{j},\n$$\n其中$s_{i}$是某个样本特异性因子（反映文库大小或测序深度），$m_{j}$是某个不依赖于条件的基因特异性基线。尽管$s_{i}$和$m_{j}$并非先验已知，但这些基因间的精确比例关系保证了它们的存在。\n\n对于任何这样的基因$j \\in \\{1,2,3,5\\}$，其跨样本几何平均值为\n$$\ng_{j} \\;=\\; \\left( \\prod_{i=1}^{4} s_{i}\\, m_{j} \\right)^{1/4} \\;=\\; m_{j} \\left( \\prod_{i=1}^{4} s_{i} \\right)^{1/4}.\n$$\n因此，对于$j \\in \\{1,2,3,5\\}$，\n$$\n\\frac{K_{ij}}{g_{j}} \\;=\\; \\frac{s_{i}\\, m_{j}}{ m_{j}\\, \\left( \\prod_{i'=1}^{4} s_{i'} \\right)^{1/4} } \\;=\\; \\frac{s_{i}}{ \\left( \\prod_{i'=1}^{4} s_{i'} \\right)^{1/4} }.\n$$\n等式右边不再依赖于基因索引$j$，因此对于每个样本$i$，由$G_{1}, G_{2}, G_{3}, G_{5}$贡献的四个比率是相同的，均等于$s_{i}/S_{\\mathrm{geo}}$，其中我们简记\n$$\nS_{\\mathrm{geo}} \\;=\\; \\left( \\prod_{i=1}^{4} s_{i} \\right)^{1/4}.\n$$\n\n对于基因$G_{4}$，其计数在不同条件下有所不同，这表明存在基因特异性的条件效应。观测到的元组$(150, 220, 400, 560)$保持了与上述相同的样本间比例关系，但在条件$\\mathrm{B}$中相对于条件$\\mathrm{A}$乘以了一个额外的因子$2$。具体来说，我们可以写成\n$$\nK_{i,4} \\;=\\; s_{i}\\, m_{4}\\, c_{i},\n$$\n其中对于$i \\in \\{1,2\\}$（条件$\\mathrm{A}$）$c_{i}=1$，对于$i \\in \\{3,4\\}$（条件$\\mathrm{B}$）$c_{i}=2$。其几何平均值为\n$$\ng_{4} \\;=\\; \\left( \\prod_{i=1}^{4} s_{i}\\, m_{4}\\, c_{i} \\right)^{1/4} \\;=\\; m_{4}\\, \\left( \\prod_{i=1}^{4} s_{i} \\right)^{1/4} \\left( \\prod_{i=1}^{4} c_{i} \\right)^{1/4} \\;=\\; m_{4}\\, S_{\\mathrm{geo}} \\, \\left(1\\cdot 1\\cdot 2\\cdot 2\\right)^{1/4} \\;=\\; m_{4}\\, S_{\\mathrm{geo}}\\, \\sqrt{2}.\n$$\n因此，对于$G_{4}$，\n$$\n\\frac{K_{i,4}}{g_{4}} \\;=\\; \\frac{s_{i}\\, m_{4}\\, c_{i}}{ m_{4}\\, S_{\\mathrm{geo}}\\, \\sqrt{2} } \\;=\\; \\frac{s_{i}}{S_{\\mathrm{geo}}}\\, \\frac{c_{i}}{\\sqrt{2}}.\n$$\n\n汇总每个样本$i$的五个比率：\n- 其中四个（来自$G_{1}, G_{2}, G_{3}, G_{5}$）恰好是$\\dfrac{s_{i}}{S_{\\mathrm{geo}}}$。\n- 第五个（来自$G_{4}$）对于$i \\in \\{1,2\\}$是$\\dfrac{s_{i}}{S_{\\mathrm{geo}}}\\, \\dfrac{1}{\\sqrt{2}}$，对于$i \\in \\{3,4\\}$是$\\dfrac{s_{i}}{S_{\\mathrm{geo}}}\\, \\sqrt{2}$。\n\n因此，对于每个$i$，这五个值的中位数是$\\dfrac{s_{i}}{S_{\\mathrm{geo}}}$，因为四个相同的值在顺序统计量中占主导地位，而第五个值要么严格小一个因子$\\dfrac{1}{\\sqrt{2}}$，要么严格大一个因子$\\sqrt{2}$。因此计算出的大小因子是\n$$\ns_{i}^{\\ast} \\;=\\; \\frac{s_{i}}{S_{\\mathrm{geo}}}, \\quad i \\in \\{1,2,3,4\\}.\n$$\n这些$s_{i}^{\\ast}$的定义相差一个公共乘法常数$S_{\\mathrm{geo}}^{-1}$，这在下游建模中无关紧要，因为它会被截距项吸收。\n\n现在我们为基因$G_{4}$拟合一个泊松广义线性模型（GLM），使用对数连接函数和偏移量$\\ln s_{i}^{\\ast}$。该模型为\n$$\nK_{i,4} \\sim \\mathrm{Poisson}(\\mu_{i}), \\qquad \\ln \\mu_{i} \\;=\\; \\ln s_{i}^{\\ast} \\;+\\; \\beta_{0} \\;+\\; \\beta_{1}\\, x_{i},\n$$\n其中对于$i \\in \\{1,2\\}$，$x_{i} = 0$，对于$i \\in \\{3,4\\}$，$x_{i} = 1$。\n\n令$e_{i} = s_{i}^{\\ast}$表示偏移暴露量。定义$\\theta_{\\mathrm{A}} = \\exp(\\beta_{0})$和$\\theta_{\\mathrm{B}} = \\exp(\\beta_{0}+\\beta_{1})$。那么样本$i$的均值可以写成\n$$\n\\mu_{i} \\;=\\; \\begin{cases}\ne_{i}\\, \\theta_{\\mathrm{A}},  i \\in \\{1,2\\} \\\\\ne_{i}\\, \\theta_{\\mathrm{B}},  i \\in \\{3,4\\}.\n\\end{cases}\n$$\n在不考虑一个不依赖于参数的加性常数$\\sum_{i} -\\ln(K_{i,4}!)$的情况下，对数似然函数为\n$$\n\\ell(\\theta_{\\mathrm{A}}, \\theta_{\\mathrm{B}}) \\;=\\; \\sum_{i \\in \\{1,2\\}} \\left[ K_{i,4}\\, \\ln(e_{i}\\, \\theta_{\\mathrm{A}}) - e_{i}\\, \\theta_{\\mathrm{A}} \\right] \\;+\\; \\sum_{i \\in \\{3,4\\}} \\left[ K_{i,4}\\, \\ln(e_{i}\\, \\theta_{\\mathrm{B}}) - e_{i}\\, \\theta_{\\mathrm{B}} \\right].\n$$\n分别对$\\theta_{\\mathrm{A}}$和$\\theta_{\\mathrm{B}}$进行最大化，通过将导数设为零，得到标准的泊松暴露量加权平均值：\n$$\n\\frac{\\partial \\ell}{\\partial \\theta_{\\mathrm{A}}} \\;=\\; \\sum_{i \\in \\{1,2\\}} \\left( \\frac{K_{i,4}}{\\theta_{\\mathrm{A}}} - e_{i} \\right) \\;=\\; 0 \\;\\;\\Rightarrow\\;\\; \\widehat{\\theta}_{\\mathrm{A}} \\;=\\; \\frac{\\sum_{i \\in \\{1,2\\}} K_{i,4}}{\\sum_{i \\in \\{1,2\\}} e_{i}},\n$$\n$$\n\\frac{\\partial \\ell}{\\partial \\theta_{\\mathrm{B}}} \\;=\\; \\sum_{i \\in \\{3,4\\}} \\left( \\frac{K_{i,4}}{\\theta_{\\mathrm{B}}} - e_{i} \\right) \\;=\\; 0 \\;\\;\\Rightarrow\\;\\; \\widehat{\\theta}_{\\mathrm{B}} \\;=\\; \\frac{\\sum_{i \\in \\{3,4\\}} K_{i,4}}{\\sum_{i \\in \\{3,4\\}} e_{i}}.\n$$\n因此，条件系数的最大似然估计量为\n$$\n\\widehat{\\beta}_{1} \\;=\\; \\ln \\widehat{\\theta}_{\\mathrm{B}} \\;-\\; \\ln \\widehat{\\theta}_{\\mathrm{A}} \\;=\\; \\ln\\!\\left( \\frac{\\sum_{i \\in \\{3,4\\}} K_{i,4}}{\\sum_{i \\in \\{3,4\\}} e_{i}} \\right) \\;-\\; \\ln\\!\\left( \\frac{\\sum_{i \\in \\{1,2\\}} K_{i,4}}{\\sum_{i \\in \\{1,2\\}} e_{i}} \\right).\n$$\n\n我们现在使用提供的计数和$e_{i} = s_{i}^{\\ast} = s_{i}/S_{\\mathrm{geo}}$的结构来计算这些和。首先计算$G_{4}$的计数总和：\n$$\n\\sum_{i \\in \\{1,2\\}} K_{i,4} \\;=\\; 150 \\;+\\; 220 \\;=\\; 370, \\qquad \\sum_{i \\in \\{3,4\\}} K_{i,4} \\;=\\; 400 \\;+\\; 560 \\;=\\; 960.\n$$\n接下来，计算偏移量总和。因为$s_{i}^{\\ast}$与底层的$s_{i}$成比例，公共因子为$S_{\\mathrm{geo}}^{-1}$，所以它们的分组总和是\n$$\n\\sum_{i \\in \\{1,2\\}} e_{i} \\;=\\; \\frac{s_{1} + s_{2}}{S_{\\mathrm{geo}}}, \\qquad \\sum_{i \\in \\{3,4\\}} e_{i} \\;=\\; \\frac{s_{3} + s_{4}}{S_{\\mathrm{geo}}}.\n$$\n公共因子$S_{\\mathrm{geo}}^{-1}$在$\\widehat{\\beta}_{1}$中被抵消。事实上，\n$$\n\\widehat{\\beta}_{1} \\;=\\; \\ln\\!\\left( \\frac{960}{(s_{3} + s_{4})/S_{\\mathrm{geo}}} \\right) \\;-\\; \\ln\\!\\left( \\frac{370}{(s_{1} + s_{2})/S_{\\mathrm{geo}}} \\right)\n\\;=\\; \\ln(960) \\;-\\; \\ln(370) \\;+\\; \\ln\\!\\left( \\frac{s_{1} + s_{2}}{s_{3} + s_{4}} \\right).\n$$\n我们直接从非差异表达基因$G_{1}, G_{2}, G_{3}, G_{5}$确定$\\dfrac{s_{1} + s_{2}}{s_{3} + s_{4}}$。对于任何这样的基因$j$，期望计数服从$K_{ij} \\propto s_{i}$，因此分组总和的比率估计了比率$(s_{1} + s_{2})/(s_{3} + s_{4})$，且不依赖于$m_{j}$。为具体起见，使用$G_{1}$，\n$$\n\\frac{s_{1} + s_{2}}{s_{3} + s_{4}} \\;=\\; \\frac{K_{1,1} + K_{2,1}}{K_{3,1} + K_{4,1}} \\;=\\; \\frac{75 + 110}{100 + 140} \\;=\\; \\frac{185}{240} \\;=\\; \\frac{37}{48}.\n$$\n从$G_{2}$、$G_{3}$和$G_{5}$可以得到相同的比率，因为它们的样本间比例关系是相同的。因此，\n$$\n\\widehat{\\beta}_{1} \\;=\\; \\ln(960) \\;-\\; \\ln(370) \\;+\\; \\ln\\!\\left( \\frac{37}{48} \\right)\n\\;=\\; \\ln\\!\\left( \\frac{960}{370} \\cdot \\frac{37}{48} \\right)\n\\;=\\; \\ln\\!\\left( \\frac{960 \\cdot 37}{370 \\cdot 48} \\right).\n$$\n我们简化这个分数：\n$$\n\\frac{960}{48} \\;=\\; 20, \\qquad \\frac{37}{370} \\;=\\; \\frac{1}{10}.\n$$\n因此，\n$$\n\\frac{960 \\cdot 37}{370 \\cdot 48} \\;=\\; 20 \\cdot \\frac{1}{10} \\;=\\; 2,\n$$\n所以\n$$\n\\widehat{\\beta}_{1} \\;=\\; \\ln(2).\n$$\n这就是在指定的归一化和GLM下，基因$G_{4}$的条件系数的精确闭合形式最大似然估计。",
            "answer": "$$\\boxed{\\ln(2)}$$"
        },
        {
            "introduction": "虽然泊松模型为计数数据的建模提供了一个良好的起点，但真实的RNA测序数据通常表现出“过度离散”（overdispersion）的特性，即方差大于均值，这是泊松分布所不能完全捕捉的。负二项（Negative Binomial, NB）分布能更好地对这一特性进行建模，因此成为差异表达分析中的标准工具。本练习将带您深入现代DGE分析工具（如DESeq2）的核心，通过编程实现一个负二项广义线性模型（NB-GLM）的拟合过程，并对组间差异执行Wald检验以获得p值 ()。通过亲手实现这个核心统计引擎，您将对差异表达检验的内部机制获得深刻的理解。",
            "id": "4333087",
            "problem": "您的任务是构建一个程序，该程序针对在两个临床组中测量的单个基因，拟合一个负二项广义线性模型 (NB-GLM)，并对组系数执行沃尔德检验 (Wald test)，以评估差异表达。这是精准医疗和基因组诊断的核心，其中核糖核酸 (RNA) 测序计数使用适当的计数分布进行建模，并推断组效应。程序必须遵循以下精确的建模和统计框架，并以指定的输出格式生成结果。\n\n基本基础和定义：\n- 负二项 (NB) 模型，其均值-方差关系与生物计数数据一致。使用方差为 $$\\operatorname{Var}(Y_i) = \\mu_i + \\phi \\mu_i^2,$$ 的参数化形式，其中 $Y_i$ 是观测值 $i$ 的计数，$\\mu_i$ 是均值，$\\phi$ 是离散度参数，等效的“大小”参数 $r$ 定义为 $$r = \\frac{1}{\\phi}.$$ 在此参数化下，方差也可以写成 $$\\operatorname{Var}(Y_i) = \\mu_i + \\frac{\\mu_i^2}{r}.$$\n- 广义线性模型 (GLM)，具有对数连接函数和一个偏移量（已知的暴露或文库大小因子）。均值满足 $$\\log(\\mu_i) = \\log(o_i) + \\mathbf{x}_i^\\top \\boldsymbol{\\beta},$$ 其中 $o_i$ 是观测值 $i$ 的偏移量，$\\mathbf{x}_i$ 是设计向量，$\\boldsymbol{\\beta}$ 是系数向量。\n- 双组设计：使用 $$\\mathbf{x}_i = [1, g_i]^\\top,$$ 其中 $g_i \\in \\{0, 1\\}$ 表示组成员关系。系数 $\\beta_0$ 是截距，$\\beta_1$ 是组效应（差异表达分析中感兴趣的参数）。\n- 最大似然估计 (MLE)：通过在上述连接函数和偏移量结构下最大化 NB 对数似然来拟合 $\\boldsymbol{\\beta}$。\n- 组系数的沃尔德检验 (Wald test)：如果 $\\widehat{\\beta}_1$ 是最大似然估计，$\\operatorname{se}(\\widehat{\\beta}_1)$ 是从费雪信息 (Fisher information) 估计的标准误，那么沃尔德统计量是 $$W = \\left(\\frac{\\widehat{\\beta}_1}{\\operatorname{se}(\\widehat{\\beta}_1)}\\right)^2,$$ 并且必须使用标准正态近似计算相应的双边 $p$ 值。\n\n您的程序必须根据上述定义和原理，实现带有对数连接和偏移量的 NB-GLM 的拟合，然后计算 $\\beta_1$ 的沃尔德统计量 $W$ 和双边 $p$ 值。\n\n输入作为包含四个案例的测试套件嵌入在程序中。对于每个案例，都提供了一个计数向量 $y$、一个偏移量向量 $o$、一个二元组指示向量 $g$ 和一个离散度 $\\phi$。所有向量均按观测索引对齐。每个案例都应独立处理。不涉及物理单位，所有输出必须是数值。测试套件如下：\n\n- 案例 1（具有中等计数和异构偏移量的一般情况）：\n  - $y = [14, 9, 11, 10, 8, 23, 29, 31, 18, 27]$\n  - $o = [1.10, 0.90, 1.05, 1.00, 0.95, 1.20, 1.30, 0.85, 1.10, 0.90]$\n  - $g = [0, 0, 0, 0, 0, 1, 1, 1, 1, 1]$\n  - $\\phi = 0.25$\n- 案例 2（具有零和低计数的边缘情况）：\n  - $y = [0, 0, 1, 0, 2, 3, 4, 0, 5, 2]$\n  - $o = [1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00]$\n  - $g = [0, 0, 0, 0, 0, 1, 1, 1, 1, 1]$\n  - $\\phi = 0.50$\n- 案例 3（具有异构偏移量的高计数，表明存在归一化效应）：\n  - $y = [50, 60, 55, 48, 52, 58]$\n  - $o = [2.00, 1.80, 2.20, 3.00, 2.50, 3.50]$\n  - $g = [0, 0, 0, 1, 1, 1]$\n  - $\\phi = 0.10$\n- 案例 4（小样本量和高离散度下的近零效应）：\n  - $y = [7, 8, 6, 9]$\n  - $o = [1.00, 1.00, 1.00, 1.00]$\n  - $g = [0, 0, 1, 1]$\n  - $\\phi = 1.00$\n\n您的程序必须对每个案例，根据上述定义拟合 NB-GLM，计算沃尔德统计量 $W$ 和双边 $p$ 值（以十进制表示），然后打印一行包含所有四个案例结果的内容，按顺序排列，格式为一个用方括号括起来的逗号分隔列表，其中每个元素是对应案例的配对 $[W, p]$。例如，打印输出格式必须为 $$[[W_1, p_1],[W_2, p_2],[W_3, p_3],[W_4, p_4]]$$。",
            "solution": "该问题要求实现一个负二项广义线性模型 (NB-GLM)，以检验两组间的基因差异表达。该问题定义明确，科学上基于成熟的生物统计学方法，并为获得唯一解提供了所有必要信息。我们将进行完整的求解。\n\n我们的目标是拟合模型的系数 $\\boldsymbol{\\beta} = [\\beta_0, \\beta_1]^\\top$，并对组系数 $\\widehat{\\beta}_1$ 进行沃尔德检验。\n\n该模型由两个部分定义：\n1.  每个观测值 $i$ 的计数数据 $Y_i$ 的分布，即均值为 $\\mu_i$、离散度为 $\\phi$ 的负二项 (NB) 分布。方差由关系式 $\\operatorname{Var}(Y_i) = \\mu_i + \\phi \\mu_i^2$ 给出。NB 分布的大小参数 $r$ 与离散度的关系为 $r=1/\\phi$。\n2.  均值 $\\mu_i$ 与模型的线性预测变量 $\\eta_i = \\mathbf{x}_i^\\top \\boldsymbol{\\beta}$ 之间的关系。这由一个对数连接函数给出，并包含一个偏移项 $o_i$（通常代表文库大小或暴露）：\n    $$ \\log(\\mu_i) = \\log(o_i) + \\eta_i \\implies \\mu_i = o_i \\exp(\\eta_i) = o_i \\exp(\\mathbf{x}_i^\\top \\boldsymbol{\\beta}) $$\n    两组比较的设计向量为 $\\mathbf{x}_i = [1, g_i]^\\top$，其中 $g_i \\in \\{0, 1\\}$ 是组指示符。因此，线性预测变量为 $\\eta_i = \\beta_0 + \\beta_1 g_i$。\n\n系数 $\\beta_1$ 表示第 1 组相对于第 0 组平均表达量的对数倍数变化。检验假设 $H_0: \\beta_1 = 0$ 就是检验差异表达。\n\n系数 $\\boldsymbol{\\beta}$ 通过最大化 NB-GLM 的对数似然来估计。整个数据集 $\\mathbf{y} = [y_1, \\dots, y_N]^\\top$ 的对数似然函数是单个对数似然的总和：\n$$ \\mathcal{L}(\\boldsymbol{\\beta}) = \\sum_{i=1}^N \\ell_i(\\boldsymbol{\\beta}) $$\n其中 $\\ell_i$ 是在给定 $\\mu_i(\\boldsymbol{\\beta})$ 和 $\\phi$ 的情况下观测到 $y_i$ 的对数概率。由均值 $\\mu$ 和大小 $r=1/\\phi$ 参数化的 NB 概率质量函数是：\n$$ P(Y=y | \\mu, r) = \\frac{\\Gamma(y+r)}{\\Gamma(y+1)\\Gamma(r)} \\left(\\frac{r}{r+\\mu}\\right)^r \\left(\\frac{\\mu}{r+\\mu}\\right)^y $$\n对于观测值 $i$，忽略相对于 $\\boldsymbol{\\beta}$ 的常数项，其对数似然为：\n$$ \\ell_i(\\boldsymbol{\\beta}) \\propto y_i \\log(\\mu_i) - (y_i+r) \\log(\\mu_i+r) $$\n代入 $\\mu_i = o_i \\exp(\\mathbf{x}_i^\\top \\boldsymbol{\\beta})$，我们得到要相对于 $\\boldsymbol{\\beta}$ 最大化的函数。\n\n这个最大化过程使用迭代重加权最小二乘法 (IRLS) 算法进行数值计算，该算法等价于牛顿-拉夫逊 (Newton-Raphson) 优化。IRLS 算法迭代地解决一个加权最小二乘问题。在每次迭代 $t$ 中：\n1.  计算当前的线性预测变量 $\\eta^{(t)} = X \\boldsymbol{\\beta}^{(t)}$ 和均值 $\\mu^{(t)}_i = o_i \\exp(\\eta_i^{(t)})$。\n2.  计算工作因变量：\n    $$ z_i^{(t)} = \\eta_i^{(t)} + \\frac{y_i - \\mu_i^{(t)}}{\\mu_i^{(t)}} $$\n3.  计算权重：\n    $$ w_i^{(t)} = \\frac{(\\partial \\mu_i / \\partial \\eta_i)^2}{\\operatorname{Var}(Y_i)} = \\frac{(\\mu_i^{(t)})^2}{\\mu_i^{(t)} + \\phi (\\mu_i^{(t)})^2} = \\frac{\\mu_i^{(t)}}{1 + \\phi \\mu_i^{(t)}} $$\n4.  通过求解加权最小二乘问题来更新系数：\n    $$ \\boldsymbol{\\beta}^{(t+1)} = (X^\\top W^{(t)} X)^{-1} X^\\top W^{(t)} \\mathbf{z}^{(t)} $$\n    其中 $W^{(t)}$ 是由权重 $w_i^{(t)}$ 构成的对角矩阵。\n\n重复此过程，直到 $\\boldsymbol{\\beta}$ 的变化小于一个很小的容差。$\\beta_1$ 的初始值设为 $0$，$\\beta_0$ 的初始值设为 $\\log(\\sum y_i / \\sum o_i)$。\n\n收敛后，我们获得最大似然估计 (MLE) $\\widehat{\\boldsymbol{\\beta}}$。$\\widehat{\\boldsymbol{\\beta}}$ 的渐近协方差矩阵通过在 $\\widehat{\\boldsymbol{\\beta}}$ 处评估的费雪信息矩阵的逆来估计：\n$$ \\operatorname{Cov}(\\widehat{\\boldsymbol{\\beta}}) = I(\\widehat{\\boldsymbol{\\beta}})^{-1} = (X^\\top \\widehat{W} X)^{-1} $$\n其中 $\\widehat{W}$ 是使用最终均值估计 $\\widehat{\\mu}_i$ 计算的对角权重矩阵。\n\n组系数估计的标准误 $\\operatorname{se}(\\widehat{\\beta}_1)$ 是该协方差矩阵第二个对角元素（对应于 $\\beta_1$）的平方根。\n\n然后，假设 $H_0: \\beta_1 = 0$ 的沃尔德检验统计量计算如下：\n$$ W = \\left( \\frac{\\widehat{\\beta}_1}{\\operatorname{se}(\\widehat{\\beta}_1)} \\right)^2 $$\n在零假设下，$W$ 服从自由度为 1 的卡方分布 ($\\chi^2_1$)。双边 $p$ 值是观测到至少与 $W$ 一样极端的统计量的概率：\n$$ p \\text{-value} = P(\\chi^2_1 \\ge W) $$\n此过程独立地应用于所提供的四个测试案例中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Main function to run the NB-GLM analysis for all test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1\n        (\n            np.array([14, 9, 11, 10, 8, 23, 29, 31, 18, 27]),\n            np.array([1.10, 0.90, 1.05, 1.00, 0.95, 1.20, 1.30, 0.85, 1.10, 0.90]),\n            np.array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1]),\n            0.25\n        ),\n        # Case 2\n        (\n            np.array([0, 0, 1, 0, 2, 3, 4, 0, 5, 2]),\n            np.array([1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00, 1.00]),\n            np.array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1]),\n            0.50\n        ),\n        # Case 3\n        (\n            np.array([50, 60, 55, 48, 52, 58]),\n            np.array([2.00, 1.80, 2.20, 3.00, 2.50, 3.50]),\n            np.array([0, 0, 0, 1, 1, 1]),\n            0.10\n        ),\n        # Case 4\n        (\n            np.array([7, 8, 6, 9]),\n            np.array([1.00, 1.00, 1.00, 1.00]),\n            np.array([0, 0, 1, 1]),\n            1.00\n        )\n    ]\n\n    results = []\n    for y, o, g, phi in test_cases:\n        W, p = fit_nb_glm_and_test(y, o, g, phi)\n        results.append([W, p])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef fit_nb_glm_and_test(y, o, g, phi):\n    \"\"\"\n    Fits a Negative Binomial GLM and performs a Wald test on the group coefficient.\n\n    Args:\n        y (np.ndarray): Count data vector.\n        o (np.ndarray): Offset vector.\n        g (np.ndarray): Group indicator vector (0 or 1).\n        phi (float): Dispersion parameter.\n\n    Returns:\n        tuple[float, float]: A tuple containing the Wald statistic W and the p-value.\n    \"\"\"\n    # 1. Construct the design matrix X\n    # Column 0 is the intercept, Column 1 is the group effect.\n    X = np.stack([np.ones_like(g), g], axis=1)\n    \n    # 2. Initialize coefficients for IRLS\n    # Initialize beta_1 to 0 (no group effect)\n    # Initialize beta_0 to the log of the overall mean rate\n    sum_y = np.sum(y)\n    if sum_y == 0:\n        # Avoid log(0) if all counts are zero\n        beta0_init = -10 \n    else:\n        beta0_init = np.log(sum_y / np.sum(o))\n    beta = np.array([beta0_init, 0.0])\n\n    # 3. Perform Iteratively Reweighted Least Squares (IRLS)\n    max_iter = 50\n    tolerance = 1e-8\n    for i in range(max_iter):\n        eta = X @ beta\n        mu = o * np.exp(eta)\n        \n        # Calculate weights for WLS\n        weights = mu / (1 + phi * mu)\n        W_diag = np.diag(weights)\n        \n        # Calculate working dependent variable z\n        z = eta + (y - mu) / mu\n\n        # Store old beta for convergence check\n        beta_old = beta.copy()\n\n        # Update beta by solving the weighted least squares problem\n        # beta_new = inv(X.T @ W @ X) @ X.T @ W @ z\n        try:\n            XT_W = X.T @ W_diag\n            XT_W_X = XT_W @ X\n            XT_W_z = XT_W @ z\n            beta = np.linalg.solve(XT_W_X, XT_W_z)\n        except np.linalg.LinAlgError:\n            # If matrix is singular, use a pseudo-inverse\n            beta = np.linalg.pinv(XT_W_X) @ XT_W_z\n            \n        # Check for convergence\n        if np.sum(np.abs(beta - beta_old))  tolerance:\n            break\n\n    # 4. Perform Wald test on the group coefficient (beta_1)\n    # Get the final MLE estimates\n    beta_hat = beta\n    beta1_hat = beta_hat[1]\n    \n    # Recalculate final mu and weights at MLE\n    eta_hat = X @ beta_hat\n    mu_hat = o * np.exp(eta_hat)\n    weights_hat = mu_hat / (1 + phi * mu_hat)\n    W_hat_diag = np.diag(weights_hat)\n    \n    # Calculate Fisher Information Matrix I = X^T W X\n    fisher_info = X.T @ W_hat_diag @ X\n    \n    try:\n        # Covariance matrix is the inverse of the Fisher Information\n        cov_beta = np.linalg.inv(fisher_info)\n        # Variance of beta_1 is the second diagonal element\n        var_beta1 = cov_beta[1, 1]\n        \n        # Standard error of beta1_hat\n        se_beta1 = np.sqrt(var_beta1)\n        \n        if se_beta1  1e-10: # Avoid division by zero\n            wald_stat = 0.0\n        else:\n            # Wald statistic W = (beta1_hat / se_beta1)^2\n            wald_stat = (beta1_hat / se_beta1)**2\n            \n        # p-value from chi-squared distribution with 1 degree of freedom\n        p_value = chi2.sf(wald_stat, df=1)\n\n    except np.linalg.LinAlgError:\n        # If Fisher information matrix is singular, test is inconclusive.\n        # This can happen with sparse data or separation.\n        wald_stat = np.nan\n        p_value = np.nan\n\n    return wald_stat, p_value\n\n# Execute the main function\nsolve()\n```"
        }
    ]
}