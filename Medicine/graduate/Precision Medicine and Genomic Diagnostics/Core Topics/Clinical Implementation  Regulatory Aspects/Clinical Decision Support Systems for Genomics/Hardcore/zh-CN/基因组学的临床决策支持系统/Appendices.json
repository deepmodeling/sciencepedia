{
    "hands_on_practices": [
        {
            "introduction": "许多常见疾病的风险受到成千上万个遗传变异的共同影响，而每个变异的影响都相当微小。临床决策支持系统（CDSS）必须能够整合这些分散的信息，并将其转化为一个有意义的风险评估。本练习  将引导您完成计算多基因风险评分（PRS）并将其转换为个体绝对疾病风险的基本步骤，这是实现风险分层筛查和预防的核心功能。",
            "id": "4324199",
            "problem": "一个信息学团队正在构建一个临床决策支持模块，该模块将一种常见复杂疾病的多基因风险评分（PRS）整合到基于对数优势比标度的个体化绝对风险评估中。PRS 是通过单核苷酸多态性（SNPs）的加权和计算得出的，其中基因型被编码为风险等位基因的数量。假设满足哈迪-温伯格平衡（HWE）且各 SNP 之间相互独立，因此对于每个风险等位基因频率为 $p_j$ 的 SNP，其基因型计数 $x_j \\in \\{0,1,2\\}$ 服从参数为 $n=2$ 和概率为 $p_j$ 的二项分布，从而得到 $\\mathbb{E}[x_j] = 2p_j$ 和 $\\mathrm{Var}(x_j) = 2p_j(1-p_j)$。原始 PRS 为 $S = \\sum_{j=1}^{m} \\beta_j x_j$，其中 $\\beta_j$ 是来自经过验证的全基因组关联研究的每个风险等位基因的对数优势比权重。个体的标准化 PRS z-分数定义为 $z = \\dfrac{S - \\mu_S}{\\sigma_S}$，其中在独立性假设下，$\\mu_S = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$ 且 $\\sigma_S = \\sqrt{\\sum_{j=1}^{m} \\beta_j^{2} \\mathrm{Var}(x_j)}$。\n\n为了将标准化的 PRS 转化为绝对风险，使用一个基于优势比和对数优势比定义的逻辑斯谛模型：对于概率 $p$，其优势比为 $\\dfrac{p}{1-p}$，对数优势比（logit）为 $\\ln\\!\\left(\\dfrac{p}{1-p}\\right)$，对于线性预测变量 $\\eta$，反-logit（逻辑斯谛函数）为 $\\dfrac{1}{1+\\exp(-\\eta)}$。假设该模块将经人群校准的基线发病率 $I_0$ 编码为标准化 PRS $z=0$ 时的风险，并将 PRS 的效应建模为 z 每增加一个标准差，对数优势比就偏移 $\\gamma$。因此，对于一个标准化 PRS 为 $z$ 的个体，其线性预测变量为 $\\eta = \\alpha + \\gamma z$，其中截距 $\\alpha$ 满足 $\\alpha = \\ln\\!\\left(\\dfrac{I_0}{1-I_0}\\right)$。\n\n考虑 $m=5$ 个 SNP，其参数如下，其中所有 $\\beta_j$ 均为每等位基因的对数优势比权重，$p_j$ 为人群风险等位基因频率，$x_j$ 为个体观察到的风险等位基因计数：\n- SNP 1: $\\beta_1 = 0.12$, $p_1 = 0.30$, $x_1 = 1$。\n- SNP 2: $\\beta_2 = -0.08$, $p_2 = 0.45$, $x_2 = 0$。\n- SNP 3: $\\beta_3 = 0.25$, $p_3 = 0.10$, $x_3 = 1$。\n- SNP 4: $\\beta_4 = 0.05$, $p_4 = 0.60$, $x_4 = 1$。\n- SNP 5: $\\beta_5 = 0.15$, $p_5 = 0.20$, $x_5 = 2$。\n\n假设基线发病率 $I_0 = 0.12$，每标准差的对数优势比效应 $\\gamma = 0.35$。仅使用上面提供的基本定义（哈迪-温伯格平衡下的二项基因型模型、SNP 间的独立性、优势比、对数优势比以及逻辑斯谛连接），计算该个体的标准化 PRS $z$，然后从对数优势比模型中推导出绝对风险 $p$。仅以小数形式报告最终的绝对风险。将最终答案四舍五入至四位有效数字。不允许使用百分号。",
            "solution": "该问题被认为是有效的，因为它在科学上基于统计遗传学和流行病学的既定原则，提法得当且信息充分，可得出唯一解，并以客观、正式的语言表述。解题过程通过有条不紊地应用问题陈述中提供的定义来进行。\n\n计算分以下几个步骤进行：\n1.  计算 $m=5$ 个 SNP 中每个 SNP 基因型计数的总体均值 $\\mathbb{E}[x_j]$ 和方差 $\\mathrm{Var}(x_j)$。\n2.  计算个体的原始多基因风险评分 (PRS) $S$。\n3.  计算 PRS 的总体均值 $\\mu_S$。\n4.  计算 PRS 的总体方差 $\\sigma_S^2$ 和标准差 $\\sigma_S$。\n5.  计算个体的标准化 PRS z-分数。\n6.  使用提供的逻辑斯谛风险模型计算个体的绝对风险 $p$。\n\n**步骤 1：每个 SNP 的总体矩**\n对于每个 SNP $j$，基因型计数 $x_j$ 是一个参数为 $n=2$ 和概率为 $p_j$ 的二项随机变量。其均值和方差由以下公式给出：\n$\\mathbb{E}[x_j] = 2p_j$\n$\\mathrm{Var}(x_j) = 2p_j(1-p_j)$\n\n使用提供的风险等位基因频率 $p_j$：\n- 对于 SNP 1 ($p_1 = 0.30$)：\n  $\\mathbb{E}[x_1] = 2(0.30) = 0.60$\n  $\\mathrm{Var}(x_1) = 2(0.30)(1 - 0.30) = 0.42$\n- 对于 SNP 2 ($p_2 = 0.45$)：\n  $\\mathbb{E}[x_2] = 2(0.45) = 0.90$\n  $\\mathrm{Var}(x_2) = 2(0.45)(1 - 0.45) = 0.495$\n- 对于 SNP 3 ($p_3 = 0.10$)：\n  $\\mathbb{E}[x_3] = 2(0.10) = 0.20$\n  $\\mathrm{Var}(x_3) = 2(0.10)(1 - 0.10) = 0.18$\n- 对于 SNP 4 ($p_4 = 0.60$)：\n  $\\mathbb{E}[x_4] = 2(0.60) = 1.20$\n  $\\mathrm{Var}(x_4) = 2(0.60)(1 - 0.60) = 0.48$\n- 对于 SNP 5 ($p_5 = 0.20$)：\n  $\\mathbb{E}[x_5] = 2(0.20) = 0.40$\n  $\\mathrm{Var}(x_5) = 2(0.20)(1 - 0.20) = 0.32$\n\n**步骤 2：个体的原始 PRS, $S$**\n原始 PRS 是个体风险等位基因计数的加权和：$S = \\sum_{j=1}^{m} \\beta_j x_j$。\n代入给定的 $\\beta_j$ 和 $x_j$ 值：\n$$S = (0.12)(1) + (-0.08)(0) + (0.25)(1) + (0.05)(1) + (0.15)(2)$$\n$$S = 0.12 + 0 + 0.25 + 0.05 + 0.30 = 0.72$$\n\n**步骤 3：PRS 的总体均值, $\\mu_S$**\nPRS 的总体均值为 $\\mu_S = \\mathbb{E}[S] = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$。\n代入 $\\beta_j$ 和计算出的 $\\mathbb{E}[x_j]$：\n$$\\mu_S = (0.12)(0.60) + (-0.08)(0.90) + (0.25)(0.20) + (0.05)(1.20) + (0.15)(0.40)$$\n$$\\mu_S = 0.072 - 0.072 + 0.050 + 0.060 + 0.060 = 0.170$$\n\n**步骤 4：PRS 的总体方差和标准差**\n假设各 SNP 之间相互独立，PRS 的总体方差为 $\\sigma_S^2 = \\mathrm{Var}(S) = \\sum_{j=1}^{m} \\beta_j^2 \\mathrm{Var}(x_j)$。\n$$\\sigma_S^2 = (0.12)^2(0.42) + (-0.08)^2(0.495) + (0.25)^2(0.18) + (0.05)^2(0.48) + (0.15)^2(0.32)$$\n$$\\sigma_S^2 = (0.0144)(0.42) + (0.0064)(0.495) + (0.0625)(0.18) + (0.0025)(0.48) + (0.0225)(0.32)$$\n$$\\sigma_S^2 = 0.006048 + 0.003168 + 0.01125 + 0.0012 + 0.0072$$\n$$\\sigma_S^2 = 0.028866$$\n标准差是方差的平方根：\n$$\\sigma_S = \\sqrt{0.028866}$$\n\n**步骤 5：标准化的 PRS z-分数**\n标准化的 PRS 为 $z = \\dfrac{S - \\mu_S}{\\sigma_S}$。\n$$z = \\frac{0.72 - 0.170}{\\sqrt{0.028866}} = \\frac{0.55}{\\sqrt{0.028866}}$$\n$$z \\approx \\frac{0.55}{0.16989997} \\approx 3.237216$$\n\n**步骤 6：个体绝对风险, $p$**\n绝对风险由一个线性预测变量为 $\\eta = \\alpha + \\gamma z$ 的逻辑斯谛模型确定。\n首先，根据基线发病率 $I_0 = 0.12$ 计算截距 $\\alpha$：\n$$\\alpha = \\ln\\left(\\frac{I_0}{1-I_0}\\right) = \\ln\\left(\\frac{0.12}{1-0.12}\\right) = \\ln\\left(\\frac{0.12}{0.88}\\right) = \\ln\\left(\\frac{3}{22}\\right)$$\n$$\\alpha \\approx -1.992430$$\n接着，使用 $\\gamma = 0.35$ 和计算出的 $z$ 计算线性预测变量 $\\eta$：\n$$\\eta = \\alpha + \\gamma z = \\ln\\left(\\frac{3}{22}\\right) + (0.35)\\left(\\frac{0.55}{\\sqrt{0.028866}}\\right)$$\n$$\\eta \\approx -1.992430 + (0.35)(3.237216) \\approx -1.992430 + 1.133026$$\n$$\\eta \\approx -0.859404$$\n最后，使用反-logit 函数计算绝对风险 $p$：\n$$p = \\frac{1}{1 + \\exp(-\\eta)}$$\n$$p = \\frac{1}{1 + \\exp(-(-0.859404))} = \\frac{1}{1 + \\exp(0.859404)}$$\n$$p \\approx \\frac{1}{1 + 2.36173} \\approx \\frac{1}{3.36173} \\approx 0.297464$$\n将最终结果四舍五入到四位有效数字，得到 $0.2975$。",
            "answer": "$$\\boxed{0.2975}$$"
        },
        {
            "introduction": "任何基因组CDSS面临的一个关键挑战是裁决相互矛盾的证据。例如，某个变异可能根据实验室功能实验显示为致病性，但其在普通人群中的频率却表明它是良性的。本练习  将让您扮演CDSS的角色，要求您运用定量的群体遗传学原理来评估这种冲突，并确定最科学合理的解释策略。",
            "id": "4324229",
            "problem": "一套用于基因组解读的临床决策支持系统（CDSS）正在评估一个错义变异。该变异所在基因与一种常染色体显性遗传的心律失常表型存在已知的关联。功能研究是一项经过充分验证的体外试验，结果显示电流密度降低了约 $60\\%$，这与该基因已知的功能丧失性致病机制一致。因此，美国医学遗传学与基因组学学会（ACMG）关于充分验证的功能性证据的标准（PS3）可能适用。然而，基因组聚合数据库（gnomAD）报告了该变异在不同祖源人群中的以下观察结果：在非芬兰裔欧洲人群中，总共 $300{,}000$ 个等位基因中观察到 $240$ 个该变异等位基因，得出与祖源匹配的等位基因频率约为 $0.0008$。\n\n对于所讨论的疾病，以下流行病学和遗传结构方面的事实有充分支持：\n- 疾病患病率约为 $1/5000$ ($K = 2\\times 10^{-4}$)。\n- 致病性杂合子的外显率总体约为 $50\\%$ ($p=0.5$)。\n- 该基因对疾病的贡献约占所有病例的 $35\\%$ ($g=0.35$)。\n- 历史上，该基因中占比最大的单个变异在基因阳性病例中不超过 $5\\%$ ($a=0.05$)。\n\n临床决策支持系统（CDSS）必须对功能试验证据提示的致病性与人群等位基因频率提示的良性之间的明显冲突进行裁决。请仅使用基本原理，如罕见等位基因的Hardy–Weinberg平衡和用于证据整合的Bayes定理，来确定以下哪种CDSS裁决策略在这种情况下最合适。\n\nA. 应用一个固定的、与祖源无关的 $5\\%$ 等位基因频率阈值作为独立的良性证据规则，如果超过此阈值，则无论功能研究结果如何，都将变异分类为良性。\n\nB. 使用疾病患病率、外显率以及遗传和等位基因异质性，计算一个针对特定疾病和祖源的最大可信等位基因频率阈值；将观察到的与祖源匹配的频率与此阈值进行比较，然后使用贝叶斯框架整合人群证据（例如ACMG BS1）和功能试验证据（例如ACMG PS3）。如果功能证据和人群证据都很强但相互矛盾，则将其归类为意义不明确的变异，除非有额外的病例水平或共分离证据解决该冲突。\n\nC. 只要任何体外试验表明存在有害效应，就自动降低人群证据的权重或忽略它，因为功能数据在机制上更接近疾病，因此应占主导地位。\n\nD. 评估可以调和冲突的特殊情况，包括外显率降低或年龄依赖性外显率、具有亚群特异性疾病患病率的亚群创始人效应、隐性或寡基因遗传机制，或功能获得与功能丧失机制不匹配等；如果适用，调整先验概率、阈值或疾病模型，并在适当的模型下重新运行贝叶斯整合，而不是强行使用显性、高外显率模型。\n\nE. 对于迟发性疾病，完全忽略基因组聚合数据库（gnomAD），因为人群数据库对于此类疾病不可靠。\n\n选择所有适用项。",
            "solution": "用户提供了一个临床基因组学问题，并要求为存在证据冲突的变异寻找最合适的裁决策略。解决方案要求对问题陈述进行严格验证，然后基于群体遗传学原理和变异解读指南进行定量分析。\n\n### 第1步：提取已知条件\n\n问题提供了以下明确的数据和条件：\n-   **基因与疾病背景**：常染色体显性遗传的心律失常表型。该基因已知的致病机制是功能丧失。\n-   **变异功能证据**：一项经过充分验证的*体外*试验显示电流密度降低了约 $60\\%$。这被认为可能满足美国医学遗传学与基因组学学会（ACMG）的PS3标准（致病性强证据）。\n-   **变异人群数据**：来自基因组聚合数据库（gnomAD），非芬兰裔欧洲人群：\n    -   等位基因计数（AC）：$240$\n    -   总等位基因数（AN）：$300,000$\n    -   计算出的等位基因频率（$AF_{obs}$）：$240 / 300,000 \\approx 0.0008$\n-   **流行病学和遗传结构数据**：\n    -   疾病患病率（$K$）：$\\approx 1/5000$，即 $K = 2 \\times 10^{-4}$。\n    -   外显率（$p$）：$\\approx 50\\%$，即 $p = 0.5$。\n    -   基因水平对疾病的贡献（$g$）：$\\approx 35\\%$，即 $g = 0.35$。\n    -   最大等位基因贡献（$a$）：单个影响最大的变异在基因阳性病例中占比不超过 $5\\%$，所以 $a = 0.05$。\n\n### 第2步：使用提取的已知条件进行验证\n\n问题需根据强制性标准进行验证。\n\n-   **科学依据**：该问题很好地基于医学和群体遗传学的既定原则。它使用了常染色体显性遗传、外显率、遗传和等位基因异质性等概念，以及标准数据源（gnomAD）和解读框架（ACMG）。所提供的患病率、外显率和遗传结构的数值对于罕见的孟德尔遗传病是现实的。功能研究和人群频率之间证据冲突的情景是临床基因组学中一个常见而关键的挑战。\n-   **问题定义明确**：问题陈述清晰。它提供了所有必要的定量信息，以计算最大可信等位基因频率并将其与观察到的频率进行比较。问题要求评估裁决策略，这是一项定义明确的任务。\n-   **客观性**：问题以客观、定量和精确的语言陈述，没有主观或有偏见的论断。\n\n问题陈述成功通过了所有验证标准。它是一个有效、可解决的科学问题。\n\n### 第3步：结论与行动\n\n问题是**有效的**。现在开始解决过程。\n\n### 基于原理的推导和选项分析\n\n问题的核心是功能证据（提示致病性，PS3）与人群等位基因频率（看起来很高，可能提示为良性，BS1）之间的冲突。为了裁决这一点，我们必须首先定量地确定，在给定的遗传模型下，观察到的等位基因频率对于该变异作为特定疾病的病因来说是否确实过高。\n\n我们根据给定的疾病参数，计算该基因中单个致病性变异的最大可信等位基因频率（$AF_{max}$）。\n\n1.  **由该基因导致的患病率**：总疾病患病率为 $K = 2 \\times 10^{-4}$。归因于该特定基因的病例比例为 $g = 0.35$。因此，由该基因中变异引起的疾病患病率（$K_{gene}$）为：\n    $$K_{gene} = K \\times g = (2 \\times 10^{-4}) \\times 0.35 = 0.7 \\times 10^{-4}$$\n\n2.  **累积致病等位基因频率**：对于一种罕见的常染色体显性遗传病，其患病率约等于累积致病等位基因频率（$f_{gene}$）与外显率（$p$）乘积的两倍。这一关系源于Hardy-Weinberg原理，其中罕见等位基因的杂合子频率约为 $2f$。\n    $$K_{gene} \\approx 2 \\times f_{gene} \\times p$$\n    我们可以求解该基因中*所有*致病性变异的最大累积等位基因频率（$f_{gene,max}$）：\n    $$f_{gene,max} = \\frac{K_{gene}}{2 \\times p} = \\frac{0.7 \\times 10^{-4}}{2 \\times 0.5} = \\frac{0.7 \\times 10^{-4}}{1} = 7 \\times 10^{-5}$$\n\n3.  **单个变异的最大等位基因频率**：问题陈述指出，单个影响最大的变异在该基因所有致病性等位基因中占比不超过 $a = 0.05$（$5\\%$）。这个因素考虑了等位基因异质性。因此，任何单个致病性变异的最大可信等位基因频率（$AF_{max}$）为：\n    $$AF_{max} = f_{gene,max} \\times a = (7 \\times 10^{-5}) \\times 0.05 = 3.5 \\times 10^{-6}$$\n\n4.  **与观察频率的比较**：在与祖源匹配的人群中，观察到的等位基因频率为 $AF_{obs} = 0.0008$，即 $8 \\times 10^{-4}$。\n    我们将观察到的频率与计算出的最大可信频率进行比较：\n    $$AF_{obs} = 8 \\times 10^{-4} \\quad \\text{vs.} \\quad AF_{max} = 3.5 \\times 10^{-6}$$\n    观察到的频率（$800 \\times 10^{-6}$）比指定疾病模型下致病性变异的最大可信频率（$3.5 \\times 10^{-6}$）高出 $200$ 多倍。这构成了该变异为良性的极强证据（ACMG标准BS1）。\n\n问题现在变成了如何裁决来自功能研究的强致病性证据（PS3）和来自人群频率分析的强良性证据（BS1）之间的冲突。\n\n### 逐项分析\n\n**A. 应用一个固定的、与祖源无关的 $5\\%$ 等位基因频率阈值作为独立的良性证据规则，如果超过此阈值，则无论功能研究结果如何，都将变异分类为良性。**\n观察到的等位基因频率为 $0.0008$，即 $0.08\\%$。这远低于 $5\\%$（$0.05$）的阈值。因此，该规则（对应于常见良性变异的ACMG规则BA1）未被触发。此外，使用通用的高阈值在科学上不如我们上面所做的计算疾病特异性阈值。此策略过于简单且不适用。**不正确**。\n\n**B. 使用疾病患病率、外显率以及遗传和等位基因异质性，计算一个针对特定疾病和祖源的最大可信等位基因频率阈值；将观察到的与祖源匹配的频率与此阈值进行比较，然后使用贝叶斯框架整合人群证据（例如ACMG BS1）和功能试验证据（例如ACMG PS3）。如果功能证据和人群证据都很强但相互矛盾，则将其归类为意义不明确的变异，除非有额外的病例水平或共分离证据解决该冲突。**\n该选项精确地描述了上面执行的严谨、定量的过程。它正确地指出观察到的频率过高（BS1 evidence），且这与功能证据（PS3）相冲突。在ACMG/AMP框架中，当存在强但相互冲突的证据（一个致病性，一个良性）时，必须将其分类为“意义不明确的变异”（VUS）。该策略代表了变异解读中标准的、基于证据的方法。**正确**。\n\n**C. 只要任何*体外*试验表明存在有害效应，就自动降低人群证据的权重或忽略它，因为功能数据在机制上更接近疾病，因此应占主导地位。**\n该策略在科学上是不合理的。虽然功能试验提供了机制上的见解，但它们并非绝对可靠，可能无法完美重现*体内*细胞环境或生物体生物学。来自像gnomAD这样的大型人群数据库的定量证据非常有力，不容忽视。观察到的频率与最大可信等位基因频率之间超过 $200$ 倍的差异是一个必须被正视而不是被忽略的稳健发现。将一种证据类型自动置于另一种之上是一种有缺陷的启发式方法。**不正确**。\n\n**D. 评估可以调和冲突的特殊情况，包括外显率降低或年龄依赖性外显率、具有亚群特异性疾病患病率的亚群创始人效应、隐性或寡基因遗传机制，或功能获得与功能丧失机制不匹配等；如果适用，调整先验概率、阈值或疾病模型，并在适当的模型下重新运行贝叶斯整合，而不是强行使用显性、高外显率模型。**\n该选项描述了解决深层证据冲突时一个复杂而关键的步骤。策略（B）中得出VUS的分类是因为数据与初始疾病模型（显性遗传，$p=0.5$）不一致。策略（D）建议通过质疑模型的假设来调查冲突的*原因*。例如，如果真实的外显率要低得多（例如，$\\approx 0.004$），那么高的等位基因频率就可能与致病性相容。同样，隐性遗传模式或其他复杂的遗传模型也可以解释这些观察结果。这代表了更深层次的科学探究，旨在找到一个能够一致解释所有可用数据的模型。这是一个全面的裁决策略的重要组成部分，特别是对于追求高准确度的CDSS而言。**正确**。\n\n**E. 对于迟发性疾病，完全忽略基因组聚合数据库（gnomAD），因为人群数据库对于此类疾病不可靠。**\n这是一种过度简化和不正确的断言。虽然对于迟发性疾病，无症状携带者确实可能存在于人群数据库中，但这并不会使数据“不可靠”或无用。这仅仅意味着必须谨慎解读数据，通常通过模拟降低的外显率（如选项D中所建议的）。基于这种担忧而放弃现代基因组学中最强大的工具之一是极端且不恰当的行为。在本问题中，等位基因频率差异的巨大程度远非仅凭未出现症状的个体存在就能解释。**不正确**。\n\n### 结论\n选项B和D都描述了成熟的CDSS应采用的适当且必要的策略。选项B概述了在初始模型下整合冲突证据的标准程序，正确地得出VUS的分类结论。选项D概述了必要的后续调查，包括质疑并可能修改初始模型以解决根本冲突。一个完整的裁决过程包括这两个步骤。由于题目要求选择所有适用策略，因此两者都是正确的。",
            "answer": "$$\\boxed{BD}$$"
        },
        {
            "introduction": "CDSS的最终目标是在诊疗的关键时刻提供清晰、可操作的指导。最后的这个实践  模拟了这一过程，要求您将一个真实的药物基因组学指南编码成一个可以在电子健康记录（EHR）系统中触发的规则。您将把药物剂量的临床逻辑转化为具体的计算算法，从而连接起基因组数据与患者治疗之间的鸿沟。",
            "id": "4324236",
            "problem": "您需要实现一个完整、可运行的程序，该程序将一项可操作的临床药物遗传学实施联盟 (CPIC) 指南建议编码为与临床决策支持 (CDS) Hooks 兼容的规则引擎触发器，并计算出一个剂量建议以在电子健康记录 (EHR) 中呈现。目标是形式化最小输入（有效载荷）和决策逻辑，以根据硫嘌呤S-甲基转移酶 (TPMT) 和 nudix 水解酶 15 (NUDT15) 的药物基因组学表型，生成一个定量的硫嘌呤类药物剂量建议。\n\n使用的基本原理：\n- 基因型到表型再到治疗的路径植根于分子生物学中心法则和药代动力学：酶编码基因的遗传变异改变了酶的活性，从而改变了活性代谢物的暴露水平。这是药物基因组学经过充分验证的基础。\n- CPIC（临床药物遗传学实施联盟）提供了基于 TPMT 和 NUDT15 表型的硫嘌呤类药物的临床验证建议。您可以将下述的表型到剂量的调整类别视为经过充分验证的事实。\n- CDS Hooks 是一种事件驱动规范，当特定的临床工作流程事件发生时，服务会收到一个请求。钩子标识符和上下文决定了规则是否应该触发。\n\n最小有效载荷定义（作为一组键值约束）：\n- 请求是一个包含以下键的单一字典：\n  - \"hook\"：一个等于 \"medication-prescribe\" 的字符串。\n  - \"context\"：一个必须包含以下内容的字典：\n    - \"medication\"：一个不区分大小写的字符串，表示药物名称。\n    - \"standardDoseMg\"：一个以毫克为单位的实数值，表示临床医生为该患者输入的标准剂量。用 $D_s$ 表示，单位为 mg。\n  - \"prefetch\"：一个可以包含以下内容的字典：\n    - \"genomics\"：一个包含零个或多个字典的列表，每个字典包含：\n      - \"gene\"：一个不区分大小写的字符串，等于 \"TPMT\" 或 \"NUDT15\"。\n      - \"phenotype\"：一个不区分大小写的字符串，等于 \"Normal metabolizer\"、\"Intermediate metabolizer\" 或 \"Poor metabolizer\"。用 $P_{\\mathrm{TPMT}}$ 表示 TPMT 表型，用 $P_{\\mathrm{NUDT15}}$ 表示 NUDT15 表型。\n\n触发语义：\n- 当且仅当 \"hook\" 的值等于 \"medication-prescribe\" 且 \"medication\" 的值（不区分大小写）在硫嘌呤类药物集合 {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"} 中时，规则才会触发。否则，不应应用任何药物基因组学调整。\n\n用作基础起点的剂量调整事实：\n- 对于 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 \"Normal metabolizer\" 的患者，初始剂量乘数为 $m = 1.0$。\n- 对于 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 中恰好一个为 \"Intermediate metabolizer\" 且另一个为 \"Normal metabolizer\" 的患者，初始剂量乘数为 $m = 0.5$。\n- 对于 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 \"Intermediate metabolizer\" 的患者，初始剂量乘数为 $m = 0.2$。\n- 对于 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 任一为 \"Poor metabolizer\" 的患者，初始剂量乘数为 $m = 0.1$。\n- 如果 \"genomics\" 中缺少某个基因，则在计算 $m$ 时将该缺失基因视为 \"Normal metabolizer\"。\n- 如果规则不触发，则设置 $m = 1.0$。\n\n决策计算与输出：\n- 设 $D_s$ 是以毫克为单位的标准剂量。\n- 计算推荐剂量 $D_r = m \\times D_s$，单位为毫克。\n- 使用半值向上取整法将 $D_r$ 圆整到最接近的整数毫克（即，小数部分恰好为 $0.5$ 的值向上舍入，远离零）。\n- 您的程序必须只输出一行，其中包含指定测试套件的整数推荐值，以逗号分隔并用方括号括起来。\n\n单位规范：\n- 所有剂量在取整后必须以毫克 (mg) 为单位表示为整数。\n\n角度和百分比规范：\n- 不使用角度。\n- 任何小数乘数都必须视为小数（例如，$0.5$），而不是百分比。\n\n测试套件：\n对于下面的每个测试用例，构建有效载荷并计算最终的整数 $D_r$（单位为 mg）。\n\n- 测试用例 1（正常路径，两者均为正常代谢型）：\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 2（单个中间代谢型）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 3（一个基因为弱代谢型）：\n  - \"medication\" = \"thioguanine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Poor metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 4（两者均为中间代谢型）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 40$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Intermediate metabolizer\"\n  - 预期触发：是\n\n- 测试用例 5（缺少基因组学信息，默认行为）：\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 60$ mg\n  - \"genomics\" 列表为空\n  - 预期触发：是\n\n- 测试用例 6（半值向上取整检查）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 35$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Poor metabolizer\"\n  - 预期触发：是\n\n- 测试用例 7（非目标药物，规则不触发）：\n  - \"medication\" = \"clopidogrel\"\n  - $D_s = 75$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：否\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含七个测试用例的结果，格式为用方括号括起来的逗号分隔列表（例如，“[$x_1,x_2,x_3,x_4,x_5,x_6,x_7$]”），其中每个 $x_i$ 是按顺序排列的测试用例 $i$ 的整数 $D_r$ 值（单位为 mg）。",
            "solution": "该问题要求基于临床药物遗传学实施联盟 (CPIC) 的硫嘌呤类药物剂量指南，形式化并实现一条临床决策支持 (CDS) 规则。该实现必须与 CDS Hooks 规范兼容，将硫嘌呤S-甲基转移酶 ($TPMT$) 和 nudix 水解酶 15 ($NUDT15$) 的药物基因组学表型转化为具体的剂量建议。解决方案需要将所提供的临床逻辑系统地、一步步地转化为计算算法。\n\n首先，有必要对问题陈述进行验证。\n\n**第 1 步：提取已知信息**\n\n- **钩子规范**：规则由 CDS Hooks 请求触发，其中 `hook` 标识符为 `\"medication-prescribe\"`。\n- **触发药物集**：如果处方 `medication` 是 `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` 中的一种（不区分大小写），则规则适用。\n- **输入数据结构（有效载荷）**：\n  - `hook`：字符串，必须为 `\"medication-prescribe\"`。\n  - `context`：字典，包含：\n    - `medication`：字符串，药物名称。\n    - `standardDoseMg`：实数，标准剂量 $D_s$，单位为毫克 (mg)。\n  - `prefetch`：字典，可包含：\n    - `genomics`：字典列表，每个字典包含：\n      - `gene`：字符串，`\"TPMT\"` 或 `\"NUDT15\"`（不区分大小写）。\n      - `phenotype`：字符串，`\"Normal metabolizer\"`、`\"Intermediate metabolizer\"` 或 `\"Poor metabolizer\"`（不区分大小写）。我们用 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 表示。\n- **剂量调整规则（乘数 $m$）**：\n  1. 如果不满足触发条件，剂量乘数 $m$ 为 $1.0$。\n  2. 如果缺少某个基因的表型，则假定为 `\"Normal metabolizer\"`。\n  3. 如果 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 `\"Normal metabolizer\"`，则 $m = 1.0$。\n  4. 如果一个表型为 `\"Intermediate metabolizer\"` 而另一个为 `\"Normal metabolizer\"`，则 $m = 0.5$。\n  5. 如果 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 `\"Intermediate metabolizer\"`，则 $m = 0.2$。\n  6. 如果 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 任一为 `\"Poor metabolizer\"`，则 $m = 0.1$。\n- **计算与输出**：\n  - 推荐剂量计算公式为 $D_r = m \\times D_s$。\n  - 最终结果 $D_r$ 必须使用半值向上取整法圆整到最接近的整数。\n  - 输出为单行字符串，包含测试套件的逗号分隔整数结果，并用方括号括起来。\n- **测试套件**：提供了七个具体的测试用例，定义了输入和预期的触发行为。\n\n**第 2 步：使用提取的已知信息进行验证**\n\n- **科学依据**：该问题植根于已确立的药物基因组学原理，并引用了现实世界中基于证据的 CPIC 指南和 CDS Hooks 技术标准。$TPMT$/$NUDT15$ 基因变异、酶活性和硫嘌呤代谢之间的关系是个性化医疗的基石。所提供的剂量调整因子是简化的，但代表了实际的临床指南。该问题在科学上是合理的。\n- **定义明确**：该问题定义明确。输入被严格定义，剂量调整的逻辑规则是确定性的，并涵盖了所有指定的组合，缺失数据的默认行为也已明确说明。计算和取整规则毫不含糊，确保任何有效输入都有唯一的解决方案。\n- **客观性**：问题以精确、客观的语言陈述，没有歧义或主观论断。所有参数和规则都是定量的或逻辑的。\n\n**第 3 步：结论与行动**\n\n问题陈述是有效的。它具有科学依据、定义明确且客观。它为开发计算解决方案提供了一套完整且一致的要求。我们可以继续进行解决方案设计。\n\n**解决方案设计与算法**\n\n解决方案的核心是一个函数，该函数处理输入有效载荷，应用触发和剂量逻辑，并返回计算出的剂量。此过程可分为四个主要阶段。\n\n**1. 规则触发评估**\n第一步是确定是否应应用基于药物基因组学的剂量规则。这由两个必须同时满足的条件决定：\n- CDS Hooks 调用的上下文必须是药物处方事件。通过检查输入 `hook` 键的值是否等于 `\"medication-prescribe\"` 来验证。\n- 处方药物必须是硫嘌呤类药物。通过检查 `medication` 键的不区分大小写的值是否存在于集合 `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` 中来验证。\n\n如果任一条件不满足，规则不触发。在这种情况下，剂量乘数 $m$ 设置为 $1.0$，推荐剂量 $D_r$ 就是标准剂量 $D_s$。\n\n**2. 确定表型及默认值**\n如果规则触发，下一步是确定患者的 $TPMT$ 和 $NUDT15$ 代谢表型。问题指定了默认值：如果有效载荷的 `prefetch` 部分未提供某个基因的表型，则应将其视为 `\"Normal metabolizer\"`。\n因此，算法将初始化表型 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 为 `\"Normal metabolizer\"`。然后，它遍历 `prefetch` 数据中的 `genomics` 列表。对于每个条目，它识别基因（例如，`\"TPMT\"` 或 `\"NUDT15\"`）及其对应的表型，并更新初始化的值。此过程对于基因名称和表型描述都必须不区分大小写。\n\n**3. 剂量乘数 ($m$) 计算**\n在确定了 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 后，可以根据提供的规则层次结构计算剂量乘数 $m$。为确保正确性，这些规则必须按优先级顺序评估，从最关键的表型（弱代谢型）开始。让我们将表型规范地表示为 NM（正常代谢型）、IM（中间代謝型）和 PM（弱代謝型）。\n\n逻辑如下：\n- **条件 1（最高优先级）**：如果 $P_{\\mathrm{TPMT}} = \\text{PM}$ 或 $P_{\\mathrm{NUDT15}} = \\text{PM}$，则设置 $m = 0.1$。此规则覆盖所有其他规则。\n- **条件 2**：否则，如果 $P_{\\mathrm{TPMT}} = \\text{IM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{IM}$，则设置 $m = 0.2$。\n- **条件 3**：否则，如果 ($P_{\\mathrm{TPMT}} = \\text{IM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{NM}$) 或 ($P_{\\mathrm{TPMT}} = \\text{NM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{IM}$)，则设置 $m = 0.5$。\n- **条件 4（基本情况）**：否则（这意味着 $P_{\\mathrm{TPMT}} = \\text{NM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{NM}$），则设置 $m = 1.0$。\n\n这种结构化的评估确保根据指定的临床逻辑选择正确的乘数。\n\n**4. 最终剂量计算与取整**\n最后一步是计算推荐剂量 $D_r$，并按要求格式化。\n- 未取整的推荐剂量按以下公式计算：\n$$D_r = m \\times D_s$$\n其中 $D_s$ 是输入上下文中提供的标准剂量。\n- 问题指定使用半值向上取整法圆整到最接近的整数。对于非负值 $x$，这在计算上可以实现为 $\\lfloor x + 0.5 \\rfloor$，对于正数，在 Python 中等效于 `int(x + 0.5)`。\n\n通过对提供的测试套件中的每个测试用例应用此四步流程，我们可以生成所需的整数剂量建议列表。最终的实现将此逻辑封装到一个完整、可运行的程序中。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print the final results.\n    \"\"\"\n\n    # Define the test cases from the problem statement as a list of dictionaries.\n    test_cases = [\n        # Test case 1 (happy path, both normal)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 2 (single intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 3 (poor for one gene)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"thioguanine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Poor metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 4 (both intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 40},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Intermediate metabolizer\"},\n                ]\n            },\n        },\n        # Test case 5 (missing genomics, default behavior)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 60},\n            \"prefetch\": {\"genomics\": []},\n        },\n        # Test case 6 (half-up rounding check)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 35},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Poor metabolizer\"},\n                ]\n            },\n        },\n        # Test case 7 (non-target medication, rule does not trigger)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"clopidogrel\", \"standardDoseMg\": 75},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n    ]\n\n    results = [compute_recommendation(case) for case in test_cases]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_recommendation(payload: dict) -> int:\n    \"\"\"\n    Computes a thiopurine dosing recommendation based on a CDS Hooks payload.\n\n    Args:\n        payload: A dictionary representing the CDS Hooks request.\n\n    Returns:\n        The recommended dose in milligrams, rounded to the nearest integer.\n    \"\"\"\n    \n    # Define constants for the rule logic.\n    THIOPURINES = {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}\n    \n    # Phenotype canonical representations for internal use.\n    NM = \"normal metabolizer\"\n    IM = \"intermediate metabolizer\"\n    PM = \"poor metabolizer\"\n\n    context = payload.get(\"context\", {})\n    standard_dose = context.get(\"standardDoseMg\", 0.0)\n    medication = context.get(\"medication\", \"\").lower()\n    hook = payload.get(\"hook\", \"\")\n\n    # 1. Rule Trigger Evaluation\n    # Rule triggers only for thiopurine prescriptions.\n    if not (hook == \"medication-prescribe\" and medication in THIOPURINES):\n        # If the rule doesn't trigger, use the standard dose (multiplier is 1.0).\n        # Rounding is still applied to handle potential float inputs.\n        return int(standard_dose + 0.5)\n\n    # 2. Phenotype Determination with Defaults\n    # Default phenotypes to \"Normal metabolizer\".\n    phenotypes = {\"tpmt\": NM, \"nudt15\": NM}\n\n    prefetch = payload.get(\"prefetch\", {})\n    genomics_data = prefetch.get(\"genomics\", [])\n    \n    for record in genomics_data:\n        gene = record.get(\"gene\", \"\").lower()\n        phenotype = record.get(\"phenotype\", \"\").lower()\n        if gene in phenotypes:\n            phenotypes[gene] = phenotype\n    \n    p_tpmt = phenotypes[\"tpmt\"]\n    p_nudt15 = phenotypes[\"nudt15\"]\n\n    # 3. Dose Multiplier (m) Calculation\n    # The rules are checked in order of highest precedence (most severe impact).\n    multiplier = 1.0  # Default multiplier\n\n    if p_tpmt == PM or p_nudt15 == PM:\n        multiplier = 0.1\n    elif p_tpmt == IM and p_nudt15 == IM:\n        multiplier = 0.2\n    elif (p_tpmt == IM and p_nudt15 == NM) or (p_tpmt == NM and p_nudt15 == IM):\n        multiplier = 0.5\n    elif p_tpmt == NM and p_nudt15 == NM:\n        multiplier = 1.0\n        \n    # 4. Final Dose Calculation and Rounding\n    recommended_dose_unrounded = multiplier * standard_dose\n    \n    # Apply half-up rounding. For positive numbers, int(x + 0.5) suffices.\n    final_dose = int(recommended_dose_unrounded + 0.5)\n    \n    return final_dose\n\nsolve()\n```"
        }
    ]
}