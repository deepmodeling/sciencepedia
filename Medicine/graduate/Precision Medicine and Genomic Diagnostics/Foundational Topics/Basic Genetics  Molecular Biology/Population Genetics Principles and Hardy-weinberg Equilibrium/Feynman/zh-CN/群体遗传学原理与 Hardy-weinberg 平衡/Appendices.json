{
    "hands_on_practices": [
        {
            "introduction": "在检验哈迪-温伯格平衡（HWE）之前，我们必须首先根据样本数据估算等位基因频率。这项练习将指导您推导等位基因频率的最大似然估计（Maximum Likelihood Estimator, MLE），这是统计遗传学的基石 。通过证明这种直观的“基因计数”方法不仅是最大似然估计，而且是无偏的，您将为所有后续分析奠定坚实的理论基础。",
            "id": "4370662",
            "problem": "一家临床基因组学实验室正在估计一个双等位基因单核苷酸变异的等位基因频率，以便为精准医疗中的致病性分类提供证据阈值。在一个具有等位基因 $A$ 和 $a$ 的常染色体座位上，该实验室从 $n$ 个无亲缘关系的个体中观察到基因型计数 $(n_{AA}, n_{Aa}, n_{aa})$，这些个体通过高置信度的检测方法进行了分型。假设群体很大，个体是随机抽取的，并且该座位在随机交配下遵循Hardy-Weinberg平衡（HWE）模型，因此基因型 $AA$、$Aa$ 和 $aa$ 的概率分别为 $p^{2}$、$2p(1-p)$ 和 $(1-p)^{2}$，其中 $p$ 是等位基因 $A$ 的频率，$q=1-p$ 是等位基因 $a$ 的频率。将观察到的计数视为来自具有 $n$ 次试验和上述基因型概率的多项式抽样模型的一次实现。\n\n从多项式似然的基本定义出发，且不假设任何特定的估计量，推导等位基因频率 $p$ 的最大似然估计量（MLE）$\\hat{p}$，用 $(n_{AA}, n_{Aa}, n_{aa}, n)$ 表示。然后，利用多项式模型下期望的熟知性质，计算在有限样本量 $n$ 下的期望值 $\\mathbb{E}[\\hat{p}]$ 和偏差 $\\operatorname{Bias}(\\hat{p})=\\mathbb{E}[\\hat{p}]-p$。\n\n将偏差报告为单个实数。如果您的结果是精确的，请不要四舍五入。不需要物理单位。",
            "solution": "该实验室正在观察一个双等位基因座位上的基因型计数，Hardy-Weinberg平衡（HWE）模型根据等位基因频率 $p$ 指定了基因型概率，对于 $AA$ 是 $p^{2}$，对于 $Aa$ 是 $2p(1-p)$，对于 $aa$ 是 $(1-p)^{2}$。设观察到的计数为 $(n_{AA}, n_{Aa}, n_{aa})$，总数为 $n=n_{AA}+n_{Aa}+n_{aa}$。在多项式抽样框架下，$p$ 的似然函数为\n$$\nL(p \\mid n_{AA}, n_{Aa}, n_{aa}) \\propto \\left(p^{2}\\right)^{n_{AA}} \\left(2p(1-p)\\right)^{n_{Aa}} \\left((1-p)^{2}\\right)^{n_{aa}},\n$$\n其中多项式系数相对于 $p$ 是一个常数，在求最大值时可以省略。对数似然函数为\n$$\n\\ell(p) = n_{AA} \\ln\\left(p^{2}\\right) + n_{Aa} \\ln\\left(2p(1-p)\\right) + n_{aa} \\ln\\left((1-p)^{2}\\right).\n$$\n使用对数性质，这可以简化为\n$$\n\\ell(p) = 2 n_{AA} \\ln p + n_{Aa} \\left(\\ln 2 + \\ln p + \\ln(1-p)\\right) + 2 n_{aa} \\ln(1-p).\n$$\n项 $n_{Aa} \\ln 2$ 相对于 $p$ 是常数，不影响最大化过程。对 $\\ell(p)$ 关于 $p$ 求导：\n$$\n\\frac{d\\ell}{dp} = \\frac{2 n_{AA}}{p} + \\frac{n_{Aa}}{p} - \\frac{n_{Aa}}{1-p} - \\frac{2 n_{aa}}{1-p} = \\frac{2 n_{AA} + n_{Aa}}{p} - \\frac{n_{Aa} + 2 n_{aa}}{1-p}.\n$$\n令导数等于零以找到临界点：\n$$\n\\frac{2 n_{AA} + n_{Aa}}{p} = \\frac{n_{Aa} + 2 n_{aa}}{1-p}.\n$$\n交叉相乘以求解 $p$：\n$$\n(2 n_{AA} + n_{Aa})(1-p) = (n_{Aa} + 2 n_{aa}) p,\n$$\n$$\n(2 n_{AA} + n_{Aa}) - (2 n_{AA} + n_{Aa}) p = p n_{Aa} + 2 p n_{aa},\n$$\n$$\n(2 n_{AA} + n_{Aa}) = p \\left[(2 n_{AA} + n_{Aa}) + n_{Aa} + 2 n_{aa}\\right] = p \\left[2 n_{AA} + 2 n_{Aa} + 2 n_{aa}\\right] = 2 n p.\n$$\n因此，最大似然估计量是\n$$\n\\hat{p} = \\frac{2 n_{AA} + n_{Aa}}{2 n}.\n$$\n\n我们现在在参数为 $(p^{2}, 2p(1-p), (1-p)^{2})$ 的多项式模型下评估期望 $\\mathbb{E}[\\hat{p}]$。计数的期望值为\n$$\n\\mathbb{E}[n_{AA}] = n p^{2}, \\quad \\mathbb{E}[n_{Aa}] = n \\cdot 2p(1-p), \\quad \\mathbb{E}[n_{aa}] = n (1-p)^{2}.\n$$\n根据期望的线性性质，\n$$\n\\mathbb{E}[\\hat{p}] = \\mathbb{E}\\left[\\frac{2 n_{AA} + n_{Aa}}{2 n}\\right] = \\frac{2 \\mathbb{E}[n_{AA}] + \\mathbb{E}[n_{Aa}]}{2 n} = \\frac{2 n p^{2} + n \\cdot 2p(1-p)}{2 n}.\n$$\n简化分子：\n$$\n2 n p^{2} + 2 n p(1-p) = 2 n \\left(p^{2} + p - p^{2}\\right) = 2 n p.\n$$\n因此，\n$$\n\\mathbb{E}[\\hat{p}] = \\frac{2 n p}{2 n} = p.\n$$\n偏差定义为\n$$\n\\operatorname{Bias}(\\hat{p}) = \\mathbb{E}[\\hat{p}] - p = p - p = 0.\n$$\n因此，在有限样本量 $n$ 下，从一个由等位基因频率 $p$ 和Hardy-Weinberg基因型概率表征的群体中进行多项式抽样，估计量 $\\hat{p} = (2 n_{AA} + n_{Aa})/(2 n)$ 是无偏的，其偏差恰好为零。",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "估算出等位基因频率后，我们现在可以提出一个关键的质量控制问题：我们样本中观察到的基因型计数是否显著偏离了HWE所预测的比例？本练习将引导您运用最常见的方法——皮尔逊卡方检验来回答这个问题 。您将学会计算期望的基因型计数，并使用卡方统计量来量化偏差，这是识别基因分型错误或群体分层等潜在问题的必备技能。",
            "id": "4370688",
            "problem": "一个临床药物基因组学实验室旨在验证一个与药物不良反应相关的基因中的双等位基因单核苷酸变异的基因型质量，以便在将数据用于精准给药之前进行确认。该队列由 $N$ 名同质性大陆祖源的无亲缘关系个体组成，他们通过经临床实验室改进修正案(CLIA)验证的流程进行了基因分型，并对不一致的检出结果进行了正交验证。假设该位点的两个等位基因分别表示为 $A$ 和 $a$，观察到的基因型计数为 $n_{AA} = 290$，$n_{Aa} = 190$，$n_{aa} = 20$，其中 $N = n_{AA} + n_{Aa} + n_{aa} = 500$。\n\n仅使用群体遗传学的核心定义和基本原理，按以下步骤进行：\n- 根据观察到的基因型计数和 $N$ 定义等位基因 $A$ 的频率 $p$ 和等位基因 $a$ 的频率 $q$，并解释在配子随机结合的情况下 $p$ 和 $q$ 之间的关系。\n- 根据配子随机结合模型和哈迪-温伯格平衡 (HWE) 的基本假设，用 $p$ 和 $q$ 推导出预期的基因型频率，不要引用任何预先记忆的公式。\n- 使用您推导出的表达式，计算给定样本在 HWE 下的预期基因型计数。\n- 将此视为一个拟合优度问题，其中等位基因频率参数从样本中估计，并使用一个自由度计算偏离 HWE 的卡方检验统计量。\n\n在您的推理中，请清楚阐明在临床基因组学背景下，该检验的卡方近似有效的条件（例如，独立性、祖源同质性和最小预期单元格计数），并简要说明所用自由度的理由。\n\n将最终的卡方检验统计量四舍五入至四位有效数字。以无单位实数的形式表示最终答案。",
            "solution": "第一步是根据观察到的基因型计数来定义等位基因频率。样本中的个体总数为 $N = n_{AA} + n_{Aa} + n_{aa} = 290 + 190 + 20 = 500$。由于每个二倍体个体在该位点携带两个等位基因，因此样本中的等位基因总数为 $2N = 1000$。\n\n等位基因 $A$ 的频率（用 $p$ 表示）是 $A$ 等位基因的总数除以样本中等位基因的总数。基因型为 $AA$ 的个体携带两个 $A$ 等位基因，基因型为 $Aa$ 的个体携带一个 $A$ 等位基因。\n等位基因 $A$ 的总数为 $2 \\times n_{AA} + 1 \\times n_{Aa}$。\n因此，频率 $p$ 为：\n$$p = \\frac{2n_{AA} + n_{Aa}}{2N}$$\n代入给定值：\n$$p = \\frac{2(290) + 190}{2(500)} = \\frac{580 + 190}{1000} = \\frac{770}{1000} = 0.77$$\n\n同样，等位基因 $a$ 的频率（用 $q$ 表示）是 $a$ 等位基因的总数除以等位基因的总数。基因型为 $aa$ 的个体携带两个 $a$ 等位基因，基因型为 $Aa$ 的个体携带一个 $a$ 等位基因。\n等位基因 $a$ 的总数为 $1 \\times n_{Aa} + 2 \\times n_{aa}$。\n因此，频率 $q$ 为：\n$$q = \\frac{n_{Aa} + 2n_{aa}}{2N}$$\n代入给定值：\n$$q = \\frac{190 + 2(20)}{2(500)} = \\frac{190 + 40}{1000} = \\frac{230}{1000} = 0.23$$\n\n对于一个双等位基因位点，只有两种可能的等位基因，$A$ 和 $a$。因此，它们的频率之和必须为 $1$。这可以从定义中得出：\n$$p + q = \\frac{2n_{AA} + n_{Aa}}{2N} + \\frac{n_{Aa} + 2n_{aa}}{2N} = \\frac{2n_{AA} + 2n_{Aa} + 2n_{aa}}{2N} = \\frac{2(n_{AA} + n_{Aa} + n_{aa})}{2N} = \\frac{2N}{2N} = 1$$\n我们计算出的值与此关系一致：$0.77 + 0.23 = 1.00$。\n\n接下来，我们在哈迪-温伯格平衡 (HWE) 的假设下推导预期的基因型频率。HWE 描述了在特定理想化条件下群体中的遗传稳定状态，这些条件包括随机交配（泛交）、大的群体规模，以及没有突变、基因流和自然选择等进化影响。在随机交配（等同于配子随机结合）的情况下，我们可以将基因型的形成建模为独立的概率事件。\n考虑一个概念上的基因库，其中携带等位基因 $A$ 的配子以频率 $p$ 存在，携带等位基因 $a$ 的配子以频率 $q$ 存在。形成一个二倍体基因型等同于从这个基因库中独立抽取两个配子。\n形成纯合子 $AA$ 基因型的概率是抽取一个 $A$ 配子，然后再抽取另一个 $A$ 配子的概率。由于这些是独立事件，该概率为 $p \\times p = p^2$。\n$$f(AA) = p^2$$\n形成纯合子 $aa$ 基因型的概率是抽取一个 $a$ 配子，然后再抽取另一个 $a$ 配子的概率。该概率为 $q \\times q = q^2$。\n$$f(aa) = q^2$$\n杂合子 $Aa$ 基因型可以通过两种互斥的方式形成：\n1. 先抽取一个 $A$ 配子，然后抽取一个 $a$ 配子。概率为 $p \\times q$。\n2. 先抽取一个 $a$ 配子，然后抽取一个 $A$ 配子。概率为 $q \\times p$。\n形成杂合子的总概率是这些概率之和：$pq + qp = 2pq$。\n$$f(Aa) = 2pq$$\n这些是在 HWE 下的预期基因型频率。这些频率的总和为 $p^2 + 2pq + q^2 = (p+q)^2 = 1^2 = 1$，符合预期。\n\n现在，我们为给定的大小为 $N=500$ 的样本计算预期的基因型计数。每个基因型的预期计数是其预期频率乘以总样本量 $N$。我们使用从样本数据中估计出的等位基因频率 $p=0.77$ 和 $q=0.23$。\n\n$AA$ 的预期计数：\n$$E_{AA} = N \\times p^2 = 500 \\times (0.77)^2 = 500 \\times 0.5929 = 296.45$$\n$Aa$ 的预期计数：\n$$E_{Aa} = N \\times 2pq = 500 \\times 2 \\times 0.77 \\times 0.23 = 500 \\times 0.3542 = 177.10$$\n$aa$ 的预期计数：\n$$E_{aa} = N \\times q^2 = 500 \\times (0.23)^2 = 500 \\times 0.0529 = 26.45$$\n预期计数之和为 $296.45 + 177.10 + 26.45 = 500$，与样本量 $N$ 相符。\n\n最后，我们计算卡方 ($\\chi^2$) 检验统计量，以评估观察计数与预期计数之间的拟合优度。公式为：\n$$\\chi^2 = \\sum_{\\text{genotypes}} \\frac{(\\text{Observed} - \\text{Expected})^2}{\\text{Expected}}$$\n观察到的计数为 $O_{AA} = 290$，$O_{Aa} = 190$，$O_{aa} = 20$。\n$$\\chi^2 = \\frac{(O_{AA} - E_{AA})^2}{E_{AA}} + \\frac{(O_{Aa} - E_{Aa})^2}{E_{Aa}} + \\frac{(O_{aa} - E_{aa})^2}{E_{aa}}$$\n$$\\chi^2 = \\frac{(290 - 296.45)^2}{296.45} + \\frac{(190 - 177.10)^2}{177.10} + \\frac{(20 - 26.45)^2}{26.45}$$\n$$\\chi^2 = \\frac{(-6.45)^2}{296.45} + \\frac{(12.9)^2}{177.10} + \\frac{(-6.45)^2}{26.45}$$\n$$\\chi^2 = \\frac{41.6025}{296.45} + \\frac{166.41}{177.10} + \\frac{41.6025}{26.45}$$\n$$\\chi^2 \\approx 0.1403359 + 0.9396386 + 1.5728733$$\n$$\\chi^2 \\approx 2.6528478$$\n将结果四舍五入至四位有效数字，得到 $2.653$。\n\n该检验的自由度理由如下。拟合优度检验中自由度 ($df$) 的通用公式为 $df = (\\text{类别数}) - 1 - (\\text{从数据中估计的参数个数})$。我们有 $3$ 个基因型类别（$AA$、$Aa$、$aa$）。我们从数据中估计了一个独立参数，即等位基因频率 $p$（因为 $q$ 由 $p$ 通过 $q=1-p$ 决定）。因此，自由度为 $df = 3 - 1 - 1 = 1$。\n\n在临床基因组学背景下，该卡方检验的有效性取决于几个条件的满足：\n1.  **观测的独立性**：问题陈述该队列由 $N$ 名**无亲缘关系**的个体组成。这是卡方检验的一个关键假设。如果未考虑隐性亲缘关系，则会违反此假设。\n2.  **祖源同质性**：问题指明了这是一个具有**同质性大陆祖源**的队列。这一点至关重要，因为即使基因分型完美无误，群体混合（分层）也是导致显著偏离 HWE 的一个众所周知的原因。进行 HWE 检验是检测此类问题的标准质量控制措施。\n3.  **最小预期单元格计数**：卡方分布是对检验统计量的离散多项分布的连续近似。当预期计数足够大时，此近似有效。一个常见的经验法则是所有预期计数应至少为 $5$。在这里，我们的预期计数分别为 $E_{AA} = 296.45$，$E_{Aa} = 177.10$ 和 $E_{aa} = 26.45$，所有这些都远高于 $5$ 的阈值。因此，使用卡方近似是合理的。\n4.  **大样本量**：总样本量 $N=500$ 足够大，可以提供稳定的等位基因频率估计，并满足卡方检验分布特性所依赖的假设。\n经 CLIA 验证的流程这一背景意味着高质量的基因分型，这最大限度地减少了技术性假象（例如，等位基因差异性扩增、不正确的基因型检出）成为偏离 HWE 来源的可能性。因此，一个显著的偏差更可能指向群体遗传学假设的违背，比如分层，而这正是该检验旨在检测的问题。",
            "answer": "$$\n\\boxed{2.653}\n$$"
        },
        {
            "introduction": "卡方检验是一种近似方法，在样本量较小或等位基因稀有时可能并不可靠。为了进行更严谨的分析，我们会使用“精确检验”。这项高级练习将挑战您推导HWE精确检验的底层概率分布，然后通过编程实现它来计算p值 。这项练习弥合了统计理论与现代基因组诊断中所需的实用编程技能之间的鸿沟。",
            "id": "4370711",
            "problem": "在一个用于精准医疗和基因组诊断学质量控制的队列中，对一个二倍体、双等位基因座进行了基因分型。假设从一个无近亲繁殖、无基因分型错误且该基因座上无选择作用的随机交配群体中，抽取了一个包含 $n$ 个无亲缘关系个体的样本。在哈代-温伯格平衡 (HWE) 条件下，基因型计数遵循由配子随机结合产生的哈代-温伯格比例。考虑用于HWE的条件精确检验，该检验固定观测到的等位基因计数，并枚举出与这些固定的等位基因计数和固定的样本量相一致的所有可能的基因型计数配置。\n\n基本原理：\n- 配子随机结合意味着，在 $2n$ 条抽样染色体中某一特定等位基因的总数给定的条件下，将这 $2n$ 个等位基因配对成 $n$ 个无序二倍体基因型的所有方式都是等可能的。\n- 基因型配置由杂合子的数量决定。给定等位基因 $A$ 的固定计数（记为 $m$）和杂合子的数量 $h$，剩余的纯合子计数由等位基因和个体数量守恒完全确定。\n\n定义：\n- 设观测到的基因型 $AA$、$Aa$ 和 $aa$ 的计数分别为 $(n_{AA}, n_{Aa}, n_{aa})$。\n- 设样本量为 $n = n_{AA} + n_{Aa} + n_{aa}$。\n- 设 $m = 2 n_{AA} + n_{Aa}$ 为 $2n$ 条抽样染色体中等位基因 $A$ 的总计数。\n- 在固定的 $(n, m)$ 下，可行的基因型配置对应于所有满足以下条件的整数 $h$（杂合子数量）：$h$ 与 $m$ 具有相同的奇偶性，且 $0 \\le h \\le \\min(m, 2n - m)$；对于每个可行的 $h$，其隐含的纯合子计数为 $n_{AA} = (m - h)/2$ 和 $n_{aa} = (2n - m - h)/2$。\n\n任务：\n- 使用配子随机结合模型和组合计数论证，从第一性原理推导在哈代-温伯格平衡（HWE）下杂合子数量 $h$ 的条件概率质量函数。该推导必须从以下假设出发：在给定 $m$ 的条件下，将 $2n$ 个等位基因配对成 $n$ 个无序二倍体基因型的每种方式都是等可能的。\n- 实施一个程序，该程序：\n  1. 从 $(n_{AA}, n_{Aa}, n_{aa})$ 计算 $n$ 和 $m$。\n  2. 枚举与 $(n, m)$ 一致的所有可行 $h$ 值。\n  3. 对每个可行的 $h$ 计算条件概率 $P(h \\mid n, m)$。\n  4. 计算观测配置的 mid-p 值，其定义为所有严格小于观测配置概率的概率之和，再加上观测配置概率的一半。形式上，设 $p_{\\text{obs}} = P(h_{\\text{obs}} \\mid n, m)$，则 mid-p 值为\n     $$p_{\\text{mid}} = \\sum_{h : P(h \\mid n, m)  p_{\\text{obs}}} P(h \\mid n, m) + \\frac{1}{2} p_{\\text{obs}}.$$\n  5. 稳健地处理边界情况，包括只有一个可行配置的情况（例如 $m = 0$，$m = 2n$，或 $n = 1$ 且 $m = 1$），在这些情况下 $p_{\\text{mid}}$ 必须等于 $0.5$。\n\n数值要求：\n- 所有输出必须以十进制小数表示。\n- 将每个报告的 mid-p 值四舍五入到恰好 $12$ 位小数。\n\n测试套件：\n- 使用以下测试用例，以 $(n_{AA}, n_{Aa}, n_{aa})$ 形式给出：\n  1. $(36, 48, 16)$，其中 $n = 100$ 且 $m = 120$。\n  2. $(0, 50, 0)$，其中 $n = 50$ 且 $m = 50$。\n  3. $(30, 0, 0)$，其中 $n = 30$ 且 $m = 60$。\n  4. $(12, 1, 12)$，其中 $n = 25$ 且 $m = 25$。\n  5. $(20, 18, 2)$，其中 $n = 40$ 且 $m = 58$。\n  6. $(0, 1, 0)$，其中 $n = 1$ 且 $m = 1$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含六个测试用例的 mid-p 值，格式为一个用方括号括起来的逗号分隔列表，每个值都四舍五入到 $12$ 位小数（例如，$[0.123456789012,0.500000000000,0.000000000001]$）。不应打印任何其他文本。",
            "solution": "目标是推导在哈代-温伯格平衡（HWE）下杂合子数量 $h$ 的条件概率质量函数（PMF），然后实现一个算法来计算观测到的基因型配置的 mid-p 值。\n\n### PMF $P(h \\mid n, m)$ 的推导\n\n推导过程源于问题陈述中指定的群体遗传学和统计推断的第一性原理。我们考虑从一个大型的随机交配（panmictic）群体中随机抽取 $n$ 个二倍体个体。设该基因座上的两个等位基因为 $A$ 和 $a$，其群体频率分别为 $p$ 和 $q=1-p$。\n\n1.  **基因型计数的无条件概率**：在 HWE 下，基因型 $AA$、$Aa$ 和 $aa$ 出现的概率分别为 $p^2$、$2pq$ 和 $q^2$。对于一个包含 $n$ 个个体的随机样本，这些基因型的计数 $(n_{AA}, n_{Aa}, n_{aa})$ 服从多项分布。设杂合子的数量为 $h = n_{Aa}$。观测到一组特定基因型计数的概率是：\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n!}{n_{AA}! h! n_{aa}!} (p^2)^{n_{AA}} (2pq)^{h} (q^2)^{n_{aa}} $$\n    这可以通过对含 $p$ 和 $q$ 的项进行分组来重新整理：\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^{2n_{AA}+h} q^{h+2n_{aa}} $$\n\n2.  **等位基因计数**：样本中等位基因 $A$ 的总计数是 $m = 2n_{AA} + h$，等位基因 $a$ 的总计数是 $2n-m = h + 2n_{aa}$。将这些代入表达式中，得到：\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^m q^{2n-m} $$\n    这是基因型计数和等位基因计数的联合概率（因为基因型计数决定了等位基因计数）。\n\n3.  **条件分布**：HWE 的精确检验以观测到的等位基因计数 $(m, 2n-m)$ 为条件，从而消除了未知的等位基因频率 $p$ 这个讨厌参数。为了找到条件概率 $P(n_{AA}, h, n_{aa} \\mid n, m)$，我们必须用联合概率除以在 $2n$ 个等位基因样本中观测到 $m$ 个等位基因 $A$ 的边缘概率。这个边缘概率服从二项分布，因为样本中的每个 $2n$ 等位基因都可以看作是从群体基因库中的一次独立抽取：\n    $$ P(m \\mid n) = \\binom{2n}{m} p^m q^{2n-m} = \\frac{(2n)!}{m!(2n-m)!} p^m q^{2n-m} $$\n\n4.  **最终 PMF**：条件概率是比率 $P(n_{AA}, h, n_{aa}) / P(m \\mid n)$：\n    $$ P(h \\mid n, m) = \\frac{\\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^m q^{2n-m}}{\\frac{(2n)!}{m!(2n-m)!} p^m q^{2n-m}} $$\n    涉及 $p$ 和 $q$ 的项相消，得到一个仅依赖于计数 $n, m,$ 和 $h$ 的分布：\n    $$ P(h \\mid n, m) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} \\frac{m!(2n-m)!}{(2n)!} $$\n    给定 $n$ 和 $m$，纯合子计数是 $h$ 的函数：$n_{AA} = (m-h)/2$ 和 $n_{aa} = (2n-m-h)/2$。代入这些可得到 $h$ 的最终 PMF：\n    $$ P(h \\mid n, m) = \\frac{n! \\, m! \\, (2n-m)! \\, 2^h}{(2n)! \\, h! \\, ((m-h)/2)! \\, ((2n-m-h)/2)!} $$\n    该分布对所有可行的整数 $h$ 值有定义，这些 $h$ 值与 $m$ 具有相同的奇偶性，并满足 $0 \\le h \\le \\min(m, 2n-m)$。这个公式是从第一性原理推导出的期望结果。它对应于多元超几何分布的一个特例，并将“计算将 $m$ 个‘A’等位基因和 $2n-m$ 个‘a’等位基因配对成 $n$ 个基因型的方法数”这一组合论证形式化。\n\n### Mid-p 值计算算法\n\n对于每个测试用例 $(n_{AA,obs}, n_{Aa,obs}, n_{aa,obs})$，程序实现以下步骤：\n\n1.  **初始化**：计算样本量 $n = n_{AA,obs} + n_{Aa,obs} + n_{aa,obs}$ 和等位基因计数 $m = 2n_{AA,obs} + n_{Aa,obs}$。观测到的杂合子数量为 $h_{obs} = n_{Aa,obs}$。\n\n2.  **可行配置的枚举**：生成与固定的 $n$ 和 $m$ 一致的所有可能的杂合子数量整数值 $h$。这些值必须与 $m$ 具有相同的奇偶性，并且位于区间 $[0, \\min(m, 2n-m)]$ 内。枚举的步长为 $2$，从 $m \\pmod 2$ 开始。\n\n3.  **概率计算**：对于每个可行的 $h$，使用推导出的 PMF 计算条件概率 $P(h \\mid n, m)$。为了处理阶乘中涉及的大数，计算在对数空间中进行，使用 `scipy.special` 库中的 `gammaln` 函数，其中 $\\log(k!) = \\text{gammaln}(k+1)$。对数概率为：\n    $$ \\log P(h) = \\log(n!) + \\log(m!) + \\log((2n-m)!) - \\log((2n)!) + h\\log(2) - \\log(h!) - \\log(n_{AA}!) - \\log(n_{aa}!) $$\n    然后通过取指数来恢复概率。为保持数值精度，在取指数之前，将对数概率减去其最大值进行平移，然后将得到的概率归一化，使其总和为 $1$。\n\n4.  **Mid-p 值计算**：问题将 mid-p 值定义为 $p_{\\text{mid}} = \\sum_{h : P(h)  p_{\\text{obs}}} P(h) + \\frac{1}{2} p_{\\text{obs}}$，其中 $p_{obs} = P(h_{obs} \\mid n, m)$。如果没有其他配置的概率等于 $p_{obs}$，这个公式是无歧义的。为了实现一个能够正确处理潜在概率相等情况（即多个不同的 $h$ 值产生相同的概率 $p_{obs}$）的稳健实现，采用了标准的统计学定义。这包括将所有严格小于 $p_{obs}$ 的概率相加，并加上 $p_{obs}$ 处总概率质量的一半：\n    $$ p_{\\text{mid}} = \\left( \\sum_{h : P(h)  p_{\\text{obs}}} P(h) \\right) + \\frac{1}{2} \\left( \\sum_{h : P(h) = p_{\\text{obs}}} P(h) \\right) $$\n    这确保了 p 值在所有条件下都是良定义的并表现正确，包括问题中规定的边界情况（例如，$m=0$，$m=2n$），在这些情况下，只有一个配置是可能的，mid-p 值正确地解析为 $0.5$。\n\n5.  **输出格式化**：每个测试用例最终计算出的 mid-p 值被四舍五入并格式化为恰好 $12$ 位小数。结果被收集并以指定的列表格式打印。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef calculate_mid_p(n_AA_obs, n_Aa_obs, n_aa_obs):\n    \"\"\"\n    Computes the mid-p value for the Hardy-Weinberg Equilibrium exact test.\n    \"\"\"\n    n = n_AA_obs + n_Aa_obs + n_aa_obs\n    if n == 0:\n        return 0.5  # A reasonable default for an empty sample\n\n    m = 2 * n_AA_obs + n_Aa_obs\n    h_obs = n_Aa_obs\n\n    # Enumerate all feasible heterozygote counts (h)\n    h_min = m % 2\n    h_max = min(m, 2 * n - m)\n    feasible_h = list(range(h_min, h_max + 1, 2))\n\n    # If there is only one possible configuration, the mid-p-value is 0.5\n    if len(feasible_h) = 1:\n        return 0.5\n\n    # Compute log-probabilities for each feasible h to avoid numerical overflow/underflow\n    log_probs = {}\n    \n    # Constant part of the log-probability formula: log( n! m! (2n-m)! / (2n)! )\n    log_constant = (gammaln(n + 1) + gammaln(m + 1) + \n                    gammaln(2 * n - m + 1) - gammaln(2 * n + 1))\n    \n    for h in feasible_h:\n        # Implied homozygote counts\n        n_AA = (m - h) // 2\n        n_aa = (2 * n - m - h) // 2\n        \n        # Variable part of the log-probability: log( 2^h / (h! n_AA! n_aa!) )\n        log_variable_part = h * np.log(2) - (gammaln(h + 1) + \n                                             gammaln(n_AA + 1) + \n                                             gammaln(n_aa + 1))\n        \n        log_probs[h] = log_constant + log_variable_part\n\n    # Normalize probabilities to ensure numerical stability\n    # 1. Shift by max log probability to prevent underflow when exponentiating\n    max_log_prob = max(log_probs.values())\n    probs = {h: np.exp(lp - max_log_prob) for h, lp in log_probs.items()}\n    \n    # 2. Normalize so that total probability is 1.0\n    sum_of_probs = sum(probs.values())\n    probs = {h: p / sum_of_probs for h, p in probs.items()}\n    \n    # Calculate the mid-p value\n    if h_obs not in probs:\n      # This should not happen for valid inputs derived from the same sample.\n      # If h_obs is not feasible, it's an impossible observation.\n      # This case is not specified by the problem, but we return a default.\n      return 1.0\n\n    p_obs = probs[h_obs]\n    \n    sum_less = 0.0\n    sum_equal = 0.0\n    \n    # Use a small tolerance for floating-point comparisons\n    tolerance = 1e-15 \n    \n    for p in probs.values():\n        if p  p_obs - tolerance:\n            sum_less += p\n        elif abs(p - p_obs)  tolerance:\n            sum_equal += p\n            \n    # The mid-p value is the sum of probabilities of less likely configurations\n    # plus half the probability of equally likely configurations.\n    p_mid = sum_less + 0.5 * sum_equal\n    \n    return p_mid\n\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and produce the final output.\n    \"\"\"\n    # Test cases given as (n_AA, n_Aa, n_aa)\n    test_cases = [\n        (36, 48, 16),\n        (0, 50, 0),\n        (30, 0, 0),\n        (12, 1, 12),\n        (20, 18, 2),\n        (0, 1, 0),\n    ]\n\n    results = []\n    for case in test_cases:\n        n_AA, n_Aa, n_aa = case\n        mid_p_value = calculate_mid_p(n_AA, n_Aa, n_aa)\n        results.append(mid_p_value)\n\n    # Format results to 12 decimal places and print in the required format\n    formatted_results = [f\"{r:.12f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```"
        }
    ]
}