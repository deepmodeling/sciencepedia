{
    "hands_on_practices": [
        {
            "introduction": "进行脉冲触发协方差（Spike-Triggered Covariance, STC）分析的第一步是确定刺激空间中的哪些维度真正影响了神经元的放电。由于数据有限，STC 矩阵的特征值可能仅因为随机波动而显得很大。本练习  将指导你通过标准的置换检验（permutation test）来严格建立统计显著性，同时控制多重比较带来的误差，这是避免错误发现的一项关键技能。",
            "id": "4021308",
            "problem": "您的任务是，使用具有明确生成模型的合成数据，实现、分析并测试一种用于发放触发协方差的基于置换的推断程序。目标是估计发放触发协方差之差的特征值的零分布，并控制多个特征值的族错误率（FWER）。\n\n考虑一个刺激时间序列，它由 $T$ 次独立抽样 $\\{\\mathbf{x}_t\\}_{t=1}^T$ 组成，其中每个 $\\mathbf{x}_t \\in \\mathbb{R}^d$ 均从一个零均值、单位协方差的 $d$ 维标准高斯分布中抽取。一个二元发放序列 $\\{s_t\\}_{t=1}^T$（其中 $s_t \\in \\{0,1\\}$）由一个神经元生成，其每个时间窗内的发放概率取决于刺激在两个潜在轴上的二次投影。具体来说，设 $\\mathbf{v}_1, \\mathbf{v}_2 \\in \\mathbb{R}^d$ 为标准正交单位向量。发放概率由以下逻辑斯谛模型给出\n$$\np_t \\equiv \\mathbb{P}(s_t = 1 \\mid \\mathbf{x}_t) = \\sigma\\!\\left(c_0 + \\theta_1\\, (\\mathbf{v}_1^\\top \\mathbf{x}_t)^2 + \\theta_2\\, (\\mathbf{v}_2^\\top \\mathbf{x}_t)^2\\right),\n$$\n其中 $\\sigma(z) = \\frac{1}{1 + e^{-z}}$，$c_0 \\in \\mathbb{R}$ 是一个基线logit，$\\theta_1, \\theta_2 \\in \\mathbb{R}$ 是控制沿 $\\mathbf{v}_1$ 和 $\\mathbf{v}_2$ 轴敏感度的二次权重。发放 $s_t$ 作为独立的伯努利随机变量进行抽样，成功概率为 $p_t$。\n\n将所有时间窗内的经验刺激协方差定义为\n$$\n\\mathbf{C} \\equiv \\frac{1}{T} \\sum_{t=1}^{T} \\left(\\mathbf{x}_t - \\overline{\\mathbf{x}}\\right)\\left(\\mathbf{x}_t - \\overline{\\mathbf{x}}\\right)^\\top,\n$$\n其中 $\\overline{\\mathbf{x}} = \\frac{1}{T} \\sum_{t=1}^{T} \\mathbf{x}_t$ 是经验均值。将发放触发协方差定义为\n$$\n\\mathbf{C}_{\\text{spike}} \\equiv \\frac{1}{N_s} \\sum_{t: s_t = 1} \\left(\\mathbf{x}_t - \\overline{\\mathbf{x}}_{\\text{spike}}\\right)\\left(\\mathbf{x}_t - \\overline{\\mathbf{x}}_{\\text{spike}}\\right)^\\top,\n$$\n其中 $N_s = \\sum_{t=1}^T s_t$ 是总发放数，$\\overline{\\mathbf{x}}_{\\text{spike}} = \\frac{1}{N_s} \\sum_{t: s_t = 1} \\mathbf{x}_t$ 是发放期间的平均刺激。发放触发协方差之差为\n$$\n\\Delta \\mathbf{C} \\equiv \\mathbf{C}_{\\text{spike}} - \\mathbf{C}.\n$$\n设 $\\lambda_1(\\Delta \\mathbf{C}), \\ldots, \\lambda_d(\\Delta \\mathbf{C})$ 表示 $\\Delta \\mathbf{C}$ 的特征值，按绝对值大小降序排列，即 $|\\lambda_1| \\geq |\\lambda_2| \\geq \\cdots \\geq |\\lambda_d|$。\n\n在发放时间独立于刺激的零假设下，$\\Delta \\mathbf{C}$ 的分布以零为中心，因此其特征值反映的是随机波动。为估计零分布，应用一种置换检验，该检验通过重排发放时间来打破关联，同时保持总发放数和总体上的时间排列。对于每次置换，计算置换后的 $\\Delta \\mathbf{C}$，提取其特征值，并记录前 $k$ 个特征值中的最大绝对特征值统计量。使用这个最大值类型统计量的经验零分布，在水平 $\\alpha_{\\mathrm{FWER}}$ 上控制待检验的 $k$ 个特征值的族错误率（FWER）。\n\n您的程序必须：\n\n- 使用指定的参数为每个测试用例模拟刺激和发放序列。\n- 计算观测到的发放序列的 $\\Delta \\mathbf{C}$ 及其特征值。\n- 通过随机置换发放序列 $\\{s_t\\}$（即随机重排发放指示符）来执行 $B$ 次置换，为每次置换重新计算 $\\Delta \\mathbf{C}$ 和前 $k$ 个特征值中的最大绝对特征值。\n- 构建最大值类型统计量的经验零分布，并使用该置换分布的 $(1-\\alpha_{\\mathrm{FWER}})$ 分位数确定控制FWER的阈值（水平为 $\\alpha_{\\mathrm{FWER}}$）。\n- 如果前 $k$ 个观测特征值中某个特征值的绝对值超过该阈值，则宣布其为显著。返回前 $k$ 个特征值中的显著特征值总数。\n\n实现细节与科学基础：\n\n- 数学基础包括零假设下的独立性和可交换性、协方差和特征分解的性质，以及置换检验的基本原理。\n- 族错误率（FWER）通过最大值类型检验来控制：将每个检验统计量与最大统计量零分布的 $(1-\\alpha_{\\mathrm{FWER}})$ 分位数进行比较，确保对 $k$ 个假设中的任何一个都有强控制。\n\n测试套件：\n\n提供以下四个测试用例，每个用例由元组 $(r, d, T, c_0, \\theta_1, \\theta_2, B, k, \\alpha_{\\mathrm{FWER}})$ 指定，其中 $r$ 是用于确保可复现性的随机种子。\n\n1. 具有两个信息性二次轴的基线理想情况：\n   - $(2025, 12, 40000, -5.5, 1.5, 1.0, 100, 4, 0.05)$\n\n2. 零依赖情况（无刺激敏感度）：\n   - $(77, 12, 40000, -4.0, 0.0, 0.0, 100, 4, 0.05)$\n\n3. 低发放数边缘情况（稀疏发放）：\n   - $(310, 8, 30000, -7.0, 1.5, 1.0, 100, 4, 0.05)$\n\n4. 更高维度中等灵敏度：\n   - $(88, 20, 50000, -5.0, 0.8, 0.6, 100, 6, 0.05)$\n\n最终输出规范：\n\n- 对于每个测试用例，您的程序必须输出一个整数，该整数等于在使用最大值类型置换阈值进行FWER控制后，前 $k$ 个特征值中的显著特征值数量。\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，\"[2,0,0,1]\"）。\n\n本问题不涉及物理单位。不出现角度。输出中的任何分数或概率必须通过整数计数间接呈现；不允许使用百分号。",
            "solution": "该问题提出了计算神经科学领域一个有效且适定的挑战，要求实现发放触发协方差（STC）分析，并结合基于置换的假设检验来控制族错误率（FWER）。该问题具有科学依据，采用了标准模型（带二次项的广义线性模型）和统计技术（置换检验、用于FWER控制的最大值类型检验）。所有参数和程序都定义清晰，从而能够得出一个唯一且可验证的解。\n\n核心任务是识别显著影响神经元发放活动的刺激维度。神经元的响应被建模为刺激沿两个特定（尽管是隐藏的）维度的方差的函数。STC分析旨在通过分析以发放为条件的刺激协方差与总体刺激协方差之间的差异来恢复这些维度。\n\n### 数学和程序框架\n\n**1. 生成模型**\n\n生成一个合成数据集以模拟真实的神经科学实验。在每个时间点 $t \\in \\{1, \\dots, T\\}$ 的刺激 $\\mathbf{x}_t \\in \\mathbb{R}^d$ 是从一个 $d$ 维各向同性高斯分布 $\\mathbf{x}_t \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{I})$ 中独立抽取的。神经元的发放概率 $p_t$ 通过一个逻辑斯谛模型受刺激在两个标准正交向量 $\\mathbf{v}_1$ 和 $\\mathbf{v}_2$ 上的投影所调制：\n\n$$\np_t = \\sigma\\!(c_0 + \\theta_1 (\\mathbf{v}_1^\\top \\mathbf{x}_t)^2 + \\theta_2 (\\mathbf{v}_2^\\top \\mathbf{x}_t)^2)\n$$\n\n其中 $\\sigma(z) = (1 + e^{-z})^{-1}$ 是逻辑斯谛函数，$c_0$ 是一个基线发放参数，$\\theta_1, \\theta_2$ 分别控制对沿 $\\mathbf{v}_1$ 和 $\\mathbf{v}_2$ 的刺激方差的敏感度。一次发放 $s_t=1$ 以概率 $p_t$ 作为伯努利试验生成。由于刺激分布是各向同性的，标准正交对 $(\\mathbf{v}_1, \\mathbf{v}_2)$ 的具体选择不会改变问题的统计特性。不失一般性，我们可以将它们与前两个标准基向量 $\\mathbf{e}_1$ 和 $\\mathbf{e}_2$ 对齐。\n\n**2. 发放触发协方差（STC）分析**\n\nSTC旨在寻找那些引发发放的刺激的方差与背景刺激方差有差异的刺激维度。我们计算两个协方差矩阵：\n\n- 总体刺激协方差，$\\mathbf{C}$：\n$$\n\\mathbf{C} = \\frac{1}{T} \\sum_{t=1}^{T} (\\mathbf{x}_t - \\overline{\\mathbf{x}})(\\mathbf{x}_t - \\overline{\\mathbf{x}})^\\top\n$$\n- 发放触发协方差，$\\mathbf{C}_{\\text{spike}}$：\n$$\n\\mathbf{C}_{\\text{spike}} = \\frac{1}{N_s} \\sum_{t: s_t = 1} (\\mathbf{x}_t - \\overline{\\mathbf{x}}_{\\text{spike}})(\\mathbf{x}_t - \\overline{\\mathbf{x}}_{\\text{spike}})^\\top\n$$\n其中 $N_s$ 是总发放数，$\\overline{\\mathbf{x}}$ 是平均刺激，$\\overline{\\mathbf{x}}_{\\text{spike}}$ 是平均发放触发刺激。\n\n差值 $\\Delta \\mathbf{C} = \\mathbf{C}_{\\text{spike}} - \\mathbf{C}$ 分离了协方差的变化。$\\Delta \\mathbf{C}$ 的特征向量中，对应于大绝对值特征值的那些，标识了我们感兴趣的刺激维度。在我们的模型中，正的 $\\theta_1$ 和 $\\theta_2$ 意味着在 $\\mathbf{v}_1$ 和 $\\mathbf{v}_2$ 上有较大投影的刺激更有可能引起发放。这增加了发放触发刺激集合在这些方向上的方差，导致 $\\Delta \\mathbf{C}$ 的特征向量与 $\\mathbf{v}_1, \\mathbf{v}_2$ 对齐，并具有正的特征值。\n\n**3. 用于统计显著性检验的置换检验**\n\n为评估观测到的 $\\Delta \\mathbf{C}$ 特征值是否具有统计显著性，或者仅仅是由于随机抽样所致，我们采用置换检验。\n\n- **零假设 ($H_0$)**：发放时间独立于刺激。在 $H_0$ 下，$\\Delta \\mathbf C$ 的期望是零矩阵，任何观测到的非零特征值都是噪声。\n- **置换原理**：通过随机置换发放序列 $\\{s_t\\}$，我们打破了刺激 $\\mathbf{x}_t$ 和发放 $s_t$ 之间的时间关联，从而有效地创建了符合零假设的代理数据。此过程保留了总发放数和刺激的边际统计量，为估计我们检验统计量的零分布提供了一种强大的非参数方法。\n\n**4. 族错误率（FWER）控制**\n\n我们同时检验 $k$ 个假设，每个假设对应前 $k$ 个（按绝对值大小排序的）特征值之一。为避免假阳性率膨胀，我们必须控制FWER——即犯至少一个第一类错误的概率。我们使用一个单步最大值类型程序：\n\n- **检验统计量**：观测到的检验统计量是观测到的 $\\Delta \\mathbf{C}$ 的前 $k$ 个特征值的绝对值，记为 $\\{|\\lambda_i|\\}_{i=1}^k$。\n- **最大值的零分布**：对于 $B$ 次置换中的每一次，我们计算一个置换后的协方差差值 $\\Delta \\mathbf{C}^*$ 及其特征值。然后我们记录最大绝对特征值 $m^* = \\max_{j=1,\\ldots,d} |\\lambda_j^*|$。这等价于从按绝对值大小排序的置换特征值中找到 $|\\lambda_1^*|$。这 $B$ 个值的集合 $\\{m^*_1, \\dots, m^*_B\\}$，构成了一个针对最极端可能特征值的经验零分布。\n- **阈值设定**：我们将单个显著性阈值 $c_{\\text{crit}}$ 设为此最大值经验分布的 $(1-\\alpha_{\\mathrm{FWER}})$ 分位数。\n- **决策规则**：如果一个观测到的特征值 $\\lambda_i$ 的绝对值 $|\\lambda_i|$ 超过这个共同的、严格的阈值 $c_{\\text{crit}}$，我们就宣布其为显著。这个程序在水平 $\\alpha_{\\mathrm{FWER}}$ 上提供了对FWER的强控制。\n\n### 算法实现步骤\n\n1.  **初始化**：对于每个测试用例，设置随机种子 $r$ 和参数 $(d, T, c_0, \\theta_1, \\theta_2, B, k, \\alpha_{\\mathrm{FWER}})$。\n2.  **生成数据**：\n    -   从 $\\mathcal{N}(\\mathbf{0}, \\mathbf{I})$ 生成 $T \\times d$ 的刺激矩阵 $\\mathbf{X}$。\n    -   选择 $\\mathbf{v}_1 = \\mathbf{e}_1$ 和 $\\mathbf{v}_2 = \\mathbf{e}_2$。\n    -   根据生成模型计算发放概率 $p_t$。\n    -   生成长度为 $T$ 的二元发放序列 $s_t$。\n3.  **计算观测统计量**：\n    -   计算观测到的 $\\Delta \\mathbf{C} = \\mathbf{C}_{\\text{spike}} - \\mathbf{C}$。\n    -   计算 $\\Delta \\mathbf{C}$ 的特征值，并按绝对值大小降序排列。\n    -   提取前 $k$ 个绝对特征值 $\\{|\\lambda_i|\\}_{i=1}^k$。\n4.  **生成零分布**：\n    -   初始化一个空列表用于存放零分布统计量。\n    -   循环 $B$ 次：\n        -   通过重排 $s_t$ 创建一个置换后的发放序列 $s_t^*$。\n        -   计算置换后的协方差差值 $\\Delta \\mathbf{C}^*$。\n        -   找到 $\\Delta \\mathbf{C}^*$ 的最大绝对特征值，并将其追加到列表中。\n5.  **确定显著性**：\n    -   将阈值 $c_{\\text{crit}}$ 计算为所生成零分布的 $(1-\\alpha_{\\mathrm{FWER}})$ 百分位数。\n    -   计算 $k$ 个观测到的绝对特征值 $|\\lambda_i|$ 中有多少个大于 $c_{\\text{crit}}$。\n    -   返回这个计数。\n对问题陈述中提供的每个测试用例重复此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import expit\n\ndef run_stc_permutation_test(r, d, T, c0, theta1, theta2, B, k, alpha_fwer):\n    \"\"\"\n    Simulates a neuron's spike train, performs spike-triggered covariance (STC)\n    analysis, and uses a permutation test to find significant eigenvalues\n    while controlling the Family-Wise Error Rate (FWER).\n\n    Args:\n        r (int): Random seed for reproducibility.\n        d (int): Dimensionality of the stimulus space.\n        T (int): Number of time bins.\n        c0 (float): Baseline logit for spiking.\n        theta1 (float): Weight for the first quadratic feature.\n        theta2 (float): Weight for the second quadratic feature.\n        B (int): Number of permutations for the null distribution.\n        k (int): Number of top eigenvalues to test for significance.\n        alpha_fwer (float): Target Family-Wise Error Rate.\n\n    Returns:\n        int: The number of significant eigenvalues among the top k.\n    \"\"\"\n    rng = np.random.default_rng(r)\n\n    # Step 1: Simulate stimuli and spike train\n    # Due to the isotropic stimulus distribution N(0, I), we can choose v1 and v2\n    # to be the first two standard basis vectors without loss of generality.\n    v1 = np.zeros(d)\n    v1[0] = 1.0\n    v2 = np.zeros(d)\n    v2[1] = 1.0\n\n    X = rng.standard_normal(size=(T, d))\n    \n    proj1_sq = (X @ v1)**2\n    proj2_sq = (X @ v2)**2\n\n    logits = c0 + theta1 * proj1_sq + theta2 * proj2_sq\n    p_spike = expit(logits)  # Numerically stable logistic function\n    s = rng.binomial(1, p_spike)\n\n    spike_indices = np.where(s == 1)[0]\n    Ns = len(spike_indices)\n\n    # If Ns  2, covariance is undefined. No significant dimensions can be found.\n    # This is extremely unlikely with the given test cases.\n    if Ns  2:\n        return 0\n\n    # Step 2: Compute observed Delta_C and its eigenvalues\n    X_spike = X[spike_indices]\n    \n    # Use np.cov with ddof=0 to divide by N, as per the problem's formulas.\n    # rowvar=False because our variables are columns of X.\n    C = np.cov(X, rowvar=False, ddof=0)\n    C_spike = np.cov(X_spike, rowvar=False, ddof=0)\n    delta_C = C_spike - C\n\n    # eigh is for symmetric matrices and returns eigenvalues in ascending order.\n    eigvals_obs = np.linalg.eigh(delta_C)[0]\n    \n    # Sort eigenvalues by decreasing absolute magnitude\n    sorted_indices_obs = np.argsort(np.abs(eigvals_obs))[::-1]\n    sorted_eigvals_obs = eigvals_obs[sorted_indices_obs]\n    \n    # These are the k test statistics we will evaluate\n    abs_eigvals_obs_k = np.abs(sorted_eigvals_obs[:k])\n\n    # Step 3: Build null distribution via permutations\n    max_perm_eigvals = np.zeros(B)\n    \n    for i in range(B):\n        # Permute the spike train to break stimulus-spike relationship\n        s_perm = rng.permutation(s)\n        spike_indices_perm = np.where(s_perm == 1)[0]\n        \n        X_spike_perm = X[spike_indices_perm]\n        \n        C_spike_perm = np.cov(X_spike_perm, rowvar=False, ddof=0)\n        delta_C_perm = C_spike_perm - C\n\n        eigvals_perm = np.linalg.eigh(delta_C_perm)[0]\n        \n        # For the max-T FWER control, we need the maximum of the test statistics\n        # under permutation. This is the largest absolute eigenvalue.\n        max_perm_eigvals[i] = np.max(np.abs(eigvals_perm))\n        \n    # Step 4: Determine threshold and count significant eigenvalues\n    # The threshold is the (1 - alpha) quantile of the null distribution of the max statistic.\n    threshold = np.quantile(max_perm_eigvals, 1 - alpha_fwer)\n    \n    # An observed eigenvalue is significant if its absolute value exceeds the FWER-controlling threshold.\n    significant_count = np.sum(abs_eigvals_obs_k > threshold)\n    \n    return int(significant_count)\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        # (r, d, T, c0, theta1, theta2, B, k, alpha_fwer)\n        (2025, 12, 40000, -5.5, 1.5, 1.0, 100, 4, 0.05),\n        (77, 12, 40000, -4.0, 0.0, 0.0, 100, 4, 0.05),\n        (310, 8, 30000, -7.0, 1.5, 1.0, 100, 4, 0.05),\n        (88, 20, 50000, -5.0, 0.8, 0.6, 100, 6, 0.05)\n    ]\n\n    results = []\n    for case in test_cases:\n        count = run_stc_permutation_test(*case)\n        results.append(count)\n\n    # Print the final output in the specified format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在识别出一个显著的子空间后，一个常见的任务是评估它与理论模型或其他实验结果的匹配程度。这需要一种形式化的方法来衡量两个子空间之间的“距离”。本练习  介绍了主角度（principal angles）的概念，它通过基底交叉矩阵的奇异值分解（SVD）得出，为量化估计的神经特征空间与真实特征空间之间的一致性提供了强大而几何直观的度量。",
            "id": "4021267",
            "problem": "考虑一个由高维高斯白化刺激驱动的神经元，其相关特征空间是低维的，这在脉冲触发协方差 (STC) 分析中是常见的模型。白化后，真实的（ground-truth）相关子空间由一个标准正交基矩阵 $U \\in \\mathbb{R}^{4 \\times 2}$ 张成，而STC估计得出的标准正交基矩阵为 $\\hat U \\in \\mathbb{R}^{4 \\times 2}$。假设\n$$\nU = \\begin{pmatrix}\n1  0 \\\\\n0  1 \\\\\n0  0 \\\\\n0  0\n\\end{pmatrix}, \\quad\n\\hat U = \\begin{pmatrix}\n\\frac{1}{\\sqrt{2}}  0 \\\\\n0  \\frac{1}{\\sqrt{3}} \\\\\n\\frac{1}{\\sqrt{2}}  0 \\\\\n0  \\sqrt{\\frac{2}{3}}\n\\end{pmatrix}.\n$$\n从子空间之间主角的定义出发——即在相互正交的约束下，通过递归地最大化每个子空间中单位向量之间角度的余弦而获得的序列 $\\{\\theta_i\\}$——并利用标准正交基的成熟性质以及基交叉矩阵 $U^{\\top}\\hat U$ 的奇异值分解（SVD），推导出从 $U$ 和 $\\hat U$ 计算主角 $\\{\\theta_i\\}$ 所需的关系。然后，将一个定量的子空间差异 $d$ 定义为这些主角的正弦平方和的平方根，并计算其对于上述矩阵的值。\n\n将 $d$ 的最终答案表示为一个实数，并四舍五入到四位有效数字。不需要单位。",
            "solution": "所述问题具有科学依据，定义明确且客观，可以进行形式化求解。它要求推导一种从两个子空间的标准正交基计算它们之间主角的方法，然后计算一个特定的差异度量。\n\n设这两个子空间分别表示为 $S_U = \\text{span}(U)$ 和 $S_{\\hat{U}} = \\text{span}(\\hat{U})$，其中 $U \\in \\mathbb{R}^{n \\times k}$ 和 $\\hat{U} \\in \\mathbb{R}^{n \\times k}$ 是具有标准正交列的矩阵，这些列分别为它们各自的 $k$ 维子空间构成基。这里，$n=4$ 且 $k=2$。\n\n这两个子空间之间的主角 $\\{\\theta_i\\}_{i=1}^k$ 是递归定义的。第一个主角 $\\theta_1$ 是从每个子空间中各取一个单位向量所形成的任意向量对之间的最小夹角。其余弦由以下最大化问题给出：\n$$ \\cos(\\theta_1) = \\max_{\\substack{\\mathbf{u} \\in S_U, \\, ||\\mathbf{u}||=1 \\\\ \\mathbf{\\hat{u}} \\in S_{\\hat{U}}, \\, ||\\mathbf{\\hat{u}}||=1}} \\mathbf{u}^\\top \\mathbf{\\hat{u}} $$\n任何向量 $\\mathbf{u} \\in S_U$ 都可以写成 $U$ 中基向量的线性组合，即 $\\mathbf{u} = U\\mathbf{x}$，其中 $\\mathbf{x} \\in \\mathbb{R}^k$ 是某个系数向量。由于 $U$ 的列是标准正交的，因此 $||\\mathbf{u}||^2 = (U\\mathbf{x})^\\top(U\\mathbf{x}) = \\mathbf{x}^\\top U^\\top U \\mathbf{x} = \\mathbf{x}^\\top I_k \\mathbf{x} = ||\\mathbf{x}||^2$。因此，条件 $||\\mathbf{u}||=1$ 意味着 $||\\mathbf{x}||=1$。类似地，对于 $\\mathbf{\\hat{u}} \\in S_{\\hat{U}}$，我们可以写成 $\\mathbf{\\hat{u}} = \\hat{U}\\mathbf{y}$，且 $||\\mathbf{y}||=1$。\n\n将这些代入最大化问题，我们得到：\n$$ \\cos(\\theta_1) = \\max_{||\\mathbf{x}||=1, ||\\mathbf{y}||=1} (U\\mathbf{x})^\\top (\\hat{U}\\mathbf{y}) = \\max_{||\\mathbf{x}||=1, ||\\mathbf{y}||=1} \\mathbf{x}^\\top (U^\\top \\hat{U}) \\mathbf{y} $$\n令 $M = U^\\top \\hat{U}$。表达式 $\\mathbf{x}^\\top M \\mathbf{y}$ 是一个双线性形式。对于单位向量 $\\mathbf{x}$ 和 $\\mathbf{y}$，此形式的最大值根据定义是矩阵 $M$ 的最大奇异值，记为 $\\sigma_1(M)$。\n\n后续的主角是通过在先前找到的主向量的正交补上重复此过程来找到的。一个作为线性代数基本结果的普适关系指出，主角 $\\{\\theta_i\\}$ 的余弦是基交叉矩阵 $M = U^\\top \\hat{U}$ 的奇异值。\n$$ \\cos(\\theta_i) = \\sigma_i(U^\\top \\hat{U}) \\quad \\text{for } i=1, \\dots, k $$\n其中奇异值按 $\\sigma_1 \\ge \\sigma_2 \\ge \\dots \\ge \\sigma_k \\ge 0$ 的顺序排列。\n\n问题将子空间差异度量 $d$ 定义为这些主角的正弦平方和的平方根：\n$$ d = \\sqrt{\\sum_{i=1}^k \\sin^2(\\theta_i)} $$\n使用恒等式 $\\sin^2(\\theta_i) + \\cos^2(\\theta_i) = 1$ 和关系式 $\\cos(\\theta_i) = \\sigma_i$，我们可以用奇异值来表示 $d$：\n$$ d = \\sqrt{\\sum_{i=1}^k (1 - \\cos^2(\\theta_i))} = \\sqrt{\\sum_{i=1}^k (1 - \\sigma_i^2)} $$\n现在，我们为给定的矩阵计算这个值：\n$$ U = \\begin{pmatrix} 1  0 \\\\ 0  1 \\\\ 0  0 \\\\ 0  0 \\end{pmatrix}, \\quad \\hat{U} = \\begin{pmatrix} \\frac{1}{\\sqrt{2}}  0 \\\\ 0  \\frac{1}{\\sqrt{3}} \\\\ \\frac{1}{\\sqrt{2}}  0 \\\\ 0  \\sqrt{\\frac{2}{3}} \\end{pmatrix} $$\n首先，我们计算矩阵 $M = U^\\top \\hat{U}$。$U$ 的转置是：\n$$ U^\\top = \\begin{pmatrix} 1  0  0  0 \\\\ 0  1  0  0 \\end{pmatrix} $$\n乘积为：\n$$ M = U^\\top \\hat{U} = \\begin{pmatrix} 1  0  0  0 \\\\ 0  1  0  0 \\end{pmatrix} \\begin{pmatrix} \\frac{1}{\\sqrt{2}}  0 \\\\ 0  \\frac{1}{\\sqrt{3}} \\\\ \\frac{1}{\\sqrt{2}}  0 \\\\ 0  \\sqrt{\\frac{2}{3}} \\end{pmatrix} = \\begin{pmatrix} (1)(\\frac{1}{\\sqrt{2}}) + (0)(0)  (1)(0) + (0)(\\frac{1}{\\sqrt{3}}) \\\\ (0)(\\frac{1}{\\sqrt{2}}) + (1)(0)  (0)(0) + (1)(\\frac{1}{\\sqrt{3}}) \\end{pmatrix} $$\n$$ M = \\begin{pmatrix} \\frac{1}{\\sqrt{2}}  0 \\\\ 0  \\frac{1}{\\sqrt{3}} \\end{pmatrix} $$\n矩阵 $M$ 是一个对角矩阵。对角矩阵的奇异值是其对角元素的绝对值。因此，奇异值为：\n$$ \\sigma_1 = \\frac{1}{\\sqrt{2}}, \\quad \\sigma_2 = \\frac{1}{\\sqrt{3}} $$\n注意 $\\frac{1}{\\sqrt{2}}  \\frac{1}{\\sqrt{3}}$，所以这个排序是正确的。\n\n现在我们可以计算差异 $d^2$：\n$$ d^2 = \\sum_{i=1}^{2} (1 - \\sigma_i^2) = (1 - \\sigma_1^2) + (1 - \\sigma_2^2) $$\n$$ d^2 = \\left(1 - \\left(\\frac{1}{\\sqrt{2}}\\right)^2\\right) + \\left(1 - \\left(\\frac{1}{\\sqrt{3}}\\right)^2\\right) $$\n$$ d^2 = \\left(1 - \\frac{1}{2}\\right) + \\left(1 - \\frac{1}{3}\\right) = \\frac{1}{2} + \\frac{2}{3} $$\n$$ d^2 = \\frac{3}{6} + \\frac{4}{6} = \\frac{7}{6} $$\n差异 $d$ 是这个值的平方根：\n$$ d = \\sqrt{\\frac{7}{6}} $$\n为了给出数值答案，我们计算其值并四舍五入到四位有效数字：\n$$ d = \\sqrt{\\frac{7}{6}} \\approx \\sqrt{1.166666...} \\approx 1.080123... $$\n四舍五入到四位有效数字得到 $1.080$。",
            "answer": "$$\\boxed{1.080}$$"
        },
        {
            "introduction": "真实的神经元数据非常复杂，神经元的放电通常会受到其自身近期活动（如不应期）的影响。这些历史活动效应可能与外部刺激相关，从而混淆 STC 分析，导致识别出虚假的刺激特征。本练习  探讨了这个高级但至关重要的问题，展示了如何通过数学方法“回归掉”历史效应的干扰，并评估可能残留的混淆程度，从而确保对刺激选择性的更准确描述。",
            "id": "4021328",
            "problem": "考虑一个实验，其中一个神经元由高维刺激驱动，并表现出脉冲历史效应。在时间索引 $t$ 处的刺激是一个3维向量 $s_t \\in \\mathbb{R}^3$，脉冲历史特征向量 $h_t \\in \\mathbb{R}^2$ 收集了两个编码近期脉冲发放的预测变量 $h_{1,t}$ 和 $h_{2,t}$。假设 $(s_t, h_t)$ 是联合零均值的二阶平稳过程，其协方差有明确定义。\n\n令 $C_{ss} \\in \\mathbb{R}^{3 \\times 3}$、$C_{hh} \\in \\mathbb{R}^{2 \\times 2}$ 和 $C_{sh} \\in \\mathbb{R}^{3 \\times 2}$ 分别表示无条件刺激协方差、历史协方差和刺激-历史互协方差。刺激的脉冲触发协方差 (Spike-Triggered Covariance, STC) 定义为 $C_{ss|\\text{spike}} - C_{ss}$，即脉冲前刺激的协方差与无条件刺激协方差之差。\n\n为减轻脉冲历史带来的混淆，可以在计算 STC 之前，通过将刺激投影到历史预测变量的正交补上，来回归掉 $s_t$ 中可由历史线性预测的分量。在二阶平稳性下的总体（无限样本）极限中，移除历史线性可预测性的正交投影等价于通过从 $s_t$ 中减去其基于 $h_t$ 的最佳线性预测来对 $s_t$ 进行残差化。将残差化后的刺激记为 $s_t^{\\perp} = s_t - B h_t$，其中选择 $B \\in \\mathbb{R}^{3 \\times 2}$ 以最小化期望平方预测误差。\n\n假设真实的协方差为\n$$\nC_{ss} = \\begin{pmatrix}\n2.0  0.5  0.3 \\\\\n0.5  1.5  0.2 \\\\\n0.3  0.2  1.0\n\\end{pmatrix}, \\quad\nC_{hh} = \\begin{pmatrix}\n1.0  0.3 \\\\\n0.3  0.8\n\\end{pmatrix}, \\quad\nC_{sh} = \\begin{pmatrix}\n0.4  0.2 \\\\\n0.1  0.3 \\\\\n0.2  0.1\n\\end{pmatrix}.\n$$\n\n现在考虑一个错误设定的回归，其中在进行残差化时只包含了第一个历史预测变量 $h_{1,t}$。令 $u_t = h_{1,t}$ 和 $v_t = h_{2,t}$。在这种情况下，残差化变换只使用 $u_t$，得到 $s_t^{\\perp u} = s_t - B_u u_t$，其中 $B_u \\in \\mathbb{R}^{3 \\times 1}$ 是仅使用 $u_t$ 来最小化期望平方误差的系数。相对于被忽略的预测变量 $v_t$ 的残余混淆，可以通过残余刺激-历史互协方差与 $v_t$ 的范数与原始互协方差与 $v_t$ 的范数之比来量化：\n$$\n\\gamma \\equiv \\frac{\\|C_{s^{\\perp u} v}\\|_{2}}{\\|C_{s v}\\|_{2}},\n$$\n其中 $C_{s v} \\in \\mathbb{R}^{3 \\times 1}$ 是 $C_{sh}$ 的第二列，而 $C_{s^{\\perp u} v}$ 是 $s_t^{\\perp u}$ 和 $v_t$ 之间的互协方差。\n\n从协方差、正交投影和最小二乘回归的核心定义出发，推导总体最优的残差化变换 $s_t^{\\perp} = s_t - B h_t$ 作为到历史预测变量正交补上的投影，解释这与在残差化刺激上计算 STC 的关系，然后，对于使用 $u_t$ 的错误设定的单预测变量残差化，利用给定的协方差计算标量残余混淆指数 $\\gamma$。\n\n将最终的标量表示为无量纲数，并将答案四舍五入到四位有效数字。",
            "solution": "我们从基本定义开始。刺激 $s_t \\in \\mathbb{R}^3$ 和历史 $h_t \\in \\mathbb{R}^2$ 是联合零均值的，其无条件二阶矩由 $C_{ss}$、$C_{hh}$ 和 $C_{sh}$ 表示。脉冲触发协方差 (STC) 定义为差值 $C_{ss|\\text{spike}} - C_{ss}$，它捕获了与脉冲发放相关的二阶刺激特征。当 $s_t$ 和 $h_t$ 相关时，就会出现脉冲历史混淆，导致 STC 反映的是可归因于历史而非刺激选择性的方差结构。\n\n为了回归掉历史的影响，我们使用正交投影原理：对于给定的预测变量矩阵（此处为历史特征），最小二乘残差与预测变量子空间正交。在总体极限下，这种等价性可以通过使用二阶矩来陈述，而无需引用有限样本设计矩阵。\n\n考虑从 $h_t$ 预测 $s_t$ 的形式为 $B h_t$ 的线性预测器，其中 $B \\in \\mathbb{R}^{3 \\times 2}$。均方意义上的最佳线性预测器最小化期望平方误差\n$$\n\\mathbb{E}\\big[ \\| s_t - B h_t \\|_2^2 \\big].\n$$\n对 $B$ 求导并将梯度设为零，得到正规方程\n$$\n\\frac{\\partial}{\\partial B} \\mathbb{E}\\big[ \\| s_t - B h_t \\|_2^2 \\big] = -2 \\, \\mathbb{E}\\big[ s_t h_t^{\\top} \\big] + 2 \\, B \\, \\mathbb{E}\\big[ h_t h_t^{\\top} \\big] = -2 C_{sh} + 2 B C_{hh} = 0,\n$$\n这意味着\n$$\nB C_{hh} = C_{sh} \\quad \\Longrightarrow \\quad B = C_{sh} C_{hh}^{-1}.\n$$\n因此，在最小二乘意义上与历史预测变量子空间正交的残差化刺激是\n$$\ns_t^{\\perp} = s_t - C_{sh} C_{hh}^{-1} h_t.\n$$\n根据构造，该残差满足\n$$\n\\mathbb{E}\\big[ s_t^{\\perp} h_t^{\\top} \\big] = \\mathbb{E}\\big[ s_t h_t^{\\top} \\big] - C_{sh} C_{hh}^{-1} \\mathbb{E}\\big[ h_t h_t^{\\top} \\big] = C_{sh} - C_{sh} C_{hh}^{-1} C_{hh} = 0,\n$$\n因此 $s_t^{\\perp}$ 在二阶意义上与 $h_t$ 正交。因此，在 $s_t^{\\perp}$ 上计算 STC 会移除 $s_t$ 中可由 $h_t$ 线性预测的方差分量，这与那些旨在隔离出不受历史污染的、包含刺激信息的维度的子空间方法是一致的。\n\n我们现在分析一个错误设定的残差化，它只使用第一个历史分量 $u_t = h_{1,t}$。单预测变量的最小二乘解是\n$$\nB_u = \\arg\\min_{b \\in \\mathbb{R}^{3 \\times 1}} \\mathbb{E}\\big[ \\| s_t - b \\, u_t \\|_2^2 \\big].\n$$\n正规方程简化为\n$$\nb \\, \\mathbb{E}\\big[ u_t^2 \\big] = \\mathbb{E}\\big[ s_t u_t \\big] \\quad \\Longrightarrow \\quad B_u = C_{s u} C_{u u}^{-1},\n$$\n其中 $C_{s u} \\in \\mathbb{R}^{3 \\times 1}$ 是 $C_{sh}$ 的第一列，$C_{u u} \\in \\mathbb{R}$ 是 $C_{hh}$ 的 $(1,1)$ 元素。残差化刺激为\n$$\ns_t^{\\perp u} = s_t - C_{s u} C_{u u}^{-1} u_t.\n$$\n$s_t^{\\perp u}$ 与被忽略的预测变量 $v_t = h_{2,t}$ 之间的互协方差则为\n$$\nC_{s^{\\perp u} v} = \\mathbb{E}\\big[ s_t^{\\perp u} v_t \\big] = \\mathbb{E}\\big[ s_t v_t \\big] - C_{s u} C_{u u}^{-1} \\mathbb{E}\\big[ u_t v_t \\big] = C_{s v} - C_{s u} C_{u u}^{-1} C_{u v},\n$$\n其中 $C_{s v} \\in \\mathbb{R}^{3 \\times 1}$ 是 $C_{sh}$ 的第二列，$C_{u v}$ 是 $C_{hh}$ 的 $(1,2)$ 元素。该表达式量化了由于忽略历史预测变量而产生的残余混淆。\n\n我们定义残余混淆指数\n$$\n\\gamma \\equiv \\frac{\\|C_{s^{\\perp u} v}\\|_{2}}{\\|C_{s v}\\|_{2}},\n$$\n当残差化降低了与 $v_t$ 的相关性时，该指数是无量纲的且位于 $[0,1]$ 区间内。\n\n使用给定的协方差，\n$$\nC_{s u} = \\begin{pmatrix} 0.4 \\\\ 0.1 \\\\ 0.2 \\end{pmatrix}, \\quad\nC_{s v} = \\begin{pmatrix} 0.2 \\\\ 0.3 \\\\ 0.1 \\end{pmatrix}, \\quad\nC_{u u} = 1.0, \\quad\nC_{u v} = 0.3.\n$$\n因此\n$$\nC_{s^{\\perp u} v} = C_{s v} - C_{s u} C_{u u}^{-1} C_{u v} = \\begin{pmatrix} 0.2 \\\\ 0.3 \\\\ 0.1 \\end{pmatrix} - 0.3 \\begin{pmatrix} 0.4 \\\\ 0.1 \\\\ 0.2 \\end{pmatrix} = \\begin{pmatrix} 0.08 \\\\ 0.27 \\\\ 0.04 \\end{pmatrix}.\n$$\n计算范数的平方：\n$$\n\\|C_{s v}\\|_2^2 = 0.2^2 + 0.3^2 + 0.1^2 = 0.14, \\quad\n\\|C_{s^{\\perp u} v}\\|_2^2 = 0.08^2 + 0.27^2 + 0.04^2 = 0.0809.\n$$\n因此，\n$$\n\\gamma = \\frac{\\|C_{s^{\\perp u} v}\\|_{2}}{\\|C_{s v}\\|_{2}} = \\sqrt{\\frac{0.0809}{0.14}} = \\sqrt{\\frac{809}{1400}} \\approx 0.760169733\\ldots\n$$\n四舍五入到四位有效数字，残余混淆指数为 $0.7602$。",
            "answer": "$$\\boxed{0.7602}$$"
        }
    ]
}