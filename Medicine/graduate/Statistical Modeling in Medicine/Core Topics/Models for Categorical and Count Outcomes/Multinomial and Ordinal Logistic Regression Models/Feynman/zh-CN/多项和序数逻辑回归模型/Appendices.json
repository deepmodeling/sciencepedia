{
    "hands_on_practices": [
        {
            "introduction": "在拟合一个比例优势模型后，一个关键任务是将其应用于新的个体进行预测。本练习将指导您完成基于患者特定协变量计算每个结局类别的预测概率的完整过程。这会强化您对线性预测变量、通过对数单位（logit）链接导出的累积概率以及最终的类别特异性概率之间联系的理解。掌握这一计算对于解释模型输出和将统计结果转化为具体的临床相关预测至关重要。",
            "id": "4976153",
            "problem": "一家医院对急性感染采用了一个四级有序严重性量表，编码为 $Y \\in \\{1,2,3,4\\}$，其中 $1=$ 无，$2=$ 轻度，$3=$ 中度，$4=$ 重度。一个比例优势（累积 logit）模型已应用于一项队列研究，使用了入院时测量的协变量：年龄（岁）、性别（男性指示变量）、血清 C 反应蛋白（mg/L）和 Charlson 合并症指数。拟合的模型使用了切点（也称为阈值）$\\alpha_1$、$\\alpha_2$、$\\alpha_3$ 和一个共同的斜率向量 $\\boldsymbol{\\beta}$，报告如下，并指明了协变量的缩放以方便解释：\n\n- 切点：$\\alpha_1 = -1.5$，$\\alpha_2 = 0.0$，$\\alpha_3 = 1.5$。\n- 斜率：年龄每 10 岁：$\\beta_{\\text{age}} = 0.25$；男性指示变量：$\\beta_{\\text{male}} = 0.40$；C 反应蛋白每 50 mg/L：$\\beta_{\\text{CRP}} = 0.60$；Charlson 合并症指数每点：$\\beta_{\\text{CCI}} = 0.15$。\n\n考虑一名具有以下协变量的患者：年龄 45 岁，女性（男性指示变量为 $0$），C 反应蛋白 20 mg/L，Charlson 合并症指数 $0$。\n\n使用 logit 变换和 logistic 函数的定义，计算该患者在比例优势模型下的预测类别概率 $P(Y=1 \\mid \\mathbf{x})$、$P(Y=2 \\mid \\mathbf{x})$、$P(Y=3 \\mid \\mathbf{x})$ 和 $P(Y=4 \\mid \\mathbf{x})$，并从临床合理性的角度解释其在不同严重性等级上的分布。然后，计算该患者的预期严重性指数 $\\mathbb{E}[Y \\mid \\mathbf{x}]$。\n\n仅提供预期严重性指数作为最终答案，并四舍五入至四位有效数字。无需单位。",
            "solution": "该问题是在医学背景下应用标准统计模型的明确定义问题。所有必要信息均已提供，参数一致，要求是基于给定模型进行一系列计算和解释。因此，该问题具有科学依据、问题设定良好、客观且完整。\n\n对于具有 $K$ 个类别（此处 $K=4$）的有序结果 $Y$，比例优势（累积 logit）模型对累积概率 $P(Y \\le j \\mid \\mathbf{x})$（其中 $j=1, \\dots, K-1$）进行建模。该模型定义为：\n$$\n\\text{logit}(P(Y \\le j \\mid \\mathbf{x})) = \\ln\\left(\\frac{P(Y \\le j \\mid \\mathbf{x})}{1 - P(Y \\le j \\mid \\mathbf{x})}\\right) = \\alpha_j - \\boldsymbol{\\beta}^T\\mathbf{x}\n$$\n此处，$\\alpha_j$ 是每个累积概率的切点（截距），$\\boldsymbol{\\beta}$ 是回归系数向量，$\\mathbf{x}$ 是协变量向量。风险因素（年龄、CRP、CCI）的正系数意味着这些协变量的增加会导致累积 logit 的减小，这意味着 $P(Y \\le j \\mid \\mathbf{x})$ 的减小，从而将概率质量推向更高的 $Y$ 值（更严重的级别）。这种表述是标准且恰当的。\n\n首先，我们为指定患者计算线性预测器 $\\eta = \\boldsymbol{\\beta}^T\\mathbf{x}$。协变量必须根据模型的规范进行缩放。该患者为 $45$ 岁女性，C 反应蛋白（CRP）为 $20$ mg/L，Charlson 合并症指数（CCI）为 $0$。\n协变量向量 $\\mathbf{x}$ 的构建如下：\n- 年龄：$x_{\\text{age}} = \\frac{45}{10} = 4.5$\n- 性别（男性指示变量）：$x_{\\text{male}} = 0$\n- C 反应蛋白：$x_{\\text{CRP}} = \\frac{20}{50} = 0.4$\n- Charlson 合并症指数：$x_{\\text{CCI}} = 0$\n\n线性预测器为：\n$$\n\\eta = \\boldsymbol{\\beta}^T\\mathbf{x} = \\beta_{\\text{age}}x_{\\text{age}} + \\beta_{\\text{male}}x_{\\text{male}} + \\beta_{\\text{CRP}}x_{\\text{CRP}} + \\beta_{\\text{CCI}}x_{\\text{CCI}}\n$$\n$$\n\\eta = (0.25)(4.5) + (0.40)(0) + (0.60)(0.4) + (0.15)(0)\n$$\n$$\n\\eta = 1.125 + 0 + 0.24 + 0 = 1.365\n$$\n\n接下来，我们通过应用逆 logit（logistic）函数 $f(z) = \\frac{1}{1 + \\exp(-z)}$ 来计算累积概率 $P(Y \\le j \\mid \\mathbf{x})$。\n对于 $j=1$：\n$$\nP(Y \\le 1 \\mid \\mathbf{x}) = \\frac{1}{1 + \\exp(-(\\alpha_1 - \\eta))} = \\frac{1}{1 + \\exp(-(-1.5 - 1.365))} = \\frac{1}{1 + \\exp(2.865)}\n$$\n对于 $j=2$：\n$$\nP(Y \\le 2 \\mid \\mathbf{x}) = \\frac{1}{1 + \\exp(-(\\alpha_2 - \\eta))} = \\frac{1}{1 + \\exp(-(0.0 - 1.365))} = \\frac{1}{1 + \\exp(1.365)}\n$$\n对于 $j=3$：\n$$\nP(Y \\le 3 \\mid \\mathbf{x}) = \\frac{1}{1 + \\exp(-(\\alpha_3 - \\eta))} = \\frac{1}{1 + \\exp(-(1.5 - 1.365))} = \\frac{1}{1 + \\exp(-0.135)}\n$$\n另外，根据定义，$P(Y \\le 4 \\mid \\mathbf{x}) = 1$。\n\n现在，我们计算单个类别的概率 $P(Y=j \\mid \\mathbf{x})$：\n$P(Y=1 \\mid \\mathbf{x}) = P(Y \\le 1 \\mid \\mathbf{x}) \\approx 0.053914$\n$P(Y=2 \\mid \\mathbf{x}) = P(Y \\le 2 \\mid \\mathbf{x}) - P(Y \\le 1 \\mid \\mathbf{x}) \\approx 0.203430 - 0.053914 = 0.149516$\n$P(Y=3 \\mid \\mathbf{x}) = P(Y \\le 3 \\mid \\mathbf{x}) - P(Y \\le 2 \\mid \\mathbf{x}) \\approx 0.533700 - 0.203430 = 0.330270$\n$P(Y=4 \\mid \\mathbf{x}) = 1 - P(Y \\le 3 \\mid \\mathbf{x}) \\approx 1 - 0.533700 = 0.466300$\n\n该患者在不同严重性等级上的预测概率分布约为：$P(Y=1, \\text{无}) \\approx 5.4\\%$，$P(Y=2, \\text{轻度}) \\approx 15.0\\%$，$P(Y=3, \\text{中度}) \\approx 33.0\\%$，以及 $P(Y=4, \\text{重度}) \\approx 46.6\\%$。模型预测最可能的结果是“重度”，这在临床上是合理的。尽管该患者是女性且无合并症（较低的风险因素），但她的年龄（$45$ 岁）和升高的 CRP 水平（$20$ mg/L）导致了正的线性预测器（$\\eta=1.365$），表明其风险状况远高于基线个体。这解释了为什么概率质量会向较高的严重性类别偏移。\n\n最后，我们计算预期严重性指数 $\\mathbb{E}[Y \\mid \\mathbf{x}]$。这是类别值的加权平均值，权重为类别概率：\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] = \\sum_{j=1}^{4} j \\cdot P(Y=j \\mid \\mathbf{x})\n$$\n一种更直接的计算方法是使用累积概率：\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] = \\sum_{j=1}^{K} P(Y \\ge j \\mid \\mathbf{x}) = 1 + \\sum_{j=1}^{K-1} P(Y > j \\mid \\mathbf{x}) = 1 + \\sum_{j=1}^{K-1} (1 - P(Y \\le j \\mid \\mathbf{x})) = K - \\sum_{j=1}^{K-1} P(Y \\le j \\mid \\mathbf{x})\n$$\n当 $K=4$ 时，我们有：\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] = 4 - [P(Y \\le 1 \\mid \\mathbf{x}) + P(Y \\le 2 \\mid \\mathbf{x}) + P(Y \\le 3 \\mid \\mathbf{x})]\n$$\n让我们代入累积概率的数值：\n$P(Y \\le 1 \\mid \\mathbf{x}) \\approx 0.05391418$\n$P(Y \\le 2 \\mid \\mathbf{x}) \\approx 0.20343015$\n$P(Y \\le 3 \\mid \\mathbf{x}) \\approx 0.53369986$\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] \\approx 4 - (0.05391418 + 0.20343015 + 0.53369986)\n$$\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] \\approx 4 - 0.79104419 = 3.20895581\n$$\n问题要求将答案四舍五入至四位有效数字。\n$$\n\\mathbb{E}[Y \\mid \\mathbf{x}] \\approx 3.209\n$$",
            "answer": "$$\n\\boxed{3.209}\n$$"
        },
        {
            "introduction": "从使用模型转向构建和检验模型，医学研究中一个常见的问题是某个特定的生物标志物或风险因素是否对结局有统计学上的显著影响。本实践将演示如何使用似然比检验（Likelihood Ratio Test, LRT）来回答多项结局的这一问题。您将拟合一个包含该生物标志物的完整模型和一个不包含它的简化（零）模型，然后比较它们的似然值来确定该预测变量的显著性。这个动手编码练习能够帮助您深入理解最大似然估计以及在复杂分类模型背景下假设检验的基本原理。",
            "id": "4976107",
            "problem": "考虑一个医学队列，其中分类结果代表具有 $K$ 个互斥类别的疾病状态，并且为每位患者测量了一个连续的生物标志物。假设采用以下基线类别多项逻辑回归表示：对于相对于所选基线类别 $0$ 的由 $k \\in \\{1,\\dots,K-1\\}$ 索引的类别，类别 $k$ 的线性预测器为 $\\eta_k = \\alpha_k + \\beta_k x$，其中 $x$ 是患者的生物标志物值，并且类别概率由逻辑斯蒂链接定义。数据集由独立观测值 $\\{(x_i, y_i)\\}_{i=1}^N$ 组成，其中 $y_i \\in \\{0,1,\\dots,K-1\\}$ 且生物标志物值 $x_i \\in \\mathbb{R}$。建模目标是评估该生物标志物是否对分配到任何非基线类别的几率有任何影响，即，在原假设 $H_0: \\beta_k = 0$ 对所有 $k \\in \\{1,\\dots,K-1\\}$ 成立的情况下，是否所有斜率参数都为零，其备择假设为 $H_1: \\exists k$ 使得 $\\beta_k \\ne 0$。\n\n仅从以下基础出发：\n- 每个观测值 $i$ 具有概率 $(p_{0i}, p_{1i}, \\dots, p_{(K-1)i})$ 的独立分类结果的定义，其中 $p_{0i} + \\sum_{k=1}^{K-1} p_{ki} = 1$。\n- 最大似然估计原理，即参数估计值使指定模型所蕴含的联合似然最大化（等价于使负对数似然最小化）。\n- 基线类别多项逻辑斯蒂链接，它通过逻辑斯蒂变换将线性预测器映射到概率，确保在所有类别上总和为一的有效概率。\n- 通用似然比检验原理，它使用嵌套模型的最大化似然值进行比较，并通过由模型间维度差异决定的适当大样本分布来评估统计显著性。\n\n您的任务是实现一个程序，该程序：\n1. 使用指定的参数集和随机种子，在科学上合理的医学情景下构建合成数据集。\n2. 通过最大化相应的似然来拟合两个模型：允许 $\\beta_k$ 在 $k \\in \\{1,\\dots,K-1\\}$ 上自由变化的不受限模型，以及在 $H_0$ 下，其中对所有 $k \\in \\{1,\\dots,K-1\\}$ 都有 $\\beta_k = 0$ 的受限模型（仅含截距）。\n3. 对每个数据集执行针对 $H_1$ 的 $H_0$ 的似然比检验，报告检验统计量、定义为不受限模型和受限模型之间自由参数数量之差的自由度，以及使用适当参考分布计算的相应大样本 $p$ 值。$p$ 值必须以小数形式报告，而不是百分比。\n\n数据生成和测试套件：\n- 对每个测试用例，从由均值和标准差指定的正态分布中独立生成生物标志物值 $x_i$，然后根据具有给定真实参数的多项逻辑斯蒂模型独立生成结果 $y_i$。使用基线类别参数化，基线类别由 $0$ 索引。\n- 使用以下测试套件，其中每个元组指定 $(N, K, \\boldsymbol{\\alpha}, \\boldsymbol{\\beta}, \\mu_x, \\sigma_x, \\text{seed})$，其中 $\\boldsymbol{\\alpha} = (\\alpha_1,\\dots,\\alpha_{K-1})$ 且 $\\boldsymbol{\\beta} = (\\beta_1,\\dots,\\beta_{K-1})$：\n    1. $(800, 4, (-1.2, 0.5, -0.3), (0.8, -0.5, 0.4), 2.0, 1.0, 42)$，代表一个四类别疾病状态，其中生物标志物在不同类别间显示出异质效应。\n    2. $(600, 3, (-0.2, -1.0), (0.0, 0.0), 1.0, 0.8, 123)$，代表一个无效应情景，其中生物标志物对类别几率没有影响。\n    3. $(50, 3, (-1.5, -1.0), (1.5, 1.2), 0.0, 1.2, 999)$，代表一个具有显著生物标志物效应的小样本边界情况。\n    4. $(1200, 5, (-2.0, -1.0, -1.5, -3.0), (0.7, 0.3, -0.4, 0.9), 1.5, 0.7, 2023)$，代表五类别结果，包括一个具有多样生物标志物效应的罕见类别情景。\n\n算法和数值要求：\n- 使用对基线类别多项逻辑斯蒂链接下的对数似然进行数值稳定的计算方法，为不受限模型和受限模型实现最大似然估计。优化器应基于标准的拟牛顿法，并且不得依赖任何闭式解。\n- 通过使用指定的随机种子来确保可复现性。\n- 程序应生成单行输出，其中包含所有测试用例的结果，格式为一个由方括号括起来的逗号分隔列表。对于每个测试用例，按 $[T, \\text{df}, p]$ 的顺序输出包含三个值的列表，其中 $T$ 是似然比检验统计量（浮点数），$\\text{df}$ 是自由度（整数），$p$ 是 $p$ 值（浮点数）。最终输出的格式应为 $[[T_1,\\text{df}_1,p_1],[T_2,\\text{df}_2,p_2],[T_3,\\text{df}_3,p_3],[T_4,\\text{df}_4,p_4]]$。\n\n此问题不涉及任何物理单位或角度单位；所有输出均为无量纲量。",
            "solution": "该问题要求为多项逻辑回归模型实现一个似然比检验（LRT）。这涉及生成合成数据，在原假设下拟合一个完整（不受限）模型和一个简化（受限）模型，然后比较它们的最大化对数似然以计算检验统计量。\n\n### 第一步：问题验证\n根据指定标准对问题陈述进行严格评估。\n\n#### 步骤 1.1：提取的已知条件\n- **模型：** 带有连续生物标志物预测变量 $x$ 的基线类别多项逻辑回归。\n- **结果：** 一个具有 $K$ 个互斥类别的分类变量，索引为 $y_i \\in \\{0, 1, \\dots, K-1\\}$。类别 $0$ 是基线。\n- **线性预测器：** 对于每个非基线类别 $k \\in \\{1,\\dots,K-1\\}$，观测值 $i$ 的线性预测器为 $\\eta_{ik} = \\alpha_k + \\beta_k x_i$。基线类别的线性预测器为 $\\eta_{i0} = 0$。\n- **概率：** 观测值 $i$ 属于类别 $k$ 的概率由 softmax 函数给出：$p_{ik} = \\frac{\\exp(\\eta_{ik})}{\\sum_{j=0}^{K-1} \\exp(\\eta_{ij})}$。每个观测值的概率总和为一：$\\sum_{k=0}^{K-1} p_{ik} = 1$。\n- **假设：** 原假设 $H_0$ 表明生物标志物没有效应，即对于所有 $k \\in \\{1,\\dots,K-1\\}$，$\\beta_k = 0$。备择假设 $H_1$ 是至少存在一个 $\\beta_k \\neq 0$。\n- **核心原则：** 解决方案必须源自 (1) 独立分类结果模型，(2) 最大似然估计（MLE）原理，(3) 指定的基线类别逻辑斯蒂链接，以及 (4) 通用似然比检验原理。\n- **任务：** 对几个合成数据集，拟合不受限模型和受限模型，并执行 LRT 以获得检验统计量 $T$、自由度 $\\text{df}$ 和 $p$ 值。\n- **数据生成：** 对每个测试用例，从正态分布 $\\mathcal{N}(\\mu_x, \\sigma_x^2)$ 中抽取 $N$ 个生物标志物值 $x_i$。然后，根据从真实模型参数 $(\\boldsymbol{\\alpha}, \\boldsymbol{\\beta})$ 推导出的概率，从多项分布中抽取结果 $y_i$。为四个测试用例提供了 $(N, K, \\boldsymbol{\\alpha}, \\boldsymbol{\\beta}, \\mu_x, \\sigma_x, \\text{seed})$ 的具体值。\n- **数值要求：** 必须使用拟牛顿优化方法执行 MLE。计算必须是数值稳定的。\n\n#### 步骤 1.2：验证与结论\n根据验证清单对问题进行评估：\n- **科学依据：** 该问题牢固地植根于经典统计理论。多项逻辑回归、MLE 和 LRT 是生物统计学和其他科学领域中基础且广泛使用的方法。\n- **适定性：** 该问题是自洽的，并提供了生成数据和执行指定分析所需的所有信息。该模型的目标函数（对数似然）是全局凹的，确保了数值优化是适定的，并将收敛到唯一的最大值。\n- **客观性：** 问题使用精确、正式且无歧义的数学和统计语言进行陈述。\n- **缺陷分析：** 该问题没有表现出任何指定的缺陷。它在科学上是合理的，可形式化的，完整的，现实的，并且是适定的。这是一个非平凡的计算任务，需要正确实现既定的统计原则。\n\n**结论：** 该问题是**有效的**。\n\n### 第二步：原则性解决方案设计\n\n#### 2.1：多项逻辑回归模型\n对于一个生物标志物值为 $x_i$ 的观测值 $i$，该模型为非基线类别定义了 $K-1$ 个线性预测器：\n$$ \\eta_{ik} = \\alpha_k + \\beta_k x_i \\quad \\text{for } k \\in \\{1, \\dots, K-1\\} $$\n为了模型的可识别性，基线类别 $k=0$ 的线性预测器固定为零，即 $\\eta_{i0} = 0$。观测值 $i$ 属于类别 $k$ 的概率由 softmax 变换给出：\n$$ p_{ik} = P(y_i=k | x_i; \\boldsymbol{\\alpha}, \\boldsymbol{\\beta}) = \\frac{\\exp(\\eta_{ik})}{\\sum_{j=0}^{K-1} \\exp(\\eta_{ij})} $$\n\n#### 2.2：最大似然估计（MLE）\n模型的参数 $\\boldsymbol{\\theta} = (\\alpha_1, \\dots, \\alpha_{K-1}, \\beta_1, \\dots, \\beta_{K-1})$ 通过最大化观测数据的对数似然来估计。给定 $N$ 个独立观测值 $\\{(x_i, y_i)\\}_{i=1}^N$，对数似然函数为：\n$$ \\ell(\\boldsymbol{\\theta}) = \\sum_{i=1}^N \\log P(y_i | x_i; \\boldsymbol{\\theta}) $$\n为便于计算，我们对结果使用独热编码，其中如果第 $i$ 个观测值属于类别 $k$，则 $y_{ik} = 1$，否则 $y_{ik} = 0$。对数似然可以写为：\n$$ \\ell(\\boldsymbol{\\theta}) = \\sum_{i=1}^{N} \\sum_{k=0}^{K-1} y_{ik} \\log(p_{ik}) $$\n代入 $p_{ik}$ 的表达式：\n$$ \\ell(\\boldsymbol{\\theta}) = \\sum_{i=1}^{N} \\left( \\sum_{k=0}^{K-1} y_{ik}\\eta_{ik} - \\log\\left(\\sum_{j=0}^{K-1} \\exp(\\eta_{ij})\\right) \\right) $$\n由于 $\\eta_{i0}=0$ 且 $\\sum_{k=0}^{K-1} y_{ik}=1$，并注意到 $y_{i0} \\eta_{i0} = 0$：\n$$ \\ell(\\boldsymbol{\\theta}) = \\sum_{i=1}^{N} \\left( \\sum_{k=1}^{K-1} y_{ik}\\eta_{ik} - \\log\\left(1 + \\sum_{j=1}^{K-1} \\exp(\\eta_{ij})\\right) \\right) $$\n直接计算 $\\exp(\\eta_{ij})$ 可能导致数值溢出。使用 `log-sum-exp` 技巧进行稳定计算：$\\log(\\sum_j e^{z_j}) = M + \\log(\\sum_j e^{z_j-M})$，其中 $M=\\max_j(z_j)$。通过使用拟牛顿法（L-BFGS-B）最小化负对数似然 $-\\ell(\\boldsymbol{\\theta})$ 来执行优化。\n\n#### 2.3：似然比检验（LRT）\nLRT 用于比较两个嵌套模型。\n- **不受限模型（$M_1$）：** 这是上面描述的完整模型，参数为 $\\boldsymbol{\\theta}_1 = (\\alpha_1, \\dots, \\alpha_{K-1}, \\beta_1, \\dots, \\beta_{K-1})$。参数数量为 $d_1 = 2(K-1)$。对此模型最大化似然得到最大化对数似然 $\\ell_1^* = \\ell(\\hat{\\boldsymbol{\\theta}}_1)$。\n- **受限模型（$M_0$）：** 该模型由原假设 $H_0: \\beta_k = 0$（对所有 $k$）指定。其线性预测器为 $\\eta_{ik} = \\alpha_k$。参数为 $\\boldsymbol{\\theta}_0 = (\\alpha_1, \\dots, \\alpha_{K-1})$。参数数量为 $d_0 = K-1$。在此约束下最大化似然得到 $\\ell_0^* = \\ell(\\hat{\\boldsymbol{\\theta}}_0)$。\n\n似然比检验统计量 $T$ 定义为：\n$$ T = -2 (\\ell_0^* - \\ell_1^*) = 2(\\ell_1^* - \\ell_0^*) $$\n在原假设 $H_0$ 下，对于足够大的样本量 $N$，$T$ 渐近服从卡方分布（$\\chi^2$），其自由度等于两个模型参数数量之差：\n$$ \\text{df} = d_1 - d_0 = 2(K-1) - (K-1) = K-1 $$\n$p$ 值是在假设 $H_0$ 为真的情况下，观测到至少与计算出的检验统计量一样大的值的概率：\n$$ p = P(\\chi^2_{\\text{df}} \\ge T) $$\n这使用 $\\chi^2_{\\text{df}}$ 分布的生存函数计算。\n\n#### 2.4：实现\n解决方案逻辑在 Python 程序中实现。对每个测试用例：1. 使用 `numpy.random` 创建合成数据集。为保证可复现性，对 `default_rng` 进行播种。2. 定义两个目标函数 `nll_m0` 和 `nll_m1`，分别用于计算受限模型和不受限模型的负对数似然。这些函数为数值稳定性而设计。3. 使用带 `L-BFGS-B` 方法的 `scipy.optimize.minimize` 函数，通过最小化各自的负对数似然来找到两个模型的最大似然估计。4. 从优化结果中提取最大化对数似然 $\\ell_0^*$ 和 $\\ell_1^*$。5. 如上所述计算 LRT 统计量 $T$、自由度 $\\text{df}$ 和 $p$ 值，其中 $p$ 值从 `scipy.stats.chi2.sf` 获得。6. 收集所有测试用例的结果并格式化为所需的输出字符串。",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize\nfrom scipy.special import softmax, logsumexp\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Main function to run the likelihood ratio test for multinomial logistic regression\n    on several synthetic datasets.\n    \"\"\"\n    test_cases = [\n        # (N, K, alpha_true, beta_true, mu_x, sigma_x, seed)\n        (800, 4, [-1.2, 0.5, -0.3], [0.8, -0.5, 0.4], 2.0, 1.0, 42),\n        (600, 3, [-0.2, -1.0], [0.0, 0.0], 1.0, 0.8, 123),\n        (50, 3, [-1.5, -1.0], [1.5, 1.2], 0.0, 1.2, 999),\n        (1200, 5, [-2.0, -1.0, -1.5, -3.0], [0.7, 0.3, -0.4, 0.9], 1.5, 0.7, 2023),\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        N, K, alphas_true, betas_true, mu_x, sigma_x, seed = case\n        \n        # 1. Generate synthetic data\n        rng = np.random.default_rng(seed)\n        x_data = rng.normal(loc=mu_x, scale=sigma_x, size=N)\n        \n        alphas_true_np = np.array(alphas_true)\n        betas_true_np = np.array(betas_true)\n\n        # Calculate true linear predictors (eta) for categories 1 to K-1\n        eta = alphas_true_np[None, :] + np.outer(x_data, betas_true_np)\n        \n        # Add baseline category's eta (which is 0)\n        eta_full = np.hstack([np.zeros((N, 1)), eta])\n        \n        # Convert to probabilities using softmax\n        probs = softmax(eta_full, axis=1)\n        \n        # Generate categorical outcomes\n        y_data = np.array([rng.choice(K, p=p_i) for p_i in probs])\n        \n        # One-hot encode the outcome variable for likelihood calculation\n        y_one_hot = np.zeros((N, K))\n        y_one_hot[np.arange(N), y_data] = 1\n\n        # 2. Fit models using MLE\n        \n        def nll_m0(params, x, y_oh, k_val):\n            \"\"\"Negative log-likelihood for the restricted model (M0: intercepts only).\"\"\"\n            n_obs = x.shape[0]\n            alphas = params\n            # Eta does not depend on x\n            eta_k = np.tile(alphas, (n_obs, 1))\n            eta_full = np.hstack([np.zeros((n_obs, 1)), eta_k])\n            \n            log_denominators = logsumexp(eta_full, axis=1)\n            log_probs = eta_full - log_denominators[:, None]\n            \n            nll = -np.sum(y_oh * log_probs)\n            return nll\n\n        def nll_m1(params, x, y_oh, k_val):\n            \"\"\"Negative log-likelihood for the unrestricted model (M1).\"\"\"\n            n_obs = x.shape[0]\n            alphas = params[:k_val - 1]\n            betas = params[k_val - 1:]\n            \n            eta_k = alphas[None, :] + np.outer(x, betas)\n            eta_full = np.hstack([np.zeros((n_obs, 1)), eta_k])\n\n            log_denominators = logsumexp(eta_full, axis=1)\n            log_probs = eta_full - log_denominators[:, None]\n\n            nll = -np.sum(y_oh * log_probs)\n            return nll\n\n        # Fit restricted model (M0)\n        initial_params_0 = np.zeros(K - 1)\n        res0 = minimize(nll_m0, initial_params_0, args=(x_data, y_one_hot, K), method='L-BFGS-B')\n        logL0 = -res0.fun\n\n        # Fit unrestricted model (M1)\n        initial_params_1 = np.zeros(2 * (K - 1))\n        res1 = minimize(nll_m1, initial_params_1, args=(x_data, y_one_hot, K), method='L-BFGS-B')\n        logL1 = -res1.fun\n\n        # 3. Perform Likelihood Ratio Test\n        # Test statistic T = 2 * (logL(M1) - logL(M0))\n        T = 2 * (logL1 - logL0)\n        \n        # Degrees of freedom = difference in number of parameters\n        df = (2 * (K - 1)) - (K - 1)\n        \n        # p-value from chi-squared distribution\n        p_value = chi2.sf(T, df)\n        \n        all_results.append([T, df, p_value])\n\n    # Format the final output string\n    # E.g., [[T1,df1,p1],[T2,df2,p2],...]\n    output_str = f\"[{','.join(f'[{t:.6f},{d},{p:.6f}]' for t, d, p in all_results)}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}