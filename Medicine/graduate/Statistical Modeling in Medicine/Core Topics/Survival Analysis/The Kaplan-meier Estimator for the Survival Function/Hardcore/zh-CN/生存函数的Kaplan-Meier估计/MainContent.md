## 引言
在医学研究、工程可靠性测试和许多其他科学领域，分析“从起点到某一事件发生的时间”（即时间至事件数据）是一项核心任务。然而，由于研究周期有限、个体失访等原因，我们常常无法观测到所有研究对象的完整事件时间，这种情况被称为“删失”。这种不完整的[数据结构](@entry_id:262134)给传统的统计分析带来了巨大挑战，直接忽略或错误处理删失数据会导致对生存概率的严重偏误。

为了解决这一难题，[Kaplan-Meier](@entry_id:169317)（KM）估计量应运而生，它已成为生存分析领域最基础、应用最广泛的[非参数方法](@entry_id:138925)。本文旨在全面剖析[Kaplan-Meier估计量](@entry_id:178062)，帮助读者从基本原理到高级应用建立一个完整的知识框架。

本文将分为三个核心部分。在“原理与机制”一章中，我们将深入探讨K[M估计量](@entry_id:169257)的数学构造、处理[删失数据](@entry_id:173222)的概率逻辑，以及其作为[非参数最大似然估计](@entry_id:164132)的理论基础。接下来，在“应用与跨学科联系”一章中，我们将展示K[M估计量](@entry_id:169257)在比较不同群体生存状况、处理左截断和竞争风险等复杂[数据结构](@entry_id:262134)时的应用与扩展，并揭示其与Cox回归模型乃至工程学和机器学习等领域的深刻联系。最后，通过“动手实践”部分，读者将有机会通过具体计算来巩固所学知识，掌握从原始数据生成生存曲线及相关统计量的全过程。

## 原理与机制

在上一章引言的基础上，本章将深入探讨[Kaplan-Meier估计量](@entry_id:178062)的核心原理、数学构造及其在生存分析中的具体应用。我们将从[生存数据](@entry_id:165675)的基本结构出发，逐步构建估计量的概率逻辑，阐明其计算方法，并最终探讨其重要的理论性质，为后续章节中更复杂的模型奠定基础。

### 基本概念与设定：处理不完整数据的挑战

生存分析的核心任务是估计**生存函数 (survival function)** $S(t) = \mathbb{P}(T > t)$，其中 $T$ 是表示从某个起始点到某个“事件”发生所经过时间的随机变量。然而，在临床研究或可靠性测试等实际场景中，我们往往无法观测到所有研究对象的完整事件时间 $T$。最常见的情况是**[右删失](@entry_id:164686) (right-censoring)**，即观测在事件发生前因某种原因而终止。

为了精确地描述这一过程，我们为每个研究对象 $i$ 定义以下变量：
*   $T_i$：潜在的、真实的事件时间。
*   $C_i$：潜在的删失时间，例如研究结束、失访等。
*   $X_i = \min(T_i, C_i)$：实际观测到的时间，即事件时间和删失时间中的较小者。
*   $\delta_i = \mathbf{1}\{T_i \le C_i\}$：事件指示符，如果观测到的是真实事件，则 $\delta_i=1$；如果观测因删失而终止，则 $\delta_i=0$。

因此，对于每个研究对象，我们能获取的数据是一个数据对 $(X_i, \delta_i)$，以及可能影响生存时间的基线协变量 $\mathbf{Z}_i$。

#### 关键假设：非信息性删失

直接使用观测时间 $X_i$ 来估计生存函数是有问题的。例如，一个简单的估计量 $\tilde{S}_n(t) = n^{-1}\sum_{i=1}^n \mathbf{1}\{X_i > t\}$ 会系统性地低估真实的生存概率，因为它错误地将删失的个体等同于在删失时刻发生事件的个体，而实际上我们只知道这些个体在删失时仍然存活。

为了从删失数据中无偏地估计生存函数，我们必须引入一个核心假设：**非信息性删失 (non-informative censoring)**。这个假设的直观含义是，在任何时间点，一个被删失的个体其未来的事件风险与那些在同一时间点仍然在研究中、具有相同协变量的个体是相同的。换言之，删失的发生与个体未来的生存前景无关。

在数学上，这个假设被表述为事件时间 $T$ 和删失时间 $C$ 在给定协变量 $\mathbf{Z}$ 的条件下是独立的，记作 $T \perp C \mid \mathbf{Z}$。这意味着对于任意时间 $t$ 和 $c$ 以及协变量值 $z$，我们有：
$$ \mathbb{P}(T > t, C > c \mid \mathbf{Z} = z) = \mathbb{P}(T > t \mid \mathbf{Z} = z) \mathbb{P}(C > c \mid \mathbf{Z} = z) $$
一个更具实践意义的等价定义是，在任意时间 $t$，对于那些仍然存活（即 $T \ge t$）且具有相同协变量 $\mathbf{Z}$ 的个体，他们是否会被删失的概率不依赖于他们未来的真实事件时间 $T$。

这个假设至关重要，因为它允许我们将观测数据的似然函数分解。对于一个观测值为 $(X_i, \delta_i, \mathbf{Z}_i)$ 的个体，其似然贡献可以写作：
$$ L_i = [f_T(X_i \mid \mathbf{Z}_i) S_C(X_i \mid \mathbf{Z}_i)]^{\delta_i} [S_T(X_i \mid \mathbf{Z}_i) f_C(X_i \mid \mathbf{Z}_i)]^{1 - \delta_i} $$
其中 $f_T$ 和 $S_T$ 分别是事件时间的密度函数和生存函数，$f_C$ 和 $S_C$ 则是删失时间的对应函数。在 $T \perp C \mid \mathbf{Z}$ 的假设下，整个样本的似然函数可以分解为两个独立的部分：一个只与事件时间分布的参数有关，另一个只与删失时间分布的参数有关。
$$ L = L_T(\theta_T) \times L_C(\theta_C) $$
这意味着我们可以通过最大化[似然函数](@entry_id:141927)中仅与 $T$ 相关的部分 $L_T(\theta_T)$ 来估计 $S_T(t)$，而无需对删失过程进行建模。这正是[Kaplan-Meier](@entry_id:169317)估计作为[非参数最大似然估计](@entry_id:164132)（[NPMLE](@entry_id:164132)）的理论基础。

### 乘积极限法的概率逻辑

Kaplan-Meier估计的核心思想是将生存概率的计算分解为一系列条件概率的乘积。根据概率论的链式法则，存活超过时间 $t$ 的概率可以表示为：
$$ S(t) = \mathbb{P}(T > t) = \mathbb{P}(T > t_1) \times \mathbb{P}(T > t_2 \mid T > t_1) \times \dots \times \mathbb{P}(T > t_k \mid T > t_{k-1}) $$
其中 $t_1  t_2  \dots  t_k$ 是一系列时间点。[Kaplan-Meier](@entry_id:169317)方法巧妙地选择在每个观测到的事件发生时间点上来估计这些[条件概率](@entry_id:151013)。

假设 $t_{(1)}  t_{(2)}  \dots  t_{(K)}$ 是数据中所有唯一的、按顺序排列的事件时间。在每个事件时间 $t_{(j)}$，我们关注的是“在已知存活到 $t_{(j)}$ 之前的情况下，能够继续存活过 $t_{(j)}$ 的[条件概率](@entry_id:151013)”，即 $\mathbb{P}(T  t_{(j)} \mid T \ge t_{(j)})$。

为了估计这个条件概率，我们定义两个关键量：
*   **风险集 (risk set)** $n_j$：在事件时间 $t_{(j)}$ 之前“处于风险中”的个体数量。一个体在时间 $t_{(j)}$ 处于风险中，意味着他/她在此之前既未发生事件也未被删失，即其观测时间 $X_i \ge t_{(j)}$。
*   **事件数 (number of events)** $d_j$：在时间 $t_{(j)}$ 精确发生的事件数量。

在时间点 $t_{(j)}$，有 $n_j$ 个体处于风险中，其中 $d_j$ 个体发生了事件。因此，在 $t_{(j)}$ 发生事件的[条件概率](@entry_id:151013)（即离散风险或hazard）的经验估计为 $d_j/n_j$。相应地，在已知存活至 $t_{(j)}$ 的条件下，继续存活过 $t_{(j)}$ 的条件概率的经验估计就是：
$$ \left(1 - \frac{d_j}{n_j}\right) $$
这个简单的比率是[Kaplan-Meier](@entry_id:169317)估计的基石，它代表了在每个事件发生时刻，风险人群中未发生事件的比例。

通过将所有截至时间 $t$ 的事件时刻的条件生存概率相乘，我们便得到了Kaplan-Meier[乘积极限估计量](@entry_id:171437) (product-limit estimator) 的表达式：
$$ \hat{S}(t) = \prod_{j: t_{(j)} \le t} \left(1 - \frac{d_j}{n_j}\right) $$
这个公式优雅地结合了所有可用的信息，正确处理了删失数据，为我们提供了对真实生存函数的非[参数估计](@entry_id:139349)。

### Kaplan-Meier估计的实践应用

虽然公式看起来简洁，但在实际计算中需要严谨细致。下面我们通过一个综合示例来演示计算过程。假设一个包含10个组件的可靠性研究，记录了如下的失效（事件）和移除（删失，用`*`表示）时间（单位：小时）：50, 80*, 80*, 120, 150*, 150*, 150*, 150*, 150*, 150*。我们来计算在不同时间点的生存概率。

**计算步骤:**

1.  **识别并排序唯一事件时间**：数据中的事件时间为 $t_{(1)} = 50$ 和 $t_{(2)} = 120$。

2.  **计算 $\hat{S}(t)$**：
    *   **初始状态 ($t=0$)**: 所有10个组件都处于风险中，$\hat{S}(0) = 1$。
    *   **第一个事件 ($t_{(1)}=50$ 小时)**:
        *   风险集 $n_1$：在50小时前，所有10个组件都在运行，因此 $n_1=10$。
        *   事件数 $d_1$：在50小时发生1次失效，因此 $d_1=1$。
        *   更新生存概率：
            $$ \hat{S}(50) = \hat{S}(0) \times \left(1 - \frac{d_1}{n_1}\right) = 1 \times \left(1 - \frac{1}{10}\right) = 0.9 $$
            对于 $50 \le t  120$ 的所有时间 $t$，生存概率估计值保持为 $0.9$。
    *   **删失事件 ($t=80$ 小时)**:
        *   在80小时，有2个组件被移除（删失）。这一行为**不会**导致生存曲线的下降。$\hat{S}(t)$ 在删失时刻保持不变。然而，这些删失的个体会从后续的风险集中移除，从而影响后续的计算。
    *   **第二个事件 ($t_{(2)}=120$ 小时)**:
        *   风险集 $n_2$：在120小时前，最初的10个组件中，1个在50小时失效，2个在80小时删失。因此，风险集大小为 $10 - 1 - 2 = 7$，即 $n_2=7$。
        *   事件数 $d_2$：在120小时发生1次失效，因此 $d_2=1$。
        *   更新生存概率：
            $$ \hat{S}(120) = \hat{S}(\text{before 120}) \times \left(1 - \frac{d_2}{n_2}\right) = 0.9 \times \left(1 - \frac{1}{7}\right) = \frac{9}{10} \times \frac{6}{7} = \frac{54}{70} \approx 0.771 $$
            
    *   **研究结束 ($t=150$ 小时)**:
        *   在120小时之后，直到研究结束（150小时），没有其他事件发生。因此，对于所有 $t \ge 120$ 的时间，生存概率估计值保持在 $\hat{S}(t) \approx 0.771$。剩下的6个组件在150小时被删失，这标志着我们无法再从数据中获取关于生存时间的更多信息。

从这个例子可以看出，[Kaplan-Meier](@entry_id:169317)生存曲线是一个**右连续的阶梯函数 (step function)**。它的值仅在**事件发生时**刻发生向下跳跃，而在两个连续事件之间保持平坦。删失时刻不会引起跳跃，但会减少后续计算中的风险集大小，从而影响之后跳跃的幅度。

### 理论基础与[渐近性质](@entry_id:177569)

为了进行统计推断，如构建[置信区间](@entry_id:138194)或进行假设检验，我们需要了解[Kaplan-Meier估计量](@entry_id:178062)的统计性质，特别是其方差和在大样本下的分布。

#### 与风险函数的关系

生存分析的另一个核心概念是**[风险函数](@entry_id:166593) (hazard function)** $\lambda(t)$，它表示在时间 $t$ 存活的个体在该时刻发生事件的[瞬时速率](@entry_id:182981)。[累积风险函数](@entry_id:169734)定义为 $A(t) = \int_0^t \lambda(u)du$。在连续时间模型中，生存函数和[累积风险函数](@entry_id:169734)之间有确定的关系：$S(t) = \exp(-A(t))$。

在离散数据的情境下，我们可以定义一个累积风险的非参数估计量，即**Nelson-Aalen估计量**:
$$ \hat{A}(t) = \sum_{j: t_{(j)} \le t} \frac{d_j}{n_j} $$
它简单地将每个事件时刻的离散风险 $(d_j/n_j)$ 累加起来。

[Kaplan-Meier估计量](@entry_id:178062)与Nelson-Aalen估计量之间存在着深刻的联系。通过对 $\log(1-x) \approx -x$（当 $x$ 很小时）这个一阶[泰勒展开](@entry_id:145057)，我们可以近似地建立两者关系：
$$ \log \hat{S}(t) = \sum_{j: t_{(j)} \le t} \log\left(1 - \frac{d_j}{n_j}\right) \approx \sum_{j: t_{(j)} \le t} \left(-\frac{d_j}{n_j}\right) = -\hat{A}(t) $$
因此，我们得到一个非常重要的近似关系：$\hat{S}(t) \approx \exp(-\hat{A}(t))$。这个近似在每个事件时刻的风险 $d_j/n_j$ 都很小（例如，在大样本研究中，事件不密集）时非常精确。这为理解[Kaplan-Meier估计量](@entry_id:178062)提供了另一个视角，即它是从累积风险的估计转化而来的生存函数估计。

#### 方差估计与[置信区间](@entry_id:138194)

为了量化 $\hat{S}(t)$ 的不确定性，我们需要估计其方差。最常用的方法是**Greenwood公式 (Greenwood's formula)**：
$$ \widehat{\text{Var}}(\hat{S}(t)) = [\hat{S}(t)]^2 \sum_{j: t_{(j)} \le t} \frac{d_j}{n_j(n_j - d_j)} $$
这个公式同样可以从乘积极限的结构通过[Delta方法](@entry_id:276272)推导得出。分母中的 $n_j - d_j$ 项反映了在时间 $t_{(j)}$ 存活下来的个体数量。

更深入的**[计数过程](@entry_id:260664)理论 (counting process theory)** 揭示了其[渐近性质](@entry_id:177569)。可以将 $\hat{S}(t)$ 的估计误差表示为鞅 (martingale) 的积分形式。通过这一理论可以证明，在大样本 ($n \to \infty$) 条件下，经过适当缩放的[Kaplan-Meier估计量](@entry_id:178062)是渐近正态的。具体来说，$\sqrt{n}(\hat{S}(t) - S(t))$ 会收敛到一个正态分布。其[渐近方差](@entry_id:269933)也与真实的风险函数 $\lambda(s)$ 和在时间 $s$ 仍处于风险中的概率 $\pi(s)$ 相关：
$$ \lim_{n\to\infty} n \cdot \text{Var}(\ln(\hat{S}(t))) = \int_0^t \frac{\lambda(s)}{\pi(s)} ds $$
这一[渐近正态性](@entry_id:168464)的关键结果使得构建**点状[置信区间](@entry_id:138194) (pointwise confidence interval)** 成为可能。在给定的时间点 $t$，真实生存函数 $S(t)$ 的 $100(1-\alpha)\%$ [置信区间](@entry_id:138194)可以计算为：
$$ \hat{S}(t) \pm z_{\alpha/2} \sqrt{\widehat{\text{Var}}(\hat{S}(t))} $$
其中 $z_{\alpha/2}$ 是标准正态分布的临界值。

除了对单个时间点的推断，研究者们也发展了为整条生存曲线构建**置信带 (confidence bands)** 的方法，如Hall-Wellner置信带。这些置信带可以在一个时间区间内同时保证对 $S(t)$ 的覆盖率，但这需要更高等的弱[收敛理论](@entry_id:176137)。在大多数应用中，基于Greenwood公式的点状[置信区间](@entry_id:138194)已经为评估估计的不确定性提供了非常有用的工具。