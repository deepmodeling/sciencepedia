## 引言
在[生物医学系统建模](@entry_id:1121641)领域，构建能够精确描述复杂生理过程并做出可靠预测的模型至关重要。然而，模型的价值并不仅仅取决于其对数据的[拟合优度](@entry_id:176037)，如高[决定系数](@entry_id:900023)（$R^2$），更在于我们对其局限性和潜在缺陷的深刻理解。仅仅接受一个看似“好”的模型而不对其假设进行严格审视，可能会导致错误的科学推断和临床决策。[残差分析](@entry_id:191495)，即对模型预测值与实际观测值之差的研究，正是填补这一认知空白、从模型“失败”中学习的关键方法论。

本文将系统性地引导读者深入[残差分析](@entry_id:191495)的世界。第一章**“原理与机制”**将从最基础的线性模型出发，揭示残差的数学本质，并介绍用于[模型诊断](@entry_id:136895)的[标准化残差](@entry_id:634169)及其图形化工具。第二章**“应用与交叉学科联系”**将展示这些理论如何在[药代动力学](@entry_id:136480)、时间序列分析和[神经影像学](@entry_id:896120)等真实世界问题中发挥作用，凸显[残差分析](@entry_id:191495)作为科学发现引擎的潜力。最后，在第三章**“动手实践”**中，您将通过具体的编程练习，将理论知识转化为可操作的技能。通过这三章的学习，您将掌握一套完整的工具，不仅能评估模型的有效性，更能洞察其不足，并据此进行改进，从而构建更稳健、更可信的生物医学模型。

## 原理与机制

在[生物医学系统建模](@entry_id:1121641)中，任何模型的价值最终都取决于其拟合数据的优劣以及其预测的准确性。[残差分析](@entry_id:191495)是评估模型性能、诊断模型假定是否成立以及指导模型改进的核心工具。本章将深入探讨[残差分析](@entry_id:191495)的基本原理和关键机制，从经典的线性模型出发，逐步扩展到[广义线性模型](@entry_id:900434)和[非线性混合效应模型](@entry_id:1128864)等更复杂的框架。我们将阐明残差的数学性质，介绍用于[模型诊断](@entry_id:136895)的各类残差及其图形化表示，并最终将这些原理应用于生物医学研究中的复杂问题。

### 线性模型中残差的基本性质

为了建立一个坚实的理论基础，我们首先在[普通最小二乘法](@entry_id:137121)（Ordinary Least Squares, OLS）[线性模型](@entry_id:178302)的框架下考察残差。假设我们有一个模型 $y = X\beta + \varepsilon$，其中 $y \in \mathbb{R}^{n}$ 是观测响应向量，$X \in \mathbb{R}^{n \times p}$ 是一个列满秩的[设计矩阵](@entry_id:165826)，$\beta \in \mathbb{R}^{p}$ 是待估计的参数向量，而 $\varepsilon \in \mathbb{R}^{n}$ 是随机误差向量。

#### 定义：残差与不可观测的误差

一个至关重要的区别在于**残差（residuals）**和**误差（errors）**。误差向量 $\varepsilon = y - X\beta$ 代表了真实数据生成过程中的随机波动，是观测值 $y$ 与真实条件均值 $X\beta$ 之间的偏差。在实际应用中，真实的参数 $\beta$ 是未知的，因此 $\varepsilon$ 是不可观测的。

相比之下，残差是可观测的量。通过OLS方法，我们得到参数的估计值 $\hat{\beta}$，进而得到拟合值向量 $\hat{y} = X\hat{\beta}$。**普通[残差向量](@entry_id:165091)（ordinary residual vector）** $e$ 定义为观测值与拟合值之差：

$e = y - \hat{y} = y - X\hat{\beta}$

残差 $e$ 可以看作是不可[观测误差](@entry_id:752871) $\varepsilon$ 的一个估计或代理。然而，正如我们将看到的，残差的数学性质与误差有显著的不同，理解这些差异是正确进行[模型诊断](@entry_id:136895)的关键 。

#### OLS的几何学：[正交性原理](@entry_id:153755)

[OLS估计量](@entry_id:177304) $\hat{\beta}$ 是通过最小化**[残差平方和](@entry_id:174395)（Residual Sum of Squares, RSS）** $S(\beta) = \|y - X\beta\|_2^2$ 得到的。对 $S(\beta)$ 关于 $\beta$ 求导并令其为零，可以得到**[正规方程组](@entry_id:142238)（normal equations）** ：

$X^{\top}(y - X\hat{\beta}) = 0 \implies X^{\top}e = 0$

这个简单的方程蕴含着深刻的几何意义。它表明，[残差向量](@entry_id:165091) $e$ 与设计矩阵 $X$ 的所有列向量均正交。换言之，**[残差向量](@entry_id:165091) $e$ 位于 $X$ [列空间](@entry_id:156444)的[正交补](@entry_id:149922)空间中**。这是一个由OLS拟合过程施加在残差上的严格数学约束。如果模型包含一个截距项（即 $X$ 的某一列是全为1的向量 $\mathbf{1}_n$），那么 $X^{\top}e = 0$ 的一个直接推论就是 $\mathbf{1}_n^{\top}e = \sum_{i=1}^{n} e_i = 0$。也就是说，包含截距项的OLS模型的残差之和恒为零 。

#### 统计性质：均值、方差与协方差

为了深入理解残差的行为，我们需要考察它们的统计性质。我们可以通过**[帽子矩阵](@entry_id:174084)（hat matrix）** $H$ 来简化表达。[帽子矩阵](@entry_id:174084)是一个[投影矩阵](@entry_id:154479)，它将观测向量 $y$ 投影到 $X$ 的[列空间](@entry_id:156444)上，从而得到拟合值 $\hat{y}$。其定义为 $H = X(X^{\top}X)^{-1}X^{\top}$。于是，拟合值和残差可以写为：

$\hat{y} = Hy$

$e = y - \hat{y} = (I_n - H)y$

这里 $I_n$ 是 $n$ 维单位矩阵。矩阵 $M = I_n - H$ 同样是一个[投影矩阵](@entry_id:154479)，它将[向量投影](@entry_id:147046)到 $X$ [列空间](@entry_id:156444)的[正交补](@entry_id:149922)空间上。

现在，我们可以利用 $e = M\varepsilon$ 的关系（推导见 ）来研究残差的期望和方差。假设误差项满足标准假定 $E(\varepsilon) = 0$ 和 $\operatorname{Var}(\varepsilon) = \sigma^2 I_n$（即误差不相关且方差恒定），我们可以推导出：

- **期望（Mean）**: 残差的期望为零。
$E(e) = E((I_n - H)\varepsilon) = (I_n - H)E(\varepsilon) = 0$

- **方差-协方差矩阵（Variance-Covariance Matrix）**: 残差的方差-协方差矩阵为 $\sigma^2(I_n - H)$。
$\operatorname{Var}(e) = \operatorname{Var}((I_n - H)\varepsilon) = (I_n - H)\operatorname{Var}(\varepsilon)(I_n - H)^{\top} = (I_n - H)(\sigma^2 I_n)(I_n - H) = \sigma^2(I_n - H)$
推导中利用了 $I_n - H$ 是对称和幂等的性质 ($M^2=M$)  。

这个[协方差矩阵](@entry_id:139155)揭示了残差的两个关键特性，这与误差的假定形成鲜明对比：
1.  **残差是相关的**：$\operatorname{Var}(e)$ 的非对角元素为 $-\sigma^2 h_{ij}$，通常不为零。这意味着即使真实的误差 $\varepsilon_i$ 是[相互独立](@entry_id:273670)的，OLS残差 $e_i$ 彼此之间也是相关的。这种相关性是由于它们共同受到 $p$ 个正交性约束（$X^{\top}e=0$）的限制。例如，在一个简单的模型中，我们可能会发现第一个残差和最后一个残差之间存在协方差，如 $\operatorname{Cov}(e_1, e_4) = -\sigma^2 h_{14}$，这表明它们并非独立 。
2.  **残差是异方差的**：第 $i$ 个残差的方差为 $\operatorname{Var}(e_i) = \sigma^2(1 - h_{ii})$。其中 $h_{ii}$ 是[帽子矩阵](@entry_id:174084) $H$ 的第 $i$ 个对角元素，称为观测 $i$ 的**[杠杆值](@entry_id:172567)（leverage）**。由于[杠杆值](@entry_id:172567) $h_{ii}$ 对于不同的观测通常是不同的，所以即使真实误差的方差 $\sigma^2$ 是恒定的（[同方差性](@entry_id:634679)），残差的方差也不是恒定的。[杠杆值](@entry_id:172567)越高的观测点（通常是那些在[协变](@entry_id:634097)量空间中较为极端的点），其残差的方差就越小。

#### [残差平方和](@entry_id:174395)与自由度

[残差平方和](@entry_id:174395) $\text{RSS} = e^{\top}e = \|e\|_2^2$ 是衡量[模型拟合](@entry_id:265652)优度的核心指标。我们可以计算其[期望值](@entry_id:150961)：

$\mathbb{E}[\text{RSS}] = \mathbb{E}[e^{\top}e] = \mathbb{E}[\varepsilon^{\top}(I_n - H)\varepsilon] = \sigma^2 \operatorname{tr}(I_n - H)$

由于[投影矩阵的迹](@entry_id:155632)等于其所投影空间的维度，我们有 $\operatorname{tr}(H) = \operatorname{rank}(X) = p$，因此 $\operatorname{tr}(I_n - H) = n - p$。所以：

$\mathbb{E}[\text{RSS}] = \sigma^2 (n - p)$

这个结果  表明，$\text{RSS}$ 的[期望值](@entry_id:150961)是真实误差方差 $\sigma^2$ 的 $(n-p)$ 倍。量 $(n-p)$ 被称为**残差自由度（degrees of freedom for error）**。这启发我们使用均方误（Mean Squared Error, MSE）$s^2 = \frac{\text{RSS}}{n-p}$ 作为 $\sigma^2$ 的[无偏估计量](@entry_id:756290)。

### 用于诊断的[标准化残差](@entry_id:634169)

由于原始残差 $e_i$ 的方差不恒定，直接比较它们的大小可能会产生误导。为了进行有效的[模型诊断](@entry_id:136895)，特别是[离群点检测](@entry_id:175858)，我们需要对残差进行[标准化](@entry_id:637219)，使其具有近似相同的方差。

#### [内部标准化](@entry_id:181400)残差

一个自然的想法是用每个残差除以其标准差的估计值。第 $i$ 个残差的标准差为 $\sigma\sqrt{1-h_{ii}}$。用 $s$ 替换未知的 $\sigma$，我们得到**[内部标准化](@entry_id:181400)残差（internally standardized residual）**，通常记为 $r_i$：

$r_i = \frac{e_i}{s\sqrt{1-h_{ii}}}$

这些残差的[方差近似](@entry_id:268585)为1，使得它们在不同观测点之间具有可比性。然而，由于计算 $s$ 时用到了包括 $e_i$ 在内的所有残差，所以 $e_i$ 和 $s$ 不是统计独立的。因此，在正态误差假定下，$r_i$ 并不精确服从[学生t分布](@entry_id:267063)（[Student's t-distribution](@entry_id:142096)） 。

#### 外部[学生化](@entry_id:176921)（删除）残差

为了解决上述的独立性问题，从而构造一个具有精确已知分布的统计量，我们引入**外部[学生化残差](@entry_id:636292)（externally studentized residual）**，也称为**删除残差（deleted residual）**或**R-student**，记为 $t_i$：

$t_i = \frac{e_i}{s_{(i)}\sqrt{1-h_{ii}}}$

这里的关键区别在于分母中的 $s_{(i)}$。$s_{(i)}^2$ 是在**删除第 $i$ 个观测点**后重新拟合模型所得的均方误。由于 $s_{(i)}^2$ 的计算不依赖于第 $i$ 个观测，它与 $e_i$ 是统计独立的。这个精巧的构造使得在正态误差假定下，$t_i$ 精确服从自由度为 $n-p-1$ 的[t分布](@entry_id:267063) 。

$t_i \sim t_{n-p-1}$

这为检测离群点提供了一个正式的[假设检验框架](@entry_id:165093)。一个重要的代数关系将 $s_{(i)}^2$ 与 $s^2$ 联系起来，避免了实际进行 $n$ 次回归的计算负担 ：

$\frac{s_{(i)}}{s} = \sqrt{\frac{n-p-r_i^2}{n-p-1}}$

这个关系式表明，当一个点的[内部标准化](@entry_id:181400)残差 $r_i$ 的绝对值很大时，删除该点对[误差方差估计](@entry_id:167285)的影响也更大。

### 图形化诊断：可视化模型假定

[残差图](@entry_id:169585)是[模型诊断](@entry_id:136895)中不可或缺的工具，它能将模型的缺陷直观地呈现出来。

#### 评估线性关系：残差 vs. 拟合值图

这是最重要、最常用的[残差图](@entry_id:169585)之一。该图以拟合值 $\hat{y}_i$ 为横坐标，残差（通常是某种[标准化残差](@entry_id:634169)）为纵坐标。其基本原理是：如果模型对条件均值的设定是正确的（即 $E(y|X)$ 确实是线性的），那么残差应在零线上下随机散布，不应表现出任何系统性的模式。数学上，这意味着 $E(e_i|\hat{y}_i) \approx 0$ 。

- **无模式（随机散点）**：表明线性假定是合理的。
- **系统性模式**：表明[均值函数](@entry_id:264860)被错误设定。常见的模式包括：
    - **U形或倒U形曲线**：这通常表示模型中遗漏了一个或多个连续预测变量的**二次项**。例如，如果真实关系包含 $x^2$ 项，但模型只包含了 $x$，[残差图](@entry_id:169585)中就会出现这种抛物线形状 。
    - **S形曲线**：可能表示遗漏了**三次项**或一个复杂的[交互作用](@entry_id:164533)项。

在[多元回归](@entry_id:144007)中，$\hat{y}_i$ 是高维预测变量空间的一个一维投影。残差对拟合值的图能够揭示由多个预测变量的组合或其交互作用引起的[非线性](@entry_id:637147)，而这些[非线性](@entry_id:637147)在残差对单个预测变量的图中可能不明显。因此，它是一个评估模型整体线性度的强大工具。

#### 评估[同方差性](@entry_id:634679)：尺度-位置图

**尺度-位置图（Scale-Location plot）**专门用于检验**[同方差性](@entry_id:634679)（homoscedasticity）**的假定，即[误差方差](@entry_id:636041) $\sigma^2$ 是否为常数。该图通常以拟合值 $\hat{y}_i$ 为横坐标，以**[标准化残差](@entry_id:634169)绝对值的平方根** $\sqrt{|s_i|}$ 为纵坐标，其中 $s_i$ 是[标准化残差](@entry_id:634169) 。

- **为何使用 $\sqrt{|s_i|}$**？残差的分布可能是有偏的，取绝对值后再开方可以使分布更对称，减少极端值对图形趋势的过度影响，从而更稳定地展现方差的趋势。
- **图形解读**：
    - **水平带状分布**：如果点在图中形成一个大致水平的带，说明残差的离散程度（尺度）不随拟合值的变化而变化，支持[同方差性](@entry_id:634679)假定。
    - **喇叭形（Funnel shape）**：如果点的散布范围随着拟合值的增加而扩大或缩小，则表明存在**[异方差性](@entry_id:895761)（heteroscedasticity）**。例如，当[误差方差](@entry_id:636041)与均值成正比时（$\operatorname{Var}(\epsilon_i) \propto \mu_i$），图中就会出现一个开口向右的喇叭形 。

对于异方差问题，一种解决方法是在建模前对响应变量进行**[方差稳定变换](@entry_id:273381)**。例如，对于具有泊松分布特征的数据（方差约等于均值），平方根变换 $y' = \sqrt{y}$ 可以有效稳定方差。对变换后的[数据建模](@entry_id:141456)，其尺度-位置图会变得更平坦 。

#### 评估正态性：[分位数-分位数图](@entry_id:905113) ([QQ图](@entry_id:905113))

**[QQ图](@entry_id:905113)（Quantile-Quantile plot）**用于检验残差是否来自一个特定的理论分布，通常是正态分布。其构建方式是：
1.  [计算模型](@entry_id:637456)的[标准化残差](@entry_id:634169)（如[内部标准化](@entry_id:181400)残差或[学生化残差](@entry_id:636292)），并将其从小到大排序，得到样本的[顺序统计量](@entry_id:266649) $r_{(1)} \le r_{(2)} \le \dots \le r_{(n)}$。这些值构成了[QQ图](@entry_id:905113)的纵坐标。
2.  计算来自[标准正态分布](@entry_id:184509) $N(0,1)$ 的大小为 $n$ 的样本的**期望[顺序统计量](@entry_id:266649)** $\mathbb{E}[Z_{(i)}]$。这些值构成了[QQ图](@entry_id:905113)的横坐标。

从第一性原理出发，第 $i$ 个标准正态[顺序统计量](@entry_id:266649)的[期望值](@entry_id:150961)的精确表达式为 ：

$\mathbb{E}[Z_{(i)}] = \int_{0}^{1} \Phi^{-1}(u) \frac{n!}{(i-1)!(n-i)!} u^{i-1} (1-u)^{n-i} du$

其中 $\Phi^{-1}(u)$ 是标准正态[分位数函数](@entry_id:271351)。该积分是 $\Phi^{-1}(U)$ 的期望，其中 $U$ 服从参数为 $\alpha=i$ 和 $\beta=n-i+1$ 的Beta分布。

如果残差确实来自正态分布，那么[QQ图](@entry_id:905113)上的点将近似地落在 $y=x$ 这条直线上。系统性地偏离这条直线则表明正态性假定不成立：
- **[S形曲线](@entry_id:167614)**：表明分布的**[偏度](@entry_id:178163)（skewness）**与正态分布不同。
- **两端偏离直线**：表明分布的**[峰度](@entry_id:269963)（kurtosis）**与正态分布不同，例如“重尾”（heavy tails）或“轻尾”（light tails）。

### 扩展到高级模型

[残差分析](@entry_id:191495)的原理可以扩展到更复杂的模型框架，这对于[生物医学建模](@entry_id:1121638)尤为重要。

#### [广义线性模型 (GLM)](@entry_id:893670) 中的残差

在GLM中，响应变量的方差不再是常数，而是其均值的函数，即 $\operatorname{Var}(Y_i) = \phi V(\mu_i)$，其中 $\phi$ 是**离散参数（dispersion parameter）**，$V(\cdot)$ 是**方差函数**。原始残差 $y_i - \hat{\mu}_i$ 的方差会随均值变化，因此需要进行[标准化](@entry_id:637219)。

**[皮尔逊残差](@entry_id:923231)（Pearson residual）**定义为：

$r_i^P = \frac{y_i - \hat{\mu}_i}{\sqrt{V(\hat{\mu}_i)}}$

这个定义通过响应变量的方差函数（假设 $\phi=1$）来[标准化](@entry_id:637219)原始残差。[皮尔逊残差](@entry_id:923231)的[平方和](@entry_id:161049)构成了**[皮尔逊卡方统计量](@entry_id:922291)** $Q = \sum_{i=1}^{n}(r_i^P)^2$。这个统计量的期望近似为 $E(Q) \approx \phi(n-p)$。这提供了一个估计离散参数 $\phi$ 的方法：

$\hat{\phi}_P = \frac{Q}{n-p}$

这个估计量在诊断中至关重要。例如，在对感染病例数进行泊松回归时，理论上 $V(\mu) = \mu$ 且 $\phi=1$。如果计算出的 $\hat{\phi}_P$ 远大于1，则表明存在**[过度离散](@entry_id:263748)（overdispersion）**，即数据的变异性比[泊松模型](@entry_id:1129884)预期的要大，这在生物医学计数数据中非常常见。此时，可能需要使用类泊松模型或[负二项模型](@entry_id:918790)。反之，$\hat{\phi}_P  1$ 则表示**低度离散（underdispersion）** 。

#### [非线性混合效应模型 (NLMEM)](@entry_id:911974) 中的残差

在药代动力学等纵向数据研究中，NLMEMs被广泛使用。模型形式通常为 $y_{ij} = f(t_{ij}, \boldsymbol{\psi}_i, \mathbf{x}_{ij}) + \epsilon_{ij}$，其中 $y_{ij}$ 是个体 $i$ 在时间 $j$ 的观测值，$\boldsymbol{\psi}_i$ 是个体特有的[随机效应](@entry_id:915431)参数。这种模型有两个层次的变异：由 $\boldsymbol{\psi}_i$ 的分布描述的**[个体间变异](@entry_id:893196)**，以及由 $\epsilon_{ij}$ 描述的**个体内变异**（测量误差）。[残差分析](@entry_id:191495)也相应地分为两个层次 。

- **条件（个体内）残差 (Conditional Residuals)**：
$r^{\text{cond}}_{ij} = y_{ij} - f(t_{ij}, \hat{\boldsymbol{\psi}}_i, \mathbf{x}_{ij})$
这里的 $\hat{\boldsymbol{\psi}}_i$ 是个体[随机效应](@entry_id:915431)的[经验贝叶斯](@entry_id:171034)估计（Empirical Bayes Estimates, EBEs）。条件残差反映了在给定个体参数后，模型预测与实际观测的差异，因此它主要估计的是测量误差 $\epsilon_{ij}$。如果模型设定正确，条件残差应该在零附近随机波动，并且不应与任何预测变量或估计的[随机效应](@entry_id:915431) $\hat{\boldsymbol{\psi}}_i$ 表现出系统性趋势。绘制条件残差对 $\hat{\boldsymbol{\psi}}_i$ 的图是诊断[随机效应模型](@entry_id:914467)是否设定错误（例如，[随机效应](@entry_id:915431)的分布假定或方差结构错误）的有力工具 。

- **边际（群体）残差 (Marginal Residuals)**：
$r^{\text{marg}}_{ij} = y_{ij} - \mathbb{E}[y_{ij}]$
这里的 $\mathbb{E}[y_{ij}]$ 是通过对[随机效应](@entry_id:915431)的群体分布进行积分得到的群体平均预测。边际残差混合了个体内变异和[个体间变异](@entry_id:893196)（即个体真实轨迹与群体平均轨迹的差异）。由于[个体间变异](@entry_id:893196)通常远大于个体内变异，它可能会掩盖模型中更细微的设定错误。因此，边际残差对于诊断随机效应部分的具体问题通常不如条件残差敏感 。

总之，[残差分析](@entry_id:191495)是一套强大而灵活的工具，它不仅能告诉我们模型是否拟合良好，还能揭示模型在哪些方面存在不足，并为如何改进模型提供方向。从OLS到GLM再到NLMEM，理解不同类型残差的定义、性质及其在图形诊断中的应用，是任何严谨的[生物医学系统建模](@entry_id:1121641)者必备的技能。