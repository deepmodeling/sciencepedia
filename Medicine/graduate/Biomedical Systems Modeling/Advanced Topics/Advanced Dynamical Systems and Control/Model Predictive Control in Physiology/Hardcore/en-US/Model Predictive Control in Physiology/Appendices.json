{
    "hands_on_practices": [
        {
            "introduction": "The foundation of Model Predictive Control is the 'model' itself. Before we can predict or control a physiological system, we must capture its dynamics in a mathematical form suitable for a digital controller. This first practice  guides you through the fundamental process of deriving a state-space model from physiological first principles and then discretizing it. You will compare a simple approximation with an exact method, revealing critical insights into the stability and accuracy trade-offs that are paramount in designing reliable prediction engines for MPC.",
            "id": "3902953",
            "problem": "A two-compartment pharmacokinetic model describes drug amounts in a central compartment and a peripheral compartment, denoted by $x_{1}(t)$ and $x_{2}(t)$, respectively. Drug leaves the central compartment by elimination with first-order rate constant $k_{10} \\gt 0$, exchanges from central to peripheral with first-order rate constant $k_{12} \\gt 0$, and returns from peripheral to central with first-order rate constant $k_{21} \\gt 0$. An intravenous infusion input $u(t)$ (drug amount per unit time) enters the central compartment. Assume well-mixed compartments and linear first-order kinetics.\n\nStarting from mass balance (conservation of mass) and the definition of first-order flows, perform the following:\n\na) Derive the continuous-time linear time-invariant state-space model $\\dot{x}(t) = A_{c} x(t) + B_{c} u(t)$ with $x(t) = \\begin{pmatrix} x_{1}(t) \\\\ x_{2}(t) \\end{pmatrix}$. Identify $A_{c}$ and $B_{c}$ explicitly in terms of $k_{10}$, $k_{12}$, and $k_{21}$.\n\nb) Using the definition of the forward Euler method as a first-order approximation to the derivative, derive the forward Euler discretization under a constant sampling period $h \\gt 0$ with a zero-order hold on the input $u(t)$ over each sampling interval. That is, derive matrices $A_{d}^{\\mathrm{E}}(h)$ and $B_{d}^{\\mathrm{E}}(h)$ such that $x_{k+1} = A_{d}^{\\mathrm{E}}(h) x_{k} + B_{d}^{\\mathrm{E}}(h) u_{k}$.\n\nc) Starting from the exact solution of linear time-invariant systems and the definition of the matrix exponential, derive the exact zero-order-hold discretization $x_{k+1} = A_{d}^{\\mathrm{X}}(h) x_{k} + B_{d}^{\\mathrm{X}}(h) u_{k}$ with\n$A_{d}^{\\mathrm{X}}(h) = \\exp(A_{c} h)$ and $B_{d}^{\\mathrm{X}}(h)$ given as an integral involving $\\exp(A_{c} \\tau)$ and $B_{c}$. Express $B_{d}^{\\mathrm{X}}(h)$ in closed form in terms of $A_{c}$, $B_{c}$, and $h$.\n\nd) For model predictive control (MPC) design, closed-loop prediction models should be Schur stable to avoid numerical and conceptual difficulties. Using eigenvalue-based reasoning, derive the necessary and sufficient stability condition on $h$ for the forward Euler discretization obtained in part b), given that $k_{10}$, $k_{12}$, and $k_{21}$ are strictly positive. Then, simplify this condition to a single closed-form expression for the maximum admissible sampling period $h_{\\max}$ as a function of $k_{10}$, $k_{12}$, and $k_{21}$ that guarantees Schur stability of the forward Euler discretization for the open-loop pharmacokinetic dynamics.\n\ne) Briefly compare the stability and prediction accuracy trade-offs between the forward Euler and exact discretizations for MPC design in this setting, highlighting how the choice of $h$ interacts with these trade-offs.\n\nProvide, as your final answer, only the closed-form symbolic expression for $h_{\\max}$ from part d). Do not substitute numerical values, and no units are required for the final expression.",
            "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in pharmacokinetic modeling, well-posed with sufficient information, and objective in its formulation. The tasks are standard derivations in linear systems theory and control.\n\na) Derivation of the continuous-time state-space model.\n\nThe state variables are $x_{1}(t)$, the drug amount in the central compartment, and $x_{2}(t)$, the drug amount in the peripheral compartment. We apply the principle of mass balance to each compartment.\n\nFor the central compartment, the rate of change of the drug amount, $\\dot{x}_{1}(t)$, is the sum of all influx rates minus the sum of all efflux rates.\nInflux rates are the intravenous infusion $u(t)$ and the return from the peripheral compartment, $k_{21}x_{2}(t)$.\nEfflux rates are the elimination from the body, $k_{10}x_{1}(t)$, and the transfer to the peripheral compartment, $k_{12}x_{1}(t)$.\nThe mass balance equation for the central compartment is therefore:\n$$\n\\frac{dx_{1}(t)}{dt} = \\dot{x}_{1}(t) = u(t) + k_{21}x_{2}(t) - k_{10}x_{1}(t) - k_{12}x_{1}(t)\n$$\nRearranging terms, we get:\n$$\n\\dot{x}_{1}(t) = -(k_{10} + k_{12})x_{1}(t) + k_{21}x_{2}(t) + u(t)\n$$\n\nFor the peripheral compartment, the rate of change $\\dot{x}_{2}(t)$ is similarly determined.\nThe only influx is from the central compartment, with a rate of $k_{12}x_{1}(t)$.\nThe only efflux is the return to the central compartment, with a rate of $k_{21}x_{2}(t)$.\nThe mass balance equation for the peripheral compartment is:\n$$\n\\frac{dx_{2}(t)}{dt} = \\dot{x}_{2}(t) = k_{12}x_{1}(t) - k_{21}x_{2}(t)\n$$\n\nWe can write these two coupled first-order linear differential equations in the state-space form $\\dot{x}(t) = A_{c} x(t) + B_{c} u(t)$ where $x(t) = \\begin{pmatrix} x_{1}(t) \\\\ x_{2}(t) \\end{pmatrix}$:\n$$\n\\begin{pmatrix} \\dot{x}_{1}(t) \\\\ \\dot{x}_{2}(t) \\end{pmatrix} = \\begin{pmatrix} -(k_{10} + k_{12}) & k_{21} \\\\ k_{12} & -k_{21} \\end{pmatrix} \\begin{pmatrix} x_{1}(t) \\\\ x_{2}(t) \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} u(t)\n$$\nBy comparing this to the general form, we identify the matrices $A_{c}$ and $B_{c}$ as:\n$$\nA_{c} = \\begin{pmatrix} -(k_{10} + k_{12}) & k_{21} \\\\ k_{12} & -k_{21} \\end{pmatrix}, \\quad B_{c} = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}\n$$\n\nb) Derivation of the forward Euler discretization.\n\nThe forward Euler method approximates the derivative $\\dot{x}(t)$ at time $t_{k} = k h$ as $\\dot{x}(t_{k}) \\approx \\frac{x(t_{k+1}) - x(t_{k})}{h}$, where $h$ is the sampling period. Let $x_{k} \\equiv x(t_{k})$. Under a zero-order hold, the input $u(t)$ is assumed to be constant over the interval $[t_{k}, t_{k+1})$, i.e., $u(t) = u_{k}$.\nSubstituting the approximation into the continuous-time model at $t=t_k$:\n$$\n\\frac{x_{k+1} - x_{k}}{h} = A_{c} x_{k} + B_{c} u_{k}\n$$\nMultiplying by $h$ and rearranging to solve for $x_{k+1}$:\n$$\nx_{k+1} - x_{k} = h A_{c} x_{k} + h B_{c} u_{k}\n$$\n$$\nx_{k+1} = x_{k} + h A_{c} x_{k} + h B_{c} u_{k} = (I + h A_{c}) x_{k} + (h B_{c}) u_{k}\n$$\nThis is in the form $x_{k+1} = A_{d}^{\\mathrm{E}}(h) x_{k} + B_{d}^{\\mathrm{E}}(h) u_{k}$. The matrices are:\n$$\nA_{d}^{\\mathrm{E}}(h) = I + h A_{c} = \\begin{pmatrix} 1 & 0 \\\\ 0 & 1 \\end{pmatrix} + h \\begin{pmatrix} -(k_{10} + k_{12}) & k_{21} \\\\ k_{12} & -k_{21} \\end{pmatrix} = \\begin{pmatrix} 1 - h(k_{10} + k_{12}) & h k_{21} \\\\ h k_{12} & 1 - h k_{21} \\end{pmatrix}\n$$\n$$\nB_{d}^{\\mathrm{E}}(h) = h B_{c} = h \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} h \\\\ 0 \\end{pmatrix}\n$$\n\nc) Derivation of the exact zero-order-hold discretization.\n\nThe exact solution of the linear time-invariant system $\\dot{x}(t) = A_c x(t) + B_c u(t)$ from time $t_k$ to $t_{k+1} = t_k+h$, with a constant input $u(t)=u_k$ for $t \\in [t_k, t_{k+1})$, is given by the variation of constants formula:\n$$\nx(t_{k+1}) = \\exp(A_{c} h) x(t_{k}) + \\left( \\int_{t_{k}}^{t_{k+1}} \\exp(A_{c}(t_{k+1}-\\tau)) B_{c} d\\tau \\right) u_{k}\n$$\nUsing the notation $x_k = x(t_k)$, we can identify $A_{d}^{\\mathrm{X}}(h) = \\exp(A_c h)$. The input matrix $B_{d}^{\\mathrm{X}}(h)$ is the integral term:\n$$\nB_{d}^{\\mathrm{X}}(h) = \\left( \\int_{0}^{h} \\exp(A_{c}s) ds \\right) B_{c}\n$$\nwhere we have made the substitution $s = t_{k+1}-\\tau$. To evaluate this integral in closed form, we can use the property that $\\frac{d}{ds} (A_c^{-1}\\exp(A_c s)) = \\exp(A_c s)$, provided that $A_c$ is invertible. Let's check the determinant of $A_c$:\n$$\n\\det(A_{c}) = (-(k_{10} + k_{12}))(-k_{21}) - (k_{21})(k_{12}) = k_{10}k_{21} + k_{12}k_{21} - k_{12}k_{21} = k_{10}k_{21}\n$$\nSince $k_{10} > 0$ and $k_{21} > 0$ are given, $\\det(A_{c}) > 0$, so $A_c$ is invertible. We can now evaluate the integral:\n$$\n\\int_{0}^{h} \\exp(A_{c}s) ds = \\left[ A_{c}^{-1} \\exp(A_{c}s) \\right]_{0}^{h} = A_{c}^{-1} (\\exp(A_{c}h) - \\exp(A_{c} \\cdot 0)) = A_{c}^{-1}(\\exp(A_{c}h) - I)\n$$\nSubstituting this back, we get the closed form for $B_{d}^{\\mathrm{X}}(h)$:\n$$\nB_{d}^{\\mathrm{X}}(h) = A_{c}^{-1}(\\exp(A_{c}h) - I) B_{c}\n$$\n\nd) Stability condition for the forward Euler discretization.\n\nA discrete-time linear system is Schur stable if and only if all eigenvalues of its state matrix have a magnitude less than $1$. For the forward Euler discretization, the state matrix is $A_{d}^{\\mathrm{E}}(h) = I + h A_{c}$.\nIf $\\lambda_i(A_c)$ is an eigenvalue of $A_c$, then the corresponding eigenvalue of $A_{d}^{\\mathrm{E}}(h)$ is $\\lambda_i(A_{d}^{\\mathrm{E}}) = 1 + h \\lambda_i(A_c)$. The stability condition is $|\\lambda_i(A_{d}^{\\mathrm{E}})| < 1$ for all $i$.\n$$|1 + h \\lambda_i(A_c)| < 1$$\nFirst, let's find the eigenvalues of $A_c$. The characteristic equation is $\\det(A_c - \\lambda I) = 0$:\n$$\n\\lambda^2 - \\mathrm{tr}(A_c)\\lambda + \\det(A_c) = 0\n$$\n$$\n\\lambda^2 - (-(k_{10} + k_{12}) - k_{21})\\lambda + (k_{10}k_{21}) = 0\n$$\n$$\n\\lambda^2 + (k_{10} + k_{12} + k_{21})\\lambda + k_{10}k_{21} = 0\n$$\nThe product of the roots is $\\lambda_1\\lambda_2 = k_{10}k_{21} > 0$, and the sum is $\\lambda_1+\\lambda_2 = -(k_{10}+k_{12}+k_{21}) < 0$. Since the product is positive and sum is negative, both eigenvalues $\\lambda_1, \\lambda_2$ must be real and negative.\nLet $\\lambda_c$ be a real, negative eigenvalue of $A_c$. The stability condition becomes:\n$$\n|1 + h \\lambda_c| < 1 \\implies -1 < 1 + h \\lambda_c < 1\n$$\nThe right inequality, $1 + h \\lambda_c < 1 \\implies h \\lambda_c < 0$, is always true since $h>0$ and $\\lambda_c < 0$.\nThe left inequality, $-1 < 1 + h \\lambda_c \\implies -2 < h \\lambda_c \\implies h > \\frac{-2}{\\lambda_c}$. Since $\\lambda_c$ is negative, this is equivalent to $h < \\frac{2}{-\\lambda_c} = \\frac{2}{|\\lambda_c|}$.\nThis condition must hold for both eigenvalues. Therefore, $h$ must be smaller than the minimum of these bounds:\n$$\nh < \\min\\left(\\frac{2}{|\\lambda_1|}, \\frac{2}{|\\lambda_2|}\\right) = \\frac{2}{\\max(|\\lambda_1|, |\\lambda_2|)}\n$$\nThe maximum admissible sampling period is $h_{\\max} = \\frac{2}{\\max_{i}|\\lambda_i(A_c)|}$. The eigenvalues are the roots of the characteristic polynomial:\n$$\n\\lambda = \\frac{-(k_{10} + k_{12} + k_{21}) \\pm \\sqrt{(k_{10} + k_{12} + k_{21})^2 - 4k_{10}k_{21}}}{2}\n$$\nThe eigenvalue with the largest magnitude is the one with the negative sign before the square root in the numerator, as both terms in the numerator are negative.\n$$\n\\max_{i}|\\lambda_i(A_c)| = \\left| \\frac{-(k_{10} + k_{12} + k_{21}) - \\sqrt{(k_{10} + k_{12} + k_{21})^2 - 4k_{10}k_{21}}}{2} \\right|\n$$\n$$\n\\max_{i}|\\lambda_i(A_c)| = \\frac{(k_{10} + k_{12} + k_{21}) + \\sqrt{(k_{10} + k_{12} + k_{21})^2 - 4k_{10}k_{21}}}{2}\n$$\nThus, the maximum admissible sampling period is:\n$$\nh_{\\max} = \\frac{4}{(k_{10} + k_{12} + k_{21}) + \\sqrt{(k_{10} + k_{12} + k_{21})^2 - 4k_{10}k_{21}}}\n$$\n\ne) Comparison of discretization methods for MPC.\n\nFor model predictive control (MPC), a prediction model is used to forecast the system's future evolution. The choice of discretization method profoundly impacts the controller's performance and feasibility.\n\nForward Euler (FE) Discretization:\n- **Stability**: The FE-discretized model is only conditionally stable. The sampling period $h$ must be strictly less than $h_{\\max}$ derived in part d). This imposes a hard constraint on the controller design. If system parameters ($k_{ij}$) change, $h_{\\max}$ may decrease, and a previously stable controller could become unstable.\n- **Accuracy**: FE is a first-order approximation. Its prediction accuracy is poor, especially over the long prediction horizons typical in MPC, unless $h$ is chosen to be very small. This model mismatch can lead to suboptimal or even unstable closed-loop behavior.\n- **Trade-off**: The primary advantage is simplicity. However, the need for a small $h$ for both stability and accuracy leads to a large number of steps in the prediction horizon, increasing the computational burden of the MPC optimization problem.\n\nExact Zero-Order-Hold (ZOH) Discretization:\n- **Stability**: The exact ZOH discretization of a stable continuous-time system is always stable for any sampling period $h > 0$. This is because the mapping $\\lambda_d = \\exp(\\lambda_c h)$ maps the stable left-half plane of continuous eigenvalues to the stable interior of the unit circle for discrete eigenvalues. This removes the stability constraint on the choice of $h$.\n- **Accuracy**: As the name implies, it is \"exact\" for systems with piecewise-constant inputs. It provides a highly accurate prediction of the system's state at sampling instants, minimizing model mismatch due to discretization. This accuracy is crucial for the performance of MPC.\n- **Trade-off**: The calculation of the matrix exponential can be more computationally intensive than the simple algebra of FE. However, this is a one-time, offline computation for a given $h$. The key benefit is that $h$ can be chosen based on control objectives (e.g., response speed, disturbance rejection) rather than numerical stability. This often allows for a larger $h$ than with FE, which reduces the dimension of the MPC optimization problem and thus the real-time computational load.\n\nIn summary, for MPC design in this pharmacokinetic application, the exact ZOH discretization is vastly superior. It guarantees model stability and high prediction accuracy, granting the designer the freedom to select a sampling period $h$ that optimally balances control performance and computational cost, without being constrained by the numerical stability issues inherent to the forward Euler method.",
            "answer": "$$\n\\boxed{\\frac{4}{(k_{10} + k_{12} + k_{21}) + \\sqrt{(k_{10} + k_{12} + k_{21})^{2} - 4 k_{10} k_{21}}}}\n$$"
        },
        {
            "introduction": "With a predictive model in hand, the next step is to encode the clinical objectives and safety limits into the controller's logic. This practice  focuses on translating real-world clinical goals for anesthesia—such as maintaining a specific depth of sedation and preventing dangerous drops in blood pressure—into a set of mathematical constraints. You will also tackle the challenge of model uncertainty by calculating a 'robust tightening' parameter, a key technique to ensure safety specifications are met even when the patient's response deviates from the nominal model.",
            "id": "3902931",
            "problem": "A clinician is configuring Model Predictive Control (MPC) for propofol infusion during general anesthesia. The controller will operate with a sampling period of $T_s = 1$ minute and must satisfy clinical safety and efficacy constraints. The pharmacokinetic-pharmacodynamic model used for prediction is the following discrete-time linear effect-site model and output relationships:\n- Effect-site dynamics: $c_e(k+1) = a\\,c_e(k) + b\\,u(k)$ with $a = 0.8$ and $b = 0.1$, where $c_e(k)$ is an effect-site proxy and $u(k)$ is the propofol infusion rate in $\\mathrm{mg\\,min^{-1}}$.\n- Bispectral Index Score (BIS) output: $y_B(k) = 90 - \\alpha_B\\,c_e(k)$ with nominal sensitivity $\\alpha_B = 10$ (BIS units per effect-site unit).\n- Mean Arterial Pressure (MAP) output: $y_M(k) = y_{M,\\mathrm{base}} - \\alpha_M\\,c_e(k)$ with $y_{M,\\mathrm{base}} = 85$ $\\mathrm{mmHg}$ and $\\alpha_M = 3$ $\\mathrm{mmHg}$ per effect-site unit.\n\nThe controller must enforce:\n- Infusion limits: $0 \\le u(k) \\le 10$ $\\mathrm{mg\\,min^{-1}}$ from pump capability and safe dosing range for adults.\n- BIS target range: $40 \\le y_B(k) \\le 60$ to maintain appropriate hypnotic depth during general anesthesia in adults.\n- Maximum allowed blood pressure drop: $y_M(k) \\ge 65$ $\\mathrm{mmHg}$, equivalent to limiting the drop from baseline by at most $20$ $\\mathrm{mmHg}$, to avoid hypotension-related risks.\n\nTo ensure robust satisfaction of BIS constraints under bounded uncertainties, use the following uncertainty model:\n- Measurement noise on BIS is bounded by $|\\eta_B(k)| \\le \\bar{\\eta}_B$ with $\\bar{\\eta}_B = 1$ (BIS unit).\n- Unmodeled additive BIS disturbance is bounded by $|\\delta_B(k)| \\le \\bar{\\delta}_B$ with $\\bar{\\delta}_B = 1$ (BIS unit).\n- Sensitivity parameter uncertainty is bounded as $\\alpha_B \\in [(1-\\bar{\\rho}_B)\\alpha_B,(1+\\bar{\\rho}_B)\\alpha_B]$ with $\\bar{\\rho}_B = 0.05$.\n\nConstruct a constraint set for MPC that encodes the infusion limits, BIS target range, and MAP drop constraint using the nominal model outputs $y_B(k)$ and $y_M(k)$, and apply symmetric robust tightening to the BIS constraints by subtracting a tightening parameter $\\tau_B$ from the upper bound and adding $\\tau_B$ to the lower bound. Justify each bound using physiological considerations and the given model. Then, compute the minimal symmetric tightening parameter $\\tau_B$ that guarantees the BIS constraints hold for all uncertainties satisfying the bounds given above, assuming worst-case $c_e(k)$ consistent with the model and infusion limits over constant inputs. Round your answer to four significant figures. Express the final answer in BIS units.",
            "solution": "The user has provided a problem statement regarding the configuration of a Model Predictive Controller (MPC) for propofol infusion. The first step is to validate the problem statement.\n\n### Step 1: Extract Givens\n-   **System Model and Parameters**:\n    -   Discrete-time state-space model: $c_e(k+1) = a\\,c_e(k) + b\\,u(k)$\n    -   State update parameter: $a = 0.8$\n    -   Input gain: $b = 0.1$\n    -   Sampling period: $T_s = 1$ minute\n    -   State variable: $c_e(k)$, effect-site proxy\n    -   Input variable: $u(k)$, propofol infusion rate in $\\mathrm{mg\\,min^{-1}}$\n    -   BIS output model: $y_B(k) = 90 - \\alpha_B\\,c_e(k)$\n    -   Nominal BIS sensitivity: $\\alpha_B = 10$\n    -   MAP output model: $y_M(k) = y_{M,\\mathrm{base}} - \\alpha_M\\,c_e(k)$\n    -   Baseline MAP: $y_{M,\\mathrm{base}} = 85$ $\\mathrm{mmHg}$\n    -   MAP sensitivity: $\\alpha_M = 3$ $\\mathrm{mmHg}$ per effect-site unit\n\n-   **Constraints**:\n    -   Input constraint: $0 \\le u(k) \\le 10$ $\\mathrm{mg\\,min^{-1}}$\n    -   BIS target range: $40 \\le y_B(k) \\le 60$\n    -   MAP safety constraint: $y_M(k) \\ge 65$ $\\mathrm{mmHg}$\n\n-   **Uncertainty Model**:\n    -   BIS measurement noise bound: $|\\eta_B(k)| \\le \\bar{\\eta}_B$ with $\\bar{\\eta}_B = 1$\n    -   Additive BIS disturbance bound: $|\\delta_B(k)| \\le \\bar{\\delta}_B$ with $\\bar{\\delta}_B = 1$\n    -   BIS sensitivity uncertainty: $\\alpha_B \\in [(1-\\bar{\\rho}_B)\\alpha_B,(1+\\bar{\\rho}_B)\\alpha_B]$ with $\\bar{\\rho}_B = 0.05$\n\n-   **Task**:\n    1.  Construct the MPC constraint set.\n    2.  Apply symmetric robust tightening to the BIS constraints: $40 + \\tau_B \\le \\text{nominal } y_B(k) \\le 60 - \\tau_B$.\n    3.  Compute the minimal symmetric tightening parameter $\\tau_B$ that guarantees the actual BIS constraints hold under all specified uncertainties.\n    4.  Assume worst-case $c_e(k)$ consistent with model and input limits.\n    5.  Round the final answer to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded in established principles of pharmacokinetic-pharmacodynamic modeling and robust control theory as applied to clinical anesthesia. The model is a standard simplified representation, and the parameters and constraints ($e.g.$, BIS target of $40$ to $60$, MAP floor of $65$ mmHg, propofol infusion rates) are physiologically and clinically realistic. The problem is well-posed, objective, and self-contained, providing all necessary information to compute the requested tightening parameter. It does not violate any fundamental principles and is free of ambiguity or contradiction.\n\n### Verdict and Action\nThe problem is valid. A complete, reasoned solution will be provided.\n\n### Solution Derivation\nThe primary task is to compute the robust constraint tightening parameter $\\tau_B$. This requires defining the MPC constraint set, formalizing the effect of uncertainty, and calculating the worst-case deviation between the nominal model prediction and the actual system output.\n\nFirst, we construct the constraint set for the MPC based on the nominal model. The controller will enforce these constraints over a prediction horizon. For any time step $k$ in the horizon:\n\n1.  **Infusion limit**: $0 \\le u(k) \\le 10$. This is a direct constraint on the manipulated variable.\n\n2.  **MAP constraint**: $y_M(k) \\ge 65$. This is an output constraint that can be translated into a state constraint using the nominal MAP model:\n    $$y_{M,\\mathrm{base}} - \\alpha_M\\,c_e(k) \\ge 65$$\n    $$85 - 3\\,c_e(k) \\ge 65$$\n    $$20 \\ge 3\\,c_e(k) \\implies c_e(k) \\le \\frac{20}{3}$$\n\n3.  **Robust BIS constraint**: The clinical goal is for the true BIS level to be within the range $[40, 60]$. To ensure this despite uncertainties, the MPC will enforce a tightened constraint on the nominal BIS output, $y_B(k)$:\n    $$40 + \\tau_B \\le y_B(k) \\le 60 - \\tau_B$$\n    This is translated into state constraints:\n    $$40 + \\tau_B \\le 90 - \\alpha_B\\,c_e(k) \\le 60 - \\tau_B$$\n    This gives a lower and an upper bound on the state $c_e(k)$:\n    -   $90 - \\alpha_B\\,c_e(k) \\ge 40 + \\tau_B \\implies 50 - \\tau_B \\ge \\alpha_B\\,c_e(k) \\implies c_e(k) \\le \\frac{50 - \\tau_B}{10}$\n    -   $90 - \\alpha_B\\,c_e(k) \\le 60 - \\tau_B \\implies 30 + \\tau_B \\le \\alpha_B\\,c_e(k) \\implies c_e(k) \\ge \\frac{30 + \\tau_B}{10}$\n\nThe parameter $\\tau_B$ must be large enough to accommodate the worst-case deviation between the actual, measured BIS value and the nominal model's prediction. Let the actual measured BIS be $\\hat{y}_B(k)$. This value includes parameter uncertainty, unmodeled disturbances, and measurement noise. Let the true (uncertain) sensitivity be $\\tilde{\\alpha}_B$.\n$$\\hat{y}_B(k) = (90 - \\tilde{\\alpha}_B\\,c_e(k)) + \\delta_B(k) + \\eta_B(k)$$\nThe nominal BIS prediction is $y_B(k) = 90 - \\alpha_B\\,c_e(k)$.\n\nThe total error, $E(k)$, between the measured and nominal values is:\n$$E(k) = \\hat{y}_B(k) - y_B(k) = \\left( (90 - \\tilde{\\alpha}_B\\,c_e(k)) + \\delta_B(k) + \\eta_B(k) \\right) - (90 - \\alpha_B\\,c_e(k))$$\n$$E(k) = (\\alpha_B - \\tilde{\\alpha}_B)\\,c_e(k) + \\delta_B(k) + \\eta_B(k)$$\n\nFor the robust constraints to be effective, the tightening $\\tau_B$ must be at least as large as the maximum possible magnitude of this error, $|E(k)|$. Using the triangle inequality, we can bound the error:\n$$|E(k)| \\le |(\\alpha_B - \\tilde{\\alpha}_B)\\,c_e(k)| + |\\delta_B(k)| + |\\eta_B(k)|$$\n\nThe minimal tightening $\\tau_B$ is the maximum value of this upper bound:\n$$\\tau_B = \\max |E(k)| = \\max |(\\alpha_B - \\tilde{\\alpha}_B)\\,c_e(k)| + \\max |\\delta_B(k)| + \\max |\\eta_B(k)|$$\n\nWe can evaluate each term using the given uncertainty bounds:\n1.  $\\max |\\delta_B(k)| = \\bar{\\delta}_B = 1$\n2.  $\\max |\\eta_B(k)| = \\bar{\\eta}_B = 1$\n3.  $\\max |(\\alpha_B - \\tilde{\\alpha}_B)\\,c_e(k)| = \\max|\\alpha_B - \\tilde{\\alpha}_B| \\times \\max c_e(k)$. Note that $c_e(k)$, representing a concentration, is non-negative.\n\nThe uncertainty in sensitivity is given by $\\tilde{\\alpha}_B \\in [\\alpha_B(1-\\bar{\\rho}_B), \\alpha_B(1+\\bar{\\rho}_B)]$.\nThis means the maximum deviation $|\\alpha_B - \\tilde{\\alpha}_B|$ is $\\bar{\\rho}_B \\alpha_B$.\n$$\\max |\\alpha_B - \\tilde{\\alpha}_B| = \\bar{\\rho}_B \\alpha_B = 0.05 \\times 10 = 0.5$$\n\nNext, we must determine the worst-case value of $c_e(k)$, denoted $\\max c_e(k)$. The state dynamics are given by $c_e(k+1) = 0.8\\,c_e(k) + 0.1\\,u(k)$. This is a stable first-order linear system since the pole $a=0.8$ has a magnitude less than $1$. The input is bounded, $u(k) \\in [0, 10]$. For such a system, assuming it starts from a physically realistic initial condition like $c_e(0)=0$, the state $c_e(k)$ will be bounded by the maximum possible steady-state value.\n\nThe steady-state concentration $c_{e,ss}$ for a constant input $u$ is found by setting $c_e(k+1) = c_e(k) = c_{e,ss}$:\n$$c_{e,ss} = a\\,c_{e,ss} + b\\,u \\implies c_{e,ss} = \\frac{b}{1-a} u$$\nThe maximum steady-state value occurs at the maximum constant input, $u_{max} = 10$:\n$$\\max c_e(k) = \\frac{b}{1-a} u_{max} = \\frac{0.1}{1-0.8} \\times 10 = \\frac{0.1}{0.2} \\times 10 = 0.5 \\times 10 = 5$$\nThis value is consistent with the nominal operational constraints, as the target BIS range $40 \\le y_B(k) \\le 60$ corresponds to a nominal state range $3 \\le c_e(k) \\le 5$. Thus, the maximum concentration that needs to be considered for the worst-case error calculation is $\\max c_e(k) = 5$.\n\nNow, we can assemble the components to calculate $\\tau_B$:\n$$\\tau_B = (\\bar{\\rho}_B \\alpha_B) \\times (\\max c_e(k)) + \\bar{\\delta}_B + \\bar{\\eta}_B$$\nSubstituting the numerical values:\n$$\\tau_B = (0.5) \\times (5) + 1 + 1$$\n$$\\tau_B = 2.5 + 1 + 1 = 4.5$$\n\nThe problem asks for the answer to be rounded to four significant figures. The calculated value is $4.5$, which can be written as $4.500$.\nThe minimal symmetric tightening parameter is $\\tau_B = 4.500$ BIS units. This ensures that if the controller maintains the nominal BIS prediction $y_B(k)$ within the tightened range $[44.5, 55.5]$, the actual measured BIS $\\hat{y}_B(k)$ will remain within the desired clinical range of $[40, 60]$ despite the worst-case combination of parameter uncertainty, disturbances, and measurement noise.",
            "answer": "$$\\boxed{4.500}$$"
        },
        {
            "introduction": "This final practice  serves as a capstone, challenging you to integrate modeling, prediction, and constrained optimization into a complete, simulated MPC system for anesthesia control. You will implement a receding-horizon controller for a sophisticated nonlinear pharmacokinetic-pharmacodynamic model, guiding a virtual patient through induction and maintenance phases of anesthesia. This exercise provides a comprehensive, hands-on experience of the entire MPC loop in action, from solving the optimization problem at each step to analyzing the closed-loop performance.",
            "id": "3902960",
            "problem": "A dynamical system for propofol pharmacokinetics and pharmacodynamics is to be controlled using Model Predictive Control (MPC) for induction and maintenance of anesthesia. Starting from the principle of mass balance, the three-compartment pharmacokinetic model assumes one central compartment and two peripheral compartments, with an effect-site compartment capturing the delayed relationship between plasma concentration and clinical effect. The Bispectral Index (BIS) of the electroencephalogram is mapped from the effect-site concentration using a monotone pharmacodynamic function. The control input is an infusion rate that must be nonnegative and bounded, and the controller objective is to track a desired BIS setpoint while limiting aggressive changes in the infusion rate.\n\nFundamental base assumptions and definitions:\n\n- Mass balance applies to each compartment, with accumulation equal to inflow minus outflow.\n- The central compartment contains the drug introduced by infusion, with elimination and exchanges with peripheral compartments governed by first-order micro-rate constants.\n- The effect-site dynamics follow a first-order lag to the central compartment concentration.\n- The Bispectral Index (BIS) maps effect-site concentration to sedation using a sigmoidal model.\n\nModel structure and units:\n\n- States are the amounts $A_1$, $A_2$, $A_3$ in micrograms for central and two peripheral compartments, and the effect-site concentration $C_e$ in micrograms per milliliter.\n- The infusion input $u$ is in milligrams per minute. The mass inflow to the central compartment is $1000\\,u$ micrograms per minute.\n- Volumes $V_1$ are in liters; $1$ liter equals $1000$ milliliters.\n- Micro-rate constants $k_{10}$, $k_{12}$, $k_{21}$, $k_{13}$, $k_{31}$, and $k_{e0}$ are in inverse minutes.\n\nPharmacokinetic dynamics (three-compartment model, amounts in micrograms):\n$$\n\\frac{dA_1}{dt} = 1000\\,u - (k_{10} + k_{12} + k_{13})A_1 + k_{21}A_2 + k_{31}A_3,\n$$\n$$\n\\frac{dA_2}{dt} = k_{12}A_1 - k_{21}A_2,\n$$\n$$\n\\frac{dA_3}{dt} = k_{13}A_1 - k_{31}A_3.\n$$\n\nEffect-site dynamics (concentration in micrograms per milliliter):\n$$\n\\frac{dC_e}{dt} = k_{e0}\\left(\\frac{A_1}{1000\\,V_1} - C_e\\right).\n$$\n\nPharmacodynamic mapping from $C_e$ to Bispectral Index (BIS), with $BIS_0$ as baseline, $E_{\\max}$ as maximum effect, $C_{50}$ as the effect-site concentration producing half-maximal effect, and $\\gamma$ as the Hill exponent:\n$$\nBIS(C_e) = BIS_0 - E_{\\max}\\frac{C_e^\\gamma}{C_{50}^\\gamma + C_e^\\gamma}.\n$$\n\nDiscrete-time simulation:\n- Use forward Euler discretization with sampling time $T_s$ minutes. For any state $\\xi$, approximate $\\xi(t + T_s)$ by $\\xi(t) + T_s\\,\\dot{\\xi}(t)$.\n\nController objective and constraints:\n- Track a time-varying BIS setpoint $r(k)$ over a finite prediction horizon of $N$ steps.\n- Control input sequence $\\{u_k\\}_{k=0}^{N-1}$ must satisfy $0 \\le u_k \\le u_{\\max}$.\n- The cost function over the horizon is the sum of squared BIS tracking error and a penalty on infusion rate changes:\n$$\nJ = \\sum_{k=1}^{N} w_y\\left(BIS_k - r_k\\right)^2 + w_{\\Delta u}\\sum_{k=0}^{N-1}\\left(u_k - u_{k-1}\\right)^2,\n$$\nwhere $u_{-1}$ is the previously applied infusion rate at the current time, $w_y$ and $w_{\\Delta u}$ are nonnegative weights, and $BIS_k$ is the predicted BIS at step $k$ from the model.\n\nReceding-horizon MPC:\n- At each time step, solve for the optimal control sequence $\\{u_k\\}$ that minimizes $J$ subject to bounds.\n- Apply only the first element of the optimal sequence, advance the system by one sampling interval using the discretized dynamics, and repeat.\n\nInduction and maintenance phases:\n- Induction phase duration is $8$ minutes with BIS setpoint $r(k) = 50$ for all induction steps.\n- Maintenance phase duration is $17$ minutes with BIS setpoint $r(k) = 45$ for all maintenance steps.\n- Total simulation time is $25$ minutes.\n\nOvershoot definition:\n- Overshoot is defined for the induction phase as the positive quantity $50 - \\min(BIS(t))$ over induction times if $BIS(t)$ falls below $50$, otherwise $0$. Express the overshoot in BIS points as a float.\n\nParameter specification and test suite:\n- Sampling time $T_s = 0.25$ minutes, horizon length $N = 16$ steps, weights $w_y = 1.0$, $w_{\\Delta u} = 0.001$, input bound $u_{\\max} = 250$ milligrams per minute, $BIS_0 = 90$, $E_{\\max} = 60$, $\\gamma = 2.0$.\n\n- Test Case $1$ (typical adult):\n  - $V_1 = 4.0$ liters,\n  - $k_{10} = 0.5~\\text{min}^{-1}$, $k_{12} = 0.3~\\text{min}^{-1}$, $k_{21} = 0.2~\\text{min}^{-1}$, $k_{13} = 0.2~\\text{min}^{-1}$, $k_{31} = 0.05~\\text{min}^{-1}$,\n  - $k_{e0} = 0.3~\\text{min}^{-1}$,\n  - $C_{50} = 2.2$ micrograms per milliliter.\n\n- Test Case $2$ (fast effect-site dynamics, higher redistribution):\n  - $V_1 = 3.5$ liters,\n  - $k_{10} = 0.6~\\text{min}^{-1}$, $k_{12} = 0.35~\\text{min}^{-1}$, $k_{21} = 0.25~\\text{min}^{-1}$, $k_{13} = 0.25~\\text{min}^{-1}$, $k_{31} = 0.07~\\text{min}^{-1}$,\n  - $k_{e0} = 0.5~\\text{min}^{-1}$,\n  - $C_{50} = 2.0$ micrograms per milliliter.\n\n- Test Case $3$ (slow effect-site dynamics, larger central volume):\n  - $V_1 = 5.0$ liters,\n  - $k_{10} = 0.4~\\text{min}^{-1}$, $k_{12} = 0.25~\\text{min}^{-1}$, $k_{21} = 0.15~\\text{min}^{-1}$, $k_{13} = 0.2~\\text{min}^{-1}$, $k_{31} = 0.05~\\text{min}^{-1}$,\n  - $k_{e0} = 0.15~\\text{min}^{-1}$,\n  - $C_{50} = 2.5$ micrograms per milliliter.\n\nRequired final output:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,result3]$).\n- Each item is the overshoot during induction for one test case, expressed in BIS points as a float rounded to three decimals, with no units and no additional text.",
            "solution": "The problem has been validated and is deemed scientifically grounded, well-posed, and self-contained. It describes a standard problem in biomedical control engineering: the application of Model Predictive Control (MPC) to regulate the depth of anesthesia using propofol. The pharmacokinetic/pharmacodynamic (PK/PD) model is a well-established representation, and the control objective is clearly and formally defined.\n\nThe solution involves simulating a receding-horizon MPC controller for the given nonlinear PK/PD model. At each time step, an optimization problem is solved to find a sequence of future infusion rates that minimizes a cost function. This cost function balances tracking a desired Bispectral Index (BIS) setpoint against rapid changes in the drug infusion rate.\n\nI. System Model\nThe system is described by a fourth-order state-space model. The state vector is $\\mathbf{x} = [A_1, A_2, A_3, C_e]^T$, where $A_1$, $A_2$, $A_3$ are the amounts of propofol in the central, fast peripheral, and slow peripheral compartments, respectively (in $\\mu g$), and $C_e$ is the propofol concentration in the effect-site compartment (in $\\mu g/mL$). The control input is the infusion rate $u(t)$ in $mg/min$.\n\nThe continuous-time state dynamics are given by $\\dot{\\mathbf{x}} = f(\\mathbf{x}, u)$:\n$$\n\\frac{dA_1}{dt} = 1000\\,u - (k_{10} + k_{12} + k_{13})A_1 + k_{21}A_2 + k_{31}A_3\n$$\n$$\n\\frac{dA_2}{dt} = k_{12}A_1 - k_{21}A_2\n$$\n$$\n\\frac{dA_3}{dt} = k_{13}A_1 - k_{31}A_3\n$$\n$$\n\\frac{dC_e}{dt} = k_{e0}\\left(\\frac{A_1}{1000\\,V_1} - C_e\\right)\n$$\nThe factor of $1000$ in the first equation converts the infusion rate $u$ from $mg/min$ to $\\mu g/min$. The factor of $1000$ in the fourth equation converts the central compartment volume $V_1$ from Liters to milliliters, ensuring the concentration $A_1/(1000\\,V_1)$ is in $\\mu g/mL$.\n\nThe output of the system is the Bispectral Index (BIS), which is a nonlinear, static function of the effect-site concentration $C_e$:\n$$\ny(t) = BIS(t) = BIS_0 - E_{\\max}\\frac{C_e(t)^\\gamma}{C_{50}^\\gamma + C_e(t)^\\gamma}\n$$\n\nII. Discrete-Time Model for Simulation and Prediction\nFor digital control and simulation, the continuous-time model is discretized using the forward Euler method with a sampling time $T_s$. The state at time step $k+1$ is approximated from the state at step $k$ as:\n$$\n\\mathbf{x}_{k+1} = \\mathbf{x}_k + T_s \\cdot f(\\mathbf{x}_k, u_k)\n$$\nwhere $\\mathbf{x}_k = \\mathbf{x}(k T_s)$ and $u_k = u(k T_s)$. This yields the following set of difference equations:\n$$\nA_{1,k+1} = A_{1,k} + T_s \\left( 1000\\,u_k - (k_{10} + k_{12} + k_{13})A_{1,k} + k_{21}A_{2,k} + k_{31}A_{3,k} \\right)\n$$\n$$\nA_{2,k+1} = A_{2,k} + T_s \\left( k_{12}A_{1,k} - k_{21}A_{2,k} \\right)\n$$\n$$\nA_{3,k+1} = A_{3,k} + T_s \\left( k_{13}A_{1,k} - k_{31}A_{3,k} \\right)\n$$\n$$\nC_{e,k+1} = C_{e,k} + T_s \\left( k_{e0}\\left(\\frac{A_{1,k}}{1000\\,V_1} - C_{e,k}\\right) \\right)\n$$\nThe BIS value at step $k+1$ is then $BIS_{k+1} = BIS(C_{e,k+1})$.\n\nIII. Model Predictive Control Formulation\nThe MPC controller operates on the principle of receding-horizon control. At each sampling instant $t_{sim}$, the controller performs the following actions:\n1.  Measures or estimates the current state of the system, $\\mathbf{x}(t_{sim})$.\n2.  Solves a finite-horizon optimal control problem to find a sequence of future control inputs $\\mathbf{U} = \\{u_0, u_1, \\dots, u_{N-1}\\}$ that minimizes a cost function $J$ over a prediction horizon of $N$ steps.\n3.  Applies only the first element of the optimal sequence, $u_0^*$, to the system for the duration $T_s$.\n4.  Discards the rest of the sequence and repeats the process at the next sampling instant, $t_{sim} + T_s$.\n\nThe optimization problem at each step is to find $\\mathbf{U}^* = \\arg\\min_{\\mathbf{U}} J$ subject to the control input constraints $0 \\le u_k \\le u_{\\max}$ for $k=0, \\dots, N-1$. The cost function is:\n$$\nJ(\\mathbf{U}) = \\sum_{k=1}^{N} w_y\\left(\\hat{y}_k - r_k\\right)^2 + w_{\\Delta u}\\sum_{k=0}^{N-1}\\left(u_k - u_{k-1}\\right)^2\n$$\nHere, $\\hat{y}_k = \\hat{BIS}_k$ is the predicted BIS value at step $k$ of the prediction horizon, calculated by iteratively applying the discrete-time model. The sequence $r_k$ is the reference BIS setpoint over the horizon. The term $u_{-1}$ represents the control input applied in the previous sampling interval, before the current optimization begins. This is a nonlinear, constrained optimization problem due to the nonlinearity of the BIS function. It is solved numerically at each time step using a routine for constrained optimization, such as Sequential Least Squares Programming (SLSQP).\n\nIV. Simulation and Overshoot Calculation\nThe overall simulation proceeds for a total duration of $25$ minutes with a sampling time $T_s = 0.25$ minutes. The system starts from a drug-free state, i.e., $\\mathbf{x}(0) = [0, 0, 0, 0]^T$, and the initial previous control is $u_{-1}=0$.\n\nThe simulation consists of two phases:\n- **Induction Phase**: For $t \\in [0, 8)$ minutes, the BIS setpoint is $r(t) = 50$.\n- **Maintenance Phase**: For $t \\in [8, 25]$ minutes, the BIS setpoint is $r(t) = 45$.\n\nAt each discrete time step $t_{sim} = i \\cdot T_s$ ($i=0, 1, 2, \\dots$):\n1.  The current state $\\mathbf{x}_i$ and previous control $u_{i-1}$ are used to set up the MPC optimization.\n2.  The reference trajectory over the prediction horizon is set to the appropriate value ($50$ or $45$).\n3.  The optimization problem is solved to obtain the optimal control sequence.\n4.  The first control action, $u_i = u_0^*$, is applied.\n5.  The system state is advanced to $\\mathbf{x}_{i+1}$ using the discrete-time model with input $u_i$.\n6.  The resulting $BIS_{i+1}$ is recorded.\n\nAfter the simulation, the overshoot during the induction phase is calculated. The induction phase covers time $t \\in [0, 8]$ minutes, which corresponds to the first $8/T_s = 32$ simulation steps and generates $33$ BIS values from $t=0$ to $t=8$. The minimum BIS value during this period, $\\min\\limits_{t \\in [0, 8]} BIS(t)$, is found. The overshoot is then defined as:\n$$\n\\text{Overshoot} = \\max(0, 50 - \\min\\limits_{t \\in [0, 8]} BIS(t))\n$$\nThis quantity is calculated for each of the three test cases specified in the problem.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize\n\ndef solve():\n    \"\"\"\n    Main function to run the MPC simulation for all test cases and print the results.\n    \"\"\"\n\n    # Global parameters common to all test cases\n    common_params = {\n        'Ts': 0.25,      # Sampling time (min)\n        'N': 16,         # Prediction horizon (steps)\n        'wy': 1.0,       # BIS tracking weight\n        'wdu': 0.001,    # Control rate change weight\n        'u_max': 250.0,  # Max infusion rate (mg/min)\n        'BIS0': 90.0,    # Baseline BIS\n        'Emax': 60.0,    # Max effect\n        'gamma': 2.0,    # Hill exponent\n    }\n\n    # Test case specific parameters\n    test_cases = [\n        # Test Case 1 (typical adult)\n        {\n            'V1': 4.0, 'k10': 0.5, 'k12': 0.3, 'k21': 0.2, 'k13': 0.2, 'k31': 0.05,\n            'ke0': 0.3, 'C50': 2.2,\n        },\n        # Test Case 2 (fast effect-site dynamics, higher redistribution)\n        {\n            'V1': 3.5, 'k10': 0.6, 'k12': 0.35, 'k21': 0.25, 'k13': 0.25, 'k31': 0.07,\n            'ke0': 0.5, 'C50': 2.0,\n        },\n        # Test Case 3 (slow effect-site dynamics, larger central volume)\n        {\n            'V1': 5.0, 'k10': 0.4, 'k12': 0.25, 'k21': 0.15, 'k13': 0.2, 'k31': 0.05,\n            'ke0': 0.15, 'C50': 2.5,\n        },\n    ]\n\n    results = []\n    for case_params in test_cases:\n        params = {**common_params, **case_params}\n        overshoot = run_simulation(params)\n        results.append(f\"{overshoot:.3f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef bis_dynamic(Ce, p):\n    \"\"\"Calculates BIS from effect-site concentration.\"\"\"\n    if Ce  0: Ce = 0\n    ce_gamma = Ce ** p['gamma']\n    c50_gamma = p['C50'] ** p['gamma']\n    effect = p['Emax'] * ce_gamma / (c50_gamma + ce_gamma)\n    return p['BIS0'] - effect\n\ndef state_update(x, u, p):\n    \"\"\"\n    Computes the next state using forward Euler discretization.\n    State vector x = [A1, A2, A3, Ce].\n    \"\"\"\n    A1, A2, A3, Ce = x\n    Ts = p['Ts']\n\n    # Concentrations for rate calculations\n    C1 = A1 / (1000.0 * p['V1']) # ug/mL\n\n    # Derivatives\n    dA1_dt = 1000.0 * u - (p['k10'] + p['k12'] + p['k13']) * A1 + p['k21'] * A2 + p['k31'] * A3\n    dA2_dt = p['k12'] * A1 - p['k21'] * A2\n    dA3_dt = p['k13'] * A1 - p['k31'] * A3\n    dCe_dt = p['ke0'] * (C1 - Ce)\n\n    # Forward Euler step\n    A1_new = A1 + Ts * dA1_dt\n    A2_new = A2 + Ts * dA2_dt\n    A3_new = A3 + Ts * dA3_dt\n    Ce_new = Ce + Ts * dCe_dt\n    \n    return np.array([A1_new, A2_new, A3_new, Ce_new])\n\ndef mpc_objective(U, x_current, u_prev, p, ref_trajectory):\n    \"\"\"\n    Objective function for the MPC optimization.\n    U is the sequence of future control inputs [u_0, ..., u_{N-1}].\n    \"\"\"\n    cost_y = 0.0\n    cost_du = 0.0\n    x_pred = np.copy(x_current)\n    u_k_minus_1 = u_prev\n\n    for k in range(p['N']):\n        u_k = U[k]\n        \n        # Penalty on control rate change\n        cost_du += p['wdu'] * (u_k - u_k_minus_1)**2\n        \n        # Predict next state\n        x_pred = state_update(x_pred, u_k, p)\n        \n        # Predicted BIS\n        bis_pred = bis_dynamic(x_pred[3], p)\n        \n        # Penalty on tracking error\n        cost_y += p['wy'] * (bis_pred - ref_trajectory[k])**2\n        \n        u_k_minus_1 = u_k\n        \n    return cost_y + cost_du\n\ndef run_simulation(p):\n    \"\"\"\n    Runs the full MPC simulation for one set of parameters.\n    \"\"\"\n    total_time = 25.0  # minutes\n    induction_time = 8.0 # minutes\n    \n    num_steps = int(total_time / p['Ts'])\n    induction_steps = int(induction_time / p['Ts'])\n\n    # Initial state: drug-free patient\n    x = np.zeros(4)  # [A1, A2, A3, Ce]\n    u_prev = 0.0\n    \n    bis_history = [p['BIS0']]\n\n    for i in range(num_steps):\n        current_time = i * p['Ts']\n        \n        # Set reference BIS for the horizon\n        if current_time  induction_time:\n            ref_target = 50.0\n        else:\n            ref_target = 45.0\n        ref_trajectory = np.full(p['N'], ref_target)\n        \n        # Initial guess for the control sequence\n        u_guess = np.full(p['N'], u_prev)\n        \n        # Bounds for the control inputs\n        bounds = [(0, p['u_max'])] * p['N']\n\n        # Solve the optimization problem\n        opt_result = minimize(\n            mpc_objective, \n            u_guess, \n            args=(x, u_prev, p, ref_trajectory),\n            method='SLSQP', \n            bounds=bounds\n        )\n        \n        # Apply the first optimal control input\n        u_current = opt_result.x[0]\n\n        # Update system state\n        x = state_update(x, u_current, p)\n        \n        # Store BIS and update previous control\n        bis_history.append(bis_dynamic(x[3], p))\n        u_prev = u_current\n\n    # Calculate overshoot during induction\n    bis_induction = bis_history[:induction_steps + 1] # Times from 0 to 8 minutes\n    min_bis_induction = min(bis_induction)\n    overshoot = max(0, 50.0 - min_bis_induction)\n    \n    return overshoot\n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}