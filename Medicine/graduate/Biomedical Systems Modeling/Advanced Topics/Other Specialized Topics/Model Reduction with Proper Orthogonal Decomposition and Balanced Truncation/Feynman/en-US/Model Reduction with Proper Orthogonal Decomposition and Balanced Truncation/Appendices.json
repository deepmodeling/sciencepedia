{
    "hands_on_practices": [
        {
            "introduction": "The power of balanced truncation lies in its elegant connection between system theory and algebraic simplicity. Once a system is in a balanced form, where states are ordered by their joint controllability and observability, model reduction becomes a straightforward act of partitioning. This foundational exercise guides you through deriving the reduced-order model from first principles, solidifying your understanding of how the balanced structure directly leads to a truncated system. ",
            "id": "3903215",
            "problem": "Consider a linear time-invariant state-space model arising from a linearization of a multi-compartment biomedical signaling network around a steady state, given by\n$$\n\\dot{x}(t) = A x(t) + B u(t), \\quad y(t) = C x(t) + D u(t),\n$$\nwith $x(t) \\in \\mathbb{R}^{n}$, $u(t) \\in \\mathbb{R}^{m}$, and $y(t) \\in \\mathbb{R}^{p}$. Assume the system is asymptotically stable and minimal. Suppose that, after a similarity transformation to balanced coordinates, the controllability and observability Gramians are equal and diagonal, i.e.,\n$$\nW_{c} = W_{o} = \\Sigma = \\operatorname{diag}(\\sigma_{1}, \\sigma_{2}, \\dots, \\sigma_{n}),\n$$\nwith Hankel singular values ordered as $\\sigma_{1} \\ge \\sigma_{2} \\ge \\cdots \\ge \\sigma_{n} > 0$. Let the balanced system matrices be partitioned conformably with a chosen reduced order $r$ (with $1 \\le r < n$) as\n$$\nA = \\begin{bmatrix}\nA_{11} & A_{12} \\\\\nA_{21} & A_{22}\n\\end{bmatrix}, \\quad\nB = \\begin{bmatrix}\nB_{1} \\\\\nB_{2}\n\\end{bmatrix}, \\quad\nC = \\begin{bmatrix}\nC_{1} & C_{2}\n\\end{bmatrix},\n$$\nwhere the partition corresponds to the state decomposition $x = \\begin{bmatrix} x_{1} \\\\ x_{2} \\end{bmatrix}$ with $x_{1} \\in \\mathbb{R}^{r}$ associated to the $r$ largest Hankel singular values in $\\Sigma$, and $x_{2} \\in \\mathbb{R}^{n-r}$ to the remaining smaller ones.\n\nStarting from the foundational definitions of reachability and observability Gramians for stable systems, and the definition of a balanced realization, derive from first principles the truncated balanced model obtained by discarding the weakly controllable/observable state block $x_{2}$. Clearly state how $B$ and $C$ are partitioned and how they are reduced in the truncated model. Then, express the transfer function of the truncated model in the complex Laplace variable $s$ as a closed-form analytic expression involving only the partitioned blocks $A_{11}$, $B_{1}$, $C_{1}$, and $D$.\n\nGive your final answer as the transfer function expression of the truncated model $G_{r}(s)$, written as a single analytic expression in $s$. No numerical evaluation is required, and no units are needed.",
            "solution": "We begin with a continuous-time linear time-invariant system that is asymptotically stable and minimal. The reachability (also called controllability) Gramian $W_{c}$ and observability Gramian $W_{o}$ of such a system are defined as the unique positive definite solutions to the continuous-time Lyapunov equations\n$$\nA W_{c} + W_{c} A^{\\top} + B B^{\\top} = 0, \\quad\nA^{\\top} W_{o} + W_{o} A + C^{\\top} C = 0,\n$$\nprovided that $A$ is Hurwitz (all eigenvalues have strictly negative real parts) and the realization is minimal. A balanced realization is obtained via a similarity transformation $T$ such that in the transformed coordinates the Gramians are equal and diagonal:\n$$\nW_{c} = W_{o} = \\Sigma = \\operatorname{diag}(\\sigma_{1}, \\sigma_{2}, \\dots, \\sigma_{n}),\n$$\nwhere the diagonal entries $\\sigma_{i}$ are the Hankel singular values ordered as $\\sigma_{1} \\ge \\sigma_{2} \\ge \\cdots \\ge \\sigma_{n} > 0$. In these balanced coordinates, states are simultaneously most controllable and observable along the same directions, with the magnitude quantified by $\\sigma_{i}$.\n\nTo construct a reduced model of order $r$, one partitions the balanced state vector and system matrices according to the ordering of $\\Sigma$:\n$$\nx = \\begin{bmatrix} x_{1} \\\\ x_{2} \\end{bmatrix}, \\quad x_{1} \\in \\mathbb{R}^{r}, \\ x_{2} \\in \\mathbb{R}^{n-r},\n$$\nand\n$$\nA = \\begin{bmatrix}\nA_{11} & A_{12} \\\\\nA_{21} & A_{22}\n\\end{bmatrix}, \\quad\nB = \\begin{bmatrix}\nB_{1} \\\\\nB_{2}\n\\end{bmatrix}, \\quad\nC = \\begin{bmatrix}\nC_{1} & C_{2}\n\\end{bmatrix},\n$$\nwhere the partitions are conformable: $A_{11} \\in \\mathbb{R}^{r \\times r}$, $A_{12} \\in \\mathbb{R}^{r \\times (n-r)}$, $A_{21} \\in \\mathbb{R}^{(n-r) \\times r}$, $A_{22} \\in \\mathbb{R}^{(n-r) \\times (n-r)}$, $B_{1} \\in \\mathbb{R}^{r \\times m}$, $B_{2} \\in \\mathbb{R}^{(n-r) \\times m}$, $C_{1} \\in \\mathbb{R}^{p \\times r}$, and $C_{2} \\in \\mathbb{R}^{p \\times (n-r)}$.\n\nIn balanced truncation, the key principle is that the contribution of the state components associated with small Hankel singular values to the input-output behavior is small. In the balanced coordinates, this leads to the approximation that neglects the weakly controllable and observable block $x_{2}$. The full balanced system dynamics can be written in block form as\n$$\n\\begin{aligned}\n\\dot{x}_{1}(t) &= A_{11} x_{1}(t) + A_{12} x_{2}(t) + B_{1} u(t), \\\\\n\\dot{x}_{2}(t) &= A_{21} x_{1}(t) + A_{22} x_{2}(t) + B_{2} u(t), \\\\\ny(t) &= C_{1} x_{1}(t) + C_{2} x_{2}(t) + D u(t).\n\\end{aligned}\n$$\nThe truncated balanced model, also called the balanced truncation approximation, discards $x_{2}$ and retains only the $r$-dimensional subsystem driven by $x_{1}$. The reduced-order state, input, and output matrices are then obtained by taking the corresponding retained blocks:\n$$\nA_{r} = A_{11}, \\quad B_{r} = B_{1}, \\quad C_{r} = C_{1}, \\quad D_{r} = D.\n$$\nThis choice follows from the balanced coordinates: setting $x_{2}(t) \\approx 0$ in the output and discarding its dynamics yields the reduced-order state equation $\\dot{x}_{1}(t) = A_{11} x_{1}(t) + B_{1} u(t)$ and output equation $y(t) = C_{1} x_{1}(t) + D u(t)$.\n\nTo express the reduced transfer function, we recall the standard transfer function representation. For any state-space realization $(A, B, C, D)$, the transfer function $G(s)$ is\n$$\nG(s) = C (s I_{n} - A)^{-1} B + D,\n$$\nwhere $s \\in \\mathbb{C}$, and $I_{n}$ is the $n \\times n$ identity matrix. Applying this to the reduced-order realization $(A_{r}, B_{r}, C_{r}, D_{r}) = (A_{11}, B_{1}, C_{1}, D)$, we obtain\n$$\nG_{r}(s) = C_{1} \\bigl(s I_{r} - A_{11}\\bigr)^{-1} B_{1} + D.\n$$\nThis is the required closed-form analytic expression for the truncated model transfer function in terms of the partitioned blocks $A_{11}$, $B_{1}$, $C_{1}$, and $D$.\n\nIn summary, the truncation procedure partitions $B$ and $C$ conformably with the state partition as $B = \\begin{bmatrix} B_{1} \\\\ B_{2} \\end{bmatrix}$ and $C = \\begin{bmatrix} C_{1} & C_{2} \\end{bmatrix}$, and then reduces them by retaining $B_{1}$ and $C_{1}$ associated with the kept state block $x_{1}$, while discarding $B_{2}$ and $C_{2}$ associated with the neglected block $x_{2}$. The resulting reduced transfer function is $G_{r}(s) = C_{1} (s I_{r} - A_{11})^{-1} B_{1} + D$.",
            "answer": "$$\\boxed{C_{1}\\bigl(s I_{r} - A_{11}\\bigr)^{-1} B_{1} + D}$$"
        },
        {
            "introduction": "Transitioning from the theory of balanced truncation to its practical implementation requires careful numerical consideration. A naive approach can fail for the stiff or ill-conditioned models often found in biomedical systems. This practice problem challenges you to identify a robust computational procedure, the \"square-root method,\" which uses Cholesky and singular value decompositions to preserve numerical accuracy, and to recognize the key pitfalls that arise in practice. ",
            "id": "3903279",
            "problem": "A linearized infusion-controlled glucose–insulin subsystem in a critically ill patient can be approximated as a stable Linear Time-Invariant (LTI) model with state, input, and output defined by\n$$\n\\dot{x}(t) = A x(t) + B u(t), \\quad y(t) = C x(t),\n$$\nwhere $x(t) \\in \\mathbb{R}^n$, $u(t) \\in \\mathbb{R}^m$, and $y(t) \\in \\mathbb{R}^p$, and $A \\in \\mathbb{R}^{n \\times n}$ is Hurwitz (all eigenvalues have strictly negative real parts). Model reduction via balanced truncation is desired to produce a reduced-order representation preserving input–output behavior critical for dose-response safety.\n\nStarting from the foundational definitions of the infinite-horizon controllability and observability Gramians,\n$$\nW_c = \\int_0^{\\infty} e^{A t} B B^{\\top} e^{A^{\\top} t} \\, dt, \\quad\nW_o = \\int_0^{\\infty} e^{A^{\\top} t} C^{\\top} C \\, e^{A t} \\, dt,\n$$\nwhich equivalently satisfy the continuous-time Lyapunov equations\n$$\nA W_c + W_c A^{\\top} + B B^{\\top} = 0, \\qquad\nA^{\\top} W_o + W_o A + C^{\\top} C = 0,\n$$\nselect the option that correctly outlines a principled procedure to compute a balancing transform using Cholesky factorizations of $W_c$ and $W_o$ together with a Singular Value Decomposition (SVD), and simultaneously identifies the primary numerical pitfalls and appropriate remedies in ill-conditioned or stiff biomedical models.\n\nA. Assume $A$ is Hurwitz and the realization is minimal. Solve the Lyapunov equations for $W_c$ and $W_o$. Compute Cholesky factorizations $W_c = R_c R_c^{\\top}$ and $W_o = R_o R_o^{\\top}$ with $R_c, R_o$ upper triangular. Compute the SVD of $R_o^{\\top} R_c$ as $U \\Sigma V^{\\top}$, with $U, V$ orthogonal and $\\Sigma$ diagonal with nonnegative entries. Define a similarity transform using the Cholesky factors and the orthogonal–diagonal structure so that, in balanced coordinates, both transformed Gramians are equal and diagonal with entries given by $\\Sigma$. Truncate the state associated with the smallest diagonal entries to obtain a reduced-order model. Numerical pitfalls include: near-singularity or poor conditioning of $W_c$ or $W_o$ causing loss of positive definiteness and Cholesky breakdown; stiffness in $A$ degrading accuracy of Lyapunov solves and magnifying roundoff so that small entries of $\\Sigma$ are unreliable; and non-minimality leading to rank-deficient Gramians. Remedies include: pre-scaling states and inputs/outputs to improve conditioning; using square-root balanced truncation to avoid explicit inversion and retain orthogonality; employing pivoted Cholesky or symmetric $L D L^{\\top}$ factorizations for nearly singular Gramians; verifying stability and minimality or reducing to a minimal realization; and using low-rank Lyapunov solvers in large-scale settings.\n\nB. Compute $W_c$ and $W_o$ from the Lyapunov equations and then perform an eigenvalue decomposition of $W_c$ as $W_c = Q \\Lambda Q^{-1}$, set the transform as $T = Q \\Lambda^{1/2}$ so that $T W_c T^{\\top}$ is the identity, and truncate states corresponding to the smallest eigenvalues of $W_c$. Numerical issues are avoided because $Q$ diagonalizes $W_c$, and instability of $A$ is inconsequential since only $W_c$ is used.\n\nC. Form the product $W_c W_o$, compute its SVD as $W_c W_o = U \\Sigma V^{\\top}$, and define the balancing transform by directly using $U$ and $V$ so that the product Gramian is diagonalized. The Lyapunov equations need not be solved; instead, estimate $W_c$ and $W_o$ from impulse responses. Numerical pitfalls are limited to SVD convergence, which can be handled by choosing a larger tolerance, and truncation is based on the smallest singular values of $W_c W_o$.\n\nD. Collect state snapshots $x(t_k)$ from simulated step or impulse responses, assemble a data matrix, and perform Proper Orthogonal Decomposition (POD) by SVD to obtain principal modes. Use these modes as the balancing transform to reduce the system. Numerical pitfalls relate to insufficient sampling and noise in $x(t_k)$, which can be mitigated by filtering and increasing the number of snapshots; balancing of $W_c$ and $W_o$ is unnecessary because POD already captures the dominant state energy.",
            "solution": "The problem statement is valid. It presents a clear, scientifically grounded, and well-posed question regarding a standard procedure in control theory, namely balanced truncation, applied to a plausible biomedical context. All provided definitions and conditions are standard and self-consistent.\n\nThe core principle of balanced truncation is to find a state-space similarity transformation $x = T\\hat{x}$ that transforms the system $(A, B, C)$ to a new representation $(\\hat{A}, \\hat{B}, \\hat{C}) = (T^{-1}AT, T^{-1}B, CT)$ in which the controllability and observability Gramians are equal and diagonal:\n$$ \\hat{W}_c = \\hat{W}_o = \\Sigma = \\text{diag}(\\sigma_1, \\sigma_2, \\dots, \\sigma_n) $$\nThe values $\\sigma_i$ are the Hankel singular values (HSVs) of the system, which quantify the joint \"energy\" of each state mode with respect to both input-to-state and state-to-output mappings. States corresponding to small HSVs are weakly controllable and/or weakly observable and can be truncated to yield a lower-order model that accurately preserves the input-output behavior. The question asks for a numerically sound procedure to achieve this, along with an analysis of potential pitfalls.\n\nA numerically robust method, often called a square-root balanced truncation algorithm, avoids the explicit formation of the product $W_c W_o$, which can square the condition number and lead to a loss of accuracy in the small HSVs. Such a procedure is as follows:\n1.  Given a stable ($A$ is Hurwitz) and minimal realization $(A, B, C)$, solve the Lyapunov equations for the Gramians $W_c$ and $W_o$. Minimality ensures $W_c, W_o$ are positive definite.\n2.  Compute the Cholesky factorizations of the Gramians. Let us use the convention $W_c = L_c L_c^\\top$ and $W_o = L_o L_o^\\top$, where $L_c, L_o$ are lower triangular matrices.\n3.  Form the matrix product $L_o^\\top L_c$ and compute its Singular Value Decomposition (SVD): $L_o^\\top L_c = U \\Sigma V^\\top$. The diagonal entries of $\\Sigma$ are the Hankel singular values $\\sigma_i$.\n4.  Construct the balancing transformation matrix $T = L_c V \\Sigma^{-1/2}$ and its inverse $T^{-1} = \\Sigma^{1/2} V^\\top L_c^{-1}$. This transformation balances the system, i.e., $T^{-1}W_c(T^{-1})^\\top = \\Sigma$ and $T^\\top W_o T = \\Sigma$.\n5.  Partition the balanced system based on a desired reduced order $k$, corresponding to the $k$ largest HSVs, and retain the leading $k \\times k$ block of $\\hat{A}$ and the corresponding partitions of $\\hat{B}$ and $\\hat{C}$.\n\nWe will now evaluate each option against this principled framework.\n\nA. This option outlines a procedure entirely consistent with the square-root method described above. The use of upper triangular factors $R_c, R_o$ such that $W_c = R_c R_c^\\top$ is a valid, though less common, convention for Cholesky factorization; the subsequent steps involving the SVD of $R_o^\\top R_c$ are mathematically equivalent and sound. The description of the outcome—that the transformed Gramians become equal and diagonal ($\\Sigma$)—is correct. The method for truncation is also correct.\nCrucially, the option provides an extensive and accurate list of numerical pitfalls and their corresponding remedies. It correctly identifies:\n- The risk of Cholesky breakdown from ill-conditioned Gramians (due to near un-controllability/unobservability) and the remedy of using pivoted Cholesky or $LDL^\\top$ factorizations.\n- The impact of stiffness in $A$ on the accuracy of Lyapunov solvers and the reliability of small $\\sigma_i$.\n- The necessity of minimality for the Gramians to be invertible and the remedy of reducing to a minimal realization.\n- The benefits of pre-scaling to improve conditioning.\n- The role of square-root methods (which this option describes) in avoiding numerical degradation.\n- The use of low-rank solvers for large-scale systems.\nThis comprehensive and correct treatment of both the algorithm and its practical numerical considerations makes this option highly credible.\nVerdict: **Correct**.\n\nB. This option is fundamentally flawed. It proposes a transformation based only on the controllability Gramian $W_c$. The procedure $T=Q\\Lambda^{1/2}$ where $W_c=Q\\Lambda Q^\\top$ creates an *input-normal* realization where $\\hat{W}_c=I$, but it completely ignores the observability Gramian $W_o$. The transformed $\\hat{W}_o$ will not, in general, be diagonal, so the system is not balanced. Truncation based only on the eigenvalues of $W_c$ discards essential information about observability. Furthermore, the claim that \"instability of $A$ is inconsequential\" is false; the stability of $A$ (Hurwitz) is a necessary condition for the infinite-horizon Gramians to be well-defined.\nVerdict: **Incorrect**.\n\nC. This option describes an older, numerically inferior method that involves forming the product $W_c W_o$. This step squares the condition number of the problem, potentially rendering the smallest, and often most important for truncation, Hankel singular values inaccurate. The assertion that the balancing transform is defined \"directly using $U$ and $V$\" from the SVD of $W_c W_o$ is vague and incorrect. The statement that \"Numerical pitfalls are limited to SVD convergence\" is a gross oversimplification and false; the primary pitfall is the ill-conditioned formation of $W_c W_o$ itself.\nVerdict: **Incorrect**.\n\nD. This option incorrectly conflates two distinct model reduction techniques: Proper Orthogonal Decomposition (POD) and Balanced Truncation (BT). POD generates an optimal basis for a given set of state \"snapshots\" (data from simulations with specific inputs), minimizing the L2 error in reconstructing that data. BT, in contrast, is an input-independent method based on intrinsic system properties of controllability and observability. A POD basis is not a balancing transformation, and it does not guarantee that the transformed Gramians are diagonal and equal. The claim that balancing is \"unnecessary\" demonstrates a fundamental misunderstanding of the differing objectives of the two methods. While the listed pitfalls are relevant to POD, the question is explicitly about balanced truncation.\nVerdict: **Incorrect**.\n\nIn conclusion, Option A alone provides a mathematically sound, numerically robust procedure for balanced truncation and correctly identifies the associated practical challenges and solutions.",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "Many complex biomedical processes, from drug delivery to cell signaling, are modeled by partial differential equations (PDEs) which result in large-scale state-space systems upon spatial discretization. This capstone practice requires you to tackle such a system, derived from a reaction-diffusion PDE common in tissue modeling. You will implement both Proper Orthogonal Decomposition (POD), a data-driven method, and Balanced Truncation (BT), a system-theoretic method, providing a hands-on comparison of these two cornerstone model reduction techniques in a realistic setting. ",
            "id": "3903225",
            "problem": "Consider a one-dimensional spatially distributed reaction-diffusion model frequently used in biomedical systems modeling for signaling molecule transport in tissue. The governing partial differential equation is the linear parabolic equation\n$$\n\\frac{\\partial u}{\\partial t}(x,t) = d\\,\\frac{\\partial^2 u}{\\partial x^2}(x,t) - \\lambda\\,u(x,t) + b(x)\\,w(t), \\quad x \\in (0,L), \\; t \\ge 0,\n$$\nwith $u(x,t)$ denoting a dimensionless concentration, $d > 0$ a diffusion coefficient (dimensionless after nondimensionalization), $\\lambda > 0$ a reaction decay rate (dimensionless after nondimensionalization), $b(x)$ a spatially distributed input shape, and $w(t)$ a scalar input signal. The output can be taken as a linear functional of the state, $y(t) = c^\\top u(t)$, where $c$ is a spatial weighting vector.\n\nDiscretize the spatial domain using the Finite Element Method (FEM) with piecewise linear basis functions on a uniform mesh of $N$ elements over $[0,L]$, with $L = 1$. Let the nodal positions be $x_i = i h$ for $i = 0,1,\\dots,N$, where $h = L/N$. Assemble the standard mass matrix $M \\in \\mathbb{R}^{(N+1)\\times(N+1)}$ and stiffness matrix $K \\in \\mathbb{R}^{(N+1)\\times(N+1)}$ using the canonical element matrices\n$$\nM_e = \\frac{h}{6}\\begin{bmatrix}2 & 1 \\\\ 1 & 2\\end{bmatrix}, \\quad\nK_e = \\frac{1}{h}\\begin{bmatrix}1 & -1 \\\\ -1 & 1\\end{bmatrix}.\n$$\nThe semi-discrete model is\n$$\nM\\,\\dot{u}(t) = -d\\,K\\,u(t) - \\lambda\\,M\\,u(t) + B\\,w(t),\n$$\nwhere $u(t) \\in \\mathbb{R}^{N+1}$ is the vector of nodal values, and $B \\in \\mathbb{R}^{N+1}$ is the discretized input vector obtained via consistent FEM assembly for $b(x)$, i.e., $B_i = \\int_0^L \\varphi_i(x)\\,b(x)\\,dx$, where $\\varphi_i(x)$ are the FEM basis functions. For practical implementation with nodal quadrature, you may approximate $B$ as $M\\,b$, where $b \\in \\mathbb{R}^{N+1}$ is the vector of nodal samples of $b(x)$.\n\nBoundary conditions must be enforced consistently. For homogeneous Dirichlet boundary conditions, $u(0,t) = 0$ and/or $u(L,t) = 0$, eliminate the constrained degrees of freedom and work with the interior unknowns. For homogeneous Neumann boundary conditions (zero flux), the natural boundary conditions are already accounted for in the FEM formulation and do not require elimination.\n\nYou must construct Proper Orthogonal Decomposition (POD) modes weighted by the mass matrix $M$ (denoted $M$-weighted POD). Let the snapshot matrix be $X = [u(t_1),u(t_2),\\dots,u(t_m)] \\in \\mathbb{R}^{n\\times m}$ composed of the interior degrees of freedom after enforcing boundary conditions, where $n$ is the number of interior nodes. Define the $M$-weighted inner product on $\\mathbb{R}^n$ as $\\langle v,w\\rangle_M = v^\\top M\\,w$. The $r$ leading $M$-weighted POD modes must be columns of $\\Phi \\in \\mathbb{R}^{n\\times r}$ satisfying $\\Phi^\\top M\\,\\Phi = I_r$. Use these modes to perform Galerkin projection of the semi-discrete model, ensuring that the reduced-order model is consistent with the boundary conditions (i.e., reduced states only span interior degrees of freedom, and when lifted back to the full space, boundary values remain identically zero under homogeneous Dirichlet constraints). The reduced-order model should be expressed in mass-normalized coordinates, yielding\n$$\n\\dot{q}(t) = A_r\\,q(t) + B_r\\,w(t), \\quad A_r = \\Phi^\\top(-d\\,K - \\lambda\\,M)\\Phi, \\; B_r = \\Phi^\\top B,\n$$\nwhere $q(t) \\in \\mathbb{R}^r$ are reduced coordinates and $\\Phi^\\top M\\,\\Phi = I_r$.\n\nIn addition, for a small instance, derive a standard state-space representation by premultiplying the semi-discrete model with $M^{-1}$ to obtain $\\dot{u}(t) = A\\,u(t) + B_s\\,w(t)$ with $A = -d\\,M^{-1}K - \\lambda\\,I$ and $B_s = M^{-1}B$. Compute Balanced Truncation (BT) Hankel singular values by solving the continuous-time Lyapunov equations for the controllability and observability gramians,\n$$\nA\\,P + P\\,A^\\top + B_s\\,B_s^\\top = 0, \\quad A^\\top Q + Q\\,A + C^\\top C = 0,\n$$\nwhere $C \\in \\mathbb{R}^{1\\times n}$ defines a scalar output $y(t) = C\\,u(t)$.\n\nYour program must implement the above in a self-contained manner and produce results for the following test suite. All quantities are dimensionless. Time integration must use backward Euler for stability.\n\nTest case $1$ (happy path, homogeneous Dirichlet at both ends):\n- Parameters: $N = 40$, $L = 1$, $d = 0.02$, $\\lambda = 1.5$, $r = 6$, $T = 1.0$, $\\Delta t = 0.002$.\n- Boundary conditions: $u(0,t) = 0$, $u(L,t) = 0$.\n- Input: $w(t) = \\sin(2\\pi t)$.\n- Input shape: $b(x) = \\exp\\left(-\\left(\\frac{x - 0.5}{0.1}\\right)^2\\right)$ sampled at nodes.\n- Initial condition: $u(x,0) = 0$.\n- Task: Simulate the full-order semi-discrete model to collect $m$ snapshots at every time step. Construct $M$-weighted POD modes with $r = 6$, project the model, and simulate the reduced-order model using the same input and time steps. Report the maximum $M$-norm state error over all snapshots,\n$$\n\\max_k \\sqrt{(u_k - \\hat{u}_k)^\\top M\\,(u_k - \\hat{u}_k)},\n$$\nwhere $u_k$ is the interior full-order state and $\\hat{u}_k$ is the lifted reduced state. Output this value as a float.\n\nTest case $2$ (boundary handling with mixed boundary conditions):\n- Parameters: $N = 40$, $L = 1$, $d = 0.05$, $\\lambda = 0.5$, $r = 5$, $T = 1.0$, $\\Delta t = 0.002$.\n- Boundary conditions: $u(0,t) = 0$ (Dirichlet), $\\frac{\\partial u}{\\partial x}(L,t) = 0$ (Neumann).\n- Input: $w(t) = \\cos(2\\pi t)$.\n- Input shape: $b(x) = \\exp\\left(-\\left(\\frac{x - 0.3}{0.08}\\right)^2\\right)$ sampled at nodes.\n- Initial condition: $u(x,0) = 0$.\n- Task: Repeat the procedure in test case $1$ with the specified boundary conditions and parameters. Report the maximum $M$-norm state error over all snapshots as a float.\n\nTest case $3$ (Balanced Truncation Hankel singular values):\n- Parameters: $N = 20$, $L = 1$, $d = 0.03$, $\\lambda = 1.0$.\n- Boundary conditions: $u(0,t) = 0$, $u(L,t) = 0$.\n- Input shape vector $b(x) = \\exp\\left(-\\left(\\frac{x - 0.6}{0.12}\\right)^2\\right)$ sampled at nodes, and $B = M\\,b$.\n- Output vector: $C$ defined as the row vector with entries $c_i = b(x_i)$ over interior nodes, yielding $y(t) = C\\,u(t)$.\n- Task: Form the standard state-space matrices on the interior degrees of freedom, $A = -d\\,M^{-1}K - \\lambda\\,I$, $B_s = M^{-1}B$, and compute the controllability gramian $P$ and observability gramian $Q$ by solving the continuous Lyapunov equations. Compute the Hankel singular values as the square roots of the eigenvalues of $P\\,Q$, sort them in descending order, and return the first $3$ values as a list of floats.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with the third entry itself being a list. The format must be\n$[$result1$,$result2$,$[hsv1$,$hsv2$,$hsv3]$]$, for example, $[0.123,0.456,[1.23,0.45,0.12]]$.",
            "solution": "The user-provided problem is a comprehensive exercise in numerical methods for partial differential equations and model order reduction. The problem is scientifically grounded, well-posed, and its formulation is internally consistent. I will provide a full solution. The solution methodology proceeds as follows:\n\nFirst, the spatial domain of the one-dimensional reaction-diffusion partial differential equation (PDE) is discretized using the Finite Element Method (FEM) with linear basis functions. This process transforms the PDE into a large system of coupled ordinary differential equations (ODEs), known as the semi-discrete or full-order model (FOM). This system is structured as $M\\,\\dot{u}(t) = \\mathbf{A}\\,u(t) + B\\,w(t)$, where $M$ is the mass matrix and $\\mathbf{A} = -d\\,K - \\lambda\\,M$ contains the stiffness matrix $K$ and mass matrix $M$. Homogeneous boundary conditions are enforced by restricting the system to its interior degrees of freedom.\n\nSecond, for test cases 1 and 2, the FOM is simulated over time using the stable backward Euler method. The time-history of the state vector is collected into a snapshot matrix, $X$. This matrix contains the essential dynamic behavior of the FOM.\n\nThird, Proper Orthogonal Decomposition (POD) is applied to the snapshot data to extract a low-dimensional basis. The problem specifies an $M$-weighted POD, which is appropriate for FEM-discretized systems as it respects the underlying energy norm defined by the mass matrix. The $M$-weighted POD modes $\\Phi$ form an $M$-orthonormal basis that optimally captures the system's \"energy\" as recorded in the snapshots. The procedure to compute these modes involves a Cholesky decomposition of the interior mass matrix, $M_{int} = L\\,L^\\top$, followed by a standard Singular Value Decomposition (SVD) of the weighted snapshot matrix $\\tilde{X} = L^\\top X$. The POD modes are then recovered via a triangular solve.\n\nFourth, a reduced-order model (ROM) is constructed via Galerkin projection of the FOM onto the POD basis $\\Phi$. This yields a much smaller system of ODEs, $\\dot{q}(t) = A_r\\,q(t) + B_r\\,w(t)$, where the state $q(t)$ has a much lower dimension $r$ than the FOM state $u(t)$. The reduced system matrices are given by $A_r = \\Phi^\\top(-d\\,K_{int} - \\lambda\\,M_{int})\\Phi$ and $B_r = \\Phi^\\top B_{int}$. This ROM is also simulated using the backward Euler method.\n\nFifth, the accuracy of the ROM is evaluated by comparing its solution to that of the FOM. The ROM state $q_k$ at each time step is \"lifted\" back to the full-dimensional space as $\\hat{u}_k = \\Phi\\,q_k$. The error is computed as the maximum $M$-norm of the difference between the full-order state $u_k$ and the lifted reduced state $\\hat{u}_k$ over all time steps, $\\max_k \\sqrt{(u_k - \\hat{u}_k)^\\top M_{int}\\,(u_k - \\hat{u}_k)}$.\n\nSixth, for test case 3, an alternative model reduction technique, Balanced Truncation (BT), is explored. This requires converting the semi-discrete system into the standard state-space form $\\dot{u}(t) = A\\,u(t) + B_s\\,w(t)$ by premultiplying with $M_{int}^{-1}$. The core of BT lies in computing the controllability and observability gramians, $P$ and $Q$ respectively. These are obtained by solving continuous-time algebraic Lyapunov equations. The Hankel singular values (HSVs), $\\sigma_i$, are then computed as the square roots of the eigenvalues of the product of the gramians, $\\sigma_i = \\sqrt{\\lambda_i(P\\,Q)}$. These values quantify the states' joint controllability and observability, providing a metric for model reduction. The task is to compute and report the top three HSVs.\n\nThe implementation will follow these steps, with careful handling of matrix assembly, boundary condition enforcement, and the specific numerical algorithms for POD and BT.\n\n**Step-by-Step Derivations**\n\n**1. FEM Discretization and Assembly**\nThe spatial domain $[0, L]$ is divided into $N$ elements of size $h = L/N$. The global mass matrix $M \\in \\mathbb{R}^{(N+1)\\times(N+1)}$ and stiffness matrix $K \\in \\mathbb{R}^{(N+1)\\times(N+1)}$ are assembled by iterating through each element and adding the local contributions of the element mass matrix, $M_e = \\frac{h}{6}\\begin{bmatrix}2 & 1 \\\\ 1 & 2\\end{bmatrix}$, and stiffness matrix, $K_e = \\frac{1}{h}\\begin{bmatrix}1 & -1 \\\\ -1 & 1\\end{bmatrix}$, to the corresponding entries in the global matrices.\n\n**2. Boundary Condition (BC) Enforcement**\nFor homogeneous Dirichlet BCs, $u_i = 0$, the $i$-th row and column are removed from the system matrices $M, K$ and vector $B$. For homogeneous Neumann BCs, which are natural BCs in this FEM formulation, no modifications are needed at the Neumann boundary node. Let the resulting interior matrices be $M_{int}, K_{int}$ and vector be $B_{int}$.\n\n**3. Full-Order Model (FOM) Simulation**\nThe FOM for the interior nodes $u_{int}$ is $M_{int}\\,\\dot{u}_{int}(t) = (-d K_{int} - \\lambda M_{int})u_{int}(t) + B_{int}w(t)$. Applying backward Euler discretization with time step $\\Delta t$, we have:\n$$ M_{int}\\,\\frac{u_{k+1}-u_k}{\\Delta t} = (-d K_{int} - \\lambda M_{int})u_{k+1} + B_{int}w_{k+1} $$\nRearranging to solve for the state $u_{k+1}$ at the next time step gives the linear system:\n$$ (M_{int} + \\Delta t(d K_{int} + \\lambda M_{int}))\\,u_{k+1} = M_{int}\\,u_k + \\Delta t B_{int}w_{k+1} $$\nThe matrix on the left-hand side is constant and can be factorized once (e.g., LU decomposition) for efficient repeated solves.\n\n**4. M-weighted Proper Orthogonal Decomposition (POD)**\nGiven the snapshot matrix of interior states $X = [u_1, \\dots, u_m] \\in \\mathbb{R}^{n \\times m}$, the goal is to find modes $\\Phi \\in \\mathbb{R}^{n \\times r}$ that are orthonormal in the $M_{int}$-inner product, i.e., $\\Phi^\\top M_{int} \\Phi = I_r$.\na. Compute the Cholesky factorization of the symmetric positive-definite mass matrix: $M_{int} = L\\,L^\\top$.\nb. Weight the snapshots: $\\tilde{X} = L^\\top X$.\nc. Compute the SVD of the weighted snapshots: $\\tilde{X} = U \\Sigma V^\\top$. The left singular vectors $U$ are the POD modes in the weighted coordinate system.\nd. Select the first $r$ columns of $U$ to form $\\tilde{\\Phi} = U[:, :r]$.\ne. Transform the modes back to the original coordinate system by solving the linear system $L^\\top \\Phi = \\tilde{\\Phi}$.\n\n**5. Reduced-Order Model (ROM) Simulation**\nThe ROM is $\\dot{q}(t) = A_r q(t) + B_r w(t)$, where $A_r = \\Phi^\\top(-d K_{int} - \\lambda M_{int})\\Phi$ and $B_r = \\Phi^\\top B_{int}$. Using backward Euler:\n$$ \\frac{q_{k+1}-q_k}{\\Delta t} = A_r q_{k+1} + B_r w_{k+1} \\implies (I_r - \\Delta t A_r)q_{k+1} = q_k + \\Delta t B_r w_{k+1} $$\nThis $r \\times r$ linear system is solved at each time step.\n\n**6. Balanced Truncation (BT)**\na. Form state-space matrices for interior nodes: $A = -d\\,M_{int}^{-1}K_{int} - \\lambda\\,I$, $B_s = M_{int}^{-1}B_{int}$, and $C$.\nb. Solve the continuous-time Lyapunov equations for the controllability gramian $P$ and observability gramian $Q$:\n   $$ A\\,P + P\\,A^\\top + B_s\\,B_s^\\top = 0 $$\n   $$ A^\\top Q + Q\\,A + C^\\top C = 0 $$\nc. Compute the eigenvalues $\\lambda_i$ of the product $P Q$.\nd. The Hankel singular values are $\\sigma_i = \\sqrt{\\lambda_i}$. These are sorted in descending order.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main solver function that orchestrates the execution of all test cases.\n    \"\"\"\n\n    def assemble_matrices(N, L):\n        \"\"\"\n        Assembles the global mass (M) and stiffness (K) matrices for a 1D problem\n        with N linear finite elements.\n        \"\"\"\n        h = L / N\n        M_e = (h / 6.0) * np.array([[2.0, 1.0], [1.0, 2.0]])\n        K_e = (1.0 / h) * np.array([[1.0, -1.0], [-1.0, 1.0]])\n\n        M = np.zeros((N + 1, N + 1))\n        K = np.zeros((N + 1, N + 1))\n\n        for i in range(N):\n            M[i:i+2, i:i+2] += M_e\n            K[i:i+2, i:i+2] += K_e\n        return M, K\n\n    def solve_pod_case(N, L, d, lmbda, r, T, dt, bc_type, w_func, b_func):\n        \"\"\"\n        Solves test cases 1 and 2, which involve POD model reduction.\n        \"\"\"\n        # 1. Setup and FEM Assembly\n        M, K = assemble_matrices(N, L)\n        nodes = np.linspace(0, L, N + 1)\n        b_vec = b_func(nodes)\n        B_vec = M @ b_vec\n\n        # 2. Boundary Condition Enforcement\n        if bc_type == 'dirichlet-dirichlet':\n            # u(0)=0, u(L)=0. Interior nodes are 1 to N-1\n            int_indices = np.arange(1, N)\n        elif bc_type == 'dirichlet-neumann':\n            # u(0)=0, u'(L)=0. Interior nodes are 1 to N\n            int_indices = np.arange(1, N + 1)\n        else:\n            raise ValueError(\"Unknown BC type\")\n        \n        M_int = M[np.ix_(int_indices, int_indices)]\n        K_int = K[np.ix_(int_indices, int_indices)]\n        B_int = B_vec[int_indices]\n        n_int = len(int_indices)\n\n        # 3. Full-Order Model (FOM) Simulation\n        num_steps = int(T / dt)\n        times = np.linspace(0, T, num_steps + 1)\n        \n        u_int = np.zeros(n_int)\n        snapshots = np.zeros((n_int, num_steps + 1))\n        snapshots[:, 0] = u_int\n\n        A_fom_sys = -d * K_int - lmbda * M_int\n        LHS_fom = M_int - dt * A_fom_sys\n        LHS_fom_lu = linalg.lu_factor(LHS_fom)\n\n        for k in range(num_steps):\n            w_next = w_func(times[k+1])\n            rhs_fom = M_int @ u_int + dt * B_int * w_next\n            u_int = linalg.lu_solve(LHS_fom_lu, rhs_fom)\n            snapshots[:, k+1] = u_int\n\n        # 4. M-weighted POD\n        L_M = linalg.cholesky(M_int, lower=True)\n        X_tilde = L_M.T @ snapshots\n        U, s, Vh = linalg.svd(X_tilde, full_matrices=False)\n        Phi_tilde = U[:, :r]\n        Phi = linalg.solve_triangular(L_M.T, Phi_tilde, lower=False)\n\n        # 5. Reduced-Order Model (ROM) Simulation\n        A_r = Phi.T @ A_fom_sys @ Phi\n        B_r = Phi.T @ B_int\n\n        q = np.zeros(r)\n        u_hat_snapshots = np.zeros((n_int, num_steps + 1))\n        u_hat_snapshots[:, 0] = Phi @ q\n\n        LHS_rom = np.eye(r) - dt * A_r\n        LHS_rom_inv = linalg.inv(LHS_rom)\n\n        for k in range(num_steps):\n            w_next = w_func(times[k+1])\n            rhs_rom = q + dt * B_r * w_next\n            q = LHS_rom_inv @ rhs_rom\n            u_hat_snapshots[:, k+1] = Phi @ q\n        \n        # 6. Error Calculation\n        max_err_sq = 0.0\n        for k in range(num_steps + 1):\n            error_vec = snapshots[:, k] - u_hat_snapshots[:, k]\n            weighted_error_vec = L_M.T @ error_vec\n            err_norm_sq = weighted_error_vec.T @ weighted_error_vec\n            if err_norm_sq > max_err_sq:\n                max_err_sq = err_norm_sq\n        \n        return np.sqrt(max_err_sq)\n        \n    def solve_bt_case(N, L, d, lmbda, b_func, c_func):\n        \"\"\"\n        Solves test case 3, which involves Balanced Truncation.\n        \"\"\"\n        # 1. Setup and FEM Assembly\n        M, K = assemble_matrices(N, L)\n        nodes = np.linspace(0, L, N + 1)\n        b_vec = b_func(nodes)\n        B_vec = M @ b_vec\n\n        # 2. BC Enforcement (Dirichlet-Dirichlet)\n        int_indices = np.arange(1, N)\n        M_int = M[np.ix_(int_indices, int_indices)]\n        K_int = K[np.ix_(int_indices, int_indices)]\n        B_int = B_vec[int_indices]\n        C_int = c_func(nodes[int_indices])\n        \n        # 3. State-Space Matrices\n        M_int_inv = linalg.inv(M_int)\n        A = -d * (M_int_inv @ K_int) - lmbda * np.eye(N - 1)\n        Bs = M_int_inv @ B_int\n        C = C_int.reshape(1, -1)\n        \n        Bs_col = Bs.reshape(-1, 1)\n\n        # 4. Solve Lyapunov Equations\n        P = linalg.solve_continuous_lyapunov(A, -Bs_col @ Bs_col.T)\n        Q = linalg.solve_continuous_lyapunov(A.T, -C.T @ C)\n\n        # 5. Hankel Singular Values\n        hsv_sq = linalg.eigvals(P @ Q)\n        # Eigenvalues of PQ should be real, but can have small imag part due to numerics\n        hsv = np.sqrt(np.abs(hsv_sq))\n        hsv_sorted = np.sort(hsv)[::-1]\n\n        return list(hsv_sorted[:3])\n\n    # Test Case 1\n    result1 = solve_pod_case(\n        N=40, L=1.0, d=0.02, lmbda=1.5, r=6, T=1.0, dt=0.002,\n        bc_type='dirichlet-dirichlet',\n        w_func=lambda t: np.sin(2 * np.pi * t),\n        b_func=lambda x: np.exp(-((x - 0.5) / 0.1)**2)\n    )\n\n    # Test Case 2\n    result2 = solve_pod_case(\n        N=40, L=1.0, d=0.05, lmbda=0.5, r=5, T=1.0, dt=0.002,\n        bc_type='dirichlet-neumann',\n        w_func=lambda t: np.cos(2 * np.pi * t),\n        b_func=lambda x: np.exp(-((x - 0.3) / 0.08)**2)\n    )\n\n    # Test Case 3\n    result3 = solve_bt_case(\n        N=20, L=1.0, d=0.03, lmbda=1.0,\n        b_func=lambda x: np.exp(-((x - 0.6) / 0.12)**2),\n        c_func=lambda x: np.exp(-((x - 0.6) / 0.12)**2)\n    )\n\n    result3_str = f\"[{','.join(map(str, result3))}]\"\n    print(f\"[{result1},{result2},{result3_str}]\")\n\nsolve()\n```"
        }
    ]
}