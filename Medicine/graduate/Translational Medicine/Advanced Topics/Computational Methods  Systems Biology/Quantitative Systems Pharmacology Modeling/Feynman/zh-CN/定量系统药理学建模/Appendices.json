{
    "hands_on_practices": [
        {
            "introduction": "定量系统药理学(QSP)模型建立在对药物在体内动态过程的数学描述之上。本练习将引导你通过一个基础但至关重要的实践：从一个经典的二室模型出发，推导药物在持续静脉输注下达到的稳态浓度。这个过程不仅能帮助你掌握从微分方程系统求解关键药代动力学参数的基本技能，还能让你深刻理解决定长期药物暴露水平的核心生理参数。",
            "id": "5053528",
            "problem": "考虑一个用于定量系统药理学 (QSP) 的双室药物分布模型，其中药物通过恒速静脉输注进入中央室。设中央室的容积为 $V_{1}$，外周室的容积为 $V_{2}$。分别用 $A_{1}(t)$ 和 $A_{2}(t)$ 表示中央室和外周室中的药物量，相应的浓度为 $C_{1}(t) = A_{1}(t)/V_{1}$ 和 $C_{2}(t) = A_{2}(t)/V_{2}$。从中央室的药物消除由系统清除率 $CL$ 表征，中央室和外周室之间的双向分布由室间清除率 $Q$ 表征。药物以恒定速率 $R_{0}$ 输注到中央室。\n\n根据质量守恒和线性清除率驱动的流动的定义，药物量的控制性常微分方程 (ODE) 为：\n$$\n\\frac{dA_{1}}{dt} = R_{0} - CL \\, C_{1}(t) - Q \\, C_{1}(t) + Q \\, C_{2}(t),\n$$\n$$\n\\frac{dA_{2}}{dt} = Q \\, C_{1}(t) - Q \\, C_{2}(t).\n$$\n假设在恒速输注下达到稳态。通过求解 $\\frac{dA_{1}}{dt} = 0$ 和 $\\frac{dA_{2}}{dt} = 0$，计算稳态中央室浓度 $C_{ss} = C_{1}(\\infty)$，并用 $R_{0}$、$CL$、$Q$、$V_{1}$ 和 $V_{2}$ 表示 $C_{ss}$。将最终答案表示为单一的封闭形式解析表达式，并以 $\\mathrm{mg/L}$ 为单位表示浓度。无需进行数值计算或四舍五入。",
            "solution": "该问题要求计算在恒速静脉输注的双室药代动力学模型中，稳态中央室浓度 $C_{ss}$。\n\n### 步骤 1：问题验证\n\n首先，对问题陈述进行严格验证。\n\n**1.1. 提取的已知条件：**\n- **模型：** 双室药代动力学模型。\n- **室容积：** 中央室容积 $V_{1}$，外周室容积 $V_{2}$。\n- **药物量：** 中央室为 $A_{1}(t)$，外周室为 $A_{2}(t)$。\n- **浓度：** $C_{1}(t) = A_{1}(t)/V_{1}$，$C_{2}(t) = A_{2}(t)/V_{2}$。\n- **输注速率：** 以恒定速率 $R_{0}$ 进入中央室。\n- **清除率参数：** 系统清除率 $CL$，室间清除率 $Q$。\n- **控制性常微分方程 (ODE)：**\n$$\n\\frac{dA_{1}}{dt} = R_{0} - CL \\, C_{1}(t) - Q \\, C_{1}(t) + Q \\, C_{2}(t)\n$$\n$$\n\\frac{dA_{2}}{dt} = Q \\, C_{1}(t) - Q \\, C_{2}(t)\n$$\n- **目标：** 计算稳态中央室浓度 $C_{ss} = C_{1}(\\infty)$。\n- **条件：** 稳态由 $\\frac{dA_{1}}{dt} = 0$ 和 $\\frac{dA_{2}}{dt} = 0$ 定义。\n- **解中所需参数：** $C_{ss}$ 的解应以 $R_{0}$、$CL$、$Q$、$V_{1}$ 和 $V_{2}$ 表示。\n\n**1.2. 对照标准进行验证：**\n- **科学基础：** 该问题描述了药代动力学和定量系统药理学中一个标准且广泛使用的双室模型。方程基于质量守恒原理。该模型在科学上是合理的。\n- **适定性：** 问题要求解一个线性常微分方程组的稳态解。这可以转化为求解一个线性代数方程组，这是一个适定的数学任务，会产生唯一解。\n- **客观性：** 问题陈述使用了精确且无歧义的技术语言。所有变量和参数都得到了明确定义。\n- **完整性与一致性：** 提供了求解所需的所有必要方程和条件。问题要求答案用参数 $R_{0}$、$CL$、$Q$、$V_{1}$ 和 $V_{2}$ 表示。最终表达式可能不依赖于所有这些参数，但这是系统属性的结果，而非问题陈述中的不一致。问题并未说明最终表达式*必须*包含所有这些变量。\n- **其他缺陷：** 该问题没有事实错误、不切实际的条件或逻辑谬误。\n\n**1.3. 结论：**\n该问题被判定为**有效**。这是一个定义明确、有科学依据的药代动力学问题。\n\n### 步骤 2：解的推导\n\n我们的任务是找到中央室的稳态浓度 $C_{ss}$，其定义为当 $t \\to \\infty$ 时的 $C_{1}(t)$。在稳态下，每个室中的药物量是恒定的，这意味着药物量的时间导数为零。\n\n设 $C_{1,ss}$ 和 $C_{2,ss}$ 分别为中央室和外周室的稳态浓度。问题定义 $C_{ss} = C_{1,ss}$。稳态条件是：\n$$\n\\frac{dA_{1}}{dt} = 0\n$$\n$$\n\\frac{dA_{2}}{dt} = 0\n$$\n\n将此条件应用于给定的常微分方程组，我们得到一个代数方程组：\n$$\n0 = R_{0} - CL \\, C_{1,ss} - Q \\, C_{1,ss} + Q \\, C_{2,ss} \\quad \\quad (1)\n$$\n$$\n0 = Q \\, C_{1,ss} - Q \\, C_{2,ss} \\quad \\quad (2)\n$$\n\n我们可以求解该方程组以得到 $C_{1,ss}$。由方程 $(2)$ 可得：\n$$\nQ \\, C_{1,ss} = Q \\, C_{2,ss}\n$$\n假设 $Q > 0$（一个非零的室间清除率是区分双室模型和单室模型的必要条件），我们可以将两边同除以 $Q$：\n$$\nC_{1,ss} = C_{2,ss}\n$$\n这个结果在物理上是直观的：在恒速输注的稳态下，药物已在整个系统中分布，直至相连室中的浓度相等，导致它们之间的净通量为零。\n\n现在，我们将结果 $C_{2,ss} = C_{1,ss}$ 代入方程 $(1)$：\n$$\n0 = R_{0} - CL \\, C_{1,ss} - Q \\, C_{1,ss} + Q \\, C_{1,ss}\n$$\n涉及室间清除率的项，即 $- Q \\, C_{1,ss}$ 和 $+ Q \\, C_{1,ss}$，相互抵消：\n$$\n0 = R_{0} - CL \\, C_{1,ss}\n$$\n这个简化后的方程表明，在稳态下，药物输注速率 ($R_{0}$) 与药物消除速率 ($CL \\, C_{1,ss}$) 完全平衡。\n\n最后，我们求解 $C_{1,ss}$：\n$$\nCL \\, C_{1,ss} = R_{0}\n$$\n$$\nC_{1,ss} = \\frac{R_{0}}{CL}\n$$\n由于问题定义 $C_{ss} = C_{1,ss}$，最终表达式为：\n$$\nC_{ss} = \\frac{R_{0}}{CL}\n$$\n稳态浓度仅取决于输注速率和系统清除率。参数 $Q$、$V_{1}$ 和 $V_{2}$ 影响系统接近稳态的动力学过程，但本身不影响稳态浓度的值。最终表达式是按要求给出的封闭形式解析表达式。“以 $\\mathrm{mg/L}$ 表示浓度”的指令被解释为指定量 $C_{ss}$ 的物理单位，这取决于为 $R_0$ 和 $CL$ 选择的单位，而不需要在最终的数学表达式中包含单位。",
            "answer": "$$\\boxed{\\frac{R_{0}}{CL}}$$"
        },
        {
            "introduction": "为了精确预测药物在体内的分布，QSP模型必须准确描述药物如何进入不同组织。本练习将带你深入探究生理药代动力学模型的核心：推导有效组织清除率($CL_{\\text{tissue}}$)。通过从质量守恒和扩散通量的基本原理出发，你将揭示血流灌注($Q$)与膜通透性-表面积乘积($PS$)之间的关键数学关系，并学会判断药物摄取过程是受灌注限制还是通透性限制，这是构建器官水平药物分布模型的必备技能。",
            "id": "5053584",
            "problem": "在一个用于定量系统药理学 (QSP) 的生理学基础组织模块中，考虑一个用于在组织中无代谢的被动分布小分子的单室充分混合毛细血管-组织交换单位。设组织的体积血流量为 $Q$，内皮的渗透性-表面积乘积为 $PS$。假设以下基于物理原理的陈述成立：\n- 毛细血管段的质量守恒得出，$Q\\,(C_{a}(t) - C_{v}(t))$ 等于在时间 $t$ 穿过内皮进入组织的净扩散通量，其中 $C_{a}(t)$ 和 $C_{v}(t)$ 分别是动脉和静脉的未结合血浆药物浓度。\n- 穿过内皮屏障的扩散通量与穿过屏障的未结合浓度驱动力成正比。如果平衡状态下未结合的组织-血浆分配系数为 $K_{p}$，则穿过屏障的驱动力差为 $C_{p,u} - C_{t,u}/K_{p}$，其中 $C_{p,u}$ 是毛细血管血浆未结合浓度，$C_{t,u}$ 是组织未结合浓度。在充分混合毛细血管的假设下，取 $C_{p,u} = C_{v}(t)$。\n- 组织中的总药物量 $A_{t}(t)$ 根据内皮扩散通量而变化，$dA_{t}/dt$ 等于该通量。通过以下线性关系定义有效组织清除率 $CL_{\\text{tissue}}$\n$$\n\\frac{dA_{t}}{dt} \\equiv CL_{\\text{tissue}}\\,\\big(C_{a}(t) - \\frac{C_{t,u}(t)}{K_{p}}\\big),\n$$\n这样，$CL_{\\text{tissue}}$ 就将灌注和渗透的综合限制集总为一个单一的一级交换系数，该系数乘以在分布平衡 $C_{t,u} = K_{p}\\,C_{a}$ 时消失的经典驱动力。\n\n仅从上述质量守恒和扩散通量的定义出发（不引用任何预先推导的清除率公式），推导出一个仅含 $PS$、$Q$ 和 $K_{p}$ 的 $CL_{\\text{tissue}}$ 的闭式解析表达式。作为推理的一部分，通过比较 $PS$ 和 $Q$ 来确定哪种机制主导交换，并陈述区分灌注限制与渗透限制行为的标准。为便于解释，您可以假设 $C_{a}(t)$相对于毛细血管通过时间变化缓慢，因此在每个瞬间采用准稳态毛细血管近似是合适的。\n\n您的最终答案必须是一个仅用 $PS$、$Q$ 和 $K_{p}$ 表示的 $CL_{\\text{tissue}}$ 的单一解析表达式。最终答案中不要包含任何单位或数值计算。如果您选择使用示例值来说明机制分类，请不要在最终的方框答案中报告这些值。",
            "solution": "该问题要求在一个充分混合的毛细血管-组织交换单位中，基于质量输运的基本原理，推导有效组织清除率 $CL_{\\text{tissue}}$ 的表达式。推导必须从所提供的关于质量守恒和扩散通量的陈述开始。\n\n给定的原理如下：\n1.  在准稳态近似下，毛细血管段的质量守恒指出，药物在流经毛细血管时从血液中移除的速率等于进入组织的净扩散通量。这表示为：\n    $$Q \\left( C_{a}(t) - C_{v}(t) \\right) = \\text{净扩散通量}$$\n    此处，$Q$ 是体积血流量，$C_{a}(t)$ 是进入毛细血管的动脉未结合血浆浓度，$C_{v}(t)$ 是离开毛细血管的静脉未结合血浆浓度。\n\n2.  穿过内皮屏障的净扩散通量与渗透性-表面积乘积 $PS$ 以及穿过屏障的浓度梯度成正比。驱动力被指定为 $C_{p,u} - C_{t,u}/K_{p}$，其中 $C_{p,u}$ 是毛细血管血浆未结合浓度，$C_{t,u}(t)$ 是组织未结合浓度，$K_{p}$ 是未结合的组织-血浆分配系数。\n    $$\\text{净扩散通量} = PS \\left( C_{p,u} - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n\n3.  模型假设毛细血管是充分混合的，这意味着毛细血管内的浓度是均匀的，并等于流出浓度。因此，毛细血管血浆未结合浓度 $C_{p,u}$ 被取为静脉浓度 $C_{v}(t)$。\n    $$C_{p,u} = C_{v}(t)$$\n\n4.  组织中总药物量 $A_{t}(t)$ 的变化率等于来自毛细血管的净扩散通量。\n    $$\\frac{dA_{t}(t)}{dt} = \\text{净扩散通量}$$\n\n5.  最后，有效组织清除率 $CL_{\\text{tissue}}$ 由以下关系定义，该关系将组织摄取速率构建为一个清除率参数乘以一个系统驱动力的形式：\n    $$\\frac{dA_{t}(t)}{dt} \\equiv CL_{\\text{tissue}} \\left( C_{a}(t) - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n\n我们的目标是找到一个用 $Q$、$PS$ 和 $K_{p}$ 表示的 $CL_{\\text{tissue}}$ 的表达式。\n\n首先，我们结合基本原理来获得净通量的表达式。将充分混合的假设 (3) 代入扩散通量方程 (2)，我们得到：\n$$\\text{净扩散通量} = PS \\left( C_{v}(t) - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n我们称之为方程 (A)。\n\n根据毛细血管质量平衡 (1)，我们有另一个通量表达式：\n$$\\text{净扩散通量} = Q \\left( C_{a}(t) - C_{v}(t) \\right)$$\n我们称之为方程 (B)。\n\n由于方程 (A) 和方程 (B) 都描述了相同的净通量，我们可以让它们相等：\n$$Q \\left( C_{a}(t) - C_{v}(t) \\right) = PS \\left( C_{v}(t) - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n$CL_{\\text{tissue}}$ 的定义 (5) 将净通量与 $C_{a}(t)$ 和 $C_{t,u}(t)$ 联系起来。为了使我们推导出的通量表达式与此定义一致，我们必须消去中间变量 $C_{v}(t)$。我们重新整理上面的方程来求解 $C_{v}(t)$：\n$$Q C_{a}(t) - Q C_{v}(t) = PS C_{v}(t) - PS \\frac{C_{t,u}(t)}{K_{p}}$$\n$$Q C_{a}(t) + PS \\frac{C_{t,u}(t)}{K_{p}} = (Q + PS) C_{v}(t)$$\n$$C_{v}(t) = \\frac{Q C_{a}(t) + PS \\frac{C_{t,u}(t)}{K_{p}}}{Q + PS}$$\n\n现在，我们将这个 $C_{v}(t)$ 的表达式代回到其中一个通量方程中，例如方程 (B)：\n$$\\text{净扩散通量} = Q \\left( C_{a}(t) - \\frac{Q C_{a}(t) + PS \\frac{C_{t,u}(t)}{K_{p}}}{Q + PS} \\right)$$\n为了简化，我们为括号内的项找到一个公分母：\n$$\\text{净扩散通量} = Q \\left( \\frac{C_{a}(t) (Q + PS) - \\left(Q C_{a}(t) + PS \\frac{C_{t,u}(t)}{K_{p}}\\right)}{Q + PS} \\right)$$\n展开分子：\n$$\\text{净扩散通量} = Q \\left( \\frac{Q C_{a}(t) + PS C_{a}(t) - Q C_{a}(t) - PS \\frac{C_{t,u}(t)}{K_{p}}}{Q + PS} \\right)$$\n$Q C_{a}(t)$ 项相互抵消：\n$$\\text{净扩散通量} = Q \\left( \\frac{PS C_{a}(t) - PS \\frac{C_{t,u}(t)}{K_{p}}}{Q + PS} \\right)$$\n从分子中提出公因子 $PS$：\n$$\\text{净扩散通量} = \\frac{Q \\cdot PS}{Q + PS} \\left( C_{a}(t) - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n\n这个净通量的表达式是从问题中给出的第一性原理推导出来的。现在我们将这个结果与 $CL_{\\text{tissue}}$ 的定义方程 (5) 进行比较：\n$$\\frac{dA_{t}(t)}{dt} = \\text{净扩散通量} = CL_{\\text{tissue}} \\left( C_{a}(t) - \\frac{C_{t,u}(t)}{K_{p}} \\right)$$\n通过直接比较净扩散通量的两个表达式（一个从第一性原理推导，另一个来自 $CL_{\\text{tissue}}$ 的定义），我们可以确定 $CL_{\\text{tissue}}$ 的表达式：\n$$CL_{\\text{tissue}} = \\frac{Q \\cdot PS}{Q + PS}$$\n请注意，组织分配系数 $K_{p}$ 没有出现在 $CL_{\\text{tissue}}$ 的最终表达式中。这是因为问题将 $CL_{\\text{tissue}}$ 定义为相对于一个驱动力 $C_{a}(t) - C_{t,u}(t)/K_{p}$，该驱动力已经考虑了平衡分配行为。\n\n接下来，我们分析 $CL_{\\text{tissue}}$ 的表达式以确定交换的机制。该表达式可以重写为：\n$$CL_{\\text{tissue}} = \\frac{1}{\\frac{Q+PS}{Q \\cdot PS}} = \\frac{1}{\\frac{1}{PS} + \\frac{1}{Q}}$$\n这种形式表明，组织摄取的总阻力 $1/CL_{\\text{tissue}}$ 是渗透相关阻力 $1/PS$ 和灌注相关阻力 $1/Q$ 的总和。总清除率是 $Q$ 和 $PS$ 的调和平均值。\n\n区分限制性行为的标准取决于 $Q$ 和 $PS$ 的相对大小：\n1.  **灌注限制机制 (Perfusion-limited regime)**：当渗透性远大于血流量时，即 $PS \\gg Q$，就会发生这种情况。在这种情况下，膜对扩散的屏障作用可以忽略不计。项 $1/PS$ 与 $1/Q$ 相比可以忽略。\n    $$PS \\gg Q \\implies Q+PS \\approx PS$$\n    $$CL_{\\text{tissue}} = \\frac{Q \\cdot PS}{Q + PS} \\approx \\frac{Q \\cdot PS}{PS} = Q$$\n    在这种机制下，组织清除率约等于血流量，意味着药物摄取受限于药物输送到组织的速率。\n\n2.  **渗透限制机制 (Permeability-limited regime)**：当血流量远大于渗透性时，即 $Q \\gg PS$，就会发生这种情况。在这种情况下，药物供应充足，但其穿过内皮屏障的过程很慢。项 $1/Q$ 与 $1/PS$ 相比可以忽略。\n    $$Q \\gg PS \\implies Q+PS \\approx Q$$\n    $$CL_{\\text{tissue}} = \\frac{Q \\cdot PS}{Q + PS} \\approx \\frac{Q \\cdot PS}{Q} = PS$$\n    在这种机制下，组织清除率约等于渗透性-表面积乘积，意味着药物摄取受限于穿过毛细血管壁的扩散速率。\n\n因此，区分这两种行为的标准是比较 $PS$ 和 $Q$。当 $PS \\gg Q$ 时，系统是灌注限制的；当 $PS \\ll Q$ 时，系统是渗透限制的。当 $PS$ 和 $Q$ 的数量级相近时，发生从一种机制到另一种机制的过渡。",
            "answer": "$$\\boxed{\\frac{Q \\cdot PS}{Q + PS}}$$"
        },
        {
            "introduction": "QSP模型的价值最终取决于其描述和预测现实世界数据的能力。这项高级编程练习将引导你实践现代贝叶斯模型验证的基石——后验预测检验(PPC)。通过亲手实现这一强大的诊断工具，你将学会如何利用已拟合的模型生成“复制”数据集，并将其与观测数据进行系统性比较，从而定量评估模型的校准质量，发现模型可能存在的结构性缺陷。",
            "id": "5053544",
            "problem": "要求您在一个简单的定量系统药理学（QSP）设置中，通过在拟合模型下生成重复数据集并计算差异度量以评估校准质量，为一个药效学（PD）终点实现后验预测检验。您必须从基本的贝叶斯生成建模原理推导出算法，并将其实现为一个程序，该程序为一组预定义的测试用例输出数值诊断。\n\n建模背景：\n- 我们考虑一个具有一级消除的单室静脉推注药代动力学（PK）模型。对于在时间 $0$ 给药的剂量，在时间 $t$ 的血浆浓度由下式给出\n$$\nC(t \\mid \\text{Dose}, CL, V) \\;=\\; \\frac{\\text{Dose}}{V} \\,\\exp\\!\\left(-\\frac{CL}{V}\\, t\\right),\n$$\n其中 $CL$ 是清除率，$V$ 是分布容积。\n- PD终点是在时间 $\\{t_i\\}_{i=1}^n$ 测量的生物标志物，它通过一个标准的抑制性 $E_{\\max}$ 结构对浓度产生瞬时响应：\n$$\n\\mu_i(\\theta) \\;=\\; E_0 \\;-\\; I_{\\max} \\,\\frac{C(t_i)}{IC_{50} + C(t_i)},\n$$\n并带有加性测量噪声：\n$$\nY_i \\mid \\theta \\;\\sim\\; \\mathcal{N}\\!\\big(\\mu_i(\\theta), \\sigma^2\\big),\n$$\n其中 $\\theta = (CL, V, IC_{50}, I_{\\max}, E_0, \\sigma)$。\n\n贝叶斯后验预测检验（PPC）：\n- 重复数据集 $Y^{\\mathrm{rep}}$ 的后验预测分布是\n$$\np\\!\\left(Y^{\\mathrm{rep}} \\mid Y\\right) \\;=\\; \\int p\\!\\left(Y^{\\mathrm{rep}} \\mid \\theta\\right)\\, p\\!\\left(\\theta \\mid Y\\right)\\, d\\theta.\n$$\n- 使用差异函数 $D(\\cdot,\\cdot)$ 的后验预测p值是\n$$\np_{\\mathrm{ppc}} \\;=\\; \\mathbb{P}\\!\\left( D\\!\\left(Y^{\\mathrm{rep}}, \\theta\\right) \\;\\ge\\; D\\!\\left(Y, \\theta\\right) \\,\\Big|\\, Y \\right) \\;\\approx\\; \\frac{1}{M}\\sum_{m=1}^M \\mathbf{1}\\!\\left\\{ D\\!\\left(Y^{\\mathrm{rep}}_{(m)}, \\theta_{(m)}\\right) \\ge D\\!\\left(Y, \\theta_{(m)}\\right) \\right\\},\n$$\n其中 $\\{\\theta_{(m)}\\}_{m=1}^M$ 是从 $p(\\theta \\mid Y)$ 中抽取的样本，且 $Y^{\\mathrm{rep}}_{(m)} \\sim p(Y \\mid \\theta_{(m)})$。\n- 您将评估两个差异函数：\n  1. 标准化平方和：\n     $$\n     D_{\\mathrm{SSR}}(Y,\\theta) \\;=\\; \\sum_{i=1}^n \\left(\\frac{Y_i - \\mu_i(\\theta)}{\\sigma}\\right)^2.\n     $$\n  2. 最大绝对标准化残差：\n     $$ \n     D_{\\mathrm{MAX}}(Y,\\theta) \\;=\\; \\max_{1 \\le i \\le n}\\left| \\frac{Y_i - \\mu_i(\\theta)}{\\sigma} \\right|.\n     $$\n\n后验近似：\n- 假设在变换后的参数空间上存在一个分解的高斯后验，以确保支撑集的一致性：\n  - 令 $\\phi = (\\log CL,\\, \\log V,\\, \\log IC_{50},\\, \\mathrm{logit}(I_{\\max}),\\, E_0,\\, \\log \\sigma)$。\n  - 后验分布为 $\\phi \\sim \\mathcal{N}(\\mu_{\\phi}, \\mathrm{diag}(\\sigma_{\\phi}^2))$，各分量独立。\n  - 通过 $CL=\\exp(\\log CL)$，$V=\\exp(\\log V)$，$IC_{50}=\\exp(\\log IC_{50})$，$I_{\\max} = \\mathrm{logistic}(\\mathrm{logit}(I_{\\max}))$，$E_0$ 恒等变换，$\\sigma=\\exp(\\log \\sigma)$ 进行反变换。\n\n模拟和单位约定：\n- 时间 $t$ 的单位是 $\\mathrm{h}$（小时），剂量单位是 $\\mathrm{mg}$（毫克），浓度单位是 $\\mathrm{mg/L}$，PD终点单位是任意单位 $(\\mathrm{a.u.})$。\n- 对于观测数据集 $Y$，使用下面指定的种子从真实数据生成过程生成它们。所有输出（后验预测p值）都是无量纲的；将它们报告为四舍五入到 $3$ 位小数的小数。\n\n测试套件：\n- 每个测试用例使用 $M = 4000$ 次后验抽样。对于每个案例，使用其指定的随机种子生成观测数据集 $Y$，并使用一个单独的种子生成后验抽样和重复数据集。所有案例的剂量都固定为 $\\text{Dose} = 100\\,\\mathrm{mg}$。\n- 用于在所有案例中生成观测数据的真实参数：\n  - $CL^{\\star} = 5\\,\\mathrm{L/h}$，$V^{\\star} = 20\\,\\mathrm{L}$，$IC_{50}^{\\star} = 1\\,\\mathrm{mg/L}$，$I_{\\max}^{\\star} = 0.8$，$E_0^{\\star} = 100\\,\\mathrm{a.u.}$，$\\sigma^{\\star} = 3\\,\\mathrm{a.u.}$。\n- $\\phi = (\\log CL, \\log V, \\log IC_{50}, \\mathrm{logit}(I_{\\max}), E_0, \\log \\sigma)$ 的后验分布参数由每个案例的 $(\\mu_{\\phi}, \\sigma_{\\phi})$ 给出，如下所示：\n\n案例A（良好校准；理想路径）：\n- 时间点：$[0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0]\\,\\mathrm{h}$。\n- 观测数据种子：$1001$。\n- 重复生成种子：$7771$。\n- 后验均值：$\\mu_{\\phi} = [\\log 5,\\, \\log 20,\\, \\log 1,\\, \\mathrm{logit}(0.8),\\, 100,\\, \\log 3]$。\n- 后验标准差：$\\sigma_{\\phi} = [0.1,\\, 0.1,\\, 0.1,\\, 0.2,\\, 1.0,\\, 0.1]$。\n\n案例B（噪声低估；方差失准）：\n- 时间点：$[0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0]\\,\\mathrm{h}$。\n- 观测数据种子：$1002$。\n- 重复生成种子：$7772$。\n- 后验均值：$\\mu_{\\phi} = [\\log 5,\\, \\log 20,\\, \\log 1,\\, \\mathrm{logit}(0.8),\\, 100,\\, \\log 1.5]$。\n- 后验标准差：$\\sigma_{\\phi} = [0.1,\\, 0.1,\\, 0.1,\\, 0.2,\\, 1.0,\\, 0.1]$。\n\n案例C（PK结构偏差；动力学失准）：\n- 时间点：$[0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0]\\,\\mathrm{h}$。\n- 观测数据种子：$1003$。\n- 重复生成种子：$7773$。\n- 后验均值：$\\mu_{\\phi} = [\\log 8,\\, \\log 15,\\, \\log 1,\\, \\mathrm{logit}(0.8),\\, 100,\\, \\log 3]$。\n- 后验标准差：$\\sigma_{\\phi} = [0.1,\\, 0.1,\\, 0.1,\\, 0.2,\\, 1.0,\\, 0.1]$。\n\n案例D（边界条件；最少采样时间）：\n- 时间点：$[1.0, 24.0]\\,\\mathrm{h}$。\n- 观测数据种子：$1004$。\n- 重复生成种子：$7774$。\n- 后验均值：$\\mu_{\\phi} = [\\log 5,\\, \\log 20,\\, \\log 1,\\, \\mathrm{logit}(0.8),\\, 100,\\, \\log 3]$。\n- 后验标准差：$\\sigma_{\\phi} = [0.1,\\, 0.1,\\, 0.1,\\, 0.2,\\, 1.0,\\, 0.1]$。\n\n程序要求：\n- 为每个案例实现PPC，以计算两个后验预测p值：使用 $D_{\\mathrm{SSR}}$ 的 $p_{\\mathrm{SSR}}$，和使用 $D_{\\mathrm{MAX}}$ 的 $p_{\\mathrm{MAX}}$。\n- 每个案例确切使用 $M = 4000$ 次后验抽样。\n- 对于观测数据生成，为每个案例使用指定的观测数据种子设置一个NumPy随机数生成器。对于后验抽样和重复数据生成，为每个案例使用指定的重复生成种子设置一个单独的NumPy随机数生成器。\n- 最终输出格式：您的程序应生成单行输出，包含一个逗号分隔的扁平列表，其中包含所有p值，顺序为 $[p_{\\mathrm{SSR}}^{A}, p_{\\mathrm{MAX}}^{A}, p_{\\mathrm{SSR}}^{B}, p_{\\mathrm{MAX}}^{B}, p_{\\mathrm{SSR}}^{C}, p_{\\mathrm{MAX}}^{C}, p_{\\mathrm{SSR}}^{D}, p_{\\mathrm{MAX}}^{D}]$，并用方括号括起来，每个值四舍五入到 $3$ 位小数（例如，$[0.512,0.438, \\dots]$）。",
            "solution": "该问题要求为一个指定的药代动力学/药效学（PK/PD）模型实现贝叶斯后验预测检验（PPC）。目标是通过将观测数据与从模型的后验预测分布中重复生成的数据进行比较，来评估模型的校准质量。此过程将针对四个不同的测试用例执行，每个用例代表一种不同的潜在建模情景。\n\n该解决方案基于生成式贝叶斯建模和模型检验的基本原理设计。整个算法可以分解为以下几个步骤：模型定义、数据模拟、后验抽样和差异计算。\n\n**1. 模型设定**\n\n该系统由一个耦合的PK/PD模型描述。\n\n*   **药代动力学（PK）**：以静脉推注方式在时间 $t=0$ 给药的药物，其血浆浓度 $C(t)$ 服从具有一级消除的单室模型。对于给定的剂量（$\\text{Dose}$）、清除率（$CL$）和分布容积（$V$），在时间 $t$ 的浓度为：\n    $$\n    C(t) = \\frac{\\text{Dose}}{V} \\exp\\left(-\\frac{CL}{V} t\\right)\n    $$\n*   **药效学（PD）**：生物标志物的响应通过一个瞬时抑制性 $E_{\\max}$ 模型与药物浓度相关联。在时间 $t_i$ 的平均响应 $\\mu_i$ 是模型参数 $\\theta = (CL, V, IC_{50}, I_{\\max}, E_0, \\sigma)$ 的函数：\n    $$\n    \\mu_i(\\theta) = E_0 - I_{\\max} \\frac{C(t_i)}{IC_{50} + C(t_i)}\n    $$\n    其中 $E_0$ 是基线效应，$I_{\\max}$ 是最大分数抑制，$IC_{50}$ 是达到 $50\\%$ 最大抑制时的浓度。\n*   **观测模型**：观测数据点 $Y_i$ 假定在平均响应 $\\mu_i$ 周围呈正态分布，具有恒定方差 $\\sigma^2$：\n    $$\n    Y_i \\mid \\theta \\sim \\mathcal{N}(\\mu_i(\\theta), \\sigma^2)\n    $$\n\n**2. 贝叶斯后验预测检验（PPC）框架**\n\nPPC的核心思想是通过检查从拟合模型生成的数据 $Y^{\\text{rep}}$ 是否与观测数据 $Y$ 相似，来评估模型的拟合优度。如果模型能很好地描述数据生成过程，那么 $Y^{\\text{rep}}$ 在统计上应与 $Y$ 相似。\n\n这种比较通过使用差异函数 $D(Y, \\theta)$ 来形式化，该函数衡量了在给定参数集 $\\theta$ 下，数据 $Y$ 与模型预测之间的拟合不足程度。后验预测p值是在 $\\theta$ 的后验分布上取平均后，重复生成数据的差异比观测数据的差异更极端的概率：\n$$\np_{\\text{ppc}} = \\mathbb{P}(D(Y^{\\text{rep}}, \\theta) \\ge D(Y, \\theta) \\mid Y)\n$$\n极端的p值（接近 $0$ 或 $1$）表明模型与数据之间存在系统性失配。p值在 $0.5$ 左右表示相对于所选的差异度量，模型具有良好的校准。\n\n在数值上，这通过使用从后验分布 $p(\\theta \\mid Y)$ 中抽取的 $M$ 个样本 $\\{\\theta_{(m)}\\}_{m=1}^M$ 来近似：\n1.  对于每个后验样本 $\\theta_{(m)}$：\n    a. 计算观测数据的差异：$D_{\\text{obs}}^{(m)} = D(Y, \\theta_{(m)})$。\n    b. 生成一个重复数据集 $Y^{\\text{rep}}_{(m)} \\sim p(Y \\mid \\theta_{(m)})$。\n    c. 计算重复生成数据的差异：$D_{\\text{rep}}^{(m)} = D(Y^{\\text{rep}}_{(m)}, \\theta_{(m)})$。\n2.  将p值计算为重复数据差异大于或等于观测数据差异的样本所占的比例：\n    $$\n    p_{\\text{ppc}} \\approx \\frac{1}{M} \\sum_{m=1}^M \\mathbf{1}\\{ D_{\\text{rep}}^{(m)} \\ge D_{\\text{obs}}^{(m)} \\}\n    $$\n\n**3. 参数化和后验模拟**\n\n问题在变换后的参数空间 $\\phi$ 上指定了一个近似后验分布，以确保每个参数都有合适的支撑集（$CL, V, IC_{50}, \\sigma > 0$ 且 $0  I_{\\max}  1$）。\n变换为 $\\phi = (\\log CL, \\log V, \\log IC_{50}, \\text{logit}(I_{\\max}), E_0, \\log \\sigma)$，其中 $\\text{logit}(p) = \\log(p/(1-p))$。后验分布被给定为一个具有对角协方差矩阵的多元正态分布：\n$$\n\\phi \\sim \\mathcal{N}(\\mu_{\\phi}, \\text{diag}(\\sigma_{\\phi}^2))\n$$\n算法需要从该分布中抽取 $M=4000$ 个 $\\phi$ 的样本，然后应用反变换来获得 $\\theta$ 的样本：\n*   $CL = \\exp(\\phi_{CL})$\n*   $V = \\exp(\\phi_{V})$\n*   $IC_{50} = \\exp(\\phi_{IC_{50}})$\n*   $I_{\\max} = \\text{logistic}(\\phi_{I_{\\max}}) = 1 / (1 + \\exp(-\\phi_{I_{\\max}}))$\n*   $E_0 = \\phi_{E_0}$\n*   $\\sigma = \\exp(\\phi_{\\sigma})$\n\n**4. 差异函数**\n\n指定了两个差异函数来探究模型拟合的不同方面：\n1.  **标准化平方和（$D_{\\text{SSR}}$）**：该度量衡量整体的方差失配。\n    $$\n    D_{\\mathrm{SSR}}(Y,\\theta) = \\sum_{i=1}^n \\left(\\frac{Y_i - \\mu_i(\\theta)}{\\sigma}\\right)^2\n    $$\n2.  **最大绝对标准化残差（$D_{\\text{MAX}}$）**：该度量衡量单个最差预测的量级，使其对离群值或局部模型失效敏感。\n    $$\n    D_{\\mathrm{MAX}}(Y,\\theta) = \\max_{1 \\le i \\le n}\\left| \\frac{Y_i - \\mu_i(\\theta)}{\\sigma} \\right|\n    $$\n\n**5. 算法实现**\n\n对每个测试用例，实施以下程序：\n\n1.  **设置**：定义案例特定参数：测量时间点 $\\{t_i\\}$、后验分布参数 $(\\mu_{\\phi}, \\sigma_{\\phi})$ 和随机数生成器种子。设置常量 $\\text{Dose}=100\\,\\text{mg}$ 和 $M=4000$。\n\n2.  **生成观测数据**：使用指定的 `observed-data seed` 和提供的真实参数 $(\\theta^{\\star}, \\sigma^{\\star})$，生成单个观测数据集 $Y_{\\text{obs}}$。\n    a. 计算真实平均响应 $\\mu^{\\star}_i = \\mu_i(\\theta^{\\star})$。\n    b. 对所有 $i$，从 $\\mathcal{N}(\\mu^{\\star}_i, (\\sigma^{\\star})^2)$ 中抽取 $Y_i$。\n\n3.  **执行PPC**：使用指定的 `replication seed`：\n    a. **抽取后验样本**：从 $\\mathcal{N}(\\mu_{\\phi}, \\text{diag}(\\sigma_{\\phi}^2))$ 生成 $M$ 个变换后参数 $\\phi_{(m)}$ 的样本。变换这些样本以获得 $M$ 个原始参数 $\\theta_{(m)}$ 的样本。\n    b. **向量化计算**：为确保效率，计算在 $M$ 个样本上进行向量化。\n    c. **计算平均响应**：对于每个后验样本 $\\theta_{(m)}$，计算相应的平均响应向量 $\\mu_{(m)} = \\{\\mu_i(\\theta_{(m)})\\}_{i=1}^n$。这将产生一个大小为 $M \\times n$ 的平均响应矩阵。\n    d. **计算观测差异**：使用 $Y_{\\text{obs}}$ 和每对 $(\\mu_{(m)}, \\sigma_{(m)})$，计算包含 $M$ 个观测差异的向量 $\\{D(Y_{\\text{obs}}, \\theta_{(m)})\\}_{m=1}^M$，这针对 $D_{\\text{SSR}}$ 和 $D_{\\text{MAX}}$ 两种情况。\n    e. **生成重复数据**：对于每个样本 $m$，通过从 $\\mathcal{N}(\\mu_{(m)}, \\sigma_{(m)}^2)$ 中抽样来生成一个重复数据集 $Y^{\\text{rep}}_{(m)}$。这将产生一个大小为 $M \\times n$ 的重复数据矩阵。\n    f. **计算重复数据差异**：使用每个重复数据集 $Y^{\\text{rep}}_{(m)}$ 及其对应的模型 $(\\mu_{(m)}, \\sigma_{(m)})$，计算包含 $M$ 个重复数据差异的向量 $\\{D(Y^{\\text{rep}}_{(m)}, \\theta_{(m)})\\}_{m=1}^M$，这针对 $D_{\\text{SSR}}$ 和 $D_{\\text{MAX}}$ 两种情况。\n    g. **计算p值**：通过逐元素比较重复数据和观测数据的差异向量，并计算所得布尔向量的均值，来计算 $p_{\\text{SSR}}$ 和 $p_{\\text{MAX}}$。\n\n4.  **输出**：收集所有案例计算出的p值，四舍五入到三位小数，并格式化为指定的字符串格式。这个系统化的过程确保了对模型后验预测性能的可复现和正确评估。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import expit, logit\n\ndef solve():\n    \"\"\"\n    Implements a posterior predictive check for a PK/PD model across four test cases.\n    \"\"\"\n\n    def run_ppc(case_params):\n        \"\"\"\n        Runs the posterior predictive check for a single test case.\n        \"\"\"\n        # Unpack case parameters\n        times = np.array(case_params['times'])\n        obs_seed = case_params['obs_seed']\n        rep_seed = case_params['rep_seed']\n        mu_phi = np.array(case_params['mu_phi'])\n        sigma_phi = np.array(case_params['sigma_phi'])\n        \n        # Fixed model and simulation constants\n        Dose = 100.0\n        M = 4000\n        \n        # True parameters for generating observed data\n        CL_true, V_true, IC50_true = 5.0, 20.0, 1.0\n        Imax_true, E0_true, sigma_true = 0.8, 100.0, 3.0\n        \n        # --- Step 1: Generate Observed Data (Y_obs) ---\n        rng_obs = np.random.default_rng(obs_seed)\n        n_obs = len(times)\n        \n        # Calculate true concentration and mean PD response\n        C_true = (Dose / V_true) * np.exp(-(CL_true / V_true) * times)\n        mu_true = E0_true - Imax_true * (C_true / (IC50_true + C_true))\n        \n        # Generate the single observed dataset\n        Y_obs = rng_obs.normal(loc=mu_true, scale=sigma_true, size=n_obs)\n\n        # --- Step 2: Posterior Predictive Check Simulation ---\n        rng_rep = np.random.default_rng(rep_seed)\n        \n        # Generate M posterior samples for the transformed parameters phi\n        # phi = (logCL, logV, logIC50, logitImax, E0, logsigma)\n        phi_samples = rng_rep.normal(loc=mu_phi, scale=sigma_phi, size=(M, 6))\n        \n        # Transform phi samples back to the original theta parameter space\n        CL_s = np.exp(phi_samples[:, 0])\n        V_s = np.exp(phi_samples[:, 1])\n        IC50_s = np.exp(phi_samples[:, 2])\n        Imax_s = expit(phi_samples[:, 3])\n        E0_s = phi_samples[:, 4]\n        sigma_s = np.exp(phi_samples[:, 5])\n\n        # --- Step 3: Vectorized Calculations for Discrepancies ---\n        \n        # Calculate PK/PD model predictions for each of the M posterior samples.\n        # Shapes: CL_s (M,), V_s (M,), times (n_obs,). Resulting mu_matrix: (M, n_obs)\n        C_matrix = (Dose / V_s[:, None]) * np.exp(-(CL_s / V_s)[:, None] * times[None, :])\n        mu_matrix = E0_s[:, None] - Imax_s[:, None] * (C_matrix / (IC50_s[:, None] + C_matrix))\n\n        # Calculate discrepancies for OBSERVED data using each posterior sample\n        # Shapes: Y_obs (n_obs,), mu_matrix (M, n_obs), sigma_s (M,).\n        std_residuals_obs = (Y_obs[None, :] - mu_matrix) / sigma_s[:, None]\n        \n        D_ssr_obs = np.sum(std_residuals_obs**2, axis=1)\n        D_max_obs = np.max(np.abs(std_residuals_obs), axis=1)\n\n        # Generate REPLICATED data for each posterior sample\n        # Shapes: mu_matrix (M, n_obs), scale broadcasts from (M, 1) to (M, n_obs)\n        Y_rep_matrix = rng_rep.normal(loc=mu_matrix, scale=sigma_s[:, None])\n        \n        # Calculate discrepancies for REPLICATED data\n        std_residuals_rep = (Y_rep_matrix - mu_matrix) / sigma_s[:, None]\n        \n        D_ssr_rep = np.sum(std_residuals_rep**2, axis=1)\n        D_max_rep = np.max(np.abs(std_residuals_rep), axis=1)\n\n        # --- Step 4: Calculate Posterior Predictive p-values ---\n        p_ssr = np.mean(D_ssr_rep = D_ssr_obs)\n        p_max = np.mean(D_max_rep = D_max_obs)\n        \n        return p_ssr, p_max\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        { # Case A: Well-calibrated\n            \"times\": [0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0],\n            \"obs_seed\": 1001, \"rep_seed\": 7771,\n            \"mu_phi\": [np.log(5), np.log(20), np.log(1), logit(0.8), 100, np.log(3)],\n            \"sigma_phi\": [0.1, 0.1, 0.1, 0.2, 1.0, 0.1]\n        },\n        { # Case B: Underestimated noise\n            \"times\": [0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0],\n            \"obs_seed\": 1002, \"rep_seed\": 7772,\n            \"mu_phi\": [np.log(5), np.log(20), np.log(1), logit(0.8), 100, np.log(1.5)],\n            \"sigma_phi\": [0.1, 0.1, 0.1, 0.2, 1.0, 0.1]\n        },\n        { # Case C: PK structural bias\n            \"times\": [0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 24.0],\n            \"obs_seed\": 1003, \"rep_seed\": 7773,\n            \"mu_phi\": [np.log(8), np.log(15), np.log(1), logit(0.8), 100, np.log(3)],\n            \"sigma_phi\": [0.1, 0.1, 0.1, 0.2, 1.0, 0.1]\n        },\n        { # Case D: Minimal sampling times\n            \"times\": [1.0, 24.0],\n            \"obs_seed\": 1004, \"rep_seed\": 7774,\n            \"mu_phi\": [np.log(5), np.log(20), np.log(1), logit(0.8), 100, np.log(3)],\n            \"sigma_phi\": [0.1, 0.1, 0.1, 0.2, 1.0, 0.1]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        p_ssr, p_max = run_ppc(case)\n        results.extend([p_ssr, p_max])\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{x:.3f}\" for x in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}