{"hands_on_practices": [{"introduction": "我们将从构建连接任意起点 $a$ 和终点 $b$ 的通用布朗桥开始。这项练习至关重要，因为它揭示了布朗桥路径的两个最核心特征：其平均轨迹和围绕该轨迹的不确定性。我们将运用处理联合高斯随机变量的条件化方法，这是随机演算中的一项基石技能。", "problem": "设 $W_t$ 为一个标准布朗运动，定义为一个连续时间随机过程，满足 $W_0=0$，具有独立增量，并且对于每个 $t \\geq 0$，增量 $W_t-W_s$ 服从均值为 $0$、方差为 $t-s$ 的正态分布（其中 $0 \\leq s  t$）。考虑过程 $X_t=a+W_t$，其中 $a \\in \\mathbb{R}$ 为固定常数，并固定一个终端时间 $T>0$ 和一个终端值 $b \\in \\mathbb{R}$。将在区间 $[0,T]$ 上从 $a$ 到 $b$ 的布朗桥定义为在事件 $X_T=b$ 的条件下，过程 $\\{X_t:0 \\leq t \\leq T\\}$ 的条件过程。仅使用布朗运动的基本性质和联合正态随机变量的条件化理论，推导对于任意 $t \\in [0,T]$ 的期望 $\\mathbb{E}[X_t \\mid X_T=b]$ 和方差 $\\operatorname{Var}(X_t \\mid X_T=b)$。最终答案应写成一个单一的闭式解析表达式，其中包含 $\\mathbb{E}[X_t \\mid X_T=b]$ 和 $\\operatorname{Var}(X_t \\mid X_T=b)$。", "solution": "### 步骤 1：提取已知条件\n-   $W_t$ 是一个标准布朗运动：\n    -   $W_0 = 0$\n    -   连续时间随机过程\n    -   独立增量\n    -   对于 $0 \\leq s  t$，增量 $W_t - W_s$ 服从均值为 $0$、方差为 $t-s$ 的正态分布。\n-   一个随机过程 $X_t$ 定义为 $X_t = a + W_t$，其中 $a \\in \\mathbb{R}$ 为固定常数。\n-   $T > 0$ 是一个固定的终端时间。\n-   $b \\in \\mathbb{R}$ 是一个固定的终端值。\n-   布朗桥是在事件 $X_T = b$ 条件下的过程 $\\{X_t : 0 \\leq t \\leq T\\}$。\n-   任务是推导对于任意 $t \\in [0,T]$ 的条件期望 $\\mathbb{E}[X_t \\mid X_T=b]$ 和条件方差 $\\operatorname{Var}(X_t \\mid X_T=b)$。\n-   推导必须仅使用布朗运动的基本性质和联合正态随机变量的条件化理论。\n\n### 步骤 2：使用提取的已知条件进行验证\n根据验证标准评估问题陈述：\n1.  **科学性：** 该问题坚实地基于随机过程的标准数学理论，特别是布朗运动和布朗桥的定义。这些是概率论和金融数学中公认的概念。该问题在科学上和数学上是合理的。\n2.  **良态性：** 该问题是良态的。它要求在给定另一时刻的条件下，一个随机过程在特定时刻的前两个条件矩。高斯过程的框架保证了唯一且有意义的解的存在。\n3.  **客观性：** 语言精确、正式，没有任何主观性或歧义。\n4.  **完整性和一致性：** 所有必要的信息和定义（标准布朗运动、过程 $X_t$、条件事件）都已提供。没有矛盾之处。\n5.  **主题相关性：** 该问题直接关于*随机微分方程*领域内的*布朗桥和条件化*主题。\n\n### 步骤 3：结论与行动\n该问题有效。将提供完整的解答。\n\n### 解答推导\n问题的核心是求随机变量 $X_t$ 在给定随机变量 $X_T$ 的值时的条件分布。由于 $X_t$ 和 $X_T$ 是高斯过程（$W_t$）的线性变换，它们服从联合正态分布。因此，我们可以使用条件高斯分布的标准公式。\n\n设随机向量为 $(Y_1, Y_2)^T$，其中 $Y_1 = X_t$，$Y_2 = X_T$。该向量服从一个二元正态分布，其均值向量为 $\\boldsymbol{\\mu}$，协方差矩阵为 $\\Sigma$：\n$$\n\\begin{pmatrix} Y_1 \\\\ Y_2 \\end{pmatrix} \\sim \\mathcal{N} \\left( \\boldsymbol{\\mu} = \\begin{pmatrix} \\mu_1 \\\\ \\mu_2 \\end{pmatrix}, \\Sigma = \\begin{pmatrix} \\sigma_1^2  \\sigma_{12} \\\\ \\sigma_{12}  \\sigma_2^2 \\end{pmatrix} \\right)\n$$\n$Y_1$ 在给定 $Y_2 = y_2$ 的条件下的条件分布也是正态的，具有以下期望和方差：\n$$\n\\mathbb{E}[Y_1 \\mid Y_2 = y_2] = \\mu_1 + \\frac{\\sigma_{12}}{\\sigma_2^2} (y_2 - \\mu_2)\n$$\n$$\n\\operatorname{Var}(Y_1 \\mid Y_2 = y_2) = \\sigma_1^2 - \\frac{\\sigma_{12}^2}{\\sigma_2^2}\n$$\n\n我们的任务是计算在 $Y_1 = X_t$ 和 $Y_2 = X_T$ 的特定情况下，参数 $\\mu_1, \\mu_2, \\sigma_1^2, \\sigma_2^2$ 和 $\\sigma_{12}$。条件事件是 $X_T = b$。\n\n**1. 计算均值向量**\n$X_t$ 的期望是：\n$$\n\\mu_1 = \\mathbb{E}[X_t] = \\mathbb{E}[a + W_t] = a + \\mathbb{E}[W_t] = a + 0 = a\n$$\n类似地，$X_T$ 的期望是：\n$$\n\\mu_2 = \\mathbb{E}[X_T] = \\mathbb{E}[a + W_T] = a + \\mathbb{E}[W_T] = a + 0 = a\n$$\n所以，均值向量是 $\\boldsymbol{\\mu} = (a, a)^T$。\n\n**2. 计算协方差矩阵**\n协方差矩阵 $\\Sigma$ 的分量是 $X_t$ 和 $X_T$ 的方差和协方差。\n\n$X_t$ 的方差是：\n$$\n\\sigma_1^2 = \\operatorname{Var}(X_t) = \\operatorname{Var}(a + W_t) = \\operatorname{Var}(W_t) = t\n$$\n$X_T$ 的方差是：\n$$\n\\sigma_2^2 = \\operatorname{Var}(X_T) = \\operatorname{Var(a + W_T)} = \\operatorname{Var}(W_T) = T\n$$\n对于 $t \\in [0,T]$（这意味着 $t \\leq T$），$X_t$ 和 $X_T$ 之间的协方差是：\n$$\n\\sigma_{12} = \\operatorname{Cov}(X_t, X_T) = \\operatorname{Cov}(a + W_t, a + W_T) = \\operatorname{Cov}(W_t, W_T)\n$$\n根据协方差的定义：\n$$\n\\operatorname{Cov}(W_t, W_T) = \\mathbb{E}[W_t W_T] - \\mathbb{E}[W_t]\\mathbb{E}[W_T] = \\mathbb{E}[W_t W_T]\n$$\n由于 $t \\leq T$，我们可以写成 $W_T = W_t + (W_T - W_t)$。$(W_T - W_t)$ 项是布朗运动在 $[t, T]$ 上的增量，并且独立于 $W_t$（$W_t$ 依赖于直到时间 $t$ 的过程）。\n$$\n\\mathbb{E}[W_t W_T] = \\mathbb{E}[W_t (W_t + W_T - W_t)] = \\mathbb{E}[W_t^2] + \\mathbb{E}[W_t (W_T - W_t)]\n$$\n由于增量的独立性：\n$$\n\\mathbb{E}[W_t (W_T - W_t)] = \\mathbb{E}[W_t] \\mathbb{E}[W_T - W_t] = 0 \\cdot 0 = 0\n$$\n因此，协方差为：\n$$\n\\sigma_{12} = \\mathbb{E}[W_t^2] = \\operatorname{Var}(W_t) = t\n$$\n所以，协方差矩阵是：\n$$\n\\Sigma = \\begin{pmatrix} t  t \\\\ t  T \\end{pmatrix}\n$$\n\n**3. 计算条件期望和方差**\n现在我们将这些参数代入条件高斯分布的一般公式，其中 $y_2 = b$。\n\n条件期望 $\\mathbb{E}[X_t \\mid X_T=b]$ 是：\n$$\n\\mathbb{E}[X_t \\mid X_T=b] = \\mu_1 + \\frac{\\sigma_{12}}{\\sigma_2^2} (b - \\mu_2) = a + \\frac{t}{T} (b - a)\n$$\n这个表达式可以重写为起点和终点的加权平均：\n$$\n\\mathbb{E}[X_t \\mid X_T=b] = a \\left( 1 - \\frac{t}{T} \\right) + b \\frac{t}{T}\n$$\n\n条件方差 $\\operatorname{Var}(X_t \\mid X_T=b)$ 是：\n$$\n\\operatorname{Var}(X_t \\mid X_T=b) = \\sigma_1^2 - \\frac{\\sigma_{12}^2}{\\sigma_2^2} = t - \\frac{t^2}{T}\n$$\n这可以因式分解为：\n$$\n\\operatorname{Var}(X_t \\mid X_T=b) = t \\left( 1 - \\frac{t}{T} \\right) = \\frac{t(T-t)}{T}\n$$\n这些就是所求的量。期望描述了布朗桥的均值路径，这是一条从 $(0, a)$ 到 $(T, b)$ 的直线。方差是 $t$ 的一个二次函数，在 $t=0$ 和 $t=T$ 时为零，在 $t=T/2$ 时达到最大值。\n\n最终答案将这两个结果合并成一个单一的矩阵表达式。", "answer": "$$\n\\boxed{\\begin{pmatrix} a \\left( 1 - \\frac{t}{T} \\right) + b \\frac{t}{T}  \\frac{t(T-t)}{T} \\end{pmatrix}}\n$$", "id": "3042166"}, {"introduction": "在理解了布朗桥在单一时间点的性质后，我们来探究其动态特性。这项练习要求计算布朗桥*增量*的方差，并将其与标准布朗运动的增量方差进行比较。这个对比不仅仅是一个数学计算，它为我们提供了一个深刻的直观理解：终点条件如何“钉住”整个过程，从而随时间减少其随机性。[@problem_id:3042175]", "problem": "设 $\\{W_{t}\\}_{t \\ge 0}$ 为一个标准布朗运动（也称维纳过程），满足 $W_{0} = 0$。它是一个中心化高斯过程，其协方差为 $\\operatorname{Cov}(W_{u}, W_{v}) = \\min\\{u, v\\}$，对所有 $u, v \\ge 0$ 成立。通过将布朗运动的终值设为零作为条件，来定义在时间 $T$ 钉扎的布朗桥 $\\{X_{t}\\}_{0 \\le t \\le T}$，即 $X_{t}$ 是一个与 $\\{W_{t} \\mid W_{T} = 0\\}$ 具有相同有限维分布的过程。仅使用 $(W_{s}, W_{t}, W_{T})$ 的联合高斯结构以及多元正态分布的条件化规则，推导增量的二阶矩的闭式表达式，\n$$\n\\mathbb{E}\\big[(X_{t} - X_{s})^{2}\\big],\n$$\n其中 $0 \\le s  t \\le T$。然后，将您的表达式与布朗运动增量的方差 $\\operatorname{Var}(W_{t} - W_{s})$ 进行比较，以解释在时间 $T$ 钉扎的影响。您的最终答案必须是关于 $s$、$t$ 和 $T$ 的单个解析表达式。无需四舍五入。", "solution": "我们从标准布朗运动（维纳过程）$\\{W_{t}\\}_{t \\ge 0}$ 的定义开始，它是一个中心化高斯过程，满足 $\\mathbb{E}[W_{t}] = 0$ 且对所有 $u, v \\ge 0$ 有 $\\operatorname{Cov}(W_{u}, W_{v}) = \\min\\{u, v\\}$。在时间 $T$ 钉扎的布朗桥 $\\{X_{t}\\}_{0 \\le t \\le T}$ 被定义为与 $\\{W_{t} \\mid W_{T} = 0\\}$ 具有相同有限维分布的过程。\n\n为了计算 $\\mathbb{E}[(X_{t} - X_{s})^{2}]$，我们使用多元正态分布的条件化规则。具体来说，如果 $(Y_{1}, Y_{2})$ 是联合高斯分布，那么条件分布 $Y_{1} \\mid Y_{2}$ 也是高斯分布，其条件均值和协方差由通常的线性回归公式给出。对于布朗运动，向量 $(W_{s}, W_{t}, W_{T})$ 是联合高斯分布的，其均值为零，协方差矩阵由 $\\operatorname{Cov}(W_{u}, W_{v}) = \\min\\{u, v\\}$ 决定。\n\n布朗桥 $X_{u}$ 可以表示为在 $W_{T} = 0$ 的条件下 $W_{u}$ 的条件分布。使用回归公式，\n$$\n\\mathbb{E}[W_{u} \\mid W_{T}] = \\frac{\\operatorname{Cov}(W_{u}, W_{T})}{\\operatorname{Var}(W_{T})} W_{T} = \\frac{u}{T} W_{T}.\n$$\n因此，中心化残差\n$$\nX_{u} := W_{u} - \\mathbb{E}[W_{u} \\mid W_{T}] = W_{u} - \\frac{u}{T} W_{T}\n$$\n与以 $W_{T} = 0$ 为条件的 $W_{u}$ 具有相同的有限维分布，特别地，对所有 $u \\in [0, T]$ 都有 $\\mathbb{E}[X_{u}] = 0$。\n\n接下来我们计算布朗桥的协方差结构。对于 $0 \\le s \\le t \\le T$，\n\\begin{align*}\n\\operatorname{Cov}(X_{s}, X_{t})\n= \\operatorname{Cov}\\!\\left(W_{s} - \\frac{s}{T} W_{T},\\, W_{t} - \\frac{t}{T} W_{T}\\right) \\\\\n= \\operatorname{Cov}(W_{s}, W_{t}) - \\frac{t}{T} \\operatorname{Cov}(W_{s}, W_{T}) - \\frac{s}{T} \\operatorname{Cov}(W_{t}, W_{T}) + \\frac{st}{T^{2}} \\operatorname{Var}(W_{T}) \\\\\n= \\min\\{s, t\\} - \\frac{t}{T} s - \\frac{s}{T} t + \\frac{st}{T^{2}} T \\\\\n= \\min\\{s, t\\} - \\frac{st}{T}.\n\\end{align*}\n对于 $s \\le t$，这简化为 $\\operatorname{Cov}(X_{s}, X_{t}) = s - \\frac{st}{T}$。特别地，\n$$\n\\operatorname{Var}(X_{u}) = \\operatorname{Cov}(X_{u}, X_{u}) = u - \\frac{u^{2}}{T}.\n$$\n\n现在我们计算增量的二阶矩，对于一个中心化高斯过程，它等于其方差：\n\\begin{align*}\n\\mathbb{E}\\big[(X_{t} - X_{s})^{2}\\big]\n= \\operatorname{Var}(X_{t} - X_{s}) \\\\\n= \\operatorname{Var}(X_{t}) + \\operatorname{Var}(X_{s}) - 2\\,\\operatorname{Cov}(X_{s}, X_{t}) \\\\\n= \\left(t - \\frac{t^{2}}{T}\\right) + \\left(s - \\frac{s^{2}}{T}\\right) - 2\\left(s - \\frac{st}{T}\\right) \\\\\n= t - \\frac{t^{2}}{T} + s - \\frac{s^{2}}{T} - 2s + \\frac{2st}{T} \\\\\n= (t - s) - \\frac{t^{2} + s^{2} - 2st}{T} \\\\\n= (t - s) - \\frac{(t - s)^{2}}{T}.\n\\end{align*}\n\n为了与布朗运动增量进行比较，回想一下 $\\operatorname{Var}(W_{t} - W_{s}) = t - s$。因此，对于布朗桥，\n$$\n\\mathbb{E}\\big[(X_{t} - X_{s})^{2}\\big] = (t - s) - \\frac{(t - s)^{2}}{T} \\le t - s \\quad (\\text{对于 } s  t),\n$$\n这表明了由于在时间 $T$ 钉扎而导致的变异性减小。值得注意的是，当 $s = 0$ 且 $t = T$ 时，该表达式结果为 $0$，这反映了布朗桥在两个端点 $X_{0} = 0$ 和 $X_{T} = 0$ 处都被钉扎。", "answer": "$$\\boxed{(t - s) - \\frac{(t - s)^{2}}{T}}$$", "id": "3042175"}, {"introduction": "理论通过模拟而变得鲜活。这最后的练习是一个综合性项目，我们将开发一个优雅且高效的算法来生成布朗桥的路径。通过应用我们已经探索过的条件分布公式，我们将分步构建布朗桥，并使用蒙特卡洛方法来验证我们的模拟是否正确地捕捉了理论方差。[@problem_id:3042164] 这项实践将抽象的方程与计算金融或物理学的应用联系起来。", "problem": "考虑一个标准布朗运动 $W_t$，在区间 $[0,T]$ 上满足 $W_0=0$。一个在 $[0,T]$ 上从 $a$ 到 $b$ 的布朗桥 $X_t$ 是以事件 $X_0=a$ 和 $X_T=b$ 为条件的布朗运动 $W_t$。您可以使用以下事实作为基本依据：(i) 对于 $0 \\le s \\le t$，$W_t - W_s$ 是均值为 $0$、方差为 $t-s$ 的高斯分布，并且向量 $(W_{t_1},\\dots,W_{t_n})$ 是联合高斯分布，其均值为 $0$，协方差为 $\\operatorname{Cov}(W_s,W_t)=\\min\\{s,t\\}$；(ii) 任何联合高斯向量的线性条件化仍然是高斯分布，其条件均值和条件协方差可通过高斯条件化的标准分块矩阵公式获得。\n\n您的任务是：\n\n- 从上述基本依据出发，推导在给定两个端点 $X_\\ell=x_\\ell$ 和 $X_r=x_r$ 的条件下，任意时刻 $0 \\le \\ell  m  r \\le T$ 的 $X_m$ 的条件分布。具体来说，将条件均值表示为 $x_\\ell$ 和 $x_r$ 的线性函数，并将条件方差表示为时间 $\\ell$、$m$ 和 $r$ 的函数。除基本依据外，不要假设任何公式；请从第一性原理进行显式推导。\n- 使用您推导出的条件分布，提出一个递归中点模拟方案，用于在深度为 $L$ 的二进网格上生成布朗桥的路径。从已知的端点 $(0,a)$ 和 $(T,b)$ 开始，递归地插入中点：在每一步中，对于当前的任何区间 $[\\ell,r]$，从您推导出的条件高斯分布中对中点 $m=(\\ell+r)/2$ 进行采样，然后在左区间 $[\\ell,m]$ 和右区间 $[m,r]$ 上进行递归，直到达到所需的深度 $L$。\n- 通过蒙特卡洛方法验证在每个递归层级使用的条件方差是正确的。对于每个层级 $k \\in \\{0,1,\\dots,L-1\\}$，聚合在该层级上通过多次独立实现采样的所有中点。对于在其父区间 $[\\ell,r]$ 内采样的每个时间 $m$ 处的中点，计算残差平方 $(X_m - \\mathbb{E}[X_m \\mid X_\\ell, X_r])^2$。将这些残差平方在层级 $k$ 的所有中点和所有实现中进行平均。将此经验平均值与您从推导中获得的该层级的理论条件方差进行比较，并计算相对误差，其定义为绝对差除以理论值。\n\n实现要求：\n\n- 实现一个程序，该程序使用您推导出的条件高斯分布，在二进网格上执行布朗桥的递归中点模拟，并为每个递归层级执行上述方差验证。\n- 使用固定的随机种子，以确保结果是可复现的。\n- 对于每个测试用例，返回一个布尔值，指示所有层级的最大相对误差是否小于或等于指定的容差。\n\n测试套件：\n\n- 测试用例 1：$T=1.0$，$a=0.0$，$b=0.0$，$L=5$，独立实现次数 $M=3500$，容差 $\\varepsilon=0.06$。\n- 测试用例 2：$T=2.0$，$a=1.5$，$b=-0.7$，$L=4$，独立实现次数 $M=3200$，容差 $\\varepsilon=0.06$。\n- 测试用例 3：$T=0.5$，$a=-2.0$，$b=3.0$，$L=4$，独立实现次数 $M=4000$，容差 $\\varepsilon=0.06$。\n\n最终输出格式：\n\n- 您的程序应生成单行输出，其中包含按测试套件顺序排列的结果，形式为方括号括起来的逗号分隔列表。每个条目都是一个布尔值，指示该测试用例的所有递归层级是否都满足容差要求。例如，如果第一个和第三个测试用例通过而第二个失败，则输出应类似于 $[{\\rm True},{\\rm False},{\\rm True}]$。", "solution": "该问题经评估为有效。这是一个在随机过程领域中适定且有科学依据的问题。它要求从第一性原理进行严格推导，基于此推导设计一个数值算法，并对算法的属性进行蒙特卡洛验证。问题陈述清晰、客观，并包含了继续进行所需的所有必要信息。\n\n### 1. 条件分布的推导\n\n我们需要求解布朗过程 $X_m$ 在时刻 $m$ 的条件分布，给定其在时刻 $\\ell$ 和 $r$ 的值分别为 $X_\\ell=x_\\ell$ 和 $X_r=x_r$，其中 $0 \\le \\ell  m  r \\le T$。\n\n问题陈述指出，布朗桥源自标准布朗运动 $W_t$，而后者是一个高斯过程。来自高斯过程的任何有限点集 $(X_{t_1}, X_{t_2}, \\dots, X_{t_n})$ 构成一个联合高斯随机向量。因此，向量 $(X_\\ell, X_m, X_r)$ 是联合高斯的。一个分量在给定其他分量下的条件分布也同样是高斯分布。\n\n高斯过程的条件均值和方差与任何常数偏移无关。因此，我们可以对 $W_0=0$ 的标准布朗运动 $W_t$ 进行推导，其结果将直接适用于 $X_t$。我们希望找到在 $W_\\ell = w_\\ell$ 和 $W_r = w_r$ 条件下 $W_m$ 的分布。\n\n设随机向量分块为 $Y = (Y_1, Y_2^T)^T$，其中 $Y_1 = W_m$ 且 $Y_2 = (W_\\ell, W_r)^T$。这是一个零均值的联合高斯向量，因为对所有 $t$ 都有 $\\mathbb{E}[W_t] = 0$。协方差矩阵 $\\Sigma$ 由 $\\operatorname{Cov}(W_s, W_t) = \\min\\{s, t\\}$ 确定。\n\n协方差矩阵分块如下：\n$$ \\Sigma = \\begin{pmatrix} \\Sigma_{11}  \\Sigma_{12} \\\\ \\Sigma_{21}  \\Sigma_{22} \\end{pmatrix} $$\n对于我们选择的分块方式，各分块为：\n- $\\Sigma_{11} = \\operatorname{Var}(W_m) = m$\n- $\\Sigma_{12} = (\\operatorname{Cov}(W_m, W_\\ell), \\operatorname{Cov}(W_m, W_r))$。由于 $\\ell  m  r$，此值为 $(\\ell, m)$。\n- $\\Sigma_{21} = \\Sigma_{12}^T = \\begin{pmatrix} \\ell \\\\ m \\end{pmatrix}$\n- $\\Sigma_{22} = \\begin{pmatrix} \\operatorname{Var}(W_\\ell)  \\operatorname{Cov}(W_\\ell, W_r) \\\\ \\operatorname{Cov}(W_r, W_\\ell)  \\operatorname{Var}(W_r) \\end{pmatrix} = \\begin{pmatrix} \\ell  \\ell \\\\ \\ell  r \\end{pmatrix}$\n\n$Y_1$ 在给定 $Y_2 = y_2 = (w_\\ell, w_r)^T$ 条件下的分布是高斯分布 $\\mathcal{N}(\\mu_{1|2}, \\Sigma_{1|2})$，其中：\n- 条件均值：$\\mu_{1|2} = \\mu_1 + \\Sigma_{12} \\Sigma_{22}^{-1} (y_2 - \\mu_2)$\n- 条件方差：$\\Sigma_{1|2} = \\Sigma_{11} - \\Sigma_{12} \\Sigma_{22}^{-1} \\Sigma_{21}$\n\n由于基础过程是标准布朗运动，均值向量为零：$\\mu_1 = 0$ 且 $\\mu_2 = (0, 0)^T$。\n\n首先，我们求 $\\Sigma_{22}$ 的逆矩阵：\n$$ \\det(\\Sigma_{22}) = \\ell r - \\ell^2 = \\ell(r-\\ell) $$\n$$ \\Sigma_{22}^{-1} = \\frac{1}{\\ell(r-\\ell)} \\begin{pmatrix} r  -\\ell \\\\ -\\ell  \\ell \\end{pmatrix} $$\n\n现在，我们计算条件均值 $\\mu_{1|2}$：\n$$ \\mu_{1|2} = \\Sigma_{12} \\Sigma_{22}^{-1} y_2 = (\\ell, m) \\frac{1}{\\ell(r-\\ell)} \\begin{pmatrix} r  -\\ell \\\\ -\\ell  \\ell \\end{pmatrix} \\begin{pmatrix} w_\\ell \\\\ w_r \\end{pmatrix} $$\n$$ \\mu_{1|2} = \\frac{1}{\\ell(r-\\ell)} (\\ell r - m\\ell, -\\ell^2 + m\\ell) \\begin{pmatrix} w_\\ell \\\\ w_r \\end{pmatrix} $$\n$$ \\mu_{1|2} = \\frac{1}{\\ell(r-\\ell)} [(\\ell r - m\\ell)w_\\ell + (-\\ell^2 + m\\ell)w_r] $$\n$$ \\mu_{1|2} = \\frac{\\ell(r-m)}{\\ell(r-\\ell)}w_\\ell + \\frac{\\ell(m-\\ell)}{\\ell(r-\\ell)}w_r = \\frac{r-m}{r-\\ell}w_\\ell + \\frac{m-\\ell}{r-\\ell}w_r $$\n这是值 $w_\\ell$ 和 $w_r$ 在时刻 $m$ 的线性插值。由于这个结果与过程的任何常数偏移无关，我们可以为我们的过程 $X_t$ 陈述如下：\n$$ \\mathbb{E}[X_m \\mid X_\\ell=x_\\ell, X_r=x_r] = \\frac{r-m}{r-\\ell}x_\\ell + \\frac{m-\\ell}{r-\\ell}x_r $$\n\n接下来，我们计算条件方差 $\\Sigma_{1|2}$：\n$$ \\Sigma_{1|2} = \\Sigma_{11} - \\Sigma_{12} \\Sigma_{22}^{-1} \\Sigma_{21} = m - (\\ell, m) \\frac{1}{\\ell(r-\\ell)} \\begin{pmatrix} r  -\\ell \\\\ -\\ell  \\ell \\end{pmatrix} \\begin{pmatrix} \\ell \\\\ m \\end{pmatrix} $$\n$$ \\Sigma_{1|2} = m - \\frac{1}{\\ell(r-\\ell)} (\\ell r - m\\ell, -\\ell^2 + m\\ell) \\begin{pmatrix} \\ell \\\\ m \\end{pmatrix} $$\n$$ \\Sigma_{1|2} = m - \\frac{1}{\\ell(r-\\ell)} [ \\ell(\\ell r - m\\ell) + m(-\\ell^2 + m\\ell) ] $$\n$$ \\Sigma_{1|2} = m - \\frac{1}{\\ell(r-\\ell)} [ \\ell^2 r - m\\ell^2 - m\\ell^2 + m^2\\ell ] $$\n$$ \\Sigma_{1|2} = m - \\frac{\\ell(\\ell r - 2m\\ell + m^2)}{\\ell(r-\\ell)} = m - \\frac{\\ell r - 2m\\ell + m^2}{r-\\ell} $$\n$$ \\Sigma_{1|2} = \\frac{m(r-\\ell) - (\\ell r - 2m\\ell + m^2)}{r-\\ell} = \\frac{mr - m\\ell - \\ell r + 2m\\ell - m^2}{r-\\ell} $$\n$$ \\Sigma_{1|2} = \\frac{mr + m\\ell - \\ell r - m^2}{r-\\ell} = \\frac{m(r-\\ell) + \\ell(m-r)}{r-\\ell} $$\n分子可以因式分解为 $(m-\\ell)(r-m)$：\n$$ \\operatorname{Var}(X_m \\mid X_\\ell=x_\\ell, X_r=x_r) = \\frac{(m-\\ell)(r-m)}{r-\\ell} $$\n该方差仅取决于时间点 $\\ell, m, r$。\n\n### 2. 递归中点模拟方案\n\n该模拟在深度为 $L$ 的二进网格上生成一条路径。这意味着我们从区间 $[0, T]$ 开始，并递归地在其中心点处细分每个区间。\n对于具有已知值 $X_\\ell=x_\\ell$ 和 $X_r=x_r$ 的任何区间 $[\\ell, r]$，我们在中点时刻 $m = (\\ell+r)/2$ 采样值 $X_m$。使用上面推导的公式：\n\n中点处的条件均值为：\n$$ \\mathbb{E}[X_m] = \\frac{r - (\\ell+r)/2}{r-\\ell}x_\\ell + \\frac{(\\ell+r)/2 - \\ell}{r-\\ell}x_r = \\frac{(r-\\ell)/2}{r-\\ell}x_\\ell + \\frac{(r-\\ell)/2}{r-\\ell}x_r = \\frac{1}{2}x_\\ell + \\frac{1}{2}x_r = \\frac{x_\\ell+x_r}{2} $$\n\n中点处的条件方差为：\n$$ \\operatorname{Var}(X_m) = \\frac{(m-\\ell)(r-m)}{r-\\ell} = \\frac{((\\ell+r)/2 - \\ell)(r - (\\ell+r)/2)}{r-\\ell} = \\frac{((r-\\ell)/2)((r-\\ell)/2)}{r-\\ell} = \\frac{r-\\ell}{4} $$\n\n模拟算法如下：\n1. 用给定的端点初始化一个结构（例如，字典）`points`：`points` $= \\{0: a, T: b\\}$。\n2. 初始化一个待处理区间的队列：`queue` $= [(0, T)]$。\n3. 对于从 $0$ 到 $L-1$ 的每个递归层级 $k$：\n    a. 为下一层级创建一个空队列 `next_queue`。\n    b. 对于当前 `queue` 中的每个区间 $[\\ell, r]$：\n        i. 计算中点时刻 $m = (\\ell+r)/2$。\n        ii. 获取端点值 $x_\\ell = \\text{points}[\\ell]$ 和 $x_r = \\text{points}[r]$。\n        iii. 计算条件均值 $\\mu = (x_\\ell+x_r)/2$。\n        iv. 计算条件方差 $\\sigma^2 = (r-\\ell)/4$。\n        v. 采样一个标准正态随机变量 $Z \\sim \\mathcal{N}(0,1)$。\n        vi. 生成新的点值 $x_m = \\mu + \\sqrt{\\sigma^2} Z$。\n        vii. 存储新的点：`points`$[m] = x_m$。\n        viii. 将两个新的子区间添加到下一层级的队列中：`next_queue.append([`$\\ell, m$`], [m, r]`)\n    c. 用 `next_queue` 替换 `queue`。\n4. 经过 $L$ 个层级后，`points` 包含在二进网格上模拟的路径。\n\n### 3. 蒙特卡洛方差验证\n\n为了验证推导出的条件方差，我们对布朗桥路径进行 $M$ 次独立模拟。对于每次模拟和每个递归层级，我们计算采样的中点与其条件均值之间的平方误差。\n\n1.  初始化一个列表的列表 `squared_residuals`，包含 $L$ 个空列表，每个递归层级一个。\n2.  重复模拟过程 $M$ 次。在每次模拟中：\n    - 在层级 $k$，对于每个被细分的区间 $[\\ell,r]$，从中生成一个中点 $x_m$ 服从 $\\mathcal{N}(\\mu, \\sigma^2)$。\n    - 计算残差平方 $(x_m - \\mu)^2$。\n    - 将此残差平方附加到 `squared_residuals[k]`。\n3.  在 $M$ 次模拟之后，对于每个层级 $k \\in \\{0, 1, \\dots, L-1\\}$：\n    a.  经验方差是 `squared_residuals[k]` 中所有值的平均值。\n        $$ \\sigma^2_{\\text{emp}, k} = \\frac{1}{|\\text{squared\\_residuals}[k]|} \\sum_{v \\in \\text{squared\\_residuals}[k]} v $$\n    b.  需要确定层级 $k$ 的理论方差。在层级 $k$，所有区间的长度均为 $T/2^k$。采样中点的条件方差是（区间长度）/$4$。因此，理论方差为：\n        $$ \\sigma^2_{\\text{th}, k} = \\frac{T/2^k}{4} = \\frac{T}{2^{k+2}} $$\n    c.  相对误差计算如下：\n        $$ \\text{err}_{\\text{rel}, k} = \\frac{|\\sigma^2_{\\text{emp}, k} - \\sigma^2_{\\text{th}, k}|}{\\sigma^2_{\\text{th}, k}} $$\n4.  对于每个测试用例，将所有层级中的最大相对误差 $\\max_{k} \\{\\text{err}_{\\text{rel}, k}\\}$ 与给定的容差 $\\varepsilon$ 进行比较。如果此最大误差小于或等于 $\\varepsilon$，则测试用例通过。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Brownian bridge simulation and verification problem\n    for the given test cases.\n    \"\"\"\n    # Use a fixed random seed for reproducibility.\n    seed = 12345\n    rng = np.random.default_rng(seed)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (T, a, b, L, M, tolerance)\n        (1.0, 0.0, 0.0, 5, 3500, 0.06),\n        (2.0, 1.5, -0.7, 4, 3200, 0.06),\n        (0.5, -2.0, 3.0, 4, 4000, 0.06),\n    ]\n\n    results = []\n\n    for T, a, b, L, M, tol in test_cases:\n        # A list of lists to store squared residuals for each level across all realizations.\n        all_squared_residuals = [[] for _ in range(L)]\n\n        # Run M independent Monte Carlo simulations.\n        for _ in range(M):\n            # Dictionary to store the (time, value) points of the bridge path.\n            points = {0.0: a, T: b}\n            # Queue of intervals [l, r] to be subdivided at the current level.\n            # Start with the full interval [0, T].\n            queue = [(0.0, T)]\n\n            # Perform L levels of recursive midpoint subdivision.\n            for k in range(L):\n                next_queue = []\n                # Process each interval in the current level's queue.\n                for l, r in queue:\n                    m = (l + r) / 2.0\n                    \n                    x_l = points[l]\n                    x_r = points[r]\n                    \n                    # Derived conditional mean and variance for the midpoint.\n                    mean = (x_l + x_r) / 2.0\n                    variance = (r - l) / 4.0\n                    std_dev = np.sqrt(variance)\n                    \n                    # Sample a new point from the conditional Gaussian distribution.\n                    Z = rng.normal()\n                    x_m = mean + std_dev * Z\n                    \n                    points[m] = x_m\n                    \n                    # Calculate the squared residual for variance verification.\n                    # The residual is (x_m - E[X_m | ...]).\n                    squared_residual = (x_m - mean)**2\n                    all_squared_residuals[k].append(squared_residual)\n                    \n                    # Add new sub-intervals to the queue for the next level.\n                    next_queue.append((l, m))\n                    next_queue.append((m, r))\n                \n                # Move to the next level of subdivision.\n                queue = next_queue\n        \n        # After all simulations, verify the variance for each level.\n        max_rel_error = 0.0\n        for k in range(L):\n            # Calculate the empirical variance from the collected squared residuals.\n            empirical_variance = np.mean(all_squared_residuals[k])\n            \n            # The theoretical variance for level k, derived as T / 2^(k+2).\n            # This is because intervals at level k have length T / 2^k,\n            # and the midpoint variance is (interval_length) / 4.\n            theoretical_variance = (T / (2**k)) / 4.0\n\n            # Compute the relative error.\n            relative_error = np.abs(empirical_variance - theoretical_variance) / theoretical_variance\n            \n            # Keep track of the maximum relative error found across all levels.\n            if relative_error > max_rel_error:\n                max_rel_error = relative_error\n        \n        # The test case passes if the maximum relative error is within the tolerance.\n        results.append(max_rel_error = tol)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3042164"}]}