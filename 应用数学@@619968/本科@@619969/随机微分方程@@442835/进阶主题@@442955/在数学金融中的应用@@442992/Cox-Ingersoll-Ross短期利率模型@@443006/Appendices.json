{"hands_on_practices": [{"introduction": "在我们深入模拟随机过程的复杂路径之前，通过分析来掌握其基本性质是至关重要的。Cox-Ingersoll-Ross (CIR) 模型的核心特征是其均值回归特性，即利率 $r_t$ 会趋向于一个长期平均值 $\\theta$。第一个练习 [@problem_id:3080150] 将引导你完成一个基础推导，以获得期望利率 $\\mathbb{E}[r_t]$ 的显式公式。通过求解从随机微分方程（SDE）中导出的一个简单常微分方程，你将从数学上验证这种均值回归行为，并理解参数 $\\kappa$、$\\theta$ 和 $r_0$ 如何共同决定利率的期望未来路径。", "problem": "考虑 Cox–Ingersoll–Ross 短期利率模型，其中短期利率过程 $\\{r_t\\}_{t \\geq 0}$ 满足随机微分方程 (SDE)\n$$\ndr_t \\;=\\; \\kappa\\big(\\theta - r_t\\big)\\,dt \\;+\\; \\sigma \\sqrt{r_t}\\,dW_t,\n$$\n其中 $\\kappa>0$、$\\theta>0$ 和 $\\sigma>0$ 是常数，$r_0 \\ge 0$ 是给定的初始短期利率，$\\{W_t\\}_{t \\ge 0}$ 是一个标准布朗运动。假设解 $\\{r_t\\}_{t \\ge 0}$ 对每个 $t>0$ 都是严格非负的，并具有有限的一阶矩。仅使用伊藤积分的基本性质（特别是在合适的积分条件下，伊藤积分的期望为零）和期望的线性性，推导出一阶矩 $m_1(t)=\\mathbb{E}[r_t \\mid r_0]$ 所满足的常微分方程，并在初始条件 $m_1(0)=r_0$ 下求解该方程。请用 $t$、$\\kappa$、$\\theta$ 和 $r_0$ 将 $m_1(t)$ 表示为单个闭式解析表达式作为最终答案。不需要进行数值近似。", "solution": "所述问题在随机微分方程领域构成了一个有效且适定的数学练习。所有参数都已明确定义，目标明确，且框架依赖于 Cox-Ingersoll-Ross 模型的既定科学原理。我们将开始推导。\n\n描述短期利率 $\\{r_t\\}_{t \\geq 0}$ 的 Cox-Ingersoll-Ross 过程由以下随机微分方程 (SDE) 给出：\n$$\ndr_t = \\kappa(\\theta - r_t)dt + \\sigma \\sqrt{r_t}dW_t\n$$\n其中 $\\kappa$、$\\theta$ 和 $\\sigma$ 是正常数，$r_0 \\ge 0$ 是初始利率，$\\{W_t\\}_{t \\ge 0}$ 是一个标准布朗运动。我们需要求出一阶矩 $m_1(t) = \\mathbb{E}[r_t \\mid r_0]$。\n\n首先，我们将 SDE 从时间 $s=0$ 积分到 $s=t$，以其积分形式表示：\n$$\n\\int_{0}^{t} dr_s = \\int_{0}^{t} \\kappa(\\theta - r_s)ds + \\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s\n$$\n这得到：\n$$\nr_t - r_0 = \\int_{0}^{t} \\kappa(\\theta - r_s)ds + \\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s\n$$\n对 $r_t$ 重新整理，我们得到：\n$$\nr_t = r_0 + \\int_{0}^{t} \\kappa(\\theta - r_s)ds + \\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s\n$$\n现在，我们对等式两边取关于时间 $t=0$ 信息的条件期望，这等价于以 $r_0$ 的给定值为条件。\n$$\n\\mathbb{E}[r_t \\mid r_0] = \\mathbb{E}\\left[r_0 + \\int_{0}^{t} \\kappa(\\theta - r_s)ds + \\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s \\mid r_0\\right]\n$$\n利用期望算子的线性性，我们可以将各项分开：\n$$\n\\mathbb{E}[r_t \\mid r_0] = \\mathbb{E}[r_0 \\mid r_0] + \\mathbb{E}\\left[\\int_{0}^{t} \\kappa(\\theta - r_s)ds \\mid r_0\\right] + \\mathbb{E}\\left[\\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s \\mid r_0\\right]\n$$\n让我们分析右侧的每一项。\n根据定义，$m_1(t) = \\mathbb{E}[r_t \\mid r_0]$。由于 $r_0$ 是在时间 $t=0$ 已知的常数，其期望就是其自身：$\\mathbb{E}[r_0 \\mid r_0] = r_0$。\n\n对于第二项，它涉及一个标准的黎曼积分，我们可以交换期望和积分算子（根据此处适用的 Fubini 定理）。\n$$\n\\mathbb{E}\\left[\\int_{0}^{t} \\kappa(\\theta - r_s)ds \\mid r_0\\right] = \\int_{0}^{t} \\mathbb{E}[\\kappa(\\theta - r_s) \\mid r_0]ds\n$$\n在积分内部再次使用期望的线性性：\n$$\n\\int_{0}^{t} (\\mathbb{E}[\\kappa\\theta \\mid r_0] - \\mathbb{E}[\\kappa r_s \\mid r_0])ds = \\int_{0}^{t} (\\kappa\\theta - \\kappa\\mathbb{E}[r_s \\mid r_0])ds = \\int_{0}^{t} (\\kappa\\theta - \\kappa m_1(s))ds\n$$\n第三项是一个伊藤随机积分的期望。伊藤积分的一个基本性质是，对于任何合适的适应过程 $X_s$，其关于布朗运动的积分的期望为零：$\\mathbb{E}\\left[\\int_{0}^{t} X_s dW_s\\right] = 0$。必要条件是其被积函数满足 $\\mathbb{E}\\left[\\int_{0}^{t} X_s^2 ds\\right] < \\infty$。在我们的情况下，被积函数是 $X_s = \\sigma\\sqrt{r_s}$。该条件变为 $\\mathbb{E}\\left[\\int_{0}^{t} (\\sigma\\sqrt{r_s})^2 ds\\right] = \\sigma^2 \\int_{0}^{t} \\mathbb{E}[r_s]ds < \\infty$。由于问题陈述假设一阶矩 $m_1(s) = \\mathbb{E}[r_s]$ 对每个 $s>0$ 都是有限的，并且是时间的连续函数（这一点我们稍后会确认），因此对于任何有限的 $t$，该积分都是有限的。因此，该性质适用：\n$$\n\\mathbb{E}\\left[\\int_{0}^{t} \\sigma \\sqrt{r_s}dW_s \\mid r_0\\right] = 0\n$$\n将这些结果代回期望方程，我们得到一个关于 $m_1(t)$ 的积分方程：\n$$\nm_1(t) = r_0 + \\int_{0}^{t} (\\kappa\\theta - \\kappa m_1(s))ds\n$$\n为了将此积分方程转换为常微分方程 (ODE)，我们对等式两边关于 $t$ 求导。对积分项应用微积分基本定理：\n$$\n\\frac{d}{dt}m_1(t) = \\frac{d}{dt}r_0 + \\frac{d}{dt}\\left(\\int_{0}^{t} (\\kappa\\theta - \\kappa m_1(s))ds\\right)\n$$\n由于 $r_0$ 是一个常数，其导数为零。这得到：\n$$\n\\frac{dm_1(t)}{dt} = \\kappa\\theta - \\kappa m_1(t)\n$$\n这是一个一阶线性非齐次常微分方程，可以整理成标准形式：\n$$\n\\frac{dm_1(t)}{dt} + \\kappa m_1(t) = \\kappa\\theta\n$$\n初始条件是 $m_1(0) = \\mathbb{E}[r_0 \\mid r_0] = r_0$。\n我们使用积分因子 $I(t)$ 来解这个常微分方程，其定义为：\n$$\nI(t) = \\exp\\left(\\int \\kappa dt\\right) = \\exp(\\kappa t)\n$$\n将整个常微分方程乘以 $I(t)$：\n$$\n\\exp(\\kappa t)\\frac{dm_1(t)}{dt} + \\kappa\\exp(\\kappa t) m_1(t) = \\kappa\\theta\\exp(\\kappa t)\n$$\n左边是微分的乘法法则应用于 $\\exp(\\kappa t)m_1(t)$ 的结果：\n$$\n\\frac{d}{dt}\\left[\\exp(\\kappa t) m_1(t)\\right] = \\kappa\\theta\\exp(\\kappa t)\n$$\n现在，我们对两边从 $s=0$ 积分到 $s=t$：\n$$\n\\int_{0}^{t} \\frac{d}{ds}\\left[\\exp(\\kappa s) m_1(s)\\right]ds = \\int_{0}^{t} \\kappa\\theta\\exp(\\kappa s)ds\n$$\n$$\n\\left[\\exp(\\kappa s) m_1(s)\\right]_{0}^{t} = \\kappa\\theta \\left[\\frac{1}{\\kappa}\\exp(\\kappa s)\\right]_{0}^{t}\n$$\n$$\n\\exp(\\kappa t) m_1(t) - \\exp(0) m_1(0) = \\theta \\left[\\exp(\\kappa t) - \\exp(0)\\right]\n$$\n代入初始条件 $m_1(0) = r_0$ 并注意到 $\\exp(0)=1$：\n$$\n\\exp(\\kappa t) m_1(t) - r_0 = \\theta(\\exp(\\kappa t) - 1)\n$$\n解出 $\\exp(\\kappa t) m_1(t)$：\n$$\n\\exp(\\kappa t) m_1(t) = r_0 - \\theta + \\theta\\exp(\\kappa t)\n$$\n最后，我们通过除以 $\\exp(\\kappa t)$（或乘以 $\\exp(-\\kappa t)$）来分离出 $m_1(t)$：\n$$\nm_1(t) = (r_0 - \\theta)\\exp(-\\kappa t) + \\theta\n$$\n这就是 CIR 过程一阶矩的闭式解析表达式。它表明，期望短期利率 $\\mathbb{E}[r_t]$ 以由 $\\kappa$ 决定的速率，从其初始值 $r_0$ 指数地向长期均值 $\\theta$ 进行均值回归。", "answer": "$$\n\\boxed{\\theta + (r_0 - \\theta)\\exp(-\\kappa t)}\n$$", "id": "3080150"}, {"introduction": "在理解了 CIR 过程的理论行为之后，下一步自然是在计算机上模拟其路径。Euler-Maruyama 方法是随机微分方程最直接的离散化方法，通常作为入门的首选。然而，CIR 模型的一个关键特性是利率保持非负（在满足 Feller 条件时，这一特性得到理论保证）。本练习 [@problem_id:1710381] 将揭示，尽管有理论保证，但简单的 Euler-Maruyama 方案可能会失效并产生不切实际的负值。通过计算在单步模拟中发生这种情况的概率，你将亲身体会到数值离散化方法的陷阱，并理解为何需要更精密的算法。", "problem": "Cox-Ingersoll-Ross (CIR) 模型在金融数学中常用于描述利率随时间的演变过程。该理论模型的一个关键性质是，利率过程 $X_t$ 保持非负。$X_t$ 的动态过程由以下随机微分方程（SDE）所描述：\n$$dX_t = \\kappa(\\theta - X_t)dt + \\sigma \\sqrt{X_t} dW_t$$\n其中 $\\kappa > 0$ 是均值回归速率，$\\theta > 0$ 是长期均值，$\\sigma > 0$ 是波动率参数，而 $W_t$ 是一个标准维纳过程。对于从正值开始的连续过程 $X_t$ 要保持严格为正，一个充分条件是 $2\\kappa\\theta > \\sigma^2$。\n\n为了对该过程进行数值模拟，可以采用 Euler-Maruyama 方法。该方法的一个单步，时间步长为 $\\Delta t$，从时间 $t_n$ 的状态 $X_n$ 开始，计算在时间 $t_{n+1} = t_n + \\Delta t$ 的下一个状态 $X_{n+1}$ 如下：\n$$X_{n+1} = X_n + \\kappa(\\theta - X_n)\\Delta t + \\sigma \\sqrt{X_n} \\Delta W_n$$\n此处，维纳过程的增量 $\\Delta W_n$ 是一个从均值为0、方差为 $\\Delta t$ 的正态分布中抽取的随机变量。\n\n考虑一个 CIR 模型的具体实例，其参数为 $\\kappa = 0.5$，$\\theta = 0.04$ 和 $\\sigma = 0.3$。对于这些参数，$2\\kappa\\theta = 0.04$ 且 $\\sigma^2 = 0.09$，因此严格正性的充分条件 $2\\kappa\\theta > \\sigma^2$ 并不满足。假设该过程的当前状态为 $X_n = 0.01$。我们希望使用 Euler-Maruyama 方法，在单个时间步长 $\\Delta t = 0.25$ 的情况下，模拟下一个状态 $X_{n+1}$。\n\n尽管理论上保证了连续过程的正性，但该数值格式可能会产生负值。计算下一个模拟值 $X_{n+1}$ 为负的概率。将您的最终答案四舍五入到三位有效数字。", "solution": "我们应用一个 Euler-Maruyama 步：\n$$\nX_{n+1} = X_{n} + \\kappa(\\theta - X_{n})\\Delta t + \\sigma \\sqrt{X_{n}}\\,\\Delta W_{n},\n$$\n其中 $\\Delta W_{n} \\sim \\mathcal{N}(0,\\Delta t)$。在给定 $X_{n}$ 的条件下，这是对一个正态变量的仿射变换，因此 $X_{n+1}$ 服从正态分布，其均值为\n$$\nm = X_{n} + \\kappa(\\theta - X_{n})\\Delta t\n$$\n方差为\n$$\nv = \\sigma^{2} X_{n} \\Delta t,\n$$\n所以标准差为 $s = \\sqrt{v} = \\sigma \\sqrt{X_{n}\\Delta t}$。\n\nEuler 步得到负值的概率为\n$$\n\\mathbb{P}(X_{n+1}  0 \\mid X_{n}) = \\mathbb{P}\\!\\left(\\frac{X_{n+1} - m}{s}  \\frac{0 - m}{s}\\right) = \\Phi\\!\\left(-\\frac{m}{s}\\right),\n$$\n其中 $\\Phi$ 是标准正态累积分布函数。\n\n代入给定值 $\\kappa = 0.5$，$\\theta = 0.04$，$\\sigma = 0.3$，$X_{n} = 0.01$ 和 $\\Delta t = 0.25$，我们计算\n$$\nm = 0.01 + 0.5\\,(0.04 - 0.01)\\,0.25 = 0.01 + 0.5 \\cdot 0.03 \\cdot 0.25 = 0.01375,\n$$\n$$\nv = 0.3^{2} \\cdot 0.01 \\cdot 0.25 = 0.000225, \\quad s = \\sqrt{0.000225} = 0.015.\n$$\n因此，\n$$\n\\frac{m}{s} = \\frac{0.01375}{0.015} = \\frac{11}{12}, \\quad \\text{所以} \\quad \\mathbb{P}(X_{n+1}  0) = \\Phi\\!\\left(-\\frac{11}{12}\\right).\n$$\n数值上，$\\Phi(-11/12) \\approx 0.1797$，四舍五入到三位有效数字为 $0.180$。", "answer": "$$\\boxed{0.180}$$", "id": "1710381"}, {"introduction": "在见证了基础 Euler-Maruyama 方法的缺陷后，我们现在转向一个更稳健且强大的替代方案：精确模拟。值得注意的是，CIR 过程的特殊结构允许我们从一个特定的统计分布中精确地抽样其未来值 $r_{t+\\Delta}$，而没有任何离散化误差。本练习 [@problem_id:3080108] 将引导你利用 CIR 模型与非中心卡方分布之间的联系。你不仅需要推导该精确方案所需的参数，还将亲手实现它，从而彻底解决正性问题，并掌握 CIR 模型在专业应用中的一项基石技术。", "problem": "考虑由以下随机微分方程定义的 Cox–Ingersoll–Ross (CIR) 短期利率模型\n$$\ndr_t \\;=\\; \\kappa \\bigl(\\theta - r_t\\bigr)\\,dt \\;+\\; \\sigma \\sqrt{r_t}\\, dW_t,\n$$\n其中 $\\,\\kappa  0\\,$ 是均值回归速度，$\\,\\theta  0\\,$ 是长期水平，$\\,\\sigma  0\\,$ 是波动率参数，而 $\\,\\{W_t\\}_{t \\ge 0}\\,$ 是标准布朗运动。目标是利用一个涉及非中心卡方分布的分布恒等式，为以 $\\,r_t\\,$ 为条件的转移 $\\,r_{t+\\Delta}\\,$ 构建一个精确的模拟方案。\n\n您的任务是：\n\n1. 从该随机微分方程出发，使用一个有效的变换和 Itô 公式，推导出精确的单步转移机制，该机制允许通过从非中心卡方分布中抽取单个样本并应用适当的缩放来对给定的 $\\,r_t\\,$ 进行 $\\,r_{t+\\Delta}\\,$ 的抽样。您的推导必须从模型定义和平方 Bessel 过程的基本性质开始，而不是在一开始就陈述最终参数。\n\n2. 基于您的推导，设计一个算法，对于给定的参数 $\\,(\\kappa,\\theta,\\sigma,r_t,\\Delta)\\,$，计算：\n   - 非中心卡方分布的自由度 $\\,\\nu\\,$，\n   - 非中心参数 $\\,\\lambda\\,$,\n   - 缩放因子 $\\,c\\,$\n   使得 $\\,r_{t+\\Delta} = c \\cdot X\\,$，其中 $\\,X\\,$ 服从参数为 $\\,(\\nu,\\lambda)\\,$ 的非中心卡方分布。\n\n3. 实现一个程序，对下面的每个测试用例执行以下步骤：\n   - 根据您推导的方案计算 $\\,\\nu\\,$, $\\,\\lambda\\,$ 和 $\\,c\\,$。\n   - 使用固定种子 $\\,123456\\,$ 的伪随机数生成器，从参数为 $\\,(\\nu,\\lambda)\\,$ 的非中心卡方分布中生成 $\\,N\\,$ 个独立的 $\\,X\\,$ 样本，并通过缩放因子 $\\,c\\,$ 将它们映射为 $\\,r_{t+\\Delta}\\,$ 的样本。\n   - 计算模拟出的 $\\,r_{t+\\Delta}\\,$ 的样本均值，并独立地计算模型所蕴含的理论条件均值 $\\,\\mathbb{E}[r_{t+\\Delta}\\mid r_t]\\,$。\n   - 对于每个测试用例，报告一个数对 $[\\text{理论均值}, \\text{蒙特卡洛均值}]$，每个条目四舍五入到 $\\,6\\,$ 位小数。\n\n使用以下参数集测试套件，每个参数集指定为一个有序元组 $\\,(\\kappa,\\theta,\\sigma,r_t,\\Delta)\\,$：\n- 测试 A (一般情况): $(0.5,\\;0.04,\\;0.1,\\;0.03,\\;1.0)$\n- 测试 B (当前短期利率为零): $(1.2,\\;0.05,\\;0.3,\\;0.0,\\;0.5)$\n- 测试 C (接近 Feller 边界 $\\,2\\kappa\\theta = \\sigma^2\\,$): $(0.7,\\;0.02,\\;0.167332005,\\;0.015,\\;3.0)$\n- 测试 D (非常短的时间步长): $(0.3,\\;0.06,\\;0.4,\\;0.08,\\;0.01)$\n\n实现要求：\n- 每个测试用例使用 $\\,N = 200{,}000\\,$ 次模拟和固定种子 $\\,123456\\,$ 以保证可复现性。\n- 最终输出必须是包含所有测试用例结果的单行，格式为逗号分隔的列表之列表，严格遵循以下格式\n$$\n\\bigl[[m_{A}^{\\text{theory}}, m_{A}^{\\text{MC}}], [m_{B}^{\\text{theory}}, m_{B}^{\\text{MC}}], [m_{C}^{\\text{theory}}, m_{C}^{\\text{MC}}], [m_{D}^{\\text{theory}}, m_{D}^{\\text{MC}}]\\bigr],\n$$\n其中每个 $\\,m^{\\text{theory}}\\,$ 和 $\\,m^{\\text{MC}}\\,$ 都四舍五入到 $\\,6\\,$ 位小数。您的程序应生成一行输出，其中仅包含此列表格式（例如，$\\,[[0.012345,0.012346],[\\dots],\\dots]\\,$），不含任何额外文本。\n\n注意：\n- 所有量都是无量纲的；不涉及物理单位。\n- 不使用角度。\n- 不得使用百分比；所有比例均以小数形式表示。", "solution": "该问题要求推导并实现 Cox-Ingersoll-Ross (CIR) 过程的精确模拟方案。CIR 过程，记为 $r_t$，模拟短期利率的演变，由以下随机微分方程 (SDE) 定义：\n$$\ndr_t \\;=\\; \\kappa \\bigl(\\theta - r_t\\bigr)\\,dt \\;+\\; \\sigma \\sqrt{r_t}\\, dW_t\n$$\n其中 $\\kappa  0$ 是均值回归速度，$\\theta  0$ 是长期均值水平，$\\sigma  0$ 是波动率参数，而 $\\{W_t\\}_{t \\ge 0}$ 是标准的一维布朗运动。目标是在给定时间 $t$ 的值 $r_t$ 的条件下，对过程在时间 $t+\\Delta$ 的值 $r_{t+\\Delta}$ 进行抽样。已知的精确转移定律与非中心卡方分布有关。\n\n我们将首先从基本原理推导这种关系，然后制定一个数值算法，最后用已知的理论条件均值对其进行验证。\n\n**1. 精确转移定律的推导**\n\n理解 CIR 过程分布特性的关键在于其与平方 Ornstein-Uhlenbeck (OU) 过程的联系，而后者又与平方 Bessel 过程相关。这种联系为推导转移定律提供了一条构造性路径。\n\n我们假设 CIR 过程 $r_t$ 可以表示为 $\\nu$ 个独立的、相同的 Ornstein-Uhlenbeck 过程平方和的缩放，其中 $\\nu$ 是一个待定参数。设 $\\{X_i(t)\\}_{i=1}^\\nu$ 是满足以下 SDE 的 $\\nu$ 个独立 OU 过程：\n$$\ndX_i(t) = -\\frac{1}{2}\\kappa X_i(t)\\,dt + \\frac{1}{2}\\sigma\\,dW_i(t)\n$$\n其中 $\\{W_i(t)\\}_{i=1}^\\nu$ 是独立的标准布朗运动。\n\n考虑过程 $R_t = \\sum_{i=1}^{\\nu} X_i(t)^2$。我们对每个 $X_i(t)$ 应用 Itô 公式于 $f(x) = x^2$：\n$$\nd(X_i^2) = 2X_i dX_i + \\frac{1}{2}(2)(dX_i)^2\n$$\n二次变分是 $(dX_i)^2 = \\left(\\frac{1}{2}\\sigma\\,dW_i(t)\\right)^2 = \\frac{1}{4}\\sigma^2 dt$。代入 $dX_i$ 的 SDE：\n$$\nd(X_i^2) = 2X_i\\left(-\\frac{1}{2}\\kappa X_i(t)\\,dt + \\frac{1}{2}\\sigma\\,dW_i(t)\\right) + \\frac{1}{4}\\sigma^2\\,dt\n$$\n$$\nd(X_i^2) = -\\kappa X_i(t)^2\\,dt + \\sigma X_i(t)\\,dW_i(t) + \\frac{1}{4}\\sigma^2\\,dt\n$$\n对从 $i=1$ 到 $\\nu$ 的所有 $\\nu$ 个过程求和：\n$$\ndR_t = d\\left(\\sum_{i=1}^{\\nu} X_i^2\\right) = \\sum_{i=1}^{\\nu} d(X_i^2) = \\sum_{i=1}^{\\nu} \\left(-\\kappa X_i^2\\,dt + \\sigma X_i\\,dW_i + \\frac{1}{4}\\sigma^2\\,dt\\right)\n$$\n$$\ndR_t = -\\kappa \\left(\\sum_{i=1}^{\\nu} X_i^2\\right)dt + \\frac{\\nu\\sigma^2}{4}\\,dt + \\sigma \\sum_{i=1}^{\\nu} X_i\\,dW_i\n$$\n注意到 $R_t = \\sum X_i^2$，我们有：\n$$\ndR_t = \\left(\\frac{\\nu\\sigma^2}{4} - \\kappa R_t\\right)dt + \\sigma \\sum_{i=1}^{\\nu} X_i\\,dW_i\n$$\n随机项可以重写。令 $d\\widetilde{W}_t = \\frac{\\sum_{i=1}^{\\nu} X_i\\,dW_i}{\\sqrt{\\sum_{i=1}^{\\nu} X_i^2}} = \\frac{\\sum_{i=1}^{\\nu} X_i\\,dW_i}{\\sqrt{R_t}}$。根据 Lévy 特征定理，由于 $dW_i$ 是独立的，且系数平方和为 $\\sum X_i^2/R_t = 1$，因此 $\\widetilde{W}_t$ 是一个标准布朗运动。所以，随机项是 $\\sigma\\sqrt{R_t}\\,d\\widetilde{W}_t$。\nSDE 变为：\n$$\ndR_t = \\kappa \\left(\\frac{\\nu\\sigma^2}{4\\kappa} - R_t\\right)dt + \\sigma\\sqrt{R_t}\\,d\\widetilde{W}_t\n$$\n如果我们把 $R_t$ 等同于 $r_t$ 并设置长期均值 $\\theta = \\frac{\\nu\\sigma^2}{4\\kappa}$，则 $R_t$ 的这个 SDE 与 $r_t$ 的 CIR SDE 相匹配。这给了我们自由度参数：\n$$\n\\nu = \\frac{4\\kappa\\theta}{\\sigma^2}\n$$\n这个推导对整数 $\\nu$ 严格成立，但得到的转移分布对任何 $\\nu  0$ 都有效。\n\n现在，我们推导以 $r_t$ 为条件的 $r_{t+\\Delta}$ 的分布。在区间 $[t, t+\\Delta]$ 上，初始值为 $X_i(t)$ 的 $X_i$ 的 OU SDE 解为：\n$$\nX_i(t+\\Delta) = X_i(t)e^{-\\frac{1}{2}\\kappa\\Delta} + \\frac{\\sigma}{2}\\int_t^{t+\\Delta} e^{-\\frac{1}{2}\\kappa(t+\\Delta-s)}\\,dW_i(s)\n$$\n在以 $X_i(t)$ 为条件下，$X_i(t+\\Delta)$ 的值是一个服从正态分布的随机变量。其条件均值为：\n$$\n\\mathbb{E}[X_i(t+\\Delta) | X_i(t)] = X_i(t)e^{-\\frac{1}{2}\\kappa\\Delta}\n$$\n其条件方差独立于 $X_i(t)$：\n$$\n\\text{Var}[X_i(t+\\Delta) | X_i(t)] = \\mathbb{E}\\left[\\left(\\frac{\\sigma}{2}\\int_t^{t+\\Delta} e^{-\\frac{1}{2}\\kappa(t+\\Delta-s)}\\,dW_i(s)\\right)^2\\right] = \\frac{\\sigma^2}{4}\\int_t^{t+\\Delta} e^{-\\kappa(t+\\Delta-s)}\\,ds\n$$\n令 $u = t+\\Delta-s$，则 $du = -ds$。积分变为 $\\int_0^{\\Delta} e^{-\\kappa u}\\,du = \\frac{1}{\\kappa}(1-e^{-\\kappa\\Delta})$。\n$$\n\\text{Var}[X_i(t+\\Delta) | X_i(t)] = \\frac{\\sigma^2}{4\\kappa}(1-e^{-\\kappa\\Delta})\n$$\n值 $r_{t+\\Delta} = \\sum_{i=1}^\\nu X_i(t+\\Delta)^2$ 是 $\\nu$ 个独立的、均值不同但方差相同的正态随机变量的平方和。令 $V = \\text{Var}[X_i(t+\\Delta) | X_i(t)]$。\n那么 $X_i(t+\\Delta) \\sim \\mathcal{N}\\left(X_i(t)e^{-\\frac{1}{2}\\kappa\\Delta}, V\\right)$。我们可以写成 $X_i(t+\\Delta) = \\sqrt{V}Z_i$，其中 $Z_i \\sim \\mathcal{N}\\left(\\frac{X_i(t)e^{-\\frac{1}{2}\\kappa\\Delta}}{\\sqrt{V}}, 1\\right)$。因此，\n$$\nr_{t+\\Delta} = \\sum_{i=1}^\\nu (\\sqrt{V}Z_i)^2 = V \\sum_{i=1}^\\nu Z_i^2\n$$\n和 $\\sum_{i=1}^\\nu Z_i^2$ 服从非中心卡方分布 $\\chi'^2(\\nu, \\lambda)$，其自由度为 $\\nu$，非中心参数 $\\lambda$ 由 $Z_i$ 变量均值的平方和给出：\n$$\n\\lambda = \\sum_{i=1}^\\nu \\left(\\frac{X_i(t)e^{-\\frac{1}{2}\\kappa\\Delta}}{\\sqrt{V}}\\right)^2 = \\frac{e^{-\\kappa\\Delta}}{V} \\sum_{i=1}^\\nu X_i(t)^2 = \\frac{e^{-\\kappa\\Delta}}{V} r_t\n$$\n因此，$r_{t+\\Delta}$ 的分布为 $c \\cdot X$，其中 $X \\sim \\chi'^2(\\nu, \\lambda)$，参数为：\n1.  **缩放因子, $c$**: $c = V = \\frac{\\sigma^2(1-e^{-\\kappa\\Delta})}{4\\kappa}$\n2.  **自由度, $\\nu$**: $\\nu = \\frac{4\\kappa\\theta}{\\sigma^2}$\n3.  **非中心参数, $\\lambda$**: $\\lambda = \\frac{r_t e^{-\\kappa\\Delta}}{c} = \\frac{4\\kappa r_t e^{-\\kappa\\Delta}}{\\sigma^2(1-e^{-\\kappa\\Delta})}$\n\n这就构成了精确抽样方案：给定 $r_t$，我们计算 $(\\nu, \\lambda, c)$，从 $\\chi'^2(\\nu, \\lambda)$ 分布中抽取一个随机样本 $X$，并计算出新的利率为 $r_{t+\\Delta} = c \\cdot X$。\n\n**2. 理论条件均值**\n\n我们可以通过计算 $r_{t+\\Delta}$ 的理论条件期望来验证这些参数。一个非中心卡方变量 $X \\sim \\chi'^2(\\nu, \\lambda)$ 的期望是 $\\mathbb{E}[X] = \\nu + \\lambda$。\n因此，$r_{t+\\Delta}$ 的条件期望是：\n$$\n\\mathbb{E}[r_{t+\\Delta} \\mid r_t] = \\mathbb{E}[c \\cdot X] = c \\cdot (\\nu + \\lambda)\n$$\n代入我们推导出的 $c$, $\\nu$ 和 $\\lambda$ 的表达式：\n$$\n\\mathbb{E}[r_{t+\\Delta} \\mid r_t] = \\frac{\\sigma^2(1-e^{-\\kappa\\Delta})}{4\\kappa} \\left( \\frac{4\\kappa\\theta}{\\sigma^2} + \\frac{r_t e^{-\\kappa\\Delta}}{c} \\right)\n$$\n$$\n\\mathbb{E}[r_{t+\\Delta} \\mid r_t] = \\frac{\\sigma^2(1-e^{-\\kappa\\Delta})}{4\\kappa} \\frac{4\\kappa\\theta}{\\sigma^2} + \\frac{\\sigma^2(1-e^{-\\kappa\\Delta})}{4\\kappa} \\frac{r_t e^{-\\kappa\\Delta}}{\\frac{\\sigma^2(1-e^{-\\kappa\\Delta})}{4\\kappa}}\n$$\n$$\n\\mathbb{E}[r_{t+\\Delta} \\mid r_t] = \\theta(1-e^{-\\kappa\\Delta}) + r_t e^{-\\kappa\\Delta}\n$$\n这就是 CIR 过程条件均值的著名解析公式，它证实了我们推导出的参数 $(\\nu, \\lambda, c)$ 的正确性。\n\n**3. 算法与模拟设计**\n\n基于以上推导，针对每个测试用例 $(\\kappa, \\theta, \\sigma, r_t, \\Delta)$ 的算法如下：\n\n1.  **参数计算**：\n    - 计算自由度：$\\nu = \\frac{4\\kappa\\theta}{\\sigma^2}$。\n    - 计算缩放因子：$c = \\frac{\\sigma^2(1 - e^{-\\kappa\\Delta})}{4\\kappa}$。\n    - 计算非中心参数：$\\lambda = \\frac{r_t e^{-\\kappa\\Delta}}{c}$。\n\n2.  **理论均值计算**：\n    - 计算理论条件均值：$m^{\\text{theory}} = r_t e^{-\\kappa\\Delta} + \\theta(1-e^{-\\kappa\\Delta})$。\n\n3.  **蒙特卡洛模拟**：\n    - 用一个固定种子 ($123456$) 初始化伪随机数生成器。\n    - 从非中心卡方分布 $\\chi'^2(\\nu, \\lambda)$ 中生成 $N = 200,000$ 个独立样本 $\\{X_j\\}_{j=1}^N$。\n    - 将这些样本转换为未来利率的样本：$\\{r_{t+\\Delta, j}\\}_{j=1}^N$，其中 $r_{t+\\Delta, j} = c \\cdot X_j$。\n    - 计算样本均值（蒙特卡洛均值）：$m^{\\text{MC}} = \\frac{1}{N} \\sum_{j=1}^{N} r_{t+\\Delta, j}$。\n\n4.  **报告**：\n    - 对于每个测试用例，报告数对 $[m^{\\text{theory}}, m^{\\text{MC}}]$，两个值都四舍五入到 $6$ 位小数。\n\n将对提供的测试用例实施此程序。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import ncx2\n\ndef solve():\n    \"\"\"\n    Implements the exact simulation of the Cox-Ingersoll-Ross (CIR) model\n    and compares the Monte Carlo mean with the theoretical conditional mean.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Each tuple is in the format (kappa, theta, sigma, r_t, delta)\n    test_cases = [\n        (0.5, 0.04, 0.1, 0.03, 1.0),            # Test A (general case)\n        (1.2, 0.05, 0.3, 0.0, 0.5),             # Test B (zero current short rate)\n        (0.7, 0.02, 0.167332005, 0.015, 3.0),   # Test C (near Feller boundary)\n        (0.3, 0.06, 0.4, 0.08, 0.01),           # Test D (very short time step)\n    ]\n\n    # Simulation parameters\n    N = 200000\n    SEED = 123456\n    \n    # Initialize the random number generator\n    rng = np.random.default_rng(SEED)\n\n    results_for_print = []\n\n    for case in test_cases:\n        kappa, theta, sigma, r_t, delta = case\n\n        # 1. Calculate the theoretical conditional mean\n        exp_neg_kappa_delta = np.exp(-kappa * delta)\n        theoretical_mean = r_t * exp_neg_kappa_delta + theta * (1 - exp_neg_kappa_delta)\n\n        # 2. Compute parameters for the noncentral chi-square distribution\n        \n        # Degrees of freedom (nu)\n        nu = 4 * kappa * theta / (sigma**2)\n        \n        # Denominator for c and lambda\n        # This is c * (4*kappa/sigma**2)\n        one_minus_exp = 1 - exp_neg_kappa_delta\n\n        # Scale factor (c)\n        c = (sigma**2 * one_minus_exp) / (4 * kappa)\n        \n        # Noncentrality parameter (lambda)\n        # Handle c=0 case to avoid division by zero, which happens if kappa or delta are very large.\n        # Although not in test cases, it's good practice.\n        if c > 1e-16:\n            lam = (r_t * exp_neg_kappa_delta) / c\n        else: # If c is effectively zero, r_t e^(-kappa*delta) must also be zero for a finite lambda.\n            lam = 0.0\n\n        # Special case for r_t = 0 implies lambda = 0\n        if r_t == 0.0:\n            lam = 0.0\n\n        # 3. Perform Monte Carlo simulation\n        \n        # Generate N samples from the noncentral chi-square distribution\n        # scipy.stats.ncx2 takes df=degrees_of_freedom, nc=noncentrality_parameter\n        non_central_chi_sq_samples = ncx2.rvs(df=nu, nc=lam, size=N, random_state=rng)\n        \n        # Map samples to r_{t+delta} samples via the scale factor c\n        r_t_delta_samples = c * non_central_chi_sq_samples\n        \n        # Compute the sample mean\n        monte_carlo_mean = np.mean(r_t_delta_samples)\n        \n        # 4. Store the rounded results\n        # The required output format is a list, e.g., [0.123456, 0.123457]\n        # We format it to a string '[v1,v2]' to have control over spacing.\n        formatted_pair = f\"[{theoretical_mean:.6f},{monte_carlo_mean:.6f}]\"\n        results_for_print.append(formatted_pair)\n\n    # Final print statement in the exact required format.\n    # The format is a list of lists of numbers.\n    # Example: [[0.012345,0.012346],[...],...]\n    print(f\"[{','.join(results_for_print)}]\")\n\nsolve()\n```", "id": "3080108"}]}