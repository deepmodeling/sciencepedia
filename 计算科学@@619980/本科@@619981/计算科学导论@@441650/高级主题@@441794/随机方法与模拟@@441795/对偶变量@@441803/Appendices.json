{"hands_on_practices": [{"introduction": "对立变量方法的核心在于利用样本间的负相关性来降低估计量的方差。第一个练习将引导你完成一个基础但至关重要的计算：对于一个简单的单调函数，你将亲手推导出标准蒙特卡洛估计和对立变量估计的理论方差，并精确计算出方差缩减的比率。通过这个具体的例子[@problem_id:2188199]，你将对对立变量方法为何有效以及它如何量化地提升效率有一个坚实的理解。", "problem": "在计算科学中，蒙特卡罗方法常被用来近似计算定积分 $I = \\int_{0}^{1} f(x) \\,dx$ 的值。这些方法的一个关键方面是减小估计量的方差以提高准确性。\n\n考虑函数 $f(x) = (1+x)^2$ 在区间 $[0, 1]$ 上的积分。我们将比较用于此积分的两种蒙特卡罗估计量，两者都基于总共 $N$ 次函数求值，其中 $N$ 为一个偶数。\n\n1.  **标准蒙特卡罗估计量 ($\\hat{I}_{\\text{std}}$):**\n    该估计量通过从 Uniform(0,1) 分布中抽取 $N$ 个独立同分布的随机数 $X_1, X_2, \\ldots, X_N$ 形成。该估计量由下式给出：\n    $$ \\hat{I}_{\\text{std}} = \\frac{1}{N} \\sum_{i=1}^{N} f(X_i) $$\n\n2.  **对立变量估计量 ($\\hat{I}_{\\text{anti}}$):**\n    该估计量通过从 Uniform(0,1) 分布中抽取 $M = N/2$ 个独立随机数 $U_1, U_2, \\ldots, U_M$ 形成。对于每个 $U_i$，我们构成一对‘对立’样本 $(U_i, 1-U_i)$。该估计量由下式给出：\n    $$ \\hat{I}_{\\text{anti}} = \\frac{1}{M} \\sum_{i=1}^{M} \\frac{f(U_i) + f(1-U_i)}{2} $$\n\n你的任务是解析地确定对于这个特定函数，使用对立变量所能达到的理论方差缩减。计算比率 $R = \\frac{\\text{Var}(\\hat{I}_{\\text{anti}})}{\\text{Var}(\\hat{I}_{\\text{std}})}$ 的精确值。", "solution": "设 $X\\sim \\text{Uniform}(0,1)$ 且 $f(x)=(1+x)^{2}=1+2x+x^{2}$。具有 $N$ 个独立同分布样本的标准蒙特卡罗估计量的方差为\n$$\n\\text{Var}(\\hat{I}_{\\text{std}})=\\frac{\\text{Var}(f(X))}{N}.\n$$\n通过计算 $E[f(X)]$ 和 $E[f(X)^{2}]$ 来计算 $\\text{Var}(f(X))$。使用 $E[X]=\\frac{1}{2}$，$E[X^{2}]=\\frac{1}{3}$，$E[X^{3}]=\\frac{1}{4}$，$E[X^{4}]=\\frac{1}{5}$，\n$$\nE[f(X)]=E[1+2X+X^{2}]=1+2\\cdot \\frac{1}{2}+\\frac{1}{3}=\\frac{7}{3},\n$$\n且\n$$\nf(X)^{2}=(1+2X+X^{2})^{2}=1+4X+6X^{2}+4X^{3}+X^{4},\n$$\n所以\n$$\nE[f(X)^{2}]=1+4\\cdot \\frac{1}{2}+6\\cdot \\frac{1}{3}+4\\cdot \\frac{1}{4}+\\frac{1}{5}=\\frac{31}{5}.\n$$\n因此\n$$\n\\text{Var}(f(X))=E[f(X)^{2}]-\\left(E[f(X)]\\right)^{2}=\\frac{31}{5}-\\frac{49}{9}=\\frac{34}{45}.\n$$\n\n对于对立估计量，定义 $M=\\frac{N}{2}$ 和 $Y=\\frac{f(U)+f(1-U)}{2}$，其中 $U\\sim \\text{Uniform}(0,1)$。那么\n$$\n\\text{Var}(\\hat{I}_{\\text{anti}})=\\frac{\\text{Var}(Y)}{M}.\n$$\n使用\n$$\n\\text{Var}(Y)=\\frac{1}{4}\\text{Var}\\big(f(U)+f(1-U)\\big)=\\frac{1}{4}\\left(2\\,\\text{Var}(f(X))+2\\,\\text{Cov}(f(U),f(1-U))\\right)\n=\\frac{1}{2}\\left(\\text{Var}(f(X))+\\text{Cov}(f(U),f(1-U))\\right).\n$$\n因此方差比为\n$$\nR=\\frac{\\text{Var}(\\hat{I}_{\\text{anti}})}{\\text{Var}(\\hat{I}_{\\text{std}})}\n=\\frac{\\frac{\\text{Var}(Y)}{M}}{\\frac{\\text{Var}(f(X))}{N}}\n=\\frac{\\text{Var}(Y)}{\\text{Var}(f(X))}\\cdot \\frac{N}{M}\n=\\frac{\\frac{1}{2}\\left(\\text{Var}(f(X))+\\text{Cov}(f(U),f(1-U))\\right)}{\\text{Var}(f(X))}\\cdot 2\n=1+\\frac{\\text{Cov}(f(U),f(1-U))}{\\text{Var}(f(X))}.\n$$\n\n接下来需要计算 $\\text{Cov}(f(U),f(1-U))$。由于 $f(1-U)=(2-U)^{2}=4-4U+U^{2}$，\n$$\nf(U)f(1-U)=(1+2U+U^{2})(4-4U+U^{2})=4+4U-3U^{2}-2U^{3}+U^{4}.\n$$\n因此\n$$\nE[f(U)f(1-U)]=4+4\\cdot \\frac{1}{2}-3\\cdot \\frac{1}{3}-2\\cdot \\frac{1}{4}+\\frac{1}{5}=\\frac{47}{10},\n$$\n且已知 $E[f(U)]=\\frac{7}{3}$，\n$$\n\\text{Cov}(f(U),f(1-U))=E[f(U)f(1-U)]-\\left(E[f(U)]\\right)^{2}=\\frac{47}{10}-\\frac{49}{9}=-\\frac{67}{90}.\n$$\n因此，\n$$\nR=1+\\frac{-\\frac{67}{90}}{\\frac{34}{45}}=1-\\frac{67}{90}\\cdot \\frac{45}{34}=1-\\frac{67}{68}=\\frac{1}{68}.\n$$\n因此，对于此函数 $f$，对立变量估计量的方差是标准蒙特卡罗估计量方差的 $\\frac{1}{68}$。", "answer": "$$\\boxed{\\frac{1}{68}}$$", "id": "2188199"}, {"introduction": "理解了一个方法何时有效，与理解它为何有效同样重要。虽然对立变量在处理单调函数时表现出色，但当面对其他类型的函数时，其效果可能会出乎意料。这个练习[@problem_id:3285865]将探讨被积函数 $f(x) = \\sin(k \\pi x)$ 的对称性如何戏剧性地影响方差缩减的效果。你将发现，根据参数 $k$ 的奇偶性，该方法可能实现完美的方差消除，也可能反而使方差加倍，从而深刻揭示该技术成功的关键在于被积函数相对于积分区间中心的对称性。", "problem": "考虑使用带有对立变量 (AV) 的蒙特卡洛 (MC) 方法来估计积分 $I(k) = \\int_{0}^{1} \\sin(k \\pi x) \\, dx$，其中 $k$ 是一个固定的正整数。设 $\\{U_i\\}_{i=1}^{n}$ 是来自 $\\mathrm{Uniform}(0,1)$ 的独立同分布样本，且 $n$ 为偶数。将原始蒙特卡洛 (MC) 估计量定义为\n$$\n\\widehat{I}_{\\mathrm{MC}} = \\frac{1}{n} \\sum_{i=1}^{n} f(U_i)\n$$\n其中 $f(x) = \\sin(k \\pi x)$。将样本配对为 $Y_i = \\frac{f(U_i) + f(1 - U_i)}{2}$（$i = 1, \\dots, n/2$），并将对立估计量定义为\n$$\n\\widehat{I}_{\\mathrm{AV}} = \\frac{1}{n/2} \\sum_{i=1}^{n/2} Y_i\n$$\n仅使用期望、方差和协方差的基本定义以及基本的三角恒等式，推导方差比\n$$\nR(k) = \\frac{\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}})}{\\mathrm{Var}(\\widehat{I}_{\\mathrm{MC}})}\n$$\n的一个精确的闭式表达式（仅用 $k$ 表示）。\n将最终结果表示为关于 $k$ 的单个简化解析表达式。无需进行数值舍入。", "solution": "### 解题推导\n目标是计算比率 $R(k) = \\frac{\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}})}{\\mathrm{Var}(\\widehat{I}_{\\mathrm{MC}})}$。我们首先表达这两个估计量的方差。\n\n设 $U$ 是一个服从 $\\mathrm{Uniform}(0,1)$ 分布的随机变量。随机变量 $f(U_i)$ 是独立同分布的，具有共同的方差 $\\mathrm{Var}(f(U))$。\n原始蒙特卡洛估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{I}_{\\mathrm{MC}}) = \\mathrm{Var}\\left(\\frac{1}{n} \\sum_{i=1}^{n} f(U_i)\\right) = \\frac{1}{n^2} \\sum_{i=1}^{n} \\mathrm{Var}(f(U_i)) = \\frac{n}{n^2} \\mathrm{Var}(f(U)) = \\frac{1}{n} \\mathrm{Var}(f(U)).\n$$\n对立估计量是 $n/2$ 个独立同分布的随机变量 $Y_i = \\frac{f(U_i) + f(1 - U_i)}{2}$ 的平均值。设 $Y$ 是代表任何一个 $Y_i$ 的随机变量。\n对立变量估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}}) = \\mathrm{Var}\\left(\\frac{1}{n/2} \\sum_{i=1}^{n/2} Y_i\\right) = \\frac{1}{(n/2)^2} \\sum_{i=1}^{n/2} \\mathrm{Var}(Y_i) = \\frac{n/2}{(n/2)^2} \\mathrm{Var}(Y) = \\frac{2}{n} \\mathrm{Var}(Y).\n$$\n$Y$ 的方差为：\n$$\n\\mathrm{Var}(Y) = \\mathrm{Var}\\left(\\frac{f(U) + f(1-U)}{2}\\right) = \\frac{1}{4} \\mathrm{Var}(f(U) + f(1-U)).\n$$\n使用两个随机变量之和的方差公式 $\\mathrm{Var}(A+B) = \\mathrm{Var}(A) + \\mathrm{Var}(B) + 2\\mathrm{Cov}(A,B)$，我们得到：\n$$\n\\mathrm{Var}(Y) = \\frac{1}{4} \\left( \\mathrm{Var}(f(U)) + \\mathrm{Var}(f(1-U)) + 2\\mathrm{Cov}(f(U), f(1-U)) \\right).\n$$\n由于 $U \\sim \\mathrm{Uniform}(0,1)$，随机变量 $V = 1-U$ 也服从 $\\mathrm{Uniform}(0,1)$ 分布。因此，$\\mathrm{Var}(f(1-U)) = \\mathrm{Var}(f(V)) = \\mathrm{Var}(f(U))$。\n将此代回，我们有：\n$$\n\\mathrm{Var}(Y) = \\frac{1}{4} \\left( 2\\mathrm{Var}(f(U)) + 2\\mathrm{Cov}(f(U), f(1-U)) \\right) = \\frac{1}{2} \\left( \\mathrm{Var}(f(U)) + \\mathrm{Cov}(f(U), f(1-U)) \\right).\n$$\n因此，对立估计量的方差为：\n$$\n\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}}) = \\frac{2}{n} \\mathrm{Var}(Y) = \\frac{1}{n} \\left( \\mathrm{Var}(f(U)) + \\mathrm{Cov}(f(U), f(1-U)) \\right).\n$$\n现在我们可以写出方差比 $R(k)$：\n$$\nR(k) = \\frac{\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}})}{\\mathrm{Var}(\\widehat{I}_{\\mathrm{MC}})} = \\frac{\\frac{1}{n} \\left( \\mathrm{Var}(f(U)) + \\mathrm{Cov}(f(U), f(1-U)) \\right)}{\\frac{1}{n} \\mathrm{Var}(f(U))} = 1 + \\frac{\\mathrm{Cov}(f(U), f(1-U))}{\\mathrm{Var}(f(U))}.\n$$\n为了计算这个比率，我们必须分析协方差项。此分析的核心在于函数 $f(x) = \\sin(k \\pi x)$ 的对称性质。让我们计算 $f(1-x)$：\n$$\nf(1-x) = \\sin(k \\pi (1-x)) = \\sin(k \\pi - k \\pi x).\n$$\n使用三角恒等式 $\\sin(A-B) = \\sin(A)\\cos(B) - \\cos(A)\\sin(B)$：\n$$\nf(1-x) = \\sin(k \\pi)\\cos(k \\pi x) - \\cos(k \\pi)\\sin(k \\pi x).\n$$\n由于 $k$ 是一个整数，$\\sin(k \\pi) = 0$ 且 $\\cos(k \\pi) = (-1)^k$。该表达式简化为：\n$$\nf(1-x) = 0 - (-1)^k \\sin(k \\pi x) = -(-1)^k f(x).\n$$\n这个关系是关键性的。它意味着随机变量 $f(1-U)$ 和 $f(U)$ 通过 $f(1-U) = -(-1)^k f(U)$ 相关联。\n\n我们现在可以分析协方差 $\\mathrm{Cov}(f(U), f(1-U))$：\n$$\n\\mathrm{Cov}(f(U), f(1-U)) = \\mathrm{Cov}(f(U), -(-1)^k f(U)).\n$$\n使用属性 $\\mathrm{Cov}(X, cY) = c\\mathrm{Cov}(X, Y)$，其中 $c = -(-1)^k$：\n$$\n\\mathrm{Cov}(f(U), f(1-U)) = -(-1)^k \\mathrm{Cov}(f(U), f(U)) = -(-1)^k \\mathrm{Var}(f(U)).\n$$\n现在我们可以将此直接代入我们的比率 $R(k)$ 的表达式中：\n$$\nR(k) = 1 + \\frac{-(-1)^k \\mathrm{Var}(f(U))}{\\mathrm{Var}(f(U))}.\n$$\n只要 $\\mathrm{Var}(f(U)) \\neq 0$，我们就可以消去方差项。方差 $\\mathrm{Var}(f(U)) = \\mathrm{Var}(\\sin(k\\pi U))$ 仅在 $\\sin(k\\pi U)$ 为常数时才为零，而对于正整数 $k$ 来说情况并非如此。因此，这种消去是有效的。\n$$\nR(k) = 1 - (-1)^k.\n$$\n这个单一的表达式优雅地捕捉了 $k$ 为偶数和奇数时的行为。\n\n为完整起见，我们可以详细说明两种情况：\n1.  如果 $k$ 是一个偶数，$k = 2m$，其中 $m \\ge 1$ 是某个整数。那么 $(-1)^k = 1$。比率为 $R(k) = 1 - 1 = 0$。这是因为当 $k$ 为偶数时，$f(1-x) = -f(x)$，意味着函数关于点 $x=1/2$ 是奇对称的。对立配对的平均值为 $Y_i = \\frac{f(U_i) + f(1-U_i)}{2} = \\frac{f(U_i) - f(U_i)}{2} = 0$。估计量 $\\widehat{I}_{\\mathrm{AV}}$ 恒等于零，因此其方差为零。这对应于完美的方差缩减。\n\n2.  如果 $k$ 是一个奇数，$k = 2m-1$，其中 $m \\ge 1$ 是某个整数。那么 $(-1)^k = -1$。比率为 $R(k) = 1 - (-1) = 2$。这是因为当 $k$ 为奇数时，$f(1-x) = -(-1)f(x) = f(x)$，意味着函数关于点 $x=1/2$ 是偶对称的。对立配对的平均值为 $Y_i = \\frac{f(U_i) + f(1-U_i)}{2} = \\frac{f(U_i) + f(U_i)}{2} = f(U_i)$。估计量变为 $\\widehat{I}_{\\mathrm{AV}} = \\frac{1}{n/2} \\sum_{i=1}^{n/2} f(U_i)$。其方差为 $\\mathrm{Var}(\\widehat{I}_{\\mathrm{AV}}) = \\frac{1}{n/2}\\mathrm{Var}(f(U)) = \\frac{2}{n}\\mathrm{Var}(f(U))$。比率变为 $\\frac{2/n \\cdot \\mathrm{Var}(f(U))}{1/n \\cdot \\mathrm{Var}(f(U))} = 2$。在这种情况下，与使用相同函数求值次数（$n$ 次）的原始蒙特卡洛估计量相比，对立抽样技术实际上使方差加倍。\n\n问题要求使用基本定义进行推导，这已经提供。推导过程不需要显式计算 $\\mathrm{Var}(f(U))$，而是仅依赖于被积函数的对称性质。最终的表达式只是一个关于 $k$ 的函数。", "answer": "$$\n\\boxed{1 - (-1)^k}\n$$", "id": "3285865"}, {"introduction": "理论与实践相结合是掌握任何计算科学工具的必经之路。作为本章的综合练习，这个问题[@problem_id:3253450]将引导你从第一性原理出发，首先证明对立采样在一般情况下为何总能保证方差不会增加，并特别地，对于单调函数为何能确保方差缩减。随后，你将通过编写代码，对包括单调函数和非单调对称函数在内的一系列测试函数进行经验验证，从而将抽象的理论证明与具体的计算结果联系起来，巩固你对对立变量方法适用性与局限性的认识。", "problem": "您需要研究并实现用于单位区间上蒙特卡洛积分的对立采样方法。设 $g:[0,1]\\to\\mathbb{R}$ 是一个平方可积函数。目标是估计积分 $I=\\int_{0}^{1} g(x)\\,dx$，并比较原始蒙特卡洛估计量与使用配对 $(U,1-U)$ 的对立估计量的方差，其中 $U$ 是一个服从 $\\text{Uniform}([0,1])$ 分布的随机变量。\n\n从期望和方差的基本定义出发，不依赖任何预先计算的“捷径”公式，解决以下问题：\n\n- 将基于 $M$ 个独立样本 $U_1,\\dots,U_M$（其中 $U_i\\sim\\text{Uniform}([0,1])$）构建的原始蒙特卡洛估计量 $\\widehat{I}_{\\text{crude}}$ 定义为 $X_i=g(U_i)$ 的样本均值。将使用 $M$ 个对立配对 $(U_i,1-U_i)$ 构建的对立估计量 $\\widehat{I}_{\\text{anti}}$ 定义为 $A_i=\\tfrac{1}{2}\\big(g(U_i)+g(1-U_i)\\big)$ 的样本均值。从第一性原理和核心定义出发，证明对立配对平均值 $A_i$ 的方差小于或等于 $X_i$ 的方差；因此，对于任何平方可积函数 $g$，$\\widehat{I}_{\\text{anti}}$ 的方差小于或等于 $\\widehat{I}_{\\text{crude}}$ 的方差。\n\n- 此外，对于 $g$ 在 $[0,1]$ 上是凸且单调的特殊情况，证明协方差 $\\mathrm{Cov}\\big(g(U),g(1-U)\\big)\\le 0$。解释当对于所有 $x\\in[0,1]$ 都有 $g(1-x)=g(x)$ 时，等式成立的情况。\n\n- 实现一个完整的程序，该程序为几个测试函数 $g$ 估计 $I$，计算 $X=g(U)$ 和 $A=\\tfrac{1}{2}\\big(g(U)+g(1-U)\\big)$ 的经验单样本方差，并报告方差比 $r=\\widehat{\\mathrm{Var}}(A)/\\widehat{\\mathrm{Var}}(X)$。对两种估计量使用相同数量的配对 $M$ 和相同的基础均匀分布样本 $U_i$，以确保唯一的区别在于对立配对。\n\n使用以下测试套件。对于每种情况，程序必须：\n- 使用给定的随机种子，抽取 $M$ 个独立的 $U_i\\sim\\text{Uniform}([0,1])$ 样本；\n- 计算 $X_i=g(U_i)$ 和 $A_i=\\tfrac{1}{2}\\big(g(U_i)+g(1-U_i)\\big)$；\n- 计算原始估计和对立估计 $\\widehat{I}_{\\text{crude}}=\\tfrac{1}{M}\\sum_{i=1}^M X_i$ 和 $\\widehat{I}_{\\text{anti}}=\\tfrac{1}{M}\\sum_{i=1}^M A_i$；\n- 计算无偏样本方差 $\\widehat{\\mathrm{Var}}(X)$ 和 $\\widehat{\\mathrm{Var}}(A)$（除数为 $M-1$）；\n- 计算比率 $r=\\widehat{\\mathrm{Var}}(A)/\\widehat{\\mathrm{Var}}(X)$；\n- 将 $r$ 与 $1$ 在容差 $\\tau$ 内进行比较，并报告 $r\\le 1+\\tau$ 是否成立。\n\n测试套件（每行指定 $(g(x), I, M, \\text{seed})$）：\n- $g_1(x)=x^2$, $I_1=\\int_0^1 x^2\\,dx=\\frac{1}{3}$, $M=200{,}000$, seed $=12345$.\n- $g_2(x)=\\exp(x)$, $I_2=\\int_0^1 \\exp(x)\\,dx=e-1$, $M=200{,}000$, seed $=54321$.\n- $g_3(x)=(x-\\frac{1}{2})^2$, $I_3=\\int_0^1 (x-\\frac{1}{2})^2\\,dx=\\frac{1}{12}$, $M=200{,}000$, seed $=20231011$.\n- $g_4(x)=x$, $I_4=\\int_0^1 x\\,dx=\\frac{1}{2}$, $M=200{,}000$, seed $=7$.\n\n将比较容差设置为 $\\tau=0.02$。角度单位不适用。此问题中没有物理单位。输出必须是实数（浮点数）和布尔值。\n\n最终输出格式：您的程序应生成单行输出，其中按顺序包含每个测试用例 $g_1,g_2,g_3,g_4$ 的配对 $(r, b)$，其中 $r$ 是四舍五入到六位小数的方差比，$b$ 是一个布尔值，指示 $r\\le 1+\\tau$ 是否成立。将所有结果按顺序 $[r_1,b_1,r_2,b_2,r_3,b_3,r_4,b_4]$ 汇总到一个列表中，并将其打印为用逗号分隔并用方括号括起来的列表，例如 $[0.500000,True, \\dots]$。", "solution": "### 理论推导\n\n设 $U$ 是一个服从区间 $[0, 1]$ 上均匀分布的随机变量，记为 $U \\sim \\text{Uniform}([0,1])$。待估计的积分是 $I = \\int_{0}^{1} g(x)\\,dx$。根据连续随机变量的期望定义，该积分等价于 $g(U)$ 的期望值，即 $I = \\mathbb{E}[g(U)]$。\n\n随机变量 $V = 1-U$ 也服从 $\\text{Uniform}([0,1])$ 分布。这可以从其累积分布函数看出：对于 $v \\in [0,1]$，$F_V(v) = P(V \\le v) = P(1-U \\le v) = P(U \\ge 1-v) = 1 - P(U  1-v) = 1 - (1-v) = v$。其概率密度函数为 $f_V(v) = dF_V/dv = 1$（在 $[0,1]$ 上）。因此，$\\mathbb{E}[g(1-U)] = \\int_0^1 g(v) f_V(v) dv = \\int_0^1 g(v) dv = I$。\n\n我们有两个基于从 $\\text{Uniform}([0,1])$ 分布中独立抽取的 $M$ 个样本 $U_1, \\dots, U_M$ 的估计量。\n原始蒙特卡洛估计量的单样本项是 $X_i = g(U_i)$。\n对立估计量的单样本项是 $A_i = \\frac{1}{2}(g(U_i) + g(1-U_i))$。\n\n两种估计量都是无偏的，因为它们的单样本项的期望都是 $I$：\n$\\mathbb{E}[X_i] = \\mathbb{E}[g(U_i)] = I$。\n$\\mathbb{E}[A_i] = \\mathbb{E}\\left[\\frac{1}{2}(g(U_i) + g(1-U_i))\\right] = \\frac{1}{2}(\\mathbb{E}[g(U_i)] + \\mathbb{E}[g(1-U_i)]) = \\frac{1}{2}(I + I) = I$。\n\n估计量被定义为样本均值：\n$\\widehat{I}_{\\text{crude}} = \\frac{1}{M}\\sum_{i=1}^M X_i$\n$\\widehat{I}_{\\text{anti}} = \\frac{1}{M}\\sum_{i=1}^M A_i$\n\n这些估计量的方差为：\n$\\mathrm{Var}(\\widehat{I}_{\\text{crude}}) = \\mathrm{Var}\\left(\\frac{1}{M}\\sum_{i=1}^M X_i\\right) = \\frac{1}{M^2}\\sum_{i=1}^M \\mathrm{Var}(X_i) = \\frac{M \\mathrm{Var}(X_i)}{M^2} = \\frac{\\mathrm{Var}(X_i)}{M}$。\n$\\mathrm{Var}(\\widehat{I}_{\\text{anti}}) = \\mathrm{Var}\\left(\\frac{1}{M}\\sum_{i=1}^M A_i\\right) = \\frac{1}{M^2}\\sum_{i=1}^M \\mathrm{Var}(A_i) = \\frac{M \\mathrm{Var}(A_i)}{M^2} = \\frac{\\mathrm{Var}(A_i)}{M}$。\n样本 $(X_i)$ 是独立同分布的，样本 $(A_i)$ 也是独立同分布的。\n\n**证明 $\\mathrm{Var}(A_i) \\le \\mathrm{Var}(X_i)$**\n\n为简化起见，我们省略下标 $i$，并分析通用项 $X = g(U)$ 和 $A = \\frac{1}{2}(g(U) + g(1-U))$ 的方差。\n\n$A$ 的方差由下式给出：\n$$ \\mathrm{Var}(A) = \\mathrm{Var}\\left(\\frac{1}{2}(g(U) + g(1-U))\\right) $$\n使用性质 $\\mathrm{Var}(cZ) = c^2\\mathrm{Var}(Z)$，其中 $c = \\frac{1}{2}$：\n$$ \\mathrm{Var}(A) = \\frac{1}{4} \\mathrm{Var}(g(U) + g(1-U)) $$\n使用和的方差性质 $\\mathrm{Var}(Z_1+Z_2) = \\mathrm{Var}(Z_1) + \\mathrm{Var(Z_2)} + 2\\mathrm{Cov}(Z_1, Z_2)$：\n$$ \\mathrm{Var}(A) = \\frac{1}{4} \\left( \\mathrm{Var}(g(U)) + \\mathrm{Var}(g(1-U)) + 2\\mathrm{Cov}(g(U), g(1-U)) \\right) $$\n由于 $U$ 和 $1-U$ 具有相同的分布，随机变量 $g(U)$ 和 $g(1-U)$ 是同分布的。因此，它们具有相同的方差：$\\mathrm{Var}(g(U)) = \\mathrm{Var}(g(1-U))$。我们将其记为 $\\mathrm{Var}(X)$。\n$$ \\mathrm{Var}(A) = \\frac{1}{4} \\left( \\mathrm{Var}(X) + \\mathrm{Var}(X) + 2\\mathrm{Cov}(g(U), g(1-U)) \\right) $$\n$$ \\mathrm{Var}(A) = \\frac{1}{2} \\left( \\mathrm{Var}(X) + \\mathrm{Cov}(g(U), g(1-U)) \\right) $$\n要证明 $\\mathrm{Var}(A) \\le \\mathrm{Var}(X)$，我们需要证明：\n$$ \\frac{1}{2} \\left( \\mathrm{Var}(X) + \\mathrm{Cov}(g(U), g(1-U)) \\right) \\le \\mathrm{Var}(X) $$\n$$ \\mathrm{Var}(X) + \\mathrm{Cov}(g(U), g(1-U)) \\le 2\\mathrm{Var}(X) $$\n$$ \\mathrm{Cov}(g(U), g(1-U)) \\le \\mathrm{Var}(X) $$\n这个不等式是协方差的柯西-施瓦茨不等式的一个直接推论，该不等式表明 $|\\mathrm{Cov}(Z_1, Z_2)| \\le \\sqrt{\\mathrm{Var}(Z_1)\\mathrm{Var}(Z_2)}$。\n将此应用于 $Z_1 = g(U)$ 和 $Z_2 = g(1-U)$：\n$$ |\\mathrm{Cov}(g(U), g(1-U))| \\le \\sqrt{\\mathrm{Var}(g(U))\\mathrm{Var}(g(1-U))} $$\n由于 $\\mathrm{Var}(g(U)) = \\mathrm{Var}(g(1-U)) = \\mathrm{Var}(X)$，这可以简化为：\n$$ |\\mathrm{Cov}(g(U), g(1-U))| \\le \\sqrt{\\mathrm{Var}(X) \\cdot \\mathrm{Var}(X)} = \\mathrm{Var}(X) $$\n由于任何数都小于或等于其绝对值，我们有 $\\mathrm{Cov}(g(U), g(1-U)) \\le |\\mathrm{Cov}(g(U), g(1-U))|$。\n综合这些，我们得到 $\\mathrm{Cov}(g(U), g(1-U)) \\le \\mathrm{Var}(X)$，这就证明了所需的不等式 $\\mathrm{Var}(A) \\le \\mathrm{Var}(X)$。\n因此，$\\mathrm{Var}(\\widehat{I}_{\\text{anti}}) = \\frac{\\mathrm{Var}(A)}{M} \\le \\frac{\\mathrm{Var}(X)}{M} = \\mathrm{Var}(\\widehat{I}_{\\text{crude}})$。这表明对立采样绝不会增加估计量的方差。方差缩减的幅度取决于协方差项是否为负。\n\n**单调函数的协方差**\n\n设 $g$ 是 $[0,1]$ 上的一个单调函数。不失一般性，我们假设 $g$ 是非递减的。设 $h_1(x) = g(x)$，它是一个非递减函数，以及 $h_2(x) = g(1-x)$。由于 $1-x$ 是 $x$ 的递减函数，而 $g$ 是非递减的，它们的复合函数 $h_2(x) = g(1-x)$ 是 $x$ 的一个非递增（即递减）函数。\n\n我们使用 Chebyshev 积分不等式，该不等式表明，如果 $f_1$ 在 $[a,b]$ 上非递减，$f_2$ 在 $[a,b]$ 上非递增，则\n$$ \\int_a^b f_1(x)f_2(x)\\,dx \\le \\frac{1}{b-a} \\left(\\int_a^b f_1(x)\\,dx\\right) \\left(\\int_a^b f_2(x)\\,dx\\right) $$\n对于我们在 $[0,1]$ 上的情况，这便是：\n$$ \\int_0^1 g(x)g(1-x)\\,dx \\le \\left(\\int_0^1 g(x)\\,dx\\right) \\left(\\int_0^1 g(1-x)\\,dx\\right) $$\n用 $U \\sim \\text{Uniform}([0,1])$ 的期望来表示：\n$$ \\mathbb{E}[g(U)g(1-U)] \\le \\mathbb{E}[g(U)] \\mathbb{E}[g(1-U)] $$\n根据定义，协方差为 $\\mathrm{Cov}(g(U), g(1-U)) = \\mathbb{E}[g(U)g(1-U)] - \\mathbb{E}[g(U)]\\mathbb{E}[g(1-U)]$。\n因此，对于单调函数 $g$，我们有 $\\mathrm{Cov}(g(U), g(1-U)) \\le 0$。这个结果并不严格要求 $g$ 的凸性，但许多例子中常用的单调函数（如 $k \\ge 1$ 时的 $x^k$，$e^x$）也都是凸函数。\n\n**$\\mathrm{Cov}(g(U),g(1-U))$ 的等式成立情况**\n\n问题要求在单调函数协方差性质的背景下，解释当 $g(1-x) = g(x)$ 时等式成立的情况。如果一个函数 $g$ 在 $[0,1]$ 上既是单调的（非递减或非递增）又关于 $x=1/2$ 对称（即对于所有 $x \\in [0,1]$ 都有 $g(x)=g(1-x)$），那么它必定是一个常数函数。\n要证明这一点，假设 $g$ 是非递减且对称的。对于任意 $x_1, x_2 \\in [0,1]$ 且 $x_1  x_2$：\n$1$. 根据单调性：$g(x_1) \\le g(x_2)$。\n$2$. 由 $x_1  x_2$ 可得 $1-x_2  1-x_1$。再次根据单调性：$g(1-x_2) \\le g(1-x_1)$。\n$3$. 利用对称性，$g(1-x_2)=g(x_2)$ 且 $g(1-x_1)=g(x_1)$。将此代入步骤2的不等式得到 $g(x_2) \\le g(x_1)$。\n综合步骤1和3的结果，我们有 $g(x_1) \\le g(x_2)$ 和 $g(x_2) \\le g(x_1)$，这意味着 $g(x_1)=g(x_2)$。由于这对任意一对 $x_1, x_2$ 都成立，函数 $g$ 在 $[0,1]$ 上必为常数。\n如果对于某个常数 $c$ 有 $g(x)=c$，那么 $g(U)=c$ 且 $g(1-U)=c$。两个常数的协方差为零：$\\mathrm{Cov}(c,c) = 0$。因此，对于一个既单调又对称的函数，其协方差为零。\n\n**对称函数的方差比**\n\n一个需要单独考虑的情况是当 $g$ 是对称的，即 $g(x) = g(1-x)$，但不一定是单调的（例如，$g_3(x)=(x-1/2)^2$）。\n在这种情况下，对立配对中的两项是相同的：$g(U_i) = g(1-U_i)$。\n对立的单样本项变为 $A_i = \\frac{1}{2}(g(U_i) + g(U_i)) = g(U_i) = X_i$。\n对立估计量与原始估计量相同，它们的样本方差也必须相等：$\\widehat{\\mathrm{Var}}(A) = \\widehat{\\mathrm{Var}}(X)$。这导致方差比 $r=1$。\n这对应于最大可能的协方差 $\\mathrm{Cov}(g(U), g(1-U)) = \\mathrm{Var}(g(U))$，从而得出 $\\mathrm{Var}(A) = \\frac{1}{2}(\\mathrm{Var}(X) + \\mathrm{Var}(X)) = \\mathrm{Var}(X)$。在这种情况下，对立采样没有任何好处。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Performs Monte Carlo integration using crude and antithetic sampling,\n    and compares their empirical variances for a suite of test functions.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (function_name, g(x), I, M, seed)\n    # The exact integral I is for context and not used in the calculations.\n    test_cases = [\n        ('g1(x) = x^2', lambda x: x**2, 1/3, 200000, 12345),\n        ('g2(x) = exp(x)', lambda x: np.exp(x), np.e - 1, 200000, 54321),\n        ('g3(x) = (x-1/2)^2', lambda x: (x - 0.5)**2, 1/12, 200000, 20231011),\n        ('g4(x) = x', lambda x: x, 0.5, 200000, 7),\n    ]\n\n    # Set the comparison tolerance\n    tau = 0.02\n    \n    # List to store the final results\n    results_list = []\n\n    for name, g, I_exact, M, seed in test_cases:\n        # 1. Set up the random number generator with the specified seed.\n        rng = np.random.default_rng(seed)\n\n        # 2. Draw M independent uniform random numbers.\n        U = rng.uniform(0, 1, M)\n\n        # 3. Compute the sample values for crude and antithetic estimators.\n        # Crude samples\n        X = g(U)\n        \n        # Antithetic samples: A_i = 1/2 * (g(U_i) + g(1-U_i))\n        A = 0.5 * (g(U) + g(1 - U))\n\n        # 4. Compute the crude and antithetic estimates for the integral.\n        # This part is required by the problem description, though not for the final output.\n        I_crude_hat = np.mean(X)\n        I_anti_hat = np.mean(A)\n\n        # 5. Compute the unbiased sample variances (using ddof=1 for divisor M-1).\n        var_X = np.var(X, ddof=1)\n        var_A = np.var(A, ddof=1)\n        \n        # Handle the case where var_X is zero to avoid division by zero.\n        # This occurs when g(U) is constant, e.g., if g is a constant function.\n        # For g(x)=x, var_A is analytically zero, but might be a tiny float.\n        if var_X == 0:\n            # If var_A is also zero, ratio is undefined, but can be treated as 1 (no reduction)\n            # or 0 if reduction is perfect. Given the context, if var_A is also 0,\n            # it implies a perfect reduction from a non-constant X.\n            r = 0.0 if var_A  var_X else 1.0\n        else:\n             r = var_A / var_X\n\n        # 6. Compare the ratio to 1 with the given tolerance.\n        b = (r = 1 + tau)\n\n        # 7. Append the formatted results to the list.\n        results_list.append(round(r, 6))\n        results_list.append(b)\n\n    # 8. Print the final results in the specified format.\n    # The map(str, ...) converts all items, including booleans, to their string representation.\n    print(f\"[{','.join(map(str, results_list))}]\")\n\nsolve()\n\n```", "id": "3253450"}]}