{"hands_on_practices": [{"introduction": "在空间转录组学中，一个核心问题是基因的表达是否在空间上随机分布，还是呈现出聚集或离散的模式。Moran's $I$ 指数是量化这种空间自相关性的关键统计工具。本练习将引导你手动计算一个基因集的 Moran's $I$ 指数，通过一个简化的场景，帮助你建立对空间模式如何被量化的直观理解。[@problem_id:2430178]", "problem": "在一个简化的空间转录组学 (ST) 实验中，考虑一个在$4$个空间点（标记为 $1, 2, 3, 4$）上测量的组织切片，这些点排列成一个 $2 \\times 2$ 的网格。其无向空间邻接性由对角线元素为零的对称空间权重矩阵 $W$ 编码：\n$$\nW \\;=\\; \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}.\n$$\n一个基因集包含两个基因 $g_1$ 和 $g_2$。它们在这$4$个空间点上的归一化表达值如下：\n$$\ng_1: \\;(8,\\;7,\\;2,\\;3), \\qquad g_2: \\;(10,\\;9,\\;1,\\;2).\n$$\n定义逐点基因集表达量 $x_i$ 为点 $i$ 上两个基因表达量的算术平均值，即 $x_i = \\frac{1}{2}\\left(g_1(i) + g_2(i)\\right)$。令 $\\bar{x}$ 表示所有点上 $x_i$ 的平均值。使用莫兰指数I (Moran’s $I$) 对单个变量在固定且未经行标准化的空间权重矩阵上的常规定义，\n$$\nI \\;=\\; \\frac{n}{S_0} \\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,\\bigl(x_i - \\bar{x}\\bigr)\\bigl(x_j - \\bar{x}\\bigr)}{\\sum_{i=1}^{n} \\bigl(x_i - \\bar{x}\\bigr)^2},\n$$\n其中 $n = 4$ 且 $S_0 = \\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}$，计算基因集平均表达量的莫兰指数I统计量。将最终的莫兰指数I以精确的简化分数（无量纲）形式给出。不要对答案进行四舍五入。", "solution": "该问题陈述已经过严格验证。它内容自洽，在科学上基于应用于生物信息学的空间统计学领域，并且在数学上是适定的。所有必要的数据和定义都已提供，没有歧义或矛盾之处。因此，该问题是有效的，我们继续提供一个完整的、有理有据的解答。\n\n任务是计算一个给定基因集在 $n=4$ 个空间点上的平均表达量的莫兰指数I统计量。莫兰指数I的公式如下：\n$$\nI \\;=\\; \\frac{n}{S_0} \\cdot \\frac{\\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{ij}\\,\\bigl(x_i - \\bar{x}\\bigr)\\bigl(x_j - \\bar{x}\\bigr)}{\\sum_{i=1}^{n} \\bigl(x_i - \\bar{x}\\bigr)^2}\n$$\n\n首先，我们计算逐点基因集表达量 $x_i$ ，即每个点 $i$ 上基因 $g_1$ 和 $g_2$ 表达量的算术平均值。各点 $1, 2, 3, 4$ 的基因表达值以向量形式给出：\n$$\ng_1: \\;(8,\\;7,\\;2,\\;3) \\\\\ng_2: \\;(10,\\;9,\\;1,\\;2)\n$$\n逐点平均表达量 $x_i$ 为：\n$$\nx_1 = \\frac{1}{2}(g_1(1) + g_2(1)) = \\frac{1}{2}(8 + 10) = 9 \\\\\nx_2 = \\frac{1}{2}(g_1(2) + g_2(2)) = \\frac{1}{2}(7 + 9) = 8 \\\\\nx_3 = \\frac{1}{2}(g_1(3) + g_2(3)) = \\frac{1}{2}(2 + 1) = \\frac{3}{2} \\\\\nx_4 = \\frac{1}{2}(g_1(4) + g_2(4)) = \\frac{1}{2}(3 + 2) = \\frac{5}{2}\n$$\n基因集表达量的向量为 $X = \\begin{pmatrix} 9 & 8 & \\frac{3}{2} & \\frac{5}{2} \\end{pmatrix}^T$。\n\n接着，我们计算在所有 $n=4$ 个点上的平均表达量 $\\bar{x}$：\n$$\n\\bar{x} = \\frac{1}{n} \\sum_{i=1}^{n} x_i = \\frac{1}{4} \\left(9 + 8 + \\frac{3}{2} + \\frac{5}{2}\\right) = \\frac{1}{4} \\left(17 + \\frac{8}{2}\\right) = \\frac{1}{4}(17 + 4) = \\frac{21}{4}\n$$\n\n现在，我们计算每个点的表达量与平均值之间的偏差 $z_i = x_i - \\bar{x}$：\n$$\nz_1 = 9 - \\frac{21}{4} = \\frac{36 - 21}{4} = \\frac{15}{4} \\\\\nz_2 = 8 - \\frac{21}{4} = \\frac{32 - 21}{4} = \\frac{11}{4} \\\\\nz_3 = \\frac{3}{2} - \\frac{21}{4} = \\frac{6 - 21}{4} = -\\frac{15}{4} \\\\\nz_4 = \\frac{5}{2} - \\frac{21}{4} = \\frac{10 - 21}{4} = -\\frac{11}{4}\n$$\n令 $Z$ 为这些偏差组成的列向量：$Z = \\begin{pmatrix} \\frac{15}{4} & \\frac{11}{4} & -\\frac{15}{4} & -\\frac{11}{4} \\end{pmatrix}^T$。\n\n然后我们计算莫兰指数I分数中的分母，即偏差的平方和：\n$$\n\\sum_{i=1}^{4} (x_i - \\bar{x})^2 = \\sum_{i=1}^{4} z_i^2 = \\left(\\frac{15}{4}\\right)^2 + \\left(\\frac{11}{4}\\right)^2 + \\left(-\\frac{15}{4}\\right)^2 + \\left(-\\frac{11}{4}\\right)^2 \\\\\n= \\frac{225}{16} + \\frac{121}{16} + \\frac{225}{16} + \\frac{121}{16} = \\frac{2 \\times (225 + 121)}{16} = \\frac{2 \\times 346}{16} = \\frac{346}{8} = \\frac{173}{4}\n$$\n\n接下来，我们计算分子中的各项。首先，$S_0$ 是矩阵 $W$ 中所有权重之和：\n$$\nW = \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}\n$$\n$$\nS_0 = \\sum_{i=1}^{4}\\sum_{j=1}^{4} w_{ij} = 1+1+1+1+1+1+1+1 = 8\n$$\n分子中的二次型可以用矩阵表示法写为 $Z^T W Z$：\n$$\n\\sum_{i=1}^{4}\\sum_{j=1}^{4} w_{ij}\\,(x_i - \\bar{x})(x_j - \\bar{x}) = Z^T W Z\n$$\n我们首先计算乘积 $W Z$：\n$$\nW Z = \\begin{pmatrix}\n0 & 1 & 1 & 0 \\\\\n1 & 0 & 0 & 1 \\\\\n1 & 0 & 0 & 1 \\\\\n0 & 1 & 1 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\n15/4 \\\\\n11/4 \\\\\n-15/4 \\\\\n-11/4\n\\end{pmatrix} =\n\\begin{pmatrix}\n(1)(\\frac{11}{4}) + (1)(-\\frac{15}{4}) \\\\\n(1)(\\frac{15}{4}) + (1)(-\\frac{11}{4}) \\\\\n(1)(\\frac{15}{4}) + (1)(-\\frac{11}{4}) \\\\\n(1)(\\frac{11}{4}) + (1)(-\\frac{15}{4})\n\\end{pmatrix} =\n\\begin{pmatrix}\n-4/4 \\\\\n4/4 \\\\\n4/4 \\\\\n-4/4\n\\end{pmatrix} =\n\\begin{pmatrix}\n-1 \\\\\n1 \\\\\n1 \\\\\n-1\n\\end{pmatrix}\n$$\n现在我们计算最终的二次型：\n$$\nZ^T W Z = \\begin{pmatrix} \\frac{15}{4} & \\frac{11}{4} & -\\frac{15}{4} & -\\frac{11}{4} \\end{pmatrix}\n\\begin{pmatrix}\n-1 \\\\\n1 \\\\\n1 \\\\\n-1\n\\end{pmatrix} \\\\\n= \\left(\\frac{15}{4}\\right)(-1) + \\left(\\frac{11}{4}\\right)(1) + \\left(-\\frac{15}{4}\\right)(1) + \\left(-\\frac{11}{4}\\right)(-1) \\\\\n= -\\frac{15}{4} + \\frac{11}{4} - \\frac{15}{4} + \\frac{11}{4} = \\frac{-15+11-15+11}{4} = \\frac{-8}{4} = -2\n$$\n\n最后，我们将所有计算出的值代入莫兰指数I的公式中：\n$$\nI = \\frac{n}{S_0} \\cdot \\frac{Z^T W Z}{\\sum z_i^2} = \\frac{4}{8} \\cdot \\frac{-2}{173/4} = \\frac{1}{2} \\cdot \\frac{-2 \\times 4}{173} = \\frac{1}{2} \\cdot \\frac{-8}{173} = -\\frac{4}{173}\n$$\n结果是一个符合要求的精确简化分数。负值表示该基因集表达量存在负空间自相关，意味着相邻点倾向于具有不相似的表达值。", "answer": "$$\n\\boxed{-\\frac{4}{173}}\n$$", "id": "2430178"}, {"introduction": "在量化空间关系之前，我们必须首先定义什么是“邻近”。这个选择并非无关紧要，它会深刻影响下游分析的结果。本练习通过一个思想实验，对比了两种构建细胞邻近图的常用方法（固定半径法与 $k$-近邻法），揭示了在细胞密度不均匀的真实组织中，不同的图构建策略如何可能导致对细胞微环境（niche）截然不同的解读。[@problem_id:2430183]", "problem": "一项空间转录组学分析得到了一张组织切片上的单细胞位置，该切片被一个平直界面划分为两个大区域：A区（密集）和B区（稀疏）。假设每个区域中的细胞中心遵循独立的均匀泊松点过程，其强度分别为 $\\lambda_{\\mathrm{A}}=0.02\\,\\mathrm{cells}/\\mu\\mathrm{m}^{2}$ 和 $\\lambda_{\\mathrm{B}}=0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^{2}$，并且除了泊松随机性之外没有其他聚类。考虑使用以下任一方法构建细胞-细胞邻域图：\n- 一个半径图 $G_{r}$，如果两个细胞的欧几里得距离至多为 $r=10\\,\\mu\\mathrm{m}$，则连接它们，从而生成一个无向简单图；或者\n- 一个对称 $k$-近邻图 $G_{k}$，其中 $k=6$，其定义为：如果细胞 $i$ 是细胞 $j$ 的 $k$ 个最近邻居之一，或者细胞 $j$ 是细胞 $i$ 的 $k$ 个最近邻居之一，则在 $i$ 和 $j$ 之间连接一条无向边。\n\n假设一项下游生态位分析使用了一个二元标记物的未归一化邻居加和分数：对于每个细胞 $i$，$S_{i}=\\sum_{j\\in \\mathcal{N}(i)} \\mathbf{1}\\{\\text{邻居 } j \\text{ 表达该标记物}\\}$，其中 $\\mathcal{N}(i)$ 是细胞 $i$ 在所构建图中的图邻域，并且该标记物在每个细胞中独立表达，具有空间上恒定的流行率 $p\\in(0,1)$，且与位置无关。\n\n忽略远离 A-B 界面的有限尺寸边界效应（除了可能跨越界面的边），并假设观测窗口足够大以至于内部行为占主导地位，那么关于邻域图构建对下游生态位分析的影响，以下哪些陈述是正确的？\n\nA. 在 $G_{r}$ 中，A区一个细胞的期望度大约是B区一个细胞的4倍，即使标记物流行率 $p$ 在空间上是恒定的，这也会夸大A区相对于B区的未归一化邻居加和生态位分数。\n\nB. 在 $k=6$ 的 $G_{k}$ 中，期望无向度在所有地方都精确为 $6$，这确保了跨区域的度量邻域半径相同，并防止了界面附近的跨界邻居混合。\n\nC. 在 $k=6$ 的 $G_{k}$ 中，B区到邻居的典型距离比A区大，这增加了B区界面附近细胞的邻居位于界面另一侧A区的可能性，从而可能模糊边界附近的生态位差异。\n\nD. 在 $r=10\\,\\mu\\mathrm{m}$ 的 $G_{r}$ 中，B区中不可忽略的一部分细胞将被孤立（度为$0$），使得稀疏区域中的图很可能出现碎片化，并可能通过分裂稀疏区域的生态位而使社区检测产生偏差。\n\nE. $G_{r}$ 和 $G_{k}$ 产生的A区和B区之间的期望度比率相同，因此，区域间生态位分数 $S_{i}$ 的任何观测差异都必须仅源于基因表达，而非图的构建。", "solution": "必须首先验证问题陈述的科学性和逻辑完整性。\n\n**步骤1：提取已知条件**\n- 细胞分布：独立的均匀泊松点过程（HPP）。\n- A区强度：$\\lambda_{\\mathrm{A}} = 0.02 \\, \\mathrm{cells}/\\mu\\mathrm{m}^2$。\n- B区强度：$\\lambda_{\\mathrm{B}} = 0.005 \\, \\mathrm{cells}/\\mu\\mathrm{m}^2$。\n- 图1 ($G_r$)：半径图，半径 $r = 10 \\, \\mu\\mathrm{m}$。如果欧几里得距离 $\\le r$，则存在一条边。\n- 图2 ($G_k$)：对称$k$-近邻图，其中 $k=6$。如果细胞 $i$ 是 $j$ 的 $k$-近邻之一，或者 $j$ 是 $i$ 的 $k$-近邻之一，那么细胞 $i$ 和 $j$ 之间存在一条边。\n- 生态位分数：$S_{i}=\\sum_{j\\in \\mathcal{N}(i)} \\mathbf{1}\\{\\text{邻居 } j \\text{ 表达该标记物}\\}$。\n- 标记物表达：独立的、服从伯努利试验的同分布，概率为常数 $p \\in (0, 1)$。\n- 假设：忽略远离 A-B 界面的边界效应；观测窗口足够大。\n\n**步骤2：使用提取的已知条件进行验证**\n该问题是使用计算生物学和空间统计学中标准的、广为接受的模型来构建的。使用泊松点过程对细胞位置进行建模，以及通过半径图或 $k$-近邻方法构建邻域图，都是空间转录组学分析中的基本技术。所提供的参数（$\\lambda_{\\mathrm{A}}$、$\\lambda_{\\mathrm{B}}$、$r$、$k$）在物理上是现实的。所提出的问题是客观的，并且可以使用点过程和图论的既定数学原理进行形式化分析。该问题具有科学依据，是适定的、客观的。它不包含任何矛盾、歧义或事实上的不健全之处。\n\n**步骤3：结论与行动**\n问题陈述是**有效的**。开始求解。\n\n分析将通过评估基于所提供模型的每个陈述来进行。细胞 $i$ 的期望生态位分数由 $E[S_i] = E[p \\cdot D_i] = p \\cdot E[D_i]$ 给出，其中 $D_i$ 是细胞 $i$ 的度。因此，期望分数与期望度成正比。\n\n**选项A的分析**\n该陈述与半径图 $G_{r}$ 有关。对于强度为 $\\lambda$ 的均匀泊松点过程，一个典型点为中心、半径为 $r$ 的圆盘内的期望点数为 $\\lambda \\pi r^2$。这是远离任何边界的细胞的期望度。\n\n- 半径为 $r = 10\\,\\mu\\mathrm{m}$，因此邻域面积为 $A_r = \\pi r^2 = \\pi (10\\,\\mu\\mathrm{m})^2 = 100\\pi\\,\\mu\\mathrm{m}^2$。\n- 在A区，期望度 $E[D_{\\mathrm{A}}]$ 为：\n$$E[D_{\\mathrm{A}}] = \\lambda_{\\mathrm{A}} A_r = (0.02\\,\\mathrm{cells}/\\mu\\mathrm{m}^2) \\cdot (100\\pi\\,\\mu\\mathrm{m}^2) = 2\\pi \\approx 6.28$$\n- 在B区，期望度 $E[D_{\\mathrm{B}}]$ 为：\n$$E[D_{\\mathrm{B}}] = \\lambda_{\\mathrm{B}} A_r = (0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^2) \\cdot (100\\pi\\,\\mu\\mathrm{m}^2) = 0.5\\pi \\approx 1.57$$\n- 期望度的比率为：\n$$\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]} = \\frac{2\\pi}{0.5\\pi} = \\frac{\\lambda_{\\mathrm{A}}}{\\lambda_{\\mathrm{B}}} = \\frac{0.02}{0.005} = 4$$\nA区的期望度确实是B区的4倍。由于 $E[S_i] \\propto E[D_i]$ 且标记物流行率 $p$ 是恒定的，因此期望生态位分数也将呈4:1的比例。这种差异是在不同密度的区域上使用固定半径图所产生的直接人为效应，它夸大了密集区域的分数。该陈述是**正确的**。\n\n**选项B的分析**\n该陈述与对称 $k$-近邻图 $G_k$ 有关。\n\n1.  “期望无向度在所有地方都精确为 $6$”：该图是对称的，意味着如果 $j$ 是 $i$ 的 $k$-近邻之一，或 $i$ 是 $j$ 的 $k$-近邻之一，则存在一条边 $(i, j)$。节点 $i$ 的度是 $|\\{j | j \\in \\text{NN}_k(i)\\}| + |\\{j | i \\in \\text{NN}_k(j) \\text{ and } j \\notin \\text{NN}_k(i)\\}|$. 尽管第一项是 $k=6$，但第二项（非前向邻居的反向邻居数量）是一个随机变量。节点的度不固定为 $k$，其期望也未必恰好是 $k$。对于对称图，期望度通常大于 $k$。声称其*精确*为6是错误的。\n\n2.  “确保跨区域的度量邻域半径相同”：$k$-近邻方法按秩次（邻居数量）定义邻域，而不是按固定的度量半径。到第 $k$ 个邻居的物理距离会适应局部密度。在密集的A区，到第6个邻居的距离会很小。在稀疏的B区，这个距离会很大。度量半径根本不同，而非相同。\n\n3.  “防止了跨界邻居混合”：这一点由上一点引出。因为稀疏区域B中靠近界面的细胞必须在更大的半径内搜索才能找到其 $k=6$ 个邻居，所以它*更*有可能（而不是更不可能）在边界另一侧的密集区域A中找到邻居。该方法不能防止混合；它可能导致非对称混合。\n\n该陈述的所有部分在事实上都是错误的。该陈述是**不正确的**。\n\n**选项C的分析**\n该陈述也与 $G_k$ 有关。\n\n1.  “B区到邻居的典型距离比A区大”：正如对选项 B 的解释，为了找到固定数量的 $k=6$ 个邻居，在稀疏区域中必须比在密集区域中探查更大的区域（因此是更大的距离）。所以，$R_{\\text{search}, \\mathrm{B}} > R_{\\text{search}, \\mathrm{A}}$。这是正确的。\n\n2.  “增加了B区界面附近细胞的邻居位于界面另一侧A区的可能性”：B区中靠近界面的细胞具有较大的搜索半径。这个半径可以轻易地延伸到A区。由于A区密度是B区的4倍，这个细胞的6个最近邻居中的一部分（如果不是全部的话）极有可能在A区被找到。这是正确的。\n\n3.  “这会模糊边界附近的生态位差异”：生态位由局部邻域定义。如果一个来自B区的细胞，其邻域由A区的细胞组成，那么它计算出的生态位特征将反映A区，而不是其所在的B区。这种图构建的人为效应混合了边界上两个区域的信号，这种效应被准确地描述为“模糊生态位差异”。这是正确的。\n\n该陈述的整个逻辑链是合理的。该陈述是**正确的**。\n\n**选项D的分析**\n该陈述回到半径图 $G_r$。\n\n1.  “B区中不可忽略的一部分细胞将被孤立（度为$0$）”：如果没有其他细胞位于半径为 $r = 10\\,\\mu\\mathrm{m}$ 的圆盘内，则该细胞是孤立的。对于一个均匀泊松点过程（HPP），该圆盘内的邻居数量 $N$ 服从均值为 $\\mu = \\lambda \\pi r^2$ 的泊松分布。被孤立的概率为 $P(N=0) = e^{-\\mu}$。\n    - 对于B区，$\\lambda_{\\mathrm{B}} = 0.005\\,\\mathrm{cells}/\\mu\\mathrm{m}^2$。\n    - 邻居的平均数量为 $\\mu_{\\mathrm{B}} = \\lambda_{\\mathrm{B}} \\pi r^2 = 0.005 \\cdot \\pi \\cdot 10^2 = 0.5\\pi \\approx 1.5708$。\n    - B区中的一个细胞被孤立的概率是：\n    $$P(D_{\\mathrm{B}}=0) = e^{-\\mu_{\\mathrm{B}}} = e^{-0.5\\pi} \\approx 0.2078$$\n    约 $21\\%$ 的概率代表了细胞中相当大的一部分。这是一个“不可忽略的部分”。这是正确的。\n\n2.  “使得稀疏区域中的图很可能出现碎片化”：如果超过五分之一的节点度为0，那么根据定义，该图是碎片化的。其余节点可能会形成其他小的、不连通的组件。这是正确的。\n\n3.  “可能通过分裂稀疏区域的生态位而使社区检测产生偏差”：社区检测算法依赖于图的连通性来对节点进行分组。在一个高度碎片化的图中，一个单一的、空间上连续的生物生态位将被人为地分解成许多不相干的社区（其中许多将是孤立点）。这将妨碍算法识别生态位真实的、更大尺度的结构，从而使分析产生偏差。这是一个正确且直接的后果。\n\n该陈述提供了正确的定量评估以及对其下游影响的正确解释。该陈述是**正确的**。\n\n**选项E的分析**\n该陈述比较了两种图的构建方法。\n\n1.  “$G_{r}$ 和 $G_{k}$ 产生的A区和B区之间的期望度比率相同”：\n    - 对于 $G_r$，我们发现期望度的比率为 $\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]} = 4$。\n    - 对于 $G_k$，其构建方式能适应密度。在一个大的均匀区域中，对称 $k$-近邻图的期望度近似为常数，与密度 $\\lambda$ 无关。因此，期望度的比率 $\\frac{E[D_{\\mathrm{A}}]}{E[D_{\\mathrm{B}}]}$ 近似为 $1$。\n    - 由于 $4 \\neq 1$，声称比率相同的断言是错误的。\n\n2.  “因此，区域间生态位分数...的任何观测差异都必须仅源于基因表达...”：这个结论依赖于上述错误的前提。由于图的选择本身就在区域之间（特别是对于 $G_r$）引起了度分布的深刻差异，因此它是生态位分数分析中的一个主要混淆因素。该陈述从根本上就是错误的。\n\n该陈述是**不正确的**。\n\n**结论**\n陈述 A、C 和 D 准确地描述了在空间异质性背景下，相应图构建方法的后果和人为效应。陈述 B 和 E 基于对这些方法的不正确描述。", "answer": "$$\\boxed{ACD}$$", "id": "2430183"}, {"introduction": "掌握了定义空间邻域和评估空间模式的方法后，我们可以应用这些技能来解决具体的生物学问题。本练习模拟了一项高级分析任务：识别在同一细胞类型中，位于组织边界的细胞与内部细胞之间存在差异表达的基因。通过这项实践，你将学习如何编写算法来发现那些可能在不同细胞群落间介导相互作用的关键基因。[@problem_id:2430130]", "problem": "给定一组空间解析的信使核糖核酸（mRNA）表达测量值和单个细胞的二维（2D）坐标，考虑一个由整数 $t^\\star$ 标记的固定目标细胞类型。令 $X \\in \\mathbb{R}^{n \\times g}$ 表示非负表达矩阵，其中有 $n$ 行（细胞）和 $g$ 列（基因），条目 $x_{ij}$ 是基因 $j$ 在细胞 $i$ 中的表达量。令 $C \\in \\mathbb{R}^{n \\times 2}$ 表示坐标矩阵，其中第 $i$ 行给出细胞 $i$ 的二维位置。令 $T \\in \\{0,1,2,\\dots\\}^n$ 为整数细胞类型标签的向量。所有索引都是从零开始的；基因由 $j \\in \\{0,1,\\dots,g-1\\}$ 索引，细胞由 $i \\in \\{0,1,\\dots,n-1\\}$ 索引。\n\n将一个细胞 $i$ 的 $k$-最近邻（KNN）定义为其他细胞的恰好 $k$ 个不同索引的集合，这些细胞与细胞 $i$ 在 $C$ 中的欧几里得距离最小。细胞 $i$ 和 $i'$ 之间的欧几里得距离是\n$$\nd(i,i') = \\sqrt{(C_{i,0} - C_{i',0})^2 + (C_{i,1} - C_{i',1})^2}.\n$$\n如果在第 $k$ 小的距离上出现平局，则通过对候选邻居按序对 $(d(i,i'), i')$ 进行升序字典序排序（先按距离，再按索引）来确定性地打破平局，然后取前 $k$ 个索引。对于一个固定的 $t^\\star$，如果一个细胞 $i$（其 $T_i = t^\\star$）的 $k$-最近邻中至少有一个邻居的标签与 $t^\\star$ 不同，则称该细胞为边界细胞。如果一个细胞 $i$（其 $T_i = t^\\star$）的所有 $k$-最近邻的标签都恰好是 $t^\\star$，则称该细胞为内部细胞。\n\n对于每个基因 $j$，定义边界集 $B = \\{ i \\in \\{0,\\dots,n-1\\} : T_i = t^\\star \\text{ 且 } i \\text{ 是边界细胞} \\}$ 和内部集 $I = \\{ i \\in \\{0,\\dots,n-1\\} : T_i = t^\\star \\text{ 且 } i \\text{ 是内部细胞} \\}$。令\n$$\n\\mu_B(j) = \\frac{1}{|B|} \\sum_{i \\in B} x_{ij}, \\quad \\mu_I(j) = \\frac{1}{|I|} \\sum_{i \\in I} x_{ij},\n$$\n当 $|B| \\ge 1$ 且 $|I| \\ge 1$ 时。给定一个阈值 $\\tau > 0$，基因 $j$ 被称为在边界细胞和内部细胞之间（在同一类型 $t^\\star$ 内）差异表达（DE），当且仅当 $|B| \\ge 1$，$|I| \\ge 1$，且\n$|\\mu_B(j) - \\mu_I(j)| \\ge \\tau$。\n如果 $|B| = 0$ 或 $|I| = 0$，则没有基因被称为 DE，该测试用例的输出必须是空列表。\n\n您的任务是实现一个程序，对于每个提供的测试用例，计算满足上述 DE 标准的基因索引 $j$ 的排序列表。最终的程序输出必须将所有测试用例的结果汇总到单行中，该行包含一个由方括号括起来的逗号分隔的列表序列，例如，$[ [a], [b], [c] ]$（实际程序输出中不含空格）。\n\n测试套件（三个测试用例）：\n\n测试用例 1：\n- 参数：$t^\\star = 0$，$k = 2$，$\\tau = 3$。\n- 坐标：\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n1 & 0 \\\\\n2 & 0 \\\\\n1 & 1 \\\\\n2 & 1 \\\\\n3 & 0 \\\\\n0 & 1\n\\end{bmatrix}.\n$$\n- 标签：\n$$\nT = \\begin{bmatrix}\n0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\\\ 1 \\\\ 0\n\\end{bmatrix}.\n$$\n- 表达矩阵 ($n=7$, $g=3$)：\n$$\nX = \\begin{bmatrix}\n2 & 5 & 8 \\\\\n2 & 5 & 8 \\\\\n10 & 5 & 1 \\\\\n9 & 5 & 2 \\\\\n3 & 5 & 7 \\\\\n4 & 5 & 6 \\\\\n2 & 5 & 8\n\\end{bmatrix}.\n$$\n\n测试用例 2：\n- 参数：$t^\\star = 0$，$k = 2$，$\\tau = 3$。\n- 坐标：\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n0 & 1 \\\\\n0 & 2 \\\\\n10 & 0 \\\\\n10 & 1 \\\\\n10 & 2\n\\end{bmatrix}.\n$$\n- 标签：\n$$\nT = \\begin{bmatrix}\n0 \\\\ 0 \\\\ 0 \\\\ 1 \\\\ 1 \\\\ 1\n\\end{bmatrix}.\n$$\n- 表达矩阵 ($n=6$, $g=2$)：\n$$\nX = \\begin{bmatrix}\n1 & 1 \\\\\n2 & 2 \\\\\n3 & 3 \\\\\n4 & 4 \\\\\n5 & 5 \\\\\n6 & 6\n\\end{bmatrix}.\n$$\n\n测试用例 3：\n- 参数：$t^\\star = 0$，$k = 1$，$\\tau = 3$。\n- 坐标：\n$$\nC = \\begin{bmatrix}\n0 & 0 \\\\\n1 & 0 \\\\\n0 & 1 \\\\\n-1 & 0\n\\end{bmatrix}.\n$$\n- 标签：\n$$\nT = \\begin{bmatrix}\n0 \\\\ 1 \\\\ 0 \\\\ 0\n\\end{bmatrix}.\n$$\n- 表达矩阵 ($n=4$, $g=2$)：\n$$\nX = \\begin{bmatrix}\n9 & 3 \\\\\n4 & 4 \\\\\n1 & 3 \\\\\n1 & 3\n\\end{bmatrix}.\n$$\n\n要求的最终输出格式：您的程序必须生成仅一行内容，该行包含由方括号括起来的、按测试用例分隔的列表序列，用逗号分隔，且不含空格；例如，如果三个答案分别是列表 $L_1$、$L_2$ 和 $L_3$，则打印 $[L_1,L_2,L_3]$。每个 $L_i$ 都必须是按升序排列的、从零开始的基因索引列表。", "solution": "该问题经评估为**有效**。它在计算生物学领域，特别是在空间转录组学分析方面，具有科学依据。所提供的定义在数学上是精确和客观的，从而能够得出唯一且可验证的解。问题陈述清晰，提供了所有必要的数据和约束，包括一个用于确定最近邻的确定性平局打破规则。问题陈述中没有矛盾、歧义或事实性错误。\n\n该解决方案通过一系列明确定义的计算步骤来实现。对于每个测试用例，我们给定一组细胞坐标 $C \\in \\mathbb{R}^{n \\times 2}$、一个表达矩阵 $X \\in \\mathbb{R}^{n \\times g}$、一个细胞类型标签向量 $T \\in \\{0,1,2,\\dots\\}^n$、一个目标细胞类型 $t^\\star$、一个邻居数 $k$ 以及一个差异表达阈值 $\\tau > 0$。目标是找出在 $t^\\star$ 类型的边界细胞和内部细胞之间所有差异表达的基因。\n\n算法流程如下：\n\n1.  **识别目标细胞和最近邻**：\n    首先，我们识别目标类型 $t^\\star$ 的细胞索引集，即 $S_{t^\\star} = \\{ i \\mid T_i = t^\\star \\}$。对于每个细胞 $i \\in S_{t^\\star}$，我们必须找到其 $k$-最近邻（KNN）。该过程始于计算从细胞 $i$ 到每个其他细胞 $i' \\neq i$ 的欧几里得距离 $d(i,i') = \\sqrt{(C_{i,0} - C_{i',0})^2 + (C_{i,1} - C_{i',1})^2}$。为了对所有细胞高效地执行此操作，我们可以预先计算一个 $n \\times n$ 的成对距离矩阵。问题指定了一个确定性的平局打破规则：如果多个细胞在第 $k$ 个位置上距离相等，则候选邻居按序对 $(d(i,i'), i')$ 进行字典序排序，并选择前 $k$ 个。这确保了每个细胞都有一组唯一的邻居。在计算上，这是通过基于主键（距离）和次键（细胞索引）进行字典序排序来实现的。\n\n2.  **目标细胞的分类**：\n    一旦确定了细胞 $i \\in S_{t^\\star}$ 的 $k$-最近邻，我们将其分类为边界细胞或内部细胞。令 $N_i$ 为细胞 $i$ 的 $k$-最近邻的索引集。\n    -   如果所有邻居 $i' \\in N_i$ 的标签都与细胞 $i$ 相同（即，对于所有 $i' \\in N_i$ 都有 $T_{i'} = t^\\star$），则细胞 $i$ 被分类为**内部**细胞。\n    -   如果至少有一个邻居 $i' \\in N_i$ 的标签不同（即，$T_{i'} \\neq t^\\star$），则细胞 $i$ 被分类为**边界**细胞。\n    此过程将目标细胞集 $S_{t^\\star}$ 划分为边界集 $B$ 和内部集 $I$。\n\n3.  **差异表达分析**：\n    仅当边界集 $B$ 和内部集 $I$ 均不为空时，即 $|B| \\ge 1$ 且 $|I| \\ge 1$ 时，才进行分析。如果任一集合为空，则没有基因被认为是差异表达（DE）的，结果为空列表。\n    如果两个集合都不为空，我们计算每个基因 $j \\in \\{0, \\dots, g-1\\}$ 在边界和内部细胞群体中的平均表达量：\n    $$\n    \\mu_B(j) = \\frac{1}{|B|} \\sum_{i \\in B} x_{ij}\n    $$\n    $$\n    \\mu_I(j) = \\frac{1}{|I|} \\sum_{i \\in I} x_{ij}\n    $$\n    如果这些平均表达值之间的绝对差达到或超过给定阈值 $\\tau$，则基因 $j$ 被识别为差异表达：\n    $$\n    |\\mu_B(j) - \\mu_I(j)| \\ge \\tau\n    $$\n\n4.  **最终结果**：\n    收集所有满足DE标准的基因的索引。每个测试用例的结果索引列表按升序排序。最终输出是这些列表的汇总。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the final results.\n    \"\"\"\n    test_cases = [\n        {\n            \"t_star\": 0, \"k\": 2, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [1, 0], [2, 0], [1, 1], [2, 1], [3, 0], [0, 1]\n            ]),\n            \"T\": np.array([0, 0, 0, 0, 1, 1, 0]),\n            \"X\": np.array([\n                [2, 5, 8], [2, 5, 8], [10, 5, 1], [9, 5, 2],\n                [3, 5, 7], [4, 5, 6], [2, 5, 8]\n            ])\n        },\n        {\n            \"t_star\": 0, \"k\": 2, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [0, 1], [0, 2], [10, 0], [10, 1], [10, 2]\n            ]),\n            \"T\": np.array([0, 0, 0, 1, 1, 1]),\n            \"X\": np.array([\n                [1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [6, 6]\n            ])\n        },\n        {\n            \"t_star\": 0, \"k\": 1, \"tau\": 3.0,\n            \"C\": np.array([\n                [0, 0], [1, 0], [0, 1], [-1, 0]\n            ]),\n            \"T\": np.array([0, 1, 0, 0]),\n            \"X\": np.array([\n                [9, 3], [4, 4], [1, 3], [1, 3]\n            ])\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = analyze_spatial_de(\n            case[\"t_star\"], case[\"k\"], case[\"tau\"],\n            case[\"C\"], case[\"T\"], case[\"X\"]\n        )\n        results.append(result)\n\n    # Format the final output string exactly as required, with no spaces.\n    final_output = str(results).replace(\" \", \"\")\n    print(final_output)\n\ndef analyze_spatial_de(t_star, k, tau, C, T, X):\n    \"\"\"\n    Analyzes a single spatial transcriptomics dataset to find differentially\n    expressed genes between boundary and interior cells of a target type.\n    \"\"\"\n    n, g = X.shape\n    \n    # Compute pairwise Euclidean distance matrix\n    # C is shape (n, 2). Reshape for broadcasting to (n, 1, 2) and (1, n, 2).\n    # The difference is (n, n, 2), representing coordinate differences.\n    # Sum squares along the coordinate axis and take sqrt.\n    diff = C[:, np.newaxis, :] - C[np.newaxis, :, :]\n    dist_matrix = np.sqrt(np.sum(diff**2, axis=-1))\n\n    # Exclude self-neighbors by setting diagonal distance to infinity.\n    np.fill_diagonal(dist_matrix, np.inf)\n\n    target_cell_indices = np.where(T == t_star)[0]\n    \n    boundary_cells = []\n    interior_cells = []\n    \n    all_indices = np.arange(n)\n\n    for i in target_cell_indices:\n        distances_from_i = dist_matrix[i, :]\n        \n        # Lexicographical sort on (distance, index) to break ties deterministically.\n        # np.lexsort sorts by the last key first.\n        sorted_neighbor_indices = np.lexsort((all_indices, distances_from_i))\n        \n        knn_indices = sorted_neighbor_indices[:k]\n        neighbor_labels = T[knn_indices]\n        \n        # If all neighbors have the same label as the target cell, it's interior.\n        if np.all(neighbor_labels == t_star):\n            interior_cells.append(i)\n        else:\n            boundary_cells.append(i)\n            \n    # If either set is empty, no DE genes can be found.\n    if not boundary_cells or not interior_cells:\n        return []\n\n    # Calculate mean expression for boundary and interior cells\n    X_boundary = X[boundary_cells, :]\n    X_interior = X[interior_cells, :]\n    \n    mu_B = np.mean(X_boundary, axis=0)\n    mu_I = np.mean(X_interior, axis=0)\n    \n    # Identify DE genes based on the threshold tau\n    diff_expression = np.abs(mu_B - mu_I)\n    de_gene_indices = np.where(diff_expression >= tau)[0]\n    \n    # The result must be a sorted list of indices. np.where provides this.\n    return de_gene_indices.tolist()\n\nsolve()\n```", "id": "2430130"}]}