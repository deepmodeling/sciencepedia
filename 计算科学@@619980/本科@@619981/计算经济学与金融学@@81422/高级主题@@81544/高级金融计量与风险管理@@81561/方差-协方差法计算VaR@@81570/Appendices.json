{"hands_on_practices": [{"introduction": "我们从一个核心的计算实践开始，它将帮助你掌握投资组合风险价值（$VaR$）计算的基础。这个练习要求你直接应用方差-协方差方法，通过矩阵运算计算一个多资产投资组合的 $VaR$ [@problem_id:2447014]。通过这个实践，你将深刻理解在正态分布的假设下，单个资产的均值、波动率以及它们之间的相关性是如何通过投资组合权重相结合，最终决定整个投资组合的尾部风险的。", "problem": "给定一个包含$N$种资产的投资组合，其线性敞口向量为 $w \\in \\mathbb{R}^{N}$，每日资产回报向量为 $r \\in \\mathbb{R}^{N}$，每日平均回报向量为 $\\mu \\in \\mathbb{R}^{N}$，每日方差-协方差矩阵为 $\\Sigma \\in \\mathbb{R}^{N \\times N}$。假设 $r$ 服从均值为 $\\mu$、协方差为 $\\Sigma$ 的多元正态分布。单日投资组合回报为 $R_{p} = w^{\\top} r$，与投资组合价值使用相同货币单位的单日投资组合亏损为 $L = -V \\, R_{p}$，其中 $V \\in \\mathbb{R}_{+}$ 是当前投资组合价值。将尾部概率为 $\\alpha \\in (0,1)$ 的单日在险价值 (VaR) 定义为满足 $\\mathbb{P}(L > v) = \\alpha$ 的数值 $v$。所有概率都是无单位的。所有回报均以小数表示，不使用百分号。\n\n请编写一个完整的程序，在正态性假设下，使用方差-协方差法计算以下每个测试用例的单日在险价值。每个结果必须以与 $V$ 相同的货币单位表示，并四舍五入到两位小数。您的程序必须生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[x_{1},x_{2},x_{3}]$），不含空格。\n\n测试套件：\n- 案例 1（一般多资产情况）：\n  - $N = 3$\n  - $w = [\\,0.5,\\,0.3,\\,0.2\\,]$\n  - $\\mu = [\\,0.0005,\\,0.0002,\\,-0.0001\\,]$\n  - $\\Sigma = \\begin{bmatrix}\n  0.000225 & 0.00003 & 0.00015 \\\\\n  0.00003 & 0.0001 & 0.00006 \\\\\n  0.00015 & 0.00006 & 0.0004\n  \\end{bmatrix}$\n  - $V = 1000000$\n  - $\\alpha = 0.01$\n- 案例 2（完全对冲，零方差）：\n  - $N = 2$\n  - $w = [\\,0.5,\\,-0.5\\,]$\n  - $\\mu = [\\,0.0002,\\,0.0002\\,]$\n  - $\\Sigma = \\begin{bmatrix}\n  0.0001 & 0.0001 \\\\\n  0.0001 & 0.0001\n  \\end{bmatrix}$\n  - $V = 2000000$\n  - $\\alpha = 0.01$\n- 案例 3（单资产情况）：\n  - $N = 1$\n  - $w = [\\,1.0\\,]$\n  - $\\mu = [\\,-0.0003\\,]$\n  - $\\Sigma = \\begin{bmatrix} 0.0009 \\end{bmatrix}$\n  - $V = 500000$\n  - $\\alpha = 0.05$\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔结果列表（例如 $[result1,result2,result3]$）。每个 $resulti$ 都必须是四舍五入到两位小数的浮点数。不应打印任何其他文本。", "solution": "该问题要求使用方差-协方差法计算一个$N$资产投资组合的单日在险价值 ($VaR$)。问题定义明确，科学上合理，并为得出唯一解提供了所有必要的数据。核心假设是每日资产回报向量 $r$ 服从多元正态分布，$r \\sim \\mathcal{N}(\\mu, \\Sigma)$。\n\n首先，我们必须确定单日投资组合回报 $R_{p}$ 的统计分布。投资组合回报是单个资产回报的线性组合，由公式 $R_{p} = w^{\\top} r$ 给出，其中 $w$是投资组合权重向量。多元正态分布的一个基本性质是其分量的任何线性组合也服从正态分布。因此，$R_{p}$ 服从单变量正态分布。\n\n投资组合回报的均值 $\\mu_{p}$ 是 $R_{p}$ 的期望：\n$$ \\mu_{p} = \\mathbb{E}[R_{p}] = \\mathbb{E}[w^{\\top} r] = w^{\\top} \\mathbb{E}[r] = w^{\\top} \\mu $$\n投资组合回报的方差 $\\sigma_{p}^2$ 由下式给出：\n$$ \\sigma_{p}^2 = \\text{Var}(R_{p}) = \\text{Var}(w^{\\top} r) = w^{\\top} \\text{Var}(r) w = w^{\\top} \\Sigma w $$\n因此，投资组合回报的分布为 $R_{p} \\sim \\mathcal{N}(\\mu_{p}, \\sigma_{p}^2)$。\n\n接下来，我们考虑投资组合亏损 $L$，其定义为 $L = -V R_{p}$，其中 $V$ 是当前投资组合价值。由于 $L$ 是正态分布变量 $R_{p}$ 的线性变换，因此 $L$ 也服从正态分布。\n亏损的均值 $\\mu_{L}$ 为：\n$$ \\mu_{L} = \\mathbb{E}[L] = \\mathbb{E}[-V R_{p}] = -V \\mathbb{E}[R_{p}] = -V \\mu_{p} = -V w^{\\top} \\mu $$\n亏损的方差 $\\sigma_{L}^2$ 为：\n$$ \\sigma_{L}^2 = \\text{Var}(L) = \\text{Var}(-V R_{p}) = (-V)^2 \\text{Var}(R_{p}) = V^2 \\sigma_{p}^2 = V^2 (w^{\\top} \\Sigma w) $$\n亏损的标准差是 $\\sigma_{L} = V \\sigma_{p} = V \\sqrt{w^{\\top} \\Sigma w}$。\n所以，投资组合亏损的分布为 $L \\sim \\mathcal{N}(\\mu_{L}, \\sigma_{L}^2)$。\n\n尾部概率为 $\\alpha$ 的在险价值，记为 $v$，由条件 $\\mathbb{P}(L > v) = \\alpha$ 定义。为了求解 $v$，我们将正态随机变量 $L$ 标准化。设 $Z$ 为标准正态变量，$Z \\sim \\mathcal{N}(0, 1)$。我们可以将 $L$ 表示为 $L = \\mu_{L} + \\sigma_{L} Z$。该概率表述变为：\n$$ \\mathbb{P}(\\mu_{L} + \\sigma_{L} Z > v) = \\alpha $$\n假设 $\\sigma_{L} > 0$，我们重排不等式：\n$$ \\mathbb{P}\\left(Z > \\frac{v - \\mu_{L}}{\\sigma_{L}}\\right) = \\alpha $$\n设 $z_{\\alpha}$ 为标准正态分布的上 $\\alpha$-分位数，即满足 $\\mathbb{P}(Z > z_{\\alpha}) = \\alpha$ 的值。该值等价于累积分布函数 (CDF) $\\Phi$ 在 $1 - \\alpha$ 处的反函数，即 $z_{\\alpha} = \\Phi^{-1}(1 - \\alpha)$。\n通过令概率函数的参数相等，我们得到：\n$$ \\frac{v - \\mu_{L}}{\\sigma_{L}} = z_{\\alpha} $$\n求解 $v$ 即可得到 $VaR_{\\alpha}$ 的公式：\n$$ v = \\text{VaR}_{\\alpha} = \\mu_{L} + z_{\\alpha} \\sigma_{L} $$\n代入 $\\mu_{L}$ 和 $\\sigma_{L}$ 的表达式，我们得到最终的计算公式：\n$$ \\text{VaR}_{\\alpha} = -V (w^{\\top} \\mu) + z_{\\alpha} V \\sqrt{w^{\\top} \\Sigma w} $$\n这可以改写为：\n$$ \\text{VaR}_{\\alpha} = V (z_{\\alpha} \\sigma_{p} - \\mu_{p}) $$\n在投资组合方差 $\\sigma_{p}^2 = 0$ 的特殊情况下，投资组合回报是确定性的：$R_{p} = \\mu_{p}$。亏损也是确定性的，$L = -V\\mu_{p}$。根据分位数的广义定义，对于任何 $\\alpha \\in (0,1)$，$\\text{VaR}_{\\alpha} = -V\\mu_{p}$，这与通用公式是一致的，因为包含 $\\sigma_{p}$ 的项变为零。\n\n解决每个测试用例问题的算法如下：\n1. 对于一组给定的参数 $\\{w, \\mu, \\Sigma, V, \\alpha\\}$，首先计算平均投资组合回报 $\\mu_{p} = w^{\\top} \\mu$。\n2. 计算投资组合回报的方差 $\\sigma_{p}^2 = w^{\\top} \\Sigma w$。\n3. 计算投资组合回报的标准差 $\\sigma_{p} = \\sqrt{\\sigma_{p}^2}$。\n4. 使用数值函数计算 $\\Phi^{-1}(1 - \\alpha)$，以确定与尾部概率 $\\alpha$ 对应的标准正态分位数 $z_{\\alpha}$。\n5. 使用公式 $\\text{VaR}_{\\alpha} = V(z_{\\alpha} \\sigma_{p} - \\mu_{p})$ 计算 VaR。\n6. 将最终结果四舍五入到两位小数。\n此过程将应用于所提供的三个测试用例中的每一个。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes the one-day Value-at-Risk for a portfolio using the\n    variance-covariance method under the normality assumption.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general multi-asset case)\n        {\n            \"w\": np.array([0.5, 0.3, 0.2]),\n            \"mu\": np.array([0.0005, 0.0002, -0.0001]),\n            \"Sigma\": np.array([\n                [0.000225, 0.00003, 0.00015],\n                [0.00003, 0.0001, 0.00006],\n                [0.00015, 0.00006, 0.0004]\n            ]),\n            \"V\": 1000000.0,\n            \"alpha\": 0.01\n        },\n        # Case 2 (perfect hedge, zero variance)\n        {\n            \"w\": np.array([0.5, -0.5]),\n            \"mu\": np.array([0.0002, 0.0002]),\n            \"Sigma\": np.array([\n                [0.0001, 0.0001],\n                [0.0001, 0.0001]\n            ]),\n            \"V\": 2000000.0,\n            \"alpha\": 0.01\n        },\n        # Case 3 (single-asset case)\n        {\n            \"w\": np.array([1.0]),\n            \"mu\": np.array([-0.0003]),\n            \"Sigma\": np.array([[0.0009]]),\n            \"V\": 500000.0,\n            \"alpha\": 0.05\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        w = case[\"w\"]\n        mu = case[\"mu\"]\n        Sigma = case[\"Sigma\"]\n        V = case[\"V\"]\n        alpha = case[\"alpha\"]\n\n        # 1. Calculate portfolio mean return (mu_p)\n        # mu_p = w^T * mu\n        mu_p = w.T @ mu\n\n        # 2. Calculate portfolio variance of return (sigma_p^2)\n        # sigma_p_sq = w^T * Sigma * w\n        sigma_p_sq = w.T @ Sigma @ w\n\n        # 3. Calculate portfolio standard deviation of return (sigma_p)\n        sigma_p = np.sqrt(sigma_p_sq)\n\n        # 4. Find the standard normal quantile for the given confidence level\n        # z_alpha = Phi^-1(1 - alpha)\n        z_alpha = norm.ppf(1 - alpha)\n\n        # 5. Compute the Value-at-Risk (VaR)\n        # VaR = V * (z_alpha * sigma_p - mu_p)\n        var_value = V * (z_alpha * sigma_p - mu_p)\n\n        # Format the result to two decimal places.\n        results.append(f\"{var_value:.2f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "2447014"}, {"introduction": "在掌握了基本的 $VaR$ 计算之后，我们将进入一个更贴近实际投资决策的综合性问题。在这个练习中，投资组合的权重不再是给定的，而是需要你通过求解经典的 Markowitz 均值-方差最优化问题来确定 [@problem_id:2446949]。这个实践将风险衡量（$VaR$）与投资组合理论无缝结合，让你体验如何首先构建一个有效的投资组合，然后量化其面临的风险，从而将预期收益、方差和风险价值这几个核心概念联系起来。", "problem": "给定一个投资组合选择问题，您需要通过求解 Markowitz 均值-方差优化来选择投资组合权重 $w$。假设资产收益率服从联合高斯分布，且投资组合与权重呈线性关系。目标是使用方差-协方差法为多个测试案例计算风险价值 (VaR)。适用以下定义和假设。\n\n- 令 $n$ 表示资产数量。令预期收益向量为 $\\mu \\in \\mathbb{R}^n$，协方差矩阵为 $\\Sigma \\in \\mathbb{R}^{n \\times n}$，其中 $\\Sigma$ 是对称正定的。令目标投资组合预期收益为 $r_{\\text{target}} \\in \\mathbb{R}$。令投资组合价值为 $V \\in \\mathbb{R}_{+}$。令持有期（周期单位与 $\\mu$ 和 $\\Sigma$ 的单位匹配）为 $h \\in \\mathbb{N}$。令置信水平为 $c \\in (0,1)$。所有收益率均以每期的小数形式表示。\n\n- 用于确定 $w \\in \\mathbb{R}^n$ 的 Markowitz 均值-方差问题是：\n  在满足目标预期收益和完全投资的约束下，最小化投资组合方差：\n  $$\\min_{w \\in \\mathbb{R}^n} \\; w^{\\top} \\Sigma \\, w \\quad \\text{subject to} \\quad \\mu^{\\top} w = r_{\\text{target}}, \\quad \\mathbf{1}^{\\top} w = 1.$$\n  这里 $\\mathbf{1} \\in \\mathbb{R}^n$ 是全一向量。\n\n- 在方差-协方差法和多变量正态收益率的假设下，投资组合收益 $R_p$ 服从均值为 $\\mu_p = \\mu^{\\top} w$、方差为 $\\sigma_p^2 = w^{\\top} \\Sigma \\, w$ 的高斯分布。在持有期 $h$ 内，假设增量是独立同分布 (i.i.d.) 的，因此 $h$ 周期均值和标准差分别为 $\\mu_h = h \\, \\mu_p$ 和 $\\sigma_h = \\sqrt{h} \\, \\sigma_p$。对于置信水平 $c$，令 $z_c$ 表示标准正态分布的 $c$ 分位数。将投资组合损失定义为 $L = - V \\, R_p$。您的任务是使用方差-协方差法（参数法）计算置信水平为 $c$ 的风险价值 (VaR)，以货币单位表示。\n\n您的程序必须为每个测试案例精确求解上述 Markowitz 优化问题，然后相应地计算 VaR，并输出结果。\n\n测试套件。对于下述每个案例，计算一个单一的 VaR 数值。\n\n- 案例 $1$ (常规路径，4 种资产)：\n  - $\\mu = [\\, 0.01, \\, 0.015, \\, 0.02, \\, 0.012 \\,]$\n  - $\\Sigma = \\begin{bmatrix}\n    0.0030 & 0.0012 & 0.0011 & 0.0009 \\\\\n    0.0012 & 0.0040 & 0.0013 & 0.0010 \\\\\n    0.0011 & 0.0013 & 0.0050 & 0.0012 \\\\\n    0.0009 & 0.0010 & 0.0012 & 0.0035\n  \\end{bmatrix}$\n  - $r_{\\text{target}} = 0.015$\n  - $V = 1000000$\n  - $h = 1$\n  - $c = 0.99$\n\n- 案例 $2$ (有效前沿上的边界点，4 种资产)：使用与案例 $1$ 相同的 $\\mu$ 和 $\\Sigma$，但将目标预期收益设置为由 $\\mu$ 和 $\\Sigma$ 决定的全局最小方差投资组合的预期收益。即，计算\n  $$r_{\\text{target}} = \\frac{B}{A}, \\quad \\text{其中} \\quad A = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}, \\quad B = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mu.$$\n  使用\n  - $V = 1000000$\n  - $h = 1$\n  - $c = 0.95$\n\n- 案例 $3$ (持有期调整和不同维度，3 种资产)：\n  - $\\mu = [\\, 0.008, \\, 0.011, \\, 0.0095 \\,]$\n  - $\\Sigma = \\begin{bmatrix}\n    0.0025 & -0.0003 & 0.0004 \\\\\n    -0.0003 & 0.0030 & -0.0002 \\\\\n    0.0004 & -0.0002 & 0.0020\n  \\end{bmatrix}$\n  - $r_{\\text{target}} = 0.0105$\n  - $V = 2000000$\n  - $h = 3$\n  - $c = 0.975$\n\n要求。\n\n- 仅使用上述明确说明的数学假设和约束。不要引入额外的约束，如卖空限制；允许 $w$ 取满足线性约束的任何实数值。\n\n- 您的程序必须：\n  1. 对每个测试案例，使用从第一性原理出发的线性代数推导来求解所述的均值-方差优化问题以获得 $w$。\n  2. 计算置信水平为 $c$ 的 $h$ 周期 VaR，以货币单位（与 $V$ 的单位相同）表示。将最终数值表示为浮点值（小数）。\n  3. 将三个 VaR 结果汇总到单行输出中，按案例 1、2、3 的顺序，以方括号括起来的逗号分隔列表形式呈现，如 $[x_1,x_2,x_3]$。", "solution": "问题陈述已经过分析并被认为是有效的。其科学依据扎根于金融数学的既定原理，特别是 Markowitz 投资组合理论和参数化风险价值 (VaR) 计算。该问题是适定的、客观的，并为得出唯一解提供了所有必要数据。所提供的协方差矩阵是对称正定的，确保了优化问题有合规的解。\n\n解决方案分两部分展开：首先，求解 Markowitz 均值-方差优化问题；其次，使用方差-协方差法计算投资组合的 VaR。\n\nMarkowitz 优化问题公式如下：\n$$\n\\min_{w \\in \\mathbb{R}^n} \\; \\sigma_p^2 = w^{\\top} \\Sigma w\n$$\n受两个线性约束：\n$$\n\\mu^{\\top} w = r_{\\text{target}} \\quad (\\text{目标收益})\n$$\n$$\n\\mathbf{1}^{\\top} w = 1 \\quad (\\text{完全投资})\n$$\n其中 $w$是投资组合权重向量，$\\mu$是预期资产收益向量，$\\Sigma$是资产收益的协方差矩阵，$r_{\\text{target}}$是期望的投资组合预期收益，$\\mathbf{1}$是全一向量。\n\n这是一个约束二次优化问题。我们使用拉格朗日乘数法来求解。拉格朗日函数 $\\mathcal{L}$ 是：\n$$\n\\mathcal{L}(w, \\lambda_1, \\lambda_2) = w^{\\top} \\Sigma w - 2\\lambda_1 (\\mu^{\\top} w - r_{\\text{target}}) - 2\\lambda_2 (\\mathbf{1}^{\\top} w - 1)\n$$\n因子 $2$ 的引入是为了代数上的便利。关于权重向量 $w$ 的一阶条件是：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial w} = 2 \\Sigma w - 2\\lambda_1 \\mu - 2\\lambda_2 \\mathbf{1} = \\mathbf{0}\n$$\n由于 $\\Sigma$ 是正定的，其逆矩阵 $\\Sigma^{-1}$ 存在。我们可以解出 $w$：\n$$\n\\Sigma w = \\lambda_1 \\mu + \\lambda_2 \\mathbf{1}\n$$\n$$\nw = \\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}\n$$\n为了求出拉格朗日乘数 $\\lambda_1$ 和 $\\lambda_2$，我们将 $w$ 的这个表达式代入两个约束条件中：\n$1$. $\\mu^{\\top} w = \\mu^{\\top} (\\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}) = \\lambda_1 (\\mu^{\\top} \\Sigma^{-1} \\mu) + \\lambda_2 (\\mu^{\\top} \\Sigma^{-1} \\mathbf{1}) = r_{\\text{target}}$\n$2$. $\\mathbf{1}^{\\top} w = \\mathbf{1}^{\\top} (\\lambda_1 \\Sigma^{-1} \\mu + \\lambda_2 \\Sigma^{-1} \\mathbf{1}) = \\lambda_1 (\\mathbf{1}^{\\top} \\Sigma^{-1} \\mu) + \\lambda_2 (\\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}) = 1$\n\n我们定义三个标量来简化该系统：\n$A = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mathbf{1}$\n$B = \\mathbf{1}^{\\top} \\Sigma^{-1} \\mu$\n$C = \\mu^{\\top} \\Sigma^{-1} \\mu$\n关于 $(\\lambda_1, \\lambda_2)$ 的线性方程组变为：\n$$\n\\begin{pmatrix} C & B \\\\ B & A \\end{pmatrix} \\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix} = \\begin{pmatrix} r_{\\text{target}} \\\\ 1 \\end{pmatrix}\n$$\n该方程组的解通过矩阵求逆得到：\n$$\n\\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix} = \\frac{1}{AC - B^2} \\begin{pmatrix} A & -B \\\\ -B & C \\end{pmatrix} \\begin{pmatrix} r_{\\text{target}} \\\\ 1 \\end{pmatrix}\n$$\n由此得出：\n$$\n\\lambda_1 = \\frac{A r_{\\text{target}} - B}{AC - B^2}\n$$\n$$\n\\lambda_2 = \\frac{C - B r_{\\text{target}}}{AC - B^2}\n$$\n确定了 $\\lambda_1$ 和 $\\lambda_2$ 后，最优权重向量 $w$ 就完全确定了。投资组合方差 $\\sigma_p^2 = w^{\\top} \\Sigma w$ 即可计算。一个更直接的方差计算方法源于一阶条件：\n$$\n\\sigma_p^2 = w^{\\top} \\Sigma w = w^{\\top}(\\lambda_1 \\mu + \\lambda_2 \\mathbf{1}) = \\lambda_1 (w^{\\top} \\mu) + \\lambda_2 (w^{\\top} \\mathbf{1})\n$$\n使用约束条件 $w^{\\top} \\mu = r_{\\text{target}}$ 和 $w^{\\top} \\mathbf{1} = 1$，我们得到一个简洁的结果：\n$$\n\\sigma_p^2 = \\lambda_1 r_{\\text{target}} + \\lambda_2\n$$\n代入 $\\lambda_1$ 和 $\\lambda_2$ 的表达式：\n$$\n\\sigma_p^2 = \\frac{(A r_{\\text{target}} - B)r_{\\text{target}} + (C - B r_{\\text{target}})}{AC - B^2} = \\frac{A r_{\\text{target}}^2 - 2B r_{\\text{target}} + C}{AC - B^2}\n$$\n这个方程描述了有效前沿，它在 $(\\sigma_p^2, r_{\\text{target}})$ 平面中是一条抛物线。\n对于案例 2，目标收益是全局最小方差投资组合 (GMVP) 的收益。GMVP 对应于这条抛物线的顶点，其位置在 $r_{\\text{target}} = B/A$。GMVP 的方差是 $\\sigma_{\\text{GMV}}^2 = 1/A$。\n\n接下来，我们计算风险价值。问题陈述表明投资组合收益是高斯分布的。单周期投资组合收益 $R_p$ 服从 $R_p \\sim \\mathcal{N}(\\mu_p, \\sigma_p^2)$，其中 $\\mu_p = r_{\\text{target}}$，$ \\sigma_p^2$ 是上面计算的方差。假设在持有期 $h$ 内收益是独立同分布的，那么 $h$ 周期收益 $R_h$ 也服从正态分布：\n$$\nR_h \\sim \\mathcal{N}(\\mu_h, \\sigma_h^2)\n$$\n其中 $\\mu_h = h \\mu_p$ 且 $\\sigma_h^2 = h \\sigma_p^2$。\n持有期 $h$ 内的投资组合损失为 $L_h = -V R_h$，其中 $V$ 是初始投资组合价值。置信水平为 $c$ 的 VaR 是指 $\\text{VaR}_c$ 这个值，损失超过这个值的概率为 $1-c$：\n$$\nP(L_h > \\text{VaR}_c) = 1-c\n$$\n代入损失的定义：\n$$\nP(-V R_h > \\text{VaR}_c) = P(R_h < -\\text{VaR}_c / V) = 1-c\n$$\n令 $Z = (R_h - \\mu_h) / \\sigma_h$ 为标准正态变量。那么 $R_h = \\mu_h + \\sigma_h Z$。概率变为：\n$$\nP(\\mu_h + \\sigma_h Z < -\\text{VaR}_c / V) = P(Z < \\frac{-\\text{VaR}_c / V - \\mu_h}{\\sigma_h}) = 1-c\n$$\n令 $z_{1-c}$ 为标准正态分布的 $(1-c)$ 分位数。那么：\n$$\n\\frac{-\\text{VaR}_c / V - \\mu_h}{\\sigma_h} = z_{1-c}\n$$\n根据正态分布的对称性，$z_{1-c} = -z_c$，其中 $z_c$ 是 $c$ 分位数。\n$$\n-\\text{VaR}_c / V - \\mu_h = -\\sigma_h z_c\n$$\n解出 $\\text{VaR}_c$：\n$$\n\\text{VaR}_c = V(z_c \\sigma_h - \\mu_h)\n$$\n每个测试案例的计算步骤是：\n$1$. 给定 $\\mu, \\Sigma, r_{\\text{target}}, V, h$ 和 $c$。\n$2$. 对于案例 2，首先计算 $A=\\mathbf{1}^\\top \\Sigma^{-1} \\mathbf{1}$ 和 $B=\\mathbf{1}^\\top \\Sigma^{-1} \\mu$，然后设置 $r_{\\text{target}} = B/A$。\n$3$. 对于所有案例，根据 $\\mu$ 和 $\\Sigma$ 计算标量 $A, B$ 和 $C=\\mu^\\top\\Sigma^{-1}\\mu$。\n$4$. 计算单周期投资组合方差 $\\sigma_p^2 = (A r_{\\text{target}}^2 - 2B r_{\\text{target}} + C) / (AC - B^2)$。\n$5$. 确定 $h$ 周期均值 $\\mu_h = h r_{\\text{target}}$ 和标准差 $\\sigma_h = \\sqrt{h \\sigma_p^2}$。\n$6$. 找到标准正态 $c$ 分位数 $z_c$。\n$7$. 使用推导出的公式计算 VaR：$\\text{VaR}_c = V(z_c \\sigma_h - \\mu_h)$。\n将实施此程序以得出最终的数值结果。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Solves for the Value at Risk (VaR) for a portfolio optimized\n    using Markowitz mean-variance principles.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Happy path, 4 assets\n        {\n            \"mu\": np.array([0.01, 0.015, 0.02, 0.012]),\n            \"Sigma\": np.array([\n                [0.0030, 0.0012, 0.0011, 0.0009],\n                [0.0012, 0.0040, 0.0013, 0.0010],\n                [0.0011, 0.0013, 0.0050, 0.0012],\n                [0.0009, 0.0010, 0.0012, 0.0035]\n            ]),\n            \"r_target\": 0.015,\n            \"V\": 1000000.0,\n            \"h\": 1,\n            \"c\": 0.99,\n            \"type\": \"standard\"\n        },\n        # Case 2: Boundary on the efficient frontier (GMVP)\n        {\n            \"mu\": np.array([0.01, 0.015, 0.02, 0.012]),\n            \"Sigma\": np.array([\n                [0.0030, 0.0012, 0.0011, 0.0009],\n                [0.0012, 0.0040, 0.0013, 0.0010],\n                [0.0011, 0.0013, 0.0050, 0.0012],\n                [0.0009, 0.0010, 0.0012, 0.0035]\n            ]),\n            \"r_target\": None,  # To be calculated\n            \"V\": 1000000.0,\n            \"h\": 1,\n            \"c\": 0.95,\n            \"type\": \"gmv\"\n        },\n        # Case 3: Horizon scaling and different dimension\n        {\n            \"mu\": np.array([0.008, 0.011, 0.0095]),\n            \"Sigma\": np.array([\n                [0.0025, -0.0003, 0.0004],\n                [-0.0003, 0.0030, -0.0002],\n                [0.0004, -0.0002, 0.0020]\n            ]),\n            \"r_target\": 0.0105,\n            \"V\": 2000000.0,\n            \"h\": 3,\n            \"c\": 0.975,\n            \"type\": \"standard\"\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        mu = case[\"mu\"]\n        Sigma = case[\"Sigma\"]\n        r_target_initial = case[\"r_target\"]\n        V = case[\"V\"]\n        h = case[\"h\"]\n        c = case[\"c\"]\n        case_type = case[\"type\"]\n        \n        n = mu.shape[0]\n        ones = np.ones(n)\n        \n        # Calculate the inverse of the covariance matrix\n        Sigma_inv = np.linalg.inv(Sigma)\n        \n        # Calculate the scalar constants A, B, C\n        A = ones.T @ Sigma_inv @ ones\n        B = ones.T @ Sigma_inv @ mu\n        C = mu.T @ Sigma_inv @ mu\n        \n        # Determine the target return\n        if case_type == \"gmv\":\n            # For the Global Minimum-Variance Portfolio, r_target = B/A\n            r_target = B / A\n        else:\n            r_target = r_target_initial\n\n        # Calculate the portfolio variance using the efficient frontier formula\n        # This formula is derived from the Lagrangian solution.\n        # sigma_p^2 = (A*r_target^2 - 2*B*r_target + C) / (A*C - B^2)\n        # For the GMV case, this simplifies to 1/A. We use the general formula for all cases.\n        denominator = A * C - B**2\n        portfolio_variance_p = (A * r_target**2 - 2 * B * r_target + C) / denominator\n\n        # Scale mean and standard deviation for the horizon h\n        mu_p = r_target\n        sigma_p = np.sqrt(portfolio_variance_p)\n        \n        mu_h = h * mu_p\n        sigma_h = np.sqrt(h) * sigma_p\n        \n        # Find the c-quantile of the standard normal distribution\n        z_c = norm.ppf(c)\n        \n        # Calculate Value at Risk\n        # VaR = V * (z_c * sigma_h - mu_h)\n        var_result = V * (z_c * sigma_h - mu_h)\n        results.append(var_result)\n\n    # Format the results into the required output string\n    formatted_results = f\"[{','.join(f'{r:.10f}' for r in results)}]\"\n\n    # Final print statement in the exact required format.\n    print(formatted_results)\n\nsolve()\n```", "id": "2446949"}, {"introduction": "最后，我们将挑战你超越公式，进行批判性思考，探讨 $VaR$ 模型的局限性。虽然方差-协方差方法功能强大，但其核心假设——风险因子呈线性关系和正态分布——在现实世界中常常被打破 [@problem_id:2447005]。这个练习将展示一些特殊情景，在这些情景中，模型计算出的 $VaR$ 为零，但投资组合实际上却面临巨大的经济风险，从而揭示模型风险、非线性风险（如gamma风险）和未建模风险因子等至关重要的概念。", "problem": "一位风险管理者在一天的时间窗口内，采用方差-协方差法计算风险价值（VaR）。该方法将一日投资组合的盈亏建模为联合正态分布的风险因子变化的线性函数。具体而言：（i）对于线性工具的投资组合，一日盈亏被建模为风险因子变化向量的仿射线性形式；（ii）对于包含单一股票欧式期权的投资组合，银行使用关于股票价格的一阶（delta）线性化，并忽略了诸如 gamma 和 vega 等高阶项。股票的单日连续复利回报率被建模为均值为零、方差为 $\\sigma^{2}$ 的正态分布。当前股价为 $S_{0}$。在此模型选择下，一个对所有建模的风险因子的净一阶敏感度恰好为零的投资组合，其计算出的一日 VaR 为零。\n\n在上述方差-协方差程序下，以下哪个投资组合计算出的一日 VaR 为零，但在经济现实中却仍然极具风险？请选择所有适用项。\n\nA. 卖出1份欧式看涨期权和卖出1份欧式看跌期权，两者均以该股票为标的，具有相同的到期日和行权价 $K=S_{0}$；无该股票或现金头寸。\n\nB. 仅持有一张1天后到期的无风险国库券；无其他头寸，并忽略1天内的利率风险。\n\nC. 做多1股该股票，并做空市场指数期货，名义本金的选择使得投资组合相对于市场指数的贝塔值（beta）恰好为零。VaR 系统仅将市场指数作为权益风险因子建模，并忽略了个股的特异性波动。\n\nD. 买入1份欧式看涨期权并卖出1份欧式看跌期权，两者均以该股票为标的，具有相同的到期日和行权价 $K=S_{0}$；无该股票或现金头寸。", "solution": "我们从陈述的建模基础开始分析。方差-协方差 VaR 假设一日盈亏 $P$ 被建模为联合正态分布的风险因子变化的线性函数。对于具有单一风险因子（其价格）的单一标的股票，期权和股票投资组合的价值 $V$ 在一天内的 delta 线性化变化为\n$$\n\\Delta V \\approx \\delta \\,\\Delta S,\n$$\n其中 $\\delta$ 是对股票价格 $S$ 的净一阶敏感度（美元 delta），$\\Delta S$ 是 $S$ 在一天内的变化。如果股票的一日回报率被建模为均值为零、方差为 $\\sigma^{2}$ 的正态分布，那么 $\\Delta S$ 近似服从均值为零、标准差为 $S_{0}\\sigma$ 的正态分布。在方差-协方差法下，置信水平为 $\\alpha$ 的一日 VaR（忽略小的均值效应）为\n$$\n\\mathrm{VaR}_{\\alpha} \\propto |\\delta|\\,S_{0}\\sigma,\n$$\n因此，如果对所有建模的风险因子的净一阶敏感度 $\\delta$ 恰好为零，则计算出的一日 VaR 为零。然而，如果线性化忽略了重要的高阶风险（如 gamma、vega）或遗漏了相关风险因子（如特异性成分），则经济风险可能仍然很大。\n\n现在评估每个选项。\n\n选项 A：卖出1份欧式看涨期权和卖出1份欧式看跌期权，均为行权价 $K=S_{0}$ 的平价期权，到期日相同；无股票或现金头寸。\n\n根据无套利原理，在 Black–Scholes 框架下，对于无股息支付股票的欧式期权，看涨期权的 delta 为 $\\Delta_{c}=N(d_{1})$，看跌期权的 delta 为 $\\Delta_{p}=N(d_{1})-1$，其中 $N(\\cdot)$ 是标准正态累积分布函数，而 $d_{1}$ 是通常的 Black–Scholes 项。对于平价期权，我们有 $d_{1}=0$ 因而 $N(0)=\\tfrac{1}{2}$。因此，在期初时，\n$$\n\\Delta_{c}=\\tfrac{1}{2},\\qquad \\Delta_{p}=-\\tfrac{1}{2}.\n$$\n卖出跨式组合（卖出1份看涨期权和卖出1份看跌期权）的净 delta 为\n$$\n\\delta_{\\text{net}} = -\\Delta_{c} - \\Delta_{p} = -\\tfrac{1}{2} - (-\\tfrac{1}{2}) = 0.\n$$\n在忽略了 gamma 和 vega 的方差-协方差（delta-正态）法下，由于对唯一建模的因子的一阶风险暴露为零，因此计算出的一日 VaR 为零。在经济上，该头寸风险极高：一个卖出的平价跨式组合是空头凸性（负 gamma）。对于足够大的价格变动 $|\\Delta S|$，二阶项 $\\tfrac{1}{2}\\Gamma (\\Delta S)^{2}$（对于卖出跨式组合，$\\Gamma<0$）将占主导地位，可能产生巨大的损失。结论：正确。\n\n选项 B：仅持有一张1天后到期的无风险国库券；忽略1天内的利率风险。\n\n在所述假设下，一日内的支付在实际上是确定的，并且没有建模的随机风险因子暴露。计算出的一日 VaR 为零，但该头寸并非“极具风险”；事实上，它被建模（并意图）为在该时间窗口内无风险。这不满足“仍然极具风险”的要求。结论：不正确。\n\n选项 C：做多1股该股票，并做空市场指数期货以使投资组合的贝塔值（beta）恰好为零；VaR 系统仅将市场指数作为权益因子建模，并忽略特异性风险。\n\n设股票的回报率可分解为 $R_{i}=\\beta_{i} R_{m}+\\varepsilon_{i}$，其中 $R_{m}$ 是市场指数回报率，$\\varepsilon_{i}$ 是特异性部分，其方差为 $\\sigma_{\\varepsilon}^{2}$，且独立于 $R_{m}$。根据假设，方差-协方差系统仅对 $R_{m}$ 建模，并将投资组合的风险暴露映射到单一因子 $R_{m}$ 上。选择合适的期货名义本金将净贝塔值设为零，使得对 $R_{m}$ 的建模一阶风险暴露恰好为零。因此，在银行的因子集下，计算出的一日 VaR 为零。在经济上，该头寸仍然带有该个股的特异性成分 $\\varepsilon_{i}$，这可能很大（例如，公司特定新闻、盈利意外）。由于该风险因子被模型忽略，它不进入计算的 VaR，但在现实中可能导致巨大损失。因此，该投资组合计算出的 VaR 为零，但仍可能具有极高的风险。结论：正确。\n\n选项 D：买入1份欧式看涨期权并卖出1份欧式看跌期权，均为行权价 $K=S_{0}$ 的平价期权；无股票或现金头寸。\n\n根据买卖权平价关系和 delta，该头寸是一个合成远期：净 delta 等于\n$$\n\\delta_{\\text{net}} = \\Delta_{c} - \\Delta_{p} = \\tfrac{1}{2} - (-\\tfrac{1}{2}) = 1,\n$$\n因此它对股票价格有一阶非零风险暴露。在方差-协方差法下，计算出的一日 VaR 与 $S_{0}\\sigma$ 成正比，且为严格正值，不为零。虽然该头寸可能有风险，但它不满足“通过方差-协方差法计算的 VaR 为零”的条件。结论：不正确。\n\n总结：选项 A 和 C 满足在方差-协方差法下计算的 VaR 为零的条件，同时在经济上因分别忽略了高阶（gamma）风险和遗漏了特异性风险而具有很高的风险。", "answer": "$$\\boxed{AC}$$", "id": "2447005"}]}