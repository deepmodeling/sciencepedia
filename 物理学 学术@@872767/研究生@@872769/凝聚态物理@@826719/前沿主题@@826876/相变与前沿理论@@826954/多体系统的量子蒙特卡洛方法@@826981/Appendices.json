{"hands_on_practices": [{"introduction": "在量子蒙特卡洛（QMC）模拟中，我们常常从一个与目标分布相似但更易于采样的“重要性”分布中抽取样本。这项实践 [@problem_id:3012335] 至关重要，因为它揭示了如何使用重要性权重来修正由于分布不匹配而产生的偏差，这是许多高级蒙特卡洛方法的核心。通过这个练习，您将获得识别和量化朴素采样偏差的解析实践经验。", "problem": "考虑一个多体态可观测量的一个量子蒙特卡洛（QMC）估计。设 $x$ 是一个位形变量，从目标概率密度 $p(x)$ 中抽取。该密度与一个处于平衡态的相互作用费米子晶格子系统的试探波函数的模平方成正比。在实践中，人们通常从一个更容易抽取样本但与 $p(x)$ 不匹配的重要性分布 $q(x)$ 中进行抽样。可观测量 $O(x)$ 在 $p(x)$下的期望值由基本概率法则定义为 $ \\langle O \\rangle_{p} = \\int O(x)\\, p(x)\\, dx$，并且样本 $\\{x_i\\}_{i=1}^{N}$ 是从 $q(x)$ 中独立抽取的。\n\n从基本的测度变换恒等式和期望的性质出发，推导一个 $\\langle O \\rangle_{p}$ 的抽样估计量，该估计量在 $p(x)$ 仅在相差一个乘法归一化常数的情况下已知，且 $q(x)$ 不匹配但其支撑集覆盖 $p(x)$ 的非零区域时仍然有效。分析如果使用从 $q(x)$ 中抽取的样本，不进行任何重加权，而直接计算朴素样本均值 $\\frac{1}{N}\\sum_{i=1}^{N} O(x_i)$ 所产生的偏差，并用关于 $q(x)$ 和 $p(x)$ 的期望来表示此偏差。\n\n为了使偏差具体化，考虑多体位形的一个一维边缘分布，其目标密度 $p(x)$ 为标准正态密度 $p(x)=\\frac{1}{\\sqrt{2\\pi}}\\exp\\!\\left(-\\frac{x^{2}}{2}\\right)$，而抽样从参数为 $\\mu \\in \\mathbb{R}$ 和 $\\sigma0$ 的高斯重要性分布 $q(x)=\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\!\\left(-\\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right)$ 中进行。设可观测量为 $O(x)=x^{2}$。仅使用高斯积分的公认性质和上述定义，计算朴素估计量的精确偏差，定义为 $\\mathbb{E}_{q}[O(x)] - \\mathbb{E}_{p}[O(x)]$，并以 $\\mu$ 和 $\\sigma$ 的单个闭式解析表达式形式给出最终答案。不需要单位。如果可以简化，请给出简化后的表达式。最终答案必须是一个解析表达式，不含额外评注或中间步骤。", "solution": "首先根据所需标准对问题进行验证。\n\n### 步骤1：提取已知条件\n-   $x$: 一个位形变量。\n-   $p(x)$: 一个目标概率密度。\n-   $q(x)$: 一个重要性抽样分布。\n-   $\\langle O \\rangle_{p} = \\int O(x)\\, p(x)\\, dx$: 可观测量 $O(x)$ 在 $p(x)$ 下的期望值。\n-   $\\{x_i\\}_{i=1}^{N}$: 从 $q(x)$ 中独立抽取的 $N$ 个样本集合。\n-   要求1：推导一个 $\\langle O \\rangle_{p}$ 的抽样估计量，该估计量在 $p(x)$ 仅在相差一个乘法归一化常数的情况下已知，且 $q(x)$ 的支撑集覆盖 $p(x)$ 的非零区域时有效。\n-   要求2：分析使用从 $q(x)$ 中抽取的样本计算朴素估计量 $\\frac{1}{N}\\sum_{i=1}^{N} O(x_i)$ 所产生的偏差。\n-   要求3：用关于 $q(x)$ 和 $p(x)$ 的期望来表示此偏差。\n-   偏差计算的具体案例：\n    -   目标密度：$p(x)=\\frac{1}{\\sqrt{2\\pi}}\\exp\\left(-\\frac{x^{2}}{2}\\right)$。\n    -   抽样密度：$q(x)=\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\left(-\\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right)$，其中 $\\mu \\in \\mathbb{R}$ 且 $\\sigma0$。\n    -   可观测量：$O(x)=x^{2}$。\n-   具体案例中偏差的定义：$\\mathbb{E}_{q}[O(x)] - \\mathbb{E}_{p}[O(x)]$。\n-   任务：以单个闭式解析表达式计算具体案例的精确偏差。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，提法严谨且客观。它描述了重要性抽样这一标准统计方法，这是包括凝聚态物理在内的许多科学领域中蒙特卡洛模拟的基石。这些概念基于基础概率论。该问题提法严谨，为一般性推导和具体计算提供了所有必要信息。使用高斯分布和可观测量 $O(x) = x^2$ 构成了一个标准、可解的教科书式问题。不存在矛盾、歧义或事实错误。该问题需要严谨的数学推导和计算，而非主观看法。\n\n### 步骤3：结论与行动\n该问题被判定为**有效**。将提供完整解答。\n\n### 解答推导\n问题的第一部分要求推导一个通用重要性抽样估计量。可观测量 $O(x)$ 关于概率密度 $p(x)$ 的期望定义为\n$$ \\langle O \\rangle_{p} = \\int O(x) p(x) \\, dx $$\n为了使用来自不同分布 $q(x)$ 的样本，我们采用测度变换。我们将被积函数乘以并除以 $q(x)$，只要在 $O(x)p(x) \\neq 0$ 的地方有 $q(x)  0$，这个操作就是允许的。这得到：\n$$ \\langle O \\rangle_{p} = \\int O(x) \\frac{p(x)}{q(x)} q(x) \\, dx $$\n这可以解释为量 $O(x) \\frac{p(x)}{q(x)}$ 关于分布 $q(x)$ 的期望：\n$$ \\langle O \\rangle_{p} = \\mathbb{E}_{q}\\left[ O(x) \\frac{p(x)}{q(x)} \\right] $$\n项 $w(x) = \\frac{p(x)}{q(x)}$ 被称为重要性权重。给定从 $q(x)$ 中抽取的 $N$ 个独立样本 $\\{x_i\\}_{i=1}^{N}$，$\\langle O \\rangle_{p}$ 的一个蒙特卡洛估计量是重加权可观测量的样本均值：\n$$ \\hat{O}_N = \\frac{1}{N} \\sum_{i=1}^{N} O(x_i) w(x_i) = \\frac{1}{N} \\sum_{i=1}^{N} O(x_i) \\frac{p(x_i)}{q(x_i)} $$\n现在，考虑 $p(x)$ 仅在相差一个归一化常数 $C_p$ 的情况下已知的情况，即 $p(x) = C_p \\tilde{p}(x)$，其中 $\\tilde{p}(x)$ 是未归一化的密度。真实的期望值被恰当地定义为一个比率：\n$$ \\langle O \\rangle_{p} = \\frac{\\int O(x) p(x) \\, dx}{\\int p(x) \\, dx} = \\frac{\\int O(x) C_p \\tilde{p}(x) \\, dx}{\\int C_p \\tilde{p}(x) \\, dx} = \\frac{\\int O(x) \\tilde{p}(x) \\, dx}{\\int \\tilde{p}(x) \\, dx} $$\n对分子和分母同时应用测度变换：\n$$ \\langle O \\rangle_{p} = \\frac{\\int O(x) \\frac{\\tilde{p}(x)}{q(x)} q(x) \\, dx}{\\int \\frac{\\tilde{p}(x)}{q(x)} q(x) \\, dx} = \\frac{\\mathbb{E}_{q}\\left[ O(x) \\frac{\\tilde{p}(x)}{q(x)} \\right]}{\\mathbb{E}_{q}\\left[ \\frac{\\tilde{p}(x)}{q(x)} \\right]} $$\n这导出了自归一化重要性抽样（SNIS）估计量。设未归一化的权重为 $\\tilde{w}(x_i) = \\frac{\\tilde{p}(x_i)}{q(x_i)}$。$\\langle O \\rangle_p$ 的估计量是分子和分母样本均值的比率：\n$$ \\hat{O}_{\\text{SNIS}} = \\frac{\\frac{1}{N} \\sum_{i=1}^{N} O(x_i) \\tilde{w}(x_i)}{\\frac{1}{N} \\sum_{j=1}^{N} \\tilde{w}(x_j)} = \\frac{\\sum_{i=1}^{N} O(x_i) \\tilde{w}(x_i)}{\\sum_{j=1}^{N} \\tilde{w}(x_j)} $$\n即使 $p(x)$ 未归一化，该估计量也有效。\n\n接下来，我们分析朴素估计量的偏差。朴素估计量就是使用从 $q(x)$ 抽取的样本 $x_i$ 计算的可观测量 $O(x)$ 的样本均值：\n$$ \\hat{O}_{\\text{naive}} = \\frac{1}{N} \\sum_{i=1}^{N} O(x_i) $$\n该估计量的期望可以通过应用期望的线性性质找到。因为每个 $x_i$ 都根据 $q(x)$ 同分布：\n$$ \\mathbb{E}[\\hat{O}_{\\text{naive}}] = \\mathbb{E}\\left[\\frac{1}{N} \\sum_{i=1}^{N} O(x_i)\\right] = \\frac{1}{N} \\sum_{i=1}^{N} \\mathbb{E}[O(x_i)] = \\mathbb{E}_q[O(x)] $$\n估计量的偏差是其期望值与被估计的真值之差。真值为 $\\langle O \\rangle_p = \\mathbb{E}_p[O(x)]$。因此，偏差为：\n$$ \\text{Bias} = \\mathbb{E}[\\hat{O}_{\\text{naive}}] - \\langle O \\rangle_p = \\mathbb{E}_q[O(x)] - \\mathbb{E}_p[O(x)] $$\n这个偏差的表达式在问题陈述中已经给出，我们的分析验证了它。\n\n最后，我们为所提供的具体案例计算这个偏差。我们已知：\n-   目标分布：$p(x)=\\frac{1}{\\sqrt{2\\pi}}\\exp\\left(-\\frac{x^{2}}{2}\\right)$，即标准正态分布 $\\mathcal{N}(0, 1)$。\n-   抽样分布：$q(x)=\\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\exp\\left(-\\frac{(x-\\mu)^{2}}{2\\sigma^{2}}\\right)$，即一般正态分布 $\\mathcal{N}(\\mu, \\sigma^2)$。\n-   可观测量：$O(x)=x^{2}$。\n\n我们需要计算期望 $\\mathbb{E}_p[x^2]$ 和 $\\mathbb{E}_q[x^2]$。对于任意均值为 $\\mathbb{E}[X]$、方差为 $\\text{Var}(X)$ 的随机变量 $X$，其二阶矩由关系式 $\\text{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$ 给出。这意味着 $\\mathbb{E}[X^2] = \\text{Var}(X) + (\\mathbb{E}[X])^2$。\n\n首先，我们计算关于 $p(x)$ 的期望。对于标准正态分布 $\\mathcal{N}(0, 1)$，均值为 $0$，方差为 $1$。\n$$ \\mathbb{E}_p[x] = 0 $$\n$$ \\text{Var}_p(x) = 1 $$\n因此，该可观测量期望的真值为：\n$$ \\mathbb{E}_p[x^2] = \\text{Var}_p(x) + (\\mathbb{E}_p[x])^2 = 1 + 0^2 = 1 $$\n\n接下来，我们计算关于 $q(x)$ 的期望。对于一般正态分布 $\\mathcal{N}(\\mu, \\sigma^2)$，均值为 $\\mu$，方差为 $\\sigma^2$。\n$$ \\mathbb{E}_q[x] = \\mu $$\n$$ \\text{Var}_q(x) = \\sigma^2 $$\n因此，朴素估计量的期望值为：\n$$ \\mathbb{E}_q[x^2] = \\text{Var}_q(x) + (\\mathbb{E}_q[x])^2 = \\sigma^2 + \\mu^2 $$\n\n偏差是这两个量之差：\n$$ \\text{Bias} = \\mathbb{E}_q[x^2] - \\mathbb{E}_p[x^2] = (\\mu^2 + \\sigma^2) - 1 $$\n得到的偏差为 $\\mu^2 + \\sigma^2 - 1$。该表达式为零当且仅当 $\\mu=0$ 且 $\\sigma=1$，这正是抽样分布与目标分布匹配的情况（$q(x) = p(x)$），符合预期。", "answer": "$$\\boxed{\\mu^{2} + \\sigma^{2} - 1}$$", "id": "3012335"}, {"introduction": "蠕虫算法是一种在巨正则系综中进行模拟的强大技术，在这样的系综中，粒子数可以发生涨落。这项实践 [@problem_id:3012426] 提供了直接的动手经验，指导您从细致平衡第一性原理出发，推导并实现一个核心的QMC更新方案。通过这个练习，您将把理论知识转化为一个实用的连续时间模拟核心程序。", "problem": "考虑一个处于巨正则系综中的玻色多体系统，其哈密顿量简化为 Bose–Hubbard 模型的单个格点，由 $H = \\frac{U}{2}\\hat{n}(\\hat{n}-1) - \\mu \\hat{n}$ 给出，其中 $\\hat{n}$ 是粒子数算符， $U$ 是在位相互作用强度， $\\mu$ 是化学势。在自然单位制中进行计算，其中约化普朗克常数和玻尔兹曼常数满足 $\\hbar = 1$ 和 $k_{\\mathrm{B}} = 1$，因此能量是无量纲的，逆温 $\\beta$ 的单位是能量的倒数，虚时间 $\\tau$ 的单位也是能量的倒数。在逆温 $\\beta$ 下，巨正则配分函数为 $Z = \\mathrm{Tr}\\, e^{-\\beta H}$。在连续时间世界线表示中，单个格点上的一个组态由区间 $[0,\\beta)$ 上的分段恒定占据数 $n(\\tau)$ 指定，并满足虚时间上的周期性边界条件。其权重正比于 $\\exp\\left(-\\int_{0}^{\\beta} \\mathrm{d}\\tau\\, E(n(\\tau))\\right)$，其中 $E(n) = \\frac{U}{2}n(n-1) - \\mu n$。\n\n你将在一个扩展组态空间中工作，该空间包含一个用于抽样非对角关联函数的蠕虫扇区。在蠕虫扇区中，一对不连续点（一个蠕虫头和一个蠕虫尾）在虚时间 $\\tau_{\\mathrm{head}}$ 和 $\\tau_{\\mathrm{tail}}$ 处被插入，使得在这两个不连续点之间，相对于对角扇区，占据数增加了 $+1$，而在该区间之外，占据数保持不变。设时间有序间距（抬升段的长度）为 $l \\in (0,\\beta)$，因此在 $\\tau_{\\mathrm{tail}}$ 和 $\\tau_{\\mathrm{head}}$ 之间占据数为 $n+1$，其他地方为 $n$。使用一个蠕虫算符，其矩阵元对于占据数恰好改变一的情况等于一，因此没有额外的局域矩阵元因子。引入一个正的、无量纲的调节常数 $\\eta$，用于控制扩展系综中蠕虫扇区权重的相对归一化。在任何阶段都不要将虚时间离散化。\n\n你必须仅使用基本原理推导出满足细致平衡的插入和移除移动的 Metropolis–Hastings 接受概率：\n- 世界线权重为 $w \\propto \\exp\\left(-\\int_{0}^{\\beta} \\mathrm{d}\\tau\\, E(n(\\tau))\\right)$。\n- 细致平衡要求 $P(C)\\, W(C\\to C')\\, A(C\\to C') = P(C')\\, W(C'\\to C)\\, A(C'\\to C)$，其中 $P(C)$ 是扩展系综中组态 $C$ 的未归一化权重， $W$ 表示提议概率或密度， $A$ 是待推导的未知接受概率。\n- 具有恒定占据数 $n$ 的单个格点上的对角扇区组态的权重正比于 $\\exp(-\\beta E(n))$。\n- 具有长度为 $l$ 的抬升段的蠕虫扇区组态的权重正比于 $\\eta \\exp(-( \\beta - l) E(n) - l E(n+1))$。\n\n对于提议，采用以下无需时间离散化的显式连续时间选择：\n- 从对角扇区出发，通过在 $[0,\\beta)$ 上均匀抽取蠕虫尾时间 $\\tau_{\\mathrm{tail}}$，并从 $(0,\\beta)$ 上的概率密度 $f(l)$ 中抽取段长度 $l$ 来提议一次插入，且两者独立。使用均匀的 $f(l)$，即 $f(l) = 1/\\beta$。为明确起见，仅考虑增加 $+1$ 的抬升移动。\n- 从蠕虫扇区出发，通过确定性地选择唯一的现有蠕虫并尝试将其删除来提议一次移除，没有额外的随机选择。\n\n使用以上信息，根据指定的提议方案，为任意的 $U0$、实数 $\\mu$、逆温 $\\beta0$、整数占据数 $n \\geq 0$、段长度 $l \\in (0,\\beta)$ 和调节常数 $\\eta0$ 推导出服从细致平衡的显式插入和移除接受概率。\n\n然后，为此单格点问题实现一个连续时间蠕虫更新核心，该核心为给定参数计算以下情况的 Metropolis–Hastings 接受概率：\n- 插入一个蠕虫，使其在长度为 $l$ 的段上将占据数增加 $+1$。\n- 移除该蠕虫。\n\n你的实现必须在虚时间上完全连续，并且不得依赖任何离散化。对于数值评估，请使用以下参数测试套件：\n- 情况 1：$\\beta = 2.0$, $U = 1.0$, $\\mu = 0.5$, $n = 1$, $\\eta = 0.1$, $l = 0.7$。\n- 情况 2：$\\beta = 2.0$, $U = 4.0$, $\\mu = 1.5$, $n = 0$, $\\eta = 0.05$, $l = 1.3$。\n- 情况 3：$\\beta = 10.0$, $U = 8.0$, $\\mu = 2.1$, $n = 2$, $\\eta = 0.01$, $l = 5.0$。\n- 情况 4（能量差为零的边缘情况）：$\\beta = 3.0$, $U = 1.2$, $\\mu = 2.4$, $n = 2$, $\\eta = 0.2$, $l = 1.1$。\n\n所有量均应在所述的自然单位制中处理，因此答案是无量纲的实数。\n\n你的程序必须生成单行输出，其中包含上述四种情况的插入和移除接受概率，按顺序排列，形式为用方括号括起来的逗号分隔列表，每个数字四舍五入到十位小数：\n$[\\text{ins}_{1}, \\text{rem}_{1}, \\text{ins}_{2}, \\text{rem}_{2}, \\text{ins}_{3}, \\text{rem}_{3}, \\text{ins}_{4}, \\text{rem}_{4}]$。", "solution": "目标是为连续虚时间中的单格点 Bose–Hubbard 模型推导蠕虫插入和移除移动的 Metropolis–Hastings 接受概率。推导过程必须遵循细致平衡原则。\n\n该系统由哈密顿量 $H = \\frac{U}{2}\\hat{n}(\\hat{n}-1) - \\mu \\hat{n}$ 描述。具有确定占据数 $n$ 的状态的能量为 $E(n) = \\frac{U}{2}n(n-1) - \\mu n$。\n\n我们在扩展系综中考虑两种类型的组态：\n1.  对角组态 $C_D$，其中对于所有 $\\tau \\in [0, \\beta)$，占据数是恒定的 $n(\\tau) = n$。此组态的未归一化权重由 $P(C_D) = \\exp(-\\beta E(n))$ 给出。\n2.  蠕虫组态 $C_W$，其特征在于背景占据数 $n$、蠕虫尾时间 $\\tau_{\\mathrm{tail}}$ 和蠕虫长度 $l$。在虚时间区间 $\\tau_{\\mathrm{tail}}$ 和 $\\tau_{\\mathrm{head}} = (\\tau_{\\mathrm{tail}} + l) \\pmod \\beta$ 之间，占据数为 $n+1$，其他地方为 $n$。此组态的权重包含一个调节常数 $\\eta$，并由 $P(C_W) = \\eta \\exp(-(\\beta - l)E(n) - lE(n+1))$ 给出。这是关于连续变量 $\\tau_{\\mathrm{tail}}$ 和 $l$ 的权重密度。\n\n细致平衡原则指出，在平衡状态下，从状态 $C$ 到状态 $C'$ 的跃迁速率必须等于从 $C'$ 到 $C$ 的跃迁速率。对于以概率（或概率密度） $W$ 提议并以概率 $A$ 接受的移动，这表示为：\n$$P(C)\\, W(C\\to C')\\, A(C\\to C') = P(C')\\, W(C'\\to C)\\, A(C'\\to C)$$\n\n我们将此原则应用于插入和移除移动。\n\n**1. 插入移动：$C_D \\to C_W$**\n初始状态是具有恒定占据数 $n$ 的对角组态 $C_D$。通过以下方式提议一个蠕虫组态 $C_W$：\n-   从 $[0, \\beta)$ 上的均匀分布中抽取尾部时间 $\\tau_{\\mathrm{tail}}$。概率密度为 $1/\\beta$。\n-   从 $(0, \\beta)$ 上的均匀分布中抽取蠕虫长度 $l$。概率密度为 $f(l) = 1/\\beta$。\n\n因为这些选择是独立的，所以从对角状态 $n$ 创建特定蠕虫 $(n, l, \\tau_{\\mathrm{tail}})$ 的总提议概率密度为：\n$$W(C_D \\to C_W) = \\frac{1}{\\beta} \\times \\frac{1}{\\beta} = \\frac{1}{\\beta^2}$$\n这是在 $(\\tau_{\\mathrm{tail}}, l)$ 空间中的概率密度。\n\n**2. 移除移动：$C_W \\to C_D$**\n初始状态是一个蠕虫组态 $C_W$。提议是确定性地移除这个现有的蠕虫，返回到对角组态 $C_D$。由于此提议是唯一的，并且没有相关的随机变量，其提议概率为：\n$$W(C_W \\to C_D) = 1$$\n\n**3. 细致平衡方程**\n我们现在构建细致平衡方程。正确处理离散概率与连续概率密度之间的维度至关重要。该方程必须平衡离散状态 $C_D$ 与由 $(\\tau_{\\mathrm{tail}}, l)$ 描述的连续状态空间 $C_W$ 的无穷小区域之间的概率流。\n\n$$P(C_D) \\, W(C_D \\to C_W) \\, A_{\\text{ins}} = P(C_W) \\, W(C_W \\to C_D) \\, A_{\\text{rem}}$$\n其中 $A_{\\text{ins}} = A(C_D \\to C_W)$ 和 $A_{\\text{rem}} = A(C_W \\to C_D)$。\n\nMetropolis–Hastings 对接受概率的选择由 $A(C \\to C') = \\min(1, R)$ 给出，其中比率 $R$ 为：\n$$R = \\frac{P(C') W(C' \\to C)}{P(C) W(C \\to C')}$$\n\n对于插入移动，比率 $R_{\\text{ins}}$ 为：\n$$R_{\\text{ins}} = \\frac{P(C_W) W(C_W \\to C_D)}{P(C_D) W(C_D \\to C_W)}$$\n代入权重和提议概率：\n$$R_{\\text{ins}} = \\frac{\\eta \\exp(-(\\beta - l)E(n) - lE(n+1)) \\cdot 1}{\\exp(-\\beta E(n)) \\cdot (1/\\beta^2)}$$\n简化表达式：\n$$R_{\\text{ins}} = \\eta \\beta^2 \\frac{\\exp(-\\beta E(n) + l E(n) - l E(n+1))}{\\exp(-\\beta E(n))}$$\n$$R_{\\text{ins}} = \\eta \\beta^2 \\exp(l(E(n) - E(n+1)))$$\n设 $\\Delta E = E(n+1) - E(n)$ 为增加一个粒子的能量代价。\n$$R_{\\text{ins}} = \\eta \\beta^2 \\exp(-l \\Delta E)$$\n\n我们计算 $\\Delta E$：\n$$E(n+1) = \\frac{U}{2}(n+1)n - \\mu(n+1)$$\n$$E(n) = \\frac{U}{2}n(n-1) - \\mu n$$\n$$\\Delta E = E(n+1) - E(n) = \\frac{U}{2}[n(n+1) - n(n-1)] - \\mu[(n+1) - n]$$\n$$\\Delta E = \\frac{U}{2}[n^2 + n - n^2 + n] - \\mu[1] = \\frac{U}{2}(2n) - \\mu$$\n$$\\Delta E = U n - \\mu$$\n因此，插入提议的比率为：\n$$R_{\\text{ins}} = \\eta \\beta^2 \\exp(-l(Un - \\mu))$$\n\n插入的接受概率为：\n$$A_{\\text{ins}} = \\min(1, R_{\\text{ins}}) = \\min(1, \\eta \\beta^2 \\exp(-l(Un - \\mu)))$$\n\n对于移除移动，比率 $R_{\\text{rem}}$ 是 $R_{\\text{ins}}$ 的倒数：\n$$R_{\\text{rem}} = \\frac{1}{R_{\\text{ins}}} = \\frac{1}{\\eta \\beta^2} \\exp(l(Un - \\mu))$$\n移除的接受概率为：\n$$A_{\\text{rem}} = \\min(1, R_{\\text{rem}}) = \\min(1, \\frac{1}{\\eta \\beta^2} \\exp(l(Un - \\mu)))$$\n\n这些表达式为任何有效的参数集 $\\beta  0$、 $U0$、 $\\mu \\in \\mathbb{R}$、整数 $n \\ge 0$、 $\\eta  0$ 和 $l \\in (0, \\beta)$ 提供了所需的接受概率。实现将包括为提供的测试用例评估这些公式。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes Metropolis-Hastings acceptance probabilities for worm insertion and\n    removal in a continuous-time QMC simulation of the single-site Bose-Hubbard model.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (beta, U, mu, n, eta, l)\n    test_cases = [\n        # Case 1: beta=2.0, U=1.0, mu=0.5, n=1, eta=0.1, l=0.7\n        (2.0, 1.0, 0.5, 1, 0.1, 0.7),\n        # Case 2: beta=2.0, U=4.0, mu=1.5, n=0, eta=0.05, l=1.3\n        (2.0, 4.0, 1.5, 0, 0.05, 1.3),\n        # Case 3: beta=10.0, U=8.0, mu=2.1, n=2, eta=0.01, l=5.0\n        (10.0, 8.0, 2.1, 2, 0.01, 5.0),\n        # Case 4: beta=3.0, U=1.2, mu=2.4, n=2, eta=0.2, l=1.1\n        (3.0, 1.2, 2.4, 2, 0.2, 1.1),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        beta, U, mu, n, eta, l = case\n        \n        # Calculate the energy difference delta_E = E(n+1) - E(n)\n        # delta_E = (U/2 * (n+1)*n - mu*(n+1)) - (U/2 * n*(n-1) - mu*n)\n        # Simplified to:\n        delta_E = U * n - mu\n        \n        # Calculate the Metropolis-Hastings ratio for the insertion move.\n        # R_ins = eta * beta^2 * exp(-l * delta_E)\n        # This is the ratio of P(C')W(C'->C) / P(C)W(C->C')\n        # where C is the diagonal state and C' is the worm state.\n        # W(C->C') = 1/beta^2 (proposal density)\n        # W(C'->C) = 1 (deterministic proposal)\n        ratio = eta * (beta ** 2) * np.exp(-l * delta_E)\n        \n        # Acceptance probability for insertion is min(1, R_ins)\n        acc_ins = min(1.0, ratio)\n        \n        # Acceptance probability for removal is min(1, 1/R_ins)\n        # To avoid division by zero if `ratio` is extremely small (underflows to 0),\n        # note that `1.0/0.0` yields `inf` in Python, and `min(1.0, inf)` correctly gives 1.0.\n        if ratio == 0:\n            # This happens if l * delta_E is very large and positive.\n            # In this case R_ins = 0, so A_ins = 0.\n            # R_rem = infinity, so A_rem = 1.\n            acc_rem = 1.0\n        else:\n            acc_rem = min(1.0, 1.0 / ratio)\n            \n        results.append(acc_ins)\n        results.append(acc_rem)\n\n    # Format the results to ten decimal places as specified.\n    formatted_results = [f\"{r:.10f}\" for r in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3012426"}, {"introduction": "许多QMC模拟的直接输出是系统的能量。为了获得如熵等其他关键的热力学性质，必须采用后处理技术。这项练习 [@problem_id:3012293] 将引导您掌握其中最重要的方法之一——热力学积分，并教授一项关键技能：如何将原始模拟数据中的统计误差正确地传递到最终推导出的物理量中。", "problem": "给定一个多体系统在离散温度下的平衡能量的量子蒙特卡洛（QMC）测量值。在玻尔兹曼常数 $k_{B}=1$ 的单位制下，您必须实现一个基于热力学积分的熵估算器，并根据不同逆温度 $\\beta=1/T$ 下的QMC数据推导出其统计误差。您将从以下平衡态统计力学的基本定义和恒等式出发：对于配分函数 $Z(\\beta)$，亥姆霍兹自由能 $F(\\beta)$ 满足 $F(\\beta)=-\\beta^{-1}\\ln Z(\\beta)$ 以及 $$\\frac{d}{d\\beta}\\bigl(\\beta F(\\beta)\\bigr)=\\langle E\\rangle(\\beta),$$ 其中 $\\langle E\\rangle(\\beta)$ 是能量的热期望值。热力学熵遵循 $F=E-TS$，因此 $$S(\\beta)=\\beta\\bigl(\\langle E\\rangle(\\beta)-F(\\beta)\\bigr).$$\n\n从这些定义出发，利用离散的QMC数据 $\\{(\\beta_{j},\\langle E\\rangle_{j},\\sigma_{E,j})\\}_{j=0}^{i}$ 和在最低可用逆温度 $\\beta_{0}$ 处的已知基准值 $B_{0}=\\beta_{0}F(\\beta_{0})$，推导出 $S(\\beta_{i})$ 的估算器。结合这些恒等式，可写出\n$$\\beta F(\\beta)=\\beta_{0}F(\\beta_{0})+\\int_{\\beta_{0}}^{\\beta}\\langle E\\rangle(\\beta')\\,d\\beta'.$$\n因此，在给定 $B_{0}$ 的情况下，目标 $S(\\beta_{i})$ 为\n$$S(\\beta_{i})=\\beta_{i}\\langle E\\rangle_{i}-B_{0}-\\int_{\\beta_{0}}^{\\beta_{i}}\\langle E\\rangle(\\beta')\\,d\\beta'.$$\n在离散网格 $\\beta_{0}\\beta_{1}\\cdots\\beta_{i}$ 上使用复合梯形法则实现该积分：\n$$\\int_{\\beta_{0}}^{\\beta_{i}}\\langle E\\rangle(\\beta')\\,d\\beta' \\approx \\sum_{j=0}^{i-1}\\frac{\\beta_{j+1}-\\beta_{j}}{2}\\bigl(\\langle E\\rangle_{j}+\\langle E\\rangle_{j+1}\\bigr),$$\n可以重写为权重为\n$$w_{0}^{(i)}=\\frac{\\beta_{1}-\\beta_{0}}{2},\\quad w_{j}^{(i)}=\\frac{\\beta_{j+1}-\\beta_{j}}{2}+\\frac{\\beta_{j}-\\beta_{j-1}}{2}\\ \\text{for}\\ 1\\le j\\le i-1,\\quad w_{i}^{(i)}=\\frac{\\beta_{i}-\\beta_{i-1}}{2}$$\n的线性组合 $\\sum_{j=0}^{i}w_{j}^{(i)}\\langle E\\rangle_{j}$。\n假设不同温度下的能量估计值具有独立的⾼斯统计误差，其标准差为 $\\sigma_{E,j}$。在梯形估算器下，推导该积分和 $S(\\beta_{i})$ 的方差。使用线性误差传播，积分的方差为\n$$\\mathrm{Var}\\!\\left(\\sum_{j=0}^{i}w_{j}^{(i)}\\langle E\\rangle_{j}\\right)=\\sum_{j=0}^{i}\\left(w_{j}^{(i)}\\right)^{2}\\sigma_{E,j}^{2}.$$\n由于 $S(\\beta_{i})=\\beta_{i}\\langle E\\rangle_{i}-B_{0}-\\sum_{j=0}^{i}w_{j}^{(i)}\\langle E\\rangle_{j}$，$\\beta_{i}\\langle E\\rangle_{i}$ 与积分之间的协方差会产生贡献。在不同温度下独立的假设下，$\\mathrm{Cov}(\\langle E\\rangle_{i},\\sum_{j}w_{j}^{(i)}\\langle E\\rangle_{j})=w_{i}^{(i)}\\sigma_{E,i}^{2}$。因此，\n$$\\mathrm{Var}\\bigl(S(\\beta_{i})\\bigr)=\\beta_{i}^{2}\\sigma_{E,i}^{2}+\\sum_{j=0}^{i}\\left(w_{j}^{(i)}\\right)^{2}\\sigma_{E,j}^{2}-2\\beta_{i}w_{i}^{(i)}\\sigma_{E,i}^{2}.$$\n您的程序必须：\n- 对于每个测试用例，使用梯形估算器计算所提供网格中所有索引 $i$ 的熵矢量 $S(\\beta_{i})$，以及由上述方差的平方根给出的相应标准不确定度。\n- 接受直接提供基准值 $B_{0}=\\beta_{0}F(\\beta_{0})$，或者当 $\\beta_{0}=0$ 时，希尔伯特空间维度 $D$ 是已知的；在后一种情况下，使用 $B_{0}=-\\ln D$，因为 $\\beta F(\\beta)=-\\ln Z(\\beta)$ 且 $Z(0)=D$。\n- 以 $k_{B}$ 为单位表示每个熵值（在所采用的单位制中是无量纲的）。没有舍入要求；报告浮点数结果。\n- 不涉及使用弧度或角度。\n\n输入作为以下参数集的测试套件嵌入在程序中（每个测试用例包括逆温度 $\\beta$、平均能量 $\\langle E\\rangle$、其标准差 $\\sigma_{E}$ 的数组，以及 $D$ 或 $B_{0}$）：\n1. 案例A（顺利路径，有限希尔伯特空间，基准在 $\\beta_{0}=0$）：\n   - $\\beta=[0.0,0.5,1.0,2.0]$\n   - $\\langle E\\rangle=[0.0,-0.35,-0.62,-0.95]$\n   - $\\sigma_{E}=[0.01,0.02,0.02,0.03]$\n   - $D=4$.\n2. 案例B（边界，两点网格，基准在 $\\beta_{0}=0$）：\n   - $\\beta=[0.0,3.0]$\n   - $\\langle E\\rangle=[0.0,-1.2]$\n   - $\\sigma_{E}=[0.02,0.05]$\n   - $D=8$.\n3. 案例C（非零基准在 $\\beta_{0}0$，无 $D$ 的知识）：\n   - $\\beta=[0.4,0.9,1.1,1.6]$\n   - $\\langle E\\rangle=[-0.2,-0.41,-0.46,-0.61]$\n   - $\\sigma_{E}=[0.03,0.04,0.04,0.05]$\n   - $B_{0}=-0.25$.\n4. 案例D（边缘情况，误差较大的不规则网格，基准在 $\\beta_{0}=0$）：\n   - $\\beta=[0.0,0.1,0.5,0.8]$\n   - $\\langle E\\rangle=[0.0,-0.05,-0.30,-0.45]$\n   - $\\sigma_{E}=[0.20,0.15,0.10,0.10]$\n   - $D=64$.\n\n您的程序应生成单行输出，包含方括号括起来的逗号分隔的结果列表，其中每个元素对应一个测试用例，并且本身是一个包含两个元素的列表：第一个元素是该案例的 $S(\\beta_{i})$ 值列表，第二个元素是它们的标准不确定度列表。例如，输出格式必须类似于\n\"[[[S_A_0,S_A_1,...],[sigma_A_0,sigma_A_1,...]],[[S_B_0,S_B_1],[sigma_B_0,sigma_B_1]],...]\"，不含任何额外文本。", "solution": "该问题要求基于一个多体系统能量的离散量子蒙特卡洛（QMC）数据，实现一个热力学熵 $S$ 及其统计不确定度的估算器。该解决方案在平衡态统计力学的框架内构建，其中单位的选择使得玻尔兹曼常数 $k_{B}=1$。\n\n推导从亥姆霍兹自由能 $F(\\beta)$ 的基本定义及其与逆温度 $\\beta=1/T$ 下的正则配分函数 $Z(\\beta)$ 的关系开始：\n$$F(\\beta) = -\\frac{1}{\\beta} \\ln Z(\\beta)$$\n这等价于 $\\beta F(\\beta) = -\\ln Z(\\beta)$。能量的热期望值 $\\langle E \\rangle(\\beta)$ 通过热力学恒等式与自由能相关联：\n$$\\frac{d}{d\\beta}\\bigl(\\beta F(\\beta)\\bigr) = \\langle E\\rangle(\\beta)$$\n将此恒等式从参考逆温度 $\\beta_0$ 积分到目标逆温度 $\\beta$，得到：\n$$\\beta F(\\beta) - \\beta_0 F(\\beta_0) = \\int_{\\beta_0}^{\\beta} \\langle E\\rangle(\\beta') \\,d\\beta'$$\n热力学熵 $S(\\beta)$ 由关系式 $F = \\langle E \\rangle - TS$ 定义，可以重写为：\n$$S(\\beta) = \\beta\\bigl(\\langle E\\rangle(\\beta) - F(\\beta)\\bigr)$$\n将 $\\beta F(\\beta)$ 的积分表达式代入熵方程，得到在离散点 $\\beta_i$ 处 $S$ 的估算器：\n$$S(\\beta_i) = \\beta_i \\langle E\\rangle_i - \\beta_i F(\\beta_i) = \\beta_i \\langle E\\rangle_i - \\left( \\beta_0 F(\\beta_0) + \\int_{\\beta_0}^{\\beta_i} \\langle E\\rangle(\\beta') \\,d\\beta' \\right)$$\n令 $B_0 = \\beta_0 F(\\beta_0)$ 为已知基准值，熵估算器的表达式变为：\n$$S(\\beta_i) = \\beta_i \\langle E\\rangle_i - B_0 - \\int_{\\beta_0}^{\\beta_i} \\langle E\\rangle(\\beta') \\,d\\beta'$$\n基准值 $B_0$ 要么直接提供，要么从高温极限（$\\beta \\to 0$）确定。在此极限下，配分函数 $Z(0)$ 等于总态数，即希尔伯特空间维度 $D$。因此，如果 $\\beta_0=0$，我们有 $B_0 = \\lim_{\\beta \\to 0} \\beta F(\\beta) = -\\ln Z(0) = -\\ln D$。在 $\\beta_0=0$ 时，熵为 $S(0) = \\ln D$，其统计不确定度为零，因为它是系统的定义属性，而不是一个测量量。\n\n算法设计通过为一组离散的QMC数据点 $\\{(\\beta_j, \\langle E\\rangle_j, \\sigma_{E,j})\\}_{j=0}^{M-1}$ 实现此公式来进行。积分使用复合梯形法则近似计算。对于目标点 $\\beta_i$，积分为：\n$$\\int_{\\beta_0}^{\\beta_i} \\langle E\\rangle(\\beta') \\,d\\beta' \\approx \\sum_{j=0}^{i-1} \\frac{\\beta_{j+1}-\\beta_j}{2} \\bigl(\\langle E\\rangle_j + \\langle E\\rangle_{j+1}\\bigr) = \\sum_{j=0}^{i} w_j^{(i)} \\langle E\\rangle_j$$\n权重 $w_j^{(i)}$ 由问题陈述给出：$w_0^{(i)} = \\frac{\\beta_1-\\beta_0}{2}$，$w_j^{(i)} = \\frac{\\beta_{j+1}-\\beta_{j-1}}{2}$ 对于 $1 \\le j  i$，以及 $w_i^{(i)} = \\frac{\\beta_i-\\beta_{i-1}}{2}$。\n\n为了确定 $S(\\beta_i)$ 的统计不确定度，我们使用线性误差传播。假设不同温度下的能量估计值 $\\langle E\\rangle_j$ 是独立的随机变量，其方差为 $\\sigma_{E,j}^2$。熵估算器可以写成这些变量的线性组合：\n$$S(\\beta_i) = -B_0 - \\sum_{j=0}^{i-1} w_j^{(i)} \\langle E\\rangle_j + (\\beta_i - w_i^{(i)}) \\langle E\\rangle_i$$\n方差 $\\mathrm{Var}(S(\\beta_i))$ 是每一项方差的总和，因为 $B_0$ 是一个常数，而 $\\langle E\\rangle_j$ 是独立的：\n$$\\mathrm{Var}\\bigl(S(\\beta_i)\\bigr) = \\sum_{j=0}^{i} c_j^2 \\sigma_{E,j}^2$$\n其中系数 $c_j$ 由 $c_j = -w_j^{(i)}$ (对于 $j  i$) 和 $c_i = \\beta_i - w_i^{(i)}$ 给出。这得出了方差的最终表达式：\n$$\\mathrm{Var}\\bigl(S(\\beta_i)\\bigr) = \\left( \\sum_{j=0}^{i-1} (w_j^{(i)})^2 \\sigma_{E,j}^2 \\right) + (\\beta_i - w_i^{(i)})^2 \\sigma_{E,i}^2$$\n对于起始点 $i=0$，积分为零，因此 $S(\\beta_0) = \\beta_0 \\langle E\\rangle_0 - B_0$。方差就是 $\\mathrm{Var}(S(\\beta_0)) = \\beta_0^2 \\sigma_{E,0}^2$。\n\n实现的程序会遍历输入网格中的每个点 $\\beta_i$（$i=0, \\dots, M-1$）。对于每个 $i$，它首先计算到该点的梯形积分值。然后计算熵 $S(\\beta_i)$。随后，它计算权重 $w_j^{(i)}$（对于 $j=0, \\dots, i$），并使用这些权重根据推导出的公式计算 $\\mathrm{Var}(S(\\beta_i))$。标准不确定度是此方差的平方根。此过程应用于每个测试用例，并按规定格式化结果。", "answer": "```python\nimport numpy as np\nimport json\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the final output for entropy calculation.\n    \"\"\"\n    test_cases = [\n        {\n            \"beta\": [0.0, 0.5, 1.0, 2.0],\n            \"energy\": [0.0, -0.35, -0.62, -0.95],\n            \"sigma_E\": [0.01, 0.02, 0.02, 0.03],\n            \"D\": 4,\n            \"B0\": None,\n        },\n        {\n            \"beta\": [0.0, 3.0],\n            \"energy\": [0.0, -1.2],\n            \"sigma_E\": [0.02, 0.05],\n            \"D\": 8,\n            \"B0\": None,\n        },\n        {\n            \"beta\": [0.4, 0.9, 1.1, 1.6],\n            \"energy\": [-0.2, -0.41, -0.46, -0.61],\n            \"sigma_E\": [0.03, 0.04, 0.04, 0.05],\n            \"D\": None,\n            \"B0\": -0.25,\n        },\n        {\n            \"beta\": [0.0, 0.1, 0.5, 0.8],\n            \"energy\": [0.0, -0.05, -0.30, -0.45],\n            \"sigma_E\": [0.20, 0.15, 0.10, 0.10],\n            \"D\": 64,\n            \"B0\": None,\n        },\n    ]\n\n    all_case_results = []\n\n    for case in test_cases:\n        betas = np.array(case[\"beta\"], dtype=float)\n        energies = np.array(case[\"energy\"], dtype=float)\n        sigmas_E = np.array(case[\"sigma_E\"], dtype=float)\n        D = case[\"D\"]\n        B0_val = case[\"B0\"]\n\n        M = len(betas)\n        entropies = np.zeros(M)\n        uncertainties = np.zeros(M)\n        \n        if D is not None:\n            B0 = -np.log(D)\n        else:\n            B0 = B0_val\n\n        for i in range(M):\n            # --- Entropy Calculation ---\n            integral_val = 0.0\n            if i > 0:\n                integral_val = np.trapz(energies[:i+1], betas[:i+1])\n            \n            entropies[i] = betas[i] * energies[i] - B0 - integral_val\n\n            # --- Uncertainty Calculation ---\n            if i == 0:\n                if betas[0] == 0:\n                    uncertainties[i] = 0.0\n                else:\n                    uncertainties[i] = betas[0] * sigmas_E[0]\n            else:\n                # Calculate weights for the trapezoidal rule up to point i\n                w = np.zeros(i + 1)\n                w[0] = (betas[1] - betas[0]) / 2.0\n                for j in range(1, i):\n                    w[j] = (betas[j+1] - betas[j-1]) / 2.0\n                w[i] = (betas[i] - betas[i-1]) / 2.0\n                \n                # Use the variance formula provided in the problem description\n                var_integral = np.sum(w**2 * sigmas_E[:i+1]**2)\n                var_S_i = (betas[i]**2 * sigmas_E[i]**2) + var_integral - 2 * betas[i] * w[i] * sigmas_E[i]**2\n                uncertainties[i] = np.sqrt(max(0, var_S_i))\n\n        all_case_results.append([entropies.tolist(), uncertainties.tolist()])\n    \n    # Print the results in the specified JSON-like format\n    print(json.dumps(all_case_results))\n\nsolve()\n```", "id": "3012293"}]}