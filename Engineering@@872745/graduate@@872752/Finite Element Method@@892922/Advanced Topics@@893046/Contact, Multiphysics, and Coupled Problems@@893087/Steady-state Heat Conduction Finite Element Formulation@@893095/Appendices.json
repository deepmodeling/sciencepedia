{"hands_on_practices": [{"introduction": "The foundation of the Finite Element Method lies in discretizing a continuous problem into a system of algebraic equations. This first practice takes you through the essential steps of this process for the simplest case: a one-dimensional steady-state heat conduction element. By starting from the governing differential equation and applying the Galerkin method, you will derive the element stiffness matrix and load vector, which are the fundamental building blocks for any finite element analysis. [@problem_id:2599170]", "problem": "Consider one-dimensional steady-state heat conduction in a homogeneous prismatic rod of length $h$ with constant thermal conductivity $k$ and spatially uniform volumetric heat generation $Q$. Assume unit cross-sectional area so that all expressions are per unit out-of-plane thickness. The governing strong form on an element is $-\\dfrac{d}{dx}\\!\\left(k\\,\\dfrac{dT}{dx}\\right)=Q$ on $x\\in[0,h]$. Using the Finite Element Method (FEM) with the standard Galerkin approach and two-node linear interpolation, proceed as follows:\n\n1. Starting from the strong form, construct the weighted residual statement, integrate by parts to obtain the weak form over the element, and clearly identify the bilinear and linear forms.\n\n2. Using linear shape functions on the element with nodes at $x=0$ and $x=h$, derive the element stiffness matrix $K_e$ and the consistent element load vector $f_e$ for constant $k$ and $Q$.\n\n3. Define the discrete energy functional for the element,\n$$\n\\Pi(T_e)\\;=\\;\\dfrac{1}{2}\\,T_e^{\\mathsf T}\\,K_e\\,T_e\\;-\\;T_e^{\\mathsf T}\\,f_e,\n$$\nwhere $T_e=\\begin{bmatrix}T_1 & T_2\\end{bmatrix}^{\\mathsf T}$ collects the nodal temperatures. Evaluate $\\Pi(T_e)$ at the specific nodal temperature vector $T_e=\\begin{bmatrix}0 & 1\\end{bmatrix}^{\\mathsf T}$.\n\nProvide your final answer as a single closed-form symbolic expression in terms of $k$, $h$, and $Q$. Do not evaluate numerically or round.", "solution": "The problem as stated is scientifically grounded, well-posed, objective, and self-contained. It is a standard exercise in the application of the Finite Element Method to a second-order boundary value problem, specifically one-dimensional steady-state heat conduction. All necessary parameters and governing equations are provided, and there are no contradictions or ambiguities. The problem is therefore deemed valid and a solution will be constructed.\n\nThe solution process proceeds in three stages as delineated by the problem statement.\n\nFirst, we derive the weak form of the governing equation. The strong form for an element of length $h$ is given as:\n$$-\\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) = Q, \\quad x \\in [0, h]$$\nThe residual $R(x)$ is formed by moving all terms to one side:\n$$R(x) = -\\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) - Q$$\nAccording to the Galerkin method, the residual must be orthogonal to a set of weighting functions $w(x)$ over the element domain. This is expressed as the weighted residual statement:\n$$\\int_{0}^{h} w(x) R(x) \\,dx = 0$$\nSubstituting the expression for the residual, we have:\n$$\\int_{0}^{h} w(x) \\left[ -\\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) - Q \\right] dx = 0$$\nThis can be separated into two terms:\n$$-\\int_{0}^{h} w(x) \\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) dx - \\int_{0}^{h} w(x) Q \\,dx = 0$$\nTo reduce the order of the derivative on the temperature field $T(x)$, we apply integration by parts to the first term, $\\int u \\,dv = [uv] - \\int v \\,du$. Let $u = w(x)$ and $dv = \\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right)dx$. This gives $du = \\frac{dw}{dx}dx$ and $v = k \\frac{dT}{dx}$. Applying this yields:\n$$\\int_{0}^{h} w(x) \\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) dx = \\left[ w(x) k \\frac{dT}{dx} \\right]_{0}^{h} - \\int_{0}^{h} k \\frac{dT}{dx} \\frac{dw}{dx} dx$$\nSubstituting this back into the weighted residual statement and rearranging gives the weak form:\n$$\\int_{0}^{h} k \\frac{dw}{dx} \\frac{dT}{dx} dx = \\int_{0}^{h} w(x) Q \\,dx - \\left[ w(x) k \\frac{dT}{dx} \\right]_{0}^{h}$$\nThis formulation is of the type $a(w, T) = L(w)$, where $a(w, T)$ is a bilinear form and $L(w)$ is a linear functional.\nThe bilinear form is identified as:\n$$a(w, T) = \\int_{0}^{h} k \\frac{dw}{dx} \\frac{dT}{dx} dx$$\nThe linear functional is:\n$$L(w) = \\int_{0}^{h} w(x) Q \\,dx + w(h)q_{h} - w(0)q_{0}$$\nwhere $q_{h} = -k \\frac{dT}{dx}|_{x=h}$ and $q_{0} = -k \\frac{dT}{dx}|_{x=0}$ are the heat fluxes at the element boundaries.\n\nSecond, we derive the element stiffness matrix $K_e$ and consistent load vector $f_e$. For a two-node linear element with nodes at $x=0$ and $x=h$, the temperature field $T(x)$ is approximated by $T_h(x) = N_1(x)T_1 + N_2(x)T_2$, where $T_1$ and $T_2$ are the nodal temperatures. The linear shape functions are:\n$$N_1(x) = 1 - \\frac{x}{h}, \\quad N_2(x) = \\frac{x}{h}$$\nTheir derivatives with respect to $x$ are:\n$$\\frac{dN_1}{dx} = -\\frac{1}{h}, \\quad \\frac{dN_2}{dx} = \\frac{1}{h}$$\nThe element stiffness matrix $K_e$ has components $K_{ij} = a(N_i, N_j) = \\int_0^h k \\frac{dN_i}{dx} \\frac{dN_j}{dx} dx$. For constant $k$:\n$$K_{11} = \\int_{0}^{h} k \\left(-\\frac{1}{h}\\right)\\left(-\\frac{1}{h}\\right) dx = \\frac{k}{h^2} \\int_{0}^{h} dx = \\frac{k}{h}$$\n$$K_{12} = K_{21} = \\int_{0}^{h} k \\left(-\\frac{1}{h}\\right)\\left(\\frac{1}{h}\\right) dx = -\\frac{k}{h^2} \\int_{0}^{h} dx = -\\frac{k}{h}$$\n$$K_{22} = \\int_{0}^{h} k \\left(\\frac{1}{h}\\right)\\left(\\frac{1}{h}\\right) dx = \\frac{k}{h^2} \\int_{0}^{h} dx = \\frac{k}{h}$$\nThus, the element stiffness matrix is:\n$$K_e = \\frac{k}{h} \\begin{pmatrix} 1 & -1 \\\\ -1 & 1 \\end{pmatrix}$$\nThe consistent element load vector $f_e$ due to the volumetric heat source $Q$ has components $f_{e,i} = \\int_0^h N_i(x) Q \\,dx$. For constant $Q$:\n$$f_{e,1} = \\int_{0}^{h} Q \\left(1 - \\frac{x}{h}\\right) dx = Q \\left[x - \\frac{x^2}{2h}\\right]_{0}^{h} = Q \\left(h - \\frac{h^2}{2h}\\right) = \\frac{Qh}{2}$$\n$$f_{e,2} = \\int_{0}^{h} Q \\left(\\frac{x}{h}\\right) dx = \\frac{Q}{h} \\left[\\frac{x^2}{2}\\right]_{0}^{h} = \\frac{Q}{h} \\frac{h^2}{2} = \\frac{Qh}{2}$$\nThus, the consistent element load vector is:\n$$f_e = \\frac{Qh}{2} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$$\n\nThird, we evaluate the discrete energy functional $\\Pi(T_e) = \\frac{1}{2} T_e^{\\mathsf T} K_e T_e - T_e^{\\mathsf T} f_e$ for the given nodal temperature vector $T_e = \\begin{pmatrix} 0 & 1 \\end{pmatrix}^{\\mathsf T}$.\nWe compute the quadratic term first:\n$$T_e^{\\mathsf T} K_e T_e = \\begin{pmatrix} 0 & 1 \\end{pmatrix} \\left( \\frac{k}{h} \\begin{pmatrix} 1 & -1 \\\\ -1 & 1 \\end{pmatrix} \\right) \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$$\n$$= \\frac{k}{h} \\begin{pmatrix} 0 & 1 \\end{pmatrix} \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix} = \\frac{k}{h} ((0)(-1) + (1)(1)) = \\frac{k}{h}$$\nSo, the quadratic part of the functional is $\\frac{1}{2} (T_e^{\\mathsf T} K_e T_e) = \\frac{k}{2h}$.\nNext, we compute the linear term:\n$$T_e^{\\mathsf T} f_e = \\begin{pmatrix} 0 & 1 \\end{pmatrix} \\left( \\frac{Qh}{2} \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix} \\right)$$\n$$= \\frac{Qh}{2} ((0)(1) + (1)(1)) = \\frac{Qh}{2}$$\nFinally, we assemble the complete functional value:\n$$\\Pi(T_e) = \\frac{k}{2h} - \\frac{Qh}{2}$$\nThis expression can be combined into a single fraction:\n$$\\Pi(T_e) = \\frac{k - Qh^2}{2h}$$\nThis is the final symbolic expression for the value of the energy functional.", "answer": "$$ \\boxed{\\frac{k - Qh^{2}}{2h}} $$", "id": "2599170"}, {"introduction": "Once an element is formulated, how can we be sure it will produce accurate results as the mesh is refined? The patch test is a fundamental and necessary condition for the convergence of any finite element formulation. This exercise explores the theoretical underpinnings of the patch test, connecting it to crucial properties of element shape functions and the consistency of the entire numerical scheme. [@problem_id:2599172]", "problem": "Consider steady-state heat conduction in a two-dimensional domain $\\,\\Omega\\,$ with outward unit normal $\\,\\mathbf{n}\\,$, governed by the strong form $-\\nabla\\cdot\\big(k\\,\\nabla T\\big)=q$ in $\\,\\Omega\\,$, with Dirichlet boundary condition $\\,T=\\bar{T}\\,$ on $\\,\\Gamma_D\\,$ and Neumann boundary condition $\\,\\mathbf{n}\\cdot k\\nabla T=\\bar{q}_n\\,$ on $\\,\\Gamma_N\\,$, where $\\,k>0\\,$ is a constant scalar conductivity and $\\,q=0\\,$. Let the weak form be: find $\\,T\\in\\mathcal{V}\\,$ such that for all test functions $\\,w\\in\\mathcal{V}_0\\,$ one has\n$$\n\\int_{\\Omega}\\nabla w\\cdot k\\,\\nabla T\\,\\mathrm{d}\\Omega \\;=\\; \\int_{\\Gamma_N} w\\,\\bar{q}_n\\,\\mathrm{d}\\Gamma,\n$$\nwith $\\,\\mathcal{V}\\,$ the admissible space and $\\,\\mathcal{V}_0\\,$ the subspace with vanishing trace on $\\,\\Gamma_D\\,$. In a conforming Finite Element Method (FEM) discretization using isoparametric Lagrange elements and a Galerkin formulation with numerical quadrature, the patch test for conduction asks whether the discrete solution on a small, conforming mesh patch exactly reproduces prescribed constant or linear temperature fields when boundary data are chosen to make these fields exact solutions of the continuous problem. Specifically, take the constant field $\\,T^\\star(x,y)=a\\,$ or the linear field $\\,T^\\star(x,y)=a+b\\,x+c\\,y\\,$ with $\\,a,b,c\\in\\mathbb{R}\\,$, choose $q=0$ and set $\\,\\bar{q}_n=\\mathbf{n}\\cdot k\\nabla T^\\star\\,$ on $\\,\\Gamma_N\\,$, with $\\,\\Gamma_D\\,$ used only to eliminate any rigid temperature mode if needed. The discrete patch test is passed if the assembled residual vector vanishes when the nodal temperatures are taken as the exact nodal values of $\\,T^\\star\\,$.\n\nWhich of the following statements about the patch test, its prerequisites, and the implications of failure, are correct in this setting? Choose all that apply.\n\nA. For any conforming isoparametric Lagrange element with constant conductivity and exact numerical integration, exact reproduction of a constant temperature field on any patch is equivalent to the shape functions forming a partition of unity on each element.\n\nB. For any conforming isoparametric Lagrange element with constant conductivity and exact numerical integration, exact reproduction of any linear temperature field on any patch is guaranteed if and only if the element interpolation is linearly complete in the physical coordinates $\\,x,y\\,$.\n\nC. In a conforming Galerkin formulation with exact numerical integration and constant conductivity, failure of the linear patch test indicates a lack of consistency of the discrete bilinear form with the continuous weak form and precludes convergence to the exact solution under mesh refinement.\n\nD. Using one-point Gauss integration on bilinear quadrilateral elements with constant conductivity always passes the linear patch test because the exact solution has a constant gradient and the integrand is at most linear.\n\nE. The patch test must be defined with a linearly varying conductivity tensor $\\,k(x,y)\\,$ to assess consistency; passing with constant conductivity is not informative.\n\nF. If Neumann boundary data matching the exact linear solution are imposed on the external boundary of the patch and Dirichlet data constrain any rigid temperature modes, then the assembled residual vector vanishes for the nodal values of the exact linear field if and only if the element passes the patch test.", "solution": "The problem statement shall first be validated for scientific soundness, self-consistency, and clarity.\n\n### Step 1: Extract Givens\n\n1.  **Governing Equation**: Steady-state heat conduction in a 2D domain `$\\Omega$`, strong form: `$-\\nabla\\cdot\\big(k\\,\\nabla T\\big)=q$`.\n2.  **Domain and Boundaries**: Outward unit normal `$\\mathbf{n}$`, Dirichlet boundary `$\\Gamma_D$`, Neumann boundary `$\\Gamma_N$`.\n3.  **Boundary Conditions**: `$\\,T=\\bar{T}\\,$` on `$\\,\\Gamma_D\\,$` and `$\\,\\mathbf{n}\\cdot k\\nabla T=\\bar{q}_n\\,$` on `$\\,\\Gamma_N\\,$`.\n4.  **Material Property**: `$k>0$` is a constant scalar conductivity.\n5.  **Source Term**: `$q=0$`.\n6.  **Weak Form**: Find `$\\,T\\in\\mathcal{V}\\,$` such that for all `$\\,w\\in\\mathcal{V}_0\\,$`, `$\\int_{\\Omega}\\nabla w\\cdot k\\,\\nabla T\\,\\mathrm{d}\\Omega \\;=\\; \\int_{\\Gamma_N} w\\,\\bar{q}_n\\,\\mathrm{d}\\Gamma$`. `$\\mathcal{V}$` and `$\\mathcal{V}_0$` are the standard trial and test function spaces.\n7.  **Discretization**: Conforming Finite Element Method (FEM), isoparametric Lagrange elements, Galerkin formulation, numerical quadrature.\n8.  **Patch Test Definition**:\n    *   **Purpose**: To check if a discrete solution on a small, conforming mesh patch exactly reproduces a prescribed constant or linear temperature field.\n    *   **Test Fields**: `$\\,T^\\star(x,y)=a\\,$` or `$\\,T^\\star(x,y)=a+b\\,x+c\\,y\\,$`.\n    *   **Setup**: Boundary data are chosen to make `$\\,T^\\star\\,$` an exact solution. Specifically, `$q=0$` and `$\\,\\bar{q}_n=\\mathbf{n}\\cdot k\\nabla T^\\star\\,$` on `$\\,\\Gamma_N\\,$`. `$\\,\\Gamma_D\\,$` is used to constrain rigid modes if necessary.\n    *   **Passing Criterion**: The assembled residual vector vanishes when the nodal temperatures are set to the exact nodal values of `$\\,T^\\star\\,$`.\n\n### Step 2: Validate Using Extracted Givens\n\nThe problem statement describes a standard application of the Finite Element Method to the Poisson equation for heat conduction. All definitions—the strong form, weak form, boundary conditions, and the FEM discretization approach—are standard and mathematically consistent. The definition of the patch test, including the choice of linear fields, the setup of boundary conditions, and the criterion for passing (vanishing residual), is correct and corresponds to the established formulation by Irons. The problem is scientifically grounded in the theory of numerical analysis for partial differential equations. It is well-posed, objective, and self-contained, providing all necessary information to evaluate the subsequent statements. No flaws are detected.\n\n### Step 3: Verdict and Action\n\nThe problem is **valid**. A solution will be derived.\n\n### Analysis of a Conforming FEM Formulation\n\nThe discrete system of equations for the FEM problem is given by `$\\mathbf{K}\\mathbf{T} = \\mathbf{F}$`, where `$\\mathbf{T}$` is the vector of nodal temperatures. An entry of the stiffness matrix `$\\mathbf{K}$` and force vector `$\\mathbf{F}$` are, respectively:\n$$\nK_{JI} = \\int_{\\Omega} \\nabla N_J \\cdot k \\nabla N_I \\,\\mathrm{d}\\Omega\n$$\n$$\nF_J = \\int_{\\Gamma_N} N_J \\bar{q}_n \\,\\mathrm{d}\\Gamma + \\int_{\\Omega} N_J q \\,\\mathrm{d}\\Omega\n$$\nwhere `$\\,N_I, N_J\\,$` are the shape functions. For the patch test, `$q=0$`. The residual for the equation at node `$\\,J\\,$` is `$\\,R_J = F_J - \\sum_I K_{JI} T_I\\,$`. The test passes if `$\\,R_J = 0\\,$` for all free nodes `$\\,J\\,$` when `$\\,T_I = T^\\star(x_I, y_I)\\,$`.\nThe interpolated temperature field is `$\\,T^h = \\sum_I N_I T_I\\,$`. The residual can be written as:\n$$\nR_J = \\int_{\\Gamma_N} N_J \\bar{q}_n \\,\\mathrm{d}\\Gamma - \\int_{\\Omega} \\nabla N_J \\cdot k \\nabla T^h \\,\\mathrm{d}\\Omega\n$$\nFor an internal node `$\\,J\\,$` of the patch, `$\\,N_J\\,$` is zero on the boundary `$\\,\\Gamma_N\\,$`, so the boundary integral vanishes. The passing condition for an internal node is `$\\,\\int_{\\Omega} \\nabla N_J \\cdot k \\nabla T^h \\,\\mathrm{d}\\Omega = 0\\,$`.\n\n### Option-by-Option Analysis\n\n**A. For any conforming isoparametric Lagrange element with constant conductivity and exact numerical integration, exact reproduction of a constant temperature field on any patch is equivalent to the shape functions forming a partition of unity on each element.**\n\nThe term \"exact reproduction\" means that the interpolated field `$\\,T^h(x,y)\\,$` is identical to the exact field `$\\,T^\\star(x,y)\\,$` over the element.\nLet `$\\,T^\\star(x,y)=a\\,$`, where `$\\,a\\,$` is a constant. The nodal temperatures are `$\\,T_I=a\\,$` for all nodes `$\\,I\\,$`.\nThe interpolated field is `$\\,T^h = \\sum_I N_I T_I = \\sum_I N_I a = a \\sum_I N_I\\,$`.\nFor `$\\,T^h\\,$` to be identical to `$\\,T^\\star=a\\,$` for any non-zero constant `$\\,a\\,$`, it is necessary and sufficient that `$\\,\\sum_I N_I = 1\\,$`. This is the definition of the partition of unity property.\nThus, the ability of the element to exactly reproduce a constant field is equivalent to its shape functions forming a partition of unity. All standard Lagrange elements are constructed to satisfy this property.\n**Verdict: Correct.**\n\n**B. For any conforming isoparametric Lagrange element with constant conductivity and exact numerical integration, exact reproduction of any linear temperature field on any patch is guaranteed if and only if the element interpolation is linearly complete in the physical coordinates $\\,x,y\\,$.**\n\nSimilar to A, \"exact reproduction\" means `$\\,T^h(x,y) = T^\\star(x,y)\\,$`.\nLet the exact field be a general linear function `$\\,T^\\star(x,y)=a+b\\,x+c\\,y\\,$`. Nodal temperatures are `$\\,T_I=a+b\\,x_I+c\\,y_I\\,$`.\nThe interpolated field is `$\\,T^h = \\sum_I N_I T_I = \\sum_I N_I (a+b\\,x_I+c\\,y_I) = a\\sum_I N_I + b\\sum_I N_I x_I + c\\sum_I N_I y_I\\,$`.\nFor `$\\,T^h\\,$` to be identical to `$\\,T^\\star\\,$` for any choice of `$\\,a,b,c\\,$`, the following must hold:\n1.  `$\\sum_I N_I = 1\\,$` (from the constant part `$\\,a\\,$`)\n2.  `$\\sum_I N_I x_I = x\\,$` (from the linear part `$\\,bx\\,$`)\n3.  `$\\sum_I N_I y_I = y\\,$` (from the linear part `$\\,cy\\,$`)\nThese three conditions are precisely the definition of linear completeness of the interpolation in the physical coordinates `$\\,x,y\\,$`. Therefore, exact reproduction of a linear field is equivalent to linear completeness. The \"if and only if\" condition holds. For isoparametric elements, the mapping from parent to physical coordinates (`$\\,x=\\sum_I N_I x_I, y=\\sum_I N_I y_I\\,$`) ensures that the second and third conditions are met by definition, while the first condition (partition of unity) is a fundamental property of the shape functions.\n**Verdict: Correct.**\n\n**C. In a conforming Galerkin formulation with exact numerical integration and constant conductivity, failure of the linear patch test indicates a lack of consistency of the discrete bilinear form with the continuous weak form and precludes convergence to the exact solution under mesh refinement.**\n\nThis statement addresses the fundamental purpose of the patch test. In FEM error analysis, convergence is typically established by showing a method is both stable and consistent. Consistency means that the discrete equations approximate the continuous (weak form) equations accurately. The patch test is a direct, necessary condition for consistency. If an element formulation cannot exactly solve a problem whose solution is a simple polynomial (like a linear field), when that polynomial is contained within the space of functions the element can represent, then the formulation is inconsistent. An inconsistent method does not converge to the correct solution as the mesh size `$\\,h\\,$` tends to zero. This principle is a cornerstone of FEM theory, articulated first by Irons and related to the Lax equivalence theorem for finite differences. Failure to pass the patch test is a fatal flaw for an element.\n**Verdict: Correct.**\n\n**D. Using one-point Gauss integration on bilinear quadrilateral elements with constant conductivity always passes the linear patch test because the exact solution has a constant gradient and the integrand is at most linear.**\n\nIt is a known result in FEM that bilinear quadrilateral elements with one-point Gauss quadrature pass the linear patch test, even for distorted element shapes. However, the reasoning provided in the statement is flawed.\nFor a linear temperature field `$\\,T^\\star(x,y)=a+bx+cy\\,$`, the interpolated field `$\\,T^h\\,$` is identical to `$\\,T^\\star\\,$` (as shown in B), and its gradient `$\\,\\nabla T^h = (b,c)^T\\,$` is constant. The integral for the residual involves an integrand of the form `$\\,(\\nabla N_J \\cdot k \\nabla T^h)\\det(\\mathbf{J})\\,$` over the parent element. Since `$\\,\\nabla T^h\\,$` and `$\\,k\\,$` are constant, this is proportional to `$\\,(\\nabla N_J \\cdot \\mathbf{c}) \\det(\\mathbf{J})\\,$` where `$\\,\\mathbf{c}\\,$` is a constant vector.\nThe shape function gradient is `$\\,\\nabla N_J = \\mathbf{J}^{-T} \\nabla_\\xi N_J\\,$`. For a general (distorted) isoparametric quadrilateral, the Jacobian matrix `$\\,\\mathbf{J}\\,$` has entries that are linear in the parent coordinates `$\\,\\xi, \\eta\\,$`. Its determinant, `$\\,\\det(\\mathbf{J})\\,$`, is also linear in `$\\,\\xi, \\eta\\,$`. The gradient of the shape function in parent coordinates, `$\\,\\nabla_\\xi N_J\\,$`, is also linear. However, the inverse of the Jacobian, `$\\,\\mathbf{J}^{-1}\\,$`, involves division by `$\\,\\det(\\mathbf{J})\\,$`, making its entries rational functions of `$\\,\\xi, \\eta\\,$`.\nConsequently, the integrand is a rational function, not a simple polynomial, and certainly not \"at most linear\". One-point Gauss quadrature is only exact for integrands that are constant or linear (specifically, of the form `$\\,c_0+c_1\\xi+c_2\\eta\\,$`); it is not exact for the actual integrand. The fact that the test passes is due to a more subtle property known as \"superconvergence\" at the `$\\,(0,0)\\,$` Gauss point, where errors happen to cancel.\nBecause the justification provided is factually incorrect, the statement is invalid.\n**Verdict: Incorrect.**\n\n**E. The patch test must be defined with a linearly varying conductivity tensor $\\,k(x,y)\\,$ to assess consistency; passing with constant conductivity is not informative.**\n\nThis statement is incorrect. The patch test with constant conductivity is the most fundamental and crucial test for an element's formulation. It verifies the element's ability to reproduce complete polynomial fields, which is the basis for proving consistency and convergence. If an element fails this basic test, it is useless for any problem, including those with variable conductivity. Passing the constant-coefficient patch test is therefore highly informative and a mandatory prerequisite. While one can devise more stringent patch tests involving variable coefficients to test performance in those specific scenarios, the claim that the constant `$\\,k\\,$` test \"is not informative\" is false.\nFurthermore, if `$\\,k(x,y)\\,$` varies linearly and `$\\,T(x,y)\\,$` is linear, then `$\\,T\\,$` is generally not a solution to the homogeneous equation `$-\\nabla\\cdot(k\\nabla T)=0\\,$`, which complicates the test setup.\n**Verdict: Incorrect.**\n\n**F. If Neumann boundary data matching the exact linear solution are imposed on the external boundary of the patch and Dirichlet data constrain any rigid temperature modes, then the assembled residual vector vanishes for the nodal values of the exact linear field if and only if the element passes the patch test.**\n\nThis statement is a formal definition of the patch test. Let's analyze its components.\n*   \"Neumann boundary data matching the exact linear solution\": For `$\\,T^\\star\\,$`, this is `$\\,\\bar{q}_n = \\mathbf{n} \\cdot k \\nabla T^\\star\\,$`. This correctly sets the natural boundary condition to be consistent with the field `$\\,T^\\star\\,$` being an exact solution of the continuous problem.\n*   \"Dirichlet data constrain any rigid temperature modes\": For a pure Neumann problem, the solution is unique only up to an additive constant. Fixing the temperature at one or more nodes (constraining the rigid body mode) makes the solution unique. This is a necessary step for a well-posed discrete problem.\n*   \"the assembled residual vector vanishes ... if and only if the element passes the patch test\": The problem preamble defines passing the patch test precisely as the vanishing of the residual vector under these conditions.\nTherefore, the statement `$\\,(\\text{residual vanishes}) \\iff (\\text{test is passed})\\,$` is a direct consequence of the definition of \"passing the patch test\". It is a correct, albeit definitional, statement that verifies understanding of the test's formal setup.\n**Verdict: Correct.**", "answer": "$$\\boxed{ABCF}$$", "id": "2599172"}, {"introduction": "This final practice transitions from theory to a comprehensive computational implementation, a crucial skill for any modern analyst. You will build a complete 2D finite element solver and apply it to a problem with a known 'manufactured' solution, allowing for direct assessment of accuracy. The core task moves beyond just finding a solution to quantifying its error, as you will implement Superconvergent Patch Recovery (SPR) to construct an a posteriori error estimator—a powerful technique used to guide mesh refinement in practical engineering simulations where the exact solution is unknown. [@problem_id:2599230]", "problem": "Implement a program that constructs a Superconvergent Patch Recovery (SPR) for steady-state heat conduction in two space dimensions and uses it to produce an improved a posteriori error estimate. Start from the following fundamental base: conservation of energy and Fourier’s law. Conservation of energy in a stationary regime gives that the divergence of the heat flux equals the source, and Fourier’s law expresses the flux as proportional to the negative temperature gradient. Specifically, let the temperature field be denoted by $T$, the symmetric positive-definite conductivity tensor by $\\mathbf{K}$, and the heat flux by $\\mathbf{q}$. The governing equations are $-\\nabla \\cdot \\mathbf{q} = f$ in the interior and $\\mathbf{q} = -\\mathbf{K} \\nabla T$ with Dirichlet boundary data prescribed on the boundary. Derive the weak form by multiplying the conservation equation by an admissible test function and integrating by parts, using the heat flux definition to express the bilinear form in terms of $\\nabla T$. Then, using a conforming space of continuous piecewise-linear trial and test functions on a triangulation, obtain the discrete linear system. You must not use any shortcut formulas that bypass these derivations.\n\nGiven the exact manufactured solution $T(x,y) = \\sin(\\pi x)\\sin(\\pi y)$ on the unit square domain $[0,1]\\times[0,1]$ with homogeneous Dirichlet boundary conditions enforced by prescribing $T$ itself on the boundary, construct the body source $f$ implied by substituting $T$ and a constant tensor $\\mathbf{K}$ into the strong form. You must use the following mesh family: a structured partition of the unit square into $N_x \\times N_y$ rectangles, each subdivided into two right triangles along the descending diagonal. For each triangle, form the element stiffness using the gradients of the linear shape functions and assemble globally.\n\nDefine the following quantities in terms of the exact and numerical solutions and the conductivity tensor:\n- The exact flux $\\mathbf{q} = -\\mathbf{K}\\nabla T$.\n- The discrete flux per element $\\mathbf{q}_h$ computed from the piecewise-constant gradient of the discrete solution $T_h$ on each triangle.\n- The recovered flux field $\\tilde{\\mathbf{q}}$ obtained by Superconvergent Patch Recovery (SPR), where on each vertex patch you perform two independent local least-squares fits of degree one polynomials in $x$ and $y$ to the sampled components of $\\mathbf{q}_h$ at the centroids of neighboring elements, returning nodal values of $\\tilde{\\mathbf{q}}$ by evaluating the fitted polynomials at the vertex. If an underdetermined fit arises (for example, insufficient sample points at a corner), consistently fall back to the average of the sampled fluxes on the patch for that component.\n\nUse these to define quantitatively:\n- The energy norm of the exact solution $\\lVert T \\rVert_E = \\left(\\int_{\\Omega} \\nabla T^{\\top}\\mathbf{K}\\nabla T \\, \\mathrm{d}\\Omega\\right)^{1/2}$.\n- The exact energy-norm error $\\lVert T - T_h \\rVert_E = \\left(\\int_{\\Omega} (\\nabla T - \\nabla T_h)^{\\top}\\mathbf{K}(\\nabla T - \\nabla T_h) \\, \\mathrm{d}\\Omega\\right)^{1/2}$.\n- The Zienkiewicz–Zhu type estimator based on SPR $\\eta = \\left(\\int_{\\Omega} (\\tilde{\\mathbf{q}} - \\mathbf{q}_h)^{\\top}\\mathbf{K}^{-1}(\\tilde{\\mathbf{q}} - \\mathbf{q}_h) \\, \\mathrm{d}\\Omega\\right)^{1/2}$.\n\nCompute all integrals by a consistent single-point centroid rule on each triangle. Treat all quantities as dimensionless; no physical units are required in the final results.\n\nYour program must:\n- Build and solve the Finite Element Method (FEM) linear system for the manufactured solution with Dirichlet boundary conditions set from $T$ on the boundary.\n- Compute the per-element discrete flux $\\mathbf{q}_h$.\n- Construct the recovered flux $\\tilde{\\mathbf{q}}$ via Superconvergent Patch Recovery (SPR) as specified.\n- Estimate, by centroid quadrature, the global exact energy-norm error, the global estimator $\\eta$, and the energy norm of the exact solution.\n- Report, for each test case, the triple consisting of the relative exact error $\\lVert T - T_h \\rVert_E / \\lVert T \\rVert_E$, the relative estimator $\\eta / \\lVert T \\rVert_E$, and the effectivity index $\\eta / \\lVert T - T_h \\rVert_E$.\n\nTest suite and coverage:\n- Case $1$: $N_x = 4$, $N_y = 4$, isotropic $\\mathbf{K} = \\mathrm{diag}(1,1)$.\n- Case $2$: $N_x = 8$, $N_y = 8$, isotropic $\\mathbf{K} = \\mathrm{diag}(1,1)$.\n- Case $3$: $N_x = 8$, $N_y = 8$, anisotropic $\\mathbf{K} = \\mathrm{diag}(10,1)$.\n\nAngle units do not apply. All outputs are dimensionless floats.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of lists, one inner list per test case, each inner list ordered as $[\\lVert T - T_h \\rVert_E / \\lVert T \\rVert_E,\\ \\eta / \\lVert T \\rVert_E,\\ \\eta / \\lVert T - T_h \\rVert_E]$, and enclosed in square brackets. For example: $[[a_1,b_1,c_1],[a_2,b_2,c_2],[a_3,b_3,c_3]]$, where each $a_i,b_i,c_i$ is a float.", "solution": "The problem requires the implementation of a Finite Element Method (FEM) solver for two-dimensional steady-state heat conduction, followed by a Superconvergent Patch Recovery (SPR) procedure to compute an a posteriori error estimate. The analysis must begin from first principles.\n\nLet $\\Omega \\subset \\mathbb{R}^2$ be a domain with boundary $\\partial\\Omega$. The temperature field is denoted by $T(\\mathbf{x})$, the heat flux by $\\mathbf{q}(\\mathbf{x})$, the heat source by $f(\\mathbf{x})$, and the thermal conductivity by a symmetric positive-definite tensor $\\mathbf{K}$.\n\nThe governing physical principles are:\n1.  **Conservation of Energy (steady state)**: The net heat flux out of any infinitesimal control volume is balanced by the internal heat generation. In differential form, this is expressed as:\n    $$ -\\nabla \\cdot \\mathbf{q} = f $$\n2.  **Fourier's Law of Heat Conduction**: The heat flux is proportional to the negative of the temperature gradient.\n    $$ \\mathbf{q} = -\\mathbf{K} \\nabla T $$\n\nCombining these two equations yields the strong form of the governing partial differential equation (PDE) for temperature:\n$$ -\\nabla \\cdot (-\\mathbf{K} \\nabla T) = f \\quad \\text{in } \\Omega $$\nThe problem specifies Dirichlet boundary conditions, where the temperature is prescribed on the boundary:\n$$ T = g \\quad \\text{on } \\partial\\Omega $$\n\nTo derive the weak form, we multiply the PDE by an arbitrary test function $v$ from a suitable space of functions (here, the Sobolev space $H_0^1(\\Omega)$ of functions that are zero on the Dirichlet boundary) and integrate over the domain $\\Omega$:\n$$ \\int_{\\Omega} (-\\nabla \\cdot \\mathbf{q}) v \\, \\mathrm{d}\\Omega = \\int_{\\Omega} f v \\, \\mathrm{d}\\Omega $$\nApplying the divergence theorem (integration by parts) to the left-hand side:\n$$ \\int_{\\Omega} (-\\nabla \\cdot \\mathbf{q}) v \\, \\mathrm{d}\\Omega = \\int_{\\Omega} \\mathbf{q} \\cdot \\nabla v \\, \\mathrm{d}\\Omega - \\int_{\\partial\\Omega} (\\mathbf{q} \\cdot \\mathbf{n}) v \\, \\mathrm{d}\\Omega $$\nSince the test function $v$ is chosen to be zero on the boundary $\\partial\\Omega$, the boundary integral vanishes. Substituting Fourier's law, $\\mathbf{q} = -\\mathbf{K} \\nabla T$, we get:\n$$ \\int_{\\Omega} (-\\mathbf{K} \\nabla T) \\cdot \\nabla v \\, \\mathrm{d}\\Omega = \\int_{\\Omega} f v \\, \\mathrm{d}\\Omega $$\nRearranging gives the standard weak formulation: Find $T \\in H^1(\\Omega)$ such that $T=g$ on $\\partial\\Omega$ and for all $v \\in H_0^1(\\Omega)$:\n$$ a(T, v) = L(v) $$\nwith the bilinear form $a(T,v)$ and linear form $L(v)$ defined as:\n$$ a(T,v) = \\int_{\\Omega} (\\nabla v)^{\\top} \\mathbf{K} (\\nabla T) \\, \\mathrm{d}\\Omega $$\n$$ L(v) = \\int_{\\Omega} f v \\, \\mathrm{d}\\Omega $$\n\nFor the Finite Element Method, we discretize the domain $\\Omega$ into a mesh of triangular elements and approximate the temperature field $T$ by a piecewise polynomial function $T_h$. Using continuous piecewise-linear ($P^1$) basis functions $N_j(\\mathbf{x})$, the approximate solution is written as a linear combination:\n$$ T_h(\\mathbf{x}) = \\sum_{j=1}^{N_{nodes}} T_j N_j(\\mathbf{x}) $$\nwhere $T_j$ are the unknown temperature values at the mesh nodes $j$. We use the same basis functions for the test functions (Galerkin method), $v_h = \\sum_{i=1}^{N_{nodes}} c_i N_i(\\mathbf{x})$. Substituting these into the weak form leads to a system of linear equations $\\mathbf{K}_{global} \\mathbf{T} = \\mathbf{F}$, where $\\mathbf{T}$ is the vector of nodal temperatures.\n\nThe entries of the global stiffness matrix $\\mathbf{K}_{global}$ and load vector $\\mathbf{F}$ are assembled from element-level contributions:\n$$ (\\mathbf{K}_{global})_{ij} = a(N_j, N_i) = \\int_{\\Omega} (\\nabla N_i)^{\\top} \\mathbf{K} (\\nabla N_j) \\, \\mathrm{d}\\Omega $$\n$$ (\\mathbf{F})_i = L(N_i) = \\int_{\\Omega} f N_i \\, \\mathrm{d}\\Omega $$\nFor a single triangular element $\\Omega_e$ with nodes $1, 2, 3$, the linear basis functions $N_k^e$ have constant gradients $\\nabla N_k^e$ over the element. The element stiffness matrix $\\mathbf{k}^e$ has entries:\n$$ k_{ij}^e = \\int_{\\Omega_e} (\\nabla N_i^e)^{\\top} \\mathbf{K} (\\nabla N_j^e) \\, \\mathrm{d}\\Omega_e = ((\\nabla N_i^e)^{\\top} \\mathbf{K} (\\nabla N_j^e)) A_e $$\nwhere $A_e$ is the area of the element. This can be written in matrix form as $\\mathbf{k}^e = A_e (\\mathbf{B}^e)^{\\top} \\mathbf{K} \\mathbf{B}^e$, where $\\mathbf{B}^e$ is the $2 \\times 3$ matrix whose columns are the gradients $\\nabla N_k^e$.\n\nThe problem states to use single-point centroid quadrature. The element load vector $\\mathbf{f}^e$ is:\n$$ f_i^e = \\int_{\\Omega_e} f N_i^e \\, \\mathrm{d}\\Omega_e \\approx f(\\mathbf{x}_c^e) N_i^e(\\mathbf{x}_c^e) A_e $$\nAt the centroid $\\mathbf{x}_c^e$ of a linear triangle, $N_i^e(\\mathbf{x}_c^e) = 1/3$ for all three nodes $i$. Thus:\n$$ f_i^e \\approx \\frac{A_e}{3} f(\\mathbf{x}_c^e) $$\n\nThe manufactured solution is $T(x,y) = \\sin(\\pi x)\\sin(\\pi y)$ on $\\Omega = [0,1]^2$. The boundary conditions are homogeneous Dirichlet since $T=0$ on $\\partial\\Omega$. The source term $f$ is derived by substituting $T$ into the strong form:\n$$ \\nabla T = \\begin{pmatrix} \\pi \\cos(\\pi x)\\sin(\\pi y) \\\\ \\pi \\sin(\\pi x)\\cos(\\pi y) \\end{pmatrix} $$\n$$ f = -\\nabla \\cdot (-\\mathbf{K} \\nabla T) = \\nabla \\cdot (\\mathbf{K} \\nabla T) $$\nFor a constant diagonal tensor $\\mathbf{K} = \\mathrm{diag}(K_{xx}, K_{yy})$, the flux is $\\mathbf{q} = -\\mathbf{K}\\nabla T = \\begin{pmatrix} -K_{xx} \\pi \\cos(\\pi x)\\sin(\\pi y) \\\\ -K_{yy} \\pi \\sin(\\pi x)\\cos(\\pi y) \\end{pmatrix}$.\nThe source term becomes:\n$$ f = \\frac{\\partial}{\\partial x}(K_{xx} \\pi \\cos(\\pi x)\\sin(\\pi y)) + \\frac{\\partial}{\\partial y}(K_{yy} \\pi \\sin(\\pi x)\\cos(\\pi y)) $$\n$$ f(x,y) = -K_{xx} \\pi^2 \\sin(\\pi x)\\sin(\\pi y) - K_{yy} \\pi^2 \\sin(\\pi x)\\sin(\\pi y) = (K_{xx} + K_{yy})\\pi^2 \\sin(\\pi x)\\sin(\\pi y) $$\nThis function $f$ is used to compute the load vector.\n\nAfter solving the linear system for the interior nodal temperatures $T_h$, we perform post-processing.\nThe discrete flux $\\mathbf{q}_h^e$ on each element $e$ is constant:\n$$ \\mathbf{q}_h^e = -\\mathbf{K} \\nabla T_h^e = -\\mathbf{K} \\sum_{i=1}^3 T_i^e \\nabla N_i^e $$\n\nFor Superconvergent Patch Recovery (SPR), for each vertex $v$ of the mesh, we construct a patch of elements sharing that vertex. We sample the discrete flux components $(\\mathbf{q}_h)_x$ and $(\\mathbf{q}_h)_y$ at the centroid of each element in the patch. For each component, we find a linear polynomial $\\tilde{p}(x,y) = a_0 + a_1 x + a_2 y$ that best fits the sampled values in a least-squares sense. This involves solving a linear system $\\mathbf{A}\\mathbf{c}=\\mathbf{b}$ for the coefficients $\\mathbf{c}=(a_0, a_1, a_2)^{\\top}$, where $\\mathbf{A}$ contains the polynomial basis functions evaluated at the centroids. If this system is underdetermined (i.e., $\\mathrm{rank}(\\mathbf{A}) < 3$), the recovered value at the vertex is the average of the sampled component values in the patch. Otherwise, the recovered value is $\\tilde{p}(x_v, y_v)$. This gives a recovered flux vector $\\tilde{\\mathbf{q}}_v$ at each node $v$. The recovered flux field $\\tilde{\\mathbf{q}}$ is then interpolated over each element using the linear basis functions:\n$$ \\tilde{\\mathbf{q}}(\\mathbf{x}) = \\sum_{i=1}^3 \\tilde{\\mathbf{q}}_i N_i^e(\\mathbf{x}) \\quad \\text{for } \\mathbf{x} \\in \\Omega_e $$\n\nFinally, we compute the error quantities using centroid quadrature.\n1.  **Energy Norm of Exact Solution**:\n    $$ \\lVert T \\rVert_E^2 = \\int_{\\Omega} \\nabla T^{\\top}\\mathbf{K}\\nabla T \\, \\mathrm{d}\\Omega \\approx \\sum_{e \\in \\mathcal{T}_h} (\\nabla T(\\mathbf{x}_c^e))^{\\top}\\mathbf{K}(\\nabla T(\\mathbf{x}_c^e)) A_e $$\n2.  **Exact Energy-Norm Error**:\n    $$ \\lVert T - T_h \\rVert_E^2 = \\int_{\\Omega} (\\nabla T - \\nabla T_h)^{\\top}\\mathbf{K}(\\nabla T - \\nabla T_h) \\, \\mathrm{d}\\Omega \\approx \\sum_{e \\in \\mathcal{T}_h} (\\nabla T(\\mathbf{x}_c^e) - \\nabla T_h^e)^{\\top}\\mathbf{K}(\\nabla T(\\mathbf{x}_c^e) - \\nabla T_h^e) A_e $$\n3.  **Zienkiewicz-Zhu Estimator**:\n    $$ \\eta^2 = \\int_{\\Omega} (\\tilde{\\mathbf{q}} - \\mathbf{q}_h)^{\\top}\\mathbf{K}^{-1}(\\tilde{\\mathbf{q}} - \\mathbf{q}_h) \\, \\mathrm{d}\\Omega \\approx \\sum_{e \\in \\mathcal{T}_h} (\\tilde{\\mathbf{q}}(\\mathbf{x}_c^e) - \\mathbf{q}_h^e)^{\\top}\\mathbf{K}^{-1}(\\tilde{\\mathbf{q}}(\\mathbf{x}_c^e) - \\mathbf{q}_h^e) A_e $$\n    where $\\tilde{\\mathbf{q}}(\\mathbf{x}_c^e) = \\frac{1}{3}\\sum_{i=1}^3 \\tilde{\\mathbf{q}}_i$ for element $e$ with vertices $i=1,2,3$.\n\nThe final reported values are the relative error $\\lVert T-T_h \\rVert_E / \\lVert T \\rVert_E$, the relative estimator $\\eta / \\lVert T \\rVert_E$, and the effectivity index $\\eta / \\lVert T-T_h \\rVert_E$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_fem_spr(Nx, Ny, K_tensor):\n    \"\"\"\n    Solves the 2D steady-state heat conduction problem using FEM and SPR.\n    \"\"\"\n    \n    # 1. Mesh Generation\n    num_nodes_x = Nx + 1\n    num_nodes_y = Ny + 1\n    num_nodes = num_nodes_x * num_nodes_y\n    num_rects = Nx * Ny\n    num_elems = 2 * num_rects\n\n    dx = 1.0 / Nx\n    dy = 1.0 / Ny\n    \n    nodes = np.zeros((num_nodes, 2))\n    for j in range(num_nodes_y):\n        for i in range(num_nodes_x):\n            node_idx = j * num_nodes_x + i\n            nodes[node_idx] = [i * dx, j * dy]\n\n    elements = np.zeros((num_elems, 3), dtype=int)\n    elem_idx = 0\n    for j in range(Ny):\n        for i in range(Nx):\n            n1 = j * num_nodes_x + i       # bottom-left\n            n2 = j * num_nodes_x + i + 1   # bottom-right\n            n3 = (j + 1) * num_nodes_x + i # top-left\n            n4 = (j + 1) * num_nodes_x + i + 1 # top-right\n            \n            # Triangle 1 from descending diagonal (n3 -> n2)\n            elements[elem_idx] = [n1, n2, n3]\n            elem_idx += 1\n            # Triangle 2\n            elements[elem_idx] = [n2, n4, n3]\n            elem_idx += 1\n\n    # 2. Identify boundary and interior nodes\n    boundary_nodes = set()\n    for j in range(num_nodes_y):\n        for i in range(num_nodes_x):\n            if i == 0 or i == Nx or j == 0 or j == Ny:\n                boundary_nodes.add(j * num_nodes_x + i)\n    \n    interior_nodes = sorted(list(set(range(num_nodes)) - boundary_nodes))\n    node_map = {node_idx: i for i, node_idx in enumerate(interior_nodes)}\n    \n    # 3. Assemble Global Stiffness Matrix and Load Vector\n    num_interior = len(interior_nodes)\n    K_global = np.zeros((num_interior, num_interior))\n    F_global = np.zeros(num_interior)\n\n    # Manufactured solution and source term\n    T_exact_func = lambda x, y: np.sin(np.pi * x) * np.sin(np.pi * y)\n    f_func = lambda x, y, K: (K[0,0] + K[1,1]) * np.pi**2 * T_exact_func(x,y)\n\n    for el_nodes in elements:\n        v1, v2, v3 = nodes[el_nodes]\n        \n        # Element geometry\n        area = 0.5 * np.abs(v1[0]*(v2[1] - v3[1]) + v2[0]*(v3[1] - v1[1]) + v3[0]*(v1[1] - v2[1]))\n        \n        # Gradients of shape functions (B matrix)\n        B = np.zeros((2, 3))\n        b = np.array([v2[1] - v3[1], v3[1] - v1[1], v1[1] - v2[1]])\n        c = np.array([v3[0] - v2[0], v1[0] - v3[0], v2[0] - v1[0]])\n        B[0, :] = b / (2 * area)\n        B[1, :] = c / (2 * area)\n\n        # Element stiffness matrix\n        k_elem = area * B.T @ K_tensor @ B\n\n        # Element load vector (centroid quadrature)\n        centroid = (v1 + v2 + v3) / 3.0\n        f_val = f_func(centroid[0], centroid[1], K_tensor)\n        f_elem = (area / 3.0) * f_val * np.ones(3)\n\n        # Assembly into global system for interior nodes\n        for i in range(3):\n            node_i = el_nodes[i]\n            if node_i in interior_nodes:\n                map_i = node_map[node_i]\n                F_global[map_i] += f_elem[i]\n                for j in range(3):\n                    node_j = el_nodes[j]\n                    if node_j in interior_nodes:\n                        map_j = node_map[node_j]\n                        K_global[map_i, map_j] += k_elem[i, j]\n\n    # 4. Solve system and reconstruct full solution vector\n    T_interior = np.linalg.solve(K_global, F_global)\n    T_h = np.zeros(num_nodes)\n    for i, node_idx in enumerate(interior_nodes):\n        T_h[node_idx] = T_interior[i]\n\n    # 5. Compute discrete flux q_h\n    elem_flux_h = np.zeros((num_elems, 2))\n    elem_centroids = np.zeros((num_elems, 2))\n    elem_areas = np.zeros(num_elems)\n    grad_Th_elems = np.zeros((num_elems, 2))\n\n    for i, el_nodes in enumerate(elements):\n        v1, v2, v3 = nodes[el_nodes]\n        area = 0.5 * np.abs(v1[0]*(v2[1] - v3[1]) + v2[0]*(v3[1] - v1[1]) + v3[0]*(v1[1] - v2[1]))\n        elem_areas[i] = area\n        elem_centroids[i] = (v1 + v2 + v3) / 3.0\n        \n        b = np.array([v2[1] - v3[1], v3[1] - v1[1], v1[1] - v2[1]])\n        c = np.array([v3[0] - v2[0], v1[0] - v3[0], v2[0] - v1[0]])\n        B_elem = np.vstack((b, c)) / (2 * area)\n        \n        T_h_elem = T_h[el_nodes]\n        grad_Th_elems[i] = B_elem @ T_h_elem\n        elem_flux_h[i] = -K_tensor @ grad_Th_elems[i]\n\n    # 6. Superconvergent Patch Recovery (SPR)\n    node_patches = {i: [] for i in range(num_nodes)}\n    for i, el_nodes in enumerate(elements):\n        for node_idx in el_nodes:\n            node_patches[node_idx].append(i)\n\n    q_recovered = np.zeros((num_nodes, 2))\n    for i in range(num_nodes):\n        patch_elem_indices = node_patches[i]\n        patch_fluxes = elem_flux_h[patch_elem_indices]\n        patch_centroids = elem_centroids[patch_elem_indices]\n        \n        m = len(patch_elem_indices)\n        A = np.ones((m, 3))\n        A[:, 1:] = patch_centroids\n        \n        is_underdetermined = np.linalg.matrix_rank(A) < 3\n\n        for comp in range(2): # for qx and qy\n            b = patch_fluxes[:, comp]\n            if is_underdetermined:\n                # Fallback to average\n                q_recovered[i, comp] = np.mean(b)\n            else:\n                # Least squares fit\n                coeffs, _, _, _ = np.linalg.lstsq(A, b, rcond=None)\n                node_coord = nodes[i]\n                q_recovered[i, comp] = coeffs[0] + coeffs[1]*node_coord[0] + coeffs[2]*node_coord[1]\n    \n    # 7. Error Estimation\n    grad_T_exact_func = lambda x, y: np.array([\n        np.pi * np.cos(np.pi * x) * np.sin(np.pi * y),\n        np.pi * np.sin(np.pi * x) * np.cos(np.pi * y)\n    ])\n    \n    K_inv = np.linalg.inv(K_tensor)\n    \n    exact_energy_sq = 0.0\n    error_energy_sq = 0.0\n    eta_sq = 0.0\n\n    for i, el_nodes in enumerate(elements):\n        centroid = elem_centroids[i]\n        area = elem_areas[i]\n        \n        grad_T_exact = grad_T_exact_func(centroid[0], centroid[1])\n        grad_T_h = grad_Th_elems[i]\n        \n        # Energy norm of exact solution\n        exact_energy_sq += (grad_T_exact.T @ K_tensor @ grad_T_exact) * area\n        \n        # Energy norm of error\n        error_grad = grad_T_exact - grad_T_h\n        error_energy_sq += (error_grad.T @ K_tensor @ error_grad) * area\n        \n        # ZZ Estimator\n        q_h_at_centroid = elem_flux_h[i]\n        recovered_node_fluxes = q_recovered[el_nodes]\n        q_rec_at_centroid = np.mean(recovered_node_fluxes, axis=0)\n        flux_diff = q_rec_at_centroid - q_h_at_centroid\n        eta_sq += (flux_diff.T @ K_inv @ flux_diff) * area\n        \n    exact_energy_norm = np.sqrt(exact_energy_sq)\n    error_energy_norm = np.sqrt(error_energy_sq)\n    eta = np.sqrt(eta_sq)\n    \n    rel_error = error_energy_norm / exact_energy_norm\n    rel_estimator = eta / exact_energy_norm\n    effectivity = eta / error_energy_norm if error_energy_norm > 1e-12 else 0.0\n\n    return [rel_error, rel_estimator, effectivity]\n\n\ndef solve():\n    test_cases = [\n        (4, 4, np.array([[1.0, 0.0], [0.0, 1.0]])),\n        (8, 8, np.array([[1.0, 0.0], [0.0, 1.0]])),\n        (8, 8, np.array([[10.0, 0.0], [0.0, 1.0]]))\n    ]\n\n    results = []\n    for case in test_cases:\n        Nx, Ny, K_tensor = case\n        result_triple = solve_fem_spr(Nx, Ny, K_tensor)\n        results.append(result_triple)\n\n    # Format output as a list of lists of floats\n    output_str = \"[\" + \",\".join([f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "2599230"}]}