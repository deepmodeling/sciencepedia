{"hands_on_practices": [{"introduction": "Proficiency in analyzing multicomponent systems begins with the fundamental ability to interconvert between mass-based and mole-based descriptions of composition. This exercise challenges you to build the conversion formulas from first principles, reinforcing the definitions of mole fraction $X_i$, mass fraction $Y_i$, and mixture-average molecular weight $\\bar{W}$. By applying these derived formulas to a concrete example, you will solidify your grasp on these essential tools.", "problem": "A well-mixed, non-reacting ternary gas mixture occupies a large isothermal control volume. The pure-component molecular weights are given by $W = \\{16,\\,28,\\,44\\}\\,\\mathrm{g/mol}$, and the mixture mass-fraction vector is $Y = \\{0.2,\\,0.3,\\,0.5\\}$. Starting strictly from the fundamental definitions of mass fraction $Y_i \\equiv m_i/m$, mole fraction $X_i \\equiv n_i/n$, and mixture-average molecular weight $\\bar W \\equiv m/n$ (with $m_i$ the mass of species $i$, $m$ the total mass, $n_i$ the moles of species $i$, and $n$ the total moles), derive expressions that relate $\\bar W$ and the mole fractions $X_i$ to the known sets $\\{W_i\\}$ and $\\{Y_i\\}$. Then evaluate these expressions for the given data.\n\nExpress the final value of the mixture-average molecular weight in $\\mathrm{g/mol}$ and the mole fractions as dimensionless decimals. Round all decimal quantities to five significant figures.\n\nYour final reported result must be a single row vector in the form $\\big(\\bar W,\\;X_1,\\;X_2,\\;X_3\\big)$.", "solution": "The task is to derive expressions for the mixture-average molecular weight, $\\bar W$, and the mole fractions, $X_i$, in terms of the given mass fractions, $Y_i$, and component molecular weights, $W_i$. We must start strictly from the provided fundamental definitions.\n\nThe given definitions are:\n1. Mass fraction of species $i$: $Y_i \\equiv \\frac{m_i}{m}$\n2. Mole fraction of species $i$: $X_i \\equiv \\frac{n_i}{n}$\n3. Mixture-average molecular weight: $\\bar W \\equiv \\frac{m}{n}$\n\nHere, $m_i$ and $n_i$ are the mass and moles of species $i$, respectively, and $m = \\sum_i m_i$ and $n = \\sum_i n_i$ are the total mass and total moles of the mixture. The relationship between mass and moles for a pure species $i$ is given by its molecular weight, $W_i$:\n$$m_i = n_i W_i \\quad \\implies \\quad n_i = \\frac{m_i}{W_i}$$\n\nFirst, we derive the expression for the mixture-average molecular weight, $\\bar W$. We start with its definition, $\\bar W = m/n$. The total moles, $n$, can be expressed as the sum of the moles of each component:\n$$n = \\sum_i n_i = \\sum_i \\frac{m_i}{W_i}$$\nFrom the definition of mass fraction, we have $m_i = Y_i m$. Substituting this into the expression for $n$:\n$$n = \\sum_i \\frac{Y_i m}{W_i} = m \\sum_i \\frac{Y_i}{W_i}$$\nNow, we substitute this result for $n$ back into the definition of $\\bar W$:\n$$\\bar W = \\frac{m}{n} = \\frac{m}{m \\sum_{i} \\frac{Y_i}{W_i}}$$\nThe total mass $m$ cancels, leading to the final expression for $\\bar W$ in terms of known quantities:\n$$\\bar W = \\frac{1}{\\sum_{i} \\frac{Y_i}{W_i}}$$\n\nNext, we derive the expressions for the mole fractions, $X_i$. We begin with the definition $X_i = n_i/n$. We can write $n_i$ and $n$ in terms of masses and molecular weights:\n$$X_i = \\frac{m_i/W_i}{m/\\bar W}$$\nRearranging this equation gives:\n$$X_i = \\left(\\frac{m_i}{m}\\right) \\frac{\\bar W}{W_i}$$\nRecognizing that the term $(m_i/m)$ is precisely the mass fraction $Y_i$, we get the desired relationship:\n$$X_i = Y_i \\frac{\\bar W}{W_i}$$\n\nNow, we perform the numerical evaluation for the given data:\nComponent molecular weights: $W_1 = 16\\,\\mathrm{g/mol}$, $W_2 = 28\\,\\mathrm{g/mol}$, $W_3 = 44\\,\\mathrm{g/mol}$.\nComponent mass fractions: $Y_1 = 0.2$, $Y_2 = 0.3$, $Y_3 = 0.5$.\n\nFirst, we calculate $\\bar W$. We evaluate the sum in the denominator:\n$$\\sum_{i} \\frac{Y_i}{W_i} = \\frac{0.2}{16} + \\frac{0.3}{28} + \\frac{0.5}{44}$$\n$$\\sum_{i} \\frac{Y_i}{W_i} = 0.0125 + 0.0107142857... + 0.0113636363... \\approx 0.034577922\\,\\mathrm{mol/g}$$\nThe mixture-average molecular weight is the reciprocal of this sum:\n$$\\bar W = \\frac{1}{0.034577922...} \\approx 28.92018779\\,\\mathrm{g/mol}$$\nRounding to five significant figures, we get:\n$$\\bar W \\approx 28.920\\,\\mathrm{g/mol}$$\n\nUsing this value of $\\bar W$ (with higher precision for intermediate calculations to avoid rounding errors), we calculate the mole fractions $X_i$:\nFor species $1$:\n$$X_1 = Y_1 \\frac{\\bar W}{W_1} = 0.2 \\times \\frac{28.92018779}{16} \\approx 0.361502347$$\nRounding to five significant figures: $X_1 \\approx 0.36150$.\n\nFor species $2$:\n$$X_2 = Y_2 \\frac{\\bar W}{W_2} = 0.3 \\times \\frac{28.92018779}{28} \\approx 0.309859154$$\nRounding to five significant figures: $X_2 \\approx 0.30986$.\n\nFor species $3$:\n$$X_3 = Y_3 \\frac{\\bar W}{W_3} = 0.5 \\times \\frac{28.92018779}{44} \\approx 0.328638497$$\nRounding to five significant figures: $X_3 \\approx 0.32864$.\n\nAs a consistency check, the sum of the mole fractions must be unity:\n$$\\sum_i X_i = 0.36150 + 0.30986 + 0.32864 = 1.00000$$\nThe results are consistent. The final values, rounded as required, are assembled into the specified row vector format.", "answer": "$$\\boxed{\\begin{pmatrix} 28.920 & 0.36150 & 0.30986 & 0.32864 \\end{pmatrix}}$$", "id": "2504316"}, {"introduction": "True understanding extends beyond rote calculation to encompass physical intuition about limiting behaviors. This practice explores a thought experiment involving a single heavy tracer species within a lighter background gas of fixed relative composition. By deriving the exact and asymptotic relationships between mass fraction $Y_i$ and mole fraction $X_i$, you will uncover the non-linear connection between these quantities and see precisely how a tiny mole fraction can correspond to a significant mass fractionâ€”an essential insight for systems involving aerosols, heavy polymers, or trace contaminants.", "problem": "A multicomponent mixture consists of a single tracer species $i$ with molar mass $W_i$ and a background of light species indexed by $j \\in \\mathcal{L}$, whose relative composition is fixed and independent of the tracer loading. Denote the mole fraction of the tracer by $X_i$ and its mass fraction by $Y_i$. For the background, define normalized mole fractions $\\xi_j$ such that $X_j = (1 - X_i)\\,\\xi_j$ for each $j \\in \\mathcal{L}$ with $\\sum_{j \\in \\mathcal{L}} \\xi_j = 1$, and define the background-average molar mass $W_{\\ell} \\equiv \\sum_{j \\in \\mathcal{L}} \\xi_j W_j$. Assume an ideal mixture (no volume change on mixing) and standard mass-based and mole-based concentration definitions.\n\nStarting only from the fundamental definitions of mole fraction and mass fraction,\n- the mole fraction $X_i$ is $X_i = n_i/\\sum_k n_k$ where $n_k$ is the amount of substance of species $k$,\n- the mass fraction $Y_i$ is $Y_i = m_i/\\sum_k m_k$ with $m_k = n_k W_k$,\n\nderive an exact algebraic relation between $Y_i$ and $X_i$ in terms of $W_i$ and $W_{\\ell}$ for this class of mixtures. Then, consider the asymptotic regime of a very heavy tracer, $W_i \\to \\infty$, while the target mass fraction $Y_i \\in (0,1)$ is held fixed and the background composition $\\{\\xi_j\\}$ (hence $W_{\\ell}$) is fixed. Obtain the leading-order asymptotic expression for the mole fraction $X_i$ required to achieve this fixed $Y_i$ as a function of $W_i$, $W_{\\ell}$, and $Y_i$.\n\nExpress your final result as a closed-form leading-order asymptotic expression for $X_i$ in terms of $Y_i$, $W_{\\ell}$, and $W_i$. No units are required since $X_i$ and $Y_i$ are dimensionless. No rounding is needed; provide an exact symbolic expression.", "solution": "**Derivation of the Exact Relation**\n\nWe begin with the fundamental definition of the mass fraction of species $i$, $Y_i$:\n$$Y_i = \\frac{m_i}{\\sum_{k} m_k}$$\nwhere the sum is over all species in the mixture. This sum can be separated into the contribution from the tracer species $i$ and the background species $j \\in \\mathcal{L}$:\n$$Y_i = \\frac{m_i}{m_i + \\sum_{j \\in \\mathcal{L}} m_j}$$\nThe mass $m_k$ of any species $k$ is related to its amount of substance $n_k$ and molar mass $W_k$ by $m_k = n_k W_k$. Substituting this relation yields:\n$$Y_i = \\frac{n_i W_i}{n_i W_i + \\sum_{j \\in \\mathcal{L}} n_j W_j}$$\nTo introduce mole fractions, we divide the numerator and the denominator by the total amount of substance in the mixture, $N_{\\text{tot}} = \\sum_k n_k = n_i + \\sum_{j \\in \\mathcal{L}} n_j$. This gives:\n$$Y_i = \\frac{\\frac{n_i}{N_{\\text{tot}}} W_i}{\\frac{n_i}{N_{\\text{tot}}} W_i + \\sum_{j \\in \\mathcal{L}} \\frac{n_j}{N_{\\text{tot}}} W_j}$$\nBy definition, the mole fraction of species $k$ is $X_k = n_k/N_{\\text{tot}}$. The expression becomes:\n$$Y_i = \\frac{X_i W_i}{X_i W_i + \\sum_{j \\in \\mathcal{L}} X_j W_j}$$\nThe sum in the denominator represents the contribution of the background species to the average molar mass of the mixture. We use the given relation for the background mole fractions, $X_j = (1-X_i)\\xi_j$, to evaluate this sum:\n$$\\sum_{j \\in \\mathcal{L}} X_j W_j = \\sum_{j \\in \\mathcal{L}} (1-X_i)\\xi_j W_j$$\nSince $(1-X_i)$ is constant with respect to the summation index $j$, it can be factored out:\n$$\\sum_{j \\in \\mathcal{L}} X_j W_j = (1-X_i) \\sum_{j \\in \\mathcal{L}} \\xi_j W_j$$\nThe remaining sum is, by definition, the background-average molar mass, $W_{\\ell} = \\sum_{j \\in \\mathcal{L}} \\xi_j W_j$. Therefore:\n$$\\sum_{j \\in \\mathcal{L}} X_j W_j = (1-X_i) W_{\\ell}$$\nSubstituting this result back into the expression for $Y_i$, we obtain the first required result: the exact algebraic relation between $Y_i$ and $X_i$.\n$$Y_i = \\frac{X_i W_i}{X_i W_i + (1-X_i) W_{\\ell}}$$\n\n**Asymptotic Analysis for Heavy Tracer**\n\nFor the second part of the problem, we must find the leading-order asymptotic expression for $X_i$ in the limit $W_i \\to \\infty$, while $Y_i \\in (0,1)$ and $W_{\\ell}$ are held fixed. It is first necessary to solve the derived relation for $X_i$:\n$$Y_i (X_i W_i + (1-X_i) W_{\\ell}) = X_i W_i$$\n$$Y_i X_i W_i + Y_i W_{\\ell} - Y_i X_i W_{\\ell} = X_i W_i$$\nCollect all terms containing $X_i$ on one side of the equation:\n$$Y_i W_{\\ell} = X_i W_i - Y_i X_i W_i + Y_i X_i W_{\\ell}$$\nFactor out $X_i$:\n$$Y_i W_{\\ell} = X_i (W_i - Y_i W_i + Y_i W_{\\ell})$$\n$$Y_i W_{\\ell} = X_i (W_i(1-Y_i) + Y_i W_{\\ell})$$\nThis yields the exact expression for $X_i$ as a function of $Y_i$:\n$$X_i = \\frac{Y_i W_{\\ell}}{W_i(1-Y_i) + Y_i W_{\\ell}}$$\nWe now analyze the behavior of this expression as $W_i \\to \\infty$. The parameters $Y_i$ and $W_{\\ell}$ are constants in this limit. Since $Y_i \\in (0,1)$, the term $(1-Y_i)$ is a positive constant. The denominator is a sum of two terms: $W_i(1-Y_i)$ and $Y_i W_{\\ell}$. As $W_i$ becomes arbitrarily large, the first term, which is proportional to $W_i$, will dominate the second term, which is constant.\n$$W_i(1-Y_i) \\gg Y_i W_{\\ell} \\quad \\text{as} \\quad W_i \\to \\infty$$\nTherefore, for the leading-order asymptotic behavior, we can neglect the constant term $Y_i W_{\\ell}$ in the denominator:\n$$X_i \\sim \\frac{Y_i W_{\\ell}}{W_i(1-Y_i)} \\quad \\text{as} \\quad W_i \\to \\infty$$\nThis expression can be rewritten to clearly show the dependence on the ratio of molar masses:\n$$X_i \\sim \\frac{W_{\\ell}}{W_i} \\frac{Y_i}{1-Y_i}$$\nThis is the required leading-order asymptotic expression for the mole fraction $X_i$. It correctly shows that to maintain a non-zero mass fraction $Y_i$ with an increasingly heavy tracer ($W_i \\to \\infty$), the required mole fraction $X_i$ must approach zero as $1/W_i$.", "answer": "$$\n\\boxed{\\frac{Y_i W_{\\ell}}{W_i(1-Y_i)}}\n$$", "id": "2504362"}, {"introduction": "In the world of computational modeling, theoretical correctness is not enough; algorithms must also be numerically robust. This hands-on coding challenge reveals how a seemingly straightforward conversion from mole to mass fractions can produce unphysical results, such as a calculated mass fraction $\\widehat{Y}_m \\lt 0$, due to the subtle interplay of floating-point arithmetic and rounding errors. By diagnosing the failure of a naive algorithm and implementing a principled fix using projection onto the probability simplex, you will gain critical skills in developing reliable scientific software.", "problem": "You are given the fundamental definitions of composition measures in multicomponent systems. For a mixture of $m$ species with mole fractions $X_i$ and molecular weights $W_i$ (with $W_i > 0$ for all $i$), the mixture-averaged molecular weight is defined by\n$$\n\\bar W \\equiv \\sum_{i=1}^m X_i W_i,\n$$\nand the mass fractions $Y_i$ are defined by\n$$\nY_i \\equiv \\frac{X_i W_i}{\\bar W}.\n$$\nConversely, given mass fractions $Y_i$ and molecular weights $W_i$, the mole fractions are given by\n$$\nX_i \\equiv \\frac{Y_i/W_i}{\\sum_{j=1}^m Y_j/W_j}.\n$$\nBoth $\\{X_i\\}$ and $\\{Y_i\\}$ must satisfy $X_i \\ge 0$, $Y_i \\ge 0$ for all $i$, and $\\sum_i X_i = \\sum_i Y_i = 1$.\n\nA naive implementation that converts from mole fractions $\\{X_i\\}$ to mass fractions $\\{Y_i\\}$ sometimes adopts the following sequence, motivated by fixed-point formats or attempts to reduce computation:\n- Compute $\\bar W$.\n- Round $\\bar W$ to $p$ significant digits to obtain $\\widehat{\\bar W}$.\n- Compute $\\widehat Y_i \\leftarrow \\frac{X_i W_i}{\\widehat{\\bar W}}$ for all $i$.\n- Round each $\\widehat Y_i$ to $q$ decimal places for $i=1,\\dots,m-1$.\n- Enforce the summation constraint by setting the last component as the remainder: $\\widehat Y_m \\leftarrow 1 - \\sum_{i=1}^{m-1} \\widehat Y_i$ (with no further rounding).\n\nUnfortunately, due to the rounding of $\\bar W$, this naive pipeline can produce $\\widehat Y_m < 0$ even when the input $\\{X_i\\}$ are perfectly valid.\n\nTask:\n1. Starting from the above definitions and logic, derive why rounding $\\bar W$ to a smaller value than the true $\\bar W$ amplifies all computed $\\widehat Y_i$ multiplicatively and can, when combined with independent rounding of the first $m-1$ components and the remainder rule for the last component, force $\\widehat Y_m$ to become negative.\n2. Propose and implement a positivity-preserving fix that avoids this pathology while still allowing rounding to $q$ decimal places. Your fix must be derived from first principles and must ensure both nonnegativity and exact summation to one. One mathematically sound approach is to:\n   - First compute unrounded numerators $\\tilde Y_i \\equiv X_i W_i$ in full precision and normalize them to obtain $Y_i^\\ast \\equiv \\tilde Y_i / \\sum_{j=1}^m \\tilde Y_j$.\n   - Round $Y_i^\\ast$ independently to $q$ decimal places to obtain a vector $v$.\n   - Project $v$ onto the probability simplex $\\Delta \\equiv \\{ y \\in \\mathbb{R}^m \\mid \\sum_{i=1}^m y_i = 1,\\ y_i \\ge 0\\}$ using the Euclidean projection, yielding $Y^{\\mathrm{fix}}$ that satisfies the constraints by construction.\n   - You must describe the projection operator used.\n\nImplementation Requirements:\n- Write a program that implements two converters:\n  - A naive converter $\\mathcal{C}_{\\mathrm{naive}}(X,W,p,q)$ implementing the pipeline above (round $\\bar W$ to $p$ significant digits, compute and round the first $m-1$ mass fractions to $q$ decimals, and set the last as the remainder).\n  - A fixed converter $\\mathcal{C}_{\\mathrm{fix}}(X,W,q)$ implementing the normalization of $\\tilde Y_i \\equiv X_i W_i$ and the Euclidean projection of the $q$-decimally rounded vector onto $\\Delta$.\n- For each test case, your program must report, in order: an integer indicating whether any component from the naive conversion is negative ($1$ if any $\\widehat Y_i < 0$, else $0$), an integer indicating the same for the fixed conversion, the minimum component value of the naive result, and the minimum component value of the fixed result.\n\nTest Suite:\n- Use the following test cases. In all cases, compute the mole fractions $X_i$ from the provided target mass fractions $Y_i^{\\mathrm{target}}$ and molecular weights $W_i$ by the definition\n$$\nX_i \\equiv \\frac{Y_i^{\\mathrm{target}}/W_i}{\\sum_{j=1}^m Y_j^{\\mathrm{target}}/W_j}.\n$$\nThen apply both converters to these $X_i$ and $W_i$ with the specified $p$ and $q$.\n\nLet $m$ denote the number of species in each case.\n\n- Case A (counterexample expected to fail naively):\n  - Molecular weights: $W = [90,\\ 110,\\ 120,\\ 300]$.\n  - Target mass fractions: $Y^{\\mathrm{target}} = \\left[\\frac{1 - \\varepsilon}{3},\\ \\frac{1 - \\varepsilon}{3},\\ \\frac{1 - \\varepsilon}{3},\\ \\varepsilon\\right]$ with $\\varepsilon = 10^{-4}$.\n  - Rounding parameters: $p = 1$ significant digit for $\\bar W$ and $q = 2$ decimal places for mass fractions.\n\n- Case B (high-precision rounding; naive expected to be safe):\n  - Molecular weights: $W = [90,\\ 110,\\ 120,\\ 300]$.\n  - Target mass fractions: $Y^{\\mathrm{target}} = \\left[\\frac{1 - \\varepsilon}{3},\\ \\frac{1 - \\varepsilon}{3},\\ \\frac{1 - \\varepsilon}{3},\\ \\varepsilon\\right]$ with $\\varepsilon = 10^{-4}$.\n  - Rounding parameters: $p = 5$ significant digits for $\\bar W$ and $q = 4$ decimal places for mass fractions.\n\n- Case C (typical gas mixture; naive expected to be safe):\n  - Molecular weights: $W = [2.016,\\ 28.014,\\ 31.998,\\ 44.01]$.\n  - Target mass fractions: $Y^{\\mathrm{target}} = [0.7,\\ 0.1,\\ 0.1,\\ 0.1]$.\n  - Rounding parameters: $p = 1$ significant digit for $\\bar W$ and $q = 2$ decimal places for mass fractions.\n\nOutput Specification:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case must contribute a sublist of four numbers in the order: $\\left[\\text{neg\\_naive},\\ \\text{neg\\_fix},\\ \\min(\\widehat Y),\\ \\min(Y^{\\mathrm{fix}})\\right]$. Use integers for the first two entries and real numbers for the last two entries. The final line must be of the form\n$$\n[\\ [a_1,b_1,c_1,d_1],\\ [a_2,b_2,c_2,d_2],\\ [a_3,b_3,c_3,d_3]\\ ]\n$$\nwith no additional text.", "solution": "The task is twofold: first, to provide a theoretical analysis of a naive numerical algorithm for converting mole fractions to mass fractions that can produce unphysical negative results; second, to propose, derive, and implement a robust algorithm that corrects this pathology.\n\n**Part 1: Analysis of the Naive Conversion Algorithm's Failure Mode**\n\nThe definitions provided are standard. For a mixture of $m$ species with mole fractions $\\{X_i\\}_{i=1}^m$ and molecular weights $\\{W_i\\}_{i=1}^m$, the true mean molecular weight is $\\bar{W} = \\sum_{i=1}^m X_i W_i$. The true mass fractions are given by $Y_i = \\frac{X_i W_i}{\\bar{W}}$. By definition, these true mass fractions are non-negative ($Y_i \\ge 0$ as $X_i \\ge 0$ and $W_i > 0$) and sum to unity ($\\sum_{i=1}^m Y_i = \\frac{\\sum_{i=1}^m X_i W_i}{\\bar{W}} = \\frac{\\bar{W}}{\\bar{W}} = 1$).\n\nThe naive algorithm introduces several rounding steps that break these properties. Let us analyze its sequence:\n1.  The true mean molecular weight $\\bar{W}$ is computed and then rounded to $p$ significant digits, yielding $\\widehat{\\bar{W}}$.\n2.  Intermediate mass fractions, which we denote $\\widehat{Y}_i'$, are computed using this rounded denominator: $\\widehat{Y}_i' = \\frac{X_i W_i}{\\widehat{\\bar{W}}}$.\n3.  The first $m-1$ final components, $\\widehat{Y}_i$ for $i=1, \\dots, m-1$, are obtained by rounding $\\widehat{Y}_i'$ to $q$ decimal places.\n4.  The final component $\\widehat{Y}_m$ is computed as the remainder: $\\widehat{Y}_m = 1 - \\sum_{i=1}^{m-1} \\widehat{Y}_i$.\n\nThe critical flaw originates from the first step. Let us relate the intermediate fractions $\\widehat{Y}_i'$ to the true fractions $Y_i$:\n$$\n\\widehat{Y}_i' = \\frac{X_i W_i}{\\widehat{\\bar{W}}} = \\left(\\frac{X_i W_i}{\\bar{W}}\\right) \\left(\\frac{\\bar{W}}{\\widehat{\\bar{W}}}\\right) = Y_i \\left(\\frac{\\bar{W}}{\\widehat{\\bar{W}}}\\right)\n$$\nThis equation reveals that the intermediate fractions $\\widehat{Y}_i'$ are the true fractions $Y_i$ scaled by a common multiplicative factor $k = \\frac{\\bar{W}}{\\widehat{\\bar{W}}}$.\n\nThe pathology described in the problem arises specifically when $\\bar{W}$ is rounded down, which means $\\widehat{\\bar{W}} < \\bar{W}$. In this scenario, the scaling factor $k$ is greater than $1$. Consequently, every intermediate mass fraction $\\widehat{Y}_i'$ is systematically inflated relative to its true value $Y_i$.\n\nThe sum of these inflated intermediate fractions is:\n$$\n\\sum_{i=1}^m \\widehat{Y}_i' = \\sum_{i=1}^m Y_i \\left(\\frac{\\bar{W}}{\\widehat{\\bar{W}}}\\right) = \\left(\\frac{\\bar{W}}{\\widehat{\\bar{W}}}\\right) \\sum_{i=1}^m Y_i = \\frac{\\bar{W}}{\\widehat{\\bar{W}}} > 1\n$$\nThe sum of the first $m-1$ inflated components is therefore $\\sum_{i=1}^{m-1} \\widehat{Y}_i' = (\\frac{\\bar{W}}{\\widehat{\\bar{W}}}) \\sum_{i=1}^{m-1} Y_i = (\\frac{\\bar{W}}{\\widehat{\\bar{W}}})(1 - Y_m)$.\n\nThe algorithm then rounds these first $m-1$ inflated values, $\\widehat{Y}_i'$ for $i=1, \\dots, m-1$, to $q$ decimal places. Let this operation be denoted by $\\text{round}(\\cdot, q)$. The sum used to compute the remainder is $S_{m-1} = \\sum_{i=1}^{m-1} \\text{round}(\\widehat{Y}_i', q)$.\n\nThe final component is $\\widehat{Y}_m = 1 - S_{m-1}$. A negative value for $\\widehat{Y}_m$ occurs if and only if $S_{m-1} > 1$.\n\nThis is most likely to happen when two conditions are met:\n1.  The inflation factor $k = \\bar{W}/\\widehat{\\bar{W}}$ is significantly greater than $1$.\n2.  The true mass fraction of the last component, $Y_m$, is very small.\n\nIf $Y_m$ is small (e.g., $Y_m \\ll 1$), then $\\sum_{i=1}^{m-1} Y_i = 1 - Y_m$ is very close to $1$. The sum of the inflated intermediate components, $\\sum_{i=1}^{m-1} \\widehat{Y}_i'$, becomes approximately $k = \\bar{W}/\\widehat{\\bar{W}}$, which is greater than $1$. The subsequent rounding to $q$ decimal places acts on each inflated term. While rounding can either increase or decrease a value, if the $\\widehat{Y}_i'$ values are sufficiently inflated, the sum $S_{m-1}$ is likely to remain greater than $1$. For instance, if the rounding operation tends to round up on average for the inflated values, the sum is pushed even further above $1$. This forces $\\widehat{Y}_m = 1 - S_{m-1}$ to be negative, which is an unphysical result.\n\n**Part 2: A Robust, Positivity-Preserving Solution**\n\nA robust algorithm must mathematically guarantee that the final mass fractions $\\{Y_i^{\\mathrm{fix}}\\}$ satisfy the constraints $Y_i^{\\mathrm{fix}} \\ge 0$ for all $i$ and $\\sum_{i=1}^m Y_i^{\\mathrm{fix}} = 1$. The naive approach fails because it enforces the summation constraint as a final, isolated step on components that have already been perturbed by multiple, uncoordinated rounding operations. A principled approach enforces constraints cohesively.\n\nThe proposed and implemented fix follows these steps:\n1.  **Compute Unrounded Numerators:** First, we compute the numerators of the mass fraction formula, $\\tilde{Y}_i = X_i W_i$, using full machine precision. These values are proportional to the mass of each species.\n2.  **Normalize to Exact Mass Fractions:** We compute the exact mass fractions, $Y_i^\\ast$, by normalizing these numerators:\n    $$\n    Y_i^\\ast = \\frac{\\tilde{Y}_i}{\\sum_{j=1}^m \\tilde{Y}_j}\n    $$\n    By construction, this vector $Y^\\ast$ of exact mass fractions satisfies $Y_i^\\ast \\ge 0$ and $\\sum_i Y_i^\\ast = 1$. This avoids the premature rounding of $\\bar{W}$ and its associated inflation error.\n3.  **Apply Rounding:** The desired rounding to $q$ decimal places is now applied to the correct mass fractions: $v_i = \\text{round}(Y_i^\\ast, q)$. The resulting vector $v$ contains the desired precision but is no longer guaranteed to sum to $1$. Its components, however, remain non-negative.\n4.  **Project onto the Probability Simplex:** To restore the summation constraint while preserving non-negativity and remaining as close as possible to the rounded values $v_i$, we project the vector $v$ onto the standard probability simplex $\\Delta^m = \\{ y \\in \\mathbb{R}^m \\mid \\sum_{i=1}^m y_i = 1, y_i \\ge 0 \\}$. This is a well-defined mathematical operation that finds the unique vector $Y^{\\mathrm{fix}} \\in \\Delta^m$ that minimizes the Euclidean distance $\\| Y^{\\mathrm{fix}} - v \\|_2$. The solution to this quadratic programming problem can be found efficiently. The projection operator is described algorithmically as follows:\n    a. Sort the components of the vector $v$ in descending order to obtain a new vector $u$, where $u_1 \\ge u_2 \\ge \\dots \\ge u_m$.\n    b. Find the integer $\\rho$ which is the largest index $j \\in \\{1, \\dots, m\\}$ satisfying the condition:\n    $$\n    u_j - \\frac{1}{j}\\left(\\sum_{k=1}^j u_k - 1\\right) > 0\n    $$\n    c. Define a threshold $\\lambda$ using this value of $\\rho$:\n    $$\n    \\lambda = \\frac{1}{\\rho}\\left(\\sum_{k=1}^\\rho u_k - 1\\right)\n    $$\n    d. The components of the projected vector $Y^{\\mathrm{fix}}$ are then obtained by a soft-thresholding operation on the original vector $v$:\n    $$\n    Y_i^{\\mathrm{fix}} = \\max(v_i - \\lambda, 0)\n    $$\nThis procedure guarantees that the resulting vector $Y^{\\mathrm{fix}}$ is the unique closest point to $v$ on the simplex, thus satisfying $Y_i^{\\mathrm{fix}} \\ge 0$ and $\\sum_i Y_i^{\\mathrm{fix}} = 1$ by construction. This method is robust because it treats the rounding as a perturbation and systematically finds the best possible valid representation.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport math\n\ndef round_sig(x, p):\n    \"\"\"\n    Rounds a number x to p significant digits.\n    \"\"\"\n    if x == 0:\n        return 0.0\n    if p <= 0:\n        raise ValueError(\"Number of significant digits must be positive.\")\n    \n    # Calculate the number of decimal places needed for rounding\n    # based on the magnitude of x.\n    num_decimals = p - int(math.floor(math.log10(abs(x)))) - 1\n    return round(x, num_decimals)\n\ndef naive_converter(X, W, p, q):\n    \"\"\"\n    Implements the naive conversion pipeline from mole fractions to mass fractions.\n    \n    Args:\n        X (np.ndarray): Mole fractions.\n        W (np.ndarray): Molecular weights.\n        p (int): Number of significant digits to round the mean molecular weight.\n        q (int): Number of decimal places to round the mass fractions.\n    \n    Returns:\n        np.ndarray: Computed mass fractions, possibly with negative components.\n    \"\"\"\n    m = len(X)\n    \n    # 1. Compute true mean molecular weight\n    W_bar_true = np.sum(X * W)\n    \n    # 2. Round W_bar_true to p significant digits\n    W_bar_hat = round_sig(W_bar_true, p)\n    \n    # 3. Compute intermediate mass fractions\n    Y_hat_unrounded = (X * W) / W_bar_hat\n    \n    Y_hat = np.zeros(m)\n    \n    # 4. Round first m-1 components\n    for i in range(m - 1):\n        Y_hat[i] = round(Y_hat_unrounded[i], q)\n        \n    # 5. Enforce summation constraint for the last component\n    Y_hat[m - 1] = 1.0 - np.sum(Y_hat[:m - 1])\n    \n    return Y_hat\n\ndef fixed_converter(X, W, q):\n    \"\"\"\n    Implements the robust conversion using normalization and projection onto the simplex.\n    \n    Args:\n        X (np.ndarray): Mole fractions.\n        W (np.ndarray): Molecular weights.\n        q (int): Number of decimal places to round the mass fractions.\n        \n    Returns:\n        np.ndarray: Positivity- and sum-preserving mass fractions.\n    \"\"\"\n    # 1. Compute unrounded numerators\n    Y_tilde = X * W\n    \n    # 2. Normalize to get exact mass fractions\n    sum_Y_tilde = np.sum(Y_tilde)\n    if sum_Y_tilde == 0:\n        return np.ones_like(X) / len(X) # Handle case of all-zero input\n    Y_star = Y_tilde / sum_Y_tilde\n    \n    # 3. Apply rounding\n    v = np.round(Y_star, q)\n    \n    # 4. Project v onto the probability simplex\n    \n    # Check if a projection is needed\n    if abs(np.sum(v) - 1.0) < 1e-9 and np.all(v >= 0):  # Use tolerance for float comparison\n        return v\n\n    m = len(v)\n    # Sort v in descending order\n    u = np.sort(v)[::-1]\n    \n    # Compute cumulative sum of sorted values\n    cssv = np.cumsum(u)\n    \n    # Find rho: the largest j such that u_j - (1/j)(sum(u_k) - 1) > 0\n    indices = np.arange(1, m + 1)\n    condition = u - (cssv - 1) / indices > 0\n    \n    # np.where returns a tuple of arrays; we get the last index where condition is True\n    rho = np.where(condition)[0][-1] + 1\n    \n    # Compute lambda\n    lambda_ = (cssv[rho - 1] - 1) / rho\n    \n    # Compute the projection\n    Y_fix = np.maximum(v - lambda_, 0)\n    \n    return Y_fix\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    epsilon = 1e-4\n    test_cases = [\n        {\n            \"name\": \"Case A\",\n            \"W\": np.array([90.0, 110.0, 120.0, 300.0]),\n            \"Y_target\": np.array([(1 - epsilon) / 3, (1 - epsilon) / 3, (1 - epsilon) / 3, epsilon]),\n            \"p\": 1,\n            \"q\": 2\n        },\n        {\n            \"name\": \"Case B\",\n            \"W\": np.array([90.0, 110.0, 120.0, 300.0]),\n            \"Y_target\": np.array([(1 - epsilon) / 3, (1 - epsilon) / 3, (1 - epsilon) / 3, epsilon]),\n            \"p\": 5,\n            \"q\": 4\n        },\n        {\n            \"name\": \"Case C\",\n            \"W\": np.array([2.016, 28.014, 31.998, 44.01]),\n            \"Y_target\": np.array([0.7, 0.1, 0.1, 0.1]),\n            \"p\": 1,\n            \"q\": 2\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        W = case[\"W\"]\n        Y_target = case[\"Y_target\"]\n        p = case[\"p\"]\n        q = case[\"q\"]\n        \n        # Calculate input mole fractions X from target mass fractions Y_target\n        Y_over_W = Y_target / W\n        sum_Y_over_W = np.sum(Y_over_W)\n        X = Y_over_W / sum_Y_over_W\n\n        # Run naive converter\n        Y_naive = naive_converter(X, W, p, q)\n        neg_naive = 1 if np.any(Y_naive < 0) else 0\n        min_naive = np.min(Y_naive)\n\n        # Run fixed converter\n        Y_fix = fixed_converter(X, W, q)\n        neg_fix = 1 if np.any(Y_fix < 0) else 0\n        min_fix = np.min(Y_fix)\n        \n        all_results.append(f\"[{neg_naive},{neg_fix},{min_naive},{min_fix}]\")\n\n    # The final output must be formatted exactly as specified, with spaces after commas inside the sublists.\n    # The prompt shows [[a1, b1, c1, d1], ...], but the example output shows [[a1,b1,c1,d1],...].\n    # I will stick to the final format string which uses no spaces.\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```", "id": "2504315"}]}