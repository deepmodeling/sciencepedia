## 引言
在有限元方法（FEM）的广阔领域中，形函数（shape functions）的选择是决定分析精度、计算成本和算法复杂性的核心。传统的有限元实现通常依赖于标准的[拉格朗日形函数](@entry_id:635448)，但在进行模型精度提升，尤其是自适应分析时，这种方法显示出其固有的局限性——提高多项式阶次需要完全替换整个[基函数](@entry_id:170178)集。为了解决这一难题，一种更先进、更高效的构造方法应运而生，那就是**[分层形函数](@entry_id:169076)（hierarchical shape functions）**。

本文聚焦于[一维二次杆单元](@entry_id:162662)，深入剖析[分层形函数](@entry_id:169076)的理论精髓与应用价值。与传统方法相比，分层方法提供了一种增量式的、结构优雅的途径来丰富[解空间](@entry_id:200470)，其独特的数学性质不仅简化了计算，更为强大的p-自适应有限元分析铺平了道路。

通过本文的学习，读者将踏上一段从理论到实践的完整旅程。在“**原理与机制**”一章中，我们将详细阐述[分层形函数](@entry_id:169076)的数学构造、[能量正交性](@entry_id:162669)以及[静态凝聚](@entry_id:176722)等关键概念。接下来，在“**应用与交叉学科联系**”中，我们将探索这些原理如何在实际计算、先进建模（如p-自适应）和处理复杂物理问题（如非均匀材料）中发挥作用。最后，通过“**动手实践**”部分提供的编程练习，您将有机会亲手实现并验证这些理论，从而将抽象的知识转化为切实的技能。

## 原理与机制

在有限元分析中，选择合适的[插值函数](@entry_id:262791)（或称形函数）是构建离散模型的基石。对于一个给定的单元，[插值函数](@entry_id:262791)的选择直接决定了其近似解空间的丰富程度以及计算的复杂性。在“引言”章节中，我们初步了解了有限元方法的基本框架。本章将深入探讨[一维二次杆单元](@entry_id:162662)的一种高级构造方法——**[分层形函数](@entry_id:169076) (hierarchical shape functions)**。与标准的[拉格朗日形函数](@entry_id:635448)相比，[分层形函数](@entry_id:169076)提供了一种更为优雅和高效的方式来提升近似解的精度，尤其在自适应分析中显示出巨大的优势。

### [分层形函数](@entry_id:169076)的[构造原理](@entry_id:141667)

传统的有限元方法通常采用**标准[拉格朗日形函数](@entry_id:635448) (standard Lagrangian shape functions)**。对于不同阶次的多项式近似，例如从线性 ($p=1$) 提升到二次 ($p=2$)，需要完全替换一套新的形函数。而分层方法则采用了一种“增量式”或“嵌套式”的思路。高一阶的近似空间是通过在低[一阶近似](@entry_id:147559)空间的基础上增加新的[基函数](@entry_id:170178)来构建的。也就是说，低阶次的形函数集合是高阶次形函数集合的一个[子集](@entry_id:261956)。

我们以[一维二次杆单元](@entry_id:162662)为例，在参考单元域 $\xi \in [-1, 1]$ 上阐述这一思想。

首先，我们从最简单的线性近似 ($p=1$) 开始。该近似空间由两个位于单元端点（节点）的线性形函数 $N_1(\xi)$ 和 $N_2(\xi)$ 张成。它们是标准的一次[拉格朗日多项式](@entry_id:142463)：
$$
N_1(\xi) = \frac{1-\xi}{2}
$$
$$
N_2(\xi) = \frac{1+\xi}{2}
$$
这两个函数满足**克罗内克-德尔塔 (Kronecker-delta)** 性质，即在一个节点 $\xi_j$ 上，形函数 $N_i(\xi_j)$ 的取值为 $\delta_{ij}$。因此，单元内的位移场近似 $u_h^{(p=1)}(\xi)$ 可以表示为节点位移 $d_1$ 和 $d_2$ 的[线性组合](@entry_id:154743)：
$$
u_h^{(p=1)}(\xi) = d_1 N_1(\xi) + d_2 N_2(\xi)
$$
由于 $N_i$ 的克罗内克-德尔[塔性质](@entry_id:273153)，系数 $d_1$ 和 $d_2$ 正是单元在节点 $\xi=-1$ 和 $\xi=1$ 处的位移值，即 $d_1 = u_h(-1)$ 和 $d_2 = u_h(1)$。这为自由度赋予了明确的物理意义。

现在，我们希望将近似空间提升到二次 ($p=2$)。分层法的核心思想是在保留现有线性基 $\{N_1, N_2\}$ 的基础上，增加一个二次形函数 $N_b(\xi)$ 来扩充基底。这个新增的函数通常被称为**内部模态 (internal mode)** 或 **[气泡函数](@entry_id:176111) (bubble function)**。二次近似位移场 $u_h^{(p=2)}(\xi)$ 表示为：
$$
u_h^{(p=2)}(\xi) = d_1 N_1(\xi) + d_2 N_2(\xi) + a N_b(\xi)
$$
其中 $a$ 是与[气泡函数](@entry_id:176111)相关联的内部自由度。

一个至关重要的问题是：这个新增的[气泡函数](@entry_id:176111) $N_b(\xi)$ 必须满足什么条件？分层构造的一个核心要求是，增加高阶项不应改变低阶自由度的物理意义。换言之，即使引入了内部自由度 $a$，系数 $d_1$ 和 $d_2$ 必须依然分别代表单元在 $\xi=-1$ 和 $\xi=1$ 处的节点位移。

让我们在节点处评估二次近似位移场 $u_h^{(p=2)}(\xi)$：
在 $\xi = -1$ 处：
$$
u_h^{(p=2)}(-1) = d_1 N_1(-1) + d_2 N_2(-1) + a N_b(-1) = d_1(1) + d_2(0) + a N_b(-1) = d_1 + a N_b(-1)
$$
为了使 $u_h^{(p=2)}(-1) = d_1$ 成立，必须有 $a N_b(-1) = 0$。

在 $\xi = 1$ 处：
$$
u_h^{(p=2)}(1) = d_1 N_1(1) + d_2 N_2(1) + a N_b(1) = d_1(0) + d_2(1) + a N_b(1) = d_2 + a N_b(1)
$$
为了使 $u_h^{(p=2)}(1) = d_2$ 成立，必须有 $a N_b(1) = 0$。

由于内部自由度 $a$ 可以是任意值，上述两个条件只有在[气泡函数](@entry_id:176111)本身于单元端点处为零时才能得到普遍满足。即：
$$
N_b(-1) = 0 \quad \text{and} \quad N_b(1) = 0
$$
这是所有分层内部模态必须遵循的基本原则：**新增的内部形函数必须在所有被其丰富（enrich）的低阶单元的节点上取值为零**。这个性质确保了高阶项的引入不会“污染”低阶节点自由度的物理诠释，并且保证了单元间的 $C^0$ 位移连续性。[@problem_id:2538579] [@problem_id:2538605]

对于二次[气泡函数](@entry_id:176111)，它必须是一个在 $\xi = \pm 1$ 处有根的二次多项式。因此，其最一般的形式为 $N_b(\xi) = C(\xi-1)(\xi+1) = C(\xi^2-1)$，其中 $C$ 是一个非零的[归一化常数](@entry_id:752675)。不同的归一化选择会产生不同的[气泡函数](@entry_id:176111)，例如：
1.  选择 $C=-1$，使得函数在 $\xi=0$ 处的峰值为1，即 $N_b(\xi) = 1-\xi^2$。这是一种非常常见的选择，因为它形式简单。[@problem_id:2538529]
2.  选择 $C$ 使得函数在某种范数下（例如[能量范数](@entry_id:274966)）具有单位值。例如，可以设定 $\int_{-1}^{1} (N_b'(\xi))^2 d\xi = \int_{-1}^{1} (N_1'(\xi))^2 d\xi$，从而将[气泡函数](@entry_id:176111)的能量归一化到与线性模态相同。通过计算可得，这种归一化对应的函数为 $N_b(\xi) = \frac{\sqrt{3}}{4}(\xi^2-1)$。[@problem_id:2538563]

值得注意的是，内部自由度 $a$ 并不直接等于单元内某一点的位移值。例如，即使我们选择 $N_b(\xi)=1-\xi^2$ 使得 $N_b(0)=1$，在单元中心 $\xi=0$ 处的位移为 $u_h(0) = \frac{d_1+d_2}{2} + a$。因此，$a = u_h(0) - \frac{d_1+d_2}{2}$，它表示[中心点](@entry_id:636820)位移相对于线性插值结果的偏差，是一个**[模态系数](@entry_id:752057) (modal coefficient)**，而非节点值。[@problem_id:2538605]

### [刚度矩阵](@entry_id:178659)的构建

在得到形函数之后，下一步是根据[虚功原理](@entry_id:138749)推导[单元刚度矩阵](@entry_id:139369)。对于一维弹性杆，其[应变能](@entry_id:162699)对应的双线性形式为：
$$
a(u,v) = \int_{x_1}^{x_2} EA \left(\frac{du}{dx}\right) \left(\frac{dv}{dx}\right) dx
$$
其中 $E$ 是[杨氏模量](@entry_id:140430)，$A$ 是[截面](@entry_id:154995)面积，$u$ 和 $v$ 分别是[位移场](@entry_id:141476)和[虚位移](@entry_id:168781)场。[单元刚度矩阵](@entry_id:139369) $\mathbf{K}^e$ 的分量 $K_{ij}$ 通过将第 $i$ 和第 $j$ 个形函数代入上式得到。

为了进行计算，我们需要将积分从物理域 $x \in [x_1, x_2]$ 变换到参考域 $\xi \in [-1, 1]$。这需要一个**[等参映射](@entry_id:173239) (isoparametric mapping)**。对于一个长度为 $L=x_2-x_1$ 的直杆单元，其[仿射映射](@entry_id:746332)为：
$$
x(\xi) = \frac{1-\xi}{2}x_1 + \frac{1+\xi}{2}x_2
$$
该映射的**[雅可比](@entry_id:264467) (Jacobian)** 是一个常数：
$$
J = \frac{dx}{d\xi} = \frac{x_2-x_1}{2} = \frac{L}{2}
$$
根据[链式法则](@entry_id:190743)，物理坐标下的导数和参考坐标下的导数关系为：
$$
\frac{d(\cdot)}{dx} = \frac{d\xi}{dx}\frac{d(\cdot)}{d\xi} = \frac{1}{J}\frac{d(\cdot)}{d\xi}
$$
同时，[微分](@entry_id:158718)元 $dx = J d\xi$。将这些关系代入双线性形式，我们得到在参考域上的积分表达式：
$$
K_{ij} = \int_{-1}^{1} EA \left( \frac{1}{J} \frac{dN_i}{d\xi} \right) \left( \frac{1}{J} \frac{dN_j}{d\xi} \right) (J d\xi) = \frac{EA}{J} \int_{-1}^{1} \frac{dN_i}{d\xi} \frac{dN_j}{d\xi} d\xi
$$
将 $J=L/2$ 代入，得到最终的计算公式：
$$
K_{ij} = \frac{2EA}{L} \int_{-1}^{1} \frac{dN_i}{d\xi} \frac{dN_j}{d\xi} d\xi
$$
[@problem_id:2538532] [@problem_id:2538573]

现在，我们使用分层基 $\{N_1, N_2, N_b\}$ 进行计算，其中 $N_b(\xi) = 1-\xi^2$。首先计算各形函数对 $\xi$ 的导数：
$$
N_1'(\xi) = -\frac{1}{2}
$$
$$
N_2'(\xi) = \frac{1}{2}
$$
$$
N_b'(\xi) = -2\xi
$$
[@problem_id:2538559]

将这些导数代入 $K_{ij}$ 的公式并进行积分，可以得到 $3 \times 3$ 的[单元刚度矩阵](@entry_id:139369)。例如，对角线上的分量 $K_{bb}$ 为：
$$
K_{bb} = \frac{2EA}{L} \int_{-1}^{1} (-2\xi)^2 d\xi = \frac{8EA}{L} \int_{-1}^{1} \xi^2 d\xi = \frac{8EA}{L} \left[ \frac{\xi^3}{3} \right]_{-1}^{1} = \frac{16EA}{3L}
$$
[@problem_id:2538529]

完整的[刚度矩阵](@entry_id:178659)计算结果如下：
$$
\mathbf{K}^e = \frac{EA}{L} \begin{pmatrix} 1  & -1 & 0 \\ -1 & 1 & 0 \\ 0 & 0 & \frac{16}{3} \end{pmatrix}
$$
[@problem_id:2538530]

### 分层单元的关键特性与应用

观察上述刚度矩阵，可以发现几个至关重要的特性，这些特性也揭示了分层单元在实际应用中的巨大价值。

#### [能量正交性](@entry_id:162669)与块对角刚度矩阵

最引人注目的特性是刚度矩阵呈现出**块对角 (block-diagonal)** 结构。连接节点自由度 $(d_1, d_2)$ 和内部自由度 $(a)$ 的耦合项 $K_{1b}, K_{2b}, K_{b1}, K_{b2}$ 均为零。

这种[解耦](@entry_id:637294)现象并非偶然，而是分层[基函数](@entry_id:170178)在对称[参考单元](@entry_id:168425)上构造的直接结果。我们来考察耦合项的积分，例如 $K_{1b}$：
$$
K_{1b} \propto \int_{-1}^{1} N_1'(\xi) N_b'(\xi) d\xi = \int_{-1}^{1} \left(-\frac{1}{2}\right) (-2\xi) d\xi = \int_{-1}^{1} \xi d\xi
$$
这个积分是在对称区间 $[-1, 1]$ 上对一个奇函数 ($\xi$) 进行积分，其结果恒为零。更一般地，线性形函数的导数是常数（[偶函数](@entry_id:163605)），而二次[气泡函数](@entry_id:176111)的导数是线性函数（奇函数）。一个[偶函数](@entry_id:163605)与一个[奇函数](@entry_id:173259)的乘积是[奇函数](@entry_id:173259)，其在对称区间上的积分必然为零。

这种在[能量内积](@entry_id:167297)（即双线性形式 $a(\cdot, \cdot)$）意义下的正交性，被称为**[能量正交性](@entry_id:162669) (energy orthogonality)**。它意味着从能量的角度看，由线性模态描述的刚体位移和匀速拉伸/压缩，与由[气泡函数](@entry_id:176111)描述的内部二次变形是[相互独立](@entry_id:273670)的。[@problem_id:2538559] [@problem_id:2538563]

#### [静态凝聚](@entry_id:176722)

[刚度矩阵](@entry_id:178659)的[块对角结构](@entry_id:746869)带来了一个重要的计算优势：**[静态凝聚](@entry_id:176722) (static condensation)**。由于内部自由度 $a$ 只与本单元内的节点自由度相关，并且不与其他任何单元的自由度直接耦合，我们可以在单元层面将其“消除”，从而减小全局求解系统的规模。

单元的力-位移关系方程 $\mathbf{K}^e \mathbf{d}^e = \mathbf{F}^e$ 可以写成分块形式：
$$
\begin{pmatrix} \mathbf{K}_{nn}  \mathbf{K}_{ni} \\ \mathbf{K}_{in}  \mathbf{K}_{ii} \end{pmatrix} \begin{pmatrix} \mathbf{d}_n \\ \mathbf{d}_i \end{pmatrix} = \begin{pmatrix} \mathbf{F}_n \\ \mathbf{F}_i \end{pmatrix}
$$
其中下标 $n$ 代表节点（外部）自由度，下标 $i$ 代表内部自由度。由于[能量正交性](@entry_id:162669)，耦合块 $\mathbf{K}_{ni}$ 和 $\mathbf{K}_{in}$ 为零矩阵。因此[方程组](@entry_id:193238)解耦为：
$$
\mathbf{K}_{nn} \mathbf{d}_n = \mathbf{F}_n
$$
$$
\mathbf{K}_{ii} \mathbf{d}_i = \mathbf{F}_i
$$
在没有[体力](@entry_id:174230)或面力作用于内部模态的情况下（即 $\mathbf{F}_i=0$），内部自由度为零。此时，参与[全局组装](@entry_id:749916)的**凝聚刚度矩阵 (condensed stiffness matrix)** 就是左上角的 $\mathbf{K}_{nn}$ 块：
$$
\mathbf{K}_{\text{cond}} = \mathbf{K}_{nn} = \frac{EA}{L} \begin{pmatrix} 1  & -1 \\ -1 & 1 \end{pmatrix}
$$
这与标[准线性](@entry_id:637689)杆单元的刚度矩阵完全相同。这意味着，在求解全局节点位移时，我们可以使用与线性单元完全相同的[系统矩阵](@entry_id:172230)。二次效应完全包含在内部自由度中，可以在求得节点位移后，通过 $\mathbf{d}_i = \mathbf{K}_{ii}^{-1} \mathbf{F}_i$ 在单元层面局部[回代](@entry_id:146909)求解。[@problem_id:2538541]

#### 在自适应分析与[误差估计](@entry_id:141578)中的应用

分层单元最强大的应用在于**p-自适应[有限元分析](@entry_id:138109) (p-adaptive FEM)**。p-自适应是一种通过局部提高单元的多项式阶次 $p$ 来提升解的精度的策略。

分层基的嵌套特性使得 p-自适应的实现变得异常简单。要将一个二次单元 ($p=2$) 提升为三次单元 ($p=3$)，我们只需在现有基 $\{N_1, N_2, N_b\}$ 的基础上再增加一个三次的[气泡函数](@entry_id:176111) $N_{b,3}(\xi)$（例如，一个在 $\xi=\pm 1$ 处为零的三次多项式），而无需修改任何已有的形函数或自由度。这使得刚度矩阵和[载荷向量](@entry_id:635284)的更新可以增量式地进行，极大地简化了编程实现。

此外，内部模态的系数为**[后验误差估计](@entry_id:167288) (a posteriori error estimation)** 提供了天然的、高效的指示器。在求解完一个 $p$ 阶近似解后，我们可以固定节点位移，在每个单元上求解更高一阶（例如 $p+1$ 阶）内部模态的系数。这些系数的大小直接反映了更[高阶模](@entry_id:750331)态对解的能量贡献。

如果某个单元的内部[模态系数](@entry_id:752057) $|a|$ 很大，说明该单元内的解具有显著的高阶特征，而当前的 $p$ 阶近似未能充分捕捉，因此存在较大的局部误差。反之，如果 $|a|$ 很小，则说明当前近似已经足够好。基于这个原理，一个有效的 p-自适应策略是：在所有单元中，识别出那些内部[模态系数](@entry_id:752057)（或其[能量范数](@entry_id:274966)）最大的单元，并对它们进行 p-阶次提升。这个过程可以迭代进行，直到整个求解域的误差都降低到可接受的水平。[@problem_id:2538549]