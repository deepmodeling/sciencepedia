{"hands_on_practices": [{"introduction": "亚稳态是一个理论概念，但在硬件世界中，它会表现为可测量的物理现象。在解决亚稳态问题之前，工程师必须首先学会在真实电路中识别它的“指纹”。本练习将理论与实践相结合，探讨如何使用示波器的余辉模式来直观地捕捉和识别亚稳态行为，这是数字系统调试中的一项关键技能。", "problem": "一位数字系统工程师正在调试一个包含单个D型触发器的电路。已知数据输入（标记为`D`）相对于时钟输入`CLK`是异步的。为了研究电路在这种条件下的行为，工程师将一个示波器探头连接到触发器的输出`Q`。示波器设置为在`CLK`信号的上升沿触发，并启用了一种称为“无限余晖”的显示模式。此模式使所有捕获的波形都叠加在屏幕上，任何点的亮度对应于信号经过该点的频率。在电路运行几分钟后，工程师必须解读示波器屏幕上得到的图像。\n\n以下哪项对示波器显示的文本描述为触发器输出`Q`正在经历亚稳态提供了最确凿的证据？\n\nA. 显示一个单一、清晰的方波，其频率恰好是`CLK`频率的一半。\nB. 显示两条明亮、实心的水平线，一条在逻辑'1'电压，另一条在逻辑'0'电压。这些线之间的跳变是陡峭的、垂直的，并且精确地发生在触发时刻。\nC. 显示两条明亮、实心的水平线，分别位于逻辑'1'和'0'电压。在这两条线之间，从触发时刻附近开始，有一个明显的微弱、“发光”的轨迹区域，该区域水平延伸一段短暂且可变的持续时间。\nD. 显示一条在逻辑'1'电压处的恒定、实心水平线，但这条线显得粗糙和模糊，表明在'1'电平附近有快速、微小的电压波动。\nE. 显示一条单一、清晰的水平线，其电压电平大约在定义的逻辑'1'和'0'电压的中间位置。", "solution": "我们分析具有相对于时钟$CLK$为异步输入$D$的D型触发器。由于$D$是异步的，因此存在非零概率，$D$会在$CLK$上升沿附近的建立/保持时间窗口内发生跳变。当这种情况发生时，触发器可能进入亚稳态，其输出$Q$在一段随机持续时间内既不是有效的逻辑'0'也不是有效的逻辑'1'，然后才会稳定到一个确定的电平。一个用于描述其稳定过程的动力学标准模型是，亚稳态节点以特征时间常数$\\tau$的指数形式偏离判决阈值$V_{M}$，因此对于某个小的初始偏移$\\Delta V$，输出轨迹的形式为\n$$\nV_{Q}(t) \\approx V_{M} \\pm \\Delta V \\exp\\left(\\frac{t}{\\tau}\\right),\n$$\n最终的符号和电平由噪声和器件不平衡决定。亚稳态稳定时间$t_{\\text{res}}$的分布通常用指数尾部来建模；亚稳态持续时间超过$t$的概率可表示为\n$$\n\\Pr(t_{\\text{res}} > t) \\propto \\exp\\left(-\\frac{t}{\\tau}\\right).\n$$\n因此，亚稳态事件相对罕见，其持续时间是可变的，且持续时间越长，其发生的可能性呈指数级下降。\n\n示波器在$CLK$的上升沿触发，并设置为无限余晖模式，该模式会叠加多次采集，使得频繁出现的值显得明亮，而不频繁出现的值则显得暗淡。在没有亚稳态的正常同步捕获情况下，$Q$在大部分时间会处于两个逻辑电平之一，并且跳变会在触发后定义明确的时刻发生。因此，无限余晖模式将显示两条位于逻辑电平上的明亮水平线，其跳变表现为在距触发固定延迟处出现的陡峭垂直边缘。\n\n如果发生亚稳态，那么在触发时刻（采样瞬间）附近，$Q$可能会在一段随机持续时间$t_{\\text{res}}$内处于中间电压。经过多次采集，无限余晖显示因此不仅会累积两条位于逻辑电平上的明亮线条，还会在两条线之间累积一团微弱的“云”或“辉光”轨迹，这些轨迹从触发时刻附近开始，并水平延伸不同的长度，以反映随机的$t_{\\text{res}}$。由于长的亚稳态持续时间的概率与$\\exp(-t/\\tau)$成正比，这些中间轨迹的密度（亮度）会随着与触发点的水平距离增加而减小，并且与逻辑电平相比，中间电平出现的次数稀疏，因此显得暗淡。\n\n我们现在在此背景下评估各个选项：\n\nA. 一个频率为$CLK$一半的清晰方波表明$Q$在每个时钟沿都确定性地翻转（如二分频行为），这并不表示亚稳态。\n\nB. 两条明亮的逻辑电平线，在触发时刻有陡峭的垂直跳变，表明采样一致、时序良好，没有由亚稳态引起的时序离散或中间电平。\n\nC. 两条明亮的逻辑电平线，加上从触发时刻附近开始、水平延伸一段短暂且可变持续时间的独特微弱轨迹区域，这与亚稳态的特征完全匹配：在采样瞬间附近的中间$Q$电平，具有可变的稳定时间$t_{\\text{res}}$，通过无限余晖累积成逻辑电平之间一条微弱、模糊的带状区域。\n\nD. 在逻辑'1'处的一条粗糙、模糊的线表明在一个稳定的高电平周围存在噪声或小幅波动，而不是亚稳态在采样沿附近所特有的中间电平行为或可变持续时间延迟。\n\nE. 一条单一、清晰的中间电平线表示一个恒定的直流中间电平（例如，节点悬空或偏置不当、探头负载效应或驱动器未上电），而不是零星的、随时间变化的亚稳态行为。\n\n因此，提供亚稳态最确凿证据的描述是选项 C。", "answer": "$$\\boxed{C}$$", "id": "1947264"}, {"introduction": "识别问题后，下一步是设计解决方案。对于跨时钟域的异步信号，最常见的缓解策略是使用多级触发器组成的同步器。本练习 [@problem_id:1947216] 将带你从定性理解转向定量设计，通过计算平均无故障时间（MTBF）来确定满足系统可靠性要求所需的最少触发器级数，并权衡其带来的延迟代价。", "problem": "一位数字系统工程师正在设计一个接口，用于从外部异步设备接收数据。为防止时序违规，输入的数据信号必须使用一串 D 型触发器与系统的内部时钟同步。该同步器的可靠性通过其平均无故障时间（MTBF）来衡量，MTBF 是同步器因传播亚稳态而失效前的平均时间。具有 $N$ 个触发器的同步器的 MTBF 可通过以下方程建模：\n\n$$ \\text{MTBF} = \\frac{\\exp\\left(\\frac{(N-1) T_{\\text{clk}}}{\\tau}\\right)}{T_W \\cdot f_{\\text{clk}} \\cdot f_{\\text{data}}} $$\n\n其中：\n- $N$ 是同步器链中触发器的数量（$N$ 是一个 $\\ge 1$ 的整数）。\n- $f_{\\text{clk}}$ 是系统时钟频率。\n- $T_{\\text{clk}} = 1/f_{\\text{clk}}$ 是系统时钟周期。\n- $f_{\\text{data}}$ 是异步数据线上的平均转换率。\n- $\\tau$ 是亚稳态解析时间常数，是触发器技术的一个特性。\n- $T_W$ 是时钟边沿附近的一个小时间窗口，在此窗口内的输入转换可能导致亚稳态。\n\n系统具有以下规格：\n- 系统时钟频率, $f_{\\text{clk}} = 250 \\text{ MHz}$。\n- 异步数据转换率, $f_{\\text{data}} = 25 \\text{ MHz}$。\n- 触发器时间常数, $\\tau = 0.18 \\text{ ns}$。\n- 亚稳态窗口, $T_W = 15 \\text{ ps}$。\n\n为确保系统可靠性，设计要求最小 MTBF 为 100 年。在本次计算中，假设一年约等于 $3.154 \\times 10^7$ 秒。为最小化信号延迟，工程师必须使用满足此可靠性要求的最小整数个触发器（$N$）。同步器引入的延迟定义为等于链中触发器数量的总时钟周期数。\n\n计算此最小尺寸同步器引入的总延迟。答案以纳秒为单位表示，并四舍五入到三位有效数字。", "solution": "我们要求同步器的 MTBF 达到或超过 100 年的目标。MTBF 模型为\n$$\\text{MTBF}=\\frac{\\exp\\!\\left(\\frac{(N-1)T_{\\text{clk}}}{\\tau}\\right)}{T_{W}f_{\\text{clk}}f_{\\text{data}}}.$$\n设所需的最小 MTBF 为\n$$M_{\\min}=100\\times 3.154\\times 10^{7}\\ \\text{s}=3.154\\times 10^{9}\\ \\text{s}.$$\n施加要求 $\\text{MTBF}\\geq M_{\\min}$ 并求解 $N$：\n$$\\frac{\\exp\\!\\left(\\frac{(N-1)T_{\\text{clk}}}{\\tau}\\right)}{T_{W}f_{\\text{clk}}f_{\\text{data}}}\\geq M_{\\min}\\quad\\Longrightarrow\\quad \\frac{(N-1)T_{\\text{clk}}}{\\tau}\\geq \\ln\\!\\big(M_{\\min}T_{W}f_{\\text{clk}}f_{\\text{data}}\\big),$$\n$$N\\geq 1+\\frac{\\tau}{T_{\\text{clk}}}\\,\\ln\\!\\big(M_{\\min}T_{W}f_{\\text{clk}}f_{\\text{data}}\\big).$$\n计算所需量：\n$$T_{\\text{clk}}=\\frac{1}{f_{\\text{clk}}}=\\frac{1}{250\\times 10^{6}}\\ \\text{s}=4.0\\times 10^{-9}\\ \\text{s},$$\n$$\\tau=0.18\\ \\text{ns}=1.8\\times 10^{-10}\\ \\text{s},\\quad T_{W}=15\\ \\text{ps}=1.5\\times 10^{-11}\\ \\text{s},$$\n$$f_{\\text{clk}}f_{\\text{data}}=(250\\times 10^{6})(25\\times 10^{6})=6.25\\times 10^{15},$$\n$$M_{\\min}T_{W}f_{\\text{clk}}f_{\\text{data}}=(3.154\\times 10^{9})(1.5\\times 10^{-11})(6.25\\times 10^{15})=2.956875\\times 10^{14}.$$\n因此\n$$\\ln\\!\\big(M_{\\min}T_{W}f_{\\text{clk}}f_{\\text{data}}\\big)=\\ln(2.956875)+14\\ln 10\\approx 1.0842+14(2.302585)\\approx 33.3204.$$\n此外，\n$$\\frac{\\tau}{T_{\\text{clk}}}=\\frac{0.18\\ \\text{ns}}{4.0\\ \\text{ns}}=0.045.$$\n所以，\n$$N\\geq 1+0.045\\times 33.3204\\approx 1+1.4994=2.4994,$$\n所以最小的整数是 $N=3$。\n\n延迟定义为等于触发器数量的时钟周期数，因此时间延迟为\n$$\\text{latency}=N\\,T_{\\text{clk}}=3\\times 4.0\\ \\text{ns}=12.0\\ \\text{ns}.$$\n四舍五入到三位有效数字，结果是 $12.0$ 纳秒。", "answer": "$$\\boxed{12.0}$$", "id": "1947216"}, {"introduction": "仅仅遵循“使用两级或三级同步器”的规则是不够的，错误的电路结构会使同步器失效。一个常见的严重设计错误是扇出（fan-out）同步器第一级的输出。本练习 [@problem_id:1947246] 通过分析一个具体的失效场景，揭示了为何必须严格遵守“不扇出第一级输出”的设计准则，从而加深对亚稳态如何在系统中引发逻辑错误的理解。", "problem": "一个关键数字电路被设计用于将异步输入信号 `ASYNC_IN` 同步到系统时钟域 `CLK`。该同步器由两个串联的D型触发器 `FF1` 和 `FF2` 组成。第一个触发器的输出 `Q1` 连接到第二个触发器的输入 `D2`。\n\n违反良好设计实践的是，`Q1` 输出信号还被扇出，以馈入另外两个并行触发器 `FF_A` 和 `FF_B` 的数据输入端。因此，`D_A = Q1` 且 `D_B = Q1`。所有触发器（`FF1`、`FF_A` 和 `FF_B`）都由同一个时钟 `CLK` 驱动，其周期为 `T_{clk}`。\n\n由于制造工艺偏差，`FF_A` 和 `FF_B` 的逻辑输入阈值略有不同。如果电压高于 $V_{th_A}$，`FF_A` 会将其输入解释为逻辑'1'；如果电压高于 $V_{th_B}$，`FF_B` 会将其输入解释为逻辑'1'。已知 $V_{th_A}  V_{th_B}$。\n\n在时间 $t=0$ 时，`CLK` 出现一个上升沿。就在此时钟沿之前，`ASYNC_IN` 信号发生跳变，违反了 `FF1` 的建立时间。这导致 `FF1` 的输出 `Q1` 进入亚稳态。`Q1` 的电压，记为 `V_{Q1}(t)`，开始向高电源轨 `V_{DD}` 解析。该解析过程遵循以下物理模型：\n$$V_{Q1}(t) = \\frac{V_{DD}}{2} + \\Delta V_0 \\exp\\left(\\frac{t}{\\tau_{res}}\\right)$$\n其中 $t \\ge 0$ 是自时钟沿经过的时间，$\\Delta V_0$ 是一个微小的正初始电压位移，其值取决于输入跳变的精确时序，而 $\\tau_{res}$ 是触发器亚稳态解析的特征时间常数。\n\n功能性故障定义为在 $t = T_{clk}$ 的下一个时钟沿之后，输出 `Q_A` 和 `Q_B` 不相同的状态。为了使触发器可靠地捕获逻辑'1'，其数据输入必须在关键采样时刻高于其电压阈值，该时刻发生在捕获时钟沿之前的建立时间 $t_{su}$ 处。否则，它将捕获'0'。\n\n确定会导致此功能性故障的初始电压位移 $\\Delta V_0$ 的范围。通过提供 $\\Delta V_0$ 的开区间的下界和上界来表示你的答案。", "solution": "将下一个时钟捕获的关键采样时刻定义为 $t_{s}=T_{clk}-t_{su}$。在此刻，$FF_{A}$ 和 $FF_{B}$ 看到的输入为\n$$\nV_{Q1}(t_{s})=\\frac{V_{DD}}{2}+\\Delta V_{0}\\exp\\!\\left(\\frac{t_{s}}{\\tau_{res}}\\right).\n$$\n根据给定的捕获规则，$FF_{X}$（$X \\in \\{A, B\\}$）将捕获逻辑'1'当且仅当 $V_{Q1}(t_{s}) > V_{th_{X}}$，否则它将捕获'0'。由于 $V_{th_A}  V_{th_B}$，要使输出不相同，唯一可能的情况是 $Q_A=1$ 且 $Q_B=0$。这种情况发生的条件是 $V_{Q1}(t_s)$ 的电压必须介于两个阈值之间：\n$$\nV_{th_{A}}  V_{Q1}(t_s)  V_{th_B}.\n$$\n将 $V_{Q1}(t_s)$ 的表达式代入：\n$$\nV_{th_{A}}  \\frac{V_{DD}}{2}+\\Delta V_{0}\\exp\\!\\left(\\frac{t_{s}}{\\tau_{res}}\\right)  V_{th_{B}}.\n$$\n求解 $\\Delta V_{0}$：\n$$\nV_{th_{A}}-\\frac{V_{DD}}{2}  \\Delta V_{0}\\exp\\!\\left(\\frac{t_{s}}{\\tau_{res}}\\right)  V_{th_{B}}-\\frac{V_{DD}}{2}.\n$$\n$$\n\\left(V_{th_{A}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{t_{s}}{\\tau_{res}}\\right)  \\Delta V_{0}  \\left(V_{th_{B}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{t_{s}}{\\tau_{res}}\\right).\n$$\n将 $t_{s}=T_{clk}-t_{su}$ 代入，得到导致功能性故障的 $\\Delta V_0$ 范围：\n$$\n\\left(V_{th_{A}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{T_{clk}-t_{su}}{\\tau_{res}}\\right)  \\Delta V_{0}  \\left(V_{th_{B}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{T_{clk}-t_{su}}{\\tau_{res}}\\right).\n$$", "answer": "$$\\boxed{\\begin{pmatrix}\\left(V_{th_{A}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{T_{clk}-t_{su}}{\\tau_{res}}\\right)  \\left(V_{th_{B}}-\\frac{V_{DD}}{2}\\right)\\exp\\!\\left(-\\frac{T_{clk}-t_{su}}{\\tau_{res}}\\right)\\end{pmatrix}}$$", "id": "1947246"}]}