{"hands_on_practices": [{"introduction": "The foundation of a molecular dynamics simulation is the force field, which describes the potential energy $U$ of a system as a function of its atomic coordinates. To simulate the motion of atoms, we must compute the force $\\mathbf{F}$ on each atom, which is derived directly from this potential. This exercise grounds your understanding in this fundamental connection [@problem_id:2404403].\n\nYou will practice the analytical derivation of the force and the virial, a quantity crucial for calculating pressure, from a given interatomic potential. By working through a hypothetical potential, you will reinforce the core principle that force is the negative gradient of potential energy, $\\mathbf{F} = -\\nabla U(r)$, solidifying a skill essential for both developing and understanding force fields.", "problem": "Consider a monatomic system with pairwise, central interactions described by the Lennard-Jones-like potential\n$$\nU(r) = 4\\,\\varepsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right],\n$$\nwhere $r = |\\mathbf{r}_{ij}|$ is the scalar separation between two particles, $\\mathbf{r}_{ij}$ is the interparticle separation vector, $\\sigma$ is a characteristic length scale, and $\\varepsilon$ is an energy scale. Assume the interaction is spherically symmetric and pairwise additive. Using only the fundamental definitions that (i) the force is the negative gradient of the potential, and (ii) the scalar pair virial contribution is defined as $w(r) = \\mathbf{r}_{ij} \\cdot \\mathbf{F}_{ij}(r)$, derive analytic expressions for the force vector $\\mathbf{F}_{ij}(r)$ and the scalar pair virial $w(r)$ as functions of $r$, $\\sigma$, and $\\varepsilon$. Express the force along the radial unit vector $\\hat{\\mathbf{r}}_{ij} = \\mathbf{r}_{ij}/r$.\n\nProvide your final result as closed-form expressions in terms of $r$, $\\sigma$, and $\\varepsilon$ only. Express the force as a vector and the virial as a scalar. Do not substitute numerical values. Do not include units in the final boxed answer. Report both results together as a single row matrix $\\begin{pmatrix}\\mathbf{F}_{ij}(r) & w(r)\\end{pmatrix}$.", "solution": "The problem requires the derivation of the interparticle force vector $\\mathbf{F}_{ij}(r)$ and the scalar pair virial $w(r)$ from a given pairwise central potential $U(r)$. The problem is well-posed and scientifically sound, representing a standard exercise in classical mechanics and statistical physics. We shall proceed with the derivation based on the fundamental definitions provided.\n\nThe interatomic potential is given as:\n$$\nU(r) = 4\\,\\varepsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\nwhere $r = |\\mathbf{r}_{ij}|$ is the scalar distance between particles $i$ and $j$.\n\nFirst, we derive the force vector $\\mathbf{F}_{ij}$. The force is defined as the negative gradient of the potential energy with respect to the interparticle separation vector $\\mathbf{r}_{ij}$:\n$$\n\\mathbf{F}_{ij} = -\\nabla_{\\mathbf{r}_{ij}} U(r)\n$$\nSince the potential $U$ is a function of the scalar distance $r$ only, we can apply the chain rule for the gradient:\n$$\n\\nabla_{\\mathbf{r}_{ij}} U(r) = \\frac{dU}{dr} \\nabla_{\\mathbf{r}_{ij}} r\n$$\nThe gradient of the scalar distance $r = |\\mathbf{r}_{ij}| = \\sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2}$ is the radial unit vector $\\hat{\\mathbf{r}}_{ij}$:\n$$\n\\nabla_{\\mathbf{r}_{ij}} r = \\frac{\\mathbf{r}_{ij}}{r} = \\hat{\\mathbf{r}}_{ij}\n$$\nTherefore, the force vector can be expressed as:\n$$\n\\mathbf{F}_{ij}(r) = -\\frac{dU}{dr} \\hat{\\mathbf{r}}_{ij}\n$$\nWe now compute the derivative of the potential $U(r)$ with respect to $r$. For clarity, let us rewrite $U(r)$ as:\n$$\nU(r) = 4\\,\\varepsilon\\left(\\sigma^{10}r^{-10} - \\sigma^{5}r^{-5}\\right)\n$$\nThe derivative is:\n$$\n\\frac{dU}{dr} = 4\\,\\varepsilon \\frac{d}{dr}\\left(\\sigma^{10}r^{-10} - \\sigma^{5}r^{-5}\\right) = 4\\,\\varepsilon\\left(\\sigma^{10}(-10)r^{-11} - \\sigma^{5}(-5)r^{-6}\\right)\n$$\n$$\n\\frac{dU}{dr} = 4\\,\\varepsilon\\left(-10 \\frac{\\sigma^{10}}{r^{11}} + 5 \\frac{\\sigma^{5}}{r^{6}}\\right)\n$$\nFactoring out common terms, we can write:\n$$\n\\frac{dU}{dr} = \\frac{20\\,\\varepsilon}{r} \\left(-2 \\frac{\\sigma^{10}}{r^{10}} + \\frac{\\sigma^{5}}{r^{5}}\\right) = -\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\nSubstituting this derivative back into the expression for the force, we obtain:\n$$\n\\mathbf{F}_{ij}(r) = - \\left(-\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) \\hat{\\mathbf{r}}_{ij}\n$$\n$$\n\\mathbf{F}_{ij}(r) = \\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\n$$\nThis is the analytical expression for the force vector.\n\nNext, we derive the scalar pair virial, $w(r)$. The definition is provided as:\n$$\nw(r) = \\mathbf{r}_{ij} \\cdot \\mathbf{F}_{ij}(r)\n$$\nWe substitute the derived expression for $\\mathbf{F}_{ij}(r)$:\n$$\nw(r) = \\mathbf{r}_{ij} \\cdot \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\\right)\n$$\nUsing the relation $\\mathbf{r}_{ij} = r \\hat{\\mathbf{r}}_{ij}$ and noting that the dot product of a unit vector with itself is unity, $\\hat{\\mathbf{r}}_{ij} \\cdot \\hat{\\mathbf{r}}_{ij} = 1$, we find:\n$$\nw(r) = (r \\hat{\\mathbf{r}}_{ij}) \\cdot \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\hat{\\mathbf{r}}_{ij}\\right)\n$$\n$$\nw(r) = r \\left(\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) (\\hat{\\mathbf{r}}_{ij} \\cdot \\hat{\\mathbf{r}}_{ij})\n$$\nThe factors of $r$ cancel, leaving:\n$$\nw(r) = 20\\,\\varepsilon \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\nThis is the analytical expression for the scalar pair virial. An alternative and equivalent path to the virial is to use the expression $w(r) = -r \\frac{dU}{dr}$, which yields the same result:\n$$\nw(r) = -r \\left(-\\frac{20\\,\\varepsilon}{r} \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\right) = 20\\,\\varepsilon \\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\n$$\nThe derivation is complete. We have obtained closed-form expressions for both the force vector and the scalar pair virial.", "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{20\\,\\varepsilon}{r}\\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right]\\hat{\\mathbf{r}}_{ij} & 20\\,\\varepsilon\\left[2\\left(\\frac{\\sigma}{r}\\right)^{10} - \\left(\\frac{\\sigma}{r}\\right)^{5}\\right] \\end{pmatrix}}\n$$", "id": "2404403"}, {"introduction": "After mastering the link between potential and force, a critical question in force field design is choosing the right mathematical form for the potential. Simple functions like the harmonic potential, $U_h(r) = \\frac{1}{2} k (r - r_0)^2$, are computationally efficient for modeling vibrations near equilibrium but fail to describe more extreme phenomena like bond breaking. This practice explores the critical trade-offs involved in selecting a potential function [@problem_id:2407785].\n\nThrough a comparative thought experiment, you will analyze the physical and numerical differences between the simple harmonic model and the more realistic Morse potential, $U_M(r) = D_e (1 - \\exp(-a (r - r_0)))^2$. This exercise highlights why a physically accurate description of bond dissociation is crucial for preventing catastrophic numerical instabilities in molecular dynamics simulations.", "problem": "In a molecular mechanics force field used in computational biology and bioinformatics, a covalent bond is sometimes modeled with a harmonic potential $U_h(r) = \\tfrac{1}{2} k (r - r_0)^2$, where $k$ is the bond force constant and $r_0$ is the equilibrium bond length. An alternative is the Morse potential $U_M(r) = D_e \\left(1 - e^{-a (r - r_0)}\\right)^2$, where $D_e$ is the dissociation energy and $a$ controls the potentialâ€™s range. Consider an isolated diatomic fragment representing a single covalent bond. At time $t = 0$, the interatomic distance is $r = r_0$ and an impulse imparts relative kinetic energy $E_0$ along the bond stretching direction. Ignore all other degrees of freedom, environmental coupling, and nonbonded interactions. In a typical explicit molecular dynamics (MD) integrator with time step $\\Delta t$, very large instantaneous forces can cause numerical instability.\n\nWhich of the following statements correctly describe the physical and numerical consequences for this setup, and justify replacing the harmonic bond with the Morse potential in a molecular mechanics force field?\n\nA. Under $U_h(r)$, the atoms remain bound for any finite $E_0$. The outer turning point satisfies $U_h(r_{\\max}) = E_0$, giving $r_{\\max} = r_0 + \\sqrt{2 E_0 / k}$ and a maximum restoring force magnitude at the turning point of $\\sqrt{2 k E_0}$, which can become arbitrarily large as $E_0$ increases, risking catastrophic integrator failure for fixed $\\Delta t$. Under $U_M(r)$, if $E_0 > D_e$, the bond dissociates and the force magnitude decays to $0$ as $r \\to \\infty$, so energies and forces remain bounded by physically meaningful values, avoiding runaway forces.\n\nB. Under $U_h(r)$, the potential energy is bounded above by $D_e$ as $r \\to \\infty$, so there is no risk of unbounded forces or numerical instability; therefore, replacing $U_h(r)$ with $U_M(r)$ is unnecessary.\n\nC. For small displacements $|r - r_0| \\ll a^{-1}$, $U_M(r)$ is approximately harmonic with curvature $k_{\\mathrm{eff}} = 2 D_e a^2$, so one can match $k_{\\mathrm{eff}}$ to a chosen $k$ and reproduce near-equilibrium vibrations while adding realistic bond dissociation at large $r$.\n\nD. Replacing $U_h(r)$ with $U_M(r)$ necessarily increases the highest vibrational frequency near $r_0$, which forces a smaller stable time step $\\Delta t$ in explicit MD, making the Morse potential numerically worse near equilibrium.\n\nE. The catastrophic failure arises under $U_h(r)$ because its restoring force decays to $0$ as $r$ increases, allowing runaway separation; $U_M(r)$ fixes this by providing a linearly increasing force at large $r$.", "solution": "The problem requires a critical comparison of two potential energy functions used to model a covalent bond in molecular mechanics: the harmonic potential, $U_h(r)$, and the Morse potential, $U_M(r)$. We must analyze their physical realism and their implications for the numerical stability of molecular dynamics (MD) simulations.\n\nThe harmonic potential is given by:\n$$ U_h(r) = \\frac{1}{2} k (r - r_0)^2 $$\nwhere $k$ is the force constant and $r_0$ is the equilibrium bond length. The force associated with this potential is derived from its negative gradient:\n$$ F_h(r) = -\\frac{dU_h(r)}{dr} = -k (r - r_0) $$\nThis is a simple Hooke's Law restoring force. A key feature of the harmonic potential is that $U_h(r) \\to \\infty$ as the interatomic distance $r$ deviates from $r_0$. Consequently, the magnitude of the restoring force, $|F_h(r)| = k|r-r_0|$, increases linearly without bound. This is physically unrealistic, as a true covalent bond will break (dissociate) if stretched sufficiently, at which point the potential energy should approach a constant value (the dissociation energy) and the force between the atoms should approach zero.\n\nIn the scenario described, the system starts at $r=r_0$ with kinetic energy $E_0$. By conservation of energy, the total energy is $E_{total} = E_0$. The atoms will oscillate. The outer turning point, $r_{max}$, is reached when all kinetic energy is converted to potential energy, i.e., $U_h(r_{max}) = E_0$.\n$$ \\frac{1}{2} k (r_{max} - r_0)^2 = E_0 \\implies r_{max} = r_0 + \\sqrt{\\frac{2 E_0}{k}} $$\nFor any finite positive energy $E_0$, there is a finite turning point, meaning the bond never breaks. The maximum force magnitude is experienced at this turning point:\n$$ |F_{h, max}| = |F_h(r_{max})| = k(r_{max} - r_0) = k \\sqrt{\\frac{2 E_0}{k}} = \\sqrt{2 k E_0} $$\nThis maximum force grows with $\\sqrt{E_0}$ and can become arbitrarily large if $E_0$ is large. In an explicit MD integrator with a fixed time step $\\Delta t$, very large forces can cause particles to be displaced by unphysically large distances in a single step, leading to numerical instability and catastrophic failure of the simulation.\n\nThe Morse potential is a more realistic alternative:\n$$ U_M(r) = D_e \\left(1 - e^{-a (r - r_0)}\\right)^2 $$\nHere, $D_e$ is the bond dissociation energy and $a$ is a parameter controlling the \"width\" of the potential well.\nKey properties of the Morse potential are:\n1.  As $r \\to \\infty$, $e^{-a(r-r_0)} \\to 0$, so $U_M(r) \\to D_e$. This correctly models bond dissociation.\n2.  The potential has a minimum of $0$ at $r = r_0$.\n\nThe force derived from the Morse potential is:\n$$ F_M(r) = -\\frac{dU_M(r)}{dr} = -2 a D_e \\left(1 - e^{-a (r - r_0)}\\right) e^{-a (r - r_0)} = -2 a D_e \\left(e^{-a(r-r_0)} - e^{-2a(r-r_0)}\\right) $$\nAs $r \\to \\infty$, both exponential terms approach $0$, so the force $F_M(r) \\to 0$. This is physically correct; separated atoms should not exert a force on each other. The force from a Morse potential is bounded. Its maximum value occurs at $r = r_0 + \\frac{\\ln(2)}{a}$ and is equal to $\\frac{a D_e}{2}$. This finite upper limit on the force, regardless of the system's energy, prevents the runaway force problem seen with the harmonic potential. If the initial kinetic energy $E_0$ exceeds the dissociation energy $D_e$, the bond will simply break, and the atoms will separate with the force between them decaying to zero, which is a physically and numerically stable outcome.\n\nNow, we evaluate each option.\n\nA. Under $U_h(r)$, the atoms remain bound for any finite $E_0$. The outer turning point satisfies $U_h(r_{\\max}) = E_0$, giving $r_{\\max} = r_0 + \\sqrt{2 E_0 / k}$ and a maximum restoring force magnitude at the turning point of $\\sqrt{2 k E_0}$, which can become arbitrarily large as $E_0$ increases, risking catastrophic integrator failure for fixed $\\Delta t$. Under $U_M(r)$, if $E_0 > D_e$, the bond dissociates and the force magnitude decays to $0$ as $r \\to \\infty$, so energies and forces remain bounded by physically meaningful values, avoiding runaway forces.\n**Verdict: Correct.** This statement accurately summarizes the analysis above. It correctly identifies the unbounded nature of the harmonic force and its numerical consequences, and contrasts this with the physically realistic dissociation and a numerically benign bounded force provided by the Morse potential.\n\nB. Under $U_h(r)$, the potential energy is bounded above by $D_e$ as $r \\to \\infty$, so there is no risk of unbounded forces or numerical instability; therefore, replacing $U_h(r)$ with $U_M(r)$ is unnecessary.\n**Verdict: Incorrect.** The premise is false. The harmonic potential $U_h(r) = \\frac{1}{2} k (r - r_0)^2$ is unbounded; it grows quadratically as $r$ moves away from $r_0$. Therefore, the forces are also unbounded, presenting a significant risk of numerical instability.\n\nC. For small displacements $|r - r_0| \\ll a^{-1}$, $U_M(r)$ is approximately harmonic with curvature $k_{\\mathrm{eff}} = 2 D_e a^2$, so one can match $k_{\\mathrm{eff}}$ to a chosen $k$ and reproduce near-equilibrium vibrations while adding realistic bond dissociation at large $r$.\n**Verdict: Correct.** To verify this, we perform a Taylor expansion of $U_M(r)$ around $r=r_0$. Let $x = r - r_0$. For small $x$, we have $e^{-ax} \\approx 1 - ax + \\frac{1}{2}(-ax)^2 = 1-ax+\\frac{a^2x^2}{2}$.\nSubstituting this into the Morse potential expression:\n$$ U_M(x) = D_e \\left(1 - \\left(1 - ax + \\frac{a^2x^2}{2} + \\dots \\right)\\right)^2 = D_e \\left(ax - \\frac{a^2x^2}{2} + \\dots \\right)^2 $$\nExpanding and keeping the lowest order term in $x$:\n$$ U_M(x) \\approx D_e(ax)^2 = D_e a^2 x^2 = D_e a^2 (r - r_0)^2 $$\nComparing this to the harmonic form $U_h(r) = \\frac{1}{2} k (r - r_0)^2$, we can define an effective force constant $k_{eff}$ such that $\\frac{1}{2} k_{eff} (r - r_0)^2 = D_e a^2 (r-r_0)^2$. This yields $k_{eff} = 2 D_e a^2$. Thus, the Morse potential can be parameterized to match the harmonic potential's behavior for small oscillations, ensuring it accurately models near-equilibrium vibrations, while also providing the correct dissociation behavior. This is a primary justification for its use.\n\nD. Replacing $U_h(r)$ with $U_M(r)$ necessarily increases the highest vibrational frequency near $r_0$, which forces a smaller stable time step $\\Delta t$ in explicit MD, making the Morse potential numerically worse near equilibrium.\n**Verdict: Incorrect.** As shown in the analysis for option C, one can choose the parameters of the Morse potential ($a$ and $D_e$) to match any desired effective force constant $k_{eff}$ near equilibrium, including setting $k_{eff} = k$ of a given harmonic potential. The vibrational frequency, $\\omega = \\sqrt{k_{eff}/\\mu}$ (where $\\mu$ is the reduced mass), is therefore not necessarily increased. The statement is false.\n\nE. The catastrophic failure arises under $U_h(r)$ because its restoring force decays to $0$ as $r$ increases, allowing runaway separation; $U_M(r)$ fixes this by providing a linearly increasing force at large $r$.\n**Verdict: Incorrect.** This statement has the physics reversed. The failure under $U_h(r)$ is due to its linearly *increasing* force, which becomes unbounded. It is the Morse potential, $U_M(r)$, whose force decays to $0$ at large $r$.\n\nBased on the analysis, statements A and C are correct descriptions of the physical and numerical properties that justify using the Morse potential over the harmonic potential in molecular mechanics simulations.", "answer": "$$\\boxed{AC}$$", "id": "2407785"}, {"introduction": "A force field is defined not only by its mathematical form but also by a set of parameters that give it predictive power. This final practice addresses a key question: how are these parameters determined? You will engage in a complete workflow for parameterizing a portion of a force field, specifically fitting atomic partial charges to reproduce the electrostatic properties predicted by a higher-level theory [@problem_id:2404445].\n\nThis advanced exercise guides you through the process of using constrained least-squares optimization to fit partial charges $q_i$ for a formaldehyde molecule. By minimizing the difference between the force field's electrostatic potential and reference data from a quantum mechanical calculation, you will gain direct experience with a cornerstone technique in modern force field development.", "problem": "Write a complete program that, in atomic units, fits partial atomic charges for a formaldehyde molecule by minimizing the discrepancy between a force field electrostatic potential and a provided set of reference electrostatic potential values that represent a quantum mechanical calculation. The molecule contains four atoms: carbon, oxygen, and two equivalent hydrogens. The electrostatic potential at a field point located at position $\\mathbf{r}$ generated by $N$ point charges $q_i$ located at positions $\\mathbf{R}_i$ is, in atomic units where $1/(4\\pi\\varepsilon_0)=1$, given by\n$$\nV(\\mathbf{r})=\\sum_{i=1}^{N}\\frac{q_i}{\\lVert \\mathbf{r}-\\mathbf{R}_i\\rVert}.\n$$\nUse the following fixed atomic positions (in bohr) for formaldehyde:\n- Carbon (C): $(0.00000,\\,0.00000,\\,0.00000)$\n- Oxygen (O): $(2.28660,\\,0.00000,\\,0.00000)$\n- Hydrogen 1 (H1): $(-1.03935,\\,1.80099,\\,0.00000)$\n- Hydrogen 2 (H2): $(-1.03935,\\,-1.80099,\\,0.00000)$\n\nUse the following eight field points (in bohr) at which the reference electrostatic potential values are given:\n- $\\mathbf{g}_1=(4.00000,\\,0.00000,\\,0.00000)$\n- $\\mathbf{g}_2=(-4.00000,\\,0.00000,\\,0.00000)$\n- $\\mathbf{g}_3=(0.00000,\\,4.00000,\\,0.00000)$\n- $\\mathbf{g}_4=(0.00000,\\,-4.00000,\\,0.00000)$\n- $\\mathbf{g}_5=(0.00000,\\,0.00000,\\,4.00000)$\n- $\\mathbf{g}_6=(0.00000,\\,0.00000,\\,-4.00000)$\n- $\\mathbf{g}_7=(3.00000,\\,3.00000,\\,0.00000)$\n- $\\mathbf{g}_8=(-3.00000,\\,-3.00000,\\,0.00000)$\n\nThe corresponding reference electrostatic potential values $V_{\\mathrm{ref}}(\\mathbf{g}_k)$ (in atomic units of potential) at these field points are given as:\n- $V_{\\mathrm{ref}}(\\mathbf{g}_1)=-0.17942$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_2)=0.05318$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_3)=0.02462$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_4)=0.02462$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_5)=0.01088$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_6)=0.01088$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_7)=-0.05177$\n- $V_{\\mathrm{ref}}(\\mathbf{g}_8)=0.05125$\n\nLet the unknown partial charges be $\\mathbf{q}=[q_{\\mathrm{C}},\\,q_{\\mathrm{O}},\\,q_{\\mathrm{H1}},\\,q_{\\mathrm{H2}}]^{\\top}$ in units of the elementary charge. Determine $\\mathbf{q}$ by minimizing the weighted sum of squared residuals between the modeled potential and the reference values, augmented with an isotropic Tikhonov regularization term:\n$$\n\\min_{\\mathbf{q}} \\; \\sum_{k=1}^{8} w_k \\left( \\sum_{i=1}^{4} \\frac{q_i}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert} - V_{\\mathrm{ref}}(\\mathbf{g}_k) \\right)^2 \\;+\\; \\lambda \\sum_{i=1}^{4} q_i^2\n$$\nsubject to the following exact linear equality constraints:\n1. Molecular neutrality: $q_{\\mathrm{C}}+q_{\\mathrm{O}}+q_{\\mathrm{H1}}+q_{\\mathrm{H2}}=0$.\n2. Hydrogen equivalence: $q_{\\mathrm{H1}}-q_{\\mathrm{H2}}=0$.\n\nAll distances must be treated in bohr, all potentials in atomic units, and all charges in units of the elementary charge. The final fitted charges must be reported in units of the elementary charge as specified below.\n\nTest Suite. Your program must solve the problem for each of the following three test cases, which differ in the nonnegative weights $\\{w_k\\}_{k=1}^8$ and the regularization parameter $\\lambda$:\n- Case A (baseline): $\\mathbf{w}=[1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1]$, $\\lambda=0$.\n- Case B (reweighted, lightly regularized): $\\mathbf{w}=[2,\\,1,\\,1,\\,1,\\,1,\\,1,\\,2,\\,1]$, $\\lambda=0.001$.\n- Case C (sparse emphasis, strongly regularized): $\\mathbf{w}=[0,\\,5,\\,0,\\,0,\\,0,\\,0,\\,0,\\,5]$, $\\lambda=1.000$.\n\nAnswer Specification and Final Output Format. For each test case, compute the fitted charge vector $\\mathbf{q}$ that exactly satisfies the constraints. Express each component of $\\mathbf{q}$ in units of the elementary charge and round each component to six decimal places. Your program should produce a single line of output containing the results as a comma-separated list of three lists, one per test case, in the order $[q_{\\mathrm{C}},q_{\\mathrm{O}},q_{\\mathrm{H1}},q_{\\mathrm{H2}}]$. For example, the required format is\n$[[q_{\\mathrm{C}}^{(A)},q_{\\mathrm{O}}^{(A)},q_{\\mathrm{H1}}^{(A)},q_{\\mathrm{H2}}^{(A)}],[q_{\\mathrm{C}}^{(B)},q_{\\mathrm{O}}^{(B)},q_{\\mathrm{H1}}^{(B)},q_{\\mathrm{H2}}^{(B)}],[q_{\\mathrm{C}}^{(C)},q_{\\mathrm{O}}^{(C)},q_{\\mathrm{H1}}^{(C)},q_{\\mathrm{H2}}^{(C)}]]$ with each scalar rounded to six decimal places and no additional characters. There are no angular quantities in this problem. All answers must be expressed in the specified units and format, aggregated into the single required output line.", "solution": "The problem presented is a constrained quadratic optimization task, a common procedure in computational chemistry known as electrostatic potential (ESP) fitting. We are asked to determine a set of four partial atomic charges $\\mathbf{q} = [q_{\\mathrm{C}},\\,q_{\\mathrm{O}},\\,q_{\\mathrm{H1}},\\,q_{\\mathrm{H2}}]^{\\top}$ for a formaldehyde molecule that best reproduce a given set of quantum mechanical reference potentials. This is a well-posed problem that can be solved analytically.\n\nThe objective is to minimize the cost function $J(\\mathbf{q})$, which consists of a weighted sum of squared residuals and a Tikhonov regularization term:\n$$\nJ(\\mathbf{q}) = \\sum_{k=1}^{M} w_k \\left( V_{\\mathrm{model}}(\\mathbf{g}_k) - V_{\\mathrm{ref}}(\\mathbf{g}_k) \\right)^2 \\;+\\; \\lambda \\sum_{i=1}^{N} q_i^2\n$$\nHere, $M=8$ is the number of field points, and $N=4$ is the number of atoms. The model potential $V_{\\mathrm{model}}(\\mathbf{g}_k)$ generated by the point charges $q_i$ at atomic positions $\\mathbf{R}_i$ is linear in the charges:\n$$\nV_{\\mathrm{model}}(\\mathbf{g}_k) = \\sum_{i=1}^{N} \\frac{q_i}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert}\n$$\nWe can express this relationship in matrix form. Let $\\mathbf{V}_{\\mathrm{ref}} \\in \\mathbb{R}^{M}$ be the vector of reference potential values and $\\mathbf{V}_{\\mathrm{model}} \\in \\mathbb{R}^{M}$ be the vector of model potentials at the field points. Then $\\mathbf{V}_{\\mathrm{model}} = \\mathbf{A}\\mathbf{q}$, where $\\mathbf{A}$ is an $M \\times N$ matrix whose elements are the inverse distances between field points and atomic centers:\n$$\nA_{ki} = \\frac{1}{\\lVert \\mathbf{g}_k-\\mathbf{R}_i\\rVert}\n$$\nThe objective function can be written in matrix algebra as:\n$$\nJ(\\mathbf{q}) = (\\mathbf{A}\\mathbf{q} - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}\\mathbf{q} - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda \\mathbf{q}^{\\top}\\mathbf{I}\\mathbf{q}\n$$\nwhere $\\mathbf{W}$ is an $M \\times M$ diagonal matrix of weights $w_k$, and $\\mathbf{I}$ is the $N \\times N$ identity matrix.\n\nThe minimization is subject to two linear equality constraints:\n1.  Neutrality: $q_{\\mathrm{C}}+q_{\\mathrm{O}}+q_{\\mathrm{H1}}+q_{\\mathrm{H2}}=0$\n2.  Equivalence: $q_{\\mathrm{H1}}-q_{\\mathrm{H2}}=0$\n\nThese constraints reduce the number of independent degrees of freedom in the system. We can solve these constraints to express the $4$ charges in terms of a smaller set of independent variables. From the second constraint, we have $q_{\\mathrm{H1}} = q_{\\mathrm{H2}}$. Let us denote this common charge by $q_{\\mathrm{H}}$. Substituting this into the first constraint gives $q_{\\mathrm{C}} + q_{\\mathrm{O}} + 2q_{\\mathrm{H}} = 0$, which can be rearranged to express $q_{\\mathrm{O}}$ as $q_{\\mathrm{O}} = -q_{\\mathrm{C}} - 2q_{\\mathrm{H}}$.\n\nThus, the entire charge vector $\\mathbf{q} \\in \\mathbb{R}^4$ can be parameterized by a vector of two independent variables, $\\mathbf{q}' = [q_{\\mathrm{C}}, q_{\\mathrm{H}}]^{\\top} \\in \\mathbb{R}^2$. The relationship is a linear transformation $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$, where $\\mathbf{S}$ is a $4 \\times 2$ substitution matrix:\n$$\n\\mathbf{q} = \\begin{pmatrix} q_{\\mathrm{C}} \\\\ q_{\\mathrm{O}} \\\\ q_{\\mathrm{H1}} \\\\ q_{\\mathrm{H2}} \\end{pmatrix} = \\begin{pmatrix} 1 q_{\\mathrm{C}} + 0 q_{\\mathrm{H}} \\\\ -1 q_{\\mathrm{C}} - 2 q_{\\mathrm{H}} \\\\ 0 q_{\\mathrm{C}} + 1 q_{\\mathrm{H}} \\\\ 0 q_{\\mathrm{C}} + 1 q_{\\mathrm{H}} \\end{pmatrix} = \\begin{pmatrix} 1 & 0 \\\\ -1 & -2 \\\\ 0 & 1 \\\\ 0 & 1 \\end{pmatrix} \\begin{pmatrix} q_{\\mathrm{C}} \\\\ q_{\\mathrm{H}} \\end{pmatrix} = \\mathbf{S}\\mathbf{q}'\n$$\nSubstituting $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$ into the objective function transforms the constrained problem in $\\mathbb{R}^4$ into an unconstrained problem in $\\mathbb{R}^2$:\n$$\nJ(\\mathbf{q}') = (\\mathbf{A}\\mathbf{S}\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}\\mathbf{S}\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda (\\mathbf{S}\\mathbf{q}')^{\\top}(\\mathbf{S}\\mathbf{q}')\n$$\nLet us define a reduced $M \\times 2$ geometry matrix $\\mathbf{A}' = \\mathbf{A}\\mathbf{S}$. The objective function becomes:\n$$\nJ(\\mathbf{q}') = (\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}})^{\\top} \\mathbf{W} (\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + \\lambda \\mathbf{q}'^{\\top}\\mathbf{S}^{\\top}\\mathbf{S}\\mathbf{q}'\n$$\nThis is a standard quadratic form. To find the minimum, we compute the gradient with respect to $\\mathbf{q}'$ and set it to zero:\n$$\n\\nabla_{\\mathbf{q}'} J(\\mathbf{q}') = 2\\mathbf{A}'^{\\top}\\mathbf{W}(\\mathbf{A}'\\mathbf{q}' - \\mathbf{V}_{\\mathrm{ref}}) + 2\\lambda\\mathbf{S}^{\\top}\\mathbf{S}\\mathbf{q}' = \\mathbf{0}\n$$\nRearranging the terms yields a $2 \\times 2$ system of linear equations for $\\mathbf{q}'$, known as the normal equations:\n$$\n(\\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}' + \\lambda\\mathbf{S}^{\\top}\\mathbf{S})\\mathbf{q}' = \\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{V}_{\\mathrm{ref}}\n$$\nThis system, of the form $\\mathbf{M}\\mathbf{x} = \\mathbf{b}$, can be reliably solved for $\\mathbf{q}'$. The matrix $\\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}'$ is positive semi-definite and $\\mathbf{S}^{\\top}\\mathbf{S}$ is positive definite. For any $\\lambda \\ge 0$, as long as $\\mathbf{A}'$ has full column rank (which is true for the given geometry), the matrix $\\mathbf{M} = \\mathbf{A}'^{\\top}\\mathbf{W}\\mathbf{A}' + \\lambda\\mathbf{S}^{\\top}\\mathbf{S}$ is positive definite and thus invertible, guaranteeing a unique solution.\n\nThe computational procedure is as follows:\n1.  Construct the matrix $\\mathbf{A}$ from the given atomic coordinates and field points.\n2.  Define the substitution matrix $\\mathbf{S}$.\n3.  For each of the three test cases, define the weight matrix $\\mathbf{W}$ and the regularization parameter $\\lambda$.\n4.  Formulate and solve the $2 \\times 2$ linear system for the independent charge vector $\\mathbf{q}' = [q_{\\mathrm{C}}, q_{\\mathrm{H}}]^{\\top}$.\n5.  Reconstruct the full charge vector $\\mathbf{q}$ using the transformation $\\mathbf{q} = \\mathbf{S}\\mathbf{q}'$.\n6.  Format the resulting charges $[q_{\\mathrm{C}}, q_{\\mathrm{O}}, q_{\\mathrm{H1}}, q_{\\mathrm{H2}}]^{\\top}$ as specified.\n\nThis procedure will be implemented in the provided Python code to compute the solutions for the three test cases.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for partial atomic charges by minimizing a regularized,\n    weighted sum of squared residuals between a force field electrostatic\n    potential and reference values, subject to linear constraints.\n    \"\"\"\n\n    # --- Step 1: Define Givens (in atomic units) ---\n\n    # Atomic positions (bohr), N=4 atoms\n    # Order: C, O, H1, H2\n    R_atoms = np.array([\n        [0.00000, 0.00000, 0.00000],   # C\n        [2.28660, 0.00000, 0.00000],   # O\n        [-1.03935, 1.80099, 0.00000],  # H1\n        [-1.03935, -1.80099, 0.00000]   # H2\n    ])\n\n    # Field points (bohr), M=8 points\n    g_points = np.array([\n        [4.00000, 0.00000, 0.00000],\n        [-4.00000, 0.00000, 0.00000],\n        [0.00000, 4.00000, 0.00000],\n        [0.00000, -4.00000, 0.00000],\n        [0.00000, 0.00000, 4.00000],\n        [0.00000, 0.00000, -4.00000],\n        [3.00000, 3.00000, 0.00000],\n        [-3.00000, -3.00000, 0.00000]\n    ])\n\n    # Reference electrostatic potential (atomic units)\n    V_ref = np.array([\n        -0.17942, 0.05318, 0.02462, 0.02462,\n        0.01088, 0.01088, -0.05177, 0.05125\n    ])\n\n    # Test cases: weights w and regularization parameter lambda\n    test_cases = [\n        # Case A\n        {'w': np.ones(8), 'lambda': 0.0},\n        # Case B\n        {'w': np.array([2., 1., 1., 1., 1., 1., 2., 1.]), 'lambda': 0.001},\n        # Case C\n        {'w': np.array([0., 5., 0., 0., 0., 0., 0., 5.]), 'lambda': 1.000}\n    ]\n\n    # --- Step 2: Formulate the Linear System ---\n\n    # The 4 charges q = [q_C, q_O, q_H1, q_H2] are dependent.\n    # Constraints:\n    # 1. q_H1 - q_H2 = 0  => q_H1 = q_H2 = q_H\n    # 2. q_C + q_O + q_H1 + q_H2 = 0 => q_O = -q_C - 2*q_H\n    # Independent variables are q' = [q_C, q_H].\n    # The transformation is q = S @ q'.\n    S = np.array([\n        [1., 0.],    # q_C = 1*q_C + 0*q_H\n        [-1., -2.],  # q_O = -1*q_C - 2*q_H\n        [0., 1.],    # q_H1 = 0*q_C + 1*q_H\n        [0., 1.]     # q_H2 = 0*q_C + 1*q_H\n    ])\n\n    # Compute the M x N matrix A of inverse distances 1/||g_k - R_i||\n    # Using broadcasting to calculate all distances at once\n    # g_points shape (M, 1, 3), R_atoms shape (1, N, 3)\n    # dists shape (M, N)\n    dists = np.linalg.norm(g_points[:, np.newaxis, :] - R_atoms[np.newaxis, :, :], axis=2)\n    A = 1.0 / dists\n\n    # Compute the reduced M x 2 geometry matrix A' = A @ S\n    A_prime = A @ S\n\n    # Compute the 2 x 2 matrix T = S^T @ S for the regularization term\n    T = S.T @ S\n\n    results = []\n    # --- Step 3: Solve for each test case ---\n    for case in test_cases:\n        w_k = case['w']\n        lambda_reg = case['lambda']\n\n        # Weight matrix W is diagonal\n        W = np.diag(w_k)\n\n        # Form the 2x2 linear system M @ q' = v\n        # M = A'^T @ W @ A' + lambda * S^T @ S\n        M = A_prime.T @ W @ A_prime + lambda_reg * T\n        # v = A'^T @ W @ V_ref\n        v = A_prime.T @ W @ V_ref\n\n        # Solve for the independent variables q' = [q_C, q_H]\n        q_prime = np.linalg.solve(M, v)\n\n        # Reconstruct the full 4-element charge vector q = S @ q'\n        q = S @ q_prime\n        \n        # Round to 6 decimal places for final output\n        rounded_q = [f\"{charge:.6f}\" for charge in q]\n        results.append(rounded_q)\n\n    # --- Step 4: Format and Print Final Output ---\n    # The format is a list of lists: [[...],[...],[...]]\n    case_strings = [f\"[{','.join(res)}]\" for res in results]\n    final_output = f\"[{','.join(case_strings)}]\"\n    print(final_output)\n\nsolve()\n```", "id": "2404445"}]}