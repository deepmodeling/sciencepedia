{"hands_on_practices": [{"introduction": "Birth-death skyline models are a cornerstone of modern phylodynamics, allowing us to estimate how epidemic parameters change over time from genetic data. This practice sharpens your understanding of the fundamental mathematical relationships within these models. By working through the connections between the net diversification rate $r$, the sampling probability $p$, and the effective reproduction number $R_e$, you will build the foundational skills needed to interpret and critique the outputs of sophisticated phylodynamic software [@problem_id:2742387].", "problem": "A directly transmitted RNA virus is modeled using a birth–death process with sampling under a piecewise-constant (skyline) parameterization across three consecutive intervals of durations $\\Delta_1$, $\\Delta_2$, and $\\Delta_3$ (in days). Within each interval, the transmission rate per infectious lineage is $\\lambda_i$, the rate of becoming noninfectious due to recovery or cessation of infectiousness is $\\delta$ (assume constant across all intervals), and sampling with removal occurs at rate $\\psi_i$ (that is, once sampled, a lineage ceases to be infectious). The total removal rate within interval $i$ is therefore $\\delta + \\psi_i$. The effective reproduction number in interval $i$ is defined as the expected number of secondary infections generated by a typical infectious lineage before becoming noninfectious, namely $R_{e,i} = \\lambda_i / (\\delta + \\psi_i)$. The net diversification (lineage growth) rate in interval $i$ is $r_i = \\lambda_i - (\\delta + \\psi_i)$. The skyline output also reports the probability that a removal event is a sampling event in interval $i$, denoted $p_i$, which satisfies $p_i = \\psi_i / (\\delta + \\psi_i)$.\n\nYou are given the following empirically estimated quantities:\n- Constant becoming-noninfectious rate $\\delta = 0.25$ per day.\n- Interval durations: $\\Delta_1 = 20$ days, $\\Delta_2 = 30$ days, $\\Delta_3 = 25$ days.\n- Net diversification rates: $r_1 = 0.10$ per day, $r_2 = -0.05$ per day, $r_3 = 0.02$ per day.\n- Sampling probabilities among removals: $p_1 = 0.20$, $p_2 = 0.50$, $p_3 = 0.33$.\n\nAssume all quantities are piecewise constant within their respective intervals and that the process is well approximated by the birth–death model with sampling as described. Define the time-averaged effective reproduction number over the total observation window $T = \\Delta_1 + \\Delta_2 + \\Delta_3$ as\n$$\\bar{R}_e \\equiv \\frac{1}{T} \\int_0^T R_e(t)\\,dt,$$\nwhere $R_e(t)$ equals $R_{e,i}$ in interval $i$.\n\nCompute $\\bar{R}_e$ using only the definitions provided above and the given data. Express the final answer as a dimensionless number and round your result to four significant figures.", "solution": "The problem statement has been validated and is deemed acceptable. It is a well-posed problem in phylodynamics, grounded in the standard birth–death model with sampling. The provided definitions are consistent, and the data are sufficient to compute a unique solution.\n\nThe objective is to compute the time-averaged effective reproduction number, $\\bar{R}_e$, over a total observation window $T$. The definition provided is:\n$$\n\\bar{R}_e \\equiv \\frac{1}{T} \\int_0^T R_e(t)\\,dt\n$$\nThe total duration of the observation window is $T = \\Delta_1 + \\Delta_2 + \\Delta_3$. Given the interval durations $\\Delta_1 = 20$ days, $\\Delta_2 = 30$ days, and $\\Delta_3 = 25$ days, the total duration is:\n$$\nT = 20 + 30 + 25 = 75 \\text{ days}\n$$\nSince the effective reproduction number $R_e(t)$ is piecewise-constant, with $R_e(t) = R_{e,i}$ for the duration $\\Delta_i$ of interval $i$, the integral can be expressed as a weighted sum:\n$$\n\\bar{R}_e = \\frac{1}{T} \\left( \\Delta_1 R_{e,1} + \\Delta_2 R_{e,2} + \\Delta_3 R_{e,3} \\right)\n$$\nTo compute $\\bar{R}_e$, we must first determine the value of $R_{e,i}$ for each interval $i \\in \\{1, 2, 3\\}$. The problem provides the following definitions:\n1. Net diversification rate: $r_i = \\lambda_i - (\\delta + \\psi_i)$\n2. Effective reproduction number: $R_{e,i} = \\frac{\\lambda_i}{\\delta + \\psi_i}$\n3. Sampling probability: $p_i = \\frac{\\psi_i}{\\delta + \\psi_i}$\n\nFrom definition (1), we can express the transmission rate $\\lambda_i$ as $\\lambda_i = r_i + \\delta + \\psi_i$. Substituting this into definition (2) for $R_{e,i}$ yields:\n$$\nR_{e,i} = \\frac{r_i + \\delta + \\psi_i}{\\delta + \\psi_i} = \\frac{r_i}{\\delta + \\psi_i} + 1\n$$\nThis expression for $R_{e,i}$ depends on the total removal rate, $\\delta + \\psi_i$. This term can be related to the given parameters $\\delta$ and $p_i$ using definition (3). Specifically, we can write:\n$$\n1 - p_i = 1 - \\frac{\\psi_i}{\\delta + \\psi_i} = \\frac{(\\delta + \\psi_i) - \\psi_i}{\\delta + \\psi_i} = \\frac{\\delta}{\\delta + \\psi_i}\n$$\nRearranging this equation gives a direct expression for the total removal rate:\n$$\n\\delta + \\psi_i = \\frac{\\delta}{1 - p_i}\n$$\nNow, we substitute this result back into our expression for $R_{e,i}$:\n$$\nR_{e,i} = \\frac{r_i}{\\left(\\frac{\\delta}{1 - p_i}\\right)} + 1 = \\frac{r_i (1 - p_i)}{\\delta} + 1\n$$\nThis final equation allows for the direct calculation of $R_{e,i}$ using the quantities provided in the problem statement: $r_i$, $p_i$, and the constant $\\delta = 0.25$ per day.\n\nWe now compute $R_{e,i}$ for each of the three intervals.\n\nFor interval $1$:\nGiven $r_1 = 0.10$ and $p_1 = 0.20$.\n$$\nR_{e,1} = \\frac{r_1 (1 - p_1)}{\\delta} + 1 = \\frac{0.10 \\times (1 - 0.20)}{0.25} + 1 = \\frac{0.10 \\times 0.80}{0.25} + 1 = \\frac{0.08}{0.25} + 1 = 0.32 + 1 = 1.32\n$$\n\nFor interval $2$:\nGiven $r_2 = -0.05$ and $p_2 = 0.50$.\n$$\nR_{e,2} = \\frac{r_2 (1 - p_2)}{\\delta} + 1 = \\frac{-0.05 \\times (1 - 0.50)}{0.25} + 1 = \\frac{-0.05 \\times 0.50}{0.25} + 1 = \\frac{-0.025}{0.25} + 1 = -0.10 + 1 = 0.90\n$$\n\nFor interval $3$:\nGiven $r_3 = 0.02$ and $p_3 = 0.33$.\n$$\nR_{e,3} = \\frac{r_3 (1 - p_3)}{\\delta} + 1 = \\frac{0.02 \\times (1 - 0.33)}{0.25} + 1 = \\frac{0.02 \\times 0.67}{0.25} + 1 = \\frac{0.0134}{0.25} + 1 = 0.0536 + 1 = 1.0536\n$$\n\nHaving calculated the values for $R_{e,1}$, $R_{e,2}$, and $R_{e,3}$, we can now compute the time-averaged effective reproduction number $\\bar{R}_e$:\n$$\n\\bar{R}_e = \\frac{1}{75} \\left( (\\Delta_1 R_{e,1}) + (\\Delta_2 R_{e,2}) + (\\Delta_3 R_{e,3}) \\right)\n$$\n$$\n\\bar{R}_e = \\frac{1}{75} \\left( (20 \\times 1.32) + (30 \\times 0.90) + (25 \\times 1.0536) \\right)\n$$\n$$\n\\bar{R}_e = \\frac{1}{75} \\left( 26.4 + 27.0 + 26.34 \\right)\n$$\n$$\n\\bar{R}_e = \\frac{79.74}{75} = 1.0632\n$$\nThe problem requires the final answer to be rounded to four significant figures. The calculated value is $1.0632$. Rounding this to four significant figures gives $1.063$.", "answer": "$$\n\\boxed{1.063}\n$$", "id": "2742387"}, {"introduction": "A core goal of infectious disease epidemiology is to track an epidemic's trajectory through the effective reproductive number, $R_e(t)$. This computational exercise puts you at the heart of modern phylodynamics by tasking you with estimating $R_e(t)$ from two independent data sources: a viral phylogeny and traditional case incidence data. By implementing and comparing these two approaches, you will gain a powerful, first-hand appreciation for how genetic data provides a complementary and robust window into the spread of a pathogen [@problem_id:2414531].", "problem": "You are given a computational task grounded in the phylodynamics of infectious diseases: infer the effective reproductive number $R_e(t)$ of a virus from a time-scaled phylogeny under a birth-death process, and compare it to estimates from case incidence data derived via a renewal equation. The goal is to test reasoning from first principles by connecting fundamental process definitions to algorithmic estimators.\n\nUse only the following fundamental base:\n- A birth-death process with per-lineage birth rate $\\lambda(t)$ and per-lineage removal rate $\\delta(t)$ (which includes all processes that end transmission, such as recovery and sampling with removal), where the expected lifetime under a constant $\\delta$ is $1/\\delta$ and the expected number of transmission events generated by one lineage over its lifetime equals $\\lambda/\\delta$.\n- The net diversification (or epidemic growth) rate defined as $r(t) = \\lambda(t) - \\delta(t)$.\n- The lineage-through-time function $L(t)$ counts the number of lineages present at time $t$ in the reconstructed phylogeny. For approximately exponential growth within a short window, the local slope of $\\log L(t)$ with respect to time approximates the instantaneous net growth rate.\n- The renewal equation for incidence with a known generation time distribution $w(\\tau)$: the expected incidence at time $t$ satisfies $I(t) = \\int_{0}^{\\infty} R_e(t)\\, I(t-\\tau)\\, w(\\tau)\\, d\\tau$. In discrete time with step $\\Delta t$, this becomes a convolution with a discrete kernel.\n\nYour program must:\n1. From a reconstructed, time-scaled phylogeny summarized by a lineage-through-time step function on a regular time grid (unit time step is one day), estimate a piecewise continuous net growth rate $r(t)$ by the centered finite difference of $\\log L(t)$ within a symmetric window of width $2w$ days, where $w$ is a positive integer and time is measured in days. Use this to infer $R_e(t)$ under the assumption of a constant mean infectious period $D$ (in days) for each test case. All time units are days; express any intermediate and final internal calculations consistently in days. \n2. From case incidence data $I(t)$ generated via a discrete-time renewal process with a given generation time distribution $w_s$ (a probability mass function over $s \\in \\{1,2,\\dots,K\\}$ days), compute the instantaneous effective reproductive number using the Cori estimator, which uses $R_e(t) = I(t) / \\sum_{s=1}^{K} I(t-s) w_s$ whenever the denominator is nonzero. Angles are not used in this problem, so no angle unit is required.\n3. Compare the two trajectories of $R_e(t)$ over a common evaluation window by computing the root mean squared error (RMSE) between the phylogeny-based and case-based estimates. The RMSE must be a floating-point number.\n\nImplementation requirements:\n- Construct the phylogeny-derived $L(t)$ deterministically from an expected exponential growth model driven by a prescribed piecewise constant net growth rate $r(t)$ on a one-day grid. Start with $L(0)=1$ lineage and evolve an expected lineage count $L_{\\mathrm{exp}}(t)$ by $L_{\\mathrm{exp}}(t+1) = L_{\\mathrm{exp}}(t)\\,\\exp(r(t))$, then form an integer lineage-through-time curve $L(t)$ by taking the nondecreasing integer floor of $L_{\\mathrm{exp}}(t)$, with a minimum of $1$ lineage at all times. Estimate $r(t)$ from $L(t)$ by the centered finite difference on $\\log L(t)$ over the window $[t-w, t+w]$ with step size $\\Delta t = 1$ day.\n- Generate case incidence $I(t)$ deterministically from the renewal equation $I(t) = R_e(t) \\sum_{s=1}^{\\min(K,t)} I(t-s) w_s$ with an initial seed $I(0)=1$ case, where the “true” $R_e(t)$ used to generate $I(t)$ is the one implied by the prescribed piecewise $r(t)$ and the given $D$ for that test. The generation time distribution $w_s$ must be constructed as a discretized Gamma distribution with shape parameter $\\alpha$ and scale parameter $\\beta$ (mean $\\alpha\\beta$), discretized by probability mass in unit-day bins: $w_s = F(s) - F(s-1)$ for $s \\in \\{1,\\dots,K\\}$, where $F$ is the cumulative distribution function of the continuous Gamma distribution with the given parameters, normalized so that $\\sum_{s=1}^{K} w_s = 1$. All time and distribution parameters are in days.\n- For each test case, compute the RMSE between the phylogeny-based $R_e(t)$ and the case-based $R_e(t)$ over the evaluation index set $t \\in \\{t_{\\min}, \\dots, t_{\\max}\\}$ defined by $t_{\\min} = \\max\\{K, w\\}$ and $t_{\\max} = T - 1 - w$, where $T$ is the total number of days in the time series. Only include times where both estimates are finite real numbers.\n\nTest suite:\nFor each test case $i \\in \\{1,2,3\\}$, the program must use the parameters below. All times are in days, and all rates are per day. The piecewise net growth rate $r(t)$ is defined by segments $(t_{\\mathrm{start}}, t_{\\mathrm{end}}, r)$, inclusive of $t_{\\mathrm{start}}$ and exclusive of $t_{\\mathrm{end}}$, with $t \\in \\{0,1,\\dots,T-1\\}$.\n- Test case $1$:\n  - Total duration $T = 60$.\n  - Infectious period $D = 5$.\n  - Smoothing half-window $w = 3$.\n  - Generation time Gamma parameters $\\alpha = 2.0$, $\\beta = 2.5$ (mean $= 5$), truncated at $K=15$ days.\n  - Net growth segments: $(0,20,0.15)$, $(20,40,0.05)$, $(40,60,0.01)$.\n- Test case $2$:\n  - Total duration $T = 80$.\n  - Infectious period $D = 7$.\n  - Smoothing half-window $w = 5$.\n  - Generation time Gamma parameters $\\alpha = 2.0$, $\\beta = 3.5$ (mean $= 7$), truncated at $K=20$ days.\n  - Net growth segments: $(0,40,0.00)$, $(40,80,0.01)$.\n- Test case $3$:\n  - Total duration $T = 45$.\n  - Infectious period $D = 4$.\n  - Smoothing half-window $w = 4$.\n  - Generation time Gamma parameters $\\alpha = 2.0$, $\\beta = 2.0$ (mean $= 4$), truncated at $K=12$ days.\n  - Net growth segments: $(0,45,0.03)$.\n\nAssumptions to apply uniformly across all test cases:\n- Treat removal as synonymous with becoming noninfectious and assume sampling with removal; use a constant mean infectious period $D$ (so an effective constant removal rate within each test).\n- Use $\\Delta t = 1$ day as the discrete time step throughout.\n- Use the same Gamma generation time distribution to generate and to estimate from incidence.\n\nFinal output format:\n- Your program should produce a single line of output containing the RMSE values for test cases $1$, $2$, and $3$ in order, each rounded to exactly six decimal places, as a comma-separated list enclosed in square brackets. For example, the output must look like $[x_1,x_2,x_3]$ with $x_i$ as floating-point numbers rounded to six decimal places and no additional text.", "solution": "The problem posed is a well-defined exercise in computational phylodynamics, requiring the comparison of two distinct estimators for the effective reproductive number, $R_e(t)$, of an epidemic. The first estimate is derived from a phylogenetic birth-death process, and the second from epidemiological case incidence data via a renewal equation. The problem is scientifically grounded, internally consistent, and provides all necessary parameters and definitions for a unique, verifiable solution. I shall, therefore, proceed with a rigorous, step-by-step derivation and algorithmic design.\n\nThe analysis rests on two fundamental models: the birth-death process for phylogenies and the renewal equation for epidemics. The crucial intellectual step is to establish a formal bridge between them.\n\n**1. Theoretical Foundation: Connecting Phylodynamics and Epidemiology**\n\nA time-scaled phylogeny can be modeled as a birth-death process, where lineages branch (birth) at a rate $\\lambda(t)$ and are removed (death or sampling) at a rate $\\delta(t)$. The net diversification rate, which is the net growth rate of the number of lineages, is defined as:\n$$r(t) = \\lambda(t) - \\delta(t)$$\nIn epidemiology, the effective reproductive number, $R_e(t)$, is the average number of new infections caused by a single infected individual at time $t$. Under the assumption of a constant mean infectious period, $D$, the removal rate $\\delta$ is constant and equal to the inverse of this period, $\\delta = 1/D$. The quantity $R_e(t)$ is equivalent to the expected number of transmissions a lineage causes during its lifetime, which is the ratio of the birth rate to the removal rate:\n$$R_e(t) = \\frac{\\lambda(t)}{\\delta(t)}$$\nBy substituting $\\lambda(t) = r(t) + \\delta(t)$ into the expression for $R_e(t)$, and using $\\delta = 1/D$, we derive the key bridging equation:\n$$R_e(t) = \\frac{r(t) + \\delta}{\\delta} = \\frac{r(t)}{1/D} + 1 = D \\cdot r(t) + 1$$\nThis equation allows for the direct conversion between the phylodynamic growth rate $r(t)$ and the epidemiological reproductive number $R_e(t)$. This \"true\" $R_e(t)$ will be used to generate synthetic incidence data.\n\n**2. Phylogeny-Based Estimation of $R_e(t)$**\n\nThe first task is to estimate $R_e(t)$ from a phylogenetic reconstruction, summarized by the lineage-through-time (LTT) function, $L(t)$.\n\n_Step 2.1: Generation of Synthetic LTT Data_\nWe first generate a synthetic LTT curve from the given piecewise-constant growth rate $r(t)$. Starting with a single lineage, $L_{\\mathrm{exp}}(0) = 1$, the expected number of lineages evolves according to:\n$$L_{\\mathrm{exp}}(t+1) = L_{\\mathrm{exp}}(t) \\cdot \\exp(r(t))$$\nfor a discrete time step $\\Delta t = 1$ day. To create a more realistic integer-valued and non-decreasing LTT curve, $L(t)$, we take the floor of the expected value, ensuring it never decreases:\n$$L(0) = \\max(1, \\lfloor L_{\\mathrm{exp}}(0) \\rfloor)$$\n$$L(t) = \\max(L(t-1), \\lfloor L_{\\mathrm{exp}}(t) \\rfloor) \\quad \\text{for } t > 0$$\n\n_Step 2.2: Estimation of $r(t)$ and $R_e(t)$_\nFrom the generated $L(t)$ curve, we estimate the growth rate $r_{\\text{est}}(t)$. The logarithm of the LTT, $\\log L(t)$, grows approximately linearly with rate $r(t)$. We can estimate this rate using a centered finite-difference approximation for the derivative over a symmetric window of half-width $w$:\n$$r_{\\text{est}}(t) \\approx \\frac{\\log L(t+w) - \\log L(t-w)}{2w}$$\nThis estimator is valid for times $t$ within the interval $[w, T-1-w]$, where $T$ is the total duration. Using the bridging equation, the phylogeny-based estimate for the reproductive number is:\n$$R_{e, \\text{phylo}}(t) = D \\cdot r_{\\text{est}}(t) + 1$$\n\n**3. Incidence-Based Estimation of $R_e(t)$**\n\nThe second task involves estimating $R_e(t)$ from daily case incidence data, $I(t)$, using a method based on the renewal equation.\n\n_Step 3.1: Generation of Synthetic Incidence Data_\nFirst, we require a generation time distribution, which is the probability distribution for the time between successive infections. This is constructed by discretizing a Gamma distribution with given shape $\\alpha$ and scale $\\beta$ parameters. The probability mass $w_s$ for each day $s \\in \\{1, \\dots, K\\}$ is the difference in the cumulative distribution function (CDF), $F(\\cdot)$, at the day's boundaries, followed by normalization:\n$$w_s' = F(s; \\alpha, \\beta) - F(s-1; \\alpha, \\beta)$$\n$$w_s = \\frac{w_s'}{\\sum_{j=1}^{K} w_j'}$$\nWith an initial seed of $I(0)=1$, the incidence curve $I(t)$ is generated deterministically using the discrete renewal equation, driven by the true $R_e(t)$ derived in Section 1:\n$$I(t) = R_e(t) \\sum_{s=1}^{\\min(K, t)} I(t-s) w_s$$\n\n_Step 3.2: Estimation of $R_e(t)$_\nTo estimate the reproductive number from the generated incidence data, we use the Cori estimator, which inverts the renewal equation. For any time $t \\geq K$, the estimate is:\n$$R_{e, \\text{case}}(t) = \\frac{I(t)}{\\sum_{s=1}^{K} I(t-s) w_s}$$\nThe denominator represents the total infectiousness of all individuals infected in the past who could be contributing to infections at time $t$.\n\n**4. Quantitative Comparison**\n\nFinally, the two estimators are compared by computing the Root Mean Squared Error (RMSE) between their respective $R_e(t)$ trajectories. The comparison is performed over a common evaluation window $[t_{\\min}, t_{\\max}]$, where $t_{\\min} = \\max(K, w)$ and $t_{\\max} = T-1-w$. This ensures that both estimates are defined and have matured past initial boundary effects. The RMSE is given by:\n$$\\text{RMSE} = \\sqrt{\\frac{1}{N} \\sum_{t=t_{\\min}}^{t_{\\max}} \\left( R_{e, \\text{phylo}}(t) - R_{e, \\text{case}}(t) \\right)^2}$$\nwhere $N = t_{\\max} - t_{\\min} + 1$ is the number of points in the evaluation window. This metric provides a robust measure of the average discrepancy between the two independent estimation methods.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import gamma\n\ndef run_test_case(T, D, w, alpha, beta, K, r_segments):\n    \"\"\"\n    Runs a single test case for estimating Re(t) and computing RMSE.\n    \n    This function implements the full pipeline:\n    1. Generates \"true\" r(t) and Re(t).\n    2. Generates phylogenetic L(t) data and estimates Re_phylo(t).\n    3. Generates incidence I(t) data and estimates Re_case(t).\n    4. Computes the RMSE between the two estimates over the valid window.\n    \"\"\"\n    # Step 1: Define \"true\" dynamics from problem-specified piecewise rates.\n    r_true = np.zeros(T)\n    for start, end, rate in r_segments:\n        r_true[start:end] = rate\n    \n    # The \"true\" Re(t) is derived from r(t) using the formula Re(t) = D*r(t) + 1.\n    Re_true = D * r_true + 1\n\n    # Step 2: Phylogeny-based estimation.\n    # 2a. Generate lineage-through-time (LTT) data L(t).\n    L_exp = np.zeros(T)\n    L_exp[0] = 1.0\n    for t in range(T - 1):\n        L_exp[t + 1] = L_exp[t] * np.exp(r_true[t])\n    \n    L = np.zeros(T, dtype=np.int64)\n    L[0] = max(1, int(np.floor(L_exp[0])))\n    for t in range(1, T):\n        L[t] = max(L[t - 1], int(np.floor(L_exp[t])))\n        \n    # 2b. Estimate r_est(t) from L(t) and then compute Re_phylo(t).\n    Re_phylo = np.full(T, np.nan)\n    # The centered finite difference is calculated over a 2w window.\n    for t in range(w, T - w):\n        # L(t) is guaranteed to be >= 1, so log argument is positive.\n        log_L_t_plus_w = np.log(L[t + w])\n        log_L_t_minus_w = np.log(L[t - w])\n        r_est_t = (log_L_t_plus_w - log_L_t_minus_w) / (2 * w)\n        Re_phylo[t] = D * r_est_t + 1\n\n    # Step 3: Incidence-based estimation.\n    # 3a. Construct the discretized Gamma generation time distribution w_s.\n    s_vals = np.arange(1, K + 1)\n    w_s_unnormalized = gamma.cdf(s_vals, a=alpha, scale=beta) - gamma.cdf(s_vals - 1, a=alpha, scale=beta)\n    w_s = w_s_unnormalized / np.sum(w_s_unnormalized)\n\n    # 3b. Generate case incidence data I(t) using the renewal equation.\n    I = np.zeros(T)\n    I[0] = 1.0\n    for t in range(1, T):\n        limit = min(K, t)\n        # The sum is over past infections, weighted by the generation time PMF.\n        # w_s is 1-indexed (s=1..K), so array is 0-indexed.\n        sum_val = sum(I[t - s] * w_s[s - 1] for s in range(1, limit + 1))\n        I[t] = Re_true[t] * sum_val\n    \n    # 3c. Estimate Re_case(t) using the Cori estimator.\n    Re_case = np.full(T, np.nan)\n    # The denominator is a convolution of past incidence with reversed w_s.\n    for t in range(K, T):\n      denominator = np.dot(I[t - K : t], w_s[::-1])\n      if denominator > 1e-12: # Avoid division by small numbers.\n          Re_case[t] = I[t] / denominator\n          \n    # Step 4: Compare estimates and calculate RMSE.\n    t_min = max(K, w)\n    t_max = T - 1 - w\n\n    # Extract the slices of the Re estimates over the common evaluation window.\n    phylo_slice = Re_phylo[t_min : t_max + 1]\n    case_slice = Re_case[t_min : t_max + 1]\n    \n    # Filter for finite values, although not expected in these test cases.\n    valid_indices = np.isfinite(phylo_slice) & np.isfinite(case_slice)\n    phylo_valid = phylo_slice[valid_indices]\n    case_valid = case_slice[valid_indices]\n    \n    if len(phylo_valid) == 0:\n        return 0.0 # Should not happen with valid test cases.\n    \n    squared_errors = (phylo_valid - case_valid) ** 2\n    rmse = np.sqrt(np.mean(squared_errors))\n    \n    return rmse\n\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run them, and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"T\": 60, \"D\": 5, \"w\": 3, \"alpha\": 2.0, \"beta\": 2.5, \"K\": 15,\n            \"r_segments\": [(0, 20, 0.15), (20, 40, 0.05), (40, 60, 0.01)]\n        },\n        {\n            \"T\": 80, \"D\": 7, \"w\": 5, \"alpha\": 2.0, \"beta\": 3.5, \"K\": 20,\n            \"r_segments\": [(0, 40, 0.00), (40, 80, 0.01)]\n        },\n        {\n            \"T\": 45, \"D\": 4, \"w\": 4, \"alpha\": 2.0, \"beta\": 2.0, \"K\": 12,\n            \"r_segments\": [(0, 45, 0.03)]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_test_case(**case)\n        results.append(result)\n\n    # Format the final output string exactly as required.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2414531"}, {"introduction": "Beyond simply measuring an epidemic's growth rate, phylogenies can reveal *how* a pathogen is spreading through a population. This exercise challenges you to develop your \"tree-thinking\" skills by exploring how different transmission patterns, from homogeneous spread to explosive superspreading events, leave distinct signatures on the shape and structure of a phylogenetic tree. Understanding these patterns is crucial for interpreting the rich narrative of an outbreak written in the genomes of the pathogen itself [@problem_id:2414547].", "problem": "You are comparing two outbreaks of the same virus that occurred in similar host populations and under similar public health conditions. In both outbreaks, the mean number of secondary infections per primary case is the same, but the dispersion of that number differs. Specifically, let the number of secondary infections per primary case be modeled by a negative binomial distribution with mean basic reproduction number $R_0$ and dispersion parameter $k$, so that the variance is $R_0 + R_0^2/k$. Outbreak $\\mathcal{S}$ has $R_0$ equal to that of outbreak $\\mathcal{H}$, but $k_{\\mathcal{S}} \\ll 1$ (superspreading, high variance) while outbreak $\\mathcal{H}$ has $k_{\\mathcal{H}} \\to \\infty$ (approximately Poisson, homogeneous transmission). From each outbreak, $n$ viral genomes are sampled over the same calendar time window and under similar sampling protocols (constant sampling probability $\\rho$ over time), and a time-scaled phylogeny is reconstructed under the same strict molecular clock with rate $\\mu$.\n\nUsing only first principles from branching processes and coalescent theory, reason about how heterogeneity in the offspring distribution affects the shape of the reconstructed transmission phylogeny. Which set of qualitative tree-shape signatures would most strongly indicate that an observed tree came from outbreak $\\mathcal{S}$ rather than from outbreak $\\mathcal{H}$, holding $R_0$, $\\mu$, $n$, $\\rho$, and the sampling time window fixed in expectation?\n\nA. Markedly higher topological imbalance (for example, larger values of indices like the Colless or Sackin index), greater variance in internal branch lengths with clusters of very short internodes near certain internal nodes, and more ladder-like subtrees, while mean root-to-tip distances remain comparable given the same clock rate and sampling times.\n\nB. Lower topological imbalance with internal branch lengths of more uniform duration across the tree, and a topology closer to a balanced Yule tree.\n\nC. Systematically shorter mean root-to-tip distances under the same clock rate and sampling times, because superspreading compresses the tree height.\n\nD. Larger mean pairwise genetic distances among contemporaneous tips purely due to superspreading, even when $R_0$, $\\mu$, $n$, $\\rho$, and the sampling time window are the same.", "solution": "The problem statement is scientifically grounded, well-posed, and objective. It provides a valid theoretical setup for comparing the phylodynamic consequences of homogeneous versus heterogeneous disease transmission, based on established principles of epidemiology and coalescent theory. All parameters and models used are standard in the field of computational biology. I will now proceed with the solution.\n\nThe core of the problem lies in understanding how the statistical distribution of the number of secondary infections (the offspring distribution) shapes the genealogy of the pathogen population. The genealogy is represented by a time-scaled phylogeny reconstructed from sampled viral genomes. The link between the epidemiological process (a forward-in-time branching process) and the phylogeny (inferred by a backward-in-time coalescent process) is fundamental.\n\nLet the number of secondary infections caused by a single infected individual be a random variable $X$. The problem states this follows a negative binomial distribution with mean $E[X] = R_0$ and variance $\\text{Var}(X) = \\sigma^2 = R_0 + R_0^2/k$. The parameter $k$ is the dispersion parameter.\n\nIn coalescent theory for branching processes, the rate at which any pair of lineages coalesces (finds a common ancestor) is inversely proportional to the effective population size, $N_e$. The effective population size is itself inversely proportional to the variance of the offspring distribution, $\\sigma^2$. Specifically, the rate of coalescence for a pair of lineages is proportional to $\\sigma^2 / N(t)$, where $N(t)$ is the number of infected individuals at time $t$. A higher variance in offspring numbers leads to a smaller effective population size and thus a higher rate of coalescence, for a given census population size $N(t)$.\n\nLet us analyze the two scenarios:\n\n1.  **Outbreak $\\mathcal{H}$ (Homogeneous Transmission):**\n    The dispersion parameter $k_{\\mathcal{H}} \\to \\infty$. In this limit, the negative binomial distribution converges to a Poisson distribution. The variance of the offspring distribution becomes $\\sigma^2_{\\mathcal{H}} = \\lim_{k \\to \\infty} (R_0 + R_0^2/k) = R_0$. This scenario represents a process where each infected individual has roughly the same propensity to transmit the virus. Tracing ancestry backward in time, the probability that any two lineages coalesce in a specific parent is relatively uniform across all possible parent-offspring transmission events. This leads to a more regular and balanced coalescent process, akin to a Yule (pure-birth) process. The resulting phylogeny is expected to be topologically balanced, with internal branch lengths (internode durations) of more uniform length.\n\n2.  **Outbreak $\\mathcal{S}$ (Superspreading):**\n    The dispersion parameter $k_{\\mathcal{S}} \\ll 1$. The variance of the offspring distribution is $\\sigma^2_{\\mathcal{S}} = R_0 + R_0^2/k_{\\mathcal{S}}$. Since $k_{\\mathcal{S}}$ is small, the term $R_0^2/k_{\\mathcal{S}}$ is large, and thus the variance $\\sigma^2_{\\mathcal{S}}$ is much greater than the mean $R_0$. This corresponds to a situation where most individuals cause few or no secondary infections, while a small minority of \"superspreaders\" cause a large number of secondary infections.\n    This high variance $\\sigma^2_{\\mathcal{S}}$ leads to a much higher rate of coalescence compared to outbreak $\\mathcal{H}$. This has two major consequences for the tree shape:\n    *   **Topological Imbalance:** A superspreading event, where one individual infects many others, corresponds to a single node in the phylogeny that is the direct ancestor of many sampled lineages. This creates highly asymmetric, \"star-like\" or \"comb-like\" patterns. Many lineages coalesce almost simultaneously (looking backward in time) at these superspreader nodes. This results in a highly imbalanced tree topology, which would be quantified by large values of imbalance indices such as the Colless index or Sackin index.\n    *   **Branch Length Distribution:** The near-simultaneous coalescence of lineages descending from a superspreader results in a cluster of very short internal branches (internodes). In contrast, the branches connecting these major transmission clusters (which trace back to ancestors before the major superspreading events) can be very long. This leads to a high variance in the distribution of internal branch lengths.\n\nNow, we evaluate each option:\n\n**A. Markedly higher topological imbalance (for example, larger values of indices like the Colless or Sackin index), greater variance in internal branch lengths with clusters of very short internodes near certain internal nodes, and more ladder-like subtrees, while mean root-to-tip distances remain comparable given the same clock rate and sampling times.**\nThis option accurately describes the consequences of superspreading derived above.\n*   \"Markedly higher topological imbalance... larger values of indices like the Colless or Sackin index\": Correct. This is the direct result of superspreading events creating star-like nodes.\n*   \"greater variance in internal branch lengths with clusters of very short internodes\": Correct. This reflects the rapid coalescence within transmission clusters versus the longer waits for coalescence between clusters.\n*   \"more ladder-like subtrees\": Correct. This is another description of an imbalanced topology.\n*   \"mean root-to-tip distances remain comparable\": This is a reasonable statement. While the higher coalescence rate in $\\mathcal{S}$ will tend to shorten the overall time to the most recent common ancestor (TMRCA), the dominant and most distinguishing features are the topological and branch length signatures. The overall timescale of the epidemic is primarily set by the growth rate (related to $R_0$) and the duration of observation, which are the same for both outbreaks. Thus, treating the root-to-tip distances as \"comparable\" while highlighting the profound changes in shape is an appropriate way to characterize the strongest signals.\nThe collection of signatures presented in this option provides a strong and comprehensive fingerprint for a superspreader-driven outbreak.\nVerdict: **Correct**.\n\n**B. Lower topological imbalance with internal branch lengths of more uniform duration across the tree, and a topology closer to a balanced Yule tree.**\nThis option describes the expected phylogeny for the homogeneous outbreak $\\mathcal{H}$. It is the opposite of what is expected for the superspreading outbreak $\\mathcal{S}$.\nVerdict: **Incorrect**.\n\n**C. Systematically shorter mean root-to-tip distances under the same clock rate and sampling times, because superspreading compresses the tree height.**\nThe reasoning is not entirely wrong. As argued, the higher variance $\\sigma^2_{\\mathcal{S}}$ increases the coalescence rate, which does tend to reduce the TMRCA of the sample, thereby shortening the tree and the mean root-to-tip distance. However, this option is incomplete. It focuses on a single metric (mean root-to-tip distance) and ignores the more dramatic and characteristic signatures of topology and branch length distribution. The question asks for the \"set of qualitative tree-shape signatures\" that \"most strongly indicate\" outbreak $\\mathcal{S}$. Option A provides a much richer and more robust set of such signatures. While C is a likely consequence, it is not the most defining characteristic compared to the features in A.\nVerdict: **Incorrect**.\n\n**D. Larger mean pairwise genetic distances among contemporaneous tips purely due to superspreading, even when $R_0$, $\\mu$, $n$, $\\rho$, and the sampling time window are the same.**\nMean pairwise genetic distance is proportional to the average time to the most recent common ancestor over all pairs of tips $(\\overline{T_2})$. A higher rate of coalescence, which is characteristic of outbreak $\\mathcal{S}$, means that lineages find common ancestors more quickly (i.e., more recently in the past). This leads to a *smaller* average TMRCA for pairs, and therefore *smaller* mean pairwise genetic distances, not larger. This statement makes a claim opposite to the theoretical expectation.\nVerdict: **Incorrect**.\n\nIn summary, Option A provides the most accurate and comprehensive set of qualitative signatures that distinguish a phylogeny from a superspreading outbreak.", "answer": "$$\\boxed{A}$$", "id": "2414547"}]}