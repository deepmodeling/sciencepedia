{
    "hands_on_practices": [
        {
            "introduction": "本练习将使用广泛应用的通用土壤流失方程（USLE），对可变面积单元问题（MAUP）进行具体的动手实践。通过将这个非线性模型应用于不同分区方案下聚合的数据，您将直接计算和量化“尺度效应”和“分区效应”，并观察估算的全域土壤流失量如何随空间单元选择的变化而改变。该实践旨在建立对MAUP在环境建模中如何产生的基本数值理解。",
            "id": "3847664",
            "problem": "您将获得源自遥感和辅助数据的栅格输入，用于根据通用水土流失方程（USLE）及其修订版（Revised Universal Soil Loss Equation, RUSLE）评估土壤流失。目标是通过计算多种空间分区方案下的区域土壤流失，并分析因空间划分方式改变而引入的方差，从而量化可变面积单元问题（MAUP）。您的推导必须基于标准解释，即一个地点的单位面积年土壤流失量（记为 $A$）与代表降雨侵蚀力、土壤可蚀性、地形、植被覆盖与管理以及水土保持措施的因子呈乘积关系。除此乘积解释外，请勿假设任何非标准依赖关系。所有计算都必须在每个栅格单元面积相等的假设下进行。所有土壤流失率以吨/公顷/年（$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）表示，方差以 $(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$ 表示。计算中不涉及角度。\n\n基本原理：\n- 通用水土流失方程（USLE）和修订版通用水土流失方程（RUSLE）是经过充分检验的经验模型，其中一个地点的单位面积年土壤流失量 $A$ 取决于降雨-径流侵蚀力因子 $R$、土壤可蚀性因子 $K$、地形因子 $LS$、植被覆盖与管理因子 $C$ 以及水土保持措施因子 $P$。每个因子都是非负的，根据管理效益和保护性植被覆盖分数的定义，$C$ 和 $P$ 是界于 $[0,1]$ 之间的无量纲标量。$LS$ 因子是无量纲的，它综合了坡长和坡度的影响。在点尺度上，这五个因子之间是乘积关系。请仅使用此解释以及平均和方差的计算规则来推导所要求的量。\n\n数据集：\n- 一个 $4 \\times 4$ 的栅格（行从上到下索引，列从左到右索引），包含以下因子值：\n    - 降雨-径流侵蚀力因子 $R$（单位：$\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}$）：\n      行 $1$：$[320, 280, 400, 360]$；行 $2$：$[300, 260, 420, 380]$；行 $3$：$[340, 290, 410, 370]$；行 $4$：$[310, 270, 390, 350]$。\n      具体矩阵如下：\n      $\\begin{bmatrix}\n      320  280  400  360 \\\\\n      300  260  420  380 \\\\\n      340  290  410  370 \\\\\n      310  270  390  350\n      \\end{bmatrix}$。\n    - 土壤可蚀性因子 $K$（单位：$\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}$）：\n      $\\begin{bmatrix}\n      0.18  0.12  0.20  0.15 \\\\\n      0.22  0.10  0.25  0.16 \\\\\n      0.19  0.11  0.21  0.14 \\\\\n      0.17  0.13  0.23  0.18\n      \\end{bmatrix}$。\n    - 地形因子 $LS$（无量纲）：\n      $\\begin{bmatrix}\n      1.5  0.8  2.0  1.2 \\\\\n      1.8  0.7  2.2  1.3 \\\\\n      1.6  0.9  2.1  1.1 \\\\\n      1.4  0.85  1.9  1.0\n      \\end{bmatrix}$。\n    - 植被覆盖与管理因子 $C$（无量纲）：\n      $\\begin{bmatrix}\n      0.25  0.10  0.35  0.20 \\\\\n      0.30  0.08  0.40  0.22 \\\\\n      0.28  0.12  0.33  0.18 \\\\\n      0.26  0.11  0.31  0.16\n      \\end{bmatrix}$。\n    - 水土保持措施因子 $P$（无量纲）：\n      $\\begin{bmatrix}\n      0.90  0.60  0.80  0.70 \\\\\n      1.00  0.50  0.90  0.80 \\\\\n      0.95  0.65  0.85  0.75 \\\\\n      0.92  0.62  0.88  0.78\n      \\end{bmatrix}$。\n\n分区方案（区域标识符为整数；单元面积相等）：\n- 方案 $\\mathcal{Z}_A$（每个单元自成一个区域）：\n  $\\begin{bmatrix}\n  0  1  2  3 \\\\\n  4  5  6  7 \\\\\n  8  9  10  11 \\\\\n  12  13  14  15\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_B$（$2 \\times 2$ 的块，产生 $4$ 个区域）：\n  $\\begin{bmatrix}\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  2  2  3  3 \\\\\n  2  2  3  3\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_C$（垂直对半划分，产生 $2$ 个区域）：\n  $\\begin{bmatrix}\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  0  0  1  1\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_D$（覆盖整个栅格的单个区域）：\n  $\\begin{bmatrix}\n  0  0  0  0 \\\\\n  0  0  0  0 \\\\\n  0  0  0  0 \\\\\n  0  0  0  0\n  \\end{bmatrix}$。\n\n任务：\n- 仅使用通用水土流失方程因子在单元格级别的乘积解释，推导并实现一个程序来：\n  1. 在原始栅格上计算每个单元的土壤流失量 $A$。\n  2. 计算基准区域平均土壤流失量 $A_{\\mathrm{base}}$，即所有 $16$ 个单元的土壤流失量 $A$ 的算术平均值（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n  3. 对于每个分区方案 $\\mathcal{Z}_i \\in \\{\\mathcal{Z}_A, \\mathcal{Z}_B, \\mathcal{Z}_C, \\mathcal{Z}_D\\}$：\n     - 对于 $\\mathcal{Z}_i$ 中的每个区域 $z$，计算属于该区域 $z$ 的所有单元上每个因子 $R$、$K$、$LS$、$C$、$P$ 的区域平均值。\n     - 在区域级别上使用相同的乘积解释，根据各因子的区域平均值计算区域级别的土壤流失量 $A_z$。\n     - 计算方案 $\\mathcal{Z}_i$ 的区域平均土壤流失量 $A_i$，即所有区域 $A_z$ 的面积加权平均值（权重等于每个区域内的单元格数量）。\n  4. 通过对集合 $\\{A_B, A_C, A_D\\}$（不包括 $\\mathcal{Z}_A$，因其根据构造与基准值一致）进行计算，量化 MAUP 的影响：\n     - 样本方差 $V$，除数为 $n-1$，即当 $n=3$ 时的无偏估计量（单位：$(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$）。\n     - 平均绝对偏差 $\\overline{|\\Delta|}$，定义为当 $i \\in \\{B,C,D\\}$ 时 $|A_i - A_{\\mathrm{base}}|$ 的算术平均值（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n     - 最大绝对偏差 $\\max|\\Delta|$，定义为 $\\max_{i \\in \\{B,C,D\\}} |A_i - A_{\\mathrm{base}}|$（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n\n角度单位不适用。所有土壤流失输出必须以 $\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$ 为单位进行解释，方差以 $(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$ 为单位进行解释。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果按以下顺序排列：\n$[A_{\\mathrm{base}}, A_A, A_B, A_C, A_D, V, \\overline{|\\Delta|}, \\max|\\Delta|]$。\n不要在打印行中包含单位；数值必须打印为浮点数。您可以四舍五入到六位小数。",
            "solution": "在尝试求解之前，对问题陈述的有效性进行评估。\n\n### 步骤 1：提取已知条件\n\n问题提供了以下数据和定义：\n\n*   **模型**：单位面积年土壤流失量 $A$ 由乘法模型 $A = R \\times K \\times LS \\times C \\times P$ 给出。所有因子均为非负。$C, P \\in [0, 1]$。$LS$ 是无量纲的。所有栅格单元面积相等。\n*   **单位**：$A$ 的单位是 $\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$。$R$ 的单位是 $\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}$。$K$ 的单位是 $\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}$。$LS, C, P$ 是无量纲的。\n*   **因子数据栅格**：为因子 $R$, $K$, $LS$, $C$ 和 $P$ 提供了五个 $4 \\times 4$ 矩阵。\n    *   $R = \\begin{bmatrix} 320  280  400  360 \\\\ 300  260  420  380 \\\\ 340  290  410  370 \\\\ 310  270  390  350 \\end{bmatrix}$\n    *   $K = \\begin{bmatrix} 0.18  0.12  0.20  0.15 \\\\ 0.22  0.10  0.25  0.16 \\\\ 0.19  0.11  0.21  0.14 \\\\ 0.17  0.13  0.23  0.18 \\end{bmatrix}$\n    *   $LS = \\begin{bmatrix} 1.5  0.8  2.0  1.2 \\\\ 1.8  0.7  2.2  1.3 \\\\ 1.6  0.9  2.1  1.1 \\\\ 1.4  0.85  1.9  1.0 \\end{bmatrix}$\n    *   $C = \\begin{bmatrix} 0.25  0.10  0.35  0.20 \\\\ 0.30  0.08  0.40  0.22 \\\\ 0.28  0.12  0.33  0.18 \\\\ 0.26  0.11  0.31  0.16 \\end{bmatrix}$\n    *   $P = \\begin{bmatrix} 0.90  0.60  0.80  0.70 \\\\ 1.00  0.50  0.90  0.80 \\\\ 0.95  0.65  0.85  0.75 \\\\ 0.92  0.62  0.88  0.78 \\end{bmatrix}$\n*   **分区方案**：通过区域标识符矩阵定义了 $4 \\times 4$ 栅格的四种划分方案。\n    *   $\\mathcal{Z}_A$：每个单元是一个区域。\n    *   $\\mathcal{Z}_B$：$2 \\times 2$ 的块。\n    *   $\\mathcal{Z}_C$：垂直对半划分。\n    *   $\\mathcal{Z}_D$：整个栅格为一个区域。\n*   **任务**：\n    1.  计算逐单元的土壤流失量 $A$。\n    2.  计算基准区域平均土壤流失量 $A_{\\mathrm{base}}$，作为逐单元 $A$ 的平均值。\n    3.  对于每个方案 $\\mathcal{Z}_i$，通过先在区域内对因子进行平均，然后应用乘法模型，最后对区域结果进行面积加权平均来计算区域平均值 $A_i$。\n    4.  计算可变面元问题（MAUP）影响的三个度量：样本方差 $V$、平均绝对偏差 $\\overline{|\\Delta|}$ 和最大绝对偏差 $\\max|\\Delta|$，针对集合 $\\{A_B, A_C, A_D\\}$ 相对于 $A_{\\mathrm{base}}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n\n*   **科学依据**：该问题基于成熟的 USLE/RUSLE 土壤侵蚀建模方法。乘法形式 $A = RKLSCP$ 是标准的。各因子的单位是一致的：$[R] \\times [K]$ 的乘积得到 $(\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}) \\times (\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}) = \\mathrm{t \\, ha^{-1} \\, yr^{-1}}$，这是土壤流失率 $A$ 的正确单位。提供的因子值是合理的。MAUP 的概念是空间分析中一个基本且有充分文献记载的问题。\n*   **适定性**：问题被完全指定。所有必要的数据（因子栅格、分区方案）和计算过程都被明确定义。可以计算出唯一、稳定的数值解。\n*   **客观性**：问题陈述使用了精确、客观和正式的语言。它要求进行一系列具体的计算，没有任何主观解释的余地。\n\n该问题没有表现出任何科学上不健全、不完整、矛盾或模糊等缺陷。这些任务是演示 MAUP 的标准分析的直接和正式的实现。\n\n### 步骤 3：结论与行动\n\n问题是 **有效的**。将推导并实现一个解决方案。\n\n目标是在通用水土流失方程（USLE）的背景下，量化可变面元问题（MAUP）。问题的核心在于求平均值和应用非线性函数的不可交换性。USLE 模型在其多因子结构（它是变量的乘积）中是非线性的，因此乘积的平均值不等于平均值的乘积。\n\n栅格上特定位置 $(i, j)$ 的单位面积土壤流失的基本关系是：\n$$\nA_{ij} = R_{ij} K_{ij} LS_{ij} C_{ij} P_{ij}\n$$\n其中 $i \\in \\{0, 1, 2, 3\\}$ 和 $j \\in \\{0, 1, 2, 3\\}$ 是栅格单元的行和列索引。\n\n**1. 逐单元土壤流失与基准平均值 ($A_{\\mathrm{base}}$)**\n\n首先，我们使用提供的因子数据计算栅格中 16 个单元中每个单元的土壤流失。这将生成一个 $4 \\times 4$ 的土壤流失值栅格 $A_{ij}$。\n\n基准区域平均土壤流失量 $A_{\\mathrm{base}}$ 定义为在最精细的可用分辨率（单元格级别）上计算的整个区域的真实平均土壤流失量。由于所有单元格面积相等，因此这是逐单元土壤流失值的简单算术平均值。对于一个大小为 $N \\times M$ 的栅格（这里是 $4 \\times 4$，即 16 个单元）：\n$$\nA_{\\mathrm{base}} = \\frac{1}{NM} \\sum_{i=0}^{N-1} \\sum_{j=0}^{M-1} A_{ij}\n$$\n该值代表了给定输入数据下对区域土壤流失最准确的估计。\n\n**2. 区域聚合与方案级平均值 ($A_i$)**\n\nMAUP 分析通过在不同的空间聚合（分区方案）下重新计算区域平均土壤流失来进行。对于每个方案 $\\mathcal{Z}_i \\in \\{\\mathcal{Z}_A, \\mathcal{Z}_B, \\mathcal{Z}_C, \\mathcal{Z}_D\\}$，过程如下：\n\n对于方案 $\\mathcal{Z}_i$ 内的每个区域 $z$，我们首先计算每个 USLE 因子的平均值。设 $S_z$ 是属于区域 $z$ 的单元索引 $(i, j)$ 的集合，而 $|S_z|$ 是该区域中的单元数。一个因子 $F$（其中 $F$ 可以是 $R, K, LS, C$ 或 $P$）的区域平均值为：\n$$\n\\overline{F}_z = \\frac{1}{|S_z|} \\sum_{(i,j) \\in S_z} F_{ij}\n$$\n接下来，通过将 USLE 模型应用于这些平均后的因子，为整个区域计算一个单一的土壤流失值 $A_z$：\n$$\nA_z = \\overline{R}_z \\cdot \\overline{K}_z \\cdot \\overline{LS}_z \\cdot \\overline{C}_z \\cdot \\overline{P}_z\n$$\n这一步体现了聚合误差的核心：模型被应用于平均后的输入，而不是对模型的输出进行平均。\n\n最后，方案 $\\mathcal{Z}_i$ 的区域平均土壤流失量（记为 $A_i$）是各区域土壤流失值 $A_z$ 的面积加权平均值。由于所有单元格面积相等，每个区域的权重就是其大小 $|S_z|$。\n$$\nA_i = \\frac{\\sum_{z \\in \\mathcal{Z}_i} |S_z| A_z}{\\sum_{z \\in \\mathcal{Z}_i} |S_z|} = \\frac{1}{NM} \\sum_{z \\in \\mathcal{Z}_i} |S_z| A_z\n$$\n\n对所有四种方案进行此计算：\n*   **方案 $\\mathcal{Z}_A$**：每个单元是一个区域，所以 $|S_z| = 1$。这意味着 $\\overline{F}_z = F_{ij}$ 并且 $A_z = A_{ij}$。因此，最终的区域平均值 $A_A$ 将与 $A_{\\mathrm{base}}$ 相同，符合预期。\n*   **方案 $\\mathcal{Z}_B$**：四个区域，每个区域的大小 $|S_z| = 4$。\n*   **方案 $\\mathcal{Z}_C$**：两个区域，每个区域的大小 $|S_z| = 8$。\n*   **方案 $\\mathcal{Z}_D$**：一个区域，大小为 $|S_z| = 16$。计算简化为 $A_D = \\overline{R}_{\\text{total}} \\cdot \\overline{K}_{\\text{total}} \\cdot \\overline{LS}_{\\text{total}} \\cdot \\overline{C}_{\\text{total}} \\cdot \\overline{P}_{\\text{total}}$，其中每个因子都在整个栅格上取平均值。\n\n**3. MAUP 影响度量**\n\n计算出的区域平均值集合 $\\{A_B, A_C, A_D\\}$ 相对于基准值 $A_{\\mathrm{base}}$ 的变化量化了 MAUP 的影响。\n\n*   **样本方差 ($V$)**：方差是针对来自聚合方案 $\\{A_B, A_C, A_D\\}$ 的结果集计算的。对于 $n = 3$ 个值，无偏样本方差为：\n    $$\n    V = \\frac{1}{n-1} \\sum_{i \\in \\{B,C,D\\}} (A_i - \\bar{A})^2 = \\frac{1}{2} \\sum_{i \\in \\{B,C,D\\}} (A_i - \\bar{A})^2\n    $$\n    其中 $\\bar{A} = \\frac{A_B + A_C + A_D}{3}$。\n\n*   **平均绝对偏差 ($\\overline{|\\Delta|}$)**：该指标衡量由聚合引入的误差的平均大小，相对于基准值计算。\n    $$\n    \\overline{|\\Delta|} = \\frac{1}{3} \\sum_{i \\in \\{B,C,D\\}} |A_i - A_{\\mathrm{base}}| = \\frac{|A_B - A_{\\mathrm{base}}| + |A_C - A_{\\mathrm{base}}| + |A_D - A_{\\mathrm{base}}|}{3}\n    $$\n\n*   **最大绝对偏差 ($\\max|\\Delta|$)**：该指标识别了在测试的聚合方案中的最坏情况误差。\n    $$\n    \\max|\\Delta| = \\max(|A_B - A_{\\mathrm{base}}|, |A_C - A_{\\mathrm{base}}|, |A_D - A_{\\mathrm{base}}|)\n    $$\n\n这些步骤提供了一个完整、合理的程序来满足问题的要求。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates soil loss and MAUP metrics based on USLE principles.\n    \"\"\"\n    # Step 1: Define the Givens - Factor Grids\n    R = np.array([\n        [320, 280, 400, 360],\n        [300, 260, 420, 380],\n        [340, 290, 410, 370],\n        [310, 270, 390, 350]\n    ], dtype=np.float64)\n\n    K = np.array([\n        [0.18, 0.12, 0.20, 0.15],\n        [0.22, 0.10, 0.25, 0.16],\n        [0.19, 0.11, 0.21, 0.14],\n        [0.17, 0.13, 0.23, 0.18]\n    ], dtype=np.float64)\n\n    LS = np.array([\n        [1.5, 0.8, 2.0, 1.2],\n        [1.8, 0.7, 2.2, 1.3],\n        [1.6, 0.9, 2.1, 1.1],\n        [1.4, 0.85, 1.9, 1.0]\n    ], dtype=np.float64)\n\n    C = np.array([\n        [0.25, 0.10, 0.35, 0.20],\n        [0.30, 0.08, 0.40, 0.22],\n        [0.28, 0.12, 0.33, 0.18],\n        [0.26, 0.11, 0.31, 0.16]\n    ], dtype=np.float64)\n\n    P = np.array([\n        [0.90, 0.60, 0.80, 0.70],\n        [1.00, 0.50, 0.90, 0.80],\n        [0.95, 0.65, 0.85, 0.75],\n        [0.92, 0.62, 0.88, 0.78]\n    ], dtype=np.float64)\n    \n    factors = (R, K, LS, C, P)\n\n    # Define the Zoning Schemes\n    Z_A = np.arange(16).reshape(4, 4)\n    \n    Z_B = np.array([\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [2, 2, 3, 3],\n        [2, 2, 3, 3]\n    ])\n\n    Z_C = np.array([\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [0, 0, 1, 1]\n    ])\n\n    Z_D = np.zeros((4, 4), dtype=int)\n\n    # Task 1: Compute per-cell soil loss A\n    A_grid = R * K * LS * C * P\n\n    # Task 2: Compute baseline area-wide mean soil loss A_base\n    A_base = A_grid.mean()\n\n    # Task 3: Compute area-wide means for each zoning scheme\n    def calculate_scheme_mean(zone_map, factor_grids):\n        \"\"\"\n        Calculates the area-wide mean soil loss for a given zoning scheme.\n        \"\"\"\n        R_grid, K_grid, LS_grid, C_grid, P_grid = factor_grids\n        \n        unique_zones = np.unique(zone_map)\n        \n        zonal_losses = []\n        zonal_weights = []\n\n        for zone_id in unique_zones:\n            mask = (zone_map == zone_id)\n            num_cells_in_zone = np.sum(mask)\n\n            # Compute zonal mean for each factor\n            R_z = R_grid[mask].mean()\n            K_z = K_grid[mask].mean()\n            LS_z = LS_grid[mask].mean()\n            C_z = C_grid[mask].mean()\n            P_z = P_grid[mask].mean()\n\n            # Compute zone-level A from zonal factor means\n            A_z = R_z * K_z * LS_z * C_z * P_z\n            \n            zonal_losses.append(A_z)\n            zonal_weights.append(num_cells_in_zone)\n        \n        # Compute area-weighted mean of A_z across zones\n        scheme_mean = np.average(zonal_losses, weights=zonal_weights)\n        return scheme_mean\n\n    A_A = calculate_scheme_mean(Z_A, factors)\n    A_B = calculate_scheme_mean(Z_B, factors)\n    A_C = calculate_scheme_mean(Z_C, factors)\n    A_D = calculate_scheme_mean(Z_D, factors)\n\n    # Task 4: Quantify MAUP impacts\n    maup_means = np.array([A_B, A_C, A_D])\n\n    # Sample variance V\n    V = np.var(maup_means, ddof=1)\n\n    # Absolute biases\n    abs_biases = np.abs(maup_means - A_base)\n\n    # Mean absolute bias\n    mean_abs_bias = np.mean(abs_biases)\n\n    # Maximum absolute bias\n    max_abs_bias = np.max(abs_biases)\n\n    # Format and print the final results\n    results = [A_base, A_A, A_B, A_C, A_D, V, mean_abs_bias, max_abs_bias]\n    results_str = [f\"{val:.6f}\" for val in results]\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "这项高级实践将MAUP置于现代贝叶斯分层模型的框架中，这是空间分析的强大工具。您将比较两种常见的分析工作流程：“先估计后聚合”（ETA）和“先聚合后估计”（ATE）。通过推导和计算这两种方法之间的差异，您将深入了解聚合偏差在概率模型中如何体现，并理解为何操作顺序——建模与聚合——至关重要。",
            "id": "3860779",
            "problem": "您将要执行一个遥感和环境建模领域的建模任务，该任务关注可变面积单元问题（MAUP）。考虑一个区域内一组空间索引的子区域。在每个子区域 $i$ 中，观察到一个环境事件计数 $y_i$，其暴露量 $E_i$ 以人年为单位。假设抽样模型为 $y_i \\mid \\theta_i \\sim \\mathrm{Poisson}(E_i \\theta_i)$，先验为 $\\theta_i \\sim \\mathrm{Gamma}(\\alpha,\\beta)$（采用形状-率参数化），其中 $\\alpha \\gt 0$ 且 $\\beta \\gt 0$。各子区域的率在先验上是独立的。此设定定义了一个贝叶斯分层模型，通过对 $\\theta_i$ 的公共先验，实现了跨子区域的部分池化。使用贝叶斯定理以及泊松分布和伽马分布的性质，推导出计算子区域层面和区域层面后验期望率所需的表达式。\n\n为区域层面的期望率（单位：每人年事件数）定义两种估计程序：\n\n- 先估计后聚合 (ETA)：对每个子区域 $i$，使用模型计算 $\\theta_i$ 的后验分布及其后验期望（子区域期望率），然后使用 $E_i$ 作为权重，对区域内的所有子区域进行暴露量加权平均。\n\n- 先聚合后估计 (ATE)：在区域内聚合计数和暴露量，即 $Y_{+} = \\sum_i y_i$ 和 $E_{+} = \\sum_i E_i$，然后在区域尺度上使用相同的模型设定，推导区域率参数的后验分布及其后验期望（区域期望率）。\n\n当 ETA 和 ATE 产生不同结果时，可变分区单元问题便显现出来，这是因为聚合操作与模型的非线性相互作用。将一个区域的 MAUP 差异 $D$ 定义为 ETA 和 ATE 后验期望率之间的绝对差，单位为每人年事件数。\n\n您的任务是实现一个程序，为以下每个测试用例计算 $D$。每个用例代表一个由该用例中列出的所有子区域聚合而成的单一区域。请严格按照给定的参数和数据进行计算。所有答案必须以每人年事件数表示，并四舍五入到6位小数。\n\n测试套件：\n\n- 案例 1（常规多子区域）：先验 $(\\alpha,\\beta) = (2.0, 100.0)$，暴露量 $[100.0, 200.0, 300.0]$，计数 $[5, 8, 12]$。\n\n- 案例 2（边界情况，单一子区域）：先验 $(\\alpha,\\beta) = (1.5, 50.0)$，暴露量 $[250.0]$，计数 $[9]$。\n\n- 案例 3（高度异构的暴露量）：先验 $(\\alpha,\\beta) = (2.0, 10.0)$，暴露量 $[10.0, 1000.0]$，计数 $[2, 50]$。\n\n- 案例 4（稀疏计数和小暴露量）：先验 $(\\alpha,\\beta) = (0.5, 1.0)$，暴露量 $[1.0, 1.0, 1.0, 2.0]$，计数 $[0, 0, 1, 0]$。\n\n- 案例 5（相对于暴露量有强先验池化）：先验 $(\\alpha,\\beta) = (20.0, 2000.0)$，暴露量 $[5.0, 5.0, 5.0, 5.0, 5.0]$，计数 $[0, 1, 0, 2, 1]$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,...]”），列表中的每个结果是对应案例的 $D$ 值，四舍五入到6位小数，顺序与上述案例相同。不应打印任何额外文本。",
            "solution": "所提出的问题在科学上是合理的、良构的，并包含获得唯一且有意义解所需的所有信息。它描述了一个用于空间计数数据的标准贝叶斯分层模型，这是环境建模和流行病学中的一个常见任务。先估计后聚合（ETA）和先聚合后估计（ATE）的概念是标准方法，它们的比较是可变分区单元问题（MAUP）的一个经典例证。该问题是有效的，并且可以按所述方式解决。\n\n此问题的核心在于将贝叶斯定理应用于一个共轭分布对：泊松似然和伽马先验。我们的任务是在两种不同的聚合方案下，推导环境事件率 $\\theta$ 的后验期望，并量化它们之间的差异。\n\n首先，我们来推导单个子区域 $i$ 的率参数 $\\theta_i$ 的后验分布。模型设定如下：\n- 抽样模型（似然）：$p(y_i | \\theta_i) = \\frac{(E_i \\theta_i)^{y_i} e^{-E_i \\theta_i}}{y_i!}$，这是一个 $\\mathrm{Poisson}(E_i \\theta_i)$ 分布。作为 $\\theta_i$ 的函数，似然正比于 $L(\\theta_i; y_i) \\propto \\theta_i^{y_i} e^{-E_i \\theta_i}$。\n- 先验分布：假设率 $\\theta_i$ 服从形状参数为 $\\alpha$ 且率参数为 $\\beta$ 的伽马分布，记为 $\\theta_i \\sim \\mathrm{Gamma}(\\alpha, \\beta)$。其概率密度函数为 $p(\\theta_i) = \\frac{\\beta^\\alpha}{\\Gamma(\\alpha)} \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i}$，正比于 $p(\\theta_i) \\propto \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i}$。\n\n根据贝叶斯定理，后验分布正比于似然与先验的乘积：\n$$p(\\theta_i | y_i) \\propto p(y_i | \\theta_i) p(\\theta_i)$$\n$$p(\\theta_i | y_i) \\propto \\left( \\theta_i^{y_i} e^{-E_i \\theta_i} \\right) \\left( \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i} \\right)$$\n$$p(\\theta_i | y_i) \\propto \\theta_i^{(\\alpha + y_i) - 1} e^{-(\\beta + E_i) \\theta_i}$$\n这个结果的函数形式是另一个伽马分布的核。这证明了伽马先验对于泊松似然是共轭的。因此，$\\theta_i$ 的后验分布为：\n$$\\theta_i | y_i \\sim \\mathrm{Gamma}(\\alpha + y_i, \\beta + E_i)$$\n一个服从 $\\mathrm{Gamma}(\\text{shape}, \\text{rate})$ 分布的随机变量的期望值是其形状参数与率参数之比。因此，子区域 $i$ 的后验期望率为：\n$$E[\\theta_i | y_i] = \\frac{\\alpha + y_i}{\\beta + E_i}$$\n\n现在，我们可以定义区域层面率的两种估计程序。\n\n1.  **先估计后聚合 (ETA) 程序：**\n    该程序首先计算每个子区域的后验期望率，然后计算暴露量加权平均值。设 $N$ 是区域中子区域的数量。区域层面的期望率 $\\text{Rate}_{\\text{ETA}}$ 为：\n    $$\\text{Rate}_{\\text{ETA}} = \\frac{\\sum_{i=1}^{N} E_i \\cdot E[\\theta_i | y_i]}{\\sum_{i=1}^{N} E_i}$$\n    代入后验期望的表达式，我们得到：\n    $$\\text{Rate}_{\\text{ETA}} = \\frac{1}{\\sum_{i=1}^{N} E_i} \\sum_{i=1}^{N} E_i \\left( \\frac{\\alpha + y_i}{\\beta + E_i} \\right)$$\n\n2.  **先聚合后估计 (ATE) 程序：**\n    该程序首先将所有子区域的计数和暴露量聚合到区域层面。\n    -   总计数：$Y_{+} = \\sum_{i=1}^{N} y_i$\n    -   总暴露量：$E_{+} = \\sum_{i=1}^{N} E_i$\n    然后我们将相同的贝叶斯模型应用于这些聚合量。我们假设一个区域层面的率参数 $\\Theta$，其先验与之前相同，$\\Theta \\sim \\mathrm{Gamma}(\\alpha, \\beta)$，抽样模型为 $Y_{+} | \\Theta \\sim \\mathrm{Poisson}(E_{+} \\Theta)$。遵循与单个子区域相同的推导逻辑，区域率的后验分布为 $\\Theta | Y_{+} \\sim \\mathrm{Gamma}(\\alpha + Y_{+}, \\beta + E_{+})$。\n    后验期望率 $\\text{Rate}_{\\text{ATE}}$ 为：\n    $$\\text{Rate}_{\\text{ATE}} = E[\\Theta | Y_{+}] = \\frac{\\alpha + Y_{+}}{\\beta + E_{+}} = \\frac{\\alpha + \\sum_{i=1}^{N} y_i}{\\beta + \\sum_{i=1}^{N} E_i}$$\n\nMAUP 差异 $D$ 是这两个估计值之间的绝对差：\n$$D = \\left| \\text{Rate}_{\\text{ETA}} - \\text{Rate}_{\\text{ATE}} \\right|$$\n$$D = \\left| \\frac{\\sum_{i=1}^{N} E_i \\left( \\frac{\\alpha + y_i}{\\beta + E_i} \\right)}{\\sum_{i=1}^{N} E_i} - \\frac{\\alpha + \\sum_{i=1}^{N} y_i}{\\beta + \\sum_{i=1}^{N} E_i} \\right|$$\n差异 $D$ 通常不为零，因为后验期望算子是数据 $(y_i, E_i)$ 的一个非线性函数。聚合过程与应用这个非线性函数这两个操作是不可交换的。这是聚合偏差的一个典型例子，也是 MAUP 的一个关键方面。只有在特殊情况下，差异才会为零，例如当只有一个子区域时（如案例2），或者所有子区域的暴露量和观测到的粗率完全相同时。\n\n将实现以下算法来为每个测试用例计算 $D$：\n1.  对于一个给定的案例，其先验参数为 $(\\alpha, \\beta)$，暴露量列表为 $[E_i]$，计数列表为 $[y_i]$：\n2.  计算聚合量 $E_{+} = \\sum E_i$ 和 $Y_{+} = \\sum y_i$。\n3.  计算 $\\text{Rate}_{\\text{ATE}} = (\\alpha + Y_{+}) / (\\beta + E_{+})$。\n4.  初始化 ETA 的分子求和项为 $0$。\n5.  遍历每个子区域 $i$：计算子区域后验均值 $(\\alpha + y_i) / (\\beta + E_i)$，并将乘积 $E_i \\cdot ((\\alpha + y_i) / (\\beta + E_i))$ 加到求和项中。\n6.  将求和项除以 $E_{+}$来计算 $\\text{Rate}_{\\text{ETA}}$。\n7.  计算 $D = |\\text{Rate}_{\\text{ETA}} - \\text{Rate}_{\\text{ATE}}|$。\n8.  将结果四舍五入到6位小数。\n\n该程序将应用于所有提供的测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the MAUP discrepancy problem for a given set of test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (general multi-subarea zone)\n        {\"alpha\": 2.0, \"beta\": 100.0, \"exposures\": [100.0, 200.0, 300.0], \"counts\": [5, 8, 12]},\n        # Case 2 (boundary case, single subarea)\n        {\"alpha\": 1.5, \"beta\": 50.0, \"exposures\": [250.0], \"counts\": [9]},\n        # Case 3 (highly heterogeneous exposures)\n        {\"alpha\": 2.0, \"beta\": 10.0, \"exposures\": [10.0, 1000.0], \"counts\": [2, 50]},\n        # Case 4 (sparse counts and small exposures)\n        {\"alpha\": 0.5, \"beta\": 1.0, \"exposures\": [1.0, 1.0, 1.0, 2.0], \"counts\": [0, 0, 1, 0]},\n        # Case 5 (strong prior pooling relative to exposures)\n        {\"alpha\": 20.0, \"beta\": 2000.0, \"exposures\": [5.0, 5.0, 5.0, 5.0, 5.0], \"counts\": [0, 1, 0, 2, 1]},\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha = case[\"alpha\"]\n        beta = case[\"beta\"]\n        exposures = np.array(case[\"exposures\"])\n        counts = np.array(case[\"counts\"])\n\n        # --- Aggregate-then-Estimate (ATE) Calculation ---\n        # Aggregate counts and exposures\n        Y_plus = np.sum(counts)\n        E_plus = np.sum(exposures)\n        \n        # Calculate ATE posterior expected rate\n        # Rate_ATE = (alpha + sum(y_i)) / (beta + sum(E_i))\n        rate_ate = (alpha + Y_plus) / (beta + E_plus)\n\n        # --- Estimate-then-Aggregate (ETA) Calculation ---\n        # Calculate posterior expected rate for each subarea\n        # E[theta_i | y_i] = (alpha + y_i) / (beta + E_i)\n        subarea_posterior_means = (alpha + counts) / (beta + exposures)\n        \n        # Calculate exposure-weighted average of subarea posterior means\n        # Rate_ETA = sum(E_i * E[theta_i | y_i]) / sum(E_i)\n        eta_numerator = np.sum(exposures * subarea_posterior_means)\n        rate_eta = eta_numerator / E_plus\n        \n        # --- MAUP Discrepancy Calculation ---\n        discrepancy = abs(rate_eta - rate_ate)\n        \n        # Round to 6 decimal places and store the result\n        results.append(round(discrepancy, 6))\n\n    # Format the final output string as [result1,result2,...]\n    # The format string ensures trailing zeros are printed for exactly 6 decimal places.\n    output_string = \"[\" + \",\".join([f\"{r:.6f}\" for r in results]) + \"]\"\n    print(output_string)\n\nsolve()\n```"
        }
    ]
}