{
    "hands_on_practices": [
        {
            "introduction": "本练习将使用一个简化的城市增长模型，来演示可变分区单元问题（MAUP）的一个典型表现。通过分析两个不同尺度下的假设数据，您将亲眼见证聚合如何改变——甚至逆转——统计关系的符号，从而突显尺度变化下混淆变量的关键作用。",
            "id": "3863788",
            "problem": "一位遥感分析师正在校准一个城市增长元胞自动机（CA）模型，该模型将每个单元的二元城市状态从时间 $t$ 更新到时间 $t+1$。在一个时间步长内，一个 $10\\,\\mathrm{m}$ 单元城市化的概率被建模为局部地形坡度、可达性和邻域城市密度的函数。分析师首先在原始的 $10\\,\\mathrm{m}$ 分辨率下工作，然后通过对每组 $10 \\times 10$ 的 $10\\,\\mathrm{m}$ 单元内的协变量进行平均，并计算一次CA更新后地块中城市化单元的比例，从而聚合到 $100\\,\\mathrm{m}$ 的地块。\n\n基本依据。分析师采纳了广泛使用的假设：(i) CA转换概率 $P(Y_i=1)$ 随可达性和邻域城市密度的增加而增加，随坡度的增加而减少；(ii) 为解释关联性，使用响应变量和预测变量之间的 Pearson 相关系数 $r$ 和普通最小二乘斜率来概括关联方向；(iii) 地块聚合将单元级变量 $x_i$ 替换为地块均值 $\\bar{x}_b$，并将单元级二元结果 $Y_i\\in\\{0,1\\}$ 替换为地块比例 $\\bar{Y}_b=\\frac{1}{N_b}\\sum_{i\\in b}Y_i$。\n\n分析师怀疑存在可变分区单元问题（MAUP），即改变分析尺度和分区会改变估计的关联性。为探究此问题，构建了一个程式化实验，其中从 $10\\,\\mathrm{m}$ 单元构成了4个不同的 $100\\,\\mathrm{m}$ 地块：\n\n- 靠近新高速公路的两个山坡地块：$B_1$ 的 $\\bar{s}_{1}=2.0$ 且 $\\bar{a}_{1}=1.5$；$B_2$ 的 $\\bar{s}_{2}=1.5$ 且 $\\bar{a}_{2}=1.2$。此处 $\\bar{s}_b$ 是标准化的地块平均坡度（z-score），$\\bar{a}_b$ 是标准化的可达性指数。\n- 靠近历史中心的两个山谷地块：$B_3$ 的 $\\bar{s}_{3}=-1.5$ 且 $\\bar{a}_{3}=0.2$；$B_4$ 的 $\\bar{s}_{4}=-1.2$ 且 $\\bar{a}_{4}=0.1$。\n\n在 $10\\,\\mathrm{m}$ 尺度上进行一次CA更新后，通过遥感测得各地块的城市化比例为 $\\bar{Y}_{1}=0.775$，$\\bar{Y}_{2}=0.725$，$\\bar{Y}_{3}=0.625$ 和 $\\bar{Y}_{4}=0.585$。在每个地块内部，其组成的 $10 \\times 10$ 个 $10\\,\\mathrm{m}$ 单元的可达性近似恒定，而坡度则在地块内变化。\n\n问题。在此CA背景下，关于可变分区单元问题（MAUP）以及从 $10\\,\\mathrm{m}$ 像素聚合到 $100\\,\\mathrm{m}$ 地块时坡度-城市化关联的符号，以下哪些陈述是正确的？\n\nA. 从 $10\\,\\mathrm{m}$ 变为 $100\\,\\mathrm{m}$ 地块会改变预测变量间的协方差；如果在区块层面，可达性 $\\bar{a}_b$ 与坡度 $\\bar{s}_b$ 呈正相关，那么即使在细尺度上坡度对单元城市化概率的偏效应为负，$\\bar{Y}_b$ 对 $\\bar{s}_b$ 在4个地块上回归的最小二乘斜率也可能大于0。根据所提供的地块数据，$\\bar{Y}_b$ 对 $\\bar{s}_b$ 在4个地块上的聚合最小二乘斜率大于0。\n\nB. 在任何单调的CA转换规则下，聚合都会保留坡度-城市化关联的方向；因此，根据所提供的地块数据计算出的最小二乘斜率必须小于0。\n\nC. 聚合后观测到的符号反转纯粹是由随机噪声引起的；如果 $100\\,\\mathrm{m}$ 地块的数量增加，聚合后的关联必然会恢复到在 $10\\,\\mathrm{m}$ 尺度上所见的负号。\n\nD. 一种可行的缓解措施是在一个分层或多尺度框架中校准CA转换，该框架包含地块级可达性（及其他混杂因素），对不同的尺度和分区进行敏感性分析，并报告尺度依赖的效应，而不是单一尺度的估计值。\n\nE. 将 $10\\,\\mathrm{m}$ 类别标签通过最近邻重采样到 $100\\,\\mathrm{m}$ 地块消除了MAUP，因为它保持了地块内的原始像素值不变。",
            "solution": "### 步骤1：提取已知信息\n问题陈述提供了以下信息：\n- **模型背景：** 一个更新二元城市状态的城市增长元胞自动机（CA）模型。\n- **尺度：** 一个 $10\\,\\mathrm{m}$ 单元的细尺度和一个 $100\\,\\mathrm{m}$ 地块的粗尺度，每个地块由 $10 \\times 10$ 个单元格阵列组成。\n- **转换概率：** 一个单元城市化的概率 $P(Y_i=1)$ 是地形坡度、可达性和邻域城市密度的函数。\n- **假设（“基本依据”）：**\n    - (i) $P(Y_i=1)$ 随可达性和邻域密度的增加而增加，随坡度的增加而减少。这意味着在细尺度上，坡度对城市化具有负的偏效应。\n    - (ii) 关联性由 Pearson 相关系数 $r$ 和普通最小二乘（OLS）斜率概括。\n    - (iii) 聚合方法：单元级变量 $x_i$ 被地块均值 $\\bar{x}_b$ 替换，单元级二元结果 $Y_i \\in \\{0, 1\\}$ 被地块比例 $\\bar{Y}_b = \\frac{1}{N_b}\\sum_{i \\in b} Y_i$ 替换，其中 $N_b=100$。\n- **实验数据：** 四个 $100\\,\\mathrm{m}$ 地块具有以下属性：\n    - 地块 $B_1$：$\\bar{s}_{1}=2.0$（标准化的地块平均坡度），$\\bar{a}_{1}=1.5$（标准化的可达性指数），$\\bar{Y}_{1}=0.775$（城市化比例）。\n    - 地块 $B_2$：$\\bar{s}_{2}=1.5$，$\\bar{a}_{2}=1.2$，$\\bar{Y}_{2}=0.725$。\n    - 地块 $B_3$：$\\bar{s}_{3}=-1.5$，$\\bar{a}_{3}=0.2$，$\\bar{Y}_{3}=0.625$。\n    - 地块 $B_4$：$\\bar{s}_{4}=-1.2$，$\\bar{a}_{4}=0.1$，$\\bar{Y}_{4}=0.585$。\n- **附加信息：** 在每个地块内，可达性近似恒定，而坡度是变化的。\n- **问题：** 询问关于可变分区单元问题（MAUP）以及聚合后坡度-城市化关联的符号，哪些陈述是正确的。\n\n### 步骤2：使用提取的已知信息进行验证\n1.  **科学基础（关键）：** 该问题基本上是合理的。它描述了空间分析、地理学和环境建模中一个经典的问题，称为可变分区单元问题（MAUP）。用于城市增长的元胞自动机、空间数据的聚合、混杂变量以及相关性符号反转（辛普森悖论或生态谬误的一个例子）等概念在科学文献中都已得到公认。该设置是对现实世界分析挑战的一个程式化但有效的表述。\n2.  **适定性：** 该问题是适定的。它提供了清晰的假设、一个特定的数据集，并要求基于这些信息对几个陈述进行评估。问题是明确的，并且可以通过计算和概念推理的结合得出确切的答案。存在唯一且有意义的解。\n3.  **客观性（关键）：** 该问题以精确、客观和科学的语言陈述。它没有偏见、主观性或观点。\n\n问题陈述没有违反任何无效性标准。它不是科学上不合理、不可形式化、不完整、不现实、不适定或微不足道的。\n\n### 步骤3：结论与行动\n问题陈述是有效的。将继续进行求解过程。\n\n### 基于原理的推导\n核心问题是可变分区单元问题（MAUP），该问题指出，当分析的空间单元被修改时（无论是通过改变其尺度（聚合级别）还是其分区（边界）），统计结果（如相关系数或回归系数）可能会发生变化。该问题描述了一种尺度效应，即从 $10\\,\\mathrm{m}$ 单元移动到 $100\\,\\mathrm{m}$ 地块。\n\n在细（$10\\,\\mathrm{m}$）尺度上，问题假设坡度对城市化概率的偏效应为负。这意味着，在保持其他因素（如可达性）不变的情况下，坡度的增加会导致开发可能性的降低。我们可以用一个多元模型来概念性地表示单元 $i$ 的概率 $P_i$：\n$$ P_i = f(s_i, a_i, d_i) $$\n其中 $s_i, a_i, d_i$ 分别是坡度、可达性和密度，且 $\\frac{\\partial f}{\\partial s_i}  0$ 和 $\\frac{\\partial f}{\\partial a_i} > 0$。\n\n当我们聚合到粗（$100\\,\\mathrm{m}$）尺度时，我们不再检验坡度的偏效应。相反，我们对聚合后的结果 $\\bar{Y}_b$ 和聚合后的预测变量 $\\bar{s}_b$ 进行简单线性回归。这个简单回归的斜率由 $\\bar{Y}_b$ 和 $\\bar{s}_b$ 之间的协方差决定：\n$$ \\beta_{\\bar{Y}\\bar{s}} = \\frac{\\text{Cov}(\\bar{s}_b, \\bar{Y}_b)}{\\text{Var}(\\bar{s}_b)} $$\n这个斜率的符号由协方差的符号决定。$\\bar{Y}_b$ 的值是底层细尺度过程的聚合结果。由于 $\\bar{Y}_b$ 受到可达性 $\\bar{a}_b$ 的强烈影响（假设其在地块内恒定且具有正效应），因此在地块层面上，预测变量 $\\bar{s}_b$ 和 $\\bar{a}_b$ 之间的任何相关性都会影响观测到的 $\\bar{Y}_b$ 和 $\\bar{s}_b$ 之间的关系。这是一个典型的混杂案例。如果一个混杂因素（$\\bar{a}_b$）同时与预测变量（$\\bar{s}_b$）和结果（$\\bar{Y}_b$）相关，它就可能扭曲甚至反转简单回归斜率的符号，使其与真实的偏效应相反。这种现象被称为辛普森悖论，是 MAUP 的一种统计表现。\n\n让我们检查所提供的数据是否存在这种混杂。\n- $\\bar{s}_b$ 的数据： $\\{2.0, 1.5, -1.5, -1.2\\}$\n- $\\bar{a}_b$ 的数据： $\\{1.5, 1.2, 0.2, 0.1\\}$\n高坡度地块（$B_1, B_2$）也具有高可达性，而低（负）坡度地块（$B_3, B_4$）的可达性较低。因此，在地块层面上，$\\bar{s}_b$ 和 $\\bar{a}_b$ 之间存在强正相关。\n同时，城市化 $\\bar{Y}_b$ 与可达性 $\\bar{a}_b$ 呈正相关。\n- $\\bar{Y}_b$ 的数据： $\\{0.775, 0.725, 0.625, 0.585\\}$\n这就构成了一个经典的混杂情景：\n1. 坡度与城市化负相关（真实的细尺度效应）。\n2. 在地块层面上，坡度与可达性正相关（混杂相关）。\n3. 可达性与城市化正相关。\n\n坡度与可达性之间的正相关，加上可达性与城市化之间的强正相关，可能会压倒坡度与城市化之间的负相关，导致在简单回归中出现净正相关。\n\n### 逐项分析\n\n**A. 从 $10\\,\\mathrm{m}$ 变为 $100\\,\\mathrm{m}$ 地块会改变预测变量间的协方差；如果在区块层面，可达性 $\\bar{a}_b$ 与坡度 $\\bar{s}_b$ 呈正相关，那么即使在细尺度上坡度对单元城市化概率的偏效应为负，$\\bar{Y}_b$ 对 $\\bar{s}_b$ 在4个地块上回归的最小二乘斜率也可能大于0。根据所提供的地块数据，$\\bar{Y}_b$ 对 $\\bar{s}_b$ 在4个地块上的聚合最小二乘斜率大于0。**\n该陈述包含两部分。第一部分是对 MAUP/辛普森悖论的概念性解释，如上所述是正确的。尺度变化可以诱导或改变预测变量之间的相关性，从而导致混杂，反转关联的符号。第二部分是一个需要计算的论断。让我们计算 $\\bar{Y}_b$ 对 $\\bar{s}_b$ 回归的 OLS 斜率 $\\beta_{\\bar{Y}\\bar{s}}$。\n\n斜率的公式为 $\\beta = \\frac{\\sum (x_i - \\bar{x})(y_i - \\bar{y})}{\\sum (x_i - \\bar{x})^2}$。\n数据点为 $(\\bar{s}_b, \\bar{Y}_b)$: $(2.0, 0.775)$, $(1.5, 0.725)$, $(-1.5, 0.625)$, $(-1.2, 0.585)$。\n1.  计算均值：\n    $$ \\bar{s}_{\\text{mean}} = \\frac{2.0 + 1.5 - 1.5 - 1.2}{4} = \\frac{0.8}{4} = 0.2 $$\n    $$ \\bar{Y}_{\\text{mean}} = \\frac{0.775 + 0.725 + 0.625 + 0.585}{4} = \\frac{2.71}{4} = 0.6775 $$\n2.  计算分子（与协方差成正比）：\n    $$ \\sum_{b=1}^{4} (\\bar{s}_b - \\bar{s}_{\\text{mean}})(\\bar{Y}_b - \\bar{Y}_{\\text{mean}}) = (2.0 - 0.2)(0.775 - 0.6775) + (1.5 - 0.2)(0.725 - 0.6775) + (-1.5 - 0.2)(0.625 - 0.6775) + (-1.2 - 0.2)(0.585 - 0.6775) $$\n    $$ = (1.8)(0.0975) + (1.3)(0.0475) + (-1.7)(-0.0525) + (-1.4)(-0.0925) $$\n    $$ = 0.1755 + 0.06175 + 0.08925 + 0.1295 = 0.456 $$\n3.  计算分母（与 $\\bar{s}_b$ 的方差成正比）：\n    $$ \\sum_{b=1}^{4} (\\bar{s}_b - \\bar{s}_{\\text{mean}})^2 = (1.8)^2 + (1.3)^2 + (-1.7)^2 + (-1.4)^2 $$\n    $$ = 3.24 + 1.69 + 2.89 + 1.96 = 9.78 $$\n4.  计算斜率：\n    $$ \\beta_{\\bar{Y}\\bar{s}} = \\frac{0.456}{9.78} \\approx 0.0466 $$\n由于 $0.0466 > 0$，最小二乘斜率确实大于0。该陈述的两部分都是正确的。\n结论：**正确**。\n\n**B. 在任何单调的CA转换规则下，聚合都会保留坡度-城市化关联的方向；因此，根据所提供的地块数据计算出的最小二乘斜率必须小于0。**\n该陈述的第一部分是一个强烈的、普遍性的主张，但它根本上是错误的。聚合通常*不会*保留统计关联的方向，这正是 MAUP 和生态谬误的本质。混杂变量的协方差结构随尺度变化，这很容易导致符号反转，正如选项 A 的分析所示。该陈述的第二部分，“因此，最小二乘斜率...必须小于0”，是基于这个错误前提得出的结论。此外，我们在选项 A 中的计算表明斜率为正，直接证伪了这一结论。\n结论：**不正确**。\n\n**C. 聚合后观测到的符号反转纯粹是由随机噪声引起的；如果 $100\\,\\mathrm{m}$ 地块的数量增加，聚合后的关联必然会恢复到在 $10\\,\\mathrm{m}$ 尺度上所见的负号。**\n该陈述错误地将一个系统性效应归因于随机噪声。符号反转是由数据中的混杂结构（地块级坡度与可达性之间的正相关）解释的，这是所描述的空间过程的一个系统性特征，而非随机特征。该论断的第二部分也是错误的。如果造成混杂的潜在地理过程（例如，在高坡度地区建设高可达性基础设施）在整个景观中持续存在，那么更大样本的地块很可能继续显示出相同的正向聚合关联。聚合估计量收敛于真实的聚合参数，该参数可以不同于细尺度参数。没有定律规定它必须恢复到细尺度的符号。\n结论：**不正确**。\n\n**D. 一种可行的缓解措施是在一个分层或多尺度框架中校准CA转换，该框架包含地块级可达性（及其他混杂因素），对不同的尺度和分区进行敏感性分析，并报告尺度依赖的效应，而不是单一尺度的估计值。**\n该陈述提出了一套复杂而恰当的方法来处理 MAUP。\n- **分层/多尺度框架：** 这是一种标准且强大的统计方法（例如，多层模型），用于分析嵌套数据。它允许模型同时考虑单元级和地块级的关系，从而在各自的尺度上正确归因预测变量的影响，并控制跨层级的混杂。\n- **敏感性分析：** 鉴于 MAUP 指出结果对区域单元的选择敏感，稳健分析的一个关键部分就是通过使用不同的尺度和分区重复分析来测试这种敏感性。\n- **报告尺度依赖的效应：** 如果分析揭示效应随尺度变化，正确的科学实践是报告这一发现，而不是选择一个尺度并将其结果作为唯一的“真实”答案呈现。\n该选项描述了在存在尺度问题时进行空间分析的最佳实践和前沿方法。\n结论：**正确**。\n\n**E. 将 $10\\,\\mathrm{m}$ 类别标签通过最近邻重采样到 $100\\,\\mathrm{m}$ 地块消除了MAUP，因为它保持了地块内的原始像素值不变。**\n该陈述在几个方面都是不正确的。首先，最近邻重采样并不能“消除”MAUP。它只是众多可能的聚合/重采样规则之一。结果仍然会依赖于尺度（$100\\,\\mathrm{m}$）和具体的分区（网格的布局）。不同的分区或不同的重采样规则（例如，双线性插值、众数滤波）可能会产生不同的结果。其次，“因为它保持地块内的原始像素值不变”这一理由是对该方法的误解。当从 $10\\,\\mathrm{m}$ 重采样到 $100\\,\\mathrm{m}$ 时，最近邻法将原始100个像素中*一个*像素的值赋给新的、更大的像素。它丢弃了其他99个像素的信息。它并没有保持“地块内的值不变”。MAUP 源于分析单元的修改以及聚合过程中的信息丢失/转换，而最近邻法只是执行这种修改的一种方式。它没有解决根本问题。\n结论：**不正确**。",
            "answer": "$$\\boxed{AD}$$"
        },
        {
            "introduction": "在建立了概念性理解的基础上，本练习提供了一项使用著名的通用土壤流失方程（USLE）的具体计算任务。您将首先在原始分辨率下计算区域总体的土壤流失量，然后在多种聚合方案下重新计算，从而能够定量地衡量由MAUP引入的偏差和方差。",
            "id": "3847664",
            "problem": "您将获得源自遥感和辅助数据的网格化输入，以用于评估在通用水土流失方程（USLE）及其修订版（修正的通用水土流失方程，RUSLE）下的土壤流失情况。目标是通过计算多种空间分区方案下的区域范围土壤流失，并分析因空间划分改变而引入的方差，从而量化可变分区单元问题（MAUP）。您的推导必须基于标准解释，即一个地点的单位面积年土壤流失量（记为 $A$）与代表降雨侵蚀力、土壤可蚀性、地形、植被覆盖与管理以及水土保持措施的因子成乘法关系。除此乘法解释外，不要假设任何非标准依赖关系。所有计算都必须在假设每个网格单元面积相等的条件下进行。所有土壤流失率以吨/公顷/年（$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）表示，方差以 $(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$ 表示。计算中不涉及角度。\n\n基本原理：\n- 通用水土流失方程（USLE）和修正的通用水土流失方程（RUSLE）是经过充分检验的经验模型，其中一个地点的单位面积年土壤流失量 $A$ 取决于降雨-径流侵蚀力因子 $R$、土壤可蚀性因子 $K$、地形因子 $LS$、植被覆盖与管理因子 $C$ 以及水土保持措施因子 $P$。每个因子都是非负的，根据管理效率和保护性覆盖率的定义，$C$ 和 $P$ 是界于 $[0,1]$ 之间的无量纲标量。因子 $LS$ 是无量纲的，编码了坡长和坡度的影响。在地点尺度上，这五个因子之间是乘法关系。请仅使用此解释以及平均和方差的规则来推导所要求的量。\n\n数据集：\n- 一个 $4 \\times 4$ 网格（行从上到下索引，列从左到右索引）的以下因子值：\n    - 降雨-径流侵蚀力因子 $R$（单位：$\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}$）：\n      第1行：$[320, 280, 400, 360]$；第2行：$[300, 260, 420, 380]$；第3行：$[340, 290, 410, 370]$；第4行：$[310, 270, 390, 350]$。\n      具体来说，矩阵为：\n      $\\begin{bmatrix}\n      320  280  400  360 \\\\\n      300  260  420  380 \\\\\n      340  290  410  370 \\\\\n      310  270  390  350\n      \\end{bmatrix}$。\n    - 土壤可蚀性因子 $K$（单位：$\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}$）：\n      $\\begin{bmatrix}\n      0.18  0.12  0.20  0.15 \\\\\n      0.22  0.10  0.25  0.16 \\\\\n      0.19  0.11  0.21  0.14 \\\\\n      0.17  0.13  0.23  0.18\n      \\end{bmatrix}$。\n    - 地形因子 $LS$（无量纲）：\n      $\\begin{bmatrix}\n      1.5  0.8  2.0  1.2 \\\\\n      1.8  0.7  2.2  1.3 \\\\\n      1.6  0.9  2.1  1.1 \\\\\n      1.4  0.85  1.9  1.0\n      \\end{bmatrix}$。\n    - 植被覆盖与管理因子 $C$（无量纲）：\n      $\\begin{bmatrix}\n      0.25  0.10  0.35  0.20 \\\\\n      0.30  0.08  0.40  0.22 \\\\\n      0.28  0.12  0.33  0.18 \\\\\n      0.26  0.11  0.31  0.16\n      \\end{bmatrix}$。\n    - 水土保持措施因子 $P$（无量纲）：\n      $\\begin{bmatrix}\n      0.90  0.60  0.80  0.70 \\\\\n      1.00  0.50  0.90  0.80 \\\\\n      0.95  0.65  0.85  0.75 \\\\\n      0.92  0.62  0.88  0.78\n      \\end{bmatrix}$。\n\n分区方案（区域标识符为整数；等面积单元）：\n- 方案 $\\mathcal{Z}_A$（每个单元自成一区）：\n  $\\begin{bmatrix}\n  0  1  2  3 \\\\\n  4  5  6  7 \\\\\n  8  9  10  11 \\\\\n  12  13  14  15\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_B$（$2 \\times 2$ 的块，产生 $4$ 个区域）：\n  $\\begin{bmatrix}\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  2  2  3  3 \\\\\n  2  2  3  3\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_C$（垂直两半，产生 $2$ 个区域）：\n  $\\begin{bmatrix}\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  0  0  1  1 \\\\\n  0  0  1  1\n  \\end{bmatrix}$。\n- 方案 $\\mathcal{Z}_D$（覆盖整个网格的单一区域）：\n  $\\begin{bmatrix}\n  0  0  0  0 \\\\\n  0  0  0  0 \\\\\n  0  0  0  0 \\\\\n  0  0  0  0\n  \\end{bmatrix}$。\n\n任务：\n- 仅使用通用水土流失方程因子在单元级别的乘法解释，推导并实现一个程序来：\n  1. 在原始网格上计算每个单元的土壤流失量 $A$。\n  2. 计算基准区域范围平均土壤流失量 $A_{\\mathrm{base}}$，作为所有 $16$ 个单元的 $A$ 值的算术平均值（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n  3. 对于每个分区方案 $\\mathcal{Z}_i \\in \\{\\mathcal{Z}_A, \\mathcal{Z}_B, \\mathcal{Z}_C, \\mathcal{Z}_D\\}$：\n     - 对于 $\\mathcal{Z}_i$ 中的每个区域 $z$，计算属于 $z$ 的单元上每个因子 $R$、$K$、$LS$、$C$、$P$ 的区域平均值。\n     - 在区域级别使用相同的乘法解释，根据区域因子平均值计算区域级别的 $A_z$。\n     - 计算方案 $\\mathcal{Z}_i$ 的区域范围平均值 $A_i$，作为各区域 $A_z$ 的面积加权平均值（权重等于每个区域的单元数）。\n  4. 通过计算集合 $\\{A_B, A_C, A_D\\}$（不包括 $\\mathcal{Z}_A$，因为它根据定义与基准重合）来量化 MAUP 的影响：\n     - 样本方差 $V$，除数为 $n-1$，即 $n=3$ 时的无偏估计量（单位：$(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$）。\n     - 平均绝对偏差 $\\overline{|\\Delta|}$，定义为 $i \\in \\{B,C,D\\}$ 时 $|A_i - A_{\\mathrm{base}}|$ 的算术平均值（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n     - 最大绝对偏差 $\\max|\\Delta|$，定义为 $\\max_{i \\in \\{B,C,D\\}} |A_i - A_{\\mathrm{base}}|$（单位：$\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$）。\n\n角度单位不适用。所有土壤流失输出必须以 $\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$ 解读，方差以 $(\\mathrm{t \\, ha^{-1} \\, yr^{-1}})^2$ 解读。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序如下：\n$[A_{\\mathrm{base}}, A_A, A_B, A_C, A_D, V, \\overline{|\\Delta|}, \\max|\\Delta|]$。\n不要在打印行中包含单位；数值必须以浮点数形式打印。您可以四舍五入到六位小数。",
            "solution": "在尝试求解之前，对问题陈述的有效性进行评估。\n\n### 步骤1：提取已知条件\n\n问题提供了以下数据和定义：\n\n*   **模型**：单位面积年土壤流失量 $A$ 由乘法模型 $A = R \\times K \\times LS \\times C \\times P$ 给出。所有因子都是非负的。$C, P \\in [0, 1]$。$LS$ 是无量纲的。所有网格单元面积相等。\n*   **单位**：$A$ 的单位是 $\\mathrm{t \\, ha^{-1} \\, yr^{-1}}$。$R$ 的单位是 $\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}$。$K$ 的单位是 $\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}$。$LS, C, P$ 是无量纲的。\n*   **因子数据网格**：提供了 $R, K, LS, C, P$ 这五个因子的 $4 \\times 4$ 矩阵。\n    *   $R = \\begin{bmatrix} 320  280  400  360 \\\\ 300  260  420  380 \\\\ 340  290  410  370 \\\\ 310  270  390  350 \\end{bmatrix}$\n    *   $K = \\begin{bmatrix} 0.18  0.12  0.20  0.15 \\\\ 0.22  0.10  0.25  0.16 \\\\ 0.19  0.11  0.21  0.14 \\\\ 0.17  0.13  0.23  0.18 \\end{bmatrix}$\n    *   $LS = \\begin{bmatrix} 1.5  0.8  2.0  1.2 \\\\ 1.8  0.7  2.2  1.3 \\\\ 1.6  0.9  2.1  1.1 \\\\ 1.4  0.85  1.9  1.0 \\end{bmatrix}$\n    *   $C = \\begin{bmatrix} 0.25  0.10  0.35  0.20 \\\\ 0.30  0.08  0.40  0.22 \\\\ 0.28  0.12  0.33  0.18 \\\\ 0.26  0.11  0.31  0.16 \\end{bmatrix}$\n    *   $P = \\begin{bmatrix} 0.90  0.60  0.80  0.70 \\\\ 1.00  0.50  0.90  0.80 \\\\ 0.95  0.65  0.85  0.75 \\\\ 0.92  0.62  0.88  0.78 \\end{bmatrix}$\n*   **分区方案**：定义了 $4 \\times 4$ 网格的四种分区方案，由区域标识符矩阵表示。\n    *   $\\mathcal{Z}_A$：每个单元自成一区。\n    *   $\\mathcal{Z}_B$：$2 \\times 2$ 的块。\n    *   $\\mathcal{Z}_C$：垂直两半。\n    *   $\\mathcal{Z}_D$：整个网格为单一区域。\n*   **任务**：\n    1. 计算每个单元的土壤流失量 $A$。\n    2. 计算基准区域范围平均值 $A_{\\mathrm{base}}$，作为每个单元 $A$ 值的平均值。\n    3. 对于每个方案 $\\mathcal{Z}_i$，通过先在区域内平均因子，然后应用乘法模型，最后对区域结果进行面积加权平均来计算区域范围平均值 $A_i$。\n    4. 计算可变分区单元问题（MAUP）影响的三个指标：样本方差 $V$、平均绝对偏差 $\\overline{|\\Delta|}$ 和最大绝对偏差 $\\max|\\Delta|$，针对集合 $\\{A_B, A_C, A_D\\}$ 相对于 $A_{\\mathrm{base}}$。\n\n### 步骤2：使用提取的已知条件进行验证\n\n*   **科学依据**：该问题基于成熟的 USLE/RUSLE 土壤侵蚀建模方法。乘法形式 $A = RKLSCP$ 是标准的。各因子的单位是一致的：乘积 $[R] \\times [K]$ 的结果为 $(\\mathrm{MJ \\, mm \\, ha^{-1} \\, h^{-1} \\, yr^{-1}}) \\times (\\mathrm{t \\, ha \\, h \\, ha^{-1} \\, MJ^{-1} \\, mm^{-1}}) = \\mathrm{t \\, ha^{-1} \\, yr^{-1}}$，这是土壤流失率 $A$ 的正确单位。提供的因子值是合理的。MAUP 的概念是空间分析中一个基本且有据可查的问题。\n*   **适定性**：问题是完全指定的。所有必要的数据（因子网格、分区方案）和计算过程都得到了明确的定义。可以计算出唯一的、稳定的数值解。\n*   **客观性**：问题以精确、客观、正式的语言陈述。它要求进行一组特定的计算，没有任何主观解释的余地。\n\n该问题没有表现出任何诸如科学不健全、不完整、矛盾或模糊之类的缺陷。这些任务是演示 MAUP 的标准分析的直接和正式的实现。\n\n### 步骤3：结论与行动\n\n问题是**有效的**。将推导并实现一个解决方案。\n\n目标是在使用通用水土流失方程（USLE）进行土壤侵蚀建模的背景下，量化可变分区单元问题（MAUP）。问题的核心在于求平均值和应用非线性函数之间的不可交换性。USLE 模型在其多因子结构（它是变量的乘积）中是非线性的，因此乘积的平均值不等于平均值的乘积。\n\n网格上特定位置 $(i, j)$ 的单位面积土壤流失的基本关系是：\n$$\nA_{ij} = R_{ij} K_{ij} LS_{ij} C_{ij} P_{ij}\n$$\n其中 $i \\in \\{0, 1, 2, 3\\}$ 和 $j \\in \\{0, 1, 2, 3\\}$ 是网格单元的行和列索引。\n\n**1. 每单元土壤流失和基准平均值 ($A_{\\mathrm{base}}$)**\n\n首先，我们使用提供的因子数据计算网格中 16 个单元中每个单元的土壤流失量。这将生成一个 $4 \\times 4$ 的土壤流失值网格 $A_{ij}$。\n\n基准区域范围平均土壤流失量 $A_{\\mathrm{base}}$ 定义为在整个区域上以最高可用分辨率（单元级别）计算的真实平均土壤流失量。由于所有单元面积相等，这只是每单元土壤流失值的简单算术平均值。对于一个大小为 $N \\times M$ 的网格（这里是 $4 \\times 4$，即 16 个单元）：\n$$\nA_{\\mathrm{base}} = \\frac{1}{NM} \\sum_{i=0}^{N-1} \\sum_{j=0}^{M-1} A_{ij}\n$$\n在给定输入数据的情况下，此值代表了对区域范围土壤流失最准确的估计。\n\n**2. 区域聚合和方案级别平均值 ($A_i$)**\n\nMAUP 分析通过在不同的空间聚合（分区方案）下重新计算区域范围的平均土壤流失来进行。对于每个方案 $\\mathcal{Z}_i \\in \\{\\mathcal{Z}_A, \\mathcal{Z}_B, \\mathcal{Z}_C, \\mathcal{Z}_D\\}$，程序如下：\n\n对于方案 $\\mathcal{Z}_i$ 中的每个区域 $z$，我们首先计算每个 USLE 因子的平均值。设 $S_z$ 是属于区域 $z$ 的单元索引 $(i, j)$ 的集合，$|S_z|$ 是该区域中的单元数。因子 $F$（其中 $F$ 可以是 $R, K, LS, C$, 或 $P$）的区域平均值为：\n$$\n\\overline{F}_z = \\frac{1}{|S_z|} \\sum_{(i,j) \\in S_z} F_{ij}\n$$\n接下来，通过将 USLE 模型应用于这些平均后的因子，为整个区域计算一个单一的土壤流失值 $A_z$：\n$$\nA_z = \\overline{R}_z \\cdot \\overline{K}_z \\cdot \\overline{LS}_z \\cdot \\overline{C}_z \\cdot \\overline{P}_z\n$$\n这一步体现了聚合误差的核心：模型应用于平均后的输入，而不是对模型的输出求平均。\n\n最后，方案 $\\mathcal{Z}_i$ 的区域范围平均土壤流失量（记为 $A_i$）是区域土壤流失值 $A_z$ 的面积加权平均值。由于所有单元面积相等，每个区域的权重就是其大小 $|S_z|$。\n$$\nA_i = \\frac{\\sum_{z \\in \\mathcal{Z}_i} |S_z| A_z}{\\sum_{z \\in \\mathcal{Z}_i} |S_z|} = \\frac{1}{NM} \\sum_{z \\in \\mathcal{Z}_i} |S_z| A_z\n$$\n\n对所有四种方案进行此计算：\n*   **方案 $\\mathcal{Z}_A$**：每个单元自成一区，因此 $|S_z| = 1$。这意味着 $\\overline{F}_z = F_{ij}$ 且 $A_z = A_{ij}$。由此产生的区域范围平均值 $A_A$ 将与 $A_{\\mathrm{base}}$ 相同，符合预期。\n*   **方案 $\\mathcal{Z}_B$**：四个区域，每个区域大小 $|S_z| = 4$。\n*   **方案 $\\mathcal{Z}_C$**：两个区域，每个区域大小 $|S_z| = 8$。\n*   **方案 $\\mathcal{Z}_D$**：一个区域，大小 $|S_z| = 16$。计算简化为 $A_D = \\overline{R}_{\\text{total}} \\cdot \\overline{K}_{\\text{total}} \\cdot \\overline{LS}_{\\text{total}} \\cdot \\overline{C}_{\\text{total}} \\cdot \\overline{P}_{\\text{total}}$，其中每个因子都在整个网格上取平均值。\n\n**3. MAUP 影响指标**\n\n计算出的区域范围平均值 $\\{A_B, A_C, A_D\\}$ 相对于基准 $A_{\\mathrm{base}}$ 的变化量化了 MAUP 的影响。\n\n*   **样本方差 ($V$)**：为聚合方案的结果集 $\\{A_B, A_C, A_D\\}$ 计算方差。对于 $n = 3$ 个值，无偏样本方差为：\n    $$\n    V = \\frac{1}{n-1} \\sum_{i \\in \\{B,C,D\\}} (A_i - \\bar{A})^2 = \\frac{1}{2} \\sum_{i \\in \\{B,C,D\\}} (A_i - \\bar{A})^2\n    $$\n    其中 $\\bar{A} = \\frac{A_B + A_C + A_D}{3}$。\n\n*   **平均绝对偏差 ($\\overline{|\\Delta|}$)**：这衡量了由聚合引入的误差的平均大小，是相对于基准计算的。\n    $$\n    \\overline{|\\Delta|} = \\frac{1}{3} \\sum_{i \\in \\{B,C,D\\}} |A_i - A_{\\mathrm{base}}| = \\frac{|A_B - A_{\\mathrm{base}}| + |A_C - A_{\\mathrm{base}}| + |A_D - A_{\\mathrm{base}}|}{3}\n    $$\n\n*   **最大绝对偏差 ($\\max|\\Delta|$)**：这确定了在测试的聚合方案中的最坏情况误差。\n    $$\n    \\max|\\Delta| = \\max(|A_B - A_{\\mathrm{base}}|, |A_C - A_{\\mathrm{base}}|, |A_D - A_{\\mathrm{base}}|)\n    $$\n\n这些步骤为完成问题要求提供了一个完整、合理的程序。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates soil loss and MAUP metrics based on USLE principles.\n    \"\"\"\n    # Step 1: Define the Givens - Factor Grids\n    R = np.array([\n        [320, 280, 400, 360],\n        [300, 260, 420, 380],\n        [340, 290, 410, 370],\n        [310, 270, 390, 350]\n    ], dtype=np.float64)\n\n    K = np.array([\n        [0.18, 0.12, 0.20, 0.15],\n        [0.22, 0.10, 0.25, 0.16],\n        [0.19, 0.11, 0.21, 0.14],\n        [0.17, 0.13, 0.23, 0.18]\n    ], dtype=np.float64)\n\n    LS = np.array([\n        [1.5, 0.8, 2.0, 1.2],\n        [1.8, 0.7, 2.2, 1.3],\n        [1.6, 0.9, 2.1, 1.1],\n        [1.4, 0.85, 1.9, 1.0]\n    ], dtype=np.float64)\n\n    C = np.array([\n        [0.25, 0.10, 0.35, 0.20],\n        [0.30, 0.08, 0.40, 0.22],\n        [0.28, 0.12, 0.33, 0.18],\n        [0.26, 0.11, 0.31, 0.16]\n    ], dtype=np.float64)\n\n    P = np.array([\n        [0.90, 0.60, 0.80, 0.70],\n        [1.00, 0.50, 0.90, 0.80],\n        [0.95, 0.65, 0.85, 0.75],\n        [0.92, 0.62, 0.88, 0.78]\n    ], dtype=np.float64)\n    \n    factors = (R, K, LS, C, P)\n\n    # Define the Zoning Schemes\n    Z_A = np.arange(16).reshape(4, 4)\n    \n    Z_B = np.array([\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [2, 2, 3, 3],\n        [2, 2, 3, 3]\n    ])\n\n    Z_C = np.array([\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [0, 0, 1, 1],\n        [0, 0, 1, 1]\n    ])\n\n    Z_D = np.zeros((4, 4), dtype=int)\n\n    # Task 1: Compute per-cell soil loss A\n    A_grid = R * K * LS * C * P\n\n    # Task 2: Compute baseline area-wide mean soil loss A_base\n    A_base = A_grid.mean()\n\n    # Task 3: Compute area-wide means for each zoning scheme\n    def calculate_scheme_mean(zone_map, factor_grids):\n        \"\"\"\n        Calculates the area-wide mean soil loss for a given zoning scheme.\n        \"\"\"\n        R_grid, K_grid, LS_grid, C_grid, P_grid = factor_grids\n        \n        unique_zones = np.unique(zone_map)\n        \n        zonal_losses = []\n        zonal_weights = []\n\n        for zone_id in unique_zones:\n            mask = (zone_map == zone_id)\n            num_cells_in_zone = np.sum(mask)\n\n            # Compute zonal mean for each factor\n            R_z = R_grid[mask].mean()\n            K_z = K_grid[mask].mean()\n            LS_z = LS_grid[mask].mean()\n            C_z = C_grid[mask].mean()\n            P_z = P_grid[mask].mean()\n\n            # Compute zone-level A from zonal factor means\n            A_z = R_z * K_z * LS_z * C_z * P_z\n            \n            zonal_losses.append(A_z)\n            zonal_weights.append(num_cells_in_zone)\n        \n        # Compute area-weighted mean of A_z across zones\n        scheme_mean = np.average(zonal_losses, weights=zonal_weights)\n        return scheme_mean\n\n    A_A = calculate_scheme_mean(Z_A, factors)\n    A_B = calculate_scheme_mean(Z_B, factors)\n    A_C = calculate_scheme_mean(Z_C, factors)\n    A_D = calculate_scheme_mean(Z_D, factors)\n\n    # Task 4: Quantify MAUP impacts\n    maup_means = np.array([A_B, A_C, A_D])\n\n    # Sample variance V\n    V = np.var(maup_means, ddof=1)\n\n    # Absolute biases\n    abs_biases = np.abs(maup_means - A_base)\n\n    # Mean absolute bias\n    mean_abs_bias = np.mean(abs_biases)\n\n    # Maximum absolute bias\n    max_abs_bias = np.max(abs_biases)\n\n    # Format and print the final results\n    results = [A_base, A_A, A_B, A_C, A_D, V, mean_abs_bias, max_abs_bias]\n    results_str = [f\"{val:.6f}\" for val in results]\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后的这项练习将深入探讨一个更高级的统计背景，在贝叶斯分层模型框架内探索MAUP。通过比较处理空间计数数据时的“先聚合后估计”（ATE）与“先估计后聚合”（ETA）方法，您将理解聚合偏差是如何源于统计估计的非线性特性，并体会多尺度空间分析的精妙之处。",
            "id": "3860779",
            "problem": "您面临一个遥感和环境建模领域的建模任务，该任务关注可变分区单元问题（MAUP）。考虑一个区域内一组按空间索引的子区域。在每个子区域 $i$ 中，观察到一个环境事件计数 $y_i$，其暴露量为 $E_i$，单位为人年。假设抽样模型为 $y_i \\mid \\theta_i \\sim \\mathrm{Poisson}(E_i \\theta_i)$，先验分布为 $\\theta_i \\sim \\mathrm{Gamma}(\\alpha,\\beta)$，采用形状-速率参数化，其中 $\\alpha > 0$ 且 $\\beta > 0$。子区域的率在先验上是独立的。这个设定定义了一个贝叶斯分层模型，通过对 $\\theta_i$ 的共同先验在子区域之间实现部分汇集。使用贝叶斯定理以及泊松分布和伽马分布的性质，推导计算子区域层面和区域层面后验期望率所需的表达式。\n\n定义两种区域层面期望率（单位：事件数/人年）的估计程序：\n\n- 先估计后聚合（ETA）：对每个子区域 $i$，使用模型计算 $\\theta_i$ 的后验分布及其后验期望（子区域期望率），然后以 $E_i$ 为权重，计算区域内各子区域的暴露量加权平均值。\n\n- 先聚合后估计（ATE）：将区域内的计数和暴露量进行聚合，即 $Y_{+} = \\sum_i y_i$ 和 $E_{+} = \\sum_i E_i$，然后在区域尺度上使用相同的模型设定来推导区域率参数的后验分布及其后验期望（区域期望率）。\n\n当ETA和ATE产生不同结果时，可变分区单元问题就会显现，因为聚合过程与模型的非线性相互作用。将一个区域的MAUP差异定义为ETA和ATE后验期望率之间的绝对差值 $D$，单位为事件数/人年。\n\n您的任务是实现一个程序，为以下每个测试用例计算 $D$。每个用例代表一个由该用例内列出的所有子区域聚合而成的单一区域。请严格按照给定的参数和数据进行计算。所有答案必须以事件数/人年为单位表示，并四舍五入到 $6$ 位小数。\n\n测试套件：\n\n- 案例 $1$（一般多子区域区域）：先验 $(\\alpha,\\beta) = (2.0, 100.0)$，暴露量 $[100.0, 200.0, 300.0]$，计数 $[5, 8, 12]$。\n\n- 案例 $2$（边界情况，单个子区域）：先验 $(\\alpha,\\beta) = (1.5, 50.0)$，暴露量 $[250.0]$，计数 $[9]$。\n\n- 案例 $3$（高度异构的暴露量）：先验 $(\\alpha,\\beta) = (2.0, 10.0)$，暴露量 $[10.0, 1000.0]$，计数 $[2, 50]$。\n\n- 案例 $4$（稀疏计数和小暴露量）：先验 $(\\alpha,\\beta) = (0.5, 1.0)$，暴露量 $[1.0, 1.0, 1.0, 2.0]$，计数 $[0, 0, 1, 0]$。\n\n- 案例 $5$（相对于暴露量的强先验汇集）：先验 $(\\alpha,\\beta) = (20.0, 2000.0)$，暴露量 $[5.0, 5.0, 5.0, 5.0, 5.0]$，计数 $[0, 1, 0, 2, 1]$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[result1,result2,...]”），每个结果是对应案例的 $D$ 值，四舍五入到 $6$ 位小数，顺序与上述案例相同。不应打印任何额外文本。",
            "solution": "所提出的问题在科学上是合理的、定义明确的，并包含了得出唯一且有意义的解所需的所有信息。它描述了一个用于空间计数数据的标准贝叶斯分层模型，这是环境建模和流行病学中的常见任务。“先估计后聚合”（ETA）和“先聚合后估计”（ATE）是标准方法，它们的比较是可变分区单元问题（MAUP）的一个经典例证。该问题是有效的，并且可以按所述方式解决。\n\n这个问题的核心在于将贝叶斯定理应用于共轭分布对：泊松似然和伽马先验。我们的任务是在两种不同的聚合方案下，推导环境事件后验期望率 $\\theta$，并量化它们之间的差异。\n\n首先，让我们推导单个子区域 $i$ 的率参数 $\\theta_i$ 的后验分布。该模型设定如下：\n- 抽样模型（似然）：$p(y_i | \\theta_i) = \\frac{(E_i \\theta_i)^{y_i} e^{-E_i \\theta_i}}{y_i!}$，这是一个 $\\mathrm{Poisson}(E_i \\theta_i)$ 分布。作为 $\\theta_i$ 的函数，似然与 $L(\\theta_i; y_i) \\propto \\theta_i^{y_i} e^{-E_i \\theta_i}$ 成正比。\n- 先验分布：率 $\\theta_i$ 假定服从形状参数为 $\\alpha$、速率参数为 $\\beta$ 的伽马分布，记为 $\\theta_i \\sim \\mathrm{Gamma}(\\alpha, \\beta)$。其概率密度函数为 $p(\\theta_i) = \\frac{\\beta^\\alpha}{\\Gamma(\\alpha)} \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i}$，它与 $p(\\theta_i) \\propto \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i}$ 成正比。\n\n根据贝叶斯定理，后验分布与似然和先验的乘积成正比：\n$$p(\\theta_i | y_i) \\propto p(y_i | \\theta_i) p(\\theta_i)$$\n$$p(\\theta_i | y_i) \\propto \\left( \\theta_i^{y_i} e^{-E_i \\theta_i} \\right) \\left( \\theta_i^{\\alpha-1} e^{-\\beta \\theta_i} \\right)$$\n$$p(\\theta_i | y_i) \\propto \\theta_i^{(\\alpha + y_i) - 1} e^{-(\\beta + E_i) \\theta_i}$$\n这个结果的函数形式是另一个伽马分布的核。这证明了伽马先验与泊松似然的共轭性。因此，$\\theta_i$ 的后验分布为：\n$$\\theta_i | y_i \\sim \\mathrm{Gamma}(\\alpha + y_i, \\beta + E_i)$$\n服从 $\\mathrm{Gamma}(\\text{形状}, \\text{速率})$ 分布的随机变量的期望值是其形状与速率之比。因此，子区域 $i$ 的后验期望率为：\n$$E[\\theta_i | y_i] = \\frac{\\alpha + y_i}{\\beta + E_i}$$\n\n现在，我们可以定义区域层面率的两种估计量。\n\n1.  **先估计后聚合（ETA）程序：**\n    此程序首先计算每个子区域的后验期望率，然后计算暴露量加权平均值。设 $N$ 为区域内子区域的数量。区域层面的期望率 $\\text{Rate}_{\\text{ETA}}$ 为：\n    $$\\text{Rate}_{\\text{ETA}} = \\frac{\\sum_{i=1}^{N} E_i \\cdot E[\\theta_i | y_i]}{\\sum_{i=1}^{N} E_i}$$\n    代入后验期望的表达式，我们得到：\n    $$\\text{Rate}_{\\text{ETA}} = \\frac{1}{\\sum_{i=1}^{N} E_i} \\sum_{i=1}^{N} E_i \\left( \\frac{\\alpha + y_i}{\\beta + E_i} \\right)$$\n\n2.  **先聚合后估计（ATE）程序：**\n    此程序首先将所有子区域的计数和暴露量聚合到区域层面。\n    -   总计数：$Y_{+} = \\sum_{i=1}^{N} y_i$\n    -   总暴露量：$E_{+} = \\sum_{i=1}^{N} E_i$\n    然后我们将相同的贝叶斯模型应用于这些聚合量。我们假设一个区域层面的率参数 $\\Theta$ 具有相同的先验 $\\Theta \\sim \\mathrm{Gamma}(\\alpha, \\beta)$，以及一个抽样模型 $Y_{+} | \\Theta \\sim \\mathrm{Poisson}(E_{+} \\Theta)$。遵循与单个子区域相同的推导逻辑，区域率的后验分布为 $\\Theta | Y_{+} \\sim \\mathrm{Gamma}(\\alpha + Y_{+}, \\beta + E_{+})$。\n    后验期望率 $\\text{Rate}_{\\text{ATE}}$ 为：\n    $$\\text{Rate}_{\\text{ATE}} = E[\\Theta | Y_{+}] = \\frac{\\alpha + Y_{+}}{\\beta + E_{+}} = \\frac{\\alpha + \\sum_{i=1}^{N} y_i}{\\beta + \\sum_{i=1}^{N} E_i}$$\n\nMAUP 差异 $D$ 是这两种估计值之间的绝对差：\n$$D = \\left| \\text{Rate}_{\\text{ETA}} - \\text{Rate}_{\\text{ATE}} \\right|$$\n$$D = \\left| \\frac{\\sum_{i=1}^{N} E_i \\left( \\frac{\\alpha + y_i}{\\beta + E_i} \\right)}{\\sum_{i=1}^{N} E_i} - \\frac{\\alpha + \\sum_{i=1}^{N} y_i}{\\beta + \\sum_{i=1}^{N} E_i} \\right|$$\n差异 $D$ 通常不为零，因为后验期望算子是数据 $(y_i, E_i)$ 的一个非线性函数。聚合过程与应用此非线性函数的操作不可交换。这是聚合偏差的一个典型例子，也是 MAUP 的一个关键方面。只有在特殊情况下，差异才会为零，例如只有一个子区域（如案例2），或者所有子区域的暴露量和观察到的原始率完全同质。\n\n将实现以下算法来为每个测试用例计算 $D$：\n1.  对于一个给定的案例，其先验参数为 $(\\alpha, \\beta)$，暴露量列表为 $[E_i]$，计数列表为 $[y_i]$：\n2.  计算聚合量 $E_{+} = \\sum E_i$ 和 $Y_{+} = \\sum y_i$。\n3.  计算 $\\text{Rate}_{\\text{ATE}} = (\\alpha + Y_{+}) / (\\beta + E_{+})$。\n4.  初始化 ETA 分子的总和为 $0$。\n5.  遍历每个子区域 $i$：计算子区域后验均值 $(\\alpha + y_i) / (\\beta + E_i)$，并将乘积 $E_i \\cdot ((\\alpha + y_i) / (\\beta + E_i))$ 加入总和。\n6.  通过将总和除以 $E_{+}$ 来计算 $\\text{Rate}_{\\text{ETA}}$。\n7.  计算 $D = |\\text{Rate}_{\\text{ETA}} - \\text{Rate}_{\\text{ATE}}|$。\n8.  将结果四舍五入到 $6$ 位小数。\n\n此程序将应用于所有提供的测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the MAUP discrepancy problem for a given set of test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (general multi-subarea zone)\n        {\"alpha\": 2.0, \"beta\": 100.0, \"exposures\": [100.0, 200.0, 300.0], \"counts\": [5, 8, 12]},\n        # Case 2 (boundary case, single subarea)\n        {\"alpha\": 1.5, \"beta\": 50.0, \"exposures\": [250.0], \"counts\": [9]},\n        # Case 3 (highly heterogeneous exposures)\n        {\"alpha\": 2.0, \"beta\": 10.0, \"exposures\": [10.0, 1000.0], \"counts\": [2, 50]},\n        # Case 4 (sparse counts and small exposures)\n        {\"alpha\": 0.5, \"beta\": 1.0, \"exposures\": [1.0, 1.0, 1.0, 2.0], \"counts\": [0, 0, 1, 0]},\n        # Case 5 (strong prior pooling relative to exposures)\n        {\"alpha\": 20.0, \"beta\": 2000.0, \"exposures\": [5.0, 5.0, 5.0, 5.0, 5.0], \"counts\": [0, 1, 0, 2, 1]},\n    ]\n\n    results = []\n    for case in test_cases:\n        alpha = case[\"alpha\"]\n        beta = case[\"beta\"]\n        exposures = np.array(case[\"exposures\"])\n        counts = np.array(case[\"counts\"])\n\n        # --- Aggregate-then-Estimate (ATE) Calculation ---\n        # Aggregate counts and exposures\n        Y_plus = np.sum(counts)\n        E_plus = np.sum(exposures)\n        \n        # Calculate ATE posterior expected rate\n        # Rate_ATE = (alpha + sum(y_i)) / (beta + sum(E_i))\n        rate_ate = (alpha + Y_plus) / (beta + E_plus)\n\n        # --- Estimate-then-Aggregate (ETA) Calculation ---\n        # Calculate posterior expected rate for each subarea\n        # E[theta_i | y_i] = (alpha + y_i) / (beta + E_i)\n        subarea_posterior_means = (alpha + counts) / (beta + exposures)\n        \n        # Calculate exposure-weighted average of subarea posterior means\n        # Rate_ETA = sum(E_i * E[theta_i | y_i]) / sum(E_i)\n        eta_numerator = np.sum(exposures * subarea_posterior_means)\n        rate_eta = eta_numerator / E_plus\n        \n        # --- MAUP Discrepancy Calculation ---\n        discrepancy = abs(rate_eta - rate_ate)\n        \n        # Round to 6 decimal places and store the result\n        results.append(round(discrepancy, 6))\n\n    # Format the final output string as [result1,result2,...]\n    # The format string ensures trailing zeros are printed for exactly 6 decimal places.\n    output_string = \"[\" + \",\".join([f\"{r:.6f}\" for r in results]) + \"]\"\n    print(output_string)\n\nsolve()\n```"
        }
    ]
}