{
    "hands_on_practices": [
        {
            "introduction": "简单的影像相减是变化检测的直观方法，但它对各种误差源高度敏感，其中最常见也最具挑战性的是影像间的亚像素级配准误差。本练习旨在探讨景观中的空间梯度与微小的几何未对齐如何相互作用，从而在没有真实地物变化时产生显著的“伪变化”信号。通过对这一效应进行数学建模，您将对变化检测中误报的一个主要来源建立批判性认识，并理解高精度影像配准的必要性 。",
            "id": "3820730",
            "problem": "一对经过大气校正的同一场景的表面反射率图像 $I_1(\\mathbf{x})$ 和 $I_2(\\mathbf{x})$ 用于通过图像差分进行变化检测，其中差分图像定义为 $D(\\mathbf{x}) = I_2(\\mathbf{x}) - I_1(\\mathbf{x})$。假设在两次采集之间没有真实的物理变化，但第二幅图像存在亚像素配准误差，使得 $I_2$ 中的采样点位于位置 $\\mathbf{x} + \\delta \\mathbf{x}$，其中 $\\delta \\mathbf{x}$ 代表配准误差向量。在空间异质性景观中，$I_1(\\mathbf{x})$ 的边缘和梯度不为零。\n\n从 $I_1(\\mathbf{x})$ 的可微性以及平移配准误差会使采样位置发生偏移的物理解释出发，在固定像素点 $\\mathbf{x}_0$ 处完成以下任务：\n\n- 基于标准多元微积分，使用一阶展开式，在没有真实变化的情况下，表达仅由 $\\delta \\mathbf{x}$ 引起的对 $D(\\mathbf{x}_0)$ 的主阶贡献。\n\n- 设 $\\delta \\mathbf{x}$ 被建模为一个零均值二元高斯随机向量，其协方差矩阵为 $\\boldsymbol{\\Sigma}$。利用高斯随机变量线性变换的性质，推导虚假变化的期望幅值 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$ 的解析表达式，用 $\\nabla I_1(\\mathbf{x}_0)$ 和 $\\boldsymbol{\\Sigma}$ 表示。\n\n- 对推导出的表达式进行数值计算。假设一个像素点位于陆水边界上，其局部空间梯度测量为 $\\nabla I_1(\\mathbf{x}_0) = \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix}$（单位：反射率/米），配准误差协方差为 $\\boldsymbol{\\Sigma} = \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix}$（单位：$\\mathrm{m}^2$）。以十进制反射率（无量纲）表示最终的伪变化期望幅值 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$，并将答案四舍五入至 $4$ 位有效数字。",
            "solution": "该问题被验证为具有科学依据、提法明确且客观。这是多元微积分和统计学在遥感变化检测实际问题中的一个标准应用。所有必要信息均已提供，问题没有矛盾或含糊之处。\n\n该问题要求分三部分进行推导和计算，涉及由亚像素配准误差引起的图像差分中的伪变化信号。\n\n首先，我们来推导在像素点 $\\mathbf{x}_0$ 处对差分图像 $D(\\mathbf{x}_0)$ 的主阶贡献。差分图像定义为 $D(\\mathbf{x}) = I_2(\\mathbf{x}) - I_1(\\mathbf{x})$。问题陈述，场景中没有真实的物理变化，因此两个时间点的底层反射率场都由 $I_1(\\mathbf{x})$ 描述。第二幅图像 $I_2$ 是第一幅图像的配准误差版本，意味着其采样点位于偏移后的位置。这可以正式表示为 $I_2(\\mathbf{x}) = I_1(\\mathbf{x} + \\delta\\mathbf{x})$，其中 $\\delta\\mathbf{x}$ 是亚像素配准误差向量。\n\n将此代入特定像素点 $\\mathbf{x}_0$ 的差分图像定义中，我们得到：\n$$D(\\mathbf{x}_0) = I_1(\\mathbf{x}_0 + \\delta\\mathbf{x}) - I_1(\\mathbf{x}_0)$$\n问题假设图像函数 $I_1(\\mathbf{x})$ 是可微的。因此，我们可以对 $I_1$ 在点 $\\mathbf{x}_0$ 周围使用一阶多元泰勒展开：\n$$I_1(\\mathbf{x}_0 + \\delta\\mathbf{x}) \\approx I_1(\\mathbf{x}_0) + \\nabla I_1(\\mathbf{x}_0) \\cdot \\delta\\mathbf{x}$$\n这里，$\\nabla I_1(\\mathbf{x}_0)$ 是图像强度在 $\\mathbf{x}_0$ 处的梯度，它是一个列向量，乘积是点积。这也可以写成 $\\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x}$。将此展开式代回 $D(\\mathbf{x}_0)$ 的表达式中：\n$$D(\\mathbf{x}_0) \\approx \\left( I_1(\\mathbf{x}_0) + \\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x} \\right) - I_1(\\mathbf{x}_0)$$\n这简化为伪变化信号的主阶贡献：\n$$D(\\mathbf{x}_0) \\approx \\nabla I_1(\\mathbf{x}_0)^T \\delta\\mathbf{x}$$\n\n其次，我们推导这个伪变化的期望幅值 $\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right]$ 的解析表达式。我们将伪变化建模为标量随机变量 $D_0 = \\mathbf{g}^T \\delta\\mathbf{x}$，其中我们定义常数向量 $\\mathbf{g} = \\nabla I_1(\\mathbf{x}_0)$。配准误差向量 $\\delta\\mathbf{x}$ 被建模为一个零均值二元高斯随机向量，$\\delta\\mathbf{x} \\sim \\mathcal{N}(\\mathbf{0}, \\boldsymbol{\\Sigma})$，其中 $\\mathbf{0}$ 是零向量，$\\boldsymbol{\\Sigma}$ 是协方差矩阵。\n\n多元高斯分布的一个基本性质是，高斯随机向量的任何线性变换都会得到另一个高斯随机变量（或向量）。由于 $D_0$ 是 $\\delta\\mathbf{x}$ 的标量线性变换，因此 $D_0$ 是一个一元高斯随机变量。我们来确定它的均值和方差。\n$D_0$ 的均值为：\n$$\\mathbb{E}[D_0] = \\mathbb{E}[\\mathbf{g}^T \\delta\\mathbf{x}] = \\mathbf{g}^T \\mathbb{E}[\\delta\\mathbf{x}] = \\mathbf{g}^T \\mathbf{0} = 0$$\n$D_0$ 的方差由随机向量线性变换方差的一般公式 $\\mathrm{Var}(\\mathbf{A}\\mathbf{y}) = \\mathbf{A}\\mathrm{Var}(\\mathbf{y})\\mathbf{A}^T$ 给出。在我们的标量情况下（$D_0 = \\mathbf{g}^T \\delta\\mathbf{x}$）：\n$$\\sigma_{D_0}^2 = \\mathrm{Var}(D_0) = \\mathrm{Var}(\\mathbf{g}^T \\delta\\mathbf{x}) = \\mathbf{g}^T \\mathrm{Var}(\\delta\\mathbf{x}) \\mathbf{g} = \\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}$$\n因此，$D_0$ 服从零均值正态分布，$D_0 \\sim \\mathcal{N}(0, \\sigma_{D_0}^2)$，其概率密度函数为 $f(d) = \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\frac{d^2}{2\\sigma_{D_0}^2}\\right)$。\n\n我们需要计算 $D_0$ 的绝对值的期望：\n$$\\mathbb{E}[|D_0|] = \\int_{-\\infty}^{\\infty} |d| f(d) \\, \\mathrm{d}d = \\int_{-\\infty}^{\\infty} |d| \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\frac{d^2}{2\\sigma_{D_0}^2}\\right) \\, \\mathrm{d}d$$\n由于被积函数是偶函数，我们可以将其简化为：\n$$\\mathbb{E}[|D_0|] = 2 \\int_{0}^{\\infty} d \\frac{1}{\\sqrt{2\\pi}\\sigma_{D_0}} \\exp\\left(-\\fracd^2}{2\\sigma_{D_0}^2}\\right) \\, \\mathrm{d}d$$\n这个积分是一个标准结果，对应于半正态分布的均值。其计算结果为：\n$$\\mathbb{E}[|D_0|] = \\sigma_{D_0} \\sqrt{\\frac{2}{\\pi}}$$\n代入 $\\sigma_{D_0}$ 的表达式：\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] = \\sqrt{\\frac{2}{\\pi}} \\sqrt{\\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}} = \\sqrt{\\frac{2}{\\pi} \\left( \\nabla I_1(\\mathbf{x}_0)^T \\boldsymbol{\\Sigma} \\nabla I_1(\\mathbf{x}_0) \\right)}$$\n\n第三，我们对这个表达式进行数值计算。给定的值为：\n$$\\nabla I_1(\\mathbf{x}_0) = \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix} \\quad \\text{和} \\quad \\boldsymbol{\\Sigma} = \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix}$$\n设 $\\mathbf{g} = \\nabla I_1(\\mathbf{x}_0)$。我们首先计算方差 $\\sigma_{D_0}^2 = \\mathbf{g}^T \\boldsymbol{\\Sigma} \\mathbf{g}$：\n$$\\sigma_{D_0}^2 = \\begin{pmatrix} 0.022  -0.015 \\end{pmatrix} \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix} \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix}$$\n首先，我们计算 $\\mathbf{g}^T \\boldsymbol{\\Sigma}$：\n$$\\begin{pmatrix} 0.022  -0.015 \\end{pmatrix} \\begin{pmatrix} 0.36  0.06 \\\\ 0.06  0.16 \\end{pmatrix} = \\begin{pmatrix} (0.022)(0.36) + (-0.015)(0.06)  (0.022)(0.06) + (-0.015)(0.16) \\end{pmatrix}$$\n$$= \\begin{pmatrix} 0.00792 - 0.0009  0.00132 - 0.0024 \\end{pmatrix} = \\begin{pmatrix} 0.00702  -0.00108 \\end{pmatrix}$$\n接下来，我们将此结果乘以 $\\mathbf{g}$：\n$$\\sigma_{D_0}^2 = \\begin{pmatrix} 0.00702  -0.00108 \\end{pmatrix} \\begin{pmatrix} 0.022 \\\\ -0.015 \\end{pmatrix} = (0.00702)(0.022) + (-0.00108)(-0.015)$$\n$$\\sigma_{D_0}^2 = 0.00015444 + 0.0000162 = 0.00017064$$\n标准差 $\\sigma_{D_0}$ 为：\n$$\\sigma_{D_0} = \\sqrt{0.00017064} \\approx 0.01306292$$\n最后，我们计算期望幅值：\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] = \\sigma_{D_0} \\sqrt{\\frac{2}{\\pi}} \\approx (0.01306292) \\times \\sqrt{\\frac{2}{\\pi}} \\approx (0.01306292) \\times (0.79788456)$$\n$$\\mathbb{E}\\left[|D(\\mathbf{x}_0)|\\right] \\approx 0.01042299$$\n四舍五入到 4 位有效数字，伪变化的期望幅值为 $0.01042$。该值以反射率为单位，是无量纲的。",
            "answer": "$$\\boxed{0.01042}$$"
        },
        {
            "introduction": "影像比值法是影像相减法的一种常用替代方法，尤其在消除光照差异方面效果显著。然而，如同任何衍生量一样，其数值会受到原始测量不确定性的影响。本练习应用了统计学中的一个基本工具——德尔塔方法（delta method），来分析测量噪声在除法运算中的传播规律。通过这项实践，您将掌握量化比值法变化指标不确定性的能力，从而能够构建置信区间，将变化检测从主观阈值设定转变为基于统计的稳健评估 。",
            "id": "3820727",
            "problem": "一种基于比率的变化检测方案使用比率图像 $R(\\mathbf{x}) = \\dfrac{X_{2}(\\mathbf{x})}{X_{1}(\\mathbf{x})}$，该图像是同一位置 $\\mathbf{x}$ 在两个采集日期的大气校正地表反射率之比。考虑单个像素，并将反射率建模为随机变量 $X_{1}$ 和 $X_{2}$，其均值有限，分别为 $\\mu_{1} = \\mathbb{E}[X_{1}]$、$\\mu_{2} = \\mathbb{E}[X_{2}]$，方差为 $\\sigma_{1}^{2} = \\mathrm{Var}(X_{1})$、$\\sigma_{2}^{2} = \\mathrm{Var}(X_{2})$，这些不确定性源于传感器和残余校正噪声。假设测量误差是无偏的，并且在不同日期之间是独立的，因此 $\\mathrm{Cov}(X_{1}, X_{2}) = 0$。还假设在每个日期内真实反射率是恒定的，因此不确定性主要由测量噪声决定。令 $g(x_{1}, x_{2}) = x_{2}/x_{1}$。\n\n仅从函数 $g$ 关于 $(\\mu_{1}, \\mu_{2})$ 的一阶多元泰勒展开和不确定性传播的标准法则（也称为 delta 方法）出发，完成以下任务：\n\n1. 在所述的独立性假设下，用 $\\mu_{1}$、$\\mu_{2}$、$\\sigma_{1}^{2}$ 和 $\\sigma_{2}^{2}$ 推导 $\\mathbb{E}[R]$ 和 $\\mathrm{Var}(R)$ 的一阶近似值。\n2. 基于你推导的方差表达式，使用 $R$ 的正态近似，为 $R$ 提出一个双侧 $(1-\\alpha)$ 置信区间 (CI)，其中 $\\alpha = 0.05$。\n3. 对于一个近红外像素，其参数为 $\\mu_{1} = 0.24$、$\\mu_{2} = 0.264$、$\\sigma_{1} = 0.01$ 和 $\\sigma_{2} = 0.012$，计算由你的推导得出的 $R$ 的双侧 $95\\%$ 置信区间的上端点。将你的答案四舍五入到四位有效数字。将结果表示为一个无量纲数（无单位）。",
            "solution": "我们从测量模型开始，其中 $X_{1}$ 和 $X_{2}$ 是代表两个日期的反射率的随机变量，其均值为 $\\mu_{1}$ 和 $\\mu_{2}$，方差为 $\\sigma_{1}^{2}$ 和 $\\sigma_{2}^{2}$，且 $\\mathrm{Cov}(X_{1}, X_{2}) = 0$。变化度量为 $R = g(X_{1}, X_{2})$，其中 $g(x_{1}, x_{2}) = x_{2}/x_{1}$。\n\n一阶多元泰勒展开（delta 方法）：对于可微函数 $g$ 和随机向量 $\\mathbf{X} = (X_{1}, X_{2})^{\\top}$（其均值为 $\\boldsymbol{\\mu} = (\\mu_{1}, \\mu_{2})^{\\top}$，协方差矩阵为 $\\boldsymbol{\\Sigma}$），一阶展开式为\n$$\ng(\\mathbf{X}) \\approx g(\\boldsymbol{\\mu}) + \\nabla g(\\boldsymbol{\\mu})^{\\top}(\\mathbf{X} - \\boldsymbol{\\mu}),\n$$\n传播的均值和方差为\n$$\n\\mathbb{E}[g(\\mathbf{X})] \\approx g(\\boldsymbol{\\mu}), \\quad \\mathrm{Var}(g(\\mathbf{X})) \\approx \\nabla g(\\boldsymbol{\\mu})^{\\top} \\boldsymbol{\\Sigma}\\, \\nabla g(\\boldsymbol{\\mu}).\n$$\n\n计算 $g$ 的梯度：\n- 关于 $x_{1}$ 的偏导数为\n$$\n\\frac{\\partial g}{\\partial x_{1}}(x_{1}, x_{2}) = -\\frac{x_{2}}{x_{1}^{2}}.\n$$\n- 关于 $x_{2}$ 的偏导数为\n$$\n\\frac{\\partial g}{\\partial x_{2}}(x_{1}, x_{2}) = \\frac{1}{x_{1}}.\n$$\n因此，\n$$\n\\nabla g(\\boldsymbol{\\mu}) =\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}} \\\\\n\\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}.\n$$\n\n在独立性假设下，协方差矩阵为\n$$\n\\boldsymbol{\\Sigma} =\n\\begin{pmatrix}\n\\sigma_{1}^{2}  0 \\\\\n0  \\sigma_{2}^{2}\n\\end{pmatrix}.\n$$\n\n因此，一阶传播均值和方差为：\n- 均值：\n$$\n\\mathbb{E}[R] \\approx g(\\boldsymbol{\\mu}) = \\frac{\\mu_{2}}{\\mu_{1}}.\n$$\n- 方差：\n$$\n\\mathrm{Var}(R) \\approx\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}}  \\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}\n\\begin{pmatrix}\n\\sigma_{1}^{2}  0 \\\\\n0  \\sigma_{2}^{2}\n\\end{pmatrix}\n\\begin{pmatrix}\n-\\dfrac{\\mu_{2}}{\\mu_{1}^{2}} \\\\\n\\dfrac{1}{\\mu_{1}}\n\\end{pmatrix}\n=\n\\left(\\frac{\\mu_{2}}{\\mu_{1}^{2}}\\right)^{2}\\sigma_{1}^{2} + \\left(\\frac{1}{\\mu_{1}}\\right)^{2}\\sigma_{2}^{2}.\n$$\n也就是说，\n$$\n\\mathrm{Var}(R) \\approx \\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}.\n$$\n\n为了提出 $R$ 的一个双侧 $(1-\\alpha)$ 置信区间，我们使用 delta 方法所蕴含的正态近似：\n$$\nR \\approx \\mathcal{N}\\!\\left(\\frac{\\mu_{2}}{\\mu_{1}},\\, \\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}\\right).\n$$\n令 $z_{1-\\alpha/2}$ 表示标准正态分布的上 $(1-\\alpha/2)$ 分位数。那么，一个双侧 $(1-\\alpha)$ 置信区间 (CI) 为\n$$\n\\left[\\frac{\\mu_{2}}{\\mu_{1}} - z_{1-\\alpha/2}\\,\\sqrt{\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}}\\,,\\;\\;\n\\frac{\\mu_{2}}{\\mu_{1}} + z_{1-\\alpha/2}\\,\\sqrt{\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} + \\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}}}\\right].\n$$\n\n将其应用于数值 $\\mu_{1} = 0.24$、$\\mu_{2} = 0.264$、$\\sigma_{1} = 0.01$ 和 $\\sigma_{2} = 0.012$，其中 $\\alpha = 0.05$，因此 $z_{1-\\alpha/2} \\approx 1.96$。\n\n1. 点估计：\n$$\n\\widehat{R} \\approx \\frac{\\mu_{2}}{\\mu_{1}} = \\frac{0.264}{0.24} = 1.1.\n$$\n\n2. 方差分量：\n$$\n\\frac{\\sigma_{2}^{2}}{\\mu_{1}^{2}} = \\frac{0.012^{2}}{0.24^{2}} = \\frac{0.000144}{0.0576} = 0.0025,\n$$\n$$\n\\frac{\\mu_{2}^{2}\\,\\sigma_{1}^{2}}{\\mu_{1}^{4}} = \\frac{0.264^{2}\\cdot 0.01^{2}}{0.24^{4}} = \\frac{0.069696\\cdot 0.0001}{0.00331776} = \\frac{0.0000069696}{0.00331776} = 0.002100694444\\ldots\n$$\n因此，\n$$\n\\mathrm{Var}(R) \\approx 0.0025 + 0.002100694444\\ldots = 0.004600694444\\ldots\n$$\n且\n$$\n\\mathrm{SD}(R) \\approx \\sqrt{0.004600694444\\ldots} = 0.067828\\ldots\n$$\n\n3. 双侧 $95\\%$ 置信区间的上端点：\n$$\n\\text{Upper} = \\widehat{R} + z_{0.975}\\,\\mathrm{SD}(R) \\approx 1.1 + 1.96 \\times 0.067828\\ldots \\approx 1.1 + 0.132944\\ldots = 1.232944\\ldots\n$$\n\n四舍五入到四位有效数字，上端点是 $1.233$（无量纲）。",
            "answer": "$$\\boxed{1.233}$$"
        },
        {
            "introduction": "传统的变化检测通常只比较两个离散的时间点，然而，许多环境过程是连续和周期性的，将“变化”定义为对这种预期模式的偏离往往更为恰当。这个动手编程练习将使用普通最小二乘法（OLS）来拟合一个谐波模型，以捕捉遥感时间序列中典型的季节性行为。通过将变化定义为相对于模型预测的异常，您将学到一种更为强大的技术，它对物候变化具有更强的稳健性，并能探测时间动态中的细微转变，这是现代遥感时间序列分析的基石 。",
            "id": "3820694",
            "problem": "您正在为遥感中的单个图像像素的单变量地表反射率时间序列建模。反射率是闭区间 $\\left[0,1\\right]$ 内的一个无量纲量，并且由于物候和光照几何的原因，它会随时间周期性变化。假设索引为 $x$ 的像素的期望反射率可以表示为已知周期 $T$ 上的截断傅里叶级数的一阶谐波，并且与期望的偏差是加性的、零均值的。您的任务是，从第一性原理出发，推导出一个有原则的估计器来估计任意时间的期望反射率，然后为一个预留观测值计算基于异常的差分，该差分可作为变化检测指标。\n\n从以下基本依据开始：\n- 周期为 $T$ 的周期信号可以展开为傅里叶级数。三角函数系统 $\\left\\{1,\\cos\\left(2\\pi t/T\\right),\\sin\\left(2\\pi t/T\\right)\\right\\}$ 在标准内积下构成一个周期上的正交基。\n- 对于加性零均值噪声下的线性模型，普通最小二乘法 (OLS) 是残差平方和的最小化方法，并产生数据在回归变量张成空间上的正交投影。\n- 余弦和正弦函数的参数以弧度为单位；因此，角度必须以弧度计算。\n\n仅使用这些依据，推导出以下形式的线性模型\n$$\nI_t(x) \\approx a_0(x) + a_1(x)\\cos\\left(\\frac{2\\pi t}{T}\\right) + a_2(x)\\sin\\left(\\frac{2\\pi t}{T}\\right),\n$$\n并说明如何使用普通最小二乘法 (OLS) 从一组训练观测值 $\\left\\{(t_i, I_{t_i}(x))\\right\\}_{i=1}^n$（不包括预留的目标时间）中估计系数 $a_0(x)$、$a_1(x)$ 和 $a_2(x)$。然后，定义并计算基于异常的差分\n$$\nD_a(x) = I_{t^\\star}(x) - \\widehat{I}_{t^\\star}(x),\n$$\n其中 $t^\\star$ 是一个预留时间，$I_{t^\\star}(x)$ 是在 $t^\\star$ 观测到的反射率，$\\widehat{I}_{t^\\star}(x)$ 是由拟合的谐波模型通过 OLS 预测的在 $t^\\star$ 的期望反射率。所有余弦和正弦参数必须以弧度为单位。反射率是无量纲的。\n\n实现要求：\n- 对于每个测试用例，仅使用其训练集 $\\left\\{(t_i, I_{t_i}(x))\\right\\}_{i=1}^n$ 和提供的周期 $T$ 拟合谐波模型，然后在指定的预留时间 $t^\\star$ 使用提供的观测反射率 $I_{t^\\star}(x)$ 计算 $D_a(x)$。\n- 使用普通最小二乘法 (OLS) 估计系数。如果求解正规方程，请确保数值稳定性；可接受使用数值稳健的最小二乘求解器。\n- 将每个测试用例的 $D_a(x)$ 报告为一个浮点数，四舍五入到 $6$ 位小数。\n\n角度单位说明：\n- 所有三角函数求值必须使用弧度。\n\n单位：\n- 反射率是无量纲的。对于以天为单位指定 $T$ 的情况，时间单位为天；否则，时间单位为任意时间单位。只要 $t$ 和 $T$ 共享相同的单位，单位的选择是无关紧要的。\n\n测试套件：\n将以下 $4$ 个测试用例作为常量提供给您的程序。对于每个用例，$T$ 是周期，$t_{\\text{train}}$ 是训练时间的列表，$I_{\\text{train}}$ 是相应训练反射率的列表，$t^\\star$ 是要评估的预留时间，$I_{t^\\star}$ 是预留的反射率。除时间和周期外，以下所有数字都是无量纲的。确保三角函数参数使用从这些时间和周期计算出的弧度。\n\n- 用例 $1$（一般季节性信号，多个样本）：\n  - $T = 365.0$\n  - $t_{\\text{train}} = [15.0, 80.0, 170.0, 260.0, 330.0]$\n  - $I_{\\text{train}} = [0.34, 0.31, 0.22, 0.20, 0.28]$\n  - $t^\\star = 200.0$\n  - $I_{t^\\star} = 0.27$\n- 用例 $2$（边界情况：恒定反射率，模型应塌缩为常数）：\n  - $T = 360.0$\n  - $t_{\\text{train}} = [0.0, 90.0, 180.0, 270.0]$\n  - $I_{\\text{train}} = [0.4, 0.4, 0.4, 0.4]$\n  - $t^\\star = 45.0$\n  - $I_{t^\\star} = 0.41$\n- 用例 $3$（边界情况：恰好三个训练点，若独立则唯一确定系数）：\n  - $T = 100.0$\n  - $t_{\\text{train}} = [0.0, 25.0, 50.0]$\n  - $I_{\\text{train}} = [0.35, 0.32, 0.25]$\n  - $t^\\star = 75.0$\n  - $I_{t^\\star} = 0.26$\n- 用例 $4$（理想情况，具有不规则采样和无噪声谐波一致性）：\n  - $T = 10.0$\n  - $t_{\\text{train}} = [1.0, 2.0, 3.0, 5.0, 7.0, 9.0]$\n  - $I_{\\text{train}} = [0.7176, 0.7902, 0.7902, 0.6, 0.4098, 0.4824]$\n  - $t^\\star = 4.0$\n  - $I_{t^\\star} = 0.6676$\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[r_1,r_2,r_3,r_4]$），其中 $r_i$ 是用例 $i$ 的 $D_a(x)$ 值，每个值都四舍五入到 $6$ 位小数。不要打印任何其他文本。",
            "solution": "该问题要求推导并应用普通最小二乘法 (OLS) 估计器，用于表示地表反射率时间序列数据的一阶谐波模型的系数。随后，该模型用于为预留观测值计算基于异常的差分。\n\n在时间 $t$ 像素 $x$ 的期望反射率 $I_t(x)$ 模型由一个周期为 $T$ 的截断傅里叶级数给出：\n$$\nI_t(x) \\approx \\widehat{I}_t(x) = a_0(x) + a_1(x)\\cos\\left(\\frac{2\\pi t}{T}\\right) + a_2(x)\\sin\\left(\\frac{2\\pi t}{T}\\right)\n$$\n为简化符号，像素索引 $x$ 将被省略，因为分析仅针对单个像素位置。角频率定义为 $\\omega = \\frac{2\\pi}{T}$。因此，模型为：\n$$\nI_t \\approx \\widehat{I}_t = a_0 + a_1\\cos(\\omega t) + a_2\\sin(\\omega t)\n$$\n该模型关于系数 $a_0$、$a_1$ 和 $a_2$ 是线性的。给定一组 $n$ 个训练观测值 $\\{(t_i, I_{t_i})\\}_{i=1}^n$，我们可以使用一个线性方程组来表示整个训练集的关系。令 $\\mathbf{y}$ 为观测反射率向量，$\\mathbf{\\beta}$ 为系数向量：\n$$\n\\mathbf{y} = \\begin{pmatrix} I_{t_1} \\\\ I_{t_2} \\\\ \\vdots \\\\ I_{t_n} \\end{pmatrix}, \\quad \\mathbf{\\beta} = \\begin{pmatrix} a_0 \\\\ a_1 \\\\ a_2 \\end{pmatrix}\n$$\n该方程组可以写成矩阵形式 $\\mathbf{y} \\approx \\mathbf{X}\\mathbf{\\beta}$，其中 $\\mathbf{X}$ 是一个 $n \\times 3$ 的设计矩阵，其行由在每个时间 $t_i$ 处求值的基函数构成：\n$$\n\\mathbf{X} = \\begin{pmatrix}\n1  \\cos(\\omega t_1)  \\sin(\\omega t_1) \\\\\n1  \\cos(\\omega t_2)  \\sin(\\omega t_2) \\\\\n\\vdots  \\vdots  \\vdots \\\\\n1  \\cos(\\omega t_n)  \\sin(\\omega t_n)\n\\end{pmatrix}\n$$\n普通最小二乘法 (OLS) 旨在寻找能够最小化残差平方和 (SSR) 的系数向量 $\\hat{\\mathbf{\\beta}}$，残差平方和是残差向量 $\\mathbf{e} = \\mathbf{y} - \\mathbf{X}\\mathbf{\\beta}$ 的欧几里得范数的平方：\n$$\n\\text{SSR}(\\mathbf{\\beta}) = \\sum_{i=1}^n (I_{t_i} - \\widehat{I}_{t_i})^2 = \\|\\mathbf{y} - \\mathbf{X}\\mathbf{\\beta}\\|^2\n$$\n最小化该量的向量 $\\hat{\\mathbf{\\beta}}$ 即为 OLS 估计。根据所述原理，OLS 产生数据向量 $\\mathbf{y}$ 在设计矩阵 $\\mathbf{X}$ 的列空间上的正交投影。解可以通过正规方程找到：\n$$\n(\\mathbf{X}^T \\mathbf{X}) \\hat{\\mathbf{\\beta}} = \\mathbf{X}^T \\mathbf{y}\n$$\n只要矩阵 $\\mathbf{X}^T \\mathbf{X}$ 是可逆的（这要求 $\\mathbf{X}$ 的列是线性无关的，如果 $n \\ge 3$ 且观测时间 $t_i$ 足够不同，则该条件满足），估计系数的唯一解为：\n$$\n\\hat{\\mathbf{\\beta}} = \\begin{pmatrix} \\hat{a}_0 \\\\ \\hat{a}_1 \\\\ \\hat{a}_2 \\end{pmatrix} = (\\mathbf{X}^T \\mathbf{X})^{-1} \\mathbf{X}^T \\mathbf{y}\n$$\n虽然这个方程提供了解析解，但在实现中首选使用数值稳健的算法（如基于 QR 分解的算法），以避免直接对 $\\mathbf{X}^T \\mathbf{X}$ 求逆可能带来的不稳定性。\n\n一旦从训练数据中估计出系数 $\\hat{\\mathbf{\\beta}} = [\\hat{a}_0, \\hat{a}_1, \\hat{a}_2]^T$，我们就可以预测在预留时间 $t^\\star$ 的期望反射率 $\\widehat{I}_{t^\\star}$。这通过应用拟合模型完成：\n$$\n\\widehat{I}_{t^\\star} = \\hat{a}_0 + \\hat{a}_1\\cos(\\omega t^\\star) + \\hat{a}_2\\sin(\\omega t^\\star)\n$$\n该预测可以表示为回归量向量 $\\mathbf{x}_{t^\\star}^T$ 和估计系数向量 $\\hat{\\mathbf{\\beta}}$ 的点积：\n$$\n\\mathbf{x}_{t^\\star} = \\begin{pmatrix} 1 \\\\ \\cos(\\omega t^\\star) \\\\ \\sin(\\omega t^\\star) \\end{pmatrix}, \\quad \\widehat{I}_{t^\\star} = \\mathbf{x}_{t^\\star}^T \\hat{\\mathbf{\\beta}}\n$$\n最后，基于异常的差分 $D_a$ 计算为在预留时间观测到的反射率 $I_{t^\\star}$ 与预测的反射率 $\\widehat{I}_{t^\\star}$ 之间的残差：\n$$\nD_a = I_{t^\\star} - \\widehat{I}_{t^\\star}\n$$\n这个量 $D_a$ 可作为变化检测指标。一个幅值较大的 $D_a$ 值表明，在时间 $t^\\star$ 的观测值与从训练数据中学到的既定周期性模式有显著偏差。$D_a$ 的符号表示偏差的方向。\n\n实现将对所提供的每个测试用例遵循此过程，使用数值稳定的最小二乘求解器找到 $\\hat{\\mathbf{\\beta}}$，然后计算 $D_a$。所有三角函数的参数都按规定以弧度计算。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the harmonic model fitting and anomaly detection problem for all test cases.\n    \"\"\"\n    # Define the 4 test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general seasonal signal, multiple samples)\n        {\n            \"T\": 365.0,\n            \"t_train\": [15.0, 80.0, 170.0, 260.0, 330.0],\n            \"I_train\": [0.34, 0.31, 0.22, 0.20, 0.28],\n            \"t_star\": 200.0,\n            \"I_t_star\": 0.27\n        },\n        # Case 2 (boundary: constant reflectance)\n        {\n            \"T\": 360.0,\n            \"t_train\": [0.0, 90.0, 180.0, 270.0],\n            \"I_train\": [0.4, 0.4, 0.4, 0.4],\n            \"t_star\": 45.0,\n            \"I_t_star\": 0.41\n        },\n        # Case 3 (boundary: exactly three training points)\n        {\n            \"T\": 100.0,\n            \"t_train\": [0.0, 25.0, 50.0],\n            \"I_train\": [0.35, 0.32, 0.25],\n            \"t_star\": 75.0,\n            \"I_t_star\": 0.26\n        },\n        # Case 4 (happy path with irregular sampling)\n        {\n            \"T\": 10.0,\n            \"t_train\": [1.0, 2.0, 3.0, 5.0, 7.0, 9.0],\n            \"I_train\": [0.7176, 0.7902, 0.7902, 0.6, 0.4098, 0.4824],\n            \"t_star\": 4.0,\n            \"I_t_star\": 0.6676\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Extract data for the current case\n        T = case[\"T\"]\n        t_train = np.array(case[\"t_train\"])\n        I_train = np.array(case[\"I_train\"])\n        t_star = case[\"t_star\"]\n        I_t_star = case[\"I_t_star\"]\n        \n        # Calculate angular frequency omega\n        omega = (2 * np.pi) / T\n        \n        # Construct the design matrix X for the training data\n        # The columns are 1, cos(omega*t), sin(omega*t)\n        n = len(t_train)\n        X = np.zeros((n, 3))\n        X[:, 0] = 1.0\n        X[:, 1] = np.cos(omega * t_train)\n        X[:, 2] = np.sin(omega * t_train)\n        \n        # Use Ordinary Least Squares (OLS) to estimate the coefficients beta_hat = [a0, a1, a2]\n        # np.linalg.lstsq is a numerically stable way to solve the normal equations.\n        beta_hat, _, _, _ = np.linalg.lstsq(X, I_train, rcond=None)\n        \n        # Construct the regressor vector for the held-out time t_star\n        x_star = np.array([1.0, np.cos(omega * t_star), np.sin(omega * t_star)])\n\n        # Predict the reflectance at t_star using the fitted model\n        I_hat_t_star = x_star @ beta_hat\n        \n        # Compute the anomaly-based difference Da\n        Da = I_t_star - I_hat_t_star\n        \n        # Append the result to the list of results\n        results.append(Da)\n\n    # Format the final output as a comma-separated list in brackets, rounded to 6 decimal places.\n    print(f\"[{','.join([f'{r:.6f}' for r in results])}]\")\n\nsolve()\n```"
        }
    ]
}