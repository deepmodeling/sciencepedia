{
    "hands_on_practices": [
        {
            "introduction": "所有流域划分工作都始于理解水流如何流经数字化的地表。本练习将剖析地理信息系统（GIS）软件所使用的基础算法（D8算法），让学生亲手计算流向和流量累积。通过这项动手实践，可以揭开自动化过程的神秘面纱，并建立对数字高程模型（DEM）如何进行水文解译的核心理解。",
            "id": "3866230",
            "problem": "一个从激光雷达（LiDAR）数据派生的数字高程模型（DEM）在一个用于水文地形分析的均匀方形网格上提供以单元格为中心的高程。考虑一个方形区域上的合成DEM，该区域由一个 $3 \\times 3$ 的单元格集合组成，网格间距为 $\\Delta x = 30$ 米。流向将使用D8算法来分配，该算法基于以下基本定义：朝向八个邻居中每一个的局部地形坡度大小近似为高程降与中心间距的比值，其中到四个基本方向邻居的距离为 $\\Delta x$，到四个对角线邻居的距离为 $\\Delta x \\sqrt{2}$。对于每个单元格，流向被分配给具有最大正坡度大小（最陡下降）的单个邻居。汇流累积量定义为在有限域内流入给定单元格的单元格数量，包括该单元格本身（贡献为 $1$），并且没有来自 $3 \\times 3$ 域外部的流入。\n\n用 $(i,j)$ 对网格进行索引，其中 $i \\in \\{1,2,3\\}$ 表示从北到南的行， $j \\in \\{1,2,3\\}$ 表示从西到东的列。高程 $z(i,j)$（单位：米）如下：\n- $(1,1)$: $z=99$,\n- $(1,2)$: $z=98$,\n- $(1,3)$: $z=94$,\n- $(2,1)$: $z=97$,\n- $(2,2)$: $z=100$,\n- $(2,3)$: $z=95$,\n- $(3,1)$: $z=96$,\n- $(3,2)$: $z=96$,\n- $(3,3)$: $z=93$.\n\n首先，仅使用上述基本定义，确定所有九个单元格的D8流向。然后，确定单元格 $(2,3)$ 的基准汇流累积量。\n\n接下来，评估D8分配和汇流累积量对中心单元格东侧邻居高程微小扰动的敏感性。具体来说，将 $(2,3)$ 处的高程增加一个非负扰动 $\\delta$，使其扰动后的高程变为 $z(2,3) + \\delta$。确定最小的严格正扰动 $\\delta_{\\min}$，使得中心单元格 $(2,2)$ 的D8出流方向偏离其基准方向，从而使单元格 $(2,3)$ 的汇流累积量恰好比其基准值减少 $1$。\n\n仅报告 $\\delta_{\\min}$ 的值。以米为单位表示最终答案，并四舍五入到四位有效数字。",
            "solution": "该问题是有效的。它在科学上基于流域水文学的既定原则（D8流向算法，汇流累积），问题陈述清晰，可以从提供的数据中辨别出唯一解，并且它是客观的，使用了精确的定义和定量数据。所有必要的信息都已提供，没有内部矛盾。\n\nD8流向算法将水流从中心单元格分配给其八个邻居之一。主导标准是最大正地形坡度，定义为高程降除以中心间距。设 $z_c$ 为中心单元格的高程，$z_n$ 为邻居单元格的高程。坡度 $S$ 由下式给出：\n$$S = \\frac{z_c - z_n}{L}$$\n其中距离 $L$ 对于基本方向邻居（北、南、东、西）是网格间距 $\\Delta x$，对于对角线邻居（东北、西北、东南、西南）是 $\\Delta x \\sqrt{2}$。在本问题中，$\\Delta x = 30$ 米。\n\n首先，我们确定中心单元格 $(2,2)$ 的基准流向，其高程为 $z(2,2) = 100$ 米。我们计算到所有八个邻居的坡度。高程数据为：$z(1,1)=99$, $z(1,2)=98$, $z(1,3)=94$, $z(2,1)=97$, $z(2,3)=95$, $z(3,1)=96$, $z(3,2)=96$, $z(3,3)=93$。\n\n从单元格 $(2,2)$ 到其邻居 $(i,j)$ 的坡度 $S_{2,2 \\to i,j}$ 如下：\n- 到 $(1,1)$: $S_{2,2 \\to 1,1} = \\frac{100 - 99}{\\Delta x \\sqrt{2}} = \\frac{1}{\\Delta x \\sqrt{2}}$\n- 到 $(1,2)$: $S_{2,2 \\to 1,2} = \\frac{100 - 98}{\\Delta x} = \\frac{2}{\\Delta x}$\n- 到 $(1,3)$: $S_{2,2 \\to 1,3} = \\frac{100 - 94}{\\Delta x \\sqrt{2}} = \\frac{6}{\\Delta x \\sqrt{2}}$\n- 到 $(2,1)$: $S_{2,2 \\to 2,1} = \\frac{100 - 97}{\\Delta x} = \\frac{3}{\\Delta x}$\n- 到 $(2,3)$: $S_{2,2 \\to 2,3} = \\frac{100 - 95}{\\Delta x} = \\frac{5}{\\Delta x}$\n- 到 $(3,1)$: $S_{2,2 \\to 3,1} = \\frac{100 - 96}{\\Delta x \\sqrt{2}} = \\frac{4}{\\Delta x \\sqrt{2}}$\n- 到 $(3,2)$: $S_{2,2 \\to 3,2} = \\frac{100 - 96}{\\Delta x} = \\frac{4}{\\Delta x}$\n- 到 $(3,3)$: $S_{2,2 \\to 3,3} = \\frac{100 - 93}{\\Delta x \\sqrt{2}} = \\frac{7}{\\Delta x \\sqrt{2}}$\n\n为了比较这些坡度，我们可以比较 $(\\text{drop}) / (\\text{distance}/\\Delta x)$ 的值。需要比较的值是 $1/\\sqrt{2}$、 $2$、 $6/\\sqrt{2}$、 $3$、 $5$、 $4/\\sqrt{2}$、 $4$ 和 $7/\\sqrt{2}$。\n数值上，它们约等于 $0.707$、$2$、$4.243$、$3$、$5$、$2.828$、$4$ 和 $4.950$。\n最大值为 $5$，对应于朝向单元格 $(2,3)$ 的坡度。因此，从单元格 $(2,2)$ 出发的基准流向是指向单元格 $(2,3)$。\n\n单元格 $(2,3)$ 的基准汇流累积量是流入它的单元格数量，包括它本身。根据对整个网格的完整分析（为简洁起见此处省略，但已经过验证），只有单元格 $(2,2)$ 流入 $(2,3)$。因此，贡献单元格是 $(2,2)$ 和 $(2,3)$ 本身。$(2,3)$ 的基准汇流累积量是 $1+1=2$。\n\n接下来，我们分析扰动。单元格 $(2,3)$ 的高程增加一个非负量 $\\delta$，因此其新高程为 $z'(2,3) = 95 + \\delta$。这个变化只影响从 $(2,2)$ 到 $(2,3)$ 的坡度。新的坡度 $S'_{2,2 \\to 2,3}$ 为：\n$$S'_{2,2 \\to 2,3} = \\frac{100 - (95 + \\delta)}{\\Delta x} = \\frac{5 - \\delta}{\\Delta x}$$\n问题要求找到最小的严格正扰动 $\\delta_{\\min}$，该扰动改变了 $(2,2)$ 的流向，从而使 $(2,3)$ 的汇流累积量恰好减少 $1$。这种情况发生在单元格 $(2,2)$ 不再流入 $(2,3)$ 时。要使流向改变，坡度 $S'_{2,2 \\to 2,3}$ 必须不再是最大坡度。新的流向将指向具有第二高原始坡度的邻居。\n\n根据基准计算，第二高的坡度是 $S_{2,2 \\to 3,3} = \\frac{7}{\\Delta x \\sqrt{2}}$（对应分数为 $4.950$，是剩余分数中的最大值）。当到 $(2,3)$ 的坡度变得小于到 $(3,3)$ 的坡度时，从 $(2,2)$ 出发的流向将从 $(2,3)$ 切换到 $(3,3)$。这种变化的阈值发生在两个坡度相等时。最小扰动 $\\delta_{\\min}$ 对应于此相等条件：\n$$S'_{2,2 \\to 2,3} = S_{2,2 \\to 3,3}$$\n$$\\frac{5 - \\delta_{\\min}}{\\Delta x} = \\frac{7}{\\Delta x \\sqrt{2}}$$\n我们可以消去两边的 $\\Delta x$：\n$$5 - \\delta_{\\min} = \\frac{7}{\\sqrt{2}}$$\n求解 $\\delta_{\\min}$：\n$$\\delta_{\\min} = 5 - \\frac{7}{\\sqrt{2}}$$\n这个 $\\delta_{\\min}$ 的值是严格为正的，因为 $5 > 7/\\sqrt{2}$（因为 $5\\sqrt{2} \\approx 7.07 > 7$）。在这个阈值下，从 $(2,2)$ 出发的流被引向 $(3,3)$。这将流入 $(2,3)$ 的单元格数量减少了一个，并且经检查确认没有其他单元格被重新路由到 $(2,3)$。因此，$(2,3)$ 的汇流累积量从 $2$ 严格减少到 $1$，变化量恰好为 $1$，满足题目条件。\n\n最后，我们计算 $\\delta_{\\min}$ 的数值，并四舍五入到四位有效数字。\n$$\\delta_{\\min} = 5 - \\frac{7}{\\sqrt{2}} = 5 - \\frac{7\\sqrt{2}}{2} \\approx 5 - \\frac{7 \\times 1.41421356}{2} \\approx 5 - 4.94974746 = 0.05025254$$\n四舍五入到四位有效数字得到 $0.05025$。",
            "answer": "$$\\boxed{0.05025}$$"
        },
        {
            "introduction": "在描绘了流域的结构之后，我们转向模拟其水文功能。本练习要求学生从第一性原理出发，推导出一个降雨-径流模型（纳什瞬时单位线），将流域概念化为一个线性水库系统。通过实施该模型，学生不仅能将降水转化为流量过程线，还能探究输入数据的时间分辨率对模拟精度的关键影响，这是实际建模中的一个核心考量。",
            "id": "3866245",
            "problem": "一位水文模型专家正在评估将降水从精细分辨率进行时间聚合到粗略分辨率，如何改变模拟的流域响应。考虑一个面积恒定的单一分水岭，并假设一个线性的、时不变的降雨-径流转换，由瞬时单位线 (IUH) 表示。IUH 将根据 Nash 构想的等容线性水库串联模型推导得出。目的是量化时间聚合对模拟过程线的两种影响：洪峰衰减和时间偏移。\n\n从基本原理出发，使用线性水库的质量守恒和线性时不变系统的标准属性来推导并实现降雨-径流转换。不要引用任何现成的简化公式；从水库的质量平衡和单位线的定义开始。您的推导应导出一个以小时为时间步长的离散时间计算方案，该方案能在给定有效降雨强度过程线（采用一致的物理单位）的情况下，模拟分水岭出口的流量。您必须通过包含物理上一致的单位换算和使用合理的参数值来确保科学真实性。\n\n假设和定义：\n- 分水岭表现为一个线性时不变系统，其输入为有效降雨强度，输出为流量。\n- 降雨-径流转换由一个 IUH 表示，该 IUH 源自 $n$ 个相同的线性水库串联，每个水库的滞留时间为 $k$。$n$ 和 $k$ 均为常数，且 $n$ 是一个大于或等于 $1$ 的整数。\n- 分水岭面积恒定，等于 $A$。\n- 有效降雨强度 $i_e(t)$ 是观测降雨强度 $p(t)$ 的一个恒定分数 $C$；即，损失由一个无量纲的径流系数 $C$ 表示，使得对于所有 $t$，都有 $i_e(t) = C \\, p(t)$。\n- 必须正确应用单位换算：降雨强度 $p(t)$ 以毫米/小时 (mm/hr) 为单位，滞留时间 $k$ 以小时 (hr) 为单位，面积 $A$ 以平方公里 (km$^2$) 为单位，流量必须以立方米/秒 (m$^3$/s) 报告。不使用角度。所有涉及物理时间差的输出必须以小时为单位。\n\n推导和计算要求：\n1.  从单个线性水库的质量守恒开始：$\\dfrac{ds}{dt} = u(t) - \\dfrac{s(t)}{k}$，其中 $s(t)$ 是蓄水量， $u(t)$ 是入流量，$k$ 是滞留时间。将其推广到 $n$ 个具有相同 $k$ 值的串联水库，并推导出对应于单位脉冲有效降雨输入的 IUH $h(t)$。建立流量 $Q(t)$ 关于有效降雨强度 $i_e(t)$ 和 IUH $h(t)$ 的连续时间卷积表达式，然后生成其在固定时间步长 $\\Delta t$（以小时为单位）下的离散时间近似。确保您的离散时间方案在给定 $p(t)$（单位 mm/hr）的情况下，能得出 $Q(t)$（单位 m$^3$/s），并明确应用单位换算。\n2.  实现一个算法，以小时分辨率计算两条出流过程线：一条使用原始的逐时降水过程线，另一条使用该过程线的按日聚合版本。按日聚合意味着将每天内的 $24$ 个小时值相加，得到日总降水量（单位 mm/day），然后将该总量均匀地分配回当天的 $24$ 小时内，形成该天恒定的小时降雨强度（单位 mm/hr）。\n3.  对于每对过程线，计算两个指标：\n    -   洪峰衰减比 $r = \\dfrac{Q_{\\text{peak, daily}}}{Q_{\\text{peak, hourly}}}$（无量纲小数）。\n    -   洪峰时间偏移 $\\Delta t_{\\text{peak}} = t_{\\text{peak, daily}} - t_{\\text{peak, hourly}}}$（以小时为单位）。\n    此处 $Q_{\\text{peak, hourly}}$ 和 $Q_{\\text{peak, daily}}$ 是模拟的最大流量（单位 m$^3$/s），$t_{\\text{peak, hourly}}$ 和 $t_{\\text{peak, daily}}$ 是它们出现的时间（从过程线开始算起，以小时为单位）。\n\n测试套件和参数：\n除非另有说明，所有案例均使用以下参数值：分水岭面积 $A = 150$ km$^2$，径流系数 $C = 0.5$，Nash 串联水库数量 $n = 4$，滞留时间 $k = 6$ hr，小时时间步长 $\\Delta t = 1$ hr。离散时间中的 IUH 支持长度必须足够长，以基本捕捉到完整的响应；选择一个对于这些参数而言在科学上合理的核长度。\n\n定义三个降水过程线，单位为 mm/hr：\n- 案例 $1$（一日内的暴雨）：长度 $72$ 小时。除以下时段外，所有小时的 $p(t) = 0$ mm/hr：\n  - 第 $15$ 小时：$3$ mm/hr。\n  - 第 $20, 21, 22$ 小时：分别为 $12, 25, 18$ mm/hr。\n  - 所有其他小时：$0$ mm/hr。\n- 案例 $2$（脉冲式暴雨）：长度 $48$ 小时。$p(0) = 20$ mm/hr。所有其他小时：$0$ mm/hr。\n- 案例 $3$（均匀降雨）：长度 $48$ 小时。所有小时的 $p(t) = 1$ mm/hr。\n\n要求的最终输出格式：\n您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表，其中每个元素对应一个测试案例，并且本身是一个包含浮点数的二元列表 $[r, \\Delta t_{\\text{peak}}]$，按案例 $1, 2, 3$ 的顺序排列；例如，$[[r_1,\\Delta t_1],[r_2,\\Delta t_2],[r_3,\\Delta t_3]]$。比率 $r$ 必须是一个不带百分号的小数，时间偏移必须以小时为单位。",
            "solution": "该问题要求基于 Nash 线性水库串联模型推导并实现一个降雨-径流模型，以分析降水时间聚合的影响。推导将从线性水库的质量守恒基本原理开始，然后发展到离散时间的卷积方案。\n\n### 1. 瞬时单位线 (IUH) 的推导\n\n该系统被概念化为 $n$ 个相同线性水库的串联，每个水库的特征是其滞留时间 $k$。\n\n**单个线性水库：**\n单个水库的质量守恒原理指出，蓄水量的变化率 $\\dfrac{ds}{dt}$ 等于入流速率 $u(t)$ 减去出流速率 $o(t)$：\n$$\n\\frac{ds}{dt} = u(t) - o(t)\n$$\n对于线性水库，蓄水量与出流量成正比，比例常数为滞留时间 $k$：\n$$\ns(t) = k \\cdot o(t)\n$$\n将此关系代入质量平衡方程，得到：\n$$\nk \\frac{do}{dt} = u(t) - o(t)\n$$\n这可以重新整理成一个标准的一阶线性常微分方程：\n$$\n\\frac{do}{dt} + \\frac{1}{k} o(t) = \\frac{1}{k} u(t)\n$$\n瞬时单位线 (IUH)，记为 $h(t)$，被定义为对单位脉冲入流（即 $u(t) = \\delta(t)$，其中 $\\delta(t)$ 是狄拉克δ函数）的出流响应 $o(t)$。对于 $t > 0$，入流为零，方程变为齐次的：\n$$\n\\frac{dh_1}{dt} + \\frac{1}{k} h_1(t) = 0\n$$\n该方程的解是一个指数衰减函数：$h_1(t) = C_1 e^{-t/k}$。常数 $C_1$ 由总出流量必须等于单位入流量的条件确定，即 $\\int_0^\\infty h_1(t) dt = 1$。\n$$\n\\int_0^\\infty C_1 e^{-t/k} dt = C_1 \\left[-k e^{-t/k}\\right]_0^\\infty = C_1 k = 1 \\implies C_1 = \\frac{1}{k}\n$$\n因此，单个线性水库的 IUH 为：\n$$\nh_1(t) = \\frac{1}{k} e^{-t/k} \\quad \\text{for } t \\ge 0\n$$\n\n**n 个线性水库串联（Nash 模型）：**\n对于 $n$ 个相同水库的串联，一个水库的出流成为下一个水库的入流。整个串联系统的 IUH，$h_n(t)$，是通过将单个水库的 IUH 与自身进行 $n-1$ 次卷积得到的：\n$$\nh_n(t) = \\underbrace{h_1(t) * h_1(t) * \\dots * h_1(t)}_{n \\text{ times}}\n$$\n这个运算在拉普拉斯域中进行最为方便。$h_1(t)$ 的拉普拉斯变换，记为 $H_1(s)$，是：\n$$\nH_1(s) = \\mathcal{L}\\left\\{\\frac{1}{k} e^{-t/k}\\right\\} = \\frac{1}{k} \\frac{1}{s + 1/k} = \\frac{1}{1+ks}\n$$\n对于 $n$ 个串联水库，系统的传递函数是各个传递函数的乘积：\n$$\nH_n(s) = [H_1(s)]^n = \\left(\\frac{1}{1+ks}\\right)^n = \\frac{1}{k^n(s+1/k)^n}\n$$\nIUH $h_n(t)$ 是 $H_n(s)$ 的拉普拉斯逆变换。使用标准变换对 $\\mathcal{L}^{-1}\\left\\{\\frac{1}{(s+a)^n}\\right\\} = \\frac{t^{n-1}e^{-at}}{(n-1)!}$，我们发现：\n$$\nh_n(t) = \\mathcal{L}^{-1}\\{H_n(s)\\} = \\frac{1}{k^n} \\frac{t^{n-1}e^{-t/k}}{(n-1)!}\n$$\n认识到对于整数 $n \\ge 1$，$(n-1)! = \\Gamma(n)$，其中 $\\Gamma$ 是伽马函数，Nash 串联模型的 IUH 为：\n$$\nh_n(t) = \\frac{1}{k\\Gamma(n)} \\left(\\frac{t}{k}\\right)^{n-1} e^{-t/k} \\quad \\text{for } t \\ge 0\n$$\n该函数描述了通过串联系统的行程时间的概率分布，单位为 $\\text{time}^{-1}$，其在 $[0, \\infty)$ 上的积分为1。\n\n### 2. 降雨-径流转换与离散化\n\n分水岭被视为一个线性时不变系统。输出（流量 $Q(t)$）是输入（有效降雨率 $u(t)$）与系统脉冲响应（IUH $h_n(t)$）的卷积。\n\n水文系统的输入是流域面积 $A$ 上的有效降雨率。给定观测到的降雨强度（雨量图）$p(t)$ 和径流系数 $C$，有效降雨强度为 $i_e(t) = C \\cdot p(t)$。总入流率 $u(t)$ 是该强度乘以面积 $A$：\n$$\nu(t) = A \\cdot i_e(t) = A \\cdot C \\cdot p(t)\n$$\n出口处的流量则由卷积分给出：\n$$\nQ(t) = \\int_0^t u(\\tau) h_n(t-\\tau) d\\tau\n$$\n对于具有固定时间步长 $\\Delta t$ 的离散时间实现，该积分由求和近似。设 $p_i = p(i\\Delta t)$ 为离散雨量图，$u_i = u(i\\Delta t)$ 为离散入流，$Q_j = Q(j\\Delta t)$ 为离散出流过程线。卷积的离散形式为：\n$$\nQ_j = \\sum_{i=0}^{j} u_i \\cdot (h_{n, j-i} \\Delta t)\n$$\n其中 $h_{n,m} = h_n(m\\Delta t)$。项 $H_m = h_{n,m} \\Delta t$ 代表离散时间单位线核，它是一组无量纲的纵坐标，其和近似为 $1$。卷积变为 $Q_j = \\sum_{i=0}^{j} u_i H_{j-i}$。\n\n**单位换算：**\n确保单位一致至关重要。问题规定：\n- $p(t)$ 单位为 mm/hr\n- $A$ 单位为 km$^2$\n- $k$ 单位为 hr\n- $\\Delta t$ 单位为 hr\n- $Q(t)$ 必须以 m$^3$/s 为单位\n\n入流率 $u(t)$ 必须从 [km$^2 \\cdot$ mm/hr] 单位转换为 [m$^3$/s]：\n$$\n1 \\text{ km}^2 \\cdot \\frac{\\text{mm}}{\\text{hr}} = (10^3 \\text{ m})^2 \\cdot \\frac{10^{-3} \\text{ m}}{3600 \\text{ s}} = \\frac{10^6 \\cdot 10^{-3}}{3600} \\frac{\\text{m}^3}{\\text{s}} = \\frac{1000}{3600} \\frac{\\text{m}^3}{\\text{s}} = \\frac{1}{3.6} \\frac{\\text{m}^3}{\\text{s}}\n$$\n因此，换算系数为 $\\frac{1}{3.6}$。以 m$^3$/s 为单位的离散入流为：\n$$\nu_i \\left[\\frac{\\text{m}^3}{\\text{s}}\\right] = \\frac{1}{3.6} \\cdot A [\\text{km}^2] \\cdot C \\cdot p_i \\left[\\frac{\\text{mm}}{\\text{hr}}\\right]\n$$\n当 $u_i$ 的单位为 m$^3$/s 且 $H_{j-i}$ 为无量纲时，得到的流量 $Q_j$ 的单位将正确地为 m$^3$/s。\n\n### 3. 计算算法\n\n解决该问题的过程如下：\n1.  **设置参数**：定义常数 $A = 150$, $C = 0.5$, $n = 4$, $k = 6$, 和 $\\Delta t = 1$。\n2.  **定义 IUH 核**：计算离散 IUH 纵坐标 $H_m = h_n(m\\Delta t)\\Delta t$ for $m = 0, 1, 2, \\dots, M-1$。\n    $$\n    H_m = \\left( \\frac{1}{k\\Gamma(n)} \\left(\\frac{m\\Delta t}{k}\\right)^{n-1} e^{-m\\Delta t/k} \\right) \\Delta t\n    $$\n    核长度 $M$ 必须足够长，以使 IUH 衰减到可忽略的值。IUH 的峰值出现在 $t_{peak} = (n-1)k = (4-1) \\times 6 = 18$ 小时。长度为 $M=200$ 小时是绰绰有余的。\n3.  **处理降水**：对于每个测试案例：\n    a.  **逐时雨量图**：直接使用给定的逐时降水 $p_{\\text{hourly}}(t)$。\n    b.  **按日聚合雨量图**：将逐时雨量图聚合为日总降水量，然后将其均匀地重新分配到当天的 $24$ 小时内。对于每一天 $d$：\n        $$\n        p_{\\text{daily, total}} = \\sum_{i=d \\cdot 24}^{(d+1)\\cdot 24 - 1} p_{\\text{hourly}}(i \\Delta t) \\Delta t\n        $$\n        $$\n        p_{\\text{daily, intensity}} = \\frac{p_{\\text{daily, total}}}{24 \\text{ hr}}\n        $$\n        将这个恒定的强度应用于第 $d$ 天的所有 $24$ 小时，以形成聚合后的雨量图 $p_{\\text{daily}}(t)$。\n4.  **模拟过程线**：对于逐时和按日聚合的雨量图：\n    a.  使用单位换算系数计算以 m$^3$/s 为单位的入流过程线 $u_i$。\n    b.  通过将入流 $u_i$ 与 IUH 核 $H_m$ 进行卷积来计算出流过程线 $Q_j$：$Q = u * H$。\n5.  **计算指标**：\n    a.  找出逐时和按日聚合模拟的峰值流量 $Q_{\\text{peak}} = \\max(Q_j)$ 和洪峰时间 $t_{\\text{peak}} = \\arg\\max(Q_j) \\cdot \\Delta t$。\n    b.  计算洪峰衰减比：$r = \\frac{Q_{\\text{peak, daily}}}{Q_{\\text{peak, hourly}}}$。\n    c.  计算洪峰时间偏移：$\\Delta t_{\\text{peak}} = t_{\\text{peak, daily}} - t_{\\text{peak, hourly}}}$。\n6.  **整理结果**：为三个测试案例中的每一个计算对 $[r, \\Delta t_{\\text{peak}}]$，并以要求的格式呈现。对于案例 $3$，由于降雨是均匀的，逐时和按日聚合的雨量图是相同的，这提供了一个检验，即 $r$ 应为 $1.0$，$\\Delta t_{\\text{peak}}$ 应为 $0.0$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gamma\n\ndef solve():\n    \"\"\"\n    Solves the watershed hydrologic modeling problem.\n\n    This function derives and implements a rainfall-runoff transformation based\n    on the Nash Instantaneous Unit Hydrograph (IUH) model. It calculates two\n    hydrographs for each given precipitation scenario: one from the original\n    hourly data and one from a daily-aggregated version. Finally, it computes\n    metrics for peak attenuation and timing shift caused by the aggregation.\n    \"\"\"\n\n    # --- Problem Parameters ---\n    A = 150.0  # Watershed area in km^2\n    C = 0.5    # Runoff coefficient (dimensionless)\n    n = 4      # Number of Nash reservoirs (integer)\n    k = 6.0    # Reservoir residence time in hours\n    dt = 1.0   # Time step in hours\n\n    # --- Test Cases: Precipitation Hyetographs (mm/hr) ---\n    p_case1 = np.zeros(72)\n    p_case1[15] = 3.0\n    p_case1[20] = 12.0\n    p_case1[21] = 25.0\n    p_case1[22] = 18.0\n\n    p_case2 = np.zeros(48)\n    p_case2[0] = 20.0\n\n    p_case3 = np.ones(48)\n\n    test_cases = [\n        {\"name\": \"Case 1\", \"p_hourly\": p_case1},\n        {\"name\": \"Case 2\", \"p_hourly\": p_case2},\n        {\"name\": \"Case 3\", \"p_hourly\": p_case3},\n    ]\n\n    results = []\n\n    # --- IUH Kernel Calculation (common for all cases) ---\n    # Choose a kernel length long enough for the hydrograph to recede.\n    # Peak of IUH is at t = (n-1)*k = (4-1)*6 = 18 hours.\n    # A length of 200 hours is scientifically reasonable and safe.\n    kernel_len = 200\n    t = np.arange(kernel_len) * dt\n    \n    # Nash IUH formula: h(t) = (1/(k*Gamma(n))) * (t/k)^(n-1) * exp(-t/k)\n    # Using np.power with where=t>0 avoids issues with 0^0 or 0^negative.\n    h = (1.0 / (k * gamma(n))) * np.power(t / k, n - 1, where=t>0, out=np.zeros_like(t)) * np.exp(-t / k)\n    \n    # The discrete unit hydrograph kernel H is h(t)*dt.\n    # Its elements are dimensionless and sum to approx. 1.\n    H = h * dt\n\n    for case in test_cases:\n        p_hourly = case[\"p_hourly\"]\n        \n        # --- 1. Daily Aggregation of Precipitation ---\n        p_daily_agg = np.zeros_like(p_hourly)\n        num_hours = len(p_hourly)\n        num_days = int(np.ceil(num_hours / 24.0))\n\n        for day in range(num_days):\n            start_hour = day * 24\n            # Ensure the end_hour slice does not exceed the array length\n            end_hour = min((day + 1) * 24, num_hours)\n            \n            if start_hour >= end_hour:\n                continue\n\n            daily_total_mm = np.sum(p_hourly[start_hour:end_hour])\n            daily_intensity_mm_hr = daily_total_mm / 24.0\n            \n            p_daily_agg[start_hour:end_hour] = daily_intensity_mm_hr\n\n        # --- 2. Compute Inflow and Convolve to get Discharge ---\n        # Conversion factor from [km^2 * mm/hr] to [m^3/s] is 1/3.6\n        conversion_factor = 1.0 / 3.6\n\n        def compute_discharge(p_hyetograph):\n            # Calculate inflow u(t) in m^3/s\n            u = conversion_factor * A * C * p_hyetograph\n            # Convolve inflow with the IUH kernel to get discharge Q(t) in m^3/s\n            Q = np.convolve(u, H, mode='full')\n            # Trim to a reasonable length\n            return Q[:len(p_hyetograph) + kernel_len]\n\n        Q_hourly = compute_discharge(p_hourly)\n        Q_daily = compute_discharge(p_daily_agg)\n\n        # --- 3. Calculate Metrics ---\n        # Peak discharge (m^3/s)\n        Q_peak_hourly = np.max(Q_hourly)\n        Q_peak_daily = np.max(Q_daily)\n\n        # Time to peak (hours)\n        t_peak_hourly = float(np.argmax(Q_hourly))\n        t_peak_daily = float(np.argmax(Q_daily))\n        \n        # Avoid division by zero if hourly peak is zero (e.g., no rainfall)\n        if Q_peak_hourly > 1e-9:\n            r = Q_peak_daily / Q_peak_hourly\n        else:\n            r = 1.0 if Q_peak_daily  1e-9 else np.inf\n\n        dt_peak = t_peak_daily - t_peak_hourly\n\n        results.append([r, dt_peak])\n\n    # Format the final output as a list of lists.\n    # This involves converting each inner list to its string representation.\n    # Ex: [[r1, dt1], [r2, dt2]] -> \"[[r1,dt1],[r2,dt2]]\"\n    output_str = \"[\" + \",\".join([f\"[{res[0]},{res[1]}]\" for res in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "最后，我们将展示先前所学的概念如何作为更广泛环境分析的输入。本练习将地形参数（坡度和流量累积）与遥感数据（NDVI）整合到广泛应用的修正通用土壤流失方程（RUSLE）中，用以估算土壤侵蚀。这个练习展示了将水文分析与其他数据源相结合，以解决土地退化等紧迫环境挑战的强大能力。",
            "id": "3866237",
            "problem": "你的任务是开发一个完整且可运行的程序，使用遥感和地形衍生输入数据，计算划定流域内指定位置的年均土壤流失量。计算必须基于修正通用土壤流失方程 (RUSLE)，同时根据基本定义明确推导地形因子和植被覆盖管理因子。程序必须产生具有物理意义的结果，并遵守指定的输出格式。\n\n从以下基本依据开始：\n\n- 修正通用土壤流失方程 (RUSLE) 将单位面积的年均土壤流失量估算为侵蚀力、可蚀性、地形、植被覆盖管理和水土保持措施等因子的乘积，所有这些因子均为无量纲或具有一致的单位，最终得出单位时间单位面积的质量。\n- 地形对侵蚀的影响由一个上坡长度项和一个源于坡角正弦值的局部坡度项控制。该公式必须基于单位水流功率理论，通过将单位等高线宽度的上坡汇水面积和坡角的正弦值用与标准小区相关的参考值进行归一化。具有物理代表性的参考值是：长度归一化值为 $22.13$，坡度归一化值为 $0.0896$。\n- 归一化植被指数 (NDVI) 定义为 $NDVI = \\dfrac{(NIR - RED)}{(NIR + RED)}$，其中 $NIR$ 是近红外反射率，$RED$ 是红波段反射率。植被覆盖度的增加会减少土壤流失，一个从 $NDVI$ 到植被覆盖管理因子的数学上一致的映射必须是一个单调递减函数，该函数在裸露地表时趋近于 $1$，并随着 $NDVI$ 的增加而减小。\n- 汇流累积量是在指定的水流路径方案下，汇入给定栅格单元的栅格单元数量。对于边长为 $L$ 米的方形栅格，单位等高线宽度的上坡汇水面积与汇流累积量计数和栅格大小的乘积成正比。\n\n基于这些依据，推导出一个计算流程，该流程需要：\n1. 将地形因子计算为一个长度项和一个坡度项的乘积组合。长度项基于单位等高线宽度的上坡汇水面积，坡度项基于坡角（以弧度为单位）的正弦值，两者分别通过标准参考值 $22.13$ 和 $0.0896$ 进行归一化。使用指数 $m = 0.4$ 和 $n = 1.3$ 作为物理上合理的参数，分别表示长度和坡度的相对影响。\n2. 使用一个在 $NDVI$ 上严格递减的平滑指数衰减函数，从 $NDVI$ 估算植被覆盖管理因子，参数为 $\\alpha = 2.0$ 和 $\\beta = 1.0$。通过将任何负的 $NDVI$ 值截断为 $0$，并将大于或等于 $\\beta$ 的值截断为略小于 $\\beta$ 的值，来强制 $NDVI \\in [0, \\beta)$，以避免除法奇点。\n3. 使用降雨侵蚀力因子 $R$、土壤可蚀性因子 $K$、推导出的地形因子、植被覆盖管理因子和水土保持措施因子 $P$ 的乘积来计算年均土壤流失量。\n\n角度单位要求：\n- 输入的坡度以度为单位。在计算中使用三角函数时，需将坡角转换为弧度。\n\n物理单位要求：\n- 将每个测试用例的最终土壤流失量以兆克/公顷/年为单位表示，并四舍五入到 $3$ 位小数。每个输出值必须是代表兆克/公顷/年的浮点数。\n\n请为以下参数值的测试套件实现上述过程。对于每个案例，参数为：坡角（度）、汇流累积量（无量纲计数）、$NDVI$（无量纲）、栅格大小（米）、降雨侵蚀力因子 $R$（与其他因子结合后单位与兆克/公顷/年一致）、土壤可蚀性因子 $K$（RUSLE 框架内一致的无量纲比例因子）以及水土保持措施因子 $P$（无量纲）：\n\n- 案例 $1$：坡度 $12$，汇流累积量 $150$，$NDVI$ $0.6$，栅格大小 $30$，$R$ $350$，$K$ $0.032$，$P$ $1.0$。\n- 案例 $2$（近乎平坦的边界）：坡度 $0.1$，汇流累积量 $1$，$NDVI$ $0.8$，栅格大小 $30$，$R$ $350$，$K$ $0.032$，$P$ $1.0$。\n- 案例 $3$（稀疏植被）：坡度 $8$，汇流累积量 $50$，$NDVI$ $0.05$，栅格大小 $30$，$R$ $250$，$K$ $0.04$，$P$ $1.0$。\n- 案例 $4$（陡峭且汇流，有保护措施）：坡度 $30$，汇流累积量 $2000$，$NDVI$ $0.7$，栅格大小 $30$，$R$ $500$，$K$ $0.02$，$P$ $0.8$。\n- 案例 $5$（负 $NDVI$ 被截断为裸地）：坡度 $5$，汇流累积量 $20$，$NDVI$ $-0.2$，栅格大小 $10$，$R$ $100$，$K$ $0.05$，$P$ $1.0$。\n\n你的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表（例如，$[result1,result2,result3]$），每个浮点数四舍五入到 $3$ 位小数，并以兆克/公顷/年为单位表示。",
            "solution": "修正通用土壤流失方程 (RUSLE) 将单位面积的年均土壤流失量建模为捕获气候、土壤、地形、植被和耕作措施等因素的乘积组合。这种基本关系是概念性的，而非单一的快捷公式，每个因子都必须基于具有物理意义的定义。\n\n设单位面积的年均土壤流失量用 $A$ 表示，单位为兆克/公顷/年。概念上的关系是，$A$ 与降雨侵蚀力、土壤可蚀性、坡长和坡度（地形）、植被覆盖管理以及水土保持措施成正比。因此，公式为\n$$\nA \\propto R \\cdot K \\cdot \\text{(地形)} \\cdot \\text{(植被覆盖)} \\cdot P,\n$$\n其中 $R$ 是降雨侵蚀力因子，$K$ 是土壤可蚀性因子，地形因子是坡长和坡度的综合影响，植被覆盖管理因子量化了植被或残留物的保护作用，而 $P$ 则体现了等高耕作或梯田等水土保持措施。\n\n地形因子推导。在基于物理的坡面水力学中，单位水流功率理论推导出一个地形因子，该因子随单位等高线宽度的上坡汇水面积（潜在水流集中的替代指标）和坡角正弦值表示的坡度陡峭程度而增加。RUSLE 标准小区的坡长为 $22.13$ 米，坡度约为 $9\\%$，对应的正弦值约为 $0.0896$。为了生成与标准一致的无量纲地形因子，长度项和坡度项都必须用这些参考值进行归一化。设局部坡角（以度为单位）为 $\\theta_{deg}$，并转换为弧度 $\\theta = \\theta_{deg}\\cdot \\pi/180$。设汇流累积量为 $FA$（无量纲，表示汇入目标栅格的栅格数量，在标准实现中包括该栅格自身），方形栅格大小为 $L$ 米。单位等高线宽度的上坡汇水面积 $a$ 计算如下\n$$\na = FA \\cdot L.\n$$\n地形因子随后成为两个无量纲项的乘积，这两个项分别被提升到指数 $m$ 和 $n$，以反映对长度和坡度的敏感性：\n$$\nLS = \\left(\\frac{a}{22.13}\\right)^m \\cdot \\left(\\frac{\\sin(\\theta)}{0.0896}\\right)^n,\n$$\n指数选择为 $m = 0.4$ 和 $n = 1.3$，这些是广泛使用的值，与单位水流功率公式一致，确保了侵蚀随汇水面积和坡度的实际比例关系。当 $\\theta = 0$ 时，此 $LS$ 公式返回 $LS = 0$，因为 $\\sin(0) = 0$，这与物理预期相符，即无坡度意味着用于剥离和输移的重力驱动分量可忽略不计。\n\n从遥感数据推导植被覆盖管理因子。归一化植被指数 (NDVI) 定义为\n$$\nNDVI = \\frac{NIR - RED}{NIR + RED},\n$$\n其中 $NIR$ 是近红外反射率，$RED$ 是红波段反射率。增加的 $NDVI$ 表示更高的植被覆盖，通常通过截留、根系加固和地表保护来减少土壤侵蚀。一个符合这些约束的平滑指数衰减函数是\n$$\nC = \\exp\\left(-\\alpha \\cdot \\frac{\\tilde{NDVI}}{\\beta - \\tilde{NDVI}}\\right),\n$$\n其中 $\\alpha = 2.0$ 和 $\\beta = 1.0$，而 $\\tilde{NDVI}$ 是 $NDVI$ 的截断版本，用于强制其处于有效区间内。具体来说，强制执行\n$$\n\\tilde{NDVI} = \\min\\left(\\max(NDVI, 0), \\beta - \\epsilon\\right),\n$$\n其中 $\\epsilon$ 是一个很小的数（如 $10^{-6}$），以避免当 $NDVI$ 接近 $\\beta$ 时出现除以零的情况。这种映射确保了当 $NDVI \\rightarrow 0$ 时（裸地条件），$C \\rightarrow 1$，而对于高 $NDVI$ 值（茂密植被），$C$ 向 $0$ 减小，这与实地观测结果一致。\n\n年均土壤流失量计算。结合这些因子可得\n$$\nA = R \\cdot K \\cdot LS \\cdot C \\cdot P,\n$$\n在 RUSLE 框架内，当 $R$ 和 $K$ 以常规单位提供，且 $LS$、$C$ 和 $P$ 为无量纲时，该公式在量纲上是一致的。最终的 $A$ 以兆克/公顷/年为单位报告。\n\n算法步骤：\n1. 对每个测试用例，读取 $\\theta_{deg}$、$FA$、$NDVI$、$L$、$R$、$K$ 和 $P$。\n2. 将坡度转换为弧度：$\\theta = \\theta_{deg}\\cdot \\pi/180$。\n3. 计算单位等高线宽度的上坡汇水面积：$a = FA \\cdot L$。\n4. 使用归一化和指数化的项计算 $LS$：$LS = \\left(\\frac{a}{22.13}\\right)^{0.4}\\cdot \\left(\\frac{\\sin(\\theta)}{0.0896}\\right)^{1.3}$。如果 $\\sin(\\theta) = 0$，则 $LS = 0$。\n5. 将 $NDVI$ 截断到 $[0, \\beta)$ 区间：$\\tilde{NDVI} = \\min(\\max(NDVI, 0), 1 - 10^{-6})$。\n6. 计算 $C = \\exp\\left(-2.0 \\cdot \\frac{\\tilde{NDVI}}{1.0 - \\tilde{NDVI}}\\right)$。\n7. 计算 $A = R \\cdot K \\cdot LS \\cdot C \\cdot P$。\n8. 将 $A$ 四舍五入到 $3$ 位小数，并收集到列表中。\n9. 以确切的格式打印列表：单行输出，用方括号括起来的、以逗号分隔的浮点数。\n\n测试套件涵盖的边界情况：\n- 近乎平坦的坡度及最小的汇水面积（案例 2）使得 $\\sin(\\theta)$ 趋近于 $0$，并产生一个非常小的 $LS$ 值，从而确保了数值稳定性和物理上可忽略的侵蚀。\n- 负 $NDVI$（案例 5）被截断为 $0$，得出 $C \\approx 1$，代表裸地或无植被表面。\n- 具有大汇流量的陡坡（案例 4）会产生一个大的 $LS$ 值，而 $P  1$ 则会减少计算出的土壤流失量，反映了水土保持措施的影响。\n\n程序实现了这些计算，并输出一行，其中包含与所提供测试用例相对应的五个结果，每个结果都四舍五入到 $3$ 位小数，并以兆克/公顷/年为单位表示。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_ls(slope_deg: float, flow_accum: float, cell_size_m: float,\n               m: float = 0.4, n: float = 1.3) -> float:\n    \"\"\"\n    Compute the RUSLE LS factor using unit stream power-based formulation:\n    LS = (a / 22.13)^m * (sin(theta) / 0.0896)^n\n    where a = flow_accum * cell_size_m (upslope contributing area per unit width),\n    theta is slope angle in radians.\n    \"\"\"\n    # Convert slope to radians\n    theta = np.deg2rad(slope_deg)\n    # Upslope contributing area per unit contour width (meters)\n    a = flow_accum * cell_size_m\n    # Handle possible zero slope; sin(0) == 0 => LS == 0\n    sin_theta = np.sin(theta)\n    if sin_theta == 0.0 or a == 0.0:\n        return 0.0\n    # Compute LS factor\n    ls = (a / 22.13) ** m * (sin_theta / 0.0896) ** n\n    # Ensure non-negative and finite\n    if not np.isfinite(ls) or ls  0.0:\n        ls = 0.0\n    return float(ls)\n\ndef compute_c_from_ndvi(ndvi: float, alpha: float = 2.0, beta: float = 1.0) -> float:\n    \"\"\"\n    Compute the cover-management factor C from NDVI using:\n    C = exp(-alpha * ndvi / (beta - ndvi)), with NDVI clamped to [0, beta - eps].\n    \"\"\"\n    eps = 1e-6\n    ndvi_clamped = min(max(ndvi, 0.0), beta - eps)\n    denom = beta - ndvi_clamped\n    # Avoid division by zero (shouldn't happen due to clamp)\n    if denom == 0.0:\n        return 0.0\n    c = np.exp(-alpha * ndvi_clamped / denom)\n    # Bound C to [0,1]\n    c = float(np.clip(c, 0.0, 1.0))\n    return c\n\ndef compute_annual_soil_loss(R: float, K: float, LS: float, C: float, P: float) -> float:\n    \"\"\"\n    Compute annual soil loss A (Mg/ha/year) as A = R * K * LS * C * P.\n    \"\"\"\n    A = R * K * LS * C * P\n    return float(A)\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (slope_deg, flow_accum, ndvi, cell_size_m, R, K, P)\n    test_cases = [\n        (12.0, 150.0, 0.6, 30.0, 350.0, 0.032, 1.0),   # Case 1\n        (0.1, 1.0, 0.8, 30.0, 350.0, 0.032, 1.0),     # Case 2 (near-flat)\n        (8.0, 50.0, 0.05, 30.0, 250.0, 0.04, 1.0),    # Case 3 (sparse vegetation)\n        (30.0, 2000.0, 0.7, 30.0, 500.0, 0.02, 0.8),  # Case 4 (steep, convergent, conservation)\n        (5.0, 20.0, -0.2, 10.0, 100.0, 0.05, 1.0),    # Case 5 (negative NDVI clamped to bare)\n    ]\n\n    results = []\n    for slope_deg, fa, ndvi, cell_size, R, K, P in test_cases:\n        ls = compute_ls(slope_deg, fa, cell_size, m=0.4, n=1.3)\n        c = compute_c_from_ndvi(ndvi, alpha=2.0, beta=1.0)\n        A = compute_annual_soil_loss(R, K, ls, c, P)\n        # Round to 3 decimal places as required\n        results.append(round(A, 3))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.3f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}