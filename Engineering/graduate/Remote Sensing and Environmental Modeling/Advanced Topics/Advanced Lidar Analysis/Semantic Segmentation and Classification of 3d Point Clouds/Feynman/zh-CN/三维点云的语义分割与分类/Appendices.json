{
    "hands_on_practices": [
        {
            "introduction": "在许多环境建模任务（如变化检测）中，一个关键的初始步骤是将来自不同时间或传感器的点云对齐到一个公共坐标系中。本练习将引导您学习刚体变换的基本数学原理，即所谓的“配准”过程。通过一个包含对应关键点的具体示例 ，您将学会如何使用奇异值分解（SVD）来稳健地估计对齐两个数据集的最佳旋转和平移。",
            "id": "3844964",
            "problem": "在一次针对城乡-森林混合环境的多时相航空激光雷达（LiDAR）遥感勘测中，获取了两个三维点云，它们分别位于不同的坐标系中：一个是传感器本地坐标系，另一个是地理配准的地图坐标系。为了将语义分割标签从一次采集传播到另一次采集，并在不同时期进行一致的环境建模，需要估计两个坐标系之间的刚性变换，该变换能保持欧几里得距离和朝向。设刚性变换由映射 $p \\mapsto p'$ 定义，其中 $p, p' \\in \\mathbb{R}^{3}$ 满足 $p' = R p + t$，此处 $R \\in \\mathbb{R}^{3 \\times 3}$ 是一个旋转矩阵，$t \\in \\mathbb{R}^{3}$ 是一个平移向量。\n\n仅从欧几里得几何和最小二乘估计的基本原理出发，完成以下任务：\n1. 在保持距离和正确朝向的约束下，推导出 $p' = R p + t$ 的形式，证明 $R$ 必须满足 $R^{\\top} R = I$ 和 $\\det(R) = 1$。\n2. 将从 $N$ 个对应点 $\\{(p_i, q_i)\\}_{i=1}^{N}$ 估计 $(R, t)$ 的问题，表述为最小化残差平方和 $J(R, t) = \\sum_{i=1}^{N} \\| q_i - (R p_i + t) \\|^{2}$。通过使用样本均值进行中心化，推导出只含旋转的简化目标函数。证明这个只含旋转的问题是正交普罗克汝斯忒斯问题，并且其解可以通过奇异值分解（SVD）获得，同时确保 $\\det(R) = 1$。\n3. 考虑以下六个从平面屋顶和垂直外墙上提取的、经手动验证的稳定关键点对应关系（为改善数值条件，选择的点相对于传感器本地原点对称）：\n   - 传感器本地坐标（源点）：$p_1 = (1, 0, 0)$，$p_2 = (-1, 0, 0)$，$p_3 = (0, 1, 0)$，$p_4 = (0, -1, 0)$，$p_5 = (0, 0, 1)$，$p_6 = (0, 0, -1)$。\n   - 地理配准的地图坐标系（目标点）：$q_i = R p_i + t$，其中未知的 $(R, t)$ 有待估计。\n   假设真实的变换包含一个绕 $z$ 轴旋转 $\\pi/2$ 弧度的旋转和一个平移 $t = (2, -1, 3)$，但在推导中不要直接使用这些值；而是将基于SVD的正交普罗克汝斯忒斯解法应用于给定的对应点。明确计算样本均值、互协方差矩阵和SVD，以恢复 $R$ 和 $t$。\n4. 使用LaTeX的 `pmatrix` 环境，将最终答案表示为一个单行矩阵，该矩阵按行主序依次列出 $R$ 的元素，然后是 $t$ 的三个元素。无需四舍五入。无需单位。\n\n你的最终答案必须是指定行矩阵形式的计算结果。",
            "solution": "该问题是有效的，因为它在科学上基于欧几里得几何和估计理论，具有充分的数据以获得唯一解，问题陈述客观，属于良态问题。它代表了三维数据处理中的一个标准问题，特别是点云配准。我们将进行完整的推导和求解。\n\n根据问题陈述的要求，解法分为三个部分，最后是格式化的答案。\n\n1. 刚性变换性质的推导\n\n刚性变换是一个映射 $T: \\mathbb{R}^{3} \\rightarrow \\mathbb{R}^{3}$，它保持任意两点之间的欧几里得距离。设该变换为一个仿射映射，形式为 $p' = T(p) = R p + t$，其中 $p, p' \\in \\mathbb{R}^{3}$，$R$ 是一个 $3 \\times 3$ 矩阵，$t$ 是一个 $3 \\times 1$ 的平移向量。\n\n设 $p_1$ 和 $p_2$ 是 $\\mathbb{R}^{3}$ 中的两个点。它们变换后的对应点是 $p'_1 = R p_1 + t$ 和 $p'_2 = R p_2 + t$。连接变换后两点的向量是 $p'_1 - p'_2 = (R p_1 + t) - (R p_2 + t) = R(p_1 - p_2)$。\n\n距离保持条件规定，欧几里得距离的平方在变换下是不变的：\n$$ \\| p'_1 - p'_2 \\|^{2} = \\| p_1 - p_2 \\|^{2} $$\n代入变换后向量的表达式：\n$$ \\| R(p_1 - p_2) \\|^{2} = \\| p_1 - p_2 \\|^{2} $$\n令 $v = p_1 - p_2$。这个关系必须对任意向量 $v \\in \\mathbb{R}^{3}$ 都成立。根据欧几里得范数平方的定义 $\\|x\\|^2 = x^{\\top}x$：\n$$ (Rv)^{\\top}(Rv) = v^{\\top}v $$\n$$ v^{\\top}R^{\\top}Rv = v^{\\top}Iv $$\n其中 $I$ 是 $3 \\times 3$ 的单位矩阵。由于这个等式必须对所有 $v \\in \\mathbb{R}^{3}$ 成立，因此其二次型必须相同，这意味着它们的定义矩阵相等：\n$$ R^{\\top}R = I $$\n满足此条件的矩阵 $R$ 称为正交矩阵。这表明刚性变换的线性部分必须是正交的。\n\n该问题还要求变换保持朝向。坐标系的朝向由其基向量矩阵的行列式符号决定。如果一个变换矩阵 $R$ 的行列式为正，则它保持朝向。从正交条件 $R^{\\top}R = I$，我们可以对两边取行列式：\n$$ \\det(R^{\\top}R) = \\det(I) $$\n$$ \\det(R^{\\top})\\det(R) = 1 $$\n因为 $\\det(R^{\\top}) = \\det(R)$，这导致：\n$$ (\\det(R))^{2} = 1 $$\n这意味着 $\\det(R)$ 可以是 $1$ 或 $-1$。\n- 如果 $\\det(R) = 1$，该变换是正常旋转。它保持坐标系的“手性”。\n- 如果 $\\det(R) = -1$，该变换是非正常旋转（旋转反射），它包含一次反射并反转坐标系的手性。\n\n为保持朝向，我们必须选择 $\\det(R) = 1$ 的情况。这样的矩阵是特殊正交群 $SO(3)$ 的一个成员。因此，一个保持距离和朝向的刚性变换具有 $p' = Rp + t$ 的形式，其中 $R$ 是一个特殊正交矩阵（$R^{\\top}R = I$ 且 $\\det(R)=1$）。\n\n2. 最小二乘法公式和正交普罗克汝斯忒斯解的推导\n\n给定 $N$ 对对应点 $\\{(p_i, q_i)\\}_{i=1}^{N}$，我们寻求找到旋转矩阵 $R \\in SO(3)$ 和平移向量 $t \\in \\mathbb{R}^{3}$，以最小化残差（或误差）的平方和：\n$$ J(R, t) = \\sum_{i=1}^{N} \\| q_i - (R p_i + t) \\|^{2} $$\n为了找到最优平移 $t$，我们可以通过将其梯度设为零来最小化 $J$ 对 $t$ 的偏导。\n$$ \\frac{\\partial J}{\\partial t} = \\sum_{i=1}^{N} \\frac{\\partial}{\\partial t} \\| q_i - R p_i - t \\|^{2} = \\sum_{i=1}^{N} 2(q_i - R p_i - t)(-1) = 0 $$\n$$ \\sum_{i=1}^{N} (q_i - R p_i - t) = 0 $$\n$$ \\sum_{i=1}^{N} q_i - R \\sum_{i=1}^{N} p_i - \\sum_{i=1}^{N} t = 0 $$\n设 $\\bar{p} = \\frac{1}{N}\\sum_{i=1}^{N} p_i$ 和 $\\bar{q} = \\frac{1}{N}\\sum_{i=1}^{N} q_i$ 为两个点集的质心（样本均值）。\n$$ N\\bar{q} - R(N\\bar{p}) - Nt = 0 $$\n$$ t = \\bar{q} - R\\bar{p} $$\n这表明最优平移 $t$ 取决于最优旋转 $R$ 和点集的质心。\n\n我们可以将这个 $t$ 的表达式代回目标函数，以获得一个仅依赖于 $R$ 的简化目标：\n$$ q_i - R p_i - t = q_i - R p_i - (\\bar{q} - R\\bar{p}) = (q_i - \\bar{q}) - R(p_i - \\bar{p}) $$\n设中心化后的点坐标为 $p'_i = p_i - \\bar{p}$ 和 $q'_i = q_i - \\bar{q}$。目标函数变为：\n$$ J(R) = \\sum_{i=1}^{N} \\| q'_i - R p'_i \\|^{2} $$\n展开平方范数：\n$$ J(R) = \\sum_{i=1}^{N} (q'_i - R p'_i)^{\\top}(q'_i - R p'_i) = \\sum_{i=1}^{N} ( (q'_i)^{\\top}q'_i - (q'_i)^{\\top}R p'_i - (p'_i)^{\\top}R^{\\top}q'_i + (p'_i)^{\\top}R^{\\top}R p'_i ) $$\n因为 $R$ 是正交的，所以 $R^{\\top}R = I$。另外，$(p'_i)^{\\top}R^{\\top}q'_i$ 是一个标量，因此它等于其转置，即 $((p'_i)^{\\top}R^{\\top}q'_i)^{\\top} = (q'_i)^{\\top}R p'_i$。\n$$ J(R) = \\sum_{i=1}^{N} (\\|q'_i\\|^{2} + \\|p'_i\\|^{2}) - 2 \\sum_{i=1}^{N} (q'_i)^{\\top}R p'_i $$\n项 $\\sum \\|q'_i\\|^{2}$ 和 $\\sum \\|p'_i\\|^{2}$ 相对于 $R$ 是常数。因此，最小化 $J(R)$ 等价于最大化项 $\\sum_{i=1}^{N} (q'_i)^{\\top}R p'_i$。\n\n我们使用迹算子将这个和式转换为矩阵表达式。对于任意标量 $s$, $s = \\text{tr}(s)$。\n$$ \\sum_{i=1}^{N} (q'_i)^{\\top}R p'_i = \\sum_{i=1}^{N} \\text{tr}((q'_i)^{\\top}R p'_i) = \\sum_{i=1}^{N} \\text{tr}(p'_i (q'_i)^{\\top}R) $$\n利用迹的线性性质，这等价于最大化：\n$$ \\text{tr}\\left(\\left(\\sum_{i=1}^{N} p'_i (q'_i)^{\\top}\\right)R\\right) = \\text{tr}(HR) $$\n其中 $H = \\sum_{i=1}^{N} p'_i (q'_i)^{\\top}$ 是中心化点集的 $3 \\times 3$ 互协方差矩阵。利用迹的循环性质，$\\text{tr}(HR) = \\text{tr}(RH)$。我们希望最大化 $\\text{tr}(RH)$。这就是正交普罗克汝斯忒斯问题。\n\n设 $H$ 的奇异值分解（SVD）为 $H = U S V^{\\top}$，其中 $U, V \\in O(3)$ 是正交矩阵，$S$ 是一个非负奇异值的对角矩阵，$\\sigma_1 \\ge \\sigma_2 \\ge \\sigma_3 \\ge 0$。\n$$ \\text{tr}(RH) = \\text{tr}(R U S V^{\\top}) $$\n利用循环性质 $\\text{tr}(ABCD) = \\text{tr}(DABC)$：\n$$ \\text{tr}(R U S V^{\\top}) = \\text{tr}(V^{\\top} R U S) $$\n令 $M = V^{\\top} R U$。由于 $V$、$R$ 和 $U$ 都是正交的，所以 $M$ 也是一个正交矩阵。目标变为最大化 $\\text{tr}(MS)$。\n$$ \\text{tr}(MS) = \\sum_{j=1}^{3} (MS)_{jj} = \\sum_{j=1}^{3} M_{jj} \\sigma_j $$\n由于 $M$ 是正交的，其列向量是单位向量，这意味着 $|M_{jj}| \\le 1$。为了最大化这个和，我们应选择 $M_{jj}$ 尽可能大。最优选择是 $M=I$，这给出了最大值 $\\sum \\sigma_j$。\n因此，$V^{\\top} R U = I \\implies R = V I U^{\\top} = V U^{\\top}$。\n\n我们必须确保 $\\det(R)=1$。我们有 $\\det(R) = \\det(V U^{\\top}) = \\det(V)\\det(U^{\\top}) = \\det(V)\\det(U)$。如果 $\\det(U)$ 或 $\\det(V)$ 中一个是 $-1$ 而另一个是 $1$，这个乘积可能为 $-1$。这对应于一次反射，它是数学上最接近的正交矩阵，但不是一个正常旋转。如果 $\\det(VU^\\top) = -1$，最优旋转是通过强制行列式为 $1$ 来找到的。这可以通过设置 $M=\\text{diag}(1, 1, -1)$ 而不是 $I$ 来实现，这将翻转最小奇异值项的符号，得到的迹为 $\\sigma_1 + \\sigma_2 - \\sigma_3$。这是在 $\\det(M) = -1$ 约束下的最佳可能结果（假设 $\\det(U)\\det(V)=1$；如果 $\\det(U)\\det(V)=-1$，我们需要 $\\det(M)=-1$ 才能得到 $\\det(R)=1$）。\n\n一个稳健的写法来表示 $R \\in SO(3)$ 的解是：\n$$ R = V \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & \\det(VU^{\\top}) \\end{pmatrix} U^{\\top} $$\n这确保了 $\\det(R) = \\det(V)\\det(U^{\\top})\\det(\\text{diag}(...)) = \\det(VU^{\\top})^2 = 1$。\n\n3. 应用于给定的关键点\n\n源点为：\n$p_1 = (1, 0, 0)^{\\top}$，$p_2 = (-1, 0, 0)^{\\top}$，$p_3 = (0, 1, 0)^{\\top}$，$p_4 = (0, -1, 0)^{\\top}$，$p_5 = (0, 0, 1)^{\\top}$，$p_6 = (0, 0, -1)^{\\top}$。\n点的数量为 $N=6$。\n\n首先，计算源点的质心：\n$$ \\bar{p} = \\frac{1}{6}\\sum_{i=1}^{6} p_i = \\frac{1}{6} \\begin{pmatrix} 1-1+0+0+0+0 \\\\ 0+0+1-1+0+0 \\\\ 0+0+0+0+1-1 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\end{pmatrix} $$\n目标点 $q_i$ 由 $q_i = R_{true} p_i + t_{true}$ 生成，其中 $R_{true}$ 是绕 $z$ 轴旋转 $\\pi/2$ 弧度的旋转矩阵，$t_{true}=(2, -1, 3)^{\\top}$。\n$$ R_{true} = \\begin{pmatrix} \\cos(\\pi/2) & -\\sin(\\pi/2) & 0 \\\\ \\sin(\\pi/2) & \\cos(\\pi/2) & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = \\begin{pmatrix} 0 & -1 & 0 \\\\ 1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n目标点为：\n$q_1 = (0, 1, 0)^{\\top} + (2, -1, 3)^{\\top} = (2, 0, 3)^{\\top}$\n$q_2 = (0, -1, 0)^{\\top} + (2, -1, 3)^{\\top} = (2, -2, 3)^{\\top}$\n$q_3 = (-1, 0, 0)^{\\top} + (2, -1, 3)^{\\top} = (1, -1, 3)^{\\top}$\n$q_4 = (1, 0, 0)^{\\top} + (2, -1, 3)^{\\top} = (3, -1, 3)^{\\top}$\n$q_5 = (0, 0, 1)^{\\top} + (2, -1, 3)^{\\top} = (2, -1, 4)^{\\top}$\n$q_6 = (0, 0, -1)^{\\top} + (2, -1, 3)^{\\top} = (2, -1, 2)^{\\top}$\n\n接下来，计算目标点的质心：\n$$ \\bar{q} = \\frac{1}{6}\\left( \\begin{pmatrix} 2 \\\\ 0 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} 2 \\\\ -2 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ -1 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} 3 \\\\ -1 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} 2 \\\\ -1 \\\\ 4 \\end{pmatrix} + \\begin{pmatrix} 2 \\\\ -1 \\\\ 2 \\end{pmatrix} \\right) = \\frac{1}{6}\\begin{pmatrix} 12 \\\\ -6 \\\\ 18 \\end{pmatrix} = \\begin{pmatrix} 2 \\\\ -1 \\\\ 3 \\end{pmatrix} $$\n中心化点为 $p'_i = p_i - \\bar{p} = p_i$ 和 $q'_i = q_i - \\bar{q}$。\n$q'_1 = (0, 1, 0)^{\\top}$，$q'_2= (0, -1, 0)^{\\top}$，$q'_3 = (-1, 0, 0)^{\\top}$，$q'_4 = (1, 0, 0)^{\\top}$，$q'_5 = (0, 0, 1)^{\\top}$，$q'_6 = (0, 0, -1)^{\\top}$。\n\n现在，计算互协方差矩阵 $H = \\sum_{i=1}^{6} p'_i (q'_i)^{\\top}$：\n$H = p_1 (q'_1)^{\\top} + p_2 (q'_2)^{\\top} + p_3 (q'_3)^{\\top} + p_4 (q'_4)^{\\top} + p_5 (q'_5)^{\\top} + p_6 (q'_6)^{\\top}$\n$H = \\begin{pmatrix}1\\\\0\\\\0\\end{pmatrix}(0,1,0) + \\begin{pmatrix}-1\\\\0\\\\0\\end{pmatrix}(0,-1,0) + \\begin{pmatrix}0\\\\1\\\\0\\end{pmatrix}(-1,0,0) + \\begin{pmatrix}0\\\\-1\\\\0\\end{pmatrix}(1,0,0) + \\begin{pmatrix}0\\\\0\\\\1\\end{pmatrix}(0,0,1) + \\begin{pmatrix}0\\\\0\\\\-1\\end{pmatrix}(0,0,-1)$\n$H = \\begin{pmatrix}0 & 1 & 0 \\\\ 0 & 0 & 0 \\\\ 0 & 0 & 0\\end{pmatrix} + \\begin{pmatrix}0 & 1 & 0 \\\\ 0 & 0 & 0 \\\\ 0 & 0 & 0\\end{pmatrix} + \\begin{pmatrix}0 & 0 & 0 \\\\ -1 & 0 & 0 \\\\ 0 & 0 & 0\\end{pmatrix} + \\begin{pmatrix}0 & 0 & 0 \\\\ -1 & 0 & 0 \\\\ 0 & 0 & 0\\end{pmatrix} + \\begin{pmatrix}0 & 0 & 0 \\\\ 0 & 0 & 0 \\\\ 0 & 0 & 1\\end{pmatrix} + \\begin{pmatrix}0 & 0 & 0 \\\\ 0 & 0 & 0 \\\\ 0 & 0 & 1\\end{pmatrix}$\n$$ H = \\begin{pmatrix} 0 & 2 & 0 \\\\ -2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} $$\n接下来，求 $H = U S V^{\\top}$ 的SVD。\n我们计算 $HH^{\\top}$ 和 $H^{\\top}H$：\n$$ HH^{\\top} = \\begin{pmatrix} 0 & 2 & 0 \\\\ -2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} \\begin{pmatrix} 0 & -2 & 0 \\\\ 2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} = \\begin{pmatrix} 4 & 0 & 0 \\\\ 0 & 4 & 0 \\\\ 0 & 0 & 4 \\end{pmatrix} = 4I $$\n$$ H^{\\top}H = \\begin{pmatrix} 0 & -2 & 0 \\\\ 2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} \\begin{pmatrix} 0 & 2 & 0 \\\\ -2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} = \\begin{pmatrix} 4 & 0 & 0 \\\\ 0 & 4 & 0 \\\\ 0 & 0 & 4 \\end{pmatrix} = 4I $$\n$HH^{\\top}$ 的特征值为 $\\lambda_1=\\lambda_2=\\lambda_3=4$。奇异值为 $\\sigma_i=\\sqrt{\\lambda_i}$，所以 $\\sigma_1=\\sigma_2=\\sigma_3=2$。奇异值矩阵是 $S=2I$。\n$V$ 的列是 $H^{\\top}H$ 的特征向量，$U$ 的列是 $HH^{\\top}$ 的特征向量。由于这些矩阵都是 $4I$，任何标准正交基都是有效的特征向量选择。我们必须通过关系 $U S = H V$ 来一致地选择它们。\n让我们为 $V$ 选择最简单的基，即单位矩阵：$V = I = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & 1 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix}$。\n现在我们从 $U = HVS^{-1} = H(I)(2I)^{-1} = \\frac{1}{2}H$ 求出 $U$。\n$$ U = \\frac{1}{2}\\begin{pmatrix} 0 & 2 & 0 \\\\ -2 & 0 & 0 \\\\ 0 & 0 & 2 \\end{pmatrix} = \\begin{pmatrix} 0 & 1 & 0 \\\\ -1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n我们检查 $U$ 是否正交：$U^{\\top}U = \\begin{pmatrix} 0 & -1 & 0 \\\\ 1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\begin{pmatrix} 0 & 1 & 0 \\\\ -1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = I$。是的。\n现在我们计算旋转矩阵 $R$。首先，检查行列式条件：\n$\\det(VU^{\\top}) = \\det(IU^{\\top}) = \\det(U^{\\top}) = \\det(U) = -1(-1) = 1$。\n由于行列式为 $1$，不需要修正。\n$$ R = V U^{\\top} = I U^{\\top} = U^{\\top} = \\begin{pmatrix} 0 & -1 & 0 \\\\ 1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n这是估计出的旋转矩阵，与 $R_{true}$ 完全匹配。\n\n最后，我们计算平移向量 $t$：\n$$ t = \\bar{q} - R\\bar{p} = \\begin{pmatrix} 2 \\\\ -1 \\\\ 3 \\end{pmatrix} - \\begin{pmatrix} 0 & -1 & 0 \\\\ 1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 2 \\\\ -1 \\\\ 3 \\end{pmatrix} $$\n这是估计出的平移向量，与 $t_{true}$ 完全匹配。\n\n4. 最终答案的格式\n最终答案由旋转矩阵 $R$ 的元素（按行主序）和其后跟随的平移向量 $t$ 的元素组成。\n$R = \\begin{pmatrix} 0 & -1 & 0 \\\\ 1 & 0 & 0 \\\\ 0 & 0 & 1 \\end{pmatrix}$\n$t = \\begin{pmatrix} 2 \\\\ -1 \\\\ 3 \\end{pmatrix}$\n这些元素是 $(R_{11}, R_{12}, R_{13}, R_{21}, R_{22}, R_{23}, R_{31}, R_{32}, R_{33}, t_1, t_2, t_3)$。\n对应于 $(0, -1, 0, 1, 0, 0, 0, 0, 1, 2, -1, 3)$。",
            "answer": "$$ \\boxed{ \\begin{pmatrix} 0 & -1 & 0 & 1 & 0 & 0 & 0 & 0 & 1 & 2 & -1 & 3 \\end{pmatrix} } $$"
        },
        {
            "introduction": "任何点云分类算法的性能在很大程度上取决于其输入特征的质量，而这些特征通常是基于局部邻域计算的。然而，真实的激光雷达（LiDAR）数据表现出显著的密度变化，这对固定大小的邻域提出了挑战。本练习  提供了一种设计自适应邻域方案的动手实践方法，以确保无论局部点密度如何，特征统计都能保持稳定和鲁棒。",
            "id": "3844909",
            "problem": "您正在为从具有空间变化点密度的地形上采集的三维点云设计一种用于语义分割和分类的自适应邻域选择方案。假设在任何查询位置的附近，点采样可以由一个非均匀空间泊松过程很好地局部建模，其局部强度（单位：点/立方米）表示为 $\\hat{\\lambda}(p)$，这是真实强度 $\\lambda(p)$ 的一个局部估计量。您的目标是为每个查询位置 $p$ 选择一个半径为 $r(p)$ 的球形邻域，使得球内的期望点数等于一个预设的目标值 $m_{\\mathrm{target}}$。其基本原理是，对于三维点云语义分割和分类中常用的基于主成分分析（PCA）的局部几何描述子，样本协方差矩阵元素的方差近似地与 $1/(n-1)$ 成比例，其中 $n$ 是邻域大小。在空间上保持期望的 $n$ 近似恒定，有助于在空间密度变化的情况下保持鲁棒的特征统计量。\n\n此问题的基本事实：\n- 对于三维空间中强度为 $\\lambda$ 的均匀空间泊松过程，半径为 $r$ 的球体内的期望点数为 $\\mathbb{E}[N(B_{r})] = \\lambda \\, V(B_{r})$，其中 $V(B_{r})$ 是球体的体积。\n- 三维空间中半径为 $r$ 的球体体积为 $V(B_{r}) = \\frac{4}{3}\\pi r^{3}$。\n\n设计一个自适应半径规则 $r(p)$，它是一个关于 $\\hat{\\lambda}(p)$ 和 $m_{\\mathrm{target}}$ 的函数，使得 $\\mathbb{E}[N(B_{r(p)}) \\mid \\hat{\\lambda}(p)] = m_{\\mathrm{target}}$。为了保持该方法的数值稳定性和物理合理性，请应用以下钳位操作来处理边界情况：\n- 将 $\\hat{\\lambda}(p)$ 替换为 $\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{\\hat{\\lambda}(p), \\lambda_{\\min}\\}, \\lambda_{\\max}\\}$，其中 $\\lambda_{\\min} > 0$ 和 $\\lambda_{\\max} > 0$ 是用户选择的界限。\n- 通过 $r_{\\mathrm{final}}(p) = \\min\\{\\max\\{r(p), r_{\\min}\\}, r_{\\max}\\}$ 将最终半径钳位在 $[r_{\\min}, r_{\\max}]$ 范围内。\n\n实现一个程序，根据一组查询位置的 $\\hat{\\lambda}(p)$ 值计算它们的 $r_{\\mathrm{final}}(p)$。使用以下常量和测试组。所有强度单位为点/立方米，所有半径必须以米表示。\n\n常量：\n- $m_{\\mathrm{target}} = 50$\n- $r_{\\min} = 0.05$\n- $r_{\\max} = 10.0$\n- $\\lambda_{\\min} = 10^{-3}$\n- $\\lambda_{\\max} = 10^{5}$\n\n测试组（每个测试用例提供一个 $\\hat{\\lambda}(p)$）：\n- 情况 A: $\\hat{\\lambda}(p) = 10^{-1}$\n- 情况 B: $\\hat{\\lambda}(p) = 1$\n- 情况 C: $\\hat{\\lambda}(p) = 10$\n- 情况 D: $\\hat{\\lambda}(p) = 10^{-6}$\n- 情况 E: $\\hat{\\lambda}(p) = 10^{4}$\n\n您的程序必须：\n- 基于上述基本事实和设计目标，从第一性原理推导出 $r(p)$。\n- 按所述方式对 $\\hat{\\lambda}(p)$ 和 $r(p)$ 应用钳位操作。\n- 生成单行输出，包含五个半径的列表 $[r_{\\mathrm{final}}^{A}, r_{\\mathrm{final}}^{B}, r_{\\mathrm{final}}^{C}, r_{\\mathrm{final}}^{D}, r_{\\mathrm{final}}^{E}]$，形式为方括号内由逗号分隔的列表。每个半径以米为单位，并四舍五入到 $6$ 位小数。例如，输出格式必须与 $[x_{A},x_{B},x_{C},x_{D},x_{E}]$ 完全一样，其中每个 $x_{\\cdot}$ 是一个小数点后有 $6$ 位数字的十进制数。\n\n注意：此任务不涉及角度；不需要角度单位。所有数值答案必须如上所述以米为单位。",
            "solution": "所提出的问题具有科学依据、是适定且客观的。它代表了三维点云数据分析中的一个标准任务，植根于空间泊松过程的统计特性以及特征提取算法的实际要求。所有必要的数据、模型和约束都已提供，并且它们内部一致且物理上合理。因此，该问题被认为是有效的，可以推导出完整的解决方案。\n\n核心目标是确定以查询点 $p$ 为中心的球形邻域的自适应半径 $r(p)$，使得该球内的期望点数 $\\mathbb{E}[N(B_{r(p)})]$ 等于目标值 $m_{\\mathrm{target}}$。点云被建模为具有局部估计强度 $\\hat{\\lambda}(p)$ 的非均匀空间泊松过程。\n\n对于强度为常数 $\\lambda$ 的均匀空间泊松过程，其基本原理是体积 $V$ 内的期望点数为 $\\lambda V$。对于自适应半径选择，一个标准且有效的假设是，在一个足够小的球体内，可以用一个强度等于局部估计值 $\\hat{\\lambda}(p)$ 的均匀过程来近似非均匀过程。因此，我们可以写出：\n$$\n\\mathbb{E}[N(B_{r(p)}) \\mid \\hat{\\lambda}(p)] \\approx \\hat{\\lambda}(p) \\, V(B_{r(p)})\n$$\n半径为 $r(p)$ 的三维球体的体积是 $V(B_{r(p)}) = \\frac{4}{3}\\pi [r(p)]^3$。将期望点数设为目标值 $m_{\\mathrm{target}}$，得到控制方程：\n$$\nm_{\\mathrm{target}} = \\hat{\\lambda}(p) \\left( \\frac{4}{3}\\pi [r(p)]^3 \\right)\n$$\n必须求解此方程以得到半径 $r(p)$。\n\n完整的算法包括三个主要步骤：强度钳位、半径计算和半径钳位。\n\n步骤 1：有效强度计算\n为确保数值稳定性并处理极低或极高点密度的物理不实现象，首先将估计强度 $\\hat{\\lambda}(p)$ 钳位到预定义范围 $[\\lambda_{\\min}, \\lambda_{\\max}]$ 内。有效强度 $\\hat{\\lambda}_{\\mathrm{eff}}(p)$ 由下式给出：\n$$\n\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{\\hat{\\lambda}(p), \\lambda_{\\min}\\}, \\lambda_{\\max}\\}\n$$\n此步骤可防止除以接近零的强度（这会产生无限大的半径），并限制过高密度区域的影响。\n\n步骤 2：理想半径计算\n我们将 $\\hat{\\lambda}_{\\mathrm{eff}}(p)$ 代入控制方程，求解理想半径，我们将其简记为 $r(p)$：\n$$\nm_{\\mathrm{target}} = \\hat{\\lambda}_{\\mathrm{eff}}(p) \\left( \\frac{4}{3}\\pi [r(p)]^3 \\right)\n$$\n整理各项以分离出 $[r(p)]^3$：\n$$\n[r(p)]^3 = \\frac{3 \\, m_{\\mathrm{target}}}{4 \\pi \\hat{\\lambda}_{\\mathrm{eff}}(p)}\n$$\n对两边取立方根，得到理想半径的表达式：\n$$\nr(p) = \\left( \\frac{3 \\, m_{\\mathrm{target}}}{4 \\pi \\hat{\\lambda}_{\\mathrm{eff}}(p)} \\right)^{1/3}\n$$\n\n步骤 3：最终半径钳位\n计算出的理想半径 $r(p)$ 可能仍然小于或大于后续处理步骤（例如，PCA）的实际可用范围。因此，应用最后一步钳位操作，将半径约束在 $[r_{\\min}, r_{\\max}]$ 范围内。最终的自适应半径 $r_{\\mathrm{final}}(p)$ 为：\n$$\nr_{\\mathrm{final}}(p) = \\min\\{\\max\\{r(p), r_{\\min}\\}, r_{\\max}\\}\n$$\n\n应用于测试用例\n给定的常量为 $m_{\\mathrm{target}} = 50$，$r_{\\min} = 0.05$ 米，$r_{\\max} = 10.0$ 米，$\\lambda_{\\min} = 10^{-3}$ 点/立方米，以及 $\\lambda_{\\max} = 10^{5}$ 点/立方米。\n\n情况 A: $\\hat{\\lambda}(p) = 10^{-1}$\n1. $\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{0.1, 10^{-3}\\}, 10^{5}\\} = 0.1$。\n2. $r(p) = \\left( \\frac{3 \\cdot 50}{4 \\pi \\cdot 0.1} \\right)^{1/3} = \\left( \\frac{150}{0.4\\pi} \\right)^{1/3} \\approx 4.923970$ 米。\n3. $r_{\\mathrm{final}}(p) = \\min\\{\\max\\{4.923970, 0.05\\}, 10.0\\} = 4.923970$ 米。\n\n情况 B: $\\hat{\\lambda}(p) = 1$\n1. $\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{1, 10^{-3}\\}, 10^{5}\\} = 1$。\n2. $r(p) = \\left( \\frac{3 \\cdot 50}{4 \\pi \\cdot 1} \\right)^{1/3} = \\left( \\frac{150}{4\\pi} \\right)^{1/3} \\approx 2.285580$ 米。\n3. $r_{\\mathrm{final}}(p) = \\min\\{\\max\\{2.285580, 0.05\\}, 10.0\\} = 2.285580$ 米。\n\n情况 C: $\\hat{\\lambda}(p) = 10$\n1. $\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{10, 10^{-3}\\}, 10^{5}\\} = 10$。\n2. $r(p) = \\left( \\frac{3 \\cdot 50}{4 \\pi \\cdot 10} \\right)^{1/3} = \\left( \\frac{150}{40\\pi} \\right)^{1/3} \\approx 1.060790$ 米。\n3. $r_{\\mathrm{final}}(p) = \\min\\{\\max\\{1.060790, 0.05\\}, 10.0\\} = 1.060790$ 米。\n\n情况 D: $\\hat{\\lambda}(p) = 10^{-6}$\n1. 初始值低于 $\\lambda_{\\min}$。$\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{10^{-6}, 10^{-3}\\}, 10^{5}\\} = 10^{-3}$。\n2. $r(p) = \\left( \\frac{3 \\cdot 50}{4 \\pi \\cdot 10^{-3}} \\right)^{1/3} = \\left( \\frac{150}{0.004\\pi} \\right)^{1/3} \\approx 22.855802$ 米。\n3. 计算出的半径超过了 $r_{\\max}$。$r_{\\mathrm{final}}(p) = \\min\\{\\max\\{22.855802, 0.05\\}, 10.0\\} = 10.0$ 米。\n\n情况 E: $\\hat{\\lambda}(p) = 10^{4}$\n1. $\\hat{\\lambda}_{\\mathrm{eff}}(p) = \\min\\{\\max\\{10^{4}, 10^{-3}\\}, 10^{5}\\} = 10^{4}$。\n2. $r(p) = \\left( \\frac{3 \\cdot 50}{4 \\pi \\cdot 10^{4}} \\right)^{1/3} = \\left( \\frac{150}{40000\\pi} \\right)^{1/3} \\approx 0.106079$ 米。\n3. $r_{\\mathrm{final}}(p) = \\min\\{\\max\\{0.106079, 0.05\\}, 10.0\\} = 0.106079$ 米。",
            "answer": "$$ \\boxed{[4.923970, 2.285580, 1.060790, 10.000000, 0.106079]} $$"
        },
        {
            "introduction": "在训练完语义分割模型后，严格评估其性能至关重要。这最后一个练习将深入探讨混淆矩阵的构建与解读，这是分类评估的基石。您将计算精确率、召回率和 $F1$ 分数等关键指标，并批判性地分析现实世界中的复杂情况（例如类别之间的模糊边界）如何影响模型性能 。",
            "id": "3844924",
            "problem": "部署了一个光探测和测距 (LiDAR) 语义分割管道，用于将一个在混合城市-河口景观上采集的三维点云分类为四个语义类别：地面、植被、建筑和水体。考虑一次单一的、时间上一致的采集，使得采样密度和遮挡模式在整个场景中是稳定的。给定以下基于分类事件标准定义的科学上合理的设置：\n\n- 共有 $4$ 个类别：$C_{1}$ (地面)，$C_{2}$ (植被)，$C_{3}$ (建筑) 和 $C_{4}$ (水体)。\n- 真实的类别计数为：$N_{1} = 5000$，$N_{2} = 8000$，$N_{3} = 3000$，$N_{4} = 4000$。\n- 一个基准分类器为每个真实类别生成了以下预测标签的计数（行表示真实类别，列按 $C_{1},C_{2},C_{3},C_{4}$ 的顺序表示预测类别）：\n  - 对于 $C_{1}$：$[4600, 200, 150, 50]$。\n  - 对于 $C_{2}$：$[300, 7200, 200, 300]$。\n  - 对于 $C_{3}$：$[100, 120, 2700, 80]$。\n  - 对于 $C_{4}$：$[50, 250, 100, 3600]$。\n\n环境边界（例如，植被-水体过渡带、地面-建筑边缘）对于那些局部邻域跨越了异质材料的点，会引起额外的标签模糊性。经验性实地测绘表明，边界效应表现为将一些对角线（正确）预测重新分配到最易混淆的相邻类别中。将这种由边界引起的重新分配建模为从基准矩阵的对角线到其非对角线的以下逐行重新分配：\n\n- 从被正确预测为 $C_{1}$ 的点中，将 $60$ 个重新分配给 $C_{2}$，$40$ 个给 $C_{3}$，以及 $20$ 个给 $C_{4}$。\n- 从被正确预测为 $C_{2}$ 的点中，将 $80$ 个重新分配给 $C_{1}$，$60$ 个给 $C_{3}$，以及 $60$ 个给 $C_{4}$。\n- 从被正确预测为 $C_{3}$ 的点中，将 $30$ 个重新分配给 $C_{1}$，$40$ 个给 $C_{2}$，以及 $20$ 个给 $C_{4}$。\n- 从被正确预测为 $C_{4}$ 的点中，将 $40$ 个重新分配给 $C_{1}$，$80$ 个给 $C_{2}$，以及 $40$ 个给 $C_{3}$。\n\n任务：\n1. 构建基准混淆矩阵和受边界影响的混淆矩阵，确保每行的和等于对应的真实类别计数 $N_{k}$，并且总和等于 $N_{1}+N_{2}+N_{3}+N_{4}$。\n2. 仅使用分类事件和度量指标的核心定义，为受边界影响的混淆矩阵推导出每个类别 $C_{k}$ 的精确率、召回率和 $F1$ 分数，其中精确率、召回率和 $F1$ 分数由真正例、假正例和假负例定义。\n3. 使用混淆矩阵的结构，解释为什么边界点会改变每个类别的这些度量指标，说明非对角线项的增加以及假正例和假负例的相应变化。\n4. 最后，计算受边界影响的混淆矩阵的宏平均 $F1$ 分数（各类别 $F1$ 分数的算术平均值）。将你的最终答案表示为单个精确分数或封闭形式的解析表达式。不要四舍五入。最终答案必须是这个宏平均 $F1$ 分数。",
            "solution": "对问题陈述进行验证。\n\n提取已知条件如下：\n- 共有 $4$ 个类别，记为 $C_{k}$，其中 $k \\in \\{1, 2, 3, 4\\}$。\n- 真实的类别计数（每个类别的点数）为 $N_{1} = 5000$，$N_{2} = 8000$，$N_{3} = 3000$ 和 $N_{4} = 4000$。点的总数为 $N = N_{1}+N_{2}+N_{3}+N_{4} = 20000$。\n- 基准分类器的性能由混淆矩阵的行给出，其中行是真实类别，列是预测类别：\n  - 对于真实类别 $C_{1}$：$[4600, 200, 150, 50]$。行和：$4600+200+150+50 = 5000 = N_{1}$。\n  - 对于真实类别 $C_{2}$：$[300, 7200, 200, 300]$。行和：$300+7200+200+300 = 8000 = N_{2}$。\n  - 对于真实类别 $C_{3}$：$[100, 120, 2700, 80]$。行和：$100+120+2700+80 = 3000 = N_{3}$。\n  - 对于真实类别 $C_{4}$：$[50, 250, 100, 3600]$。行和：$50+250+100+3600 = 4000 = N_{4}$。\n- 边界效应导致正确分类的点（对角线项）在同一行内重新分配到非对角线项：\n  - 从 $C_{1}$：$60$ 个点到 $C_{2}$，$40$ 个到 $C_{3}$，$20$ 个到 $C_{4}$。移动总数：$120$。\n  - 从 $C_{2}$：$80$ 个点到 $C_{1}$，$60$ 个到 $C_{3}$，$60$ 个到 $C_{4}$。移动总数：$200$。\n  - 从 $C_{3}$：$30$ 个点到 $C_{1}$，$40$ 个到 $C_{2}$，$20$ 个到 $C_{4}$。移动总数：$90$。\n  - 从 $C_{4}$：$40$ 个点到 $C_{1}$，$80$ 个到 $C_{2}$，$40$ 个到 $C_{3}$。移动总数：$160$。\n\n验证检查确认该问题在遥感和机器学习分类领域具有科学依据。所提供的数据是自洽的，因为基准预测的行和与真实类别计数相匹配。边界效应被描述为一组保持行和不变的操作，这在逻辑上是一致的。问题是适定的、客观的，并包含足够的信息以获得唯一解。未检测到任何缺陷。该问题被认为是有效的。\n\n解题过程如下。\n\n**1. 构建混淆矩阵**\n\n对于一个 $K$ 类问题，混淆矩阵 $M$ 是一个大小为 $K \\times K$ 的方阵，其中条目 $M_{ij}$ 是真实类别为 $C_i$ 但被预测为类别 $C_j$ 的观测数量。\n\n基准混淆矩阵 $M_{base}$ 直接根据所提供的计数构建：\n$$\nM_{base} = \\begin{pmatrix}\n4600 & 200 & 150 & 50 \\\\\n300 & 7200 & 200 & 300 \\\\\n100 & 120 & 2700 & 80 \\\\\n50 & 250 & 100 & 3600\n\\end{pmatrix}\n$$\n正如在验证期间所证实的，每行 $k$ 的和等于相应的真实类别计数 $N_k$。所有条目的总和为 $N = 20000$。\n\n受边界影响的混淆矩阵 $M_{bound}$ 是通过将指定的重新分配应用于 $M_{base}$ 得到的。对于每一行 $k$，我们从对角线元素 $M_{kk}$ 中减去重新分配的点的总数，并将它们加到相应的非对角线元素 $M_{kj}$ ($j \\neq k$) 上。\n\n对于第 1 行 (真实 $C_1$)：\n- 对角线：$4600 - (60+40+20) = 4600 - 120 = 4480$。\n- 非对角线：$M_{12} \\to 200+60=260$；$M_{13} \\to 150+40=190$；$M_{14} \\to 50+20=70$。\n- 新的第 1 行：$[4480, 260, 190, 70]$。和：$5000 = N_1$。\n\n对于第 2 行 (真实 $C_2$)：\n- 对角线：$7200 - (80+60+60) = 7200 - 200 = 7000$。\n- 非对角线：$M_{21} \\to 300+80=380$；$M_{23} \\to 200+60=260$；$M_{24} \\to 300+60=360$。\n- 新的第 2 行：$[380, 7000, 260, 360]$。和：$8000 = N_2$。\n\n对于第 3 行 (真实 $C_3$)：\n- 对角线：$2700 - (30+40+20) = 2700 - 90 = 2610$。\n- 非对角线：$M_{31} \\to 100+30=130$；$M_{32} \\to 120+40=160$；$M_{34} \\to 80+20=100$。\n- 新的第 3 行：$[130, 160, 2610, 100]$。和：$3000 = N_3$。\n\n对于第 4 行 (真实 $C_4$)：\n- 对角线：$3600 - (40+80+40) = 3600 - 160 = 3440$。\n- 非对角线：$M_{41} \\to 50+40=90$；$M_{42} \\to 250+80=330$；$M_{43} \\to 100+40=140$。\n- 新的第 4 行：$[90, 330, 140, 3440]$。和：$4000 = N_4$。\n\n得到的受边界影响的混淆矩阵是：\n$$\nM_{bound} = \\begin{pmatrix}\n4480 & 260 & 190 & 70 \\\\\n380 & 7000 & 260 & 360 \\\\\n130 & 160 & 2610 & 100 \\\\\n90 & 330 & 140 & 3440\n\\end{pmatrix}\n$$\n行和保持不变，总和仍为 $20000$。\n\n**2. $M_{bound}$ 的各类别分类度量指标**\n\n对于每个类别 $C_k$，我们计算真正例 ($TP_k$)、假正例 ($FP_k$) 和假负例 ($FN_k$)。\n- $TP_k = M_{bound, kk}$ (对角线元素)。\n- $FP_k = (\\sum_{i=1}^{4} M_{bound, ik}) - TP_k$ (列和减去对角线元素)。\n- $FN_k = (\\sum_{j=1}^{4} M_{bound, kj}) - TP_k = N_k - TP_k$ (行和减去对角线元素)。\n\n度量指标定义如下：\n- 精确率：$P_k = \\frac{TP_k}{TP_k + FP_k}$\n- 召回率：$R_k = \\frac{TP_k}{TP_k + FN_k}$\n- $F1$ 分数：$F1_k = 2 \\frac{P_k R_k}{P_k + R_k} = \\frac{2TP_k}{2TP_k + FP_k + FN_k}$\n\n首先，我们计算 $M_{bound}$ 的列和：\n- 第 1 列和：$4480+380+130+90 = 5080$。\n- 第 2 列和：$260+7000+160+330 = 7750$。\n- 第 3 列和：$190+260+2610+140 = 3200$。\n- 第 4 列和：$70+360+100+3440 = 3970$。\n\n现在，我们计算每个类别的度量指标：\n\n- **类别 $C_1$ (地面)：**\n  $TP_1 = 4480$。\n  $FP_1 = 5080 - 4480 = 600$。\n  $FN_1 = 5000 - 4480 = 520$。\n  $P_1 = \\frac{4480}{5080} = \\frac{112}{127}$。\n  $R_1 = \\frac{4480}{5000} = \\frac{112}{125}$。\n  $F1_1 = \\frac{2 \\times 4480}{2 \\times 4480 + 600 + 520} = \\frac{8960}{8960 + 1120} = \\frac{8960}{10080} = \\frac{896}{1008} = \\frac{8}{9}$。\n\n- **类别 $C_2$ (植被)：**\n  $TP_2 = 7000$。\n  $FP_2 = 7750 - 7000 = 750$。\n  $FN_2 = 8000 - 7000 = 1000$。\n  $P_2 = \\frac{7000}{7750} = \\frac{28}{31}$。\n  $R_2 = \\frac{7000}{8000} = \\frac{7}{8}$。\n  $F1_2 = \\frac{2 \\times 7000}{2 \\times 7000 + 750 + 1000} = \\frac{14000}{14000 + 1750} = \\frac{14000}{15750} = \\frac{1400}{1575} = \\frac{56}{63} = \\frac{8}{9}$。\n\n- **类别 $C_3$ (建筑)：**\n  $TP_3 = 2610$。\n  $FP_3 = 3200 - 2610 = 590$。\n  $FN_3 = 3000 - 2610 = 390$。\n  $P_3 = \\frac{2610}{3200} = \\frac{261}{320}$。\n  $R_3 = \\frac{2610}{3000} = \\frac{261}{300} = \\frac{87}{100}$。\n  $F1_3 = \\frac{2 \\times 2610}{2 \\times 2610 + 590 + 390} = \\frac{5220}{5220 + 980} = \\frac{5220}{6200} = \\frac{522}{620} = \\frac{261}{310}$。\n\n- **类别 $C_4$ (水体)：**\n  $TP_4 = 3440$。\n  $FP_4 = 3970 - 3440 = 530$。\n  $FN_4 = 4000 - 3440 = 560$。\n  $P_4 = \\frac{3440}{3970} = \\frac{344}{397}$。\n  $R_4 = \\frac{3440}{4000} = \\frac{344}{400} = \\frac{43}{50}$。\n  $F1_4 = \\frac{2 \\times 3440}{2 \\times 3440 + 530 + 560} = \\frac{6880}{6880 + 1090} = \\frac{6880}{7970} = \\frac{688}{797}$。\n\n**3. 边界效应对度量指标变化的影响解释**\n\n由边界引起的重新分配只将点从正确的分类移动到不正确的分类。让我们对任意类别 $C_k$ 进行分析。\n- **真正例** ($TP_k=M_{kk}$) 的计数被明确地减少，因为点从对角线被重新分配出去。\n- **假负例** ($FN_k$) 的计数是第 $k$ 行中非对角线元素的总和 ($FN_k = \\sum_{j \\neq k} M_{kj}$)。由于点从 $M_{kk}$ 移动到 $M_{kj}$ ($j \\neq k$)， $FN_k$ 的增加量恰好等于 $TP_k$ 的减少量。\n- **假正例** ($FP_k$) 的计数是第 $k$ 列中非对角线元素的总和 ($FP_k = \\sum_{i \\neq k} M_{ik}$)。问题陈述指出，对于每个类别 $C_i$，其部分正确分类的点被重新分配给其他类别，包括 $C_k$。这意味着对于 $i \\neq k$ 的条目 $M_{ik}$ 会增加。因此，所有类别的 $FP_k$ 都会增加。\n\n这些变化直接影响度量指标：\n- **召回率**，$R_k = \\frac{TP_k}{TP_k + FN_k} = \\frac{TP_k}{N_k}$。由于 $TP_k$ 减少而分母 $N_k$ 是常数，因此每个类别的召回率都会下降。\n- **精确率**，$P_k = \\frac{TP_k}{TP_k + FP_k}$。分子 $TP_k$ 减少，而分母中的项 $FP_k$ 增加。这两个因素都导致比率下降，因此每个类别的精确率都会下降。\n- **$F1$ 分数**，$F1_k$，是精确率和召回率的调和平均值。由于 $P_k$ 和 $R_k$ 都下降了，它们的调和平均值也必然下降。按此模型，边界效应明确地降低了分类器对每个类别的性能。\n\n**4. 宏平均 F1 分数**\n\n宏平均 $F1$ 分数，$F1_{macro}$，是各类别 $F1$ 分数的算术平均值。\n$$\nF1_{macro} = \\frac{1}{4} \\sum_{k=1}^{4} F1_k = \\frac{1}{4} (F1_1 + F1_2 + F1_3 + F1_4)\n$$\n代入计算出的值：\n$$\nF1_{macro} = \\frac{1}{4} \\left( \\frac{8}{9} + \\frac{8}{9} + \\frac{261}{310} + \\frac{688}{797} \\right) = \\frac{1}{4} \\left( \\frac{16}{9} + \\frac{261}{310} + \\frac{688}{797} \\right)\n$$\n为了将它们合并成一个单独的分数，我们找到一个公分母。分母是 $9=3^2$，$310=2 \\times 5 \\times 31$ 和 $797$ (它是一个质数)。最小公倍数是 $9 \\times 310 \\times 797 = 2223630$。\n$$\nF1_{macro} = \\frac{1}{4} \\left( \\frac{16 \\times (310 \\times 797)}{2223630} + \\frac{261 \\times (9 \\times 797)}{2223630} + \\frac{688 \\times (9 \\times 310)}{2223630} \\right)\n$$\n$$\nF1_{macro} = \\frac{1}{4} \\left( \\frac{16 \\times 247070}{2223630} + \\frac{261 \\times 7173}{2223630} + \\frac{688 \\times 2790}{2223630} \\right)\n$$\n$$\nF1_{macro} = \\frac{1}{4} \\left( \\frac{3953120 + 1872153 + 1919520}{2223630} \\right)\n$$\n$$\nF1_{macro} = \\frac{1}{4} \\left( \\frac{7744793}{2223630} \\right)\n$$\n$$\nF1_{macro} = \\frac{7744793}{4 \\times 2223630} = \\frac{7744793}{8894520}\n$$\n分子和分母没有公质因数，所以这个分数是最简形式。",
            "answer": "$$\n\\boxed{\\frac{7744793}{8894520}}\n$$"
        }
    ]
}