{
    "hands_on_practices": [
        {
            "introduction": "普通克里金法是地统计学中最核心且应用最广泛的插值技术，因为它不需要预先知道空间过程的均值，这在实际应用中更具现实意义。本练习将引导你从基本原理出发，推导并建立普通克里金方程组，利用拉格朗日乘数法来满足无偏性约束条件。通过这个实践，你将掌握使用半变异函数进行空间估计的基本技能。",
            "id": "3817477",
            "problem": "一场遥感活动监测一个 $100\\,\\mathrm{m} \\times 100\\,\\mathrm{m}$ 城市街区上的细颗粒物浓度，该浓度由随机函数 $Z(\\mathbf{s})$ 表示，单位为 $\\mathrm{mg\\,m^{-3}}$。假设该过程具有内蕴平稳性，其局部均值为未知的常数，并具有一个带块金效应的各向同性指数半变异函数，其表达式为\n$$\n\\gamma(h) \\;=\\; c_{0} \\;+\\; c \\left(1 - \\exp\\!\\left(-\\frac{h}{a}\\right)\\right),\n$$\n其中 $c_{0} = 0.2\\,\\mathrm{(mg\\,m^{-3})^{2}}$，$c = 1.0\\,\\mathrm{(mg\\,m^{-3})^{2}}$，且 $a = 50\\,\\mathrm{m}$。现有三个具有精确地理位置的原位参考测量值：\n- 位于 $\\mathbf{s}_{1} = (0, 50)\\,\\mathrm{m}$ 处的 $Z(\\mathbf{s}_{1}) = 12\\,\\mathrm{mg\\,m^{-3}}$，\n- 位于 $\\mathbf{s}_{2} = (50, 0)\\,\\mathrm{m}$ 处的 $Z(\\mathbf{s}_{2}) = 10\\,\\mathrm{mg\\,m^{-3}}$，\n- 位于 $\\mathbf{s}_{3} = (50, 50)\\,\\mathrm{m}$ 处的 $Z(\\mathbf{s}_{3}) = 15\\,\\mathrm{mg\\,m^{-3}}$。\n\n你需要使用普通克里金法估计目标位置 $\\mathbf{s}_{0} = (0, 0)\\,\\mathrm{m}$ 处的浓度。从内蕴平稳过程的半变异函数定义\n$$\n\\gamma(\\mathbf{h}) \\;=\\; \\frac{1}{2}\\,\\mathbb{E}\\!\\left[\\big(Z(\\mathbf{s}+\\mathbf{h}) - Z(\\mathbf{s})\\big)^{2}\\right],\n$$\n出发，并结合具有未知常数均值的普通克里金法的无偏性条件，推导出使估计方差最小的普通克里金权重，并计算普通克里金估计值 $\\hat{Z}(\\mathbf{s}_{0})$。根据定义，始终将 $\\gamma(0)$ 视为 $0$。以 $\\mathrm{mg\\,m^{-3}}$ 为单位表示最终估计值，并将答案四舍五入到四位有效数字。",
            "solution": "我们将 $Z(\\mathbf{s})$ 建模为一个内蕴平稳随机函数，其局部均值为未知的常数 $m$，半变异函数为指定的 $\\gamma(h)$。在 $\\mathbf{s}_{0}$ 处的普通克里金估计量为\n$$\n\\hat{Z}(\\mathbf{s}_{0}) \\;=\\; \\sum_{i=1}^{n} w_{i}\\, Z(\\mathbf{s}_{i}),\n$$\n其中 $n = 3$，权重 $\\{w_{i}\\}$ 的选择需满足无偏性并使估计方差最小化。对于普通克里金法，在未知常数均值条件下的无偏性要求\n$$\n\\sum_{i=1}^{n} w_{i} \\;=\\; 1.\n$$\n对于内蕴平稳过程，其估计方差可以用半变异函数表示为\n$$\n\\sigma^{2}_{\\mathrm{OK}}(\\mathbf{s}_{0}) \\;=\\; \\mathrm{Var}\\!\\left(\\hat{Z}(\\mathbf{s}_{0}) - Z(\\mathbf{s}_{0})\\right)\n\\;=\\; \\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{i} w_{j}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{i} - \\mathbf{s}_{j}\\|\\right)\n- 2 \\sum_{i=1}^{n} w_{i}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{i} - \\mathbf{s}_{0}\\|\\right).\n$$\n为了在最小化 $\\sigma^{2}_{\\mathrm{OK}}(\\mathbf{s}_{0})$ 的同时施加无偏性约束，我们构建拉格朗日函数\n$$\n\\mathcal{L}(\\mathbf{w}, \\mu) \\;=\\; \\sum_{i=1}^{n}\\sum_{j=1}^{n} w_{i} w_{j}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{i} - \\mathbf{s}_{j}\\|\\right)\n- 2 \\sum_{i=1}^{n} w_{i}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{i} - \\mathbf{s}_{0}\\|\\right)\n+ 2\\mu \\left(\\sum_{i=1}^{n} w_{i} - 1\\right),\n$$\n并将其关于 $w_{k}$ 的偏导数设为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial w_{k}} \\;=\\; 2 \\sum_{j=1}^{n} w_{j}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{k} - \\mathbf{s}_{j}\\|\\right)\n- 2\\, \\gamma\\!\\left(\\|\\mathbf{s}_{k} - \\mathbf{s}_{0}\\|\\right)\n+ 2\\mu \\;=\\; 0.\n$$\n两边除以 2，得到以半变异函数形式表示的普通克里金方程组：\n$$\n\\sum_{j=1}^{n} w_{j}\\, \\gamma\\!\\left(\\|\\mathbf{s}_{k} - \\mathbf{s}_{j}\\|\\right) + \\mu \\;=\\; \\gamma\\!\\left(\\|\\mathbf{s}_{k} - \\mathbf{s}_{0}\\|\\right), \\quad k = 1, \\dots, n,\n$$\n以及约束条件 $\\sum_{i=1}^{n} w_{i} = 1$。由于 $\\gamma(0) = 0$，对角线元素满足 $\\gamma(\\|\\mathbf{s}_{i} - \\mathbf{s}_{i}\\|) = 0$。\n\n我们计算所有需要的距离。目标位置为 $\\mathbf{s}_{0} = (0, 0)\\,\\mathrm{m}$，数据点位置为 $\\mathbf{s}_{1} = (0, 50)\\,\\mathrm{m}$，$\\mathbf{s}_{2} = (50, 0)\\,\\mathrm{m}$，$\\mathbf{s}_{3} = (50, 50)\\,\\mathrm{m}$。两点间的距离如下：\n- $\\|\\mathbf{s}_{1} - \\mathbf{s}_{0}\\| = \\sqrt{(0-0)^{2} + (50-0)^{2}} = 50\\,\\mathrm{m}$,\n- $\\|\\mathbf{s}_{2} - \\mathbf{s}_{0}\\| = \\sqrt{(50-0)^{2} + (0-0)^{2}} = 50\\,\\mathrm{m}$,\n- $\\|\\mathbf{s}_{3} - \\mathbf{s}_{0}\\| = \\sqrt{(50-0)^{2} + (50-0)^{2}} = 50\\sqrt{2}\\,\\mathrm{m}$,\n- $\\|\\mathbf{s}_{1} - \\mathbf{s}_{2}\\| = \\sqrt{(0-50)^{2} + (50-0)^{2}} = 50\\sqrt{2}\\,\\mathrm{m}$,\n- $\\|\\mathbf{s}_{1} - \\mathbf{s}_{3}\\| = \\sqrt{(0-50)^{2} + (50-50)^{2}} = 50\\,\\mathrm{m}$,\n- $\\|\\mathbf{s}_{2} - \\mathbf{s}_{3}\\| = \\sqrt{(50-50)^{2} + (0-50)^{2}} = 50\\,\\mathrm{m}$.\n\n定义\n$$\n\\gamma_{50} \\;=\\; \\gamma(50) \\;=\\; c_{0} + c\\left(1 - \\exp\\!\\left(-\\frac{50}{a}\\right)\\right)\n\\;=\\; 0.2 + 1.0\\left(1 - \\exp(-1)\\right)\n\\;=\\; 1.2 - \\exp(-1),\n$$\n$$\n\\gamma_{70} \\;=\\; \\gamma(50\\sqrt{2}) \\;=\\; c_{0} + c\\left(1 - \\exp\\!\\left(-\\frac{50\\sqrt{2}}{a}\\right)\\right)\n\\;=\\; 0.2 + 1.0\\left(1 - \\exp(-\\sqrt{2})\\right)\n\\;=\\; 1.2 - \\exp(-\\sqrt{2}).\n$$\n数值上，\n$$\n\\exp(-1) \\approx 0.367879441, \\quad \\exp(-\\sqrt{2}) \\approx 0.243116734,\n$$\n所以\n$$\n\\gamma_{50} \\approx 0.832120559, \\quad \\gamma_{70} \\approx 0.956883266.\n$$\n\n设权重为 $w_{1}, w_{2}, w_{3}$，拉格朗日乘子为 $\\mu$。普通克里金方程组变为\n$$\n\\begin{aligned}\n\\gamma(\\|\\mathbf{s}_{1}-\\mathbf{s}_{2}\\|) w_{2} + \\gamma(\\|\\mathbf{s}_{1}-\\mathbf{s}_{3}\\|) w_{3} + \\mu &=\\; \\gamma(\\|\\mathbf{s}_{1}-\\mathbf{s}_{0}\\|), \\\\\n\\gamma(\\|\\mathbf{s}_{2}-\\mathbf{s}_{1}\\|) w_{1} + \\gamma(\\|\\mathbf{s}_{2}-\\mathbf{s}_{3}\\|) w_{3} + \\mu &=\\; \\gamma(\\|\\mathbf{s}_{2}-\\mathbf{s}_{0}\\|), \\\\\n\\gamma(\\|\\mathbf{s}_{3}-\\mathbf{s}_{1}\\|) w_{1} + \\gamma(\\|\\mathbf{s}_{3}-\\mathbf{s}_{2}\\|) w_{2} + \\mu &=\\; \\gamma(\\|\\mathbf{s}_{3}-\\mathbf{s}_{0}\\|), \\\\\nw_{1} + w_{2} + w_{3} &=\\; 1,\n\\end{aligned}\n$$\n代入距离后，方程组为\n$$\n\\begin{aligned}\n\\gamma_{70}\\, w_{2} + \\gamma_{50}\\, w_{3} + \\mu &=\\; \\gamma_{50}, \\\\\n\\gamma_{70}\\, w_{1} + \\gamma_{50}\\, w_{3} + \\mu &=\\; \\gamma_{50}, \\\\\n\\gamma_{50}\\, w_{1} + \\gamma_{50}\\, w_{2} + \\mu &=\\; \\gamma_{70}, \\\\\nw_{1} + w_{2} + w_{3} &=\\; 1.\n\\end{aligned}\n$$\n根据几何构型相对于 $\\mathbf{s}_{0}$ 的对称性，我们有 $w_{1} = w_{2} = w$。设 $w_{3} = v$。方程组简化为\n$$\n\\begin{aligned}\n\\gamma_{70}\\, w + \\gamma_{50}\\, v + \\mu &=\\; \\gamma_{50}, \\\\\n2\\,\\gamma_{50}\\, w + \\mu &=\\; \\gamma_{70}, \\\\\n2w + v &=\\; 1.\n\\end{aligned}\n$$\n第一个方程减去第二个方程，消去 $\\mu$：\n$$\n\\left(\\gamma_{70} - 2\\gamma_{50}\\right) w + \\gamma_{50}\\, v \\;=\\; \\gamma_{50} - \\gamma_{70}.\n$$\n使用约束条件 $v = 1 - 2w$，我们得到\n$$\n\\left(\\gamma_{70} - 2\\gamma_{50}\\right) w + \\gamma_{50} (1 - 2w) \\;=\\; \\gamma_{50} - \\gamma_{70},\n$$\n化简为\n$$\n\\left(\\gamma_{70} - 2\\gamma_{50} - 2\\gamma_{50}\\right) w + \\gamma_{50} \\;=\\; \\gamma_{50} - \\gamma_{70},\n$$\n$$\n\\left(\\gamma_{70} - 4\\gamma_{50}\\right) w \\;=\\; -\\gamma_{70}.\n$$\n等价地（保留之前汇总的系数），\n$$\n-2.37159897\\, w \\;\\approx\\; -0.956883266 \\quad\\Rightarrow\\quad w \\;\\approx\\; 0.403477.\n$$\n那么\n$$\nv \\;=\\; 1 - 2w \\;\\approx\\; 1 - 0.806954 \\;\\approx\\; 0.193046.\n$$\n普通克里金估计值为\n$$\n\\hat{Z}(\\mathbf{s}_{0}) \\;=\\; w\\, Z(\\mathbf{s}_{1}) + w\\, Z(\\mathbf{s}_{2}) + v\\, Z(\\mathbf{s}_{3})\n\\;=\\; w\\,(12 + 10) + v\\,(15)\n\\;=\\; 22w + 15v.\n$$\n数值上，\n$$\n22w \\;\\approx\\; 22 \\times 0.403477 \\;\\approx\\; 8.876494, \\quad 15v \\;\\approx\\; 15 \\times 0.193046 \\;\\approx\\; 2.895690,\n$$\n所以\n$$\n\\hat{Z}(\\mathbf{s}_{0}) \\;\\approx\\; 8.876494 + 2.895690 \\;\\approx\\; 11.772184\\,\\mathrm{mg\\,m^{-3}}.\n$$\n四舍五入到四位有效数字并以 $\\mathrm{mg\\,m^{-3}}$ 为单位表示，普通克里金估计值为 $11.77\\,\\mathrm{mg\\,m^{-3}}$。",
            "answer": "$$\\boxed{11.77}$$"
        },
        {
            "introduction": "建立一个空间插值模型只是第一步，评估其预测的可靠性同样至关重要。本练习将介绍一种基本的模型验证技术——留一法交叉验证（LOOCV），它通过系统性地移除一个数据点并用其余数据进行预测来检验模型的性能。你将学习如何计算一个关键的诊断指标，即均方标准化误差（MSSE），以判断模型的预测不确定性是否与实际预测误差相符。",
            "id": "3817496",
            "problem": "一个遥感团队使用合成孔径雷达（SAR）来估计一小块农田的地表土壤水分含量。三个地面验证点排列成一个边长为 $1$ $\\mathrm{km}$ 的等边三角形，其坐标分别为 $\\left(0,0\\right)$、$\\left(1,0\\right)$ 和 $\\left(\\frac{1}{2},\\frac{\\sqrt{3}}{2}\\right)$，测得的土壤水分含量为 $\\left(z_{1},z_{2},z_{3}\\right)=\\left(0.32,0.40,0.28\\right)$。假设土壤湿度是一个二阶平稳高斯随机场，其各向同性指数协方差函数为 $C\\!\\left(h\\right)=\\sigma^{2}\\exp\\!\\left(-\\frac{h}{\\phi}\\right)$，块金效应为零，偏基台值为 $\\sigma^{2}=0.02$，变程参数为 $\\phi=1$ $\\mathrm{km}$。\n\n使用普通克里金法（未知常数均值），在每个站点进行留一法交叉验证（LOOCV）：当预测位置 $\\mathbf{x}_{i}$ 的值时，仅使用其余两个点作为训练集。仅从普通克里金作为最佳线性无偏估计量的定义以及在无偏性约束下最小化方差的原则出发，推导普通克里金方程组，确定每次LOOCV预测的权重，推导LOOCV目标点对应的克里金方差，并计算均方标准化误差（MSSE）\n$$\n\\mathrm{MSSE}=\\frac{1}{n}\\sum_{i=1}^{n}\\frac{\\left(z_{i}-\\hat{z}_{-i}\\right)^{2}}{\\sigma_{K,-i}^{2}},\n$$\n其中 $n=3$，$\\hat{z}_{-i}$ 是使用另外两个点对 $\\mathbf{x}_{i}$ 进行的LOOCV普通克里金预测值，$\\sigma_{K,-i}^{2}$ 是相关的LOOCV普通克里金方差。将最终的MSSE四舍五入到四位有效数字，并以无单位的小数形式表示。",
            "solution": "任务是使用普通克里金法，通过留一法交叉验证（LOOCV）程序计算均方标准化误差（MSSE）。我们首先从第一性原理推导普通克里金方程组。\n\n设随机场为 $Z(\\mathbf{x})$，假设其为二阶平稳，具有一个未知但恒定的均值 $E[Z(\\mathbf{x})] = \\mu$ 和一个已知的协方差函数 $\\mathrm{Cov}(Z(\\mathbf{x}), Z(\\mathbf{y})) = C(\\mathbf{x}-\\mathbf{y})$。\n目标是使用在 $N$ 个位置 $\\mathbf{x}_1, \\dots, \\mathbf{x}_N$ 观测到的值 $z_i = Z(\\mathbf{x}_i)$ 的线性组合来预测位置 $\\mathbf{x}_0$ 处的值 $Z(\\mathbf{x}_0)$。估计量为\n$$\n\\hat{Z}(\\mathbf{x}_0) = \\sum_{i=1}^N w_i z_i\n$$\n其中 $w_i$ 是待确定的权重。\n\n为使估计量无偏，即 $E[\\hat{Z}(\\mathbf{x}_0) - Z(\\mathbf{x}_0)] = 0$，我们需要：\n$$\nE[\\hat{Z}(\\mathbf{x}_0)] = E\\left[\\sum_{i=1}^N w_i Z(\\mathbf{x}_i)\\right] = \\sum_{i=1}^N w_i E[Z(\\mathbf{x}_i)] = \\mu \\sum_{i=1}^N w_i\n$$\n由于 $E[Z(\\mathbf{x}_0)] = \\mu$，无偏性条件要求 $\\mu \\sum_{i=1}^N w_i = \\mu$。因为对于任何未知均值 $\\mu$ 的值，该式都必须成立，所以我们必须施加约束条件：\n$$\n\\sum_{i=1}^N w_i = 1\n$$\n克里金法通过最小化估计方差 $\\sigma_K^2 = E[(\\hat{Z}(\\mathbf{x}_0) - Z(\\mathbf{x}_0))^2]$ 来确定权重，同时满足这一无偏性约束。估计方差可以展开为：\n$$\n\\sigma_K^2 = \\mathrm{Var}(\\hat{Z}(\\mathbf{x}_0) - Z(\\mathbf{x}_0)) = \\mathrm{Cov}\\left(\\sum_i w_i Z_i - Z_0, \\sum_j w_j Z_j - Z_0\\right)\n$$\n$$\n\\sigma_K^2 = \\sum_{i=1}^N \\sum_{j=1}^N w_i w_j C_{ij} - 2\\sum_{i=1}^N w_i C_{i0} + C_{00}\n$$\n其中 $Z_i = Z(\\mathbf{x}_i)$，$C_{ij} = \\mathrm{Cov}(Z_i, Z_j)$，$C_{i0} = \\mathrm{Cov}(Z_i, Z_0)$，以及 $C_{00} = \\mathrm{Var}(Z_0)$。\n\n为了解决这个约束最小化问题，我们使用拉格朗日乘数法。我们定义拉格朗日函数 $\\mathcal{L}$：\n$$\n\\mathcal{L}(\\mathbf{w}, \\lambda) = \\sum_{i=1}^N \\sum_{j=1}^N w_i w_j C_{ij} - 2\\sum_{i=1}^N w_i C_{i0} + C_{00} - 2\\lambda\\left(\\sum_{i=1}^N w_i - 1\\right)\n$$\n将关于每个权重 $w_k$ 的偏导数设为零，得到：\n$$\n\\frac{\\partial\\mathcal{L}}{\\partial w_k} = 2\\sum_{i=1}^N w_i C_{ik} - 2C_{k0} - 2\\lambda = 0 \\implies \\sum_{i=1}^N w_i C_{ik} - \\lambda = C_{k0} \\quad (k=1, \\dots, N)\n$$\n关于 $\\lambda$ 的导数恢复了约束条件 $\\sum w_i = 1$。得到的 $N+1$ 个线性方程组构成了普通克里金方程组，其矩阵形式为：\n$$\n\\begin{pmatrix}\nC_{11} & \\cdots & C_{1N} & 1 \\\\\n\\vdots & \\ddots & \\vdots & \\vdots \\\\\nC_{N1} & \\cdots & C_{NN} & 1 \\\\\n1 & \\cdots & 1 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\nw_1 \\\\\n\\vdots \\\\\nw_N \\\\\n\\lambda\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nC_{10} \\\\\n\\vdots \\\\\nC_{N0} \\\\\n1\n\\end{pmatrix}\n$$\n最小化的克里金方差由 $\\sigma_K^2 = C_{00} - \\sum_{i=1}^N w_i C_{i0} - \\lambda$ 给出。\n\n现在，我们将此框架应用于具体问题。坐标为 $\\mathbf{x}_1=(0,0)$，$\\mathbf{x}_2=(1,0)$ 和 $\\mathbf{x}_3=(\\frac{1}{2},\\frac{\\sqrt{3}}{2})$。任意两点之间的距离均为 $1$ $\\mathrm{km}$。各向同性指数协方差函数为 $C(h) = \\sigma^2 \\exp(-h/\\phi)$，其中偏基台值 $\\sigma^2 = 0.02$，变程 $\\phi = 1$ $\\mathrm{km}$。因此，$C(h) = 0.02 \\exp(-h)$。\n随机场的方差为 $C(0) = 0.02$。三个站点中任意两个之间的协方差为 $C(1) = 0.02 \\exp(-1)$。我们将其表示为 $C_0 = 0.02$ 和 $C_1 = 0.02e^{-1}$。\n\n我们对 $n=3$ 个站点中的每一个进行留一法交叉验证。由于等边三角形的几何特性，每次LOOCV预测的设置都是相同的。例如，当使用来自 $\\mathbf{x}_2$ 和 $\\mathbf{x}_3$ 的数据（$N=2$）预测 $\\mathbf{x}_1$（目标点，即 $\\mathbf{x}_0$）时，克里金方程组为：\n$$\n\\begin{pmatrix}\nC(\\mathbf{x}_2, \\mathbf{x}_2) & C(\\mathbf{x}_2, \\mathbf{x}_3) & 1 \\\\\nC(\\mathbf{x}_3, \\mathbf{x}_2) & C(\\mathbf{x}_3, \\mathbf{x}_3) & 1 \\\\\n1 & 1 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\nw_2 \\\\\nw_3 \\\\\n\\lambda\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nC(\\mathbf{x}_2, \\mathbf{x}_1) \\\\\nC(\\mathbf{x}_3, \\mathbf{x}_1) \\\\\n1\n\\end{pmatrix}\n$$\n对于不同点对，距离均为 $h=1$ $\\mathrm{km}$。因此，对于 $i \\neq j$，$C(\\mathbf{x}_i, \\mathbf{x}_i) = C_0$ 且 $C(\\mathbf{x}_i, \\mathbf{x}_j) = C_1$。方程组变为：\n$$\n\\begin{pmatrix}\nC_0 & C_1 & 1 \\\\\nC_1 & C_0 & 1 \\\\\n1 & 1 & 0\n\\end{pmatrix}\n\\begin{pmatrix}\nw_2 \\\\\nw_3 \\\\\n\\lambda\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nC_1 \\\\\nC_1 \\\\\n1\n\\end{pmatrix}\n$$\n这得到三个方程：\n1. $w_2 C_0 + w_3 C_1 + \\lambda = C_1$\n2. $w_2 C_1 + w_3 C_0 + \\lambda = C_1$\n3. $w_2 + w_3 = 1$\n\n第一个方程减去第二个方程得到 $w_2(C_0 - C_1) - w_3(C_0 - C_1) = 0$。因为 $C_0 \\neq C_1$，我们可以除以 $(C_0 - C_1)$ 得到 $w_2 = w_3$。将此结果代入第三个方程得到 $2w_2 = 1$，所以 $w_2 = w_3 = 0.5$。\n由于对称性，对于任何LOOCV预测，两个可用的数据点将始终获得 $0.5$ 的权重。\n\n克里金方差 $\\sigma_{K,-i}^2$ 对于每一次LOOCV折叠（fold）也将是相同的。让我们为在 $\\mathbf{x}_1$ 处的预测计算它：\n$$ \\sigma_{K,-1}^2 = C(\\mathbf{x}_1, \\mathbf{x}_1) - (w_2 C(\\mathbf{x}_2, \\mathbf{x}_1) + w_3 C(\\mathbf{x}_3, \\mathbf{x}_1)) - \\lambda $$\n为了求出 $\\lambda$，我们使用第一个方程：$0.5 C_0 + 0.5 C_1 + \\lambda = C_1 \\implies \\lambda = 0.5 C_1 - 0.5 C_0$。\n$$ \\sigma_{K,-1}^2 = C_0 - (0.5 C_1 + 0.5 C_1) - (0.5 C_1 - 0.5 C_0) = C_0 - C_1 - 0.5 C_1 + 0.5 C_0 $$\n$$ \\sigma_{K,-1}^2 = 1.5 C_0 - 1.5 C_1 = 1.5(C_0 - C_1) $$\n代入数值 $C_0 = 0.02$ 和 $C_1 = 0.02e^{-1}$：\n$$ \\sigma_{K,-1}^2 = 1.5(0.02 - 0.02e^{-1}) = 0.03(1 - e^{-1}) $$\n对于所有三次折叠，这个恒定的克里金方差记为 $\\sigma_{K}^2$。\n\n现在我们计算LOOCV的预测值和误差：测量值为 $(z_1, z_2, z_3) = (0.32, 0.40, 0.28)$。\n1. 在 $\\mathbf{x}_1$ 处的预测：$\\hat{z}_{-1} = 0.5 z_2 + 0.5 z_3 = 0.5(0.40 + 0.28) = 0.34$。\n    平方误差：$(z_1 - \\hat{z}_{-1})^2 = (0.32 - 0.34)^2 = (-0.02)^2 = 0.0004$。\n2. 在 $\\mathbf{x}_2$ 处的预测：$\\hat{z}_{-2} = 0.5 z_1 + 0.5 z_3 = 0.5(0.32 + 0.28) = 0.30$。\n    平方误差：$(z_2 - \\hat{z}_{-2})^2 = (0.40 - 0.30)^2 = (0.10)^2 = 0.01$。\n3. 在 $\\mathbf{x}_3$ 处的预测：$\\hat{z}_{-3} = 0.5 z_1 + 0.5 z_2 = 0.5(0.32 + 0.40) = 0.36$。\n    平方误差：$(z_3 - \\hat{z}_{-3})^2 = (0.28 - 0.36)^2 = (-0.08)^2 = 0.0064$。\n\n最后，我们计算均方标准化误差（MSSE）：\n$$ \\mathrm{MSSE} = \\frac{1}{n}\\sum_{i=1}^{n}\\frac{(z_i - \\hat{z}_{-i})^2}{\\sigma_{K,-i}^2} $$\n由于 $n=3$ 且对于所有 $i$ 都有 $\\sigma_{K,-i}^2 = \\sigma_{K}^2 = 0.03(1 - e^{-1})$：\n$$ \\mathrm{MSSE} = \\frac{1}{3 \\sigma_{K}^2} \\sum_{i=1}^3 (z_i - \\hat{z}_{-i})^2 $$\n平方误差之和为 $0.0004 + 0.01 + 0.0064 = 0.0168$。\n$$ \\mathrm{MSSE} = \\frac{0.0168}{3 \\times 0.03(1 - e^{-1})} = \\frac{0.0168}{0.09(1 - e^{-1})} $$\n对该表达式进行数值计算：\n$$ \\mathrm{MSSE} = \\frac{0.0168}{0.09 \\times (1 - \\exp(-1))} \\approx \\frac{0.0168}{0.09 \\times (1 - 0.367879)} = \\frac{0.0168}{0.09 \\times 0.632121} \\approx \\frac{0.0168}{0.0568909} \\approx 0.295311 $$\n四舍五入到四位有效数字，我们得到 $0.2953$。",
            "answer": "$$\n\\boxed{0.2953}\n$$"
        },
        {
            "introduction": "在许多环境应用中，仅仅得到一个“最佳”估计值是不够的，量化空间不确定性更为关键。本练习将介绍序列高斯模拟（SGS），这是一种强大的蒙特卡洛方法，能够生成多个与观测数据及空间结构相符的、等概率的空间场实现。通过这个编程练习，你将亲手实现SGS算法，其中普通克里金法被迭代地用于定义每一步的条件分布，从而深入理解如何对空间不确定性进行建模与可视化。",
            "id": "3817488",
            "problem": "您在遥感和环境建模领域接获一项任务，要求使用序贯高斯模拟 (SGS) 进行条件模拟。假设环境属性已被转换为均值为零、方差为一的标准高斯分布，并被建模为平稳高斯随机场。对未采样位置的插值使用普通克里金法进行，而SGS通过在每个目标位置依次从条件高斯分布中采样来生成实现，其条件包括原始测量值和先前已模拟的值。\n\n从高斯随机场和线性无偏估计的核心定义出发，根据无偏性和最小估计方差的约束推导出普通克里金系统，并建立SGS中使用的条件分布。使用带有基台值、变程和块金效应参数的各向同性指数协方差模型。通过按规定顺序访问目标位置来实现SGS，在每一步中使用当前条件集计算普通克里金估计值和克里金方差，然后从相应的条件高斯分布中抽取一个样本。\n\n基本基础和假设：\n- 假设存在一个零均值的平稳高斯随机场。协方差函数是各向同性的，并由指数模型给出。\n- 普通克里金法由一个线性估计量定义，其权重在给定协方差下满足无偏性并使估计方差最小化。\n- 序贯高斯模拟 (SGS) 定义为通过在每个位置根据所有当前可用的条件数据（原始样本和先前模拟的节点）从条件分布中抽样，逐节点地模拟高斯场。\n\n使用的定义：\n- 令 $Z(\\mathbf{x})$ 表示空间位置 $\\mathbf{x}\\in\\mathbb{R}^{2}$ 处的高斯随机场。\n- 两个位置 $\\mathbf{x}$ 和 $\\mathbf{y}$ 之间的协方差取决于分离距离 $h=\\|\\mathbf{x}-\\mathbf{y}\\|$，其形式为 $C(h)=s^{2}\\exp\\left(-\\frac{h}{a}\\right)$，其中 $s^{2}$ 是基台值，$a$ 是变程。块金效应 $\\tau^{2}$ 表示微尺度变异性和测量误差，在普通克里金法中仅加到数据-数据协方差矩阵的对角线上。\n- 普通克里金法使用权重 $\\{w_{i}\\}_{i=1}^{n}$ 作用于在位置 $\\{\\mathbf{x}_{i}\\}_{i=1}^{n}$ 观测到的值 $\\{z_{i}\\}_{i=1}^{n}$，以估计未采样位置 $\\mathbf{x}_{0}$ 处的 $Z$：$\\hat{Z}(\\mathbf{x}_{0})=\\sum_{i=1}^{n}w_{i}z_{i}$，并满足无偏性约束 $\\sum_{i=1}^{n}w_{i}=1$，且选择权重以最小化估计方差。\n\n您的程序必须为每个测试用例实现以下步骤：\n1. 形成由观测位置和值组成的条件集。所有坐标均以米为单位提供，并且必须在数值上按米（$\\mathrm{m}$）处理。\n2. 对于指定序贯路径顺序中的每个目标位置：\n   - 使用当前条件集构建普通克里金线性系统：\n     - 使用结构化协方差 $C(h)=s^{2}\\exp\\left(-\\frac{h}{a}\\right)$ 构建条件位置的 $n\\times n$ 协方差矩阵 $\\mathbf{C}$，并在对角线上加上块金效应 $\\tau^{2}$。\n     - 通过附加一行和一列的1来形成 $(n+1)\\times(n+1)$ 的增广系统，以强制执行无偏性约束。\n     - 使用不含块金效应的 $C(h)$ 计算目标位置与条件位置之间的协方差向量 $\\mathbf{c}$。\n     - 求解该系统以获得克里金权重和拉格朗日乘子，并计算克里金估计值和方差。\n   - 从条件高斯分布中为目标位置采样一个实现值，该分布的均值等于克里金估计值，方差等于根据结构化协方差模型计算出的克里金方差（使用 $C(0)=s^{2}$）。\n   - 在移至路径中的下一个目标之前，将模拟的目标及其模拟值追加到条件集中。\n\n重要的实现指南：\n- 普通克里金方差必须仅使用零滞后距处的结构化协方差 $C(0)=s^{2}$ 进行计算，不包括目标位置处的块金效应。\n- 块金效应 $\\tau^{2}$ 仅加到数据-数据协方差矩阵 $\\mathbf{C}$ 的对角线上。\n- 如果数值舍入误差产生非正的克里金方差，则将其裁剪为一个小的正值，以维持有效的高斯分布。\n\n测试套件：\n- 案例1 (正常路径)：\n  - 观测位置和值： $(\\mathbf{x}_{1},z_{1})=((0.0,0.0),0.2)$， $(\\mathbf{x}_{2},z_{2})=((50.0,0.0),-0.1)$， $(\\mathbf{x}_{3},z_{3})=((0.0,50.0),0.3)$， $(\\mathbf{x}_{4},z_{4})=((50.0,50.0),-0.2)$。\n  - 协方差参数： 基台值 $s^{2}=1.0$，变程 $a=40.0\\,\\mathrm{m}$，块金效应 $\\tau^{2}=0.05$。\n  - 目标路径 (按顺序)： $\\mathbf{x}_{0,1}=(25.0,25.0)$，然后是 $\\mathbf{x}_{0,2}=(30.0,20.0)$。\n  - 随机种子： $42$。\n- 案例2 (短变程边界条件)：\n  - 观测位置和值： $(\\mathbf{x}_{1},z_{1})=((0.0,0.0),1.0)$， $(\\mathbf{x}_{2},z_{2})=((100.0,0.0),-1.0)$。\n  - 协方差参数： 基台值 $s^{2}=1.0$，变程 $a=5.0\\,\\mathrm{m}$，块金效应 $\\tau^{2}=0.2$。\n  - 目标路径 (按顺序)： $\\mathbf{x}_{0,1}=(10.0,0.0)$，然后是 $\\mathbf{x}_{0,2}=(90.0,0.0)$。\n  - 随机种子： $123$。\n- 案例3 (高块金效应、单个数据的边缘案例)：\n  - 观测位置和值： $(\\mathbf{x}_{1},z_{1})=((10.0,10.0),0.5)$。\n  - 协方差参数： 基台值 $s^{2}=1.0$，变程 $a=20.0\\,\\mathrm{m}$，块金效应 $\\tau^{2}=0.5$。\n  - 目标路径 (按顺序)： $\\mathbf{x}_{0,1}=(12.0,12.0)$，然后是 $\\mathbf{x}_{0,2}=(40.0,40.0)$。\n  - 随机种子： $7$。\n\n角度单位不适用，因为只使用以米为单位的欧几里得距离。模拟值为无量纲数，必须以无单位的浮点数形式呈现。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。该列表必须按顺序包含案例1的两个目标的模拟值，然后是案例2的两个目标的模拟值，最后是案例3的两个目标的模拟值。\n- 每个浮点数必须四舍五入到6位小数。\n- 示例格式： $[\\text{值}_{1},\\text{值}_{2},\\text{值}_{3},\\text{值}_{4},\\text{值}_{5},\\text{值}_{6}]$。\n\n您的最终答案必须是一个完整的、可运行的程序，该程序实现所述过程并以指定的确切格式输出结果。",
            "solution": "所提出的问题是地质统计学领域一个适定且有科学依据的任务，具体涉及通过序贯高斯模拟 (SGS) 算法进行条件模拟。所有必要的数据、模型和参数均已提供，且该过程与既有的地质统计学理论一致。因此，该问题被认为是有效的。\n\n该任务的核心是推导并实现普通克里金系统，该系统是SGS过程的引擎。SGS算法通过从条件分布中序贯地抽取数值来生成高斯随机场的实现，其中每个分布本身由一个克里金估计值（均值）和克里金方差定义。\n\n设 $Z(\\mathbf{x})$ 是空间位置 $\\mathbf{x} \\in \\mathbb{R}^2$ 上的一个平稳高斯随机场。该场的特征为一个未知的常数均值 $E[Z(\\mathbf{x})] = m$ 和一个仅依赖于分离向量 $\\mathbf{h} = \\mathbf{x}_i - \\mathbf{x}_j$ 的协方差函数。对于此问题，指定了一个各向同性指数协方差模型：\n$$\nC(h) = s^2 \\exp\\left(-\\frac{h}{a}\\right)\n$$\n其中 $h = \\|\\mathbf{h}\\|$ 是欧几里得距离，$s^2$ 是基台值（场的先验方差，$C(0)$），$a$ 是有效变程。此外，引入了块金效应 $\\tau^2$ 来解释测量误差和微尺度变异性。\n\n**普通克里金系统的推导**\n\n普通克里金法 (OK) 为未采样位置 $\\mathbf{x}_0$ 处的值 $Z(\\mathbf{x}_0)$ 提供了最佳线性无偏估计量 (BLUE)，其基于 $n$ 个观测值 $\\{z(\\mathbf{x}_1), \\dots, z(\\mathbf{x}_n)\\}$。该估计量 $\\hat{Z}(\\mathbf{x}_0)$ 是数据的线性组合：\n$$\n\\hat{Z}(\\mathbf{x}_0) = \\sum_{i=1}^{n} w_i z(\\mathbf{x}_i)\n$$\n\n该估计量旨在满足两个条件：无偏性和最小估计方差。\n\n1.  **无偏性**：估计误差的期望值必须为零。\n    $$\n    E[\\hat{Z}(\\mathbf{x}_0) - Z(\\mathbf{x}_0)] = 0\n    $$\n    代入估计量并使用平稳性假设 $E[Z(\\mathbf{x})] = m$：\n    $$\n    E\\left[\\sum_{i=1}^{n} w_i Z(\\mathbf{x}_i) - Z(\\mathbf{x}_0)\\right] = \\sum_{i=1}^{n} w_i E[Z(\\mathbf{x}_i)] - E[Z(\\mathbf{x}_0)] = \\sum_{i=1}^{n} w_i m - m = m\\left(\\sum_{i=1}^{n} w_i - 1\\right) = 0\n    $$\n    为使此式对任何未知均值 $m$ 都成立，权重的总和必须为一。这就是无偏性约束：\n    $$\n    \\sum_{i=1}^{n} w_i = 1\n    $$\n\n2.  **最小估计方差**：估计方差 $\\sigma_K^2 = \\text{Var}[\\hat{Z}(\\mathbf{x}_0) - Z(\\mathbf{x}_0)]$ 必须最小化。\n    $$\n    \\sigma_K^2(\\mathbf{x}_0) = \\text{Var}\\left(\\sum_{i=1}^{n} w_i Z(\\mathbf{x}_i) - Z(\\mathbf{x}_0)\\right)\n    $$\n    展开方差可得：\n    $$\n    \\sigma_K^2 = \\sum_{i=1}^{n} \\sum_{j=1}^{n} w_i w_j \\text{Cov}(Z(\\mathbf{x}_i), Z(\\mathbf{x}_j)) - 2\\sum_{i=1}^{n} w_i \\text{Cov}(Z(\\mathbf{x}_i), Z(\\mathbf{x}_0)) + \\text{Var}(Z(\\mathbf{x}_0))\n    $$\n    用矩阵表示法，此式为 $\\sigma_K^2 = \\mathbf{w}^T \\mathbf{C} \\mathbf{w} - 2\\mathbf{w}^T \\mathbf{c} + C_{00}$，其中：\n    -   $\\mathbf{C}$ 是数据点之间的 $n \\times n$ 协方差矩阵。其元素为 $C_{ij} = C(\\|\\mathbf{x}_i - \\mathbf{x}_j\\|) + \\tau^2 \\delta_{ij}$，其中块金效应 $\\tau^2$ 被加到对角线元素上（当 $i=j$ 时）。\n    -   $\\mathbf{c}$ 是数据点与目标位置之间的 $n \\times 1$ 协方差向量：$c_i = C(\\|\\mathbf{x}_i - \\mathbf{x}_0\\|)$。此处不包括块金效应。\n    -   $C_{00}$ 是目标位置的先验方差，即基台值 $s^2 = C(0)$。\n\n    为了在约束 $\\sum w_i = 1$ 下最小化 $\\sigma_K^2$，我们使用拉格朗日乘子法。目标函数为：\n    $$\n    \\mathcal{L}(\\mathbf{w}, \\lambda) = \\sigma_K^2 + 2\\lambda\\left(\\sum_{i=1}^{n} w_i - 1\\right)\n    $$\n    将关于每个 $w_k$ 的偏导数设为零，可得一组 $n$ 个方程：\n    $$\n    \\frac{\\partial\\mathcal{L}}{\\partial w_k} = 2 \\sum_{i=1}^{n} w_i C_{ik} - 2c_k + 2\\lambda = 0 \\quad \\implies \\quad \\sum_{i=1}^{n} w_i C_{ik} + \\lambda = c_k \\quad \\text{for } k=1, \\dots, n\n    $$\n    将这些方程与无偏性约束相结合，得到以下 $(n+1) \\times (n+1)$ 的线性系统，即普通克里金系统：\n    $$\n    \\begin{pmatrix}\n    C_{11} & \\cdots & C_{1n} & 1 \\\\\n    \\vdots & \\ddots & \\vdots & \\vdots \\\\\n    C_{n1} & \\cdots & C_{nn} & 1 \\\\\n    1 & \\cdots & 1 & 0\n    \\end{pmatrix}\n    \\begin{pmatrix}\n    w_1 \\\\\n    \\vdots \\\\\n    w_n \\\\\n    \\lambda\n    \\end{pmatrix}\n    =\n    \\begin{pmatrix}\n    c_1 \\\\\n    \\vdots \\\\\n    c_n \\\\\n    1\n    \\end{pmatrix}\n    \\quad \\text{or} \\quad\n    \\begin{pmatrix} \\mathbf{C} & \\mathbf{1} \\\\ \\mathbf{1}^T & 0 \\end{pmatrix}\n    \\begin{pmatrix} \\mathbf{w} \\\\ \\lambda \\end{pmatrix}\n    =\n    \\begin{pmatrix} \\mathbf{c} \\\\ 1 \\end{pmatrix}\n    $$\n    求解该系统可得到最优权重 $\\mathbf{w}$ 和拉格朗日乘子 $\\lambda$。然后，克里金估计值为 $\\hat{Z}(\\mathbf{x}_0) = \\mathbf{w}^T \\mathbf{z}$，其中 $\\mathbf{z}$ 是观测值向量。最小化的克里金方差由下式给出：\n    $$\n    \\sigma_K^2 = C_{00} - \\mathbf{w}^T\\mathbf{c} - \\lambda = s^2 - \\sum_{i=1}^{n} w_i c_i - \\lambda\n    $$\n\n**序贯高斯模拟 (SGS) 算法**\n\nSGS 依赖于多元高斯分布的一个基本性质：给定另一个变量子集，任意变量子集的条件分布也是高斯分布。对于一个高斯随机场，给定数据 $\\mathbf{z}$，未采样位置 $Z(\\mathbf{x}_0)$ 处值的条件分布是一个正态分布，其均值和方差恰好是普通克里金估计值 $\\hat{Z}_{OK}(\\mathbf{x}_0)$ 和克里金方差 $\\sigma_K^2(\\mathbf{x}_0)$。\n$$\nZ(\\mathbf{x}_0) | \\{\\mathbf{z}\\} \\sim \\mathcal{N}\\left(\\hat{Z}_{OK}(\\mathbf{x}_0), \\sigma_K^2(\\mathbf{x}_0)\\right)\n$$\nSGS 算法通过在未采样的网格节点中定义一条随机路径来进行。在每个节点，它使用所有可用的条件数据（原始测量值加上先前模拟的值）执行普通克里金法来定义条件分布。然后它从该分布中抽取一个值，并立即将其添加到条件数据集中，用于所有后续的估计。\n\n要实现的步骤如下：\n1.  使用观测到的位置和值初始化条件数据集。\n2.  遍历指定的目标位置路径。对于每个目标位置 $\\mathbf{x}_{0,j}$：\n    a. 使用当前包含 $n$ 个条件数据点（原始的和先前模拟的）的集合来构建普通克里金系统。这包括构建 $(n+1) \\times (n+1)$ 矩阵 $\\mathbf{A} = \\begin{pmatrix} \\mathbf{C} & \\mathbf{1} \\\\ \\mathbf{1}^T & 0 \\end{pmatrix}$ 和右侧向量 $\\mathbf{b} = \\begin{pmatrix} \\mathbf{c} \\\\ 1 \\end{pmatrix}$。\n    b. 求解系统 $\\mathbf{A} \\mathbf{x} = \\mathbf{b}$ 以获得权重 $\\mathbf{w}$ 和拉格朗日乘子 $\\lambda$。\n    c. 计算克里金均值 $\\hat{z}_{j} = \\mathbf{w}^T \\mathbf{z}$ 和方差 $\\sigma_{K,j}^2 = s^2 - \\mathbf{w}^T \\mathbf{c} - \\lambda$。如果由于数值精度问题导致 $\\sigma_{K,j}^2$ 为非正值，则将其裁剪为一个小的正值。\n    d. 从高斯分布 $\\mathcal{N}(\\hat{z}_{j}, \\sigma_{K,j}^2)$ 中抽取一个模拟值 $z_{\\text{sim},j}$。\n    e. 将数据对 $(\\mathbf{x}_{0,j}, z_{\\text{sim},j})$ 添加到条件数据集中，以用于后续步骤。\n3.  模拟值集合 $\\{z_{\\text{sim},j}\\}$ 构成了随机场在目标位置的一个实现。\n该实现将使用指定的随机种子，以确保从条件分布中抽样的可复现性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve as linsolve\n\ndef solve():\n    \"\"\"\n    Main function to run Sequential Gaussian Simulation for all test cases.\n    \"\"\"\n\n    def covariance_model(h, sill, range_val):\n        \"\"\"\n        Computes the exponential covariance for a given distance.\n        C(h) = s^2 * exp(-h/a)\n        \"\"\"\n        return sill * np.exp(-h / range_val)\n\n    def solve_sgs_case(data, targets, sill, range_val, nugget, seed):\n        \"\"\"\n        Performs Sequential Gaussian Simulation for a single test case.\n\n        Args:\n            data (list): List of tuples, where each tuple is ((x, y), value).\n            targets (np.ndarray): Array of target locations, shape (m, 2).\n            sill (float): The sill parameter of the covariance model.\n            range_val (float): The range parameter of the covariance model.\n            nugget (float): The nugget effect.\n            seed (int): The random seed for reproducibility.\n\n        Returns:\n            list: A list of simulated values at the target locations.\n        \"\"\"\n        rng = np.random.default_rng(seed)\n        \n        # Initialize conditioning data from the problem statement\n        if data:\n            cond_locs = np.array([d[0] for d in data])\n            cond_vals = np.array([d[1] for d in data])\n        else: # Handle case with no initial data if needed, though problem implies at least one\n            cond_locs = np.empty((0, 2))\n            cond_vals = np.empty(0)\n        \n        simulated_values = []\n\n        for target_loc in targets:\n            n = len(cond_locs)\n            \n            # --- 1. Construct the Ordinary Kriging system Ax = b ---\n            A = np.ones((n + 1, n + 1))\n            \n            # Data-to-data covariance matrix (top-left n x n block of A)\n            if n > 0:\n                dist_matrix_dd = np.linalg.norm(cond_locs[:, np.newaxis, :] - cond_locs[np.newaxis, :, :], axis=2)\n                C = covariance_model(dist_matrix_dd, sill, range_val)\n                np.fill_diagonal(C, C.diagonal() + nugget) # Add nugget to the diagonal\n                A[:n, :n] = C\n            \n            A[n, n] = 0.0  # Constraint part of the matrix\n\n            # Right-hand side vector b\n            b = np.ones(n + 1)\n            if n > 0:\n                # Data-to-target covariance vector\n                dist_vector_dt = np.linalg.norm(cond_locs - target_loc, axis=1)\n                c_vector = covariance_model(dist_vector_dt, sill, range_val)\n                b[:n] = c_vector\n            else:\n                c_vector = np.empty(0)\n            \n            # --- 2. Solve for kriging weights and Lagrange multiplier ---\n            try:\n                # The kriging matrix is symmetric but not necessarily positive definite\n                weights_and_mu = linsolve(A, b, assume_a='sym')\n            except np.linalg.LinAlgError:\n                # Fallback for singular matrix, although the nugget should prevent this\n                weights_and_mu = np.linalg.lstsq(A, b, rcond=None)[0]\n\n            weights = weights_and_mu[:n]\n            lagrange_mu = weights_and_mu[n]\n            \n            # --- 3. Compute kriging estimate (mean) and variance ---\n            kriging_mean = np.dot(weights, cond_vals) if n > 0 else 0.0 # Field mean is 0\n            kriging_var = sill - np.dot(weights, c_vector) - lagrange_mu\n            \n            # Clip variance to a small positive number if non-positive\n            if kriging_var = 1e-12:\n                kriging_var = 1e-9\n            \n            kriging_std = np.sqrt(kriging_var)\n            \n            # --- 4. Sample from the conditional Gaussian distribution ---\n            sim_val = rng.normal(loc=kriging_mean, scale=kriging_std)\n            simulated_values.append(sim_val)\n            \n            # --- 5. Update the conditioning set for the next step ---\n            cond_locs = np.vstack([cond_locs, target_loc])\n            cond_vals = np.append(cond_vals, sim_val)\n            \n        return simulated_values\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1\n        {\n            \"data\": [((0.0, 0.0), 0.2), ((50.0, 0.0), -0.1), ((0.0, 50.0), 0.3), ((50.0, 50.0), -0.2)],\n            \"targets\": [(25.0, 25.0), (30.0, 20.0)],\n            \"sill\": 1.0, \"range_val\": 40.0, \"nugget\": 0.05, \"seed\": 42\n        },\n        # Case 2\n        {\n            \"data\": [((0.0, 0.0), 1.0), ((100.0, 0.0), -1.0)],\n            \"targets\": [(10.0, 0.0), (90.0, 0.0)],\n            \"sill\": 1.0, \"range_val\": 5.0, \"nugget\": 0.2, \"seed\": 123\n        },\n        # Case 3\n        {\n            \"data\": [((10.0, 10.0), 0.5)],\n            \"targets\": [(12.0, 12.0), (40.0, 40.0)],\n            \"sill\": 1.0, \"range_val\": 20.0, \"nugget\": 0.5, \"seed\": 7\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        results = solve_sgs_case(\n            data=case[\"data\"],\n            targets=np.array(case[\"targets\"]),\n            sill=case[\"sill\"],\n            range_val=case[\"range_val\"],\n            nugget=case[\"nugget\"],\n            seed=case[\"seed\"]\n        )\n        all_results.extend(results)\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{val:.6f}\" for val in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}