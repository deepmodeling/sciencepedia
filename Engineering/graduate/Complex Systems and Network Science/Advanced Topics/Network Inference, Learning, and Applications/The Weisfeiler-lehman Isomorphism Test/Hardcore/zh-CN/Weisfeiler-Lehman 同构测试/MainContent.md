## 引言
[图同构问题](@entry_id:261854)——判断两个图是否在拓扑结构上完全相同——是[图论](@entry_id:140799)和[理论计算机科学](@entry_id:263133)中的一个基本挑战。尽管其精确的[计算复杂性](@entry_id:204275)尚不明确，但在实践中，我们需要高效且强大的方法来区分或匹配图结构。Weisfeiler-Lehman (WL) 测试正是在这一背景下应运而生的一种影响深远的[启发式算法](@entry_id:176797)。最初作为[图同构问题](@entry_id:261854)的工具，其核心思想——迭代式地聚合邻域信息以提炼结构特征——如今已远远超越其原始范畴，成为现代[图机器学习](@entry_id:1127557)和[网络分析](@entry_id:139553)的基石。

然而，对于这一强大工具的理解往往是碎片化的：理论研究者关注其代数性质和局限性，而实践者则更多地将其视为图神经网络（GNN）背后的“黑箱”理论或一个现成的图核函数。本文旨在弥合这一鸿沟，提供一个关于[WL测试](@entry_id:1134117)的系统性、综合性的论述。我们将揭示该测试不仅是一个算法，更是一种理解和量化图结构的通用框架。

为实现这一目标，本文组织如下：
- **第一章：原理与机制**，将深入剖析[WL测试](@entry_id:1134117)的核心，从基础的1-WL[颜色细化](@entry_id:1122664)算法出发，阐明其如何捕捉局部结构、与公平划分的联系，以及其能力的理论边界。我们还将探讨如何通过更高维的k-[WL测试](@entry_id:1134117)来构建一个[表达能力](@entry_id:149863)更强的层级结构。
- **第二章：应用与跨学科连接**，将展示[WL测试](@entry_id:1134117)的广泛影响力，重点阐述其作为衡量[GNN表达能力](@entry_id:1125692)上限的理论标尺，以及作为WL子树核在[计算化学](@entry_id:143039)、生物学等领域赋能图级别学习任务的实践。
- **第三章：动手实践**，将通过一系列精心设计的计算练习，引导您亲手操作WL算法，直观地感受其工作流程、能力和局限性，从而将理论知识内化为实践技能。

通过这三个章节的层层递进，读者将不仅掌握[WL测试](@entry_id:1134117)的“如何做”，更能深刻理解其“为什么”，从而在自己的研究和应用中更有效地运用这一经典而强大的工具。

## 原理与机制

在介绍了Weisfeiler-Lehman (WL)测试作为[图同构问题](@entry_id:261854)的一种强大[启发式方法](@entry_id:637904)之后，本章将深入探讨其核心原理与内在机制。我们将从最基础的一维WL算法（1-WL）出发，系统地剖析其操作流程、它所捕捉的图结构信息，以及其能力的理论边界。随后，我们将这一框架推广到更高维度的k-[WL测试](@entry_id:1134117)，并阐释由此形成的表达能力层级。最后，我们将讨论该测试如何应用于带有节点或边标签的更复杂的网络结构。

### 1-WL算法：一种[颜色细化](@entry_id:1122664)机制

最基础的[Weisfeiler-Lehman测试](@entry_id:1134117)，即 **1-WL**，通常也被称为 **[颜色细化](@entry_id:1122664) (color refinement)** 或 **朴素顶点分类 (naive vertex classification)**。它是一种迭代过程，通过为图中的每个顶点分配“颜色”（或标签）来捕捉其局部邻域的结构。如果两个图经过此过程后得到的最终颜色分布不同，那么它们必定不是同构的。反之，如果颜色分布相同，则它们可能是同构的，也可能不是——[WL测试](@entry_id:1134117)是一个必要非充分条件。

该算法的精确定义如下，对于一个有限、简单、无向且无标签的图 $G=(V, E)$ ：

1.  **初始化 (Initialization)**：在第 $t=0$ 步，由于图是无标签的，所有顶点在结构上最初被视为等同的。因此，我们为所有顶点 $v \in V$ 分配一个相同的初始颜色，记为 $c_0(v) = \alpha$。这对应于将顶点集 $V$ 划分为一个单一的颜色类。

2.  **迭代细化 (Iterative Refinement)**：在每一个后续步骤 $t \ge 0$ 中，每个顶点 $v$ 的颜色都会被更新。新的颜色 $c_{t+1}(v)$ 是通过一个[单射](@entry_id:183792)（injective）的[哈希函数](@entry_id:636237)（hash function）或编码函数，基于顶点当前自身的颜色 $c_t(v)$ 以及其所有邻居颜色的 **多重集 (multiset)** 来确定的。其更新规则可以形式化地写作：
    $$c_{t+1}(v) = \mathrm{hash}\Big(c_t(v), \{\!\{\,c_t(u) : u \in N(v)\,\}\!\} \Big)$$
    其中，$N(v)$ 是顶点 $v$ 的邻居集合，而 $\{\!\{\dots\}\!\}$ 表示一个多重集，它会记录每种邻居颜色出现的次数。例如，一个邻居颜色为 $\{\text{red}, \text{blue}, \text{blue}\}$ 的顶点的多重集与一个邻居颜色为 $\{\text{red}, \text{red}, \text{blue}\}$ 的顶点是不同的，而如果使用集合（set），这两者将被视为相同。使用多重集是至关重要的，因为它保留了关于邻域结构的定量信息，这是[WL测试](@entry_id:1134117)能力的关键来源。

3.  **终止 (Stabilization)**：当颜色的分配不再变化时，迭代过程终止。严格来说，稳定发生在某一步 $T$，当由颜色 $c_T$ 诱导的顶点划分与由 $c_{T+1}$ 诱导的划分相同时。这意味着，对于任意两个顶点 $v, w \in V$，当且仅当 $c_T(v) = c_T(w)$ 时，有 $c_{T+1}(v) = c_{T+1}(w)$。此时，任何现有的颜色类都不会在下一轮被进一步分裂。这个过程保证在至多 $|V|-1$ 轮迭代后终止。最终的输出是这个稳定的颜色分配 $c_T$（或等价地，由其诱导的顶点划分），以及图中每种最终颜色的计数（即颜色[直方图](@entry_id:178776)）。

如果两个图 $G$ 和 $H$ 经过1-[WL测试](@entry_id:1134117)后得到的稳定颜色直方图不同，我们就可以断定 $G$ 和 $H$ 是非同构的。

### WL颜色所蕴含的结构意义

虽然1-WL的机制看似简单，但它在迭代过程中聚合的颜色标签却蕴含着深刻的结构信息。我们可以从几个互补的角度来理解WL颜色究竟“计算”了什么。

#### 根植子树模式 (Rooted Subtree Patterns)

1-WL算法与图的局部子树结构之间有着紧密的联系 。在 $t$ 轮迭代之后，一个顶点 $v$ 的颜色 $c_t(v)$ 实际上唯一地编码了从 $v$ 出发、通过[广度优先搜索](@entry_id:156630)（BFS）展开得到的深度为 $t$ 的 **根植树 (rooted tree)** 的[同构类](@entry_id:147854)型。

我们可以通过归纳法来理解这一点：
-   **$t=0$**: 所有顶点的颜色 $c_0$都相同，这对应于深度为0的根植树（即一个单独的根节点），所有这样的树都是同构的。
-   **$t=1$**: $c_1(v)$ 的计算依赖于邻居的数量（即[顶点度数](@entry_id:264944)），因为所有邻居的颜色都是 $c_0$。因此，$c_1(v)$ 编码了[顶点的度](@entry_id:264944)数。这恰恰对应于深度为1的根植树的[同构类](@entry_id:147854)型，该树由一个根和 $\deg(v)$ 个叶子节点组成。
-   **$t \to t+1$**: 假设在第 $t$ 轮，每个顶点 $u$ 的颜色 $c_t(u)$ 已经编码了其深度为 $t$ 的根植[BFS树](@entry_id:263690) $T_u^t$ 的[同构类](@entry_id:147854)型。在第 $t+1$ 轮，顶点 $v$ 的新颜色 $c_{t+1}(v)$ 是由 $c_t(v)$（编码了 $T_v^t$）和其邻居颜色 $c_t(u)$ 的多重集（编码了其邻居的 $T_u^t$ 树的[同构类](@entry_id:147854)型）决定的。这恰好是构建深度为 $t+1$ 的根植树 $T_v^{t+1}$ 所需的信息：一个根（$v$），其下的子树正是其邻居的深度为 $t$ 的根植树。

因此，1-WL算法的[颜色细化](@entry_id:1122664)过程本质上是在并行地、自底向上地为图中每个顶点构建并编码其越来越大的根植邻域树。在许多稀疏的[复杂网络](@entry_id:261695)中，局部结构是树状的，因此，WL颜色能够有效地捕捉和压缩这些局部结构基序（motifs）。

#### 公平划分与商图 (Equitable Partitions and Quotient Graphs)

从[代数图论](@entry_id:274338)的角度看，1-WL算法的稳定划分具有一个重要的性质，即它是一个 **公平划分 (equitable partition)** 。

一个对顶点集 $V$ 的划分 $\Pi = \{C_1, C_2, \dots, C_m\}$ 被称为公平的，如果对于任意两个在同一划分块 $C_i$ 中的顶点 $u, v \in C_i$，以及对于任意一个划分块 $C_j \in \Pi$，顶点 $u$ 在 $C_j$ 中的邻居数量与顶点 $v$ 在 $C_j$ 中的邻居数量完全相同。也就是说，$|N(u) \cap C_j| = |N(v) \cap C_j|$。

这个定义精确地描述了1-WL算法达到稳定状态时的条件。当划分稳定时，同一颜色类中的所有顶点必须拥有完全相同的邻居颜色多重集，这意味着它们在任何其他颜色类中都必须有相同数量的邻居。反之，如果一个划分已经是公平的，那么1-WL的迭代过程将不会再对其进行细分，因为同一划分块中所有顶点的更新信息都是相同的。

一个关键的理论结果是：从一个初始划分 $\Pi_0$ 开始，1-WL算法计算出的稳定划分 $\Pi^*$ 是 **所有细化 $\Pi_0$ 的公平划分中最粗糙的一个 (the coarsest equitable partition refining $\Pi_0$)**。当从未标记图的均匀颜色初始化开始时，1-WL找到的是图本身最粗糙的非平凡公平划分。

基于这个稳定的公平划分 $\Pi^*=\{C_1, \dots, C_m\}$，我们可以构建一个 **WL商图 (quotient graph)** $Q(G)$ 。这个商图提供了一个压缩的、但保留了重要结构信息[网络表示](@entry_id:752440)：
-   $Q(G)$ 的顶点是 $\Pi^*$ 中的颜色类 $\{C_1, \dots, C_m\}$。
-   对于每对有序的颜色类 $(C_i, C_j)$，在 $Q(G)$ 中存在一条从 $C_i$ 到 $C_j$ 的有向边，其权重（或标签）为 $a_{ij} = |N(v) \cap C_j|$，其中 $v$ 是 $C_i$中的任意一个顶点。由于 $\Pi^*$ 是公平划分，这个计数值 $a_{ij}$ 对于 $C_i$ 中所有顶点的选择都是恒定的，因此是良定义的。

这个商图 $Q(G)$ 本身是一个[图同构](@entry_id:143072)不变量。如果两个图 $G$ 和 $H$ 是同构的，那么它们的WL商图（作为带权重的有向图）也必然是同构的。

### 代数与群论视角

[WL测试](@entry_id:1134117)的能力和局限性也可以通过更抽象的代数和群论语言来理解。

#### [自同构群](@entry_id:139672)轨道 (Automorphism Orbits)

一个图的 **[自同构](@entry_id:155390) (automorphism)** 是一个保持邻接关系的顶点置换。所有[自同构](@entry_id:155390)组成的群 $\mathrm{Aut}(G)$ 捕捉了[图的对称性](@entry_id:178762)。在该群的作用下，顶点集 $V$ 会被划分为若干 **轨道 (orbits)**。同一轨道中的顶点在结构上是完[全等](@entry_id:273198)价的，因为总能找到一个图的[对称变换](@entry_id:144406)将其中一个顶点映到另一个。

轨道的划分总是公平的。根据前述结论，1-WL产生的划分是最粗糙的公平划分，因此 **1-WL的稳定划分总是比轨道划分更粗糙（或相等）** 。这意味着，如果两个顶点在结构上是等价的（在同一轨道中），那么1-[WL测试](@entry_id:1134117)一定无法将它们区分开。

在某些情况下，WL划分与轨道划分是完全一致的。例如，对于 **[顶点传递图](@entry_id:139202) (vertex-transitive graphs)**，图中所有顶点都在同一个轨道中。1-[WL测试](@entry_id:1134117)在[正则图](@entry_id:265877)（[顶点传递图](@entry_id:139202)必然是正则的）上会立即稳定到单一颜色，正确地反映了所有顶点的等价性。对于[路径图](@entry_id:274599) $P_n$ 这样的非[正则图](@entry_id:265877)，1-WL的颜色会从两端向中间传播，最终产生的颜色类恰好是其[自同构群](@entry_id:139672)（只有一个[反射对称](@entry_id:1130776)）的轨道，即 $\{1, n\}, \{2, n-1\}, \dots$ 。

#### 分数阶同构 (Fractional Isomorphism)

1-[WL测试](@entry_id:1134117)与一个称为 **分数阶同构 (fractional isomorphism)** 的概念有着令人惊讶的[等价关系](@entry_id:138275) [@problem_id:4S11884]。图 $G$ 和 $H$ 之间的同构可以由一个[置换矩阵](@entry_id:136841) $P$ 来表示，满足 $PA_G = A_H P$，其中 $A_G$ 和 $A_H$ 是邻接矩阵。分数阶同构是对这一概念的松弛。

如果存在一个 **[双随机矩阵](@entry_id:1123952) (doubly stochastic matrix)** $X$（即[矩阵元](@entry_id:186505)素非负，且每行每列之和均为1），使得 $X A_G = A_H X$，那么我们称图 $G$ 和 $H$ 是分数阶同构的 。

一个深刻的定理指出：**两个图在1-[WL测试](@entry_id:1134117)下不可区分，当且仅当它们是分数阶同构的** 。

这个[等价关系](@entry_id:138275)为我们提供了理解1-WL局限性的代数工具。由于[置换矩阵](@entry_id:136841)的集合是[双随机矩阵](@entry_id:1123952)集合的一个[真子集](@entry_id:152276)，所以[图同构](@entry_id:143072)是比分数阶同构更强的条件。

### 1-WL的局限性：为何它不是一个完备的测试

1-[WL测试](@entry_id:1134117)之所以强大，在于它能在[多项式时间](@entry_id:263297)内运行，并区分大量的[非同构图](@entry_id:274028)。然而，它并非一个完备的[图同构](@entry_id:143072)测试。存在许多非同构的图，1-WL无法将它们区分开。

最经典的例子是 **[强正则图](@entry_id:269473) (Strongly Regular Graphs, SRGs)** 。一个图被称为参数为 $(n, k, \lambda, \mu)$ 的[强正则图](@entry_id:269473)，如果它是一个有 $n$ 个顶点的 $k$-[正则图](@entry_id:265877)，其中任意两个相邻顶点恰有 $\lambda$ 个共同邻居，任意两个不相邻顶点恰有 $\mu$ 个共同邻居。

由于SRG是 $k$-正则的，正如我们之前分析的，1-WL从均匀初始化开始，会立即稳定到单一颜色。算法完全无法利用到定义SRG的更精细的结构信息（即 $\lambda$ 和 $\mu$ 的值）。因此，**任何两个具有相同参数 $(n, k)$ 的非同构SRG，对于1-[WL测试](@entry_id:1134117)来说都是不可区分的**。例如，著名的Shrikhande图和 $4 \times 4$  rook's graph（也称为Lattice graph L2(4)）都是参数为 $(16, 6, 2, 2)$ 的SRG，但它们并[非同构图](@entry_id:274028)。1-[WL测试](@entry_id:1134117)无法分辨它们。这直接对应于分数阶同构弱于[图同构](@entry_id:143072)的事实 。

### k-WL层级：推广与表达能力的提升

1-WL的局限性促使研究者们思考如何增强其判别能力。一个自然的想法是，不仅仅考虑单个顶点，而是考虑顶点的元组。这引出了更高维度的 **k-[WL测试](@entry_id:1134117)**。

#### k-WL算法的定义

对于整数 $k \ge 2$，k-WL算法在 $k$-元顶点元组的集合 $V^k$上进行[颜色细化](@entry_id:1122664) 。
1.  **初始化**：对每个 $k$-元组 $\mathbf{v} = (v_1, \dots, v_k) \in V^k$，其初始颜色 $\chi_0(\mathbf{v})$ 由该元组的 **原子类型 (atomic type)** 决定。原子类型描述了元组内部的[等价关系](@entry_id:138275)和邻接关系，即对于任意 $i, j \in \{1, \dots, k\}$，$v_i$ 是否等于 $v_j$，以及 $(v_i, v_j)$ 是否是图中的一条边。所有具有相同原子类型的元组获得相同的初始颜色。
2.  **迭代细化**：在第 $t$ 步，元组 $\mathbf{v}$ 的新颜色 $\chi_{t+1}(\mathbf{v})$ 是通过一个编码函数，基于其当前颜色 $\chi_t(\mathbf{v})$ 以及其“邻域”中所有元组的颜色信息来确定的。这里的“邻域”定义得非常精巧：对于元组 $\mathbf{v}$ 的每一个坐标 $i \in \{1, \dots, k\}$，我们用图中 *所有* 顶点 $u \in V$ 来替换 $v_i$，得到新的元组 $\mathbf{v}[i \leftarrow u]$。k-WL的更新规则聚合了所有这些替换所产生的元组的颜色。形式上：
    $$\chi_{t+1}(\mathbf{v}) = \mathrm{encode}\Big(\chi_t(\mathbf{v}),\ \{\!\{\, (i,\ \chi_t(\mathbf{v}[i \leftarrow u]))\ :\ i \in \{1,\dots,k\},\ u \in V\, \}\!\} \Big)$$
    这个更新规则通过考察 $k$ 个顶点与图中其他所有顶点之间的关系，来同步更新这 $k$ 个顶点的联合状态，从而能够捕捉更高阶的结构信息。

#### [表达能力](@entry_id:149863)的严格层级

通过增加维度 $k$，[WL测试](@entry_id:1134117)的判别能力也随之增强。如果两个图能被 $(k-1)$-WL区分，那么它们也一定能被 $k$-WL区分。一个更重要且不平凡的结果是，这个能力层级是 **严格的 (strict)** 。

由Cai、Fürer和Immerman证明的一个里程碑式的定理表明：**对于任意 $k \ge 2$，k-[WL测试](@entry_id:1134117)严格比 $(k-1)$-[WL测试](@entry_id:1134117)更强大**。这意味着，对于任何 $k$，都存在一对非同构的图，它们对于所有维度直到 $(k-1)$ 的[WL测试](@entry_id:1134117)都是不可区分的，但 $k$-[WL测试](@entry_id:1134117)却能够成功地将它们区分开。

其深层原因在于，$k$-元组的颜色能够编码涉及 $k$ 个变量的逻辑谓词。有些图的结构属性（例如，某种偶校验或线性方程组解的存在性）被巧妙地编码在图中，这些属性需要同时关联 $k$ 个顶点才能被检测到，而任何只使用 $k-1$ 个“探针”的方法（如 $(k-1)$-WL）都无法发现这种全局关联。

尽管如此，这个层级并不会在某个有限的 $k$ 值处“塌缩”到能够解决所有[图同构问题](@entry_id:261854)。也就是说，不存在一个固定的 $k$，使得 $k$-WL能够区分所有非同构的图。[图同构问题](@entry_id:261854)是否在[多项式时间](@entry_id:263297)内可解，至今仍是[理论计算机科学](@entry_id:263133)中一个未决的重大问题。

### 对带标签图的扩展

在许多实际应用中，网络中的节点和边都带有标签（或称属性），例如在社交网络中节点代表用户，标签可以是其所在城市；在[蛋白质相互作用网络](@entry_id:273576)中，边的标签可以代表相互作用的类型。WL框架可以很自然地扩展以处理这些信息 。

-   **带顶点标签的图**：最简单的扩展是在初始化步骤。我们不再将所有顶点初始化为同一颜色，而是直接使用它们的 **类别标签作为初始颜色**。后续的迭代 refinement 过程保持不变。当然，此时的[图同构](@entry_id:143072)定义也需要加强，不仅要求保持邻接关系，还要求同构映射 $f$ 保持顶点标签，即 $\ell_G(u) = \ell_H(f(u))$。

-   **带边标签的图**：当边也带有标签时，我们需要修改迭代更新规则。在聚合邻居颜色时，需要将连接边上的标签也考虑进去。例如，更新规则可以变为聚合形如 $(\lambda_G(\{u, v\}), c_t(v))$ 的二元组，其中 $\lambda_G(\{u, v\})$ 是连接 $u$ 和 $v$ 的边的标签。这使得算法能够区分一个连接到“蓝色”邻居的“友谊”边和一个同样连接到“蓝色”邻居的“家庭”边。

-   **标签的语义**：在处理标签时，还需注意标签的语义。如果标签是可重命名的（名义上的），那么同构的概念可能需要进一步放宽，允许在比较图结构之前对标签进行一个全局的置换。在这种情况下，直接使用原始标签进行[WL测试](@entry_id:1134117)可能会导致因标签命名不一致而产生的假阴性结果 。

总而言之，[Weisfeiler-Lehman测试](@entry_id:1134117)提供了一个从基础到高级、兼具理论深度与实践价值的框架。它不仅是理解[图同构问题](@entry_id:261854)的关键工具，也为现代[图机器学习](@entry_id:1127557)方法，如[图神经网络](@entry_id:136853)（GNNs），的[表达能力](@entry_id:149863)上限提供了理论基础。