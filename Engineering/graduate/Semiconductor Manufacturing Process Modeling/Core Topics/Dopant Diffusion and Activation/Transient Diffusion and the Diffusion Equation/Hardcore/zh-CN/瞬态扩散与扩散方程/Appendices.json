{
    "hands_on_practices": [
        {
            "introduction": "解决扩散问题通常需要处理边界，例如硅片的表面。第一个练习将介绍强大的镜像法，这是一种经典的解析技术，用于求解具有零通量（反射）边界的半无限域中的扩散方程 。掌握此方法对于模拟预沉积掺杂层的推进等场景至关重要，在这些场景中，掺杂剂的总量是守恒的。",
            "id": "4176713",
            "problem": "一个用于半无限硅衬底（占据半直线 $x \\geq 0$）在等温退火过程中掺杂剂再分布的一维模型。掺杂剂浓度 $C(x,t)$ 在退火温度下根据菲克第二定律演化，其扩散系数 $D$ 为常数。表面 $x=0$ 处被覆盖以防止向外扩散，从而形成零通量边界。在时间 $t=0$ 时，一次离子注入在深度 $x_{s}  0$ 处产生一个窄的掺杂剂薄层，其总面剂量为 $Q$（原子/单位面积），这在法线方向上被建模为狄拉克δ分布。假设 $D$ 是恒定且均匀的，并忽略任何团簇、偏析或电场效应。\n\n从菲克第二定律和通量的定义出发，仅使用基本原理和镜像法，推导在 $x \\geq 0$ 和 $t  0$ 范围内满足以下条件的浓度 $C(x,t)$ 的显式闭合形式表达式：\n- 扩散方程 $\\partial C/\\partial t = D\\,\\partial^{2} C/\\partial x^{2}$，\n- 零通量边界条件 $\\left.\\partial C/\\partial x\\right|_{x=0} = 0$，\n- 初始条件 $C(x,0) = Q\\,\\delta(x - x_{s})$，\n- 以及在任何固定 $t0$ 时，当 $x \\to \\infty$ 时 $C(x,t) \\to 0$ 的远场条件。\n\n请用 $Q$、$D$、$x_{s}$、$x$ 和 $t$ 表示您的最终答案，形式为一个单一的闭合形式解析表达式。无需进行数值取整。所有符号必须明确定义并与上述描述一致。",
            "solution": "该问题要求推导在半无限硅衬底（$x \\geq 0$）中经历瞬态扩散的掺杂剂浓度分布 $C(x,t)$。该过程由一组明确定义的物理和数学条件所控制。\n\n首先，我们将问题陈述形式化。掺杂剂浓度 $C(x,t)$ 必须满足一维扩散方程，也称为菲克第二定律：\n$$\n\\frac{\\partial C}{\\partial t} = D \\frac{\\partial^2 C}{\\partial x^2} \\quad \\text{for } x  0, t  0\n$$\n其中 $D$ 是恒定的掺杂剂扩散系数。\n\n边界条件和初始条件如下：\n1.  在表面 $x=0$ 处的零通量边界条件。掺杂剂通量 $J$ 由菲克第一定律给出，$J = -D \\frac{\\partial C}{\\partial x}$。因此，零通量条件意味着垂直于边界的浓度梯度为零：\n    $$\n    \\left. J \\right|_{x=0} = -D \\left. \\frac{\\partial C}{\\partial x} \\right|_{x=0} = 0 \\implies \\left. \\frac{\\partial C}{\\partial x} \\right|_{x=0} = 0 \\quad \\text{for } t  0\n    $$\n    这是一个诺伊曼（Neumann）边界条件。\n\n2.  在时间 $t=0$ 时的初始条件，表示在深度 $x_s  0$ 处注入的总面剂量为 $Q$ 的窄掺杂剂薄层。这在数学上被建模为狄拉克δ函数：\n    $$\n    C(x,0) = Q \\, \\delta(x - x_s) \\quad \\text{for } x \\geq 0\n    $$\n\n3.  远场条件，即浓度在远离源的地方趋于零：\n    $$\n    \\lim_{x \\to \\infty} C(x,t) = 0 \\quad \\text{for } t  0\n    $$\n\n解决此初边值问题的指定方法是镜像法。该方法通过在非物理区域（$x  0$）添加一个虚构的“镜像”源，将问题从半无限域（$x \\geq 0$）扩展到无限域（$-\\infty  x  \\infty$）。选择此镜像源的属性（位置和强度），使得在整个无限域中的解能自动满足在 $x=0$ 处的边界条件。\n\n在一维无限域中，对于位于 $x=x_s$ 处强度为 $Q$ 的点源初始条件，即 $C(x,0) = Q\\,\\delta(x - x_s)$，扩散方程的基本解是一个高斯函数：\n$$\nC_{\\text{source}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right)\n$$\n该函数表示初始掺杂剂薄层随时间的扩散。\n\n为了满足在 $x=0$ 处的零通量（诺伊曼）边界条件，我们必须放置一个镜像源，其产生的浓度分布的梯度与真实源的梯度相加后，在 $x=0$ 处为零。对于 $x=0$ 处的诺伊曼条件，合适的镜像源是位于镜像位置 $x = -x_s$ 处的一个符号和大小均相同的镜像。因此，我们放置一个初始分布为 $Q\\,\\delta(x + x_s)$ 的镜像源。\n\n在无限域中，这个镜像源的解是：\n$$\nC_{\\text{image}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x - (-x_s))^2}{4Dt}\\right) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right)\n$$\n根据叠加原理，无限域中的总解 $C_{\\text{full}}(x,t)$ 是真实源和镜像源的解之和：\n$$\nC_{\\text{full}}(x,t) = C_{\\text{source}}(x,t) + C_{\\text{image}}(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\n我们现在必须验证这个构造的解是否满足在 $x=0$ 处的零通量边界条件。我们计算 $C_{\\text{full}}$ 对 $x$ 的偏导数：\n$$\n\\frac{\\partial C_{\\text{full}}}{\\partial x} = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\frac{-2(x - x_s)}{4Dt} \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + \\frac{-2(x + x_s)}{4Dt} \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\n$$\n\\frac{\\partial C_{\\text{full}}}{\\partial x} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ (x - x_s) \\exp\\left(-\\frac{(x - x_s)^2}{4Dt}\\right) + (x + x_s) \\exp\\left(-\\frac{(x + x_s)^2}{4Dt}\\right) \\right]\n$$\n在 $x=0$ 处计算此导数：\n$$\n\\left. \\frac{\\partial C_{\\text{full}}}{\\partial x} \\right|_{x=0} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ (0 - x_s) \\exp\\left(-\\frac{(-x_s)^2}{4Dt}\\right) + (0 + x_s) \\exp\\left(-\\frac{(x_s)^2}{4Dt}\\right) \\right]\n$$\n$$\n\\left. \\frac{\\partial C_{\\text{full}}}{\\partial x} \\right|_{x=0} = -\\frac{Q}{2Dt\\sqrt{4\\pi Dt}} \\left[ -x_s \\exp\\left(-\\frac{x_s^2}{4Dt}\\right) + x_s \\exp\\left(-\\frac{x_s^2}{4Dt}\\right) \\right] = 0\n$$\n边界条件得到满足。物理域 $x \\geq 0$ 的解 $C(x,t)$ 是 $C_{\\text{full}}(x,t)$ 在该域上的限制。远场和初始条件也通过这种构造得到满足。物理域中的总掺杂剂量 $\\int_0^\\infty C(x,t) dx$ 是守恒的，并且对于所有 $t > 0$ 始终等于 $Q$，这与无通量边界是一致的。\n\n因此，浓度分布的最终表达式为：\n$$\nC(x,t) = \\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x-x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x+x_s)^2}{4Dt}\\right) \\right]\n$$\n适用于 $x \\geq 0$ 和 $t > 0$。",
            "answer": "$$\n\\boxed{\\frac{Q}{\\sqrt{4\\pi Dt}} \\left[ \\exp\\left(-\\frac{(x-x_s)^2}{4Dt}\\right) + \\exp\\left(-\\frac{(x+x_s)^2}{4Dt}\\right) \\right]}\n$$"
        },
        {
            "introduction": "虽然常数扩散系数模型具有指导意义，但现实世界中的扩散系数通常依赖于掺杂剂浓度本身，从而导致非线性问题。本练习通过引入线性化技术来处理这种复杂性，这是数学物理学中的一个基本工具 。通过分析围绕恒定背景浓度的微小扰动，您将推导出一个有效的线性扩散系数，从而深入理解如何近似和把握非线性效应。",
            "id": "4176728",
            "problem": "在晶体硅中的高剂量硼驱入扩散过程中，高温下的主导机制涉及硼-自填隙原子对。设硅中包含一个硼浓度场 $C(x,t)$，并假设硼-填隙原子对的浓度 $C_{p}(x,t)$ 与硼浓度和一个归一化的、依赖于硼的点缺陷因子 $H(C)$ 的乘积成正比，该因子捕捉了局部的电荷态和缺陷平衡。在等温条件下，对扩散率 $D_{p}$ 被认为是与 $C$ 无关的。硼通量由对通量给出，该通量遵循应用于对浓度的菲克第一定律，因此硼的守恒可表示为\n$$\n\\frac{\\partial C}{\\partial t} \\;=\\; \\frac{\\partial}{\\partial x}\\!\\left[D_{p}\\,\\frac{\\partial}{\\partial x}\\!\\big(H(C)\\,C\\big)\\right].\n$$\n定义复合扩散率 $D(C)\\equiv D_{p}\\,H(C)$，从而精确的非线性扩散方程具有守恒形式\n$$\n\\frac{\\partial C}{\\partial t} \\;=\\; \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big).\n$$\n考虑一个空间均匀的背景浓度 $C_{0}0$ 和一个小扰动 $\\tilde{C}(x,t)$，使得 $C(x,t)=C_{0}+\\tilde{C}(x,t)$ 并且对于所有的 $x$ 和 $t$ 都有 $|\\tilde{C}|\\ll C_{0}$。从质量守恒的陈述和上述本构关系出发，对均匀状态进行关于 $\\tilde{C}$ 及其空间导数的一阶展开。\n\n推导 $\\tilde{C}(x,t)$ 的线性化演化方程，证明它具有带有有效常数扩散系数的线性扩散方程形式，并确定此有效线性扩散系数的解析表达式，用 $D(C_{0})$、$D'(C_{0})$ 和 $C_{0}$ 表示，其中 $D'(C)$ 表示 $D$ 对其自变量 $C$ 的导数。\n\n你的最终答案必须是有效扩散系数的单一闭式解析表达式。不要在最终答案中提供中间步骤。不需要进行数值计算，答案框中也不应报告单位。",
            "solution": "该问题要求从给定的守恒形式的非线性扩散方程出发，推导关于均匀背景浓度 $C_0$ 的小扰动 $\\tilde{C}(x,t)$ 的线性化扩散方程。目标是确定此线性化方程中的有效扩散系数。\n\n总硼浓度 $C(x,t)$ 的控制方程如下：\n$$\n\\frac{\\partial C}{\\partial t} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big)\n$$\n其中 $D(C)$ 是一个依赖于浓度的复合扩散率。\n\n我们考虑在一个恒定、均匀的背景浓度 $C_0  0$ 周围的一个小扰动 $\\tilde{C}(x,t)$。因此，总浓度可以写为：\n$$\nC(x,t) = C_{0} + \\tilde{C}(x,t)\n$$\n其中假设对于所有位置 $x$ 和时间 $t$，都有 $|\\tilde{C}(x,t)| \\ll C_{0}$。我们将 $C(x,t)$ 的这个表达式代入控制偏微分方程。\n\n我们首先分析方程的左侧（LHS）：\n$$\n\\text{LHS} = \\frac{\\partial C}{\\partial t} = \\frac{\\partial}{\\partial t}\\left(C_{0} + \\tilde{C}(x,t)\\right)\n$$\n由于 $C_0$ 是一个常数，其时间导数为零。因此，LHS 简化为：\n$$\n\\text{LHS} = \\frac{\\partial \\tilde{C}}{\\partial t}\n$$\n\n接下来，我们分析方程的右侧（RHS）：\n$$\n\\text{RHS} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\big(D(C)\\,C\\big)\n$$\n代入 $C = C_0 + \\tilde{C}$：\n$$\n\\text{RHS} = \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left(D(C_{0} + \\tilde{C})\\,(C_{0} + \\tilde{C})\\right)\n$$\n二阶空间导数的参数，即项 $D(C)C$，是 $C$ 的一个非线性函数。为了线性化该方程，我们对该项在 $C = C_0$ 附近进行泰勒级数展开，并仅保留小扰动 $\\tilde{C}$ 的一阶项。我们定义函数 $F(C) = D(C)C$。其展开式为：\n$$\nF(C) = F(C_{0} + \\tilde{C}) \\approx F(C_0) + F'(C_0)\\tilde{C}\n$$\n其中 $F'(C_0)$ 是 $F(C)$ 对 $C$ 的导数在 $C = C_0$ 处的值。\n\n我们使用乘法法则计算导数 $F'(C)$：\n$$\nF'(C) = \\frac{d}{dC}\\big(D(C)C\\big) = \\frac{dD}{dC} \\cdot C + D(C) \\cdot 1 = D'(C)C + D(C)\n$$\n在 $C = C_0$ 处计算此导数得到：\n$$\nF'(C_0) = D'(C_0)C_0 + D(C_0)\n$$\n将此结果代回 $F(C)$ 的泰勒展开式，我们得到：\n$$\nD(C)C \\approx D(C_0)C_0 + \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C}\n$$\n\n现在，我们将这个线性化的表达式代回控制方程的 RHS：\n$$\n\\text{RHS} \\approx \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( D(C_0)C_0 + \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C} \\right)\n$$\n项 $D(C_0)C_0$ 是一个关于空间 $x$ 和时间 $t$ 的常数。因此，它的二阶空间导数为零：\n$$\n\\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( D(C_0)C_0 \\right) = 0\n$$\n因此，RHS 简化为：\n$$\n\\text{RHS} \\approx \\frac{\\partial^{2}}{\\partial x^{2}}\\!\\left( \\left[ D(C_0) + C_0D'(C_0) \\right]\\tilde{C} \\right)\n$$\n系数 $\\left[ D(C_0) + C_0D'(C_0) \\right]$ 是一个常数，因为 $C_0$ 是常数，且 $D$ 和 $D'$ 是在 $C_0$ 处求值的。作为一个常数系数，它可以从空间导数中提出来：\n$$\n\\text{RHS} \\approx \\left[ D(C_0) + C_0D'(C_0) \\right] \\frac{\\partial^{2}\\tilde{C}}{\\partial x^{2}}\n$$\n\n最后，我们将线性化的 LHS 和 RHS 相等，得到扰动 $\\tilde{C}(x,t)$ 的演化方程：\n$$\n\\frac{\\partial \\tilde{C}}{\\partial t} = \\left[ D(C_0) + C_0D'(C_0) \\right] \\frac{\\partial^{2}\\tilde{C}}{\\partial x^{2}}\n$$\n这个方程是关于 $\\tilde{C}(x,t)$ 的线性偏微分方程。它具有线性扩散方程的标准形式：\n$$\n\\frac{\\partial u}{\\partial t} = D_{\\text{eff}} \\frac{\\partial^{2}u}{\\partial x^{2}}\n$$\n通过将我们推导出的 $\\tilde{C}$ 方程与此标准形式进行比较，我们可以确定有效扩散系数 $D_{\\text{eff}}$。\n\n有效线性扩散系数是乘以扰动的二阶空间导数的常数项。因此，我们有：\n$$\nD_{\\text{eff}} = D(C_0) + C_0D'(C_0)\n$$\n此表达式仅依赖于背景浓度 $C_0$ 以及在 $C_0$ 处求值的扩散率函数 $D(C)$ 及其导数的性质，符合题目要求。",
            "answer": "$$\n\\boxed{D(C_{0}) + C_{0}D'(C_{0})}\n$$"
        },
        {
            "introduction": "对于许多涉及复杂几何形状或空间变化的材料特性的实际问题，解析解是不可能得到的。这最后一个练习将引导您从解析理论走向计算实践，通过指导您实现一个保守的有限体积法（FVM）。您将学习如何对具有位置依赖性扩散系数的扩散方程进行离散化，为隐式时间步进方案组装系统矩阵，并验证离散剂量守恒这一关键属性，为创建专业级工艺模拟器奠定基础。",
            "id": "4176749",
            "problem": "考虑半导体晶圆在热处理过程中的一维掺杂剂扩散，该过程在具有零通量边界的有限区间上建模。其物理基础是菲克第二定律 (Fick's second law)，在一维空间且扩散系数随空间变化的情况下，这是一个偏微分方程\n$$\n\\frac{\\partial C(x,t)}{\\partial t} = \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right),\n$$\n其中 $C(x,t)$ 是掺杂剂浓度，单位为 $\\mathrm{m}^{-3}$；$x$ 是位置，单位为 $\\mathrm{m}$；$t$ 是时间，单位为 $\\mathrm{s}$；$D(x)$ 是扩散系数，单位为 $\\mathrm{m}^2/\\mathrm{s}$。零通量边界条件要求通量 $J(x,t) = -D(x)\\,\\partial C/\\partial x$ 在所有时间 $t$ 都满足 $J(0,t) = 0$ 和 $J(L,t) = 0$，其中 $L$ 是晶圆厚度，单位为 $\\mathrm{m}$。\n\n您的任务是使用界面电导 (interface conductances) 实现一维空间算子 $\\nabla\\cdot(D\\nabla C)$ 的保守有限体积法 (conservative finite volume method (FVM)) 离散化，并使用全隐式后向欧拉格式 (fully implicit backward Euler scheme) 对解进行时间推进。您必须从高斯散度定理 (divergence theorem) 和菲克定律 (Fick's law) 出发，从第一性原理推导出适当的界面电导，并确保在零通量边界条件下，所得到的格式在剂量（单位横截面积的总掺杂剂）意义上是保守的。您还必须通过数学解释和计算演示，证明所有测试用例的离散剂量守恒性。\n\n定义和要求：\n- 设域为 $[0,L]$，其中 $L$ 的单位为 $\\mathrm{m}$，划分为 $N$ 个控制体（单元），其中心为 $x_i$，宽度为 $\\Delta x_i$，其中 $i=1,\\dots,N$。设横截面积为单位1，则单元体积为 $V_i = \\Delta x_i$。\n- 每个控制体的半离散守恒律 (semi-discrete conservation law) 必须具有以下形式\n$$\nV_i\\,\\frac{d C_i(t)}{dt} = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t),\n$$\n其中 $F_{i+\\frac{1}{2}}$ 表示穿过单元 $i$ 右侧界面的扩散通量，其定义与菲克定律一致。您必须根据界面电导和相邻单元浓度，推导出 $F_{i+\\frac{1}{2}}$ 的一致表达式。\n- 时间离散化必须使用后向欧拉法 (backward Euler)：\n$$\nV_i\\left(C_i^{n+1} - C_i^n\\right) = \\Delta t \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right),\n$$\n其中时间步长 $\\Delta t$ 的单位为 $\\mathrm{s}$。\n\n证明要求：\n- 从半离散守恒律出发，证明在零通量边界条件下，后向欧拉更新保持离散剂量 (discrete dose)\n$$\nQ^n = \\sum_{i=1}^N V_i\\,C_i^n,\n$$\n守恒，即证明在精确算术假设下，$Q^{n+1} = Q^n$ 对所有时间步都成立。\n\n实现要求：\n- 使用根据单元中心扩散系数 $D_i = D(x_i)$ 计算的界面电导实现一维离散化。该方法对于空间变化的 $D(x)$ 和非均匀网格必须是保守且一致的。\n- 组装隐式更新的矩阵形式\n$$\n\\left(\\mathbf{M} - \\Delta t\\,\\mathbf{A}\\right)\\,\\mathbf{C}^{n+1} = \\mathbf{M}\\,\\mathbf{C}^n,\n$$\n其中 $\\mathbf{M}$ 是对角矩阵，其元素为 $V_i$，$\\mathbf{A}\\,\\mathbf{C}$ 表示每个控制体的净通量差。您必须确保 $\\mathbf{A}$ 满足属性 $\\mathbf{A}\\,\\mathbf{1} = \\mathbf{0}$，其中 $\\mathbf{1}$ 是全1向量，这与均匀浓度下零通量的情况一致。\n- 使用与物理定义一致的单位：$L$ 的单位为 $\\mathrm{m}$，$D$ 的单位为 $\\mathrm{m}^2/\\mathrm{s}$，$t$ 的单位为 $\\mathrm{s}$，$C$ 的单位为 $\\mathrm{m}^{-3}$。输出将是无量纲的布尔值。\n\n测试套件：\n实现并运行以下四个测试用例。对于每个测试用例，运行指定步数的隐式格式，并报告两个布尔值：离散剂量是否在 $10^{-12}$ 的相对容差内守恒，以及 $\\mathbf{A}$ 的所有行和是否在 $10^{-12}$ 的绝对容差内等于零。最终输出必须按顺序将这八个布尔值聚合为单个列表。\n\n- 测试用例 1（均匀网格，均匀扩散系数，高斯初始条件）：\n  - $L = 10^{-6}\\ \\mathrm{m}$，$N = 64$，$\\Delta t = 10\\ \\mathrm{s}$，步数 $= 10$。\n  - 对于所有 $x$，$D(x) = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$。\n  - 初始条件 $C(x,0) = C_0 \\exp\\left(-\\frac{(x - L/2)^2}{2\\sigma^2}\\right)$，其中 $C_0 = 10^{23}\\ \\mathrm{m}^{-3}$ 且 $\\sigma = L/10$。\n\n- 测试用例 2（均匀网格，分段扩散系数，顶帽形初始条件）：\n  - $L = 10^{-6}\\ \\mathrm{m}$，$N = 100$，$\\Delta t = 20\\ \\mathrm{s}$，步数 $= 10$。\n  - 当 $x \\le L/2$ 时 $D(x) = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$，当 $x  L/2$ 时 $D(x) = 10^{-16}\\ \\mathrm{m}^2/\\mathrm{s}$。\n  - 初始条件 $C(x,0) = C_0$ 当 $x \\in [0, L/3]$，否则 $C(x,0) = 0$，其中 $C_0 = 10^{22}\\ \\mathrm{m}^{-3}$。\n\n- 测试用例 3（非均匀网格，平滑变化的扩散系数，分段线性初始条件）：\n  - $L = 10^{-6}\\ \\mathrm{m}$，$N = 53$，$\\Delta t = 5\\ \\mathrm{s}$，步数 $= 20$。\n  - 非均匀网格通过映射 $s_j = j/N$（其中 $j=0,\\dots,N$）定义，界面位于 $x_{j+\\frac{1}{2}} = L\\,s_j^{2}$；单元宽度为 $\\Delta x_i = x_{i+\\frac{1}{2}} - x_{i-\\frac{1}{2}}$，中心为 $x_i = (x_{i-\\frac{1}{2}} + x_{i+\\frac{1}{2}})/2$。\n  - $D(x) = D_0\\left(1 + \\alpha \\sin\\left(2\\pi x/L\\right)\\right)$，其中 $D_0 = 10^{-14}\\ \\mathrm{m}^2/\\mathrm{s}$ 且 $\\alpha = 0.8$。\n  - 初始条件 $C(x,0)$ 是分段线性的：当 $x \\in [0, L/2]$ 时 $C(x,0) = C_0 \\cdot (x/L)$，当 $x \\in (L/2, L]$ 时 $C(x,0) = C_0 \\cdot (1 - x/L)$，其中 $C_0 = 10^{21}\\ \\mathrm{m}^{-3}$。\n\n- 测试用例 4（单单元边界情况）：\n  - $L = 10^{-6}\\ \\mathrm{m}$，$N = 1$，$\\Delta t = 100\\ \\mathrm{s}$，步数 $= 5$。\n  - 对于所有 $x$，$D(x) = 10^{-15}\\ \\mathrm{m}^2/\\mathrm{s}$。\n  - 初始条件 $C(x,0) = C_0$，其中 $C_0 = 10^{20}\\ \\mathrm{m}^{-3}$。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序如下：\n$$\n[\\text{TC1\\_dose},\\text{TC1\\_rowsum},\\text{TC2\\_dose},\\text{TC2\\_rowsum},\\text{TC3\\_dose},\\text{TC3\\_rowsum},\\text{TC4\\_dose},\\text{TC4\\_rowsum}],\n$$\n其中每个条目都是一个布尔值，表示相应检查是否通过该测试用例。",
            "solution": "任务是为瞬态扩散方程 $\\frac{\\partial C(x,t)}{\\partial t} = \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right)$ 在具有零通量边界条件的有限域 $[0,L]$ 上开发并实现一种一维有限体积法 (FVM)。空间离散化必须是保守的，时间积分将使用全隐式后向欧拉格式。我们还必须证明所得到的数值格式能够守恒总掺杂剂量。\n\n**1. 半离散有限体积格式的推导**\n\n有限体积法首先将控制性偏微分方程（PDE）在一个控制体 $V_i$ 上积分，在一维中，这是一个跨越区间 $[x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$ 的单元 $i$。单元的宽度是 $\\Delta x_i = x_{i+\\frac{1}{2}} - x_{i-\\frac{1}{2}}$，对于单位横截面积，体积为 $V_i = \\Delta x_i$。\n\n在单元 $i$ 上积分PDE：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial C(x,t)}{\\partial t} dx = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right) dx\n$$\n假设单元 $i$ 中的平均浓度为 $C_i(t) = \\frac{1}{\\Delta x_i} \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} C(x,t) dx$，左侧可以近似为：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial C(x,t)}{\\partial t} dx \\approx \\frac{d}{dt} \\left(\\Delta x_i C_i(t)\\right) = V_i \\frac{dC_i(t)}{dt}\n$$\n右侧使用微积分基本定理（一维中的散度定理）进行积分：\n$$\n\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\frac{\\partial}{\\partial x}\\left(D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}\\right) dx = \\left[ D(x)\\,\\frac{\\partial C(x,t)}{\\partial x} \\right]_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}}\n$$\n扩散通量由菲克第一定律定义为 $J(x,t) = -D(x)\\,\\frac{\\partial C(x,t)}{\\partial x}$。问题将通量定义为 $F(x,t) = -J(x,t) = D(x)\\frac{\\partial C}{\\partial x}$。因此，积分变为：\n$$\nF(x_{i+\\frac{1}{2}}, t) - F(x_{i-\\frac{1}{2}}, t) = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t)\n$$\n这给出了单元 $i$ 的半离散守恒律：\n$$\nV_i\\,\\frac{d C_i(t)}{dt} = F_{i+\\frac{1}{2}}(t) - F_{i-\\frac{1}{2}}(t)\n$$\n为了继续，我们需要一个在单元 $i$ 和单元 $i+1$ 之间界面上通量 $F_{i+\\frac{1}{2}}$ 的离散表达式。我们使用单元中心浓度 $C_i$ 和 $C_{i+1}$ 来近似界面处的浓度梯度，并且我们需要一个界面处的代表性扩散系数 $D_{i+\\frac{1}{2}}$。通量近似为：\n$$\nF_{i+\\frac{1}{2}} \\approx D_{i+\\frac{1}{2}} \\frac{C_{i+1} - C_i}{x_{i+1} - x_i}\n$$\n其中 $x_i$ 和 $x_{i+1}$ 是单元 $i$ 和 $i+1$ 的中心。对于单元中心是中点的网格，$x_{i+1} - x_i = (\\Delta x_i + \\Delta x_{i+1}) / 2$。然而，一个更稳健的界面通量公式，特别是对于非均匀网格和变化的扩散系数，是通过认为通量在单元中心之间是恒定的并对阻力 $1/D(x)$ 进行积分来推导的。这导致有效扩散系数的调和平均值。单元 $i$ 和单元 $i+1$ 之间的通量由下式给出：\n$$\nF_{i+\\frac{1}{2}} = \\gamma_{i+\\frac{1}{2}} (C_{i+1} - C_i)\n$$\n其中 $\\gamma_{i+\\frac{1}{2}}$ 是界面电导。它是通过考虑从中心 $x_i$ 到界面 $x_{i+\\frac{1}{2}}$ 以及从界面 $x_{i+\\frac{1}{2}}$ 到中心 $x_{i+1}$ 的扩散阻力串联得出的：\n$$\n\\gamma_{i+\\frac{1}{2}} = \\frac{1}{R_i + R_{i+1}} = \\frac{1}{\\frac{x_{i+\\frac{1}{2}} - x_i}{D_i} + \\frac{x_{i+1} - x_{i+\\frac{1}{2}}}{D_{i+1}}} = \\frac{1}{\\frac{\\Delta x_i / 2}{D_i} + \\frac{\\Delta x_{i+1} / 2}{D_{i+1}}} = \\frac{2 D_i D_{i+1}}{D_{i+1} \\Delta x_i + D_i \\Delta x_{i+1}}\n$$\n这里，$D_i = D(x_i)$ 是单元 $i$ 中心的扩散系数。这个表达式是对称的，并且能正确处理 $D$ 的巨大差异。\n内部单元 $i$ 的半离散系统是：\n$$\nV_i \\frac{dC_i}{dt} = \\gamma_{i+\\frac{1}{2}}(C_{i+1} - C_i) - \\gamma_{i-\\frac{1}{2}}(C_i - C_{i-1}) = \\gamma_{i-\\frac{1}{2}}C_{i-1} - (\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}})C_i + \\gamma_{i+\\frac{1}{2}}C_{i+1}\n$$\n\n**2. 边界条件和矩阵结构**\n\n零通量边界条件 $J(0,t)=0$ 和 $J(L,t)=0$ 意味着 $F_{1/2}(t)=0$ 和 $F_{N+1/2}(t)=0$。这等同于将域边界处的电导设置为零：$\\gamma_{1/2} = 0$ 和 $\\gamma_{N+1/2} = 0$。\n边界单元的方程是：\n- 对于单元 $i=1$：$V_1 \\frac{dC_1}{dt} = F_{3/2} - F_{1/2} = \\gamma_{3/2}(C_2 - C_1)$\n- 对于单元 $i=N$：$V_N \\frac{dC_N}{dt} = F_{N+1/2} - F_{N-1/2} = -\\gamma_{N-1/2}(C_N - C_{N-1})$\n\n令 $\\mathbf{C}$ 为单元浓度向量 $[C_1, \\dots, C_N]^T$。半离散系统可以写成矩阵形式 $\\mathbf{M} \\frac{d\\mathbf{C}}{dt} = \\mathbf{A}\\mathbf{C}$，其中 $\\mathbf{M}$ 是一个对角矩阵，其元素为 $M_{ii} = V_i = \\Delta x_i$。矩阵 $\\mathbf{A}$ 代表空间算子。其元素为：\n- $A_{i,i} = -(\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}})$，对于 $i=2, \\dots, N-1$\n- $A_{i, i-1} = \\gamma_{i-\\frac{1}{2}}$，对于 $i=2, \\dots, N$\n- $A_{i, i+1} = \\gamma_{i+\\frac{1}{2}}$，对于 $i=1, \\dots, N-1$\n- $A_{1,1} = -\\gamma_{3/2}$，$A_{N,N} = -\\gamma_{N-1/2}$\n矩阵 $\\mathbf{A}$ 的每一行之和为零。对于内部行 $i$，其和为 $A_{i,i-1} + A_{i,i} + A_{i,i+1} = \\gamma_{i-\\frac{1}{2}} -(\\gamma_{i-\\frac{1}{2}} + \\gamma_{i+\\frac{1}{2}}) + \\gamma_{i+\\frac{1}{2}} = 0$。对于第 1 行，其和为 $A_{1,1} + A_{1,2} = -\\gamma_{3/2} + \\gamma_{3/2} = 0$。对于第 $N$ 行，其和为 $A_{N,N-1} + A_{N,N} = \\gamma_{N-1/2} - \\gamma_{N-1/2} = 0$。这个性质 $\\mathbf{A}\\mathbf{1}=\\mathbf{0}$（其中 $\\mathbf{1}$ 是全1向量）确保了均匀浓度分布会产生零净通量，并且是一个稳态解，正如物理上所预期的。\n\n**3. 时间离散化和最终系统**\n\n将一阶精度的后向欧拉法应用于半离散系统，得到：\n$$\nV_i \\frac{C_i^{n+1} - C_i^n}{\\Delta t} = F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\n$$\n其中通量是在新的时间层 $n+1$ 计算的。写成矩阵形式：\n$$\n\\mathbf{M} \\frac{\\mathbf{C}^{n+1} - \\mathbf{C}^n}{\\Delta t} = \\mathbf{A} \\mathbf{C}^{n+1}\n$$\n重新整理以求解 $\\mathbf{C}^{n+1}$，我们得到：\n$$\n\\mathbf{M}\\mathbf{C}^{n+1} - \\Delta t \\mathbf{A}\\mathbf{C}^{n+1} = \\mathbf{M}\\mathbf{C}^n \\implies (\\mathbf{M} - \\Delta t \\mathbf{A})\\mathbf{C}^{n+1} = \\mathbf{M}\\mathbf{C}^n\n$$\n这是一个线性方程组，在每个时间步求解未知的浓度向量 $\\mathbf{C}^{n+1}$。\n\n**4. 离散剂量守恒的证明**\n\n在时间步 $n$ 的离散剂量（单位面积的总掺杂量）定义为 $Q^n = \\sum_{i=1}^N V_i C_i^n$。我们必须证明在零通量边界条件下，$Q^{n+1}=Q^n$。\n将全离散方程对所有单元 $i=1, \\dots, N$ 求和：\n$$\n\\sum_{i=1}^N V_i\\frac{C_i^{n+1} - C_i^n}{\\Delta t} = \\sum_{i=1}^N \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right)\n$$\n左侧是：\n$$\n\\frac{1}{\\Delta t} \\left(\\sum_{i=1}^N V_i C_i^{n+1} - \\sum_{i=1}^N V_i C_i^n\\right) = \\frac{Q^{n+1} - Q^n}{\\Delta t}\n$$\n右侧是一个伸缩求和 (telescoping sum)：\n$$\n\\sum_{i=1}^N \\left(F_{i+\\frac{1}{2}}^{n+1} - F_{i-\\frac{1}{2}}^{n+1}\\right) = (F_{3/2}^{n+1} - F_{1/2}^{n+1}) + (F_{5/2}^{n+1} - F_{3/2}^{n+1}) + \\dots + (F_{N+\\frac{1}{2}}^{n+1} - F_{N-\\frac{1}{2}}^{n+1}) = F_{N+\\frac{1}{2}}^{n+1} - F_{1/2}^{n+1}\n$$\n零通量边界条件要求 $F_{1/2}(t)=0$ 和 $F_{N+1/2}(t)=0$ 对所有时间 $t$ 成立，包括 $t=t^{n+1}$。因此，右侧的和为 $0-0=0$。\n我们得到：\n$$\n\\frac{Q^{n+1} - Q^n}{\\Delta t} = 0\n$$\n这意味着 $Q^{n+1} - Q^n = 0$，或 $Q^{n+1} = Q^n$。这证明了数值格式是保守的，即在精确算术的假设下，它在任何时间步 $\\Delta t$ 内都保持域中的总剂量不变。这一性质是FVM公式的直接结果，其中相邻单元的通量完美抵消。",
            "answer": "```python\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n\n    def run_case(L, N, dt, num_steps, D_func, C_func, grid_type='uniform', grid_param=None):\n        \"\"\"\n        Runs a single simulation case for the 1D diffusion problem.\n        \n        Returns:\n            (bool, bool): A tuple containing booleans for dose conservation and A matrix row sum check.\n        \"\"\"\n        # 1. Grid Generation\n        # Cell indices k = 0, ..., N-1. Face indices j = 0, ..., N.\n        x_face = np.zeros(N + 1)\n        if grid_type == 'uniform':\n            x_face = np.linspace(0, L, N + 1)\n        elif grid_type == 'nonuniform':\n            s = np.linspace(0, 1, N + 1)\n            x_face = L * (s**grid_param)\n        \n        dx = x_face[1:] - x_face[:-1]  # Cell widths, V_i or M_ii\n        x_cell = 0.5 * (x_face[:-1] + x_face[1:]) # Cell centers\n\n        # 2. Initialization\n        D_cell = D_func(x_cell)\n        C_current = C_func(x_cell)\n        \n        # Diagonal of mass matrix M\n        M_diag = dx\n        \n        initial_dose = np.sum(M_diag * C_current)\n\n        # 3. Assemble stiffness matrix A\n        A = np.zeros((N, N))\n        \n        if N > 1:\n            gamma = np.zeros(N - 1)\n            # Loop over interior faces (indices k = 0 to N-2, corresponding to interfaces 3/2, 5/2, ...)\n            for k in range(N - 1):\n                # Harmonic mean-based conductance\n                resistance = (dx[k] / (2.0 * D_cell[k])) + (dx[k+1] / (2.0 * D_cell[k+1]))\n                gamma[k] = 1.0 / resistance\n                A[k, k + 1] = gamma[k]\n                A[k + 1, k] = gamma[k]\n        \n        # Fill diagonal of A to enforce row sums are zero\n        for k in range(N):\n            A[k, k] = -np.sum(A[k, :])\n\n        # 4. Check properties of A\n        row_sums = np.sum(A, axis=1)\n        row_sum_check = np.all(np.abs(row_sums)  1e-12)\n\n        # 5. Time Stepping\n        # Form the system matrix S = (M - dt*A)\n        S = np.diag(M_diag) - dt * A\n        \n        for _ in range(num_steps):\n            # RHS vector b = M * C^n\n            b = M_diag * C_current\n            # Solve S * C^{n+1} = b\n            C_current = linalg.solve(S, b)\n\n        # 6. Check dose conservation\n        final_dose = np.sum(M_diag * C_current)\n        \n        # Use relative tolerance, guard against zero initial dose\n        if np.abs(initial_dose) > 1e-20:\n            relative_error = np.abs((final_dose - initial_dose) / initial_dose)\n            dose_check = relative_error  1e-12\n        else: # If initial dose is effectively zero\n            dose_check = np.abs(final_dose)  1e-12\n\n        return dose_check, row_sum_check\n\n    test_cases = [\n        {\n            \"L\": 1e-6, \"N\": 64, \"dt\": 10.0, \"num_steps\": 10,\n            \"D_func\": lambda x: 1e-14 * np.ones_like(x),\n            \"C_func\": lambda x: 1e23 * np.exp(-(x - 1e-6/2)**2 / (2 * (1e-6/10)**2)),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        },\n        {\n            \"L\": 1e-6, \"N\": 100, \"dt\": 20.0, \"num_steps\": 10,\n            \"D_func\": lambda x: np.piecewise(x, [x = 1e-6/2], [1e-14, 1e-16]),\n            \"C_func\": lambda x: np.piecewise(x, [x = 1e-6/3], [1e22, 0.0]),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        },\n        {\n            \"L\": 1e-6, \"N\": 53, \"dt\": 5.0, \"num_steps\": 20,\n            \"D_func\": lambda x: 1e-14 * (1 + 0.8 * np.sin(2 * np.pi * x / 1e-6)),\n            \"C_func\": lambda x: 1e21 * np.piecewise(x, [x = 1e-6/2],\n                                [lambda v: v / 1e-6, lambda v: 1 - v / 1e-6]),\n            \"grid_type\": \"nonuniform\", \"grid_param\": 2.0\n        },\n        {\n            \"L\": 1e-6, \"N\": 1, \"dt\": 100.0, \"num_steps\": 5,\n            \"D_func\": lambda x: 1e-15 * np.ones_like(x),\n            \"C_func\": lambda x: 1e20 * np.ones_like(x),\n            \"grid_type\": \"uniform\", \"grid_param\": None\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        dose_ok, rowsum_ok = run_case(**case)\n        results.extend([dose_ok, rowsum_ok])\n\n    # Convert Python booleans to JSON-style lowercase 'true'/'false' for output\n    formatted_results = [str(r).lower() for r in results]\n\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}