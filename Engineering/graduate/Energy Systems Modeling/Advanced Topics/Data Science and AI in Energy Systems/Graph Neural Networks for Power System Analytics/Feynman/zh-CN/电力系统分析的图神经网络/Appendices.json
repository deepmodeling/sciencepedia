{
    "hands_on_practices": [
        {
            "introduction": "在将图神经网络（GNN）应用于电力系统分析之前，一个至关重要的预处理步骤是特征工程。电力系统中的物理量，如功率（以兆瓦 $MW$ 为单位）和电压（以千伏 $kV$ 为单位），其数值尺度差异巨大，直接使用这些原始数值会给机器学习模型的训练带来困难。本练习将引导您实践电力工程中一种标准的归一化方法——标幺化（per-unit normalization），它能将所有物理量转换为无量纲的统一尺度，为 GNN 提供高质量的输入数据。",
            "id": "4094182",
            "problem": "一个输电网络被表示为一个图，其中每个母线是一个节点，线路是边。为了训练用于状态估计和异常检测的图神经网络（GNN），节点特征在标幺（p.u.）系统中进行归一化，以确保输入是无量纲且尺度一致的。考虑单个母线 $i$，其净有功功率注入为 $P_i=150\\,\\mathrm{MW}$，电压幅值为 $|V_i|=230\\,\\mathrm{kV}$。系统的标幺基准值为视在功率基准 $S_{\\mathrm{base}}=100\\,\\mathrm{MVA}$ 和电压基准 $V_{\\mathrm{base}}=230\\,\\mathrm{kV}$，与额定输电等级一致。从交流电网络中复功率的定义 $S=P+jQ$ 和由与基准量之比定义的标幺归一化原理出发，并强制量纲一致性，推导母线 $i$ 的标幺归一化特征 $P_i^{\\mathrm{pu}}$ 和 $|V_i|^{\\mathrm{pu}}$。将母线 $i$ 的最终归一化行特征向量组装为 $\\begin{pmatrix}P_i^{\\mathrm{pu}}  |V_i|^{\\mathrm{pu}}\\end{pmatrix}$，其元素为无量纲值。请以单行矩阵的形式提供最终答案。无需四舍五入，请给出精确值。",
            "solution": "该问题要求推导电力系统母线的标幺归一化特征，特指有功功率注入和电压幅值。标幺系统是电力系统分析中一种归一化量的方法，其中实际值表示为基准值的小数部分。\n\n### 步骤 1：问题验证\n\n**1.1. 提取给定条件**\n- 母线: $i$\n- 净有功功率注入: $P_i=150\\,\\mathrm{MW}$\n- 电压幅值: $|V_i|=230\\,\\mathrm{kV}$\n- 视在功率基准: $S_{\\mathrm{base}}=100\\,\\mathrm{MVA}$\n- 电压基准: $V_{\\mathrm{base}}=230\\,\\mathrm{kV}$\n- 复功率定义: $S=P+jQ$\n- 标幺原理: 与基准量之比。\n- 要求输出: 一个行特征向量 $\\begin{pmatrix}P_i^{\\mathrm{pu}}  |V_i|^{\\mathrm{pu}}\\end{pmatrix}$。\n\n**1.2. 使用提取的给定条件进行验证**\n该问题在科学上基于电气工程原理，特别是交流电力电路分析和标幺系统，这是分析电力网络和为图神经网络等计算模型准备数据的标准技术。所提供的值对于高压输电系统是符合实际的。该问题是适定的，提供了计算唯一解所需的所有基准量和实际值。它使用标准术语进行了客观陈述。该问题是完整的、一致的，并且没有违反任何科学或数学原理。\n\n**1.3. 结论与行动**\n该问题被判定为**有效**。将推导解答。\n\n### 步骤 2：解题推导\n\n标幺量的基本定义是实际量与选定的同量纲基准量之比。\n$$ \\text{标幺量} = \\frac{\\text{实际量}}{\\text{基准量}} $$\n此运算的结果是一个无量纲值。我们将此原理应用于电压幅值和有功功率。\n\n**2.1. 标幺电压幅值 ($|V_i|^{\\mathrm{pu}}$)**\n母线 $i$ 的实际电压幅值给定为 $|V_i| = 230\\,\\mathrm{kV}$。系统电压基准给定为 $V_{\\mathrm{base}} = 230\\,\\mathrm{kV}$。\n应用标幺定义：\n$$ |V_i|^{\\mathrm{pu}} = \\frac{|V_i|}{V_{\\mathrm{base}}} $$\n代入给定值：\n$$ |V_i|^{\\mathrm{pu}} = \\frac{230\\,\\mathrm{kV}}{230\\,\\mathrm{kV}} = 1.0 $$\n得到的标幺电压幅值为无量纲值 $1.0$。\n\n**2.2. 标幺有功功率 ($P_i^{\\mathrm{pu}}$)**\n母线 $i$ 的实际净有功功率注入给定为 $P_i = 150\\,\\mathrm{MW}$。\n在标准标幺系统中，所有功率量——有功功率（$P$）、无功功率（$Q$）和视在功率（$S$）——都通过一个单一、共同的视在功率基准 $S_{\\mathrm{base}}$ 进行归一化。这一惯例确保了以复功率形式表示的功率三角形关系 $S=P+jQ$ 对标幺量仍然有效，即 $S^{\\mathrm{pu}} = P^{\\mathrm{pu}} + jQ^{\\mathrm{pu}}$。\n视在功率基准给定为 $S_{\\mathrm{base}} = 100\\,\\mathrm{MVA}$。因此，有功功率的基准也是这个值。\n$$ P_{\\mathrm{base}} = S_{\\mathrm{base}} = 100\\,\\mathrm{MVA} $$\n实际量（$P_i$，单位为 $\\mathrm{MW}$）和基准量（$S_{\\mathrm{base}}$，单位为 $\\mathrm{MVA}$）的单位必须一致。在功率的背景下，兆瓦（$\\mathrm{MW}$）和兆伏安（$\\mathrm{MVA}$）就此比率而言在量纲上是一致的，因为 $P=|S|\\cos\\phi$。功率的基本单位是伏安（$\\mathrm{VA}$），而瓦特（$\\mathrm{W}$）在归一化目的上是等效的（$1\\,\\mathrm{W} = 1\\,\\mathrm{VA} \\times (\\text{功率因数})$）。由于标幺系统旨在创建无量纲表示，因此直接形成比率。\n应用功率的标幺定义：\n$$ P_i^{\\mathrm{pu}} = \\frac{P_i}{S_{\\mathrm{base}}} $$\n代入给定值：\n$$ P_i^{\\mathrm{pu}} = \\frac{150\\,\\mathrm{MW}}{100\\,\\mathrm{MVA}} = 1.5 $$\n得到的标幺有功功率为无量纲值 $1.5$。\n\n**2.3. 组装特征向量**\n问题要求将最终的归一化特征组装成 $\\begin{pmatrix}P_i^{\\mathrm{pu}}  |V_i|^{\\mathrm{pu}}\\end{pmatrix}$ 形式的行特征向量。\n代入计算出的标幺值：\n$$ \\begin{pmatrix} 1.5  1.0 \\end{pmatrix} $$\n该向量表示母线 $i$ 的归一化特征，将用作图神经网络模型中节点的输入。",
            "answer": "$$\\boxed{\\begin{pmatrix} 1.5  1.0 \\end{pmatrix}}$$"
        },
        {
            "introduction": "图神经网络的核心在于其信息传播机制，即节点通过迭代地聚合邻居节点的信息来更新自身表示。这个过程本质上是一种局部平均或“平滑”操作，但也可能导致“过平滑”（over-smoothing）现象，即多层传播后节点特征趋于一致，丧失了区分度。本练习模拟了两种主流 GNN 架构（GCN 和 GraphSAGE），让您亲手量化这种平滑效应对电力系统中关键物理信号——如输电通道两端的电压相角差——的削弱作用，从而深刻理解 GNN 的内在特性与潜在局限。",
            "id": "4094185",
            "problem": "考虑一个表示输电走廊的路径图，该图有$4$个母线，标记为$1$、$2$、$3$、$4$。这些母线按顺序连接，即$1–2$、$2–3$、$3–4$。设母线$i$处的节点特征为母线电压相角$\\theta_i$（单位为弧度）。在线性化直流（DC）潮流中，线路上的有功功率流与其两端的相角差成正比，而陡峭的相角梯度表示走廊承受高压力和高传输。我们研究两轮基于图的平均化操作如何影响母线$1$和$4$之间的端到端相角对比度。\n\n您必须为以下每种架构实现两个消息传递层：\n\n- 图卷积网络（GCN）：图卷积网络（GCN）使用带自环的对称归一化。为该路径图构建邻接矩阵$A$，然后建立$\\tilde{A} = A + I$，其中$I$是单位矩阵。定义对角度矩阵$\\tilde{D}$，其中$\\tilde{D}_{ii} = \\sum_j \\tilde{A}_{ij}$。传播算子是对称归一化形式$\\hat{A} = \\tilde{D}^{-1/2} \\tilde{A} \\tilde{D}^{-1/2}$。应用两层单位权重且无非线性变换的传播，因此经过两层传播后的相角为$\\theta^{(2)}_{\\mathrm{GCN}} = \\hat{A} \\hat{A} \\theta^{(0)}$。\n\n- 图采样与聚合（GraphSAGE）：采用均值聚合和自环的GraphSAGE可以通过对带自环的邻接矩阵进行行归一化来表示。使用相同的$\\tilde{A}$，定义$P = \\tilde{D}^{-1} \\tilde{A}$。应用两层单位权重且无非线性变换的传播，得到$\\theta^{(2)}_{\\mathrm{SAGE}} = P P \\theta^{(0)}$。\n\n您的任务是量化由这两层传播引起的端到端相角对比度的衰减。将初始对比度定义为$C_0 = |\\theta^{(0)}_4 - \\theta^{(0)}_1|$，传播后的对比度定义为$C_{\\mathrm{GCN}} = |\\theta^{(2)}_{\\mathrm{GCN},4} - \\theta^{(2)}_{\\mathrm{GCN},1}|$和$C_{\\mathrm{SAGE}} = |\\theta^{(2)}_{\\mathrm{SAGE},4} - \\theta^{(2)}_{\\mathrm{SAGE},1}|$。报告对比度衰减比$r_{\\mathrm{GCN}} = C_{\\mathrm{GCN}} / C_0$和$r_{\\mathrm{SAGE}} = C_{\\mathrm{SAGE}} / C_0$。如果$C_0 = 0$，则将两个比率都定义为$0$。相角必须以弧度处理。\n\n使用以下初始相角配置$\\theta^{(0)}$（所有条目单位均为弧度）的测试套件：\n\n- 测试$1$：$\\theta^{(0)} = [0.0, 0.2, 0.6, 1.4]$（从母线$1$到母线$4$的大梯度）。\n- 测试$2$：$\\theta^{(0)} = [0.5, 0.5, 0.5, 0.5]$（均匀相角）。\n- 测试$3$：$\\theta^{(0)} = [1.2, 0.0, 0.0, -1.2]$（端点反相）。\n- 测试$4$：$\\theta^{(0)} = [0.0, 0.0, 0.0, 1.0]$（终端母线处的急剧阶跃）。\n\n您的程序必须为每个测试用例计算两个衰减比$r_{\\mathrm{GCN}}$和$r_{\\mathrm{SAGE}}$，并生成一行输出。该输出包含一个方括号括起来的逗号分隔列表，其中包含所有结果，顺序为$[r_{\\mathrm{GCN},1}, r_{\\mathrm{SAGE},1}, r_{\\mathrm{GCN},2}, r_{\\mathrm{SAGE},2}, r_{\\mathrm{GCN},3}, r_{\\mathrm{SAGE},3}, r_{\\mathrm{GCN},4}, r_{\\mathrm{SAGE},4}]$。每个元素必须是浮点数，且不应打印任何额外文本。",
            "solution": "问题陈述已经过验证，被认为是有效的。它具有科学依据、是良定的、客观的，并包含推导出唯一解所需的所有必要信息。线性化直流潮流和图神经网络传播的概念是标准的，并且应用正确。\n\n求解过程如下：首先为指定的图构建GCN和GraphSAGE的传播算子，然后应用它们进行两次迭代以计算最终的节点特征，最后为每个测试用例计算对比度衰减比。\n\n**1. 图和矩阵定义**\n\n该系统是一个有 $4$ 个母线的路径图，标记为 $1, 2, 3, 4$。连接方式为 $1–2$、 $2–3$ 和 $3–4$。对矩阵使用从零开始的索引（节点 $1 \\to$ 索引 $0$，节点 $4 \\to$ 索引 $3$），邻接矩阵 $A$ 为：\n$$\nA = \\begin{pmatrix} 0  1  0  0 \\\\ 1  0  1  0 \\\\ 0  1  0  1 \\\\ 0  0  1  0 \\end{pmatrix}\n$$\n带自环的邻接矩阵 $\\tilde{A} = A + I$ 为：\n$$\n\\tilde{A} = A + I_4 = \\begin{pmatrix}\n1  1  0  0 \\\\\n1  1  1  0 \\\\\n0  1  1  1 \\\\\n0  0  1  1\n\\end{pmatrix}\n$$\n对角度矩阵 $\\tilde{D}$ 由 $\\tilde{A}$ 的行和构成。带自环节点的度分别为 $\\tilde{d}_1 = 2$、 $\\tilde{d}_2 = 3$、 $\\tilde{d}_3 = 3$ 和 $\\tilde{d}_4 = 2$。\n$$\n\\tilde{D} = \\begin{pmatrix}\n2  0  0  0 \\\\\n0  3  0  0 \\\\\n0  0  3  0 \\\\\n0  0  0  2\n\\end{pmatrix}\n$$\n\n**2. 图卷积网络（GCN）传播**\n\nGCN传播算子为 $\\hat{A} = \\tilde{D}^{-1/2} \\tilde{A} \\tilde{D}^{-1/2}$。其元素为 $\\hat{A}_{ij} = \\tilde{A}_{ij} / \\sqrt{\\tilde{d}_i \\tilde{d}_j}$。\n$$\n\\hat{A} = \\begin{pmatrix}\n1/2  1/\\sqrt{6}  0  0 \\\\\n1/\\sqrt{6}  1/3  1/3  0 \\\\\n0  1/3  1/3  1/\\sqrt{6} \\\\\n0  0  1/\\sqrt{6}  1/2\n\\end{pmatrix}\n$$\n两层传播得到的算子为 $M_{\\mathrm{GCN}} = \\hat{A}^2$。传播后的相角为 $\\theta^{(2)}_{\\mathrm{GCN}} = M_{\\mathrm{GCN}} \\theta^{(0)}$。对比度 $C_{\\mathrm{GCN}} = |\\theta^{(2)}_{\\mathrm{GCN},4} - \\theta^{(2)}_{\\mathrm{GCN},1}|$ 取决于 $M_{\\mathrm{GCN}}$ 的第一行和第四行。设 $M_{\\mathrm{GCN},i}$ 为 $M_{\\mathrm{GCN}}$ 的第 $i$ 行。\n$M_{\\mathrm{GCN},1} = [5/12, 5/(6\\sqrt{6}), 1/(3\\sqrt{6}), 0]$\n$M_{\\mathrm{GCN},4} = [0, 1/(3\\sqrt{6}), 5/(6\\sqrt{6}), 5/12]$\n差分向量 $v = M_{\\mathrm{GCN},4} - M_{\\mathrm{GCN},1}$ 为：\n$$\nv = [-5/12, -1/(2\\sqrt{6}), 1/(2\\sqrt{6}), 5/12]\n$$\n因此，GCN对比度为 $C_{\\mathrm{GCN}} = |v \\cdot \\theta^{(0)}| = |(5/12)(\\theta^{(0)}_4 - \\theta^{(0)}_1) + (1/(2\\sqrt{6}))(\\theta^{(0)}_3 - \\theta^{(0)}_2)|$。\n\n**3. GraphSAGE传播**\n\nGraphSAGE传播算子（采用均值聚合）为 $P = \\tilde{D}^{-1} \\tilde{A}$。其元素为 $P_{ij} = \\tilde{A}_{ij} / \\tilde{d}_i$。\n$$\nP = \\begin{pmatrix}\n1/2  1/2  0  0 \\\\\n1/3  1/3  1/3  0 \\\\\n0  1/3  1/3  1/3 \\\\\n0  0  1/2  1/2\n\\end{pmatrix}\n$$\n两层传播得到的算子为 $M_{\\mathrm{SAGE}} = P^2$。传播后的相角为 $\\theta^{(2)}_{\\mathrm{SAGE}} = M_{\\mathrm{SAGE}} \\theta^{(0)}$。对比度 $C_{\\mathrm{SAGE}} = |\\theta^{(2)}_{\\mathrm{SAGE},4} - \\theta^{(2)}_{\\mathrm{SAGE},1}|$ 取决于 $M_{\\mathrm{SAGE}}$ 的第一行和第四行。设 $M_{\\mathrm{SAGE},i}$ 为 $M_{\\mathrm{SAGE}}$ 的第 $i$ 行。\n$M_{\\mathrm{SAGE},1} = [5/12, 5/12, 1/6, 0]$\n$M_{\\mathrm{SAGE},4} = [0, 1/6, 5/12, 5/12]$\n差分向量 $w = M_{\\mathrm{SAGE},4} - M_{\\mathrm{SAGE},1}$ 为：\n$$\nw = [-5/12, -1/4, 1/4, 5/12]\n$$\n因此，GraphSAGE对比度为 $C_{\\mathrm{SAGE}} = |w \\cdot \\theta^{(0)}| = |(5/12)(\\theta^{(0)}_4 - \\theta^{(0)}_1) + (1/4)(\\theta^{(0)}_3 - \\theta^{(0)}_2)|$。\n\n**4. 衰减比的计算**\n\n对于每个测试用例 $\\theta^{(0)}$，我们计算 $C_0 = |\\theta^{(0)}_4 - \\theta^{(0)}_1|$、$C_{\\mathrm{GCN}}$ 和 $C_{\\mathrm{SAGE}}$。衰减比为 $r = C / C_0$ （如果 $C_0=0$ 则为 $0$）。\n\n- **测试 1:** $\\theta^{(0)} = [0.0, 0.2, 0.6, 1.4]$\n$C_0 = |1.4 - 0.0| = 1.4$。\n$\\theta^{(0)}_4 - \\theta^{(0)}_1 = 1.4$。 $\\theta^{(0)}_3 - \\theta^{(0)}_2 = 0.4$。\n$C_{\\mathrm{GCN}} = |(5/12)(1.4) + (1/(2\\sqrt{6}))(0.4)| \\approx |0.58333 + 0.08165| \\approx 0.66498$。\n$r_{\\mathrm{GCN}} = 0.66498 / 1.4 \\approx 0.474988$。\n$C_{\\mathrm{SAGE}} = |(5/12)(1.4) + (1/4)(0.4)| = |7/12 + 1/10| = 41/60 \\approx 0.68333$。\n$r_{\\mathrm{SAGE}} = (41/60) / 1.4 = 41/84 \\approx 0.488095$。\n\n- **测试 2:** $\\theta^{(0)} = [0.5, 0.5, 0.5, 0.5]$\n$C_0 = |0.5 - 0.5| = 0$。\n根据问题定义，$r_{\\mathrm{GCN}} = 0.0$ 且 $r_{\\mathrm{SAGE}} = 0.0$。\n\n- **测试 3:** $\\theta^{(0)} = [1.2, 0.0, 0.0, -1.2]$\n$C_0 = |-1.2 - 1.2| = 2.4$。\n$\\theta^{(0)}_4 - \\theta^{(0)}_1 = -2.4$。 $\\theta^{(0)}_3 - \\theta^{(0)}_2 = 0.0$。\n$C_{\\mathrm{GCN}} = |(5/12)(-2.4) + 0| = |-1.0| = 1.0$。\n$r_{\\mathrm{GCN}} = 1.0 / 2.4 = 5/12 \\approx 0.416667$。\n$C_{\\mathrm{SAGE}} = |(5/12)(-2.4) + 0| = |-1.0| = 1.0$。\n$r_{\\mathrm{SAGE}} = 1.0 / 2.4 = 5/12 \\approx 0.416667$。\n\n- **测试 4:** $\\theta^{(0)} = [0.0, 0.0, 0.0, 1.0]$\n$C_0 = |1.0 - 0.0| = 1.0$。\n$\\theta^{(0)}_4 - \\theta^{(0)}_1 = 1.0$。 $\\theta^{(0)}_3 - \\theta^{(0)}_2 = 0.0$。\n$C_{\\mathrm{GCN}} = |(5/12)(1.0) + 0| = 5/12$。\n$r_{\\mathrm{GCN}} = (5/12) / 1.0 = 5/12 \\approx 0.416667$。\n$C_{\\mathrm{SAGE}} = |(5/12)(1.0) + 0| = 5/12$。\n$r_{\\mathrm{SAGE}} = (5/12) / 1.0 = 5/12 \\approx 0.416667$。\n\n这些计算展示了GNN层的平滑效应，该效应降低了端到端信号的对比度。此效应的大小取决于GNN架构和初始特征分布。",
            "answer": "[0.4749880791485601,0.4880952380952381,0.0,0.0,0.4166666666666667,0.4166666666666667,0.4166666666666667,0.4166666666666667]"
        },
        {
            "introduction": "为了构建更精确、更具物理一致性的模型，我们可以超越传统的“黑箱”GNN，迈向物理知识与神经网络融合的前沿领域。通过将已知的物理定律（如直流潮流方程）直接嵌入到模型架构中，我们可以引导 GNN 的学习过程，使其预测结果不仅数据驱动，而且遵循物理约束。这项高级实践将指导您构建一个混合系统，其中 GNN 的初始预测会由一个可微分的物理层进行修正，您将通过这个完整的计算图计算端到端的梯度，体验物理知识增强学习的强大威力。",
            "id": "4094187",
            "problem": "考虑一个用于电力系统分析的简化混合学习系统，其中图神经网络（GNN）预测初始节点电压相角，而一个物理信息层在直流（DC）潮流近似下执行一个梯度步长来对其进行优化。目标是计算基于物理的损失函数相对于GNN参数的端到端梯度，并验证优化步骤是否改善了对直流潮流约束的满足程度。\n\n基本原理：直流潮流近似表明，N个母线上的有功功率注入向量 $\\mathbf{P} \\in \\mathbb{R}^{N}$ 与节点电压相角 $\\boldsymbol{\\theta} \\in \\mathbb{R}^{N}$ 通过由线路电纳构建的加权图拉普拉斯矩阵 $\\mathbf{B} \\in \\mathbb{R}^{N \\times N}$ 线性相关，关系为 $\\mathbf{P} = \\mathbf{B} \\boldsymbol{\\theta}$。加权邻接矩阵为 $\\mathbf{A} \\in \\mathbb{R}^{N \\times N}$，对于电纳为 $b_{ij}$ 的母线 $i$ 和 $j$ 之间的无向线路，其元素为 $\\mathbf{A}_{ij} = b_{ij}$。$\\mathbf{B}$ 是相应的拉普拉斯矩阵，其元素为 $\\mathbf{B}_{ii} = \\sum_{j} b_{ij}$ 且当 $i \\neq j$ 时 $\\mathbf{B}_{ij} = -b_{ij}$。角度单位为弧度，所有功率注入均为标幺值。\n\nGNN预测：令 $\\mathbf{x} \\in \\mathbb{R}^{N}$ 表示节点特征，此处取为有功功率注入 $\\mathbf{P}$。一个单层线性GNN通过以下公式预测初始相角 $\\widehat{\\boldsymbol{\\theta}}$：\n$$\n\\widehat{\\boldsymbol{\\theta}} = w_{\\mathrm{self}} \\, \\mathbf{x} + w_{\\mathrm{neigh}} \\, \\mathbf{A} \\mathbf{x},\n$$\n其中 $w_{\\mathrm{self}} \\in \\mathbb{R}$ 和 $w_{\\mathrm{neigh}} \\in \\mathbb{R}$ 是标量可训练参数。\n\n物理优化层：考虑基于物理的目标函数\n$$\nJ(\\boldsymbol{\\theta}) = \\frac{1}{2} \\left\\| \\mathbf{B} \\boldsymbol{\\theta} - \\mathbf{P} \\right\\|_{2}^{2} + \\frac{\\lambda_{s}}{2} \\, \\theta_{s}^{2},\n$$\n其中 $\\theta_{s}$ 是平衡节点相角，$\\lambda_{s} \\in \\mathbb{R}$ 是平衡相角惩罚系数。令 $\\mathbf{e}_{s} \\in \\mathbb{R}^{N}$ 为平衡节点选择向量，其在平衡节点索引处为1，其他位置为0，且 $\\mathbf{E}_{s} = \\mathbf{e}_{s} \\mathbf{e}_{s}^{\\top}$。一个物理优化步骤使用步长为 $\\alpha \\in \\mathbb{R}$ 的梯度下降法：\n$$\n\\boldsymbol{\\theta}^{+} = \\widehat{\\boldsymbol{\\theta}} - \\alpha \\, \\nabla_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) \\big|_{\\boldsymbol{\\theta} = \\widehat{\\boldsymbol{\\theta}}},\n$$\n其中\n$$\n\\nabla_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) = \\mathbf{B}^{\\top} (\\mathbf{B} \\boldsymbol{\\theta} - \\mathbf{P}) + \\lambda_{s} \\, \\mathbf{E}_{s} \\boldsymbol{\\theta}.\n$$\n\n端到端损失：将优化后的端到端损失定义为\n$$\nL = \\frac{1}{2} \\left\\| \\mathbf{B} \\boldsymbol{\\theta}^{+} - \\mathbf{P} \\right\\|_{2}^{2} + \\frac{\\lambda_{s}}{2} \\, (\\theta^{+}_{s})^{2}.\n$$\n\n任务：对每个给定的测试用例，执行以下操作：\n- 从给定网络构建 $\\mathbf{A}$ 和 $\\mathbf{B}$。\n- 通过一个物理梯度步骤计算 $\\widehat{\\boldsymbol{\\theta}}$ 和优化后的 $\\boldsymbol{\\theta}^{+}$。\n- 通过物理层的精确微分计算端到端梯度 $\\frac{\\partial L}{\\partial w_{\\mathrm{self}}}$ 和 $\\frac{\\partial L}{\\partial w_{\\mathrm{neigh}}}$。\n- 通过检查残差范数 $\\left\\| \\mathbf{B} \\widehat{\\boldsymbol{\\theta}} - \\mathbf{P} \\right\\|_{2}$ 是否在优化后严格减小至 $\\left\\| \\mathbf{B} \\boldsymbol{\\theta}^{+} - \\mathbf{P} \\right\\|_{2}$，来验证优化是否改善了对直流潮流约束的满足程度。\n\n您必须将所有测试用例的结果汇总到单行中。使用以下格式：一个由方括号括起来的逗号分隔列表，其中每个测试用例的结果本身是一个形式为 $[g_{\\mathrm{self}}, g_{\\mathrm{neigh}}, \\mathrm{improved}]$ 的列表，其中 $g_{\\mathrm{self}}$ 和 $g_{\\mathrm{neigh}}$ 是浮点数，$\\mathrm{improved}$ 是布尔值。例如，输出必须类似于 $[[g_{1s}, g_{1n}, \\mathrm{True}], [g_{2s}, g_{2n}, \\mathrm{False}], \\dots]$。\n\n角度单位是弧度；功率注入是标幺值。输出中不出现其他物理单位。\n\n测试套件规范（在程序中索引从零开始）：\n- 案例1（正常路径）：$N = 3$，平衡节点索引 $s = 0$，线路电纳为 $(0,1,10)$ 和 $(1,2,8)$，$\\mathbf{P} = [0.5, -0.2, -0.3]$，$w_{\\mathrm{self}} = 0.8$，$w_{\\mathrm{neigh}} = 0.2$，$\\alpha = 0.08$，$\\lambda_{s} = 50$。\n- 案例2（初始完全可行）：$N = 3$，平衡节点索引 $s = 1$，线路 $(0,1,9)$ 和 $(1,2,9)$，$\\mathbf{P} = [0.0, 0.0, 0.0]$，$w_{\\mathrm{self}} = 0.3$，$w_{\\mathrm{neigh}} = -0.1$，$\\alpha = 0.10$，$\\lambda_{s} = 20$。\n- 案例3（更大型网络）：$N = 4$，平衡节点索引 $s = 1$，环形线路 $(0,1,8)$、$(1,2,5)$、$(2,3,7)$、$(3,0,6)$，$\\mathbf{P} = [0.6, -0.1, -0.2, -0.3]$，$w_{\\mathrm{self}} = 1.0$，$w_{\\mathrm{neigh}} = 0.0$，$\\alpha = 0.12$，$\\lambda_{s} = 40$。\n- 案例4（无优化的边界情况）：$N = 2$，平衡节点索引 $s = 0$，线路 $(0,1,12)$，$\\mathbf{P} = [0.4, -0.4]$，$w_{\\mathrm{self}} = 0.5$，$w_{\\mathrm{neigh}} = 0.5$，$\\alpha = 0.0$，$\\lambda_{s} = 10$。\n\n您的程序应生成单行输出，包含如上所述格式为 $[g_{\\mathrm{self}}, g_{\\mathrm{neigh}}, \\mathrm{improved}]$ 的结果，并以逗号分隔列表的形式包含在方括号中。",
            "solution": "问题陈述已经过验证，被认为是科学上合理、定义明确且完整的。它提供了一套清晰、自洽的定义和参数，来解决电力系统中物理信息机器学习领域的特定计算问题。其基本原理，包括直流潮流近似和基于梯度的优化，是标准的且表述正确。因此，我们可以进行完整的求解。\n\n任务的核心是计算端到端损失函数 $L$ 相对于一个简单图神经网络（GNN）的参数 $w_{\\mathrm{self}}$ 和 $w_{\\mathrm{neigh}}$ 的梯度。GNN的输出由一个物理信息层进行优化，梯度计算需要通过整个计算图应用链式法则。\n\n首先，我们建立电力系统和模型组件的矩阵和向量表示。系统有 $N$ 个母线。\n- 网络拓扑和线路电纳 $b_{ij}$ 被编码在加权邻接矩阵 $\\mathbf{A} \\in \\mathbb{R}^{N \\times N}$ 中，其中如果母线 $i$ 和 $j$ 之间有线路连接，则 $\\mathbf{A}_{ij} = \\mathbf{A}_{ji} = b_{ij}$，否则 $\\mathbf{A}_{ij} = 0$。\n- 加权图拉普拉斯矩阵为 $\\mathbf{B} \\in \\mathbb{R}^{N \\times N}$，定义为 $\\mathbf{B}_{ii} = \\sum_{j \\neq i} \\mathbf{A}_{ij}$ 且当 $i \\neq j$ 时 $\\mathbf{B}_{ij} = -\\mathbf{A}_{ij}$。鉴于 $\\mathbf{A}$ 是对称的，$\\mathbf{B}$ 也是对称的，因此 $\\mathbf{B}^{\\top} = \\mathbf{B}$。\n- 索引为 $s$ 的平衡节点使用选择向量 $\\mathbf{e}_{s} \\in \\mathbb{R}^{N}$ 来标识，该向量在索引 $s$ 处为 $1$，其他位置为 $0$。相应的惩罚矩阵为 $\\mathbf{E}_{s} = \\mathbf{e}_{s} \\mathbf{e}_{s}^{\\top}$。\n- 节点有功功率注入向量是 $\\mathbf{P} \\in \\mathbb{R}^{N}$，它作为GNN的节点特征，即 $\\mathbf{x} = \\mathbf{P}$。\n\n整个过程可以描述为一个前向传播（预测和优化）和一个后向传播（梯度计算）。\n\n**1. 前向传播**\n\n前向传播包括两个主要阶段：GNN预测和基于物理的优化。\n\n**a. GNN预测：**\n单层线性GNN生成电压相角的初始估计值 $\\widehat{\\boldsymbol{\\theta}} \\in \\mathbb{R}^{N}$，作为其参数 $w_{\\mathrm{self}}$ 和 $w_{\\mathrm{neigh}}$ 的函数：\n$$\n\\widehat{\\boldsymbol{\\theta}}(w_{\\mathrm{self}}, w_{\\mathrm{neigh}}) = w_{\\mathrm{self}} \\mathbf{P} + w_{\\mathrm{neigh}} \\mathbf{A} \\mathbf{P}\n$$\n\n**b. 物理优化：**\n初始相角 $\\widehat{\\boldsymbol{\\theta}}$ 通过对基于物理的目标函数 $J(\\boldsymbol{\\theta})$ 执行一步梯度下降来进行优化：\n$$\nJ(\\boldsymbol{\\theta}) = \\frac{1}{2} \\left\\| \\mathbf{B} \\boldsymbol{\\theta} - \\mathbf{P} \\right\\|_{2}^{2} + \\frac{\\lambda_{s}}{2} \\theta_{s}^{2}\n$$\n该目标函数关于 $\\boldsymbol{\\theta}$ 的梯度是：\n$$\n\\nabla_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) = \\mathbf{B}^{\\top}(\\mathbf{B} \\boldsymbol{\\theta} - \\mathbf{P}) + \\lambda_{s} \\mathbf{E}_{s} \\boldsymbol{\\theta} = (\\mathbf{B}^{2} + \\lambda_{s} \\mathbf{E}_{s})\\boldsymbol{\\theta} - \\mathbf{B}\\mathbf{P}\n$$\n其中我们使用了 $\\mathbf{B}^{\\top} = \\mathbf{B}$。我们用 $\\mathbf{H} = \\nabla_{\\boldsymbol{\\theta}}^{2} J(\\boldsymbol{\\theta}) = \\mathbf{B}^{2} + \\lambda_{s} \\mathbf{E}_{s}$ 表示 $J(\\boldsymbol{\\theta})$ 的海森矩阵。梯度可以写为 $\\nabla_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) = \\mathbf{H}\\boldsymbol{\\theta} - \\mathbf{B}\\mathbf{P}$。\n\n单步优化使用步长 $\\alpha$ 将相角从 $\\widehat{\\boldsymbol{\\theta}}$ 更新为 $\\boldsymbol{\\theta}^{+}$：\n$$\n\\boldsymbol{\\theta}^{+} = \\widehat{\\boldsymbol{\\theta}} - \\alpha \\left. \\nabla_{\\boldsymbol{\\theta}} J(\\boldsymbol{\\theta}) \\right|_{\\boldsymbol{\\theta} = \\widehat{\\boldsymbol{\\theta}}} = \\widehat{\\boldsymbol{\\theta}} - \\alpha (\\mathbf{H}\\widehat{\\boldsymbol{\\theta}} - \\mathbf{B}\\mathbf{P}) = (\\mathbf{I} - \\alpha \\mathbf{H})\\widehat{\\boldsymbol{\\theta}} + \\alpha \\mathbf{B}\\mathbf{P}\n$$\n\n**c. 改善验证：**\n问题要求验证此优化步骤是否改善了对直流潮流约束的满足程度。这是通过比较优化前后的功率残差向量的范数来完成的。\n- 初始残差范数： $N_{\\mathrm{init}} = \\left\\| \\mathbf{B} \\widehat{\\boldsymbol{\\theta}} - \\mathbf{P} \\right\\|_{2}$\n- 优化后残差范数： $N_{\\mathrm{final}} = \\left\\| \\mathbf{B} \\boldsymbol{\\theta}^{+} - \\mathbf{P} \\right\\|_{2}$\n- 如果 $N_{\\mathrm{final}}  N_{\\mathrm{init}}$，则认为优化有所改善。\n\n**2. 后向传播（端到端梯度计算）**\n\n目标是计算端到端损失 $L$ 相对于GNN参数 $w_{\\mathrm{self}}$ 和 $w_{\\mathrm{neigh}}$ 的梯度。损失 $L$ 定义为在优化后的相角处评估的物理目标函数：\n$$\nL = J(\\boldsymbol{\\theta}^{+}) = \\frac{1}{2} \\left\\| \\mathbf{B} \\boldsymbol{\\theta}^{+} - \\mathbf{P} \\right\\|_{2}^{2} + \\frac{\\lambda_{s}}{2} (\\theta^{+}_{s})^{2}\n$$\n我们应用链式法则。对于一个通用参数 $w \\in \\{w_{\\mathrm{self}}, w_{\\mathrm{neigh}}\\}$：\n$$\n\\frac{\\partial L}{\\partial w} = \\frac{\\partial L}{\\partial \\boldsymbol{\\theta}^{+}} \\frac{\\partial \\boldsymbol{\\theta}^{+}}{\\partial \\widehat{\\boldsymbol{\\theta}}} \\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w}\n$$\n在向量表示法中，这可以更精确地写为：\n$$\n\\frac{\\partial L}{\\partial w} = \\left(\\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w}\\right)^{\\top} \\left(\\frac{\\partial \\boldsymbol{\\theta}^{+}}{\\partial \\widehat{\\boldsymbol{\\theta}}}\\right)^{\\top} \\nabla_{\\boldsymbol{\\theta}^{+}}L\n$$\n我们来计算每一项：\n\n- $\\nabla_{\\boldsymbol{\\theta}^{+}}L$：$L$ 相对于 $\\boldsymbol{\\theta}^{+}$ 的梯度。由于 $L=J(\\boldsymbol{\\theta}^{+})$，其梯度形式与 $\\nabla J$ 相同：\n$$\n\\nabla_{\\boldsymbol{\\theta}^{+}}L = \\mathbf{H} \\boldsymbol{\\theta}^{+} - \\mathbf{B}\\mathbf{P}\n$$\n\n- $\\left(\\frac{\\partial \\boldsymbol{\\theta}^{+}}{\\partial \\widehat{\\boldsymbol{\\theta}}}\\right)^{\\top}$：优化映射的雅可比矩阵的转置。根据更新规则 $\\boldsymbol{\\theta}^{+} = (\\mathbf{I} - \\alpha \\mathbf{H})\\widehat{\\boldsymbol{\\theta}} + \\alpha \\mathbf{B}\\mathbf{P}$，雅可比矩阵为：\n$$\n\\frac{\\partial \\boldsymbol{\\theta}^{+}}{\\partial \\widehat{\\boldsymbol{\\theta}}} = \\mathbf{I} - \\alpha \\mathbf{H}\n$$\n由于 $\\mathbf{H}$ 是对称的，这个雅可比矩阵也是对称的。我们称之为 $\\mathbf{M} = \\mathbf{I} - \\alpha \\mathbf{H}$。\n\n- $\\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w}$：GNN输出相对于其参数的导数。\n$$\n\\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w_{\\mathrm{self}}} = \\mathbf{P} \\quad \\text{和} \\quad \\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w_{\\mathrm{neigh}}} = \\mathbf{A} \\mathbf{P}\n$$\n\n我们定义上游梯度向量 $\\mathbf{u}$，它是反向传播到 $\\widehat{\\boldsymbol{\\theta}}$ 的 $L$ 的梯度：\n$$\n\\mathbf{u} = \\left(\\frac{\\partial \\boldsymbol{\\theta}^{+}}{\\partial \\widehat{\\boldsymbol{\\theta}}}\\right)^{\\top} \\nabla_{\\boldsymbol{\\theta}^{+}}L = (\\mathbf{I} - \\alpha \\mathbf{H}) (\\mathbf{H} \\boldsymbol{\\theta}^{+} - \\mathbf{B}\\mathbf{P})\n$$\n最终的梯度 $g_{\\mathrm{self}}$ 和 $g_{\\mathrm{neigh}}$ 是通过将这个上游梯度投影到GNN函数的偏导数上得到的：\n$$\ng_{\\mathrm{self}} = \\frac{\\partial L}{\\partial w_{\\mathrm{self}}} = \\left(\\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w_{\\mathrm{self}}}\\right)^{\\top} \\mathbf{u} = \\mathbf{P}^{\\top} \\mathbf{u}\n$$\n$$\ng_{\\mathrm{neigh}} = \\frac{\\partial L}{\\partial w_{\\mathrm{neigh}}} = \\left(\\frac{\\partial \\widehat{\\boldsymbol{\\theta}}}{\\partial w_{\\mathrm{neigh}}}\\right)^{\\top} \\mathbf{u} = (\\mathbf{A}\\mathbf{P})^{\\top} \\mathbf{u}\n$$\n\n**算法流程**\n\n对于每个测试用例，执行以下步骤：\n1.  初始化参数：$N, s,$ 线路, $\\mathbf{P}, w_{\\mathrm{self}}, w_{\\mathrm{neigh}}, \\alpha, \\lambda_{s}$。\n2.  构建矩阵：从给定的网络数据构建 $\\mathbf{A}$、$\\mathbf{B}$ 和 $\\mathbf{E}_s$。\n3.  计算GNN预测：$\\widehat{\\boldsymbol{\\theta}} = w_{\\mathrm{self}} \\mathbf{P} + w_{\\mathrm{neigh}} \\mathbf{A} \\mathbf{P}$。\n4.  计算物理相关矩阵：$\\mathbf{H} = \\mathbf{B}^{2} + \\lambda_{s} \\mathbf{E}_{s}$。\n5.  执行优化：$\\boldsymbol{\\theta}^{+} = (\\mathbf{I} - \\alpha \\mathbf{H})\\widehat{\\boldsymbol{\\theta}} + \\alpha \\mathbf{B}\\mathbf{P}$。\n6.  检查改善情况：计算 $N_{\\mathrm{init}} = \\|\\mathbf{B} \\widehat{\\boldsymbol{\\theta}} - \\mathbf{P}\\|_{2}$ 和 $N_{\\mathrm{final}} = \\|\\mathbf{B} \\boldsymbol{\\theta}^{+} - \\mathbf{P}\\|_{2}$。设置 `improved = (N_final  N_init)`。\n7.  计算损失梯度：$\\nabla_{\\boldsymbol{\\theta}^{+}}L = \\mathbf{H} \\boldsymbol{\\theta}^{+} - \\mathbf{B}\\mathbf{P}$。\n8.  反向传播梯度：$\\mathbf{u} = (\\mathbf{I} - \\alpha \\mathbf{H}) \\nabla_{\\boldsymbol{\\theta}^{+}}L$。\n9.  计算最终梯度：$g_{\\mathrm{self}} = \\mathbf{P}^{\\top} \\mathbf{u}$ 和 $g_{\\mathrm{neigh}} = (\\mathbf{A}\\mathbf{P})^{\\top} \\mathbf{u}$。\n10. 存储当前案例的元组 $(g_{\\mathrm{self}}, g_{\\mathrm{neigh}}, \\text{improved})$。\n处理完所有案例后，将结果汇总成一个列表。",
            "answer": "[[4.281177699317582,0.9135008581024317,True],[-0.0,0.0,False],[0.15174092143004653,0.0,True],[0.0,0.0,False]]"
        }
    ]
}