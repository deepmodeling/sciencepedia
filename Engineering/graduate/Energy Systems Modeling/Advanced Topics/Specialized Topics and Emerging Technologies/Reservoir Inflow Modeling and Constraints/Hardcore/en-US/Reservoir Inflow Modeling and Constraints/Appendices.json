{
    "hands_on_practices": [
        {
            "introduction": "Effective reservoir management begins with a solid understanding of the physical processes that govern water availability. This first practice challenges you to model reservoir inflow from first principles, starting with a hypothetical rainfall event and a simplified catchment response model . By applying the convolution integral to represent the rainfall-runoff process, you will derive the total inflow volume and solve the reservoir's mass balance equation analytically to determine a sustainable release strategy. This exercise grounds your understanding in the fundamental link between hydrology and water resource operations.",
            "id": "4118220",
            "problem": "A single-reservoir hydropower system receives hydrologic inflow from an upstream catchment. The inflow is modeled from first principles via mass conservation and a linear rainfall–runoff representation. The fundamental mass balance for reservoir storage is $ \\frac{dS(t)}{dt} = I(t) - R(t) - E(t) $, where $ S(t) $ is storage, $ I(t) $ is inflow, $ R(t) $ is release, and $ E(t) $ represents evaporative losses. Hydrologic inflow is defined as the runoff response to effective precipitation convolved with a Unit Hydrograph (UH). Assume the following scientifically consistent specifications and constants:\n\n- Catchment area $ A_c = 1.2 \\times 10^{9} \\,\\text{m}^{2} $ with runoff coefficient $ C = 0.6 $.\n- Effective precipitation intensity $ p(t) = r_{0} \\exp\\!\\left(-\\frac{t}{\\theta}\\right) $ for $ t \\ge 0 $, with $ r_{0} = 1.5 \\times 10^{-5} \\,\\text{m s}^{-1} $ and $ \\theta = 7.2 \\times 10^{3} \\,\\text{s} $.\n- Unit Hydrograph (UH) $ u(t) = \\frac{1}{\\tau} \\exp\\!\\left(-\\frac{t}{\\tau}\\right) $ for $ t \\ge 0 $, with $ \\tau = 7.2 \\times 10^{4} \\,\\text{s} $.\n- Reservoir surface area is approximated constant at $ A_{r} = 3.0 \\times 10^{7} \\,\\text{m}^{2} $ over the horizon. The evaporation rate is $ e = 6.0 \\times 10^{-3} \\,\\text{m day}^{-1} $, assumed constant over the horizon.\n- The planning horizon is $ T = 1.728 \\times 10^{5} \\,\\text{s} $ from $ t = 0 $ to $ t = T $.\n- The release policy is constant $ R(t) = R_{0} $ subject to operational constraints: minimum environmental flow $ R_{\\min} = 10 \\,\\text{m}^{3} \\text{ s}^{-1} $ and maximum turbine capacity $ R_{\\max} = 500 \\,\\text{m}^{3} \\text{ s}^{-1} $.\n- Initial storage $ S(0) = 2.50 \\times 10^{8} \\,\\text{m}^{3} $ and target terminal storage $ S(T) = 2.65 \\times 10^{8} \\,\\text{m}^{3} $.\n\nUsing mass conservation and the hydrologic inflow definition $ I(t) = C A_{c} \\int_{0}^{t} p(\\xi)\\, u(t-\\xi)\\, d\\xi $, derive the closed-form expression for $ \\int_{0}^{T} I(t)\\, dt $ and compute the constant release $ R_{0} $ that exactly achieves the target terminal storage $ S(T) $ over the specified horizon, accounting for evaporation losses $ E(t) = e_{s} A_{r} $ with $ e_{s} $ the evaporation rate in $ \\text{m s}^{-1} $. Verify that the computed $ R_{0} $ respects the given operational constraints. Round your final numeric answer to four significant figures. Express the final release in cubic meters per second ($\\text{m}^3\\,\\text{s}^{-1}$).",
            "solution": "The solution to this problem proceeds by applying the principle of mass conservation to the reservoir over the specified planning horizon. The governing equation is the integral form of the mass balance.\n\nThe fundamental mass balance for the reservoir storage $S(t)$ is given by:\n$$\n\\frac{dS(t)}{dt} = I(t) - R(t) - E(t)\n$$\nwhere $I(t)$ is the inflow, $R(t)$ is the release, and $E(t)$ is the evaporation loss. To find the relationship between the total volumes over the planning horizon from $t=0$ to $t=T$, we integrate this equation with respect to time:\n$$\n\\int_{0}^{T} \\frac{dS(t)}{dt} dt = \\int_{0}^{T} I(t) dt - \\int_{0}^{T} R(t) dt - \\int_{0}^{T} E(t) dt\n$$\nThe left side evaluates to the change in storage, $S(T) - S(0)$. Let $V_I = \\int_{0}^{T} I(t) dt$ be the total inflow volume, $V_R = \\int_{0}^{T} R(t) dt$ be the total release volume, and $V_E = \\int_{0}^{T} E(t) dt$ be the total evaporation volume. The integrated mass balance is:\n$$\nS(T) - S(0) = V_I - V_R - V_E\n$$\nOur goal is to solve for the constant release $R_0$. Each term in this equation must be determined.\n\nThe total change in storage is given by the initial and terminal conditions:\n$$\nS(T) - S(0) = 2.65 \\times 10^{8} \\,\\text{m}^{3} - 2.50 \\times 10^{8} \\,\\text{m}^{3} = 1.5 \\times 10^{7} \\,\\text{m}^{3}\n$$\nThe release policy is a constant release $R(t) = R_0$. The total release volume over the horizon $T$ is:\n$$\nV_R = \\int_{0}^{T} R_0 dt = R_0 T\n$$\nThe evaporation loss rate is $E(t) = e_s A_r$, where $A_r$ is the constant reservoir surface area and $e_s$ is the constant evaporation rate in $\\text{m s}^{-1}$. First, we convert the given rate $e = 6.0 \\times 10^{-3} \\,\\text{m day}^{-1}$ to SI units. Knowing that $1$ day = $86400$ s:\n$$\ne_s = \\frac{6.0 \\times 10^{-3} \\,\\text{m}}{1 \\,\\text{day}} \\times \\frac{1 \\,\\text{day}}{86400 \\,\\text{s}} = \\frac{6.0 \\times 10^{-3}}{8.64 \\times 10^4} \\,\\text{m s}^{-1}\n$$\nThe total evaporation volume is:\n$$\nV_E = \\int_{0}^{T} e_s A_r dt = e_s A_r T = \\left(\\frac{6.0 \\times 10^{-3}}{8.64 \\times 10^4}\\right) (3.0 \\times 10^7) (1.728 \\times 10^5) \\,\\text{m}^3\n$$\nNoticing that $(1.728 \\times 10^5) / (8.64 \\times 10^4) = 2$, we can simplify:\n$$\nV_E = (6.0 \\times 10^{-3})(3.0 \\times 10^7)(2) = 36 \\times 10^4 \\,\\text{m}^3 = 3.6 \\times 10^5 \\,\\text{m}^3\n$$\nThe most complex term is the total inflow volume, $V_I$. The inflow rate $I(t)$ is defined by a convolution integral:\n$$\nI(t) = C A_{c} \\int_{0}^{t} p(\\xi)\\, u(t-\\xi)\\, d\\xi\n$$\nSubstituting the given functions for precipitation $p(t) = r_0 \\exp(-t/\\theta)$ and the Unit Hydrograph $u(t) = \\frac{1}{\\tau} \\exp(-t/\\tau)$:\n$$\nI(t) = C A_c \\int_{0}^{t} r_0 \\exp(-\\xi/\\theta) \\, \\frac{1}{\\tau} \\exp(-(t-\\xi)/\\tau) \\, d\\xi\n$$\n$$\nI(t) = \\frac{C A_c r_0}{\\tau} \\exp(-t/\\tau) \\int_{0}^{t} \\exp\\left(-\\frac{\\xi}{\\theta} + \\frac{\\xi}{\\tau}\\right) d\\xi = \\frac{C A_c r_0}{\\tau} \\exp(-t/\\tau) \\int_{0}^{t} \\exp\\left(\\xi \\left(\\frac{1}{\\tau} - \\frac{1}{\\theta}\\right)\\right) d\\xi\n$$\nAssuming $\\tau \\neq \\theta$, the integral evaluates to:\n$$\n\\int_{0}^{t} \\exp\\left(\\xi \\frac{\\theta-\\tau}{\\tau\\theta}\\right) d\\xi = \\left[ \\frac{\\tau\\theta}{\\theta-\\tau} \\exp\\left(\\xi \\frac{\\theta-\\tau}{\\tau\\theta}\\right) \\right]_0^t = \\frac{\\tau\\theta}{\\theta-\\tau} \\left( \\exp\\left(t \\left(\\frac{1}{\\tau}-\\frac{1}{\\theta}\\right)\\right) - 1 \\right)\n$$\nSubstituting this back into the expression for $I(t)$:\n$$\nI(t) = \\frac{C A_c r_0}{\\tau} \\exp(-t/\\tau) \\frac{\\tau\\theta}{\\theta-\\tau} \\left( \\exp(t/\\tau) \\exp(-t/\\theta) - 1 \\right)\n$$\n$$\nI(t) = \\frac{C A_c r_0 \\theta}{\\theta-\\tau} \\left( \\exp(-t/\\theta) - \\exp(-t/\\tau) \\right)\n$$\nThis is the closed-form expression for the inflow rate $I(t)$. To find the total inflow volume $V_I$, we integrate $I(t)$ from $0$ to $T$:\n$$\nV_I = \\int_{0}^{T} I(t) dt = \\frac{C A_c r_0 \\theta}{\\theta-\\tau} \\int_{0}^{T} \\left( \\exp(-t/\\theta) - \\exp(-t/\\tau) \\right) dt\n$$\n$$\nV_I = \\frac{C A_c r_0 \\theta}{\\theta-\\tau} \\left[ [-\\theta \\exp(-t/\\theta)]_{0}^{T} - [-\\tau \\exp(-t/\\tau)]_{0}^{T} \\right]\n$$\n$$\nV_I = \\frac{C A_c r_0 \\theta}{\\theta-\\tau} \\left[ (-\\theta \\exp(-T/\\theta) + \\theta) - (-\\tau \\exp(-T/\\tau) + \\tau) \\right]\n$$\nThis gives the required closed-form expression for the total inflow volume:\n$$\nV_I = \\int_{0}^{T} I(t) dt = \\frac{C A_c r_0 \\theta}{\\theta-\\tau} \\left[ \\theta(1 - \\exp(-T/\\theta)) - \\tau(1 - \\exp(-T/\\tau)) \\right]\n$$\nNow, we substitute the given numerical values:\n$C = 0.6$, $A_c = 1.2 \\times 10^9 \\,\\text{m}^2$, $r_0 = 1.5 \\times 10^{-5} \\,\\text{m s}^{-1}$, $\\theta = 7.2 \\times 10^3 \\,\\text{s}$, $\\tau = 7.2 \\times 10^4 \\,\\text{s}$, and $T = 1.728 \\times 10^5 \\,\\text{s}$.\nThe time constant ratios are $T/\\theta = (1.728 \\times 10^5)/(7.2 \\times 10^3) = 24$ and $T/\\tau = (1.728 \\times 10^5)/(7.2 \\times 10^4) = 2.4$.\nThe pre-factor is:\n$$\n\\frac{C A_c r_0 \\theta}{\\theta-\\tau} = \\frac{(0.6)(1.2 \\times 10^9)(1.5 \\times 10^{-5})(7.2 \\times 10^3)}{7.2 \\times 10^3 - 7.2 \\times 10^4} = \\frac{7.776 \\times 10^7}{-6.48 \\times 10^4} = -1200 \\,\\text{m}^3\\,\\text{s}^{-1}\n$$\nThe term in brackets is:\n$$\n(7.2 \\times 10^3)(1 - \\exp(-24)) - (7.2 \\times 10^4)(1 - \\exp(-2.4)) \\,\\text{s}\n$$\nThe value of $\\exp(-24)$ is negligible.\n$$\n\\approx (7.2 \\times 10^3) - (7.2 \\times 10^4)(1 - \\exp(-2.4)) = 7200 - 72000(1 - 0.09071795...) = 7200 - 65468.307... = -58268.307... \\,\\text{s}\n$$\nThus, the total inflow volume is:\n$$\nV_I \\approx (-1200) \\times (-58268.307) = 69921968.9... \\,\\text{m}^3 \\approx 6.9922 \\times 10^7 \\,\\text{m}^3\n$$\nNow we assemble the mass balance equation to solve for $R_0$:\n$$\nS(T) - S(0) = V_I - R_0 T - V_E\n$$\n$$\nR_0 T = V_I - (S(T) - S(0)) - V_E\n$$\n$$\nR_0 = \\frac{V_I - (S(T) - S(0)) - V_E}{T}\n$$\nSubstituting the calculated volumes and the horizon $T$:\n$$\nR_0 = \\frac{69921968.9 - 1.5 \\times 10^7 - 3.6 \\times 10^5}{1.728 \\times 10^5}\n$$\n$$\nR_0 = \\frac{69921968.9 - 15000000 - 360000}{172800} = \\frac{54561968.9}{172800} \\approx 315.7521 \\,\\text{m}^3\\,\\text{s}^{-1}\n$$\nRounding to four significant figures, we get $R_0 = 315.8 \\,\\text{m}^3\\,\\text{s}^{-1}$.\n\nFinally, we must verify that this release rate satisfies the operational constraints: $R_{\\min} = 10 \\,\\text{m}^3\\,\\text{s}^{-1}$ and $R_{\\max} = 500 \\,\\text{m}^3\\,\\text{s}^{-1}$.\nThe computed value $R_0 = 315.8 \\,\\text{m}^3\\,\\text{s}^{-1}$ is indeed between the minimum and maximum allowed releases:\n$10 \\le 315.8 \\le 500$.\nThe result is therefore valid.",
            "answer": "$$\\boxed{315.8}$$"
        },
        {
            "introduction": "While analytical solutions provide deep insight, practical reservoir operation is managed through dynamic, discrete-time simulations that account for a complex set of interacting constraints. This practice guides you in building such a simulator from the ground up . You will implement the core mass balance equation in a discrete-time form and then layer on a cascade of realistic operational rules, including storage limits, turbine capacity, and ramp-rate constraints. This task is essential for developing the algorithmic thinking required to model and control real-world energy and water systems.",
            "id": "4118229",
            "problem": "Construct a program that enforces physically consistent reservoir mass balance and state update constraints over a discrete time horizon. The reservoir is represented as a control volume with storage $s(t)$ measured in cubic meters, inflow rate $I(t)$ measured in cubic meters per second, release rate $R(t)$ measured in cubic meters per second, and evaporation rate $E(t)$ measured in meters per second. The surface area is modeled as a storage-dependent function $A(s)$ measured in square meters. The program must derive the discrete-time state update from conservation of mass and then enforce operational constraints at each time step.\n\nStart from the conservation of mass for a control volume: the rate of change of stored water equals the net inflow minus the net outflow and losses. Derive the discrete-time update $s_{t+1}$ from this fundamental law using a first-order explicit time discretization over a fixed time step $\\Delta t$, assuming piecewise constant inflow, release, and evaporation over each interval. Model evaporation as a flux $E_t$ in meters per second across the instantaneous surface area $A(s_t)$ in square meters, which yields a volumetric loss rate $E_t A(s_t)$ in cubic meters per second.\n\nEnforce the following constraints, all expressed per time step $t$:\n- Storage bounds: $S_{\\min} \\le s_t \\le S_{\\max}$ for all $t$. If the unconstrained update would produce $s_{t+1}  S_{\\max}$, the excess must be spilled so that $s_{t+1} = S_{\\max}$. If the unconstrained update would produce $s_{t+1}  S_{\\min}$, the release must be curtailed to exactly meet $s_{t+1} = S_{\\min}$.\n- Environmental minimum release: $\\underline{R} \\le R_t$.\n- Turbine capacity (maximum release): $R_t \\le \\overline{R}$.\n- Ramp rate constraint: $\\lvert R_t - R_{t-1} \\rvert \\le \\rho$, where $\\rho$ is the maximum change in release per time step. The initial previous release $R_{-1}$ is specified.\n\nDefine the surface area function as $A(s) = A_0 + \\alpha s$, where $A_0$ is a positive constant in square meters and $\\alpha$ is a nonnegative constant in inverse meters. When curtailing $R_t$ for minimum storage, ensure the chosen $R_t$ is the largest value that keeps $s_{t+1} \\ge S_{\\min}$ while also respecting the environmental minimum release if physically possible; if the environmental minimum release cannot be met without violating $S_{\\min}$, set $R_t$ to the maximum feasible value and report that the environmental flow was not met.\n\nUnits and numerical requirements:\n- Express all storages $s_t$ in cubic meters, all inflows $I_t$ in cubic meters per second, all releases $R_t$ in cubic meters per second, the evaporation rate $E_t$ in meters per second, the surface area $A(s)$ in square meters, and time step $\\Delta t$ in seconds.\n- The program must compute the storage sequence $\\{s_1, s_2, \\dots, s_T\\}$ as floating-point numbers in cubic meters.\n- The program must compute three booleans per test case: whether the environmental minimum release was met at every time step, whether any spillage occurred at any time step, and whether any ramp clipping occurred due to $\\lvert R_t - R_{t-1} \\rvert  \\rho$ relative to the desired release.\n\nTest suite:\nUse a horizon length $T = 4$ with the following globally shared parameters:\n- $S_{\\min} = 10{,}000{,}000$ cubic meters,\n- $S_{\\max} = 100{,}000{,}000$ cubic meters,\n- $A_0 = 3{,}000{,}000$ square meters,\n- $\\alpha = 0.005$ inverse meters,\n- $\\Delta t = 86{,}400$ seconds,\n- $\\underline{R} = 50$ cubic meters per second,\n- $\\overline{R} = 400$ cubic meters per second,\n- $\\rho = 100$ cubic meters per second,\n- $R_{-1} = 50$ cubic meters per second for all cases,\n- $E_t = 6 \\times 10^{-8}$ meters per second for all $t$ in each case.\n\nDefine four test cases, each specified by initial storage $s_0$, inflow vector {$I_0, I_1, I_2, I_3$} in cubic meters per second, and desired release vector {$R^{\\mathrm{des}}_0, R^{\\mathrm{des}}_1, R^{\\mathrm{des}}_2, R^{\\mathrm{des}}_3$} in cubic meters per second:\n- Case $1$ (typical operating conditions): $s_0 = 50{,}000{,}000$, {$I_t$} = {$180, 160, 150, 140$}, {$R^{\\mathrm{des}}_t$} = {$150, 200, 180, 160$}.\n- Case $2$ (high inflow near capacity causing spillage): $s_0 = 95{,}000{,}000$, {$I_t$} = {$500, 600, 800, 900$}, {$R^{\\mathrm{des}}_t$} = {$200, 200, 200, 200$}.\n- Case $3$ (low inflow risking minimum storage, environmental flow potentially unmet): $s_0 = 12{,}000{,}000$, {$I_t$} = {$40, 30, 20, 10$}, {$R^{\\mathrm{des}}_t$} = {$60, 60, 60, 60$}.\n- Case $4$ (aggressive release changes violating ramp constraints but otherwise feasible): $s_0 = 50{,}000{,}000$, {$I_t$} = {$200, 200, 200, 200$}, {$R^{\\mathrm{des}}_t$} = {$50, 350, 50, 350$}.\n\nFor each test case, produce a result of the form $[\\text{storage\\_sequence},\\ \\text{env\\_met},\\ \\text{spill\\_occurred},\\ \\text{ramp\\_clipped\\_occurred}]$, where $\\text{storage\\_sequence}$ is the list [$s_1, s_2, s_3, s_4$] in cubic meters, $\\text{env\\_met}$ is a boolean indicating whether $\\underline{R}$ was met at every step after enforcing all constraints, $\\text{spill\\_occurred}$ is a boolean indicating whether any spillage occurred, and $\\text{ramp\\_clipped\\_occurred}$ is a boolean indicating whether any desired release was adjusted due to the ramp constraint.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,result3,result4]$), where each $resulti$ is the list specified above for the $i$-th test case. All storage values must be in cubic meters. Angles do not appear in this problem. No percentages appear in this problem.",
            "solution": "The user-provided problem is assessed to be valid. It is scientifically grounded in the principle of mass conservation, is mathematically well-posed with a complete set of parameters and constraints, and is expressed in objective, formal language. The problem requires the development of a discrete-time simulation model for a reservoir, which is a standard task in water resources and energy systems engineering.\n\nThe solution proceeds by first deriving the governing discrete-time equation and then developing a step-by-step algorithm to enforce the specified operational constraints.\n\nThe fundamental principle governing the reservoir is the conservation of mass. For a control volume, the rate of change of the stored volume $s(t)$ is equal to the volumetric inflow rate minus the volumetric outflow rate. The inflows are given by $I(t)$, and the outflows consist of the controlled release $R(t)$ and natural evaporation.\n\nThe volumetric evaporation loss rate is the product of the evaporation rate $E(t)$ (in units of length per time, m/s) and the reservoir's surface area $A(s(t))$ (in units of area, m$^2$). The surface area is given as a linear function of storage:\n$$ A(s) = A_0 + \\alpha s $$\nwhere $A_0$ is the base area and $\\alpha$ determines the increase in area with storage.\n\nThe continuous-time differential equation for mass balance is:\n$$ \\frac{ds(t)}{dt} = I(t) - R(t) - E(t) A(s(t)) $$\n\nTo solve this numerically, we use a first-order explicit (forward Euler) time discretization over a fixed time step $\\Delta t$. We assume that the rates $I_t$, $R_t$, and $E_t$ are piecewise constant over the interval $[t, t+\\Delta t]$. The derivative is approximated as:\n$$ \\frac{ds(t)}{dt} \\approx \\frac{s_{t+1} - s_t}{\\Delta t} $$\nSubstituting this into the mass balance equation, and evaluating the right-hand side at time $t$, gives:\n$$ \\frac{s_{t+1} - s_t}{\\Delta t} = I_t - R_t - E_t A(s_t) $$\nRearranging to solve for the storage at the next time step, $s_{t+1}$, we obtain the discrete-time state update equation:\n$$ s_{t+1} = s_t + \\left( I_t - R_t - E_t (A_0 + \\alpha s_t) \\right) \\Delta t $$\n\nThe core of the problem is to determine the actual release $R_t$ at each time step, considering a desired release $R_t^{\\mathrm{des}}$ and a cascade of physical and operational constraints. The following algorithm is executed for each time step $t$ from $0$ to $T-1$, given the state $s_t$ and the previous release $R_{t-1}$.\n\n1.  **Determine Candidate Release**: The initial target for the release is the desired release, $R_t^{\\mathrm{des}}$. This target is sequentially adjusted to satisfy operational constraints.\n    a.  **Ramp Rate Constraint**: The release cannot change too quickly. The change $|R_t - R_{t-1}|$ must not exceed the ramp rate limit $\\rho$. This defines a feasible range for $R_t$: $[R_{t-1} - \\rho, R_{t-1} + \\rho]$. The desired release is clipped to this range. If clipping occurs, the `ramp_clipped_occurred` flag is set to true.\n        $$ R_t' = \\max(R_{t-1} - \\rho, \\min(R_{t-1} + \\rho, R_t^{\\mathrm{des}})) $$\n    b.  **Turbine and Environmental Constraints**: The release must be within the turbine capacity $\\overline{R}$ and must satisfy the environmental minimum flow $\\underline{R}$. This defines a second feasible range $[\\underline{R}, \\overline{R}]$. The ramp-constrained release $R_t'$ is then clipped to this range to produce the final candidate release, $R_t^{\\text{cand}}$.\n        $$ R_t^{\\text{cand}} = \\max(\\underline{R}, \\min(\\overline{R}, R_t')) $$\n\n2.  **Calculate Tentative Next Storage**: Using the candidate release $R_t^{\\text{cand}}$, we calculate a tentative storage for the next time step, $s_{t+1}^{\\text{tentative}}$, using the state update equation.\n    $$ s_{t+1}^{\\text{tentative}} = s_t + \\left( I_t - R_t^{\\text{cand}} - E_t (A_0 + \\alpha s_t) \\right) \\Delta t $$\n\n3.  **Enforce Storage Bounds**: The tentative storage is checked against the absolute minimum and maximum storage limits, $S_{\\min}$ and $S_{\\max}$. The final values for $s_{t+1}$ and $R_t$ are determined based on this check.\n\n    a.  **Spillage Condition**: If $s_{t+1}^{\\text{tentative}}  S_{\\max}$, the reservoir is overflowing. The final storage is capped at the maximum capacity, $s_{t+1} = S_{\\max}$. The excess water is spilled. The controlled release through the turbines remains the candidate release, $R_t = R_t^{\\text{cand}}$. The `spill_occurred` flag is set to true.\n\n    b.  **Curtailment Condition**: If $s_{t+1}^{\\text{tentative}}  S_{\\min}$, the candidate release is too high and would drain the reservoir below its minimum level. The release must be curtailed. The problem states that the release should be adjusted to exactly meet $s_{t+1} = S_{\\min}$. We find the required release, $R_t^{\\text{req}}$, by setting $s_{t+1} = S_{\\min}$ in the state update equation and solving for $R_t$:\n        $$ S_{\\min} = s_t + \\left( I_t - R_t^{\\text{req}} - E_t (A_0 + \\alpha s_t) \\right) \\Delta t $$\n        $$ R_t^{\\text{req}} = I_t - E_t (A_0 + \\alpha s_t) - \\frac{S_{\\min} - s_t}{\\Delta t} $$\n        This value $R_t^{\\text{req}}$ is the maximum possible release that does not violate the minimum storage constraint. This physical limit overrides the operational targets. Thus, the final release is set to this value: $R_t = R_t^{\\text{req}}$. The final storage is $s_{t+1} = S_{\\min}$. After determining this necessary release, we check if it satisfies the environmental minimum: if $R_t  \\underline{R}$, the `env_met` flag is set to false.\n\n    c.  **Normal Condition**: If $S_{\\min} \\le s_{t+1}^{\\text{tentative}} \\le S_{\\max}$, the candidate release is feasible. The final storage is the tentative storage, $s_{t+1} = s_{t+1}^{\\text{tentative}}$, and the final release is the candidate release, $R_t = R_t^{\\text{cand}}$. Since $R_t^{\\text{cand}}$ was already forced to be $\\ge \\underline{R}$, the environmental flow is met in this case.\n\nAfter each time step, the final release $R_t$ becomes the previous release for the next step, $R_t \\rightarrow R_{t-1}$, and the simulation proceeds. This process is repeated for the entire time horizon for each test case.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the reservoir simulation problem for all specified test cases.\n    \"\"\"\n    # Globally shared parameters\n    S_min = 10_000_000.0  # m^3\n    S_max = 100_000_000.0 # m^3\n    A0 = 3_000_000.0      # m^2\n    alpha = 0.005        # m^-1\n    delta_t = 86400.0    # seconds (1 day)\n    R_env_min = 50.0     # m^3/s\n    R_turbine_max = 400.0# m^3/s\n    rho = 100.0          # m^3/s per time step\n    R_minus_1 = 50.0     # m^3/s\n    E = 6e-8             # m/s\n    T = 4                # Number of time steps\n\n    # Test cases\n    test_cases = [\n        # Case 1 (typical operating conditions)\n        {\n            \"s0\": 50_000_000.0,\n            \"I\": np.array([180.0, 160.0, 150.0, 140.0]),\n            \"R_des\": np.array([150.0, 200.0, 180.0, 160.0]),\n        },\n        # Case 2 (high inflow near capacity causing spillage)\n        {\n            \"s0\": 95_000_000.0,\n            \"I\": np.array([500.0, 600.0, 800.0, 900.0]),\n            \"R_des\": np.array([200.0, 200.0, 200.0, 200.0]),\n        },\n        # Case 3 (low inflow risking minimum storage)\n        {\n            \"s0\": 12_000_000.0,\n            \"I\": np.array([40.0, 30.0, 20.0, 10.0]),\n            \"R_des\": np.array([60.0, 60.0, 60.0, 60.0]),\n        },\n        # Case 4 (aggressive release changes violating ramp constraints)\n        {\n            \"s0\": 50_000_000.0,\n            \"I\": np.array([200.0, 200.0, 200.0, 200.0]),\n            \"R_des\": np.array([50.0, 350.0, 50.0, 350.0]),\n        },\n    ]\n\n    results = []\n\n    for case in test_cases:\n        s_current = case[\"s0\"]\n        I_t = case[\"I\"]\n        R_des_t = case[\"R_des\"]\n        \n        R_prev = R_minus_1\n        storage_sequence = []\n        \n        # Flags for the entire horizon\n        env_met_horizon = True\n        spill_occurred_horizon = False\n        ramp_clipped_occurred_horizon = False\n\n        for t in range(T):\n            # Step 1: Determine Candidate Release\n            R_target = R_des_t[t]\n\n            # a. Ramp Rate Constraint\n            R_ramped = np.clip(R_target, R_prev - rho, R_prev + rho)\n            if R_ramped != R_target:\n                ramp_clipped_occurred_horizon = True\n\n            # b. Turbine and Environmental Constraints\n            R_cand = np.clip(R_ramped, R_env_min, R_turbine_max)\n\n            # Step 2: Calculate Tentative Next Storage\n            surface_area = A0 + alpha * s_current\n            evap_rate_volumetric = E * surface_area  # m^3/s\n            \n            s_next_tentative = s_current + (I_t[t] - R_cand - evap_rate_volumetric) * delta_t\n\n            # Step 3: Enforce Storage Bounds\n            R_final = 0.0\n            s_next = 0.0\n            \n            if s_next_tentative  S_max:\n                # Spillage condition\n                s_next = S_max\n                R_final = R_cand\n                spill_occurred_horizon = True\n            elif s_next_tentative  S_min:\n                # Curtailment condition\n                s_next = S_min\n                # Recalculate release to hit S_min exactly\n                R_req = I_t[t] - evap_rate_volumetric - (S_min - s_current) / delta_t\n                R_final = R_req\n            else:\n                # Normal condition\n                s_next = s_next_tentative\n                R_final = R_cand\n\n            # Check if environmental flow was met for this step\n            if R_final  R_env_min:\n                env_met_horizon = False\n\n            # Store result and update state for next iteration\n            storage_sequence.append(s_next)\n            s_current = s_next\n            R_prev = R_final\n\n        results.append([storage_sequence, env_met_horizon, spill_occurred_horizon, ramp_clipped_occurred_horizon])\n\n    # The custom string formatting is required to match the exact output spec.\n    results_str = [f\"[{item[0]}, {item[1]}, {item[2]}, {item[3]}]\" for item in results]\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Deterministic models provide a clear picture but ignore the inherent uncertainty of natural systems. This final practice introduces you to the world of probabilistic forecasting, where inflow is represented by an ensemble of possible trajectories rather than a single value . You will learn to assess the quality of these probabilistic forecasts using standard verification metrics like the Continuous Ranked Probability Score ($CRPS$) and the Brier score. Furthermore, you will use the ensemble to simulate reservoir operations and quantify the risk of violating critical constraints, a core skill in modern risk-based decision-making.",
            "id": "4118226",
            "problem": "Consider a reservoir supplied by stochastic inflow represented by an ensemble of trajectories. The operator issues releases subject to turbine capacity and upper storage constraints, and verification metrics are computed against observed inflow. Start from foundational principles: conservation of mass for reservoir storage dynamics, the definition of the cumulative distribution function, and elementary probability. You are to implement verifications of probabilistic inflow ensembles and constraints and return quantitative metrics for a provided test suite.\n\nFundamental base and definitions to be used:\n- Conservation of mass: for each time step $t$, the storage update is\n$$\nS_{t+1} \\;=\\; S_t \\;+\\; \\Delta t\\cdot I_t \\;-\\; \\Delta t\\cdot R_t \\;-\\; E_t \\;-\\; \\text{Spill}_t,\n$$\nwhere $S_t$ is storage in $\\mathrm{m}^3$, $I_t$ is inflow in $\\mathrm{m}^3/\\mathrm{s}$, $R_t$ is release in $\\mathrm{m}^3/\\mathrm{s}$, $E_t$ is evaporation loss in $\\mathrm{m}^3$ during the time step, $\\text{Spill}_t \\ge 0$ is spill in $\\mathrm{m}^3$, and $\\Delta t$ is the duration of the time step in $\\mathrm{s}$. Turbine capacity imposes $R_t \\le C_t$, and storage bounds impose $S_{\\min} \\le S_t \\le S_{\\max}$.\n- Cumulative distribution function: for a random variable $X$ with distribution function $F_X(x) = \\mathbb{P}(X \\le x)$, and an observation $y$, the Continuous Ranked Probability Score (CRPS) of forecast $F_X$ with respect to $y$ is\n$$\n\\text{CRPS}(F_X, y) \\;=\\; \\int_{-\\infty}^{+\\infty} \\bigl(F_X(z) - \\mathbb{1}\\{y \\le z\\}\\bigr)^2\\,\\mathrm{d}z,\n$$\nwhere $\\mathbb{1}\\{\\cdot\\}$ is the indicator function. For a discrete ensemble, implement the corresponding empirical computation implied by this definition.\n- Brier score for a binary event: for event $A$ (e.g., inflow exceeding a threshold), with forecast probability $p$ and observed outcome $o \\in \\{0,1\\}$, the Brier score is\n$$\n\\text{BS} \\;=\\; (p - o)^2.\n$$\n\nTasks to implement for each test case:\n1. Compute the time-step CRPS between the inflow ensemble at each time $t$ and the observed inflow at time $t$, using the empirical discrete-ensemble formulation implied by the integral definition above, then return the arithmetic mean of the per-time-step CRPS values as a single float.\n2. For the binary event “inflow exceeds threshold,” compute the time-step Brier score by taking the forecast probability as the fraction of ensemble members exceeding the threshold and the observed outcome as $1$ if the observed inflow exceeds the threshold and $0$ otherwise. Return the arithmetic mean of the per-time-step Brier scores as a single float.\n3. Compute empirical coverage of the nominal central prediction interval at level $p_{\\mathrm{cov}}$ by using the empirical quantiles at levels $(1-p_{\\mathrm{cov}})/2$ and $1-(1-p_{\\mathrm{cov}})/2$ of the ensemble at each time $t$, then computing the fraction of observed inflows falling within their corresponding intervals. Return a boolean indicating whether the empirical coverage fraction is within a specified tolerance $tol_{\\mathrm{cov}}$ of $p_{\\mathrm{cov}}$.\n4. Simulate reservoir storage across ensemble trajectories under the policy $R_t = \\min\\{C_t, \\text{median}(\\text{ensemble inflow at } t)\\}$, with time step duration $\\Delta t = 3600\\,\\mathrm{s}$, evaporation $E_t$ in $\\mathrm{m}^3$ per time step, spill enforcing the upper bound by setting $S_{t+1} = \\min\\{S_{\\max}, S_t + \\Delta t\\cdot I_t - \\Delta t\\cdot R_t - E_t\\}$, and record a lower-bound violation if $S_{t+1}  S_{\\min}$. Return the empirical probability (as a decimal) over ensemble members that a lower-bound violation occurs at any time step.\n\nPhysical units and reporting:\n- Inflow and release are in $\\mathrm{m}^3/\\mathrm{s}$.\n- Storage is in $\\mathrm{m}^3$.\n- Evaporation per time step is in $\\mathrm{m}^3$.\n- Use $\\Delta t = 3600\\,\\mathrm{s}$ for all test cases.\n- All returned numeric metrics are dimensionless floats; coverage is returned as a boolean.\n- No angle units are involved.\n- The final program output must be a single line containing a comma-separated list enclosed in square brackets of the per-test-case results, where each test case result is itself a list in the order $[\\text{mean\\_CRPS}, \\text{mean\\_Brier}, \\text{coverage\\_ok}, \\text{lower\\_bound\\_violation\\_probability}]$.\n\nTest suite:\n- Test case $1$ (happy path):\n    - Ensemble size $K = 10$, time steps $T = 3$.\n    - Ensemble inflow trajectories (each list is $\\mathrm{m}^3/\\mathrm{s}$ at times $t=1,2,3$):\n        - $[90, 100, 95]$\n        - $[92, 98, 96]$\n        - $[88, 97, 103]$\n        - $[105, 110, 102]$\n        - $[98, 101, 99]$\n        - $[93, 94, 97]$\n        - $[102, 108, 106]$\n        - $[97, 96, 100]$\n        - $[91, 99, 95]$\n        - $[100, 104, 101]$\n    - Observed inflows: $[95, 102, 100]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Threshold for exceedance event: $100$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Nominal coverage level: $p_{\\mathrm{cov}} = 0.9$, tolerance $tol_{\\mathrm{cov}} = 0.05$.\n    - Turbine capacities $C_t$: $[100, 100, 100]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Evaporation per time step $E_t$: $[5000, 5000, 5000]$ in $\\mathrm{m}^3$.\n    - Storage bounds and initial storage: $S_{\\min} = 2{,}000{,}000$ $\\mathrm{m}^3$, $S_{\\max} = 5{,}000{,}000$ $\\mathrm{m}^3$, $S_0 = 3{,}000{,}000$ $\\mathrm{m}^3$.\n- Test case $2$ (lower-bound risk under high evaporation):\n    - Ensemble size $K = 8$, time steps $T = 4$.\n    - Ensemble inflow trajectories:\n        - $[35, 34, 36, 33]$\n        - $[38, 39, 37, 35]$\n        - $[32, 31, 33, 30]$\n        - $[50, 45, 48, 47]$\n        - $[40, 42, 41, 43]$\n        - $[37, 36, 35, 34]$\n        - $[45, 44, 43, 42]$\n        - $[39, 38, 40, 37]$\n    - Observed inflows: $[36, 38, 40, 35]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Threshold for exceedance event: $42$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Nominal coverage level: $p_{\\mathrm{cov}} = 0.9$, tolerance $tol_{\\mathrm{cov}} = 0.05$.\n    - Turbine capacities $C_t$: $[150, 150, 150, 150]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Evaporation per time step $E_t$: $[60000, 60000, 60000, 60000]$ in $\\mathrm{m}^3$.\n    - Storage bounds and initial storage: $S_{\\min} = 2{,}000{,}000$ $\\mathrm{m}^3$, $S_{\\max} = 5{,}000{,}000$ $\\mathrm{m}^3$, $S_0 = 2{,}050{,}000$ $\\mathrm{m}^3$.\n- Test case $3$ (deterministic forecast edge case):\n    - Ensemble size $K = 1$, time steps $T = 2$.\n    - Ensemble inflow trajectory:\n        - $[120, 80]$\n    - Observed inflows: $[110, 90]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Threshold for exceedance event: $100$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Nominal coverage level: $p_{\\mathrm{cov}} = 0.8$, tolerance $tol_{\\mathrm{cov}} = 0.10$.\n    - Turbine capacities $C_t$: $[90, 90]$ in $\\mathrm{m}^3/\\mathrm{s}$.\n    - Evaporation per time step $E_t$: $[5000, 5000]$ in $\\mathrm{m}^3$.\n    - Storage bounds and initial storage: $S_{\\min} = 1{,}000{,}000$ $\\mathrm{m}^3$, $S_{\\max} = 1{,}500{,}000$ $\\mathrm{m}^3$, $S_0 = 1{,}050{,}000$ $\\mathrm{m}^3$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to a test case result list in the order $[\\text{mean\\_CRPS}, \\text{mean\\_Brier}, \\text{coverage\\_ok}, \\text{lower\\_bound\\_violation\\_probability}]$. For example, the output format must be exactly like $[[r_{1,1},r_{1,2},r_{1,3},r_{1,4}],[r_{2,1},r_{2,2},r_{2,3},r_{2,4}],[r_{3,1},r_{3,2},r_{3,3},r_{3,4}]]$.",
            "solution": "The problem requires the implementation of four distinct verification and simulation tasks related to reservoir inflow forecasting and management. The solution is designed by implementing each task as a modular function, adhering strictly to the provided definitions and principles.\n\n**1. Mean Continuous Ranked Probability Score (CRPS)**\n\nThe first task is to compute the mean CRPS, a metric for evaluating probabilistic forecasts. The problem provides the integral definition of CRPS for a continuous forecast distribution $F_X$ and an observation $y$:\n$$\n\\text{CRPS}(F_X, y) \\;=\\; \\int_{-\\infty}^{+\\infty} \\bigl(F_X(z) - \\mathbb{1}\\{y \\le z\\}\\bigr)^2\\,\\mathrm{d}z\n$$\nFor a discrete ensemble forecast $\\{x_i\\}_{i=1}^K$, the empirical cumulative distribution function is $F_K(z) = \\frac{1}{K}\\sum_{i=1}^K \\mathbb{1}\\{x_i \\le z\\}$. While the integral can be solved directly using this step-wise function, a more computationally convenient and widespread formulation, known as the energy form, is employed. This formulation expresses the CRPS as the difference between the expected absolute error of the forecast members to the observation and half the expected absolute difference between any two forecast members:\n$$\n\\text{CRPS}(F_K, y) = \\mathbb{E}[|X - y|] - \\frac{1}{2}\\mathbb{E}[|X - X'|]\n$$\nwhere $X$ and $X'$ are independent random variables drawn from the forecast distribution $F_K$. The empirical estimates for these expectations, given the ensemble $\\{x_i\\}_{i=1}^K$, are:\n$$\n\\mathbb{E}[|X - y|] \\approx \\frac{1}{K}\\sum_{i=1}^K |x_i - y|\n$$\n$$\n\\mathbb{E}[|X - X'|] \\approx \\frac{1}{K^2}\\sum_{i=1}^K \\sum_{j=1}^K |x_i - x_j|\n$$\nThe algorithm proceeds by iterating through each time step $t$ from $0$ to $T-1$. At each step, the inflow ensemble $\\{I_{k,t}\\}_{k=1}^K$ and the corresponding observation $I_{\\text{obs},t}$ are used to compute a time-step CRPS value using the formulation above. The final metric is the arithmetic mean of these per-time-step CRPS values.\n\n**2. Mean Brier Score**\n\nThe second task is to compute the mean Brier score for a binary event. The event is defined as the inflow exceeding a given threshold. The Brier score is given by:\n$$\n\\text{BS} \\;=\\; (p - o)^2\n$$\nwhere $p$ is the forecast probability of the event and $o \\in \\{0,1\\}$ is the observed binary outcome.\n\nThe algorithm again iterates through each time step $t$. For each step:\n- The forecast probability $p_t$ is calculated as the fraction of ensemble members whose inflow $I_{k,t}$ is strictly greater than the specified threshold.\n- The observed outcome $o_t$ is set to $1$ if the observed inflow $I_{\\text{obs},t}$ is strictly greater than the threshold, and $0$ otherwise.\n- The Brier score for the time step, $\\text{BS}_t = (p_t - o_t)^2$, is calculated.\n\nThe final metric is the arithmetic mean of these scores over all time steps.\n\n**3. Empirical Coverage Verification**\n\nThe third task verifies if the empirical coverage of a central prediction interval matches its nominal level $p_{\\mathrm{cov}}$ within a given tolerance $tol_{\\mathrm{cov}}$. The central prediction interval is defined by the empirical quantiles of the inflow ensemble at levels $\\alpha_1 = (1 - p_{\\mathrm{cov}})/2$ and $\\alpha_2 = 1 - \\alpha_1 = (1 + p_{\\mathrm{cov}})/2$.\n\nThe algorithm consists of the following steps:\n- For each time step $t$, the lower bound $q_{1,t}$ and upper bound $q_{2,t}$ of the interval are computed as the empirical quantiles of the inflow ensemble $\\{I_{k,t}\\}_{k=1}^K$ at levels $\\alpha_1$ and $\\alpha_2$ respectively.\n- The observed inflow $I_{\\text{obs},t}$ is checked to see if it falls within this interval, i.e., $q_{1,t} \\le I_{\\text{obs},t} \\le q_{2,t}$.\n- The total number of time steps where the observation is covered, $T_{\\text{covered}}$, is counted.\n- The empirical coverage fraction is calculated as $p_{\\text{emp}} = T_{\\text{covered}} / T$.\n- Finally, the algorithm returns a boolean value indicating whether the absolute difference between the empirical and nominal coverage is within the tolerance: $|p_{\\text{emp}} - p_{\\mathrm{cov}}| \\le tol_{\\mathrm{cov}}$.\n\n**4. Reservoir Lower-Bound Violation Probability**\n\nThe fourth task is a simulation to estimate the probability of violating the minimum storage level $S_{\\min}$. The simulation is run for each of the $K$ ensemble inflow trajectories. The reservoir storage $S_t$ evolves according to the conservation of mass equation:\n$$\nS_{t+1}^{\\text{pre-spill}} \\;=\\; S_t \\;+\\; \\Delta t\\cdot I_t \\;-\\; \\Delta t\\cdot R_t \\;-\\; E_t\n$$\nThe release policy is given as $R_t = \\min\\{C_t, \\text{median}(\\text{ensemble inflow at } t)\\}$. A crucial point is that the release $R_t$ at any time step $t$ is constant across all simulation runs, as it depends on the median of the entire inflow ensemble for that time step, not on an individual member's inflow.\n\nThe simulation algorithm is designed as follows:\n- First, the sequence of releases $R_t$ for all time steps $t=0, ..., T-1$ is pre-calculated based on the given policy.\n- Then, for each of the $K$ ensemble members:\n    - A simulation is run over the time horizon $T$. Storage is initialized to $S_0$.\n    - At each time step $t$, the next storage state before considering spill, $S'_{k, t+1}$, is calculated using the inflow $I_{k,t}$ for that specific member and the pre-calculated release $R_t$.\n    - The upper storage bound is enforced by setting the final storage for the time step as $S_{k,t+1} = \\min\\{S_{\\max}, S'_{k, t+1}\\}$.\n    - A check is performed: if $S_{k,t+1}  S_{\\min}$ at any point during the simulation for member $k$, a violation is recorded for that member, and the simulation for that member can be stopped early.\n- After simulating all $K$ members, the number of members for which a violation was recorded, $N_{\\text{violations}}$, is counted.\n- The final result is the empirical probability of violation, computed as $N_{\\text{violations}} / K$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to define test cases and compute the required metrics.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"name\": \"Test case 1 (happy path)\",\n            \"ensemble_inflow\": np.array([\n                [90, 100, 95], [92, 98, 96], [88, 97, 103], [105, 110, 102], [98, 101, 99],\n                [93, 94, 97], [102, 108, 106], [97, 96, 100], [91, 99, 95], [100, 104, 101]\n            ]),\n            \"observed_inflow\": np.array([95, 102, 100]),\n            \"threshold\": 100.0,\n            \"p_cov\": 0.9, \"tol_cov\": 0.05,\n            \"C_t\": np.array([100, 100, 100]),\n            \"E_t\": np.array([5000, 5000, 5000]),\n            \"S_min\": 2000000.0, \"S_max\": 5000000.0, \"S_0\": 3000000.0,\n            \"delta_t\": 3600.0\n        },\n        {\n            \"name\": \"Test case 2 (lower-bound risk under high evaporation)\",\n            \"ensemble_inflow\": np.array([\n                [35, 34, 36, 33], [38, 39, 37, 35], [32, 31, 33, 30], [50, 45, 48, 47],\n                [40, 42, 41, 43], [37, 36, 35, 34], [45, 44, 43, 42], [39, 38, 40, 37]\n            ]),\n            \"observed_inflow\": np.array([36, 38, 40, 35]),\n            \"threshold\": 42.0,\n            \"p_cov\": 0.9, \"tol_cov\": 0.05,\n            \"C_t\": np.array([150, 150, 150, 150]),\n            \"E_t\": np.array([60000, 60000, 60000, 60000]),\n            \"S_min\": 2000000.0, \"S_max\": 5000000.0, \"S_0\": 2050000.0,\n            \"delta_t\": 3600.0\n        },\n        {\n            \"name\": \"Test case 3 (deterministic forecast edge case)\",\n            \"ensemble_inflow\": np.array([[120, 80]]),\n            \"observed_inflow\": np.array([110, 90]),\n            \"threshold\": 100.0,\n            \"p_cov\": 0.8, \"tol_cov\": 0.10,\n            \"C_t\": np.array([90, 90]),\n            \"E_t\": np.array([5000, 5000]),\n            \"S_min\": 1000000.0, \"S_max\": 1500000.0, \"S_0\": 1050000.0,\n            \"delta_t\": 3600.0\n        }\n    ]\n\n    def _calculate_crps(ensemble_slice, observation):\n        \"\"\"Computes empirical CRPS for a single time step.\"\"\"\n        K = len(ensemble_slice)\n        term1 = np.mean(np.abs(ensemble_slice - observation))\n        \n        # Reshape for broadcasting\n        ens_col = ensemble_slice[:, np.newaxis]\n        ens_row = ensemble_slice[np.newaxis, :]\n        \n        term2 = 0.5 * np.mean(np.abs(ens_col - ens_row))\n        return term1 - term2\n\n    def _calculate_brier(ensemble_slice, observation, threshold):\n        \"\"\"Computes Brier score for a single time step.\"\"\"\n        p_forecast = np.mean(ensemble_slice  threshold)\n        o_observed = 1 if observation  threshold else 0\n        return (p_forecast - o_observed)**2\n\n    def process_case(case):\n        \"\"\"Processes a single test case and returns the four metrics.\"\"\"\n        I_ens = case[\"ensemble_inflow\"]\n        I_obs = case[\"observed_inflow\"]\n        threshold = case[\"threshold\"]\n        p_cov, tol_cov = case[\"p_cov\"], case[\"tol_cov\"]\n        C_t, E_t = case[\"C_t\"], case[\"E_t\"]\n        S_min, S_max, S_0 = case[\"S_min\"], case[\"S_max\"], case[\"S_0\"]\n        delta_t = case[\"delta_t\"]\n\n        K, T = I_ens.shape\n\n        # Task 1: Mean CRPS\n        crps_values = [_calculate_crps(I_ens[:, t], I_obs[t]) for t in range(T)]\n        mean_crps = np.mean(crps_values)\n\n        # Task 2: Mean Brier Score\n        brier_scores = [_calculate_brier(I_ens[:, t], I_obs[t], threshold) for t in range(T)]\n        mean_brier = np.mean(brier_scores)\n        \n        # Task 3: Coverage Check\n        alpha1 = (1.0 - p_cov) / 2.0\n        alpha2 = 1.0 - alpha1\n        \n        covered_count = 0\n        for t in range(T):\n            q1 = np.quantile(I_ens[:, t], alpha1)\n            q2 = np.quantile(I_ens[:, t], alpha2)\n            if q1 = I_obs[t] = q2:\n                covered_count += 1\n        \n        p_emp = covered_count / T\n        coverage_ok = np.abs(p_emp - p_cov) = tol_cov\n\n        # Task 4: Lower-bound violation probability\n        # Pre-calculate releases, constant for all members at each time step\n        R_t = np.array([min(C_t[t], np.median(I_ens[:, t])) for t in range(T)])\n        \n        violations = 0\n        for k in range(K):\n            S_current = S_0\n            violation_found = False\n            for t in range(T):\n                inflow_vol = I_ens[k, t] * delta_t\n                release_vol = R_t[t] * delta_t\n                evap_vol = E_t[t]\n                \n                S_next_pre_spill = S_current + inflow_vol - release_vol - evap_vol\n                S_next = min(S_max, S_next_pre_spill)\n                \n                if S_next  S_min:\n                    violation_found = True\n                    break\n                S_current = S_next\n            \n            if violation_found:\n                violations += 1\n        \n        violation_prob = violations / K\n        \n        return [mean_crps, mean_brier, coverage_ok, violation_prob]\n\n    results = [process_case(case) for case in test_cases]\n    \n    # Format the final output string as specified\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}