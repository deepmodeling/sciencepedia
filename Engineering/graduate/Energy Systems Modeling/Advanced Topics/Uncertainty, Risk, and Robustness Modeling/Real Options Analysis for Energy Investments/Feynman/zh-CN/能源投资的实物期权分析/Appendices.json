{
    "hands_on_practices": [
        {
            "introduction": "二叉树格状模型是为期权（尤其是允许提前执行的美式期权）定价的一种基础且直观的数值方法。本练习将指导你从第一性原理出发，构建一个实物期权估值模型，从而弥合连续时间理论（几何布朗运动）与离散时间实现之间的鸿沟。通过这个实践，你将掌握将复杂的随机过程转化为可计算步骤的核心技能，并学会处理提前执行的决策逻辑。",
            "id": "4115364",
            "problem": "考虑一个能源投资问题，其中项目总价值 $X_t$（以百万美元为单位）随连续时间随机演变，遵循几何布朗运动 (GBM)。假设市场无摩擦、无套利，并存在唯一的等价鞅测度（风险中性测度）。在风险中性测度下，$X_t$ 满足随机微分方程 $dX_t = (r - \\delta) X_t \\, dt + \\sigma X_t \\, dW_t$，其中参数为常数：无风险连续复利率 $r$、连续支付收益率 $\\delta$ 和波动率 $\\sigma$。决策者持有一个实物期权，可以在时间 $t \\in [0, T]$ 内的任何时刻通过支付一笔不可逆的投资成本 $I$（以百万美元为单位）进行投资。一旦投资，项目立即实现，其回报等于当时的净现值，模型为 $\\max(X_t - I, 0)$（以百万美元为单位）。该期权为美式期权，意味着在到期日或到期日之前的任何时间都允许行权。\n\n您的任务是设计并实现一个重组二叉树格模型方法，以计算该美式实物期权在时间 $t=0$ 的价值。该离散化必须从第一性原理构建：从风险中性测度下的 GBM 动态开始，并施加无套利条件，通过匹配单步转移的前两阶矩（到时间步长 $\\Delta t$ 的主导阶），推导出上涨和下跌乘数以及风险中性转移概率。然后，通过贴现执行向后归纳来计算美式期权价值。必须在每个节点通过比较继续价值与立即执行价值来处理提前行权。贴现必须对每个格点步骤使用因子 $e^{-r \\Delta t}$。\n\n程序还必须正确处理退化极限 $\\sigma = 0$ 的情况，此时随机过程在风险中性测度下变为确定性过程。在这种情况下，格点构建会退化，您必须实现一个逻辑上一致的估值方法，该方法要尊重美式期权在一组离散行权时间上的最优停止性质。当 $T = 0$ 时，价值简化为在 $t=0$ 时的立即回报。\n\n所有输出必须以百万美元（million USD）为单位，表示为实值浮点数。不涉及角度。如果任何量要以百分比表示，则必须是小数形式；然而，本问题使用的连续复利率 $r$ 和 $\\delta$ 是以年为单位的小数。\n\n实现一个程序，给定以下参数集 $(X_0, I, r, \\delta, \\sigma, T, N)$ 的测试套件，使用具有 $N$ 个时间步长（大小为 $\\Delta t = T/N$）的重组二叉树格模型计算在 $t=0$ 时的期权价值：\n\n- 测试用例 1（一般情况，正常路径）：$(X_0, I, r, \\delta, \\sigma, T, N) = (100.0, 90.0, 0.06, 0.02, 0.20, 3.0, 150)$。\n- 测试用例 2（退化波动率，$\\sigma = 0$）：$(X_0, I, r, \\delta, \\sigma, T, N) = (120.0, 100.0, 0.06, 0.00, 0.00, 2.0, 50)$。\n- 测试用例 3（边界到期日， $T = 0$）：$(X_0, I, r, \\delta, \\sigma, T, N) = (80.0, 100.0, 0.05, 0.02, 0.25, 0.0, 1)$。\n- 测试用例 4（高支付收益率，负风险中性漂移）：$(X_0, I, r, \\delta, \\sigma, T, N) = (150.0, 140.0, 0.05, 0.25, 0.30, 2.0, 100)$。\n\n您的程序应生成单行输出，其中包含一个逗号分隔的列表，用方括号括起来，顺序与测试套件相同，例如：“[result1,result2,result3,result4]”。每个结果必须是一个浮点数，代表 $t=0$ 时的期权价值（百万美元）。\n\n推导和算法设计必须从连续时间的核心概率论和金融学原理（风险中性测度下的 GBM 和无套利）开始，并进而构建一个有效的重组二叉树近似和通过向后归纳的最优停止估值。不要在推导中不加解释地使用快捷公式；相反，应从所述的基础出发，推导出离散参数和估值递归。",
            "solution": "该问题要求对一个能源项目的美式实物期权进行估值。该期权的价值将使用重组二叉树格模型计算。该问题定义明确，具有金融工程原理的科学基础，并为唯一解提供了所有必要的数据。\n\n解决方案分三个阶段进行：\n1.  通过确保持与在风险中性测度下的指定连续时间几何布朗运动 (GBM) 模型的一致性，推导离散时间二叉树格模型参数（$u$, $d$, $p$）。\n2.  构建用于评估美式期权的向后归纳算法，该算法涉及在格模型的每个节点上比较继续价值与立即执行价值。\n3.  为波动率 $\\sigma=0$ 或到期时间 $T=0$ 的退化情况指定正确的逻辑程序。\n\n**1. 连续时间模型与二叉树离散化**\n\n规定项目总价值 $X_t$ 在风险中性测度 $Q$ 下遵循几何布朗运动。其随机微分方程 (SDE) 为：\n$$\ndX_t = (r - \\delta) X_t \\, dt + \\sigma X_t \\, dW_t\n$$\n其中 $r$ 是无风险利率，$\\delta$ 是连续支付收益率，$\\sigma$ 是波动率，$W_t$ 是在 $Q$ 下的标准维纳过程。\n\n我们的目标是用一个包含 $N$ 个时间步长（时长为 $\\Delta t = T/N$）的离散时间二叉树格模型来近似这个连续过程。在这个格模型中，如果一个节点上的项目价值为 $X$，在下一个时间步长 $\\Delta t$ 中，它可以向上移动到 $X \\cdot u$ 或向下移动到 $X \\cdot d$，其中 $u$ 和 $d$ 分别是上涨和下跌的乘法因子。格模型必须被构造成重组的，这意味着先上涨后下跌的序列与先下跌后上涨的序列结果相同 ($ud=du$)。如果 $ud=1$，这个条件就得到满足。\n\n**2. 格模型参数的推导**\n\n离散模型的参数——上涨因子 $u$、下跌因子 $d$ 和上涨的风险中性概率 $p$——是通过将离散过程的矩与连续过程的矩在 $\\Delta t$ 的主导阶上进行匹配来推导的。最常用且最稳健的方法，由 Cox, Ross, 和 Rubinstein (CRR) 提出，如下所示。\n\n首先，我们设置上涨和下跌因子以匹配标的资产过程的波动率。在连续模型中，一个周期 $\\Delta t$ 内的对数回报率的方差是 $\\text{Var}[\\ln(X_{t+\\Delta t}/X_t)] = \\sigma^2 \\Delta t$。我们在我们的一步二叉树模型中强制执行这一点，其中对数回报率要么是 $\\ln u$ 要么是 $\\ln d$。通过将运动设置为围绕零对称，$\\ln u = -\\ln d$，我们选择：\n$$\nu = e^{\\sigma \\sqrt{\\Delta t}} \\quad \\text{和} \\quad d = e^{-\\sigma \\sqrt{\\Delta t}}\n$$\n这个选择确保了 $ud=1$，使格模型成为重组格模型。它也匹配了过程的对数回报率的方差。\n\n其次，我们通过匹配预期回报来确定风险中性概率 $p$。在风险中性的世界里，支付连续收益率 $\\delta$ 的资产的期望值必须以 $r-\\delta$ 的速率增长。因此，贴现后的资产价格 $e^{-(r-\\delta)t}X_t$ 必须是一个鞅。这意味着 $E_t^Q[X_{t+\\Delta t}] = X_t e^{(r-\\delta)\\Delta t}$。\n在我们的离散模型中，$X_{t+\\Delta t}$ 的期望值为 $p(X_t u) + (1-p)(X_t d)$。将两者相等得到：\n$$\np(X_t u) + (1-p)(X_t d) = X_t e^{(r-\\delta)\\Delta t}\n$$\n两边除以 $X_t$ 并解出 $p$：\n$$\np(u-d) + d = e^{(r-\\delta)\\Delta t}\n$$\n$$\np = \\frac{e^{(r-\\delta)\\Delta t} - d}{u - d}\n$$\n对 $u$、$d$ 和 $p$ 的这些选择定义了我们的重组二叉树格模型，它近似于给定的 GBM。\n\n**3. 估值算法：向后归纳**\n\n美式期权的价值通过在格模型上进行向后归纳来找到。\n\n**步骤 3.1：终端条件**\n在到期时间 $T$（或步骤 $j=N$），当且仅当项目价值 $X_{N,i}$ 超过投资成本 $I$ 时，期权才会被行使。因此，在 $N+1$ 个终端节点 $(N, i)$ 中每个节点的期权价值是其内在价值：\n$$\nV_{N,i} = \\max(X_{N,i} - I, 0)\n$$\n其中 $i$ 是上涨的次数（$i = 0, 1, \\dots, N$），且 $X_{N,i} = X_0 u^i d^{N-i}$。\n\n**步骤 3.2：递推步骤**\n然后我们从 $j=N-1$ 向下到 $j=0$ 回溯时间。在任何节点 $(j, i)$，美式期权的持有者有两个选择：立即行权或等待（继续）。\n\n立即行权的价值是该节点的内在价值：\n$$\nE_{j,i} = \\max(X_{j,i} - I, 0)\n$$\n其中 $X_{j,i} = X_0 u^i d^{j-i}$。\n\n继续（持有期权再过一个时期）的价值是在风险中性测度下，下一时期期权的贴现期望价值：\n$$\nC_{j,i} = e^{-r \\Delta t} \\left[ p \\cdot V_{j+1, i+1} + (1-p) \\cdot V_{j+1, i} \\right]\n$$\n其中 $V_{j+1, i+1}$ 和 $V_{j+1, i}$ 分别是后续上涨和下跌节点的已知期权价值。\n\n由于期权是美式的，持有者会选择价值最大化的行动。因此，节点 $(j,i)$ 的期权价值是：\n$$\nV_{j,i} = \\max(C_{j,i}, E_{j,i})\n$$\n这个递推重复进行，直到我们到达树的根节点 $j=0, i=0$。价值 $V_{0,0}$ 就是我们所求的在时间 $t=0$ 时的期权价值。\n\n**4. 特殊情况处理**\n\n通用算法必须针对测试套件中提供的两种特定退化情况进行调整。\n\n**情况 1：$T=0$（零到期日）**\n如果到期时间为零，期权必须立即行使，否则将变得毫无价值。没有时间价值。其价值就是 $t=0$ 时立即行使的回报：\n$$\nV_0 = \\max(X_0 - I, 0)\n$$\n\n**情况 2：$\\sigma=0$（零波动率）**\n如果波动率为零，随机过程退化为确定性过程。SDE 变为常微分方程 $dX_t = (r - \\delta) X_t dt$，其解为：\n$$\nX_t = X_0 e^{(r-\\delta)t}\n$$\n项目价值的未来路径是确定已知的。标准的二叉树参数公式会失效，因为 $u=d=1$，导致计算 $p$ 时出现除以零的情况。相反，问题简化为从可能的离散行权日期集合 $\\{t_j = j \\Delta t \\mid j=0, 1, \\dots, N\\}$ 中找到最优行权时间 $t^*$。\n在未来时间 $t_j$ 行权的 $t=0$ 时刻的价值是贴现后的回报：\n$$\n\\text{Value}(t_j) = e^{-r t_j} \\max(X_{t_j} - I, 0) = e^{-r t_j} \\max(X_0 e^{(r-\\delta)t_j} - I, 0)\n$$\n最优策略是选择使该价值最大化的时间 $t_j$。因此，期权价值是：\n$$\nV_0 = \\max_{j \\in \\{0, 1, \\dots, N\\}} \\left\\{ e^{-r (j \\Delta t)} \\max(X_0 e^{(r-\\delta)(j \\Delta t)} - I, 0) \\right\\}\n$$\n这是一个在 $N+1$ 个离散选择上的简单优化问题。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the value of an American real option using a binomial lattice model.\n    \"\"\"\n\n    def compute_option_value(X0, I, r, delta, sigma, T, N):\n        \"\"\"\n        Computes the American real option value for a single set of parameters.\n\n        Args:\n            X0 (float): Initial project value.\n            I (float): Investment cost.\n            r (float): Risk-free rate.\n            delta (float): Continuous payout yield.\n            sigma (float): Volatility.\n            T (float): Time to maturity in years.\n            N (int): Number of time steps in the binomial lattice.\n\n        Returns:\n            float: The value of the American option at time t=0.\n        \"\"\"\n        # Handle the degenerate case where maturity T=0.\n        if T == 0:\n            return max(X0 - I, 0.0)\n\n        # Handle the degenerate case where volatility sigma=0.\n        # The process is deterministic.\n        if sigma == 0:\n            dt = T / N\n            # Create an array of discrete time points for possible exercise.\n            times = np.arange(N + 1) * dt\n            \n            # Calculate project values at each time point.\n            project_values = X0 * np.exp((r - delta) * times)\n            \n            # Calculate intrinsic payoffs at each time point.\n            payoffs = np.maximum(project_values - I, 0.0)\n            \n            # Discount payoffs back to t=0.\n            discount_factors = np.exp(-r * times)\n            discounted_payoffs = payoffs * discount_factors\n            \n            # The option value is the maximum of all possible discounted payoffs.\n            return np.max(discounted_payoffs)\n\n        # Standard binomial lattice model for sigma > 0.\n        dt = T / N\n        \n        # Calculate Cox-Ross-Rubinstein (CRR) parameters.\n        u = np.exp(sigma * np.sqrt(dt))\n        d = 1.0 / u\n        p = (np.exp((r - delta) * dt) - d) / (u - d)\n        \n        discount_factor = np.exp(-r * dt)\n\n        # Initialize a 1D array to store option values at each step.\n        # Start with terminal values at maturity T (step N).\n        # There are N+1 nodes at the final step.\n        # Prices at maturity: S_T = S_0 * u^i * d^(N-i) for i = 0 to N\n        # This can be computed efficiently.\n        prices_at_maturity = X0 * (d ** np.arange(N, -1, -1)) * (u ** np.arange(0, N + 1, 1))\n        V = np.maximum(prices_at_maturity - I, 0.0)\n\n        # Perform backward induction from step N-1 to 0.\n        for j in range(N - 1, -1, -1):\n            # The V array currently holds j+2 values from step j+1.\n            # We compute j+1 values for step j.\n            \n            # Continuation value: discounted expected value of the next step.\n            # V[:-1] corresponds to V_{j+1, i} states, V[1:] to V_{j+1, i+1} states.\n            continuation_values = discount_factor * (p * V[1:j+2] + (1 - p) * V[0:j+1])\n            \n            # Project prices at step j.\n            prices_at_j = X0 * (d ** np.arange(j, -1, -1)) * (u ** np.arange(0, j + 1, 1))\n            \n            # Exercise values at step j.\n            exercise_values = np.maximum(prices_at_j - I, 0.0)\n            \n            # For American option, the value at each node is the max of continuing and exercising.\n            V = np.maximum(continuation_values, exercise_values)\n\n        # The final result is the single value at the root of the tree.\n        return V[0]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (X0, I, r, delta, sigma, T, N)\n        (100.0, 90.0, 0.06, 0.02, 0.20, 3.0, 150),\n        (120.0, 100.0, 0.06, 0.00, 0.00, 2.0, 50),\n        (80.0, 100.0, 0.05, 0.02, 0.25, 0.0, 1),\n        (150.0, 140.0, 0.05, 0.25, 0.30, 2.0, 100),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_option_value(*case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "许多现实世界的能源投资涉及离散单位（如涡轮机数量）和预算限制，这些复杂性难以用标准的连续时间模型处理。本练习介绍了一个强大的两阶段随机规划框架来应对这些挑战。通过解决这个问题，你将学会如何优化一个包含立即投资和延迟投资权的组合，从而在不确定性下做出最优的整数决策。",
            "id": "4115374",
            "problem": "考虑一个能源系统中的两阶段实物期权投资问题，该问题在风险中性定价下被建模为一个混合整数随机规划。一个能源开发商决定第一阶段的整数投资，并保留在不确定性消除后进行后续投资的权利。该设定使用兆瓦 (MW) 作为离散容量单位，所有现金流均以每兆瓦百万货币单位的现值计算。开发商有第一阶段的预算约束。第二阶段的决策依赖于情景，并且在不确定的利润实现后做出。\n\n基本原理和定义：\n- 在风险中性定价下，不确定现金流的净现值 (NPV) 是其相对于风险中性概率测度的折现期望。设折现因子为 $\\beta \\in (0,1)$，情景集合为 $\\mathcal{S}$，其概率为 $\\{p_s\\}_{s \\in \\mathcal{S}}$，满足 $\\sum_{s \\in \\mathcal{S}} p_s = 1$ 且对于所有 $s \\in \\mathcal{S}$ 都有 $p_s \\ge 0$。\n- 设 $m_0$ 表示第一阶段每兆瓦的净运营利润，设 $m_{1,s}$ 表示情景 $s \\in \\mathcal{S}$ 下第二阶段每兆瓦的净运营利润。利润被理解为扣除可变运营成本后的收入，并且是非负的。\n- 设 $c_0$ 表示立即建设的第一阶段每兆瓦资本支出， $c_1$ 表示延迟建设的第二阶段每兆瓦资本支出， $r$ 表示第一阶段每兆瓦的保留成本，该成本授予在第二阶段进行建设的选择权。\n- 设 $B_0$ 表示第一阶段的预算。\n- 设 $x_0 \\in \\{0,1,2,\\dots,X_{\\max}\\}$ 是在第一阶段立即建设的整数兆瓦数。设 $k \\in \\{0,1,2,\\dots,K_{\\max}\\}$ 是在第一阶段获得的保留整数兆瓦数。设 $y_s \\in \\{0,1,2,\\dots,k\\}$ 是在情景 $s$ 下第二阶段行权（建设）的整数兆瓦数。决策 $x_0$ 和 $k$ 是第一阶段决策，必须满足非预期性（即，它们不能依赖于情景的实现），而追索决策 $\\{y_s\\}$ 是第二阶段决策，可以依赖于已实现的情景 $s$。\n- 第一阶段的预算约束是 $c_0 x_0 + r k \\le B_0$。\n- 现金流组成部分定义如下：\n  - 第一阶段现金流：$m_0 x_0 - c_0 x_0 - r k$。\n  - 情景 $s$ 下的第二阶段现金流：$m_{1,s}(x_0 + y_s) - c_1 y_s$，在风险中性期望中，通过 $\\beta$ 进行折现，并由 $p_s$ 加权。\n\n目标和决策逻辑：\n- 开发商的目标是在整数决策空间上最大化期望折现净现值，受上述预算和整数约束的限制。\n- 在第二阶段，对于每个情景 $s$，必须选择追索决策 $y_s$ 以在给定已实现的 $m_{1,s}$ 和保留上限 $k$ 的情况下，最大化该情景的贡献。由于情景现金流在 $y_s$ 上是线性的，并且存在整数约束，最优的 $y_s$ 要么等于 $0$ 要么等于 $k$（或在每兆瓦净值等于零的临界情况下，介于两者之间的任何整数），这与界限 $0 \\le y_s \\le k$ 一致。\n\n平局打破规则：\n- 如果多个不同的元组 $(x_0,k,\\{y_s\\}_{s \\in \\mathcal{S}})$ 在数值容差 $10^{-12}$ 内达到相同的最优期望折现净现值，则对于固定的情景排序，选择排序 $(x_0,k,y_{s_1},y_{s_2},\\dots)$ 中字典序最小的元组。\n\n单位和输出：\n- 所有货币量必须以百万货币单位表示。输出的期望折现净现值必须以百万货币单位报告，并四舍五入到六位小数。\n\n编程任务：\n- 实现一个求解器，该求解器枚举预算约束下所有可行的第一阶段整数决策 $(x_0,k)$，并为每个情景 $s$ 枚举可行的第二阶段整数追索决策 $y_s \\in \\{0,1,\\dots,k\\}$，选择那些能最大化期望折现净现值的决策。使用带有折现因子 $\\beta$ 的风险中性期望。\n\n测试套件：\n- 在每个测试案例中使用一个包含两个情景的集合 $\\mathcal{S} = \\{H,L\\}$，其概率为 $(p_H,p_L)$。对于每个测试案例，计算并返回最优决策 $(x_0,k,y_H,y_L)$ 和相应的最优期望折现净现值。四个测试案例如下：\n\n  1. 常规情况，盈利能力和保留成本适中：\n     - $X_{\\max} = 3$, $K_{\\max} = 3$, $B_0 = 1.2$, $\\beta = 0.95$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.6$, $m_{1,H} = 1.2$, $m_{1,L} = 0.2$, $c_0 = 1.0$, $c_1 = 1.0$, $r = 0.1$.\n  2. 边缘情况，等待本质上无利可图（第二阶段利润低于第二阶段资本支出）：\n     - $X_{\\max} = 1$, $K_{\\max} = 3$, $B_0 = 0.9$, $\\beta = 0.92$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.8$, $m_{1,H} = 0.7$, $m_{1,L} = 0.5$, $c_0 = 0.9$, $c_1 = 0.9$, $r = 0.05$.\n  3. 边界情况，预算恰好用完且未来利润不对称：\n     - $X_{\\max} = 1$, $K_{\\max} = 3$, $B_0 = 0.3$, $\\beta = 0.9$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.5$, $m_{1,H} = 1.1$, $m_{1,L} = 0.0$, $c_0 = 0.3$, $c_1 = 0.8$, $r = 0.1$.\n  4. 折现因子较低导致未来价值减少且概率倾斜的情况：\n     - $X_{\\max} = 2$, $K_{\\max} = 2$, $B_0 = 1.35$, $\\beta = 0.6$, $p_H = 0.6$, $p_L = 0.4$, $m_0 = 0.7$, $m_{1,H} = 2.0$, $m_{1,L} = 0.1$, $c_0 = 1.0$, $c_1 = 1.2$, $r = 0.15$.\n\n最终输出格式规范：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表的结果（例如，$[result_1,result_2,\\dots]$）。每个 $result_i$ 必须是 $[x_0,k,y_H,y_L,\\text{EV}]$ 形式的列表，不含空格，其中 $\\text{EV}$ 是最优期望折现净现值，以百万货币单位表示，四舍五入到六位小数。在所有测试案例中，$(y_H,y_L)$ 的情景排序必须是 $(H,L)$。",
            "solution": "该问题是一个定义明确的两阶段混合整数随机规划，用于能源系统中的实物期权投资决策。该公式基于风险中性定价和动态规划的标准原则。所有参数、约束和决策变量都得到了清晰明确的定义，为测试案例提供的数据是自洽和完整的。没有科学或数学上的缺陷，目标是在有限的离散选择集合上最大化一个明确指定的净现值 (NPV)，这保证了解的存在性。平局打破规则确保了解的唯一性。因此，该问题是有效的，并且可以推导出解。\n\n问题在于找到最优的第一阶段整数决策，用于立即投资（$x_0$）和容量保留（$k$），以及为每个情景 $s \\in \\mathcal{S}$ 找到最优的第二阶段整数追索决策，用于行使保留的期权（$y_s$）。目标是最大化期望折现净现值 (NPV)。\n\n设决策变量为：\n- $x_0 \\in \\{0, 1, \\dots, X_{\\max}\\}$: 第一阶段建设的整数容量。\n- $k \\in \\{0, 1, \\dots, K_{\\max}\\}$: 第一阶段为未来可能建设而保留的整数容量。\n- $y_s \\in \\{0, 1, \\dots, k\\}$: 在情景 $s$ 下第二阶段建设的整数容量。\n\n总期望折现NPV是第一阶段现金流与所有情景 $s \\in \\mathcal{S}$ 下第二阶段现金流的折现期望值之和。目标函数的数学公式为：\n$$ \\text{NPV}(x_0, k, \\{y_s\\}) = \\underbrace{(m_0 - c_0)x_0 - rk}_{\\text{第一阶段现金流}} + \\underbrace{\\beta \\sum_{s \\in \\mathcal{S}} p_s \\left( m_{1,s}(x_0 + y_s) - c_1 y_s \\right)}_{\\text{折现期望第二阶段现金流}} $$\n其中 $\\beta$ 是折现因子， $p_s$ 是情景 $s$ 的风险中性概率。第一阶段决策必须满足预算约束：\n$$ c_0 x_0 + r k \\le B_0 $$\n该问题具有两阶段结构，适合通过动态规划求解，或者在这种情况下，鉴于决策空间小且离散，可通过结构化枚举求解。求解方法如下：\n\n1.  **第一阶段枚举**：我们遍历所有可能的第一阶段整数决策组合 $(x_0, k)$，在其各自的界限内（$x_0 \\le X_{\\max}$，$k \\le K_{\\max}$）。对于每一对，我们检查其是否满足第一阶段预算约束 $c_0 x_0 + r k \\le B_0$。\n\n2.  **第二阶段优化**：对于每个可行的第一阶段决策对 $(x_0, k)$，我们确定最优的第二阶段追索决策 $\\{y_s\\}_{s \\in \\mathcal{S}}$。每个情景 $s$ 的决策独立于其他情景，旨在最大化其对总NPV的贡献。NPV目标函数中依赖于 $y_s$ 的部分是：\n    $$ \\beta p_s \\left( m_{1,s}(x_0 + y_s) - c_1 y_s \\right) $$\n    由于在此阶段 $x_0$ 是固定的，且 $\\beta p_s > 0$，最大化该项等价于在约束 $0 \\le y_s \\le k$ 下最大化行使期权所带来的单位净利润 $(m_{1,s} - c_1)y_s$。\n    由于 $y_s$ 的线性性质，最优决策 $y_s^*$ 位于可行集 $\\{0, 1, \\dots, k\\}$ 的边界上：\n    - 如果行使的净利润为正，即 $m_{1,s} - c_1 > 0$，则最优决策是行使所有保留的期权：$y_s^* = k$。\n    - 如果净利润为非正，即 $m_{1,s} - c_1 \\le 0$，则最优决策是不行使任何期权：$y_s^* = 0$。\n\n3.  **NPV 计算与选择**：对于每个可行决策对 $(x_0, k)$ 及其对应的最优追索决策 $\\{y_s^*\\}$，我们使用完整的目标函数计算总期望折现NPV。我们记录迄今为止发现的最高NPV以及产生它的决策元组 $(x_0, k, \\{y_s^*\\})$。如果一个新的决策元组产生的NPV大于当前最大值（在 $10^{-12}$ 的数值容差内），它就成为新的最优解。如果一个元组产生的NPV在数值上等于当前最大值，则调用平局打破规则：选择字典序较小的元组。指定的情景排序为 $(H,L)$，因此用于比较的元组是 $(x_0, k, y_H, y_L)$。\n\n在有限、离散的决策空间上进行这种枚举，保证能找到全局最优的投资策略。实现将通过系统地探索所有有效的第一阶段选择，并为每个选择应用最优的第二阶段策略来展开。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves a two-stage real options investment problem for a given set of test cases.\n    The method enumerates all feasible first-stage decisions and determines the optimal\n    second-stage recourse decisions to maximize the expected discounted NPV.\n    \"\"\"\n    \n    test_cases = [\n        # Case 1: Happy-path moderate profitability and reservation\n        {\"X_max\": 3, \"K_max\": 3, \"B0\": 1.2, \"beta\": 0.95, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.6, \"m1_H\": 1.2, \"m1_L\": 0.2, \"c0\": 1.0, \"c1\": 1.0, \"r\": 0.1},\n        # Case 2: Edge case where waiting is intrinsically unprofitable\n        {\"X_max\": 1, \"K_max\": 3, \"B0\": 0.9, \"beta\": 0.92, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.8, \"m1_H\": 0.7, \"m1_L\": 0.5, \"c0\": 0.9, \"c1\": 0.9, \"r\": 0.05},\n        # Case 3: Boundary case with exact budget fit\n        {\"X_max\": 1, \"K_max\": 3, \"B0\": 0.3, \"beta\": 0.9, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.5, \"m1_H\": 1.1, \"m1_L\": 0.0, \"c0\": 0.3, \"c1\": 0.8, \"r\": 0.1},\n        # Case 4: Low discount factor and skewed probabilities\n        {\"X_max\": 2, \"K_max\": 2, \"B0\": 1.35, \"beta\": 0.6, \"p_H\": 0.6, \"p_L\": 0.4,\n         \"m0\": 0.7, \"m1_H\": 2.0, \"m1_L\": 0.1, \"c0\": 1.0, \"c1\": 1.2, \"r\": 0.15},\n    ]\n\n    results = []\n    \n    for params in test_cases:\n        X_max, K_max = params[\"X_max\"], params[\"K_max\"]\n        B0, beta = params[\"B0\"], params[\"beta\"]\n        p_H, p_L = params[\"p_H\"], params[\"p_L\"]\n        m0, m1_H, m1_L = params[\"m0\"], params[\"m1_H\"], params[\"m1_L\"]\n        c0, c1, r = params[\"c0\"], params[\"c1\"], params[\"r\"]\n        \n        best_npv = -np.inf\n        # Initialize with a lexicographically large tuple\n        best_decision = (X_max + 1, K_max + 1, K_max + 1, K_max + 1)\n        \n        # Enumerate all first-stage decisions (x0, k)\n        for x0 in range(X_max + 1):\n            for k in range(K_max + 1):\n                # Check budget constraint\n                if c0 * x0 + r * k > B0:\n                    continue\n                \n                # Determine optimal second-stage decisions (y_H, y_L)\n                # Optimal y_s is k if m1_s > c1, and 0 otherwise.\n                y_H = k if m1_H - c1 > 0 else 0\n                y_L = k if m1_L - c1 > 0 else 0\n                \n                # Calculate total expected NPV for the current decision tuple\n                # First-stage cash flow\n                first_stage_cf = (m0 - c0) * x0 - r * k\n                \n                # Second-stage cash flow for scenario H\n                second_stage_cf_H = m1_H * (x0 + y_H) - c1 * y_H\n                \n                # Second-stage cash flow for scenario L\n                second_stage_cf_L = m1_L * (x0 + y_L) - c1 * y_L\n                \n                # Total expected NPV\n                current_npv = first_stage_cf + beta * (p_H * second_stage_cf_H + p_L * second_stage_cf_L)\n\n                current_decision = (x0, k, y_H, y_L)\n\n                # Update best decision based on NPV and tie-breaking rule\n                # Numerical tolerance for float comparison\n                TOLERANCE = 1e-12\n                if current_npv > best_npv + TOLERANCE:\n                    best_npv = current_npv\n                    best_decision = current_decision\n                elif abs(current_npv - best_npv) = TOLERANCE:\n                    # Tie-breaking: choose lexicographically smallest tuple\n                    if current_decision  best_decision:\n                        best_npv = current_npv\n                        best_decision = current_decision\n\n        result_list = list(best_decision) + [f\"{best_npv:.6f}\"]\n        results.append(str(result_list).replace(\" \", \"\").replace(\"'\", \"\"))\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在对长期项目进行估值时，分析框架的选择——采用真实（扣除通胀）价值还是名义价值——会显著影响最终的估值和决策。本练习通过一个思想实验，让你分析并推导在通胀指数化成本和固定名义成本两种情况下，最优的投资触发点有何不同。这个过程将揭示关于延迟期权价值的重要经济直觉，并加深你对通货膨胀在资本预算中作用的理解。",
            "id": "4115355",
            "problem": "一家独立发电商正在考虑一项永续投资期权，用于投资一个灵活性天然气调峰机组，该机组的净运营现金流与一个能源市场状态变量成正比。设单位容量的标的真实项目价值为 $X_t$，在风险中性测度下被建模为具有恒定波动率和支付收益率的几何布朗运动 (GBM)。具体来说，以真实单位计算，$X_t$ 满足 $dX_t = X_t \\left( (r_r - \\delta) \\, dt + \\sigma \\, dW_t \\right)$，其中 $r_r$ 是连续复利的真实无风险利率，$\\delta$ 是以真实价值计算的恒定现金流或股息收益率，$\\sigma$ 是波动率，$W_t$ 是标准布朗运动。\n\n通货膨胀被建模为连续复利率 $\\pi$，名义短期利率 $r_n$ 与真实短期利率 $r_r$ 通过 Fisher 关系 $r_n = r_r + \\pi$ 相关联。相应的名义价值过程是 $S_t = I_t X_t$，其中 $I_t$ 是价格水平。在风险中性测度下，这意味着 $dS_t = S_t \\left( (r_n - \\delta) \\, dt + \\sigma \\, dW_t \\right)$，因为支付收益率按比例应用于名义价值。\n\n该公司有两种备选的投资成本合同结构：\n- 情况 R（指数化成本）：投资成本完全与通货膨胀挂钩，以真实价值计算是恒定的，等于 $K_{\\text{real}}$。\n- 情况 N（非指数化成本）：投资成本是一个固定的名义金额，等于 $K_{\\text{nom}}$，不根据通货膨胀进行调整。\n\n假设在 $t=0$ 时 $K_{\\text{real}} = K_{\\text{nom}}$，并且初始价格水平满足 $I_0 = 1$，因此在 $t=0$ 时，当以名义价值表示时，两种成本是相同的。该公司将每种情况下的投资期权都视为一项永续美式期权进行估值，通过支付成本来获取资产并获得其标的价值。公司寻求在每种框架下的最优投资阈值：\n- 在情况 R 中，最优真实阈值 $X^{\\ast}_{R}$（以真实货币单位表示）。\n- 在情况 N 中，最优名义阈值 $S^{\\ast}_{N}$（以名义货币单位表示）。\n\n从 Fisher 关系 $r_n = r_r + \\pi$ 和具有支付收益率的 GBM 的无套利风险中性估值出发，推导永续投资期权的控制方程和边界条件，求解每种情况下的最优投资阈值，并计算比率\n$$\nR \\equiv \\frac{S^{\\ast}_{N}}{S^{\\ast}_{R,\\text{nom}}},\n$$\n其中 $S^{\\ast}_{R,\\text{nom}}$ 表示在 $t=0$ 时使用 $I_0=1$ 将情况 R 的阈值转换为名义单位。使用参数值 $r_n = 0.07$，$\\pi = 0.03$，$\\delta = 0.02$，$\\sigma = 0.25$ 以及 $K_{\\text{real}} = K_{\\text{nom}}  0$。将最终比率表示为一个无单位的数，并将您的答案四舍五入到四位有效数字。",
            "solution": "问题陈述经评估是有效的。其科学基础在于金融工程和实物期权分析的既定原则，特别是 Black-Scholes-Merton 框架在永续美式期权上的应用。这个问题是适定的，提供了所有必要的参数、定义和关系，以确定一个唯一且有意义的解。语言客观精确，参数值对于能源经济学中的程式化模型而言是现实的。不存在矛盾、歧义或事实错误。因此，我们可以着手求解。\n\n该问题要求在两种不同的成本结构下，找到永续美式期权的最优投资阈值。期权的价值（我们称之为 $F$）作为标的资产价值 $V$ 的函数，在期权未被行权的区域内，由以下常微分方程控制：\n$$\n\\frac{1}{2} \\sigma^2 V^2 \\frac{d^2 F}{dV^2} + (r - q) V \\frac{dF}{dV} - r F = 0\n$$\n这里，$r$ 是适当的无风险利率，$q$ 是资产的连续支付收益率，$\\sigma$ 是资产价值的波动率。这个柯西-欧拉方程的通解形式为 $F(V) = A_1 V^{\\beta_1} + A_2 V^{\\beta_2}$，其中 $\\beta_1$ 和 $\\beta_2$ 是指标方程的根：\n$$\n\\frac{1}{2} \\sigma^2 \\beta(\\beta-1) + (r - q) \\beta - r = 0\n$$\n一个根 $\\beta_1$ 是正数且大于1，而另一个根 $\\beta_2$ 是负数。对于看涨期权，如果资产价值为零，期权价值必须为零，因此我们舍弃带有负指数的解，因为它在 $V \\to 0$ 时会发散至无穷大。因此，解为 $F(V) = A V^{\\beta_1}$。\n\n为了找到最优投资阈值 $V^{\\ast}$ 和常数 $A$，我们在阈值处应用价值匹配和平滑粘贴条件：\n1. 价值匹配：$F(V^{\\ast}) = V^{\\ast} - K$，其中 $K$ 是投资成本。\n2. 平滑粘贴：$\\frac{dF}{dV}(V^{\\ast}) = 1$。\n\n将这些条件应用于 $F(V) = A V^{\\beta_1}$：\n1. $A (V^{\\ast})^{\\beta_1} = V^{\\ast} - K$\n2. $A \\beta_1 (V^{\\ast})^{\\beta_1-1} = 1$\n\n从第二个条件，我们解出 $A = \\frac{(V^{\\ast})^{1-\\beta_1}}{\\beta_1}$。将此代入第一个条件得到：\n$$\n\\frac{(V^{\\ast})^{1-\\beta_1}}{\\beta_1} (V^{\\ast})^{\\beta_1} = V^{\\ast} - K \\implies \\frac{V^{\\ast}}{\\beta_1} = V^{\\ast} - K\n$$\n求解 $V^{\\ast}$ 得到最优阈值的通用公式：\n$$\nV^{\\ast} = \\left(\\frac{\\beta_1}{\\beta_1 - 1}\\right) K\n$$\n正根 $\\beta_1$ 由二次方程求根公式给出：\n$$\n\\beta_1 = \\frac{-\\left(r - q - \\frac{1}{2}\\sigma^2\\right) + \\sqrt{\\left(r - q - \\frac{1}{2}\\sigma^2\\right)^2 + 2r\\sigma^2}}{\\sigma^2}\n$$\n\n我们现在将这个通用框架应用于两种具体情况。\n\n**情况 R（指数化成本）：真实价值框架**\n分析以真实价值进行。状态变量是真实项目价值 $X_t$。\n- 状态变量：$V = X$\n- 投资成本：$K = K_{\\text{real}}$\n- 无风险利率：$r = r_r$ (真实无风险利率)\n- 支付收益率：$q = \\delta$\n- 波动率：$\\sigma$\n\n真实无风险利率 $r_r$ 由 Fisher 关系推导得出：$r_r = r_n - \\pi$。\n以真实价值计算的最优投资阈值 $X^{\\ast}_{R}$ 为：\n$$\nX^{\\ast}_{R} = \\left(\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}\\right) K_{\\text{real}}\n$$\n其中 $\\beta_{1,R}$ 是使用真实利率 $r_r$ 的特征方程的正根：\n$$\n\\frac{1}{2} \\sigma^2 \\beta^2 + \\left(r_r - \\delta - \\frac{1}{2}\\sigma^2\\right) \\beta - r_r = 0\n$$\n\n**情况 N（非指数化成本）：名义价值框架**\n分析以名义价值进行。状态变量是名义项目价值 $S_t$。\n- 状态变量：$V = S$\n- 投资成本：$K = K_{\\text{nom}}$\n- 无风险利率：$r = r_n$ (名义无风险利率)\n- 支付收益率：$q = \\delta$\n- 波动率：$\\sigma$\n\n以名义价值计算的最优投资阈值 $S^{\\ast}_{N}$ 为：\n$$\nS^{\\ast}_{N} = \\left(\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}\\right) K_{\\text{nom}}\n$$\n其中 $\\beta_{1,N}$ 是使用名义利率 $r_n$ 的特征方程的正根：\n$$\n\\frac{1}{2} \\sigma^2 \\beta^2 + \\left(r_n - \\delta - \\frac{1}{2}\\sigma^2\\right) \\beta - r_n = 0\n$$\n\n**计算比率**\n问题要求计算比率 $R \\equiv \\frac{S^{\\ast}_{N}}{S^{\\ast}_{R,\\text{nom}}}$。\n$S^{\\ast}_{R,\\text{nom}}$ 是在 $t=0$ 时将情况 R 的真实阈值 $X^{\\ast}_{R}$ 转换为名义单位。转换关系为 $S = I_t X$。在 $t=0$ 时，给定 $I_0=1$，所以 $S^{\\ast}_{R,\\text{nom}} = I_0 X^{\\ast}_{R} = 1 \\cdot X^{\\ast}_{R} = X^{\\ast}_{R}$。\n我们还被告知 $K_{\\text{real}} = K_{\\text{nom}}$。因此，比率为：\n$$\nR = \\frac{S^{\\ast}_{N}}{X^{\\ast}_{R}} = \\frac{\\left(\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}\\right) K_{\\text{nom}}}{\\left(\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}\\right) K_{\\text{real}}} = \\frac{\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}}{\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}} = \\frac{\\beta_{1,N}(\\beta_{1,R} - 1)}{\\beta_{1,R}(\\beta_{1,N} - 1)}\n$$\n\n**数值计算**\n给定的参数值为：$r_n = 0.07$，$\\pi = 0.03$，$\\delta = 0.02$，$\\sigma = 0.25$。\n首先，我们计算真实无风险利率：\n$r_r = r_n - \\pi = 0.07 - 0.03 = 0.04$。\n我们还需要 $\\sigma^2 = (0.25)^2 = 0.0625$ 和 $\\frac{1}{2}\\sigma^2 = 0.03125$。\n\n计算 $\\beta_{1,R}$（使用 $r_r=0.04$）：\n二次求根公式中的漂移项为 $r_r - \\delta - \\frac{1}{2}\\sigma^2 = 0.04 - 0.02 - 0.03125 = -0.01125$。\n平方根下的项为：\n$(-0.01125)^2 + 2(0.04)(0.0625) = 0.0001265625 + 0.005 = 0.0051265625$。\n所以，\n$$\n\\beta_{1,R} = \\frac{-(-0.01125) + \\sqrt{0.0051265625}}{0.0625} = \\frac{0.01125 + 0.071600017458}{0.0625} \\approx 1.325600\n$$\n\n计算 $\\beta_{1,N}$（使用 $r_n=0.07$）：\n二次求根公式中的漂移项为 $r_n - \\delta - \\frac{1}{2}\\sigma^2 = 0.07 - 0.02 - 0.03125 = 0.01875$。\n平方根下的项为：\n$(0.01875)^2 + 2(0.07)(0.0625) = 0.0003515625 + 0.00875 = 0.0091015625$。\n所以，\n$$\n\\beta_{1,N} = \\frac{-(0.01875) + \\sqrt{0.0091015625}}{0.0625} = \\frac{-0.01875 + 0.09540210952}{0.0625} \\approx 1.226434\n$$\n\n现在，计算比率 $R$：\n$$\n\\beta_{1,R} - 1 \\approx 1.325600 - 1 = 0.325600\n$$\n$$\n\\beta_{1,N} - 1 \\approx 1.226434 - 1 = 0.226434\n$$\n$$\nR = \\frac{\\beta_{1,N}(\\beta_{1,R} - 1)}{\\beta_{1,R}(\\beta_{1,N} - 1)} \\approx \\frac{1.226434 \\times 0.325600}{1.325600 \\times 0.226434} \\approx \\frac{0.399259}{0.300221} \\approx 1.330369\n$$\n四舍五入到四位有效数字，比率为 $1.330$。\n$R  1$ 这个事实在经济学上是直观的。对于固定的名义投资成本，通货膨胀会随着时间的推移侵蚀其实际成本，从而使投资期权更有价值。更有价值的期权会鼓励持有者等待更长时间，因此需要更高的投资触发点。因此，名义触发点 $S^{\\ast}_{N}$ 是其成本 $K_{\\text{nom}}$ 的倍数，要大于真实触发点 $X^{\\ast}_R$ 是其成本 $K_{\\text{real}}$ 的倍数，从而导致 $R  1$。\n使用更高精度的最终计算：\n$$\n\\beta_{1,R} \\approx 1.3256002793\n$$\n$$\n\\beta_{1,N} \\approx 1.2264337523\n$$\n$$\nR = \\frac{1.2264337523 \\times (1.3256002793 - 1)}{1.3256002793 \\times (1.2264337523 - 1)} = \\frac{1.2264337523 \\times 0.3256002793}{1.3256002793 \\times 0.2264337523} \\approx 1.330369\n$$\n四舍五入到四位有效数字得到 $1.330$。",
            "answer": "$$\n\\boxed{1.330}\n$$"
        }
    ]
}