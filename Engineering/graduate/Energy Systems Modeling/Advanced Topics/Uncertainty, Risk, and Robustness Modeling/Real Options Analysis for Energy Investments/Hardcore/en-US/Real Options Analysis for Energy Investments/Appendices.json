{
    "hands_on_practices": [
        {
            "introduction": "This first practice problem takes you to the heart of real options valuation using the classic perpetual American option model. You will explore how the choice of a real versus a nominal valuation framework impacts the optimal investment threshold. This exercise is crucial for understanding the direct influence of macroeconomic variables like inflation on investment strategy and for mastering the foundational analytical solution for investment timing under uncertainty .",
            "id": "4115355",
            "problem": "An independent power producer is considering a perpetual option to invest in a flexible natural gas peaker unit whose net operating cash flow is proportional to an energy market state variable. Let the underlying real project value per unit capacity be $X_t$, modeled under the risk-neutral measure as a Geometric Brownian Motion (GBM) with constant volatility and payout yield. Specifically, in real units, $X_t$ satisfies $dX_t = X_t \\left( (r_r - \\delta) \\, dt + \\sigma \\, dW_t \\right)$, where $r_r$ is the continuously compounded real risk-free rate, $\\delta$ is a constant cash-flow or dividend yield in real terms, $\\sigma$ is the volatility, and $W_t$ is a standard Brownian motion.\n\nInflation is modeled as a continuously compounded rate $\\pi$, and the nominal short rate $r_n$ is related to the real short rate $r_r$ by the Fisher relation $r_n = r_r + \\pi$. The corresponding nominal value process is $S_t = I_t X_t$ where $I_t$ is the price level, which under the risk-neutral measure implies $dS_t = S_t \\left( (r_n - \\delta) \\, dt + \\sigma \\, dW_t \\right)$, since the payout yield applies proportionally to the nominal value.\n\nThe firm has two alternative contracting structures for the investment cost:\n- Case R (indexed cost): The investment cost is fully inflation-indexed and constant in real terms, equal to $K_{\\text{real}}$.\n- Case N (unindexed cost): The investment cost is a fixed nominal amount, equal to $K_{\\text{nom}}$, not adjusted for inflation.\n\nAssume $K_{\\text{real}} = K_{\\text{nom}}$ at $t=0$ and the initial price level satisfies $I_0 = 1$, so both costs coincide at $t=0$ when expressed in nominal terms. The firm values the option to invest in each case as a perpetual American option to acquire the asset by paying the cost and receiving the underlying value. The firm seeks the optimal investment threshold in each framework:\n- In Case R, the optimal real threshold $X^{\\ast}_{R}$ (expressed in real currency units).\n- In Case N, the optimal nominal threshold $S^{\\ast}_{N}$ (expressed in nominal currency units).\n\nStarting from the Fisher relation $r_n = r_r + \\pi$ and the no-arbitrage risk-neutral valuation for GBM with payout yield, derive the governing equation and boundary conditions for the perpetual investment option, solve for the optimal investment threshold in each case, and compute the ratio\n$$\nR \\equiv \\frac{S^{\\ast}_{N}}{S^{\\ast}_{R,\\text{nom}}},\n$$\nwhere $S^{\\ast}_{R,\\text{nom}}$ denotes the Case R threshold converted to nominal units at $t=0$ using $I_0=1$. Use the parameter values $r_n = 0.07$, $\\pi = 0.03$, $\\delta = 0.02$, $\\sigma = 0.25$, and $K_{\\text{real}} = K_{\\text{nom}} > 0$. Express the final ratio as a unitless number and round your answer to four significant figures.",
            "solution": "The problem statement is assessed to be valid. It is scientifically grounded in the established principles of financial engineering and real options analysis, specifically the application of the Black-Scholes-Merton framework to perpetual American options. The problem is well-posed, with all necessary parameters, definitions, and relationships provided to determine a unique, meaningful solution. The language is objective and precise, and the parameter values are realistic for a stylized model in energy economics. There are no contradictions, ambiguities, or factual errors. We may therefore proceed with the solution.\n\nThe problem requires finding the optimal investment thresholds for a perpetual American option under two different cost structures. The option's value, let's call it $F$, as a function of the underlying asset's value, $V$, is governed by the following ordinary differential equation in the region where the option is not exercised:\n$$\n\\frac{1}{2} \\sigma^2 V^2 \\frac{d^2 F}{dV^2} + (r - q) V \\frac{dF}{dV} - r F = 0\n$$\nHere, $r$ is the appropriate risk-free interest rate, $q$ is the continuous payout yield on the asset, and $\\sigma$ is the volatility of the asset's value. The general solution to this Cauchy-Euler equation is of the form $F(V) = A_1 V^{\\beta_1} + A_2 V^{\\beta_2}$, where $\\beta_1$ and $\\beta_2$ are the roots of the indicial equation:\n$$\n\\frac{1}{2} \\sigma^2 \\beta(\\beta-1) + (r - q) \\beta - r = 0\n$$\nOne root, $\\beta_1$, is positive and greater than $1$, while the other, $\\beta_2$, is negative. For a call option, the value must be zero if the asset value is zero, so we discard the solution with the negative exponent, which explodes as $V \\to 0$. Thus, the solution is $F(V) = A V^{\\beta_1}$.\n\nTo find the optimal investment threshold, $V^{\\ast}$, and the constant $A$, we apply the value-matching and smooth-pasting conditions at the threshold:\n1. Value-matching: $F(V^{\\ast}) = V^{\\ast} - K$, where $K$ is the investment cost.\n2. Smooth-pasting: $\\frac{dF}{dV}(V^{\\ast}) = 1$.\n\nApplying these conditions to $F(V) = A V^{\\beta_1}$:\n1. $A (V^{\\ast})^{\\beta_1} = V^{\\ast} - K$\n2. $A \\beta_1 (V^{\\ast})^{\\beta_1-1} = 1$\n\nFrom the second condition, we solve for $A = \\frac{(V^{\\ast})^{1-\\beta_1}}{\\beta_1}$. Substituting this into the first condition gives:\n$$\n\\frac{(V^{\\ast})^{1-\\beta_1}}{\\beta_1} (V^{\\ast})^{\\beta_1} = V^{\\ast} - K \\implies \\frac{V^{\\ast}}{\\beta_1} = V^{\\ast} - K\n$$\nSolving for $V^{\\ast}$ yields the general formula for the optimal threshold:\n$$\nV^{\\ast} = \\left(\\frac{\\beta_1}{\\beta_1 - 1}\\right) K\n$$\nThe positive root $\\beta_1$ is given by the quadratic formula:\n$$\n\\beta_1 = \\frac{-\\left(r - q - \\frac{1}{2}\\sigma^2\\right) + \\sqrt{\\left(r - q - \\frac{1}{2}\\sigma^2\\right)^2 + 2r\\sigma^2}}{\\sigma^2}\n$$\n\nWe now apply this general framework to the two specific cases.\n\n**Case R (indexed cost): Real Framework**\nThe analysis is performed in real terms. The state variable is the real project value, $X_t$.\n- State variable: $V = X$\n- Investment cost: $K = K_{\\text{real}}$\n- Risk-free rate: $r = r_r$ (real risk-free rate)\n- Payout yield: $q = \\delta$\n- Volatility: $\\sigma$\n\nThe real risk-free rate $r_r$ is derived from the Fisher relation: $r_r = r_n - \\pi$.\nThe optimal investment threshold in real terms, $X^{\\ast}_{R}$, is:\n$$\nX^{\\ast}_{R} = \\left(\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}\\right) K_{\\text{real}}\n$$\nwhere $\\beta_{1,R}$ is the positive root of the characteristic equation using the real rate $r_r$:\n$$\n\\frac{1}{2} \\sigma^2 \\beta^2 + \\left(r_r - \\delta - \\frac{1}{2}\\sigma^2\\right) \\beta - r_r = 0\n$$\n\n**Case N (unindexed cost): Nominal Framework**\nThe analysis is performed in nominal terms. The state variable is the nominal project value, $S_t$.\n- State variable: $V = S$\n- Investment cost: $K = K_{\\text{nom}}$\n- Risk-free rate: $r = r_n$ (nominal risk-free rate)\n- Payout yield: $q = \\delta$\n- Volatility: $\\sigma$\n\nThe optimal investment threshold in nominal terms, $S^{\\ast}_{N}$, is:\n$$\nS^{\\ast}_{N} = \\left(\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}\\right) K_{\\text{nom}}\n$$\nwhere $\\beta_{1,N}$ is the positive root of the characteristic equation using the nominal rate $r_n$:\n$$\n\\frac{1}{2} \\sigma^2 \\beta^2 + \\left(r_n - \\delta - \\frac{1}{2}\\sigma^2\\right) \\beta - r_n = 0\n$$\n\n**Computing the Ratio**\nThe problem asks for the ratio $R \\equiv \\frac{S^{\\ast}_{N}}{S^{\\ast}_{R,\\text{nom}}}$.\n$S^{\\ast}_{R,\\text{nom}}$ is the Case R real threshold $X^{\\ast}_{R}$ converted to nominal units at $t=0$. The conversion is $S = I_t X$. At $t=0$, we are given $I_0=1$, so $S^{\\ast}_{R,\\text{nom}} = I_0 X^{\\ast}_{R} = 1 \\cdot X^{\\ast}_{R} = X^{\\ast}_{R}$.\nWe are also given $K_{\\text{real}} = K_{\\text{nom}}$. Therefore, the ratio is:\n$$\nR = \\frac{S^{\\ast}_{N}}{X^{\\ast}_{R}} = \\frac{\\left(\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}\\right) K_{\\text{nom}}}{\\left(\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}\\right) K_{\\text{real}}} = \\frac{\\frac{\\beta_{1,N}}{\\beta_{1,N} - 1}}{\\frac{\\beta_{1,R}}{\\beta_{1,R} - 1}} = \\frac{\\beta_{1,N}(\\beta_{1,R} - 1)}{\\beta_{1,R}(\\beta_{1,N} - 1)}\n$$\n\n**Numerical Calculation**\nThe given parameter values are: $r_n = 0.07$, $\\pi = 0.03$, $\\delta = 0.02$, $\\sigma = 0.25$.\nFirst, we calculate the real risk-free rate:\n$r_r = r_n - \\pi = 0.07 - 0.03 = 0.04$.\nWe also need $\\sigma^2 = (0.25)^2 = 0.0625$ and $\\frac{1}{2}\\sigma^2 = 0.03125$.\n\nCalculate $\\beta_{1,R}$ (using $r_r=0.04$):\nThe drift term for the quadratic formula is $r_r - \\delta - \\frac{1}{2}\\sigma^2 = 0.04 - 0.02 - 0.03125 = -0.01125$.\nThe term under the square root is:\n$(-0.01125)^2 + 2(0.04)(0.0625) = 0.0001265625 + 0.005 = 0.0051265625$.\nSo,\n$$\n\\beta_{1,R} = \\frac{-(-0.01125) + \\sqrt{0.0051265625}}{0.0625} = \\frac{0.01125 + 0.071600017458}{0.0625} \\approx 1.325600\n$$\n\nCalculate $\\beta_{1,N}$ (using $r_n=0.07$):\nThe drift term for the quadratic formula is $r_n - \\delta - \\frac{1}{2}\\sigma^2 = 0.07 - 0.02 - 0.03125 = 0.01875$.\nThe term under the square root is:\n$(0.01875)^2 + 2(0.07)(0.0625) = 0.0003515625 + 0.00875 = 0.0091015625$.\nSo,\n$$\n\\beta_{1,N} = \\frac{-(0.01875) + \\sqrt{0.0091015625}}{0.0625} = \\frac{-0.01875 + 0.09540210952}{0.0625} \\approx 1.226434\n$$\n\nNow, compute the ratio $R$:\n$$\n\\beta_{1,R} - 1 \\approx 1.325600 - 1 = 0.325600\n$$\n$$\n\\beta_{1,N} - 1 \\approx 1.226434 - 1 = 0.226434\n$$\n$$\nR = \\frac{\\beta_{1,N}(\\beta_{1,R} - 1)}{\\beta_{1,R}(\\beta_{1,N} - 1)} \\approx \\frac{1.226434 \\times 0.325600}{1.325600 \\times 0.226434} \\approx \\frac{0.399259}{0.300221} \\approx 1.330369\n$$\nRounding to four significant figures, the ratio is $1.330$.\nThe fact that $R > 1$ is economically intuitive. With a fixed nominal investment cost, inflation erodes the real cost over time, making the option to invest more valuable. A more valuable option encourages the holder to wait longer, thus requiring a higher investment trigger. The nominal trigger $S^{\\ast}_{N}$ is therefore a larger multiple of its cost $K_{\\text{nom}}$ than the real trigger $X^{\\ast}_R$ is of its cost $K_{\\text{real}}$, leading to $R > 1$.\nFinal calculation using higher precision:\n$$\n\\beta_{1,R} \\approx 1.3256002793\n$$\n$$\n\\beta_{1,N} \\approx 1.2264337523\n$$\n$$\nR = \\frac{1.2264337523 \\times (1.3256002793 - 1)}{1.3256002793 \\times (1.2264337523 - 1)} = \\frac{1.2264337523 \\times 0.3256002793}{1.3256002793 \\times 0.2264337523} \\approx 1.330369\n$$\nRounding to four significant figures gives $1.330$.",
            "answer": "$$\n\\boxed{1.330}\n$$"
        },
        {
            "introduction": "While analytical solutions provide deep insights, most real-world options have finite lifespans and other complexities that require numerical methods. This hands-on coding exercise challenges you to build a recombining binomial lattice from first principles to value an American-style investment option. By translating the theory of Geometric Brownian Motion and risk-neutral valuation into a functional algorithm, you will gain a practical and indispensable skill for tackling a wide range of real options problems .",
            "id": "4115364",
            "problem": "Consider an energy investment problem where the gross project value $X_t$ (in million United States dollars) evolves stochastically over continuous time following a Geometric Brownian Motion (GBM). Assume a frictionless market, absence of arbitrage, and the existence of a unique equivalent martingale measure (risk-neutral measure). Under the risk-neutral measure, $X_t$ satisfies the stochastic differential equation $dX_t = (r - \\delta) X_t \\, dt + \\sigma X_t \\, dW_t$, with constant parameters: risk-free continuously compounded rate $r$, continuous payout yield $\\delta$, and volatility $\\sigma$. The decision-maker holds a real option to invest by paying an irreversible investment cost $I$ (in million United States dollars) at any time $t \\in [0, T]$. Upon investment, the project is immediately realized and its payoff equals the net present value at that time, modeled as $\\max(X_t - I, 0)$ (in million United States dollars). The option is of American style, meaning exercise is allowed at any time prior to or at maturity.\n\nYour task is to design and implement a recombining binomial lattice method to value this American real option at time $t=0$. The discretization must be constructed from first principles: starting from the GBM dynamics under the risk-neutral measure and imposing the no-arbitrage condition, derive the up and down multipliers and the risk-neutral transition probability by matching the first two moments of the one-step transition to leading order in the time step $\\Delta t$. Then, perform backward induction with discounting to compute the American option value. Early exercise must be handled by comparing continuation value to immediate exercise value at each node. The discounting must use the factor $e^{-r \\Delta t}$ per lattice step.\n\nThe program must also correctly handle the degenerate limit $\\sigma = 0$, in which the stochastic process becomes deterministic under the risk-neutral measure. In this case, the lattice construction degenerates and you must implement a logically consistent valuation that respects the optimal stopping nature of the American option over a discrete set of exercise times. When $T = 0$, the value reduces to the immediate payoff at $t=0$.\n\nAll outputs must be expressed in million United States dollars (million USD) as real-valued floats. Angles are not involved. If any quantity is to be expressed as a percentage, it must be in decimal form; however, this problem uses continuously compounded rates $r$ and $\\delta$ as decimals per year.\n\nImplement a program that, given the following test suite of parameter sets $(X_0, I, r, \\delta, \\sigma, T, N)$, computes the option value at $t=0$ using a recombining binomial lattice with $N$ time steps of size $\\Delta t = T/N$:\n\n- Test Case 1 (general case, happy path): $(X_0, I, r, \\delta, \\sigma, T, N) = (100.0, 90.0, 0.06, 0.02, 0.20, 3.0, 150)$.\n- Test Case 2 (degenerate volatility, $\\sigma = 0$): $(X_0, I, r, \\delta, \\sigma, T, N) = (120.0, 100.0, 0.06, 0.00, 0.00, 2.0, 50)$.\n- Test Case 3 (boundary maturity, $T = 0$): $(X_0, I, r, \\delta, \\sigma, T, N) = (80.0, 100.0, 0.05, 0.02, 0.25, 0.0, 1)$.\n- Test Case 4 (high payout yield, negative risk-neutral drift): $(X_0, I, r, \\delta, \\sigma, T, N) = (150.0, 140.0, 0.05, 0.25, 0.30, 2.0, 100)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite, for example: \"[result1,result2,result3,result4]\". Each result must be a float representing the option value at $t=0$ in million USD.\n\nThe derivation and algorithmic design must begin from core probabilistic and financial principles in continuous time (GBM under the risk-neutral measure and no-arbitrage), and proceed to construct a valid recombining binomial approximation and optimal stopping valuation via backward induction. Do not use shortcut formulas without explanation in your derivation; instead, derive the discrete parameters and the valuation recursion from the stated foundational base.",
            "solution": "The problem requires the valuation of an American-style real option on an energy project. The value of this option will be computed using a recombining binomial lattice model. The problem is well-posed, scientifically grounded in financial engineering principles, and provides all necessary data for a unique solution.\n\nThe solution proceeds in three stages:\n1.  Derivation of the discrete-time binomial lattice parameters ($u$, $d$, $p$) by ensuring consistency with the specified continuous-time Geometric Brownian Motion (GBM) model under the risk-neutral measure.\n2.  Formulation of the backward induction algorithm for valuing the American option, which involves comparing the continuation value with the immediate exercise value at each node of the lattice.\n3.  Specification of the correct logical procedures for the degenerate cases where the volatility $\\sigma=0$ or the time to maturity $T=0$.\n\n**1. Continuous-Time Model and Binomial Discretization**\n\nThe gross project value, $X_t$, is stipulated to follow a Geometric Brownian Motion under the risk-neutral measure $Q$. The stochastic differential equation (SDE) is:\n$$\ndX_t = (r - \\delta) X_t \\, dt + \\sigma X_t \\, dW_t\n$$\nwhere $r$ is the risk-free rate, $\\delta$ is the continuous payout yield, $\\sigma$ is the volatility, and $W_t$ is a standard Wiener process under $Q$.\n\nWe aim to approximate this continuous process with a discrete-time binomial lattice over $N$ time steps of duration $\\Delta t = T/N$. In this lattice, if the project value at a node is $X$, in the next time step $\\Delta t$, it can move up to $X \\cdot u$ or down to $X \\cdot d$, where $u$ and $d$ are the multiplicative up and down factors, respectively. The lattice must be constructed to be recombining, meaning a sequence of an up-move followed by a down-move results in the same value as a down-move followed by an up-move ($ud=du$). This is satisfied if $ud=1$.\n\n**2. Derivation of Lattice Parameters**\n\nThe parameters of the discrete model—the up-factor $u$, the down-factor $d$, and the risk-neutral probability of an up-move $p$—are derived by matching the moments of the discrete process to those of the continuous process to a leading order in $\\Delta t$. The most common and robust approach, proposed by Cox, Ross, and Rubinstein (CRR), is as follows.\n\nFirst, we set the up and down factors to match the volatility of the underlying process. The variance of the log-return over a period $\\Delta t$ in the continuous model is $\\text{Var}[\\ln(X_{t+\\Delta t}/X_t)] = \\sigma^2 \\Delta t$. We enforce this in our one-step binomial model where the log-return is either $\\ln u$ or $\\ln d$. By setting the movements to be symmetric around zero, $\\ln u = -\\ln d$, we choose:\n$$\nu = e^{\\sigma \\sqrt{\\Delta t}} \\quad \\text{and} \\quad d = e^{-\\sigma \\sqrt{\\Delta t}}\n$$\nThis choice ensures $ud=1$, making the lattice recombining. It also matches the variance of the log-return of the process.\n\nSecond, we determine the risk-neutral probability $p$ by matching the expected return. In a risk-neutral world, the expected value of an asset that pays a continuous yield $\\delta$ must grow at the rate $r-\\delta$. Therefore, the discounted asset price $e^{-(r-\\delta)t}X_t$ must be a martingale. This implies $E_t^Q[X_{t+\\Delta t}] = X_t e^{(r-\\delta)\\Delta t}$.\nIn our discrete model, the expected value of $X_{t+\\Delta t}$ is $p(X_t u) + (1-p)(X_t d)$. Equating the two gives:\n$$\np(X_t u) + (1-p)(X_t d) = X_t e^{(r-\\delta)\\Delta t}\n$$\nDividing by $X_t$ and solving for $p$:\n$$\np(u-d) + d = e^{(r-\\delta)\\Delta t}\n$$\n$$\np = \\frac{e^{(r-\\delta)\\Delta t} - d}{u - d}\n$$\nThese choices for $u$, $d$, and $p$ define our recombining binomial lattice that approximates the given GBM.\n\n**3. Valuation Algorithm: Backward Induction**\n\nThe value of the American option is found by backward induction on the lattice.\n\n**Step 3.1: Terminal Condition**\nAt the maturity time $T$ (or step $j=N$), the option will be exercised if and only if the project value $X_{N,i}$ exceeds the investment cost $I$. The value of the option at each of the $N+1$ terminal nodes $(N, i)$ is therefore its intrinsic value:\n$$\nV_{N,i} = \\max(X_{N,i} - I, 0)\n$$\nwhere $i$ is the number of up-moves ($i = 0, 1, \\dots, N$) and $X_{N,i} = X_0 u^i d^{N-i}$.\n\n**Step 3.2: Recursive Step**\nWe then step backward in time from $j=N-1$ down to $j=0$. At any node $(j, i)$, the holder of the American option has two choices: exercise immediately or wait (continue).\n\nThe value of immediate exercise is the intrinsic value at that node:\n$$\nE_{j,i} = \\max(X_{j,i} - I, 0)\n$$\nwhere $X_{j,i} = X_0 u^i d^{j-i}$.\n\nThe value of continuing (holding the option for another period) is the discounted expected value of the option in the next period, under the risk-neutral measure:\n$$\nC_{j,i} = e^{-r \\Delta t} \\left[ p \\cdot V_{j+1, i+1} + (1-p) \\cdot V_{j+1, i} \\right]\n$$\nwhere $V_{j+1, i+1}$ and $V_{j+1, i}$ are the known option values at the subsequent up and down nodes, respectively.\n\nSince the option is American, the holder will choose the action that maximizes value. Thus, the option value at node $(j,i)$ is:\n$$\nV_{j,i} = \\max(C_{j,i}, E_{j,i})\n$$\nThis recursion is repeated until we reach the root of the tree at $j=0$, $i=0$. The value $V_{0,0}$ is the desired option value at time $t=0$.\n\n**4. Handling of Special Cases**\n\nThe general algorithm must be adapted for two specific degenerate cases provided in the test suite.\n\n**Case 1: $T=0$ (Zero Maturity)**\nIf the time to maturity is zero, the option must be exercised immediately or it expires worthless. There is no time value. The value is simply the payoff from immediate exercise at $t=0$:\n$$\nV_0 = \\max(X_0 - I, 0)\n$$\n\n**Case 2: $\\sigma=0$ (Zero Volatility)**\nIf the volatility is zero, the stochastic process degenerates into a deterministic one. The SDE becomes an ordinary differential equation $dX_t = (r - \\delta) X_t dt$, with the solution:\n$$\nX_t = X_0 e^{(r-\\delta)t}\n$$\nThe future path of the project value is known with certainty. The standard binomial parameter formulas fail because $u=d=1$, leading to division by zero for $p$. Instead, the problem reduces to finding the optimal exercise time $t^*$ from the discrete set of possible exercise dates $\\{t_j = j \\Delta t \\mid j=0, 1, \\dots, N\\}$.\nThe value at $t=0$ of exercising at a future time $t_j$ is the discounted payoff:\n$$\n\\text{Value}(t_j) = e^{-r t_j} \\max(X_{t_j} - I, 0) = e^{-r t_j} \\max(X_0 e^{(r-\\delta)t_j} - I, 0)\n$$\nThe optimal strategy is to choose the time $t_j$ that maximizes this value. The option value is therefore:\n$$\nV_0 = \\max_{j \\in \\{0, 1, \\dots, N\\}} \\left\\{ e^{-r (j \\Delta t)} \\max(X_0 e^{(r-\\delta)(j \\Delta t)} - I, 0) \\right\\}\n$$\nThis is a simple optimization problem over $N+1$ discrete choices.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the value of an American real option using a binomial lattice model.\n    \"\"\"\n\n    def compute_option_value(X0, I, r, delta, sigma, T, N):\n        \"\"\"\n        Computes the American real option value for a single set of parameters.\n\n        Args:\n            X0 (float): Initial project value.\n            I (float): Investment cost.\n            r (float): Risk-free rate.\n            delta (float): Continuous payout yield.\n            sigma (float): Volatility.\n            T (float): Time to maturity in years.\n            N (int): Number of time steps in the binomial lattice.\n\n        Returns:\n            float: The value of the American option at time t=0.\n        \"\"\"\n        # Handle the degenerate case where maturity T=0.\n        if T == 0:\n            return max(X0 - I, 0.0)\n\n        # Handle the degenerate case where volatility sigma=0.\n        # The process is deterministic.\n        if sigma == 0:\n            dt = T / N\n            # Create an array of discrete time points for possible exercise.\n            times = np.arange(N + 1) * dt\n            \n            # Calculate project values at each time point.\n            project_values = X0 * np.exp((r - delta) * times)\n            \n            # Calculate intrinsic payoffs at each time point.\n            payoffs = np.maximum(project_values - I, 0.0)\n            \n            # Discount payoffs back to t=0.\n            discount_factors = np.exp(-r * times)\n            discounted_payoffs = payoffs * discount_factors\n            \n            # The option value is the maximum of all possible discounted payoffs.\n            return np.max(discounted_payoffs)\n\n        # Standard binomial lattice model for sigma > 0.\n        dt = T / N\n        \n        # Calculate Cox-Ross-Rubinstein (CRR) parameters.\n        u = np.exp(sigma * np.sqrt(dt))\n        d = 1.0 / u\n        p = (np.exp((r - delta) * dt) - d) / (u - d)\n        \n        discount_factor = np.exp(-r * dt)\n\n        # Initialize a 1D array to store option values at each step.\n        # Start with terminal values at maturity T (step N).\n        # There are N+1 nodes at the final step.\n        # Prices at maturity: S_T = S_0 * u^i * d^(N-i) for i = 0 to N\n        # This can be computed efficiently.\n        prices_at_maturity = X0 * (d ** np.arange(N, -1, -1)) * (u ** np.arange(0, N + 1, 1))\n        V = np.maximum(prices_at_maturity - I, 0.0)\n\n        # Perform backward induction from step N-1 to 0.\n        for j in range(N - 1, -1, -1):\n            # The V array currently holds j+2 values from step j+1.\n            # We compute j+1 values for step j.\n            \n            # Continuation value: discounted expected value of the next step.\n            # V[:-1] corresponds to V_{j+1, i} states, V[1:] to V_{j+1, i+1} states.\n            continuation_values = discount_factor * (p * V[1:j+2] + (1 - p) * V[0:j+1])\n            \n            # Project prices at step j.\n            prices_at_j = X0 * (d ** np.arange(j, -1, -1)) * (u ** np.arange(0, j + 1, 1))\n            \n            # Exercise values at step j.\n            exercise_values = np.maximum(prices_at_j - I, 0.0)\n            \n            # For American option, the value at each node is the max of continuing and exercising.\n            V = np.maximum(continuation_values, exercise_values)\n\n        # The final result is the single value at the root of the tree.\n        return V[0]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (X0, I, r, delta, sigma, T, N)\n        (100.0, 90.0, 0.06, 0.02, 0.20, 3.0, 150),\n        (120.0, 100.0, 0.06, 0.00, 0.00, 2.0, 50),\n        (80.0, 100.0, 0.05, 0.02, 0.25, 0.0, 1),\n        (150.0, 140.0, 0.05, 0.25, 0.30, 2.0, 100),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_option_value(*case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Real options rarely exist in a vacuum; they are part of a larger capital allocation strategy subject to real-world constraints like budgets and indivisible project scales. This final practice problem challenges you to model an investment decision as a two-stage mixed-integer stochastic program. By solving for the optimal mix of immediate investments and options on future capacity, you will learn how to embed real options logic within a formal optimization framework to guide strategic capital budgeting under uncertainty .",
            "id": "4115374",
            "problem": "Consider a two-stage real options investment problem in energy systems, modeled as a mixed-integer stochastic program under risk-neutral valuation. An energy developer decides on first-stage integer investments and reservation of the right to invest later after uncertainty resolves. The setting uses a discrete capacity unit per megawatt (MW), and all cash flows are in present-value terms of millions of currency units per MW. The developer has a first-stage budget constraint. The second-stage decisions are scenario-dependent and follow after uncertain margins are realized.\n\nFundamental base and definitions:\n- Under risk-neutral valuation, the Net Present Value (NPV) of an uncertain cash flow is its discounted expectation with respect to the risk-neutral probability measure. Let the discount factor be $\\beta \\in (0,1)$ and the set of scenarios be $\\mathcal{S}$ with probabilities $\\{p_s\\}_{s \\in \\mathcal{S}}$ satisfying $\\sum_{s \\in \\mathcal{S}} p_s = 1$ and $p_s \\ge 0$ for all $s \\in \\mathcal{S}$.\n- Let $m_0$ denote the first-stage net operational margin per MW, and let $m_{1,s}$ denote the second-stage net operational margin per MW in scenario $s \\in \\mathcal{S}$. Margins are understood as revenues net of variable operating costs, and are nonnegative.\n- Let $c_0$ denote the first-stage capital expenditure per MW for immediate build, $c_1$ denote the second-stage capital expenditure per MW for deferred build, and $r$ denote the first-stage reservation cost per MW that grants the option to build in the second stage.\n- Let $B_0$ denote the first-stage budget.\n- Let $x_0 \\in \\{0,1,2,\\dots,X_{\\max}\\}$ be the integer number of MW built immediately in the first stage. Let $k \\in \\{0,1,2,\\dots,K_{\\max}\\}$ be the integer number of MW of reservation procured in the first stage. Let $y_s \\in \\{0,1,2,\\dots,k\\}$ be the integer number of MW exercised (built) in the second stage in scenario $s$. The decisions $x_0$ and $k$ are first-stage and must satisfy nonanticipativity (that is, they cannot depend on scenario realizations), while the recourse decisions $\\{y_s\\}$ are second-stage and can depend on the realized scenario $s$.\n- The first-stage budget constraint is $c_0 x_0 + r k \\le B_0$.\n- The cash flow components are defined as follows:\n  - First stage cash flow: $m_0 x_0 - c_0 x_0 - r k$.\n  - Second stage cash flow in scenario $s$: $m_{1,s}(x_0 + y_s) - c_1 y_s$, discounted by $\\beta$ and weighted by $p_s$ in risk-neutral expectation.\n\nObjective and decision logic:\n- The developer aims to maximize expected discounted NPV over the integer decision space, subject to the above budget and integrality constraints.\n- In the second stage, for each scenario $s$, the recourse decision $y_s$ must be chosen to maximize the scenario contribution given the realized $m_{1,s}$ and the reservation limit $k$. Due to the linearity of scenario cash flows in $y_s$ and the integrality constraint, the optimal $y_s$ either equals $0$ or $k$ (or any integer between them in knife-edge cases where the per-MW net value equals zero), consistent with the bounds $0 \\le y_s \\le k$.\n\nTie-breaking rule:\n- If multiple distinct tuples $(x_0,k,\\{y_s\\}_{s \\in \\mathcal{S}})$ achieve the same optimal expected discounted NPV up to a numerical tolerance of $10^{-12}$, select the lexicographically smallest tuple in the ordering $(x_0,k,y_{s_1},y_{s_2},\\dots)$ for a fixed scenario ordering.\n\nUnits and output:\n- All monetary quantities must be expressed in millions of currency units. The output expected discounted NPV must be reported in millions of currency units, rounded to six decimal places.\n\nProgramming task:\n- Implement a solver that enumerates all feasible first-stage integer decisions $(x_0,k)$ under the budget constraint and, for each scenario $s$, enumerates feasible integer second-stage recourse decisions $y_s \\in \\{0,1,\\dots,k\\}$, selecting those that maximize expected discounted NPV. Use the risk-neutral expectation with discount factor $\\beta$.\n\nTest suite:\n- Use a two-scenario set $\\mathcal{S} = \\{H,L\\}$ with probabilities $(p_H,p_L)$ in each test case. For each test case, compute and return the optimal decisions $(x_0,k,y_H,y_L)$ and the corresponding optimal expected discounted NPV. The four test cases are:\n\n  1. Happy-path moderate profitability and reservation:\n     - $X_{\\max} = 3$, $K_{\\max} = 3$, $B_0 = 1.2$, $\\beta = 0.95$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.6$, $m_{1,H} = 1.2$, $m_{1,L} = 0.2$, $c_0 = 1.0$, $c_1 = 1.0$, $r = 0.1$.\n  2. Edge case where waiting is intrinsically unprofitable to exercise (second-stage margins below second-stage capex):\n     - $X_{\\max} = 1$, $K_{\\max} = 3$, $B_0 = 0.9$, $\\beta = 0.92$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.8$, $m_{1,H} = 0.7$, $m_{1,L} = 0.5$, $c_0 = 0.9$, $c_1 = 0.9$, $r = 0.05$.\n  3. Boundary case with exact budget fit and asymmetric future margins:\n     - $X_{\\max} = 1$, $K_{\\max} = 3$, $B_0 = 0.3$, $\\beta = 0.9$, $p_H = 0.5$, $p_L = 0.5$, $m_0 = 0.5$, $m_{1,H} = 1.1$, $m_{1,L} = 0.0$, $c_0 = 0.3$, $c_1 = 0.8$, $r = 0.1$.\n  4. Case with low discount factor reducing future value and skewed probabilities:\n     - $X_{\\max} = 2$, $K_{\\max} = 2$, $B_0 = 1.35$, $\\beta = 0.6$, $p_H = 0.6$, $p_L = 0.4$, $m_0 = 0.7$, $m_{1,H} = 2.0$, $m_{1,L} = 0.1$, $c_0 = 1.0$, $c_1 = 1.2$, $r = 0.15$.\n\nFinal output format specification:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[result_1,result_2,\\dots]$). Each $result_i$ must be a list of the form $[x_0,k,y_H,y_L,\\text{EV}]$ with no spaces, where $\\text{EV}$ is the optimal expected discounted NPV in millions of currency units, rounded to six decimal places. The scenario ordering must be $(H,L)$ for $(y_H,y_L)$ in all test cases.",
            "solution": "The problem is a well-defined two-stage mixed-integer stochastic program for a real options investment decision in an energy system. The formulation is grounded in the standard principles of risk-neutral valuation and dynamic programming. All parameters, constraints, and decision variables are clearly and unambiguously defined, and the provided data for the test cases are self-contained and consistent. There are no scientific or mathematical flaws, and the objective is to maximize a clearly specified Net Present Value (NPV) over a finite a set of discrete choices, which guarantees that a solution exists. The tie-breaking rule ensures the uniqueness of the solution. Therefore, the problem is valid and a solution can be derived.\n\nThe problem is to find the optimal integer first-stage decisions for immediate investment, $x_0$, and capacity reservation, $k$, and the optimal integer second-stage recourse decisions for exercising the reserved options, $y_s$, for each scenario $s \\in \\mathcal{S}$. The objective is to maximize the expected discounted Net Present Value (NPV).\n\nLet the decision variables be:\n- $x_0 \\in \\{0, 1, \\dots, X_{\\max}\\}$: integer capacity built in the first stage.\n- $k \\in \\{0, 1, \\dots, K_{\\max}\\}$: integer capacity reserved in the first stage for potential future construction.\n- $y_s \\in \\{0, 1, \\dots, k\\}$: integer capacity built in the second stage under scenario $s$.\n\nThe total expected discounted NPV is the sum of the first-stage cash flow and the discounted expected value of the second-stage cash flows across all scenarios $s \\in \\mathcal{S}$. The mathematical formulation of the objective function is:\n$$ \\text{NPV}(x_0, k, \\{y_s\\}) = \\underbrace{(m_0 - c_0)x_0 - rk}_{\\text{First-stage cash flow}} + \\underbrace{\\beta \\sum_{s \\in \\mathcal{S}} p_s \\left( m_{1,s}(x_0 + y_s) - c_1 y_s \\right)}_{\\text{Discounted expected second-stage cash flow}} $$\nwhere $\\beta$ is the discount factor and $p_s$ is the risk-neutral probability of scenario $s$. The first-stage decisions must satisfy the budget constraint:\n$$ c_0 x_0 + r k \\le B_0 $$\nThis problem has a two-stage structure that lends itself to a solution via dynamic programming, or in this case, a structured enumeration, given the small, discrete decision space. The solution approach is as follows:\n\n1.  **First-Stage Enumeration**: We iterate through all possible combinations of first-stage integer decisions $(x_0, k)$ within their respective bounds ($x_0 \\le X_{\\max}$, $k \\le K_{\\max}$). For each pair, we check feasibility against the first-stage budget constraint, $c_0 x_0 + r k \\le B_0$.\n\n2.  **Second-Stage Optimization**: For each feasible first-stage pair $(x_0, k)$, we determine the optimal second-stage recourse decisions $\\{y_s\\}_{s \\in \\mathcal{S}}$. The decision for each scenario $s$ is independent of other scenarios and aims to maximize its contribution to the total NPV. The part of the NPV objective function that depends on $y_s$ is:\n    $$ \\beta p_s \\left( m_{1,s}(x_0 + y_s) - c_1 y_s \\right) $$\n    Since $x_0$ is fixed at this stage, and $\\beta p_s > 0$, maximizing this term is equivalent to maximizing the per-unit net margin from exercising the option, $(m_{1,s} - c_1)y_s$, subject to the constraint $0 \\le y_s \\le k$.\n    Due to the linearity in $y_s$, the optimal decision, $y_s^*$, is at the boundary of the feasible set $\\{0, 1, \\dots, k\\}$:\n    - If the net margin of exercising is positive, i.e., $m_{1,s} - c_1 > 0$, it is optimal to exercise all reserved options: $y_s^* = k$.\n    - If the net margin is non-positive, i.e., $m_{1,s} - c_1 \\le 0$, it is optimal not to exercise any options: $y_s^* = 0$.\n\n3.  **NPV Calculation and Selection**: For each feasible pair $(x_0, k)$ and its corresponding optimal recourse decisions $\\{y_s^*\\}$, we calculate the total expected discounted NPV using the full objective function. We maintain a record of the highest NPV found so far and the decision tuple $(x_0, k, \\{y_s^*\\})$ that produced it. If a new decision tuple yields an NPV greater than the current maximum (within a numerical tolerance of $10^{-12}$), it becomes the new optimum. If a tuple yields an NPV that is numerically equal to the current maximum, the tie-breaking rule is invoked: the tuple that is lexicographically smaller is chosen. The specified scenario ordering is $(H,L)$, so the tuple for comparison is $(x_0, k, y_H, y_L)$.\n\nThis enumeration over the finite, discrete decision space guarantees finding the globally optimal investment strategy. The implementation will proceed by systematically exploring all valid first-stage choices and applying the optimal second-stage policy for each.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves a two-stage real options investment problem for a given set of test cases.\n    The method enumerates all feasible first-stage decisions and determines the optimal\n    second-stage recourse decisions to maximize the expected discounted NPV.\n    \"\"\"\n    \n    test_cases = [\n        # Case 1: Happy-path moderate profitability and reservation\n        {\"X_max\": 3, \"K_max\": 3, \"B0\": 1.2, \"beta\": 0.95, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.6, \"m1_H\": 1.2, \"m1_L\": 0.2, \"c0\": 1.0, \"c1\": 1.0, \"r\": 0.1},\n        # Case 2: Edge case where waiting is intrinsically unprofitable\n        {\"X_max\": 1, \"K_max\": 3, \"B0\": 0.9, \"beta\": 0.92, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.8, \"m1_H\": 0.7, \"m1_L\": 0.5, \"c0\": 0.9, \"c1\": 0.9, \"r\": 0.05},\n        # Case 3: Boundary case with exact budget fit\n        {\"X_max\": 1, \"K_max\": 3, \"B0\": 0.3, \"beta\": 0.9, \"p_H\": 0.5, \"p_L\": 0.5,\n         \"m0\": 0.5, \"m1_H\": 1.1, \"m1_L\": 0.0, \"c0\": 0.3, \"c1\": 0.8, \"r\": 0.1},\n        # Case 4: Low discount factor and skewed probabilities\n        {\"X_max\": 2, \"K_max\": 2, \"B0\": 1.35, \"beta\": 0.6, \"p_H\": 0.6, \"p_L\": 0.4,\n         \"m0\": 0.7, \"m1_H\": 2.0, \"m1_L\": 0.1, \"c0\": 1.0, \"c1\": 1.2, \"r\": 0.15},\n    ]\n\n    results = []\n    \n    for params in test_cases:\n        X_max, K_max = params[\"X_max\"], params[\"K_max\"]\n        B0, beta = params[\"B0\"], params[\"beta\"]\n        p_H, p_L = params[\"p_H\"], params[\"p_L\"]\n        m0, m1_H, m1_L = params[\"m0\"], params[\"m1_H\"], params[\"m1_L\"]\n        c0, c1, r = params[\"c0\"], params[\"c1\"], params[\"r\"]\n        \n        best_npv = -np.inf\n        # Initialize with a lexicographically large tuple\n        best_decision = (X_max + 1, K_max + 1, K_max + 1, K_max + 1)\n        \n        # Enumerate all first-stage decisions (x0, k)\n        for x0 in range(X_max + 1):\n            for k in range(K_max + 1):\n                # Check budget constraint\n                if c0 * x0 + r * k > B0:\n                    continue\n                \n                # Determine optimal second-stage decisions (y_H, y_L)\n                # Optimal y_s is k if m1_s > c1, and 0 otherwise.\n                y_H = k if m1_H - c1 > 0 else 0\n                y_L = k if m1_L - c1 > 0 else 0\n                \n                # Calculate total expected NPV for the current decision tuple\n                # First-stage cash flow\n                first_stage_cf = (m0 - c0) * x0 - r * k\n                \n                # Second-stage cash flow for scenario H\n                second_stage_cf_H = m1_H * (x0 + y_H) - c1 * y_H\n                \n                # Second-stage cash flow for scenario L\n                second_stage_cf_L = m1_L * (x0 + y_L) - c1 * y_L\n                \n                # Total expected NPV\n                current_npv = first_stage_cf + beta * (p_H * second_stage_cf_H + p_L * second_stage_cf_L)\n\n                current_decision = (x0, k, y_H, y_L)\n\n                # Update best decision based on NPV and tie-breaking rule\n                # Numerical tolerance for float comparison\n                TOLERANCE = 1e-12\n                if current_npv > best_npv + TOLERANCE:\n                    best_npv = current_npv\n                    best_decision = current_decision\n                elif abs(current_npv - best_npv) <= TOLERANCE:\n                    # Tie-breaking: choose lexicographically smallest tuple\n                    if current_decision < best_decision:\n                        best_npv = current_npv\n                        best_decision = current_decision\n\n        result_list = list(best_decision) + [f\"{best_npv:.6f}\"]\n        results.append(str(result_list).replace(\" \", \"\").replace(\"'\", \"\"))\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}