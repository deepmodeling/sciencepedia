{
    "hands_on_practices": [
        {
            "introduction": "设置电力系统备用容量是一个经典的权衡问题：过多的备用容量会增加成本，而备用不足则可能导致代价高昂的电力短缺。本练习将引导您完成一个核心步骤：将条件风险价值（$CVaR$）最小化的目标转化为一个易于求解的线性规划问题，这是风险规避优化中的一项基本技能。通过求解一个具体的数值算例，您将亲身体验如何应用此方法来确定最优的备用水平。",
            "id": "4077181",
            "problem": "一家独立系统运营商必须决定一个单一的日前快速启动备用容量 $x \\ge 0$（单位：兆瓦），以对冲具有可变可再生能源发电的电力系统中的不确定性净需求。设确定性需求为 $D$，可再生能源发电为随机变量 $R(\\xi)$，其中 $\\xi$ 表示场景。运营商为每单位 $x$ 承担容量成本系数 $c_x$，为每单位未满足的需求承担短缺惩罚系数 $c_p$。在决策 $x$ 和场景 $\\xi$ 下的实现损失为\n$$\nL(x,\\xi) \\;=\\; c_x\\,x \\;+\\; c_p\\,\\max\\bigl(0,\\,D - R(\\xi) - x\\bigr).\n$$\n运营商寻求一种风险规避决策，以最小化随机损失 $L(x,\\xi)$ 在置信水平 $\\alpha \\in (0,1)$ 下的条件风险价值（CVaR）。\n\n从风险价值（VaR）作为损失分布的 $\\alpha$-分位数和条件风险价值（CVaR）作为超出VaR的尾部期望的核心定义出发，使用 $N$ 个等概率的 $R(\\xi)$ 的独立同分布场景 $\\{\\xi^{(i)}\\}_{i=1}^{N}$，推导一个基于样本的凸优化重构模型，用于最小化关于 $x$ 的CVaR，并证明该重构模型可以简化为使用适当决策变量和辅助变量的线性规划。\n\n然后求解以下小型实例。考虑 $N=4$ 个等可能场景，需求 $D=100$，可再生能源发电实现值为 $R(\\xi^{(1)})=70$、$R(\\xi^{(2)})=80$、$R(\\xi^{(3)})=90$ 和 $R(\\xi^{(4)})=95$。设 $c_x=2$ 和 $c_p=20$。使用置信水平 $\\alpha=0.75$。确定最优备用容量 $x^{\\star}$，以最小化该实例中 $L(x,\\xi)$ 的基于样本的CVaR。最终答案 $x^{\\star}$ 以兆瓦（MW）表示。无需四舍五入。",
            "solution": "用户要求我解决一个能源系统中的风险规避优化问题。\n\n### 第1步：提取已知信息\n-   决策者角色：独立系统运营商。\n-   决策变量：日前快速启动备用容量，$x \\ge 0$ (MW)。\n-   确定性需求：$D$。\n-   随机可再生能源发电：$R(\\xi)$，其中 $\\xi$ 是场景。\n-   容量成本系数：$c_x$。\n-   短缺惩罚系数：$c_p$。\n-   在决策 $x$ 和场景 $\\xi$ 下的损失函数：$L(x,\\xi) = c_x x + c_p \\max(0, D - R(\\xi) - x)$。\n-   优化目标：最小化随机损失 $L(x,\\xi)$ 在置信水平 $\\alpha \\in (0,1)$ 下的条件风险价值（CVaR）。\n-   任务1：使用 $N$ 个等概率的 $R(\\xi)$ 的独立同分布场景 $\\{\\xi^{(i)}\\}_{i=1}^{N}$，推导一个基于样本的凸优化重构模型，用于最小化关于 $x$ 的CVaR，并证明该重构模型可以简化为一个线性规划。\n-   任务2：求解具有以下数据的具体实例：\n    -   场景数量：$N=4$。\n    -   需求：$D=100$。\n    -   可再生能源发电实现值：$R(\\xi^{(1)})=70$，$R(\\xi^{(2)})=80$，$R(\\xi^{(3)})=90$，$R(\\xi^{(4)})=95$。\n    -   容量成本系数：$c_x=2$。\n    -   短缺惩罚系数：$c_p=20$。\n    -   置信水平：$\\alpha=0.75$。\n-   最终答案要求：最优备用容量 $x^{\\star}$，单位为兆瓦（MW）。\n\n### 第2步：使用提取的已知信息进行验证\n该问题具有科学依据、适定且客观。\n-   **科学依据**：该问题是随机优化和风险规避决策（特别是使用CVaR）在电力系统运行（机组组合和备用分配）这一常见问题中的标准应用。损失函数的构建是平衡容量成本和短缺成本的成熟模型。\n-   **适定性**：问题定义明确。目标函数CVaR是一致且凸的，决策空间 $x \\ge 0$ 是一个凸集。损失函数 $L(x, \\xi)$ 对 $x$ 是凸的。由于CVaR保持凸性，最小化 $CVaR_{\\alpha}(L(x, \\xi))$ 的整个问题是一个凸优化问题，这保证了全局最小值的存在（如果目标函数是严格凸的，则全局最小值唯一，但这不是必需的）。\n-   **客观性**：问题陈述精确，使用了标准的数学和经济术语。所有参数和目标都得到了清晰明确的定义。\n\n该问题没有表现出任何无效性缺陷。它是一个完整、一致且可形式化的问题，根植于成熟的运筹学和能源经济学原理。\n\n### 第3步：结论与行动\n该问题有效。我将继续提供完整的解决方案。\n\n按题目要求，解答分为两部分。\n\n**第1部分：线性规划重构模型的推导**\n\n令 $Z(x, \\xi) = L(x, \\xi)$ 为给定决策 $x$ 下的随机损失。在置信水平 $\\alpha \\in (0,1)$ 下的风险价值（$VaR$）是损失分布的 $\\alpha$-分位数：\n$$\nVaR_{\\alpha}(Z) = \\inf\\{z \\in \\mathbb{R} \\mid P(Z \\le z) \\ge \\alpha\\}.\n$$\n条件风险价值（$CVaR$）是分布的 $(1-\\alpha)$-尾部中的期望损失，即损失超过 $VaR$ 时的期望损失：\n$$\nCVaR_{\\alpha}(Z) = E[Z \\mid Z > VaR_{\\alpha}(Z)].\n$$\nRockafellar和Uryasev（2000）的一个关键结果提供了一种易于处理的优化 $CVaR$ 的方法。随机变量 $Z$ 的 $CVaR$ 可以通过求解一个带辅助变量 $v \\in \\mathbb{R}$ 的优化问题来找到：\n$$\nCVaR_{\\alpha}(Z) = \\min_{v \\in \\mathbb{R}} \\left( v + \\frac{1}{1-\\alpha} E[\\max(0, Z - v)] \\right).\n$$\n在此公式中，$v$ 的最优值是 $VaR_{\\alpha}(Z)$。\n\n我们的目标是关于备用容量 $x \\ge 0$ 来最小化损失 $L(x, \\xi)$ 的 $CVaR$。这可以写成关于 $x$ 和辅助变量 $v$ 的联合最小化问题：\n$$\n\\min_{x \\ge 0} CVaR_{\\alpha}(L(x, \\xi)) = \\min_{x \\ge 0, v \\in \\mathbb{R}} \\left( v + \\frac{1}{1-\\alpha} E[\\max(0, L(x, \\xi) - v)] \\right).\n$$\n给定 $N$ 个等概率 $1/N$ 的独立同分布场景 $\\{\\xi^{(i)}\\}_{i=1}^{N}$。我们可以使用样本均值近似（SAA）方法，用样本均值替代期望算子 $E[\\cdot]$：\n$$\nE[f(\\xi)] \\approx \\frac{1}{N} \\sum_{i=1}^{N} f(\\xi^{(i)}).\n$$\n将此应用于我们的目标函数，并令 $R_i = R(\\xi^{(i)})$，问题变为：\n$$\n\\min_{x \\ge 0, v \\in \\mathbb{R}} \\left( v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^{N} \\max\\left(0, L(x, \\xi^{(i)}) - v\\right) \\right).\n$$\n代入损失函数表达式 $L(x, \\xi^{(i)}) = c_x x + c_p \\max(0, D - R_i - x)$：\n$$\n\\min_{x \\ge 0, v \\in \\mathbb{R}} \\left( v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^{N} \\max\\left(0, c_x x + c_p \\max(0, D - R_i - x) - v\\right) \\right).\n$$\n由于两个嵌套的 $\\max$ 函数，该目标函数是凸的但非线性。我们可以通过引入辅助变量将其重构为线性规划（LP）。\n\n首先，为每个场景 $i=1, \\dots, N$ 引入一个辅助变量 $u_i$ 来表示 $\\max(0, \\dots)$ 项：\n$$\nu_i \\ge c_x x + c_p \\max(0, D - R_i - x) - v, \\quad u_i \\ge 0.\n$$\n问题变为：\n$$\n\\min_{x, v, u_1, \\dots, u_N} \\left( v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^{N} u_i \\right)\n$$\n受制于关于 $u_i$ 的约束。这些约束仍然包含一个 $\\max$ 函数。我们可以通过引入另一组辅助变量 $s_i$ 来表示每个场景中的短缺项，从而将其线性化：\n$$\ns_i \\ge D - R_i - x, \\quad s_i \\ge 0.\n$$\n这等价于 $s_i = \\max(0, D - R_i - x)$。\n\n将 $s_i$ 代入 $u_i$ 的约束中，我们得到一组完全线性的约束。最终的LP重构模型是：\n$$\n\\begin{array}{cll}\n\\min  v + \\frac{1}{N(1-\\alpha)} \\sum_{i=1}^{N} u_i  \\\\\n\\text{s.t.}  u_i \\ge c_x x + c_p s_i - v,  \\forall i=1, \\dots, N \\\\\n s_i \\ge D - R_i - x,  \\forall i=1, \\dots, N \\\\\n x \\ge 0  \\\\\n v \\in \\mathbb{R}  \\\\\n u_i \\ge 0,  \\forall i=1, \\dots, N \\\\\n s_i \\ge 0,  \\forall i=1, \\dots, N\n\\end{array}\n$$\n这是一个以决策变量 $x$、$v$ 以及辅助变量 $\\{u_i\\}_{i=1}^N$ 和 $\\{s_i\\}_{i=1}^N$ 构成的线性规划。这完成了任务的第一部分。\n\n**第2部分：具体实例的求解**\n\n我们有以下数据：\n-   $N=4$ 个场景。\n-   $D=100$ MW。\n-   可再生能源实现值：$R_1=70$ MW, $R_2=80$ MW, $R_3=90$ MW, $R_4=95$ MW。\n-   成本：$c_x=2$ 每MW, $c_p=20$ 每MW。\n-   置信水平：$\\alpha=0.75$。\n\n首先，计算每个场景的净需求 $d_i = D - R_i$：\n$$\nd_1 = 100 - 70 = 30 \\text{ MW} \\\\\nd_2 = 100 - 80 = 20 \\text{ MW} \\\\\nd_3 = 100 - 90 = 10 \\text{ MW} \\\\\nd_4 = 100 - 95 = 5 \\text{ MW}\n$$\n每个场景 $i$ 的损失函数是 $L_i(x) = c_x x + c_p \\max(0, d_i - x)$。\n$$\nL_1(x) = 2x + 20 \\max(0, 30 - x) \\\\\nL_2(x) = 2x + 20 \\max(0, 20 - x) \\\\\nL_3(x) = 2x + 20 \\max(0, 10 - x) \\\\\nL_4(x) = 2x + 20 \\max(0, 5 - x)\n$$\n由于 $d_1 > d_2 > d_3 > d_4$，可以证明对于任何给定的 $x \\ge 0$，损失的排序为 $L_1(x) \\ge L_2(x) \\ge L_3(x) \\ge L_4(x)$。\n\n我们要最小化损失的基于样本的 $CVaR_{0.75}$。分布尾部的场景数量为 $q = N(1-\\alpha) = 4(1-0.75) = 4(0.25) = 1$。当 $N(1-\\alpha)$ 是整数时，样本 $CVaR$ 是 $N(1-\\alpha)$ 个最大损失的平均值。在本例中，$q=1$，样本 $CVaR_{0.75}$ 就是单个最大的损失。\n由于损失的排序，最大的损失总是 $L_1(x)$。\n因此，最小化 $CVaR_{0.75}(L(x, \\xi))$ 的问题简化为最小化最大损失，即 $L_1(x)$：\n$$\n\\min_{x \\ge 0} L_1(x) = \\min_{x \\ge 0} \\left( 2x + 20 \\max(0, 30-x) \\right).\n$$\n这是一个凸优化问题，可以通过分析目标函数 $f(x) = 2x + 20 \\max(0, 30-x)$ 来求解。\n\n我们考虑 $x \\ge 0$ 的两种情况：\n1.  情况1：$0 \\le x \\le 30$。\n    在此区间，$\\max(0, 30-x) = 30-x$。目标函数变为：\n    $$\n    f(x) = 2x + 20(30-x) = 2x + 600 - 20x = 600 - 18x.\n    $$\n    此函数对 $x$ 线性递减。其在区间 $[0, 30]$ 上的最小值在 $x=30$ 处取得，此时 $f(30) = 600 - 18(30) = 600 - 540 = 60$。\n\n2.  情况2：$x > 30$。\n    在此区间，$\\max(0, 30-x) = 0$。目标函数变为：\n    $$\n    f(x) = 2x.\n    $$\n    此函数对 $x$ 线性递增。其在区间 $(30, \\infty)$ 上的最小值在 $x$ 从右侧趋近于 $30$ 时达到。在 $x=30$ 处的值为 $f(30) = 2(30)=60$。\n\n综合两种情况，函数 $f(x)$ 在 $x \\in [0, 30)$ 上递减，在 $x \\in (30, \\infty)$ 上递增。因此，全局最小值在点 $x=30$ 处达到。\n最优备用容量为 $x^{\\star} = 30$ MW。\n\n为了确认这一点，我们检查 $f(x)$ 在 $x=30$ 处的次梯度。\n$f(x)$ 在 $x$ 处的次梯度为 $\\partial f(x) = 2 + 20 \\cdot \\partial_x(\\max(0, 30-x))$。\n$\\max(0, 30-x)$ 在 $x=30$ 处的次梯度是区间 $[-1, 0]$。\n因此，$f(x)$ 在 $x=30$ 处的次梯度是：\n$$\n\\partial f(30) = 2 + 20 \\cdot [-1, 0] = 2 + [-20, 0] = [-18, 2].\n$$\n由于 $0 \\in [-18, 2]$，点 $x=30$ 确实是 $f(x)$ 的最小值点。\n\n最优备用容量为30兆瓦。",
            "answer": "$$\n\\boxed{30}\n$$"
        },
        {
            "introduction": "理解了如何优化 $CVaR$ 之后，下一个关键问题是它为什么重要，以及它如何改变我们的决策。本练习通过一个发电机组组合问题，让您直接比较最小化期望成本（风险中性方法）与最小化 $CVaR$（风险规避方法）所得到的最优策略。您将发现，不同的风险偏好如何导致在面对不确定性时，做出截然不同的运行决策，从而深刻理解风险规避的实际价值。",
            "id": "4077132",
            "problem": "考虑一个电力系统的单周期发电机组启停与调度问题，该系统包含两台火力发电机组和不确定性需求。设两台发电机组的索引为 $i \\in \\{1,2\\}$。对于每台发电机组 $i$，决策变量 $x_i \\in \\{0,1\\}$ 表示该发电机组是否投入（开启）或不投入（关闭）。如果投入运行，发电机组 $i$ 在此单周期内可产生输出 $g_i \\ge 0$，最高可达其铭牌容量 $P_i$（单位为 $\\mathrm{MWh}$）。不确定性净需求 $D$ 被建模为一个离散随机变量，其支撑集为 $\\{d_k\\}_{k=1}^K$，对应概率为 $\\{\\pi_k\\}_{k=1}^K$，满足 $\\sum_{k=1}^K \\pi_k = 1$。其中，每个 $d_k$ 以 $\\mathrm{MWh}$ 为单位表示，每个 $\\pi_k$ 为一个小数。\n\n假设生产成本为线性可变成本，启停成本为固定成本：发电机组 $i$ 的可变成本为 $c_i$（单位为 $\\$ / \\mathrm{MWh}$），固定成本为 $f_i$（单位为 $\\$/\\mathrm{h}$），当 $x_i=1$ 时产生固定成本。在任一情景中，任何未满足的需求 $L \\ge 0$ 会产生惩罚成本 $\\lambda$（单位为 $\\$ / \\mathrm{MWh}$），代表失负荷价值。对于每个情景 $k$，调度问题通过求解一个确定性线性规划来最小化该情景下的成本，并满足供需平衡和容量限制：\n$$\n\\min_{g_1,g_2,L} \\quad c_1 g_1 + c_2 g_2 + \\lambda L \\\\\n\\text{subject to} \\\\\ng_1 + g_2 + L = d_k, \\\\\n0 \\le g_i \\le x_i P_i \\quad \\text{for } i \\in \\{1,2\\}, \\\\\nL \\ge 0.\n$$\n该情景的总成本等于上述调度目标的最优值加上固定启停成本 $f_1 x_1 + f_2 x_2$。\n\n将期望成本目标定义为总情景成本的期望值：\n$$\n\\mathbb{E}[\\text{cost}] = \\sum_{k=1}^K \\pi_k \\, \\text{cost}(x_1,x_2; d_k).\n$$\n将随机总成本 $X$ 在置信水平 $\\beta \\in (0,1)$ 下的条件风险价值（CVaR）定义为风险度量\n$$\n\\operatorname{CVaR}_\\beta(X) = \\min_{z \\in \\mathbb{R}} \\left\\{ z + \\frac{1}{1-\\beta} \\, \\mathbb{E}\\left[(X - z)_+\\right] \\right\\},\n$$\n其中 $(\\cdot)_+ = \\max\\{ \\cdot , 0\\}$，期望是关于情景概率 $\\{\\pi_k\\}_{k=1}^K$ 计算的。\n\n您的任务是实现一个程序，对每个指定的测试用例执行以下步骤：\n- 枚举所有的启停组合 $(x_1,x_2) \\in \\{0,1\\}^2$。\n- 对于每种启停组合和每个需求情景 $k$，计算使情景成本最小化的最优调度 $(g_1,g_2,L)$，并满足上述线性约束。根据基本的线性规划原理，在线性成本和容量约束下，此单周期设置中的最优调度会优先分配发电给可变成本较低的机组，直至其容量上限，然后再分配给可变成本较高的机组；只有当总投入容量不足以满足情景需求时，才会发生切负荷。调度量应以 $\\mathrm{MWh}$ 计算，产生的情景成本以 $\\$$ 计算。\n- 计算总情景成本（包括固定启停成本），并基于此计算每种启停组合的期望成本（单位为 $\\$$）和在水平 $\\beta$ 下的条件风险价值（单位为 $\\$$）。\n- 确定期望成本最优的启停组合（$\\mathbb{E}[\\text{cost}]$ 的最小化者）和条件风险价值最优的启停组合（$\\operatorname{CVaR}_\\beta$ 的最小化者）。如果出现平局，则按 $(x_1,x_2)$ 的字典序进行决断。\n- 计算在期望成本最优启停组合下发生切负荷（即 $L > 0$）的概率，该概率等于 $\\sum_{k: d_k > x_1 P_1 + x_2 P_2} \\pi_k$。此概率必须表示为小数。\n\n所有计算出的成本以美元（$\\$$）表示，所有能量以兆瓦时（$\\mathrm{MWh}$）表示。概率以小数形式报告。对于每个测试用例，最终的程序输出必须呈现一个包含以下八个条目的列表：\n1. 期望成本最优启停组合的 $x_1$（整数 $0$ 或 $1$），\n2. 期望成本最优启停组合的 $x_2$（整数 $0$ 或 $1$），\n3. 该启停组合的期望成本（浮点数，单位为 $\\$$），\n4. 条件风险价值最优启停组合的 $x_1$（整数 $0$ 或 $1$），\n5. 条件风险价值最优启停组合的 $x_2$（整数 $0$ 或 $1$），\n6. 该启停组合的 $\\operatorname{CVaR}_\\beta$ 值（浮点数，单位为 $\\$$），\n7. 一个整数指示符，如果两个最优启停组合不同则为 $1$，否则为 $0$，\n8. 期望成本最优启停组合下发生切负荷的概率（浮点数，小数形式）。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，其中每个元素是按顺序排列的一个测试用例的上述列表。例如，输出格式必须类似于 $[\\text{case1},\\text{case2},\\text{case3}]$，不含多余的空格或字符。\n\n使用以下三个测试用例，它们旨在涵盖正常情况、边界情况和对惩罚敏感的边缘情况：\n- 测试用例 $1$（重尾分布且调峰机组昂贵）：\n  - 发电机 $1$：$P_1 = 50 \\ \\mathrm{MWh}$，$c_1 = 20 \\ \\$/\\mathrm{MWh}$，$f_1 = 500 \\ \\$/\\mathrm{h}$。\n  - 发电机 $2$：$P_2 = 70 \\ \\mathrm{MWh}$，$c_2 = 50 \\ \\$/\\mathrm{MWh}$，$f_2 = 9000 \\ \\$/\\mathrm{h}$。\n  - 需求情景：$\\{d_k\\} = [40, 60, 110] \\ \\mathrm{MWh}$，对应概率 $\\{\\pi_k\\} = [0.7, 0.2, 0.1]$。\n  - 惩罚：$\\lambda = 1000 \\ \\$/\\mathrm{MWh}$。\n  - 置信水平：$\\beta = 0.9$。\n- 测试用例 $2$（需求相同，发电机2的固定成本适中）：\n  - 发电机 $1$：$P_1 = 50 \\ \\mathrm{MWh}$，$c_1 = 20 \\ \\$/\\mathrm{MWh}$，$f_1 = 500 \\ \\$/\\mathrm{h}$。\n  - 发电机 $2$：$P_2 = 70 \\ \\mathrm{MWh}$，$c_2 = 50 \\ \\$/\\mathrm{MWh}$，$f_2 = 2000 \\ \\$/\\mathrm{h}$。\n  - 需求情景：$\\{d_k\\} = [40, 60, 110] \\ \\mathrm{MWh}$，对应概率 $\\{\\pi_k\\} = [0.7, 0.2, 0.1]$。\n  - 惩罚：$\\lambda = 1000 \\ \\$/\\mathrm{MWh}$。\n  - 置信水平：$\\beta = 0.9$。\n- 测试用例 $3$（发电机与测试用例1相同，但失负荷价值较低）：\n  - 发电机 $1$：$P_1 = 50 \\ \\mathrm{MWh}$，$c_1 = 20 \\ \\$/\\mathrm{MWh}$，$f_1 = 500 \\ \\$/\\mathrm{h}$。\n  - 发电机 $2$：$P_2 = 70 \\ \\mathrm{MWh}$，$c_2 = 50 \\ \\$/\\mathrm{MWh}$，$f_2 = 9000 \\ \\$/\\mathrm{h}$。\n  - 需求情景：$\\{d_k\\} = [40, 60, 110] \\ \\mathrm{MWh}$，对应概率 $\\{\\pi_k\\} = [0.7, 0.2, 0.1]$。\n  - 惩罚：$\\lambda = 200 \\ \\$/\\mathrm{MWh}$。\n  - 置信水平：$\\beta = 0.9$。\n\n您的程序必须完全按照规定实现计算，并将三个测试用例的结果以单行方括号内逗号分隔列表的形式输出，不含空格。",
            "solution": "用户提供的问题是能源系统优化领域一个明确定义的练习，重点在于比较不确定性下的风险中性（期望成本）决策与风险规避（条件风险价值）决策。问题陈述具有科学依据，内容完整且逻辑一致。因此，该问题被视为有效，并提供完整解答如下。\n\n### **问题建模与方法**\n\n该问题要求我们为面临不确定性需求的双发电机电力系统确定最优启停策略。启停决策由二元变量 $(x_1, x_2)$ 表示，其中 $x_i=1$ 表示发电机 $i$ 开启，$x_i=0$ 表示其关闭。我们必须在两个不同目标下比较最优启停策略：最小化总期望成本和最小化总成本的条件风险价值（CVaR）。\n\n该方法的核心是对四种可能的启停策略 $(x_1, x_2) \\in \\{(0,0), (0,1), (1,0), (1,1)\\}$ 中的每一种，执行一个四步流程：\n\n1.  **各情景下的最优调度：** 对于给定的启停组合 $(x_1, x_2)$ 和特定的需求情景 $d_k$，我们必须确定成本最低的发电调度 $(g_1, g_2)$ 和切负荷量 $L$。问题指明发电机成本 $c_i$ 是线性的，切负荷惩罚 $\\lambda$ 也是线性的。这导出了一个优先顺序调度法则：首先使用最便宜的可用资源来满足需求，直至其容量上限，然后再转向次便宜的资源。边际成本满足 $c_1  c_2  \\lambda$。因此，对于给定的需求 $d_k$ 和总可用容量 $C_{total} = x_1 P_1 + x_2 P_2$：\n    *   机组1的发电量：$g_1 = \\min(d_k, x_1 P_1)$。\n    *   待满足的剩余需求：$d'_k = d_k - g_1$。\n    *   机组2的发电量：$g_2 = \\min(d'_k, x_2 P_2)$。\n    *   未满足的需求（切负荷）：$L = d_k - g_1 - g_2 = \\max(0, d_k - C_{total})$。\n    此情景的可变调度成本为 $C_{disp,k} = c_1 g_1 + c_2 g_2 + \\lambda L$。\n\n2.  **总情景成本计算：** 在启停组合 $(x_1, x_2)$ 下，情景 $k$ 的总成本是可变调度成本与固定启停成本之和：\n    $$C_{total, k}(x_1, x_2) = C_{disp,k} + (f_1 x_1 + f_2 x_2)$$\n\n3.  **目标函数评估：**\n    *   **期望成本：** 对于每种启停组合 $(x_1, x_2)$，期望成本是所有 $K$ 个情景下总成本的概率加权平均值：\n    $$\\mathbb{E}[\\text{cost}](x_1, x_2) = \\sum_{k=1}^K \\pi_k C_{total, k}(x_1, x_2)$$\n    *   **条件风险价值 (CVaR)：** 在置信水平 $\\beta$ 下的 CVaR 度量了在 $(1-\\beta)\\%$ 最差情景下的期望损失。对于成本 $\\{C_k\\}_{k=1}^K$ 及其概率 $\\{\\pi_k\\}_{k=1}^K$ 的离散分布，可以推导出一个标准的 $\\operatorname{CVaR}_\\beta$ 计算公式。首先，我们将成本-概率对 $(C_k, \\pi_k)$ 按成本的非降序排列，得到序列 $(C_{(i)}, \\pi_{(i)})$，其中 $i=1, \\dots, K$。然后，我们找到最小的索引 $m$，使得累积概率 $P_m = \\sum_{i=1}^m \\pi_{(i)} \\ge \\beta$。于是 $\\operatorname{CVaR}_\\beta$ 可计算为：\n    $$\\operatorname{CVaR}_\\beta = \\frac{1}{1-\\beta} \\left[ \\sum_{i=m+1}^K \\pi_{(i)} C_{(i)} + \\left(\\sum_{i=1}^m \\pi_{(i)} - \\beta \\right) C_{(m)} \\right]$$\n    该公式能正确处理 $\\beta$-分位数落在一个概率质量内或恰好在边界上的情况。\n\n4.  **最优启停组合选择与分析：** 在计算完所有四种启停策略的期望成本和 CVaR 后，我们确定最优策略：\n    *   期望成本最优的启停组合为 $(x_1^*, x_2^*)_{\\mathbb{E}} = \\arg\\min_{(x_1,x_2)} \\mathbb{E}[\\text{cost}](x_1, x_2)$。\n    *   CVaR 最优的启停组合为 $(x_1^*, x_2^*)_{\\operatorname{CVaR}} = \\arg\\min_{(x_1,x_2)} \\operatorname{CVaR}_\\beta[\\text{cost}](x_1, x_2)$。\n    平局通过选择字典序最小的启停组合来解决。最后，在期望成本最优的启停组合下，发生切负荷的概率计算为所有需求超过可用容量的情景的概率之和：\n    $$P(L>0) = \\sum_{k: d_k > (x_1^*)_{\\mathbb{E}} P_1 + (x_2^*)_{\\mathbb{E}} P_2} \\pi_k$$\n\n对所提供的三个测试用例中的每一个都执行了此完整过程。\n\n### **测试用例1的详细计算**\n\n让我们以测试用例1为例说明该过程：\n- 参数：$P_1=50$, $c_1=20$, $f_1=500$；$P_2=70$, $c_2=50$, $f_2=9000$；需求 $\\{d_k\\}=[40, 60, 110]$；概率 $\\{\\pi_k\\}=[0.7, 0.2, 0.1]$；$\\lambda=1000$；$\\beta=0.9$。\n\n**1. 启停组合 $(x_1, x_2) = (1, 0)$：**\n- 容量 $C_{total} = 50$。固定成本 $C_{fixed} = 500$。\n- 情景 $k=1$ ($d_1=40$)：$g_1=40, g_2=0, L=0$。$C_{disp,1} = 20 \\times 40 = 800$。$C_{total,1} = 800 + 500 = 1300$。\n- 情景 $k=2$ ($d_2=60$)：$g_1=50, g_2=0, L=10$。$C_{disp,2} = 20 \\times 50 + 1000 \\times 10 = 11000$。$C_{total,2} = 11000 + 500 = 11500$。\n- 情景 $k=3$ ($d_3=110$)：$g_1=50, g_2=0, L=60$。$C_{disp,3} = 20 \\times 50 + 1000 \\times 60 = 61000$。$C_{total,3} = 61000 + 500 = 61500$。\n- 期望成本：$0.7(1300) + 0.2(11500) + 0.1(61500) = 910 + 2300 + 6150 = 9360$。\n- CVaR$_{0.9}$：成本为 $[1300, 11500, 61500]$，对应概率为 $[0.7, 0.2, 0.1]$。累积概率为 $[0.7, 0.9, 1.0]$。最差的 $10\\%$ 结果对应第三个情景。$\\operatorname{CVaR}_{0.9} = 61500$。\n\n**2. 启停组合 $(x_1, x_2) = (1, 1)$：**\n- 容量 $C_{total} = 120$。固定成本 $C_{fixed} = 500 + 9000 = 9500$。\n- 情景 $k=1$ ($d_1=40$)：$g_1=40, g_2=0, L=0$。$C_{disp,1} = 20 \\times 40 = 800$。$C_{total,1} = 800 + 9500 = 10300$。\n- 情景 $k=2$ ($d_2=60$)：$g_1=50, g_2=10, L=0$。$C_{disp,2} = 20 \\times 50 + 50 \\times 10 = 1500$。$C_{total,2} = 1500 + 9500 = 11000$。\n- 情景 $k=3$ ($d_3=110$)：$g_1=50, g_2=60, L=0$。$C_{disp,3} = 20 \\times 50 + 50 \\times 60 = 4000$。$C_{total,3} = 4000 + 9500 = 13500$。\n- 期望成本：$0.7(10300) + 0.2(11000) + 0.1(13500) = 7210 + 2200 + 1350 = 10760$。\n- CVaR$_{0.9}$：成本为 $[10300, 11000, 13500]$。最差的 $10\\%$ 结果对应第三个情景。$\\operatorname{CVaR}_{0.9} = 13500$。\n\n在评估所有四种启停组合后，我们发现：\n- 期望成本最优：$(1,0)$，其 $\\mathbb{E}[\\text{cost}] = 9360$。\n- CVaR最优：$(1,1)$，其 $\\operatorname{CVaR}_{0.9} = 13500$。\n- 两种最优启停组合不同。\n- 对于 $(1,0)$ 的切负荷概率：容量为 $50 \\mathrm{MWh}$。需求为 $40, 60, 110 \\mathrm{MWh}$。当需求为 $60$ 和 $110$ 时发生切负荷。概率之和为 $0.2 + 0.1 = 0.3$。\n\n对所有测试用例重复相同的计算以生成最终输出。结果展示了在最小化平均成本（这可能接受高成本、低概率的事件）和减轻尾部风险（这优先避免灾难性的高成本后果，即使会增加平均成本）之间的权衡。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the generation commitment and dispatch problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"g1\": {\"P\": 50, \"c\": 20, \"f\": 500},\n            \"g2\": {\"P\": 70, \"c\": 50, \"f\": 9000},\n            \"demand\": {\"d\": np.array([40, 60, 110]), \"pi\": np.array([0.7, 0.2, 0.1])},\n            \"lambda\": 1000,\n            \"beta\": 0.9,\n        },\n        {\n            \"g1\": {\"P\": 50, \"c\": 20, \"f\": 500},\n            \"g2\": {\"P\": 70, \"c\": 50, \"f\": 2000},\n            \"demand\": {\"d\": np.array([40, 60, 110]), \"pi\": np.array([0.7, 0.2, 0.1])},\n            \"lambda\": 1000,\n            \"beta\": 0.9,\n        },\n        {\n            \"g1\": {\"P\": 50, \"c\": 20, \"f\": 500},\n            \"g2\": {\"P\": 70, \"c\": 50, \"f\": 9000},\n            \"demand\": {\"d\": np.array([40, 60, 110]), \"pi\": np.array([0.7, 0.2, 0.1])},\n            \"lambda\": 200,\n            \"beta\": 0.9,\n        },\n    ]\n\n    results = []\n\n    for case in test_cases:\n        e_cost_results = {'cost': float('inf'), 'commit': None}\n        cvar_results = {'cost': float('inf'), 'commit': None}\n\n        # Enumerate all 4 commitment patterns in lexicographic order\n        commitments = [(0, 0), (0, 1), (1, 0), (1, 1)]\n\n        for x1, x2 in commitments:\n            # Calculate total scenario costs for this commitment\n            total_costs = []\n            \n            p1, c1, f1 = case[\"g1\"][\"P\"], case[\"g1\"][\"c\"], case[\"g1\"][\"f\"]\n            p2, c2, f2 = case[\"g2\"][\"P\"], case[\"g2\"][\"c\"], case[\"g2\"][\"f\"]\n            demands = case[\"demand\"][\"d\"]\n            probs = case[\"demand\"][\"pi\"]\n            lambda_val = case[\"lambda\"]\n            beta = case[\"beta\"]\n\n            fixed_cost = x1 * f1 + x2 * f2\n\n            for d_k in demands:\n                # Optimal dispatch based on merit order (c1  c2  lambda)\n                # Generator 1 dispatch\n                g1 = min(d_k, x1 * p1)\n                rem_demand = d_k - g1\n                \n                # Generator 2 dispatch\n                g2 = min(rem_demand, x2 * p2)\n                rem_demand -= g2\n                \n                # Load shedding\n                L = rem_demand\n\n                dispatch_cost = c1 * g1 + c2 * g2 + lambda_val * L\n                total_scenario_cost = dispatch_cost + fixed_cost\n                total_costs.append(total_scenario_cost)\n\n            total_costs = np.array(total_costs)\n\n            # Calculate Expected Cost\n            expected_cost = np.dot(total_costs, probs)\n\n            # Calculate Conditional Value-at-Risk (CVaR)\n            cost_prob_pairs = sorted(zip(total_costs, probs))\n            sorted_costs, sorted_probs = zip(*cost_prob_pairs)\n            \n            cum_prob = 0.0\n            cvar_m_idx = -1\n            for i in range(len(sorted_probs)):\n                cum_prob += sorted_probs[i]\n                if cum_prob >= beta:\n                    cvar_m_idx = i\n                    break\n            \n            cvar_val = 0.0\n            if 1.0 - beta > 1e-9: # Use tolerance for float comparison\n                tail_sum = 0.0\n                if cvar_m_idx + 1  len(sorted_costs):\n                    tail_sum = np.dot(sorted_costs[cvar_m_idx+1:], sorted_probs[cvar_m_idx+1:])\n                \n                spillover_prob = cum_prob - beta\n                cvar_val = (tail_sum + spillover_prob * sorted_costs[cvar_m_idx]) / (1.0 - beta)\n            else: # if beta is 1, CVaR is the max cost\n                 cvar_val = sorted_costs[-1]\n\n\n            # Update optimal commitments (tie-breaking is handled by loop order)\n            if expected_cost  e_cost_results['cost']:\n                e_cost_results['cost'] = expected_cost\n                e_cost_results['commit'] = (x1, x2)\n            \n            if cvar_val  cvar_results['cost']:\n                cvar_results['cost'] = cvar_val\n                cvar_results['commit'] = (x1, x2)\n\n        # Calculate probability of load shedding for E-cost optimal commitment\n        e_cost_optimal_commit = e_cost_results['commit']\n        total_capacity_e_cost = e_cost_optimal_commit[0] * p1 + e_cost_optimal_commit[1] * p2\n        \n        shed_prob = 0.0\n        for i, d_k in enumerate(demands):\n            if d_k > total_capacity_e_cost:\n                shed_prob += probs[i]\n\n        # Indicator for differing commitments\n        commits_differ = 1 if e_cost_results['commit'] != cvar_results['commit'] else 0\n\n        # Assemble the final list for this case\n        case_result = [\n            e_cost_results['commit'][0],\n            e_cost_results['commit'][1],\n            float(e_cost_results['cost']),\n            cvar_results['commit'][0],\n            cvar_results['commit'][1],\n            float(cvar_results['cost']),\n            commits_differ,\n            float(shed_prob)\n        ]\n        results.append(case_result)\n\n    # Format the final output string\n    case_strings = [f\"[{','.join(map(str, r))}]\" for r in results]\n    print(f\"[{','.join(case_strings)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在真实的能源系统中，不确定性来源（如风力或太阳能发电）之间往往存在相关性。本练习作为一个高级建模实践，旨在揭示正确建模这些相关性的关键重要性。您将量化分析忽略相关性（即假设不确定性是独立的）与考虑相关性两种情况下，所需的风险裕度有何不同，并由此理解为何忽略正相关性可能会导致对系统风险的危险低估。",
            "id": "4077130",
            "problem": "考虑一个能源系统，其不确定的净注入量（例如，风力和太阳能发电厂）汇集在单个平衡区域。设预测误差向量为 $\\mathbf{w} \\in \\mathbb{R}^n$，单位为兆瓦（MW），建模为一个零均值的多元正态随机向量，其协方差矩阵为 $\\Sigma \\in \\mathbb{R}^{n \\times n}$。影响所需的上调备用容量的总不平衡量是线性组合 $L = \\mathbf{1}^\\top \\mathbf{w}$，其中 $\\mathbf{1}$ 是全为1的向量。我们关注两种经典范式下的风险感知备用容量：机会约束和条件风险价值（CVaR），这两种方法在能源系统建模中都很常见。\n\n从以下基础出发：\n- 多元正态随机变量线性变换的性质，即联合正态变量的任何线性组合都是单变量正态的。\n- 单侧机会约束和条件风险价值（CVaR）的定义，包括它们分别作为尾部概率控制和尾部期望损失的解释。\n- 对于任何确定性向量 $a$，线性组合的方差由 $\\mathrm{Var}(a^\\top \\mathbf{w}) = a^\\top \\Sigma a$ 给出。\n\n您的任务是：\n1. 对于给定的置信水平参数 $\\alpha \\in (0,1)$，推导在总不平衡量 $L$ 的单侧机会约束下所需的上调备用容量，以兆瓦（MW）为单位表示。\n2. 在相同的置信水平参数 $\\alpha$ 下，推导基于CVaR的相同总不平衡量 $L$ 的备用容量，以兆瓦（MW）为单位。\n3. 通过分别使用完整协方差矩阵 $\\Sigma$ 和一个忽略非对角相关项的对角近似 $\\mathrm{diag}(\\Sigma)$ 来计算两种备用容量，从而量化净注入量之间相关性的影响。对角近似被定义为与 $\\Sigma$ 对角线元素相同，而其他位置为零的矩阵。\n4. 为每种情况提供科学依据的评估，判断对角近似相对于完整协方差是否是保守的。保守性定义为使用 $\\mathrm{diag}(\\Sigma)$ 计算的备用容量大于或等于使用 $\\Sigma$ 计算的备用容量。\n\n您必须实现一个完整的、可运行的程序，为每个测试用例计算：\n- 使用 $\\Sigma$ 和 $\\mathrm{diag}(\\Sigma)$ 的机会约束备用容量，单位为MW。\n- 使用 $\\Sigma$ 和 $\\mathrm{diag}(\\Sigma)$ 的条件风险价值备用容量，单位为MW。\n- 两个布尔指标，如果对角近似对相应的备用容量是保守的，则为 $1$，否则为 $0$。\n\n系统不确定性由方差和一个等相关结构构建。对于给定的方差向量 $(\\sigma_1^2,\\ldots,\\sigma_n^2)$ 和等相关参数 $\\rho \\in \\left[-\\frac{1}{n-1},1\\right]$，协方差矩阵定义为\n$$\n\\Sigma_{ij} = \n\\begin{cases}\n\\sigma_i^2  \\text{if } i=j, \\\\\n\\rho \\, \\sigma_i \\sigma_j  \\text{if } i \\neq j.\n\\end{cases}\n$$\n\n实现程序以评估以下测试套件。每个测试用例是一个元组 $(n, \\text{variances}, \\rho, \\alpha)$：\n- 案例A（一般正相关）：$(3, [25, 9, 16], 0.5, 0.95)$。\n- 案例B（一般负相关）：$(3, [25, 9, 16], -0.4, 0.95)$。\n- 案例C（独立边界）：$(5, [4, 4, 4, 4, 4], 0.0, 0.99)$。\n- 案例D（强正相关）：$(4, [100, 36, 49, 64], 0.9, 0.90)$。\n- 案例E（高维中的弱负相关）：$(6, [9, 16, 9, 4, 25, 36], -0.15, 0.95)$。\n\n科学真实性要求：\n- 所有备用容量必须以兆瓦（MW）为单位，表示为实数。\n- 对角近似必须精确保留方差，同时将所有协方差设置为零。\n- 确保在每个案例中，$\\rho$ 都满足等相关的半正定条件 $\\rho \\in \\left[-\\frac{1}{n-1},1\\right]$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表。\n- 每个测试用例的结果必须是按以下顺序排列的列表：\n  $[\\text{CC\\_full}, \\text{CC\\_diag}, \\text{CVaR\\_full}, \\text{CVaR\\_diag}, \\text{CC\\_diag\\_is\\_conservative}, \\text{CVaR\\_diag\\_is\\_conservative}]$,\n  其中 $\\text{CC\\_full}$ 和 $\\text{CC\\_diag}$ 分别是使用 $\\Sigma$ 和 $\\mathrm{diag}(\\Sigma)$ 的机会约束备用容量（MW），$\\text{CVaR\\_full}$ 和 $\\text{CVaR\\_diag}$ 是对应的基于CVaR的备用容量（MW），最后两项是表示是否保守的指标（$1$ 表示保守，$0$ 表示非保守）。\n- 例如，总输出将如下所示： \n  $[[\\dots],[\\dots],[\\dots],[\\dots],[\\dots]]$。\n\n您的程序必须是自包含的，不需要任何输入，并且必须遵守指定的执行环境。答案必须仅为浮点数和整数，备用容量单位为MW。",
            "solution": "该问题陈述经评估是有效的。它在科学上基于概率论及其在能源系统风险管理中的应用，使用了标准的模型和定义。该问题定义良好，提供了所有必要的数据和条件，可以得出一个唯一的、有意义的解决方案。语言客观而精确。所有测试用例都满足给定的相关参数 $\\rho$ 的约束条件。因此，我们可以进行求解。\n\n分析分为五个部分：首先，我们描述总不平衡量 $L$ 的统计特性；其次，我们推导机会约束（CC）备用容量的公式；第三，我们推导基于条件风险价值（CVaR）的备用容量的公式；第四，我们为协方差矩阵的对角近似指定这些备用容量；第五，我们评估对角近似在何种条件下是保守的。\n\n**1. 总不平衡量的统计特性表征**\n\n预测误差向量 $\\mathbf{w} \\in \\mathbb{R}^n$ 被给定为一个零均值的多元正态随机向量，即 $\\mathbf{w} \\sim \\mathcal{N}(\\mathbf{0}, \\Sigma)$。总不平衡量 $L$ 是 $\\mathbf{w}$ 中元素的线性组合，定义为 $L = \\mathbf{1}^\\top \\mathbf{w} = \\sum_{i=1}^{n} w_i$，其中 $\\mathbf{1}$ 是 $n \\times 1$ 的全一向量。\n\n多元正态分布的一个基本性质是，其分量的任何线性组合也服从正态分布。因此，$L$ 是一个单变量正态随机变量。\n\n$L$ 的均值为：\n$$E[L] = E[\\mathbf{1}^\\top \\mathbf{w}] = \\mathbf{1}^\\top E[\\mathbf{w}] = \\mathbf{1}^\\top \\mathbf{0} = 0$$\n\n$L$ 的方差，记为 $\\sigma_L^2$，是：\n$$\\sigma_L^2 = \\mathrm{Var}(L) = \\mathrm{Var}(\\mathbf{1}^\\top \\mathbf{w}) = \\mathbf{1}^\\top \\Sigma \\mathbf{1}$$\n展开这个矩阵表达式，方差是协方差矩阵 $\\Sigma$ 中所有元素的总和：\n$$\\sigma_L^2 = \\sum_{i=1}^{n} \\sum_{j=1}^{n} \\Sigma_{ij} = \\sum_{i=1}^{n} \\Sigma_{ii} + \\sum_{i \\neq j} \\Sigma_{ij}$$\n使用给定的等相关结构，其中 $\\Sigma_{ii} = \\sigma_i^2$ 且当 $i \\neq j$ 时 $\\Sigma_{ij} = \\rho \\sigma_i \\sigma_j$，我们有：\n$$\\sigma_L^2 = \\sum_{i=1}^{n} \\sigma_i^2 + \\sum_{i \\neq j} \\rho \\sigma_i \\sigma_j = \\sum_{i=1}^{n} \\sigma_i^2 + \\rho \\sum_{i \\neq j} \\sigma_i \\sigma_j$$\n因此，总不平衡量服从正态分布 $L \\sim \\mathcal{N}(0, \\sigma_L^2)$，其标准差为 $\\sigma_L = \\sqrt{\\mathbf{1}^\\top \\Sigma \\mathbf{1}}$。\n\n**2. 机会约束（CC）备用容量的推导**\n\n机会约束上调备用容量 $R_{CC}$ 由以下条件决定：总不平衡量 $L$ 不超过该容量的概率至少为给定的置信水平 $\\alpha \\in (0, 1)$。为求得最紧的备用容量，我们求解等式：\n$$\\mathrm{P}(L \\le R_{CC}) = \\alpha$$\n该表达式将 $R_{CC}$ 定义为 $L$ 分布的 $\\alpha$-分位数，也称为置信水平为 $\\alpha$ 的风险价值（VaR）。\n\n为了求这个值，我们对随机变量 $L$ 进行标准化。设 $Z = L/\\sigma_L$ 为一个标准正态随机变量，$Z \\sim \\mathcal{N}(0, 1)$。条件变为：\n$$\\mathrm{P}\\left(\\frac{L}{\\sigma_L} \\le \\frac{R_{CC}}{\\sigma_L}\\right) = \\mathrm{P}\\left(Z \\le \\frac{R_{CC}}{\\sigma_L}\\right) = \\alpha$$\n设 $\\Phi(\\cdot)$ 为标准正态分布的累积分布函数（CDF）。该概率为 $\\Phi(R_{CC}/\\sigma_L) = \\alpha$。\n应用逆CDF，即分位数函数 $\\Phi^{-1}(\\cdot)$，我们得到：\n$$\\frac{R_{CC}}{\\sigma_L} = \\Phi^{-1}(\\alpha)$$\n因此，机会约束备用容量为：\n$$R_{CC} = \\sigma_L \\cdot \\Phi^{-1}(\\alpha) = \\sqrt{\\mathbf{1}^\\top \\Sigma \\mathbf{1}} \\cdot \\Phi^{-1}(\\alpha)$$\n\n**3. 基于CVaR的备用容量的推导**\n\n在置信水平 $\\alpha$ 下的条件风险价值 $\\mathrm{CVaR}_\\alpha(L)$ 是不平衡量在超过VaR分位数（即 $R_{CC}$）条件下的期望值。\n$$R_{CVaR} = \\mathrm{CVaR}_\\alpha(L) = E[L | L > R_{CC}]$$\n对于一个一般的正态随机变量 $X \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其 $\\mathrm{CVaR}$ 由以下公式给出：\n$$\\mathrm{CVaR}_\\alpha(X) = \\mu + \\sigma \\frac{\\phi(\\Phi^{-1}(\\alpha))}{1-\\alpha}$$\n其中 $\\phi(\\cdot)$ 是标准正态分布的概率密度函数（PDF）。\n\n对于我们的总不平衡量 $L \\sim \\mathcal{N}(0, \\sigma_L^2)$，我们有 $\\mu=0$ 和 $\\sigma=\\sigma_L$。将这些代入公式，得到基于CVaR的备用容量：\n$$R_{CVaR} = 0 + \\sigma_L \\frac{\\phi(\\Phi^{-1}(\\alpha))}{1-\\alpha} = \\sqrt{\\mathbf{1}^\\top \\Sigma \\mathbf{1}} \\cdot \\frac{\\phi(\\Phi^{-1}(\\alpha))}{1-\\alpha}$$\n\n**4. 对角近似下的备用容量**\n\n对角近似假设不确定性是不相关的，对于正态分布而言，这意味着独立性。这是通过将协方差矩阵的非对角元素设置为零来实现的，得到一个新矩阵 $\\Sigma' = \\mathrm{diag}(\\Sigma)$。在此近似下，总不平衡量的方差 $\\sigma_{L, diag}^2$ 为：\n$$\\sigma_{L, diag}^2 = \\mathbf{1}^\\top \\mathrm{diag}(\\Sigma) \\mathbf{1} = \\sum_{i=1}^n \\sigma_i^2$$\n相应的备用容量 $R_{CC, diag}$ 和 $R_{CVaR, diag}$ 是通过在推导出的公式中用 $\\sigma_{L, diag} = \\sqrt{\\sum_{i=1}^n \\sigma_i^2}$ 替换 $\\sigma_L$ 得到的：\n$$R_{CC, diag} = \\left(\\sqrt{\\sum_{i=1}^n \\sigma_i^2}\\right) \\cdot \\Phi^{-1}(\\alpha)$$\n$$R_{CVaR, diag} = \\left(\\sqrt{\\sum_{i=1}^n \\sigma_i^2}\\right) \\cdot \\frac{\\phi(\\Phi^{-1}(\\alpha))}{1-\\alpha}$$\n\n**5. 保守性评估**\n\n根据定义，如果对角近似产生的备用容量大于或等于使用完整协方差矩阵 $\\Sigma$ 计算的备用容量，则该近似是保守的。\n让我们比较 $R_{CC, diag}$ 和 $R_{CC, full}$。由于置信水平 $\\alpha > 0.5$，项 $\\Phi^{-1}(\\alpha)$ 是正的。比较因此简化为比较标准差：\n$$R_{CC, diag} \\ge R_{CC, full} \\iff \\sigma_{L, diag} \\ge \\sigma_{L, full}$$\n由于标准差是非负的，这等价于比较方差：\n$$\\sigma_{L, diag}^2 \\ge \\sigma_{L, full}^2$$\n代入方差的表达式：\n$$\\sum_{i=1}^{n} \\sigma_i^2 \\ge \\sum_{i=1}^{n} \\sigma_i^2 + \\rho \\sum_{i \\neq j} \\sigma_i \\sigma_j$$\n这个不等式简化为：\n$$0 \\ge \\rho \\sum_{i \\neq j} \\sigma_i \\sigma_j$$\n由于标准差 $\\sigma_i$ 是正的，所以和 $\\sum_{i \\neq j} \\sigma_i \\sigma_j$ 也是正的。因此，不等式的方向仅由等相关参数 $\\rho$ 的符号决定。\n- 如果 $\\rho > 0$，右侧为正值，所以不等式 $0 \\ge \\text{(正值)}$ 不成立。对角近似是**不保守的**（它低估了风险）。\n- 如果 $\\rho \\le 0$，右侧为非正值，所以不等式 $0 \\ge \\text{(非正值)}$ 成立。对角近似是**保守的**（它高估或等于风险）。\n\n同样的逻辑适用于CVaR备用容量，因为它们也与同一个标准差项 $\\sigma_L$ 成正比，且其乘数项对于 $\\alpha \\in (0,1)$ 也是正的。因此，对于CC和CVaR备用容量，保守性评估是相同的。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Calculates chance-constrained and CVaR-based reserve margins for an energy system \n    with correlated uncertainties, and assesses the conservatism of a diagonal covariance approximation.\n    \"\"\"\n    \n    # Each test case is a tuple: (n, variances, rho, alpha), where alpha is confidence level.\n    # variances are given as sigma_i^2 in MW^2.\n    test_cases = [\n        # Case A: General positive correlation\n        (3, [25, 9, 16], 0.5, 0.95),\n        # Case B: General negative correlation\n        (3, [25, 9, 16], -0.4, 0.95),\n        # Case C: Independence boundary\n        (5, [4, 4, 4, 4, 4], 0.0, 0.99),\n        # Case D: Strong positive correlation\n        (4, [100, 36, 49, 64], 0.9, 0.90),\n        # Case E: Mild negative correlation in higher dimension\n        (6, [9, 16, 9, 4, 25, 36], -0.15, 0.95),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        n, variances, rho, alpha = case\n        \n        variances = np.array(variances, dtype=float)\n        stds = np.sqrt(variances)\n        \n        # 1. Construct the full covariance matrix Sigma\n        # Sigma_ij = rho * sigma_i * sigma_j for i != j\n        # Sigma_ii = sigma_i^2\n        sigma_full = rho * np.outer(stds, stds)\n        np.fill_diagonal(sigma_full, variances)\n        \n        # 2. Calculate the variance of the aggregate imbalance L = 1^T * w\n        # For the full covariance matrix: Var(L) = 1^T * Sigma * 1\n        ones_vec = np.ones(n)\n        var_l_full = ones_vec.T @ sigma_full @ ones_vec\n        # Ensure variance is non-negative to avoid domain errors from small numerical inaccuracies\n        if var_l_full  0:\n            var_l_full = 0\n        sigma_l_full = np.sqrt(var_l_full)\n\n        # For the diagonal approximation: Var(L_diag) = sum(variances)\n        var_l_diag = np.sum(variances)\n        sigma_l_diag = np.sqrt(var_l_diag)\n        \n        # 3. Calculate risk measure multipliers\n        # For CC margin (VaR), the multiplier is the alpha-quantile of N(0,1)\n        z_alpha = norm.ppf(alpha)\n        \n        # For CVaR margin, the multiplier is pdf(z_alpha) / (1-alpha)\n        tail_prob = 1 - alpha\n        cvar_multiplier = 0.0\n        if tail_prob > 1e-9: # Avoid division by zero if alpha is close to 1\n            cvar_multiplier = norm.pdf(z_alpha) / tail_prob\n        \n        # 4. Calculate the four margins in MW\n        # R = sigma_L * multiplier\n        cc_full = sigma_l_full * z_alpha\n        cvar_full = sigma_l_full * cvar_multiplier\n        \n        cc_diag = sigma_l_diag * z_alpha\n        cvar_diag = sigma_l_diag * cvar_multiplier\n        \n        # 5. Assess conservatism of the diagonal approximation\n        # The approximation is conservative if its margin is >= the full model's margin.\n        # This is equivalent to sigma_l_diag >= sigma_l_full. We use a small tolerance\n        # for floating point comparisons, though simple >= is sufficient for these cases.\n        cc_diag_is_conservative = 1 if cc_diag >= cc_full else 0\n        cvar_diag_is_conservative = 1 if cvar_diag >= cvar_full else 0\n\n        case_result = [\n            cc_full, cc_diag, cvar_full, cvar_diag,\n            cc_diag_is_conservative, cvar_diag_is_conservative\n        ]\n        results.append(case_result)\n\n    # Format the final output string as specified\n    result_strings = []\n    for res in results:\n        # Format each number and integer within the inner list\n        inner_list_str = f\"[{','.join(f'{x:.10f}' if isinstance(x, float) else str(x) for x in res)}]\"\n        result_strings.append(inner_list_str)\n        \n    final_output = f\"[{','.join(result_strings)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        }
    ]
}