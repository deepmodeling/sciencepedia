{
    "hands_on_practices": [
        {
            "introduction": "在将条件风险价值（CVaR）应用于复杂的能源系统模型之前，首先必须掌握其基本数学性质。本练习将通过一个重要的例子——帕累托分布，来加深您对CVaR的理解。通过从第一性原理出发推导其解析表达式 ()，您将清晰地看到诸如尾部指数 $\\beta$ 等参数如何直接影响风险度量，这对于理解和量化重尾极端事件风险至关重要。",
            "id": "4080154",
            "problem": "一位能源系统规划师正在为一个高可再生能源渗透率的微电网中极端运营成本的尾部风险进行建模。历史分析表明，极端事件造成的损失 $L$（以货币单位计量）服从帕累托分布，其最小尺度为 $x_{m} > 0$，尾部指数为 $\\beta > 1$，其累积分布函数为 $F(l) = 1 - \\left(\\frac{x_{m}}{l}\\right)^{\\beta}$，其中 $l \\geq x_{m}$。该规划师使用置信水平为 $\\alpha \\in (0,1)$ 的条件风险价值 (CVaR) 来增强容量规划对尾部损失的鲁棒性。\n\n从连续损失分布的风险价值 (VaR) 和条件风险价值 (CVaR) 的核心定义出发——其中，水平为 $\\alpha$ 的 VaR 是损失分布的 $\\alpha$-分位数，而水平为 $\\alpha$ 的 CVaR 是在损失超过 VaR 条件下的期望损失——推导出一个关于 $\\alpha$、$\\beta$ 和 $x_{m}$ 的 $\\mathrm{CVaR}_{\\alpha}(L)$ 的闭式解析表达式。然后，分析当 $\\alpha \\to 1^{-}$ 时，$\\mathrm{CVaR}_{\\alpha}(L)$ 对 $\\alpha$ 的敏感性，解释其极限行为和敏感性变化的速度。\n\n将最终答案表示为关于 $\\alpha$、$\\beta$ 和 $x_{m}$ 的 $\\mathrm{CVaR}_{\\alpha}(L)$ 的单个闭式解析表达式。不需要进行数值四舍五入，最终表达式中不应包含任何物理单位。",
            "solution": "问题陈述经评估有效。它具有科学依据，问题提出得当，客观且自洽。该问题清晰地定义了损失变量 $L$ 服从帕累托分布，其指定参数为 $x_{m} > 0$ 和 $\\beta > 1$，累积分布函数 (CDF) 为 $F(l) = 1 - (\\frac{x_{m}}{l})^{\\beta}$，其中 $l \\geq x_{m}$。它在置信水平 $\\alpha \\in (0,1)$ 下使用了风险价值 ($\\mathrm{VaR}$) 和条件风险价值 ($\\mathrm{CVaR}$) 的标准、可形式化的定义。推导 $\\mathrm{CVaR}_{\\alpha}(L)$ 的闭式表达式并分析其敏感性的任务是一项定义明确的数学练习，没有明显的矛盾或歧义。条件 $\\beta > 1$ 至关重要，因为它确保了该分布具有有限的一阶矩（均值），这是 $\\mathrm{CVaR}$ 有限且定义良好的必要条件。\n\n推导过程分三步进行：首先，我们确定概率密度函数 (PDF)；其次，我们计算风险价值 ($\\mathrm{VaR}_{\\alpha}(L)$)；第三，我们使用这些结果来计算条件风险价值 ($\\mathrm{CVaR}_{\\alpha}(L)$)。\n\n首先，我们通过对 CDF $F(l)$ 关于 $l$（其中 $l \\geq x_{m}$）求导来找到 PDF $f(l)$：\n$$f(l) = \\frac{d}{dl} F(l) = \\frac{d}{dl} \\left( 1 - \\left(\\frac{x_{m}}{l}\\right)^{\\beta} \\right)$$\n$$f(l) = \\frac{d}{dl} \\left( 1 - x_{m}^{\\beta}l^{-\\beta} \\right) = -x_{m}^{\\beta}(-\\beta)l^{-\\beta-1} = \\frac{\\beta x_{m}^{\\beta}}{l^{\\beta+1}}$$\n\n其次，我们确定风险价值 $\\mathrm{VaR}_{\\alpha}(L)$，它是这样一个值 $v$，使得损失小于或等于 $v$ 的概率为 $\\alpha$。这是分布的 $\\alpha$-分位数，通过设 $F(v) = \\alpha$ 并求解 $v$ 来得到。\n$$F(v) = 1 - \\left(\\frac{x_{m}}{v}\\right)^{\\beta} = \\alpha$$\n$$\\left(\\frac{x_{m}}{v}\\right)^{\\beta} = 1 - \\alpha$$\n$$\\frac{x_{m}}{v} = (1 - \\alpha)^{\\frac{1}{\\beta}}$$\n$$v = \\frac{x_{m}}{(1 - \\alpha)^{\\frac{1}{\\beta}}} = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\n因此，我们得到了风险价值的表达式：\n$$\\mathrm{VaR}_{\\alpha}(L) = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\n\n第三，我们推导条件风险价值 $\\mathrm{CVaR}_{\\alpha}(L)$，它被定义为在损失超过 VaR 的条件下的期望损失。对于连续分布，其公式为：\n$$\\mathrm{CVaR}_{\\alpha}(L) = E[L | L > \\mathrm{VaR}_{\\alpha}(L)] = \\frac{1}{1-\\alpha} \\int_{\\mathrm{VaR}_{\\alpha}(L)}^{\\infty} l \\cdot f(l) \\, dl$$\n令 $v = \\mathrm{VaR}_{\\alpha}(L)$。我们先计算积分部分：\n$$\\int_{v}^{\\infty} l \\cdot f(l) \\, dl = \\int_{v}^{\\infty} l \\cdot \\frac{\\beta x_{m}^{\\beta}}{l^{\\beta+1}} \\, dl = \\beta x_{m}^{\\beta} \\int_{v}^{\\infty} l^{-\\beta} \\, dl$$\n由于问题陈述 $\\beta > 1$，我们可以计算这个瑕积分：\n$$\\int_{v}^{\\infty} l^{-\\beta} \\, dl = \\left[ \\frac{l^{-\\beta+1}}{-\\beta+1} \\right]_{v}^{\\infty} = \\frac{1}{1-\\beta} \\left[ l^{1-\\beta} \\right]_{v}^{\\infty}$$\n因为 $\\beta > 1$，指数 $1-\\beta$ 是负数。因此，当 $l \\to \\infty$ 时，$l^{1-\\beta} \\to 0$。该积分计算结果为：\n$$\\frac{1}{1-\\beta} (0 - v^{1-\\beta}) = \\frac{-v^{1-\\beta}}{1-\\beta} = \\frac{v^{1-\\beta}}{\\beta-1}$$\n将此结果代回到 $l \\cdot f(l)$ 的积分表达式中：\n$$\\int_{v}^{\\infty} l \\cdot f(l) \\, dl = \\beta x_{m}^{\\beta} \\left( \\frac{v^{1-\\beta}}{\\beta-1} \\right) = \\frac{\\beta x_{m}^{\\beta}}{\\beta-1} v^{1-\\beta}$$\n现在，我们代入 $v = \\mathrm{VaR}_{\\alpha}(L) = x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}}$ 的表达式：\n$$\\frac{\\beta x_{m}^{\\beta}}{\\beta-1} \\left( x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right)^{1-\\beta} = \\frac{\\beta x_{m}^{\\beta}}{\\beta-1} x_{m}^{1-\\beta} (1 - \\alpha)^{\\left(-\\frac{1}{\\beta}\\right)(1-\\beta)}$$\n$$= \\frac{\\beta x_{m}^{\\beta+1-\\beta}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}} = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}}$$\n最后，我们将此结果代入 $\\mathrm{CVaR}_{\\alpha}(L)$ 的公式中：\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{1}{1-\\alpha} \\left( \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta}} \\right)$$\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1}{\\beta} - 1} = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{\\frac{\\beta-1-\\beta}{\\beta}}$$\n这可以简化为 $\\mathrm{CVaR}_{\\alpha}(L)$ 的最终闭式表达式：\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}}$$\n值得注意的是，我们可以将 $\\mathrm{CVaR}_{\\alpha}(L)$ 表示为 $\\mathrm{VaR}_{\\alpha}(L)$ 的倍数：\n$$\\mathrm{CVaR}_{\\alpha}(L) = \\frac{\\beta}{\\beta-1} \\left( x_{m} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right) = \\frac{\\beta}{\\beta-1} \\mathrm{VaR}_{\\alpha}(L)$$\n由于 $\\beta > 1$，因子 $\\frac{\\beta}{\\beta-1}$ 总是大于 1。\n\n对于敏感性分析，我们考察当 $\\alpha \\to 1^{-}$ 时的行为。当 $\\alpha$ 趋近于 1 时，项 $(1-\\alpha)$ 从正方向趋近于 0。由于指数 $-\\frac{1}{\\beta}$ 是负数，项 $(1-\\alpha)^{-\\frac{1}{\\beta}}$ 会无界增长。\n$$\\lim_{\\alpha \\to 1^{-}} \\mathrm{CVaR}_{\\alpha}(L) = \\lim_{\\alpha \\to 1^{-}} \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}} = \\infty$$\n这表明极端尾部的期望损失是无界的，这是帕累托分布等重尾分布的特征。\n为了找到敏感性变化的速度，我们计算 $\\mathrm{CVaR}_{\\alpha}(L)$ 关于 $\\alpha$ 的导数：\n$$\\frac{d}{d\\alpha} \\mathrm{CVaR}_{\\alpha}(L) = \\frac{d}{d\\alpha} \\left[ \\frac{\\beta x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{1}{\\beta}} \\right]$$\n$$= \\frac{\\beta x_{m}}{\\beta-1} \\left( -\\frac{1}{\\beta} \\right) (1 - \\alpha)^{-\\frac{1}{\\beta}-1} (-1)$$\n$$= \\frac{x_{m}}{\\beta-1} (1 - \\alpha)^{-\\frac{\\beta+1}{\\beta}}$$\n当 $\\alpha \\to 1^{-}$ 时，敏感性本身也趋于无穷大。这种发散的速度是一个幂律，即 $(1-\\alpha)^{-(1+1/\\beta)}$。随着分布的尾部变得更重（即 $\\beta$ 减小并趋向于 1），指数 $-(1+\\frac{1}{\\beta})$ 的量级会增加，导致当考虑更极端的事件（$\\alpha \\to 1^{-}$）时，$\\mathrm{CVaR}$ 对 $\\alpha$ 变化的敏感性增长得更快。",
            "answer": "$$\\boxed{\\frac{\\beta x_{m}}{\\beta - 1} (1 - \\alpha)^{-\\frac{1}{\\beta}}}$$"
        },
        {
            "introduction": "理论推导提供了深刻的见解，但在实际规划中，我们通常处理的是来自仿真的离散情景数据。本练习将理论与实践联系起来，要求您使用样本平均近似（Sample Average Approximation, SAA）方法从一组给定的损失样本中计算CVaR。通过解决这个基于优化的公式 ()，您将掌握一项核心技能：如何在没有已知概率分布的情况下，对基于情景的风险进行量化。",
            "id": "4080182",
            "problem": "一位规划者在评估能源系统扩展时，研究了在燃料价格和可再生能源可用性不确定性下的年度总成本。给出了一组包含 $n=10$ 个情景损失（年度总成本，视为损失）的历史蒙特卡洛样本，单位为百万美元，如下所示：\n$$\nL_1=42.3,\\quad L_2=45.1,\\quad L_3=39.8,\\quad L_4=50.0,\\quad L_5=47.6,\\quad L_6=41.2,\\quad L_7=49.4,\\quad L_8=46.8,\\quad L_9=52.7,\\quad L_{10}=44.0.\n$$\n使用条件风险价值 (CVaR) 的样本平均近似 (SAA) 方法，通过选择最小化潜在分段线性目标的松弛变量 $\\eta$，计算置信水平 $\\alpha=0.95$ 下的 $\\alpha$-水平 CVaR。使用 CVaR 的基本定义，即其是基于正部算子的凸泛函的最小值。以百万美元为单位表示最终的 CVaR 值。将答案四舍五入到四位有效数字。\n\n具体来说，使用以下定义：\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) \\;=\\; \\min_{\\eta \\in \\mathbb{R}} \\left[\\, \\eta \\;+\\; \\frac{1}{1-\\alpha}\\cdot \\frac{1}{n}\\sum_{i=1}^{n} (L_i - \\eta)^{+} \\,\\right],\n$$\n其中 $(x)^{+}=\\max\\{x,0\\}$。",
            "solution": "问题经过验证。\n\n### 步骤1：提取已知条件\n- $n=10$ 个情景损失 $L_i$ 的样本，单位为百万美元：$L_1=42.3, L_2=45.1, L_3=39.8, L_4=50.0, L_5=47.6, L_6=41.2, L_7=49.4, L_8=46.8, L_9=52.7, L_{10}=44.0$。\n- CVaR 的置信水平为 $\\alpha=0.95$。\n- 条件风险价值 (CVaR) 的样本平均近似 (SAA) 的定义由以下最小化问题给出：\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) \\;=\\; \\min_{\\eta \\in \\mathbb{R}} F(\\eta)\n$$\n其中目标函数为\n$$\nF(\\eta) \\;=\\; \\eta \\;+\\; \\frac{1}{(1-\\alpha)n}\\sum_{i=1}^{n} (L_i - \\eta)^{+}\n$$\n且 $(x)^{+}$ 是正部算子，定义为 $(x)^{+} = \\max\\{x,0\\}$。\n- 最终答案要求四舍五入到四位有效数字。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学依据**：问题有效。所提供的 CVaR 公式是 Rockafellar 和 Uryasev (2000) 提出的一个标准且公认的定义，它将 CVaR 表示为一个凸优化问题的最优值。此公式在金融、运筹学和能源系统的风险管理中被广泛使用。\n- **良态问题**：该问题是良态的。目标函数 $F(\\eta)$ 是一个线性函数 ($\\eta$) 和一组凸分段线性函数 ($\\frac{1}{(1-\\alpha)n}(L_i - \\eta)^{+}$) 的和。由于凸函数之和仍为凸函数，所以 $F(\\eta)$ 是凸的。可以保证该函数在 $\\mathbb{R}$ 上存在最小值。\n- **客观与完整**：问题是客观的，提供了所有必要的数值数据（$L_i, n, \\alpha$）和一个精确的数学定义。它内容完整且无歧义。\n\n### 步骤3：结论与行动\n问题被认为是有效的。将提供解答。\n\n### 解题步骤\n问题要求根据给定的 $n=10$ 个损失样本，计算置信水平 $\\alpha=0.95$ 下的条件风险价值 (CVaR)。我们使用所提供的定义，该定义将 CVaR 构建为一个优化问题的解。SAA-CVaR 是以下函数的最小值：\n$$\nF(\\eta) \\;=\\; \\eta \\;+\\; \\frac{1}{(1-\\alpha)n}\\sum_{i=1}^{n} \\max\\{L_i - \\eta, 0\\}\n$$\n函数 $F(\\eta)$ 是凸函数且是分段线性的。凸函数的最小值在其梯度（对于不可微点，则为其“次梯度”）为零的点处找到。函数 $F(\\eta)$ 在 $\\eta = L_i$ 的点上是不可微的。\n\n我们来求 $F(\\eta)$ 的次梯度。正部函数 $(c-z)^+$ 关于 $z$ 的次梯度为：如果 $z  c$，则为 $\\{-1\\}$；如果 $z = c$，则为 $[ -1, 0 ]$；如果 $z > c$，则为 $\\{0\\}$。因此，$F(\\eta)$ 关于 $\\eta$ 的次梯度是：\n$$\n\\partial F(\\eta) \\;=\\; 1 \\;-\\; \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n} \\mathbb{I}(L_i > \\eta) \\;-\\; \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n, L_i=\\eta} [0, 1]\n$$\n其中 $\\mathbb{I}(\\cdot)$ 是指示函数。最小化器 $\\eta^*$ 是一个使 $0 \\in \\partial F(\\eta^*)$ 的 $\\eta$ 值。\n\n为了分析这个条件，我们首先将损失样本按非递减顺序排序，记为 $L_{(1)} \\le L_{(2)} \\le \\dots \\le L_{(n)}$。给定的损失数据是：\n$42.3, 45.1, 39.8, 50.0, 47.6, 41.2, 49.4, 46.8, 52.7, 44.0$。\n排序这些值得到：\n$L_{(1)} = 39.8$\n$L_{(2)} = 41.2$\n$L_{(3)} = 42.3$\n$L_{(4)} = 44.0$\n$L_{(5)} = 45.1$\n$L_{(6)} = 46.8$\n$L_{(7)} = 47.6$\n$L_{(8)} = 49.4$\n$L_{(9)} = 50.0$\n$L_{(10)} = 52.7$\n\n$F(\\eta)$ 的导数在任意两个连续的已排序损失值之间是恒定的。最优值 $\\eta^*$ 必须是其中一个顺序统计量 $L_{(j)}$。最优的 $\\eta^*$ 对应于样本的 $\\alpha$-风险价值 ($\\operatorname{VaR}_{\\alpha}$)。样本 VaR 的一个标准估计量是第 $j$ 个顺序统计量 $L_{(j)}$，其中 $j = \\lceil n\\alpha \\rceil$。\n\n对于本问题，我们有 $n=10$ 和 $\\alpha=0.95$。我们计算索引 $j$：\n$$\nj = \\lceil n\\alpha \\rceil = \\lceil 10 \\times 0.95 \\rceil = \\lceil 9.5 \\rceil = 10\n$$\n因此，松弛变量 $\\eta$ 的最优值是第10个顺序统计量：\n$$\n\\eta^* = L_{(10)} = 52.7\n$$\n这个值 $\\eta^*=52.7$ 是样本 $\\operatorname{VaR}_{0.95}$。\n\n现在，我们将 $\\eta^*$ 代入目标函数 $F(\\eta)$ 来计算 CVaR：\n$$\n\\operatorname{CVaR}_{\\alpha}^{\\mathrm{SAA}}(L) = F(\\eta^*) = \\eta^* + \\frac{1}{(1-\\alpha)n} \\sum_{i=1}^{n} (L_i - \\eta^*)^{+}\n$$\n代入数值 $\\eta^*=52.7$, $n=10$ 和 $\\alpha=0.95$：\n$$\n\\operatorname{CVaR}_{0.95}^{\\mathrm{SAA}}(L) = 52.7 + \\frac{1}{(1-0.95) \\times 10} \\sum_{i=1}^{10} (L_i - 52.7)^{+}\n$$\n求和项需要对每个损失 $L_i$ 计算 $(L_i - 52.7)^{+}$。项 $(x)^+ = \\max\\{x,0\\}$ 仅在 $x > 0$ 时才非零。在我们的情况下，这意味着我们只需要考虑那些满足 $L_i > 52.7$ 的损失 $L_i$。\n通过检查已排序的损失列表，最大损失为 $L_{(10)} = 52.7$。没有严格大于 $52.7$ 的损失 $L_i$。对于样本中的每个损失 $L_i$，不等式 $L_i \\le 52.7$ 均成立。\n因此，对于所有的 $i=1, \\dots, 10$，我们有 $L_i - 52.7 \\le 0$。这意味着：\n$$\n(L_i - 52.7)^{+} = \\max\\{L_i - 52.7, 0\\} = 0 \\quad \\forall i \\in \\{1, \\dots, 10\\}\n$$\n因此，总和为零：\n$$\n\\sum_{i=1}^{10} (L_i - 52.7)^{+} = 0\n$$\n将此结果代回 CVaR 的表达式中：\n$$\n\\operatorname{CVaR}_{0.95}^{\\mathrm{SAA}}(L) = 52.7 + \\frac{1}{0.05 \\times 10} \\times 0 = 52.7 + \\frac{1}{0.5} \\times 0 = 52.7\n$$\n计算出的 CVaR 值为 $52.7$ 百万美元。问题要求答案四舍五入到四位有效数字。这得到 $52.70$。",
            "answer": "$$\\boxed{52.70}$$"
        },
        {
            "introduction": "掌握了CVaR的计算方法后，下一步是将其作为决策工具，在不确定性下指导能源系统的规划。这个综合性练习要求您构建并求解一个完整的容量扩张线性规划模型，其中CVaR被整合到目标函数中。通过为不同的风险厌恶水平 $\\alpha$ 求解模型 ()，您将亲身体验风险偏好如何具体地转化为对发电容量的投资决策，从而在成本和系统韧性之间做出权衡。",
            "id": "4080122",
            "problem": "提出了一个不确定性下的能源容量规划问题，该问题使用条件风险价值 (CVaR) 作为风险规避目标。规划者必须为可靠可调度技术（如天然气）和可变可再生能源技术（如风能）分别选择非负容量 $K_g$ 和 $K_r$，以在一组有限的等概率情景下，最小化投资成本与运营成本的 CVaR 度量之和。对于集合 $\\{1,\\dots,S\\}$ 中的每个情景 $s$，不确定的需求为 $D_s$，可再生能源可用率因子为 $a_s$，因此情景 $s$ 中的最大可再生能源发电量为 $a_s K_r$。每个情景的调度决策包括可靠发电量 $g_s$、可再生能源发电量 $r_s$ 和未满足的需求量（甩负荷）$u_s$。单位投资成本为 $c_g^I$ 和 $c_r^I$（货币单位/$\\mathrm{MW}$），可靠发电的运营（可变）成本为 $c_g^O$（货币单位/$\\mathrm{MWh}$），未满足需求的惩罚成本为 $p$（货币单位/$\\mathrm{MWh}$）。假设一个单一的代表性小时，因此在整个时间范围内能量和功率单位在数值上一致，所有容量结果均以 $\\mathrm{MW}$ 表示。\n\n该模型采用 Rockafellar–Uryasev 表示法来处理置信水平为 $ \\alpha \\in (0,1) $ 的条件风险价值 (CVaR)，引入了辅助变量 $ \\eta \\ge 0 $ 和满足 $ \\xi_s \\ge c_g^O g_s + p u_s - \\eta $ 的各情景非负松弛变量 $ \\xi_s \\ge 0 $。目标是在各情景概率相等（为 $ 1/S $）的情况下，最小化投资成本加上运营成本的 CVaR：\n$$\n\\min_{K_g, K_r, \\eta, \\{g_s,r_s,u_s,\\xi_s\\}_{s=1}^S} \\; c_g^I K_g + c_r^I K_r + \\eta + \\frac{1}{(1-\\alpha) S}\\sum_{s=1}^S \\xi_s,\n$$\n在每个情景 $ s $ 中需满足以下线性运营约束：\n- 可再生能源调度受可用性和容量限制：$ 0 \\le r_s \\le a_s K_r $。\n- 可靠发电调度受容量限制：$ 0 \\le g_s \\le K_g $。\n- 相对于需求无超额发电：$ g_s + r_s \\le D_s $。\n- 允许未满足需求的供需平衡：$ g_s + r_s + u_s \\ge D_s $，其中 $ u_s \\ge 0 $。\n- CVaR 松弛约束：$ \\xi_s \\ge 0 $ 和 $ \\xi_s \\ge c_g^O g_s + p u_s - \\eta $。\n- 容量和 CVaR 水平的非负性：$ K_g \\ge 0 $，$ K_r \\ge 0 $，$ \\eta \\ge 0 $。\n\n这构成了一个线性规划问题，对于任何指定的 $ \\alpha $、参数集和情景数据都是可解的。\n\n你的任务是实现一个程序，针对以下每个参数集（每个参数集构成一个测试用例），在三个 CVaR 置信水平 $ \\alpha = 0.9 $、$ 0.95 $ 和 $ 0.99 $ 下，计算最优容量 $ K_g $ 和 $ K_r $：\n\n- 测试用例1（正常路径，中等惩罚，可变可再生能源）：\n  - $ S = 5 $ 个情景，需求 $ D = [100, 110, 120, 130, 140] $，单位为 $\\mathrm{MW}$。\n  - 可再生能源可用率因子 $ a = [0.6, 0.6, 0.4, 0.2, 0.1] $。\n  - 成本：$ c_g^I = 50 $，$ c_r^I = 70 $，单位为货币单位/$\\mathrm{MW}$；$ c_g^O = 40 $，$ p = 200 $，单位为货币单位/$\\mathrm{MWh}$。\n\n- 测试用例2（边界条件，极高的未满足需求惩罚）：\n  - $ S = 5 $ 个情景，需求 $ D = [100, 150, 200, 250, 300] $，单位为 $\\mathrm{MW}$。\n  - 可再生能源可用率因子 $ a = [0.8, 0.5, 0.4, 0.3, 0.1] $。\n  - 成本：$ c_g^I = 50 $，$ c_r^I = 60 $，单位为货币单位/$\\mathrm{MW}$；$ c_g^O = 30 $，$ p = 1000 $，单位为货币单位/$\\mathrm{MWh}$。\n\n- 测试用例3（边缘情况，更便宜的可再生能源，更高的可靠发电运营成本）：\n  - $ S = 5 $ 个情景，需求 $ D = [80, 90, 100, 110, 120] $，单位为 $\\mathrm{MW}$。\n  - 可再生能源可用率因子 $ a = [0.9, 0.8, 0.7, 0.6, 0.5] $。\n  - 成本：$ c_g^I = 70 $，$ c_r^I = 40 $，单位为货币单位/$\\mathrm{MW}$；$ c_g^O = 50 $，$ p = 400 $，单位为货币单位/$\\mathrm{MWh}$。\n\n对于每个测试用例，分别在 $ \\alpha = 0.9 $、$ 0.95 $ 和 $ 0.99 $ 下求解该线性规划问题，并记录最优容量 $ K_g(\\alpha) $ 和 $ K_r(\\alpha) $（单位：$\\mathrm{MW}$）。然后，通过计算变化量 $ \\Delta K_g = K_g(0.99) - K_g(0.9) $ 和 $ \\Delta K_r = K_r(0.99) - K_r(0.9) $（单位：$\\mathrm{MW}$）来量化风险规避带来的变化。\n\n最终输出格式：\n- 你的程序应生成单行输出，包含一个由方括号括起来的逗号分隔列表。对于每个测试用例，按以下顺序输出8个值，所有值都以 $\\mathrm{MW}$ 为单位，表示为实数（浮点数）：\n  - $ K_g(0.9) $, $ K_r(0.9) $, $ K_g(0.95) $, $ K_r(0.95) $, $ K_g(0.99) $, $ K_r(0.99) $, $ \\Delta K_g $, $ \\Delta K_r $。\n- 将测试用例1、测试用例2和测试用例3的这8个值连接起来，形成一个包含24个数字的单一扁平列表。\n- 格式示例：$ [x_1,x_2,\\dots,x_{24}] $，其中每个 $ x_i $ 是一个以 $\\mathrm{MW}$ 为单位的浮点数。\n\n本问题不涉及角度。百分比（如风险水平）应作为小数（例如，$0.9$）处理，而不是使用百分号。",
            "solution": "用户提供了一个定义明确的不确定性下的能源容量规划问题，该问题被构建为一个使用条件风险价值（CVaR）作为风险规避目标的线性规划（LP）问题。任务是针对几组参数集和风险水平求解此LP，以确定对可靠（$K_g$）和可再生（$K_r$）发电容量的最优投资。\n\n### 第1步：提取已知条件\n**决策变量：**\n- 可靠和可再生能源发电的非负容量：$K_g \\ge 0$, $K_r \\ge 0$。\n- 每个情景 $s \\in \\{1, \\dots, S\\}$ 的调度决策，包括可靠发电（$g_s$）、可再生能源发电（$r_s$）和未满足的需求（$u_s$）。\n- CVaR辅助变量：$\\eta \\ge 0$ 和每个情景 $s$ 的非负松弛变量 $\\xi_s \\ge 0$。\n\n**参数：**\n- 情景数量：$S$。\n- 依赖于情景的需求：$D_s$。\n- 依赖于情景的可再生能源可用率因子：$a_s$。\n- 单位投资成本：$c_g^I$, $c_r^I$。\n- 可靠发电运营成本：$c_g^O$。\n- 未满足需求的惩罚成本：$p$。\n- CVaR置信水平：$\\alpha \\in (0,1)$。\n\n**目标函数（最小化）：**\n$$\nc_g^I K_g + c_r^I K_r + \\eta + \\frac{1}{(1-\\alpha) S}\\sum_{s=1}^S \\xi_s\n$$\n\n**约束条件（针对每个情景 $s \\in \\{1, \\dots, S\\}$）：**\n1.  $0 \\le r_s \\le a_s K_r$\n2.  $0 \\le g_s \\le K_g$\n3.  $g_s + r_s \\le D_s$\n4.  $g_s + r_s + u_s \\ge D_s$\n5.  $u_s \\ge 0$\n6.  $\\xi_s \\ge 0$\n7.  $\\xi_s \\ge c_g^O g_s + p u_s - \\eta$\n8.  $K_g \\ge 0, K_r \\ge 0, \\eta \\ge 0$ (已在变量定义中说明)\n\n**测试用例与任务：**\n- 提供了三个测试用例，包含 $S$、$D_s$、$a_s$ 和成本的具体数值。\n- 对于每个测试用例，必须针对 $\\alpha = 0.9, 0.95, 0.99$ 求解模型。\n- 主要输出是最优容量 $K_g(\\alpha)$ 和 $K_r(\\alpha)$。\n- 最终要求的值是每个 $\\alpha$ 对应的容量以及差值 $\\Delta K_g = K_g(0.99) - K_g(0.9)$ 和 $\\Delta K_r = K_r(0.99) - K_r(0.9)$。\n\n### 第2步：使用提取的已知条件进行验证\n- **科学依据：** 该问题使用了能源系统规划中处理不确定性决策的标准且被广泛接受的方法（CVaR优化）。该模型虽然简化（例如，单小时），但遵循了基本的物理和经济原则（能量平衡、调度限制、成本结构）。模型构建是正确的。\n- **适定性：** 该问题是一个线性规划（LP）问题。目标函数是线性的，所有约束条件都是线性不等式。鉴于所有成本和变量都是非负的，目标函数有下界（零）。可行解总是存在的（例如，将所有容量和调度设为零，会因未满足需求的惩罚而产生一个有限的目标值）。因此，保证存在最优解。\n- **客观性：** 问题使用精确的数学形式化语言陈述，并提供了明确的数值数据。没有主观或基于观点的成分。\n- **完整性与一致性：** 为每个测试用例提供了所有必需的参数。单位是一致的（功率单位 $\\mathrm{MW}$，能量单位 $\\mathrm{MWh}$，成本单位 货币单位/$\\mathrm{MW}$ 或 货币单位/$\\mathrm{MWh}$），单小时的假设使得功率和能量在数值上等效，这一点已明确指出。约束条件不矛盾。\n\n### 第3步：结论与行动\n该问题有效。它是一个适定、科学合理且完整定义的线性规划任务。可以构建并实施解决方案。\n\n### 基于原则的设计与求解\n这个问题的核心是找到一个最优的投资策略，以平衡前期投资成本和未来的运营风险。风险由运营成本的 CVaR 来度量。\n\n**1. CVaR 及其线性表示：**\n条件风险价值 (CVaR)，也称为预期短缺，量化了超过某个阈值（风险价值，VaR）的成本的期望值。对于给定的置信水平 $\\alpha$，CVaR$_\\alpha$ 代表了最差 $(1-\\alpha)\\%$ 结果的平均值。更高的 $\\alpha$ 表示更强的风险规避，因为规划者更关注成本分布中一个更小、更极端的尾部情景。\n\n该问题使用了 Rockafellar-Uryasev 表示法，这使得 CVaR 优化能在线性规划框架内进行。情景 $s$ 中的运营成本为 $C_s = c_g^O g_s + p u_s$。该成本的 CVaR 表示为：\n$$\n\\text{CVaR}_\\alpha(\\{C_s\\}) = \\min_{\\eta} \\left( \\eta + \\frac{1}{(1-\\alpha) S} \\sum_{s=1}^S \\max(0, C_s - \\eta) \\right)\n$$\n通过引入非负松弛变量 $\\xi_s \\ge \\max(0, C_s - \\eta)$，这个最小化问题可以直接整合到主问题中。约束条件 $\\xi_s \\ge 0$ 和 $\\xi_s \\ge C_s - \\eta$ 将 $\\max$ 算子线性化，从而得到问题描述中给出的LP结构。在最优解中，变量 $\\eta$ 可以解释为风险价值（VaR）。\n\n**2. 构建线性规划：**\n为了使用像 `scipy.optimize.linprog` 这样的标准LP求解器来解决这个问题，我们必须将其表示为标准形式 $\\min_{\\mathbf{x}} \\mathbf{c}^T \\mathbf{x}$，约束条件为 $A_{ub} \\mathbf{x} \\le \\mathbf{b}_{ub}$ 和变量边界。\n\n**决策变量向量 ($\\mathbf{x}$):** 决策变量被排成一个单一的向量。对于 $S$ 个情景，共有 $3 + 4S$ 个变量。我们将向量 $\\mathbf{x}$ 定义为：\n$$\n\\mathbf{x} = [K_g, K_r, \\eta, g_0, \\dots, g_{S-1}, r_0, \\dots, r_{S-1}, u_0, \\dots, u_{S-1}, \\xi_0, \\dots, \\xi_{S-1}]^T\n$$\n注意，为与编程习惯保持一致，情景使用了从0开始的索引（$s=0, \\dots, S-1$）。\n\n**成本向量 ($\\mathbf{c}$):** 成本向量 $\\mathbf{c}$ 包含目标函数中每个变量的系数：\n$$\n\\mathbf{c}^T = [c_g^I, c_r^I, 1, \\underbrace{0, \\dots, 0}_{S \\text{ 次}}, \\underbrace{0, \\dots, 0}_{S \\text{ 次}}, \\underbrace{0, \\dots, 0}_{S \\text{ 次}}, \\underbrace{\\frac{1}{(1-\\alpha)S}, \\dots, \\frac{1}{(1-\\alpha)S}}_{S \\text{ 次}}]\n$$\n\n**约束矩阵 ($A_{ub}$) 与向量 ($\\mathbf{b}_{ub}$):**\n问题约束被转换为一个线性不等式系统 $A_{ub} \\mathbf{x} \\le \\mathbf{b}_{ub}$。总共有 $5S$ 个这样的约束。\n\n- 对于每个情景 $s \\in \\{0, \\dots, S-1\\}$：\n    1.  $r_s - a_s K_r \\le 0$\n    2.  $g_s - K_g \\le 0$\n    3.  $g_s + r_s \\le D_s$\n    4.  $-g_s - r_s - u_s \\le -D_s$\n    5.  $c_g^O g_s + p u_s - \\eta - \\xi_s \\le 0$\n\n这些不等式被系统地编码到矩阵 $A_{ub}$ 的行和向量 $\\mathbf{b}_{ub}$ 中。所有变量的非负性（$K_g, K_r, \\eta, g_s, r_s, u_s, \\xi_s \\ge 0$）通过求解器的 `bounds` 参数来处理。\n\n**3. 实现与分析：**\n实现一个Python函数，用于为任何给定的参数集以编程方式构建这些矩阵和向量，并使用 `scipy.optimize.linprog` 求解得到的LP。对三个测试用例中的每一个，以及每个用例中的三个指定 $\\alpha$ 水平（$0.9, 0.95, 0.99$），执行此函数。\n\n从求解器的解向量中提取 $K_g$ 和 $K_r$ 的最优值。然后计算在风险规避程度最低（$\\alpha=0.9$）和最高（$\\alpha=0.99$）的设置之间，这些容量的变化。增加 $\\alpha$ 会迫使模型对冲高成本、低概率的事件，这通常会驱动投资于更多容量，以减少对昂贵的可靠发电或灾难性的甩负荷的依赖。$\\Delta K_g$ 和 $\\Delta K_r$ 的符号和大小揭示了随着风险规避程度的增加，最优投资策略如何转变。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve_cvar_lp(params, alpha):\n    \"\"\"\n    Sets up and solves the CVaR capacity expansion linear program.\n\n    Args:\n        params (tuple): A tuple containing the parameters for a test case.\n        alpha (float): The CVaR confidence level.\n\n    Returns:\n        tuple: A tuple containing the optimal capacities (K_g, K_r).\n    \"\"\"\n    S, D, a, c_g_I, c_r_I, c_g_O, p = params\n    \n    # --- Define dimensions of the LP ---\n    # Variables: K_g, K_r, eta, g_s[S], r_s[S], u_s[S], xi_s[S]\n    num_vars = 3 + 4 * S\n    \n    # Constraints: 5 types of constraints, each for S scenarios\n    num_cons = 5 * S\n\n    # --- Cost vector c ---\n    c = np.zeros(num_vars)\n    c[0] = c_g_I  # K_g\n    c[1] = c_r_I  # K_r\n    c[2] = 1      # eta\n    # g_s, r_s, u_s have zero cost in the objective\n    # Coefficients for xi_s\n    xi_coeff = 1 / ((1 - alpha) * S)\n    c[3 + 3 * S:] = xi_coeff\n    \n    # --- Constraint matrices A_ub and b_ub ---\n    A_ub = np.zeros((num_cons, num_vars))\n    b_ub = np.zeros(num_cons)\n    \n    row_idx = 0\n    for s in range(S):\n        # Constraint 1: r_s = a_s * K_r\n        A_ub[row_idx, 1] = -a[s]            # Coeff for K_r\n        A_ub[row_idx, 3 + S + s] = 1        # Coeff for r_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n        \n        # Constraint 2: g_s = K_g\n        A_ub[row_idx, 0] = -1               # Coeff for K_g\n        A_ub[row_idx, 3 + s] = 1            # Coeff for g_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n\n        # Constraint 3: g_s + r_s = D_s\n        A_ub[row_idx, 3 + s] = 1            # Coeff for g_s\n        A_ub[row_idx, 3 + S + s] = 1        # Coeff for r_s\n        b_ub[row_idx] = D[s]\n        row_idx += 1\n        \n        # Constraint 4: g_s + r_s + u_s >= D_s  (or -g_s - r_s - u_s = -D_s)\n        A_ub[row_idx, 3 + s] = -1           # Coeff for g_s\n        A_ub[row_idx, 3 + S + s] = -1       # Coeff for r_s\n        A_ub[row_idx, 3 + 2 * S + s] = -1   # Coeff for u_s\n        b_ub[row_idx] = -D[s]\n        row_idx += 1\n        \n        # Constraint 5: xi_s >= c_g_O*g_s + p*u_s - eta  (or c_g_O*g_s + p*u_s - eta - xi_s = 0)\n        A_ub[row_idx, 2] = -1               # Coeff for eta\n        A_ub[row_idx, 3 + s] = c_g_O        # Coeff for g_s\n        A_ub[row_idx, 3 + 2 * S + s] = p    # Coeff for u_s\n        A_ub[row_idx, 3 + 3 * S + s] = -1   # Coeff for xi_s\n        b_ub[row_idx] = 0\n        row_idx += 1\n\n    # --- Bounds ---\n    # All variables are non-negative\n    bounds = (0, None)\n\n    # --- Solve the LP ---\n    res = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')\n    \n    if not res.success:\n        raise RuntimeError(f\"LP solver failed for alpha={alpha} with message: {res.message}\")\n\n    K_g_opt = res.x[0]\n    K_r_opt = res.x[1]\n    \n    return K_g_opt, K_r_opt\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1: happy path, moderate penalty, variable renewables\n        (\n            5,                                     # S\n            np.array([100, 110, 120, 130, 140]),  # D\n            np.array([0.6, 0.6, 0.4, 0.2, 0.1]),  # a\n            50, 70, 40, 200                        # c_g_I, c_r_I, c_g_O, p\n        ),\n        # Test Case 2: boundary condition, very high penalty for unmet demand\n        (\n            5,                                     # S\n            np.array([100, 150, 200, 250, 300]),  # D\n            np.array([0.8, 0.5, 0.4, 0.3, 0.1]),  # a\n            50, 60, 30, 1000                       # c_g_I, c_r_I, c_g_O, p\n        ),\n        # Test Case 3: edge case, cheaper renewables, higher firm operating cost\n        (\n            5,                                     # S\n            np.array([80, 90, 100, 110, 120]),    # D\n            np.array([0.9, 0.8, 0.7, 0.6, 0.5]),  # a\n            70, 40, 50, 400                        # c_g_I, c_r_I, c_g_O, p\n        )\n    ]\n\n    alphas = [0.9, 0.95, 0.99]\n    final_results = []\n\n    for case in test_cases:\n        results_for_case = {}\n        for alpha in alphas:\n            K_g, K_r = solve_cvar_lp(case, alpha)\n            results_for_case[alpha] = (K_g, K_r)\n        \n        K_g_90, K_r_90 = results_for_case[0.90]\n        K_g_95, K_r_95 = results_for_case[0.95]\n        K_g_99, K_r_99 = results_for_case[0.99]\n\n        delta_K_g = K_g_99 - K_g_90\n        delta_K_r = K_r_99 - K_r_90\n        \n        case_output = [\n            K_g_90, K_r_90,\n            K_g_95, K_r_95,\n            K_g_99, K_r_99,\n            delta_K_g, delta_K_r\n        ]\n        final_results.extend(case_output)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, final_results))}]\")\n\nsolve()\n```"
        }
    ]
}