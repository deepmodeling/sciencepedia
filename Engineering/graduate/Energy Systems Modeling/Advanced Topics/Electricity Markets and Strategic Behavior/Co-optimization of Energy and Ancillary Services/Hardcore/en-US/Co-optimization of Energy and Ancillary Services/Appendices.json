{
    "hands_on_practices": [
        {
            "introduction": "Before building complex optimization models, it is crucial to grasp the economic principles that necessitate co-optimization. This exercise explores a classic scenario where a generator's physical constraints and the system's need for ancillary services lead to a situation where marginal prices for energy and reserves alone do not cover the unit's total costs . By calculating the required 'uplift' payment, you will gain a tangible understanding of the 'missing money' problem and see why integrated market clearing is essential for ensuring resource adequacy.",
            "id": "4078317",
            "problem": "Consider a single-period, single-bus co-optimization of energy and spinning reserve in an electric power system. The system operator must meet a fixed energy demand and a spinning reserve requirement simultaneously. The system comprises two resources:\n\n1. A wind unit with variable energy cost $c_{W} = 0$ dollars per megawatt-hour, maximum available power $P_{W}^{\\max} = 100$ megawatts, and no capability to provide spinning reserve.\n\n2. A thermal unit with variable energy cost $c_{T} = 40$ dollars per megawatt-hour, minimum stable output $P_{T}^{\\min} = 15$ megawatts, maximum output $P_{T}^{\\max} = 75$ megawatts, and upward spinning reserve capability limited by $R_{T} \\leq P_{T}^{\\max} - P_{T}$. The thermal unit has a no-load cost $F = 600$ dollars per hour and a startup cost $S = 900$ dollars per start. Assume the thermal unit starts from the offline state.\n\nLet the energy demand be $D = 100$ megawatts and the spinning reserve requirement be $R^{\\mathrm{req}} = 30$ megawatts. Assume there is no separate marginal cost for providing reserve beyond the opportunity cost implied by headroom constraints.\n\nWork from first principles of least-cost dispatch and co-optimization: model the primal problem as minimizing total production cost subject to energy balance, reserve requirement, and unit capability constraints (including minimum output and reserve capability), and define prices as Lagrange multipliers of the corresponding constraints in the convex relaxation conditional on commitment.\n\nUnder standard marginal pricing, the system pays energy at the Locational Marginal Price (LMP) and reserve at the Spinning Reserve Clearing Price (SRCP). Define uplift as the minimal nonnegative payment required to ensure that the thermal unit’s net profit over the settlement interval equals zero if its market revenues (energy plus reserve) under marginal prices do not cover its realized costs (variable energy cost, no-load cost, and startup cost).\n\nConstruct and analyze the co-optimized dispatch to show a case in which the spinning reserve requirement drives commitment of the thermal unit even though the energy LMP is below its marginal energy cost. Derive the LMP and SRCP from the Lagrangian duals of the energy balance and reserve requirement, respectively, and compute the required uplift for the thermal unit over the one-hour settlement interval. Express the final uplift in dollars. No rounding instruction is necessary; provide the exact value.",
            "solution": "The problem will be validated against the specified criteria before a solution is attempted.\n\n### Step 1: Extract Givens\n-   Wind unit variable cost: $c_{W} = 0$ dollars per megawatt-hour\n-   Wind unit maximum power: $P_{W}^{\\max} = 100$ megawatts\n-   Wind unit reserve capability: $0$\n-   Thermal unit variable cost: $c_{T} = 40$ dollars per megawatt-hour\n-   Thermal unit minimum stable output: $P_{T}^{\\min} = 15$ megawatts\n-   Thermal unit maximum output: $P_{T}^{\\max} = 75$ megawatts\n-   Thermal unit upward spinning reserve capability: $R_{T} \\leq P_{T}^{\\max} - P_{T}$\n-   Thermal unit no-load cost: $F = 600$ dollars per hour\n-   Thermal unit startup cost: $S = 900$ dollars per start (from offline state)\n-   Energy demand: $D = 100$ megawatts\n-   Spinning reserve requirement: $R^{\\mathrm{req}} = 30$ megawatts\n-   Settlement interval: $1$ hour\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It is a standard, albeit simplified, unit commitment and economic dispatch problem from the field of power systems engineering and electricity market design. The parameters are self-contained and consistent, and the terminology (LMP, SRCP, uplift) is standard within the domain. The problem does not violate any scientific principles, is not metaphorical, is not incomplete or contradictory, and is not trivial. It presents a classic case illustrating the need for uplift payments in markets with non-convex generator constraints.\n\n### Step 3: Verdict and Action\nThe problem is valid. A solution will be provided.\n\nThe total system cost, which the system operator aims to minimize, is the sum of the costs of the committed units. The costs for the thermal unit include a startup cost, a no-load cost (if committed), and a variable energy cost. The wind unit has only a variable energy cost. Let $u_T \\in \\{0, 1\\}$ be the binary commitment variable for the thermal unit, where $u_T=1$ if the unit is online and $u_T=0$ if it is offline. Let $P_W$ and $P_T$ be the energy dispatched from the wind and thermal units, respectively, and let $R_T$ be the spinning reserve provided by the thermal unit.\n\nThe co-optimization problem can be formulated as a mixed-integer linear program:\n$$\n\\min_{u_T, P_W, P_T, R_T} \\quad C = c_W P_W + c_T P_T + u_T (F + S)\n$$\nSubject to:\n1.  Energy balance: $P_W + P_T = D$\n2.  Reserve requirement: $R_T \\ge R^{\\mathrm{req}}$ (as only the thermal unit provides reserve)\n3.  Wind unit capacity: $0 \\le P_W \\le P_W^{\\max}$\n4.  Thermal unit capacity: $u_T P_T^{\\min} \\le P_T \\le u_T P_T^{\\max}$\n5.  Thermal unit reserve headroom: $P_T + R_T \\le u_T P_T^{\\max}$\n6.  Non-negativity of reserve: $R_T \\ge 0$\n7.  Binary commitment: $u_T \\in \\{0, 1\\}$\n\nSubstituting the given values:\n$$\n\\min_{u_T, P_W, P_T, R_T} \\quad C = (0) P_W + 40 P_T + u_T (600 + 900) = 40 P_T + 1500 u_T\n$$\nSubject to:\n1.  $P_W + P_T = 100$\n2.  $R_T \\ge 30$\n3.  $0 \\le P_W \\le 100$\n4.  $15 u_T \\le P_T \\le 75 u_T$\n5.  $P_T + R_T \\le 75 u_T$\n\nWe solve this by considering the two possible cases for $u_T$.\n\nCase 1: Thermal unit is offline ($u_T = 0$).\nThe constraints become: $P_T = 0$ and $R_T = 0$.\nThe reserve requirement $R_T \\ge 30$ becomes $0 \\ge 30$, which is false.\nThus, this case is infeasible. The thermal unit must be committed to satisfy the spinning reserve requirement.\n\nCase 2: Thermal unit is online ($u_T = 1$).\nThe problem becomes a linear program to find the optimal dispatch:\n$$\n\\min_{P_W, P_T, R_T} \\quad C = 40 P_T + 1500\n$$\nSubject to:\n1.  $P_W + P_T = 100$\n2.  $R_T \\ge 30$\n3.  $0 \\le P_W \\le 100$\n4.  $15 \\le P_T \\le 75$\n5.  $P_T + R_T \\le 75$\n\nTo minimize the cost $C$, we must minimize $P_T$.\nFrom the energy balance, $P_W = 100 - P_T$. Substituting this into the wind capacity constraint gives $0 \\le 100 - P_T \\le 100$, which implies $0 \\le P_T \\le 100$. Combining this with the thermal unit's capacity constraint ($15 \\le P_T \\le 75$), the effective range for $P_T$ is $[15, 75]$.\nThe objective function is minimized at the lowest possible value of $P_T$, which is $P_T^* = 15$ MW.\nLet's check if this dispatch is feasible with the reserve constraints.\nWith $P_T^* = 15$, the reserve headroom constraint is $15 + R_T \\le 75$, which implies $R_T \\le 60$.\nThe system requires $R_T \\ge 30$.\nSince the range $[30, 60]$ is valid for $R_T$, a feasible solution exists. The system operator will procure the minimum required amount, so $R_T^* = 30$ MW.\nThe corresponding wind dispatch is $P_W^* = 100 - P_T^* = 100 - 15 = 85$ MW. This is within the wind unit's capacity.\n\nThe optimal dispatch is: $P_T^* = 15$ MW, $P_W^* = 85$ MW, and $R_T^* = 30$ MW.\nThis dispatch demonstrates that the thermal unit is committed ($u_T=1$) due to the reserve requirement, even though there is enough cheaper wind capacity to meet the entire energy demand.\nThe total system cost is $C^* = 40(15) + 1500 = 600 + 1500 = 2100$ dollars.\n\nNext, we derive the market clearing prices, LMP and SRCP, from the dual of the relaxed linear program (with $u_T=1$). The variable-cost portion of the objective function is $40 P_T$.\nLet $\\lambda$ be the Lagrange multiplier for the energy balance constraint (LMP) and $\\mu$ be the multiplier for the reserve requirement constraint (SRCP).\n\nThe Lagrangian for the variable cost minimization is:\n$L = 40 P_T - \\lambda(P_W + P_T - 100) - \\mu(R_T - 30) - \\nu(75 - P_T - R_T) - \\alpha(P_T - 15) - ...$\n(including multipliers for all constraints).\nThe Karush-Kuhn-Tucker (KKT) conditions for optimality include:\n$\\frac{\\partial L}{\\partial P_W} = -\\lambda - \\gamma_W = 0$, where $\\gamma_W$ is the multiplier for wind capacity, which is $0$ as $P_W^* = 85$ is not at its bounds. Thus, $\\lambda=0$.\n$\\frac{\\partial L}{\\partial P_T} = 40 - \\lambda - \\alpha + \\nu = 0$, where $\\alpha$ is for $P_T \\ge 15$ and $\\nu$ is for $P_T+R_T \\le 75$.\n$\\frac{\\partial L}{\\partial R_T} = -\\mu + \\nu = 0 \\implies \\mu = \\nu$.\n\nAt the optimal solution ($P_T^*=15$, $R_T^*=30$):\n-   The energy price is the LMP, $\\lambda$. Since the marginal unit for energy is wind ($c_W=0$) and it has spare capacity ($P_W^*=85 < P_W^{\\max}=100$), the cost of an additional megawatt of energy is zero. Thus, LMP $=\\lambda=0\\$/\\text{MWh}$.\n-   The reserve price is the SRCP, $\\mu$. At the optimum, $P_T^* + R_T^* = 15 + 30 = 45 < 75$. The thermal unit has spare capacity to provide more reserve without reducing its energy output. The constraint $P_T+R_T \\le 75$ is not binding, so its dual variable $\\nu = 0$. Since $\\mu=\\nu$, it follows that SRCP $=\\mu=0\\$/\\text{MWh}$.\n\nThis result, LMP $=0$ and SRCP $=0$, is a consequence of pricing based on the relaxed convex problem, where the non-convex minimum output constraint is a primary driver of the dispatch but its cost is not reflected in the marginal prices.\n\nFinally, we compute the uplift for the thermal unit. Uplift is the payment required to cover costs not recovered through the energy and reserve markets.\nMarket Revenue for the thermal unit:\n$$\n\\text{Revenue} = (\\text{LMP} \\times P_T^*) + (\\text{SRCP} \\times R_T^*) = (\\$0/\\text{MWh} \\times 15 \\text{ MW}) + (\\$0/\\text{MWh} \\times 30 \\text{ MW}) = \\$0\n$$\nThe calculation is for a $1$-hour period.\nTotal Cost for the thermal unit:\n$$\n\\text{Cost} = (\\text{Variable Cost}) + (\\text{No-Load Cost}) + (\\text{Startup Cost})\n$$\n$$\n\\text{Cost} = (c_T \\times P_T^*) + F + S = (40 \\$/\\text{MWh} \\times 15 \\text{ MW}) + \\$600 + \\$900 = \\$600 + \\$600 + \\$900 = \\$2100\n$$\nThe unit's profit from market operations is Revenue - Cost = $\\$0 - \\$2100 = -\\$2100$.\nThe uplift payment must make the net profit zero.\n$$\n\\text{Uplift} = -(\\text{Profit}) = -(-\\$2100) = \\$2100\n$$",
            "answer": "$$\\boxed{2100}$$"
        },
        {
            "introduction": "Having established the economic motivation, we now tackle the system operator's central challenge: scheduling resources under uncertainty. This practice guides you through building and solving a two-stage stochastic program, a powerful technique for decision-making in the face of unpredictable future events like fluctuating net loads . You will determine optimal first-stage energy and reserve commitments that balance known costs against the expected costs of real-time recourse actions, providing a robust hedge against uncertainty.",
            "id": "4078378",
            "problem": "Consider a single-hour stochastic co-optimization of energy and ancillary services for a small system with two conventional generators and two net-load scenarios. The scheduling horizon is $1$ hour, so energy quantities in $\\mathrm{MWh}$ are numerically equal to power quantities in $\\mathrm{MW}$ for this hour. The goal is to decide first-stage day-ahead commitments and upward reserve allocations that minimize expected total cost with real-time recourse. The formulation must satisfy power balance and physical feasibility and incorporate real-time adjustments: upward regulation, downward regulation, and involuntary load shedding.\n\nUse the following fundamental bases:\n- Conservation of energy/power balance: for each scenario, total supply (after real-time adjustments) plus load shedding equals net load.\n- Expected value definition: expected total cost equals the sum over scenarios of scenario probability times scenario cost.\n- Linear marginal cost representations for energy, reserve capacity, and real-time actions.\n\nDecision variables:\n- First-stage variables for each generator $i \\in \\{1,2\\}$: scheduled energy $e_i \\, (\\mathrm{MW})$ and scheduled upward reserve capacity $r_i \\, (\\mathrm{MW})$.\n- Second-stage recourse variables for each scenario $s \\in \\{1,2\\}$ and generator $i \\in \\{1,2\\}$: upward regulation $u_{i}^{(s)} \\, (\\mathrm{MW})$, downward regulation $d_{i}^{(s)} \\, (\\mathrm{MW})$, and scenario load shedding $\\ell^{(s)} \\, (\\mathrm{MW})$.\n\nParameters (all nonnegative and scientifically plausible):\n- Generator capacities $G_i \\, (\\mathrm{MW})$.\n- Marginal energy costs $C_i \\, (\\$/\\mathrm{MWh})$.\n- Upward reserve capacity costs $A_i \\, (\\$/\\mathrm{MW}\\text{-}\\mathrm{h})$.\n- Real-time upward regulation marginal costs $U_i \\, (\\$/\\mathrm{MWh})$.\n- Real-time downward regulation marginal costs $D_i \\, (\\$/\\mathrm{MWh})$.\n- Load-shedding penalty $S \\, (\\$/\\mathrm{MWh})$.\n- Scenario loads $L^{(s)} \\, (\\mathrm{MW})$ for $s \\in \\{1,2\\}$.\n- Scenario probabilities $p^{(s)}$ such that $p^{(1)} + p^{(2)} = 1$.\n\nModel the co-optimization as a Linear Program (LP):\n- Objective: minimize expected total cost\n$$\n\\sum_{i=1}^{2} C_i \\, e_i \\;+\\; \\sum_{i=1}^{2} A_i \\, r_i \\;+\\; \\sum_{s=1}^{2} p^{(s)}\\left(\\sum_{i=1}^{2} U_i \\, u_{i}^{(s)} \\;+\\; \\sum_{i=1}^{2} D_i \\, d_{i}^{(s)} \\;+\\; S \\, \\ell^{(s)}\\right).\n$$\n- Physical feasibility constraints:\n  - For each generator $i$: $0 \\le e_i \\le G_i$, $0 \\le r_i$, and $e_i + r_i \\le G_i$.\n  - For each scenario $s$ and generator $i$: $0 \\le u_{i}^{(s)} \\le r_i$ and $0 \\le d_{i}^{(s)} \\le e_i$.\n  - For each scenario $s$: power balance\n$$\n\\sum_{i=1}^{2} e_i \\;+\\; \\sum_{i=1}^{2} u_{i}^{(s)} \\;-\\; \\sum_{i=1}^{2} d_{i}^{(s)} \\;+\\; \\ell^{(s)} \\;=\\; L^{(s)},\n$$\nwith $\\ell^{(s)} \\ge 0$.\n\nTest suite:\nProvide three parameter sets that probe different facets of the problem. In each case, report the optimal first-stage commitments and reserve allocations $\\left[e_1,e_2,r_1,r_2\\right]$ in $\\mathrm{MW}$.\n\n- Case $1$ (happy path, ample capacity, nontrivial reserve trade-offs):\n  - $G_1 = 80$, $G_2 = 70$.\n  - $C_1 = 10$, $C_2 = 25$.\n  - $A_1 = 2$, $A_2 = 4$.\n  - $U_1 = 15$, $U_2 = 35$.\n  - $D_1 = 1$, $D_2 = 1$.\n  - $S = 1000$.\n  - $L^{(1)} = 90$, $L^{(2)} = 130$.\n  - $p^{(1)} = 0.6$, $p^{(2)} = 0.4$.\n\n- Case $2$ (edge case, insufficient total capacity leads to penalized shedding in the high-load scenario):\n  - $G_1 = 60$, $G_2 = 60$.\n  - $C_1 = 12$, $C_2 = 24$.\n  - $A_1 = 1$, $A_2 = 2$.\n  - $U_1 = 18$, $U_2 = 30$.\n  - $D_1 = 0.5$, $D_2 = 0.5$.\n  - $S = 2000$.\n  - $L^{(1)} = 90$, $L^{(2)} = 130$.\n  - $p^{(1)} = 0.5$, $p^{(2)} = 0.5$.\n\n- Case $3$ (boundary trade-off case, high reserve capacity costs encourage scheduling nearer the higher load and relying on downward regulation):\n  - $G_1 = 80$, $G_2 = 80$.\n  - $C_1 = 12$, $C_2 = 20$.\n  - $A_1 = 20$, $A_2 = 50$.\n  - $U_1 = 18$, $U_2 = 30$.\n  - $D_1 = 1$, $D_2 = 1$.\n  - $S = 1000$.\n  - $L^{(1)} = 95$, $L^{(2)} = 105$.\n  - $p^{(1)} = 0.5$, $p^{(2)} = 0.5$.\n\nRequired output:\n- Express $e_1$, $e_2$, $r_1$, and $r_2$ in $\\mathrm{MW}$ as floating-point numbers rounded to three decimal places.\n- Your program should produce a single line of output containing the results for the three cases as a comma-separated list enclosed in square brackets, with each case reported as its own list. For example, the output format must be\n$$\n\\left[\\left[e_1^{(1)},e_2^{(1)},r_1^{(1)},r_2^{(1)}\\right],\\left[e_1^{(2)},e_2^{(2)},r_1^{(2)},r_2^{(2)}\\right],\\left[e_1^{(3)},e_2^{(3)},r_1^{(3)},r_2^{(3)}\\right]\\right].\n$$",
            "solution": "The user has provided a well-defined problem in the domain of energy systems engineering, specifically the co-optimization of energy and ancillary services under uncertainty. The problem is formulated as a two-stage stochastic linear program for a system with $2$ generators and $2$ scenarios.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n- **Decision Variables (First-Stage):**\n  - $e_i$: Scheduled energy for generator $i \\in \\{1,2\\}$ $(\\mathrm{MW})$.\n  - $r_i$: Scheduled upward reserve capacity for generator $i \\in \\{1,2\\}$ $(\\mathrm{MW})$.\n- **Decision Variables (Second-Stage):**\n  - $u_{i}^{(s)}$: Upward regulation for generator $i$ in scenario $s \\in \\{1,2\\}$ $(\\mathrm{MW})$.\n  - $d_{i}^{(s)}$: Downward regulation for generator $i$ in scenario $s \\in \\{1,2\\}$ $(\\mathrm{MW})$.\n  - $\\ell^{(s)}$: Load shedding in scenario $s \\in \\{1,2\\}$ $(\\mathrm{MW})$.\n- **Parameters:**\n  - $G_i$: Capacity of generator $i$ $(\\mathrm{MW})$.\n  - $C_i$: Marginal energy cost for generator $i$ $(\\$/\\mathrm{MWh})$.\n  - $A_i$: Upward reserve capacity cost for generator $i$ $(\\$/\\mathrm{MW}\\text{-}\\mathrm{h})$.\n  - $U_i$: Upward regulation marginal cost for generator $i$ $(\\$/\\mathrm{MWh})$.\n  - $D_i$: Downward regulation marginal cost for generator $i$ $(\\$/\\mathrm{MWh})$.\n  - $S$: Load shedding penalty $(\\$/\\mathrm{MWh})$.\n  - $L^{(s)}$: Net load in scenario $s$ $(\\mathrm{MW})$.\n  - $p^{(s)}$: Probability of scenario $s$, with $p^{(1)} + p^{(2)} = 1$.\n- **Objective Function:** Minimize expected total cost:\n$$ \\sum_{i=1}^{2} C_i \\, e_i \\;+\\; \\sum_{i=1}^{2} A_i \\, r_i \\;+\\; \\sum_{s=1}^{2} p^{(s)}\\left(\\sum_{i=1}^{2} U_i \\, u_{i}^{(s)} \\;+\\; \\sum_{i=1}^{2} D_i \\, d_{i}^{(s)} \\;+\\; S \\, \\ell^{(s)}\\right) $$\n- **Constraints:**\n  - $0 \\le e_i \\le G_i$ for $i \\in \\{1,2\\}$.\n  - $0 \\le r_i$ for $i \\in \\{1,2\\}$.\n  - $e_i + r_i \\le G_i$ for $i \\in \\{1,2\\}$.\n  - $0 \\le u_{i}^{(s)} \\le r_i$ for $s \\in \\{1,2\\}, i \\in \\{1,2\\}$.\n  - $0 \\le d_{i}^{(s)} \\le e_i$ for $s \\in \\{1,2\\}, i \\in \\{1,2\\}$.\n  - $\\ell^{(s)} \\ge 0$ for $s \\in \\{1,2\\}$.\n  - $\\sum_{i=1}^{2} e_i \\;+\\; \\sum_{i=1}^{2} u_{i}^{(s)} \\;-\\; \\sum_{i=1}^{2} d_{i}^{(s)} \\;+\\; \\ell^{(s)} \\;=\\; L^{(s)}$ for $s \\in \\{1,2\\}$.\n- **Test Cases:** Three distinct sets of parameters are provided.\n\n**Step 2: Validate Using Extracted Givens**\n\n- **Scientifically Grounded:** The problem is a standard, albeit simplified, formulation of a two-stage stochastic unit commitment problem, a cornerstone of modern power systems operations and planning. The concepts of day-ahead energy and reserve scheduling, real-time recourse actions (regulation), load shedding, and their associated costs are fundamental and accurately represented. The model correctly uses expected value minimization and conservation of energy (power balance).\n- **Well-Posed:** The problem is formulated as a Linear Program (LP). Given a non-empty, bounded feasible region (which is ensured by the generator capacity constraints) and a linear objective function, an optimal solution is guaranteed to exist. All terms are clearly defined.\n- **Objective:** The language is precise, mathematical, and free of subjective or ambiguous statements.\n- **Other Criteria:** The problem is self-contained, with all necessary data provided for each test case. The parameters are physically plausible and do not contain internal contradictions. It is a non-trivial optimization problem that requires balancing competing costs across different time stages and scenarios.\n\n**Step 3: Verdict and Action**\n\nThe problem is valid. It is a well-posed, scientifically sound, and objective optimization task. A complete solution will be provided.\n\n### Solution\n\nThe problem is a two-stage stochastic linear program. The first-stage decisions ($e_1, e_2, r_1, r_2$) are made \"here-and-now\" before the realization of the uncertain net load. The second-stage or recourse decisions ($u_i^{(s)}, d_i^{(s)}, \\ell^{(s)}$) are made \"wait-and-see\" for each scenario $s$ to optimally correct any imbalance between the scheduled generation and the realized load. The standard method for solving this problem is to construct its deterministic equivalent, which is a single, large linear program that encompasses all variables and constraints across all scenarios. This is the formulation provided in the problem statement.\n\nWe will solve this LP using standard numerical optimization tooling. The formulation is translated into the canonical form required by a generic LP solver:\n$$\n\\begin{aligned}\n\\text{minimize} \\quad & c^T x \\\\\n\\text{subject to} \\quad & A_{eq} x = b_{eq} \\\\\n& A_{ub} x \\le b_{ub} \\\\\n& l \\le x \\le u\n\\end{aligned}\n$$\nwhere $x$ is the vector of all decision variables.\n\n**1. Decision Variable Vector**\n\nThe decision variables are ordered into a single vector $x \\in \\mathbb{R}^{14}$:\n$$\nx = [e_1, e_2, r_1, r_2, u_1^{(1)}, u_2^{(1)}, d_1^{(1)}, d_2^{(1)}, \\ell^{(1)}, u_1^{(2)}, u_2^{(2)}, d_1^{(2)}, d_2^{(2)}, \\ell^{(2)}]^T\n$$\nThe indices map as follows: $e_1 \\to 0$, $e_2 \\to 1$, $r_1 \\to 2$, $r_2 \\to 3$, $u_1^{(1)} \\to 4$, ..., $\\ell^{(2)} \\to 13$.\n\n**2. Objective Function (Cost Vector $c$)**\n\nThe objective is to minimize the sum of the first-stage costs and the expected second-stage costs. The cost vector $c \\in \\mathbb{R}^{14}$ is constructed directly from the objective function coefficients:\n$$\nc = [C_1, C_2, A_1, A_2, p^{(1)}U_1, p^{(1)}U_2, p^{(1)}D_1, p^{(1)}D_2, p^{(1)}S, p^{(2)}U_1, p^{(2)}U_2, p^{(2)}D_1, p^{(2)}D_2, p^{(2)}S]^T\n$$\n\n**3. Equality Constraints ($A_{eq}, b_{eq}$)**\n\nThe equality constraints enforce the power balance in each of the $2$ scenarios. This results in a matrix $A_{eq} \\in \\mathbb{R}^{2 \\times 14}$ and a vector $b_{eq} \\in \\mathbb{R}^{2}$.\n\n- **Scenario 1 Balance:** $\\sum_{i=1}^{2} e_i + \\sum_{i=1}^{2} u_{i}^{(1)} - \\sum_{i=1}^{2} d_{i}^{(1)} + \\ell^{(1)} = L^{(1)}$\n  This corresponds to the first row of $A_{eq}$, with coefficients of $1$ for $e_1, e_2, u_1^{(1)}, u_2^{(1)}, \\ell^{(1)}$ and $-1$ for $d_1^{(1)}, d_2^{(1)}$.\n- **Scenario 2 Balance:** $\\sum_{i=1}^{2} e_i + \\sum_{i=1}^{2} u_{i}^{(2)} - \\sum_{i=1}^{2} d_{i}^{(2)} + \\ell^{(2)} = L^{(2)}$\n  This corresponds to the second row of $A_{eq}$, with coefficients of $1$ for $e_1, e_2, u_1^{(2)}, u_2^{(2)}, \\ell^{(2)}$ and $-1$ for $d_1^{(2)}, d_2^{(2)}$.\n\nThe right-hand side is $b_{eq} = [L^{(1)}, L^{(2)}]^T$.\n\n**4. Inequality Constraints ($A_{ub}, b_{ub}$)**\n\nThe inequality constraints codify the physical limits of the generators and the coupling between first-stage and second-stage decisions. There are $10$ such constraints, forming a matrix $A_{ub} \\in \\mathbb{R}^{10 \\times 14}$ and a vector $b_{ub} \\in \\mathbb{R}^{10}$.\n\n- **Generator Capacity:** $e_i + r_i \\le G_i$ for $i \\in \\{1,2\\}$. (2 constraints)\n- **Upward Regulation Limit:** $u_{i}^{(s)} \\le r_i \\implies u_{i}^{(s)} - r_i \\le 0$ for $i \\in \\{1,2\\}, s \\in \\{1,2\\}$. (4 constraints)\n- **Downward Regulation Limit:** $d_{i}^{(s)} \\le e_i \\implies d_{i}^{(s)} - e_i \\le 0$ for $i \\in \\{1,2\\}, s \\in \\{1,2\\}$. (4 constraints)\n\nThe right-hand side is $b_{ub} = [G_1, G_2, 0, 0, 0, 0, 0, 0, 0, 0]^T$.\n\n**5. Variable Bounds ($l, u$)**\n\nThe bounds define the domain of each individual variable.\n\n- $0 \\le e_i \\le G_i$ for $i=1,2$.\n- All other variables are non-negative: $r_i \\ge 0$, $u_{i}^{(s)} \\ge 0$, $d_{i}^{(s)} \\ge 0$, $\\ell^{(s)} \\ge 0$.\n\nThis complete LP formulation is constructed and solved for each of the three test cases. The optimal values for the first-stage variables ($e_1, e_2, r_1, r_2$) are extracted from the solution vector $x$. The results demonstrate how the system optimally hedges against load uncertainty based on the relative costs of day-ahead scheduling, reserve procurement, and real-time adjustments.\n\n- **Case 1** has ample capacity. The key trade-off is between procuring reserve from the cheaper generator (G1), which requires reducing its cheap energy output, versus using the more expensive generator (G2) for reserve.\n- **Case 2** is constrained by total system capacity, which is less than the high-load requirement. This forces a deterministic amount of load-shedding in the high-load scenario, simplifying the trade-offs.\n- **Case 3** features very high reserve capacity costs ($A_i$). This creates an economic incentive to minimize procured reserve, potentially by scheduling energy closer to the high-load scenario and relying on cheaper downward regulation in the low-load scenario.\n\nThe implementation will construct these matrices and vectors for each case and use the `scipy.optimize.linprog` function to find the optimal solution.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Solves the stochastic co-optimization problem for three test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Happy path\n        {\n            \"G\": np.array([80.0, 70.0]),\n            \"C\": np.array([10.0, 25.0]),\n            \"A\": np.array([2.0, 4.0]),\n            \"U\": np.array([15.0, 35.0]),\n            \"D\": np.array([1.0, 1.0]),\n            \"S\": 1000.0,\n            \"L\": np.array([90.0, 130.0]),\n            \"p\": np.array([0.6, 0.4]),\n        },\n        # Case 2: Insufficient capacity\n        {\n            \"G\": np.array([60.0, 60.0]),\n            \"C\": np.array([12.0, 24.0]),\n            \"A\": np.array([1.0, 2.0]),\n            \"U\": np.array([18.0, 30.0]),\n            \"D\": np.array([0.5, 0.5]),\n            \"S\": 2000.0,\n            \"L\": np.array([90.0, 130.0]),\n            \"p\": np.array([0.5, 0.5]),\n        },\n        # Case 3: Boundary trade-off\n        {\n            \"G\": np.array([80.0, 80.0]),\n            \"C\": np.array([12.0, 20.0]),\n            \"A\": np.array([20.0, 50.0]),\n            \"U\": np.array([18.0, 30.0]),\n            \"D\": np.array([1.0, 1.0]),\n            \"S\": 1000.0,\n            \"L\": np.array([95.0, 105.0]),\n            \"p\": np.array([0.5, 0.5]),\n        },\n    ]\n\n    all_results = []\n    \n    # Variable mapping to indices in the decision vector x:\n    # x = [e1, e2, r1, r2, u1_1, u2_1, d1_1, d2_1, l_1, u1_2, u2_2, d1_2, d2_2, l_2]\n    # Indices: 0, 1, 2,  3,  4,    5,    6,    7,    8,   9,    10,   11,   12,   13\n\n    for case_params in test_cases:\n        G, C, A, U, D, S, L, p = (\n            case_params[\"G\"],\n            case_params[\"C\"],\n            case_params[\"A\"],\n            case_params[\"U\"],\n            case_params[\"D\"],\n            case_params[\"S\"],\n            case_params[\"L\"],\n            case_params[\"p\"],\n        )\n        G1, G2 = G\n        L1, L2 = L\n        p1, p2 = p\n        C1, C2 = C\n        A1, A2 = A\n        U1, U2 = U\n        D1, D2 = D\n\n        # Objective function vector c (14 variables)\n        c = np.array([\n            C1, C2, A1, A2,          # First-stage costs\n            p1 * U1, p1 * U2, p1 * D1, p1 * D2, p1 * S, # Scenario 1 recourse costs\n            p2 * U1, p2 * U2, p2 * D1, p2 * D2, p2 * S, # Scenario 2 recourse costs\n        ])\n\n        # Equality constraints A_eq * x = b_eq (2 constraints for power balance)\n        A_eq = np.zeros((2, 14))\n        # Scenario 1: e1+e2 + u1_1+u2_1 - d1_1-d2_1 + l_1 = L1\n        A_eq[0, [0, 1, 4, 5, 8]] = 1\n        A_eq[0, [6, 7]] = -1\n        # Scenario 2: e1+e2 + u1_2+u2_2 - d1_2-d2_2 + l_2 = L2\n        A_eq[1, [0, 1, 9, 10, 13]] = 1\n        A_eq[1, [11, 12]] = -1\n        b_eq = np.array([L1, L2])\n\n        # Inequality constraints A_ub * x = b_ub (10 constraints)\n        A_ub = np.zeros((10, 14))\n        # e1 + r1 = G1\n        A_ub[0, [0, 2]] = 1\n        # e2 + r2 = G2\n        A_ub[1, [1, 3]] = 1\n        # u1_1 - r1 = 0\n        A_ub[2, [4, 2]] = [1, -1]\n        # u2_1 - r2 = 0\n        A_ub[3, [5, 3]] = [1, -1]\n        # u1_2 - r1 = 0\n        A_ub[4, [9, 2]] = [1, -1]\n        # u2_2 - r2 = 0\n        A_ub[5, [10, 3]] = [1, -1]\n        # d1_1 - e1 = 0\n        A_ub[6, [6, 0]] = [1, -1]\n        # d2_1 - e2 = 0\n        A_ub[7, [7, 1]] = [1, -1]\n        # d1_2 - e1 = 0\n        A_ub[8, [11, 0]] = [1, -1]\n        # d2_2 - e2 = 0\n        A_ub[9, [12, 1]] = [1, -1]\n        \n        b_ub = np.array([G1, G2, 0, 0, 0, 0, 0, 0, 0, 0])\n\n        # Bounds for each variable\n        bounds = [\n            (0, G1), (0, G2),      # e1, e2\n            (0, None), (0, None), # r1, r2\n            (0, None), (0, None), # u1_1, u2_1\n            (0, None), (0, None), # d1_1, d2_1\n            (0, None),            # l_1\n            (0, None), (0, None), # u1_2, u2_2\n            (0, None), (0, None), # d1_2, d2_2\n            (0, None),            # l_2\n        ]\n\n        # Solve the linear program\n        res = linprog(c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, bounds=bounds, method='highs')\n\n        if res.success:\n            # Extract first-stage variables [e1, e2, r1, r2]\n            e1, e2, r1, r2 = res.x[0:4]\n            # Format to 3 decimal places\n            case_result = [f\"{val:.3f}\" for val in [e1, e2, r1, r2]]\n            all_results.append(f\"[{','.join(case_result)}]\")\n        else:\n            # This should not happen for this well-posed problem\n            all_results.append(\"['error','error','error','error']\")\n    \n    # Final print statement in the exact required format\n    print(f\"[{','.join(all_results)}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "Modern grids with high levels of renewable generation face challenges that extend beyond static capacity; they also require sufficient dynamic *flexibility*. This exercise introduces the critical concept of ramp constraints, where various ancillary services compete for a finite budget of system-wide ramping capability . By modeling this competition, you will learn how co-optimization frameworks are extended to manage the dynamic response characteristics essential for maintaining stability in a rapidly changing power system.",
            "id": "4078373",
            "problem": "Consider a single-node power system co-optimizing procurement of three ancillary services—Flexible Ramping Up, Regulation Up, and Spinning Reserve—over one dispatch interval of fixed duration. The system is represented at an aggregate level, where only total capacity and total ramping capability are modeled. The objective is to minimize total procurement cost while meeting system requirements, subject to joint constraints on capacity headroom and ramp capability.\n\nFundamental definitions:\n- Let $C_{\\text{tot}}$ denote the total available capacity in $\\mathrm{MW}$, and let $D$ denote the fixed energy demand in $\\mathrm{MW}$ during the interval. The capacity headroom available to ancillary services is $H = \\max\\{0, C_{\\text{tot}} - D\\}$, in $\\mathrm{MW}$.\n- Let $R_{\\lim}$ denote the aggregated up-ramp capability of the fleet in $\\mathrm{MW}$ over the dispatch interval, and let $R_{\\text{energy}}$ denote the obligatory up-ramp already committed to follow net load in the same interval, in $\\mathrm{MW}$. The up-ramp budget remaining for ancillary services is $B = \\max\\{0, R_{\\lim} - R_{\\text{energy}}\\}$, in $\\mathrm{MW}$.\n- Three up-type ancillary services are procured: Flexible Ramping Up ($\\mathrm{FR}$), Regulation Up ($\\mathrm{RU}$), and Spinning Reserve ($\\mathrm{SR}$). Each $\\mathrm{MW}$ of service $i \\in \\{\\mathrm{FR}, \\mathrm{RU}, \\mathrm{SR}\\}$ consumes both capacity headroom and ramp budget. Capacity consumption is $1\\,\\mathrm{MW}$ of headroom per $1\\,\\mathrm{MW}$ of service. Ramp consumption is $w_i \\,\\mathrm{MW}$ of ramp per $1\\,\\mathrm{MW}$ of service, where $w_i \\ge 0$ is a given ramp usage coefficient that maps the service’s performance timescale into equivalent up-ramp consumption over the dispatch interval.\n- Let $M_i$ be the minimum procurement requirement for service $i$ in $\\mathrm{MW}$, and let $c_i$ be the offer price in $\\$ / \\mathrm{MW}$. If requirements cannot be fully met due to scarcity, shortfalls are allowed via nonnegative slack variables $s_i \\ge 0$, incurring a large penalty $P_i$ in $\\$ / \\mathrm{MW}$ for unmet requirement.\n\nDecision variables:\n- Procured quantities $q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}} \\ge 0$ in $\\mathrm{MW}$.\n- Shortfalls $s_{\\mathrm{FR}}, s_{\\mathrm{RU}}, s_{\\mathrm{SR}} \\ge 0$ in $\\mathrm{MW}$.\n\nOptimization model:\n- Objective: minimize total cost\n$$\n\\min_{q, s} \\;\\; \\sum_{i \\in \\{\\mathrm{FR},\\mathrm{RU},\\mathrm{SR}\\}} c_i \\, q_i \\;+\\; \\sum_{i \\in \\{\\mathrm{FR},\\mathrm{RU},\\mathrm{SR}\\}} P_i \\, s_i.\n$$\n- Requirement satisfaction:\n$$\nq_i + s_i \\ge M_i \\quad \\text{for } i \\in \\{\\mathrm{FR},\\mathrm{RU},\\mathrm{SR}\\}.\n$$\n- Capacity headroom:\n$$\nq_{\\mathrm{FR}} + q_{\\mathrm{RU}} + q_{\\mathrm{SR}} \\le H.\n$$\n- Ramp budget:\n$$\nw_{\\mathrm{FR}} q_{\\mathrm{FR}} + w_{\\mathrm{RU}} q_{\\mathrm{RU}} + w_{\\mathrm{SR}} q_{\\mathrm{SR}} \\le B.\n$$\n- Nonnegativity:\n$$\nq_i \\ge 0,\\; s_i \\ge 0 \\quad \\text{for } i \\in \\{\\mathrm{FR},\\mathrm{RU},\\mathrm{SR}\\}.\n$$\n\nAll quantities $q_i$ and $s_i$ must be reported in $\\mathrm{MW}$. Report the final allocations $[q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}}]$ for each test case, rounded to three decimals, in $\\mathrm{MW}$.\n\nTest suite:\nProvide the optimal allocations for each of the following four cases. In every case, use the rule $H = \\max\\{0, C_{\\text{tot}} - D\\}$ and $B = \\max\\{0, R_{\\lim} - R_{\\text{energy}}\\}$, both in $\\mathrm{MW}$.\n\n- Case 1 (feasible “happy path”):\n    - $C_{\\text{tot}} = 500$, $D = 450$, $R_{\\lim} = 60$, $R_{\\text{energy}} = 20$.\n    - Ramp coefficients: $w_{\\mathrm{FR}} = 1.0$, $w_{\\mathrm{RU}} = 0.7$, $w_{\\mathrm{SR}} = 0.2$.\n    - Requirements: $M_{\\mathrm{FR}} = 10$, $M_{\\mathrm{RU}} = 20$, $M_{\\mathrm{SR}} = 15$.\n    - Prices: $c_{\\mathrm{FR}} = 5$, $c_{\\mathrm{RU}} = 8$, $c_{\\mathrm{SR}} = 3$ in $\\$ / \\mathrm{MW}$.\n    - Penalties: $P_{\\mathrm{FR}} = 1000$, $P_{\\mathrm{RU}} = 1500$, $P_{\\mathrm{SR}} = 800$ in $\\$ / \\mathrm{MW}$.\n\n- Case 2 (ramp scarcity dominates):\n    - $C_{\\text{tot}} = 500$, $D = 450$, $R_{\\lim} = 40$, $R_{\\text{energy}} = 20$.\n    - Ramp coefficients: $w_{\\mathrm{FR}} = 1.0$, $w_{\\mathrm{RU}} = 0.7$, $w_{\\mathrm{SR}} = 0.2$.\n    - Requirements: $M_{\\mathrm{FR}} = 10$, $M_{\\mathrm{RU}} = 20$, $M_{\\mathrm{SR}} = 15$.\n    - Prices: $c_{\\mathrm{FR}} = 5$, $c_{\\mathrm{RU}} = 8$, $c_{\\mathrm{SR}} = 3$ in $\\$ / \\mathrm{MW}$.\n    - Penalties: $P_{\\mathrm{FR}} = 1000$, $P_{\\mathrm{RU}} = 1500$, $P_{\\mathrm{SR}} = 800$ in $\\$ / \\mathrm{MW}$.\n\n- Case 3 (capacity scarcity dominates):\n    - $C_{\\text{tot}} = 470$, $D = 450$, $R_{\\lim} = 100$, $R_{\\text{energy}} = 10$.\n    - Ramp coefficients: $w_{\\mathrm{FR}} = 1.0$, $w_{\\mathrm{RU}} = 0.7$, $w_{\\mathrm{SR}} = 0.2$.\n    - Requirements: $M_{\\mathrm{FR}} = 12$, $M_{\\mathrm{RU}} = 18$, $M_{\\mathrm{SR}} = 10$.\n    - Prices: $c_{\\mathrm{FR}} = 5$, $c_{\\mathrm{RU}} = 8$, $c_{\\mathrm{SR}} = 3$ in $\\$ / \\mathrm{MW}$.\n    - Penalties: $P_{\\mathrm{FR}} = 1000$, $P_{\\mathrm{RU}} = 1500$, $P_{\\mathrm{SR}} = 800$ in $\\$ / \\mathrm{MW}$.\n\n- Case 4 (edge case with zero ancillary ramp budget and spinning not using ramp):\n    - $C_{\\text{tot}} = 520$, $D = 500$, $R_{\\lim} = 15$, $R_{\\text{energy}} = 15$.\n    - Ramp coefficients: $w_{\\mathrm{FR}} = 1.0$, $w_{\\mathrm{RU}} = 0.5$, $w_{\\mathrm{SR}} = 0.0$.\n    - Requirements: $M_{\\mathrm{FR}} = 10$, $M_{\\mathrm{RU}} = 10$, $M_{\\mathrm{SR}} = 10$.\n    - Prices: $c_{\\mathrm{FR}} = 6$, $c_{\\mathrm{RU}} = 9$, $c_{\\mathrm{SR}} = 2$ in $\\$ / \\mathrm{MW}$.\n    - Penalties: $P_{\\mathrm{FR}} = 1200$, $P_{\\mathrm{RU}} = 2000$, $P_{\\mathrm{SR}} = 600$ in $\\$ / \\mathrm{MW}$.\n\nRequired program output format:\nYour program should produce a single line of output containing a Python-style list of results, one per test case, where each result is the list $[q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}}]$ in $\\mathrm{MW}$, rounded to three decimals. For example: \"[[x11,x12,x13],[x21,x22,x23],[x31,x32,x33],[x41,x42,x43]]\".",
            "solution": "We start from core system definitions that govern feasible co-optimization across energy and ancillary services.\n\nFirst principles:\n- Power balance establishes that, over one dispatch interval, the instantaneous energy demand $D$ in $\\mathrm{MW}$ occupies part of the total capacity $C_{\\text{tot}}$ in $\\mathrm{MW}$. The free capacity headroom available to ancillary services is $H = \\max\\{0, C_{\\text{tot}} - D\\}$ in $\\mathrm{MW}$, since negative headroom physically implies no residual capacity can be reserved for ancillary services.\n- Generator ramp rate aggregates determine the feasible rate of change of net output, often expressed as an increase capability over the dispatch interval, here denoted $R_{\\lim}$ in $\\mathrm{MW}$. A portion of this ramp capability must be committed to follow the net load change in the energy schedule, here treated as an obligatory ramp consumption $R_{\\text{energy}}$ in $\\mathrm{MW}$. Therefore, the ramp budget for ancillary reservations is $B = \\max\\{0, R_{\\lim} - R_{\\text{energy}}\\}$ in $\\mathrm{MW}$.\n- Ancillary reservations consume both capacity headroom and ramp capability. Each $\\mathrm{MW}$ of reservation $q_i$ for service $i$ uses $1\\,\\mathrm{MW}$ of headroom and $w_i\\,\\mathrm{MW}$ of ramp capacity. This captures that services with faster activation timescales require more immediately available ramp to be deliverable.\n\nGiven these fundamentals, the co-optimization across services is a linear program because both the objective and constraints are linear in the decisions. We introduce shortfall variables $s_i \\ge 0$ to ensure feasibility under scarcity, penalizing any unmet requirement by $P_i$ that is deliberately chosen to dominate procurement costs. The optimization seeks to minimize total procurement and shortfall penalties:\n$$\n\\min_{q, s} \\;\\; \\sum_{i} c_i q_i + \\sum_i P_i s_i,\n$$\nsubject to:\n- Requirement satisfaction $q_i + s_i \\ge M_i$ for each $i \\in \\{\\mathrm{FR}, \\mathrm{RU}, \\mathrm{SR}\\}$.\n- Capacity headroom $q_{\\mathrm{FR}} + q_{\\mathrm{RU}} + q_{\\mathrm{SR}} \\le H$.\n- Ramp budget $w_{\\mathrm{FR}} q_{\\mathrm{FR}} + w_{\\mathrm{RU}} q_{\\mathrm{RU}} + w_{\\mathrm{SR}} q_{\\mathrm{SR}} \\le B$.\n- Nonnegativity $q_i \\ge 0, s_i \\ge 0$.\n\nThis model is standard in co-optimization: each ancillary reservation competes for shared headroom and shared ramp capability, with trade-offs guided by marginal procurement costs and large penalties that prioritize requirement satisfaction where feasible.\n\nInterpretation via Lagrangian reasoning:\n- Let $\\lambda_H \\ge 0$ and $\\lambda_B \\ge 0$ be dual variables (shadow prices) for capacity and ramp constraints, respectively. In scarcity, allocating $1\\,\\mathrm{MW}$ to service $i$ incurs an opportunity cost $\\lambda_H \\cdot 1 + \\lambda_B \\cdot w_i$. The optimizer compares this against the penalty savings $P_i$ and procurement cost $c_i$ when moving from shortfall $s_i$ toward meeting $q_i$. Where capacity scarcity dominates ($\\lambda_H$ high and $\\lambda_B$ near zero), the ranking tends to favor the services with highest $(P_i - c_i)$ per $\\mathrm{MW}$ of capacity consumed. Where ramp scarcity dominates ($\\lambda_B$ high), the effective ranking is driven by $(P_i - c_i)/w_i$—penalty savings per unit of ramp consumed—making services with small $w_i$ (such as spinning reserve) attractive under ramp scarcity. The linear program formalizes these trade-offs.\n\nAlgorithmic design:\n- For each test case, compute $H = \\max\\{0, C_{\\text{tot}} - D\\}$ and $B = \\max\\{0, R_{\\lim} - R_{\\text{energy}}\\}$.\n- Formulate the linear program with decision vector\n$$\nx = \\left[q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}}, s_{\\mathrm{FR}}, s_{\\mathrm{RU}}, s_{\\mathrm{SR}}\\right]^\\top.\n$$\n- Objective vector\n$$\n\\mathbf{f} = \\left[c_{\\mathrm{FR}}, c_{\\mathrm{RU}}, c_{\\mathrm{SR}}, P_{\\mathrm{FR}}, P_{\\mathrm{RU}}, P_{\\mathrm{SR}}\\right]^\\top.\n$$\n- Inequality constraints:\n    1. Capacity headroom:\n    $$\n    \\begin{bmatrix}\n    1  1  1  0  0  0\n    \\end{bmatrix} x \\le H.\n    $$\n    2. Ramp budget:\n    $$\n    \\begin{bmatrix}\n    w_{\\mathrm{FR}}  w_{\\mathrm{RU}}  w_{\\mathrm{SR}}  0  0  0\n    \\end{bmatrix} x \\le B.\n    $$\n    3. Requirement satisfaction per service as $-q_i - s_i \\le -M_i$:\n    $$\n    \\begin{bmatrix}\n    -1  0  0  -1  0  0\\\\\n    0  -1  0  0  -1  0\\\\\n    0  0  -1  0  0  -1\n    \\end{bmatrix} x \\le\n    \\begin{bmatrix}\n    -M_{\\mathrm{FR}}\\\\ -M_{\\mathrm{RU}}\\\\ -M_{\\mathrm{SR}}\n    \\end{bmatrix}.\n    $$\n- Bounds: $x \\ge 0$.\n\nSolving with a linear programming solver yields the optimal allocations and shortfalls. We report only the allocations $[q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}}]$ per the problem requirement.\n\nQualitative expectations for the test suite:\n- Case 1: Both headroom and ramp are sufficient, so all requirements are met exactly, yielding $[q_{\\mathrm{FR}}, q_{\\mathrm{RU}}, q_{\\mathrm{SR}}] = [10, 20, 15]$.\n- Case 2: Ramp scarcity binds; with $B = 20$ and ramp consumption needs $10 \\cdot 1.0 + 20 \\cdot 0.7 + 15 \\cdot 0.2 = 27$, the model prioritizes services with larger penalty per unit ramp. Spinning reserve (small $w_{\\mathrm{SR}}$) and regulation are favored, resulting in full procurement of $\\mathrm{RU}$ and $\\mathrm{SR}$ and curtailed $\\mathrm{FR}$ to meet the ramp budget, approximately $[3, 20, 15]$.\n- Case 3: Capacity scarcity binds with $H = 20$ and ample ramp. The optimizer allocates capacity to the highest $(P_i - c_i)$ first, thus filling regulation up to requirement, then allocating remaining headroom to flexible ramping, leaving spinning reserve short, approximately $[2, 18, 0]$.\n- Case 4: Zero ancillary ramp budget $B=0$ and $w_{\\mathrm{SR}} = 0$ means only spinning reserve can be procured; capacity headroom allows satisfying spinning reserve’s requirement fully, resulting in $[0, 0, 10]$.\n\nThe program will implement this linear program using a standard solver and output the allocations for each test case as a single-line list of lists, with values in $\\mathrm{MW}$ rounded to three decimals.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    # Define test cases according to the problem statement.\n    # Each case is a dictionary of parameters.\n    test_cases = [\n        # Case 1: Feasible “happy path”\n        {\n            \"C_tot\": 500.0, \"D\": 450.0, \"R_lim\": 60.0, \"R_energy\": 20.0,\n            \"w\": {\"FR\": 1.0, \"RU\": 0.7, \"SR\": 0.2},\n            \"M\": {\"FR\": 10.0, \"RU\": 20.0, \"SR\": 15.0},\n            \"c\": {\"FR\": 5.0,  \"RU\": 8.0,  \"SR\": 3.0},\n            \"P\": {\"FR\": 1000.0, \"RU\": 1500.0, \"SR\": 800.0},\n        },\n        # Case 2: Ramp scarcity dominates\n        {\n            \"C_tot\": 500.0, \"D\": 450.0, \"R_lim\": 40.0, \"R_energy\": 20.0,\n            \"w\": {\"FR\": 1.0, \"RU\": 0.7, \"SR\": 0.2},\n            \"M\": {\"FR\": 10.0, \"RU\": 20.0, \"SR\": 15.0},\n            \"c\": {\"FR\": 5.0,  \"RU\": 8.0,  \"SR\": 3.0},\n            \"P\": {\"FR\": 1000.0, \"RU\": 1500.0, \"SR\": 800.0},\n        },\n        # Case 3: Capacity scarcity dominates\n        {\n            \"C_tot\": 470.0, \"D\": 450.0, \"R_lim\": 100.0, \"R_energy\": 10.0,\n            \"w\": {\"FR\": 1.0, \"RU\": 0.7, \"SR\": 0.2},\n            \"M\": {\"FR\": 12.0, \"RU\": 18.0, \"SR\": 10.0},\n            \"c\": {\"FR\": 5.0,  \"RU\": 8.0,  \"SR\": 3.0},\n            \"P\": {\"FR\": 1000.0, \"RU\": 1500.0, \"SR\": 800.0},\n        },\n        # Case 4: Zero ancillary ramp budget; spinning doesn't use ramp\n        {\n            \"C_tot\": 520.0, \"D\": 500.0, \"R_lim\": 15.0, \"R_energy\": 15.0,\n            \"w\": {\"FR\": 1.0, \"RU\": 0.5, \"SR\": 0.0},\n            \"M\": {\"FR\": 10.0, \"RU\": 10.0, \"SR\": 10.0},\n            \"c\": {\"FR\": 6.0,  \"RU\": 9.0,  \"SR\": 2.0},\n            \"P\": {\"FR\": 1200.0, \"RU\": 2000.0, \"SR\": 600.0},\n        },\n    ]\n\n    results = []\n    for params in test_cases:\n        # Extract parameters\n        C_tot = params[\"C_tot\"]\n        D = params[\"D\"]\n        R_lim = params[\"R_lim\"]\n        R_energy = params[\"R_energy\"]\n        w_FR = params[\"w\"][\"FR\"]\n        w_RU = params[\"w\"][\"RU\"]\n        w_SR = params[\"w\"][\"SR\"]\n        M_FR = params[\"M\"][\"FR\"]\n        M_RU = params[\"M\"][\"RU\"]\n        M_SR = params[\"M\"][\"SR\"]\n        c_FR = params[\"c\"][\"FR\"]\n        c_RU = params[\"c\"][\"RU\"]\n        c_SR = params[\"c\"][\"SR\"]\n        P_FR = params[\"P\"][\"FR\"]\n        P_RU = params[\"P\"][\"RU\"]\n        P_SR = params[\"P\"][\"SR\"]\n\n        # Compute headroom H and ramp budget B (nonnegative by definition)\n        H = max(0.0, C_tot - D)\n        B = max(0.0, R_lim - R_energy)\n\n        # Decision vector x = [q_FR, q_RU, q_SR, s_FR, s_RU, s_SR]\n        # Objective coefficients\n        f = np.array([c_FR, c_RU, c_SR, P_FR, P_RU, P_SR], dtype=float)\n\n        # Inequality constraints A_ub x = b_ub\n        A_ub = []\n        b_ub = []\n\n        # Capacity headroom: q_FR + q_RU + q_SR = H\n        A_ub.append([1.0, 1.0, 1.0, 0.0, 0.0, 0.0])\n        b_ub.append(H)\n\n        # Ramp budget: w_FR*q_FR + w_RU*q_RU + w_SR*q_SR = B\n        A_ub.append([w_FR, w_RU, w_SR, 0.0, 0.0, 0.0])\n        b_ub.append(B)\n\n        # Requirement satisfaction: q_i + s_i >= M_i  => -q_i - s_i = -M_i\n        # FR\n        A_ub.append([-1.0, 0.0, 0.0, -1.0, 0.0, 0.0])\n        b_ub.append(-M_FR)\n        # RU\n        A_ub.append([0.0, -1.0, 0.0, 0.0, -1.0, 0.0])\n        b_ub.append(-M_RU)\n        # SR\n        A_ub.append([0.0, 0.0, -1.0, 0.0, 0.0, -1.0])\n        b_ub.append(-M_SR)\n\n        A_ub = np.array(A_ub, dtype=float)\n        b_ub = np.array(b_ub, dtype=float)\n\n        # Bounds: all variables >= 0\n        bounds = [(0, None)] * 6\n\n        # Solve LP\n        res = linprog(c=f, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method=\"highs\")\n\n        if not res.success:\n            # In case of unexpected numerical issue, default to zeros\n            q_FR, q_RU, q_SR = 0.0, 0.0, 0.0\n        else:\n            x = res.x\n            q_FR, q_RU, q_SR = x[0], x[1], x[2]\n\n        # Round to three decimals\n        q_FR = round(q_FR, 3)\n        q_RU = round(q_RU, 3)\n        q_SR = round(q_SR, 3)\n\n        results.append([q_FR, q_RU, q_SR])\n\n    # Final print statement in the exact required format.\n    def format_list_of_lists(lol):\n        inner_lists = []\n        for sublist in lol:\n            # Format each number to three decimal places as a string\n            formatted_numbers = [f\"{v:.3f}\" for v in sublist]\n            inner_lists.append(f\"[{','.join(formatted_numbers)}]\")\n        return f\"[{','.join(inner_lists)}]\"\n\n    print(format_list_of_lists(results))\n\nsolve()\n```"
        }
    ]
}