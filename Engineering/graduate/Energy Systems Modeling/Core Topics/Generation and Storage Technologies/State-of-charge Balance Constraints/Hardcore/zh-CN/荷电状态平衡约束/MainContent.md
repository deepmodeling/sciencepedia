## 引言
储能系统是实现未来能源系统灵活性和可靠性的关键技术。为了有效调度和规划储能资产，我们需要能够精确描述其动态行为的数学模型，而荷电状态（State-of-Charge, SOC）平衡约束正是这些模型的核心。然而，将能量守恒的基本物理原理转化为一个在优化问题中既准确又易于处理的数学约束，并非易事，其中涉及对效率、损耗、物理边界和经济信号的复杂考量。本文旨在系统性地填补这一知识空白，为研究人员和从业者提供一个关于SOC平衡约束的全面指南。

在接下来的内容中，我们将分三步深入探讨这一主题。首先，在“原理与机制”一章，我们将从能量守恒的第一性原理出发，一步步构建SOC平衡方程，并辨析其中关键参数的物理意义与建模陷阱。接着，在“应用与跨学科关联”一章，我们将展示该约束如何在电力市场套利、电网调度、电动汽车管理乃至非电领域中发挥关键作用。最后，通过“动手实践”部分，您将有机会亲手实现和测试这些模型，将理论知识转化为实践技能。

让我们从基础开始，深入探索构成[储能建模](@entry_id:1124487)基石的原理与机制。

## 原理与机制

本章深入探讨[储能系统建模](@entry_id:1124491)的核心——荷电状态（State-of-Charge, SOC）平衡约束。我们将从能量守恒的第一性原理出发，系统地构建描述储能设备动态行为的数学模型。在此基础上，我们将阐明模型中各项参数的物理意义，并探讨在[优化建模](@entry_id:170993)中如何处理与此相关的各种复杂情况，如[变量选择](@entry_id:177971)、非物理行为的约束以及有限时间范围带来的偏差等。

### 基本[能量平衡方程](@entry_id:191484)

所有储能模型的基础是[热力学第一定律](@entry_id:146485)，即能量守恒原理。在一个[封闭系统](@entry_id:139565)中，能量的改变量等于净流入的能量。对于储能设备，这表现为一个跨时间步的平衡关系，其中下一时刻的储能水平取决于当前时刻的储能水平以及在此期间发生的能量交换。

我们首先以能量单位（如兆瓦时，MWh）来定义储能状态，即**能量状态**（State-of-Energy, SoE），记为 $e_t$。在一个离散的时间步 $\Delta t$ 内，能量状态的演化可以表示为：

$e_{t+1} = (\text{上一时刻残余能量}) + (\text{充电增加的能量}) - (\text{放电减少的能量})$

这个看似简单的平衡式中，每一项都包含着关键的物理机制，特别是与效率相关的能量损失。

#### 效率项的物理根据

储能设备在充放电过程中并非完美无损。能量在电化学形式与其他形式之间的转换伴随着热量耗散。模型必须精确地反映这些损失。

**充电效率**（**charging efficiency**），记为 $\eta_{\mathrm{ch}} \in (0, 1]$，定义为实际存储到设备中的能量与从电网吸收的能量之比。若充[电功率](@entry_id:273774)为 $p_t^{\mathrm{ch}}$，在 $\Delta t$ 时间内从电网吸收的能量为 $p_t^{\mathrm{ch}} \Delta t$。由于转换损失，只有一部分能量被成功储存。因此，能量状态的增量为 ：

$\Delta e_{\mathrm{ch}} = \eta_{\mathrm{ch}} (p_t^{\mathrm{ch}} \Delta t)$

**放电效率**（**discharging efficiency**），记为 $\eta_{\mathrm{dis}} \in (0, 1]$，其定义稍有不同，为主设备向电网输送的能量与从内部存储中提取的能量之比。这意味着，为了向电网提供功率 $p_t^{\mathrm{dis}}$，设备必须从内部提取比 $p_t^{\mathrm{dis}} \Delta t$ 更多的能量来补偿放电过程中的损失。具体来说，从存储中提取的能量 $\Delta e_{\mathrm{dis}}$ 满足：

$\eta_{\mathrm{dis}} = \frac{p_t^{\mathrm{dis}} \Delta t}{\Delta e_{\mathrm{dis}}}$

因此，能量状态的减少量为  ：

$\Delta e_{\mathrm{dis}} = \frac{1}{\eta_{\mathrm{dis}}} (p_t^{\mathrm{dis}} \Delta t)$

注意，因为 $\eta_{\mathrm{ch}} \le 1$ 且 $\eta_{\mathrm{dis}} \le 1$，充电项的系数 $\eta_{\mathrm{ch}}$ 不大于1，而放电项的系数 $\frac{1}{\eta_{\mathrm{dis}}}$ 不小于1。这精确地捕捉了物理现实：充电时存入的能量少于吸收的能量，放电时提取的能量多于输送的能量。

**往返效率**（**round-trip efficiency**），$\eta_{\mathrm{rt}}$，是衡量储能设备完整“充-放”循环总效率的指标。它等于充电效率和放电效率的乘积，即 $\eta_{\mathrm{rt}} = \eta_{\mathrm{ch}} \eta_{\mathrm{dis}}$。例如，向设备充入 $1 \ \mathrm{MWh}$ 的电能，实际储存了 $\eta_{\mathrm{ch}} \ \mathrm{MWh}$；再将这些储存的能量全部放出，最终能向电网输送 $\eta_{\mathrm{dis}} (\eta_{\mathrm{ch}} \ \mathrm{MWh}) = \eta_{\mathrm{rt}} \ \mathrm{MWh}$ 的电能。尽管往返效率是评估储能经济性的一个关键宏观指标，但在构建单步动态平衡方程时，必须使用方向性的充电和放电效率，而不能用 $\eta_{\mathrm{rt}}$ 来代替 。

#### [自放电](@entry_id:274268)效应

除了在充放电过程中的转换损失，大多数储能设备还会存在**[自放电](@entry_id:274268)**（**self-discharge**）或“漏损”现象，即在闲置状态下储存的能量也会随时间缓慢减少。一个常见的线性模型假设在一个时间步内，设备会损失其当前储能量的一个固定比例 $\sigma \in [0, 1)$。因此，在计入任何充放电活动之前，始于 $t$ 时刻的能量 $e_t$ 会衰减为 $(1-\sigma)e_t$。

综合以上各项，我们得到一个完整的离散时间能量状态平衡方程：

$e_{t+1} = (1-\sigma) e_t + \eta_{\mathrm{ch}} p_t^{\mathrm{ch}} \Delta t - \frac{1}{\eta_{\mathrm{dis}}} p_t^{\mathrm{dis}} \Delta t$

这个方程构成了所有后续分析的基础。

### 从能量状态到荷电状态

尽管能量状态 $e_t$ 在物理上是直观的，但在工程实践和学术研究中，我们更常用一个标准化的、无量纲的变量——**荷电状态**（**State-of-Charge, SOC**），通常记为 $s_t$。

#### 定义与量纲分析

SOC被定义为当前存储的能量 $e_t$ 与其额定能量容量 $E_{\max}$ 的比值：

$s_t = \frac{e_t}{E_{\max}}$

SOC是一个介于 $0$（完全放空）和 $1$（完全充满）之间的数值。要将[能量平衡方程](@entry_id:191484)转换为SOC平衡方程，我们只需将方程两边同除以 $E_{\max}$：

$\frac{e_{t+1}}{E_{\max}} = (1-\sigma) \frac{e_t}{E_{\max}} + \frac{\eta_{\mathrm{ch}} p_t^{\mathrm{ch}} \Delta t}{E_{\max}} - \frac{p_t^{\mathrm{dis}} \Delta t}{\eta_{\mathrm{dis}} E_{\max}}$

代入SOC的定义，我们得到SOC平衡方程：

$s_{t+1} = (1-\sigma) s_t + \frac{\eta_{\mathrm{ch}} \Delta t}{E_{\max}} p_t^{\mathrm{ch}} - \frac{\Delta t}{\eta_{\mathrm{dis}} E_{\max}} p_t^{\mathrm{dis}}$

在这里，出现了一个关键的[转换因子](@entry_id:142644) $\frac{\Delta t}{E_{\max}}$。这个因子的存在是确保[量纲一致性](@entry_id:271193)的必然要求 。功率变量 $p_t$ 的单位是能量/时间（如 MW 或 kW），而SOC是无量纲的。为了将功率转换为SOC的变化量，必须经过两个步骤：
1.  **功率到能量的转换**：将功率 $p_t$ 乘以时间步长 $\Delta t$ 得到能量增量 $p_t \Delta t$。
2.  **能量到SOC的归一化**：将能量增量除以总容量 $E_{\max}$，将其转换为无量纲的SOC增量。

例如，在一个一致的单位系统中，若功率 $p_t$ 单位为 $\mathrm{kW}$，时间步 $\Delta t$ 为 $\mathrm{h}$，容量 $E_{\max}$ 为 $\mathrm{kWh}$，则 $\frac{\Delta t}{E_{\max}} p_t$ 的单位为 $\frac{\mathrm{h}}{\mathrm{kWh}} \mathrm{kW} = \frac{\mathrm{kWh}}{\mathrm{kWh}} = 1$，即无量纲。同样，在[国际单位制](@entry_id:172547)中，若 $p_t$ 为 $\mathrm{W}$，$t$ 为 $\mathrm{s}$，$E_{\max}$ 为 $\mathrm{J}$，由于 $\mathrm{W} \cdot \mathrm{s} = \mathrm{J}$，该因子同样确保了量纲的正确性 。

#### 物理边界与状态依赖约束

SOC的定义域为 $[0, 1]$，这反映了储能设备不能储存[负能量](@entry_id:161542)，也不能超过其物理容量的限制。然而，在数学模型中，这个边界不会自动被遵守。如果我们允许任意大的充电功率 $p_t^{\mathrm{ch}}$，即使在 $e_t \lt E_{\max}$ 的情况下，$e_{t+1}$ 仍可能轻易地超过 $E_{\max}$。

因此，为了保证模型的物理有效性，必须对控制变量（即充放电功率）施加**状态依赖的约束**（**state-dependent constraints**）。这些约束确保在任何时刻，充入的能量不会使总储能量超过容量，提取的能量不会使总储能量低于零 。

具体来说，在时间步 $\Delta t$ 内，可充入的最大能量等于[自放电](@entry_id:274268)后可用的“空闲”容量 $E_{\max} - (1-\sigma)e_t$。因此，充电功率必须满足：

$\eta_{\mathrm{ch}} p_t^{\mathrm{ch}} \Delta t \le E_{\max} - (1-\sigma)e_t \implies p_t^{\mathrm{ch}} \le \frac{E_{\max} - (1-\sigma)e_t}{\eta_{\mathrm{ch}} \Delta t}$

同理，可放出的最大能量不能超过[自放电](@entry_id:274268)后剩余的能量 $(1-\sigma)e_t$。因此，放电功率必须满足：

$\frac{1}{\eta_{\mathrm{dis}}} p_t^{\mathrm{dis}} \Delta t \le (1-\sigma)e_t \implies p_t^{\mathrm{dis}} \le \frac{\eta_{\mathrm{dis}} (1-\sigma)e_t}{\Delta t}$

通过施加这些与当前状态 $e_t$（或 $s_t$）相关的功率上限，我们确保了SOC序列 $s_0, s_1, \dots, s_T$ 始终保持在 $[0, 1]$ 的物理区间内。

#### 约束的跨期性质

SOC平衡方程是一个典型的**[跨期约束](@entry_id:1126649)**（**intertemporal constraint**），因为它直接将一个时间点的状态（$s_{t+1}$）与前一个时间点的状态（$s_t$）以及这两个时间点之间的决策（$p_t^{\mathrm{ch}}, p_t^{\mathrm{dis}}$）联系起来。储能的本质就是时间的函数：今天的决策会影响明天的状态，从而约束明天的[决策空间](@entry_id:1123459)。

为了更深刻地理解这种跨期依赖性，我们可以考察其连续时间形式。SOC的演化可以用一个[一阶常微分方程](@entry_id:264241)（ODE）来描述 ：

$\frac{ds(\tau)}{d\tau} = \frac{\eta^{\mathrm{ch}} p^{\mathrm{ch}}(\tau)}{E_{\max}} - \frac{p^{\mathrm{dis}}(\tau)}{\eta^{\mathrm{dis}} E_{\max}} - \lambda s(\tau)$

其中 $\lambda$ 是连续时间下的[自放电](@entry_id:274268)率。求解这个方程可以得到在 $[t-1, t]$ 区间末端的状态 $s_t$：

$s_t = e^{-\lambda \Delta t} s_{t-1} + \int_{t-1}^{t} e^{-\lambda (t-\tau)} \left( \frac{\eta^{\mathrm{ch}} p^{\mathrm{ch}}(\tau)}{E_{\max}} - \frac{p^{\mathrm{dis}}(\tau)}{\eta^{\mathrm{dis}} E_{\max}} \right) d\tau$

这个解清晰地表明，$s_t$ 不仅依赖于衰减后的初始状态 $s_{t-1}$，还依赖于整个时间区间 $[t-1, t]$ 内所有充放电决策的加权积分。这种“记忆”效应是储能系统作为动态系统的核心特征。

### [优化建模](@entry_id:170993)中的高阶考量

在将SOC平衡约束嵌入到能量[系统优化](@entry_id:262181)问题中时，一些更深层次的建模选择和技术细节变得至关重要。

#### [状态变量](@entry_id:138790)的选择：能量状态 vs. 荷电状态

在构建优化模型时，我们面临一个选择：使用能量状态 $e_t$ 还是荷电状态 $s_t$ 作为状态变量。当储能容量 $E_{\max}$ 是一个固定的已知参数时，这两个变量通过一个简单的线性变换 $e_t = E_{\max} s_t$ 相关联。在这种情况下，两种模型表述是等价的：一个关于 $(e_t, p_t^{\mathrm{ch}}, p_t^{\mathrm{dis}})$ 的[线性规划](@entry_id:138188)问题可以被无损地转换为一个关于 $(s_t, p_t^{\mathrm{ch}}, p_t^{\mathrm{dis}})$ 的线性规划问题，只需对目标函数和约束中的系数进行相应调整即可 。

然而，当 $E_{\max}$ 本身是一个**决策变量**时（例如，在储能容量优化配置或投资规划问题中），这个选择会对模型的数学性质产生巨大影响 。

-   **使用能量状态 $e_t$**：状态平衡方程 $e_t = (1-\sigma)e_{t-1} + \dots$ 和边界约束 $0 \le e_t \le E_{\max}$ 都是关于决策变量 $e_t, e_{t-1}, p_t, E_{\max}$ 的线性表达式。因此，整个模型保持了线性（或[凸性](@entry_id:138568)，取决于[目标函数](@entry_id:267263)）。

-   **使用荷电状态 $s_t$**：状态平衡方程变为 $s_t = (1-\sigma)s_{t-1} + \frac{\eta_{\mathrm{ch}} \Delta t}{E_{\max}} p_t^{\mathrm{ch}} - \dots$。这里的系数 $\frac{1}{E_{\max}}$ 乘以了另一个决策变量 $p_t^{\mathrm{ch}}$，形成了**[双线性](@entry_id:146819)项**（**bilinear term**）。[双线性](@entry_id:146819)项是非凸的，它会破坏问题的线性或凸性，使得求解变得异常困难，通常需要复杂的[非线性](@entry_id:637147)或[全局优化](@entry_id:634460)算法。

因此，在涉及储能容量优化的模型中，强烈推荐使用能量状态 $e_t$ 作为状态变量，以保持模型的良好数学结构（如线性或凸性），从而保证计算上的易解性 。

#### 模拟同时充放电

在标准的能量市场或系统运行模型中，通常会禁止储能设备在同一个时间步内既充电又放电。这背后的原因既有物理上的，也有经济上的。

从物理上看，由于[往返效率](@entry_id:1131124) $\eta_{\mathrm{rt}} = \eta_{\mathrm{ch}}\eta_{\mathrm{dis}} \lt 1$，同时以功率 $p^{\mathrm{ch}}$ 充电和以功率 $p^{\mathrm{dis}}$ 放电，本质上是在进行一次能量循环，这个过程必然导致净能量损失。

从经济上看，如果充放电的边际成本（或收益）是功率的非减函数（例如，以固定电价购买电能，以固定但通常更低的价格出售电能），那么这种纯粹消耗能量的行为永远不会是最优的。对于任何一个存在同时充放电的解，总能找到另一个至少同样好（甚至更好）的解，它只进行净充电或净放电，但达到相同的SOC变化效果 。

在优化模型中，禁止同时充放电可以通过引入一个**互补约束**（**complementarity constraint**）来实现：

$p_t^{\mathrm{ch}} \cdot p_t^{\mathrm{dis}} = 0$

由于 $p_t^{\mathrm{ch}} \ge 0$ 和 $p_t^{\mathrm{dis}} \ge 0$，这个非凸的二次约束确保了两者中至少有一个为零。在[混合整数线性规划](@entry_id:1127955)（MILP）中，这个逻辑可以用一个二元变量 $y_t \in \{0, 1\}$ 和“大M”方法来线性化地表示 ：

$p_t^{\mathrm{ch}} \le y_t \cdot M$
$p_t^{\mathrm{dis}} \le (1 - y_t) \cdot M$

其中 $M$ 是一个足够大的常数（例如，充放[电功率](@entry_id:273774)的上限）。

然而，禁止同时充放电的假设并非总是成立。在某些特殊的市场条件下，例如当购电价格为**负数**时，情况就发生了变化。假设购电价格为 $-15 \ \mathrm{USD/MWh}$（即每用一兆瓦时电，电网会付给你15美元），而售电价格为 $40 \ \mathrm{USD/MWh}$。即使[往返效率](@entry_id:1131124)只有 $0.87$，通过同时充放电进行套利也可能是有利可图的。充电 $1 \ \mathrm{MW}$ 意味着收入 $15 \ \mathrm{USD}$，这 $1 \ \mathrm{MW}$ 的[电力](@entry_id:264587)经过设备循环后，可以输出 $0.87 \ \mathrm{MW}$ 的[电力](@entry_id:264587)，带来 $0.87 \times 40 = 34.8 \ \mathrm{USD}$ 的收入。总收入 $15 + 34.8 = 49.8 \ \mathrm{USD}$，远大于零。在这种情况下，最优决策可能就是以最大功率进行同时充放电套利 。这说明，是否禁止同时充放电，取决于模型所反映的经济环境。

#### 处理有限时间范围效应

在对未来有限时间范围（例如未来24小时）进行优化时，模型会表现出一种被称为“**边界效应**”或“**期末效应**”（**end-of-horizon effects**）的人为偏差。如果模型的目标函数只关心时间范围内的运行成本，而没有对期末的储能状态 $s_T$ 赋予任何价值，那么优化器会倾向于在时间范围的末尾将储能完全耗尽（以最大化放电收益）或完全充满（如果期末电价极低），而不考虑这种状态对未来运行的影响。

为了消除这种不切实际的短视行为，一种常见的技术是施加一个**能量中性**（**energy neutrality**）或**周期性环绕**（**cyclic wrap-around**）的[终端约束](@entry_id:176488) 。最常见的形式是要求在优化期末，储能状态必须返回到初始状态：

$s_T = s_0$

这个约束强制模型寻找一个可持续的、可重复的操作策略。通过将期末状态与初始状态绑定，它含蓄地为期末能量赋予了与初始能量相等的“[机会成本](@entry_id:146217)”，从而避免了在期末人为地囤积或耗尽能量的行为  。

当施加 $s_T=s_0$ 约束时，整个周期的能量平衡呈现出一个清晰的物理图像。通过对单步平衡方程进行累加，我们可以得到整个周期的总平衡关系 ：

$\sum_{t=0}^{T-1} (\eta_{\mathrm{ch}} p_t^{\mathrm{ch}} \Delta t - \frac{1}{\eta_{\mathrm{dis}}} p_t^{\mathrm{dis}} \Delta t) = \sum_{t=0}^{T-1} \sigma e_t$

这个方程的含义是：在一个完整的、状态可恢复的循环中，所有注入的有效能量（充电能量减去为满足放电需求而提取的能量）必须恰好等于在整个周期内因[自放电](@entry_id:274268)而损失的总能量。换言之，充入的能量不仅要满足放电需求，还必须补偿所有的系统损耗（包括[往返效率](@entry_id:1131124)损失和[自放电](@entry_id:274268)损失），才能使系统“收支相抵”，回到初始状态。这正是对一个可持续运行的储能系统长期能量收支平衡的精确数学刻画。