{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握自由能微扰方法，首先必须理解其统计力学根基。本基础练习将引导您针对一个可以精确求解的简谐振子模型，推导自由能微扰公式。通过将结果与直接通过配分函数计算得到的结果进行比较 ，您将对这一强大关系式为何以及如何成立获得坚实的理解。",
            "id": "3847564",
            "problem": "考虑一个在固定温度 $T$ 下的经典一维系统，该系统由单一坐标 $x$ 和两个谐波势能函数描述：$U_{A}(x)=\\tfrac{1}{2}k_{A}x^{2}$ 和 $U_{B}(x)=\\tfrac{1}{2}k_{B}x^{2}$，其中 $k_{A}>0$ 和 $k_{B}>0$ 是力常数。仅使用正则系综的定义和经典统计力学的基本事实，通过两种方式推导状态 B 和状态 A 之间的自由能差 $\\Delta F \\equiv F_{B}-F_{A}$：\n1. 从 $U_{A}(x)$ 下的正则平均定义出发，计算系综平均 $\\langle \\exp(-\\beta\\Delta U)\\rangle_{A}$，其中 $\\Delta U(x)\\equiv U_{B}(x)-U_{A}(x)$ 且 $\\beta\\equiv 1/(k_{\\mathrm{B}}T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数。使用此平均值获得 $\\Delta F$ 的解析表达式，除了正则定义之外，不借助任何预先陈述的恒等式。\n2. 独立计算 $U_{B}$ 和 $U_{A}$ 的精确构型配分函数之比，并用它来获得 $\\Delta F$。证明两个结果一致。\n\n假设哈密顿量可分离为动能和势能部分，并注意任何动量贡献在自由能差中均被抵消，因为状态 A 和 B 中的动能相同。请以 $k_{A}$、$k_{B}$、$k_{\\mathrm{B}}$ 和 $T$ 的单一闭合形式表达式给出 $\\Delta F$ 的最终答案。以焦耳表示自由能。不需要进行数值计算或四舍五入。",
            "solution": "本问题要求推导亥姆霍兹自由能差 $\\Delta F \\equiv F_{B}-F_{A}$，该差值存在于一个由谐波势能函数 $U_{A}(x)=\\tfrac{1}{2}k_{A}x^{2}$ 和 $U_{B}(x)=\\tfrac{1}{2}k_{B}x^{2}$ 描述的一维经典系统的两个状态之间。该推导必须通过两种不同的方式进行，以证明它们的等价性。我们已知逆温度 $\\beta \\equiv 1/(k_{\\mathrm{B}}T)$，其中 $k_{\\mathrm{B}}$ 为玻尔兹曼常数，$T$ 为固定温度。\n\n首先，我们建立自由能与配分函数之间的基本关系。亥姆霍兹自由能 $F$ 由总正则配分函数 $Z$ 定义为：\n$$F = -k_{\\mathrm{B}}T \\ln Z = -\\frac{1}{\\beta} \\ln Z$$\n对于具有可分离哈密顿量 $H(p,x) = K(p) + U(x)$ 的一维系统，其总配分函数 $Z$ 由对所有相空间坐标 $(p,x)$ 的积分给出：\n$$Z = \\frac{1}{h} \\int \\int \\exp(-\\beta H(p,x)) dp dx = \\left(\\frac{1}{h} \\int \\exp(-\\beta K(p)) dp\\right) \\left(\\int \\exp(-\\beta U(x)) dx\\right)$$\n其中 $h$ 是一个具有作用量单位的常数，用以使 $Z$ 无量纲化，通常为普朗克常数。我们可以将其写为 $Z = Z_{\\mathrm{kin}} Q$，其中 $Z_{\\mathrm{kin}}$ 是动能贡献，而 $Q$ 是构型配分函数，$Q = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U(x)) dx$。\n\n自由能差 $\\Delta F$ 为：\n$$\\Delta F = F_{B} - F_{A} = \\left(-\\frac{1}{\\beta} \\ln Z_{B}\\right) - \\left(-\\frac{1}{\\beta} \\ln Z_{A}\\right) = -\\frac{1}{\\beta} \\ln\\left(\\frac{Z_{B}}{Z_{A}}\\right)$$\n由于状态 A 和 B 的动能项 $K(p)$ 相同，它们的动能配分函数 $Z_{\\mathrm{kin},A}$ 和 $Z_{\\mathrm{kin},B}$ 是相同的。因此，总配分函数之比简化为构型配分函数之比：\n$$\\frac{Z_{B}}{Z_{A}} = \\frac{Z_{\\mathrm{kin}} Q_{B}}{Z_{\\mathrm{kin}} Q_{A}} = \\frac{Q_{B}}{Q_{A}}$$\n因此，自由能差与构型配分函数直接相关：\n$$\\Delta F = -\\frac{1}{\\beta} \\ln\\left(\\frac{Q_{B}}{Q_{A}}\\right)$$\n这个从正则定义导出的关系式将是两种方法的核心。\n\n**方法 1：使用系综平均进行推导**\n\n此方法要求我们计算系综平均 $\\langle \\exp(-\\beta\\Delta U)\\rangle_{A}$ 并将其与 $\\Delta F$ 相关联。首先，我们必须按要求从基本定义出发推导出此关系式。\n\n在状态 A 中，物理量 $O(x)$ 的正则系综平均定义为：\n$$\\langle O(x) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} O(x) \\exp(-\\beta U_{A}(x)) dx}{\\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{A}(x)) dx} = \\frac{\\int_{-\\infty}^{\\infty} O(x) \\exp(-\\beta U_{A}(x)) dx}{Q_{A}}$$\n我们感兴趣的是 $O(x) = \\exp(-\\beta\\Delta U(x))$ 的特定平均值，其中 $\\Delta U(x) = U_{B}(x) - U_{A}(x)$。将其代入定义：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} \\exp(-\\beta(U_{B}(x) - U_{A}(x))) \\exp(-\\beta U_{A}(x)) dx}{Q_{A}}$$\n通过合并分子中的指数项，我们发现：\n$$\\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x) + \\beta U_{A}(x) - \\beta U_{A}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x)) dx = Q_{B}$$\n因此，系综平均恰好是构型配分函数之比：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{Q_{B}}{Q_{A}}$$\n将此结果与前面推导的 $\\Delta F$ 表达式相结合，我们得到自由能微扰恒等式：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln \\langle \\exp(-\\beta\\Delta U) \\rangle_{A}$$\n现在，我们为给定的势能显式计算该平均值。势能差为：\n$$\\Delta U(x) = U_{B}(x) - U_{A}(x) = \\frac{1}{2}k_{B}x^{2} - \\frac{1}{2}k_{A}x^{2} = \\frac{1}{2}(k_{B} - k_{A})x^{2}$$\n系综平均为：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\int_{-\\infty}^{\\infty} \\exp\\left(-\\beta \\left(\\frac{1}{2}(k_{B}-k_{A})x^{2}\\right)\\right) \\exp\\left(-\\beta \\left(\\frac{1}{2}k_{A}x^{2}\\right)\\right) dx}{\\int_{-\\infty}^{\\infty} \\exp\\left(-\\beta \\left(\\frac{1}{2}k_{A}x^{2}\\right)\\right) dx}$$\n分子的积分为：\n$$I_{\\mathrm{num}} = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta}{2}(k_{B}-k_{A}+k_{A})x^{2}\\right) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{B}}{2}x^{2}\\right) dx$$\n分母的积分为：\n$$I_{\\mathrm{den}} = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{A}}{2}x^{2}\\right) dx$$\n这些是标准高斯积分，形式为 $\\int_{-\\infty}^{\\infty} \\exp(-ax^{2})dx = \\sqrt{\\pi/a}$。\n对于分子，$a = \\frac{\\beta k_{B}}{2}$，所以 $I_{\\mathrm{num}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}}}$。\n对于分母，$a = \\frac{\\beta k_{A}}{2}$，所以 $I_{\\mathrm{den}} = \\sqrt{\\frac{2\\pi}{\\beta k_{A}}}$。\n系综平均是这两个结果的比值：\n$$\\langle \\exp(-\\beta\\Delta U) \\rangle_{A} = \\frac{\\sqrt{2\\pi/(\\beta k_{B})}}{\\sqrt{2\\pi/(\\beta k_{A})}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}} \\cdot \\frac{\\beta k_{A}}{2\\pi}} = \\sqrt{\\frac{k_{A}}{k_{B}}}$$\n最后，我们将其代入 $\\Delta F$ 的表达式中：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln\\left(\\sqrt{\\frac{k_{A}}{k_{B}}}\\right) = -k_{\\mathrm{B}}T \\ln\\left(\\left(\\frac{k_{A}}{k_{B}}\\right)^{1/2}\\right) = -\\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{A}}{k_{B}}\\right)$$\n使用对数性质 $\\ln(1/x) = -\\ln(x)$，这可以写成：\n$$\\Delta F = \\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)$$\n\n**方法 2：使用配分函数之比进行推导**\n\n此方法直接从构型配分函数之比 $Q_{B}/Q_{A}$ 计算 $\\Delta F$。如引言中所述，$\\Delta F = -k_{\\mathrm{B}}T \\ln(Q_{B}/Q_{A})$。\n\n状态 A 和 B 的构型配分函数为：\n$$Q_{A} = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{A}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{A}}{2}x^{2}\\right) dx$$\n$$Q_{B} = \\int_{-\\infty}^{\\infty} \\exp(-\\beta U_{B}(x)) dx = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_{B}}{2}x^{2}\\right) dx$$\n使用高斯积分结果 $\\int_{-\\infty}^{\\infty} \\exp(-ax^{2})dx = \\sqrt{\\pi/a}$，我们计算每个配分函数：\n$$Q_{A} = \\sqrt{\\frac{\\pi}{(\\beta k_{A}/2)}} = \\sqrt{\\frac{2\\pi}{\\beta k_{A}}}$$\n$$Q_{B} = \\sqrt{\\frac{\\pi}{(\\beta k_{B}/2)}} = \\sqrt{\\frac{2\\pi}{\\beta k_{B}}}$$\n接下来，我们计算它们的比值：\n$$\\frac{Q_{B}}{Q_{A}} = \\frac{\\sqrt{2\\pi/(\\beta k_{B})}}{\\sqrt{2\\pi/(\\beta k_{A})}} = \\sqrt{\\frac{k_{A}}{k_{B}}}$$\n将此比值代入自由能差的方程中：\n$$\\Delta F = -k_{\\mathrm{B}}T \\ln\\left(\\frac{Q_{B}}{Q_{A}}\\right) = -k_{\\mathrm{B}}T \\ln\\left(\\sqrt{\\frac{k_{A}}{k_{B}}}\\right)$$\n这可以简化为：\n$$\\Delta F = -\\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{A}}{k_{B}}\\right) = \\frac{1}{2}k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)$$\n\n**结论**\n\n两种方法都得出了相同的自由能差结果：$\\Delta F = \\frac{1}{2}k_{\\mathrm{B}}T \\ln(k_{B}/k_{A})$。这证实了两种方法的一致性，这两种方法都是统计力学和自由能计算的基石。该表达式的单位是能量（国际单位制中为焦耳），因为乘积 $k_{\\mathrm{B}}T$ 的单位是能量，而对数项是无量纲的。",
            "answer": "$$\n\\boxed{\\frac{1}{2} k_{\\mathrm{B}}T \\ln\\left(\\frac{k_{B}}{k_{A}}\\right)}\n$$"
        },
        {
            "introduction": "虽然自由能微扰公式在理论上很简洁，但将其应用于蛋白质-配体结合等复杂体系时，却充满了实践上的挑战。本练习提供了一个假设的、但存在严重缺陷的计算研究案例，要求您扮演同行评审的角色。通过识别其中的多种方法学错误 ，您将锻炼出敏锐的批判性思维，并掌握进行可靠自由能计算所必需的最佳实践。",
            "id": "2455870",
            "problem": "一篇最近的论文报道了使用单步自由能微扰 (FEP) 方案，计算一个大的、柔性的、类药物配体与蛋白质结合的“绝对”结合自由能。作者在一个显式溶剂盒子中，于正则系综 (NVT) 下，$T=300\\ \\mathrm{K}$ 条件，以 $2\\ \\mathrm{fs}$ 的时间步长模拟了蛋白质-配体复合物 $5\\ \\mathrm{ns}$。伦纳德-琼斯相互作用在 $1.0\\ \\mathrm{nm}$ 的球形截断半径处被截断，没有进行长程色散校正；静电相互作用在周期性边界条件下使用粒子网格埃瓦尔德 (PME) 方法处理。配体在一个步骤中被炼金术般地“关闭”：其与环境的非键相互作用被移除，所报告的自由能使用 Zwanzig 指数平均值计算\n\n$$\n\\Delta G_{0\\to 1} \\;=\\; -k_{\\mathrm{B}}T \\,\\ln \\left\\langle \\exp\\!\\left[-\\beta\\big(U_{1}-U_{0}\\big)\\right]\\right\\rangle_{0},\n$$\n\n其中 $\\beta=1/(k_{\\mathrm{B}}T)$，$U_{0}$ 是完全相互作用的结合复合物的势能，$U_{1}$ 是当配体与其环境完全解耦时的势能，而 $\\langle\\cdot\\rangle_{0}$ 表示对从 $U_{0}$ 采样的构型进行的系综平均。没有使用中间耦合参数，没有对范德华相互作用应用软核修饰，并且只评估了正向过程 $0\\to 1$。在解耦过程中，配体的净电荷变化了 $+1e$；没有添加显式的抗衡离子（依赖 PME 的均匀中和背景）。没有应用位置或取向限制来将解耦的配体保持在结合位点中，并且在通过 $\\Delta G^{\\circ}=RT\\ln K_{\\mathrm{d}}$ 将 $\\Delta G$ 转换为解离常数时没有添加标准态校正。作者没有进行溶剂“分支”的计算（即在体相水中对配体进行解耦），也没有报告不确定性或收敛性诊断。\n\n鉴于所述方法，以下哪些批评在科学上是合理的？选择所有适用项。\n\nA. 对于一个大的、柔性的配体，从完全相互作用状态到完全无相互作用状态执行单步 FEP，很可能会因相空间重叠差而导致指数平均 $-k_{\\mathrm{B}}T\\ln\\langle e^{-\\beta\\Delta U}\\rangle$ 在没有中间状态的情况下不稳定且有偏差。\n\nB. 忽略对结合位点中配体的限制以及相关的标准态校正会使绝对结合自由能产生偏差，因为解耦的配体可以自由平移和旋转；必须包括限制自由能和 $\\Delta G^{\\circ}$ 校正。\n\nC. 在有限周期性盒子中，使用 PME 方法时将净电荷改变 $+1e$ 会因为均匀中和背景和镜像相互作用而引入有限尺寸效应；需要进行净电荷校正，忽略它会使 $\\Delta G$ 产生偏差。\n\nD. 仅计算复合物“分支”（在蛋白质结合位点中对配体进行解耦）不足以得到绝对结合自由能；一个热力学循环需要将复合物分支与溶剂分支（在水中对配体进行解耦）结合起来，同时还要包括限制和标准态项。\n\nE. 使用正则 (NVT) 系综而非等温等压 (NPT) 系综必然会使来自 FEP 的结合自由能无效，因此所报告的值在根本上是无意义的。\n\nF. 在没有软核势的情况下，单步关闭伦纳德-琼斯相互作用会在原子重叠时导致端点奇点和大的力峰值，从而引起数值不稳定和严重偏差。\n\nG. PME 静电学方法不适用于炼金术变换，因此会使任何此类结合自由能的计算结果都不可靠。\n\nH. 仅依赖正向指数估计器，而没有进行反向计算或使用 Bennett 接受率 (BAR) 或跨多个中间状态的多态 BAR (MBAR)，会带来很大的偏差风险，并且缺乏可靠的不确定性量化。",
            "solution": "问题陈述描述了一个计算实验，旨在确定配体与蛋白质结合的绝对结合自由能。该问题是检验计算化学中自由能计算理论与实践知识的有效测试。所述方法充满了严重错误，任务是识别所提供的批评中哪些在科学上是合理的。我现在将评估每一项批评。\n\n计算的核心是 Zwanzig 公式，或称自由能微扰 (FEP)：\n$$\n\\Delta G_{0\\to 1} \\;=\\; -k_{\\mathrm{B}}T \\,\\ln \\left\\langle \\exp\\!\\left[-\\beta\\big(U_{1}-U_{0}\\big)\\right]\\right\\rangle_{0}\n$$\n其中状态 $0$ 是完全相互作用的蛋白质-配体复合物，状态 $1$ 是配体的非键相互作用被炼金术般地“关闭”的系统。\n\nA. 对于一个大的、柔性的配体，从完全相互作用状态到完全无相互作用状态执行单步 FEP，很可能会因相空间重叠差而导致指数平均 $-k_{\\mathrm{B}}T\\ln\\langle e^{-\\beta\\Delta U}\\rangle$ 在没有中间状态的情况下不稳定且有偏差。\n这项批评是**正确的**。FEP 公式的有效性取决于参考态（状态 $0$）的系综与目标态（状态 $1$）的相空间有足够的重叠。当两个状态非常不同时，例如湮灭一个大配体的所有非键相互作用时，对于从状态 $0$ 采样的几乎所有构型，势能差 $\\Delta U = U_1 - U_0$ 都会非常大且为正。指数平均 $\\langle e^{-\\beta\\Delta U} \\rangle_{0}$ 会被 $\\Delta U$ 很小的极端罕见构型所主导。一次 $5\\ \\mathrm{ns}$ 的有限模拟极不可能充分采样到这些关键构型。这会导致系统性的采样不足问题，从而在计算出的 $\\Delta G$ 中产生大的统计误差（方差）和显著的系统误差（偏差）。标准且必要的程序是将变换分解为多个更小的步骤（例如，使用由耦合参数 $\\lambda$ 定义的中间状态），以确保相邻步骤之间有足够的相空间重叠。\n\nB. 忽略对结合位点中配体的限制以及相关的标准态校正会使绝对结合自由能产生偏差，因为解耦的配体可以自由平移和旋转；必须包括限制自由能和 $\\Delta G^{\\circ}$ 校正。\n这项批评是**正确的**。目标是“绝对”结合自由能，它对应于标准结合自由能 $\\Delta G^{\\circ}$。该值与标准条件（例如 $1\\ \\mathrm{M}$ 浓度）下的平衡常数 $K_d$ 或 $K_a$ 相关。原始的炼金术计算得出的是将配体从其结合态转移到一个仍然被限制在蛋白质结合位点内的无相互作用状态的自由能。要将其与 $\\Delta G^{\\circ}$ 联系起来，需要一个严谨的方案。这包括对配体施加位置和取向限制，计算带有这些限制的自由能变化，然后解析计算并加上将这些限制释放到标准态体积（$V^\\circ$，对应于 $1\\ \\mathrm{M}$）中所需的自由能。通过忽略限制，配体的最终状态定义不清（它在口袋内的一个未知体积中采样），并且通过忽略标准态校正，得到的数值无法有意义地转换或与实验解离常数进行比较。\n\nC. 在有限周期性盒子中，使用 PME 方法时将净电荷改变 $+1e$ 会因为均匀中和背景和镜像相互作用而引入有限尺寸效应；需要进行净电荷校正，忽略它会使 $\\Delta G$ 产生偏差。\n这项批评是**正确的**。用于计算周期性系统中静电相互作用的粒子网格埃瓦尔德 (PME) 方法假定整个模拟盒子是电中性的。如果系统带有净电荷，PME 会隐式地添加一个均匀的背景电荷（中和等离子体）以保持电中性。由于电荷与其自身的周期性镜像以及这个背景的相互作用，这会引入一个依赖于系统尺寸的人为能量项。当炼金术变换改变了系统的净电荷时，如此处所述（$+1e$），这种人为效应不会被抵消。它会给计算出的自由能差引入一个显著的误差。存在成熟的校正方案来估计和移除这种有限尺寸效应。对于改变电荷的变换，忽略此类校正是一个严重的方法学错误。\n\nD. 仅计算复合物“分支”（在蛋白质结合位点中对配体进行解耦）不足以得到绝对结合自由能；一个热力学循环需要将复合物分支与溶剂分支（在水中对配体进行解耦）结合起来，同时还要包括限制和标准态项。\n这项批评是**正确的**。绝对结合自由能 $\\Delta G_{bind}^\\circ$ 对应于将配体从体相溶剂转移到蛋白质结合位点的过程。这个过程不是直接模拟的。而是构建一个热力学循环：\n$$\n\\begin{array}{ccc} \\text{复合物(aq)}  \\xrightarrow{\\Delta G_{\\text{bind}}^\\circ}  \\text{蛋白质(aq) + 配体(aq)} \\\\ \\downarrow \\Delta G_{\\text{complex}}   \\downarrow \\Delta G_{\\text{solvent}} \\\\ \\text{蛋白质(aq) + “虚拟”配体(在位点中)}  \\xrightarrow{\\approx 0}  \\text{蛋白质(aq) + “虚拟”配体(在溶剂中)} \\end{array}\n$$\n根据这个循环，$\\Delta G_{\\text{bind}}^\\circ = \\Delta G_{\\text{solvent}} - \\Delta G_{\\text{complex}}$。问题陈述中描述的计算只计算了这个循环的一部分，即“复合物分支” ($\\Delta G_{\\text{complex}}$)。如果不计算“溶剂分支”($\\Delta G_{\\text{solvent}}$)，即在体相水中解耦相同配体的自由能，就不可能确定结合自由能。仅将复合物分支的值报告为绝对结合自由能是对该方法的根本性误解。\n\nE. 使用正则 (NVT) 系综而非等温等压 (NPT) 系综必然会使来自 FEP 的结合自由能无效，因此所报告的值在根本上是无意义的。\n这项批评是**不正确的**。FEP 计算可以在多种统计系综中进行。在 NVT 系综中，结果是亥姆霍兹自由能差 $\\Delta A$。在 NPT 系综中，结果是吉布斯自由能差 $\\Delta G$。两者通过 $\\Delta G = \\Delta A + P\\Delta V$ 相关联。对于凝聚相生物分子系统，配体结合或解耦时的体积变化 $\\Delta V$ 通常非常小，使得 $P\\Delta V$ 项与其他误差来源相比可以忽略不计。虽然 NPT 系综在理论上更适合与通常在恒定压力下进行的实验进行比较，但使用 NVT 系综是一种常见且通常合理的近似。声称它“必然使”结果无效是一种夸大其词的说法。所描述的其他错误（A, B, C, D, F, H）要严重得多。\n\nF. 在没有软核势的情况下，单步关闭伦纳德-琼斯相互作用会在原子重叠时导致端点奇点和大的力峰值，从而引起数值不稳定和严重偏差。\n这项批评是**正确的**。伦纳德-琼斯势有一个强排斥性的 $r^{-12}$ 项，在原子间距离 $r \\to 0$ 时会发散。当炼金术般地湮灭一个粒子时，其相互作用被关闭。在逆过程（创生）中，将从一个粒子是无相互作用的“虚拟”原子的状态中采样构型。这个虚拟原子可能会漂移到一个与环境中原子发生空间位阻冲突的位置。为这种构型评估完全相互作用的势能会产生近乎无穷大的能量和力，这个问题被称为“端点奇点”。软核势是一种标准技术，用于在短程范围内修改势能，以防止这种发散，并使自由能计算稳定和收敛。试图在没有软核势的情况下单步关闭 LJ 相互作用是极具问题的，可能导致模拟崩溃，或者充其量由于这些高能事件而得到一个偏差大到无可救药的结果。\n\nG. PME 静电学方法不适用于炼金术变换，因此会使任何此类结合自由能的计算结果都不可靠。\n这项批评是**不正确的**。这是一个错误且过于宽泛的概括。PME 是处理周期性模拟中长程静电相互作用的标准、最先进的方法，包括用于炼金术自由能计算的模拟。虽然它有已知的、必须正确处理的人为效应（如批评 C 中所述），但该方法本身并非“不适用”。文献中绝大多数可靠的 FEP 研究都使用 PME。\n\nH. 仅依赖正向指数估计器，而没有进行反向计算或使用 Bennett 接受率 (BAR) 或跨多个中间状态的多态 BAR (MBAR)，会带来很大的偏差风险，并且缺乏可靠的不确定性量化。\n这项批评是**正确的**。正向 FEP 估计器（Zwanzig 公式）已知是有偏差的，尤其是在相空间重叠较差时。它收敛非常慢，并且没有提供对其自身有效性的内部检验。现代自由能计算的最佳实践要求使用统计上更稳健的估计器。Bennett 接受率 (BAR) 方法结合了正向 ($0 \\to 1$) 和反向 ($1 \\to 0$) 模拟的数据，为给定的模拟时间提供自由能的最小偏差和最小方差估计。正向和反向估计之间的差异也可以作为一种有用的、尽管不完美的收敛性诊断。仅依赖单侧的 Zwanzig 公式是一种糟糕的做法，很可能产生有偏差的结果，并且没有提供可靠的方法来评估计算的统计不确定性或系统误差。",
            "answer": "$$\\boxed{ABCDF H}$$"
        },
        {
            "introduction": "在了解了单步自由能微扰的陷阱之后，我们现在转向最前沿的解决方案：多态贝内特接受率（MBAR）方法。这个高级实践要求您推导并实现 MBAR 方程，以最佳方式整合来自多个中间态的数据。通过完成这个练习 ，您不仅将克服相空间重叠问题，还将学会如何计算稳健的自由能及其统计不确定性，这是现代计算化学的标志。",
            "id": "3847551",
            "problem": "你将获得一个从多个热力学态中抽取的样本集合，这些热力学态由 $k \\in \\{0,1,\\ldots,K-1\\}$ 索引，每个态都由一个约化势 $u_k(\\mathbf{x})$ 来表征。约化势的定义为 $u_k(\\mathbf{x}) = \\beta U_k(\\mathbf{x}) + \\text{在恒定热力学参数下的项}$，其中 $U_k(\\mathbf{x})$ 是势能。在下文中，你可以取 $\\beta = 1$（无量纲温度），并将所有约化势视为无量纲。目标是使用被称为多态 Bennett 接受率 (Multi-state Bennett Acceptance Ratio, MBAR) 的多态最大似然方法，根据汇集自多个态的数据，估计无量纲自由能 $f_k$（相差一个加性常数）。你必须推导、实现并应用相关的自洽方程以及一个数值稳定的迭代方案来计算自由能及其不确定度。\n\n从平衡统计力学和重要性采样的基础出发，仅使用以下核心事实：\n- 配分函数为 $Z_k = \\int d\\mathbf{x}\\, e^{-u_k(\\mathbf{x})}$，无量纲自由能为 $f_k = -\\ln Z_k$（相差一个加性常数）。\n- 样本是从对应于态 $k$ 的 $K$ 个平衡分布的混合体中抽取的，已知每个态的样本数 $N_k$ 和总样本数 $N = \\sum_{k=0}^{K-1} N_k$。\n- 重要性采样恒等式以及具有已知采样比例的混合模型的最大似然估计，可以导出用于最大化观测到的汇集数据似然的参数的自洽估计方程。\n- 最大似然估计量的渐近协方差由观测到的费雪信息（对数似然的负海森矩阵）的逆矩阵给出，该矩阵经过投影以消除由 $f_k$ 的加性规范不变性引起的任何不可辨识性。\n\n你的任务如下：\n- 推导 MBAR 自洽方程，这些方程根据所有态 $k$ 和汇集样本 $\\{\\mathbf{x}_n\\}_{n=1}^N$ 的约化势 $u_k(\\mathbf{x}_n)$ 以及已知的样本数 $N_k$，来确定 $K$ 个未知的自由能 $f_k$（定义上相差一个加性常数）。\n- 提出一个数值稳定的不动点迭代方案来求解这些方程。你的方案必须明确使用 log-sum-exp 技巧以确保数值稳定性，通过固定 $f_0 = 0$ 来强制执行参考规范，并包含一个基于 $f_k$ 的最大绝对变化小于用户指定容差的收敛准则。\n- 推导估计的 $f_k$ 的观测费雪信息，用解所隐含的态责任权重的形式表示，解释如何通过将信息矩阵约化到一个满秩子空间（例如，通过固定 $f_0 = 0$）来处理加性常数的不可辨识性，并获得自由能差 $\\Delta f_{k0} = f_k - f_0$ 的渐近标准误差。\n\n然后，实现一个完成以下任务的完整程序：\n- 使用 $\\beta = 1$ 的一维谐振子约化势构建合成测试数据。对于每个态 $k$，定义一个谐振子约化势 $u_k(x) = \\tfrac{1}{2}\\,k_{\\text{spring}}\\,(x - \\mu_k)^2$，并从相应的平衡分布 $p_k(x) \\propto \\exp\\!\\left[-u_k(x)\\right]$ 中抽取 $N_k$ 个独立样本 $x$，对于谐振子而言，该分布是均值为 $\\mu_k$、方差为 $1/k_{\\text{spring}}$ 的正态分布。\n- 从汇集的样本集合 $\\{x_n\\}_{n=1}^N$ 中，构建适用于所有 $k \\in \\{0,\\ldots,K-1\\}$ 和 $n \\in \\{1,\\ldots,N\\}$ 的完整约化势矩阵 $[u_k(x_n)]$。\n- 通过你提出的迭代方案求解 $f_k$ 的 MBAR 自洽方程，通过设置 $f_0 = 0$ 来固定参考态，计算 $k \\in \\{1,\\ldots,K-1\\}$ 的 $\\Delta f_{k0}$，并通过约化到可辨识子空间的观测费雪信息计算它们的渐近标准误差。\n\n科学真实性要求：\n- 假设所有样本都有效不相关，因此有效样本量因子为1。所有量均为无量纲；不需要物理单位。\n- 使用对近简并态具有鲁棒性的数值稳定实现。\n\n测试套件：\n你的程序必须运行以下三个案例，每个案例由态的数量 $K$、每个态的样本数 $\\{N_k\\}$、谐振子均值 $\\{\\mu_k\\}$、共同的弹簧常数 $k_{\\text{spring}}$ 和一个随机种子指定。对于每个案例，为每个态 $k$ 独立地从 $\\mathcal{N}(\\mu_k, 1/k_{\\text{spring}})$ 中精确抽取 $N_k$ 个样本，然后将各态的样本汇集起来。必须按指定的方式为随机数生成器设置种子以确保确定性。\n- 案例 1：$K = 2$，$\\{\\mu_k\\} = [-1.0, 1.0]$，$k_{\\text{spring}} = 5.0$，$\\{N_k\\} = [80, 80]$，种子 $= 246810$。\n- 案例 2：$K = 3$，$\\{\\mu_k\\} = [-1.0, 0.0, 1.5]$，$k_{\\text{spring}} = 4.0$，$\\{N_k\\} = [100, 10, 5]$，种子 $= 13579$。\n- 案例 3：$K = 2$，$\\{\\mu_k\\} = [0.0, 0.2]$，$k_{\\text{spring}} = 10.0$，$\\{N_k\\} = [50, 50]$，种子 $= 424242$。\n\n答案规范：\n- 对于每个案例，计算 $k \\in \\{1,\\ldots,K-1\\}$ 的自由能差 $\\Delta f_{k0}$ 及其从约化的观测费雪信息中获得的渐近标准误差 $s_{k0}$。所有输出均为无量纲浮点数。\n- 最终输出格式：你的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表形式的结果。对于上述顺序中的每个案例，将序列 $\\left[\\Delta f_{10}, s_{10}, \\Delta f_{20}, s_{20}, \\ldots, \\Delta f_{(K-1)0}, s_{(K-1)0}\\right]$ 追加到一个单一的扁平化列表中。每个浮点数在打印前必须四舍五入到恰好 $6$ 位小数。例如，一个有效的输出可能看起来像 $[\\ldots]$，其中所有条目都有 $6$ 位小数。",
            "solution": "用户提供了一个有效的问题陈述。任务是推导并实现多态 Bennett 接受率 (MBAR) 方法，用于从模拟数据中估计自由能差。这包括推导自由能的自洽方程，提出一种数值稳定的迭代解法，并推导估计的渐近误差公式。该实现将在由谐振子生成的合成数据上进行测试。\n\n### 1. MBAR自洽方程的推导\n\n我们从统计力学的基础开始。热力学态 $k$ 的配分函数由 $Z_k = \\int e^{-u_k(\\mathbf{x})} d\\mathbf{x}$ 给出，其中 $u_k(\\mathbf{x})$ 是系统在构型 $\\mathbf{x}$ 下的约化势能。无量纲自由能为 $f_k = -\\ln Z_k$，其定义相差一个取决于参考体积选择的加性常数。\n\n给定一个包含 $N$ 个构型的集合 $\\{\\mathbf{x}_n\\}_{n=1}^N$，这些构型从 $K$ 个不同的热力学态中抽取。对于每个态 $k \\in \\{0, \\ldots, K-1\\}$，我们有 $N_k$ 个样本，使得总样本数为 $N = \\sum_{k=0}^{K-1} N_k$。\n\nMBAR 方程提供了自由能的最小方差无偏估计。它们可以从多个角度推导得出，包括最大似然估计。一个直接的推导源于最优重要性采样原理。任何态 $i$ 的配分函数 $Z_i$ 可写为积分：\n$$\nZ_i = \\int e^{-u_i(\\mathbf{x})} d\\mathbf{x}\n$$\n我们可以通过对汇集样本 $\\{\\mathbf{x}_n\\}$ 进行重加权来估计此积分。对来自所有态的样本进行最优组合，可以得到以下关于 $Z_i$ 的自洽估计量：\n$$\n\\hat{Z}_i = \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j \\hat{Z}_j^{-1} e^{-u_j(\\mathbf{x}_n)}}\n$$\n该方程表明，配分函数 $\\hat{Z}_i$ 的估计是所有 $N$ 个样本的加权平均。每个样本 $\\mathbf{x}_n$ 都从其原生的“混合”系综重加权到目标系综 $i$。权重分母 $\\sum_j N_j \\hat{Z}_j^{-1} e^{-u_j(\\mathbf{x}_n)}$ 代表在所有 $K$ 个系综的混合体中观测到构型 $\\mathbf{x}_n$ 的未归一化概率密度。\n\n为了得到自由能 $f_k = -\\ln Z_k$ 的方程，我们将 $\\hat{Z}_k = e^{-\\hat{f}_k}$ 代入上述方程：\n$$\ne^{-\\hat{f}_i} = \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{\\hat{f}_j} e^{-u_j(\\mathbf{x}_n)}}\n$$\n整理后得到 MBAR 自洽方程的最终形式：\n$$\n\\hat{f}_i = -\\ln \\left( \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{\\hat{f}_j - u_j(\\mathbf{x}_n)}} \\right)\n$$\n这 $K$ 个耦合的非线性方程必须被求解，以得到 $K$ 个自由能 $\\hat{f}_0, \\ldots, \\hat{f}_{K-1}$。这些自由能仅能确定到一个任意的加性常数，因为将所有 $\\hat{f}_j$ 平移一个常数 $c$ 并不会改变方程。我们通过将一个自由能固定为参考值（通常为 $\\hat{f}_0 = 0$）来解决此问题。\n\n### 2. 数值稳定的不动点迭代方案\n\n该自洽方程可以使用不动点迭代法求解：\n$$\nf_i^{\\text{new}} = -\\ln \\left( \\sum_{n=1}^{N} \\frac{e^{-u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j^{\\text{old}} - u_j(\\mathbf{x}_n)}} \\right)\n$$\n由于存在浮点数上溢或下溢的风险，直接计算此形式中的指数在数值上是不稳定的。我们可以使用 log-sum-exp (LSE) 技巧构建一个稳定的方案，其中 $\\text{LSE}(\\mathbf{v}) = \\ln(\\sum_i e^{v_i})$。$f_i$ 的迭代更新可以重写为：\n$$\nf_i^{\\text{new}} = -\\ln \\left( \\sum_{n=1}^{N} \\exp\\left[ -u_i(\\mathbf{x}_n) - \\ln\\left(\\sum_{j=0}^{K-1} \\exp\\left[ \\ln N_j + f_j^{\\text{old}} - u_j(\\mathbf{x}_n) \\right]\\right) \\right] \\right)\n$$\n这个表达式是 LSE 的嵌套应用。我们来定义 LSE 函数的参数：\n- 对于内层 LSE（对每个样本 $n$ 遍历所有态 $j$）：$A_{jn} = \\ln N_j + f_j^{\\text{old}} - u_j(\\mathbf{x}_n)$。\n- 内层 LSE 的结果是每个样本的对数分母：$L_n = \\text{LSE}_j(A_{jn}) = \\ln(\\sum_j e^{A_{jn}})$。\n- 对于外层 LSE（对每个态 $i$ 遍历所有样本 $n$）：$B_{in} = -u_i(\\mathbf{x}_n) - L_n$。\n- 未平移的更新后自由能则为 $f'_i = -\\text{LSE}_n(B_{in}) = -\\ln(\\sum_n e^{B_{in}})$。\n\n计算出未平移的值 $f'_i$ 后，我们通过平移所有自由能来强制执行规范条件 $f_0=0$：\n$$\nf_i^{\\text{new}} = f'_i - f'_0 \\quad \\text{对于 } i \\in \\{0, \\ldots, K-1\\}\n$$\n这确保了 $f_0^{\\text{new}} = 0$。迭代过程从一个初始猜测（例如，对所有 $i$，$f_i=0$）开始，并重复更新，直到连续迭代之间任何自由能值的最大绝对变化小于指定的容差 $\\epsilon$：\n$$\n\\max_{i} |f_i^{\\text{new}} - f_i^{\\text{old}}|  \\epsilon\n$$\n\n### 3. 渐近误差估计\n\n估计的自由能 $\\hat{\\mathbf{f}}$ 的渐近协方差矩阵由观测到的费雪信息矩阵 $\\mathbf{I}$ 的逆矩阵给出。费雪信息是在最大似然估计处求值的对数似然函数的负海森矩阵。相关的对数似然函数（相差一个加性常数）为：\n$$\n\\ln \\mathcal{L}(\\mathbf{f}) = \\sum_{k=0}^{K-1} N_k f_k - \\sum_{n=1}^{N} \\ln\\left( \\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)} \\right)\n$$\n关于 $f_i$ 的一阶导数是：\n$$\n\\frac{\\partial \\ln \\mathcal{L}}{\\partial f_i} = N_i - \\sum_{n=1}^{N} \\frac{N_i e^{f_i - u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)}} = N_i - \\sum_{n=1}^{N} W_{in}\n$$\n其中 $W_{in}$ 是样本 $n$（从任何态中抽取）在热力学上属于态 $i$ 的概率：\n$$\nW_{in} = \\frac{N_i e^{f_i - u_i(\\mathbf{x}_n)}}{\\sum_{j=0}^{K-1} N_j e^{f_j - u_j(\\mathbf{x}_n)}}\n$$\n注意，对于任何样本 $n$，都有 $\\sum_{i=0}^{K-1} W_{in} = 1$。在最大似然解处，$\\frac{\\partial \\ln \\mathcal{L}}{\\partial f_i} = 0$，这意味着 $N_i = \\sum_{n=1}^N W_{in}$。\n\n海森矩阵元素 $H_{ij} = \\frac{\\partial^2 \\ln \\mathcal{L}}{\\partial f_i \\partial f_j}$ 为：\n$$\nH_{ij} = -\\sum_{n=1}^{N} \\frac{\\partial W_{in}}{\\partial f_j} = -\\sum_{n=1}^{N} (W_{in}\\delta_{ij} - W_{in}W_{jn})\n$$\n其中 $\\delta_{ij}$ 是克罗内克 δ (Kronecker delta)。观测到的费雪信息矩阵为 $\\mathbf{I} = -\\mathbf{H}$：\n$$\nI_{ij} = \\sum_{n=1}^{N} (W_{in}\\delta_{ij} - W_{in}W_{jn})\n$$\n这个 $K \\times K$ 矩阵是奇异的，反映了绝对自由能的不可辨识性。向量 $(1, 1, \\ldots, 1)^T$ 是一个零特征向量，因为 $\\sum_j I_{ij} = 0$。\n\n为获得一个非奇异矩阵，我们在相对于态 0 的自由能差的约化空间中进行操作，即 $\\Delta f_{k0} = f_k - f_0$，其中 $k \\in \\{1, \\ldots, K-1\\}$。这等价于设置 $f_0=0$ 并估计剩余的 $K-1$ 个自由能。这 $K-1$ 个参数的费雪信息矩阵是通过移除对应于态 0 的行和列从 $\\mathbf{I}$ 中得到的 $(K-1) \\times (K-1)$ 子矩阵：\n$$\n\\mathbf{I}_{\\text{red}} = (I_{ij})_{i,j \\in \\{1,\\ldots,K-1\\}}\n$$\n这个约化矩阵是可逆的。自由能差 $(\\Delta f_{10}, \\ldots, \\Delta f_{(K-1)0})$ 的协方差矩阵由其逆矩阵给出：\n$$\n\\mathbf{C} = \\mathbf{I}_{\\text{red}}^{-1}\n$$\n$\\Delta f_{k0}$ 估计的渐近标准误差是 $\\mathbf{C}$ 对应对角元素的平方根：\n$$\ns_{k0} = \\sqrt{C_{k-1, k-1}} \\quad \\text{对于 } k \\in \\{1, \\ldots, K-1\\}\n$$\n（对矩阵 $\\mathbf{C}$ 使用从0开始的索引）。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import logsumexp\n\ndef solve_mbar(u_kn, N_k, tol=1e-12, max_iter=10000):\n    \"\"\"\n    Solves the MBAR self-consistent equations for the free energies.\n\n    Args:\n        u_kn (np.ndarray): A KxN matrix of reduced potentials u_k(x_n).\n        N_k (np.ndarray): A K-element array of sample counts per state.\n        tol (float): The convergence tolerance.\n        max_iter (int): The maximum number of iterations.\n\n    Returns:\n        tuple: A tuple containing:\n            - f_k (np.ndarray): K-element array of estimated dimensionless free energies with f_0 = 0.\n            - df_k (np.ndarray): (K-1)-element array of standard errors for f_k - f_0.\n    \"\"\"\n    K, N = u_kn.shape\n    f_k = np.zeros(K, dtype=np.float64)\n    log_N_k = np.log(N_k)\n\n    for i in range(max_iter):\n        f_k_old = np.copy(f_k)\n\n        # Numerically stable calculation of new free energies\n        # A_kn = log(N_k) + f_k - u_kn\n        A_kn = log_N_k[:, np.newaxis] + f_k[:, np.newaxis] - u_kn\n        \n        # log_D_n = log(sum_k exp(A_kn))\n        log_D_n = logsumexp(A_kn, axis=0)\n        \n        # log [ exp(-u_kn) / D_n ] = -u_kn - log_D_n\n        log_term = -u_kn - log_D_n[np.newaxis, :]\n        \n        # f'_k = -log(sum_n exp(log_term))\n        f_k_new_unshifted = -logsumexp(log_term, axis=1)\n        \n        # Enforce gauge f_0 = 0\n        f_k = f_k_new_unshifted - f_k_new_unshifted[0]\n\n        if np.max(np.abs(f_k - f_k_old))  tol:\n            break\n    else:\n        raise RuntimeError(\"MBAR did not converge in {} iterations.\".format(max_iter))\n\n    # Calculate uncertainties\n    # A_kn = log(N_k) + f_k - u_kn for converged f_k\n    A_kn = log_N_k[:, np.newaxis] + f_k[:, np.newaxis] - u_kn\n    log_D_n = logsumexp(A_kn, axis=0)\n    \n    # W_kn = exp(A_kn) / D_n = exp(A_kn - log_D_n)\n    log_W_kn = A_kn - log_D_n[np.newaxis, :]\n    W_kn = np.exp(log_W_kn)\n\n    # Fisher information matrix I_ij = sum_n (W_in * delta_ij - W_in * W_jn)\n    # This can be written as I = diag(sum(W, axis=1)) - W @ W.T\n    I = np.diag(np.sum(W_kn, axis=1)) - W_kn @ W_kn.T\n\n    # Invert the reduced (K-1)x(K-1) Fisher information matrix\n    # for states 1..K-1 to get the covariance of (f_1-f_0, ..., f_{K-1}-f_0)\n    I_red = I[1:, 1:]\n    try:\n        C_red = np.linalg.inv(I_red)\n        df_k = np.sqrt(np.diag(C_red))\n    except np.linalg.LinAlgError:\n        # This can happen if states are not well-connected,\n        # but shouldn't for the given test cases.\n        df_k = np.full(K - 1, np.nan)\n\n    return f_k[1:], df_k\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        {'K': 2, 'mu_k': [-1.0, 1.0], 'k_spring': 5.0, 'N_k': [80, 80], 'seed': 246810},\n        {'K': 3, 'mu_k': [-1.0, 0.0, 1.5], 'k_spring': 4.0, 'N_k': [100, 10, 5], 'seed': 13579},\n        {'K': 2, 'mu_k': [0.0, 0.2], 'k_spring': 10.0, 'N_k': [50, 50], 'seed': 424242},\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        K = case['K']\n        mu_k = np.array(case['mu_k'])\n        k_spring = case['k_spring']\n        N_k = np.array(case['N_k'])\n        seed = case['seed']\n        \n        rng = np.random.default_rng(seed)\n\n        # 1. Generate synthetic data\n        samples_per_state = []\n        for k in range(K):\n            # Samples drawn from N(mu_k, sigma^2 = 1/k_spring)\n            std_dev = np.sqrt(1.0 / k_spring)\n            samples = rng.normal(loc=mu_k[k], scale=std_dev, size=N_k[k])\n            samples_per_state.append(samples)\n        \n        # Pool all samples\n        x_n = np.concatenate(samples_per_state)\n        N = x_n.shape[0]\n\n        # 2. Construct reduced potential matrix u_kn\n        # u_k(x_n) = 0.5 * k_spring * (x_n - mu_k)^2\n        u_kn = 0.5 * k_spring * (x_n[np.newaxis, :] - mu_k[:, np.newaxis])**2\n\n        # 3. Solve MBAR equations\n        f_k_diff, df_k_err = solve_mbar(u_kn, N_k)\n\n        # 4. Collect results for this case\n        case_results = []\n        for f, df in zip(f_k_diff, df_k_err):\n            case_results.extend([f, df])\n        all_results.extend(case_results)\n\n    # Format and print the final output\n    formatted_results = [f\"{x:.6f}\" for x in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}