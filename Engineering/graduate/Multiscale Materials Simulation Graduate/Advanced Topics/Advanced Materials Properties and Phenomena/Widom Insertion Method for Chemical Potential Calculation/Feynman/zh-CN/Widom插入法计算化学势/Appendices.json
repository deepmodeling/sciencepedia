{
    "hands_on_practices": [
        {
            "introduction": "在分子模拟中，为了提高计算效率，通常会对相互作用势进行截断。然而，这种截断会引入系统性偏差，影响计算结果的准确性。本练习 () 将指导您推导并估算由于Lennard-Jones势的截断而对过剩化学势造成的偏差。掌握这种分析方法对于评估模拟模型的保真度和理解长程校正的重要性至关重要。",
            "id": "3858611",
            "problem": "考虑一种用于多尺度材料模拟的均匀、各向同性、单组分原子流体。原子间通过 Lennard-Jones 对势相互作用，其能量参数为 $\\varepsilon$，长度参数为 $\\sigma$，$u(r)=4\\varepsilon\\left[(\\sigma/r)^{12}-(\\sigma/r)^{6}\\right]$。该系统采用球形截断半径 $r_{c}$ 进行模拟，忽略了超出 $r_{c}$ 的相互作用，并且省略了任何长程校正 (LRC)。过剩化学势 $\\mu^{\\mathrm{ex}}$ 通过称为 Widom 插入法的插入方法获得，该方法评估了向系统中添加一个测试粒子所需的自由能代价。\n\n从化学势的平衡统计力学定义和在大型均匀系统中添加测试粒子的 Boltzmann 权重出发，证明忽略超出 $r_{c}$ 的相互作用会使估计的过剩化学势产生偏差。在物理上标准的假设下，即对于 $r\\ge r_{c}$，(i) 径向分布函数 (RDF) $g(r)$ 近似为 $1$，以及 (ii) 内部区域 $r  r_c$ 和外部区域 $r > r_c$ 之间的插入能的波动是解耦的。使用这些假设，推导出所计算的过剩化学势的偏差，并为 $r_c = 3.5 \\text{ Å}$，$\\sigma = 2.5 \\text{ Å}$，$\\rho = 0.0210 \\text{ atoms}/\\text{Å}^3$，$\\epsilon/k_B = 120 \\text{ K}$，$T=300 \\text{ K}$ 估算该偏差（以 $k_B T$ 为单位）。报告一个无量纲的值。",
            "solution": "该问题要求我们首先推导在使用 Widom 插入法计算过剩化学势时，由于对势被截断而产生的偏差的表达式，然后在一系列特定的近似和条件下估计该偏差的大小。\n\n过剩化学势 $\\mu^{\\mathrm{ex}}$ 定义为在恒定体积 $V$ 和温度 $T$ 下，将一个测试粒子插入一个包含 $N$ 个粒子的系统所需的功。在 Widom 插入法的框架内，其表达式为：\n$$\n\\mu^{\\mathrm{ex}} = -k_B T \\ln \\langle \\exp(-\\beta \\Delta U) \\rangle_{N,V,T}\n$$\n其中 $k_B$ 是 Boltzmann 常数，$T$ 是绝对温度，$\\beta \\equiv 1/(k_B T)$，$\\Delta U$ 是测试粒子与系统中已有的 $N$ 个粒子之间的相互作用能。尖括号 $\\langle \\dots \\rangle_{N,V,T}$ 表示对 $N$ 个粒子的所有构型进行的正则系综平均。\n\n相互作用能 $\\Delta U$ 是测试粒子与所有其他粒子之间对相互作用的总和：\n$$\n\\Delta U = \\sum_{i=1}^{N} u(r_i)\n$$\n其中 $r_i$ 是测试粒子与粒子 $i$ 之间的距离。\n\n在采用截断势的模拟中，当 $r > r_c$ 时，对势 $u(r)$ 被设为零。计算出的过剩化学势，我们记为 $\\mu^{\\mathrm{ex}}_{\\text{trunc}}$，是基于这个截断的相互作用能 $\\Delta U_{\\text{trunc}}$：\n$$\n\\Delta U_{\\text{trunc}} = \\sum_{i=1}^{N} u_{\\text{trunc}}(r_i) \\quad \\text{其中} \\quad u_{\\text{trunc}}(r) = \\begin{cases} u(r)  r \\le r_c \\\\ 0  r > r_c \\end{cases}\n$$\n$$\n\\mu^{\\mathrm{ex}}_{\\text{trunc}} = -k_B T \\ln \\langle \\exp(-\\beta \\Delta U_{\\text{trunc}}) \\rangle\n$$\n真实的过剩化学势 $\\mu^{\\mathrm{ex}}_{\\text{full}}$ 对应于完整的、未截断的势。我们可以将总相互作用能 $\\Delta U$ 分解为来自截断半径内部的贡献 $\\Delta U_{\\text{in}}$ 和来自截断半径外部的贡献 $\\Delta U_{\\text{out}}$：\n$$\n\\Delta U = \\Delta U_{\\text{in}} + \\Delta U_{\\text{out}} = \\sum_{i: r_i \\le r_c} u(r_i) + \\sum_{i: r_i > r_c} u(r_i)\n$$\n注意 $\\Delta U_{\\text{trunc}} = \\Delta U_{\\text{in}}$。因此，我们有：\n$$\n\\exp(-\\beta \\mu^{\\mathrm{ex}}_{\\text{trunc}}) = \\langle \\exp(-\\beta \\Delta U_{\\text{in}}) \\rangle\n$$\n$$\n\\exp(-\\beta \\mu^{\\mathrm{ex}}_{\\text{full}}) = \\langle \\exp(-\\beta (\\Delta U_{\\text{in}} + \\Delta U_{\\text{out}})) \\rangle\n$$\n问题陈述了内部区域 ($r  r_c$) 和外部区域 ($r > r_c$) 之间的插入能的波动是解耦的，这意味着我们可以将系综平均近似为：\n$$\n\\langle \\exp(-\\beta (\\Delta U_{\\text{in}} + \\Delta U_{\\text{out}})) \\rangle \\approx \\langle \\exp(-\\beta \\Delta U_{\\text{in}}) \\rangle \\langle \\exp(-\\beta \\Delta U_{\\text{out}}) \\rangle\n$$\n将此近似代入，我们得到：\n$$\n\\exp(-\\beta \\mu^{\\mathrm{ex}}_{\\text{full}}) \\approx \\exp(-\\beta \\mu^{\\mathrm{ex}}_{\\text{trunc}}) \\langle \\exp(-\\beta \\Delta U_{\\text{out}}) \\rangle\n$$\n$$\n\\mu^{\\mathrm{ex}}_{\\text{full}} - \\mu^{\\mathrm{ex}}_{\\text{trunc}} \\approx -k_B T \\ln \\langle \\exp(-\\beta \\Delta U_{\\text{out}}) \\rangle\n$$\n由于 $r_c$ 之外的相互作用通常较弱，$\\beta \\Delta U_{\\text{out}}$ 预计会很小。因此，我们可以对指数项进行一阶泰勒展开：$\\langle \\exp(-\\beta \\Delta U_{\\text{out}}) \\rangle \\approx 1 - \\beta \\langle \\Delta U_{\\text{out}} \\rangle$。然后，我们对对数项进行泰勒展开 $\\ln(1-x) \\approx -x$：\n$$\n\\mu^{\\mathrm{ex}}_{\\text{full}} - \\mu^{\\mathrm{ex}}_{\\text{trunc}} \\approx -k_B T (-\\beta \\langle \\Delta U_{\\text{out}} \\rangle) = \\langle \\Delta U_{\\text{out}} \\rangle\n$$\n因此，估计的过剩化学势的偏差为 $\\mu^{\\mathrm{ex}}_{\\text{trunc}} - \\mu^{\\mathrm{ex}}_{\\text{full}} \\approx -\\langle \\Delta U_{\\text{out}} \\rangle$。\n我们现在需要计算 $\\langle \\Delta U_{\\text{out}} \\rangle$。这是将一个测试粒子插入系统时，其与 $r > r_c$ 之外所有粒子相互作用能的系综平均值。对于均匀系统，这可以写成积分形式：\n$$\n\\langle \\Delta U_{\\text{out}} \\rangle = \\int_{r_c}^{\\infty} u(r) \\rho g(r) 4\\pi r^2 dr\n$$\n其中 $\\rho$ 是粒子数密度，$g(r)$ 是径向分布函数。\n根据问题中的假设，$g(r) \\approx 1$ for $r \\ge r_c$。代入 Lennard-Jones 势的表达式：\n$$\n\\langle \\Delta U_{\\text{out}} \\rangle \\approx \\rho \\int_{r_c}^{\\infty} 4\\varepsilon \\left[ \\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^{6} \\right] 4\\pi r^2 dr\n$$\n$$\n\\langle \\Delta U_{\\text{out}} \\rangle \\approx 16\\pi\\rho\\varepsilon \\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr\n$$\n计算积分：\n$$\n\\int_{r_c}^{\\infty} \\left( \\sigma^{12}r^{-10} - \\sigma^6 r^{-4} \\right) dr = \\left[ \\sigma^{12} \\frac{r^{-9}}{-9} - \\sigma^6 \\frac{r^{-3}}{-3} \\right]_{r_c}^{\\infty} = 0 - \\left( -\\frac{\\sigma^{12}}{9r_c^9} + \\frac{\\sigma^6}{3r_c^3} \\right) = \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3}\n$$\n因此，我们得到：\n$$\n\\langle \\Delta U_{\\text{out}} \\rangle \\approx 16\\pi\\rho\\varepsilon \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\n我们所求的偏差是 $\\mu^{\\mathrm{ex}}_{\\text{trunc}} - \\mu^{\\mathrm{ex}}_{\\text{full}} \\approx -\\langle \\Delta U_{\\text{out}} \\rangle$。\n最后，我们代入给定值进行数值计算：\n$\\rho = 0.0210 \\text{ Å}^{-3}$, $\\sigma = 2.5 \\text{ Å}$, $r_c = 3.5 \\text{ Å}$, $\\varepsilon/k_B = 120 \\text{ K}$, $T = 300 \\text{ K}$。\n$\\varepsilon/(k_B T) = 120/300 = 0.4$。\n计算括号中的项：\n$$\n\\frac{\\sigma^{12}}{9r_c^9} = \\frac{2.5^{12}}{9 \\cdot 3.5^9} \\approx \\frac{5.960 \\times 10^6}{9 \\cdot (4.262 \\times 10^7)} \\approx \\frac{5.960 \\times 10^6}{3.836 \\times 10^8} \\approx 0.01554 \\text{ Å}^3\n$$\n$$\n\\frac{\\sigma^6}{3r_c^3} = \\frac{2.5^6}{3 \\cdot 3.5^3} \\approx \\frac{244.14}{3 \\cdot 42.875} \\approx \\frac{244.14}{128.625} \\approx 1.8980 \\text{ Å}^3\n$$\n括号内的值为 $0.01554 - 1.8980 = -1.88246 \\text{ Å}^3$。\n以 $k_B T$ 为单位的偏差为：\n$$\n\\frac{\\mu^{\\mathrm{ex}}_{\\text{trunc}} - \\mu^{\\mathrm{ex}}_{\\text{full}}}{k_B T} \\approx -\\frac{\\langle \\Delta U_{\\text{out}} \\rangle}{k_B T} \\approx -16\\pi\\rho \\frac{\\varepsilon}{k_B T} \\left( \\frac{\\sigma^{12}}{9r_c^9} - \\frac{\\sigma^6}{3r_c^3} \\right)\n$$\n$$\n\\approx -16\\pi(0.0210)(0.4)(-1.88246) \\approx - (1.0556)(0.4)(-1.88246) \\approx -(0.4222)(-1.88246) \\approx 0.7948\n$$\n因此，该偏差约为 $0.7948$。",
            "answer": "$$\\boxed{0.7948}$$"
        },
        {
            "introduction": "在解决了模型的系统性偏差之后，我们必须面对统计误差。分子模拟产生的构型在时间上是相关的，这使得基于独立同分布假设的标准误差公式失效。本练习 () 介绍分块平均法，这是一种处理相关数据系列、监控模拟收敛性并稳健估计统计不确定性的标准技术。这对于报告可靠的模拟结果及其置信区间至关重要。",
            "id": "3858645",
            "problem": "在温度为 $T$ 的正则系综中，Widom 测试粒子插入框架通过玻尔兹曼加权可观测量的平衡平均值来估算过剩化学势。考虑可观测量 $X \\equiv \\exp(-\\beta \\Delta U)$，其中 $\\Delta U$ 是将一个无相互作用的测试粒子插入到从正则分布中抽取的构型时所产生的瞬时能量变化，并且 $\\beta \\equiv 1/(k_{B} T)$，其中 $k_{B}$ 是玻尔兹曼常数。在均匀流体的平衡轨道中，您以均匀的时间间隔收集了 $N$ 个连续样本 $\\{X_{i}\\}_{i=1}^{N}$。由于连续样本是相关的，您将使用分块平均法来监测收敛性并估算 $\\langle X \\rangle$ 的统计误差。\n\n从正则系综期望值的定义和遍历性假设出发，并引用适用于分块级别的弱相关平稳时间序列的中心极限定理（CLT），推导如何构建 $\\langle X \\rangle$ 的分块平均估计量及其标准误差。然后，将您的推导应用于以下从温度 $T$ 下的分子模拟中获得的 $N=24$ 个 $X=\\exp(-\\beta \\Delta U)$ 的测量值数据集（这些值为无量纲）：\n$0.120,\\, 0.085,\\, 0.102,\\, 0.095,\\, 0.110,\\, 0.090,\\; 0.070,\\, 0.130,\\, 0.088,\\, 0.112,\\, 0.105,\\, 0.098,\\; 0.095,\\, 0.104,\\, 0.099,\\, 0.101,\\, 0.097,\\, 0.100,\\; 0.092,\\, 0.108,\\, 0.085,\\, 0.115,\\, 0.103,\\, 0.107.$\n\n假设按顺序将数据分组为 $M=4$ 个大小相等的连续数据块（$B=6$），可以得到近似独立的块均值。计算：\n- $M$ 个块均值，\n- $\\langle X \\rangle$ 的总分块平均估计量，\n- 根据块均值之间的变异性计算该估计量的标准误差，\n- 在 1、2、3 和 4 个数据块之后计算累积的分块平均估计值，以监测收敛性。\n\n最后，将 $\\langle \\exp(-\\beta \\Delta U) \\rangle$ 的分块平均估计值报告为一个四舍五入到六位有效数字的单一数值。最终报告的数值是无量纲的，并且应不带任何单位。",
            "solution": "该问题提法明确，具有科学依据，并包含了获得唯一解所需的所有信息。所要求的步骤，即 Widom 插入法和分块平均法，是计算统计力学中的标准和基本技术。\n\n第1部分：分块平均法的理论推导\n\n在正则（$NVT$）系综中，物理可观测量 $X$ 的期望值定义为系综平均：\n$$\n\\langle X \\rangle = \\frac{\\int X(\\mathbf{r}^N, \\mathbf{p}^N) \\exp(-\\beta H(\\mathbf{r}^N, \\mathbf{p}^N)) d\\mathbf{r}^N d\\mathbf{p}^N}{\\int \\exp(-\\beta H(\\mathbf{r}^N, \\mathbf{p}^N)) d\\mathbf{r}^N d\\mathbf{p}^N}\n$$\n其中 $H$ 是 $N$ 粒子系统的哈密顿量，$\\mathbf{r}^N$ 和 $\\mathbf{p}^N$ 分别是粒子坐标和动量的集合，$\\beta = 1/(k_B T)$。对于像 $X = \\exp(-\\beta \\Delta U)$ 这样依赖于构型的可观测量，这可以简化为对构型空间的平均。\n\n分子模拟（如分子动力学或蒙特卡洛方法）生成一系列从该系综中抽样的系统构型。根据遍历性假设，系综平均 $\\langle X \\rangle$ 可以通过对长轨迹的时间平均来近似。给定从平衡模拟中收集的 $N_{s}$ 个连续样本 $\\{X_i\\}_{i=1}^{N_{s}}$，$\\langle X \\rangle$ 的估计量是样本均值：\n$$\n\\bar{X}_{N_{s}} = \\frac{1}{N_{s}} \\sum_{i=1}^{N_{s}} X_i\n$$\n\n一个关键问题是，连续样本 $X_i$ 和 $X_{i+1}$ 通常是相关的，因为系统构型在一个时间步内不会发生剧烈变化。这种相关性意味着用于独立样本均值误差的标准公式 $\\sigma_X / \\sqrt{N_{s}}$ 不再适用。真实的不确定性比这个朴素公式所建议的要大。\n\n分块平均法是在存在此类相关性时估算统计不确定性的稳健方法。其步骤如下：\n1. 将总共 $N_{s}$ 个数据点序列划分为 $M$ 个连续、不重叠的数据块，每个数据块的大小为 $B$。我们必须有 $N_s = M \\times B$。\n2. 对每个数据块 $j$（其中 $j = 1, 2, ..., M$），计算块均值：\n$$\n\\bar{X}_j^{(B)} = \\frac{1}{B} \\sum_{i=(j-1)B+1}^{jB} X_i\n$$\n3. $\\langle X \\rangle$ 的总估计量，即分块平均估计量，是这些块均值的平均值。这在数值上等同于对所有 $N_s$ 个数据点的简单平均：\n$$\n\\bar{X}_{M,B} = \\frac{1}{M} \\sum_{j=1}^{M} \\bar{X}_j^{(B)} = \\frac{1}{M} \\sum_{j=1}^{M} \\left( \\frac{1}{B} \\sum_{i=(j-1)B+1}^{jB} X_i \\right) = \\frac{1}{MB} \\sum_{i=1}^{N_s} X_i = \\bar{X}_{N_s}\n$$\n4. 关键步骤是误差估计。如果选择的数据块大小 $B$ 远大于数据序列 $\\{X_i\\}$ 的相关时间 $\\tau_c$，那么块均值 $\\{\\bar{X}_j^{(B)}\\}$ 可以被视为近似独立同分布（i.i.d.）的随机变量。\n5. 对这 $M$ 个块均值应用中心极限定理（CLT），我们可以将它们视为从一个正态分布中抽取的 $M$ 个独立样本，该分布的均值就是我们感兴趣的量 $\\langle X \\rangle$。然后，我们可以将标准统计公式应用于这组块均值来计算均值的误差。\n6. 首先，我们计算块均值的样本方差，记为 $s_{\\text{block}}^2$：\n$$\ns_{\\text{block}}^2 = \\frac{1}{M-1} \\sum_{j=1}^{M} \\left(\\bar{X}_j^{(B)} - \\bar{X}_{M,B}\\right)^2\n$$\n使用因子 $M-1$（Bessel 校正）是因为我们是从样本中估计总体方差。\n7. 那么总均值估计量 $\\bar{X}_{M,B}$ 的方差可估计为 $\\frac{s_{\\text{block}}^2}{M}$。\n8. 分块平均估计量 $\\bar{X}_{M,B}$ 的标准误差是该方差的平方根：\n$$\nSE(\\bar{X}_{M,B}) = \\sqrt{\\frac{s_{\\text{block}}^2}{M}} = \\frac{s_{\\text{block}}}{\\sqrt{M}} = \\sqrt{\\frac{1}{M(M-1)} \\sum_{j=1}^{M} \\left(\\bar{X}_j^{(B)} - \\bar{X}_{M,B}\\right)^2}\n$$\n只要独立块均值的假设成立，这就为均值的不确定性提供了一个统计上可靠的估计。\n\n第2部分：应用于所提供的数据\n\n问题提供了可观测量 $X = \\exp(-\\beta \\Delta U)$ 的 $N=24$ 个数据点。这些数据点将被分组为 $M=4$ 个块，每个块的大小为 $B=6$。\n\n数据集为：\n$0.120, 0.085, 0.102, 0.095, 0.110, 0.090$\n$0.070, 0.130, 0.088, 0.112, 0.105, 0.098$\n$0.095, 0.104, 0.099, 0.101, 0.097, 0.100$\n$0.092, 0.108, 0.085, 0.115, 0.103, 0.107$\n\n问题要求进行四项具体计算。\n\n1. $M$ 个块均值, $\\bar{X}_j^{(B)}$：\n块 1: $\\bar{X}_1^{(6)} = \\frac{1}{6}(0.120+0.085+0.102+0.095+0.110+0.090) = \\frac{0.602}{6} \\approx 0.100333$\n块 2: $\\bar{X}_2^{(6)} = \\frac{1}{6}(0.070+0.130+0.088+0.112+0.105+0.098) = \\frac{0.603}{6} = 0.1005$\n块 3: $\\bar{X}_3^{(6)} = \\frac{1}{6}(0.095+0.104+0.099+0.101+0.097+0.100) = \\frac{0.596}{6} \\approx 0.099333$\n块 4: $\\bar{X}_4^{(6)} = \\frac{1}{6}(0.092+0.108+0.085+0.115+0.103+0.107) = \\frac{0.610}{6} \\approx 0.101667$\n\n2. $\\langle X \\rangle$ 的总分块平均估计量, $\\bar{X}_{M,B}$：\n这是块均值的平均值，或者更简单地说，是所有 $N=24$ 个数据点的平均值。\n所有数据点的总和是块总和的总和：$S_{total} = 0.602 + 0.603 + 0.596 + 0.610 = 2.411$。\n$$\n\\bar{X}_{4,6} = \\frac{2.411}{24} \\approx 0.100458333...\n$$\n\n3. 该估计量的标准误差, $SE(\\bar{X}_{4,6})$：\n使用上面推导的公式，其中 $M=4$：\n$$\nSE(\\bar{X}_{4,6}) = \\sqrt{\\frac{1}{4(4-1)} \\sum_{j=1}^{4} \\left(\\bar{X}_j^{(6)} - \\bar{X}_{4,6}\\right)^2}\n$$\n首先，计算块均值的样本方差, $s_{\\text{block}}^2$：\n$$\ns_{\\text{block}}^2 = \\frac{1}{3} \\left[ (0.100333... - 0.1004583...)^2 + (0.1005 - 0.1004583...)^2 + (0.099333... - 0.1004583...)^2 + (0.101667... - 0.1004583...)^2 \\right]\n$$\n为精确起见，我们使用精确分数。$\\bar{X}_1^{(6)}=\\frac{0.602}{6}$, $\\bar{X}_2^{(6)}=\\frac{0.603}{6}$, $\\bar{X}_3^{(6)}=\\frac{0.596}{6}$, $\\bar{X}_4^{(6)}=\\frac{0.610}{6}$，以及 $\\bar{X}_{4,6}=\\frac{2.411}{24}$。\n块总和与其均值 $(\\bar{S} = 2.411/4 = 0.60275)$ 的平方偏差之和更简单：\n$\\sum_{j=1}^4 (S_j - \\bar{S})^2 = (0.602-0.60275)^2 + (0.603-0.60275)^2 + (0.596-0.60275)^2 + (0.610-0.60275)^2$\n$= (-0.00075)^2 + (0.00025)^2 + (-0.00675)^2 + (0.00725)^2$\n$= 5.625 \\times 10^{-7} + 6.25 \\times 10^{-8} + 4.55625 \\times 10^{-5} + 5.25625 \\times 10^{-5} = 9.875 \\times 10^{-5}$。\n$s_{\\text{block}}^2 = \\frac{1}{M-1} \\sum (\\frac{S_j}{B} - \\frac{\\bar{S}}{B})^2 = \\frac{1}{(M-1)B^2} \\sum (S_j - \\bar{S})^2 = \\frac{9.875 \\times 10^{-5}}{(3)(6^2)} = \\frac{9.875 \\times 10^{-5}}{108} \\approx 9.1435 \\times 10^{-7}$。\n标准误差为：\n$$\nSE(\\bar{X}_{4,6}) = \\sqrt{\\frac{s_{\\text{block}}^2}{M}} = \\sqrt{\\frac{9.1435 \\times 10^{-7}}{4}} = \\sqrt{2.285875 \\times 10^{-7}} \\approx 0.0004781\n$$\n\n4. 累积的分块平均估计值：\n这是在每个完整数据块之后计算的可观测量的移动平均值。\n经过 $k$ 个数据块后，累积估计值 $\\bar{X}_{cum, k}$ 是前 $k \\times B$ 个数据点的平均值。\n$k=1$: $\\bar{X}_{cum, 1} = \\bar{X}_1^{(6)} = \\frac{0.602}{6} \\approx 0.100333$\n$k=2$: $\\bar{X}_{cum, 2} = \\frac{0.602 + 0.603}{12} = \\frac{1.205}{12} \\approx 0.100417$\n$k=3$: $\\bar{X}_{cum, 3} = \\frac{0.602 + 0.603 + 0.596}{18} = \\frac{1.801}{18} \\approx 0.100056$\n$k=4$: $\\bar{X}_{cum, 4} = \\frac{0.602 + 0.603 + 0.596 + 0.610}{24} = \\frac{2.411}{24} \\approx 0.100458$\n\n最终的分块平均估计值是处理完所有数据块后的值，即 $\\bar{X}_{4,6}$。将其四舍五入到六位有效数字，得到 $0.100458$。\n根据这些计算，最终报告的 $\\langle \\exp(-\\beta \\Delta U) \\rangle$ 的值为 $0.100458$。",
            "answer": "$$\n\\boxed{0.100458}\n$$"
        },
        {
            "introduction": "最后一个挑战来自计算的底层——数值稳定性。在Widom方法中，玻尔兹曼因子 $\\exp(-\\beta \\Delta U)$ 的值可能跨越许多数量级，尤其是在致密相中，这很容易导致标准浮点运算出现上溢或下溢。本练习 () 探讨了一种避免这些数值陷阱的算法。通过辨别正确的数值稳定累积方案，您将学会如何实现精确且可靠的计算，这是任何严肃的科学计算软件开发的核心要求。",
            "id": "3858603",
            "problem": "在温度为 $T$ 的稠密液体的正则系综中，可以通过多尺度材料模拟中与介观尺度描述耦合的原子模型采样的随机测试粒子插入来估计稀溶质的过剩化学势。每次插入都会产生一个相互作用能变化 $\\Delta U_i$，其中 $i=1,\\dots,M$，$M$ 是独立插入的次数，$\\beta = 1/(k_B T)$，$k_B$ 是玻尔兹曼常数。在稠密相中，插入能量的范围通常很宽，例如 $\\Delta U_i \\in [-10 k_B T, 50 k_B T]$，因此在有限精度算术下，$\\exp(-\\beta \\Delta U_i)$ 可能会发生下溢或上溢。\n\n您的任务是以流式方式（一次处理一个 $\\Delta U_i$）从样本 $\\{\\Delta U_i\\}_{i=1}^M$ 计算量 $L = \\ln \\langle e^{-\\beta \\Delta U} \\rangle$，并满足双重要求：(i) 对于大的 $M$ 和变化范围宽的 $\\Delta U_i$，算法在数值上对上溢和下溢是稳定的；(ii) 算法是精确的，即在有限样本上产生与理想算术相同的结果（无近似偏差）。令 $a_i = -\\beta \\Delta U_i$（$i=1,\\dots,M$），并用 $\\ln$ 表示自然对数。\n\n以下哪种算法规定同时满足这两个要求？\n\nA. 在实数算术中累加朴素和：初始化 $S = 0$，对每个 $i$ 设置 $S \\leftarrow S + e^{a_i}$；最后计算 $L = \\ln(S) - \\ln(M)$。\n\nB. 使用以运行时最大值为锚点的对数-和-指数累加：维护 $m$（$a_i$ 的运行时最大值）和 $s$（重缩放的和）。初始化 $m = -\\infty$ 和 $s = 0$。对于每个 $i$：\n- 如果 $a_i > m$，设置 $s \\leftarrow e^{m - a_i} s + 1$，然后设置 $m \\leftarrow a_i$。\n- 否则设置 $s \\leftarrow s + e^{a_i - m}$。\n最后计算 $L = m + \\ln(s) - \\ln(M)$。\n\nC. 按运行时算术平均值中心化：维护 $\\mu$（$a_i$ 的运行时均值）和 $s_c$（中心化的和）。初始化 $\\mu = 0$ 和 $s_c = 0$。对于每个 $i$，使用标准运行时均值公式更新 $\\mu$，并设置 $s_c \\leftarrow s_c + e^{a_i - \\mu}$。最后计算 $L = \\mu + \\ln(s_c) - \\ln(M)$。\n\nD. 对指数项应用补偿求和（Kahan 求和）：初始化 $S = 0$ 和补偿项 $C = 0$。对于每个 $i$，构造 $y = e^{a_i} - C$, $t = S + y$，并更新 $C \\leftarrow (t - S) - y$, $S \\leftarrow t$；最后计算 $L = \\ln(S) - \\ln(M)$。\n\nE. 使用二阶累积量近似：计算样本均值 $\\bar{a} = \\frac{1}{M} \\sum_{i=1}^M a_i$ 和方差 $\\sigma_a^2 = \\frac{1}{M} \\sum_{i=1}^M (a_i - \\bar{a})^2$，然后设置 $L \\approx \\bar{a} + \\frac{1}{2} \\sigma_a^2$。\n\n选择所有满足 (i) 和 (ii) 的选项。",
            "solution": "正则系综中稀溶质的过剩化学势可以与包含 $N$ 和 $N+1$ 个粒子的系统的配分函数之比相关联。设 $Z_N$ 表示 $N$ 个粒子的构型配分函数，$Z_{N+1}$ 表示 $N+1$ 个粒子的构型配分函数。在固定体积和温度下，当溶质在插入前是不可区分且无相互作用时，化学势 $\\mu$ 定义为 $\\mu = -k_B T \\ln(Z_{N+1}/Z_N)$。对于一个插入到从 $N$ 粒子系统的玻尔兹曼分布中采样的溶剂构型 $\\mathbf{R}$ 中的测试粒子，在尝试插入位置 $\\mathbf{r}$ 时，插入引起的能量增量变化为 $\\Delta U(\\mathbf{R}, \\mathbf{r})$，对 $\\exp(-\\beta \\Delta U)$ 在所有溶剂构型和插入位置上取平均，得到\n$$\n\\mu^{\\mathrm{ex}} = - k_B T \\ln \\left\\langle e^{-\\beta \\Delta U} \\right\\rangle,\n$$\n其中尖括号表示系综平均。在实践中，对于 $\\Delta U_i$ 的 $M$ 个独立样本，有限样本上 $L = \\ln \\langle e^{-\\beta \\Delta U} \\rangle$ 的估计量为\n$$\nL_{\\mathrm{sample}} = \\ln\\left(\\frac{1}{M} \\sum_{i=1}^M e^{a_i}\\right), \\quad a_i = -\\beta \\Delta U_i.\n$$\n数值计算的挑战在于，当 $a_i$ 的范围很宽时，$e^{a_i}$ 在有限精度下可能会下溢或上溢，并且如果和由极端项主导，则可能会损失精度。为了在有限算术中精确地解决这个问题，可以使用对数-和-指数恒等式：\n$$\n\\ln\\left(\\sum_{i=1}^M e^{a_i}\\right) = m + \\ln\\left(\\sum_{i=1}^M e^{a_i - m}\\right),\n$$\n其中 $m = \\max_{1 \\le i \\le M} a_i$。这个恒等式在代数上是精确的。通过选择 $m$ 为最大值，每一项 $e^{a_i - m}$ 都位于 $(0, 1]$ 区间内，从而防止上溢，并对大的负值 $a_i$ 最小化下溢。那么，样本量为\n$$\nL_{\\mathrm{sample}} = m + \\ln\\left(\\sum_{i=1}^M e^{a_i - m}\\right) - \\ln(M).\n$$\n在流式计算中，我们事先不知道 $m$，但我们可以一致地维护当前最大值 $m$ 和一个重缩放的和 $s = \\sum e^{a_i - m}$。假设处理完 $k-1$ 项后，我们有 $m_{k-1}$ 和 $s_{k-1} = \\sum_{i=1}^{k-1} e^{a_i - m_{k-1}}$。对于一个新的 $a_k$：\n- 如果 $a_k \\le m_{k-1}$，则令 $m_k = m_{k-1}$，我们可以更新 $s_k = s_{k-1} + e^{a_k - m_k}$。\n- 如果 $a_k  m_{k-1}$，则新的最大值为 $m_k = a_k$。先前累积的和必须被重缩放：因为\n$$\n\\sum_{i=1}^{k-1} e^{a_i - m_k} = \\sum_{i=1}^{k-1} e^{a_i - m_{k-1}} \\, e^{m_{k-1} - m_k} = s_{k-1} \\, e^{m_{k-1} - m_k},\n$$\n我们设置 $s_k = s_{k-1} e^{m_{k-1} - m_k} + e^{a_k - m_k} = s_{k-1} e^{m_{k-1} - a_k} + 1$。\n这种流式更新保留了 $\\sum e^{a_i - m}$ 的精确代数值，同时保证了指数函数的参数都 $\\le 0$，这在数值上是安全的。处理完所有 $M$ 个样本后，我们得到 $m = m_M$，$s = s_M$，以及精确的有限样本值\n$$\nL_{\\mathrm{sample}} = m + \\ln(s) - \\ln(M).\n$$\n我们现在来分析这些选项。\n\n选项 A：该方法直接累加 $S = \\sum e^{a_i}$，然后计算 $L = \\ln(S) - \\ln(M)$。虽然在代数上是精确的，但在数值上不稳定，因为当 $a_i$ 是大的正数时，$e^{a_i}$ 会上溢；当 $a_i$ 是大的负数时，$e^{a_i}$ 会下溢为零。并且，当组合数量级差异巨大的数时，求和会遭受灾难性抵消。这不满足要求 (i)。结论：不正确。\n\n选项 B：该方法实现了以运行时最大值为锚点的对数-和-指数恒等式，并在流式更新中进行了正确的重缩放：\n- 如果一个新的 $a_i$ 超过当前的 $m$，先前的和将乘以 $e^{m - a_i}$，并为新项加上 $1$，然后将 $m$ 设置为 $a_i$。\n- 否则，加上 $e^{a_i - m}$。\n这可以精确地维护 $s = \\sum e^{a_i - m}$，并确保所有指数函数的参数都 $\\le 0$，从而将它们的值限制在 $(0, 1]$ 区间内，避免了上溢并最小化了下溢。最终的 $L = m + \\ln(s) - \\ln(M)$ 在代数上与 $\\ln((1/M)\\sum e^{a_i})$ 等价。它同时满足要求 (i) 和 (ii)。结论：正确。\n\n选项 C：按运行时算术平均值中心化使用 $L = \\mu + \\ln\\left(\\sum e^{a_i - \\mu}\\right) - \\ln(M)$，这对于任何常数 $\\mu$ 都是代数上精确的；因此，如果 $\\mu$ 已知且固定，该恒等式将成立。然而，使用运行时均值 $\\mu$ 会引入数值风险：指数参数 $a_i - \\mu$ 不保证 $\\le 0$，并且在重尾或偏斜样本中，$\\mu$ 可能滞后于真实的中心趋势，产生大的正值 $a_i - \\mu$ 和潜在的上溢。此外，在累加 $s_c$ 的同时更新 $\\mu$ 需要在 $\\mu$ 每次变化时对先前累积的中心化和进行重缩放；所给的规定在更新 $\\mu$ 时没有重缩放 $s_c$，因此 $s_c$ 不再等于使用当前 $\\mu$ 的 $\\sum e^{a_i - \\mu}$，除非应用额外的校正，否则破坏了精确性。因此，按其写法，它不能保证避免上溢，并且在流式形式下不精确。结论：不正确。\n\n选项 D：补偿求和（Kahan 求和）在对不同数量级的数字求和时可以减少舍入误差，但它不能阻止指数项 $e^{a_i}$ 在计算时发生上溢或下溢。因此，它可以在中等范围内提高精度，但在极端情况下不满足要求 (i)。在没有发生上溢的情况下，它在带补偿的求和意义上是精确的，但不满足稳定性要求。结论：不正确。\n\n选项 E：二阶累积量展开 $L \\approx \\bar{a} + \\frac{1}{2}\\sigma_a^2$ 是一种依赖于截断累积量生成函数的近似。如果 $a$ 的分布近似为正态分布且高阶累积量很小，它可能很准确，但它在有限样本上不是精确的，并且会引入偏差。它也没有解决计算 $e^{a_i}$ 时的上溢问题，因为它通过近似避免了直接的指数计算，但要求 (ii) 使其不合格。结论：不正确。\n\n因此，只有以运行时最大值为锚点的对数-和-指数流式累加方法才能在计算有限样本上的 $L = \\ln \\langle e^{-\\beta \\Delta U} \\rangle$ 时同时满足数值稳定性和精确性。",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}