{
    "hands_on_practices": [
        {
            "introduction": "The Kalman filter is the cornerstone of optimal state estimation for linear systems subject to Gaussian noise. This first exercise provides a concrete, hands-on calculation of a single filter iteration, stripping the algorithm down to its fundamental prediction and update steps. By manually computing the evolution of the state estimate and its covariance, you will gain an intuitive feel for how the filter optimally blends a model-based prediction with a new, noisy measurement to refine its knowledge of the system's state .",
            "id": "3903722",
            "problem": "A lithium-ion cell is modeled near a fixed operating point by a discrete-time linearized Thevenin resistor-capacitor (RC) equivalent circuit. The state vector is $x_k = \\begin{pmatrix} x_{1,k} & x_{2,k} \\end{pmatrix}^{\\top}$, where $x_{1,k}$ is the state of charge (SOC) fraction and $x_{2,k}$ is the RC overpotential in volts. The input $u_{k-1}$ is the applied current (positive for discharge), and the measured output $y_k$ is the terminal voltage deviation from the operating-point voltage after precompensating the ohmic drop. The stochastic linear-Gaussian state-space model is\n$$x_k = A x_{k-1} + B u_{k-1} + w_{k-1}, \\quad w_{k-1} \\sim \\mathcal{N}(0,Q),$$\n$$y_k = H x_k + v_k, \\quad v_k \\sim \\mathcal{N}(0,R),$$\nwith independent process and measurement noises.\n\nAssume the system matrices and noise covariances are numerically specified as\n$$A = \\begin{bmatrix} 1 & 0 \\\\ 0 & \\tfrac{1}{2} \\end{bmatrix}, \\quad B = \\begin{bmatrix} -\\tfrac{1}{10} \\\\ \\tfrac{1}{5} \\end{bmatrix}, \\quad H = \\begin{bmatrix} \\tfrac{3}{10} & -1 \\end{bmatrix},$$\n$$Q = \\begin{bmatrix} \\tfrac{1}{100} & 0 \\\\ 0 & \\tfrac{1}{25} \\end{bmatrix}, \\quad R = \\tfrac{9}{100}.$$\n\nAt time $k-1$, the posterior state estimate and covariance are\n$$x_{k-1}^{+} = \\begin{bmatrix} \\tfrac{1}{2} \\\\ \\tfrac{1}{5} \\end{bmatrix}, \\quad P_{k-1}^{+} = \\begin{bmatrix} \\tfrac{1}{25} & 0 \\\\ 0 & \\tfrac{9}{100} \\end{bmatrix}.$$\nAt the next step, the applied current is $u_{k-1} = 1$, and the measured terminal-voltage deviation is $y_k = -\\tfrac{1}{5}$.\n\nStarting from the linear-Gaussian state transition and observation models and standard probabilistic conditioning of Gaussian random variables, perform one complete Kalman filter iteration (prediction and update) to obtain the posterior state $x_k^{+}$ and covariance $P_k^{+}$ at time $k$.\n\nAnswer specification:\n- Provide exact values in closed form; do not round.\n- Report the final answer as a single row matrix in the order $[x_{1,k}^{+},\\, x_{2,k}^{+},\\, P_{11,k}^{+},\\, P_{12,k}^{+},\\, P_{21,k}^{+},\\, P_{22,k}^{+}]$.\n- Express $x_{1,k}^{+}$ as an SOC fraction and $x_{2,k}^{+}$ in volts; the covariance entries are in the corresponding squared units. In the final boxed answer, do not include units.",
            "solution": "The problem statement is evaluated to be valid. It is scientifically grounded in standard state-space modeling and estimation theory for electrochemical systems, specifically using a linearized equivalent circuit model for a lithium-ion cell, which is a common practice. The problem is well-posed, providing all necessary matrices, covariances, initial conditions, and measurements to perform a single, unique iteration of the Kalman filter. The provided numerical values are dimensionally consistent and do not represent any physical or mathematical contradictions. The task is a direct application of the standard Kalman filter algorithm, a cornerstone of data assimilation and online state estimation.\n\nThe Kalman filter algorithm consists of two sequential steps: prediction (time update) and correction (measurement update). We will perform one complete iteration.\n\nThe posterior state estimate and its covariance at time $k-1$ are given as:\n$$x_{k-1}^{+} = \\begin{bmatrix} \\tfrac{1}{2} \\\\ \\tfrac{1}{5} \\end{bmatrix}, \\quad P_{k-1}^{+} = \\begin{bmatrix} \\tfrac{1}{25} & 0 \\\\ 0 & \\tfrac{9}{100} \\end{bmatrix}$$\nThe system matrices, input, and measurement are:\n$$A = \\begin{bmatrix} 1 & 0 \\\\ 0 & \\tfrac{1}{2} \\end{bmatrix}, \\quad B = \\begin{bmatrix} -\\tfrac{1}{10} \\\\ \\tfrac{1}{5} \\end{bmatrix}, \\quad H = \\begin{bmatrix} \\tfrac{3}{10} & -1 \\end{bmatrix}$$\n$$Q = \\begin{bmatrix} \\tfrac{1}{100} & 0 \\\\ 0 & \\tfrac{1}{25} \\end{bmatrix}, \\quad R = \\tfrac{9}{100}$$\n$$u_{k-1} = 1, \\quad y_k = -\\tfrac{1}{5}$$\n\n**1. Prediction Step**\n\nThe prediction step projects the state and covariance estimates forward in time from step $k-1$ to $k$.\n\nFirst, we compute the predicted (a priori) state estimate $x_k^{-}$:\n$$x_k^{-} = A x_{k-1}^{+} + B u_{k-1}$$\n$$x_k^{-} = \\begin{bmatrix} 1 & 0 \\\\ 0 & \\tfrac{1}{2} \\end{bmatrix} \\begin{bmatrix} \\tfrac{1}{2} \\\\ \\tfrac{1}{5} \\end{bmatrix} + \\begin{bmatrix} -\\tfrac{1}{10} \\\\ \\tfrac{1}{5} \\end{bmatrix} (1) = \\begin{bmatrix} \\tfrac{1}{2} \\\\ \\tfrac{1}{10} \\end{bmatrix} + \\begin{bmatrix} -\\tfrac{1}{10} \\\\ \\tfrac{2}{10} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{4}{10} \\\\ \\tfrac{3}{10} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{2}{5} \\\\ \\tfrac{3}{10} \\end{bmatrix}$$\n\nNext, we compute the predicted (a priori) error covariance $P_k^{-}$:\n$$P_k^{-} = A P_{k-1}^{+} A^{\\top} + Q$$\n$$P_k^{-} = \\begin{bmatrix} 1 & 0 \\\\ 0 & \\tfrac{1}{2} \\end{bmatrix} \\begin{bmatrix} \\tfrac{1}{25} & 0 \\\\ 0 & \\tfrac{9}{100} \\end{bmatrix} \\begin{bmatrix} 1 & 0 \\\\ 0 & \\tfrac{1}{2} \\end{bmatrix} + \\begin{bmatrix} \\tfrac{1}{100} & 0 \\\\ 0 & \\tfrac{1}{25} \\end{bmatrix}$$\n$$P_k^{-} = \\begin{bmatrix} \\tfrac{1}{25} & 0 \\\\ 0 & \\tfrac{9}{400} \\end{bmatrix} + \\begin{bmatrix} \\tfrac{1}{100} & 0 \\\\ 0 & \\tfrac{16}{400} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{4}{100} + \\tfrac{1}{100} & 0 \\\\ 0 & \\tfrac{9}{400} + \\tfrac{16}{400} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{5}{100} & 0 \\\\ 0 & \\tfrac{25}{400} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{1}{20} & 0 \\\\ 0 & \\tfrac{1}{16} \\end{bmatrix}$$\n\n**2. Update Step**\n\nThe update step corrects the predicted estimates using the new measurement $y_k$.\n\nFirst, we compute the Kalman gain $K_k$. This requires the innovation covariance, $S_k = H P_k^{-} H^{\\top} + R$.\n$$P_k^{-} H^{\\top} = \\begin{bmatrix} \\tfrac{1}{20} & 0 \\\\ 0 & \\tfrac{1}{16} \\end{bmatrix} \\begin{bmatrix} \\tfrac{3}{10} \\\\ -1 \\end{bmatrix} = \\begin{bmatrix} \\tfrac{3}{200} \\\\ -\\tfrac{1}{16} \\end{bmatrix}$$\n$$H P_k^{-} H^{\\top} = \\begin{bmatrix} \\tfrac{3}{10} & -1 \\end{bmatrix} \\begin{bmatrix} \\tfrac{3}{200} \\\\ -\\tfrac{1}{16} \\end{bmatrix} = \\tfrac{9}{2000} + \\tfrac{1}{16} = \\tfrac{9}{2000} + \\tfrac{125}{2000} = \\tfrac{134}{2000} = \\tfrac{67}{1000}$$\n$$S_k = H P_k^{-} H^{\\top} + R = \\tfrac{67}{1000} + \\tfrac{9}{100} = \\tfrac{67}{1000} + \\tfrac{90}{1000} = \\tfrac{157}{1000}$$\nThe Kalman gain $K_k$ is then:\n$$K_k = P_k^{-} H^{\\top} S_k^{-1} = \\begin{bmatrix} \\tfrac{3}{200} \\\\ -\\tfrac{1}{16} \\end{bmatrix} \\left(\\tfrac{1000}{157}\\right) = \\begin{bmatrix} \\tfrac{3 \\times 5}{157} \\\\ -\\tfrac{1000/16}{157} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{15}{157} \\\\ -\\tfrac{62.5}{157} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{15}{157} \\\\ -\\tfrac{125}{314} \\end{bmatrix}$$\n\nNext, we update the state estimate to obtain the posterior (a posteriori) estimate $x_k^{+}$. This requires the measurement residual (innovation), $y_k - H x_k^{-}$.\n$$H x_k^{-} = \\begin{bmatrix} \\tfrac{3}{10} & -1 \\end{bmatrix} \\begin{bmatrix} \\tfrac{2}{5} \\\\ \\tfrac{3}{10} \\end{bmatrix} = \\tfrac{6}{50} - \\tfrac{3}{10} = \\tfrac{6}{50} - \\tfrac{15}{50} = -\\tfrac{9}{50}$$\nThe innovation is $y_k - H x_k^{-} = -\\tfrac{1}{5} - (-\\tfrac{9}{50}) = -\\tfrac{10}{50} + \\tfrac{9}{50} = -\\tfrac{1}{50}$.\n$$x_k^{+} = x_k^{-} + K_k (y_k - H x_k^{-})$$\n$$x_k^{+} = \\begin{bmatrix} \\tfrac{2}{5} \\\\ \\tfrac{3}{10} \\end{bmatrix} + \\begin{bmatrix} \\tfrac{15}{157} \\\\ -\\tfrac{125}{314} \\end{bmatrix} \\left(-\\tfrac{1}{50}\\right) = \\begin{bmatrix} \\tfrac{2}{5} - \\tfrac{15}{157 \\times 50} \\\\ \\tfrac{3}{10} + \\tfrac{125}{314 \\times 50} \\end{bmatrix}$$\nThe components of $x_k^{+}$ are:\n$$x_{1,k}^{+} = \\tfrac{2}{5} - \\tfrac{3}{1570} = \\tfrac{2 \\times 314 - 3}{1570} = \\tfrac{628-3}{1570} = \\tfrac{625}{1570} = \\tfrac{125}{314}$$\n$$x_{2,k}^{+} = \\tfrac{3}{10} + \\tfrac{125}{15700} = \\tfrac{3}{10} + \\tfrac{5}{628} = \\tfrac{3 \\times 314 + 5 \\times 5}{3140} = \\tfrac{942+25}{3140} = \\tfrac{967}{3140}$$\nSo, $x_k^{+} = \\begin{bmatrix} \\tfrac{125}{314} \\\\ \\tfrac{967}{3140} \\end{bmatrix}$.\n\nFinally, we update the error covariance to obtain the posterior covariance $P_k^{+}$.\n$$P_k^{+} = (I - K_k H) P_k^{-}$$\n$$K_k H = \\begin{bmatrix} \\tfrac{15}{157} \\\\ -\\tfrac{125}{314} \\end{bmatrix} \\begin{bmatrix} \\tfrac{3}{10} & -1 \\end{bmatrix} = \\begin{bmatrix} \\tfrac{45}{1570} & -\\tfrac{15}{157} \\\\ -\\tfrac{375}{3140} & \\tfrac{125}{314} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{9}{314} & -\\tfrac{30}{314} \\\\ -\\tfrac{75}{628} & \\tfrac{125}{314} \\end{bmatrix}$$\n$$I - K_k H = \\begin{bmatrix} 1 - \\tfrac{9}{314} & \\tfrac{30}{314} \\\\ \\tfrac{75}{628} & 1 - \\tfrac{125}{314} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{305}{314} & \\tfrac{30}{314} \\\\ \\tfrac{75}{628} & \\tfrac{189}{314} \\end{bmatrix}$$\nNow, multiplying by the diagonal $P_k^{-}$:\n$$P_k^{+} = \\begin{bmatrix} \\tfrac{305}{314} & \\tfrac{30}{314} \\\\ \\tfrac{75}{628} & \\tfrac{189}{314} \\end{bmatrix} \\begin{bmatrix} \\tfrac{1}{20} & 0 \\\\ 0 & \\tfrac{1}{16} \\end{bmatrix} = \\begin{bmatrix} \\tfrac{305}{314 \\times 20} & \\tfrac{30}{314 \\times 16} \\\\ \\tfrac{75}{628 \\times 20} & \\tfrac{189}{314 \\times 16} \\end{bmatrix}$$\nThe components of $P_k^{+}$ are:\n$$P_{11,k}^{+} = \\tfrac{305}{6280} = \\tfrac{61}{1256}$$\n$$P_{12,k}^{+} = \\tfrac{30}{5024} = \\tfrac{15}{2512}$$\n$$P_{21,k}^{+} = \\tfrac{75}{12560} = \\tfrac{15}{2512}$$\n$$P_{22,k}^{+} = \\tfrac{189}{5024}$$\nAs expected, $P_k^{+}$ is symmetric, i.e., $P_{12,k}^{+} = P_{21,k}^{+}$.\n\nThe final posterior state and covariance are:\n$$x_k^{+} = \\begin{bmatrix} \\tfrac{125}{314} \\\\ \\tfrac{967}{3140} \\end{bmatrix}, \\quad P_k^{+} = \\begin{bmatrix} \\tfrac{61}{1256} & \\tfrac{15}{2512} \\\\ \\tfrac{15}{2512} & \\tfrac{189}{5024} \\end{bmatrix}$$\nThe requested output is the row matrix $[x_{1,k}^{+},\\, x_{2,k}^{+},\\, P_{11,k}^{+},\\, P_{12,k}^{+},\\, P_{21,k}^{+},\\, P_{22,k}^{+}]$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{125}{314} & \\frac{967}{3140} & \\frac{61}{1256} & \\frac{15}{2512} & \\frac{15}{2512} & \\frac{189}{5024}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Real-world battery models are rarely linear, especially concerning the relationship between Open-Circuit Voltage (OCV) and State of Charge (SOC). The Extended Kalman Filter (EKF) addresses this by applying a first-order linearization to the nonlinear model at each time step. This practice focuses on the most critical step in implementing an EKF: deriving the measurement Jacobian matrix $H_k$, which quantifies the sensitivity of the measured output to infinitesimal changes in the state variables. Mastering this linearization is key to applying Kalman filtering techniques to the vast majority of practical, nonlinear estimation problems .",
            "id": "3903746",
            "problem": "Consider a single-cell lithium-ion battery operated at a constant temperature, modeled for online state and parameter estimation in an Extended Kalman Filter (EKF). The measurement equation for the terminal voltage is given by the relationship between the open-circuit voltage and the state of charge, with an ohmic drop due to internal resistance:\n$$\nV_k = \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k + w_k,\n$$\nwhere $V_k$ is the measured terminal voltage at discrete time $k$, $\\mathrm{SOC}_k$ is the state of charge, $R_k$ is the ohmic resistance, $I_k$ is the applied current (positive for discharge), and $w_k$ is the measurement noise. The EKF measurement function is $h(x_k,u_k) = \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k$, with the state vector $x_k = \\begin{pmatrix} \\mathrm{SOC}_k \\\\ R_k \\end{pmatrix}$ and the input $u_k = I_k$.\n\nStarting from the definition of the Extended Kalman Filter linearization based on the first-order Taylor expansion of the measurement function, derive the measurement Jacobian matrix $H_k = \\left.\\frac{\\partial h}{\\partial x}\\right|_{x=\\hat{x}_k^{-}}$ using the partial derivative $\\frac{\\partial \\mathrm{OCV}}{\\partial \\mathrm{SOC}}$ and the functional dependence on $R_k$ and $I_k$. Then, for the specific open-circuit voltage function\n$$\n\\mathrm{OCV}(\\mathrm{SOC}) = 3.7 + 0.1\\,\\mathrm{SOC} + 0.05\\,\\mathrm{SOC}^{2} - 0.03\\,\\mathrm{SOC}^{3},\n$$\nevaluate $H_k$ at the predicted state $\\hat{x}_k^{-} = \\begin{pmatrix} \\hat{\\mathrm{SOC}}_k^{-} \\\\ \\hat{R}_k^{-} \\end{pmatrix} = \\begin{pmatrix} 0.60 \\\\ 0.050 \\end{pmatrix}$ with applied current $I_k = 2.000$, assuming standard International System of Units (SI) for numerical evaluation. Express the first entry of $H_k$ in volts per unit state-of-charge and the second entry in volts per ohm, and report the final numerical row vector $H_k$ rounded to four significant figures. Provide only the numerical values in the final row vector, without units.",
            "solution": "The problem requires the derivation and evaluation of the measurement Jacobian matrix, $H_k$, for an Extended Kalman Filter (EKF) applied to a battery model.\n\nFirst, we must validate the problem statement.\nThe givens are:\n- The measurement equation: $V_k = \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k + w_k$.\n- The EKF measurement function: $h(x_k,u_k) = \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k$.\n- The state vector: $x_k = \\begin{pmatrix} \\mathrm{SOC}_k \\\\ R_k \\end{pmatrix}$.\n- The input: $u_k = I_k$.\n- The definition of the Jacobian: $H_k = \\left.\\frac{\\partial h}{\\partial x}\\right|_{x=\\hat{x}_k^{-}}$.\n- A specific functional form for the open-circuit voltage: $\\mathrm{OCV}(\\mathrm{SOC}) = 3.7 + 0.1\\,\\mathrm{SOC} + 0.05\\,\\mathrm{SOC}^{2} - 0.03\\,\\mathrm{SOC}^{3}$.\n- The numerical values for evaluation: the predicted state $\\hat{x}_k^{-} = \\begin{pmatrix} \\hat{\\mathrm{SOC}}_k^{-} \\\\ \\hat{R}_k^{-} \\end{pmatrix} = \\begin{pmatrix} 0.60 \\\\ 0.050 \\end{pmatrix}$ and the applied current $I_k = 2.000$.\n\nThe problem is scientifically grounded, using standard models (equivalent circuit model for a battery) and methods (EKF) from control theory and electrical engineering. The problem is well-posed, providing all necessary functions and data for a unique solution. The language is objective and precise. The numerical values are physically plausible for a lithium-ion cell. Therefore, the problem is deemed valid.\n\nWe can now proceed with the solution. The measurement Jacobian matrix $H_k$ is defined as the partial derivative of the scalar measurement function $h$ with respect to the state vector $x_k$. Since the state vector $x_k$ has two components, $\\mathrm{SOC}_k$ and $R_k$, the Jacobian $H_k$ will be a $1 \\times 2$ row vector:\n$$\nH_k = \\left.\\begin{pmatrix} \\frac{\\partial h}{\\partial \\mathrm{SOC}_k} & \\frac{\\partial h}{\\partial R_k} \\end{pmatrix}\\right|_{x_k = \\hat{x}_k^{-}}\n$$\nThe measurement function is $h(x_k, u_k) = \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k$. Let's compute each partial derivative.\n\nThe first component of $H_k$ is the partial derivative of $h$ with respect to $\\mathrm{SOC}_k$:\n$$\n\\frac{\\partial h}{\\partial \\mathrm{SOC}_k} = \\frac{\\partial}{\\partial \\mathrm{SOC}_k} \\left( \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k \\right)\n$$\nSince the term $- R_k I_k$ does not depend on $\\mathrm{SOC}_k$, its derivative with respect to $\\mathrm{SOC}_k$ is zero. Thus,\n$$\n\\frac{\\partial h}{\\partial \\mathrm{SOC}_k} = \\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}_k}\n$$\nThe second component of $H_k$ is the partial derivative of $h$ with respect to $R_k$:\n$$\n\\frac{\\partial h}{\\partial R_k} = \\frac{\\partial}{\\partial R_k} \\left( \\mathrm{OCV}(\\mathrm{SOC}_k) - R_k I_k \\right)\n$$\nThe term $\\mathrm{OCV}(\\mathrm{SOC}_k)$ does not depend on $R_k$, so its derivative is zero. The derivative of the second term is:\n$$\n\\frac{\\partial h}{\\partial R_k} = -I_k\n$$\nCombining these results, the symbolic expression for the Jacobian matrix is:\n$$\nH_k = \\begin{pmatrix} \\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}_k} & -I_k \\end{pmatrix}\n$$\nThis matrix must be evaluated at the a priori state estimate, $x_k = \\hat{x}_k^{-} = \\begin{pmatrix} \\hat{\\mathrm{SOC}}_k^{-} \\\\ \\hat{R}_k^{-} \\end{pmatrix}$.\n\nNow, we use the specific functional form for $\\mathrm{OCV}(\\mathrm{SOC})$ provided in the problem statement:\n$$\n\\mathrm{OCV}(\\mathrm{SOC}) = 3.7 + 0.1\\,\\mathrm{SOC} + 0.05\\,\\mathrm{SOC}^{2} - 0.03\\,\\mathrm{SOC}^{3}\n$$\nWe compute its derivative with respect to $\\mathrm{SOC}$:\n$$\n\\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}} = \\frac{d}{d\\mathrm{SOC}} \\left( 3.7 + 0.1\\,\\mathrm{SOC} + 0.05\\,\\mathrm{SOC}^{2} - 0.03\\,\\mathrm{SOC}^{3} \\right)\n$$\n$$\n\\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}} = 0.1 + 2(0.05)\\,\\mathrm{SOC} - 3(0.03)\\,\\mathrm{SOC}^{2}\n$$\n$$\n\\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}} = 0.1 + 0.1\\,\\mathrm{SOC} - 0.09\\,\\mathrm{SOC}^{2}\n$$\nWe need to evaluate this derivative at $\\mathrm{SOC}_k = \\hat{\\mathrm{SOC}}_k^{-} = 0.60$:\n$$\n\\left.\\frac{d\\mathrm{OCV}}{d\\mathrm{SOC}_k}\\right|_{\\hat{\\mathrm{SOC}}_k^{-}=0.60} = 0.1 + 0.1(0.60) - 0.09(0.60)^{2}\n$$\n$$\n= 0.1 + 0.06 - 0.09(0.36)\n$$\n$$\n= 0.16 - 0.0324\n$$\n$$\n= 0.1276\n$$\nThe first entry of $H_k$ is $0.1276$. The unit is Volts per unit SOC.\n\nThe second entry of $H_k$ is $-I_k$. We are given $I_k = 2.000$ Amperes.\n$$\n-I_k = -2.000\n$$\nThe second entry of $H_k$ is $-2.000$. The unit is Volts per Ohm, which is equivalent to Amperes.\n\nAssembling the numerical Jacobian matrix $H_k$:\n$$\nH_k = \\begin{pmatrix} 0.1276 & -2.000 \\end{pmatrix}\n$$\nThe problem requires the final answer to be rounded to four significant figures.\nThe first value, $0.1276$, has four significant figures.\nThe second value, $-2.000$, has four significant figures.\nTherefore, no further rounding is needed. The final numerical row vector for $H_k$ is $\\begin{pmatrix} 0.1276 & -2.000 \\end{pmatrix}$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.1276 & -2.000\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Before launching an estimation algorithm, a fundamental question must be addressed: can the model parameters be uniquely determined from the planned experiment? This practice delves into the crucial concept of parameter identifiability, which depends on both the model structure and the richness of the input signals. By constructing a sensitivity matrix and analyzing its rank under different input current profiles, you will see firsthand how the design of an experiment directly enables—or prevents—the successful estimation of a model's internal parameters .",
            "id": "3903723",
            "problem": "You are tasked with evaluating local parameter identifiability in a physics-based battery model used for automated battery design and simulation by computing a sensitivity matrix and its rank over specified input trajectories. Begin from fundamental circuit laws and conservation of charge to construct the forward model, then use this model to build the sensitivity matrix and determine local identifiability through its rank.\n\nAssume a first-order Equivalent Circuit Model (ECM) for a lithium-ion cell consisting of an ohmic resistance and a single polarization (resistor-capacitor) branch. Let State of Charge (SOC) be defined via conservation of charge. The model is derived from Kirchhoff’s laws and capacitor constitutive relations as follows:\n\n- Let the input current be $I(t)$ in amperes, positive for discharge. Let the nominal capacity be $Q_{\\mathrm{n}}$ in coulombs. The State of Charge $z(t)$ satisfies\n$$\\frac{dz(t)}{dt} = -\\frac{I(t)}{Q_{\\mathrm{n}}}.$$\n- Let the polarization voltage across the resistor-capacitor branch be $v_{\\mathrm{rc}}(t)$ in volts, the polarization resistance be $R_1$ in ohms, the polarization capacitance be $C_1$ in farads, and the ohmic resistance be $R_0$ in ohms. By Kirchhoff’s laws and the capacitor current-voltage relation, the polarization voltage satisfies\n$$\\frac{dv_{\\mathrm{rc}}(t)}{dt} = -\\frac{1}{R_1 C_1} v_{\\mathrm{rc}}(t) + \\frac{1}{C_1} I(t).$$\n- Let the open-circuit voltage be locally linearized around a reference SOC $z_{\\mathrm{ref}}$ as $V_{\\mathrm{OCV}}(z) = V_0 + \\alpha \\big(z - z_{\\mathrm{ref}}\\big)$, where $V_0$ is a constant in volts, and $\\alpha$ is the local slope in volts per unit SOC. The terminal voltage output $y(t)$ in volts is\n$$y(t) = V_0 + \\alpha \\big(z(t) - z_{\\mathrm{ref}}\\big) - v_{\\mathrm{rc}}(t) - R_0 I(t).$$\n\nDefine the parameter vector $\\boldsymbol{\\theta} = \\begin{pmatrix} R_0 & R_1 & C_1 & \\alpha \\end{pmatrix}^\\top$. For a discrete-time experiment with time step $\\Delta t$ and an input trajectory $I_k = I(k \\Delta t)$, simulate the model with given initial conditions $z(0) = z_0$ and $v_{\\mathrm{rc}}(0) = v_{\\mathrm{rc},0}$ to obtain sampled outputs $y_k = y(k \\Delta t)$ at selected indices $k \\in \\mathcal{K}$. Construct the sensitivity matrix $S$ with entries\n$$S_{ij} = \\frac{\\partial y_{k_i}}{\\partial \\theta_j},$$\nwhere $k_i$ is the $i$-th selected sample index. Use a numerically stable finite-difference approximation for $\\frac{\\partial y_{k_i}}{\\partial \\theta_j}$ that is appropriate for parameters of different magnitudes.\n\nLocal identifiability at the operating point is assessed by $\\mathrm{rank}(S)$: full column rank indicates that small perturbations in parameters produce distinguishable output variations at the sampled times.\n\nImplement the forward simulation using the explicit Euler method:\n$$v_{\\mathrm{rc},k+1} = v_{\\mathrm{rc},k} + \\Delta t\\left(-\\frac{1}{R_1 C_1} v_{\\mathrm{rc},k} + \\frac{1}{C_1} I_k\\right), \\quad z_{k+1} = z_k - \\Delta t \\frac{I_k}{Q_{\\mathrm{n}}}, \\quad y_k = V_0 + \\alpha \\big(z_k - z_{\\mathrm{ref}}\\big) - v_{\\mathrm{rc},k} - R_0 I_k.$$\n\nNumerical requirements:\n- Use a central finite difference for sensitivities with a relative perturbation magnitude $\\delta_j = \\varepsilon \\, |\\theta_j|$ with $\\varepsilon = 10^{-6}$, i.e.,\n$$\\frac{\\partial y_{k_i}}{\\partial \\theta_j} \\approx \\frac{y_{k_i}(\\theta_j + \\delta_j) - y_{k_i}(\\theta_j - \\delta_j)}{2\\delta_j}.$$\n- When computing the matrix rank, use a singular value decomposition based criterion with a sensible tolerance (you may use the default behavior of a standard numerical linear algebra routine).\n\nPhysical units and constants:\n- Express current $I$ in amperes, voltage $y$ and $V_0$ in volts, time in seconds, resistance in ohms, capacitance in farads, capacity $Q_{\\mathrm{n}}$ in coulombs, and SOC as dimensionless ($0$ to $1$).\n- Use $Q_{\\mathrm{n}} = 7200$ coulombs, $V_0 = 3.7$ volts, $z_0 = 0.5$, $z_{\\mathrm{ref}} = 0.5$, and $v_{\\mathrm{rc},0} = 0$ volts in all tests.\n\nTest suite:\n- Test $1$ (rich excitation, expected full rank): $\\boldsymbol{\\theta} = [0.01, 0.02, 2400, 0.8]$, $\\Delta t = 0.5$ seconds, $N = 200$ samples, input $I_k$ is a deterministic pseudo-random binary sequence (PRBS) taking values $\\pm 1$ ampere with pattern changes over time, sampled at all indices $\\mathcal{K} = \\{0,1,\\dots,N-1\\}$.\n- Test $2$ (no excitation, expected rank $0$): $\\boldsymbol{\\theta} = [0.01, 0.02, 2400, 0.8]$, $\\Delta t = 1.0$ seconds, $N = 50$ samples, input $I_k \\equiv 0$ ampere, sampled at all indices $\\mathcal{K} = \\{0,1,\\dots,N-1\\}$.\n- Test $3$ (steady-state dominated, expected rank deficiency): $\\boldsymbol{\\theta} = [0.01, 0.02, 2400, 0.8]$, $\\Delta t = 1.0$ seconds, $N = 300$ samples, input $I_k \\equiv 1.0$ ampere for all $k$, sampled at the last $100$ indices $\\mathcal{K} = \\{200, 201, \\dots, 299\\}$.\n- Test $4$ (single-sample boundary case): $\\boldsymbol{\\theta} = [0.01, 0.02, 2400, 0.8]$, $\\Delta t = 1.0$ seconds, $N = 1$ sample, input $I_0 = 0.5$ ampere, sampled at index $\\mathcal{K} = \\{0\\}$.\n\nYour program must:\n- Implement the forward simulation and sensitivity computation exactly as specified.\n- For each test, construct the sensitivity matrix $S$ using the specified $\\boldsymbol{\\theta}$, inputs, and sampling indices, then compute the integer rank $\\mathrm{rank}(S)$.\n- Produce a single line of output containing the ranks for Tests $1$ through $4$ as a comma-separated list enclosed in square brackets, for example $[r_1,r_2,r_3,r_4]$. The ranks are unitless integers.\n\nAll numeric quantities in the problem statement are provided in their specified units (amperes, volts, seconds, ohms, farads, coulombs). The final outputs are ranks (unitless integers). No angles or percentages are involved.",
            "solution": "The problem requires an assessment of local parameter identifiability for a first-order equivalent circuit model (ECM) of a lithium-ion battery. This is achieved by computing the rank of the sensitivity matrix for a given set of parameters and input current trajectories.\n\nThe forward model is defined by a system of ordinary differential equations. The first state, the State of Charge $z(t)$, is governed by the principle of conservation of charge (coulomb counting):\n$$\n\\frac{dz(t)}{dt} = -\\frac{I(t)}{Q_{\\mathrm{n}}}\n$$\nwhere $I(t)$ is the input current and $Q_{\\mathrm{n}}$ is the nominal capacity of the cell.\n\nThe second state, the polarization voltage $v_{\\mathrm{rc}}(t)$ across the parallel resistor-capacitor ($RC$) branch, is governed by Kirchhoff's laws and the constitutive relation for a capacitor:\n$$\n\\frac{dv_{\\mathrm{rc}}(t)}{dt} = -\\frac{1}{R_1 C_1} v_{\\mathrm{rc}}(t) + \\frac{1}{C_1} I(t)\n$$\nHere, $R_1$ is the polarization resistance and $C_1$ is the polarization capacitance. The characteristic time constant of this dynamic process is $\\tau_1 = R_1 C_1$.\n\nThe model's output is the terminal voltage $y(t)$, which is the sum of the open-circuit voltage ($V_{\\mathrm{OCV}}$), the voltage drop across the ohmic resistance $R_0$, and the polarization voltage:\n$$\ny(t) = V_{\\mathrm{OCV}}(z(t)) - v_{\\mathrm{rc}}(t) - R_0 I(t)\n$$\nThe open-circuit voltage is locally approximated by a linear function of the State of Charge around a reference point $z_{\\mathrm{ref}}$:\n$$\nV_{\\mathrm{OCV}}(z(t)) = V_0 + \\alpha \\big(z(t) - z_{\\mathrm{ref}}\\big)\n$$\nwhere $V_0$ is the OCV at $z_{\\mathrm{ref}}$ and $\\alpha$ is the local slope of the OCV-SOC curve.\n\nThe parameters to be identified are collected in the vector $\\boldsymbol{\\theta} = \\begin{pmatrix} R_0 & R_1 & C_1 & \\alpha \\end{pmatrix}^\\top$.\n\nFor numerical simulation, the continuous-time model is discretized using the explicit Euler method with a time step $\\Delta t$. Let $x_k = x(k \\Delta t)$ denote the value of a variable $x$ at a discrete time step $k$. The state and output equations become:\n$$\nz_{k+1} = z_k - \\frac{\\Delta t}{Q_{\\mathrm{n}}} I_k\n$$\n$$\nv_{\\mathrm{rc},k+1} = v_{\\mathrm{rc},k} + \\Delta t\\left(-\\frac{1}{R_1 C_1} v_{\\mathrm{rc},k} + \\frac{1}{C_1} I_k\\right) = v_{\\mathrm{rc},k} \\left(1 - \\frac{\\Delta t}{R_1 C_1}\\right) + \\frac{\\Delta t}{C_1} I_k\n$$\n$$\ny_k = V_0 + \\alpha \\big(z_k - z_{\\mathrm{ref}}\\big) - v_{\\mathrm{rc},k} - R_0 I_k\n$$\n\nLocal parameter identifiability is assessed by analyzing the sensitivity of the model's output $y_k$ to variations in the parameters $\\boldsymbol{\\theta}$. The sensitivity matrix $S$ is constructed from these partial derivatives, sampled at specific time indices $k_i \\in \\mathcal{K}$:\n$$\nS_{ij} = \\frac{\\partial y_{k_i}}{\\partial \\theta_j}\n$$\nThe parameters in $\\boldsymbol{\\theta}$ are locally identifiable if the columns of $S$ are linearly independent, which is true if and only if $S$ has full column rank. The rank of $S$ is equal to the number of identifiable parameters or combinations of parameters.\n\nThe derivatives are computed numerically using the central finite difference method, which offers second-order accuracy. For a parameter $\\theta_j$, we introduce a small perturbation $\\delta_j$ and compute the output with perturbed parameters:\n$$\n\\frac{\\partial y_{k_i}}{\\partial \\theta_j} \\approx \\frac{y_{k_i}(\\boldsymbol{\\theta} + \\boldsymbol{e}_j \\delta_j) - y_{k_i}(\\boldsymbol{\\theta} - \\boldsymbol{e}_j \\delta_j)}{2\\delta_j}\n$$\nwhere $\\boldsymbol{e}_j$ is the $j$-th standard basis vector. The perturbation magnitude is chosen relative to the parameter's value, $\\delta_j = \\varepsilon |\\theta_j|$ with $\\varepsilon = 10^{-6}$, to handle parameters of different scales appropriately.\n\nThe rank of the resulting sensitivity matrix $S$ is determined using a Singular Value Decomposition (SVD). The rank corresponds to the number of singular values that are significantly larger than zero, determined numerically with a suitable tolerance.\n\nThe analysis is performed for four test cases:\n1.  **Test 1 (PRBS input):** A pseudo-random binary sequence provides rich, persistent excitation across a wide band of frequencies. This dynamic input is expected to excite both the fast ($RC$) and slow ($SOC$) dynamics of the model, making all four parameters distinguishable. The rank of $S$ is expected to be $4$.\n2.  **Test 2 (Zero input):** With $I(t) = 0$, and given initial conditions $z_0 = z_{\\mathrm{ref}}$ and $v_{\\mathrm{rc},0} = 0$, the states do not evolve: $z(t)=z_0$ and $v_{\\mathrm{rc}}(t)=0$. The output becomes $y(t) = V_0$, a constant. Since the output is independent of all parameters in $\\boldsymbol{\\theta}$, all sensitivity derivatives are zero. The sensitivity matrix $S$ is a zero matrix, and its rank is $0$.\n3.  **Test 3 (Constant input, late sampling):** A constant current $I(t) = I$ is applied. The sampling occurs after the $RC$ dynamics have reached steady state ($t \\gg \\tau_1 = R_1C_1$). In this regime, $v_{\\mathrm{rc}}(t) \\approx R_1 I$. The output is approximated by $y_k \\approx V_0 + \\alpha(z_k - z_{\\mathrm{ref}}) - (R_0 + R_1)I$. The parameters $R_0$ and $R_1$ only appear as a sum, $R_0 + R_1$, making them individually unidentifiable. Similarly, $C_1$ has no influence on the steady-state output. Therefore, the sensitivity matrix columns corresponding to $R_0$ and $R_1$ will be linearly dependent, and the column for $C_1$ will be a zero vector. We expect to identify only $\\alpha$ and the combined resistance $R_0+R_1$, resulting in a rank of $2$.\n4.  **Test 4 (Single sample at $t=0$):** The output is sampled only at the initial time, $k=0$. The output equation is $y_0 = V_0 + \\alpha(z_0 - z_{\\mathrm{ref}}) - v_{\\mathrm{rc},0} - R_0 I_0$. With the given initial conditions ($z_0=z_{\\mathrm{ref}}$, $v_{\\mathrm{rc},0}=0$), this simplifies to $y_0 = V_0 - R_0 I_0$. The output depends only on $R_0$. Consequently, only the sensitivity with respect to $R_0$ is non-zero. The sensitivity matrix is a $1 \\times 4$ row vector with three zero entries, giving a rank of $1$.\n\nThe implementation will consist of a forward simulator for the discretized model, a loop to compute the columns of the sensitivity matrix via finite differencing, and a final rank calculation for each test case.",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(theta, I_profile, dt, N, Qn, z0, vrc0, V0, z_ref):\n    \"\"\"\n    Simulates the first-order ECM using the explicit Euler method.\n\n    Args:\n        theta (list or np.ndarray): Parameter vector [R0, R1, C1, alpha].\n        I_profile (np.ndarray): Input current trajectory of length N.\n        dt (float): Time step in seconds.\n        N (int): Number of samples.\n        Qn (float): Nominal capacity in Coulombs.\n        z0 (float): Initial state of charge.\n        vrc0 (float): Initial polarization voltage.\n        V0 (float): Reference open-circuit voltage.\n        z_ref (float): Reference state of charge.\n\n    Returns:\n        np.ndarray: The simulated terminal voltage trajectory y of length N.\n    \"\"\"\n    R0, R1, C1, alpha = theta\n    \n    # Handle cases where perturbed parameters might be zero.\n    if C1 <= 0 or R1 <= 0:\n        return np.full(N, np.nan)\n\n    z = np.zeros(N)\n    vrc = np.zeros(N)\n    \n    z[0] = z0\n    vrc[0] = vrc0\n    \n    tau_inv = 1.0 / (R1 * C1)\n    \n    for k in range(N - 1):\n        vrc[k+1] = vrc[k] * (1.0 - dt * tau_inv) + (dt / C1) * I_profile[k]\n        z[k+1] = z[k] - (dt / Qn) * I_profile[k]\n\n    y = V0 + alpha * (z - z_ref) - vrc - R0 * I_profile\n    \n    return y\n\ndef compute_sensitivity_matrix_rank(case):\n    \"\"\"\n    Computes the rank of the sensitivity matrix for a given test case.\n    \"\"\"\n    theta_nom, dt, N, get_I_profile, K_indices = case\n\n    # Constants and initial conditions\n    Qn = 7200.0\n    V0 = 3.7\n    z0 = 0.5\n    z_ref = 0.5\n    vrc0 = 0.0\n\n    # Generate the full input current profile\n    I_profile = get_I_profile(N)\n    \n    # Finite difference perturbation\n    epsilon = 1e-6\n    num_params = len(theta_nom)\n    num_samples = len(K_indices)\n    \n    S = np.zeros((num_samples, num_params))\n\n    for j in range(num_params):\n        theta_j = theta_nom[j]\n        # Use a small absolute perturbation if the parameter is zero\n        delta_j = epsilon * np.abs(theta_j) if theta_j != 0 else epsilon\n\n        theta_plus = np.array(theta_nom)\n        theta_plus[j] += delta_j\n        \n        theta_minus = np.array(theta_nom)\n        theta_minus[j] -= delta_j\n        \n        y_plus = run_simulation(theta_plus, I_profile, dt, N, Qn, z0, vrc0, V0, z_ref)\n        y_minus = run_simulation(theta_minus, I_profile, dt, N, Qn, z0, vrc0, V0, z_ref)\n\n        # Handle potential NaNs from invalid parameters\n        if np.any(np.isnan(y_plus)) or np.any(np.isnan(y_minus)):\n            S[:, j] = 0\n            continue\n            \n        sens_j = (y_plus - y_minus) / (2.0 * delta_j)\n        \n        S[:, j] = sens_j[K_indices]\n\n    return np.linalg.matrix_rank(S)\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    \n    # Define a deterministic PRBS generator for Test 1\n    def get_prbs_profile(N):\n        rng = np.random.default_rng(seed=42)\n        return rng.choice([-1.0, 1.0], size=N)\n\n    test_cases = [\n        # Test 1: Rich excitation\n        (\n            [0.01, 0.02, 2400, 0.8], # theta\n            0.5, # dt\n            200, # N\n            get_prbs_profile, # I_k generator\n            np.arange(200) # K_indices\n        ),\n        # Test 2: No excitation\n        (\n            [0.01, 0.02, 2400, 0.8], # theta\n            1.0, # dt\n            50, # N\n            lambda n: np.zeros(n), # I_k generator\n            np.arange(50) # K_indices\n        ),\n        # Test 3: Steady-state dominated\n        (\n            [0.01, 0.02, 2400, 0.8], # theta\n            1.0, # dt\n            300, # N\n            lambda n: np.ones(n) * 1.0, # I_k generator\n            np.arange(200, 300) # K_indices\n        ),\n        # Test 4: Single-sample boundary case\n        (\n            [0.01, 0.02, 2400, 0.8], # theta\n            1.0, # dt\n            1, # N\n            lambda n: np.array([0.5]), # I_k generator\n            np.array([0]) # K_indices\n        ),\n    ]\n\n    results = []\n    for case in test_cases:\n        rank = compute_sensitivity_matrix_rank(case)\n        results.append(rank)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}