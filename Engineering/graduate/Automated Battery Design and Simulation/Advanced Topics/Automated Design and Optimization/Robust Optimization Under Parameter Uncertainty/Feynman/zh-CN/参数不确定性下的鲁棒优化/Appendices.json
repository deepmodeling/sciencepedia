{
    "hands_on_practices": [
        {
            "introduction": "在电池包设计中，确保在制造差异下电压的稳定性至关重要。本练习将演示一项基本技术：如何将带有“不确定性预算”的鲁棒线性约束转化为标准的线性规划（LP）问题。掌握这种重构方法是应用鲁棒优化解决实际工程约束问题的第一步 。",
            "id": "3947214",
            "problem": "在自动化电池包设计与仿真中，稳态母线电压降遵循欧姆定律。对于一个包含 $N$ 个承载放电电流的串联母线段的电池包，总电压降是各段电压降之和，其模型为 $V_{\\text{drop}} = \\sum_{k=1}^{N} r_{k} i_{k}$，其中 $r_{k}$ 是第 $k$ 段的电阻，$i_{k} \\ge 0$ 是对应的电流。在制造变异和热效应的影响下，各段的电阻是不确定的。假设电阻存在单侧增加 $r_{k} = r_{k}^{0} + \\delta_{k}$，其中 $r_{k}^{0}$ 是标称电阻，$0 \\le \\delta_{k} \\le d_{k}$ 是一个受 $d_{k}$ 限制的未知偏差。为了调节整体的保守性，使用鲁棒优化中引入的不确定性预算参数 $\\Gamma$：最多有 $\\Gamma$ 个分段可以同时达到其最大偏差，而其他分段可能只产生部分偏差。\n\n考虑一个鲁棒设计要求，即最坏情况下的电压降不超过允许的上限 $V_{\\max}$，也就是说，对于所有满足不确定性预算的偏差，该约束都必须成立。使用带有辅助变量的线性规划（LP）方法重构此鲁棒线性约束，使其能在标准 LP 求解器中执行。然后，通过第一性原理和适当的对偶推理，推导预算 $\\Gamma$ 如何控制对标称电压降的最坏情况附加惩罚项的大小。\n\n最后，将您的公式应用于以下具有放电电流和电阻数据的四段情况（$N=4$）：\n- 电流：$i_{1} = 80$, $i_{2} = 60$, $i_{3} = 50$, $i_{4} = 40$（单位均为 $\\mathrm{A}$）。\n- 标称电阻：$r_{1}^{0} = 0.5$, $r_{2}^{0} = 0.8$, $r_{3}^{0} = 0.3$, $r_{4}^{0} = 0.6$（单位均为 $\\mathrm{m}\\Omega$）。\n- 偏差上限：$d_{1} = 0.1$, $d_{2} = 0.2$, $d_{3} = 0.05$, $d_{4} = 0.15$（单位均为 $\\mathrm{m}\\Omega$）。\n\n假设 $\\Gamma = 2.3$，并计算由您的鲁棒 LP 重构和分析所隐含的最坏情况总电压降 $V_{\\text{drop}}^{\\star}(\\Gamma)$。以伏特为单位表示最终答案，并将其四舍五入至四位有效数字。仅在答案框中提供所要求的最坏情况总电压降值；不要包含中间步骤。",
            "solution": "该问题在科学上和数学上是有效的。它描述了使用不确定性预算模型的鲁棒优化的一个标准应用，这是一种处理线性规划中参数不确定性的成熟技术。其底层的物理模型是欧姆定律的正确应用。所有必要的数据都已提供，且内部没有矛盾。\n\n该问题需要一个包含三部分的解答：将鲁棒约束重构为标准的线性规划（LP）形式，推导不确定性预算 $\\Gamma$ 如何控制最坏情况下的惩罚项，以及计算一个具体的最坏情况电压降。\n\n首先，我们定义总电压降。已知第 $k$ 段的电阻为 $r_k = r_k^0 + \\delta_k$，则总电压降为：\n$$ V_{\\text{drop}} = \\sum_{k=1}^{N} r_k i_k = \\sum_{k=1}^{N} (r_k^0 + \\delta_k) i_k = \\sum_{k=1}^{N} r_k^0 i_k + \\sum_{k=1}^{N} \\delta_k i_k $$\n第一项 $\\sum_{k=1}^{N} r_k^0 i_k$ 是标称电压降，我们将其表示为 $V_{\\text{nom}}$。第二项是由电阻偏差引起的附加电压降。\n\n鲁棒设计要求是，约束 $V_{\\text{drop}} \\le V_{\\max}$ 必须对指定不确定性集合内的所有可能偏差 $\\delta_k$ 都成立。这等同于确保最坏情况下的电压降不超过 $V_{\\max}$：\n$$ \\max_{\\delta \\in U} \\left( \\sum_{k=1}^{N} r_k^0 i_k + \\sum_{k=1}^{N} \\delta_k i_k \\right) \\le V_{\\max} $$\n$$ V_{\\text{nom}} + \\max_{\\delta \\in U} \\left( \\sum_{k=1}^{N} \\delta_k i_k \\right) \\le V_{\\max} $$\n不确定性集合 $U$ 由以下约束定义：对于所有 $k \\in \\{1, \\dots, N\\}$，有 $0 \\le \\delta_k \\le d_k$，以及预算约束 $\\sum_{k=1}^{N} \\frac{\\delta_k}{d_k} \\le \\Gamma$。\n\n问题的核心是内部最大化问题，它用于寻找电压降的最坏情况惩罚项：\n$$ \\Pi(\\Gamma) = \\max \\sum_{k=1}^{N} i_k \\delta_k $$\n约束条件为：\n$$ \\sum_{k=1}^{N} \\frac{1}{d_k} \\delta_k \\le \\Gamma $$\n$$ 0 \\le \\delta_k \\le d_k, \\quad k=1, \\dots, N $$\n这是一个线性规划问题。为了获得鲁棒约束的 LP 重构，我们推导这个问题的对偶问题。设 $\\lambda \\ge 0$ 为预算约束的对偶变量，$\\rho_k \\ge 0$ 为上界约束 $\\delta_k \\le d_k$ 的对偶变量。约束 $\\delta_k \\ge 0$ 被隐式处理。\n\n对偶问题是：\n$$ \\min_{\\lambda \\ge 0, \\rho_k \\ge 0} \\left( \\Gamma \\lambda + \\sum_{k=1}^{N} d_k \\rho_k \\right) $$\n约束条件为：\n$$ \\frac{\\lambda}{d_k} + \\rho_k \\ge i_k, \\quad k=1, \\dots, N $$\n根据 LP 的强对偶性，$\\Pi(\\Gamma)$ 等于此对偶问题的最优值。因此，原始的鲁棒约束等价于以下包含辅助变量 $\\lambda$ 和 $\\rho_k$ 的线性约束系统：\n$$ V_{\\text{nom}} + \\Gamma \\lambda + \\sum_{k=1}^{N} d_k \\rho_k \\le V_{\\max} $$\n$$ \\lambda + d_k \\rho_k \\ge i_k d_k, \\quad k=1, \\dots, N $$\n$$ \\lambda \\ge 0, \\quad \\rho_k \\ge 0 $$\n这就是所要求的 LP 重构。\n\n接下来，我们推导 $\\Gamma$ 如何控制最坏情况惩罚项 $\\Pi(\\Gamma)$ 的大小。我们直接求解原始最大化问题。让我们引入缩放后的偏差变量 $z_k = \\delta_k/d_k$，因此有 $0 \\le z_k \\le 1$。问题变为：\n$$ \\Pi(\\Gamma) = \\max \\sum_{k=1}^{N} (i_k d_k) z_k $$\n约束条件为：\n$$ \\sum_{k=1}^{N} z_k \\le \\Gamma $$\n$$ 0 \\le z_k \\le 1, \\quad k=1, \\dots, N $$\n这是一个连续背包问题。最优解可以通过贪心方法找到。我们应该优先考虑具有最大潜在电压降增加的分段，该增加由乘积 $v_k = i_k d_k$ 给出。设 $\\pi$ 是索引 $\\{1, \\dots, N\\}$ 的一个排列，使得 $v_{\\pi(1)} \\ge v_{\\pi(2)} \\ge \\dots \\ge v_{\\pi(N)}$。\n\n贪心策略是对于最大的 $v_k$ 值，将 $z_k$ 设置为其最大值 $1$，直到预算 $\\Gamma$ 被用尽。设 $m = \\lfloor \\Gamma \\rfloor$ 为 $\\Gamma$ 的整数部分，$\\{\\Gamma\\} = \\Gamma - m$ 为其小数部分。\n最优解为设置：\n$z_{\\pi(k)} = 1$ 对于 $k = 1, \\dots, m$。\n$z_{\\pi(m+1)} = \\{\\Gamma\\}$。\n$z_{\\pi(k)} = 0$ 对于 $k > m+1$。\n总和为 $\\sum z_k = m \\cdot 1 + \\{\\Gamma\\} + 0 = \\Gamma$，满足预算约束。\n因此，最坏情况的附加惩罚项为：\n$$ \\Pi(\\Gamma) = \\sum_{k=1}^{N} v_k z_k = \\sum_{k=1}^{m} v_{\\pi(k)} \\cdot 1 + v_{\\pi(m+1)} \\cdot \\{\\Gamma\\} + \\sum_{k=m+2}^{N} v_{\\pi(k)} \\cdot 0 $$\n$$ \\Pi(\\Gamma) = \\sum_{k=1}^{\\lfloor \\Gamma \\rfloor} v_{\\pi(k)} + \\{\\Gamma\\} \\cdot v_{\\pi(\\lfloor \\Gamma \\rfloor + 1)} $$\n这个显式公式表明，惩罚项是关于 $\\Gamma$ 的一个分段线性凸函数。随着 $\\Gamma$ 的增加，惩罚函数的斜率减小，在区间 $\\Gamma \\in [m, m+1]$ 内的斜率等于第 $(m+1)$ 大的 $i_k d_k$ 值。\n\n最后，我们将此应用于给定的四段情况。\n数据：\n电流：$i_{1} = 80 \\, \\mathrm{A}$，$i_{2} = 60 \\, \\mathrm{A}$，$i_{3} = 50 \\, \\mathrm{A}$，$i_{4} = 40 \\, \\mathrm{A}$。\n标称电阻：$r_{1}^{0} = 0.5 \\, \\mathrm{m}\\Omega$，$r_{2}^{0} = 0.8 \\, \\mathrm{m}\\Omega$，$r_{3}^{0} = 0.3 \\, \\mathrm{m}\\Omega$，$r_{4}^{0} = 0.6 \\, \\mathrm{m}\\Omega$。\n偏差上限：$d_{1} = 0.1 \\, \\mathrm{m}\\Omega$，$d_{2} = 0.2 \\, \\mathrm{m}\\Omega$，$d_{3} = 0.05 \\, \\mathrm{m}\\Omega$，$d_{4} = 0.15 \\, \\mathrm{m}\\Omega$。\n预算：$\\Gamma = 2.3$。\n\n首先，计算标称电压降 $V_{\\text{nom}}$ （单位为毫伏，$\\mathrm{mV}$）：\n$$ V_{\\text{nom}} = (80)(0.5) + (60)(0.8) + (50)(0.3) + (40)(0.6) = 40 + 48 + 15 + 24 = 127 \\, \\mathrm{mV} $$\n接下来，计算乘积 $v_k = i_k d_k$ （单位为毫伏，$\\mathrm{mV}$）：\n$v_1 = i_1 d_1 = (80)(0.1) = 8 \\, \\mathrm{mV}$\n$v_2 = i_2 d_2 = (60)(0.2) = 12 \\, \\mathrm{mV}$\n$v_3 = i_3 d_3 = (50)(0.05) = 2.5 \\, \\mathrm{mV}$\n$v_4 = i_4 d_4 = (40)(0.15) = 6 \\, \\mathrm{mV}$\n\n将这些值按降序排序：\n$v_2 = 12$\n$v_1 = 8$\n$v_4 = 6$\n$v_3 = 2.5$\n排序后的索引顺序 $\\pi$ 是 $(2, 1, 4, 3)$。排序后的值为 $v_{\\pi(1)}=12$, $v_{\\pi(2)}=8$, $v_{\\pi(3)}=6$, $v_{\\pi(4)}=2.5$。\n\n对于 $\\Gamma = 2.3$，我们有 $\\lfloor \\Gamma \\rfloor = 2$ 和 $\\{\\Gamma\\} = 0.3$。\n使用最坏情况惩罚项 $\\Pi(\\Gamma)$ 的公式：\n$$ \\Pi(2.3) = v_{\\pi(1)} + v_{\\pi(2)} + 0.3 \\cdot v_{\\pi(3)} $$\n$$ \\Pi(2.3) = 12 + 8 + 0.3 \\cdot 6 = 20 + 1.8 = 21.8 \\, \\mathrm{mV} $$\n最坏情况总电压降是标称压降与最坏情况惩罚项之和：\n$$ V_{\\text{drop}}^{\\star}(\\Gamma) = V_{\\text{nom}} + \\Pi(\\Gamma) = 127 \\, \\mathrm{mV} + 21.8 \\, \\mathrm{mV} = 148.8 \\, \\mathrm{mV} $$\n转换为伏特：\n$$ V_{\\text{drop}}^{\\star}(2.3) = 0.1488 \\, \\mathrm{V} $$\n该值有四位有效数字。",
            "answer": "$$\\boxed{0.1488}$$"
        },
        {
            "introduction": "鲁棒优化提供的理论保障依赖于一个关键参数——不确定性预算 $\\Gamma$，必须谨慎选择。这个动手编程练习将指导您完成一个完整的数据驱动工作流程，使用样本外验证来调整 $\\Gamma$。您将学习如何在性能（例如，更快的充电速度）和安全性（避免电压违规）之间进行权衡，这是设计可靠电池管理系统的关键技能 。",
            "id": "3947183",
            "problem": "考虑一个在电压限制下，科学上合理但简化的锂离子电池组快速充电设计问题。在离散时间步 $t \\in \\{0,\\dots,T-1\\}$ 的端电压被建模为三部分贡献之和：来自标称仿真的开路电压 $U_{\\mathrm{nom},t}$、与施加电流 $I_t$ 成正比的欧姆压降，以及与步间电流变化幅度 $s_t = |I_t - I_{t-1}|$（约定 $I_{-1} = 0$）成正比的瞬态极化。该模型为\n$$\nV_t = U_{\\mathrm{nom},t} + R_{\\mathrm{nom}} I_t + P_{\\mathrm{nom}} s_t,\n$$\n其中，$R_{\\mathrm{nom}}$（欧姆电阻）和 $P_{\\mathrm{nom}}$（瞬态极化系数）是从先前的仿真和辨识中获得的标称系数。电压限制要求对所有 $t$ 都有 $V_t \\le V_{\\max}$。\n\n我们通过每时间步预算参数为 $\\Gamma \\in [0,2]$ 的预算不确定性模型（Bertsimas–Sim）来考虑参数 $R$ 和 $P$ 的不确定性。具体来说，我们假设 $R = R_{\\mathrm{nom}} + \\delta_R$ 和 $P = P_{\\mathrm{nom}} + \\delta_P$，其中非负偏差 $\\delta_R \\in [0,\\hat R]$ 和 $\\delta_P \\in [0,\\hat P]$ 受从训练数据估计出的不确定性半径 $\\hat R$ 和 $\\hat P$ 的限制。在预算 $\\Gamma$ 下，在每个时间步 $t$，两个不确定性贡献中至多有 $\\Gamma$ 个可以同时取其最坏情况值，当 $\\Gamma$ 为非整数时允许小数分配。在时间步 $t$ 的电压约束的鲁棒对应是\n$$\nU_{\\mathrm{nom},t} + R_{\\mathrm{nom}} I_t + P_{\\mathrm{nom}} s_t + \\Gamma z_t + p_{t,1} + p_{t,2} \\le V_{\\max},\n$$\n其中包含辅助变量 $z_t \\ge 0$、$p_{t,1} \\ge 0$、$p_{t,2} \\ge 0$ 和线性约束\n$$\np_{t,1} \\ge \\hat R\\, I_t - z_t, \\quad p_{t,2} \\ge \\hat P\\, s_t - z_t.\n$$\n这些是针对线性不等式系数的预算不确定性的标准线性规划鲁棒对应约束。绝对值 $s_t = |I_t - I_{t-1}|$ 由以下线性不等式强制执行\n$$\ns_t \\ge I_t - I_{t-1}, \\quad s_t \\ge I_{t-1} - I_t, \\quad s_t \\ge 0, \\quad I_{-1} = 0.\n$$\n\n设计目标是在满足 $0 \\le I_t \\le I_{\\max}$ 和所有 $t$ 的鲁棒电压约束的条件下，最大化总充电量 $Q = \\Delta t \\sum_{t=0}^{T-1} I_t$（单位：安秒）。我们将使用样本外验证来调整预算参数 $\\Gamma$，以在鲁棒性（在不确定性下遵守电压限制）和性能（大的 $Q$ 值）之间取得平衡。给定一个固定的候选 $\\Gamma$，我们求解上述鲁棒线性规划问题，以获得充电电流曲线 $I_t$ 及相关的阶跃变化幅度 $s_t$。然后，我们使用从指定分布中抽取的独立验证场景 $(\\delta_R,\\delta_P)$ 来评估样本外违规率，为每个场景计算是否存在任何 $t$ 违反 $V_t \\le V_{\\max}$。风险调整性能指标定义为\n$$\n\\widetilde{Q} = Q \\cdot (1 - \\text{violation\\_rate}),\n$$\n我们选择在验证数据上最大化 $\\widetilde{Q}$ 的 $\\Gamma$，若出现平局则选择最小的 $\\Gamma$。\n\n您的任务是使用以下参数值测试套件来实现此鲁棒调整过程。所有物理量必须在国际单位制（SI）中进行解释。所有电压以伏特（$\\mathrm{V}$）表示，电流以安培（$\\mathrm{A}$）表示，时间以秒（$\\mathrm{s}$）表示，电荷以安秒（$\\mathrm{A}\\cdot \\mathrm{s}$）表示。不涉及角度。最终输出必须是每个测试用例所选的 $\\Gamma$ 值，以浮点数形式表示。\n\n对于每个测试用例，使用训练数据，从指定的训练分布中抽取的非负偏差的经验 $0.95$ 分位数来估计 $(\\hat R, \\hat P)$。使用验证数据，从指定的混合分布中计算违规率。对于所有情况，使用 $\\Gamma$ 候选值 $\\{0.0, 0.5, 1.0, 1.5, 2.0\\}$。\n\n测试用例 1 (理想路径):\n- 视界长度 $T = 12$，步长 $\\Delta t = 5$。\n- 标称开路电压序列 $U_{\\mathrm{nom},t} = 380 + 0.4 t$，对于 $t = 0, \\dots, 11$。\n- 电压限制 $V_{\\max} = 402$。\n- 电流上限 $I_{\\max} = 180$。\n- 标称欧姆电阻 $R_{\\mathrm{nom}} = 0.010$。\n- 标称极化系数 $P_{\\mathrm{nom}} = 0.004$。\n- 训练偏差为独立抽样：$\\delta_R^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_R^2)|$，其中 $\\sigma_R = 0.001$；$\\delta_P^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_P^2)|$，其中 $\\sigma_P = 0.0005$；样本量 $N_{\\mathrm{train}} = 200$；随机种子 $123$。\n- 验证偏差遵循混合分布：以概率 $0.9$ 从 $|\\mathcal{N}(0, \\sigma_R^2)| \\times |\\mathcal{N}(0, \\sigma_P^2)|$ 抽取；以概率 $0.1$ 从 $|\\mathcal{N}(0, \\sigma_{R,\\mathrm{hi}}^2)| \\times |\\mathcal{N}(0, \\sigma_{P,\\mathrm{hi}}^2)|$ 抽取，其中 $\\sigma_{R,\\mathrm{hi}} = 0.002$，$\\sigma_{P,\\mathrm{hi}} = 0.0008$；样本量 $N_{\\mathrm{val}} = 1000$；随机种子 $456$。\n\n测试用例 2 (电压裕度紧张的边界情况):\n- 视界长度 $T = 12$，步长 $\\Delta t = 5$。\n- 标称开路电压序列 $U_{\\mathrm{nom},t} = 397 + 0.3 t$，对于 $t = 0, \\dots, 11$。\n- 电压限制 $V_{\\max} = 401$。\n- 电流上限 $I_{\\max} = 200$。\n- 标称欧姆电阻 $R_{\\mathrm{nom}} = 0.012$。\n- 标称极化系数 $P_{\\mathrm{nom}} = 0.005$。\n- 训练偏差：$\\delta_R^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_R^2)|$，其中 $\\sigma_R = 0.0012$；$\\delta_P^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_P^2)|$，其中 $\\sigma_P = 0.0006$；样本量 $N_{\\mathrm{train}} = 200$；随机种子 $789$。\n- 验证偏差混合分布：以概率 $0.85$ 从基础 $\\sigma_R, \\sigma_P$ 抽取；以概率 $0.15$ 从 $\\sigma_{R,\\mathrm{hi}} = 0.0024$, $\\sigma_{P,\\mathrm{hi}} = 0.001$ 抽取；样本量 $N_{\\mathrm{val}} = 1000$；随机种子 $2468$。\n\n测试用例 3 (小视界长度的边缘情况):\n- 视界长度 $T = 4$，步长 $\\Delta t = 5$。\n- 标称开路电压序列 $U_{\\mathrm{nom},t} = 380 + 0.6 t$，对于 $t = 0, \\dots, 3$。\n- 电压限制 $V_{\\max} = 390$。\n- 电流上限 $I_{\\max} = 220$。\n- 标称欧姆电阻 $R_{\\mathrm{nom}} = 0.009$。\n- 标称极化系数 $P_{\\mathrm{nom}} = 0.0035$。\n- 训练偏差：$\\delta_R^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_R^2)|$，其中 $\\sigma_R = 0.0008$；$\\delta_P^{\\mathrm{train}} = |\\mathcal{N}(0, \\sigma_P^2)|$，其中 $\\sigma_P = 0.0004$；样本量 $N_{\\mathrm{train}} = 200$；随机种子 $1357$。\n- 验证偏差混合分布：以概率 $0.95$ 从基础 $\\sigma_R, \\sigma_P$ 抽取；以概率 $0.05$ 从 $\\sigma_{R,\\mathrm{hi}} = 0.0016$, $\\sigma_{P,\\mathrm{hi}} = 0.0007$ 抽取；样本量 $N_{\\mathrm{val}} = 1000$；随机种子 $97531$。\n\n算法要求：\n- 对每个测试用例，从训练样本中估计 $\\hat R$ 和 $\\hat P$ 为经验 $0.95$ 分位数。\n- 对每个候选 $\\Gamma \\in \\{0.0, 0.5, 1.0, 1.5, 2.0\\}$，求解鲁棒线性规划以找到在鲁棒约束和边界条件下最大化 $Q$ 的 $I_t$ 和 $s_t$。\n- 使用验证场景，为获得的曲线 $(I_t, s_t)$ 计算在所有 $t$ 上 $V_t \\le V_{\\max}$ 的违规率，并计算 $\\widetilde{Q} = Q \\cdot (1 - \\text{violation\\_rate})$。\n- 选择最大化 $\\widetilde{Q}$ 的 $\\Gamma$；如果多个 $\\Gamma$ 打平，则选择最小的那个。\n\n最终输出规范：\n- 您的程序应生成单行输出，其中包含上述三个测试用例所选的 $\\Gamma$ 值，形式为方括号内以逗号分隔的列表（例如，$[0.0,1.0,1.5]$）。结果必须是浮点数。\n\n科学依据与现实性：\n- 电压模型使用欧姆定律和标准的一阶极化项，这在等效电路电池模型中被广泛使用。\n- 鲁棒对应遵循 Bertsimas 和 Sim 经过充分检验的预算不确定性框架，从而产生适合算法求解的线性规划约束。\n- 所有参数和量值都选择为对车用规模电池组而言是合理的，电压在数百伏特，电流在数百安培。",
            "solution": "所呈现的问题是一项为锂离子电池组设计快速充电电流曲线的鲁棒优化任务。该问题具有科学依据、定义明确，并提供了所有必要的参数和程序。\n任务的核心是通过在充电性能与参数不确定性下违反电压安全限制的风险之间进行权衡，来确定鲁棒性预算参数 $\\Gamma$ 的最优值。该问题是有效的，并且可以通过算法求解。\n\n对于每个测试用例，该过程包括以下主要步骤：\n1.  **随机数据生成**：根据指定的统计分布，为不确定参数生成训练和验证样本。\n2.  **不确定性集估计**：使用训练数据，通过估计不确定性半径 $\\hat{R}$ 和 $\\hat{P}$ 来定义鲁棒优化模型的不确定性集。\n3.  **迭代鲁棒优化**：对于一组候选 $\\Gamma$ 值，求解一个鲁棒线性规划（LP）以找到最优的充电电流曲线。\n4.  **样本外验证**：使用独立的验证数据集评估每个曲线的性能和鲁棒性。\n5.  **最优参数选择**：选择使风险调整性能指标最大化的 $\\Gamma$ 值。\n\n我们现在详细说明数学公式和算法过程。\n\n**1. 模型与目标函数**\n\n在每个离散时间步 $t \\in \\{0, \\dots, T-1\\}$ 的端电压 $V_t$ 由以下公式给出：\n$$\nV_t(I_t, s_t; R, P) = U_{\\mathrm{nom},t} + R I_t + P s_t\n$$\n其中，$U_{\\mathrm{nom},t}$ 是标称开路电压，$I_t$ 是充电电流，$s_t = |I_t - I_{t-1}|$ 是电流变化的幅度（约定 $I_{-1} = 0$），$R$ 和 $P$ 分别是不确定的欧姆电阻和极化系数。\n\n目标是在时间视界 $T$ 内最大化传递给电池的总电荷 $Q$：\n$$\n\\text{Maximize} \\quad Q = \\Delta t \\sum_{t=0}^{T-1} I_t\n$$\n其中 $\\Delta t$ 是一个时间步的持续时间。\n\n**2. 鲁棒优化公式**\n\n参数 $R$ 和 $P$ 被建模为 $R = R_{\\mathrm{nom}} + \\delta_R$ 和 $P = P_{\\mathrm{nom}} + \\delta_P$，其中偏差 $\\delta_R \\in [0, \\hat{R}]$ 和 $\\delta_P \\in [0, \\hat{P}]$。半径 $\\hat{R}$ 和 $\\hat{P}$ 是从指定分布中抽取的训练数据的经验 $0.95$ 分位数确定的。\n\n电压约束 $V_t \\le V_{\\max}$ 必须对所有 $t$ 和所有允许的参数偏差都成立。使用预算为 $\\Gamma \\in [0, 2]$ 的 Bertsimas-Sim 预算不确定性方法，为每个时间步 $t$ 的不确定性最坏情况实现进行建模。这导出了电压约束的鲁棒对应：\n$$\nU_{\\mathrm{nom},t} + R_{\\mathrm{nom}} I_t + P_{\\mathrm{nom}} s_t + \\underbrace{\\max_{\\substack{S \\subseteq \\{1, 2\\}, |S| \\le \\Gamma}} \\left\\{ \\sum_{i \\in S} \\text{dev}_i \\right\\}}_{\\text{鲁棒性项}} \\le V_{\\max}\n$$\n其中 $\\text{dev}_1 = \\hat{R}I_t$ 和 $\\text{dev}_2 = \\hat{P}s_t$。这个内部最大化问题的对偶问题产生了一组线性约束。完整的优化问题被构建为一个线性规划（LP）。\n\n**决策变量**：\n对于每个时间步 $t \\in \\{0, \\dots, T-1\\}$，我们定义以下变量：\n- $I_t$: 充电电流。\n- $s_t$: 电流变化幅度。\n- $z_t, p_{t,1}, p_{t,2}$: 鲁棒对应的辅助变量。\n\n完整的决策变量向量为 $\\mathbf{x} \\in \\mathbb{R}^{5T}$，结构如下：\n$$\n\\mathbf{x} = [I_0, \\dots, I_{T-1}, s_0, \\dots, s_{T-1}, z_0, \\dots, z_{T-1}, p_{0,1}, \\dots, p_{T-1,1}, p_{0,2}, \\dots, p_{T-1,2}]^T\n$$\n\n**线性规划公式**：\n问题是求解：\n$$\n\\max_{\\mathbf{x}} \\quad \\mathbf{c}^T \\mathbf{x} \\quad \\text{subject to} \\quad \\mathbf{A}_{\\text{ub}} \\mathbf{x} \\le \\mathbf{b}_{\\text{ub}} \\quad \\text{and} \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u}\n$$\n其中目标向量 $\\mathbf{c}$ 对于每个 $I_t$ 的条目为 $\\Delta t$，其他为 $0$。由于 $\\Delta t$ 是一个正常数，我们可以等价地最大化 $\\sum I_t$，然后将结果乘以 $\\Delta t$。\n\n**每个 $t \\in \\{0, \\dots, T-1\\}$ 的约束条件**：\n1.  **鲁棒电压约束**:\n    $$R_{\\mathrm{nom}} I_t + P_{\\mathrm{nom}} s_t + \\Gamma z_t + p_{t,1} + p_{t,2} \\le V_{\\max} - U_{\\mathrm{nom},t}$$\n2.  **鲁棒对应辅助约束**:\n    $$\\hat{R} I_t - z_t - p_{t,1} \\le 0$$\n    $$\\hat{P} s_t - z_t - p_{t,2} \\le 0$$\n3.  **绝对值线性化**: 约束 $s_t \\ge |I_t - I_{t-1}|$ 被线性化为：\n    $$I_t - I_{t-1} - s_t \\le 0$$\n    $$I_{t-1} - I_t - s_t \\le 0$$\n    （约定 $I_{-1} = 0$）。\n4.  **变量边界**:\n    $$0 \\le I_t \\le I_{\\max}$$\n    $$s_t \\ge 0, \\quad z_t \\ge 0, \\quad p_{t,1} \\ge 0, \\quad p_{t,2} \\ge 0$$\n\n**3. 调整预算参数 $\\Gamma$**\n\n主要任务是从候选集 $\\{0.0, 0.5, 1.0, 1.5, 2.0\\}$ 中选择最佳的 $\\Gamma$。该选择基于在样本外验证数据上评估的风险调整性能指标 $\\widetilde{Q}$。\n\n对于每个候选 $\\Gamma$：\n1.  构建并求解上述定义的 LP，以找到最优电流曲线 $\\{I_t^*\\}_{t=0}^{T-1}$ 和相应的电流变化 $\\{s_t^*\\}_{t=0}^{T-1}$。\n2.  计算总电荷：$Q^* = \\Delta t \\sum_{t=0}^{T-1} I_t^*$。\n3.  使用 $N_{\\mathrm{val}}$ 个验证场景 $(\\delta_{R,j}, \\delta_{P,j})$ 评估此曲线的鲁棒性。对于每个场景 $j=1, \\dots, N_{\\mathrm{val}}$，如果在任何时间步电压限制被突破，则发生违规：\n    $$\n    \\exists t \\in \\{0, \\dots, T-1\\} \\quad \\text{s.t.} \\quad U_{\\mathrm{nom},t} + (R_{\\mathrm{nom}} + \\delta_{R,j})I_t^* + (P_{\\mathrm{nom}} + \\delta_{P,j})s_t^* > V_{\\max}\n    $$\n4.  违规率 $v$ 是导致违规的验证场景的比例。\n5.  计算风险调整后的电荷：$\\widetilde{Q} = Q^* \\cdot (1 - v)$。\n\n最优预算参数 $\\Gamma_{\\text{opt}}$ 是使 $\\widetilde{Q}$ 最大化的那个。如果 $\\widetilde{Q}$ 值出现平局，则选择最小的 $\\Gamma$。\n\n**4. 算法实现**\n\n对于每个测试用例，算法按以下步骤进行：\n1.  为可复现性设置随机数生成器种子。从折叠正态分布 $|\\mathcal{N}(0, \\sigma^2)|$ 生成 $N_{\\mathrm{train}}=200$ 个 $(\\delta_R^{\\mathrm{train}}, \\delta_P^{\\mathrm{train}})$ 样本。\n2.  将生成的 $\\delta_R^{\\mathrm{train}}$ 和 $\\delta_P^{\\mathrm{train}}$ 样本的 $0.95$ 分位数分别作为 $\\hat{R}$ 和 $\\hat{P}$。\n3.  设置新种子并从指定的混合分布生成 $N_{\\mathrm{val}}=1000$ 个验证样本 $(\\delta_R^{\\mathrm{val}}, \\delta_P^{\\mathrm{val}})$。\n4.  初始化 $\\Gamma_{\\text{opt}} = -1.0$ 和 $\\widetilde{Q}_{\\max} = -1.0$。\n5.  遍历每个 $\\Gamma \\in \\{0.0, 0.5, 1.0, 1.5, 2.0\\}$：\n    a. 基于问题参数、估计的 $(\\hat{R}, \\hat{P})$ 和当前的 $\\Gamma$ 构建 LP 矩阵 $\\mathbf{c}$、$\\mathbf{A}_{\\text{ub}}$、$\\mathbf{b}_{\\text{ub}}$ 和边界 $(\\mathbf{l}, \\mathbf{u})$。\n    b. 使用标准求解器（例如 `scipy.optimize.linprog`）求解 LP 以获得最优解向量 $\\mathbf{x}^*$。\n    c. 提取最优电流曲线 $\\{I_t^*\\}$ 和阶跃变化 $\\{s_t^*\\}$。\n    d. 使用验证数据计算 $Q^*$ 和违规率 $v$。\n    e. 计算 $\\widetilde{Q} = Q^* \\cdot (1 - v)$。\n    f. 如果 $\\widetilde{Q} > \\widetilde{Q}_{\\max}$，则更新 $\\widetilde{Q}_{\\max} = \\widetilde{Q}$ 和 $\\Gamma_{\\text{opt}} = \\Gamma$。平局决胜规则（选择最小的 $\\Gamma$）通过严格不等式来处理。\n6.  测试用例的最终结果是 $\\Gamma_{\\text{opt}}$。对所有三个测试用例重复此整个过程。\n\n这种系统性方法确保所选的充电策略不仅在输送电荷方面表现出色，而且对电池参数的预期变化具有鲁棒性，这是安全可靠运行的关键考虑因素。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linprog\n\ndef solve():\n    \"\"\"\n    Main solver function that iterates through test cases and prints the final result.\n    \"\"\"\n    \n    test_cases = [\n        # Test Case 1 (happy path)\n        {\n            \"T\": 12, \"delta_t\": 5.0,\n            \"U_nom_func\": lambda t: 380.0 + 0.4 * t,\n            \"V_max\": 402.0, \"I_max\": 180.0,\n            \"R_nom\": 0.010, \"P_nom\": 0.004,\n            \"train_params\": {\"N\": 200, \"sigma_R\": 0.001, \"sigma_P\": 0.0005, \"seed\": 123},\n            \"val_params\": {\n                \"N\": 1000, \"seed\": 456, \"mix_prob\": 0.1,\n                \"base_sigma_R\": 0.001, \"base_sigma_P\": 0.0005,\n                \"hi_sigma_R\": 0.002, \"hi_sigma_P\": 0.0008,\n            }\n        },\n        # Test Case 2 (tight voltage headroom)\n        {\n            \"T\": 12, \"delta_t\": 5.0,\n            \"U_nom_func\": lambda t: 397.0 + 0.3 * t,\n            \"V_max\": 401.0, \"I_max\": 200.0,\n            \"R_nom\": 0.012, \"P_nom\": 0.005,\n            \"train_params\": {\"N\": 200, \"sigma_R\": 0.0012, \"sigma_P\": 0.0006, \"seed\": 789},\n            \"val_params\": {\n                \"N\": 1000, \"seed\": 2468, \"mix_prob\": 0.15,\n                \"base_sigma_R\": 0.0012, \"base_sigma_P\": 0.0006,\n                \"hi_sigma_R\": 0.0024, \"hi_sigma_P\": 0.001,\n            }\n        },\n        # Test Case 3 (edge case small horizon)\n        {\n            \"T\": 4, \"delta_t\": 5.0,\n            \"U_nom_func\": lambda t: 380.0 + 0.6 * t,\n            \"V_max\": 390.0, \"I_max\": 220.0,\n            \"R_nom\": 0.009, \"P_nom\": 0.0035,\n            \"train_params\": {\"N\": 200, \"sigma_R\": 0.0008, \"sigma_P\": 0.0004, \"seed\": 1357},\n            \"val_params\": {\n                \"N\": 1000, \"seed\": 97531, \"mix_prob\": 0.05,\n                \"base_sigma_R\": 0.0008, \"base_sigma_P\": 0.0004,\n                \"hi_sigma_R\": 0.0016, \"hi_sigma_P\": 0.0007,\n            }\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        best_gamma = run_test_case(params)\n        results.append(best_gamma)\n    \n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_test_case(params):\n    \"\"\"\n    Executes the full robust tuning procedure for a single test case.\n    \"\"\"\n    T = params[\"T\"]\n    delta_t = params[\"delta_t\"]\n    U_nom = np.array([params[\"U_nom_func\"](t) for t in range(T)])\n    V_max = params[\"V_max\"]\n    I_max = params[\"I_max\"]\n    R_nom = params[\"R_nom\"]\n    P_nom = params[\"P_nom\"]\n    \n    gamma_candidates = [0.0, 0.5, 1.0, 1.5, 2.0]\n\n    # --- Step 1: Data Generation ---\n    # Training data\n    train_p = params[\"train_params\"]\n    rng_train = np.random.default_rng(train_p[\"seed\"])\n    delta_R_train = np.abs(rng_train.normal(0, train_p[\"sigma_R\"], train_p[\"N\"]))\n    delta_P_train = np.abs(rng_train.normal(0, train_p[\"sigma_P\"], train_p[\"N\"]))\n\n    # Validation data\n    val_p = params[\"val_params\"]\n    rng_val = np.random.default_rng(val_p[\"seed\"])\n    N_val = val_p[\"N\"]\n    \n    N_hi = int(N_val * val_p[\"mix_prob\"])\n    N_base = N_val - N_hi\n    \n    delta_R_val_base = np.abs(rng_val.normal(0, val_p[\"base_sigma_R\"], N_base))\n    delta_P_val_base = np.abs(rng_val.normal(0, val_p[\"base_sigma_P\"], N_base))\n\n    delta_R_val_hi = np.abs(rng_val.normal(0, val_p[\"hi_sigma_R\"], N_hi))\n    delta_P_val_hi = np.abs(rng_val.normal(0, val_p[\"hi_sigma_P\"], N_hi))\n\n    delta_R_val = np.concatenate((delta_R_val_base, delta_R_val_hi))\n    delta_P_val = np.concatenate((delta_P_val_base, delta_P_val_hi))\n    val_scenarios = np.stack((delta_R_val, delta_P_val), axis=1) # Shape (N_val, 2)\n    rng_val.shuffle(val_scenarios) # Shuffle to mix the groups\n\n    # --- Step 2: Uncertainty Radii Estimation ---\n    R_hat = np.quantile(delta_R_train, 0.95)\n    P_hat = np.quantile(delta_P_train, 0.95)\n\n    best_gamma = -1.0\n    max_q_tilde = -1.0\n\n    # --- Step 3  4  5: Tuning Loop ---\n    for gamma in gamma_candidates:\n        # --- Construct and Solve the LP ---\n        # Variable vector x = [I_0..I_T-1, s_0..s_T-1, z_0..z_T-1, p1_0..p1_T-1, p2_0..p2_T-1]\n        # Total variables: 5 * T\n        I_offset, s_offset, z_offset, p1_offset, p2_offset = 0, T, 2 * T, 3 * T, 4 * T\n\n        # Objective: Maximize sum(I_t), so minimize -sum(I_t)\n        c = np.zeros(5 * T)\n        c[I_offset : I_offset + T] = -1.0\n\n        num_constraints = 5 * T\n        A_ub = np.zeros((num_constraints, 5 * T))\n        b_ub = np.zeros(num_constraints)\n        \n        row_idx = 0\n        for t in range(T):\n            # Robust voltage constraint\n            A_ub[row_idx, I_offset + t] = R_nom\n            A_ub[row_idx, s_offset + t] = P_nom\n            A_ub[row_idx, z_offset + t] = gamma\n            A_ub[row_idx, p1_offset + t] = 1.0\n            A_ub[row_idx, p2_offset + t] = 1.0\n            b_ub[row_idx] = V_max - U_nom[t]\n            row_idx += 1\n        \n        for t in range(T):\n            # Robust counterpart constraint 1\n            A_ub[row_idx, I_offset + t] = R_hat\n            A_ub[row_idx, z_offset + t] = -1.0\n            A_ub[row_idx, p1_offset + t] = -1.0\n            b_ub[row_idx] = 0.0\n            row_idx += 1\n            \n        for t in range(T):\n            # Robust counterpart constraint 2\n            A_ub[row_idx, s_offset + t] = P_hat\n            A_ub[row_idx, z_offset + t] = -1.0\n            A_ub[row_idx, p2_offset + t] = -1.0\n            b_ub[row_idx] = 0.0\n            row_idx += 1\n\n        for t in range(T):\n            # Absolute value s_t = I_t - I_{t-1}\n            A_ub[row_idx, I_offset + t] = 1.0\n            if t  0:\n                A_ub[row_idx, I_offset + t - 1] = -1.0\n            A_ub[row_idx, s_offset + t] = -1.0\n            b_ub[row_idx] = 0.0\n            row_idx += 1\n\n        for t in range(T):\n            # Absolute value s_t = I_{t-1} - I_t\n            A_ub[row_idx, I_offset + t] = -1.0\n            if t  0:\n                A_ub[row_idx, I_offset + t - 1] = 1.0\n            A_ub[row_idx, s_offset + t] = -1.0\n            b_ub[row_idx] = 0.0\n            row_idx += 1\n            \n        # Bounds on variables\n        bounds = [(0, I_max)] * T + [(0, None)] * (4 * T)\n        \n        res = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')\n\n        if not res.success:\n            # If LP fails, this gamma is non-viable. Assign worst performance.\n            q_tilde = -1.0\n        else:\n            I_opt = res.x[I_offset : I_offset + T]\n            s_opt = res.x[s_offset : s_offset + T]\n            \n            Q = delta_t * np.sum(I_opt)\n\n            # Evaluate violation rate\n            violation_count = 0\n            for delta_R, delta_P in val_scenarios:\n                R_val = R_nom + delta_R\n                P_val = P_nom + delta_P\n                \n                V_val = U_nom + R_val * I_opt + P_val * s_opt\n                \n                if np.any(V_val  V_max):\n                    violation_count += 1\n            \n            violation_rate = violation_count / N_val\n            q_tilde = Q * (1 - violation_rate)\n        \n        # Update best gamma\n        if q_tilde  max_q_tilde:\n            max_q_tilde = q_tilde\n            best_gamma = gamma\n            \n    return best_gamma\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}