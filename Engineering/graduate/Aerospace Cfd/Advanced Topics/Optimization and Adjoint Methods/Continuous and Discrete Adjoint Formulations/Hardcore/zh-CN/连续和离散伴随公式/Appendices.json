{
    "hands_on_practices": [
        {
            "introduction": "在将伴随方法自动化应用于大规模问题之前，从最基础的层面理解其工作原理至关重要。本练习旨在通过对一个常见的CFD通量计算手动应用反向模式自动微分（离散伴随方法的算法等价物），来揭开其神秘面纱。通过一步步追踪计算图并反向传播梯度，您将为后续更复杂的应用打下坚实的直观基础。",
            "id": "3950963",
            "problem": "考虑一个一维无量纲标量守恒律，它代表了计算流体动力学（CFD）中使用的通量计算程序，其中数值界面通量是使用 Rusanov（局部 Lax–Friedrichs）方法构建的。设左、右态为 $u_{L}$ 和 $u_{R}$。原始通量函数为 $f(u) = \\frac{1}{2} u^{2}$。特征速度为 $a_{L} = |u_{L}|$ 和 $a_{R} = |u_{R}|$，谱半径为 $a_{\\max} = \\max(a_{L}, a_{R})$。Rusanov 通量为\n$$\nF = \\frac{1}{2}\\big(f(u_{L}) + f(u_{R})\\big) - \\frac{1}{2} a_{\\max} \\big(u_{R} - u_{L}\\big).\n$$\n定义一个标量目标泛函\n$$\nJ = w F + c F^{2},\n$$\n其中 $w$ 和 $c$ 是固定的无量纲系数。\n\n从微积分的链式法则和反向模式自动微分（AD）（即计算图的离散伴随）的定义出发，为上述通量计算程序配备反向模式AD，并推导计算图中每个中间变量（包括 $f(u_{L})$、$f(u_{R})$、$a_{L}$、$a_{R}$、$a_{\\max}$、$F$ 以及输入 $u_{L}$ 和 $u_{R}$）的伴随（反向模式）更新。假设在 $|\\cdot|$ 和 $\\max(\\cdot,\\cdot)$ 的不可导点之外具有标准可微性，并对 $\\max$ 采用由记录的原始值确定的激活分支导数。\n\n对于一次具体评估，取 $u_{L} = 1.7$、$u_{R} = -0.9$、$w = 1.2$ 和 $c = 0.3$。使用推导出的伴随更新，计算梯度 $\\nabla J = \\big(\\frac{\\partial J}{\\partial u_{L}}, \\frac{\\partial J}{\\partial u_{R}}\\big)$ 的数值。将最终梯度的每个分量四舍五入到六位有效数字。这些变量都是无量纲的；答案中不需要物理单位。将最终梯度表示为行矩阵。",
            "solution": "用户希望求出目标泛函 $J$ 关于输入态 $u_L$ 和 $u_R$ 的梯度。这将通过使用反向模式自动微分（AD）（也称为离散伴随方法）来完成。该过程包括两个阶段：一个前向传播过程，用以计算 $J$ 的值并存储所有中间变量；以及一个反向传播过程，用以将导数从输出 $J$ 传播回输入 $u_L$ 和 $u_R$。\n\n### 步骤 1：问题验证\n\n**1.1. 提取已知条件**\n- **状态**: $u_{L}$ 和 $u_{R}$\n- **原始通量函数**: $f(u) = \\frac{1}{2} u^{2}$\n- **特征速度**: $a_{L} = |u_{L}|$, $a_{R} = |u_{R}|$\n- **谱半径**: $a_{\\max} = \\max(a_{L}, a_{R})$\n- **Rusanov 通量**: $F = \\frac{1}{2}\\big(f(u_{L}) + f(u_{R})\\big) - \\frac{1}{2} a_{\\max} \\big(u_{R} - u_{L}\\big)$\n- **目标泛函**: $J = w F + c F^{2}$\n- **固定系数**: $w$, $c$\n- **数值**: $u_{L} = 1.7$, $u_{R} = -0.9$, $w = 1.2$, $c = 0.3$\n- **任务**: 推导伴随更新并计算数值梯度 $\\nabla J = \\big(\\frac{\\partial J}{\\partial u_{L}}, \\frac{\\partial J}{\\partial u_{R}}\\big)$。\n- **AD 假设**: 对不可微函数使用激活分支导数。\n\n**1.2. 使用提取的已知条件进行验证**\n该问题在科学上是成立的，因为它涉及计算流体动力学中的标准概念（Rusanov 通量）和数值优化中的标准概念（反向模式 AD）。该问题是适定的，提供了唯一解所需的所有方程和数据。语言客观、精确。该问题没有违反任何无效性标准。\n\n**1.3. 结论与行动**\n该问题有效。将提供完整解答。\n\n### 步骤 2：解题推导\n\n求解过程遵循反向模式 AD 的结构。\n\n**A. 前向传播：计算图**\n\n从输入 $u_L$ 和 $u_R$ 计算 $J$ 的过程可以分解为一系列基本运算，构成一个计算图。\n\n1.  $f_L = \\frac{1}{2} u_L^2$\n2.  $f_R = \\frac{1}{2} u_R^2$\n3.  $a_L = |u_L|$\n4.  $a_R = |u_R|$\n5.  $a_{\\max} = \\max(a_L, a_R)$\n6.  $F = \\frac{1}{2}(f_L + f_R) - \\frac{1}{2} a_{\\max} (u_R - u_L)$\n7.  $J = w F + c F^2$\n\n**B. 反向传播：伴随更新推导**\n\n反向传播通过反向遍历计算图来计算伴随变量（用变量上方的横杠表示，例如 $\\bar{v} = \\frac{\\partial J}{\\partial v}$）。每一步都应用链式法则。我们将所有伴随变量初始化为 $0$，除了最终输出 $\\bar{J} = \\frac{\\partial J}{\\partial J} = 1$。\n\n1.  **F 的伴随变量**：从 $J = w F + c F^2$，我们计算 $\\bar{F}$。\n    $$ \\bar{F} = \\bar{J} \\frac{dJ}{dF} = 1 \\cdot (w + 2cF) = w + 2cF $$\n\n2.  **从 F 得到的伴随变量**：从 $F = \\frac{1}{2}(f_L + f_R) - \\frac{1}{2} a_{\\max} (u_R - u_L)$，我们将 $\\bar{F}$ 传播给它的参数。伴随更新是累积的。\n    $$ \\bar{f_L} \\mathrel{+}= \\bar{F} \\frac{\\partial F}{\\partial f_L} = \\frac{1}{2} \\bar{F} $$\n    $$ \\bar{f_R} \\mathrel{+}= \\bar{F} \\frac{\\partial F}{\\partial f_R} = \\frac{1}{2} \\bar{F} $$\n    $$ \\bar{a}_{\\max} \\mathrel{+}= \\bar{F} \\frac{\\partial F}{\\partial a_{\\max}} = -\\frac{1}{2}(u_R - u_L) \\bar{F} $$\n    函数 $F$ 也显式依赖于 $u_L$ 和 $u_R$。\n    $$ \\bar{u}_L \\mathrel{+}= \\bar{F} \\frac{\\partial F}{\\partial u_L} = \\frac{1}{2} a_{\\max} \\bar{F} $$\n    $$ \\bar{u}_R \\mathrel{+}= \\bar{F} \\frac{\\partial F}{\\partial u_R} = -\\frac{1}{2} a_{\\max} \\bar{F} $$\n\n3.  **从 $a_{\\max}$ 得到的伴随变量**：从 $a_{\\max} = \\max(a_L, a_R)$，我们根据前向传播过程中确定的激活分支来传播 $\\bar{a}_{\\max}$。\n    如果 $a_L > a_R$：\n    $$ \\bar{a}_L \\mathrel{+}= \\bar{a}_{\\max} \\frac{\\partial a_{\\max}}{\\partial a_L} = \\bar{a}_{\\max} \\cdot 1 $$\n    $$ \\bar{a}_R \\mathrel{+}= \\bar{a}_{\\max} \\frac{\\partial a_{\\max}}{\\partial a_R} = \\bar{a}_{\\max} \\cdot 0 = 0 $$\n    如果 $a_R > a_L$：\n    $$ \\bar{a}_L \\mathrel{+}= \\bar{a}_{\\max} \\frac{\\partial a_{\\max}}{\\partial a_L} = \\bar{a}_{\\max} \\cdot 0 = 0 $$\n    $$ \\bar{a}_R \\mathrel{+}= \\bar{a}_{\\max} \\frac{\\partial a_{\\max}}{\\partial a_R} = \\bar{a}_{\\max} \\cdot 1 $$\n\n4.  **从 $a_L$ 和 $a_R$ 得到的伴随变量**：从 $a_L = |u_L|$ 和 $a_R = |u_R|$，我们使用导数 $\\frac{d|x|}{dx} = \\text{sgn}(x)$（对于 $x \\neq 0$）。\n    $$ \\bar{u}_L \\mathrel{+}= \\bar{a}_L \\frac{da_L}{du_L} = \\bar{a}_L \\cdot \\text{sgn}(u_L) $$\n    $$ \\bar{u}_R \\mathrel{+}= \\bar{a}_R \\frac{da_R}{du_R} = \\bar{a}_R \\cdot \\text{sgn}(u_R) $$\n\n5.  **从 $f_L$ 和 $f_R$ 得到的伴随变量**：从 $f_L = \\frac{1}{2}u_L^2$ 和 $f_R = \\frac{1}{2}u_R^2$。\n    $$ \\bar{u}_L \\mathrel{+}= \\bar{f}_L \\frac{df_L}{du_L} = \\bar{f}_L \\cdot u_L $$\n    $$ \\bar{u}_R \\mathrel{+}= \\bar{f}_R \\frac{df_R}{du_R} = \\bar{f}_R \\cdot u_R $$\n\n在所有贡献都累积后，$\\bar{u}_L$ 和 $\\bar{u}_R$ 的最终值就是所求的梯度分量 $\\frac{\\partial J}{\\partial u_L}$ 和 $\\frac{\\partial J}{\\partial u_R}$。\n\n**C. 数值计算**\n\n现在我们用给定的数值进行这些步骤：$u_{L} = 1.7$，$u_{R} = -0.9$，$w = 1.2$，$c = 0.3$。\n\n**前向传播执行**：\n- $u_L = 1.7$\n- $u_R = -0.9$\n- $f_L = \\frac{1}{2}(1.7)^2 = \\frac{1}{2}(2.89) = 1.445$\n- $f_R = \\frac{1}{2}(-0.9)^2 = \\frac{1}{2}(0.81) = 0.405$\n- $a_L = |1.7| = 1.7$\n- $a_R = |-0.9| = 0.9$\n- $a_{\\max} = \\max(1.7, 0.9) = 1.7$\n- $F = \\frac{1}{2}(1.445 + 0.405) - \\frac{1}{2}(1.7)(-0.9 - 1.7) = \\frac{1}{2}(1.85) - (0.85)(-2.6) = 0.925 + 2.21 = 3.135$\n- $J = 1.2(3.135) + 0.3(3.135)^2 = 3.762 + 0.3(9.828225) = 3.762 + 2.9484675 = 6.7104675$\n\n**反向传播执行**：\n将所有伴随变量初始化为 $0$。设 $\\bar{u}_L$ 和 $\\bar{u}_R$ 为最终梯度的累加器。\n\n1.  **从 $\\bar{J}=1$ 开始**：\n    $\\bar{F} = w + 2cF = 1.2 + 2(0.3)(3.135) = 1.2 + 0.6(3.135) = 1.2 + 1.881 = 3.081$。\n\n2.  **传播 $\\bar{F}$**：\n    $\\bar{f_L} = \\frac{1}{2}\\bar{F} = \\frac{1}{2}(3.081) = 1.5405$。\n    $\\bar{f_R} = \\frac{1}{2}\\bar{F} = \\frac{1}{2}(3.081) = 1.5405$。\n    $\\bar{a}_{\\max} = -\\frac{1}{2}(u_R - u_L)\\bar{F} = -\\frac{1}{2}(-0.9 - 1.7)(3.081) = -\\frac{1}{2}(-2.6)(3.081) = 1.3(3.081) = 4.0053$。\n    对 $\\bar{u}_L$ 的贡献：$\\frac{1}{2}a_{\\max}\\bar{F} = \\frac{1}{2}(1.7)(3.081) = 0.85(3.081) = 2.61885$。因此，$\\bar{u}_L = 2.61885$。\n    对 $\\bar{u}_R$ 的贡献：$-\\frac{1}{2}a_{\\max}\\bar{F} = -\\frac{1}{2}(1.7)(3.081) = -0.85(3.081) = -2.61885$。因此，$\\bar{u}_R = -2.61885$。\n\n3.  **传播 $\\bar{a}_{\\max}$**：\n    因为 $a_L = 1.7 > a_R = 0.9$，所以激活分支是 $a_L$。\n    $\\bar{a}_L = \\bar{a}_{\\max} \\cdot 1 = 4.0053$。\n    $\\bar{a}_R = \\bar{a}_{\\max} \\cdot 0 = 0$。\n\n4.  **传播 $\\bar{a}_L$ 和 $\\bar{a}_R$**：\n    $\\text{sgn}(u_L) = \\text{sgn}(1.7) = 1$。对 $\\bar{u}_L$ 的贡献：$\\bar{a}_L \\cdot \\text{sgn}(u_L) = 4.0053 \\cdot 1 = 4.0053$。\n    $\\bar{u}_L \\mathrel{+}= 4.0053 \\implies \\bar{u}_L = 2.61885 + 4.0053 = 6.62415$。\n    $\\text{sgn}(u_R) = \\text{sgn}(-0.9) = -1$。对 $\\bar{u}_R$ 的贡献：$\\bar{a}_R \\cdot \\text{sgn}(u_R) = 0 \\cdot (-1) = 0$。\n    $\\bar{u}_R \\mathrel{+}= 0 \\implies \\bar{u}_R = -2.61885 + 0 = -2.61885$。\n\n5.  **传播 $\\bar{f}_L$ 和 $\\bar{f}_R$**：\n    对 $\\bar{u}_L$ 的贡献：$\\bar{f}_L \\cdot u_L = 1.5405 \\cdot 1.7 = 2.61885$。\n    $\\bar{u}_L \\mathrel{+}= 2.61885 \\implies \\bar{u}_L = 6.62415 + 2.61885 = 9.243$。\n    对 $\\bar{u}_R$ 的贡献：$\\bar{f}_R \\cdot u_R = 1.5405 \\cdot (-0.9) = -1.38645$。\n    $\\bar{u}_R \\mathrel{+}= -1.38645 \\implies \\bar{u}_R = -2.61885 - 1.38645 = -4.0053$。\n\n梯度分量的最终值为：\n$$ \\frac{\\partial J}{\\partial u_L} = 9.243 $$\n$$ \\frac{\\partial J}{\\partial u_R} = -4.0053 $$\n将每个分量四舍五入到六位有效数字，得到 $9.24300$ 和 $-4.00530$。\n\n梯度是 $\\nabla J = \\begin{pmatrix} 9.24300  -4.00530 \\end{pmatrix}$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n9.24300  -4.00530\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在掌握了基本机理之后，下一步是将离散伴随方法应用于一个完整（尽管简单）的物理系统。本练习要求您为一个一维对流扩散问题推导并实现伴随求解器。更关键的是，您需要将计算出的梯度与有限差分近似值进行比较并验证其正确性——这是任何实际优化任务中都必不可少的健全性检查步骤。",
            "id": "3950976",
            "problem": "考虑一个一维、稳态、无量纲的对流扩散模型，该模型常用于计算流体动力学（CFD），源于一个输运标量的守恒。在具有 $N$ 个点的均匀网格的域 $x \\in [0,1]$ 上，Dirichlet 边界条件为 $U(0)=0$ 和 $U(1)=0$，内部节点索引为 $i=1,\\dots,N-2$，设每个内部节点的离散残差为\n$$\nR_i(U,p) = \\Gamma \\frac{U_{i-1} - 2 U_i + U_{i+1}}{\\Delta x^2} - a \\frac{U_i - U_{i-1}}{\\Delta x} - s_i(p),\n$$\n其中 $U_i$ 表示节点 $i$ 处的离散状态，$\\Delta x = \\frac{1}{N-1}$，$a \\ge 0$ 是一个无量纲的对流强度，$\\Gamma > 0$ 是一个无量纲的扩散系数，$s_i(p)$ 是一个取决于标量设计参数 $p$ 的无量纲源项。假设 $s_i(p) = p f_i$，其中 $f_i = \\sin(\\pi x_i)$ 且 $x_i = i \\Delta x$。离散状态 $U$ 由稳态残差方程 $R(U,p)=0$ 隐式定义，对于此线性模型，该方程可以写成 $A(p) U = s(p)$，其中三对角矩阵 $A(p)$ 与 $p$ 无关，由下式给出\n$$\nA_{i,i} = -\\frac{2\\Gamma}{\\Delta x^2} - \\frac{a}{\\Delta x}, \\quad A_{i,i-1} = \\frac{\\Gamma}{\\Delta x^2} + \\frac{a}{\\Delta x}, \\quad A_{i,i+1} = \\frac{\\Gamma}{\\Delta x^2},\n$$\n适用于所有有效索引，其中边界值为零，因此不产生额外的源项。考虑代价泛函\n$$\nJ(U,p) = \\frac{1}{2}\\,\\Delta x \\sum_{i=1}^{N-2} \\left(U_i - U_i^\\star\\right)^2 + \\beta\\, p,\n$$\n其中 $U_i^\\star = \\sin(2\\pi x_i)$ 是一个给定的无量纲目标场，$\\beta$ 是一个无量纲的标量权重。所有三角函数中的角度均以弧度为单位。\n\n任务：从离散残差的定义和应用于隐式状态 $U(p)$ 的链式法则出发，推导离散伴随方程和梯度公式\n$$\n\\frac{dJ}{dp} = J_p^T - \\lambda^T R_p,\n$$\n其中 $\\lambda$ 是伴随变量，由一个您必须得到的线性系统定义，$J_p$ 是在 $U$ 固定时 $J$ 对 $p$ 的偏导数，$R_p$ 是在 $U$ 固定时 $R$ 对 $p$ 的偏导数。然后实现一个程序，该程序：\n- 构建矩阵 $A$，通过 $A U = s(p)$ 求解状态 $U$，从适当的线性系统中计算伴随变量 $\\lambda$，并评估离散伴随梯度 $\\frac{dJ}{dp}$。\n- 使用对称差分和小步长 $h$ 计算 $\\frac{dJ}{dp}$ 的有限差分估计，\n$$\n\\left.\\frac{dJ}{dp}\\right|_{\\text{FD}} \\approx \\frac{J(U(p+h),p+h) - J(U(p-h),p-h)}{2h}.\n$$\n- 对于每个测试用例，返回离散伴随梯度和有限差分梯度之间的绝对差值，结果为浮点数。\n\n所有量均为无量纲。您必须在所有三角函数求值中使用弧度。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，$[r_1,r_2,\\dots]$）。\n\n使用以下带有参数元组 $(N,a,\\Gamma,p,\\beta)$ 的测试套件：\n- 案例 1：$(N,a,\\Gamma,p,\\beta) = (50, 1.0, 0.1, 0.5, 0.3)$。\n- 案例 2：$(N,a,\\Gamma,p,\\beta) = (20, 0.0, 0.5, 1.0, 0.0)$。\n- 案例 3：$(N,a,\\Gamma,p,\\beta) = (200, 5.0, 10^{-3}, 0.1, 1.0)$。\n- 案例 4：$(N,a,\\Gamma,p,\\beta) = (5, 0.2, 0.05, 0.8, 0.2)$。\n\n您的输出必须是一个列表 $[d_1,d_2,d_3,d_4]$，其中 $d_k$ 是案例 $k$ 的离散伴随梯度和有限差分梯度之间的绝对差值，表示为浮点数。",
            "solution": "该问题是有效的，因为它具有科学依据、良态且客观。它提出了一个使用离散伴随方法进行基于 CFD 优化的标准问题。所有必要的数据和定义都已提供。\n\n### 离散伴随梯度的推导\n\n目标是计算代价泛函 $J(U,p)$ 关于设计参数 $p$ 的全导数。状态向量 $U$ 是 $p$ 的隐式函数，由稳态残差方程 $R(U(p), p) = 0$ 定义。\n\n代价泛函由下式给出：\n$$\nJ(U,p) = \\frac{1}{2}\\,\\Delta x \\sum_{i=1}^{N-2} \\left(U_i - U_i^\\star\\right)^2 + \\beta\\, p\n$$\n每个内部节点 $i \\in \\{1, \\dots, N-2\\}$ 的离散残差方程为：\n$$\nR_i(U,p) = \\left( \\frac{\\Gamma}{\\Delta x^2} + \\frac{a}{\\Delta x} \\right) U_{i-1} + \\left( -\\frac{2\\Gamma}{\\Delta x^2} - \\frac{a}{\\Delta x} \\right) U_i + \\left( \\frac{\\Gamma}{\\Delta x^2} \\right) U_{i+1} - p f_i = 0\n$$\n其中 $f_i = \\sin(\\pi x_i)$。这可以写成矩阵形式 $R(U, p) = A U - s(p) = 0$，其中 $A$ 是系统矩阵，$s(p)$ 是源向量，其分量为 $s_i(p) = p f_i$。\n\n**1. 使用链式法则求全导数**\n\n对 $J(U(p), p)$ 应用链式法则，我们得到关于 $p$ 的全导数：\n$$\n\\frac{dJ}{dp} = \\frac{\\partial J}{\\partial p} + \\left(\\nabla_U J\\right)^T \\frac{dU}{dp}\n$$\n此处，$\\frac{\\partial J}{\\partial p}$ 是在保持 $U$ 不变的情况下 $J$ 对 $p$ 的偏导数，$\\nabla_U J$ 是 $J$ 关于状态向量 $U$ 的梯度（一个由偏导数 $\\frac{\\partial J}{\\partial U_i}$ 组成的列向量），$\\frac{dU}{dp}$ 是状态灵敏度向量，其分量为 $\\frac{dU_i}{dp}$。\n\n**2. 状态灵敏度推导**\n\n状态灵敏度向量 $\\frac{dU}{dp}$ 通过对状态方程 $R(U(p), p) = 0$ 关于 $p$ 求导得到：\n$$\n\\frac{dR}{dp} = \\frac{\\partial R}{\\partial U} \\frac{dU}{dp} + \\frac{\\partial R}{\\partial p} = 0\n$$\n其中 $\\frac{\\partial R}{\\partial U}$ 是残差向量 $R$ 关于状态向量 $U$ 的雅可比矩阵，$\\frac{\\partial R}{\\partial p}$ 是 $R$ 关于 $p$ 的偏导数。\n重新整理得到状态灵敏度：\n$$\n\\frac{dU}{dp} = - \\left( \\frac{\\partial R}{\\partial U} \\right)^{-1} \\frac{\\partial R}{\\partial p}\n$$\n直接计算 $\\frac{dU}{dp}$ 需要为灵敏度向量的每个分量求解一个线性系统，这在计算上是昂贵的。伴随方法可以避免这个问题。\n\n**3. 伴随方法**\n\n将灵敏度的表达式代入 $J$ 的全导数中：\n$$\n\\frac{dJ}{dp} = \\frac{\\partial J}{\\partial p} - \\left(\\nabla_U J\\right)^T \\left( \\frac{\\partial R}{\\partial U} \\right)^{-1} \\frac{\\partial R}{\\partial p}\n$$\n为避免矩阵求逆，我们通过组合乘以 $\\frac{\\partial R}{\\partial p}$ 的项来定义离散伴随向量 $\\lambda$（一个列向量）：\n$$\n\\lambda^T = \\left(\\nabla_U J\\right)^T \\left( \\frac{\\partial R}{\\partial U} \\right)^{-1}\n$$\n为了在不计算逆矩阵的情况下求解 $\\lambda$，我们右乘 $\\frac{\\partial R}{\\partial U}$ 并取转置：\n$$\n\\left( \\frac{\\partial R}{\\partial U} \\right)^T \\lambda = \\nabla_U J\n$$\n这就是 **离散伴随方程**，它是一个关于伴随向量 $\\lambda$ 的单一线性系统。\n\n如此定义 $\\lambda$ 后，代价泛函的全导数简化为：\n$$\n\\frac{dJ}{dp} = \\frac{\\partial J}{\\partial p} - \\lambda^T \\frac{\\partial R}{\\partial p}\n$$\n这就是所求的梯度公式。使用符号 $J_p = \\frac{\\partial J}{\\partial p}$ 和 $R_p = \\frac{\\partial R}{\\partial p}$，公式为 $\\frac{dJ}{dp} = J_p - \\lambda^T R_p$。由于 $p$ 是标量，$J_p$ 也是标量，因此 $J_p^T=J_p$。\n\n**4. 对特定问题的应用**\n\n我们现在计算给定问题所需的偏导数。\n-   **残差雅可比矩阵：** 从 $R(U, p) = A U - s(p)$，关于 $U$ 的偏导数就是矩阵 $A$。\n    $$\n    \\frac{\\partial R}{\\partial U} = A\n    $$\n-   **关于参数的残差导数：** 残差向量为 $R(U,p) = AU - p f$。其关于 $p$ 的偏导数为：\n    $$\n    \\frac{\\partial R}{\\partial p} = -f\n    $$\n    其中 $f$ 是分量为 $f_i = \\sin(\\pi x_i)$ 的向量。\n-   **关于状态的泛函梯度：** 泛函为 $J = \\frac{1}{2}\\,\\Delta x \\sum_{k=1}^{N-2} \\left(U_k - U_k^\\star\\right)^2 + \\beta\\, p$。其关于 $U_i$ 的偏导数为：\n    $$\n    (\\nabla_U J)_i = \\frac{\\partial J}{\\partial U_i} = \\Delta x \\left(U_i - U_i^\\star\\right)\n    $$\n-   **关于参数的泛函导数：** $J$ 关于 $p$ 的偏导数为：\n    $$\n    \\frac{\\partial J}{\\partial p} = \\beta\n    $$\n\n**5. 最终伴随系统和梯度**\n\n将这些特定项代入通用伴随框架中，得到：\n-   **原始（状态）方程：** $A U = s(p)$，其中 $s_i(p) = p f_i$。\n-   **伴随方程：**\n    $$\n    A^T \\lambda = \\nabla_U J, \\quad \\text{其中 } (\\nabla_U J)_i = \\Delta x (U_i - U_i^\\star)\n    $$\n-   **梯度公式：**\n    $$\n    \\frac{dJ}{dp} = \\beta - \\lambda^T (-f) = \\beta + \\lambda^T f = \\beta + \\sum_{i=1}^{N-2} \\lambda_i f_i\n    $$\n\n**6. 数值步骤**\n\n计算离散伴随梯度的算法如下：\n1.  对于给定的参数 $(N, a, \\Gamma, p, \\beta)$，构建 $(N-2) \\times (N-2)$ 矩阵 $A$ 和源向量 $s(p)$。\n2.  求解原始线性系统 $A U = s(p)$ 以获得状态向量 $U$。\n3.  使用计算出的状态 $U$ 构建伴随系统的右侧项 $\\nabla_U J$。\n4.  求解伴随线性系统 $A^T \\lambda = \\nabla_U J$ 以获得伴随向量 $\\lambda$。\n5.  使用公式 $\\frac{dJ}{dp} = \\beta + \\lambda^T f$ 计算梯度。\n\n然后将此梯度与有限差分近似进行比较以进行验证：\n$$\n\\left.\\frac{dJ}{dp}\\right|_{\\text{FD}} \\approx \\frac{J(U(p+h),p+h) - J(U(p-h),p-h)}{2h}\n$$\n其中 $h$ 是一个小扰动。这需要两次额外的原始求解来找到 $U(p+h)$ 和 $U(p-h)$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries are permitted\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print results.\n    \"\"\"\n    test_cases = [\n        (50, 1.0, 0.1, 0.5, 0.3),   # Case 1\n        (20, 0.0, 0.5, 1.0, 0.0),   # Case 2\n        (200, 5.0, 1e-3, 0.1, 1.0), # Case 3\n        (5, 0.2, 0.05, 0.8, 0.2),   # Case 4\n    ]\n\n    results = []\n    for case in test_cases:\n        N, a, Gamma, p, beta = case\n        diff = compute_gradient_difference(N, a, Gamma, p, beta)\n        results.append(diff)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_gradient_difference(N, a, Gamma, p, beta, h=1e-7):\n    \"\"\"\n    Computes the absolute difference between the discrete-adjoint gradient and\n    a finite-difference approximation.\n\n    Args:\n        N (int): Number of mesh points.\n        a (float): Dimensionless convection strength.\n        Gamma (float): Dimensionless diffusion coefficient.\n        p (float): Scalar design parameter.\n        beta (float): Scalar weight in the cost functional.\n        h (float): Step size for finite difference.\n\n    Returns:\n        float: The absolute difference between the two gradient calculations.\n    \"\"\"\n    # Grid and problem setup\n    num_interior = N - 2\n    if num_interior = 0:\n        return 0.0\n    \n    dx = 1.0 / (N - 1)\n    x_interior = np.linspace(0, 1, N)[1:-1]\n\n    # Target field and source term structure\n    U_star = np.sin(2 * np.pi * x_interior)\n    f_vec = np.sin(np.pi * x_interior)\n\n    # --- Construct the primal system matrix A ---\n    A = np.zeros((num_interior, num_interior))\n    \n    # Coefficients from discretization\n    c_diff = Gamma / dx**2\n    c_conv = a / dx\n    \n    diag_val = -2.0 * c_diff - c_conv\n    sub_diag_val = c_diff + c_conv\n    sup_diag_val = c_diff\n    \n    np.fill_diagonal(A, diag_val)\n    if num_interior > 1:\n        np.fill_diagonal(A[1:, :], sub_diag_val)\n        np.fill_diagonal(A[:, 1:], sup_diag_val)\n\n    # --- Discrete-Adjoint Gradient Calculation ---\n    \n    # 1. Solve primal system for state U: A U = s(p)\n    s_p = p * f_vec\n    U = np.linalg.solve(A, s_p)\n\n    # 2. Assemble and solve adjoint system for lambda: A^T lambda = dJ/dU\n    grad_J_U = dx * (U - U_star)\n    A_T = A.T\n    lambda_vec = np.linalg.solve(A_T, grad_J_U)\n\n    # 3. Compute adjoint gradient: dJ/dp = beta + lambda^T f\n    grad_adjoint = beta + np.dot(lambda_vec, f_vec)\n    \n    # --- Finite-Difference Gradient Calculation ---\n\n    def compute_J(param_p):\n        \"\"\"Helper to compute cost functional J for a given parameter p.\"\"\"\n        s_vec = param_p * f_vec\n        U_sol = np.linalg.solve(A, s_vec)\n        cost = 0.5 * dx * np.sum((U_sol - U_star)**2) + beta * param_p\n        return cost\n\n    J_plus_h = compute_J(p + h)\n    J_minus_h = compute_J(p - h)\n    \n    grad_fd = (J_plus_h - J_minus_h) / (2.0 * h)\n\n    # Return the absolute difference\n    return abs(grad_adjoint - grad_fd)\n\nsolve()\n```"
        },
        {
            "introduction": "真实的CFD代码中经常包含不可微的组件，例如通量限制器，这使得伴随计算变得复杂。本练习将直面这一挑战，要求您为带有minmod限制器的MUSCL格式推导离散伴随。这个过程将迫使您处理函数中的“扭结”点，并接触到次梯度的概念，从而更好地理解如何在实际工程问题中处理非光滑性。",
            "id": "3950940",
            "problem": "考虑一维定常线性平流方程，其速度为常数 $a>0$，标量状态为 $u(x)$，并通过均匀的有限体积网格进行离散。在单元交界面 $i+\\tfrac{1}{2}$ 处，使用守恒律单调上游中心格式 (MUSCL) 重构和 minmod 通量限制器来定义左偏状态 $u_{L,i+\\frac{1}{2}}$，具体如下：\n- 定义前向差分 $\\Delta^{+} u_{i} \\equiv u_{i+1}-u_{i}$ 和后向差分 $\\Delta^{-} u_{i} \\equiv u_{i}-u_{i-1}$，以及比率 $r_{i} \\equiv \\dfrac{\\Delta^{-} u_{i}}{\\Delta^{+} u_{i}}$（假设 $\\Delta^{+} u_{i} \\neq 0$）。\n- 令 minmod 限制器为 $\\phi_{\\mathrm{mm}}(r) \\equiv \\max\\!\\big(0,\\min(1,r)\\big)$。\n- MUSCL 左状态为 $u_{L,i+\\frac{1}{2}} \\equiv u_{i} + \\tfrac{1}{2}\\,\\phi_{\\mathrm{mm}}(r_{i})\\,\\Delta^{+} u_{i}$。\n- 交界面处的上游数值通量为 $F_{i+\\frac{1}{2}} \\equiv a\\,u_{L,i+\\frac{1}{2}}$。\n\n设目标函数为该交界面通量的线性泛函，$J \\equiv \\alpha\\,F_{i+\\frac{1}{2}}$，其中 $\\alpha$ 是给定的标量权重。在离散伴随意义下，该交界面对局部伴随方程右端项的贡献由梯度 $\\nabla_{\\mathbf{u}} J$ 决定，该梯度是相对于参与重构模板的守恒单元值三元组 $\\mathbf{u} \\equiv (u_{i-1},u_{i},u_{i+1})$ 计算的。\n\n任务：\n1) 从上述定义和链式法则出发，并假设 $0  r_i  1$ 从而 $\\phi_{\\mathrm{mm}}(r_{i})=r_{i}$，推导伴随贡献 $\\nabla_{\\mathbf{u}} J = \\left(\\dfrac{\\partial J}{\\partial u_{i-1}},\\dfrac{\\partial J}{\\partial u_{i}},\\dfrac{\\partial J}{\\partial u_{i+1}}\\right)$ 的表达式。您的最终表达式应仅依赖于常数 $a$ 和 $\\alpha$。\n2) 使用您的表达式，计算当 $a=2$、$\\alpha=1$ 且局部状态为 $(u_{i-1},u_{i},u_{i+1})=(1,2,5)$ 时的数值贡献。将结果表示为行矩阵。\n3) 简要讨论 minmod 限制器函数在 $r_{i}=0$ 和 $r_{i}=1$ 处非光滑“拐点”对离散伴随（即梯度 $\\nabla_{\\mathbf{u}} J$）存在性的影响。",
            "solution": "该问题要求推导和评估在有限体积格式中，与一个MUSCL重构通量相关的特定目标函数的离散伴随贡献。它还要求讨论不可微限制器函数的影响。\n\n首先，必须对问题进行验证。\n\n### 步骤1：提取已知条件\n- 方程：具有恒定速度 $a>0$ 的一维定常线性平流方程。\n- 离散化：均匀的有限体积网格。\n- 状态变量：单元平均值 $u_{i-1}$、$u_{i}$、$u_{i+1}$。\n- 定义：\n  - 前向差分：$\\Delta^{+} u_{i} \\equiv u_{i+1}-u_{i}$\n  - 后向差分：$\\Delta^{-} u_{i} \\equiv u_{i}-u_{i-1}$\n  - 梯度比：$r_{i} \\equiv \\dfrac{\\Delta^{-} u_{i}}{\\Delta^{+} u_{i}}$，假设 $\\Delta^{+} u_{i} \\neq 0$。\n  - Minmod通量限制器函数：$\\phi_{\\mathrm{mm}}(r) \\equiv \\max\\!\\big(0,\\min(1,r)\\big)$。\n  - 重构的左状态：$u_{L,i+\\frac{1}{2}} \\equiv u_{i} + \\tfrac{1}{2}\\,\\phi_{\\mathrm{mm}}(r_{i})\\,\\Delta^{+} u_{i}$。\n  - 上游数值通量：$F_{i+\\frac{1}{2}} \\equiv a\\,u_{L,i+\\frac{1}{2}}$。\n- 目标泛函：$J \\equiv \\alpha\\,F_{i+\\frac{1}{2}}$，其中 $\\alpha$ 是一个标量权重。\n- 目标梯度：$\\nabla_{\\mathbf{u}} J = \\left(\\dfrac{\\partial J}{\\partial u_{i-1}},\\dfrac{\\partial J}{\\partial u_{i}},\\dfrac{\\partial J}{\\partial u_{i+1}}\\right)$，其中 $\\mathbf{u} \\equiv (u_{i-1},u_{i},u_{i+1})$。\n- 任务1的条件：假设 $0  r_{i}  1$，这意味着 $\\phi_{\\mathrm{mm}}(r_{i}) = r_{i}$。\n- 任务2的数据：$a=2$，$\\alpha=1$，以及局部状态 $(u_{i-1},u_{i},u_{i+1})=(1,2,5)$。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，描述了标准的MUSCL格式及相关的离散伴随计算，这些都是高等计算流体动力学（CFD）和数值优化的核心课题。问题是适定的，提供了所有必要的定义。为任务2提供的数据与任务1的假设是一致的：\n给定 $(u_{i-1},u_{i},u_{i+1})=(1,2,5)$:\n$\\Delta^{+} u_{i} = u_{i+1} - u_{i} = 5 - 2 = 3$。\n$\\Delta^{-} u_{i} = u_{i} - u_{i-1} = 2 - 1 = 1$。\n比率为 $r_{i} = \\dfrac{\\Delta^{-} u_{i}}{\\Delta^{+} u_{i}} = \\dfrac{1}{3}$。\n由于 $0  \\frac{1}{3}  1$，所提供的状态正确地落在指定的minmod限制器激活分支内。该问题是客观、完整且数学上可验证的。\n\n### 步骤3：结论与行动\n问题有效。将提供解答。\n\n---\n\n### 任务1：伴随贡献的推导\n\n目标函数 $J$ 被定义为状态变量 $\\mathbf{u} = (u_{i-1}, u_{i}, u_{i+1})$ 的一系列嵌套函数。\n$$J = \\alpha F_{i+\\frac{1}{2}} = \\alpha \\left( a u_{L,i+\\frac{1}{2}} \\right)$$\n代入重构状态 $u_{L,i+\\frac{1}{2}}$ 的定义：\n$$J = \\alpha a \\left( u_{i} + \\frac{1}{2} \\phi_{\\mathrm{mm}}(r_i) \\Delta^{+} u_i \\right)$$\n问题指明我们处于 $0  r_i  1$ 的分支。在此范围内，minmod 函数简化为 $\\phi_{\\mathrm{mm}}(r_i) = r_i$。$J$ 的表达式变为：\n$$J = \\alpha a \\left( u_{i} + \\frac{1}{2} r_i \\Delta^{+} u_i \\right)$$\n现在，我们代入 $r_i$ 和 $\\Delta^{+} u_i$ 的定义：\n$$r_i = \\frac{\\Delta^{-} u_i}{\\Delta^{+} u_i} = \\frac{u_i - u_{i-1}}{u_{i+1} - u_i}$$\n$$\\Delta^{+} u_i = u_{i+1} - u_i$$\n项 $\\frac{1}{2} r_i \\Delta^{+} u_i$ 可以被极大简化：\n$$\\frac{1}{2} r_i \\Delta^{+} u_i = \\frac{1}{2} \\left( \\frac{u_i - u_{i-1}}{u_{i+1} - u_i} \\right) (u_{i+1} - u_i) = \\frac{1}{2} (u_i - u_{i-1})$$\n需要注意的是，这个简化之所以成立，是因为题目说明了 $\\Delta^{+} u_i \\neq 0$。\n将这个简化后的项代回 $J$ 的表达式中：\n$$J = \\alpha a \\left( u_i + \\frac{1}{2} (u_i - u_{i-1}) \\right)$$\n合并包含 $u_i$ 的项：\n$$J = \\alpha a \\left( \\frac{3}{2} u_i - \\frac{1}{2} u_{i-1} \\right)$$\n这是目标函数 $J$ 在指定分支下的闭式表达式。正如所料，它仅依赖于 $u_{i-1}$ 和 $u_i$。现在我们计算关于 $\\mathbf{u}$ 各分量的偏导数：\n\n1.  关于 $u_{i-1}$ 的导数：\n    $$\\frac{\\partial J}{\\partial u_{i-1}} = \\frac{\\partial}{\\partial u_{i-1}} \\left[ \\alpha a \\left( \\frac{3}{2} u_i - \\frac{1}{2} u_{i-1} \\right) \\right] = -\\frac{1}{2} \\alpha a$$\n\n2.  关于 $u_{i}$ 的导数：\n    $$\\frac{\\partial J}{\\partial u_{i}} = \\frac{\\partial}{\\partial u_{i}} \\left[ \\alpha a \\left( \\frac{3}{2} u_i - \\frac{1}{2} u_{i-1} \\right) \\right] = \\frac{3}{2} \\alpha a$$\n\n3.  关于 $u_{i+1}$ 的导数：\n    $$\\frac{\\partial J}{\\partial u_{i+1}} = \\frac{\\partial}{\\partial u_{i+1}} \\left[ \\alpha a \\left( \\frac{3}{2} u_i - \\frac{1}{2} u_{i-1} \\right) \\right] = 0$$\n\n得到的伴随贡献向量为 $\\left(-\\frac{1}{2} \\alpha a, \\frac{3}{2} \\alpha a, 0\\right)$。根据要求，这些表达式仅依赖于常数 $a$ 和 $\\alpha$。\n\n### 任务2：数值计算\n\n我们使用给定的数值 $a=2$ 和 $\\alpha=1$ 来计算任务1中推导出的表达式。状态值 $(u_{i-1},u_{i},u_{i+1})=(1,2,5)$ 用于确认我们处于限制器的正确分支，但在该特定分支的导数最终表达式中并未出现。\n\n- $\\dfrac{\\partial J}{\\partial u_{i-1}} = -\\dfrac{1}{2} \\alpha a = -\\dfrac{1}{2} (1)(2) = -1$\n- $\\dfrac{\\partial J}{\\partial u_{i}} = \\dfrac{3}{2} \\alpha a = \\dfrac{3}{2} (1)(2) = 3$\n- $\\dfrac{\\partial J}{\\partial u_{i+1}} = 0$\n\n因此，数值贡献为 $(-1, 3, 0)$。\n\n### 任务3：关于非光滑拐点的讨论\n\nminmod 限制器函数 $\\phi_{\\mathrm{mm}}(r) = \\max(0, \\min(1, r))$ 是连续的，但不是连续可微的。它在 $r=0$ 和 $r=1$ 处有不可微点，即“拐点”(kinks)。其导数 $\\phi'_{\\mathrm{mm}}(r)$ 是分段常数：\n$$ \\phi'_{\\mathrm{mm}}(r) = \\begin{cases} 0  \\text{若 } r  0 \\\\ 1  \\text{若 } 0  r  1 \\\\ 0  \\text{若 } r > 1 \\end{cases} $$\n在 $r=0$ 和 $r=1$ 处，导数在形式上是未定义的。\n\n目标函数 $J$ 通过 $\\phi_{\\mathrm{mm}}(r_i(\\mathbf{u}))$ 依赖于状态变量 $\\mathbf{u}$。根据链式法则，$\\phi_{\\mathrm{mm}}$ 在特定 $r$ 值处的不可微性会转化为 $J$ 相对于任何产生该 $r_i$ 值的状态 $\\mathbf{u}$ 的不可微性。离散伴随是梯度 $\\nabla_{\\mathbf{u}} J$。如果这个梯度未定义，那么离散伴随在经典意义上不存在，或者至少不唯一。\n\n这种不唯一性为基于梯度的算法带来了问题，因为这类算法要求在每个点上都有一个唯一定义的梯度向量。为了解决这个问题，可以借助凸分析中的次梯度概念。在不可微点，次梯度是表征函数局部行为的一个值的集合。对于 $\\phi_{\\mathrm{mm}}$，在 $r=0$ 处的次梯度是区间 $[0,1]$，在 $r=1$ 处也是区间 $[0,1]$（因为它是左导数和右导数的凸包）。\n\n对于一个实用的、可实现的离散伴随方法，必须在每个拐点从次梯度集合中选择一个单一的值。这个选择虽然是任意的，但必须保持一致。常见的选择包括：\n1.  使用单侧导数之一（例如，从左侧设置 $\\phi'_{\\mathrm{mm}}(0)=0$，或从右侧设置 $\\phi'_{\\mathrm{mm}}(0)=1$）。\n2.  使用单侧导数的平均值（例如，$\\phi'_{\\mathrm{mm}}(0) = \\frac{0+1}{2} = \\frac{1}{2}$）。\n\n一个典型且易于实现的选择是，将导数定义为其单侧极限之一，例如定义当 $r \\in [0, 1)$ 时 $\\phi'_{\\mathrm{mm}}(r) = 1$，否则 $\\phi'_{\\mathrm{mm}}(r) = 0$。这确保了广义导数总有一个唯一的值可用，从而允许链式法则在任何地方应用，并在整个状态空间上产生一个唯一定义的（尽管技术上是基于次梯度的）伴随向量。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-1  3  0\n\\end{pmatrix}\n}\n$$"
        }
    ]
}