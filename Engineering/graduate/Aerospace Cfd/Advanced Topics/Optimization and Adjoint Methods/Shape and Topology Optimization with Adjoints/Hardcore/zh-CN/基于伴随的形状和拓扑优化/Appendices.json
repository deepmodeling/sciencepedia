{
    "hands_on_practices": [
        {
            "introduction": "本练习为整个离散伴随方法奠定了数学基础。通过从第一性原理推导伴随方程和相应的梯度表达式，您将深入理解我们如何以与设计参数数量无关的成本计算目标函数的灵敏度。掌握这一推导是理解和应用大规模系统中梯度计算效率的关键 。",
            "id": "3993444",
            "problem": "对围绕一个翼型的粘性、可压缩流进行的稳态计算流体力学(CFD)仿真进行离散化，以生成一个代数方程组，该方程组在每个控制体上强制执行质量、动量和能量守恒。令 $U \\in \\mathbb{R}^{n}$ 表示离散流动未知量（包括任何湍流模型变量）的向量，令 $\\alpha \\in \\mathbb{R}^{p}$ 表示一组设计参数，这些参数通过（例如）Brinkman罚函数方法中的孔隙率分布来控制翼型形状或拓扑场。离散残差为 $R(U,\\alpha) \\in \\mathbb{R}^{n}$，稳态CFD解满足 $R(U,\\alpha)=0$。气动目标是一个可微泛函 $J(U,\\alpha) \\in \\mathbb{R}$（例如，由表面应力计算出的阻力泛函或体积功率耗散）。\n\n假设 $R$ 和 $J$ 对其自变量是二阶连续可微的，并且雅可比矩阵 $R_{U} := \\partial R/\\partial U \\in \\mathbb{R}^{n \\times n}$ 在解处是非奇异的，因此 $U(\\alpha)$ 是 $\\alpha$ 的一个局部可微函数。考虑降阶目标函数 $\\widehat{J}(\\alpha) := J(U(\\alpha),\\alpha)$。\n\n任务：\n1) 从链式法则和约束 $R(U(\\alpha),\\alpha)=0$ 出发，推导全导数 $dJ/d\\alpha$ 的表达式，用 $J_{U}$、$J_{\\alpha}$、$R_{U}$、$R_{\\alpha}$ 和 $dU/d\\alpha$ 来表示。\n2) 引入一个拉格朗日乘子（伴随）向量 $\\lambda \\in \\mathbb{R}^{n}$，并构造一个拉格朗日函数 $\\mathcal{L}(U,\\alpha,\\lambda)$ 来强制执行残差约束。通过对 $\\mathcal{L}$ 关于 $U$ 施加驻定性条件，推导出 $\\lambda$ 必须满足的线性系统。不要假设 $R_{U}$ 具有任何对称性。\n3) 使用第2部分的结果，从全导数中消去 $dU/d\\alpha$，并将降阶梯度 $dJ/d\\alpha$ 仅用偏导数和伴随向量来表示。\n4) 最后，消去伴随向量，以获得一个仅依赖于 $J_{U}$、$J_{\\alpha}$、$R_{U}$ 和 $R_{\\alpha}$ 的单一显式降阶梯度表达式，其中不出现 $U(\\alpha)$、$dU/d\\alpha$ 或 $\\lambda$。\n\n将你的最终答案以第4部分要求的显式符号表达式的形式给出。不需要进行数值计算。你的最终答案必须是一个单一的闭式解析表达式，并且不包含任何单位。",
            "solution": "该问题被验证为具有科学依据、适定且客观。它代表了在连续优化背景下，用于灵敏度分析的伴随方法的标准推导，这是现代计算工程的基石。\n\n解答是通过遵循四个指定的任务推导出来的。给定状态方程 $R(U,\\alpha)=0$，其中 $U \\in \\mathbb{R}^{n}$ 是状态向量，$\\alpha \\in \\mathbb{R}^{p}$ 是设计向量。目标函数是 $J(U,\\alpha) \\in \\mathbb{R}$。相应的降阶目标函数是 $\\widehat{J}(\\alpha) = J(U(\\alpha),\\alpha)$。我们采用这样的记法：标量函数关于向量的梯度是一个行向量。例如，$J_{U} = \\frac{\\partial J}{\\partial U} \\in \\mathbb{R}^{1 \\times n}$ 和 $\\frac{dJ}{d\\alpha} \\in \\mathbb{R}^{1 \\times p}$。\n\n**1) 全导数的推导**\n\n降阶目标函数 $\\widehat{J}(\\alpha)$ 关于设计向量 $\\alpha$ 的全导数可以使用多元链式法则求得：\n$$\n\\frac{d\\widehat{J}}{d\\alpha} = \\frac{\\partial J}{\\partial U} \\frac{dU}{d\\alpha} + \\frac{\\partial J}{\\partial \\alpha}\n$$\n使用指定的记法，这可以写成：\n$$\n\\frac{dJ}{d\\alpha} = J_{U} \\frac{dU}{d\\alpha} + J_{\\alpha}\n$$\n这个表达式给出了全导数，但它依赖于灵敏度矩阵 $\\frac{dU}{d\\alpha} \\in \\mathbb{R}^{n \\times p}$，该矩阵量化了状态向量 $U$ 如何随设计参数 $\\alpha$ 而变化。直接确定这一项的计算成本通常很高。\n\n**2) 拉格朗日函数与伴随方程**\n\n为了推导伴随方法，我们引入一个拉格朗日函数 $\\mathcal{L}$，将状态方程 $R(U,\\alpha)=0$ 作为目标函数 $J(U,\\alpha)$ 的约束。我们引入一个拉格朗日乘子向量 $\\lambda \\in \\mathbb{R}^{n}$，也称为伴随变量。拉格朗日函数定义为：\n$$\n\\mathcal{L}(U,\\alpha,\\lambda) = J(U,\\alpha) + \\lambda^T R(U,\\alpha)\n$$\n伴随方法旨在寻找一个能简化梯度计算的特定 $\\lambda$ 值。我们通过对拉格朗日函数关于状态向量 $U$ 施加驻定性条件（即 $\\frac{\\partial \\mathcal{L}}{\\partial U} = 0$）来找到这个值。\n$\\mathcal{L}$ 关于 $U$ 的偏导数为：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial U} = \\frac{\\partial J}{\\partial U} + \\lambda^T \\frac{\\partial R}{\\partial U} = J_{U} + \\lambda^T R_{U}\n$$\n将此式设为零可得到条件：\n$$\nJ_{U} + \\lambda^T R_{U} = 0\n$$\n由于这是一个关于未知量 $\\lambda$ 的线性系统，通常将其写成 $Ax=b$ 的形式。重新整理该方程得到 $\\lambda^T R_{U} = -J_{U}$。对两边取转置，我们得到 $\\lambda$ 必须满足的线性系统，这被称为离散伴随方程：\n$$\nR_{U}^T \\lambda = -J_{U}^T\n$$\n注意，我们没有假设雅可比矩阵 $R_U$ 的对称性，其转置 $R_U^T$ 自然地出现在伴随方程中。\n\n**3) 消去状态灵敏度项**\n\n我们现在使用伴随方程来重新表述第1部分中全导数的表达式。目标是消去状态灵敏度项 $\\frac{dU}{d\\alpha}$。\n根据第2部分的伴随方程，我们得到 $J_U$ 的一个表达式：\n$$\nJ_U = -\\lambda^T R_U\n$$\n将此式代入第1部分的全导数表达式中：\n$$\n\\frac{dJ}{d\\alpha} = (-\\lambda^T R_{U}) \\frac{dU}{d\\alpha} + J_{\\alpha} = -\\lambda^T \\left( R_{U} \\frac{dU}{d\\alpha} \\right) + J_{\\alpha}\n$$\n为了继续推导，我们需要一个括号内项的表达式。这可以通过对状态方程 $R(U(\\alpha), \\alpha) = 0$ 关于 $\\alpha$ 求导得到：\n$$\n\\frac{d R}{d\\alpha} = \\frac{\\partial R}{\\partial U} \\frac{dU}{d\\alpha} + \\frac{\\partial R}{\\partial \\alpha} = R_{U} \\frac{dU}{d\\alpha} + R_{\\alpha} = 0\n$$\n这就得到了所谓的灵敏度方程：$R_{U} \\frac{dU}{d\\alpha} = -R_{\\alpha}$。\n将此代入我们的全导数表达式中：\n$$\n\\frac{dJ}{d\\alpha} = -\\lambda^T (-R_{\\alpha}) + J_{\\alpha}\n$$\n这可简化为基于伴随方法的降阶梯度表达式：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} + \\lambda^T R_{\\alpha}\n$$\n该表达式提供了目标函数的全导数，而无需计算状态灵敏度矩阵 $\\frac{dU}{d\\alpha}$。取而代之的是，必须求解关于 $\\lambda$ 的单个线性伴随系统。\n\n**4) 最终的显式降阶梯度表达式**\n\n最后一个任务是获得一个不依赖于 $\\lambda$ 或 $\\frac{dU}{d\\alpha}$ 的单一显式降阶梯度表达式。我们可以通过对 $\\lambda$ 进行形式上的求解，然后将其代回第3部分的结果来实现。\n\n从第2部分推导出的伴随方程 $R_{U}^T \\lambda = -J_{U}^T$，我们可以解出 $\\lambda$。因为给定 $R_U$ 是非奇异的，所以其转置 $R_U^T$ 也是非奇异的。因此，我们可以写出：\n$$\n\\lambda = -(R_{U}^T)^{-1} J_{U}^T\n$$\n现在，我们需要 $\\lambda$ 的转置以代入第3部分的表达式：\n$$\n\\lambda^T = \\left( -(R_{U}^T)^{-1} J_{U}^T \\right)^T = -(J_U^T)^T ((R_U^T)^{-1})^T\n$$\n使用恒等式 $(A^{-1})^T = (A^T)^{-1}$，我们有 $((R_{U}^T)^{-1})^T = ((R_{U}^T)^T)^{-1} = (R_{U})^{-1}$。同时，$(J_U^T)^T = J_U$。于是，我们得到：\n$$\n\\lambda^T = -J_{U} R_{U}^{-1}\n$$\n最后，将这个 $\\lambda^T$ 的表达式代入第3部分的梯度公式中：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} + \\lambda^T R_{\\alpha} = J_{\\alpha} + (-J_{U} R_{U}^{-1}) R_{\\alpha}\n$$\n这就得到了最终的显式降阶梯度表达式：\n$$\n\\frac{dJ}{d\\alpha} = J_{\\alpha} - J_{U} R_{U}^{-1} R_{\\alpha}\n$$\n该表达式仅依赖于目标函数（$J_U, J_\\alpha$）和残差（$R_U, R_\\alpha$）的偏导数，以及残差雅可比矩阵 $R_U$ 的逆。这是支撑直接法和伴随法灵敏度分析方法的形式化结果，两者区别在于运算顺序，而这对计算成本具有深远的影响。",
            "answer": "$$\n\\boxed{J_{\\alpha} - J_{U} R_{U}^{-1} R_{\\alpha}}\n$$"
        },
        {
            "introduction": "在计算实践中，验证已实现梯度的正确性是至关重要的一步。本问题介绍了一种强大的验证技术，称为残差恒等式检验 。该技术通过将伴随方法预测的梯度与有限差分结果进行比较，使您能够确认伴随法实现方案的准确性。",
            "id": "3993440",
            "problem": "考虑一个计算流体动力学 (CFD) 中的稳态气动外形与拓扑设计问题，该问题经过离散化后，得到一个有限维状态向量 $u \\in \\mathbb{R}^{m}$ 和一个设计向量 $\\alpha \\in \\mathbb{R}^{n}$。离散控制方程写作残差形式 $R(u,\\alpha)=0$，标量目标函数为 $J(u,\\alpha)$。在当前的设计迭代点，您希望通过执行一个能够消除对状态扰动依赖的残差恒等式检验来验证一个离散伴随实现。\n\n仅从离散残差 $R(u,\\alpha)=0$、目标函数 $J(u,\\alpha)$ 和拉格朗日量 $\\mathcal{L}(u,\\alpha,\\lambda) = J(u,\\alpha) + \\lambda^{T} R(u,\\alpha)$ 的定义出发，完成以下任务：\n\n1) 使用一阶变分和强制拉格朗日量相对于 $u$ 满足定常性的伴随方程，推导由设计扰动 $\\delta \\alpha$ 引起的目标函数一阶变化的表达式，该表达式消除了状态扰动 $\\delta u$。将结果表示为以下形式的内积：\n$$\n\\delta J \\;=\\; s^{T}\\,\\delta \\alpha,\n$$\n并用已知的离散导数和乘子来确定 $s$。\n\n2) 将推导出的恒等式应用于当前设计迭代点的以下离散数据。状态的维度为 $m=2$，设计的维度为 $n=3$。给定：\n- 目标函数关于设计的偏导数，\n$$\nJ_{\\alpha} \\;=\\; \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix}.\n$$\n- 残差关于设计的混合雅可比矩阵（将 $\\delta \\alpha$ 映射到残差扰动），\n$$\nR_{\\alpha} \\;=\\; \\begin{pmatrix}\n1.0  -2.0  0.0 \\\\\n0.5  1.0  -1.5\n\\end{pmatrix}.\n$$\n- 伴随向量，\n$$\n\\lambda \\;=\\; \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix}.\n$$\n\n根据第 (1) 部分的结果构造 $s$，然后，对于以下每个独立的随机设计扰动 $\\delta \\alpha_{k}$，计算伴随预测的一阶变化 $\\delta J_{\\mathrm{adj},k} = s^{T}\\delta \\alpha_{k}$，并与相应的有限差分测量值 $\\delta J_{\\mathrm{fd},k}$ 进行比较：\n- $k=1$: $\\delta \\alpha_{1} = \\begin{pmatrix} 0.02 \\\\ -0.01 \\\\ 0.03 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},1} = 0.073000073$。\n- $k=2$: $\\delta \\alpha_{2} = \\begin{pmatrix} -0.03 \\\\ 0.04 \\\\ -0.02 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},2} = -0.137000137$。\n- $k=3$: $\\delta \\alpha_{3} = \\begin{pmatrix} 0.05 \\\\ 0.01 \\\\ -0.04 \\end{pmatrix}$，其中 $\\delta J_{\\mathrm{fd},3} = -0.020999979$。\n\n将每种情况下的相对不匹配度定义为\n$$\ne_{k} \\;=\\; \\frac{\\left|\\delta J_{\\mathrm{fd},k} - \\delta J_{\\mathrm{adj},k}\\right|}{\\left|\\delta J_{\\mathrm{adj},k}\\right|}.\n$$\n\n计算最大相对不匹配度\n$$\nE_{\\max} \\;=\\; \\max\\{e_{1},\\,e_{2},\\,e_{3}\\},\n$$\n并确定其是否低于验证容差 $\\varepsilon_{\\mathrm{tol}} = 2.0 \\times 10^{-6}$。\n\n仅报告 $E_{\\max}$ 的值作为您的最终答案。将此最大相对不匹配度表示为无量纲十进制数，并将您的答案四舍五入到三位有效数字。",
            "solution": "该问题经验证具有科学依据、良定、客观且完整。它展示了在计算优化背景下，对离散伴随实现进行标准验证的程序。我将继续解答，解答包括两部分：理论推导和数值应用。\n\n第 1 部分：基于伴随的灵敏度推导\n\n给定离散控制方程 $R(u, \\alpha) = 0$ 和一个标量目标函数 $J(u, \\alpha)$，其中 $u \\in \\mathbb{R}^{m}$ 是状态向量，$\\alpha \\in \\mathbb{R}^{n}$ 是设计向量。状态 $u$ 是设计变化 $u = u(\\alpha)$ 的一个隐式函数。\n\n由设计扰动 $\\delta \\alpha$ 引起的目标函数 $J$ 的一阶变分由全导数给出：\n$$\n\\delta J = \\left(\\frac{\\partial J}{\\partial u}\\right)^T \\delta u + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n该表达式依赖于我们希望消除的状态扰动 $\\delta u$。$\\delta u$ 和 $\\delta \\alpha$ 之间的关系可以通过对控制方程 $R(u, \\alpha) = 0$ 进行一阶变分找到：\n$$\n\\delta R = \\frac{\\partial R}{\\partial u} \\delta u + \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha = 0\n$$\n其中 $\\frac{\\partial R}{\\partial u}$ 是 $m \\times m$ 的状态雅可比矩阵，$\\frac{\\partial R}{\\partial \\alpha}$ 是 $m \\times n$ 的设计雅可比矩阵。\n\n问题引入了拉格朗日量 $\\mathcal{L}(u, \\alpha, \\lambda) = J(u, \\alpha) + \\lambda^T R(u, \\alpha)$，其中 $\\lambda \\in \\mathbb{R}^{m}$ 是伴随变量（或拉格朗日乘子）的向量。伴随方程由 $\\mathcal{L}$ 相对于状态 $u$ 的定常性定义：\n$$\n\\left(\\frac{\\partial \\mathcal{L}}{\\partial u}\\right)^T = \\frac{\\partial J}{\\partial u} + \\left(\\frac{\\partial R}{\\partial u}\\right)^T \\lambda = 0\n$$\n注意，我们对梯度使用列向量约定，因此 $\\frac{\\partial J}{\\partial u}$ 是一个 $m \\times 1$ 的列向量，$\\frac{\\partial R}{\\partial u}$ 是一个 $m \\times m$ 的矩阵。这个伴随方程允许我们用伴随向量来表示 $J$ 相对于 $u$ 的灵敏度：\n$$\n\\frac{\\partial J}{\\partial u} = - \\left(\\frac{\\partial R}{\\partial u}\\right)^T \\lambda\n$$\n我们将此代入 $\\delta J$ 的表达式中：\n$$\n\\delta J = \\left(- \\lambda^T \\frac{\\partial R}{\\partial u}\\right) \\delta u + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha = -\\lambda^T \\left(\\frac{\\partial R}{\\partial u} \\delta u\\right) + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n从残差的变分中，我们得到关系式 $\\frac{\\partial R}{\\partial u} \\delta u = - \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha$。将此代入 $\\delta J$ 的方程中，消除了项 $\\frac{\\partial R}{\\partial u} \\delta u$：\n$$\n\\delta J = -\\lambda^T \\left(- \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha\\right) + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n$$\n\\delta J = \\lambda^T \\frac{\\partial R}{\\partial \\alpha} \\delta \\alpha + \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T \\delta \\alpha\n$$\n提取设计扰动 $\\delta \\alpha$：\n$$\n\\delta J = \\left( \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T + \\lambda^T \\frac{\\partial R}{\\partial \\alpha} \\right) \\delta \\alpha\n$$\n这是 $\\delta J = s^T \\delta \\alpha$ 的形式，其中 $s$ 是所求的灵敏度列向量。通过辨识各项，我们找到行向量 $s^T$：\n$$\ns^T = \\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T + \\lambda^T \\frac{\\partial R}{\\partial \\alpha}\n$$\n对该表达式进行转置，得到列向量 $s$：\n$$\ns = \\left(s^T\\right)^T = \\left(\\left(\\frac{\\partial J}{\\partial \\alpha}\\right)^T\\right)^T + \\left(\\lambda^T \\frac{\\partial R}{\\partial \\alpha}\\right)^T = \\frac{\\partial J}{\\partial \\alpha} + \\left(\\frac{\\partial R}{\\partial \\alpha}\\right)^T \\lambda\n$$\n使用问题陈述中的记法，其中 $J_\\alpha$ 是列向量 $\\frac{\\partial J}{\\partial \\alpha}$，$R_\\alpha$ 是矩阵 $\\frac{\\partial R}{\\partial \\alpha}$，灵敏度向量为：\n$$\ns = J_\\alpha + R_\\alpha^T \\lambda\n$$\n该表达式给出了目标函数的一阶变化，而无需计算状态扰动 $\\delta u$。\n\n第 2 部分：数值计算与验证\n\n我们将推导出的恒等式应用于所提供的离散数据。维度为 $m=2$ 和 $n=3$。\n给定的数据是：\n- 目标函数关于设计的偏导数：$J_{\\alpha} = \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix}$\n- 残差关于设计的混合雅可比矩阵：$R_{\\alpha} = \\begin{pmatrix} 1.0  -2.0  0.0 \\\\ 0.5  1.0  -1.5 \\end{pmatrix}$\n- 伴随向量：$\\lambda = \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix}$\n\n首先，我们计算灵敏度向量 $s$。这需要 $R_\\alpha$ 的转置：\n$$\nR_{\\alpha}^T = \\begin{pmatrix} 1.0  0.5 \\\\ -2.0  1.0 \\\\ 0.0  -1.5 \\end{pmatrix}\n$$\n接下来，我们计算乘积 $R_\\alpha^T \\lambda$：\n$$\nR_\\alpha^T \\lambda = \\begin{pmatrix} 1.0  0.5 \\\\ -2.0  1.0 \\\\ 0.0  -1.5 \\end{pmatrix} \\begin{pmatrix} 0.3 \\\\ -0.4 \\end{pmatrix} = \\begin{pmatrix} (1.0)(0.3) + (0.5)(-0.4) \\\\ (-2.0)(0.3) + (1.0)(-0.4) \\\\ (0.0)(0.3) + (-1.5)(-0.4) \\end{pmatrix} = \\begin{pmatrix} 0.3 - 0.2 \\\\ -0.6 - 0.4 \\\\ 0.0 + 0.6 \\end{pmatrix} = \\begin{pmatrix} 0.1 \\\\ -1.0 \\\\ 0.6 \\end{pmatrix}\n$$\n现在，我们计算 $s$：\n$$\ns = J_\\alpha + R_\\alpha^T \\lambda = \\begin{pmatrix} 0.8 \\\\ -1.2 \\\\ 0.5 \\end{pmatrix} + \\begin{pmatrix} 0.1 \\\\ -1.0 \\\\ 0.6 \\end{pmatrix} = \\begin{pmatrix} 0.9 \\\\ -2.2 \\\\ 1.1 \\end{pmatrix}\n$$\n灵敏度行向量为 $s^T = \\begin{pmatrix} 0.9  -2.2  1.1 \\end{pmatrix}$。\n\n现在我们为三种情况中的每一种计算伴随预测的变化 $\\delta J_{\\mathrm{adj},k} = s^T \\delta \\alpha_k$ 和相应的相对不匹配度 $e_k$。\n\n情况 $k=1$：\n$\\delta \\alpha_1 = \\begin{pmatrix} 0.02 \\\\ -0.01 \\\\ 0.03 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},1} = (0.9)(0.02) + (-2.2)(-0.01) + (1.1)(0.03) = 0.018 + 0.022 + 0.033 = 0.073$。\n给定 $\\delta J_{\\mathrm{fd},1} = 0.073000073$。\n相对不匹配度为：\n$$\ne_1 = \\frac{|\\delta J_{\\mathrm{fd},1} - \\delta J_{\\mathrm{adj},1}|}{|\\delta J_{\\mathrm{adj},1}|} = \\frac{|0.073000073 - 0.073|}{|0.073|} = \\frac{0.000000073}{0.073} = 1.0 \\times 10^{-6}\n$$\n\n情况 $k=2$：\n$\\delta \\alpha_2 = \\begin{pmatrix} -0.03 \\\\ 0.04 \\\\ -0.02 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},2} = (0.9)(-0.03) + (-2.2)(0.04) + (1.1)(-0.02) = -0.027 - 0.088 - 0.022 = -0.137$。\n给定 $\\delta J_{\\mathrm{fd},2} = -0.137000137$。\n相对不匹配度为：\n$$\ne_2 = \\frac{|\\delta J_{\\mathrm{fd},2} - \\delta J_{\\mathrm{adj},2}|}{|\\delta J_{\\mathrm{adj},2}|} = \\frac{|-0.137000137 - (-0.137)|}{|-0.137|} = \\frac{|-0.000000137|}{0.137} = 1.0 \\times 10^{-6}\n$$\n\n情况 $k=3$：\n$\\delta \\alpha_3 = \\begin{pmatrix} 0.05 \\\\ 0.01 \\\\ -0.04 \\end{pmatrix}$。\n$\\delta J_{\\mathrm{adj},3} = (0.9)(0.05) + (-2.2)(0.01) + (1.1)(-0.04) = 0.045 - 0.022 - 0.044 = -0.021$。\n给定 $\\delta J_{\\mathrm{fd},3} = -0.020999979$。\n相对不匹配度为：\n$$\ne_3 = \\frac{|\\delta J_{\\mathrm{fd},3} - \\delta J_{\\mathrm{adj},3}|}{|\\delta J_{\\mathrm{adj},3}|} = \\frac{|-0.020999979 - (-0.021)|}{|-0.021|} = \\frac{|0.000000021|}{0.021} = 1.0 \\times 10^{-6}\n$$\n\n最后，我们求出最大相对不匹配度 $E_{\\max}$：\n$$\nE_{\\max} = \\max\\{e_1, e_2, e_3\\} = \\max\\{1.0 \\times 10^{-6}, 1.0 \\times 10^{-6}, 1.0 \\times 10^{-6}\\} = 1.0 \\times 10^{-6}\n$$\n验证容差为 $\\varepsilon_{\\mathrm{tol}} = 2.0 \\times 10^{-6}$。由于 $E_{\\max}  \\varepsilon_{\\mathrm{tol}}$，伴随实现通过了此验证测试。问题要求将 $E_{\\max}$ 的值四舍五入到三位有效数字。\n$$\nE_{\\max} = 1.00 \\times 10^{-6}\n$$",
            "answer": "$$\n\\boxed{1.00 \\times 10^{-6}}\n$$"
        },
        {
            "introduction": "伴随方法可以通过两种截然不同的方式构建：离散方法（先离散后优化）和连续方法（先优化后离散）。本练习通过让您为经典的空气动力学问题实现并比较这两种方法，深入探讨了这一关键区别 。这有助于深入了解它们各自的优缺点和收敛特性。",
            "id": "3993452",
            "problem": "您必须在薄翼型假设下，使用连续和离散伴随公式，对一个美国国家航空咨询委员会（NACA）四位数翼型，实现其升力系数梯度（关于弯度幅值设计变量）的数值比较。控制流体模型为二维、定常、不可压缩、无粘势流，且攻角较小。薄翼型模型在后缘强制施加库塔条件，并沿弦向角变量将边界条件展开为余弦级数。最终程序必须计算连续伴随梯度和离散伴随梯度之间的相对误差，并针对一组测试用例，以单行格式报告这些误差。\n\n基本原理如下：\n- 定常二维、不可压缩、无粘势流遵循速度势的拉普拉斯方程，这意味着除了翼型表面（其中涡片代表环量）外，流动是无旋的。Kutta–Joukowski定理指出，单位翼展的升力取决于环量：$L' = \\rho U_{\\infty} \\Gamma$，在薄翼型理论中，无量纲升力系数为$C_L = 2 \\pi A_0$，其中$A_0$是弯度线边界条件的余弦级数表示中的常数项。\n- 薄翼型边界条件，在翼型弯度线上使用角变量$\\theta \\in (0, \\pi)$表示（通过$x = \\frac{1 - \\cos \\theta}{2}$映射到弦向位置$x$），写作$f(\\theta) = \\alpha - \\frac{dz_c}{dx}\\left(x(\\theta)\\right)$，其中$\\alpha$是攻角（以弧度为单位），$\\frac{dz_c}{dx}$是弯度线相对于$x$的导数。函数$f(\\theta)$展开为余弦级数：\n$$\nf(\\theta) = A_0 + \\sum_{n=1}^{\\infty} A_n \\cos(n \\theta).\n$$\n根据余弦级数的正交性，常数系数为\n$$\nA_0 = \\frac{1}{\\pi} \\int_{0}^{\\pi} f(\\theta)\\, d\\theta,\n$$\n由此得出标准的薄翼型升力系数$C_L = 2 \\pi A_0$。\n\nNACA四位数翼型的弯度线$z_c(x)$由参数$m$（最大弯度与弦长的比值）和$p$（最大弯度位置与弦长的比值）定义。厚度参数不出现在薄翼型无粘升力中，因此在此忽略。弯度线及其斜率的分段定义如下：\n- 对于$0 \\le x \\le p$，\n$$\nz_c(x) = \\frac{m}{p^2} (2 p x - x^2), \\quad \\frac{dz_c}{dx}(x) = \\frac{2 m}{p^2} (p - x).\n$$\n- 对于$p \\le x \\le 1$，\n$$\nz_c(x) = \\frac{m}{(1 - p)^2} \\left( (1 - 2p) + 2 p x - x^2 \\right), \\quad \\frac{dz_c}{dx}(x) = \\frac{2 m}{(1 - p)^2} (p - x).\n$$\n\n将$C_L$相对于弯度幅值$m$的连续伴随梯度定义为通过对$A_0$的积分表达式求导得到的连续形状导数：\n$$\n\\frac{d C_L}{d m} = 2 \\pi \\frac{d A_0}{d m} = 2 \\pi \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( - \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta)) \\right) d\\theta = - 2 \\int_{0}^{\\pi} \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta)) \\, d\\theta.\n$$\n使用$x(\\theta) = \\frac{1 - \\cos \\theta}{2}$和$\\theta_p = \\arccos(1 - 2 p)$，导数$\\frac{\\partial}{\\partial m}\\frac{dz_c}{dx}$是分段常数乘以$(p - x)$：\n- 对于$0 \\le \\theta \\le \\theta_p$（即$x \\le p$），\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx} = \\frac{2}{p^2} (p - x(\\theta)).\n$$\n- 对于$\\theta_p \\le \\theta \\le \\pi$（即$x \\ge p$），\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx} = \\frac{2}{(1 - p)^2} (p - x(\\theta)).\n$$\n利用$p - x(\\theta) = p - \\frac{1}{2} + \\frac{1}{2} \\cos \\theta = \\frac{2p - 1}{2} + \\frac{1}{2} \\cos \\theta$，连续梯度计算为\n$$\n\\frac{d C_L}{d m} = - 2 \\left[ \\frac{2}{p^2} \\left( \\frac{2p - 1}{2} \\theta_p + \\frac{1}{2} \\sin \\theta_p \\right) + \\frac{2}{(1 - p)^2} \\left( \\frac{2p - 1}{2} (\\pi - \\theta_p) - \\frac{1}{2} \\sin \\theta_p \\right) \\right].\n$$\n\n对于离散伴随梯度，我们在$N+1$个点$\\theta_i = \\frac{i \\pi}{N+1}$（其中$i = 1, 2, \\dots, N+1$）上配置边界条件。我们将余弦级数截断为$N$个模态并包含常数项，从而得到系数向量$\\mathbf{a} = [A_0, A_1, \\dots, A_N]^T$的方形线性系统：\n$$\n\\mathbf{M} \\mathbf{a} = \\mathbf{r}, \\quad \\text{其中} \\quad M_{i,0} = 1, \\quad M_{i,n} = \\cos(n \\theta_i) \\; \\text{对于} \\; n = 1, \\dots, N, \\quad r_i = \\alpha - \\frac{dz_c}{dx}(x(\\theta_i)).\n$$\n目标是$f(\\mathbf{a}) = C_L = 2 \\pi A_0$，所以$\\frac{\\partial f}{\\partial \\mathbf{a}} = 2 \\pi \\mathbf{e}_0$，其中$\\mathbf{e}_0$是选择第一个分量的单位向量。离散伴随向量$\\boldsymbol{\\lambda}$求解\n$$\n\\mathbf{M}^T \\boldsymbol{\\lambda} = \\frac{\\partial f}{\\partial \\mathbf{a}} = 2 \\pi \\mathbf{e}_0.\n$$\n由于$\\mathbf{M}$不依赖于$m$（配置点和余弦基与几何参数无关），离散伴随梯度为\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{disc}} = \\boldsymbol{\\lambda}^T \\frac{\\partial \\mathbf{r}}{\\partial m} = - \\sum_{i=1}^{N+1} \\lambda_i \\, \\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta_i)).\n$$\n\n对于给定的参数集$(\\alpha, m, p, N)$，定义相对误差度量为\n$$\nE = \\frac{\\left| \\frac{d C_L}{d m}\\big|_{\\text{disc}} - \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|}{\\max \\left( \\left| \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|, \\varepsilon \\right)},\n$$\n其中$\\varepsilon = 10^{-12}$。\n\n攻角必须以弧度为单位指定。升力系数$C_L$及其梯度是无量纲的。\n\n实现一个Python程序，该程序：\n- 使用上述解析公式计算$\\frac{d C_L}{d m}\\big|_{\\text{cont}}$。\n- 对每个$(\\alpha, m, p, N)$，构建并求解离散伴随系统以获得$\\boldsymbol{\\lambda}$，并计算$\\frac{d C_L}{d m}\\big|_{\\text{disc}}$。\n- 报告所提供测试套件的相对误差$E$。\n\n测试套件参数：\n- 用例 1：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 4 \\right)$。\n- 用例 2：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 8 \\right)$。\n- 用例 3：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 16 \\right)$。\n- 用例 4：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.4, 32 \\right)$。\n- 用例 5：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.1, 16 \\right)$。\n- 用例 6：$(\\alpha, m, p, N) = \\left( \\frac{3 \\pi}{180}, 0.02, 0.5, 32 \\right)$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[result1,result2,...]\"）。每个结果必须是浮点数，代表对应测试用例的相对误差$E$，并严格按照上面列出的顺序。",
            "solution": "该问题陈述经评估在科学上是合理的、适定的且自洽的。它提出了一个计算空气动力学和基于伴随的灵敏度分析中的标准（尽管简化了的）问题。所有提供的公式和定义都与薄翼型理论和伴随法的既定原则一致。因此，该问题被认为是有效的，下面提供了解决方案。\n\n目标是计算NACA四位数翼型的升力系数$C_L$相对于最大弯度参数$m$的梯度。我们将比较使用连续伴随公式计算的梯度与使用离散伴随公式计算的梯度，并量化相对误差。\n\n### 连续伴随公式\n\n根据薄翼型理论，升力系数是攻角$\\alpha$和翼型弯度线形状$z_c(x)$的函数。该理论将流动相切边界条件线性化，并将其施加在弦线$x \\in [0, 1]$上。使用角坐标变换$x(\\theta) = (1 - \\cos \\theta) / 2$，边界条件表示为函数$f(\\theta)$，然后展开成余弦级数：\n$$\nf(\\theta) = \\alpha - \\frac{dz_c}{dx}(x(\\theta)) = A_0 + \\sum_{n=1}^{\\infty} A_n \\cos(n \\theta)\n$$\n升力系数与常数项$A_0$成正比：\n$$\nJ = C_L = 2 \\pi A_0\n$$\n利用余弦函数的正交性可以分离出系数$A_0$：\n$$\nA_0 = \\frac{1}{\\pi} \\int_{0}^{\\pi} f(\\theta) d\\theta = \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( \\alpha - \\frac{dz_c}{dx}(x(\\theta)) \\right) d\\theta\n$$\n设计参数是最大弯度$m$。目标函数$J$相对于$m$的梯度可以通过对$C_L$的表达式求导来找到。这是连续梯度，因为它是在对控制方程进行任何数值离散化之前推导出来的。\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{cont}} = \\frac{d}{dm} \\left( 2 \\pi \\frac{1}{\\pi} \\int_{0}^{\\pi} \\left( \\alpha - \\frac{dz_c}{dx} \\right) d\\theta \\right) = -2 \\int_{0}^{\\pi} \\frac{\\partial}{\\partial m}\\left(\\frac{dz_c}{dx}(x(\\theta))\\right) d\\theta\n$$\n弯度斜率的导数$\\frac{\\partial}{\\partial m}(\\frac{dz_c}{dx})$由NACA四位数翼型弯度线的分段定义导出：\n$$\n\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x) =\n\\begin{cases}\n    \\frac{2}{p^2} (p - x)         \\text{对于 } 0 \\le x \\le p \\\\\n    \\frac{2}{(1 - p)^2} (p - x)   \\text{对于 } p \\le x \\le 1\n\\end{cases}\n$$\n代入$x(\\theta) = (1 - \\cos \\theta) / 2$并对由$\\theta_p = \\arccos(1 - 2p)$分隔的两个段进行积分，得到所提供的连续梯度的解析公式，我们已经验证了该公式：\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{cont}} = -2 \\left[ \\frac{2}{p^2} \\left( \\frac{2p - 1}{2} \\theta_p + \\frac{1}{2} \\sin \\theta_p \\right) + \\frac{2}{(1 - p)^2} \\left( \\frac{2p - 1}{2} (\\pi - \\theta_p) - \\frac{1}{2} \\sin \\theta_p \\right) \\right]\n$$\n此公式仅依赖于参数$p$，即最大弯度的位置。\n\n### 离散伴随公式\n\n在离散方法中，我们首先离散化控制方程，然后进行灵敏度分析。边界条件在一组有限的$N+1$个配置点$\\theta_i = \\frac{i \\pi}{N+1}$（$i = 1, 2, \\dots, N+1$）上强制执行。余弦级数被截断为$N+1$项，$[A_0, A_1, \\dots, A_N]^T = \\mathbf{a}$。这导致一个线性方程组（原始或状态系统）：\n$$\n\\mathbf{R}(\\mathbf{a}, m) = \\mathbf{M} \\mathbf{a} - \\mathbf{r}(m) = \\mathbf{0}\n$$\n其中矩阵$\\mathbf{M}$和向量$\\mathbf{r}$由下式给出：\n$$\nM_{ij} = \\cos(j \\theta_i) \\quad \\text{对于 } i \\in \\{1, \\dots, N+1\\}, j \\in \\{0, \\dots, N\\}\n$$\n$$\nr_i(m) = \\alpha - \\frac{dz_c}{dx}(x(\\theta_i); m)\n$$\n离散目标函数为$f(\\mathbf{a}) = 2 \\pi A_0 = 2 \\pi \\mathbf{e}_0^T \\mathbf{a}$，其中$\\mathbf{e}_0 = [1, 0, \\dots, 0]^T$。\n\n为了求梯度$\\frac{df}{dm}$，我们使用伴随法来避免计算成本高昂的$\\frac{d\\mathbf{a}}{dm}$。让我们仔细地进行推导。全导数为：\n$$\n\\frac{df}{dm} = \\left(\\nabla_{\\mathbf{a}} f\\right) \\frac{d\\mathbf{a}}{dm} + \\frac{\\partial f}{\\partial m}\n$$\n其中$\\nabla_{\\mathbf{a}} f = 2 \\pi \\mathbf{e}_0^T$ 是一个行向量。由于$f$不显式依赖于$m$，所以$\\frac{\\partial f}{\\partial m} = 0$。对状态方程$\\mathbf{R}=\\mathbf{0}$求导得到$\\frac{d\\mathbf{R}}{dm} = \\nabla_{\\mathbf{a}} \\mathbf{R} \\cdot \\frac{d\\mathbf{a}}{dm} + \\frac{\\partial \\mathbf{R}}{\\partial m} = \\mathbf{0}$，这给出$\\mathbf{M} \\frac{d\\mathbf{a}}{dm} - \\frac{\\partial \\mathbf{r}}{\\partial m} = \\mathbf{0}$。求解$\\frac{d\\mathbf{a}}{dm}$得到$\\frac{d\\mathbf{a}}{dm} = \\mathbf{M}^{-1} \\frac{\\partial \\mathbf{r}}{\\partial m}$。\n将此代入梯度表达式：\n$$\n\\frac{df}{dm} = (2 \\pi \\mathbf{e}_0^T) \\mathbf{M}^{-1} \\frac{\\partial \\mathbf{r}}{\\partial m}\n$$\n我们定义伴随向量$\\boldsymbol{\\lambda}$（作为列向量）作为伴随方程的解：\n$$\n\\mathbf{M}^T \\boldsymbol{\\lambda} = (2 \\pi \\mathbf{e}_0^T)^T = 2 \\pi \\mathbf{e}_0\n$$\n那么$\\boldsymbol{\\lambda}^T = (2 \\pi \\mathbf{e}_0)^T (\\mathbf{M}^T)^{-1}$。代入梯度表达式，得到：\n$$\n\\frac{df}{dm} = \\boldsymbol{\\lambda}^T \\frac{\\partial \\mathbf{r}}{\\partial m}\n$$\n这与问题陈述一致。因此，离散梯度为：\n$$\n\\frac{d C_L}{d m}\\biggr|_{\\text{disc}} = \\boldsymbol{\\lambda}^T \\frac{\\partial \\mathbf{r}}{\\partial m}\n$$\n其中$\\frac{\\partial \\mathbf{r}}{\\partial m}$是一个向量，其分量为$(\\frac{\\partial r}{\\partial m})_i = -\\frac{\\partial}{\\partial m} \\frac{dz_c}{dx}(x(\\theta_i))$。我们求解一个线性系统得到$\\boldsymbol{\\lambda}$，然后通过向量点积计算梯度。对于这个线性问题，参数$\\alpha$和$m$在此梯度计算中是不需要的，因为$\\boldsymbol{\\lambda}$和$\\frac{\\partial \\mathbf{r}}{\\partial m}$都与它们无关。\n\n### 误差计算\n\n离散梯度和连续梯度之间的相对误差计算如下：\n$$\nE = \\frac{\\left| \\frac{d C_L}{d m}\\big|_{\\text{disc}} - \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|}{\\max \\left( \\left| \\frac{d C_L}{d m}\\big|_{\\text{cont}} \\right|, \\varepsilon \\right)}\n$$\n使用一个小的正则化参数$\\varepsilon = 10^{-12}$以防止除以零。数值实现将为每个测试用例计算此误差。随着配置点数$N+1$的增加，离散梯度预计会收敛到连续梯度，导致误差$E$减小。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares continuous and discrete adjoint gradients for a NACA 4-digit airfoil.\n    \"\"\"\n\n    test_cases = [\n        (3 * np.pi / 180, 0.02, 0.4, 4),\n        (3 * np.pi / 180, 0.02, 0.4, 8),\n        (3 * np.pi / 180, 0.02, 0.4, 16),\n        (3 * np.pi / 180, 0.02, 0.4, 32),\n        (3 * np.pi / 180, 0.02, 0.1, 16),\n        (3 * np.pi / 180, 0.02, 0.5, 32),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        alpha, m, p, N = case\n        \n        # 1. Compute the continuous adjoint gradient\n        # The formula is invalid for p=0 or p=1, but test cases are safe.\n        if p == 0.0 or p == 1.0:\n            # For p=0.5, the gradient is 0. This is a special case of the formula.\n            if p == 0.5:\n                grad_cont = 0.0\n            else:\n                 # In practice, handle these edge cases if they can occur.\n                 # For the given test suite, this branch is not taken.\n                 grad_cont = np.nan\n        else:\n            theta_p = np.arccos(1 - 2 * p)\n            \n            term1 = (2 / p**2) * ( (2*p - 1)/2 * theta_p + 0.5 * np.sin(theta_p) )\n            \n            term2 = (2 / (1 - p)**2) * ( (2*p - 1)/2 * (np.pi - theta_p) - 0.5 * np.sin(theta_p) )\n            \n            grad_cont = -2 * (term1 + term2)\n\n        # 2. Compute the discrete adjoint gradient\n        \n        # Number of collocation points and modes\n        num_points = N + 1\n        \n        # Collocation points theta_i = i*pi/(N+1) for i = 1, ..., N+1\n        i_vals = np.arange(1, num_points + 1)\n        theta_vec = i_vals * np.pi / num_points\n        \n        # Matrix M where M_ij = cos(j * theta_i) for i rows, j columns\n        # Column index j corresponds to A_j, j from 0 to N\n        # Row index i corresponds to theta_i, i from 1 to N+1\n        j_vals = np.arange(num_points) # 0 to N\n        M = np.cos(np.outer(theta_vec, j_vals))\n        \n        # Solve the adjoint system: M^T * lambda = dJ/da\n        # dJ/da = [2*pi, 0, ..., 0]^T\n        dJ_da = np.zeros(num_points)\n        dJ_da[0] = 2 * np.pi\n        \n        lambda_vec = np.linalg.solve(M.T, dJ_da)\n        \n        # Compute dr/dm = -d/dm(dzc/dx) at collocation points\n        x_vec = (1 - np.cos(theta_vec)) / 2\n        \n        dr_dm = np.zeros(num_points)\n        for i, x_i in enumerate(x_vec):\n            if x_i = p:\n                if p == 0:\n                    deriv = np.inf # Avoid division by zero\n                else:\n                    deriv = (2 / p**2) * (p - x_i)\n            else: # x_i > p\n                if p == 1:\n                    deriv = np.inf # Avoid division by zero\n                else:\n                    deriv = (2 / (1 - p)**2) * (p - x_i)\n            dr_dm[i] = -deriv\n            \n        grad_disc = np.dot(lambda_vec, dr_dm)\n\n        # 3. Compute relative error\n        epsilon = 1e-12\n        denominator = max(abs(grad_cont), epsilon)\n        error = abs(grad_disc - grad_cont) / denominator\n        \n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}