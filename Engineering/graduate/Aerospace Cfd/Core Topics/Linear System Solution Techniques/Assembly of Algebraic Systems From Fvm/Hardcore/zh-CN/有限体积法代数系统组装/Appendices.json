{
    "hands_on_practices": [
        {
            "introduction": "将控制方程离散为代数方程组是有限体积法 (Finite Volume Method, FVM) 的核心步骤。在此过程中，一个关键环节是如何正确施加边界条件，因为这直接影响最终系统的结构和数值属性。本练习将引导您探索处理狄利克雷 (Dirichlet) 边界条件的两种经典方法——“消元法”和“罚函数法”，并通过分析最终矩阵的条件数来揭示不同方法对线性系统求解性能的深远影响 。",
            "id": "3944932",
            "problem": "考虑一个厚度为 $L$、导热系数 $k$ 为常数的平板中的一维稳态热传导问题，其控制方程为守恒定律 $\\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right)=0$。使用有限体积法 (FVM)，在一个包含三个宽度为 $h$、横截面积为 $A$ 的控制体积的均匀网格上组装代数系统，其中单元中心处的未知温度为 $\\{T_1,T_2,T_3\\}$。假设 $x=0$ 处的左边界服从 Dirichlet 条件 $T(0)=T_D$，$x=L$ 处的右边界是绝热的，即 Neumann 条件 $-\\left.k\\frac{dT}{dx}\\right|_{x=L}=0$。设边界处面到中心的距离为 $h/2$，相邻单元中心之间的距离为 $h$，并在面上使用线性（两点）扩散通量近似。\n\n你需要针对 Dirichlet 边界的两种不同处理方法，组装离散矩阵 $\\boldsymbol{A}$ 和右端项 $\\boldsymbol{b}$：\n\n- 消元法：在全局系统中通过行和列消元来强制执行 $T_1=T_D$，并通过将耦合项移到右端项来保持对称性。\n- 罚函数法：保留原始行，并在 Dirichlet 自由度上附加一个强度为 $\\gamma0$ 的罚项。\n\n使用无量纲常数 $k=1$, $h=1$, $A=1$，使得内部扩散导热系数为1。从 FVM 通量平衡的基本原理出发，写出三个控制体积的未修改的传导模板，然后：\n\n1. 使用消元法，写出对矩阵元素和右端项的精确代数修改。用 $T_D$ 显式地给出最终组装的 $\\boldsymbol{A}_{\\text{elim}}$ 和 $\\boldsymbol{b}_{\\text{elim}}$。\n2. 使用罚函数法，写出对矩阵元素和右端项的精确代数修改。用 $T_D$ 和 $\\gamma$ 显式地给出最终组装的 $\\boldsymbol{A}_{\\text{pen}}$ 和 $\\boldsymbol{b}_{\\text{pen}}$。\n3. 对每个组装的矩阵，基于其最大特征值与最小特征值之比，分析其 2-范数条件数 $\\kappa_2(\\boldsymbol{A})$。对于消元法，精确计算 $\\kappa_2(\\boldsymbol{A}_{\\text{elim}})$。对于罚函数法，推导当 $\\gamma\\to\\infty$ 时 $\\kappa_2(\\boldsymbol{A}_{\\text{pen}})$ 的主阶渐近形式，只保留 $\\gamma$ 的主导标度。\n\n最后，推导当 $\\gamma\\to\\infty$ 时条件数之比的主阶渐近表达式\n$$\n\\frac{\\kappa_2\\!\\left(\\boldsymbol{A}_{\\text{pen}}\\right)}{\\kappa_2\\!\\left(\\boldsymbol{A}_{\\text{elim}}\\right)}.\n$$\n将最终答案表示为关于 $\\gamma$ 和根式的单一闭式解析表达式。无需四舍五入，也无需报告物理单位。定义：有限体积法 (Finite Volume Method, FVM)，计算流体力学 (Computational Fluid Dynamics, CFD)。",
            "solution": "该问题陈述具有科学依据、适定、客观且内部一致。它提出了一个在使用有限体积法进行偏微分方程数值分析领域的标准、可验证的问题。该问题是有效的。\n\n我们首先将有限体积法 (FVM) 应用于一维稳态热传导方程 $\\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right)=0$。在一个横截面积为 $A$ 的控制体积 $V_i$ 上，从其西面 ($w$) 到东面 ($e$) 进行积分，得到：\n$$ \\int_{V_i} \\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) dV = \\int_{x_w}^{x_e} A \\frac{d}{dx}\\left(k \\frac{dT}{dx}\\right) dx = A \\left[k \\frac{dT}{dx}\\right]_{x_w}^{x_e} = 0 $$\n这给出了通量平衡：$\\left(k A \\frac{dT}{dx}\\right)_e - \\left(k A \\frac{dT}{dx}\\right)_w = 0$。一个面上的热通量为 $q = -k A \\frac{dT}{dx}$。因此，平衡关系为 $q_w - q_e = 0$。\n\n我们使用一个包含三个控制体积的均匀网格，每个控制体积的宽度为 $h$。区域总长度为 $L=3h$。单元中心位于 $x_1 = h/2$、$x_2 = 3h/2$ 和 $x_3 = 5h/2$。无量纲常数为 $k=1$, $h=1$, $A=1$。因此，$L=3$，单元中心位于 $x_1=0.5$、$x_2=1.5$、$x_3=2.5$。各个面位于 $x=0, 1, 2, 3$。\n\n单元 $i$ 和 $i+1$ 之间的内界面上的通量近似为：\n$$ q_{i+1/2} = -k_f A_f \\frac{T_{i+1}-T_i}{x_{i+1}-x_i} = -(1)(1)\\frac{T_{i+1}-T_i}{1} = -(T_{i+1}-T_i) $$\n内部单元之间的扩散导热系数为 $C_{int} = kA/h = 1$。\n\n现在我们为每个控制体积组装方程，这构成了两种所需方法的基础。\n\n**控制体积 1 (中心位于 $x_1=0.5$)：**\n西面是位于 $x=0$ 的边界，其中 $T(0)=T_D$。通量为 $q_w = -kA \\frac{T_1 - T_D}{x_1 - 0} = - (1)(1) \\frac{T_1 - T_D}{0.5-0} = -2(T_1-T_D)$。\n东面位于 $x=1$，在单元 1 和 2 之间。通量为 $q_e = -(T_2-T_1)$。\n平衡关系 $q_w - q_e = 0$ 给出：$-2(T_1-T_D) - (-(T_2-T_1)) = 0$，化简为 $-2T_1+2T_D+T_2-T_1=0$，即 $3T_1-T_2 = 2T_D$。\n\n**控制体积 2 (中心位于 $x_2=1.5$)：**\n西面位于 $x=1$，因此 $q_w = -(T_2-T_1)$。\n东面位于 $x=2$，在单元 2 和 3 之间，因此 $q_e = -(T_3-T_2)$。\n平衡关系 $q_w - q_e = 0$ 给出：$-(T_2-T_1) - (-(T_3-T_2))=0$，化简为 $-T_2+T_1+T_3-T_2=0$，即 $-T_1+2T_2-T_3=0$。\n\n**控制体积 3 (中心位于 $x_3=2.5$)：**\n西面位于 $x=2$，因此 $q_w = -(T_3-T_2)$。\n东面位于边界 $x=L=3$，该边界是绝热的。条件是 $-\\left.k\\frac{dT}{dx}\\right|_{x=L}=0$，这意味着通量 $q_e=0$。\n平衡关系 $q_w - q_e = 0$ 给出：$-(T_3-T_2) - 0 = 0$，即 $-T_2+T_3=0$。\n\n组装后的系统，我们称之为基础系统，是：\n$$\n\\begin{pmatrix}\n3  -1  0 \\\\\n-1  2  -1 \\\\\n0  -1  1\n\\end{pmatrix}\n\\begin{pmatrix}\nT_1 \\\\ T_2 \\\\ T_3\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n2T_D \\\\ 0 \\\\ 0\n\\end{pmatrix}\n$$\n记该系统为 $\\boldsymbol{A}_{\\text{base}}\\boldsymbol{T} = \\boldsymbol{b}_{\\text{base}}$。\n\n### 1. 消元法\n\n消元法在组装的系统上强制执行 Dirichlet 条件 $T_1=T_D$，同时保持对称性。我们修改系统，使得第一个方程变为 $T_1=T_D$，并且从 $T_1$ 到其他方程的耦合项被移到右端项。\n\n第二个方程是 $-T_1+2T_2-T_3=0$。代入 $T_1=T_D$，它变为 $2T_2-T_3 = T_D$。这等价于更新右端项：$b_2' = b_2 - A_{21}T_D = 0 - (-1)T_D = T_D$。\n第三个方程 $ -T_2+T_3=0$ 不涉及 $T_1$，因此保持不变。\n第一个方程被约束条件 $T_1=T_D$ 替代。\n为了保持对称的矩阵结构，我们将第一行和第一列的非对角元素设为零，并将对角元素 $A_{11}$ 设为 1。修改后的系统 $\\boldsymbol{A}_{\\text{elim}}\\boldsymbol{T} = \\boldsymbol{b}_{\\text{elim}}$ 是：\n$$\n\\boldsymbol{A}_{\\text{elim}} =\n\\begin{pmatrix}\n1  0  0 \\\\\n0  2  -1 \\\\\n0  -1  1\n\\end{pmatrix},\n\\quad\n\\boldsymbol{b}_{\\text{elim}} =\n\\begin{pmatrix}\nT_D \\\\\nT_D \\\\\n0\n\\end{pmatrix}\n$$\n\n### 2. 罚函数法\n\n罚函数法通过向第一个方程添加一个罚项来强制执行 Dirichlet 条件 $T_1 \\approx T_D$。这是通过将 $\\gamma$ 加到基础系统的对角元素 $A_{11}$ 上，并将 $\\gamma T_D$ 加到右端项 $b_1$ 上来实现的。\n从 $\\boldsymbol{A}_{\\text{base}}$ 和 $\\boldsymbol{b}_{\\text{base}}$ 开始：\n$A_{11, \\text{pen}} = A_{11, \\text{base}} + \\gamma = 3+\\gamma$。\n$b_{1, \\text{pen}} = b_{1, \\text{base}} + \\gamma T_D = 2T_D + \\gamma T_D = (2+\\gamma)T_D$。\n系统的其他行不变。得到的系统 $\\boldsymbol{A}_{\\text{pen}}\\boldsymbol{T} = \\boldsymbol{b}_{\\text{pen}}$ 是：\n$$\n\\boldsymbol{A}_{\\text{pen}} =\n\\begin{pmatrix}\n3+\\gamma  -1  0 \\\\\n-1  2  -1 \\\\\n0  -1  1\n\\end{pmatrix},\n\\quad\n\\boldsymbol{b}_{\\text{pen}} =\n\\begin{pmatrix}\n(2+\\gamma)T_D \\\\\n0 \\\\\n0\n\\end{pmatrix}\n$$\n\n### 3. 条件数分析\n\n2-范数条件数为 $\\kappa_2(\\boldsymbol{A}) = \\frac{|\\lambda_{\\max}|}{|\\lambda_{\\min}|}$。\n\n**$\\boldsymbol{A}_{\\text{elim}}$ 的条件数：**\n$\\boldsymbol{A}_{\\text{elim}}$ 的特征值 $\\lambda$ 由 $\\det(\\boldsymbol{A}_{\\text{elim}} - \\lambda\\boldsymbol{I}) = 0$ 求得。\n$$ \\det\\begin{pmatrix} 1-\\lambda  0  0 \\\\ 0  2-\\lambda  -1 \\\\ 0  -1  1-\\lambda \\end{pmatrix} = (1-\\lambda)[(2-\\lambda)(1-\\lambda) - 1] = 0 $$\n一个特征值是 $\\lambda_1=1$。另外两个是 $\\lambda^2-3\\lambda+1=0$ 的根，即 $\\lambda_{2,3} = \\frac{3 \\pm \\sqrt{5}}{2}$。\n特征值为 $\\lambda_{\\max} = \\frac{3+\\sqrt{5}}{2}$、$\\lambda_{\\min} = \\frac{3-\\sqrt{5}}{2}$ 和 $1$。\n所以，$\\lambda_{\\max}(\\boldsymbol{A}_{\\text{elim}}) = \\frac{3+\\sqrt{5}}{2}$ 且 $\\lambda_{\\min}(\\boldsymbol{A}_{\\text{elim}}) = \\frac{3-\\sqrt{5}}{2}$。\n$$ \\kappa_2(\\boldsymbol{A}_{\\text{elim}}) = \\frac{\\lambda_{\\max}}{\\lambda_{\\min}} = \\frac{(3+\\sqrt{5})/2}{(3-\\sqrt{5})/2} = \\frac{3+\\sqrt{5}}{3-\\sqrt{5}} = \\frac{(3+\\sqrt{5})^2}{(3-\\sqrt{5})(3+\\sqrt{5})} = \\frac{9+6\\sqrt{5}+5}{9-5} = \\frac{14+6\\sqrt{5}}{4} = \\frac{7+3\\sqrt{5}}{2} $$\n\n**当 $\\gamma \\to \\infty$ 时 $\\boldsymbol{A}_{\\text{pen}}$ 的渐近条件数：**\n特征方程为 $\\det(\\boldsymbol{A}_{\\text{pen}} - \\lambda \\boldsymbol{I})=0$。\n$$ (3+\\gamma-\\lambda)((2-\\lambda)(1-\\lambda)-1) - (-1)(-(1-\\lambda)) = 0 $$\n$$ (3+\\gamma-\\lambda)(\\lambda^2-3\\lambda+1) - (1-\\lambda) = 0 $$\n$$ \\lambda^3 - (6+\\gamma)\\lambda^2 + (9+3\\gamma)\\lambda - (2+\\gamma) = 0 $$\n当 $\\gamma \\to \\infty$ 时，我们预期有一个大特征值 $\\lambda_{\\max} \\sim O(\\gamma)$ 和两个 $O(1)$ 阶的小特征值。\n对于小特征值，我们将多项式除以 $\\gamma$ 并取极限 $\\gamma \\to \\infty$：\n$$ \\frac{\\lambda^3}{\\gamma} - (1+\\frac{6}{\\gamma})\\lambda^2 + (3+\\frac{9}{\\gamma})\\lambda - (1+\\frac{2}{\\gamma}) = 0 \\quad\\to\\quad -\\lambda^2+3\\lambda-1=0 $$\n这给出 $\\lambda^2-3\\lambda+1=0$，因此两个较小的特征值收敛于 $\\frac{3 \\pm \\sqrt{5}}{2}$。因此，$\\lambda_{\\min}(\\boldsymbol{A}_{\\text{pen}}) \\to \\frac{3-\\sqrt{5}}{2}$。\n对于大特征值，特征值之和为 $\\lambda_1+\\lambda_2+\\lambda_3 = 6+\\gamma$。当 $\\gamma\\to\\infty$ 时，$\\lambda_{\\max} + \\frac{3+\\sqrt{5}}{2} + \\frac{3-\\sqrt{5}}{2} \\approx 6+\\gamma$。\n$\\lambda_{\\max} + 3 \\approx 6+\\gamma$，所以 $\\lambda_{\\max} \\approx \\gamma+3$。\n主阶项为 $\\lambda_{\\max} \\sim \\gamma$。\n渐近条件数为：\n$$ \\kappa_2(\\boldsymbol{A}_{\\text{pen}}) \\sim \\frac{\\lambda_{\\max}}{\\lambda_{\\min}} \\sim \\frac{\\gamma}{\\frac{3-\\sqrt{5}}{2}} = \\frac{2\\gamma}{3-\\sqrt{5}} = \\frac{2\\gamma(3+\\sqrt{5})}{9-5} = \\gamma\\frac{3+\\sqrt{5}}{2} $$\n\n**条件数之比：**\n最后，我们计算当 $\\gamma \\to \\infty$ 时该比率的主阶渐近表达式：\n$$ \\frac{\\kappa_2(\\boldsymbol{A}_{\\text{pen}})}{\\kappa_2(\\boldsymbol{A}_{\\text{elim}})} \\sim \\frac{\\gamma\\frac{3+\\sqrt{5}}{2}}{\\frac{7+3\\sqrt{5}}{2}} = \\gamma \\frac{3+\\sqrt{5}}{7+3\\sqrt{5}} $$\n为化简该分数，我们将分母有理化：\n$$ \\gamma \\frac{3+\\sqrt{5}}{7+3\\sqrt{5}} \\times \\frac{7-3\\sqrt{5}}{7-3\\sqrt{5}} = \\gamma \\frac{(3+\\sqrt{5})(7-3\\sqrt{5})}{7^2 - (3\\sqrt{5})^2} = \\gamma \\frac{21 - 9\\sqrt{5} + 7\\sqrt{5} - 3(5)}{49 - 9(5)} $$\n$$ = \\gamma \\frac{21-15-2\\sqrt{5}}{49-45} = \\gamma \\frac{6-2\\sqrt{5}}{4} = \\gamma \\frac{3-\\sqrt{5}}{2} $$\n该比率的主阶渐近表达式为 $\\gamma \\frac{3-\\sqrt{5}}{2}$。",
            "answer": "$$\n\\boxed{\\gamma \\frac{3-\\sqrt{5}}{2}}\n$$"
        },
        {
            "introduction": "在计算流体力学 (Computational Fluid Dynamics, CFD) 中，许多重要问题本质上是非线性的，例如包含非线性源项或与速度相关的对流通量。求解这些非线性代数方程组通常依赖于牛顿法等迭代策略，而牛顿法的核心在于计算和使用雅可比矩阵。本练习将带您亲手构建一个包含非线性源项的对流扩散问题的雅可比矩阵列，并对比基于解析微分（自动微分的核心思想）和有限差分近似的两种不同计算方式，从而深入理解为非线性求解器精确高效地组装雅可比矩阵的原理 。",
            "id": "3944905",
            "problem": "考虑在均匀网格上的一维稳态对流-扩散方程，其带有非线性源项，并使用有限体积法 (FVM) 进行离散化。设计算域长度为 $L=1$，划分为 $N=4$ 个相等的控制体积，每个控制体积的宽度为 $\\Delta x = L/N = 0.25$，横截面积恒为 $A=1$。扩散系数为 $\\Gamma=0.1$，密度为 $\\rho=1$，均匀对流速度为 $V=3$，方向从左到右。左、右狄利克雷边界值分别为 $u_{L}=1$ 和 $u_{R}=0$。非线性源项为 $S(u) = k\\,u^{2}$，其中 $k=5$，因此在单元 $i$ 上积分的体积源为 $k\\,A\\,\\Delta x\\,u_{i}^{2}$。\n\n将 $N=4$ 个单元中心的未知量向量表示为 $\\mathbf{u} = [u_{1},u_{2},u_{3},u_{4}]^{\\top}$。对于每个内部控制体积 $i \\in \\{1,2,3,4\\}$，将残差 $R_{i}(\\mathbf{u})$ 定义为对流通量和扩散通量的净流出量加上体积源：\n$$\nR_{i}(\\mathbf{u}) = \\big(F_{c,i+\\frac{1}{2}} - F_{c,i-\\frac{1}{2}}\\big) + \\big(F_{d,i+\\frac{1}{2}} - F_{d,i-\\frac{1}{2}}\\big) + k\\,A\\,\\Delta x\\,u_{i}^{2},\n$$\n其中，对于正的 $V$，在面 $i+\\frac{1}{2}$ 处的迎风对流通量为 $F_{c,i+\\frac{1}{2}} = \\rho\\,V\\,A\\,u_{i}$，在左边界的面 $\\frac{1}{2}$ 处为 $F_{c,\\frac{1}{2}}=\\rho\\,V\\,A\\,u_{L}$。在面 $i+\\frac{1}{2}$ 处的扩散通量为 $F_{d,i+\\frac{1}{2}} = -\\Gamma\\,A\\,\\frac{u_{i+1}-u_{i}}{\\Delta x}$，边界上的面使用 $u_{L}$ 和 $u_{R}$ 代替 $u_{0}$ 和 $u_{5}$。\n\n设当前迭代值为\n$$\n\\mathbf{u}^{(0)} = [0.8,\\,0.5,\\,0.2,\\,0.1]^{\\top}.\n$$\n设 $\\mathbf{J}(\\mathbf{u})$ 表示 $\\mathbf{R}(\\mathbf{u})$ 关于 $\\mathbf{u}$ 的雅可比矩阵。你的任务是使用两种方法在 $\\mathbf{u}^{(0)}$ 处组装雅可比矩阵的第三列 $\\mathbf{J}(:,3)$：\n1. 通过对残差定义关于 $u_{3}$ 求导，进行与自动微分 (AD) 原理一致的解析组装。\n2. 使用扰动步长 $h = 10^{-6}$ 的中心有限差分近似，\n$$\n\\mathbf{J}_{\\mathrm{FD}}(:,3) \\approx \\frac{\\mathbf{R}(\\mathbf{u}^{(0)} + h\\,\\mathbf{e}_{3}) - \\mathbf{R}(\\mathbf{u}^{(0)} - h\\,\\mathbf{e}_{3})}{2\\,h},\n$$\n其中 $\\mathbf{e}_{3}$ 是 $\\mathbb{R}^{4}$ 中的第三个标准基向量。\n\n计算这两列，讨论它们的稀疏模式，并最终计算欧几里得二范数\n$$\n\\left\\| \\mathbf{J}_{\\mathrm{FD}}(:,3) - \\mathbf{J}(:,3) \\right\\|_{2}.\n$$\n将此范数作为最终答案。无需四舍五入。将最终答案表示为不带单位的纯数字。",
            "solution": "问题已根据指定标准进行验证。\n\n**步骤1：提取已知条件**\n- **域和网格**：长度 $L=1$，控制体积数量 $N=4$，控制体积宽度 $\\Delta x = L/N = 0.25$，横截面积 $A=1$。\n- **物理常数**：扩散系数 $\\Gamma=0.1$，密度 $\\rho=1$，均匀对流速度 $V=3$ (正)。\n- **边界条件**：狄利克雷类型，左边界值 $u_{L}=1$，右边界值 $u_{R}=0$。\n- **源项**：$S(u) = k\\,u^{2}$，其中 $k=5$。在单元 $i$ 上的积分源为 $k\\,A\\,\\Delta x\\,u_{i}^{2}$。\n- **未知量和迭代值**：未知量向量 $\\mathbf{u} = [u_{1},u_{2},u_{3},u_{4}]^{\\top}$，当前迭代值 $\\mathbf{u}^{(0)} = [0.8,\\,0.5,\\,0.2,\\,0.1]^{\\top}$。\n- **残差定义**：对于单元 $i$，$R_{i}(\\mathbf{u}) = \\big(F_{c,i+\\frac{1}{2}} - F_{c,i-\\frac{1}{2}}\\big) + \\big(F_{d,i+\\frac{1}{2}} - F_{d,i-\\frac{1}{2}}\\big) + k\\,A\\,\\Delta x\\,u_{i}^{2}$。\n- **通量定义（$V0$ 时使用迎风格式）**：\n  - 对流通量：在一般面处 $F_{c,i+\\frac{1}{2}} = \\rho\\,V\\,A\\,u_{i}$，在左边界处 $F_{c,\\frac{1}{2}}=\\rho\\,V\\,A\\,u_{L}$。\n  - 扩散通量：$F_{d,i+\\frac{1}{2}} = -\\Gamma\\,A\\,\\frac{u_{i+1}-u_{i}}{\\Delta x}$。\n- **有限差分近似**：使用步长 $h = 10^{-6}$ 和中心差分公式的雅可比矩阵列近似：\n  $$\n  \\mathbf{J}_{\\mathrm{FD}}(:,3) \\approx \\frac{\\mathbf{R}(\\mathbf{u}^{(0)} + h\\,\\mathbf{e}_{3}) - \\mathbf{R}(\\mathbf{u}^{(0)} - h\\,\\mathbf{e}_{3})}{2\\,h}\n  $$\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题描述了一个标准的一维稳态对流-扩散方程，带有非线性源项，并使用有限体积法进行离散化。这是计算流体动力学和传热学中的一个基本且成熟的问题。\n- **适定性**：所有必要的参数、边界条件和本构关系（通量定义）均已提供。该问题是自洽的，在数学上没有歧义。\n- **客观性**：该问题以精确的数学和工程术语陈述，没有主观性。\n\n未发现任何使其无效的缺陷。该问题被认为是有效的。\n\n**步骤3：结论与行动**\n该问题是有效的。解决方案将在下面提供。\n\n首先，我们为 $N=4$ 个控制体积中的每一个建立离散化的残差方程。我们根据给定的参数定义两个关键系数：\n对流通量系数：$C = \\rho\\,V\\,A = 1 \\times 3 \\times 1 = 3$。\n扩散通量系数：$D = \\frac{\\Gamma\\,A}{\\Delta x} = \\frac{0.1 \\times 1}{0.25} = 0.4$。\n单元 $i$ 的源项系数为 $k\\,A\\,\\Delta x = 5 \\times 1 \\times 0.25 = 1.25$。\n\n对于一个一般内部单元 $i \\in \\{2, 3\\}$，其残差为：\n$R_{i}(\\mathbf{u}) = (C\\,u_{i} - C\\,u_{i-1}) + \\left(-\\Gamma\\,A\\,\\frac{u_{i+1}-u_{i}}{\\Delta x} - (-\\Gamma\\,A\\,\\frac{u_{i}-u_{i-1}}{\\Delta x})\\right) + 1.25\\,u_{i}^{2}$\n$R_{i}(\\mathbf{u}) = C\\,u_{i} - C\\,u_{i-1} - D\\,u_{i+1} + 2\\,D\\,u_{i} - D\\,u_{i-1} + 1.25\\,u_{i}^{2}$\n$R_{i}(\\mathbf{u}) = -(C+D)u_{i-1} + (C+2D)u_{i} - D\\,u_{i+1} + 1.25\\,u_{i}^{2}$\n\n现在我们为每个单元写出具体的残差方程，并应用边界条件。\n对于单元 $i=1$：$u_{i-1}$ 被替换为 $u_{L}=1$。\n$R_{1}(\\mathbf{u}) = (C\\,u_{1} - C\\,u_{L}) + \\left(-D(u_{2}-u_{1}) - (-D(u_{1}-u_{L}))\\right) + 1.25\\,u_{1}^{2}$\n$R_{1}(\\mathbf{u}) = (C+2D)u_{1} - D\\,u_{2} + 1.25\\,u_{1}^{2} - (C+D)u_{L}$\n代入 $C=3$, $D=0.4$, $u_{L}=1$：\n$R_{1}(\\mathbf{u}) = 3.8\\,u_{1} - 0.4\\,u_{2} + 1.25\\,u_{1}^{2} - 3.4$。\n\n对于单元 $i=2$：\n$R_{2}(\\mathbf{u}) = -(C+D)u_{1} + (C+2D)u_{2} - D\\,u_{3} + 1.25\\,u_{2}^{2}$\n$R_{2}(\\mathbf{u}) = -3.4\\,u_{1} + 3.8\\,u_{2} - 0.4\\,u_{3} + 1.25\\,u_{2}^{2}$。\n\n对于单元 $i=3$：\n$R_{3}(\\mathbf{u}) = -(C+D)u_{2} + (C+2D)u_{3} - D\\,u_{4} + 1.25\\,u_{3}^{2}$\n$R_{3}(\\mathbf{u}) = -3.4\\,u_{2} + 3.8\\,u_{3} - 0.4\\,u_{4} + 1.25\\,u_{3}^{2}$。\n\n对于单元 $i=4$：$u_{i+1}$ 被替换为 $u_{R}=0$。\n$R_{4}(\\mathbf{u}) = (C\\,u_{4} - C\\,u_{3}) + \\left(-D(u_{R}-u_{4}) - (-D(u_{4}-u_{3}))\\right) + 1.25\\,u_{4}^{2}$\n$R_{4}(\\mathbf{u}) = -(C+D)u_{3} + (C+2D)u_{4} + 1.25\\,u_{4}^{2} - D\\,u_{R}$\n代入 $C=3$, $D=0.4$, $u_{R}=0$：\n$R_{4}(\\mathbf{u}) = -3.4\\,u_{3} + 3.8\\,u_{4} + 1.25\\,u_{4}^{2}$。\n\n**1. 解析雅可比矩阵列组装**\n雅可比矩阵定义为 $J_{ij}(\\mathbf{u}) = \\frac{\\partial R_{i}}{\\partial u_{j}}$。我们需要计算第三列 $\\mathbf{J}(:,3)$，它由每个残差分量对 $u_{3}$ 的导数组成。\n- $\\frac{\\partial R_{1}}{\\partial u_{3}}$：$R_{1}$ 只依赖于 $u_{1}$ 和 $u_{2}$。\n  $$J_{13} = \\frac{\\partial R_{1}}{\\partial u_{3}} = 0$$\n- $\\frac{\\partial R_{2}}{\\partial u_{3}}$：根据 $R_{2}$ 的表达式，我们对 $u_{3}$ 求导。\n  $$J_{23} = \\frac{\\partial R_{2}}{\\partial u_{3}} = \\frac{\\partial}{\\partial u_{3}} (-3.4\\,u_{1} + 3.8\\,u_{2} - 0.4\\,u_{3} + 1.25\\,u_{2}^{2}) = -0.4$$\n- $\\frac{\\partial R_{3}}{\\partial u_{3}}$：根据 $R_{3}$ 的表达式，我们对 $u_{3}$ 求导。\n  $$J_{33} = \\frac{\\partial R_{3}}{\\partial u_{3}} = \\frac{\\partial}{\\partial u_{3}} (-3.4\\,u_{2} + 3.8\\,u_{3} - 0.4\\,u_{4} + 1.25\\,u_{3}^{2}) = 3.8 + 2.5\\,u_{3}$$\n- $\\frac{\\partial R_{4}}{\\partial u_{3}}$：根据 $R_{4}$ 的表达式，我们对 $u_{3}$ 求导。\n  $$J_{43} = \\frac{\\partial R_{4}}{\\partial u_{3}} = \\frac{\\partial}{\\partial u_{3}} (-3.4\\,u_{3} + 3.8\\,u_{4} + 1.25\\,u_{4}^{2}) = -3.4$$\n\n我们在给定的迭代值 $\\mathbf{u}^{(0)} = [0.8,\\,0.5,\\,0.2,\\,0.1]^{\\top}$ 处计算此列。唯一依赖于 $\\mathbf{u}^{(0)}$ 的分量是 $J_{33}$，它依赖于 $u_{3}^{(0)}=0.2$。\n$J_{13} = 0$\n$J_{23} = -0.4$\n$J_{33} = 3.8 + 2.5 \\times 0.2 = 3.8 + 0.5 = 4.3$\n$J_{43} = -3.4$\n因此，雅可比矩阵的解析第三列为 $\\mathbf{J}(:,3) = [0, -0.4, 4.3, -3.4]^{\\top}$。\n\n该列的稀疏模式（仅在行 $i=2,3,4$ 有非零项）与雅可比矩阵的三对角结构一致，该结构源于一维有限体积法离散化的最近邻模板。导数 $\\frac{\\partial R_{i}}{\\partial u_{j}}$ 仅在 $j \\in \\{i-1, i, i+1\\}$ 时非零。对于列 $j=3$，这意味着非零项仅出现在行 $i \\in \\{2, 3, 4\\}$。\n\n**2. 有限差分雅可比矩阵列组装**\n第三列的中心有限差分近似由下式给出：\n$$\n\\mathbf{J}_{\\mathrm{FD}}(:,3) = \\frac{\\mathbf{R}(\\mathbf{u}^{(0)} + h\\,\\mathbf{e}_{3}) - \\mathbf{R}(\\mathbf{u}^{(0)} - h\\,\\mathbf{e}_{3})}{2\\,h}\n$$\n导数 $f'(x)$ 的中心差分近似的泰勒级数展开为 $f'(x) = \\frac{f(x+h) - f(x-h)}{2h} - \\frac{h^2}{6}f'''(x) - O(h^4)$。如果函数的三阶及更高阶导数为零，则该近似是精确的。对于任意2次或更低次的多项式，这一点是成立的。\n\n让我们考察每个残差分量 $R_{i}$ 关于变量 $u_{3}$ 的函数形式：\n- $R_{1}(\\mathbf{u})$ 与 $u_{3}$ 无关，即关于 $u_{3}$ 的0次多项式。\n- $R_{2}(\\mathbf{u})$ 关于 $u_{3}$ 是线性的，即关于 $u_{3}$ 的1次多项式。\n- $R_{3}(\\mathbf{u})$ 关于 $u_{3}$ 是二次的，即关于 $u_{3}$ 的2次多项式。\n- $R_{4}(\\mathbf{u})$ 关于 $u_{3}$ 是线性的，即关于 $u_{3}$ 的1次多项式。\n\n对于所有的 $i \\in \\{1,2,3,4\\}$，三阶导数 $\\frac{\\partial^3 R_{i}}{\\partial u_{3}^{3}}$ 均为零。因此，中心差分公式提供了导数的精确值，而不是一个近似值。截断误差为零。\n因此，$\\mathbf{J}_{\\mathrm{FD}}(:,3) = \\mathbf{J}(:,3)$。\n$$\n\\mathbf{J}_{\\mathrm{FD}}(:,3) = \\begin{pmatrix} 0 \\\\ -0.4 \\\\ 4.3 \\\\ -3.4 \\end{pmatrix}\n$$\n\n**欧几里得范数的计算**\n最后一步是计算有限差分雅可比矩阵列与解析雅可比矩阵列之差的欧几里得二范数。\n差向量为：\n$$\n\\mathbf{J}_{\\mathrm{FD}}(:,3) - \\mathbf{J}(:,3) = \\begin{pmatrix} 0 \\\\ -0.4 \\\\ 4.3 \\\\ -3.4 \\end{pmatrix} - \\begin{pmatrix} 0 \\\\ -0.4 \\\\ 4.3 \\\\ -3.4 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\end{pmatrix}\n$$\n零向量的欧几里得范数为：\n$$\n\\left\\| \\mathbf{J}_{\\mathrm{FD}}(:,3) - \\mathbf{J}(:,3) \\right\\|_{2} = \\sqrt{0^{2} + 0^{2} + 0^{2} + 0^{2}} = 0\n$$",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "当我们将问题规模扩展到实际工程应用中的数百万甚至数十亿网格时，雅可比矩阵的计算效率成为决定 CFD 求解器性能的关键瓶颈。幸运的是，由 FVM 局部离散格式产生的雅可比矩阵通常是稀疏的。本练习将向您介绍一种先进的优化技术，即如何利用图论中的“图着色”算法来识别雅可比矩阵中的“结构正交”列，并通过构建种子矩阵实现多列的同时计算，从而显著减少自动微分所需的计算遍数 。",
            "id": "3944962",
            "problem": "考虑网格上某个输运量 $u$ 的稳态标量守恒律，其在控制体 $V_i$ 上的积分形式可写作扩散通量、对流通量和源项的平衡。在计算流体动力学 (CFD) 中，使用有限体积法 (FVM)，控制体 $i$ 的半离散残差为 $R_i(u)=0$，对于 $n$ 个控制体，全局残差向量为 $R(u)\\in\\mathbb{R}^n$。组装后得到的代数系统为 $R(u)=0$。当使用 Newton 型方法求解该系统时，必须对雅可比矩阵 $J(u)=\\partial R/\\partial u\\in\\mathbb{R}^{n\\times n}$ 进行求值。在自动微分 (AD) 中，通常通过方向导数 $J(u)s$ 来计算雅可比矩阵的列，其中 $s\\in\\mathbb{R}^n$ 是一个种子向量。如果逐列计算，AD 的遍数将等于 $n$。\n\n你的任务是推导并实现一个基于图着色的种子矩阵，该矩阵允许同时计算多个雅可比矩阵列，并量化 AD 遍数的减少量。请使用符合背景的基本原理：从 FVM 控制体平衡和线性化出发，推导出由网格邻接性引起的雅可比矩阵稀疏性。然后构建列交集图并执行着色。\n\n定义和要求：\n\n- 令 $J\\in\\mathbb{R}^{n\\times n}$ 表示状态 $u$ 处的雅可比矩阵。如果存在某行 $i$ 使得 $J_{ij}\\neq 0$ 和 $J_{ik}\\neq 0$ 同时成立，则称 $J$ 的第 $j$ 列和第 $k$ 列相交。列交集图 $G=(V,E)$ 的顶点集 $V=\\{0,1,\\dots,n-1\\}$ 对应于雅可比矩阵的列，其无向边集为 $E=\\{\\{j,k\\}\\mid \\text{列 } j \\text{ 和 } k \\text{ 相交}\\}$。\n- $G$ 的一个正常着色为每个列 $j$ 分配一个颜色索引 $c(j)\\in\\{0,1,\\dots,q-1\\}$，使得相邻顶点具有不同的颜色。共享相同颜色的列是结构上正交的，这意味着 $J$ 的任何一行在这些列中至多只有一个非零元。\n- 种子矩阵 $S\\in\\mathbb{R}^{n\\times q}$ 定义为 $S_{j,c(j)}=1$ 且当 $c\\neq c(j)$ 时 $S_{j,c}=0$。使用 $S$ 的第 $c$ 列作为种子向量进行单次 AD 计算，可以得到 $J s_c$，它无重叠地聚合了所有共享颜色 $c$ 的结构正交列。因此，所需的 AD 遍数等于颜色数 $q$。AD 遍数的减少量为 $n-q$。\n\n仅使用此基本原理，根据 FVM 模板所蕴含的雅可比矩阵稀疏性推导出 $G$ 的构造方法，并通过图着色组装种子矩阵 $S$。然后，实现一个程序，该程序为以下测试套件计算 $G$，按顶点度数降序执行确定性贪心着色算法，组装 $S$，并报告减少量 $n-q$。在您的推导中，所有符号必须用 LaTeX 表示。\n\n测试套件和雅可比稀疏性规范：\n\n- 案例 1（一维网格，理想情况）：$n=10$ 个控制体排列在一条均匀的线上，两端为 Dirichlet 边界条件。残差计算对扩散项使用标准的二阶中心差分，对恒定速度下的对流项使用一阶迎风线性化，这为内部行产生了一个三对角模板。具体来说，对于行索引 $i\\in\\{1,2,\\dots,n-2\\}$，非零列索引为 $\\{i-1,i,i+1\\}$；对于边界行 $i\\in\\{0,n-1\\}$，唯一的非零元在第 $i$ 列。\n- 案例 2（二维结构化网格）：在 $4\\times 4$ 网格上的 $n=16$ 个控制体，具有非周期性边界，采用五点拉普拉斯模板（仅扩散）。对于每个内部网格单元，其对应行中的非零列索引是中心点及其四个网格邻居（北、南、东、西）（如果这些邻居存在）；边界行根据其位置有较少的邻居。\n- 案例 3（密集耦合边缘情况）：$n=5$，雅可比矩阵为全密集矩阵，即所有元素 $J_{ij}$ 在结构上都是非零的。这模拟了一个依赖于每个自由度的全局源项。\n- 案例 4（小尺寸边界情况）：$n=2$ 的一维网格，具有 Dirichlet 边界，模板规则与案例 1 相同。由于没有内部单元，这会产生一个对角的雅可比模式。\n\n程序要求：\n\n- 直接根据指定的雅可比非零模式为每个案例构建列交集图 $G$。然后，使用确定性贪心算法计算正常着色，该算法按度数降序对顶点排序，并为每个顶点分配其已着色邻居未使用的最小可用颜色。\n- 使用着色结果为每个案例组装种子矩阵 $S\\in\\mathbb{R}^{n\\times q}$。\n- 对于每个案例，计算 AD 遍数的整数减少量 $n-q$。\n- 最终输出格式：您的程序应生成单行输出，其中包含四个减少量，格式为方括号括起来的逗号分隔列表，并按上述案例顺序排列，例如，“[$r_1$,$r_2$,$r_3$,$r_4$]”。这些输出不涉及物理单位；它们是纯整数。\n\n您的推导和实现必须是通用的和自包含的，不依赖外部文件。角度和物理单位不适用。所有数学公式都用 LaTeX 表示。",
            "solution": "这个问题的核心在于优化雅可比矩阵 $J(u) = \\partial R/\\partial u$ 的计算，该矩阵产生于非线性代数方程组 $R(u)=0$ 的线性化。这个方程组本身源于对稳态标量守恒律的有限体积法 (FVM) 离散化。优化策略包括通过利用其稀疏模式来压缩雅可比矩阵的计算，这是一种与自动微分 (AD) 结合使用时尤其有效的技术。这种压缩是通过识别可同时计算的“结构上正交”的列组来实现的。这种分组通过图着色来形式化。\n\n首先，我们建立 FVM 离散化与雅可比矩阵稀疏性之间的关系。在控制体 $V_i$ 上的稳态标量守恒律的积分形式由下式给出：\n$$\n\\oint_{\\partial V_i} \\mathbf{F}(u) \\cdot \\mathbf{n} \\, dS = \\int_{V_i} Q(u) \\, dV\n$$\n其中 $u$ 是守恒标量，$\\mathbf{F}$ 是通量向量（包含对流和扩散分量），$Q$ 是源项。FVM 将此方程离散化，为每个控制体 $i$ 生成一个代数残差方程：\n$$\nR_i(u) = \\sum_{f \\in \\text{faces}(V_i)} \\mathbf{F}_f \\cdot \\mathbf{n}_f S_f - Q_i V_i = 0\n$$\n在此表达式中，穿过面 $f$ 的数值通量 $\\mathbf{F}_f$ 和单元平均源项 $Q_i$ 是围绕单元 $i$ 的一个小的局部单元邻域中解值 $u_j$ 的代数函数。这个邻域由 FVM 重构和通量格式决定，构成了计算模板。令 $N(i)$ 为计算残差 $R_i$ 所需的解值 $u_j$ 所在的单元（包括 $i$ 本身）的索引集。因此，单元 $i$ 的残差仅是这些局部变量的函数：$R_i(u) = R_i(\\{u_j \\mid j \\in N(i)\\})$。\n\n雅可比矩阵的元素由 $J_{ij} = \\partial R_i / \\partial u_j$ 给出。由于残差的局部依赖性，雅可比矩阵元素 $J_{ij}$ 只有在单元 $j$ 中的解直接影响单元 $i$ 中的残差时，才可能在结构上非零。这当且仅当 $j \\in N(i)$ 时成立。因此，雅可比矩阵第 $i$ 行的非零列索引集合恰好是模板索引集 $N(i)$。$J$ 的稀疏模式是网格连通性和所选数值格式的直接反映。\n\n接下来，我们构建列交集图 $G=(V, E)$。顶点 $V=\\{0, 1, \\dots, n-1\\}$ 对应于雅可比矩阵 $J$ 的列。两个顶点 $j$ 和 $k$ 之间存在无向边 $\\{j, k\\} \\in E$ 当且仅当它们对应的列相交。根据定义，如果至少存在一行 $i$，使得 $J_{ij}$ 和 $J_{ik}$ 在结构上都非零，则列 $j$ 和 $k$ 相交。数学上表示为：\n$$\n\\{j, k\\} \\in E \\iff \\exists i \\in \\{0, 1, \\dots, n-1\\} \\text{ such that } j \\in N(i) \\text{ and } k \\in N(i)\n$$\n这个条件为构造 $G$ 提供了一个直接的算法。我们可以初始化一个全零的 $n \\times n$ 邻接矩阵来表示 $G$。然后，对于雅可比矩阵的每一行 $i$，我们确定其非零列索引集 $N(i)$。对于该集合内的每一对不同的列 $\\{j, k\\}$，我们在 $G$ 中它们之间放置一条边。\n\n第三步是获得 $G$ 的一个正常着色。着色为每个顶点 $j$ 分配一个整数颜色 $c(j) \\in \\{0, 1, \\dots, q-1\\}$，使得没有两个相邻的顶点共享相同的颜色。关键的见解是，被分配相同颜色的列保证是结构上正交的。也就是说，如果对于 $j \\neq k$ 有 $c(j) = c(k)$，那么不存在任何行 $i$ 使得 $J_{ij}$ 和 $J_{ik}$ 都非零。这个性质使我们能够“压缩”雅可比矩阵的计算。所有相同颜色的列可以在一次 AD 计算中同时求出。\n\n我们构造一个种子矩阵 $S \\in \\mathbb{R}^{n \\times q}$，其中 $q$ 是使用的颜色数。$S$ 的元素定义为 $S_{j,c(j)} = 1$ 且当 $c \\neq c(j)$ 时 $S_{j,c} = 0$。$S$ 的每一列（例如 $s_\\kappa$）都是一次 AD 计算的种子向量。乘积 $p_\\kappa = J s_\\kappa$ 计算一个方向导数。该乘积的第 $i$ 个分量是 $(p_\\kappa)_i = \\sum_{j=0}^{n-1} J_{ij}(s_\\kappa)_j = \\sum_{j | c(j)=\\kappa} J_{ij}$。由于结构正交性，对于任何给定的行 $i$，此求和中最多只有一项是非零的。因此，结果向量 $p_\\kappa$ 的每个分量都包含来自某个颜色为 $\\kappa$ 的列的唯一非零项。通过执行 $q$ 次这样的 AD 计算（每种颜色一次），我们得到向量 $\\{p_0, p_1, \\dots, p_{q-1}\\}$，从中可以无损地恢复整个雅可比矩阵 $J$。AD 的遍数从 $n$ 减少到 $q$。总减少量为 $n-q$。\n\n问题指定了一个确定性贪心着色算法：\n1. 顶点主要按其在 $G$ 中的度数降序排列，度数相同时按顶点索引升序排列。\n2. 算法按此特定顺序遍历顶点。对于每个顶点 $v$，它会分配一个当前未被其任何已着色邻居使用的最小非负整数颜色。\n\n我们将此过程应用于指定的测试案例。\n\n案例 1：$n=10$，一维网格。内部行 $i$ 的模板是 $\\{i-1, i, i+1\\}$。这意味着如果列 $j$ 和 $k$ 同时出现在某行的模板中，它们在 $G$ 中就是相连的，这种情况发生在它们的索引距离 $|j-k| \\leq 2$ 时。该图是路径图的平方 $P_{10}^2$。贪心着色算法找到一个使用 $q=3$ 种颜色的着色方案。减少量为 $n-q = 10-3 = 7$。\n\n案例 2：$n=16$，$4 \\times 4$ 二维网格。五点模板意味着列交集图 $G$ 连接任意两个在网格上对应单元的曼哈顿距离为 1 或 2 的顶点。对于这样的图，贪心算法会找到一个使用 $q=5$ 种颜色的着色方案。这是二维网格上距离-2图的一个已知结果。减少量为 $n-q = 16-5 = 11$。\n\n案例 3：$n=5$，密集雅可比矩阵。由于 $J$ 的所有元素都非零，任何行 $i$ 的非零列集合都是 $\\{0, 1, 2, 3, 4\\}$。因此，每一对列 $\\{j, k\\}$ 都相交。得到的图 $G$ 是完全图 $K_5$。一个完全图 $K_n$ 需要 $n$ 种颜色，所以 $q=5$。减少量为 $n-q = 5-5 = 0$，表示无法进行压缩。\n\n案例 4：$n=2$，具有边界条件的一维网格。行 $i=0$ 和 $i=1$ 都是边界行，其模板分别为 $\\{0\\}$ 和 $\\{1\\}$。雅可比矩阵在结构上是对角的。对于每一行，非零列索引的集合只包含一个元素。无法形成列对，所以图 $G$ 没有边。所有顶点都可以被赋予相同的颜色。因此，$q=1$。减少量为 $n-q = 2-1 = 1$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef get_sparsity_pattern(case_id: int):\n    \"\"\"\n    Generates the Jacobian sparsity pattern for a given test case.\n    The pattern is a list of lists, where sparsity[i] contains the\n    column indices of non-zero entries in row i.\n    \"\"\"\n    if case_id == 1:\n        n = 10\n        sparsity = []\n        # Dirichlet BC at i=0\n        sparsity.append([0])\n        # Interior rows with tridiagonal stencil\n        for i in range(1, n - 1):\n            sparsity.append([i - 1, i, i + 1])\n        # Dirichlet BC at i=n-1\n        sparsity.append([n - 1])\n        return n, sparsity\n    \n    elif case_id == 2:\n        n = 16\n        grid_dim = 4\n        sparsity = []\n        for i in range(n):\n            r, c = divmod(i, grid_dim)\n            neighbors = [i]\n            # North neighbor\n            if r  0: neighbors.append(i - grid_dim)\n            # South neighbor\n            if r  grid_dim - 1: neighbors.append(i + grid_dim)\n            # West neighbor\n            if c  0: neighbors.append(i - 1)\n            # East neighbor\n            if c  grid_dim - 1: neighbors.append(i + 1)\n            sparsity.append(sorted(neighbors))\n        return n, sparsity\n        \n    elif case_id == 3:\n        n = 5\n        # Fully dense Jacobian\n        sparsity = [list(range(n)) for _ in range(n)]\n        return n, sparsity\n        \n    elif case_id == 4:\n        n = 2\n        # 1D mesh with n=2 means both are boundary cells\n        sparsity = []\n        # Dirichlet BC at i=0\n        sparsity.append([0])\n        # Dirichlet BC at i=1\n        sparsity.append([1])\n        return n, sparsity\n        \n    else:\n        raise ValueError(\"Invalid case ID\")\n\ndef solve_case(n: int, sparsity: list):\n    \"\"\"\n    Constructs the column intersection graph, performs greedy coloring,\n    and computes the reduction in AD passes.\n    \"\"\"\n    # 1. Build the adjacency matrix for the column intersection graph G\n    adj_matrix = np.zeros((n, n), dtype=int)\n    for row_non_zeros in sparsity:\n        # For each row, all pairs of columns with non-zeros intersect\n        for i in range(len(row_non_zeros)):\n            for j in range(i + 1, len(row_non_zeros)):\n                u, v = row_non_zeros[i], row_non_zeros[j]\n                adj_matrix[u, v] = 1\n                adj_matrix[v, u] = 1\n\n    # 2. Perform deterministic greedy coloring\n    \n    # Calculate vertex degrees\n    degrees = np.sum(adj_matrix, axis=1)\n    \n    # Sort vertices by degree (descending) and then index (ascending)\n    # The key for sorting is a tuple (-degree, index)\n    sorted_vertices = sorted(range(n), key=lambda v: (-degrees[v], v))\n    \n    # Initialize colors\n    colors = [-1] * n\n    \n    num_colors = 0\n    for v in sorted_vertices:\n        # Find colors of already-colored neighbors\n        neighbor_colors = set()\n        for u in range(n):\n            if adj_matrix[v, u] == 1 and colors[u] != -1:\n                neighbor_colors.add(colors[u])\n        \n        # Find the smallest available color (first-fit)\n        c = 0\n        while c in neighbor_colors:\n            c += 1\n        colors[v] = c\n        \n        if c + 1  num_colors:\n            num_colors = c + 1\n            \n    # The number of colors used is q\n    if n == 0:\n        q = 0\n    else:\n        q = num_colors\n        \n    # 3. Compute reduction\n    reduction = n - q\n    return reduction\n\ndef solve():\n    \"\"\"\n    Runs all test cases and prints the results in the required format.\n    \"\"\"\n    test_cases = [1, 2, 3, 4]\n    results = []\n    \n    for case_id in test_cases:\n        n, sparsity = get_sparsity_pattern(case_id)\n        reduction = solve_case(n, sparsity)\n        results.append(reduction)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}