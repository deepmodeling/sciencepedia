{
    "hands_on_practices": [
        {
            "introduction": "The core of land surface modeling is finding the surface temperature, $T_s$, that satisfies the conservation of energy, as all major fluxes—radiation, sensible heat, latent heat, and ground heat—depend on it. This practice provides hands-on experience in implementing the full surface energy balance from first principles. By using a numerical solver like the Newton method, you will learn how to find the equilibrium skin temperature that closes the energy budget under diverse environmental conditions, a fundamental skill in climate modeling .",
            "id": "4097707",
            "problem": "You are tasked with implementing a physically consistent computation of the land surface energy balance at midday for multiple prescribed scenarios and solving for the unknown land surface skin temperature using an iterative Newton method. The calculation must be rooted in fundamental physical laws and widely used parameterizations in numerical weather prediction and climate modeling.\n\nStart from the conservation of energy for a control volume at the land surface, which states that the net radiation equals the sum of the turbulent sensible and latent heat fluxes plus the conductive ground heat flux:\n$$\nR_n = H + LE + G.\n$$\nThe goal is to find the land surface skin temperature $T_s$ that satisfies this balance given meteorological inputs and surface parameters.\n\nUse the following physical bases and parameterizations, without invoking any shortcuts beyond these fundamentals:\n\n- Net radiation $R_n$ is the sum of net shortwave and net longwave radiation:\n$$\nR_n(T_s) = (1 - \\alpha) S_{\\downarrow} + L_{\\downarrow} - \\epsilon \\sigma T_s^4,\n$$\nwhere $\\alpha$ is surface albedo, $S_{\\downarrow}$ is downward shortwave irradiance, $L_{\\downarrow}$ is downward longwave irradiance, $\\epsilon$ is surface emissivity, and $\\sigma$ is the Stefan–Boltzmann constant.\n\n- Turbulent sensible heat flux $H$ parameterized via bulk transfer and neutral Monin–Obukhov similarity:\n$$\nH(T_s) = \\rho c_p \\frac{T_s - T_a}{r_{ah}},\n$$\nwhere $\\rho$ is air density, $c_p$ is specific heat of air at constant pressure, $T_a$ is air temperature, and $r_{ah}$ is the aerodynamic resistance for heat under neutral stability.\n\n- Turbulent latent heat flux $LE$ using a bulk formulation with aerodynamic plus surface resistance:\n$$\nLE(T_s) = \\rho L_v \\frac{q_{sat}(T_s) - q_a}{r_{ah} + r_s},\n$$\nwhere $L_v$ is the latent heat of vaporization, $q_{sat}(T_s)$ is saturation specific humidity at the surface temperature, $q_a$ is air specific humidity (diagnosed from relative humidity), and $r_s$ is the surface (stomatal) resistance.\n\n- Ground heat flux $G$ approximated by Fourier heat conduction across a thin upper soil layer:\n$$\nG(T_s) = \\frac{k_g}{d_g} (T_s - T_d),\n$$\nwhere $k_g$ is soil thermal conductivity, $d_g$ is the thickness of the upper soil layer, and $T_d$ is the temperature at the bottom of that layer.\n\nDerive all necessary intermediate quantities from fundamental definitions:\n\n- Air density from the Ideal Gas Law:\n$$\n\\rho = \\frac{p}{R_d T_a},\n$$\nwhere $p$ is air pressure and $R_d$ is the specific gas constant for dry air.\n\n- Aerodynamic resistance under neutral conditions using the logarithmic wind profile:\n$$\nr_{ah} = \\frac{\\ln\\left(\\frac{z_{ref} - d}{z_{0m}}\\right) \\cdot \\ln\\left(\\frac{z_{ref} - d}{z_{0h}}\\right)}{\\kappa^2 U},\n$$\nwhere $z_{ref}$ is the reference height of measurements, $d$ is the zero-plane displacement height, $z_{0m}$ and $z_{0h}$ are roughness lengths for momentum and heat, $\\kappa$ is the von Kármán constant, and $U$ is wind speed.\n\n- Saturation vapor pressure $e_{sat}(T)$ over water using the Tetens relation applied to temperature in degrees Celsius:\n$$\ne_{sat}(T) = a \\exp\\left(\\frac{b \\, T_C}{c + T_C}\\right),\n$$\nwith $T_C = T - 273.15$, $a = 611.2 \\,\\text{Pa}$, $b = 17.62$, $c = 243.12 \\,\\text{°C}$.\n\n- Specific humidity from vapor pressure:\n$$\nq = \\frac{\\epsilon_{mw} \\, e}{p - (1 - \\epsilon_{mw}) e},\n$$\nwhere $\\epsilon_{mw} = 0.622$ is the ratio of the molar masses of water to dry air, and $e$ is vapor pressure. Compute air specific humidity $q_a$ from relative humidity $\\mathrm{RH}$ by $e_a = \\mathrm{RH} \\cdot e_{sat}(T_a)$ and inserting $e_a$ into the specific humidity formula. Compute saturation specific humidity $q_{sat}(T_s)$ by inserting $e_{sat}(T_s)$ into the same formula.\n\nYou must find $T_s$ that solves\n$$\nF(T_s) \\equiv R_n(T_s) - H(T_s) - LE(T_s) - G(T_s) = 0.\n$$\nImplement a Newton method for $T_s$ with an initial guess $T_s^{(0)} = T_a$, a maximum of $N_{max} = 50$ iterations, and stopping criteria requiring both a flux residual magnitude $\\left|F(T_s)\\right|  \\tau_F$ and a temperature increment magnitude $\\left|\\Delta T_s\\right|  \\tau_T$, where $\\tau_F = 10^{-2}$ in $\\mathrm{W\\,m^{-2}}$ and $\\tau_T = 10^{-6}$ in $\\mathrm{K}$. If a raw Newton step is excessively large, you may damp it, but you must remain within physically plausible bounds.\n\nConstants to use:\n- Stefan–Boltzmann constant $\\sigma = 5.670374419 \\times 10^{-8}$ in $\\mathrm{W\\,m^{-2}\\,K^{-4}}$,\n- Specific heat $c_p = 1004$ in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\n- Latent heat of vaporization $L_v = 2.5 \\times 10^{6}$ in $\\mathrm{J\\,kg^{-1}}$,\n- Dry air gas constant $R_d = 287$ in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$,\n- von Kármán constant $\\kappa = 0.4$,\n- Molecular weight ratio $\\epsilon_{mw} = 0.622$.\n\nUnits and output requirements:\n- All fluxes $R_n$, $H$, $LE$, and $G$ must be reported in $\\mathrm{W\\,m^{-2}}$.\n- The skin temperature $T_s$ must be reported in $\\mathrm{K}$.\n- Express every reported numerical value rounded to three decimals.\n- Angles are not used, so no angle unit is needed.\n- Relative humidity $\\mathrm{RH}$ must be treated as a unitless decimal fraction.\n\nTest suite:\nUse the following prescribed cases. Each case defines $(p, S_{\\downarrow}, L_{\\downarrow}, \\alpha, \\epsilon, T_a, \\mathrm{RH}, U, z_{ref}, d, z_{0m}, z_{0h}, r_s, T_d, k_g, d_g)$:\n\n- Case A (vegetated cropland, midday, moderate wind, mid-latitude): $\\left(101325, 800, 400, 0.20, 0.97, 300, 0.50, 3.0, 10.0, 0.536, 0.080, 0.008, 100, 298, 1.0, 0.10\\right)$.\n- Case B (bare dry soil, strong insolation, low humidity): $\\left(101325, 1000, 350, 0.30, 0.95, 310, 0.20, 5.0, 2.0, 0.0, 0.010, 0.001, 500, 305, 0.8, 0.05\\right)$.\n- Case C (snow-covered surface, high albedo, cold, high altitude): $\\left(80000, 500, 250, 0.85, 0.99, 270, 0.90, 4.0, 2.0, 0.0, 0.001, 0.001, 0, 268, 0.5, 0.20\\right)$.\n- Case D (humid tropical canopy, tall roughness, very low wind): $\\left(101325, 900, 450, 0.12, 0.98, 302, 0.80, 0.1, 30.0, 13.400, 2.000, 0.200, 50, 300, 1.5, 0.10\\right)$.\n\nFinal output format:\nYour program should produce a single line of output containing a JSON-like nested list where each element corresponds to one test case in the order A, B, C, D, and each case’s element is the list $[R_n, H, LE, G, T_s]$ with all values rounded to three decimals, like\n[[R_n^A, H^A, LE^A, G^A, T_s^A],[R_n^B, H^B, LE^B, G^B, T_s^B],[R_n^C, H^C, LE^C, G^C, T_s^C],[R_n^D, H^D, LE^D, G^D, T_s^D]].\nPrint exactly this single line, with no additional text.",
            "solution": "The problem has been validated and is determined to be sound. It is scientifically grounded in the principles of land-surface-atmosphere interactions, well-posed with a clear objective and sufficient data, and formulated objectively using standard parameterizations from atmospheric science and numerical weather prediction. All provided parameters and constants are physically realistic and consistent. Therefore, a solution will be provided.\n\nThe core of the problem is to find the land surface skin temperature, $T_s$, that satisfies the surface energy balance equation:\n$$\nF(T_s) = R_n(T_s) - H(T_s) - LE(T_s) - G(T_s) = 0\n$$\nThis is a root-finding problem for a single variable, $T_s$. We are instructed to use the Newton method, an iterative scheme defined by the update rule:\n$$\nT_s^{(k+1)} = T_s^{(k)} - \\frac{F(T_s^{(k)})}{F'(T_s^{(k)})}\n$$\nwhere $T_s^{(k)}$ is the estimate of the root at iteration $k$, and $F'(T_s)$ is the first derivative of the function $F(T_s)$ with respect to $T_s$.\n\nThe solution procedure involves the following steps:\n1.  For each test case, calculate all quantities that are independent of $T_s$.\n2.  Implement the Newton method iterative loop to solve for $T_s$. This requires the analytical derivation of the function $F(T_s)$ and its derivative $F'(T_s)$.\n3.  Once the converged value of $T_s$ is found, use it to compute the final values of the energy balance components: $R_n$, $H$, $LE$, and $G$.\n\nLet's define the function $F(T_s)$ and its derivative $F'(T_s)$. The function $F(T_s)$ is constructed from the given parameterizations:\n$$\nF(T_s) = \\left( (1 - \\alpha) S_{\\downarrow} + L_{\\downarrow} - \\epsilon \\sigma T_s^4 \\right) - \\left( \\rho c_p \\frac{T_s - T_a}{r_{ah}} \\right) - \\left( \\rho L_v \\frac{q_{sat}(T_s) - q_a}{r_{ah} + r_s} \\right) - \\left( \\frac{k_g}{d_g} (T_s - T_d) \\right) = 0\n$$\n\nTo find the derivative $F'(T_s) = \\frac{dF}{dT_s}$, we differentiate each term with respect to $T_s$:\n\n1.  **Net Radiation Derivative**: The shortwave component and downward longwave radiation are constant with respect to $T_s$. Only the outgoing longwave radiation depends on $T_s$.\n    $$\n    \\frac{d R_n}{d T_s} = \\frac{d}{d T_s} \\left( (1 - \\alpha) S_{\\downarrow} + L_{\\downarrow} - \\epsilon \\sigma T_s^4 \\right) = -4 \\epsilon \\sigma T_s^3\n    $$\n\n2.  **Sensible Heat Flux Derivative**:\n    $$\n    \\frac{d H}{d T_s} = \\frac{d}{d T_s} \\left( \\rho c_p \\frac{T_s - T_a}{r_{ah}} \\right) = \\frac{\\rho c_p}{r_{ah}}\n    $$\n\n3.  **Ground Heat Flux Derivative**:\n    $$\n    \\frac{d G}{d T_s} = \\frac{d}{d T_s} \\left( \\frac{k_g}{d_g} (T_s - T_d) \\right) = \\frac{k_g}{d_g}\n    $$\n\n4.  **Latent Heat Flux Derivative**: This is the most complex term as $q_{sat}$ is a non-linear function of $T_s$.\n    $$\n    \\frac{d (LE)}{d T_s} = \\frac{d}{d T_s} \\left( \\rho L_v \\frac{q_{sat}(T_s) - q_a}{r_{ah} + r_s} \\right) = \\frac{\\rho L_v}{r_{ah} + r_s} \\frac{d q_{sat}}{d T_s}\n    $$\n    We must find $\\frac{d q_{sat}}{d T_s}$ using the chain rule: $\\frac{d q_{sat}}{d T_s} = \\frac{\\partial q_{sat}}{\\partial e_{sat}} \\frac{d e_{sat}}{d T_s}$.\n\n    First, we find $\\frac{d e_{sat}}{d T_s}$ from the Tetens formula, $e_{sat}(T) = a \\exp\\left(\\frac{b T_C}{c + T_C}\\right)$, where $T_C = T_s - 273.15$.\n    $$\n    \\frac{d e_{sat}}{d T_s} = a \\exp\\left(\\frac{b(T_s - 273.15)}{c + (T_s - 273.15)}\\right) \\cdot \\frac{d}{d T_s}\\left(\\frac{b(T_s - 273.15)}{c + (T_s - 273.15)}\\right)\n    $$\n    Applying the quotient rule to the exponent term's derivative:\n    $$\n    \\frac{d e_{sat}}{d T_s} = e_{sat}(T_s) \\cdot \\frac{b c}{(c + (T_s - 273.15))^2}\n    $$\n\n    Next, we find $\\frac{\\partial q_{sat}}{\\partial e_{sat}}$ from the specific humidity definition, $q = \\frac{\\epsilon_{mw} e}{p - (1-\\epsilon_{mw})e}$.\n    Using the quotient rule:\n    $$\n    \\frac{\\partial q}{\\partial e} = \\frac{\\epsilon_{mw}(p - (1-\\epsilon_{mw})e) - \\epsilon_{mw}e(-(1-\\epsilon_{mw}))}{(p - (1-\\epsilon_{mw})e)^2} = \\frac{\\epsilon_{mw} p}{(p - (1-\\epsilon_{mw})e)^2}\n    $$\n    Substituting $e = e_{sat}(T_s)$, we get $\\frac{\\partial q_{sat}}{\\partial e_{sat}}$.\n\n    Combining these, the derivative of the latent heat flux is:\n    $$\n    \\frac{d (LE)}{d T_s} = \\frac{\\rho L_v}{r_{ah} + r_s} \\left( \\frac{\\epsilon_{mw} p}{(p - (1-\\epsilon_{mw})e_{sat}(T_s))^2} \\right) \\left( e_{sat}(T_s) \\frac{b c}{(c + (T_s - 273.15))^2} \\right)\n    $$\n\nFinally, the total derivative $F'(T_s) = \\frac{d R_n}{d T_s} - \\frac{d H}{d T_s} - \\frac{d (LE)}{d T_s} - \\frac{d G}{d T_s}$ is:\n$$\nF'(T_s) = -4 \\epsilon \\sigma T_s^3 - \\frac{\\rho c_p}{r_{ah}} - \\frac{k_g}{d_g} - \\frac{d (LE)}{d T_s}\n$$\nAll terms in $F'(T_s)$ are negative (since $\\frac{d(LE)}{dT_s}  0$), ensuring that $F(T_s)$ is a strictly monotonically decreasing function. This guarantees a unique root and the stability of the Newton method.\n\nThe algorithm proceeds as follows for each test case:\n1.  Define all physical and case-specific constants. The given relative humidity, $\\mathrm{RH}$, is used as a decimal fraction (e.g., $0.50$ for $50\\%$).\n2.  Calculate constant parameters: air density $\\rho$ and aerodynamic resistance $r_{ah}$. Calculate air specific humidity $q_a$ from the given $T_a$ and $\\mathrm{RH}$.\n3.  Initialize the iteration with $T_s^{(0)} = T_a$.\n4.  Loop for a maximum of $N_{max}=50$ iterations:\n    a. Calculate all terms of $F(T_s)$ and $F'(T_s)$ using the current $T_s^{(k)}$.\n    b. Calculate the update step $\\Delta T_s = -F(T_s^{(k)}) / F'(T_s^{(k)})$.\n    c. To improve stability, the step is damped if it is too large: $\\Delta T_s \\leftarrow \\text{sign}(\\Delta T_s) \\cdot \\min(|\\Delta T_s|, 5.0\\,\\text{K})$.\n    d. Update the temperature: $T_s^{(k+1)} = T_s^{(k)} + \\Delta T_s$.\n    e. Check for convergence: if $|F(T_s^{(k+1)})|  \\tau_F = 10^{-2}\\,\\text{W}\\,\\text{m}^{-2}$ and $|\\Delta T_s|  \\tau_T = 10^{-6}\\,\\text{K}$, terminate the loop.\n5.  After the loop terminates, use the final $T_s$ to recompute the final values of fluxes $R_n$, $H$, $LE$, and $G$.\n6.  Store the list $[R_n, H, LE, G, T_s]$ with values rounded to three decimal places.\n7.  Repeat for all test cases and format the results into the required single-line output.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the surface energy balance for a set of test cases using a Newton method.\n    \"\"\"\n    # Physical Constants\n    SIGMA = 5.670374419e-8  # Stefan–Boltzmann constant (W m^-2 K^-4)\n    CP = 1004.0             # Specific heat of air at constant pressure (J kg^-1 K^-1)\n    LV = 2.5e6              # Latent heat of vaporization (J kg^-1)\n    RD = 287.0              # Specific gas constant for dry air (J kg^-1 K^-1)\n    KAPPA = 0.4             # von Kármán constant (-)\n    EPS_MW = 0.622          # Ratio of molar masses of water to dry air (-)\n    \n    # Tetens formula constants\n    A_TETENS = 611.2        # Pa\n    B_TETENS = 17.62        # -\n    C_TETENS = 243.12       # °C\n\n    # Newton method parameters\n    N_MAX = 50\n    TAU_F = 1e-2            # Flux residual tolerance (W m^-2)\n    TAU_T = 1e-6            # Temperature increment tolerance (K)\n    MAX_DT_STEP = 5.0       # Damping for Newton step (K)\n\n    # Test cases: (p, S_down, L_down, alpha, epsilon, Ta, RH, U, z_ref, d, z0m, z0h, rs, Td, kg, dg)\n    test_cases = [\n        (101325, 800, 400, 0.20, 0.97, 300, 0.50, 3.0, 10.0, 0.536, 0.080, 0.008, 100, 298, 1.0, 0.10),\n        (101325, 1000, 350, 0.30, 0.95, 310, 0.20, 5.0, 2.0, 0.0, 0.010, 0.001, 500, 305, 0.8, 0.05),\n        (80000, 500, 250, 0.85, 0.99, 270, 0.90, 4.0, 2.0, 0.0, 0.001, 0.001, 0, 268, 0.5, 0.20),\n        (101325, 900, 450, 0.12, 0.98, 302, 0.80, 0.1, 30.0, 13.400, 2.000, 0.200, 50, 300, 1.5, 0.10),\n    ]\n\n    # --- Helper functions ---\n    def e_sat_func(T_k):\n        \"\"\"Saturation vapor pressure (Pa) from temperature (K) via Tetens.\"\"\"\n        T_c = T_k - 273.15\n        return A_TETENS * np.exp((B_TETENS * T_c) / (C_TETENS + T_c))\n\n    def q_func(e, p):\n        \"\"\"Specific humidity (kg/kg) from vapor pressure (Pa) and air pressure (Pa).\"\"\"\n        return (EPS_MW * e) / (p - (1.0 - EPS_MW) * e)\n\n    def calculate_surface_balance(params):\n        \"\"\"Computes surface energy balance for a single case.\"\"\"\n        p, S_down, L_down, alpha, epsilon, Ta, RH, U, z_ref, d, z0m, z0h, rs, Td, kg, dg = params\n\n        # A. Pre-calculate Ts-independent quantities\n        rho = p / (RD * Ta)\n        if U > 0:\n            rah = (np.log((z_ref - d) / z0m) * np.log((z_ref - d) / z0h)) / (KAPPA**2 * U)\n        else: # Handle zero wind case\n            rah = np.inf\n\n        e_sat_a = e_sat_func(Ta)\n        e_a = RH * e_sat_a\n        qa = q_func(e_a, p)\n        \n        R_net_sw = (1.0 - alpha) * S_down\n\n        # B. Newton Method Iteration\n        Ts = Ta  # Initial guess\n\n        for _ in range(N_MAX):\n            # Calculate F(Ts)\n            R_net_lw = L_down - epsilon * SIGMA * Ts**4\n            Rn = R_net_sw + R_net_lw\n            \n            H = rho * CP * (Ts - Ta) / rah if rah != np.inf else 0.0\n            \n            G = (kg / dg) * (Ts - Td)\n            \n            e_sat_s = e_sat_func(Ts)\n            q_sat_s = q_func(e_sat_s, p)\n            LE = rho * LV * (q_sat_s - qa) / (rah + rs) if (rah + rs) > 0 else 0.0\n            \n            F_Ts = Rn - H - LE - G\n\n            # Calculate F'(Ts)\n            # Derivative of R_net_lw\n            dRn_dTs = -4.0 * epsilon * SIGMA * Ts**3\n            \n            # Derivative of H\n            dH_dTs = rho * CP / rah if rah != np.inf else 0.0\n            \n            # Derivative of G\n            dG_dTs = kg / dg\n            \n            # Derivative of LE\n            Tc_s = Ts - 273.15\n            de_sat_s_dTs = e_sat_s * (B_TETENS * C_TETENS) / (C_TETENS + Tc_s)**2\n            dq_sat_s_des = (EPS_MW * p) / (p - (1.0 - EPS_MW) * e_sat_s)**2\n            dq_sat_s_dTs = dq_sat_s_des * de_sat_s_dTs\n            dLE_dTs = (rho * LV / (rah + rs)) * dq_sat_s_dTs if (rah + rs) > 0 else 0.0\n            \n            F_prime_Ts = dRn_dTs - dH_dTs - dLE_dTs - dG_dTs\n            \n            # Update step with damping\n            delta_Ts = -F_Ts / F_prime_Ts\n            delta_Ts = np.sign(delta_Ts) * min(abs(delta_Ts), MAX_DT_STEP)\n            \n            Ts += delta_Ts\n            \n            if abs(F_Ts)  TAU_F and abs(delta_Ts)  TAU_T:\n                break\n        \n        # C. Post-calculation of final fluxes with converged Ts\n        R_net_lw_final = L_down - epsilon * SIGMA * Ts**4\n        Rn_final = R_net_sw + R_net_lw_final\n        H_final = rho * CP * (Ts - Ta) / rah if rah != np.inf else 0.0\n        G_final = (kg / dg) * (Ts - Td)\n        e_sat_s_final = e_sat_func(Ts)\n        q_sat_s_final = q_func(e_sat_s_final, p)\n        LE_final = rho * LV * (q_sat_s_final - qa) / (rah + rs) if (rah + rs) > 0 else 0.0\n        \n        return [Rn_final, H_final, LE_final, G_final, Ts]\n\n    # --- Main execution loop ---\n    all_results = []\n    for case in test_cases:\n        result = calculate_surface_balance(case)\n        all_results.append(result)\n\n    # --- Format and print output ---\n    results_str = []\n    for res in all_results:\n        # Use a list comprehension to format each number and join with commas\n        res_str = f\"[{','.join([f'{v:.3f}' for v in res])}]\"\n        results_str.append(res_str)\n    \n    final_output = f\"[{','.join(results_str)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "The latent heat flux, $LE$, is a critical component of the energy balance and the hydrological cycle, but its direct calculation requires the unknown surface temperature. The Penman-Monteith formulation elegantly combines the energy balance with aerodynamic principles to express $LE$ using only atmospheric variables. In this exercise, you will derive this cornerstone equation, reinforcing the interplay between energy and mass transfer and providing a tool to analyze how plant physiology, through stomatal resistance $r_s$, controls evapotranspiration .",
            "id": "4097617",
            "problem": "Consider a horizontally homogeneous vegetated land surface represented as a single, well-mixed \"big-leaf\" canopy under steady daytime conditions. The land-surface energy budget is governed by the principle of surface energy balance, $$R = H + LE,$$ where $R$ is the available energy given by $R = R_n - G$, $H$ is the sensible heat flux, and $LE$ is the latent heat flux associated with evaporation and transpiration. The sensible heat flux is described by bulk aerodynamic transfer, $$H = \\rho c_p g_a \\left( T_s - T_a \\right),$$ where $\\rho$ is air density, $c_p$ is the specific heat capacity of air at constant pressure, $g_a$ is the aerodynamic conductance, $T_s$ is the effective canopy surface temperature, and $T_a$ is the air temperature above the canopy. The latent heat flux is linked to the mass transfer of water vapor through the vapor conductance $g_v$ and the near-surface specific humidity difference, and linearization of the saturation vapor pressure about $T_a$ gives $$e_s(T_s) \\approx e_s(T_a) + \\Delta (T_s - T_a),$$ where $e_s$ is the saturation vapor pressure and $\\Delta$ is the slope of the saturation vapor pressure curve at the air temperature. The psychrometric constant is defined by $$\\gamma = \\frac{c_p P}{\\varepsilon \\lambda},$$ where $P$ is atmospheric pressure, $\\varepsilon$ is the ratio of the molecular weight of water vapor to dry air, and $\\lambda$ is the latent heat of vaporization. Vapor Pressure Deficit (VPD) is defined as $$\\mathrm{VPD} = e_s(T_a) - e_a,$$ where $e_a$ is the ambient vapor pressure.\n\nUsing the above principles and definitions only (and no pre-stated target formulas), derive an expression for the latent heat flux $LE$ in terms of $\\Delta$, $\\gamma$, $R$, $\\mathrm{VPD}$, $r_a$, and $r_s$, where $g_a = 1/r_a$ and $g_v = 1/(r_a + r_s)$, and then evaluate $LE$ numerically for the following physically consistent parameter set representing midday conditions over a temperate grassland canopy:\n- Net radiation $R_n = 550\\ \\mathrm{W\\ m^{-2}}$,\n- Ground heat flux $G = 50\\ \\mathrm{W\\ m^{-2}}$,\n- Slope of the saturation vapor pressure curve $\\Delta = 200\\ \\mathrm{Pa\\ K^{-1}}$,\n- Psychrometric constant $\\gamma = 65\\ \\mathrm{Pa\\ K^{-1}}$,\n- Vapor Pressure Deficit $\\mathrm{VPD} = 2000\\ \\mathrm{Pa}$,\n- Aerodynamic resistance $r_a = 20\\ \\mathrm{s\\ m^{-1}}$,\n- Surface (stomatal) resistance $r_s = 100\\ \\mathrm{s\\ m^{-1}}$,\n- Air density $\\rho = 1.2\\ \\mathrm{kg\\ m^{-3}}$,\n- Specific heat of air at constant pressure $c_p = 1004\\ \\mathrm{J\\ kg^{-1}\\ K^{-1}}$.\n\nPerform a sensitivity analysis with respect to $r_s$ by analytically differentiating your derived $LE$ with respect to $r_s$ and then forming the elasticity of $LE$ to $r_s$, $$S_{r_s} = \\frac{\\partial \\ln LE}{\\partial \\ln r_s} = \\frac{r_s}{LE}\\,\\frac{\\partial LE}{\\partial r_s}.$$ Evaluate $S_{r_s}$ at the above parameter values to quantify the direct physiological control of transpiration via $r_s$. Report the elasticity as your final answer. Round your final answer to four significant figures. The final reported quantity is dimensionless; no units are required for the final answer. If you provide any intermediate numerical values such as $LE$, express them in $\\mathrm{W\\ m^{-2}}$.",
            "solution": "The problem is first validated and found to be scientifically grounded, well-posed, and objective. It is a standard problem in micrometeorology concerning the derivation and application of the Penman-Monteith equation for latent heat flux. All necessary principles and data are provided for a complete derivation and numerical evaluation.\n\nThe derivation begins with the fundamental equations governing the surface energy and mass transfer. The surface energy balance is given by:\n$$R = H + LE \\quad (1)$$\nwhere $R$ is the available energy, $H$ is the sensible heat flux, and $LE$ is the latent heat flux. The available energy is $R = R_n - G$, where $R_n$ is the net radiation and $G$ is the ground heat flux.\n\nThe sensible heat flux $H$ is defined by the bulk aerodynamic formula:\n$$H = \\rho c_p g_a (T_s - T_a) \\quad (2)$$\nHere, $\\rho$ is the air density, $c_p$ is the specific heat of air, $g_a = 1/r_a$ is the aerodynamic conductance ($r_a$ being the aerodynamic resistance), $T_s$ is the surface temperature, and $T_a$ is the air temperature.\n\nThe latent heat flux $LE$ represents the energy equivalent of the water vapor flux $E$. The flux $E$ is proportional to the vapor pressure difference between the surface and the air, and the vapor conductance $g_v = 1/(r_a+r_s)$, where $r_s$ is the surface resistance. The latent heat flux is given by:\n$$LE = L \\cdot E = L \\frac{\\rho \\varepsilon}{P} g_v (e_s(T_s) - e_a)$$\nUsing the definition of the psychrometric constant, $\\gamma = \\frac{c_p P}{\\varepsilon \\lambda}$ (where we use $\\lambda$ for the latent heat of vaporization $L$ as per the problem's notation), we can rearrange to get $\\frac{\\varepsilon \\lambda}{P} = \\frac{c_p}{\\gamma}$. Substituting this into the expression for $LE$ yields the corresponding bulk formula for latent heat flux:\n$$LE = \\frac{\\rho c_p}{\\gamma} g_v (e_s(T_s) - e_a) \\quad (3)$$\nwhere $e_s(T_s)$ is the saturation vapor pressure at the surface temperature $T_s$, and $e_a$ is the ambient vapor pressure.\n\nThe primary difficulty in using equations $(1)$, $(2)$, and $(3)$ is the presence of the unknown surface temperature $T_s$. To eliminate $T_s$, we use the provided linearization of the saturation vapor pressure curve around the known air temperature $T_a$:\n$$e_s(T_s) \\approx e_s(T_a) + \\Delta (T_s - T_a) \\quad (4)$$\nwhere $\\Delta$ is the slope of the saturation vapor pressure curve at $T_a$.\n\nFirst, we solve for the temperature difference $(T_s - T_a)$ from the sensible heat flux equation $(2)$:\n$$T_s - T_a = \\frac{H}{\\rho c_p g_a}$$\nSubstitute this into the linearized vapor pressure equation $(4)$:\n$$e_s(T_s) \\approx e_s(T_a) + \\Delta \\frac{H}{\\rho c_p g_a}$$\nNow, substitute this expression for $e_s(T_s)$ into the latent heat flux equation $(3)$:\n$$LE = \\frac{\\rho c_p g_v}{\\gamma} \\left( e_s(T_a) + \\frac{\\Delta H}{\\rho c_p g_a} - e_a \\right)$$\nRecognizing that the Vapor Pressure Deficit is $\\mathrm{VPD} = e_s(T_a) - e_a$, we can simplify:\n$$LE = \\frac{\\rho c_p g_v}{\\gamma} \\left( \\mathrm{VPD} + \\frac{\\Delta H}{\\rho c_p g_a} \\right)$$\n$$LE = \\frac{\\rho c_p g_v}{\\gamma} \\mathrm{VPD} + \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} H \\quad (5)$$\nWe now have two equations, $(1)$ and $(5)$, with two unknowns, $H$ and $LE$. We can solve this system. From $(1)$, we have $H = R - LE$. Substituting this into $(5)$:\n$$LE = \\frac{\\rho c_p g_v}{\\gamma} \\mathrm{VPD} + \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} (R - LE)$$\nWe now solve for $LE$. First, distribute the last term:\n$$LE = \\frac{\\rho c_p g_v}{\\gamma} \\mathrm{VPD} + \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} R - \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} LE$$\nGroup all terms containing $LE$ on the left side:\n$$LE \\left( 1 + \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} \\right) = \\frac{\\Delta}{\\gamma} \\frac{g_v}{g_a} R + \\frac{\\rho c_p g_v}{\\gamma} \\mathrm{VPD}$$\nTo isolate $LE$, we multiply both sides by $\\frac{\\gamma g_a}{g_v}$:\n$$LE \\left( \\frac{\\gamma g_a}{g_v} + \\Delta \\right) = \\Delta R + \\rho c_p g_a \\mathrm{VPD}$$\nThis yields the final derived expression for latent heat flux, commonly known as the Penman-Monteith equation:\n$$LE = \\frac{\\Delta R + \\rho c_p g_a \\mathrm{VPD}}{\\Delta + \\gamma \\frac{g_a}{g_v}}$$\nSubstituting the conductances with resistances, $g_a=1/r_a$ and $g_v=1/(r_a+r_s)$, we get $g_a/g_v = (r_a+r_s)/r_a$. The expression becomes:\n$$LE = \\frac{\\Delta R + \\frac{\\rho c_p}{r_a} \\mathrm{VPD}}{\\Delta + \\gamma \\left( \\frac{r_a+r_s}{r_a} \\right)} \\quad (6)$$\n\nNext, we evaluate $LE$ numerically using the provided parameters.\nFirst, calculate the available energy $R$:\n$R = R_n - G = 550\\ \\mathrm{W\\ m^{-2}} - 50\\ \\mathrm{W\\ m^{-2}} = 500\\ \\mathrm{W\\ m^{-2}}$.\nThe parameters are:\n$\\Delta = 200\\ \\mathrm{Pa\\ K^{-1}}$\n$\\gamma = 65\\ \\mathrm{Pa\\ K^{-1}}$\n$\\mathrm{VPD} = 2000\\ \\mathrm{Pa}$\n$r_a = 20\\ \\mathrm{s\\ m^{-1}}$\n$r_s = 100\\ \\mathrm{s\\ m^{-1}}$\n$\\rho = 1.2\\ \\mathrm{kg\\ m^{-3}}$\n$c_p = 1004\\ \\mathrm{J\\ kg^{-1}\\ K^{-1}}$\n\nNumerator of equation $(6)$:\n$\\Delta R + \\frac{\\rho c_p}{r_a} \\mathrm{VPD} = (200)(500) + \\frac{(1.2)(1004)}{20} (2000)$\n$= 100000 + (60.24)(2000) = 100000 + 120480 = 220480\\ \\mathrm{W\\ Pa\\ m^{-2}\\ K^{-1}}$\n\nDenominator of equation $(6)$:\n$\\Delta + \\gamma \\left( \\frac{r_a+r_s}{r_a} \\right) = 200 + 65 \\left( \\frac{20+100}{20} \\right) = 200 + 65 \\left( \\frac{120}{20} \\right)$\n$= 200 + 65(6) = 200 + 390 = 590\\ \\mathrm{Pa\\ K^{-1}}$\n\nNow, calculate $LE$:\n$$LE = \\frac{220480}{590} \\approx 373.69\\ \\mathrm{W\\ m^{-2}}$$\n\nFinally, we perform the sensitivity analysis by calculating the elasticity of $LE$ with respect to $r_s$:\n$$S_{r_s} = \\frac{\\partial \\ln LE}{\\partial \\ln r_s} = \\frac{r_s}{LE} \\frac{\\partial LE}{\\partial r_s}$$\nTo simplify the differentiation, we rewrite equation $(6)$ to explicitly show its dependence on $r_s$:\n$$LE(r_s) = \\frac{\\Delta R + \\frac{\\rho c_p}{r_a} \\mathrm{VPD}}{\\Delta + \\gamma \\left(1 + \\frac{r_s}{r_a}\\right)} = \\frac{N}{D_1 + D_2 r_s}$$\nwhere $N = \\Delta R + \\frac{\\rho c_p}{r_a} \\mathrm{VPD}$, $D_1 = \\Delta + \\gamma$, and $D_2 = \\gamma/r_a$ are all independent of $r_s$.\nThe logarithmic derivative is easier to compute:\n$\\ln(LE) = \\ln(N) - \\ln(D_1 + D_2 r_s)$\nDifferentiating with respect to $r_s$:\n$$\\frac{\\partial \\ln(LE)}{\\partial r_s} = 0 - \\frac{1}{D_1 + D_2 r_s} \\cdot \\frac{\\partial}{\\partial r_s}(D_1 + D_2 r_s) = - \\frac{D_2}{D_1 + D_2 r_s}$$\nThe elasticity is then:\n$$S_{r_s} = r_s \\frac{\\partial \\ln(LE)}{\\partial r_s} = -\\frac{D_2 r_s}{D_1 + D_2 r_s}$$\nSubstituting back the original expressions for $D_1$ and $D_2$:\n$$S_{r_s} = -\\frac{(\\gamma/r_a) r_s}{(\\Delta + \\gamma) + (\\gamma/r_a) r_s} = -\\frac{\\frac{\\gamma r_s}{r_a}}{\\Delta + \\gamma \\left(1 + \\frac{r_s}{r_a}\\right)} = \\frac{-\\frac{\\gamma r_s}{r_a}}{\\Delta + \\gamma \\left(\\frac{r_a+r_s}{r_a}\\right)}$$\nThis is the analytical expression for the elasticity.\nNow, we evaluate $S_{r_s}$ with the given numerical values.\nNumerator:\n$-\\frac{\\gamma r_s}{r_a} = -\\frac{(65)(100)}{20} = -\\frac{6500}{20} = -325\\ \\mathrm{Pa\\ K^{-1}}$\nThe denominator is the same as the denominator for $LE$: $590\\ \\mathrm{Pa\\ K^{-1}}$.\n$$S_{r_s} = \\frac{-325}{590} \\approx -0.55084745...$$\nRounding to four significant figures, the elasticity is $-0.5508$. This dimensionless quantity indicates that a $1\\%$ increase in surface resistance $r_s$ results in approximately a $0.55\\%$ decrease in latent heat flux, quantifying the stomatal control on transpiration.",
            "answer": "$$\\boxed{-0.5508}$$"
        },
        {
            "introduction": "Accurately modeling the surface energy balance over frozen or thawing ground requires accounting for the substantial latent heat of fusion, but a naive implementation can cause numerical instability. The enthalpy method provides a robust and physically consistent way to handle these phase change energetics. This advanced practice guides you through implementing a stable numerical scheme for the surface temperature update using an enthalpy-based approach, a crucial feature for any robust land surface model used in weather and climate prediction .",
            "id": "4097685",
            "problem": "You are tasked with designing and implementing a robust implicit update for the surface skin-layer temperature $T_s$ in a land surface model within the field of numerical weather prediction and climate modeling. The scheme must handle the energetics of phase change of soil water without inducing numerical instability. Your implementation must be derived from first principles and expressed as a program.\n\nBegin from the following fundamental base:\n\n- Conservation of energy applied to a thin skin-layer of thickness $d$ over land yields, per unit area, the prognostic evolution of enthalpy $h$:\n$$\n\\frac{d h}{d t} = F_{\\mathrm{net}},\n$$\nwhere $F_{\\mathrm{net}}$ is the net energy flux into the skin layer, with units $\\mathrm{W\\,m^{-2}}=\\mathrm{J\\,s^{-1}\\,m^{-2}}$.\n\n- The enthalpy $h$ consists of a sensible contribution plus a latent contribution associated with the phase state of soil water. Let $T_m$ be the melting temperature of water in Kelvin, and assume a mushy phase change is regularized over a small temperature half-width $\\Delta T/2$ around $T_m$ to avoid singular heat capacity. Define the ice fraction $f_i(T)$ to be $1$ for $T \\le T_m - \\Delta T/2$, $0$ for $T \\ge T_m + \\Delta T/2$, and varying linearly in between. Let $C$ denote the skin-layer areal heat capacity with units $\\mathrm{J\\,m^{-2}\\,K^{-1}}$, and let $L$ denote the available latent energy per unit area associated with freezing the skin-layer pore water with units $\\mathrm{J\\,m^{-2}}$.\n\n- Use a reference enthalpy such that sensible enthalpy is zero at $T_m$ when liquid, and the latent contribution is negative when ice is present. The enthalpy $h(T)$ is then a monotone function of $T$, with three regimes: fully frozen, partially frozen (mushy), and fully liquid.\n\nConstruct an unconditionally stable implicit timestep for $T_s$ over a single step from time level $n$ to $n+1$ as follows:\n\n- Perform the implicit enthalpy update\n$$\nh^{n+1} = h^{n} + \\Delta t \\, F_{\\mathrm{net}},\n$$\nwith $\\Delta t$ in seconds. Here $h^{n} = h\\!\\left(T_s^{n}\\right)$ and $h^{n+1} = h\\!\\left(T_s^{n+1}\\right)$. Then determine $T_s^{n+1}$ by inverting the monotone function $T \\mapsto h(T)$.\n\nYour program must implement this enthalpy-based update by explicitly constructing the piecewise-linear $h(T)$ implied by the above assumptions and then deriving and applying the corresponding piecewise-linear inverse $T(h)$. All calculations must be carried out in Kelvin for temperature and in the units specified above for energy and flux. The inversion must be exact for the specified piecewise-linear $h(T)$ and must not require iteration. The scheme must satisfy the following:\n\n- The mapping $T \\mapsto h(T)$ is strictly monotone increasing.\n- The implicit update in $h$ followed by exact inversion yields an unconditionally stable update for $T_s$ with respect to the phase change stiffness.\n- The implementation must avoid any numerical overshoot across the phase-change interval.\n\nTest Suite:\n\nUse the following parameter tuples, each specified as $(T_s^n, F_{\\mathrm{net}}, \\Delta t, C, L, T_m, \\Delta T)$ with units $([\\,\\mathrm{K}\\,], [\\,\\mathrm{W\\,m^{-2}}\\,], [\\,\\mathrm{s}\\,], [\\,\\mathrm{J\\,m^{-2}\\,K^{-1}}\\,], [\\,\\mathrm{J\\,m^{-2}}\\,], [\\,\\mathrm{K}\\,], [\\,\\mathrm{K}\\,])$:\n\n- Case A (frozen, remains frozen): $(270.0, 50, 3600, 5e5, 5e6, 273.15, 0.2)$.\n- Case B (frozen, enters mushy): $(272.9, 150, 3600, 5e5, 5e6, 273.15, 0.2)$.\n- Case C (liquid, cools into mushy): $(273.4, -100, 7200, 5e5, 5e6, 273.15, 0.2)$.\n- Case D (mushy, freezes): $(273.05, -200, 3600, 5e5, 5e6, 273.15, 0.2)$.\n- Case E (liquid, remains liquid): $(275.0, 200, 3600, 5e5, 5e6, 273.15, 0.2)$.\n- Case F (exact melt point, no forcing): $(273.15, 0, 3600, 5e5, 5e6, 273.15, 0.2)$.\n\nYour task:\n\n- Implement a program that, for each test case, computes $T_s^{n+1}$ in Kelvin by performing the implicit enthalpy update $h^{n+1} = h^{n} + \\Delta t \\, F_{\\mathrm{net}}$ and then inverting $h(T)$ exactly.\n- Express the outputs in Kelvin, each rounded to $6$ decimals.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[v_1,v_2,\\dots,v_6]$, where each $v_i$ is the $6$-decimal-rounded value of $T_s^{n+1}$ in Kelvin corresponding to the $i$-th test case in the order specified above.",
            "solution": "The problem requires the design and implementation of a numerically stable, implicit timestepping scheme for the surface skin-layer temperature $T_s$ in a land surface model. This is achieved by first updating the system's enthalpy, $h$, and then inverting the temperature-enthalpy relationship, $h(T)$, to find the new temperature, $T_s^{n+1}$. The method must correctly account for the latent heat of phase change of soil water.\n\nFirst, we must construct the explicit, piecewise-linear function for enthalpy per unit area, $h(T)$, based on the provided physical definitions. The enthalpy comprises a sensible heat component and a latent heat component. The reference state is defined such that the sensible enthalpy is zero at the melting temperature $T_m$ and the water is in a liquid state. This implies the sensible enthalpy is $C(T - T_m)$, where $C$ is the areal heat capacity in $\\mathrm{J\\,m^{-2}\\,K^{-1}}$. The latent heat component is defined as $-L f_i(T)$, where $L$ is the total latent energy of fusion available per unit area in $\\mathrm{J\\,m^{-2}}$ and $f_i(T)$ is the ice fraction, which is a function of temperature $T$. The negative sign ensures the latent enthalpy contribution is negative when ice is present, as stipulated.\n\nThe total enthalpy is thus given by:\n$$\nh(T) = C(T - T_m) - L f_i(T)\n$$\n\nThe phase change is regularized over a temperature interval $\\Delta T$ centered at $T_m$. Let us define the temperature boundaries for the mushy (partially frozen) region:\n- The lower boundary, below which the layer is fully frozen: $T_{\\text{lower}} = T_m - \\Delta T/2$.\n- The upper boundary, above which the layer is fully liquid: $T_{\\text{upper}} = T_m + \\Delta T/2$.\n\nThe ice fraction, $f_i(T)$, is defined piecewise:\n1.  For $T \\le T_{\\text{lower}}$ (fully frozen): $f_i(T) = 1$.\n2.  For $T \\ge T_{\\text{upper}}$ (fully liquid): $f_i(T) = 0$.\n3.  For $T_{\\text{lower}}  T  T_{\\text{upper}}$ (mushy region): $f_i(T)$ varies linearly from $1$ to $0$. The function for this line is:\n    $$\n    f_i(T) = \\frac{T_{\\text{upper}} - T}{T_{\\text{upper}} - T_{\\text{lower}}} = \\frac{T_m + \\Delta T/2 - T}{\\Delta T}\n    $$\n\nSubstituting these definitions for $f_i(T)$ into the enthalpy equation yields a piecewise-linear function for $h(T)$:\n\n- **Regime 1: Fully Frozen ($T \\le T_{\\text{lower}}$)**\n  With $f_i(T) = 1$, the enthalpy is:\n  $$\n  h(T) = C(T - T_m) - L\n  $$\n\n- **Regime 2: Mushy ($T_{\\text{lower}}  T  T_{\\text{upper}}$)**\n  Substituting the linear form of $f_i(T)$:\n  $$\n  h(T) = C(T - T_m) - L\\left(\\frac{T_m + \\Delta T/2 - T}{\\Delta T}\\right)\n  $$\n  This expression can be rearranged to highlight its dependence on $T-T_m$. A cleaner form is derived by recognizing that the effective heat capacity in this region is $C_{\\text{eff}} = dh/dT = C - L (df_i/dT) = C - L(-1/\\Delta T) = C + L/\\Delta T$. Integrating this yields:\n  $$\n  h(T) = \\left(C + \\frac{L}{\\Delta T}\\right)(T - T_m) - \\frac{L}{2}\n  $$\n\n- **Regime 3: Fully Liquid ($T \\ge T_{\\text{upper}}$)**\n  With $f_i(T)=0$, the enthalpy is purely sensible heat relative to $T_m$:\n  $$\n  h(T) = C(T - T_m)\n  $$\n\nThe function $h(T)$ is continuous and strictly monotonically increasing, as its derivative, the effective heat capacity, is always positive ($C0$, $L0$, $\\Delta T0$). This guarantees the existence of a unique, single-valued inverse function, $T(h)$.\n\nThe next step is to derive this inverse function, $T(h)$, by algebraically inverting each piece of $h(T)$. We first define the enthalpy values at the boundaries of the mushy region:\n- $h_{\\text{lower}} = h(T_{\\text{lower}}) = C(T_{\\text{lower}} - T_m) - L = C(-\\Delta T/2) - L = -C\\frac{\\Delta T}{2} - L$.\n- $h_{\\text{upper}} = h(T_{\\text{upper}}) = C(T_{\\text{upper}} - T_m) = C(\\Delta T/2) = C\\frac{\\Delta T}{2}$.\n\n- **For $h \\le h_{\\text{lower}}$ (Fully Frozen):**\n  From $h = C(T - T_m) - L$, we solve for $T$:\n  $$\n  T(h) = T_m + \\frac{h + L}{C}\n  $$\n\n- **For $h_{\\text{lower}}  h  h_{\\text{upper}}$ (Mushy):**\n  From $h = (C + L/\\Delta T)(T - T_m) - L/2$, we solve for $T$:\n  $$\n  T(h) = T_m + \\frac{h + L/2}{C + L/\\Delta T}\n  $$\n\n- **For $h \\ge h_{\\text{upper}}$ (Fully Liquid):**\n  From $h = C(T - T_m)$, we solve for $T$:\n  $$\n  T(h) = T_m + \\frac{h}{C}\n  $$\n\nThe numerical update scheme consists of two steps. First, an explicit forward step is used to update the enthalpy from time level $n$ to $n+1$:\n$$\nh^{n+1} = h(T_s^n) + \\Delta t \\, F_{\\mathrm{net}}\n$$\nwhere $h(T_s^n)$ is calculated using the derived piecewise function for $h(T)$. Second, the new temperature $T_s^{n+1}$ is found by applying the inverse function $T(h)$ to the new enthalpy $h^{n+1}$:\n$$\nT_s^{n+1} = T(h^{n+1})\n$$\nThis two-step procedure constitutes an implicit update for temperature $T_s$. The stiffness associated with the large effective heat capacity during phase change is handled analytically by the inversion of $h(T)$, rather than numerically by the time integration. This makes the scheme unconditionally stable with respect to the phase-change physics, a critical feature for robust climate and weather models. The implementation involves a series of conditional statements to select the correct analytical formula from the piecewise definitions of $h(T)$ and $T(h)$, avoiding any iterative solution.\n\nThe program will implement this logic for each test case by:\n1.  Calculating the initial enthalpy $h^n$ from the given initial temperature $T_s^n$.\n2.  Calculating the final enthalpy $h^{n+1}$ using the net energy flux $F_{\\mathrm{net}}$ and time step $\\Delta t$.\n3.  Calculating the final temperature $T_s^{n+1}$ by inverting $h^{n+1}$ using the appropriate regime-dependent formula.\n4.  Rounding the result to $6$ decimal places.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the final surface skin-layer temperature based on an \n    enthalpy-based implicit update scheme.\n    \"\"\"\n    \n    # Test cases: (Ts_n, F_net, dt, C, L, Tm, DT)\n    # Units: ([K], [W m^-2], [s], [J m^-2 K^-1], [J m^-2], [K], [K])\n    test_cases = [\n        (270.0, 50.0, 3600.0, 5e5, 5e6, 273.15, 0.2),    # Case A\n        (272.9, 150.0, 3600.0, 5e5, 5e6, 273.15, 0.2),    # Case B\n        (273.4, -100.0, 7200.0, 5e5, 5e6, 273.15, 0.2),   # Case C\n        (273.05, -200.0, 3600.0, 5e5, 5e6, 273.15, 0.2),  # Case D\n        (275.0, 200.0, 3600.0, 5e5, 5e6, 273.15, 0.2),    # Case E\n        (273.15, 0.0, 3600.0, 5e5, 5e6, 273.15, 0.2),    # Case F\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        Ts_n, F_net, dt, C, L, Tm, DT = case\n        \n        # Calculate final temperature using the derived enthalpy method\n        Ts_next = calculate_ts_next(Ts_n, F_net, dt, C, L, Tm, DT)\n        results.append(f\"{Ts_next:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\ndef calculate_ts_next(Ts_n, F_net, dt, C, L, Tm, DT):\n    \"\"\"\n    Calculates the next timestep surface temperature T_s^{n+1}.\n\n    This function implements the three-stage piecewise linear enthalpy model\n    and its inverse to provide an unconditionally stable update.\n    \"\"\"\n    # Define temperature boundaries for the mushy phase\n    T_lower = Tm - DT / 2.0\n    T_upper = Tm + DT / 2.0\n\n    # Step 1: Calculate initial enthalpy h^n = h(T_s^n)\n    h_n = 0.0\n    if Ts_n = T_lower:\n        # Fully frozen regime\n        h_n = C * (Ts_n - Tm) - L\n    elif Ts_n >= T_upper:\n        # Fully liquid regime\n        h_n = C * (Ts_n - Tm)\n    else:\n        # Mushy (partially frozen) regime\n        C_eff_mushy = C + L / DT\n        h_n = C_eff_mushy * (Ts_n - Tm) - L / 2.0\n\n    # Step 2: Update enthalpy to find h^{n+1}\n    h_next = h_n + dt * F_net\n\n    # Step 3: Invert h^{n+1} to find T_s^{n+1} = T(h^{n+1})\n    # Define enthalpy boundaries for the mushy phase\n    h_lower = -C * DT / 2.0 - L\n    h_upper = C * DT / 2.0\n    \n    Ts_next = 0.0\n    if h_next = h_lower:\n        # Final state is fully frozen\n        Ts_next = Tm + (h_next + L) / C\n    elif h_next >= h_upper:\n        # Final state is fully liquid\n        Ts_next = Tm + h_next / C\n    else:\n        # Final state is mushy\n        C_eff_mushy = C + L / DT\n        Ts_next = Tm + (h_next + L / 2.0) / C_eff_mushy\n\n    return Ts_next\n\nsolve()\n```"
        }
    ]
}