{
    "hands_on_practices": [
        {
            "introduction": "The principle of Potential Vorticity (PV) invertibility is built upon the ability to recover balanced mass and wind fields from a known PV distribution. This first exercise provides a foundational, analytical look at this process in a simplified shallow-water system . By deriving and solving the linear invertibility relationship, you will directly see how a prescribed PV anomaly forces a response in the height and velocity fields, and how this response depends critically on the spatial scale of the anomaly relative to the Rossby deformation radius.",
            "id": "4077245",
            "problem": "Consider a single-layer shallow-water system on a non-divergent, unbounded domain with constant background layer thickness $H$, constant Coriolis parameter $f$, and gravitational acceleration $g$. Assume small Rossby number so that the horizontal momentum is in geostrophic balance, and restrict attention to balanced, slowly varying motions. Let the layer thickness be $h(x,y,t) = H + \\eta(x,y,t)$, with $|\\eta| \\ll H$, and define the horizontal geostrophic velocity through a streamfunction $\\psi(x,y,t)$ via $u = -\\partial \\psi/\\partial y$ and $v = \\partial \\psi/\\partial x$, and the geostrophic balance $u = -(g/f)\\,\\partial \\eta/\\partial y$, $v = (g/f)\\,\\partial \\eta/\\partial x$.\n\nDefine the absolute vorticity $\\zeta_{a} = \\zeta + f$, where the relative vorticity $\\zeta = \\partial v/\\partial x - \\partial u/\\partial y$, and the shallow-water Potential Vorticity (PV) as $q = \\zeta_{a}/h$. Consider perturbations about the resting state with constant $H$ and $u=v=0$, and define the linear PV anomaly $q' = q - f/H$. Introduce the non-dimensional PV anomaly $\\tilde{q} = H q'/f$.\n\nA prescribed, steady, horizontally periodic non-dimensional PV anomaly is imposed of the form\n$$\n\\tilde{q}(x) = A \\cos(k x),\n$$\nwith wavenumber $k > 0$, constant amplitude $A$ (dimensionless), and no $y$-dependence. Assume perturbations decay at infinity and there is no external forcing or dissipation.\n\nStarting from the shallow-water definitions and geostrophic balance, linearize the PV about the base state and derive the balanced invertibility relation that connects the geostrophic streamfunction $\\psi$ to the PV anomaly. Then invert this relation for the corresponding geostrophic height perturbation $\\eta$ and wind. Finally, determine the single constant coefficient $C$ such that the non-dimensional height perturbation $h'(x)/H = \\eta(x)/H$ can be written as\n$$\n\\frac{h'(x)}{H} = C \\cos(k x),\n$$\nexpressing $C$ purely in terms of $A$, $k$, and the Rossby deformation radius $L_{d} = \\sqrt{g H}/f$. Since $C$ is dimensionless, no units are required in the final expression.",
            "solution": "The problem statement has been validated and is deemed sound. It is scientifically grounded in the principles of geophysical fluid dynamics, specifically the quasi-geostrophic theory of potential vorticity. The problem is well-posed, objective, and contains all necessary information to derive a unique solution.\n\nThe objective is to find the coefficient $C$ relating the non-dimensional potential vorticity (PV) anomaly to the resulting non-dimensional geostrophic height perturbation in a linearized shallow-water system. This requires, first, the derivation of the PV invertibility relationship.\n\nThe shallow-water potential vorticity $q$ is defined as the ratio of the absolute vorticity $\\zeta_a$ to the total fluid depth $h$:\n$$\nq = \\frac{\\zeta_a}{h} = \\frac{\\zeta + f}{h}\n$$\nwhere $f$ is the constant Coriolis parameter, $\\zeta = \\partial v/\\partial x - \\partial u/\\partial y$ is the relative vorticity, and $h(x,y,t) = H + \\eta(x,y,t)$ is the layer thickness, with $H$ being the constant mean thickness and $\\eta$ the perturbation.\n\nUnder the assumption of geostrophic balance for slowly varying motions, the velocity components $(u, v)$ are related to a geostrophic streamfunction $\\psi$ by $u = -\\partial \\psi/\\partial y$ and $v = \\partial \\psi/\\partial x$. The relative vorticity is then given by the Laplacian of the streamfunction:\n$$\n\\zeta = \\frac{\\partial}{\\partial x}\\left(\\frac{\\partial \\psi}{\\partial x}\\right) - \\frac{\\partial}{\\partial y}\\left(-\\frac{\\partial \\psi}{\\partial y}\\right) = \\nabla^2 \\psi\n$$\nThe geostrophic balance equations also relate the velocity to the height perturbation $\\eta$:\n$$\nu = -\\frac{g}{f}\\frac{\\partial \\eta}{\\partial y} \\quad , \\quad v = \\frac{g}{f}\\frac{\\partial \\eta}{\\partial x}\n$$\nComparing the expressions for the velocity components in terms of $\\psi$ and $\\eta$, we see that $\\partial \\psi/\\partial y = (g/f)\\partial \\eta/\\partial y$ and $\\partial \\psi/\\partial x = (g/f)\\partial \\eta/\\partial x$. Integrating these relations yields a direct relationship between the streamfunction and the height perturbation, up to a spatial constant which can be set to zero for convenience:\n$$\n\\psi = \\frac{g}{f} \\eta \\quad \\text{or} \\quad \\eta = \\frac{f}{g} \\psi\n$$\nWe now linearize the PV expression about a state of rest ($u=v=0$, $\\zeta=0$, $\\eta=0$) where the PV is $q_0 = f/H$. For small perturbations, $|\\eta| \\ll H$ and $|\\zeta| \\ll f$.\n$$\nq = \\frac{f + \\nabla^2 \\psi}{H + \\eta} = \\frac{f + \\nabla^2 \\psi}{H(1 + \\eta/H)} \\approx \\frac{1}{H}(f + \\nabla^2 \\psi)\\left(1 - \\frac{\\eta}{H}\\right)\n$$\nExpanding and retaining only terms that are linear in the perturbation quantities ($\\psi$ and $\\eta$), we neglect the product of small terms $(\\nabla^2 \\psi)(\\eta/H)$:\n$$\nq \\approx \\frac{f}{H} - \\frac{f \\eta}{H^2} + \\frac{\\nabla^2 \\psi}{H}\n$$\nThe linear PV anomaly $q'$ is defined as $q' = q - q_0 = q - f/H$. Thus,\n$$\nq' \\approx \\frac{\\nabla^2 \\psi}{H} - \\frac{f \\eta}{H^2}\n$$\nNow, we substitute $\\eta = (f/g)\\psi$ into this expression to obtain a relation solely in terms of $\\psi$:\n$$\nq' = \\frac{\\nabla^2 \\psi}{H} - \\frac{f}{H^2}\\left(\\frac{f}{g}\\psi\\right) = \\frac{1}{H}\\left(\\nabla^2 \\psi - \\frac{f^2}{gH}\\psi\\right)\n$$\nThe problem defines the Rossby radius of deformation as $L_d = \\sqrt{g H}/f$, so its square is $L_d^2 = gH/f^2$. The term $f^2/(gH)$ is therefore equal to $1/L_d^2$. The linearized PV invertibility relation is:\n$$\nq' = \\frac{1}{H}\\left(\\nabla^2 \\psi - \\frac{1}{L_d^2}\\psi\\right)\n$$\nThis is a Helmholtz-type elliptic equation relating the PV anomaly $q'$ to the streamfunction $\\psi$.\n\nNext, we use the given non-dimensional PV anomaly $\\tilde{q}(x) = A \\cos(k x)$. The relationship between $\\tilde{q}$ and $q'$ is $\\tilde{q} = H q'/f$, which implies $q' = (f/H)\\tilde{q}$. Substituting this into the invertibility equation:\n$$\n\\frac{f}{H}\\tilde{q} = \\frac{1}{H}\\left(\\nabla^2 \\psi - \\frac{1}{L_d^2}\\psi\\right)\n$$\n$$\nf\\tilde{q} = \\nabla^2 \\psi - \\frac{1}{L_d^2}\\psi\n$$\nThe problem specifies that $\\tilde{q}$ depends only on $x$, so we assume the response $\\psi$ also depends only on $x$, meaning $\\psi = \\psi(x)$. The Laplacian operator becomes $\\nabla^2 = d^2/dx^2$. The governing equation for $\\psi$ is:\n$$\nf A \\cos(k x) = \\frac{d^2 \\psi}{dx^2} - \\frac{1}{L_d^2}\\psi\n$$\nWe seek a periodic solution of the form $\\psi(x) = \\Psi_0 \\cos(k x)$, where $\\Psi_0$ is the constant amplitude of the streamfunction. Substituting this ansatz into the differential equation:\n$$\n\\frac{d^2}{dx^2}(\\Psi_0 \\cos(k x)) = -k^2 \\Psi_0 \\cos(k x)\n$$\nSo, the equation becomes:\n$$\nf A \\cos(k x) = -k^2 \\Psi_0 \\cos(k x) - \\frac{1}{L_d^2} \\Psi_0 \\cos(k x)\n$$\nFor this equation to hold for all $x$, the coefficients of $\\cos(k x)$ on both sides must be equal:\n$$\nf A = -k^2 \\Psi_0 - \\frac{1}{L_d^2} \\Psi_0 = -\\Psi_0 \\left(k^2 + \\frac{1}{L_d^2}\\right)\n$$\nSolving for the streamfunction amplitude $\\Psi_0$:\n$$\n\\Psi_0 = -\\frac{f A}{k^2 + 1/L_d^2}\n$$\nThe corresponding geostrophic height perturbation $\\eta(x)$ is found using $\\eta = (f/g)\\psi$:\n$$\n\\eta(x) = \\frac{f}{g} \\psi(x) = \\frac{f}{g} \\left(-\\frac{f A}{k^2 + 1/L_d^2}\\right) \\cos(k x) = -\\frac{f^2 A}{g(k^2 + 1/L_d^2)} \\cos(k x)\n$$\nThe problem asks for the coefficient $C$ in the expression for the non-dimensional height perturbation $\\eta(x)/H$:\n$$\n\\frac{\\eta(x)}{H} = -\\frac{f^2 A}{g H (k^2 + 1/L_d^2)} \\cos(k x)\n$$\nBy comparing this to the form $\\frac{\\eta(x)}{H} = C \\cos(k x)$, we identify the coefficient $C$ as:\n$$\nC = -\\frac{f^2 A}{g H (k^2 + 1/L_d^2)}\n$$\nTo express $C$ purely in terms of $A$, $k$, and $L_d$, we use the relation $1/L_d^2 = f^2/(gH)$:\n$$\nC = -A \\frac{f^2/(gH)}{k^2 + 1/L_d^2} = -A \\frac{1/L_d^2}{k^2 + 1/L_d^2}\n$$\nMultiplying the numerator and denominator by $L_d^2$ simplifies the expression:\n$$\nC = -A \\frac{1}{L_d^2(k^2 + 1/L_d^2)} = -\\frac{A}{k^2 L_d^2 + 1}\n$$\nThe wind field, for completeness, has components $u=0$ (since $\\psi$ does not depend on $y$) and $v = \\partial\\psi/\\partial x$:\n$$\nv(x) = \\frac{\\partial}{\\partial x}\\left(\\Psi_0 \\cos(k x)\\right) = -k \\Psi_0 \\sin(k x) = -k \\left(-\\frac{f A}{k^2 + 1/L_d^2}\\right) \\sin(k x) = \\frac{k f A}{k^2 + 1/L_d^2} \\sin(k x)\n$$\nThe final expression for the coefficient $C$ is dimensionless, as required. It relates the amplitude of the height response to the amplitude of the PV forcing, mediated by the non-dimensional parameter $k L_d$, which is the ratio of the deformation radius to the spatial scale of the forcing.",
            "answer": "$$\\boxed{-\\frac{A}{1 + k^{2}L_{d}^{2}}}$$"
        },
        {
            "introduction": "Beyond understanding the basic principle, the real power of PV lies in its use as a diagnostic tool to attribute parts of the flow to specific features in the PV field. This computational practice demonstrates the technique of piecewise PV inversion, a method widely used in atmospheric research . You will explore how the total flow can be understood as a linear superposition of the flows induced by individual PV anomalies, and critically, how non-linear quantities like kinetic energy arise from the interaction between these components.",
            "id": "4077232",
            "problem": "Consider a barotropic Quasi-Geostrophic (QG) flow on a doubly periodic domain with side lengths $L_x$ and $L_y$ and uniform Coriolis parameter $f_0$. In the barotropic QG approximation, the Potential Vorticity (PV) anomaly $q'$ is related to the streamfunction $\\psi$ by the Poisson equation $q' = \\nabla^2 \\psi$. The geostrophic velocity field $(u,v)$ is given by $u = -\\partial \\psi / \\partial y$ and $v = \\partial \\psi / \\partial x$. Kinetic energy per unit mass is defined as $K = \\frac{1}{2} (u^2 + v^2)$. The goal is to perform piecewise PV inversion and attribution diagnostics: construct PV subfields $q_A$ and $q_B$, invert them separately and jointly, and quantify how their contributions combine to produce the total kinetic energy.\n\nFundamental base:\n- Use the definition of barotropic Quasi-Geostrophic (QG) Potential Vorticity (PV) anomaly $q'$, where $q' = \\nabla^2 \\psi$ on a two-dimensional domain with periodic boundary conditions.\n- Use the Discrete Fourier Transform (DFT) to represent fields and compute spatial derivatives spectrally. Define wavenumbers $k_x$ and $k_y$ using the periodic domain lengths $L_x$ and $L_y$, with $k_x = 2\\pi n_x / L_x$ and $k_y = 2\\pi n_y / L_y$, where $n_x$ and $n_y$ are integer mode indices.\n- Implement the inversion of the Poisson equation in spectral space by solving for $\\psi$ such that its Laplacian matches $q'$, ensuring the zero wavenumber mode is handled correctly by removing the domain mean of $q$ before inversion. Set the zero-wavenumber component of $\\psi$ to zero to fix the gauge, as adding any constant to $\\psi$ does not change $(u,v)$.\n\nYour task:\n1. Construct two PV anomaly subfields $q_A(x,y)$ and $q_B(x,y)$ as isotropic Gaussian functions on the domain, and define the total PV anomaly as the sum $q(x,y) = q_A(x,y) + q_B(x,y)$. Each Gaussian is defined by an amplitude $A$ (in $\\mathrm{s}^{-1}$), a radial scale (standard deviation) $\\sigma$ (in $\\mathrm{m}$), and a center $(x_0,y_0)$ (in $\\mathrm{m}$), via\n   $$ q_G(x,y) = A \\exp\\left(-\\frac{(x-x_0)^2+(y-y_0)^2}{2\\sigma^2}\\right). $$\n   For inversion, remove the domain mean from each field: use $q'_A = q_A - \\langle q_A \\rangle$, $q'_B = q_B - \\langle q_B \\rangle$, and $q' = q - \\langle q \\rangle$.\n2. Invert $q'_A$, $q'_B$, and $q'$ to obtain $\\psi_A$, $\\psi_B$, and $\\psi$, respectively, under periodic boundary conditions using spectral methods. Derive the spectral relationship between $q'$ and $\\psi$ based on the Poisson equation and implement it numerically. Ensure the zero-wavenumber mode of $\\psi$ is set to zero.\n3. Compute the geostrophic velocities $(u_A,v_A)$, $(u_B,v_B)$, and $(u,v)$ from $\\psi_A$, $\\psi_B$, and $\\psi$, respectively, using spectral differentiation. Verify linear superposition of velocities, i.e., check that $(u,v)$ equals $(u_A+u_B, v_A+v_B)$ to numerical precision.\n4. Compute the domain-mean kinetic energies per unit mass (in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$): $K_{\\text{tot}} = \\langle \\frac{1}{2}(u^2+v^2) \\rangle$, $K_A = \\langle \\frac{1}{2}(u_A^2+v_A^2) \\rangle$, and $K_B = \\langle \\frac{1}{2}(u_B^2+v_B^2) \\rangle$. Quantify the non-additive cross-term $K_\\times = K_{\\text{tot}} - K_A - K_B$ attributable to interactions between piecewise contributions.\n5. As an invertibility diagnostic, compute the reconstructed PV anomaly $q'_{\\text{rec}}$ from $\\psi$ using $q'_{\\text{rec}} = \\nabla^2 \\psi$ in spectral space. Compute the relative root-mean-square error $E = \\|q' - q'_{\\text{rec}}\\|_2 / \\|q'\\|_2$, and return a boolean indicating whether $E \\le 10^{-11}$.\n\nPhysical and numerical units:\n- $L_x$, $L_y$, $\\sigma$, $x_0$, and $y_0$ must be in meters ($\\mathrm{m}$).\n- PV amplitudes $A$ must be in inverse seconds ($\\mathrm{s}^{-1}$).\n- Velocities must be computed in meters per second ($\\mathrm{m}\\,\\mathrm{s}^{-1}$).\n- Kinetic energies must be returned as domain-mean values in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$.\n- Angles are not used; no angular units are required.\n\nTest suite:\nImplement your program to run the following four test cases. Each case is defined by $(N_x,N_y,L_x,L_y,A_A,A_B,\\sigma_A,\\sigma_B,x_{0A},y_{0A},x_{0B},y_{0B})$:\n\n- Case 1 (general, two anomalies of opposite sign): $(64,64,1.0\\times 10^6,1.0\\times 10^6,5.0\\times 10^{-5},-4.0\\times 10^{-5},1.2\\times 10^5,1.8\\times 10^5,3.0\\times 10^5,7.0\\times 10^5,7.0\\times 10^5,3.0\\times 10^5)$.\n- Case 2 (boundary, one anomaly only): $(64,64,1.0\\times 10^6,1.0\\times 10^6,4.0\\times 10^{-5},0.0,1.5\\times 10^5,1.0\\times 10^5,5.0\\times 10^5,5.0\\times 10^5,2.0\\times 10^5,8.0\\times 10^5)$.\n- Case 3 (edge, high-wavenumber content with two positive anomalies): $(64,64,1.0\\times 10^6,1.0\\times 10^6,6.0\\times 10^{-5},6.0\\times 10^{-5},8.0\\times 10^4,1.0\\times 10^5,2.5\\times 10^5,2.5\\times 10^5,7.5\\times 10^5,7.5\\times 10^5)$.\n- Case 4 (edge, nearby opposite anomalies causing cancellation): $(64,64,1.0\\times 10^6,1.0\\times 10^6,5.0\\times 10^{-5},-5.0\\times 10^{-5},1.2\\times 10^5,1.2\\times 10^5,4.5\\times 10^5,5.5\\times 10^5,5.5\\times 10^5,4.5\\times 10^5)$.\n\nFor each test case, compute and return a list containing five entries:\n- $K_{\\text{tot}}$ (float, in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$),\n- $K_A$ (float, in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$),\n- $K_B$ (float, in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$),\n- $K_\\times$ (float, in $\\mathrm{m}^2\\,\\mathrm{s}^{-2}$),\n- invertibility boolean (true if $E \\le 10^{-11}$, false otherwise).\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list of the per-test-case result lists, enclosed in square brackets. For example, the output should look like: \n\"[[K_tot1,K_A1,K_B1,K_cross1,inv_ok1],[K_tot2,K_A2,K_B2,K_cross2,inv_ok2],[K_tot3,K_A3,K_B3,K_cross3,inv_ok3],[K_tot4,K_A4,K_B4,K_cross4,inv_ok4]]\".",
            "solution": "The problem is well-posed and scientifically sound, representing a standard numerical exercise in geophysical fluid dynamics. We shall proceed with a complete solution.\n\n**1. Governing Equations and Discretization**\n\nThe fundamental relationship between the PV anomaly, $q'$, and the geostrophic streamfunction, $\\psi$, is given by the Poisson equation:\n$$ q'(x,y) = \\nabla^2 \\psi(x,y) = \\left(\\frac{\\partial^2}{\\partial x^2} + \\frac{\\partial^2}{\\partial y^2}\\right) \\psi(x,y) $$\nThe domain is a rectangle $(x,y) \\in [0, L_x) \\times [0, L_y)$ with periodic boundary conditions. The geostrophic velocity components $(u,v)$ are derived from the streamfunction:\n$$ u(x,y) = -\\frac{\\partial \\psi}{\\partial y}, \\quad v(x,y) = \\frac{\\partial \\psi}{\\partial x} $$\nThe problem is solved numerically on a discrete grid of size $N_x \\times N_y$.\n\n**2. Spectral Method for PV Inversion**\n\nThe use of a doubly periodic domain makes the Discrete Fourier Transform (DFT) an exceptionally efficient and accurate tool. A field $f(x,y)$ in physical space can be represented by its complex Fourier coefficients $\\hat{f}(k_x, k_y)$ in spectral space.\n\nThe key property of the Fourier transform is that differentiation in physical space becomes multiplication in spectral space. Specifically, $\\mathcal{F}\\{\\frac{\\partial f}{\\partial x}\\} = i k_x \\hat{f}$ and $\\mathcal{F}\\{\\frac{\\partial f}{\\partial y}\\} = i k_y \\hat{f}$, where $i=\\sqrt{-1}$ and $k_x$, $k_y$ are the wavenumbers. The wavenumbers are defined by the domain size and grid resolution:\n$$ k_x = \\frac{2\\pi n_x}{L_x}, \\quad k_y = \\frac{2\\pi n_y}{L_y} $$\nfor integer mode indices $n_x \\in [ -N_x/2+1, ..., N_x/2 ]$ and $n_y \\in [ -N_y/2+1, ..., N_y/2 ]$.\n\nApplying the 2D Fourier transform $\\mathcal{F}$ to the Poisson equation yields:\n$$ \\hat{q}'(k_x, k_y) = \\mathcal{F}\\{\\nabla^2 \\psi\\} = \\mathcal{F}\\left\\{\\frac{\\partial^2 \\psi}{\\partial x^2}\\right\\} + \\mathcal{F}\\left\\{\\frac{\\partial^2 \\psi}{\\partial y^2}\\right\\} = ((i k_x)^2 + (i k_y)^2) \\hat{\\psi} = -(k_x^2 + k_y^2) \\hat{\\psi} $$\nLet $k^2 = k_x^2 + k_y^2$. The equation in spectral space is $\\hat{q}' = -k^2 \\hat{\\psi}$.\n\nThis algebraic relationship allows for direct inversion to find $\\hat{\\psi}$ from $\\hat{q}'$:\n$$ \\hat{\\psi}(k_x, k_y) = -\\frac{\\hat{q}'(k_x, k_y)}{k^2} $$\nThis inversion is only defined for $k^2 \\neq 0$.\n\nFor the zero-wavenumber mode ($k_x=0, k_y=0$, so $k^2=0$), two conditions must be met:\n1.  **Solvability Condition**: The numerator $\\hat{q}'(0,0)$ must be zero. The zero-wavenumber Fourier coefficient is proportional to the domain mean of the field. Therefore, we must use a PV anomaly field with zero mean. This is achieved by computing $q' = q - \\langle q \\rangle$, where $\\langle \\cdot \\rangle$ denotes the spatial mean.\n2.  **Gauge Fixing**: The value of $\\hat{\\psi}(0,0)$ is undetermined. This corresponds to the fact that adding an arbitrary constant to $\\psi$ does not change the velocity field. We fix this gauge by setting $\\hat{\\psi}(0,0) = 0$.\n\nThe full algorithm for PV inversion is:\n1.  Given a PV field $q(x,y)$, compute its anomaly $q'(x,y) = q(x,y) - \\langle q(x,y) \\rangle$.\n2.  Compute its Fourier transform $\\hat{q}'(k_x,k_y) = \\mathcal{F}\\{q'\\}$.\n3.  Compute the spectral streamfunction $\\hat{\\psi}$ by setting $\\hat{\\psi}(0,0) = 0$ and $\\hat{\\psi}(k_x, k_y) = -\\hat{q}'(k_x, k_y) / (k_x^2 + k_y^2)$ for all other wavenumbers.\n4.  Compute the physical-space streamfunction $\\psi(x,y) = \\mathcal{F}^{-1}\\{\\hat{\\psi}\\}$.\n\n**3. Velocity and Kinetic Energy Calculation**\n\nOnce $\\hat{\\psi}$ is known, the spectral representations of the velocities are:\n$$ \\hat{u}(k_x, k_y) = -i k_y \\hat{\\psi}(k_x, k_y) $$\n$$ \\hat{v}(k_x, k_y) = i k_x \\hat{\\psi}(k_x, k_y) $$\nThe physical velocity fields $u(x,y)$ and $v(x,y)$ are obtained by applying the inverse Fourier transform. The kinetic energy per unit mass is $K = \\frac{1}{2}(u^2+v^2)$, and we are asked to compute its domain mean, $\\langle K \\rangle$.\n\n**4. Piecewise Inversion and Energy Attribution**\n\nThe total PV is a sum of two components, $q = q_A + q_B$. Since the inversion process (mean-removal, FFT, division by $-k^2$, IFFT) is linear, the resulting total streamfunction is the sum of the streamfunctions from the individual components: $\\psi = \\psi_A + \\psi_B$. Consequently, the total velocity is also a linear superposition: $\\mathbf{v} = \\mathbf{v}_A + \\mathbf{v}_B$.\n\nHowever, kinetic energy is a quadratic quantity and does not superpose linearly. The total domain-mean kinetic energy $K_{\\text{tot}}$ is:\n$$ K_{\\text{tot}} = \\left\\langle \\frac{1}{2} (\\mathbf{v}_A+\\mathbf{v}_B) \\cdot (\\mathbf{v}_A+\\mathbf{v}_B) \\right\\rangle = \\left\\langle \\frac{1}{2}(\\mathbf{v}_A \\cdot \\mathbf{v}_A) + \\frac{1}{2}(\\mathbf{v}_B \\cdot \\mathbf{v}_B) + \\mathbf{v}_A \\cdot \\mathbf{v}_B \\right\\rangle $$\n$$ K_{\\text{tot}} = K_A + K_B + K_\\times $$\nwhere $K_A = \\langle \\frac{1}{2}(u_A^2+v_A^2) \\rangle$ and $K_B = \\langle \\frac{1}{2}(u_B^2+v_B^2) \\rangle$ are the energies of the individual components, and $K_\\times = \\langle u_A u_B + v_A v_B \\rangle$ is the cross-term or interaction energy. This term quantifies the constructive or destructive interference between the flow fields induced by the two PV anomalies.\n\n**5. Invertibility Diagnostic**\n\nTo verify the numerical implementation, we perform a round-trip calculation. We start with the total PV anomaly $q'$, invert it to get $\\psi$, and then apply the forward operator $\\nabla^2$ to $\\psi$ to get a reconstructed PV anomaly, $q'_{\\text{rec}}$.\n$$ q'_{\\text{rec}} = \\nabla^2 \\psi $$\nIn spectral space, this is simply $\\hat{q}'_{\\text{rec}} = -k^2 \\hat{\\psi}$.\nTheoretically, $q'_{\\text{rec}}$ should be identical to $q'$. We measure the numerical error by the relative root-mean-square error $E = \\|q' - q'_{\\text{rec}}\\|_2 / \\|q'\\|_2$, where $\\|f\\|_2 = \\sqrt{\\sum f_{ij}^2}$ is the L2-norm. A small value of $E$ (e.g., less than $10^{-11}$) confirms the accuracy of the spectral computations.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the PV inversion test cases.\n    \"\"\"\n    test_cases = [\n        # (Nx, Ny, Lx, Ly, A_A, A_B, sigma_A, sigma_B, x0A, y0A, x0B, y0B)\n        (64, 64, 1.0e6, 1.0e6, 5.0e-5, -4.0e-5, 1.2e5, 1.8e5, 3.0e5, 7.0e5, 7.0e5, 3.0e5),\n        (64, 64, 1.0e6, 1.0e6, 4.0e-5, 0.0, 1.5e5, 1.0e5, 5.0e5, 5.0e5, 2.0e5, 8.0e5),\n        (64, 64, 1.0e6, 1.0e6, 6.0e-5, 6.0e-5, 8.0e4, 1.0e5, 2.5e5, 2.5e5, 7.5e5, 7.5e5),\n        (64, 64, 1.0e6, 1.0e6, 5.0e-5, -5.0e-5, 1.2e5, 1.2e5, 4.5e5, 5.5e5, 5.5e5, 4.5e5),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = process_case(case)\n        results.append(result)\n\n    # Format the final output string exactly as specified.\n    case_strs = [\n        f\"[{r[0]},{r[1]},{r[2]},{r[3]},{r[4]}]\" for r in results\n    ]\n    final_output = f\"[{','.join(case_strs)}]\"\n    print(final_output)\n\ndef make_gaussian(X, Y, A, sigma, x0, y0):\n    \"\"\"\n    Generates a 2D Gaussian function on a grid.\n    \"\"\"\n    return A * np.exp(-((X - x0)**2 + (Y - y0)**2) / (2 * sigma**2))\n\ndef process_case(case):\n    \"\"\"\n    Processes a single test case for PV inversion and diagnostics.\n    \"\"\"\n    Nx, Ny, Lx, Ly, A_A, A_B, sigma_A, sigma_B, x0A, y0A, x0B, y0B = case\n    \n    # 1. Set up grid and wavenumbers\n    x = np.linspace(0, Lx, Nx, endpoint=False)\n    y = np.linspace(0, Ly, Ny, endpoint=False)\n    X, Y = np.meshgrid(x, y)\n\n    kx_1d = 2 * np.pi * np.fft.fftfreq(Nx, d=Lx/Nx)\n    ky_1d = 2 * np.pi * np.fft.fftfreq(Ny, d=Ly/Ny)\n    Kx, Ky = np.meshgrid(kx_1d, ky_1d)\n    \n    K_squared = Kx**2 + Ky**2\n    iKx = 1j * Kx\n    iKy = 1j * Ky\n\n    # 2. Construct PV anomaly fields\n    q_A = make_gaussian(X, Y, A_A, sigma_A, x0A, y0A)\n    q_B = make_gaussian(X, Y, A_B, sigma_B, x0B, y0B)\n    q_total = q_A + q_B\n    \n    def invert_and_differentiate(q_field):\n        \"\"\"\n        Performs PV inversion and calculates velocities for a given PV field.\n        \"\"\"\n        # A. Remove domain mean to get PV anomaly q'\n        q_prime = q_field - np.mean(q_field)\n        \n        # B. Invert for streamfunction psi in spectral space\n        q_prime_hat = np.fft.fft2(q_prime)\n        psi_hat = np.zeros_like(q_prime_hat)\n        \n        # Avoid division by zero at k=0. \n        # The (0,0) component of psi_hat remains 0, fixing the gauge.\n        nonzero_k_mask = K_squared != 0\n        psi_hat[nonzero_k_mask] = -q_prime_hat[nonzero_k_mask] / K_squared[nonzero_k_mask]\n        \n        # C. Differentiate for velocity in spectral space\n        u_hat = -iKy * psi_hat\n        v_hat = iKx * psi_hat\n        \n        # D. Inverse transform to physical space and take the real part\n        psi = np.fft.ifft2(psi_hat).real\n        u = np.fft.ifft2(u_hat).real\n        v = np.fft.ifft2(v_hat).real\n        \n        return psi, u, v\n\n    # 3. Invert the individual and total PV fields\n    psi_A, u_A, v_A = invert_and_differentiate(q_A)\n    psi_B, u_B, v_B = invert_and_differentiate(q_B)\n    psi_total, u_total, v_total = invert_and_differentiate(q_total)\n\n    # 4. Compute domain-mean kinetic energies\n    K_A = 0.5 * np.mean(u_A**2 + v_A**2)\n    K_B = 0.5 * np.mean(u_B**2 + v_B**2)\n    K_tot = 0.5 * np.mean(u_total**2 + v_total**2)\n    K_cross = K_tot - K_A - K_B\n\n    # 5. Perform the invertibility diagnostic\n    q_prime_total = q_total - np.mean(q_total)\n    \n    # Reconstruct q' from the final streamfunction psi_total\n    psi_total_hat = np.fft.fft2(psi_total)\n    q_rec_prime_hat = -K_squared * psi_total_hat\n    q_rec_prime = np.fft.ifft2(q_rec_prime_hat).real\n    \n    # Calculate the relative RMS error\n    norm_q_prime = np.linalg.norm(q_prime_total)\n    \n    if norm_q_prime == 0:\n        # If the input PV field is uniform, its anomaly is zero.\n        # The reconstruction will also be zero, so the error is zero.\n        rel_error = 0.0\n    else:\n        rel_error = np.linalg.norm(q_prime_total - q_rec_prime) / norm_q_prime\n        \n    invertibility_ok = rel_error <= 1e-11\n    \n    return [K_tot, K_A, K_B, K_cross, invertibility_ok]\n\nsolve()\n```"
        },
        {
            "introduction": "A static view of PV inversion connects the fields at a single moment in time, but the atmosphere is a dynamic system where PV is constantly being redistributed and created. This practice shifts our focus to the evolution of Ertel PV, exploring its non-conservative behavior due to diabatic heating and friction . By calculating the explicit source and sink terms, you will gain a quantitative understanding of the physical processes that generate the very PV anomalies that drive weather system development, such as cyclogenesis.",
            "id": "4077234",
            "problem": "An Ertel Potential Vorticity (PV) diagnostic is to be performed at a single midlatitude tropospheric point in a Numerical Weather Prediction (NWP) model. The Ertel PV is defined by $q = \\rho^{-1} \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\theta$, where $\\rho$ is density, $\\boldsymbol{\\omega}_{a}$ is the absolute vorticity vector, and $\\theta$ is potential temperature. At the analysis point, assume the following fields are uniform over a small neighborhood and constant in time over a window of duration $\\Delta t = 6$ hours:\n- Density: $\\rho = 0.8 \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$.\n- Absolute vorticity: $\\boldsymbol{\\omega}_{a} = \\left(2.0 \\times 10^{-4}, \\ -1.0 \\times 10^{-4}, \\ 1.0 \\times 10^{-4}\\right) \\ \\mathrm{s}^{-1}$.\n- Potential temperature gradient: $\\nabla \\theta = \\left(1.5 \\times 10^{-5}, \\ -2.0 \\times 10^{-5}, \\ 1.2 \\times 10^{-2}\\right) \\ \\mathrm{K} \\ \\mathrm{m}^{-1}$.\n- Gradient of diabatic heating rate: $\\nabla \\dot{\\theta} = \\left(4.0 \\times 10^{-11}, \\ -2.0 \\times 10^{-11}, \\ -3.0 \\times 10^{-8}\\right) \\ \\mathrm{K} \\ \\mathrm{s}^{-1} \\ \\mathrm{m}^{-1}$.\n- Curl of the non-conservative (frictional) force per unit mass: $\\nabla \\times \\boldsymbol{F} = \\left(1.0 \\times 10^{-9}, \\ -1.0 \\times 10^{-9}, \\ 5.0 \\times 10^{-9}\\right) \\ \\mathrm{s}^{-2}$.\n\nStarting from the compressible equations of motion in a rotating frame with a non-conservative force per unit mass $\\boldsymbol{F}$ and the thermodynamic equation $D\\theta/Dt = \\dot{\\theta}$, use fundamental laws and definitions to derive the material derivative of Ertel PV $Dq/Dt$ including source and sink terms due to diabatic heating and friction. Then, under the stated uniformity and constancy assumptions, compute the net PV change $\\Delta q$ over the time window $\\Delta t$ at the analysis point.\n\nExpress your final answer in the Potential Vorticity Unit (PVU), defined by $1 \\ \\mathrm{PVU} = 10^{-6} \\ \\mathrm{K} \\ \\mathrm{m}^{2} \\ \\mathrm{kg}^{-1} \\ \\mathrm{s}^{-1}$. Round your answer to three significant figures.",
            "solution": "The Ertel Potential Vorticity (PV) is defined by\n$$\nq \\equiv \\frac{1}{\\rho} \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\theta,\n$$\nwhere $\\boldsymbol{\\omega}_{a} = \\nabla \\times \\boldsymbol{v} + 2 \\boldsymbol{\\Omega}$ is the absolute vorticity, $\\rho$ is density, and $\\theta$ is potential temperature. In adiabatic and inviscid flow, $q$ is materially conserved. In the presence of diabatic heating and friction, $q$ evolves according to source and sink terms derived from the governing equations.\n\nWe begin with the compressible momentum equation in a rotating frame,\n$$\n\\frac{D \\boldsymbol{v}}{D t} + 2 \\boldsymbol{\\Omega} \\times \\boldsymbol{v} = - \\frac{1}{\\rho} \\nabla p + \\boldsymbol{g} + \\boldsymbol{F},\n$$\nthe continuity equation,\n$$\n\\frac{D \\rho}{D t} + \\rho \\, \\nabla \\cdot \\boldsymbol{v} = 0,\n$$\nand the thermodynamic equation for potential temperature,\n$$\n\\frac{D \\theta}{D t} = \\dot{\\theta}.\n$$\nTaking the material derivative of $q$ gives\n$$\n\\frac{D q}{D t} = \\frac{D}{D t}\\left( \\frac{1}{\\rho} \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\theta \\right)\n= \\frac{1}{\\rho} \\frac{D \\boldsymbol{\\omega}_{a}}{D t} \\cdot \\nabla \\theta + \\frac{1}{\\rho} \\boldsymbol{\\omega}_{a} \\cdot \\frac{D (\\nabla \\theta)}{D t} - \\frac{q}{\\rho} \\frac{D \\rho}{D t}.\n$$\nUsing the continuity equation to replace $D \\rho / D t = - \\rho \\, \\nabla \\cdot \\boldsymbol{v}$, the last term becomes $q \\, \\nabla \\cdot \\boldsymbol{v}$. The material derivative of the gradient is\n$$\n\\frac{D (\\nabla \\theta)}{D t} = \\nabla \\left( \\frac{D \\theta}{D t} \\right) - (\\nabla \\boldsymbol{v})^{\\top} \\cdot \\nabla \\theta = \\nabla \\dot{\\theta} - (\\nabla \\boldsymbol{v})^{\\top} \\cdot \\nabla \\theta.\n$$\nThe absolute vorticity evolution can be written (using a standard vorticity identity for compressible flow in a rotating frame with non-conservative force per unit mass $\\boldsymbol{F}$),\n$$\n\\frac{D \\boldsymbol{\\omega}_{a}}{D t} = (\\boldsymbol{\\omega}_{a} \\cdot \\nabla) \\boldsymbol{v} - \\boldsymbol{\\omega}_{a} \\, \\nabla \\cdot \\boldsymbol{v} + \\frac{1}{\\rho^{2}} \\nabla \\rho \\times \\nabla p + \\nabla \\times \\boldsymbol{F}.\n$$\nSubstituting these into $Dq/Dt$ and collecting terms yields\n$$\n\\frac{D q}{D t}\n= \\frac{1}{\\rho} \\left[ \\left( (\\boldsymbol{\\omega}_{a} \\cdot \\nabla) \\boldsymbol{v} - \\boldsymbol{\\omega}_{a} \\, \\nabla \\cdot \\boldsymbol{v} + \\frac{1}{\\rho^{2}} \\nabla \\rho \\times \\nabla p + \\nabla \\times \\boldsymbol{F} \\right) \\cdot \\nabla \\theta \\right]\n+ \\frac{1}{\\rho} \\boldsymbol{\\omega}_{a} \\cdot \\left( \\nabla \\dot{\\theta} - (\\nabla \\boldsymbol{v})^{\\top} \\cdot \\nabla \\theta \\right)\n+ q \\, \\nabla \\cdot \\boldsymbol{v}.\n$$\nUse the identity\n$$\n\\left( (\\boldsymbol{\\omega}_{a} \\cdot \\nabla) \\boldsymbol{v} \\right) \\cdot \\nabla \\theta\n= \\boldsymbol{\\omega}_{a} \\cdot \\left( (\\nabla \\boldsymbol{v})^{\\top} \\cdot \\nabla \\theta \\right),\n$$\nwhich cancels the corresponding term from $\\boldsymbol{\\omega}_{a} \\cdot \\left( - (\\nabla \\boldsymbol{v})^{\\top} \\cdot \\nabla \\theta \\right)$. Likewise, the compressibility terms cancel: $-(\\boldsymbol{\\omega}_{a} \\, \\nabla \\cdot \\boldsymbol{v}) \\cdot \\nabla \\theta / \\rho + q \\, \\nabla \\cdot \\boldsymbol{v} = 0$, since $q = \\rho^{-1} \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\theta$. The baroclinic torque term $(\\rho^{-2} \\nabla \\rho \\times \\nabla p) \\cdot \\nabla \\theta$ vanishes for Ertel PV due to the definition of $\\theta$ as a monotonic function of entropy, which ensures $\\nabla \\rho \\times \\nabla p$ is orthogonal to $\\nabla \\theta$. Thus we obtain the standard Ertel PV tendency with diabatic and frictional sources:\n$$\n\\frac{D q}{D t} = \\frac{1}{\\rho} \\left( \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\dot{\\theta} + \\nabla \\theta \\cdot (\\nabla \\times \\boldsymbol{F}) \\right).\n$$\n\nUnder the stated assumptions that the fields are uniform and constant over the time window, the net PV change over $\\Delta t$ is\n$$\n\\Delta q = \\left( \\frac{D q}{D t} \\right) \\Delta t.\n$$\nWe now evaluate the source terms numerically.\n\nFirst, compute the diabatic term:\n$$\n\\boldsymbol{\\omega}_{a} \\cdot \\nabla \\dot{\\theta}\n= (2.0 \\times 10^{-4})(4.0 \\times 10^{-11}) + (-1.0 \\times 10^{-4})(-2.0 \\times 10^{-11}) + (1.0 \\times 10^{-4})(-3.0 \\times 10^{-8}).\n$$\nEvaluate each product:\n$$\n(2.0 \\times 10^{-4})(4.0 \\times 10^{-11}) = 8.0 \\times 10^{-15},\n$$\n$$\n(-1.0 \\times 10^{-4})(-2.0 \\times 10^{-11}) = 2.0 \\times 10^{-15},\n$$\n$$\n(1.0 \\times 10^{-4})(-3.0 \\times 10^{-8}) = -3.0 \\times 10^{-12}.\n$$\nTherefore,\n$$\n\\boldsymbol{\\omega}_{a} \\cdot \\nabla \\dot{\\theta} = -2.99 \\times 10^{-12} \\ \\mathrm{K} \\ \\mathrm{s}^{-2} \\ \\mathrm{m}^{-1}.\n$$\n\nNext, compute the frictional term:\n$$\n\\nabla \\theta \\cdot (\\nabla \\times \\boldsymbol{F})\n= (1.5 \\times 10^{-5})(1.0 \\times 10^{-9}) + (-2.0 \\times 10^{-5})(-1.0 \\times 10^{-9}) + (1.2 \\times 10^{-2})(5.0 \\times 10^{-9}).\n$$\nEvaluate each product:\n$$\n(1.5 \\times 10^{-5})(1.0 \\times 10^{-9}) = 1.5 \\times 10^{-14},\n$$\n$$\n(-2.0 \\times 10^{-5})(-1.0 \\times 10^{-9}) = 2.0 \\times 10^{-14},\n$$\n$$\n(1.2 \\times 10^{-2})(5.0 \\times 10^{-9}) = 6.0 \\times 10^{-11}.\n$$\nTherefore,\n$$\n\\nabla \\theta \\cdot (\\nabla \\times \\boldsymbol{F}) = 6.0035 \\times 10^{-11} \\ \\mathrm{K} \\ \\mathrm{m}^{-1} \\ \\mathrm{s}^{-2}.\n$$\n\nCombine the two source terms and divide by $\\rho$:\n$$\n\\frac{D q}{D t} = \\frac{1}{\\rho} \\left[ \\boldsymbol{\\omega}_{a} \\cdot \\nabla \\dot{\\theta} + \\nabla \\theta \\cdot (\\nabla \\times \\boldsymbol{F}) \\right]\n= \\frac{1}{0.8} \\left( -2.99 \\times 10^{-12} + 6.0035 \\times 10^{-11} \\right).\n$$\nCompute the sum in the brackets:\n$$\n-2.99 \\times 10^{-12} + 6.0035 \\times 10^{-11} = 5.7045 \\times 10^{-11}.\n$$\nThus,\n$$\n\\frac{D q}{D t} = \\frac{5.7045 \\times 10^{-11}}{0.8} = 7.130625 \\times 10^{-11} \\ \\mathrm{K} \\ \\mathrm{m}^{2} \\ \\mathrm{kg}^{-1} \\ \\mathrm{s}^{-2}.\n$$\n\nOver $\\Delta t = 6$ hours $= 6 \\times 3600 = 21600 \\ \\mathrm{s}$, the net PV change is\n$$\n\\Delta q = \\left( 7.130625 \\times 10^{-11} \\right) \\times 21600 = 1.540215 \\times 10^{-6} \\ \\mathrm{K} \\ \\mathrm{m}^{2} \\ \\mathrm{kg}^{-1} \\ \\mathrm{s}^{-1}.\n$$\nConverting to Potential Vorticity Units (PVU), with $1 \\ \\mathrm{PVU} = 10^{-6} \\ \\mathrm{K} \\ \\mathrm{m}^{2} \\ \\mathrm{kg}^{-1} \\ \\mathrm{s}^{-1}$, gives\n$$\n\\Delta q = 1.540215 \\ \\mathrm{PVU}.\n$$\nRounded to three significant figures, the requested net PV change is\n$$\n\\Delta q = 1.54 \\ \\mathrm{PVU}.\n$$",
            "answer": "$$\\boxed{1.54}$$"
        }
    ]
}