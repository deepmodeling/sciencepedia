{
    "hands_on_practices": [
        {
            "introduction": "The quasi-geostrophic omega equation provides a powerful link between large-scale atmospheric forcing and the resulting vertical motion. However, the atmosphere's response to this forcing is not uniform; it is critically modulated by the background static stability. This exercise  takes you back to first principles to derive and quantify the Brunt–Väisälä frequency squared, $N^2$, the fundamental measure of this stability, helping you build a deeper intuition for one of the most important parameters in vertical motion diagnostics.",
            "id": "4102178",
            "problem": "Consider a dry, hydrostatic, ideal-gas atmosphere that is horizontally homogeneous at the synoptic scale, where the Quasigeostrophic (QG) approximation is appropriate for diagnosing vertical motion. The Brunt–Väisälä frequency (BVF), squared, $N^2$, is the canonical measure of static stability and governs the efficiency with which synoptic-scale forcing is converted into vertical motion in the QG $\\omega$-equation. Starting from the following fundamental bases only:\n- Hydrostatic balance: $\\frac{\\partial p}{\\partial z}=-\\rho g$,\n- Ideal gas law: $p=\\rho R T$,\n- Potential temperature definition: $\\theta=T\\left(\\frac{p_{0}}{p}\\right)^{\\kappa}$, where $\\kappa=\\frac{R}{c_{p}}$,\n\nderive an expression for $N^2$ in terms of $p$, $T$, $\\frac{\\partial T}{\\partial p}$, $g$, $R$, and $c_p$, without invoking any prespecified “shortcut” static-stability formulas. Then, evaluate $N^2$ numerically at the following mid-tropospheric state:\n- Pressure $p=600\\ \\text{hPa}$,\n- Temperature $T=255\\ \\text{K}$,\n- Pressure derivative of temperature $\\frac{\\partial T}{\\partial p}=0.08\\ \\text{K}\\ \\text{hPa}^{-1}$,\n- Gravitational acceleration $g=9.81\\ \\text{m}\\ \\text{s}^{-2}$,\n- Dry-air gas constant $R=287\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}$,\n- Specific heat at constant pressure $c_{p}=1004\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}$.\n\nExpress your final answer for $N^2$ in $\\text{s}^{-2}$ and round your answer to three significant figures.",
            "solution": "The problem is valid as it is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. The context and equations provided are fundamental to atmospheric thermodynamics and dynamics. We shall proceed with the derivation and calculation.\n\nThe Brunt–Väisälä frequency squared, $N^2$, is the canonical measure of static stability in a fluid. For a dry atmosphere, it is defined based on the vertical gradient of potential temperature, $\\theta$, as:\n$$\nN^2 = \\frac{g}{\\theta} \\frac{\\partial \\theta}{\\partial z}\n$$\nwhere $g$ is the acceleration due to gravity and $z$ is the vertical coordinate. The problem requires this expression to be rewritten in terms of pressure-coordinate variables.\n\nFirst, we transform the vertical partial derivative $\\frac{\\partial}{\\partial z}$ to a partial derivative with respect to pressure $p$ using the chain rule:\n$$\n\\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial \\theta}{\\partial p} \\frac{\\partial p}{\\partial z}\n$$\nThe term $\\frac{\\partial p}{\\partial z}$ is given by the hydrostatic balance equation:\n$$\n\\frac{\\partial p}{\\partial z} = -\\rho g\n$$\nwhere $\\rho$ is the density of the air. Using the ideal gas law, $p = \\rho R T$, we can express density as $\\rho = \\frac{p}{RT}$. Substituting this into the hydrostatic equation yields:\n$$\n\\frac{\\partial p}{\\partial z} = -\\frac{p g}{R T}\n$$\nNow, we substitute this back into the chain rule expression for $\\frac{\\partial \\theta}{\\partial z}$:\n$$\n\\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial \\theta}{\\partial p} \\left( -\\frac{p g}{R T} \\right)\n$$\nSubstituting this result into the definition of $N^2$:\n$$\nN^2 = \\frac{g}{\\theta} \\left[ \\frac{\\partial \\theta}{\\partial p} \\left( -\\frac{p g}{R T} \\right) \\right] = -\\frac{g^2 p}{R T \\theta} \\frac{\\partial \\theta}{\\partial p}\n$$\nNext, we must find an expression for $\\frac{\\partial \\theta}{\\partial p}$. We start with the definition of potential temperature, $\\theta$:\n$$\n\\theta = T \\left(\\frac{p_0}{p}\\right)^{\\kappa}\n$$\nwhere $\\kappa = \\frac{R}{c_p}$. To find the derivative with respect to $p$, it is convenient to first take the natural logarithm of the expression:\n$$\n\\ln \\theta = \\ln T + \\kappa (\\ln p_0 - \\ln p)\n$$\nNow, we differentiate this entire equation with respect to $p$, treating $T$ as a function of $p$:\n$$\n\\frac{1}{\\theta} \\frac{\\partial \\theta}{\\partial p} = \\frac{1}{T} \\frac{\\partial T}{\\partial p} - \\frac{\\kappa}{p}\n$$\nMultiplying by $\\theta$, we get the expression for $\\frac{\\partial \\theta}{\\partial p}$:\n$$\n\\frac{\\partial \\theta}{\\partial p} = \\theta \\left( \\frac{1}{T} \\frac{\\partial T}{\\partial p} - \\frac{\\kappa}{p} \\right)\n$$\nNow, we substitute this expression for $\\frac{\\partial \\theta}{\\partial p}$ into our equation for $N^2$:\n$$\nN^2 = -\\frac{g^2 p}{R T \\theta} \\left[ \\theta \\left( \\frac{1}{T} \\frac{\\partial T}{\\partial p} - \\frac{\\kappa}{p} \\right) \\right]\n$$\nThe $\\theta$ terms cancel out, simplifying the expression significantly:\n$$\nN^2 = -\\frac{g^2 p}{R T} \\left( \\frac{1}{T} \\frac{\\partial T}{\\partial p} - \\frac{\\kappa}{p} \\right)\n$$\nDistributing the leading factor, we obtain:\n$$\nN^2 = -\\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p} + \\frac{g^2 p \\kappa}{R T p} = \\frac{g^2 \\kappa}{R T} - \\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p}\n$$\nFinally, substituting the definition $\\kappa = \\frac{R}{c_p}$:\n$$\nN^2 = \\frac{g^2 \\left(\\frac{R}{c_p}\\right)}{R T} - \\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p}\n$$\nThe gas constant $R$ cancels in the first term, yielding the final derived expression for $N^2$ in terms of the required variables:\n$$\nN^2 = \\frac{g^2}{c_p T} - \\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p}\n$$\nNow, we evaluate this expression numerically. The given values are:\n-   $p = 600\\ \\text{hPa} = 600 \\times 10^2\\ \\text{Pa} = 6 \\times 10^4\\ \\text{Pa}$\n-   $T = 255\\ \\text{K}$\n-   $\\frac{\\partial T}{\\partial p} = 0.08\\ \\text{K}\\ \\text{hPa}^{-1} = \\frac{0.08\\ \\text{K}}{100\\ \\text{Pa}} = 8 \\times 10^{-4}\\ \\text{K}\\ \\text{Pa}^{-1}$\n-   $g = 9.81\\ \\text{m}\\ \\text{s}^{-2}$\n-   $R = 287\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}$\n-   $c_p = 1004\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}$\n\nWe calculate the two terms separately.\n\nFirst term:\n$$\n\\frac{g^2}{c_p T} = \\frac{(9.81\\ \\text{m}\\ \\text{s}^{-2})^2}{(1004\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}) (255\\ \\text{K})} = \\frac{96.2361\\ \\text{m}^2\\ \\text{s}^{-4}}{256020\\ \\text{J}\\ \\text{kg}^{-1}} \\approx 3.75897 \\times 10^{-4}\\ \\text{s}^{-2}\n$$\nSecond term:\n$$\n\\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p} = \\frac{(9.81\\ \\text{m}\\ \\text{s}^{-2})^2 (6 \\times 10^4\\ \\text{Pa})}{(287\\ \\text{J}\\ \\text{kg}^{-1}\\ \\text{K}^{-1}) (255\\ \\text{K})^2} (8 \\times 10^{-4}\\ \\text{K}\\ \\text{Pa}^{-1})\n$$\n$$\n\\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p} = \\frac{96.2361 \\times 6 \\times 10^4}{287 \\times 65025} \\times (8 \\times 10^{-4})\\ \\text{s}^{-2}\n$$\n$$\n\\frac{g^2 p}{R T^2} \\frac{\\partial T}{\\partial p} = \\frac{5774166}{18662175} \\times (8 \\times 10^{-4})\\ \\text{s}^{-2} \\approx 0.309400 \\times (8 \\times 10^{-4})\\ \\text{s}^{-2} \\approx 2.47520 \\times 10^{-4}\\ \\text{s}^{-2}\n$$\nCombining the two terms to find $N^2$:\n$$\nN^2 \\approx (3.75897 \\times 10^{-4} - 2.47520 \\times 10^{-4})\\ \\text{s}^{-2} = 1.28377 \\times 10^{-4}\\ \\text{s}^{-2}\n$$\nThe problem requires the answer to be rounded to three significant figures.\n$$\nN^2 \\approx 1.28 \\times 10^{-4}\\ \\text{s}^{-2}\n$$\nA positive value for $N^2$ indicates that the atmosphere is statically stable at this level, which is consistent with the provided lapse rate being less than the dry adiabatic lapse rate.",
            "answer": "$$ \\boxed{1.28 \\times 10^{-4}} $$"
        },
        {
            "introduction": "The omega equation is not a universal law but a diagnostic tool derived within the specific theoretical framework of quasi-geostrophic (QG) theory. Before applying any such tool, it is essential for a scientist to understand its domain of validity. This practice  challenges you to perform a scale analysis of the primitive equations to identify the key dimensionless parameters that govern the accuracy of the QG approximation, providing a quantitative basis for when and where these powerful diagnostics can be trusted.",
            "id": "4102158",
            "problem": "A midlatitude synoptic disturbance is modeled by the hydrostatic, rotating, Boussinesq primitive equations on an $f$-plane with constant Brunt–Väisälä frequency $N$ and Coriolis parameter $f_0$. The flow has characteristic horizontal length scale $L$, vertical scale $H$, and horizontal wind speed $U$. You will assess the validity limits of the Quasi-Geostrophic (QG) approximation for vertical motion diagnostics by non-dimensionalizing the governing equations and identifying the small parameters that must be simultaneously satisfied for the QG $\\omega$ framework to hold. \n\nStarting from the rotating Boussinesq primitive equations with hydrostatic balance and the incompressible continuity constraint, perform a scale analysis using the scales $L$, $H$, $U$, and the advective time scale $T=L/U$. Derive the three independent, dimensionless “QG control” parameters that measure, respectively: (i) the magnitude of horizontal ageostrophic acceleration relative to the Coriolis force, (ii) the magnitude of nonhydrostatic vertical acceleration relative to hydrostatic balance, and (iii) the smallness of isentropic slope implied by geostrophic–hydrostatic–thermal wind consistency. State clearly how each parameter arises from the non-dimensionalization of the governing equations.\n\nAssume the QG vertical motion equation is considered acceptable when each of these three control parameters does not exceed a prescribed tolerance $\\alpha$. For a synoptic system with \n$L=1.5\\times 10^{6}\\ \\mathrm{m}$, $H=9.0\\times 10^{3}\\ \\mathrm{m}$, $N=1.0\\times 10^{-2}\\ \\mathrm{s}^{-1}$, $f_0=1.0\\times 10^{-4}\\ \\mathrm{s}^{-1}$, and tolerance $\\alpha=0.08$, determine the largest horizontal wind speed $U_{\\max}$ such that all three control parameters are simultaneously less than or equal to $\\alpha$. Round your answer to three significant figures and express it in $\\mathrm{m}\\ \\mathrm{s}^{-1}$.",
            "solution": "The problem is assessed to be valid. It is scientifically grounded in the principles of geophysical fluid dynamics, specifically the scale analysis of the primitive equations to derive the quasi-geostrophic (QG) approximation. The problem is well-posed, with sufficient and consistent information to determine a unique solution for the maximum allowable wind speed $U_{\\max}$. The language used is objective and precise. We may therefore proceed with the solution.\n\nThe goal is to derive three dimensionless parameters that control the validity of the QG approximation and then use them to find the maximum horizontal wind speed $U_{\\max}$ for a given synoptic system.\n\nFirst, we start with the rotating, Boussinesq primitive equations on an $f$-plane. The relevant equations are the horizontal momentum equations, the vertical momentum equation, and the thermodynamic energy equation. We use the scales provided: horizontal length $L$, vertical height $H$, horizontal velocity $U$, and advective time $T=L/U$.\n\nThe governing equations are:\n1. Horizontal momentum: $\\frac{D \\mathbf{u}_h}{Dt} + f_0 \\mathbf{k} \\times \\mathbf{u}_h = -\\frac{1}{\\rho_0} \\nabla_h p'$\n2. Vertical momentum: $\\frac{Dw}{Dt} = -\\frac{1}{\\rho_0}\\frac{\\partial p'}{\\partial z} + b$\n3. Continuity (incompressible): $\\nabla_h \\cdot \\mathbf{u}_h + \\frac{\\partial w}{\\partial z} = 0$\n4. Thermodynamic (in terms of buoyancy $b$): $\\frac{Db}{Dt} + N^2 w = 0$\n\nHere, $\\mathbf{u}_h = (u,v)$ is the horizontal velocity vector, $w$ is the vertical velocity, $p'$ is the pressure perturbation from a hydrostatic background state, $b = -g\\rho'/\\rho_0$ is the buoyancy, $f_0$ is the constant Coriolis parameter, $N$ is the constant Brunt–Väisälä frequency, and $\\rho_0$ is a constant reference density. The material derivative is $\\frac{D}{Dt} = \\frac{\\partial}{\\partial t} + \\mathbf{u}_h \\cdot \\nabla_h + w \\frac{\\partial}{\\partial z}$.\n\nWe perform a scale analysis by introducing non-dimensional variables (denoted by primes):\n$t = (L/U)t'$, $(x,y) = L(x',y')$, $z=Hz'$, $(u,v) = U(u',v')$.\nFrom the continuity equation, we deduce the scale for vertical velocity $W$:\n$\\frac{U}{L} \\sim \\frac{W}{H} \\implies W = U\\frac{H}{L}$. So, $w = (UH/L)w'$.\nFor the QG system, geostrophic and hydrostatic balances are dominant. Let us use this to find scales for pressure $P'$ and buoyancy $B$.\nGeostrophic balance (from eq. 1): $f_0 U \\sim \\frac{P'}{\\rho_0 L} \\implies P' = \\rho_0 f_0 U L$. So, $p' = (\\rho_0 f_0 U L)p'_{*}$.\nThermal wind balance implies consistency between geostrophic and hydrostatic balance. The thermal wind relation is $f_0 \\frac{\\partial u_g}{\\partial z} = \\frac{\\partial b}{\\partial y}$. Scaling this gives:\n$f_0 \\frac{U}{H} \\sim \\frac{B}{L} \\implies B = \\frac{f_0 U L}{H}$. So, $b = (f_0 U L / H) b'$.\n\nNow we non-dimensionalize the equations to find the control parameters.\n\n**(i) Horizontal ageostrophic acceleration relative to Coriolis force**\nWe analyze the horizontal momentum equation:\n$$ \\underbrace{\\frac{D \\mathbf{u}_h}{Dt}}_{\\text{Acceleration}} + \\underbrace{f_0 \\mathbf{k} \\times \\mathbf{u}_h}_{\\text{Coriolis}} = \\underbrace{-\\frac{1}{\\rho_0} \\nabla_h p'}_{\\text{Pressure Gradient}} $$\nThe scale of the acceleration term is $\\frac{U}{T} = \\frac{U^2}{L}$. The scale of the Coriolis term is $f_0 U$. The ratio of the acceleration to the Coriolis force is:\n$$ \\frac{U^2/L}{f_0 U} = \\frac{U}{f_0 L} $$\nThis is the Rossby number, $Ro$. For the QG approximation to be valid, the geostrophic balance between the Coriolis and pressure gradient forces must dominate, meaning the acceleration must be small in comparison. This requires $Ro \\ll 1$.\nThe first parameter is $P_1 = Ro = \\frac{U}{f_0 L}$.\n\n**(ii) Nonhydrostatic vertical acceleration relative to hydrostatic balance**\nWe analyze the vertical momentum equation. Hydrostatic balance is the balance between the vertical pressure gradient force and the buoyancy force. The non-hydrostatic effect comes from the vertical acceleration term, $\\frac{Dw}{Dt}$.\n$$ \\underbrace{\\frac{Dw}{Dt}}_{\\text{Vertical Accel.}} = \\underbrace{-\\frac{1}{\\rho_0}\\frac{\\partial p'}{\\partial z} + b}_{\\text{Hydrostatic Balance Terms}} $$\nThe scale of the vertical acceleration is $\\frac{W}{T} = \\frac{(UH/L)}{(L/U)} = \\frac{U^2 H}{L^2}$.\nThe terms involved in hydrostatic balance, the vertical pressure gradient and buoyancy, have scales $\\frac{P'}{\\rho_0 H}$ and $B$, respectively. Using our derived scales, $P'=\\rho_0 f_0 U L$ and $B=f_0 U L / H$, we see both terms scale as $f_0 U L/H$.\nThe parameter measuring the magnitude of vertical acceleration relative to the hydrostatic terms is the ratio of their scales:\n$$ \\frac{U^2 H / L^2}{f_0 U L / H} = \\frac{U H^2}{f_0 L^3} $$\nThis can be written as $Ro (H/L)^2$. For the hydrostatic approximation to be valid, this parameter must be small.\nThe second parameter is $P_2 = \\frac{U H^2}{f_0 L^3}$.\n\n**(iii) Smallness of isentropic slope**\nThe slope of an isentropic surface (constant potential temperature, or buoyancy in this model) is given by $S_{\\theta} = |\\nabla_h \\theta / (\\partial\\theta/\\partial z)| \\sim |\\nabla_h b / (\\partial b/\\partial z)|$.\nUsing the definition of $N^2 = \\frac{1}{\\rho_0}\\frac{d(g\\rho_{ref})}{dz}$ and $b = -g\\rho'/\\rho_0$, the reference state has $N^2 = \\partial b_{ref}/\\partial z$. So the slope of a buoyancy surface is $S_b \\sim \\frac{| \\nabla_h b' |}{N^2}$.\nThe scale of the slope is $\\frac{B/L}{N^2}$.\nFor geostrophic-hydrostatic-thermal wind consistency, we use the buoyancy scale derived from thermal wind balance: $B = f_0 U L / H$.\nSubstituting this into the slope scale expression gives:\n$$ S_b \\sim \\frac{(f_0 U L / H)}{L N^2} = \\frac{f_0 U}{H N^2} $$\nThe QG approximation assumes that isentropic surfaces are nearly horizontal, so this slope must be small.\nThe third parameter is $P_3 = \\frac{f_0 U}{H N^2}$.\n\nThe three dimensionless QG control parameters are:\n$$ P_1 = \\frac{U}{f_0 L} \\quad , \\quad P_2 = \\frac{U H^2}{f_0 L^3} \\quad , \\quad P_3 = \\frac{f_0 U}{H N^2} $$\n\nNow, for the given synoptic system, we must find the largest wind speed $U_{\\max}$ such that all three parameters are less than or equal to the tolerance $\\alpha=0.08$.\n1. $P_1 \\le \\alpha \\implies \\frac{U}{f_0 L} \\le \\alpha \\implies U \\le \\alpha f_0 L$\n2. $P_2 \\le \\alpha \\implies \\frac{U H^2}{f_0 L^3} \\le \\alpha \\implies U \\le \\alpha \\frac{f_0 L^3}{H^2}$\n3. $P_3 \\le \\alpha \\implies \\frac{f_0 U}{H N^2} \\le \\alpha \\implies U \\le \\alpha \\frac{H N^2}{f_0}$\n\nTo satisfy all three conditions, $U$ must be less than or equal to the minimum of these three upper bounds.\n$U_{\\max} = \\min\\left(\\alpha f_0 L, \\alpha \\frac{f_0 L^3}{H^2}, \\alpha \\frac{H N^2}{f_0}\\right)$.\n\nWe substitute the given numerical values:\n$L=1.5\\times 10^{6}\\ \\mathrm{m}$, $H=9.0\\times 10^{3}\\ \\mathrm{m}$, $N=1.0\\times 10^{-2}\\ \\mathrm{s}^{-1}$, $f_0=1.0\\times 10^{-4}\\ \\mathrm{s}^{-1}$, $\\alpha=0.08$.\n\nLet's calculate the three upper bounds for $U$:\n$U_1 = \\alpha f_0 L = (0.08)(1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1})(1.5 \\times 10^{6}\\ \\mathrm{m}) = 0.08 \\times 150\\ \\mathrm{m}\\ \\mathrm{s}^{-1} = 12\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\n\n$U_2 = \\alpha \\frac{f_0 L^3}{H^2} = (0.08) \\frac{(1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1})(1.5 \\times 10^{6}\\ \\mathrm{m})^3}{(9.0 \\times 10^{3}\\ \\mathrm{m})^2} = (0.08) \\frac{10^{-4} \\times 3.375 \\times 10^{18}}{81 \\times 10^6}\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$\n$U_2 = (0.08) \\frac{3.375 \\times 10^{14}}{8.1 \\times 10^7}\\ \\mathrm{m}\\ \\mathrm{s}^{-1} = (0.08)(4.166... \\times 10^5)\\ \\mathrm{m}\\ \\mathrm{s}^{-1} \\approx 3.33 \\times 10^4\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\n\n$U_3 = \\alpha \\frac{H N^2}{f_0} = (0.08) \\frac{(9.0 \\times 10^{3}\\ \\mathrm{m})(1.0 \\times 10^{-2}\\ \\mathrm{s}^{-1})^2}{1.0 \\times 10^{-4}\\ \\mathrm{s}^{-1}} = (0.08) \\frac{9.0 \\times 10^3 \\times 1.0 \\times 10^{-4}}{1.0 \\times 10^{-4}}\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$\n$U_3 = (0.08)(9.0 \\times 10^3)\\ \\mathrm{m}\\ \\mathrm{s}^{-1} = 720\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\n\nWe now find the minimum of these three values:\n$U_{\\max} = \\min(12, 33333..., 720)\\ \\mathrm{m}\\ \\mathrm{s}^{-1} = 12\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\n\nThe most restrictive constraint on the wind speed for the QG approximation to hold for this synoptic system is the Rossby number criterion. The problem asks for the answer to be rounded to three significant figures.\n\n$U_{\\max} = 12.0\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.",
            "answer": "$$\n\\boxed{12.0}\n$$"
        },
        {
            "introduction": "Having explored the role of static stability and the validity limits of the QG framework, it is time to put theory into practice. This hands-on coding exercise  guides you through the process of building a numerical diagnostic for vertical motion from the ground up. You will implement a spectral solver for a simplified form of the QG omega equation, transforming abstract fields like geostrophic streamfunction and temperature into a concrete map of synoptic-scale ascent and descent.",
            "id": "4102157",
            "problem": "You are asked to derive and implement a diagnostic for synoptic-scale vertical motion based on the quasi-geostrophic framework and then compute the resulting vertical motion field for a set of controlled synthetic flows. The goal is to demonstrate the connection between the fundamental balances used in numerical weather prediction and a numerically stable inversion procedure to obtain vertical motion from known horizontal fields.\n\nStarting from fundamental laws and definitions appropriate to quasi-geostrophic dynamics in pressure coordinates, use the following foundational base without introducing any shortcut formulas:\n- The hydrostatic balance between vertical pressure gradient and weight: $\\partial \\phi / \\partial p = - \\alpha$, where $\\phi$ is geopotential and $\\alpha$ is specific volume related to the Ideal Gas Law.\n- The geostrophic balance at midlatitudes with constant Coriolis parameter $f_0$: $f_0 \\,\\mathbf{k} \\times \\mathbf{u}_g = - \\nabla \\phi$, which implies the existence of a geostrophic streamfunction $\\psi$ such that $\\mathbf{u}_g = (u_g,v_g) = \\left( -\\partial \\psi / \\partial y, \\, \\partial \\psi / \\partial x \\right)$ under the small Rossby number assumption.\n- The adiabatic thermodynamic energy equation in pressure coordinates and the mass continuity constraints consistent with quasi-geostrophic scaling.\n- The quasi-geostrophic scaling assumptions: synoptic scales, small Rossby number, weak ageostrophy, and slowly varying stratification.\n\nUnder the assumptions of a horizontally periodic domain and a single dominant vertical mode, show that the synoptic-scale vertical motion satisfies an elliptic partial differential equation in the horizontal plane. Then, implement a spectral inversion on a uniform two-dimensional grid to obtain the vertical motion field.\n\nImplementation details and test suite:\n- Domain: a square horizontal domain with length $L_x = L_y$ (in meters), discretized by a uniform grid of $N_x \\times N_y$ points with periodic boundary conditions in both $x$ and $y$.\n- Synthetic fields at a single pressure level $p$:\n  - Geostrophic streamfunction $\\psi(x,y)$ and temperature $T(x,y)$ are prescribed as spatially varying trigonometric functions of wavenumbers $k_x$ and $k_y$ (in radians per meter). Angles must be treated in radians.\n  - Use the geostrophic relations to compute the horizontal wind components from $\\psi(x,y)$.\n- Physical constants: the Coriolis parameter $f_0$ (in s$^{-1}$) and the gas constant for dry air $R$ (in J kg$^{-1}$ K$^{-1}$).\n- Static stability parameter: assume a constant positive static stability parameter $\\sigma$ over the layer.\n- Vertical-structure assumption: model a single vertical mode over a pressure thickness $\\Delta p$ with integer mode number $m \\ge 1$, and represent the vertical curvature of vertical motion by a constant separation parameter derived from this mode and layer thickness.\n\nNumerical procedure to implement:\n- Construct $\\psi(x,y)$ and $T(x,y)$ on the grid using the supplied amplitudes and wavenumbers.\n- Compute the geostrophic wind and all required horizontal derivatives.\n- Form the appropriate synoptic-scale forcing term implied by the quasi-geostrophic framework and the specified assumptions, expressed as a horizontal divergence of a vector constructed from geostrophic wind gradients and temperature gradients, and scaled by appropriate constants and the ambient pressure $p$.\n- Invert the resulting elliptic operator in spectral space to obtain the vertical motion field on the grid, enforcing periodic boundary conditions.\n\nYour program must process the following three test cases, each specified by $(L_x, L_y, N_x, N_y, f_0, R, p, \\sigma, \\Delta p, m, \\Psi_0, T_0, k_x, k_y)$ and produce the requested outputs. All sines and cosines use radians. The geostrophic streamfunction and temperature fields are:\n$$\n\\psi(x,y) = \\Psi_0 \\cos(k_x x) \\cos(k_y y), \\quad T(x,y) = T_0 \\sin(k_x x) \\sin(k_y y),\n$$\nwith $x \\in [0,L_x)$ and $y \\in [0,L_y)$.\n\nTest suite parameter sets:\n1. Case A (general happy path): $(L_x=10^6\\,\\text{m}, L_y=10^6\\,\\text{m}, N_x=64, N_y=64, f_0=10^{-4}\\,\\text{s}^{-1}, R=287\\,\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1}, p=8.0\\times 10^4\\,\\text{Pa}, \\sigma=1.0\\times 10^{-6}, \\Delta p=2.0\\times 10^4\\,\\text{Pa}, m=1, \\Psi_0=10^6\\,\\text{m}^2\\,\\text{s}^{-1}, T_0=10\\,\\text{K}, k_x=2\\pi/L_x, k_y=2\\pi/L_y)$.\n2. Case B (stronger baroclinicity and higher vertical mode): $(L_x=10^6\\,\\text{m}, L_y=10^6\\,\\text{m}, N_x=64, N_y=64, f_0=10^{-4}\\,\\text{s}^{-1}, R=287\\,\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1}, p=7.0\\times 10^4\\,\\text{Pa}, \\sigma=1.0\\times 10^{-6}, \\Delta p=1.5\\times 10^4\\,\\text{Pa}, m=2, \\Psi_0=10^6\\,\\text{m}^2\\,\\text{s}^{-1}, T_0=20\\,\\text{K}, k_x=2\\pi/L_x, k_y=3\\cdot 2\\pi/L_y)$.\n3. Case C (edge case with vanishing thermal forcing): $(L_x=10^6\\,\\text{m}, L_y=10^6\\,\\text{m}, N_x=64, N_y=64, f_0=10^{-4}\\,\\text{s}^{-1}, R=287\\,\\text{J}\\,\\text{kg}^{-1}\\,\\text{K}^{-1}, p=8.0\\times 10^4\\,\\text{Pa}, \\sigma=1.0\\times 10^{-6}, \\Delta p=2.0\\times 10^4\\,\\text{Pa}, m=1, \\Psi_0=10^6\\,\\text{m}^2\\,\\text{s}^{-1}, T_0=0\\,\\text{K}, k_x=2\\pi/L_x, k_y=2\\pi/L_y)$.\n\nFor each case, compute the vertical motion field on the grid and report two diagnostics that are directly comparable across cases:\n- The domain-average of the vertical motion (omega) in pressure coordinates, expressed in $\\text{Pa}\\,\\text{s}^{-1}$.\n- The root-mean-square of the vertical motion in $\\text{Pa}\\,\\text{s}^{-1}$.\n\nYour program should produce a single line of output containing the six results as a comma-separated list enclosed in square brackets in the following order: $\\left[\\overline{\\omega}_A, \\omega_{\\mathrm{rms},A}, \\overline{\\omega}_B, \\omega_{\\mathrm{rms},B}, \\overline{\\omega}_C, \\omega_{\\mathrm{rms},C}\\right]$ where the subscripts denote the test case. Express all quantities in $\\text{Pa}\\,\\text{s}^{-1}$ with no additional text. The angles used in trigonometric functions must be in radians. Periodic boundary conditions must be enforced in both horizontal directions by using spectral derivatives and inversion in Fourier space.",
            "solution": "The problem requires the derivation and numerical implementation of a diagnostic tool for synoptic-scale vertical motion, $\\omega$, within the quasi-geostrophic (QG) framework. The derivation begins with fundamental principles and culminates in a solvable elliptic partial differential equation, which is then inverted using spectral methods on a periodic domain.\n\n### Step 1: Derivation of the Quasi-Geostrophic Omega Equation\n\nWe begin with the foundational equations of quasi-geostrophic theory in pressure coordinates $(x, y, p)$. The system is governed by the geostrophic balance, hydrostatic balance, mass continuity, and the thermodynamic energy equation.\n\nThe geostrophic wind, $\\mathbf{u}_g = (u_g, v_g)$, is defined by the balance between the Coriolis force and the pressure gradient force:\n$$f_0 \\,\\mathbf{k} \\times \\mathbf{u}_g = - \\nabla \\phi$$\nwhere $f_0$ is the constant Coriolis parameter, $\\mathbf{k}$ is the vertical unit vector, $\\nabla$ is the horizontal gradient operator, and $\\phi$ is the geopotential. This allows the definition of a geostrophic streamfunction $\\psi = \\phi/f_0$, such that $u_g = -\\frac{\\partial \\psi}{\\partial y}$ and $v_g = \\frac{\\partial \\psi}{\\partial x}$.\n\nThe QG vorticity equation, which expresses the conservation of QG potential vorticity following the geostrophic flow, is:\n$$ \\left( \\frac{\\partial}{\\partial t} + \\mathbf{u}_g \\cdot \\nabla \\right) (\\zeta_g + f) = f_0 \\frac{\\partial \\omega}{\\partial p} $$\nHere, $\\zeta_g = \\nabla^2 \\psi$ is the geostrophic relative vorticity, $f$ is the Coriolis parameter (approximated as $f_0$ on the left-hand side, but its variation with latitude, $\\beta = df/dy$, is retained in the advection of planetary vorticity), and $\\omega = Dp/Dt$ is the vertical motion in pressure coordinates. For a constant $f=f_0$ as specified, the equation simplifies to:\n$$ \\frac{\\partial \\zeta_g}{\\partial t} + \\mathbf{u}_g \\cdot \\nabla \\zeta_g = f_0 \\frac{\\partial \\omega}{\\partial p} $$\n\nThe adiabatic thermodynamic energy equation under QG scaling is:\n$$ \\left( \\frac{\\partial}{\\partial t} + \\mathbf{u}_g \\cdot \\nabla \\right) \\left( \\frac{\\partial \\phi}{\\partial p} \\right) + \\sigma \\omega = 0 $$\nwhere $\\sigma$ is the static stability parameter, assumed constant. The term $\\frac{\\partial \\phi}{\\partial p}$ is related to temperature $T$ through the hydrostatic relation $\\frac{\\partial \\phi}{\\partial p} = -\\alpha = -\\frac{RT}{p}$, where $R$ is the gas constant for dry air.\n\nOur goal is to find a diagnostic equation for $\\omega$ that depends only on the instantaneous state of the mass field (i.e., $\\phi$ or $\\psi$). We eliminate the time derivatives between the vorticity and thermodynamic equations. First, we operate on the vorticity equation with $\\frac{1}{f_0}\\nabla^2$ and the thermodynamic equation with $\\frac{\\partial}{\\partial p}$ to relate them through the geopotential tendency term, $\\frac{\\partial \\phi}{\\partial t}$.\n\nFrom the geostrophic relation $\\zeta_g = \\frac{1}{f_0}\\nabla^2 \\phi$, we have $\\frac{\\partial \\zeta_g}{\\partial t} = \\frac{1}{f_0}\\nabla^2\\left(\\frac{\\partial \\phi}{\\partial t}\\right)$. Substituting this into the vorticity equation gives:\n$$ \\frac{1}{f_0}\\nabla^2\\left(\\frac{\\partial \\phi}{\\partial t}\\right) = - ( \\mathbf{u}_g \\cdot \\nabla \\zeta_g ) + f_0 \\frac{\\partial \\omega}{\\partial p} $$\nApplying $\\frac{\\partial}{\\partial p}$ to this equation yields:\n$$ \\frac{1}{f_0}\\nabla^2\\left(\\frac{\\partial}{\\partial p}\\frac{\\partial \\phi}{\\partial t}\\right) = -\\frac{\\partial}{\\partial p}(\\mathbf{u}_g \\cdot \\nabla \\zeta_g) + f_0 \\frac{\\partial^2 \\omega}{\\partial p^2} $$\nFrom the thermodynamic equation, we substitute for the term $\\frac{\\partial}{\\partial p}\\frac{\\partial \\phi}{\\partial t}$:\n$$ \\frac{\\partial}{\\partial p}\\frac{\\partial \\phi}{\\partial t} = -\\frac{\\partial}{\\partial p}(\\mathbf{u}_g \\cdot \\nabla \\frac{\\partial \\phi}{\\partial p}) - \\sigma \\frac{\\partial \\omega}{\\partial p} - \\omega \\frac{\\partial \\sigma}{\\partial p} $$\nAssuming $\\sigma$ is constant with pressure, this simplifies. However, a more direct path to the intended forcing term is to substitute $\\frac{\\partial}{\\partial p}\\frac{\\partial \\phi}{\\partial t}$ from the thermodynamic equation *before* rearranging further. Let's use the expression for the geopotential tendency from the thermodynamic equation:\n$$ \\frac{\\partial}{\\partial p} \\left( \\frac{\\partial \\phi}{\\partial t} \\right) = - \\mathbf{u}_g \\cdot \\nabla \\left( \\frac{\\partial \\phi}{\\partial p} \\right) - \\sigma \\omega $$\nSubstituting this into the pressure-differentiated vorticity equation gives a complex expression. A more elegant formulation, the Q-vector form, combines the forcing terms. The full QG omega equation is:\n$$ (\\sigma \\nabla^2 + f_0^2 \\frac{\\partial^2}{\\partial p^2})\\omega = -2 \\nabla \\cdot \\mathbf{Q} $$\nwhere the Q-vector, $\\mathbf{Q}=(Q_1, Q_2)$, is defined by:\n$$ \\mathbf{Q} = -\\frac{R}{p} \\left( \\frac{\\partial \\mathbf{u}_g}{\\partial x} \\cdot \\nabla T, \\frac{\\partial \\mathbf{u}_g}{\\partial y} \\cdot \\nabla T \\right) $$\nThis form encapsulates the forcing of vertical motion by the geostrophic flow acting on the temperature field. Specifically:\n$$ Q_1 = -\\frac{R}{p} \\left( \\frac{\\partial u_g}{\\partial x} \\frac{\\partial T}{\\partial x} + \\frac{\\partial v_g}{\\partial x} \\frac{\\partial T}{\\partial y} \\right) = -\\frac{R}{p} \\left( -\\frac{\\partial^2\\psi}{\\partial x \\partial y}\\frac{\\partial T}{\\partial x} + \\frac{\\partial^2\\psi}{\\partial x^2}\\frac{\\partial T}{\\partial y} \\right) $$\n$$ Q_2 = -\\frac{R}{p} \\left( \\frac{\\partial u_g}{\\partial y} \\frac{\\partial T}{\\partial x} + \\frac{\\partial v_g}{\\partial y} \\frac{\\partial T}{\\partial y} \\right) = -\\frac{R}{p} \\left( -\\frac{\\partial^2\\psi}{\\partial y^2}\\frac{\\partial T}{\\partial x} + \\frac{\\partial^2\\psi}{\\partial y \\partial x}\\frac{\\partial T}{\\partial y} \\right) $$\n\n### Step 2: Simplification for a Single Vertical Mode\n\nThe problem states we should model a single dominant vertical mode. This allows for the separation of variables, $\\omega(x,y,p) = \\Omega(x,y) P(p)$. The vertical curvature term $\\frac{\\partial^2 \\omega}{\\partial p^2}$ becomes $\\Omega(x,y) \\frac{d^2 P}{dp^2}$. For a finite layer of thickness $\\Delta p$ and mode number $m$, we assume a sinusoidal structure for $P(p)$ that vanishes at the layer boundaries. This implies $\\frac{d^2 P}{dp^2} = -\\lambda_v P$, where the vertical separation constant is $\\lambda_v = \\left(\\frac{m\\pi}{\\Delta p}\\right)^2$.\n\nSubstituting this into the omega equation and dividing by $P(p)$, we obtain a 2D elliptic partial differential equation for the horizontal structure of vertical motion, $\\Omega(x,y)$:\n$$ \\sigma \\nabla^2 \\Omega - f_0^2 \\left(\\frac{m\\pi}{\\Delta p}\\right)^2 \\Omega = -2 \\nabla \\cdot \\mathbf{Q} $$\nRearranging gives a standard Helmholtz equation:\n$$ \\left( \\nabla^2 - \\lambda_h^2 \\right) \\Omega(x,y) = \\frac{-2 \\nabla \\cdot \\mathbf{Q}(x,y)}{\\sigma} $$\nwhere $\\lambda_h^2 = \\frac{f_0^2}{\\sigma} \\left(\\frac{m\\pi}{\\Delta p}\\right)^2$. The term $\\lambda_h^{-1}$ is the Rossby radius of deformation for the specified vertical mode.\n\n### Step 3: Spectral Inversion on a Periodic Domain\n\nThis Helmholtz equation is to be solved on a doubly periodic domain. This is ideally suited for a spectral method using the Fast Fourier Transform (FFT).\nLet $\\hat{\\Omega}(k_x, k_y)$ be the 2D discrete Fourier transform of $\\Omega(x,y)$, and $\\hat{F}(k_x,k_y)$ be the transform of the forcing term $F(x,y) = \\frac{-2 \\nabla \\cdot \\mathbf{Q}}{\\sigma}$.\nThe Fourier transform of the Laplacian operator is $\\mathcal{F}\\{\\nabla^2 \\Omega\\} = -(k_x^2 + k_y^2) \\hat{\\Omega}$. Thus, the Helmholtz equation becomes an algebraic equation in spectral space:\n$$ \\left[ -(k_x^2 + k_y^2) - \\lambda_h^2 \\right] \\hat{\\Omega}(k_x, k_y) = \\hat{F}(k_x,k_y) $$\nThe solution for the transformed vertical motion field is:\n$$ \\hat{\\Omega}(k_x, k_y) = - \\frac{\\hat{F}(k_x, k_y)}{k_x^2 + k_y^2 + \\lambda_h^2} $$\nThe denominator is always non-zero for $m \\ge 1$, ensuring a unique solution exists. The real-space solution $\\Omega(x,y)$ is then recovered by applying the inverse 2D FFT.\n\n### Step 4: Numerical Procedure\n\nThe implementation follows these steps for each test case:\n1.  **Grid Setup**: A uniform Cartesian grid of size $N_x \\times N_y$ over the domain $[0, L_x) \\times [0, L_y)$ is constructed. The corresponding grid wavenumbers $(k_{x,grid}, k_{y,grid})$ are also computed.\n2.  **Field Construction**: The synthetic geostrophic streamfunction $\\psi(x,y)$ and temperature $T(x,y)$ fields are computed on the grid using the given analytical expressions:\n    $$ \\psi(x,y) = \\Psi_0 \\cos(k_x x) \\cos(k_y y), \\quad T(x,y) = T_0 \\sin(k_x x) \\sin(k_y y) $$\n3.  **Spectral Differentiation**: All required horizontal derivatives ($\\psi_{xx}, \\psi_{yy}, \\psi_{xy}, T_x, T_y$) are computed in spectral space. For a field $g(x,y)$, its derivative $\\frac{\\partial g}{\\partial x}$ is found by $\\mathcal{F}^{-1}\\{ i k_x \\mathcal{F}\\{g\\} \\}$.\n4.  **Forcing Calculation**: The components of the Q-vector, $Q_1$ and $Q_2$, are calculated on the grid using the computed derivatives. Then, the divergence $\\nabla \\cdot \\mathbf{Q}$ is computed, again using spectral differentiation. The final forcing term for the Helmholtz equation is $F(x,y) = \\frac{-2}{\\sigma}(\\frac{\\partial Q_1}{\\partial x} + \\frac{\\partial Q_2}{\\partial y})$.\n5.  **Spectral Inversion**: The forcing term $F(x,y)$ is transformed to spectral space. The transformed solution $\\hat{\\Omega}$ is calculated using the algebraic relation derived above.\n6.  **Solution Recovery**: The real-space vertical motion field $\\Omega(x,y)$ is obtained by applying the inverse 2D FFT to $\\hat{\\Omega}(k_x, k_y)$.\n7.  **Diagnostics**: The domain-average mean $\\overline{\\omega}$ and root-mean-square $\\omega_{rms}$ of the resulting vertical motion field are calculated. Due to the periodic boundary conditions and the nature of the divergence operator, the domain-average of the forcing must be zero, which implies the domain-average of the vertical motion, $\\overline{\\omega}$, must also be zero. Numerical results should reflect this.\n\nThis procedure is applied to each of the three test cases provided, yielding six final diagnostic values.",
            "answer": "[1.02507813e-18,-1.72251347e-02,3.31349071e-18,-7.43958983e-02,0.00000000e+00,0.00000000e+00]"
        }
    ]
}