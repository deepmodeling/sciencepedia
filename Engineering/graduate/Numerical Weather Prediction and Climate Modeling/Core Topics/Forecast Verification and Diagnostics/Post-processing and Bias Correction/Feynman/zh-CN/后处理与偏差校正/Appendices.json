{
    "hands_on_practices": [
        {
            "introduction": "线性回归是校正模式预报系统性偏差的一种基本且广泛应用的方法，通常被称为模式输出统计（MOS）。本练习不仅要求您应用形如 $y \\approx a + b f$ 的线性模型 ，更关键的是，通过检查残差的结构来诊断其局限性。这是任何统计建模过程中的关键步骤，有助于我们判断一个简单的线性模型是否足以描述预报与观测之间的复杂关系。",
            "id": "4076566",
            "problem": "在数值天气预报（NWP）的后处理中，预报到观测的偏差订正通常被建模为一个线性映射，形式为 $y \\approx a + b f$，其中 $f$ 表示原始模式预报，$y$ 表示检验观测值。在模式输出统计（MOS）中，参数 $a$ 和 $b$ 通过最小二乘法进行估计。从最小化误差平方和的原理出发，推导以样本统计量表示的最小二乘估计量，然后对以下数据集进行评估。在计算线性拟合后，通过量化残差 $r_i$ 与中心化预报的平方 $s_i = (f_i - \\bar{f})^{2}$ 之间的线性关联，来检查残差结构以诊断非线性。\n\n使用以下 $n = 10$ 组关于2米温度的配对值 $\\{(f_i, y_i)\\}_{i=1}^{10}$，其中 $f_i$ 是以开尔文为单位的预报值，$y_i$ 是以开尔文为单位的检验观测值：\n$\\{(f_i, y_i)\\}_{i=1}^{10} = \\{(275, 274), (280, 277.5), (285, 282), (290, 287.5), (295, 294), (275, 274), (280, 277.5), (285, 282), (290, 287.5), (295, 294)\\}$.\n\n您的任务是：\n1. 从最小二乘准则以及样本均值、样本方差和样本协方差的核心定义出发，推导以样本统计量表示的估计量 $\\hat{a}$ 和 $\\hat{b}$，并为给定数据集计算它们的数值。将 $\\hat{a}$ 以开尔文表示，$\\hat{b}$ 为无量纲量。\n2. 计算残差 $r_i = y_i - (\\hat{a} + \\hat{b} f_i)$ 与中心化预报的平方 $s_i = (f_i - \\bar{f})^{2}$ 之间的皮尔逊相关系数 $D$。在偏差订正中诊断非线性的背景下，解释 $D$ 的大小和符号。\n\n如果数值答案需要四舍五入，请保留四位有效数字。将 $\\hat{a}$ 以开尔文表示，$\\hat{b}$ 和 $D$ 为无量纲量。提供 $\\hat{a}$、$\\hat{b}$ 和 $D$ 的最终数值。",
            "solution": "本题要求针对给定的气象预报和观测数据集，推导和计算线性回归参数，然后进行残差分析以诊断非线性。该过程将按要求分两部分进行。\n\n### 第1部分：最小二乘估计量的推导与计算\n\n线性模型为 $y \\approx a + b f$。参数 $a$ 和 $b$ 通过最小化误差平方和（SSE）$S(a, b)$ 来估计。\n\n**1. 估计量的推导**\n\nSSE 定义为：\n$$S(a,b) = \\sum_{i=1}^{n} (y_i - (a + b f_i))^2$$\n为了找到使 $S$ 最小化的 $a$ 和 $b$ 的值，我们对 $S$ 分别求关于 $a$ 和 $b$ 的偏导数，并令它们等于零。得到的估计量记为 $\\hat{a}$ 和 $\\hat{b}$。\n\n关于 $a$ 的一阶偏导数为：\n$$\\frac{\\partial S}{\\partial a} = \\sum_{i=1}^{n} 2(y_i - a - b f_i)(-1) = -2 \\sum_{i=1}^{n} (y_i - a - b f_i)$$\n令 $\\frac{\\partial S}{\\partial a} = 0$：\n$$\\sum_{i=1}^{n} (y_i - \\hat{a} - \\hat{b} f_i) = 0$$\n$$\\sum y_i - n\\hat{a} - \\hat{b}\\sum f_i = 0$$\n两边同除以样本量 $n$，并使用样本均值的定义 $\\bar{y} = \\frac{1}{n}\\sum y_i$ 和 $\\bar{f} = \\frac{1}{n}\\sum f_i$：\n$$\\bar{y} - \\hat{a} - \\hat{b}\\bar{f} = 0$$\n这给出了用斜率估计量 $\\hat{b}$ 表示的截距估计量 $\\hat{a}$：\n$$\\hat{a} = \\bar{y} - \\hat{b}\\bar{f}$$\n\n关于 $b$ 的一阶偏导数为：\n$$\\frac{\\partial S}{\\partial b} = \\sum_{i=1}^{n} 2(y_i - a - b f_i)(-f_i) = -2 \\sum_{i=1}^{n} f_i(y_i - a - b f_i)$$\n令 $\\frac{\\partial S}{\\partial b} = 0$：\n$$\\sum_{i=1}^{n} f_i(y_i - \\hat{a} - \\hat{b} f_i) = 0$$\n代入 $\\hat{a}$ 的表达式：\n$$\\sum_{i=1}^{n} f_i(y_i - (\\bar{y} - \\hat{b}\\bar{f}) - \\hat{b} f_i) = 0$$\n$$\\sum_{i=1}^{n} f_i((y_i - \\bar{y}) - \\hat{b}(f_i - \\bar{f})) = 0$$\n$$\\sum_{i=1}^{n} f_i(y_i - \\bar{y}) - \\hat{b}\\sum_{i=1}^{n} f_i(f_i - \\bar{f}) = 0$$\n解出 $\\hat{b}$：\n$$\\hat{b} = \\frac{\\sum f_i(y_i - \\bar{y})}{\\sum f_i(f_i - \\bar{f})}$$\n分子和分母可以简化为用中心化变量表示的更标准的形式：\n$\\sum (f_i - \\bar{f})(y_i - \\bar{y}) = \\sum (f_iy_i - f_i\\bar{y} - \\bar{f}y_i + \\bar{f}\\bar{y}) = \\sum f_iy_i - \\bar{y}\\sum f_i - \\bar{f}\\sum y_i + n\\bar{f}\\bar{y} = \\sum f_iy_i - n\\bar{f}\\bar{y} - n\\bar{f}\\bar{y} + n\\bar{f}\\bar{y} = \\sum f_iy_i - n\\bar{f}\\bar{y}$。\n同时，$\\sum f_i(y_i - \\bar{y}) = \\sum f_iy_i - \\bar{y}\\sum f_i = \\sum f_iy_i - n\\bar{f}\\bar{y}$。\n所以，$\\sum_i (f_i - \\bar{f})(y_i - \\bar{y}) = \\sum_i f_i(y_i - \\bar{y})$。类似地，$\\sum_i (f_i - \\bar{f})^2 = \\sum_i f_i(f_i - \\bar{f})$。\n这给出了 $\\hat{b}$ 的标准表达式：\n$$\\hat{b} = \\frac{\\sum_{i=1}^{n}(f_i - \\bar{f})(y_i - \\bar{y})}{\\sum_{i=1}^{n}(f_i - \\bar{f})^2}$$\n这将 $\\hat{b}$ 表示为 $f$ 和 $y$ 的样本协方差（与分子成正比）和 $f$ 的样本方差（与分母成正比）的形式。具体来说，如果 $s_{fy} = \\frac{1}{n-1}\\sum(f_i - \\bar{f})(y_i - \\bar{y})$ 且 $s_f^2 = \\frac{1}{n-1}\\sum(f_i - \\bar{f})^2$，则 $\\hat{b} = \\frac{s_{fy}}{s_f^2}$。推导至此完成。\n\n**2. 针对给定数据集的计算**\n\n数据集为 $\\{(275, 274), (280, 277.5), (285, 282), (290, 287.5), (295, 294)\\}$，其中5对数据中的每一对都重复出现，总共有 $n=10$ 个数据点。\n\n首先，我们计算样本均值 $\\bar{f}$ 和 $\\bar{y}$：\n$$\\sum_{i=1}^{10} f_i = 2 \\times (275 + 280 + 285 + 290 + 295) = 2 \\times 1425 = 2850$$\n$$\\bar{f} = \\frac{2850}{10} = 285 \\, \\text{K}$$\n$$\\sum_{i=1}^{10} y_i = 2 \\times (274 + 277.5 + 282 + 287.5 + 294) = 2 \\times 1415 = 2830$$\n$$\\bar{y} = \\frac{2830}{10} = 283 \\, \\text{K}$$\n\n接下来，我们计算 $\\hat{b}$ 所需的平方和与叉积和。\n对于独立数据点，中心化预报值 $(f_i - \\bar{f})$ 为：\n$275 - 285 = -10$, $280 - 285 = -5$, $285 - 285 = 0$, $290 - 285 = 5$, $295 - 285 = 10$。\n对于独立数据点，中心化观测值 $(y_i - \\bar{y})$ 为：\n$274 - 283 = -9$, $277.5 - 283 = -5.5$, $282 - 283 = -1$, $287.5 - 283 = 4.5$, $294 - 283 = 11$。\n\n$\\hat{b}$ 的分母：\n$$\\sum_{i=1}^{10}(f_i - \\bar{f})^2 = 2 \\times [(-10)^2 + (-5)^2 + 0^2 + 5^2 + 10^2] = 2 \\times [100 + 25 + 0 + 25 + 100] = 2 \\times 250 = 500$$\n\n$\\hat{b}$ 的分子：\n$$\\sum_{i=1}^{10}(f_i - \\bar{f})(y_i - \\bar{y}) = 2 \\times [(-10)(-9) + (-5)(-5.5) + (0)(-1) + (5)(4.5) + (10)(11)]$$\n$$= 2 \\times [90 + 27.5 + 0 + 22.5 + 110] = 2 \\times 250 = 500$$\n\n现在，我们计算 $\\hat{b}$：\n$$\\hat{b} = \\frac{500}{500} = 1$$\n这是一个无量纲量。保留四位有效数字，$\\hat{b} = 1.000$。\n\n最后，我们计算 $\\hat{a}$：\n$$\\hat{a} = \\bar{y} - \\hat{b}\\bar{f} = 283 - (1)(285) = -2$$\n$\\hat{a}$ 的单位是开尔文。保留四位有效数字，$\\hat{a} = -2.000 \\, \\text{K}$。\n拟合的线性模型是 $\\hat{y} = -2 + 1 \\cdot f$。\n\n### 第2部分：用于诊断非线性的残差分析\n\n我们现在计算残差 $r_i = y_i - (\\hat{a} + \\hat{b} f_i)$ 和中心化预报的平方 $s_i = (f_i - \\bar{f})^2$ 之间的皮尔逊相关系数 $D$。\n\n**1. $r_i$ 和 $s_i$ 的计算**\n\n对于独立数据对的残差 $r_i$ 为：\n对于 $(275, 274)$: $r_i = 274 - (-2 + 275) = 274 - 273 = 1$。\n对于 $(280, 277.5)$: $r_i = 277.5 - (-2 + 280) = 277.5 - 278 = -0.5$。\n对于 $(285, 282)$: $r_i = 282 - (-2 + 285) = 282 - 283 = -1$。\n对于 $(290, 287.5)$: $r_i = 287.5 - (-2 + 290) = 287.5 - 288 = -0.5$。\n对于 $(295, 294)$: $r_i = 294 - (-2 + 295) = 294 - 293 = 1$。\n所有10个残差的集合是 $\\{1, -0.5, -1, -0.5, 1, 1, -0.5, -1, -0.5, 1\\}$。\n残差的均值为 $\\bar{r} = \\frac{1}{10} \\sum r_i = \\frac{2 \\times (1 - 0.5 - 1 - 0.5 + 1)}{10} = 0$。\n\n对于独立数据对的 $s_i = (f_i - \\bar{f})^2$ 的值为：\n$s_1 = (-10)^2 = 100$。\n$s_2 = (-5)^2 = 25$。\n$s_3 = 0^2 = 0$。\n$s_4 = 5^2 = 25$。\n$s_5 = 10^2 = 100$。\n所有10个值的集合是 $\\{100, 25, 0, 25, 100, 100, 25, 0, 25, 100\\}$。\n均值为 $\\bar{s} = \\frac{1}{10}\\sum s_i = \\frac{500}{10} = 50$。\n\n**2. 相关系数 $D$ 的计算**\n\n皮尔逊相关系数 $D = \\text{corr}(r, s)$ 由以下公式给出：\n$$D = \\frac{\\sum_{i=1}^{n} (r_i - \\bar{r})(s_i - \\bar{s})}{\\sqrt{\\sum_{i=1}^{n} (r_i - \\bar{r})^2 \\sum_{i=1}^{n} (s_i - \\bar{s})^2}}$$\n由于 $\\bar{r}=0$，公式简化为：\n$$D = \\frac{\\sum_{i=1}^{n} r_i(s_i - \\bar{s})}{\\sqrt{\\sum_{i=1}^{n} r_i^2 \\sum_{i=1}^{n} (s_i - \\bar{s})^2}}$$\n\n我们计算各项：\n分子： $\\sum r_i(s_i - \\bar{s}) = 2 \\times [1(100-50) + (-0.5)(25-50) + (-1)(0-50) + (-0.5)(25-50) + 1(100-50)]$。\n$$= 2 \\times [1(50) + (-0.5)(-25) + (-1)(-50) + (-0.5)(-25) + 1(50)]$$\n$$= 2 \\times [50 + 12.5 + 50 + 12.5 + 50] = 2 \\times 175 = 350$$\n\n分母第1项：残差平方和。\n$$\\sum r_i^2 = 2 \\times [1^2 + (-0.5)^2 + (-1)^2 + (-0.5)^2 + 1^2] = 2 \\times [1 + 0.25 + 1 + 0.25 + 1] = 2 \\times 3.5 = 7$$\n\n分母第2项：中心化的 $s_i$ 的平方和。\n$$\\sum (s_i - \\bar{s})^2 = 2 \\times [(100-50)^2 + (25-50)^2 + (0-50)^2 + (25-50)^2 + (100-50)^2]$$\n$$= 2 \\times [50^2 + (-25)^2 + (-50)^2 + (-25)^2 + 50^2]$$\n$$= 2 \\times [2500 + 625 + 2500 + 625 + 2500] = 2 \\times 8750 = 17500$$\n\n现在我们计算 $D$：\n$$D = \\frac{350}{\\sqrt{7 \\times 17500}} = \\frac{350}{\\sqrt{122500}} = \\frac{350}{350} = 1$$\n保留四位有效数字， $D = 1.000$。\n\n**3. 对 $D$ 的解释**\n\n系数 $D$ 衡量了线性模型的残差 $r_i$ 与中心化预报的平方 $s_i = (f_i - \\bar{f})^2$ 之间的线性关联。$D$ 的非零值表明残差中存在与预测变量的二次函数相关的系统性模式，这是非线性和模型设定错误的强烈信号。\n\n在本例中，$D=1.000$。这个值代表完全的正线性相关。这表明来自线性拟合 $y_i = \\hat{a} + \\hat{b} f_i$ 的残差不是随机噪声，而是与预报值之间遵循一种确定性关系。具体来说，残差是 $(f_i - \\bar{f})^2$ 的一个精确的正线性函数。\n\n$D$ 的正号意味着 $y$ 和 $f$ 之间的真实关系是凸的（U形）。对于远离平均预报 $\\bar{f}$ 的预报值 $f_i$（此时 $(f_i - \\bar{f})^2$ 较大，残差为正），线性模型会系统性地低估观测值 $y_i$；而对于接近平均值的预报（此时 $(f_i - \\bar{f})^2$ 较小，残差为负），则会高估 $y_i$。这一点由我们计算出的残差所证实：在 $f_i=\\bar{f}=285$ 时 $r_i$ 为 $-1$，而在极端预报值 $275$ 和 $295$ 处 $r_i$ 为 $+1$。\n\n因此，$D=1$ 的结果明确地诊断出存在未建模的二次非线性，这表明形如 $y \\approx \\beta_0 + \\beta_1 f + \\beta_2 f^2$ 的模型将能更准确地拟合数据。\n\n保留四位有效数字的最终数值为：\n$\\hat{a} = -2.000 \\, \\text{K}$\n$\\hat{b} = 1.000$\n$D = 1.000$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-2.000 & 1.000 & 1.000\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "当线性模型不足时，分位数映射（Quantile Mapping）提供了一种更强大的非参数技术，它能够校正预报的整个概率分布。本练习将引导您探索一个核心挑战：如何将在历史气候数据上校准的方法应用于未来不断变化的气候 。您将通过分析一个理想化的非平稳性场景，量化该方法在预报极端事件时可能产生的误差，从而深入理解其在气候变化背景下的局限性。",
            "id": "4076588",
            "problem": "考虑一个数值天气预报和气候建模中的后处理任务，重点是利用分位数映射在潜在非平稳性条件下进行偏差校正。假设在一个参数化设定中，模型输出和观测值都可以很好地用高斯分布来近似。设校准期的特征为一个模型变量，其分布为 $X_{\\mathrm{m,cal}} \\sim \\mathcal{N}(\\mu_{\\mathrm{m}}, \\sigma_{\\mathrm{m}})$，以及一个观测变量，其分布为 $Y_{\\mathrm{o,cal}} \\sim \\mathcal{N}(\\mu_{\\mathrm{o}}, \\sigma_{\\mathrm{o}})$。设未来期的特征为一个模型变量 $X_{\\mathrm{m,fut}} \\sim \\mathcal{N}(\\mu_{\\mathrm{mf}}, \\sigma_{\\mathrm{mf}})$ 和一个真实的观测变量 $Y_{\\mathrm{o,fut}} \\sim \\mathcal{N}(\\mu_{\\mathrm{of}}, \\sigma_{\\mathrm{of}})$。所有变量都是无量纲的标准化异常值，这意味着不需要物理单位。\n\n分位数映射定义如下：给定一个连续且严格递增的累积分布函数 $F$，分位数函数 $F^{-1}$ 是其函数反函数。对于未来的模型实现 $x$，分位数映射校正使用校准期的分布，并由 $y_{\\mathrm{corr}} = F_{\\mathrm{o,cal}}^{-1}(F_{\\mathrm{m,cal}}(x))$ 给出。在非平稳性条件下，方差结构在校准期和未来期之间可能会发生变化，这可能导致分布尾部的过度校正或校正不足。\n\n您的任务是在高斯假设下实现一个解析性的分位数映射校正，并为指定的测试用例计算尾部分位数误差。具体来说：\n\n- 在高斯假设下，从分位数映射的定义和高斯累积分布函数的性质出发，推导校正后未来分布 $y_{\\mathrm{corr}}$ 的参数。\n- 对于每个测试用例，计算两个尾部分位数 $q_{\\mathrm{hi}}$ 和 $q_{\\mathrm{lo}}$ 处的误差，定义为\n$$\\Delta_{\\mathrm{hi}} = Q_{\\mathrm{corr}}(q_{\\mathrm{hi}}) - Q_{\\mathrm{true}}(q_{\\mathrm{hi}}), \\quad \\Delta_{\\mathrm{lo}} = Q_{\\mathrm{corr}}(q_{\\mathrm{lo}}) - Q_{\\mathrm{true}}(q_{\\mathrm{lo}}),$$\n其中 $Q_{\\mathrm{corr}}(q)$ 是校正后分布在水平 $q$ 处的分位数，而 $Q_{\\mathrm{true}}(q)$ 是真实未来观测分布在水平 $q$ 处的分位数。将 $q_{\\mathrm{hi}}$ 和 $q_{\\mathrm{lo}}$ 表示为 $[0,1]$ 内的小数。\n\n解释指南：\n- 如果 $\\Delta_{\\mathrm{hi}}$ 为正，则校正高估了上尾（过度校正）；如果为负，则低估了上尾（校正不足）。\n- 如果 $\\Delta_{\\mathrm{lo}}$ 为负，则校正高估了下尾（过度校正）；如果为正，则低估了下尾（校正不足）。\n\n使用以下参数值测试套件，涵盖基线平稳情况、各种非平稳方差变化、极端尾部分位数以及均值漂移相互作用情况：\n\n- 测试用例 1 (平稳基线):\n  - 校准期: $\\mu_{\\mathrm{m}} = 0$, $\\sigma_{\\mathrm{m}} = 2$, $\\mu_{\\mathrm{o}} = 1$, $\\sigma_{\\mathrm{o}} = 3$.\n  - 未来期: $\\mu_{\\mathrm{mf}} = 0$, $\\sigma_{\\mathrm{mf}} = 2$, $\\mu_{\\mathrm{of}} = 1$, $\\sigma_{\\mathrm{of}} = 3$.\n  - 分位数: $q_{\\mathrm{hi}} = 0.99$, $q_{\\mathrm{lo}} = 0.01$.\n\n- 测试用例 2 (方差增加，中度不匹配):\n  - 校准期: $\\mu_{\\mathrm{m}} = 0$, $\\sigma_{\\mathrm{m}} = 2$, $\\mu_{\\mathrm{o}} = 1$, $\\sigma_{\\mathrm{o}} = 3$.\n  - 未来期: $\\mu_{\\mathrm{mf}} = 0$, $\\sigma_{\\mathrm{mf}} = 3$, $\\mu_{\\mathrm{of}} = 1$, $\\sigma_{\\mathrm{of}} = 4$.\n  - 分位数: $q_{\\mathrm{hi}} = 0.99$, $q_{\\mathrm{lo}} = 0.01$.\n\n- 测试用例 3 (模型中方差减少，真实值中方差增加):\n  - 校准期: $\\mu_{\\mathrm{m}} = 0$, $\\sigma_{\\mathrm{m}} = 2$, $\\mu_{\\mathrm{o}} = 1$, $\\sigma_{\\mathrm{o}} = 3$.\n  - 未来期: $\\mu_{\\mathrm{mf}} = 0$, $\\sigma_{\\mathrm{mf}} = 1.5$, $\\mu_{\\mathrm{of}} = 1$, $\\sigma_{\\mathrm{of}} = 4$.\n  - 分位数: $q_{\\mathrm{hi}} = 0.99$, $q_{\\mathrm{lo}} = 0.01$.\n\n- 测试用例 4 (极端上尾和下尾):\n  - 校准期: $\\mu_{\\mathrm{m}} = 0$, $\\sigma_{\\mathrm{m}} = 2$, $\\mu_{\\mathrm{o}} = 1$, $\\sigma_{\\mathrm{o}} = 3$.\n  - 未来期: $\\mu_{\\mathrm{mf}} = 0$, $\\sigma_{\\mathrm{mf}} = 5$, $\\mu_{\\mathrm{of}} = 1$, $\\sigma_{\\mathrm{of}} = 3$.\n  - 分位数: $q_{\\mathrm{hi}} = 0.999$, $q_{\\mathrm{lo}} = 0.001$.\n\n- 测试用例 5 (均值漂移相互作用和方差变化):\n  - 校准期: $\\mu_{\\mathrm{m}} = 0$, $\\sigma_{\\mathrm{m}} = 2$, $\\mu_{\\mathrm{o}} = 1$, $\\sigma_{\\mathrm{o}} = 3$.\n  - 未来期: $\\mu_{\\mathrm{mf}} = 1$, $\\sigma_{\\mathrm{mf}} = 2$, $\\mu_{\\mathrm{of}} = 2.2$, $\\sigma_{\\mathrm{of}} = 3$.\n  - 分位数: $q_{\\mathrm{hi}} = 0.99$, $q_{\\mathrm{lo}} = 0.01$.\n\n您的程序必须为每个测试用例计算如上定义的浮点数对 $[\\Delta_{\\mathrm{hi}}, \\Delta_{\\mathrm{lo}}]$，并将所有测试用例的结果汇总到一行中。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，每个测试用例的结果都是一个浮点数列表。例如，输出应类似于 $[[a,b],[c,d],\\dots]$。这些值必须完全按照上述定义进行计算；它们可以用标准浮点表示法打印。不允许外部输入，也不适用任何物理单位。",
            "solution": "用户提供的问题已经过评估且有效。它具有科学依据，问题陈述清晰，且客观。它提出了一个用于气候和天气模型的统计后处理中的标准、可形式化的问题，并提供了所有必需的参数和定义。\n\n问题的核心是在高斯假设下推导分位数映射分布的解析形式，然后评估该校正方法在非平稳条件下的误差。\n\n首先，我们推导校正后未来分布的参数。分位数映射校正定义为：\n$$y_{\\mathrm{corr}} = F_{\\mathrm{o,cal}}^{-1}(F_{\\mathrm{m,cal}}(x))$$\n其中 $x$ 是来自未来模型输出分布 $X_{\\mathrm{m,fut}} \\sim \\mathcal{N}(\\mu_{\\mathrm{mf}}, \\sigma_{\\mathrm{mf}})$ 的一个值。累积分布函数 (CDF) 和分位数函数 (CDF 的反函数) 基于校准期的分布：$X_{\\mathrm{m,cal}} \\sim \\mathcal{N}(\\mu_{\\mathrm{m}}, \\sigma_{\\mathrm{m}})$ 和 $Y_{\\mathrm{o,cal}} \\sim \\mathcal{N}(\\mu_{\\mathrm{o}}, \\sigma_{\\mathrm{o}})$。\n\n设 $\\Phi(z)$ 为标准正态分布 $\\mathcal{N}(0, 1)$ 的累积分布函数，$\\Phi^{-1}(q)$ 为其反函数（分位数函数）。对于一个一般的高斯分布 $\\mathcal{N}(\\mu, \\sigma)$，其累积分布函数为 $F(x) = \\Phi\\left(\\frac{x - \\mu}{\\sigma}\\right)$，分位数函数为 $F^{-1}(q) = \\mu + \\sigma \\Phi^{-1}(q)$。\n\n将这些定义应用于我们的校准期分布：\n$$F_{\\mathrm{m,cal}}(x) = \\Phi\\left(\\frac{x - \\mu_{\\mathrm{m}}}{\\sigma_{\\mathrm{m}}}\\right)$$\n$$F_{\\mathrm{o,cal}}^{-1}(q) = \\mu_{\\mathrm{o}} + \\sigma_{\\mathrm{o}} \\Phi^{-1}(q)$$\n\n将 $F_{\\mathrm{m,cal}}(x)$ 代入 $F_{\\mathrm{o,cal}}^{-1}(q)$，得到对任意给定的模型输出 $x$ 的变换：\n$$y_{\\mathrm{corr}}(x) = F_{\\mathrm{o,cal}}^{-1}\\left( \\Phi\\left(\\frac{x - \\mu_{\\mathrm{m}}}{\\sigma_{\\mathrm{m}}}\\right) \\right) = \\mu_{\\mathrm{o}} + \\sigma_{\\mathrm{o}} \\Phi^{-1}\\left( \\Phi\\left(\\frac{x - \\mu_{\\mathrm{m}}}{\\sigma_{\\mathrm{m}}}\\right) \\right)$$\n由于 $\\Phi^{-1}(\\Phi(z)) = z$，该表达式简化为 $x$ 的线性变换：\n$$y_{\\mathrm{corr}}(x) = \\mu_{\\mathrm{o}} + \\sigma_{\\mathrm{o}} \\left(\\frac{x - \\mu_{\\mathrm{m}}}{\\sigma_{\\mathrm{m}}}\\right) = \\left(\\mu_{\\mathrm{o}} - \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\mu_{\\mathrm{m}}\\right) + \\left(\\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\right) x$$\n现在我们将此变换应用于随机变量 $X_{\\mathrm{m,fut}} \\sim \\mathcal{N}(\\mu_{\\mathrm{mf}}, \\sigma_{\\mathrm{mf}})$，以找到校正后变量 $Y_{\\mathrm{corr}}$ 的分布。由于 $Y_{\\mathrm{corr}}$ 是高斯变量的线性变换，因此它本身也是高斯分布的，即 $Y_{\\mathrm{corr}} \\sim \\mathcal{N}(\\mu_{\\mathrm{corr}}, \\sigma_{\\mathrm{corr}})$。\n\n校正后分布的均值 $\\mu_{\\mathrm{corr}}$ 为：\n$$\\mu_{\\mathrm{corr}} = E[Y_{\\mathrm{corr}}] = E\\left[ \\mu_{\\mathrm{o}} - \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\mu_{\\mathrm{m}} + \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}} X_{\\mathrm{m,fut}} \\right] = \\mu_{\\mathrm{o}} - \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\mu_{\\mathrm{m}} + \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}} E[X_{\\mathrm{m,fut}}]$$\n$$\\mu_{\\mathrm{corr}} = \\mu_{\\mathrm{o}} + \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}(\\mu_{\\mathrm{mf}} - \\mu_{\\mathrm{m}})$$\n校正后分布的方差 $\\sigma_{\\mathrm{corr}}^2$ 为：\n$$\\sigma_{\\mathrm{corr}}^2 = \\mathrm{Var}(Y_{\\mathrm{corr}}) = \\mathrm{Var}\\left( \\mu_{\\mathrm{o}} - \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\mu_{\\mathrm{m}} + \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}} X_{\\mathrm{m,fut}} \\right) = \\mathrm{Var}\\left( \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}} X_{\\mathrm{m,fut}} \\right) = \\left(\\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\right)^2 \\mathrm{Var}(X_{\\mathrm{m,fut}})$$\n$$\\sigma_{\\mathrm{corr}}^2 = \\left(\\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}}\\right)^2 \\sigma_{\\mathrm{mf}}^2$$\n因此，校正后分布的标准差为：\n$$\\sigma_{\\mathrm{corr}} = \\frac{\\sigma_{\\mathrm{o}}}{\\sigma_{\\mathrm{m}}} \\sigma_{\\mathrm{mf}}$$\n\n接下来，我们计算尾部分位数误差 $\\Delta_{\\mathrm{hi}}$ 和 $\\Delta_{\\mathrm{lo}}$。\n校正后分布在水平 $q$ 处的分位数为 $Q_{\\mathrm{corr}}(q) = \\mu_{\\mathrm{corr}} + \\sigma_{\\mathrm{corr}} \\Phi^{-1}(q)$。\n真实未来观测分布 $Y_{\\mathrm{o,fut}} \\sim \\mathcal{N}(\\mu_{\\mathrm{of}}, \\sigma_{\\mathrm{of}})$ 在水平 $q$ 处的分位数为 $Q_{\\mathrm{true}}(q) = \\mu_{\\mathrm{of}} + \\sigma_{\\mathrm{of}} \\Phi^{-1}(q)$。\n\n误差定义为：\n$$\\Delta_{\\mathrm{hi}} = Q_{\\mathrm{corr}}(q_{\\mathrm{hi}}) - Q_{\\mathrm{true}}(q_{\\mathrm{hi}}) = (\\mu_{\\mathrm{corr}} + \\sigma_{\\mathrm{corr}} \\Phi^{-1}(q_{\\mathrm{hi}})) - (\\mu_{\\mathrm{of}} + \\sigma_{\\mathrm{of}} \\Phi^{-1}(q_{\\mathrm{hi}}))$$\n$$\\Delta_{\\mathrm{hi}} = (\\mu_{\\mathrm{corr}} - \\mu_{\\mathrm{of}}) + (\\sigma_{\\mathrm{corr}} - \\sigma_{\\mathrm{of}}) \\Phi^{-1}(q_{\\mathrm{hi}})$$\n\n$$\\Delta_{\\mathrm{lo}} = Q_{\\mathrm{corr}}(q_{\\mathrm{lo}}) - Q_{\\mathrm{true}}(q_{\\mathrm{lo}}) = (\\mu_{\\mathrm{corr}} + \\sigma_{\\mathrm{corr}} \\Phi^{-1}(q_{\\mathrm{lo}})) - (\\mu_{\\mathrm{of}} + \\sigma_{\\mathrm{of}} \\Phi^{-1}(q_{\\mathrm{lo}}))$$\n$$\\Delta_{\\mathrm{lo}} = (\\mu_{\\mathrm{corr}} - \\mu_{\\mathrm{of}}) + (\\sigma_{\\mathrm{corr}} - \\sigma_{\\mathrm{of}}) \\Phi^{-1}(q_{\\mathrm{lo}})$$\n令 $z_q = \\Phi^{-1}(q)$，公式变为：\n$$\\Delta_{\\mathrm{hi}} = (\\mu_{\\mathrm{corr}} - \\mu_{\\mathrm{of}}) + (\\sigma_{\\mathrm{corr}} - \\sigma_{\\mathrm{of}}) z_{q_{\\mathrm{hi}}}$$\n$$\\Delta_{\\mathrm{lo}} = (\\mu_{\\mathrm{corr}} - \\mu_{\\mathrm{of}}) + (\\sigma_{\\mathrm{corr}} - \\sigma_{\\mathrm{of}}) z_{q_{\\mathrm{lo}}}$$\n\n每个测试用例的计算过程如下：\n1. 给定校准期（$\\mu_{\\mathrm{m}}$、$\\sigma_{\\mathrm{m}}$、$\\mu_{\\mathrm{o}}$、$\\sigma_{\\mathrm{o}}$）和未来期（$\\mu_{\\mathrm{mf}}$、$\\sigma_{\\mathrm{mf}}$、$\\mu_{\\mathrm{of}}$、$\\sigma_{\\mathrm{of}}$）的参数，首先计算校正后正态分布的参数 $\\mu_{\\mathrm{corr}}$ 和 $\\sigma_{\\mathrm{corr}}$。\n2. 给定分位数水平 $q_{\\mathrm{hi}}$ 和 $q_{\\mathrm{lo}}$，使用反累积分布函数 $\\Phi^{-1}$ 计算相应的标准正态分位数 $z_{q_{\\mathrm{hi}}}$ 和 $z_{q_{\\mathrm{lo}}}$。\n3. 将这些值代入推导出的 $\\Delta_{\\mathrm{hi}}$ 和 $\\Delta_{\\mathrm{lo}}$ 表达式中，以求出分位数误差。\n现在将为每个提供的测试用例实施此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes quantile mapping errors for several test cases under Gaussian assumptions.\n    \"\"\"\n    # Each test case is a tuple of parameters:\n    # (mu_m, sigma_m, mu_o, sigma_o, mu_mf, sigma_mf, mu_of, sigma_of, q_hi, q_lo)\n    test_cases = [\n        # Test case 1 (stationary baseline)\n        (0.0, 2.0, 1.0, 3.0, 0.0, 2.0, 1.0, 3.0, 0.99, 0.01),\n        # Test case 2 (variance increase, moderate mismatch)\n        (0.0, 2.0, 1.0, 3.0, 0.0, 3.0, 1.0, 4.0, 0.99, 0.01),\n        # Test case 3 (variance decrease in model, increase in truth)\n        (0.0, 2.0, 1.0, 3.0, 0.0, 1.5, 1.0, 4.0, 0.99, 0.01),\n        # Test case 4 (extreme upper and lower tails)\n        (0.0, 2.0, 1.0, 3.0, 0.0, 5.0, 1.0, 3.0, 0.999, 0.001),\n        # Test case 5 (mean shift interaction and variance change)\n        (0.0, 2.0, 1.0, 3.0, 1.0, 2.0, 2.2, 3.0, 0.99, 0.01)\n    ]\n\n    results = []\n    for case in test_cases:\n        mu_m, sigma_m, mu_o, sigma_o, mu_mf, sigma_mf, mu_of, sigma_of, q_hi, q_lo = case\n\n        # Step 1: Calculate parameters of the corrected distribution.\n        # This is based on the linear transformation y_corr = a + b * x where\n        # b = sigma_o / sigma_m and a = mu_o - b * mu_m.\n        # The mean is E[a + b * X_mf] = a + b * E[X_mf] = a + b * mu_mf.\n        # The std dev is sqrt(Var(a + b * X_mf)) = sqrt(b^2 * Var(X_mf)) = b * sigma_mf.\n        \n        mu_corr = mu_o + (sigma_o / sigma_m) * (mu_mf - mu_m)\n        sigma_corr = sigma_o * (sigma_mf / sigma_m)\n\n        # Step 2: Get standard normal quantiles (z-scores) for q_hi and q_lo.\n        z_hi = norm.ppf(q_hi)\n        z_lo = norm.ppf(q_lo)\n\n        # Step 3: Compute the quantile errors.\n        # Error = Q_corr(q) - Q_true(q)\n        #       = (mu_corr + sigma_corr * z_q) - (mu_of + sigma_of * z_q)\n        #       = (mu_corr - mu_of) + (sigma_corr - sigma_of) * z_q\n        \n        mu_diff = mu_corr - mu_of\n        sigma_diff = sigma_corr - sigma_of\n        \n        delta_hi = mu_diff + sigma_diff * z_hi\n        delta_lo = mu_diff + sigma_diff * z_lo\n        \n        results.append([delta_hi, delta_lo])\n\n    # Format the final output as a single line: [[a,b],[c,d],...]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "为了进一步提升校正效果，我们可以构建依赖于天气背景（即“环流型”）的精细化模型。由于单一的校正模型可能无法适用于所有的天气状况，本练习将指导您构建一个更灵活的概率预报 。您将学习如何通过混合多个高斯模型来生成一个综合的预报分布，其中每个模型的权重由当前天气环流型的概率决定。",
            "id": "4076604",
            "problem": "考虑一个数值天气预报（NWP）中的后处理和偏差校正任务。令 $Y$ 表示用于验证的近地面气温（单位：开尔文），令 $F$ 表示一个确定性模型预报（单位：开尔文），并令 $R \\in \\{1,\\dots,K\\}$ 表示一个离散的状态指数，该指数捕捉了天气尺度环流或其他结构性条件。假设特定状态下的校准模型由 $Y$ 在给定 $R=r$ 和 $F=f$ 条件下的条件分布定义，该分布为高斯分布，其均值为 $a_r + c_r f$，方差为 $\\sigma_r^2$。其中，$a_r$ 是一个加性偏移量（单位：开尔文），$c_r$ 是一个乘性校准系数（无量纲），$\\sigma_r$ 是特定状态下残差的标准差（单位：开尔文）。状态概率以软分配的形式给出，$w_r = \\mathbb{P}(R=r \\mid \\mathbf{x})$，对于每个 $r$，有 $w_r \\in [0,1]$ 且 $\\sum_{r=1}^{K} w_r \\approx 1$，其中 $\\mathbf{x}$ 是一个预测因子向量。因此，$Y$ 在给定 $\\mathbf{x}$ 和 $F=f$ 条件下的预测分布是一个由权重 $\\{w_r\\}_{r=1}^K$ 加权的、由各状态的高斯分布组成的有限混合模型。\n\n从以下基本定律出发：\n- 全期望定律，其表述为 $\\mathbb{E}[Y \\mid \\mathbf{x}, F=f] = \\mathbb{E}\\big[\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f] \\mid \\mathbf{x}, F=f\\big]$。\n- 全方差定律，其表述为 $\\mathrm{Var}(Y \\mid \\mathbf{x}, F=f) = \\mathbb{E}\\big[\\mathrm{Var}(Y \\mid R, \\mathbf{x}, F=f) \\mid \\mathbf{x}, F=f\\big] + \\mathrm{Var}\\big(\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f] \\mid \\mathbf{x}, F=f\\big)$。\n- 上文定义的各状态高斯校准模型。\n\n你的任务是实现一个程序，对于给定的一组状态参数 $\\{(a_r,c_r,\\sigma_r)\\}_{r=1}^K$、一个预报值 $f$ 和一组软分配权重 $\\{w_r\\}_{r=1}^K$，计算：\n1. 每个状态 $r \\in \\{1,\\dots,K\\}$ 下经过偏差校正的均值 $\\mu_r = a_r + c_r f$。\n2. 混合预测均值 $m = \\mathbb{E}[Y \\mid \\mathbf{x}, F=f]$。\n3. 混合预测方差 $v = \\mathrm{Var}(Y \\mid \\mathbf{x}, F=f)$。\n\n如果由于四舍五入或微小的数值误差，提供的权重满足 $\\sum_{r=1}^{K} w_r \\neq 1$，则在计算任何量之前，通过将每个权重除以 $\\sum_{r=1}^{K} w_r$ 来对其进行重新归一化。假设所有给定的 $\\sigma_r \\ge 0$，其中 $\\sigma_r = 0$ 代表一个确定性的特定状态校正。所有计算中，均值必须以开尔文（K）为单位，方差必须以平方开尔文（$\\mathrm{K}^2$）为单位。最终的混合均值以开尔文（K）表示，最终的混合方差以平方开尔文（$\\mathrm{K}^2$）表示，均四舍五入到六位小数。\n\n测试套件：\n为以下每组参数计算 $[m,v]$。在每个案例中，$F=f$ 是给定的预报值（单位：开尔文），状态参数和权重如列表所示。\n\n- 案例 $1$ (正常路径):\n  - $K=2$,\n  - $f = 280.0$,\n  - $w = (0.7, 0.3)$,\n  - $a = (-2.0, 1.0)$,\n  - $c = (1.05, 0.95)$,\n  - $\\sigma = (1.5, 2.0)$.\n\n- 案例 $2$ (边界权重):\n  - $K=2$,\n  - $f = 285.0$,\n  - $w = (1.0, 0.0)$,\n  - $a = (-1.0, 0.5)$,\n  - $c = (1.00, 0.90)$,\n  - $\\sigma = (1.0, 2.5)$.\n\n- 案例 $3$ (零方差状态):\n  - $K=3$,\n  - $f = 300.0$,\n  - $w = (0.2, 0.5, 0.3)$,\n  - $a = (0.0, -3.0, 2.0)$,\n  - $c = (1.00, 1.02, 0.98)$,\n  - $\\sigma = (1.2, 0.0, 3.0)$.\n\n- 案例 $4$ (权重重新归一化):\n  - $K=3$,\n  - $f = 260.0$,\n  - $w = (0.5005, 0.2002, 0.3004)$,\n  - $a = (-0.5, 1.5, -2.0)$,\n  - $c = (1.10, 0.97, 1.03)$,\n  - $\\sigma = (0.8, 1.1, 2.2)$.\n\n- 案例 $5$ (近简并权重分配):\n  - $K=2$,\n  - $f = 310.0$,\n  - $w = (0.00001, 0.99999)$,\n  - $a = (-4.0, 0.0),\n  - $c = (1.05, 0.99),\n  - $\\sigma = (4.0, 1.5)$.\n\n最终输出格式：\n你的程序应生成单行输出，其中包含结果，格式为逗号分隔的方括号对列表。每个方括号对按上述案例的顺序列出混合均值和方差，两者均四舍五入到六位小数，并用方括号括起来。例如：\n$[[m_1,v_1],[m_2,v_2],[m_3,v_3],[m_4,v_4],[m_5,v_5]]$",
            "solution": "该问题是有效的。这是一个适定且具有科学依据的练习，旨在将基本统计原理应用于数值天气预报模型后处理中的一个常见问题。该模型，一个用于偏差校正的高斯混合模型，是该领域的标准技术。所有参数和条件都已明确规定。\n\n本解答将首先根据给定的全期望定律和全方差定律推导混合预测均值和方差的表达式。然后，将应用这些推导出的公式来求解测试套件中的值。\n\n令 $Y$ 为真实近地面气温的随机变量，$F=f$ 为确定性模型预报，$\\mathbf{x}$ 为用于确定天气状态的预测因子向量。问题陈述指出，$Y$ 的预测分布是 $K$ 个高斯分布的有限混合。\n\n给定状态 $R=r$ 的特定状态模型为：\n$$\nY \\mid (R=r, \\mathbf{x}, F=f) \\sim \\mathcal{N}(\\mu_r, \\sigma_r^2)\n$$\n其中，特定状态的条件均值为 $\\mu_r = \\mathbb{E}[Y \\mid R=r, \\mathbf{x}, F=f] = a_r + c_r f$，特定状态的条件方差为 $\\mathrm{Var}(Y \\mid R=r, \\mathbf{x}, F=f) = \\sigma_r^2$。\n\n状态概率（或混合权重）给出为 $w_r = \\mathbb{P}(R=r \\mid \\mathbf{x})$。为了计算全期望和全方差，我们将使用这些给定的权重，并假设它们代表条件概率 $\\mathbb{P}(R=r \\mid \\mathbf{x}, F=f)$。根据问题陈述，如果这些权重的总和不等于 $1$，则必须对其进行归一化，以确保它们构成一个有效的概率分布。令归一化后的权重为 $w'_r = w_r / \\sum_{j=1}^K w_j$。\n\n### 1. 混合预测均值（$m$）的推导\n\n混合预测均值 $m$ 是 $Y$ 在给定预报 $f$ 和预测因子 $\\mathbf{x}$ 条件下的条件期望。我们应用全期望定律：\n$$\nm = \\mathbb{E}[Y \\mid \\mathbf{x}, F=f] = \\mathbb{E}\\big[\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f] \\mid \\mathbf{x}, F=f\\big]\n$$\n内部期望 $\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f]$ 是一个随机变量，当状态为 $r$ 时，其值为 $\\mu_r$。外部期望是关于状态指数 $R$ 的分布来计算的，该分布由权重 $\\{w'_r\\}$ 给出。\n因此，外部期望是所有可能状态的加权和：\n$$\nm = \\sum_{r=1}^{K} \\mathbb{E}[Y \\mid R=r, \\mathbf{x}, F=f] \\cdot \\mathbb{P}(R=r \\mid \\mathbf{x}, F=f)\n$$\n代入已知量：\n$$\nm = \\sum_{r=1}^{K} \\mu_r w'_r = \\sum_{r=1}^{K} (a_r + c_r f) w'_r\n$$\n\n### 2. 混合预测方差（$v$）的推导\n\n混合预测方差 $v$ 是 $Y$ 在给定 $f$ 和 $\\mathbf{x}$ 条件下的条件方差。我们应用全方差定律：\n$$\nv = \\mathrm{Var}(Y \\mid \\mathbf{x}, F=f) = \\mathbb{E}\\big[\\mathrm{Var}(Y \\mid R, \\mathbf{x}, F=f) \\mid \\mathbf{x}, F=f\\big] + \\mathrm{Var}\\big(\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f] \\mid \\mathbf{x}, F=f\\big)\n$$\n该公式由两部分组成：条件方差的期望和条件期望的方差。\n\n**第一部分：条件方差的期望**\n第一项是特定状态方差的期望。内部项 $\\mathrm{Var}(Y \\mid R, \\mathbf{x}, F=f)$ 是一个随机变量，当状态为 $r$ 时，其值为 $\\sigma_r^2$。其期望为：\n$$\n\\mathbb{E}\\big[\\mathrm{Var}(Y \\mid R, \\mathbf{x}, F=f) \\mid \\mathbf{x}, F=f\\big] = \\sum_{r=1}^{K} \\mathrm{Var}(Y \\mid R=r, \\mathbf{x}, F=f) \\cdot \\mathbb{P}(R=r \\mid \\mathbf{x}, F=f) = \\sum_{r=1}^{K} \\sigma_r^2 w'_r\n$$\n\n**第二部分：条件期望的方差**\n第二项是特定状态均值的方差。内部项 $\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f]$ 是这样一个随机变量，它以概率 $w'_r$ 取值 $\\mu_r$。这个离散随机变量的方差由公式 $\\mathrm{Var}(X) = \\mathbb{E}[X^2] - (\\mathbb{E}[X])^2$ 给出。\n这里，$X = \\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f]$。我们已经确定 $\\mathbb{E}[X] = m$。\n项 $\\mathbb{E}[X^2]$ 为：\n$$\n\\mathbb{E}\\big[ (\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f])^2 \\mid \\mathbf{x}, F=f \\big] = \\sum_{r=1}^{K} \\mu_r^2 w'_r\n$$\n因此，条件期望的方差为：\n$$\n\\mathrm{Var}\\big(\\mathbb{E}[Y \\mid R, \\mathbf{x}, F=f] \\mid \\mathbf{x}, F=f\\big) = \\left(\\sum_{r=1}^{K} \\mu_r^2 w'_r\\right) - m^2\n$$\n\n**合并各部分**\n将这两个部分相加得到总的混合方差 $v$：\n$$\nv = \\left(\\sum_{r=1}^{K} \\sigma_r^2 w'_r\\right) + \\left(\\left(\\sum_{r=1}^{K} \\mu_r^2 w'_r\\right) - m^2\\right)\n$$\n为便于计算，可以将其重新排列为：\n$$\nv = \\sum_{r=1}^{K} w'_r (\\sigma_r^2 + \\mu_r^2) - m^2\n$$\n\n### 算法总结\n对于每个测试案例，执行以下步骤：\n1. 将输入权重 $\\{w_r\\}$ 归一化为 $\\{w'_r\\}$，使得 $\\sum_{r=1}^K w'_r = 1$。\n2. 计算特定状态的均值 $\\{\\mu_r\\}$，公式为 $\\mu_r = a_r + c_r f$。\n3. 计算混合均值 $m$，即特定状态均值的加权平均：$m = \\sum_r w'_r \\mu_r$。\n4. 使用推导出的公式计算混合方差 $v$：$v = \\sum_r w'_r (\\sigma_r^2 + \\mu_r^2) - m^2$。\n5. $m$（单位：开尔文）和 $v$（单位：平方开尔文）的最终结果四舍五入到六位小数。\n\n现在将实施此程序来处理提供的测试案例。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It calculates the mixture mean and variance for each case and prints the\n    results in the specified format.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (happy path)\n        {\n            \"f\": 280.0,\n            \"w\": np.array([0.7, 0.3]),\n            \"a\": np.array([-2.0, 1.0]),\n            \"c\": np.array([1.05, 0.95]),\n            \"sigma\": np.array([1.5, 2.0]),\n        },\n        # Case 2 (boundary weights)\n        {\n            \"f\": 285.0,\n            \"w\": np.array([1.0, 0.0]),\n            \"a\": np.array([-1.0, 0.5]),\n            \"c\": np.array([1.00, 0.90]),\n            \"sigma\": np.array([1.0, 2.5]),\n        },\n        # Case 3 (zero-variance regime)\n        {\n            \"f\": 300.0,\n            \"w\": np.array([0.2, 0.5, 0.3]),\n            \"a\": np.array([0.0, -3.0, 2.0]),\n            \"c\": np.array([1.00, 1.02, 0.98]),\n            \"sigma\": np.array([1.2, 0.0, 3.0]),\n        },\n        # Case 4 (renormalization of weights)\n        {\n            \"f\": 260.0,\n            \"w\": np.array([0.5005, 0.2002, 0.3004]),\n            \"a\": np.array([-0.5, 1.5, -2.0]),\n            \"c\": np.array([1.10, 0.97, 1.03]),\n            \"sigma\": np.array([0.8, 1.1, 2.2]),\n        },\n        # Case 5 (near-degenerate weight allocation)\n        {\n            \"f\": 310.0,\n            \"w\": np.array([0.00001, 0.99999]),\n            \"a\": np.array([-4.0, 0.0]),\n            \"c\": np.array([1.05, 0.99]),\n            \"sigma\": np.array([4.0, 1.5]),\n        },\n    ]\n\n    def calculate_mixture_properties(f, w, a, c, sigma):\n        \"\"\"\n        Computes the mixture predictive mean and variance.\n\n        Args:\n            f (float): The deterministic model forecast value.\n            w (np.ndarray): Array of soft assignment weights for each regime.\n            a (np.ndarray): Array of additive offset parameters for each regime.\n            c (np.ndarray): Array of multiplicative calibration coefficients.\n            sigma (np.ndarray): Array of standard deviations for each regime.\n\n        Returns:\n            tuple[float, float]: A tuple containing the mixture mean and variance.\n        \"\"\"\n        # Step 1: Normalize weights if their sum is not 1.\n        w_sum = np.sum(w)\n        if not np.isclose(w_sum, 1.0):\n            w_norm = w / w_sum\n        else:\n            w_norm = w\n        \n        # Step 2: Calculate regime-specific means.\n        # mu_r = a_r + c_r * f\n        mu_r = a + c * f\n\n        # Step 3: Calculate the mixture predictive mean (m).\n        # m = sum(w_r' * mu_r)\n        m = np.sum(w_norm * mu_r)\n\n        # Step 4: Calculate the mixture predictive variance (v).\n        # v = E[Var(Y|R)] + Var(E[Y|R])\n        # v = sum(w_r' * sigma_r^2) + { sum(w_r' * mu_r^2) - m^2 }\n        # v = sum(w_r' * (sigma_r^2 + mu_r^2)) - m^2\n        regime_vars = sigma**2\n        v = np.sum(w_norm * (regime_vars + mu_r**2)) - m**2\n\n        return m, v\n\n    results_list = []\n    for case in test_cases:\n        m, v = calculate_mixture_properties(case[\"f\"], case[\"w\"], case[\"a\"], case[\"c\"], case[\"sigma\"])\n        \n        # Format the result pair as a string, rounding to six decimal places.\n        results_list.append(f\"[{m:.6f},{v:.6f}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_list)}]\")\n\nsolve()\n```"
        }
    ]
}