{
    "hands_on_practices": [
        {
            "introduction": "这项练习为理解公平威胁评分（Equitable Threat Score, ETS）提供了一个基础性的训练。通过在频率偏差为1（即虚报数等于漏报数）这一特定且重要的条件下推导ETS公式，您将把该评分的结构与一个关键的诊断指标联系起来。将此推导应用于一个具体的数值场景，有助于巩固抽象概念，并增强您在计算和解释这一关键验证评分时的信心。",
            "id": "4021502",
            "problem": "考虑在数值天气预报和气候建模中对阈值降水超额进行的二元事件检验，该检验由一个包含以下计数的列联表总结：命中 $H$、漏报 $M$、空报 $F$ 和正确否定 $C$。设预报-观测对的总数为 $N$，因此 $N = H + M + F + C$。观测事件频数是观测到事件的次数 $H + M$，预报事件频数是预报了事件的次数 $H + F$。频率偏差是预报事件频数与观测事件频数的比率。公平威胁评分（ETS）的构建思想是：在预报和观测相互独立的假设下，会有一定预期数量的命中纯粹由偶然发生，而这些随机命中应从分子（以衡量有技巧的命中）和分母（以在不同基础率下保持公平的惩罚）中剔除。\n\n仅从这些核心定义和原则出发：\n- 推导使频率偏差等于1时，$(H, M, F, C)$ 所需满足的充要条件。\n- 使用独立性假设作为偶然重合的基础概率模型，推导公平威胁评分（ETS）的表达式，然后在预报事件频数等于观测事件频数的条件下简化该表达式。\n\n最后，将您的结果应用于以下科学上真实的情景：共有 $N = 2500$ 次每日预报；观测事件基础率为 $0.1$，因此观测到事件的次数为 $H + M = 250$；预报事件频数与观测事件频数相匹配，且命中在观测事件中所占的比例为 $0.6$，因此 $H = 0.6(H + M)$。为此情景数值计算ETS。将您的答案四舍五入到四位有效数字。最终结果以无单位的纯数表示。",
            "solution": "该问题被评估为具有科学依据、提法恰当、客观且自洽。所有必要信息均已提供，问题具体且可形式化。该情景在数值天气预报的背景下是真实的。因此，该问题有效，并将提供解答。\n\n分析按问题陈述的要求分三部分进行：\n1.  推导频率偏差为1的条件。\n2.  推导和简化公平威胁评分（ETS）。\n3.  对给定情景进行ETS的数值计算。\n\n设列联表的四个要素定义如下：\n- $H$：命中（预报事件，观测到事件）\n- $M$：漏报（未预报事件，观测到事件）\n- $F$：空报（预报事件，未观测到事件）\n- $C$：正确否定（未预报事件，未观测到事件）\n\n预报-观测对的总数为 $N = H + M + F + C$。\n\n### 第1部分：频率偏差为1的条件\n\n频率偏差，通常表示为 $B$，定义为预报事件频数与观测事件频数的比率。\n事件被预报的次数是命中和空报的总和，$H + F$。\n事件被观测到的次数是命中和漏报的总和，$H + M$。\n\n因此，频率偏差由下式给出：\n$$\nB = \\frac{H + F}{H + M}\n$$\n问题要求推导频率偏差等于1的充要条件。设 $B = 1$：\n$$\n\\frac{H + F}{H + M} = 1\n$$\n假设观测到事件的次数不为零（即 $H + M \\neq 0$，这是为了使偏差有良好定义和意义的实际需要），我们可以在等式两边同乘以 $H + M$：\n$$\nH + F = H + M\n$$\n从两边减去 $H$ 得出：\n$$\nF = M\n$$\n这就是充要条件。频率偏差为 $1$ 意味着空报的次数与漏报的次数完全相等。这个条件在频率意义上也被称为“无偏”，意味着模型预报事件的频率与观测到的频率相同。\n\n### 第2部分：公平威胁评分（ETS）的推导与简化\n\n公平威胁评分（ETS）旨在改进威胁评分（TS），也称为临界成功指数（CSI），其定义为 $TS = \\frac{H}{H+M+F}$。ETS考虑了在预报和观测统计上独立的假设下，预期纯粹由随机偶然性导致的命中。\n\n这种偶然重合的基础概率模型是基于预报事件和观测事件的独立性。\n预报事件的概率为 $P(fcst) = \\frac{H + F}{N}$。\n观测事件的概率为 $P(obs) = \\frac{H + M}{N}$。\n\n在独立性假设下，联合发生（一次命中）的概率是各自概率的乘积：\n$$\nP(hit_{random}) = P(fcst) \\times P(obs) = \\left(\\frac{H + F}{N}\\right) \\left(\\frac{H + M}{N}\\right)\n$$\n在总共 $N$ 次试验中，由随机偶然性产生的预期命中次数 $H_{random}$ 为：\n$$\nH_{random} = N \\times P(hit_{random}) = N \\times \\frac{(H + F)(H + M)}{N^2} = \\frac{(H + F)(H + M)}{N}\n$$\nETS的构建方法是从实际命中次数中减去这些随机命中，以获得“有技巧的”命中次数。为了保持评分的公平性，这个随机部分也从分母中减去。TS的分母 $H+M+F$ 代表事件被预报或被观测（或两者皆有）的总次数。\n$$\nETS = \\frac{\\text{实际命中} - \\text{随机命中}}{\\text{事件总数} - \\text{随机命中}} = \\frac{H - H_{random}}{H + M + F - H_{random}}\n$$\n代入 $H_{random}$ 的表达式，ETS的通用公式为：\n$$\nETS = \\frac{H - \\frac{(H + F)(H + M)}{N}}{H + M + F - \\frac{(H + F)(H + M)}{N}}\n$$\n现在，我们在第1部分推导出的条件下简化此表达式，即预报事件频数等于观测事件频数。这个条件是 $H+F = H+M$。\n让我们用 $K$ 表示这个共同的频数，使得 $K = H+F = H+M$。如前所示，这意味着 $F=M$。\n\n在此条件下，随机命中的表达式简化为：\n$$\nH_{random} = \\frac{K \\cdot K}{N} = \\frac{(H + M)^2}{N} \\quad \\text{或等价地} \\quad H_{random} = \\frac{(H + F)^2}{N}\n$$\nETS 的分母 $H+M+F$ 可以使用 $F=M$ 进行改写：\n$$\nH + M + F = H + M + M = H + 2M\n$$\n或者，$H+M+F = (H+M) + F = K+F$。\n\n将这些代入ETS公式：\n$$\nETS = \\frac{H - \\frac{(H+M)^2}{N}}{H + M + F - \\frac{(H+M)^2}{N}}\n$$\n这是在频率偏差为1的条件下ETS的简化表达式。\n\n### 第3部分：数值计算\n\n给定以下情景：\n- 总预报次数：$N = 2500$\n- 观测事件基础率：$0.1$。观测到事件的次数为 $H + M = 0.1 \\times N = 0.1 \\times 2500 = 250$。\n- 预报事件频数与观测事件频数相匹配。这意味着 $H+F = H+M = 250$，这是单位偏差的条件 ($F=M$）。\n- 命中在观测事件中所占的比例为 $0.6$。这得出 $H = 0.6 \\times (H+M)$。\n\n我们现在可以计算 $H, M, F,$ 和 $C$ 的值。\n1.  计算命中 ($H$)：\n    $$\n    H = 0.6 \\times (H+M) = 0.6 \\times 250 = 150\n    $$\n2.  计算漏报 ($M$)：\n    $$\n    M = (H+M) - H = 250 - 150 = 100\n    $$\n3.  计算空报 ($F$)：\n    因为频率偏差为1，所以 $F=M$。\n    $$\n    F = 100\n    $$\n    验证一下：$H+F = 150+100=250$，与 $H+M$ 相符。\n4.  计算正确否定 ($C$)：\n    $$\n    C = N - (H+M+F) = 2500 - (150 + 100 + 100) = 2500 - 350 = 2150\n    $$\n现在，我们计算ETS。首先，计算随机命中次数 $H_{random}$：\n$$\nH_{random} = \\frac{(H + F)(H + M)}{N} = \\frac{250 \\times 250}{2500} = \\frac{62500}{2500} = 25\n$$\n最后，使用通用公式计算ETS：\n$$\nETS = \\frac{H - H_{random}}{H + M + F - H_{random}} = \\frac{150 - 25}{150 + 100 + 100 - 25}\n$$\n$$\nETS = \\frac{125}{350 - 25} = \\frac{125}{325}\n$$\n为简化分数，我们可以将分子和分母同除以它们的最大公约数 $25$：\n$$\nETS = \\frac{125 \\div 25}{325 \\div 25} = \\frac{5}{13}\n$$\n问题要求答案为数值，并四舍五入到四位有效数字。\n$$\nETS = \\frac{5}{13} \\approx 0.38461538...\n$$\n四舍五入到四位有效数字，我们得到 $0.3846$。",
            "answer": "$$\\boxed{0.3846}$$"
        },
        {
            "introduction": "在掌握了基础知识之后，这项练习将挑战您去探索ETS相对于临界成功指数（Critical Success Index, CSI）等更简单指标的独特优势。通过分析一个虚报数不断增加的场景，您将从数学上证明ETS如何更有效地惩罚那些过度预报事件的模式。这项分析性练习对于理解为何ETS被认为是“公平的”并且是一个更优选的工具至关重要，尤其是在评估罕见事件预报时，因为在这类预报中，过度预报的倾向性很强。",
            "id": "4021638",
            "problem": "考虑对数值天气预报中 $N$ 个时空样本的稀有事件预报进行分类验证。设 $2 \\times 2$ 列联表计数为：命中 $H$、漏报 $M$、空报 $F$ 和正确否定 $C$，其中 $H > 0$，$M \\geq 0$，$F \\geq 0$，$C \\geq 0$。观测事件计数为 $S_{o} = H + M$，预报事件计数为 $S_{f} = H + F$，样本大小为 $N = H + M + F + C$。临界成功指数 (CSI) 定义为事件的交并比，即 $\\text{CSI} = H/(H + M + F)$。公平评分是指对于在统计上与随机预报无法区分的预报（给定观测和预报的事件频率），其评分为零。\n\n假设在具有相同边际总和的随机（独立）预报下，期望命中数等于观测事件频率与预报事件频率的乘积，即期望随机命中数 $H_{r}$ 满足 $H_{r} = (S_{o}/N)(S_{f}/N)N = S_{o} S_{f}/N$。从公平性要求和 $\\text{CSI}$ 作为事件集上的交并比度量的定义出发，通过从分子和分母中都减去 $H_{r}$ 来构造 $\\text{CSI}$ 的一个公平修正，使得对于完美预报，结果评分为 $1$，而对于具有相同边际总和的随机预报，评分为 $0$。这个构造就是公平威胁评分 (ETS)。\n\n现在考虑一系列情景，其中 $H$ 和 $M$ 保持不变，$C$ 是一个固定的非负常数，且 $F \\to \\infty$，因此 $N = H + M + F + C \\to \\infty$。设 $\\text{ETS}(F)$ 和 $\\text{CSI}(F)$ 表示在这些约束条件下作为 $F$ 的函数的公平威胁评分和临界成功指数。\n\n确定当 $F \\to \\infty$ 时，比值 $\\text{ETS}(F)/\\text{CSI}(F)$ 的闭式极限，该极限纯粹用 $H$ 和 $M$ 表示。您的最终答案必须以单一解析表达式的形式给出，不带单位，也无需数值计算或四舍五入。",
            "solution": "问题陈述是一个有效、适定的数学问题，其基础是预报检验统计学的原理。所有术语都有明确的定义，前提在科学和数学上都是合理的。因此，我们可以开始求解。\n\n问题要求我们确定在特定的渐近情景下，公平威胁评分 ($\\text{ETS}$) 与临界成功指数 ($\\text{CSI}$) 之比的极限。我们首先将相关量定义为空报数 $F$ 的函数。观测事件总数 $S_o$ 是常数，因为 $H$ 和 $M$ 是固定的：\n$$S_o = H + M$$\n预报事件总数 $S_f$ 取决于 $F$：\n$$S_f(F) = H + F$$\n总样本大小 $N$ 也取决于 $F$：\n$$N(F) = H + M + F + C$$\n临界成功指数 $\\text{CSI}$ 作为 $F$ 的函数由下式给出：\n$$\\text{CSI}(F) = \\frac{H}{H + M + F}$$\n对于具有相同边际总和的随机预报，期望命中数 $H_r$ 为：\n$$H_r(F) = \\frac{S_o S_f(F)}{N(F)} = \\frac{(H+M)(H+F)}{H+M+F+C}$$\n公平威胁评分 $\\text{ETS}$ 是通过从 $\\text{CSI}$ 公式中的分子（命中数 $H$）和分母（并集中的事件总数 $H+M+F$）中都减去随机预报的贡献 $H_r$ 来构造的。因此，$\\text{ETS}$ 作为 $F$ 的函数是：\n$$\\text{ETS}(F) = \\frac{H - H_r(F)}{H + M + F - H_r(F)}$$\n我们需要求当 $F \\to \\infty$ 时比值 $R(F) = \\frac{\\text{ETS}(F)}{\\text{CSI}(F)}$ 的极限。让我们构建这个比值：\n$$R(F) = \\frac{\\frac{H - H_r(F)}{H + M + F - H_r(F)}}{\\frac{H}{H + M + F}} = \\frac{H+M+F}{H} \\cdot \\frac{H-H_r(F)}{H+M+F-H_r(F)}$$\n当 $F \\to \\infty$ 时，该表达式是 $\\infty \\cdot 0$ 型的不定式，因为 $H+M+F \\to \\infty$ 且第二项趋于 $0$。因此，在取极限之前，我们必须进行更详细的代数化简。\n\n让我们把包含 $H_r(F)$ 的项表示为 $F$ 的有理函数。\n首先，第二个分数的分子 $H-H_r(F)$：\n$$H - H_r(F) = H - \\frac{(H+M)(H+F)}{H+M+F+C} = \\frac{H(H+M+F+C) - (H+M)(H+F)}{H+M+F+C}$$\n展开该表达式的分子：\n$$H(H+M+F+C) - (H+M)(H+F) = (H^2 + HM + HF + HC) - (H^2 + HF + MH + MF)$$\n$$= H^2 + HM + HF + HC - H^2 - HF - MH - MF = HC - MF$$\n所以，我们有：\n$$H - H_r(F) = \\frac{HC - MF}{H+M+F+C}$$\n接下来，第二个分数的分母 $H+M+F-H_r(F)$：\n$$H+M+F-H_r(F) = (H+M+F) - \\frac{(H+M)(H+F)}{H+M+F+C}$$\n$$= \\frac{(H+M+F)(H+M+F+C) - (H+M)(H+F)}{H+M+F+C}$$\n该表达式的分子是关于 $F$ 的二次多项式。令 $A = H+M$。该项变为：\n$$(A+F)(A+F+C) - A(H+F) = (A+F)^2 + C(A+F) - A(H+F)$$\n$$= A^2+2AF+F^2+AC+CF - AH-AF = F^2 + (A+C)F + (A^2+AC-AH)$$\n$$= F^2 + (H+M+C)F + (H+M)^2 + C(H+M) - H(H+M)$$\n$$= F^2 + (H+M+C)F + (H+M)(H+M+C-H) = F^2 + (H+M+C)F + (H+M)(M+C)$$\n所以，我们有：\n$$H+M+F-H_r(F) = \\frac{F^2+(H+M+C)F+(H+M)(M+C)}{H+M+F+C}$$\n现在我们将这些表达式代回到比值 $R(F)$ 中：\n$$R(F) = \\frac{H+M+F}{H} \\cdot \\frac{\\frac{HC - MF}{H+M+F+C}}{\\frac{F^2+(H+M+C)F+(H+M)(M+C)}{H+M+F+C}}$$\n公分母 $\\frac{1}{H+M+F+C}$ 消去，剩下：\n$$R(F) = \\frac{H+M+F}{H} \\cdot \\frac{HC - MF}{F^2+(H+M+C)F+(H+M)(M+C)}$$\n$$R(F) = \\frac{(H+M+F)(HC - MF)}{H[F^2+(H+M+C)F+(H+M)(M+C)]}$$\n这是一个关于 $F$ 的有理函数。为了求当 $F \\to \\infty$ 时的极限，我们找出分子和分母中 $F$ 的最高次幂。\n分子是关于 $F$ 的多项式：\n$$\\text{Numerator}(F) = (F+H+M)(-MF+HC) = -MF^2 + (HC-M(H+M))F + HC(H+M)$$\n分子中 $F$ 的最高次幂项是 $-MF^2$。\n分母也是关于 $F$ 的多项式：\n$$\\text{Denominator}(F) = H[F^2+(H+M+C)F+(H+M)(M+C)] = HF^2 + H(H+M+C)F + H(H+M)(M+C)$$\n分母中 $F$ 的最高次幂项是 $HF^2$。\n\n当变量趋于无穷大时，有理函数的极限是最高次幂项系数之比，前提是分子和分母的次数相等。这里，两者都是 2 次。\n$$\\lim_{F \\to \\infty} R(F) = \\lim_{F \\to \\infty} \\frac{-MF^2 + \\dots}{HF^2 + \\dots} = \\frac{-M}{H}$$\n常数 $H$、$M$ 和 $C$ 是固定的，且给定 $H>0$，所以这个极限是良定义的。结果按要求只依赖于 $H$ 和 $M$。",
            "answer": "$$\\boxed{\\frac{-M}{H}}$$"
        },
        {
            "introduction": "这最后一项练习将引导您从理论走向应用，任务是从头开始构建一个自动化的验证流程。您需要将命中、漏报、虚报和随机命中的抽象定义转化为一个处理格点化预报和观测数据的具体算法。通过亲手实现ETS的计算并在一系列不同场景下进行测试，您将获得与数值天气预报和气候模拟领域的研究人员和业务预报员工作直接相关的宝贵实践经验。",
            "id": "4021663",
            "problem": "您需要设计并实现一个用于数值天气预报和气候模拟的自动化分类检验流程。该流程能接收网格化的降水预报场和观测场，应用阈值来定义二元事件的发生，计算标准的列联计数，并为每个案例返回附带完整数值溯源的公平威胁评分（Equitable Threat Score）。您的推导和实现必须从二元分类和独立性的基本定义出发，不得假定任何简化公式。所有降水值的单位均为毫米/天，阈值的单位也为毫米/天。\n\n从以下基础出发：\n- 二元事件指示符通过对标量场进行阈值处理来定义。给定降水场 $X$ 和阈值 $t$，当且仅当 $X \\ge t$（含等于）时，一个格点上发生事件。\n- 在一个包含 $N$ 个格点的区域上，根据其集合论含义定义分类计数：\n  - 命中 $H$：预报事件和观测事件同时发生的格点数。\n  - 漏报 $M$：预报事件未发生而观测事件发生的格点数。\n  - 空报 $F$：预报事件发生而观测事件未发生的格点数。\n- 令 $p_{o}$ 表示观测事件率，$p_{f}$ 表示预报事件率。在预报事件指示符和观测事件指示符相互独立的假设下，联合发生的预期次数等于它们的边际概率乘积再乘以 $N$。\n\n基于此，推导出一个以列联计数和随机命中预期数（通过独立性和边际事件率定义）表示的、经过严格论证的公平威胁评分公式。证明该评分是公平的，即对于除了匹配观测基准率外不提供任何差异信息的预报，其预期技巧评分为零。您的流程必须实现这些定义来计算评分，并返回完整的数值溯源。\n\n算法要求：\n- 给定代表同一网格上预报和观测降水场的两个实值数组，以及一个单位为毫米/天的阈值 $t$，使用包含性规则 $X \\ge t$ 将每个数组映射到一个二元事件场。\n- 根据其定义计算计数 $H$、$M$ 和 $F$，同时计算 $N$ 以及由独立性和边际率推导出的随机命中预期数 $H_{r}$。\n- 使用推导出的表达式从第一性原理计算公平威胁评分，并稳健地处理退化分母；当您的推导所隐含的分母计算结果为零时，将评分定义为 $0.0$。\n- 为每个测试用例返回一个数值溯源列表，顺序为 $[e, h, m, f, h_{r}, n, t, \\mathrm{inc}]$，其中 $e$ 是作为实数的公平威胁评分，$h$、$m$、$f$ 和 $n$ 是整数，$h_{r}$ 是从独立性和边际率计算出的实数，$t$ 是单位为毫米/天的阈值实数，而 $\\mathrm{inc}$ 是指示符，当且仅当阈值判断规则使用 $X \\ge t$ 时为 $1$。\n\n测试套件包含五个科学上合理的案例，它们共同检验了一般行为、完美技巧、退化域和基准率偏差。在所有案例中，数值均为单位为毫米/天的降水率，角度单位不适用，所有输出必须是纯数字（无百分号）：\n- 案例1（混合技巧 $4 \\times 4$ 域，阈值 $t = 10$ 毫米/天）：\n  - 预报场，各行为 $(\\,0,\\,5,\\,12,\\,20\\,)$、$(\\,3,\\,15,\\,8,\\,2\\,)$、$(\\,25,\\,0,\\,10,\\,4\\,)$、$(\\,7,\\,9,\\,11,\\,14\\,)$。\n  - 观测场，各行为 $(\\,1,\\,4,\\,10,\\,22\\,)$、$(\\,0,\\,18,\\,7,\\,3\\,)$、$(\\,20,\\,2,\\,12,\\,6\\,)$、$(\\,8,\\,10,\\,9,\\,13\\,)$。\n- 案例2（完美预报，$4 \\times 4$ 结构同案例1，阈值 $t = 10$ 毫米/天）：\n  - 预报场等于案例1的观测场。\n  - 观测场等于案例1的观测场。\n- 案例3（无事件域 $3 \\times 3$，阈值 $t = 1$ 毫米/天）：\n  - 预报场，各行为 $(\\,0.1,\\,0.3,\\,0.0\\,)$、$(\\,0.5,\\,0.2,\\,0.4\\,)$、$(\\,0.0,\\,0.0,\\,0.1\\,)$。\n  - 观测场，各行为 $(\\,0.0,\\,0.0,\\,0.0\\,)$、$(\\,0.0,\\,0.0,\\,0.0\\,)$、$(\\,0.0,\\,0.0,\\,0.0\\,)$。\n- 案例4（全为空报 $3 \\times 3$，阈值 $t = 5$ 毫米/天）：\n  - 预报场，各行为 $(\\,6,\\,7,\\,0\\,)$、$(\\,0,\\,0,\\,8\\,)$、$(\\,9,\\,0,\\,0\\,)$。\n  - 观测场，各行为 $(\\,0,\\,0,\\,0\\,)$、$(\\,0,\\,0,\\,0\\,)$、$(\\,0,\\,0,\\,0\\,)$。\n- 案例5（有偏基准率 $5 \\times 5$，阈值 $t = 5$ 毫米/天）：\n  - 预报场，各行为 $(\\,0,\\,2,\\,7,\\,3,\\,6\\,)$、$(\\,5,\\,8,\\,1,\\,0,\\,4\\,)$、$(\\,6,\\,9,\\,2,\\,5,\\,7\\,)$、$(\\,0,\\,0,\\,3,\\,8,\\,10\\,)$、$(\\,4,\\,5,\\,6,\\,2,\\,1\\,)$。\n  - 观测场，各行为 $(\\,1,\\,0,\\,6,\\,5,\\,7\\,)$、$(\\,4,\\,7,\\,0,\\,1,\\,3\\,)$、$(\\,5,\\,8,\\,2,\\,3,\\,6\\,)$、$(\\,0,\\,1,\\,4,\\,9,\\,11\\,)$、$(\\,3,\\,6,\\,5,\\,1,\\,0\\,)$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个顶级列表，该列表包含五个按测试用例顺序排列的子列表。每个子列表必须是如上所述的 $[e, h, m, f, h_{r}, n, t, \\mathrm{inc}]$ 格式。该单行输出必须采用 $[[\\ldots],[\\ldots],[\\ldots],[\\ldots],[\\ldots]]$ 的形式，所有条目均为数字并以逗号分隔，无其他文本。",
            "solution": "我们从有限网格上二元事件分类检验的标准列联表定义开始。假设有 $N$ 个格点，索引为 $i \\in \\{1,2,\\ldots,N\\}$。设预报降水场为 $F(i)$（单位：毫米/天），观测降水场为 $O(i)$（单位：毫米/天）。固定一个阈值 $t$（单位：毫米/天）和一个包含性阈值规则，则二元事件指示符为\n$$\nE_{f}(i) = \\mathbf{1}\\{F(i) \\ge t\\}, \\quad E_{o}(i) = \\mathbf{1}\\{O(i) \\ge t\\},\n$$\n其中 $\\mathbf{1}\\{\\cdot\\}$ 是指示函数。分类计数定义如下：\n$$\nH = \\sum_{i=1}^{N} \\mathbf{1}\\{E_{f}(i) = 1 \\,\\wedge\\, E_{o}(i) = 1\\},\n$$\n$$\nM = \\sum_{i=1}^{N} \\mathbf{1}\\{E_{f}(i) = 0 \\,\\wedge\\, E_{o}(i) = 1\\},\n$$\n$$\nF = \\sum_{i=1}^{N} \\mathbf{1}\\{E_{f}(i) = 1 \\,\\wedge\\, E_{o}(i) = 0\\}.\n$$\n这些定义确保了 $H$ 统计联合事件，$M$ 统计预报漏掉的观测事件，$F$ 统计预报了但未观测到的事件。格点总数为\n$$\nN = \\sum_{i=1}^{N} \\mathbf{1}\\{\\text{any}\\} = \\text{grid size}.\n$$\n观测事件率等于\n$$\np_{o} = \\frac{H + M}{N},\n$$\n预报事件率等于\n$$\np_{f} = \\frac{H + F}{N}.\n$$\n在二元指示符 $E_{f}$ 和 $E_{o}$ 相互独立的假设下（即预报除了匹配边际率外，不提供关于事件发生的其他信息），联合发生的预期次数等于边际概率的乘积在整个域上求和，得出\n$$\nH_{r} = N \\, p_{o} \\, p_{f} = N \\left(\\frac{H + M}{N}\\right)\\left(\\frac{H + F}{N}\\right) = \\frac{(H + M)(H + F)}{N}.\n$$\n公平威胁评分（Equitable Threat Score）旨在衡量超出给定基准率下随机预期部分的成功联合检测的比例，该比例通过从总的预报或观测事件机会中移除随机命中后进行归一化。根据第一性原理构建，该评分为\n$$\n\\mathrm{ETS} = \\frac{H - H_{r}}{H + M + F - H_{r}}.\n$$\n其公平性属性直接得出：对于不包含差异信息且独立于观测的预报（即 $E_{f}$ 与 $E_{o}$ 独立且具有相同的边际事件率），命中数的期望值等于 $H_{r}$，因此在期望上 $H \\approx H_{r}$，得出 $\\mathrm{ETS} \\approx \\frac{H - H_{r}}{H + M + F - H_{r}} \\approx 0$。这确保了预报员不能仅仅通过匹配基准率来提高分数。\n\n算法设计：\n- 步骤1：对场进行阈值处理。通过包含性规则 $F(i) \\ge t$ 和 $O(i) \\ge t$ 计算向量 $E_{f}(i)$ 和 $E_{o}(i)$。\n- 步骤2：使用上述指示符逻辑计算分类计数。在向量化形式中，这些是布尔运算和求和：$H = \\sum (E_{f} \\wedge E_{o})$, $M = \\sum (\\neg E_{f} \\wedge E_{o})$, $F = \\sum (E_{f} \\wedge \\neg E_{o})$，而 $N$ 是元素数量。\n- 步骤3：使用独立性和边际率计算随机命中预期数 $H_{r}$：$H_{r} = \\frac{(H + M)(H + F)}{N}$。\n- 步骤4：从推导的公式计算 $\\mathrm{ETS}$。为确保数值稳健性，当分母 $D = H + M + F - H_{r}$ 计算结果为 $0$ 时，定义 $\\mathrm{ETS} = 0.0$；这对应于除了随机机会外没有预报或观测事件机会的退化域，并避免了除以零的错误。\n- 步骤5：将完整的数值溯源组装成列表 $[e, h, m, f, h_{r}, n, t, \\mathrm{inc}]$，其中 $e = \\mathrm{ETS}$，$h = H$，$m = M$，$f = F$，$h_{r}$ 如上所述，$n = N$，$t$ 是单位为毫米/天的阈值，$\\mathrm{inc} = 1$ 表示使用包含性规则。\n\n复杂度和正确性：\n- 每一步在网格上的时间复杂度为 $O(N)$，主要由阈值处理和布尔组合决定。基于独立性的 $H_{r}$ 仅使用标量计数，因此在给定 $H$、$M$、$F$ 和 $N$ 的情况下，其时间复杂度为 $O(1)$。\n- 通过减去根据边际率计算的 $H_{r}$ 来保证公平性属性，这惩罚了仅匹配基准率的预报。\n\n单位和输出：\n- 所有降水值 $F(i)$ 和 $O(i)$ 以及阈值 $t$ 的单位均为毫米/天。\n- 计数 $H$、$M$、$F$ 和 $N$ 是无单位的整数。\n- 随机命中预期数 $H_{r}$ 和 $\\mathrm{ETS}$ 是实数。\n- 阈值规则是包含性的，由 $\\mathrm{inc} = 1$ 表示。\n- 程序输出单行，其中包含一个顶级列表，该列表包含五个按测试用例顺序排列的子列表，每个子列表的形式为 $[e, h, m, f, h_{r}, n, t, \\mathrm{inc}]$。\n\n案例1的示例验证：\n- 对于阈值 $t = 10$ 毫米/天和给定的 $4 \\times 4$ 场，通过 $X \\ge t$ 计算的事件指示符得出 $H = 6$，$M = 1$，$F = 1$，以及 $N = 16$。\n- 边际率得出 $p_{o} = \\frac{7}{16}$ 和 $p_{f} = \\frac{7}{16}$，所以 $H_{r} = \\frac{(6 + 1)(6 + 1)}{16} = \\frac{49}{16} = 3.0625$。\n- 分母为 $D = H + M + F - H_{r} = 6 + 1 + 1 - 3.0625 = 4.9375$，分子为 $H - H_{r} = 2.9375$，所以 $\\mathrm{ETS} = \\frac{2.9375}{4.9375} = \\frac{47}{79} \\approx 0.594936709$。\n- 因此，该案例的输出以 $[0.594936709, 6, 1, 1, 3.0625, 16, 10.0, 1]$ 开始。\n\n其余案例由程序类似地计算，对于退化分母，按规定返回 $\\mathrm{ETS}$ 为 $0.0$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_ets_and_provenance(forecast: np.ndarray, observation: np.ndarray, threshold: float, inclusive: bool = True):\n    \"\"\"\n    Compute categorical counts (H, M, F), expected random hits Hr, and ETS with full numerical provenance.\n    - forecast, observation: numpy arrays of the same shape (precipitation in mm/day).\n    - threshold: float (mm/day).\n    - inclusive: bool indicating event definition uses >= threshold if True, else > threshold.\n    Returns: [e, h, m, f, hr, n, t, inc]\n    \"\"\"\n    if forecast.shape != observation.shape:\n        raise ValueError(\"Forecast and observation must have the same shape.\")\n    # Event indicators under the inclusive or strict rule\n    if inclusive:\n        event_f = forecast >= threshold\n        event_o = observation >= threshold\n        inc = 1\n    else:\n        event_f = forecast > threshold\n        event_o = observation > threshold\n        inc = 0\n\n    # Counts\n    hits = int(np.sum(event_f  event_o))\n    misses = int(np.sum((~event_f)  event_o))\n    false_alarms = int(np.sum(event_f  (~event_o)))\n    n = int(forecast.size)\n\n    # Expected random hits under independence and marginals\n    hr = ((hits + misses) * (hits + false_alarms)) / n if n > 0 else 0.0\n\n    # ETS computation with safe denominator handling\n    denom = (hits + misses + false_alarms) - hr\n    if denom == 0:\n        ets = 0.0\n    else:\n        ets = (hits - hr) / denom\n\n    # Assemble provenance: [e, h, m, f, hr, n, t, inc]\n    return [float(ets), hits, misses, false_alarms, float(hr), n, float(threshold), inc]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Case 1: Mixed-skill 4x4, threshold 10 mm/day\n    forecast1 = np.array([\n        [0, 5, 12, 20],\n        [3, 15, 8, 2],\n        [25, 0, 10, 4],\n        [7, 9, 11, 14]\n    ], dtype=float)\n    obs1 = np.array([\n        [1, 4, 10, 22],\n        [0, 18, 7, 3],\n        [20, 2, 12, 6],\n        [8, 10, 9, 13]\n    ], dtype=float)\n    t1 = 10.0\n\n    # Case 2: Perfect forecast equals observation (same as obs1), threshold 10 mm/day\n    forecast2 = obs1.copy()\n    obs2 = obs1.copy()\n    t2 = 10.0\n\n    # Case 3: No-event domain 3x3, threshold 1 mm/day\n    forecast3 = np.array([\n        [0.1, 0.3, 0.0],\n        [0.5, 0.2, 0.4],\n        [0.0, 0.0, 0.1]\n    ], dtype=float)\n    obs3 = np.array([\n        [0.0, 0.0, 0.0],\n        [0.0, 0.0, 0.0],\n        [0.0, 0.0, 0.0]\n    ], dtype=float)\n    t3 = 1.0\n\n    # Case 4: All false alarms 3x3, threshold 5 mm/day\n    forecast4 = np.array([\n        [6, 7, 0],\n        [0, 0, 8],\n        [9, 0, 0]\n    ], dtype=float)\n    obs4 = np.array([\n        [0, 0, 0],\n        [0, 0, 0],\n        [0, 0, 0]\n    ], dtype=float)\n    t4 = 5.0\n\n    # Case 5: Biased base rates 5x5, threshold 5 mm/day\n    forecast5 = np.array([\n        [0, 2, 7, 3, 6],\n        [5, 8, 1, 0, 4],\n        [6, 9, 2, 5, 7],\n        [0, 0, 3, 8, 10],\n        [4, 5, 6, 2, 1]\n    ], dtype=float)\n    obs5 = np.array([\n        [1, 0, 6, 5, 7],\n        [4, 7, 0, 1, 3],\n        [5, 8, 2, 3, 6],\n        [0, 1, 4, 9, 11],\n        [3, 6, 5, 1, 0]\n    ], dtype=float)\n    t5 = 5.0\n\n    test_cases = [\n        (forecast1, obs1, t1),\n        (forecast2, obs2, t2),\n        (forecast3, obs3, t3),\n        (forecast4, obs4, t4),\n        (forecast5, obs5, t5)\n    ]\n\n    results = []\n    for fcst, obs, thr in test_cases:\n        res = compute_ets_and_provenance(fcst, obs, thr, inclusive=True)\n        results.append(res)\n    \n    # Final print statement in the exact required format.\n    # Convert the list of lists to the required string format\n    print(str(results).replace(\" \", \"\"))\n\n# solve() # This call is commented out to prevent execution in environments where it is not desired.\n# The expected output from running solve() is:\n# [[0.5949367088607594,6,1,1,3.0625,16,10.0,1],[1.0,7,0,0,3.0625,16,10.0,1],[0.0,0,0,0,0.0,9,1.0,1],[-0.07407407407407407,0,0,4,1.7777777777777777,9,5.0,1],[0.26666666666666666,8,4,5,5.88,25,5.0,1]]\n```"
        }
    ]
}