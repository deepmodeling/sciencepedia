{
    "hands_on_practices": [
        {
            "introduction": "A primary goal of model initialization is to distinguish the meteorologically significant slow-evolving flow from spurious, high-frequency gravity waves. Normal-mode decomposition offers a powerful and rigorous framework for this by separating the system's governing equations into a \"slow manifold\" of balanced motions and a \"fast subspace\" of unbalanced inertia-gravity waves. This practice provides a fundamental tool for formally defining and quantifying dynamical imbalance by projecting an initial state onto these subspaces and computing the kinetic energy residing in the fast modes. ",
            "id": "4064940",
            "problem": "A rotating shallow water linear model on a constant Coriolis parameter plane (an $f$-plane) provides a fundamental base for quantifying dynamical imbalance during model initialization and spin-up control in numerical weather prediction and climate modeling. Consider the linearized rotating shallow water equations about a state of rest with mean fluid depth $H$ and surface height perturbation $\\eta$:\n$$\n\\frac{\\partial u}{\\partial t} - f v = - g \\frac{\\partial \\eta}{\\partial x}, \\quad\n\\frac{\\partial v}{\\partial t} + f u = - g \\frac{\\partial \\eta}{\\partial y}, \\quad\n\\frac{\\partial \\eta}{\\partial t} + H \\left( \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y} \\right) = 0,\n$$\nwhere $u$ and $v$ are the horizontal velocity components, $g$ is gravitational acceleration, and $f$ is the Coriolis parameter. For a single spatial Fourier component with wavevector $\\mathbf{k} = (k_x, k_y)$, write the state as the complex Fourier amplitudes $\\hat{u}$, $\\hat{v}$, and $\\hat{\\eta}$ such that spatial derivatives act as multiplication by $i k_x$ and $i k_y$. The evolution can be written as a linear system $\\frac{d}{dt} \\mathbf{s} = A \\mathbf{s}$ with $\\mathbf{s} = [\\hat{u}, \\hat{v}, \\hat{\\eta}]^\\top$ and\n$$\nA =\n\\begin{bmatrix}\n0  f  - g i k_x \\\\\n- f  0  - g i k_y \\\\\n- H i k_x  - H i k_y  0\n\\end{bmatrix}.\n$$\nNormal-mode decomposition diagonalizes this system. The balanced subspace corresponds to the zero-frequency eigenmode, while the unbalanced fast subspace corresponds to the inertia-gravity eigenmodes. The fraction of kinetic energy residing in the fast subspace is defined using the spatially averaged kinetic energy per unit mass for a single Fourier component,\n$$\nE_k = \\frac{1}{4}\\left( |\\hat{u}|^2 + |\\hat{v}|^2 \\right),\n$$\nand the fast-mode contribution computed by projecting the initial state onto the fast eigen-subspace and retaining its velocity components.\n\nTask: Implement a program that, for each specified test case, constructs the matrix $A$, computes its right eigen-decomposition, forms the projection operator onto the fast subspace (nonzero-frequency eigenspaces), applies this projection to the initial Fourier state $\\mathbf{s}_0$, and returns the fraction of kinetic energy in the fast modes defined as\n$$\n\\phi = \\frac{E_{k,\\text{fast}}}{E_{k,\\text{total}}},\n$$\nwhere $E_{k,\\text{fast}}$ is the kinetic energy of the fast-projected state and $E_{k,\\text{total}}$ is the kinetic energy of the initial state. If $E_{k,\\text{total}} = 0$, return $0$.\n\nAll quantities must be treated in the following units: velocity components $u$ and $v$ in $\\text{m s}^{-1}$, surface height perturbation $\\eta$ in $\\text{m}$, gravitational acceleration $g$ in $\\text{m s}^{-2}$, Coriolis parameter $f$ in $\\text{s}^{-1}$, and wavenumbers $k_x$ and $k_y$ in $\\text{m}^{-1}$. The inputs may include complex entries for $\\hat{u}$, $\\hat{v}$, and $\\hat{\\eta}$ representing the complex Fourier amplitudes.\n\nUse the following test suite. Each test case is a tuple $(g, H, f, k_x, k_y, \\hat{u}, \\hat{v}, \\hat{\\eta})$:\n\n$1.$ General midlatitude scales with mixed balanced and unbalanced content:\n$$\n(g, H, f, k_x, k_y, \\hat{u}, \\hat{v}, \\hat{\\eta}) = (9.81, 10000, 10^{-4}, 4\\times 10^{-6}, 3\\times 10^{-6}, 1.5, -0.5, 0.8).\n$$\n\n$2.$ Purely balanced initial state constructed to satisfy geostrophic relations at the given wavenumber:\n$$\ng = 9.81, \\quad H = 10000, \\quad f = 10^{-4}, \\quad k_x = 4\\times 10^{-6}, \\quad k_y = 3\\times 10^{-6},\n$$\nwith\n$$\n\\hat{\\eta} = 1.2, \\quad \\hat{u} = - i \\frac{g k_y}{f} \\hat{\\eta}, \\quad \\hat{v} = i \\frac{g k_x}{f} \\hat{\\eta}.\n$$\n\n$3.$ Zero wavenumber boundary case:\n$$\n(g, H, f, k_x, k_y, \\hat{u}, \\hat{v}, \\hat{\\eta}) = (9.81, 10000, 10^{-4}, 0, 0, 0.7, 0.9, 2.0).\n$$\n\n$4.$ High-wavenumber gravity-wave-dominated regime:\n$$\n(g, H, f, k_x, k_y, \\hat{u}, \\hat{v}, \\hat{\\eta}) = (9.81, 10000, 10^{-4}, 2\\times 10^{-5}, 2\\times 10^{-5}, 0.2, -0.3, 0.05).\n$$\n\n$5.$ Near-inertial regime with very small wavenumber and negligible height perturbation:\n$$\n(g, H, f, k_x, k_y, \\hat{u}, \\hat{v}, \\hat{\\eta}) = (9.81, 10000, 10^{-4}, 10^{-7}, 0, 0.4, 0.4, 0.0).\n$$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\phi_1,\\phi_2,\\phi_3,\\phi_4,\\phi_5]$), where each $\\phi_j$ is the kinetic energy fraction in the fast modes for the $j$-th test case expressed as a decimal.",
            "solution": "The problem requires the calculation of the fraction of kinetic energy contained within the unbalanced, fast-propagating modes (inertia-gravity waves) of a linearized rotating shallow water system. This is a fundamental procedure in data assimilation and model initialization, aiming to filter out high-frequency oscillations that can contaminate a numerical forecast. The solution involves decomposing an initial state into its projections onto the system's normal modes.\n\nThe governing linear system in the Fourier domain is given by $\\frac{d\\mathbf{s}}{dt} = A \\mathbf{s}$, where the state vector is $\\mathbf{s} = [\\hat{u}, \\hat{v}, \\hat{\\eta}]^\\top$ and the dynamics matrix is:\n$$\nA =\n\\begin{bmatrix}\n0  f  - g i k_x \\\\\n- f  0  - g i k_y \\\\\n- H i k_x  - H i k_y  0\n\\end{bmatrix}\n$$\nHere, $\\hat{u}$ and $\\hat{v}$ are the complex Fourier amplitudes of the velocity components, $\\hat{\\eta}$ is the amplitude of the surface height perturbation, $f$ is the Coriolis parameter, $g$ is the gravitational acceleration, $H$ is the mean fluid depth, and $\\mathbf{k} = (k_x, k_y)$ is the wavevector. The number $i$ is the imaginary unit.\n\nThe normal modes of the system are the eigenvectors of the matrix $A$. The associated eigenvalues, $\\lambda$, determine the temporal behavior of these modes. The characteristic equation, $\\det(A - \\lambda I) = 0$, is:\n$$\n-\\lambda \\left( \\lambda^2 + f^2 + gH(k_x^2 + k_y^2) \\right) = 0\n$$\nThis yields three distinct eigenvalues, which represent scaled frequencies:\n$$\n\\lambda_1 = 0 \\quad \\text{(the geostrophic or slow mode)}\n$$\n$$\n\\lambda_{2,3} = \\pm i \\sqrt{f^2 + gHk^2} \\quad \\text{(the inertia-gravity or fast modes)}\n$$\nwhere $k = \\sqrt{k_x^2 + k_y^2}$ is the total wavenumber. The eigenvector associated with $\\lambda_1 = 0$ spans the balanced, or slow, subspace. The two eigenvectors associated with $\\lambda_{2,3} \\neq 0$ (for non-trivial $f$ or $k$) span the unbalanced, or fast, subspace.\n\nTo determine the fraction of energy in the fast modes, we must project the initial state vector $\\mathbf{s}_0$ onto the fast subspace. The set of right eigenvectors of $A$, denoted $\\{\\mathbf{r}_1, \\mathbf{r}_2, \\mathbf{r}_3\\}$, forms a basis for the state space $\\mathbb{C}^3$. Any initial state $\\mathbf{s}_0$ can be uniquely expressed as a linear combination of these eigenvectors:\n$$\n\\mathbf{s}_0 = c_1 \\mathbf{r}_1 + c_2 \\mathbf{r}_2 + c_3 \\mathbf{r}_3\n$$\nThe projection of $\\mathbf{s}_0$ onto the fast subspace, $\\mathbf{s}_{\\text{fast}}$, is the portion of the sum corresponding to the fast modes:\n$$\n\\mathbf{s}_{\\text{fast}} = c_2 \\mathbf{r}_2 + c_3 \\mathbf{r}_3\n$$\nThe coefficients $c_j$ are found using the set of left eigenvectors of $A$, $\\{\\mathbf{l}_j\\}$, which are bi-orthogonal to the right eigenvectors. If normalized such that $\\mathbf{l}_j^\\dagger \\mathbf{r}_k = \\delta_{jk}$ (where $\\dagger$ denotes the conjugate transpose and $\\delta_{jk}$ is the Kronecker delta), the coefficients are given by the projection $c_j = \\mathbf{l}_j^\\dagger \\mathbf{s}_0$.\n\nComputationally, this projection can be implemented using matrix algebra. Let $R$ be the matrix whose columns are the right eigenvectors $\\mathbf{r}_j$. The vector of coefficients $\\mathbf{c} = [c_1, c_2, c_3]^\\top$ is then found by $\\mathbf{c} = R^{-1} \\mathbf{s}_0$. The rows of $R^{-1}$ are the conjugate-transposed left eigenvectors, $\\mathbf{l}_j^\\dagger$.\n\nThe algorithmic steps to find $\\mathbf{s}_{\\text{fast}}$ are:\n1.  For a given set of parameters $(g, H, f, k_x, k_y)$, construct the matrix $A$.\n2.  Numerically compute the eigenvalues $\\lambda_j$ and the matrix of right eigenvectors $R$ of $A$.\n3.  Compute the matrix of left eigenvectors $L = R^{-1}$.\n4.  Given an initial state $\\mathbf{s}_0 = [\\hat{u}_0, \\hat{v}_0, \\hat{\\eta}_0]^\\top$, calculate the coefficient vector $\\mathbf{c} = L \\mathbf{s}_0$.\n5.  Identify the coefficients corresponding to the fast modes (those for which $|\\lambda_j| > \\epsilon$, for a small numerical tolerance $\\epsilon$). Construct a new coefficient vector $\\mathbf{c}_{\\text{fast}}$ where coefficients for slow modes are set to zero.\n6.  Reconstruct the fast-projected state vector: $\\mathbf{s}_{\\text{fast}} = R \\mathbf{c}_{\\text{fast}}$. Let this vector be $\\mathbf{s}_{\\text{fast}} = [\\hat{u}_{\\text{fast}}, \\hat{v}_{\\text{fast}}, \\hat{\\eta}_{\\text{fast}}]^\\top$.\n\nFinally, we calculate the required kinetic energy fraction, $\\phi$. The total initial kinetic energy is:\n$$\nE_{k,\\text{total}} = \\frac{1}{4}\\left( |\\hat{u}_0|^2 + |\\hat{v}_0|^2 \\right)\n$$\nThe kinetic energy of the projected fast-mode component is:\n$$\nE_{k,\\text{fast}} = \\frac{1}{4}\\left( |\\hat{u}_{\\text{fast}}|^2 + |\\hat{v}_{\\text{fast}}|^2 \\right)\n$$\nThe fraction of kinetic energy in the fast modes is then:\n$$\n\\phi = \\frac{E_{k,\\text{fast}}}{E_{k,\\text{total}}}\n$$\nIf $E_{k,\\text{total}} = 0$, the problem specifies that $\\phi$ should be returned as $0$. This procedure is applied to each test case.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print results.\n    \"\"\"\n\n    def calculate_phi(params):\n        \"\"\"\n        Calculates the fraction of kinetic energy in the fast modes for a single test case.\n\n        Args:\n            params: A tuple containing the physical parameters and initial state:\n                    (g, H, f, kx, ky, u_hat, v_hat, eta_hat)\n\n        Returns:\n            The fraction phi as a float.\n        \"\"\"\n        g, H, f, kx, ky = params[:5]\n        u_hat, v_hat, eta_hat = params[5:]\n\n        # For Test Case 2, u_hat and v_hat are defined by geostrophic balance\n        if isinstance(u_hat, str) and u_hat == 'geostrophic':\n            # Note: f cannot be zero for this case, which is true for the test suite.\n            u_hat = -1j * g * ky * eta_hat / f\n            v_hat = 1j * g * kx * eta_hat / f\n\n        u_hat, v_hat, eta_hat = complex(u_hat), complex(v_hat), complex(eta_hat)\n\n        s0 = np.array([u_hat, v_hat, eta_hat], dtype=complex)\n\n        # Calculate total initial kinetic energy\n        # The 1/4 factor cancels in the ratio, so we can omit it.\n        E_k_total = np.abs(u_hat)**2 + np.abs(v_hat)**2\n\n        # If total kinetic energy is zero, the fraction is zero.\n        if E_k_total  1e-12:\n            return 0.0\n\n        # Construct the matrix A\n        A = np.array([\n            [0, f, -1j * g * kx],\n            [-f, 0, -1j * g * ky],\n            [-1j * H * kx, -1j * H * ky, 0]\n        ], dtype=complex)\n\n        # Compute eigen-decomposition of A\n        # eigvals: eigenvalues\n        # R: right eigenvectors (as columns)\n        try:\n            eigvals, R = np.linalg.eig(A)\n        except np.linalg.LinAlgError:\n            # Handle cases where eigendecomposition might fail, though unlikely for this matrix.\n            return np.nan\n\n        # Compute the inverse of R to get the left eigenvectors\n        # The rows of L are the (conjugate transpose of) the left eigenvectors.\n        try:\n            L = np.linalg.inv(R)\n        except np.linalg.LinAlgError:\n            # Handle non-invertible R (degenerate eigenvectors), also unlikely.\n            return np.nan\n\n        # Project the initial state onto the eigenvectors to get the mode coefficients\n        # c = L @ s0\n        c = np.dot(L, s0)\n\n        # Identify fast modes (those with non-zero eigenvalues)\n        # and create a new coefficient vector for only the fast modes.\n        c_fast = np.zeros_like(c, dtype=complex)\n        # Use a small tolerance to identify the zero eigenvalue\n        fast_mode_indices = np.where(np.abs(eigvals)  1e-9)[0]\n        c_fast[fast_mode_indices] = c[fast_mode_indices]\n\n        # Reconstruct the state vector component in the fast subspace\n        # s_fast = R @ c_fast\n        s_fast = np.dot(R, c_fast)\n        \n        u_fast, v_fast = s_fast[0], s_fast[1]\n\n        # Calculate the kinetic energy in the fast modes\n        E_k_fast = np.abs(u_fast)**2 + np.abs(v_fast)**2\n\n        # Return the fraction\n        phi = E_k_fast / E_k_total\n        return phi\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: General midlatitude scales\n        (9.81, 10000, 1e-4, 4e-6, 3e-6, 1.5, -0.5, 0.8),\n        # Case 2: Purely balanced initial state\n        (9.81, 10000, 1e-4, 4e-6, 3e-6, 'geostrophic', 'geostrophic', 1.2),\n        # Case 3: Zero wavenumber\n        (9.81, 10000, 1e-4, 0, 0, 0.7, 0.9, 2.0),\n        # Case 4: High-wavenumber gravity-wave-dominated\n        (9.81, 10000, 1e-4, 2e-5, 2e-5, 0.2, -0.3, 0.05),\n        # Case 5: Near-inertial regime\n        (9.81, 10000, 1e-4, 1e-7, 0, 0.4, 0.4, 0.0)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_phi(case)\n        results.append(f\"{result:.10f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Building on the formal definition of balance, a practical challenge in initialization is ensuring the initial mass and wind fields are mutually consistent. This practice explores a common \"static\" initialization technique that enforces this consistency using the linear balance equation, a direct approximation of the slow manifold. By solving a Poisson equation for the geopotential height, you will learn to derive a balanced mass field from a given wind field, a cornerstone procedure in preparing initial conditions for numerical models. ",
            "id": "4064908",
            "problem": "Consider a two-dimensional, barotropic shallow-water model on a constant Coriolis parameter plane (commonly called an $f$-plane), with square, periodic domain of side length $L$ and uniform grid of $N \\times N$ points. Let the horizontal wind components be $u(x,y)$ and $v(x,y)$ and the mass field be the height $h(x,y)$. The geostrophic balance in terms of geopotential $\\Phi(x,y) = g h(x,y)$, where $g$ is gravitational acceleration, is expressed as $f \\,\\hat{\\mathbf{k}} \\times \\mathbf{v}_g = - \\nabla \\Phi$, where $f$ is the constant Coriolis parameter, $\\hat{\\mathbf{k}}$ is the vertical unit vector, and $\\mathbf{v}_g = (u_g, v_g)$ is the geostrophic wind. Assume periodic boundary conditions in both horizontal directions and neglect any external forcing or friction.\n\nGiven an analyzed wind increment $(\\delta u, \\delta v)$, define the relative vorticity increment as $\\delta \\zeta = \\partial_x \\delta v - \\partial_y \\delta u$. Show that the balanced mass-field increment $\\delta h$ implied by geostrophic balance satisfies the Poisson equation\n$$\n\\nabla^2 \\delta h = \\frac{f}{g} \\, \\delta \\zeta,\n$$\nand that the corresponding geostrophic wind increment reconstructed from $\\delta h$ is\n$$\n\\delta \\mathbf{v}_g = \\frac{g}{f} \\, \\hat{\\mathbf{k}} \\times \\nabla \\delta h = \\left( -\\frac{g}{f} \\, \\partial_y \\delta h \\,,\\, \\frac{g}{f} \\, \\partial_x \\delta h \\right).\n$$\nThe ageostrophic residual increment is then $\\delta \\mathbf{v}_a = (\\delta u, \\delta v) - \\delta \\mathbf{v}_g$. To quantify imbalance relevant for model initialization and spin-up control, define the dimensionless ratio\n$$\nR = \\frac{\\sqrt{\\langle \\lvert \\delta \\mathbf{v}_a \\rvert^2 \\rangle}}{\\sqrt{\\langle \\lvert \\delta \\mathbf{v} \\rvert^2 \\rangle}},\n$$\nwhere $\\langle \\cdot \\rangle$ denotes the spatial mean over the periodic domain and $\\lvert \\delta \\mathbf{v} \\rvert^2 = (\\delta u)^2 + (\\delta v)^2$.\n\nImplement a program that, for specified test cases, constructs $(\\delta u, \\delta v)$, solves the Poisson equation for $\\delta h$ on the periodic domain using a Fast Fourier Transform (FFT), reconstructs $\\delta \\mathbf{v}_g$, computes the residual $\\delta \\mathbf{v}_a$, and outputs the ratio $R$ for each case. Use the discrete Fourier transform with wavenumbers consistent with the periodic domain, and set the zero-wavenumber mode of $\\delta h$ to zero (enforcing zero-mean height increment). Express $R$ as decimal floats.\n\nUse the following parameter values for all test cases:\n- Grid size: $N = 64$ points per dimension.\n- Domain size: $L = 10^6$ meters.\n- Coriolis parameter: $f = 10^{-4}$ s$^{-1}$.\n- Gravitational acceleration: $g = 9.81$ m s$^{-2}$.\n\nConstruct three test cases that span balanced, divergent, and mixed increments:\n1. Balanced, nondivergent increment derived from a streamfunction $\\psi(x,y) = \\psi_0 \\cos(k_x x) \\cos(k_y y)$ with amplitude $\\psi_0 = 5000$ m$^2$ s$^{-1}$, where $k_x = 2\\pi m_x / L$ and $k_y = 2\\pi m_y / L$, with $m_x = 2$ and $m_y = 3$. Define $\\delta u = -\\partial_y \\psi$ and $\\delta v = \\partial_x \\psi$.\n2. Purely divergent, irrotational increment derived from a velocity potential $\\chi(x,y) = \\chi_0 \\cos(k_x x) \\cos(k_y y)$ with amplitude $\\chi_0 = 5000$ m$^2$ s$^{-1}$, where $m_x = 4$ and $m_y = 1$. Define $\\delta u = \\partial_x \\chi$ and $\\delta v = \\partial_y \\chi$.\n3. Mixed increment combining a streamfunction $\\psi(x,y) = \\psi_0 \\cos(k_x x) \\cos(k_y y)$ with $\\psi_0 = 3000$ m$^2$ s$^{-1}$ and $(m_x,m_y) = (3,2)$, and a velocity potential $\\chi(x,y) = \\chi_0 \\cos(k_x x) \\cos(k_y y)$ with $\\chi_0 = 2000$ m$^2$ s$^{-1}$ and $(m_x,m_y) = (1,5)$. Define $(\\delta u, \\delta v)$ as the sum of the nondivergent and irrotational components.\n\nRequirements:\n- Discretize derivatives and solve the Poisson equation spectrally using FFT on the periodic domain. Use angular wavenumbers $k_x$ and $k_y$ computed from the FFT frequency vectors scaled by $2\\pi$. For the Poisson equation $\\nabla^2 \\delta h = \\frac{f}{g} \\delta \\zeta$, solve in spectral space as $\\widehat{\\delta h}(\\mathbf{k}) = - \\widehat{F}(\\mathbf{k}) / \\lvert \\mathbf{k} \\rvert^2$ for nonzero wavenumbers, where $F = \\frac{f}{g} \\delta \\zeta$ and $\\lvert \\mathbf{k} \\rvert^2 = k_x^2 + k_y^2$, and set $\\widehat{\\delta h}(\\mathbf{0}) = 0$.\n- Use the FFT to compute spatial derivatives for vorticity and for reconstructing geostrophic wind from $\\delta h$, ensuring consistency with periodic boundary conditions.\n- For each test case, compute and report the ratio $R$ as a decimal float (dimensionless).\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\").\n\nNo external input is required; hardcode the parameters and test cases as specified above. The final output quantities are dimensionless ratios; no physical units need to be attached to the output values.",
            "solution": "The problem presented is a valid and well-posed exercise in geophysical fluid dynamics, specifically addressing the concept of geostrophic balance and its application in numerical model initialization. We are tasked with quantifying the geostrophic imbalance of given wind field increments in a simplified model framework. The core of the problem involves deriving and then numerically solving a Poisson equation to find the balanced mass field corresponding to a given wind field.\n\nFirst, we will provide the theoretical derivation of the governing equations. Subsequently, we will outline the numerical implementation using spectral methods based on the Fast Fourier Transform (FFT), which is appropriate for the specified periodic domain.\n\n**Theoretical Derivation**\n\nThe foundation of this problem is the geostrophic balance, which describes a state where the Coriolis force is exactly balanced by the pressure gradient force. For an incremental change in the fields, this balance is expressed in terms of the geopotential increment $\\delta \\Phi = g \\delta h$ and the geostrophic wind increment $\\delta \\mathbf{v}_g = (\\delta u_g, \\delta v_g)$:\n$$\nf \\,\\hat{\\mathbf{k}} \\times \\delta \\mathbf{v}_g = - \\nabla \\delta \\Phi\n$$\nwhere $f$ is the Coriolis parameter, $g$ is the gravitational acceleration, $\\delta h$ is the height increment, and $\\hat{\\mathbf{k}}$ is the unit vector in the vertical direction. Expanding the cross product gives the component-wise relations:\n$$\n-f \\delta v_g = - \\partial_x (g \\delta h)\n$$\n$$\nf \\delta u_g = - \\partial_y (g \\delta h)\n$$\nSolving for the components of the geostrophic wind increment yields:\n$$\n\\delta u_g = -\\frac{g}{f} \\partial_y \\delta h \\quad \\text{and} \\quad \\delta v_g = \\frac{g}{f} \\partial_x \\delta h\n$$\nThis can be written compactly as $\\delta \\mathbf{v}_g = \\frac{g}{f} \\hat{\\mathbf{k}} \\times \\nabla \\delta h$, which confirms the expression for the reconstructed geostrophic wind increment provided in the problem statement.\n\nNext, we derive the Poisson equation for the height increment $\\delta h$. The fundamental assumption of this \"linear balance\" procedure is that the vorticity of the balanced flow, represented by the geostrophic wind $\\delta \\mathbf{v}_g$, must be equal to the vorticity of the total given wind increment $\\delta \\mathbf{v} = (\\delta u, \\delta v)$.\n\nThe vorticity of the total wind increment is defined as $\\delta \\zeta = \\partial_x \\delta v - \\partial_y \\delta u$.\nThe vorticity of the geostrophic wind increment, denoted $\\delta \\zeta_g$, is calculated by substituting the expressions for $\\delta u_g$ and $\\delta v_g$:\n$$\n\\delta \\zeta_g = \\partial_x (\\delta v_g) - \\partial_y (\\delta u_g) = \\partial_x \\left(\\frac{g}{f} \\partial_x \\delta h\\right) - \\partial_y \\left(-\\frac{g}{f} \\partial_y \\delta h\\right)\n$$\nSince $f$ and $g$ are constants, we have:\n$$\n\\delta \\zeta_g = \\frac{g}{f} \\left(\\frac{\\partial^2 \\delta h}{\\partial x^2} + \\frac{\\partial^2 \\delta h}{\\partial y^2}\\right) = \\frac{g}{f} \\nabla^2 \\delta h\n$$\nBy equating the geostrophic vorticity with the total vorticity, $\\delta \\zeta_g = \\delta \\zeta$, we establish the relationship that defines the balanced height field:\n$$\n\\frac{g}{f} \\nabla^2 \\delta h = \\delta \\zeta\n$$\nRearranging this equation gives the required Poisson equation for the balanced mass-field increment $\\delta h$:\n$$\n\\nabla^2 \\delta h = \\frac{f}{g} \\delta \\zeta\n$$\n\n**Numerical Method**\n\nThe problem is set on a square, doubly periodic domain, which makes spectral methods based on the 2D Fast Fourier Transform (FFT) an ideal choice for numerical solution. They are computationally efficient and spectrally accurate for differentiation and for solving the Poisson equation.\n\nA continuous field $A(x,y)$ on the grid is represented by a discrete $N \\times N$ array. Its 2D discrete Fourier transform is denoted by $\\hat{A}(k_x, k_y)$. The key property of the Fourier transform is that spatial derivatives become algebraic multiplications in spectral space:\n$$\n\\widehat{\\frac{\\partial A}{\\partial x}} = i k_x \\hat{A} \\quad \\text{and} \\quad \\widehat{\\frac{\\partial A}{\\partial y}} = i k_y \\hat{A}\n$$\nwhere $k_x$ and $k_y$ are the angular wavenumbers. These are constructed from the discrete frequencies provided by `numpy.fft.fftfreq`.\n\nThe solution algorithm proceeds as follows for each test case:\n1.  **Construct Input Field**: The wind increments $(\\delta u, \\delta v)$ are defined analytically on the $N \\times N$ discrete grid using the given streamfunctions and/or velocity potentials.\n2.  **Compute Vorticity**: The vorticity increment $\\delta \\zeta = \\partial_x \\delta v - \\partial_y \\delta u$ is computed spectrally. We first compute the 2D FFTs of $\\delta u$ and $\\delta v$ to get $\\widehat{\\delta u}$ and $\\widehat{\\delta v}$. Then, the transform of the vorticity, $\\widehat{\\delta \\zeta}$, is calculated as:\n    $$\n    \\widehat{\\delta \\zeta}(k_x, k_y) = i k_x \\widehat{\\delta v}(k_x, k_y) - i k_y \\widehat{\\delta u}(k_x, k_y)\n    $$\n3.  **Solve Poisson Equation**: The Poisson equation $\\nabla^2 \\delta h = \\frac{f}{g} \\delta \\zeta$ transforms into an algebraic equation in the spectral domain:\n    $$\n    -(k_x^2 + k_y^2) \\widehat{\\delta h} = \\frac{f}{g} \\widehat{\\delta \\zeta}\n    $$\n    We solve for the spectral coefficients of the height increment, $\\widehat{\\delta h}$:\n    $$\n    \\widehat{\\delta h}(k_x, k_y) = - \\frac{f}{g} \\frac{\\widehat{\\delta \\zeta}(k_x, k_y)}{k_x^2 + k_y^2}\n    $$\n    For the zero-wavenumber mode $(k_x, k_y) = (0,0)$, the denominator is zero. As specified, we set $\\widehat{\\delta h}(0,0) = 0$, which enforces a zero spatial mean for the height increment, i.e., $\\langle \\delta h \\rangle = 0$. This condition ensures a unique solution, and it is valid because the spatial mean of the right-hand side, $\\langle \\delta \\zeta \\rangle$, is guaranteed to be zero on a periodic domain.\n4.  **Reconstruct Geostrophic Wind**: The balanced geostrophic wind increment $\\delta \\mathbf{v}_g$ is reconstructed from the computed $\\delta h$. This is also done spectrally to maintain consistency. We first compute $\\widehat{\\delta h}$ by solving the Poisson equation, then find its spectral components:\n    $$\n    \\widehat{\\delta u_g} = -\\frac{g}{f} (i k_y \\widehat{\\delta h}) \\quad \\text{and} \\quad \\widehat{\\delta v_g} = \\frac{g}{f} (i k_x \\widehat{\\delta h})\n    $$\n    An inverse 2D FFT on $\\widehat{\\delta u_g}$ and $\\widehat{\\delta v_g}$ yields the real-space fields $(\\delta u_g, \\delta v_g)$.\n5.  **Compute Imbalance Ratio**: The ageostrophic residual increment is $\\delta \\mathbf{v}_a = \\delta \\mathbf{v} - \\delta \\mathbf{v}_g$. The imbalance ratio $R$ is then calculated as the ratio of the root-mean-square magnitudes of the ageostrophic and total wind increments:\n    $$\n    R = \\frac{\\sqrt{\\langle (\\delta u_a)^2 + (\\delta v_a)^2 \\rangle}}{\\sqrt{\\langle (\\delta u)^2 + (\\delta v)^2 \\rangle}}\n    $$\n    where $\\langle \\cdot \\rangle$ denotes the mean over all grid points.\n\n**Expected Results for Test Cases**\n*   **Case 1 (Balanced)**: The input wind field is purely rotational (nondivergent), derived from a streamfunction $\\psi$. As shown in the validation thought process, the linear balance equation perfectly relates $\\delta h$ to $\\psi$ by $\\delta h = (f/g)\\psi$. The reconstructed geostrophic wind $\\delta \\mathbf{v}_g$ will be identical to the input wind $\\delta \\mathbf{v}$. Thus, the ageostrophic residual $\\delta \\mathbf{v}_a$ will be zero, and we expect $R \\approx 0$ (up to numerical precision).\n*   **Case 2 (Divergent)**: The input wind is purely divergent (irrotational), derived from a velocity potential $\\chi$. Its vorticity $\\delta \\zeta$ is identically zero. The solution to $\\nabla^2 \\delta h = 0$ with zero mean is $\\delta h = 0$. Consequently, the reconstructed geostrophic wind $\\delta \\mathbf{v}_g$ is zero. The ageostrophic residual is the entire input wind, $\\delta \\mathbf{v}_a = \\delta \\mathbf{v}$. Therefore, we expect $R=1$.\n*   **Case 3 (Mixed)**: The input wind is a sum of rotational and divergent components, $\\delta \\mathbf{v} = \\mathbf{v}_\\psi + \\mathbf{v}_\\chi$. The balance procedure only \"sees\" the vorticity from the rotational part, $\\mathbf{v}_\\psi$. It will reconstruct $\\delta \\mathbf{v}_g = \\mathbf{v}_\\psi$. The ageostrophic residual will be the purely divergent part, $\\delta \\mathbf{v}_a = \\mathbf{v}_\\chi$. The ratio $R$ will thus be the ratio of the energy of the divergent component to the energy of the total wind, yielding a value between $0$ and $1$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the geostrophic imbalance ratio R for three test cases\n    of wind increments in a shallow-water model on a periodic f-plane.\n    \"\"\"\n    # Define physical and numerical-grid constants\n    N = 64\n    L = 1.0e6  # meters\n    f = 1.0e-4  # s^-1\n    g = 9.81  # m/s^2\n\n    # Set up the computational grid and wavenumbers\n    # The grid spacing dx is the same for both dimensions.\n    dx = L / N\n    # Create a 1D coordinate array.\n    x = np.arange(N) * dx\n    # Create 2D coordinate grids. The 'xy' indexing is the default and standard for\n    # ensuring that axis 0 corresponds to the y-dimension and axis 1 to the x-dimension.\n    # xx[i, j] = x[j], yy[i, j] = x[i]\n    xx, yy = np.meshgrid(x, x, indexing='xy')\n\n    # Create 1D array of angular wavenumbers.\n    k_freq = np.fft.fftfreq(N, d=dx)\n    k = 2 * np.pi * k_freq\n    # Create 2D wavenumber grids corresponding to the coordinate grids.\n    # kxx corresponds to differentiation along axis 1 (x).\n    # kyy corresponds to differentiation along axis 0 (y).\n    kxx, kyy = np.meshgrid(k, k, indexing='xy')\n    \n    # Squared total wavenumber.\n    ksq = kxx**2 + kyy**2\n\n    # Define the parameters for the three test cases.\n    test_cases = [\n        # Case 1: Purely balanced (nondivergent) flow.\n        {'psi_params': {'amp': 5000.0, 'mx': 2, 'my': 3}, 'chi_params': None},\n        # Case 2: Purely divergent (irrotational) flow.\n        {'psi_params': None, 'chi_params': {'amp': 5000.0, 'mx': 4, 'my': 1}},\n        # Case 3: Mixed flow with both rotational and divergent components.\n        {\n            'psi_params': {'amp': 3000.0, 'mx': 3, 'my': 2},\n            'chi_params': {'amp': 2000.0, 'mx': 1, 'my': 5}\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Initialize wind increments to zero.\n        du = np.zeros((N, N), dtype=float)\n        dv = np.zeros((N, N), dtype=float)\n\n        # Construct the total wind increment (du, dv) by summing components.\n        # Rotational (nondivergent) component from streamfunction psi.\n        if case['psi_params']:\n            p = case['psi_params']\n            psi0, mx, my = p['amp'], p['mx'], p['my']\n            kx_an = 2 * np.pi * mx / L\n            ky_an = 2 * np.pi * my / L\n            # du = -d/dy(psi)\n            du += psi0 * ky_an * np.cos(kx_an * xx) * np.sin(ky_an * yy)\n            # dv = d/dx(psi)\n            dv -= psi0 * kx_an * np.sin(kx_an * xx) * np.cos(ky_an * yy)\n        \n        # Divergent (irrotational) component from velocity potential chi.\n        if case['chi_params']:\n            c = case['chi_params']\n            chi0, mx, my = c['amp'], c['mx'], c['my']\n            kx_an = 2 * np.pi * mx / L\n            ky_an = 2 * np.pi * my / L\n            # du = d/dx(chi)\n            du -= chi0 * kx_an * np.sin(kx_an * xx) * np.cos(ky_an * yy)\n            # dv = d/dy(chi)\n            dv -= chi0 * ky_an * np.cos(kx_an * xx) * np.sin(ky_an * yy)\n\n        # Compute vorticity spectrally\n        du_hat = np.fft.fft2(du)\n        dv_hat = np.fft.fft2(dv)\n        dzeta_hat = 1j * kxx * dv_hat - 1j * kyy * du_hat\n        \n        # Solve the Poisson equation for the height increment in spectral space.\n        # Equation: -(kxx^2 + kyy^2) * dh_hat = (f/g) * dzeta_hat\n        dh_hat = np.zeros_like(dzeta_hat)\n        # Avoid division by zero at k=0 by using a mask.\n        non_zero_k = ksq != 0\n        dh_hat[non_zero_k] = (f / g) * dzeta_hat[non_zero_k] / (-ksq[non_zero_k])\n        # The mean height is set to zero by ensuring dh_hat[0, 0] = 0.\n\n        # Reconstruct the geostrophic wind increment in spectral space.\n        # dug_hat = -(g/f) * 1j * kyy * dh_hat\n        # dvg_hat = (g/f) * 1j * kxx * dh_hat\n        dug_hat = (-g / f) * 1j * kyy * dh_hat\n        dvg_hat = (g / f) * 1j * kxx * dh_hat\n        \n        # Transform geostrophic winds back to real space.\n        du_g = np.real(np.fft.ifft2(dug_hat))\n        dv_g = np.real(np.fft.ifft2(dvg_hat))\n        \n        # Compute the ageostrophic residual increment.\n        du_a = du - du_g\n        dv_a = dv - dv_g\n        \n        # Calculate the imbalance ratio R.\n        # Mean squared magnitude of the ageostrophic wind.\n        mean_sq_va = np.mean(du_a**2 + dv_a**2)\n        # Mean squared magnitude of the total wind.\n        mean_sq_v = np.mean(du**2 + dv**2)\n        \n        if mean_sq_v  1e-16: # Avoid division by zero for null fields\n            R = 0.0\n        else:\n            R = np.sqrt(mean_sq_va / mean_sq_v)\n            \n        results.append(R)\n\n    # Format and print the final results as specified.\n    print(f\"[{','.join(f'{r:.12f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "An alternative to statically adjusting the initial state is to dynamically guide the model toward a balanced state during the first part of the simulation, a process often called spin-up control. This exercise examines the mathematical foundation of one of the most common methods, Newtonian relaxation or \"nudging,\" where the model state is gently relaxed toward an observational analysis. You will derive the form of the nudging tendency from first principles and connect its strength, the relaxation coefficient $\\alpha$, to a physically intuitive adjustment timescale, providing a key insight into tuning data assimilation systems. ",
            "id": "4064916",
            "problem": "In a global atmospheric model used for Numerical Weather Prediction (NWP) and climate simulations, spin-up control during model initialization can be achieved by adding a Newtonian relaxation (nudging) tendency that drives a prognostic temperature variable toward a prescribed target state. Let the prognostic scalar be denoted by $\\phi$ (representing temperature), and let the prescribed target field be $\\phi_{t}$ obtained from an external analysis. During a short initialization interval, assume that the nudging term is the only active tendency and that the departure $\\delta \\phi(t) = \\phi(t) - \\phi_{t}(t)$ evolves according to a memoryless, linear, time-invariant relaxation that is characterized by a single constant time scale called the e-folding adjustment time, denoted by $\\tau$. The e-folding adjustment time $\\tau$ is defined such that $|\\delta \\phi(t + \\tau)| = |\\delta \\phi(t)| \\exp(-1)$ when the nudging tendency acts alone.\n\nStarting from these assumptions and the definition of the e-folding adjustment time, derive the explicit form of the nudging tendency of $\\phi$ in terms of $\\phi - \\phi_{t}$, and then compute the relaxation coefficient $\\alpha$ required to achieve the specified e-folding adjustment time $\\tau$. Express your final answer for $\\alpha$ in $\\mathrm{s}^{-1}$ as a closed-form analytical expression in terms of $\\tau$. No numerical evaluation is required.",
            "solution": "The problem requires us to derive the functional form of a Newtonian relaxation (nudging) tendency and then to determine the value of the relaxation coefficient, denoted by $\\alpha$, in terms of a specified e-folding adjustment time, $\\tau$.\n\nFirst, we address the derivation of the nudging tendency. The problem states that the departure of the prognostic variable $\\phi$ from its target state $\\phi_t$, defined as $\\delta\\phi = \\phi - \\phi_t$, evolves according to a \"memoryless, linear, time-invariant relaxation\". This description has a precise mathematical interpretation. A relaxation process acts to reduce the departure from a target state.\n-   A **linear** relaxation implies that the tendency is directly proportional to the departure.\n-   The tendency must drive the state $\\phi$ towards the target $\\phi_t$. This means that if the departure $\\phi - \\phi_t$ is positive, the tendency must be negative, and if the departure is negative, the tendency must be positive. This is achieved by making the tendency proportional to the negative of the departure, i.e., $-(\\phi - \\phi_t)$.\n\nCombining these points, we can express the nudging tendency of $\\phi$, which we denote as $\\frac{d\\phi}{dt}_{\\text{nudge}}$, in the following functional form:\n$$\n\\frac{d\\phi}{dt}_{\\text{nudge}} = -\\alpha (\\phi - \\phi_t)\n$$\nHere, $\\alpha$ is the relaxation coefficient, which is a positive constant representing the strength of the nudging. The problem states that $\\alpha$ is related to a time-invariant relaxation process, so $\\alpha$ is constant in time. This is the explicit form of the nudging tendency of $\\phi$ in terms of $\\phi - \\phi_t$.\n\nNext, we must compute the value of $\\alpha$. The problem specifies that during a short initialization interval, the nudging term is the only active tendency. Therefore, the total time rate of change of $\\phi$ is given solely by the nudging tendency:\n$$\n\\frac{d\\phi}{dt} = -\\alpha (\\phi - \\phi_t)\n$$\nWe are interested in the evolution of the departure, $\\delta \\phi(t) = \\phi(t) - \\phi_t(t)$. Taking the time derivative of $\\delta\\phi(t)$ yields:\n$$\n\\frac{d(\\delta\\phi)}{dt} = \\frac{d\\phi}{dt} - \\frac{d\\phi_t}{dt}\n$$\nSubstituting the expression for $\\frac{d\\phi}{dt}$:\n$$\n\\frac{d(\\delta\\phi)}{dt} = -\\alpha (\\phi - \\phi_t) - \\frac{d\\phi_t}{dt} = -\\alpha \\delta\\phi - \\frac{d\\phi_t}{dt}\n$$\nFor the purpose of defining and analyzing the intrinsic properties of the relaxation operator itself, it is standard practice to consider the target state $\\phi_t$ as constant in time during the relaxation process, i.e., $\\frac{d\\phi_t}{dt} = 0$. This is a reasonable assumption for the \"short initialization interval\" mentioned in the problem. Under this assumption, the governing equation for the departure $\\delta\\phi$ simplifies to a first-order linear homogeneous ordinary differential equation:\n$$\n\\frac{d(\\delta\\phi)}{dt} = -\\alpha \\delta\\phi\n$$\nThis equation describes exponential decay. To solve it, we can separate variables:\n$$\n\\frac{d(\\delta\\phi)}{\\delta\\phi} = -\\alpha dt\n$$\nIntegrating both sides from an initial time $t_0$ to a later time $t$:\n$$\n\\int_{\\delta\\phi(t_0)}^{\\delta\\phi(t)} \\frac{1}{\\delta\\phi'} d(\\delta\\phi') = \\int_{t_0}^{t} -\\alpha dt'\n$$\nThis yields:\n$$\n[\\ln|\\delta\\phi'|]_{\\delta\\phi(t_0)}^{\\delta\\phi(t)} = -\\alpha [t']_{t_0}^{t}\n$$\n$$\n\\ln|\\delta\\phi(t)| - \\ln|\\delta\\phi(t_0)| = -\\alpha (t - t_0)\n$$\n$$\n\\ln\\left(\\frac{|\\delta\\phi(t)|}{|\\delta\\phi(t_0)|}\\right) = -\\alpha (t - t_0)\n$$\nExponentiating both sides gives the solution for the magnitude of the departure:\n$$\n|\\delta\\phi(t)| = |\\delta\\phi(t_0)| \\exp(-\\alpha(t - t_0))\n$$\nThe problem provides the definition of the e-folding adjustment time, $\\tau$, as the time interval over which the magnitude of the departure decreases by a factor of $\\exp(-1)$. This is expressed as:\n$$\n|\\delta\\phi(t_0 + \\tau)| = |\\delta\\phi(t_0)| \\exp(-1)\n$$\nWe can now use our derived solution for $|\\delta\\phi(t)|$. Let's set $t = t_0 + \\tau$:\n$$\n|\\delta\\phi(t_0 + \\tau)| = |\\delta\\phi(t_0)| \\exp(-\\alpha((t_0 + \\tau) - t_0)) = |\\delta\\phi(t_0)| \\exp(-\\alpha\\tau)\n$$\nBy equating this result with the given definition of $\\tau$, we get:\n$$\n|\\delta\\phi(t_0)| \\exp(-\\alpha\\tau) = |\\delta\\phi(t_0)| \\exp(-1)\n$$\nAssuming the initial departure is non-zero, i.e., $|\\delta\\phi(t_0)| \\neq 0$, we can divide both sides by $|\\delta\\phi(t_0)|$:\n$$\n\\exp(-\\alpha\\tau) = \\exp(-1)\n$$\nFor this equality to hold, the exponents must be equal:\n$$\n-\\alpha\\tau = -1\n$$\nSolving for the relaxation coefficient $\\alpha$, we find:\n$$\n\\alpha = \\frac{1}{\\tau}\n$$\nThe time scale $\\tau$ has units of time (e.g., seconds, denoted s), so the coefficient $\\alpha$ has units of inverse time (e.g., $\\mathrm{s}^{-1}$), which is consistent with the problem's requirement and the form of the differential equation.",
            "answer": "$$\\boxed{\\frac{1}{\\tau}}$$"
        }
    ]
}