{
    "hands_on_practices": [
        {
            "introduction": "背景误差协方差矩阵 $B$ 不仅仅是对角线上的一系列方差；它的非对角元素代表了不同变量和位置之间误差的相关性。这些相关性通常植根于控制大气运动的物理定律。本练习将指导您如何从一个基本的物理约束——地转平衡——出发，推导出风场分量误差之间的协方差结构，从而将理论物理关系转化为具体的统计模型。",
            "id": "4091344",
            "problem": "考虑一个用于数值天气预报（NWP）数据同化的二维、水平均匀且各向同性的误差场。令地转流函数误差表示为 $\\psi(\\boldsymbol{r})$，其中 $\\boldsymbol{r} = (x,y)$ 是水平位置向量。假设误差为零均值，并且平衡风分量满足以下具有物理动机的关系：$u(\\boldsymbol{r}) = -\\partial \\psi(\\boldsymbol{r}) / \\partial y$ 和 $v(\\boldsymbol{r}) = \\partial \\psi(\\boldsymbol{r}) / \\partial x$，其中 $u$ 和 $v$ 分别是纬向和经向风误差。流函数的背景误差协方差（BEC）函数被指定为一个均匀各向同性的高斯函数，\n$$\nC_{\\psi}(r) = \\sigma_{\\psi}^{2} \\exp\\!\\left(-\\frac{r^{2}}{L^{2}}\\right),\n$$\n其中 $r = |\\boldsymbol{r}|$，$\\sigma_{\\psi}^{2}$ 是流函数误差方差，$L$ 是水平相关长度尺度。\n\n根据协方差的定义，风分量的物理结构化背景误差协方差矩阵 $\\boldsymbol{B}$ 是由从 $\\psi$ 到 $(u,v)$ 的线性微分映射所引出的。将交叉协方差项 $B_{uv}(\\boldsymbol{r})$ 定义为原点处的 $u$ 与位置 $\\boldsymbol{r}$ 处的 $v$ 之间的协方差，即 $B_{uv}(\\boldsymbol{r}) = \\mathbb{E}\\!\\left[ u(\\boldsymbol{0}) \\, v(\\boldsymbol{r}) \\right]$。\n\n从均匀场的协方差基本定义和指定的风-流函数关系出发，推导 $B_{uv}(\\boldsymbol{r})$ 的一个闭式解析表达式，该表达式用 $r$、$\\boldsymbol{r}$ 相对于 $x$ 轴的极角 $\\theta$、$\\sigma_{\\psi}^{2}$ 和 $L$ 来表示。请将您的最终答案表示为单个解析表达式。不要在答案中附加单位。",
            "solution": "该问题是有效的，因为它科学地基于地球物理流体动力学和统计数据同化的原理，问题陈述清晰，提供了所有必要信息，并使用标准的数学和物理术语客观地表述。\n\n我们的任务是推导原点 $\\boldsymbol{0}$ 处的纬向风误差 $u$ 与位置 $\\boldsymbol{r} = (x,y)$ 处的经向风误差 $v$ 之间的交叉协方差 $B_{uv}(\\boldsymbol{r})$。其定义如下：\n$$\nB_{uv}(\\boldsymbol{r}) = \\mathbb{E}\\!\\left[ u(\\boldsymbol{0}) \\, v(\\boldsymbol{r}) \\right]\n$$\n误差被指定为零均值。风分量 $u$ 和 $v$ 通过以下微分算子与地转流函数误差 $\\psi$ 相关联：\n$$\nu(\\boldsymbol{r}) = -\\frac{\\partial \\psi(\\boldsymbol{r})}{\\partial y}\n\\quad \\text{和} \\quad\nv(\\boldsymbol{r}) = \\frac{\\partial \\psi(\\boldsymbol{r})}{\\partial x}\n$$\n为了计算协方差，我们必须为这两个变量引入空间中的两个不同点。令 $u$ 的位置为 $\\boldsymbol{r}' = (x', y')$，$v$ 的位置为 $\\boldsymbol{r} = (x, y)$。协方差的表达式因此涉及到在这两点的导数。我们将在计算的最后设置 $\\boldsymbol{r}'=\\boldsymbol{0}$。\n$$\nB_{uv}(\\boldsymbol{r}) = \\mathbb{E}\\!\\left[ \\left(-\\left.\\frac{\\partial \\psi(\\boldsymbol{r}')}{\\partial y'}\\right|_{\\boldsymbol{r}'=\\boldsymbol{0}}\\right) \\left(\\frac{\\partial \\psi(\\boldsymbol{r})}{\\partial x}\\right) \\right]\n$$\n由于随机场 $\\psi$ 的均值为零，且微分是线性运算，我们可以将期望算子 $\\mathbb{E}$ 与偏导数交换位置：\n$$\nB_{uv}(\\boldsymbol{r}) = -\\frac{\\partial}{\\partial y'} \\frac{\\partial}{\\partial x} \\mathbb{E}\\!\\left[ \\psi(\\boldsymbol{r}') \\psi(\\boldsymbol{r}) \\right] \\bigg|_{\\boldsymbol{r}'=\\boldsymbol{0}}\n$$\n项 $\\mathbb{E}\\!\\left[ \\psi(\\boldsymbol{r}') \\psi(\\boldsymbol{r}) \\right]$ 是流函数场的两点协方差的定义。由于该场被假设为均匀的，该协方差仅取决于分离向量 $\\boldsymbol{\\delta} = \\boldsymbol{r} - \\boldsymbol{r}'$。\n$$\n\\mathbb{E}\\!\\left[ \\psi(\\boldsymbol{r}') \\psi(\\boldsymbol{r}) \\right] = C_{\\psi}(\\boldsymbol{r}-\\boldsymbol{r}')\n$$\n将此代入我们关于 $B_{uv}(\\boldsymbol{r})$ 的表达式中：\n$$\nB_{uv}(\\boldsymbol{r}) = -\\frac{\\partial}{\\partial y'} \\frac{\\partial}{\\partial x} C_{\\psi}(\\boldsymbol{r}-\\boldsymbol{r}') \\bigg|_{\\boldsymbol{r}'=\\boldsymbol{0}}\n$$\n我们来分析关于 $\\boldsymbol{r}=(x,y)$ 和 $\\boldsymbol{r}'=(x',y')$ 分量的导数。令 $\\boldsymbol{\\delta} = (\\delta_x, \\delta_y) = (x-x', y-y')$。使用偏微分的链式法则：\n$$\n\\frac{\\partial}{\\partial x} C_{\\psi}(x-x', y-y') = \\frac{\\partial C_{\\psi}}{\\partial \\delta_x} \\frac{\\partial \\delta_x}{\\partial x} = \\frac{\\partial C_{\\psi}}{\\partial \\delta_x}\n$$\n对于关于 $y'$ 的导数：\n$$\n\\frac{\\partial}{\\partial y'} \\left( \\frac{\\partial C_{\\psi}}{\\partial \\delta_x} \\right) = \\frac{\\partial^2 C_{\\psi}}{\\partial \\delta_y \\partial \\delta_x} \\frac{\\partial \\delta_y}{\\partial y'} = -\\frac{\\partial^2 C_{\\psi}}{\\partial \\delta_y \\partial \\delta_x}\n$$\n将此代回 $B_{uv}(\\boldsymbol{r})$ 的表达式中，得到：\n$$\nB_{uv}(\\boldsymbol{r}) = -\\left( -\\frac{\\partial^2 C_{\\psi}(\\boldsymbol{r}-\\boldsymbol{r}')}{\\partial \\delta_y \\partial \\delta_x} \\right) \\bigg|_{\\boldsymbol{r}'=\\boldsymbol{0}}\n$$\n当我们在 $\\boldsymbol{r}'=\\boldsymbol{0}$ 处求值时，分离向量 $\\boldsymbol{\\delta}$ 变为 $\\boldsymbol{r}$，导数 $\\partial/\\partial \\delta_x$ 和 $\\partial/\\partial \\delta_y$ 分别变为 $\\partial/\\partial x$ 和 $\\partial/\\partial y$。\n$$\nB_{uv}(\\boldsymbol{r}) = \\frac{\\partial^2 C_{\\psi}(\\boldsymbol{r})}{\\partial x \\partial y}\n$$\n现在，我们必须为给定的流函数协方差函数计算这个混合偏导数：\n$$\nC_{\\psi}(r) = \\sigma_{\\psi}^{2} \\exp\\!\\left(-\\frac{r^{2}}{L^{2}}\\right)\n$$\n在笛卡尔坐标系中，$r^2 = x^2 + y^2$，所以函数为：\n$$\nC_{\\psi}(x,y) = \\sigma_{\\psi}^{2} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right)\n$$\n首先，我们对 $y$ 求导：\n$$\n\\frac{\\partial C_{\\psi}}{\\partial y} = \\sigma_{\\psi}^{2} \\frac{\\partial}{\\partial y} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right) = \\sigma_{\\psi}^{2} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right) \\cdot \\left(-\\frac{2y}{L^2}\\right)\n$$\n接下来，我们将结果对 $x$ 求导：\n$$\n\\frac{\\partial^2 C_{\\psi}}{\\partial x \\partial y} = \\frac{\\partial}{\\partial x} \\left[ -\\frac{2y\\sigma_{\\psi}^{2}}{L^2} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right) \\right]\n$$\n将包含 $y$ 的项视为关于 $x$ 求导的常数：\n$$\n\\frac{\\partial^2 C_{\\psi}}{\\partial x \\partial y} = -\\frac{2y\\sigma_{\\psi}^{2}}{L^2} \\cdot \\frac{\\partial}{\\partial x} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right) = -\\frac{2y\\sigma_{\\psi}^{2}}{L^2} \\cdot \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right) \\cdot \\left(-\\frac{2x}{L^2}\\right)\n$$\n简化表达式，我们得到：\n$$\nB_{uv}(x,y) = \\frac{\\partial^2 C_{\\psi}}{\\partial x \\partial y} = \\frac{4xy\\sigma_{\\psi}^{2}}{L^4} \\exp\\!\\left(-\\frac{x^2+y^2}{L^2}\\right)\n$$\n问题要求答案用极坐标 $(r, \\theta)$ 表示，其中 $\\boldsymbol{r}$ 的模为 $r$，相对于 $x$ 轴的极角为 $\\theta$。坐标变换为：\n$$\nx = r \\cos(\\theta)\n\\quad \\text{和} \\quad\ny = r \\sin(\\theta)\n$$\n由此，我们有：\n$$\nx^2+y^2 = r^2\n$$\n$$\nxy = r^2 \\cos(\\theta) \\sin(\\theta)\n$$\n使用三角倍角公式 $2\\sin(\\theta)\\cos(\\theta) = \\sin(2\\theta)$，我们可以写出：\n$$\nxy = \\frac{1}{2} r^2 \\sin(2\\theta)\n$$\n将这些极坐标表达式代入我们关于 $B_{uv}(x,y)$ 的结果中：\n$$\nB_{uv}(r, \\theta) = \\frac{4\\sigma_{\\psi}^{2}}{L^4} \\left(\\frac{1}{2} r^2 \\sin(2\\theta)\\right) \\exp\\!\\left(-\\frac{r^2}{L^2}\\right)\n$$\n最后，简化数值因子，得到交叉协方差的闭式解析表达式：\n$$\nB_{uv}(r, \\theta) = \\frac{2\\sigma_{\\psi}^{2} r^2}{L^4} \\sin(2\\theta) \\exp\\!\\left(-\\frac{r^2}{L^2}\\right)\n$$",
            "answer": "$$\\boxed{\\frac{2\\sigma_{\\psi}^{2} r^{2}}{L^{4}} \\sin(2\\theta) \\exp\\!\\left(-\\frac{r^{2}}{L^{2}}\\right)}$$"
        },
        {
            "introduction": "一旦背景误差协方差 $B$ 和观测误差协方差 $R$ 被指定，它们就共同定义了变分同化问题的数学景观。这个练习将带您深入探讨 $B$ 和 $R$ 的数学特性如何直接影响代价函数的几何形状，特别是其曲率，这由Hessian矩阵来描述。通过分析Hessian矩阵的条件数，您将理解协方差矩阵的设定为何对同化系统优化算法的收敛效率至关重要。",
            "id": "4091350",
            "problem": "在一个用于数值天气预报和气候模拟的简化双变量三维变分(3D-Var)数据同化系统中，考虑两个相邻格点上温度异常的状态向量，记为 $x \\in \\mathbb{R}^{2}$。背景误差协方差矩阵 $B \\in \\mathbb{R}^{2 \\times 2}$ 由一个平稳、均匀的相关结构指定，其中两点之间的相关系数为 $\\rho$，每个点的背景标准差为 $\\sigma_{b}$，因此\n$$\nB = \\sigma_{b}^{2} \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}.\n$$\n单个标量观测测量了两个异常值的算术平均值，其观测误差是独立的、均值为零、方差为 $r$，即 $y = \\tfrac{1}{2}(x_{1} + x_{2}) + \\epsilon$，其中 $\\epsilon \\sim \\mathcal{N}(0, r)$。相应的线性观测算子为 $H \\in \\mathbb{R}^{1 \\times 2}$，其行向量为 $h = \\begin{pmatrix} \\tfrac{1}{2}  \\tfrac{1}{2} \\end{pmatrix}$，观测误差协方差矩阵为 $R = r \\in \\mathbb{R}^{1 \\times 1}$。3D-Var代价函数为\n$$\nJ(x) = \\tfrac{1}{2}(x - x_{b})^{\\top} B^{-1} (x - x_{b}) + \\tfrac{1}{2}(y - H x)^{\\top} R^{-1} (y - H x),\n$$\n控制变量由 $x = x_{b} + B^{1/2} v$ 定义，其中 $B^{1/2}$ 是 $B$ 唯一的对称平方根。\n\n仅使用协方差矩阵的定义、其对称性和正定性，以及二次型的标准线性代数性质，推导 $J$ 关于控制变量 $v$ 的高斯-牛顿 Hessian 矩阵，并用它来计算其谱条件数，该谱条件数定义为其最大特征值与最小特征值之比。取以下参数值：$\\sigma_{b} = 1.2$ 开尔文, $\\rho = 0.8$, 且 $r = (0.3 \\text{ 开尔文})^{2}$。\n\n最终答案以单个无量纲数的形式给出，并四舍五入到四位有效数字。",
            "solution": "该问题经核实具有科学依据、是适定且客观的。这是数据同化理论中的一个标准问题，所有必要的参数和定义都已提供。\n\n目标是计算代价函数 $J$ 关于控制变量 $v$ 的高斯-牛顿 Hessian 矩阵的谱条件数。代价函数由下式给出：\n$$\nJ(x) = \\tfrac{1}{2}(x - x_{b})^{\\top} B^{-1} (x - x_{b}) + \\tfrac{1}{2}(y - H x)^{\\top} R^{-1} (y - H x)\n$$\n控制变量 $v$ 通过变换 $x = x_{b} + B^{1/2} v$ 与状态向量 $x$ 相关，其中 $B^{1/2}$ 是背景误差协方差矩阵 $B$ 的对称平方根。\n\n首先，我们用控制变量 $v$ 来表示代价函数 $J$。\n$J(x)$ 的第一项变为：\n$$\n\\tfrac{1}{2}(x - x_{b})^{\\top} B^{-1} (x - x_{b}) = \\tfrac{1}{2}(B^{1/2} v)^{\\top} B^{-1} (B^{1/2} v)\n$$\n因为 $B^{1/2}$ 是对称的，所以 $(B^{1/2})^{\\top} = B^{1/2}$。并且，$B^{-1} = (B^{1/2}B^{1/2})^{-1} = (B^{1/2})^{-1}(B^{1/2})^{-1}$。\n$$\n= \\tfrac{1}{2} v^{\\top} B^{1/2} (B^{1/2})^{-1} (B^{1/2})^{-1} B^{1/2} v = \\tfrac{1}{2} v^{\\top} I v = \\tfrac{1}{2} v^{\\top} v\n$$\n$J(x)$ 的第二项包含 $y - Hx$ 这一项：\n$$\ny - Hx = y - H(x_b + B^{1/2}v) = (y - Hx_b) - H B^{1/2} v\n$$\n令 $d = y - Hx_b$ 为新息向量（在本例中为标量），并令变换后的观测算子为 $\\tilde{H} = H B^{1/2}$。第二项变为：\n$$\n\\tfrac{1}{2}(d - \\tilde{H}v)^{\\top} R^{-1} (d - \\tilde{H}v)\n$$\n因此，用 $v$ 表示的代价函数为：\n$$\nJ(v) = \\tfrac{1}{2} v^{\\top} v + \\tfrac{1}{2}(d - \\tilde{H}v)^{\\top} R^{-1} (d - \\tilde{H}v)\n$$\n这是关于 $v$ 的二次函数。对于二次代价函数，高斯-牛顿 Hessian 矩阵与精确 Hessian 矩阵相同。我们通过对 $J(v)$ 关于 $v$ 求两次导数来找到 Hessian 矩阵。\n展开第二项：\n$$\nJ(v) = \\tfrac{1}{2} v^{\\top} v + \\tfrac{1}{2}(d^{\\top}R^{-1}d - 2d^{\\top}R^{-1}\\tilde{H}v + v^{\\top}\\tilde{H}^{\\top}R^{-1}\\tilde{H}v)\n$$\n关于 $v$ 的梯度是：\n$$\n\\nabla_v J(v) = v - (\\tilde{H}^{\\top}R^{-1}d) + \\tilde{H}^{\\top}R^{-1}\\tilde{H}v\n$$\nHessian 矩阵是梯度对 $v^{\\top}$ 的导数：\n$$\n\\mathcal{H}_v = \\frac{\\partial(\\nabla_v J(v))}{\\partial v^{\\top}} = I + \\tilde{H}^{\\top}R^{-1}\\tilde{H}\n$$\n代入 $\\tilde{H} = H B^{1/2}$，并注意到由于 $B^{1/2}$ 是对称的，有 $(H B^{1/2})^{\\top} = (B^{1/2})^{\\top} H^{\\top} = B^{1/2} H^{\\top}$：\n$$\n\\mathcal{H}_v = I + B^{1/2} H^{\\top} R^{-1} H B^{1/2}\n$$\n现在我们必须使用给定的参数构造这个矩阵。参数为 $\\sigma_b = 1.2$，$\\rho=0.8$，以及 $R=r=(0.3)^2=0.09$。所以 $R^{-1} = 1/r = 1/0.09 = 100/9$。\n背景误差协方差矩阵为 $B = \\sigma_{b}^{2} \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}$。\n观测算子为 $H = \\begin{pmatrix} 1/2  1/2 \\end{pmatrix}$。\n\n我们来分析 $M = B^{1/2} H^{\\top} R^{-1} H B^{1/2}$ 这一项。\n$H^{\\top}R^{-1}H = \\begin{pmatrix} 1/2 \\\\ 1/2 \\end{pmatrix} (1/r) \\begin{pmatrix} 1/2  1/2 \\end{pmatrix} = \\frac{1}{r} \\begin{pmatrix} 1/4  1/4 \\\\ 1/4  1/4 \\end{pmatrix} = \\frac{1}{4r} \\begin{pmatrix} 1  1 \\\\ 1  1 \\end{pmatrix}$。\n矩阵 $\\begin{pmatrix} 1  1 \\\\ 1  1 \\end{pmatrix}$ 可以用其归一化特征向量表示。矩阵 $\\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}$ 的特征向量是 $u_1 = \\frac{1}{\\sqrt{2}}\\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix}$ 和 $u_2 = \\frac{1}{\\sqrt{2}}\\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix}$。\n注意到 $\\begin{pmatrix} 1  1 \\\\ 1  1 \\end{pmatrix} = 2 u_1 u_1^{\\top}$。\n所以，$M = B^{1/2} \\left( \\frac{2}{4r} u_1 u_1^{\\top} \\right) B^{1/2} = \\frac{1}{2r} B^{1/2} u_1 u_1^{\\top} B^{1/2}$。\n向量 $u_1$ 是矩阵 $\\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}$ 的一个特征向量，对应的特征值为 $1+\\rho$。\n因此，$u_1$ 也是 $B = \\sigma_b^2 \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}$ 的一个特征向量，特征值为 $\\sigma_b^2(1+\\rho)$；同时也是 $B^{1/2}$ 的一个特征向量，特征值为 $\\sqrt{\\sigma_b^2(1+\\rho)} = \\sigma_b\\sqrt{1+\\rho}$。\n所以，$B^{1/2} u_1 = \\sigma_b\\sqrt{1+\\rho} \\ u_1$。\n$u_1^{\\top}B^{1/2}$ 这一项是转置：$(B^{1/2}u_1)^{\\top} = (\\sigma_b\\sqrt{1+\\rho} \\ u_1)^{\\top} = \\sigma_b\\sqrt{1+\\rho} \\ u_1^{\\top}$。\n将这些代回到 $M$ 的表达式中：\n$$\nM = \\frac{1}{2r} (B^{1/2} u_1) (u_1^{\\top} B^{1/2}) = \\frac{1}{2r} (\\sigma_b\\sqrt{1+\\rho} \\ u_1) (\\sigma_b\\sqrt{1+\\rho} \\ u_1^{\\top}) = \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 u_1^{\\top}\n$$\nHessian 矩阵为 $\\mathcal{H}_v = I + M = I + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 u_1^{\\top}$。\n为了求 $\\mathcal{H}_v$ 的特征值，我们可以测试它对特征向量 $u_1$ 和 $u_2$ 的作用。\n对于 $u_1$：\n$\\mathcal{H}_v u_1 = (I + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 u_1^{\\top})u_1 = Iu_1 + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 (u_1^{\\top}u_1)$。\n由于 $u_1$ 是归一化的， $u_1^{\\top}u_1=1$。\n$\\mathcal{H}_v u_1 = u_1 + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 = \\left(1 + \\frac{\\sigma_b^2(1+\\rho)}{2r}\\right)u_1$。\n所以，第一个特征值是 $\\mu_1 = 1 + \\frac{\\sigma_b^2(1+\\rho)}{2r}$。\n\n对于 $u_2$：\n$\\mathcal{H}_v u_2 = (I + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 u_1^{\\top})u_2 = Iu_2 + \\frac{\\sigma_b^2(1+\\rho)}{2r} u_1 (u_1^{\\top}u_2)$。\n由于 $u_1$ 和 $u_2$ 是正交的， $u_1^{\\top}u_2=0$。\n$\\mathcal{H}_v u_2 = u_2 + 0 = 1 \\cdot u_2$。\n所以，第二个特征值是 $\\mu_2 = 1$。\n\n现在，我们代入数值：$\\sigma_b = 1.2$，$\\rho = 0.8$，$r = 0.09$。\n$\\sigma_b^2 = 1.44$。\n$$\n\\mu_1 = 1 + \\frac{1.44(1+0.8)}{2(0.09)} = 1 + \\frac{1.44 \\times 1.8}{0.18} = 1 + 1.44 \\times 10 = 1 + 14.4 = 15.4\n$$\n特征值为 $\\mu_{\\max} = 15.4$ 和 $\\mu_{\\min} = 1$。\n谱条件数 $\\kappa$ 是最大特征值与最小特征值之比：\n$$\n\\kappa(\\mathcal{H}_v) = \\frac{\\mu_{\\max}}{\\mu_{\\min}} = \\frac{15.4}{1} = 15.4\n$$\n题目要求答案四舍五入到四位有效数字。这得到 $15.40$。",
            "answer": "$$\\boxed{15.40}$$"
        },
        {
            "introduction": "在实际应用中，通过统计模型或集合预报估计的背景误差协方差 $B$ 往往会包含虚假的长程相关，这可能导致观测信息不适当地影响远离观测点的分析场，从而降低同化质量。协方差局地化是一种关键的先进技术，旨在通过在长距离上将相关性平滑地削减至零来解决此问题。在本编程练习中，您将亲手实现一种标准的局地化方案——Gaspari-Cohn函数，并将其应用于一个一维同化系统，直观地观察局地化如何改进分析结果。",
            "id": "4091354",
            "problem": "考虑一个与数值天气预报和气候模拟相关的一维数据同化问题，其目标是理解局地化如何影响背景误差协方差矩阵和观测误差协方差矩阵的设定。设状态向量为线性域上的开尔文温标网格化温度场。该问题必须使用以下具有科学依据的基本定义和事实来解决。\n\n基本定义和假设：\n- 状态向量表示为 $\\mathbf{x} \\in \\mathbb{R}^n$，其中 $n$ 是网格点的数量。观测值表示为 $\\mathbf{y} \\in \\mathbb{R}^m$，通过线性观测算子 $\\mathbf{H} \\in \\mathbb{R}^{m \\times n}$ 与状态相关联。\n- $\\mathbf{x}$ 的先验（背景）分布是高斯分布，均值为 $\\mathbf{x}_b$，协方差矩阵为 $\\mathbf{B} \\in \\mathbb{R}^{n \\times n}$。观测误差是零均值的高斯分布，协方差矩阵为 $\\mathbf{R} \\in \\mathbb{R}^{m \\times m}$。\n- 分析（后验）分布是高斯分布，其协方差矩阵 $\\mathbf{A} \\in \\mathbb{R}^{n \\times n}$ 由 $\\mathbf{B}$、$\\mathbf{R}$ 和 $\\mathbf{H}$ 组合确定。协方差局地化通过与局地化相关矩阵 $\\mathbf{L} \\in \\mathbb{R}^{n \\times n}$ 进行 Hadamard（Schur）积来修正 $\\mathbf{B}$，得到 $\\mathbf{B}_{\\text{loc}} = \\mathbf{L} \\odot \\mathbf{B}$。Schur 积定理指出，两个半正定矩阵的逐元素积是半正定的。\n- 局地化相关函数必须是紧支撑和半正定的。对于此问题，使用 Gaspari–Cohn 相关函数，该函数以无量纲距离 $r = d / \\ell_{\\text{loc}}$ 表示，其中 $d$ 是两个网格点之间的物理距离，$\\ell_{\\text{loc}}$ 是局地化长度尺度。定义\n$$\n\\rho(r) = \n\\begin{cases}\n1 - \\frac{5}{3}r^2 + \\frac{5}{8}r^3 + \\frac{1}{2}r^4 - \\frac{1}{4}r^5,  0 \\le r \\le 1, \\\\\n4 - 5r + \\frac{5}{3}r^2 + \\frac{5}{8}r^3 - \\frac{1}{2}r^4 + \\frac{1}{12}r^5 - \\frac{2}{3r},  1  r \\le 2, \\\\\n0,  r > 2.\n\\end{cases}\n$$\n使用 $\\mathbf{L}_{ij} = \\rho\\!\\left(\\frac{d_{ij}}{\\ell_{\\text{loc}}}\\right)$，其中 $d_{ij}$ 是网格点 $i$ 和 $j$ 之间的距离。当 $\\ell_{\\text{loc}} \\le 0$ 时，定义 $\\mathbf{L} = \\mathbf{I}$（单位矩阵）。\n- 背景协方差 $\\mathbf{B}$ 来自一个均匀、各向同性的高斯相关模型，其方差为 $\\sigma_b^2$，相关长度为 $\\ell_b$，因此\n$$\n\\mathbf{B}_{ij} = \\sigma_b^2 \\exp\\!\\left(-\\frac{d_{ij}^2}{2 \\ell_b^2}\\right).\n$$\n\n情景设定：\n- 设 $n = 8$ 个网格点位于位置 $x_i = i \\times 1\\,\\text{km}$，其中 $i \\in \\{0,1,2,3,4,5,6,7\\}$，因此网格间距为 $1\\,\\text{km}$。状态变量是开尔文温标的温度。\n- 设背景标准差为 $\\sigma_b = 2\\,\\text{K}$，背景高斯相关长度为 $\\ell_b = 1.5\\,\\text{km}$。\n- 设 $m = 3$ 个观测值，精确位于状态索引 $i \\in \\{0,3,5\\}$ 处，因此观测算子 $\\mathbf{H}$ 直接在这些索引处选取状态元素。\n- 设观测误差协方差是对角的，三个观测值的标准差分别为 $\\{0.5\\,\\text{K}, 1.0\\,\\text{K}, 0.3\\,\\text{K}\\}$。因此 $\\mathbf{R} = \\mathrm{diag}\\!\\left(\\{(0.5\\,\\text{K})^2,(1.0\\,\\text{K})^2,(0.3\\,\\text{K})^2\\}\\right)$。\n\n要执行的任务：\n1. 构建距离矩阵 $\\mathbf{D} \\in \\mathbb{R}^{n \\times n}$，其元素为 $\\mathbf{D}_{ij} = |x_i - x_j|$，单位为 $\\text{km}$。\n2. 使用给定的高斯相关模型和参数 $\\sigma_b$ 和 $\\ell_b$ 构建背景协方差矩阵 $\\mathbf{B}$。\n3. 构建观测算子矩阵 $\\mathbf{H}$，作为指定观测索引的选择算子。\n4. 对于每个指定的局地化长度尺度 $\\ell_{\\text{loc}}$，构建 Gaspari–Cohn 局地化矩阵 $\\mathbf{L}$ 和局地化背景协方差 $\\mathbf{B}_{\\text{loc}} = \\mathbf{L} \\odot \\mathbf{B}$。\n5. 对于每个 $\\mathbf{B}_{\\text{loc}}$，根据线性高斯数据同化框架，使用 $\\mathbf{H}$ 和 $\\mathbf{R}$ 计算分析协方差矩阵 $\\mathbf{A}$。\n6. 对于每种情况，计算以下指标：\n   - 分析协方差的迹，$\\mathrm{tr}(\\mathbf{A})$，以 $\\text{K}^2$ 表示。\n   - 平均方差缩减因子，定义为 $\\frac{1}{n} \\sum_{i=1}^n \\frac{\\mathbf{A}_{ii}}{\\mathbf{B}_{\\text{loc},ii}}$，该值为无量纲，必须表示为小数。\n   - $\\mathbf{B}_{\\text{loc}}$ 的最小特征值，以 $\\text{K}^2$ 表示。\n   - 一个布尔值，指示 $\\mathbf{B}_{\\text{loc}}$ 是否为数值上半正定，由条件 $\\lambda_{\\min}(\\mathbf{B}_{\\text{loc}}) > 10^{-10}\\,\\text{K}^2$ 定义。\n7. 所有计算必须完全按照规定执行；不得使用此处列出的数据或参数之外的任何外部数据或参数。所有角度都与此问题无关，不需要角度单位。\n\n测试套件：\n- 使用以下四个局地化长度尺度 $\\ell_{\\text{loc}}$（单位为 $\\text{km}$）：\n  - 情况 1：$\\ell_{\\text{loc}} = 0$（边界情况，单位矩阵局地化）。\n  - 情况 2：$\\ell_{\\text{loc}} = 0.5$（紧凑局地化）。\n  - 情况 3：$\\ell_{\\text{loc}} = 1.5$（局地化尺度等于背景相关长度）。\n  - 情况 4：$\\ell_{\\text{loc}} = 100$（在整个域范围内实际上没有局地化）。\n这些情况涵盖了边界条件、强局地化机制、尺度匹配机制和近似均匀机制。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每个测试用例产生一个包含上述指定顺序的四个值的列表。例如，输出必须具有以下形式\n$$\n[\\,[r_{1,1},r_{1,2},r_{1,3},r_{1,4}],\\,[r_{2,1},r_{2,2},r_{2,3},r_{2,4}],\\,[r_{3,1},r_{3,2},r_{3,3},r_{3,4}],\\,[r_{4,1},r_{4,2},r_{4,3},r_{4,4}]\\,],\n$$\n该行中任何地方都没有空格。所有与方差相关的量都必须以 $\\text{K}^2$ 表示，平均方差缩减因子必须表示为小数（无量纲）。布尔值必须表示为 $\\texttt{True}$ 或 $\\texttt{False}$。",
            "solution": "该问题已经过验证，并被确定为是合理的。它在科学上基于线性高斯数据同化原理，数学上是适定的，并且陈述客观。为获得唯一解，所有必要的数据和定义均已提供。\n\n解决方案通过执行问题陈述中概述的步骤来进行。问题的核心是在一维数据同化背景下，为不同的局地化情景构建背景和观测误差协方差矩阵，然后计算分析误差协方差。\n\n首先，我们定义模型域和参数。状态向量 $\\mathbf{x} \\in \\mathbb{R}^n$ 代表 $n=8$ 个点组成的网格上的温度。网格点位于位置 $x_i = i\\,\\text{km}$，其中 $i \\in \\{0, 1, \\dots, 7\\}$。\n\n**1. 距离矩阵, $\\mathbf{D}$**\n任意两个网格点 $i$ 和 $j$ 之间的物理距离由 $d_{ij} = |x_i - x_j|$ 给出。我们构建距离矩阵 $\\mathbf{D} \\in \\mathbb{R}^{n \\times n}$，其元素为 $\\mathbf{D}_{ij} = |i-j|$，单位为 $\\text{km}$。这是一个对角线为零的对称矩阵。\n\n**2. 背景误差协方差矩阵, $\\mathbf{B}$**\n背景误差协方差矩阵 $\\mathbf{B}$ 使用均匀且各向同性的高斯相关函数建模。其元素由下式给出：\n$$\n\\mathbf{B}_{ij} = \\sigma_b^2 \\exp\\!\\left(-\\frac{d_{ij}^2}{2 \\ell_b^2}\\right)\n$$\n其中背景误差标准差为 $\\sigma_b = 2\\,\\text{K}$（因此方差为 $\\sigma_b^2 = 4\\,\\text{K}^2$），背景相关长度尺度为 $\\ell_b = 1.5\\,\\text{km}$。得到的矩阵 $\\mathbf{B}$ 是一个 $8 \\times 8$ 的对称半正定矩阵。\n\n**3. 观测算子, $\\mathbf{H}$，和观测误差协方差, $\\mathbf{R}$**\n在索引为 $\\{0, 3, 5\\}$ 的网格点上有 $m=3$ 个温度观测值。观测算子 $\\mathbf{H} \\in \\mathbb{R}^{m \\times n}$ 是一个线性选择算子，它将状态向量映射到观测空间。它是一个稀疏矩阵，其元素为 $\\mathbf{H}_{1,1}=1$、$\\mathbf{H}_{2,4}=1$ 和 $\\mathbf{H}_{3,6}=1$（对矩阵行/列使用 1-基索引），其他位置为零。更正式地，使用 0-基索引：$\\mathbf{H}_{k, i_k}=1$，其中观测位置为 $i_k \\in \\{0, 3, 5\\}$。\n观测误差不相关，标准差为 $\\{0.5\\,\\text{K}, 1.0\\,\\text{K}, 0.3\\,\\text{K}\\}$。因此，观测误差协方差矩阵 $\\mathbf{R} \\in \\mathbb{R}^{m \\times m}$ 是对角的：\n$$\n\\mathbf{R} = \\mathrm{diag}\\!\\left( (0.5)^2, (1.0)^2, (0.3)^2 \\right) = \\mathrm{diag}\\!\\left( 0.25, 1.0, 0.09 \\right)\\,\\text{K}^2\n$$\n\n**4. 协方差局地化和局地化背景协方差, $\\mathbf{B}_{\\text{loc}}$**\n对于每个指定的局地化长度尺度 $\\ell_{\\text{loc}}$，我们首先构建局地化相关矩阵 $\\mathbf{L} \\in \\mathbb{R}^{n \\times n}$。其元素使用 Gaspari–Cohn 五阶分段有理函数 $\\rho(r)$ 计算，其中 $r = d_{ij} / \\ell_{\\text{loc}}$ 是无量纲距离。\n$$\n\\mathbf{L}_{ij} = \\rho\\!\\left(\\frac{d_{ij}}{\\ell_{\\text{loc}}}\\right)\n$$\n函数 $\\rho(r)$ 定义如下：\n$$\n\\rho(r) = \n\\begin{cases}\n1 - \\frac{5}{3}r^2 + \\frac{5}{8}r^3 + \\frac{1}{2}r^4 - \\frac{1}{4}r^5,  0 \\le r \\le 1, \\\\\n4 - 5r + \\frac{5}{3}r^2 + \\frac{5}{8}r^3 - \\frac{1}{2}r^4 + \\frac{1}{12}r^5 - \\frac{2}{3r},  1  r \\le 2, \\\\\n0,  r > 2.\n\\end{cases}\n$$\n对于 $\\ell_{\\text{loc}} \\le 0$ 的边界情况，问题规定 $\\mathbf{L}$ 是单位矩阵 $\\mathbf{I}$。\n然后，通过取 $\\mathbf{L}$ 和 $\\mathbf{B}$ 的 Hadamard（逐元素）积来获得局地化背景误差协方差矩阵 $\\mathbf{B}_{\\text{loc}}$：\n$$\n\\mathbf{B}_{\\text{loc}} = \\mathbf{L} \\odot \\mathbf{B}\n$$\n根据 Schur 积定理，由于 $\\mathbf{L}$（根据构造）和 $\\mathbf{B}$（作为协方差矩阵）都是半正定的，因此 $\\mathbf{B}_{\\text{loc}}$ 也保证是半正定的。\n\n**5. 分析误差协方差矩阵, $\\mathbf{A}$**\n分析（或后验）误差协方差矩阵 $\\mathbf{A}$ 结合了背景和观测信息。它由最优统计插值或三维变分（3D-Var）的标准公式给出：\n$$\n\\mathbf{A}^{-1} = \\mathbf{B}_{\\text{loc}}^{-1} + \\mathbf{H}^T \\mathbf{R}^{-1} \\mathbf{H}\n$$\n为保证数值稳定性和计算效率，特别是当 $n \\gg m$ 时，最好使用等效的 Kalman 增益形式：\n$$\n\\mathbf{A} = (\\mathbf{I} - \\mathbf{K} \\mathbf{H}) \\mathbf{B}_{\\text{loc}}\n$$\n其中 $\\mathbf{K}$ 是 Kalman 增益矩阵：\n$$\n\\mathbf{K} = \\mathbf{B}_{\\text{loc}} \\mathbf{H}^T (\\mathbf{H} \\mathbf{B}_{\\text{loc}} \\mathbf{H}^T + \\mathbf{R})^{-1}\n$$\n这种形式需要对一个 $m \\times m$ 的矩阵 $(\\mathbf{H} \\mathbf{B}_{\\text{loc}} \\mathbf{H}^T + \\mathbf{R})$ 求逆，在本问题中该矩阵很小（$3 \\times 3$），而不是对更大的 $n \\times n$ 矩阵 $\\mathbf{B}_{\\text{loc}}$ 求逆。对四个指定的 $\\ell_{\\text{loc}}$ 值中的每一个都重复此过程。\n\n**6. 指标计算**\n对于每个得到的分析协方差 $\\mathbf{A}$ 及其对应的局地化背景协方差 $\\mathbf{B}_{\\text{loc}}$，我们计算四个指标：\n1.  **分析协方差的迹**：$\\mathrm{tr}(\\mathbf{A}) = \\sum_{i=0}^{n-1} \\mathbf{A}_{ii}$。这表示同化后系统中总的剩余方差。\n2.  **平均方差缩减因子**：$\\frac{1}{n} \\sum_{i=0}^{n-1} \\frac{\\mathbf{A}_{ii}}{\\mathbf{B}_{\\text{loc},ii}}$。这个无量纲量衡量了所有网格点相对于局地化先验方差的平均方差减少。\n3.  **$\\mathbf{B}_{\\text{loc}}$ 的最小特征值**：$\\lambda_{\\min}(\\mathbf{B}_{\\text{loc}})$。这是矩阵条件数和正定性的一个关键指标。\n4.  **数值上半正定性**：一个布尔值检查，如果 $\\lambda_{\\min}(\\mathbf{B}_{\\text{loc}}) > 10^{-10}\\,\\text{K}^2$ 则为 `True`，否则为 `False`。这验证了矩阵在数值上是否表现良好。\n\n对每个测试用例 $\\ell_{\\text{loc}} \\in \\{0, 0.5, 1.5, 100\\}\\,\\text{km}$ 执行这些计算。然后将结果格式化为所需的输出字符串。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef gaspari_cohn_rho(r):\n    \"\"\"\n    Computes the Gaspari-Cohn correlation function for a given non-dimensional distance r.\n    The function is vectorized to handle numpy arrays.\n    \"\"\"\n    rho = np.zeros_like(r, dtype=float)\n\n    # Case 1: 0 = r = 1\n    mask1 = (r = 0)  (r = 1)\n    r1 = r[mask1]\n    rho[mask1] = 1 - (5/3)*r1**2 + (5/8)*r1**3 + (1/2)*r1**4 - (1/4)*r1**5\n\n    # Case 2: 1  r = 2\n    mask2 = (r  1)  (r = 2)\n    r2 = r[mask2]\n    # Handle division by zero just in case, though r2  1.\n    with np.errstate(divide='ignore', invalid='ignore'):\n        term_inv_r = -2 / (3 * r2)\n    term_inv_r[np.isinf(term_inv_r)] = 0\n    \n    rho[mask2] = 4 - 5*r2 + (5/3)*r2**2 + (5/8)*r2**3 - (1/2)*r2**4 + (1/12)*r2**5 + term_inv_r\n    \n    # Case 3: r  2 is implicitly handled as rho is initialized to zeros.\n\n    return rho\n\ndef solve():\n    \"\"\"\n    Main function to solve the data assimilation problem.\n    \"\"\"\n    # Scenario Specification\n    n = 8\n    grid_points = np.arange(n)\n    sigma_b = 2.0\n    l_b = 1.5\n    \n    m = 3\n    obs_indices = [0, 3, 5]\n    obs_err_std = np.array([0.5, 1.0, 0.3])\n\n    # Test suite\n    test_cases_l_loc = [0.0, 0.5, 1.5, 100.0]\n\n    # Task 1: Construct distance matrix D\n    D = np.abs(grid_points[:, np.newaxis] - grid_points)\n\n    # Task 2: Construct background covariance matrix B\n    B = sigma_b**2 * np.exp(-D**2 / (2 * l_b**2))\n\n    # Task 3: Construct observation operator H\n    H = np.zeros((m, n))\n    H[np.arange(m), obs_indices] = 1.0\n\n    # Construct observation error covariance R\n    R = np.diag(obs_err_std**2)\n\n    results = []\n    \n    for l_loc in test_cases_l_loc:\n        # Task 4: Construct localization matrix L and B_loc\n        if l_loc = 0:\n            L = np.identity(n)\n        else:\n            r = D / l_loc\n            L = gaspari_cohn_rho(r)\n        \n        B_loc = L * B  # Hadamard product\n\n        # Task 5: Compute analysis covariance matrix A\n        # Use the Kalman gain form: A = (I - KH)B\n        # K = B H' (H B H' + R)^-1\n        H_B_loc = H @ B_loc\n        H_B_loc_HT = H_B_loc @ H.T\n        S_inv = np.linalg.inv(H_B_loc_HT + R)\n        K = B_loc @ H.T @ S_inv\n        A = (np.identity(n) - K @ H) @ B_loc\n        \n        # Task 6: Compute metrics\n        # Metric 1: Trace of A\n        trace_A = np.trace(A)\n\n        # Metric 2: Mean variance reduction factor\n        # Using np.diag to get diagonals efficiently\n        diag_A = np.diag(A)\n        diag_B_loc = np.diag(B_loc)\n        # Avoid division by zero, although B_loc diagonal should be  0.\n        with np.errstate(divide='ignore', invalid='ignore'):\n            ratios = diag_A / diag_B_loc\n        ratios[~np.isfinite(ratios)] = 0 # Or some appropriate handling\n        mean_var_reduc = np.mean(ratios)\n\n        # Metric 3: Minimum eigenvalue of B_loc\n        # B_loc is real and symmetric, use eigvalsh for efficiency/stability.\n        eigvals_B_loc = np.linalg.eigvalsh(B_loc)\n        min_eig_B_loc = np.min(eigvals_B_loc)\n\n        # Metric 4: Numerical positive semidefiniteness\n        is_psd = min_eig_B_loc  1e-10\n\n        case_results = [trace_A, mean_var_reduc, min_eig_B_loc, is_psd]\n        results.append(case_results)\n\n    # Final output formatting\n    # Create list of formatted strings for each inner list\n    inner_parts = []\n    for case in results:\n        # Format each item in the inner list\n        formatted_items = []\n        for item in case:\n            if isinstance(item, bool):\n                formatted_items.append(str(item))\n            else:\n                formatted_items.append(f\"{item:.10f}\".rstrip('0').rstrip('.') if '.' in f\"{item:.10f}\" else f\"{item:.0f}\")\n\n        inner_parts.append(f\"[{','.join(formatted_items)}]\")\n\n    final_output = f\"[{','.join(inner_parts)}]\"\n    \n    # An alternative, simpler formatting, letting python's str() handle it.\n    # The first version offers more control over float precision. Let's stick to simple\n    # as the problem does not specify precision. Python's default repr is quite good.\n    inner_parts_simple = [f\"[{','.join(map(str, case))}]\" for case in results]\n    final_output_simple = f\"[{','.join(inner_parts_simple)}]\"\n\n\n    print(final_output_simple)\n\nsolve()\n```"
        }
    ]
}