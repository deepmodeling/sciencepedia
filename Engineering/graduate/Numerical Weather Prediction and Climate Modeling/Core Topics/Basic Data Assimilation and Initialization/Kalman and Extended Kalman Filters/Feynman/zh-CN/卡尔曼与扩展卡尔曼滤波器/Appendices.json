{
    "hands_on_practices": [
        {
            "introduction": "本练习的核心是新息向量（innovation vector），即观测值与模型预报值之差。理解新息的统计特性对于诊断任何资料同化系统的性能都至关重要。在此实践中，你将推导新息的期望均值和协方差，并利用这些理论结果构建一个卡方（chi-square）检验，以检查系统在统计上的一致性。",
            "id": "4057079",
            "problem": "考虑数值天气预报（NWP）中使用卡尔曼滤波器（KF）或扩展卡尔曼滤波器（EKF）的数据同化循环，其中预报状态 $x^{f} \\in \\mathbb{R}^{n}$ 通过观测算子 $\\mathcal{H}(\\cdot)$ 映射到观测空间。新息定义为 $d = y - \\mathcal{H}(x^{f})$，其中 $y \\in \\mathbb{R}^{m}$ 是观测向量。假设以下地球物理数据同化中标准的基础建模假设：\n- 预报（背景）误差 $e^{f} = x^{t} - x^{f}$（其中 $x^{t}$ 是真实状态）是无偏的，满足 $\\mathbb{E}[e^{f}] = 0$，其协方差为 $\\mathcal{P}^{f}$，且服从高斯分布。\n- 观测误差 $e^{o} = y - \\mathcal{H}(x^{t})$ 是无偏的，满足 $\\mathbb{E}[e^{o}] = 0$，其协方差为 $R$，服从高斯分布，且与 $e^{f}$ 独立。\n- 对于 EKF，观测算子在 $x^{f}$ 处是可微且线性化的，因此 $\\mathcal{H}(x^{t}) \\approx \\mathcal{H}(x^{f}) + H (x^{t} - x^{f})$，其中 $H$ 是在 $x^{f}$ 处求值的雅可比矩阵。\n\n在这些假设下，从第一性原理推导新息 $d$ 的期望值和协方差。然后，提出一个基于卡方分布的检验，用于检测 $(\\mathcal{P}^{f}, R)$ 与观测到的新息统计量之间的不一致性。\n\n现在，将您的推导应用于以下科学上合理的配置，该配置涉及 $m = 2$ 个观测值（一个近地表温度和一个水平风分量）和 $n = 3$ 个预报状态变量：\n- 预报状态 $x^{f} = \\begin{pmatrix} 290 \\\\ 12 \\\\ 0.8 \\end{pmatrix}$。\n- 线性化观测算子 $H = \\begin{pmatrix} 1  0  0 \\\\ 0  0  1 \\end{pmatrix}$，因此 $H x^{f} = \\begin{pmatrix} 290 \\\\ 0.8 \\end{pmatrix}$。\n- 观测值 $y = \\begin{pmatrix} 289.5 \\\\ 1.1 \\end{pmatrix}$。\n- 预报误差协方差\n$$\n\\mathcal{P}^{f} = \\begin{pmatrix}\n0.25  0.05  0.03 \\\\\n0.05  1.00  0.02 \\\\\n0.03  0.02  0.16\n\\end{pmatrix}.\n$$\n- 观测误差协方差\n$$\nR = \\begin{pmatrix}\n0.09  0.012 \\\\\n0.012  0.04\n\\end{pmatrix}.\n$$\n\n使用您推导出的表达式，计算该循环中实现的新息的卡方检验统计量。您需要计算的检验统计量是在一致性原假设下，由新息及其协方差构成的二次型。请用一个实数表示您的最终数值答案。将答案四舍五入到四位有效数字。该检验统计量是无量纲的，因此最终答案中无需物理单位。",
            "solution": "该问题要求在数据同化背景下推导新息向量的期望值和协方差，构建用于统计一致性检验的卡方检验，并将这些结果应用于一个具体的数值示例。该问题定义明确，并在科学上基于状态估计和数据同化的原理。\n\n首先，我们推导新息 $d$ 的统计特性。新息定义为观测向量 $y \\in \\mathbb{R}^{m}$ 与投影到观测空间中的预报状态之差，即 $d = y - \\mathcal{H}(x^{f})$。\n\n观测向量 $y$ 通过观测误差 $e^o$ 与真实状态 $x^t$ 相关，即 $y = \\mathcal{H}(x^t) + e^o$。真实状态 $x^t$ 通过预报误差 $e^f$ 与预报状态 $x^f$ 相关，即 $x^t = x^f + e^f$。\n\n对于扩展卡尔曼滤波器（EKF），观测算子 $\\mathcal{H}$ 在预报状态 $x^f$ 附近进行线性化：\n$$\n\\mathcal{H}(x^t) = \\mathcal{H}(x^f + e^f) \\approx \\mathcal{H}(x^f) + H e^f\n$$\n其中 $H$ 是 $\\mathcal{H}$ 在 $x^f$ 处求值的雅可比矩阵。\n\n将这些关系代入新息 $d$ 的定义中：\n$$\nd = y - \\mathcal{H}(x^f) = (\\mathcal{H}(x^t) + e^o) - \\mathcal{H}(x^f)\n$$\n使用线性化，我们得到：\n$$\nd \\approx (\\mathcal{H}(x^f) + H e^f + e^o) - \\mathcal{H}(x^f) = H e^f + e^o\n$$\n该表达式将新息与底层的模式误差和观测误差联系起来。\n\n现在，我们计算新息的期望值 $\\mathbb{E}[d]$。利用期望算子的线性性：\n$$\n\\mathbb{E}[d] \\approx \\mathbb{E}[H e^f + e^o] = \\mathbb{E}[H e^f] + \\mathbb{E}[e^o] = H \\mathbb{E}[e^f] + \\mathbb{E}[e^o]\n$$\n问题陈述预报误差和观测误差都是无偏的，即 $\\mathbb{E}[e^f] = 0$ 且 $\\mathbb{E}[e^o] = 0$。因此，新息的期望值为：\n$$\n\\mathbb{E}[d] \\approx H(0) + 0 = 0\n$$\n在给定假设下，新息的期望值为零。\n\n接下来，我们推导新息的协方差，记为 $S$。协方差定义为 $S = \\text{Cov}(d) = \\mathbb{E}[(d - \\mathbb{E}[d])(d - \\mathbb{E}[d])^T]$。由于 $\\mathbb{E}[d] \\approx 0$，这可简化为 $S \\approx \\mathbb{E}[d d^T]$。\n$$\nS \\approx \\mathbb{E}[(H e^f + e^o)(H e^f + e^o)^T]\n$$\n展开期望内的项：\n$$\nS \\approx \\mathbb{E}[ (H e^f + e^o) ((e^f)^T H^T + (e^o)^T) ] = \\mathbb{E}[ H e^f (e^f)^T H^T + H e^f (e^o)^T + e^o (e^f)^T H^T + e^o (e^o)^T ]\n$$\n根据期望的线性性：\n$$\nS \\approx \\mathbb{E}[H e^f (e^f)^T H^T] + \\mathbb{E}[H e^f (e^o)^T] + \\mathbb{E}[e^o (e^f)^T H^T] + \\mathbb{E}[e^o (e^o)^T]\n$$\n我们可以提出常数矩阵 $H$：\n$$\nS \\approx H \\mathbb{E}[e^f (e^f)^T] H^T + H \\mathbb{E}[e^f (e^o)^T] + \\mathbb{E}[e^o (e^f)^T] H^T + \\mathbb{E}[e^o (e^o)^T]\n$$\n问题给出了协方差矩阵 $\\mathcal{P}^f = \\mathbb{E}[e^f (e^f)^T]$ 和 $R = \\mathbb{E}[e^o (e^o)^T]$。问题还指出预报误差和观测误差是独立的。这意味着它们的互协方差为零：$\\mathbb{E}[e^f (e^o)^T] = \\mathbb{E}[e^f]\\mathbb{E}[(e^o)^T] = 0 \\cdot 0^T = 0$。项 $\\mathbb{E}[e^o (e^f)^T]$ 是其转置，也是一个零矩阵。\n将这些代入 $S$ 的表达式中：\n$$\nS \\approx H \\mathcal{P}^f H^T + H(0) + (0)H^T + R = H \\mathcal{P}^f H^T + R\n$$\n这就是新息向量的理论协方差。\n\n为了提出一个一致性检验，我们利用 $e^f$ 和 $e^o$ 服从高斯分布这一事实。由于 $d \\approx H e^f + e^o$ 是高斯随机向量的线性组合，因此 $d$ 本身也近似服从高斯分布，其均值为 $0$，协方差为 $S$。也就是说，$d \\sim \\mathcal{N}(0, S)$。对于一个服从多元正态分布 $\\mathcal{N}(0, \\Sigma)$ 的随机向量 $z \\in \\mathbb{R}^m$，其二次型 $z^T \\Sigma^{-1} z$ 服从自由度为 $m$ 的卡方分布，记为 $\\chi^2_m$。\n因此，我们可以构建检验统计量 $\\chi^2 = d^T S^{-1} d$。在指定的协方差 $\\mathcal{P}^f$ 和 $R$ 是正确的原假设下，该统计量应服从 $\\chi^2_m$ 分布，其中 $m$ 是观测空间的维度。如果观测到的 $\\chi^2$ 值异常大（例如，位于 $\\chi^2_m$ 分布的上尾部），则表明关于 $\\mathcal{P}^f$ 和 $R$ 的基本假设与观测到的新息不一致。\n\n现在，我们将这些结果应用于给定的数值案例。\n观测向量为 $y = \\begin{pmatrix} 289.5 \\\\ 1.1 \\end{pmatrix}$，映射后的预报为 $H x^f = \\begin{pmatrix} 290 \\\\ 0.8 \\end{pmatrix}$。\n实现的新息 $d$ 为：\n$$\nd = y - Hx^f = \\begin{pmatrix} 289.5 - 290 \\\\ 1.1 - 0.8 \\end{pmatrix} = \\begin{pmatrix} -0.5 \\\\ 0.3 \\end{pmatrix}\n$$\n接下来，我们计算理论新息协方差 $S = H \\mathcal{P}^f H^T + R$。\n给定 $H = \\begin{pmatrix} 1  0  0 \\\\ 0  0  1 \\end{pmatrix}$ 和 $\\mathcal{P}^{f} = \\begin{pmatrix} 0.25  0.05  0.03 \\\\ 0.05  1.00  0.02 \\\\ 0.03  0.02  0.16 \\end{pmatrix}$。\n$$\nH \\mathcal{P}^f = \\begin{pmatrix} 1  0  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} 0.25  0.05  0.03 \\\\ 0.05  1.00  0.02 \\\\ 0.03  0.02  0.16 \\end{pmatrix} = \\begin{pmatrix} 0.25  0.05  0.03 \\\\ 0.03  0.02  0.16 \\end{pmatrix}\n$$\n$$\nH \\mathcal{P}^f H^T = \\begin{pmatrix} 0.25  0.05  0.03 \\\\ 0.03  0.02  0.16 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 0  0 \\\\ 0  1 \\end{pmatrix} = \\begin{pmatrix} 0.25  0.03 \\\\ 0.03  0.16 \\end{pmatrix}\n$$\n现在我们加上观测误差协方差 $R = \\begin{pmatrix} 0.09  0.012 \\\\ 0.012  0.04 \\end{pmatrix}$：\n$$\nS = H \\mathcal{P}^f H^T + R = \\begin{pmatrix} 0.25  0.03 \\\\ 0.03  0.16 \\end{pmatrix} + \\begin{pmatrix} 0.09  0.012 \\\\ 0.012  0.04 \\end{pmatrix} = \\begin{pmatrix} 0.34  0.042 \\\\ 0.042  0.20 \\end{pmatrix}\n$$\n为了计算 $\\chi^2$ 统计量，我们需要 $S$ 的逆矩阵。对于一个 $2 \\times 2$ 矩阵 $\\begin{pmatrix} a  b \\\\ c  d \\end{pmatrix}$，其逆矩阵为 $\\frac{1}{ad-bc} \\begin{pmatrix} d  -b \\\\ -c  a \\end{pmatrix}$。\n$S$ 的行列式为：\n$$\n\\det(S) = (0.34)(0.20) - (0.042)^2 = 0.068 - 0.001764 = 0.066236\n$$\n逆矩阵 $S^{-1}$ 为：\n$$\nS^{-1} = \\frac{1}{0.066236} \\begin{pmatrix} 0.20  -0.042 \\\\ -0.042  0.34 \\end{pmatrix}\n$$\n最后，我们计算检验统计量 $\\chi^2 = d^T S^{-1} d$：\n$$\n\\chi^2 = \\begin{pmatrix} -0.5  0.3 \\end{pmatrix} \\frac{1}{0.066236} \\begin{pmatrix} 0.20  -0.042 \\\\ -0.042  0.34 \\end{pmatrix} \\begin{pmatrix} -0.5 \\\\ 0.3 \\end{pmatrix}\n$$\n分子中的二次型为：\n$$\n\\begin{pmatrix} -0.5  0.3 \\end{pmatrix} \\begin{pmatrix} 0.20  -0.042 \\\\ -0.042  0.34 \\end{pmatrix} \\begin{pmatrix} -0.5 \\\\ 0.3 \\end{pmatrix} = \\begin{pmatrix} -0.5  0.3 \\end{pmatrix} \\begin{pmatrix} (0.20)(-0.5) + (-0.042)(0.3) \\\\ (-0.042)(-0.5) + (0.34)(0.3) \\end{pmatrix}\n$$\n$$\n= \\begin{pmatrix} -0.5  0.3 \\end{pmatrix} \\begin{pmatrix} -0.1 - 0.0126 \\\\ 0.021 + 0.102 \\end{pmatrix} = \\begin{pmatrix} -0.5  0.3 \\end{pmatrix} \\begin{pmatrix} -0.1126 \\\\ 0.123 \\end{pmatrix}\n$$\n$$\n= (-0.5)(-0.1126) + (0.3)(0.123) = 0.0563 + 0.0369 = 0.0932\n$$\n除以行列式得到 $\\chi^2$ 值：\n$$\n\\chi^2 = \\frac{0.0932}{0.066236} \\approx 1.4069925...\n$$\n四舍五入到四位有效数字，检验统计量为 $1.407$。该值将与 $\\chi^2_2$ 分布进行比较以评估一致性。",
            "answer": "$$\\boxed{1.407}$$"
        },
        {
            "introduction": "扩展卡尔曼滤波器通过线性化非线性模型动力学来传播误差协方差。这种线性化由雅可比矩阵（Jacobian matrix）表示，也称为切线性模型（tangent linear model）。本练习提供了一个动手实践的机会，你将为一个简化的、作为地球物理流体动力学基石的正压涡度模型推导和实现雅可比矩阵，并通过将其解析形式与数值近似进行比较来验证其正确性。",
            "id": "4057052",
            "problem": "考虑一个周期性方形域上的简化、无量纲的正压涡度模型。设状态向量为离散时间索引 $k$ 处的离散相对涡度场 $\\boldsymbol{\\zeta}_k \\in \\mathbb{R}^{N}$，其中 $N = n_x n_y$，$n_x$ 是 $x$ 方向的网格点数，$n_y$ 是 $y$ 方向的网格点数。在 beta 平面上，无行星涡度梯度、无摩擦、无强迫的连续正压涡度方程可简化为\n$$\n\\frac{\\partial \\zeta}{\\partial t} = - J(\\psi, \\zeta),\n$$\n其中 $\\zeta = \\nabla^2 \\psi$，$\\psi$ 是流函数，$J(\\psi, \\zeta) = \\frac{\\partial \\psi}{\\partial x} \\frac{\\partial \\zeta}{\\partial y} - \\frac{\\partial \\psi}{\\partial y} \\frac{\\partial \\zeta}{\\partial x}$ 是雅可比项（平流非线性项）。在周期性边界条件和均匀网格下，定义离散中心有限差分算子 $D_x$ 和 $D_y$，它们分别近似于 $\\partial/\\partial x$ 和 $\\partial/\\partial y$；再定义一个离散逆拉普拉斯算子 $P$，使得 $\\boldsymbol{\\psi} = P \\boldsymbol{\\zeta}$ 是离散泊松方程 $\\nabla^2 \\psi = \\zeta$ 在谱空间中强制施加零均值约束下的解。设离散速度分量为\n$$\n\\boldsymbol{u} = - D_y \\boldsymbol{\\psi}, \\quad \\boldsymbol{v} = D_x \\boldsymbol{\\psi},\n$$\n涡度的离散空间导数为\n$$\n\\boldsymbol{\\zeta}_x = D_x \\boldsymbol{\\zeta}, \\quad \\boldsymbol{\\zeta}_y = D_y \\boldsymbol{\\zeta}.\n$$\n则离散的右端项为\n$$\n\\mathbf{F}(\\boldsymbol{\\zeta}) = \\boldsymbol{u} \\circ \\boldsymbol{\\zeta}_x + \\boldsymbol{v} \\circ \\boldsymbol{\\zeta}_y,\n$$\n其中 $\\circ$ 表示逐元素乘法。考虑一个单步前向欧拉时间步长，\n$$\n\\boldsymbol{\\zeta}_{k+1} = \\boldsymbol{\\zeta}_k + \\Delta t \\, \\mathbf{F}(\\boldsymbol{\\zeta}_k),\n$$\n其用于扩展卡尔曼滤波器 (EKF) 的状态转移雅可比矩阵为\n$$\nA_k = I + \\Delta t \\, J_{\\mathbf{F}}(\\boldsymbol{\\zeta}_k),\n$$\n其中 $I$ 是单位矩阵，$J_{\\mathbf{F}}(\\boldsymbol{\\zeta}_k)$ 是 $\\mathbf{F}$ 在 $\\boldsymbol{\\zeta}_k$ 处求值的雅可比矩阵。\n\n你的任务是：\n- 在一个 $x$ 方向长度为 $L_x$、$y$ 方向长度为 $L_y$ 的区域上，构建具有周期性边界条件的均匀网格上的中心有限差分矩阵 $D_x$ 和 $D_y$。使用间距 $d_x = L_x / n_x$ 和 $d_y = L_y / n_y$。\n- 使用离散傅里叶变换在谱空间中实现 $P$，使得对于非零波数，$\\widehat{\\psi}(\\boldsymbol{k}) = - \\widehat{\\zeta}(\\boldsymbol{k}) / \\|\\boldsymbol{k}\\|^2$，而 $\\widehat{\\psi}(\\boldsymbol{0}) = 0$，其中 $\\boldsymbol{k}$ 汇集了 $x$ 和 $y$方向的波数。\n- 推导并实现解析雅可比矩阵 $J_{\\mathbf{F}}(\\boldsymbol{\\zeta})$，它作为一个线性算子作用于扰动 $\\delta \\boldsymbol{\\zeta}$，\n$$\n\\delta \\mathbf{F} = \\left[ \\operatorname{diag}(\\boldsymbol{\\zeta}_x) \\left( - D_y P \\right) + \\operatorname{diag}(\\boldsymbol{u}) D_x + \\operatorname{diag}(\\boldsymbol{\\zeta}_y) \\left( D_x P \\right) + \\operatorname{diag}(\\boldsymbol{v}) D_y \\right] \\delta \\boldsymbol{\\zeta},\n$$\n因此\n$$\nJ_{\\mathbf{F}}(\\boldsymbol{\\zeta}) = \\operatorname{diag}(\\boldsymbol{\\zeta}_x) \\left( - D_y P \\right) + \\operatorname{diag}(\\boldsymbol{u}) D_x + \\operatorname{diag}(\\boldsymbol{\\zeta}_y) \\left( D_x P \\right) + \\operatorname{diag}(\\boldsymbol{v}) D_y.\n$$\n- 通过 $A_k^{(\\text{ana})} = I + \\Delta t \\, J_{\\mathbf{F}}(\\boldsymbol{\\zeta}_k)$ 解析地计算 $A_k$。\n- 通过有限差分法数值地计算雅可比矩阵，即对 $\\boldsymbol{\\zeta}_k$ 的每个分量使用大小为 $\\varepsilon$ 的对称扰动，\n$$\n\\left[J_{\\mathbf{F}}(\\boldsymbol{\\zeta}_k)\\right]_{:,i} \\approx \\frac{\\mathbf{F}(\\boldsymbol{\\zeta}_k + \\varepsilon \\mathbf{e}_i) - \\mathbf{F}(\\boldsymbol{\\zeta}_k - \\varepsilon \\mathbf{e}_i)}{2 \\varepsilon},\n$$\n然后计算 $A_k^{(\\text{num})} = I + \\Delta t \\, J_{\\mathbf{F}}^{(\\text{num})}(\\boldsymbol{\\zeta}_k)$。\n\n通过计算它们差值的弗罗贝尼乌斯范数来比较 $A_k^{(\\text{ana})}$ 和 $A_k^{(\\text{num})}$，\n$$\n\\| A_k^{(\\text{num})} - A_k^{(\\text{ana})} \\|_F.\n$$\n\n测试套件：\n- 案例 1：$n_x = 4$, $n_y = 4$, $L_x = 2\\pi$, $L_y = 2\\pi$, $\\Delta t = 0.01$, $\\boldsymbol{\\zeta}_k$ 是零场, $\\varepsilon = 10^{-6}$。\n- 案例 2：$n_x = 4$, $n_y = 4$, $L_x = 2\\pi$, $L_y = 2\\pi$, $\\Delta t = 0.01$, $\\boldsymbol{\\zeta}_k$ 是一个从固定种子生成的零均值随机场，振幅缩放至 $0.1$, $\\varepsilon = 10^{-5}$。\n- 案例 3：$n_x = 5$, $n_y = 5$, $L_x = 2\\pi$, $L_y = 2\\pi$, $\\Delta t = 0.05$, $\\boldsymbol{\\zeta}_k(i,j) = \\sin(k_x x_j) \\sin(k_y y_i)$，其中 $k_x = 1$, $k_y = 2$，振幅为 $1.0$, $\\varepsilon = 10^{-6}$。\n\n你的程序应该生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的浮点数均四舍五入到 $8$ 位小数，并按测试案例的顺序排列：$[\\|A_1^{(\\text{num})} - A_1^{(\\text{ana})}\\|_F,\\|A_2^{(\\text{num})} - A_2^{(\\text{ana})}\\|_F,\\|A_3^{(\\text{num})} - A_3^{(\\text{ana})}\\|_F]$。",
            "solution": "用户提供了一个问题，要求将一个离散动力系统的解析雅可比矩阵与一个数值计算的雅可比矩阵进行验证。该系统模拟了周期域上的正压涡度方程。任务涉及构建几个离散算子，实现系统动力学，然后计算并比较雅可比矩阵。\n\n### 步骤 1：提取给定信息\n\n-   **状态向量**：在时间 $k$ 的离散相对涡度 $\\boldsymbol{\\zeta}_k \\in \\mathbb{R}^{N}$，其中 $N = n_x n_y$。\n-   **控制方程（连续）**：$\\frac{\\partial \\zeta}{\\partial t} = - J(\\psi, \\zeta)$，其中 $\\zeta = \\nabla^2 \\psi$ 且 $J(\\psi, \\zeta) = \\frac{\\partial \\psi}{\\partial x} \\frac{\\partial \\zeta}{\\partial y} - \\frac{\\partial \\psi}{\\partial y} \\frac{\\partial \\zeta}{\\partial x}$。\n-   **域**：周期性方形（或矩形）域，大小为 $L_x \\times L_y$。\n-   **网格**：均匀网格，有 $n_x \\times n_y$ 个点。间距为 $d_x = L_x / n_x$ 和 $d_y = L_y / n_y$。\n-   **离散算子**：\n    -   $D_x, D_y$：中心有限差分矩阵，用于 $\\partial/\\partial x, \\partial/\\partial y$，具有周期性边界。\n    -   $P$：谱逆拉普拉斯算子，$\\boldsymbol{\\psi} = P \\boldsymbol{\\zeta}$，求解 $\\nabla^2 \\psi = \\zeta$。在傅里叶空间中，对于 $\\boldsymbol{k} \\neq \\boldsymbol{0}$，$\\widehat{\\psi}(\\boldsymbol{k}) = - \\widehat{\\zeta}(\\boldsymbol{k}) / \\|\\boldsymbol{k}\\|^2$；对于 $\\boldsymbol{k} = \\boldsymbol{0}$，$\\widehat{\\psi}(\\boldsymbol{0}) = 0$。\n-   **离散速度和涡度梯度**：\n    -   $\\boldsymbol{u} = - D_y \\boldsymbol{\\psi}$, $\\boldsymbol{v} = D_x \\boldsymbol{\\psi}$。\n    -   $\\boldsymbol{\\zeta}_x = D_x \\boldsymbol{\\zeta}$, $\\boldsymbol{\\zeta}_y = D_y \\boldsymbol{\\zeta}$。\n-   **离散动力学函数**：$\\mathbf{F}(\\boldsymbol{\\zeta}) = \\boldsymbol{u} \\circ \\boldsymbol{\\zeta}_x + \\boldsymbol{v} \\circ \\boldsymbol{\\zeta}_y$，其中 $\\circ$ 是逐元素乘法。\n-   **时间步进方案**：前向欧拉法，$\\boldsymbol{\\zeta}_{k+1} = \\boldsymbol{\\zeta}_k + \\Delta t \\, \\mathbf{F}(\\boldsymbol{\\zeta}_k)$。\n-   **状态转移雅可比矩阵**：$A_k = I + \\Delta t \\, J_{\\mathbf{F}}(\\boldsymbol{\\zeta}_k)$。\n-   **F 的解析雅可比矩阵**：$J_{\\mathbf{F}}(\\boldsymbol{\\zeta}) = \\operatorname{diag}(\\boldsymbol{\\zeta}_x) \\left( - D_y P \\right) + \\operatorname{diag}(\\boldsymbol{u}) D_x + \\operatorname{diag}(\\boldsymbol{\\zeta}_y) \\left( D_x P \\right) + \\operatorname{diag}(\\boldsymbol{v}) D_y$。\n-   **F 的数值雅可比矩阵**：第 $i$ 列由 $\\frac{\\mathbf{F}(\\boldsymbol{\\zeta}_k + \\varepsilon \\mathbf{e}_i) - \\mathbf{F}(\\boldsymbol{\\zeta}_k - \\varepsilon \\mathbf{e}_i)}{2 \\varepsilon}$ 给出。\n-   **比较度量**：弗罗贝尼乌斯范数的差，$\\| A_k^{(\\text{num})} - A_k^{(\\text{ana})} \\|_F$。\n-   **测试案例**：\n    1.  $n_x = 4, n_y = 4, L_x = 2\\pi, L_y = 2\\pi, \\Delta t = 0.01, \\boldsymbol{\\zeta}_k = \\mathbf{0}, \\varepsilon = 10^{-6}$。\n    2.  $n_x = 4, n_y = 4, L_x = 2\\pi, L_y = 2\\pi, \\Delta t = 0.01$，$\\boldsymbol{\\zeta}_k$ 是一个均值为零、振幅为 $0.1$ 的随机场（从固定种子生成），$\\varepsilon = 10^{-5}$。\n    3.  $n_x = 5, n_y = 5, L_x = 2\\pi, L_y = 2\\pi, \\Delta t = 0.05, \\boldsymbol{\\zeta}_k(i,j) = \\sin(k_x x_j) \\sin(k_y y_i)$，其中 $k_x = 1, k_y = 2$，振幅为 $1.0$，$\\varepsilon = 10^{-6}$。\n\n### 步骤 2：使用提取的给定信息进行验证\n\n-   **科学基础**：该问题设置在地球物理流体动力学和数据同化（EKF）的背景下，这些都是成熟的科学领域。该模型是浅水方程的标准简化。平流项 $\\mathbf{F}$ 的离散形式与标准正压涡度方程（$u\\zeta_x - v\\zeta_y$）存在符号差异，因为它被给出为 $u\\zeta_x + v\\zeta_y$。然而，问题是自洽的：它定义了一个函数 $\\mathbf{F}$ 并要求计算其雅可比矩阵。该任务是一个数学和数值分析练习，而不是对物理保真度的测试。该设置在内部是一致的且在数学上是严谨的。\n-   **适定性**：任务是计算一个标量值（矩阵差的弗罗贝尼乌斯范数）。所有必要的函数、参数和方法都已明确定义。对于每个测试案例，都存在唯一、稳定且有意义的解。\n-   **客观性**：问题使用精确的数学语言和定量数据进行描述。没有主观或含糊的陈述。\n\n该问题没有无效性缺陷。它在数值方法的背景下具有科学基础，是适定的，并且是客观的。\n\n### 步骤 3：结论与行动\n\n问题陈述是**有效的**。将提供一个解决方案。\n\n### 基于原则的解决方案设计\n\n问题的核心是实现几个线性算子和一个非线性函数，然后计算并比较该函数的雅可比矩阵的两种不同表示。解决方案的结构将系统地构建每个组件。\n\n1.  **离散化和索引**：我们将二维涡度场 $\\zeta(y,x)$ 表示为形状为 $(n_y, n_x)$ 的二维 `numpy` 数组。第一个索引对应于 $y$ 方向（行），第二个索引对应于 $x$ 方向（列）。当需要一维状态向量 $\\boldsymbol{\\zeta}$ 时，这个二维数组将以行主序（'C' 序）展平。所有线性算子（$D_x, D_y, P$）都将构建为密集的 $N \\times N$ 矩阵，其中 $N=n_x n_y$，与此展平方案一致。\n\n2.  **有限差分算子 ($D_x, D_y$)**：这些矩阵表示周期性网格上的中心差分。对于一个 $N$ 点网格，矩阵的第 $k$ 行将在对应于第 $k$ 个网格点邻居的位置上有非零项。对于我们展平为一维的二维网格，点 $(i,j)$（平展索引为 $k=i \\cdot n_x + j$）的邻居是 $D_x$ 的 $(i, j \\pm 1)$ 和 $D_y$ 的 $(i \\pm 1, j)$。周期性边界条件通过对索引使用模运算来处理。\n\n3.  **谱逆拉普拉斯算子 ($P$)**：这个算子最自然的实现方式是作为一个函数，将其输入向量转换到傅里叶空间。\n    -   输入向量 $\\boldsymbol{\\zeta}$ 被重塑为一个二维场。\n    -   应用二维快速傅里叶变换（FFT）得到 $\\widehat{\\boldsymbol{\\zeta}}$。\n    -   构建一个波数平方网格，$\\|\\boldsymbol{k}\\|^2 = k_x^2 + k_y^2$。\n    -   通过将 $\\widehat{\\boldsymbol{\\zeta}}$ 除以 $-\\|\\boldsymbol{k}\\|^2$ 来计算所有非零波数的 $\\widehat{\\boldsymbol{\\psi}}$。$\\widehat{\\boldsymbol{\\psi}}$ 的零波数分量设置为零，从而对流函数强制施加零均值。\n    -   逆二维 FFT 产生二维流函数场 $\\boldsymbol{\\psi}$，然后将其展平。\n    -   为了获得矩阵形式 $P_{\\text{mat}}$，将此函数应用于每个标准基向量 $\\mathbf{e}_i$，结果构成 $P_{\\text{mat}}$ 的第 $i$ 列。\n\n4.  **非线性动力学函数 ($\\mathbf{F}$)**：此函数接收 $\\boldsymbol{\\zeta}$ 并计算 $\\mathbf{F}(\\boldsymbol{\\zeta}) = (\\boldsymbol{-D_y P \\zeta}) \\circ (\\boldsymbol{D_x \\zeta}) + (\\boldsymbol{D_x P \\zeta}) \\circ (\\boldsymbol{D_y \\zeta})$。这涉及到将预先计算的算子矩阵应用于 $\\boldsymbol{\\zeta}$ 并执行逐元素的向量积。\n\n5.  **解析雅可比矩阵 ($J_{\\mathbf{F}}^{(\\text{ana})}$)**：根据问题中提供的公式构建矩阵。这需要依赖于状态的向量 $\\boldsymbol{u}, \\boldsymbol{v}, \\boldsymbol{\\zeta}_x, \\boldsymbol{\\zeta}_y$，这些向量在给定状态 $\\boldsymbol{\\zeta}_k$ 下计算。然后将这些向量形成为对角矩阵，并与适当的算子矩阵（$D_x, D_y, P_{\\text{mat}}$ 及其乘积）相乘。\n\n6.  **数值雅可比矩阵 ($J_{\\mathbf{F}}^{(\\text{num})}$)**：使用中心有限差分公式逐列计算。对于每一列 $i$，在两个扰动状态 $\\boldsymbol{\\zeta}_k \\pm \\varepsilon \\mathbf{e}_i$ 下评估函数 $\\mathbf{F}$，并对差值进行缩放。这是数值微分定义的直接实现。\n\n7.  **比较**：最后，为解析和数值雅可比矩阵形成状态转移矩阵 $A_k = I + \\Delta t J_{\\mathbf{F}}$。计算它们差值的弗罗贝尼乌斯范数 $\\|A_k^{(\\text{num})} - A_k^{(\\text{ana})}\\|_F$，它量化了差异。对于 $\\boldsymbol{\\zeta}_k = \\mathbf{0}$ 的情况，函数 $\\mathbf{F}$ 是一个齐次二次多项式，导致 $J_{\\mathbf{F}}(\\mathbf{0}) = \\mathbf{0}$。二次函数在零点的数值有限差分也为零，因此我们预期差值的范数精确为零。对于非零状态，范数应该很小，与数值微分的截断误差一致，该误差为 $O(\\varepsilon^2)$ 阶。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    主求解函数，遍历测试用例并打印结果。\n    \"\"\"\n\n    def compute_norm_diff(nx, ny, Lx, Ly, dt, zeta_k, eps):\n        \"\"\"\n        为给定的测试用例计算数值和解析状态转移雅可比矩阵之差的弗罗贝尼乌斯范数。\n        \"\"\"\n        N = nx * ny\n        dx = Lx / nx\n        dy = Ly / ny\n\n        # 1. 构建离散有限差分算子 Dx 和 Dy\n        Dx = np.zeros((N, N))\n        Dy = np.zeros((N, N))\n        for i in range(ny):\n            for j in range(nx):\n                k = i * nx + j\n                # Dx (周期性)\n                k_xp1 = i * nx + (j + 1) % nx\n                k_xm1 = i * nx + (j - 1 + nx) % nx\n                Dx[k, k_xp1] = 1.0 / (2.0 * dx)\n                Dx[k, k_xm1] = -1.0 / (2.0 * dx)\n                # Dy (周期性)\n                k_yp1 = ((i + 1) % ny) * nx + j\n                k_ym1 = ((i - 1 + ny) % ny) * nx + j\n                Dy[k, k_yp1] = 1.0 / (2.0 * dy)\n                Dy[k, k_ym1] = -1.0 / (2.0 * dy)\n\n        # 2. 将谱逆拉普拉斯算子 P 定义为一个函数\n        kx_vec = 2.0 * np.pi * np.fft.fftfreq(nx, d=dx)\n        ky_vec = 2.0 * np.pi * np.fft.fftfreq(ny, d=dy)\n        kx_grid, ky_grid = np.meshgrid(kx_vec, ky_vec, indexing='xy')\n        ksq = kx_grid**2 + ky_grid**2\n        \n        def P_op(zeta_flat):\n            zeta_2d = zeta_flat.reshape(ny, nx)\n            zeta_hat = np.fft.fft2(zeta_2d)\n            psi_hat = np.zeros_like(zeta_hat, dtype=complex)\n            \n            nonzero_idx = ksq != 0\n            # 广播除法\n            psi_hat[nonzero_idx] = -zeta_hat[nonzero_idx] / ksq[nonzero_idx]\n\n            psi_2d = np.real(np.fft.ifft2(psi_hat))\n            return psi_2d.flatten()\n\n        # 3. 构建 P 的矩阵形式\n        P_mat = np.zeros((N, N))\n        I_N = np.identity(N)\n        for j in range(N):\n            P_mat[:, j] = P_op(I_N[:, j])\n            \n        # 4. 定义非线性动力学函数 F\n        def F_func(zeta_flat):\n            psi_flat = P_op(zeta_flat)\n            u_flat = -Dy @ psi_flat\n            v_flat = Dx @ psi_flat\n            zetax_flat = Dx @ zeta_flat\n            zetay_flat = Dy @ zeta_flat\n            return u_flat * zetax_flat + v_flat * zetay_flat\n\n        # 5. 计算解析雅可比矩阵 J_ana\n        psi_k = P_op(zeta_k)\n        u_k = -Dy @ psi_k\n        v_k = Dx @ psi_k\n        zetax_k = Dx @ zeta_k\n        zetay_k = Dy @ zeta_k\n\n        term1 = np.diag(zetax_k) @ (-Dy @ P_mat)\n        term2 = np.diag(u_k) @ Dx\n        term3 = np.diag(zetay_k) @ (Dx @ P_mat)\n        term4 = np.diag(v_k) @ Dy\n        J_ana = term1 + term2 + term3 + term4\n\n        # 6. 计算数值雅可比矩阵 J_num\n        J_num = np.zeros((N, N))\n        for j in range(N):\n            ej = I_N[:, j]\n            zeta_plus = zeta_k + eps * ej\n            zeta_minus = zeta_k - eps * ej\n            F_plus = F_func(zeta_plus)\n            F_minus = F_func(zeta_minus)\n            J_num[:, j] = (F_plus - F_minus) / (2.0 * eps)\n            \n        # 7. 计算状态转移矩阵及其差的范数\n        A_ana = I_N + dt * J_ana\n        A_num = I_N + dt * J_num\n        norm_diff = np.linalg.norm(A_num - A_ana, 'fro')\n        \n        return norm_diff\n\n    # 定义测试用例\n    test_cases_params = [\n        {'nx': 4, 'ny': 4, 'Lx': 2*np.pi, 'Ly': 2*np.pi, 'dt': 0.01, 'eps': 1e-6, 'case_id': 1},\n        {'nx': 4, 'ny': 4, 'Lx': 2*np.pi, 'Ly': 2*np.pi, 'dt': 0.01, 'eps': 1e-5, 'case_id': 2},\n        {'nx': 5, 'ny': 5, 'Lx': 2*np.pi, 'Ly': 2*np.pi, 'dt': 0.05, 'eps': 1e-6, 'case_id': 3},\n    ]\n\n    results = []\n    for params in test_cases_params:\n        nx, ny = params['nx'], params['ny']\n        Lx, Ly = params['Lx'], params['Ly']\n        dx, dy = Lx / nx, Ly / ny\n\n        if params['case_id'] == 1:\n            zeta_2d = np.zeros((ny, nx))\n        elif params['case_id'] == 2:\n            rng = np.random.default_rng(seed=0)\n            zeta_2d = rng.random((ny, nx))\n            zeta_2d -= np.mean(zeta_2d)\n            max_abs = np.max(np.abs(zeta_2d))\n            if max_abs > 0:\n                zeta_2d = 0.1 * zeta_2d / max_abs\n        elif params['case_id'] == 3:\n            kx, ky = 1.0, 2.0\n            x_coords = np.arange(nx) * dx\n            y_coords = np.arange(ny) * dy\n            yy_grid, xx_grid = np.meshgrid(y_coords, x_coords, indexing='ij')\n            zeta_2d = np.sin(kx * xx_grid) * np.sin(ky * yy_grid)\n        \n        zeta_k = zeta_2d.flatten()\n        \n        norm_val = compute_norm_diff(params['nx'], params['ny'], params['Lx'], params['Ly'], \n                                     params['dt'], zeta_k, params['eps'])\n        results.append(norm_val)\n\n    # 格式化并打印最终结果\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "这最后一个练习在一个综合性的实现任务中，汇集了扩展卡尔曼滤波器的所有核心组件。你将为 Lorenz-96 模型（一个用于测试天气预报和资料同化方法的经典混沌系统）构建并运行一个完整的 EKF 资料同化循环。该练习涉及实现非线性模型、为模型和观测算子数值计算雅可比矩阵，并应用完整的预报和分析更新方程，以生成后验状态和误差协方差估计。",
            "id": "4057058",
            "problem": "考虑一个针对 Lorenz–$96$ (L$96$) 模型的离散时间数据同化问题，使用扩展卡尔曼滤波器 (EKF)。Lorenz–$96$ 模型有一个状态向量 $\\mathbf{x} \\in \\mathbb{R}^{K}$，其分量为 $x_{i}$（$i \\in \\{0,\\dots,K-1\\}$），满足循环索引规则 $x_{i+K} = x_{i}$。其连续时间动力学由以下常微分方程定义：\n$$\n\\frac{dx_{i}}{dt} = \\left(x_{i+1} - x_{i-2}\\right) x_{i-1} - x_{i} + F,\n$$\n其中 $F$ 是一个常数强迫，$K$ 是系统维度。假设时间离散的预报模型是通过使用四阶 Runge–Kutta 方法对该常微分方程进行单步长 $dt$ 的数值积分得到的，从而定义一个离散映射 $\\mathbf{M} : \\mathbb{R}^{K} \\to \\mathbb{R}^{K}$，使得 $\\mathbf{x}_{k+1} = \\mathbf{M}(\\mathbf{x}_{k})$。观测值是通过一个非线性观测算子 $\\mathbf{h} : \\mathbb{R}^{K} \\to \\mathbb{R}^{m}$ 获得的，该算子将状态向量映射到给定观测分量索引集的观测空间中。假设存在协方差分别为 $\\mathbf{Q}$ 和 $\\mathbf{R}$ 的加性高斯过程噪声和观测噪声。\n\n您必须在单个同化时间点上实现一次扩展卡尔曼滤波器分析，从先验（背景）均值 $\\mathbf{x}_{b}$ 和协方差 $\\mathbf{P}_{b}$ 开始，通过 $\\mathbf{M}$ 执行单个预报步骤以获得预报均值 $\\mathbf{x}_{f}$，然后同化一个给定的观测向量 $\\mathbf{y}$ 以生成分析均值 $\\mathbf{x}_{a}$ 和分析协方差 $\\mathbf{P}_{a}$。在 EKF 中，线性化必须通过使用中心有限差分的数值雅可比矩阵来计算。具体来说：\n- 状态转移雅可比矩阵 $\\mathbf{F} = \\left.\\frac{\\partial \\mathbf{M}}{\\partial \\mathbf{x}}\\right|_{\\mathbf{x}_{b}}$ 必须通过以一个微小量 $\\varepsilon$ 扰动 $\\mathbf{x}_{b}$ 的每个分量并使用中心差分格式进行数值近似。\n- 同样，观测雅可比矩阵 $\\mathbf{H} = \\left.\\frac{\\partial \\mathbf{h}}{\\partial \\mathbf{x}}\\right|_{\\mathbf{x}_{f}}$ 也必须通过中心有限差分进行数值近似。\n\n在此问题中，您必须：\n1. 实现 Lorenz–$96$ 的右端项和一个四阶 Runge–Kutta 单步积分器来定义 $\\mathbf{M}$。\n2. 使用中心有限差分和微小扰动量 $\\varepsilon$ 为 $\\mathbf{M}$ 和 $\\mathbf{h}$ 实现数值雅可比矩阵。\n3. 使用线性化动力学将先验协方差在预报步骤中进行传播，以获得预报协方差。\n4. 使用数值计算的观测雅可比矩阵和 Joseph 稳定化的协方差更新来执行 EKF 分析更新。\n5. 通过计算三个标量诊断量来评估后验误差协方差：$\\mathbf{P}_{a}$ 的迹、$\\mathbf{P}_{a}$ 的最大特征值以及 $\\mathbf{P}_{a}$ 的弗罗贝尼乌斯范数。\n\n您的推导和实现应基于以下基本原则：\n- Lorenz–$96$ 动力系统定义和数值时间积分，作为对连续时间动力学的经过充分测试的近似，\n- 非线性映射线性化下的高斯不确定性传播，\n- 用于结合先验信息与似然的 Bayes 法则，及其高斯特例化所导出的卡尔曼类型更新。\n\n使用以下参数值测试套件。索引从 $0$ 开始计数。\n\n测试用例 1 (正常路径，部分非线性正弦观测，中等噪声)：\n- 维度 $K = 5$，强迫 $F = 8$，时间步长 $dt = 0.05$，\n- 先验均值 $\\mathbf{x}_{b} = [\\,1.5,\\,1.2,\\,1.3,\\,1.4,\\,1.6\\,]$，\n- 先验协方差 $\\mathbf{P}_{b} = \\operatorname{diag}([\\,0.25,\\,0.25,\\,0.25,\\,0.25,\\,0.25\\,])$，\n- 过程噪声协方差 $\\mathbf{Q} = \\operatorname{diag}([\\,0.01,\\,0.01,\\,0.01,\\,0.01,\\,0.01\\,])$，\n- 观测算子 $\\mathbf{h}$ 定义在观测索引 $[\\,0,\\,2,\\,4\\,]$ 上，为对这些分量逐元素应用 $\\sin(\\cdot)$，因此 $m = 3$，\n- 观测噪声协方差 $\\mathbf{R} = \\operatorname{diag}([\\,0.0025,\\,0.0025,\\,0.0025\\,])$，\n- 真实状态 $\\mathbf{x}_{\\text{true}} = [\\,1.6,\\,1.4,\\,1.5,\\,1.7,\\,1.8\\,]$，以及观测值 $\\mathbf{y} = \\mathbf{h}(\\mathbf{x}_{\\text{true}})$。\n\n测试用例 2 (边界情况，所有分量上的二次方观测，零观测噪声，零过程噪声)：\n- 维度 $K = 5$，强迫 $F = 8$，时间步长 $dt = 0.05$，\n- 先验均值 $\\mathbf{x}_{b} = [\\,1.0,\\,0.0,\\,0.5,\\,-0.5,\\,1.0\\,]$，\n- 先验协方差 $\\mathbf{P}_{b} = \\operatorname{diag}([\\,0.01,\\,0.01,\\,0.01,\\,0.01,\\,0.01\\,])$，\n- 过程噪声协方差 $\\mathbf{Q} = \\operatorname{diag}([\\,0,\\,0,\\,0,\\,0,\\,0\\,])$，\n- 观测算子 $\\mathbf{h}$ 定义在观测索引 $[\\,0,\\,1,\\,2,\\,3,\\,4\\,]$ 上，为对这些分量逐元素应用 $(\\cdot)^{2}$，因此 $m = 5$，\n- 观测噪声协方差 $\\mathbf{R} = \\operatorname{diag}([\\,0,\\,0,\\,0,\\,0,\\,0\\,])$，\n- 真实状态 $\\mathbf{x}_{\\text{true}} = [\\,1.0,\\,0.5,\\,-0.2,\\,0.8,\\,-1.1\\,]$，以及观测值 $\\mathbf{y} = \\mathbf{h}(\\mathbf{x}_{\\text{true}})$。\n\n测试用例 3 (边缘情况，更高维度，稀疏单分量正弦观测，相对较大的观测噪声，各向异性先验协方差)：\n- 维度 $K = 7$，强迫 $F = 8$，时间步长 $dt = 0.05$，\n- 先验均值 $\\mathbf{x}_{b} = [\\,0.5,\\,-0.3,\\,1.0,\\,0.2,\\,-0.7,\\,0.8,\\,1.2\\,]$，\n- 先验协方差 $\\mathbf{P}_{b} = \\operatorname{diag}([\\,0.04,\\,0.09,\\,0.16,\\,0.01,\\,0.25,\\,0.09,\\,0.04\\,])$，\n- 过程噪声协方差 $\\mathbf{Q} = \\operatorname{diag}([\\,0.02,\\,0.02,\\,0.02,\\,0.02,\\,0.02,\\,0.02,\\,0.02\\,])$，\n- 观测算子 $\\mathbf{h}$ 定义在观测索引 $[\\,3\\,]$ 上，为对该单分量逐元素应用 $\\sin(\\cdot)$，因此 $m = 1$，\n- 观测噪声协方差 $\\mathbf{R} = \\operatorname{diag}([\\,0.25\\,])$，\n- 真实状态 $\\mathbf{x}_{\\text{true}} = [\\,0.7,\\,-0.1,\\,0.9,\\,0.3,\\,-0.5,\\,1.1,\\,1.4\\,]$，以及观测值 $\\mathbf{y} = \\mathbf{h}(\\mathbf{x}_{\\text{true}})$。\n\n您的程序必须：\n- 对所有数值雅可比矩阵使用中心有限差分步长 $\\varepsilon = 10^{-6}$，\n- 使用 Joseph 稳定化的协方差更新来计算 $\\mathbf{P}_{a}$，\n- 在计算诊断量之前，将最终的 $\\mathbf{P}_{a}$ 对称化为 $\\tfrac{1}{2}\\left(\\mathbf{P}_{a} + \\mathbf{P}_{a}^{\\top}\\right)$。\n\n所需的最终输出格式是单行列表，其中包含每个测试用例的三个浮点数的列表，按 $[\\,\\operatorname{tr}(\\mathbf{P}_{a}),\\,\\lambda_{\\max}(\\mathbf{P}_{a}),\\,\\|\\mathbf{P}_{a}\\|_{F}\\,]$ 的顺序排列，并汇总所有测试用例，其确切字符串形式为\n$$\n[\\,[\\text{t}_{1},\\text{l}_{1},\\text{n}_{1}],\\,[\\text{t}_{2},\\text{l}_{2},\\text{n}_{2}],\\,[\\text{t}_{3},\\text{l}_{3},\\text{n}_{3}]\\,],\n$$\n无任何附加文本。所有量均为无单位实数。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果 (例如，$[\\,\\text{result}_{1},\\text{result}_{2},\\text{result}_{3}\\,]$)。",
            "solution": "该问题要求为 Lorenz–$96$ 动力系统实现单个扩展卡尔曼滤波器 (EKF) 的预报-分析循环。对问题陈述的验证表明，它是科学可靠、适定的、客观的，并包含继续进行所需的所有必要信息。该问题是数据同化技术在著名混沌模型上的标准应用。我们现在将通过构建 EKF 算法的必要组件来推导解决方案。\n\nEKF 是卡尔曼滤波器针对非线性系统的改编，其操作分为两步：一个预报步骤，用于将状态及其不确定性随时间向前传播；以及一个分析步骤，用于利用新观测值更新预报状态。\n\n### 1. 预报步骤\n\n预报步骤将先验（或背景）状态估计 $\\mathbf{x}_{b} \\in \\mathbb{R}^{K}$ 及其相关的误差协方差矩阵 $\\mathbf{P}_{b} \\in \\mathbb{R}^{K \\times K}$ 推进到下一次观测的时刻。\n\n**状态预报：**\n先验均值状态 $\\mathbf{x}_{b}$ 通过非线性预报模型 $\\mathbf{M}$ 进行传播，以获得预报均值状态 $\\mathbf{x}_{f}$：\n$$\n\\mathbf{x}_{f} = \\mathbf{M}(\\mathbf{x}_{b})\n$$\n模型 $\\mathbf{M}$ 被定义为使用四阶 Runge–Kutta (RK4) 方法积分 Lorenz–$96$ 常微分方程的单个时间步长 $dt$：\n$$\n\\frac{dx_{i}}{dt} = f_i(\\mathbf{x}) = (x_{i+1} - x_{i-2}) x_{i-1} - x_{i} + F\n$$\n其中 $i=0, \\dots, K-1$，具有循环边界条件 (例如，$x_{-1} = x_{K-1}$，$x_{-2} = x_{K-2}$)。对于一个通用系统 $\\frac{d\\mathbf{x}}{dt} = f(\\mathbf{x})$ 的 RK4 格式为：\n$$\n\\begin{align*}\n\\mathbf{k}_{1} = f(\\mathbf{x}(t)) \\\\\n\\mathbf{k}_{2} = f(\\mathbf{x}(t) + \\frac{dt}{2}\\mathbf{k}_{1}) \\\\\n\\mathbf{k}_{3} = f(\\mathbf{x}(t) + \\frac{dt}{2}\\mathbf{k}_{2}) \\\\\n\\mathbf{k}_{4} = f(\\mathbf{x}(t) + dt\\mathbf{k}_{3}) \\\\\n\\mathbf{x}(t+dt) = \\mathbf{x}(t) + \\frac{dt}{6}(\\mathbf{k}_{1} + 2\\mathbf{k}_{2} + 2\\mathbf{k}_{3} + \\mathbf{k}_{4})\n\\end{align*}\n$$\n将此应用于状态 $\\mathbf{x}_b$ 的 Lorenz–$96$ 动力学，可得到 $\\mathbf{x}_f$。\n\n**协方差预报：**\n先验协方差 $\\mathbf{P}_{b}$ 通过将模型动力学在先验均值 $\\mathbf{x}_{b}$ 附近线性化来进行传播。预报协方差 $\\mathbf{P}_{f}$ 由下式给出：\n$$\n\\mathbf{P}_{f} = \\mathbf{F} \\mathbf{P}_{b} \\mathbf{F}^{\\top} + \\mathbf{Q}\n$$\n其中 $\\mathbf{Q}$ 是过程噪声协方差，$\\mathbf{F}$ 是切线性模型，即 $\\mathbf{M}$ 在 $\\mathbf{x}_{b}$ 处求值的雅可比矩阵：\n$$\n\\mathbf{F} = \\left.\\frac{\\partial \\mathbf{M}}{\\partial \\mathbf{x}}\\right|_{\\mathbf{x}_{b}}\n$$\n该雅可比矩阵使用中心有限差分格式进行数值计算。对于 $\\mathbf{F}$ 的每一列 $j$，我们扰动 $\\mathbf{x}_{b}$ 的第 $j$ 个分量：\n$$\n\\mathbf{F}_{:, j} = \\frac{\\mathbf{M}(\\mathbf{x}_{b} + \\varepsilon \\mathbf{e}_{j}) - \\mathbf{M}(\\mathbf{x}_{b} - \\varepsilon \\mathbf{e}_{j})}{2\\varepsilon}\n$$\n其中 $\\mathbf{e}_{j}$ 是第 $j$ 个标准基向量，$\\varepsilon$ 是一个小的扰动量，给定为 $\\varepsilon = 10^{-6}$。\n\n### 2. 分析步骤\n\n分析步骤将预报状态 $\\mathbf{x}_{f}$ 及其协方差 $\\mathbf{P}_{f}$ 与一个观测向量 $\\mathbf{y} \\in \\mathbb{R}^{m}$ 相结合，以生成一个改进的分析（后验）状态 $\\mathbf{x}_{a}$ 和协方差 $\\mathbf{P}_{a}$。\n\n**新息：**\n新息或观测残差 $\\mathbf{d}$ 是实际观测值 $\\mathbf{y}$ 与从预报状态预测的观测值之间的差异：\n$$\n\\mathbf{d} = \\mathbf{y} - \\mathbf{h}(\\mathbf{x}_{f})\n$$\n其中 $\\mathbf{h}: \\mathbb{R}^{K} \\to \\mathbb{R}^{m}$ 是（可能非线性的）观测算子。观测值由 $\\mathbf{y} = \\mathbf{h}(\\mathbf{x}_{\\text{true}})$ 给出。\n\n**观测雅可比矩阵：**\n更新需要观测算子的线性化，即 $\\mathbf{H}$，它是其在预报状态 $\\mathbf{x}_{f}$ 处求值的雅可比矩阵：\n$$\n\\mathbf{H} = \\left.\\frac{\\partial \\mathbf{h}}{\\partial \\mathbf{x}}\\right|_{\\mathbf{x}_{f}}\n$$\n与 $\\mathbf{F}$ 一样，这个 $m \\times K$ 的矩阵也使用中心有限差分进行数值计算：\n$$\n\\mathbf{H}_{:, j} = \\frac{\\mathbf{h}(\\mathbf{x}_{f} + \\varepsilon \\mathbf{e}_{j}) - \\mathbf{h}(\\mathbf{x}_{f} - \\varepsilon \\mathbf{e}_{j})}{2\\varepsilon}\n$$\n\n**卡尔曼增益和状态/协方差更新：**\n分析是预报和观测的加权平均，其权重由它们各自的不确定性决定。新息协方差为：\n$$\n\\mathbf{S} = \\mathbf{H} \\mathbf{P}_{f} \\mathbf{H}^{\\top} + \\mathbf{R}\n$$\n其中 $\\mathbf{R}$ 是观测误差协方差。决定给予新息权重的卡尔曼增益 $\\mathbf{K}$ 为：\n$$\n\\mathbf{K} = \\mathbf{P}_{f} \\mathbf{H}^{\\top} \\mathbf{S}^{-1}\n$$\n在数值上，通过求解线性系统 $\\mathbf{S}\\mathbf{K}^{\\top} = \\mathbf{H}\\mathbf{P}_{f}$ 得到 $\\mathbf{K}^{\\top}$，然后转置结果来计算 $\\mathbf{K}$ 更为稳定。\n\n分析均值状态 $\\mathbf{x}_{a}$ 和协方差 $\\mathbf{P}_{a}$ 随后被更新：\n$$\n\\mathbf{x}_{a} = \\mathbf{x}_{f} + \\mathbf{K} \\mathbf{d}\n$$\n对于协方差更新，我们使用 Joseph 稳定形式，这种形式在数值上更鲁棒，并且即使存在浮点误差也能保证生成一个对称半正定矩阵：\n$$\n\\mathbf{P}_{a} = (\\mathbf{I} - \\mathbf{K}\\mathbf{H}) \\mathbf{P}_{f} (\\mathbf{I} - \\mathbf{K}\\mathbf{H})^{\\top} + \\mathbf{K}\\mathbf{R}\\mathbf{K}^{\\top}\n$$\n其中 $\\mathbf{I}$ 是单位矩阵。\n\n### 3. 最终诊断\n\n计算出分析协方差 $\\mathbf{P}_{a}$ 后，首先将其显式对称化以消除任何数值不对称性：\n$$\n\\mathbf{P}_{a} \\leftarrow \\frac{1}{2}(\\mathbf{P}_{a} + \\mathbf{P}_{a}^{\\top})\n$$\n最后，计算三个标量诊断量来总结后验误差协方差：\n1.  **迹：** $\\operatorname{tr}(\\mathbf{P}_{a}) = \\sum_{i} (\\mathbf{P}_{a})_{ii}$。这表示后验误差方差的总和。\n2.  **最大特征值：** $\\lambda_{\\max}(\\mathbf{P}_{a})$。这衡量了误差分布最大主成分的大小。\n3.  **弗罗贝尼乌斯范数：** $\\|\\mathbf{P}_{a}\\|_{F} = \\sqrt{\\sum_{i,j} |(\\mathbf{P}_{a})_{ij}|^2}$。这提供了协方差矩阵大小的整体度量。\n\n实现将针对所提供的三个测试用例分别遵循这些步骤。",
            "answer": "```python\nimport numpy as np\nimport scipy.linalg\n\ndef solve():\n    \"\"\"\n    Implements and runs the Extended Kalman Filter for the Lorenz-96 model\n    for three specified test cases.\n    \"\"\"\n\n    test_cases = [\n        # Test case 1\n        {\n            \"K\": 5, \"F\": 8.0, \"dt\": 0.05,\n            \"xb\": np.array([1.5, 1.2, 1.3, 1.4, 1.6]),\n            \"Pb\": np.diag([0.25, 0.25, 0.25, 0.25, 0.25]),\n            \"Q\": np.diag([0.01, 0.01, 0.01, 0.01, 0.01]),\n            \"obs_indices\": np.array([0, 2, 4]),\n            \"obs_op\": np.sin,\n            \"R\": np.diag([0.0025, 0.0025, 0.0025]),\n            \"xtrue\": np.array([1.6, 1.4, 1.5, 1.7, 1.8]),\n        },\n        # Test case 2\n        {\n            \"K\": 5, \"F\": 8.0, \"dt\": 0.05,\n            \"xb\": np.array([1.0, 0.0, 0.5, -0.5, 1.0]),\n            \"Pb\": np.diag([0.01, 0.01, 0.01, 0.01, 0.01]),\n            \"Q\": np.diag([0.0, 0.0, 0.0, 0.0, 0.0]),\n            \"obs_indices\": np.array([0, 1, 2, 3, 4]),\n            \"obs_op\": lambda x: x**2,\n            \"R\": np.diag([0.0, 0.0, 0.0, 0.0, 0.0]),\n            \"xtrue\": np.array([1.0, 0.5, -0.2, 0.8, -1.1]),\n        },\n        # Test case 3\n        {\n            \"K\": 7, \"F\": 8.0, \"dt\": 0.05,\n            \"xb\": np.array([0.5, -0.3, 1.0, 0.2, -0.7, 0.8, 1.2]),\n            \"Pb\": np.diag([0.04, 0.09, 0.16, 0.01, 0.25, 0.09, 0.04]),\n            \"Q\": np.diag([0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02]),\n            \"obs_indices\": np.array([3]),\n            \"obs_op\": np.sin,\n            \"R\": np.diag([0.25]),\n            \"xtrue\": np.array([0.7, -0.1, 0.9, 0.3, -0.5, 1.1, 1.4]),\n        },\n    ]\n\n    epsilon = 1e-6\n    results = []\n\n    def lorenz96_rhs(x, F):\n        \"\"\"Lorenz-96 RHS with cyclic boundary conditions.\"\"\"\n        K = x.shape[0]\n        dxdt = np.zeros(K)\n        # Using np.roll for efficient cyclic indexing\n        x_p1 = np.roll(x, -1)\n        x_m1 = np.roll(x, 1)\n        x_m2 = np.roll(x, 2)\n        dxdt = (x_p1 - x_m2) * x_m1 - x + F\n        return dxdt\n\n    def rk4_step(x, func_rhs, dt, F):\n        \"\"\"Fourth-order Runge-Kutta integrator for one step.\"\"\"\n        k1 = func_rhs(x, F)\n        k2 = func_rhs(x + 0.5 * dt * k1, F)\n        k3 = func_rhs(x + 0.5 * dt * k2, F)\n        k4 = func_rhs(x + dt * k3, F)\n        return x + (dt / 6.0) * (k1 + 2.0 * k2 + 2.0 * k3 + k4)\n\n    def compute_jacobian(func, x, epsilon):\n        \"\"\"Computes Jacobian of func at x using central finite differences.\"\"\"\n        K = x.shape[0]\n        y_ref = func(x)\n        m = y_ref.shape[0]\n        J = np.zeros((m, K))\n        x_pert = np.copy(x)\n        for j in range(K):\n            # Perturb x_pert in place, which is slightly more efficient\n            original_val = x_pert[j]\n            x_pert[j] = original_val + epsilon\n            y_plus = func(x_pert)\n            x_pert[j] = original_val - epsilon\n            y_minus = func(x_pert)\n            J[:, j] = (y_plus - y_minus) / (2.0 * epsilon)\n            # Restore original value\n            x_pert[j] = original_val\n        return J\n\n    for case in test_cases:\n        K = case[\"K\"]\n        F = case[\"F\"]\n        dt = case[\"dt\"]\n        xb = case[\"xb\"]\n        Pb = case[\"Pb\"]\n        Q = case[\"Q\"]\n        obs_indices = case[\"obs_indices\"]\n        obs_op = case[\"obs_op\"]\n        R = case[\"R\"]\n        xtrue = case[\"xtrue\"]\n        \n        # Define the specific forecast model M and observation operator h\n        M = lambda x: rk4_step(x, lorenz96_rhs, dt, F)\n        h = lambda x: obs_op(x[obs_indices])\n        \n        # Generate observation y\n        y = h(xtrue)\n        \n        # --- FORECAST STEP ---\n        # State forecast\n        xf = M(xb)\n        \n        # Covariance forecast\n        F_jac = compute_jacobian(M, xb, epsilon)\n        Pf = F_jac @ Pb @ F_jac.T + Q\n        \n        # --- ANALYSIS STEP ---\n        # Innovation\n        d = y - h(xf)\n        \n        # Observation Jacobian\n        H_jac = compute_jacobian(h, xf, epsilon)\n        \n        # Innovation covariance\n        S = H_jac @ Pf @ H_jac.T + R\n        \n        # Kalman Gain (using numerically stable linear solve)\n        # Solve S K.T = H Pf\n        KT = scipy.linalg.solve(S, H_jac @ Pf, assume_a='sym')\n        K_gain = KT.T\n        \n        # State analysis\n        # xa = xf + K_gain @ d  # Not required for the final output\n\n        # Covariance analysis (Joseph form)\n        I = np.identity(K)\n        term1 = I - K_gain @ H_jac\n        Pa = term1 @ Pf @ term1.T + K_gain @ R @ K_gain.T\n        \n        # --- POST-PROCESSING  DIAGNOSTICS ---\n        # Symmetrize Pa to correct for numerical inaccuracies\n        Pa_sym = 0.5 * (Pa + Pa.T)\n        \n        # Calculate diagnostics\n        tr_Pa = np.trace(Pa_sym)\n        # Use eigvalsh for symmetric matrices\n        eigvals = np.linalg.eigvalsh(Pa_sym)\n        lmax_Pa = np.max(eigvals)\n        fnorm_Pa = np.linalg.norm(Pa_sym, 'fro')\n        \n        results.append([tr_Pa, lmax_Pa, fnorm_Pa])\n\n    # Format the final output string exactly as specified.\n    # str(results) produces spaces, which need to be removed.\n    output_str = str(results).replace(\" \", \"\")\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}