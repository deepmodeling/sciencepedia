{
    "hands_on_practices": [
        {
            "introduction": "在将复杂的物理和动力过程耦合到数值模型中时，算子分裂是一种基本策略，它允许我们分别处理不同的过程。然而，这种便利性并非没有代价，它会引入一种被称为分裂误差的近似误差。本练习的核心是探究分裂误差的来源：非交换算子，并通过李换向子 $[A,B] = AB - BA$ 来量化它。通过为动力学（算子 $A$）和物理（算子 $B$）的相互作用建立一个具体的数值估计，您将深入了解为什么高阶分裂方案（如斯特朗分裂）在算子显著非交换的情况下至关重要 。",
            "id": "4074816",
            "problem": "在用于数值天气预报 (NWP) 的大气模型的一列中，预报状态已使用标准参考尺度进行了无量纲化，因此欧几里得范数是量级的适当度量。时间演化由分裂系统 $\\frac{d x}{d t} = A x + B x$ 建模，其中 $A$ 代表解析动力学算子，$B$ 代表次网格物理算子。考虑一个时间步，在此时间步内，假定 $A$ 和 $B$ 围绕当前状态 $x$ 是冻结和线性化的。给定当前状态下以下数值计算的算子作用：\n- 当前状态：$x = \\begin{pmatrix} 0.8 \\\\ -0.3 \\\\ 1.2 \\\\ 0.05 \\end{pmatrix}$。\n- 单次应用：$A x = \\begin{pmatrix} 0.12 \\\\ -0.08 \\\\ 0.35 \\\\ -0.01 \\end{pmatrix}$ 和 $B x = \\begin{pmatrix} 0.03 \\\\ 0.02 \\\\ -0.06 \\\\ 0.004 \\end{pmatrix}$。\n- 嵌套应用：$A(B x) = \\begin{pmatrix} 0.014 \\\\ -0.006 \\\\ 0.020 \\\\ -0.001 \\end{pmatrix}$ 和 $B(A x) = \\begin{pmatrix} 0.008 \\\\ -0.005 \\\\ 0.015 \\\\ -0.0005 \\end{pmatrix}$。\n\n使用 Baker–Campbell–Hausdorff 展开至所需的最小阶数，首先导出一阶 Lie–Trotter 方法的局部分裂误差的主阶表达式，用作用于 $x$ 的李换位子 $[A,B]$ 和无量纲时间步长 $\\Delta \\hat{t}$ 表示。然后，使用给定的算子作用，构造作用于状态的换位子 $[A,B]x$ 的有限差分近似。定义一个无量纲局部误差比\n$$\nR \\equiv \\frac{1}{\\|x\\|_2}\\,\\frac{\\Delta \\hat{t}^{2}}{2}\\,\\bigl\\|[A,B]x\\bigr\\|_2,\n$$\n其中 $\\|\\cdot\\|_2$ 是欧几里得范数，无量纲时间步长为 $\\Delta \\hat{t} \\equiv \\Delta t / T_{\\mathrm{ref}}$，参考时间 $T_{\\mathrm{ref}} = 3600\\,\\mathrm{s}$。取物理时间步长为 $\\Delta t = 2400\\,\\mathrm{s}$。使用耦合容差 $\\tau = 1.0 \\times 10^{-3}$ (无量纲) 来判断一阶 Lie 分裂误差是否可接受；如果 $R > \\tau$，则对于此耦合，需要采用二阶 Strang 分裂。\n\n根据提供的数据计算 $R$，并根据容差判断是否需要采用 Strang 分裂。最终答案只报告 $R$ 的值，四舍五入到四位有效数字，并表示为无量纲数。最终答案框中不要包含单位或判断。",
            "solution": "首先根据指定标准对问题进行验证。\n\n### 步骤 1：提取已知条件\n-   控制方程为 $\\frac{d x}{d t} = A x + B x = (A+B)x$。\n-   当前状态：$x = \\begin{pmatrix} 0.8 \\\\ -0.3 \\\\ 1.2 \\\\ 0.05 \\end{pmatrix}$。\n-   算子作用 $A x$：$A x = \\begin{pmatrix} 0.12 \\\\ -0.08 \\\\ 0.35 \\\\ -0.01 \\end{pmatrix}$。\n-   算子作用 $B x$：$B x = \\begin{pmatrix} 0.03 \\\\ 0.02 \\\\ -0.06 \\\\ 0.004 \\end{pmatrix}$。\n-   嵌套算子作用 $A(B x)$：$A(B x) = \\begin{pmatrix} 0.014 \\\\ -0.006 \\\\ 0.020 \\\\ -0.001 \\end{pmatrix}$。\n-   嵌套算子作用 $B(A x)$：$B(A x) = \\begin{pmatrix} 0.008 \\\\ -0.005 \\\\ 0.015 \\\\ -0.0005 \\end{pmatrix}$。\n-   物理时间步长：$\\Delta t = 2400\\,\\mathrm{s}$。\n-   参考时间尺度：$T_{\\mathrm{ref}} = 3600\\,\\mathrm{s}$。\n-   无量纲时间步长：$\\Delta \\hat{t} \\equiv \\Delta t / T_{\\mathrm{ref}}$。\n-   无量纲局部误差比定义：$R \\equiv \\frac{1}{\\|x\\|_2}\\,\\frac{\\Delta \\hat{t}^{2}}{2}\\,\\bigl\\|[A,B]x\\bigr\\|_2$。\n-   耦合容差：$\\tau = 1.0 \\times 10^{-3}$。\n-   高阶分裂条件：如果 $R > \\tau$，则需要采用 Strang 分裂。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学基础**：该问题基于算子分裂（特别是 Lie-Trotter 分裂）的标准实践，这是一种求解微分方程组的数值方法，在数值天气预报和气候建模中是常用技术。Baker-Campbell-Hausdorff 展开和李换位子是分析分裂误差的正确理论工具。\n-   **适定性**：问题是完全指定的。计算量 $R$ 所需的所有数值数据和定义都已提供。目标清晰明确。\n-   **客观性**：问题以精确的数学和数值术语陈述，没有主观语言。\n\n### 步骤 3：结论与行动\n该问题有效。将提供完整解答。\n\n### 求解推导\n该问题要求计算一个无量纲比率 $R$，该比率量化了一阶 Lie-Trotter 分裂方案的局部误差。首先，我们推导主阶分裂误差。在一个时间步长 $\\Delta t$ 内，$\\frac{d x}{d t} = (A+B)x$ 的精确解为 $x(\\Delta t) = \\exp((A+B)\\Delta t)x_0$，其中 $x_0$ 是 $t=0$ 时的状态。\n\n一阶 Lie-Trotter 分裂将此演化近似为 $x_{LT}(\\Delta t) = \\exp(B\\Delta t)\\exp(A\\Delta t)x_0$。局部截断误差是一步之后精确解与近似解之间的差。为找到此误差的主阶项，我们对指数算子使用泰勒级数展开。\n\n精确解算子为：\n$$\n\\exp((A+B)\\Delta t) = I + (A+B)\\Delta t + \\frac{1}{2}(A+B)^2 \\Delta t^2 + O(\\Delta t^3)\n$$\n展开二次项：\n$$\n\\exp((A+B)\\Delta t) = I + A\\Delta t + B\\Delta t + \\frac{1}{2}(A^2 + AB + BA + B^2)\\Delta t^2 + O(\\Delta t^3)\n$$\nLie-Trotter 近似算子为：\n$$\n\\exp(B\\Delta t)\\exp(A\\Delta t) = \\left(I + B\\Delta t + \\frac{1}{2}B^2\\Delta t^2 + \\dots\\right)\\left(I + A\\Delta t + \\frac{1}{2}A^2\\Delta t^2 + \\dots\\right)\n$$\n展开并保留至 $\\Delta t^2$ 阶的项：\n$$\n\\exp(B\\Delta t)\\exp(A\\Delta t) = I + A\\Delta t + B\\Delta t + BA\\Delta t^2 + \\frac{1}{2}A^2\\Delta t^2 + \\frac{1}{2}B^2\\Delta t^2 + O(\\Delta t^3)\n$$\n局部误差算子 $L_{err}$ 是精确算子与近似算子之差：\n$$\nL_{err} = \\exp((A+B)\\Delta t) - \\exp(B\\Delta t)\\exp(A\\Delta t)\n$$\n$$\nL_{err} = \\left[\\frac{1}{2}(A^2 + AB + BA + B^2) - \\left(BA + \\frac{1}{2}A^2 + \\frac{1}{2}B^2\\right)\\right]\\Delta t^2 + O(\\Delta t^3)\n$$\n$$\nL_{err} = \\frac{1}{2}(AB - BA)\\Delta t^2 + O(\\Delta t^3) = \\frac{1}{2}[A,B]\\Delta t^2 + O(\\Delta t^3)\n$$\n其中 $[A,B] = AB - BA$ 是算子 $A$ 和 $B$ 的李换位子。\n因此，作用于状态 $x$ 的主阶局部分裂误差为 $\\frac{1}{2}[A,B]x\\,\\Delta t^2$。\n使用无量纲时间步长 $\\Delta \\hat{t} = \\Delta t / T_{\\mathrm{ref}}$，误差为 $\\frac{1}{2}[A,B]x\\,(T_{\\mathrm{ref}}\\Delta \\hat{t})^2$。由于问题中定义的 $R$ 不含 $T_{\\mathrm{ref}}$，它隐含地假设分析是在无量纲时间内完成的，因此误差表示为 $\\frac{1}{2}[A,B]x\\,\\Delta \\hat{t}^2$。量 $R$ 是该误差的范数，并按状态 $x$ 的范数进行缩放。\n\n下一步是计算 $R$ 的分量。\n\n1.  **计算 $[A,B]x$**：换位子对状态 $x$ 的作用由 $[A,B]x = A(Bx) - B(Ax)$ 给出。使用提供的数值：\n    $$\n    [A,B]x = \\begin{pmatrix} 0.014 \\\\ -0.006 \\\\ 0.020 \\\\ -0.001 \\end{pmatrix} - \\begin{pmatrix} 0.008 \\\\ -0.005 \\\\ 0.015 \\\\ -0.0005 \\end{pmatrix} = \\begin{pmatrix} 0.014 - 0.008 \\\\ -0.006 - (-0.005) \\\\ 0.020 - 0.015 \\\\ -0.001 - (-0.0005) \\end{pmatrix} = \\begin{pmatrix} 0.006 \\\\ -0.001 \\\\ 0.005 \\\\ -0.0005 \\end{pmatrix}\n    $$\n2.  **计算欧几里得范数**：我们需要 $\\|x\\|_2$ 和 $\\|[A,B]x\\|_2$。\n    $$\n    \\|x\\|_2 = \\sqrt{(0.8)^2 + (-0.3)^2 + (1.2)^2 + (0.05)^2} = \\sqrt{0.64 + 0.09 + 1.44 + 0.0025} = \\sqrt{2.1725}\n    $$\n    $$\n    \\|[A,B]x\\|_2 = \\sqrt{(0.006)^2 + (-0.001)^2 + (0.005)^2 + (-0.0005)^2}\n    $$\n    $$\n    \\|[A,B]x\\|_2 = \\sqrt{3.6 \\times 10^{-5} + 1.0 \\times 10^{-6} + 2.5 \\times 10^{-5} + 0.25 \\times 10^{-6}}\n    $$\n    $$\n    \\|[A,B]x\\|_2 = \\sqrt{(36 + 1 + 25 + 0.25) \\times 10^{-6}} = \\sqrt{62.25 \\times 10^{-6}}\n    $$\n3.  **计算无量纲时间步长 $\\Delta \\hat{t}$**：\n    $$\n    \\Delta \\hat{t} = \\frac{\\Delta t}{T_{\\mathrm{ref}}} = \\frac{2400\\,\\mathrm{s}}{3600\\,\\mathrm{s}} = \\frac{24}{36} = \\frac{2}{3}\n    $$\n4.  **计算比率 $R$**：将计算出的值代入 $R$ 的定义中。\n    $$\n    R = \\frac{1}{\\|x\\|_2}\\,\\frac{\\Delta \\hat{t}^{2}}{2}\\,\\bigl\\|[A,B]x\\bigr\\|_2 = \\frac{1}{\\sqrt{2.1725}} \\frac{(2/3)^2}{2} \\sqrt{62.25 \\times 10^{-6}}\n    $$\n    $$\n    R = \\frac{1}{\\sqrt{2.1725}} \\frac{4/9}{2} \\sqrt{62.25} \\times 10^{-3} = \\frac{1}{\\sqrt{2.1725}} \\frac{2}{9} \\sqrt{62.25} \\times 10^{-3}\n    $$\n    $$\n    R = \\frac{2 \\sqrt{62.25}}{9 \\sqrt{2.1725}} \\times 10^{-3} \\approx \\frac{2 \\times 7.889867}{9 \\times 1.473940} \\times 10^{-3}\n    $$\n    $$\n    R \\approx \\frac{15.779734}{13.26546} \\times 10^{-3} \\approx 1.189532 \\times 10^{-3}\n    $$\n将结果四舍五入到四位有效数字，得到 $R \\approx 1.190 \\times 10^{-3}$。\n\n最后，我们将此值与容差 $\\tau = 1.0 \\times 10^{-3}$ 进行比较。\n由于 $R \\approx 1.190 \\times 10^{-3} > 1.0 \\times 10^{-3}$，我们有 $R > \\tau$。这表明对于此时间步长，一阶 Lie-Trotter 方法的局部分裂误差大到不可接受，因此，有必要使用像 Strang 分裂这样的二阶方法。最终答案是 $R$ 的数值。",
            "answer": "$$\n\\boxed{1.190 \\times 10^{-3}}\n$$"
        },
        {
            "introduction": "数值天气预报模型的一个主要挑战是有效处理跨越多个时间尺度的现象。例如，声波的传播速度远快于平流过程。本练习将探讨“分裂-显式”方案，这是一种强大的时间分裂技术，旨在解决这一挑战。您将通过计算满足声波稳定性（CFL条件）所需的最小子步数，并评估其相对于非分裂方案的计算成本，来亲身体验这种方法在实际操作中的巨大效率优势 。这项实践揭示了在不牺牲数值稳定性的前提下，实现更长模拟时间步长的核心权衡。",
            "id": "4074861",
            "problem": "一个可压缩的数值天气预报动力核心在快声波模态和较慢的平流-旋转动力过程之间使用了一种分裂-显式耦合方法。大步长动力过程和物理倾向项在每个长度为 $\\Delta t$ 的总时间步长内计算一次，而声波模态则用 $N_{\\text{ac}}$ 个长度为 $\\Delta t_{\\text{ac}} = \\Delta t / N_{\\text{ac}}$ 的子步进行积分，以满足与声波传播相关的 Courant–Friedrichs–Lewy (CFL) 稳定性要求。\n\n假设一维空间中的声波模态可以由线性标量平流方程 $\\partial \\phi / \\partial t + c_{a} \\, \\partial \\phi / \\partial x = 0$ 做领导阶近似，其中 $c_{a}$ 是声波相速度。声波更新在时间上采用前向欧拉格式，在空间上采用一阶迎风离散格式，网格为均匀网格，间距为 $\\Delta x$。期望的总步长为 $\\Delta t$。\n\n给定：\n- 声波相速度 $c_{a} = 320 \\,\\mathrm{m\\,s^{-1}}$，\n- 网格间距 $\\Delta x = 2.0 \\,\\mathrm{km}$，\n- 总时间步长 $\\Delta t = 60 \\,\\mathrm{s}$。\n\n在一个简单的成本模型中，成本以每网格列每总步长的浮点运算次数（flop）来衡量：\n- 每总步长的慢动力过程成本为 $C_{\\text{slow}} = 2.0 \\times 10^{8}$，\n- 一个声波子步的成本为 $C_{\\text{ac}} = 0.5 \\times 10^{8}$，\n- 每总步长的物理参数化成本为 $C_{\\text{phys}} = 5.0 \\times 10^{8}$。\n\n设分裂-显式方法每总步长的计算成本为 $C_{\\text{split}} = C_{\\text{slow}} + C_{\\text{phys}} + N_{\\text{ac}} \\, C_{\\text{ac}}$。考虑一种非分裂显式方法作为基准，该方法将全局时间步长缩短至声波子步长以满足 CFL 要求，从而在每个 $\\Delta t$ 内执行 $N_{\\text{ac}}$ 个小步长，在每个小步长中都执行慢动力过程、声波更新和物理过程。其每个 $\\Delta t$ 的成本为 $C_{\\text{unsplit}} = N_{\\text{ac}} \\, (C_{\\text{slow}} + C_{\\text{ac}} + C_{\\text{phys}})$。\n\n任务：\n1. 从离散化的声波平流表示及其稳定性约束出发，确定在一个长度为 $\\Delta t$ 的总步长内，为满足声波 CFL 条件所需的最小整数声波子步数 $N_{\\text{ac}}$。\n2. 使用上述成本，计算比率 $R = C_{\\text{split}} / C_{\\text{unsplit}}$。\n\n将比率 $R$ 四舍五入到四位有效数字。将您的最终配对结果表示为一个单行矩阵 $\\begin{pmatrix} N_{\\text{ac}} & R \\end{pmatrix}$，不带单位。",
            "solution": "该问题是适定的且科学上是合理的，基于偏微分方程数值方法在大气建模中应用的基本原理。所有必要数据都已提供，可得出唯一解。我们将按概述的两个任务进行。\n\n第一个任务是确定数值稳定性所需的最小声波子步数 $N_{\\text{ac}}$。声波模态由一维线性标量平流方程建模：\n$$\n\\frac{\\partial \\phi}{\\partial t} + c_{a} \\frac{\\partial \\phi}{\\partial x} = 0\n$$\n其中 $\\phi$ 是一个状态变量，$t$ 是时间，$x$ 是空间坐标，$c_{a}$ 是声波相速度。\n\n该方程在时间上使用前向欧拉格式，在空间上使用一阶迎风格式进行离散。设 $\\phi_j^n$ 表示在网格点 $j$ 和时间层 $n$ 处 $\\phi$ 的值。网格间距为 $\\Delta x$，声波时间步长为 $\\Delta t_{\\text{ac}}$。由于相速度 $c_{a}$ 为正，波在 $x$ 正方向传播，因此网格点 $j$ 处的迎风空间导数使用来自网格点 $j-1$ 的信息。离散后的方程为：\n$$\n\\frac{\\phi_j^{n+1} - \\phi_j^n}{\\Delta t_{\\text{ac}}} + c_{a} \\frac{\\phi_j^n - \\phi_{j-1}^n}{\\Delta x} = 0\n$$\n重新整理以求解下一个时间步的解 $\\phi_j^{n+1}$，得到：\n$$\n\\phi_j^{n+1} = \\phi_j^n - \\frac{c_{a} \\Delta t_{\\text{ac}}}{\\Delta x} (\\phi_j^n - \\phi_{j-1}^n)\n$$\n我们将声波子步的 Courant 数 $\\nu_{\\text{ac}}$ 定义为：\n$$\n\\nu_{\\text{ac}} = \\frac{c_{a} \\Delta t_{\\text{ac}}}{\\Delta x}\n$$\n离散方程可以写为：\n$$\n\\phi_j^{n+1} = (1 - \\nu_{\\text{ac}})\\phi_j^n + \\nu_{\\text{ac}}\\phi_{j-1}^n\n$$\n为了使这个显式格式（时间前向，一阶迎风）稳定，右侧各项的系数必须为非负。由于 $\\nu_{\\text{ac}}$ 内在为正（$c_a > 0$, $\\Delta t_{\\text{ac}} > 0$, $\\Delta x > 0$），稳定性条件为 $1 - \\nu_{\\text{ac}} \\ge 0$，这简化为 Courant–Friedrichs–Lewy (CFL) 稳定性判据：\n$$\n\\nu_{\\text{ac}} \\le 1\n$$\n代入 $\\nu_{\\text{ac}}$ 的定义，我们得到：\n$$\n\\frac{c_{a} \\Delta t_{\\text{ac}}}{\\Delta x} \\le 1\n$$\n这意味着声波时间步长 $\\Delta t_{\\text{ac}}$ 必须满足：\n$$\n\\Delta t_{\\text{ac}} \\le \\frac{\\Delta x}{c_{a}}\n$$\n问题陈述，声波模态在一个总时间步长 $\\Delta t$ 内，用 $N_{\\text{ac}}$ 个长度为 $\\Delta t_{\\text{ac}}$ 的子步进行积分，使得 $\\Delta t_{\\text{ac}} = \\Delta t / N_{\\text{ac}}$。将此代入稳定性条件得到：\n$$\n\\frac{\\Delta t}{N_{\\text{ac}}} \\le \\frac{\\Delta x}{c_{a}}\n$$\n我们需要找到满足此条件的 $N_{\\text{ac}}$ 的最小整数值。对不等式进行整理以求解 $N_{\\text{ac}}$：\n$$\nN_{\\text{ac}} \\ge \\frac{c_{a} \\Delta t}{\\Delta x}\n$$\n现在，我们代入给定的值：\n- $c_a = 320 \\,\\mathrm{m\\,s^{-1}}$\n- $\\Delta t = 60 \\,\\mathrm{s}$\n- $\\Delta x = 2.0 \\,\\mathrm{km} = 2.0 \\times 10^3 \\,\\mathrm{m}$\n\n$$\nN_{\\text{ac}} \\ge \\frac{(320 \\,\\mathrm{m\\,s^{-1}}) \\cdot (60 \\,\\mathrm{s})}{2.0 \\times 10^3 \\,\\mathrm{m}} = \\frac{19200}{2000} = 9.6\n$$\n由于 $N_{\\text{ac}}$ 必须是整数，因此稳定性所需的最小声波子步数是大于或等于 $9.6$ 的最小整数。\n$$\nN_{\\text{ac, min}} = 10\n$$\n\n第二个任务是计算比率 $R = C_{\\text{split}} / C_{\\text{unsplit}}$。分裂-显式和非分裂显式方法的成本由下式给出：\n$$\nC_{\\text{split}} = C_{\\text{slow}} + C_{\\text{phys}} + N_{\\text{ac}} \\, C_{\\text{ac}}\n$$\n$$\nC_{\\text{unsplit}} = N_{\\text{ac}} \\, (C_{\\text{slow}} + C_{\\text{ac}} + C_{\\text{phys}})\n$$\n我们给出了以下每网格列每总步长的成本值：\n- $C_{\\text{slow}} = 2.0 \\times 10^{8}$\n- $C_{\\text{ac}} = 0.5 \\times 10^{8}$\n- $C_{\\text{phys}} = 5.0 \\times 10^{8}$\n\n使用 $N_{\\text{ac}} = 10$，我们可以计算这两个成本。\n对于分裂-显式方法：\n$$\nC_{\\text{split}} = (2.0 \\times 10^{8}) + (5.0 \\times 10^{8}) + 10 \\cdot (0.5 \\times 10^{8})\n$$\n$$\nC_{\\text{split}} = (2.0 + 5.0 + 5.0) \\times 10^{8} = 12.0 \\times 10^{8}\n$$\n对于非分裂显式方法：\n$$\nC_{\\text{unsplit}} = 10 \\cdot ((2.0 \\times 10^{8}) + (0.5 \\times 10^{8}) + (5.0 \\times 10^{8}))\n$$\n$$\nC_{\\text{unsplit}} = 10 \\cdot (2.0 + 0.5 + 5.0) \\times 10^{8} = 10 \\cdot (7.5) \\times 10^{8} = 75.0 \\times 10^{8}\n$$\n现在我们计算比率 $R$：\n$$\nR = \\frac{C_{\\text{split}}}{C_{\\text{unsplit}}} = \\frac{12.0 \\times 10^{8}}{75.0 \\times 10^{8}} = \\frac{12.0}{75.0} = \\frac{12}{75}\n$$\n化简分数：\n$$\nR = \\frac{4 \\times 3}{25 \\times 3} = \\frac{4}{25} = 0.16\n$$\n问题要求将此比率四舍五入到四位有效数字。\n$$\nR = 0.1600\n$$\n最终的配对结果是 $N_{\\text{ac}} = 10$ 和 $R = 0.1600$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 10 & 0.1600 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "将物理参数化（如云微物理）与动力核心耦合是现代气候和天气建模中的一个核心难题，特别是当物理过程表现出“刚性”时，即其特征时间尺度远小于动力学时间步长。本编码练习将带您进入这一挑战的核心，要求您为一个简化的云微物理系统实现一个带有子循环的时间分裂方案。通过编写代码来模拟云水向雨水的转化，并与高精度参考解进行比较，您将直接观察到子循环步数如何影响模型的稳定性和准确性 。这项实践综合了理论概念与编程实现，为您提供了处理多尺度物理-动力学相互作用的宝贵实践经验。",
            "id": "4074886",
            "problem": "在数值天气预报（NWP）中，考虑解析流体动力学与次网格尺度云微物理之间的耦合。在一个单柱对流羽的理想化模型中，假设在一个宏观时间步长内，解析动力学通过沉降过程贡献了雨水的大尺度输送趋势，而微物理过程则通过自动转化将云水转化为雨水。我们定义预报变量为云水混合比 $q_c$ 和雨水混合比 $q_r$，单位均为 $\\mathrm{kg}/\\mathrm{kg}$。简化的暖雨 Kessler 型微物理参数化方案通过一个阈值化的自动转化源 $R(q_c)$ 来建模，而沉降过程则被建模为雨水的一阶汇。在总模拟时间 $T_{\\text{total}}$ 内的连续时间系统为\n$$\n\\frac{d q_c}{d t} \\,=\\, - R(q_c), \\qquad \\frac{d q_r}{d t} \\,=\\, R(q_c) \\,-\\, \\frac{q_r}{\\tau_{\\text{sed}}},\n$$\n其中\n$$\nR(q_c) \\,=\\, \\max\\!\\left(0,\\frac{q_c - q_{\\text{thresh}}}{\\tau_{\\text{auto}}}\\right),\n$$\n其中 $\\tau_{\\text{auto}}$ 是微物理自动转化时间尺度（单位为 $\\mathrm{s}$），$q_{\\text{thresh}}$ 是自动转化阈值（单位为 $\\mathrm{kg}/\\mathrm{kg}$），$\\tau_{\\text{sed}}$ 是沉降时间尺度（单位为 $\\mathrm{s}$）。\n\n在一个代表物理-动力学耦合的时间分裂设计中，解析动力学在一个大小为 $\\Delta t$ 的宏观步长上推进，方法是每个宏观步长应用一次沉降过程；而云微物理则在每个宏观步长内以子步长 $\\Delta t_{\\text{sub}} = \\Delta t/N$ 进行 $N$ 次子循环。每个子步长的微物理子循环更新采用一阶显式欧拉法，\n$$\nq_c^{(k+1)} \\,=\\, q_c^{(k)} \\,-\\, \\Delta t_{\\text{sub}} \\, R\\!\\left(q_c^{(k)}\\right), \\qquad\nq_r^{(k+1)} \\,=\\, q_r^{(k)} \\,+\\, \\Delta t_{\\text{sub}} \\, R\\!\\left(q_c^{(k)}\\right),\n$$\n每个宏观步长应用一次的沉降更新是精确的 $\\tau_{\\text{sed}}$ 衰减\n$$\nq_r^{\\text{new}} \\,=\\, q_r^{\\text{old}} \\, \\exp\\!\\left(-\\frac{\\Delta t}{\\tau_{\\text{sed}}}\\right).\n$$\n所有更新必须保持物理单位：$q_c$ 和 $q_r$ 的单位为 $\\mathrm{kg}/\\mathrm{kg}$，时间单位为 $\\mathrm{s}$。\n\n从对流羽包裹的初始条件 $q_c(0)=q_{c,0}$ 和 $q_r(0)=q_{r,0}$ 开始，设计一个程序，该程序能够：\n- 在总时间 $T_{\\text{total}}$ 内，使用上述算子分裂策略积分系统，其中每个动力学宏观步长包含 $N$ 个微物理子步长。\n- 通过在 $[0, T_{\\text{total}}]$ 上使用高精度求解器积分未分裂的常微分方程（ODE）系统，构建一个高精度参考解。\n- 通过欧几里得范数来量化在 $t=T_{\\text{total}}$ 时的精度\n$$\nE(N) \\,=\\, \\sqrt{\\left(q_c^{\\text{split}}(T_{\\text{total}}) - q_c^{\\text{ref}}(T_{\\text{total}})\\right)^2 \\,+\\, \\left(q_r^{\\text{split}}(T_{\\text{total}}) - q_r^{\\text{ref}}(T_{\\text{total}})\\right)^2},\n$$\n表示为一个浮点数，单位为 $\\mathrm{kg}/\\mathrm{kg}$。\n- 将稳定性量化为一个布尔值，指示是否有任何子步长产生了负的 $q_c$ 或 $q_r$（负值标志着不稳定性）。不要进行裁剪；只需检测并报告不稳定性。\n\n对一个对流羽案例，使用以下科学上合理的测试套件。每个案例都是一个元组 $(N,\\Delta t,T_{\\text{total}},\\tau_{\\text{auto}},\\tau_{\\text{sed}},q_{c,0},q_{r,0},q_{\\text{thresh}})$，并带有指定的单位：\n- 案例 1（理想路径，无子循环）：$(N=\\,$$1$$,\\, \\Delta t=\\,$$10$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$60$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$20$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$2\\times 10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n- 案例 2（中等子循环）：$(N=\\,$$5$$,\\, \\Delta t=\\,$$10$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$60$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$20$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$2\\times 10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n- 案例 3（强子循环）：$(N=\\,$$20$$,\\, \\Delta t=\\,$$10$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$60$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$20$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$2\\times 10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n- 案例 4（边界接近阈值）：$(N=\\,$$1$$,\\, \\Delta t=\\,$$10$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$50$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$20$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n- 案例 5（刚性微物理，无子循环时可能不稳定）：$(N=\\,$$1$$,\\, \\Delta t=\\,$$60$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$120$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$2$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$3\\times 10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n- 案例 6（通过子循环稳定的刚性微物理）：$(N=\\,$$40$$,\\, \\Delta t=\\,$$60$$\\,\\mathrm{s},\\, T_{\\text{total}}=\\,$$120$$\\,\\mathrm{s},\\, \\tau_{\\text{auto}}=\\,$$2$$\\,\\mathrm{s},\\, \\tau_{\\text{sed}}=\\,$$100$$\\,\\mathrm{s},\\, q_{c,0}=\\,$$3\\times 10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{r,0}=\\,$$0$$\\,\\mathrm{kg}/\\mathrm{kg},\\, q_{\\text{thresh}}=\\,$$10^{-3}$$\\,\\mathrm{kg}/\\mathrm{kg})$。\n\n您的程序必须为每个案例计算出数据对 $[E(N),\\text{stable}]$，其中 $E(N)$ 是一个单位为 $\\mathrm{kg}/\\mathrm{kg}$ 的浮点数，而 $\\text{stable}$ 是一个布尔值。您的程序应生成单行输出，其中包含按上述案例顺序排列的结果，格式为逗号分隔的列表并用方括号括起，例如 $[[e_1,\\text{stable}_1],[e_2,\\text{stable}_2],\\dots]$，不含任何额外文本。",
            "solution": "该问题被认为是有效的，因为它是科学上合理的、适定的和自洽的。它提出了一个标准的、尽管是简化的云微物理及其与动力学耦合的模型，这是数值天气预报中的一个核心课题。其表述涉及一个常微分方程（ODE）系统和一个数值算子分裂方案，两者都定义明确。所提供的参数对于大气对流是物理上现实的。\n\n对于每个测试案例，该解决方案通过两条主要路径实现：计算一个高精度参考解，以及根据指定的时间分裂方案计算解。然后比较这些结果，以评估分裂方法的准确性和稳定性。\n\n首先，为连续时间系统建立一个高精度参考解。该 ODE 系统由以下公式给出：\n$$\n\\frac{d q_c}{d t} \\,=\\, - R(q_c) \\,=\\, -\\max\\!\\left(0,\\frac{q_c - q_{\\text{thresh}}}{\\tau_{\\text{auto}}}\\right)\n$$\n$$\n\\frac{d q_r}{d t} \\,=\\, R(q_c) - \\frac{q_r}{\\tau_{\\text{sed}}} \\,=\\, \\max\\!\\left(0,\\frac{q_c - q_{\\text{thresh}}}{\\tau_{\\text{auto}}}\\right) - \\frac{q_r}{\\tau_{\\text{sed}}}\n$$\n这是一个在时间区间 $[0, T_{\\text{total}}]$ 上定义的初值问题，初始条件为 $q_c(0) = q_{c,0}$ 和 $q_r(0) = q_{r,0}$。我们使用高质量的数值 ODE 求解器来求解该系统，特别是来自 SciPy 库的 `scipy.integrate.solve_ivp`。该函数采用自适应步长法（我们选择 `LSODA`，它会在非刚性和刚性方法之间自动切换），并使用非常严格的相对和绝对误差容限（分别为 $10^{-12}$ 和 $10^{-15}$），以确保解 $(q_c^{\\text{ref}}(T_{\\text{total}}), q_r^{\\text{ref}}(T_{\\text{total}}))$ 是一个可靠的基准。\n\n其次，我们实现了所述的算子分裂数值方案。总模拟时间 $T_{\\text{total}}$ 被划分为 $M = T_{\\text{total}} / \\Delta t$ 个持续时间为 $\\Delta t$ 的宏观步长。在每个宏观步长内，我们在微物理和沉降过程之间执行顺序分裂。\n\n代表自动转化的微物理过程由以下方程控制：\n$$\n\\frac{d q_c}{d t} \\,=\\, -R(q_c), \\qquad \\frac{d q_r}{d t} \\,=\\, R(q_c)\n$$\n该子系统通过使用一阶显式欧拉方法，以子步长 $\\Delta t_{\\text{sub}} = \\Delta t/N$ 进行 $N$ 次子循环，在 $\\Delta t$ 上积分。对于从 $0$ 到 $N-1$ 的每个子步长 $k$，状态 $(q_c^{(k)}, q_r^{(k)})$ 更新为 $(q_c^{(k+1)}, q_r^{(k+1)})$：\n$$\nq_c^{(k+1)} \\,=\\, q_c^{(k)} - \\Delta t_{\\text{sub}} \\, R(q_c^{(k)})\n$$\n$$\nq_r^{(k+1)} \\,=\\, q_r^{(k)} + \\Delta t_{\\text{sub}} \\, R(q_c^{(k)})\n$$\n在此过程中，我们监控数值不稳定性。如果在任何子步长的任何时刻 $q_c$ 或 $q_r$ 变为负值，则标记为不稳定。这是显式时间步进方案的典型特征，当时间步长相对于过程的特征时间尺度过大时会发生。对于 $q_c$ 方程，当 $q_c > q_{\\text{thresh}}$ 时，更新公式为 $q_c^{(k+1)} = q_c^{(k)} - \\Delta t_{\\text{sub}} \\frac{q_c^{(k)} - q_{\\text{thresh}}}{\\tau_{\\text{auto}}}$。为了防止 $q_c^{(k+1)}$ 变为负值（特别是在一个步长内过冲超过平衡值 $q_{\\text{thresh}}$），时间步长 $\\Delta t_{\\text{sub}}$ 必须足够小。稳定性的一个必要条件与 Courant-Friedrichs-Lewy (CFL) 条件有关，对于该方程，该条件大致要求 $\\Delta t_{\\text{sub}} \\le \\tau_{\\text{auto}}$。即使宏观步长 $\\Delta t$ 不满足此条件，使用足够大的 $N$ 进行子循环也可以满足。\n\n在完成 $N$ 个微物理子步长后，对整个宏观步长 $\\Delta t$ 应用一次沉降过程。沉降过程由以下方程控制：\n$$\n\\frac{d q_c}{d t} \\,=\\, 0, \\qquad \\frac{d q_r}{d t} \\,=\\, -\\frac{q_r}{\\tau_{\\text{sed}}}\n$$\n此简单衰减方程在区间 $\\Delta t$ 上的精确解被应用于从微物理子循环中获得的 $q_r$ 值：\n$$\nq_r^{\\text{new}} \\,=\\, q_r^{\\text{old}} \\exp\\left(-\\frac{\\Delta t}{\\tau_{\\text{sed}}}\\right)\n$$\n$q_c$ 的值在沉降步骤中保持不变。这一系列微物理子循环后跟一次沉降更新，构成了一个完整的宏观步长。\n\n对所有 $M$ 个宏观步长重复此完整过程。最终状态 $(q_c^{\\text{split}}(T_{\\text{total}}), q_r^{\\text{split}}(T_{\\text{total}}))$ 是分裂步长积分的结果。\n\n最后，对于每个测试案例，我们计算所需的输出。精度通过在 $t=T_{\\text{total}}$ 时的误差向量的欧几里得范数来量化：\n$$\nE(N) \\,=\\, \\sqrt{\\left(q_c^{\\text{split}}(T_{\\text{total}}) - q_c^{\\text{ref}}(T_{\\text{total}})\\right)^2 \\,+\\, \\left(q_r^{\\text{split}}(T_{\\text{total}}) - q_r^{\\text{ref}}(T_{\\text{total}})\\right)^2}\n$$\n稳定性以布尔值的形式报告，如果在积分过程中的任何时刻检测到负的混合比，则为 `False`，否则为 `True`。最终输出是一个列表，其中包含每个测试案例的数据对 $[E(N), \\text{stable}]$。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve_case(N, dt, T_total, tau_auto, tau_sed, q_c0, q_r0, q_thresh):\n    \"\"\"\n    Computes the error and stability for a single test case of the\n    physics-dynamics coupling problem.\n    \"\"\"\n    params = (tau_auto, tau_sed, q_thresh)\n\n    # 1. High-accuracy reference solution using an ODE solver\n    def ode_system(t, y, tau_auto_p, tau_sed_p, q_thresh_p):\n        q_c_val, q_r_val = y\n        R_qc = np.maximum(0.0, (q_c_val - q_thresh_p) / tau_auto_p)\n        dqc_dt = -R_qc\n        dqr_dt = R_qc - q_r_val / tau_sed_p\n        return [dqc_dt, dqr_dt]\n\n    y0 = [q_c0, q_r0]\n    t_span = [0, T_total]\n    \n    ref_sol = solve_ivp(\n        ode_system,\n        t_span,\n        y0,\n        args=params,\n        method='LSODA',\n        rtol=1e-12,\n        atol=1e-15\n    )\n    q_c_ref, q_r_ref = ref_sol.y[:, -1]\n\n    # 2. Operator-splitting numerical solution\n    q_c = q_c0\n    q_r = q_r0\n    stable = True\n    \n    # Check for T_total being a multiple of dt to avoid float precision issues\n    if not np.isclose(T_total % dt, 0) and not np.isclose(T_total % dt, dt):\n        raise ValueError(\"T_total must be an integer multiple of dt.\")\n    num_macro_steps = int(round(T_total / dt))\n    dt_sub = dt / N\n\n    for _ in range(num_macro_steps):\n        # Microphysics sub-stepping loop\n        for _ in range(N):\n            R_qc = np.maximum(0.0, (q_c - q_thresh) / tau_auto)\n            \n            # Explicit Euler update\n            q_c_new = q_c - dt_sub * R_qc\n            q_r_new = q_r + dt_sub * R_qc\n\n            # Stability check (do not clip, just report)\n            if q_c_new  0.0 or q_r_new  0.0:\n                stable = False\n            \n            q_c, q_r = q_c_new, q_r_new\n\n        # Dynamics (sedimentation) step\n        q_r = q_r * np.exp(-dt / tau_sed)\n        # q_c is unchanged\n    \n    q_c_split = q_c\n    q_r_split = q_r\n\n    # 3. Quantify error and stability\n    error = np.sqrt((q_c_split - q_c_ref)**2 + (q_r_split - q_r_ref)**2)\n\n    return [error, stable]\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # (N, Δt, T_total, τ_auto, τ_sed, q_c,0, q_r,0, q_thresh)\n        (1, 10.0, 60.0, 20.0, 100.0, 2e-3, 0.0, 1e-3),\n        (5, 10.0, 60.0, 20.0, 100.0, 2e-3, 0.0, 1e-3),\n        (20, 10.0, 60.0, 20.0, 100.0, 2e-3, 0.0, 1e-3),\n        (1, 10.0, 50.0, 20.0, 100.0, 1e-3, 0.0, 1e-3),\n        (1, 60.0, 120.0, 2.0, 100.0, 3e-3, 0.0, 1e-3),\n        (40, 60.0, 120.0, 2.0, 100.0, 3e-3, 0.0, 1e-3),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = solve_case(*case)\n        results.append(result)\n    \n    # Format the final output string as specified\n    # e.g., [[err1,True],[err2,False],...]\n    output_string = \",\".join([f\"[{res[0]},{'True' if res[1] else 'False'}]\" for res in results])\n    print(f\"[{output_string}]\")\n\nsolve()\n```"
        }
    ]
}