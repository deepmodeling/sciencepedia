{
    "hands_on_practices": [
        {
            "introduction": "理论是基础，但真正的理解始于实践。我们首先通过一个简单的例子，直观地揭示标准半拉格朗日方法在质量守恒方面存在的固有问题。这个练习将通过在一个一维网格上进行单步平流计算，量化展示线性插值如何导致虚假的质量增加或减少，从而阐明开发更复杂守恒格式的必要性。",
            "id": "4062339",
            "problem": "考虑一个用于数值天气预报（NWP）的一维周期性区域，该区域被一个均匀网格离散化，网格间距为 $\\Delta x = 1$（无量纲），网格点由 $i=0,1,2,3$ 索引。一个被动标量 $q(x,t)$ 满足平流方程 $\\partial q / \\partial t + u(x,t) \\, \\partial q / \\partial x = 0$。在半拉格朗日（SL）方法中，假定 $q$ 沿着轨迹线为常数，并且在时间 $t^{n+1}$ 时每个网格点 $x_i$ 的更新值是通过对出发点 $x_i - u(x_i,t^n)\\,\\Delta t$ 处值的采样得到的，该值由时间 $t^n$ 时最近的两个上游网格点的值进行线性插值来近似。应用周期性边界条件，因此索引运算以 4 为模。\n\n在时间 $t^n$，标量场在网格点上的值由 $q_i^n$ 给出：\n$$\nq_0^n = 3,\\quad q_1^n = 1,\\quad q_2^n = 0,\\quad q_3^n = 2.\n$$\n使用时间步长 $\\Delta t = 1$（无量纲）。在该时间步内，速度场是定常的，并在到达网格点上指定为：\n$$\nu(x_0,t^n) = 0.2,\\quad u(x_1,t^n) = 0.6,\\quad u(x_2,t^n) = 0.8,\\quad u(x_3,t^n) = 0.4.\n$$\n假设每个出发点 $x_i - u(x_i,t^n)\\,\\Delta t$ 都位于区间 $[x_{i-1},x_i]$ 内，因此使用 $q_{i-1}^n$ 和 $q_i^n$ 之间的线性插值。令 $\\alpha_i = u(x_i,t^n)\\,\\Delta t / \\Delta x$ 表示网格点 $i$ 处的局部库朗数。\n\n将时间 $t^n$ 和 $t^{n+1}$ 的离散、区域积分标量含量定义为：\n$$\nM^n = \\sum_{i=0}^{3} q_i^n \\,\\Delta x,\\qquad M^{n+1} = \\sum_{i=0}^{3} q_i^{n+1} \\,\\Delta x,\n$$\n其中 $\\Delta x = 1$（无量纲）。使用所述的半拉格朗日线性插值更新方法，计算在一个时间步长内离散含量的净变化，\n$$\n\\Delta M = M^{n+1} - M^n,\n$$\n并将您的最终答案表示为一个纯数（无量纲）。无需四舍五入；请提供精确值。",
            "solution": "该问题要求使用带有线性插值的半拉格朗日（SL）平流格式，计算一个离散标量在一个时间步长内的变化。\n\n首先，我们建立数值格式。半拉格朗日方法通过将轨迹线在时间上向后追溯到时间 $t^n$ 的出发点 $x_{d,i}$，并取该点的标量场值来更新时间 $t^{n+1}$ 时网格点 $x_i$ 的值。新时间的值为 $q_i^{n+1} = q^n(x_{d,i})$。出发点由 $x_{d,i} = x_i - u(x_i, t^n) \\Delta t$ 给出。\n\n问题指明，$q^n(x_{d,i})$ 的值由最近的两个上游网格点的值进行线性插值来近似。问题陈述出发点 $x_i - u(x_i,t^n)\\,\\Delta t$ 位于区间 $[x_{i-1},x_i]$ 内。出发点相对于网格的位置由局部库朗数 $\\alpha_i = u(x_i,t^n)\\,\\Delta t / \\Delta x$ 决定。\n出发点可以写为 $x_{d,i} = x_i - \\alpha_i \\Delta x$。该点位于 $x_i$ 上游，距离为分数 $\\alpha_i$，在单元格 $[x_{i-1}, x_i]$ 内。\n\n使用周围网格点的值 $q_{i-1}^n$ 和 $q_i^n$ 对 $x_{d,i}$ 处的值进行线性插值，公式如下：\n$$q_i^{n+1} = w_{i} q_i^n + w_{i-1} q_{i-1}^n$$\n其中权重 $w_i$ 和 $w_{i-1}$ 取决于 $x_{d,i}$ 的位置。每个网格点的权重与出发点到*另一个*网格点的距离成正比。\n从 $x_{d,i}$ 到 $x_i$ 的距离是 $\\alpha_i \\Delta x$。\n从 $x_{d,i}$ 到 $x_{i-1}$ 的距离是 $(x_i - \\alpha_i \\Delta x) - x_{i-1} = (x_i - x_{i-1}) - \\alpha_i \\Delta x = \\Delta x - \\alpha_i \\Delta x = (1-\\alpha_i) \\Delta x$。\n用区间长度 $\\Delta x$ 进行归一化，权重为：\n$w_i = \\frac{(1-\\alpha_i) \\Delta x}{\\Delta x} = 1 - \\alpha_i$\n$w_{i-1} = \\frac{\\alpha_i \\Delta x}{\\Delta x} = \\alpha_i$\n因此，使用线性插值的半拉格朗日格式的更新公式为：\n$$q_i^{n+1} = (1 - \\alpha_i) q_i^n + \\alpha_i q_{i-1}^n$$\n此公式适用于每个网格点 $i \\in \\{0, 1, 2, 3\\}$，由于周期性边界条件，索引运算以 4 为模进行（即 $q_{-1}^n = q_3^n$）。\n\n给定的数据是：\n网格间距：$\\Delta x = 1$。\n时间步长：$\\Delta t = 1$。\n初始标量值：$q_0^n = 3$, $q_1^n = 1$, $q_2^n = 0$, $q_3^n = 2$。\n速度值：$u(x_0,t^n) = 0.2$, $u(x_1,t^n) = 0.6$, $u(x_2,t^n) = 0.8$, $u(x_3,t^n) = 0.4$。为简洁起见，我们将其表示为 $u_0, u_1, u_2, u_3$。\n\n首先，我们计算局部库朗数 $\\alpha_i = u_i \\Delta t / \\Delta x$：\n$\\alpha_0 = 0.2 \\times 1 / 1 = 0.2$\n$\\alpha_1 = 0.6 \\times 1 / 1 = 0.6$\n$\\alpha_2 = 0.8 \\times 1 / 1 = 0.8$\n$\\alpha_3 = 0.4 \\times 1 / 1 = 0.4$\n与问题陈述一致，所有的 $\\alpha_i$ 都在区间 $[0,1]$ 内。\n\n现在，我们为每个 $i \\in \\{0, 1, 2, 3\\}$ 计算 $q_i^{n+1}$：\n对于 $i=0$： $q_0^{n+1} = (1 - \\alpha_0) q_0^n + \\alpha_0 q_{-1}^n = (1 - 0.2) q_0^n + 0.2 q_3^n = 0.8(3) + 0.2(2) = 2.4 + 0.4 = 2.8$。\n对于 $i=1$： $q_1^{n+1} = (1 - \\alpha_1) q_1^n + \\alpha_1 q_0^n = (1 - 0.6) q_1^n + 0.6 q_0^n = 0.4(1) + 0.6(3) = 0.4 + 1.8 = 2.2$。\n对于 $i=2$： $q_2^{n+1} = (1 - \\alpha_2) q_2^n + \\alpha_2 q_1^n = (1 - 0.8) q_2^n + 0.8 q_1^n = 0.2(0) + 0.8(1) = 0.0 + 0.8 = 0.8$。\n对于 $i=3$： $q_3^{n+1} = (1 - \\alpha_3) q_3^n + \\alpha_3 q_2^n = (1 - 0.4) q_3^n + 0.4 q_2^n = 0.6(2) + 0.4(0) = 1.2 + 0.0 = 1.2$。\n\n时间 $t^{n+1}$ 时的标量场为：$q_0^{n+1} = 2.8$, $q_1^{n+1} = 2.2$, $q_2^{n+1} = 0.8$, $q_3^{n+1} = 1.2$。\n\n接下来，我们计算时间 $t^n$ 和 $t^{n+1}$ 的离散标量总含量。总含量定义为 $M = \\sum_{i=0}^{3} q_i \\Delta x$。由于 $\\Delta x=1$，这仅是 $q_i$ 值的总和。\n\n在时间 $t^n$：\n$$M^n = \\sum_{i=0}^{3} q_i^n = q_0^n + q_1^n + q_2^n + q_3^n = 3 + 1 + 0 + 2 = 6$$\n\n在时间 $t^{n+1}$：\n$$M^{n+1} = \\sum_{i=0}^{3} q_i^{n+1} = q_0^{n+1} + q_1^{n+1} + q_2^{n+1} + q_3^{n+1} = 2.8 + 2.2 + 0.8 + 1.2 = 7.0$$\n\n最后，一个时间步长内离散含量的净变化为：\n$$\\Delta M = M^{n+1} - M^n = 7.0 - 6.0 = 1.0$$\n\n非零的变化 $\\Delta M$ 表明，使用线性插值的半拉格朗日格式不是严格守恒的。这种不守恒性源于信息在网格上收集和分布的不对称性。根据构造，到达一个网格点的值的插值权重之和为一，但从一个网格点出发到其邻近点的值的权重之和不一定为一。\n\n总含量的变化也可以通过符号推导得出：\n$$M^{n+1} = \\sum_{i} q_i^{n+1} = \\sum_{i} [(1-\\alpha_i)q_i^n + \\alpha_i q_{i-1}^n] = \\sum_i q_i^n - \\sum_i \\alpha_i q_i^n + \\sum_i \\alpha_i q_{i-1}^n$$\n$$\\Delta M = M^{n+1} - M^n = \\sum_i \\alpha_i q_{i-1}^n - \\sum_i \\alpha_i q_i^n = \\sum_i \\alpha_i (q_{i-1}^n - q_i^n)$$\n使用给定值通过此公式验证结果：\n$\\Delta M = \\alpha_0(q_3^n - q_0^n) + \\alpha_1(q_0^n - q_1^n) + \\alpha_2(q_1^n - q_2^n) + \\alpha_3(q_2^n - q_3^n)$\n$\\Delta M = 0.2(2-3) + 0.6(3-1) + 0.8(1-0) + 0.4(0-2)$\n$\\Delta M = 0.2(-1) + 0.6(2) + 0.8(1) + 0.4(-2) = -0.2 + 1.2 + 0.8 - 0.8 = 1.0$。\n符号推导证实了数值结果。最终答案是一个纯粹的无量纲数。",
            "answer": "$$\\boxed{1}$$"
        },
        {
            "introduction": "在认识到标准插值方法的不足之后，我们转向其解决方案：守恒重映（conservative remapping）。此练习将引导您推导并应用一种基于通量形式的半拉格朗日方法。您将通过计算离去区间与网格单元的重叠部分来更新质量，确保质量在输运过程中被精确地重新分配，从而从根本上理解守恒算法的核心机制。",
            "id": "4062354",
            "problem": "考虑一个无源标量质量密度 $\\rho(x,t)$ 在周期性域 $[0,L)$ 上被恒定速度场 $u$ 进行一维纯平流。该域被离散为 N 个宽度为 $\\Delta x$ 的均匀单元，其中单元 i 占据 $[x_{i-\\frac{1}{2}},x_{i+\\frac{1}{2}})$，在时间 $t^n$ 的单元积分质量为 $m_i^n = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\rho(x,t^n)\\,dx$。控制定律是物质控制体的质量守恒积分表述：在纯平流作用下，包含在物质区间内的质量不随时间变化。\n\n在一个时间步长 $\\Delta t$ 内，一个通量形式的守恒半拉格朗日更新将时间 $t^{n+1}$ 的欧拉到达单元 i 映射到其在时间 $t^n$ 的出发区间。假设在每个单元上对 $\\rho(\\cdot,t^n)$ 进行分段常数重构，其值等于单元平均值 $\\rho_j^n = m_j^n/\\Delta x$。\n\n- 域和网格：$L = 5~\\text{km}$, $N = 5$, $\\Delta x = 1~\\text{km}$，周期性边界条件。\n- 速度和时间步长：$u = 0.365~\\text{km s}^{-1}$, $\\Delta t = 2~\\text{s}$。\n- $t^n$ 时刻的初始单元积分质量（单位：千克）：$m_1^n = 1200$, $m_2^n = 2100$, $m_3^n = 1500$, $m_4^n = 300$, $m_5^n = 900$。\n\n任务：\n1. 从物质区间的质量守恒积分形式和恒定速度 $u$ 下的出发区间的定义出发，推导用分段常数 $\\rho_j^n$ 和单元 i 的出发区间与给予单元之间的一维重叠长度来更新 $m_i^{n+1}$ 的守恒重映表达式。将注意力限制在 $0  s  \\Delta x$ 的情况，其中 $s = u\\,\\Delta t$ 是一个时间步长内的平流位移大小，并明确指出对于给定的到达单元 i 出现的两个重叠长度。\n2. 对于到达单元 $i=3$，计算两个重叠长度的数值，然后使用上述分段常数重构计算 $m_3^{n+1}$。\n\n将您对 $m_3^{n+1}$ 的最终数值答案以千克（kg）表示，并四舍五入到四位有效数字。",
            "solution": "### 解答推导与计算\n\n**任务1：守恒重映表达式的推导**\n\n基本原理是物质控制体中的质量守恒。在半拉格朗日框架中，我们考虑到达时间 $t^{n+1}$ 的一个固定欧拉网格单元，并将其体积追溯到它在时间 $t^n$ 的出发位置。\n\n根据定义，在时间 $t^{n+1}$，到达单元 i（表示为 $C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}})$）中的质量为：\n$$ m_i^{n+1} = \\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} \\rho(x, t^{n+1})\\,dx $$\n根据物质区间的质量守恒积分定律，这个质量等于在时间 $t^n$ 时相应的出发区间 $D_i$ 内包含的质量。对于恒定速度 $u$，在 $t^{n+1}$ 时刻的点 x 源于 $t^n$ 时刻的 $x_d = x - u\\Delta t$。因此，对应于到达单元 $C_i$ 的出发区间 $D_i$ 是：\n$$ D_i = [x_{i-\\frac{1}{2}} - u\\Delta t, x_{i+\\frac{1}{2}} - u\\Delta t) $$\n令 $s = u\\Delta t$ 为时间步长 $\\Delta t$ 内的平流位移。出发区间为 $D_i = [x_{i-\\frac{1}{2}} - s, x_{i+\\frac{1}{2}} - s)$。质量更新则为：\n$$ m_i^{n+1} = \\int_{D_i} \\rho(x, t^n)\\,dx = \\int_{x_{i-\\frac{1}{2}} - s}^{x_{i+\\frac{1}{2}} - s} \\rho(x, t^n)\\,dx $$\n问题指定在时间 $t^n$ 密度场进行分段常数重构，其中对于任何单元 j，对所有 $x \\in C_j$ 都有 $\\rho(x, t^n) = \\rho_j^n = m_j^n/\\Delta x$。\n\n我们被给予约束条件 $0  s  \\Delta x$。这意味着出发区间 $D_i$ 与时间 $t^n$ 网格中的恰好两个给予单元重叠。$D_i$ 的左端点 $x_{i-\\frac{1}{2}} - s$ 位于单元 $C_{i-1} = [x_{i-\\frac{3}{2}}, x_{i-\\frac{1}{2}})$ 内。$D_i$ 的右端点 $x_{i+\\frac{1}{2}} - s$ 位于单元 $C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}})$ 内。（索引按周期性处理，但在此推导中，我们可以假设它们是有效的。）\n\n$m_i^{n+1}$ 的积分可以被分解到两个给予单元上：\n$$ m_i^{n+1} = \\int_{D_i \\cap C_{i-1}} \\rho(x, t^n)\\,dx + \\int_{D_i \\cap C_i} \\rho(x, t^n)\\,dx $$\n相交的区间是：\n1.  $D_i \\cap C_{i-1} = [x_{i-\\frac{1}{2}} - s, x_{i-\\frac{1}{2}})$。这个相交区间的长度是第一个重叠长度：$L_{upwind} = x_{i-\\frac{1}{2}} - (x_{i-\\frac{1}{2}} - s) = s$。\n2.  $D_i \\cap C_i = [x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}} - s)$。这个相交区间的长度是第二个重叠长度：$L_{local} = (x_{i+\\frac{1}{2}} - s) - x_{i-\\frac{1}{2}} = \\Delta x - s$。\n\n因此，两个重叠长度明确为 $s$ 和 $\\Delta x - s$。\n\n由于 $\\rho(x,t^n)$ 在每个单元上是常数，我们可以计算积分：\n$$ m_i^{n+1} = \\rho_{i-1}^n \\cdot (\\text{length of } D_i \\cap C_{i-1}) + \\rho_i^n \\cdot (\\text{length of } D_i \\cap C_i) $$\n代入重叠长度和密度表达式，得到守恒重映表达式：\n$$ m_i^{n+1} = \\rho_{i-1}^n \\cdot s + \\rho_i^n \\cdot (\\Delta x - s) $$\n该表达式根据给予单元中的密度和重叠长度来更新质量 $m_i^{n+1}$。任务1完成。\n\n**任务2：到达单元 i=3 的计算**\n\n我们需要计算 $m_3^{n+1}$。到达单元是 $i=3$。给予单元是 $C_{i-1} = C_2$ 和 $C_i = C_3$。更新公式是：\n$$ m_3^{n+1} = \\rho_2^n \\cdot s + \\rho_3^n \\cdot (\\Delta x - s) $$\n\n首先，我们计算参数的数值：\n- 平流位移：$s = u \\cdot \\Delta t = (0.365~\\text{km s}^{-1})(2~\\text{s}) = 0.73~\\text{km}$。\n- 单元宽度：$\\Delta x = 1~\\text{km}$。\n\n接下来，我们计算单元 $i=3$ 的两个重叠长度的数值：\n- 与给予单元 $C_2$ 的重叠长度：$s = 0.73~\\text{km}$。\n- 与给予单元 $C_3$ 的重叠长度：$\\Delta x - s = 1~\\text{km} - 0.73~\\text{km} = 0.27~\\text{km}$。\n\n现在，我们根据给定的初始质量计算所需的密度：\n- $m_2^n = 2100\\,\\text{kg}$\n- $m_3^n = 1500\\,\\text{kg}$\n密度为：\n- $\\rho_2^n = \\frac{m_2^n}{\\Delta x} = \\frac{2100\\,\\text{kg}}{1\\,\\text{km}} = 2100\\,\\text{kg km}^{-1}$。\n- $\\rho_3^n = \\frac{m_3^n}{\\Delta x} = \\frac{1500\\,\\text{kg}}{1\\,\\text{km}} = 1500\\,\\text{kg km}^{-1}$。\n\n最后，我们将这些值代入重映公式以求得 $m_3^{n+1}$：\n$$ m_3^{n+1} = (2100\\,\\text{kg km}^{-1}) \\cdot (0.73\\,\\text{km}) + (1500\\,\\text{kg km}^{-1}) \\cdot (0.27\\,\\text{km}) $$\n$$ m_3^{n+1} = (2100 \\times 0.73)\\,\\text{kg} + (1500 \\times 0.27)\\,\\text{kg} $$\n$$ m_3^{n+1} = 1533\\,\\text{kg} + 405\\,\\text{kg} $$\n$$ m_3^{n+1} = 1938\\,\\text{kg} $$\n问题要求答案四舍五入到四位有效数字。计算出的值 1938 是一个恰好有四位有效数字的整数。因此，无需四舍五入。\n$m_3^{n+1}$ 的最终数值答案是 $1938$ kg。",
            "answer": "$$\n\\boxed{1938}\n$$"
        },
        {
            "introduction": "最后的挑战是将我们在一维模型中学到的概念应用到更真实的二维球面几何中，这是气候和天气模型中的标准设定。在这个编程练习中，您将为球面上的刚体旋转问题分别实现标准半拉格朗日方案和守恒重映方案。通过对比两种方法在完整旋转周期后的总质量误差，您将亲身体验并量化验证守恒格式对于长期数值模拟的极端重要性。",
            "id": "4062306",
            "problem": "考虑单位半径球体上由恒定角速度的刚体旋转引起的被动示踪剂平流。其控制定律是示踪剂 $q(\\lambda,\\phi,t)$ 的物质守恒，由球面上的连续性方程控制，这意味着 $q$ 沿着轨迹线是恒定的。球面的经度为 $\\lambda \\in [0,2\\pi)$，纬度为 $\\phi \\in [-\\pi/2,\\pi/2]$，使用弧度作为角度单位。示踪剂的全球总质量由球面积分定义\n$$\nM(t) \\equiv \\int_{0}^{2\\pi} \\int_{-\\pi/2}^{\\pi/2} q(\\lambda,\\phi,t)\\,\\cos\\phi \\, d\\phi \\, d\\lambda,\n$$\n在刚体旋转的精确平流下，该质量是不变的。\n\n在半拉格朗日平流中，通过将每个网格点（或每个网格单元平均值）在时间 $t+\\Delta t$ 的位置沿特征线映射到其在时间 $t$ 的出发位置，来推进离散的示踪剂场。在围绕极轴进行刚体旋转的情况下，轨迹线沿纬向移动，纬度保持不变，而经度发生偏移。考虑两种算法重映（remapping）选择：\n\n- 标准半拉格朗日（SL）插值法：通过在连续的出发经度上使用经向线性插值对前一时刻的场进行采样，来更新单元中心的点值。该方法不严格守恒。\n\n- 守恒半拉格朗日重映法：通过计算由纬向偏移引起的上游单元区间重叠的贡献，来更新单元平均值。对于均匀的经度网格和纯平移，这简化为沿每个纬度圈的一维周期性守恒重映，该方法能精确保持纬圈积分质量，当与正确的球面面积权重结合时，也能保持全球总质量。\n\n您的任务是为纬度-经度网格离散化实现这两种方法，将一个紧凑的余弦钟示踪剂平流一个完整的精确旋转周期，并评估完成旋转后每种方法的全球总质量误差。\n\n使用以下设置，所有角度均为弧度，时间为无量纲单位：\n\n- 单位球半径为 $a = 1$。\n\n- 刚体旋转的角速度为 $\\omega  0$，周期为 $T = 2\\pi/\\omega$。选择任意时间步长 $\\Delta t$；通过执行 $N$ 个大小为 $\\Delta t$ 的均匀步长，然后执行一个大小为 $\\Delta t_{\\text{last}}$ 的最后一步，确保模拟恰好完成一个完整的旋转，使得 $N\\omega \\Delta t + \\omega \\Delta t_{\\text{last}} = 2\\pi$。\n\n- 示踪剂的初始条件是一个以 $(\\lambda_0,\\phi_0)$ 为中心、半角半径为 $R$ 的余弦钟，定义为\n$$\nq(\\lambda,\\phi,0) =\n\\begin{cases}\n\\frac{1}{2}\\left[1+\\cos\\left(\\pi \\frac{\\alpha(\\lambda,\\phi)}{R}\\right)\\right],   \\alpha(\\lambda,\\phi) \\le R,\\\\\n0,   \\alpha(\\lambda,\\phi)  R,\n\\end{cases}\n$$\n其中 $\\alpha(\\lambda,\\phi)$ 是 $(\\lambda,\\phi)$ 和 $(\\lambda_0,\\phi_0)$ 之间的大圆角距离，由下式给出\n$$\n\\cos \\alpha(\\lambda,\\phi) = \\sin\\phi\\,\\sin\\phi_0 + \\cos\\phi\\,\\cos\\phi_0\\,\\cos(\\lambda-\\lambda_0), \\quad \\alpha \\in [0,\\pi].\n$$\n\n- 用 $N_\\lambda$ 个等距单元中心离散化经度，用 $N_\\phi$ 个等距单元中心离散化纬度。使用基于纬度边界的精确球面单元面积：\n$$\nA_{i,j} = \\Delta \\lambda \\left[\\sin\\left(\\phi_{i+\\frac{1}{2}}\\right) - \\sin\\left(\\phi_{i-\\frac{1}{2}}\\right)\\right], \\quad \\Delta \\lambda = \\frac{2\\pi}{N_\\lambda},\n$$\n其中 $\\phi_{i\\pm\\frac{1}{2}}$ 表示纬度边界。\n\n- 对于标准SL方法，通过在连续出发经度上进行经向线性插值来更新每个单元中心 $(\\lambda_j,\\phi_i)$ 的点值。对于守恒重映方法，沿经度方向使用由纬圈上的纬向偏移引起的上游区间的精确重叠分数来更新每个单元的平均值；这种一维周期性守恒重映必须保持每个纬度圈上单元平均值的总和。\n\n使用离散场的面积加权和计算初始全球总质量 $M(0)$。在完成一个精确的完整旋转后，计算标准SL方法的最终质量 $M_{\\text{std}}$ 和守恒重映方法的最终质量 $M_{\\text{cons}}$，并报告有符号的质量误差\n$$\nE_{\\text{std}} = M_{\\text{std}} - M(0), \\qquad E_{\\text{cons}} = M_{\\text{cons}} - M(0).\n$$\n\n实现程序以评估以下测试套件的这些质量误差，涵盖典型情况、粗网格较大步长情况以及细网格多步长情况：\n\n- 情况 1：$N_\\lambda = 128$，$N_\\phi = 64$，$\\omega = 2\\pi$，$\\Delta t = 0.0025$，$\\lambda_0 = 1.3$，$\\phi_0 = 0.7$，$R = 0.5$。\n\n- 情况 2：$N_\\lambda = 32$，$N_\\phi = 16$，$\\omega = 2\\pi$，$\\Delta t = 0.02$，$\\lambda_0 = 1.3$，$\\phi_0 = 0.7$，$R = 0.5$。\n\n- 情况 3：$N_\\lambda = 256$，$N_\\phi = 128$，$\\omega = 2\\pi$，$\\Delta t = 0.0002$，$\\lambda_0 = 1.3$，$\\phi_0 = 0.7$，$R = 0.5$。\n\n您的程序应生成单行输出，其中包含六个浮点数结果，格式为方括号内的逗号分隔列表，顺序为 $[E_{\\text{std},1}, E_{\\text{cons},1}, E_{\\text{std},2}, E_{\\text{cons},2}, E_{\\text{std},3}, E_{\\text{cons},3}]$，其中每个 $E$ 是相应情况下的质量误差，表示为十进制数。",
            "solution": "问题陈述已经过严格验证，被认为是科学上合理、适定且客观的。它提出了一个计算流体动力学中的标准测试案例，用于评估球面上的数值平流方案。所有参数、方程和数值方法都得到了清晰的定义，构成了一个完整且可解的问题。\n\n解决方案按以下步骤进行：首先，我们对球形域进行离散化并初始化示踪剂场。其次，我们定义计算示踪剂总质量的数值程序。第三，我们实现两种指定的半拉格朗日平流方案。最后，我们进行一个完整旋转周期的时间积分，并计算两种方案的全球质量守恒误差。\n\n**1. 离散化和初始质量计算**\n\n使用均匀的纬度-经度网格对球面进行离散化。纬度域 $\\phi \\in [-\\pi/2, \\pi/2]$ 被划分为 $N_\\phi$ 个宽度为 $\\Delta\\phi = \\pi/N_\\phi$ 的单元。单元中心位于 $\\phi_i = -\\pi/2 + (i+0.5)\\Delta\\phi$，其中 $i=0, \\dots, N_\\phi-1$。经度域 $\\lambda \\in [0, 2\\pi)$ 被划分为 $N_\\lambda$ 个宽度为 $\\Delta\\lambda = 2\\pi/N_\\lambda$ 的单元，中心位于 $\\lambda_j = (j+0.5)\\Delta\\lambda$，其中 $j=0, \\dots, N_\\lambda-1$。\n\n初始示踪剂场 $q(\\lambda, \\phi, 0)$ 是一个由距中心 $(\\lambda_0, \\phi_0)$ 的大圆距离 $\\alpha$ 定义的余弦钟。离散初始场 $q_{i,j}^0$ 通过在单元中心 $(\\phi_i, \\lambda_j)$ 处计算解析函数得到。\n$$\n\\cos \\alpha_{i,j} = \\sin\\phi_i\\,\\sin\\phi_0 + \\cos\\phi_i\\,\\cos\\phi_0\\,\\cos(\\lambda_j-\\lambda_0)\n$$\n$$\nq_{i,j}^0 =\n\\begin{cases}\n\\frac{1}{2}\\left[1+\\cos\\left(\\pi \\frac{\\arccos(\\cos\\alpha_{i,j})}{R}\\right)\\right],  \\arccos(\\cos\\alpha_{i,j}) \\le R,\\\\\n0,  \\text{otherwise}.\n\\end{cases}\n$$\n\n全球总质量 $M(t)$ 通过数值积分近似，即对整个网格上单元中心的示踪剂值与相应单元面积的乘积求和。单元 $(i,j)$ 的面积由下式给出\n$$\nA_i = \\int_{\\lambda_j-\\Delta\\lambda/2}^{\\lambda_j+\\Delta\\lambda/2} \\int_{\\phi_i-\\Delta\\phi/2}^{\\phi_i+\\Delta\\phi/2} \\cos\\phi' \\, d\\phi' \\, d\\lambda' = \\Delta\\lambda \\left( \\sin\\phi_{i+1/2} - \\sin\\phi_{i-1/2} \\right)\n$$\n其中 $\\phi_{i\\pm1/2}$ 是纬度单元的边界。然后，离散的全球总质量计算如下：\n$$\nM = \\sum_{i=0}^{N_\\phi-1} \\sum_{j=0}^{N_\\lambda-1} q_{i,j} A_i\n$$\n初始质量 $M(0)$ 使用 $q_{i,j}^0$ 计算。\n\n**2. 时间积分**\n\n模拟运行的总时长等于一个旋转周期 $T = 2\\pi/\\omega$。这是通过执行 $N = \\lfloor T/\\Delta t \\rfloor$ 个大小为 $\\Delta t$ 的步长，然后执行一个大小为 $\\Delta t_{\\text{last}} = T - N \\Delta t$ 的较小最终步长来精确完成旋转。刚体旋转只影响经度，因此平流更新独立应用于每个纬度圈。\n\n**3. 标准半拉格朗日（SL）方案**\n\n半拉格朗日方法基于示踪剂值 $q$ 沿轨迹线守恒的原理。新时间 $t+\\Delta t$ 时网格点 $(\\lambda_j, \\phi_i)$ 的值是流体质点在时间 $t$ 时其出发点 $(\\lambda_d, \\phi_d)$ 的值。对于角速度为 $\\omega$ 的刚体旋转，轨迹是纯纬向的，因此 $\\phi_d = \\phi_i$，出发经度为 $\\lambda_d = \\lambda_j - \\omega \\Delta t$。\n\n由于 $\\lambda_d$ 通常不与网格点重合，因此必须通过对离散场 $q^n$ 进行插值来获得值 $q(\\lambda_d, \\phi_i, t)$。我们沿经度方向使用线性插值。对于给定的到达点 $\\lambda_j$，我们找到出发经度 $\\lambda_d$ 的两个包围网格点 $k$ 和 $k+1$。新值为：\n$$\nq_{i,j}^{n+1} = (1-w) q_{i,k}^n + w q_{i,k+1}^n\n$$\n其中索引 $k$ 和 $k+1$ 按模 $N_\\lambda$ 周期性处理，而 $w = (\\lambda_d - \\lambda_k)/\\Delta\\lambda$ 是插值权重。该方法计算效率高，但不是形式上守恒的，可能导致示踪剂质量的虚假源或汇。\n\n**4. 守恒重映方案**\n\n该方案是一种有限体积法，它更新单元平均值而非点值，从而确保质量守恒。对于纬向平流，它简化为每个纬度圈上的一维守恒重映。目标单元中的新平均值是通过对相应的上游“出发单元”上的旧场进行积分，然后除以单元面积得到的。\n\n对于示踪剂的分段常数表示，其中 $q_k^n$ 是单元 $k$ 上的平均值，单元 $j$ 中的新平均值为：\n$$\nq_j^{n+1} = \\frac{1}{\\Delta\\lambda} \\int_{\\lambda_j - \\omega\\Delta t - \\Delta\\lambda/2}^{\\lambda_j - \\omega\\Delta t + \\Delta\\lambda/2} q^n(\\lambda') d\\lambda'\n$$\n积分是在出发单元上进行的，这是一个长度为 $\\Delta\\lambda$ 的区间。该区间与旧网格中的一个或多个单元重叠。设库朗数（Courant number）为 $c = \\omega \\Delta t / \\Delta\\lambda$，整数部分为 $I = \\lfloor c \\rfloor$，小数部分为 $\\alpha = c - I$。单元 $j$ 的出发区间与旧单元 $j-I-1$ 和 $j-I$ 重叠。与单元 $j-I-1$ 的重叠分数为 $\\alpha$，与单元 $j-I$ 的重叠分数为 $1-\\alpha$。因此，新的单元平均值是旧平均值的加权和：\n$$\nq_{i,j}^{n+1} = \\alpha q_{i, j-I-1}^n + (1-\\alpha) q_{i, j-I}^n\n$$\n其中索引按模 $N_\\lambda$ 计算。根据构造，该方案保持了每个纬圈上示踪剂值的总和（$\\sum_j q_{i,j}^{n+1} = \\sum_j q_{i,j}^n$），因此在浮点精度范围内，能够精确守恒全球总质量。\n\n**5. 质量误差评估**\n\n经过一个完整旋转后（$t=T$），解析解与初始条件相同，$q(\\lambda, \\phi, T) = q(\\lambda, \\phi, 0)$。每种方案的最终质量 $M_{\\text{std}}$ 和 $M_{\\text{cons}}$ 是根据最终的离散场 $q_{\\text{std}}^N$ 和 $q_{\\text{cons}}^N$ 计算的。然后，有符号的质量误差计算如下：\n$$\nE_{\\text{std}} = M_{\\text{std}} - M(0) \\quad \\text{and} \\quad E_{\\text{cons}} = M_{\\text{cons}} - M(0)\n$$\n正如预期的那样，守恒方案产生的质量误差接近机器精度，而标准的非守恒方案则表现出明显的质量误差。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and evaluates standard and conservative semi-Lagrangian advection\n    for a cosine bell tracer undergoing solid-body rotation on a sphere.\n    \"\"\"\n    test_cases = [\n        # Case 1: (N_lambda, N_phi, omega, dt_nominal, lambda0, phi0, R)\n        (128, 64, 2 * np.pi, 0.0025, 1.3, 0.7, 0.5),\n        # Case 2\n        (32, 16, 2 * np.pi, 0.02, 1.3, 0.7, 0.5),\n        # Case 3\n        (256, 128, 2 * np.pi, 0.0002, 1.3, 0.7, 0.5),\n    ]\n\n    results = []\n    for case in test_cases:\n        N_lambda, N_phi, omega, dt_nominal, lambda0, phi0, R = case\n\n        # --- Grid Setup ---\n        dphi = np.pi / N_phi\n        dlambda = 2 * np.pi / N_lambda\n        phi_centers = -np.pi / 2.0 + (np.arange(N_phi) + 0.5) * dphi\n        lambda_centers = (np.arange(N_lambda) + 0.5) * dlambda\n\n        # --- Initial Condition ---\n        q0 = np.zeros((N_phi, N_lambda))\n        lons_grid, phis_grid = np.meshgrid(lambda_centers, phi_centers)\n        \n        # Great-circle distance calculation\n        # Use np.clip to prevent domain errors with arccos for values near +/-1\n        cos_alpha = np.clip(\n            np.sin(phis_grid) * np.sin(phi0) + np.cos(phis_grid) * np.cos(phi0) * np.cos(lons_grid - lambda0),\n            -1.0, 1.0\n        )\n        alpha = np.arccos(cos_alpha)\n        \n        # Cosine bell tracer\n        mask = alpha = R\n        q0[mask] = 0.5 * (1.0 + np.cos(np.pi * alpha[mask] / R))\n\n        # --- Initial Mass Calculation ---\n        phi_edges = -np.pi / 2.0 + np.arange(N_phi + 1) * dphi\n        cell_areas = dlambda * (np.sin(phi_edges[1:]) - np.sin(phi_edges[:-1]))\n        initial_mass = np.sum(q0 * cell_areas[:, np.newaxis])\n\n        # --- Time Stepping Setup ---\n        T_period = 2.0 * np.pi / omega\n        if dt_nominal > 1e-15:\n            num_steps = int(np.floor(T_period / dt_nominal))\n            dt_last = T_period - num_steps * dt_nominal\n        else: # Handle case of dt_nominal = 0\n            num_steps = 0\n            dt_last = T_period\n        \n        time_steps = [dt_nominal] * num_steps\n        if dt_last > 1e-15:\n            time_steps.append(dt_last)\n\n        # Create copies of the field for each advection method\n        q_std = q0.copy()\n        q_cons = q0.copy()\n        \n        # --- Advection Loop ---\n        indices = np.arange(N_lambda)\n        \n        for dt in time_steps:\n            # --- Standard Semi-Lagrangian Advection (Linear Interpolation) ---\n            shift_in_indices = -omega * dt / dlambda\n            departure_indices_float = indices + shift_in_indices\n            \n            left_indices = np.floor(departure_indices_float).astype(int)\n            weights = departure_indices_float - left_indices\n            \n            left_indices_mod = np.mod(left_indices, N_lambda)\n            right_indices_mod = np.mod(left_indices + 1, N_lambda)\n            \n            # Vectorized update for all latitude rings\n            w_reshaped = weights[np.newaxis, :]\n            q_std = (1.0 - w_reshaped) * q_std[:, left_indices_mod] + w_reshaped * q_std[:, right_indices_mod]\n\n            # --- Conservative Semi-Lagrangian Remapping (Piecewise Constant) ---\n            courant_num = omega * dt / dlambda\n            I = int(np.floor(courant_num))\n            alpha_remap = courant_num - I\n            \n            src_indices1 = np.mod(indices - I - 1, N_lambda)\n            src_indices2 = np.mod(indices - I, N_lambda)\n            \n            # Vectorized update for all latitude rings\n            q_cons = alpha_remap * q_cons[:, src_indices1] + (1.0 - alpha_remap) * q_cons[:, src_indices2]\n\n        # --- Final Mass and Error Calculation ---\n        final_mass_std = np.sum(q_std * cell_areas[:, np.newaxis])\n        final_mass_cons = np.sum(q_cons * cell_areas[:, np.newaxis])\n\n        error_std = final_mass_std - initial_mass\n        error_cons = final_mass_cons - initial_mass\n        \n        results.append(error_std)\n        results.append(error_cons)\n\n    # --- Print Final Result ---\n    # The problem asks for the output to be a list of decimal numbers.\n    # Scientific notation is used to represent these floating-point numbers accurately.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}