{
    "hands_on_practices": [
        {
            "introduction": "In a fully compressible model, the state of the fluid is represented by a vector of conserved variables, such as mass density, momentum density, and total energy density. This exercise  guides you through the essential process of \"decoding\" this state vector to recover the primitive thermodynamic variables of pressure and temperature. This calculation is a fundamental step in model diagnostics and physics coupling, as it requires carefully partitioning the total energy into its internal, kinetic, and gravitational potential components.",
            "id": "4046690",
            "problem": "Consider a single finite-volume cell in a fully compressible atmospheric model advanced with a strictly conservative formulation for mass, momentum, and energy in the presence of gravity. The model stores the conserved variables mass density $\\rho$, momentum density $\\rho \\mathbf{u}$, and total energy density $E$. Gravity is represented by a gravitational potential per unit mass $\\Phi = g z$, where $g$ is the gravitational acceleration and $z$ is the geopotential height. The thermodynamic closure is an ideal-gas model for dry air, with ratio of specific heats $\\gamma$ and specific gas constant $R$.\n\nGiven the following cell-averaged data:\n- $\\rho = 1.18~\\mathrm{kg}\\,\\mathrm{m}^{-3}$,\n- $\\rho \\mathbf{u} = (5.0,\\,-2.0,\\,0.5)~\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$,\n- $E = 2.2987016 \\times 10^{5}~\\mathrm{J}\\,\\mathrm{m}^{-3}$,\n- $g = 9.80665~\\mathrm{m}\\,\\mathrm{s}^{-2}$,\n- $z = 1500~\\mathrm{m}$,\n- $\\gamma = 1.4$,\n- $R = 287~\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$,\n\ncompute the primitive thermodynamic state $(p, T)$ in this cell, where $p$ is the pressure and $T$ is the temperature. Treat the stored energy density $E$ as the total energy per unit volume including internal, kinetic, and gravitational potential contributions. Then assess realizability by verifying the positivity conditions $p>0$ and $T>0$.\n\nExpress $p$ in Pascals and $T$ in Kelvin. Round your final answers to four significant figures. Provide your final numerical answers as a single row matrix $\\left(p ~\\~ T\\right)$.",
            "solution": "The problem statement gives a set of cell-averaged conserved variables from a fully compressible atmospheric model and asks for the corresponding primitive thermodynamic variables, pressure $p$ and temperature $T$. The problem is well-posed, scientifically sound, and contains all necessary information for a unique solution.\n\nThe total energy density $E$ in the presence of gravity is the sum of the internal energy density $\\rho e$, the kinetic energy density $E_k$, and the gravitational potential energy density $E_p$:\n$$E = \\rho e + E_k + E_p$$\nThe kinetic energy density is $E_k = \\frac{1}{2}\\rho \\lVert\\mathbf{u}\\rVert^2$, and the gravitational potential energy density is $E_p = \\rho \\Phi = \\rho g z$. Substituting these into the total energy equation gives:\n$$E = \\rho e + \\frac{1}{2}\\rho \\lVert\\mathbf{u}\\rVert^2 + \\rho g z$$\nThe thermodynamic state is described by the ideal gas law for dry air, $p = \\rho R T$, where $p$ is the pressure, $\\rho$ is the mass density, $R$ is the specific gas constant, and $T$ is the temperature. The specific internal energy $e$ for an ideal gas is a function of temperature only, given by $e = c_v T$, where $c_v$ is the specific heat at constant volume. The constant $c_v$ is related to $R$ and the ratio of specific heats $\\gamma$ by the relation $c_v = \\frac{R}{\\gamma - 1}$.\n\nOur goal is to invert the given conserved state $(\\rho, \\rho\\mathbf{u}, E)$ to find the primitive state $(p, T)$.\n\nFirst, we calculate the kinetic energy density $E_k$. It is most directly calculated from the given momentum density $\\rho \\mathbf{u}$ and mass density $\\rho$ as:\n$$E_k = \\frac{\\lVert\\rho \\mathbf{u}\\rVert^2}{2\\rho}$$\nGiven $\\rho \\mathbf{u} = (5.0, -2.0, 0.5)~\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, the squared magnitude of the momentum density is:\n$$\\lVert\\rho \\mathbf{u}\\rVert^2 = (5.0)^2 + (-2.0)^2 + (0.5)^2 = 25.0 + 4.0 + 0.25 = 29.25~(\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1})^2$$\nWith $\\rho = 1.18~\\mathrm{kg}\\,\\mathrm{m}^{-3}$, the kinetic energy density is:\n$$E_k = \\frac{29.25}{2 \\times 1.18} = \\frac{29.25}{2.36}~\\mathrm{J}\\,\\mathrm{m}^{-3} \\approx 12.394068~\\mathrm{J}\\,\\mathrm{m}^{-3}$$\n\nSecond, we calculate the gravitational potential energy density $E_p$:\n$$E_p = \\rho g z$$\nUsing the provided values $g = 9.80665~\\mathrm{m}\\,\\mathrm{s}^{-2}$ and $z = 1500~\\mathrm{m}$:\n$$E_p = 1.18~\\mathrm{kg}\\,\\mathrm{m}^{-3} \\times 9.80665~\\mathrm{m}\\,\\mathrm{s}^{-2} \\times 1500~\\mathrm{m} = 17357.7705~\\mathrm{J}\\,\\mathrm{m}^{-3}$$\n\nThird, we isolate the internal energy density $\\rho e$ by rearranging the total energy equation:\n$$\\rho e = E - E_k - E_p$$\nSubstituting the value for total energy $E = 2.2987016 \\times 10^{5}~\\mathrm{J}\\,\\mathrm{m}^{-3}$ and our calculated values for $E_k$ and $E_p$:\n$$\\rho e = 229870.16 - 12.394068 - 17357.7705 \\approx 212499.995432~\\mathrm{J}\\,\\mathrm{m}^{-3}$$\n\nFourth, we determine the temperature $T$. The internal energy density is related to temperature by $\\rho e = \\rho c_v T$. First, we compute $c_v$:\n$$c_v = \\frac{R}{\\gamma - 1} = \\frac{287~\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}}{1.4 - 1.0} = \\frac{287}{0.4} = 717.5~\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$$\nNow we solve for $T$:\n$$T = \\frac{\\rho e}{\\rho c_v} = \\frac{212499.995432~\\mathrm{J}\\,\\mathrm{m}^{-3}}{1.18~\\mathrm{kg}\\,\\mathrm{m}^{-3} \\times 717.5~\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}} = \\frac{212499.995432}{846.65}~\\mathrm{K} \\approx 250.99757~\\mathrm{K}$$\n\nFifth, we calculate the pressure $p$ using the ideal gas law:\n$$p = \\rho R T$$\n$$p = 1.18~\\mathrm{kg}\\,\\mathrm{m}^{-3} \\times 287~\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1} \\times 250.99757~\\mathrm{K} \\approx 85003.58~\\mathrm{Pa}$$\n\nThe problem requires rounding the final answers to four significant figures.\nPressure: $p = 85003.58~\\mathrm{Pa} \\to 8.500 \\times 10^4~\\mathrm{Pa}$.\nTemperature: $T = 250.99757~\\mathrm{K} \\to 251.0~\\mathrm{K}$.\n\nFinally, we assess the physical realizability of the computed state. The conditions are $p>0$ and $T>0$. Our results $p \\approx 8.5 \\times 10^4~\\mathrm{Pa}$ and $T \\approx 251~\\mathrm{K}$ are both positive, so the state is realizable.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n8.500 \\times 10^4  251.0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "The principle of conservation is the cornerstone of the discretization schemes discussed in this article. This practice  makes this principle tangible by applying the integral form of the continuity equation to a single finite-volume cell. By calculating the net mass flux across the cell's boundaries, you will determine the instantaneous rate of change of the cell-averaged density, directly illustrating how local fluxes govern the evolution of the system.",
            "id": "4046725",
            "problem": "Consider the fully compressible continuity equation of the Euler system,\n$$\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\boldsymbol{u}) = 0,$$\nand its control-volume form obtained by integrating over a rectangular cell and applying the divergence theorem. Using the Finite Volume Method (FVM) on a single two-dimensional rectangular cell of dimensions $\\Delta x$ by $\\Delta y$ with unit depth in the out-of-plane direction, adopt the outward-unit-normal convention on each face and let $u_{n,f}$ denote the face-normal component of velocity on face $f$ (positive when directed outward). Assume that, at an instant in time, the cell-mean density $\\overline{\\rho}$ and all face-normal velocities are spatially uniform across their respective faces. Derive the semi-discrete evolution equation for $\\partial_t \\overline{\\rho}$ in terms of the outward face-normal mass fluxes and then evaluate it for the following data:\n- Cell dimensions: $\\Delta x = 1000\\ \\mathrm{m}$ and $\\Delta y = 500\\ \\mathrm{m}$.\n- Cell-mean density: $\\overline{\\rho} = 1.2\\ \\mathrm{kg}\\ \\mathrm{m}^{-3}$.\n- Outward face-normal velocities on the east, west, north, and south faces, respectively: $u_{n,E} = +10\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,W} = -5\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,N} = +2\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,S} = -4\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\nHere, the face lengths are $A_E = A_W = \\Delta y$ and $A_N = A_S = \\Delta x$ for the east/west and north/south faces, respectively. First compute the net outward mass flux across the cell boundary at this instant, and then compute the resultant instantaneous rate of change of the cell-mean density $\\partial_t \\overline{\\rho}$. Round your final answer for $\\partial_t \\overline{\\rho}$ to four significant figures and express it in $\\mathrm{kg}\\ \\mathrm{m}^{-3}\\ \\mathrm{s}^{-1}$.",
            "solution": "The starting point is the continuity equation in its differential form:\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot (\\rho \\boldsymbol{u}) = 0\n$$\nwhere $\\rho$ is the fluid density and $\\boldsymbol{u}$ is the velocity vector. For a finite volume method, this equation is integrated over a control volume $V$, which in this case is a two-dimensional rectangular cell with volume $V = \\Delta x \\Delta y \\cdot 1$.\n$$\n\\int_V \\frac{\\partial \\rho}{\\partial t} \\,dV + \\int_V \\nabla \\cdot (\\rho \\boldsymbol{u}) \\,dV = 0\n$$\nApplying the divergence theorem to the second term transforms the volume integral of the divergence into a surface integral of the flux over the boundary $S$ of the volume $V$:\n$$\n\\int_V \\nabla \\cdot (\\rho \\boldsymbol{u}) \\,dV = \\oint_S (\\rho \\boldsymbol{u}) \\cdot \\boldsymbol{n} \\,dS\n$$\nwhere $\\boldsymbol{n}$ is the outward-pointing unit normal vector on the surface $S$.\n\nThe cell-mean density $\\overline{\\rho}$ is defined as the total mass in the cell divided by the cell volume:\n$$\n\\overline{\\rho} = \\frac{1}{V} \\int_V \\rho \\,dV\n$$\nAssuming the control volume $V$ is fixed in time, the time derivative can be moved outside the integral:\n$$\n\\int_V \\frac{\\partial \\rho}{\\partial t} \\,dV = \\frac{d}{dt} \\int_V \\rho \\,dV = \\frac{d}{dt} (\\overline{\\rho} V) = V \\frac{d\\overline{\\rho}}{dt}\n$$\nSubstituting these results back into the integrated continuity equation gives the exact balance law for the control volume:\n$$\nV \\frac{d\\overline{\\rho}}{dt} + \\oint_S (\\rho \\boldsymbol{u}) \\cdot \\boldsymbol{n} \\,dS = 0\n$$\nThis equation states that the rate of change of mass within the volume is equal to the net mass flux into the volume.\n\nThe surface integral is discretized by summing the fluxes over the four faces of the rectangular cell: East ($E$), West ($W$), North ($N$), and South ($S$).\n$$\n\\oint_S (\\rho \\boldsymbol{u}) \\cdot \\boldsymbol{n} \\,dS = \\sum_{f \\in \\{E,W,N,S\\}} \\int_{A_f} (\\rho \\boldsymbol{u}) \\cdot \\boldsymbol{n}_f \\,dS_f\n$$\nThe problem defines $u_{n,f} = \\boldsymbol{u} \\cdot \\boldsymbol{n}_f$ as the outward-normal velocity on face $f$, which is assumed uniform across that face. The flux through face $f$ is thus $\\int_{A_f} \\rho u_{n,f} \\,dS_f = u_{n,f} \\int_{A_f} \\rho \\,dS_f$. A simple, first-order approximation for the density on the face is to use the cell-mean density, $\\overline{\\rho}$. With this, the flux through face $f$ is approximated as $\\overline{\\rho} u_{n,f} A_f$, where $A_f$ is the area of the face.\n\nThe semi-discrete equation for the cell-mean density becomes:\n$$\nV \\frac{\\partial \\overline{\\rho}}{\\partial t} \\approx - \\sum_{f \\in \\{E,W,N,S\\}} \\overline{\\rho} u_{n,f} A_f\n$$\n$$\n\\frac{\\partial \\overline{\\rho}}{\\partial t} \\approx -\\frac{\\overline{\\rho}}{V} \\sum_{f \\in \\{E,W,N,S\\}} u_{n,f} A_f\n$$\nThe term $\\Phi_{net} = \\overline{\\rho} \\sum u_{n,f} A_f$ is the net outward mass flux.\n\nWe are given the following data:\n- Cell dimensions: $\\Delta x = 1000\\ \\mathrm{m}$ and $\\Delta y = 500\\ \\mathrm{m}$.\n- Cell-mean density: $\\overline{\\rho} = 1.2\\ \\mathrm{kg}\\ \\mathrm{m}^{-3}$.\n- Outward face-normal velocities: $u_{n,E} = +10\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,W} = -5\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,N} = +2\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$, $u_{n,S} = -4\\ \\mathrm{m}\\ \\mathrm{s}^{-1}$.\n\nThe face areas and cell volume are (for unit depth):\n- $A_E = A_W = \\Delta y \\times 1 = 500\\ \\mathrm{m}^2$.\n- $A_N = A_S = \\Delta x \\times 1 = 1000\\ \\mathrm{m}^2$.\n- $V = \\Delta x \\times \\Delta y \\times 1 = 1000\\ \\mathrm{m} \\times 500\\ \\mathrm{m} = 5 \\times 10^5\\ \\mathrm{m}^3$.\n\nFirst, we compute the net outward mass flux, $\\Phi_{net}$:\n$$\n\\Phi_{net} = \\overline{\\rho} (u_{n,E}A_E + u_{n,W}A_W + u_{n,N}A_N + u_{n,S}A_S)\n$$\nSubstituting the values:\n$$\n\\Phi_{net} = (1.2\\ \\mathrm{kg}\\ \\mathrm{m}^{-3}) [(10\\ \\mathrm{m}\\ \\mathrm{s}^{-1})(500\\ \\mathrm{m}^2) + (-5\\ \\mathrm{m}\\ \\mathrm{s}^{-1})(500\\ \\mathrm{m}^2) + (2\\ \\mathrm{m}\\ \\mathrm{s}^{-1})(1000\\ \\mathrm{m}^2) + (-4\\ \\mathrm{m}\\ \\mathrm{s}^{-1})(1000\\ \\mathrm{m}^2)]\n$$\n$$\n\\Phi_{net} = 1.2 \\times [5000 - 2500 + 2000 - 4000] \\ \\mathrm{kg}\\ \\mathrm{s}^{-1}\n$$\n$$\n\\Phi_{net} = 1.2 \\times [500] \\ \\mathrm{kg}\\ \\mathrm{s}^{-1} = 600\\ \\mathrm{kg}\\ \\mathrm{s}^{-1}\n$$\nThe net outward mass flux is $600\\ \\mathrm{kg}\\ \\mathrm{s}^{-1}$.\n\nNext, we compute the instantaneous rate of change of the cell-mean density, $\\partial_t \\overline{\\rho}$:\n$$\n\\frac{\\partial \\overline{\\rho}}{\\partial t} = -\\frac{\\Phi_{net}}{V}\n$$\n$$\n\\frac{\\partial \\overline{\\rho}}{\\partial t} = -\\frac{600\\ \\mathrm{kg}\\ \\mathrm{s}^{-1}}{5 \\times 10^5\\ \\mathrm{m}^3} = -0.0012\\ \\mathrm{kg}\\ \\mathrm{m}^{-3}\\ \\mathrm{s}^{-1}\n$$\nThe problem requires this answer to be rounded to four significant figures. The exact answer is $-0.0012$. Expressed with four significant figures, this becomes $-0.001200$. In standard scientific notation, this is $-1.200 \\times 10^{-3}$.",
            "answer": "$$\n\\boxed{-1.200 \\times 10^{-3}}\n$$"
        },
        {
            "introduction": "While ensuring conservation is necessary, it is not always sufficient for a robust numerical scheme, especially in geophysical applications. This advanced practice  tackles the critical challenge of accurately representing the hydrostatic balance over complex terrain. You will compare a naive discretization of the pressure gradient force with a sophisticated \"well-balanced\" formulation, quantifying the dramatic reduction in spurious numerical error and appreciating why such methods are vital for realistic atmospheric simulation.",
            "id": "4046693",
            "problem": "Consider a two-dimensional, dry, fully compressible atmosphere in hydrostatic equilibrium over terrain represented by a bottom boundary elevation that varies with horizontal position. The fluid is at rest and the hydrostatic balance is given by the fundamental law $dp/dz = - \\rho g$, where $p$ is pressure in $\\mathrm{Pa}$, $\\rho$ is density in $\\mathrm{kg\\,m^{-3}}$, $z$ is geometric height in $\\mathrm{m}$, and $g$ is gravitational acceleration in $\\mathrm{m\\,s^{-2}}$. Assume an isothermal ideal gas with constant temperature $T$ and gas constant $R$, so that $p(z) = p_0 \\exp(-z/H)$ and $\\rho(z) = \\rho_0 \\exp(-z/H)$, where $H = RT/g$ is the pressure scale height, $p_0$ is the sea-level pressure, and $\\rho_0 = p_0/(RT)$ is the sea-level density. The horizontal domain is periodic in the $x$ direction with length $L_x$.\n\nLet the terrain-following vertical coordinate be defined by $\\sigma \\in [0,1]$ with a mapping to geometric height\n$$\nz(x,\\sigma) = z_b(x) + \\sigma \\left( z_\\mathrm{top} - z_b(x) \\right),\n$$\nwhere $z_b(x)$ is the bottom boundary elevation and $z_\\mathrm{top}$ is the constant top height. The bottom is given by a cosine hill\n$$\nz_b(x) = A \\cos\\!\\left( \\frac{2\\pi x}{L_x} \\right),\n$$\nwith amplitude $A$ in $\\mathrm{m}$. The computational grid consists of $N_x$ uniformly spaced horizontal points $x_i = i \\Delta x$ for $i \\in \\{0,\\dots,N_x-1\\}$ with $\\Delta x = L_x/N_x$, and $N_z$ uniformly spaced full levels in $\\sigma$, $\\sigma_j = (j + 1/2)/N_z$ for $j \\in \\{0,\\dots,N_z-1\\}$.\n\nDefine the discrete hydrostatic base state by sampling $p$ and $\\rho$ at the grid points: $p_{i,j} = p\\!\\left( z(x_i,\\sigma_j) \\right)$ and $\\rho_{i,j} = \\rho\\!\\left( z(x_i,\\sigma_j) \\right)$. Consider the discrete horizontal acceleration due to the Pressure Gradient Force (PGF), which in physical coordinates is $a_x = -\\frac{1}{\\rho} \\frac{\\partial p}{\\partial x}$.\n\nYour task is to compute, for each of the following test cases, the maximum-norm residual acceleration $R$ in $\\mathrm{m\\,s^{-2}}$ over the grid for two different discrete formulations:\n\n1. A naive, non-well-balanced formulation that approximates the PGF at constant $\\sigma$ using a centered finite difference,\n$$\na_{x,\\mathrm{naive}}(i,j) = -\\frac{1}{\\rho_{i,j}} \\cdot \\frac{p_{i+1,j} - p_{i-1,j}}{2\\Delta x},\n$$\nwith periodic indexing in $i$. The residual $R_\\mathrm{naive}$ is defined as\n$$\nR_\\mathrm{naive} = \\max_{i,j} \\left| a_{x,\\mathrm{naive}}(i,j) \\right|.\n$$\n\n2. A well-balanced, height-interpolated formulation that approximates the PGF at constant geometric height. For each $(i,j)$, let $z_{i,j} = z(x_i,\\sigma_j)$. Construct linear interpolants of the profiles $p$ as functions of $z$ in columns $i-1$ and $i+1$ from the sampled pairs $\\{(z_{k}, p_{k})\\}$ for those columns. Evaluate these interpolants at the target height $z_{i,j}$ to obtain $p_{i-1 \\rightarrow i}(z_{i,j})$ and $p_{i+1 \\rightarrow i}(z_{i,j})$, i.e., the pressures in columns $i-1$ and $i+1$ mapped to the height $z_{i,j}$ by linear interpolation in $z$. Allow linear extrapolation when $z_{i,j}$ lies outside the sampled range in a neighboring column. Then define\n$$\na_{x,\\mathrm{wb}}(i,j) = -\\frac{1}{\\rho_{i,j}} \\cdot \\frac{p_{i+1 \\rightarrow i}(z_{i,j}) - p_{i-1 \\rightarrow i}(z_{i,j})}{2\\Delta x},\n$$\nand\n$$\nR_\\mathrm{wb} = \\max_{i,j} \\left| a_{x,\\mathrm{wb}}(i,j) \\right|.\n$$\n\nFor each test case, compute the error-reduction factor\n$$\n\\mathcal{Q} = \n\\begin{cases}\nR_\\mathrm{naive} / R_\\mathrm{wb},  \\text{if } R_\\mathrm{wb} > 0,\\\\\n1.0,  \\text{if } R_\\mathrm{wb} = 0,\n\\end{cases}\n$$\nas a dimensionless float.\n\nAll physical constants and parameters must be used in International System of Units (SI units). Use $g = 9.81\\,\\mathrm{m\\,s^{-2}}$, $R = 287\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $T = 280\\,\\mathrm{K}$, $p_0 = 10^5\\,\\mathrm{Pa}$. The top is at $z_\\mathrm{top} = 12000\\,\\mathrm{m}$. The following test suite specifies the remaining parameters for four cases:\n- Case 1 (flat terrain baseline): $L_x = 100000\\,\\mathrm{m}$, $N_x = 64$, $N_z = 40$, $A = 0\\,\\mathrm{m}$.\n- Case 2 (moderate slope): $L_x = 100000\\,\\mathrm{m}$, $N_x = 64$, $N_z = 40$, $A = 1000\\,\\mathrm{m}$.\n- Case 3 (steeper terrain, coarser vertical grid): $L_x = 50000\\,\\mathrm{m}$, $N_x = 64$, $N_z = 20$, $A = 2000\\,\\mathrm{m}$.\n- Case 4 (steeper terrain, finer vertical grid): $L_x = 50000\\,\\mathrm{m}$, $N_x = 64$, $N_z = 80$, $A = 2000\\,\\mathrm{m}$.\n\nYour program must compute, for each case, the triple $(R_\\mathrm{naive}, R_\\mathrm{wb}, \\mathcal{Q})$ with $R_\\mathrm{naive}$ and $R_\\mathrm{wb}$ in $\\mathrm{m\\,s^{-2}}$ and $\\mathcal{Q}$ dimensionless, and then print a single line containing all twelve results as a comma-separated list of floats enclosed in square brackets, ordered by cases and within each case ordered as $(R_\\mathrm{naive}, R_\\mathrm{wb}, \\mathcal{Q})$. Each float must be rounded to six significant digits. For example, the output format must be\n$[r_{1,\\mathrm{naive}},r_{1,\\mathrm{wb}},q_1,r_{2,\\mathrm{naive}},r_{2,\\mathrm{wb}},q_2,r_{3,\\mathrm{naive}},r_{3,\\mathrm{wb}},q_3,r_{4,\\mathrm{naive}},r_{4,\\mathrm{wb}},q_4]$,\nwhere each $r$ is in $\\mathrm{m\\,s^{-2}}$ and each $q$ is dimensionless, all as decimal floats.",
            "solution": "The central challenge of this problem is to quantify the numerical error arising from the computation of the horizontal Pressure Gradient Force (PGF) in a terrain-following coordinate system and to demonstrate the superior accuracy of a well-balanced discretization scheme over a naive one. The physical scenario is an atmosphere at rest in perfect hydrostatic equilibrium, where the true horizontal acceleration is exactly zero. Any non-zero acceleration computed by a numerical scheme is therefore purely a result of discretization error.\n\nThe continuous horizontal PGF in the $x$-direction is given by\n$$\na_x = -\\frac{1}{\\rho} \\frac{\\partial p}{\\partial x}\n$$\nIn a hydrostatic atmosphere at rest, pressure $p$ is solely a function of geometric height $z$, i.e., $p = p(z)$. Consequently, the partial derivative of pressure with respect to the horizontal coordinate $x$ at a constant height $z$ is zero:\n$$\n\\left( \\frac{\\partial p}{\\partial x} \\right)_z = 0\n$$\nThis implies that the true horizontal acceleration $a_x$ is identically zero everywhere. The problem, therefore, asks for the computation of spurious, numerically-generated accelerations.\n\nFirst, we establish the computational domain and the physical state. The physical constants are gravitational acceleration $g = 9.81\\,\\mathrm{m\\,s^{-2}}$, the specific gas constant for dry air $R = 287\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, the constant temperature $T = 280\\,\\mathrm{K}$, and the sea-level pressure $p_0 = 10^5\\,\\mathrm{Pa}$. From these, we derive the pressure scale height $H = RT/g$ and the sea-level density $\\rho_0 = p_0/(RT)$. The hydrostatic pressure and density profiles are given by the exponential functions:\n$$\np(z) = p_0 \\exp(-z/H)\n$$\n$$\n\\rho(z) = \\rho_0 \\exp(-z/H)\n$$\nThe computational grid is defined over a horizontal domain of length $L_x$ and a vertical domain extending to height $z_\\mathrm{top} = 12000\\,\\mathrm{m}$. The horizontal grid has $N_x$ points $x_i = i \\Delta x$ for $i \\in \\{0, \\dots, N_x-1\\}$, where $\\Delta x = L_x/N_x$. The vertical direction is discretized using a terrain-following coordinate $\\sigma \\in [0,1]$ with $N_z$ levels located at $\\sigma_j = (j + 0.5)/N_z$ for $j \\in \\{0, \\dots, N_z-1\\}$. The geometric height $z$ at each grid point $(i,j)$ is determined by the mapping:\n$$\nz(x_i, \\sigma_j) = z_b(x_i) + \\sigma_j (z_\\mathrm{top} - z_b(x_i))\n$$\nwhere the terrain height $z_b(x)$ is given by a cosine hill with amplitude $A$:\n$$\nz_b(x_i) = A \\cos\\left( \\frac{2\\pi x_i}{L_x} \\right)\n$$\nUsing this grid of $z_{i,j}$ values, we sample the continuous pressure and density fields to obtain the discrete base state arrays $p_{i,j} = p(z_{i,j})$ and $\\rho_{i,j} = \\rho(z_{i,j})$.\n\nThe core of the task is to compute the maximum residual acceleration for two different PGF formulations.\n\n1.  **Naive, Non-Well-Balanced Formulation**\n    This method approximates the pressure gradient at constant $\\sigma$-levels. The partial derivative $(\\partial p / \\partial x)$ is approximated using a centered finite difference along the grid lines of constant $j$:\n    $$\n    a_{x,\\mathrm{naive}}(i,j) = -\\frac{1}{\\rho_{i,j}} \\cdot \\frac{p_{i+1,j} - p_{i-1,j}}{2\\Delta x}\n    $$\n    The horizontal indices $i+1$ and $i-1$ are handled periodically. When the terrain is not flat ($A > 0$), a surface of constant $\\sigma_j$ is not a surface of constant geometric height $z$. Therefore, $z_{i+1,j} \\neq z_{i-1,j}$, leading to $p_{i+1,j} \\neq p_{i-1,j}$. This results in a non-zero, spurious PGF, which is a well-known source of error in terrain-following models. The residual is the maximum absolute value of this spurious acceleration over the entire grid: $R_\\mathrm{naive} = \\max_{i,j} |a_{x,\\mathrm{naive}}(i,j)|$.\n\n2.  **Well-Balanced, Height-Interpolated Formulation**\n    This method is designed to be \"well-balanced\", meaning it can exactly or with high accuracy balance the PGF and gravity terms to maintain a state of rest. It correctly approximates the PGF on a constant geometric height surface, $(\\partial p / \\partial x)_z$. To do this at a grid point $(i,j)$, we must estimate the pressures in the neighboring columns $i-1$ and $i+1$ at the same geometric height as the point $(i,j)$, which is $z_{i,j} = z(x_i, \\sigma_j)$.\n    The procedure is as follows:\n    -   For each grid point $(i,j)$, identify the target height $z_{i,j}$.\n    -   In the neighboring columns $i-1$ and $i+1$ (with periodic indexing), we have the discrete vertical profiles of pressure versus height, i.e., the sets of pairs $\\{ (z_{i-1,k}, p_{i-1,k}) \\}_{k=0}^{N_z-1}$ and $\\{ (z_{i+1,k}, p_{i+1,k}) \\}_{k=0}^{N_z-1}$.\n    -   We construct a linear interpolant for pressure as a function of height for each of these neighboring columns. Since the target height $z_{i,j}$ may lie outside the range of heights in a neighboring column (e.g., a point deep in a valley next to a high mountain), linear extrapolation is permitted as specified. We use SciPy's `interp1d` function with `fill_value='extrapolate'` for this purpose.\n    -   We evaluate these two interpolants at the target height $z_{i,j}$ to obtain the horizontally-mapped pressures, $p_{i-1 \\rightarrow i}(z_{i,j})$ and $p_{i+1 \\rightarrow i}(z_{i,j})$.\n    -   The well-balanced PGF is then computed as:\n    $$\n    a_{x,\\mathrm{wb}}(i,j) = -\\frac{1}{\\rho_{i,j}} \\cdot \\frac{p_{i+1 \\rightarrow i}(z_{i,j}) - p_{i-1 \\rightarrow i}(z_{i,j})}{2\\Delta x}\n    $$\n    The residual error for this scheme, $R_\\mathrm{wb} = \\max_{i,j} |a_{x,\\mathrm{wb}}(i,j)|$, arises from the inaccuracy of the linear interpolation of the exponential pressure profile. This error is expected to be much smaller than the error of the naive scheme.\n\nFinally, for each test case, we compute the error-reduction factor $\\mathcal{Q}$:\n$$\n\\mathcal{Q} = \n\\begin{cases}\nR_\\mathrm{naive} / R_\\mathrm{wb},  \\text{if } R_\\mathrm{wb} > 0,\\\\\n1.0,  \\text{if } R_\\mathrm{wb} = 0,\n\\end{cases}\n$$\nThis factor quantifies the improvement gained by using the well-balanced formulation. The entire procedure is implemented for the four specified test cases, and the results are formatted to six significant digits.",
            "answer": "```python\nimport numpy as np\nfrom scipy.interpolate import interp1d\n\ndef solve():\n    \"\"\"\n    Computes the residual pressure gradient force accelerations for naive and\n    well-balanced schemes in a terrain-following coordinate system.\n    \"\"\"\n\n    # Physical constants (SI units)\n    g = 9.81  # m/s^2\n    R_gas = 287.0  # J/(kg*K)\n    T = 280.0  # K\n    p0 = 1.0e5  # Pa\n    z_top = 12000.0  # m\n\n    # Derived constants\n    H = R_gas * T / g  # Pressure scale height\n    rho0 = p0 / (R_gas * T)  # Sea-level density\n\n    # Analytical hydrostatic profiles\n    def p_func(z):\n        return p0 * np.exp(-z / H)\n\n    def rho_func(z):\n        return rho0 * np.exp(-z / H)\n\n    # Test case parameters\n    test_cases = [\n        # (Lx, Nx, Nz, A)\n        (100000.0, 64, 40, 0.0),    # Case 1: Flat terrain\n        (100000.0, 64, 40, 1000.0), # Case 2: Moderate slope\n        (50000.0, 64, 20, 2000.0),  # Case 3: Steeper, coarser grid\n        (50000.0, 64, 80, 2000.0),  # Case 4: Steeper, finer grid\n    ]\n\n    all_results = []\n    \n    for Lx, Nx, Nz, A in test_cases:\n        # 1. Setup Grids\n        dx = Lx / Nx\n        x_i = np.arange(Nx) * dx\n        sigma_j = (np.arange(Nz) + 0.5) / Nz\n\n        # 2. Compute Geometric Heights z(x, sigma)\n        zb_i = A * np.cos(2 * np.pi * x_i / Lx)\n        # Reshape for broadcasting: zb_i (Nx,1), sigma_j (1,Nz)\n        z_grid = zb_i[:, np.newaxis] + sigma_j[np.newaxis, :] * (z_top - zb_i[:, np.newaxis])\n\n        # 3. Sample Hydrostatic State on the Grid\n        p_grid = p_func(z_grid)\n        rho_grid = rho_func(z_grid)\n\n        # 4. Compute Naive PGF Residual (R_naive)\n        p_i_plus_1 = np.roll(p_grid, -1, axis=0)\n        p_i_minus_1 = np.roll(p_grid, 1, axis=0)\n        \n        a_naive = - (1.0 / rho_grid) * (p_i_plus_1 - p_i_minus_1) / (2.0 * dx)\n        R_naive = np.max(np.abs(a_naive))\n\n        # 5. Compute Well-Balanced PGF Residual (R_wb)\n        a_wb = np.zeros_like(p_grid)\n        for i in range(Nx):\n            i_prev = (i - 1 + Nx) % Nx\n            i_next = (i + 1) % Nx\n            \n            # Get neighbor column profiles (z and p)\n            # z-profiles are guaranteed to be monotonic, so sorting is not needed.\n            z_prev_col = z_grid[i_prev, :]\n            p_prev_col = p_grid[i_prev, :]\n            z_next_col = z_grid[i_next, :]\n            p_next_col = p_grid[i_next, :]\n\n            # Create linear interpolators with linear extrapolation\n            interp_prev = interp1d(z_prev_col, p_prev_col, kind='linear', fill_value='extrapolate', assume_sorted=True)\n            interp_next = interp1d(z_next_col, p_next_col, kind='linear', fill_value='extrapolate', assume_sorted=True)\n            \n            for j in range(Nz):\n                z_target = z_grid[i, j]\n                \n                # Interpolate neighbor pressures to target height\n                p_interp_prev = interp_prev(z_target)\n                p_interp_next = interp_next(z_target)\n                \n                a_wb[i, j] = - (1.0 / rho_grid[i, j]) * (p_interp_next - p_interp_prev) / (2.0 * dx)\n\n        R_wb = np.max(np.abs(a_wb))\n\n        # 6. Compute Error Reduction Factor (Q)\n        if R_wb > 0:\n            Q = R_naive / R_wb\n        else:\n            Q = 1.0\n\n        all_results.extend([R_naive, R_wb, Q])\n\n    # 7. Format and print output\n    # Format each float to 6 significant digits as a string\n    formatted_results = [f\"{v:.6g}\" for v in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}