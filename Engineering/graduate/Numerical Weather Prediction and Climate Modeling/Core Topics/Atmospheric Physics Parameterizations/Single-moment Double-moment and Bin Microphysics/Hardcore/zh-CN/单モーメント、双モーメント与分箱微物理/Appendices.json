{
    "hands_on_practices": [
        {
            "introduction": "宏观微物理方案建立在对粒子谱分布（PSD）的假设数学形式之上，例如伽马分布。推导该分布的矩是一项基本技能，它使我们能够将抽象的分布参数（$N_0$、$\\mu$、$\\Lambda$）与具有物理意义的宏观量（如总数浓度或总质量）联系起来。本练习  将指导您完成这一关键的数学推导。",
            "id": "4089390",
            "problem": "在用于数值天气预报和气候模拟的整体云微物理参数化方案中，一种水凝物种类的滴谱分布（DSD）由广义伽马形式 $n(D)=N_0 D^{\\mu} \\exp(-\\Lambda D)$ 表示，其中 $D$ 是粒子直径，$N_0$ 是截距参数，$\\mu$ 是形状参数，$\\Lambda$ 是斜率参数。在单矩方案中，使用对分布的一个预报约束（例如，质量混合比矩）来诊断其他参数；在双矩方案中，使用两个独立的预报约束来诊断剩余的参数；在分档方案中，直接解析分布，而不假设其参数化形式。\n\n从分布矩的基本定义出发，推导DSD的 $k$ 阶矩 $M_k$ 关于 $N_0$、$\\mu$ 和 $\\Lambda$ 的闭合形式解析表达式，并说明为使 $M_k$ 存在且有限所需的参数约束。你的最终答案必须是 $M_k$ 的单一闭合形式解析表达式。不需要数值近似，最终表达式中也不应包含任何单位。",
            "solution": "该问题陈述经评估有效。它在科学上植根于成熟的云微物理理论，问题适定、客观，并包含了进行形式推导所需的所有必要信息。任务是推导指定粒子谱分布的 $k$ 阶矩，这是一个标准且可验证的数学过程。\n\n粒子谱分布 $n(D)$ 的 $k$ 阶矩 $M_k$ 定义为 $D^k$ 与分布函数加权后，在整个粒子直径 $D$ 范围内的积分。直径 $D$ 是一个物理量，必须为非负值。因此，积分域为从 $0$ 到 $\\infty$。其定义为：\n$$\nM_k = \\int_{0}^{\\infty} D^k n(D) \\, dD\n$$\n问题提供的滴谱分布（DSD）为广义伽马函数：\n$$\nn(D) = N_0 D^{\\mu} \\exp(-\\Lambda D)\n$$\n将此 $n(D)$ 的表达式代入 $k$ 阶矩的定义中，得到：\n$$\nM_k = \\int_{0}^{\\infty} D^k \\left( N_0 D^{\\mu} \\exp(-\\Lambda D) \\right) \\, dD\n$$\n我们可以合并包含直径 $D$ 的项，并将常数截距参数 $N_0$ 移到积分号外：\n$$\nM_k = N_0 \\int_{0}^{\\infty} D^{k+\\mu} \\exp(-\\Lambda D) \\, dD\n$$\n该积分的形式与定义伽马函数 $\\Gamma(z)$ 的第二类欧拉积分密切相关：\n$$\n\\Gamma(z) = \\int_{0}^{\\infty} t^{z-1} \\exp(-t) \\, dt\n$$\n为了将我们的积分转换为这种标准形式，我们进行变量代换。令 $t = \\Lambda D$。这意味着 $D = \\frac{t}{\\Lambda}$。微分元 $dD$ 变为 $dD = \\frac{1}{\\Lambda} dt$。在 $\\Lambda>0$ 的条件下，积分上下限在此变换下保持不变。若 $D=0$，则 $t=0$。当 $D \\to \\infty$ 时，则 $t \\to \\infty$。\n\n将这些代入 $M_k$ 的表达式中：\n$$\nM_k = N_0 \\int_{0}^{\\infty} \\left(\\frac{t}{\\Lambda}\\right)^{k+\\mu} \\exp(-t) \\left(\\frac{1}{\\Lambda} dt\\right)\n$$\n我们可以将包含 $t$ 的项与包含 $\\Lambda$ 的常数项分开：\n$$\nM_k = N_0 \\int_{0}^{\\infty} \\frac{t^{k+\\mu}}{\\Lambda^{k+\\mu}} \\exp(-t) \\frac{1}{\\Lambda} dt\n$$\n依赖于 $\\Lambda$ 的项相对于积分变量 $t$ 是常数，可以移到积分号外：\n$$\nM_k = \\frac{N_0}{\\Lambda^{k+\\mu} \\Lambda^1} \\int_{0}^{\\infty} t^{k+\\mu} \\exp(-t) dt\n$$\n$$\nM_k = \\frac{N_0}{\\Lambda^{k+\\mu+1}} \\int_{0}^{\\infty} t^{k+\\mu} \\exp(-t) dt\n$$\n剩下的积分现在是伽马函数的形式。通过将 $\\int_{0}^{\\infty} t^{k+\\mu} \\exp(-t) dt$ 与定义式 $\\Gamma(z) = \\int_{0}^{\\infty} t^{z-1} \\exp(-t) \\, dt$ 进行比较，我们可以通过令 $t$ 的指数相等来确定伽马函数的自变量：\n$$\nz-1 = k+\\mu \\implies z = k+\\mu+1\n$$\n因此，该积分的计算结果为 $\\Gamma(k+\\mu+1)$。将此结果代回我们对 $M_k$ 的表达式中，我们便得到了闭合形式的解析表达式：\n$$\nM_k = N_0 \\frac{\\Gamma(k+\\mu+1)}{\\Lambda^{k+\\mu+1}}\n$$\n为了使此表达式有效且有限，必须对参数施加某些约束。\n1.  伽马函数 $\\Gamma(z)$ 的积分仅当其自变量的实部为正时才收敛。在我们的情况中，$z = k+\\mu+1$。由于 $k$ 和 $\\mu$ 是实数参数，这要求：\n    $$\n    k+\\mu+1 > 0\n    $$\n2.  变量代换 $t = \\Lambda D$ 要求斜率参数 $\\Lambda$ 严格为正，即 $\\Lambda > 0$。如果 $\\Lambda=0$，指数项变为 $\\exp(0)=1$，积分 $\\int_0^\\infty D^{k+\\mu} dD$ 将在上限处发散（除非 $k+\\mu  -1$，但这种情况下通常会在下限处发散）。如果 $\\Lambda0$，指数项会随着 $D \\to \\infty$ 无界增长，导致积分发散。\n3.  截距参数 $N_0$ 代表数密度浓度，必须为非负。对于一个非平凡分布，我们要求 $N_0 > 0$。\n4.  一个基本的物理约束是，粒子总数，即零阶矩 $M_0$（即 $k=0$ 时），必须是有限的。对 $k=0$ 应用第一个约束，我们得到 $\\mu+1 > 0$，即 $\\mu > -1$。这确保了分布是可归一化的。\n\n总而言之，为使 $k$ 阶矩存在且有限，必要的参数约束是 $\\Lambda > 0$，$N_0 \\ge 0$ 和 $k+\\mu+1 > 0$。",
            "answer": "$$\n\\boxed{N_0 \\frac{\\Gamma(k+\\mu+1)}{\\Lambda^{k+\\mu+1}}}\n$$"
        },
        {
            "introduction": "模式如何表征降水的起始（自动转化过程）在很大程度上取决于其微物理方案的复杂性。较简单的单矩方案仅使用质量信息，而更先进的双矩方案则同时包含了数浓度信息，从而导致不同的模式行为。本练习  对这两种方法进行了直接的定量比较，揭示了它们在特定大气条件下不同的敏感性。",
            "id": "4089348",
            "problem": "在数值天气预报 (NWP) 中使用的暖雨块体微物理学中，自动转化过程通过云滴之间的碰并，将云水混合比转化为雨水混合比。在单矩方案中（例如，Kessler 参数化方案），自动转化趋势仅取决于云水混合比，而在双矩方案中（例如，Khairoutdinov–Kogan 公式），它同时取决于云水混合比和云滴数浓度。\n\n从 Smoluchowski 凝聚框架和滴谱分布矩的定义出发，自动转化可以表示为对块体矩的幂律依赖关系。云水混合比为 $q_c$（单位质量湿空气中的液态水质量），云滴数浓度为 $N_c$（单位体积空气中的云滴数量）。在根据详细的分档微物理和大涡模拟 (LES) 校准的经验约束双矩公式中，自动转化趋势 $P_{\\mathrm{KK}}$（从云到雨的质量混合比转化率）可以用幂律表示\n$$\nP_{\\mathrm{KK}} = C_{\\mathrm{KK}}\\,q_c^{\\alpha}\\,N_c^{\\beta},\n$$\n其中 $\\alpha$ 和 $\\beta$ 是反映对分布的质量矩和数量矩依赖性的经验指数。在本问题中，使用 Khairoutdinov–Kogan (KK) 指数 $\\alpha=2.47$ 和 $\\beta=-1.79$，以及系数 $C_{\\mathrm{KK}}=1.35\\times 10^{3}$，其中 $q_c$ 以 $\\mathrm{kg\\,kg^{-1}}$ 表示，$N_c$ 以 $\\mathrm{cm^{-3}}$ 表示，$P_{\\mathrm{KK}}$ 以 $\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$ 为单位返回。\n\n为了进行比较，考虑由下式定义的 Kessler 单矩阈值方案\n$$\nP_{\\mathrm{Kessler}} =\n\\begin{cases}\nC_{\\mathrm{K}}\\,(q_c - q_0),  q_c > q_0,\\\\\n0,  q_c \\le q_0,\n\\end{cases}\n$$\n其中 $C_{\\mathrm{K}}=1.0\\times 10^{-3}\\,\\mathrm{s^{-1}}$ 且 $q_0=1.0\\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}$。\n\n计算当 $q_c=1.0\\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}$ 且 $N_c=100\\,\\mathrm{cm^{-3}}$ 时的自动转化趋势 $P_{\\mathrm{KK}}$ 和 $P_{\\mathrm{Kessler}}$。将每个趋势以 $\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$ 表示，并将您的答案四舍五入到三位有效数字。将 $\\left(P_{\\mathrm{KK}},\\,P_{\\mathrm{Kessler}}\\right)$ 的最终值以行矩阵的形式提供。",
            "solution": "该问题要求使用两种不同的参数化方案计算暖雨的自动转化趋势：双矩 Khairoutdinov–Kogan (KK) 方案和单矩 Kessler 方案，并给定一组云属性。\n\n首先，我们处理 Khairoutdinov–Kogan 方案。自动转化趋势 $P_{\\mathrm{KK}}$ 由以下幂律公式给出：\n$$\nP_{\\mathrm{KK}} = C_{\\mathrm{KK}}\\,q_c^{\\alpha}\\,N_c^{\\beta}\n$$\n问题提供了以下数值：\n- 系数 $C_{\\mathrm{KK}} = 1.35 \\times 10^{3}$（对于以 $\\mathrm{kg\\,kg^{-1}}$ 为单位的 $q_c$ 和以 $\\mathrm{cm^{-3}}$ 为单位的 $N_c$ 输入）。\n- 指数 $\\alpha = 2.47$ 和 $\\beta = -1.79$。\n- 云水混合比 $q_c = 1.0 \\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}$。\n- 云滴数浓度 $N_c = 100\\,\\mathrm{cm^{-3}}$。\n\n将这些值代入 $P_{\\mathrm{KK}}$ 的方程中：\n$$\nP_{\\mathrm{KK}} = (1.35 \\times 10^{3}) \\times (1.0 \\times 10^{-3})^{2.47} \\times (100)^{-1.79}\n$$\n我们可以简化包含 10 的幂的项：\n- $q_c$ 的项是 $(10^{-3})^{2.47} = 10^{-3 \\times 2.47} = 10^{-7.41}$。\n- $N_c$ 的项是 $(100)^{-1.79} = (10^2)^{-1.79} = 10^{2 \\times (-1.79)} = 10^{-3.58}$。\n\n现在，我们将这些代回 $P_{\\mathrm{KK}}$ 的表达式中：\n$$\nP_{\\mathrm{KK}} = 1.35 \\times 10^{3} \\times 10^{-7.41} \\times 10^{-3.58}\n$$\n合并 10 的指数：\n$$\nP_{\\mathrm{KK}} = 1.35 \\times 10^{3 - 7.41 - 3.58} = 1.35 \\times 10^{-7.99}\n$$\n计算数值：\n$$\nP_{\\mathrm{KK}} = 1.35 \\times 10^{-7.99} \\approx 1.35 \\times 1.02329... \\times 10^{-8} \\approx 1.3814... \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}\n$$\n按要求将此结果四舍五入到三位有效数字，得到：\n$$\nP_{\\mathrm{KK}} \\approx 1.38 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}\n$$\n\n接下来，我们处理 Kessler 方案。自动转化趋势 $P_{\\mathrm{Kessler}}$ 由一个分段函数定义：\n$$\nP_{\\mathrm{Kessler}} =\n\\begin{cases}\nC_{\\mathrm{K}}\\,(q_c - q_0),  q_c > q_0,\\\\\n0,  q_c \\le q_0,\n\\end{cases}\n$$\n问题为此方案提供了以下数值：\n- 速率系数 $C_{\\mathrm{K}} = 1.0 \\times 10^{-3}\\,\\mathrm{s^{-1}}$。\n- 阈值云水混合比 $q_0 = 1.0 \\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}$。\n- 云水混合比与之前相同，$q_c = 1.0 \\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}$。\n\n我们必须首先检查条件，以确定使用分段函数的哪一部分。我们将 $q_c$ 与阈值 $q_0$ 进行比较：\n$$\nq_c = 1.0 \\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}\n$$\n$$\nq_0 = 1.0 \\times 10^{-3}\\,\\mathrm{kg\\,kg^{-1}}\n$$\n由于 $q_c$ 等于 $q_0$，满足条件 $q_c \\le q_0$。根据 Kessler 方案的定义，当云水混合比不超过阈值时，自动转化趋势为零。因此，\n$$\nP_{\\mathrm{Kessler}} = 0\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}\n$$\n这是一个精确值，不需要四舍五入。\n\n计算出的自动转化趋势为 $P_{\\mathrm{KK}} \\approx 1.38 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$ 和 $P_{\\mathrm{Kessler}} = 0\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 1.38 \\times 10^{-8}  0 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "除了计算瞬时过程速率，微物理方案还必须在模式网格中进行数值积分。这涉及到求解水凝物场的输送方程，例如沉降过程。这个动手编程练习  要求您实现和比较求解沉降方程的显式和隐式数值方法，并分析数值稳定性这一关键概念。",
            "id": "4089393",
            "problem": "考虑一维垂直气柱中雨水混合比的沉降。设 $z$ 表示从地面向上测量的高度（单位为 $\\mathrm{m}$），气柱深度为 $H$，分为 $N$ 个厚度为 $\\Delta z = H/N$ 的均匀间隔的层。预报变量是雨水混合比 $q_r(z,t)$（单位为 $\\mathrm{kg}/\\mathrm{kg}$）。沉降过程由作用于 $q_r$ 的终端下落速度 $V_r$（向下为正）引起的垂直平流表示。\n\n基本原理：从被动标量 $q_r$ 的通量形式质量守恒定律开始，其垂直输送速度为 $w$（向上为正），且除沉降外没有其他源项。对于沉降，取 $w = -V_r$，因此守恒定律为\n$$\n\\frac{\\partial q_r}{\\partial t} + \\frac{\\partial}{\\partial z}\\left(w\\,q_r\\right) = 0, \\quad \\text{其中 } w = -V_r.\n$$\n这可以等价地重写为\n$$\n\\frac{\\partial q_r}{\\partial t} + \\frac{\\partial}{\\partial z}\\left(-V_r\\,q_r\\right) = 0.\n$$\n在气柱顶部（$z=H$）施加零流入边界条件，并允许在地面（$z=0$）流出，以便沉降在 $z=0$ 处移除 $q_r$。\n\n将气柱在网格中心 $i = 0,1,\\dots,N-1$ 上进行离散化，从地面（$i=0$）到顶部（$i=N-1$）。使用守恒的、用于向下输送的一阶迎风界面通量来近似垂直通量散度。实现一个一阶显式时间步进方案和一个一阶隐式后向欧拉时间步进方案，每个方案都与守恒定律和给定的边界条件相一致。对于显式方案，在已知时间层上计算 $V_r$ 和 $q_r$；对于隐式方案，在未知的新时间层上计算它们。对于非线性的 $V_r(q_r)$，通过不动点迭代处理隐式方案，直至收敛。\n\n将向下沉降的库朗-弗里德里希斯-列维（CFL）数定义为\n$$\nC = \\max_i \\left(\\frac{V_{r,i}\\,\\Delta t}{\\Delta z}\\right),\n$$\n其中 $\\Delta t$ 是时间步长，$V_{r,i}$ 是网格中心的终端下落速度。对于显式迎风方案，判断库朗-弗里德里希斯-列维（CFL）条件 $C \\le 1$ 是否得到满足。\n\n初始条件：通过一个中心位于高处的高斯羽来指定初始雨水混合比廓线，\n$$\nq_r(z,0) = q_0\\,\\exp\\left(-\\frac{(z-z_0)^2}{2\\,\\sigma^2}\\right),\n$$\n其中 $q_0$ 的单位是 $\\mathrm{kg}/\\mathrm{kg}$，$z_0$ 的单位是 $\\mathrm{m}$，$\\sigma$ 的单位是 $\\mathrm{m}$。对于一个边界情况测试，也使用零场 $q_r(z,0)=0$。\n\n与微物理复杂性相关联的终端下落速度参数化方案：\n- 单矩微物理方案：取一个与 $q_r$ 无关的常数 $V_r = V_0$，单位为 $\\mathrm{m}/\\mathrm{s}$。\n- 类双矩微物理方案：取非线性下落速度定律 $V_r(q_r) = v_0\\left(\\frac{q_r}{q_{\\mathrm{ref}}}\\right)^\\beta$，并将其值截断在 $[0,v_{\\max}]$ 范围内，其中 $v_0$ 的单位是 $\\mathrm{m}/\\mathrm{s}$，$q_{\\mathrm{ref}}$ 的单位是 $\\mathrm{kg}/\\mathrm{kg}$，$\\beta$ 是无量纲的，$v_{\\max}$ 的单位是 $\\mathrm{m}/\\mathrm{s}$。\n\n单步趋势项：对于每种方案，计算气柱中点层 $i = \\lfloor N/2 \\rfloor$ 处的单步沉降趋势项\n$$\n\\mathcal{T}_{\\mathrm{scheme}} = \\frac{q_r^{\\mathrm{new}} - q_r^{\\mathrm{old}}}{\\Delta t},\n$$\n并以 $\\mathrm{kg}/\\mathrm{kg}/\\mathrm{s}$ 为单位报告其值。\n\n测试套件和参数（均为科学上合理的）：\n- 计算域：$H = 2000\\,\\mathrm{m}$，$N = 10$，因此 $\\Delta z = 200\\,\\mathrm{m}$。\n- 高斯廓线参数：$q_0 = 10^{-3}\\,\\mathrm{kg}/\\mathrm{kg}$，$z_0 = 1500\\,\\mathrm{m}$，$\\sigma = 300\\,\\mathrm{m}$。\n- 非线性速度参数：$v_0 = 5\\,\\mathrm{m}/\\mathrm{s}$，$q_{\\mathrm{ref}} = 10^{-3}\\,\\mathrm{kg}/\\mathrm{kg}$，$\\beta = 0.2$，$v_{\\max} = 10\\,\\mathrm{m}/\\mathrm{s}$。\n\n提供以下五个测试案例：\n- 案例 1：单矩方案，$V_0 = 5\\,\\mathrm{m}/\\mathrm{s}$，$\\Delta t = 10\\,\\mathrm{s}$，高斯 $q_r$ 廓线。\n- 案例 2：单矩方案，$V_0 = 5\\,\\mathrm{m}/\\mathrm{s}$，$\\Delta t = 40\\,\\mathrm{s}$，高斯 $q_r$ 廓线。\n- 案例 3：单矩方案，$V_0 = 5\\,\\mathrm{m}/\\mathrm{s}$，$\\Delta t = 80\\,\\mathrm{s}$，高斯 $q_r$ 廓线。\n- 案例 4：类双矩方案，使用如上定义的 $V_r(q_r)$，$\\Delta t = 40\\,\\mathrm{s}$，高斯 $q_r$ 廓线。\n- 案例 5：单矩方案，$V_0 = 5\\,\\mathrm{m}/\\mathrm{s}$，$\\Delta t = 40\\,\\mathrm{s}$，零 $q_r$ 场。\n\n对于每个案例，计算：\n- 显式方案的库朗-弗里德里希斯-列维（CFL）布尔值 $C \\le 1$。\n- 显式方案的中点趋势项 $\\mathcal{T}_{\\mathrm{exp}}$（单位：$\\mathrm{kg}/\\mathrm{kg}/\\mathrm{s}$）。\n- 隐式方案的中点趋势项 $\\mathcal{T}_{\\mathrm{imp}}$（单位：$\\mathrm{kg}/\\mathrm{kg}/\\mathrm{s}$）。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个由逗号分隔的五个子列表组成的列表，每个子列表的形式为 $[C\\_ok,\\mathcal{T}_{\\mathrm{exp}},\\mathcal{T}_{\\mathrm{imp}}]$，并用方括号括起来。例如，打印的行必须如下所示\n$$\n[\\,[\\text{布尔值},\\text{浮点数},\\text{浮点数}],\\,[\\text{布尔值},\\text{浮点数},\\text{浮点数}],\\,[\\text{布尔值},\\text{浮点数},\\text{浮点数}],\\,[\\text{布尔值},\\text{浮点数},\\text{浮点数}],\\,[\\text{布尔值},\\text{浮点数},\\text{浮点数}]\\,].\n$$\n所有趋势项均以 $\\mathrm{kg}/\\mathrm{kg}/\\mathrm{s}$ 为单位表示。",
            "solution": "问题陈述已经过严格评估，并被确定为有效。它以流体动力学和质量守恒原理为科学基础，与大气科学中的数值模拟相关。该问题是适定的，提供了一个清晰的初边值问题，包含了获得唯一数值解所需的所有必要参数和定义。其语言是客观的，设置是内部一致的。因此，我们可以进行正式求解。\n\n该问题要求模拟雨水沉降过程，该过程由雨水混合比 $q_r(z, t)$ 的一维平流方程控制。控制偏微分方程（PDE）以守恒形式给出：\n$$\n\\frac{\\partial q_r}{\\partial t} + \\frac{\\partial}{\\partial z}(w q_r) = 0\n$$\n其中 $w = -V_r$ 是垂直速度，$V_r  0$ 是向下的终端下落速度。这等价于：\n$$\n\\frac{\\partial q_r}{\\partial t} - \\frac{\\partial}{\\partial z}(V_r q_r) = 0\n$$\n设 $F(q_r) = V_r q_r$ 表示向下沉降通量。方程变为：\n$$\n\\frac{\\partial q_r}{\\partial t} = \\frac{\\partial F}{\\partial z}\n$$\n我们将高度为 $H$ 的垂直气柱离散化为 $N$ 个网格单元，每个单元的厚度为 $\\Delta z = H/N$。网格单元从地面向上索引为 $i = 0, 1, \\dots, N-1$。网格单元 $i$ 的中心位于高度 $z_i = (i + 0.5)\\Delta z$ 处。在时间 $t$、网格单元 $i$ 中的混合比值表示为 $q_{r,i}(t)$。使用有限体积法，网格单元 $i$ 的偏微分方程的半离散形式为：\n$$\n\\frac{d q_{r,i}}{dt} = \\frac{1}{\\Delta z} (F_{i+1/2} - F_{i-1/2})\n$$\n其中 $F_{i+1/2}$ 和 $F_{i-1/2}$ 分别是网格单元 $i$ 顶面和底面的通量。问题指定了用于向下输送的一阶迎风方案。对于向下通量，界面处的值由界面*上方*的网格单元的状态确定。因此，跨越界面 $z_{i+1/2}$（网格单元 $i$ 的顶部）的通量由网格单元 $i+1$ 中的状态确定。\n$$\nF_{i+1/2} = (V_r q_r)_{i+1}\n$$\n类似地，底部界面 $z_{i-1/2}$ 处的通量由其上方的网格单元 $i$ 确定：\n$$\nF_{i-1/2} = (V_r q_r)_i\n$$\n对于内部网格单元（$i = 0, \\dots, N-2$，注意问题中不寻常的索引方式，其中就通量计算逻辑而言，$i=0$ 是一个内部网格单元），半离散方程为：\n$$\n\\frac{d q_{r,i}}{dt} = \\frac{1}{\\Delta z} \\left( (V_r q_r)_{i+1} - (V_r q_r)_i \\right)\n$$\n对于边界网格单元：\n- 在气柱顶部（$z=H$），即网格单元 $i=N-1$ 的顶面，存在零流入边界条件。这意味着从上方流入网格单元 $N-1$ 的通量为零，$F_{N-1+1/2} = 0$。顶部网格单元的方程是：\n$$\n\\frac{d q_{r,N-1}}{dt} = \\frac{1}{\\Delta z} (F_{N-1+1/2} - F_{N-1-1/2}) = \\frac{1}{\\Delta z} \\left( 0 - (V_r q_r)_{N-1} \\right) = -\\frac{(V_r q_r)_{N-1}}{\\Delta z}\n$$\n- 在气柱底部（$z=0$），允许流出。从网格单元 $i=0$ 底部流出的通量是 $F_{-1/2} = (V_r q_r)_0$。流入网格单元 $i=0$ 顶部的通量是 $F_{1/2} = (V_r q_r)_1$。底部网格单元 $i=0$ 的方程是：\n$$\n\\frac{d q_{r,0}}{dt} = \\frac{1}{\\Delta z} (F_{1/2} - F_{-1/2}) = \\frac{1}{\\Delta z} \\left( (V_r q_r)_1 - (V_r q_r)_0 \\right)\n$$\n这与一般内部网格单元方程具有相同的形式。\n\n设 $q_i^n$ 为时间步 $n$ 时 $q_{r,i}$ 的值。我们现在应用指定的时间积分方案。\n\n**1. 一阶显式（前向欧拉）方案**\n时间导数使用时间层 $n$ 的值进行近似。\n对于 $i = 0, \\dots, N-2$：\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{1}{\\Delta z} \\left( (V_r^n q^n)_{i+1} - (V_r^n q^n)_i \\right) \\implies q_i^{n+1} = q_i^n + \\frac{\\Delta t}{\\Delta z} \\left( V_{r,i+1}^n q_{i+1}^n - V_{r,i}^n q_i^n \\right)\n$$\n对于顶部网格单元，$i = N-1$：\n$$\n\\frac{q_{N-1}^{n+1} - q_{N-1}^n}{\\Delta t} = -\\frac{(V_r^n q^n)_{N-1}}{\\Delta z} \\implies q_{N-1}^{n+1} = q_{N-1}^n - \\frac{\\Delta t}{\\Delta z} V_{r,N-1}^n q_{N-1}^n\n$$\n这里，$V_{r,i}^n$ 是网格单元 $i$ 中的下落速度，对于非线性情况，使用 $q_i^n$ 进行计算。\n\n**2. 一阶隐式（后向欧拉）方案**\n时间导数使用新时间层 $n+1$ 的值进行近似。\n对于 $i = 0, \\dots, N-2$：\n$$\n\\frac{q_i^{n+1} - q_i^n}{\\Delta t} = \\frac{1}{\\Delta z} \\left( (V_r^{n+1} q^{n+1})_{i+1} - (V_r^{n+1} q^{n+1})_i \\right)\n$$\n对于顶部网格单元，$i = N-1$：\n$$\n\\frac{q_{N-1}^{n+1} - q_{N-1}^n}{\\Delta t} = -\\frac{(V_r^{n+1} q^{n+1})_{N-1}}{\\Delta z}\n$$\n这构成了一个关于未知向量 $q^{n+1}$ 的方程组。\n\n- **线性情况（单矩，$V_r = V_0$ 为常数）：** 设 $C_0 = \\frac{V_0 \\Delta t}{\\Delta z}$。该系统是线性的。\n$$\n(1+C_0) q_i^{n+1} - C_0 q_{i+1}^{n+1} = q_i^n \\quad \\text{对于 } i=0,\\dots,N-2\n$$\n$$\n(1+C_0) q_{N-1}^{n+1} = q_{N-1}^n\n$$\n这是一个上双对角系统，可以通过从 $i=N-1$ 开始向下进行到 $i=0$ 的回代法高效求解：\n$$\nq_{N-1}^{n+1} = \\frac{q_{N-1}^n}{1+C_0}\n$$\n$$\nq_i^{n+1} = \\frac{q_i^n + C_0 q_{i+1}^{n+1}}{1+C_0} \\quad \\text{对于 } i=N-2, \\dots, 0\n$$\n\n- **非线性情况（类双矩）：** 该系统是非线性的。按照指定，我们使用不动点迭代。设 $k$ 为求解 $q^{n+1}$ 的迭代指数。我们用一个猜测值 $(q^{n+1})^{(0)} = q^n$ 进行初始化。$(q^{n+1})^{(k+1)}$ 的迭代通过在前一次迭代 $k$ 上计算非线性系数 $V_r$ 来构建：\n$$\nq_i^{n+1} - \\frac{\\Delta t}{\\Delta z} V_r(q_{i+1}^{n+1})q_{i+1}^{n+1} + \\frac{\\Delta t}{\\Delta z} V_r(q_i^{n+1})q_i^{n+1} = q_i^n \\quad (\\text{对于 } i=0,\\dots,N-2)\n$$\n$$\nq_{N-1}^{n+1} + \\frac{\\Delta t}{\\Delta z} V_r(q_{N-1}^{n+1})q_{N-1}^{n+1} = q_{N-1}^n\n$$\n令 $V_{r,i}^{(k)} = V_r((q_i^{n+1})^{(k)})$，我们在每次迭代中求解以下线性系统：\n$$\n\\left(1 + \\frac{\\Delta t}{\\Delta z}V_{r,i}^{(k)}\\right) (q_i^{n+1})^{(k+1)} - \\left(\\frac{\\Delta t}{\\Delta z}V_{r,i+1}^{(k)}\\right) (q_{i+1}^{n+1})^{(k+1)} = q_i^n\n$$\n$$\n\\left(1 + \\frac{\\Delta t}{\\Delta z}V_{r,N-1}^{(k)}\\right) (q_{N-1}^{n+1})^{(k+1)} = q_{N-1}^n\n$$\n这又是一个上双对角系统，在每个不动点迭代步骤中通过回代法求解，直到 $q^{n+1}$ 的解收敛为止。我们使用的收敛准则是 $\\max_i |(q_i^{n+1})^{(k+1)} - (q_i^{n+1})^{(k)}|  10^{-12}$。\n\n**初始条件和参数化细节**\n- **初始廓线：** 初始廓线 $q_r(z,0)$ 在网格中心 $z_i=(i+0.5)\\Delta z$ （$i=0, \\dots, N-1$）处进行计算。\n$q_i^0 = q_0 \\exp\\left(-\\frac{(z_i-z_0)^2}{2\\sigma^2}\\right)$。\n- **CFL 条件：** 库朗-弗里德里希斯-列维数是 $C = \\max_i \\left(\\frac{V_{r,i}\\,\\Delta t}{\\Delta z}\\right)$。显式方案的稳定性条件是 $C \\le 1$。\n- **趋势项：** 一个方案的单步趋势项在中点层 $i_{mid} = \\lfloor N/2 \\rfloor = 5$ 处计算为 $\\mathcal{T}_{\\mathrm{scheme}} = (q_{i_{mid}}^{n+1} - q_{i_{mid}}^n) / \\Delta t$。\n\n实现过程将是：为每个测试案例设置初始条件，计算 CFL 条件，然后为显式和隐式方案计算新状态 $q^{n+1}$，最后计算中点层各自的趋势项。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_q_initial(params):\n    \"\"\"Calculates the initial rainwater mixing ratio profile.\"\"\"\n    H, N, q0, z0, sigma, use_gaussian = params\n    delta_z = H / N\n    z_centers = (np.arange(N) + 0.5) * delta_z\n    if not use_gaussian:\n        return np.zeros(N)\n    return q0 * np.exp(-((z_centers - z0)**2) / (2 * sigma**2))\n\ndef get_fall_speed(q_r, v_params):\n    \"\"\"Calculates the fall speed based on the microphysics scheme.\"\"\"\n    scheme_type, v0, q_ref, beta, v_max = v_params\n    if scheme_type == 'single-moment':\n        return np.full_like(q_r, v0)\n    elif scheme_type == 'double-moment':\n        # Ensure q_r is non-negative before power law to avoid complex numbers\n        q_r_safe = np.maximum(q_r, 0)\n        v_r = v0 * (q_r_safe / q_ref)**beta\n        return np.minimum(v_r, v_max)\n    else:\n        raise ValueError(\"Unknown scheme type\")\n\ndef solve_explicit(q_old, V_r, dt, dz):\n    \"\"\"Computes one step of the explicit forward-Euler scheme.\"\"\"\n    N = len(q_old)\n    q_new = np.zeros_like(q_old)\n    c_factor = dt / dz\n\n    flux_product = V_r * q_old\n    \n    # Internal cells and bottom cell (i=0)\n    # Equation for i=0..N-2 is q_new[i] = q_old[i] + c_factor * (flux[i+1] - flux[i])\n    q_new[:-1] = q_old[:-1] + c_factor * (flux_product[1:] - flux_product[:-1])\n\n    # Top cell (i=N-1)\n    # Equation is q_new[N-1] = q_old[N-1] - c_factor * flux[N-1]\n    q_new[-1] = q_old[-1] - c_factor * flux_product[-1]\n    \n    return q_new\n\ndef solve_implicit_linear(q_old, V0, dt, dz):\n    \"\"\"Solves the implicit backward-Euler scheme for the linear case.\"\"\"\n    N = len(q_old)\n    q_new = np.zeros_like(q_old)\n    C0 = V0 * dt / dz\n    \n    # Solve via back substitution (A q_new = q_old)\n    # Top cell, i = N-1\n    q_new[-1] = q_old[-1] / (1.0 + C0)\n    \n    # Cells from i = N-2 down to 0\n    for i in range(N - 2, -1, -1):\n        q_new[i] = (q_old[i] + C0 * q_new[i+1]) / (1.0 + C0)\n        \n    return q_new\n\ndef solve_implicit_nonlinear(q_old, v_params, dt, dz):\n    \"\"\"Solves the implicit backward-Euler scheme for the non-linear case.\"\"\"\n    N = len(q_old)\n    \n    q_k = np.copy(q_old) # Iteration k guess, (q^{n+1})^{(k)}\n    \n    max_iter = 100\n    tol = 1e-12\n    \n    for _ in range(max_iter):\n        q_k_plus_1 = np.zeros_like(q_k)\n        V_r_k = get_fall_speed(q_k, v_params)\n        \n        c_factors_k = V_r_k * dt / dz\n        \n        # Top cell, i = N-1\n        q_k_plus_1[-1] = q_old[-1] / (1.0 + c_factors_k[-1])\n        \n        # Cells from i = N-2 down to 0\n        for i in range(N - 2, -1, -1):\n            numerator = q_old[i] + c_factors_k[i+1] * q_k_plus_1[i+1]\n            denominator = 1.0 + c_factors_k[i]\n            q_k_plus_1[i] = numerator / denominator\n\n        # Check for convergence\n        if np.max(np.abs(q_k_plus_1 - q_k))  tol:\n            return q_k_plus_1\n        \n        q_k = q_k_plus_1\n        \n    # If no convergence, this would indicate an issue, but is unlikely for this problem.\n    return q_k\n\ndef solve():\n    \"\"\"Main function to run the test cases and print results.\"\"\"\n    # Common parameters\n    H = 2000.0  # m\n    N = 10\n    delta_z = H / N\n    midpoint_idx = N // 2\n    \n    # Gaussian profile parameters\n    q0 = 1e-3  # kg/kg\n    z0 = 1500.0 # m\n    sigma = 300.0 # m\n    \n    # Non-linear velocity parameters\n    v0_nl = 5.0  # m/s\n    q_ref = 1e-3 # kg/kg\n    beta = 0.2\n    v_max = 10.0 # m/s\n\n    test_cases = [\n        # Case 1: Single-moment, V0=5, dt=10, Gaussian\n        {'label': '1', 'scheme': 'single-moment', 'V0': 5.0, 'dt': 10.0, 'use_gaussian': True},\n        # Case 2: Single-moment, V0=5, dt=40, Gaussian\n        {'label': '2', 'scheme': 'single-moment', 'V0': 5.0, 'dt': 40.0, 'use_gaussian': True},\n        # Case 3: Single-moment, V0=5, dt=80, Gaussian\n        {'label': '3', 'scheme': 'single-moment', 'V0': 5.0, 'dt': 80.0, 'use_gaussian': True},\n        # Case 4: Double-moment, dt=40, Gaussian\n        {'label': '4', 'scheme': 'double-moment', 'V0': None, 'dt': 40.0, 'use_gaussian': True},\n        # Case 5: Single-moment, V0=5, dt=40, Zero field\n        {'label': '5', 'scheme': 'single-moment', 'V0': 5.0, 'dt': 40.0, 'use_gaussian': False},\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        dt = case['dt']\n        \n        # 1. Initial conditions\n        ic_params = (H, N, q0, z0, sigma, case['use_gaussian'])\n        q_initial = calculate_q_initial(ic_params)\n\n        # 2. Fall speed and CFL condition\n        if case['scheme'] == 'single-moment':\n            v_params = ('single-moment', case['V0'], None, None, None)\n            V_initial = get_fall_speed(q_initial, v_params)\n        else: # double-moment\n            v_params = ('double-moment', v0_nl, q_ref, beta, v_max)\n            V_initial = get_fall_speed(q_initial, v_params)\n\n        CFL = np.max(V_initial) * dt / delta_z\n        CFL_ok = CFL = 1.0\n\n        # 3. Explicit scheme tendency\n        q_new_exp = solve_explicit(q_initial, V_initial, dt, delta_z)\n        T_exp = (q_new_exp[midpoint_idx] - q_initial[midpoint_idx]) / dt\n\n        # 4. Implicit scheme tendency\n        if case['scheme'] == 'single-moment':\n            q_new_imp = solve_implicit_linear(q_initial, case['V0'], dt, delta_z)\n        else: # double-moment\n            q_new_imp = solve_implicit_nonlinear(q_initial, v_params, dt, delta_z)\n        T_imp = (q_new_imp[midpoint_idx] - q_initial[midpoint_idx]) / dt\n        \n        # Store results for this case\n        all_results.append(f\"[{CFL_ok},{T_exp},{T_imp}]\")\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(all_results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}