{
    "hands_on_practices": [
        {
            "introduction": "在湍流建模中，一种常见的方法是将完整的湍流能（TKE）预报方程简化为一个诊断性的代数关系。这种简化在假定湍流生成与耗散达到局部平衡时是有效的，从而避免了求解一个复杂的偏微分方程。本练习  旨在提供应用一阶闭包模型求解平衡TKE的实践经验，它直接关联了湍流的生成项（如切变和浮力生成）与耗散项。掌握这一技能是理解湍流强度如何被参数化以及不同物理过程如何影响湍流能量的基础。",
            "id": "4099592",
            "problem": "考虑湿空气中一个水平均匀、准稳态的对流边界层，在Boussinesq近似下处理，其中湿浮力效应通过虚热力学变量表示。令湍流动能（TKE）定义为 $k \\equiv \\tfrac{1}{2}\\overline{u_i^{\\prime}u_i^{\\prime}}$，其中上划线表示雷诺平均，撇号表示湍流脉动。此情况下，雷诺平均Navier-Stokes（RANS）TKE收支可以示意性地写为切变产生、浮力产生、耗散和湍流输送之间的平衡。假设在充分混合层中的一个代表性高度上，输送散度可以忽略不计，且流动已达到局地平衡，因此产生项与耗散项相平衡。\n\n使用以下建模假设：\n- 平均垂直切变大小为 $S \\equiv \\left|\\partial U/\\partial z\\right|$，其中 $U$ 是水平平均风速。切变产生通过一阶顺梯度闭合 $-\\overline{u^{\\prime}w^{\\prime}} = K_m S$ 进行建模，得到切变产生项 $P_s = K_m S^2$。\n- 涡黏性系数建模为 $K_m = c_m\\,\\ell\\,\\sqrt{k}$，其中 $c_m$ 是一个无量纲常数，$\\ell$ 是混合长度。\n- 湿浮力产生（包括通过虚变量表示的水汽效应）被规定为一个标量 $B$，单位为 $\\mathrm{m^2\\,s^{-3}}$，并被视为已知输入。\n- 耗散参数化为 $\\epsilon = C_{\\epsilon}\\,k^{3/2}/\\ell$，其中 $C_{\\epsilon}$ 是一个无量纲常数。\n\n从TKE收支的局地平衡形式出发，推导这些假设所隐含的关于 $k$ 的代数方程，并根据给定的参数值求解该方程：\n- $S = 2.0\\times 10^{-2}\\ \\mathrm{s^{-1}}$，\n- $B = 2.0\\times 10^{-2}\\ \\mathrm{m^2\\,s^{-3}}$，\n- $\\ell = 1.00\\times 10^{2}\\ \\mathrm{m}$，\n- $c_m = 1.0\\times 10^{-1}$，\n- $C_{\\epsilon} = 7.0\\times 10^{-1}$。\n\n将平衡湍流动能 $k$ 以 $\\mathrm{m^2\\,s^{-2}}$ 为单位，报告为一个实数。将您的答案四舍五入到三位有效数字。",
            "solution": "用户要求我根据一个简化的TKE收支的一组参数化方案，求解平衡湍流动能（TKE）。\n\n### 问题验证\n\n**步骤1：提取给定信息**\n\n- **TKE的定义**：$k \\equiv \\tfrac{1}{2}\\overline{u_i^{\\prime}u_i^{\\prime}}$\n- **物理系统**：水平均匀、准稳态的对流边界层。\n- **近似方法**：Boussinesq近似，用于湿浮力的虚热力学变量。\n- **TKE收支假设**：局地平衡，即产生项与耗散项相平衡。湍流输送散度可忽略。\n- **切变产生模型**：\n    - 平均垂直切变大小：$S \\equiv \\left|\\partial U/\\partial z\\right|$\n    - 一阶顺梯度闭合：$-\\overline{u^{\\prime}w^{\\prime}} = K_m S$\n    - 切变产生项：$P_s = K_m S^2$\n- **涡黏性系数模型**：$K_m = c_m\\,\\ell\\,\\sqrt{k}$\n- **浮力产生**：规定为标量 $B$。\n- **耗散模型**：$\\epsilon = C_{\\epsilon}\\,k^{3/2}/\\ell$\n- **参数值**：\n    - $S = 2.0\\times 10^{-2}\\ \\mathrm{s^{-1}}$\n    - $B = 2.0\\times 10^{-2}\\ \\mathrm{m^2\\,s^{-3}}$\n    - $\\ell = 1.00\\times 10^{2}\\ \\mathrm{m}$\n    - $c_m = 1.0\\times 10^{-1}$\n    - $C_{\\epsilon} = 7.0\\times 10^{-1}$\n\n**步骤2：使用提取的给定信息进行验证**\n\n- **科学基础**：该问题在 大气边界层物理学和湍流建模领域具有坚实的科学基础。雷诺平均Navier-Stokes（RANS）方程、TKE收支的概念以及一阶（$K$理论）闭合的使用都是流体动力学中的标准和基本概念。涡黏性系数（$K_m$）和耗散（$\\epsilon$）的具体形式是基于量纲分析的经典参数化方案，在简化情境中被广泛使用。\n- **适定性**：该问题提供了一组代数关系，并要求解单个变量（$k$）。这些方程可以导出一个关于 $\\sqrt{k}$ 的三次方程。对此方程的分析表明，存在唯一的正实数解，这使得该问题是适定的。\n- **客观性**：该问题使用精确、标准的科学术语和数学表达式进行陈述。它没有歧义、主观论断或观点。\n- **完整性和一致性**：所有必需的参数和模型都已明确给出。给定参数的单位是一致的：\n    - $[P_s] = [K_m][S^2] = ([\\ell][k^{1/2}]) \\times [S^2] = (\\mathrm{m} \\cdot \\mathrm{m\\,s^{-1}}) \\times (\\mathrm{s^{-1}})^2 = \\mathrm{m^2\\,s^{-3}}$。\n    - $[B] = \\mathrm{m^2\\,s^{-3}}$。\n    - $[\\epsilon] = [k^{3/2}]/[\\ell] = (\\mathrm{m^2\\,s^{-2}})^{3/2} / \\mathrm{m} = (\\mathrm{m^3\\,s^{-3}}) / \\mathrm{m} = \\mathrm{m^2\\,s^{-3}}$。\n    TKE收支中的所有项都具有正确的单位，即单位质量的能量每单位时间（或比功率）。该问题在量纲上是一致的。\n\n**步骤3：结论与行动**\n\n该问题在科学上是合理的、适定的、客观的、完整的和一致的。没有发现可识别的缺陷。因此，该问题是**有效的**。我将继续进行详细求解。\n\n### 求解推导\n\n问题陈述，在局地平衡状态下，湍流动能（TKE） $k$ 的产生项与其耗散项 $\\epsilon$ 相平衡。产生项由切变产生 $P_s$ 和浮力产生 $B$ 组成。湍流输送项被假设为可以忽略。因此，TKE收支方程为：\n$$P_s + B = \\epsilon$$\n问题为每一项提供了参数化方案。切变产生项由 $P_s = K_m S^2$ 给出，其中涡黏性系数 $K_m$ 建模为 $K_m = c_m \\ell \\sqrt{k}$。将 $K_m$ 的表达式代入 $P_s$ 的表达式中，得到：\n$$P_s = (c_m \\ell \\sqrt{k}) S^2$$\n耗散项 $\\epsilon$ 被参数化为：\n$$\\epsilon = \\frac{C_{\\epsilon} k^{3/2}}{\\ell}$$\n将这些 $P_s$ 和 $\\epsilon$ 的表达式代入TKE收支方程，得到：\n$$c_m \\ell S^2 \\sqrt{k} + B = \\frac{C_{\\epsilon} k^{3/2}}{\\ell}$$\n这是关于 $k$ 的代数方程。为了解这个方程，做一个代换会很方便。令 $x = \\sqrt{k}$。因为 $k$ 代表动能，它必须是非负的（$k \\geq 0$），这意味着 $x$ 必须是一个非负实数。通过这个代换，$k^{3/2} = (\\sqrt{k})^3 = x^3$。方程变为：\n$$c_m \\ell S^2 x + B = \\frac{C_{\\epsilon}}{\\ell} x^3$$\n将其整理成标准的三次多项式形式（$ax^3+bx+c=0$）得到：\n$$\\frac{C_{\\epsilon}}{\\ell} x^3 - c_m \\ell S^2 x - B = 0$$\n现在，我们代入所提供的参数数值：\n- $S = 2.0\\times 10^{-2}\\ \\mathrm{s^{-1}}$\n- $B = 2.0\\times 10^{-2}\\ \\mathrm{m^2\\,s^{-3}}$\n- $\\ell = 1.00\\times 10^{2}\\ \\mathrm{m}$\n- $c_m = 1.0\\times 10^{-1}$\n- $C_{\\epsilon} = 7.0\\times 10^{-1}$\n\n我们计算三次方程的系数：\n$x^3$ 项的系数是：\n$$\\frac{C_{\\epsilon}}{\\ell} = \\frac{7.0 \\times 10^{-1}}{1.00 \\times 10^{2}} = 7.0 \\times 10^{-3}\\ \\mathrm{m^{-1}}$$\n$x$ 项的系数是：\n$$-c_m \\ell S^2 = -(1.0 \\times 10^{-1}) (1.00 \\times 10^{2}) (2.0 \\times 10^{-2})^2 = -(10) (4.0 \\times 10^{-4}) = -4.0 \\times 10^{-3}\\ \\mathrm{m\\,s^{-2}}$$\n常数项是：\n$$-B = -2.0 \\times 10^{-2}\\ \\mathrm{m^2\\,s^{-3}}$$\n关于 $x$ 的三次方程是：\n$$(7.0 \\times 10^{-3}) x^3 - (4.0 \\times 10^{-3}) x - (2.0 \\times 10^{-2}) = 0$$\n为了简化数值求解，我们可以将整个方程乘以 $1000$：\n$$7x^3 - 4x - 20 = 0$$\n我们需要找到这个方程的正实数根。我们可以分析函数 $f(x) = 7x^3 - 4x - 20$。由于 $f(0) = -20$ 且当 $x \\to \\infty$ 时 $f(x) \\to \\infty$，并且函数对于 $x>0$ 只有一个局部极值（是一个值为负的极小值），所以必须存在唯一一个正实数根。\n我们测试整数值：\n$f(1) = 7(1)^3 - 4(1) - 20 = 7 - 4 - 20 = -17$\n$f(2) = 7(2)^3 - 4(2) - 20 = 56 - 8 - 20 = 28$\n根位于 $x=1$ 和 $x=2$ 之间。我们可以使用数值方法（如牛顿-拉弗森法或二分法）找到根。让我们尝试1和2之间的值：\n$f(1.5) = 7(1.5)^3 - 4(1.5) - 20 = 7(3.375) - 6 - 20 = 23.625 - 26 = -2.375$\n$f(1.6) = 7(1.6)^3 - 4(1.6) - 20 = 7(4.096) - 6.4 - 20 = 28.672 - 26.4 = 2.272$\n根位于 $1.5$ 和 $1.6$ 之间。找到一个更精确的值约为 $x \\approx 1.5528$。\n\n现在我们可以从 $x$ 计算TKE $k$：\n$$k = x^2$$\n$$k \\approx (1.5528)^2 \\approx 2.41118784\\ \\mathrm{m^2\\,s^{-2}}$$\n问题要求将结果四舍五入到三位有效数字。\n$$k \\approx 2.41\\ \\mathrm{m^2\\,s^{-2}}$$",
            "answer": "$$\\boxed{2.41}$$"
        },
        {
            "introduction": "从理想化的混合层过渡到受地表强烈影响的大气近地层，我们遇到了另一个强大的理论框架。莫宁-奥布霍夫相似性理论（Monin-Obukhov Similarity Theory, MOST）为关联湍流助熔与平均量梯度提供了坚实的基础，是边界层气象学的基石。本练习  要求您使用给定的观测数据来计算关键的标度参数，例如奥布霍夫长度 $L$ 和动量涡动扩散系数 $K_{m}$。这个过程将展示理论如何将真实世界的测量数据与湍流的基本属性联系起来，这是评估地表-大气相互作用的关键一步。",
            "id": "4099599",
            "problem": "考虑开放海洋上的大气近地面层，在定常、水平均匀且莫宁-奥布霍夫相似性理论（MOST）适用的条件下。给定在高度 $z=10\\,\\mathrm{m}$ 处的观测值：摩擦速度 $u_{*}=0.35\\,\\mathrm{m\\,s^{-1}}$，运动学虚位温通量 $\\overline{w' \\theta_{v}'}=0.060\\,\\mathrm{K\\,m\\,s^{-1}}$，气温 $T=298\\,\\mathrm{K}$，比湿 $q_{v}=0.018\\,\\mathrm{kg\\,kg^{-1}}$，以及气压 $p=1.015\\times 10^{5}\\,\\mathrm{Pa}$。假设在测量高度没有液态水（即 $q_{\\ell}=0$），冯·卡门常数 $\\kappa=0.40$，重力加速度 $g=9.81\\,\\mathrm{m\\,s^{-2}}$，参考气压 $p_{0}=1.0\\times 10^{5}\\,\\mathrm{Pa}$，干空气气体常数 $R_{d}=287\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，以及定压比热 $c_{p}=1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$。\n\n从用于定义奥布霍夫长度的近地面层通量-梯度框架和湍流动能收支（对湿空气使用虚位温）出发，完成以下任务：\n\n- 根据 $(T,\\,q_{v},\\,p)$ 计算平均虚位温 $\\overline{\\theta_{v}}$。\n- 使用适用于湿空气（含 $\\theta_{v}$）的奥布霍夫长度 $L$ 的定义来计算 $L$。\n- 根据 $z/L$ 的符号确定稳定度状况，并采用该状况下动量的标准 Businger-Dyer 相似函数，计算在 $z=10\\,\\mathrm{m}$ 处的无量纲风切变函数 $\\phi_{m}$。\n- 最后，使用通量-梯度关系式 $K_{m}=u_{*}\\,\\kappa\\,z/\\phi_{m}$ 计算动量涡动扩散系数 $K_{m}$。\n\n将 $L$ 以 $\\mathrm{m}$ 为单位表示，$\\phi_{m}$ 为无量纲量，以及 $K_{m}$ 以 $\\mathrm{m^{2}\\,s^{-1}}$ 为单位表示。将最终结果四舍五入至三位有效数字。",
            "solution": "适用的基础框架是莫宁-奥布霍夫相似性理论（MOST），该理论基于近地面层中定常、水平均匀和平面流动的雷诺平均方程，以及引出奥布霍夫长度尺度的湍流动能（TKE）收支。在湿空气中，浮力由虚位温决定，因此相关的热力学变量是 $\\theta_{v}$。\n\n第1步：计算平均虚位温 $\\overline{\\theta_{v}}$。\n\n- 位温的定义为\n$$\n\\theta \\equiv T \\left(\\frac{p_{0}}{p}\\right)^{\\kappa_{\\theta}}, \\quad \\kappa_{\\theta}\\equiv \\frac{R_{d}}{c_{p}}.\n$$\n- 对于湿润、非凝结空气的虚位温为\n$$\n\\theta_{v}=\\theta\\left(1+0.61\\,q_{v}-q_{\\ell}\\right).\n$$\n给定 $q_{\\ell}=0$，此式简化为 $\\theta_{v}=\\theta\\left(1+0.61\\,q_{v}\\right)$。\n\n在代入数值前保持符号形式：\n$$\n\\overline{\\theta_{v}}=T \\left(\\frac{p_{0}}{p}\\right)^{R_{d}/c_{p}}\\left(1+0.61\\,q_{v}\\right).\n$$\n\n现在代入给定值：\n- $T=298\\,\\mathrm{K}$，\n- $p_{0}=1.0\\times 10^{5}\\,\\mathrm{Pa}$，\n- $p=1.015\\times 10^{5}\\,\\mathrm{Pa}$，\n- $R_{d}/c_{p}=287/1004\\approx 0.2857$，\n- $q_{v}=0.018$。\n\n计算 Exner 因子：\n$$\n\\left(\\frac{p_{0}}{p}\\right)^{R_{d}/c_{p}}=\\left(\\frac{1.0\\times 10^{5}}{1.015\\times 10^{5}}\\right)^{0.2857}\\approx \\left(0.98522\\right)^{0.2857}\\approx 0.99576.\n$$\n然后\n$$\n\\theta=T \\left(\\frac{p_{0}}{p}\\right)^{R_{d}/c_{p}}\\approx 298\\times 0.99576\\approx 296.73\\,\\mathrm{K},\n$$\n并考虑湿度，\n$$\n\\overline{\\theta_{v}}=\\theta\\left(1+0.61\\,q_{v}\\right)\\approx 296.73\\times \\left(1+0.61\\times 0.018\\right)=296.73\\times 1.01098\\approx 299.988\\,\\mathrm{K}.\n$$\n\n第2步：定义并计算奥布霍夫长度 $L$。\n\n根据 MOST 和近地面层的 TKE 收支，使用虚位温的奥布霍夫长度为\n$$\nL\\equiv -\\,\\frac{u_{*}^{3}\\,\\overline{\\theta_{v}}}{\\kappa\\, g\\, \\overline{w'\\theta_{v}'} }.\n$$\n代入给定值：\n- $u_{*}=0.35\\,\\mathrm{m\\,s^{-1}}$，所以 $u_{*}^{3}=0.35^{3}=0.042875\\,\\mathrm{m^{3}\\,s^{-3}}$，\n- $\\overline{\\theta_{v}}\\approx 299.988\\,\\mathrm{K}$，\n- $\\kappa=0.40$，\n- $g=9.81\\,\\mathrm{m\\,s^{-2}}$，\n- $\\overline{w'\\theta_{v}'}=0.060\\,\\mathrm{K\\,m\\,s^{-1}}$。\n\n计算分母：\n$$\n\\kappa\\,g\\,\\overline{w'\\theta_{v}'}=0.40\\times 9.81\\times 0.060=0.23544.\n$$\n计算分子：\n$$\nu_{*}^{3}\\,\\overline{\\theta_{v}}=0.042875\\times 299.988\\approx 12.86199.\n$$\n因此\n$$\nL=-\\,\\frac{12.86199}{0.23544}\\approx -54.6296\\,\\mathrm{m}.\n$$\n\n第3步：确定稳定度并计算 $\\phi_{m}$。\n\n稳定度参数为 $z/L$。当 $z=10\\,\\mathrm{m}$ 且 $L\\approx -54.6296\\,\\mathrm{m}$ 时，\n$$\n\\frac{z}{L}=\\frac{10}{-54.6296}\\approx -0.1830,\n$$\n这表示不稳定层结（由于向上的正浮力通量，导致 $z/L$ 为负）。\n\n采用不稳定条件下动量的标准 Businger-Dyer 相似函数，这是一个被广泛使用且经过充分检验的经验形式。对于不稳定层结，该函数为\n$$\n\\phi_{m}=\\left(1-16\\,\\frac{z}{L}\\right)^{-1/4}.\n$$\n在 $z=10\\,\\mathrm{m}$ 处求值：\n$$\n1-16\\,\\frac{z}{L}=1-16\\times(-0.1830)=1+2.9285=3.9285,\n$$\n所以\n$$\n\\phi_{m}=3.9285^{-1/4}\\approx 0.7104.\n$$\n\n第4步：计算动量涡动扩散系数 $K_{m}$。\n\n根据近地面层的通量-梯度关系，\n$$\nK_{m}=\\frac{u_{*}\\,\\kappa\\,z}{\\phi_{m}}.\n$$\n代入数值：\n$$\nK_{m}=\\frac{0.35\\times 0.40\\times 10}{0.7104}=\\frac{1.40}{0.7104}\\approx 1.9705\\,\\mathrm{m^{2}\\,s^{-1}}.\n$$\n\n将每个量四舍五入至三位有效数字，并按要求标注单位：\n- $L\\approx -54.6\\,\\mathrm{m}$，\n- $\\phi_{m}\\approx 0.710$ (无量纲)，\n- $K_{m}\\approx 1.97\\,\\mathrm{m^{2}\\,s^{-1}}$。",
            "answer": "$$\\boxed{\\begin{pmatrix}-54.6  0.710  1.97\\end{pmatrix}}$$"
        },
        {
            "introduction": "虽然简单的闭包方案很有用，但理解它们的局限性至关重要。经典的K理论假设湍流总是沿着平均梯度的方向输送动量（顺梯度输送），但这种假设在由浮力驱动的对流边界层中会失效，因为大的涡旋可以逆着平均风切变的方向输送动量。这项高级练习  将您置于模型开发者的角色，要求您通过编程来定量评估K理论闭包相对于高分辨率模拟结果的表现。您需要实现一个决策规则，用以判断何时必须放弃简单的局部闭包，转而使用更复杂的非局部方案，这正是湍流闭包问题在实际应用中的核心挑战。",
            "id": "4099600",
            "problem": "考虑大气边界层中的一个一维垂直气柱，其高度坐标为 $z$，单位为米。雷诺平均动量方程引入了湍流动量通量，定义为 $\\tau_u(z) = \\overline{u'(z) w'(z)}$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$，其中 $\\overline{\\cdot}$ 表示雷诺平均，$u'$ 和 $w'$ 分别是水平和垂直速度分量的湍流脉动。在局地涡度扩散闭合（通常称为 K-理论）中，湍流动量通量被建模为 $\\tau_K(z) = -K_m(z) \\, \\partial_z \\overline{u}(z)$，其中 $K_m(z)$ 是动量的涡度扩散系数，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$，$\\overline{u}(z)$ 是平均水平风，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-1}$。大涡模拟（LES）用于在三维空间中高保真地解析湍流通量，并提供一个参考廓线 $\\tau_{\\mathrm{LES}}(z)$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$。\n\n您的任务是通过比较 $\\tau_K(z)$ 与 $\\tau_{\\mathrm{LES}}(z)$，分析局地 K-理论在干对流条件下的性能，并提出一个定量的机制切换准则，以决定何时应优先选择非局地闭合。您编写的程序必须为每个测试案例计算以下诊断量，然后应用一个决策规则：\n\n- 在一个均匀间隔的 $z$ 点网格上，使用二阶精度的有限差分格式计算垂直梯度 $\\partial_z \\overline{u}(z)$（对内部点使用中心差分，对边界点使用单侧差分）。$\\partial_z \\overline{u}$ 的单位必须是 $\\mathrm{s}^{-1}$。\n- 计算局地 K-理论通量 $\\tau_K(z) = -K_m(z) \\, \\partial_z \\overline{u}(z)$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$。\n- 计算归一化均方根误差 $\\mathrm{NRMSE}$，定义为 $$\\mathrm{NRMSE} = \\frac{\\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\tau_K(z_i) - \\tau_{\\mathrm{LES}}(z_i)\\right)^2}}{\\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\tau_{\\mathrm{LES}}(z_i)\\right)^2} + \\varepsilon},$$ 其中 $N$ 是垂直层数，$\\varepsilon$ 是一个小的正常数以避免除以零（使用 $\\varepsilon = 10^{-12}$）。\n- 计算量级加权的符号不匹配分数 $$S = \\frac{\\sum_{i=1}^{N} \\left|\\tau_{\\mathrm{LES}}(z_i)\\right| \\, \\mathbb{I}\\left(\\operatorname{sign}\\left(\\tau_K(z_i)\\right) \\neq \\operatorname{sign}\\left(\\tau_{\\mathrm{LES}}(z_i)\\right)\\right)}{\\sum_{i=1}^{N} \\left|\\tau_{\\mathrm{LES}}(z_i)\\right| + \\varepsilon},$$ 其中 $\\mathbb{I}(\\cdot)$ 是指示函数，$\\operatorname{sign}(\\cdot)$ 返回 $-1$、$0$ 或 $+1$。\n- 计算 $\\tau_K$ 和 $\\tau_{\\mathrm{LES}}$ 之间的皮尔逊相关系数 $r$，定义为 $$r = \\frac{\\mathrm{Cov}\\left(\\tau_K, \\tau_{\\mathrm{LES}}\\right)}{\\sigma(\\tau_K) \\, \\sigma(\\tau_{\\mathrm{LES}})},$$ 其中 $\\mathrm{Cov}$ 是协方差，$\\sigma$ 表示标准差。如果任一方差为零（即 $\\sigma(\\tau_K) = 0$ 或 $\\sigma(\\tau_{\\mathrm{LES}}) = 0$），则将 $r$ 设为 $0$，并为了机制切换的目的，将该相关性视为未定义。\n\n定义机制切换决策规则如下。当局部 K-理论至少满足以下一个量化标准而失效时，选择非局地闭合：\n- $\\mathrm{NRMSE} > A$，\n- $S > B$，\n- $r < C$ 且 $\\tau_K$ 和 $\\tau_{\\mathrm{LES}}$ 的方差均为有效的非零值。\n否则，选择局地 K-理论机制。使用阈值 $A = 0.35$，$B = 0.30$ 和 $C = 0.60$（无量纲）。\n\n您的程序必须评估以下科学上合理的测试套件。对于每个案例，构建一个均匀网格，计算 $\\partial_z \\overline{u}$、$\\tau_K$、诊断量 $\\mathrm{NRMSE}$、$S$、$r$，然后应用机制切换规则。所有物理量均以指定单位表示。最终输出是每个测试案例的机制分类，以整数形式表示（$0$ 表示局地 K-理论，$1$ 表示非局地闭合）。\n\n测试套件：\n- 案例 1（混合层中弱切变的干对流边界层，预计局地顺梯度闭合会失效）：\n  - 气柱高度 $h_1 = 1200$ $\\mathrm{m}$，层数 $N_1 = 61$，$z$ 从 $0$ 到 $h_1$ 均匀间隔。\n  - 平均风廓线 $\\overline{u}_1(z) = 8 - 0.5 \\exp\\left(-\\frac{z}{50}\\right)$，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-1}$。\n  - 涡度扩散系数 $K_{m,1}(z) = 25 \\left(\\frac{z}{h_1}\\right)\\left(1 - \\frac{z}{h_1}\\right) + 0.5$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$。\n  - LES 解析的动量通量 $\\tau_{\\mathrm{LES},1}(z) = -0.3 \\left[1 - \\left(\\frac{z}{h_1}\\right)^{1.2}\\right]$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$。\n- 案例 2（中性、切变驱动的边界层，局地 K-理论适用）：\n  - 气柱高度 $h_2 = 600$ $\\mathrm{m}$，层数 $N_2 = 81$，$z$ 从 $2$ 到 $h_2$ 均匀间隔（避免 $z = 0$ 以防止对数中的奇点）。\n  - 常数：摩擦速度 $u_* = 0.4$ $\\mathrm{m} \\, \\mathrm{s}^{-1}$，von Kármán 常数 $\\kappa = 0.4$，粗糙度长度 $z_0 = 0.1$ $\\mathrm{m}$。\n  - 平均风廓线 $\\overline{u}_2(z) = \\frac{u_*}{\\kappa} \\ln\\left(\\frac{z + z_0}{z_0}\\right)$，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-1}$。\n  - 涡度扩散系数 $K_{m,2}(z) = \\kappa \\, u_* \\, z \\left(1 - \\frac{z}{h_2}\\right)$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$。\n  - LES 解析的动量通量定义为与局地闭合有 5% 的偏差：$\\tau_{\\mathrm{LES},2}(z) = 0.95 \\left[-K_{m,2}(z) \\, \\partial_z \\overline{u}_2(z)\\right]$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$。\n- 案例 3（平均风几乎均匀的粗分辨率对流混合层，非局地输送占主导）：\n  - 气柱高度 $h_3 = 800$ $\\mathrm{m}$，层数 $N_3 = 7$，$z$ 从 $0$ 到 $h_3$ 均匀间隔。\n  - 平均风廓线 $\\overline{u}_3(z) = 10$，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-1}$（常数）。\n  - 涡度扩散系数 $K_{m,3}(z) = 15 \\left(\\frac{z}{h_3}\\right)\\left(1 - \\frac{z}{h_3}\\right)$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$。\n  - LES 解析的动量通量 $\\tau_{\\mathrm{LES},3}(z) = -0.2 \\left(1 - \\frac{z}{h_3}\\right)$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$。\n- 案例 4（弱切变、静止层；闭合通量和 LES 通量均接近于零）：\n  - 气柱高度 $h_4 = 300$ $\\mathrm{m}$，层数 $N_4 = 61$，$z$ 从 $0$ 到 $h_4$ 均匀间隔。\n  - 平均风廓线 $\\overline{u}_4(z) = 5$，单位为 $\\mathrm{m} \\, \\mathrm{s}^{-1}$（常数）。\n  - 涡度扩散系数 $K_{m,4}(z) = 0.01$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$（常数）。\n  - LES 解析的动量通量 $\\tau_{\\mathrm{LES},4}(z) = 0$，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$（恒为零）。\n\n机制切换输出规范：\n- 对于每个测试案例，使用阈值 $A = 0.35$、$B = 0.30$ 和 $C = 0.60$ 应用决策规则，如果选择局地 K-理论机制，则输出 $0$，如果选择非局地机制，则输出 $1$。\n- 您的程序应生成单行输出，其中包含四个机制决策，形式为用方括号括起来的逗号分隔列表（例如，$[0,1,1,0]$）。",
            "solution": "湍流闭合问题是流体动力学中的一个核心挑战，尤其是在数值天气预报和气候模拟的背景下。流体运动的雷诺平均方程包含一些项，如湍流动量通量 $\\overline{u'w'}$，这些项代表了未解析的湍涡的净效应。闭合方案是一种模型，它将这些未知项表示为已解析的平均流变量的函数。本问题要求评估一种简单的局地闭合方案（K-理论）相对于大涡模拟（LES）提供的高保真度参考的性能，并实现一个定量准则，以便在局地模型失效时切换到更复杂的非局地闭合方案。\n\n局地 K-理论的基本原理是涡度扩散假设，该假设认为湍流输送沿着平均量的梯度方向发生，类似于分子扩散。对于动量，这表示为：\n$$\n\\tau_K(z) = -K_m(z) \\, \\frac{\\partial \\overline{u}(z)}{\\partial z}\n$$\n其中 $\\tau_K(z)$ 是模拟的运动学动量通量，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-2}$；$K_m(z)$ 是动量的涡度扩散系数，单位为 $\\mathrm{m}^2 \\, \\mathrm{s}^{-1}$；$\\frac{\\partial \\overline{u}(z)}{\\partial z}$ 是平均水平风的垂直梯度，或称平均风切变，单位为 $\\mathrm{s}^{-1}$。众所周知，该模型在切变驱动的湍流中是有效的，但在浮力驱动（对流）的湍流中会失效，因为在后者中，大的、相干的涡旋可以逆着或横跨平均风梯度输送动量（“逆梯度”输送）。LES 解析了这些大涡，因此提供了一个物理上更准确的参考通量 $\\tau_{\\mathrm{LES}}(z)$。\n\n对于每个测试案例，解决方案分四个主要步骤进行：\n1.  对垂直域进行离散化，并计算每个网格点 $z_i$ 上的平均风廓线 $\\overline{u}(z_i)$。\n2.  使用二阶精度的有限差分格式计算平均风切变 $\\frac{\\partial \\overline{u}}{\\partial z}$。\n3.  计算 K-理论通量 $\\tau_K(z_i)$，并评估给定的 $K_m(z_i)$ 和 $\\tau_{\\mathrm{LES}}(z_i)$ 廓线。\n4.  计算指定的诊断指标（$\\mathrm{NRMSE}$, $S$, $r$）并应用决策规则来选择合适的闭合机制。\n\n**步骤 1：网格离散化**\n对于每个高度为 $h$、层数为 $N$ 的案例，构建一个均匀的垂直网格 $z$。网格间距为 $\\Delta z = (z_{\\text{end}} - z_{\\text{start}}) / (N-1)$。对于案例 1、3 和 4，网格从 $z=0$ 延伸到 $z=h$。对于案例 2，它从 $z=2$ 延伸到 $z=h_2$。\n\n**步骤 2：数值微分**\n风切变 $\\frac{\\partial \\overline{u}}{\\partial z}$ 是通过数值方法计算的。为了按要求在整个域上保持二阶精度，我们对内部点使用中心差分格式，对边界点使用二阶单侧（前向/后向）格式。对于均匀网格 $z_i$（间距为 $\\Delta z$）上的函数 $f(z)$：\n- 内部点（$i=2, \\dots, N-1$）：二阶中心差分为\n$$\n\\left(\\frac{\\partial f}{\\partial z}\\right)_{i} \\approx \\frac{f(z_{i+1}) - f(z_{i-1})}{2 \\Delta z}\n$$\n- 下边界（$i=1$）：二阶前向差分为\n$$\n\\left(\\frac{\\partial f}{\\partial z}\\right)_{1} \\approx \\frac{-3f(z_1) + 4f(z_2) - f(z_3)}{2 \\Delta z}\n$$\n- 上边界（$i=N$）：二阶后向差分为\n$$\n\\left(\\frac{\\partial f}{\\partial z}\\right)_{N} \\approx \\frac{3f(z_N) - 4f(z_{N-1}) + f(z_{N-2})}{2 \\Delta z}\n$$\n\n**步骤 3：诊断量计算**\n在计算出所有 $N$ 个网格点的廓线 $\\tau_K(z_i)$ 和 $\\tau_{\\mathrm{LES}}(z_i)$ 后，计算三个性能指标。\n\n- **归一化均方根误差（$\\mathrm{NRMSE}$）**：该指标量化了误差的总体大小相对于参考信号的大小。\n$$\n\\mathrm{NRMSE} = \\frac{\\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\tau_K(z_i) - \\tau_{\\mathrm{LES}}(z_i)\\right)^2}}{\\sqrt{\\frac{1}{N}\\sum_{i=1}^{N} \\left(\\tau_{\\mathrm{LES}}(z_i)\\right)^2} + \\varepsilon}\n$$\n一个小的常数 $\\varepsilon = 10^{-12}$ 确保在 LES 通量处处为零时计算的稳定性。\n\n- **量级加权的符号不匹配分数（$S$）**：该诊断量专门用于惩罚 K-理论模型在预测通量方向错误（例如，当输送是逆梯度时预测为顺梯度）的情况。不匹配的权重由真实通量的量级决定，从而强调在输送显著之处的误差。\n$$\nS = \\frac{\\sum_{i=1}^{N} \\left|\\tau_{\\mathrm{LES}}(z_i)\\right| \\, \\mathbb{I}\\left(\\operatorname{sign}\\left(\\tau_K(z_i)\\right) \\neq \\operatorname{sign}\\left(\\tau_{\\mathrm{LES}}(z_i)\\right)\\right)}{\\sum_{i=1}^{N} \\left|\\tau_{\\mathrm{LES}}(z_i)\\right| + \\varepsilon}\n$$\n指示函数 $\\mathbb{I}(\\cdot)$ 在条件为真时为 $1$，否则为 $0$。$\\operatorname{sign}$ 函数返回 $-1$、$0$ 或 $+1$。\n\n- **皮尔逊相关系数（$r$）**：该指标衡量了模拟通量廓线和参考通量廓线之间的线性相关性。\n$$\nr = \\frac{\\sum_{i=1}^{N} (\\tau_K(z_i) - \\overline{\\tau_K})(\\tau_{\\mathrm{LES}}(z_i) - \\overline{\\tau_{\\mathrm{LES}}})}{\\sqrt{\\sum_{i=1}^{N}(\\tau_K(z_i) - \\overline{\\tau_K})^2 \\sum_{i=1}^{N}(\\tau_{\\mathrm{LES}}(z_i) - \\overline{\\tau_{\\mathrm{LES}}})^2}}\n$$\n其中 $\\overline{\\tau}$ 表示通量廓线的平均值。根据规定，如果任一通量廓线的方差为零（即为常数），则将 $r$ 设为 $0$，并且该指标不用于决策规则。\n\n**步骤 4：机制切换决策**\n如果局地模型的性能不佳，则做出从局地 K-理论闭合（机制 0）切换到非局地闭合（机制 1）的决定。失效的标准由阈值 $A = 0.35$，$B = 0.30$ 和 $C = 0.60$ 确定。如果满足以下任一条件，则选择非局地闭合：\n1.  $\\mathrm{NRMSE} > A$\n2.  $S > B$\n3.  $r < C$，前提是 $\\tau_K$ 和 $\\tau_{\\mathrm{LES}}$ 的方差都非零。\n\n如果以上条件均不满足，则认为局地 K-理论是足够的（机制 0）。\n\n**测试案例分析：**\n\n- **案例 1**：干对流边界层。平均风切变很弱，尤其是在混合层的上部。然而，对流湍流驱动了显著的动量通量。我们预期 $\\partial_z \\overline{u}$ 会很小，导致 $\\tau_K$ 也很小，而 $\\tau_{\\mathrm{LES}}$ 则很显著。这种不匹配应导致高 $\\mathrm{NRMSE}$、可能高的 $S$ 和低 $r$，从而触发切换到非局地机制（输出 $1$）。\n\n- **案例 2**：中性、切变驱动的边界层。这是 K-理论的理想情景。对数风廓线在整个层内提供了强大且非零的切变。K-理论通量 $\\tau_K$ 应该是真实通量的良好近似。由于 $\\tau_{\\mathrm{LES}}$ 被定义为与 $\\tau_K$ 仅相差 $5\\%$，我们预期会有极好的一致性。$\\mathrm{NRMSE}$ 将非常小，$S$ 将为 $0$（符号将始终匹配），$r$ 将非常接近 $1$。应选择局地 K-理论机制（输出 $0$）。\n\n- **案例 3**：具有均匀平均风的对流层。这里，$\\overline{u}(z)$ 是常数，因此其梯度 $\\partial_z \\overline{u}$ 恒为零。因此，K-理论通量 $\\tau_K(z) = 0$ 处处为零。然而，LES 参考通量 $\\tau_{\\mathrm{LES}}$ 是非零的，代表了纯粹的非局地对流输送。在这种情况下，$\\mathrm{NRMSE}$ 将恰好为 $1$（因为 $\\tau_K=0$）。符号不匹配分数 $S$ 也将为 $1$，因为在 $\\tau_{\\mathrm{LES}} \\neq 0$ 的地方，$\\operatorname{sign}(0) \\neq \\operatorname{sign}(-0.2 \\dots)$。$\\tau_K$ 的方差为零，因此跳过相关性检查。由于 $\\mathrm{NRMSE} > A$ 和 $S > B$，决策将是切换到非局地机制（输出 $1$）。\n\n- **案例 4**：静止层。平均风是均匀的（$\\partial_z \\overline{u} = 0$），LES 通量也为零（$\\tau_{\\mathrm{LES}} = 0$）。K-理论通量同样为零（$\\tau_K=0$）。没有需要模拟的湍流。$\\mathrm{NRMSE}$ 和 $S$ 指标的分子和分母都将为零（或接近零，由 $\\varepsilon$ 处理）。因此，$\\mathrm{NRMSE} \\approx 0$ 且 $S \\approx 0$。两个通量廓线的方差都为零，因此跳过相关性检查。所有失效标准均未满足，因此（微不足道的）局地 K-理论是足够的（输出 $0$）。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    \n    # Define constants and thresholds\n    EPSILON = 1e-12\n    A = 0.35  # NRMSE threshold\n    B = 0.30  # Sign mismatch threshold\n    C = 0.60  # Pearson correlation threshold\n\n    # --- Test Case Definitions ---\n\n    test_cases = [\n        # Case 1: Dry convective boundary layer\n        {\n            \"h\": 1200.0, \"N\": 61, \"z_start\": 0.0,\n            \"u_profile\": lambda z, h: 8.0 - 0.5 * np.exp(-z / 50.0),\n            \"Km_profile\": lambda z, h: 25.0 * (z / h) * (1 - z / h) + 0.5,\n            \"tau_les_profile\": lambda z, h, grad_u, Km: -0.3 * (1 - (z / h)**1.2),\n        },\n        # Case 2: Neutral, shear-driven boundary layer\n        {\n            \"h\": 600.0, \"N\": 81, \"z_start\": 2.0,\n            \"params\": {\"u_star\": 0.4, \"kappa\": 0.4, \"z0\": 0.1},\n            \"u_profile\": lambda z, h, p: (p[\"u_star\"] / p[\"kappa\"]) * np.log((z + p[\"z0\"]) / p[\"z0\"]),\n            \"Km_profile\": lambda z, h, p: p[\"kappa\"] * p[\"u_star\"] * z * (1 - z / h),\n            \"tau_les_profile\": lambda z, h, grad_u, Km: 0.95 * (-Km * grad_u),\n        },\n        # Case 3: Coarse-resolution convective mixed layer\n        {\n            \"h\": 800.0, \"N\": 7, \"z_start\": 0.0,\n            \"u_profile\": lambda z, h: 10.0 + 0*z, # Ensure array output\n            \"Km_profile\": lambda z, h: 15.0 * (z / h) * (1 - z / h),\n            \"tau_les_profile\": lambda z, h, grad_u, Km: -0.2 * (1 - z / h),\n        },\n        # Case 4: Weak-shear, quiescent layer\n        {\n            \"h\": 300.0, \"N\": 61, \"z_start\": 0.0,\n            \"u_profile\": lambda z, h: 5.0 + 0*z, # Ensure array output\n            \"Km_profile\": lambda z, h: 0.01 + 0*z,\n            \"tau_les_profile\": lambda z, h, grad_u, Km: 0.0 + 0*z,\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        decision = process_case(case, A, B, C, EPSILON)\n        results.append(decision)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\n\ndef compute_gradient(f_vals, dz):\n    \"\"\"\n    Computes the gradient of a function on a uniform grid using second-order\n    accurate finite differences at the interior and boundaries.\n    \"\"\"\n    n = len(f_vals)\n    if n < 3:\n        # Fallback to first-order for very coarse grids\n        grad = np.gradient(f_vals, dz)\n        return grad\n        \n    grad = np.zeros_like(f_vals, dtype=float)\n    \n    # Second-order forward difference at the start\n    grad[0] = (-3.0 * f_vals[0] + 4.0 * f_vals[1] - f_vals[2]) / (2.0 * dz)\n    \n    # Second-order central difference for the interior\n    grad[1:-1] = (f_vals[2:] - f_vals[:-2]) / (2.0 * dz)\n    \n    # Second-order backward difference at the end\n    grad[-1] = (3.0 * f_vals[-1] - 4.0 * f_vals[-2] + f_vals[-3]) / (2.0 * dz)\n    \n    return grad\n\n\ndef process_case(case_data, A, B, C, epsilon):\n    \"\"\"\n    Processes a single test case to determine the closure regime.\n    Returns 0 for local K-theory, 1 for non-local.\n    \"\"\"\n    h, N, z_start = case_data[\"h\"], case_data[\"N\"], case_data[\"z_start\"]\n    params = case_data.get(\"params\", None)\n\n    # 1. Setup grid and compute profiles\n    z = np.linspace(z_start, h, N)\n    dz = z[1] - z[0] if N > 1 else 0\n\n    if params:\n        u_vals = case_data[\"u_profile\"](z, h, params)\n    else:\n        u_vals = case_data[\"u_profile\"](z, h)\n\n    # 2. Compute gradient\n    grad_u = compute_gradient(u_vals, dz) if N > 1 else np.zeros(N)\n\n    # 3. Compute fluxes\n    if params:\n        Km_vals = case_data[\"Km_profile\"](z, h, params)\n    else:\n        Km_vals = case_data[\"Km_profile\"](z, h)\n        \n    tau_K = -Km_vals * grad_u\n    tau_LES = case_data[\"tau_les_profile\"](z, h, grad_u, Km_vals)\n    \n    # 4. Compute diagnostics\n    \n    # NRMSE\n    num_nrmse = np.sqrt(np.mean((tau_K - tau_LES)**2))\n    den_nrmse = np.sqrt(np.mean(tau_LES**2)) + epsilon\n    nrmse = num_nrmse / den_nrmse\n\n    # S (Magnitude-weighted sign mismatch)\n    sign_mismatch = (np.sign(tau_K) != np.sign(tau_LES)).astype(int)\n    num_s = np.sum(np.abs(tau_LES) * sign_mismatch)\n    den_s = np.sum(np.abs(tau_LES)) + epsilon\n    s_metric = num_s / den_s\n    \n    # r (Pearson correlation)\n    var_K = np.var(tau_K)\n    var_LES = np.var(tau_LES)\n    \n    use_r_criterion = (var_K > 0 and var_LES > 0)\n    if use_r_criterion:\n        # np.corrcoef returns a 2x2 matrix\n        r = np.corrcoef(tau_K, tau_LES)[0, 1]\n    else:\n        r = 0.0 # As per problem, set to 0 and do not use for decision\n    \n    # 5. Apply decision rule\n    is_non_local = False\n    if nrmse > A:\n        is_non_local = True\n    if s_metric > B:\n        is_non_local = True\n    if use_r_criterion and r < C:\n        is_non_local = True\n        \n    return 1 if is_non_local else 0\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}