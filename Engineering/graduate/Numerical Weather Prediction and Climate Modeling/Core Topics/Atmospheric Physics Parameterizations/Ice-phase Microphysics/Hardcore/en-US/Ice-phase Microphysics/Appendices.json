{
    "hands_on_practices": [
        {
            "introduction": "Homogeneous freezing is a fundamental pathway for ice formation in the atmosphere, occurring when supercooled solution droplets freeze spontaneously at very low temperatures. This exercise provides a practical application of the Koop criterion, a critical tool in atmospheric models for predicting this process. By combining aerosol properties with thermodynamic principles, you will calculate the specific temperature at which a droplet is expected to freeze, bridging the gap between aerosol chemistry and cloud-phase partitioning .",
            "id": "4054058",
            "problem": "A cloud microphysics module in a numerical weather prediction model represents homogeneous freezing of solution droplets using the water activity criterion. Consider a spherical aqueous ammonium sulfate solution droplet of diameter $0.2\\,\\mathrm{\\mu m}$ in liquid water equilibrium at near-saturation with respect to water vapor. The dry ammonium sulfate nucleus has diameter $0.1\\,\\mathrm{\\mu m}$. Assume the following physically realistic properties:\n- The solute is ammonium sulfate $\\left(\\mathrm{(NH_4)_2SO_4}\\right)$, fully dissociated with van 't Hoff factor $\\nu = 3$.\n- Solute density $\\rho_{s} = 1770\\,\\mathrm{kg\\,m^{-3}}$.\n- Liquid water density $\\rho_{w} = 1000\\,\\mathrm{kg\\,m^{-3}}$.\n- Molar mass of ammonium sulfate $M_{s} = 132.14\\,\\mathrm{g\\,mol^{-1}}$.\n- Molar mass of water $M_{w} = 18.015\\,\\mathrm{g\\,mol^{-1}}$.\n\nUsing Köhler theory, approximate the solution water activity by the ideal Raoult–van 't Hoff form $a_{w} \\approx \\dfrac{n_{w}}{n_{w} + \\nu n_{s}}$, where $n_{w}$ and $n_{s}$ are the moles of water and solute in the droplet, respectively. Compute $a_{w}$ from the given geometry and properties, taking the wet droplet radius $r = 1.0\\times 10^{-7}\\,\\mathrm{m}$ and dry nucleus radius $r_{d} = 5.0\\times 10^{-8}\\,\\mathrm{m}$, and assuming ideal volume additivity so that the liquid water volume is the wet volume minus the dry nucleus volume.\n\nThen, estimate the homogeneous freezing temperature $T$ (in Kelvin) of this solution droplet by applying the Koop criterion in the form of an empirically calibrated activity–temperature relation consistent with laboratory data for homogeneous freezing of aqueous solutions:\n$$\na_{w}(T) = a_{*}\\,\\exp\\!\\left(-\\alpha\\left(\\frac{1}{T} - \\frac{1}{T_{*}}\\right)\\right),\n$$\nwith $a_{*} = 0.85$, $T_{*} = 235\\,\\mathrm{K}$, and $\\alpha = 500\\,\\mathrm{K}$. Neglect curvature (Kelvin) effects in the activity for the purpose of the Koop criterion.\n\nDerive an analytical expression for $T$ in terms of $a_{w}$, $a_{*}$, $T_{*}$, and $\\alpha$, and evaluate it numerically using the $a_{w}$ you computed. Round your final temperature to four significant figures. Express the final temperature in Kelvin.",
            "solution": "The task is to compute the water activity $a_{w}$ of the solution droplet using Köhler theory’s bulk solution term (Raoult effect with van 't Hoff factor), and then invert the Koop criterion $a_{w}(T)$ to find the temperature $T$ at which homogeneous freezing is expected.\n\nStep 1: Compute geometric volumes of the dry nucleus and the wet droplet.\nThe dry nucleus radius is $r_{d} = 5.0\\times 10^{-8}\\,\\mathrm{m}$ and the wet droplet radius is $r = 1.0\\times 10^{-7}\\,\\mathrm{m}$. The spherical volumes are\n$$\nV_{d} = \\frac{4}{3}\\pi r_{d}^{3}, \\quad V_{w,\\mathrm{tot}} = \\frac{4}{3}\\pi r^{3}.\n$$\nNumerically,\n$$\nr_{d}^{3} = (5.0\\times 10^{-8}\\,\\mathrm{m})^{3} = 1.25\\times 10^{-22}\\,\\mathrm{m^{3}},\n$$\n$$\nV_{d} = \\frac{4}{3}\\pi \\times 1.25\\times 10^{-22} \\approx 5.235987756\\times 10^{-22}\\,\\mathrm{m^{3}},\n$$\n$$\nr^{3} = (1.0\\times 10^{-7}\\,\\mathrm{m})^{3} = 1.0\\times 10^{-21}\\,\\mathrm{m^{3}},\n$$\n$$\nV_{w,\\mathrm{tot}} = \\frac{4}{3}\\pi \\times 1.0\\times 10^{-21} \\approx 4.188790205\\times 10^{-21}\\,\\mathrm{m^{3}}.\n$$\nAssuming ideal volume additivity, the liquid water volume in the droplet is\n$$\nV_{w} = V_{w,\\mathrm{tot}} - V_{d} \\approx 4.188790205\\times 10^{-21} - 5.235987756\\times 10^{-22} = 3.665191429\\times 10^{-21}\\,\\mathrm{m^{3}}.\n$$\n\nStep 2: Convert volumes to masses and then to moles.\nSolute mass:\n$$\nm_{s} = \\rho_{s} V_{d} = 1770\\,\\mathrm{kg\\,m^{-3}} \\times 5.235987756\\times 10^{-22}\\,\\mathrm{m^{3}} \\approx 9.26669712\\times 10^{-19}\\,\\mathrm{kg}.\n$$\nIn grams,\n$$\nm_{s} = 9.26669712\\times 10^{-16}\\,\\mathrm{g}.\n$$\nSolute moles:\n$$\nn_{s} = \\frac{m_{s}}{M_{s}} = \\frac{9.26669712\\times 10^{-16}\\,\\mathrm{g}}{132.14\\,\\mathrm{g\\,mol^{-1}}} \\approx 7.011\\times 10^{-18}\\,\\mathrm{mol}.\n$$\nWater mass:\n$$\nm_{w} = \\rho_{w} V_{w} = 1000\\,\\mathrm{kg\\,m^{-3}} \\times 3.665191429\\times 10^{-21}\\,\\mathrm{m^{3}} \\approx 3.665191429\\times 10^{-18}\\,\\mathrm{kg}.\n$$\nIn grams,\n$$\nm_{w} = 3.665191429\\times 10^{-15}\\,\\mathrm{g}.\n$$\nWater moles:\n$$\nn_{w} = \\frac{m_{w}}{M_{w}} = \\frac{3.665191429\\times 10^{-15}\\,\\mathrm{g}}{18.015\\,\\mathrm{g\\,mol^{-1}}} \\approx 2.0345\\times 10^{-16}\\,\\mathrm{mol}.\n$$\n\nStep 3: Compute water activity using Raoult–van 't Hoff approximation.\nFor an ideal electrolyte solution with full dissociation and van 't Hoff factor $\\nu = 3$, the water activity is\n$$\na_{w} \\approx \\frac{n_{w}}{n_{w} + \\nu n_{s}}.\n$$\nSubstituting the values,\n$$\n\\nu n_{s} \\approx 3 \\times 7.011\\times 10^{-18} = 2.1033\\times 10^{-17}\\,\\mathrm{mol},\n$$\n$$\nn_{w} + \\nu n_{s} \\approx 2.0345\\times 10^{-16} + 2.1033\\times 10^{-17} = 2.2448\\times 10^{-16}\\,\\mathrm{mol},\n$$\n$$\na_{w} \\approx \\frac{2.0345\\times 10^{-16}}{2.2448\\times 10^{-16}} \\approx 0.9066.\n$$\n\nStep 4: Invert the Koop criterion to solve for $T$.\nThe Koop activity–temperature relation is specified as\n$$\na_{w}(T) = a_{*}\\,\\exp\\!\\left(-\\alpha\\left(\\frac{1}{T} - \\frac{1}{T_{*}}\\right)\\right),\n$$\nwith $a_{*} = 0.85$, $T_{*} = 235\\,\\mathrm{K}$, and $\\alpha = 500\\,\\mathrm{K}$.\n\nSet $a_{w}(T) = a_{w}$ and solve for $T$. First, divide both sides by $a_{*}$ and take the natural logarithm:\n$$\n\\ln\\!\\left(\\frac{a_{w}}{a_{*}}\\right) = -\\alpha\\left(\\frac{1}{T} - \\frac{1}{T_{*}}\\right).\n$$\nRearrange for $1/T$:\n$$\n\\frac{1}{T} = \\frac{1}{T_{*}} - \\frac{1}{\\alpha}\\,\\ln\\!\\left(\\frac{a_{w}}{a_{*}}\\right).\n$$\nThus,\n$$\nT = \\left[\\frac{1}{T_{*}} - \\frac{1}{\\alpha}\\,\\ln\\!\\left(\\frac{a_{w}}{a_{*}}\\right)\\right]^{-1}.\n$$\n\nStep 5: Evaluate numerically and round to four significant figures.\nCompute the ratio and its logarithm:\n$$\n\\frac{a_{w}}{a_{*}} = \\frac{0.9066}{0.85} \\approx 1.0666, \\quad \\ln\\!\\left(\\frac{a_{w}}{a_{*}}\\right) \\approx \\ln(1.0666) \\approx 0.0645.\n$$\nCompute $1/T$:\n$$\n\\frac{1}{T} = \\frac{1}{235\\,\\mathrm{K}} - \\frac{1}{500\\,\\mathrm{K}} \\times 0.0645 \\approx 0.004255319 - 0.0001290 = 0.0041263\\,\\mathrm{K^{-1}}.\n$$\nInvert to obtain $T$:\n$$\nT \\approx \\frac{1}{0.0041263}\\,\\mathrm{K} \\approx 242.3\\,\\mathrm{K}.\n$$\nRounded to four significant figures and expressed in Kelvin, the homogeneous freezing temperature estimate is $242.3\\,\\mathrm{K}$.",
            "answer": "$$\\boxed{242.3}$$"
        },
        {
            "introduction": "Once ice crystals form, they grow by vapor deposition, a process heavily influenced by their shape, or 'habit'. This practice demonstrates a core concept in microphysics parameterization: scaling up from the properties of single particles to the behavior of a bulk population. You will derive and compute an effective growth coefficient for a mixed population of ice crystals, a crucial step for representing ice growth in large-scale atmospheric models .",
            "id": "4054067",
            "problem": "Consider an ice-phase microphysics module embedded in a Numerical Weather Prediction (NWP) and climate model that represents vapor deposition onto nonspherical ice crystals. Under steady, diffusion-limited growth, the vapor flux to an isolated crystal is governed by Fick’s law and the steady heat equation, which together imply a near-linear relationship between the single-particle mass growth rate and the ice supersaturation for small departures from saturation. For each crystal habit $h$ (e.g., plates or columns), the single-particle deposition mass growth rate is approximated by\n$$\\frac{dm_h}{dt} \\approx C_h \\left(S_i - 1\\right),$$\nwhere $S_i$ is the saturation ratio with respect to ice, and $C_h$ is a habit-dependent deposition growth coefficient that encapsulates geometric capacitance, ventilation effects, and the combined diffusive and thermal resistances of air.\n\nA mixed population of ice crystals occupies a unit volume of air with total number concentration $N$ and habit fractions $f_P$ for plates and $f_C$ for columns, satisfying $f_P + f_C = 1$. Assume the following conditions, representative of a mid-tropospheric cloud layer:\n- Temperature $T = 258\\,\\mathrm{K}$ and pressure $p = 700\\,\\mathrm{hPa}$.\n- Total ice number concentration $N = 2.0 \\times 10^{5}\\,\\mathrm{m}^{-3}$.\n- Habit fractions $f_P = 0.65$ and $f_C = 0.35$.\n- Habit-specific single-particle deposition coefficients (thermodynamically and aerodynamically corrected) at these conditions:\n  $C_P = 4.8 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}}$ for plates and $C_C = 6.0 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}}$ for columns.\n\nStarting from mass conservation and the linear superposition principle implied by the diffusion and heat conduction governing equations, derive the habit-weighted bulk deposition growth coefficient $C_{\\mathrm{eff}}$ such that the total vapor-to-ice deposition tendency per unit volume can be written as\n$$\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} = C_{\\mathrm{eff}} \\left(S_i - 1\\right).$$\nCompute the numerical value of $C_{\\mathrm{eff}}$ using the provided parameters. Express your final answer in $\\mathrm{kg\\,m^{-3}\\,s^{-1}}$ and round your answer to four significant figures.",
            "solution": "The total vapor-to-ice deposition tendency per unit volume, denoted $\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}}$, represents the sum of the mass growth rates of all individual ice crystals within that volume. The problem statement refers to a \"linear superposition principle,\" which implies that the total growth rate is the sum of the growth rates of all individual particles, assuming they grow independently without competing for the same local vapor.\n\nA unit volume of air contains a total of $N$ ice crystals. This population is composed of two habits: plates ($P$) and columns ($C$). The number concentration of each habit is given by the total concentration multiplied by the respective habit fraction:\n- Number concentration of plates: $N_P = N f_P$\n- Number concentration of columns: $N_C = N f_C$\n\nThe total mass growth rate per unit volume is the sum of the contributions from all plates and all columns in that volume.\n$$\n\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} = N_P \\left(\\frac{dm_P}{dt}\\right) + N_C \\left(\\frac{dm_C}{dt}\\right)\n$$\nHere, $\\frac{dm_P}{dt}$ and $\\frac{dm_C}{dt}$ are the single-particle mass growth rates for plates and columns, respectively. The problem provides the linear approximation for these rates:\n$$\n\\frac{dm_P}{dt} \\approx C_P (S_i - 1)\n$$\n$$\n\\frac{dm_C}{dt} \\approx C_C (S_i - 1)\n$$\nSubstituting these expressions into the equation for the bulk growth rate:\n$$\n\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} \\approx N_P \\left[ C_P (S_i - 1) \\right] + N_C \\left[ C_C (S_i - 1) \\right]\n$$\nNow, we substitute the expressions for $N_P$ and $N_C$:\n$$\n\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} \\approx (N f_P) C_P (S_i - 1) + (N f_C) C_C (S_i - 1)\n$$\nWe can factor out the common terms $N$ and $(S_i - 1)$:\n$$\n\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} \\approx \\left[ N (f_P C_P + f_C C_C) \\right] (S_i - 1)\n$$\nThis derived expression has the same form as the target equation provided in the problem statement:\n$$\n\\left.\\frac{dM_{\\mathrm{dep}}}{dt}\\right|_{\\mathrm{bulk}} = C_{\\mathrm{eff}} (S_i - 1)\n$$\nBy direct comparison, we identify the habit-weighted bulk deposition growth coefficient, $C_{\\mathrm{eff}}$:\n$$\nC_{\\mathrm{eff}} = N (f_P C_P + f_C C_C)\n$$\nThis expression shows that the effective bulk coefficient is the total number concentration multiplied by the habit-fraction-weighted average of the single-particle deposition coefficients.\n\nWe now compute the numerical value of $C_{\\mathrm{eff}}$ using the provided parameters:\n- $N = 2.0 \\times 10^{5}\\,\\mathrm{m}^{-3}$\n- $f_P = 0.65$\n- $C_P = 4.8 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}}$\n- $f_C = 0.35$\n- $C_C = 6.0 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}}$\n\nFirst, we calculate the weighted-average single-particle coefficient:\n$$\nf_P C_P + f_C C_C = (0.65)(4.8 \\times 10^{-11}) + (0.35)(6.0 \\times 10^{-11})\n$$\n$$\nf_P C_P + f_C C_C = (3.12 \\times 10^{-11}) + (2.10 \\times 10^{-11}) = 5.22 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}}\n$$\nNext, we multiply by the total number concentration $N$:\n$$\nC_{\\mathrm{eff}} = (2.0 \\times 10^{5}\\,\\mathrm{m}^{-3}) \\times (5.22 \\times 10^{-11}\\,\\mathrm{kg\\,s^{-1}})\n$$\n$$\nC_{\\mathrm{eff}} = (2.0 \\times 5.22) \\times (10^{5} \\times 10^{-11})\\,\\mathrm{kg\\,m^{-3}\\,s^{-1}}\n$$\n$$\nC_{\\mathrm{eff}} = 10.44 \\times 10^{-6}\\,\\mathrm{kg\\,m^{-3}\\,s^{-1}}\n$$\nTo express this in standard scientific notation, we adjust the mantissa and exponent:\n$$\nC_{\\mathrm{eff}} = 1.044 \\times 10^{-5}\\,\\mathrm{kg\\,m^{-3}\\,s^{-1}}\n$$\nThe problem requires the answer to be rounded to four significant figures. The calculated value $1.044 \\times 10^{-5}$ already has four significant figures.",
            "answer": "$$\\boxed{1.044 \\times 10^{-5}}$$"
        },
        {
            "introduction": "Ice crystals not only grow individually but also interact, colliding and sticking together in a process known as aggregation, which profoundly alters the ice particle size distribution. This advanced computational exercise challenges you to design a numerical scheme for aggregation that adheres to a fundamental physical constraint: the conservation of mass. Implementing a conservative scheme for the Smoluchowski coagulation equation is a foundational skill in developing robust and physically realistic microphysics models .",
            "id": "4054051",
            "problem": "In ice-phase microphysics for Numerical Weather Prediction (NWP) and climate models, the aggregation (coagulation) of ice particles changes the number concentration distribution while conserving total ice mass. Consider the continuous Smoluchowski coagulation equation for the number concentration distribution $n(m,t)$ over particle mass $m$:\n$$\n\\frac{\\partial n(m,t)}{\\partial t}\n=\n\\frac{1}{2}\\int_{0}^{m} K(m',m-m')\\,n(m',t)\\,n(m-m',t)\\,\\mathrm{d}m'\n-\nn(m,t)\\int_{0}^{\\infty} K(m,m')\\,n(m',t)\\,\\mathrm{d}m',\n$$\nwhere $K(m,m')$ is the symmetric coagulation kernel with units $\\mathrm{m^3\\,s^{-1}}$.\n\nDesign a conservative numerical scheme with fixed pivots for the coagulation integral on a discrete mass grid $\\{m_k\\}_{k=0}^{K-1}$, with fixed bin pivot masses $m_k$ (in $\\mathrm{kg}$) and number concentrations $\\{N_k\\}_{k=0}^{K-1}$ (in $\\mathrm{m^{-3}}$). Your scheme must:\n- Discretize the gain and loss terms from first principles without using any pre-derived discretization shortcuts.\n- Preserve the discrete first moment (total mass) $M(t)=\\sum_{k=0}^{K-1} m_k N_k(t)$ exactly in the limit of perfect arithmetic, for any explicit forward-Euler time step $\\Delta t$ (in $\\mathrm{s}$) small enough to maintain nonnegativity.\n- Use mass-proportional redistribution to the two nearest pivots that bracket an aggregate product mass $m_p=m_i+m_j$.\n- Treat pair production rates consistently with the symmetry of collisions, ensuring pairs $(i,j)$ with $i\\neq j$ are counted once and self-collisions $(i=j)$ are not double-counted.\n\nStarting only from the continuous integral equation above and the definitions of the discrete binning, derive the fixed-pivot redistribution weights that guarantee discrete mass conservation, and implement the scheme to perform one forward-Euler update:\n$$\nN_k^{(t+\\Delta t)} = N_k^{(t)} + \\Delta t\\left(S_k - L_k\\right),\n$$\nwhere $S_k$ is the source from aggregation gains into bin $k$ and $L_k$ is the loss from particles in bin $k$ participating in collisions, both with units $\\mathrm{m^{-3}\\,s^{-1}}$.\n\nYour program must:\n- Implement the kernel $K(m_i,m_j)$ for each test case specified below.\n- Compute the updated $\\{N_k\\}$ after a single time step $\\Delta t$ using the conservative fixed-pivot scheme that you derive.\n- Verify and report the absolute mass conservation error\n$$\nE = \\left|\\sum_{k=0}^{K-1} m_k N_k^{(t+\\Delta t)} - \\sum_{k=0}^{K-1} m_k N_k^{(t)}\\right|\n$$\nin units of kilograms per cubic meter ($\\mathrm{kg\\,m^{-3}}$), expressed as a floating-point number.\n- Assert that all aggregate product masses $m_p=m_i+m_j$ occurring with nonzero production rate lie within the pivot range $[m_0,m_{K-1}]$ so that bracketing by two pivots is well-defined. If this condition is violated, the scheme must not proceed (for the provided test suite this condition holds by construction).\n\nPhysical units and conventions:\n- Masses $m_k$ are in $\\mathrm{kg}$.\n- Number concentrations $N_k$ are in $\\mathrm{m^{-3}}$.\n- Kernel $K(m_i,m_j)$ is in $\\mathrm{m^3\\,s^{-1}}$.\n- Time step $\\Delta t$ is in $\\mathrm{s}$.\n- The conservation error $E$ must be reported in $\\mathrm{kg\\,m^{-3}}$.\n\nTest suite (all tests use the same pivot set of $K=5$ bins with geometric progression by factor $2$: $m_0=10^{-12}\\,\\mathrm{kg}$, $m_1=2\\times 10^{-12}\\,\\mathrm{kg}$, $m_2=4\\times 10^{-12}\\,\\mathrm{kg}$, $m_3=8\\times 10^{-12}\\,\\mathrm{kg}$, $m_4=16\\times 10^{-12}\\,\\mathrm{kg}$):\n- Test $1$ (happy path, constant kernel):\n  - Kernel: $K(m_i,m_j)=K_0$ with $K_0=10^{-12}\\,\\mathrm{m^3\\,s^{-1}}$.\n  - Initial $N$: $[10^{5},\\,5\\times 10^{4},\\,2\\times 10^{4},\\,10^{4},\\,0]\\,\\mathrm{m^{-3}}$.\n  - $\\Delta t = 5\\,\\mathrm{s}$.\n- Test $2$ (mass-dependent additive kernel, moderate change):\n  - Kernel: $K(m_i,m_j)=\\beta\\,(m_i+m_j)$ with $\\beta=10\\,\\mathrm{m^3\\,s^{-1}\\,kg^{-1}}$.\n  - Initial $N$: $[5\\times 10^{4},\\,5\\times 10^{4},\\,0,\\,2\\times 10^{4},\\,0]\\,\\mathrm{m^{-3}}$.\n  - $\\Delta t = 0.5\\,\\mathrm{s}$.\n- Test $3$ (boundary bracketing exactly at top pivot, constant kernel):\n  - Kernel: $K(m_i,m_j)=K_0$ with $K_0=5\\times 10^{-13}\\,\\mathrm{m^3\\,s^{-1}}$.\n  - Initial $N$: $[0,\\,0,\\,3\\times 10^{4},\\,3\\times 10^{4},\\,0]\\,\\mathrm{m^{-3}}$.\n  - $\\Delta t = 10\\,\\mathrm{s}$.\n- Test $4$ (tiny time step, constant kernel, stability check):\n  - Kernel: $K(m_i,m_j)=K_0$ with $K_0=10^{-12}\\,\\mathrm{m^3\\,s^{-1}}$.\n  - Initial $N$: $[10^{5},\\,10^{5},\\,10^{5},\\,0,\\,0]\\,\\mathrm{m^{-3}}$.\n  - $\\Delta t = 10^{-6}\\,\\mathrm{s}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the conservation errors for the four tests, as a comma-separated list enclosed in square brackets, for example: \"[e1,e2,e3,e4]\". Each $e_i$ must be a floating-point number representing the absolute mass conservation error $E$ in $\\mathrm{kg\\,m^{-3}}$ for the corresponding test.",
            "solution": "The user has provided a valid problem statement. The task is to derive and implement a mass-conserving numerical scheme for the Smoluchowski coagulation equation on a discrete mass grid.\n\n### **1. Discretization Framework**\n\nThe continuous Smoluchowski coagulation equation describes the time evolution of the number concentration distribution $n(m,t)$ as a function of particle mass $m$ and time $t$:\n$$\n\\frac{\\partial n(m,t)}{\\partial t}\n=\n\\underbrace{\\frac{1}{2}\\int_{0}^{m} K(m',m-m')\\,n(m',t)\\,n(m-m',t)\\,\\mathrm{d}m'}_{\\text{Gain Term}}\n-\n\\underbrace{n(m,t)\\int_{0}^{\\infty} K(m,m')\\,n(m',t)\\,\\mathrm{d}m'}_{\\text{Loss Term}}\n$$\nWe are discretizing this equation onto a fixed set of mass pivots $\\{m_k\\}_{k=0}^{K-1}$, with corresponding number concentrations $\\{N_k\\}_{k=0}^{K-1}$ in units of $\\mathrm{m^{-3}}$. The time evolution is approximated using a forward-Euler step:\n$$\nN_k^{(t+\\Delta t)} = N_k^{(t)} + \\Delta t\\left(S_k - L_k\\right)\n$$\nHere, $L_k$ and $S_k$ are the discrete rates of loss and source (gain) for particles in bin $k$, respectively, in units of $\\mathrm{m^{-3}\\,s^{-1}}$. Our primary goal is to derive expressions for $S_k$ and $L_k$ that guarantee the conservation of total mass $M = \\sum_{k=0}^{K-1} m_k N_k$.\n\n### **2. Derivation of the Loss Term ($L_k$)**\n\nThe loss term in the continuous equation represents the removal of particles of mass $m$ due to collisions with any other particle. In our discrete framework, a particle from bin $k$ (mass $m_k$, concentration $N_k$) is lost when it collides with a particle from any bin $j$ (mass $m_j$, concentration $N_j$), where $j$ can range from $0$ to $K-1$.\n\nThe rate of collisions per unit volume between particles from bin $k$ and bin $j$ is given by $K(m_k, m_j) N_k N_j$, where $K(m_k, m_j)$ is the coagulation kernel. To find the total loss rate for particles in bin $k$, we sum the rates of its collisions with particles from all bins:\n$$\nL_k = N_k \\sum_{j=0}^{K-1} K(m_k, m_j) N_j\n$$\nThis expression is the direct discretization of the integral loss term. The total mass loss rate for the entire system is the sum of mass lost from all bins:\n$$\n\\text{Total Mass Loss Rate} = \\sum_{k=0}^{K-1} m_k L_k = \\sum_{k=0}^{K-1} m_k N_k \\sum_{j=0}^{K-1} K(m_k, m_j) N_j = \\sum_{k=0}^{K-1} \\sum_{j=0}^{K-1} m_k K(m_k, m_j) N_k N_j\n$$\n\n### **3. Derivation of the Gain Term ($S_k$)**\n\nThe gain term represents the formation of new particles. In the discrete model, a collision between a particle from bin $i$ and a particle from bin $j$ produces a new aggregate particle of mass $m_p = m_i + m_j$.\n\nTo avoid double-counting, we sum over unique pairs $(i,j)$ where $i \\le j$. The rate of formation of new particles from such a pair is:\n$$\n\\hat{C}_{ij} = \\begin{cases} K(m_i, m_j) N_i N_j  \\text{if } i  j \\\\ \\frac{1}{2} K(m_i, m_i) N_i^2  \\text{if } i = j \\end{cases}\n$$\nThe factor of $\\frac{1}{2}$ for self-collisions ($i=j$) corrects for the fact that each collision involves two identical particles, and we are counting pairs.\n\nThe newly formed particle of mass $m_p$ will generally not coincide with a grid pivot. The problem specifies a mass-proportional redistribution scheme to the two nearest bracketing pivots. Let these pivots be $m_k$ and $m_{k+1}$, such that $m_k \\le m_p \\le m_{k+1}$. Each aggregate of mass $m_p$ must be represented as a combination of particles at these two pivots. We introduce fractional particle numbers, $f_k$ and $f_{k+1}$, that represent the number of particles at each pivot needed to represent one particle of mass $m_p$. To conserve both particle number and mass *during the redistribution step*, we require:\n$$\n\\begin{cases} 1 = f_k + f_{k+1}  (\\text{number conservation}) \\\\ m_p = f_k m_k + f_{k+1} m_{k+1}  (\\text{mass conservation}) \\end{cases}\n$$\nSolving this system for the redistribution weights $f_k$ and $f_{k+1}$ yields:\n$$\nf_k = \\frac{m_{k+1} - m_p}{m_{k+1} - m_k} \\quad \\text{and} \\quad f_{k+1} = \\frac{m_p - m_k}{m_{k+1} - m_k}\n$$\nThese are the standard linear interpolation weights. For each collision event $(i,j)$, the number production rate $\\hat{C}_{ij}$ is partitioned into source rates for bins $k$ and $k+1$:\n- Contribution to $S_k$: $\\hat{C}_{ij} \\cdot f_k$\n- Contribution to $S_{k+1}$: $\\hat{C}_{ij} \\cdot f_{k+1}$\nIf $m_p$ falls exactly on a pivot, e.g., $m_p = m_k$, then $f_k=1$ and $f_{k+1}=0$ (and $f_{k-1}=0$), so the entire production rate $\\hat{C}_{ij}$ is added to $S_k$.\n\nThe total source term $S_k$ for bin $k$ is the sum of all such contributions from all possible collision pairs $(i,j)$ that deposit mass into bin $k$.\n\n### **4. Proof of Mass Conservation**\n\nTo prove that the scheme is mass-conserving, we must show that the total mass gain rate equals the total mass loss rate. The mass added to the system per unit time from a single collision event $(i,j)$ is:\n$$\n\\text{Mass Rate Gain from }(i,j) = m_k (\\hat{C}_{ij} f_k) + m_{k+1} (\\hat{C}_{ij} f_{k+1}) = \\hat{C}_{ij} (m_k f_k + m_{k+1} f_{k+1})\n$$\nBy construction of the weights $f_k$ and $f_{k+1}$, we have $m_k f_k + m_{k+1} f_{k+1} = m_p$. Therefore:\n$$\n\\text{Mass Rate Gain from }(i,j) = \\hat{C}_{ij} m_p = \\hat{C}_{ij} (m_i + m_j)\n$$\nThe total mass gain rate for the system is the sum over all unique collision pairs:\n$$\n\\text{Total Mass Gain Rate} = \\sum_{k=0}^{K-1} m_k S_k = \\sum_{i=0}^{K-1} \\sum_{j=i}^{K-1} (m_i + m_j) \\hat{C}_{ij}\n$$\nNow, we rewrite the total mass loss rate using the definition of $\\hat{C}_{ij}$:\n$$\n\\text{Total Mass Loss Rate} = \\sum_{i=0}^{K-1} \\sum_{j=0}^{K-1} m_i K(m_i, m_j) N_i N_j\n$$\nUsing the symmetry of the kernel, $K(m_i, m_j) = K(m_j, m_i)$, we can write:\n$$\n\\text{Total Mass Loss Rate} = \\frac{1}{2} \\sum_{i=0}^{K-1} \\sum_{j=0}^{K-1} (m_i + m_j) K(m_i, m_j) N_i N_j = \\sum_{ij} (m_i+m_j) K_{ij}N_iN_j + \\sum_{i=j} (m_i+m_i) \\frac{1}{2}K_{ii}N_i^2 = \\sum_{i\\le j} (m_i+m_j)\\hat{C}_{ij}\n$$\nThus, the total mass gain rate is exactly equal to the total mass loss rate. The time rate of change of total system mass is zero:\n$$\n\\frac{\\mathrm{d}M}{\\mathrm{d}t} = \\sum_{k=0}^{K-1} m_k \\frac{\\mathrm{d}N_k}{\\mathrm{d}t} = \\sum_{k=0}^{K-1} m_k(S_k - L_k) = \\sum_{i \\le j} (m_i+m_j)\\hat{C}_{ij} - \\sum_{i \\le j} (m_i+m_j)\\hat{C}_{ij} = 0\n$$\nThis confirms that the scheme conserves mass exactly, limited only by floating-point precision. The reported error $E$ will quantify this numerical precision limit.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that runs the test suite and prints the final results.\n    \"\"\"\n\n    # Define the common mass grid for all test cases.\n    m_pivots = np.array([1e-12, 2e-12, 4e-12, 8e-12, 16e-12], dtype=np.float64)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"name\": \"Test 1 (happy path, constant kernel)\",\n            \"kernel_func\": lambda m_i, m_j: 1e-12,\n            \"N_initial\": np.array([1e5, 5e4, 2e4, 1e4, 0], dtype=np.float64),\n            \"dt\": 5.0\n        },\n        {\n            \"name\": \"Test 2 (mass-dependent additive kernel, moderate change)\",\n            \"kernel_func\": lambda m_i, m_j: 10.0 * (m_i + m_j),\n            \"N_initial\": np.array([5e4, 5e4, 0, 2e4, 0], dtype=np.float64),\n            \"dt\": 0.5\n        },\n        {\n            \"name\": \"Test 3 (boundary bracketing exactly at top pivot, constant kernel)\",\n            \"kernel_func\": lambda m_i, m_j: 5e-13,\n            \"N_initial\": np.array([0, 0, 3e4, 3e4, 0], dtype=np.float64),\n            \"dt\": 10.0\n        },\n        {\n            \"name\": \"Test 4 (tiny time step, constant kernel, stability check)\",\n            \"kernel_func\": lambda m_i, m_j: 1e-12,\n            \"N_initial\": np.array([1e5, 1e5, 1e5, 0, 0], dtype=np.float64),\n            \"dt\": 1e-6\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        error = run_coagulation_step(m_pivots, case[\"N_initial\"], case[\"dt\"], case[\"kernel_func\"])\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_coagulation_step(m_grid, N_initial, dt, kernel_func):\n    \"\"\"\n    Performs one time step of coagulation using the derived conservative scheme.\n\n    Args:\n        m_grid (np.ndarray): Array of mass pivots (kg).\n        N_initial (np.ndarray): Array of initial number concentrations (m^-3).\n        dt (float): Time step (s).\n        kernel_func (callable): Function K(m_i, m_j) returning the kernel value (m^3 s^-1).\n\n    Returns:\n        float: Absolute mass conservation error (kg m^-3).\n    \"\"\"\n    K = len(m_grid)\n    N = np.copy(N_initial)\n\n    # 1. Calculate initial total mass\n    M_initial = np.sum(m_grid * N)\n\n    # 2. Pre-compute the symmetric kernel matrix\n    K_matrix = np.zeros((K, K), dtype=np.float64)\n    for i in range(K):\n        for j in range(i, K):\n            val = kernel_func(m_grid[i], m_grid[j])\n            K_matrix[i, j] = val\n            K_matrix[j, i] = val\n\n    # 3. Calculate the loss term vector L\n    L = N * (K_matrix @ N)\n\n    # 4. Calculate the source term vector S\n    S = np.zeros(K, dtype=np.float64)\n    for i in range(K):\n        for j in range(i, K):\n            if N[i] == 0.0 or N[j] == 0.0:\n                continue\n\n            # Calculate the number production rate for the pair (i, j)\n            if i == j:\n                C_ij = 0.5 * K_matrix[i, i] * N[i] * N[i]\n            else:  # i  j\n                C_ij = K_matrix[i, j] * N[i] * N[j]\n            \n            # Form aggregate particle and check if it's within the grid mass range\n            m_p = m_grid[i] + m_grid[j]\n            \n            if not (m_grid[0] = m_p = m_grid[-1]):\n                # Per problem, this condition is satisfied by the test suite.\n                # In a real model, this mass would need to be handled.\n                raise ValueError(f\"Product mass {m_p} is outside the grid range [{m_grid[0]}, {m_grid[-1]}]\")\n\n            # Find bracketing pivots and redistribute mass\n            # 'searchsorted' finds the insertion index to maintain order. 'left' side returns the first suitable index.\n            k_high_idx = np.searchsorted(m_grid, m_p, side='left')\n\n            # Case 1: Product mass falls exactly on a pivot\n            if k_high_idx  K and np.isclose(m_grid[k_high_idx], m_p):\n                S[k_high_idx] += C_ij\n            # Case 2: Product mass falls between two pivots\n            else:\n                k_low_idx = k_high_idx - 1\n                \n                m_low = m_grid[k_low_idx]\n                m_high = m_grid[k_high_idx]\n                \n                denominator = m_high - m_low\n                \n                # These are the derived mass-conserving redistribution weights\n                weight_low = (m_high - m_p) / denominator\n                weight_high = (m_p - m_low) / denominator\n                \n                S[k_low_idx] += C_ij * weight_low\n                S[k_high_idx] += C_ij * weight_high\n\n    # 5. Update number concentrations using forward Euler\n    N_new = N + dt * (S - L)\n    \n    # 6. Calculate final total mass\n    M_final = np.sum(m_grid * N_new)\n    \n    # 7. Calculate and return the absolute mass conservation error\n    error = np.abs(M_final - M_initial)\n    return error\n\nsolve()\n```"
        }
    ]
}