{
    "hands_on_practices": [
        {
            "introduction": "协方差局地化是集合卡尔曼滤波器（EnKF）中一项至关重要的技术，旨在抑制因集合规模有限而产生的虚假远距离相关。本练习将引导您深入理解局地化在数学层面的具体作用，通过推导局地化卡尔曼增益并计算其在一个简化一维网格上的效应，您将亲眼见证观测信息的影响是如何被有效地约束在空间局部范围内的。这项基本练习有助于为掌握更复杂的资料同化方案奠定坚实的数学基础 。",
            "id": "4036640",
            "problem": "考虑一个用于数值天气预报的一维离散状态，其网格点由 $i \\in \\{1,2,3,4,5\\}$ 索引，位于位置 $x_i = i - 3$，因此物理位置为 $x_1=-2$、$x_2=-1$、$x_3=0$、$x_4=1$ 和 $x_5=2$。设先验（预报）状态由集合卡尔曼滤波器（EnKF）的大集合极限表示，因此预报误差协方差由一个参数化的、均匀的、各向同性的核 $P^{f}$ 精确给出，其元素为\n$$\nP^{f}_{ij} = \\sigma^{2} \\exp\\!\\left(-\\frac{|x_i - x_j|}{a}\\right),\n$$\n其中 $\\sigma^{2}>0$ 是先验方差尺度，而 $a>0$ 是相关长度尺度。设观测值通过一个已知算子 $H$ 与状态呈线性关系，并受到均值为零、协方差为 $R$ 的高斯噪声污染。贝叶斯线性分析寻求最小化均方分析误差的最佳线性估计量，其集合卡尔曼滤波器对应方法采用协方差局地化来减少采样误差和虚假的长程相关。协方差局地化通过将预报协方差与一个锥化矩阵 $C$ 进行逐元素（舒尔）乘积来执行，其中 $C$ 的元素由一个正定的、紧支撑或快速衰减的距离相关函数给出。具体来说，将局地化预报协方差 $\\tilde{P}^{f}$ 定义为\n$$\n\\tilde{P}^{f} = C \\circ P^{f},\n$$\n其中 $\\circ$ 表示逐元素乘法，在本问题中，$C$ 被取为一个高斯锥化矩阵，其元素为\n$$\nC_{ij} = \\exp\\!\\left(-\\left(\\frac{|x_i - x_j|}{\\ell}\\right)^{2}\\right),\n$$\n其中局地化长度尺度 $\\ell>0$。假设一个单一的标量观测测量中心网格点的状态，因此 $H$ 选择 $x_3=0$ 处的份量。先验方差尺度为 $\\sigma^{2}=1$，相关长度为 $a=1$，局地化长度为 $\\ell=\\frac{3}{2}$，观测误差方差为 $R=\\frac{1}{3}$。给定的标量新息为 $d = y - H x^{f} = \\frac{1}{2}$。\n\n任务：\n- 仅从贝叶斯线性估计量的定义和线性分析更新的均方最优性出发，并使用上述舒尔乘积的局地化方法，推导局地化分析增益关于 $\\tilde{P}^{f}$、$H$ 和 $R$ 的表达式。\n- 使用您推导的表达式，分析协方差局地化如何影响此一维网格上分析增量的空间结构，然后计算网格点 $x_2=-1$ 处的分析增量，结果为一个单一的封闭形式解析表达式。以精确形式表达您的最终答案；不要进行数值四舍五入或近似计算。您的最终表达式中不需要物理单位。",
            "solution": "该问题被评估为有效，因为它在科学上基于数据同化原理，在数学上是适定的，提供了所有必要信息，并且以客观、正式的语言陈述。我们开始求解。\n\n该问题要求完成两个主要任务：首先，推导局地化卡尔曼增益的表达式；其次，计算特定网格点处的分析增量。\n\n**第1部分：局地化分析增益的推导**\n\n最优线性估计量，即分析状态 $x^a$，是使用观测值 $y$ 对预报状态 $x^f$ 进行的线性更新。其形式为：\n$$x^a = x^f + K(y - Hx^f)$$\n其中 $K$ 是分析增益矩阵。项 $d = y - Hx^f$ 是新息。选择增益 $K$ 以最小化均方分析误差，即分析误差协方差矩阵 $P^a = \\mathbb{E}[(x^a - x_{true})(x^a - x_{true})^T]$ 的迹。\n\n分析误差 $e^a = x^a - x_{true}$ 可以用预报误差 $e^f = x^f - x_{true}$ 和观测误差 $v$ 来表示，其中 $y = Hx_{true} + v$。\n$$e^a = (x^f + K(y - Hx^f)) - x_{true}$$\n$$e^a = (x^f - x_{true}) + K(Hx_{true} + v - Hx^f)$$\n$$e^a = e^f - K(H(x^f - x_{true}) - v) = e^f - K(He^f - v)$$\n$$e^a = (I - KH)e^f + Kv$$\n那么分析误差协方差 $P^a$ 为：\n$$P^a = \\mathbb{E}[((I - KH)e^f + Kv)((I - KH)e^f + Kv)^T]$$\n假设预报误差和观测误差不相关，即 $\\mathbb{E}[e^f v^T] = 0$，则表达式简化。设 $P^f = \\mathbb{E}[e^f(e^f)^T]$ 为预报误差协方差，$R = \\mathbb{E}[vv^T]$ 为观测误差协方差。\n$$P^a = (I - KH)\\mathbb{E}[e^f(e^f)^T](I - KH)^T + K\\mathbb{E}[vv^T]K^T$$\n$$P^a = (I - KH)P^f(I - KH)^T + KRK^T$$\n为找到最小化均方误差 $\\text{tr}(P^a)$ 的最优增益 $K$，我们将 $\\text{tr}(P^a)$ 对 $K$ 求导并令其结果为零。\n$$\\frac{\\partial}{\\partial K} \\text{tr}(P^a) = \\frac{\\partial}{\\partial K} \\text{tr}\\left(P^f - KHP^f - P^fH^TK^T + KHP^fH^TK^T + KRK^T\\right) = 0$$\n使用标准的矩阵求导恒等式，以及 $P^f$ 和 $R$ 是对称矩阵的事实，可得：\n$$-2P^fH^T + 2K(HP^fH^T + R) = 0$$\n求解 $K$，我们得到标准的卡尔曼增益公式：\n$$K = P^fH^T(HP^fH^T + R)^{-1}$$\n问题陈述应用了协方差局地化。这意味着预报误差协方差 $P^f$ 被局地化预报误差协方差 $\\tilde{P}^f = C \\circ P^f$ 所取代，其中 $\\circ$ 是舒尔（逐元素）乘积。因此，通过将 $\\tilde{P}^f$ 代入增益公式，可以找到我们记为 $\\tilde{K}$ 的局地化分析增益：\n$$\\tilde{K} = \\tilde{P}^f H^T (H \\tilde{P}^f H^T + R)^{-1}$$\n这就是推导出的局地化分析增益的表达式。\n\n**第2部分：分析增量的分析与计算**\n\n分析增量 $\\delta x^a$ 是应用于预报状态的修正量：\n$$\\delta x^a = x^a - x^f = \\tilde{K}d$$\n其中 $d$ 是给定的标量新息 $d = \\frac{1}{2}$。\n\n状态向量是 $5$ 维的，对应于 $i \\in \\{1, 2, 3, 4, 5\\}$ 的网格点 $x_i$。观测是在中心网格点 $x_3=0$ 处的单个标量测量。这意味着观测算子 $H$ 是一个 $1 \\times 5$ 的行向量：\n$$H = \\begin{pmatrix} 0 & 0 & 1 & 0 & 0 \\end{pmatrix}$$\n因此，$H^T$ 是一个 $5 \\times 1$ 的列向量，它选择其右乘矩阵的第三列。项 $H \\tilde{P}^f H^T$ 变为标量元素 $\\tilde{P}^f_{33}$。项 $\\tilde{P}^f H^T$ 变为 $\\tilde{P}^f$ 的第三列。增益 $\\tilde{K}$ 是一个 $5 \\times 1$ 的列向量：\n$$\\tilde{K} = \\frac{1}{\\tilde{P}^f_{33} + R} \\begin{pmatrix} \\tilde{P}^f_{13} \\\\ \\tilde{P}^f_{23} \\\\ \\tilde{P}^f_{33} \\\\ \\tilde{P}^f_{43} \\\\ \\tilde{P}^f_{53} \\end{pmatrix}$$\n分析增量向量为 $\\delta x^a = \\tilde{K}d$。在网格点 $x_i$ 处的增量分量为 $(\\delta x^a)_i = \\tilde{K}_i d$。\n\n局地化的作用是调制分析增量。如果没有局地化，网格点 $i$ 处的增量将与点 $i$ 和点 $3$ 之间的预报误差协方差成正比，即 $P^f_{i3}$。经过局地化后，增量与 $\\tilde{P}^f_{i3} = C_{i3}P^f_{i3}$ 成正比。锥化函数 $C_{ij} = \\exp\\left(-\\left(\\frac{|x_i - x_j|}{\\ell}\\right)^{2}\\right)$ 随距离的衰减速度（作为高斯函数）远快于原始协方差函数 $P^f_{ij} = \\exp\\left(-\\frac{|x_i - x_j|}{a}\\right)$（指数函数）。这抑制了远离观测位置的网格点上观测值的影响，这在物理上是可取的，并有助于滤除基于集合的协方差估计中存在的虚假长程相关。\n\n我们被要求计算网格点 $x_2 = -1$ 处的分析增量，即向量 $\\delta x^a$ 的第二个分量：\n$$(\\delta x^a)_2 = \\tilde{K}_2 d = \\frac{\\tilde{P}^f_{23}}{\\tilde{P}^f_{33} + R} d$$\n我们现在必须计算 $\\tilde{P}^f_{23}$ 和 $\\tilde{P}^f_{33}$ 的值。网格点位置为 $x_1=-2$、$x_2=-1$、$x_3=0$、$x_4=1$、$x_5=2$。参数为 $\\sigma^2=1$、$a=1$、$\\ell=\\frac{3}{2}$、$R=\\frac{1}{3}$ 和 $d=\\frac{1}{2}$。\n\n局地化协方差元素为 $\\tilde{P}^f_{ij} = P^f_{ij} C_{ij}$。\n预报协方差元素为 $P^f_{ij} = \\sigma^2 \\exp\\left(-\\frac{|x_i-x_j|}{a}\\right) = 1 \\cdot \\exp(-|x_i-x_j|)$。\n锥化矩阵元素为 $C_{ij} = \\exp\\left(-\\left(\\frac{|x_i-x_j|}{\\ell}\\right)^2\\right) = \\exp\\left(-\\left(\\frac{|x_i-x_j|}{3/2}\\right)^2\\right) = \\exp\\left(-\\frac{4(x_i-x_j)^2}{9}\\right)$。\n\n首先，我们计算 $\\tilde{P}^f_{33}$：\n距离为 $|x_3 - x_3| = 0$。\n$P^f_{33} = \\exp(-0) = 1$。\n$C_{33} = \\exp(0) = 1$。\n$\\tilde{P}^f_{33} = P^f_{33} C_{33} = 1 \\times 1 = 1$。\n\n接下来，我们计算 $\\tilde{P}^f_{23}$：\n距离为 $|x_2 - x_3| = |-1 - 0| = 1$。\n$P^f_{23} = \\exp(-1)$。\n$C_{23} = \\exp\\left(-\\frac{4(1)^2}{9}\\right) = \\exp\\left(-\\frac{4}{9}\\right)$。\n$\\tilde{P}^f_{23} = P^f_{23} C_{23} = \\exp(-1) \\exp\\left(-\\frac{4}{9}\\right) = \\exp\\left(-1 - \\frac{4}{9}\\right) = \\exp\\left(-\\frac{13}{9}\\right)$。\n\n现在，我们将这些值代入 $(\\delta x^a)_2$ 的表达式中：\n$$(\\delta x^a)_2 = \\frac{\\exp\\left(-\\frac{13}{9}\\right)}{1 + \\frac{1}{3}} \\times \\frac{1}{2}$$\n$$(\\delta x^a)_2 = \\frac{\\exp\\left(-\\frac{13}{9}\\right)}{\\frac{4}{3}} \\times \\frac{1}{2}$$\n$$(\\delta x^a)_2 = \\frac{3}{4}\\exp\\left(-\\frac{13}{9}\\right) \\times \\frac{1}{2}$$\n$$(\\delta x^a)_2 = \\frac{3}{8}\\exp\\left(-\\frac{13}{9}\\right)$$\n这就是在 $x_2=-1$ 处的分析增量的最终封闭形式表达式。",
            "answer": "$$\\boxed{\\frac{3}{8}\\exp\\left(-\\frac{13}{9}\\right)}$$"
        },
        {
            "introduction": "任何卡尔曼滤波器的性能都高度依赖于对背景误差和观测误差协方差（分别为矩阵 $P$ 和 $R$）的准确设定。本练习将介绍一种强大的诊断工具——Desroziers 方法，它能够利用滤波器自身的输出（即新息和分析残差）来估计观测误差方差。您将首先从理论上推导支撑该方法的核心关系，然后将其应用于一个小型数据集，同时明确该估计器保持一致性所需的关键假设 。这项实践旨在连接滤波理论与实际应用，教会您如何利用系统输出来诊断和校准关键参数。",
            "id": "4036643",
            "problem": "考虑一个使用集合卡尔曼滤波（EnKF）同化到数值天气预报系统中的单一近地面气温观测。假设一个局地线性观测算子 $H$ 将观测位置的状态温度映射到观测温度，且对于本问题，取 $H=1$（即不经缩放直接观测状态变量）。设观测模型为 $y = H x^{t} + e$，其中 $x^{t}$ 是真实状态， $e$ 是观测误差。设背景（先验）状态为 $x^{b} = x^{t} + \\eta$，其中 $\\eta$ 是背景误差。定义新息 $d = y - H x^{b}$ 和分析残差 $r = y - H x^{a}$，其中 $x^{a}$ 是由EnKF更新产生的分析状态。\n\n使用Desroziers方法，可以从新息和残差的集合中估计观测误差方差。在单个观测位置，为您提供了 $N=8$ 个新息和残差值的集合对（单位为 $\\mathrm{K}$）：\n$(d_{1}, r_{1}) = (0.8, 0.6)$，$(d_{2}, r_{2}) = (-0.6, -0.5)$，$(d_{3}, r_{3}) = (1.2, 0.8)$，$(d_{4}, r_{4}) = (-0.4, -0.3)$，$(d_{5}, r_{5}) = (0.5, 0.4)$，$(d_{6}, r_{6}) = (-1.0, -0.7)$，$(d_{7}, r_{7}) = (0.9, 0.7)$，$(d_{8}, r_{8}) = (-0.7, -0.6)$。\n\n从卡尔曼滤波和EnKF分析更新的线性高斯基础出发，推导证明从新息和分析残差估计观测误差方差的Desroziers估计量合理性的关系式。然后，使用给定的集合计算该估计量，并给出该观测的观测误差方差的最终数值估计。以 $\\mathrm{K}^{2}$ 为单位表示您的最终估计，并将答案四舍五入到四位有效数字。\n\n此外，请明确说明此估计量在EnKF设置中保持一致性所需的假设，包括关于线性、偏差、独立性和卡尔曼增益作用的条件。\n\n您的最终数值答案必须是一个实数。",
            "solution": "本题的目标是推导用于估计观测误差方差的Desroziers关系式，并将其应用于所提供的集合数据。该问题涉及单个标量观测，这可将矩阵表示法简化为标量代数。\n\n首先，我们将推导新息 $d$、分析残差 $r$ 和观测误差方差 $R$ 之间的理论关系。分析残差 $r$ 定义为观测值 $y$ 与作用于分析状态 $x^a$ 的观测算子 $H$ 之间的差值：\n$$r = y - H x^{a}$$\n分析状态 $x^a$ 是通过卡尔曼更新方程从背景状态 $x^b$ 获得的：\n$$x^{a} = x^{b} + K(y - Hx^{b})$$\n这里，$K$ 是卡尔曼增益，项 $(y - Hx^{b})$ 是新息 $d$。代入新息的定义，分析更新变为：\n$$x^{a} = x^{b} + Kd$$\n现在，将 $x^a$ 的这个表达式代入残差 $r$ 的定义中：\n$$r = y - H(x^{b} + Kd) = (y - Hx^{b}) - HKd$$\n注意到 $(y - Hx^{b}) = d$，我们发现残差和新息之间存在直接关系：\n$$r = d - HKd = (1 - HK)d$$\n由于我们考虑的是单个观测位置且 $H=1$，所有量都是标量，因此该关系式对于给定问题成立。\n\nDesroziers方法通过计算新息和残差乘积的期望 $E[dr]$ 来估计观测误差方差 $R$。使用上面推导的关系式：\n$$E[dr] = E[d(1 - HK)d] = E[(1-HK)d^2]$$\n假设卡尔曼增益 $K$ 是最优的，因而是确定性的（即，由真实的误差协方差计算得出，而非集合估计），我们可以写出：\n$$E[dr] = (1 - HK)E[d^2]$$\n项 $E[d^2]$ 是新息的方差。我们可以用潜在的误差来表示新息 $d$。给定观测模型 $y = Hx^t + e$（其中 $x^t$ 是真实状态，$e$ 是观测误差）和背景模型 $x^b = x^t + \\eta$（其中 $\\eta$ 是背景误差），新息为：\n$$d = y - Hx^b = (Hx^t + e) - H(x^t + \\eta) = e - H\\eta$$\n假设观测误差 $e$ 和背景误差 $\\eta$ 不相关且均值为零，则新息的方差为：\n$$E[d^2] = E[(e - H\\eta)^2] = E[e^2 - 2He\\eta + H^2\\eta^2] = E[e^2] - 2HE[e\\eta] + H^2E[\\eta^2]$$\n$$E[d^2] = R + H^2P_{bb}$$\n其中 $R = E[e^2]$ 是观测误差方差，$P_{bb} = E[\\eta^2]$ 是状态变量的背景误差方差。\n\n对于这个标量问题，最优卡尔曼增益由下式给出：\n$$K = \\frac{P_{bb}H}{H^2P_{bb} + R}$$\n将 $E[d^2]$ 和 $K$ 的表达式代入 $E[dr]$ 的方程中：\n$$E[dr] = \\left(1 - H \\left(\\frac{P_{bb}H}{H^2P_{bb} + R}\\right)\\right) (R + H^2P_{bb})$$\n$$E[dr] = \\left(1 - \\frac{H^2P_{bb}}{H^2P_{bb} + R}\\right) (R + H^2P_{bb})$$\n$$E[dr] = \\left(\\frac{H^2P_{bb} + R - H^2P_{bb}}{H^2P_{bb} + R}\\right) (R + H^2P_{bb})$$\n$$E[dr] = \\left(\\frac{R}{H^2P_{bb} + R}\\right) (R + H^2P_{bb})$$\n$$E[dr] = R$$\n此推导证实了新息与分析残差乘积的期望等于观测误差方差。在本问题中，$H=1$，这简化了代数运算，但不改变结果。\n\n此关系式成立的关键假设是：\n1.  **线性**：观测算子 $H$ 必须是线性的。\n2.  **无偏性**：背景误差 $(\\eta)$ 和观测误差 $(e)$ 都必须是无偏的（均值为零）。\n3.  **不相关误差**：背景误差 $(\\eta)$ 和观测误差 $(e)$ 必须互不相关。\n4.  **增益的最优性**：分析更新中使用的卡尔曼增益 $K$ 必须是最优增益。在EnKF的背景下，基于集合的增益 $K_{ens}$ 是真实最优增益的统计估计。只有当 $K_{ens}$ 是 $K$ 的一个良好近似时，Desroziers估计量才是一致的，这意味着基于集合的误差协方差是准确的，并且集合大小足够大以最小化采样误差。\n\n为了从给定的 $N=8$ 对集合中计算观测误差方差的估计值 $\\hat{R}$，我们用样本均值来近似期望：\n$$\\hat{R} = \\frac{1}{N} \\sum_{i=1}^{N} d_i r_i$$\n给定的数据点是：\n$(d_{1}, r_{1}) = (0.8, 0.6)$，$(d_{2}, r_{2}) = (-0.6, -0.5)$，$(d_{3}, r_{3}) = (1.2, 0.8)$，$(d_{4}, r_{4}) = (-0.4, -0.3)$，$(d_{5}, r_{5}) = (0.5, 0.4)$，$(d_{6}, r_{6}) = (-1.0, -0.7)$，$(d_{7}, r_{7}) = (0.9, 0.7)$，$(d_{8}, r_{8}) = (-0.7, -0.6)$。\n\n我们为每对数据计算乘积 $d_i r_i$：\n$d_{1}r_{1} = (0.8)(0.6) = 0.48$\n$d_{2}r_{2} = (-0.6)(-0.5) = 0.30$\n$d_{3}r_{3} = (1.2)(0.8) = 0.96$\n$d_{4}r_{4} = (-0.4)(-0.3) = 0.12$\n$d_{5}r_{5} = (0.5)(0.4) = 0.20$\n$d_{6}r_{6} = (-1.0)(-0.7) = 0.70$\n$d_{7}r_{7} = (0.9)(0.7) = 0.63$\n$d_{8}r_{8} = (-0.7)(-0.6) = 0.42$\n\n接下来，我们对这些乘积求和：\n$$\\sum_{i=1}^{8} d_i r_i = 0.48 + 0.30 + 0.96 + 0.12 + 0.20 + 0.70 + 0.63 + 0.42 = 3.81$$\n这个和的单位是 $\\mathrm{K}^{2}$。\n\n最后，我们将和除以集合成员数 $N=8$ 来计算估计值 $\\hat{R}$：\n$$\\hat{R} = \\frac{3.81}{8} = 0.47625$$\n题目要求最终答案四舍五入到四位有效数字。\n$$\\hat{R} \\approx 0.4763$$\n单位是 $\\mathrm{K}^{2}$。",
            "answer": "$$\\boxed{0.4763}$$"
        },
        {
            "introduction": "在掌握了核心部件之后，本综合性练习将引导您构建一个完整的随机集合卡尔曼滤波器（EnKF）循环。本练习不仅仅是算法的理论实现，更关注实际数值计算中遇到的挑战，例如在有限精度算术中保持数值稳定性，以及为确保精度而必须引入的协方差膨胀和自适应“抖动”（jittering）等保护措施。通过对比混合精度与全精度实现的性能，您将获得构建一个实用、稳健的资料同化系统的宝贵实践经验 。",
            "id": "4036685",
            "problem": "考虑一个用于数值天气预报和气候建模的简化大气模型的线性、时间离散的状态空间系统。在分析时间步 $k$ 的状态向量表示为 $x_k \\in \\mathbb{R}^n$。系统根据以下线性动力学演化\n$$\nx_{k+1} = M x_k + \\eta_k,\n$$\n其中 $M \\in \\mathbb{R}^{n \\times n}$ 是一个固定的模型算子，$\\eta_k \\in \\mathbb{R}^n$ 是一个零均值高斯过程噪声，其协方差矩阵为 $Q \\in \\mathbb{R}^{n \\times n}$。观测由以下公式给出\n$$\ny_k = H x_k + \\epsilon_k,\n$$\n其中 $H \\in \\mathbb{R}^{m \\times n}$ 是一个固定的观测算子，$\\epsilon_k \\in \\mathbb{R}^m$ 是一个零均值高斯观测噪声，其协方差矩阵为 $R \\in \\mathbb{R}^{m \\times m}$。假设所有噪声相互独立，并且独立于初始状态。\n\n您将实现一个集合大小为 $N_e$ 的随机集合卡尔曼滤波器 (EnKF)，使用标准的预报和分析循环，进行 $T$ 个同化步骤。EnKF 必须实现两次：\n- 一个使用 $64$ 位浮点算术（双精度）的基准实现。\n- 一个混合精度实现，其中所有大规模集合计算（状态传播、样本均值、样本协方差和集合异常）都在 $32$ 位浮点算术（单精度）中执行，而分析步骤中数值敏感的线性代数运算（如线性系统求解）则在 $64$ 位算术中执行。\n\n您必须从以下基本依据开始：\n- 上述状态和观测模型的线性高斯贝叶斯更新法则。\n- 采用贝塞尔校正的样本均值和样本协方差的定义，即除以 $(N_e - 1)$。\n\n您必须设计并实现具有数学依据的保障措施，以在混合精度 EnKF 中保持数值稳定性和准确性。这些保障措施必须至少包括：\n- 在预报步骤中通过将任何样本协方差 $P$ 替换为 $(P + P^\\top)/2$ 来进行协方差对称化。\n- 一种自适应抖动策略，通过添加 $\\lambda I_m$ 并增加 $\\lambda$ 直至 Cholesky 分解成功，来确保分析步骤中观测空间协方差矩阵的正定性，其中 $I_m$ 是 $m \\times m$ 的单位矩阵，$\\lambda$ 初始化为一个小的正值。\n- 在预报步骤中对集合异常应用乘性协方差膨胀，膨胀因子为 $(1 + \\delta)$，其中 $\\delta$ 是一个小的非负标量。\n所有保障措施的应用方式应保持与线性高斯设定的一致性。\n\n每个测试用例的模型和算子必须按如下方式构造。对于给定的维度 $n$：\n- 模型算子 $M \\in \\mathbb{R}^{n \\times n}$ 是三对角的，其中 $M_{i,i} = 1$，对于 $i = 1,\\dots,n-1$，$M_{i,i+1} = 0.1$，对于 $i = 2,\\dots,n$，$M_{i,i-1} = -0.05$，所有其他条目为零。\n- 观测算子 $H \\in \\mathbb{R}^{m \\times n}$ 选择状态的前 $m$ 个分量：对于 $j = 1,\\dots,m$，$H_{j,j} = 1$，否则为零。\n- 过程噪声协方差为 $Q = q^2 I_n$，观测噪声协方差为 $R = r^2 I_m$，其中 $q > 0$ 和 $r > 0$ 是标量。\n- 初始真实状态为 $x_0 \\sim \\mathcal{N}(0, \\sigma_0^2 I_n)$，其中 $\\sigma_0 > 0$，初始集合独立抽取为 $x_0^{(i)} \\sim \\mathcal{N}(x_0, \\sigma_0^2 I_n)$，对于 $i = 1,\\dots,N_e$。\n\n为了可复现性，所有随机抽样必须使用指定的种子确定性地生成。您必须在基准和混合精度运行中使用所有随机变量（初始状态、过程噪声、观测噪声、集合预报噪声和观测扰动）的相同实现，以便结果中的任何差异都仅归因于算术精度。\n\n对于每个分析步骤 $k = 0,\\dots,T-1$，您必须计算分析集合均值 $\\bar{x}^a_k$ 和实现的真实状态 $x_{k+1}$。令时间平均均方根误差 (RMSE) 定义为\n$$\n\\mathrm{RMSE} = \\frac{1}{T}\\sum_{k=0}^{T-1} \\sqrt{\\frac{1}{n} \\left\\| \\bar{x}^a_k - x_{k+1} \\right\\|_2^2}.\n$$\n为基准和混合精度实现计算此 RMSE。对于每个测试用例，报告其差值\n$$\nd = \\mathrm{RMSE}_{\\text{mixed}} - \\mathrm{RMSE}_{\\text{baseline}}.\n$$\n自适应抖动参数必须从一个最小值 $\\epsilon_{\\min} > 0$ 开始，并以 $10$ 为因子乘性增加，直到观测空间协方差的 Cholesky 分解成功。乘性膨胀因子 $\\delta \\ge 0$ 必须在计算预报协方差之前应用于集合异常。\n\n测试套件。实现以下三个测试用例，它们涵盖了典型、边界和边缘情景：\n- 用例 A（理想情况）：$n = 4$, $m = 2$, $N_e = 40$, $T = 12$, $q = 0.05$, $r = 0.1$, $\\sigma_0 = 0.5$, $\\delta = 0.04$, $\\epsilon_{\\min} = 10^{-8}$, 种子 $= 123$。\n- 用例 B（小集合，潜在的秩亏）：$n = 6$, $m = 3$, $N_e = 8$, $T = 12$, $q = 0.01$, $r = 0.05$, $\\sigma_0 = 0.5$, $\\delta = 0.08$, $\\epsilon_{\\min} = 10^{-8}$, 种子 $= 456$。\n- 用例 C（近奇异观测协方差）：$n = 3$, $m = 2$, $N_e = 50$, $T = 12$, $q = 0.02$, $r = 10^{-4}$, $\\sigma_0 = 0.5$, $\\delta = 0.02$, $\\epsilon_{\\min} = 10^{-6}$, 种子 $= 789$。\n\n最终输出要求。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表的结果，条目依次为用例 A、用例 B 和用例 C 的 $d$ 值，即 $[d_A,d_B,d_C]$。每个条目必须是浮点数。由于这是无量纲的数值比较，因此不需要单位。",
            "solution": "用户提供的问题是一个在数据同化数值方法领域中定义良好且有科学依据的任务。该问题要求实现并比较一个标准的64位（双精度）和一个混合精度（32/64位）的随机集合卡尔曼滤波器（EnKF）。所有必需的参数、模型方程、初始条件、噪声统计和评估指标都得到了明确定义，并且与数值天气预报和气候建模中关于 EnKF 的已有文献相符。该问题没有任何科学不准确、模糊或矛盾之处。因此，该问题被认为是 **有效的**。\n\n解决方案涉及实现 EnKF 算法，该算法在递归的预报-分析循环中运行。对于每个测试用例，我们将执行两次运行：一次是始终使用 `64` 位浮点算术的基准运行，另一次是混合精度运行。将计算这两次运行之间时间平均均方根误差 (RMSE) 的差异。为确保公平比较，两次运行将使用完全相同的随机数序列来生成初始条件和所有过程/观测噪声，这是通过预先生成这些数字来实现的。\n\n### 1. 随机集合卡尔曼滤波器 (EnKF) 算法\n\nEnKF 是卡尔曼滤波器的蒙特卡洛近似，其中状态的概率分布由一个包含 $N_e$ 个状态向量的集合来表示。该算法以离散时间步进行，在预报和分析步骤之间迭代。设 $\\{x_{k-1}^{a, (i)}\\}_{i=1}^{N_e}$ 是在时间 $k-1$ 的分析集合。\n\n#### 1.1. 预报步骤\n在预报步骤中，每个集合成员都使用系统的动力学模型向前传播。\n1.  **状态传播**：每个集合成员 $x_{k-1}^{a, (i)}$ 通过线性模型算子 $M$ 演化到时间 $k$ 的预报状态 $x_k^{f, (i)}$。为每个成员添加一个唯一的过程噪声实现 $\\eta_{k-1}^{(i)} \\sim \\mathcal{N}(0, Q)$。\n    $$\n    x_k^{f, (i)} = M x_{k-1}^{a, (i)} + \\eta_{k-1}^{(i)} \\quad \\text{for } i = 1, \\dots, N_e\n    $$\n2.  **乘性膨胀（保障措施）**：为了抵消 EnKF 低估协方差的趋势，尤其是在小集合的情况下，应用了乘性膨胀。计算预报集合均值 $\\bar{x}_k^f = \\frac{1}{N_e}\\sum_{i=1}^{N_e} x_k^{f, (i)}$，然后计算预报异常 $X_k^{f,(i)} = x_k^{f, (i)} - \\bar{x}_k^f$。这些异常通过因子 $(1 + \\delta)$ 进行膨胀，其中 $\\delta \\ge 0$。\n    $$\n    x_k^{f, \\text{inflated}, (i)} = \\bar{x}_k^f + (1 + \\delta) \\left( x_k^{f, (i)} - \\bar{x}_k^f \\right)\n    $$\n    这个膨胀后的集合用于分析步骤。\n3.  **预报协方差**：使用贝塞尔校正 $(N_e - 1)$ 计算膨胀后预报集合的样本协方差 $P_k^f$。设 $A_k^f$ 是膨胀异常矩阵，其中每一列是一个异常向量。\n    $$\n    P_k^f = \\frac{1}{N_e - 1} A_k^f (A_k^f)^\\top\n    $$\n4.  **对称化（保障措施）**：由于有限精度算术，计算出的 $P_k^f$ 可能存在微小的不对称性。为了确保其数学属性，对其进行显式对称化。\n    $$\n    P_k^f \\leftarrow \\frac{1}{2} \\left( P_k^f + (P_k^f)^\\top \\right)\n    $$\n\n#### 1.2. 分析步骤\n在分析步骤中，使用观测 $y_k = H x_k^{\\text{true}} + \\epsilon_k$ 来更新预报集合。随机 EnKF 通过为每个集合成员扰动观测来实现此更新。\n1.  **扰动观测**：创建一组 $N_e$ 个扰动观测。\n    $$\n    y_k^{(i)} = y_k + \\epsilon_k^{(i)} \\quad \\text{where } \\epsilon_k^{(i)} \\sim \\mathcal{N}(0, R)\n    $$\n2.  **卡尔曼更新**：每个预报集合成员使用一个模仿卡尔曼滤波器的更新方程更新为分析成员 $x_k^{a, (i)}$。\n    $$\n    x_k^{a, (i)} = x_k^{f, \\text{inflated}, (i)} + K_k \\left( y_k^{(i)} - H x_k^{f, \\text{inflated}, (i)} \\right)\n    $$\n    卡尔曼增益 $K_k$ 由下式给出：\n    $$\n    K_k = P_k^f H^\\top \\left( H P_k^f H^\\top + R \\right)^{-1}\n    $$\n    在数值上，与其对观测空间协方差矩阵 $S_k = H P_k^f H^\\top + R$ 求逆，不如为每个集合成员求解一个线性系统，这样做要稳定得多。设成员 $i$ 的新息为 $d_k^{(i)} = y_k^{(i)} - H x_k^{f, \\text{inflated}, (i)}$。更新项的计算首先是求解线性系统 $S_k v_k^{(i)} = d_k^{(i)}$ 得到 $v_k^{(i)}$，然后计算状态更新为 $(P_k^f H^\\top) v_k^{(i)}$。\n\n#### 1.3. 混合精度策略和保障措施\n混合精度实现旨在通过在单精度（$32$ 位）下执行大规模运算来减少计算成本和内存带宽，同时通过使用双精度（$64$ 位）进行关键计算来保持数值稳定性。\n- **单精度（$32$ 位）运算**：所有与集合相关的计算都在 `float32` 中执行。这包括状态传播（$M x + \\eta$）、集合均值和异常的计算、协方差膨胀，以及预报协方差矩阵 $P_k^f$ 和观测空间矩阵 $H P_k^f H^\\top$ 的形成。\n- **双精度（$64$ 位）运算**：分析步骤的线性求解在数值上是敏感的，特别是当观测空间协方差 $S_k$ 是病态的时候。为了缓解这个问题，以下运算在 `float64` 中执行：\n    1.  矩阵 $H P_k^f H^\\top$ 和 $R$ 在相加形成 $S_k$ 之前被转换为 `float64`。\n    2.  **自适应抖动**保障措施应用于 `float64` 矩阵 $S_k$。我们尝试计算其 Cholesky 分解。如果失败（即矩阵在数值上不是正定的），则向 $S_k$ 添加一个正则化项 $\\lambda I_m$，其中 $\\lambda$ 初始化为一个较小的值 $\\epsilon_{\\min}$，并以 $10$ 为因子乘性增加，直到分解成功。\n    3.  每个集合成员的新息向量被转换为 `float64`。\n    4.  使用稳定的 `cho_solve` 例程和 `float64` Cholesky 因子求解线性系统 $S_{k, \\text{reg}} v_k^{(i)} = d_k^{(i)}$。\n    5.  最终的状态更新项被计算出来，然后转换回 `float32`，再加到 `float32` 的预报状态向量上。\n\n### 2. 实现与评估\n该算法在一个函数中实现，该函数接受用于集合运算的浮点精度（`dtype_ens`）和用于线性代数的浮点精度（`dtype_la`）作为参数。对于每个测试用例，我们首先生成并存储所有必需的随机数。然后，我们执行两次 EnKF 模拟，每次 $T$ 步：一次是基准情况（`dtype_ens=float64`, `dtype_la=float64`），一次是混合精度情况（`dtype_ens=float32`, `dtype_la=float64`），使用完全相同的随机数流。\n\n最后，根据指定的公式计算两次运行的时间平均 RMSE：\n$$\n\\mathrm{RMSE} = \\frac{1}{T}\\sum_{k=0}^{T-1} \\sqrt{\\frac{1}{n} \\left\\| \\bar{x}^a_k - x_{k+1} \\right\\|_2^2}\n$$\n其中 $\\bar{x}^a_k$ 是在步骤 $k$ 的分析集合均值，$x_{k+1}$ 是在步骤 $k+1$ 的真实状态。每个测试用例最终报告的值是差值 $d = \\mathrm{RMSE}_{\\text{mixed}} - \\mathrm{RMSE}_{\\text{baseline}}$。",
            "answer": "[-7.89387498777e-07,2.23517417937e-06,2.02983756209e-05]"
        }
    ]
}