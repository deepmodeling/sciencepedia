{
    "hands_on_practices": [
        {
            "introduction": "Before we can assimilate cloud-affected radiances, we must first understand their physical impact on microwave radiation. This exercise provides a foundational calculation to quantify the scattering effect of an ice cloud on brightness temperature, a key process that all-sky systems must model. You will connect microphysical cloud properties, such as Ice Water Content ($IWC$) and effective particle radius ($r_e$), to the resulting depression in the top-of-atmosphere brightness temperature, a key signal that all-sky systems are designed to interpret .",
            "id": "4011516",
            "problem": "A satellite microwave humidity sounder channel centered near the $183 \\ \\mathrm{GHz}$ water vapor absorption feature is assimilated in an all-sky radiance framework for numerical weather prediction. Consider a homogeneous ice cloud layer of geometrical thickness $H = 2.0 \\times 10^{3} \\ \\mathrm{m}$, with constant Ice Water Content (IWC) $= 1.0 \\times 10^{-4} \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$ and particle effective radius $r_{e} = 1.0 \\times 10^{-4} \\ \\mathrm{m}$. Assume the ice particles are homogeneous spheres with complex refractive index $m = 1.78 + i \\, 0.002$ at $183 \\ \\mathrm{GHz}$, and the density of ice is $\\rho_{i} = 917 \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$. The instrument views the scene at a zenith angle $\\theta = 53^{\\circ}$, and the clear-sky top-of-atmosphere brightness temperature along this line of sight is $T_{b}^{\\mathrm{clear}} = 245 \\ \\mathrm{K}$. Neglect emission by the ice and multiple scattering, and treat scattering as removal of radiance from the instrument’s narrow line of sight (i.e., scattering contributes to extinction only). Assume the rest of the atmosphere is unchanged by the presence of the cloud. Use the Rayleigh–Jeans limit to relate radiance and brightness temperature.\n\nStarting from the scalar radiative transfer equation for a beam subject to extinction, and using the Rayleigh scattering result for small spheres, where the scattering efficiency factor is\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2},\n$$\nwith size parameter $x = \\frac{2 \\pi r_{e}}{\\lambda}$ and wavelength $\\lambda = \\frac{c}{f}$ for speed of light $c$ and frequency $f$, derive an expression for the brightness temperature depression $\\Delta T_{b}$ at the top of the atmosphere caused solely by ice-cloud scattering. Then evaluate $\\Delta T_{b}$ numerically for $f = 183 \\times 10^{9} \\ \\mathrm{Hz}$ and $c = 2.99792458 \\times 10^{8} \\ \\mathrm{m} \\ \\mathrm{s}^{-1}$.\n\nExpress your final answer as a single number in kelvin and round your result to three significant figures. State any intermediate assumptions clearly in your reasoning.",
            "solution": "The user wants to find the brightness temperature depression caused by an ice cloud.\n\n### Step 1: Extract Givens\n- Instrument: Microwave humidity sounder\n- Frequency: $f = 183 \\times 10^{9} \\ \\mathrm{Hz}$\n- Cloud: Homogeneous ice cloud layer\n- Geometrical thickness: $H = 2.0 \\times 10^{3} \\ \\mathrm{m}$\n- Ice Water Content: $\\mathrm{IWC} = 1.0 \\times 10^{-4} \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$\n- Particle effective radius: $r_{e} = 1.0 \\times 10^{-4} \\ \\mathrm{m}$\n- Ice particle shape: Homogeneous spheres\n- Complex refractive index of ice: $m = 1.78 + i \\, 0.002$\n- Density of ice: $\\rho_{i} = 917 \\ \\mathrm{kg} \\ \\mathrm{m}^{-3}$\n- Instrument zenith angle: $\\theta = 53^{\\circ}$\n- Clear-sky TOA brightness temperature: $T_{b}^{\\mathrm{clear}} = 245 \\ \\mathrm{K}$\n- Speed of light: $c = 2.99792458 \\times 10^{8} \\ \\mathrm{m} \\ \\mathrm{s}^{-1}$\n- Scattering efficiency factor (Rayleigh): $Q_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$\n- Size parameter: $x = \\frac{2 \\pi r_{e}}{\\lambda}$\n- Wavelength: $\\lambda = \\frac{c}{f}$\n- Assumptions/simplifications:\n    1.  Neglect emission by the ice.\n    2.  Neglect multiple scattering.\n    3.  Scattering contributes to extinction only.\n    4.  Atmosphere outside the cloud is unchanged.\n    5.  Use the Rayleigh–Jeans limit.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, referring to standard concepts in atmospheric radiative transfer like brightness temperature, IWC, effective radius, and scattering theory. The numerical values provided are physically realistic for a cirrus cloud. The problem is well-posed, providing all necessary parameters and simplifying assumptions (neglect of emission and multiple scattering) to allow for an analytical solution. A crucial point is the instruction to use the Rayleigh scattering formula. The size parameter $x = \\frac{2 \\pi r_e}{\\lambda}$ for the given values is approximately $0.38$, which is at the upper limit of the Rayleigh regime (typically $x \\ll 1$). However, since the problem explicitly provides the formula to use, this is considered a pedagogical simplification rather than a scientific flaw that would invalidate the problem. The problem is objective, complete, and internally consistent.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A detailed solution will be provided.\n\n### Solution Derivation\n\nThe problem asks for the brightness temperature depression $\\Delta T_{b}$ at the top of the atmosphere due to scattering by an ice cloud. We begin with the scalar radiative transfer equation (RTE) for a beam of radiance $I$ traveling along a path $s$, subject only to extinction.\n$$\n\\frac{dI}{ds} = -k_{\\mathrm{ext}} I\n$$\nwhere $k_{\\mathrm{ext}}$ is the volume extinction coefficient. The problem states to neglect ice emission and multiple scattering. By Kirchhoff's law of thermal radiation, a medium that does not emit does not absorb. Therefore, the extinction is due solely to scattering out of the beam, so $k_{\\mathrm{ext}} = k_{\\mathrm{sca}}$, where $k_{\\mathrm{sca}}$ is the volume scattering coefficient.\n\nFor a homogeneous cloud, $k_{\\mathrm{sca}}$ is constant. Integrating the RTE along the slant path $s$ through the cloud gives:\n$$\nI(s) = I(0) \\exp(-k_{\\mathrm{sca}} s)\n$$\nHere, $I(0)$ is the upwelling radiance incident at the cloud base, and $I(s)$ is the radiance exiting the cloud top. The slant path length through the cloud is $s = H / \\cos(\\theta)$, where $H$ is the geometrical thickness and $\\theta$ is the zenith angle. The product $k_{\\mathrm{sca}} s$ is the cloud optical depth along the slant path, $\\tau_{\\mathrm{cld}}$.\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)}\n$$\nThe problem states to use the Rayleigh-Jeans limit, where radiance $I$ is directly proportional to brightness temperature $T_{b}$. This allows us to write the RTE in terms of $T_{b}$:\n$$\nT_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\nHere, $T_{b}^{\\mathrm{clear}}$ is the brightness temperature that would be observed without the cloud, which represents the radiation source from below, and $T_{b}^{\\mathrm{cloudy}}$ is the attenuated brightness temperature observed in the presence of the cloud.\n\nThe brightness temperature depression, $\\Delta T_{b}$, is the difference between the clear-sky and cloudy-sky brightness temperatures:\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right)\n$$\nTo evaluate this, we must first determine $\\tau_{\\mathrm{cld}}$. This requires calculating $k_{\\mathrm{sca}}$. The volume scattering coefficient is the product of the number density of scatterers, $N$, and the scattering cross-section of a single particle, $\\sigma_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = N \\sigma_{\\mathrm{sca}}\n$$\nThe number density $N$ can be found from the Ice Water Content (IWC), which is the total mass of ice per unit volume. For spherical particles of radius $r_e$ and density $\\rho_i$, the mass of a single particle is $M_{p} = \\rho_i V_{p} = \\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}$. Then, $\\mathrm{IWC} = N M_p$.\n$$\nN = \\frac{\\mathrm{IWC}}{M_{p}} = \\frac{\\mathrm{IWC}}{\\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}} = \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}}\n$$\nThe scattering cross-section $\\sigma_{\\mathrm{sca}}$ is the product of the particle's geometrical cross-section, $A_{p} = \\pi r_{e}^{2}$, and the scattering efficiency, $Q_{\\mathrm{sca}}$.\n$$\n\\sigma_{\\mathrm{sca}} = A_{p} Q_{\\mathrm{sca}} = \\pi r_{e}^{2} Q_{\\mathrm{sca}}\n$$\nCombining these gives an expression for $k_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = \\left( \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}} \\right) (\\pi r_{e}^{2} Q_{\\mathrm{sca}}) = \\frac{3 \\, \\mathrm{IWC} \\, Q_{\\mathrm{sca}}}{4 \\, \\rho_{i} \\, r_{e}}\n$$\nNow, we must evaluate $Q_{\\mathrm{sca}}$ using the given formula:\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}\n$$\nFirst, we calculate the wavelength $\\lambda$ and the size parameter $x$:\n$$\n\\lambda = \\frac{c}{f} = \\frac{2.99792458 \\times 10^{8} \\, \\mathrm{m \\, s^{-1}}}{183 \\times 10^{9} \\, \\mathrm{Hz}} \\approx 1.63821 \\times 10^{-3} \\, \\mathrm{m}\n$$\n$$\nx = \\frac{2 \\pi r_{e}}{\\lambda} = \\frac{2 \\pi (1.0 \\times 10^{-4} \\, \\mathrm{m})}{1.63821 \\times 10^{-3} \\, \\mathrm{m}} \\approx 0.38356\n$$\nNext, we evaluate the complex term using $m = 1.78 + i \\, 0.002$:\n$$\nm^{2} = (1.78 + i \\, 0.002)^{2} = 1.78^{2} + 2(1.78)(i \\, 0.002) + (i \\, 0.002)^{2} = 3.1684 + i \\, 0.00712 - 0.000004 = 3.168396 + i \\, 0.00712\n$$\nThe term $\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$ is the squared magnitude of a complex ratio, which can be calculated as the ratio of the squared magnitudes of the numerator and denominator:\n$$\n\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2} = \\frac{|(3.168396 - 1) + i \\, 0.00712|^{2}}{|(3.168396 + 2) + i \\, 0.00712|^{2}} = \\frac{|2.168396 + i \\, 0.00712|^{2}}{|5.168396 + i \\, 0.00712|^{2}}\n$$\n$$\n= \\frac{2.168396^{2} + 0.00712^{2}}{5.168396^{2} + 0.00712^{2}} = \\frac{4.70198 + 5.06944 \\times 10^{-5}}{26.71235 + 5.06944 \\times 10^{-5}} \\approx \\frac{4.70203}{26.71240} \\approx 0.17602\n$$\nNow we can compute $Q_{\\mathrm{sca}}$:\n$$\nQ_{\\mathrm{sca}} \\approx \\frac{8}{3} (0.38356)^{4} (0.17602) \\approx \\frac{8}{3} (0.021642) (0.17602) \\approx 0.010134\n$$\nWith $Q_{\\mathrm{sca}}$, we find $k_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = \\frac{3 \\, (1.0 \\times 10^{-4} \\, \\mathrm{kg \\, m^{-3}}) (0.010134)}{4 \\, (917 \\, \\mathrm{kg \\, m^{-3}}) (1.0 \\times 10^{-4} \\, \\mathrm{m})} = \\frac{3.0402 \\times 10^{-6}}{0.3668} \\approx 8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}\n$$\nNext, we calculate the cloud optical depth $\\tau_{\\mathrm{cld}}$:\n$$\n\\cos(53^{\\circ}) \\approx 0.601815\n$$\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)} \\approx \\frac{(8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}) (2.0 \\times 10^{3} \\, \\mathrm{m})}{0.601815} \\approx \\frac{0.0165774}{0.601815} \\approx 0.027546\n$$\nFinally, we compute the brightness temperature depression $\\Delta T_{b}$:\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right) \\approx 245 \\, \\mathrm{K} \\left(1 - \\exp(-0.027546)\\right)\n$$\n$$\n\\Delta T_{b} \\approx 245 \\, (1 - 0.972828) = 245 \\, (0.027172) \\approx 6.65714 \\, \\mathrm{K}\n$$\nRounding the result to three significant figures gives $6.66 \\, \\mathrm{K}$.",
            "answer": "$$\\boxed{6.66}$$"
        },
        {
            "introduction": "At the heart of any data assimilation system is the observation operator, or forward model ($H$), which simulates observations from the model's state variables. This practice guides you through constructing a simplified all-sky forward model and calculating its Jacobian matrix, which represents the sensitivity of brightness temperatures to changes in hydrometeors. Understanding these sensitivities is crucial for diagnosing the model and is a fundamental component of the variational assimilation algorithm itself .",
            "id": "4011543",
            "problem": "You are tasked with constructing and analyzing a simplified, physically consistent forward model relevant to all-sky radiance assimilation for a microwave imager in numerical weather prediction and climate modeling. The objective is to compute channel-wise Jacobians of top-of-atmosphere brightness temperature with respect to hydrometeor mixing ratios and to rank the channels by their sensitivity to cloud ice.\n\nFundamental base and modeling assumptions: Start from the one-dimensional, plane-parallel thermal radiative transfer in the Microwave (MW) regime under Local Thermodynamic Equilibrium (LTE), without scattering. The governing law is the Schwarzschild equation for upwelling radiation. Represent the atmosphere as a single, homogeneous slab with constant temperature and extinction, viewed by a nadir-orbiting imager. Let Top-Of-Atmosphere (TOA) brightness temperature be considered in the Rayleigh-Jeans limit, and incorporate a non-black surface with a specified emissivity.\n\nDefinitions and variables to be used:\n- Brightness temperatures and thermodynamic temperatures are denoted by $T$ and must be expressed in Kelvin ($\\mathrm{K}$).\n- Surface temperature $T_s$ in $\\mathrm{K}$, layer temperature $T_\\ell$ in $\\mathrm{K}$, and surface emissivity $\\varepsilon$ (dimensionless).\n- Viewing zenith angle $\\theta$ in degrees, with path factor $\\mu = \\cos(\\theta \\times \\pi / 180)$ (dimensionless).\n- Column mass path of the slab $M$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}$.\n- Gas mass-extinction coefficient per unit mass path $\\,\\kappa_g(\\nu)$ in $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$ for each channel frequency $\\nu$.\n- Hydrometeor species mixing ratios $q_i$ (dimensionless, in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$) for the four species: cloud ice ($q_{\\mathrm{ice}}$), cloud liquid ($q_{\\mathrm{liq}}$), rain ($q_{\\mathrm{rain}}$), and snow ($q_{\\mathrm{snow}}$).\n- Hydrometeor mass-extinction coefficients $\\,\\alpha_i(\\nu)$ (species- and frequency-dependent, in $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$).\n- Channels correspond to three frequencies: $23.8$, $36.5$, and $89.0$ gigahertz (GHz).\n\nForward model specification to implement:\n- Use the Schwarzschild equation in a homogeneous slab with source function equal to the Planck function in the Rayleigh-Jeans limit, and with an incident surface brightness temperature $T_b^{\\mathrm{surf}} = \\varepsilon T_s$.\n- The total mass-extinction per unit mass path for a given channel is $K(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) \\, q_i$, where the sum runs over the four hydrometeor species.\n- The optical depth of the slab along the line of sight is $\\tau_{\\mathrm{opt}}(\\nu) = \\dfrac{M}{\\mu} \\, K(\\nu)$.\n- The TOA brightness temperature for each channel is the homogeneous-slab solution of the Schwarzschild equation along the line of sight, with the specified boundary condition at the surface.\n\nYour program must compute, for each test case and each channel:\n1. The Jacobians $\\dfrac{\\partial T_b}{\\partial q_i}$ with respect to each hydrometeor mixing ratio $q_i$, for $i \\in \\{\\mathrm{ice}, \\mathrm{liq}, \\mathrm{rain}, \\mathrm{snow}\\}$; the units must be reported as $\\mathrm{K}$ per $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$.\n2. A ranking of the channels by absolute sensitivity to cloud ice, i.e., sort channels by $\\left|\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}\\right|$ in descending order and report the channel indices using 0-based indexing corresponding to $[23.8\\,\\mathrm{GHz} \\rightarrow 0,\\; 36.5\\,\\mathrm{GHz} \\rightarrow 1,\\; 89.0\\,\\mathrm{GHz} \\rightarrow 2]$.\n\nUse the following scientifically plausible coefficients for the three channels:\n- Gas mass-extinction coefficients (per unit mass path): $\\kappa_g(\\nu)$ for $\\nu = [23.8, 36.5, 89.0]\\ \\mathrm{GHz}$ are $[0.015,\\ 0.012,\\ 0.025]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$.\n- Hydrometeor mass-extinction coefficients:\n  - Cloud ice: $\\alpha_{\\mathrm{ice}}(\\nu) = [0.020,\\ 0.050,\\ 0.250]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$.\n  - Cloud liquid: $\\alpha_{\\mathrm{liq}}(\\nu) = [0.150,\\ 0.200,\\ 0.300]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$.\n  - Rain: $\\alpha_{\\mathrm{rain}}(\\nu) = [0.600,\\ 0.800,\\ 1.100]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$.\n  - Snow: $\\alpha_{\\mathrm{snow}}(\\nu) = [0.300,\\ 0.400,\\ 0.800]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$.\n\nTest suite: Implement the following four test cases. Angles must be interpreted in degrees, temperatures in Kelvin, $M$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}$, and mixing ratios in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$.\n- Case $1$ (happy path, oblique view, moderate cloud): $T_s = 290$, $T_\\ell = 260$, $\\varepsilon = 0.95$, $\\theta = 53$, $M = 2.0$, $q_{\\mathrm{ice}} = 5\\times 10^{-4}$, $q_{\\mathrm{liq}} = 1\\times 10^{-3}$, $q_{\\mathrm{rain}} = 1\\times 10^{-4}$, $q_{\\mathrm{snow}} = 2\\times 10^{-4}$.\n- Case $2$ (boundary, clear sky hydrometeors, nadir): $T_s = 288$, $T_\\ell = 270$, $\\varepsilon = 0.90$, $\\theta = 0$, $M = 2.0$, $q_{\\mathrm{ice}} = 0$, $q_{\\mathrm{liq}} = 0$, $q_{\\mathrm{rain}} = 0$, $q_{\\mathrm{snow}} = 0$.\n- Case $3$ (edge, grazing path, low emissivity, cold cloud): $T_s = 300$, $T_\\ell = 240$, $\\varepsilon = 0.60$, $\\theta = 60$, $M = 5.0$, $q_{\\mathrm{ice}} = 1\\times 10^{-3}$, $q_{\\mathrm{liq}} = 5\\times 10^{-4}$, $q_{\\mathrm{rain}} = 2\\times 10^{-4}$, $q_{\\mathrm{snow}} = 1\\times 10^{-3}$.\n- Case $4$ (edge, thicker slab, stronger gas extinction): $T_s = 285$, $T_\\ell = 255$, $\\varepsilon = 0.97$, $\\theta = 45$, $M = 8.0$, $q_{\\mathrm{ice}} = 8\\times 10^{-4}$, $q_{\\mathrm{liq}} = 2\\times 10^{-3}$, $q_{\\mathrm{rain}} = 5\\times 10^{-4}$, $q_{\\mathrm{snow}} = 3\\times 10^{-4}$.\n\nFinal output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each element of this outer list corresponds to one test case and is itself a two-element list: the first element is a $3 \\times 4$ nested list of floats giving the Jacobians $\\left[\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{liq}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{rain}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{snow}}}\\right]$ for each of the three channels; the second element is the list of ranked channel indices by absolute sensitivity to cloud ice. Concretely, the output must have the form\n$\\left[ \\left[ J^{(1)}, R^{(1)} \\right], \\left[ J^{(2)}, R^{(2)} \\right], \\left[ J^{(3)}, R^{(3)} \\right], \\left[ J^{(4)}, R^{(4)} \\right] \\right]$,\nwhere $J^{(k)}$ is the $3 \\times 4$ list of Jacobians for case $k$, and $R^{(k)}$ is the ranking list for case $k$. The printed line must contain no extra spaces.",
            "solution": "The problem is scientifically grounded, well-posed, and provides a complete set of definitions, constants, and test cases. It represents a a standard, albeit simplified, problem in atmospheric radiative transfer. Therefore, the problem is valid and a solution will be derived and implemented.\n\nThe core of the problem is to construct a forward model for the top-of-atmosphere (TOA) brightness temperature, $T_b$, and then to compute its sensitivity (Jacobian) with respect to changes in hydrometeor concentrations.\n\n**1. Forward Model Derivation**\n\nThe problem specifies a one-dimensional, plane-parallel atmosphere modeled as a single, homogeneous slab. We start with the Schwarzschild equation for radiative transfer in a non-scattering medium under local thermodynamic equilibrium (LTE). In the Rayleigh-Jeans limit, where radiance is linearly proportional to brightness temperature, this equation can be written as:\n$$\n\\frac{d T_b}{d \\tau'} = T(s) - T_b\n$$\nwhere $T_b$ is the brightness temperature of the radiation, $T(s)$ is the local thermodynamic temperature of the medium at position $s$ along the path, and $d \\tau'$ is the differential optical depth along the path. The problem asks for a solution for upwelling radiation. Let's define the total optical depth along the line of sight (LOS) through the slab as $\\tau_{\\mathrm{opt}}$. Integrating the Schwarzschild equation from the surface (where the outgoing brightness temperature is $T_b^{\\mathrm{surf}}$) to the top of the atmosphere (TOA, where we want to find $T_b$) yields the formal solution:\n$$\nT_b(\\text{TOA}) = T_b^{\\mathrm{surf}} e^{-\\tau_{\\mathrm{opt}}} + \\int_{0}^{\\tau_{\\mathrm{opt}}} T(s(\\tau')) e^{-\\tau'} d\\tau'\n$$\nThe problem states the slab is homogeneous with a constant layer temperature $T_\\ell$. Thus, $T(s(\\tau')) = T_\\ell$ is a constant. The integral can now be solved:\n$$\n\\int_{0}^{\\tau_{\\mathrm{opt}}} T_\\ell e^{-\\tau'} d\\tau' = T_\\ell \\left[ -e^{-\\tau'} \\right]_{0}^{\\tau_{\\mathrm{opt}}} = T_\\ell \\left( -e^{-\\tau_{\\mathrm{opt}}} - (-e^{-0}) \\right) = T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}})\n$$\nThe surface brightness temperature is given as $T_b^{\\mathrm{surf}} = \\varepsilon T_s$, where $\\varepsilon$ is the surface emissivity and $T_s$ is the surface thermodynamic temperature. Substituting these results into the formal solution gives the forward model for the TOA brightness temperature, which we will simply denote as $T_b$:\n$$\nT_b(\\nu) = (\\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} + T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}(\\nu)})\n$$\nThis can be rearranged for computational convenience:\n$$\nT_b(\\nu) = T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}(\\nu)}\n$$\n\n**2. Optical Depth and Extinction**\n\nThe total optical depth along the line of sight, $\\tau_{\\mathrm{opt}}(\\nu)$, is given by:\n$$\n\\tau_{\\mathrm{opt}}(\\nu) = \\frac{M}{\\mu} K(\\nu)\n$$\nwhere $M$ is the column mass path of the slab, $\\mu = \\cos(\\theta \\times \\pi / 180)$ is the path factor for a viewing zenith angle $\\theta$, and $K(\\nu)$ is the total mass-extinction coefficient per unit mass path. $K(\\nu)$ is the sum of contributions from gases and hydrometeors:\n$$\nK(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) q_i\n$$\nThe sum is over the four hydrometeor species: cloud ice ($i=\\mathrm{ice}$), cloud liquid ($i=\\mathrm{liq}$), rain ($i=\\mathrm{rain}$), and snow ($i=\\mathrm{snow}$). Here, $\\kappa_g(\\nu)$ is the gas mass-extinction coefficient, $\\alpha_i(\\nu)$ is the mass-extinction coefficient for species $i$, and $q_i$ is the mixing ratio of species $i$.\n\n**3. Jacobian Derivation**\n\nThe primary task is to compute the Jacobians, which are the partial derivatives of the TOA brightness temperature with respect to each hydrometeor mixing ratio, $\\dfrac{\\partial T_b}{\\partial q_i}$. We use the chain rule:\n$$\n\\frac{\\partial T_b}{\\partial q_i} = \\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} \\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i}\n$$\nFirst, we compute the derivative of $T_b$ with respect to $\\tau_{\\mathrm{opt}}$:\n$$\n\\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} = \\frac{\\partial}{\\partial \\tau_{\\mathrm{opt}}} \\left[ T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}} \\right] = (\\varepsilon T_s - T_\\ell) (-e^{-\\tau_{\\mathrm{opt}}}) = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}}\n$$\nNext, we compute the derivative of $\\tau_{\\mathrm{opt}}$ with respect to a specific mixing ratio $q_i$:\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} \\left[ \\frac{M}{\\mu} \\left( \\kappa_g(\\nu) + \\sum_{j} \\alpha_j(\\nu) q_j \\right) \\right]\n$$\nSince the mixing ratios $q_j$ are independent variables, the derivative is non-zero only for the term where $j=i$:\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\nCombining these two parts gives the final expression for the Jacobian:\n$$\n\\frac{\\partial T_b(\\nu)}{\\partial q_i} = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\nThis expression shows that the sensitivity of the brightness temperature to a change in a hydrometeor amount depends on the contrast between the atmospheric layer temperature $T_\\ell$ and the surface brightness temperature $\\varepsilon T_s$, the total atmospheric opacity (through the $e^{-\\tau_{\\mathrm{opt}}}$ term), the amount of mass in the path ($M/\\mu$), and the specific extinction property of that hydrometeor species ($\\alpha_i(\\nu)$).\n\n**4. Algorithmic Procedure**\n\nFor each test case and each of the three frequency channels, the following steps are performed:\n1.  Calculate the path factor $\\mu = \\cos(\\theta \\times \\pi / 180)$.\n2.  Compute the total mass-extinction coefficient $K(\\nu)$ for each channel using the given gas and hydrometeor coefficients and mixing ratios.\n3.  Compute the line-of-sight optical depth $\\tau_{\\mathrm{opt}}(\\nu) = (M/\\mu) K(\\nu)$ for each channel.\n4.  Use the derived Jacobian formula to calculate the $3 \\times 4$ matrix of sensitivities, $\\dfrac{\\partial T_b(\\nu)}{\\partial q_i}$, where rows correspond to the three channels (indexed $0, 1, 2$) and columns correspond to the four hydrometeor species ($q_{\\mathrm{ice}}, q_{\\mathrm{liq}}, q_{\\mathrm{rain}}, q_{\\mathrm{snow}}$).\n5.  Extract the column of Jacobians corresponding to cloud ice, $\\left|\\dfrac{\\partial T_b(\\nu)}{\\partial q_{\\mathrm{ice}}}\\right|$, for all three channels.\n6.  Sort the channel indices ($0, 1, 2$) in descending order based on the magnitude of these ice sensitivity values to obtain the channel ranking.\n7.  The results for each test case, consisting of the Jacobian matrix and the ranked channel indices, are collected and formatted into the specified string output.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes channel-wise Jacobians of TOA brightness temperature with respect\n    to hydrometeor mixing ratios and ranks channels by sensitivity to cloud ice.\n    \"\"\"\n\n    # --- Define Constants ---\n    # Frequencies: [23.8, 36.5, 89.0] GHz\n    # Channel indices: 0, 1, 2\n\n    # Gas mass-extinction coefficients (m^2/kg)\n    K_G = np.array([0.015, 0.012, 0.025])\n\n    # Hydrometeor mass-extinction coefficients (m^2/kg)\n    # Rows: ice, liq, rain, snow\n    # Columns: 23.8 GHz, 36.5 GHz, 89.0 GHz\n    A_HYDROMETEORS = np.array([\n        [0.020, 0.050, 0.250],  # cloud ice\n        [0.150, 0.200, 0.300],  # cloud liquid\n        [0.600, 0.800, 1.100],  # rain\n        [0.300, 0.400, 0.800]   # snow\n    ])\n\n    # --- Test Cases ---\n    # (T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow)\n    test_cases = [\n        (290.0, 260.0, 0.95, 53.0, 2.0, 5e-4, 1e-3, 1e-4, 2e-4),\n        (288.0, 270.0, 0.90, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0),\n        (300.0, 240.0, 0.60, 60.0, 5.0, 1e-3, 5e-4, 2e-4, 1e-3),\n        (285.0, 255.0, 0.97, 45.0, 8.0, 8e-4, 2e-3, 5e-4, 3e-4),\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow = case\n        \n        q = np.array([q_ice, q_liq, q_rain, q_snow])\n\n        # --- Calculations ---\n        # 1. Path factor mu = cos(theta)\n        mu = np.cos(theta_deg * np.pi / 180.0)\n\n        # 2. Total mass-extinction coefficient K(nu) for each channel\n        # K = k_g + sum(alpha_i * q_i)\n        hydrometeor_extinction = np.sum(A_HYDROMETEORS * q[:, np.newaxis], axis=0)\n        K = K_G + hydrometeor_extinction\n\n        # 3. Optical depth tau_opt(nu) for each channel\n        tau_opt = (M / mu) * K\n\n        # 4. Calculate Jacobians: d(Tb)/d(qi) = (T_l - eps*T_s) * exp(-tau_opt) * (M/mu) * alpha_i\n        \n        # This is the common part of the Jacobian for all hydrometeor species, per channel\n        # The result is a 3-element array.\n        common_factor_per_channel = (T_l - epsilon * T_s) * np.exp(-tau_opt) * (M / mu)\n        \n        # Calculate the full Jacobian matrix.\n        # This broadcasts the (3,) common_factor array across the columns of the (4, 3) A_HYDROMETEORS array.\n        # The result is a (4, 3) matrix: rows are species, columns are channels.\n        jacobian_matrix = A_HYDROMETEORS * common_factor_per_channel\n\n        # The required output format is 3x4 (channels x species).\n        jacobian_output = jacobian_matrix.T.tolist()\n\n        # 5. Rank channels by absolute sensitivity to cloud ice\n        # Jacobians for ice are in the first row of the (4, 3) jacobian_matrix\n        ice_sensitivities = np.abs(jacobian_matrix[0, :])\n        \n        # argsort sorts in ascending order. We sort the negative to get descending order.\n        ranked_channel_indices = np.argsort(-ice_sensitivities).tolist()\n\n        all_results.append([jacobian_output, ranked_channel_indices])\n\n    # Final print statement in the exact required format.\n    # str() creates the nested list representation, and .replace(' ', '') removes all spaces.\n    print(str(all_results).replace(' ', ''))\n\nsolve()\n```"
        },
        {
            "introduction": "Variational data assimilation methods use a linearized version of the observation operator, known as the tangent-linear (TL) model, to find an optimal analysis. Before being used operationally, the TL model must be rigorously tested to ensure it accurately approximates the full non-linear model for small perturbations. This final practice introduces a standard numerical consistency test, allowing you to verify the correctness of a TL operator and understand the limits of its validity .",
            "id": "4011519",
            "problem": "Consider an all-sky radiance assimilation setting in numerical weather prediction and climate modeling, where the observation operator maps a model state to top-of-atmosphere brightness temperatures for two microwave channels. The operator for each channel is a blend of clear-sky and cloudy-sky components, weighted by cloud fraction and parameterized by Beer-Lambert transmittance. Let the state vector be $\\mathbf{x} = [T_s, T_a, T_c, q, L, c]$, where $T_s$ is the surface temperature, $T_a$ is a representative clear-sky atmospheric temperature, $T_c$ is a representative cloudy-sky atmospheric temperature, $q$ is the water vapor mass mixing ratio, $L$ is the cloud liquid water path proxy, and $c$ is the cloud fraction. Assume Rayleigh-Jeans brightness for microwaves so that the source function is approximated by the temperature itself.\n\nFor microwave channel $i \\in \\{1,2\\}$, define the clear-sky transmittance\n$$\n\\tau_{\\mathrm{clr}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q\\big)\n$$\nand the cloudy-sky transmittance\n$$\n\\tau_{\\mathrm{cld}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L\\big),\n$$\nwith absorption coefficients\n$$\n\\kappa_q^{(1)} = 0.08,\\quad \\kappa_l^{(1)} = 0.02,\\quad \\kappa_q^{(2)} = 0.02,\\quad \\kappa_l^{(2)} = 0.08.\n$$\nThe brightness temperature for channel $i$ is\n$$\ny^{(i)}(\\mathbf{x}) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right].\n$$\nLet $H(\\mathbf{x}) = \\big[y^{(1)}(\\mathbf{x}), y^{(2)}(\\mathbf{x})\\big]^\\top$ be the two-channel forward operator. The tangent-linear operator $\\mathcal{H}$ is the Jacobian of $H$ applied to a perturbation $\\delta\\mathbf{x}$. A standard tangent-linear consistency test evaluates\n$$\n\\mathcal{R}(\\epsilon; \\mathbf{x}, \\delta \\mathbf{x}) = \\frac{\\left\\|H\\!\\left(\\mathbf{x}+\\epsilon\\,\\delta \\mathbf{x}\\right) - H(\\mathbf{x}) - \\epsilon\\, \\mathcal{H}\\,\\delta \\mathbf{x}\\right\\|_2}{\\epsilon\\, \\left\\|\\mathcal{H}\\,\\delta \\mathbf{x}\\right\\|_2},\n$$\nfor a sequence of perturbation scales $\\epsilon$, where $\\|\\cdot\\|_2$ denotes the Euclidean norm.\n\nStarting from the Beer-Lambert law and the Rayleigh-Jeans approximation for microwave brightness temperature, and treating cloud fraction blending as a convex combination of clear and cloudy contributions, derive the expressions necessary to implement $H(\\mathbf{x})$ and the action of $\\mathcal{H}$ on $\\delta\\mathbf{x}$. Then, write a program that:\n- Implements $H(\\mathbf{x})$ using the formulas above.\n- Implements $\\mathcal{H}\\,\\delta\\mathbf{x}$ by analytically differentiating $H$ with respect to the components of $\\mathbf{x}$ and applying the result to $\\delta\\mathbf{x}$.\n- Computes $\\mathcal{R}(\\epsilon; \\mathbf{x}, \\delta \\mathbf{x})$ for the $\\epsilon$ sequence $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$.\n\nAcceptance criteria for linearity: for a given $(\\mathbf{x},\\delta\\mathbf{x})$, declare the tangent-linear approximation acceptable if the sequence of ratios $\\mathcal{R}$ is strictly decreasing for $\\epsilon \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}\\}$ and the value at $\\epsilon = 10^{-4}$ is less than $10^{-3}$. If the denominator $\\epsilon\\,\\|\\mathcal{H}\\,\\delta\\mathbf{x}\\|_2$ is numerically zero (less than $10^{-12}$), treat the case as not acceptable.\n\nYour program must evaluate the acceptance for each of the following four test cases (each test case specifies $(\\mathbf{x},\\delta\\mathbf{x})$):\n\n- Test case $1$ (typical midlatitude, partially cloudy): $\\mathbf{x} = [288.0, 275.0, 265.0, 0.012, 0.10, 0.40]$, $\\delta\\mathbf{x} = [0.5, -0.3, 0.2, 0.001, 0.02, -0.05]$.\n- Test case $2$ (clear-sky boundary): $\\mathbf{x} = [290.0, 270.0, 260.0, 0.010, 0.05, 0.00]$, $\\delta\\mathbf{x} = [0.5, -0.2, 0.1, 0.0005, 0.01, 0.10]$.\n- Test case $3$ (overcast boundary): $\\mathbf{x} = [285.0, 272.0, 262.0, 0.015, 0.20, 1.00]$, $\\delta\\mathbf{x} = [0.2, 0.2, -0.3, -0.002, 0.03, -0.10]$.\n- Test case $4$ (moist and thicker clouds): $\\mathbf{x} = [292.0, 278.0, 268.0, 0.030, 0.30, 0.70]$, $\\delta\\mathbf{x} = [-0.4, 0.4, 0.0, 0.003, -0.05, 0.00]$.\n\nAll temperatures are in Kelvin, and $q$, $L$, and $c$ are dimensionless in this simplified parameterization. The ratio $\\mathcal{R}$ is dimensionless. Angles are not used.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,result3,result4]$), where each entry is a boolean indicating whether the acceptance criteria are met for the corresponding test case.",
            "solution": "The problem is valid. It presents a well-posed, scientifically grounded numerical task common in the field of geophysical data assimilation. It is self-contained, with all necessary mathematical definitions, physical parameters, and test conditions provided.\n\nThe core of the problem is to derive the tangent-linear operator $\\mathcal{H}$ for a given non-linear forward operator $H(\\mathbf{x})$ and to perform a numerical consistency check. The forward operator $H(\\mathbf{x})$ maps a six-component state vector $\\mathbf{x} = [T_s, T_a, T_c, q, L, c]^\\top$ to a two-component observation vector of brightness temperatures $\\mathbf{y} = [y^{(1)}, y^{(2)}]^\\top$. The components of $\\mathbf{x}$ are the surface temperature $T_s$, clear-sky atmospheric temperature $T_a$, cloudy-sky atmospheric temperature $T_c$, water vapor $q$, cloud liquid water $L$, and cloud fraction $c$.\n\nThe brightness temperature for each of the two channels $i \\in \\{1, 2\\}$ is given by:\n$$\ny^{(i)}(\\mathbf{x}) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right]\n$$\nThis can be simplified by defining the clear-sky brightness temperature $y_{\\mathrm{clr}}^{(i)}$ and cloudy-sky brightness temperature $y_{\\mathrm{cld}}^{(i)}$:\n$$\ny_{\\mathrm{clr}}^{(i)} = \\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\n$$\n$$\ny_{\\mathrm{cld}}^{(i)} = \\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\n$$\nThus, $y^{(i)}(\\mathbf{x})$ is a convex combination weighted by the cloud fraction $c$:\n$$\ny^{(i)}(\\mathbf{x}) = (1-c) y_{\\mathrm{clr}}^{(i)} + c y_{\\mathrm{cld}}^{(i)}\n$$\nThe transmittances $\\tau_{\\mathrm{clr}}^{(i)}$ and $\\tau_{\\mathrm{cld}}^{(i)}$ depend on the state variables $q$ and $L$:\n$$\n\\tau_{\\mathrm{clr}}^{(i)}(q) = \\exp(-\\kappa_q^{(i)} q)\n$$\n$$\n\\tau_{\\mathrm{cld}}^{(i)}(q, L) = \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L)\n$$\n\nThe tangent-linear operator $\\mathcal{H}$ is the Jacobian of $H(\\mathbf{x})$, a $2 \\times 6$ matrix whose elements are the partial derivatives of each component of $H$ with respect to each component of $\\mathbf{x}$. The action of $\\mathcal{H}$ on a perturbation vector $\\delta\\mathbf{x}$ is the matrix-vector product $\\mathcal{H}\\,\\delta\\mathbf{x}$. To compute this, we need the partial derivatives of $y^{(i)}$ with respect to each of the $6$ components of $\\mathbf{x}$. We find these using the chain rule.\n\nFirst, we find the derivatives of the transmittances with respect to the state variables on which they depend:\n$$\n\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q) = -\\kappa_q^{(i)} \\tau_{\\mathrm{clr}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_q^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -\\kappa_l^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_l^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\nNote that $\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial L} = 0$.\n\nNow, we compute the partial derivatives of $y^{(i)}$:\n1.  Derivative with respect to $T_s$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_s} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_s} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_s} = (1-c)\\tau_{\\mathrm{clr}}^{(i)} + c\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n2.  Derivative with respect to $T_a$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_a} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_a} = (1-c)(1-\\tau_{\\mathrm{clr}}^{(i)})\n    $$\n3.  Derivative with respect to $T_c$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_c} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_c} = c(1-\\tau_{\\mathrm{cld}}^{(i)})\n    $$\n4.  Derivative with respect to $q$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial q} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial q} = (1-c)(T_s - T_a)\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} + c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q}\n    $$\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = -(1-c)(T_s - T_a)\\kappa_q^{(i)}\\tau_{\\mathrm{clr}}^{(i)} - c(T_s - T_c)\\kappa_q^{(i)}\\tau_{\\mathrm{cld}}^{(i)} = -\\kappa_q^{(i)}\\left[(1-c)\\tau_{\\mathrm{clr}}^{(i)}(T_s-T_a) + c\\tau_{\\mathrm{cld}}^{(i)}(T_s-T_c)\\right]\n    $$\n5.  Derivative with respect to $L$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial L} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial L} = c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -c(T_s - T_c)\\kappa_l^{(i)}\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n6.  Derivative with respect to $c$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial c} = -y_{\\mathrm{clr}}^{(i)} + y_{\\mathrm{cld}}^{(i)}\n    $$\n\nThe action of the tangent-linear operator on a perturbation $\\delta\\mathbf{x} = [\\delta T_s, \\delta T_a, \\delta T_c, \\delta q, \\delta L, \\delta c]^\\top$ is then given by the vector whose $i$-th component is:\n$$\n(\\mathcal{H}\\,\\delta\\mathbf{x})_i = \\frac{\\partial y^{(i)}}{\\partial T_s}\\delta T_s + \\frac{\\partial y^{(i)}}{\\partial T_a}\\delta T_a + \\frac{\\partial y^{(i)}}{\\partial T_c}\\delta T_c + \\frac{\\partial y^{(i)}}{\\partial q}\\delta q + \\frac{\\partial y^{(i)}}{\\partial L}\\delta L + \\frac{\\partial y^{(i)}}{\\partial c}\\delta c\n$$\nThis is the dot product of the gradient of $y^{(i)}$ and the perturbation vector $\\delta\\mathbf{x}$.\n\nThe implementation will consist of two functions: one for the non-linear operator $H(\\mathbf{x})$ and one for the tangent-linear action $\\mathcal{H}\\,\\delta\\mathbf{x}$. A loop will then iterate through the four provided test cases. For each case, the consistency ratio $\\mathcal{R}(\\epsilon; \\mathbf{x}, \\delta \\mathbf{x})$ is calculated for a sequence of $\\epsilon$ values: $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$. The denominator $\\epsilon\\,\\|\\mathcal{H}\\,\\delta\\mathbf{x}\\|_2$ is checked against a threshold of $10^{-12}$ to prevent division by zero and identify cases where the perturbation has no effect in the linear approximation.\n\nFinally, the acceptance criteria are applied: the sequence of the first four ratios $\\mathcal{R}(\\epsilon)$ must be strictly decreasing, and the value of $\\mathcal{R}$ at $\\epsilon = 10^{-4}$ must be less than $10^{-3}$. A boolean result (True/False) is recorded for each test case based on these criteria.",
            "answer": "```python\nimport numpy as np\n\n# Define global constants as specified in the problem\nKAPPAS = {\n    1: {'q': 0.08, 'l': 0.02},\n    2: {'q': 0.02, 'l': 0.08}\n}\nEPSILONS = [10**(-i) for i in range(1, 6)]\nZERO_THRESHOLD = 1e-12\nACCEPTANCE_THRESHOLD = 1e-3\n\ndef H_operator(x):\n    \"\"\"\n    Implements the non-linear forward operator H(x).\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n    \n    Returns:\n        np.ndarray: The 2-element observation vector [y^(1), y^(2)].\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    y = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        \n        y[i-1] = (1 - c) * y_clr_i + c * y_cld_i\n        \n    return y\n\ndef H_tl_operator(x, dx):\n    \"\"\"\n    Implements the action of the tangent-linear operator H_tl on a perturbation dx.\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n        dx (np.ndarray): The perturbation vector [dTs, dTa, dTc, dq, dL, dc].\n    \n    Returns:\n        np.ndarray: The 2-element result vector H_tl * dx.\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    H_dx = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        # Partial derivatives\n        d_y_i_d_Ts = (1 - c) * tau_clr_i + c * tau_cld_i\n        d_y_i_d_Ta = (1 - c) * (1 - tau_clr_i)\n        d_y_i_d_Tc = c * (1 - tau_cld_i)\n        d_y_i_d_q = -kappa_q_i * ((1 - c) * tau_clr_i * (Ts - Ta) + c * tau_cld_i * (Ts - Tc))\n        d_y_i_d_L = -c * kappa_l_i * tau_cld_i * (Ts - Tc)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        d_y_i_d_c = y_cld_i - y_clr_i\n        \n        jacobian_row_i = np.array([\n            d_y_i_d_Ts, d_y_i_d_Ta, d_y_i_d_Tc,\n            d_y_i_d_q, d_y_i_d_L, d_y_i_d_c\n        ])\n        \n        H_dx[i-1] = np.dot(jacobian_row_i, dx)\n        \n    return H_dx\n\ndef solve():\n    \"\"\"\n    Main function to run the tangent-linear test for all specified cases.\n    \"\"\"\n    test_cases = [\n        # Test case 1\n        (np.array([288.0, 275.0, 265.0, 0.012, 0.10, 0.40]), \n         np.array([0.5, -0.3, 0.2, 0.001, 0.02, -0.05])),\n        # Test case 2\n        (np.array([290.0, 270.0, 260.0, 0.010, 0.05, 0.00]), \n         np.array([0.5, -0.2, 0.1, 0.0005, 0.01, 0.10])),\n        # Test case 3\n        (np.array([285.0, 272.0, 262.0, 0.015, 0.20, 1.00]), \n         np.array([0.2, 0.2, -0.3, -0.002, 0.03, -0.10])),\n        # Test case 4\n        (np.array([292.0, 278.0, 268.0, 0.030, 0.30, 0.70]), \n         np.array([-0.4, 0.4, 0.0, 0.003, -0.05, 0.00])),\n    ]\n\n    results = []\n    \n    for x, dx in test_cases:\n        Hx = H_operator(x)\n        H_tl_dx = H_tl_operator(x, dx)\n        \n        norm_H_tl_dx = np.linalg.norm(H_tl_dx)\n        \n        R_values = []\n        is_acceptable = True\n        \n        for epsilon in EPSILONS:\n            denominator = epsilon * norm_H_tl_dx\n            if denominator < ZERO_THRESHOLD:\n                is_acceptable = False\n                break\n            \n            x_pert = x + epsilon * dx\n            Hx_pert = H_operator(x_pert)\n            \n            numerator = np.linalg.norm(Hx_pert - Hx - epsilon * H_tl_dx)\n            \n            R_values.append(numerator / denominator)\n            \n        if not is_acceptable:\n            results.append(False)\n            continue\n            \n        # Check acceptance criteria on the calculated ratios\n        # 1. Strictly decreasing for the first 4 epsilon values\n        is_strictly_decreasing = (\n            R_values[0] > R_values[1] and\n            R_values[1] > R_values[2] and\n            R_values[2] > R_values[3]\n        )\n        \n        # 2. Value at epsilon = 1e-4 is less than the threshold\n        is_small_enough = R_values[3] < ACCEPTANCE_THRESHOLD\n        \n        results.append(is_strictly_decreasing and is_small_enough)\n            \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}