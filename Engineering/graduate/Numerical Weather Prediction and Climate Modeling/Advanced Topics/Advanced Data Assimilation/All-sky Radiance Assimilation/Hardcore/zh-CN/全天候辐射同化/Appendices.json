{
    "hands_on_practices": [
        {
            "introduction": "任何数据同化系统的核心都是前向算子，它根据模式状态模拟观测值。在全天候同化中，该算子必须真实地表示云和降水对卫星辐射的影响。本练习将指导您构建一个简化的微波辐射传输模型，并计算其雅可比矩阵——即亮温对水凝物含量变化的敏感度。掌握这一步对于理解卫星测量如何提供云信息，以及为发展先进数据同化所需的切线性和伴随模型至关重要。",
            "id": "4011543",
            "problem": "您的任务是构建并分析一个简化的、物理上一致的正向模型，该模型与数值天气预报和气候模拟中微波成像仪的全天辐射率同化相关。目标是计算大气层顶亮度温度相对于水凝物混合比的逐通道雅可比矩阵，并根据通道对云冰的敏感度进行排序。\n\n基本和建模假设：从微波（MW）波段下、局地热力学平衡（LTE）中、无散射的一维平面平行热辐射传输开始。其控制定律是用于上行辐射的 Schwarzschild 方程。将大气表示为一个由天底轨道成像仪观测的、具有恒定温度和消光的单一均匀板层。设大气层顶（TOA）亮度温度在 Rayleigh-Jeans 极限下考虑，并包含一个具有指定发射率的非黑体表面。\n\n待使用的定义和变量：\n- 亮度温度和热力学温度用 $T$ 表示，单位必须是开尔文（$\\mathrm{K}$）。\n- 地表温度 $T_s$（单位 $\\mathrm{K}$），层温度 $T_\\ell$（单位 $\\mathrm{K}$），以及地表发射率 $\\varepsilon$（无量纲）。\n- 观测天顶角 $\\theta$（单位度），路径因子 $\\mu = \\cos(\\theta \\times \\pi / 180)$（无量纲）。\n- 板层的柱质量路径 $M$（单位 $\\mathrm{kg}\\,\\mathrm{m}^{-2}$）。\n- 每个通道频率 $\\nu$ 的单位质量路径的气体质量消光系数 $\\,\\kappa_g(\\nu)$（单位 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$）。\n- 四种水凝物种类的混合比 $q_i$（无量纲，单位 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$）：云冰 ($q_{\\mathrm{ice}}$)、云液 ($q_{\\mathrm{liq}}$)、雨 ($q_{\\mathrm{rain}}$)和雪 ($q_{\\mathrm{snow}}$)。\n- 水凝物质量消光系数 $\\,\\alpha_i(\\nu)$（与种类和频率相关，单位 $\\mathrm{m}^2\\,\\mathrm{kg}^{-1}$）。\n- 通道对应三个频率：$23.8$、$36.5$ 和 $89.0$ 千兆赫（GHz）。\n\n要实现的正向模型规范：\n- 在一个均匀板层中使用 Schwarzschild 方程，其源函数等于 Rayleigh-Jeans 极限下的普朗克函数，并具有入射地表亮度温度 $T_b^{\\mathrm{surf}} = \\varepsilon T_s$。\n- 给定通道的单位质量路径的总质量消光为 $K(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) \\, q_i$，其中求和遍历四种水凝物种类。\n- 板层沿视线的光学深度为 $\\tau_{\\mathrm{opt}}(\\nu) = \\dfrac{M}{\\mu} \\, K(\\nu)$。\n- 每个通道的大气层顶亮度温度是 Schwarzschild 方程沿视线的均匀板层解，并采用指定的地表边界条件。\n\n您的程序必须为每个测试用例和每个通道计算：\n1. 相对于每种水凝物混合比 $q_i$ 的雅可比矩阵 $\\dfrac{\\partial T_b}{\\partial q_i}$，其中 $i \\in \\{\\mathrm{ice}, \\mathrm{liq}, \\mathrm{rain}, \\mathrm{snow}\\}$；单位必须报告为 $\\mathrm{K}$ 每 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$。\n2. 按对云冰的绝对敏感度对通道进行排序，即按 $\\left|\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}\\right|$ 的降序对通道排序，并使用与 $[23.8\\,\\mathrm{GHz} \\rightarrow 0,\\; 36.5\\,\\mathrm{GHz} \\rightarrow 1,\\; 89.0\\,\\mathrm{GHz} \\rightarrow 2]$ 对应的从0开始的索引报告通道索引。\n\n对这三个通道使用以下科学上合理的系数：\n- 气体质量消光系数（每单位质量路径）：对于 $\\nu = [23.8, 36.5, 89.0]\\ \\mathrm{GHz}$，$\\kappa_g(\\nu)$ 分别为 $[0.015,\\ 0.012,\\ 0.025]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n- 水凝物质量消光系数：\n  - 云冰: $\\alpha_{\\mathrm{ice}}(\\nu) = [0.020,\\ 0.050,\\ 0.250]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 云液: $\\alpha_{\\mathrm{liq}}(\\nu) = [0.150,\\ 0.200,\\ 0.300]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 雨: $\\alpha_{\\mathrm{rain}}(\\nu) = [0.600,\\ 0.800,\\ 1.100]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n  - 雪: $\\alpha_{\\mathrm{snow}}(\\nu) = [0.300,\\ 0.400,\\ 0.800]\\ \\mathrm{m}^2\\,\\mathrm{kg}^{-1}$。\n\n测试套件：实现以下四个测试用例。角度单位必须解释为度，温度为开尔文，$M$ 为 $\\mathrm{kg}\\,\\mathrm{m}^{-2}$，混合比为 $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$。\n- 用例 $1$（正常路径，倾斜视角，中等云量）：$T_s = 290$, $T_\\ell = 260$, $\\varepsilon = 0.95$, $\\theta = 53$, $M = 2.0$, $q_{\\mathrm{ice}} = 5\\times 10^{-4}$, $q_{\\mathrm{liq}} = 1\\times 10^{-3}$, $q_{\\mathrm{rain}} = 1\\times 10^{-4}$, $q_{\\mathrm{snow}} = 2\\times 10^{-4}$。\n- 用例 $2$（边界情况，晴空无水凝物，天底视角）：$T_s = 288$, $T_\\ell = 270$, $\\varepsilon = 0.90$, $\\theta = 0$, $M = 2.0$, $q_{\\mathrm{ice}} = 0$, $q_{\\mathrm{liq}} = 0$, $q_{\\mathrm{rain}} = 0$, $q_{\\mathrm{snow}} = 0$。\n- 用例 $3$（边缘情况，掠射路径，低发射率，冷云）：$T_s = 300$, $T_\\ell = 240$, $\\varepsilon = 0.60$, $\\theta = 60$, $M = 5.0$, $q_{\\mathrm{ice}} = 1\\times 10^{-3}$, $q_{\\mathrm{liq}} = 5\\times 10^{-4}$, $q_{\\mathrm{rain}} = 2\\times 10^{-4}$, $q_{\\mathrm{snow}} = 1\\times 10^{-3}$。\n- 用例 $4$（边缘情况，较厚板层，较强气体消光）：$T_s = 285$, $T_\\ell = 255$, $\\varepsilon = 0.97$, $\\theta = 45$, $M = 8.0$, $q_{\\mathrm{ice}} = 8\\times 10^{-4}$, $q_{\\mathrm{liq}} = 2\\times 10^{-3}$, $q_{\\mathrm{rain}} = 5\\times 10^{-4}$, $q_{\\mathrm{snow}} = 3\\times 10^{-4}$。\n\n最终输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。此外层列表的每个元素对应一个测试用例，其本身是一个包含两个元素的列表：第一个元素是一个 $3 \\times 4$ 的浮点数嵌套列表，给出每个通道的雅可比矩阵 $\\left[\\dfrac{\\partial T_b}{\\partial q_{\\mathrm{ice}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{liq}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{rain}}}, \\dfrac{\\partial T_b}{\\partial q_{\\mathrm{snow}}}\\right]$；第二个元素是按对云冰的绝对敏感度排序的通道索引列表。具体来说，输出必须具有形式 $\\left[ \\left[ J^{(1)}, R^{(1)} \\right], \\left[ J^{(2)}, R^{(2)} \\right], \\left[ J^{(3)}, R^{(3)} \\right], \\left[ J^{(4)}, R^{(4)} \\right] \\right]$，其中 $J^{(k)}$ 是用例 $k$ 的 $3 \\times 4$ 雅可比矩阵列表，而 $R^{(k)}$ 是用例 $k$ 的排序列表。打印的行不得包含多余的空格。",
            "solution": "该问题在科学上是合理的、定义明确的，并提供了一套完整的定义、常数和测试用例。它代表了大气辐射传输中一个标准的、尽管是简化了的问题。因此，该问题是有效的，我们将推导并实现一个解决方案。\n\n问题的核心是为大气层顶（TOA）亮度温度 $T_b$ 构建一个正向模型，然后计算其对水凝物浓度变化的敏感度（雅可比）。\n\n**1. 正向模型推导**\n\n问题指定了一个一维的、平面平行的大气，模型化为一个单一的均匀板层。我们从局地热力学平衡（LTE）下非散射介质中辐射传输的 Schwarzschild 方程开始。在 Rayleigh-Jeans 极限下，辐射率与亮度温度成线性比例，该方程可以写成：\n$$\n\\frac{d T_b}{d \\tau'} = T(s) - T_b\n$$\n其中 $T_b$ 是辐射的亮度温度，$T(s)$ 是沿路径位置 $s$ 处介质的局地热力学温度，$d \\tau'$ 是沿路径的光学深度微分。问题要求一个上行辐射的解。我们将穿过板层的沿视线（LOS）的总光学深度定义为 $\\tau_{\\mathrm{opt}}$。将 Schwarzschild 方程从地表（出射亮度温度为 $T_b^{\\mathrm{surf}}$）积分到大气层顶（TOA，我们想要求解 $T_b$ 的地方），得到形式解：\n$$\nT_b(\\text{TOA}) = T_b^{\\mathrm{surf}} e^{-\\tau_{\\mathrm{opt}}} + \\int_{0}^{\\tau_{\\mathrm{opt}}} T(s(\\tau')) e^{-\\tau'} d\\tau'\n$$\n问题指出该板层是均匀的，具有恒定的层温度 $T_\\ell$。因此，$T(s(\\tau')) = T_\\ell$ 是一个常数。现在可以求解该积分：\n$$\n\\int_{0}^{\\tau_{\\mathrm{opt}}} T_\\ell e^{-\\tau'} d\\tau' = T_\\ell \\left[ -e^{-\\tau'} \\right]_{0}^{\\tau_{\\mathrm{opt}}} = T_\\ell \\left( -e^{-\\tau_{\\mathrm{opt}}} - (-e^{-0}) \\right) = T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}})\n$$\n地表亮度温度由 $T_b^{\\mathrm{surf}} = \\varepsilon T_s$ 给出，其中 $\\varepsilon$ 是地表发射率，$T_s$ 是地表热力学温度。将这些结果代入形式解，得到大气层顶亮度温度的正向模型，我们将其简记为 $T_b$：\n$$\nT_b(\\nu) = (\\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} + T_\\ell(1 - e^{-\\tau_{\\mathrm{opt}}(\\nu)})\n$$\n为了计算方便，可以重新排列为：\n$$\nT_b(\\nu) = T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}(\\nu)}\n$$\n\n**2. 光学深度和消光**\n\n沿视线的总光学深度 $\\tau_{\\mathrm{opt}}(\\nu)$ 由下式给出：\n$$\n\\tau_{\\mathrm{opt}}(\\nu) = \\frac{M}{\\mu} K(\\nu)\n$$\n其中 $M$ 是板层的柱质量路径，$\\mu = \\cos(\\theta \\times \\pi / 180)$ 是观测天顶角 $\\theta$ 的路径因子，$K(\\nu)$ 是单位质量路径的总质量消光系数。$K(\\nu)$ 是来自气体和水凝物的贡献之和：\n$$\nK(\\nu) = \\kappa_g(\\nu) + \\sum_{i} \\alpha_i(\\nu) q_i\n$$\n求和遍历四种水凝物种类：云冰（$i=\\mathrm{ice}$）、云液（$i=\\mathrm{liq}$）、雨（$i=\\mathrm{rain}$）和雪（$i=\\mathrm{snow}$）。这里，$\\kappa_g(\\nu)$ 是气体质量消光系数，$\\alpha_i(\\nu)$ 是种类 $i$ 的质量消光系数，$q_i$ 是种类 $i$ 的混合比。\n\n**3. 雅可比矩阵推导**\n\n主要任务是计算雅可比矩阵，即大气层顶亮度温度相对于每种水凝物混合比的偏导数 $\\dfrac{\\partial T_b}{\\partial q_i}$。我们使用链式法则：\n$$\n\\frac{\\partial T_b}{\\partial q_i} = \\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} \\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i}\n$$\n首先，我们计算 $T_b$ 相对于 $\\tau_{\\mathrm{opt}}$ 的导数：\n$$\n\\frac{\\partial T_b}{\\partial \\tau_{\\mathrm{opt}}} = \\frac{\\partial}{\\partial \\tau_{\\mathrm{opt}}} \\left[ T_\\ell + (\\varepsilon T_s - T_\\ell) e^{-\\tau_{\\mathrm{opt}}} \\right] = (\\varepsilon T_s - T_\\ell) (-e^{-\\tau_{\\mathrm{opt}}}) = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}}\n$$\n接下来，我们计算 $\\tau_{\\mathrm{opt}}$ 相对于特定混合比 $q_i$ 的导数：\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{\\partial}{\\partial q_i} \\left[ \\frac{M}{\\mu} \\left( \\kappa_g(\\nu) + \\sum_{j} \\alpha_j(\\nu) q_j \\right) \\right]\n$$\n由于混合比 $q_j$ 是自变量，导数仅在 $j=i$ 的项上非零：\n$$\n\\frac{\\partial \\tau_{\\mathrm{opt}}}{\\partial q_i} = \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\n将这两部分结合起来，得到雅可比矩阵的最终表达式：\n$$\n\\frac{\\partial T_b(\\nu)}{\\partial q_i} = (T_\\ell - \\varepsilon T_s) e^{-\\tau_{\\mathrm{opt}}(\\nu)} \\frac{M}{\\mu} \\alpha_i(\\nu)\n$$\n该表达式表明，亮度温度对水凝物含量变化的敏感度取决于大气层温度 $T_\\ell$ 和地表亮度温度 $\\varepsilon T_s$ 之间的对比度、总的大气不透明度（通过 $e^{-\\tau_{\\mathrm{opt}}}$ 项）、路径中的质量（$M/\\mu$）以及该水凝物种类的特定消光特性（$\\alpha_i(\\nu)$）。\n\n**4. 算法流程**\n\n对于每个测试用例和三个频率通道中的每一个，执行以下步骤：\n1.  计算路径因子 $\\mu = \\cos(\\theta \\times \\pi / 180)$。\n2.  使用给定的气体和水凝物系数以及混合比，计算每个通道的总质量消光系数 $K(\\nu)$。\n3.  计算每个通道的视线光学深度 $\\tau_{\\mathrm{opt}}(\\nu) = (M/\\mu) K(\\nu)$。\n4.  使用推导出的雅可比公式计算 $3 \\times 4$ 的敏感度矩阵 $\\dfrac{\\partial T_b(\\nu)}{\\partial q_i}$，其中行对应三个通道（索引为 $0, 1, 2$），列对应四种水凝物种类（$q_{\\mathrm{ice}}, q_{\\mathrm{liq}}, q_{\\mathrm{rain}}, q_{\\mathrm{snow}}$）。\n5.  提取所有三个通道对应的云冰雅可比矩阵列 $\\left|\\dfrac{\\partial T_b(\\nu)}{\\partial q_{\\mathrm{ice}}}\\right|$。\n6.  根据这些冰敏感度值的大小，按降序对通道索引（$0, 1, 2$）进行排序，以获得通道排名。\n7.  收集每个测试用例的结果，包括雅可比矩阵和排序后的通道索引，并将其格式化为指定的字符串输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes channel-wise Jacobians of TOA brightness temperature with respect\n    to hydrometeor mixing ratios and ranks channels by sensitivity to cloud ice.\n    \"\"\"\n\n    # --- Define Constants ---\n    # Frequencies: [23.8, 36.5, 89.0] GHz\n    # Channel indices: 0, 1, 2\n\n    # Gas mass-extinction coefficients (m^2/kg)\n    K_G = np.array([0.015, 0.012, 0.025])\n\n    # Hydrometeor mass-extinction coefficients (m^2/kg)\n    # Rows: ice, liq, rain, snow\n    # Columns: 23.8 GHz, 36.5 GHz, 89.0 GHz\n    A_HYDROMETEORS = np.array([\n        [0.020, 0.050, 0.250],  # cloud ice\n        [0.150, 0.200, 0.300],  # cloud liquid\n        [0.600, 0.800, 1.100],  # rain\n        [0.300, 0.400, 0.800]   # snow\n    ])\n\n    # --- Test Cases ---\n    # (T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow)\n    test_cases = [\n        (290.0, 260.0, 0.95, 53.0, 2.0, 5e-4, 1e-3, 1e-4, 2e-4),\n        (288.0, 270.0, 0.90, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0),\n        (300.0, 240.0, 0.60, 60.0, 5.0, 1e-3, 5e-4, 2e-4, 1e-3),\n        (285.0, 255.0, 0.97, 45.0, 8.0, 8e-4, 2e-3, 5e-4, 3e-4),\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        T_s, T_l, epsilon, theta_deg, M, q_ice, q_liq, q_rain, q_snow = case\n        \n        q = np.array([q_ice, q_liq, q_rain, q_snow])\n\n        # --- Calculations ---\n        # 1. Path factor mu = cos(theta)\n        mu = np.cos(theta_deg * np.pi / 180.0)\n\n        # 2. Total mass-extinction coefficient K(nu) for each channel\n        # K = k_g + sum(alpha_i * q_i)\n        hydrometeor_extinction = np.sum(A_HYDROMETEORS * q[:, np.newaxis], axis=0)\n        K = K_G + hydrometeor_extinction\n\n        # 3. Optical depth tau_opt(nu) for each channel\n        tau_opt = (M / mu) * K\n\n        # 4. Calculate Jacobians: d(Tb)/d(qi) = (T_l - eps*T_s) * exp(-tau_opt) * (M/mu) * alpha_i\n        \n        # This is the common part of the Jacobian for all hydrometeor species, per channel\n        # The result is a 3-element array.\n        common_factor_per_channel = (T_l - epsilon * T_s) * np.exp(-tau_opt) * (M / mu)\n        \n        # Calculate the full Jacobian matrix.\n        # This broadcasts the (3,) common_factor array across the columns of the (4, 3) A_HYDROMETEORS array.\n        # The result is a (4, 3) matrix: rows are species, columns are channels.\n        jacobian_matrix = A_HYDROMETEORS * common_factor_per_channel\n\n        # The required output format is 3x4 (channels x species).\n        jacobian_output = jacobian_matrix.T.tolist()\n\n        # 5. Rank channels by absolute sensitivity to cloud ice\n        # Jacobians for ice are in the first row of the (4, 3) jacobian_matrix\n        ice_sensitivities = np.abs(jacobian_matrix[0, :])\n        \n        # argsort sorts in ascending order. We sort the negative to get descending order.\n        ranked_channel_indices = np.argsort(-ice_sensitivities).tolist()\n\n        all_results.append([jacobian_output, ranked_channel_indices])\n\n    # Final print statement in the exact required format.\n    # str() creates the nested list representation, and .replace(' ', '') removes all spaces.\n    print(str(all_results).replace(' ', ''))\n\nsolve()\n```"
        },
        {
            "introduction": "变分和集合数据同化方法通常依赖于非线性前向算子的线性近似，即所谓的切线性模型。在使用此线性模型之前，必须严格验证其准确性。本练习介绍了切线性检验，这是一个标准程序，用于确认您的切线性代码是否是对非线性前向算子的正确线性化。执行此检查是一个关键的质量控制步骤，可以防止线性化中的错误传播并破坏整个分析过程。",
            "id": "4011519",
            "problem": "考虑一个在数值天气预报和气候模拟中的全天空辐射率同化情景，其中观测算子将一个模式状态映射为两个微波通道的大气层顶亮温。每个通道的算子是晴空和云天分量的混合，由云量加权，并通过Beer-Lambert透过率进行参数化。设状态向量为 $x = [T_s, T_a, T_c, q, L, c]$，其中 $T_s$ 是地表温度，$T_a$ 是代表性的晴空大气温度，$T_c$ 是代表性的云天大气温度，$q$ 是水汽质量混合比，$L$ 是云液态水路径的代理变量，$c$ 是云量。假设微波符合Rayleigh-Jeans亮温近似，因此源函数可由温度本身近似。\n\n对于微波通道 $i \\in \\{1,2\\}$，定义晴空透过率\n$$\n\\tau_{\\mathrm{clr}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q\\big)\n$$\n和云天透过率\n$$\n\\tau_{\\mathrm{cld}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L\\big),\n$$\n吸收系数为\n$$\n\\kappa_q^{(1)} = 0.08,\\quad \\kappa_l^{(1)} = 0.02,\\quad \\kappa_q^{(2)} = 0.02,\\quad \\kappa_l^{(2)} = 0.08.\n$$\n通道 $i$ 的亮温为\n$$\ny^{(i)}(x) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right].\n$$\n令 $H(x) = \\big[y^{(1)}(x), y^{(2)}(x)\\big]^\\top$ 为双通道前向算子。切线性算子 $\\mathcal{H}$ 是 $H$ 的雅可比矩阵应用于一个扰动 $\\delta x$。标准的切线性一致性检验评估\n$$\n\\mathcal{R}(\\epsilon; x, \\delta x) = \\frac{\\left\\|H\\!\\left(x+\\epsilon\\,\\delta x\\right) - H(x) - \\epsilon\\, \\mathcal{H}\\,\\delta x\\right\\|_2}{\\epsilon\\, \\left\\|\\mathcal{H}\\,\\delta x\\right\\|_2},\n$$\n对于一个扰动尺度 $\\epsilon$ 的序列，其中 $\\|\\cdot\\|_2$ 表示欧几里得范数。\n\n从Beer-Lambert定律和微波亮温的Rayleigh-Jeans近似出发，并将云量混合处理为晴空和云天贡献的凸组合，推导实现 $H(x)$ 和 $\\mathcal{H}$ 对 $\\delta x$ 的作用所需的表达式。然后，编写一个程序，该程序：\n- 使用上述公式实现 $H(x)$。\n- 通过对 $H$ 关于 $x$ 的分量进行解析微分，并将结果应用于 $\\delta x$，来实现 $\\mathcal{H}\\,\\delta x$。\n- 对 $\\epsilon$ 序列 $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$ 计算 $\\mathcal{R}(\\epsilon; x, \\delta x)$。\n\n线性可接受性准则：对于给定的 $(x,\\delta x)$，如果比率序列 $\\mathcal{R}$ 在 $\\epsilon \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}\\}$ 上严格递减，并且在 $\\epsilon = 10^{-4}$ 处的值小于 $10^{-3}$，则声明该切线性近似是可接受的。如果分母 $\\epsilon\\,\\|\\mathcal{H}\\,\\delta x\\|_2$ 的绝对值小于 $10^{-12}$，则将该情况视为不可接受。\n\n您的程序必须对以下四个测试案例中的每一个进行可接受性评估（每个测试案例指定了 $(x,\\delta x)$）：\n\n- 测试案例 1（典型的中纬度，部分多云）：$x = [288.0, 275.0, 265.0, 0.012, 0.10, 0.40]$，$\\delta x = [0.5, -0.3, 0.2, 0.001, 0.02, -0.05]$。\n- 测试案例 2（晴空边界）：$x = [290.0, 270.0, 260.0, 0.010, 0.05, 0.00]$，$\\delta x = [0.5, -0.2, 0.1, 0.0005, 0.01, 0.10]$。\n- 测试案例 3（阴天边界）：$x = [285.0, 272.0, 262.0, 0.015, 0.20, 1.00]$，$\\delta x = [0.2, 0.2, -0.3, -0.002, 0.03, -0.10]$。\n- 测试案例 4（湿润且云层较厚）：$x = [292.0, 278.0, 268.0, 0.030, 0.30, 0.70]$，$\\delta x = [-0.4, 0.4, 0.0, 0.003, -0.05, 0.00]$。\n\n所有温度单位均为开尔文，在这个简化的参数化方案中，$q$、$L$ 和 $c$ 是无量纲的。比率 $\\mathcal{R}$ 是无量纲的。不使用角度。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[result1,result2,result3,result4]$），每个条目是一个布尔值，表示相应测试案例是否满足可接受性准则。",
            "solution": "此问题是有效的。它提出了一个在地球物理数据同化领域中常见的、适定的、有科学依据的数值任务。它是自洽的，提供了所有必要的数学定义、物理参数和测试条件。\n\n问题的核心是为一个给定的非线性前向算子 $H(x)$ 推导其切线性算子 $\\mathcal{H}$，并执行数值一致性检验。前向算子 $H(x)$ 将一个六分量状态向量 $x = [T_s, T_a, T_c, q, L, c]^\\top$ 映射到一个二分量观测向量，即亮温 $y = [y^{(1)}, y^{(2)}]^\\top$。$x$ 的分量是地表温度 $T_s$、晴空大气温度 $T_a$、云天大气温度 $T_c$、水汽 $q$、云液态水 $L$ 和云量 $c$。\n\n对于两个通道中的每一个 $i \\in \\{1, 2\\}$，亮温由下式给出：\n$$\ny^{(i)}(x) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right]\n$$\n通过定义晴空亮温 $y_{\\mathrm{clr}}^{(i)}$ 和云天亮温 $y_{\\mathrm{cld}}^{(i)}$，可以简化此表达式：\n$$\ny_{\\mathrm{clr}}^{(i)} = \\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\n$$\n$$\ny_{\\mathrm{cld}}^{(i)} = \\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\n$$\n因此，$y^{(i)}(x)$ 是由云量 $c$ 加权的凸组合：\n$$\ny^{(i)}(x) = (1-c) y_{\\mathrm{clr}}^{(i)} + c y_{\\mathrm{cld}}^{(i)}\n$$\n透过率 $\\tau_{\\mathrm{clr}}^{(i)}$ 和 $\\tau_{\\mathrm{cld}}^{(i)}$ 依赖于状态变量 $q$ 和 $L$：\n$$\n\\tau_{\\mathrm{clr}}^{(i)}(q) = \\exp(-\\kappa_q^{(i)} q)\n$$\n$$\n\\tau_{\\mathrm{cld}}^{(i)}(q, L) = \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L)\n$$\n\n切线性算子 $\\mathcal{H}$ 是 $H(x)$ 的雅可比矩阵，它是一个 $2 \\times 6$ 的矩阵，其元素是 $H$ 的每个分量相对于 $x$ 的每个分量的偏导数。$\\mathcal{H}$ 对一个扰动向量 $\\delta x$ 的作用是矩阵-向量乘积 $\\mathcal{H}\\,\\delta x$。为计算此乘积，我们需要 $y^{(i)}$ 相对于 $x$ 的 6 个分量的每一个的偏导数。我们使用链式法则来求这些导数。\n\n首先，我们求透过率相对于它们所依赖的状态变量的导数：\n$$\n\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q) = -\\kappa_q^{(i)} \\tau_{\\mathrm{clr}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_q^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -\\kappa_l^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_l^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\n注意 $\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial L} = 0$。\n\n现在，我们计算 $y^{(i)}$ 的偏导数：\n1.  相对于 $T_s$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_s} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_s} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_s} = (1-c)\\tau_{\\mathrm{clr}}^{(i)} + c\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n2.  相对于 $T_a$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_a} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_a} = (1-c)(1-\\tau_{\\mathrm{clr}}^{(i)})\n    $$\n3.  相对于 $T_c$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_c} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_c} = c(1-\\tau_{\\mathrm{cld}}^{(i)})\n    $$\n4.  相对于 $q$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial q} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial q} = (1-c)(T_s - T_a)\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} + c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q}\n    $$\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = -(1-c)(T_s - T_a)\\kappa_q^{(i)}\\tau_{\\mathrm{clr}}^{(i)} - c(T_s - T_c)\\kappa_q^{(i)}\\tau_{\\mathrm{cld}}^{(i)} = -\\kappa_q^{(i)}\\left[(1-c)\\tau_{\\mathrm{clr}}^{(i)}(T_s-T_a) + c\\tau_{\\mathrm{cld}}^{(i)}(T_s-T_c)\\right]\n    $$\n5.  相对于 $L$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial L} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial L} = c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -c(T_s - T_c)\\kappa_l^{(i)}\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n6.  相对于 $c$ 的导数：\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial c} = -y_{\\mathrm{clr}}^{(i)} + y_{\\mathrm{cld}}^{(i)}\n    $$\n\n切线性算子对一个扰动 $\\delta x = [\\delta T_s, \\delta T_a, \\delta T_c, \\delta q, \\delta L, \\delta c]^\\top$ 的作用由一个向量给出，其第 i 个分量为：\n$$\n(\\mathcal{H}\\,\\delta x)_i = \\frac{\\partial y^{(i)}}{\\partial T_s}\\delta T_s + \\frac{\\partial y^{(i)}}{\\partial T_a}\\delta T_a + \\frac{\\partial y^{(i)}}{\\partial T_c}\\delta T_c + \\frac{\\partial y^{(i)}}{\\partial q}\\delta q + \\frac{\\partial y^{(i)}}{\\partial L}\\delta L + \\frac{\\partial y^{(i)}}{\\partial c}\\delta c\n$$\n这是 $y^{(i)}$ 的梯度与扰动向量 $\\delta x$ 的点积。\n\n实现将包括两个函数：一个用于非线性算子 $H(x)$，另一个用于切线性作用 $\\mathcal{H}\\,\\delta x$。然后，一个循环将遍历提供的四个测试案例。对于每个案例，将为一系列 $\\epsilon$ 值 $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$ 计算一致性比率 $\\mathcal{R}(\\epsilon; x, \\delta x)$。分母 $\\epsilon\\,\\|\\mathcal{H}\\,\\delta x\\|_2$ 将与阈值 $10^{-12}$ 进行比较，以防止除以零，并识别出扰动在线性近似中没有影响的情况。\n\n最后，应用可接受性准则：前四个比率 $\\mathcal{R}(\\epsilon)$ 的序列必须严格递减，并且在 $\\epsilon = 10^{-4}$ 处的 $\\mathcal{R}$ 值必须小于 $10^{-3}$。将根据这些准则为每个测试案例记录一个布尔结果（True/False）。",
            "answer": "```python\nimport numpy as np\n\n# Define global constants as specified in the problem\nKAPPAS = {\n    1: {'q': 0.08, 'l': 0.02},\n    2: {'q': 0.02, 'l': 0.08}\n}\nEPSILONS = [10**(-i) for i in range(1, 6)]\nZERO_THRESHOLD = 1e-12\nACCEPTANCE_THRESHOLD = 1e-3\n\ndef H_operator(x):\n    \"\"\"\n    Implements the non-linear forward operator H(x).\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n    \n    Returns:\n        np.ndarray: The 2-element observation vector [y^(1), y^(2)].\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    y = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        \n        y[i-1] = (1 - c) * y_clr_i + c * y_cld_i\n        \n    return y\n\ndef H_tl_operator(x, dx):\n    \"\"\"\n    Implements the action of the tangent-linear operator H_tl on a perturbation dx.\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n        dx (np.ndarray): The perturbation vector [dTs, dTa, dTc, dq, dL, dc].\n    \n    Returns:\n        np.ndarray: The 2-element result vector H_tl * dx.\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    H_dx = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        # Partial derivatives\n        d_y_i_d_Ts = (1 - c) * tau_clr_i + c * tau_cld_i\n        d_y_i_d_Ta = (1 - c) * (1 - tau_clr_i)\n        d_y_i_d_Tc = c * (1 - tau_cld_i)\n        d_y_i_d_q = -kappa_q_i * ((1 - c) * tau_clr_i * (Ts - Ta) + c * tau_cld_i * (Ts - Tc))\n        d_y_i_d_L = -c * kappa_l_i * tau_cld_i * (Ts - Tc)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        d_y_i_d_c = y_cld_i - y_clr_i\n        \n        jacobian_row_i = np.array([\n            d_y_i_d_Ts, d_y_i_d_Ta, d_y_i_d_Tc,\n            d_y_i_d_q, d_y_i_d_L, d_y_i_d_c\n        ])\n        \n        H_dx[i-1] = np.dot(jacobian_row_i, dx)\n        \n    return H_dx\n\ndef solve():\n    \"\"\"\n    Main function to run the tangent-linear test for all specified cases.\n    \"\"\"\n    test_cases = [\n        # Test case 1\n        (np.array([288.0, 275.0, 265.0, 0.012, 0.10, 0.40]), \n         np.array([0.5, -0.3, 0.2, 0.001, 0.02, -0.05])),\n        # Test case 2\n        (np.array([290.0, 270.0, 260.0, 0.010, 0.05, 0.00]), \n         np.array([0.5, -0.2, 0.1, 0.0005, 0.01, 0.10])),\n        # Test case 3\n        (np.array([285.0, 272.0, 262.0, 0.015, 0.20, 1.00]), \n         np.array([0.2, 0.2, -0.3, -0.002, 0.03, -0.10])),\n        # Test case 4\n        (np.array([292.0, 278.0, 268.0, 0.030, 0.30, 0.70]), \n         np.array([-0.4, 0.4, 0.0, 0.003, -0.05, 0.00])),\n    ]\n\n    results = []\n    \n    for x, dx in test_cases:\n        Hx = H_operator(x)\n        H_tl_dx = H_tl_operator(x, dx)\n        \n        norm_H_tl_dx = np.linalg.norm(H_tl_dx)\n        \n        R_values = []\n        is_acceptable = True\n        \n        for epsilon in EPSILONS:\n            denominator = epsilon * norm_H_tl_dx\n            if abs(denominator)  ZERO_THRESHOLD:\n                is_acceptable = False\n                break\n            \n            x_pert = x + epsilon * dx\n            Hx_pert = H_operator(x_pert)\n            \n            numerator = np.linalg.norm(Hx_pert - Hx - epsilon * H_tl_dx)\n            \n            R_values.append(numerator / denominator)\n            \n        if not is_acceptable:\n            results.append(False)\n            continue\n            \n        # Check acceptance criteria on the calculated ratios\n        # 1. Strictly decreasing for the first 4 epsilon values\n        is_strictly_decreasing = (\n            R_values[0] > R_values[1] and\n            R_values[1] > R_values[2] and\n            R_values[2] > R_values[3]\n        )\n        \n        # 2. Value at epsilon = 1e-4 is less than the threshold\n        is_small_enough = R_values[3]  ACCEPTANCE_THRESHOLD\n        \n        results.append(is_strictly_decreasing and is_small_enough)\n            \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "为了在变分数据同化中高效地计算成本函数的梯度，我们使用切线性算子的伴随。该伴随模型的正确性对于同化系统的收敛和准确性至关重要。这最后一个练习演示了伴随一致性检验，它通过数值方法验证伴随算子和切线性算子是否满足基本恒等式 $\\langle \\mathcal{H} \\delta x, \\delta y \\rangle = \\langle \\delta x, \\mathcal{H}^T \\delta y \\rangle$。成功完成此测试，意味着您确信同化系统的核心组件已正确实现且相互一致。",
            "id": "4011581",
            "problem": "给定一个在数值天气预报和气候模型背景下的简化全天空观测算子，该算子将云水混合比的垂直廓线映射为多个微波通道的大气层顶向上辐射。目标是通过检验等式 $\\langle \\mathcal{H} \\,\\delta x, \\delta y \\rangle = \\langle \\delta x, \\mathcal{H}^{T} \\,\\delta y \\rangle$ 是否成立，来数值上验证云水混合比扰动的伴随一致性。其中，$\\mathcal{H}$ 是观测算子相对于云水混合比的切线性（雅可比）算子，$\\mathcal{H}^{T}$ 是其在欧几里得内积下的伴随算子。\n\n基本原理：\n- 假设局部热力学平衡（LTE）和一个纯吸收大气（无散射），由一个具有 $N$ 个分层的垂直气柱中的热辐射的离散 Schwarzschild 方程描述。对于通道 $c$，大气层顶的向上单色辐射率（记为 $I_c$）为\n$$\nI_c \\;=\\; B_c(T_s)\\,\\exp\\!\\left(-\\sum_{j=1}^{N} \\tau_{c,j}\\right) \\;+\\; \\sum_{i=1}^{N} B_c(T_i)\\,\\bigl(1 - \\exp(-\\tau_{c,i})\\bigr)\\,\\exp\\!\\left(-\\sum_{j=i+1}^{N} \\tau_{c,j}\\right),\n$$\n其中 $T_s$ 是地表温度，$T_i$ 是第 $i$ 层的温度，$\\tau_{c,i}$ 是通道 $c$ 的分层光学厚度。\n- 使用微波辐射率的 Rayleigh–Jeans 近似，$B_c(T) = \\alpha_c\\,T$，其中 $\\alpha_c = \\dfrac{2\\,k_B\\,\\nu_c^2}{c^2}$，$\\nu_c$ 是通道中心频率，$k_B$ 是 Boltzmann 常数，$c$ 是光速。\n- 定义每层的光学厚度为\n$$\n\\tau_{c,i} \\;=\\; \\kappa_c \\,\\rho_i \\,q_{c,i}\\,\\Delta z_i,\n$$\n其中 $\\kappa_c$ 是通道 $c$ 的质量消光系数，$\\rho_i$ 是第 $i$ 层的空气密度，$q_{c,i}$ 是第 $i$ 层的云水混合比，$\\Delta z_i$ 是层厚度。\n\n任务：\n- 从上述基本原理出发，推导切线性算子 $\\mathcal{H}$，该算子将云水混合比向量的扰动 $\\delta x = [\\delta q_{c,1}, \\dots, \\delta q_{c,N}]^T$ 映射到 $C$ 个通道的辐射率扰动 $\\delta y = [\\delta I_1, \\dots, \\delta I_{C}]^T$。通过链式法则和 $\\dfrac{\\partial \\tau_{c,i}}{\\partial q_{c,i}} = \\kappa_c \\,\\rho_i\\,\\Delta z_i$，计算雅可比矩阵元素 $w_{c,i} = \\dfrac{\\partial I_c}{\\partial q_{c,i}}$ 来数值上构建 $\\mathcal{H}$。\n- 使用欧几里得内积 $\\langle a, b \\rangle = \\sum_k a_k\\,b_k$，并将伴随算子 $\\mathcal{H}^{T}$ 设为雅可比矩阵的转置。\n- 对于每个测试用例，使用固定的随机种子和标准正态分布抽样生成扰动 $\\delta x$ 和 $\\delta y$。计算 $\\langle \\mathcal{H}\\,\\delta x, \\delta y \\rangle$ 和 $\\langle \\delta x, \\mathcal{H}^{T}\\,\\delta y \\rangle$ 两者，并以浮点数形式报告其绝对差。\n\n物理单位说明：\n- 尽管中间量带有物理单位（例如，光学厚度是无量纲的，温度单位为 $\\mathrm{K}$，密度单位为 $\\mathrm{kg\\,m^{-3}}$，厚度单位为 $\\mathrm{m}$，频率单位为 $\\mathrm{Hz}$），但所需的输出是表示内积绝对差的纯浮点数；输出无需单位转换。\n\n测试套件规范：\n实现您的程序以运行以下五个测试用例。在所有用例中，温度以 $\\mathrm{K}$ 表示，密度以 $\\mathrm{kg\\,m^{-3}}$ 表示，层厚度以 $\\mathrm{m}$ 表示，频率以 $\\mathrm{Hz}$ 表示，质量消光系数以 $\\mathrm{m^2\\,kg^{-1}}$ 表示。\n\n- 测试用例 $1$ (通用正常路径, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [5\\times 10^{-4}, 2\\times 10^{-4}, 1\\times 10^{-4}, 5\\times 10^{-5}, 1\\times 10^{-5}]$\n  - 通道: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - 随机种子: $\\text{seed}_{\\delta x} = 42$, $\\text{seed}_{\\delta y} = 43$\n\n- 测试用例 $2$ (无云背景, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [0, 0, 0, 0, 0]$\n  - 通道: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - 随机种子: $\\text{seed}_{\\delta x} = 123$, $\\text{seed}_{\\delta y} = 124$\n\n- 测试用例 $3$ (光学厚云, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [5\\times 10^{-3}, 4\\times 10^{-3}, 3\\times 10^{-3}, 2\\times 10^{-3}, 1\\times 10^{-3}]$\n  - 通道: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.2, 0.4]$\n  - 随机种子: $\\text{seed}_{\\delta x} = 7$, $\\text{seed}_{\\delta y} = 8$\n\n- 测试用例 $4$ (单层边界情况, $N=1$, $C=2$):\n  - $T_s = 300$, $T = [290]$\n  - $\\rho = [1.2]$\n  - $\\Delta z = [1000]$\n  - $q = [1\\times 10^{-3}]$\n  - 通道: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - 随机种子: $\\text{seed}_{\\delta x} = 99$, $\\text{seed}_{\\delta y} = 100$\n\n- 测试用例 $5$ (非均匀网格和三通道, $N=6$, $C=3$):\n  - $T_s = 295$, $T = [285, 275, 260, 240, 225, 215]$\n  - $\\rho = [1.18, 1.05, 0.9, 0.7, 0.5, 0.35]$\n  - $\\Delta z = [800, 1200, 900, 700, 600, 500]$\n  - $q = [2\\times 10^{-4}, 0, 1\\times 10^{-3}, 5\\times 10^{-4}, 0, 2\\times 10^{-5}]$\n  - 通道: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}, 150\\times 10^{9}]$, $\\kappa = [0.05, 0.08, 0.12]$\n  - 随机种子: $\\text{seed}_{\\delta x} = 2025$, $\\text{seed}_{\\delta y} = 2026$\n\n输出格式要求：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$\\texttt{[0.0,0.0,0.0]}$）。列表中的每个元素必须是相应测试用例的绝对差 $\\bigl|\\langle \\mathcal{H}\\,\\delta x, \\delta y \\rangle - \\langle \\delta x, \\mathcal{H}^{T}\\,\\delta y \\rangle\\bigr|$，表示为浮点数。",
            "solution": "问题陈述经评估为**有效**。其科学基础扎根于辐射传输原理，在数学上是适定的，并为可解的数值任务提供了一套完整且一致的信息。虽然存在一个轻微的符号歧义，即云水混合比在形式定义中被写为 $q_{c,i}$（暗示其依赖于通道），但在测试用例中却提供为单一的、不依赖于通道的廓线 $q_i$，但这可以通过遵循物理上正确的解释和所提供数据的结构来解决。该问题代表了数值模拟和数据同化领域中一个标准且有意义的验证练习。\n\n核心任务是为一个线性算子 $\\mathcal{H}$ 数值验证其伴随性质，该算子是非线性观测算子 $\\mathcal{M}$ 的切线性近似。该性质表明，对于任意两个向量 $\\delta x$（模式状态空间中的一个扰动）和 $\\delta y$（观测空间中的一个扰动），以下等式成立：\n$$\n\\langle \\mathcal{H} \\,\\delta x, \\delta y \\rangle = \\langle \\delta x, \\mathcal{H}^{T} \\,\\delta y \\rangle\n$$\n这里，$\\mathcal{H}$ 是 $\\mathcal{M}$ 的雅可比矩阵，$\\mathcal{H}^T$ 是其伴随算子，即在标准欧几里得内积 $\\langle a, b \\rangle = \\sum_k a_k b_k$ 下的矩阵转置。该恒等式是线性代数的一个基本性质：$(\\mathcal{H}\\delta x)^T \\delta y = \\delta x^T \\mathcal{H}^T \\delta y$。因此，验证过程取决于雅可比矩阵 $\\mathcal{H}$ 的正确数值构建。\n\n状态向量 $x$ 是云水混合比的廓线，$x = q = [q_1, \\dots, q_N]^T \\in \\mathbb{R}^N$。观测向量 $y$ 是大气层顶辐射率的集合，$y = I = [I_1, \\dots, I_C]^T \\in \\mathbb{R}^C$。因此，雅可比矩阵 $\\mathcal{H}$ 的维度为 $C \\times N$，其元素由 $\\mathcal{H}_{ci} = \\frac{\\partial I_c}{\\partial q_i}$ 给出。\n\n问题使用 Rayleigh-Jeans 近似来计算辐射率，$B_c(T) = \\alpha_c T$。由于因子 $\\alpha_c$ 会线性地出现在伴随恒等式的两边，我们可以通过处理亮温来简化计算，这等效于设置 $\\alpha_c=1$。因此，我们使用 $B(T)=T$。\n\n为了计算雅可比矩阵元素，我们使用链式法则：\n$$\n\\mathcal{H}_{ci} = \\frac{\\partial I_c}{\\partial q_i} = \\frac{\\partial I_c}{\\partial \\tau_{c,i}} \\frac{\\partial \\tau_{c,i}}{\\partial q_i}\n$$\n光学厚度 $\\tau_{c,i} = \\kappa_c \\rho_i q_i \\Delta z_i$ 相对于 $q_i$ 的导数已经给出，并且非常直接：\n$$\n\\frac{\\partial \\tau_{c,i}}{\\partial q_i} = \\kappa_c \\rho_i \\Delta z_i\n$$\n主要挑战在于计算 $\\frac{\\partial I_c}{\\partial \\tau_{c,i}}$。我们采用一种计算高效的递推方法。设 $I_c^{\\uparrow}(k)$ 为第 $k$ 层顶部的上行亮温（其中 $k=0$ 为地表）。辐射传输过程可以通过以下递推关系描述：\n$$\nI_c^{\\uparrow}(k) = I_c^{\\uparrow}(k-1) e^{-\\tau_{c,k}} + T_k (1 - e^{-\\tau_{c,k}}), \\quad \\text{for } k=1, \\dots, N\n$$\n边界条件为 $I_c^{\\uparrow}(0) = T_s$。最终的大气层顶辐射率为 $I_c = I_c^{\\uparrow}(N)$。\n\n为了求出 $I_c = I_c^{\\uparrow}(N)$ 相对于任意层 $i$ 的光学厚度 $\\tau_{c,i}$ 的导数，我们对递推关系进行微分。\n对于任何层 $k  i$，光学厚度 $\\tau_{c,i}$ 仅通过其对 $I_c^{\\uparrow}(k-1)$ 的依赖性来影响 $I_c^{\\uparrow}(k)$：\n$$\n\\frac{\\partial I_c^{\\uparrow}(k)}{\\partial \\tau_{c,i}} = \\frac{\\partial I_c^{\\uparrow}(k-1)}{\\partial \\tau_{c,i}} e^{-\\tau_{c,k}}\n$$\n这表明导数向上传播，并被其穿过的每一层的透射率所衰减。导数的“源”在第 $i$ 层：\n$$\n\\frac{\\partial I_c^{\\uparrow}(i)}{\\partial \\tau_{c,i}} = -I_c^{\\uparrow}(i-1) e^{-\\tau_{c,i}} + T_i e^{-\\tau_{c,i}} = (T_i - I_c^{\\uparrow}(i-1)) e^{-\\tau_{c,i}}\n$$\n将这些结合起来，大气层顶辐射率相对于 $\\tau_{c,i}$ 的导数是在第 $i$ 层的源项乘以 $i$ 层之上所有层的总透射率：\n$$\n\\frac{\\partial I_c}{\\partial \\tau_{c,i}} = \\frac{\\partial I_c^{\\uparrow}(N)}{\\partial \\tau_{c,i}} = (T_i - I_c^{\\uparrow}(i-1)) e^{-\\tau_{c,i}} \\exp\\left(-\\sum_{j=i+1}^{N} \\tau_{c,j}\\right)\n$$\n实现算法如下：\n1.  对于每个测试用例，解析大气和通道参数。\n2.  对于每个通道 $c \\in \\{1, \\dots, C\\}$：\n    a. 计算所有层 $i \\in \\{1, \\dots, N\\}$ 的光学厚度廓线 $\\tau_{c,i}$。\n    b. 使用正向递推关系计算 $k=0, \\dots, N$ 的上行亮温廓线 $I_c^{\\uparrow}(k)$。这些中间值必须被存储。\n    c. 对于每个层 $i \\in \\{1, \\dots, N\\}$，通过组合上述推导的导数项来计算雅可比矩阵元素 $\\mathcal{H}_{ci}$。\n3.  使用指定的随机种子生成随机扰动向量 $\\delta x \\in \\mathbb{R}^N$ 和 $\\delta y \\in \\mathbb{R}^C$。\n4.  计算两个内积：$LHS = (\\mathcal{H} \\delta x)^T \\delta y$ 和 $RHS = \\delta x^T (\\mathcal{H}^T \\delta y)$。\n5.  计算并存储绝对差 $|LHS - RHS|$。由于浮点运算的性质，该值应非常接近 $0.0$。\n6.  收集所有测试用例的结果并将其格式化为逗号分隔的列表。",
            "answer": "```python\nimport numpy as np\n\ndef run_adjoint_test(case_params):\n    \"\"\"\n    Runs the adjoint test for a single case.\n    \n    This function computes the Jacobian of the radiance operator, then verifies\n    the adjoint identity"
        }
    ]
}