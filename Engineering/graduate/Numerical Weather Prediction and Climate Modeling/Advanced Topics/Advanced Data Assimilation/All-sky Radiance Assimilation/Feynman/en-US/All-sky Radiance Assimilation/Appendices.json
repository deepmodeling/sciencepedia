{
    "hands_on_practices": [
        {
            "introduction": "Before we can assimilate all-sky radiances, we must first build a robust understanding of how clouds and precipitation interact with microwave radiation. This exercise provides a foundational, first-principles calculation connecting cloud microphysical properties—such as ice water content and particle size—to a macroscopic observable: the depression in brightness temperature caused by scattering. By working through this simplified but physically-grounded scenario , you will gain direct insight into the forward problem at the heart of all-sky assimilation and appreciate the sensitivity of satellite measurements to cloud ice.",
            "id": "4011516",
            "problem": "A satellite microwave humidity sounder channel centered near the $183 \\, \\mathrm{GHz}$ water vapor absorption feature is assimilated in an all-sky radiance framework for numerical weather prediction. Consider a homogeneous ice cloud layer of geometrical thickness $H = 2.0 \\times 10^{3} \\, \\mathrm{m}$, with constant Ice Water Content (IWC) $= 1.0 \\times 10^{-4} \\, \\mathrm{kg} \\, \\mathrm{m}^{-3}$ and particle effective radius $r_{e} = 1.0 \\times 10^{-4} \\, \\mathrm{m}$. Assume the ice particles are homogeneous spheres with complex refractive index $m = 1.78 + i \\, 0.002$ at $183 \\, \\mathrm{GHz}$, and the density of ice is $\\rho_{i} = 917 \\, \\mathrm{kg} \\, \\mathrm{m}^{-3}$. The instrument views the scene at a zenith angle $\\theta = 53^{\\circ}$, and the clear-sky top-of-atmosphere brightness temperature along this line of sight is $T_{b}^{\\mathrm{clear}} = 245 \\, \\mathrm{K}$. Neglect emission by the ice and multiple scattering, and treat scattering as removal of radiance from the instrument’s narrow line of sight (i.e., scattering contributes to extinction only). Assume the rest of the atmosphere is unchanged by the presence of the cloud. Use the Rayleigh–Jeans limit to relate radiance and brightness temperature.\n\nStarting from the scalar radiative transfer equation for a beam subject to extinction, and using the Rayleigh scattering result for small spheres, where the scattering efficiency factor is\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2},\n$$\nwith size parameter $x = \\frac{2 \\pi r_{e}}{\\lambda}$ and wavelength $\\lambda = \\frac{c}{f}$ for speed of light $c$ and frequency $f$, derive an expression for the brightness temperature depression $\\Delta T_{b}$ at the top of the atmosphere caused solely by ice-cloud scattering. Then evaluate $\\Delta T_{b}$ numerically for $f = 183 \\times 10^{9} \\, \\mathrm{Hz}$ and $c = 2.99792458 \\times 10^{8} \\, \\mathrm{m} \\, \\mathrm{s}^{-1}$.\n\nExpress your final answer as a single number in kelvin and round your result to three significant figures. State any intermediate assumptions clearly in your reasoning.",
            "solution": "The user wants to find the brightness temperature depression caused by an ice cloud.\n\n### Step 1: Extract Givens\n- Instrument: Microwave humidity sounder\n- Frequency: $f = 183 \\times 10^{9} \\, \\mathrm{Hz}$\n- Cloud: Homogeneous ice cloud layer\n- Geometrical thickness: $H = 2.0 \\times 10^{3} \\, \\mathrm{m}$\n- Ice Water Content: $\\mathrm{IWC} = 1.0 \\times 10^{-4} \\, \\mathrm{kg} \\, \\mathrm{m}^{-3}$\n- Particle effective radius: $r_{e} = 1.0 \\times 10^{-4} \\, \\mathrm{m}$\n- Ice particle shape: Homogeneous spheres\n- Complex refractive index of ice: $m = 1.78 + i \\, 0.002$\n- Density of ice: $\\rho_{i} = 917 \\, \\mathrm{kg} \\, \\mathrm{m}^{-3}$\n- Instrument zenith angle: $\\theta = 53^{\\circ}$\n- Clear-sky TOA brightness temperature: $T_{b}^{\\mathrm{clear}} = 245 \\, \\mathrm{K}$\n- Speed of light: $c = 2.99792458 \\times 10^{8} \\, \\mathrm{m} \\, \\mathrm{s}^{-1}$\n- Scattering efficiency factor (Rayleigh): $Q_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$\n- Size parameter: $x = \\frac{2 \\pi r_{e}}{\\lambda}$\n- Wavelength: $\\lambda = \\frac{c}{f}$\n- Assumptions/simplifications:\n    1.  Neglect emission by the ice.\n    2.  Neglect multiple scattering.\n    3.  Scattering contributes to extinction only.\n    4.  Atmosphere outside the cloud is unchanged.\n    5.  Use the Rayleigh–Jeans limit.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, referring to standard concepts in atmospheric radiative transfer like brightness temperature, IWC, effective radius, and scattering theory. The numerical values provided are physically realistic for a cirrus cloud. The problem is well-posed, providing all necessary parameters and simplifying assumptions (neglect of emission and multiple scattering) to allow for an analytical solution. A crucial point is the instruction to use the Rayleigh scattering formula. The size parameter $x = \\frac{2 \\pi r_e}{\\lambda}$ for the given values is approximately $0.38$, which is at the upper limit of the Rayleigh regime (typically $x \\ll 1$). However, since the problem explicitly provides the formula to use, this is considered a pedagogical simplification rather than a scientific flaw that would invalidate the problem. The problem is objective, complete, and internally consistent.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A detailed solution will be provided.\n\n### Solution Derivation\n\nThe problem asks for the brightness temperature depression $\\Delta T_{b}$ at the top of the atmosphere due to scattering by an ice cloud. We begin with the scalar radiative transfer equation (RTE) for a beam of radiance $I$ traveling along a path $s$, subject only to extinction.\n$$\n\\frac{dI}{ds} = -k_{\\mathrm{ext}} I\n$$\nwhere $k_{\\mathrm{ext}}$ is the volume extinction coefficient. The problem states to neglect ice emission and multiple scattering. By Kirchhoff's law of thermal radiation, a medium that does not emit does not absorb. Therefore, the extinction is due solely to scattering out of the beam, so $k_{\\mathrm{ext}} = k_{\\mathrm{sca}}$, where $k_{\\mathrm{sca}}$ is the volume scattering coefficient.\n\nFor a homogeneous cloud, $k_{\\mathrm{sca}}$ is constant. Integrating the RTE along the slant path $s$ through the cloud gives:\n$$\nI(s) = I(0) \\exp(-k_{\\mathrm{sca}} s)\n$$\nHere, $I(0)$ is the upwelling radiance incident at the cloud base, and $I(s)$ is the radiance exiting the cloud top. The slant path length through the cloud is $s = H / \\cos(\\theta)$, where $H$ is the geometrical thickness and $\\theta$ is the zenith angle. The product $k_{\\mathrm{sca}} s$ is the cloud optical depth along the slant path, $\\tau_{\\mathrm{cld}}$.\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)}\n$$\nThe problem states to use the Rayleigh-Jeans limit, where radiance $I$ is directly proportional to brightness temperature $T_{b}$. This allows us to write the RTE in terms of $T_{b}$:\n$$\nT_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\nHere, $T_{b}^{\\mathrm{clear}}$ is the brightness temperature that would be observed without the cloud, which represents the radiation source from below, and $T_{b}^{\\mathrm{cloudy}}$ is the attenuated brightness temperature observed in the presence of the cloud.\n\nThe brightness temperature depression, $\\Delta T_{b}$, is the difference between the clear-sky and cloudy-sky brightness temperatures:\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{cloudy}} = T_{b}^{\\mathrm{clear}} - T_{b}^{\\mathrm{clear}} \\exp(-\\tau_{\\mathrm{cld}})\n$$\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right)\n$$\nTo evaluate this, we must first determine $\\tau_{\\mathrm{cld}}$. This requires calculating $k_{\\mathrm{sca}}$. The volume scattering coefficient is the product of the number density of scatterers, $N$, and the scattering cross-section of a single particle, $\\sigma_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = N \\sigma_{\\mathrm{sca}}\n$$\nThe number density $N$ can be found from the Ice Water Content (IWC), which is the total mass of ice per unit volume. For spherical particles of radius $r_e$ and density $\\rho_i$, the mass of a single particle is $M_{p} = \\rho_i V_{p} = \\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}$. Then, $\\mathrm{IWC} = N M_p$.\n$$\nN = \\frac{\\mathrm{IWC}}{M_{p}} = \\frac{\\mathrm{IWC}}{\\rho_{i} \\frac{4}{3} \\pi r_{e}^{3}} = \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}}\n$$\nThe scattering cross-section $\\sigma_{\\mathrm{sca}}$ is the product of the particle's geometrical cross-section, $A_{p} = \\pi r_{e}^{2}$, and the scattering efficiency, $Q_{\\mathrm{sca}}$.\n$$\n\\sigma_{\\mathrm{sca}} = A_{p} Q_{\\mathrm{sca}} = \\pi r_{e}^{2} Q_{\\mathrm{sca}}\n$$\nCombining these gives an expression for $k_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = \\left( \\frac{3 \\, \\mathrm{IWC}}{4 \\pi \\rho_{i} r_{e}^{3}} \\right) (\\pi r_{e}^{2} Q_{\\mathrm{sca}}) = \\frac{3 \\, \\mathrm{IWC} \\, Q_{\\mathrm{sca}}}{4 \\, \\rho_{i} \\, r_{e}}\n$$\nNow, we must evaluate $Q_{\\mathrm{sca}}$ using the given formula:\n$$\nQ_{\\mathrm{sca}} = \\frac{8}{3} \\, x^{4} \\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}\n$$\nFirst, we calculate the wavelength $\\lambda$ and the size parameter $x$:\n$$\n\\lambda = \\frac{c}{f} = \\frac{2.99792458 \\times 10^{8} \\, \\mathrm{m \\, s^{-1}}}{183 \\times 10^{9} \\, \\mathrm{Hz}} \\approx 1.63821 \\times 10^{-3} \\, \\mathrm{m}\n$$\n$$\nx = \\frac{2 \\pi r_{e}}{\\lambda} = \\frac{2 \\pi (1.0 \\times 10^{-4} \\, \\mathrm{m})}{1.63821 \\times 10^{-3} \\, \\mathrm{m}} \\approx 0.38356\n$$\nNext, we evaluate the complex term using $m = 1.78 + i \\, 0.002$:\n$$\nm^{2} = (1.78 + i \\, 0.002)^{2} = 1.78^{2} + 2(1.78)(i \\, 0.002) + (i \\, 0.002)^{2} = 3.1684 + i \\, 0.00712 - 0.000004 = 3.168396 + i \\, 0.00712\n$$\nThe term $\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2}$ is the squared magnitude of a complex ratio, which can be calculated as the ratio of the squared magnitudes of the numerator and denominator:\n$$\n\\left| \\frac{m^{2} - 1}{m^{2} + 2} \\right|^{2} = \\frac{|(3.168396 - 1) + i \\, 0.00712|^{2}}{|(3.168396 + 2) + i \\, 0.00712|^{2}} = \\frac{|2.168396 + i \\, 0.00712|^{2}}{|5.168396 + i \\, 0.00712|^{2}}\n$$\n$$\n= \\frac{2.168396^{2} + 0.00712^{2}}{5.168396^{2} + 0.00712^{2}} = \\frac{4.70198 + 5.06944 \\times 10^{-5}}{26.71235 + 5.06944 \\times 10^{-5}} \\approx \\frac{4.70203}{26.71240} \\approx 0.17602\n$$\nNow we can compute $Q_{\\mathrm{sca}}$:\n$$\nQ_{\\mathrm{sca}} \\approx \\frac{8}{3} (0.38356)^{4} (0.17602) \\approx \\frac{8}{3} (0.021642) (0.17602) \\approx 0.010134\n$$\nWith $Q_{\\mathrm{sca}}$, we find $k_{\\mathrm{sca}}$:\n$$\nk_{\\mathrm{sca}} = \\frac{3 \\times (1.0 \\times 10^{-4}) \\times 0.010134}{4 \\times 917 \\times (1.0 \\times 10^{-4})} \\, \\mathrm{m^{-1}} \\approx \\frac{3.0402 \\times 10^{-6}}{0.3668} \\, \\mathrm{m^{-1}} \\approx 8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}\n$$\nNext, we calculate the cloud optical depth $\\tau_{\\mathrm{cld}}$:\n$$\n\\cos(53^{\\circ}) \\approx 0.601815\n$$\n$$\n\\tau_{\\mathrm{cld}} = \\frac{k_{\\mathrm{sca}} H}{\\cos(\\theta)} \\approx \\frac{(8.2887 \\times 10^{-6} \\, \\mathrm{m^{-1}}) (2.0 \\times 10^{3} \\, \\mathrm{m})}{0.601815} \\approx \\frac{0.0165774}{0.601815} \\approx 0.027546\n$$\nFinally, we compute the brightness temperature depression $\\Delta T_{b}$:\n$$\n\\Delta T_{b} = T_{b}^{\\mathrm{clear}} \\left(1 - \\exp(-\\tau_{\\mathrm{cld}})\\right) \\approx 245 \\, \\mathrm{K} \\left(1 - \\exp(-0.027546)\\right)\n$$\n$$\n\\Delta T_{b} \\approx 245 \\, (1 - 0.972828) = 245 \\, (0.027172) \\approx 6.65714 \\, \\mathrm{K}\n$$\nRounding the result to three significant figures gives $6.66 \\, \\mathrm{K}$.",
            "answer": "$$\\boxed{6.66}$$"
        },
        {
            "introduction": "Modern data assimilation systems, particularly variational and ensemble methods, rely on linear approximations of the inherently nonlinear observation operator, $H(x)$. The tangent-linear (TL) model, $\\mathcal{H}$, represents the first-order Taylor expansion of this operator and is fundamental for propagating perturbations and calculating sensitivities. However, coding these complex derivatives is prone to error. This practice  guides you through a crucial quality control procedure: the tangent-linear test, which numerically verifies that the TL code is a consistent linearization of the full nonlinear operator.",
            "id": "4011519",
            "problem": "Consider an all-sky radiance assimilation setting in numerical weather prediction and climate modeling, where the observation operator maps a model state to top-of-atmosphere brightness temperatures for two microwave channels. The operator for each channel is a blend of clear-sky and cloudy-sky components, weighted by cloud fraction and parameterized by Beer-Lambert transmittance. Let the state vector be $x = [T_s, T_a, T_c, q, L, c]$, where $T_s$ is the surface temperature, $T_a$ is a representative clear-sky atmospheric temperature, $T_c$ is a representative cloudy-sky atmospheric temperature, $q$ is the water vapor mass mixing ratio, $L$ is the cloud liquid water path proxy, and $c$ is the cloud fraction. Assume Rayleigh-Jeans brightness for microwaves so that the source function is approximated by the temperature itself.\n\nFor microwave channel $i \\in \\{1,2\\}$, define the clear-sky transmittance\n$$\n\\tau_{\\mathrm{clr}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q\\big)\n$$\nand the cloudy-sky transmittance\n$$\n\\tau_{\\mathrm{cld}}^{(i)} = \\exp\\!\\big(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L\\big),\n$$\nwith absorption coefficients\n$$\n\\kappa_q^{(1)} = 0.08,\\quad \\kappa_l^{(1)} = 0.02,\\quad \\kappa_q^{(2)} = 0.02,\\quad \\kappa_l^{(2)} = 0.08.\n$$\nThe brightness temperature for channel $i$ is\n$$\ny^{(i)}(x) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right].\n$$\nLet $H(x) = \\big[y^{(1)}(x), y^{(2)}(x)\\big]^\\top$ be the two-channel forward operator. The tangent-linear operator $\\mathcal{H}$ is the Jacobian of $H$ applied to a perturbation $\\delta x$. A standard tangent-linear consistency test evaluates\n$$\n\\mathcal{R}(\\epsilon; x, \\delta x) = \\frac{\\left\\|H\\!\\left(x+\\epsilon\\,\\delta x\\right) - H(x) - \\epsilon\\, \\mathcal{H}\\,\\delta x\\right\\|_2}{\\epsilon\\, \\left\\|\\mathcal{H}\\,\\delta x\\right\\|_2},\n$$\nfor a sequence of perturbation scales $\\epsilon$, where $\\|\\cdot\\|_2$ denotes the Euclidean norm.\n\nStarting from the Beer-Lambert law and the Rayleigh-Jeans approximation for microwave brightness temperature, and treating cloud fraction blending as a convex combination of clear and cloudy contributions, derive the expressions necessary to implement $H(x)$ and the action of $\\mathcal{H}$ on $\\delta x$. Then, write a program that:\n- Implements $H(x)$ using the formulas above.\n- Implements $\\mathcal{H}\\,\\delta x$ by analytically differentiating $H$ with respect to the components of $x$ and applying the result to $\\delta x$.\n- Computes $\\mathcal{R}(\\epsilon; x, \\delta x)$ for the $\\epsilon$ sequence $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$.\n\nAcceptance criteria for linearity: for a given $(x,\\delta x)$, declare the tangent-linear approximation acceptable if the sequence of ratios $\\mathcal{R}$ is strictly decreasing for $\\epsilon \\in \\{10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}\\}$ and the value at $\\epsilon = 10^{-4}$ is less than $10^{-3}$. If the denominator $\\epsilon\\,\\|\\mathcal{H}\\,\\delta x\\|_2$ is numerically zero (less than $10^{-12}$), treat the case as not acceptable.\n\nYour program must evaluate the acceptance for each of the following four test cases (each test case specifies $(x,\\delta x)$):\n\n- Test case $1$ (typical midlatitude, partially cloudy): $x = [288.0, 275.0, 265.0, 0.012, 0.10, 0.40]$, $\\delta x = [0.5, -0.3, 0.2, 0.001, 0.02, -0.05]$.\n- Test case $2$ (clear-sky boundary): $x = [290.0, 270.0, 260.0, 0.010, 0.05, 0.00]$, $\\delta x = [0.5, -0.2, 0.1, 0.0005, 0.01, 0.10]$.\n- Test case $3$ (overcast boundary): $x = [285.0, 272.0, 262.0, 0.015, 0.20, 1.00]$, $\\delta x = [0.2, 0.2, -0.3, -0.002, 0.03, -0.10]$.\n- Test case $4$ (moist and thicker clouds): $x = [292.0, 278.0, 268.0, 0.030, 0.30, 0.70]$, $\\delta x = [-0.4, 0.4, 0.0, 0.003, -0.05, 0.00]$.\n\nAll temperatures are in Kelvin, and $q$, $L$, and $c$ are dimensionless in this simplified parameterization. The ratio $\\mathcal{R}$ is dimensionless. Angles are not used.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,result3,result4]$), where each entry is a boolean indicating whether the acceptance criteria are met for the corresponding test case.",
            "solution": "The problem is valid. It presents a well-posed, scientifically grounded numerical task common in the field of geophysical data assimilation. It is self-contained, with all necessary mathematical definitions, physical parameters, and test conditions provided.\n\nThe core of the problem is to derive the tangent-linear operator $\\mathcal{H}$ for a given non-linear forward operator $H(x)$ and to perform a numerical consistency check. The forward operator $H(x)$ maps a six-component state vector $x = [T_s, T_a, T_c, q, L, c]^\\top$ to a two-component observation vector of brightness temperatures $y = [y^{(1)}, y^{(2)}]^\\top$. The components of $x$ are the surface temperature $T_s$, clear-sky atmospheric temperature $T_a$, cloudy-sky atmospheric temperature $T_c$, water vapor $q$, cloud liquid water $L$, and cloud fraction $c$.\n\nThe brightness temperature for each of the two channels $i \\in \\{1, 2\\}$ is given by:\n$$\ny^{(i)}(x) = (1-c)\\left[\\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\\right] + c\\left[\\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\\right]\n$$\nThis can be simplified by defining the clear-sky brightness temperature $y_{\\mathrm{clr}}^{(i)}$ and cloudy-sky brightness temperature $y_{\\mathrm{cld}}^{(i)}$:\n$$\ny_{\\mathrm{clr}}^{(i)} = \\tau_{\\mathrm{clr}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{clr}}^{(i)}\\right) T_a\n$$\n$$\ny_{\\mathrm{cld}}^{(i)} = \\tau_{\\mathrm{cld}}^{(i)} T_s + \\left(1-\\tau_{\\mathrm{cld}}^{(i)}\\right) T_c\n$$\nThus, $y^{(i)}(x)$ is a convex combination weighted by the cloud fraction $c$:\n$$\ny^{(i)}(x) = (1-c) y_{\\mathrm{clr}}^{(i)} + c y_{\\mathrm{cld}}^{(i)}\n$$\nThe transmittances $\\tau_{\\mathrm{clr}}^{(i)}$ and $\\tau_{\\mathrm{cld}}^{(i)}$ depend on the state variables $q$ and $L$:\n$$\n\\tau_{\\mathrm{clr}}^{(i)}(q) = \\exp(-\\kappa_q^{(i)} q)\n$$\n$$\n\\tau_{\\mathrm{cld}}^{(i)}(q, L) = \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L)\n$$\n\nThe tangent-linear operator $\\mathcal{H}$ is the Jacobian of $H(x)$, a $2 \\times 6$ matrix whose elements are the partial derivatives of each component of $H$ with respect to each component of $x$. The action of $\\mathcal{H}$ on a perturbation vector $\\delta x$ is the matrix-vector product $\\mathcal{H}\\,\\delta x$. To compute this, we need the partial derivatives of $y^{(i)}$ with respect to each of the $6$ components of $x$. We find these using the chain rule.\n\nFirst, we find the derivatives of the transmittances with respect to the state variables on which they depend:\n$$\n\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q) = -\\kappa_q^{(i)} \\tau_{\\mathrm{clr}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q} = -\\kappa_q^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_q^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\n$$\n\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -\\kappa_l^{(i)} \\exp(-\\kappa_q^{(i)} q - \\kappa_l^{(i)} L) = -\\kappa_l^{(i)} \\tau_{\\mathrm{cld}}^{(i)}\n$$\nNote that $\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial L} = 0$.\n\nNow, we compute the partial derivatives of $y^{(i)}$:\n1.  Derivative with respect to $T_s$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_s} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_s} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_s} = (1-c)\\tau_{\\mathrm{clr}}^{(i)} + c\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n2.  Derivative with respect to $T_a$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_a} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial T_a} = (1-c)(1-\\tau_{\\mathrm{clr}}^{(i)})\n    $$\n3.  Derivative with respect to $T_c$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial T_c} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial T_c} = c(1-\\tau_{\\mathrm{cld}}^{(i)})\n    $$\n4.  Derivative with respect to $q$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = (1-c)\\frac{\\partial y_{\\mathrm{clr}}^{(i)}}{\\partial q} + c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial q} = (1-c)(T_s - T_a)\\frac{\\partial \\tau_{\\mathrm{clr}}^{(i)}}{\\partial q} + c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial q}\n    $$\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial q} = -(1-c)(T_s - T_a)\\kappa_q^{(i)}\\tau_{\\mathrm{clr}}^{(i)} - c(T_s - T_c)\\kappa_q^{(i)}\\tau_{\\mathrm{cld}}^{(i)} = -\\kappa_q^{(i)}\\left[(1-c)\\tau_{\\mathrm{clr}}^{(i)}(T_s-T_a) + c\\tau_{\\mathrm{cld}}^{(i)}(T_s-T_c)\\right]\n    $$\n5.  Derivative with respect to $L$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial L} = c\\frac{\\partial y_{\\mathrm{cld}}^{(i)}}{\\partial L} = c(T_s - T_c)\\frac{\\partial \\tau_{\\mathrm{cld}}^{(i)}}{\\partial L} = -c(T_s - T_c)\\kappa_l^{(i)}\\tau_{\\mathrm{cld}}^{(i)}\n    $$\n6.  Derivative with respect to $c$:\n    $$\n    \\frac{\\partial y^{(i)}}{\\partial c} = -y_{\\mathrm{clr}}^{(i)} + y_{\\mathrm{cld}}^{(i)}\n    $$\n\nThe action of the tangent-linear operator on a perturbation $\\delta x = [\\delta T_s, \\delta T_a, \\delta T_c, \\delta q, \\delta L, \\delta c]^\\top$ is then given by the vector whose $i$-th component is:\n$$\n(\\mathcal{H}\\,\\delta x)_i = \\frac{\\partial y^{(i)}}{\\partial T_s}\\delta T_s + \\frac{\\partial y^{(i)}}{\\partial T_a}\\delta T_a + \\frac{\\partial y^{(i)}}{\\partial T_c}\\delta T_c + \\frac{\\partial y^{(i)}}{\\partial q}\\delta q + \\frac{\\partial y^{(i)}}{\\partial L}\\delta L + \\frac{\\partial y^{(i)}}{\\partial c}\\delta c\n$$\nThis is the dot product of the gradient of $y^{(i)}$ and the perturbation vector $\\delta x$.\n\nThe implementation will consist of two functions: one for the non-linear operator $H(x)$ and one for the tangent-linear action $\\mathcal{H}\\,\\delta x$. A loop will then iterate through the four provided test cases. For each case, the consistency ratio $\\mathcal{R}(\\epsilon; x, \\delta x)$ is calculated for a sequence of $\\epsilon$ values: $[10^{-1}, 10^{-2}, 10^{-3}, 10^{-4}, 10^{-5}]$. The denominator $\\epsilon\\,\\|\\mathcal{H}\\,\\delta x\\|_2$ is checked against a threshold of $10^{-12}$ to prevent division by zero and identify cases where the perturbation has no effect in the linear approximation.\n\nFinally, the acceptance criteria are applied: the sequence of the first four ratios $\\mathcal{R}(\\epsilon)$ must be strictly decreasing, and the value of $\\mathcal{R}$ at $\\epsilon = 10^{-4}$ must be less than $10^{-3}$. A boolean result (True/False) is recorded for each test case based on these criteria.",
            "answer": "```python\nimport numpy as np\n\n# Define global constants as specified in the problem\nKAPPAS = {\n    1: {'q': 0.08, 'l': 0.02},\n    2: {'q': 0.02, 'l': 0.08}\n}\nEPSILONS = [10**(-i) for i in range(1, 6)]\nZERO_THRESHOLD = 1e-12\nACCEPTANCE_THRESHOLD = 1e-3\n\ndef H_operator(x):\n    \"\"\"\n    Implements the non-linear forward operator H(x).\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n    \n    Returns:\n        np.ndarray: The 2-element observation vector [y^(1), y^(2)].\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    y = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        \n        y[i-1] = (1 - c) * y_clr_i + c * y_cld_i\n        \n    return y\n\ndef H_tl_operator(x, dx):\n    \"\"\"\n    Implements the action of the tangent-linear operator H_tl on a perturbation dx.\n    \n    Args:\n        x (np.ndarray): The state vector [Ts, Ta, Tc, q, L, c].\n        dx (np.ndarray): The perturbation vector [dTs, dTa, dTc, dq, dL, dc].\n    \n    Returns:\n        np.ndarray: The 2-element result vector H_tl * dx.\n    \"\"\"\n    Ts, Ta, Tc, q, L, c = x\n    H_dx = np.zeros(2)\n\n    for i in range(1, 3):\n        kappa_q_i = KAPPAS[i]['q']\n        kappa_l_i = KAPPAS[i]['l']\n        \n        tau_clr_i = np.exp(-kappa_q_i * q)\n        tau_cld_i = np.exp(-kappa_q_i * q - kappa_l_i * L)\n        \n        # Partial derivatives\n        d_y_i_d_Ts = (1 - c) * tau_clr_i + c * tau_cld_i\n        d_y_i_d_Ta = (1 - c) * (1 - tau_clr_i)\n        d_y_i_d_Tc = c * (1 - tau_cld_i)\n        d_y_i_d_q = -kappa_q_i * ((1 - c) * tau_clr_i * (Ts - Ta) + c * tau_cld_i * (Ts - Tc))\n        d_y_i_d_L = -c * kappa_l_i * tau_cld_i * (Ts - Tc)\n        \n        y_clr_i = tau_clr_i * Ts + (1 - tau_clr_i) * Ta\n        y_cld_i = tau_cld_i * Ts + (1 - tau_cld_i) * Tc\n        d_y_i_d_c = y_cld_i - y_clr_i\n        \n        jacobian_row_i = np.array([\n            d_y_i_d_Ts, d_y_i_d_Ta, d_y_i_d_Tc,\n            d_y_i_d_q, d_y_i_d_L, d_y_i_d_c\n        ])\n        \n        H_dx[i-1] = np.dot(jacobian_row_i, dx)\n        \n    return H_dx\n\ndef solve():\n    \"\"\"\n    Main function to run the tangent-linear test for all specified cases.\n    \"\"\"\n    test_cases = [\n        # Test case 1\n        (np.array([288.0, 275.0, 265.0, 0.012, 0.10, 0.40]), \n         np.array([0.5, -0.3, 0.2, 0.001, 0.02, -0.05])),\n        # Test case 2\n        (np.array([290.0, 270.0, 260.0, 0.010, 0.05, 0.00]), \n         np.array([0.5, -0.2, 0.1, 0.0005, 0.01, 0.10])),\n        # Test case 3\n        (np.array([285.0, 272.0, 262.0, 0.015, 0.20, 1.00]), \n         np.array([0.2, 0.2, -0.3, -0.002, 0.03, -0.10])),\n        # Test case 4\n        (np.array([292.0, 278.0, 268.0, 0.030, 0.30, 0.70]), \n         np.array([-0.4, 0.4, 0.0, 0.003, -0.05, 0.00])),\n    ]\n\n    results = []\n    \n    for x, dx in test_cases:\n        Hx = H_operator(x)\n        H_tl_dx = H_tl_operator(x, dx)\n        \n        norm_H_tl_dx = np.linalg.norm(H_tl_dx)\n        \n        R_values = []\n        is_acceptable = True\n        \n        for epsilon in EPSILONS:\n            denominator = epsilon * norm_H_tl_dx\n            if denominator < ZERO_THRESHOLD:\n                is_acceptable = False\n                break\n            \n            x_pert = x + epsilon * dx\n            Hx_pert = H_operator(x_pert)\n            \n            numerator = np.linalg.norm(Hx_pert - Hx - epsilon * H_tl_dx)\n            \n            R_values.append(numerator / denominator)\n            \n        if not is_acceptable:\n            results.append(False)\n            continue\n            \n        # Check acceptance criteria on the calculated ratios\n        # 1. Strictly decreasing for the first 4 epsilon values\n        is_strictly_decreasing = (\n            R_values[0] > R_values[1] and\n            R_values[1] > R_values[2] and\n            R_values[2] > R_values[3]\n        )\n        \n        # 2. Value at epsilon = 1e-4 is less than the threshold\n        is_small_enough = R_values[3] < ACCEPTANCE_THRESHOLD\n        \n        results.append(is_strictly_decreasing and is_small_enough)\n            \n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "For large-scale variational assimilation systems, computing the full Jacobian matrix to find the cost function gradient is computationally prohibitive. The adjoint model, $\\mathcal{H}^T$, offers an exceptionally efficient alternative by calculating the gradient with a single model integration, irrespective of the state vector's size. Given its importance, verifying the correctness of the adjoint code is a non-negotiable step in model development. This exercise  introduces the standard \"adjoint test,\" which confirms that the implemented adjoint operator is indeed the mathematical transpose of the tangent-linear operator, ensuring the integrity of the entire assimilation system.",
            "id": "4011581",
            "problem": "**Fundamental base:**\n- Assume Local Thermodynamic Equilibrium (LTE) and a purely absorbing atmosphere (no scattering), described by the discrete Schwarzschild equation for thermal emission along a vertical column with $N$ layers. The upward monochromatic radiance at the top of the atmosphere for channel $c$, denoted $I_c$, is\n$$\nI_c \\;=\\; B_c(T_s)\\,\\exp\\!\\left(-\\sum_{j=1}^{N} \\tau_{c,j}\\right) \\;+\\; \\sum_{i=1}^{N} B_c(T_i)\\,\\bigl(1 - \\exp(-\\tau_{c,i})\\bigr)\\,\\exp\\!\\left(-\\sum_{j=i+1}^{N} \\tau_{c,j}\\right),\n$$\nwhere $T_s$ is the surface temperature, $T_i$ is the temperature of layer $i$, and $\\tau_{c,i}$ is the layer optical depth for channel $c$.\n- Use the Rayleigh–Jeans approximation for microwave radiance, $B_c(T) = \\alpha_c\\,T$, where $\\alpha_c = \\dfrac{2\\,k_B\\,\\nu_c^2}{c^2}$, and $c$ is the speed of light.\n- Define the optical depth per layer as $\\tau_{c,i} \\;=\\; \\kappa_c \\,\\rho_i \\,q_{c,i}\\,\\Delta z_i$, where $\\kappa_c$ is the mass extinction coefficient for channel $c$, $\\rho_i$ is the air density in layer $i$, $q_{c,i}$ is the cloud water mixing ratio in layer $i$, and $\\Delta z_i$ is the layer thickness.\n\n**Task:**\n- You are given a simplified all-sky observation operator in the context of numerical weather prediction and climate modeling that maps a vertical profile of cloud water mixing ratio to top-of-atmosphere upward radiances for multiple microwave channels. The goal is to verify adjoint consistency numerically for perturbations in the cloud water mixing ratio by checking that the equality $\\langle \\mathcal{H} \\,\\delta x, \\delta y \\rangle = \\langle \\delta x, \\mathcal{H}^{T} \\,\\delta y \\rangle$ holds, where $\\mathcal{H}$ is the tangent-linear (Jacobian) of the observation operator with respect to the cloud water mixing ratio and $\\mathcal{H}^{T}$ is its adjoint under the Euclidean inner product.\n- Derive the tangent-linear operator $\\mathcal{H}$ that maps perturbations in the cloud water mixing ratio vector $\\delta x = [\\delta q_{c,1}, \\dots, \\delta q_{c,N}]^T$ to perturbations in radiance $\\delta y = [\\delta I_1, \\dots, \\delta I_{C}]^T$ for $C$ channels, starting from the above fundamental base. Construct $\\mathcal{H}$ numerically by computing the Jacobian entries $w_{c,i} = \\dfrac{\\partial I_c}{\\partial q_{c,i}}$ through the chain rule with $\\dfrac{\\partial \\tau_{c,i}}{\\partial q_{c,i}} = \\kappa_c \\,\\rho_i\\,\\Delta z_i$.\n- Use the Euclidean inner product, $\\langle a, b \\rangle = \\sum_k a_k\\,b_k$, and set the adjoint $\\mathcal{H}^{T}$ equal to the transpose of the Jacobian matrix.\n- For each test case, generate perturbations $\\delta x$ and $\\delta y$ using a fixed random seed and standard normal draws. Compute both $\\langle \\mathcal{H}\\,\\delta x, \\delta y \\rangle$ and $\\langle \\delta x, \\mathcal{H}^{T}\\,\\delta y \\rangle$ and report the absolute difference as a floating-point number.\n\n**Physical units note:**\n- Although intermediate quantities carry physical units (e.g., optical depth is dimensionless, temperature in $\\mathrm{K}$, density in $\\mathrm{kg\\,m^{-3}}$, thickness in $\\mathrm{m}$, frequency in $\\mathrm{Hz}$), the required outputs are pure floating-point numbers representing absolute differences in inner products; no unit conversion is required for the outputs.\n\n**Test suite specification:**\n- Implement your program to run the following five test cases. In all cases, express temperatures in $\\mathrm{K}$, densities in $\\mathrm{kg\\,m^{-3}}$, layer thicknesses in $\\mathrm{m}$, frequencies in $\\mathrm{Hz}$, and mass extinction coefficients in $\\mathrm{m^2\\,kg^{-1}}$.\n\n- Test case $1$ (general happy path, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [5\\times 10^{-4}, 2\\times 10^{-4}, 1\\times 10^{-4}, 5\\times 10^{-5}, 1\\times 10^{-5}]$\n  - Channels: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - Random seeds: $\\text{seed}_{\\delta x} = 42$, $\\text{seed}_{\\delta y} = 43$\n\n- Test case $2$ (cloud-free background, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [0, 0, 0, 0, 0]$\n  - Channels: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - Random seeds: $\\text{seed}_{\\delta x} = 123$, $\\text{seed}_{\\delta y} = 124$\n\n- Test case $3$ (optically thick cloud, $N=5$, $C=2$):\n  - $T_s = 300$, $T = [290, 270, 250, 230, 220]$\n  - $\\rho = [1.2, 1.0, 0.8, 0.5, 0.3]$\n  - $\\Delta z = [1000, 1000, 1000, 500, 500]$\n  - $q = [5\\times 10^{-3}, 4\\times 10^{-3}, 3\\times 10^{-3}, 2\\times 10^{-3}, 1\\times 10^{-3}]$\n  - Channels: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.2, 0.4]$\n  - Random seeds: $\\text{seed}_{\\delta x} = 7$, $\\text{seed}_{\\delta y} = 8$\n\n- Test case $4$ (single-layer boundary case, $N=1$, $C=2$):\n  - $T_s = 300$, $T = [290]$\n  - $\\rho = [1.2]$\n  - $\\Delta z = [1000]$\n  - $q = [1\\times 10^{-3}]$\n  - Channels: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}]$, $\\kappa = [0.03, 0.06]$\n  - Random seeds: $\\text{seed}_{\\delta x} = 99$, $\\text{seed}_{\\delta y} = 100$\n\n- Test case $5$ (nonuniform grid and three channels, $N=6$, $C=3$):\n  - $T_s = 295$, $T = [285, 275, 260, 240, 225, 215]$\n  - $\\rho = [1.18, 1.05, 0.9, 0.7, 0.5, 0.35]$\n  - $\\Delta z = [800, 1200, 900, 700, 600, 500]$\n  - $q = [2\\times 10^{-4}, 0, 1\\times 10^{-3}, 5\\times 10^{-4}, 0, 2\\times 10^{-5}]$\n  - Channels: $\\nu = [50\\times 10^{9}, 89\\times 10^{9}, 150\\times 10^{9}]$, $\\kappa = [0.05, 0.08, 0.12]$\n  - Random seeds: $\\text{seed}_{\\delta x} = 2025$, $\\text{seed}_{\\delta y} = 2026$\n\nOutput format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., `[0.0,0.0,0.0]`). Each element of the list must be the absolute difference $\\bigl|\\langle \\mathcal{H}\\,\\delta x, \\delta y \\rangle - \\langle \\delta x, \\mathcal{H}^{T}\\,\\delta y \\rangle\\bigr|$ for the corresponding test case, expressed as a floating-point number.",
            "solution": "The problem statement is assessed to be **valid**. It is scientifically grounded in the principles of radiative transfer, mathematically well-posed, and provides a complete and consistent set of information for a solvable numerical task. While there is a minor notational ambiguity where the cloud water mixing ratio is written as $q_{c,i}$ (implying channel-dependence) in the formal definition but provided as a single, channel-independent profile $q_i$ in the test cases, this is resolved by adhering to the physically correct interpretation and the structure of the provided data. The problem represents a standard and meaningful verification exercise in the field of numerical modeling and data assimilation.\n\nThe core task is to numerically verify the adjoint property for a linear operator $\\mathcal{H}$, which is a tangent-linear approximation of a non-linear observation operator $\\mathcal{M}$. The property states that for any two vectors $\\delta x$ (a perturbation in the model state space) and $\\delta y$ (a perturbation in the observation space), the following equality holds:\n$$\n\\langle \\mathcal{H} \\,\\delta x, \\delta y \\rangle = \\langle \\delta x, \\mathcal{H}^{T} \\,\\delta y \\rangle\n$$\nHere, $\\mathcal{H}$ is the Jacobian matrix of $\\mathcal{M}$, and $\\mathcal{H}^T$ is its adjoint, which is the matrix transpose under the standard Euclidean inner product $\\langle a, b \\rangle = \\sum_k a_k b_k$. The identity is a fundamental property of linear algebra: $(\\mathcal{H}\\delta x)^T \\delta y = \\delta x^T \\mathcal{H}^T \\delta y$. Therefore, the verification process hinges on the correct numerical construction of the Jacobian matrix $\\mathcal{H}$.\n\nThe state vector $x$ is the profile of cloud water mixing ratio, $x = q = [q_1, \\dots, q_N]^T \\in \\mathbb{R}^N$. The observation vector $y$ is the set of top-of-atmosphere radiances, $y = I = [I_1, \\dots, I_C]^T \\in \\mathbb{R}^C$. The Jacobian matrix $\\mathcal{H}$ thus has dimensions $C \\times N$, with elements given by $\\mathcal{H}_{ci} = \\frac{\\partial I_c}{\\partial q_i}$.\n\nThe problem uses the Rayleigh-Jeans approximation for radiance, $B_c(T) = \\alpha_c T$. Since the factor $\\alpha_c$ would appear linearly on both sides of the adjoint identity, we can simplify the calculation by working with brightness temperatures, which is equivalent to setting $\\alpha_c=1$. Thus, we use $B(T)=T$.\n\nTo compute the Jacobian elements, we use the chain rule:\n$$\n\\mathcal{H}_{ci} = \\frac{\\partial I_c}{\\partial q_i} = \\frac{\\partial I_c}{\\partial \\tau_{c,i}} \\frac{\\partial \\tau_{c,i}}{\\partial q_i}\n$$\nThe derivative of the optical depth $\\tau_{c,i} = \\kappa_c \\rho_i q_i \\Delta z_i$ with respect to $q_i$ is given and is straightforward:\n$$\n\\frac{\\partial \\tau_{c,i}}{\\partial q_i} = \\kappa_c \\rho_i \\Delta z_i\n$$\nThe main challenge lies in calculating $\\frac{\\partial I_c}{\\partial \\tau_{c,i}}$. We use a computationally efficient recursive approach. Let $I_c^{\\uparrow}(k)$ be the upwelling brightness temperature at the top of layer $k$ (where $k=0$ is the surface). The radiative transfer process can be described by the recurrence relation:\n$$\nI_c^{\\uparrow}(k) = I_c^{\\uparrow}(k-1) e^{-\\tau_{c,k}} + T_k (1 - e^{-\\tau_{c,k}}), \\quad \\text{for } k=1, \\dots, N\n$$\nwith the boundary condition $I_c^{\\uparrow}(0) = T_s$. The final top-of-atmosphere radiance is $I_c = I_c^{\\uparrow}(N)$.\n\nTo find the derivative of $I_c = I_c^{\\uparrow}(N)$ with respect to the optical depth of an arbitrary layer $i$, $\\tau_{c,i}$, we differentiate the recurrence relation.\nFor any layer $k > i$, the optical depth $\\tau_{c,i}$ only affects $I_c^{\\uparrow}(k)$ through its dependence on $I_c^{\\uparrow}(k-1)$:\n$$\n\\frac{\\partial I_c^{\\uparrow}(k)}{\\partial \\tau_{c,i}} = \\frac{\\partial I_c^{\\uparrow}(k-1)}{\\partial \\tau_{c,i}} e^{-\\tau_{c,k}}\n$$\nThis shows that the derivative propagates upwards, attenuated by the transmittance of each layer it passes through. The \"source\" of the derivative is at layer $i$:\n$$\n\\frac{\\partial I_c^{\\uparrow}(i)}{\\partial \\tau_{c,i}} = -I_c^{\\uparrow}(i-1) e^{-\\tau_{c,i}} + T_i e^{-\\tau_{c,i}} = (T_i - I_c^{\\uparrow}(i-1)) e^{-\\tau_{c,i}}\n$$\nCombining these, the derivative of the TOA radiance with respect to $\\tau_{c,i}$ is the source term at layer $i$ multiplied by the total transmittance of all layers above $i$:\n$$\n\\frac{\\partial I_c}{\\partial \\tau_{c,i}} = \\frac{\\partial I_c^{\\uparrow}(N)}{\\partial \\tau_{c,i}} = (T_i - I_c^{\\uparrow}(i-1)) e^{-\\tau_{c,i}} \\exp\\left(-\\sum_{j=i+1}^{N} \\tau_{c,j}\\right)\n$$\nThe implementation algorithm is as follows:\n$1$. For each test case, parse the atmospheric and channel parameters.\n$2$. For each channel $c \\in \\{1, \\dots, C\\}$:\n    a. Calculate the optical depth profile $\\tau_{c,i}$ for all layers $i \\in \\{1, \\dots, N\\}$.\n    b. Compute the upwelling brightness temperature profile $I_c^{\\uparrow}(k)$ for $k=0, \\dots, N$ using the forward recurrence relation. These intermediate values must be stored.\n    c. For each layer $i \\in \\{1, \\dots, N\\}$, calculate the Jacobian element $\\mathcal{H}_{ci}$ by combining the derivative terms as derived above.\n$3$. Generate random perturbation vectors $\\delta x \\in \\mathbb{R}^N$ and $\\delta y \\in \\mathbb{R}^C$ using the specified random seeds.\n$4$. Compute the two inner products: $LHS = (\\mathcal{H} \\delta x)^T \\delta y$ and $RHS = \\delta x^T (\\mathcal{H}^T \\delta y)$.\n$5$. Calculate and store the absolute difference $|LHS - RHS|$. Due to the properties of floating-point arithmetic, this value should be extremely close to $0.0$.\n$6$. Collect the results from all test cases and format them as a comma-separated list.",
            "answer": "```python\nimport numpy as np\n\ndef run_adjoint_test(case_params):\n    \"\"\"\n    Runs the adjoint test for a single case.\n    \n    This function computes the Jacobian of the radiance operator, then verifies\n    the adjoint identity <H*dx, dy> = <dx, H^T*dy> numerically.\n    \"\"\"\n    Ts, T, rho, dz, q, nu, kappa, seed_dx, seed_dy = case_params\n    \n    # Convert input lists to numpy arrays for vectorized operations\n    T = np.array(T)\n    rho = np.array(rho)\n    dz = np.array(dz)\n    q = np.array(q)\n    kappa = np.array(kappa)\n\n    N = len(T)\n    C = len(nu)\n\n    # Initialize the Jacobian matrix H (size C x N)\n    H = np.zeros((C, N))\n\n    # Loop over each channel to compute rows of the Jacobian\n    for c in range(C):\n        # Calculate the constants for the optical depth calculation for this channel.\n        # tau_c,i = A_c,i * q_i\n        A_c = kappa[c] * rho * dz\n        \n        # Calculate optical depth profile for this channel based on the q profile\n        tau_c = A_c * q\n        \n        # --- Forward Model Calculation ---\n        # We work in brightness temperature units (alpha=1).\n        # I_up[i] stores the upwelling radiance (in K) at the TOP of layer i (0-indexed).\n        # I_up[0] is the surface contribution entering layer 0 from below.\n        # I_up[N] is the final TOA radiance.\n        I_up = np.zeros(N + 1)\n        I_up[0] = Ts\n        for i in range(N):\n            transmittance_i = np.exp(-tau_c[i])\n            I_up[i+1] = I_up[i] * transmittance_i + T[i] * (1 - transmittance_i)\n            \n        # --- Jacobian Calculation for channel c ---\n        # Loop over layers i (the control variable dimension) to compute H[c, i]\n        for i in range(N):\n            # The derivative of radiance w.r.t optical depth of layer i is:\n            # dI/dtau_i = (T_i - I_up_below) * exp(-tau_i) * Transmittance_above_i\n            \n            # I_up_below is the radiance entering layer i from below.\n            # For 0-indexed layer i, this is I_up[i].\n            I_below = I_up[i]\n            \n            # Transmittance from the top of layer i to the top of the atmosphere.\n            # This is the product of transmittances of layers i+1, ..., N-1.\n            trans_above = np.exp(-np.sum(tau_c[i+1:]))\n            \n            # Derivative of TOA radiance w.r.t optical depth of layer i\n            dI_dtau = (T[i] - I_below) * np.exp(-tau_c[i]) * trans_above\n            \n            # Full derivative using chain rule: dI/dq_i = dI/dtau_i * dtau_i/dq_i\n            # where dtau_i/dq_i = kappa_c * rho_i * dz_i = A_c[i]\n            H[c, i] = dI_dtau * A_c[i]\n\n    # --- Adjoint Test ---\n    # Generate random perturbations for the state and observation spaces\n    rng_dx = np.random.RandomState(seed_dx)\n    dx = rng_dx.randn(N)\n    \n    rng_dy = np.random.RandomState(seed_dy)\n    dy = rng_dy.randn(C)\n    \n    # Compute the two sides of the identity using dot products\n    # term1 = <H*dx, dy>\n    H_dx = H @ dx\n    term1 = H_dx @ dy\n    \n    # term2 = <dx, H^T*dy>\n    HT_dy = H.T @ dy\n    term2 = dx @ HT_dy\n    \n    # Calculate the absolute difference, which should be near zero\n    abs_diff = np.abs(term1 - term2)\n    \n    return abs_diff\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Test case 1 (general happy path, N=5, C=2)\n        (300.0, [290.0, 270.0, 250.0, 230.0, 220.0], [1.2, 1.0, 0.8, 0.5, 0.3], [1000.0, 1000.0, 1000.0, 500.0, 500.0], [5e-4, 2e-4, 1e-4, 5e-5, 1e-5], [50e9, 89e9], [0.03, 0.06], 42, 43),\n        # Test case 2 (cloud-free background, N=5, C=2)\n        (300.0, [290.0, 270.0, 250.0, 230.0, 220.0], [1.2, 1.0, 0.8, 0.5, 0.3], [1000.0, 1000.0, 1000.0, 500.0, 500.0], [0.0, 0.0, 0.0, 0.0, 0.0], [50e9, 89e9], [0.03, 0.06], 123, 124),\n        # Test case 3 (optically thick cloud, N=5, C=2)\n        (300.0, [290.0, 270.0, 250.0, 230.0, 220.0], [1.2, 1.0, 0.8, 0.5, 0.3], [1000.0, 1000.0, 1000.0, 500.0, 500.0], [5e-3, 4e-3, 3e-3, 2e-3, 1e-3], [50e9, 89e9], [0.2, 0.4], 7, 8),\n        # Test case 4 (single-layer boundary case, N=1, C=2)\n        (300.0, [290.0], [1.2], [1000.0], [1e-3], [50e9, 89e9], [0.03, 0.06], 99, 100),\n        # Test case 5 (nonuniform grid and three channels, N=6, C=3)\n        (295.0, [285.0, 275.0, 260.0, 240.0, 225.0, 215.0], [1.18, 1.05, 0.9, 0.7, 0.5, 0.35], [800.0, 1200.0, 900.0, 700.0, 600.0, 500.0], [2e-4, 0.0, 1e-3, 5e-4, 0.0, 2e-5], [50e9, 89e9, 150e9], [0.05, 0.08, 0.12], 2025, 2026),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_adjoint_test(case)\n        results.append(result)\n\n    # Format the output as a single comma-separated list in brackets,\n    # with floating point numbers formatted for precision.\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}