{
    "hands_on_practices": [
        {
            "introduction": "Smith-Weintraub 关系式是 GPS 无线电掩星观测算子的核心，它将大气的热力学状态与折射率联系起来。在变分同化中，我们必须量化模型变量（如温度和湿度）的微小变化如何影响观测值（折射率），这需要计算观测算子的雅可比矩阵。本练习将通过推导这些敏感性，帮助你掌握构建切线性和伴随模型的关键第一步。",
            "id": "4050127",
            "problem": "考虑将全球定位系统（GPS）无线电掩星观测资料同化到一个变分数值天气预报（NWP）系统中。前向观测算子将模式状态映射为大气折射率 $N$，其定义为 $N = 10^{6} (n - 1)$，其中 $n$ 是湿空气的折射指数。一个将大气折射率与热力学状态联系起来的、经过充分检验的公式是 Smith–Weintraub 关系式，它可以表示为总压 $P$、温度 $T$ 和水汽分压 $e$ 的函数：\n$$\nN(T,e,P) = k_{1} \\,\\frac{P}{T} + k_{2} \\,\\frac{e}{T^{2}},\n$$\n其中 $k_{1}$ 和 $k_{2}$ 是由实验室测量和电磁理论确定的正常数。\n\n在变分资料同化中，线性化观测算子需要计算 $N$ 相对于控制变量的敏感性。假设在计算关于 $T$ 和 $e$ 的偏导数时，$P$ 保持不变（即 $\\partial P/\\partial T = 0$ 且 $\\partial P/\\partial e = 0$），请推导由 Smith–Weintraub 关系式所蕴含的敏感性 $\\frac{\\partial N}{\\partial T}$ 和 $\\frac{\\partial N}{\\partial e}$ 的解析表达式。请将您的最终答案表示为以 $k_{1}$、$k_{2}$、$P$、$T$ 和 $e$ 表示的封闭形式解析表达式。无需进行数值计算。",
            "solution": "该问题是有效的。这是一个适定的数学练习，基于大气物理和数值天气预报的基本原理。Smith–Weintraub 关系式是解释无线电掩星数据的基石，而其偏导数（雅可比矩阵）的计算是变分资料同化方案中的一个关键步骤。所有项都已明确定义，且必要的假设也已明确说明。\n\n该问题要求推导大气折射率 $N$ 相对于温度 $T$ 和水汽分压 $e$ 的偏导数。给定的大气折射率表达式是 Smith–Weintraub 关系式：\n$$\nN(T,e,P) = k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}}\n$$\n其中 $k_{1}$ 和 $k_{2}$ 是常数，$P$ 是总压，$T$ 是温度，$e$ 是水汽分压。\n\n问题指出，为了本次计算，$P$ 应被视为相对于 $T$ 和 $e$ 的常数。这意味着我们在计算偏导数时，将 $T$、$e$ 和 $P$ 视作自变量。\n\n首先，我们计算 $N$ 相对于温度的敏感性 $\\frac{\\partial N}{\\partial T}$。这需要对 $N$ 的表达式求关于 $T$ 的导数，同时保持 $P$ 和 $e$ 不变。我们可以逐项求导：\n$$\n\\frac{\\partial N}{\\partial T} = \\frac{\\partial}{\\partial T} \\left( k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}} \\right) = \\frac{\\partial}{\\partial T} \\left( k_{1} P T^{-1} \\right) + \\frac{\\partial}{\\partial T} \\left( k_{2} e T^{-2} \\right)\n$$\n使用幂函数求导法则 $\\frac{d}{dx}(ax^n) = anx^{n-1}$，我们求出每一项的导数。\n\n对于第一项，对 $T$ 求导：\n$$\n\\frac{\\partial}{\\partial T} \\left( k_{1} P T^{-1} \\right) = k_{1} P \\frac{\\partial}{\\partial T} \\left( T^{-1} \\right) = k_{1} P (-1)T^{-1-1} = -k_{1} P T^{-2} = -k_{1} \\frac{P}{T^{2}}\n$$\n\n对于第二项，对 $T$ 求导：\n$$\n\\frac{\\partial}{\\partial T} \\left( k_{2} e T^{-2} \\right) = k_{2} e \\frac{\\partial}{\\partial T} \\left( T^{-2} \\right) = k_{2} e (-2)T^{-2-1} = -2k_{2} e T^{-3} = -2k_{2} \\frac{e}{T^{3}}\n$$\n将这两个结果合并，我们得到关于温度的敏感性表达式：\n$$\n\\frac{\\partial N}{\\partial T} = -k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}\n$$\n\n接下来，我们计算 $N$ 相对于水汽分压的敏感性 $\\frac{\\partial N}{\\partial e}$。这需要对 $N$ 的表达式求关于 $e$ 的导数，同时保持 $P$ 和 $T$ 不变。同样，我们逐项求导：\n$$\n\\frac{\\partial N}{\\partial e} = \\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} + k_{2} \\frac{e}{T^{2}} \\right) = \\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} \\right) + \\frac{\\partial}{\\partial e} \\left( k_{2} \\frac{e}{T^{2}} \\right)\n$$\n对于第一项，变量 $k_{1}$、$P$ 和 $T$ 都被视为相对于 $e$ 的常数。因此，该项的导数为零：\n$$\n\\frac{\\partial}{\\partial e} \\left( k_{1} \\frac{P}{T} \\right) = 0\n$$\n对于第二项，我们对 $e$ 求导：\n$$\n\\frac{\\partial}{\\partial e} \\left( k_{2} \\frac{e}{T^{2}} \\right) = \\frac{k_{2}}{T^{2}} \\frac{\\partial}{\\partial e} (e) = \\frac{k_{2}}{T^{2}} (1) = \\frac{k_{2}}{T^{2}}\n$$\n合并这些结果，得到关于水汽分压的敏感性表达式：\n$$\n\\frac{\\partial N}{\\partial e} = \\frac{k_{2}}{T^{2}}\n$$\n因此，所要求的敏感性的解析表达式为：$\\frac{\\partial N}{\\partial T}$ 为 $-k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}$，$\\frac{\\partial N}{\\partial e}$ 为 $\\frac{k_{2}}{T^{2}}$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -k_{1} \\frac{P}{T^{2}} - 2k_{2} \\frac{e}{T^{3}}  \\frac{k_{2}}{T^{2}} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "建立在对折射率敏感性的理解之上，本练习将探讨使用不完整观测算子所带来的后果。通过一个忽略 Smith-Weintraub 公式中水汽项的理想化“干空气”反演场景，你将量化由此产生的温度“干偏差”。这项实践突显了精确模拟水汽效应的极端重要性，尤其是在水汽丰富的对流层低层。",
            "id": "4050120",
            "problem": "考虑在数值天气预报（NWP）中同化全球定位系统（GPS）无线电掩星（RO）数据。用于折射率的正演算子使用经过充分检验的 Smith–Weintraub 公式，该公式将折射率 $N$ 与热力学状态变量联系起来：\n$$\nN \\;=\\; k_{1}\\,\\frac{p}{T} \\;+\\; k_{2}\\,\\frac{e}{T^{2}},\n$$\n其中，$p$ 是总气压，$T$ 是温度，$e$ 是水汽分压，$k_{1} = 77.6\\,\\mathrm{K/hPa}$，$k_{2} = 3.73\\times 10^{5}\\,\\mathrm{K^{2}/hPa}$。在一种简化的“干”反演中，湿项 $k_{2}\\,e/T^{2}$ 被忽略，温度通过 $N \\approx k_{1}\\,p/T$ 从折射率推断出来。\n\n假设一个代表对流层低层的湿层，其参数为 $p = 850\\,\\mathrm{hPa}$，$T = 295\\,\\mathrm{K}$，$e = 20\\,\\mathrm{hPa}$。一次 GPS RO 观测提供了与在这一真实状态下计算的完整 Smith–Weintraub 关系式一致的折射率 $N$。一个忽略湿项的数据同化系统使用测量到的 $N$ 和已知的气压 $p$ 来反演干关系式，从而得到一个“干”温度 $T_{d}$。\n\n从 Smith–Weintraub 公式出发，并仅使用经过充分检验的物理关系，完成以下任务：\n- 当观测折射率 $N$ 是由完整的湿关系式计算得出时，推导干反演温度 $T_{d}$ 的表达式。\n- 从第一性原理出发，推导因忽略湿项而引入的精确偏差 $\\Delta T \\equiv T_{d} - T$，并用 $\\{k_{1},k_{2},p,T,e\\}$ 以闭合形式表示。\n- 对给定的湿层状态，数值计算 $\\Delta T$ 并给出最终的数值。\n\n以开尔文为单位表示最终的数值偏差。将您的答案四舍五入到四位有效数字。仅使用指定的常数和给定的状态值；不要引入任何未明确说明的额外近似。",
            "solution": "分析始于对问题陈述的验证。\n\n### 步骤 1：提取给定条件\n-   折射率 $N$ 的 Smith–Weintraub 公式：$N = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}$。\n-   干反演近似：$N \\approx k_{1}\\,\\frac{p}{T}$。\n-   常数 $k_{1}$：$77.6\\,\\mathrm{K/hPa}$。\n-   常数 $k_{2}$：$3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}$。\n-   真实总气压：$p = 850\\,\\mathrm{hPa}$。\n-   真实温度：$T = 295\\,\\mathrm{K}$。\n-   真实水汽分压：$e = 20\\,\\mathrm{hPa}$。\n-   观测折射率 $N$ 的定义：它由真实状态下的完整湿关系式计算得出。\n-   干反演温度 $T_d$ 的定义：它使用观测到的 $N$ 和已知的 $p$ 从干关系式 $N = k_{1}\\,\\frac{p}{T_d}$ 反演得出。\n-   偏差的定义：$\\Delta T \\equiv T_{d} - T$。\n-   任务 1：推导 $T_d$ 关于 $\\{k_{1},k_{2},p,T,e\\}$ 的表达式。\n-   任务 2：推导精确偏差 $\\Delta T$ 关于 $\\{k_{1},k_{2},p,T,e\\}$ 的闭合形式表达式。\n-   任务 3：对给定状态数值计算 $\\Delta T$，并四舍五入至四位有效数字。\n\n### 步骤 2：使用提取的给定条件进行验证\n该问题具有科学依据，因为它基于大气遥感中使用的标准 Smith–Weintraub 公式。气压、温度和水汽的物理值对于对流层低层是符合实际的。该问题是适定的，提供了所有必要的信息和一组明确的目标，从而可以得出一个唯一的解。语言客观而精确。该问题是分析数据同化中反演误差的标准练习，并且完全有效。\n\n### 步骤 3：推导与求解\n\n该问题要求系统地推导因忽略水汽对大气折射率的贡献而产生的温度偏差。\n\n首先，我们确定观测折射率 $N$ 的值。该值由真实大气状态 $\\{p, T, e\\}$ 使用完整的 Smith–Weintraub 公式确定：\n$$\nN = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\n$$\n这个 $N$ 值就是 GPS RO 仪器在该大气层中会测量到的值。\n\n接下来，一个使用简化的“干”正演算子的数据同化系统试图反演温度。它假设折射率通过简化的干公式与反演温度 $T_d$ 和已知气压 $p$ 相关联：\n$$\nN = k_{1}\\,\\frac{p}{T_{d}}\n$$\n该系统使用观测到的 $N$ 求解 $T_d$。\n\n为了推导 $T_d$ 的表达式，我们将两个关于 $N$ 的表达式相等：\n$$\nk_{1}\\,\\frac{p}{T_{d}} = k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\n$$\n我们现在求解这个方程以得到 $T_d$。首先，我们可以对两边取倒数：\n$$\n\\frac{T_{d}}{k_{1}p} = \\frac{1}{k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}}\n$$\n乘以 $k_1 p$ 得到干反演温度 $T_d$ 的表达式：\n$$\nT_d = \\frac{k_{1}p}{k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}}\n$$\n为了得到一个更方便的形式，我们可以将分子和分母同乘以 $T^2$：\n$$\nT_d = \\frac{k_{1}pT^{2}}{T^2 \\left(k_{1}\\,\\frac{p}{T} + k_{2}\\,\\frac{e}{T^{2}}\\right)} = \\frac{k_{1}pT^{2}}{k_{1}pT + k_{2}e}\n$$\n这就是所要求的 $T_d$ 关于真实状态变量和物理常数的表达式。\n\n现在，我们推导偏差的表达式 $\\Delta T = T_d - T$。我们将 $T_d$ 的表达式代入此定义中：\n$$\n\\Delta T = \\frac{k_{1}pT^{2}}{k_{1}pT + k_{2}e} - T\n$$\n为了简化，我们通分：\n$$\n\\Delta T = \\frac{k_{1}pT^{2} - T(k_{1}pT + k_{2}e)}{k_{1}pT + k_{2}e}\n$$\n展开分子中的项得到：\n$$\n\\Delta T = \\frac{k_{1}pT^{2} - k_{1}pT^{2} - k_{2}eT}{k_{1}pT + k_{2}e}\n$$\n分子中的前两项相消，留下偏差的最终闭合形式表达式：\n$$\n\\Delta T = \\frac{-k_{2}eT}{k_{1}pT + k_{2}e}\n$$\n这个表达式表明，对于正的物理量，偏差总是负的，这意味着在湿润大气中，干反演总是低估真实温度。\n\n最后，我们使用给定的数值来计算这个偏差：\n- $k_{1} = 77.6\\,\\mathrm{K/hPa}$\n- $k_{2} = 3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}$\n- $p = 850\\,\\mathrm{hPa}$\n- $T = 295\\,\\mathrm{K}$\n- $e = 20\\,\\mathrm{hPa}$\n\n我们计算 $\\Delta T$ 表达式的分子和分母。\n分子：\n$$\n-k_{2}eT = -(3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa}) \\times (20\\,\\mathrm{hPa}) \\times (295\\,\\mathrm{K}) = -2200700000\\,\\mathrm{K^{3}}\n$$\n分母：\n$$\nk_{1}pT + k_{2}e = (77.6\\,\\mathrm{K/hPa} \\times 850\\,\\mathrm{hPa} \\times 295\\,\\mathrm{K}) + (3.73 \\times 10^{5}\\,\\mathrm{K^{2}/hPa} \\times 20\\,\\mathrm{hPa})\n$$\n$$\nk_{1}pT + k_{2}e = (19458200\\,\\mathrm{K^{2}}) + (7460000\\,\\mathrm{K^{2}}) = 26918200\\,\\mathrm{K^{2}}\n$$\n现在，我们计算比值：\n$$\n\\Delta T = \\frac{-2200700000\\,\\mathrm{K^{3}}}{26918200\\,\\mathrm{K^{2}}} \\approx -81.75549\\,\\mathrm{K}\n$$\n问题要求最终数值四舍五入到四位有效数字。第五位有效数字是 $5$，所以我们将第四位数字向上取整。\n$$\n\\Delta T \\approx -81.76\\,\\mathrm{K}\n$$\n这个显著的负偏差凸显了在折射率计算中考虑湿项的至关重要性，尤其是在水汽丰富的对流层低层。",
            "answer": "$$\n\\boxed{-81.76}\n$$"
        },
        {
            "introduction": "在同化任何观测数据之前，必须进行严格的质量控制，以剔除可能破坏分析的受污染数据。本练习将理论与实践相结合，要求你设计一个算法来检测超折射和波导等特殊大气条件，这些条件会使 GPS 无线电掩星信号的几何光学假设失效。你将从第一性原理出发推导波导现象的物理阈值，并将其应用于一个模拟真实数值天气预报中心操作的分类方案中。",
            "id": "4050111",
            "problem": "设计并实现一个用于数值天气预报 (NWP) 的全球定位系统 (GPS) 无线电掩星 (RO) 观测资料的质量控制检验，以利用折射率的垂直梯度自动检测超折射和波导条件。其目标是根据背景场，决定在给定的切点高度上的RO观测应该被接受、降权还是剔除。该检验必须从几何光学在球状分层大气和地球曲率下的第一性原理出发，并从折射率的基本定义开始推导。最终程序必须生成一行输出，汇总所提供测试套件的分类结果。\n\n定义和要求：\n- 折射率定义为 $N = \\left(n - 1\\right)\\times 10^{6}$，其中 $n$ 是空气的折射指数，$N$ 是无量纲的（通常称为“N单位”）。\n- 假设大气是水平分层的，射线路径遵循由折射指数梯度决定的几何光学。必须通过对折射率进行适当的变换来考虑地球曲率。\n- 您必须推导出一个以“N单位/公里”表示的折射率垂直梯度 $dN/dz$ 的阈值，该阈值对应于波导的发生。您还必须提出并论证一个次要的、较不严格的阈值，用于在存在超折射但不存在波导时进行积极降权，以确保在同化系统中的实际稳健性。所有推理都必须在物理上是合理的。\n- 决策规则必须将每个在其切点高度 $z_t$ 的观测资料精确地归入以下整数类别之一：\n  - $0$：接受（不降权），\n  - $1$：降权（有超折射风险但非波导），\n  - $2$：剔除（波导），\n  - $3$：不确定（$z_t$ 附近没有足够的有效背景数据来估计梯度）。\n- 算法必须通过在 $z_t$ 周围半宽为 $W$ 的对称窗口内使用局地线性拟合，从背景折射率廓线 $N(z)$ 来估计 $z_t$ 处的局地垂直梯度 $dN/dz$。窗口半宽必须为 $W = 200$ 米。使用一种稳健的方法，该方法要求窗口内至少有 $3$ 个有效点；否则，返回类别 $3$。\n- 单位：\n  - 高度 $z$ 必须以米为单位。\n  - 垂直梯度 $dN/dz$ 必须以“N单位/公里”计算，以便进行阈值比较。\n- 输出格式：您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果（例如，“[result1,result2,result3]”），其中每个结果是上面定义的整数 $0$、$1$、$2$ 或 $3$ 之一。\n\n测试套件：\n为以下五个测试用例实现您的解决方案。在每个用例中，背景场提供了离散的垂直高度层 $z$ 和相应的折射率值 $N(z)$，以及切点高度 $z_t$。背景 $N(z)$ 数组是直接提供的（即，不要从气压和温度计算 $N$），并且这些值在科学上是合理的。\n\n- 案例 $1$（典型分层，接受）：\n  - $z$：从 $0$ 米到 $2000$ 米，步长为 $100$ 米。\n  - $N(z) = 300 - 40 \\times \\left(z / 1000\\right)$（大约每公里线性减少 $40$ N单位）。\n  - $z_t = 1000$ 米。\n\n- 案例 $2$（强超折射，降权）：\n  - $z$：从 $0$ 米到 $2000$ 米，步长为 $100$ 米。\n  - $N(z) = 320 - 130 \\times \\left(z / 1000\\right)$（大约每公里线性减少 $130$ N单位）。\n  - $z_t = 800$ 米。\n\n- 案例 $3$（波导，剔除）：\n  - $z$：从 $0$ 米到 $2000$ 米，步长为 $100$ 米。\n  - $N(z) = 340 - 170 \\times \\left(z / 1000\\right)$（大约每公里线性减少 $170$ N单位）。\n  - $z_t = 500$ 米。\n\n- 案例 $4$（接近临界，边界条件）：\n  - $z$：从 $0$ 米到 $2000$ 米，步长为 $50$ 米。\n  - $N(z) = 330 - 157 \\times \\left(z / 1000\\right)$（大约每公里线性减少 $157$ N单位）。\n  - $z_t = 600$ 米。\n\n- 案例 $5$（$z_t$ 附近有效数据不足，不确定）：\n  - $z$：从 $0$ 米到 $2000$ 米，步长为 $100$ 米。\n  - $N(z) = 310 - 80 \\times \\left(z / 1000\\right)$，但对于所有满足 $|z - 1200| \\le 200$ 米的 $z$，将 $N(z)$ 设置为缺失（非数字）。\n  - $z_t = 1200$ 米。\n\n您的程序必须：\n- 使用最小二乘线性拟合在 $|z - z_t| \\le W$ 范围内估计 $z_t$ 处的 $dN/dz$。\n- 将拟合的斜率转换为“N单位/公里”。\n- 应用您推导出的波导阈值和您论证的降权阈值，为每个案例生成分类。\n- 完全按照要求的格式打印单行，按案例顺序汇总五个整数结果。",
            "solution": "该问题陈述经评估是科学上合理、适定、客观且自洽的。它基于大气物理学和几何光学关于无线电波传播的既定原理。从第一性原理推导物理阈值，然后在质量控制算法中实现它们的要求，是数值天气预报 (NWP) 和资料同化中的一项标准且有效的任务。所提供的测试用例定义明确，并使用了科学上合理的值。将假设一个标准的、被广泛接受的地球平均半径值，这对于此类问题是一种常见且合理的做法。因此，我们着手提供一个完整的解决方案。\n\n主要任务是为 GPS 无线电掩星 (RO) 折射率廓线开发一个质量控制检验。这涉及到推导折射率垂直梯度 $dN/dz$ 的阈值，以检测超折射和波导条件。这些条件可能会导致资料同化中使用的观测算子产生较大误差，因此有必要剔除或降权受影响的数据。\n\n推导从球状分层大气中射线传播的几何光学原理开始。\n\n**1. 波导阈值的推导**\n\n在具有空间变化的折射指数 $n$ 的介质中，射线路径的曲率 $\\kappa$ 由下式给出：\n$$\n\\kappa = \\frac{1}{\\rho_{\\text{ray}}} = \\frac{1}{n} |\\nabla_{\\perp} n|\n$$\n其中 $\\rho_{\\text{ray}}$ 是射线的曲率半径，$\\nabla_{\\perp} n$ 是 $n$ 的梯度在垂直于射线方向上的分量。\n\n对于球状分层大气中的近水平射线（其中 $n$ 仅随高度 $z$ 变化），梯度是垂直的，因此 $\\nabla n \\approx \\frac{dn}{dz}\\mathbf{\\hat{k}}$。垂直于射线的分量近似为 $\\frac{dn}{dz}$。射线向更高折射指数的方向弯曲，因此在标准大气中，当 $n$ 随高度减小时，$\\frac{dn}{dz}$ 为负，射线向下弯曲。曲率为 $\\kappa = -\\frac{1}{n}\\frac{dn}{dz}$。\n\n当无线电波的向下曲率大于或等于地球表面的曲率时，就会发生波导或陷获。这种情况会将射线陷获在近地表的一个层中。地球的曲率为 $\\kappa_E = 1/R_E$，其中 $R_E$ 是地球的平均半径。\n\n因此，波导的条件是：\n$$\n\\kappa \\ge \\kappa_E \\implies -\\frac{1}{n}\\frac{dn}{dz} \\ge \\frac{1}{R_E}\n$$\n对梯度进行整理，得到波导发生的临界条件：\n$$\n\\frac{dn}{dz} \\le -\\frac{n}{R_E}\n$$\n\n使用折射率 $N$ 更为方便，其定义为 $N = (n-1) \\times 10^6$。由此，我们有 $n = 1 + N \\times 10^{-6}$。对高度 z 求导，得到：\n$$\n\\frac{dn}{dz} = 10^{-6} \\frac{dN}{dz}\n$$\n将此代入波导条件：\n$$\n10^{-6} \\frac{dN}{dz} \\le -\\frac{n}{R_E}\n$$\n$$\n\\frac{dN}{dz} \\le -\\frac{n \\times 10^6}{R_E}\n$$\n在地球大气中，折射指数 $n$ 非常接近 $1$（在地表通常 $n \\approx 1.0003$）。因此，我们可以做出 $n \\approx 1$ 的极好近似。波导阈值变为：\n$$\n\\frac{dN}{dz} \\le -\\frac{10^6}{R_E}\n$$\n为了计算数值，我们使用标准的地球平均半径 $R_E \\approx 6371$ 公里。问题要求梯度以 N单位/公里 表示。如果 $z$ 以公里为单位，则阈值为：\n$$\n\\frac{dN}{dz_{\\text{km}}} \\le -\\frac{10^6}{6371 \\text{ km}} \\approx -156.96 \\text{ N-units/km}\n$$\n在NWP质量控制的实际应用中，该值通常被取整。我们将把波导阈值 $T_{\\text{duct}}$ 设为一个标准的、物理推导的值。\n$$\nT_{\\text{duct}} = -157 \\text{ N-units/km}\n$$\n任何估计的局地梯度 $dN/dz$ 小于或等于此阈值的观测将被归类为类别 $2$（剔除）。\n\n**2. 超折射降权阈值的论证**\n\n超折射指的是折射率梯度比标准大气的梯度更负，但未必强到足以引起波导的任何条件。美国标准大气的梯度约为 $-39$ N单位/公里。非常强的负梯度通常是由湿度的急剧垂直下降引起的，例如在海洋边界层的顶部。\n\n这些陡峭的梯度对NWP模型构成了挑战，因为这些模型可能没有足够的垂直分辨率来正确表示它们。RO正演模型也假设了球对称性，而在常伴随此类垂直梯度的急剧水平变化情况下，这一假设被破坏。这可能导致比预期更大的观测误差。\n\n因此，在存在强超折射的情况下，即使不存在波导，降权观测也是审慎的。为此目的，建立了一个次级阈值 $T_{\\text{super}}$。$T_{\\text{super}}$ 的选择是在尽可能多地保留数据和避免同化潜在错误观测之间的一种启发式平衡。\n\n一个合理且稳健的选择是一个能够标记出那些比典型大气梯度负得多，但仍与临界波导极限有安全边际的梯度的值。取波导阈值的 $80\\%$ 是一个常见的做法。\n$$\nT_{\\text{super}} = 0.8 \\times T_{\\text{duct}} = 0.8 \\times (-157 \\text{ N-units/km}) \\approx -125.6 \\text{ N-units/km}\n$$\n为清晰和便于实际实现，我们将其取整为整数：\n$$\nT_{\\text{super}} = -125 \\text{ N-units/km}\n$$\n该阈值有效地标记了强大气层结条件，这些条件在资料同化系统中需要谨慎对待。\n\n**3. 算法设计与分类逻辑**\n\n质量控制算法使用背景折射率廓线 $N(z)$ 来处理每个在切点高度 $z_t$ 的 RO 观测。\n\n1.  **数据开窗**：对于给定的切点高度 $z_t$，选择所有落在半宽为 $W=200$ 米的对称垂直窗口内的背景数据点 $(z_i, N_i)$。也就是说，选择满足 $|z_i - z_t| \\le 200$ 米的点。\n\n2.  **数据有效性检查**：从窗口数据中，丢弃任何具有无效或缺失 $N$ 值（例如 NaN）的点。统计剩余的有效数据点数 $N_{\\text{valid}}$。\n\n3.  **梯度估计**：\n    *   如果 $N_{\\text{valid}}  3$，则数据不足以进行可靠的线性拟合。观测被分类为类别 $3$（不确定）。\n    *   如果 $N_{\\text{valid}} \\ge 3$，则对有效数据点执行线性最小二乘拟合，以找到使 $\\sum_i ((a z_i + b) - N_i)^2$ 最小化的斜率 $a$。该斜率 $a = dN/dz$ 的单位是 N单位/米。\n\n4.  **单位转换**：将斜率转换为所需的 N单位/公里 单位：\n    $$\n    g = \\frac{dN}{dz} [\\text{N-units/km}] = a [\\text{N-units/m}] \\times 1000 [\\text{m/km}]\n    $$\n\n5.  **分类**：将推导出的阈值应用于计算出的梯度 $g$：\n    *   **类别2（剔除）**：如果 $g \\le T_{\\text{duct}}$（即 $g \\le -157$）。\n    *   **类别1（降权）**：如果 $T_{\\text{duct}}  g \\le T_{\\text{super}}$（即 $-157  g \\le -125$）。\n    *   **类别0（接受）**：如果 $g > T_{\\text{super}}$（即 $g > -125$）。\n\n这种结构化的方法为 RO 观测提供了先验的、基于物理的质量控制，增强了其在 NWP 模型中同化的稳健性。现在将实现该算法并将其应用于提供的测试套件。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef quality_control(z_profile: np.ndarray, n_profile: np.ndarray, z_t: float, window_half_width: float) - int:\n    \"\"\"\n    Performs quality control on a GPS RO observation based on background refractivity gradients.\n\n    Args:\n        z_profile: Array of background altitude levels in meters.\n        n_profile: Array of background refractivity values (N-units).\n        z_t: Tangent height of the observation in meters.\n        window_half_width: Half-width of the fitting window in meters.\n\n    Returns:\n        An integer classification code: 0 (accept), 1 (downweight), 2 (reject), 3 (indeterminate).\n    \"\"\"\n    # Derived thresholds from first principles\n    T_DUCT = -157.0  # Ducting threshold in N-units/km\n    T_SUPER = -125.0  # Super-refraction (downweighting) threshold in N-units/km\n    MIN_POINTS_FOR_FIT = 3\n\n    # 1. Data Windowing\n    window_mask = np.abs(z_profile - z_t) = window_half_width\n    z_window = z_profile[window_mask]\n    n_window = n_profile[window_mask]\n\n    # 2. Data Validity Check\n    valid_mask = ~np.isnan(n_window)\n    z_fit = z_window[valid_mask]\n    n_fit = n_window[valid_mask]\n    num_valid_points = len(z_fit)\n\n    # 3. Gradient Estimation\n    if num_valid_points  MIN_POINTS_FOR_FIT:\n        return 3  # Indeterminate\n\n    # Perform a linear least-squares fit (degree 1 polynomial)\n    # The slope is in N-units per meter\n    try:\n        slope_m, _ = np.polyfit(z_fit, n_fit, 1)\n    except (np.linalg.LinAlgError, ValueError):\n        # This can happen if, e.g., all z_fit values are identical,\n        # which is unlikely in this context but good to be robust.\n        return 3\n\n    # 4. Unit Conversion\n    # Convert from N-units/meter to N-units/kilometer\n    gradient_km = slope_m * 1000.0\n\n    # 5. Classification\n    if gradient_km = T_DUCT:\n        return 2  # Reject (ducting)\n    elif gradient_km = T_SUPER:\n        return 1  # Downweight (super-refraction)\n    else:\n        return 0  # Accept\n\ndef solve():\n    \"\"\"\n    Main function to define test cases, run a quality control algorithm, and print results.\n    \"\"\"\n    # Window half-width in meters, as specified in the problem.\n    W = 200.0\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: Typical stratification, accept\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 300.0 - 40.0 * (z / 1000.0),\n            \"z_t\": 1000.0,\n            \"nan_z_range\": None\n        },\n        # Case 2: Strong super-refraction, downweight\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 320.0 - 130.0 * (z / 1000.0),\n            \"z_t\": 800.0,\n            \"nan_z_range\": None\n        },\n        # Case 3: Ducting, reject\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 340.0 - 170.0 * (z / 1000.0),\n            \"z_t\": 500.0,\n            \"nan_z_range\": None\n        },\n        # Case 4: Near critical, boundary condition\n        {\n            \"z_range\": (0, 2001, 50),\n            \"n_func\": lambda z: 330.0 - 157.0 * (z / 1000.0),\n            \"z_t\": 600.0,\n            \"nan_z_range\": None\n        },\n        # Case 5: Insufficient valid data, indeterminate\n        {\n            \"z_range\": (0, 2001, 100),\n            \"n_func\": lambda z: 310.0 - 80.0 * (z / 1000.0),\n            \"z_t\": 1200.0,\n            \"nan_z_range\": (1200.0, 200.0) # center, half-width\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Generate the background profile\n        z_profile = np.arange(*case[\"z_range\"])\n        n_profile = case[\"n_func\"](z_profile)\n\n        # Introduce missing data for Case 5\n        if case[\"nan_z_range\"] is not None:\n            center, half_width = case[\"nan_z_range\"]\n            nan_mask = np.abs(z_profile - center) = half_width\n            n_profile[nan_mask] = np.nan\n        \n        # Run the quality control\n        result = quality_control(z_profile, n_profile, case[\"z_t\"], W)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}