{
    "hands_on_practices": [
        {
            "introduction": "The heart of any Large-Eddy Simulation (LES) lies in its subgrid-scale (SGS) model, which parameterizes the effects of unresolved turbulence. This first practice focuses on the foundational Smagorinsky model, a classic eddy-viscosity closure. You will translate the theoretical concepts of SGS stress and mixing-length theory into a concrete algorithm to compute the eddy viscosity, $\\nu_t$, and the corresponding SGS dissipation, $\\varepsilon_{\\mathrm{sgs}}$. Mastering this core calculation  is an essential first step toward building and diagnosing LES codes for atmospheric modeling.",
            "id": "4058479",
            "problem": "You are tasked with implementing a computational module, expressed as a complete and runnable program, that applies the Smagorinsky subgrid-scale closure within Large-Eddy Simulation (LES) for shear-driven flow relevant to numerical weather prediction and climate modeling. Starting from the filtered momentum equations of incompressible flow and the definition of the resolved rate-of-strain, derive from first principles the expressions needed to compute the turbulent eddy viscosity and the subgrid-scale dissipation per unit mass at discrete sample points. The program must then apply these expressions to a well-defined test suite and produce outputs in the exact format specified.\n\nUse the following foundational bases and definitions:\n- Begin from the filtered incompressible Navier–Stokes equations and the definition of the Subgrid-Scale (SGS) stress tensor. The filtered momentum equation introduces an SGS stress $ \\tau_{ij} $ representing the effect of unresolved scales on resolved scales.\n- The resolved symmetric rate-of-strain tensor is defined as $ S_{ij} = \\tfrac{1}{2}\\left( \\partial u_i / \\partial x_j + \\partial u_j / \\partial x_i \\right) $, and the second invariant of $ S_{ij} $ is $ S_{ij} S_{ij} $.\n- For anisotropic grids, the effective filter width is $ \\Delta = (\\Delta_x \\Delta_y \\Delta_z)^{1/3} $ expressed in meters, a widely used geometric mean that is consistent with three-dimensional top-hat filters in Large-Eddy Simulation (LES).\n\nYour program shall implement the following tasks:\n1. From first principles, derive an algorithm to compute the turbulent eddy viscosity $ \\nu_t $ based on a mixing-length argument consistent with the Smagorinsky model, in terms of a constant Smagorinsky coefficient $ C_s $, an effective filter width $ \\Delta $, and the invariant magnitude of the resolved strain-rate tensor $ S_{ij} $. Do not assume any shortcut formulas; the derivation must follow from dimensional analysis and the eddy-viscosity closure for the deviatoric part of the Subgrid-Scale (SGS) stress.\n2. From the derived closure, obtain an expression for the subgrid-scale dissipation per unit mass, $ \\varepsilon_{\\mathrm{sgs}} $, defined as $ -\\tau_{ij} S_{ij} $, ensuring the dissipative property is preserved under the chosen closure and correctly accounting for the isotropic contribution.\n\nUnits and output requirements:\n- All given and computed quantities must consistently use International System of Units (SI). Strain-rate components $ S_{ij} $ are in $ \\mathrm{s}^{-1} $, grid spacings $ \\Delta_x $, $ \\Delta_y $, $ \\Delta_z $ are in $ \\mathrm{m} $, the Smagorinsky coefficient $ C_s $ is dimensionless, the eddy viscosity $ \\nu_t $ must be expressed in $ \\mathrm{m}^2\\,\\mathrm{s}^{-1} $, and the dissipation $ \\varepsilon_{\\mathrm{sgs}} $ must be expressed in $ \\mathrm{m}^2\\,\\mathrm{s}^{-3} $ per unit mass.\n- Angles do not appear in this problem.\n- Your final numerical outputs must be rounded to six decimal places.\n\nTest suite:\nCompute $ \\nu_t $ and $ \\varepsilon_{\\mathrm{sgs}} $ for each of the following five independent cases. Each case provides a symmetric resolved strain-rate tensor $ S_{ij} $ at a sample point and grid spacings, along with the Smagorinsky coefficient $ C_s $:\n- Case $A$ (general shear, anisotropic grid):\n  - $ \\Delta_x = 10\\,\\mathrm{m} $, $ \\Delta_y = 10\\,\\mathrm{m} $, $ \\Delta_z = 5\\,\\mathrm{m} $, $ C_s = 0.17 $.\n  - $ S_{ij} $ components in $ \\mathrm{s}^{-1} $: $ S_{11} = 0 $, $ S_{22} = 0 $, $ S_{33} = 0 $, $ S_{12} = S_{21} = 0.5 $, $ S_{23} = S_{32} = 0.2 $, $ S_{13} = S_{31} = 0 $.\n- Case $B$ (zero strain edge case):\n  - $ \\Delta_x = 20\\,\\mathrm{m} $, $ \\Delta_y = 20\\,\\mathrm{m} $, $ \\Delta_z = 20\\,\\mathrm{m} $, $ C_s = 0.17 $.\n  - $ S_{ij} $ components: all entries are $ 0\\,\\mathrm{s}^{-1} $.\n- Case $C$ (strong anisotropy and stronger shear):\n  - $ \\Delta_x = 50\\,\\mathrm{m} $, $ \\Delta_y = 50\\,\\mathrm{m} $, $ \\Delta_z = 5\\,\\mathrm{m} $, $ C_s = 0.17 $.\n  - $ S_{ij} $ components: $ S_{11} = 0 $, $ S_{22} = 0 $, $ S_{33} = 0 $, $ S_{12} = S_{21} = 1.0 $, $ S_{23} = S_{32} = -0.5 $, $ S_{13} = S_{31} = 0.3 $.\n- Case $D$ (refined isotropic grid with moderate shear):\n  - $ \\Delta_x = 1\\,\\mathrm{m} $, $ \\Delta_y = 1\\,\\mathrm{m} $, $ \\Delta_z = 1\\,\\mathrm{m} $, $ C_s = 0.17 $.\n  - $ S_{ij} $ components: $ S_{11} = 0 $, $ S_{22} = 0 $, $ S_{33} = 0 $, $ S_{12} = S_{21} = 0.4 $, $ S_{23} = S_{32} = 0.1 $, $ S_{13} = S_{31} = 0 $.\n- Case $E$ (variation in Smagorinsky coefficient and mixed shear):\n  - $ \\Delta_x = 10\\,\\mathrm{m} $, $ \\Delta_y = 15\\,\\mathrm{m} $, $ \\Delta_z = 7.5\\,\\mathrm{m} $, $ C_s = 0.23 $.\n  - $ S_{ij} $ components: $ S_{11} = 0 $, $ S_{22} = 0 $, $ S_{33} = 0 $, $ S_{12} = S_{21} = 0.6 $, $ S_{23} = S_{32} = 0.3 $, $ S_{13} = S_{31} = 0.2 $.\n\nProgram output specification:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each element corresponds to one case and must be a two-element list $ [\\nu_t, \\varepsilon_{\\mathrm{sgs}}] $ with both values rounded to six decimal places, in SI units, for example: $ [[\\nu_{t,A},\\varepsilon_{\\mathrm{sgs},A}],[\\nu_{t,B},\\varepsilon_{\\mathrm{sgs},B}],\\dots] $.",
            "solution": "We begin with the filtered incompressible Navier–Stokes equations appropriate for Large-Eddy Simulation (LES). Filtering the momentum equation yields a term involving the Subgrid-Scale (SGS) stress tensor $ \\tau_{ij} = \\overline{u_i u_j} - \\overline{u}_i \\, \\overline{u}_j $, where the overbar denotes filtering. The filtered equation for the resolved velocity $ \\overline{u}_i $ includes $ \\partial_j \\tau_{ij} $ and requires closure.\n\nThe resolved symmetric rate-of-strain tensor is defined as\n$$\nS_{ij} = \\frac{1}{2}\\left( \\frac{\\partial \\overline{u}_i}{\\partial x_j} + \\frac{\\partial \\overline{u}_j}{\\partial x_i} \\right),\n$$\nwith units $ \\mathrm{s}^{-1} $. A physically consistent eddy-viscosity closure models the deviatoric part of the SGS stress tensor as proportional to the resolved strain-rate:\n$$\n\\tau_{ij} - \\frac{1}{3}\\tau_{kk}\\delta_{ij} = -2 \\nu_t S_{ij},\n$$\nwhere $ \\nu_t $ is the eddy viscosity. This closure enforces symmetry and ensures that $ \\tau_{ij} $ is aligned with $ S_{ij} $, consistent with the idea that unresolved motions act as an effective viscosity on the resolved field.\n\nDimensional analysis and mixing-length theory motivate the Smagorinsky form for the eddy viscosity. The mixing length $ \\ell_s $ is taken to scale with the filter width such that $ \\ell_s = C_s \\Delta $, where $ C_s $ is a dimensionless Smagorinsky coefficient and $ \\Delta $ is an effective filter width. For anisotropic grids, a widely used choice for $ \\Delta $ consistent with three-dimensional top-hat filters is\n$$\n\\Delta = (\\Delta_x \\Delta_y \\Delta_z)^{1/3}.\n$$\nThe eddy viscosity must have units $ \\mathrm{m}^2\\,\\mathrm{s}^{-1} $, and combining a length scale $ \\ell_s $ with a velocity gradient scale derived from $ S_{ij} $ gives\n$$\n\\nu_t \\propto \\ell_s^2 \\, \\left| S \\right|.\n$$\nTo form a scalar magnitude from the tensor $ S_{ij} $, we use the invariant based on the second tensorial invariant of the rate-of-strain:\n$$\n\\left| S \\right| = \\sqrt{2 S_{ij} S_{ij}},\n$$\nwhere $ S_{ij} S_{ij} = \\sum_{i=1}^{3}\\sum_{j=1}^{3} S_{ij}^2 $ is the double contraction and the factor of $ 2 $ is conventional so that $ \\left| S \\right| $ reduces to the absolute shear rate in simple shear and preserves rotational invariance. Consequently, the Smagorinsky eddy viscosity becomes\n$$\n\\nu_t = (C_s \\Delta)^2 \\, \\sqrt{2 S_{ij} S_{ij}}.\n$$\n\nNext, we consider the subgrid-scale dissipation per unit mass. The resolved kinetic energy equation includes the SGS dissipation term\n$$\n\\varepsilon_{\\mathrm{sgs}} = -\\tau_{ij} S_{ij}.\n$$\nSubstituting the deviatoric closure and noting that the isotropic part $ \\tfrac{1}{3}\\tau_{kk}\\delta_{ij} $ does not contribute to $ -\\tau_{ij} S_{ij} $ because $ \\delta_{ij} S_{ij} = S_{kk} $ and for incompressible resolved flow $ S_{kk} = 0 $, we obtain\n$$\n\\varepsilon_{\\mathrm{sgs}} = -\\left( -2 \\nu_t S_{ij} \\right) S_{ij} = 2 \\nu_t S_{ij} S_{ij}.\n$$\nThis expression is strictly nonnegative because $ \\nu_t \\ge 0 $ and $ S_{ij} S_{ij} \\ge 0 $, thereby enforcing the dissipative nature of the SGS closure.\n\nAlgorithmic steps for each test case:\n1. Compute the effective filter width $ \\Delta = (\\Delta_x \\Delta_y \\Delta_z)^{1/3} $ using the provided grid spacings $ \\Delta_x $, $ \\Delta_y $, $ \\Delta_z $.\n2. Compute the invariant $ S_{ij} S_{ij} = \\sum_{i=1}^{3}\\sum_{j=1}^{3} S_{ij}^2 $ from the given symmetric $ S_{ij} $.\n3. Compute $ \\left| S \\right| = \\sqrt{2 S_{ij} S_{ij}} $.\n4. Compute the eddy viscosity $ \\nu_t = (C_s \\Delta)^2 \\left| S \\right| $ in $ \\mathrm{m}^2\\,\\mathrm{s}^{-1} $.\n5. Compute the subgrid-scale dissipation per unit mass $ \\varepsilon_{\\mathrm{sgs}} = 2 \\nu_t S_{ij} S_{ij} $ in $ \\mathrm{m}^2\\,\\mathrm{s}^{-3} $.\n6. Round both $ \\nu_t $ and $ \\varepsilon_{\\mathrm{sgs}} $ to six decimal places for output.\n\nScientific realism and edge-case behavior:\n- In Case $B$, $ S_{ij} = 0 $ implies $ \\nu_t = 0 $ and $ \\varepsilon_{\\mathrm{sgs}} = 0 $, as expected in the absence of shear.\n- In Case $C$, strong anisotropy with large $ \\Delta_x $ and $ \\Delta_y $ and small $ \\Delta_z $ enlarges $ \\Delta $, increasing $ \\nu_t $ and $ \\varepsilon_{\\mathrm{sgs}} $ under strong shear.\n- In Case $D$, refined grid reduces $ \\Delta $, reducing $ \\nu_t $ and $ \\varepsilon_{\\mathrm{sgs}} $ for the same resolved strain, reflecting enhanced resolution and diminished SGS activity.\n- In Case $E$, a larger $ C_s $ increases the mixing length $ \\ell_s $ and thus increases both $ \\nu_t $ and $ \\varepsilon_{\\mathrm{sgs}} $, illustrating parameter sensitivity.\n\nThe program implements these steps for the five specified cases and prints a single line containing a list of five two-element lists $ [\\nu_t, \\varepsilon_{\\mathrm{sgs}}] $, each rounded to six decimal places, with units implicitly SI as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_nu_t_and_epsilon(S, dx, dy, dz, Cs):\n    \"\"\"\n    Compute eddy viscosity nu_t and SGS dissipation epsilon_sgs\n    for a given symmetric strain-rate tensor S, grid spacings, and Smagorinsky coefficient.\n\n    Parameters:\n    - S: 3x3 numpy array for S_ij components [1/s]\n    - dx, dy, dz: grid spacings [m]\n    - Cs: Smagorinsky coefficient (dimensionless)\n\n    Returns:\n    - nu_t [m^2/s]\n    - epsilon_sgs [m^2/s^3]\n    \"\"\"\n    # Effective filter width using geometric mean for anisotropic grid\n    Delta = (dx * dy * dz) ** (1.0 / 3.0)\n\n    # Invariant S_ij S_ij = sum_{i,j} S_ij^2\n    s2 = float(np.sum(S**2))\n\n    # |S| = sqrt(2 * S_ij S_ij)\n    S_mag = np.sqrt(2.0 * s2)\n\n    # Eddy viscosity nu_t = (Cs * Delta)^2 * |S|\n    mixing_length_sq = (Cs * Delta) ** 2\n    nu_t = mixing_length_sq * S_mag\n\n    # Subgrid-scale dissipation per unit mass: epsilon_sgs = 2 * nu_t * (S_ij S_ij)\n    epsilon_sgs = 2.0 * nu_t * s2\n\n    return nu_t, epsilon_sgs\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (S matrix, dx, dy, dz, Cs)\n    test_cases = [\n        # Case A: general shear, anisotropic grid\n        (\n            np.array([\n                [0.0, 0.5, 0.0],\n                [0.5, 0.0, 0.2],\n                [0.0, 0.2, 0.0]\n            ], dtype=float),\n            10.0, 10.0, 5.0, 0.17\n        ),\n        # Case B: zero strain edge case\n        (\n            np.zeros((3,3), dtype=float),\n            20.0, 20.0, 20.0, 0.17\n        ),\n        # Case C: strong anisotropy and stronger shear\n        (\n            np.array([\n                [0.0,  1.0,  0.3],\n                [1.0,  0.0, -0.5],\n                [0.3, -0.5,  0.0]\n            ], dtype=float),\n            50.0, 50.0, 5.0, 0.17\n        ),\n        # Case D: refined isotropic grid with moderate shear\n        (\n            np.array([\n                [0.0, 0.4, 0.0],\n                [0.4, 0.0, 0.1],\n                [0.0, 0.1, 0.0]\n            ], dtype=float),\n            1.0, 1.0, 1.0, 0.17\n        ),\n        # Case E: variation in C_s and mixed shear\n        (\n            np.array([\n                [0.0, 0.6, 0.2],\n                [0.6, 0.0, 0.3],\n                [0.2, 0.3, 0.0]\n            ], dtype=float),\n            10.0, 15.0, 7.5, 0.23\n        ),\n    ]\n\n    results_str = []\n\n    for S, dx, dy, dz, Cs in test_cases:\n        nu_t, epsilon_sgs = compute_nu_t_and_epsilon(S, dx, dy, dz, Cs)\n        # Round to six decimal places and format without spaces\n        nu_t_str = f\"{nu_t:.6f}\"\n        epsilon_str = f\"{epsilon_sgs:.6f}\"\n        results_str.append(f\"[{nu_t_str},{epsilon_str}]\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "While the basic LES framework is often introduced for incompressible, constant-density flow, many real-world atmospheric phenomena involve significant density variations due to temperature and moisture. This practice introduces Favre (density-weighted) filtering, the standard technique for extending LES to handle such compressible effects. By computing the subgrid buoyancy flux anomaly , you will gain hands-on experience with the definitions and manipulations required for variable-density flows, a critical skill for simulating realistic cloud-topped boundary layers and deep convection.",
            "id": "4058432",
            "problem": "You are given three three-dimensional fields sampled on a uniform Cartesian grid representing a single snapshot from a Large-Eddy Simulation (LES) of stratocumulus: density $\\,\\rho(x,y,z)\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, vertical velocity $\\,w(x,y,z)\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$, and potential temperature $\\,\\theta(x,y,z)\\,$ in $\\mathrm{K}$. Your task is to implement a program that applies Favre (density-weighted) filtering with a periodic, discrete top-hat kernel to compute the filtered buoyancy flux anomaly field\n$$\nB(x,y,z) \\equiv \\overline{\\rho\\,w\\,\\theta}(x,y,z) - \\overline{\\rho}(x,y,z)\\,\\tilde{w}(x,y,z)\\,\\tilde{\\theta}(x,y,z),\n$$\nwhere $\\,\\overline{(\\cdot)}\\,$ denotes spatial filtering and the tilde denotes the Favre filter, defined for any scalar field $\\,\\phi\\,$ by\n$$\n\\tilde{\\phi}(x,y,z) \\equiv \\frac{\\overline{\\rho\\,\\phi}(x,y,z)}{\\overline{\\rho}(x,y,z)}.\n$$\nThe spatial filter $\\,\\overline{(\\cdot)}\\,$ is a separable, isotropic or anisotropic discrete top-hat with periodic boundary conditions and integer widths $\\,s_x$, $\\,s_y$, and $\\,s_z\\,$ in the $\\,x$, $\\,y$, and $\\,z\\,$ directions respectively. For an integer width $\\,s\\,$ along a given axis, the centered discrete top-hat includes $\\,s\\,$ grid points with offsets\n$$\n\\{\\,-\\lfloor s/2 \\rfloor,\\, -\\lfloor s/2 \\rfloor + 1,\\,\\ldots,\\,\\lceil s/2 \\rceil - 1\\,\\},\n$$\nand averages over those points. The full three-dimensional filter is the sequential application of the one-dimensional filters along each axis, which is valid due to separability. Angles used inside trigonometric functions must be interpreted in radians.\n\nYou must compute the domain-mean of $\\,B(x,y,z)\\,$ for each test case, expressed as a plain decimal float in International System of Units (SI) $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{K}$.\n\nFundamental base to be used:\n- The compressible Favre filtering definition $\\,\\tilde{\\phi} = \\overline{\\rho\\,\\phi}/\\overline{\\rho}\\,$ and linearity of the spatial filter $\\,\\overline{(\\cdot)}\\,$.\n- The discrete, centered top-hat filter with periodic wrapping and separability across axes.\n\nImplement periodic boundary conditions by wrapping indices modulo the grid size in each direction.\n\nTest Suite:\nFor each test case, construct the grid and fields exactly as specified below, then compute the domain-mean of $\\,B\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{K}$.\n\n- Test Case 1 (identity filter edge case):\n  - Grid size: $\\,N_x = 4$, $\\,N_y = 4$, $\\,N_z = 4$.\n  - Random seed: $\\,\\text{seed} = 1729$.\n  - Field generation:\n    - $\\,\\rho \\sim \\text{Uniform}(0.8,\\,1.2)\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n    - $\\,w \\sim \\text{Uniform}(-1.0,\\,1.0)\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n    - $\\,\\theta \\sim \\text{Uniform}(290,\\,310)\\,$ in $\\mathrm{K}$.\n  - Filter widths: $\\,s_x = 1$, $\\,s_y = 1$, $\\,s_z = 1$.\n\n- Test Case 2 (uniform fields consistency):\n  - Grid size: $\\,N_x = 6$, $\\,N_y = 8$, $\\,N_z = 5$.\n  - Fields (uniform constants):\n    - $\\,\\rho(x,y,z) = 1.2\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n    - $\\,w(x,y,z) = 0.5\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n    - $\\,\\theta(x,y,z) = 300\\,$ in $\\mathrm{K}$.\n  - Filter widths: $\\,s_x = 3$, $\\,s_y = 3$, $\\,s_z = 3$.\n\n- Test Case 3 (anisotropic filtering of structured variability):\n  - Grid size: $\\,N_x = 8$, $\\,N_y = 8$, $\\,N_z = 8$.\n  - Coordinates: integer indices $\\,i \\in \\{0,\\ldots,N_x-1\\}$, $\\,j \\in \\{0,\\ldots,N_y-1\\}$, $\\,k \\in \\{0,\\ldots,N_z-1\\}$, with angles in radians created by $\\,\\alpha_x = 2\\pi i/N_x$, $\\,\\alpha_y = 2\\pi j/N_y$, $\\,\\alpha_z = 2\\pi k/N_z$.\n  - Fields:\n    - $\\,\\rho(i,j,k) = 1.0 + 0.1\\sin(\\alpha_x) + 0.05\\cos(\\alpha_z)\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n    - $\\,w(i,j,k) = 0.5\\sin(\\alpha_y) + 0.2\\cos(\\alpha_x)\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n    - $\\,\\theta(i,j,k) = 300 + 2.0\\cos(\\alpha_z) + 1.0\\sin(\\alpha_x)\\sin(\\alpha_y)\\,$ in $\\mathrm{K}$.\n  - Filter widths: $\\,s_x = 3$, $\\,s_y = 1$, $\\,s_z = 5$.\n\n- Test Case 4 (domain-spanning filter):\n  - Grid size: $\\,N_x = 5$, $\\,N_y = 7$, $\\,N_z = 6$.\n  - Random seed: $\\,\\text{seed} = 2025$.\n  - Field generation:\n    - $\\,\\rho \\sim \\text{Uniform}(0.9,\\,1.3)\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n    - $\\,w \\sim \\text{Uniform}(-2.0,\\,2.0)\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n    - $\\,\\theta \\sim \\text{Uniform}(285,\\,305)\\,$ in $\\mathrm{K}$.\n  - Filter widths: $\\,s_x = N_x$, $\\,s_y = N_y$, $\\,s_z = N_z$.\n\n- Test Case 5 (sharp gradients and small even-width filter):\n  - Grid size: $\\,N_x = 3$, $\\,N_y = 3$, $\\,N_z = 3$.\n  - Fields:\n    - $\\,\\rho(i,j,k) = 1.0 + 0.3\\,\\mathbf{1}_{(j \\ge 1)}\\,$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, where $\\,\\mathbf{1}_{(\\cdot)}\\,$ is the indicator function.\n    - $\\,w(i,j,k) = -0.5 + 1.0\\,\\mathbf{1}_{(i \\ge 1)}\\,$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n    - $\\,\\theta(i,j,k) = 295 + 10\\,\\mathbf{1}_{(k \\ge 1)}\\,$ in $\\mathrm{K}$.\n  - Filter widths: $\\,s_x = 2$, $\\,s_y = 2$, $\\,s_z = 2$.\n\nYour program must:\n- Implement the centered periodic discrete top-hat filter along each axis as specified.\n- Compute $\\,\\overline{\\rho}$, $\\,\\overline{\\rho w}$, $\\,\\overline{\\rho \\theta}$, $\\,\\overline{\\rho w \\theta}$, and then $\\,\\tilde{w}$ and $\\,\\tilde{\\theta}$ via the Favre definition, and finally $\\,B$ for each test case.\n- For each test case, compute the domain-mean of $\\,B$ and report it as a float in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{K}$.\n\nFinal Output Format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of Test Case $\\,1\\,$ through Test Case $\\,5\\,$, that is, $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4,\\text{result}_5]$, where each $\\,\\text{result}_m\\,$ is the domain-mean of $\\,B\\,$ for the $\\,m$-th test case in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{K}$.",
            "solution": "The problem has been validated and is deemed scientifically sound, well-posed, and objective. It specifies a clear computational task rooted in the principles of Large-Eddy Simulation (LES) for fluid dynamics. We are tasked with computing the domain-mean of the Favre-filtered buoyancy flux anomaly, $B(x,y,z)$, for several test cases.\n\nThe buoyancy flux anomaly is defined as:\n$$\nB(x,y,z) \\equiv \\overline{\\rho\\,w\\,\\theta}(x,y,z) - \\overline{\\rho}(x,y,z)\\,\\tilde{w}(x,y,z)\\,\\tilde{\\theta}(x,y,z)\n$$\nwhere $\\rho$ is the density, $w$ is the vertical velocity, and $\\theta$ is the potential temperature. The operator $\\overline{(\\cdot)}$ denotes a spatial filter, and $\\tilde{(\\cdot)}$ denotes a Favre (density-weighted) filter.\n\nThe Favre filter for a generic scalar field $\\phi$ is given by:\n$$\n\\tilde{\\phi}(x,y,z) \\equiv \\frac{\\overline{\\rho\\,\\phi}(x,y,z)}{\\overline{\\rho}(x,y,z)}\n$$\nApplying this definition to our specific fields, the Favre-filtered velocity $\\tilde{w}$ and potential temperature $\\tilde{\\theta}$ are:\n$$\n\\tilde{w} = \\frac{\\overline{\\rho w}}{\\overline{\\rho}} \\quad \\text{and} \\quad \\tilde{\\theta} = \\frac{\\overline{\\rho \\theta}}{\\overline{\\rho}}\n$$\nSubstituting these into the expression for $B(x,y,z)$ yields:\n$$\nB = \\overline{\\rho w \\theta} - \\overline{\\rho} \\left( \\frac{\\overline{\\rho w}}{\\overline{\\rho}} \\right) \\left( \\frac{\\overline{\\rho \\theta}}{\\overline{\\rho}} \\right) = \\overline{\\rho w \\theta} - \\frac{\\overline{\\rho w} \\, \\overline{\\rho \\theta}}{\\overline{\\rho}}\n$$\nThis final expression for $B(x,y,z)$ requires the computation of four filtered fields: $\\overline{\\rho}$, $\\overline{\\rho w}$, $\\overline{\\rho \\theta}$, and $\\overline{\\rho w \\theta}$.\n\nThe core of the task is the implementation of the spatial filter $\\overline{(\\cdot)}$. It is defined as a separable, discrete top-hat filter with periodic boundary conditions. For a given axis, the filter of integer width $s$ averages over $s$ adjacent grid points. The set of relative indices (offsets) for this average is specified as $\\{-\\lfloor s/2 \\rfloor, -\\lfloor s/2 \\rfloor + 1, \\ldots, \\lceil s/2 \\rceil - 1\\}$.\n\nSince the filter is separable, the full three-dimensional filter can be constructed by applying the one-dimensional filter sequentially along each of the three axes ($x$, $y$, and $z$). Let's consider the one-dimensional filter along the $x$-axis with width $s_x$ acting on a field $\\psi$. The filtered value at index $i$ is:\n$$\n(\\overline{\\psi})_i = \\frac{1}{s_x} \\sum_{d = -\\lfloor s_x/2 \\rfloor}^{\\lceil s_x/2 \\rceil - 1} \\psi_{(i+d) \\pmod{N_x}}\n$$\nwhere $N_x$ is the number of grid points along the $x$-axis and the modulo operator enforces periodic boundary conditions. This operation is a discrete convolution with a top-hat kernel.\n\nThe algorithmic procedure for calculating the domain-mean of $B$ for each test case is as follows:\n1.  **Field Generation**: Construct the three-dimensional arrays for $\\rho(i,j,k)$, $w(i,j,k)$, and $\\theta(i,j,k)$ on a grid of size $N_x \\times N_y \\times N_z$ according to the specifications of each test case.\n2.  **Product Formation**: Compute the element-wise products to form the composite fields required for filtering: $\\rho w$, $\\rho \\theta$, and $\\rho w \\theta$.\n3.  **Spatial Filtering**: Implement a function that performs the 3D separable, periodic top-hat filtering. This function will be applied to the fields $\\rho$, $\\rho w$, $\\rho \\theta$, and $\\rho w \\theta$ using the specified filter widths ($s_x, s_y, s_z$) to compute $\\overline{\\rho}$, $\\overline{\\rho w}$, $\\overline{\\rho \\theta}$, and $\\overline{\\rho w \\theta}$. The implementation will use `numpy.roll` to efficiently handle the periodic data shifting required for the convolution sum along each axis.\n4.  **Buoyancy Flux Calculation**: Using the filtered fields, compute the buoyancy flux anomaly field $B(i,j,k)$ at each grid point using the derived formula $B = \\overline{\\rho w \\theta} - (\\overline{\\rho w} \\, \\overline{\\rho \\theta}) / \\overline{\\rho}$.\n5.  **Domain Averaging**: Compute the arithmetic mean of all values in the resulting 3D array $B$. This gives the final scalar result for the test case.\n\nThis procedure is systematically applied to each of the five test cases. The test cases include important checks:\n- **Test Case 1** ($s_x=s_y=s_z=1$): The filter is an identity operation ($\\overline{\\phi}=\\phi$), which should result in $B=0$.\n- **Test Case 2** (uniform fields): Filtering a constant field returns the same constant field, which also leads to $B=0$.\n- **Test Case 4** (domain-spanning filter): The filter computes the domain average, leading to a constant value for $B$ across the grid, equal to $\\langle \\rho w \\theta \\rangle - \\langle \\rho w \\rangle \\langle \\rho \\theta \\rangle / \\langle \\rho \\rangle$, where $\\langle \\cdot \\rangle$ denotes the domain average.\n\nThe provided Python code implements this complete logic.",
            "answer": "```python\nimport numpy as np\n\ndef apply_3d_filter(field, s_x, s_y, s_z):\n    \"\"\"\n    Applies a 3D separable, periodic, discrete top-hat filter to a field.\n\n    Args:\n        field (np.ndarray): The 3D input field with shape (Nx, Ny, Nz).\n        s_x (int): Filter width in the x-direction (axis 0).\n        s_y (int): Filter width in the y-direction (axis 1).\n        s_z (int): Filter width in the z-direction (axis 2).\n\n    Returns:\n        np.ndarray: The filtered 3D field.\n    \"\"\"\n    filtered_field = field.astype(np.float64, copy=True)\n    \n    # Filter along x-axis (axis 0)\n    if s_x > 1:\n        temp_field = np.zeros_like(filtered_field)\n        start_offset = -int(np.floor(s_x / 2))\n        end_offset = int(np.ceil(s_x / 2))\n        for offset in range(start_offset, end_offset):\n            temp_field += np.roll(filtered_field, -offset, axis=0)\n        filtered_field = temp_field / s_x\n\n    # Filter along y-axis (axis 1)\n    if s_y > 1:\n        temp_field = np.zeros_like(filtered_field)\n        start_offset = -int(np.floor(s_y / 2))\n        end_offset = int(np.ceil(s_y / 2))\n        for offset in range(start_offset, end_offset):\n            temp_field += np.roll(filtered_field, -offset, axis=1)\n        filtered_field = temp_field / s_y\n\n    # Filter along z-axis (axis 2)\n    if s_z > 1:\n        temp_field = np.zeros_like(filtered_field)\n        start_offset = -int(np.floor(s_z / 2))\n        end_offset = int(np.ceil(s_z / 2))\n        for offset in range(start_offset, end_offset):\n            temp_field += np.roll(filtered_field, -offset, axis=2)\n        filtered_field = temp_field / s_z\n        \n    return filtered_field\n\n\ndef process_case(params):\n    \"\"\"\n    Generates fields and computes the domain-mean of B for a single test case.\n    \"\"\"\n    case_num = params['case']\n    Nx, Ny, Nz = params['grid_size']\n    sx, sy, sz = params['filter_width']\n\n    # Generate fields\n    if case_num == 1:\n        rng = np.random.default_rng(params['seed'])\n        rho = rng.uniform(0.8, 1.2, size=(Nx, Ny, Nz))\n        w = rng.uniform(-1.0, 1.0, size=(Nx, Ny, Nz))\n        theta = rng.uniform(290, 310, size=(Nx, Ny, Nz))\n    elif case_num == 2:\n        rho = np.full((Nx, Ny, Nz), 1.2)\n        w = np.full((Nx, Ny, Nz), 0.5)\n        theta = np.full((Nx, Ny, Nz), 300)\n    elif case_num == 3:\n        i = np.arange(Nx).reshape(-1, 1, 1)\n        j = np.arange(Ny).reshape(1, -1, 1)\n        k = np.arange(Nz).reshape(1, 1, -1)\n        alpha_x = 2 * np.pi * i / Nx\n        alpha_y = 2 * np.pi * j / Ny\n        alpha_z = 2 * np.pi * k / Nz\n        rho = 1.0 + 0.1 * np.sin(alpha_x) + 0.05 * np.cos(alpha_z)\n        w = 0.5 * np.sin(alpha_y) + 0.2 * np.cos(alpha_x)\n        theta = 300 + 2.0 * np.cos(alpha_z) + 1.0 * np.sin(alpha_x) * np.sin(alpha_y)\n    elif case_num == 4:\n        rng = np.random.default_rng(params['seed'])\n        rho = rng.uniform(0.9, 1.3, size=(Nx, Ny, Nz))\n        w = rng.uniform(-2.0, 2.0, size=(Nx, Ny, Nz))\n        theta = rng.uniform(285, 305, size=(Nx, Ny, Nz))\n    elif case_num == 5:\n        i, j, k = np.ogrid[0:Nx, 0:Ny, 0:Nz]\n        rho = 1.0 + 0.3 * (j >= 1).astype(float)\n        w = -0.5 + 1.0 * (i >= 1).astype(float)\n        theta = 295.0 + 10.0 * (k >= 1).astype(float)\n\n    # Form composite fields\n    rho_w = rho * w\n    rho_theta = rho * theta\n    rho_w_theta = rho * w * theta\n\n    # Apply spatial filter\n    rho_bar = apply_3d_filter(rho, sx, sy, sz)\n    rho_w_bar = apply_3d_filter(rho_w, sx, sy, sz)\n    rho_theta_bar = apply_3d_filter(rho_theta, sx, sy, sz)\n    rho_w_theta_bar = apply_3d_filter(rho_w_theta, sx, sy, sz)\n\n    # Compute Favre-filtered fields (tilde fields)\n    # rho_bar is guaranteed to be positive for the given test cases.\n    w_tilde = rho_w_bar / rho_bar\n    theta_tilde = rho_theta_bar / rho_bar\n\n    # Compute buoyancy flux anomaly field B\n    B = rho_w_theta_bar - rho_bar * w_tilde * theta_tilde\n    \n    # Return domain mean\n    return np.mean(B)\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        {'case': 1, 'grid_size': (4, 4, 4), 'filter_width': (1, 1, 1), 'seed': 1729},\n        {'case': 2, 'grid_size': (6, 8, 5), 'filter_width': (3, 3, 3)},\n        {'case': 3, 'grid_size': (8, 8, 8), 'filter_width': (3, 1, 5)},\n        {'case': 4, 'grid_size': (5, 7, 6), 'filter_width': (5, 7, 6), 'seed': 2025},\n        {'case': 5, 'grid_size': (3, 3, 3), 'filter_width': (2, 2, 2)},\n    ]\n\n    results = []\n    for params in test_cases:\n        result = process_case(params)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A physically sound model is only useful if it can be integrated forward in time in a numerically stable manner. This final exercise bridges the gap between the physics of the LES model and the practical realities of computational simulation. You will learn to determine the maximum stable timestep, $\\Delta t$, for a simulation by considering both the advective Courant–Friedrichs–Lewy (CFL) limit and the diffusive limit imposed by the SGS model. This calculation  is a critical, everyday task for LES practitioners, as it directly governs the computational cost and feasibility of a simulation.",
            "id": "4058443",
            "problem": "Consider a Large-Eddy Simulation (LES) of a horizontally periodic daytime atmospheric boundary layer under the Boussinesq approximation. The governing equations are the incompressible momentum, heat, and continuity equations with buoyancy expressed through a perturbation potential temperature, and a subgrid-scale (SGS) eddy viscosity closure. The prognostic velocity equations are integrated explicitly in time using a third-order Strong Stability Preserving Runge–Kutta method, and spatial discretization uses a first-order upwind scheme for the linear advection term and a second-order central difference for the Laplacian (diffusion) term. The SGS eddy viscosity is modeled with the Smagorinsky closure,\n$$\n\\nu_{t} \\;=\\; \\left(C_{s}\\,\\Delta\\right)^{2}\\,|S|\n$$,\nwhere $C_{s}$ is the Smagorinsky constant, $\\Delta$ is the filter width defined as the cube root of the cell volume, and $|S|$ is the magnitude of the resolved strain-rate tensor.\n\nYou are tasked with determining the maximum stable time step $\\Delta t$ constrained by the explicit treatment of advection and diffusion for this LES configuration. Assume incompressible flow (no acoustic modes) and neglect any additional gravity-wave stability constraints by considering convectively well-mixed conditions in the daytime boundary layer.\n\nThe numerical and physical setup is as follows:\n- Grid spacings are $\\Delta x = 50\\,\\mathrm{m}$, $\\Delta y = 50\\,\\mathrm{m}$, and $\\Delta z = 20\\,\\mathrm{m}$.\n- The maximum resolved wind components in the domain are $u_{\\max} = 15\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $v_{\\max} = 4\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, and $w_{\\max} = 2\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$.\n- Significant shear is present near the capping inversion; take the dominant vertical shear as $\\left|\\partial u/\\partial z\\right| = 0.015\\,\\mathrm{s}^{-1}$ and assume other strain-rate components are negligible so that $|S| \\approx \\left|\\partial u/\\partial z\\right|$.\n- The Smagorinsky constant is $C_{s} = 0.17$.\n- Molecular viscosity is negligible compared to $\\nu_{t}$ under these conditions and may be ignored in the stability estimate.\n\nStarting from the incompressible Boussinesq equations and the definitions above, perform a stability analysis appropriate for explicit time integration to obtain the advective Courant–Friedrichs–Lewy (CFL) constraint and the explicit diffusion constraint for the discretizations described, combine them, and compute the maximum stable $\\Delta t$ for this scenario. Round your final numerical answer to three significant figures. Express your answer in seconds.",
            "solution": "The problem is deemed valid as it is scientifically grounded in the principles of computational fluid dynamics and numerical analysis, is well-posed with sufficient information for a unique solution, and is expressed in objective, formal language. The provided physical and numerical parameters are realistic for a Large-Eddy Simulation (LES) of the atmospheric boundary layer.\n\nThe objective is to determine the maximum stable time step, $\\Delta t$, for an explicit time integration scheme. The stability of the simulation is limited by two processes: the advection of momentum and heat, and the subgrid-scale (SGS) diffusion of the same quantities. The overall time step constraint is therefore given by the minimum of the advective and diffusive time step limits:\n$$\n\\Delta t \\le \\min(\\Delta t_{\\text{adv}}, \\Delta t_{\\text{diff}})\n$$\nWe will now derive the constraints for each process based on the numerical schemes specified. The stability of an explicit time integration scheme is constrained by the properties of the spatial discretization operators. For the schemes specified—first-order upwind for advection and second-order central difference for diffusion—we analyze the stability based on the canonical limits derived from a von Neumann stability analysis using a simple forward-Euler time step. Although the third-order Strong Stability Preserving Runge–Kutta (SSP-RK3) method possesses a larger stability region than forward-Euler, using these canonical limits provides a robust and standard baseline for determining a stable time step, as is common practice in computational fluid dynamics.\n\nFirst, we determine the advective time step limit, which is governed by the Courant–Friedrichs–Lewy (CFL) condition. For a three-dimensional flow using a first-order upwind scheme for the advection terms, the stability condition is:\n$$\n\\Delta t_{\\text{adv}} \\left( \\frac{|u|}{\\Delta x} + \\frac{|v|}{\\Delta y} + \\frac{|w|}{\\Delta z} \\right) \\le C_{\\text{max, adv}}\n$$\nFor a first-order upwind scheme, the dimensionless Courant number limit is $C_{\\text{max, adv}} = 1$. The most restrictive condition occurs where the velocities are maximal. Therefore, we use $u_{\\max}$, $v_{\\max}$, and $w_{\\max}$:\n$$\n\\Delta t_{\\text{adv}} \\le \\frac{1}{\\frac{u_{\\max}}{\\Delta x} + \\frac{v_{\\max}}{\\Delta y} + \\frac{w_{\\max}}{\\Delta z}}\n$$\nSubstituting the given values:\n$u_{\\max} = 15\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $v_{\\max} = 4\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $w_{\\max} = 2\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$\n$\\Delta x = 50\\,\\mathrm{m}$, $\\Delta y = 50\\,\\mathrm{m}$, $\\Delta z = 20\\,\\mathrm{m}$\n$$\n\\Delta t_{\\text{adv}} \\le \\frac{1}{\\frac{15}{50} + \\frac{4}{50} + \\frac{2}{20}} = \\frac{1}{0.3 + 0.08 + 0.1} = \\frac{1}{0.48}\\,\\mathrm{s}\n$$\n$$\n\\Delta t_{\\text{adv}} \\le 2.08\\overline{3}\\,\\mathrm{s}\n$$\n\nNext, we determine the diffusive time step limit. This constraint arises from the explicit treatment of the viscous diffusion term, which in this LES is dominated by the SGS eddy viscosity, $\\nu_t$. For a diffusion equation discretized using a second-order central difference scheme in space, the three-dimensional stability condition is:\n$$\n\\Delta t_{\\text{diff}} \\le \\frac{C_{\\text{max, diff}}}{\\nu_t \\left( \\frac{1}{(\\Delta x)^2} + \\frac{1}{(\\Delta y)^2} + \\frac{1}{(\\Delta z)^2} \\right)}\n$$\nThe stability limit for this scheme is $C_{\\text{max, diff}} = 0.5$. To use this formula, we must first calculate the SGS eddy viscosity, $\\nu_t$. The problem provides the Smagorinsky model:\n$$\n\\nu_{t} = (C_{s}\\,\\Delta)^{2}\\,|S|\n$$\nwhere $C_{s} = 0.17$ and $|S| \\approx |\\partial u/\\partial z| = 0.015\\,\\mathrm{s}^{-1}$. The filter width $\\Delta$ is the cube root of the grid cell volume:\n$$\n\\Delta = (\\Delta x \\Delta y \\Delta z)^{1/3} = (50 \\times 50 \\times 20)^{1/3} = (50000)^{1/3}\\,\\mathrm{m}\n$$\nNow we can compute $\\nu_t$:\n$$\n\\nu_t = (0.17)^{2} \\times ((50000)^{1/3})^{2} \\times 0.015 = 0.0289 \\times (50000)^{2/3} \\times 0.015\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}\n$$\n$$\n(50000)^{2/3} \\approx 1357.21\\,\\mathrm{m}^2\n$$\n$$\n\\nu_t \\approx 0.0289 \\times 1357.21 \\times 0.015 \\approx 0.5883\\,\\mathrm{m}^2\\,\\mathrm{s}^{-1}\n$$\nNow we compute the geometric part of the diffusion constraint:\n$$\n\\frac{1}{(\\Delta x)^2} + \\frac{1}{(\\Delta y)^2} + \\frac{1}{(\\Delta z)^2} = \\frac{1}{50^2} + \\frac{1}{50^2} + \\frac{1}{20^2} = \\frac{1}{2500} + \\frac{1}{2500} + \\frac{1}{400}\n$$\n$$\n= 0.0004 + 0.0004 + 0.0025 = 0.0033\\,\\mathrm{m}^{-2}\n$$\nSubstituting these values back into the diffusive time step constraint equation:\n$$\n\\Delta t_{\\text{diff}} \\le \\frac{0.5}{0.5883 \\times 0.0033} \\approx \\frac{0.5}{0.001941} \\approx 257.5\\,\\mathrm{s}\n$$\n\nFinally, we find the maximum stable time step for the entire system by taking the minimum of the advective and diffusive limits:\n$$\n\\Delta t_{\\max} = \\min(\\Delta t_{\\text{adv}}, \\Delta t_{\\text{diff}}) = \\min(2.08\\overline{3}\\,\\mathrm{s}, 257.5\\,\\mathrm{s})\n$$\nThe advective CFL condition is clearly the more restrictive constraint.\n$$\n\\Delta t_{\\max} = 2.08\\overline{3}\\,\\mathrm{s}\n$$\nThe problem requires the answer to be rounded to three significant figures.\n$$\n\\Delta t_{\\max} \\approx 2.08\\,\\mathrm{s}\n$$",
            "answer": "$$\\boxed{2.08}$$"
        }
    ]
}