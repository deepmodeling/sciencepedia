{
    "hands_on_practices": [
        {
            "introduction": "本节的第一个实践将带你回到概念气候科学的基石——简化的能量平衡模型。通过一个双箱模型，我们将探索气候系统在不同时间尺度上的响应，区分快速的瞬态气候响应（$TCR$）和长期的平衡气候敏感度（$ECS$）。这个练习旨在让你亲手计算并理解海洋热吸收等物理过程如何导致这两个关键指标的差异，从而建立起对涌现约束为何必要的物理直觉 。",
            "id": "4035774",
            "problem": "考虑一个全球平均的双箱能量平衡模型来表示气候系统，其中上层箱代表大气-海洋混合层，下层箱代表深海。上层箱的全球平均温度异常 $T_{u}(t)$ 和深海的全球平均温度异常 $T_{d}(t)$ 的演变由能量守恒定律决定：\n$$\nC_{u}\\,\\frac{d T_{u}}{dt} \\;=\\; F(t) \\;-\\; \\lambda\\,T_{u}(t) \\;-\\; \\gamma\\,\\big(T_{u}(t) - T_{d}(t)\\big),\n$$\n$$\nC_{d}\\,\\frac{d T_{d}}{dt} \\;=\\; \\gamma\\,\\big(T_{u}(t) - T_{d}(t)\\big),\n$$\n其中 $C_{u}$ 和 $C_{d}$ 分别是上层和深海箱的有效热容，$F(t)$ 是外部施加的辐射强迫，$\\lambda$ 是净气候反馈参数（对于稳定反馈为正值），$\\gamma$ 是两箱之间的有效热交换系数。将大气层顶的净向下能量不平衡定义为 $N(t) \\equiv F(t) - \\lambda\\,T_{u}(t)$，并将海洋吸热效率定义为 $\\kappa$，这是瞬态响应的一个涌现特性，使得在数十年尺度上，随着辐射强迫的增加，$N(t)$ 与 $T_{u}(t)$ 近似成正比，即 $N(t) \\approx \\kappa\\,T_{u}(t)$。\n\n假设一个理想化的情景，大气二氧化碳浓度以每年 $1\\%$ 的速率指数增长，使得辐射强迫随时间单调增加，直到二氧化碳浓度加倍。设 $F_{2\\times\\mathrm{CO_{2}}}$ 表示二氧化碳加倍时的辐射强迫，并将平衡气候敏感度定义为 $\\mathrm{ECS} \\equiv T_{\\mathrm{eq}}$，满足平衡关系 $0 = F_{2\\times\\mathrm{CO_{2}}} - \\lambda\\,T_{\\mathrm{eq}}$。将瞬态气候响应定义为在上述瞬态情景下，二氧化碳加倍时刻 $t_{2}$ 时的 $T_{u}(t_{2})$，即 $\\mathrm{TCR} \\equiv T_{u}(t_{2})$。\n\n仅使用控制平衡方程、$N(t)$ 的定义以及在瞬态期间成立的涌现正比关系 $N(t) \\approx \\kappa\\,T_{u}(t)$，推导用 $F_{2\\times\\mathrm{CO_{2}}}$、$\\lambda$ 和 $\\kappa$ 表示 $\\mathrm{TCR}$ 的表达式，以及用 $F_{2\\times\\mathrm{CO_{2}}}$ 和 $\\lambda$ 表示 $\\mathrm{ECS}$ 的表达式。然后，使用假设但科学上合理的参数值 $F_{2\\times\\mathrm{CO_{2}}} = 3.70\\,\\mathrm{W\\,m^{-2}}}$，$\\lambda = 1.30\\,\\mathrm{W\\,m^{-2}\\,K^{-1}}}$ 和 $\\kappa = 0.70\\,\\mathrm{W\\,m^{-2}\\,K^{-1}}}$，计算无量纲比率\n$$\nR \\equiv \\frac{\\mathrm{TCR}}{\\mathrm{ECS}}\n$$\n作为时间尺度效应的定量度量。\n\n将 $R$ 的最终答案四舍五入到四位有效数字。将最终答案表示为没有单位的纯数。",
            "solution": "该问题要求推导平衡气候敏感度（$\\mathrm{ECS}$）和瞬态气候响应（$\\mathrm{TCR}$）的表达式，然后计算它们的比率 $R$。\n\n首先，我们推导 $\\mathrm{ECS}$ 的表达式。$\\mathrm{ECS}$ 被定义为响应持续辐射强迫 $F_{2\\times\\mathrm{CO_{2}}}$ 时的平衡温度异常 $T_{\\mathrm{eq}}$。在平衡状态下，所有时间导数均为零，即 $\\frac{dT_u}{dt} = 0$ 和 $\\frac{dT_d}{dt} = 0$。第二个控制方程 $C_{d}\\,\\frac{d T_{d}}{dt} = \\gamma\\,\\big(T_{u}(t) - T_{d}(t)\\big)$ 意味着在平衡时，$T_{u} - T_{d} = 0$，所以 $T_u = T_d = T_{\\mathrm{eq}}$。将这些条件代入第一个控制方程得到：\n$$\nC_{u} \\cdot 0 = F_{2\\times\\mathrm{CO_{2}}} - \\lambda\\,T_{\\mathrm{eq}} - \\gamma\\,\\big(T_{\\mathrm{eq}} - T_{\\mathrm{eq}}\\big)\n$$\n$$\n0 = F_{2\\times\\mathrm{CO_{2}}} - \\lambda\\,T_{\\mathrm{eq}}\n$$\n这与问题陈述中提供的平衡关系一致。$\\mathrm{ECS}$ 定义为 $\\mathrm{ECS} \\equiv T_{\\mathrm{eq}}$。解出 $T_{\\mathrm{eq}}$ 得到 $\\mathrm{ECS}$ 的表达式：\n$$\n\\mathrm{ECS} = \\frac{F_{2\\times\\mathrm{CO_{2}}}}{\\lambda}\n$$\n\n接下来，我们推导 $\\mathrm{TCR}$ 的表达式。$\\mathrm{TCR}$ 定义为 $\\mathrm{CO_2}$ 加倍时刻的上层箱温度异常，即 $\\mathrm{TCR} \\equiv T_{u}(t_{2})$。在这个特定时刻，辐射强迫为 $F(t_2) = F_{2\\times\\mathrm{CO_{2}}}$。问题陈述指出，在瞬态增温情景中，大气层顶的净向下能量不平衡 $N(t)$ 与上层箱温度异常 $T_u(t)$ 近似成正比，关系为 $N(t) \\approx \\kappa\\,T_{u}(t)$。问题还提供了能量不平衡的物理定义：$N(t) \\equiv F(t) - \\lambda\\,T_{u}(t)$。\n\n通过在加倍时刻 $t_2$ 令这两个 $N(t)$ 的表达式相等，我们可以建立一个瞬态关系。我们将按照问题设定的指示（“使用...涌现正比关系”），将该近似视为等式。\n$$\n\\kappa\\,T_{u}(t_{2}) = F(t_{2}) - \\lambda\\,T_{u}(t_{2})\n$$\n将定义 $\\mathrm{TCR} \\equiv T_{u}(t_{2})$ 和 $F(t_{2}) = F_{2\\times\\mathrm{CO_{2}}}$ 代入此方程：\n$$\n\\kappa\\,\\mathrm{TCR} = F_{2\\times\\mathrm{CO_{2}}} - \\lambda\\,\\mathrm{TCR}\n$$\n现在我们可以重新整理这个代数方程来解出 $\\mathrm{TCR}$：\n$$\n\\kappa\\,\\mathrm{TCR} + \\lambda\\,\\mathrm{TCR} = F_{2\\times\\mathrm{CO_{2}}}\n$$\n$$\n(\\lambda + \\kappa)\\,\\mathrm{TCR} = F_{2\\times\\mathrm{CO_{2}}}\n$$\n这就得出了用指定参数表示的 $\\mathrm{TCR}$ 表达式：\n$$\n\\mathrm{TCR} = \\frac{F_{2\\times\\mathrm{CO_{2}}}}{\\lambda + \\kappa}\n$$\n\n最后，我们被要求计算无量纲比率 $R \\equiv \\frac{\\mathrm{TCR}}{\\mathrm{ECS}}$。使用上面推导出的表达式：\n$$\nR = \\frac{\\mathrm{TCR}}{\\mathrm{ECS}} = \\frac{\\left( \\frac{F_{2\\times\\mathrm{CO_{2}}}}{\\lambda + \\kappa} \\right)}{\\left( \\frac{F_{2\\times\\mathrm{CO_{2}}}}{\\lambda} \\right)}\n$$\n项 $F_{2\\times\\mathrm{CO_{2}}}$ 从分子和分母中消去，得到比率 $R$ 的简化符号表达式：\n$$\nR = \\frac{\\lambda}{\\lambda + \\kappa}\n$$\n这个表达式表明，瞬态响应与平衡响应的比率取决于气候反馈参数与反馈参数和海洋吸热效率之和的比率。由于 $\\kappa > 0$，因此 $R  1$，这在物理上是预期的，因为海洋吸热会延迟地表变暖。\n\n现在，我们代入给定的数值来计算 $R$ 的值：\n$\\lambda = 1.30\\,\\mathrm{W\\,m^{-2}\\,K^{-1}}$\n$\\kappa = 0.70\\,\\mathrm{W\\,m^{-2}\\,K^{-1}}$\n\n$$\nR = \\frac{1.30}{1.30 + 0.70} = \\frac{1.30}{2.00} = 0.65\n$$\n问题要求最终答案四舍五入到四位有效数字。因此，我们将结果表示为：\n$$\nR = 0.6500\n$$",
            "answer": "$$\\boxed{0.6500}$$"
        },
        {
            "introduction": "在建立了物理直觉后，我们进入涌现约束的统计核心。本练习将引导你运用贝叶斯统计的威力，在一个标准的线性高斯框架下，推导平衡气候敏感度（$ECS$）的后验分布。你将学习如何将模式集合提供的事前信息与带有自身不确定性的观测数据相结合，从而得到一个被约束的、不确定性更小的估计值，这正是涌现约束方法的精髓所在 。",
            "id": "4035788",
            "problem": "考虑气候建模中的一个涌现约束框架，其中平衡气候敏感度（ECS），记为 $Y$，以及一个变率或反馈强度的候选预测因子，记为潜在真实预测因子 $X^{\\ast}$，在一个模式集合中联合分布。假设如下：\n\n- 对 $(X^{\\ast}, Y)$ 服从联合高斯分布，其均值向量为 $\\left(\\mu_{X}, \\mu_{Y}\\right)$，协方差矩阵为\n$$\n\\begin{pmatrix}\n\\sigma_{X}^{2}  r\\,\\sigma_{X}\\sigma_{Y} \\\\\nr\\,\\sigma_{X}\\sigma_{Y}  \\sigma_{Y}^{2}\n\\end{pmatrix},\n$$\n其中 $r$ 是 $X^{\\ast}$ 和 $Y$ 之间的集合相关性，$\\sigma_{X}^{2}$ 是 $X^{\\ast}$ 的集合方差，$\\sigma_{Y}^{2}$ 是 $Y$ 的集合方差。\n\n- 预测因子的观测估计值 $X_{o}$ 由一个带有加性误差的线性测量模型给出，\n$$\nX_{o} \\;=\\; X^{\\ast} \\,+\\, \\eta,\n$$\n其中 $\\eta \\sim \\mathcal{N}(0, \\sigma_{\\eta}^{2})$ 是高斯测量误差，独立于 $X^{\\ast}$ 和 $Y$。\n\n假设 $\\mu_{X}$、$\\mu_{Y}$、$\\sigma_{X}^{2}$、$\\sigma_{Y}^{2}$、$r$ 和 $\\sigma_{\\eta}^{2}$ 是表征模式集合和观测系统的已知常数，且 $X_{o}$ 是一个单个观测值。\n\n从协方差、相关性的定义以及联合高斯随机变量在线性变换下的性质出发，推导后验均值 $\\mathbb{E}[Y \\mid X_{o}]$ 和后验方差 $\\operatorname{Var}(Y \\mid X_{o})$，使其成为 $r, \\sigma_{X}^{2}, \\sigma_{Y}^{2}, \\mu_{X}, \\mu_{Y}, \\sigma_{\\eta}^{2}$ 和 $X_{o}$ 的解析函数。将后验均值以开尔文表示，后验方差以开尔文的平方表示。最终答案必须是一个单一的闭式表达式，将后验均值和方差一同以行矩阵的形式列出。",
            "solution": "我们的目标是推导后验均值 $\\mathbb{E}[Y \\mid X_{o}]$ 和后验方差 $\\operatorname{Var}(Y \\mid X_{o})$。根据问题设定，随机变量 $(X^{\\ast}, Y, \\eta)$ 均为高斯分布。由于 $X_o = X^\\ast + \\eta$ 是高斯变量的线性组合，因此 $(Y, X_{o})$ 也服从联合高斯分布。因此，$Y$ 给定 $X_{o}$ 的条件分布也是高斯分布，我们只需要求出其均值和方差。\n\n首先，我们确定 $(Y, X_{o})$ 联合分布的参数。这是一个由其均值向量和协方差矩阵表征的二元正态分布。\n\n均值向量为 $\\boldsymbol{\\mu} = (\\mathbb{E}[Y], \\mathbb{E}[X_{o}])^{T}$。其分量为：\n1.  $\\mathbb{E}[Y] = \\mu_{Y}$ (已知)。\n2.  $\\mathbb{E}[X_{o}] = \\mathbb{E}[X^{\\ast} + \\eta] = \\mathbb{E}[X^{\\ast}] + \\mathbb{E}[\\eta] = \\mu_{X} + 0 = \\mu_{X}$。\n\n所以，均值向量为 $\\begin{pmatrix} \\mu_{Y} \\\\ \\mu_{X} \\end{pmatrix}$。\n\n协方差矩阵为 $\\mathbf{\\Sigma} = \\begin{pmatrix} \\operatorname{Var}(Y)  \\operatorname{Cov}(Y, X_{o}) \\\\ \\operatorname{Cov}(Y, X_{o})  \\operatorname{Var}(X_{o}) \\end{pmatrix}$。其分量为：\n1.  $\\operatorname{Var}(Y) = \\sigma_{Y}^{2}$ (已知)。\n2.  $\\operatorname{Var}(X_{o}) = \\operatorname{Var}(X^{\\ast} + \\eta)$。由于 $X^{\\ast}$ 和 $\\eta$ 独立，$\\operatorname{Var}(X_{o}) = \\operatorname{Var}(X^{\\ast}) + \\operatorname{Var}(\\eta) = \\sigma_{X}^{2} + \\sigma_{\\eta}^{2}$。\n3.  $\\operatorname{Cov}(Y, X_{o}) = \\operatorname{Cov}(Y, X^{\\ast} + \\eta) = \\operatorname{Cov}(Y, X^{\\ast}) + \\operatorname{Cov}(Y, \\eta)$。由于 $Y$ 和 $\\eta$ 独立，$\\operatorname{Cov}(Y, \\eta) = 0$。因此，$\\operatorname{Cov}(Y, X_{o}) = \\operatorname{Cov}(Y, X^{\\ast}) = r\\sigma_{X}\\sigma_{Y}$ (已知)。\n\n因此，$(Y, X_{o})$ 的联合分布是一个二元正态分布，其均值向量为 $\\begin{pmatrix} \\mu_{Y} \\\\ \\mu_{X} \\end{pmatrix}$，协方差矩阵为：\n$$\n\\mathbf{\\Sigma} = \\begin{pmatrix}\n\\sigma_{Y}^{2}  r\\sigma_{X}\\sigma_{Y} \\\\\nr\\sigma_{X}\\sigma_{Y}  \\sigma_{X}^{2} + \\sigma_{\\eta}^{2}\n\\end{pmatrix}.\n$$\n\n现在我们使用联合高斯变量条件分布的标准公式。如果 $(V_{1}, V_{2})$ 服从均值为 $(\\mu_{1}, \\mu_{2})$、协方差矩阵为 $\\begin{pmatrix} \\Sigma_{11}  \\Sigma_{12} \\\\ \\Sigma_{21}  \\Sigma_{22} \\end{pmatrix}$ 的联合高斯分布，则给定 $V_{2} = v_{2}$ 时，$V_{1}$ 的条件分布是高斯分布，其均值和方差为：\n-   条件均值：$\\mathbb{E}[V_{1} \\mid V_{2}=v_{2}] = \\mu_{1} + \\Sigma_{12}\\Sigma_{22}^{-1}(v_{2} - \\mu_{2})$\n-   条件方差：$\\operatorname{Var}(V_{1} \\mid V_{2}=v_{2}) = \\Sigma_{11} - \\Sigma_{12}\\Sigma_{22}^{-1}\\Sigma_{21}$\n\n将我们的变量代入公式 ($V_{1} \\to Y, V_{2} \\to X_{o}$)，我们得到后验均值 $\\mathbb{E}[Y \\mid X_{o}]$ 为：\n$$\n\\mathbb{E}[Y \\mid X_{o}] = \\mu_{Y} + (r\\sigma_{X}\\sigma_{Y})(\\sigma_{X}^{2} + \\sigma_{\\eta}^{2})^{-1}(X_{o} - \\mu_{X}) = \\mu_{Y} + \\frac{r\\sigma_{X}\\sigma_{Y}}{\\sigma_{X}^{2} + \\sigma_{\\eta}^{2}}(X_{o} - \\mu_{X}).\n$$\n这个表达式的单位是开尔文，与物理意义相符。\n\n后验方差 $\\operatorname{Var}(Y \\mid X_{o})$ 为：\n$$\n\\operatorname{Var}(Y \\mid X_{o}) = \\sigma_{Y}^{2} - (r\\sigma_{X}\\sigma_{Y})(\\sigma_{X}^{2} + \\sigma_{\\eta}^{2})^{-1}(r\\sigma_{X}\\sigma_{Y}) = \\sigma_{Y}^{2} - \\frac{r^{2}\\sigma_{X}^{2}\\sigma_{Y}^{2}}{\\sigma_{X}^{2} + \\sigma_{\\eta}^{2}}\n$$\n提出因子 $\\sigma_{Y}^{2}$：\n$$\n\\operatorname{Var}(Y \\mid X_{o}) = \\sigma_{Y}^{2} \\left( 1 - \\frac{r^{2}\\sigma_{X}^{2}}{\\sigma_{X}^{2} + \\sigma_{\\eta}^{2}} \\right).\n$$\n这个表达式表示了在观测到 $X_o$ 后 $Y$ 的方差减少量，其单位是开尔文的平方，与物理意义相符。这两个量共同构成了最终答案。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\mu_{Y} + \\frac{r\\sigma_{X}\\sigma_{Y}}{\\sigma_{X}^{2} + \\sigma_{\\eta}^{2}}(X_{o} - \\mu_{X})  \\sigma_{Y}^{2} \\left( 1 - \\frac{r^{2}\\sigma_{X}^{2}}{\\sigma_{X}^{2} + \\sigma_{\\eta}^{2}} \\right) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "现实世界远比线性模型复杂，因此，一项高级但至关重要的技能是评估和选择最能描述数据的模型。这项实践将指导你使用前沿的贝叶斯模型比较方法，来判断一个预报因子与 $ECS$ 之间的关系是线性的，还是更复杂的非线性形式。通过实现和对比线性模型、分段线性模型以及强大的高斯过程模型，你将掌握构建更稳健、物理上更合理的涌现约束的先进技术 。",
            "id": "4035758",
            "problem": "您的任务是实现贝叶斯模型比较，用于气候敏感性的涌现约束。涌现约束利用基于物理学的模型间关系来约束平衡气候敏感性（ECS）。平衡气候敏感性（ECS）的定义是，在大气二氧化碳浓度加倍后，全球平均近地表气温的平衡变化量，单位为开尔文。在本问题中，可观测预测变量 $X$ 是一个无量纲的模型间比较指标，理论表明它与 $\\mathrm{ECS}$ 之间存在单调但可能非线性的映射关系。\n\n从以下基础出发：\n\n- 平衡状态下的全球能量平衡意味着全球平均地表温度的变化量 $\\,\\Delta T\\,$ 与有效辐射强迫 $\\,\\Delta F\\,$ 和净气候反馈 $\\,\\lambda\\,$ 之间的关系为 $\\,\\lambda \\Delta T = \\Delta F\\,$。二氧化碳加倍情况下的平衡气候敏感性（ECS）满足 $\\,\\Delta T_{2\\times \\mathrm{CO}_2} = \\mathrm{ECS} = \\Delta F_{2\\times \\mathrm{CO}_2}/\\lambda\\,$，其中 $\\,\\Delta F_{2\\times \\mathrm{CO}_2}\\,$ 是一个已知的恒定强迫。理论表明，由于云和环流模态的变化，$\\,X\\,$ 与 $\\,\\lambda\\,$ 以非线性方式相关，因此 $\\,X\\,$ 可以作为 $\\,\\mathrm{ECS}\\,$ 的一个涌现预测变量。\n- 我们假设观测数据对 $\\,\\{(x_i, y_i)\\}_{i=1}^n\\,$ 由 $\\,y_i = g(x_i) + \\epsilon_i\\,$ 生成，其中 $\\,y_i\\,$ 是以开尔文（K）为单位的 $\\mathrm{ECS}$，$\\,x_i\\,$ 是无量纲的，$\\,g(\\cdot)\\,$ 是一个未知的确定性映射，而 $\\,\\epsilon_i \\sim \\mathcal{N}(0,\\sigma_y^2)\\,$ 是具有已知方差 $\\,\\sigma_y^2\\,$ 的独立观测误差。\n- 贝叶斯模型比较通过候选模型 $\\,\\mathcal{M}\\,$ 的后验概率 $\\,p(\\mathcal{M}\\mid \\mathbf{y},\\mathbf{x}) \\propto p(\\mathbf{y}\\mid \\mathbf{x},\\mathcal{M})\\,p(\\mathcal{M})\\,$ 对其进行排序，其中 $\\,p(\\mathbf{y}\\mid \\mathbf{x},\\mathcal{M})\\,$ 是边际似然（模型证据）。我们对模型采用均匀先验，因此排序简化为比较模型证据。\n\n您必须实现三个候选映射 $\\,\\mathcal{M}_0\\,$, $\\,\\mathcal{M}_1\\,$ 和 $\\,\\mathcal{M}_2\\,$：\n\n- $\\,\\mathcal{M}_0\\,$（线性回归）：$\\,y = \\alpha + \\beta x + \\epsilon\\,$，权重 $\\,(\\alpha,\\beta)\\,$ 服从零均值高斯先验，具体为 $\\,(\\alpha,\\beta)^\\top \\sim \\mathcal{N}\\!\\left(\\mathbf{0},\\,\\tau^2 \\mathbf{I}\\right)\\,$，且 $\\,\\epsilon \\sim \\mathcal{N}(0,\\sigma_y^2)\\,$。\n- $\\,\\mathcal{M}_1\\,$（具有单个铰链点的连续分段线性回归）：$\\,y = a + b x + h\\,\\max(0, x - c) + \\epsilon\\,$，其中 $\\,c\\,$ 是一个未知的断点。在给定 $\\,c\\,$ 的条件下，参数 $\\,\\mathbf{w}=(a,b,h)^\\top\\,$ 服从零均值高斯先验 $\\,\\mathbf{w} \\sim \\mathcal{N}\\!\\left(\\mathbf{0},\\,\\tau^2 \\mathbf{I}\\right)\\,$，且 $\\,\\epsilon \\sim \\mathcal{N}(0,\\sigma_y^2)\\,$。在指定的网格上为 $\\,c\\,$ 设置离散均匀先验。\n- $\\,\\mathcal{M}_2\\,$（高斯过程（GP）回归）：$\\,y = f(x) + \\epsilon\\,$，其中 $\\,f(\\cdot)\\,$ 是一个零均值高斯过程，其协方差为 $\\,k(x,x') = \\sigma_f^2 \\exp\\!\\left(-\\frac{(x-x')^2}{2\\ell^2}\\right)\\,$，且 $\\,\\epsilon \\sim \\mathcal{N}(0,\\sigma_y^2)\\,$。在指定的网格上为超参数 $\\,(\\sigma_f,\\ell)\\,$ 设置离散均匀先验。\n\n对于每个候选模型，当高斯参数共轭时，通过解析地将其积分掉来计算模型证据 $\\,p(\\mathbf{y}\\mid \\mathbf{x},\\mathcal{M}_j)\\,$，并在需要时通过在离散超参数网格上求和来计算。对于线性和分段线性模型，使用精确的高斯恒等式：如果 $\\,\\mathbf{y}\\mid \\mathbf{w} \\sim \\mathcal{N}(\\Phi\\mathbf{w},\\sigma_y^2 \\mathbf{I})\\,$ 且 $\\,\\mathbf{w}\\sim \\mathcal{N}(\\mathbf{0},\\tau^2 \\mathbf{I})\\,$，则 $\\,\\mathbf{y}\\sim \\mathcal{N}\\!\\left(\\mathbf{0},\\,\\sigma_y^2 \\mathbf{I} + \\tau^2 \\Phi \\Phi^\\top\\right)\\,$，因此边际似然是一个协方差为 $\\,\\sigma_y^2 \\mathbf{I} + \\tau^2 \\Phi \\Phi^\\top\\,$ 的多元正态密度。对于高斯过程模型，使用指定核函数下的标准对数边际似然，并使用 log-sum-exp 稳定化方法在超参数网格上求和，以形成具有均匀超参数先验的证据。\n\n测试套件规范：\n\n您将生成四个合成数据集，代表 $\\,X\\,$ 和 $\\,\\mathrm{ECS}\\,$ 之间可能的涌现关系。对于每种情况，独立地从 $\\,\\mathrm{Uniform}(0,1)\\,$ 分布中抽取 $\\,x_i\\,$，并计算 $\\,y_i = g(x_i) + \\epsilon_i\\,$，其中 $\\,\\epsilon_i \\sim \\mathcal{N}(0,\\sigma_y^2)\\,$。使用以下情况，其中包含 $\\,n\\,$ 个样本、以开尔文为单位的高斯噪声标准差 $\\,\\sigma_y\\,$ 和映射 $\\,g(x)\\,$：\n\n- 情况 $\\,1\\,$（带拐点的分段线性，理论上预示的模态转换）：$\\,n=30\\,$, $\\,\\sigma_y=0.20\\,\\mathrm{K}\\,$, $\\,g(x) = a + b x + h\\,\\max(0, x - c)\\,$，其中 $\\,a=2.0\\,\\mathrm{K}\\,$, $\\,b=1.0\\,\\mathrm{K}\\,$, $\\,h=1.0\\,\\mathrm{K}\\,$, $\\,c=0.5\\,$。\n- 情况 $\\,2\\,$（平滑饱和非线性）：$\\,n=30\\,$, $\\,\\sigma_y=0.25\\,\\mathrm{K}\\,$, $\\,g(x) = \\mu + A\\,\\tanh\\!\\left(\\dfrac{x - x_0}{s}\\right)\\,$，其中 $\\,\\mu=3.5\\,\\mathrm{K}\\,$, $\\,A=1.5\\,\\mathrm{K}\\,$, $\\,x_0=0.4\\,$, $\\,s=0.2\\,$。\n- 情况 $\\,3\\,$（严格线性）：$\\,n=25\\,$, $\\,\\sigma_y=0.20\\,\\mathrm{K}\\,$, $\\,g(x) = a + b x\\,$，其中 $\\,a=2.0\\,\\mathrm{K}\\,$, $\\,b=3.0\\,\\mathrm{K}\\,$。\n- 情况 $\\,4\\,$（高噪声带拐点的分段线性边缘情况）：$\\,n=15\\,$, $\\,\\sigma_y=1.00\\,\\mathrm{K}\\,$, $\\,g(x) = a + b x + h\\,\\max(0, x - c)\\,$，其中 $\\,a=2.0\\,\\mathrm{K}\\,$, $\\,b=1.0\\,\\mathrm{K}\\,$, $\\,h=1.0\\,\\mathrm{K}\\,$, $\\,c=0.5\\,$。\n\n为保证可复现性，使用独立的随机种子：情况 $\\,1\\,$ 种子 $\\,123\\,$，情况 $\\,2\\,$ 种子 $\\,456\\,$，情况 $\\,3\\,$ 种子 $\\,789\\,$，情况 $\\,4\\,$ 种子 $\\,321\\,$。\n\n适用于所有情况的贝叶斯设置：\n\n- 所有线性高斯权重的权重先验方差为 $\\,\\tau^2 = 10.0\\,\\mathrm{K}^2\\,$。\n- 模型 $\\,\\mathcal{M}_1\\,$ 的断点网格：$\\,c \\in \\{0.3,\\,0.5,\\,0.7\\}\\,$，服从离散均匀先验。\n- 模型 $\\,\\mathcal{M}_2\\,$ 的高斯过程超参数网格：$\\,\\sigma_f \\in \\{0.5\\,\\mathrm{K},\\,1.0\\,\\mathrm{K},\\,2.0\\,\\mathrm{K}\\}\\,$ 且 $\\,\\ell \\in \\{0.15,\\,0.30,\\,0.60\\}\\,$，在笛卡尔积上服从离散均匀先验。\n\n您的程序必须：\n\n- 对于每种情况，按规定生成 $\\,\\{(x_i,y_i)\\}_{i=1}^n\\,$。\n- 使用上述方法计算 $\\,j\\in\\{0,1,2\\}\\,$ 的模型证据 $\\,p(\\mathbf{y}\\mid \\mathbf{x},\\mathcal{M}_j)\\,$，在适当之处通过 Cholesky 分解对对数行列式进行数值稳定，并使用 log-sum-exp。\n- 通过在均匀模型先验下最大化后验模型概率来选择最可能的映射。将所选模型编码为整数：线性模型 $\\,\\mathcal{M}_0\\,$ 为 $\\,0\\,$，分段线性模型 $\\,\\mathcal{M}_1\\,$ 为 $\\,1\\,$，高斯过程模型 $\\,\\mathcal{M}_2\\,$ 为 $\\,2\\,$。\n\n最终输出格式：\n\n您的程序应生成单行输出，其中包含一个含四个整数的列表，按 $\\,1,2,3,4\\,$ 的顺序对应每种情况，代表每种情况下所选的模型索引 $\\,\\{0,1,2\\}\\,$。格式必须是方括号内以逗号分隔的列表，例如 $\\,\\left[0,1,2,1\\right]\\,$。输出中不需要单位，因为它仅编码模型索引。",
            "solution": "任务是为三个候选模型执行贝叶斯模型比较，这些模型描述了无量纲预测变量 $x$ 与以开尔文（K）表示的平衡气候敏感性（ECS）$y$ 之间的关系。比较将在四个合成生成的数据集上进行。选择后验概率最高的模型。鉴于模型服从均匀先验概率，这等同于选择具有最高模型证据或边际似然 $p(\\mathbf{y}\\mid \\mathbf{x},\\mathcal{M})$ 的模型。\n\n问题的核心在于计算三个模型中每一个的对数边际似然：线性模型（$\\mathcal{M}_0$）、连续分段线性模型（$\\mathcal{M}_1$）和高斯过程模型（$\\mathcal{M}_2$）。\n\n对于形式为 $\\mathbf{y} = \\Phi\\mathbf{w} + \\boldsymbol{\\epsilon}$ 的通用参数线性模型，其中 $\\mathbf{y}$ 是观测值的 $n \\times 1$ 向量，$\\Phi$ 是 $n \\times p$ 的设计矩阵，$\\mathbf{w}$ 是权重的 $p \\times 1$ 向量，$\\boldsymbol{\\epsilon}$ 是噪声向量，贝叶斯设置如下：\n似然为 $p(\\mathbf{y} \\mid \\mathbf{w}) = \\mathcal{N}(\\mathbf{y} \\mid \\Phi\\mathbf{w}, \\sigma_y^2 \\mathbf{I}_n)$。\n权重的先验为 $p(\\mathbf{w}) = \\mathcal{N}(\\mathbf{w} \\mid \\mathbf{0}, \\tau^2 \\mathbf{I}_p)$。\n\n边际似然通过对权重进行积分得到：\n$$p(\\mathbf{y} \\mid \\Phi) = \\int p(\\mathbf{y} \\mid \\mathbf{w}) p(\\mathbf{w}) d\\mathbf{w}$$\n因为似然和先验都是高斯分布，所以该积分是可解的，并得到 $\\mathbf{y}$ 的多元高斯分布：\n$$\\mathbf{y} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{K})$$\n其中协方差矩阵 $\\mathbf{K}$ 由 $\\mathbf{K} = \\sigma_y^2 \\mathbf{I}_n + \\tau^2 \\Phi \\Phi^\\top$ 给出。\n对数边际似然（对数证据）则为：\n$$\\log p(\\mathbf{y} \\mid \\Phi) = -\\frac{1}{2} \\left( \\mathbf{y}^\\top \\mathbf{K}^{-1} \\mathbf{y} + \\log \\det(\\mathbf{K}) + n \\log(2\\pi) \\right)$$\n为了数值稳定性，项 $\\log \\det(\\mathbf{K})$ 计算为 $2 \\sum_i \\log(L_{ii})$，其中 $\\mathbf{L}$ 是 $\\mathbf{K}$ 的 Cholesky 因子（即 $\\mathbf{K} = \\mathbf{L}\\mathbf{L}^\\top$）。二次型 $\\mathbf{y}^\\top \\mathbf{K}^{-1} \\mathbf{y}$ 的计算方法是：首先求解 $\\mathbf{L}\\mathbf{z} = \\mathbf{y}$ 得到 $\\mathbf{z}$，然后计算 $\\mathbf{z}^\\top\\mathbf{z}$。\n\n**模型 $\\mathcal{M}_0$：线性回归**\n模型为 $y_i = \\alpha + \\beta x_i + \\epsilon_i$。权重为 $\\mathbf{w} = [\\alpha, \\beta]^\\top$。设计矩阵 $\\Phi_0$ 是一个 $n \\times 2$ 的矩阵，其第 $i$ 行为 $[1, x_i]$。\n$\\mathcal{M}_0$ 的对数证据使用上述公式直接计算，其中 $\\Phi = \\Phi_0$，$\\tau^2=10.0$，以及特定情况下的 $\\sigma_y^2$。\n\n**模型 $\\mathcal{M}_1$：分段线性回归**\n模型为 $y_i = a + b x_i + h \\max(0, x_i - c) + \\epsilon_i$。该模型的参数取决于断点 $c$。对于一个固定的 $c$ 值，该模型在权重 $\\mathbf{w} = [a, b, h]^\\top$ 上是线性的。设计矩阵 $\\Phi_c$ 是一个 $n \\times 3$ 的矩阵，其第 $i$ 行由 $[1, x_i, \\max(0, x_i - c)]$ 给出。\n问题指定了在网格 $\\mathcal{C} = \\{0.3, 0.5, 0.7\\}$ 上对 $c$ 使用离散均匀先验。总模型证据通过对 $c$ 进行边缘化得到：\n$$p(\\mathbf{y} \\mid \\mathbf{x}, \\mathcal{M}_1) = \\sum_{c \\in \\mathcal{C}} p(\\mathbf{y} \\mid \\mathbf{x}, c, \\mathcal{M}_1) p(c)$$\n由于 $p(c)$ 是均匀的，且 $p(c) = 1/|\\mathcal{C}|$，这变成了对每个 $c$ 的证据的平均值：\n$$p(\\mathbf{y} \\mid \\mathbf{x}, \\mathcal{M}_1) = \\frac{1}{|\\mathcal{C}|} \\sum_{c \\in \\mathcal{C}} p(\\mathbf{y} \\mid \\mathbf{x}, c, \\mathcal{M}_1)$$\n在对数空间中，这需要 log-sum-exp 稳定化。对于每个 $c_j \\in \\mathcal{C}$，我们使用通用的线性高斯公式计算条件对数证据 $\\mathcal{L}_j = \\log p(\\mathbf{y} \\mid \\mathbf{x}, c_j, \\mathcal{M}_1)$。总对数证据则为：\n$$\\log p(\\mathbf{y} \\mid \\mathbf{x}, \\mathcal{M}_1) = \\mathrm{logsumexp}(\\{\\mathcal{L}_j\\}_{j=1}^{|\\mathcal{C}|}) - \\log(|\\mathcal{C}|)$$\n\n**模型 $\\mathcal{M}_2$：高斯过程回归**\n模型为 $y_i = f(x_i) + \\epsilon_i$，其中 $f(x)$ 是从一个零均值高斯过程中抽取的样本，该过程使用平方指数核：$k(x_i, x_j) = \\sigma_f^2 \\exp(-\\frac{(x_i-x_j)^2}{2\\ell^2})$。数据向量 $\\mathbf{y}$ 服从多元正态分布 $\\mathbf{y} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{K}_{\\text{GP}})$，其中协方差矩阵 $\\mathbf{K}_{\\text{GP}}$ 是核矩阵 $\\mathbf{K}_f$ 和噪声协方差之和：\n$$(\\mathbf{K}_{\\text{GP}})_{ij} = k(x_i, x_j) + \\sigma_y^2 \\delta_{ij}$$\n超参数 $(\\sigma_f, \\ell)$ 在指定的网格上具有离散均匀先验。与 $\\mathcal{M}_1$ 类似，总证据是通过在超参数网格 $\\mathcal{H}$ 上进行边缘化找到的：\n$$p(\\mathbf{y} \\mid \\mathbf{x}, \\mathcal{M}_2) = \\frac{1}{|\\mathcal{H}|} \\sum_{(\\sigma_f, \\ell) \\in \\mathcal{H}} p(\\mathbf{y} \\mid \\mathbf{x}, \\sigma_f, \\ell, \\mathcal{M}_2)$$\n对于每一对 $(\\sigma_f, \\ell)$，我们构建协方差矩阵 $\\mathbf{K}_{\\text{GP}}$ 并计算其对数行列式和二次型 $\\mathbf{y}^\\top \\mathbf{K}_{\\text{GP}}^{-1} \\mathbf{y}$ 以获得条件对数证据。总对数证据是使用 log-sum-exp 技巧对所有超参数对计算得出的。\n\n**每种情况的流程：**\n对于四个测试用例中的每一个：\n1.  为保证可复现性，设置随机种子。\n2.  生成预测变量 $x_i \\sim \\mathrm{Uniform}(0, 1)$ 的 $n$ 个样本。\n3.  根据特定情况的函数计算真实值 $g(x_i)$。\n4.  生成噪声 $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_y^2)$ 并构成观测值 $y_i = g(x_i) + \\epsilon_i$。\n5.  计算 $\\mathcal{M}_0$、$\\mathcal{M}_1$ 和 $\\mathcal{M}_2$ 的对数证据。\n6.  选择具有最大对数证据的模型。结果是其索引：$\\mathcal{M}_0$ 为 $0$，$\\mathcal{M}_1$ 为 $1$，$\\mathcal{M}_2$ 为 $2$。\n最终输出是这四个索引的列表。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import cholesky, solve_triangular\nfrom scipy.special import logsumexp\n\ndef compute_log_marginal_likelihood(y, Phi, sigma_y, tau_sq):\n    \"\"\"\n    Computes the log-marginal likelihood for a linear-in-parameters model.\n    Model: y = Phi*w + eps, w ~ N(0, tau^2*I), eps ~ N(0, sigma_y^2*I)\n    This implies y ~ N(0, K) with K = sigma_y^2*I + tau^2*Phi*Phi.T\n    \"\"\"\n    n, p = Phi.shape\n    y = y.reshape(-1, 1)\n\n    # Covariance matrix K = sigma_y^2 * I + tau^2 * Phi @ Phi.T\n    K = (sigma_y**2) * np.eye(n) + tau_sq * (Phi @ Phi.T)\n    \n    try:\n        # Use Cholesky decomposition for stability and efficiency\n        L = cholesky(K, lower=True)\n    except np.linalg.LinAlgError:\n        # If K is not positive definite, return a very small log-likelihood\n        return -np.inf\n\n    # log|det(K)| = 2 * sum(log(diag(L)))\n    log_det_K = 2 * np.sum(np.log(np.diag(L)))\n\n    # Solve L*z = y for z, then compute z.T*z = y.T*K_inv*y\n    z = solve_triangular(L, y, lower=True)\n    y_Kinv_y = np.sum(z**2)\n    \n    # Log-marginal likelihood: -0.5 * (y.T*K_inv*y + log|det(K)| + n*log(2*pi))\n    log_ml = -0.5 * (y_Kinv_y + log_det_K + n * np.log(2.0 * np.pi))\n    \n    return log_ml\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and compute the best model for each.\n    \"\"\"\n    # Bayesian settings from the problem statement\n    tau_sq = 10.0\n    c_grid = [0.3, 0.5, 0.7]\n    sf_grid = [0.5, 1.0, 2.0]\n    l_grid = [0.15, 0.30, 0.60]\n    gp_hparam_grid = [(sf, l) for sf in sf_grid for l in l_grid]\n\n    # Test case specifications\n    test_cases = [\n        {\n            \"id\": 1,\n            \"n\": 30, \"sigma_y\": 0.20,\n            \"g\": lambda x: 2.0 + 1.0 * x + 1.0 * np.maximum(0, x - 0.5),\n            \"seed\": 123\n        },\n        {\n            \"id\": 2,\n            \"n\": 30, \"sigma_y\": 0.25,\n            \"g\": lambda x: 3.5 + 1.5 * np.tanh((x - 0.4) / 0.2),\n            \"seed\": 456\n        },\n        {\n            \"id\": 3,\n            \"n\": 25, \"sigma_y\": 0.20,\n            \"g\": lambda x: 2.0 + 3.0 * x,\n            \"seed\": 789\n        },\n        {\n            \"id\": 4,\n            \"n\": 15, \"sigma_y\": 1.00,\n            \"g\": lambda x: 2.0 + 1.0 * x + 1.0 * np.maximum(0, x - 0.5),\n            \"seed\": 321\n        }\n    ]\n\n    selected_models = []\n\n    for case in test_cases:\n        # 1. Generate synthetic data\n        n, sigma_y, g, seed = case[\"n\"], case[\"sigma_y\"], case[\"g\"], case[\"seed\"]\n        rng = np.random.default_rng(seed)\n        x = rng.uniform(0, 1, n)\n        epsilon = rng.normal(0, sigma_y, n)\n        y = g(x) + epsilon\n\n        # 2. Compute evidence for each model\n        log_evidences = []\n\n        # Model 0: Linear\n        Phi_0 = np.vstack([np.ones(n), x]).T\n        log_ev_0 = compute_log_marginal_likelihood(y, Phi_0, sigma_y, tau_sq)\n        log_evidences.append(log_ev_0)\n\n        # Model 1: Piecewise-Linear\n        log_evs_m1 = []\n        for c in c_grid:\n            hinge = np.maximum(0, x - c)\n            Phi_1_c = np.vstack([np.ones(n), x, hinge]).T\n            log_ev_c = compute_log_marginal_likelihood(y, Phi_1_c, sigma_y, tau_sq)\n            log_evs_m1.append(log_ev_c)\n        log_ev_1 = logsumexp(log_evs_m1) - np.log(len(c_grid))\n        log_evidences.append(log_ev_1)\n\n        # Model 2: Gaussian Process\n        log_evs_m2 = []\n        x_col = x[:, np.newaxis]\n        for sf, l in gp_hparam_grid:\n            # Squared exponential kernel\n            sqdist = np.sum(x_col**2, 1).reshape(-1, 1) + np.sum(x_col**2, 1) - 2 * (x_col @ x_col.T)\n            K_f = sf**2 * np.exp(-0.5 * sqdist / l**2)\n            \n            # Full covariance matrix with noise\n            K_gp = K_f + (sigma_y**2) * np.eye(n)\n            \n            try:\n                L = cholesky(K_gp, lower=True)\n            except np.linalg.LinAlgError:\n                log_evs_m2.append(-np.inf)\n                continue\n\n            log_det_K = 2 * np.sum(np.log(np.diag(L)))\n            z = solve_triangular(L, y, lower=True)\n            y_Kinv_y = np.sum(z**2)\n            \n            log_ml = -0.5 * (y_Kinv_y + log_det_K + n * np.log(2 * np.pi))\n            log_evs_m2.append(log_ml)\n        \n        log_ev_2 = logsumexp(log_evs_m2) - np.log(len(gp_hparam_grid))\n        log_evidences.append(log_ev_2)\n\n        # 3. Select model with highest evidence\n        best_model_idx = np.argmax(log_evidences)\n        selected_models.append(best_model_idx)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, selected_models))}]\")\n\nsolve()\n```"
        }
    ]
}