{
    "hands_on_practices": [
        {
            "introduction": "The Brewer-Dobson circulation is fundamentally driven by the breaking of atmospheric waves, which deposit momentum and decelerate the mean flow. This exercise provides a foundational look at this process by tasking you with calculating the vertical flux of horizontal momentum, $\\rho \\overline{u'w'}$, from a gravity wave packet, connecting wave properties directly to the forcing that drives large-scale circulation .",
            "id": "4095869",
            "problem": "Consider a small-amplitude, two-dimensional internal gravity wave packet propagating upward through a stably stratified atmosphere on the equatorial-to-subtropical flank of a westerly jet. Model the flow with the Boussinesq approximation and linear dynamics, neglecting planetary rotation. Let the zonal and vertical velocity perturbations be denoted by $u'(x,z,t)$ and $w'(x,z,t)$, respectively, and assume a monochromatic plane-wave structure $w'(x,z,t) = \\Re\\{\\hat{w}\\exp[i(k x + m z - \\omega t)]\\}$ with real-valued wavenumbers $k$ and $m$, and real frequency $\\omega$. The Reynolds averaging operator $\\overline{(\\cdot)}$ is a time or phase average over many wave cycles. The vertical flux of horizontal (zonal) momentum associated with the wave is $\\rho\\,\\overline{u'w'}$, where $\\rho$ is the ambient density. Under the Transformed Eulerian Mean (TEM) formulation, the zonal-mean zonal wind tendency due to wave–mean-flow interaction is $-(1/\\rho)\\,\\partial\\big(\\rho\\,\\overline{u'w'}\\big)/\\partial z$.\n\nStarting from the linearized Boussinesq equations and mass continuity, derive an expression for $\\overline{u'w'}$ in terms of the complex amplitude $\\hat{w}$ and the wavenumbers $k$ and $m$, and then evaluate the resulting vertical flux $\\rho\\,\\overline{u'w'}$ at the lower edge of the jet-core layer for the following scientifically plausible parameters:\n- Horizontal wavenumber $k = 1.0 \\times 10^{-5}\\ \\mathrm{m}^{-1}$,\n- Vertical wavenumber $m = -1.0 \\times 10^{-3}\\ \\mathrm{m}^{-1}$,\n- Vertical velocity amplitude $|\\hat{w}| = 5.0 \\times 10^{-2}\\ \\mathrm{m}\\,\\mathrm{s}^{-1}$,\n- Density at the lower edge of the layer $\\rho_{\\mathrm{b}} = 1.8 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n\nAssume that the wave encounters a critical level within the jet-core layer where it is fully absorbed, so that the vertical flux at the upper edge of the layer is zero, and the layer thickness is $\\Delta z = 5.0 \\times 10^{3}\\ \\mathrm{m}$. Using the TEM mean-flow forcing, compute the corresponding zonal-mean zonal acceleration across the layer by approximating the vertical derivative as a finite difference with a layer-mean density $\\rho_{\\mathrm{avg}} = 1.5 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}$. Round both the vertical momentum flux and the zonal-mean acceleration to three significant figures. Express the flux in Pascals and the acceleration in $\\mathrm{m}\\,\\mathrm{s}^{-2}$. Your final answer must be a calculation and should report the two requested quantities.",
            "solution": "The problem statement is evaluated as valid. It is scientifically grounded in the principles of atmospheric fluid dynamics, specifically the theory of internal gravity waves and their interaction with a mean flow. The problem is well-posed, providing all necessary parameters and a clear objective. The language is objective and the parameters are physically plausible. The task is to derive and calculate quantities based on fundamental equations, which is a standard and verifiable procedure.\n\nWe begin by deriving an expression for the vertical flux of horizontal momentum, often referred to as the Reynolds stress component $\\overline{u'w'}$. The problem states to use the linearized Boussinesq equations, neglecting rotation. The most direct path to relate the velocity components $u'$ and $w'$ is through the equation for mass continuity for an incompressible fluid (a core component of the Boussinesq approximation):\n$$\n\\frac{\\partial u'}{\\partial x} + \\frac{\\partial w'}{\\partial z} = 0\n$$\nThe velocity perturbations are given as monochromatic plane waves. We can write both $u'$ and $w'$ in complex form, with the understanding that the physical quantity is the real part:\n$$\nu'(x,z,t) = \\Re\\{\\hat{u}\\exp[i(k x + m z - \\omega t)]\\}\n$$\n$$\nw'(x,z,t) = \\Re\\{\\hat{w}\\exp[i(k x + m z - \\omega t)]\\}\n$$\nHere, $\\hat{u}$ and $\\hat{w}$ are the complex amplitudes of the zonal and vertical velocities, respectively. Substituting these forms into the continuity equation requires taking the derivatives:\n$$\n\\frac{\\partial u'}{\\partial x} = \\Re\\{i k \\hat{u}\\exp[i(k x + m z - \\omega t)]\\}\n$$\n$$\n\\frac{\\partial w'}{\\partial z} = \\Re\\{i m \\hat{w}\\exp[i(k x + m z - \\omega t)]\\}\n$$\nSumming these gives:\n$$\n\\Re\\{i(k\\hat{u} + m\\hat{w})\\exp[i(k x + m z - \\omega t)]\\} = 0\n$$\nFor this equation to hold for all $x$, $z$, and $t$, the complex term multiplying the exponential must be zero. This provides a relationship between the complex amplitudes:\n$$\nk\\hat{u} + m\\hat{w} = 0 \\implies \\hat{u} = -\\frac{m}{k}\\hat{w}\n$$\nNext, we calculate the time-averaged product $\\overline{u'w'}$. For two general oscillatory quantities $A(t) = \\Re\\{\\hat{A}\\exp(-i\\omega t)\\}$ and $B(t) = \\Re\\{\\hat{B}\\exp(-i\\omega t)\\}$, the time average over one or many periods is given by $\\overline{A B} = \\frac{1}{2}\\Re\\{\\hat{A}\\hat{B}^*\\}$, where $\\hat{B}^*$ is the complex conjugate of $\\hat{B}$. In our case, the full complex amplitudes including spatial dependence are $\\hat{u}\\exp[i(kx+mz)]$ and $\\hat{w}\\exp[i(kx+mz)]$. The time average is independent of the spatial coordinates, so we have:\n$$\n\\overline{u'w'} = \\frac{1}{2}\\Re\\{ \\left( \\hat{u}\\exp[i(kx+mz)] \\right) \\left( \\hat{w}\\exp[i(kx+mz)] \\right)^* \\}\n$$\n$$\n\\overline{u'w'} = \\frac{1}{2}\\Re\\{ \\hat{u}\\exp[i(kx+mz)] \\hat{w}^*\\exp[-i(kx+mz)] \\} = \\frac{1}{2}\\Re\\{\\hat{u}\\hat{w}^*\\}\n$$\nNow, we substitute the relationship for $\\hat{u}$ derived from the continuity equation:\n$$\n\\overline{u'w'} = \\frac{1}{2}\\Re\\left\\{\\left(-\\frac{m}{k}\\hat{w}\\right)\\hat{w}^*\\right\\} = \\frac{1}{2}\\Re\\left\\{-\\frac{m}{k}(\\hat{w}\\hat{w}^*)\\right\\}\n$$\nSince $\\hat{w}\\hat{w}^* = |\\hat{w}|^2$, and the wavenumbers $k$ and $m$ are real, the expression inside the real-part operator is entirely real. Thus, we arrive at the first required expression:\n$$\n\\overline{u'w'} = -\\frac{m}{2k}|\\hat{w}|^2\n$$\nThe vertical flux of horizontal momentum is $F_m = \\rho\\,\\overline{u'w'}$. We are asked to evaluate this at the lower edge of the jet-core layer, which we denote with subscript $b$.\n$$\nF_{m,b} = \\rho_b \\left( -\\frac{m}{2k}|\\hat{w}|^2 \\right)\n$$\nWe substitute the given numerical values:\n- Horizontal wavenumber $k = 1.0 \\times 10^{-5}\\ \\mathrm{m}^{-1}$\n- Vertical wavenumber $m = -1.0 \\times 10^{-3}\\ \\mathrm{m}^{-1}$\n- Vertical velocity amplitude $|\\hat{w}| = 5.0 \\times 10^{-2}\\ \\mathrm{m}\\,\\mathrm{s}^{-1}$\n- Density at the lower edge $\\rho_b = 1.8 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}$\n\nFirst, we calculate the term in parentheses:\n$$\n-\\frac{m}{2k}|\\hat{w}|^2 = -\\frac{-1.0 \\times 10^{-3}\\ \\mathrm{m}^{-1}}{2(1.0 \\times 10^{-5}\\ \\mathrm{m}^{-1})} (5.0 \\times 10^{-2}\\ \\mathrm{m}\\,\\mathrm{s}^{-1})^2\n$$\n$$\n= \\frac{1.0 \\times 10^{-3}}{2.0 \\times 10^{-5}} (2.5 \\times 10^{-3}\\ \\mathrm{m}^2\\,\\mathrm{s}^{-2}) = (50) \\times (2.5 \\times 10^{-3}\\ \\mathrm{m}^2\\,\\mathrm{s}^{-2}) = 1.25 \\times 10^{-1}\\ \\mathrm{m}^2\\,\\mathrm{s}^{-2}\n$$\nNow, we compute the flux:\n$$\nF_{m,b} = (1.8 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}) \\times (1.25 \\times 10^{-1}\\ \\mathrm{m}^2\\,\\mathrm{s}^{-2}) = 2.25 \\times 10^{-2}\\ \\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2}\n$$\nThe unit $\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2}$ is equivalent to Pascals ($\\mathrm{Pa}$), as required. Rounded to three significant figures, the flux is $2.25 \\times 10^{-2}\\ \\mathrm{Pa}$.\n\nFinally, we compute the zonal-mean zonal acceleration across the layer. The forcing is given by the Transformed Eulerian Mean (TEM) expression:\n$$\na = -\\frac{1}{\\rho}\\frac{\\partial(\\rho\\,\\overline{u'w'})}{\\partial z}\n$$\nWe approximate this using a finite difference over the layer of thickness $\\Delta z$, using the layer-mean density $\\rho_{\\mathrm{avg}}$:\n$$\na \\approx -\\frac{1}{\\rho_{\\mathrm{avg}}} \\frac{\\Delta(\\rho\\,\\overline{u'w'})}{\\Delta z} = -\\frac{1}{\\rho_{\\mathrm{avg}}} \\frac{(\\rho\\,\\overline{u'w'})_{\\text{top}} - (\\rho\\,\\overline{u'w'})_{\\text{bottom}}}{\\Delta z}\n$$\nThe problem states the wave is fully absorbed within the layer, implying the momentum flux at the top of the layer is zero: $(\\rho\\,\\overline{u'w'})_{\\text{top}} = 0$. The flux at the bottom is the value $F_{m,b}$ we just calculated.\nThe given parameters are:\n- $(\\rho\\,\\overline{u'w'})_{\\text{bottom}} = 2.25 \\times 10^{-2}\\ \\mathrm{Pa}$\n- $\\rho_{\\mathrm{avg}} = 1.5 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}$\n- $\\Delta z = 5.0 \\times 10^{3}\\ \\mathrm{m}$\n\nSubstituting these into the approximation for acceleration:\n$$\na \\approx -\\frac{1}{1.5 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}} \\frac{0 - (2.25 \\times 10^{-2}\\ \\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2})}{5.0 \\times 10^{3}\\ \\mathrm{m}}\n$$\n$$\na \\approx \\frac{2.25 \\times 10^{-2}\\ \\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2}}{(1.5 \\times 10^{-1}\\ \\mathrm{kg}\\,\\mathrm{m}^{-3}) \\times (5.0 \\times 10^{3}\\ \\mathrm{m})}\n$$\n$$\na \\approx \\frac{2.25 \\times 10^{-2}}{7.5 \\times 10^{2}} \\frac{\\mathrm{kg}\\,\\mathrm{m}^{-1}\\,\\mathrm{s}^{-2}}{\\mathrm{kg}\\,\\mathrm{m}^{-2}} = 0.3 \\times 10^{-4}\\ \\mathrm{m}\\,\\mathrm{s}^{-2} = 3.0 \\times 10^{-5}\\ \\mathrm{m}\\,\\mathrm{s}^{-2}\n$$\nRounding to three significant figures, the acceleration is $3.00 \\times 10^{-5}\\ \\mathrm{m}\\,\\mathrm{s}^{-2}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 2.25 \\times 10^{-2} & 3.00 \\times 10^{-5} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Accurately simulating the transport of tracers like ozone by the Brewer-Dobson circulation is a core task of climate models, but it is fraught with numerical challenges. This practice problem delves into the stability and accuracy of a common advection scheme, demonstrating through the Courant-Friedrichs-Lewy (CFL) condition how numerical choices can introduce artificial diffusion that may overwhelm the physical processes being studied .",
            "id": "4095886",
            "problem": "A global chemistry–climate model is used to simulate ozone transport by the Brewer–Dobson circulation and stratosphere–troposphere exchange. Consider tracer advection governed by the one-dimensional linear advection equation in each coordinate direction, with an explicit upstream finite-volume discretization advanced in time by forward Euler. Along a midlatitude latitude circle in the lower stratosphere, take a typical zonal wind speed of $u = 40 \\,\\mathrm{m\\,s^{-1}}$, a horizontal grid spacing of $\\Delta x = 100 \\,\\mathrm{km}$, and a time step of $\\Delta t = 1800 \\,\\mathrm{s}$. For vertical transport across the tropical tropopause layer, take a typical residual mean vertical velocity of $w = 1.5 \\times 10^{-3} \\,\\mathrm{m\\,s^{-1}}$, a vertical grid spacing of $\\Delta z = 1.5 \\,\\mathrm{km}$, and the same time step $\\Delta t = 1800 \\,\\mathrm{s}$. \n\nStarting from the advection equation and a control-volume discretization, and using Fourier (von Neumann) stability analysis, compute the Courant–Friedrichs–Lewy (CFL) Courant numbers for horizontal and vertical tracer advection under these conditions, and determine whether the explicit upstream advection is stable in each direction. Then, based on the modified-equation perspective, assess the expected accuracy regime by comparing the leading-order numerical diffusion implied by the scheme to physically plausible lower-stratospheric mixing rates.\n\nRound each Courant number to three significant figures. Express Courant numbers as dimensionless numbers with no unit in your final answer.",
            "solution": "The problem requires an analysis of the stability and accuracy of an explicit upstream finite-volume scheme for tracer advection in a chemistry-climate model. The analysis is performed separately for horizontal (zonal) and vertical transport based on the provided parameters.\n\nThe governing equation for a non-reactive tracer with concentration $\\phi$ under pure advection in one dimension by a constant velocity $c$ is the linear advection equation:\n$$\n\\frac{\\partial \\phi}{\\partial t} + c \\frac{\\partial \\phi}{\\partial x} = 0\n$$\n\nWe discretize this equation on a uniform grid with spacing $\\Delta x$ using a finite-volume approach. For a grid cell $i$, centered at $x_i$, the rate of change of the cell-averaged concentration is governed by the fluxes at the cell faces:\n$$\n\\frac{d\\phi_i}{dt}\\Delta x + (c\\phi)_{i+1/2} - (c\\phi)_{i-1/2} = 0\n$$\nHere, $\\phi_i$ is the average concentration in cell $i$, and $(c\\phi)_{i\\pm1/2}$ are the fluxes at the right and left cell interfaces, respectively.\n\nThe scheme specified is forward Euler in time and explicit upstream for the spatial fluxes. The forward Euler discretization of the time derivative is $\\frac{d\\phi_i}{dt} \\approx \\frac{\\phi_i^{n+1} - \\phi_i^n}{\\Delta t}$. The upstream scheme dictates that the value of $\\phi$ at a cell interface is taken from the upwind cell. For a positive velocity ($c > 0$), this means $(c\\phi)_{i+1/2} = c\\phi_i^n$ and $(c\\phi)_{i-1/2} = c\\phi_{i-1}^n$. Substituting these into the finite-volume equation gives:\n$$\n\\frac{\\phi_i^{n+1} - \\phi_i^n}{\\Delta t} \\Delta x + c\\phi_i^n - c\\phi_{i-1}^n = 0\n$$\nRearranging for the new time step $\\phi_i^{n+1}$:\n$$\n\\phi_i^{n+1} = \\phi_i^n - \\frac{c \\Delta t}{\\Delta x} (\\phi_i^n - \\phi_{i-1}^n)\n$$\nWe define the dimensionless Courant–Friedrichs–Lewy (CFL) number, or Courant number, as $\\sigma = \\frac{c \\Delta t}{\\Delta x}$. The update equation becomes:\n$$\n\\phi_i^{n+1} = (1 - \\sigma)\\phi_i^n + \\sigma\\phi_{i-1}^n\n$$\nA Fourier (von Neumann) stability analysis of this scheme shows that it is numerically stable if and only if the Courant number $\\sigma$ satisfies the condition $0 \\le \\sigma \\le 1$.\n\nWe now apply this framework to the two cases provided.\n\n**1. Horizontal (Zonal) Advection**\n\nThe given parameters are:\n- Zonal wind speed: $u = 40 \\,\\mathrm{m\\,s^{-1}}$\n- Horizontal grid spacing: $\\Delta x = 100 \\,\\mathrm{km} = 1 \\times 10^5 \\,\\mathrm{m}$\n- Time step: $\\Delta t = 1800 \\,\\mathrm{s}$\n\nThe Courant number for horizontal advection, $\\sigma_x$, is:\n$$\n\\sigma_x = \\frac{u \\Delta t}{\\Delta x} = \\frac{(40 \\,\\mathrm{m\\,s^{-1}}) \\times (1800 \\,\\mathrm{s})}{1 \\times 10^5 \\,\\mathrm{m}} = \\frac{72000}{100000} = 0.72\n$$\nRounding to three significant figures gives $\\sigma_x = 0.720$.\nSince $0 \\le 0.720 \\le 1$, the stability condition is satisfied. The explicit upstream scheme for horizontal advection is therefore **stable** under these conditions.\n\n**2. Vertical Advection**\n\nThe given parameters are:\n- Residual mean vertical velocity: $w = 1.5 \\times 10^{-3} \\,\\mathrm{m\\,s^{-1}}$\n- Vertical grid spacing: $\\Delta z = 1.5 \\,\\mathrm{km} = 1.5 \\times 10^3 \\,\\mathrm{m}$\n- Time step: $\\Delta t = 1800 \\,\\mathrm{s}$\n\nThe Courant number for vertical advection, $\\sigma_z$, is:\n$$\n\\sigma_z = \\frac{w \\Delta t}{\\Delta z} = \\frac{(1.5 \\times 10^{-3} \\,\\mathrm{m\\,s^{-1}}) \\times (1800 \\,\\mathrm{s})}{1.5 \\times 10^3 \\,\\mathrm{m}} = \\frac{2.7}{1500} = 0.0018\n$$\nRounding to three significant figures gives $\\sigma_z = 0.00180$.\nSince $0 \\le 0.00180 \\le 1$, the stability condition is satisfied. The explicit upstream scheme for vertical advection is also **stable**.\n\n**3. Accuracy Assessment via Modified Equation**\n\nWhile the scheme is stable in both directions, its accuracy must be assessed. The forward-Euler, upstream scheme is known to be only first-order accurate and to introduce significant numerical diffusion. This can be quantified using the modified-equation perspective, which reveals the partial differential equation that the numerical scheme actually solves. For this scheme, the modified equation is:\n$$\n\\frac{\\partial \\phi}{\\partial t} + c \\frac{\\partial \\phi}{\\partial x} = K_{num} \\frac{\\partial^2 \\phi}{\\partial x^2} + \\dots (\\text{higher-order terms})\n$$\nThe leading-order error term has the form of a physical diffusion term, where $K_{num}$ is the numerical diffusivity. Its value is given by:\n$$\nK_{num} = \\frac{c \\Delta x}{2}(1 - \\sigma)\n$$\nThis numerical diffusion is an artifact of the discretization and can corrupt the simulation if its magnitude is comparable to or larger than the physical mixing processes being modeled.\n\n**Horizontal Accuracy:**\nThe numerical diffusivity for the horizontal advection is:\n$$\nK_{num, x} = \\frac{u \\Delta x}{2}(1 - \\sigma_x) = \\frac{(40 \\,\\mathrm{m\\,s^{-1}})(1 \\times 10^5 \\,\\mathrm{m})}{2}(1 - 0.720) = (2 \\times 10^6 \\,\\mathrm{m}^2 \\mathrm{s}^{-1})(0.28) = 5.6 \\times 10^5 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}\n$$\nIn the lower stratosphere, large-scale quasi-horizontal mixing by breaking planetary waves is a key physical process, characterized by an effective horizontal eddy diffusivity on the order of $K_{yy} \\approx 10^5 - 10^6 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}$. The calculated numerical diffusivity $K_{num, x} = 5.6 \\times 10^5 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}$ falls directly within this range. This implies that the artificial diffusion from the numerical scheme is of the same magnitude as the physical process it is meant to resolve. The simulated horizontal transport would therefore be dominated by numerical error, representing a **poor accuracy regime**.\n\n**Vertical Accuracy:**\nThe numerical diffusivity for the vertical advection is:\n$$\nK_{num, z} = \\frac{w \\Delta z}{2}(1 - \\sigma_z) = \\frac{(1.5 \\times 10^{-3} \\,\\mathrm{m\\,s^{-1}})(1.5 \\times 10^3 \\,\\mathrm{m})}{2}(1 - 0.00180) \\approx \\frac{2.25 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}}{2}(0.9982) \\approx 1.12 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}\n$$\nThe lower stratosphere is very stably stratified, and physical vertical mixing is weak. Plausible values for the vertical eddy diffusivity, $K_{zz}$, are typically in the range of $0.1 - 1.0 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}$. The calculated numerical diffusivity $K_{num, z} \\approx 1.12 \\,\\mathrm{m}^2 \\mathrm{s}^{-1}$ is at the uppermost limit of, or even larger than, the plausible physical values. This is particularly problematic because vertical transport in the Brewer-Dobson circulation is slow, and maintaining sharp vertical gradients of tracers like ozone across the tropopause is critical. The large numerical diffusion will artificially smooth these gradients, fundamentally misrepresenting the physics of stratosphere-troposphere exchange. This constitutes a **very poor accuracy regime**. Note that the very small Courant number ($\\sigma_z \\ll 1$) leads to maximal numerical diffusion, a classic flaw of this scheme for slow advective processes.\n\nIn summary, while the scheme is numerically stable for the given parameters, its inherent numerical diffusion is so large in both horizontal and vertical directions that it renders the simulation scientifically inaccurate for studying lower-stratospheric transport. Modern climate models employ higher-order, less diffusive advection schemes to mitigate this critical problem.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.720 & 0.00180 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Quantifying the exchange of mass and chemicals between the stratosphere and troposphere is critical, but the \"boundary\" between these two regions—the tropopause—can be defined in multiple ways. This exercise explores the practical consequences of this ambiguity by asking you to compute stratosphere-troposphere exchange (STE) fluxes using different tropopause definitions, revealing the sensitivity of diagnostic results to methodological choices .",
            "id": "4095866",
            "problem": "Consider a highly idealized zonal band composed of $N_x$ independent columns, each discretized on $N_z$ fixed geometric height levels. The purpose is to diagnose the instantaneous downward stratosphere–troposphere exchange (STE) flux of an ozone-like passive tracer across a tropopause diagnosed by different definitions and thresholds, and to quantify its sensitivity to the potential vorticity (PV) threshold and to the thermal lapse-rate criterion. The diagnostic must begin from fundamental principles and core definitions, and all computations must be expressed in SI units. The final program must produce results for a fixed test suite.\n\nThe fundamental base for this problem is as follows.\n\n- The instantaneous vertical mass flux of a tracer across a material surface is defined from the continuity and transport equations as the area integral of the product of air density, vertical velocity, and tracer mass mixing ratio. For an interface approximated by a horizontal surface at geometric height $z = z_{\\mathrm{tp}}(x)$ and diagnosed at discrete levels, the domain-integrated downward tracer flux can be approximated by\n$$\n\\mathcal{F}_{\\downarrow} \\approx \\sum_{i=1}^{N_x} \\rho_i(z_{\\mathrm{tp}, i}) \\, \\max\\left(-w_i(z_{\\mathrm{tp}, i}), 0\\right) \\, \\chi_i(z_{\\mathrm{tp}, i}) \\, \\Delta A_i,\n$$\nwhere $\\rho$ is air density in $\\mathrm{kg\\, m^{-3}}$, $w$ is vertical velocity in $\\mathrm{m\\, s^{-1}}$ (positive upward), $\\chi$ is the tracer mass mixing ratio in $\\mathrm{kg\\, kg^{-1}}$, and $\\Delta A_i$ is the column area in $\\mathrm{m^2}$. The quantity $\\mathcal{F}_{\\downarrow}$ has units $\\mathrm{kg\\, s^{-1}}$.\n\n- The geometric tropopause is diagnosed in three ways, each yielding an index $k_{\\mathrm{tp}, i}$ corresponding to a discrete model level at height $z_{k_{\\mathrm{tp}, i}}$.\n\n  1. PV-based definition: given a PV threshold $q_t$ expressed in potential vorticity units (PVU), where $1\\,\\mathrm{PVU} = 10^{-6}\\,\\mathrm{K\\, m^2\\, kg^{-1}\\, s^{-1}}$, find the first level index $k$ increasing with height such that $q_i(k) \\ge q_t$ and either $k = 0$ or $q_i(k-1) < q_t$. If no such crossing exists, assign $k_{\\mathrm{tp}, i}$ to the highest level index.\n\n  2. Thermal lapse-rate definition: define the discrete lapse rate between adjacent levels as\n  $$\n  \\Gamma_i(k) = -\\frac{T_i(k+1) - T_i(k)}{z_{k+1} - z_k} \\times 10^{3},\n  $$\n  in $\\mathrm{K\\, km^{-1}}$, for $k \\in \\{0,\\dots,N_z-2\\}$. Given a threshold $\\gamma_t$ in $\\mathrm{K\\, km^{-1}}$, find the first $k$ such that $\\Gamma_i(k) \\le \\gamma_t$ and set $k_{\\mathrm{tp}, i} = k + 1$. If no such index exists, assign $k_{\\mathrm{tp}, i}$ to the highest level index.\n\n  3. Hybrid definition: compute both PV-based and thermal-based indices when available and select the one at the greater height, that is, the larger $z_{k_{\\mathrm{tp}, i}}$. If only one is available, use it; if neither is found, assign the highest level index.\n\nThe synthetic domain and fields are defined as follows.\n\n- The number of columns is $N_x = 4$. The number of vertical levels is $N_z = 10$. Level heights are\n$$\nz_k = 6000 + 1000\\,k \\quad \\text{for } k \\in \\{0,1,\\dots,9\\},\n$$\nin meters.\n\n- Each column $i \\in \\{0,1,2,3\\}$ has a column-dependent tropopause height\n$$\nz_{\\mathrm{tp}, i}^{\\star} = 10000 + 500\\,(i - 1.5),\n$$\nin meters.\n\n- Temperature $T_i(k)$ in Kelvin is constructed from a tropospheric lapse rate below $z_{\\mathrm{tp}, i}^{\\star}$ and a weak stratopause lapse rate above:\n  - Define a base temperature at $z_0 = 6000\\,\\mathrm{m}$ as $T_{0,i} = 245 - 2\\,i$ in Kelvin.\n  - For $z_k \\le z_{\\mathrm{tp}, i}^{\\star}$,\n  $$\n  T_i(k) = T_{0,i} - 6.5 \\times \\frac{z_k - 6000}{1000}.\n  $$\n  - For $z_k > z_{\\mathrm{tp}, i}^{\\star}$, let\n  $$\n  T_i(k) = T_{0,i} - 6.5 \\times \\frac{z_{\\mathrm{tp}, i}^{\\star} - 6000}{1000} - 1.0 \\times \\frac{z_k - z_{\\mathrm{tp}, i}^{\\star}}{1000}.\n  $$\n\n- Potential vorticity $q_i(k)$ in PVU is defined by\n$$\nq_i(k) = \\left(0.5 + 0.15\\,k + 0.1\\,i\\right) + \\Delta q_i(k), \\quad \\Delta q_i(k) = \\begin{cases}\n0, & z_k < z_{\\mathrm{tp}, i}^{\\star},\\\\\n2.0, & z_k \\ge z_{\\mathrm{tp}, i}^{\\star}.\n\\end{cases}\n$$\n\n- Vertical velocity $w_i(k)$ in $\\mathrm{m\\, s^{-1}}$ is prescribed by\n$$\nw_i(k) = 0.02 \\,\\sin\\!\\left(\\frac{\\pi}{4} \\left(\\frac{z_k}{1000} - 6 + 0.5\\,i\\right)\\right) - 0.005.\n$$\n\n- Tracer mass mixing ratio $\\chi_i(k)$ in $\\mathrm{kg\\, kg^{-1}}$ increases with height and has a small step at the tropopause:\n  - For $z_k \\le z_{\\mathrm{tp}, i}^{\\star}$,\n  $$\n  \\chi_i(k) = 4\\times 10^{-6} + 0.5\\times 10^{-6} \\times \\frac{z_k - 6000}{1000}.\n  $$\n  - For $z_k > z_{\\mathrm{tp}, i}^{\\star}$,\n  $$\n  \\chi_i(k) = \\left[4\\times 10^{-6} + 0.5\\times 10^{-6} \\times \\frac{z_{\\mathrm{tp}, i}^{\\star} - 6000}{1000}\\right] + 3\\times 10^{-6} + 0.3\\times 10^{-6} \\times \\frac{z_k - z_{\\mathrm{tp}, i}^{\\star}}{1000}.\n  $$\n\n- Air density $\\rho_i(k)$ in $\\mathrm{kg\\, m^{-3}}$ is exponential in height with a column-dependent prefactor:\n  - Define $\\rho_{6,i} = 0.66 \\times \\left(1 + 0.03\\,(i - 1.5)\\right)$ at $z = 6000\\,\\mathrm{m}$.\n  - Let the scale height be $H = 7000\\,\\mathrm{m}$, and for any $z_k$,\n  $$\n  \\rho_i(k) = \\rho_{6,i}\\,\\exp\\!\\left(-\\frac{z_k - 6000}{H}\\right).\n  $$\n\n- Each column represents an equal area $\\Delta A_i = \\Delta A = 10^{10}\\,\\mathrm{m^2}$.\n\nUsing these definitions, implement an algorithm that, for a given diagnosis type and thresholds, determines the tropopause level $k_{\\mathrm{tp}, i}$ in each column, evaluates $\\rho_i(k_{\\mathrm{tp}, i})$, $w_i(k_{\\mathrm{tp}, i})$, and $\\chi_i(k_{\\mathrm{tp}, i})$, and computes the total downward tracer flux $\\mathcal{F}_{\\downarrow}$ in $\\mathrm{kg\\, s^{-1}}$ as specified. If no PV crossing or thermal criterion is met as defined above, use the highest level as the tropopause for that method; for the hybrid method, select the highest-altitude among available methods, falling back to the highest level if neither method yields a tropopause level.\n\nTest suite and output requirements:\n\n- The input to your program is fixed by the following list of $8$ test cases, each a triple $(\\text{def}, q_t, \\gamma_t)$:\n  - Case $1$: PV-based, $(\\text{\"PV\"}, 2.0, 2.0)$,\n  - Case $2$: PV-based, $(\\text{\"PV\"}, 3.5, 2.0)$,\n  - Case $3$: Thermal-based, $(\\text{\"TH\"}, 2.0, 2.0)$,\n  - Case $4$: Thermal-based, $(\\text{\"TH\"}, 2.0, 1.5)$,\n  - Case $5$: Hybrid, $(\\text{\"HYB\"}, 2.0, 2.0)$,\n  - Case $6$: Hybrid, $(\\text{\"HYB\"}, 3.5, 1.5)$,\n  - Case $7$: PV-based high threshold edge case, $(\\text{\"PV\"}, 6.0, 2.0)$,\n  - Case $8$: Thermal-based strict criterion edge case, $(\\text{\"TH\"}, 2.0, 0.5)$.\n\n- For each case, compute $\\mathcal{F}_{\\downarrow}$ in $\\mathrm{kg\\, s^{-1}}$, rounded to $6$ decimal places.\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite (for example, $[\\text{result}_1,\\text{result}_2,\\dots,\\text{result}_8]$). No other output is permitted.\n\nAngles are not used in this problem, and there are no percentages. All outputs must be reported in $\\mathrm{kg\\, s^{-1}}$ as specified, rounded to six decimal places.",
            "solution": "The problem requires the computation of the instantaneous downward stratosphere-troposphere exchange (STE) flux of a passive tracer across a diagnosed tropopause. The calculation is performed on a synthetic, idealized two-dimensional domain. The solution entails three main stages: first, constructing the discrete atmospheric state variables; second, diagnosing the tropopause height according to three distinct definitions; and third, computing the total downward flux by summing contributions from each atmospheric column.\n\nFirst, we establish the computational domain and discretization. The domain consists of $N_x = 4$ independent vertical columns, indexed by $i \\in \\{0, 1, 2, 3\\}$. Each column is discretized into $N_z = 10$ vertical levels, indexed by $k \\in \\{0, 1, \\dots, 9\\}$. The geometric height of each level $z_k$ is given by the formula $z_k = 6000 + 1000k$, where $z_k$ is in meters. The area associated with each column is a constant, $\\Delta A = 10^{10}\\,\\mathrm{m^2}$.\n\nNext, we generate the required physical fields for each column $i$ and level $k$. These fields are temperature $T_i(k)$, potential vorticity $q_i(k)$, vertical velocity $w_i(k)$, tracer mass mixing ratio $\\chi_i(k)$, and air density $\\rho_i(k)$. The definitions are parameterized based on a column-dependent reference tropopause height, $z_{\\mathrm{tp}, i}^{\\star} = 10000 + 500(i - 1.5)\\,\\mathrm{m}$.\n\nThe temperature field $T_i(k)$ is defined piecewise. A base temperature at $z_0 = 6000\\,\\mathrm{m}$ is set as $T_{0,i} = 245 - 2i\\,\\mathrm{K}$. Below $z_{\\mathrm{tp}, i}^{\\star}$, the temperature follows a constant lapse rate of $6.5\\,\\mathrm{K\\,km^{-1}}$:\n$$ T_i(k) = T_{0,i} - 6.5 \\times \\frac{z_k - 6000}{1000} \\quad \\text{for } z_k \\le z_{\\mathrm{tp}, i}^{\\star}. $$\nAbove $z_{\\mathrm{tp}, i}^{\\star}$, the atmosphere is more stable with a lapse rate of $-1.0\\,\\mathrm{K\\,km^{-1}}$ (i.e., temperature decreases at $1.0\\,\\mathrm{K\\,km^{-1}}$):\n$$ T_i(k) = T(z_{\\mathrm{tp}, i}^{\\star}) - 1.0 \\times \\frac{z_k - z_{\\mathrm{tp}, i}^{\\star}}{1000} \\quad \\text{for } z_k > z_{\\mathrm{tp}, i}^{\\star}, $$\nwhere $T(z_{\\mathrm{tp}, i}^{\\star})$ is the temperature at the reference tropopause height, evaluated using the tropospheric profile.\n\nThe potential vorticity $q_i(k)$, in Potential Vorticity Units (PVU), is constructed from a background profile that increases linearly with level index $k$ and varies with column index $i$, plus a sharp increase of $2.0\\,\\mathrm{PVU}$ at and above the reference tropopause height $z_{\\mathrm{tp}, i}^{\\star}$:\n$$ q_i(k) = (0.5 + 0.15k + 0.1i) + \\Delta q_i(k), \\quad \\text{where } \\Delta q_i(k) = \\begin{cases} 0, & z_k < z_{\\mathrm{tp}, i}^{\\star} \\\\ 2.0, & z_k \\ge z_{\\mathrm{tp}, i}^{\\star} \\end{cases}. $$\n\nThe vertical velocity $w_i(k)$ in $\\mathrm{m\\,s^{-1}}$ is given by a sinusoidal function of height and column index, plus a constant downward offset:\n$$ w_i(k) = 0.02 \\sin\\left(\\frac{\\pi}{4} \\left(\\frac{z_k}{1000} - 6 + 0.5i\\right)\\right) - 0.005. $$\n\nThe tracer mass mixing ratio $\\chi_i(k)$ in $\\mathrm{kg\\,kg^{-1}}$ is defined piecewise with different gradients below and above $z_{\\mathrm{tp}, i}^{\\star}$, including a step increase of $3 \\times 10^{-6}\\,\\mathrm{kg\\,kg^{-1}}$ at the transition, modeling a stratospheric tracer.\n\nThe air density $\\rho_i(k)$ in $\\mathrm{kg\\,m^{-3}}$ follows an exponential decay with height (isothermal atmosphere approximation), with a specified scale height $H = 7000\\,\\mathrm{m}$ and a column-dependent reference density $\\rho_{6,i} = 0.66(1 + 0.03(i-1.5))\\,\\mathrm{kg\\,m^{-3}}$ at the base height $z_0=6000\\,\\mathrm{m}$:\n$$ \\rho_i(k) = \\rho_{6,i} \\exp\\left(-\\frac{z_k - 6000}{H}\\right). $$\n\nWith the physical fields defined, the core of the algorithm is to diagnose the tropopause level index $k_{\\mathrm{tp}, i}$ for each column $i$ based on one of three methods.\n\n1.  PV-based Definition: For a given PV threshold $q_t$, we search for the lowest level index $k \\in \\{0, \\dots, N_z-1\\}$ such that $q_i(k) \\ge q_t$ and either $k=0$ or $q_i(k-1) < q_t$. If no such level is found, the tropopause is assigned to the highest model level, $k_{\\mathrm{tp}, i} = N_z - 1$.\n\n2.  Thermal Lapse-Rate Definition: First, we compute the lapse rate $\\Gamma_i(k)$ in $\\mathrm{K\\,km^{-1}}$ between adjacent levels using $\\Gamma_i(k) = -\\frac{T_i(k+1) - T_i(k)}{z_{k+1} - z_k} \\times 1000$ for $k \\in \\{0, \\dots, N_z-2\\}$. Since $z_{k+1} - z_k = 1000\\,\\mathrm{m}$, this simplifies to $\\Gamma_i(k) = -(T_i(k+1) - T_i(k))$. For a given threshold $\\gamma_t$, we find the lowest index $k$ where $\\Gamma_i(k) \\le \\gamma_t$. The tropopause level is then set to $k_{\\mathrm{tp}, i} = k + 1$. If this condition is never met, we again default to the highest level, $k_{\\mathrm{tp}, i} = N_z - 1$.\n\n3.  Hybrid Definition: This method synthesizes the PV and thermal definitions. We first attempt to find a tropopause using both methods. Let these be $k_{\\mathrm{pv}}$ and $k_{\\mathrm{th}}$, and we track whether each was found via a true threshold crossing or by defaulting to the highest level.\n    - If both methods yield a valid crossing, we select the one corresponding to the greater geometric height, i.e., the larger level index.\n    - If only one method yields a valid crossing, we use its resulting index.\n    - If neither method finds a crossing, we use a default of the highest level index, $N_z - 1$.\n\nFinally, for each test case, we compute the total downward tracer flux $\\mathcal{F}_{\\downarrow}$. For a given tropopause definition and its associated thresholds, we iterate through each column $i=0, \\dots, N_x-1$:\na. Determine the tropopause level index $k_{\\mathrm{tp}, i}$.\nb. Retrieve the values of density $\\rho_i(k_{\\mathrm{tp}, i})$, vertical velocity $w_i(k_{\\mathrm{tp}, i})$, and tracer mixing ratio $\\chi_i(k_{\\mathrm{tp}, i})$ at this level.\nc. Calculate the downward flux contribution from this column. This is non-zero only for downward motion ($w_i < 0$). The contribution is $\\rho_i(k_{\\mathrm{tp}, i}) \\times \\max(-w_i(k_{\\mathrm{tp}, i}), 0) \\times \\chi_i(k_{\\mathrm{tp}, i}) \\times \\Delta A$.\nd. Sum these contributions over all columns to obtain the total flux $\\mathcal{F}_{\\downarrow}$ in $\\mathrm{kg\\,s^{-1}}$.\n\nThe final result for each test case is rounded to $6$ decimal places as specified. The overall algorithm is implemented by pre-calculating all physical fields on the grid and then applying the diagnostic procedures for each case in the test suite.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes stratosphere-troposphere exchange flux for a suite of test cases.\n    \"\"\"\n    # 1. Define domain and constants\n    Nx = 4\n    Nz = 10\n    i_indices = np.arange(Nx)\n    k_indices = np.arange(Nz)\n    \n    z_k = 6000.0 + 1000.0 * k_indices  # meters\n    DeltaA = 1.0e10  # m^2\n    H = 7000.0  # meters\n\n    # 2. Generate the physical fields\n    \n    # Pre-allocate arrays\n    T = np.zeros((Nx, Nz))\n    q = np.zeros((Nx, Nz))\n    w = np.zeros((Nx, Nz))\n    chi = np.zeros((Nx, Nz))\n    rho = np.zeros((Nx, Nz))\n    \n    z_tp_star = 10000.0 + 500.0 * (i_indices - 1.5)\n    \n    # Base temperature at z=6000m\n    T0_i = 245.0 - 2.0 * i_indices\n    \n    # Base density at z=6000m\n    rho6_i = 0.66 * (1.0 + 0.03 * (i_indices - 1.5))\n    \n    for i in i_indices:\n        # Temperature\n        T_at_ztp_star = T0_i[i] - 6.5 * (z_tp_star[i] - 6000.0) / 1000.0\n        chi_at_ztp_star = 4e-6 + 0.5e-6 * (z_tp_star[i] - 6000.0) / 1000.0\n        \n        for k in k_indices:\n            zk = z_k[k]\n            \n            # Temperature T\n            if zk <= z_tp_star[i]:\n                T[i, k] = T0_i[i] - 6.5 * (zk - 6000.0) / 1000.0\n            else:\n                T[i, k] = T_at_ztp_star - 1.0 * (zk - z_tp_star[i]) / 1000.0\n            \n            # Potential Vorticity q\n            delta_q = 2.0 if zk >= z_tp_star[i] else 0.0\n            q[i, k] = (0.5 + 0.15 * k + 0.1 * i) + delta_q\n            \n            # Vertical Velocity w\n            w[i, k] = 0.02 * np.sin(np.pi / 4.0 * (zk / 1000.0 - 6.0 + 0.5 * i)) - 0.005\n            \n            # Tracer mixing ratio chi\n            if zk <= z_tp_star[i]:\n                chi[i, k] = 4e-6 + 0.5e-6 * (zk - 6000.0) / 1000.0\n            else:\n                chi[i, k] = chi_at_ztp_star + 3e-6 + 0.3e-6 * (zk - z_tp_star[i]) / 1000.0\n            \n            # Density rho\n            rho[i, k] = rho6_i[i] * np.exp(-(zk - 6000.0) / H)\n\n    # 3. Implement Tropopause Finders\n    \n    def find_pv_tropopause(i, q_t):\n        for k in k_indices:\n            is_crossing = q[i, k] >= q_t\n            if k == 0:\n                if is_crossing:\n                    return k, True # Found at lowest level\n            else:\n                if is_crossing and q[i, k-1] < q_t:\n                    return k, True # Found crossing\n        return Nz - 1, False # Not found, default to top\n\n    def find_thermal_tropopause(i, gamma_t):\n        # Lapse rate Gamma is defined for k in {0, ..., Nz-2}\n        for k in range(Nz - 1):\n            # z_{k+1} - z_k = 1000, so factor of 1000 cancels\n            gamma_k = -(T[i, k+1] - T[i, k])\n            if gamma_k <= gamma_t:\n                return k + 1, True # Tropopause is at level k+1\n        return Nz - 1, False # Not found, default to top\n        \n    def find_hybrid_tropopause(i, q_t, gamma_t):\n        k_pv, found_pv = find_pv_tropopause(i, q_t)\n        k_th, found_th = find_thermal_tropopause(i, gamma_t)\n        \n        if found_pv and found_th:\n            # Both found, pick higher altitude\n            return k_pv if z_k[k_pv] >= z_k[k_th] else k_th\n        elif found_pv:\n            return k_pv\n        elif found_th:\n            return k_th\n        else:\n            # Neither found, default to top\n            return Nz - 1\n\n    # 4. Process test suite and calculate fluxes\n\n    test_cases = [\n        (\"PV\", 2.0, 2.0),\n        (\"PV\", 3.5, 2.0),\n        (\"TH\", 2.0, 2.0),\n        (\"TH\", 2.0, 1.5),\n        (\"HYB\", 2.0, 2.0),\n        (\"HYB\", 3.5, 1.5),\n        (\"PV\", 6.0, 2.0),\n        (\"TH\", 2.0, 0.5),\n    ]\n\n    results = []\n    \n    for case_def, q_t, gamma_t in test_cases:\n        total_flux = 0.0\n        for i in i_indices:\n            if case_def == \"PV\":\n                k_tp, _ = find_pv_tropopause(i, q_t)\n            elif case_def == \"TH\":\n                k_tp, _ = find_thermal_tropopause(i, gamma_t)\n            elif case_def == \"HYB\":\n                k_tp = find_hybrid_tropopause(i, q_t, gamma_t)\n            \n            # Retrieve values at tropopause level\n            rho_tp = rho[i, k_tp]\n            w_tp = w[i, k_tp]\n            chi_tp = chi[i, k_tp]\n            \n            # Calculate downward flux contribution\n            downward_mass_flux_per_area = rho_tp * max(-w_tp, 0)\n            flux_contribution = downward_mass_flux_per_area * chi_tp * DeltaA\n            total_flux += flux_contribution\n            \n        results.append(round(total_flux, 6))\n\n    # 5. Final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}