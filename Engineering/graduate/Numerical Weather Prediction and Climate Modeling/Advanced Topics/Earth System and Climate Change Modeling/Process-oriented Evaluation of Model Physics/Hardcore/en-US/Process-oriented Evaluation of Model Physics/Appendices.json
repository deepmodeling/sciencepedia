{
    "hands_on_practices": [
        {
            "introduction": "The conservation of energy at the land surface, governed by the balance $R_n = H + LE + G$, is a fundamental constraint that all physical models must respect. However, parameterizations designed for computational efficiency can sometimes violate this principle, leading to unrealistic long-term drifts in climate simulations. This exercise  provides a clear, analytical method for quantifying the daily-integrated energy imbalance of a model scheme under idealized diurnal forcing, honing your ability to diagnose foundational model biases.",
            "id": "4079638",
            "problem": "A process-oriented evaluation of land-surface model physics in Numerical Weather Prediction (NWP) requires diagnosing flux partitioning and energy conservation across the diurnal cycle. Consider a homogeneous land site with an eddy-covariance tower providing observed net all-wave radiation $R_n(t)$, turbulent sensible heat flux $H(t)$, and turbulent latent heat flux $LE(t)$, all in $\\mathrm{W\\,m^{-2}}$. The latent heat flux $LE(t)$ is the product of the latent heat of vaporization and the evaporation rate, but is treated here simply as a measured flux. Assume the surface energy balance is governed by conservation of energy at the land surface, neglecting storage terms other than the soil/ground heat flux $G(t)$ over the tower footprint. Let time $t$ be measured in seconds from local midnight, and one diurnal cycle be $T = 86400$.\n\nTo emulate a clear-sky warm-season day, the observed fluxes are represented by the following diurnally periodic functions with radian phases:\n$$\nR_n(t) = R_0 + A_R \\cos(\\omega t) - B_R \\cos(2\\omega t), \\quad \\omega = \\frac{2\\pi}{T},\n$$\n$$\nH(t) = H_0 + A_H \\cos(\\omega t - \\phi_H),\n$$\n$$\nLE(t) = LE_0 + A_{LE} \\cos(\\omega t - \\phi_{LE}),\n$$\nwith constants $R_0 = 80$, $A_R = 220$, $B_R = 30$, $H_0 = 35$, $A_H = 160$, $\\phi_H = \\frac{\\pi}{6}$, $LE_0 = 40$, $A_{LE} = 120$, and $\\phi_{LE} = \\frac{\\pi}{4}$.\n\nA land-surface model (LSM) embedded in the NWP system predicts the soil heat flux using a simple parameterization intended to capture a combination of radiative forcing partitioning and thermal inertia:\n$$\n\\hat{G}(t) = \\alpha\\,R_n(t) - \\tau\\,\\frac{d R_n}{dt},\n$$\nwith $\\alpha = 0.12$ and $\\tau = 1200$.\n\nTasks:\n1. Starting from conservation of energy at the land surface, derive the residual ground heat flux $G_{\\mathrm{res}}(t)$ implied by the observations.\n2. Define the model’s daily integrated energy imbalance under the given diurnal forcing as\n$$\nI \\equiv \\int_{0}^{T} \\big(R_n(t) - H(t) - LE(t) - \\hat{G}(t)\\big)\\,dt,\n$$\nand derive a closed-form analytical expression for $I$ from the given representations and parameters.\n3. Compute the numerical value of $I$ and determine whether the model’s land scheme conserves energy under the diurnal forcing (exact conservation corresponds to $I = 0$). Round your final numerical answer to four significant figures and express the final energy in $\\mathrm{kJ\\,m^{-2}}$. Angles are to be treated in radians throughout.",
            "solution": "The problem is first validated against the specified criteria.\n\n### Step 1: Extract Givens\nThe given quantities and relationships are:\n-   Net all-wave radiation: $R_n(t) = R_0 + A_R \\cos(\\omega t) - B_R \\cos(2\\omega t)$, in $\\mathrm{W\\,m^{-2}}$\n-   Turbulent sensible heat flux: $H(t) = H_0 + A_H \\cos(\\omega t - \\phi_H)$, in $\\mathrm{W\\,m^{-2}}$\n-   Turbulent latent heat flux: $LE(t) = LE_0 + A_{LE} \\cos(\\omega t - \\phi_{LE})$, in $\\mathrm{W\\,m^{-2}}$\n-   Duration of a diurnal cycle: $T = 86400$ s\n-   Angular frequency: $\\omega = \\frac{2\\pi}{T}$\n-   Constants for $R_n(t)$: $R_0 = 80$, $A_R = 220$, $B_R = 30$\n-   Constants for $H(t)$: $H_0 = 35$, $A_H = 160$, $\\phi_H = \\frac{\\pi}{6}$\n-   Constants for $LE(t)$: $LE_0 = 40$, $A_{LE} = 120$, $\\phi_{LE} = \\frac{\\pi}{4}$\n-   Model parameterization for soil heat flux: $\\hat{G}(t) = \\alpha\\,R_n(t) - \\tau\\,\\frac{d R_n}{dt}$\n-   Constants for $\\hat{G}(t)$: $\\alpha = 0.12$, $\\tau = 1200$\n-   Definition of daily integrated energy imbalance: $I \\equiv \\int_{0}^{T} \\big(R_n(t) - H(t) - LE(t) - \\hat{G}(t)\\big)\\,dt$\n-   Principle of surface energy balance: Conservation of energy at the land surface, an implicit statement of $R_n(t) = H(t) + LE(t) + G(t)$, where $G(t)$ is the true ground heat flux.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded in the principles of micrometeorology and land-surface modeling. The surface energy balance is a fundamental concept. The functional forms for the fluxes are idealized but common representations for diurnal cycles in clear-sky conditions. The parameterization of the soil heat flux, $\\hat{G}(t)$, is a simplified form related to force-restore methods used in land-surface models. The problem is well-posed, providing all necessary functions, constants, and definitions to perform the requested tasks. The language is objective and technical. The setup is self-contained and free of contradictions. The problem requires the application of integral calculus to analyze a physically relevant model's performance, which is a standard task in model evaluation. Therefore, the problem is deemed valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. A solution will be provided.\n\n### Solution Derivation\n\n**Task 1: Derive the residual ground heat flux $G_{\\mathrm{res}}(t)$**\n\nThe principle of conservation of energy at the land surface states that the net radiation must be balanced by the sum of the turbulent fluxes (sensible and latent heat) and the ground heat flux. The residual ground heat flux, $G_{\\mathrm{res}}(t)$, is defined as the term that perfectly closes this budget based on the observed fluxes.\n$$\nR_n(t) = H(t) + LE(t) + G_{\\mathrm{res}}(t)\n$$\nSolving for $G_{\\mathrm{res}}(t)$:\n$$\nG_{\\mathrm{res}}(t) = R_n(t) - H(t) - LE(t)\n$$\nSubstituting the given functional forms:\n$$\nG_{\\mathrm{res}}(t) = \\left(R_0 + A_R \\cos(\\omega t) - B_R \\cos(2\\omega t)\\right) - \\left(H_0 + A_H \\cos(\\omega t - \\phi_H)\\right) - \\left(LE_0 + A_{LE} \\cos(\\omega t - \\phi_{LE})\\right)\n$$\nThis expression represents the ground heat flux that is implied by the observational data and the principle of energy conservation.\n\n**Task 2: Derive a closed-form analytical expression for $I$**\n\nThe model's daily integrated energy imbalance $I$ is defined as:\n$$\nI = \\int_{0}^{T} \\big(R_n(t) - H(t) - LE(t) - \\hat{G}(t)\\big)\\,dt\n$$\nWe can break this integral into the sum of integrals of each term:\n$$\nI = \\int_{0}^{T} R_n(t)\\,dt - \\int_{0}^{T} H(t)\\,dt - \\int_{0}^{T} LE(t)\\,dt - \\int_{0}^{T} \\hat{G}(t)\\,dt\n$$\nWe evaluate each integral over one full period $T = \\frac{2\\pi}{\\omega}$. The integral of a cosine function of the form $\\cos(n\\omega t + \\phi)$ over one or more full periods is zero for any integer $n \\neq 0$.\n\nIntegral of $R_n(t)$:\n$$\n\\int_{0}^{T} R_n(t)\\,dt = \\int_{0}^{T} \\left(R_0 + A_R \\cos(\\omega t) - B_R \\cos(2\\omega t)\\right)\\,dt\n$$\n$$\n= \\int_{0}^{T} R_0\\,dt + A_R \\int_{0}^{T} \\cos(\\omega t)\\,dt - B_R \\int_{0}^{T} \\cos(2\\omega t)\\,dt\n$$\nThe cosine integrals are zero, so:\n$$\n\\int_{0}^{T} R_n(t)\\,dt = R_0 [t]_{0}^{T} = R_0 T\n$$\n\nIntegral of $H(t)$:\n$$\n\\int_{0}^{T} H(t)\\,dt = \\int_{0}^{T} \\left(H_0 + A_H \\cos(\\omega t - \\phi_H)\\right)\\,dt = \\int_{0}^{T} H_0\\,dt + A_H \\int_{0}^{T} \\cos(\\omega t - \\phi_H)\\,dt = H_0 T\n$$\n\nIntegral of $LE(t)$:\n$$\n\\int_{0}^{T} LE(t)\\,dt = \\int_{0}^{T} \\left(LE_0 + A_{LE} \\cos(\\omega t - \\phi_{LE})\\right)\\,dt = \\int_{0}^{T} LE_0\\,dt + A_{LE} \\int_{0}^{T} \\cos(\\omega t - \\phi_{LE})\\,dt = LE_0 T\n$$\n\nIntegral of $\\hat{G}(t)$:\nThe model for ground heat flux is $\\hat{G}(t) = \\alpha\\,R_n(t) - \\tau\\,\\frac{d R_n}{dt}$.\n$$\n\\int_{0}^{T} \\hat{G}(t)\\,dt = \\int_{0}^{T} \\left(\\alpha\\,R_n(t) - \\tau\\,\\frac{d R_n}{dt}\\right)\\,dt = \\alpha \\int_{0}^{T} R_n(t)\\,dt - \\tau \\int_{0}^{T} \\frac{d R_n}{dt}\\,dt\n$$\nThe first term is $\\alpha \\int_{0}^{T} R_n(t)\\,dt = \\alpha (R_0 T)$.\nThe second term is an integral of a total derivative:\n$$\n\\int_{0}^{T} \\frac{d R_n}{dt}\\,dt = R_n(T) - R_n(0)\n$$\nSince $R_n(t)$ is periodic with period $T$, $R_n(T) = R_n(0)$. Therefore, this term is zero.\n$$\n\\int_{0}^{T} \\hat{G}(t)\\,dt = \\alpha R_0 T\n$$\nThis demonstrates that the time-derivative component of the soil heat flux parameterization does not contribute to the net energy exchange over a complete diurnal cycle.\n\nNow, we assemble the expression for $I$:\n$$\nI = R_0 T - H_0 T - LE_0 T - \\alpha R_0 T\n$$\nFactoring out $T$:\n$$\nI = T \\left( R_0 - H_0 - LE_0 - \\alpha R_0 \\right)\n$$\nAnd rearranging:\n$$\nI = T \\left( (1-\\alpha)R_0 - H_0 - LE_0 \\right)\n$$\nThis is the closed-form analytical expression for the model's daily integrated energy imbalance.\n\n**Task 3: Compute the numerical value of $I$**\n\nWe substitute the given numerical values into the derived expression for $I$.\nGiven:\n- $T = 86400$ s\n- $\\alpha = 0.12$\n- $R_0 = 80$ W m$^{-2}$\n- $H_0 = 35$ W m$^{-2}$\n- $LE_0 = 40$ W m$^{-2}$\n\n$$\nI = 86400 \\times \\left( (1 - 0.12) \\times 80 - 35 - 40 \\right)\n$$\n$$\nI = 86400 \\times \\left( (0.88) \\times 80 - (35 + 40) \\right)\n$$\n$$\nI = 86400 \\times \\left( 70.4 - 75 \\right)\n$$\n$$\nI = 86400 \\times (-4.6)\n$$\n$$\nI = -397440 \\,\\mathrm{J\\,m^{-2}}\n$$\nThe problem requires the answer in units of kilojoules per square meter ($\\mathrm{kJ\\,m^{-2}}$).\n$$\nI = \\frac{-397440}{1000} \\,\\mathrm{kJ\\,m^{-2}} = -397.44 \\,\\mathrm{kJ\\,m^{-2}}\n$$\nRounding to four significant figures gives:\n$$\nI = -397.4 \\,\\mathrm{kJ\\,m^{-2}}\n$$\nSince $I \\neq 0$, the model's land scheme does not conserve energy under this diurnal forcing. The negative sign indicates a net loss of energy from the system over the course of one day, meaning the model parameterization creates a spurious energy sink of $397.4\\,\\mathrm{kJ\\,m^{-2}}$ per day.",
            "answer": "$$\n\\boxed{-397.4}\n$$"
        },
        {
            "introduction": "Model parameterizations often contain tunable coefficients that must be constrained by observations to ensure physical realism. This practice  delves into the atmospheric boundary layer, using the foundational Monin-Obukhov Similarity Theory to connect observable quantities to model physics. By calculating a key parameter in a stability function from field data, you will perform a fundamental task in model development: ensuring the parameterized relationship between turbulent fluxes and mean gradients aligns with observations.",
            "id": "4079679",
            "problem": "Consider a nocturnal, stably stratified atmospheric boundary layer (ABL) over homogeneous grassland at height $z = 10~\\mathrm{m}$. The turbulent fluxes and mean profiles are consistent with Monin–Obukhov Similarity Theory (MOST). Let the von Kármán constant be $\\kappa = 0.40$. Observations provide a friction velocity $u_{*} = 0.25~\\mathrm{m\\,s^{-1}}$, a mean wind shear $\\partial U/\\partial z = 0.12~\\mathrm{s^{-1}}$, and a Monin–Obukhov length $L = 80~\\mathrm{m}$.\n\nA first-order closure scheme for the momentum flux uses a stability-dependent mixing length $l$ and an eddy diffusivity $K_{m}$ defined by the model’s process-oriented physics as follows: the non-dimensional shear function $\\phi_{m}$ connects the mean shear to the turbulent scales through MOST, the mixing length is $l = \\kappa z / \\phi_{m}$, and the eddy diffusivity is $K_{m} = l^{2}\\,|\\partial U/\\partial z|$. In this scheme, the stability function is parameterized for stable stratification as $\\phi_{m}(z/L) = 1 + a\\,(z/L)$, where $a$ is a dimensionless constant to be estimated from observations.\n\nUsing the MOST definition of non-dimensional shear $\\phi_{m}$ and the provided observations:\n- Derive the observed $\\phi_{m}$ at $z = 10~\\mathrm{m}$.\n- Compute the mixing length $l$ and eddy diffusivity $K_{m}$ at $z = 10~\\mathrm{m}$ (express $l$ in $\\mathrm{m}$ and $K_{m}$ in $\\mathrm{m^{2}\\,s^{-1}}$).\n- Impose the requirement that the scheme’s $\\phi_{m}(z/L)$ equals the observed $\\phi_{m}$ to solve for the constant $a$.\n\nProvide your final answer as the estimated constant $a$ rounded to four significant figures. The final answer must be dimensionless and presented without units.",
            "solution": "The problem statement is scientifically grounded, well-posed, and objective. It is based on the established principles of Monin–Obukhov Similarity Theory (MOST) for the atmospheric boundary layer. The provided data are physically realistic and sufficient to determine a unique solution for the requested quantities. The definitions provided for the model's physics, while specific, are internally consistent and coherent with the underlying theory. Therefore, the problem is valid, and a solution can be derived.\n\nThe problem requires us to evaluate a first-order closure scheme against observational data within the MOST framework. The first step is to determine the \"observed\" non-dimensional wind shear, $\\phi_{m}$, from the provided measurements. According to Monin–Obukhov Similarity Theory, $\\phi_{m}$ is defined as:\n$$\n\\phi_{m} = \\frac{\\kappa z}{u_{*}} \\frac{\\partial U}{\\partial z}\n$$\nHere, $\\kappa$ is the von Kármán constant, $z$ is the height above the ground, $u_{*}$ is the friction velocity, and $\\partial U/\\partial z$ is the mean vertical wind shear. The provided observational data at height $z = 10~\\mathrm{m}$ are: $\\kappa = 0.40$, $u_{*} = 0.25~\\mathrm{m\\,s^{-1}}$, and $\\partial U/\\partial z = 0.12~\\mathrm{s^{-1}}$.\n\nSubstituting these values into the definition of $\\phi_{m}$ gives the observed value, which we denote as $\\phi_{m, \\text{obs}}$:\n$$\n\\phi_{m, \\text{obs}} = \\frac{(0.40)(10~\\mathrm{m})}{0.25~\\mathrm{m\\,s^{-1}}} (0.12~\\mathrm{s^{-1}})\n$$\n$$\n\\phi_{m, \\text{obs}} = \\frac{4.0}{0.25} \\times 0.12 = 16 \\times 0.12 = 1.92\n$$\nThis value is dimensionless, as expected.\n\nNext, we are asked to compute the mixing length $l$ and the eddy diffusivity for momentum $K_{m}$ at the same height, using the model's specified definitions. The model defines the mixing length as:\n$$\nl = \\frac{\\kappa z}{\\phi_{m}}\n$$\nUsing the observed value $\\phi_{m, \\text{obs}} = 1.92$, we calculate $l$:\n$$\nl = \\frac{(0.40)(10~\\mathrm{m})}{1.92} = \\frac{4.0}{1.92}~\\mathrm{m} \\approx 2.0833~\\mathrm{m}\n$$\nExpressing this as an exact fraction:\n$$\nl = \\frac{4}{1.92} = \\frac{400}{192} = \\frac{100}{48} = \\frac{25}{12}~\\mathrm{m}\n$$\nThe eddy diffusivity $K_{m}$ is defined by the model's physics as:\n$$\nK_{m} = l^{2} \\left| \\frac{\\partial U}{\\partial z} \\right|\n$$\nSubstituting the value for $l$ we just found and the given wind shear $\\partial U/\\partial z = 0.12~\\mathrm{s^{-1}}$ (which is positive, so the absolute value is redundant):\n$$\nK_{m} = \\left(\\frac{25}{12}~\\mathrm{m}\\right)^{2} (0.12~\\mathrm{s^{-1}}) = \\frac{625}{144}~\\mathrm{m}^{2} \\times \\frac{12}{100}~\\mathrm{s^{-1}}\n$$\n$$\nK_{m} = \\frac{625 \\times 12}{144 \\times 100}~\\mathrm{m^{2}\\,s^{-1}} = \\frac{625}{12 \\times 100}~\\mathrm{m^{2}\\,s^{-1}} = \\frac{625}{1200}~\\mathrm{m^{2}\\,s^{-1}} = \\frac{25}{48}~\\mathrm{m^{2}\\,s^{-1}}\n$$\nNumerically, $K_{m} \\approx 0.5208~\\mathrm{m^{2}\\,s^{-1}}$.\n\nFinally, the problem asks us to determine the dimensionless constant $a$ from the model's parameterization for $\\phi_{m}$ in stable conditions:\n$$\n\\phi_{m}\\left(\\frac{z}{L}\\right) = 1 + a \\frac{z}{L}\n$$\nTo estimate $a$, we enforce that the model's $\\phi_{m}$ must equal the observed value $\\phi_{m, \\text{obs}}$ at the specified height. First, we calculate the stability parameter $z/L$ using the given data: $z = 10~\\mathrm{m}$ and the Monin–Obukhov length $L = 80~\\mathrm{m}$.\n$$\n\\frac{z}{L} = \\frac{10~\\mathrm{m}}{80~\\mathrm{m}} = \\frac{1}{8} = 0.125\n$$\nNow, we set the parameterized $\\phi_m$ equal to the observed value $\\phi_{m, \\text{obs}} = 1.92$:\n$$\n1.92 = 1 + a (0.125)\n$$\nSolving for $a$:\n$$\na \\times 0.125 = 1.92 - 1\n$$\n$$\n0.125 a = 0.92\n$$\n$$\na = \\frac{0.92}{0.125} = \\frac{0.92}{1/8} = 0.92 \\times 8 = 7.36\n$$\nThe value of the constant $a$ is exactly $7.36$. The problem requires the answer to be rounded to four significant figures. Therefore, we express the result as $7.360$.",
            "answer": "$$\n\\boxed{7.360}\n$$"
        },
        {
            "introduction": "A critical aspect of process-oriented evaluation is assessing not just *what* a model predicts, but *how* it achieves that prediction. Distinguishing between convective and stratiform precipitation is crucial for understanding a model's representation of a storm system's structure, dynamics, and radiative impact. This computational exercise  guides you through implementing and applying classification algorithms to both model output and radar observations, providing a powerful method for evaluating the realism of the model's precipitation processes against an observational benchmark.",
            "id": "4079650",
            "problem": "You are given a process-oriented evaluation task for model physics in numerical weather prediction and climate modeling. The goal is to partition rain rates into convective and stratiform components using physically motivated criteria applied to model outputs and to radar-derived fields, then compare the resulting partitions to assess process realism. Your program must implement the definitions, conversions, and criteria provided below and compute specified metrics for a set of test cases. All rain rates must be expressed in millimeters per hour (mm/h), and any angles, if they appeared, would need explicit units; no angles are involved here. You must produce a single-line output that aggregates results for all test cases exactly as specified at the end.\n\nFundamental bases and definitions:\n- Precipitation rate is a flux and obeys conservation of mass. For liquid rain, the Weather Surveillance Radar reflectivity factor $Z$ relates to the drop size distribution $N(D)$ through $Z = \\int_0^{\\infty} N(D) D^6 \\,\\mathrm{d}D$, and is empirically related to rain rate $R$ via a widely used power-law known as the Marshall–Palmer relation: $$R = a Z^b.$$ Use $a = 0.017$ and $b = 0.714$, with $R$ in $\\mathrm{mm}/\\mathrm{h}$ and $Z$ in $\\mathrm{mm}^6\\,\\mathrm{m}^{-3}$.\n- Radar reflectivity in decibels relative to $Z$ (dBZ) is given by $\\mathrm{dBZ} = 10 \\log_{10}(Z)$. Therefore, $Z = 10^{\\mathrm{dBZ}/10}$.\n- To suppress non-precipitating echoes, define a minimum reflectivity threshold $\\mathrm{dBZ}_{\\min} = 10$. If a pixel has $\\mathrm{dBZ}  \\mathrm{dBZ}_{\\min}$, set its radar-derived rain rate to $0$.\n\nPartitioning criteria:\n- Model-based convective classification: Given a model surface rain rate field $R_{\\mathrm{mod}}(x,y)$ and a column maximum vertical velocity field $w_{\\max}(x,y)$, classify a grid cell $(x,y)$ as convective if either $R_{\\mathrm{mod}}(x,y) \\ge R_c$ or $w_{\\max}(x,y) \\ge w_c$, otherwise classify it as stratiform. Use $R_c = 15$ and $w_c = 3$, where $R_c$ is in $\\mathrm{mm}/\\mathrm{h}$ and $w_c$ is in $\\mathrm{m}/\\mathrm{s}$.\n- Radar-based convective classification (simplified Steiner–Houze criterion): Given a radar reflectivity field in dBZ, classify a grid cell $(x,y)$ as convective if either $\\mathrm{dBZ}(x,y) \\ge Z_{\\mathrm{abs}}$ or $$\\mathrm{dBZ}(x,y) - \\overline{\\mathrm{dBZ}}_{\\mathrm{nbr}}(x,y) \\ge \\Delta Z,$$ where $\\overline{\\mathrm{dBZ}}_{\\mathrm{nbr}}(x,y)$ is the mean dBZ in a square neighborhood of radius $r$ grid cells around $(x,y)$, excluding the center cell. Use $Z_{\\mathrm{abs}} = 40$ (in dBZ), $\\Delta Z = 10$ (in dBZ), and $r = 1$ grid cell (i.e., a $3 \\times 3$ window).\n- Rain-rate partitioning: For a field $R(x,y)$ and a corresponding boolean convective mask $C(x,y)$ ($C=1$ for convective, $C=0$ for stratiform), define convective rain rate field $$R_{\\mathrm{conv}}(x,y) = C(x,y)\\,R(x,y),$$ and stratiform rain rate field $$R_{\\mathrm{strat}}(x,y) = (1 - C(x,y))\\,R(x,y).$$\n\nMetrics:\n- Convective fraction for a domain $\\mathcal{D}$ is $$f_{\\mathrm{conv}} = \\frac{\\sum_{(x,y)\\in \\mathcal{D}} R_{\\mathrm{conv}}(x,y)}{\\sum_{(x,y)\\in \\mathcal{D}} R(x,y)}.$$ If the denominator is zero, define $f_{\\mathrm{conv}} = 0$ by convention.\n- Fraction difference is $$\\Delta f = f_{\\mathrm{conv,mod}} - f_{\\mathrm{conv,rad}}.$$\n- Root-mean-square error (RMSE) of convective rain-rate partitions is $$\\mathrm{RMSE} = \\sqrt{\\frac{1}{N}\\sum_{(x,y)\\in \\mathcal{D}} \\big(R_{\\mathrm{conv,mod}}(x,y) - R_{\\mathrm{conv,rad}}(x,y)\\big)^2},$$ where $N$ is the number of grid cells in $\\mathcal{D}$.\n\nTest suite:\nFor each test case, you are given gridded fields on a $5 \\times 5$ domain. Arrays are listed row-wise. All numbers are in the units specified.\n\n- Test Case $1$ (mixed convective core):\n    - $R_{\\mathrm{mod}}$ (in $\\mathrm{mm}/\\mathrm{h}$):\n      $[ [3,3,3,3,3], [3,10,20,10,3], [3,20,40,20,3], [3,10,20,10,3], [3,3,3,3,3] ]$\n    - $w_{\\max}$ (in $\\mathrm{m}/\\mathrm{s}$):\n      $[ [0.2,0.2,0.2,0.2,0.2], [0.2,1.0,2.0,1.0,0.2], [0.2,2.0,5.0,2.0,0.2], [0.2,1.0,2.0,1.0,0.2], [0.2,0.2,0.2,0.2,0.2] ]$\n    - Radar $\\mathrm{dBZ}$:\n      $[ [25,25,25,25,25], [25,35,40,35,25], [25,40,48,40,25], [25,35,40,35,25], [25,25,25,25,25] ]$\n\n- Test Case $2$ (uniform stratiform drizzle):\n    - $R_{\\mathrm{mod}}$ (in $\\mathrm{mm}/\\mathrm{h}$):\n      $[ [1,1,1,1,1], [1,1,1,1,1], [1,1,2,1,1], [1,1,1,1,1], [1,1,1,1,1] ]$\n    - $w_{\\max}$ (in $\\mathrm{m}/\\mathrm{s}$):\n      $[ [0.2,0.2,0.2,0.2,0.2], [0.2,0.2,0.2,0.2,0.2], [0.2,0.2,0.2,0.2,0.2], [0.2,0.2,0.2,0.2,0.2], [0.2,0.2,0.2,0.2,0.2] ]$\n    - Radar $\\mathrm{dBZ}$:\n      $[ [22,22,22,22,22], [22,22,22,22,22], [22,22,22,22,22], [22,22,22,22,22], [22,22,22,22,22] ]$\n\n- Test Case $3$ (no rain edge case):\n    - $R_{\\mathrm{mod}}$ (in $\\mathrm{mm}/\\mathrm{h}$):\n      $[ [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0] ]$\n    - $w_{\\max}$ (in $\\mathrm{m}/\\mathrm{s}$):\n      $[ [0.1,0.1,0.1,0.1,0.1], [0.1,0.1,0.1,0.1,0.1], [0.1,0.1,0.1,0.1,0.1], [0.1,0.1,0.1,0.1,0.1], [0.1,0.1,0.1,0.1,0.1] ]$\n    - Radar $\\mathrm{dBZ}$:\n      $[ [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0], [0,0,0,0,0] ]$\n\nRequired final output format:\nYour program should produce a single line of output containing the results for the three test cases as a comma-separated list enclosed in square brackets, where each element is itself a list of four floats in the order $[f_{\\mathrm{conv,mod}}, f_{\\mathrm{conv,rad}}, \\Delta f, \\mathrm{RMSE}]$. For example, the output structure must be like $[[x_1,x_2,x_3,x_4],[y_1,y_2,y_3,y_4],[z_1,z_2,z_3,z_4]]$ with no additional text. All rain-rate-related quantities, including $\\mathrm{RMSE}$, must be in $\\mathrm{mm}/\\mathrm{h}$, and fractions are dimensionless decimals.",
            "solution": "The problem requires a process-oriented evaluation by partitioning rain rates from a numerical model and radar observations into convective and stratiform components. This involves implementing specific physical and empirical rules, calculating rain rates, and then computing comparative metrics. The solution is structured by first processing model data, then radar data, and finally calculating the specified metrics for each test case. All calculations are performed on a $5 \\times 5$ grid of data points.\n\nFirst, we address the model-based partitioning. According to the problem definition, a grid cell $(x,y)$ is classified as convective if the model surface rain rate $R_{\\mathrm{mod}}(x,y)$ is greater than or equal to a threshold $R_c = 15 \\, \\mathrm{mm}/\\mathrm{h}$, or if the column maximum vertical velocity $w_{\\max}(x,y)$ is greater than or equal to a threshold $w_c = 3 \\, \\mathrm{m}/\\mathrm{s}$. This can be expressed as a boolean convective mask, $C_{\\mathrm{mod}}(x,y)$, which is $1$ if $R_{\\mathrm{mod}}(x,y) \\ge R_c$ or $w_{\\max}(x,y) \\ge w_c$, and $0$ otherwise. The model-derived convective rain rate field is then given by $R_{\\mathrm{conv,mod}}(x,y) = C_{\\mathrm{mod}}(x,y) \\cdot R_{\\mathrm{mod}}(x,y)$. The total model convective fraction, $f_{\\mathrm{conv,mod}}$, is the ratio of the total convective rain rate to the total rain rate over the domain $\\mathcal{D}$:\n$$f_{\\mathrm{conv,mod}} = \\frac{\\sum_{(x,y)\\in \\mathcal{D}} R_{\\mathrm{conv,mod}}(x,y)}{\\sum_{(x,y)\\in \\mathcal{D}} R_{\\mathrm{mod}}(x,y)}$$\nIf the total rain rate is $0$, $f_{\\mathrm{conv,mod}}$ is defined as $0$.\n\nSecond, we process the radar-derived data. The initial step is to convert the radar reflectivity in decibels, $\\mathrm{dBZ}$, into a rain rate, $R_{\\mathrm{rad}}$, in $\\mathrm{mm}/\\mathrm{h}$.\nA minimum reflectivity threshold of $\\mathrm{dBZ}_{\\min} = 10$ is applied first; any pixel with $\\mathrm{dBZ}  \\mathrm{dBZ}_{\\min}$ has its rain rate set to $0 \\, \\mathrm{mm}/\\mathrm{h}$. For pixels with $\\mathrm{dBZ} \\ge \\mathrm{dBZ}_{\\min}$, the reflectivity factor $Z$ in $\\mathrm{mm}^6\\,\\mathrm{m}^{-3}$ is calculated using the formula $Z = 10^{\\mathrm{dBZ}/10}$. The rain rate $R$ is then obtained from the Marshall-Palmer relation $R = a Z^b$, with the given parameters $a = 0.017$ and $b = 0.714$. This produces the radar-derived rain rate field, $R_{\\mathrm{rad}}(x,y)$.\n\nNext, we partition the radar field using the simplified Steiner–Houze criterion. A grid cell $(x,y)$ is classified as convective if its reflectivity, $\\mathrm{dBZ}(x,y)$, is greater than or equal to an absolute threshold $Z_{\\mathrm{abs}} = 40 \\, \\mathrm{dBZ}$, or if its reflectivity exceeds the average of its immediate neighbors, $\\overline{\\mathrm{dBZ}}_{\\mathrm{nbr}}(x,y)$, by at least $\\Delta Z = 10 \\, \\mathrm{dBZ}$. The neighboring average, $\\overline{\\mathrm{dBZ}}_{\\mathrm{nbr}}(x,y)$, is the mean $\\mathrm{dBZ}$ over the $8$ cells in a $3 \\times 3$ window centered on $(x,y)$, excluding the center cell itself. This is implemented using a 2D filter operation. This process yields a radar-based convective mask, $C_{\\mathrm{rad}}(x,y)$.\nThe radar-derived convective rain rate field is then $R_{\\mathrm{conv,rad}}(x,y) = C_{\\mathrm{rad}}(x,y) \\cdot R_{\\mathrm{rad}}(x,y)$. The radar convective fraction is calculated similarly to the model's:\n$$f_{\\mathrm{conv,rad}} = \\frac{\\sum_{(x,y)\\in \\mathcal{D}} R_{\\mathrm{conv,rad}}(x,y)}{\\sum_{(x,y)\\in \\mathcal{D}} R_{\\mathrm{rad}}(x,y)}$$\nAgain, if the total radar rain rate is $0$, $f_{\\mathrm{conv,rad}}$ is set to $0$.\n\nFinally, we compute the two comparative metrics. The fraction difference, $\\Delta f$, is the simple difference between the model and radar convective fractions:\n$$\\Delta f = f_{\\mathrm{conv,mod}} - f_{\\mathrm{conv,rad}}$$\nThe root-mean-square error (RMSE) quantifies the difference between the two convective rain rate *fields*, not just their totals. It is calculated over all $N$ grid cells in the domain:\n$$\\mathrm{RMSE} = \\sqrt{\\frac{1}{N}\\sum_{(x,y)\\in \\mathcal{D}} \\big(R_{\\mathrm{conv,mod}}(x,y) - R_{\\mathrm{conv,rad}}(x,y)\\big)^2}$$\n\nThis entire procedure is applied to each of the three test cases provided. The input data arrays are processed according to these steps, and the four resulting floating-point numbers ($f_{\\mathrm{conv,mod}}$, $f_{\\mathrm{conv,rad}}$, $\\Delta f$, $\\mathrm{RMSE}$) are collected for each case. The final output aggregates these results into a list of lists.",
            "answer": "```python\nimport numpy as np\nfrom scipy.ndimage import generic_filter\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print results.\n    \"\"\"\n\n    # --- Problem Constants ---\n    # Marshall-Palmer parameters\n    a = 0.017\n    b = 0.714\n    # Thresholds\n    dBZ_min = 10.0\n    R_c = 15.0\n    w_c = 3.0\n    Z_abs = 40.0\n    delta_Z = 10.0\n\n    # --- Test Cases ---\n    test_cases = [\n        {\n            \"R_mod\": np.array([\n                [3, 3, 3, 3, 3],\n                [3, 10, 20, 10, 3],\n                [3, 20, 40, 20, 3],\n                [3, 10, 20, 10, 3],\n                [3, 3, 3, 3, 3]\n            ], dtype=float),\n            \"w_max\": np.array([\n                [0.2, 0.2, 0.2, 0.2, 0.2],\n                [0.2, 1.0, 2.0, 1.0, 0.2],\n                [0.2, 2.0, 5.0, 2.0, 0.2],\n                [0.2, 1.0, 2.0, 1.0, 0.2],\n                [0.2, 0.2, 0.2, 0.2, 0.2]\n            ], dtype=float),\n            \"dBZ\": np.array([\n                [25, 25, 25, 25, 25],\n                [25, 35, 40, 35, 25],\n                [25, 40, 48, 40, 25],\n                [25, 35, 40, 35, 25],\n                [25, 25, 25, 25, 25]\n            ], dtype=float),\n        },\n        {\n            \"R_mod\": np.array([\n                [1, 1, 1, 1, 1],\n                [1, 1, 1, 1, 1],\n                [1, 1, 2, 1, 1],\n                [1, 1, 1, 1, 1],\n                [1, 1, 1, 1, 1]\n            ], dtype=float),\n            \"w_max\": np.array([\n                [0.2, 0.2, 0.2, 0.2, 0.2],\n                [0.2, 0.2, 0.2, 0.2, 0.2],\n                [0.2, 0.2, 0.2, 0.2, 0.2],\n                [0.2, 0.2, 0.2, 0.2, 0.2],\n                [0.2, 0.2, 0.2, 0.2, 0.2]\n            ], dtype=float),\n            \"dBZ\": np.array([\n                [22, 22, 22, 22, 22],\n                [22, 22, 22, 22, 22],\n                [22, 22, 22, 22, 22],\n                [22, 22, 22, 22, 22],\n                [22, 22, 22, 22, 22]\n            ], dtype=float),\n        },\n        {\n            \"R_mod\": np.array([\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0]\n            ], dtype=float),\n            \"w_max\": np.array([\n                [0.1, 0.1, 0.1, 0.1, 0.1],\n                [0.1, 0.1, 0.1, 0.1, 0.1],\n                [0.1, 0.1, 0.1, 0.1, 0.1],\n                [0.1, 0.1, 0.1, 0.1, 0.1],\n                [0.1, 0.1, 0.1, 0.1, 0.1]\n            ], dtype=float),\n            \"dBZ\": np.array([\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0],\n                [0, 0, 0, 0, 0]\n            ], dtype=float),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        R_mod = case[\"R_mod\"]\n        w_max = case[\"w_max\"]\n        dBZ = case[\"dBZ\"]\n        N = R_mod.size\n\n        # 1. Model-based partitioning\n        C_mod = (R_mod = R_c) | (w_max = w_c)\n        R_conv_mod = R_mod * C_mod\n        \n        total_R_mod = np.sum(R_mod)\n        if total_R_mod  0:\n            f_conv_mod = np.sum(R_conv_mod) / total_R_mod\n        else:\n            f_conv_mod = 0.0\n\n        # 2. Radar-based partitioning\n        # a. Convert dBZ to R_rad\n        R_rad = np.zeros_like(dBZ, dtype=float)\n        valid_dbz_mask = dBZ = dBZ_min\n        \n        Z = 10**(dBZ[valid_dbz_mask] / 10.0)\n        R_rad[valid_dbz_mask] = a * (Z**b)\n\n        # b. Radar convective classification\n        def mean_neighbors(arr):\n            # arr is the flattened 3x3 neighborhood. Center is at index 4.\n            num_neighbors = arr.size - 1\n            return (np.sum(arr) - arr[4]) / num_neighbors\n\n        # Using generic_filter to calculate mean of neighbors\n        # mode='reflect' handles boundaries by reflecting pixel values\n        dBZ_nbr = generic_filter(dBZ, mean_neighbors, size=3, mode='reflect')\n        \n        C_rad = (dBZ = Z_abs) | ((dBZ - dBZ_nbr) = delta_Z)\n        \n        R_conv_rad = R_rad * C_rad\n        \n        total_R_rad = np.sum(R_rad)\n        if total_R_rad  0:\n            f_conv_rad = np.sum(R_conv_rad) / total_R_rad\n        else:\n            f_conv_rad = 0.0\n            \n        # 3. Calculate metrics\n        delta_f = f_conv_mod - f_conv_rad\n        rmse = np.sqrt(np.sum((R_conv_mod - R_conv_rad)**2) / N)\n\n        results.append([f_conv_mod, f_conv_rad, delta_f, rmse])\n\n    # Final print statement\n    formatted_results = [f\"[{','.join(f'{val:.6f}' for val in res)}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}