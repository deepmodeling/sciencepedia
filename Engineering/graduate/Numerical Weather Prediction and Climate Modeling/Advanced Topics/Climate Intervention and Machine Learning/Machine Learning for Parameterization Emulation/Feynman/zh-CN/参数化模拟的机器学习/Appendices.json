{
    "hands_on_practices": [
        {
            "introduction": "任何气候模型组件的一个首要要求是，在长期模拟中它不能人为地创造或毁灭能量。这个练习  提供了一种动手实践的方法，通过将其积分温度趋势与从第一性原理（辐射通量散度）导出的趋势进行比较，来检查一个用于辐射的机器学习模拟器是否守恒能量。这是检验模拟器可靠性的一个基本“健全性检查”。",
            "id": "4061564",
            "problem": "考虑一个用于数值天气预报 (NWP) 和气候模拟的、厚度为 $\\Delta z$ 的单一均匀大气层。一个来自机器学习 (ML) 的模拟模型提供了每小时的层平均温度趋势，其旨在重现辐射参数化的效应。为了对照能量守恒来验证该模拟器的单位和符号约定，请使用第一性原理的干空气能量方程和辐射通量辐合。\n\n假设干空气热力学和能量守恒，其中层平均辐射加热率 $q_{\\mathrm{rad}}(t)$ 满足\n$$\n\\rho c_p \\frac{dT}{dt} \\approx -\\frac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t)}{\\Delta z},\n$$\n其中 $\\rho$ 是空气密度，$c_p$ 是定压比热，$F_{\\mathrm{net}}(z,t)$ 是净垂直辐射通量（向上为正）。在离散的每小时时间点 $t_k=k\\,\\Delta t$，$k=0,1,\\dots,23$，取 $\\Delta t=3600\\,\\mathrm{s}$，以及\n- $\\rho=1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $c_p=1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $\\Delta z=1000\\,\\mathrm{m}$,\n- $F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)=F_{t0}-A\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)$，其中 $F_{t0}=0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 且 $A=30\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，\n- $F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)=F_{b0}-B\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)$，其中 $F_{b0}=10\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 且 $B=45\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$。\n\nML 模拟器提供的每小时层平均温度趋势（单位为 $\\mathrm{K}\\,\\mathrm{s}^{-1}$）由下式给出：\n$$\n\\hat{q}_k=\\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right),\\quad \\alpha=\\frac{1}{120{,}480}+\\frac{1}{2{,}000{,}000},\\quad \\beta=-\\frac{1}{80{,}320}.\n$$\n\n任务：\n1. 使用上述通量，计算24小时累积的物理辐射加热\n$$\n\\Delta T_{\\mathrm{rad}}=\\sum_{k=0}^{23} q_{\\mathrm{rad}}(t_k)\\,\\Delta t,\n$$\n其中 $q_{\\mathrm{rad}}(t_k)=-\\dfrac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)}{\\rho c_p \\Delta z}$。\n2. 计算24小时累积的模拟器加热\n$$\n\\Delta T_{\\mathrm{ML}}=\\sum_{k=0}^{23} \\hat{q}_k\\,\\Delta t.\n$$\n3. 计算诊断不匹配量\n$$\n\\Delta=\\Delta T_{\\mathrm{ML}}-\\Delta T_{\\mathrm{rad}},\n$$\n以此作为对照辐射通量辐合来验证模拟器的单位和符号约定的方法。\n\n以开尔文为单位表示 $\\Delta$ 的最终答案，并将答案四舍五入到四位有效数字。",
            "solution": "目标是计算来自机器学习 (ML) 模拟器的24小时累积加热与从通量散度导出的物理辐射加热之间的诊断不匹配量 $\\Delta = \\Delta T_{\\mathrm{ML}} - \\Delta T_{\\mathrm{rad}}$。这可用于验证模拟器的能量守恒特性。计算按要求分三步进行。\n\n物理常数和参数如下：\n空气密度，$\\rho=1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n定压比热，$c_p=1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$。\n大气层厚度，$\\Delta z=1000\\,\\mathrm{m}$。\n时间步长，$\\Delta t=3600\\,\\mathrm{s}$。\n乘积 $\\rho c_p \\Delta z$ 表示单位面积大气层的热容量。\n$$\n\\rho c_p \\Delta z = (1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}) \\times (1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}) \\times (1000\\,\\mathrm{m}) = 1,204,800\\,\\mathrm{J}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}.\n$$\n\n首先，我们计算24小时累积的物理辐射加热 $\\Delta T_{\\mathrm{rad}}$。\n在离散时间 $t_k = k \\Delta t$ 的物理辐射加热率由下式给出\n$$\nq_{\\mathrm{rad}}(t_k)=-\\dfrac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)}{\\rho c_p \\Delta z}.\n$$\n该层顶部和底部的净通量差为\n$$\nF_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k) = \\left(F_{t0}-A\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\right) - \\left(F_{b0}-B\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\right) = (F_{t0}-F_{b0})-(A-B)\\sin\\!\\left(\\frac{2\\pi k}{24}\\right).\n$$\n代入给定值 $F_{t0}=0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，$F_{b0}=10\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，$A=30\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 和 $B=45\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$：\n$$\nF_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k) = (0 - 10) - (30 - 45)\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) = -10 + 15\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\,\\mathrm{W}\\,\\mathrm{m}^{-2}.\n$$\n辐射加热率则为\n$$\nq_{\\mathrm{rad}}(t_k) = -\\frac{-10 + 15\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)}{1,204,800} = \\frac{10}{1,204,800} - \\frac{15}{1,204,800}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right).\n$$\n简化系数，我们得到\n$$\nq_{\\mathrm{rad}}(t_k) = \\frac{1}{120,480} - \\frac{1}{80,320}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\,\\mathrm{K}\\,\\mathrm{s}^{-1}.\n$$\n24小时内的总累积加热量是对 $k$ 从 $0$ 到 $23$ 的求和：\n$$\n\\Delta T_{\\mathrm{rad}}=\\sum_{k=0}^{23} q_{\\mathrm{rad}}(t_k)\\,\\Delta t = \\Delta t \\sum_{k=0}^{23} \\left[ \\frac{1}{120,480} - \\frac{1}{80,320}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) \\right].\n$$\n正弦函数在一个完整离散周期内的和为零：$\\sum_{k=0}^{N-1} \\sin(2\\pi k/N) = 0$。在本例中，$N=24$。\n$$\n\\sum_{k=0}^{23} \\sin\\!\\left(\\frac{2\\pi k}{24}\\right) = 0.\n$$\n因此，求和简化为\n$$\n\\Delta T_{\\mathrm{rad}} = \\Delta t \\sum_{k=0}^{23} \\frac{1}{120,480} = (3600\\,\\mathrm{s}) \\times 24 \\times \\frac{1}{120,480} = \\frac{86,400}{120,480}\\,\\mathrm{K} = \\frac{8,640}{12,048}\\,\\mathrm{K} = \\frac{180}{251}\\,\\mathrm{K}.\n$$\n\n其次，我们计算24小时累积的模拟器加热 $\\Delta T_{\\mathrm{ML}}$。\nML 模拟器提供的温度趋势为\n$$\n\\hat{q}_k=\\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right),\n$$\n其中 $\\alpha=\\frac{1}{120,480}+\\frac{1}{2,000,000}$ 和 $\\beta=-\\frac{1}{80,320}$。\n来自ML模型的总累积加热量是\n$$\n\\Delta T_{\\mathrm{ML}}=\\sum_{k=0}^{23} \\hat{q}_k\\,\\Delta t = \\Delta t \\sum_{k=0}^{23} \\left[ \\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) \\right].\n$$\n同样，正弦项的和为零。\n$$\n\\Delta T_{\\mathrm{ML}} = \\Delta t \\sum_{k=0}^{23} \\alpha = (3600\\,\\mathrm{s}) \\times 24 \\times \\alpha = 86,400 \\alpha.\n$$\n代入 $\\alpha$ 的值：\n$$\n\\Delta T_{\\mathrm{ML}} = 86,400 \\left( \\frac{1}{120,480}+\\frac{1}{2,000,000} \\right) = \\frac{86,400}{120,480} + \\frac{86,400}{2,000,000}.\n$$\n第一项与 $\\Delta T_{\\mathrm{rad}}$ 相同：\n$$\n\\Delta T_{\\mathrm{ML}} = \\frac{180}{251} + 0.0432\\,\\mathrm{K}.\n$$\n\n第三，我们计算诊断不匹配量 $\\Delta$。\n$$\n\\Delta = \\Delta T_{\\mathrm{ML}} - \\Delta T_{\\mathrm{rad}} = \\left( \\frac{180}{251} + 0.0432 \\right) - \\frac{180}{251} = 0.0432\\,\\mathrm{K}.\n$$\n问题要求最终答案应四舍五入到四位有效数字。数字 $0.0432$ 有三位有效数字（数字 $4$、$3$ 和 $2$）。为了用四位有效数字表示它，我们在末尾添加一个零。\n$$\n\\Delta = 0.04320\\,\\mathrm{K}.\n$$\n这种不匹配源于ML模拟器平均加热率中的微小恒定偏差，该偏差由 $\\alpha$ 中的项 $\\frac{1}{2,000,000}$ 表示。模拟器正确地捕捉了加热日循环的相位和振幅（因为 $\\beta$ 与物理值 $-\\frac{1}{80,320}$ 相匹配），但略微错估了24小时的平均加热。在长期的气候模拟中，这种类型的诊断对于确保ML模拟器不引入系统性能量漂移至关重要。",
            "answer": "$$\\boxed{0.04320}$$"
        },
        {
            "introduction": "虽然完美守恒是最终目标，但离线训练的模拟器可能会表现出微小的能量不平衡。这个练习  演示了一种实用的技术，用于“后验地”强制执行能量守恒。我们将计算模拟器输出的能量残差，然后推导出一个最小的、物理上一致的校正项，以确保整层大气柱的能量收支闭合，这是防止耦合模型中出现气候漂移的关键步骤。",
            "id": "4061580",
            "problem": "一个机器学习（ML）模拟器被用于预测数值天气预报（NWP）模型中单个大气柱内的温度和比湿的次网格非绝热趋势。该模拟器在气压离散化网格上输出逐层趋势 $\\dot{T}_{i}$ 和 $\\dot{q}_{i}$。为了确保气柱能量平衡，整层积分湿静力能趋势必须与外部提供的净非绝热能量通量辐合目标 $F_{\\mathrm{req}}$ 一致。从单位质量湿静力能 $h = c_{p} T + L_{v} q + g z$ 出发，其中 $c_{p}$ 是恒压干空气比热，$L_{v}$ 是蒸发潜热，$g$ 是重力加速度。假设静力平衡，并忽略固定层边界处重力势项的变化。整层积分湿静力能趋势定义为质量加权垂直积分\n$$\nE = \\frac{1}{g} \\int_{p_{\\mathrm{top}}}^{p_{\\mathrm{sfc}}} \\left( c_{p} \\,\\dot{T}(p) + L_{v} \\,\\dot{q}(p) \\right) \\, dp,\n$$\n并且，在使用层厚度 $\\Delta p_{i}$ 的逐层近似下，离散化为\n$$\nE_{\\mathrm{emul}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i} \\right).\n$$\n给定一个三层气柱（$N=3$），其数据如下：\n- $g = 9.81\\,\\mathrm{m\\,s^{-2}}$，$c_{p} = 1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，$L_{v} = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$，\n- $\\Delta p_{1} = 25000\\,\\mathrm{Pa}$，$\\Delta p_{2} = 40000\\,\\mathrm{Pa}$，$\\Delta p_{3} = 35000\\,\\mathrm{Pa}$，\n- $\\dot{T}_{1} = 1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{T}_{2} = -8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{T}_{3} = 3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，\n- $\\dot{q}_{1} = 2.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，$\\dot{q}_{2} = 0.5 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，$\\dot{q}_{3} = -1.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，\n- $F_{\\mathrm{req}} = 95\\,\\mathrm{W\\,m^{-2}}$，以及容差 $\\epsilon = 1\\,\\mathrm{W\\,m^{-2}}$。\n\n(a) 计算模拟器预测的整层积分湿静力能趋势 $E_{\\mathrm{emul}}$ 和残差\n$$\nR = E_{\\mathrm{emul}} - F_{\\mathrm{req}}.\n$$\n(b) 构建一个对模拟器趋势的物理上一致的修正。该修正仅通过一个均匀偏移量 $\\delta \\dot{T}_{i} = \\alpha$（对 $i$ 是常数）来调整温度趋势，并保持湿度趋势不变（$\\delta \\dot{q}_{i} = 0$），使得修正后的整层积分趋势在容差 $\\epsilon$ 内满足能量平衡，即：\n$$\n\\left| \\left( E_{\\mathrm{emul}} + \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} c_{p} \\alpha \\right) - F_{\\mathrm{req}} \\right| \\le \\epsilon.\n$$\n假设当 $|R|  \\epsilon$ 时采用强制精确平衡的最小修正，否则不进行修正，推导 $\\alpha$ 的表达式，并根据给定数据计算其数值。将最终的 $\\alpha$ 以 $\\mathrm{K\\,s^{-1}}$ 为单位表示，并将答案四舍五入到四位有效数字。",
            "solution": "该问题分为两部分。首先，我们计算模拟器预测的整层积分湿静力能趋势 $E_{\\mathrm{emul}}$ 及其相对于所需能量通量辐合 $F_{\\mathrm{req}}$ 的残差 $R$。其次，我们推导并计算对温度趋势的均匀修正量 $\\alpha$，以强制实现能量平衡。\n\n(a) 部分：计算 $E_{\\mathrm{emul}}$ 和 $R$。\n\n模拟器预测的整层积分湿静力能趋势 $E_{\\mathrm{emul}}$ 由以下离散化公式给出：\n$$\nE_{\\mathrm{emul}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i} \\right)\n$$\n给定 $N=3$ 个层以及以下常数和数据：\n- $g = 9.81\\,\\mathrm{m\\,s^{-2}}$\n- $c_{p} = 1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n- $L_{v} = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$\n- 第 1 层：$\\Delta p_{1} = 25000\\,\\mathrm{Pa}$，$\\dot{T}_{1} = 1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{1} = 2.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n- 第 2 层：$\\Delta p_{2} = 40000\\,\\mathrm{Pa}$，$\\dot{T}_{2} = -8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{2} = 0.5 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n- 第 3 层：$\\Delta p_{3} = 35000\\,\\mathrm{Pa}$，$\\dot{T}_{3} = 3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{3} = -1.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n\n让我们为每一层 $i$ 计算项 $h_{i}^{\\prime} = c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i}$：\n对于第 1 层：\n$h_{1}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (2.0 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{1}^{\\prime} = 0.01506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} + 0.05\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = 0.06506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n对于第 2 层：\n$h_{2}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (-8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (0.5 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{2}^{\\prime} = -0.008032\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} + 0.0125\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = 0.004468\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n对于第 3 层：\n$h_{3}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (-1.0 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{3}^{\\prime} = 0.003012\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} - 0.025\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = -0.021988\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n现在，我们计算总和 $\\sum_{i=1}^{3} \\Delta p_{i} h_{i}^{\\prime}$：\n$\\sum_{i=1}^{3} \\Delta p_{i} h_{i}^{\\prime} = (25000\\,\\mathrm{Pa})(0.06506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}) + (40000\\,\\mathrm{Pa})(0.004468\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}) + (35000\\,\\mathrm{Pa})(-0.021988\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}})$\n$\\sum_{i=1}^{3} \\Delta p_{i} h_{i}^{\\prime} = 1626.5 + 178.72 - 769.58 = 1035.64$ (单位为 $\\mathrm{Pa \\cdot J \\cdot kg^{-1} \\cdot s^{-1}}$)。\n\n现在，我们计算 $E_{\\mathrm{emul}}$，单位为 $\\mathrm{W\\,m^{-2}}$：\n$$\nE_{\\mathrm{emul}} = \\frac{1035.64}{9.81\\,\\mathrm{m\\,s^{-2}}} \\approx 105.57003\\,\\mathrm{W\\,m^{-2}}\n$$\n残差 $R$ 定义为 $R = E_{\\mathrm{emul}} - F_{\\mathrm{req}}$。给定 $F_{\\mathrm{req}} = 95\\,\\mathrm{W\\,m^{-2}}$：\n$$\nR = 105.57003\\,\\mathrm{W\\,m^{-2}} - 95\\,\\mathrm{W\\,m^{-2}} = 10.57003\\,\\mathrm{W\\,m^{-2}}\n$$\n\n(b) 部分：修正量 $\\alpha$ 的推导和计算。\n\n修正只应用于温度趋势，使得对于所有层 $i$ 都有 $\\delta \\dot{T}_{i} = \\alpha$，且 $\\delta \\dot{q}_{i} = 0$。修正后的模拟器趋势 $E_{\\mathrm{corr}}$ 则是：\n$$\nE_{\\mathrm{corr}} = E_{\\mathrm{emul}} + \\frac{c_{p} \\alpha}{g} \\sum_{i=1}^{N} \\Delta p_{i}\n$$\n令 $\\Delta p_{\\mathrm{tot}} = \\sum_{i=1}^{N} \\Delta p_{i} = 25000 + 40000 + 35000 = 100000\\,\\mathrm{Pa}$。\n所以，修正后的趋势是：\n$$\nE_{\\mathrm{corr}} = E_{\\mathrm{emul}} + \\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g}\n$$\n问题陈述，仅当残差的绝对值超过容差时才应用修正，即 $|R|  \\epsilon$。\n我们有 $|R| \\approx 10.57\\,\\mathrm{W\\,m^{-2}}$ 且 $\\epsilon = 1\\,\\mathrm{W\\,m^{-2}}$。由于 $|R|  \\epsilon$，需要进行修正。最小修正是实现精确能量平衡的修正：$E_{\\mathrm{corr}} = F_{\\mathrm{req}}$。\n将 $E_{\\mathrm{corr}}$ 设为 $F_{\\mathrm{req}}$，我们得到：\n$$\nF_{\\mathrm{req}} = E_{\\mathrm{emul}} + \\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g}\n$$\n我们求解 $\\alpha$：\n$$\n\\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g} = F_{\\mathrm{req}} - E_{\\mathrm{emul}} = -R\n$$\n$$\n\\alpha = -R \\left( \\frac{g}{c_{p} \\Delta p_{\\mathrm{tot}}} \\right)\n$$\n这是 $\\alpha$ 的符号表达式。现在我们代入数值：\n$$\n\\alpha = -(10.57003\\,\\mathrm{W\\,m^{-2}}) \\left( \\frac{9.81\\,\\mathrm{m\\,s^{-2}}}{(1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (100000\\,\\mathrm{Pa})} \\right)\n$$\n$$\n\\alpha = -10.57003 \\left( \\frac{9.81}{100400000} \\right) \\mathrm{K\\,s^{-1}}\n$$\n$$\n\\alpha \\approx -10.57003 \\times (9.770916 \\times 10^{-8}) \\mathrm{K\\,s^{-1}}\n$$\n$$\n\\alpha \\approx -1.03287 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}\n$$\n按照要求将结果四舍五入到四位有效数字：\n$$\n\\alpha \\approx -1.033 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}\n$$\n这对应于施加到所有层的一个小的、均匀的冷却，以抵消模拟器产生的多余能量。",
            "answer": "$$\n\\boxed{-1.033 \\times 10^{-6}}\n$$"
        },
        {
            "introduction": "在业务化的天气和气候预报中，速度和准确性同等重要。一个过于缓慢的模拟器无法替代原有的参数化方案。这个练习  深入探讨了性能分析这一关键任务，比较了两种常见架构——多层感知器 (MLP) 和傅里叶神经算子 (FNO) 的计算成本（浮点运算次数）和参数数量。这种分析对于选择一个能够满足业务预报中心严格时间限制的架构至关重要。",
            "id": "4061530",
            "problem": "一个国家气象中心考虑用机器学习模拟器取代一个柱状物理参数化方案。提出了两种候选架构：多层感知器（MLP）和一维傅里叶神经算子（FNO）。该模型在一个水平离散化的域上运行，其中 $N_x = 1024$ 和 $N_y = 1024$，产生 $N_{\\text{col}} = N_x N_y$ 个独立的垂直气柱。垂直网格有 $N_z = 72$ 个层级。每个气柱每层提供 $F_{\\text{in}} = 10$ 个输入特征，并需要每层输出 $F_{\\text{out}} = 6$ 个特征。\n\n运行约束为物理模拟分配了 $P_{\\text{avail}} = 1.0 \\times 10^{15}$ 次浮点运算每秒（FLOPS）的持续性能预算，以及每次调用的时间预算为 $B = 0.2$ 秒。假设使用以下广泛使用的操作计数近似方法：\n- 一个从 $\\mathbb{R}^{n} \\to \\mathbb{R}^{m}$ 的全连接层每次应用的成本约为 $2 n m + m$ 次浮点运算（FLOPs）（$+m$ 用于计算偏置），与矩阵乘法相比，非线性激活的成本可以忽略不计。\n- 长度为 $n$ 的复数快速傅里叶变换（FFT）需要大约 $5 n \\log_{2}(n)$ 次 FLOPs，反向FFT具有相同的成本。\n- 长度为 $C$ 的复数点积需要大约 $6 C$ 次 FLOPs 用于复数乘法和 $2 (C - 1)$ 次 FLOPs 用于复数加法；为简化计算，当对 $C$ 个输入形成复数加权和时，每个输出使用 $8 C$ 次 FLOPs。\n- FNO 中的谱卷积使用 $K$ 个复数模态，并通过复数加权和将每个模态的 $C$ 个输入通道混合到 $C$ 个输出通道。\n\n架构：\n1. 多层感知器（MLP）在每个垂直层级上以相同且独立的方式运行，且在所有层级间共享权重。它有两个宽度为 $64$ 的隐藏层和一个到 $F_{\\text{out}}$ 的最终线性层。因此，对于每个层级，层的尺寸为 $F_{\\text{in}} = 10 \\to 64 \\to 64 \\to F_{\\text{out}} = 6$。\n2. 一维傅里叶神经算子（FNO）沿垂直维度作用。它包括：\n   - 在每个层级上有一个逐点的提升线性层，将 $F_{\\text{in}}$ 映射到 $C = 32$ 个通道。\n   - $L = 3$ 个傅里叶层。每个层执行：对 $C$ 个通道中的每一个沿垂直方向进行前向 FFT；使用 $K = 16$ 个复数模态进行谱卷积，通过复数加权和将每个模态的 $C$ 个输入混合到 $C$ 个输出；对每个通道进行反向 FFT；以及在每个层级上进行从 $C$ 到 $C$ 的逐点线性混合。\n   - 在每个层级上有一个最终的逐点投影线性层，将 $C$ 个通道映射到 $F_{\\text{out}}$。\n\n任务：\n- 根据以上规格，推导并计算 MLP 和 FNO 的总参数数量。\n- 推导并计算 MLP 和 FNO 每气柱的前向传播 FLOPs。\n- 通过将每气柱的成本乘以 $N_{\\text{col}}$，计算每种架构在整个水平域上每次模拟器调用的总 FLOPs。\n- 设每次调用的可用 FLOPs 为 $P_{\\text{avail}} B$。定义可行性分数 $r_{\\text{FNO}} = \\frac{\\text{FLOPs}_{\\text{FNO, total}}}{P_{\\text{avail}} B}$ 和 $r_{\\text{MLP}} = \\frac{\\text{FLOPs}_{\\text{MLP, total}}}{P_{\\text{avail}} B}$。计算这两个分数。\n\n将您对 $(r_{\\text{FNO}}, r_{\\text{MLP}})$ 的最终数值答案四舍五入到三位有效数字，并以无量纲小数表示。以行矩阵的形式提供最终的数值对。",
            "solution": "该分析分四个阶段进行：参数数量、每气柱 FLOPs、总 FLOPs 和可行性分数。\n\n**1. 参数数量**\n\n计算每种架构的可训练参数（$\\Theta$）的数量。\n\n**多层感知器 (MLP):**\nMLP 在每个层级上运行，并共享权重。我们计算单个每层级网络的参数。\n- 第 1 层 ($10 \\to 64$)：$\\Theta_1 = 10 \\times 64 + 64 = 704$。\n- 第 2 层 ($64 \\to 64$)：$\\Theta_2 = 64 \\times 64 + 64 = 4160$。\n- 第 3 层 ($64 \\to 6$)：$\\Theta_3 = 64 \\times 6 + 6 = 390$。\nMLP 的总参数数量：\n$$ \\Theta_{\\text{MLP}} = 704 + 4160 + 390 = 5254 $$\n\n**傅里叶神经算子 (FNO):**\n- 提升层（逐点 $10 \\to 32$）：\n$$ \\Theta_{\\text{lift}} = 10 \\times 32 + 32 = 352 $$\n- 傅里叶层（$L=3$ 层）：每个傅里叶层包含谱卷积和逐点线性变换的参数。\n  - 谱卷积：对于 $L=3$ 层中的每一层，都有一组复数值权重。对于 $K=16$ 个模态中的每一个，使用一个 $C \\times C$ 的复数权重矩阵。一个复数需要 2 个实数来存储。\n  $$ \\Theta_{\\text{spec}} = 2 \\times K \\times C \\times C = 2 \\times 16 \\times 32 \\times 32 = 32768 $$\n  - 逐点线性层 ($32 \\to 32$):\n  $$ \\Theta_{\\text{pointwise}} = 32 \\times 32 + 32 = 1056 $$\n  $L=3$ 个傅里叶层的总参数为：\n  $$ \\Theta_{\\text{fourier\\_layers}} = L \\times (\\Theta_{\\text{spec}} + \\Theta_{\\text{pointwise}}) = 3 \\times (32768 + 1056) = 101472 $$\n- 投影层（逐点 $32 \\to 6$）:\n$$ \\Theta_{\\text{proj}} = 32 \\times 6 + 6 = 198 $$\nFNO 的总参数数量：\n$$ \\Theta_{\\text{FNO}} = \\Theta_{\\text{lift}} + \\Theta_{\\text{fourier\\_layers}} + \\Theta_{\\text{proj}} = 352 + 101472 + 198 = 102022 $$\n\n**2. 每气柱前向传播 FLOPs**\n\n**每气柱 MLP FLOPs:**\n每层级的 MLP 在 $N_z=72$ 个垂直层级的每一个上独立应用。\n- 每层级的 FLOPs：\n  - 第 1 层 ($10 \\to 64$)：$2 \\times 10 \\times 64 + 64 = 1344$。\n  - 第 2 层 ($64 \\to 64$)：$2 \\times 64 \\times 64 + 64 = 8256$。\n  - 第 3 层 ($64 \\to 6$)：$2 \\times 64 \\times 6 + 6 = 774$。\n- 每层级的总 FLOPs：$1344 + 8256 + 774 = 10374$。\n- 每气柱的总 FLOPs：\n$$ \\text{FLOPs}_{\\text{MLP, col}} = N_z \\times 10374 = 72 \\times 10374 = 746928 $$\n\n**每气柱 FNO FLOPs:**\n- 提升层（逐点 $10 \\to 32$）：\n$$ F_{\\text{lift}} = N_z \\times (2 \\times 10 \\times 32 + 32) = 72 \\times 672 = 48384 $$\n- 傅里叶层（$L=3$ 层）：\n  - 前向/反向 FFT：对 $C=32$ 个通道中的每一个，执行一个长度为 $N_z=72$ 的 FFT/IFFT。\n  $$ F_{\\text{FFT/IFFT}} = C \\times (5 N_z \\log_2(N_z)) = 32 \\times (5 \\times 72 \\times \\log_2(72)) \\approx 32 \\times 360 \\times 6.1699 = 71087 $$\n  - 谱卷积：对于 $K=16$ 个模态中的每一个，计算 $C=32$ 个输出，每个输出是 $C$ 个输入的复数加权和。\n  $$ F_{\\text{spec}} = K \\times C \\times (8C) = 8 K C^2 = 8 \\times 16 \\times 32^2 = 131072 $$\n  - 逐点线性层 ($32 \\to 32$):\n  $$ F_{\\text{pointwise}} = N_z \\times (2 \\times 32^2 + 32) = 72 \\times 2080 = 149760 $$\n  - 单个傅里叶层的总 FLOPs：$2 \\times F_{\\text{FFT/IFFT}} + F_{\\text{spec}} + F_{\\text{pointwise}} \\approx 2 \\times 71087 + 131072 + 149760 = 423006$。\n  - $L=3$ 个傅里叶层的总 FLOPs：$3 \\times 423006 = 1269018$。\n- 投影层（逐点 $32 \\to 6$）:\n$$ F_{\\text{proj}} = N_z \\times (2 \\times 32 \\times 6 + 6) = 72 \\times 390 = 28080 $$\n- 每 FNO 气柱的总 FLOPs：\n$$ \\text{FLOPs}_{\\text{FNO, col}} \\approx 48384 + 1269018 + 28080 = 1345482 $$\n（使用更精确的 $\\log_2(72)$ 会得到 $1345483.23$）\n\n**3. 每次模拟器调用的总 FLOPs**\n\n总气柱数为 $N_{\\text{col}} = 1024 \\times 1024 = 1048576$。\n- MLP 总 FLOPs:\n$$ \\text{FLOPs}_{\\text{MLP, total}} = N_{\\text{col}} \\times \\text{FLOPs}_{\\text{MLP, col}} = 1048576 \\times 746928 \\approx 7.832 \\times 10^{11} $$\n- FNO 总 FLOPs:\n$$ \\text{FLOPs}_{\\text{FNO, total}} = N_{\\text{col}} \\times \\text{FLOPs}_{\\text{FNO, col}} = 1048576 \\times 1345483 \\approx 1.411 \\times 10^{12} $$\n\n**4. 可行性分数**\n\n每次模拟器调用的可用 FLOPs 是：\n$$ \\text{FLOPs}_{\\text{avail}} = P_{\\text{avail}} \\times B = (1.0 \\times 10^{15} \\text{ FLOPs/s}) \\times (0.2 \\text{ s}) = 2.0 \\times 10^{14} \\text{ FLOPs} $$\n- MLP 可行性分数：\n$$ r_{\\text{MLP}} = \\frac{7.832 \\times 10^{11}}{2.0 \\times 10^{14}} = 0.003916 $$\n四舍五入到三位有效数字，$r_{\\text{MLP}} \\approx 0.00392$。\n\n- FNO 可行性分数：\n$$ r_{\\text{FNO}} = \\frac{1.411 \\times 10^{12}}{2.0 \\times 10^{14}} = 0.007055 $$\n四舍五入到三位有效数字，$r_{\\text{FNO}} \\approx 0.00705$。\n\n最终答案是数值对 $(r_{\\text{FNO}}, r_{\\text{MLP}})$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.00705  0.00392\n\\end{pmatrix}\n}\n$$"
        }
    ]
}