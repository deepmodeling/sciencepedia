## 引言
在数值天气预报和气候建模领域，利用[机器学习模拟](@entry_id:1127546)（emulation）复杂的[物理参数化](@entry_id:1129649)方案，正成为一场深刻的范式变革。传统的[参数化](@entry_id:265163)方案是模型中最耗时、也是不确定性来源之一的部分，而机器学习提供了一种强大的数据驱动方法，有望在大幅提升[计算效率](@entry_id:270255)的同时，保持甚至超越物理保真度。然而，构建一个能够在复杂的地球系统中稳定运行的模拟器，远非一个简单的回归问题。它要求我们不仅要掌握机器学习技术，更要深刻理解其背后的物理原理和数值挑战。本文旨在系统性地解决这一知识鸿沟，为研究人员和实践者提供一个全面的指南。

在接下来的内容中，读者将首先深入学习构建模拟器的核心**原理与机制**，从其存在的理论基础——闭合问题，到设计中必须考虑的因果闭合、物理守恒律、数值稳定性，以及在线评估中的反馈挑战。接着，文章将通过丰富的案例，展示这些技术在天气、气候及其他科学领域的具体**应用与跨学科联系**，探讨如何模拟辐射、[湍流](@entry_id:151300)和云微物理等关键过程，并介绍多专家系统和[算子学习](@entry_id:752958)等前沿架构。最后，通过一系列精心设计的**动手实践**，读者将有机会将理论知识付诸实践，学习诊断计算成本、检验能量守恒和实施校正方案等关键技能，从而全面掌握构建和验证机器学习[参数化模拟](@entry_id:1129324)器的完整流程。

## 原理与机制

在理解了机器学习[参数化模拟](@entry_id:1129324)的基本动机之后，本章将深入探讨构建、约束和评估这类模拟器所需的核心原理与机制。我们将从模拟存在的基本理由——即所谓的“闭合问题”——开始，然后系统地探讨模拟器的设计、物理约束的植入、[数值稳定性](@entry_id:175146)的保障，以及最终评估其在复杂气候系统中的性能时所面临的挑战。

### 模拟的基本原理：闭合问题

在[数值天气预报](@entry_id:191656)和气候模型中，我们求解的是描述大气运动的流体力学和[热力学](@entry_id:172368)[偏微分方程组](@entry_id:172573)，例如[原始方程](@entry_id:1130162)。这些方程本质上是[非线性](@entry_id:637147)的。例如，平流项，其形式为 $u_j \partial_j \phi$，包含状态变量（如风速 $u_j$）与其自身或另一变量（如温度或湿度 $\phi$）的乘积。

由于计算资源的限制，模型无法在每一个空间点上都解析流体的完整状态。取而代之的是，我们在一个离散的网格上进行计算，每个网格单元的尺度为 $\Delta$。这相当于对真实的连续方程应用了一个**[粗粒化](@entry_id:141933)**（coarse-graining）或滤波算子 $\mathcal{G}_\Delta$。一个经过滤波的变量，我们用上划线表示，例如 $\overline{\phi} = \mathcal{G}_\Delta(\phi)$，代表了在网格尺度 $\Delta$ 上可解析的变量部分。

问题的核心在于，滤波算子 $\mathcal{G}_\Delta$ 与[非线性](@entry_id:637147)乘法运算是不可交换的。也就是说，对于任意两个场 $f$ 和 $g$，通常情况下 $\mathcal{G}_\Delta(fg) \neq \mathcal{G}_\Delta(f) \mathcal{G}_\Delta(g)$，即“先相乘再滤波”不等于“先滤波再相乘”。当我们对一个非线性方程（如动量或热量平流方程）应用滤波算子时，就会出现一个无法用已解析变量表达的项 。

以平流项 $\nabla \cdot (\mathbf{u} \phi)$ 为例，对其进行滤波得到 $\nabla \cdot (\overline{\mathbf{u} \phi})$。由于上述的[非交换性](@entry_id:153545)，我们无法将其写成 $\nabla \cdot (\overline{\mathbf{u}} \overline{\phi})$。为了看清这一点，我们将真实场分解为可解析[部分和](@entry_id:162077)**次网格**（subgrid）部分，即 $f = \overline{f} + f'$。代入后可得：
$$
\overline{\mathbf{u} \phi} = \overline{(\overline{\mathbf{u}} + \mathbf{u}') (\overline{\phi} + \phi')} = \overline{\overline{\mathbf{u}}\overline{\phi}} + \overline{\overline{\mathbf{u}}\phi'} + \overline{\mathbf{u}'\overline{\phi}} + \overline{\mathbf{u}'\phi'}
$$
经过整理，可解析变量 $\overline{\phi}$ 的演化方程变为：
$$
\frac{\partial \overline{\phi}}{\partial t} + \nabla \cdot (\overline{\mathbf{u}}\overline{\phi}) = \overline{S} - \nabla \cdot (\overline{\mathbf{u} \phi} - \overline{\mathbf{u}}\overline{\phi})
$$
其中 $\overline{S}$ 是滤波后的源汇项。方程右侧新出现的项 $\boldsymbol{\tau}_\phi = \overline{\mathbf{u} \phi} - \overline{\mathbf{u}}\overline{\phi}$ 被称为**[次网格尺度](@entry_id:1132591)通量**。它代表了未被解析的次网格运动（如[湍流](@entry_id:151300)涡旋、对流云）对可解析尺度变量的净效应。由于这一项依赖于未知的次网格变量（如 $\overline{\mathbf{u}'\phi'}$），仅包含可解析变量的方程组是不完整的，或者说是**不闭合**的。这就是**闭合问题**（closure problem）。

**[次网格参数化](@entry_id:1132597)**（subgrid parameterization）的根本任务就是解决这个闭合问题。它旨在提供一个近似关系，将这个未知的次网格效应（即倾向项 $-\nabla \cdot \boldsymbol{\tau}_\phi$）表示为可解析状态变量 $\mathbf{X} = \{\overline{u_i}, \overline{\theta}, \overline{q}, \dots\}$ 的函数或泛函。而**[参数化模拟](@entry_id:1129324)**（parameterization emulation）则是利用[机器学习模型](@entry_id:262335)，通过从高分辨率模拟或观测数据中学习，来构建这个从可解析状态 $\mathbf{X}$ 到次网格倾向 $\mathbf{T}$ 的映射关系 $\widehat{\mathcal{F}}_\phi: \mathbf{X} \mapsto \mathbf{T}$ 。

### 模拟器的设计：输入、输出与因果闭合

明确了模拟器旨在学习一个从可解析状态到次网格倾向的映射后，一个关键的设计问题随之而来：这个映射的输入应该包含哪些变量？为了确保模拟器能够做出科学上一致的预测，其输入必须满足**因果闭合**（causal closure）的原则。这意味着在任意时刻 $t$，模拟器的输入必须包含真实物理过程在该时刻所依赖的所有信息，从而使得该映射是条件良定的和马尔可夫的 。

为了确定这些必要的输入，我们首先要区分两类变量：

-   **预报变量**（prognostic variables）：这些是构成模型[状态向量](@entry_id:154607) $\mathbf{x}$ 的核心变量，它们的未来值由其自身的[微分](@entry_id:158422)方程（即倾向方程）决定。例如，水平风分量 $u$ 和 $v$、位温 $\theta$、比湿 $q_v$ 等。它们是模型通过[时间积分](@entry_id:267413)直接演化的量。

-   **诊断变量**（diagnostic variables）：这些变量在每个时刻由预报变量和其他强迫通过代数关系式计算得出，它们没有自己的独立时间演化方程。例如，压强 $p$ 可以通过[理想气体定律](@entry_id:146757)从密度和[温度诊断](@entry_id:161236)得出，大气的静力稳定度（如布伦特-瓦萨拉频率 $N^2$）也是如此。

根据因果闭合原则，模拟器的输入集必须包含确定[次网格物理](@entry_id:755602)倾向 $\mathcal{P}_{\mathrm{phys}}$ 所需的全部信息。在物理上，这些倾向在时刻 $t$ 依赖于该时刻完整的预报状态 $\mathbf{x}(t)$、其空间梯度 $\nabla \mathbf{x}(t)$ 以及外部强迫（如太阳辐射）和边界条件（如地表通量） $\mathbf{b}(t)$。因此，一个因果闭合的模拟器必须至少接收完整的预报变量向量（通常是整个大气柱的廓线）及其空间结构信息作为输入。

相比之下，诊断变量由于可以从预报变量确定性地计算出来，因此从信息论的角度看是冗余的。一个足够强大的[机器学习模型](@entry_id:262335)原则上可以从预报变量中自行学习到这些诊断关系。虽然在实践中，将物理上有意义的诊断变量作为特征输入可能有助于简化学习任务，但它们对于保证因果闭合并非是必需的。

一个重要的细节是，某些传统的[参数化](@entry_id:265163)方案可能包含其自身的“隐藏”预报状态，例如，[湍流](@entry_id:151300)方案中的[湍流](@entry_id:151300)能量（TKE）可能由其自身的倾向方程演化。如果模拟器旨在取代此类方案，那么这些内部的、缓慢演化的次网格状态也必须被包含在输入中，以保持系统的[马尔可夫性质](@entry_id:139474) 。

### 植入物理一致性：守恒律

一个仅仅在离线测试中均方根误差很低的模拟器，如果不能遵守基本的物理守恒律，那么在与气候模型的在线耦合中几乎肯定会失败。因此，将物理约束植入模拟器是其设计过程中的一个核心环节。最重要的约束来自于质量、水物质和能量的守恒。

#### 定义约束条件

在一个单柱大气模型中，我们可以将整个大气柱视为一个控制体，其总质量、总水物质和总能量的变化率必须等于通过其边界（地表和大气层顶）的通量。这为模拟器的输出（即倾向和通量）提供了一组严格的代数约束 。

1.  **[质量守恒](@entry_id:204015)（组分闭合）**: 在每一层大气中，所有物质（干空气、水汽、液态水、冰）的质量混合比之和必须为1。因此，它们的倾向之和必须为零：
    $$
    \forall k: \dot{q}_{\text{dry},k} + \dot{q}_{v,k} + \dot{q}_{l,k} + \dot{q}_{i,k} = 0
    $$
    这保证了[参数化](@entry_id:265163)过程本身不会无中生有或消灭质量。

2.  **总水物质守恒**: 整个大气柱中总水质量（包括汽、液、冰三相）的变化率，必须等于从地表蒸发进入的水汽通量减去以地表降水形式流出的水量，以及可能在大气层顶的净流出：
    $$
    \sum_{k=1}^{N} m_k \left(\dot{q}_{v,k} + \dot{q}_{l,k} + \dot{q}_{i,k}\right) = \frac{F_E}{L_v} - F_p - F_{\text{top,w}}
    $$
    这里 $m_k$ 是第 $k$ 层的空气质量，$F_E$ 是地表潜热通量，$L_v$ 是蒸发潜热，$F_p$ 是降水通量，$F_{\text{top,w}}$ 是大气层顶水物质通量。

3.  **能量守恒（第一[热力学定律](@entry_id:202285)）**: 整个大气柱的总能量（通常以湿焓形式表示 $h \approx c_p T + L_v q_v - L_f q_i$）的变化率，必须等于进入该柱的净能量通量。这包括净辐射通量（进入减去射出）、地表[感热和潜热通量](@entry_id:1131472)，以及随降水粒子带走的能量：
    $$
    \sum_{k=1}^{N} m_k \left(c_p \dot{T}_k + L_v \dot{q}_{v,k} - L_f \dot{q}_{i,k}\right) = (F_R^{\text{surf}} - F_R^{\text{TOA}}) + F_H + F_E - h_p F_p - F_{\text{top,E}}
    $$
    这里 $F_R^{\text{surf/TOA}}$ 是地表和大气层顶的净[辐射通量](@entry_id:151732)，$F_H$ 是[感热通量](@entry_id:1131473)，$h_p$ 是降水携带的比焓。此外，如果模拟器也预测[辐射加热](@entry_id:754016)率廓线 $\dot{T}_{\text{rad},k}$，那么其廓[线积分](@entry_id:141417)也必须与[辐射通量](@entry_id:151732)的散度相一致。

这些约束是模拟器输出必须在每个时间步都满足的“硬性”要求。

#### 实施约束的方法

有两种主要策略可以实施这些守恒律：

1.  **结构化实施**: 最稳健的方法是设计一个**结构保守**（structurally conservative）的模拟器架构 。在这种方法中，模拟器不直接预测倾向（如 $\dot{T}_k, \dot{q}_k$），而是预测[守恒量](@entry_id:161475)（如[湿静力能](@entry_id:1128097)和总水）的**垂直通量**（vertical fluxes）$F_m(z)$ 和 $F_q(z)$。然后，通过计算这些通量的**散度**（divergence）来得到倾向：
    $$
    \rho \dot{m}(z) = -\frac{\partial F_m}{\partial z}, \quad \rho \dot{q}(z) = -\frac{\partial F_q}{\partial z}
    $$
    通过在模型的顶部和底部边界强制实施[零通量条件](@entry_id:182067)，该列的总能量和总水量就能够通过构造得到精确守恒。此外，对于必须保持正定性的变量（如湿度），可以使用**守恒通量限制器**（conservative flux limiters）来调整通量，以防止在更新后产生非物理的负值，同时不破坏整体守恒。

2.  **通过[损失函数](@entry_id:634569)实施软约束**: 另一种方法是在训练过程中通过**复合损失函数**（composite loss function）来鼓励守恒 。这种[损失函数](@entry_id:634569)由多个部分组成：
    $$
    L(\theta) = L_{\text{accuracy}} + \sum_j \lambda_j L_{\text{conservation},j}
    $$
    其中 $L_{\text{accuracy}}$ 是一个标准的准确性度量，如**均方误差**（Mean Squared Error, MSE）。$L_{\text{conservation},j}$ 是惩罚第 $j$ 个守恒律被违反的项，通常是守恒方程残差的平方。$\lambda_j$ 是平衡各项的权重。

    这种方法的挑战在于单位的一致性和权重的选择。直接将具有不同物理单位的项（如温度倾向的MSE和能量通量的残差）相加是无意义的。一个有原则的解决方案是首先通过特征尺度对所有项进行**[无量纲化](@entry_id:136704)**。此外，权重 $\lambda_j$ 不应是固定的任意值，而应在训练中自适应调整。常见的策略包括根据各损失项梯度的大小来[动态平衡](@entry_id:136767)权重，使用**增广拉格朗日**（Augmented Lagrangian）方法将约束问题转化为一系列无[约束优化问题](@entry_id:1122941)，或从概率论角度出发，将每个损失项视为高斯[负对数似然](@entry_id:637801)，通过学习其不确定性（方差）来自[动平衡](@entry_id:163330)权重 。

### 保证[数值稳定性](@entry_id:175146)：刚性问题

一个物理上一致且离线准确的模拟器，在耦合到[动力核心](@entry_id:1124042)时仍可能因[数值不稳定性](@entry_id:137058)而失败。一个常见的根源是**刚性**（stiffness）问题 。

在气候系统中，不同物理过程的特征时间尺度差异巨大。例如，与云微物理（秒到分钟）或[湍流](@entry_id:151300)（分钟）相关的快速过程，相比于大尺度平流（小时到天）等慢速过程，其演化速度要快得多。一个[微分](@entry_id:158422)方程系统如果包含多个分离悬殊的时间尺度，就被称为**刚性系统**。

当使用**[显式时间积分](@entry_id:165797)**方案（explicit time-stepping scheme）时，其数值稳定性受到系统中最快时间尺度 $\tau_{\text{fast}}$ 的严格限制。例如，对于一个简单的松弛过程 $\frac{dq}{dt} = -\frac{1}{\tau_m}(q - q_{\text{eq}})$，使用[前向欧拉法](@entry_id:141238)积分的稳定性条件是时间步长 $\Delta t \leq 2\tau_m$。

然而，气候模型的全局时间步长 $\Delta t$ 通常是根据慢速动力过程（如满足CFL条件）来选择的，因此往往远大于许多[参数化](@entry_id:265163)过程的快速物理时间尺度（$\Delta t \gg \tau_m$）。如果一个标准的、前馈式的[机器学习模拟器](@entry_id:751586)（其本质上是一个显式更新）被用于模拟这些快速过程，其稳定性条件就会被严重违反。这会导致数值解的剧烈振荡和[指数增长](@entry_id:141869)，即所谓的“模型爆炸”，并产生如负湿度之类的非物理结果 。

认识到刚性问题对于成功耦合至关重要。它表明，对于具有快速过程的模拟器，可能需要采用更复杂的积分策略，例如在物理过程内部使用更小的子步长，或开发能进行隐式或半[隐式时间积分](@entry_id:171761)的模拟器架构。

### 模拟器的评估与反馈问题

如何评估一个模拟器的好坏？这是一个比计算简单的准确性指标更为复杂的问题。关键在于区分两种评估协议：

1.  **离线评估**（Offline evaluation）: 在这个阶段，模拟器在一个固定的、预先生成的数据集上进行测试。输入数据来自原始模型（使用传统[参数化](@entry_id:265163)方案），模拟器的输出与数据集中的“真实”倾向进行比较。常用的度量是均方误差（MSE）。这种评估是在“开环”（open-loop）或“[教师强制](@entry_id:636705)”（teacher-forced）模式下进行的，因为模拟器的输出不会影响后续的输入状态 。

2.  **在[线积分](@entry_id:141417)**（Online integration）: 在这个阶段，模拟器被实际植入到气候或[天气预报模型](@entry_id:1134014)中，取代原有的[参数化](@entry_id:265163)方案。模型在“闭环”（closed-loop）模式下运行，即模拟器在每个时间步产生的倾向会更新模型状态，而这个新状态又成为模拟器在下一个时间步的输入 。

离线评估的优异表现是必要的，但绝不充分。许多离线表现良好的模拟器在在[线积分](@entry_id:141417)时会迅速失败。其根本原因在于**反馈**（feedback）的存在 。

在线上模式中，模拟器与模型的动力核心之间形成了一个反馈循环。即使模拟器存在微小的、系统性的误差（即偏差），这些误差也会通过这个循环不断累积和放大。例如，一个微小但持续的正温度偏差会使模拟的大气逐渐变暖。这种变暖的状态反过来又成为模拟器的输入，可能导致其产生更大的偏差。久而久之，模拟的气候可能会漂移到一个完全不真实的状态，甚至导致数值不稳定。

我们可以通过一个简单的思想实验来形式化地理解这一现象。假设一个简化的大气系统有一个稳定的[平衡态](@entry_id:270364)（定点）$x^\star$，满足 $F(x^\star) + P(x^\star) = 0$，其中 $F$ 是动力倾向，$P$ 是物理倾向。如果我们将 $P$ 替换为一个有微小常数偏差 $b$ 的模拟器 $\hat{P} = P + b$，那么新的[平衡态](@entry_id:270364) $x^\star + \delta x$ 将会发生偏移。通过一阶线性化可以发现，这个偏移量近似为 $\delta x \approx -[D(F+P)(x^\star)]^{-1} b$，其中 $D(F+P)$ 是系统在原[平衡态](@entry_id:270364)的[雅可比矩阵](@entry_id:178326)。这个公式表明，即使偏差 $b$ 很小，如果系统的[雅可比矩阵](@entry_id:178326)的逆（即系统的敏感性）很大，最终导致的平均态漂移 $\delta x$ 也可能非常显著 。

离线评估无法捕捉到这种由反馈驱动的漂移或不稳定性。因此，**在线测试是评估模拟器真实性能和[长期稳定性](@entry_id:146123)的唯一可靠方法**。

### 高级挑战：气候变化下的泛化能力

模拟器开发面临的终极挑战是其泛化能力，特别是在一个变化的外部强迫（如温室气体浓度增加）下的未来气候中。一个在当前气候数据上训练的模拟器，在未来的气候情景中还会有效吗？这引出了**[分布偏移](@entry_id:915633)**（distribution shift）的问题 。

在[统计学习理论](@entry_id:274291)中，我们假设训练数据和测试数据来自同一个概率分布。然而，在气候模拟中，训练数据来自历史气候的分布 $p_s(x,y)$，而部署环境（未来气候）则遵循一个不同的分布 $p_t(x,y)$。

-   我们能直接测量的性能是**[经验风险](@entry_id:633993)**（empirical risk），即在有限的训练样本上的平均损失 $\hat{R}_s(f)$。
-   根据大数定律，当训练样本足够大时，[经验风险](@entry_id:633993)会收敛到**源域[期望风险](@entry_id:634700)**（source expected risk）$R_s(f)$。
-   但我们真正关心的，是模拟器在未来气候中的**目标域[期望风险](@entry_id:634700)**（target expected risk）$R_t(f)$。

在这种情况下，**[泛化误差](@entry_id:637724)**最相关的定义是目标域[期望风险](@entry_id:634700)与源域[经验风险](@entry_id:633993)之差 $R_t(f) - \hat{R}_s(f)$，它同时包含了由有限样本造成的误差和由[分布偏移](@entry_id:915633)造成的误差 。

[分布偏移](@entry_id:915633)可以进一步细分为两种类型 ：

1.  **[协变量偏移](@entry_id:636196)**（Covariate Shift）: 这种情况下，输入变量的[边际分布](@entry_id:264862)发生了变化（$p_t(x) \neq p_s(x)$），但输入和输出之间的物理关系（[条件概率](@entry_id:151013)）保持不变（$p_t(y|x) = p_s(y|x)$）。在气候背景下，这意味着未来气候中可能会更频繁地出现某些极端天气模式（例如更强的热浪），但这些模式下的物理过程本身没有改变。

2.  **[概念漂移](@entry_id:1122835)**（Concept Drift）: 这种情况下，输入和输出之间的物理关系本身发生了变化（$p_t(y|x) \neq p_s(y|x)$）。这可能发生在例如大气中气溶胶浓度的变化改变了云的微物理过程，导致即使在相同的宏观气象条件下，也会产生不同的加热或降水倾向。

理解[分布偏移](@entry_id:915633)的类型对于开发更具鲁棒性的模拟器至关重要。例如，在纯[协变量偏移](@entry_id:636196)的情况下，原则上可以通过**[重要性加权](@entry_id:636441)**（importance weighting）等技术，利用源域数据来估计和优化目标域的性能，其目标风险可以表示为 $R_t(f) = \mathbb{E}_{(x,y)\sim p_s}[w(x)\ell(f(x),y)]$，其中权重 $w(x) = p_t(x)/p_s(x)$ 。然而，[概念漂移](@entry_id:1122835)则构成了更根本的挑战，可能需要模拟器具备外推到全新物理机制的能力，这是当前研究的前沿领域。