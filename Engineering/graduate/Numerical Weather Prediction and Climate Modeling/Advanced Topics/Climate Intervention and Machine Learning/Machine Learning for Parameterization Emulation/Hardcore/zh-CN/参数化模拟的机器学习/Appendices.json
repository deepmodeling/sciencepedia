{
    "hands_on_practices": [
        {
            "introduction": "在将机器学习（ML）参数化方案集成到业务化的数值天气预报（NWP）或气候模型中之前，一个至关重要的实际步骤是评估其计算成本。业务化模型有严格的时间预算，每一秒的模拟时间都对应着有限的计算资源。此练习将指导您分析两种流行的神经网络架构——多层感知机（MLP）和傅里叶神经算子（FNO）——的计算可行性，帮助您掌握评估模型部署在高性能计算环境中可行性的基本技能。",
            "id": "4061530",
            "problem": "一个国家气象中心考虑用机器学习模拟器取代一个柱状物理参数化方案。提出了两种候选架构：多层感知器（MLP）和一维傅里叶神经算子（FNO）。该模型在一个水平离散化的区域上运行，区域大小为 $N_x = 1024$ 和 $N_y = 1024$，产生 $N_{\\text{col}} = N_x N_y$ 个独立的垂直气柱。垂直网格有 $N_z = 72$ 个层级。每个气柱每层提供 $F_{\\text{in}} = 10$ 个输入特征，并要求每层输出 $F_{\\text{out}} = 6$ 个特征。\n\n操作限制为物理模拟分配了 $P_{\\text{avail}} = 1.0 \\times 10^{15}$ 次浮点运算每秒（FLOPS）的持续性能预算，以及每次调用的时间预算为 $B = 0.2$ 秒。假设使用以下广泛使用的运算计数近似方法：\n- 一个从 $\\mathbb{R}^{n} \\to \\mathbb{R}^{m}$ 的全连接层每次应用的成本约为 $2 n m + m$ 次浮点运算（FLOPs）（其中 $+m$ 是偏置项的开销），非线性激活函数的成本与矩阵乘法相比可以忽略不计。\n- 长度为 $n$ 的复数快速傅里叶变换（FFT）需要约 $5 n \\log_{2}(n)$ FLOPs，逆FFT的成本相同。\n- 长度为 $C$ 的复数点积需要约 $6 C$ FLOPs用于复数乘法和 $2 (C - 1)$ FLOPs用于复数加法；为简化计算，在对 $C$ 个输入进行复数加权求和以形成一个输出时，使用 $8 C$ FLOPs。\n- FNO中的谱卷积使用 $K$ 个复数模态，并通过复数加权求和将每个模态的 $C$ 个输入通道混合到 $C$ 个输出通道。\n\n架构：\n1. 多层感知器（MLP）在每个垂直层级上以相同且独立的方式运行，且权重在各层级间共享。它有两个宽度为 $64$ 的隐藏层和一个到 $F_{\\text{out}}$ 的最终线性层。因此，对于每个层级，层的尺寸为 $F_{\\text{in}} = 10 \\to 64 \\to 64 \\to F_{\\text{out}} = 6$。\n2. 一维傅里叶神经算子（FNO）沿垂直维度作用。它包括：\n   - 在每个层级上有一个逐点的提升线性层，将 $F_{\\text{in}}$ 映射到 $C = 32$ 个通道。\n   - $L = 3$ 个傅里叶层。每个层执行：对 $C$ 个通道中的每一个沿垂直方向进行正向FFT；使用 $K = 16$ 个复数模态进行谱卷积，通过复数加权求和将每个模态的 $C$ 个输入混合到 $C$ 个输出；对每个通道进行逆FFT；以及在每个层级上进行从 $C$到 $C$ 的逐点线性混合。\n   - 在每个层级上有一个最终的逐点投影线性层，将 $C$ 个通道映射到 $F_{\\text{out}}$。\n\n任务：\n- 根据以上规格，推导并计算MLP和FNO的总参数数量。\n- 推导并计算MLP和FNO的每气柱前向传播FLOPs。\n- 通过将每气柱的成本乘以 $N_{\\text{col}}$，计算每种架构在整个水平域上每次模拟器调用的总FLOPs。\n- 设每次调用的可用FLOPs为 $P_{\\text{avail}} B$。定义可行性分数 $r_{\\text{FNO}} = \\frac{\\text{FLOPs}_{\\text{FNO, total}}}{P_{\\text{avail}} B}$ 和 $r_{\\text{MLP}} = \\frac{\\text{FLOPs}_{\\text{MLP, total}}}{P_{\\text{avail}} B}$。计算这两个分数。\n- 将您计算出的 $(r_{\\text{FNO}}, r_{\\text{MLP}})$ 的最终数值答案四舍五入到三位有效数字，并以无量纲小数表示。以行矩阵的形式提供最终的数值对。",
            "solution": "用户提供了一个明确定义的计算问题，用于比较两种神经网络架构。在进行求解之前，必须验证问题陈述。\n\n### 步骤1：提取给定条件\n- 水平域尺寸：$N_x = 1024$, $N_y = 1024$。\n- 垂直气柱数量：$N_{\\text{col}} = N_x N_y$。\n- 垂直网格层级：$N_z = 72$。\n- 每层输入特征数：$F_{\\text{in}} = 10$。\n- 每层输出特征数：$F_{\\text{out}} = 6$。\n- 持续性能预算：$P_{\\text{avail}} = 1.0 \\times 10^{15}$ FLOPS。\n- 每次调用时间预算：$B = 0.2$ s。\n- 全连接层（$\\mathbb{R}^{n} \\to \\mathbb{R}^{m}$）的FLOPs：$2nm + m$。\n- 复数FFT/IFFT（长度为$n$）的FLOPs：$5n \\log_{2}(n)$。\n- 复数加权求和（$C$个输入产生一个输出）的FLOPs：$8C$。\n- MLP架构：逐层，权重共享，$10 \\to 64 \\to 64 \\to 6$。\n- FNO架构：作用于垂直维度，$L=3$ 个傅里叶层。\n  - 提升层：逐点 $F_{\\text{in}} \\to C=32$ 通道。\n  - 傅里叶层：FFT，使用$K=16$个模态进行谱卷积混合$C \\to C$通道，IFFT，逐点线性层$C \\to C$。\n  - 投影层：逐点 $C \\to F_{\\text{out}}$。\n\n### 步骤2：使用提取的给定条件进行验证\n该问题具有科学依据，描述了机器学习在计算气候科学中的一个现实应用。所用架构（MLP, FNO）是标准架构，指定的FLOPs计数近似方法在性能建模中很常见。该问题是适定问题，为获得唯一解提供了所有必要的参数和定义。问题是客观的，没有歧义。检查清单中未发现任何缺陷。\n\n### 步骤3：结论与行动\n该问题有效。将提供完整解答。\n\n### 解题推导\n\n按照要求，分析分四个阶段进行：参数计数、每气柱FLOPs、总FLOPs和可行性分数。\n\n**1. 参数计数**\n\n计算每种架构的可训练参数数量（$\\Theta$）。\n\n**多层感知器（MLP）：**\nMLP在每个层级上运行，并共享权重。我们计算单个逐层网络的参数。该架构包含三个层：两个隐藏层和一个输出层。\n- 第1层 ($F_{\\text{in}} \\to 64$)：参数包括权重和偏置。$\\Theta_1 = F_{\\text{in}} \\times 64 + 64 = 10 \\times 64 + 64 = 640 + 64 = 704$。\n- 第2层 ($64 \\to 64$)：$\\Theta_2 = 64 \\times 64 + 64 = 4096 + 64 = 4160$。\n- 第3层 ($64 \\to F_{\\text{out}}$)：$\\Theta_3 = 64 \\times F_{\\text{out}} + F_{\\text{out}} = 64 \\times 6 + 6 = 384 + 6 = 390$。\n\nMLP的总参数数是所有层参数的总和：\n$$ \\Theta_{\\text{MLP}} = \\Theta_1 + \\Theta_2 + \\Theta_3 = 704 + 4160 + 390 = 5254 $$\n\n**傅里叶神经算子（FNO）：**\nFNO的参数包括提升层、傅里叶层和投影层的参数。\n- 提升层（逐点 $F_{\\text{in}} \\to C$）：这是一个在$N_z$个层级上共享权重的线性层。\n$$ \\Theta_{\\text{lift}} = F_{\\text{in}} \\times C + C = 10 \\times 32 + 32 = 352 $$\n- 傅里叶层（$L=3$ 层）：每个傅里叶层包含谱卷积和逐点线性变换的参数。\n  - 谱卷积：对于$L$层中的每一层，都有一组复数值权重。对于$K$个模态中的每一个，使用一个$C \\times C$的复数权重矩阵。一个复数需要2个实数来存储。\n  $$ \\Theta_{\\text{spec}} = 2 \\times K \\times C \\times C = 2 \\times 16 \\times 32 \\times 32 = 32768 $$\n  - 逐点线性层 ($C \\to C$):\n  $$ \\Theta_{\\text{pointwise}} = C \\times C + C = 32 \\times 32 + 32 = 1024 + 32 = 1056 $$\n  $L=3$个傅里叶层的总参数为：\n  $$ \\Theta_{\\text{fourier\\_layers}} = L \\times (\\Theta_{\\text{spec}} + \\Theta_{\\text{pointwise}}) = 3 \\times (32768 + 1056) = 3 \\times 33824 = 101472 $$\n- 投影层（逐点 $C \\to F_{\\text{out}}$）：\n$$ \\Theta_{\\text{proj}} = C \\times F_{\\text{out}} + F_{\\text{out}} = 32 \\times 6 + 6 = 192 + 6 = 198 $$\nFNO的总参数数是所有组件的总和：\n$$ \\Theta_{\\text{FNO}} = \\Theta_{\\text{lift}} + \\Theta_{\\text{fourier\\_layers}} + \\Theta_{\\text{proj}} = 352 + 101472 + 198 = 102022 $$\n\n**2. 每气柱前向传播FLOPs**\n\n**MLP 每气柱FLOPs：**\n逐层的MLP在 $N_z$ 个垂直层级中的每一个上独立应用。\n- 第1层 ($F_{\\text{in}} \\to 64$) 的FLOPs：$2 \\times F_{\\text{in}} \\times 64 + 64 = 2 \\times 10 \\times 64 + 64 = 1280 + 64 = 1344$。\n- 第2层 ($64 \\to 64$) 的FLOPs：$2 \\times 64 \\times 64 + 64 = 8192 + 64 = 8256$。\n- 第3层 ($64 \\to F_{\\text{out}}$) 的FLOPs：$2 \\times 64 \\times F_{\\text{out}} + F_{\\text{out}} = 2 \\times 64 \\times 6 + 6 = 768 + 6 = 774$。\n每层的总FLOPs：$F_l = 1344 + 8256 + 774 = 10374$。\n每气柱的总FLOPs是该值乘以层级数 $N_z$：\n$$ \\text{FLOPs}_{\\text{MLP, col}} = N_z \\times F_l = 72 \\times 10374 = 746928 $$\n\n**FNO 每气柱FLOPs：**\n- 提升层（逐点 $F_{\\text{in}} \\to C$）：在$N_z$个层级上应用。\n$$ F_{\\text{lift}} = N_z \\times (2 \\times F_{\\text{in}} \\times C + C) = 72 \\times (2 \\times 10 \\times 32 + 32) = 72 \\times 672 = 48384 $$\n- 傅里叶层（$L=3$ 层）：每个层有四个计算步骤。\n  - 正向FFT：对$C$个通道中的每一个，执行长度为$N_z$的FFT。\n  $$ F_{\\text{FFT}} = C \\times (5 N_z \\log_2(N_z)) = 32 \\times (5 \\times 72 \\times \\log_2(72)) = 11520 \\log_2(72) $$\n  - 谱卷积：对于$K$个模态中的每一个，我们计算$C$个输出。每个输出是对$C$个输入的复数加权求和，成本为$8C$ FLOPs。\n  $$ F_{\\text{spec}} = K \\times C \\times (8C) = 8 K C^2 = 8 \\times 16 \\times 32^2 = 131072 $$\n  - 逆FFT：与正向FFT成本相同。\n  $$ F_{\\text{IFFT}} = 11520 \\log_2(72) $$\n  - 逐点线性层 ($C \\to C$)：在$N_z$个层级上应用。\n  $$ F_{\\text{pointwise}} = N_z \\times (2 C^2 + C) = 72 \\times (2 \\times 32^2 + 32) = 72 \\times 2080 = 149760 $$\n  $L=3$个傅里叶层的总FLOPs：\n  $$ F_{\\text{fourier\\_layers}} = L \\times (F_{\\text{FFT}} + F_{\\text{spec}} + F_{\\text{IFFT}} + F_{\\text{pointwise}}) $$\n  $$ F_{\\text{fourier\\_layers}} = 3 \\times (2 \\times 11520 \\log_2(72) + 131072 + 149760) = 3 \\times (23040 \\log_2(72) + 280832) $$\n  $$ F_{\\text{fourier\\_layers}} = 69120 \\log_2(72) + 842496 $$\n- 投影层（逐点 $C \\to F_{\\text{out}}$）：\n$$ F_{\\text{proj}} = N_z \\times (2 C F_{\\text{out}} + F_{\\text{out}}) = 72 \\times (2 \\times 32 \\times 6 + 6) = 72 \\times 390 = 28080 $$\nFNO每气柱的总FLOPs：\n$$ \\text{FLOPs}_{\\text{FNO, col}} = F_{\\text{lift}} + F_{\\text{fourier\\_layers}} + F_{\\text{proj}} $$\n$$ \\text{FLOPs}_{\\text{FNO, col}} = 48384 + (69120 \\log_2(72) + 842496) + 28080 $$\n$$ \\text{FLOPs}_{\\text{FNO, col}} = 918960 + 69120 \\log_2(72) $$\n使用 $\\log_2(72) \\approx 6.169925$：\n$$ \\text{FLOPs}_{\\text{FNO, col}} \\approx 918960 + 69120 \\times 6.169925 \\approx 918960 + 426523.23 \\approx 1345483.23 $$\n\n**3. 每次模拟器调用的总FLOPs**\n\n气柱总数为 $N_{\\text{col}} = N_x \\times N_y = 1024 \\times 1024 = 1048576$。\n- MLP总FLOPs：\n$$ \\text{FLOPs}_{\\text{MLP, total}} = N_{\\text{col}} \\times \\text{FLOPs}_{\\text{MLP, col}} = 1048576 \\times 746928 = 783216963584 \\approx 7.832 \\times 10^{11} $$\n- FNO总FLOPs：\n$$ \\text{FLOPs}_{\\text{FNO, total}} = N_{\\text{col}} \\times \\text{FLOPs}_{\\text{FNO, col}} = 1048576 \\times (918960 + 69120 \\log_2(72)) $$\n$$ \\text{FLOPs}_{\\text{FNO, total}} \\approx 1048576 \\times 1345483.23 \\approx 1410943265997 \\approx 1.411 \\times 10^{12} $$\n\n**4. 可行性分数**\n\n每次模拟器调用可用的FLOPs是性能预算和时间预算的乘积：\n$$ \\text{FLOPs}_{\\text{avail}} = P_{\\text{avail}} \\times B = (1.0 \\times 10^{15} \\text{ FLOPs/s}) \\times (0.2 \\text{ s}) = 2.0 \\times 10^{14} \\text{ FLOPs} $$\n可行性分数是所需FLOPs与可用FLOPs的比率。\n\n- MLP可行性分数：\n$$ r_{\\text{MLP}} = \\frac{\\text{FLOPs}_{\\text{MLP, total}}}{\\text{FLOPs}_{\\text{avail}}} = \\frac{783216963584}{2.0 \\times 10^{14}} \\approx 0.00391608 $$\n四舍五入到三位有效数字，$r_{\\text{MLP}} \\approx 0.00392$。\n\n- FNO可行性分数：\n$$ r_{\\text{FNO}} = \\frac{\\text{FLOPs}_{\\text{FNO, total}}}{\\text{FLOPs}_{\\text{avail}}} = \\frac{1410943265997}{2.0 \\times 10^{14}} \\approx 0.00705472 $$\n四舍五入到三位有效数字，$r_{\\text{FNO}} \\approx 0.00705$。\n\n最终答案是数值对 $(r_{\\text{FNO}}, r_{\\text{MLP}})$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.00705  0.00392\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "即使机器学习模拟器在瞬时预测上表现出高精度，它也可能在长期积分过程中无意中违反基本的物理守恒定律，例如能量守恒。这种微小的、系统性的偏差会随着时间累积，导致气候模拟出现不切实际的长期漂移。本练习模拟了一个关键的验证过程：通过将模拟器24小时的累积加热效应与基于物理的辐射通量散度进行比较，来诊断模拟器是否存在系统性的能量偏差。",
            "id": "4061564",
            "problem": "考虑一个用于数值天气预报（NWP）和气候模拟的厚度为 $\\Delta z$ 的单一均匀大气层。一个来自机器学习（ML）的仿真模型提供了每小时的层平均温度倾向，旨在再现辐射参数化的效应。为根据能量守恒来验证该仿真模型的单位和符号约定，请使用第一性原理的干空气能量方程和辐射通量辐合。\n\n假设干空气热力学和能量守恒，其中层平均辐射加热率 $q_{\\mathrm{rad}}(t)$ 满足\n$$\n\\rho c_p \\frac{dT}{dt} \\approx -\\frac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t)}{\\Delta z},\n$$\n其中 $\\rho$ 是空气密度，$c_p$ 是定压比热，$F_{\\mathrm{net}}(z,t)$ 是净垂直辐射通量（向上为正）。在离散的小时时间点 $t_k=k\\,\\Delta t$，$k=0,1,\\dots,23$ 上，取 $\\Delta t=3600\\,\\mathrm{s}$，且\n- $\\rho=1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$c_p=1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$，$\\Delta z=1000\\,\\mathrm{m}$，\n- $F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)=F_{t0}-A\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)$，其中 $F_{t0}=0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 且 $A=30\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，\n- $F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)=F_{b0}-B\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)$，其中 $F_{b0}=10\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 且 $B=45\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$。\n\nML 仿真模型提供的每小时层平均温度倾向（单位为 $\\mathrm{K}\\,\\mathrm{s}^{-1}$）由下式给出\n$$\n\\hat{q}_k=\\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right),\\quad \\alpha=\\frac{1}{120{,}480}+\\frac{1}{2{,}000{,}000},\\quad \\beta=-\\frac{1}{80{,}320}.\n$$\n\n任务：\n1. 使用上述通量，计算24小时累积的物理辐射加热\n$$\n\\Delta T_{\\mathrm{rad}}=\\sum_{k=0}^{23} q_{\\mathrm{rad}}(t_k)\\,\\Delta t,\n$$\n其中 $q_{\\mathrm{rad}}(t_k)=-\\dfrac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)}{\\rho c_p \\Delta z}$。\n2. 计算24小时累积的仿真模型加热\n$$\n\\Delta T_{\\mathrm{ML}}=\\sum_{k=0}^{23} \\hat{q}_k\\,\\Delta t.\n$$\n3. 计算诊断性不匹配\n$$\n\\Delta=\\Delta T_{\\mathrm{ML}}-\\Delta T_{\\mathrm{rad}},\n$$\n以此作为对照辐射通量辐合来验证仿真模型的单位和符号约定的一种方式。\n\n将 $\\Delta$ 的最终答案以开尔文表示，并四舍五入到四位有效数字。",
            "solution": "目标是计算机器学习（ML）仿真模型产生的24小时累积加热与从通量散度导出的物理辐射加热之间的诊断性不匹配 $\\Delta = \\Delta T_{\\mathrm{ML}} - \\Delta T_{\\mathrm{rad}}$。这可以作为对仿真模型能量守恒特性的一种验证。计算按要求的三个步骤进行。\n\n物理常数和参数如下：\n空气密度，$\\rho=1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n定压比热，$c_p=1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$。\n层厚度，$\\Delta z=1000\\,\\mathrm{m}$。\n时间步长，$\\Delta t=3600\\,\\mathrm{s}$。\n乘积 $\\rho c_p \\Delta z$ 代表单位面积大气层的热容。\n$$\n\\rho c_p \\Delta z = (1.2\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}) \\times (1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}) \\times (1000\\,\\mathrm{m}) = 1,204,800\\,\\mathrm{J}\\,\\mathrm{m}^{-2}\\,\\mathrm{K}^{-1}.\n$$\n\n首先，我们计算24小时累积的物理辐射加热 $\\Delta T_{\\mathrm{rad}}$。\n在离散时间 $t_k = k \\Delta t$ 的物理辐射加热率由下式给出\n$$\nq_{\\mathrm{rad}}(t_k)=-\\dfrac{F_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k)}{\\rho c_p \\Delta z}.\n$$\n该层顶部和底部之间的净通量差为\n$$\nF_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k) = \\left(F_{t0}-A\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\right) - \\left(F_{b0}-B\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\right) = (F_{t0}-F_{b0})-(A-B)\\sin\\!\\left(\\frac{2\\pi k}{24}\\right).\n$$\n代入给定值 $F_{t0}=0\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，$F_{b0}=10\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$，$A=30\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$ 和 $B=45\\,\\mathrm{W}\\,\\mathrm{m}^{-2}$：\n$$\nF_{\\mathrm{net}}(z_{\\mathrm{top}},t_k)-F_{\\mathrm{net}}(z_{\\mathrm{bot}},t_k) = (0 - 10) - (30 - 45)\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) = -10 + 15\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\,\\mathrm{W}\\,\\mathrm{m}^{-2}.\n$$\n于是辐射加热率为\n$$\nq_{\\mathrm{rad}}(t_k) = -\\frac{-10 + 15\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)}{1,204,800} = \\frac{10}{1,204,800} - \\frac{15}{1,204,800}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right).\n$$\n化简系数，我们得到\n$$\nq_{\\mathrm{rad}}(t_k) = \\frac{1}{120,480} - \\frac{1}{80,320}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right)\\,\\mathrm{K}\\,\\mathrm{s}^{-1}.\n$$\n24小时内的总累积加热是对 k 从 0 到 23 的求和：\n$$\n\\Delta T_{\\mathrm{rad}}=\\sum_{k=0}^{23} q_{\\mathrm{rad}}(t_k)\\,\\Delta t = \\Delta t \\sum_{k=0}^{23} \\left[ \\frac{1}{120,480} - \\frac{1}{80,320}\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) \\right].\n$$\n正弦函数在一个完整离散周期上的和为零：$\\sum_{k=0}^{N-1} \\sin(2\\pi k/N) = 0$。在本例中，$N=24$。\n$$\n\\sum_{k=0}^{23} \\sin\\!\\left(\\frac{2\\pi k}{24}\\right) = 0.\n$$\n因此，求和可简化为\n$$\n\\Delta T_{\\mathrm{rad}} = \\Delta t \\sum_{k=0}^{23} \\frac{1}{120,480} = (3600\\,\\mathrm{s}) \\times 24 \\times \\frac{1}{120,480} = \\frac{86,400}{120,480}\\,\\mathrm{K} = \\frac{8,640}{12,048}\\,\\mathrm{K} = \\frac{180}{251}\\,\\mathrm{K}.\n$$\n\n其次，我们计算24小时累积的仿真模型加热 $\\Delta T_{\\mathrm{ML}}$。\nML 仿真模型提供的温度倾向为\n$$\n\\hat{q}_k=\\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right),\n$$\n其中 $\\alpha=\\frac{1}{120,480}+\\frac{1}{2,000,000}$ 且 $\\beta=-\\frac{1}{80,320}$。\n来自 ML 模型的总累积加热为\n$$\n\\Delta T_{\\mathrm{ML}}=\\sum_{k=0}^{23} \\hat{q}_k\\,\\Delta t = \\Delta t \\sum_{k=0}^{23} \\left[ \\alpha+\\beta\\sin\\!\\left(\\frac{2\\pi k}{24}\\right) \\right].\n$$\n同样，正弦项的和为零。\n$$\n\\Delta T_{\\mathrm{ML}} = \\Delta t \\sum_{k=0}^{23} \\alpha = (3600\\,\\mathrm{s}) \\times 24 \\times \\alpha = 86,400 \\alpha.\n$$\n代入 $\\alpha$ 的值：\n$$\n\\Delta T_{\\mathrm{ML}} = 86,400 \\left( \\frac{1}{120,480}+\\frac{1}{2,000,000} \\right) = \\frac{86,400}{120,480} + \\frac{86,400}{2,000,000}.\n$$\n第一项与 $\\Delta T_{\\mathrm{rad}}$ 相同：\n$$\n\\Delta T_{\\mathrm{ML}} = \\frac{180}{251} + \\frac{86,400}{2,000,000} = \\frac{180}{251} + 0.0432\\,\\mathrm{K}.\n$$\n\n第三，我们计算诊断性不匹配 $\\Delta$。\n$$\n\\Delta = \\Delta T_{\\mathrm{ML}} - \\Delta T_{\\mathrm{rad}} = \\left( \\frac{180}{251} + 0.0432 \\right) - \\frac{180}{251} = 0.0432\\,\\mathrm{K}.\n$$\n题目要求最终答案应四舍五入到四位有效数字。数字 $0.0432$ 有三位有效数字（数字 $4$、$3$ 和 $2$）。为了用四位有效数字表示，我们在末尾加一个零。\n$$\n\\Delta = 0.04320\\,\\mathrm{K}.\n$$\n这种不匹配源于 ML 仿真模型平均加热率中的微小常数偏差，由 $\\alpha$ 中的项 $\\frac{1}{2,000,000}$ 表示。该仿真模型正确地捕捉了加热日循环的相位和振幅（因为 $\\beta$ 与物理值 $-\\frac{1}{80,320}$ 相匹配），但略微错失了24小时的平均加热。这种类型的诊断对于确保 ML 仿真模型在长期气候模拟中不引入系统性能量漂移至关重要。",
            "answer": "$$\\boxed{0.04320}$$"
        },
        {
            "introduction": "当诊断测试表明模拟器未能守恒如能量这样的关键物理量时，我们必须采取措施进行修正。这确保了耦合模型的稳定性和物理真实性，是构建可靠的混合物理-机器学习模型的最后一道防线。此练习将引导您实施一种常见且有效的“后验”校正技术：首先计算整层大气柱的能量收支误差，然后对温度趋势廓线施加一个统一的修正，以强制闭合能量平衡。",
            "id": "4061580",
            "problem": "在数值天气预报（NWP）模型中，一个机器学习（ML）模拟器被用来预测单个大气柱内温度和比湿的次网格非绝热倾向。该模拟器在压力离散化的基础上输出逐层的倾向 $\\dot{T}_{i}$ 和 $\\dot{q}_{i}$。为了确保整层大气的能量平衡，整层积分的湿静力能倾向必须与外部给定的净非绝热能量通量辐合目标 $F_{\\mathrm{req}}$ 相一致。从单位质量的湿静力能 $h = c_{p} T + L_{v} q + g z$ 开始，其中 $c_{p}$ 是干空气的定压比热，$L_{v}$ 是汽化潜热，$g$ 是重力加速度。假设静力平衡，并忽略固定层边界处重力势能项的变化。整层积分的湿静力能倾向被定义为质量加权的垂直积分\n$$\nE = \\frac{1}{g} \\int_{p_{\\mathrm{top}}}^{p_{\\mathrm{sfc}}} \\left( c_{p} \\,\\dot{T}(p) + L_{v} \\,\\dot{q}(p) \\right) \\, dp,\n$$\n并且，在具有层厚度 $\\Delta p_{i}$ 的逐层近似下，离散化为\n$$\nE_{\\mathrm{emul}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i} \\right).\n$$\n给定一个三层大气柱（$N=3$），数据如下：\n- $g = 9.81\\,\\mathrm{m\\,s^{-2}}$，$c_{p} = 1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$，$L_{v} = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$，\n- $\\Delta p_{1} = 25000\\,\\mathrm{Pa}$，$\\Delta p_{2} = 40000\\,\\mathrm{Pa}$，$\\Delta p_{3} = 35000\\,\\mathrm{Pa}$，\n- $\\dot{T}_{1} = 1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{T}_{2} = -8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{T}_{3} = 3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，\n- $\\dot{q}_{1} = 2.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，$\\dot{q}_{2} = 0.5 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，$\\dot{q}_{3} = -1.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$，\n- $F_{\\mathrm{req}} = 95\\,\\mathrm{W\\,m^{-2}}$，以及容差 $\\epsilon = 1\\,\\mathrm{W\\,m^{-2}}$。\n\n(a) 计算模拟器预测的整层积分湿静力能倾向 $E_{\\mathrm{emul}}$ 以及残差\n$$\nR = E_{\\mathrm{emul}} - F_{\\mathrm{req}}.\n$$\n(b) 构造一个物理上一致的对模拟器倾向的修正，该修正仅通过一个均匀的偏移量 $\\delta \\dot{T}_{i} = \\alpha$（对 $i$ 是常数）来调整温度倾向，并保持湿度倾向不变（$\\delta \\dot{q}_{i} = 0$），使得修正后的整层积分倾向在容差 $\\epsilon$ 内满足能量平衡，即：\n$$\n\\left| \\left( E_{\\mathrm{emul}} + \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} c_{p} \\alpha \\right) - F_{\\mathrm{req}} \\right| \\le \\epsilon.\n$$\n假设当 $|R| > \\epsilon$ 时采用强制精确平衡的最小修正，否则不进行修正。请推导出 $\\alpha$ 的表达式，并根据给定数据计算其数值。最终的 $\\alpha$ 以 $\\mathrm{K\\,s^{-1}}$ 为单位表示，并四舍五入到四位有效数字。",
            "solution": "该问题已经过验证，被认为是科学上可靠、适定、客观、完整和一致的。所有求解所需量的数据和定义都已提供。其物理背景是大气科学和数值模拟中的标准问题，涉及在机器学习参数化方案上强制执行守恒定律。\n\n该问题分为两部分。首先，我们计算模拟器预测的整层积分湿静力能倾向 $E_{\\mathrm{emul}}$ 及其相对于所需能量通量辐合 $F_{\\mathrm{req}}$ 的残差 $R$。其次，我们推导并计算一个对温度倾向的均匀修正量 $\\alpha$ 以强制实现能量平衡。\n\n第 (a) 部分：计算 $E_{\\mathrm{emul}}$ 和 $R$。\n\n模拟器预测的整层积分湿静力能倾向 $E_{\\mathrm{emul}}$ 由以下离散化公式给出：\n$$\nE_{\\mathrm{emul}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i} \\right)\n$$\n我们给定 $N=3$ 层以及以下常数和数据：\n- $g = 9.81\\,\\mathrm{m\\,s^{-2}}$\n- $c_{p} = 1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$\n- $L_{v} = 2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}$\n- 第1层：$\\Delta p_{1} = 25000\\,\\mathrm{Pa}$，$\\dot{T}_{1} = 1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{1} = 2.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n- 第2层：$\\Delta p_{2} = 40000\\,\\mathrm{Pa}$，$\\dot{T}_{2} = -8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{2} = 0.5 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n- 第3层：$\\Delta p_{3} = 35000\\,\\mathrm{Pa}$，$\\dot{T}_{3} = 3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}$，$\\dot{q}_{3} = -1.0 \\times 10^{-8}\\,\\mathrm{kg\\,kg^{-1}\\,s^{-1}}$\n\n让我们计算每一层 $i$ 的项 $h_{i}^{\\prime} = c_{p} \\,\\dot{T}_{i} + L_{v} \\,\\dot{q}_{i}$：\n对于第1层：\n$h_{1}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (1.5 \\times 10^{-5}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (2.0 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{1}^{\\prime} = 0.01506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} + 0.05\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = 0.06506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n对于第2层：\n$h_{2}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (-8.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (0.5 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{2}^{\\prime} = -0.008032\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} + 0.0125\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = 0.004468\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n对于第3层：\n$h_{3}^{\\prime} = (1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (3.0 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}) + (2.5 \\times 10^{6}\\,\\mathrm{J\\,kg^{-1}}) (-1.0 \\times 10^{-8}\\,\\mathrm{s^{-1}})$\n$h_{3}^{\\prime} = 0.003012\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} - 0.025\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}} = -0.021988\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}$\n\n现在，我们计算总和 $\\sum_{i=1}^{3} \\Delta p_{i} h_{i}^{\\prime}$：\n$\\sum_{i=1}^{3} \\Delta p_{i} h_{i}^{\\prime} = (25000\\,\\mathrm{Pa})(0.06506\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}) + (40000\\,\\mathrm{Pa})(0.004468\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}}) + (35000\\,\\mathrm{Pa})(-0.021988\\,\\mathrm{J\\,kg^{-1}\\,s^{-1}})$\n$= 1626.5 + 178.72 - 769.58 = 1035.64\\,\\mathrm{Pa \\cdot J \\cdot kg^{-1} \\cdot s^{-1}}$.\n因子 $1/g$ 修正了单位。我们验证最终量 $E$ 的单位：$\\frac{1}{g} \\sum \\Delta p_i (\\dots)$ 的单位是 $\\frac{\\mathrm{s}^2}{\\mathrm{m}} \\cdot \\mathrm{Pa} \\cdot \\frac{\\mathrm{J}}{\\mathrm{kg} \\cdot \\mathrm{s}} = \\frac{\\mathrm{s}^2}{\\mathrm{m}} \\cdot \\frac{\\mathrm{kg}}{\\mathrm{m} \\cdot \\mathrm{s}^2} \\cdot \\frac{\\mathrm{J}}{\\mathrm{kg} \\cdot \\mathrm{s}} = \\frac{\\mathrm{J}}{\\mathrm{m}^2 \\cdot \\mathrm{s}} = \\mathrm{W\\,m^{-2}}$，这是一个通量，符合要求。\n\n现在，我们计算 $E_{\\mathrm{emul}}$：\n$$\nE_{\\mathrm{emul}} = \\frac{1035.64\\,\\mathrm{Pa \\cdot J \\cdot kg^{-1} \\cdot s^{-1}}}{9.81\\,\\mathrm{m\\,s^{-2}}} \\approx 105.57003\\,\\mathrm{W\\,m^{-2}}\n$$\n残差 $R$ 定义为 $R = E_{\\mathrm{emul}} - F_{\\mathrm{req}}$。给定 $F_{\\mathrm{req}} = 95\\,\\mathrm{W\\,m^{-2}}$：\n$$\nR = 105.57003\\,\\mathrm{W\\,m^{-2}} - 95\\,\\mathrm{W\\,m^{-2}} = 10.57003\\,\\mathrm{W\\,m^{-2}}\n$$\n\n第 (b) 部分：修正量 $\\alpha$ 的推导和计算。\n\n修正仅应用于温度倾向，使得对所有层 $i$ 有 $\\delta \\dot{T}_{i} = \\alpha$，且 $\\delta \\dot{q}_{i} = 0$。修正后的模拟器倾向 $E_{\\mathrm{corr}}$ 为：\n$$\nE_{\\mathrm{corr}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} (\\dot{T}_{i} + \\alpha) + L_{v} \\dot{q}_{i} \\right)\n$$\n我们可以将其分解为原始倾向和修正项：\n$$\nE_{\\mathrm{corr}} = \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} \\left( c_{p} \\dot{T}_{i} + L_{v} \\dot{q}_{i} \\right) + \\frac{1}{g} \\sum_{i=1}^{N} \\Delta p_{i} c_{p} \\alpha\n$$\n第一项是 $E_{\\mathrm{emul}}$。由于 $\\alpha$ 和 $c_p$ 是常数，我们可以将它们从求和中提出来：\n$$\nE_{\\mathrm{corr}} = E_{\\mathrm{emul}} + \\frac{c_{p} \\alpha}{g} \\sum_{i=1}^{N} \\Delta p_{i}\n$$\n设 $\\Delta p_{\\mathrm{tot}} = \\sum_{i=1}^{N} \\Delta p_{i}$ 为大气柱的总气压厚度。\n$\\Delta p_{\\mathrm{tot}} = 25000\\,\\mathrm{Pa} + 40000\\,\\mathrm{Pa} + 35000\\,\\mathrm{Pa} = 100000\\,\\mathrm{Pa}$。\n因此，修正后的倾向为：\n$$\nE_{\\mathrm{corr}} = E_{\\mathrm{emul}} + \\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g}\n$$\n问题规定，只有当残差的绝对值超过容差时才进行修正，即 $|R| > \\epsilon$。\n我们有 $|R| \\approx 10.57\\,\\mathrm{W\\,m^{-2}}$ 且 $\\epsilon = 1\\,\\mathrm{W\\,m^{-2}}$。由于 $|R| > \\epsilon$，因此需要进行修正。最小修正是实现精确能量平衡的修正：$E_{\\mathrm{corr}} = F_{\\mathrm{req}}$。\n将 $E_{\\mathrm{corr}}$ 设为 $F_{\\mathrm{req}}$，我们得到：\n$$\nF_{\\mathrm{req}} = E_{\\mathrm{emul}} + \\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g}\n$$\n我们求解 $\\alpha$：\n$$\n\\alpha \\frac{c_{p} \\Delta p_{\\mathrm{tot}}}{g} = F_{\\mathrm{req}} - E_{\\mathrm{emul}} = -R\n$$\n$$\n\\alpha = -R \\left( \\frac{g}{c_{p} \\Delta p_{\\mathrm{tot}}} \\right)\n$$\n这是 $\\alpha$ 的符号表达式。现在我们代入数值：\n$$\n\\alpha = -(10.57003\\,\\mathrm{W\\,m^{-2}}) \\left( \\frac{9.81\\,\\mathrm{m\\,s^{-2}}}{(1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}) (100000\\,\\mathrm{Pa})} \\right)\n$$\n$$\n\\alpha = -10.57003 \\left( \\frac{9.81}{100400000} \\right) \\mathrm{K\\,s^{-1}}\n$$\n$$\n\\alpha \\approx -10.57003 \\times (9.770916 \\times 10^{-8}) \\mathrm{K\\,s^{-1}}\n$$\n$$\n\\alpha \\approx -1.03287 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}\n$$\n根据要求将结果四舍五入到四位有效数字：\n$$\n\\alpha \\approx -1.033 \\times 10^{-6}\\,\\mathrm{K\\,s^{-1}}\n$$\n这对应于对所有层施加一个小的、均匀的冷却，以抵消模拟器产生的多余能量。\n\n如果 $|R| \\le \\epsilon$，则不满足应用修正的条件，解将是 $\\alpha=0$。我们计算出的 $R$ 明显超过了容差，因此非零修正是正确的途径。\n最后检查规则：“当 $|R| > \\epsilon$ 时强制精确平衡的最小修正，否则不进行修正”。我们的步骤完全符合此规则。",
            "answer": "$$\n\\boxed{-1.033 \\times 10^{-6}}\n$$"
        }
    ]
}