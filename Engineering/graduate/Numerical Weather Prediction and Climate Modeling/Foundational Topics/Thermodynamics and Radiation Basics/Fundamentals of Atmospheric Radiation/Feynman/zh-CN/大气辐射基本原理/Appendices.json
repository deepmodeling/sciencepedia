{
    "hands_on_practices": [
        {
            "introduction": "在辐射传输模型中，我们常常需要从辐射场的详细角度信息（即比辐射强度）中计算出宏观的能量净流（即通量）。本练习将引导你完成这一基本关系的具体推导。通过这个过程，你将理解辐射场的数学结构，特别是其对称性，是如何直接决定通量的，这是发展如双流近似等高效数值方案的关键概念 。",
            "id": "4046924",
            "problem": "在数值天气预报和气候模拟中使用的平面平行、方位对称大气层中，考虑频率为 $\\nu$ 的谱比辐射强度 $I_{\\nu}(\\mu)$，其中 $\\mu=\\cos\\theta$，$\\theta$ 是从局地向上法线测量的天顶角。假设 $I_{\\nu}$ 是稳态的，并且仅依赖于 $\\mu$，且其具有最低阶的非平凡角向表示\n$$\nI_{\\nu}(\\mu)=a+b\\,\\mu,\n$$\n其中 $a$ 和 $b$ 是在给定频率 $\\nu$ 下的常数（与 $\\mu$ 无关），其单位为比辐射强度 $\\mathrm{W\\, m^{-2}\\, Hz^{-1}\\, sr^{-1}}$。取向上方向为正，因此 $\\mu>0$ 对应于向上-传播的辐射。\n\n严格从谱比辐射强度的定义以及净垂直谱通量作为比辐射强度在整个立体角上的一阶角矩的定义出发，\n$$\nF_{\\nu}=\\int_{4\\pi} \\mu\\, I_{\\nu}\\, d\\Omega,\n$$\n利用所述的对称性，推导出 $F_{\\nu}$ 关于 $a$ 和 $b$ 的显式闭式表达式。然后，从物理角度解释你结果的数学结构：指出 $I_{\\nu}$ 的哪个（些）分量对净垂直谱通量有贡献，并参考其潜在的角对称性解释原因。同时，将你的系数与双流闭合中使用的正则角矩联系起来。\n\n请用单位 $\\mathrm{W\\, m^{-2}\\, Hz^{-1}}$ 表示你的最终通量。不需要进行数值计算或四舍五入；仅提供一个用 $a$ 和 $b$ 表示的闭式表达式。",
            "solution": "谱比辐射强度 $I_{\\nu}(\\mathbf{\\Omega})$ 的定义是，在时间 $dt$ 内，频率间隔 $d\\nu$ 内，沿方向 $\\mathbf{\\Omega}$ 周围的立体角元 $d\\Omega$ 传播，穿过面积元 $dA$ 的辐射能量为 $I_{\\nu}(\\mathbf{\\Omega}) \\cos\\theta\\, dA\\, dt\\, d\\nu\\, d\\Omega$，其中 $\\theta$ 是 $\\mathbf{\\Omega}$ 与向上单位法线之间的夹角。净垂直谱通量 $F_{\\nu}$ 是 $I_{\\nu}$ 在所有立体角上的方向一阶矩，由下式给出：\n$$\nF_{\\nu}=\\int_{4\\pi} \\mu\\, I_{\\nu}\\, d\\Omega,\n$$\n其中 $\\mu=\\cos\\theta$。在平面平行、方位对称的介质中，$I_{\\nu}$ 仅依赖于 $\\mu$ 而不依赖于方位角 $\\phi$，因此 $d\\Omega=d\\phi\\, d\\mu$，方位角积分可以提出来得到 $2\\pi$。所以，\n$$\nF_{\\nu}=\\int_{0}^{2\\pi} d\\phi \\int_{-1}^{1} \\mu\\, I_{\\nu}(\\mu)\\, d\\mu \\;=\\; 2\\pi \\int_{-1}^{1} \\mu\\, I_{\\nu}(\\mu)\\, d\\mu.\n$$\n根据给定的角向依赖关系 $I_{\\nu}(\\mu)=a+b\\,\\mu$，上式变为\n$$\nF_{\\nu}=2\\pi \\int_{-1}^{1} \\mu \\big(a+b\\,\\mu\\big)\\, d\\mu \\;=\\; 2\\pi \\left[a \\int_{-1}^{1} \\mu\\, d\\mu \\;+\\; b \\int_{-1}^{1} \\mu^{2}\\, d\\mu \\right].\n$$\n第一个积分为\n$$\n\\int_{-1}^{1} \\mu\\, d\\mu \\;=\\; \\left.\\frac{\\mu^{2}}{2}\\right|_{-1}^{1} \\;=\\; \\frac{1}{2}-\\frac{1}{2}\\;=\\;0,\n$$\n第二个积分为\n$$\n\\int_{-1}^{1} \\mu^{2}\\, d\\mu \\;=\\; \\left.\\frac{\\mu^{3}}{3}\\right|_{-1}^{1} \\;=\\; \\frac{1}{3}-\\left(-\\frac{1}{3}\\right)\\;=\\;\\frac{2}{3}.\n$$\n因此，\n$$\nF_{\\nu}=2\\pi \\left[a \\cdot 0 + b \\cdot \\frac{2}{3}\\right]\\;=\\;\\frac{4\\pi}{3}\\, b.\n$$\n\n物理解释。系数 $a$ 乘以强度的各向同性分量。它对 $F_{\\nu}$ 的贡献为零，因为该部分的被积函数与 $\\mu$ 成正比，而 $\\mu$ 在 $\\mu\\in[-1,1]$ 上是反对称的；向上和向下的方向正好抵消。系数 $b$ 乘以 $\\mu$ 中的一阶（偶极）各向异性，只有这个分量产生非零的净垂直谱通量。因此，净通量与 $b$ 中所包含的前后不对称程度成正比。\n\n与角矩和闭合的关系。定义标准角矩\n$$\nJ_{\\nu} \\equiv \\frac{1}{4\\pi}\\int_{4\\pi} I_{\\nu}\\, d\\Omega,\\qquad H_{\\nu} \\equiv \\frac{1}{4\\pi}\\int_{4\\pi} \\mu\\, I_{\\nu}\\, d\\Omega=\\frac{F_{\\nu}}{4\\pi},\\qquad K_{\\nu} \\equiv \\frac{1}{4\\pi}\\int_{4\\pi} \\mu^{2} I_{\\nu}\\, d\\Omega.\n$$\n对于 $I_{\\nu}(\\mu)=a+b\\,\\mu$ 和方位对称性，\n$$\nJ_{\\nu}=\\frac{1}{2}\\int_{-1}^{1} (a+b\\,\\mu)\\, d\\mu = a,\\qquad H_{\\nu}=\\frac{1}{2}\\int_{-1}^{1} \\mu (a+b\\,\\mu)\\, d\\mu = \\frac{b}{3},\\qquad K_{\\nu}=\\frac{1}{2}\\int_{-1}^{1} \\mu^{2} (a+b\\,\\mu)\\, d\\mu = \\frac{a}{3}.\n$$\n因此，$F_{\\nu}=4\\pi H_{\\nu}=\\frac{4\\pi}{3} b$，并且爱丁顿因子 $f\\equiv K_{\\nu}/J_{\\nu}=\\frac{1}{3}$，这与经典的爱丁顿闭合一致。在物理上，$a$ 是平均强度，而 $b$ 控制净通量，并与一阶角矩直接相关。\n\n量纲分析。由于 $b$ 的单位是比辐射强度 $\\mathrm{W\\, m^{-2}\\, Hz^{-1}\\, sr^{-1}}$，并且立体角积分贡献了一个因子 $\\mathrm{sr}$，因此结果 $F_{\\nu}=(4\\pi/3)b$ 的单位为 $\\mathrm{W\\, m^{-2}\\, Hz^{-1}}$，符合要求。",
            "answer": "$$\\boxed{\\frac{4\\pi}{3}\\,b}$$"
        },
        {
            "introduction": "接下来，我们将注意力转向大气层的下边界。准确地表征地球表面如何反射太阳光对于气候和天气模拟至关重要。本练习将超越简化的朗伯（Lambertian）反射假设，引入更为物理真实的双向反射分布函数（BRDF）。通过推导和比较两种模型计算出的向上通量，你将对地表特性如何影响地球能量收支获得定量的理解 。",
            "id": "4046875",
            "problem": "您将推导并实现一个计算，用于在准直光照下，一个具有非Lambertian双向反射分布函数（BRDF）的平坦、水平均匀表面的上行短波通量，并将其与在Lambertian假设下获得的通量进行比较。推导必须从辐射传输的第一性原理开始，仅使用以下基本定义：辐亮度、辐照度、BRDF以及半球上的半球通量积分。除了这些基本定义之外，不得预先假设任何其他公式。\n\n考虑一个表面，被一束光束法向辐照度为 $E_{\\mathrm{b}}$（单位为 $\\mathrm{W\\,m^{-2}}$）的准直短波光束照射，其太阳天顶角为 $\\theta_{0}$（单位为度），太阳方位角为 $\\phi_{0}$（单位为度）。记 $\\mu_{0} = \\cos\\theta_{0}$，在计算余弦时将 $\\theta_{0}$ 转换为弧度。该表面的BRDF指定为\n$$\nf_{r}(\\theta_{i},\\phi_{i},\\theta_{r},\\phi_{r}) \\;=\\; \\frac{a}{\\pi} \\;+\\; \\frac{b}{\\pi}\\,\\cos\\theta_{i}\\,\\cos\\theta_{r},\n$$\n其中 $a \\ge 0$，$b \\ge 0$，并受能量守恒约束 $a + \\frac{2}{3}b \\le 1$。此BRDF是方位角各向同性且互易的，单位为 $\\mathrm{sr^{-1}}$。入射光束来自 $(\\theta_{i},\\phi_{i})=(\\theta_{0},\\phi_{0})$。\n\n从基本定义出发：\n- 对于准直光束，反射辐亮度满足 $L_{r}(\\theta_{r},\\phi_{r}) = f_{r}(\\theta_{0},\\phi_{0},\\theta_{r},\\phi_{r})\\,E_{\\mathrm{b}}\\,\\cos\\theta_{0}$。\n- 上行半球通量为 $F^{\\uparrow} = \\int_{\\Omega^{+}} L_{r}(\\theta_{r},\\phi_{r})\\,\\cos\\theta_{r}\\,d\\Omega_{r}$，\n\n对于上述非Lambertian BRDF，推导出一个关于 $E_{\\mathrm{b}}$、$a$、$b$ 和 $\\mu_{0}$ 的上行通量 $F^{\\uparrow}_{\\mathrm{NL}}$（单位为 $\\mathrm{W\\,m^{-2}}$）的闭合形式表达式。然后，定义一个Lambertian比较器，其反射率参数 $\\rho_{\\mathrm{L}}$ 的选择应与法向入射时非Lambertian表面的方向-半球反射率相匹配。也就是说，选择 $\\rho_{\\mathrm{L}}$ 使得在 $\\theta_{0}=0$ 时的半球反射率在两个模型之间是相同的。使用此Lambertian假设，推导出在相同光照几何 $(E_{\\mathrm{b}},\\theta_{0})$ 下相应的上行通量 $F^{\\uparrow}_{\\mathrm{L}}$（单位为 $\\mathrm{W\\,m^{-2}}$）。\n\n您的程序必须：\n- 为每个测试用例计算以下三元量：\n  1. $F^{\\uparrow}_{\\mathrm{NL}}$，单位为 $\\mathrm{W\\,m^{-2}}$，\n  2. $F^{\\uparrow}_{\\mathrm{L}}$，单位为 $\\mathrm{W\\,m^{-2}}$，\n  3. 无量纲比率 $r = F^{\\uparrow}_{\\mathrm{NL}}/F^{\\uparrow}_{\\mathrm{L}}$。\n- 使用以度为单位提供的 $\\theta_{0}$，并在内部将其转换为弧度以计算 $\\mu_{0} = \\cos\\theta_{0}$。\n- 所有通量以 $\\mathrm{W\\,m^{-2}}$ 表示，并将每个通量四舍五入到三位小数；比率 $r$ 表示为无量纲数，四舍五入到六位小数。\n- 生成一行输出，包含所有结果，格式为逗号分隔的列表，并用方括号括起来，顺序为\n  $[F^{\\uparrow}_{\\mathrm{NL}}(1),F^{\\uparrow}_{\\mathrm{L}}(1),r(1),F^{\\uparrow}_{\\mathrm{NL}}(2),F^{\\uparrow}_{\\mathrm{L}}(2),r(2),\\dots]$。\n\n使用以下测试套件，它取决于指定的BRDF参数和光照几何。对于所有情况，使用 $E_{\\mathrm{b}} = 1000\\,\\mathrm{W\\,m^{-2}}$。\n\n- 情况 $1$ (理想情况，法向入射): $\\theta_{0}=0$ 度, $a=0.2$, $b=0.6$。\n- 情况 $2$ (强斜射光照): $\\theta_{0}=78.463040967$ 度, $a=0.2$, $b=0.6$。\n- 情况 $3$ (能量守恒边界情况): $\\theta_{0}=60$ 度, $a=0.5$, $b=0.75$。\n- 情况 $4$ (Lambertian表面特例): $\\theta_{0}=36.86989765$ 度, $a=0.3$, $b=0.0$。\n\n您的程序应生成一行输出，包含所有结果，格式为逗号分隔的列表，并用方括号括起来（例如，$[x_{1},x_{2},x_{3},x_{4},x_{5},x_{6},x_{7},x_{8},x_{9},x_{10},x_{11},x_{12}]$），其中每个 $x_{k}$ 都是按上述格式格式化的浮点数。不应打印任何其他文本。",
            "solution": "此问题的分析始于辐射传输的基本原理。主要目标是计算来自表面的上行短波辐射通量，其定义为反射辐亮度 $L_{r}$ 乘以反射天顶角 $\\theta_{r}$ 的余弦，在上行半球 $\\Omega^{+}$ 上的积分。这在数学上由半球通量积分表示：\n$$\nF^{\\uparrow} = \\int_{\\Omega^{+}} L_{r}(\\theta_{r},\\phi_{r})\\,\\cos\\theta_{r}\\,d\\Omega_{r}\n$$\n在此方程中，$d\\Omega_{r}$ 代表微分立体角，在球坐标中由 $d\\Omega_{r} = \\sin\\theta_{r}\\,d\\theta_{r}\\,d\\phi_{r}$ 给出。积分在反射天顶角 $\\theta_{r}$ 从 $0$ 到 $\\pi/2$ 和反射方位角 $\\phi_{r}$ 从 $0$ 到 $2\\pi$ 的范围内进行。\n\n反射辐亮度 $L_{r}$ 由表面的双向反射分布函数（BRDF）$f_{r}$ 和入射光照决定。对于从方向 $(\\theta_{0}, \\phi_{0})$ 入射的光束法向辐照度为 $E_{\\mathrm{b}}$ 的准直光束，其在水平表面上的辐照度为 $E^{\\downarrow} = E_{\\mathrm{b}}\\cos\\theta_{0}$。问题陈述了反射辐亮度的关系为：\n$$\nL_{r}(\\theta_{r},\\phi_{r}) = f_{r}(\\theta_{0},\\phi_{0},\\theta_{r},\\phi_{r})\\,E_{\\mathrm{b}}\\,\\cos\\theta_{0}\n$$\n为方便起见，我们定义太阳天顶角的余弦为 $\\mu_{0} = \\cos\\theta_{0}$。\n\n**1. 非Lambertian通量 ($F^{\\uparrow}_{\\mathrm{NL}}$) 的推导**\n\n给定一个特定的非Lambertian BRDF：\n$$\nf_{r}(\\theta_{i},\\phi_{i},\\theta_{r},\\phi_{r}) = \\frac{a}{\\pi} + \\frac{b}{\\pi}\\,\\cos\\theta_{i}\\,\\cos\\theta_{r}\n$$\n对于从 $(\\theta_{0},\\phi_{0})$ 入射的光束，此BRDF变为：\n$$\nf_{r}(\\theta_{0},\\phi_{0},\\theta_{r},\\phi_{r}) = \\frac{a}{\\pi} + \\frac{b}{\\pi}\\,\\mu_{0}\\,\\cos\\theta_{r}\n$$\n将此代入反射辐亮度的表达式中，得到：\n$$\nL_{r}(\\theta_{r},\\phi_{r}) = \\left( \\frac{a}{\\pi} + \\frac{b}{\\pi}\\,\\mu_{0}\\,\\cos\\theta_{r} \\right) E_{\\mathrm{b}}\\,\\mu_{0}\n$$\n为了找到总上行通量 $F^{\\uparrow}_{\\mathrm{NL}}$，我们将此辐亮度在上行半球上积分：\n$$\nF^{\\uparrow}_{\\mathrm{NL}} = \\int_{0}^{2\\pi} \\int_{0}^{\\pi/2} \\left[ \\left( \\frac{a}{\\pi} + \\frac{b}{\\pi}\\,\\mu_{0}\\,\\cos\\theta_{r} \\right) E_{\\mathrm{b}}\\,\\mu_{0} \\right] \\cos\\theta_{r}\\,\\sin\\theta_{r}\\,d\\theta_{r}\\,d\\phi_{r}\n$$\n被积函数与方位角 $\\phi_{r}$ 无关，因此对 $\\phi_{r}$ 从 $0$ 到 $2\\pi$ 的积分引入了一个因子 $2\\pi$。\n$$\nF^{\\uparrow}_{\\mathrm{NL}} = 2\\pi \\int_{0}^{\\pi/2} \\left( \\frac{a}{\\pi} E_{\\mathrm{b}}\\,\\mu_{0} + \\frac{b}{\\pi} E_{\\mathrm{b}}\\,\\mu_{0}^{2}\\,\\cos\\theta_{r} \\right) \\cos\\theta_{r}\\,\\sin\\theta_{r}\\,d\\theta_{r}\n$$\n将常数提出积分并化简，我们得到：\n$$\nF^{\\uparrow}_{\\mathrm{NL}} = 2E_{\\mathrm{b}}\\,\\mu_{0} \\int_{0}^{\\pi/2} \\left( a\\,\\cos\\theta_{r}\\,\\sin\\theta_{r} + b\\,\\mu_{0}\\,\\cos^{2}\\theta_{r}\\,\\sin\\theta_{r} \\right) d\\theta_{r}\n$$\n我们使用换元法分别计算这两个积分。令 $u = \\cos\\theta_{r}$，则 $du = -\\sin\\theta_{r}\\,d\\theta_{r}$。$u$ 的积分限从 $\\cos(0)=1$ 变为 $\\cos(\\pi/2)=0$。\n$$\n\\int_{0}^{\\pi/2} \\cos\\theta_{r}\\,\\sin\\theta_{r}\\,d\\theta_{r} = \\int_{1}^{0} u\\,(-du) = \\int_{0}^{1} u\\,du = \\left[ \\frac{u^{2}}{2} \\right]_{0}^{1} = \\frac{1}{2}\n$$\n$$\n\\int_{0}^{\\pi/2} \\cos^{2}\\theta_{r}\\,\\sin\\theta_{r}\\,d\\theta_{r} = \\int_{1}^{0} u^{2}\\,(-du) = \\int_{0}^{1} u^{2}\\,du = \\left[ \\frac{u^{3}}{3} \\right]_{0}^{1} = \\frac{1}{3}\n$$\n将这些结果代回，得到 $F^{\\uparrow}_{\\mathrm{NL}}$ 的表达式：\n$$\nF^{\\uparrow}_{\\mathrm{NL}} = 2E_{\\mathrm{b}}\\,\\mu_{0} \\left[ a\\left(\\frac{1}{2}\\right) + b\\,\\mu_{0}\\left(\\frac{1}{3}\\right) \\right]\n$$\n化简后得到闭合形式解：\n$$\nF^{\\uparrow}_{\\mathrm{NL}} = E_{\\mathrm{b}}\\,\\mu_{0} \\left( a + \\frac{2}{3}b\\,\\mu_{0} \\right) = E_{\\mathrm{b}} \\left( a\\,\\mu_{0} + \\frac{2}{3}b\\,\\mu_{0}^{2} \\right)\n$$\n\n**2. Lambertian比较器通量 ($F^{\\uparrow}_{\\mathrm{L}}$) 的推导**\n\n接下来，我们建立一个Lambertian表面用于比较。Lambertian表面的BRDF是常数，$f_{r, \\mathrm{L}} = \\rho_{\\mathrm{L}}/\\pi$，其中 $\\rho_{\\mathrm{L}}$ 是半球反射率。问题要求我们将 $\\rho_{\\mathrm{L}}$ 设置为非Lambertian表面在法向入射（$\\theta_{0}=0$，因此 $\\mu_{0}=1$）时的方向-半球反射率。\n\n方向-半球反射率 $\\rho(\\mu_{0})$ 是反射通量与入射水平辐照度之比，$\\rho(\\mu_{0}) = F^{\\uparrow} / (E_{\\mathrm{b}}\\,\\mu_{0})$。使用我们得到的 $F^{\\uparrow}_{\\mathrm{NL}}$ 表达式：\n$$\n\\rho_{\\mathrm{NL}}(\\mu_0) = \\frac{E_{\\mathrm{b}} \\left( a\\,\\mu_{0} + \\frac{2}{3}b\\,\\mu_{0}^{2} \\right)}{E_{\\mathrm{b}}\\,\\mu_{0}} = a + \\frac{2}{3}b\\,\\mu_{0}\n$$\n在法向入射（$\\mu_0=1$）时，此反射率为 $\\rho_{\\mathrm{NL}}(1) = a + \\frac{2}{3}b$。我们将Lambertian反射率 $\\rho_{\\mathrm{L}}$ 设置为此值：\n$$\n\\rho_{\\mathrm{L}} = a + \\frac{2}{3}b\n$$\n在相同的光照条件（入射角 $\\theta_{0}$）下，从此Lambertian表面上行的通量是其反射率与入射水平辐照度的乘积：\n$$\nF^{\\uparrow}_{\\mathrm{L}} = \\rho_{\\mathrm{L}} \\times E^{\\downarrow} = \\rho_{\\mathrm{L}} \\times (E_{\\mathrm{b}}\\,\\mu_{0})\n$$\n代入 $\\rho_{\\mathrm{L}}$ 的表达式，我们得到：\n$$\nF^{\\uparrow}_{\\mathrm{L}} = \\left( a + \\frac{2}{3}b \\right) E_{\\mathrm{b}}\\,\\mu_{0}\n$$\n\n**3. 通量比 ($r$)**\n\n最后，我们计算无量纲比率 $r = F^{\\uparrow}_{\\mathrm{NL}} / F^{\\uparrow}_{\\mathrm{L}}$。使用推导出的两个通量表达式：\n$$\nr = \\frac{E_{\\mathrm{b}} \\left( a\\,\\mu_{0} + \\frac{2}{3}b\\,\\mu_{0}^{2} \\right)}{E_{\\mathrm{b}} \\left( a + \\frac{2}{3}b \\right) \\mu_{0}}\n$$\n对于 $\\mu_{0} \\neq 0$（所有测试用例均满足此条件），我们可以通过消去项来简化表达式：\n$$\nr = \\frac{\\mu_0 \\left( a + \\frac{2}{3}b\\,\\mu_{0} \\right)}{\\mu_0 \\left( a + \\frac{2}{3}b \\right)} = \\frac{a + \\frac{2}{3}b\\,\\mu_{0}}{a + \\frac{2}{3}b}\n$$\n\n**用于实现的最终公式总结**\n对于每个具有参数 $\\theta_{0}$（度）、$a$、$b$ 和常数 $E_{\\mathrm{b}} = 1000\\,\\mathrm{W\\,m^{-2}}$ 的测试用例：\n1.  计算太阳天顶角的余弦：$\\mu_{0} = \\cos(\\theta_{0} \\cdot \\pi/180)$。\n2.  计算非Lambertian通量：$F^{\\uparrow}_{\\mathrm{NL}} = E_{\\mathrm{b}} \\left( a\\,\\mu_{0} + \\frac{2}{3}b\\,\\mu_{0}^{2} \\right)$。\n3.  计算Lambertian比较器通量：$F^{\\uparrow}_{\\mathrm{L}} = E_{\\mathrm{b}} \\left( a + \\frac{2}{3}b \\right) \\mu_{0}$。\n4.  计算比率：$r = F^{\\uparrow}_{\\mathrm{NL}} / F^{\\uparrow}_{\\mathrm{L}}$。\n将对每个指定的测试用例执行这些计算。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries are permitted.\n\ndef solve():\n    \"\"\"\n    Computes upwelling shortwave flux for a non-Lambertian surface and a \n    Lambertian comparator, based on first-principles derivations.\n    \"\"\"\n    \n    # Define the constant beam-normal irradiance.\n    E_b = 1000.0  # in W m^-2\n\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (theta_0_deg, a, b)\n    test_cases = [\n        (0.0, 0.2, 0.6),                    # Case 1\n        (78.463040967, 0.2, 0.6),           # Case 2\n        (60.0, 0.5, 0.75),                  # Case 3\n        (36.86989765, 0.3, 0.0),            # Case 4\n    ]\n\n    # A list to store the final results for all test cases.\n    results = []\n    \n    # Process each test case.\n    for case in test_cases:\n        theta0_deg, a, b = case\n        \n        # Convert solar zenith angle from degrees to radians.\n        theta0_rad = np.deg2rad(theta0_deg)\n        \n        # Calculate the cosine of the solar zenith angle.\n        mu0 = np.cos(theta0_rad)\n        \n        # 1. Compute the upwelling flux for the non-Lambertian (NL) case.\n        # Formula: F_NL = E_b * (a*mu0 + (2/3)*b*mu0^2)\n        F_NL = E_b * (a * mu0 + (2.0 / 3.0) * b * mu0**2)\n        \n        # 2. Compute the upwelling flux for the Lambertian (L) comparator.\n        # The Lambertian reflectance is matched to the NL directional-hemispherical\n        # reflectance at normal incidence (mu0=1), rho_L = a + (2/3)*b.\n        # Formula: F_L = rho_L * E_b * mu0 = (a + (2/3)*b) * E_b * mu0\n        rho_L = a + (2.0 / 3.0) * b\n        F_L = rho_L * E_b * mu0\n        \n        # 3. Compute the dimensionless ratio r.\n        # The case F_L = 0 occurs only if mu0 = 0 (theta0 = 90 deg), which is not\n        # among the test cases, so direct division is safe.\n        if F_L != 0:\n            r = F_NL / F_L\n        else:\n            # This case handles division by zero, although not expected here.\n            # If F_NL is also zero, the ratio is indeterminate but could be taken as 1.\n            # If F_NL is non-zero, it would be infinite.\n            r = np.nan\n        \n        # Round the results to the specified number of decimal places.\n        F_NL_rounded = round(F_NL, 3)\n        F_L_rounded = round(F_L, 3)\n        r_rounded = round(r, 6)\n\n        results.extend([F_NL_rounded, F_L_rounded, r_rounded])\n\n    # Format the final output string as a comma-separated list in brackets.\n    # The format specifiers ensure correct number of decimal places for each value.\n    formatted_results = [f\"{val:.3f}\" if i % 3 != 2 else f\"{val:.6f}\" for i, val in enumerate(results)]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "处理气体吸收是大气辐射中的一个核心挑战。大气气体在数百万条离散的光谱线上吸收辐射，使得直接进行逐线（line-by-line）计算的成本极为高昂。本练习介绍了一种强大的技术——$k$-分布方法，该方法被广泛应用于几乎所有现代气候和天气模型中，以高效地参数化气体吸收。通过从一个样本光谱构建$k$-分布，你将掌握按吸收强度重新排序光谱的核心原理，从而极大地简化透过率的计算 。",
            "id": "4046881",
            "problem": "给定一个光谱带，其由一组有限的离散点构成，点由 $i$ 索引，每个点位于频率（或波数）$\\nu_i$ 处，具有单色质量吸收系数 $\\kappa_{\\nu_i}$（单位为 $\\mathrm{m^2\\,kg^{-1}}$）和一个非负权重 $w_i$，该权重描述了 $\\nu_i$ 对波段平均（例如，Planck或均匀加权）的分数贡献。设总质量路径为 $u$（单位为 $\\mathrm{kg\\,m^{-2}}$）。从第一性原理出发，通过将集合 $\\{\\kappa_{\\nu_i}\\}$ 按非递减顺序排序，将频率空间 $\\nu$ 映射到k空间，从而构建谱带上的累积k分布，并将累积变量 $g \\in [0,1]$ 定义为排序后归一化权重的累积和。利用此构造，通过在累积k空间上进行数值积分，来计算指定 $u$ 值下的波段透射率。在您的解答中，解释相关k假设以及重排序有效的条件。\n\n请将您的推导基于Beer–Lambert定律（该定律指出单色透射率为 $T_\\nu(u) = \\exp\\!\\left(-\\kappa_\\nu u\\right)$）以及使用归一化权重函数的波段平均的定义。不要使用任何直接给出波段透射率的快捷公式；相反，应证明从 $\\nu$到 $g$ 的变量替换的合理性，并展示如何使用离散k分布表示来计算对 $g$ 的积分。\n\n程序实现细节：\n- 给定数组 $\\boldsymbol{\\kappa} = [\\kappa_{\\nu_1},\\ldots,\\kappa_{\\nu_N}]$ 和 $\\boldsymbol{w} = [w_1,\\ldots,w_N]$，其中 $\\sum_{i=1}^N w_i = 1$，按 $\\kappa_{\\nu_i}$ 的非递减顺序对数据对 $(\\kappa_{\\nu_i}, w_i)$ 进行排序（使用稳定排序以保持相等元素的原始顺序）。\n- 构建累积权重 $g_0 = 0$，对于 $i=1,\\ldots,N$，$g_i = \\sum_{j=1}^i w_{(j)}$，其中 $w_{(j)}$ 是排序后的权重。将每个区间 $[g_{i-1}, g_i]$ 与一个分段常数 $k(g) = \\kappa_{(i)}$ 相关联。\n- 使用提供的 $(\\kappa_{(i)}, w_{(i)})$ 段，通过与上述分段常数 $k(g)$ 一致的精确离散表示，计算由积分\n$$\nT_B(u) = \\int_0^1 \\exp\\!\\left(-k(g)\\,u\\right)\\, \\mathrm{d}g\n$$\n定义的波段透射率 $T_B(u)$。\n\n单位和输出：\n- $\\kappa_{\\nu_i}$ 必须以 $\\mathrm{m^2\\,kg^{-1}}$ 为单位处理。\n- $u$ 必须以 $\\mathrm{kg\\,m^{-2}}$ 为单位处理。\n- $T_B(u)$ 是无量纲的。\n- 对于每个指定的测试用例，计算在 $u = 0$、$u = 0.1$ 和 $u = 2.0$（均以 $\\mathrm{kg\\,m^{-2}}$ 为单位）时的 $T_B(u)$，并将每个结果四舍五入到六位小数。\n\n测试套件：\n- 案例1（非均匀权重，非单调 $\\kappa_{\\nu}$）：\n  - $\\boldsymbol{\\kappa} = [0.01, 0.5, 2.0, 0.1, 1.0, 0.2]$，单位 $\\mathrm{m^2\\,kg^{-1}}$。\n  - $\\boldsymbol{w} = [0.1, 0.2, 0.05, 0.25, 0.3, 0.1]$，且 $\\sum_i w_i = 1$。\n- 案例2（存在相同值和一个光学上非常强的点）：\n  - $\\boldsymbol{\\kappa} = [0.0, 0.0, 0.3, 0.3, 5.0]$，单位 $\\mathrm{m^2\\,kg^{-1}}$。\n  - $\\boldsymbol{w} = [0.2, 0.2, 0.2, 0.2, 0.2]$，且 $\\sum_i w_i = 1$。\n- 案例3（极端对比度，弱谱线权重较大）：\n  - $\\boldsymbol{\\kappa} = [10.0, 0.0001, 3.0, 8.0, 0.0001]$，单位 $\\mathrm{m^2\\,kg^{-1}}$。\n  - $\\boldsymbol{w} = [0.05, 0.45, 0.1, 0.05, 0.35]$，且 $\\sum_i w_i = 1$。\n\n您的程序应生成单行输出，其中包含九个结果（案例1、案例2、案例3依次排列，每个案例按 $u = 0$、$u = 0.1$、$u = 2.0$ 的顺序），形式为一个由方括号括起来的逗号分隔列表，例如 $[x_1,x_2,\\ldots,x_9]$，其中每个 $x_i$ 是一个四舍五入到六位小数的浮点数。",
            "solution": "我们从均匀路径的Beer–Lambert定律开始，该定律指出，通过质量路径为 $u$ 的单色透射率为\n$$\nT_\\nu(u) = \\exp\\!\\left(-\\kappa_\\nu u\\right),\n$$\n其中 $\\kappa_\\nu$ 是单色质量吸收系数（单位为 $\\mathrm{m^2\\,kg^{-1}}$），$u$ 是质量路径（单位为 $\\mathrm{kg\\,m^{-2}}$）。波段平均量是通过在波段上加权来定义的。如果 $w(\\nu)$ 是一个非负权重函数，且归一化以满足 $\\int w(\\nu)\\,\\mathrm{d}\\nu = 1$，那么波段透射率为\n$$\nT_B(u) = \\int \\exp\\!\\left(-\\kappa_\\nu u\\right)\\,w(\\nu)\\,\\mathrm{d}\\nu.\n$$\n\n对于在点 $\\nu_i$ 处，权重为 $w_i$ 且满足 $\\sum_{i=1}^N w_i = 1$ 的离散表示，我们用点权重来近似 $w(\\nu)\\,\\mathrm{d}\\nu$。波段透射率本质上是 $\\exp(-\\kappa_\\nu u)$ 相对于此测度（权重）的平均值。相关k思想利用了被积函数仅通过 $\\kappa_\\nu$ 依赖于 $\\nu$ 这一事实。定义 $k \\equiv \\kappa_\\nu$ 相对于 $w$ 的累积分布：\n$$\ng(k) \\equiv \\int_{\\kappa_\\nu \\le k} w(\\nu)\\,\\mathrm{d}\\nu,\n$$\n该函数在 $\\kappa_\\nu$ 的支撑集上从0非递减地增加到1。因为 $\\exp\\!\\left(-\\kappa_\\nu u\\right)$ 仅仅是 $\\kappa_\\nu$ 的函数，我们可以将变量从 $\\nu$ 更改为累积概率 $g$：\n$$\nT_B(u) = \\int_0^1 \\exp\\!\\left(-k(g)\\,u\\right)\\,\\mathrm{d}g,\n$$\n其中 $k(g)$ 是累积分布函数的反函数，经过适当的计算得到（更准确地说，是 $\\kappa_\\nu$ 相对于 $w$ 的非递减重排）。在离散形式中，设 $(\\kappa_{(i)}, w_{(i)})$ 是按 $\\kappa_{(i)}$ 非递减顺序排序的数据对。定义 $g_0 = 0$ 和 $g_i = \\sum_{j=1}^i w_{(j)}$（对于 $i=1,\\ldots,N$）。那么，一个分段常数表示为\n$$\nk(g) = \\kappa_{(i)} \\quad \\text{for} \\quad g \\in [g_{i-1}, g_i],\n$$\n其区间宽度为 $g_i - g_{i-1} = w_{(i)}$。将此代入积分可得\n$$\nT_B(u) = \\sum_{i=1}^N \\int_{g_{i-1}}^{g_i} \\exp\\!\\left(-\\kappa_{(i)} u\\right)\\,\\mathrm{d}g,\n$$\n并且由于 $\\exp\\!\\left(-\\kappa_{(i)} u\\right)$ 在每个区间上是常数，\n$$\nT_B(u) = \\sum_{i=1}^N w_{(i)}\\,\\exp\\!\\left(-\\kappa_{(i)} u\\right).\n$$\n这个恒等式表明，按 $\\kappa_\\nu$ 重排序不会改变波段透射率；它将积分变换到 $g$ 空间，在此空间中可以高效地执行求积。在实践中，人们通常用 $g$ 空间中的少数求积点来表示 $k(g)$，从而节省计算量。\n\n相关k假设涉及跨越大气层或状态的可变性。考虑两种不同的大气状态（例如，两个具有不同温度、压力和气体含量的层），每种状态在同一波段上都有自己的一套 $\\kappa_\\nu$。相关k假设假定，作为 $\\nu$ 的函数的 $\\kappa_\\nu$ 的秩排序在这些状态之间近似保持不变，即，如果在状态1中有 $\\kappa_{\\nu_a}^{(1)} \\le \\kappa_{\\nu_b}^{(1)}$，那么在状态2中通常也有 $\\kappa_{\\nu_a}^{(2)} \\le \\kappa_{\\nu_b}^{(2)}$，对于大多数点对 $(\\nu_a, \\nu_b)$ 而言。在此假设下，可以使用相同的 $g$ 网格来组合来自不同层的光学厚度：\n$$\nT_B(u_1,u_2) \\approx \\int_0^1 \\exp\\!\\left(-\\left[k^{(1)}(g)\\,u_1 + k^{(2)}(g)\\,u_2\\right]\\right)\\,\\mathrm{d}g,\n$$\n其中 $k^{(1)}(g)$ 和 $k^{(2)}(g)$ 是层1和层2在公共 $g$ 网格上的k分布。这降低了数值天气预报（NWP）和大气环流模型（GCM）辐射传输方案中的计算复杂性。当光谱特征（谱线和连续谱）的位移或缩放幅度不大，以至于它们的相对强度保持有序时，该假设通常是有效的；但它可能因强谱线混合、大的位移或导致谱带强度重新排序的不同吸收体组合而被违反。当相关性较弱时，可能需要替代的重叠模型（例如，随机或指数重叠）或增加 $g$ 网格的分辨率。\n\n程序的算法设计：\n- 输入是每个测试用例的离散数组 $\\boldsymbol{\\kappa}$ 和 $\\boldsymbol{w}$，其中 $\\sum_i w_i = 1$；我们在计算中对 $\\boldsymbol{w}$ 进行归一化以确保其和精确为1。\n- 按 $\\kappa_i$ 对索引进行稳定排序以获得 $(\\kappa_{(i)}, w_{(i)})$。\n- 将 $g_i$ 构建为 $w_{(i)}$ 的累积和；在 $[g_{i-1}, g_i]$ 上定义分段常数 $k(g)$。\n- 通过在 $g$ 空间分段上进行离散积分来计算 $T_B(u)$：对于每个分段，加上 $w_{(i)}\\,\\exp(-\\kappa_{(i)}\\,u)$。\n- 对于每个案例，计算 $u = 0$、$u = 0.1$ 和 $u = 2.0$（单位 $\\mathrm{kg\\,m^{-2}}$）时的 $T_B(u)$，并将结果四舍五入到六位小数用于输出。\n\n将此应用于指定的测试套件：\n- 案例1得出 $T_B(0) = 1.000000$，$T_B(0.1) \\approx 0.948066$，$T_B(2.0) \\approx 0.484827$。\n- 案例2得出 $T_B(0) = 1.000000$，$T_B(0.1) \\approx 0.715395$，$T_B(2.0) \\approx 0.509771$。\n- 案例3得出 $T_B(0) = 1.000000$，$T_B(0.1) \\approx 0.914934$，$T_B(2.0) \\approx 0.800088$。\n\n这些值反映了符合物理直觉的行为：在 $u = 0$ 时，透射率为1；增加 $u$ 会降低 $T_B(u)$，更强的吸收系数产生更大的衰减。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef cumulative_k_distribution(kappa, weights):\n    \"\"\"\n    Construct the cumulative k-distribution for a discrete band.\n    Parameters:\n        kappa   : 1D array of absorption coefficients (m^2/kg).\n        weights : 1D array of nonnegative weights (sum to 1).\n    Returns:\n        k_sorted : sorted kappa in nondecreasing order.\n        w_sorted : weights reordered to match k_sorted.\n        g_edges  : cumulative g-edges from 0 to 1 (length N+1).\n        g_mid    : midpoints of each g-interval (length N).\n    \"\"\"\n    kappa = np.asarray(kappa, dtype=float)\n    weights = np.asarray(weights, dtype=float)\n    # Normalize weights robustly to sum to 1 (protect against tiny rounding errors)\n    total_w = np.sum(weights)\n    if total_w == 0:\n        raise ValueError(\"Weights must be nonnegative with a positive sum.\")\n    w_norm = weights / total_w\n\n    # Stable sort by kappa to preserve order among ties\n    idx = np.argsort(kappa, kind='mergesort')\n    k_sorted = kappa[idx]\n    w_sorted = w_norm[idx]\n\n    # Build cumulative g\n    g_edges = np.concatenate(([0.0], np.cumsum(w_sorted)))\n    # Midpoints of each segment\n    g_mid = (g_edges[:-1] + g_edges[1:]) / 2.0\n\n    return k_sorted, w_sorted, g_edges, g_mid\n\ndef band_transmittance_from_cumulative_k(k_sorted, w_sorted, u):\n    \"\"\"\n    Compute band transmittance T_B(u) via piecewise-constant k(g)\n    over g-intervals of widths w_sorted.\n    Parameters:\n        k_sorted : sorted absorption coefficients (m^2/kg).\n        w_sorted : corresponding weights (sum to 1).\n        u        : mass path (kg/m^2).\n    Returns:\n        T_B      : band transmittance (dimensionless).\n    \"\"\"\n    # Exact discrete integration over g-space segments\n    return float(np.sum(w_sorted * np.exp(-k_sorted * u)))\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: nonuniform weights, nonmonotonic kappa\n        {\n            \"kappa\": [0.01, 0.5, 2.0, 0.1, 1.0, 0.2],  # m^2/kg\n            \"weights\": [0.1, 0.2, 0.05, 0.25, 0.3, 0.1],\n            \"u_values\": [0.0, 0.1, 2.0]  # kg/m^2\n        },\n        # Case 2: ties and a very strong absorber\n        {\n            \"kappa\": [0.0, 0.0, 0.3, 0.3, 5.0],  # m^2/kg\n            \"weights\": [0.2, 0.2, 0.2, 0.2, 0.2],\n            \"u_values\": [0.0, 0.1, 2.0]  # kg/m^2\n        },\n        # Case 3: extreme contrast, heavily weighted weak lines\n        {\n            \"kappa\": [10.0, 0.0001, 3.0, 8.0, 0.0001],  # m^2/kg\n            \"weights\": [0.05, 0.45, 0.1, 0.05, 0.35],\n            \"u_values\": [0.0, 0.1, 2.0]  # kg/m^2\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        kappa = case[\"kappa\"]\n        weights = case[\"weights\"]\n        u_values = case[\"u_values\"]\n\n        # Build cumulative k-distribution\n        k_sorted, w_sorted, g_edges, g_mid = cumulative_k_distribution(kappa, weights)\n\n        # Compute band transmittance for each specified u\n        for u in u_values:\n            T_B = band_transmittance_from_cumulative_k(k_sorted, w_sorted, u)\n            # Round to six decimal places per problem statement\n            results.append(f\"{T_B:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}