{
    "hands_on_practices": [
        {
            "introduction": "This first exercise revisits a cornerstone of atmospheric dynamics: the behavior of a dry air parcel undergoing adiabatic motion. By deriving the dry adiabatic lapse rate from first principles, you will solidify your understanding of how potential temperature ($\\theta$) and dry static energy ($h_d$) are conserved. This practice provides the essential foundation for diagnosing static stability and serves as the baseline for our subsequent exploration of more complex moist processes .",
            "id": "4040122",
            "problem": "Consider a hydrostatic, unsaturated (dry) atmosphere composed of an ideal gas representing dry air, as used in Numerical Weather Prediction (NWP) and climate models. Let $p$ denote pressure, $T$ temperature, $\\rho$ density, $z$ geometric height, $g$ gravitational acceleration, $R_d$ the specific gas constant for dry air, and $c_{p,d}$ the specific heat capacity at constant pressure for dry air. Assume a reversible adiabatic displacement of an air parcel (no diabatic heating and negligible viscous dissipation), and neglect kinetic energy changes relative to enthalpy and gravitational potential energy.\n\nStarting from the hydrostatic balance, the ideal gas law, and the first law of thermodynamics expressed in terms of entropy for an ideal gas, perform the following:\n\n1. Derive the vertical temperature gradient (lapse rate) of a dry air parcel undergoing a reversible adiabatic displacement, and express it in terms of $g$ and $c_{p,d}$.\n2. Using the definition of entropy for an ideal gas, derive the material conservation of potential temperature $\\theta$ for a dry adiabatic parcel and show how static stability relates to the sign of $\\partial \\theta / \\partial z$ by connecting the sign of $\\partial \\theta / \\partial z$ to the comparison between the environmental lapse rate and the dry adiabatic lapse rate.\n3. Interpret the dry adiabatic lapse rate in the framework of dry static energy $h_d = c_{p,d} T + g z$ and discuss its link to the moist static energy concept used in moist processes.\n4. Finally, estimate the numerical value of the dry adiabatic lapse rate using $c_{p,d} = 1004$ $\\mathrm{J \\, kg^{-1} \\, K^{-1}}$ and $g = 9.81$ $\\mathrm{m \\, s^{-2}}$. Express the final lapse rate in $\\mathrm{K \\, km^{-1}}$ and round your answer to four significant figures.",
            "solution": "This problem requires the derivation and interpretation of fundamental atmospheric thermodynamic quantities. We begin from the specified first principles: the hydrostatic balance, the ideal gas law, and the first law of thermodynamics.\n\nThe hydrostatic balance equation relates the change in pressure $p$ with geometric height $z$:\n$$ \\frac{dp}{dz} = -\\rho g $$\nwhere $\\rho$ is the density and $g$ is the gravitational acceleration.\n\nThe ideal gas law for dry air is:\n$$ p = \\rho R_d T $$\nwhere $R_d$ is the specific gas constant for dry air and $T$ is the absolute temperature.\n\nThe first law of thermodynamics for a reversible process, expressed per unit mass in terms of specific enthalpy $h$, is:\n$$ T ds = dh - \\frac{1}{\\rho} dp $$\nwhere $s$ is the specific entropy. For an ideal gas, the change in specific enthalpy is $dh = c_{p,d} dT$, where $c_{p,d}$ is the specific heat capacity at constant pressure for dry air. Thus, the first law becomes:\n$$ T ds = c_{p,d} dT - \\frac{1}{\\rho} dp $$\n\nThe problem specifies a reversible adiabatic process for an air parcel. Adiabatic means there is no heat exchange with the surroundings, so $ds = 0$.\n\n1.  **Derivation of the Dry Adiabatic Lapse Rate ($\\Gamma_d$)**\n\nFor a reversible adiabatic process, $ds=0$, so the first law of thermodynamics simplifies to:\n$$ 0 = c_{p,d} dT - \\frac{1}{\\rho} dp $$\n$$ c_{p,d} dT = \\frac{1}{\\rho} dp $$\nThis equation describes the temperature change $dT$ of an air parcel undergoing a change in pressure $dp$. To find the temperature change with height, we use the hydrostatic equation, which relates the pressure change to a change in height for a parcel in hydrostatic equilibrium with its surroundings: $dp = -\\rho g dz$. Substituting this into the thermodynamic equation yields:\n$$ c_{p,d} dT = \\frac{1}{\\rho} (-\\rho g dz) $$\n$$ c_{p,d} dT = -g dz $$\nRearranging this equation gives the rate of change of temperature with height for the adiabatically displaced parcel:\n$$ \\frac{dT}{dz} = -\\frac{g}{c_{p,d}} $$\nThe lapse rate is defined as the rate of temperature *decrease* with height, so it is the negative of this gradient. The dry adiabatic lapse rate, denoted by $\\Gamma_d$, is therefore:\n$$ \\Gamma_d = -\\frac{dT}{dz} = \\frac{g}{c_{p,d}} $$\n\n2.  **Potential Temperature ($\\theta$) and Static Stability**\n\nPotential temperature $\\theta$ is defined as the temperature an air parcel would have if brought adiabatically from its current pressure $p$ and temperature $T$ to a standard reference pressure $p_0$ (usually $1000$ hPa).\n\nTo derive its expression, we return to the simplified first law for an adiabatic process, $c_{p,d} dT = \\frac{1}{\\rho} dp$. Using the ideal gas law to substitute for density, $\\rho = p / (R_d T)$, we get:\n$$ c_{p,d} dT = \\frac{R_d T}{p} dp $$\nSeparating variables gives:\n$$ \\frac{c_{p,d}}{T} dT = \\frac{R_d}{p} dp \\quad \\implies \\quad c_{p,d} d(\\ln T) = R_d d(\\ln p) $$\nFor an adiabatic process, this relationship holds. Integrating from the parcel's state ($p, T$) to the reference state ($p_0, \\theta$) gives:\n$$ \\int_{T}^{\\theta} c_{p,d} d(\\ln T') = \\int_{p}^{p_0} R_d d(\\ln p') $$\n$$ c_{p,d} (\\ln \\theta - \\ln T) = R_d (\\ln p_0 - \\ln p) $$\n$$ \\ln\\left(\\frac{\\theta}{T}\\right) = \\frac{R_d}{c_{p,d}} \\ln\\left(\\frac{p_0}{p}\\right) = \\ln\\left[ \\left(\\frac{p_0}{p}\\right)^{R_d/c_{p,d}} \\right] $$\nTaking the exponential of both sides yields the definition of potential temperature:\n$$ \\theta = T \\left(\\frac{p_0}{p}\\right)^{R_d/c_{p,d}} $$\nFrom the derivation, the quantity $c_{p,d} \\ln T - R_d \\ln p$ is constant during an adiabatic process. This is equivalent to saying that $\\theta$ is a conserved quantity for a dry adiabatic parcel, i.e., $\\frac{D\\theta}{Dt} = 0$, where $\\frac{D}{Dt}$ is the material derivative.\n\nNow, we relate the vertical gradient of potential temperature in the *environment*, $\\frac{\\partial \\theta}{\\partial z}$, to static stability. Stability is determined by comparing the environmental lapse rate, $\\Gamma = -\\frac{\\partial T_e}{\\partial z}$, with the dry adiabatic lapse rate, $\\Gamma_d$.\nLet's find the expression for $\\frac{\\partial \\theta}{\\partial z}$ by differentiating the definition of $\\theta$ with respect to $z$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial}{\\partial z} \\left[ T \\left(\\frac{p_0}{p}\\right)^{\\kappa} \\right] \\quad \\text{where } \\kappa = \\frac{R_d}{c_{p,d}} $$\nUsing the product and chain rules:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\partial T}{\\partial z} \\left(\\frac{p_0}{p}\\right)^{\\kappa} + T \\cdot \\kappa \\left(\\frac{p_0}{p}\\right)^{\\kappa-1} \\left(-\\frac{p_0}{p^2}\\right) \\frac{\\partial p}{\\partial z} $$\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\frac{\\partial T}{\\partial z} - \\frac{\\theta}{p} \\kappa \\frac{\\partial p}{\\partial z} $$\nSubstituting the environmental lapse rate definition ($\\frac{\\partial T}{\\partial z} = -\\Gamma$) and the hydrostatic equation ($\\frac{\\partial p}{\\partial z} = -\\rho g$):\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} (-\\Gamma) - \\frac{\\theta}{p} \\kappa (-\\rho g) = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{T \\kappa \\rho g}{p} \\right) $$\nUsing the ideal gas law $p = \\rho R_d T$, we have $\\frac{T \\rho}{p} = \\frac{1}{R_d}$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{\\kappa g}{R_d} \\right) $$\nSubstituting back $\\kappa = \\frac{R_d}{c_{p,d}}$:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{R_d}{c_{p,d}} \\frac{g}{R_d} \\right) = \\frac{\\theta}{T} \\left( -\\Gamma + \\frac{g}{c_{p,d}} \\right) $$\nRecognizing that $\\Gamma_d = \\frac{g}{c_{p,d}}$, we arrive at the final relationship:\n$$ \\frac{\\partial \\theta}{\\partial z} = \\frac{\\theta}{T} (\\Gamma_d - \\Gamma) $$\nSince $\\theta$ and $T$ are positive absolute temperatures, the sign of $\\frac{\\partial \\theta}{\\partial z}$ is determined by the sign of $(\\Gamma_d - \\Gamma)$.\n-   **Statically Stable:** An upwardly displaced parcel becomes colder and denser than its new surroundings and returns to its original level. This occurs when the environmental lapse rate is less than the adiabatic rate, $\\Gamma  \\Gamma_d$. In this case, $(\\Gamma_d - \\Gamma)  0$, so $\\frac{\\partial \\theta}{\\partial z}  0$. Potential temperature increases with height.\n-   **Statically Unstable:** An upwardly displaced parcel remains warmer and less dense than its new surroundings and continues to accelerate upward. This occurs when $\\Gamma  \\Gamma_d$. In this case, $(\\Gamma_d - \\Gamma)  0$, so $\\frac{\\partial \\theta}{\\partial z}  0$. Potential temperature decreases with height.\n-   **Statically Neutral:** A displaced parcel has the same temperature as its new surroundings and remains at its new level. This occurs when $\\Gamma = \\Gamma_d$, which implies $\\frac{\\partial \\theta}{\\partial z} = 0$. Potential temperature is constant with height.\n\n3.  **Dry Static Energy ($h_d$) and Moist Static Energy (MSE)**\n\nDry static energy per unit mass, $h_d$, is the sum of specific enthalpy ($c_{p,d} T$) and specific gravitational potential energy ($g z$):\n$$ h_d = c_{p,d} T + g z $$\nFor a parcel of air moving vertically, the rate of change of its dry static energy with height is:\n$$ \\frac{dh_d}{dz} = \\frac{d}{dz}(c_{p,d} T + g z) = c_{p,d} \\frac{dT}{dz} + g $$\nIf the parcel moves adiabatically, its temperature gradient is given by $\\frac{dT}{dz} = -\\Gamma_d = -\\frac{g}{c_{p,d}}$. Substituting this into the equation for the change in $h_d$:\n$$ \\frac{dh_d}{dz} = c_{p,d} \\left(-\\frac{g}{c_{p,d}}\\right) + g = -g + g = 0 $$\nThis shows that $h_d$ is conserved for a parcel undergoing dry adiabatic displacement. This provides a direct physical interpretation: as the parcel rises, its gravitational potential energy ($gz$) increases, and this increase is exactly balanced by a decrease in its enthalpy ($c_{p,d} T$), resulting in no net change in its total static energy.\n\nThis concept is extended to moist processes through moist static energy (MSE), $h_m$. MSE includes the latent heat of vaporization, $L_v$, associated with water vapor in the air, characterized by the specific humidity $q_v$:\n$$ h_m = c_{p,d} T + g z + L_v q_v \\approx h_d + L_v q_v $$\nFor a saturated parcel rising and condensing water vapor, the release of latent heat ($L_v$) warms the parcel, making its lapse rate (the saturated adiabatic lapse rate $\\Gamma_s$) smaller than $\\Gamma_d$. In a saturated adiabatic process, it is the moist static energy, $h_m$, that is approximately conserved. The term $h_d$ is no longer conserved because of the diabatic heating from condensation. The conservation of $h_m$ in moist convection is a cornerstone principle in tropical meteorology and climate studies, analogous to the conservation of $h_d$ in dry dynamics.\n\n4.  **Numerical Estimation of the Dry Adiabatic Lapse Rate**\n\nWe use the derived formula $\\Gamma_d = \\frac{g}{c_{p,d}}$ with the given values:\n-   $g = 9.81 \\, \\mathrm{m \\, s^{-2}}$\n-   $c_{p,d} = 1004 \\, \\mathrm{J \\, kg^{-1} \\, K^{-1}}$\n\nThe units of the calculation are $\\frac{\\mathrm{m \\, s^{-2}}}{\\mathrm{J \\, kg^{-1} \\, K^{-1}}}$. Since $1 \\, \\mathrm{J} = 1 \\, \\mathrm{kg \\, m^2 \\, s^{-2}}$, the denominator's units are $\\mathrm{kg \\, m^2 \\, s^{-2} \\, kg^{-1} \\, K^{-1}} = \\mathrm{m^2 \\, s^{-2} \\, K^{-1}}$. The resulting unit is $\\frac{\\mathrm{m \\, s^{-2}}}{\\mathrm{m^2 \\, s^{-2} \\, K^{-1}}} = \\mathrm{K \\, m^{-1}}$.\n\n$$ \\Gamma_d = \\frac{9.81}{1004} \\, \\mathrm{K \\, m^{-1}} \\approx 0.0097709 \\, \\mathrm{K \\, m^{-1}} $$\nThe problem asks for the result in units of $\\mathrm{K \\, km^{-1}}$. To convert, we multiply by $1000 \\, \\mathrm{m \\, km^{-1}}$:\n$$ \\Gamma_d \\approx 0.0097709 \\, \\frac{\\mathrm{K}}{\\mathrm{m}} \\times 1000 \\, \\frac{\\mathrm{m}}{\\mathrm{km}} = 9.7709 \\, \\mathrm{K \\, km^{-1}} $$\nRounding to four significant figures, we get:\n$$ \\Gamma_d \\approx 9.771 \\, \\mathrm{K \\, km^{-1}} $$\nThe numerical value required is therefore $9.771$.",
            "answer": "$$\\boxed{9.771}$$"
        },
        {
            "introduction": "Building on the concept of dry static energy, we now extend our analysis to the moist atmosphere, where water vapor's latent heat is a crucial component of the energy budget. This practice challenges you to formulate moist static energy ($m$) as a prognostic variable, deriving its tendency equation and constructing a conservative numerical scheme for its transport . This exercise directly connects thermodynamic theory to the design of the dynamical core in weather and climate models.",
            "id": "4040089",
            "problem": "Consider a geophysical fluid modeled for Numerical Weather Prediction (NWP) and climate applications, where the thermodynamic state of a moist atmosphere is characterized by the moist static energy per unit mass. Define the moist static energy $m$ as $m = c_p T + g z + L_v q_v$, where $c_p$ is the specific heat at constant pressure for dry air, $T$ is temperature, $g$ is gravitational acceleration, $z$ is geometric height, $L_v$ is the latent heat of vaporization, and $q_v$ is the specific humidity of water vapor. Assume a compressible atmosphere but neglect kinetic energy and pressure-work terms in the internal energy budget, and treat turbulence as a Fickian diffusion process. Start from the conservation of energy and mass for moist air and water vapor, and fundamental thermodynamics, and derive a prognostic tendency equation for $m$ that includes advection, diffusion, radiative heating, and irreversible phase-change sinks associated with precipitation fallout. Your derivation must begin from the following fundamental bases without assuming any shortcut relationships:\n- The first law of thermodynamics for a moist atmosphere in terms of specific enthalpy, written materially as $D h / D t$ equals diabatic heating terms plus exchanges due to phase changes, with $h = c_p T + L_v q_v$ while ignoring kinetic and pressure-work contributions for this problem’s scope.\n- The water vapor mass conservation $D q_v / D t$ equals sources minus sinks due to microphysics and transport.\n- The gravitational potential energy per unit mass $g z$ is transported by the flow, and its budget should be handled consistently with advection and boundary terms.\n- The divergence form of conservation laws in an Eulerian framework, where conservative transport is represented by flux divergence.\n\nAssume that reversible phase changes internal to the air parcel (e.g., condensation balanced by evaporation within the model control volume) convert water vapor to liquid and back without external energy exchange, and that their latent heating contribution cancels out when forming the budget for $m$. By contrast, precipitation fallout that irreversibly removes condensed water from the control volume represents an external sink of moist static energy associated with removal of latent energy $L_v$ tied to the water mass leaving.\n\nYou must then construct a one-dimensional, periodic, finite-volume discretization in the $x$-direction that is conservative by design. The discrete tendency at cell $i$ for $m$ must be assembled purely as flux divergences for advection and diffusion, plus volumetric source terms for radiation and precipitation sinks. Use an upwind scheme for advection and a centered difference for diffusion. The discrete formulation should ensure that, under periodic boundary conditions, the domain-mean tendency due to transport (advection and diffusion) is identically zero to within floating-point roundoff, so that the domain-mean tendency equals the domain-mean of the volumetric sources and sinks. Discuss the implications for conservation.\n\nImplement the discretization numerically on a uniform grid with periodic boundary conditions and evaluate the spatially averaged tendency for three test cases. For each test case, compute the result as the difference between the spatial average of the discrete tendency and the spatial average of the external source-sink terms (radiation plus precipitation sink), expressed in watts per kilogram. This residual quantifies conservation: a value near zero indicates that transport terms are conservative in the mean.\n\nUse the following constants and parameters, written in the specified units:\n- $c_p = 1004\\,\\mathrm{J\\,kg^{-1}\\,K^{-1}}$, $L_v = 2.5\\times 10^6\\,\\mathrm{J\\,kg^{-1}}$, $g = 9.81\\,\\mathrm{m\\,s^{-2}}$.\n- Domain length $L = 1000\\,\\mathrm{m}$, number of cells $N_x = 128$, grid spacing $\\Delta x = L / N_x$.\n- Base state $T_0 = 300\\,\\mathrm{K}$, $q_0 = 0.01$ (dimensionless mass fraction), and a sinusoidal perturbation of amplitude $A = 1000\\,\\mathrm{J\\,kg^{-1}}$ added to $m$: $m(x) = c_p T_0 + L_v q_0 + A \\sin\\left(2\\pi x/L\\right)$. Treat $g z$ as horizontally uniform and constant, such that its gradient is zero in the $x$-direction and its contribution to transport vanishes in this one-dimensional setting (no vertical motion).\n\nFor each test case below, assemble the discrete tendency as the sum of the negative divergence of the advective flux and the divergence of the diffusive flux, plus the source terms. Use constant velocity $u$ and diffusivity $K$ as specified.\n\nTest Suite (all results must be expressed as floats in $\\mathrm{W\\,kg^{-1}}$):\n1. Happy path transport-only case: $u = 10\\,\\mathrm{m\\,s^{-1}}$, $K = 50\\,\\mathrm{m^2\\,s^{-1}}$, $Q_{\\mathrm{rad}} = 0\\,\\mathrm{W\\,kg^{-1}}$, precipitation sink $P(x) = 0\\,\\mathrm{s^{-1}}$. Compute the residual defined as $\\langle \\partial m / \\partial t \\rangle - \\langle Q_{\\mathrm{rad}} - L_v P \\rangle$, where the angle brackets denote the spatial average over $x$.\n2. Radiation-only case: $u = 0\\,\\mathrm{m\\,s^{-1}}$, $K = 0\\,\\mathrm{m^2\\,s^{-1}}$, $Q_{\\mathrm{rad}} = 2\\times 10^{-3}\\,\\mathrm{W\\,kg^{-1}}$, $P(x) = 0\\,\\mathrm{s^{-1}}$. Compute the same residual.\n3. Phase-change sink edge case: $u = 0\\,\\mathrm{m\\,s^{-1}}$, $K = 0\\,\\mathrm{m^2\\,s^{-1}}$, $Q_{\\mathrm{rad}} = 0\\,\\mathrm{W\\,kg^{-1}}$, and a localized precipitation sink $P(x)$ equal to $P_0 = 1\\times 10^{-7}\\,\\mathrm{s^{-1}}$ in the single central cell and zero elsewhere. Compute the same residual.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"), where each result is the float residual in $\\mathrm{W\\,kg^{-1}}$ for the corresponding test case, in the order listed above. Angles are not used. No percentages are involved. All physical units in inputs and outputs must be respected as specified.",
            "solution": "The solution proceeds in three stages: first, the derivation of the prognostic equation for moist static energy ($m$); second, the development of a conservative finite-volume discretization; and third, an explanation of the numerical implementation and the conservation principle being tested.\n\n**1. Derivation of the Prognostic Equation for Moist Static Energy**\n\nThe moist static energy per unit mass, $m$, is defined as:\n$$\nm = c_p T + g z + L_v q_v\n$$\nwhere $c_p$ is the specific heat of dry air at constant pressure, $T$ is temperature, $g$ is gravitational acceleration, $z$ is geometric height, $L_v$ is the latent heat of vaporization, and $q_v$ is the specific humidity. The term $c_p T + gz$ is the dry static energy, and $L_v q_v$ is the latent energy.\n\nThe problem asks for a prognostic tendency equation for $m$. We begin by considering the material derivative, $\\frac{D}{Dt} = \\frac{\\partial}{\\partial t} + \\mathbf{u} \\cdot \\nabla$, which describes the rate of change following an air parcel.\n$$\n\\frac{Dm}{Dt} = \\frac{D}{Dt}(c_p T) + \\frac{D}{Dt}(gz) + \\frac{D}{Dt}(L_v q_v)\n$$\nAssuming $c_p$ and $L_v$ are constants, this becomes:\n$$\n\\frac{Dm}{Dt} = c_p \\frac{DT}{Dt} + g \\frac{Dz}{Dt} + L_v \\frac{Dq_v}{Dt}\n$$\nWe analyze each term based on the fundamental principles provided:\n\n- **The first law of thermodynamics**: For a moist air parcel, ignoring pressure-work and kinetic energy as instructed, the first law governs the change in temperature. The heating sources are diabatic heating (e.g., radiation, denoted $Q_{\\mathrm{rad}}$) and latent heat release from phase changes internal to the parcel. Let $S_{iv}$ be the net rate of condensation (mass of vapor converted to liquid per unit mass of air per unit time). The first law is:\n$$\nc_p \\frac{DT}{Dt} = Q_{\\mathrm{rad}} + L_v S_{iv}\n$$\nThis equation states that temperature changes are driven by external heating and internal latent heat conversion. The problem statement defines a quantity $h = c_p T + L_v q_v$ and refers to its material derivative. Combining the first law with water vapor conservation below demonstrates the utility of this grouping.\n\n- **Water vapor conservation**: The specific humidity $q_v$ changes due to internal phase changes ($S_{iv}$) and irreversible removal of water mass through precipitation, denoted by the rate $P$.\n$$\n\\frac{Dq_v}{Dt} = -S_{iv} - P\n$$\n\n- **Potential energy**: The term $g \\frac{Dz}{Dt}$ represents the rate of work done by the parcel against gravity. Since $\\frac{Dz}{Dt} = w$ (vertical velocity), this term is $gw$. For the specified one-dimensional problem in the $x$-direction, there is no vertical motion, so $w=0$. Thus, $\\frac{D(gz)}{Dt} = 0$.\n\nCombining these components:\n$$\n\\frac{Dm}{Dt} = \\left( Q_{\\mathrm{rad}} + L_v S_{iv} \\right) + 0 + L_v \\left( -S_{iv} - P \\right)\n$$\n$$\n\\frac{Dm}{Dt} = Q_{\\mathrm{rad}} + L_v S_{iv} - L_v S_{iv} - L_v P = Q_{\\mathrm{rad}} - L_v P\n$$\nThis result is significant: the term $L_v S_{iv}$ associated with reversible internal phase changes cancels out. This means that $m$ is conserved under moist-adiabatic processes where there is no precipitation. The only source/sink terms for $m$ are external heating/cooling ($Q_{\\mathrm{rad}}$) and the irreversible loss of latent energy due to precipitation ($-L_v P$).\n\nTo obtain the full prognostic equation in an Eulerian framework, we must account for the transport of $m$ by advection and diffusion. The general conservation law for a scalar $\\phi$ in flux form is:\n$$\n\\frac{\\partial \\phi}{\\partial t} + \\nabla \\cdot \\mathbf{F} = S_{\\phi}\n$$\nwhere $\\mathbf{F}$ is the total flux and $S_{\\phi}$ is the net source. Here, the scalar is $m$. The transport flux $\\mathbf{F}$ consists of advection ($\\mathbf{u}m$) and Fickian diffusion ($-K \\nabla m$). The full equation is:\n$$\n\\frac{\\partial m}{\\partial t} + \\nabla \\cdot (\\mathbf{u} m) = \\nabla \\cdot (K \\nabla m) + Q_{\\mathrm{rad}} - L_v P\n$$\nRearranging to isolate the tendency term $\\frac{\\partial m}{\\partial t}$ and specializing to one dimension ($x$) with constant velocity $u$ and diffusivity $K$:\n$$\n\\frac{\\partial m}{\\partial t} = - \\frac{\\partial (u m)}{\\partial x} + \\frac{\\partial}{\\partial x} \\left(K \\frac{\\partial m}{\\partial x}\\right) + Q_{\\mathrm{rad}} - L_v P\n$$\nThis is the final prognostic equation to be discretized. It properly separates the transport processes (advection and diffusion), which are expressed as flux divergences, from the volumetric source/sink terms ($Q_{\\mathrm{rad}}$ and $-L_v P$).\n\n**2. Finite-Volume Discretization**\n\nWe discretize the equation on a uniform grid with $N_x$ cells of width $\\Delta x = L/N_x$. The cells are indexed by $i = 0, \\dots, N_x-1$, and the value $m_i$ represents the average of $m(x)$ over cell $i$. Integrating the prognostic equation over cell $i$ (from $x_{i-1/2}$ to $x_{i+1/2}$):\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial m}{\\partial t} dx = \\int_{x_{i-1/2}}^{x_{i+1/2}} \\left[ -\\frac{\\partial(um)}{\\partial x} + \\frac{\\partial}{\\partial x}\\left(K\\frac{\\partial m}{\\partial x}\\right) \\right] dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} (Q_{\\mathrm{rad}} - L_v P) dx\n$$\nApplying the fundamental theorem of calculus to the flux divergence terms:\n$$\n\\Delta x \\frac{d m_i}{dt} = - \\left[ (um)_{i+1/2} - (um)_{i-1/2} \\right] + \\left[ \\left(K \\frac{\\partial m}{\\partial x}\\right)_{i+1/2} - \\left(K \\frac{\\partial m}{\\partial x}\\right)_{i-1/2} \\right] + (Q_{\\mathrm{rad},i} - L_v P_i) \\Delta x\n$$\nDividing by $\\Delta x$:\n$$\n\\frac{d m_i}{dt} = - \\frac{F_{adv, i+1/2} - F_{adv, i-1/2}}{\\Delta x} + \\frac{F_{diff, i+1/2} - F_{diff, i-1/2}}{\\Delta x} + S_i\n$$\nwhere $F_{adv} = um$ is the advective flux, $F_{diff} = K \\frac{\\partial m}{\\partial x}$ is the diffusive flux (defined as per the equation's structure), and $S_i = Q_{\\mathrm{rad},i} - L_v P_i$ is the cell-averaged source/sink term.\n\n- **Advective Flux (Upwind Scheme)**: The flux at the interface $x_{i+1/2}$ is determined by the value in the \"upwind\" cell. For a constant velocity $u$:\n  - If $u  0$ (flow is from left to right), $F_{adv, i+1/2} = u m_i$.\n  - If $u  0$ (flow is from right to left), $F_{adv, i+1/2} = u m_{i+1}$.\n  The advection term for $u  0$ becomes $-u \\frac{m_i - m_{i-1}}{\\Delta x}$. For $u0$, it becomes $-u \\frac{m_{i+1} - m_i}{\\Delta x}$.\n\n- **Diffusive Flux (Centered Scheme)**: The gradient at the interface $x_{i+1/2}$ is approximated using a centered difference:\n  $$\n  F_{diff, i+1/2} = K \\frac{m_{i+1} - m_i}{\\Delta x}\n  $$\n  The diffusion term becomes $\\frac{1}{\\Delta x} \\left( K \\frac{m_{i+1} - m_i}{\\Delta x} - K \\frac{m_i - m_{i-1}}{\\Delta x} \\right) = K \\frac{m_{i+1} - 2m_i + m_{i-1}}{(\\Delta x)^2}$.\n\nThe complete discrete tendency for cell $i$ is the sum of these terms, with indices handled periodically (e.g., $m_{-1} \\equiv m_{N_x-1}$ and $m_{N_x} \\equiv m_0$).\n\n**3. Conservation and Numerical Verification**\n\nA key property of this finite-volume formulation is that the transport terms are discretely conservative. The spatial average of a discrete tendency component, such as advection, is $\\langle A \\rangle = \\frac{1}{N_x} \\sum_{i=0}^{N_x-1} A_i$.\n\nFor the advection term (assuming $u  0$):\n$$\n\\sum_{i=0}^{N_x-1} A_i = \\sum_{i=0}^{N_x-1} \\left( -u \\frac{m_i - m_{i-1}}{\\Delta x} \\right) = -\\frac{u}{\\Delta x} \\sum_{i=0}^{N_x-1} (m_i - m_{i-1})\n$$\nThis is a telescoping sum. With periodic boundary conditions ($m_{-1} = m_{N_x-1}$), the sum is zero: $(m_0 - m_{N_x-1}) + (m_1 - m_0) + \\dots + (m_{N_x-1} - m_{N_x-2}) = 0$.\n\nFor the diffusion term:\n$$\n\\sum_{i=0}^{N_x-1} D_i = \\sum_{i=0}^{N_x-1} \\left( K \\frac{m_{i+1} - 2m_i + m_{i-1}}{(\\Delta x)^2} \\right) = \\frac{K}{(\\Delta x)^2} \\sum_{i=0}^{N_x-1} \\left[ (m_{i+1} - m_i) - (m_i - m_{i-1}) \\right]\n$$\nThis is also a telescoping sum of differences, which evaluates to zero on a periodic domain.\n\nTherefore, the spatial average of the transport tendencies is identically zero: $\\langle A+D \\rangle = 0$. This implies that the spatially averaged tendency of $m$ must equal the spatially averaged source/sink term:\n$$\n\\left\\langle \\frac{dm}{dt} \\right\\rangle = \\langle S \\rangle = \\langle Q_{\\mathrm{rad}} - L_v P \\rangle\n$$\nThe problem asks to compute the residual $\\left\\langle \\frac{dm}{dt} \\right\\rangle - \\langle Q_{\\mathrm{rad}} - L_v P \\rangle$. Based on this analysis, the residual should be zero to within floating-point precision. This is a powerful verification that the numerical scheme correctly conserves the quantity $m$ during transport, meaning that transport only redistributes $m$ within the domain and does not create or destroy it.\n\nThe numerical implementation will compute the discrete tendency $(\\frac{dm}{dt})_i$ for each cell $i$, average it over the domain to get $\\langle \\frac{dm}{dt} \\rangle$, compute the average source $\\langle S \\rangle$, and find their difference.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating the conservation residual for moist static energy\n    tendency in a 1D periodic finite-volume model.\n    \"\"\"\n\n    # --- Constants and Parameters ---\n    # Physical constants\n    cp = 1004.0  # J kg^-1 K^-1\n    Lv = 2.5e6   # J kg^-1\n    g = 9.81     # m s^-2 (note: gz term is constant and its gradient is zero)\n\n    # Domain and Grid\n    L = 1000.0   # m\n    Nx = 128     # number of cells\n    dx = L / Nx  # m\n\n    # Initial state parameters\n    T0 = 300.0   # K\n    q0 = 0.01    # dimensionless\n    A = 1000.0  # J kg^-1\n\n    # --- Test Cases ---\n    test_cases = [\n        # Case 1: Happy path transport-only\n        {'u': 10.0, 'K': 50.0, 'Q_rad_val': 0.0, 'P0': 0.0, 'P_loc': 'none'},\n        # Case 2: Radiation-only\n        {'u': 0.0, 'K': 0.0, 'Q_rad_val': 2.0e-3, 'P0': 0.0, 'P_loc': 'none'},\n        # Case 3: Phase-change sink edge case\n        {'u': 0.0, 'K': 0.0, 'Q_rad_val': 0.0, 'P0': 1.0e-7, 'P_loc': 'center'},\n    ]\n\n    # --- Grid and Initial Field Setup ---\n    # x-coordinates of cell centers\n    x = np.arange(Nx) * dx + dx / 2.0 \n    \n    # Initial moist static energy (m) field. The constant gz term has no gradient\n    # and does not affect transport, so it can be omitted without loss of generality\n    # for the tendency calculation. The base value is m_base = cp*T0 + Lv*q0.\n    m_base = cp * T0 + Lv * q0\n    m_initial = m_base + A * np.sin(2 * np.pi * x / L)\n\n    results = []\n\n    for case in test_cases:\n        u = case['u']\n        K = case['K']\n        Q_rad_val = case['Q_rad_val']\n        P0 = case['P0']\n        P_loc = case['P_loc']\n\n        m = np.copy(m_initial)\n\n        # --- Calculate Tendency Components ---\n\n        # 1. Advection Term (dmdt_adv)\n        dmdt_adv = np.zeros(Nx)\n        if u > 0:\n            # Upwind: value at i-1/2 is m[i-1], value at i+1/2 is m[i]\n            # Here, np.roll(m, 1) brings m[i-1] to index i.\n            m_minus_1 = np.roll(m, 1)\n            flux_divergence = (u * m - u * m_minus_1) / dx\n            dmdt_adv = -flux_divergence\n        elif u  0:\n            # Upwind: value at i-1/2 is m[i], value at i+1/2 is m[i+1]\n            # Here, np.roll(m, -1) brings m[i+1] to index i.\n            m_plus_1 = np.roll(m, -1)\n            flux_divergence = (u * m_plus_1 - u * m) / dx\n            dmdt_adv = -flux_divergence\n        \n        # 2. Diffusion Term (dmdt_diff)\n        dmdt_diff = np.zeros(Nx)\n        if K > 0:\n            # Centered difference for 2nd derivative\n            m_plus_1 = np.roll(m, -1)\n            m_minus_1 = np.roll(m, 1)\n            laplacian_m = (m_plus_1 - 2 * m + m_minus_1) / (dx**2)\n            dmdt_diff = K * laplacian_m\n\n        # 3. Source/Sink Terms (Q_rad_array, P_sink)\n        Q_rad_array = np.full(Nx, Q_rad_val)\n        \n        P_sink = np.zeros(Nx)\n        if P_loc == 'center':\n            center_idx = Nx // 2\n            P_sink[center_idx] = P0\n        \n        source_sink_term = Q_rad_array - Lv * P_sink\n\n        # --- Total Tendency and Residual Calculation ---\n        dmdt = dmdt_adv + dmdt_diff + source_sink_term\n\n        # Spatially averaged tendency\n        avg_dmdt = np.mean(dmdt)\n\n        # Spatially averaged source/sink term\n        avg_source_sink_term = np.mean(source_sink_term)\n\n        # Residual: This should be close to zero, representing conservation\n        residual = avg_dmdt - avg_source_sink_term\n        results.append(residual)\n\n    # --- Print Final Output ---\n    # The output format must be exactly \"[result1,result2,result3]\"\n    print(f\"[{','.join(f'{r:.18e}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "The conservation of energy must be strictly enforced not only in a model's dynamics but also within its physical parameterizations. This final exercise focuses on a critical algorithm, the saturation adjustment scheme, which is central to simulating clouds and precipitation . You will implement a robust numerical method to bring a moist air parcel to equilibrium while perfectly conserving its total water content and moist enthalpy, a task that highlights the precision required in modern model development.",
            "id": "4040102",
            "problem": "Consider a moist air parcel at pressure $p$, temperature $T$, with total water mass fraction $q_t$ partitioned among water vapor $q_v$, liquid water $q_\\ell$, and ice $q_i$ such that $q_v + q_\\ell + q_i = q_t$. The goal is to design a saturation adjustment scheme that updates $T$ and the phase partitioning $(q_v,q_\\ell,q_i)$ to a physically saturated state while strictly conserving the parcel’s moist enthalpy $h$ and the total water $q_t$. The scheme must use only fundamental thermodynamic relations and well-tested formulas.\n\nYou must start from the following base relations and constants, expressed per unit mass of moist air:\n\n- Specific heats at constant pressure: $c_{p,d}$ for dry air, $c_{p,v}$ for water vapor, $c_{p,\\ell}$ for liquid water, and $c_{p,i}$ for ice. Assume they are constant with respect to temperature.\n- Latent heats at the reference temperature $T_0 = 273.15\\,\\mathrm{K}$: $L_{v,0}$ (vaporization) and $L_{f,0}$ (fusion), with $L_{s,0} = L_{v,0} + L_{f,0}$ (sublimation).\n- Ideal gas constants: $R_d$ for dry air, $R_v$ for water vapor, and $\\epsilon = R_d/R_v$.\n- Reference saturation vapor pressure at $T_0$: $e_0$.\n- Saturation vapor pressure $e_s(T)$ given by integrating the Clausius–Clapeyron equation with constant latent heat (a standard, well-tested approximation):\n$$\ne_s(T) = \n\\begin{cases}\ne_0 \\exp\\!\\left( \\dfrac{L_{v,0}}{R_v}\\left(\\dfrac{1}{T_0} - \\dfrac{1}{T}\\right) \\right),  T \\ge T_0 \\text{ (over liquid)} \\\\\ne_0 \\exp\\!\\left( \\dfrac{L_{s,0}}{R_v}\\left(\\dfrac{1}{T_0} - \\dfrac{1}{T}\\right) \\right),  T  T_0 \\text{ (over ice)}\n\\end{cases}\n$$\nThe saturation mixing ratio $r_s$ and the saturation specific humidity $q_s$ are given by ideal gas relations:\n$$\nr_s(T,p) = \\epsilon \\,\\dfrac{e_s(T)}{p - e_s(T)}, \\qquad q_s(T,p) = \\dfrac{r_s}{1 + r_s}.\n$$\n\nDefine species-specific enthalpies as linear functions of $T$ that satisfy the latent heat differences at $T_0$, by choosing offsets $b_v$, $b_\\ell$, and $b_i$ such that $h_v - h_\\ell = L_{v,0}$, $h_v - h_i = L_{s,0}$, and $h_\\ell - h_i = L_{f,0}$ at $T_0$. Take $b_\\ell = 0$ and:\n$$\nh_d(T) = c_{p,d} T, \\quad h_v(T) = c_{p,v} T + b_v, \\quad h_\\ell(T) = c_{p,\\ell} T + b_\\ell = c_{p,\\ell} T, \\quad h_i(T) = c_{p,i} T + b_i,\n$$\nwith\n$$\nb_v = L_{v,0} - (c_{p,v} - c_{p,\\ell}) T_0, \\qquad b_i = -L_{f,0} + (c_{p,\\ell} - c_{p,i}) T_0.\n$$\nThe parcel moist enthalpy $h$ per unit mass of moist air is then\n$$\nh(T,q_v,q_\\ell,q_i,q_t) = (1 - q_t)\\,h_d(T) + q_v\\,h_v(T) + q_\\ell\\,h_\\ell(T) + q_i\\,h_i(T).\n$$\n\nSaturation adjustment problem: Given an initial state $(p, T_\\mathrm{init}, q_t, q_v^\\mathrm{init}, q_\\ell^\\mathrm{init}, q_i^\\mathrm{init})$, compute the initial moist enthalpy $h_\\mathrm{init}$ using the above definition. Find the unique final temperature $T^\\star$ such that the final saturated partition $\\big(q_v^\\star, q_\\ell^\\star, q_i^\\star\\big)$ at $(p, T^\\star, q_t)$ satisfies\n$$\nh\\!\\left(T^\\star, q_v^\\star, q_\\ell^\\star, q_i^\\star, q_t\\right) = h_\\mathrm{init},\n$$\nwith phase partitioning rules:\n- If $q_t \\le q_s(T^\\star,p)$, the state is unsaturated and $q_v^\\star = q_t$, $q_\\ell^\\star = 0$, $q_i^\\star = 0$.\n- If $q_t  q_s(T^\\star,p)$ and $T^\\star \\ge T_0$, saturate over liquid: $q_v^\\star = q_s(T^\\star,p)$, $q_\\ell^\\star = q_t - q_v^\\star$, $q_i^\\star = 0$.\n- If $q_t  q_s(T^\\star,p)$ and $T^\\star  T_0$, saturate over ice: $q_v^\\star = q_s(T^\\star,p)$, $q_i^\\star = q_t - q_v^\\star$, $q_\\ell^\\star = 0$.\n\nYour program must solve for $T^\\star$ by root-finding on the function\n$$\nF(T) = h\\!\\left(T, q_v(T), q_\\ell(T), q_i(T), q_t\\right) - h_\\mathrm{init},\n$$\nwhere $(q_v(T), q_\\ell(T), q_i(T))$ follow the saturation partitioning rules above, and must return the absolute conservation error\n$$\n\\Delta h = \\left|\\, h\\!\\left(T^\\star, q_v^\\star, q_\\ell^\\star, q_i^\\star, q_t\\right) - h_\\mathrm{init} \\,\\right|\n$$\nfor each test case.\n\nScientific realism requirements:\n- Use $c_{p,d} = 1004\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $c_{p,v} = 1860\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $c_{p,\\ell} = 4185\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $c_{p,i} = 2106\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$.\n- Use $L_{v,0} = 2.5\\times 10^6\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$, $L_{f,0} = 3.34\\times 10^5\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$, so $L_{s,0} = 2.834\\times 10^6\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}$.\n- Use $R_d = 287.05\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $R_v = 461.5\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$, $\\epsilon = R_d/R_v$.\n- Use $e_0 = 611.65\\,\\mathrm{Pa}$ and $T_0 = 273.15\\,\\mathrm{K}$.\n\nUnits and output:\n- All temperatures must be in $\\mathrm{K}$, pressures in $\\mathrm{Pa}$, water mass fractions in $\\mathrm{kg}\\,\\mathrm{kg}^{-1}$, and moist enthalpy in $\\mathrm{J}\\,\\mathrm{kg}^{-1}$.\n- For each test case, compute the absolute enthalpy conservation error $\\Delta h$ in $\\mathrm{J}\\,\\mathrm{kg}^{-1}$ and output these values.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each entry being a floating-point number in $\\mathrm{J}\\,\\mathrm{kg}^{-1}$, for example $[x_1,x_2,x_3]$.\n\nTest suite:\nImplement the saturation adjustment and compute $\\Delta h$ for the following five test cases, each specified as $(p, T_\\mathrm{init}, q_t, q_v^\\mathrm{init}, q_\\ell^\\mathrm{init}, q_i^\\mathrm{init})$:\n\n1. $(95000\\,\\mathrm{Pa},\\,295\\,\\mathrm{K},\\,0.010,\\,0.010,\\,0.000,\\,0.000)$\n2. $(90000\\,\\mathrm{Pa},\\,288\\,\\mathrm{K},\\,0.018,\\,0.018,\\,0.000,\\,0.000)$\n3. $(80000\\,\\mathrm{Pa},\\,263\\,\\mathrm{K},\\,0.0045,\\,0.0045,\\,0.000,\\,0.000)$\n4. $(85000\\,\\mathrm{Pa},\\,268\\,\\mathrm{K},\\,0.010,\\,0.004,\\,0.000,\\,0.006)$\n5. $(90000\\,\\mathrm{Pa},\\,271\\,\\mathrm{K},\\,0.020,\\,0.020,\\,0.000,\\,0.000)$\n\nThe numerical solver must be robust and demonstrate that $\\Delta h$ is at or below machine precision for double-precision arithmetic in all cases.\n\nYour task: Implement the scheme and produce the single-line output of the five $\\Delta h$ values in $\\mathrm{J}\\,\\mathrm{kg}^{-1}$ as a list in the exact specified format.",
            "solution": "The problem requires the design and implementation of a saturation adjustment scheme for a moist air parcel. The core principle is the conservation of total water mass fraction $q_t$ and moist enthalpy $h$ during the transition from an initial, potentially non-equilibrium state to a final, thermodynamically saturated equilibrium state.\n\nThe final equilibrium state is defined by a unique temperature $T^\\star$ and a corresponding phase partition $(q_v^\\star, q_\\ell^\\star, q_i^\\star)$ that are consistent with the saturation properties of water at that temperature and pressure. This physical constraint establishes a functional relationship between the parcel's enthalpy and its temperature, allowing us to find $T^\\star$ by solving a nonlinear equation.\n\nThe algorithmic approach is as follows:\n\n1.  **Compute Initial Enthalpy:** For each test case, the initial moist enthalpy, $h_\\mathrm{init}$, is computed using the given initial state $(T_\\mathrm{init}, q_v^\\mathrm{init}, q_\\ell^\\mathrm{init}, q_i^\\mathrm{init})$ and the total water content $q_t$. This value of $h_\\mathrm{init}$ becomes the conserved quantity for the adjustment process. The formula used is:\n    $$\n    h_\\mathrm{init} = (1 - q_t)\\,h_d(T_\\mathrm{init}) + q_v^\\mathrm{init}\\,h_v(T_\\mathrm{init}) + q_\\ell^\\mathrm{init}\\,h_\\ell(T_\\mathrm{init}) + q_i^\\mathrm{init}\\,h_i(T_\\mathrm{init})\n    $$\n    where the species-specific enthalpies $h_x(T)$ are calculated using the provided linear-in-$T$ formulas and constants.\n\n2.  **Define the Root-Finding Function:** We must find the temperature $T^\\star$ that satisfies the conservation equation $h(T^\\star) = h_\\mathrm{init}$. This is equivalent to finding the root of the function $F(T) = h(T) - h_\\mathrm{init}$. The function $F(T)$ is constructed as follows:\n    - **a. Calculate Saturation Specific Humidity:** For a given temperature $T$ and pressure $p$, the saturation specific humidity $q_s(T,p)$ is calculated. This step involves first determining the saturation vapor pressure $e_s(T)$ using the appropriate form of the Clausius-Clapeyron equation depending on whether $T$ is above or below the freezing point $T_0$. Then, $q_s$ is found from $e_s$ and $p$.\n    - **b. Determine Phase Partition:** The total water content $q_t$ is partitioned into vapor ($q_v$), liquid ($q_\\ell$), and ice ($q_i$) based on the saturation rules provided.\n        - If $q_t \\le q_s(T,p)$, the parcel is unsaturated. All water is in vapor form: $q_v = q_t$, $q_\\ell = 0$, $q_i = 0$.\n        - If $q_t  q_s(T,p)$, the parcel is saturated. The excess water, $q_t - q_s$, condenses. If $T \\ge T_0$, it forms liquid water: $q_v = q_s$, $q_\\ell = q_t - q_s$, $q_i = 0$. If $T  T_0$, it forms ice: $q_v = q_s$, $q_i = q_t - q_s$, $q_\\ell = 0$.\n    - **c. Calculate Enthalpy:** With the temperature $T$ and the calculated phase partition $(q_v, q_\\ell, q_i)$, the current moist enthalpy $h(T)$ is computed using the same general enthalpy formula.\n    - **d. Return Residual:** The function returns the residual value $h(T) - h_\\mathrm{init}$.\n\n3.  **Solve for Final Temperature:** The function $F(T)$ is continuous and strictly monotonic, making it ideal for a numerical root-finding algorithm. We use the robust `brentq` method from the `scipy.optimize` library. This method requires a bracketing interval $[T_a, T_b]$ where $F(T_a)$ and $F(T_b)$ have opposite signs. A physically reasonable and sufficiently wide interval, such as $[150\\,\\mathrm{K}, 350\\,\\mathrm{K}]$, ensures that the root is bracketed for all plausible atmospheric scenarios. The algorithm iteratively narrows this interval to find $T^\\star$ to high precision.\n\n4.  **Compute Conservation Error:** The final step is to verify the accuracy of the solution. The problem requires reporting the absolute conservation error, $\\Delta h = |h(T^\\star, q_v^\\star, q_\\ell^\\star, q_i^\\star, q_t) - h_\\mathrm{init}|$. This is simply the absolute value of the function $F(T)$ evaluated at the computed root, $|F(T^\\star)|$. A value at or near machine precision confirms that the numerical scheme successfully found the temperature that conserves enthalpy.\n\nThis procedure is implemented for each of the five test cases, and the resulting conservation errors $\\Delta h$ are collected for the final output.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import brentq\n\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\n\ndef solve():\n    \"\"\"\n    Implements a saturation adjustment scheme that conserves moist enthalpy,\n    and computes the final conservation error for a suite of test cases.\n    \"\"\"\n    \n    # 1. Physical and Thermodynamic Constants\n    c_pd = 1004.0      # J kg^-1 K^-1, specific heat of dry air\n    c_pv = 1860.0      # J kg^-1 K^-1, specific heat of water vapor\n    c_pl = 4185.0      # J kg^-1 K^-1, specific heat of liquid water\n    c_pi = 2106.0      # J kg^-1 K^-1, specific heat of ice\n    \n    L_v0 = 2.5e6       # J kg^-1, latent heat of vaporization at T0\n    L_f0 = 3.34e5      # J kg^-1, latent heat of fusion at T0\n    L_s0 = L_v0 + L_f0 # J kg^-1, latent heat of sublimation at T0\n    \n    R_d = 287.05       # J kg^-1 K^-1, gas constant for dry air\n    R_v = 461.5        # J kg^-1 K^-1, gas constant for water vapor\n    epsilon = R_d / R_v\n    \n    T0 = 273.15        # K, reference temperature (freezing point)\n    e0 = 611.65        # Pa, saturation vapor pressure at T0\n\n    # Enthalpy offsets based on latent heats at T0\n    b_v = L_v0 - (c_pv - c_pl) * T0\n    b_i = -L_f0 + (c_pl - c_pi) * T0\n\n    # 2. Helper Functions\n    def calculate_es(T: float) -> float:\n        \"\"\"\n        Calculates saturation vapor pressure e_s(T) in Pa.\n        Uses different latent heats for T >= T0 (liquid) and T  T0 (ice).\n        \"\"\"\n        if T >= T0:\n            return e0 * np.exp((L_v0 / R_v) * (1 / T0 - 1 / T))\n        else:\n            return e0 * np.exp((L_s0 / R_v) * (1 / T0 - 1 / T))\n\n    def calculate_qs(T: float, p: float) -> float:\n        \"\"\"\n        Calculates saturation specific humidity q_s(T, p) in kg/kg.\n        \"\"\"\n        es_val = calculate_es(T)\n        # Prevent division by zero or negative pressure in denominator if es > p\n        if es_val >= p:\n             return 1.0 # Or some large number representing full saturation\n        rs_val = epsilon * es_val / (p - es_val)\n        return rs_val / (1.0 + rs_val)\n\n    def calculate_h(T: float, qv: float, ql: float, qi: float, qt: float) -> float:\n        \"\"\"\n        Calculates moist enthalpy h per unit mass of moist air in J/kg.\n        \"\"\"\n        h_d = c_pd * T\n        h_v = c_pv * T + b_v\n        h_l = c_pl * T\n        h_i = c_pi * T + b_i\n        \n        return (1.0 - qt) * h_d + qv * h_v + ql * h_l + qi * h_i\n\n    # 3. Main Saturation Adjustment Logic\n    def F(T: float, p: float, qt: float, h_init: float) -> float:\n        \"\"\"\n        The root-finding function F(T) = h(T) - h_init.\n        It computes h(T) based on the saturation-adjusted state at temperature T.\n        \"\"\"\n        qs_val = calculate_qs(T, p)\n        \n        # Determine phase partitioning based on saturation rules\n        if qt = qs_val:\n            # Unsaturated case\n            qv, ql, qi = qt, 0.0, 0.0\n        else:\n            # Saturated case\n            qv = qs_val\n            if T >= T0:\n                ql = qt - qs_val\n                qi = 0.0\n            else:\n                ql = 0.0\n                qi = qt - qs_val\n\n        # Calculate enthalpy for the adjusted state\n        h_current = calculate_h(T, qv, ql, qi, qt)\n        \n        return h_current - h_init\n\n    # 4. Test Suite and Execution\n    test_cases = [\n        # (p, T_init, qt, qv_init, ql_init, qi_init)\n        (95000.0, 295.0, 0.010, 0.010, 0.000, 0.000),\n        (90000.0, 288.0, 0.018, 0.018, 0.000, 0.000),\n        (80000.0, 263.0, 0.0045, 0.0045, 0.000, 0.000),\n        (85000.0, 268.0, 0.010, 0.004, 0.000, 0.006),\n        (90000.0, 271.0, 0.020, 0.020, 0.000, 0.000),\n    ]\n\n    results = []\n    for case in test_cases:\n        p, T_init, qt, qv_init, ql_init, qi_init = case\n        \n        # Calculate the initial enthalpy to be conserved\n        h_init = calculate_h(T_init, qv_init, ql_init, qi_init, qt)\n        \n        # Find the final temperature T_star by finding the root of F(T)\n        T_star = brentq(\n            f=F,\n            a=150.0,  # Lower bound of temperature search range in K\n            b=350.0,  # Upper bound of temperature search range in K\n            args=(p, qt, h_init)\n        )\n        \n        # The absolute conservation error is |F(T_star)|\n        delta_h = abs(F(T_star, p, qt, h_init))\n        results.append(delta_h)\n\n    # 5. Final Output Formatting\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}