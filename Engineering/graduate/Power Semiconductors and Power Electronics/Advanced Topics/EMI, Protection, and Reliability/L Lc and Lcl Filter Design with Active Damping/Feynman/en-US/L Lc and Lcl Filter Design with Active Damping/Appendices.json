{
    "hands_on_practices": [
        {
            "introduction": "The first step in any filter design is sizing the passive components to meet key performance specifications. This exercise focuses on a fundamental task: determining the minimum inductance for the converter-side inductor in an LCL filter to control the current ripple produced by the inverter's switching action. By linking system parameters like DC bus voltage ($V_{dc}$) and switching frequency ($f_s$) to a required component value, this practice hones the essential skill of translating high-level requirements into concrete hardware design specifications .",
            "id": "3854098",
            "problem": "A three-phase two-level Voltage Source Inverter (VSI) supplies a balanced sinusoidal current to a stiff grid through an inductor-capacitor-inductor (LCL) filter. The converter employs Space Vector Modulation (SVM), which for a single phase leg can be represented equivalently by a centered, symmetric Pulse Width Modulation (PWM) with phase leg voltage switching between $+\\frac{V_{dc}}{2}$ and $-\\frac{V_{dc}}{2}$ at switching frequency $f_{s}$. The fundamental component of the average phase-leg voltage is set by the modulation index $m$, so that the average voltage over one switching period is $v_{\\text{avg}}(\\theta)=\\frac{m V_{dc}}{2}\\sin(\\theta)$, where $\\theta$ is the fundamental angle.\n\nActive damping is implemented via capacitor-current feedback to emulate a virtual resistor, ensuring that the LCL resonance is sufficiently damped. Assume the active damping loop bandwidth is sufficiently below $f_{s}$ so that it does not alter the within-switching-period dynamics of the phase-leg voltage.\n\nConsider the converter-side inductor of the LCL filter with inductance $L$. Neglect resistive losses and assume continuous conduction. Use the fundamental relationship $v_{L}(t)=L\\,\\frac{di(t)}{dt}$ and first principles of PWM average modeling to derive an expression for the peak-to-peak ripple of the inductor current over a single switching period as a function of the instantaneous modulation angle $\\theta$. Then, by enforcing that the peak-to-peak current ripple does not exceed a specified bound $\\Delta i$ for any $\\theta$ over the fundamental cycle, compute the minimum required inductor value $L$ in terms of $V_{dc}$, $m$, $f_{s}$, and $\\Delta i$.\n\nExpress your final answer as a single closed-form symbolic expression for $L$ in Henry (H). No numerical substitution is required, and no rounding is necessary.",
            "solution": "The problem asks for the minimum required value of the converter-side inductor, $L$, in a three-phase VSI system using an LCL filter. The design criterion is that the peak-to-peak current ripple in this inductor does not exceed a specified value $\\Delta i$ at any point in the fundamental cycle.\n\nFirst, we establish a model for the voltage across the inductor $L$. The inductor is situated between the inverter phase-leg output and the filter capacitor. The voltage across the inductor, $v_L(t)$, is given by the difference between the instantaneous phase-leg voltage, $v_{\\text{sw}}(t)$, and the voltage at the filter capacitor, which is approximately the fundamental component of the grid voltage. For the purpose of calculating high-frequency ripple within a single switching period $T_s = 1/f_s$, we can assume the fundamental-frequency voltage is constant and equal to the average phase-leg voltage over that period, $v_{\\text{avg}}(\\theta)$.\n$$v_L(t) = v_{\\text{sw}}(t) - v_{\\text{avg}}(\\theta)$$\nThe problem states that the phase-leg voltage $v_{\\text{sw}}(t)$ switches between $+\\frac{V_{dc}}{2}$ and $-\\frac{V_{dc}}{2}$ relative to the DC-link midpoint. The average voltage is given as $v_{\\text{avg}}(\\theta) = \\frac{m V_{dc}}{2}\\sin(\\theta)$.\n\nThe modulation scheme is centered, symmetric PWM. For a given average voltage, the duty cycle $D$ (fraction of the period where the pulse is high) for a bipolar PWM can be found. The average voltage is given by $v_{\\text{avg}} = (\\frac{V_{dc}}{2})D + (-\\frac{V_{dc}}{2})(1-D) = \\frac{V_{dc}}{2}(2D-1)$. Equating this with the given expression for $v_{\\text{avg}}(\\theta)$:\n$$\\frac{V_{dc}}{2}(2D(\\theta)-1) = \\frac{m V_{dc}}{2}\\sin(\\theta) \\implies D(\\theta) = \\frac{1 + m \\sin(\\theta)}{2}$$\nIn centered, symmetric PWM, the pulse of duration $D T_s$ is centered within the switching period $T_s$. This means the voltage is high ($+\\frac{V_{dc}}{2}$) during the interval $[\\frac{(1-D)T_s}{2}, \\frac{(1+D)T_s}{2}]$ and low ($-\\frac{V_{dc}}{2}$) otherwise.\n\nThe inductor current ripple is caused by the switching-frequency components of the voltage $v_L(t)$. The change in inductor current is governed by $L \\frac{di(t)}{dt} = v_L(t)$. The peak-to-peak ripple, $\\Delta i_{pp}$, is the change in current from its minimum to its maximum value within one switching period. The current slope is positive when $v_L(t) > 0$ and negative when $v_L(t) < 0$. The maximum current occurs at the end of the interval where $v_L(t)$ is positive, and the minimum occurs at the beginning of this interval.\n\nThe voltage across the inductor during the high-voltage part of the PWM pulse is:\n$$v_{L,\\text{on}} = v_{\\text{sw,high}} - v_{\\text{avg}}(\\theta) = \\frac{V_{dc}}{2} - \\frac{m V_{dc}}{2}\\sin(\\theta) = \\frac{V_{dc}}{2}(1 - m\\sin(\\theta))$$\nThis interval has a duration of $D(\\theta)T_s$. The peak-to-peak current ripple is the total current change during this time:\n$$\\Delta i_{pp}(\\theta) = \\frac{v_{L,\\text{on}}}{L} \\times (\\text{Duration}) = \\frac{1}{L} \\left[ \\frac{V_{dc}}{2}(1 - m\\sin(\\theta)) \\right] (D(\\theta)T_s)$$\nSubstituting the expression for $D(\\theta)$ and $T_s=1/f_s$:\n$$\\Delta i_{pp}(\\theta) = \\frac{1}{L} \\left[ \\frac{V_{dc}}{2}(1 - m\\sin(\\theta)) \\right] \\left[ \\frac{1 + m \\sin(\\theta)}{2} \\right] \\frac{1}{f_s}$$\nUsing the algebraic identity $(a-b)(a+b) = a^2 - b^2$, we simplify the expression:\n$$\\Delta i_{pp}(\\theta) = \\frac{V_{dc}}{4Lf_s} (1 - m^2\\sin^2(\\theta))$$\nThis is the expression for the peak-to-peak inductor current ripple as a function of the fundamental angle $\\theta$.\n\nNext, we must find the worst-case (maximum) ripple over a full fundamental cycle, i.e., for all $\\theta \\in [0, 2\\pi]$. We need to maximize $\\Delta i_{pp}(\\theta)$:\n$$\\Delta i_{pp, \\max} = \\max_{\\theta} \\left[ \\frac{V_{dc}}{4Lf_s} (1 - m^2\\sin^2(\\theta)) \\right]$$\nThe term $\\frac{V_{dc}}{4Lf_s}$ is a positive constant. The maximization depends on the term $(1 - m^2\\sin^2(\\theta))$. Since $m^2 \\ge 0$ and $\\sin^2(\\theta) \\ge 0$, the term $m^2\\sin^2(\\theta)$ is always non-negative. To maximize the expression, we must minimize $m^2\\sin^2(\\theta)$. The minimum value of this term is $0$, which occurs when $\\sin(\\theta) = 0$ (i.e., at $\\theta = 0, \\pi, 2\\pi, \\ldots$).\n\nAt these points, the maximum value of $(1 - m^2\\sin^2(\\theta))$ is $1$. Therefore, the maximum peak-to-peak current ripple over the entire fundamental cycle is:\n$$\\Delta i_{pp, \\max} = \\frac{V_{dc}}{4Lf_s} (1) = \\frac{V_{dc}}{4Lf_s}$$\nIt is noteworthy that the maximum ripple is independent of the modulation index $m$.\n\nFinally, the problem requires that this maximum ripple must not exceed the specified bound $\\Delta i$. This gives us the following inequality:\n$$\\Delta i_{pp, \\max} \\le \\Delta i$$\n$$\\frac{V_{dc}}{4Lf_s} \\le \\Delta i$$\nTo ensure this condition is met, the inductor value $L$ must be sufficiently large. We can solve for the minimum required value of $L$ by rearranging the inequality:\n$$L \\ge \\frac{V_{dc}}{4 f_s \\Delta i}$$\nThe minimum required inductance $L$ is therefore the value that makes this an equality.",
            "answer": "$$\\boxed{\\frac{V_{dc}}{4 f_{s} \\Delta i}}$$"
        },
        {
            "introduction": "While passive components form the filter's backbone, higher-order filters like the LCL type require active damping to suppress potentially destabilizing resonance. This practice moves beyond ideal theory to confront a critical real-world challenge: the impact of sensor noise on control performance. You will analyze how measurement noise propagates through the active damping loop and learn to design a low-pass filter, striking a crucial engineering trade-off between maintaining damping effectiveness and ensuring high-frequency noise rejection .",
            "id": "3853991",
            "problem": "A three-phase grid-connected voltage-source inverter uses an inductor-capacitor-inductor (LCL) output filter with converter-side inductance $L_1$, grid-side inductance $L_2$, and shunt capacitance $C$. The grid voltage is $v_{\\mathrm{g}}(t)$, the converter voltage command is $v_{\\mathrm{conv}}(t)$, the converter-side current is $i_1(t)$, the grid-side current is $i_2(t)$, and the capacitor current is $i_C(t)$. Neglect parasitic resistances and assume continuous-time control with negligible Pulse-Width Modulation (PWM) delay. Active damping is implemented by feeding back the measured capacitor current through a proportional gain to the converter voltage command:\n$$\nv_{\\mathrm{conv}}(t) \\;=\\; v_{\\mathrm{ctrl}}(t) \\;-\\; k_{\\mathrm{ad}}\\,i_{C,\\mathrm{meas}}(t),\n$$\nwhere $k_{\\mathrm{ad}} \\gt 0$ is the active damping gain and $i_{C,\\mathrm{meas}}(t)$ is the measured capacitor current. The measured capacitor current $i_{C,\\mathrm{meas}}(t)$ is corrupted by additive sensor noise $n_C(t)$ and filtered by a first-order low-pass filter (LPF):\n$$\ni_{C,\\mathrm{meas}}(s) \\;=\\; F_{\\mathrm{lp}}(s)\\,\\big(i_C(s) + n_C(s)\\big), \\quad F_{\\mathrm{lp}}(s) \\;=\\; \\frac{\\omega_{\\mathrm{lp}}}{s + \\omega_{\\mathrm{lp}}},\n$$\nwith cutoff angular frequency $\\omega_{\\mathrm{lp}} \\gt 0$. Assume the resonance angular frequency of the LCL network is\n$$\n\\omega_{\\mathrm{r}} \\;=\\; \\sqrt{\\frac{L_1 + L_2}{L_1\\,L_2\\,C}},\n$$\nand consider the frequency domain where the closed-loop current regulator bandwidth is below $\\omega_{\\mathrm{r}}$ and the dominant dynamics around $\\omega_{\\mathrm{r}}$ are determined by the passive LCL network and the active damping path.\n\nUsing Kirchhoff’s Current Law (KCL), $i_C(t) = i_1(t) - i_2(t)$, and the constitutive laws of inductors and capacitors, analyze how the measurement noise $n_C(s)$ propagates to the grid current $i_2(s)$ through the active damping path. In particular:\n\n- Derive an approximate transfer function $T_{n\\to i_2}(s)$ from $n_C(s)$ to $i_2(s)$ in the frequency range at and above $\\omega_{\\mathrm{r}}$, expressed in terms of $k_{\\mathrm{ad}}$, $F_{\\mathrm{lp}}(s)$, and the LCL plant, and justify any approximations used from first principles.\n- From your $T_{n\\to i_2}(s)$, determine how the magnitude of the noise-induced grid current scales with frequency for $\\omega \\ge \\omega_{\\mathrm{r}}$.\n- Propose a choice of $\\omega_{\\mathrm{lp}}$ relative to $\\omega_{\\mathrm{r}}$ that limits noise amplification at high frequency while preserving active damping effectiveness near $\\omega_{\\mathrm{r}}$. For preservation of damping, require that at $\\omega = \\omega_{\\mathrm{r}}$ the LPF introduces less than $30^\\circ$ phase lag and reduces the damping path magnitude by no more than $15\\%$. For limiting noise amplification, prefer smaller $\\omega_{\\mathrm{lp}}$ subject to those damping constraints.\n\nWhich choice best satisfies these constraints and represents a sound design trade-off?\n\nA. $\\omega_{\\mathrm{lp}} \\approx 0.3\\,\\omega_{\\mathrm{r}}$\n\nB. $\\omega_{\\mathrm{lp}} \\approx 1.0\\,\\omega_{\\mathrm{r}}$\n\nC. $\\omega_{\\mathrm{lp}} \\approx 2.0\\,\\omega_{\\mathrm{r}}$\n\nD. $\\omega_{\\mathrm{lp}} \\approx 10.0\\,\\omega_{\\mathrm{r}}$",
            "solution": "The solution proceeds in three main parts as requested: deriving the noise-to-current transfer function, analyzing its high-frequency behavior, and determining the optimal choice for the low-pass filter cutoff frequency based on the given constraints.\n\n**1. Derivation of the Noise-to-Grid-Current Transfer Function $T_{n\\to i_2}(s)$**\n\nFirst, we establish the system's equations in the Laplace domain. By Kirchhoff's Voltage Law (KVL) applied to the LCL filter, we have:\n$$ s\\,L_1\\,i_1(s) = v_{\\mathrm{conv}}(s) - v_C(s) $$\n$$ s\\,L_2\\,i_2(s) = v_C(s) - v_{\\mathrm{g}}(s) $$\nwhere $v_C(s)$ is the capacitor voltage. The capacitor's constitutive law is:\n$$ i_C(s) = s\\,C\\,v_C(s) $$\nKirchhoff's Current Law (KCL) at the capacitor node is:\n$$ i_C(s) = i_1(s) - i_2(s) $$\nTo analyze the propagation of the measurement noise $n_C(s)$ to the grid current $i_2(s)$, we set other independent inputs to zero, i.e., $v_{\\mathrm{g}}(s) = 0$ and $v_{\\mathrm{ctrl}}(s) = 0$. The latter is justified by the problem statement that the current controller bandwidth is well below the resonance frequency $\\omega_{\\mathrm{r}}$.\n\nUnder these conditions, the equations become:\n(1) $s\\,L_1\\,i_1(s) = v_{\\mathrm{conv}}(s) - v_C(s)$\n(2) $v_C(s) = s\\,L_2\\,i_2(s)$\nFrom (2) and the capacitor law, we relate $i_C(s)$ to $i_2(s)$:\n$$ i_C(s) = s\\,C\\,v_C(s) = s\\,C\\,(s\\,L_2\\,i_2(s)) = s^2\\,C\\,L_2\\,i_2(s) $$\nFrom KCL, we express $i_1(s)$ in terms of $i_2(s)$ and $i_C(s)$:\n$$ i_1(s) = i_C(s) + i_2(s) = (s^2\\,C\\,L_2 + 1)i_2(s) $$\nThe converter voltage command is determined by the active damping loop:\n$$ v_{\\mathrm{conv}}(s) = -k_{\\mathrm{ad}}\\,i_{C,\\mathrm{meas}}(s) = -k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)\\,(i_C(s) + n_C(s)) $$\nSubstituting the expression for $i_C(s)$:\n$$ v_{\\mathrm{conv}}(s) = -k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)\\,(s^2\\,C\\,L_2\\,i_2(s) + n_C(s)) $$\nNow, we substitute these expressions back into equation (1):\n$$ s\\,L_1\\,(s^2\\,C\\,L_2 + 1)i_2(s) = -k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)\\,(s^2\\,C\\,L_2\\,i_2(s) + n_C(s)) - s\\,L_2\\,i_2(s) $$\nWe rearrange to solve for the transfer function $T_{n\\to i_2}(s) = i_2(s)/n_C(s)$. Grouping terms with $i_2(s)$ on the left side:\n$$ i_2(s) \\left[ s\\,L_1(s^2\\,C\\,L_2 + 1) + s\\,L_2 + k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)s^2\\,C\\,L_2 \\right] = -k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)\\,n_C(s) $$\nThe term in the brackets is the characteristic polynomial:\n$$ s^3\\,L_1\\,L_2\\,C + s(L_1 + L_2) + k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)s^2\\,C\\,L_2 $$\nUsing the definition of the resonance frequency, $\\omega_{\\mathrm{r}}^2 = \\frac{L_1 + L_2}{L_1\\,L_2\\,C}$, we have $L_1 + L_2 = \\omega_{\\mathrm{r}}^2 L_1 L_2 C$. Substituting this:\n$$ s^3\\,L_1\\,L_2\\,C + s\\,\\omega_{\\mathrm{r}}^2 L_1 L_2 C + k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)s^2\\,C\\,L_2 = s\\,L_1\\,L_2\\,C(s^2 + \\omega_{\\mathrm{r}}^2) + k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)s^2\\,C\\,L_2 $$\nThe closed-loop transfer function from $n_C(s)$ to $i_2(s)$ is therefore:\n$$ T_{n\\to i_2}(s) = \\frac{-k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)}{s\\,L_1\\,L_2\\,C(s^2 + \\omega_{\\mathrm{r}}^2) + k_{\\mathrm{ad}}\\,F_{\\mathrm{lp}}(s)s^2\\,C\\,L_2} $$\nThe problem asks for an *approximate* transfer function for $\\omega \\ge \\omega_{\\mathrm{r}}$. For frequencies well above the resonance, $\\omega \\gg \\omega_{\\mathrm{r}}$, the term $s^2+\\omega_{\\mathrm{r}}^2 \\approx s^2$. Furthermore, the feedback loop gain diminishes, so the system response approaches the forward path gain. The forward path from noise $n_C(s)$ to current $i_2(s)$ is given by the cascade of the noise injection gain, $-k_{\\mathrm{ad}}F_{\\mathrm{lp}}(s)$, and the plant transfer function $G_{v\\to i_2}(s)=\\frac{i_2(s)}{v_{\\mathrm{conv}}(s)}$. The plant transfer function is $G_{v\\to i_2}(s) = \\frac{1}{s\\,L_1\\,L_2\\,C(s^2 + \\omega_{\\mathrm{r}}^2)}$. Thus, the approximate transfer function representing the propagation path is:\n$$ T_{n\\to i_2}(s) \\approx -k_{\\mathrm{ad}}F_{\\mathrm{lp}}(s)G_{v\\to i_2}(s) = \\frac{-k_{\\mathrm{ad}}F_{\\mathrm{lp}}(s)}{s\\,L_1\\,L_2\\,C(s^2 + \\omega_{\\mathrm{r}}^2)} $$\nThis approximation is justified because for high frequencies, the loop gain of the active damping feedback becomes much less than 1.\n\n**2. High-Frequency Scaling Analysis**\n\nWe analyze the magnitude of the approximate transfer function for high frequencies, $s=j\\omega$ where $\\omega \\to \\infty$.\nThe low-pass filter transfer function is $F_{\\mathrm{lp}}(s) = \\frac{\\omega_{\\mathrm{lp}}}{s + \\omega_{\\mathrm{lp}}}$. For large $s$, $F_{\\mathrm{lp}}(s) \\sim \\frac{\\omega_{\\mathrm{lp}}}{s}$.\nThe plant part of the transfer function for large $s$ is $\\frac{1}{s\\,L_1\\,L_2\\,C(s^2 + \\omega_{\\mathrm{r}}^2)} \\sim \\frac{1}{L_1\\,L_2\\,C\\,s^3}$.\nCombining these, the asymptotic behavior of $T_{n\\to i_2}(s)$ is:\n$$ T_{n\\to i_2}(s) \\sim -k_{\\mathrm{ad}} \\left( \\frac{\\omega_{\\mathrm{lp}}}{s} \\right) \\left( \\frac{1}{L_1\\,L_2\\,C\\,s^3} \\right) = \\frac{-k_{\\mathrm{ad}}\\,\\omega_{\\mathrm{lp}}}{L_1\\,L_2\\,C\\,s^4} $$\nThe magnitude for $s=j\\omega$ is:\n$$ |T_{n\\to i_2}(j\\omega)| \\sim \\frac{k_{\\mathrm{ad}}\\,\\omega_{\\mathrm{lp}}}{L_1\\,L_2\\,C\\,\\omega^4} $$\nThe magnitude of the noise-induced grid current scales with $\\omega^{-4}$ for $\\omega \\gg \\omega_{\\mathrm{r}}$. This corresponds to a roll-off of $-80$ dB/decade. Importantly, the magnitude is directly proportional to the LPF cutoff frequency $\\omega_{\\mathrm{lp}}$. This confirms that a smaller $\\omega_{\\mathrm{lp}}$ is preferable for attenuating high-frequency noise.\n\n**3. Selection of LPF Cutoff Frequency $\\omega_{\\mathrm{lp}}$**\n\nWe must choose $\\omega_{\\mathrm{lp}}$ to satisfy two constraints at the resonance frequency $\\omega = \\omega_{\\mathrm{r}}$, while preferring the smallest possible $\\omega_{\\mathrm{lp}}$.\n\nConstraint 1: Phase lag from LPF $< 30^\\circ$ at $\\omega = \\omega_{\\mathrm{r}}$.\nThe phase of $F_{\\mathrm{lp}}(j\\omega)$ is $\\phi(\\omega) = -\\arctan(\\frac{\\omega}{\\omega_{\\mathrm{lp}}})$. The phase lag is $-\\phi(\\omega)$.\n$$ \\arctan\\left(\\frac{\\omega_{\\mathrm{r}}}{\\omega_{\\mathrm{lp}}}\\right) < 30^\\circ $$\nSince $\\tan(x)$ is a monotonically increasing function for $x \\in (-\\pi/2, \\pi/2)$:\n$$ \\frac{\\omega_{\\mathrm{r}}}{\\omega_{\\mathrm{lp}}} < \\tan(30^\\circ) = \\frac{1}{\\sqrt{3}} $$\n$$ \\omega_{\\mathrm{lp}} > \\sqrt{3}\\,\\omega_{\\mathrm{r}} \\approx 1.732\\,\\omega_{\\mathrm{r}} $$\n\nConstraint 2: Magnitude reduction from LPF $\\le 15\\%$ at $\\omega = \\omega_{\\mathrm{r}}$.\nThis means the magnitude $|F_{\\mathrm{lp}}(j\\omega_{\\mathrm{r}})|$ must be at least $1 - 0.15 = 0.85$.\nThe magnitude is $|F_{\\mathrm{lp}}(j\\omega)| = \\frac{\\omega_{\\mathrm{lp}}}{\\sqrt{\\omega^2 + \\omega_{\\mathrm{lp}}^2}} = \\frac{1}{\\sqrt{(\\omega/\\omega_{\\mathrm{lp}})^2 + 1}}$.\n$$ \\frac{1}{\\sqrt{(\\omega_{\\mathrm{r}}/\\omega_{\\mathrm{lp}})^2 + 1}} \\ge 0.85 $$\n$$ \\frac{1}{(\\omega_{\\mathrm{r}}/\\omega_{\\mathrm{lp}})^2 + 1} \\ge 0.85^2 = 0.7225 $$\n$$ (\\frac{\\omega_{\\mathrm{r}}}{\\omega_{\\mathrm{lp}}})^2 + 1 \\le \\frac{1}{0.7225} \\approx 1.3841 $$\n$$ (\\frac{\\omega_{\\mathrm{r}}}{\\omega_{\\mathrm{lp}}})^2 \\le 0.3841 $$\n$$ \\frac{\\omega_{\\mathrm{r}}}{\\omega_{\\mathrm{lp}}} \\le \\sqrt{0.3841} = 0.6198 $$\n$$ \\omega_{\\mathrm{lp}} \\ge \\frac{\\omega_{\\mathrm{r}}}{0.6198} \\approx 1.613\\,\\omega_{\\mathrm{r}} $$\n\nComparing the two conditions, the phase constraint ($\\omega_{\\mathrm{lp}} > 1.732\\,\\omega_{\\mathrm{r}}$) is stricter than the magnitude constraint ($\\omega_{\\mathrm{lp}} \\ge 1.613\\,\\omega_{\\mathrm{r}}$). Therefore, to satisfy both, we must choose $\\omega_{\\mathrm{lp}}$ such that $\\omega_{\\mathrm{lp}} > 1.732\\,\\omega_{\\mathrm{r}}$.\n\nTo limit noise amplification, we need the smallest value of $\\omega_{\\mathrm{lp}}$ that meets this condition. We now evaluate the given options against this requirement.\n\n**Option-by-Option Analysis**\n\nA. $\\omega_{\\mathrm{lp}} \\approx 0.3\\,\\omega_{\\mathrm{r}}$\nThe ratio $\\omega_{\\mathrm{lp}}/\\omega_{\\mathrm{r}} \\approx 0.3$, which is less than $1.732$. This choice violates the damping preservation constraints. Phase lag at $\\omega_r$ would be $\\arctan(1/0.3) \\approx 73.3^\\circ$, far exceeding the $30^\\circ$ limit.\n**Verdict: Incorrect**\n\nB. $\\omega_{\\mathrm{lp}} \\approx 1.0\\,\\omega_{\\mathrm{r}}$\nThe ratio $\\omega_{\\mathrm{lp}}/\\omega_{\\mathrm{r}} \\approx 1.0$, which is less than $1.732$. This choice also violates the constraints. Phase lag at $\\omega_r$ would be $\\arctan(1/1) = 45^\\circ$, which is greater than the $30^\\circ$ limit.\n**Verdict: Incorrect**\n\nC. $\\omega_{\\mathrm{lp}} \\approx 2.0\\,\\omega_{\\mathrm{r}}$\nThe ratio $\\omega_{\\mathrm{lp}}/\\omega_{\\mathrm{r}} \\approx 2.0$, which is greater than $1.732$. Let's explicitly check the constraints:\nPhase lag: $\\arctan(\\omega_{\\mathrm{r}}/(2\\omega_{\\mathrm{r}})) = \\arctan(0.5) \\approx 26.6^\\circ < 30^\\circ$. (Satisfied)\nMagnitude: $|F_{\\mathrm{lp}}(j\\omega_{\\mathrm{r}})| = 1/\\sqrt{(1/2)^2+1} \\approx 0.894$. The reduction is $1 - 0.894 = 0.106$, or $10.6\\%$, which is less than $15\\%$. (Satisfied)\nThis option satisfies both constraints.\n**Verdict: Correct**\n\nD. $\\omega_{\\mathrm{lp}} \\approx 10.0\\,\\omega_{\\mathrm{r}}$\nThe ratio $\\omega_{\\mathrm{lp}}/\\omega_{\\mathrm{r}} \\approx 10.0$, which is also greater than $1.732$. This option satisfies both constraints as well.\nPhase lag: $\\arctan(0.1) \\approx 5.7^\\circ < 30^\\circ$. (Satisfied)\nMagnitude reduction: $1 - 1/\\sqrt{(0.1)^2+1} \\approx 0.5\\% < 15\\%$. (Satisfied)\nHowever, the problem specifies to prefer a smaller $\\omega_{\\mathrm{lp}}$ to limit noise amplification. While this option preserves damping effectiveness very well, it is not the best choice from a noise perspective. Compared to Option C, it would allow more high-frequency noise to pass into the control loop.\n**Verdict: Incorrect** (as it is not the *best* choice representing the trade-off).\n\nConclusion: Option C is the only choice that satisfies the necessary damping preservation criteria while also adhering to the principle of minimizing the filter cutoff frequency to reject noise, thus representing the best design trade-off among the given choices.",
            "answer": "$$\\boxed{C}$$"
        },
        {
            "introduction": "A successful filter design must not only ensure stability but also meet strict grid code requirements for harmonic distortion. This capstone exercise synthesizes the concepts of different filter topologies and their performance into a practical computational tool. By developing a harmonic compliance simulator from first principles, you will gain the ability to quantitatively evaluate and compare the attenuation characteristics of L, LC, and LCL filters, verifying their ability to limit grid current harmonics to permissible levels .",
            "id": "3854041",
            "problem": "Design and implement a frequency-domain simulator to evaluate whether line-current harmonics at specified orders comply with given limits for three grid-interface filter topologies: inductor (L), inductor-capacitor (LC), and inductor-capacitor-inductor (LCL) with active damping. Your simulator must compute the magnitude of the transfer function from an inverter-side harmonic voltage source to the grid-side current for each specified harmonic order and determine compliance against harmonic current limits. The simulator should compute using fundamental circuit laws only and must not rely on any pre-derived shortcut formulas beyond the definitions of impedance and Kirchhoff’s laws.\n\nUse the following context and base definitions:\n- Kirchhoff’s Current Law (KCL): At any node, the algebraic sum of currents is zero.\n- Ohm’s Law in the frequency domain: For a component with impedance $Z(\\mathrm{j}\\omega)$, the current is $I(\\mathrm{j}\\omega) = V(\\mathrm{j}\\omega)/Z(\\mathrm{j}\\omega)$.\n- Inductor impedance: $Z_L(\\mathrm{j}\\omega) = \\mathrm{j}\\,\\omega L$.\n- Capacitor impedance (with active damping implemented as a virtual series resistor): $Z_C(\\mathrm{j}\\omega) = R_v + \\dfrac{1}{\\mathrm{j}\\,\\omega C}$.\n- Parallel combination: $Z_{a\\parallel b} = \\dfrac{Z_a Z_b}{Z_a + Z_b}$.\n\nAssume a single-phase grid model with Thevenin impedance $Z_g(\\mathrm{j}\\omega) = R_g + \\mathrm{j}\\,\\omega L_g$. Model the inverter as an ideal voltage source producing harmonic components at specified orders of the fundamental frequency. For each harmonic order $h$, define the angular frequency $\\omega_h = 2\\pi f_1 h$.\n\nDefine the grid-side current magnitude at harmonic $h$ as $|I_g(h)| = |G(\\mathrm{j}\\omega_h)|\\,A_h$, where $A_h$ is the root mean square (RMS) voltage amplitude of the inverter harmonic at order $h$ and $G(\\mathrm{j}\\omega)$ is the small-signal transfer function from the inverter-side harmonic voltage to the grid-side current.\n\nDerive $G(\\mathrm{j}\\omega)$ from first principles for each topology using node-voltage analysis:\n1) L filter: One inductor $L_1$ in series between inverter and grid port; grid port connected to ground through $Z_g(\\mathrm{j}\\omega)$.\n2) LC filter: One inductor $L_1$ in series between inverter and a node that connects in parallel to capacitor $C$ to ground and grid impedance $Z_g(\\mathrm{j}\\omega)$ to ground.\n3) LCL filter with active damping: Inductor $L_1$ in series from inverter to an intermediate node; from this node, a shunt branch to ground via the damped capacitor $Z_C(\\mathrm{j}\\omega)$, and a series inductor $L_2$ to the grid port; the grid port is connected to ground via $Z_g(\\mathrm{j}\\omega)$.\n\nFor the LCL case, implement active damping by modeling capacitor-current feedback as an equivalent series resistor of value $R_v$ in series with the capacitor, inside $Z_C(\\mathrm{j}\\omega)$.\n\nCompliance criterion:\n- For each harmonic order $h$, let the limit for the RMS grid current be $I_{h,\\mathrm{lim}}$. A topology is compliant if and only if $|I_g(h)| \\le I_{h,\\mathrm{lim}}$ for all specified harmonic orders $h$.\n\nAmplitude scaling modes:\n- Direct: Use the given base RMS voltage amplitudes $A_h$ as-is.\n- Boundary: Compute a scalar $s^\\star$ such that the worst-case harmonic is exactly at the limit when amplitudes are scaled to $s^\\star A_h$. Formally,\n$$\ns^\\star \\;=\\; \\left(\\max_h \\frac{|G(\\mathrm{j}\\omega_h)|\\,A_h}{I_{h,\\mathrm{lim}}}\\right)^{-1}.\n$$\nUse amplitudes $s^\\star A_h$ for compliance evaluation (this should be exactly on the boundary and therefore compliant by the inclusive inequality).\n- Boundary-times: Given a factor $k>0$, use amplitudes $k\\,s^\\star A_h$, where $s^\\star$ is computed as above. If $k>1$, the test should become non-compliant.\n\nPhysical and numerical units:\n- Fundamental frequency: $f_1 = 50\\,\\mathrm{Hz}$.\n- Harmonic orders: $[5,7,11,13,17,19]$ (dimensionless).\n- Harmonic RMS voltage amplitudes at the inverter: $A_h = [5,5,5,5,5,5]$ in $\\mathrm{V}$.\n- Grid impedance parameters: $R_g = 0.1\\,\\Omega$, $L_g = 0.7\\,\\mathrm{mH}$.\n- Harmonic current limits in RMS amperes: $I_{h,\\mathrm{lim}} = [2.0,1.5,1.2,1.1,1.0,0.9]$ in $\\mathrm{A}$.\n\nTest suite:\nProvide three independent test cases that each define a topology, component values, and an amplitude scaling mode:\n- Case $1$ (happy path, compliant): Topology LCL with active damping. Use $L_1 = 1.8\\,\\mathrm{mH}$, $L_2 = 1.8\\,\\mathrm{mH}$, $C = 15\\,\\mu\\mathrm{F}$, $R_v = 1.5\\,\\Omega$, scaling mode Direct with scale factor $s=1$.\n- Case $2$ (boundary condition, exactly at the limit): Topology LC without active damping. Use $L_1 = 2.2\\,\\mathrm{mH}$, $C = 10\\,\\mu\\mathrm{F}$, scaling mode Boundary, i.e., compute $s^\\star$ from the network and use $s^\\star A_h$.\n- Case $3$ (edge case beyond the limit, non-compliant): Topology L only. Use $L_1 = 1.0\\,\\mathrm{mH}$, scaling mode Boundary-times with $k = 1.2$ (i.e., compute $s^\\star$ for this topology and then scale amplitudes to $1.2\\,s^\\star A_h$).\n\nAlgorithmic requirements:\n- Construct the frequency-domain impedances for each harmonic using the given component values.\n- For each topology, derive $G(\\mathrm{j}\\omega)$ from KCL and Ohm’s law:\n  - For L and LC, reduce the network using series and parallel combinations consistently.\n  - For LCL, set up the node-voltage equations and solve the $2\\times 2$ linear system to obtain the grid-port voltage and current as a function of the inverter-port source voltage.\n- Compute $|I_g(h)| = |G(\\mathrm{j}\\omega_h)|\\,A_h$ for all harmonics. For Boundary and Boundary-times modes, compute $s^\\star$ using the definition above, then rescale amplitudes accordingly before evaluating compliance.\n\nFinal output specification:\n- Your program should produce a single line of output containing a list of three boolean values, one per test case, indicating overall compliance for that case (true if compliant for all specified harmonics, false otherwise).\n- The booleans must be printed in lowercase as the strings \"true\" or \"false\".\n- The overall output format must be exactly a single line of the form: \"[b1,b2,b3]\". For example, \"[true,true,false]\".\n\nAll quantities must be handled in SI units. Angles and phases are implicit in complex impedances; no angular units are required. The final answers for each test case must be booleans as defined above. No user input is required; all parameters are fixed by this specification within the program.",
            "solution": "The problem requires the design and implementation of a frequency-domain simulator to assess the compliance of grid-side current harmonics for three filter topologies: L, LC, and LCL. The assessment is based on comparing the calculated root mean square (RMS) current magnitude at specific harmonic frequencies against specified limits. The analysis must be derived from fundamental principles, namely Kirchhoff's Current Law (KCL) and Ohm's Law in the frequency domain.\n\nThe core of the problem is to determine the transfer function $G(\\mathrm{j}\\omega) = I_g(\\mathrm{j}\\omega) / V_{inv}(\\mathrm{j}\\omega)$, where $V_{inv}(\\mathrm{j}\\omega)$ is the inverter's harmonic voltage output and $I_g(\\mathrm{j}\\omega)$ is the resulting current injected into the grid. The harmonic voltage is treated as a small-signal source. The angular frequency for a harmonic of order $h$ is given by $\\omega_h = 2\\pi f_1 h$, where $f_1$ is the fundamental frequency.\n\nFirst, we define the impedances of the passive components and the grid in the frequency domain:\n- Grid impedance: $Z_g(\\mathrm{j}\\omega) = R_g + \\mathrm{j}\\omega L_g$.\n- Inverter-side inductor impedance: $Z_{L1}(\\mathrm{j}\\omega) = \\mathrm{j}\\omega L_1$.\n- Grid-side inductor impedance (for the LCL topology): $Z_{L2}(\\mathrm{j}\\omega) = \\mathrm{j}\\omega L_2$.\n- Damped capacitor impedance (with active damping): $Z_C(\\mathrm{j}\\omega) = R_v + \\frac{1}{\\mathrm{j}\\omega C}$. For topologies without active damping, the virtual resistance $R_v$ is set to $0$.\n\nThe derivation of the transfer function $G(\\mathrm{j}\\omega)$ for each of the three topologies proceeds as follows.\n\n**1. L Filter Topology**\nIn this configuration, a single inductor $L_1$ is placed in series between the inverter voltage source $V_{inv}$ and the grid port. The grid is represented by its Thévenin impedance $Z_g$. The circuit consists of $V_{inv}$ driving a series combination of $Z_{L1}$ and $Z_g$. The total impedance of the circuit is $Z_{tot} = Z_{L1} + Z_g$. The grid current $I_g$ is the current flowing through this entire series circuit. Applying Ohm's Law:\n$$ I_g(\\mathrm{j}\\omega) = \\frac{V_{inv}(\\mathrm{j}\\omega)}{Z_{tot}(\\mathrm{j}\\omega)} = \\frac{V_{inv}(\\mathrm{j}\\omega)}{Z_{L1}(\\mathrm{j}\\omega) + Z_g(\\mathrm{j}\\omega)} $$\nThe transfer function $G_L(\\mathrm{j}\\omega)$ is therefore:\n$$ G_L(\\mathrm{j}\\omega) = \\frac{I_g(\\mathrm{j}\\omega)}{V_{inv}(\\mathrm{j}\\omega)} = \\frac{1}{Z_{L1}(\\mathrm{j}\\omega) + Z_g(\\mathrm{j}\\omega)} = \\frac{1}{\\mathrm{j}\\omega L_1 + R_g + \\mathrm{j}\\omega L_g} $$\n\n**2. LC Filter Topology**\nThe LC filter consists of a series inductor $L_1$ followed by a shunt capacitor $C$. The problem states that the grid impedance $Z_g$ is connected in parallel with the capacitor $C$. In this case, active damping is not used, so $R_v=0$ and the capacitor impedance is $Z_C(\\mathrm{j}\\omega) = 1/(\\mathrm{j}\\omega C)$.\nThe equivalent impedance of the parallel combination of $Z_C$ and $Z_g$ is given by:\n$$ Z_p(\\mathrm{j}\\omega) = \\frac{Z_C(\\mathrm{j}\\omega) Z_g(\\mathrm{j}\\omega)}{Z_C(\\mathrm{j}\\omega) + Z_g(\\mathrm{j}\\omega)} $$\nThe total current from the inverter, $I_{tot}$, flows through $Z_{L1}$ and is given by $I_{tot} = V_{inv} / (Z_{L1} + Z_p)$. This current then splits between the capacitor and the grid impedance. Using the current divider rule to find the grid current $I_g$:\n$$ I_g(\\mathrm{j}\\omega) = I_{tot}(\\mathrm{j}\\omega) \\cdot \\frac{Z_C(\\mathrm{j}\\omega)}{Z_C(\\mathrm{j}\\omega) + Z_g(\\mathrm{j}\\omega)} $$\nSubstituting the expression for $I_{tot}$:\n$$ I_g(\\mathrm{j}\\omega) = \\frac{V_{inv}(\\mathrm{j}\\omega)}{Z_{L1}(\\mathrm{j}\\omega) + Z_p(\\mathrm{j}\\omega)} \\cdot \\frac{Z_C(\\mathrm{j}\\omega)}{Z_C(\\mathrm{j}\\omega) + Z_g(\\mathrm{j}\\omega)} $$\nSubstituting $Z_p$ and simplifying:\n$$ I_g(\\mathrm{j}\\omega) = \\frac{V_{inv}(\\mathrm{j}\\omega)}{Z_{L1} + \\frac{Z_C Z_g}{Z_C + Z_g}} \\cdot \\frac{Z_C}{Z_C + Z_g} = V_{inv}(\\mathrm{j}\\omega) \\frac{Z_C + Z_g}{Z_{L1}(Z_C + Z_g) + Z_C Z_g} \\cdot \\frac{Z_C}{Z_C + Z_g} $$\nThis simplifies to the transfer function $G_{LC}(\\mathrm{j}\\omega)$:\n$$ G_{LC}(\\mathrm{j}\\omega) = \\frac{Z_C}{Z_{L1}Z_C + Z_{L1}Z_g + Z_C Z_g} $$\n\n**3. LCL Filter Topology with Active Damping**\nThis topology has an inverter-side inductor $L_1$, a shunt capacitor $C$ with virtual damping resistor $R_v$, and a grid-side inductor $L_2$. Let $V_1$ be the voltage at the node between $Z_{L1}$, $Z_C$, and $Z_{L2}$, and $V_2$ be the voltage at the node between $Z_{L2}$ and $Z_g$ (the grid port). We apply KCL at these two nodes to find $V_2$, from which we derive the grid current $I_g = V_2 / Z_g$.\n\nAt node $1$ (voltage $V_1$):\n$$ \\frac{V_1 - V_{inv}}{Z_{L1}} + \\frac{V_1}{Z_C} + \\frac{V_1 - V_2}{Z_{L2}} = 0 $$\n$$ V_1 \\left( \\frac{1}{Z_{L1}} + \\frac{1}{Z_C} + \\frac{1}{Z_{L2}} \\right) - V_2 \\left( \\frac{1}{Z_{L2}} \\right) = \\frac{V_{inv}}{Z_{L1}} $$\n\nAt node $2$ (voltage $V_2$):\n$$ \\frac{V_2 - V_1}{Z_{L2}} + \\frac{V_2}{Z_g} = 0 $$\n$$ -V_1 \\left( \\frac{1}{Z_{L2}} \\right) + V_2 \\left( \\frac{1}{Z_{L2}} + \\frac{1}{Z_g} \\right) = 0 $$\n\nThis is a $2 \\times 2$ system of linear equations for the node voltages $V_1$ and $V_2$. We can solve this system analytically for $V_2$ in terms of $V_{inv}$. From the second equation, we express $V_1$ in terms of $V_2$: $V_1 = V_2 (1 + Z_{L2}/Z_g)$. Substituting this into the first equation and solving for $V_2$ yields:\n$$ V_2(\\mathrm{j}\\omega) = V_{inv}(\\mathrm{j}\\omega) \\frac{Z_C(\\mathrm{j}\\omega) Z_g(\\mathrm{j}\\omega)}{Z_{L1}Z_{L2} + Z_{L1}Z_g + Z_{L2}Z_C + Z_C Z_g + Z_{L1}Z_C} $$\nThe grid current is $I_g = V_2 / Z_g$. Thus, the transfer function $G_{LCL}(\\mathrm{j}\\omega)$ is:\n$$ G_{LCL}(\\mathrm{j}\\omega) = \\frac{V_2(\\mathrm{j}\\omega)}{Z_g(\\mathrm{j}\\omega) V_{inv}(\\mathrm{j}\\omega)} = \\frac{Z_C}{Z_{L1}Z_{L2} + Z_{L1}Z_g + Z_{L2}Z_C + Z_C Z_g + Z_{L1}Z_C} $$\n\n**Evaluation Procedure**\nFor each test case and each specified harmonic order $h$, the simulator performs the following steps:\n1.  Calculate the harmonic angular frequency $\\omega_h = 2\\pi f_1 h$.\n2.  Compute the complex impedance values for all components at $\\omega_h$.\n3.  Calculate the complex transfer function $G(\\mathrm{j}\\omega_h)$ using the appropriate derived formula for the given topology.\n4.  The magnitude of the transfer function $|G(\\mathrm{j}\\omega_h)|$ is stored for each harmonic.\n\nAfter calculating $|G(\\mathrm{j}\\omega_h)|$ for all relevant harmonics, the voltage amplitudes $A_h$ are scaled according to the specified mode:\n-   **Direct**: The base amplitudes $A_h$ are used directly. The resulting grid current for each harmonic is $|I_g(h)| = |G(\\mathrm{j}\\omega_h)| A_h$.\n-   **Boundary**: A scaling factor $s^\\star$ is computed to bring the most critical harmonic exactly to its limit. This factor is defined as $s^\\star = (\\max_h \\frac{|G(\\mathrm{j}\\omega_h)|\\,A_h}{I_{h,\\mathrm{lim}}})^{-1}$. The amplitudes are then set to $A'_h = s^\\star A_h$. The resulting grid current is $|I_g(h)| = |G(\\mathrm{j}\\omega_h)| A'_h$. By this definition, the system should be perfectly compliant.\n-   **Boundary-times**: The amplitudes are scaled by a factor $k$ beyond the boundary condition: $A'_h = k s^\\star A_h$.\n\nFinally, compliance is checked. A topology is deemed compliant if and only if $|I_g(h)| \\le I_{h,\\mathrm{lim}}$ for all specified harmonic orders $h$. A small numerical tolerance is used in the implementation to handle potential floating-point inaccuracies, especially for the Boundary case where the worst-case harmonic current should be exactly equal to its limit.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases and print the final result.\n    \"\"\"\n\n    # --- Givens from problem statement ---\n    f1 = 50.0  # Hz\n    h_orders = np.array([5, 7, 11, 13, 17, 19])\n    Ah_base = np.array([5.0, 5.0, 5.0, 5.0, 5.0, 5.0]) # V (RMS)\n    Ih_lim = np.array([2.0, 1.5, 1.2, 1.1, 1.0, 0.9]) # A (RMS)\n    \n    # Grid impedance parameters\n    Rg = 0.1  # Ohms\n    Lg = 0.7e-3  # H\n\n    # --- Test Case Definitions ---\n    test_cases = [\n        {\n            \"topology\": \"LCL\",\n            \"params\": {\"L1\": 1.8e-3, \"L2\": 1.8e-3, \"C\": 15e-6, \"Rv\": 1.5},\n            \"scaling_mode\": \"Direct\",\n            \"k_factor\": 1.0\n        },\n        {\n            \"topology\": \"LC\",\n            \"params\": {\"L1\": 2.2e-3, \"C\": 10e-6, \"L2\": 0.0, \"Rv\": 0.0},\n            \"scaling_mode\": \"Boundary\",\n            \"k_factor\": 1.0\n        },\n        {\n            \"topology\": \"L\",\n            \"params\": {\"L1\": 1.0e-3, \"C\": 0.0, \"L2\": 0.0, \"Rv\": 0.0},\n            \"scaling_mode\": \"Boundary-times\",\n            \"k_factor\": 1.2\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        is_compliant = evaluate_case(case, h_orders, Ah_base, Ih_lim, f1, Rg, Lg)\n        results.append(\"true\" if is_compliant else \"false\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef get_transfer_function_magnitudes(case, h_orders, f1, Rg, Lg):\n    \"\"\"\n    Calculates the magnitude of the transfer function G(jw) for each harmonic.\n    \"\"\"\n    topology = case[\"topology\"]\n    params = case[\"params\"]\n    \n    L1 = params.get(\"L1\", 0.0)\n    L2 = params.get(\"L2\", 0.0)\n    C = params.get(\"C\", 0.0)\n    Rv = params.get(\"Rv\", 0.0)\n\n    omega_h = 2 * np.pi * f1 * h_orders\n    g_magnitudes = []\n\n    for omega in omega_h:\n        # Define complex impedances for the current frequency\n        Z_g = Rg + 1j * omega * Lg\n        Z_L1 = 1j * omega * L1\n        \n        if topology == \"L\":\n            # G(jw) = 1 / (Z_L1 + Z_g)\n            G = 1 / (Z_L1 + Z_g)\n        \n        elif topology == \"LC\":\n            # Zc = 1 / (j*omega*C) since Rv=0\n            Z_C = 1 / (1j * omega * C)\n            # G(jw) = Zc / (Z_L1*Zc + Z_L1*Zg + Zc*Zg)\n            G = Z_C / (Z_L1 * Z_C + Z_L1 * Z_g + Z_C * Z_g)\n\n        elif topology == \"LCL\":\n            Z_L2 = 1j * omega * L2\n            Z_C = Rv + 1 / (1j * omega * C)\n            # G(jw) = Zc / (Z_L1*Z_L2 + Z_L1*Z_g + Z_L2*Z_c + Z_c*Z_g + Z_L1*Z_c)\n            numerator = Z_C\n            denominator = Z_L1*Z_L2 + Z_L1*Z_g + Z_L2*Z_C + Z_C*Z_g + Z_L1*Z_C\n            G = numerator / denominator\n            \n        else:\n            raise ValueError(f\"Unknown topology: {topology}\")\n            \n        g_magnitudes.append(np.abs(G))\n    \n    return np.array(g_magnitudes)\n\ndef evaluate_case(case, h_orders, Ah_base, Ih_lim, f1, Rg, Lg):\n    \"\"\"\n    Evaluates a single test case for harmonic compliance.\n    \"\"\"\n    g_mags = get_transfer_function_magnitudes(case, h_orders, f1, Rg, Lg)\n    \n    Ah_scaled = np.copy(Ah_base)\n    scaling_mode = case[\"scaling_mode\"]\n\n    if scaling_mode == \"Boundary\" or scaling_mode == \"Boundary-times\":\n        # Calculate ratio of current to limit for each harmonic\n        ratios = (g_mags * Ah_base) / Ih_lim\n        # Find scaling factor s_star\n        if np.max(ratios) == 0:\n            s_star = float('inf') # Avoid division by zero\n        else:\n            s_star = 1.0 / np.max(ratios)\n        \n        k = case[\"k_factor\"]\n        Ah_scaled = k * s_star * Ah_base\n\n    # For \"Direct\" mode, Ah_scaled remains Ah_base\n    \n    # Calculate final grid currents\n    Ig_h = g_mags * Ah_scaled\n    \n    # Check compliance for all harmonics\n    # Use a small tolerance for floating point comparisons\n    compliance_checks = Ig_h <= Ih_lim * (1 + 1e-9)\n        \n    return np.all(compliance_checks)\n\n# Execute the simulation\nsolve()\n\n```"
        }
    ]
}