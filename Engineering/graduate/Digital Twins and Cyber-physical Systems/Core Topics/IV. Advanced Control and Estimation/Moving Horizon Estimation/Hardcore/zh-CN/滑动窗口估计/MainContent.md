## 引言
在现代[数字孪生](@entry_id:171650)与信息物理系统（Cyber-Physical Systems, CPS）的复杂世界中，精确掌握动态系统的内部状态是实现高效监控、精准控制和可靠决策的基石。然而，由于传感器测量的局限性、模型的不确定性以及系统固有的物理约束，获取实时而准确的状态信息成为一项重大挑战。传统的状态估计算法，如卡尔曼滤波器，虽然在特定条件下表现出色，但在处理强[非线性](@entry_id:637147)、硬约束及非高斯噪声等现实问题时往往力不从心。移动水平估计（Moving Horizon Estimation, MHE）正是在这一背景下应运而生的一种强大的、基于优化的估计算法，它通过在有限时间窗口内解决一个优化问题，为这一难题提供了有效的解决方案。

本文将系统性地引导您深入理解移动水平估计的理论精髓与实践价值。在“原理与机制”一章中，我们将剖析MHE的数学构造，揭示其与经典估计器的深刻联系，并探讨约束处理与可观测性等核心原理。随后，在“应用与跨学科连接”一章中，我们将展示MHE如何作为一项关键技术，在状态同步、故障诊断、网络安全以及与模型预测控制（MPC）的协同中发挥作用，连接起多个前沿科学与工程领域。最后，“动手实践”部分将提供一系列精心设计的问题，帮助您将理论知识转化为解决实际问题的能力。通过这一系列的学习，您将掌握构建下一代智能、可靠动态系统的关键估计技术。

## 原理与机制

移动水平估计 (Moving Horizon Estimation, MHE) 作为一种基于优化的状态估计方法，其核心在于在每个时间步求解一个[约束优化问题](@entry_id:1122941)，以在有限的时间窗口内，使模型预测与观测数据达到最佳匹配。本章将深入探讨支撑 MHE 的基本原理与核心机制，阐明其数学构造、理论保障以及实际应用中的关键考量。

### MHE 优化问题：形式化定义

移动水平估计的本质是在一个长度为 $N$ 的滑动时间窗口内，对系统的状态轨迹进行重构。在每个时刻 $k$，MHE 求解一个[参数化](@entry_id:265163)的约束优化问题，其决策变量通常是窗口内的状态轨迹 $\{x_{k-N}, \dots, x_k\}$ 以及过程扰动序列 $\{w_{k-N}, \dots, w_{k-1}\}$。一个典型的[非线性](@entry_id:637147) MHE 问题可以表述为以下形式：

$$
\min_{x_{k-N},\dots,x_k, w_{k-N},\dots,w_{k-1}} J_k
$$

其[目标函数](@entry_id:267263) $J_k$ 由三个核心部分组成：

1.  **到达成本 (Arrival Cost)**：该项惩罚窗口初始状态 $x_{k-N}$ 与其[先验估计](@entry_id:186098)值 $\bar{x}_{k-N}$ 之间的偏差。它以浓缩的形式概括了时间窗口之前的所有历史信息。其形式通常为二次型，$\Gamma(x_{k-N} - \bar{x}_{k-N}) = \|x_{k-N} - \bar{x}_{k-N}\|^2_{\Pi^{-1}}$，其中 $\Pi$ 是先验误差的[协方差矩阵](@entry_id:139155)。

2.  **过程模型成本 (Process Model Cost)**：该项惩罚在窗口内模型动态方程的不满足程度，这通常归因于未建模的过程扰动 $w_j$。它量化了状态轨迹与系统动态模型 $x_{j+1} = f(x_j, u_j, w_j)$ 的一致性。对于加性扰动，此成本通常是扰动序列的加权范数，例如 $\sum_{j=k-N}^{k-1} \|w_j\|^2_{Q^{-1}}$，其中 $Q$ 是[过程噪声](@entry_id:270644)的协方差矩阵。

3.  **量测模型成本 (Measurement Model Cost)**：该项惩罚模型预测输出与实际量测值 $y_j$ 之间的残差。它反映了量测噪声 $v_j$ 的影响，量测模型为 $y_j = h(x_j, u_j) + v_j$。此成本通常是量测残差的加权范数，例如 $\sum_{j=k-N}^{k} \|y_j - h(x_j, u_j)\|^2_{R^{-1}}$，其中 $R$ 是量测噪声的[协方差矩阵](@entry_id:139155)。

此外，该优化问题还受制于一系列约束，包括：
*   **动态约束**：$x_{j+1} = f(x_j, u_j, w_j)$，对于 $j \in \{k-N, \dots, k-1\}$。
*   **物理与安全约束**：对状态和输入的限制，例如 $x_j \in \mathbb{X}, u_j \in \mathbb{U}$。

将这些部分组合起来，MHE 求解器在每个时刻 $k$ 都在寻找一个既符合近期数据又与先验知识和物理定律相容的状态轨迹。这种基于滑动窗口的优化框架，使其在众多估计器中独树一帜。

### MHE 与经典估计器的关系

为了更好地理解 MHE 的特性，我们将其与两种经典的估计算法——**卡尔曼滤波器 (Kalman Filter, KF)** 和**[固定区间平滑](@entry_id:201439)器 (Fixed-Interval Smoother, FIS)** 进行比较 。

*   **时间窗口处理**：KF 是一种**递归**算法，它在每个时间步处理一个新的量测，并将所有历史信息压缩到一个不断更新的[先验概率](@entry_id:275634)分布中。它没有显式的优化窗口，其记忆是无限但呈指数衰减的。FIS 则是一种**批处理**算法，它一次性处理一个固定区间 $[0, T]$ 内的所有数据，以获得整个区间的状态轨[迹估计](@entry_id:756081)。MHE 则采用了一种折衷方案：它在一个**滑动的有限窗口**内进行优化，既利用了一段历史数据，又保持了在线计算的可行性。

*   **目标函数**：从[贝叶斯估计](@entry_id:137133)的角度看，这三者都可以被视为求解一个**[最大后验概率](@entry_id:268939) (Maximum A Posteriori, MAP)** 估计问题。对于[线性高斯系统](@entry_id:1127254)，KF 的递归更新等价于求解一个单步二次优化问题，其目标函数由当前量测的[似然](@entry_id:167119)和从过去递推而来的先验构成。FIS 的目标函数则是在整个固定区间上所有量测[似然](@entry_id:167119)和初始先验的联合概率。MHE 的[目标函数](@entry_id:267263)则是在滑动窗口内的 MAP 问题，其中**到达成本**扮演了窗口之前所有信息的先验角色。

*   **等价性条件**：在无约束的[线性高斯系统](@entry_id:1127254)中，这些估计器在特定条件下是等价的。如果 MHE 的到达成本被精确地设置为由卡尔曼滤波器计算得到的关于窗口初始状态 $x_{k-N}$ 的先验（即 $p(x_{k-N}|y_{0:k-N-1})$），那么 MHE 将给出与 KF 完全相同的状态估计 $\hat{x}_{k|k}$。另一方面，如果 MHE 的窗口长度 $N$ 扩展到覆盖整个固定区间 $[0, T]$，并且其到达成本就是系统的初始先验 $p(x_0)$，那么 MHE 就等价于[固定区间平滑](@entry_id:201439)器 。

*   **约束处理**：MHE 最显著的优势在于其**内生地处理约束**的能力。而标准的 KF 和 FIS 算法本质上是无约束的，尽[管存](@entry_id:1127299)在为它们添加约束的变体（如投影卡尔曼滤波器），但这通常会引入近似或增加[计算复杂性](@entry_id:204275)。MHE 将约束作为优化问题的固有部分，这对于确保[数字孪生](@entry_id:171650)或控制系统中的物理可行性至关重要。

### 核心原理一：约束估计

MHE 能够直接整合关于系统状态和输入的先验知识，这通常以**约束 (constraints)** 的形式体现。这一能力是其在处理具有物理限制的赛博物理系统（Cyber-Physical Systems, CPS）时相较于传统滤波器的主要优势 。

在 MHE 框架中，状态和输入的约束定义了优化问题的**可行集 (feasible set)**。任何违反约束的轨迹都会被优化器自动排除。常见的约束类型包括：

*   **盒式约束 (Box Constraints)**：形如 $\ell \le x_i \le u$ 的分量级上下界约束。这类约束非常普遍，例如，在[数字孪生](@entry_id:171650)中用于表示化学反应物浓度不能为负、电池的荷电状态（State-of-Charge）必须在 $[0, 1]$ 之间，或温度必须处于安全工作范围之内。这些由[闭区间](@entry_id:136474)定义的约束构成了搜索空间中的一个闭合[凸集](@entry_id:155617)（一个超矩形），确保了估计结果的物理意义。

*   **一般[不等式约束](@entry_id:176084) (General Inequality Constraints)**：形如 $g(x_i, u_i) \le 0$ 的约束，可以表示更复杂的物理或安全规则。例如，它可以表示一个电机的总功耗不能超过其额定功率，或者多个[状态变量](@entry_id:138790)的组合不能进入某个已知的危险区域。如果函数 $g$ 是凸函数，它同样定义了一个凸[可行域](@entry_id:136622)。

通过将这些约束纳入优化问题，MHE 保证了其产生的状态轨迹在物理上是可能的。然而，在实际应用中，一个严格执行硬约束的估计器可能会面临**可行性问题**。当存在较大的扰动、量测噪声或模型失配时，可能没有任何一条满足动态方程的轨迹能够同时满足所有状态和输入约束，导致可行集为空，优化问题无解。

一个标准且有效的解决方法是引入**[松弛变量](@entry_id:268374) (slack variables)** 。例如，可以将硬约束 $g(x_i, u_i) \le 0$ 放宽为 $g(x_i, u_i) \le s_i$，其中 $s_i \ge 0$ 是一个[松弛变量](@entry_id:268374)。同时，在[目标函数](@entry_id:267263)中增加一个对 $s_i$ 的惩罚项（例如，一个大的权重乘以 $s_i$ 或 $s_i^2$）。这种方法使得优化问题始终可行，因为总可以通过增大 $s_i$ 来满足约束。同时，由于对松弛量的惩罚，估计器仍然会尽量遵守原始约束。这在保持估计器鲁棒性的同时，极大地提高了其在现实世界中的可靠性。

### 核心原理二：[可观测性](@entry_id:152062)与[可辨识性](@entry_id:194150)

MHE 作为一个估计器，其性能的根本前提是系统的状态能够通过输出量测被推断出来。这一性质被称为**可观测性 (observability)**。对于 MHE 所依赖的有限窗口，我们关心的是**有限水平可观测性 (finite-horizon observability)** 。

对于一个给定的输入序列和[非线性系统](@entry_id:168347)，如果在窗口 $[t-N, t-1]$ 内，从初始状态 $x_{t-N}$到无噪声输出序列 $\hat{y}_{t-N:t-1}(x_{t-N})$ 的映射是**局部[单射](@entry_id:183792) (locally injective)** 的，那么系统就被认为是有限水平可观测的。这意味着在真实状态的一个邻域内，任何两个不同的初始状态都会产生不同的输出序列。

这一性质的数学表达可以通过**[灵敏度矩阵](@entry_id:1131475) (sensitivity matrix)** $S_N$ 来刻画。该矩阵定义为输出序列映射相对于初始状态的[雅可比矩阵](@entry_id:178326)：$S_N(x_{t-N}) \triangleq \frac{\partial \hat{y}_{t-N:t-1}(x_{t-N})}{\partial x_{t-N}}$。这是一个维度为 $(pN) \times n$ 的矩阵，其中 $p$ 是输出维度，$n$ 是状态维度。系统在 $x_{t-N}$ 处是局部可观测的，当且仅当 $S_N(x_{t-N})$ 是**列满秩 (full column rank)** 的。

[可观测性](@entry_id:152062)直接关系到 MHE 估计的**局部[可辨识性](@entry_id:194150) (local identifiability)**，即可行邻域内是否存在唯一的局部最优解。MHE 的目标函数本质上是一个加权[最小二乘问题](@entry_id:164198)。其高斯-牛顿 Hessian 矩阵（[目标函数](@entry_id:267263)二阶导数的近似）可以表示为 $H_{GN} \approx S_N^\top W S_N$，其中 $W$ 是由量测噪声协方差导出的正定加权矩阵。如果 $S_N$ 是列满秩的，那么 $H_{GN}$ 就是正定的。这保证了目标函数在解的邻域内是局部严格凸的，从而确保了局部最优[解的唯一性](@entry_id:143619) 。

更广泛地，一个“行为良好”的 MHE 问题应当是**适定的 (well-posed)**，即解存在、唯一且连续地依赖于输入数据（如量测值和先验）。这需要满足一系列[正则性条件](@entry_id:166962)：
1.  **存在性 (Existence)**：要求目标函数是**强制的 (coercive)**（即当决策变量趋于无穷时，[目标函数](@entry_id:267263)也趋于无穷），并且可行集是**闭的 (closed)**。强制性通常通过一个具有强制性的到达成本和对过程扰动的正定惩罚来实现，它保证了最优解不会“逃逸”到无穷远处。
2.  **唯一性 (Uniqueness)**：局部唯一性由前述的**强局部[可观测性](@entry_id:152062)**（即[灵敏度矩阵](@entry_id:1131475)列满秩）保证。
3.  **连续依赖性 (Continuous Dependence)**：这要求模型函数 $f$ 和 $h$ 是**连续的**，更强的条件如**局部利普希茨连续 (local Lipschitz continuity)** 提供了更好的鲁棒性保证，确保数据中的微小扰动只会导致解的微小变化。

综合来看，MHE 的理论基础建立在[可观测性](@entry_id:152062)之上，它确保了从数据中提取状态信息的可能性，而[适定性](@entry_id:148590)条件则为优化求解器的稳定运行提供了数学保障。

### MHE 的机制：实现与调优

将 MHE 从理论原理转化为实际可用的算法，涉及数值求解和关键参数的调优。

#### 数值求解：序列二次规划

[非线性](@entry_id:637147) MHE 问题是一个非凸的、约束化的优化问题，通常没有解析解。在实践中，它通过迭代的数值方法求解，其中最常用的是**序列二次规划 (Sequential Quadratic Programming, SQP)** 。

SQP 的核心思想是在当前迭代点，用一个更容易求解的二次规划 (Quadratic Program, QP) 子问题来近似原始的[非线性](@entry_id:637147)问题。在每次迭代中，SQP 执行以下步骤：
1.  **线性化约束**：将[非线性](@entry_id:637147)的动态约束 $x_{j+1} = f(x_j, u_j) + w_j$ 在当前的状态估计轨迹周围进行泰勒展开，得到一组线性（或仿射）[等式约束](@entry_id:175290)。
2.  **二次化[目标函数](@entry_id:267263)**：将原始的最小二乘[目标函数](@entry_id:267263)在当前点进行二阶[泰勒展开](@entry_id:145057)，形成一个二次型目标。对于[最小二乘问题](@entry_id:164198)，一个高效且广泛应用的近似是使用**高斯-牛顿 Hessian (Gauss-Newton Hessian)**。它通过忽略模型函数 $f$ 和 $h$ 的二阶导数项来简化 Hessian 矩阵，其形式为 $H_{GN} = J^\top W J$，其中 $J$ 是所有残差（到达成本、过程和量测残差）相对于所有决策变量的[雅可比矩阵](@entry_id:178326)，而 $W$ 是由 $P_0^{-1}, Q^{-1}, R^{-1}$ 构成的分块对角加权矩阵。这个近似在残差较小的情况下非常精确，并且保证了 Hessian 是半正定的，这对于优化算法的稳定性至关重要。

通过求解这个 QP 子问题，得到一个搜索方向和步长，用于更新状态和扰动的估计值。这个过程不断重复，直到满足[收敛准则](@entry_id:158093)。

#### 调优参数一：时间窗口长度 $N$

时间窗口长度 $N$ 是 MHE 最重要的设计参数之一，它直接影响估计性能和计算成本之间的权衡 。

*   **性能**：更长的 $N$ 意味着在每次优化中使用了更多的量测数据。对于一个**可观测且稳定**的系统，增加 $N$ 通常会带来更多的信息，有助于抑制噪声，从而提高估计精度。从数学上看，增加 $N$ 会使[可观测性矩阵](@entry_id:165052)的信息更加丰富，其条件数 $\kappa(S_N)$ 通常会改善并最终收敛到一个有限值，因为对于稳定系统，来自遥远过去的信息会自然衰减。然而，对于一个**不稳定**的系统，初始状态的影响会随时间[指数增长](@entry_id:141869)，增加 $N$ 可能会导致[灵敏度矩阵](@entry_id:1131475)的最大奇异值无界增长，从而恶化其[条件数](@entry_id:145150)，使得估计问题在数值上变得病态。

*   **计算成本**：$N$ 的增加直接导致优化问题维度的增长。决策变量的数量与 $N$ 成正比（约为 $n \times N$）。如果使用一个通用的**[稠密矩阵求解器](@entry_id:748301) (dense solver)** 来求解 SQP 子问题中的 KKT 系统，其计算复杂度将是 $O((nN)^3)$。然而，MHE 的 KKT 系统具有特殊的**块带状[稀疏结构](@entry_id:755138)**。通过利用这种结构，可以使用专门的**[稀疏求解器](@entry_id:755129) (sparse solver)**（如基于 Riccati 递归或[平滑算法](@entry_id:1131787)的方法），将每次迭代的计算复杂度降低到与 $N$ 呈线性关系，即 $O(Nn^3)$。尽管如此，计算负担仍然随 $N$ 线性增长。

因此，选择 $N$ 是一个权衡：它需要足够长以确保系统的可观测性并达到所需的估计精度，但又要足够短以满足实时计算的要求。

#### 调优参数二：加权矩阵 $P, Q, R$

加权矩阵 $P$ (到达成本)、$Q$ (过程噪声) 和 $R$ (量测噪声) 反映了我们对先验、模型和量测的相对信任程度。它们的正确选择对估计器的性能至关重要 。

*   **最优选择**：在一个[线性系统](@entry_id:147850)中，如果加权矩阵 $Q$ 和 $R$ 精确地等于真实噪声的协方差矩阵 $Q_{\text{true}}$ 和 $R_{\text{true}}$，并且到达成本正确地总结了[先验信息](@entry_id:753750)，那么 MHE (在足够长的窗口下) 会收敛到最优估计器（即卡尔曼滤波器），其估计是**无偏的 (unbiased)** 并且在所有线性估计器中具有**最小方差 (minimum variance)**。

*   **比例不变性**：在无约束的情况下，如果将 $Q$ 和 $R$ 同时乘以一个正常数 $\alpha > 0$，估计结果保持不变（对于足够长的 $N$）。这是因为优化问题寻找的是相对权重，整体缩放不改变最优解的位置。这意味着调优的关键在于确定 $Q$ 和 $R$ 的**相对大小**。

*   **偏置-方差权衡 (Bias-Variance Trade-off)**：当存在模型失配时（例如，未建模的恒定扰动或偏置 $\mu_w \neq 0$），$Q$ 和 $R$ 的选择就体现了一种偏置与方差的权衡。
    *   如果我们选择一个很小的 $Q$（即 $Q^{-1}$ 很大），相当于我们**高度信任动态模型**。估计器会倾向于忽略那些看起来像随机扰动但实际上是系统性漂移的信号，从而产生显著的**渐近偏置**。但由于其对噪声不敏感，估计的**方差**会较小。
    *   相反，如果我们选择一个较大的 $Q$，相当于我们**对模型持怀疑态度**，允许估计的状态轨迹偏离模型预测以更好地[匹配数](@entry_id:274175)据。这会使估计器能够跟踪未建模的漂移，从而**减小偏置**，但代价是估计结果会对真实的[过程噪声](@entry_id:270644)更加敏感，导致**方差增大** 。
    
因此，在实际应用中，调优 $Q$ 和 $R$ 常常是一个基于实验和经验的过程，旨在在抑制噪声（小方差）和跟踪真实系统行为（小偏置）之间找到一个满意的平衡点。

### 高级原理：到达成本、稳定性与鲁棒性

对于要求严苛的应用，MHE 的设计需要更深入的理论考量，尤其是在保证长期稳定性和应对非理想扰动方面。

#### 到达成本再探

到达成本不仅是总结过去信息的工具，它在 MHE 中扮演着更深远的角色。

*   **信息遗忘机制**：在某些应用中，我们希望估计器能够“忘记”非常陈旧的信息，以适应[时变系统](@entry_id:175653)。到达成本提供了一种实现**指数遗忘 (exponential forgetting)** 的机制。例如，如果假设信息的价值随时间以连续速率 $\rho$ 指数衰减，即 $\frac{dI(t)}{dt} = -\rho I(t)$，那么在一个[采样周期](@entry_id:265475) $\Delta t$ 内，信息将被乘以一个因子 $\exp(-\rho \Delta t)$。这与指数加权最小二乘 (EWLS) 中的**[遗忘因子](@entry_id:175644)** $\lambda$ 完全对应，即 $\lambda = \exp(-\rho \Delta t)$ 。通过这种方式，到达成本可以被设计为系统地对旧信息打折扣。

*   **稳定性基石**：更重要的是，到达成本是保证 MHE 估计误差**长期稳定**的关键。如果每次都简单地丢弃窗口外的数据（等同于设置到达成本为零），估计器可能会不稳定，因为没有任何机制阻止信息的丢失。

#### 鲁棒[渐近稳定性](@entry_id:149743)

MHE 估计误差 $e_k := x_k - \hat{x}_{k|k}$ 的稳定性是一个核心的理论问题。我们期望在有界扰动的影响下，[估计误差](@entry_id:263890)最终收敛到一个以零为中心的小邻域内；在没有扰动时，误差应收敛到零。这被称为**鲁棒[渐近稳定性](@entry_id:149743) (robust asymptotic stability)**。

要实现这一目标，需要三个关键要素的协同作用 ：
1.  **一致完全可观测性 (Uniform Complete Observability)**：这是对[可观测性](@entry_id:152062)属性的强化，要求系统在任何长度为 $N$ 的窗口内都能提供足够的信息来辨识状态。
2.  **增量稳定性 (Incremental Stability)**：系统本身需要具备一种内在的稳定性。具体而言，系统需要是**增量输入/输出到状态稳定 (incrementally input/output-to-state stable, i-IOSS)** 的。这意味着任意两个从不同初始状态出发但受相同输入和扰动驱动的轨迹，它们之间的差异会随时间收缩。
3.  **基于李雅普诺夫的到达成本 (Lyapunov-based Arrival Cost)**：到达成本的设计不能是任意的。它必须被精心构造，以作为估计误差的一个**[李雅普诺夫函数](@entry_id:273986) (Lyapunov function)**。在每个时间步，通过求解 MHE 优化问题获得的新信息所带来的[李雅普诺夫函数](@entry_id:273986)的减少量，必须能够补偿因滑动窗口而“忘记”旧信息所导致的[李雅普诺夫函数](@entry_id:273986)的增加量。只有当到达成本与系统的增量动力学特性紧密耦合时，才能保证整个闭环估计误差系统的稳定性。

#### [对异常值的鲁棒性](@entry_id:634485)

标准的 MHE 使用二次型成本函数（$L_2$ 范数），这在统计上对应于假设扰动服从高斯分布。然而，在许多实际系统中，传感器可能会产生**异常值 (outliers)** 或数据可能来自**重尾分布 (heavy-tailed distributions)**。在这种情况下，二次成本函数会给予大的残差（异常值）过大的权重，从而严重扭曲估计结果。

为了增强 MHE [对异常值的鲁棒性](@entry_id:634485)，可以将二次成本替换为**[鲁棒损失函数](@entry_id:634784) (robust loss function)** 。一个经典的选择是 **Huber 损失 (Huber loss)**，其定义为：
$$
\phi_\delta(z) = \begin{cases} \frac{1}{2}z^2, & |z|\le \delta \\ \delta\big(|z| - \frac{1}{2}\delta\big), & |z| > \delta \end{cases}
$$
其中 $\delta$ 是一个可调的阈值。Huber 损失的巧妙之处在于其**分段特性**：
*   对于小的残差（$|z| \le \delta$，被视为“[内点](@entry_id:270386)”），它是一个二次函数，保持了[最小二乘估计](@entry_id:262764)对高斯噪声的统计**高效性**和[数值优化](@entry_id:138060)的良好曲率特性。
*   对于大的残差（$|z| > \delta$，被视为“异常值”），它变为一个线性函数，其增长率远低于二次函数。这限制了异常值对总成本的贡献，从而实现了对异常值的**鲁棒性**。

通过将 Huber 损失应用于 MHE 目标函数中的过程和量测残差项，我们可以在不牺牲对正常数据的处理效率的前提下，显著提高估计器在面对非理想测量环境时的可靠性。