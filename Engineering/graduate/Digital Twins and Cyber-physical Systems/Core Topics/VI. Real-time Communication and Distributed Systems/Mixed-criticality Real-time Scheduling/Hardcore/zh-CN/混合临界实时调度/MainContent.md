## 引言
随着技术的发展，现代计算系统，尤其是网络物理系统（CPS）和[数字孪生](@entry_id:171650)（DT），正变得日益复杂。它们通常需要在共享的计算平台上集成多种功能，而这些功能具有截然不同的安全关键性——从直接关系到物理安全的飞行控制系统，到用于提升用户体验的信息娱乐系统。这种整合趋势带来了严峻的设计挑战：我们如何才能既满足最高安全等级功能所需的可认证性保证，又避免因过度保守的设计而导致宝贵的计算资源被大量浪费？

传统的[实时系统](@entry_id:754137)设计方法在应对这一挑战时显得力不从心，它往往要求为所有任务预留最坏情况下的资源，导致系统在绝大多数时间里处于低利用率状态。混合临界[实时调度](@entry_id:754136)（Mixed-criticality Real-time Scheduling）理论正是在这样的背景下应运而生，它为解决“可认证性”与“资源效率”之间的根本矛盾提供了一套创新的理论框架和工程方法。

为了全面掌握这一关键技术，本文将引导您深入探索混合临界调度的世界。我们将从以下三个层面逐步展开：
1.  在 **“原理与机制”** 一章中，我们将深入剖析其核心思想，包括混合临界任务模型、最坏情况执行时间（WCET）的多重估计原理，以及作为其灵魂机制的模式切换。
2.  接着，在 **“应用与跨学科连接”** 一章中，我们将视野拓宽，展示这些理论如何与[控制工程](@entry_id:149859)、[多核架构](@entry_id:752264)、时间敏感网络（TSN）及数字孪生等领域交叉融合，解决现实世界中的复杂工程问题。
3.  最后，在 **“动手实践”** 部分，您将有机会通过解决一系列精心设计的调度分析与设计问题，将理论知识转化为实践能力，巩固对混合临界系统设计的理解。

通过学习本章内容，您将能够理解并运用混合临界调度的核心概念，为设计和验证下一代安全、高效且可靠的复杂嵌入式系统奠定坚实的理论基础。

## 原理与机制

在上一章中，我们介绍了混合临界系统（Mixed-Criticality Systems, MCS）在现代网络物理系统（Cyber-Physical Systems, CPS）和数字孪生（Digital Twins, DT）中的重要性。这些系统需要在共享的计算平台上集成具有不同安全保证等级（assurance levels）的功能，从而引发了独特的调度与验证挑战。本章将深入探讨支持这些系统的核心原理与关键机制，为后续章节中具体的[调度算法](@entry_id:262670)与分析技术奠定理论基础。

我们将首先阐述混合临界调度的基本问题，即如何在保证最高安全标准的同时实现高效的资源利用。随后，我们将详细介绍混合临界任务模型，并着重解释其中最关键的概念——最坏情况执行时间（Worst-Case Execution Time, WCET）的多重估计。最后，我们将剖析实现混合临界语义的核心运行时机制，包括模式切换的触发、执行与恢复。

### 核心问题：在可认证性与效率之间寻求平衡

传统[实时系统](@entry_id:754137)的设计与验证遵循一种确定性的、静态的方法。系统中的每个任务 $\tau_i$ 都被赋予一个单一的、高度保守的WCET估计值 $C_i$。该值必须通过可认证的分析方法得出，以保证在任何可能的操作条件下，任务的实际执行时间都不会超过此界限。随后，调[度理论](@entry_id:636058)（如最早截止期优先（Earliest Deadline First, EDF）或[固定优先级调度](@entry_id:749439)）被用来证明，即使所有任务都达到其WCET，所有截止期也依然能够得到满足。这种方法的优点在于其简单性和可认证性：只要假设成立，系统的时序正确性就得到了保证。

然而，这种方法的代价是巨大的资源浪费。为了获得认证机构（如航空领域的[DO-178C](@entry_id:1123903)或汽车领域的[ISO 26262](@entry_id:1126786)）的信任，WCET分析必须考虑极其罕见甚至在物理上从未被观测到的“最坏情况”场景，例如最不利的缓存状态、流水线冲突和[总线争用](@entry_id:178145)组合。这导致WCET估计值远大于任务的平均或典型执行时间。当系统中所有任务都按其最坏情况WCET进行资源预留时，处理器在绝大多数时间里都处于严重未被充分利用的状态。

混合临界系统理论正是为了解决这一“可认证性”与“效率”之间的根本矛盾而提出的。其核心思想是：系统不应该被设计为永远承受所有任务同时发生最坏情况的极端场景，而是应该能够根据运行时观察到的实际行为，在不同的“保证等级”之间进行动态切换。

### 混合临界任务模型

为了形式化地描述这一思想，学术界提出了混合临界任务模型。在一个典型的双临界级（dual-criticality）系统中，任务被分为高临界级（High-Criticality, HI）和低临界级（Low-Criticality, LO）两类。一个任务 $\tau_i$ 通常由一个参数元组来描述，例如 $(\mathcal{C}_i^{\mathrm{LO}}, \mathcal{C}_i^{\mathrm{HI}}, T_i, D_i, L_i)$ 。

*   **$T_i$ (周期或最小到达间隔)**: 对于周期性任务，这是精确的激活周期；对于偶发任务（sporadic task），这是两次连续任务实例（jobs）激活之间的最小时间间隔。

*   **$D_i$ (相对截止期)**: 每个任务实例从其被激活的时刻起，必须在此时间窗内完成。我们区分**隐式截止期**（implicit-deadline, $D_i = T_i$）和**约束截止期**（constrained-deadline, $D_i \le T_i$）。这个区别至关重要，因为约束截止期会压缩任务必须完成的时间窗口，从而在短时间内产生更高的处理器需求密度。因此，对于包含约束截止期任务的系统，简单的基于利用率的调度可行性测试（如EDF的 $\sum (C_i/T_i) \le 1$）不再充分，必须采用更复杂的、基于区间需求的分析方法，如需求边界函数（demand bound function） 。

*   **$L_i$ (临界级别)**: 这是一个标签，表示任务所实现功能的关键性，例如 $L_i \in \{\mathrm{LO}, \mathrm{HI}\}$。该级别直接映射到行业安全标准所要求的保证等级。例如，一个实现飞行稳定控制的任务（如[DO-178C](@entry_id:1123903) Level A）将被标记为HI，而一个用于遥测数据聚合的任务则可能被标记为LO 。

*   **$\{C_i(\ell)\}$ (WCET向量)**: 这是混合临界模型的核心。每个任务不再只有一个WCET，而是与每个临界级别 $\ell$ 相关联的一个WCET估计值向量。在双临界系统中，这表现为两个值：$C_i^{\mathrm{LO}}$ 和 $C_i^{\mathrm{HI}}$。$C_i^{\mathrm{LO}}$ 是一个较为“乐观”的WCET估计，它基于较为常规的分析或大量的测试数据得出，能够覆盖绝大多数情况。而 $C_i^{\mathrm{HI}}$ 则是一个非常保守的WCET估计，它基于认证所要求的、极其悲观的[静态分析](@entry_id:755368)工具得出，旨在提供极高的置信度。对于一个被指定为LO临界级的任务 $\tau_j$，我们通常认为其没有高临界级的行为，因此可以形式化地将其 $C_j^{\mathrm{HI}}$ 视为未定义或等于 $C_j^{\mathrm{LO}}$ 。

### WCET单调性原理及其依据

混合临界模型的一个基石是 **WCET[单调性](@entry_id:143760)原理**：对于任何一个任务 $\tau_i$，其在高保证等级下的WCET估计值必须大于或等于在低保证等级下的估计值。对于双临界系统，这意味着 $C_i^{\mathrm{HI}} \ge C_i^{\mathrm{LO}}$。这一原理并非随意设定，而是源于对“保证”和“证据”的深刻理解。

#### 形式化与认识论依据

从形式化角度看，WCET可以定义为在一组给定的执行环境与假设 $\mathcal{A}_i^\alpha$ 下，所有可能执行场景 $\mathcal{X}_i^\alpha$ 中，执行时间函数 $T_i(x)$ 的[上确界](@entry_id:140512)（supremum）。
$$ C_i^{\alpha} = \sup_{x \in \mathcal{X}_i^{\alpha}} T_i(x) $$
一个更高等级的保证（HI）意味着需要考虑一个更广泛、更具对抗性的场景集合。例如，HI级别的分析可能需要考虑更频繁的硬件瞬时故障、更复杂的缓存干扰模式等。因此，用于HI级别分析的场景集合 $\mathcal{X}_i^{\mathrm{HI}}$ 必然是用于LO级别分析的场景集合 $\mathcal{X}_i^{\mathrm{LO}}$ 的一个超集，即 $\mathcal{X}_i^{\mathrm{LO}} \subseteq \mathcal{X}_i^{\mathrm{HI}}$。根据数学中[上确界](@entry_id:140512)的基本性质，在一个更大集合上求得的[上确界](@entry_id:140512)绝不会小于在一个子集上求得的[上确界](@entry_id:140512)。由此，我们直接推导出 $C_i^{\mathrm{HI}} \ge C_i^{\mathrm{LO}}$。

从证据和[置信度](@entry_id:267904)的角度来看，这一原理同样坚实。$C_i^{\mathrm{LO}}$ 可能基于数百万次的测试运行，通过统计方法（如[极值理论](@entry_id:140083)）得出一个置信度较高的上界。然而，对于最高安全级别的认证，单纯的测试被认为是不充分的，因为它无法穷尽所有可能的状态。例如，假设认证要求我们有 $0.99$ 的[置信度](@entry_id:267904)相信，每个任务实例的执行时间超过 $C_i^{\mathrm{HI}}$ 的概率不大于 $\varepsilon = 10^{-6}$。如果我们进行了 $n=1000$ 次独立的压力测试，并且观察到的最大执行时间为 $\hat{B}$，我们能否就此设定 $C_i^{\mathrm{HI}} = \hat{B}$ 呢？答案是否定的。将“执行时间超限”建模为一个发生概率为 $p$ 的[伯努利试验](@entry_id:268355)，在 $n=1000$ 次试验中观察到0次超限，我们可以计算出 $p$ 的单侧置信上限。在 $0.99$ 的置信度下，这个上限约为 $4.6 \times 10^{-3}$，比要求的 $10^{-6}$ 高出好几个数量级 。这深刻地揭示了，要通过经验证据来支撑如此之高的保证要求，需要海量的测试数据（在此例中约为数百万次）。因此，更现实的做法是采用提供形式化证明的[静态分析](@entry_id:755368)工具，而这些工具为了保证其结论的绝对可靠性，必然会做出非常保守的假设，从而产生一个远大于经验观察值的 $C_i^{\mathrm{HI}}$。

综上所述，$C_i^{\mathrm{LO}}$ 和 $C_i^{\mathrm{HI}}$ 并不仅仅是两个随意的数字，它们代表了基于不同证据基础和置信度水平的、关于任务行为的不同断言 。即便在某些情况下，可用的证据使得 $C_i^{\mathrm{LO}}$ 和 $C_i^{\mathrm{HI}}$ 的数值相等，模型在概念上仍然将它们区分为两个独立的实体，因为它们在系统的不同运行模式下扮演着不同的角色 。

### 核心机制：模式切换

拥有了多重WCET估计的任务模型后，混合临界调度的核心机制——**模式切换（Mode Switch）**——便应运而生。这正是它与传统[实时调度](@entry_id:754136)的根本区别，后者只有一个固定的、静态的操作模式 。

#### L[O模](@entry_id:1129014)式：标称运行

系统默认在 **LO模式** 下运行。在此模式下，调度器做出一个“乐观”的假设：所有任务（无论是HI还是LO）的每个实例都将在其 $C_i^{\mathrm{LO}}$ 预算内完成。调度器的责任是保证，在这一假设下，**所有任务** 都能满足各自的截止期。[系统设计](@entry_id:755777)时必须通过离线分析来验证L[O模](@entry_id:1129014)式的可行性。例如，对于一个使用EDF调度的隐式截止期任务集，需要验证 $\sum_{\tau_i \in \mathrm{HI} \cup \mathrm{LO}} (C_i^{\mathrm{LO}}/T_i) \le 1$。

#### 模式切换的触发与监控

L[O模](@entry_id:1129014)式的乐观假设可能会在运行时被打破。模式切换的 **触发条件** 是：一个HI临界级的任务实例，在执行了 $C_i^{\mathrm{LO}}$ 的处理器时间后，仍未完成。

为了精确地捕捉这一事件，系统必须实现一个可靠的 **[运行时监控](@entry_id:1131150)机制**。这个机制必须：
1.  **准确计量执行时间**：监控器必须跟踪每个任务实例实际消耗的处理器时间，而不是简单的墙上时钟时间（wall-clock time），因为任务在被抢占时并不消耗处理器资源。
2.  **即时触发**：当一个HI任务的累计执行时间恰好达到 $C_i^{\mathrm{LO}}$ 时，必须**立即**发出模式切换信号，并且在该任务执行任何下一条指令**之前**，系统必须完成模式的切换。

满足这一严格安全要求的理想实现是一种**事件驱动的、基于每个任务实例的执行时间预算监控器**。当一个HI任务被调度执行时，[操作系统内核](@entry_id:752950)会为其设置一个等于其剩余 $C_i^{\mathrm{LO}}$ 预算的执行时间定时器（可以通过高精度硬件性能计数器实现）。如果任务在该预算耗尽前完成或被抢占，定时器会被更新或取消。如果定时器到期，它会产生一个同步异常或中断，将控制权交还给内核。内核此时立即执行模式切换逻辑，例如挂起所有LO任务。这种机制确保了模式切换的即时性和安全性，防止系统进入一种“HI任务需要HI资源，但系统仍在LO模式运行”的[不安全状态](@entry_id:756344) 。

#### HI模式：应急运行

一旦切换到 **HI模式**，系统的保证契约发生根本性改变。调度器不再对LO临界任务的截止期负责，它们可能会被立即挂起、中止或[服务质量](@entry_id:753918)被大幅降低。系统的唯一目标是保证**所有HI临界任务**的截止期，此时的假设是这些任务的执行时间可能高达其 $C_i^{\mathrm{HI}}$。

**为何必须牺牲LO任务？** 这不是一个随意的策略，而是保证HI任务可调度性的数学必然。考虑一个具体的例子 ：
*   HI任务 $\tau_1$: $T_1=20, C_1^{\mathrm{LO}}=5, C_1^{\mathrm{HI}}=9$
*   HI任务 $\tau_2$: $T_2=25, C_2^{\mathrm{LO}}=6, C_2^{\mathrm{HI}}=10$
*   LO任务 $\tau_3$: $T_3=10, C_3^{\mathrm{LO}}=2$
*   LO任务 $\tau_4$: $T_4=20, C_4^{\mathrm{LO}}=3$

在LO模式下，总利用率为 $(\frac{5}{20}+\frac{6}{25}) + (\frac{2}{10}+\frac{3}{20}) = 0.49 + 0.35 = 0.84 \le 1$，系统在EDF下是可调度的。
现在假设系统进入HI模式。HI任务的利用率变为 $U_{\mathrm{HI}}^{\mathrm{HI}} = \frac{9}{20} + \frac{10}{25} = 0.45 + 0.40 = 0.85$。如果此时我们继续允许LO任务运行，系统的总需求利用率将飙升至 $0.85 + 0.35 = 1.20$。这个值大于1，意味着处理器已经过载，在EDF下必然会出现截止期错失。为了保证HI任务的截止期（这是认证要求），唯一的办法就是削减负载。由于HI任务的需求是不可协商的，只能通过挂起LO任务来释放处理器资源。挂起LO任务后，系统负载降至 $0.85$，重新变得可调度。因此，牺牲LO任务是维持HI任务可调度性和满足认证要求的直接后果 。

### 高级机制与调度策略

上述的模式切换是混合临界调度的基础。在此之上，研究者们还发展了更精巧的机制来进一步提升系统性能和鲁棒性。

#### 为模式切换做准备：虚拟截止期

在L[O模](@entry_id:1129014)式下，调度器可以主动为潜在的HI模式做准备。一种有效的技术是**虚拟截止期（Virtual Deadlines）**，这是EDF-VD等算法的核心思想 。在L[O模](@entry_id:1129014)式中，可以为HI临界任务 $\tau_i$ 设置一个比其实际截止期 $D_i$ 更短的虚拟截止期 $D_i^{\mathrm{virt}} = x \cdot D_i$（其中 $0  x  1$）。在EDF调度策略下，更短的截止期意味着更高的优先级。这会迫使HI任务在L[O模](@entry_id:1129014)式下更早地执行，从而为其执行“预留”出一个时间缓冲。当模式切换发生时，即使该任务需要额外的执行时间（从 $C_i^{\mathrm{LO}}$ 增长到 $C_i^{\mathrm{HI}}$），这个预留出的缓冲也能帮助其在**实际的**、未改变的截止期 $D_i$ 之前完成。反之，如果在L[O模](@entry_id:1129014)式下延长HI任务的截止期，则会使其推迟执行，从而在模式切换后留下更少的时间来应对突增的执行需求，这是极其危险的。

#### 从HI模式恢复

系统不能永远停留在效率低下的HI模式。因此，一个安全有效的**恢复协议**是必不可少的。从HI模式返回LO模式的关键挑战在于，要确保过去由超限运行所引发的“时间债”已经还清，不会对未来的HI[任务调度](@entry_id:268244)产生影响。

一个被广泛接受的、安全的恢复触发条件是等待系统达到一个**“HI空闲”时刻**（HI-idle instant）。这个时刻定义为：自模式切换以来，处理器首次出现没有待处理的HI任务（即所有已激活的HI任务均已完成）的时刻 。在这个时刻，HI任务集的状态与过去的历史无关，系统可以认为是从一个“干净”的状态重新开始。

然而，达到HI空闲时刻后直接恢复到完全的L[O模](@entry_id:1129014)式可能仍然是冒进的，因为导致第一次超限的根本原因（例如，系统过热）可能依然存在。一个更稳健的恢复协议通常包含以下步骤 ：
1.  **等待HI空闲**：等待第一个HI空闲时刻 $t_r$ 的到来。
2.  **悲观重入**：在 $t_r$ 时刻，可以考虑重新接纳LO任务。但此时的可行性分析必须是悲观的：假设HI任务仍然可能需要 $C_i^{\mathrm{HI}}$ 的执行时间。只有在满足此悲观假设下的可调度性条件（例如，使用需求边界函数进行验证）后，才能允许部分或全部LO任务恢复执行。
3.  **设置观察期**：在悲观重入模式下运行一段时间，并持续监控HI任务的实际执行时间。如果在一个预设的“观察期”内，所有HI任务都表现良好（即执行时间未超过 $C_i^{\mathrm{LO}}$），系统才最终恢复到完全的、乐观的L[O模](@entry_id:1129014)式。

通过这一系列精巧的原理与机制，混合临界调度成功地在满足严苛安全认证要求与实现高效处理器资源利用之间搭建了一座桥梁，为构建复杂而可靠的现代CPS与[数字孪生](@entry_id:171650)系统提供了坚实的理论基础。