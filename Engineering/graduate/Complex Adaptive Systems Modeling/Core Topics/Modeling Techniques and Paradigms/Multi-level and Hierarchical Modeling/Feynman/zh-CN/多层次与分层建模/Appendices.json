{
    "hands_on_practices": [
        {
            "introduction": "本练习旨在揭示分析复杂系统时的一个基本挑战：数据聚合可能会掩盖甚至逆转潜在的趋势。通过一个具体的辛普森悖论  实例，你将亲眼见证在各个子群组内部观察到的关联，在数据合并后是如何消失甚至反转的。本练习旨在为你建立一个坚实的直觉：多层次模型不仅仅是一种技术上的优化，更是从结构化数据中获得可靠科学见解的关键工具。",
            "id": "4131281",
            "problem": "考虑一个复杂的自适应系统，该系统由两个相互作用的子系统组成，分别标记为 $L$ 组和 $H$ 组。每个子系统都由代理组成，代理在组 $g \\in \\{L, H\\}$ 内由 $i$ 索引。对于每个代理，我们观察到一个个体层面的预测变量 $x_{ig}$ 和一个结果 $y_{ig}$。记录了以下数据集：\n- $L$ 组：对于 $i \\in \\{1, 2, 3\\}$，$(x_{iL}, y_{iL})$ 分别等于 $(1, 9)$, $(2, 7)$ 和 $(3, 5)$。\n- $H$ 组：对于 $i \\in \\{1, 2, 3\\}$，$(x_{iH}, y_{iH})$ 分别等于 $(8, 20)$, $(9, 18)$ 和 $(10, 16)$。\n\n将每个组视为具有不同基线属性的子系统，并将 $x_{ig}$ 和 $y_{ig}$ 之间的组内关系解释为微观层面的效应。聚合关系忽略了组成员身份，并将两组中的所有代理汇集到单个数据集中，代表了宏观层面的效应。\n\n使用线性关联的基本定义，确定 $y_{ig}$ 对 $x_{ig}$ 的组内回归的普通最小二乘斜率的符号（假设各组间的符号相同），以及在忽略组成员身份时 $y$ 对 $x$ 的聚合回归的普通最小二乘斜率的符号。哪个选项正确地报告了这两个符号？\n\nA. 组内斜率为负；聚合斜率为正。\n\nB. 组内斜率为正；聚合斜率为负。\n\nC. 组内斜率和聚合斜率均为负。\n\nD. 组内斜率和聚合斜率均为正。",
            "solution": "该问题要求在一个分层系统的两个不同层面上分析线性关联：组内（微观）层面和聚合（宏观）层面。由普通最小二乘（OLS）回归确定的线性关联的符号，取决于预测变量和结果变量之间样本协方差的符号。\n\n$y$ 对 $x$ 回归的 OLS 斜率系数 $\\beta$ 的公式如下：\n$$ \\beta = \\frac{\\text{Cov}(x, y)}{\\text{Var}(x)} = \\frac{\\sum_{i=1}^n (x_i - \\bar{x})(y_i - \\bar{y})}{\\sum_{i=1}^n (x_i - \\bar{x})^2} $$\n由于分母中的方差 $\\text{Var}(x)$ 是平方和，它总是非负的（对于非恒定的 $x$ 则是严格为正）。因此，斜率 $\\beta$ 的符号完全由样本协方差 $\\text{Cov}(x, y)$ 的符号决定。\n\n首先，我们将验证问题陈述。\n\n### 第1步：提取已知信息\n- 系统：一个包含两个子系统（$L$ 组和 $H$ 组）的复杂自适应系统。\n- 组：$g \\in \\{L, H\\}$。\n- 代理索引：$i$。\n- 个体层面预测变量：$x_{ig}$。\n- 个体层面结果：$y_{ig}$。\n- $L$ 组数据集：对于 $i \\in \\{1, 2, 3\\}$，$(x_{iL}, y_{iL})$ 分别为 $(1, 9)$, $(2, 7)$ 和 $(3, 5)$。\n- $H$ 组数据集：对于 $i \\in \\{1, 2, 3\\}$，$(x_{iH}, y_{iH})$ 分别为 $(8, 20)$, $(9, 18)$ 和 $(10, 16)$。\n- 微观层面效应：$x_{ig}$ 和 $y_{ig}$ 之间的组内关系。\n- 宏观层面效应：当所有代理被汇集时的聚合关系。\n- 任务：确定组内回归（假设符号相同）和聚合回归的 OLS 斜率符号。\n\n### 第2步：使用提取的已知信息进行验证\n该问题在科学上基于统计学，特别是在多层次模型和被称为辛普森悖论的现象的背景下。OLS 回归、协方差和聚合等概念是明确定义的数学和统计学原理。问题提法很严谨，提供了计算所需量的所有必要数据。语言客观而精确。数据内部一致，不违反任何数学或逻辑原理。该问题是统计学中一个标准的、可形式化的练习。\n\n### 第3步：结论与行动\n问题陈述有效。我们继续进行求解。\n\n### 斜率的推导\n\n**1. 组内斜率（微观层面）**\n\n我们将确定每个组的协方差符号。\n\n**对于 L 组：**\n数据点为 $(1, 9)$, $(2, 7)$, $(3, 5)$。\n样本均值为：\n$$ \\bar{x}_L = \\frac{1+2+3}{3} = \\frac{6}{3} = 2 $$\n$$ \\bar{y}_L = \\frac{9+7+5}{3} = \\frac{21}{3} = 7 $$\n协方差的分子是 $\\sum_{i=1}^3 (x_{iL} - \\bar{x}_L)(y_{iL} - \\bar{y}_L)$：\n$$ (1-2)(9-7) + (2-2)(7-7) + (3-2)(5-7) $$\n$$ = (-1)(2) + (0)(0) + (1)(-2) $$\n$$ = -2 + 0 - 2 = -4 $$\n由于协方差为负（$-4$），$L$ 组回归线的斜率为**负**。\n\n**对于 H 组：**\n数据点为 $(8, 20)$, $(9, 18)$, $(10, 16)$。\n样本均值为：\n$$ \\bar{x}_H = \\frac{8+9+10}{3} = \\frac{27}{3} = 9 $$\n$$ \\bar{y}_H = \\frac{20+18+16}{3} = \\frac{54}{3} = 18 $$\n协方差的分子是 $\\sum_{i=1}^3 (x_{iH} - \\bar{x}_H)(y_{iH} - \\bar{y}_H)$：\n$$ (8-9)(20-18) + (9-9)(18-18) + (10-9)(16-18) $$\n$$ = (-1)(2) + (0)(0) + (1)(-2) $$\n$$ = -2 + 0 - 2 = -4 $$\n由于协方差为负（$-4$），$H$ 组回归线的斜率也为**负**。\n组内斜率符号相同的假设成立，且这个共同的符号为负。\n\n**2. 聚合斜率（宏观层面）**\n\n我们汇集所有 $6$ 个数据点：$(1, 9)$, $(2, 7)$, $(3, 5)$, $(8, 20)$, $(9, 18)$, $(10, 16)$。\n聚合数据的样本均值为：\n$$ \\bar{x}_{agg} = \\frac{1+2+3+8+9+10}{6} = \\frac{33}{6} = 5.5 $$\n$$ \\bar{y}_{agg} = \\frac{9+7+5+20+18+16}{6} = \\frac{75}{6} = 12.5 $$\n聚合数据的协方差分子为 $\\sum_{i} (x_i - \\bar{x}_{agg})(y_i - \\bar{y}_{agg})$：\n- 对于 $L$ 组的点：\n  - $(1 - 5.5)(9 - 12.5) = (-4.5)(-3.5) = 15.75$\n  - $(2 - 5.5)(7 - 12.5) = (-3.5)(-5.5) = 19.25$\n  - $(3 - 5.5)(5 - 12.5) = (-2.5)(-7.5) = 18.75$\n- 对于 $H$ 组的点：\n  - $(8 - 5.5)(20 - 12.5) = (2.5)(7.5) = 18.75$\n  - $(9 - 5.5)(18 - 12.5) = (3.5)(5.5) = 19.25$\n  - $(10 - 5.5)(16 - 12.5) = (4.5)(3.5) = 15.75$\n\n这些乘积的总和是：\n$$ 15.75 + 19.25 + 18.75 + 18.75 + 19.25 + 15.75 = 107.5 $$\n由于协方差为正（$107.5$），聚合数据回归线的斜率为**正**。\n\n当数据聚合时，关联符号发生逆转，这是辛普森悖论的一个经典例子。\n\n### 逐项分析\n\n- **A. 组内斜率为负；聚合斜率为正。**\n  我们的计算表明，共同的组内斜率为负，聚合斜率为正。该陈述与我们的发现一致。\n  **结论：正确。**\n\n- **B. 组内斜率为正；聚合斜率为负。**\n  该陈述在两方面都与我们的发现相矛盾。组内斜率为负，不是正；聚合斜率为正，不是负。\n  **结论：不正确。**\n\n- **C. 组内斜率和聚合斜率均为负。**\n  该陈述正确地指出了组内斜率为负，但错误地声称聚合斜率也为负。我们的计算表明聚合斜率为正。\n  **结论：不正确。**\n\n- **D. 组内斜率和聚合斜率均为正。**\n  该陈述错误地声称组内斜率为正。我们的计算表明其为负。\n  **结论：不正确。**\n\n唯一正确报告了两个斜率符号的选项是 A。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在理解了*为何*需要层级模型之后，我们现在转向它们在数学上*如何*运作。这些模型的核心魅力在于“信息共享”，即每个群组的参数估计会从整体分布和自身数据中“借力”。本练习  将引导你完成一个群组参数后验分布的基础推导，揭示这种“部分池化”（partial pooling）的精确机制，并巩固你对驱动层级推断的贝叶斯引擎的理解。",
            "id": "4131271",
            "problem": "考虑一个用于分组观测的贝叶斯双层分层模型。对于由 $j \\in \\{1,\\dots,J\\}$ 索引的组，以及组 $j$ 内由 $i \\in \\{1,\\dots,n_j\\}$ 索引的观测值，假设在给定组参数的情况下观测值 $i$ 之间条件独立，并在给定超参数的情况下各组之间独立。数据模型（似然）为 $y_{ij} \\mid \\theta_j, \\sigma^2 \\sim \\mathcal{N}(\\theta_j,\\sigma^2)$，组级先验为 $\\theta_j \\mid \\mu,\\tau^2 \\sim \\mathcal{N}(\\mu,\\tau^2)$。令超参数表示为 $\\phi \\equiv (\\mu,\\tau^2,\\sigma^2)$，假设 $\\sigma^2 > 0$ 和 $\\tau^2 > 0$ 已知，并令 $y \\equiv \\{y_{ij}: j \\in \\{1,\\dots,J\\}, i \\in \\{1,\\dots,n_j\\}\\}$ 表示完整数据集。对于一个固定但任意的组 $j$，令 $n_j$ 为组 $j$ 的样本量，并定义组内样本均值 $\\bar{y}_j \\equiv \\frac{1}{n_j}\\sum_{i=1}^{n_j} y_{ij}$。\n\n仅从贝叶斯定理和高斯概率密度函数 (pdf) 的定义出发，推导全条件后验密度 $p(\\theta_j \\mid y,\\phi)$，并计算其后验均值和后验方差，以 $(\\mu,\\tau^2,\\sigma^2,n_j,\\bar{y}_j)$ 的闭式解析表达式形式给出。你的推导必须明确且自洽，展示后验核是如何从似然和先验中获得的，以及如何将其配方成一个高斯概率密度函数。不允许使用任何预先编译的共轭公式。\n\n将你的最终答案以由 $\\theta_j \\mid y,\\phi$ 的后验均值和后验方差组成的数对形式提供。不需要进行数值计算或四舍五入，你的最终表达式必须是精确的。不要包含任何单位。",
            "solution": "目标是推导特定组 $j$ 的全条件后验密度 $p(\\theta_j \\mid y, \\phi)$，并求出其均值和方差。推导将从贝叶斯定理和高斯概率密度函数的定义开始。\n\n根据贝叶斯定理，$\\theta_j$ 的后验概率密度与似然和先验的乘积成正比：\n$$p(\\theta_j \\mid y, \\phi) \\propto p(y \\mid \\theta_j, \\phi) p(\\theta_j \\mid \\phi)$$\n超参数向量 $\\phi$ 被给定为 $(\\mu, \\tau^2, \\sigma^2)$。问题陈述了在给定超参数的情况下，各组间的观测是条件独立的。这意味着完整似然 $p(y \\mid \\theta_1, \\dots, \\theta_J, \\phi)$ 可以分解。更具体地说，对于 $\\theta_j$ 的条件后验，一旦超参数 $\\phi$ 已知，来自其他组 $k \\neq j$ 的数据不会提供关于 $\\theta_j$ 的额外信息。模型结构是 $y_{ik} \\to \\theta_k \\to \\phi$。从 $y_{ik}$ ($k \\neq j$) 到 $\\theta_j$ 的路径被 $\\phi$ 阻断。因此，$\\theta_j$ 的后验只依赖于其自身组的数据，即 $y_j = \\{y_{ij} : i=1, \\dots, n_j\\}$。\n$$p(\\theta_j \\mid y, \\phi) = p(\\theta_j \\mid y_j, \\phi)$$\n$\\theta_j$ 的先验被直接指定为 $p(\\theta_j \\mid \\mu, \\tau^2)$，它是 $p(\\theta_j \\mid \\phi)$ 的一个组成部分。因此，后验由下式给出：\n$$p(\\theta_j \\mid y_j, \\phi) \\propto p(y_j \\mid \\theta_j, \\sigma^2) p(\\theta_j \\mid \\mu, \\tau^2)$$\n这里，$p(y_j \\mid \\theta_j, \\sigma^2)$ 是组 $j$ 的似然，$p(\\theta_j \\mid \\mu, \\tau^2)$ 是 $\\theta_j$ 的先验。\n\n对于一个随机变量 $X \\sim \\mathcal{N}(m, v)$，其高斯概率密度函数 (pdf) 由 $f(x) = (2\\pi v)^{-1/2} \\exp\\left(-\\frac{(x-m)^2}{2v}\\right)$ 给出。\n\n首先，我们写出似然项。观测值 $y_{ij}$ 在给定 $\\theta_j$ 的情况下是条件独立的，所以组 $j$ 的似然是各个密度的乘积：\n$$p(y_j \\mid \\theta_j, \\sigma^2) = \\prod_{i=1}^{n_j} p(y_{ij} \\mid \\theta_j, \\sigma^2) = \\prod_{i=1}^{n_j} \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y_{ij}-\\theta_j)^2}{2\\sigma^2}\\right)$$\n我们可以将乘积合并成一个单一的指数函数：\n$$p(y_j \\mid \\theta_j, \\sigma^2) = (2\\pi\\sigma^2)^{-n_j/2} \\exp\\left(-\\frac{1}{2\\sigma^2} \\sum_{i=1}^{n_j} (y_{ij}-\\theta_j)^2\\right)$$\n作为 $\\theta_j$ 的函数，似然的核为：\n$$p(y_j \\mid \\theta_j, \\sigma^2) \\propto \\exp\\left(-\\frac{1}{2\\sigma^2} \\sum_{i=1}^{n_j} (y_{ij}-\\theta_j)^2\\right)$$\n\n其次，我们写出先验项。$\\theta_j$ 的先验被给定为 $\\theta_j \\mid \\mu,\\tau^2 \\sim \\mathcal{N}(\\mu, \\tau^2)$。其概率密度函数为：\n$$p(\\theta_j \\mid \\mu, \\tau^2) = \\frac{1}{\\sqrt{2\\pi\\tau^2}} \\exp\\left(-\\frac{(\\theta_j-\\mu)^2}{2\\tau^2}\\right)$$\n作为 $\\theta_j$ 的函数，先验的核为：\n$$p(\\theta_j \\mid \\mu, \\tau^2) \\propto \\exp\\left(-\\frac{(\\theta_j-\\mu)^2}{2\\tau^2}\\right)$$\n\n现在，我们将似然的核与先验的核相乘，以找到后验的核：\n$$p(\\theta_j \\mid y_j, \\phi) \\propto \\exp\\left(-\\frac{1}{2\\sigma^2} \\sum_{i=1}^{n_j} (y_{ij}-\\theta_j)^2\\right) \\exp\\left(-\\frac{(\\theta_j-\\mu)^2}{2\\tau^2}\\right)$$\n$$p(\\theta_j \\mid y_j, \\phi) \\propto \\exp\\left( -\\frac{1}{2} \\left[ \\frac{1}{\\sigma^2}\\sum_{i=1}^{n_j} (y_{ij}-\\theta_j)^2 + \\frac{1}{\\tau^2}(\\theta_j-\\mu)^2 \\right] \\right)$$\n\n为了确定这个后验密度的形式，我们检查指数中的表达式，我们将其表示为 $Q(\\theta_j)$：\n$$Q(\\theta_j) = \\frac{1}{\\sigma^2}\\sum_{i=1}^{n_j} (y_{ij}^2 - 2y_{ij}\\theta_j + \\theta_j^2) + \\frac{1}{\\tau^2}(\\theta_j^2 - 2\\mu\\theta_j + \\mu^2)$$\n我们按 $\\theta_j$ 的幂次对各项进行分组。不依赖于 $\\theta_j$ 的项可以被吸收到比例常数中。\n$$Q(\\theta_j) = \\frac{1}{\\sigma^2}(n_j\\theta_j^2 - 2\\theta_j \\sum_{i=1}^{n_j} y_{ij}) + \\frac{1}{\\tau^2}(\\theta_j^2 - 2\\mu\\theta_j) + \\text{constant}$$\n使用样本均值的定义 $\\bar{y}_j = \\frac{1}{n_j}\\sum_{i=1}^{n_j} y_{ij}$，我们有 $\\sum_{i=1}^{n_j} y_{ij} = n_j\\bar{y}_j$。\n$$Q(\\theta_j) = \\frac{1}{\\sigma^2}(n_j\\theta_j^2 - 2n_j\\bar{y}_j\\theta_j) + \\frac{1}{\\tau^2}(\\theta_j^2 - 2\\mu\\theta_j) + \\text{constant}$$\n收集 $\\theta_j^2$ 和 $\\theta_j$ 的系数：\n$$Q(\\theta_j) = \\theta_j^2 \\left(\\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2}\\right) - 2\\theta_j \\left(\\frac{n_j\\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}\\right) + \\text{constant}$$\n这是一个关于 $\\theta_j$ 的二次函数。因此，后验密度是高斯的。为了找到其参数，我们进行配方。一个高斯密度 $\\mathcal{N}(\\mu_{\\text{post}}, \\sigma^2_{\\text{post}})$ 的核与 $\\exp\\left(-\\frac{(\\theta_j - \\mu_{\\text{post}})^2}{2\\sigma^2_{\\text{post}}}\\right)$ 成正比。指数部分是 $-\\frac{1}{2\\sigma^2_{\\text{post}}}(\\theta_j^2 - 2\\mu_{\\text{post}}\\theta_j + \\mu_{\\text{post}}^2)$。我们的后验核与 $\\exp\\left(-\\frac{1}{2}Q(\\theta_j)\\right)$ 成正比。\n\n比较各项，我们将 $-\\frac{1}{2}Q(\\theta_j)$ 中 $\\theta_j^2$ 的系数与 $-\\frac{1}{2\\sigma^2_{\\text{post}}}$ 进行匹配：\n$$\\frac{1}{\\sigma^2_{\\text{post}}} = \\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2}$$\n这就确定了后验精度（方差的倒数）。后验方差，我们称之为 $V_{\\text{post}}$，是：\n$$V_{\\text{post}} = \\sigma^2_{\\text{post}} = \\left(\\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1} = \\frac{1}{\\frac{n_j\\tau^2 + \\sigma^2}{\\sigma^2\\tau^2}} = \\frac{\\sigma^2\\tau^2}{n_j\\tau^2 + \\sigma^2}$$\n\n接下来，我们将 $-\\frac{1}{2}Q(\\theta_j)$ 中 $\\theta_j$ 的系数与 $\\frac{\\mu_{\\text{post}}}{\\sigma^2_{\\text{post}}}$ 进行匹配：\n$$\\frac{\\mu_{\\text{post}}}{\\sigma^2_{\\text{post}}} = \\frac{n_j\\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}$$\n后验均值，我们称之为 $M_{\\text{post}}$，是：\n$$M_{\\text{post}} = \\mu_{\\text{post}} = \\sigma^2_{\\text{post}} \\left(\\frac{n_j\\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}\\right) = \\left(\\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2}\\right)^{-1} \\left(\\frac{n_j\\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}\\right)$$\n代入后验精度的倒数表达式：\n$$M_{\\text{post}} = \\frac{\\frac{n_j\\bar{y}_j}{\\sigma^2} + \\frac{\\mu}{\\tau^2}}{\\frac{n_j}{\\sigma^2} + \\frac{1}{\\tau^2}}$$\n为了简化，将分子和分母同乘以 $\\sigma^2\\tau^2$：\n$$M_{\\text{post}} = \\frac{(n_j\\bar{y}_j/\\sigma^2)(\\sigma^2\\tau^2) + (\\mu/\\tau^2)(\\sigma^2\\tau^2)}{(n_j/\\sigma^2)(\\sigma^2\\tau^2) + (1/\\tau^2)(\\sigma^2\\tau^2)} = \\frac{n_j\\bar{y}_j\\tau^2 + \\mu\\sigma^2}{n_j\\tau^2 + \\sigma^2}$$\n推导表明，后验分布 $p(\\theta_j \\mid y, \\phi)$ 是一个高斯分布，即 $\\mathcal{N}(M_{\\text{post}}, V_{\\text{post}})$。\n\n后验均值 $M_{\\text{post}}$ 是样本均值 $\\bar{y}_j$ 和先验均值 $\\mu$ 的加权平均，权重由它们各自的精度决定。后验方差 $V_{\\text{post}}$ 是数据精度和先验精度之和的倒数。\n\n推导出的后验均值和后验方差的表达式为：\n后验均值：$M_{\\text{post}} = \\frac{n_j\\bar{y}_j\\tau^2 + \\mu\\sigma^2}{n_j\\tau^2 + \\sigma^2}$\n后验方差：$V_{\\text{post}} = \\frac{\\sigma^2\\tau^2}{n_j\\tau^2 + \\sigma^2}$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{n_j\\bar{y}_j\\tau^2 + \\mu\\sigma^2}{n_j\\tau^2 + \\sigma^2} & \\frac{\\sigma^2\\tau^2}{n_j\\tau^2 + \\sigma^2}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在实际应用中，我们常常面临一个抉择：一个简单的池化模型是否足够，还是数据本身支持我们使用一个更复杂的层级结构？本练习  通过引入贝叶斯因子（Bayes factor），一种用于比较竞争模型的原则性方法，将理论与应用联系起来。你将实现一个计算流程，来量化支持随机效应模型相对于固定效应模型的证据强度，从而学习如何就模型复杂度做出数据驱动的决策，并评估你的结论对先验假设的敏感性。",
            "id": "4131268",
            "problem": "给定由复杂自适应系统中相互作用的智能体生成的分组观测数据。您将使用贝叶斯因子比较固定效应模型和随机效应分层模型，并评估证据对组间方差先验选择的敏感性。您的任务是实现一个完整的程序，该程序为指定的分组数据集和先验超参数计算贝叶斯因子，并将证据水平的解释编码为整数。该程序必须生成单行输出，汇总所有测试用例的结果。\n\n基本背景和模型定义：从 Kolmogorov 概率公理和贝叶斯定理出发。该定理指出，对于任何具有潜变量 $\\boldsymbol{\\theta}$ 的模型 $\\mathcal{M}$，观测数据 $\\mathbf{y}$ 的边际似然由 $p(\\mathbf{y}\\mid \\mathcal{M})=\\int p(\\mathbf{y}\\mid \\boldsymbol{\\theta},\\mathcal{M})\\,p(\\boldsymbol{\\theta}\\mid \\mathcal{M})\\,\\mathrm{d}\\boldsymbol{\\theta}$ 给出。考虑以下两种用于分组数据的模型。设观测数据为 $y_{ij}$，其中组索引为 $j\\in\\{1,\\dots,J\\}$，组内索引为 $i\\in\\{1,\\dots,n_j\\}$，总观测数量为 $N=\\sum_{j=1}^J n_j$。假设已知的组内观测方差为 $\\sigma^2$，先验均值为 $m_0$，先验方差为 $s_0^2$。\n\n- 固定效应模型 $\\mathcal{M}_0$：所有组共享一个共同的均值参数 $\\mu$，且 $y_{ij}\\mid \\mu,\\mathcal{M}_0\\sim \\mathcal{N}(\\mu,\\sigma^2)$。共同均值的先验为 $\\mu\\sim \\mathcal{N}(m_0,s_0^2)$。\n\n- 随机效应分层模型 $\\mathcal{M}_1$：每个组有其自身的均值 $\\theta_j$，且 $y_{ij}\\mid \\theta_j,\\mathcal{M}_1\\sim \\mathcal{N}(\\theta_j,\\sigma^2)$。组均值服从 $\\theta_j\\mid \\mu,\\mathcal{M}_1\\sim \\mathcal{N}(\\mu,\\tau^2)$，超均值的先验为 $\\mu\\sim \\mathcal{N}(m_0,s_0^2)$。将组间方差 $\\tau^2$ 视为一个固定的超参数，以探究先验敏感性。\n\n根据这些定义，使用全概率定律和高斯积分，通过对高斯潜变量进行解析积分，推导并计算边际似然 $p(\\mathbf{y}\\mid \\mathcal{M}_0)$ 和 $p(\\mathbf{y}\\mid \\mathcal{M}_1)$。比较 $\\mathcal{M}_1$ 与 $\\mathcal{M}_0$ 的贝叶斯因子为 $B_{10}=\\dfrac{p(\\mathbf{y}\\mid \\mathcal{M}_1)}{p(\\mathbf{y}\\mid \\mathcal{M}_0)}$。您必须对测试套件中每个指定的 $\\tau^2$ 值评估 $B_{10}$，以评估先验敏感性。\n\n证据解释编码：根据贝叶斯因子的标准解释类别，使用以下整数编码。对于计算出的贝叶斯因子 $B_{10}$，定义类别整数 $c$ 如下：\n- $c=0$ 如果 $B_{10}  1$ (支持固定效应模型),\n- $c=1$ 如果 $1 \\le B_{10}  3$ (支持随机效应模型的传闻证据),\n- $c=2$ 如果 $3 \\le B_{10}  10$ (中等证据),\n- $c=3$ 如果 $10 \\le B_{10}  30$ (强证据),\n- $c=4$ 如果 $30 \\le B_{10}  100$ (很强证据),\n- $c=5$ 如果 $B_{10}\\ge 100$ (决定性证据)。\n\n单位约定：不涉及物理单位。所有报告的数值和输出均为无单位实数。不使用角度。\n\n测试套件：实现程序以计算以下 3 个用例的结果。在每个用例中，明确指定分组数据 $\\{y_{ij}\\}$、组标签（从零开始）、已知的观测方差 $\\sigma^2$、先验均值 $m_0$、先验方差 $s_0^2$ 以及用于评估先验敏感性的两个 $\\tau^2$ 值的列表。\n\n- 用例 1 (组间分离清晰，平衡分组)：\n  - 分组与观测值：\n    - 第 0 组：[$-0.10$, $0.05$, $0.12$, $-0.03$, $0.08$]\n    - 第 1 组：[$1.95$, $2.10$, $1.88$, $2.05$, $1.92$]\n    - 第 2 组：[$-1.85$, $-2.05$, $-1.95$, $-1.90$, $-2.10$]\n  - 组标签：[$0$, $0$, $0$, $0$, $0$, $1$, $1$, $1$, $1$, $1$, $2$, $2$, $2$, $2$, $2$]\n  - 已知观测方差：$\\sigma^2=0.04$\n  - 先验均值：$m_0=0.00$\n  - 先验方差：$s_0^2=1.00$\n  - 先验敏感性列表：$\\tau^2\\in\\{0.20,1.00\\}$\n\n- 用例 2 (组间变异弱，平衡分组)：\n  - 分组与观测值：\n    - 第 0 组：[$0.50$, $0.48$, $0.52$, $0.51$]\n    - 第 1 组：[$0.55$, $0.53$, $0.58$, $0.54$]\n    - 第 2 组：[$0.49$, $0.47$, $0.50$, $0.52$]\n  - 组标签：[$0$, $0$, $0$, $0$, $1$, $1$, $1$, $1$, $2$, $2$, $2$, $2$]\n  - 已知观测方差：$\\sigma^2=0.05$\n  - 先验均值：$m_0=0.50$\n  - 先验方差：$s_0^2=0.50$\n  - 先验敏感性列表：$\\tau^2\\in\\{0.10,1.00\\}$\n\n- 用例 3 (组大小不平衡，混合分离)：\n  - 分组与观测值：\n    - 第 0 组：[$1.00$]\n    - 第 1 组：[$0.20$, $0.10$, $0.15$]\n    - 第 2 组：[$1.50$, $1.60$]\n    - 第 3 组：[$-0.40$, $-0.50$, $-0.45$, $-0.55$]\n  - 组标签：[$0$, $1$, $1$, $1$, $2$, $2$, $3$, $3$, $3$, $3$]\n  - 已知观测方差：$\\sigma^2=0.25$\n  - 先验均值：$m_0=0.00$\n  - 先验方差：$s_0^2=1.00$\n  - 先验敏感性列表：$\\tau^2\\in\\{0.01,0.50\\}$\n\n计算设计要求：对于每个用例和每个 $\\tau^2$ 值，您必须根据上述模型，通过对高斯潜变量进行积分得到边际似然，并使用它们的比率来计算贝叶斯因子 $B_{10}$。为确保数值稳定性，应使用均值向量为 $\\boldsymbol{\\mu}_0=m_0\\,\\mathbf{1}$ 和分层模型所蕴含的适当协方差矩阵的多元正态分布来构建推导，并使用 Cholesky 分解来评估对数边际似然。\n\n最终输出格式规范：对于每个测试用例，程序必须输出一个包含四个数字的列表：第一个 $\\tau^2$ 对应的贝叶斯因子、第二个 $\\tau^2$ 对应的贝叶斯因子，然后是与这两个贝叶斯因子相对应的两个整数证据类别。将所有用例的结果聚合到一个顶层列表中。您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果；每个用例元素本身必须是一个方括号括起来的、无空格的逗号分隔列表，例如 $[[b_{11},b_{12},c_{11},c_{12}],[b_{21},b_{22},c_{21},c_{22}],[b_{31},b_{32},c_{31},c_{32}]]$，其中 $b_{jk}$ 是贝叶斯因子，$c_{jk}$ 是如上定义的整数。",
            "solution": "我们从贝叶斯定理和 Kolmogorov 公理出发，它们意味着在具有潜变量 $\\boldsymbol{\\theta}$ 的模型 $\\mathcal{M}$ 下，边际似然是积分 $p(\\mathbf{y}\\mid \\mathcal{M})=\\int p(\\mathbf{y}\\mid \\boldsymbol{\\theta},\\mathcal{M})\\,p(\\boldsymbol{\\theta}\\mid \\mathcal{M})\\,\\mathrm{d}\\boldsymbol{\\theta}$。贝叶斯因子定义为 $B_{10}=\\dfrac{p(\\mathbf{y}\\mid \\mathcal{M}_1)}{p(\\mathbf{y}\\mid \\mathcal{M}_0)}$。\n\n对于固定效应模型 $\\mathcal{M}_0$，似然函数为 $p(\\mathbf{y}\\mid \\mu,\\mathcal{M}_0)=\\prod_{i=1}^N \\mathcal{N}(y_i\\mid \\mu,\\sigma^2)$，先验为 $\\mu\\sim \\mathcal{N}(m_0,s_0^2)$。将 $\\mu$ 积分掉，得到数据向量 $\\mathbf{y}$ 的一个多元正态分布，其均值为 $\\boldsymbol{\\mu}_0=m_0\\,\\mathbf{1}$，协方差为\n$$\n\\mathbf{C}_0=\\sigma^2\\,\\mathbf{I}_N + s_0^2\\,\\mathbf{1}\\mathbf{1}^\\top,\n$$\n其中 $\\mathbf{I}_N$ 是 $N\\times N$ 的单位矩阵，$\\mathbf{1}$ 是 $N$ 维的全一向量。这是根据以下性质得出的：如果 $\\mu\\sim \\mathcal{N}(m_0,s_0^2)$ 并且 $y_i\\mid \\mu\\sim \\mathcal{N}(\\mu,\\sigma^2)$ 独立，那么根据线性和全方差定律，边际上 $\\mathbf{y}\\sim \\mathcal{N}(\\boldsymbol{\\mu}_0,\\mathbf{C}_0)$。\n\n对于随机效应模型 $\\mathcal{M}_1$，我们有一个层次结构：$\\mu\\sim \\mathcal{N}(m_0,s_0^2)$，$\\theta_j\\mid \\mu\\sim \\mathcal{N}(\\mu,\\tau^2)$，以及 $y_{ij}\\mid \\theta_j\\sim \\mathcal{N}(\\theta_j,\\sigma^2)$。通过解析方法（高斯积分）将 $\\mu$ 和 $\\theta_j$ 积分掉，得到一个多元正态分布 $\\mathbf{y}\\sim \\mathcal{N}(\\boldsymbol{\\mu}_0,\\mathbf{C}_1)$，其中协方差编码了共同、组级别和个体级别的变异。根据全协方差定律，\n$$\n\\mathrm{Cov}(y_{ij},y_{kl}) \n= \\underbrace{s_0^2}_{\\text{通过 }\\mu\\text{ 的共同部分}}\n+ \\underbrace{\\tau^2\\cdot \\mathbf{1}\\{j=k\\}}_{\\text{通过 }\\theta_j\\text{ 的组部分}}\n+ \\underbrace{\\sigma^2\\cdot \\mathbf{1}\\{(i,j)=(l,k)\\}}_{\\text{个体噪声}},\n$$\n因此，以矩阵形式表示，\n$$\n\\mathbf{C}_1 = \\sigma^2\\,\\mathbf{I}_N + s_0^2\\,\\mathbf{1}\\mathbf{1}^\\top + \\tau^2\\,\\mathbf{B},\n$$\n其中，如果观测值 $a$ 和 $b$ 属于同一组，则 $(\\mathbf{B})_{ab}=1$，否则为 $0$。这种块结构是在每个层次级别上添加独立高斯分量的直接结果。\n\n给定一个多元正态分布 $\\mathbf{y}\\sim \\mathcal{N}(\\boldsymbol{\\mu}_0,\\mathbf{C})$，对数边际似然为\n$$\n\\log p(\\mathbf{y}\\mid \\mathcal{M}) = -\\tfrac{1}{2}\\left(N\\log(2\\pi) + \\log\\det\\mathbf{C} + (\\mathbf{y}-\\boldsymbol{\\mu}_0)^\\top \\mathbf{C}^{-1}(\\mathbf{y}-\\boldsymbol{\\mu}_0)\\right).\n$$\n为了稳定地计算它，使用 Cholesky 分解 $\\mathbf{C}=\\mathbf{L}\\mathbf{L}^\\top$，其中 $\\mathbf{L}$ 是下三角矩阵。那么 $\\log\\det\\mathbf{C}=2\\sum_{i=1}^N \\log L_{ii}$，而 $\\mathbf{C}^{-1}(\\mathbf{y}-\\boldsymbol{\\mu}_0)$ 可以通过求解 $\\mathbf{L}\\mathbf{z}=\\mathbf{y}-\\boldsymbol{\\mu}_0$ 然后求解 $\\mathbf{L}^\\top \\mathbf{x}=\\mathbf{z}$ 得到，从而得出 $\\mathbf{x}=\\mathbf{C}^{-1}(\\mathbf{y}-\\boldsymbol{\\mu}_0)$。二次型变为 $(\\mathbf{y}-\\boldsymbol{\\mu}_0)^\\top \\mathbf{x}$。\n\n算法步骤：\n- 对于每个用例，构建 $\\mathbf{y}$ 和长度为 $N$ 的组标签向量。\n- 构建 $\\mathbf{C}_0=\\sigma^2\\,\\mathbf{I}_N + s_0^2\\,\\mathbf{1}\\mathbf{1}^\\top$。\n- 对于每个指定的 $\\tau^2$，构建 $\\mathbf{C}_1(\\tau^2)=\\sigma^2\\,\\mathbf{I}_N + s_0^2\\,\\mathbf{1}\\mathbf{1}^\\top + \\tau^2\\,\\mathbf{B}$，其中 $\\mathbf{B}$ 是组成员关系矩阵。\n- 通过 Cholesky 分解计算 $\\log p(\\mathbf{y}\\mid \\mathcal{M}_0)$ 和 $\\log p(\\mathbf{y}\\mid \\mathcal{M}_1(\\tau^2))$，然后计算 $B_{10}(\\tau^2)=\\exp\\left(\\log p(\\mathbf{y}\\mid \\mathcal{M}_1(\\tau^2)) - \\log p(\\mathbf{y}\\mid \\mathcal{M}_0)\\right)$。\n- 使用指定的阈值将每个 $B_{10}(\\tau^2)$ 映射到一个证据类别整数 $c$：如果 $B_{10}  1$ 则 $c=0$，如果 $1\\le B_{10}  3$ 则 $c=1$，如果 $3\\le B_{10}  10$ 则 $c=2$，如果 $10\\le B_{10}  30$ 则 $c=3$，如果 $30\\le B_{10}  100$ 则 $c=4$，如果 $B_{10}\\ge 100$ 则 $c=5$。\n\n设计选择和原则：\n- 分层协方差结构源于全方差和全协方差定律，利用了每个层级的独立性和高斯性。\n- Cholesky 分解在评估 $\\log\\det\\mathbf{C}$ 和二次型时确保了数值稳定性，这对于高维 $\\mathbf{y}$ 至关重要。\n- 将 $\\tau^2$ 在一小组值上视为固定值，可以分离出先验敏感性，因为对于相同的数据，$B_{10}$ 会随 $\\tau^2$ 的变化而变化。\n\n输出规范：\n- 对于每个用例，输出一个列表 $[B_{10}(\\tau^2_1), B_{10}(\\tau^2_2), c_1, c_2]$。\n- 将三个用例的列表聚合到一个顶层列表中，并按规定将其打印为单行字符串，其中元素以逗号分隔，方括号列表内无空格。\n\n该过程为多层次和分层建模中的贝叶斯因子提供了一种有原则的、基于第一性原理的评估，并通过改变 $\\tau^2$ 来量化先验敏感性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef cholesky_log_marginal_likelihood(y, mean_scalar, C):\n    \"\"\"\n    Compute log marginal likelihood for y ~ N(mean_scalar * 1, C) using Cholesky.\n    \"\"\"\n    y = np.asarray(y, dtype=float)\n    N = y.shape[0]\n    mean_vec = np.full(N, mean_scalar, dtype=float)\n    centered = y - mean_vec\n\n    # Cholesky decomposition\n    L = np.linalg.cholesky(C)\n    # log det\n    log_det = 2.0 * np.sum(np.log(np.diag(L)))\n    # Solve C^{-1} * centered via two triangular solves\n    z = np.linalg.solve(L, centered)\n    inv_centered = np.linalg.solve(L.T, z)\n    quad = float(centered @ inv_centered)\n    # log marginal likelihood of MVN\n    log_ml = -0.5 * (N * np.log(2.0 * np.pi) + log_det + quad)\n    return log_ml\n\ndef build_covariance(groups, sigma2, s02, tau2):\n    \"\"\"\n    Build covariance matrix:\n    C = sigma2 * I + s02 * 1*1^T + tau2 * B\n    where B_{ij} = 1 if groups[i] == groups[j], else 0.\n    \"\"\"\n    groups = np.asarray(groups, dtype=int)\n    N = groups.shape[0]\n    I = np.eye(N, dtype=float)\n    ones = np.ones((N, N), dtype=float)\n    # Group membership matrix\n    B = (groups[:, None] == groups[None, :]).astype(float)\n    C = sigma2 * I + s02 * ones + tau2 * B\n    return C\n\ndef bayes_factor_random_vs_fixed(y, groups, sigma2, m0, s02, tau2):\n    \"\"\"\n    Compute Bayes factor B10 = p(y | M1(tau2)) / p(y | M0)\n    where M0 has covariance C0 = sigma2 * I + s02 * 1*1^T\n    and M1 has covariance C1 = C0 + tau2 * B\n    \"\"\"\n    groups = np.asarray(groups, dtype=int)\n    N = len(y)\n    # Fixed-effects covariance (tau2 = 0)\n    C0 = build_covariance(groups, sigma2=sigma2, s02=s02, tau2=0.0)\n    # Random-effects covariance with given tau2\n    C1 = build_covariance(groups, sigma2=sigma2, s02=s02, tau2=tau2)\n\n    log_ml_M0 = cholesky_log_marginal_likelihood(y, mean_scalar=m0, C=C0)\n    log_ml_M1 = cholesky_log_marginal_likelihood(y, mean_scalar=m0, C=C1)\n    bf = float(np.exp(log_ml_M1 - log_ml_M0))\n    return bf\n\ndef bf_category(bf):\n    \"\"\"\n    Map Bayes factor to integer category:\n    0: bf  1\n    1: 1 = bf  3\n    2: 3 = bf  10\n    3: 10 = bf  30\n    4: 30 = bf  100\n    5: bf >= 100\n    \"\"\"\n    if bf  1.0:\n        return 0\n    elif bf  3.0:\n        return 1\n    elif bf  10.0:\n        return 2\n    elif bf  30.0:\n        return 3\n    elif bf  100.0:\n        return 4\n    else:\n        return 5\n\ndef format_result_list(lst):\n    # Produce \"[x,y,z,w]\" with no spaces\n    return \"[\" + \",\".join(str(x) for x in lst) + \"]\"\n\ndef solve():\n    # Define the test cases from the problem statement.\n\n    # Case 1\n    y1 = [\n        -0.10, 0.05, 0.12, -0.03, 0.08,\n        1.95, 2.10, 1.88, 2.05, 1.92,\n        -1.85, -2.05, -1.95, -1.90, -2.10\n    ]\n    groups1 = [0]*5 + [1]*5 + [2]*5\n    sigma2_1 = 0.04\n    m0_1 = 0.0\n    s02_1 = 1.0\n    tau_list_1 = [0.20, 1.00]\n\n    # Case 2\n    y2 = [\n        0.50, 0.48, 0.52, 0.51,\n        0.55, 0.53, 0.58, 0.54,\n        0.49, 0.47, 0.50, 0.52\n    ]\n    groups2 = [0]*4 + [1]*4 + [2]*4\n    sigma2_2 = 0.05\n    m0_2 = 0.50\n    s02_2 = 0.50\n    tau_list_2 = [0.10, 1.00]\n\n    # Case 3\n    y3 = [\n        1.00,\n        0.20, 0.10, 0.15,\n        1.50, 1.60,\n        -0.40, -0.50, -0.45, -0.55\n    ]\n    groups3 = [0, 1, 1, 1, 2, 2, 3, 3, 3, 3]\n    sigma2_3 = 0.25\n    m0_3 = 0.00\n    s02_3 = 1.00\n    tau_list_3 = [0.01, 0.50]\n\n    test_cases = [\n        (y1, groups1, sigma2_1, m0_1, s02_1, tau_list_1),\n        (y2, groups2, sigma2_2, m0_2, s02_2, tau_list_2),\n        (y3, groups3, sigma2_3, m0_3, s02_3, tau_list_3),\n    ]\n\n    results = []\n    for y, groups, sigma2, m0, s02, tau_list in test_cases:\n        bfs = []\n        cats = []\n        for tau2 in tau_list:\n            bf = bayes_factor_random_vs_fixed(y, groups, sigma2, m0, s02, tau2)\n            bfs.append(bf)\n            cats.append(bf_category(bf))\n        # per-case result: [BF_tau1, BF_tau2, cat_tau1, cat_tau2]\n        case_result = [bfs[0], bfs[1], cats[0], cats[1]]\n        results.append(case_result)\n\n    # Final print statement in the exact required format: single line, no spaces inside lists.\n    print(\"[\" + \",\".join(format_result_list(res) for res in results) + \"]\")\n\nsolve()\n```"
        }
    ]
}