{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of atmospheric modeling is the principle of hydrostatic equilibrium, which describes the vertical balance between the downward force of gravity and the upward pressure gradient force. This practice guides you through the derivation of the hypsometric equation, a direct consequence of this balance and the ideal gas law. By applying this equation, you will compute the geometric thickness of an atmospheric layer, a fundamental diagnostic used to interpret the thermodynamic state of the atmosphere in weather and climate models .",
            "id": "3872175",
            "problem": "In a vertically resolved atmospheric column used in coupled climate and Earth system modeling, the geometric thickness between two isobaric surfaces is a key diagnostic of the column’s thermodynamic state. Starting from the hydrostatic balance $\\partial p/\\partial z=-\\rho g$ and the equation of state for moist air written using virtual temperature $p=\\rho R_{d} T_{v}$, where $T_{v}$ is the virtual temperature and $R_{d}$ is the specific gas constant for dry air, perform the following:\n\n1) Derive, from first principles, an expression for the geometric thickness $\\Delta z\\equiv z(p_{2})-z(p_{1})$ between two pressure levels $p_{1}>p_{2}$ as an integral involving $T_{v}$ and $p$. Clearly state any assumptions needed for the derivation.\n\n2) Consider a moist tropospheric column whose virtual temperature profile as a function of pressure is given by\n$$\nT_{v}(p)=T_{0}\\left[1+\\beta \\ln\\!\\left(\\frac{p}{p_{0}}\\right)\\right],\n$$\nwith $T_{0}=290\\ \\mathrm{K}$, $\\beta=0.15$, and $p_{0}=1000\\ \\mathrm{hPa}$. Using your result from part (1), compute the geometric thickness between $p_{1}=1000\\ \\mathrm{hPa}$ and $p_{2}=500\\ \\mathrm{hPa}$. Take $R_{d}=287\\ \\mathrm{J}\\ \\mathrm{kg}^{-1}\\ \\mathrm{K}^{-1}$ and $g=9.81\\ \\mathrm{m}\\ \\mathrm{s}^{-2}$. Express the final thickness in meters, and round your answer to four significant figures.\n\nAll mathematical steps must be shown, and any integrals must be evaluated exactly before substituting numerical values. Clearly indicate the final numerical value.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of atmospheric thermodynamics, is well-posed with sufficient and consistent data, and is expressed objectively. We will proceed with the two parts of the problem.\n\nPart 1: Derivation of the geometric thickness expression.\n\nThe derivation begins with two fundamental equations provided: the hydrostatic balance and the equation of state for moist air.\n\nThe hydrostatic balance equation is:\n$$\n\\frac{\\partial p}{\\partial z} = -\\rho g\n$$\nwhere $p$ is pressure, $z$ is the geometric height, $\\rho$ is the density of moist air, and $g$ is the acceleration due to gravity.\n\nThe equation of state is given in terms of the virtual temperature, $T_v$:\n$$\np = \\rho R_{d} T_{v}\n$$\nwhere $R_d$ is the specific gas constant for dry air.\n\nOur goal is to find an expression for the geometric thickness $\\Delta z \\equiv z(p_2) - z(p_1)$. We assume that the acceleration due to gravity, $g$, is constant over the vertical extent of the layer, which is an excellent approximation for typical tropospheric layers. The primary assumption is that the atmospheric column is in hydrostatic equilibrium.\n\nFirst, we rearrange the hydrostatic equation to solve for an infinitesimal change in height, $dz$:\n$$\ndz = -\\frac{1}{\\rho g} dp\n$$\nNext, we eliminate the density, $\\rho$, by rearranging the equation of state:\n$$\n\\rho = \\frac{p}{R_{d} T_{v}}\n$$\nSubstituting this expression for $\\rho$ into the equation for $dz$ yields:\n$$\ndz = -\\frac{1}{\\left(\\frac{p}{R_{d} T_{v}}\\right) g} dp = -\\frac{R_{d} T_{v}}{g} \\frac{dp}{p}\n$$\nTo find the total thickness $\\Delta z$ between two pressure surfaces $p_1$ and $p_2$, we integrate $dz$ from the corresponding heights $z(p_1)$ to $z(p_2)$. The integration variable on the right-hand side is pressure, so the limits of integration are from $p_1$ to $p_2$.\n$$\n\\int_{z(p_1)}^{z(p_2)} dz = \\int_{p_1}^{p_2} \\left(-\\frac{R_{d} T_{v}}{g} \\frac{1}{p}\\right) dp\n$$\nThe left-hand side evaluates to $z(p_2) - z(p_1) = \\Delta z$. We can pull the constants $R_d$ and $g$ outside the integral on the right-hand side.\n$$\n\\Delta z = -\\frac{R_d}{g} \\int_{p_1}^{p_2} T_{v}(p) \\frac{dp}{p}\n$$\nThe problem specifies that $p_1 > p_2$, which means $p_1$ is at a lower altitude than $p_2$. Therefore, $z(p_2) - z(p_1)$ should be positive. The differential $dp$ is negative as we integrate upward from a higher pressure to a lower pressure. To obtain a positive result for $\\Delta z$, we can reverse the limits of integration, which cancels the negative sign:\n$$\n\\Delta z = \\frac{R_d}{g} \\int_{p_2}^{p_1} T_{v}(p) \\frac{dp}{p}\n$$\nThis is the desired expression for the geometric thickness, commonly known as the hypsometric equation.\n\nPart 2: Calculation of the geometric thickness.\n\nWe are given the virtual temperature profile:\n$$\nT_{v}(p) = T_{0}\\left[1+\\beta \\ln\\left(\\frac{p}{p_{0}}\\right)\\right]\n$$\nwith constants $T_{0}=290\\ \\mathrm{K}$, $\\beta=0.15$, and $p_{0}=1000\\ \\mathrm{hPa}$. We need to compute the thickness between $p_{1}=1000\\ \\mathrm{hPa}$ and $p_{2}=500\\ \\mathrm{hPa}$. The physical constants are $R_{d}=287\\ \\mathrm{J}\\ \\mathrm{kg}^{-1}\\ \\mathrm{K}^{-1}$ and $g=9.81\\ \\mathrm{m}\\ \\mathrm{s}^{-2}$.\n\nWe substitute the given $T_v(p)$ into our derived thickness formula:\n$$\n\\Delta z = \\frac{R_d}{g} \\int_{p_2}^{p_1} T_{0}\\left[1+\\beta \\ln\\left(\\frac{p}{p_{0}}\\right)\\right] \\frac{dp}{p}\n$$\nThe constant $T_0$ can be moved outside the integral:\n$$\n\\Delta z = \\frac{R_d T_0}{g} \\int_{p_2}^{p_1} \\left[1+\\beta \\ln\\left(\\frac{p}{p_{0}}\\right)\\right] \\frac{dp}{p}\n$$\nWe evaluate the integral analytically. Let's split the integrand:\n$$\n\\int \\left( \\frac{1}{p} + \\frac{\\beta}{p} \\ln\\left(\\frac{p}{p_0}\\right) \\right) dp = \\int \\frac{dp}{p} + \\beta \\int \\ln\\left(\\frac{p}{p_0}\\right) \\frac{dp}{p}\n$$\nThe first part is $\\ln(p)$. For the second part, we use the substitution $u = \\ln(p/p_0)$. Then $du = (p_0/p) \\cdot (1/p_0) dp = (1/p) dp$. The integral becomes $\\int u \\, du = u^2/2$.\nSo, the antiderivative is:\n$$\n\\ln(p) + \\frac{\\beta}{2} \\left[ \\ln\\left(\\frac{p}{p_0}\\right) \\right]^2\n$$\nNow, we evaluate the definite integral from $p_2$ to $p_1$:\n$$\n\\int_{p_2}^{p_1} \\left[ \\dots \\right] dp = \\left[ \\ln(p) + \\frac{\\beta}{2} \\left( \\ln\\left(\\frac{p}{p_0}\\right) \\right)^2 \\right]_{p_2}^{p_1}\n$$\n$$\n= \\left( \\ln(p_1) + \\frac{\\beta}{2} \\left( \\ln\\left(\\frac{p_1}{p_0}\\right) \\right)^2 \\right) - \\left( \\ln(p_2) + \\frac{\\beta}{2} \\left( \\ln\\left(\\frac{p_2}{p_0}\\right) \\right)^2 \\right)\n$$\n$$\n= \\ln\\left(\\frac{p_1}{p_2}\\right) + \\frac{\\beta}{2} \\left[ \\left( \\ln\\left(\\frac{p_1}{p_0}\\right) \\right)^2 - \\left( \\ln\\left(\\frac{p_2}{p_0}\\right) \\right)^2 \\right]\n$$\nNow we substitute the given pressure values: $p_1 = 1000\\ \\mathrm{hPa}$, $p_2 = 500\\ \\mathrm{hPa}$, and $p_0 = 1000\\ \\mathrm{hPa}$. Note that $p_1 = p_0$.\n$$\n\\ln\\left(\\frac{p_1}{p_0}\\right) = \\ln\\left(\\frac{1000}{1000}\\right) = \\ln(1) = 0\n$$\n$$\n\\ln\\left(\\frac{p_2}{p_0}\\right) = \\ln\\left(\\frac{500}{1000}\\right) = \\ln(0.5) = -\\ln(2)\n$$\nThe value of the definite integral is:\n$$\n\\ln\\left(\\frac{1000}{500}\\right) + \\frac{\\beta}{2} \\left[ (0)^2 - (-\\ln(2))^2 \\right] = \\ln(2) + \\frac{\\beta}{2} \\left[ -(\\ln(2))^2 \\right] = \\ln(2) - \\frac{\\beta}{2}(\\ln(2))^2\n$$\n$$\n= \\ln(2) \\left[ 1 - \\frac{\\beta}{2}\\ln(2) \\right]\n$$\nNow we assemble the full expression for $\\Delta z$:\n$$\n\\Delta z = \\frac{R_d T_0}{g} \\ln(2) \\left[ 1 - \\frac{\\beta}{2}\\ln(2) \\right]\n$$\nFinally, we substitute the numerical values for the constants:\n- $R_d = 287\\ \\mathrm{J}\\ \\mathrm{kg}^{-1}\\ \\mathrm{K}^{-1}$\n- $T_0 = 290\\ \\mathrm{K}$\n- $g = 9.81\\ \\mathrm{m}\\ \\mathrm{s}^{-2}$\n- $\\beta = 0.15$\n- $\\ln(2) \\approx 0.693147$\n\nFirst, calculate the pre-factor:\n$$\n\\frac{R_d T_0}{g} = \\frac{287 \\times 290}{9.81} = \\frac{83230}{9.81} \\approx 8484.20\\ \\mathrm{m}\n$$\nNext, calculate the term in the brackets:\n$$\n1 - \\frac{0.15}{2}\\ln(2) = 1 - 0.075 \\times \\ln(2) \\approx 1 - 0.075 \\times 0.693147 = 1 - 0.051986 \\approx 0.948014\n$$\nNow, multiply all parts together:\n$$\n\\Delta z \\approx 8484.20 \\times 0.693147 \\times 0.948014 \\approx 5574.96\\ \\mathrm{m}\n$$\nThe problem requires the answer to be rounded to four significant figures.\n$$\n\\Delta z \\approx 5575\\ \\mathrm{m}\n$$",
            "answer": "$$\\boxed{5575}$$"
        },
        {
            "introduction": "Earth system models must accurately represent the impact of external forcings on the planet's energy balance. This exercise focuses on a crucial natural forcing: the radiative effect of stratospheric aerosols from a major volcanic eruption. You will develop a simplified radiative transfer model to quantify the opposing impacts of aerosol scattering in the shortwave and absorption/emission in the longwave, culminating in a net radiative forcing calculation. This practice provides critical insight into how aerosols perturb the climate system, a key process for understanding both past climate changes and potential geoengineering strategies .",
            "id": "3872114",
            "problem": "A globally uniform stratospheric sulfate aerosol layer forms after a major volcanic eruption, producing a Pinatubo-like perturbation to the Earth's radiation budget. Assume a well-mixed, plane-parallel atmosphere with an optically thin stratospheric aerosol layer characterized by a shortwave (visible) optical depth $\\tau_{s}$, single-scattering albedo $\\omega_{0}$, and scattering asymmetry parameter $g$. The aerosol layer also weakly absorbs and emits in the thermal infrared, which can be approximated by a gray longwave optical depth $\\tau_{L}$ proportional to $\\tau_{s}$ through a constant factor $\\eta$.\n\nAdopt the following physically plausible parameters:\n- Solar constant $S_{0} = 1361 \\mathrm{W} \\mathrm{m}^{-2}$, planetary baseline albedo $A_{0} = 0.29$.\n- Aerosol shortwave properties: $\\tau_{s} = 0.15$, $\\omega_{0} = 0.98$, $g = 0.70$.\n- Longwave coupling: $\\tau_{L} = \\eta \\, \\tau_{s}$ with $\\eta = 0.06$, and aerosol layer temperature $T_{a} = 220 \\ \\mathrm{K}$.\n- Stefan–Boltzmann constant $\\sigma = 5.670374419 \\times 10^{-8} \\mathrm{W} \\mathrm{m}^{-2} \\mathrm{K}^{-4}$.\n\nUse the following fundamental bases and assumptions appropriate for the Earth system:\n- Beer–Lambert law in the optically thin limit ($\\tau \\ll 1$): the first-order fractional attenuation of a beam is proportional to $\\tau$.\n- Single-scattering approximation in shortwave: the fractional backscatter into space per scattering event can be approximated by $(1 - g)/2$, and the probability of a scattering event per path is $\\omega_{0} \\tau_{s}$.\n- Energy balance at the Top of Atmosphere (TOA): in the unperturbed state, the Outgoing Longwave Radiation (OLR) equals the absorbed shortwave, so the upward longwave flux from below the aerosol layer is $F_{u} = (1 - A_{0}) \\, S_{0}/4$.\n- In the longwave, the optically thin aerosol layer has hemispheric emissivity approximately equal to $\\tau_{L}$; its upward thermal emission is $\\tau_{L} \\sigma T_{a}^{4}$, and it absorbs a fraction $\\tau_{L}$ of the upwelling longwave flux $F_{u}$ from below.\n\nDefine the radiative perturbation at TOA, $\\Delta F$, to be positive for a downward net flux change (i.e., reduced outgoing or increased incoming). Starting from these bases, derive expressions for the shortwave perturbation $\\Delta F_{\\mathrm{SW}}$ and the longwave perturbation $\\Delta F_{\\mathrm{LW}}$, and then compute the net perturbation\n$$\n\\Delta F_{\\mathrm{net}} = \\Delta F_{\\mathrm{SW}} + \\Delta F_{\\mathrm{LW}}.\n$$\nRound your final numerical answer for $\\Delta F_{\\mathrm{net}}$ to four significant figures and express it in $\\mathrm{W} \\mathrm{m}^{-2}$.",
            "solution": "The total radiative perturbation at the Top of the Atmosphere (TOA), $\\Delta F_{\\mathrm{net}}$, is the sum of the shortwave ($\\Delta F_{\\mathrm{SW}}$) and longwave ($\\Delta F_{\\mathrm{LW}}$) perturbations. We will calculate each component separately. The perturbation is defined as positive for a net downward flux change (a warming effect).\n\nFirst, we calculate the shortwave radiative perturbation, $\\Delta F_{\\mathrm{SW}}$. This perturbation is caused by the aerosol layer scattering incoming solar radiation back to space, which increases the planetary albedo. A net increase in outgoing shortwave radiation corresponds to a negative perturbation. The globally averaged incoming solar flux at the TOA is $\\frac{S_{0}}{4}$.\nBased on the problem's single-scattering approximation, the fraction of incoming radiation that is scattered back to space by the aerosol layer is the product of the probability of a scattering event and the fraction of scattered radiation directed into the upward hemisphere (backscattered).\nThe probability of a photon being scattered is given by the scattering optical depth, $\\omega_{0}\\tau_{s}$.\nThe fraction of scattered radiation that is directed back to space is approximated by the backscatter fraction, $\\frac{1-g}{2}$.\nTherefore, the additional outgoing shortwave flux at the TOA due to the aerosol layer is:\n$$\n\\Delta F_{\\mathrm{SW, out}} = \\left(\\frac{S_{0}}{4}\\right) \\omega_{0} \\tau_{s} \\left(\\frac{1-g}{2}\\right)\n$$\nThe shortwave perturbation $\\Delta F_{\\mathrm{SW}}$ is the change in the net downward flux, so it is the negative of the change in the outgoing flux.\n$$\n\\Delta F_{\\mathrm{SW}} = - \\Delta F_{\\mathrm{SW, out}} = - \\left(\\frac{S_{0}}{4}\\right) \\omega_{0} \\tau_{s} \\left(\\frac{1-g}{2}\\right)\n$$\nSubstituting the given values:\n$S_{0} = 1361 \\mathrm{W} \\mathrm{m}^{-2}$, $\\omega_{0} = 0.98$, $\\tau_{s} = 0.15$, and $g = 0.70$.\n$$\n\\Delta F_{\\mathrm{SW}} = - \\left(\\frac{1361}{4}\\right) \\times 0.98 \\times 0.15 \\times \\left(\\frac{1 - 0.70}{2}\\right)\n$$\n$$\n\\Delta F_{\\mathrm{SW}} = - (340.25) \\times 0.98 \\times 0.15 \\times \\left(\\frac{0.30}{2}\\right)\n$$\n$$\n\\Delta F_{\\mathrm{SW}} = - (340.25) \\times 0.98 \\times 0.15 \\times 0.15\n$$\n$$\n\\Delta F_{\\mathrm{SW}} = -7.5025125 \\mathrm{W} \\mathrm{m}^{-2}\n$$\n\nNext, we calculate the longwave radiative perturbation, $\\Delta F_{\\mathrm{LW}}$. This perturbation arises from the aerosol layer absorbing and emitting thermal infrared radiation. The perturbation is the negative of the change in Outgoing Longwave Radiation (OLR).\nTwo effects alter the OLR:\n1. The aerosol layer absorbs a fraction of the upwelling longwave radiation from the warmer Earth-troposphere system below, reducing the OLR. This represents a warming effect.\n2. The aerosol layer itself emits longwave radiation upward to space at its own (cold) temperature, increasing the OLR. This represents a cooling effect.\n\nThe upwelling longwave flux from below the layer is given as $F_{u} = (1-A_{0}) \\frac{S_{0}}{4}$. The fraction of this flux absorbed by the layer is $\\tau_{L}$, so the reduction in OLR is $\\tau_{L}F_{u}$.\nThe upward emission from the aerosol layer is given by $\\epsilon_{a} \\sigma T_{a}^{4}$. With the assumption that the emissivity $\\epsilon_{a}$ is equal to the longwave optical depth $\\tau_{L}$, this emission is $\\tau_{L} \\sigma T_{a}^{4}$.\nThe net change in OLR is the new emission minus the absorbed flux:\n$$\n\\Delta \\mathrm{OLR} = \\tau_{L} \\sigma T_{a}^{4} - \\tau_{L} F_{u}\n$$\nThe longwave perturbation is $\\Delta F_{\\mathrm{LW}} = - \\Delta \\mathrm{OLR}$.\n$$\n\\Delta F_{\\mathrm{LW}} = - (\\tau_{L} \\sigma T_{a}^{4} - \\tau_{L} F_{u}) = \\tau_{L} F_{u} - \\tau_{L} \\sigma T_{a}^{4} = \\tau_{L} (F_{u} - \\sigma T_{a}^{4})\n$$\nSubstituting the expression for $F_u$:\n$$\n\\Delta F_{\\mathrm{LW}} = \\tau_{L} \\left( (1-A_{0})\\frac{S_{0}}{4} - \\sigma T_{a}^{4} \\right)\n$$\nWe first calculate the longwave optical depth $\\tau_L$:\n$\\tau_L = \\eta \\tau_s = 0.06 \\times 0.15 = 0.009$.\nNow substitute all the values into the expression for $\\Delta F_{\\mathrm{LW}}$:\n$A_{0} = 0.29$, $S_{0} = 1361 \\mathrm{W} \\mathrm{m}^{-2}$, $\\sigma = 5.670374419 \\times 10^{-8} \\mathrm{W} \\mathrm{m}^{-2} \\mathrm{K}^{-4}$, and $T_{a} = 220 \\mathrm{K}$.\n$$\nF_{u} = (1-0.29) \\times \\frac{1361}{4} = 0.71 \\times 340.25 = 241.5775 \\mathrm{W} \\mathrm{m}^{-2}\n$$\n$$\n\\sigma T_{a}^{4} = (5.670374419 \\times 10^{-8}) \\times (220)^{4} \\approx 132.846 \\mathrm{W} \\mathrm{m}^{-2}\n$$\n$$\n\\Delta F_{\\mathrm{LW}} = 0.009 \\times (241.5775 - 132.846) = 0.009 \\times 108.7315 \\approx 0.9785835 \\mathrm{W} \\mathrm{m}^{-2}\n$$\nThis positive value indicates a warming effect from the trapping of longwave radiation.\n\nFinally, we compute the net radiative perturbation, $\\Delta F_{\\mathrm{net}}$, by summing the shortwave and longwave components.\n$$\n\\Delta F_{\\mathrm{net}} = \\Delta F_{\\mathrm{SW}} + \\Delta F_{\\mathrm{LW}}\n$$\n$$\n\\Delta F_{\\mathrm{net}} = -7.5025125 \\mathrm{W} \\mathrm{m}^{-2} + 0.9785835 \\mathrm{W} \\mathrm{m}^{-2} = -6.523929 \\mathrm{W} \\mathrm{m}^{-2}\n$$\nThe problem requires the answer to be rounded to four significant figures.\n$$\n\\Delta F_{\\mathrm{net}} \\approx -6.524 \\mathrm{W} \\mathrm{m}^{-2}\n$$\nThe net effect is a strong cooling, as the shortwave reflection effect dominates the longwave greenhouse effect, which is characteristic of large sulfate aerosol layers in the stratosphere.",
            "answer": "$$\n\\boxed{-6.524}\n$$"
        },
        {
            "introduction": "The physical laws governing the climate system are mathematically expressed as partial differential equations, which Earth system models solve using numerical methods. A fundamental requirement for these methods is that they must conserve essential quantities like mass and energy. This hands-on coding practice challenges you to implement a finite-volume advection scheme from first principles, focusing on how different boundary conditions are handled and how discrete conservation can be rigorously verified. Building and testing such a scheme is a foundational skill for any climate modeler, ensuring the numerical engine of the model is robust and physically sound .",
            "id": "3872160",
            "problem": "You are tasked with constructing a flux-form finite-volume discretization for one-dimensional tracer advection on a staggered grid and demonstrating discrete conservation under multiple scientifically realistic boundary conditions. Work from the conservation of mass principle for a passive tracer, and design a numerically stable and conservative algorithm. The goal is to implement a scheme in which cell-averaged tracer concentrations are updated by the divergence of face-centered fluxes and to verify that the discrete global mass budget change equals the time-integrated net boundary flux to within floating-point precision.\n\nStart from the following fundamental base:\n- The one-dimensional conservation law for a passive tracer concentration $C(x,t)$ advected by a prescribed velocity $u(x,t)$ is $ \\frac{\\partial C}{\\partial t} + \\frac{\\partial}{\\partial x}\\left(u C\\right) = 0 $.\n- The finite-volume control volume for cell $i$ is $[x_{i-\\frac{1}{2}}, x_{i+\\frac{1}{2}}]$ of width $\\Delta x$, with cell-average $C_i(t)$ defined by $ C_i(t) = \\frac{1}{\\Delta x}\\int_{x_{i-\\frac{1}{2}}}^{x_{i+\\frac{1}{2}}} C(x,t)\\,dx $.\n- On a staggered grid, velocities are defined at cell faces $x_{j}$ for $j=0,\\dots,N$, and tracer concentrations are cell-centered at $x_i$ for $i=0,\\dots,N-1$. Fluxes across faces use face-centered velocities and an upwind choice of tracer, ensuring numerical stability while maintaining conservation.\n\nYour implementation must:\n- Construct face fluxes $F_j = u_j \\, C^{\\mathrm{upwind}}_j$ at faces $j=0,\\dots,N$, where $C^{\\mathrm{upwind}}_j$ is the appropriate upwind cell-centered tracer based on the sign of $u_j$.\n- Update cell averages using a flux divergence over the time step $\\Delta t$.\n- Apply boundary conditions in a manner consistent with the physical interpretation:\n    - Periodic boundary: wrap indices so that the left boundary face is connected to the rightmost cell and vice versa.\n    - Closed-wall boundary: impose zero normal flux at the two boundary faces.\n    - Inflow–outflow boundary: at each boundary face, if the flow is entering the domain, use a prescribed inflow tracer concentration; if the flow is leaving, use the interior upwind value.\n- Track and verify discrete global conservation by computing the mass budget residual defined as\n  $$ R = \\left[ M(T) - M(0) \\right] - \\int_0^T \\left(F_0(t) - F_N(t)\\right) \\, A \\, dt, $$\n  where $M(t) = \\sum_{i=0}^{N-1} C_i(t) \\, \\Delta x \\, A$ is the total tracer mass in the domain at time $t$, $A$ is the cross-sectional area, and $F_0(t)$, $F_N(t)$ are the fluxes through the left and right boundary faces, respectively. In discrete time with constant $\\Delta t$, this is\n  $$ R = \\left[ M^{n_{\\mathrm{end}}} - M^{0} \\right] - \\Delta t \\, A \\sum_{n=0}^{n_{\\mathrm{end}}-1} \\left(F_0^n - F_N^n\\right). $$\n  Use $A=1\\,\\mathrm{m}^2$.\n\nPhysical and numerical units:\n- Domain length $L$ in meters ($\\mathrm{m}$).\n- Velocity $u$ in meters per second ($\\mathrm{m/s}$).\n- Time step $\\Delta t$ and total time $T=n_{\\mathrm{end}} \\Delta t$ in seconds ($\\mathrm{s}$).\n- Tracer concentration $C$ in kilograms per cubic meter ($\\mathrm{kg/m^3}$).\n- Mass $M$ and residual $R$ in kilograms ($\\mathrm{kg}$).\n- Angles are not used.\n\nDesign choices:\n- Use an explicit upwind flux for $C^{\\mathrm{upwind}}_j$ based on the sign of $u_j$.\n- Ensure the Courant number $ \\mathcal{C} = \\frac{|u| \\Delta t}{\\Delta x} $ is less than or equal to $1$ in the provided tests.\n\nTest suite:\nImplement and run the discretization with the following parameter sets. For each case, compute the residual $R$ in kilograms and report it.\n\n- Case $1$ (Periodic, nonzero velocity):\n  - $L = 1000\\,\\mathrm{m}$, $N = 100$, uniform $u = 1\\,\\mathrm{m/s}$, $\\Delta t = 5\\,\\mathrm{s}$, $n_{\\mathrm{end}} = 20$.\n  - Boundary condition: periodic.\n  - Initial condition: $ C(x,0) = 1 + 0.5 \\sin\\left( \\frac{2\\pi x}{L} \\right) $.\n\n- Case $2$ (Closed-wall, nonzero velocity):\n  - $L = 100\\,\\mathrm{m}$, $N = 50$, uniform $u = 2\\,\\mathrm{m/s}$, $\\Delta t = 0.5\\,\\mathrm{s}$, $n_{\\mathrm{end}} = 25$.\n  - Boundary condition: closed-wall (zero normal flux at $x=0$ and $x=L$).\n  - Initial condition: $ C(x,0) = \\exp\\left( -\\frac{\\left(x - L/3\\right)^2}{2 \\sigma^2} \\right) $, with $ \\sigma = L/20 $.\n\n- Case $3$ (Inflow–outflow, positive velocity):\n  - $L = 200\\,\\mathrm{m}$, $N = 100$, uniform $u = 0.5\\,\\mathrm{m/s}$, $\\Delta t = 2\\,\\mathrm{s}$, $n_{\\mathrm{end}} = 50$.\n  - Boundary condition: inflow–outflow with prescribed inflow concentrations: left inflow $ C_{\\mathrm{in,L}} = 2\\,\\mathrm{kg/m^3} $, right inflow $ C_{\\mathrm{in,R}} = 0.5\\,\\mathrm{kg/m^3} $.\n  - Initial condition: $ C(x,0) = 0 $.\n\n- Case $4$ (Inflow–outflow, negative velocity):\n  - $L = 300\\,\\mathrm{m}$, $N = 60$, uniform $u = -0.8\\,\\mathrm{m/s}$, $\\Delta t = 3\\,\\mathrm{s}$, $n_{\\mathrm{end}} = 30$.\n  - Boundary condition: inflow–outflow with prescribed inflow concentrations: left inflow $ C_{\\mathrm{in,L}} = 0.7\\,\\mathrm{kg/m^3} $, right inflow $ C_{\\mathrm{in,R}} = 3\\,\\mathrm{kg/m^3} $.\n  - Initial condition: $ C(x,0) = 1 $.\n\nFinal output format:\n- Your program should produce a single line of output containing the four residuals $[R_1,R_2,R_3,R_4]$ as a comma-separated list enclosed in square brackets.\n- Each residual must be a decimal float expressed in kilograms using scientific notation with six significant digits, for example $[1.234567\\mathrm{e}{-08},-2.345678\\mathrm{e}{-10},\\dots]$.",
            "solution": "The problem requires the construction and verification of a one-dimensional, explicit, upwind finite-volume scheme for the tracer advection equation on a staggered grid. The task is to implement this scheme for three distinct boundary conditions—periodic, closed-wall, and inflow-outflow—and to verify that the discrete implementation conserves total tracer mass.\n\nThe fundamental principle is the conservation of a passive tracer with concentration $C(x,t)$ advected by a velocity field $u(x,t)$, described by the continuity equation in one dimension:\n$$\n\\frac{\\partial C}{\\partial t} + \\frac{\\partial}{\\partial x}(uC) = 0\n$$\nHere, the term $F(x,t) = u(x,t)C(x,t)$ represents the advective flux of the tracer.\n\nTo derive a numerical scheme, we employ the finite-volume method, which is predicated on the integral form of the conservation law. We integrate the equation over a control volume, or cell, $i$, which spans the spatial interval $[x_{i-1/2}, x_{i+1/2}]$ of width $\\Delta x$.\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial C}{\\partial t} \\,dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial F}{\\partial x} \\,dx = 0\n$$\nUsing the Leibniz integral rule and the Fundamental Theorem of Calculus, this becomes:\n$$\n\\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} C \\,dx + \\left[ F(x_{i+1/2},t) - F(x_{i-1/2},t) \\right] = 0\n$$\nWe define the cell-averaged concentration as $C_i(t) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} C(x,t) \\,dx$. The problem specifies a staggered grid where tracer concentrations $C_i$ are defined at cell centers and velocities $u_j$ are at cell faces. The face at $x_{i+1/2}$ is denoted by index $j=i+1$, and the face at $x_{i-1/2}$ by index $j=i$. The semi-discrete equation for cell $i$ is then:\n$$\n\\frac{d C_i}{dt} = -\\frac{1}{\\Delta x} \\left( F_{i+1} - F_i \\right)\n$$\nwhere $F_j$ is the flux at face $j$. Discretizing in time with an explicit forward Euler scheme of step size $\\Delta t$ yields the fully discrete update equation:\n$$\nC_i^{n+1} = C_i^n - \\frac{\\Delta t}{\\Delta x} \\left( F_{i+1}^n - F_i^n \\right)\n$$\nwhere the superscript $n$ denotes the time level $t = n\\Delta t$.\n\nThe crucial step is the definition of the face flux $F_j^n$. For stability, we use a first-order upwind scheme. The tracer concentration used to compute the flux at a face is taken from the cell \"upwind\" of the face, i.e., the cell from which the flow originates. Given a velocity $u_j$ at face $j$, the upwind flux is:\n$$\nF_j^n = u_j \\, C_{j}^{\\mathrm{upwind}, n} = \\begin{cases} u_j C_{j-1}^n & \\text{if } u_j > 0 \\\\ u_j C_j^n & \\text{if } u_j < 0 \\\\ 0 & \\text{if } u_j = 0 \\end{cases}\n$$\nThis formula applies to interior faces $j \\in \\{1, \\dots, N-1\\}$. For the boundary faces, $j=0$ and $j=N$, the fluxes are determined by the specified boundary conditions.\n\n1.  **Periodic Boundary Condition**: The domain wraps around such that cell $i=-1$ is equivalent to cell $i=N-1$, and cell $i=N$ is equivalent to cell $i=0$.\n    -   At the left boundary (face $j=0$): If $u_0 > 0$, the upwind cell is $C_{-1}$, which is $C_{N-1}$. Thus, $F_0^n = u_0 C_{N-1}^n$. If $u_0 < 0$, the upwind cell is $C_0$, so $F_0^n = u_0 C_0^n$.\n    -   At the right boundary (face $j=N$): If $u_N > 0$, the upwind cell is $C_{N-1}$, so $F_N^n = u_N C_{N-1}^n$. If $u_N < 0$, the upwind cell is $C_N$, which is $C_0$. Thus, $F_N^n = u_N C_0^n$.\n\n2.  **Closed-Wall Boundary Condition**: This condition imposes zero normal flux at the domain boundaries.\n    -   At the left boundary (face $j=0$): $F_0^n = 0$.\n    -   At the right boundary (face $j=N$): $F_N^n = 0$.\n\n3.  **Inflow–Outflow Boundary Condition**: The flux depends on the flow direction relative to the domain.\n    -   At the left boundary (face $j=0$): If $u_0 > 0$ (inflow), a prescribed concentration $C_{\\mathrm{in,L}}$ is used, so $F_0^n = u_0 C_{\\mathrm{in,L}}$. If $u_0 < 0$ (outflow), the flux is determined by the interior concentration, $F_0^n = u_0 C_0^n$.\n    -   At the right boundary (face $j=N$): If $u_N > 0$ (outflow), the flux is determined by the interior, $F_N^n = u_N C_{N-1}^n$. If $u_N < 0$ (inflow), a prescribed concentration $C_{\\mathrm{in,R}}$ is used, so $F_N^n = u_N C_{\\mathrm{in,R}}$.\n\nThe core of the task is to verify discrete mass conservation. The total mass in the domain at time step $n$ is $M^n = A \\sum_{i=0}^{N-1} C_i^n \\Delta x$. The principle of conservation dictates that the change in total mass over a period must equal the time-integrated net flux across the boundaries. The discrete mass balance residual, $R$, is defined to be zero if conservation holds:\n$$\nR = \\left( M^{n_{\\mathrm{end}}} - M^0 \\right) - \\Delta t \\, A \\sum_{n=0}^{n_{\\mathrm{end}}-1} \\left( F_0^n - F_N^n \\right)\n$$\nA correctly implemented conservative scheme will yield a residual $R$ on the order of floating-point machine precision. The numerical implementation will calculate this residual for the four specified test cases. For each case, the Courant number $\\mathcal{C} = \\frac{|u|\\Delta t}{\\Delta x}$ is confirmed to be less than or equal to $1$, ensuring the stability of the explicit time-stepping scheme.",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(params):\n    \"\"\"\n    Runs a single 1D advection simulation and computes the mass conservation residual.\n    \"\"\"\n    L = params['L']\n    N = params['N']\n    u_val = params['u']\n    dt = params['dt']\n    n_end = params['n_end']\n    bc_type = params['bc_type']\n    ic_func = params['ic_func']\n    bc_params = params.get('bc_params', {})\n    \n    # Grid and constants\n    dx = L / N\n    A = 1.0  # Cross-sectional area in m^2\n\n    # Check Courant stability condition\n    courant_number = abs(u_val) * dt / dx\n    if courant_number > 1.0:\n        # This is a check; the problem statement assures this is not violated.\n        raise ValueError(f\"Courant number {courant_number} > 1, simulation will be unstable.\")\n\n    # Staggered grid setup\n    x_centers = (np.arange(N) + 0.5) * dx\n    u = np.full(N + 1, u_val) # Velocities at N+1 faces\n\n    # Initial condition and mass\n    C = ic_func(x_centers, L, N)\n    M_initial = np.sum(C) * dx * A\n    \n    total_net_bdy_flux_integral = 0.0\n\n    # Time-stepping loop\n    for _ in range(n_end):\n        F = np.zeros(N + 1) # Fluxes at N+1 faces\n\n        # Interior fluxes (faces j=1 to N-1)\n        # Compact upwind formulation\n        u_val_pos = max(u_val, 0.0)\n        u_val_neg = min(u_val, 0.0)\n        F[1:N] = u_val_pos * C[:-1] + u_val_neg * C[1:]\n\n        # Boundary fluxes (faces j=0 and j=N)\n        if bc_type == 'periodic':\n            F[0] = u_val_pos * C[N-1] + u_val_neg * C[0]\n            F[N] = u_val_pos * C[N-1] + u_val_neg * C[0]\n        elif bc_type == 'closed_wall':\n            F[0] = 0.0\n            F[N] = 0.0\n        elif bc_type == 'inflow_outflow':\n            C_in_L = bc_params['C_in_L']\n            C_in_R = bc_params['C_in_R']\n            # Left boundary (j=0)\n            F[0] = u_val_pos * C_in_L + u_val_neg * C[0]\n            # Right boundary (j=N)\n            F[N] = u_val_pos * C[N-1] + u_val_neg * C_in_R\n\n        # Accumulate the time integral of net boundary flux\n        total_net_bdy_flux_integral += (F[0] - F[N]) * A * dt\n\n        # Update concentrations for all cells\n        C += -(dt / dx) * (F[1:] - F[:-1])\n\n    # Final mass\n    M_final = np.sum(C) * dx * A\n\n    # Calculate residual\n    residual = (M_final - M_initial) - total_net_bdy_flux_integral\n    return residual\n\ndef solve():\n    \"\"\"\n    Defines test cases, runs simulations, and prints results.\n    \"\"\"\n    test_cases = [\n        { # Case 1: Periodic\n            'L': 1000.0, 'N': 100, 'u': 1.0, 'dt': 5.0, 'n_end': 20,\n            'bc_type': 'periodic',\n            'ic_func': lambda x, L, N: 1.0 + 0.5 * np.sin(2 * np.pi * x / L)\n        },\n        { # Case 2: Closed-wall\n            'L': 100.0, 'N': 50, 'u': 2.0, 'dt': 0.5, 'n_end': 25,\n            'bc_type': 'closed_wall',\n            'ic_func': lambda x, L, N: np.exp(-(x - L/3.0)**2 / (2 * (L/20.0)**2))\n        },\n        { # Case 3: Inflow-Outflow, u > 0\n            'L': 200.0, 'N': 100, 'u': 0.5, 'dt': 2.0, 'n_end': 50,\n            'bc_type': 'inflow_outflow',\n            'ic_func': lambda x, L, N: np.zeros(N),\n            'bc_params': {'C_in_L': 2.0, 'C_in_R': 0.5}\n        },\n        { # Case 4: Inflow-Outflow, u < 0\n            'L': 300.0, 'N': 60, 'u': -0.8, 'dt': 3.0, 'n_end': 30,\n            'bc_type': 'inflow_outflow',\n            'ic_func': lambda x, L, N: np.ones(N),\n            'bc_params': {'C_in_L': 0.7, 'C_in_R': 3.0}\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        residual = run_simulation(params)\n        results.append(residual)\n\n    # Format output as specified: one digit before '.', six after, scientific notation\n    formatted_results = [f\"{r:.6e}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}