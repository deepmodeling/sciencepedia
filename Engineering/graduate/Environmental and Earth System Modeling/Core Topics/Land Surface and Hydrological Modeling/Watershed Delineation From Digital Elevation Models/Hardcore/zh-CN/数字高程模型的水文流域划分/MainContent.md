## 引言
流域，作为[地表径流](@entry_id:1132694)汇集的自然单元，是理解和管理[水循环](@entry_id:144834)、地貌演化及生态过程的基本空间尺度。在数字时代，从数字高程模型（DEM）中自动、精确地划分流域边界和河网，已成为水文学、地球系统科学及相关领域的一项基础而关键的技术。然而，这一看似直观的过程背后，蕴含着一套严谨的计算原理和必须审慎处理的技术细节，若处理不当，将导致错误的分析结果。本文旨在系统性地揭开这一过程的“黑箱”，为读者提供一个从理论到实践的全面指南。

在接下来的内容中，您将首先通过“**原理与机制**”一章，深入学习流域划分的核心算法，从DEM的[数据结构](@entry_id:262134)、水文修正的必要性，到D8、D∞等经典流向算法的计算细节，再到[流量累积](@entry_id:1125097)和河网提取的数学基础。随后，“**应用与跨学科联系**”一章将视野拓宽，展示这些技术如何在[水文建模](@entry_id:1126276)、地貌分析、生态研究甚至生物医学成像等不同领域中发挥关键作用，揭示其强大的通用性。最后，“**动手实践**”部分将理论付诸行动，通过具体的编程练习，引导您亲手实现流[域划分](@entry_id:748628)的核心步骤，巩固所学知识。通过这一结构化的学习路径，您将能够掌握从DEM划分流域的全套技能，并理解其在科学研究中的深远意义。

## 原理与机制

本章将深入探讨从数字高程模型（DEM）中划分流域所涉及的核心原理和计算机制。我们将从地形的数字表示法开始，逐步讲解[数据预处理](@entry_id:197920)、流向计算、[流量累积](@entry_id:1125097)，最终到流域和河网的精确划分。本章旨在为读者提供一个系统而严谨的理论框架，以理解和应用这些在水文学和地球[系统建模](@entry_id:197208)中至关重要的技术。

### 地形表示：数字高程模型

流域分析的基石是地形的数字表示。数字高程模型（Digital Elevation Model, DEM）是在规则或不规则的水平点集上对地面高程进行采样的离散表示。为了进行水流模拟，我们必须理解这些模型的结构及其对表面几何形态（如坡度和曲率）的描述能力。

#### 栅格与不规则三角网（TIN）

地形数据最常见的两种结构是栅格（Raster）和不规则三角网（Triangulated Irregular Network, TIN）。

- **栅格DEM** 在一个规则的二维网格上存储高程值。每个网格单元（或像素）代表一个特定区域，其值通常对应于单元中心或角点的高程。栅格的简单性和规则结构使其非常适合进行基于网格的计算，例如本章将要讨论的流向算法。在栅格单元内部，高程通常通过其四个角点的高程进行**[双线性插值](@entry_id:170280)**（bilinear interpolation）来估算。

- **不规则三角网（TIN）** 由一组不规则分布的顶点（包含$x, y, z$坐标）通过一系列边连接而成，形成一个连续的、不重叠的三角面网络。TIN能够通过在地形变化剧烈的区域增加顶点密度，在地形平坦的区域减少顶点密度，从而高效地表示地形。在每个三角面内，高程通过**平面插值**（planar interpolation）确定，即每个三角形都是一个具有恒定坡度和坡向的平面。

一个关键的理论要点是，无论是栅格的[双线性插值](@entry_id:170280)还是TIN的平面插值，所生成的连续表面在数学上都具有$C^0$连续性，即高程$z(x,y)$在整个定义域上是连续的，没有间断。然而，这两种模型在元素边界处（栅格单元的边界或TIN三角形的边）通常不具有$C^1$连续性。这意味着坡度（即高程梯度$\nabla z$）在穿过这些边界时会发生突变。例如，对于共享一条边的两个相邻TIN三角形，它们各自代表的平面具有不同的倾斜度，导致坡度在边界上不连续。同样，对于栅格，跨越单元边界的法向坡度通常也不连续。这种坡度的不连续性是离散地形模型的一个内在属性，对基于梯度的流向计算具有重要影响。

#### DEM, DTM 与 DSM：关键术语辨析

在进行水文分析时，精确理解不同类型高程模型的含义至关重要，因为它们代表了不同的地表。

- **数字表面模型（Digital Surface Model, DSM）** 表示地球表面上所有物体的最高点高程，包括植被冠层、建筑物屋顶和其它人造结构。它通常是由传感器（如LiDAR）的“首次回波”生成的。

- **[数字地形模型](@entry_id:1123737)（Digital Terrain Model, DTM）** 或狭义上的 **数字高程模型（DEM）** 表示的是“裸露地表”（bare-earth）的高程。它是通过从原始数据（如[LiDAR点云](@entry_id:1127195)）中滤除植被和建筑物等非地面点后生成的。

地表径流发生在裸露地表上，其路径由地形的坡度决定。水流模拟算法通过计算高程场$z(x,y)$的负梯度$-\nabla z$来确定流向。如果使用DSM，算法会将树冠和建筑屋顶误判为山脊和障碍物，从而计算出完全不符合物理现实的流路（例如，水流在树顶之间流动或在屋顶上汇集）。因此，进行流域划分和地表径流模拟时，**必须使用代表裸露地表的DTM或DEM**。使用DSM将导致严重的流路错误和不准确的流域边界。

### DEM[预处理](@entry_id:141204)：水文修正

原始的裸露地表DEM通常含有由[数据采集](@entry_id:273490)、插值或量化过程引入的伪影，这些伪影会阻碍或误导水流模拟。因此，在进行流向计算之前，必须对DEM进行**水文修正**（hydrologic conditioning），以确保水流路径的连续性和物理真实性。

#### 洼地、平坦区与伪影

水文修正主要处理两类问题：洼地（depressions）和平坦区（flats）。

- **洼地（Depressions）** 或 **汇（Sinks）** 是一个或一组栅格单元，其高程低于所有相邻单元。水流进入洼地后，由于没有更低的出口，模拟水流会被“困住”。这些洼地有些是真实的地貌特征，如喀斯特地区的落水洞或**内流盆地（endorheic basins）**，它们在水文上是封闭的，没有[地表径流](@entry_id:1132694)出口。然而，DEM中的绝大多数洼地是由于测量误差或数据处理产生的**伪影（spurious artifacts）**。

- **平坦区（Flats）** 是一片高程相同或坡度极小的相连区域。在这些区域，流向是不确定的，会导致算法中断或产生不真实的平行流路。

区分真实的内流盆地和虚假的洼地至关重要。一个真实的内流盆地通常是一个宏观的地貌单元，其封闭状态在DEM数据存在一定不确定性（例如，受垂直精度$\sigma_z$影响的微小扰动）的情况下依然保持稳定。相比之下，由数据伪影造成的洼地通常深度很小（在$\sigma_z$的量级上），形态不自然（如单个像素的凹陷），并且可以通过对DEM进行微小的、在不确定性范围内的调整来消除。

#### 填洼与挖穿

处理这些伪影的两种主要方法是**填洼（pit filling）**和**挖穿（breach carving）**。

- **填洼**：该方法识别出洼地区域，并找到其边界上的最低点，即**溢出点（spill point）**。然后，算法将洼地内所有单元的高程提升至该[溢出](@entry_id:172355)点的高程，从而创建一个平坦的表面，使得水流可以“溢出”并继续向下游流动。

- **挖穿**（或称“河道烧入”）：该方法不是抬高洼地，而是在阻碍水流的“堤坝”上挖出一条通道。它通过降低特定单元的高程，重新建立上游和下游之间的水力连通性。

选择哪种方法取决于伪影的性质和可用的辅助信息。例如，考虑一个常见的场景：一条建在路堤上的公路横穿一条已知的河流，而DEM中包含了这个路堤，形成了一道人为的“水坝”。尽管实地存在一个涵洞让河流通过，但在DEM上，河流上游区域变成了一个洼地。此时，如果采用填洼法，算法会将河流上游整个山谷填充到路堤顶部的高程（如104.0米），模拟出一条极不真实的水流路径，即水流在蓄满后翻越路堤。而挖穿法则更为合理，它利用了涵洞存在的先验知识，在DEM的路堤上沿着河流的真实路径“挖”出一条通道，其高程与实际的涵洞底部高程（如101.5米）相符。这样可以保持真实的河流连通性，避免产生巨大的人工平坦区，从而得到更准确的流域模拟结果。因此，当面对由道路、桥梁等线性工程设施造成的障碍时，**挖穿通常是水文上更优越的选择**。

### 模拟水流：从高程到流路

经过水文修正后，DEM便可以用来模拟水流路径。这一过程的核心是从离散的高程数据中计算出每个点的流向。

#### 基本地形属性：坡度与坡向

水流方向由地形的**最陡[下降方向](@entry_id:637058)**决定，这在数学上对应于高程[梯度向量](@entry_id:141180)$\nabla z$的负方向。在栅格DEM中，梯度$\nabla z = (p, q)$的两个分量$p = \frac{\partial z}{\partial x}$ 和 $q = \frac{\partial z}{\partial y}$ 可以通过**中心差分**格式进行估算。假设$x$方向（东）和$y$方向（北）的栅格间距分别为$\Delta x$和$\Delta y$，则在中心单元$(i,j)$处：
$$ p = \frac{z_{i+1,j} - z_{i-1,j}}{2\Delta x} $$
$$ q = \frac{z_{i,j+1} - z_{i,j-1}}{2\Delta y} $$

基于这两个梯度分量，我们可以定义两个关键的地形属性：

- **坡度（Slope）**：坡度角$\beta$的**正切值**等于梯度的大小，它表示地形最陡峭的程度。
  $$ \tan\beta = \lVert \nabla z \rVert = \sqrt{p^2 + q^2} $$

- **坡向（Aspect）**：坡向$\theta$是最陡**下降**方向的方位角。最陡上升方向的向量是$\nabla z = (p, q)$，因此最陡[下降方向](@entry_id:637058)的向量是$-\nabla z = (-p, -q)$。坡向通常定义为从正北方向顺时针测量的角度。为了在所有象限都获得正确结果，我们使用双参数反正切函数$\operatorname{atan2}(Y, X)$。在此定义下，$Y$分量对应东向（-p），$X$分量对应北向（-q）。因此，坡向的计算公式为：
  $$ \theta = \operatorname{atan2}(-p, -q) $$
  这个公式返回的弧度值通常需要转换为$[0, 2\pi)$的范围。

#### 流向算法

流向算法将连续的坡度与坡向信息转化为栅格上离散的流向指针。

- **[D8算法](@entry_id:1123350)（Deterministic Eight-direction）**：D8是最经典和广泛使用的**单流向算法**。对于每个中心单元，它计算流向其8个相邻单元（东、南、西、北、东南、西南、西北、东北）的坡度。坡度的计算必须考虑距离的差异：对于4个基本方位（东、南、西、北），距离为栅格尺寸$r$；对于4个对角线方位，距离为$\sqrt{2}r$。因此，从中心单元$c$到邻居$k$的坡度为：
  $$ s_k = \frac{z_c - z_k}{d_k} $$
  其中$d_k$是对应的距离。[D8算法](@entry_id:1123350)将流向指定给具有最大正坡度$s_k$的那个邻居。由于是“确定性”算法，当多个邻居具有相同的最大坡度时，必须采用一个固定的**平局打破规则**（tie-breaking strategy），例如预设一个优先级顺序（如从北开始顺时针搜索），以确保结果的可复现性。

- **D∞算法（Deterministic Infinity）**：[D8算法](@entry_id:1123350)将流向强制约束在8个离散方向上，可能导致网格偏误。D∞算法是一种**多流向算法**，它通过拟合局部平面来计算一个连续的流向角。该算法考虑由中心单元及其每对相邻邻居构成的8个三角面片。对于每个三角面片，它拟合一个平面$z(x,y) = ax+by+c$，并计算出该平面的最陡[下降方向](@entry_id:637058)$-\nabla z = (-a,-b)$。这个方向被限制在该三角面片的[方位角](@entry_id:164011)范围内。算法最终选择所有面片中可行的、坡度最大的那个方向作为最终流向$\theta$。由于$\theta$是一个连续的角度，它通常会落在一个三角面片的两个邻居之间。因此，D∞算法将水流按照几何比例**分配**给这两个下游邻居。例如，在一个由中心、东（E）和东南（SE）邻居构成的面片上，如果计算出的最陡坡降方向$\theta \approx -26.6^\circ$（介于东方$0^\circ$和东南方$-45^\circ$之间），且该方向的坡降最大，那么水流将被分配给东和东南两个邻居。分配权重可以通过流向射线与两个邻居连线的交点位置来确定。

### 流域与河网的划分

在确定了整个DEM的流向网络之后，我们便可以进行更高层次的水文分析。

#### [流量累积](@entry_id:1125097)及其物理意义

**[流量累积](@entry_id:1125097)（Flow Accumulation）**是后续所有分析的核心。对于给定的流向网络，每个栅格单元的[流量累积](@entry_id:1125097)值$A(\mathbf{x})$被定义为所有汇入该单元（包括该单元自身）的上游栅格单元的总数。这是一个递归过程，可以通过从上游到下游遍历栅格来高效计算：
$$ A(i) = 1 + \sum_{j \text{流入} i} A(j) $$
其中$j \text{流入} i$表示所有流向单元$i$的上游邻居。

[流量累积](@entry_id:1125097)值本身是一个纯粹的几何量（单元计数），但它与一个关键的物理量——**径流量（Discharge）**——有着直接的联系。假设在整个流域上存在一个空间均匀的净降雨强度$i_e$（单位时间单位面积的降雨深度），并且系统处于[稳态](@entry_id:139253)。根据质量守恒定律，流出任一单元$\mathbf{x}$的[稳态](@entry_id:139253)径流量$Q(\mathbf{x})$等于其上游所有单元产生的净径流的总和。如果每个栅格单元的面积为$a_c$，则$Q(\mathbf{x})$与[流量累积](@entry_id:1125097)值$A(\mathbf{x})$成正比：
$$ Q(\mathbf{x}) = i_e \cdot a_c \cdot A(\mathbf{x}) $$
因此，[流量累积](@entry_id:1125097)栅格可以被视为径流量的一个[空间分布](@entry_id:188271)代理图，其值越高的区域对应于径流量越大的河道。

#### 河网提取与流域划分

有了[流量累积](@entry_id:1125097)栅格后，提取河网和划分流域就变得直接了。

- **河网提取**：河道是水流汇集的地方。我们可以通过设定一个[流量累积](@entry_id:1125097)的**阈值**$A_{\text{thr}}$来定义河道的起始点。所有[流量累积](@entry_id:1125097)值大于$A_{\text{thr}}$的栅格单元被识别为河道的一部分。这个阈值代表了形成稳定河道所需的最小汇水面积。

- **流域划分**：一个流域（或汇水盆地）被定义为所有最终汇入一个特定**出水口（outlet）**或**倾泻点（pour point）**的区域。一旦流向网络和[流量累积](@entry_id:1125097)图被计算出来，划分流域就变成了一个追踪问题：从指定的出水口开始，递归地找出所有汇入该点的上游栅格单元。

在实践中，用户指定的出水口位置可能由于[地理配准](@entry_id:1125613)误差或栅格分辨率的限制而偏离真实的河道。如果出水口被错误地放在了[流量累积](@entry_id:1125097)值很低的山坡上，那么划分出的流域将非常小，与实际情况严重不符。为了解决这个问题，通常会采用一个名为**出水口吸附（outlet snapping）**的预处理步骤。该方法在用户指定的出水口周围的一个搜索半径内，自动寻找[流量累积](@entry_id:1125097)值最高的栅格单元，并将出水口“吸附”到该位置。这确保了出水口被精确地定位在代表主河道的栅格单元上，从而保证了流[域划分](@entry_id:748628)的稳健性和准确性。

### [尺度效应](@entry_id:153734)：DEM分辨率的影响

最后，必须认识到DEM的分辨率，即栅格尺寸$\Delta$，对流域分析的结果具有根本性的影响。选择不同分辨率的DEM会得到截然不同的河网和流域特征。

将DEM[重采样](@entry_id:142583)到一个更粗的分辨率（即增大$\Delta$），在信号处理上等同于对地形数据应用了一个低通滤波器。这个过程会平滑地形，抹去高[空间频率](@entry_id:270500)的细节。

- **最小可探测特征**：根据[采样定理](@entry_id:262499)，一个栅格能够分辨的最小地貌特征尺寸与栅格尺寸$\Delta$在同一个数量级，即$w_{\min} \sim \mathcal{O}(\Delta)$。要可靠地识别一个宽度为$w$的河谷，至少需要2到3个栅格单元横跨该河谷。因此，当$\Delta$增大时，那些宽度小于几个$\Delta$的窄小河谷将无法被分辨出来。

- **对河网密度的影响**：这种平滑效应直接导致了所提取的**河网密度（Drainage Density）**的降低。河网密度定义为河道总长度与流域面积之比。当分辨率变粗时，许多小型的、一级的支流（即河网的“毛细血管”）因为其所在的微小沟谷被平滑掉而消失。这导致提取出的河网总长度$L_{\text{total}}$显著减小，进而使得河网密度$D$降低。因此，更粗分辨率的DEM会产生一个更稀疏、更简化的河网结构。

理解分辨率的这种尺度效应至关重要，因为它决定了模型能够捕捉到的水文过程的尺度。任何基于DEM的流域分析都必须明确其所用数据的分辨率，并认识到这一选择对结果的内在约束。