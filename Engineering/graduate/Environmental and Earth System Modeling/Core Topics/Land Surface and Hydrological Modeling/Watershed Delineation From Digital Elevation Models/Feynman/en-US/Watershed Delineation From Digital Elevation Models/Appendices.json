{
    "hands_on_practices": [
        {
            "introduction": "The foundation of any watershed analysis on a Digital Elevation Model (DEM) is determining the path water will take across the terrain. The eight-direction (D8) algorithm is a cornerstone method that approximates flow by assigning a single direction from each cell to one of its eight neighbors. This exercise  provides direct, hands-on practice in applying the D8 algorithm's core principle: calculating the steepest downslope gradient, $s = (z_i - z_j)/d_{ij}$, to build a flow direction map from raw elevation data.",
            "id": "3930970",
            "problem": "Consider a square raster Digital Elevation Model (DEM) patch of size $3 \\times 3$ cells with uniform cell width $L$ and elevations given (in meters above a datum) by the following matrix, where the center cell is at row $2$, column $2$:\n$$\n\\begin{pmatrix}\n90 & 95 & 90 \\\\\n95 & 100 & 95 \\\\\n92 & 95 & 92\n\\end{pmatrix}\n$$ .\nAssume $L = 30\\,\\mathrm{m}$, and that planimetric neighbor distances are $d_{\\text{cardinal}} = L$ for cardinal neighbors and $d_{\\text{diagonal}} = \\sqrt{2}\\,L$ for diagonal neighbors. Use the eight-direction (D8) algorithm, defined as follows: for a cell $i$ with elevation $z_i$, the candidate downslope direction to a neighbor $j$ is chosen by maximizing the local slope\n$$\ns_{i \\to j} = \\frac{z_i - z_j}{d_{ij}},\n$$\nover all neighboring cells $j$ within the DEM patch, subject to $z_i \\ge z_j$ (downslope or flat). If $s_{i \\to j} = 0$ for all neighbors $j$ or $z_i < z_j$ for all neighbors $j$, the cell is a pit or flat and has no unique downslope direction without depression-handling. A tie case is defined as the occurrence of two or more distinct neighbors $j$ with exactly equal maximal $s_{i \\to j}$ among the admissible neighbors.\n\nApply the above definition to compute the D8 flow directions for the center cell and each of its $8$ neighbors, restricting attention to neighbors that lie within the $3 \\times 3$ patch (ignore any out-of-patch cells). Then, identify and count the number of tie cases that require explicit resolution among these $9$ cells. Report as your final answer the total number of tie cases in the patch. Express your final answer as an integer; no rounding is required.",
            "solution": "The problem is subjected to validation.\n\n### Step 1: Extract Givens\n- A $3 \\times 3$ square raster Digital Elevation Model (DEM).\n- Cell width $L = 30\\,\\mathrm{m}$.\n- Elevation matrix $Z$:\n$$\nZ = \\begin{pmatrix}\n90 & 95 & 90 \\\\\n95 & 100 & 95 \\\\\n92 & 95 & 92\n\\end{pmatrix}\n$$\n- Planimetric neighbor distances: $d_{\\text{cardinal}} = L$ and $d_{\\text{diagonal}} = \\sqrt{2}\\,L$.\n- D8 algorithm rule: choose the downslope direction to a neighbor $j$ from a cell $i$ by maximizing the slope $s_{i \\to j} = \\frac{z_i - z_j}{d_{ij}}$, subject to the condition that flow is downslope or flat, i.e., $z_i \\ge z_j$.\n- Definition of a pit or flat: a cell where $s_{i \\to j} = 0$ for all neighbors $j$ or $z_i < z_j$ for all neighbors $j$.\n- Definition of a tie case: Two or more distinct neighbors $j$ have the same maximal slope $s_{i \\to j}$ among all admissible neighbors.\n- Task: Compute flow directions for all $9$ cells, considering only neighbors within the $3 \\times 3$ patch, and count the total number of tie cases.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is based on the D8 flow direction algorithm, a fundamental and widely used method in hydrology and geographic information science (GIS) for modeling surface water flow from DEMs. The setup is a standard, textbook-style exercise. The principles are scientifically sound.\n- **Well-Posed**: The problem is self-contained. It provides all necessary data (elevation grid, cell size, distance definitions) and a precise, unambiguous algorithm for determining flow direction and identifying ties. The boundary condition (restricting neighbors to within the patch) is clearly stated. A unique integer solution exists.\n- **Objective**: The problem is stated in precise, quantitative, and objective language, free of any subjective or speculative content.\n\n### Step 3: Verdict and Action\nThe problem is valid as it is scientifically grounded, well-posed, and objective. There are no identifiable flaws. A solution will be derived.\n\nThe solution proceeds by systematically analyzing each of the $9$ cells in the DEM patch. Let a cell be denoted by its row and column index $(r, c)$, and its elevation by $z_{rc}$. The cell width is $L = 30\\,\\mathrm{m}$. The slope to a neighbor is given by $s = \\frac{\\Delta z}{d}$, where $\\Delta z$ is the elevation drop and $d$ is the distance. For cardinal neighbors, $d=L$. For diagonal neighbors, $d=\\sqrt{2}L$. We seek to maximize this slope for each cell, considering only neighbors with $z_j \\le z_i$.\n\nLet us analyze each cell:\n\n**Cell (1,1): $z_{11} = 90$**\nNeighbors within the patch are $(1,2)$, $(2,1)$, and $(2,2)$, with elevations $z_{12}=95$, $z_{21}=95$, and $z_{22}=100$. All neighbors have a higher elevation ($z_j > z_{11}$). According to the problem definition, this cell is a pit. There are no admissible downslope or flat neighbors, so a tie case is not possible.\nNumber of tie cases for $(1,1)$: $0$.\n\n**Cell (1,2): $z_{12} = 95$**\nAdmissible neighbors $j$ (where $z_j \\le 95$) are:\n- $(1,1)$: $z_{11}=90$. Cardinal. $s_{12 \\to 11} = \\frac{95 - 90}{L} = \\frac{5}{L}$.\n- $(1,3)$: $z_{13}=90$. Cardinal. $s_{12 \\to 13} = \\frac{95 - 90}{L} = \\frac{5}{L}$.\n- $(2,1)$: $z_{21}=95$. Diagonal. $s_{12 \\to 21} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\n- $(2,3)$: $z_{23}=95$. Diagonal. $s_{12 \\to 23} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\nThe maximum slope is $\\frac{5}{L}$. This slope occurs for two distinct neighbors: $(1,1)$ and $(1,3)$. This constitutes a tie case.\nNumber of tie cases for $(1,2)$: $1$.\n\n**Cell (1,3): $z_{13} = 90$**\nNeighbors within the patch are $(1,2)$, $(2,2)$, and $(2,3)$, with elevations $z_{12}=95$, $z_{22}=100$, and $z_{23}=95$. All neighbors are higher. This is a pit.\nNumber of tie cases for $(1,3)$: $0$.\n\n**Cell (2,1): $z_{21} = 95$**\nAdmissible neighbors $j$ (where $z_j \\le 95$) are:\n- $(1,1)$: $z_{11}=90$. Cardinal. $s_{21 \\to 11} = \\frac{95 - 90}{L} = \\frac{5}{L}$.\n- $(3,1)$: $z_{31}=92$. Cardinal. $s_{21 \\to 31} = \\frac{95 - 92}{L} = \\frac{3}{L}$.\n- $(1,2)$: $z_{12}=95$. Diagonal. $s_{21 \\to 12} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\n- $(3,2)$: $z_{32}=95$. Diagonal. $s_{21 \\to 32} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\nThe maximum slope is $\\frac{5}{L}$, which corresponds to a unique neighbor, $(1,1)$. No tie case occurs.\nNumber of tie cases for $(2,1)$: $0$.\n\n**Cell (2,2): $z_{22} = 100$**\nAll $8$ neighbors are at lower elevations and are thus admissible.\n- Cardinal neighbors ($d=L$): $(1,2)$, $(2,1)$, $(2,3)$, $(3,2)$. All have $z=95$. The slope is $s = \\frac{100 - 95}{L} = \\frac{5}{L}$ for all four.\n- Diagonal neighbors ($d=\\sqrt{2}L$):\n  - $(1,1)$, $z_{11}=90$: $s = \\frac{100 - 90}{\\sqrt{2}L} = \\frac{10}{\\sqrt{2}L} = \\frac{5\\sqrt{2}}{L}$.\n  - $(1,3)$, $z_{13}=90$: $s = \\frac{100 - 90}{\\sqrt{2}L} = \\frac{10}{\\sqrt{2}L} = \\frac{5\\sqrt{2}}{L}$.\n  - $(3,1)$, $z_{31}=92$: $s = \\frac{100 - 92}{\\sqrt{2}L} = \\frac{8}{\\sqrt{2}L} = \\frac{4\\sqrt{2}}{L}$.\n  - $(3,3)$, $z_{33}=92$: $s = \\frac{100 - 92}{\\sqrt{2}L} = \\frac{8}{\\sqrt{2}L} = \\frac{4\\sqrt{2}}{L}$.\nTo compare the slopes, we compare the values $\\frac{5}{L}$, $\\frac{5\\sqrt{2}}{L}$, and $\\frac{4\\sqrt{2}}{L}$. Since $\\sqrt{2} \\approx 1.414$, we have $5\\sqrt{2} \\approx 7.07$ and $4\\sqrt{2} \\approx 5.66$. The maximum slope is $\\frac{5\\sqrt{2}}{L}$. This slope occurs for two distinct neighbors: $(1,1)$ and $(1,3)$. This is a tie case.\nNumber of tie cases for $(2,2)$: $1$.\n\n**Cell (2,3): $z_{23} = 95$**\nAdmissible neighbors $j$ (where $z_j \\le 95$) are:\n- $(1,3)$: $z_{13}=90$. Cardinal. $s_{23 \\to 13} = \\frac{95 - 90}{L} = \\frac{5}{L}$.\n- $(3,3)$: $z_{33}=92$. Cardinal. $s_{23 \\to 33} = \\frac{95 - 92}{L} = \\frac{3}{L}$.\n- $(1,2)$: $z_{12}=95$. Diagonal. $s_{23 \\to 12} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\n- $(3,2)$: $z_{32}=95$. Diagonal. $s_{23 \\to 32} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\nThe maximum slope is $\\frac{5}{L}$, which corresponds to a unique neighbor, $(1,3)$. No tie case occurs.\nNumber of tie cases for $(2,3)$: $0$.\n\n**Cell (3,1): $z_{31} = 92$**\nNeighbors within the patch are $(2,1)$, $(2,2)$, and $(3,2)$, with elevations $z_{21}=95$, $z_{22}=100$, and $z_{32}=95$. All neighbors are higher. This is a pit.\nNumber of tie cases for $(3,1)$: $0$.\n\n**Cell (3,2): $z_{32} = 95$**\nAdmissible neighbors $j$ (where $z_j \\le 95$) are:\n- $(3,1)$: $z_{31}=92$. Cardinal. $s_{32 \\to 31} = \\frac{95 - 92}{L} = \\frac{3}{L}$.\n- $(3,3)$: $z_{33}=92$. Cardinal. $s_{32 \\to 33} = \\frac{95 - 92}{L} = \\frac{3}{L}$.\n- $(2,1)$: $z_{21}=95$. Diagonal. $s_{32 \\to 21} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\n- $(2,3)$: $z_{23}=95$. Diagonal. $s_{32 \\to 23} = \\frac{95 - 95}{\\sqrt{2}L} = 0$.\nThe maximum slope is $\\frac{3}{L}$. This slope occurs for two distinct neighbors: $(3,1)$ and $(3,3)$. This constitutes a tie case.\nNumber of tie cases for $(3,2)$: $1$.\n\n**Cell (3,3): $z_{33} = 92$**\nNeighbors within the patch are $(2,2)$, $(2,3)$, and $(3,2)$, with elevations $z_{22}=100$, $z_{23}=95$, and $z_{32}=95$. All neighbors are higher. This is a pit.\nNumber of tie cases for $(3,3)$: $0$.\n\n**Total Count**\nSumming the number of tie cases from all $9$ cells:\nTotal ties = $0 + 1 + 0 + 0 + 1 + 0 + 0 + 1 + 0 = 3$.\nThe total number of tie cases in the patch is $3$.",
            "answer": "$$\\boxed{3}$$"
        },
        {
            "introduction": "Real-world DEMs are rarely perfect and often contain cells or regions called depressions (or pits) that are lower than all their neighbors, which can artificially trap flow. Before delineating a complete watershed, these features must be identified and handled in a process called hydrologic conditioning. This practice  moves beyond simple flow calculation to a crucial pre-processing step, challenging you to identify depressions and classify them as either spurious artifacts or true landscape features by applying a policy based on fill depth and external hydrographic data.",
            "id": "3931009",
            "problem": "Consider a raster Digital Elevation Model (DEM) represented on a regular grid of $5 \\times 5$ cells with square cell size $c = 30\\,\\mathrm{m}$. Let the DEM elevation at grid location $(i,j)$ (row $i$, column $j$; $i,j \\in \\{1,2,3,4,5\\}$) be denoted by $z(i,j)$ in meters above a datum. The DEM values are:\n$$\n\\begin{bmatrix}\n120 & 118 & 117 & 90 & 119 \\\\\n119 & 117 & 116 & 92 & 118 \\\\\n118 & 115 & 110 & 111 & 116 \\\\\n115 & 100 & 100 & 112 & 115 \\\\\n114 & 100 & 100 & 113 & 114 \\\\\n\\end{bmatrix}\n$$\nAssume eight-direction (D8) flow on the raster, where the eight-neighborhood $N_8(p)$ of a cell $p$ consists of its adjacent and diagonal neighbors. A single-cell pit is a cell $p$ such that for all $q \\in N_8(p)$, $z(q) > z(p)$. A multi-cell depression is a maximal connected set $S$ (connected under $N_8$) for which all cells on its external boundary $\\partial S$ are strictly higher than the minimum elevation inside $S$, that is, $\\min_{b \\in \\partial S} z(b) > \\min_{s \\in S} z(s)$. The spill elevation $z_s(S)$ of a depression $S$ is defined as $z_s(S) = \\min_{b \\in \\partial S} z(b)$, and its fill depth (depression depth) is $d(S) = z_s(S) - \\min_{s \\in S} z(s)$. For a single-cell pit $p$, define $z_s(\\{p\\}) = \\min_{q \\in N_8(p)} z(q)$ and $d(\\{p\\}) = z_s(\\{p\\}) - z(p)$.\n\nAssume the DEM has a vertical uncertainty (one-sigma) of $\\sigma_z = 1\\,\\mathrm{m}$. A hydrologic enforcement policy classifies a depression $S$ as spurious if $d(S) < 3\\sigma_z$ and $S$ is not coincident with an external hydrographic feature; otherwise, it is classified as true (to be preserved). An auxiliary hydrographic dataset provides a lake polygon that exactly overlaps the four-cell block $\\{(4,2),(4,3),(5,2),(5,3)\\}$.\n\nBased on the definitions and the given policy, identify all pits (including any multi-cell depressions) in the grid and classify each as spurious or true. Choose the option that correctly lists the pit set(s) and their classification.\n\nA. Pits are $\\{(1,4)\\}$ classified spurious, and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true.\n\nB. Pits are $\\{(1,4)\\}$ classified true (because $z(1,4)$ is far lower than its neighbors), and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true.\n\nC. Pits are $\\{(1,4),(2,4)\\}$ classified spurious, and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified spurious (because equal-elevation flats cannot be true depressions).\n\nD. The only pit is $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true; $\\{(1,4)\\}$ is not a pit because it spills at $z=92\\,\\mathrm{m}$.",
            "solution": "The user has provided a problem concerning the identification and classification of pits and depressions in a Digital Elevation Model (DEM).\n\n### Problem Validation\nThe problem statement is evaluated for validity.\n\n**Step 1: Extract Givens**\n- **DEM Grid**: A $5 \\times 5$ regular grid with cell size $c = 30\\,\\mathrm{m}$.\n- **Grid Indexing**: $(i,j)$ for row $i$, column $j$, where $i,j \\in \\{1,2,3,4,5\\}$.\n- **Elevation Data $z(i,j)$**:\n$$\n\\begin{bmatrix}\n120 & 118 & 117 & 90 & 119 \\\\\n119 & 117 & 116 & 92 & 118 \\\\\n118 & 115 & 110 & 111 & 116 \\\\\n115 & 100 & 100 & 112 & 115 \\\\\n114 & 100 & 100 & 113 & 114 \\\\\n\\end{bmatrix}\\,\\mathrm{m}\n$$\n- **Flow Model**: Eight-direction (D8) using the $N_8$ neighborhood.\n- **Single-Cell Pit Definition**: Cell $p$ is a pit if $z(q) > z(p)$ for all neighbors $q \\in N_8(p)$.\n- **Multi-Cell Depression Definition**: A maximal connected set $S$ where the minimum elevation on its external boundary is strictly greater than the minimum elevation within the set: $\\min_{b \\in \\partial S} z(b) > \\min_{s \\in S} z(s)$.\n- **Spill Elevation and Fill Depth Definitions**:\n  - For a depression $S$: $z_s(S) = \\min_{b \\in \\partial S} z(b)$ and $d(S) = z_s(S) - \\min_{s \\in S} z(s)$.\n  - For a single-cell pit $p$: $z_s(\\{p\\}) = \\min_{q \\in N_8(p)} z(q)$ and $d(\\{p\\}) = z_s(\\{p\\}) - z(p)$.\n- **Vertical Uncertainty**: $\\sigma_z = 1\\,\\mathrm{m}$.\n- **Classification Policy**: A depression $S$ is \"spurious\" if $d(S) < 3\\sigma_z$ and it does not coincide with an external hydrographic feature. Otherwise, it is \"true\".\n- **Hydrographic Data**: A lake polygon exactly overlaps the cell block $\\{(4,2),(4,3),(5,2),(5,3)\\}$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded in standard hydrological and GIS principles for DEM analysis. The definitions provided for pits, depressions, spill elevation, and depth are consistent with established literature. The inclusion of DEM uncertainty and ancillary hydrographic data for classification represents a common, practical workflow. The problem is well-posed, with all necessary data and definitions provided to reach a unique, verifiable solution. There are no contradictions, ambiguities, or factual errors.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A solution will be derived.\n\n### Derivation of Solution\n\nThe solution proceeds by first identifying all pits and depressions in the DEM, then calculating their properties, and finally classifying them according to the given policy.\n\n**1. Identification of Pits and Depressions**\n\nWe must systematically scan the grid for cells or groups of cells that satisfy the definitions of a pit or depression. A pit is a cell that is a strict local minimum with respect to its $N_8$ neighbors.\n\n- **Scanning for Single-Cell Pits:**\n  We examine each cell. A cell $p$ is a pit if $z(q) > z(p)$ for all its neighbors $q$.\n  - Consider cell $p_1 = (1,4)$ with elevation $z(1,4) = 90\\,\\mathrm{m}$. Its neighbors and their elevations are:\n    $z(1,3) = 117\\,\\mathrm{m}$\n    $z(1,5) = 119\\,\\mathrm{m}$\n    $z(2,3) = 116\\,\\mathrm{m}$\n    $z(2,4) = 92\\,\\mathrm{m}$\n    $z(2,5) = 118\\,\\mathrm{m}$\n    Since all neighbor elevations are strictly greater than $90\\,\\mathrm{m}$, the cell $(1,4)$ is a single-cell pit. Let's denote this depression as $S_1 = \\{(1,4)\\}$.\n  - No other cell is a single-cell pit. For any other cell, at least one neighbor has an equal or lower elevation.\n\n- **Scanning for Multi-Cell Depressions:**\n  A multi-cell depression often involves a flat area. We observe a flat area of $100\\,\\mathrm{m}$ elevation at cells $\\{(4,2), (4,3), (5,2), (5,3)\\}$. Let's test if this set forms a depression. Let $S_2 = \\{(4,2), (4,3), (5,2), (5,3)\\}$.\n  - The minimum elevation within this set is $\\min_{s \\in S_2} z(s) = 100\\,\\mathrm{m}$.\n  - The external boundary $\\partial S_2$ consists of all cells not in $S_2$ that are neighbors to any cell in $S_2$. These are:\n    $\\partial S_2 = \\{(3,1), (3,2), (3,3), (3,4), (4,1), (4,4), (5,1), (5,4)\\}$.\n  - The elevations of the boundary cells are:\n    $z(3,1) = 118\\,\\mathrm{m}$, $z(3,2) = 115\\,\\mathrm{m}$, $z(3,3) = 110\\,\\mathrm{m}$, $z(3,4) = 111\\,\\mathrm{m}$,\n    $z(4,1) = 115\\,\\mathrm{m}$, $z(4,4) = 112\\,\\mathrm{m}$,\n    $z(5,1) = 114\\,\\mathrm{m}$, $z(5,4) = 113\\,\\mathrm{m}$.\n  - The minimum elevation on the boundary is $\\min_{b \\in \\partial S_2} z(b) = z(3,3) = 110\\,\\mathrm{m}$.\n  - We check the depression condition: $\\min_{b \\in \\partial S_2} z(b) > \\min_{s \\in S_2} z(s)$. This gives $110\\,\\mathrm{m} > 100\\,\\mathrm{m}$, which is true.\n  - The set $S_2$ is connected and no other adjacent cells have an elevation of $100\\,\\mathrm{m}$, so it is a maximal connected set. Therefore, $S_2$ is a multi-cell depression.\n\nThere are two depressions in the DEM: $S_1 = \\{(1,4)\\}$ and $S_2 = \\{(4,2),(4,3),(5,2),(5,3)\\}$.\n\n**2. Classification of Depressions**\n\nThe policy states a depression $S$ is \"spurious\" if its fill depth $d(S) < 3\\sigma_z$ AND it does not coincide with a hydrographic feature. Given $\\sigma_z = 1\\,\\mathrm{m}$, the threshold is $3\\sigma_z = 3\\,\\mathrm{m}$. Otherwise, the depression is \"true\".\n\n- **Classification of $S_1 = \\{(1,4)\\}$**:\n  - The spill elevation is $z_s(S_1) = \\min_{q \\in N_8(1,4)} z(q) = z(2,4) = 92\\,\\mathrm{m}$.\n  - The fill depth is $d(S_1) = z_s(S_1) - z(1,4) = 92\\,\\mathrm{m} - 90\\,\\mathrm{m} = 2\\,\\mathrm{m}$.\n  - We check the conditions for being spurious:\n    1. Is $d(S_1) < 3\\,\\mathrm{m}$? Yes, $2\\,\\mathrm{m} < 3\\,\\mathrm{m}$.\n    2. Is $S_1$ coincident with the hydrographic feature? No, the lake is at $\\{(4,2),(4,3),(5,2),(5,3)\\}$.\n  - Both conditions are met. Thus, $S_1$ is classified as **spurious**.\n\n- **Classification of $S_2 = \\{(4,2),(4,3),(5,2),(5,3)\\}$**:\n  - The spill elevation is $z_s(S_2) = \\min_{b \\in \\partial S_2} z(b) = z(3,3) = 110\\,\\mathrm{m}$.\n  - The fill depth is $d(S_2) = z_s(S_2) - \\min_{s \\in S_2} z(s) = 110\\,\\mathrm{m} - 100\\,\\mathrm{m} = 10\\,\\mathrm{m}$.\n  - We check the conditions for being spurious. A depression is \"true\" if either condition fails.\n    1. Is $d(S_2) < 3\\,\\mathrm{m}$? No, $10\\,\\mathrm{m} \\ge 3\\,\\mathrm{m}$.\n  - Since the first condition for being spurious fails, the depression must be classified as **true**. Furthermore, the problem states that $S_2$ is coincident with a lake polygon, which is the second reason it must be classified as true.\n\n**Conclusion of Derivation:**\nThe DEM contains two depressions:\n1.  A single-cell pit at $\\{(1,4)\\}$, which is classified as **spurious**.\n2.  A multi-cell depression at $\\{(4,2),(4,3),(5,2),(5,3)\\}$, which is classified as **true**.\n\n### Option-by-Option Analysis\n\n- **A. Pits are $\\{(1,4)\\}$ classified spurious, and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true.**\n  This option correctly identifies both depressions and their respective classifications as derived above.\n  **Verdict: Correct.**\n\n- **B. Pits are $\\{(1,4)\\}$ classified true (because $z(1,4)$ is far lower than its neighbors), and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true.**\n  This option incorrectly classifies the pit at $\\{(1,4)\\}$ as true. The classification must follow the given policy, not a subjective assessment. Its fill depth of $2\\,\\mathrm{m}$ is below the $3\\,\\mathrm{m}$ threshold, and it is not supported by hydrographic data.\n  **Verdict: Incorrect.**\n\n- **C. Pits are $\\{(1,4),(2,4)\\}$ classified spurious, and $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified spurious (because equal-elevation flats cannot be true depressions).**\n  This option makes two errors. First, it incorrectly includes cell $(2,4)$ in the first pit; $(2,4)$ is the spill point, not part of the pit itself. Second, it incorrectly classifies the second depression as spurious and provides a baseless reason. The definition provided explicitly allows for multi-cell depressions, which can be flats, and our calculation confirmed this depression is deep enough to be considered \"true\".\n  **Verdict: Incorrect.**\n\n- **D. The only pit is $\\{(4,2),(4,3),(5,2),(5,3)\\}$ classified true; $\\{(1,4)\\}$ is not a pit because it spills at $z=92\\,\\mathrm{m}$.**\n  This option incorrectly claims that $\\{(1,4)\\}$ is not a pit. It perfectly matches the definition of a single-cell pit. A pit's existence is defined by its local topography (being a local minimum), while its spill point determines its depth. The statement confuses the definition of a pit with its properties relevant to filling.\n  **Verdict: Incorrect.**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "With a hydrologically conditioned flow direction grid in hand, we can perform the main task: delineating the full upstream contributing area for any given point, or outlet. This is the very definition of a watershed. This final exercise  is a capstone practice that integrates the previous concepts into a complete computational workflow, guiding you to implement the standard algorithm for watershed delineation: a reverse graph traversal that systematically identifies all cells flowing toward the specified outlet.",
            "id": "3930952",
            "problem": "You are given a gridded Digital Elevation Model (DEM) and asked to delineate the watershed for a specified outlet cell by marking all upstream cells using reverse graph traversal. The scientific basis is that gravity drives flow from high gravitational potential energy to low gravitational potential energy, and on a raster DEM, flow is approximated to move from a given cell to one of its $8$ neighboring cells that maximizes the downslope gradient. The eight-direction ($D8$) method constructs a directed graph where each cell has at most one outgoing edge to a unique neighbor that has the maximum positive downslope gradient among the $8$ adjacent cells, if such a neighbor exists.\n\nFundamental base:\n- Gravitational potential energy per unit mass is $g h$, with $g$ denoting gravitational acceleration and $h$ denoting elevation. On a regular grid with square cells of edge length $s$, a discrete approximation of steepest descent selects the neighbor that maximizes the ratio of elevation drop to planimetric distance.\n- For a cell at indices $(i,j)$ with elevation $z_{i,j}$ and neighbor at $(i+\\Delta i, j+\\Delta j)$ with elevation $z_{i+\\Delta i, j+\\Delta j}$, the planimetric distance is $d = s$ if $|\\Delta i| + |\\Delta j| = 1$ (cardinal direction) and $d = s\\sqrt{2}$ if $|\\Delta i| = |\\Delta j| = 1$ (diagonal). The discrete downslope gradient toward that neighbor is\n$$\n\\gamma = \\frac{z_{i,j} - z_{i+\\Delta i, j+\\Delta j}}{d}\n$$ .\n- The $D8$ outflow of cell $(i,j)$ is the neighbor $(i+\\Delta i^\\ast, j+\\Delta j^\\ast)$ that maximizes $\\gamma$ over the $8$ neighbors, provided the maximum is strictly positive; otherwise the cell is a sink or pit with no outflow.\n\nWatershed delineation from an outlet follows the definition that the watershed of an outlet cell $(i_0,j_0)$ is the set of all cells whose unique $D8$ flow path eventually reaches $(i_0,j_0)$. This set can be constructed by reverse graph traversal starting at $(i_0,j_0)$ and adding any neighbor whose outflow points to the current cell.\n\nYour task:\n- Implement a complete program that:\n  - Constructs $D8$ flow directions from the DEM using the discrete steepest descent rule described above.\n  - Starting at a given outlet cell, performs a reverse breadth-first search (Breadth-First Search, BFS) to mark all upstream cells that drain into the outlet through the directed graph induced by the $D8$ flow directions.\n  - Computes the watershed area as the count of marked cells multiplied by the square of the cell size.\n- Explicitly apply the following termination conditions for the reverse traversal:\n  - Do not traverse outside the DEM domain. Any neighbor with indices outside the DEM bounds is excluded.\n  - Do not traverse into NoData cells. Represent NoData as not-a-number and exclude these from both outflow computation and reverse traversal.\n  - Do not revisit already marked cells. Maintain a visited set to prevent cycles and ensure termination.\n  - Stop the traversal when the BFS queue becomes empty; at that point, all upstream contributors have been explored.\n  - Cells classified as pits (no outflow defined under $D8$) cannot be upstream of any other cell and therefore never appear as inbound neighbors during reverse traversal; they are not added to the watershed unless they are the outlet itself.\n- Express all watershed areas in square meters $\\mathrm{m}^2$, rounded to one decimal place.\n\nTest suite:\n- Use zero-based indexing for all cell coordinates $(i,j)$.\n- Each test case is given as $(\\text{DEM}, s, (i_0,j_0))$ where $\\text{DEM}$ is a two-dimensional array of elevations, $s$ is the cell size in meters, and $(i_0,j_0)$ is the outlet location.\n- Provide the following test cases:\n  - Case $1$ (happy path): a plane sloping to the northwest. Let $\\text{DEM}_1$ be the $5\\times 5$ array with $z_{i,j} = i + j$, cell size $s_1 = 10$ meters, and outlet at $(0,0)$. The expected watershed includes all cells that do not drain to a lower internal sink (there is none here), so it should encompass the entire domain under $D8$.\n  - Case $2$ (boundary condition): a monotonic slope toward the top row. Let $\\text{DEM}_2$ be the $5\\times 5$ array with $z_{i,j} = i$, cell size $s_2 = 20$ meters, and outlet at $(0,2)$. Under $D8$, each cell tends to flow straight north if possible; the top row acts effectively as a set of local minima due to domain boundary. The watershed for $(0,2)$ should include the outlet and the cells directly south along column $j=2$.\n  - Case $3$ (edge case with an internal pit and NoData): start from the same plane as Case $1$, introduce an internal depression by setting $z_{2,2} = -5$ and introduce a NoData cell at $(1,4)$ set to not-a-number. Use cell size $s_3 = 30$ meters and outlet at $(0,0)$. The internal pit captures flows from some surroundings and reduces the upstream area that reaches the outlet.\n\nYour program should produce a single line of output containing the watershed areas for the three test cases as a comma-separated list enclosed in square brackets, with each area in $\\mathrm{m}^2$ rounded to one decimal place (e.g., \"[2500.0,2000.0,12300.0]\").",
            "solution": "The problem has been validated and is determined to be scientifically grounded, well-posed, and objective. It presents a clear, formalizable task based on established principles of computational hydrology. The solution is implemented as a two-stage process: first, constructing a flow-direction grid using the eight-direction ($D8$) model, and second, delineating the watershed via a reverse graph traversal starting from a specified outlet cell.\n\n**Stage 1: D8 Flow Direction Grid Construction**\n\nThe first stage involves creating a directed graph that represents the path of steepest descent across the Digital Elevation Model (DEM). For each cell at grid coordinates $(i,j)$ with elevation $z_{i,j}$, we identify which of its $8$ adjacent neighbors provides the path of maximum downslope gradient.\n\nThe discrete gradient, $\\gamma$, to a neighboring cell is defined as the ratio of the elevation drop to the planimetric distance:\n$$\n\\gamma = \\frac{z_{i,j} - z_{neighbor}}{\\text{distance}}\n$$\nThe distance is $s$ for cardinal neighbors (North, South, East, West) and $s\\sqrt{2}$ for diagonal neighbors (Northeast, Northwest, Southeast, Southwest), where $s$ is the side length of a grid cell.\n\nThe algorithm iterates through every cell $(i,j)$ in the DEM:\n1.  If the cell contains a NoData value (represented as `NaN`), it is marked as such and excluded from flow calculations. No cell can flow into or out of a NoData cell.\n2.  For a valid cell, we examine its $8$ neighbors. For each valid neighbor (i.e., within the grid boundaries and not a NoData cell), the gradient $\\gamma$ is calculated.\n3.  The D8 flow direction is assigned to the neighbor that corresponds to the maximum strictly positive gradient, $\\max(\\gamma) > 0$. This establishes a single, unique outflow edge for the cell $(i,j)$ in the directed graph.\n4.  If no neighbor has a lower elevation, all gradients are less than or equal to $0$. In this case, the cell is classified as a pit or sink, and it is assigned no outflow direction.\n\nThe result of this stage is a pair of grids, `flow_di` and `flow_dj`, of the same dimensions as the DEM. For each cell $(i,j)$, the values `flow_di[i,j]` and `flow_dj[i,j]` store the row and column offsets of its downstream neighbor, respectively. Pits are represented by an offset of $(0,0)$, and NoData cells by a special flag.\n\n**Stage 2: Watershed Delineation via Reverse Breadth-First Search (BFS)**\n\nThe watershed of an outlet cell is defined as the set of all cells from which water, following the D8 flow paths, will eventually reach that outlet. This set is efficiently identified using a reverse graph traversal algorithm, specifically a Breadth-First Search (BFS), starting from the outlet.\n\nThe algorithm proceeds as follows:\n1.  A queue is initialized and the outlet cell $(i_0, j_0)$ is added to it.\n2.  A boolean grid, `watershed_mask`, is used to keep track of cells that have been identified as part of the watershed. The outlet cell is marked as visited.\n3.  The algorithm enters a loop that continues as long as the queue is not empty. In each iteration, a cell $(i_{curr}, j_{curr})$ is dequeued.\n4.  We then examine the $8$ neighbors of $(i_{curr}, j_{curr})$. For each neighbor $(i_n, j_n)$, we check if its pre-computed flow direction points to the current cell. This is the \"reverse\" step: we check if $(i_n + \\text{flow\\_di}[i_n, j_n], j_n + \\text{flow\\_dj}[i_n, j_n])$ is equal to $(i_{curr}, j_{curr})$.\n5.  If a neighbor flows into the current cell and has not yet been added to the watershed (i.e., `watershed_mask[i_n, j_n]` is false), it is marked as part of the watershed and enqueued. This process ensures that we methodically discover all upstream contributing cells.\n6.  The traversal naturally handles the specified termination conditions: it will not attempt to access cells outside the DEM bounds, it will not traverse into NoData cells, and the `watershed_mask` prevents a cell from being processed more than once. The process terminates when the queue is empty, signifying that all connected upstream cells have been found.\n\nFinally, the total watershed area, $A$, is calculated by multiplying the total count of cells in the watershed, $N$, by the area of a single cell, $s^2$:\n$$\nA = N \\times s^2\n$$\nThe areas for the three test cases are calculated using this method, with results rounded to one decimal place as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom collections import deque\n\ndef create_flow_direction_grid(dem, cell_size):\n    \"\"\"\n    Constructs a D8 flow direction grid from a DEM.\n\n    Args:\n        dem (np.ndarray): The Digital Elevation Model.\n        cell_size (float): The size of each grid cell.\n\n    Returns:\n        tuple[np.ndarray, np.ndarray]: Two grids representing the row (di) and\n        column (dj) offsets of the flow direction for each cell.\n    \"\"\"\n    rows, cols = dem.shape\n    # Initialize flow direction grids. (0, 0) represents a pit.\n    flow_di = np.zeros_like(dem, dtype=int)\n    flow_dj = np.zeros_like(dem, dtype=int)\n\n    s_sqrt2 = cell_size * np.sqrt(2)\n    # Neighbor definitions: (di, dj, distance) for N, NE, E, SE, S, SW, W, NW\n    neighbors_info = [\n        (-1, 0, cell_size),    # N\n        (-1, 1, s_sqrt2),     # NE\n        (0, 1, cell_size),    # E\n        (1, 1, s_sqrt2),      # SE\n        (1, 0, cell_size),    # S\n        (1, -1, s_sqrt2),     # SW\n        (0, -1, cell_size),   # W\n        (-1, -1, s_sqrt2)     # NW\n    ]\n\n    for i in range(rows):\n        for j in range(cols):\n            if np.isnan(dem[i, j]):\n                # Use a special value (99) to flag NoData cells.\n                flow_di[i, j] = 99\n                flow_dj[i, j] = 99\n                continue\n\n            z_current = dem[i, j]\n            max_gamma = 0.0\n            best_dir = (0, 0)  # Default to a pit\n\n            for di, dj, dist in neighbors_info:\n                ni, nj = i + di, j + dj\n\n                if 0 <= ni < rows and 0 <= nj < cols:\n                    z_neighbor = dem[ni, nj]\n                    if not np.isnan(z_neighbor):\n                        # Gradient is positive for downslope flow.\n                        if z_current > z_neighbor:\n                            gamma = (z_current - z_neighbor) / dist\n                            if gamma > max_gamma:\n                                max_gamma = gamma\n                                best_dir = (di, dj)\n            \n            flow_di[i, j] = best_dir[0]\n            flow_dj[i, j] = best_dir[1]\n    \n    return flow_di, flow_dj\n\ndef delineate_watershed(flow_di, flow_dj, outlet_coords, cell_size):\n    \"\"\"\n    Delineates the watershed for a given outlet using reverse BFS.\n\n    Args:\n        flow_di (np.ndarray): Grid of flow direction row offsets.\n        flow_dj (np.ndarray): Grid of flow direction column offsets.\n        outlet_coords (tuple[int, int]): The (row, col) of the outlet cell.\n        cell_size (float): The size of each grid cell.\n\n    Returns:\n        float: The calculated watershed area.\n    \"\"\"\n    rows, cols = flow_di.shape\n    outlet_i, outlet_j = outlet_coords\n\n    # Outlet validation: must be within bounds and not a NoData cell.\n    is_invalid_outlet = not (0 <= outlet_i < rows and 0 <= outlet_j < cols) \\\n                        or flow_di[outlet_i, outlet_j] == 99\n    if is_invalid_outlet:\n        return 0.0\n\n    watershed_mask = np.zeros_like(flow_di, dtype=bool)\n    queue = deque([outlet_coords])\n    \n    watershed_mask[outlet_i, outlet_j] = True\n    cell_count = 1\n\n    # Offsets to check all 8 neighbors of a current cell.\n    neighbor_offsets = [(-1, 0), (-1, 1), (0, 1), (1, 1), (1, 0), (1, -1), (0, -1), (-1, -1)]\n\n    while queue:\n        curr_i, curr_j = queue.popleft()\n\n        # Check 8 neighbors to see if any flow into the current cell.\n        for di, dj in neighbor_offsets:\n            ni, nj = curr_i + di, curr_j + dj\n\n            if 0 <= ni < rows and 0 <= nj < cols and not watershed_mask[ni, nj]:\n                # Skip NoData cells.\n                if flow_di[ni, nj] == 99:\n                    continue\n                \n                # Check if neighbor (ni,nj) flows to (curr_i, curr_j).\n                if (ni + flow_di[ni, nj] == curr_i) and (nj + flow_dj[ni, nj] == curr_j):\n                    watershed_mask[ni, nj] = True\n                    cell_count += 1\n                    queue.append((ni, nj))\n    \n    area = cell_count * cell_size**2\n    return area\n\ndef solve():\n    \"\"\"\n    Defines test cases and runs the watershed delineation for each.\n    \"\"\"\n    # Case 1: Simple plane sloping to the northwest.\n    dem1 = np.array([[float(i + j) for j in range(5)] for i in range(5)])\n    s1 = 10.0\n    outlet1 = (0, 0)\n\n    # Case 2: Monotonic slope towards the top row.\n    dem2 = np.array([[float(i) for j in range(5)] for i in range(5)])\n    s2 = 20.0\n    outlet2 = (0, 2)\n    \n    # Case 3: Plane with an internal pit and a NoData cell.\n    dem3 = np.array([[float(i + j) for j in range(5)] for i in range(5)])\n    dem3[2, 2] = -5.0\n    dem3[1, 4] = np.nan\n    s3 = 30.0\n    outlet3 = (0, 0)\n    \n    test_cases = [\n        (dem1, s1, outlet1),\n        (dem2, s2, outlet2),\n        (dem3, s3, outlet3)\n    ]\n\n    results = []\n    for dem, s, outlet in test_cases:\n        flow_di, flow_dj = create_flow_direction_grid(dem, s)\n        area = delineate_watershed(flow_di, flow_dj, outlet, s)\n        results.append(round(area, 1))\n    \n    # Print the results in the specified format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}