{
    "hands_on_practices": [
        {
            "introduction": "我们从一个最基本的问题开始：一个领域的观测（如大气）如何改进另一领域（如海洋）的分析？这项练习  使用一个简化的双分量模型，让您推导海洋分析方差减少量的解析公式。通过该实践，您将能够精确地分离出跨域相关的贡献，并量化强耦合数据同化所带来的收益。",
            "id": "4028482",
            "problem": "在一个简化的耦合数据同化设置中，设计并实现一个验证实验，通过开关跨域协方差并计算差异度量，来分离并量化大气观测对海洋分析技巧的贡献。\n\n考虑一个线性的、瞬时的、双分量状态向量 $x = [x_{\\mathrm{a}}, x_{\\mathrm{o}}]^{\\top}$，它代表一个大气标量 $x_{\\mathrm{a}}$ 和一个海洋标量 $x_{\\mathrm{o}}$。假设一个高斯背景（先验）分布 $x \\sim \\mathcal{N}(\\mu_{\\mathrm{b}}, B)$，其背景协方差矩阵为\n$$\nB = \\begin{bmatrix}\nB_{\\mathrm{aa}} & B_{\\mathrm{ao}} \\\\\nB_{\\mathrm{oa}} & B_{\\mathrm{oo}}\n\\end{bmatrix}, \\quad B_{\\mathrm{oa}} = B_{\\mathrm{ao}},\n$$\n其中 $B_{\\mathrm{aa}}$ 和 $B_{\\mathrm{oo}}$ 分别是大气和海洋的背景方差，$B_{\\mathrm{ao}}$ 是捕捉跨域相关的交叉协方差。将交叉协方差参数化为 $B_{\\mathrm{ao}} = \\rho \\sqrt{B_{\\mathrm{aa}} B_{\\mathrm{oo}}}$，其中相关系数 $\\rho \\in (-1, 1)$。\n\n假设有一个单一的大气观测 $y$，其线性观测算子为 $H = [1, 0]$，观测误差模型为 $y = H x + \\varepsilon$，其中 $\\varepsilon \\sim \\mathcal{N}(0, R)$ 且 $R$ 是观测误差方差。在线性高斯假设下，Kalman 分析（后验）协方差由下式给出：\n$$\nP_{\\mathrm{a}} = (I - K H) B, \\quad K = B H^{\\top} (H B H^{\\top} + R)^{-1},\n$$\n其中 $I$ 是单位矩阵，$K$ 是 Kalman 增益。\n\n你的任务是编写一个程序，对每个测试用例，计算两个标量度量，用以分离在只同化大气观测时跨域协方差对海洋分析技巧的影响：\n\n1. 完全由跨域耦合导致的海洋分析方差的绝对减少量，定义为\n$$\n\\Delta_{\\mathrm{var}} = P_{\\mathrm{oo}}^{\\mathrm{decoupled}} - P_{\\mathrm{oo}}^{\\mathrm{coupled}},\n$$\n其中 $P_{\\mathrm{oo}}^{\\mathrm{coupled}}$ 是当 $B_{\\mathrm{ao}}$ 设置为参数化的非零值时分析协方差的海洋分量，而 $P_{\\mathrm{oo}}^{\\mathrm{decoupled}}$ 是在保持 $B_{\\mathrm{aa}}$、$B_{\\mathrm{oo}}$ 和 $R$ 不变的情况下，将交叉协方差关闭（设为0）时的海洋分量。\n\n2. 由耦合引起的海洋分析方差的相对减少量（无量纲分数），定义为\n$$\n\\delta_{\\mathrm{rel}} = \\frac{\\Delta_{\\mathrm{var}}}{B_{\\mathrm{oo}}}.\n$$\n\n你的推导和算法应基于线性高斯估计和 Kalman 滤波器协方差更新的基本原理，即上述定义以及对于联合高斯变量，条件化会沿着观测方向按协方差比例减小方差这一事实。\n\n使用指定的参数值实现以下测试套件：\n- 测试用例 1：$B_{\\mathrm{aa}} = 1.0$, $B_{\\mathrm{oo}} = 1.0$, $\\rho = 0.5$, $R = 0.25$。\n- 测试用例 2：$B_{\\mathrm{aa}} = 1.0$, $B_{\\mathrm{oo}} = 1.0$, $\\rho = 0.0$, $R = 0.25$。\n- 测试用例 3：$B_{\\mathrm{aa}} = 1.0$, $B_{\\mathrm{oo}} = 2.0$, $\\rho = 0.7$, $R = 1000000.0$。\n- 测试用例 4：$B_{\\mathrm{aa}} = 4.0$, $B_{\\mathrm{oo}} = 0.25$, $\\rho = 0.9$, $R = 0.01$。\n- 测试用例 5：$B_{\\mathrm{aa}} = 0.01$, $B_{\\mathrm{oo}} = 1.0$, $\\rho = 0.8$, $R = 1.0$。\n- 测试用例 6：$B_{\\mathrm{aa}} = 2.0$, $B_{\\mathrm{oo}} = 3.0$, $\\rho = -0.7$, $R = 0.5$。\n\n对每个测试用例，计算并以浮点数形式报告数值对 $[\\Delta_{\\mathrm{var}}, \\delta_{\\mathrm{rel}}]$。你的程序应生成单行输出，其中包含用方括号括起来的、以逗号分隔的结果列表（例如，$[ [\\Delta_{\\mathrm{var}}^{(1)}, \\delta_{\\mathrm{rel}}^{(1)}], [\\Delta_{\\mathrm{var}}^{(2)}, \\delta_{\\mathrm{rel}}^{(2)}], \\dots ]$）。不需要物理单位，因为所有量都是在任意但一致的单位制下的方差和无量纲比率。不涉及角度。不要将任何量表示为百分比；请将 $\\delta_{\\mathrm{rel}}$ 表示为小数。",
            "solution": "该问题要求设计一个验证实验，以量化跨域协方差对海洋分析技巧的影响。给定一个简化的双分量系统（大气 $x_{\\mathrm{a}}$，海洋 $x_{\\mathrm{o}}$）、一个针对大气的线性观测算子，以及 Kalman 滤波器分析协方差的标准方程。我们必须推导并计算两个度量：由于同化大气观测而导致的海洋状态绝对方差减少量 $\\Delta_{\\mathrm{var}}$ 和相对方差减少量 $\\delta_{\\mathrm{rel}}$。\n\n首先，我们将推导这些度量的解析表达式。状态向量为 $x = [x_{\\mathrm{a}}, x_{\\mathrm{o}}]^{\\top}$。背景协方差矩阵 $B$、观测算子 $H$ 和单位矩阵 $I$ 分别是：\n$$\nB = \\begin{bmatrix} B_{\\mathrm{aa}} & B_{\\mathrm{ao}} \\\\ B_{\\mathrm{oa}} & B_{\\mathrm{oo}} \\end{bmatrix}, \\quad H = [1 \\quad 0], \\quad I = \\begin{bmatrix} 1 & 0 \\\\ 0 & 1 \\end{bmatrix}\n$$\n其中交叉协方差参数化为 $B_{\\mathrm{ao}} = B_{\\mathrm{oa}} = \\rho \\sqrt{B_{\\mathrm{aa}} B_{\\mathrm{oo}}}$。观测误差方差是一个标量 $R$。\n\nKalman 分析协方差由 $P_{\\mathrm{a}} = (I - K H) B$ 给出，其中 Kalman 增益 $K = B H^{\\top} (H B H^{\\top} + R)^{-1}$。\n\n让我们推导 Kalman 增益 $K$ 的分量。\n项 $B H^{\\top}$ 为：\n$$\nB H^{\\top} = \\begin{bmatrix} B_{\\mathrm{aa}} & B_{\\mathrm{ao}} \\\\ B_{\\mathrm{oa}} & B_{\\mathrm{oo}} \\end{bmatrix} \\begin{bmatrix} 1 \\\\ 0 \\end{bmatrix} = \\begin{bmatrix} B_{\\mathrm{aa}} \\\\ B_{\\mathrm{oa}} \\end{bmatrix}\n$$\n新息协方差项 $H B H^{\\top} + R$ 是一个标量：\n$$\nH B H^{\\top} + R = [1 \\quad 0] \\begin{bmatrix} B_{\\mathrm{aa}} \\\\ B_{\\mathrm{oa}} \\end{bmatrix} + R = B_{\\mathrm{aa}} + R\n$$\n由于 $B_{\\mathrm{aa}}$ 是方差，$R$ 是正误差方variance，分母 $(B_{\\mathrm{aa}} + R)$ 总是正数，因此其逆存在。Kalman 增益 $K$ 是一个 $2 \\times 1$ 的列向量：\n$$\nK = \\begin{bmatrix} B_{\\mathrm{aa}} \\\\ B_{\\mathrm{oa}} \\end{bmatrix} (B_{\\mathrm{aa}} + R)^{-1} = \\frac{1}{B_{\\mathrm{aa}} + R} \\begin{bmatrix} B_{\\mathrm{aa}} \\\\ B_{\\mathrm{oa}} \\end{bmatrix}\n$$\n接下来，我们计算矩阵因子 $(I - K H)$：\n$$\nK H = \\frac{1}{B_{\\mathrm{aa}} + R} \\begin{bmatrix} B_{\\mathrm{aa}} \\\\ B_{\\mathrm{oa}} \\end{bmatrix} [1 \\quad 0] = \\frac{1}{B_{\\mathrm{aa}} + R} \\begin{bmatrix} B_{\\mathrm{aa}} & 0 \\\\ B_{\\mathrm{oa}} & 0 \\end{bmatrix}\n$$\n$$\nI - K H = \\begin{bmatrix} 1 & 0 \\\\ 0 & 1 \\end{bmatrix} - \\frac{1}{B_{\\mathrm{aa}} + R} \\begin{bmatrix} B_{\\mathrm{aa}} & 0 \\\\ B_{\\mathrm{oa}} & 0 \\end{bmatrix} = \\begin{bmatrix} 1 - \\frac{B_{\\mathrm{aa}}}{B_{\\mathrm{aa}} + R} & 0 \\\\ -\\frac{B_{\\mathrm{oa}}}{B_{\\mathrm{aa}} + R} & 1 \\end{bmatrix} = \\begin{bmatrix} \\frac{R}{B_{\\mathrm{aa}} + R} & 0 \\\\ -\\frac{B_{\\mathrm{oa}}}{B_{\\mathrm{aa}} + R} & 1 \\end{bmatrix}\n$$\n现在，我们计算完整的分析协方差矩阵 $P_{\\mathrm{a}} = (I - K H) B$：\n$$\nP_{\\mathrm{a}} = \\begin{bmatrix} \\frac{R}{B_{\\mathrm{aa}} + R} & 0 \\\\ -\\frac{B_{\\mathrm{oa}}}{B_{\\mathrm{aa}} + R} & 1 \\end{bmatrix} \\begin{bmatrix} B_{\\mathrm{aa}} & B_{\\mathrm{ao}} \\\\ B_{\\mathrm{oa}} & B_{\\mathrm{oo}} \\end{bmatrix} = \\begin{bmatrix} \\frac{R B_{\\mathrm{aa}}}{B_{\\mathrm{aa}} + R} & \\frac{R B_{\\mathrm{ao}}}{B_{\\mathrm{aa}} + R} \\\\ \\frac{-B_{\\mathrm{oa}} B_{\\mathrm{aa}}}{B_{\\mathrm{aa}} + R} + B_{\\mathrm{oa}} & \\frac{-B_{\\mathrm{oa}} B_{\\mathrm{ao}}}{B_{\\mathrm{aa}} + R} + B_{\\mathrm{oo}} \\end{bmatrix}\n$$\n非对角项 $P_{\\mathrm{oa}}$ 简化为 $\\frac{B_{\\mathrm{oa}}(-B_{\\mathrm{aa}} + B_{\\mathrm{aa}} + R)}{B_{\\mathrm{aa}} + R} = \\frac{R B_{\\mathrm{oa}}}{B_{\\mathrm{aa}} + R}$，这证实了 $P_{\\mathrm{a}}$ 的对称性，因为 $B_{\\mathrm{oa}} = B_{\\mathrm{ao}}$。\n\n我们的重点是海洋分析方差，即 $P_{\\mathrm{a}}$ 的右下角元素，记为 $P_{\\mathrm{oo}}$：\n$$\nP_{\\mathrm{oo}} = B_{\\mathrm{oo}} - \\frac{B_{\\mathrm{oa}} B_{\\mathrm{ao}}}{B_{\\mathrm{aa}} + R}\n$$\n由于 $B_{\\mathrm{oa}} = B_{\\mathrm{ao}}$，上式简化为：\n$$\nP_{\\mathrm{oo}} = B_{\\mathrm{oo}} - \\frac{B_{\\mathrm{ao}}^2}{B_{\\mathrm{aa}} + R}\n$$\n这个表达式使我们能够计算“耦合”和“解耦”两种情景下的海洋分析方差。\n\n对于**耦合**情况，我们使用参数化的交叉协方差 $B_{\\mathrm{ao}} = \\rho \\sqrt{B_{\\mathrm{aa}} B_{\\mathrm{oo}}}$。将其平方得到 $B_{\\mathrm{ao}}^2 = \\rho^2 B_{\\mathrm{aa}} B_{\\mathrm{oo}}$。将此代入 $P_{\\mathrm{oo}}$ 的表达式中，得到耦合海洋分析方差：\n$$\nP_{\\mathrm{oo}}^{\\mathrm{coupled}} = B_{\\mathrm{oo}} - \\frac{\\rho^2 B_{\\mathrm{aa}} B_{\\mathrm{oo}}}{B_{\\mathrm{aa}} + R}\n$$\n对于**解耦**情况，跨域协方差被关闭，意味着我们设置 $B_{\\mathrm{ao}} = 0$。这对应于设置相关系数 $\\rho = 0$。得到的海洋分析方差是：\n$$\nP_{\\mathrm{oo}}^{\\mathrm{decoupled}} = B_{\\mathrm{oo}} - \\frac{0^2}{B_{\\mathrm{aa}} + R} = B_{\\mathrm{oo}}\n$$\n这个结果是直观的：如果海洋和大气在背景场中不相关，那么对大气的观测不提供任何更新海洋状态的信息，因此其方差保持背景值 $B_{\\mathrm{oo}}$ 不变。\n\n现在，我们可以计算所需的度量了。\n\n1.  海洋分析方差的绝对减少量 $\\Delta_{\\mathrm{var}}$：\n    $$\n    \\Delta_{\\mathrm{var}} = P_{\\mathrm{oo}}^{\\mathrm{decoupled}} - P_{\\mathrm{oo}}^{\\mathrm{coupled}} = B_{\\mathrm{oo}} - \\left(B_{\\mathrm{oo}} - \\frac{\\rho^2 B_{\\mathrm{aa}} B_{\\mathrm{oo}}}{B_{\\mathrm{aa}} + R}\\right)\n    $$\n    $$\n    \\Delta_{\\mathrm{var}} = \\frac{\\rho^2 B_{\\mathrm{aa}} B_{\\mathrm{oo}}}{B_{\\mathrm{aa}} + R}\n    $$\n    这个量代表了由于通过跨域相关性 $\\rho$ 从大气观测传递来的信息，而导致的海洋状态不确定性（方差）的直接减少。\n\n2.  海洋分析方差的相对减少量 $\\delta_{\\mathrm{rel}}$：\n    $$\n    \\delta_{\\mathrm{rel}} = \\frac{\\Delta_{\\mathrm{var}}}{B_{\\mathrm{oo}}} = \\frac{1}{B_{\\mathrm{oo}}} \\left(\\frac{\\rho^2 B_{\\mathrm{aa}} B_{\\mathrm{oo}}}{B_{\\mathrm{aa}} + R}\\right)\n    $$\n    $$\n    \\delta_{\\mathrm{rel}} = \\frac{\\rho^2 B_{\\mathrm{aa}}}{B_{\\mathrm{aa}} + R}\n    $$\n    这个无量纲度量给出了海洋方差的分数减少量。有趣的是，它与海洋的背景方差 $B_{\\mathrm{oo}}$ 无关，而仅仅是平方相关系数 $\\rho^2$ 乘以因子 $\\frac{B_{\\mathrm{aa}}}{B_{\\mathrm{aa}} + R}$，该因子代表了被观测的大气变量本身的分数方差减少量。\n\n程序的算法是将这两个最终公式应用于每个给定的测试用例。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes metrics for a coupled data assimilation experiment.\n\n    For each test case, the function calculates the absolute and relative \n    reduction in ocean analysis variance due to cross-domain correlations \n    when assimilating only atmospheric observations.\n    \"\"\"\n\n    test_cases = [\n        # (B_aa, B_oo, rho, R)\n        (1.0, 1.0, 0.5, 0.25),\n        (1.0, 1.0, 0.0, 0.25),\n        (1.0, 2.0, 0.7, 1000000.0),\n        (4.0, 0.25, 0.9, 0.01),\n        (0.01, 1.0, 0.8, 1.0),\n        (2.0, 3.0, -0.7, 0.5),\n    ]\n\n    results = []\n    for case in test_cases:\n        B_aa, B_oo, rho, R = case\n\n        # Derived formula for the absolute reduction in ocean analysis variance\n        # delta_var = (rho^2 * B_aa * B_oo) / (B_aa + R)\n        delta_var = (rho**2 * B_aa * B_oo) / (B_aa + R)\n\n        # Derived formula for the relative reduction in ocean analysis variance\n        # delta_rel = delta_var / B_oo  or  (rho^2 * B_aa) / (B_aa + R)\n        if B_oo == 0:\n            # Handle the case where B_oo is zero, though not in test cases.\n            # In this scenario, variance is already zero, so relative reduction is ill-defined.\n            # We can define it as 0 as there's no variance to reduce.\n            delta_rel = 0.0\n        else:\n            delta_rel = delta_var / B_oo\n\n        results.append([delta_var, delta_rel])\n\n    # Format the final output string exactly as required.\n    # e.g., [[val1, val2], [val3, val4], ...]\n    # The map(str, ...) correctly converts each inner list to its string representation.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "现实世界中的跨域相关性并非静止不变，而是随地球系统的状态演变。这项练习  超越了简单的静态协方差，引入了在现代业务系统中广泛应用的混合集合-变分（EnVar）方法。通过实现该方法，您将看到由集合估计出的“流依赖”协方差如何在一个耦合系统中，为未被直接观测的分量生成符合物理规律的分析增量。",
            "id": "3872517",
            "problem": "考虑一个由两个分量组成的线性高斯耦合地球系统：一个大气分量和一个海洋分量。设状态向量为 $x \\in \\mathbb{R}^4$，其中索引 $0,1$ 对应大气，索引 $2,3$ 对应海洋。给定背景态 $x^b$ 和协方差。观测是状态的线性函数，并带有加性高斯误差。您需要在一个三维集合-变分 (3DEnVar) 混合协方差下计算分析态，该协方差混合了静态背景协方差和从异常估计的集合协方差，然后评估由观测引起的跨分量增量。\n\n从以下基本基础开始：\n- 将 $x$ 映射到观测空间的线性观测算子，由矩阵 $H$ 给出。\n- 线性和高斯先验及似然：$x \\sim \\mathcal{N}(x^b, B)$ 和 $y = H x + \\epsilon$，其中 $\\epsilon \\sim \\mathcal{N}(0, R)$，$B$ 是先验协方差，$R$ 是观测误差协方差。\n- 混合先验协方差 $B_h$ 定义为静态协方差 $B_s$ 和从异常估计的集合协方差 $B_e$ 的凸组合，标量权重为 $w \\in [0,1]$，使得 $B_h = w B_s + (1 - w) B_e$。\n- 集合协方差 $B_e$ 从异常矩阵 $A \\in \\mathbb{R}^{n \\times m}$ 估计得出，公式为 $B_e = \\frac{1}{m-1} A A^\\top$，其中 $n$ 是状态维数，$m$ 是集合大小。\n\n对于下面定义的每个测试用例，您的程序必须根据给定的异常 $A$ 构建 $B_e$，根据给定的 $B_s$ 和权重 $w$ 构建 $B_h$，然后计算分析态 $x^a$，该分析态使结合了由 $B_h$ 定义的先验项和由 $R$ 定义的观测失配项的标准线性高斯变分代价函数最小化。报告跨分量增量的大小，即在未被直接观测的分量中分析增量的欧几里得范数。\n\n计算所需量的定义：\n- 分析增量为 $x^a - x^b \\in \\mathbb{R}^4$。\n- 跨分量增量的大小是 $x^a - x^b$ 中对应于该测试用例中未被直接观测的分量的子向量的欧几里得范数。对于观测大气（索引 $0,1$）的测试，计算索引 $2,3$ 上的欧几里得范数。对于观测海洋（索引 $2,3$）的测试，计算索引 $0,1$ 上的欧几里得范数。\n\n在所有测试用例中使用以下固定数据：\n- 状态维数：$n = 4$。大气索引：$0,1$。海洋索引：$2,3$。\n- 背景态：$x^b = [1.0, -0.5, 0.2, -0.1]^\\top$。\n- 静态背景协方差：\n$$\nB_s = \\begin{bmatrix}\n1.0 & 0.5 & 0.0 & 0.0 \\\\\n0.5 & 1.0 & 0.0 & 0.0 \\\\\n0.0 & 0.0 & 0.6 & 0.18 \\\\\n0.0 & 0.0 & 0.18 & 0.6\n\\end{bmatrix}.\n$$\n- 第一个集合的集合异常（标记为 $A_1$，有 $m=5$ 个成员）：\n$$\nA_1 = \\begin{bmatrix}\n0.5 & -0.2 & 0.3 & -0.1 & -0.5 \\\\\n-0.1 & 0.4 & -0.2 & 0.3 & -0.4 \\\\\n0.4 & -0.1 & 0.2 & -0.05 & -0.3 \\\\\n0.2 & -0.05 & 0.15 & -0.02 & -0.1\n\\end{bmatrix}.\n$$\n- 第二个集合的集合异常（标记为 $A_2$，有 $m=5$ 个成员）：\n$$\nA_2 = \\begin{bmatrix}\n0.5 & -0.2 & 0.3 & -0.1 & -0.5 \\\\\n-0.1 & 0.4 & -0.2 & 0.3 & -0.4 \\\\\n-0.3 & 0.1 & -0.25 & 0.2 & 0.25 \\\\\n0.05 & -0.15 & 0.2 & -0.1 & 0.0\n\\end{bmatrix}.\n$$\n\n测试套件：\n- 测试用例 1（观测大气，使用来自 $A_1$ 的具有交叉协方差的混合模型）：\n  - 观测算子 $H$ 是一个选择索引 $0$ 的 $1 \\times 4$ 矩阵：$H = [1, 0, 0, 0]$。\n  - 观测向量 $y = [1.5]^\\top$。\n  - 观测误差协方差 $R$ 为 $[0.04]$（一个 $1 \\times 1$ 矩阵）。\n  - 混合权重 $w = 0.5$。\n  - 集合异常 $A = A_1$。\n  - 报告分析增量在索引 $2,3$ 上的欧几里得范数。\n\n- 测试用例 2（观测大气，使用备选集合异常 $A_2$）：\n  - $H = [1, 0, 0, 0]$。\n  - $y = [1.5]^\\top$。\n  - $R = [0.04]$。\n  - $w = 0.5$。\n  - $A = A_2$。\n  - 报告分析增量在索引 $2,3$ 上的欧几里得范数。\n\n- 测试用例 3（观测大气，较大的观测误差）：\n  - $H = [1, 0, 0, 0]$。\n  - $y = [1.5]^\\top$。\n  - $R = [1.0]$。\n  - $w = 0.5$。\n  - $A = A_1$。\n  - 报告分析增量在索引 $2,3$ 上的欧几里得范数。\n\n- 测试用例 4（纯静态，观测大气）：\n  - $H = [1, 0, 0, 0]$。\n  - $y = [1.5]^\\top$。\n  - $R = [0.04]$。\n  - $w = 1.0$。\n  - $A = A_1$。\n  - 报告分析增量在索引 $2,3$ 上的欧几里得范数。\n\n- 测试用例 5（纯集合，观测海洋）：\n  - $H = [0, 0, 1, 0]$。\n  - $y = [0.8]^\\top$。\n  - $R = [0.09]$。\n  - $w = 0.0$。\n  - $A = A_1$。\n  - 报告分析增量在索引 $0,1$ 上的欧几里得范数。\n\n您的程序应生成单行输出，其中包含各测试的跨分量增量大小，格式为方括号内逗号分隔的列表，每个值四舍五入到 $6$ 位小数（例如，“[v1,v2,v3,v4,v5]”）。不涉及物理单位。不使用角度。不使用百分比。",
            "solution": "该问题要求在一个耦合的线性高斯数据同化系统中，计算跨分量分析增量的大小。分析态 $x^a$ 是使三维变分 (3D-Var) 代价函数 $J(x)$ 最小化的状态向量。该代价函数衡量了与背景态 $x^b$ 和观测 $y$ 的失配程度，并由它们各自的误差协方差加权。\n\n代价函数由以下公式给出：\n$$J(x) = \\frac{1}{2}(x - x^b)^\\top B_h^{-1} (x - x^b) + \\frac{1}{2}(y - Hx)^\\top R^{-1} (y - Hx)$$\n这里，$H$ 是线性观测算子，$R$ 是观测误差协方差矩阵，$B_h$ 是混合背景误差协方差矩阵。\n\n对于线性高斯系统，这个二次代价函数有唯一的最小值。使 $J(x)$ 最小化的分析态 $x^a$ 可以通过将其梯度 $\\nabla_x J(x)$ 设为零来找到。其解析解由最佳线性无偏估计 (BLUE) 方程给出：\n$$x^a = x^b + K(y - Hx^b)$$\n其中 $K$ 是卡尔曼增益矩阵。这种形式在计算上具有优势，特别是当观测空间的维数远小于状态空间时，因为它避免了对大的 $n \\times n$ 矩阵 $B_h$ 直接求逆。卡尔曼增益 $K$ 定义为：\n$$K = B_h H^\\top (H B_h H^\\top + R)^{-1}$$\n\n$x^a - x^b$ 项是分析增量，表示基于观测信息对背景态应用的更新。\n$$\\delta x^a = x^a - x^b = K(y - Hx^b)$$\n$d = y - Hx^b$ 项是新息（innovation），或称观测减预报，是实际观测与从背景态预测的观测之间的差异。\n\n背景误差协方差 $B_h$ 是一种混合公式，构建为静态协方差 $B_s$ 和集合派生协方差 $B_e$ 的加权平均：\n$$B_h = w B_s + (1 - w) B_e$$\n其中 $w \\in [0, 1]$ 是一个标量权重。\n\n静态协方差 $B_s$ 是给定的，并且是块对角矩阵，这意味着大气分量（索引 $0,1$）和海洋分量（索引 $2,3$）之间没有先验相关性。\n$$B_s = \\begin{bmatrix}\nB_{aa} & 0 \\\\\n0 & B_{oo}\n\\end{bmatrix}$$\n‘aa’表示大气-大气块，‘oo’表示海洋-海洋块。\n\n集合协方差 $B_e$ 是从一个集合异常矩阵 $A \\in \\mathbb{R}^{n \\times m}$ 估计的，其中 $n=4$ 是状态维数，$m=5$ 是集合大小。无偏样本协方差的公式是：\n$$B_e = \\frac{1}{m-1} A A^\\top$$\n$A A^\\top$ 矩阵捕捉了由集合采样的协方差结构。关键在于，如果集合成员表现出大气和海洋分量之间的相关性，那么得到的 $B_e$ 将具有非零的非对角块（大气-海洋交叉协方差）。\n\n跨分量更新是本题测试的核心概念。当在一个分量（例如，大气）中进行观测时，分析增量 $\\delta x^a$ 可以在另一个未观测到的分量（例如，海洋）中具有非零元素。这只有在卡尔曼增益矩阵 $K$ 具有将观测分量的新息映射到未观测分量的状态变量的结构时才可能发生。这种结构直接继承自背景误差协方差 $B_h$。具体来说，如果 $B_h$ 中与观测状态变量对应的列，在与未观测状态变量对应的行中具有非零值（即交叉协方差块非零），则会发生跨分量更新。在本问题中，当 $w  1$ 时，这种交叉协方差由集合项 $B_e$ 引入。\n\n每个测试用例所需的输出是分析增量 $\\delta x^a$ 中对应于未被直接观测的分量的子向量的欧几里得范数。对于大气的观测（索引 $0,1$），这是 $||\\delta x^a_{2:3}||_2$。对于海洋的观测（索引 $2,3$），这是 $||\\delta x^a_{0:1}||_2$。\n\n每个测试用例的算法如下：\n1. 从给定的异常矩阵 $A$ 构建集合协方差矩阵 $B_e$。\n2. 使用指定的权重 $w$ 构建混合协方差矩阵 $B_h$。\n3. 计算卡尔曼增益矩阵 $K$。\n4. 计算新息 $d = y - Hx^b$。\n5. 计算分析增量 $\\delta x^a = K d$。\n6. 基于观测算子 $H$ 的结构，识别未观测的状态分量。\n7. 提取 $\\delta x^a$ 中未观测分量的子向量，并计算其欧几里得范数。\n此过程将应用于问题中定义的五个测试用例中的每一个。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_cross_increment_norm(x_b, B_s, a_matrix, w, H, y, R):\n    \"\"\"\n    Computes the cross-component analysis increment magnitude for a single test case.\n\n    Args:\n        x_b (np.ndarray): Background state vector (n,).\n        B_s (np.ndarray): Static background error covariance matrix (n, n).\n        a_matrix (np.ndarray): Ensemble anomalies matrix (n, m).\n        w (float): Hybrid weight.\n        H (np.ndarray): Observation operator matrix (k, n).\n        y (np.ndarray): Observation vector (k,).\n        R (np.ndarray): Observation error covariance matrix (k, k).\n\n    Returns:\n        float: The Euclidean norm of the cross-component analysis increment.\n    \"\"\"\n    n, m = a_matrix.shape  # n: state dimension, m: ensemble size\n\n    # 1. Construct ensemble and hybrid covariance matrices\n    B_e = (1 / (m - 1)) * (a_matrix @ a_matrix.T)\n    B_h = w * B_s + (1 - w) * B_e\n\n    # 2. Calculate Kalman gain K = B_h H^T (H B_h H^T + R)^-1\n    # H.T is (n, k), B_h is (n, n), so B_h @ H.T is (n, k)\n    k_num = B_h @ H.T\n    # H is (k, n), k_num is (n, k), so H @ k_num is (k, k)\n    # R is (k, k)\n    k_den = H @ B_h @ H.T + R\n    k_den_inv = np.linalg.inv(k_den)\n    K = k_num @ k_den_inv  # K is (n, k)\n\n    # 3. Calculate innovation d = y - H x_b\n    innovation = y - (H @ x_b) # innovation is (k,)\n\n    # 4. Compute analysis increment dx = K d\n    analysis_increment = K @ innovation  # analysis_increment is (n,)\n\n    # 5. Identify unobserved component and compute norm\n    observed_idx = np.where(H[0, :] != 0)[0][0]\n    \n    if observed_idx in [0, 1]:  # Atmosphere observed\n        unobserved_slice = slice(2, 4)\n    else:  # Ocean observed (indices 2, 3)\n        unobserved_slice = slice(0, 2)\n    \n    cross_increment_vector = analysis_increment[unobserved_slice]\n    \n    norm = np.linalg.norm(cross_increment_vector)\n    \n    return norm\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Fixed data across all test cases\n    x_b = np.array([1.0, -0.5, 0.2, -0.1])\n    B_s = np.array([\n        [1.0, 0.5, 0.0, 0.0],\n        [0.5, 1.0, 0.0, 0.0],\n        [0.0, 0.0, 0.6, 0.18],\n        [0.0, 0.0, 0.18, 0.6]\n    ])\n    A1 = np.array([\n        [0.5, -0.2, 0.3, -0.1, -0.5],\n        [-0.1, 0.4, -0.2, 0.3, -0.4],\n        [0.4, -0.1, 0.2, -0.05, -0.3],\n        [0.2, -0.05, 0.15, -0.02, -0.1]\n    ])\n    A2 = np.array([\n        [0.5, -0.2, 0.3, -0.1, -0.5],\n        [-0.1, 0.4, -0.2, 0.3, -0.4],\n        [-0.3, 0.1, -0.25, 0.2, 0.25],\n        [0.05, -0.15, 0.2, -0.1, 0.0]\n    ])\n\n    test_cases = [\n        # Test case 1\n        {\n            \"H\": np.array([[1.0, 0.0, 0.0, 0.0]]), \"y\": np.array([1.5]), \n            \"R\": np.array([[0.04]]), \"w\": 0.5, \"A\": A1\n        },\n        # Test case 2\n        {\n            \"H\": np.array([[1.0, 0.0, 0.0, 0.0]]), \"y\": np.array([1.5]),\n            \"R\": np.array([[0.04]]), \"w\": 0.5, \"A\": A2\n        },\n        # Test case 3\n        {\n            \"H\": np.array([[1.0, 0.0, 0.0, 0.0]]), \"y\": np.array([1.5]),\n            \"R\": np.array([[1.0]]), \"w\": 0.5, \"A\": A1\n        },\n        # Test case 4\n        {\n            \"H\": np.array([[1.0, 0.0, 0.0, 0.0]]), \"y\": np.array([1.5]),\n            \"R\": np.array([[0.04]]), \"w\": 1.0, \"A\": A1\n        },\n        # Test case 5\n        {\n            \"H\": np.array([[0.0, 0.0, 1.0, 0.0]]), \"y\": np.array([0.8]),\n            \"R\": np.array([[0.09]]), \"w\": 0.0, \"A\": A1\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_cross_increment_norm(\n            x_b=x_b, B_s=B_s, a_matrix=case[\"A\"], w=case[\"w\"],\n            H=case[\"H\"], y=case[\"y\"], R=case[\"R\"]\n        )\n        results.append(f\"{result:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "数据同化并非在真空中进行，它修正的是来自一个动态模型的预报。这项练习  旨在探索耦合模型自身的设计——特别是分量间信息交换的频率——如何影响作为同化输入的背景场。通过比较不同耦合频率下的情景，您将量化模型动力学过程如何最终影响分析增量的大小和特征。",
            "id": "3872554",
            "problem": "考虑一个双分量线性耦合系统，它代表单个大气标量态和单个海洋标量态。设大气状态记为 $x_{a}(t)$，海洋状态记为 $x_{o}(t)$。在耦合交换之间，每个分量根据向零的线性弛豫独立演变：\n$$\\frac{d x_{a}}{dt} = -\\lambda_{a}\\, x_{a}, \\qquad \\frac{d x_{o}}{dt} = -\\lambda_{o}\\, x_{o},$$\n已知弛豫率为 $\\lambda_{a} = 0.1\\,\\mathrm{h}^{-1}$ 和 $\\lambda_{o} = 0.02\\,\\mathrm{h}^{-1}$。在离散的交换时间 $t_{k} = k\\,\\Delta t_{c}$，耦合瞬时作用，表现为每个分量向另一个分量的线性弛豫，而已知交换系数为 $\\gamma_{ao} = 0.3$ 和 $\\gamma_{oa} = 0.1$：\n$$x_{a}(t_{k}^{+}) = x_{a}(t_{k}^{-}) + \\gamma_{ao}\\,\\big(x_{o}(t_{k}^{-}) - x_{a}(t_{k}^{-})\\big),$$\n$$x_{o}(t_{k}^{+}) = x_{o}(t_{k}^{-}) + \\gamma_{oa}\\,\\big(x_{a}(t_{k}^{-}) - x_{o}(t_{k}^{-})\\big),$$\n其中 $t_{k}^{-}$ 和 $t_{k}^{+}$ 分别表示交换前和交换后的瞬间。假设没有模式噪声，且 $t=0$ 时的初始条件为 $x_{a}(0) = 2\\,\\mathrm{K}$ 和 $x_{o}(0) = -1\\,\\mathrm{K}$。\n\n在同化时间 $T = 4\\,\\mathrm{h}$，有一个对大气状态的单一标量观测值 $y$ 可用，其值为 $y = 0.5\\,\\mathrm{K}$。在 $t=T$ 时使用经典的卡尔曼滤波 (KF) 分析，大气状态的标量背景误差方差为 $B_{a}(T) = 1.0\\,\\mathrm{K}^{2}$，标量观测误差方差为 $R = 0.25\\,\\mathrm{K}^{2}$。分析增量定义为在 $T$ 时刻分析态与背景大气态之间的差值，即 $I(\\Delta t_{c}) = x_{a}^{a}(T) - x_{a}^{b}(T)$。\n\n计算两种耦合交换间隔下大气分析增量的差异：\n- 情况1：$\\Delta t_{c} = 1\\,\\mathrm{h}$。\n- 情况2：$\\Delta t_{c} = 4\\,\\mathrm{h}$。\n\n即，计算 $\\Delta I = I(1\\,\\mathrm{h}) - I(4\\,\\mathrm{h})$。将最终答案四舍五入到四位有效数字，并以 $\\mathrm{K}$ 为单位表示。",
            "solution": "在每次交换之间的每个区间内，系统是线性时不变的。对于 $t \\in (t_{k-1}, t_{k})$（无交换），精确解是指数衰减：\n$$x_{a}(t_{k}^{-}) = \\exp(-\\lambda_{a}\\,\\Delta t_{c})\\,x_{a}(t_{k-1}^{+}), \\qquad x_{o}(t_{k}^{-}) = \\exp(-\\lambda_{o}\\,\\Delta t_{c})\\,x_{o}(t_{k-1}^{+}).$$\n在每个交换时间 $t_{k}$，瞬时耦合是一个线性弛豫：\n$$\\begin{pmatrix} x_{a}(t_{k}^{+}) \\\\ x_{o}(t_{k}^{+}) \\end{pmatrix} = \\begin{pmatrix} 1 - \\gamma_{ao}  \\gamma_{ao} \\\\ \\gamma_{oa}  1 - \\gamma_{oa} \\end{pmatrix} \\begin{pmatrix} x_{a}(t_{k}^{-}) \\\\ x_{o}(t_{k}^{-}) \\end{pmatrix}.$$\n将交换间的衰减和交换时的混合合并为从 $t_{k-1}^{+}$ 到 $t_{k}^{+}$ 的单步，得到：\n$$\\begin{pmatrix} x_{a}(t_{k}^{+}) \\\\ x_{o}(t_{k}^{+}) \\end{pmatrix} = \\underbrace{\\begin{pmatrix} 1 - \\gamma_{ao}  \\gamma_{ao} \\\\ \\gamma_{oa}  1 - \\gamma_{oa} \\end{pmatrix}}_{M} \\underbrace{\\begin{pmatrix} \\exp(-\\lambda_{a}\\,\\Delta t_{c})  0 \\\\ 0  \\exp(-\\lambda_{o}\\,\\Delta t_{c}) \\end{pmatrix}}_{D(\\Delta t_{c})} \\begin{pmatrix} x_{a}(t_{k-1}^{+}) \\\\ x_{o}(t_{k-1}^{+}) \\end{pmatrix}.$$\n因此，对于直到 $T$ 时刻的 $n = T / \\Delta t_{c}$ 次交换，在 $T$ 时刻交换刚结束后的状态是：\n$$\\begin{pmatrix} x_{a}(T) \\\\ x_{o}(T) \\end{pmatrix} = \\big(M\\,D(\\Delta t_{c})\\big)^{n} \\begin{pmatrix} x_{a}(0) \\\\ x_{o}(0) \\end{pmatrix}.$$\n由于我们在 $t=T$ 进行分析，背景态 $x_{a}^{b}(T) = x_{a}(T)$ 由上式得出。\n\n对于标量观测算子 $H=1$、标量背景误差方差 $B_{a}(T)$ 和观测误差方差 $R$ 的卡尔曼滤波 (KF)，标量卡尔曼增益为：\n$$K = \\frac{B_{a}(T)}{B_{a}(T) + R}.$$\n分析更新方程为：\n$$x_{a}^{a}(T) = x_{a}^{b}(T) + K \\big(y - x_{a}^{b}(T)\\big),$$\n所以分析增量为：\n$$I(\\Delta t_{c}) = x_{a}^{a}(T) - x_{a}^{b}(T) = K \\big(y - x_{a}^{b}(T)\\big).$$\n因此，所求的差异为：\n$$\\Delta I = I(1\\,\\mathrm{h}) - I(4\\,\\mathrm{h}) = K \\Big(\\big(y - x_{a}^{b}(T;\\Delta t_{c}=1\\,\\mathrm{h})\\big) - \\big(y - x_{a}^{b}(T;\\Delta t_{c}=4\\,\\mathrm{h})\\big)\\Big) = K \\big(x_{a}^{b}(T;\\Delta t_{c}=4\\,\\mathrm{h}) - x_{a}^{b}(T;\\Delta t_{c}=1\\,\\mathrm{h})\\big).$$\n\n我们现在为每个耦合间隔计算 $x_{a}^{b}(T)$。固定的矩阵为：\n$$M = \\begin{pmatrix} 1 - \\gamma_{ao}  \\gamma_{ao} \\\\ \\gamma_{oa}  1 - \\gamma_{oa} \\end{pmatrix} = \\begin{pmatrix} 0.7  0.3 \\\\ 0.1  0.9 \\end{pmatrix}.$$\n\n情况2：$\\Delta t_{c} = 4\\,\\mathrm{h}$，所以 $n=1$。那么\n$$D(4\\,\\mathrm{h}) = \\begin{pmatrix} \\exp(-\\lambda_{a}\\cdot 4)  0 \\\\ 0  \\exp(-\\lambda_{o}\\cdot 4) \\end{pmatrix} = \\begin{pmatrix} \\exp(-0.4)  0 \\\\ 0  \\exp(-0.08) \\end{pmatrix}.$$\n数值上，\n$$\\exp(-0.4) \\approx 0.6703200460,\\qquad \\exp(-0.08) \\approx 0.9231163464.$$\n因此\n$$A_{2} \\equiv M D(4\\,\\mathrm{h}) = \\begin{pmatrix} 0.4692240322  0.2769349040 \\\\ 0.0670320046  0.8308047118 \\end{pmatrix}.$$\n使用初始状态 $\\begin{pmatrix} x_{a}(0) \\\\ x_{o}(0) \\end{pmatrix} = \\begin{pmatrix} 2 \\\\ -1 \\end{pmatrix}$，我们得到\n$$\\begin{pmatrix} x_{a}^{b}(T;4\\,\\mathrm{h}) \\\\ x_{o}^{b}(T;4\\,\\mathrm{h}) \\end{pmatrix} = A_{2} \\begin{pmatrix} 2 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} 0.6615131604 \\\\ -0.6967407026 \\end{pmatrix},$$\n所以 $x_{a}^{b}(T;4\\,\\mathrm{h}) \\approx 0.6615131604$。\n\n情况1：$\\Delta t_{c} = 1\\,\\mathrm{h}$，所以 $n=4$。那么\n$$D(1\\,\\mathrm{h}) = \\begin{pmatrix} \\exp(-\\lambda_{a}\\cdot 1)  0 \\\\ 0  \\exp(-\\lambda_{o}\\cdot 1) \\end{pmatrix} = \\begin{pmatrix} \\exp(-0.1)  0 \\\\ 0  \\exp(-0.02) \\end{pmatrix},$$\n其中\n$$\\exp(-0.1) \\approx 0.9048374180,\\qquad \\exp(-0.02) \\approx 0.9801986733.$$\n因此\n$$A_{1} \\equiv M D(1\\,\\mathrm{h}) = \\begin{pmatrix} 0.6333861926  0.2940596020 \\\\ 0.0904837418  0.8821788060 \\end{pmatrix}.$$\n我们计算 $A_{1}^{2}$ 和 $A_{1}^{4}$：\n$$A_{1}^{2} \\approx \\begin{pmatrix} 0.4277871291  0.4456664796 \\\\ 0.1371341420  0.8048471000 \\end{pmatrix}, \\qquad A_{1}^{4} = A_{1}^{2}\\,A_{1}^{2} \\approx \\begin{pmatrix} 0.2441218000  0.5493439000 \\\\ 0.1690340000  0.7088988000 \\end{pmatrix}.$$\n应用于初始状态，\n$$\\begin{pmatrix} x_{a}^{b}(T;1\\,\\mathrm{h}) \\\\ x_{o}^{b}(T;1\\,\\mathrm{h}) \\end{pmatrix} = A_{1}^{4} \\begin{pmatrix} 2 \\\\ -1 \\end{pmatrix} \\approx \\begin{pmatrix} -0.0611003000 \\\\ -0.3708308000 \\end{pmatrix},$$\n所以 $x_{a}^{b}(T;1\\,\\mathrm{h}) \\approx -0.0611003000$。\n\n使用 $B_{a}(T)=1.0$ 和 $R=0.25$，标量卡尔曼增益为\n$$K = \\frac{B_{a}(T)}{B_{a}(T) + R} = \\frac{1.0}{1.0 + 0.25} = 0.8.$$\n分析增量为\n$$I(1\\,\\mathrm{h}) = K \\big(y - x_{a}^{b}(T;1\\,\\mathrm{h})\\big) = 0.8 \\big(0.5 - (-0.0611003000)\\big) \\approx 0.4488802400,$$\n$$I(4\\,\\mathrm{h}) = K \\big(y - x_{a}^{b}(T;4\\,\\mathrm{h})\\big) = 0.8 \\big(0.5 - 0.6615131604\\big) \\approx -0.1292105283.$$\n因此，所求的差异为\n$$\\Delta I = I(1\\,\\mathrm{h}) - I(4\\,\\mathrm{h}) \\approx 0.4488802400 - (-0.1292105283) \\approx 0.5780907683.$$\n四舍五入到四位有效数字并以 $\\mathrm{K}$ 为单位表示，结果是 $0.5781\\,\\mathrm{K}$。",
            "answer": "$$\\boxed{0.5781}$$"
        }
    ]
}