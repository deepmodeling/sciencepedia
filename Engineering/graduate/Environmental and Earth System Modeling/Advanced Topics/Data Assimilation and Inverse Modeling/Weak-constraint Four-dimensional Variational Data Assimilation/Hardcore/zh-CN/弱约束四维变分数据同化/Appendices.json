{
    "hands_on_practices": [
        {
            "introduction": "变分数据同化系统的核心在于一个高效的优化过程，而这一过程依赖于对成本函数梯度的精确计算。本练习将引导你使用拉格朗日乘子法，从第一性原理出发，推导弱约束4D-Var的一阶最优性条件。通过这个推导，你将掌握伴随方程的递归形式和模型误差项的平稳性条件，这是理解和开发任何变分同化系统的基础理论技能。",
            "id": "3426006",
            "problem": "考虑一个表述为弱约束四维变分（4D-Var）数据同化的离散时间、有限时域数据同化问题。设离散时间 $k = 0, 1, \\dots, N$ 的状态为 $x_k \\in \\mathbb{R}^{n}$，并假设其动力学由一个可能非线性且带有加性模式误差的模式给出，\n$$\nx_{k+1} = m_k(x_k) + \\eta_k,\n$$\n其中 $m_k: \\mathbb{R}^{n} \\to \\mathbb{R}^{n}$ 是连续可微的，$\\eta_k \\in \\mathbb{R}^{n}$ 是时间 $k$ 的模式误差。观测值 $y_k \\in \\mathbb{R}^{p_k}$ 通过一个观测算子 $H_k: \\mathbb{R}^{n} \\to \\mathbb{R}^{p_k}$ 与状态相关联，该算子假定为可微的，并带有加性零均值高斯观测误差，其协方差为对称正定矩阵 $R_k \\in \\mathbb{R}^{p_k \\times p_k}$。模式误差假定为零均值高斯分布，其协方差为对称正定矩阵 $Q_k \\in \\mathbb{R}^{n \\times n}$。先验（背景）状态 $x_b \\in \\mathbb{R}^{n}$ 的误差协方差为对称正定矩阵 $B \\in \\mathbb{R}^{n \\times n}$。\n\n定义弱约束 4D-Var 代价函数\n$$\nJ(x_0, \\{\\eta_k\\}_{k=0}^{N-1}) = \\tfrac{1}{2} (x_0 - x_b)^{\\top} B^{-1} (x_0 - x_b) + \\tfrac{1}{2} \\sum_{k=0}^{N} \\left(H_k(x_k) - y_k\\right)^{\\top} R_k^{-1} \\left(H_k(x_k) - y_k\\right) + \\tfrac{1}{2} \\sum_{k=0}^{N-1} \\eta_k^{\\top} Q_k^{-1} \\eta_k,\n$$\n其中状态序列 $\\{x_k\\}$ 受模式 $x_{k+1} = m_k(x_k) + \\eta_k$ 的约束。\n\n从这些定义出发，利用拉格朗日乘子和变分法的约束优化第一性原理，推导弱约束 4D-Var 关于 $x_0$ 和 $\\{\\eta_k\\}$ 的一阶最优性条件，包括：\n- 以模式和观测算子的雅可比矩阵表示的伴随递归关系，\n- 边界（终端）伴随条件，\n- 以及关于模式误差控制量 $\\{\\eta_k\\}$ 的平稳性条件。\n\n将模式的雅可比矩阵表示为 $M_k'(x_k) = \\nabla m_k(x_k) \\in \\mathbb{R}^{n \\times n}$，观测算子的雅可比矩阵表示为 $H_k'(x_k) = \\nabla H_k(x_k) \\in \\mathbb{R}^{p_k \\times n}$，并定义新息 $d_k = H_k(x_k) - y_k$。最后，给出最优控制更新 $\\eta_k$ 关于 $Q_k$ 和时间 $k+1$ 的伴随变量的闭式解析表达式。\n\n你的最终输出必须是该控制更新的单个符号数学表达式。不需要进行数值计算或四舍五入。",
            "solution": "该问题要求使用拉格朗日乘子法推导弱约束四维变分（4D-Var）数据同化问题的一阶最优性条件。目标是找到初始状态 $x_0$ 和模式误差序列 $\\{\\eta_k\\}_{k=0}^{N-1}$，以在模式动力学施加的约束下最小化给定的代价函数 $J$。\n\n需要最小化的代价函数是：\n$$\nJ(x_0, \\{\\eta_k\\}_{k=0}^{N-1}) = \\tfrac{1}{2} (x_0 - x_b)^{\\top} B^{-1} (x_0 - x_b) + \\tfrac{1}{2} \\sum_{k=0}^{N} \\left(H_k(x_k) - y_k\\right)^{\\top} R_k^{-1} \\left(H_k(x_k) - y_k\\right) + \\tfrac{1}{2} \\sum_{k=0}^{N-1} \\eta_k^{\\top} Q_k^{-1} \\eta_k\n$$\n此最小化问题受制于作为约束条件的模式动力学：\n$$\nx_{k+1} = m_k(x_k) + \\eta_k, \\quad \\text{for } k = 0, 1, \\dots, N-1\n$$\n为求解此约束优化问题，我们通过将代价函数与约束条件相增广来构造拉格朗日量 $\\mathcal{L}$，其中约束条件由一系列拉格朗日乘子（或称伴随变量）$\\lambda_{k+1} \\in \\mathbb{R}^n$（其中 $k = 0, \\dots, N-1$）加权。在拉格朗日量的构造中，我们将状态轨迹 $\\{x_k\\}_{k=0}^N$ 和模式误差 $\\{\\eta_k\\}_{k=0}^{N-1}$ 视为独立变量。拉格朗日乘子项的符号选择是一种约定；我们采用控制理论和数据同化领域中通用的约定。\n$$\n\\mathcal{L} \\left(\\{x_k\\}_{k=0}^N, \\{\\eta_k\\}_{k=0}^{N-1}, \\{\\lambda_k\\}_{k=1}^N\\right) = J - \\sum_{k=0}^{N-1} \\lambda_{k+1}^{\\top} \\left( x_{k+1} - m_k(x_k) - \\eta_k \\right)\n$$\n获得极值的一阶必要条件是拉格朗日量对其所有参数的偏导数必须为零。我们接下来计算这些导数。\n\n1.  **关于拉格朗日乘子 $\\lambda_{k+1}$（$k=0, \\dots, N-1$）的导数：**\n    取 $\\mathcal{L}$ 关于 $\\lambda_{k+1}$ 的梯度并令其为零，可恢复模式约束方程：\n    $$\n    \\nabla_{\\lambda_{k+1}} \\mathcal{L} = -\\left( x_{k+1} - m_k(x_k) - \\eta_k \\right) = 0\n    $$\n    $$\n    \\implies x_{k+1} = m_k(x_k) + \\eta_k\n    $$\n    这证实了在最优点，状态轨迹必须满足模式动力学。\n\n2.  **关于控制变量 $\\eta_k$（$k=0, \\dots, N-1$）的导数：**\n    我们取 $\\mathcal{L}$ 关于每个模式误差向量 $\\eta_k$ 的梯度。$\\mathcal{L}$ 中依赖于特定 $\\eta_k$ 的项是 $\\tfrac{1}{2}\\eta_k^{\\top} Q_k^{-1} \\eta_k$ 和 $\\lambda_{k+1}^{\\top}\\eta_k$。\n    $$\n    \\nabla_{\\eta_k} \\mathcal{L} = \\nabla_{\\eta_k} \\left(\\tfrac{1}{2}\\eta_k^{\\top} Q_k^{-1} \\eta_k\\right) + \\nabla_{\\eta_k} \\left(\\lambda_{k+1}^{\\top}\\eta_k\\right) = Q_k^{-1} \\eta_k + \\lambda_{k+1} = 0\n    $$\n    这就给出了**关于模式误差控制量 $\\{\\eta_k\\}$ 的平稳性条件**。求解 $\\eta_k$ 可得最优模式误差关于伴随变量的闭式表达式：\n    $$\n    \\eta_k = -Q_k \\lambda_{k+1}\n    $$\n\n3.  **关于终端状态 $x_N$ 的导数：**\n    $\\mathcal{L}$ 中依赖于 $x_N$ 的项是最终观测项 $\\tfrac{1}{2}(H_N(x_N) - y_N)^{\\top} R_N^{-1} (H_N(x_N) - y_N)$ 和最终约束项 $-\\lambda_N^{\\top}x_N$。使用记号 $d_k = H_k(x_k) - y_k$ 和 $H_k' = \\nabla H_k(x_k)$：\n    $$\n    \\nabla_{x_N} \\mathcal{L} = \\nabla_{x_N} \\left(\\tfrac{1}{2}d_N^{\\top}R_N^{-1}d_N\\right) - \\nabla_{x_N}\\left(\\lambda_N^{\\top}x_N\\right) = (H_N'(x_N))^{\\top} R_N^{-1} d_N - \\lambda_N = 0\n    $$\n    这导出了**边界（终端）伴随条件**：\n    $$\n    \\lambda_N = (H_N'(x_N))^{\\top} R_N^{-1} d_N\n    $$\n\n4.  **关于中间状态 $x_k$（$k=1, \\dots, N-1$）的导数：**\n    对于轨迹中间的某个状态 $x_k$，$\\mathcal{L}$ 中的相关项是时间 $k$ 的观测项、连接 $x_k$ 与 $x_{k-1}$ 的约束项（即 $-\\lambda_k^{\\top}x_k$）以及连接 $x_{k+1}$ 与 $x_k$ 的约束项（即 $\\lambda_{k+1}^{\\top}m_k(x_k)$）。\n    $$\n    \\nabla_{x_k} \\mathcal{L} = \\nabla_{x_k}\\left(\\tfrac{1}{2}d_k^{\\top}R_k^{-1}d_k\\right) - \\nabla_{x_k}\\left(\\lambda_k^{\\top}x_k\\right) + \\nabla_{x_k}\\left(\\lambda_{k+1}^{\\top}m_k(x_k)\\right) = 0\n    $$\n    使用记号 $M_k' = \\nabla m_k(x_k)$：\n    $$\n    (H_k'(x_k))^{\\top} R_k^{-1} d_k - \\lambda_k + (M_k'(x_k))^{\\top} \\lambda_{k+1} = 0\n    $$\n    整理此方程可得**伴随递归关系**：\n    $$\n    \\lambda_k = (M_k'(x_k))^{\\top} \\lambda_{k+1} + (H_k'(x_k))^{\\top} R_k^{-1} d_k, \\quad \\text{for } k=N-1, \\dots, 1\n    $$\n    该关系表明，伴随变量 $\\lambda_k$ 从 $k=N$ 的终端条件开始，随时间向后传播。\n\n5.  **关于初始状态 $x_0$ 的导数**：\n    最后，我们计算关于控制变量 $x_0$ 的梯度。相关项是背景项、 $k=0$ 时的观测项以及涉及 $m_0(x_0)$ 的第一个约束项。\n    $$\n    \\nabla_{x_0} \\mathcal{L} = \\nabla_{x_0}\\left(\\tfrac{1}{2}(x_0-x_b)^{\\top}B^{-1}(x_0-x_b)\\right) + \\nabla_{x_0}\\left(\\tfrac{1}{2}d_0^{\\top}R_0^{-1}d_0\\right) + \\nabla_{x_0}\\left(\\lambda_1^{\\top}m_0(x_0)\\right) = 0\n    $$\n    $$\n    B^{-1}(x_0 - x_b) + (H_0'(x_0))^{\\top} R_0^{-1} d_0 + (M_0'(x_0))^{\\top} \\lambda_1 = 0\n    $$\n    该方程是 $x_0$ 的平稳性条件，它代表了代价函数 $J$ 关于 $x_0$ 的梯度。如果我们通过扩展递归关系来定义一个初始伴随变量 $\\lambda_0 = (M_0'(x_0))^{\\top} \\lambda_1 + (H_0'(x_0))^{\\top} R_0^{-1} d_0$，则平稳性条件简化为 $B^{-1}(x_0 - x_b) + \\lambda_0 = 0$。\n\n总之，一阶最优性条件包括前向模式积分、后向伴随模式积分以及控制量的解析表达式。问题特别要求给出最优控制更新 $\\eta_k$ 的表达式。如步骤 2 所推导，这由关于模式误差的平稳性条件给出。\n\n所需的最优控制更新 $\\eta_k$ 的表达式是平稳性条件 $\\nabla_{\\eta_k} \\mathcal{L} = 0$ 的直接结果。通过对该条件 $Q_k^{-1} \\eta_k + \\lambda_{k+1} = 0$ 左乘模式误差协方差矩阵 $Q_k$，即可解出 $\\eta_k$。",
            "answer": "$$\n\\boxed{\\eta_k = -Q_k \\lambda_{k+1}}\n$$"
        },
        {
            "introduction": "在掌握了弱约束4D-Var的理论和实现验证后，我们通过一个具体的例子来揭示其相对于传统强约束方法的优势。这个思想实验将展示弱约束4D-Var如何通过引入和估计模型误差项，成功地拟合存在系统性偏差的观测数据。通过这个计算，你将直观地理解为何弱约束框架在处理不完美模型时更加灵活和强大。",
            "id": "3431076",
            "problem": "考虑一个一维离散时间动力系统，其时间窗口由 $k \\in \\{0,1,2\\}$ 索引，状态为 $x_k \\in \\mathbb{R}$，观测算子 $H$ 由 $H x_k = x_k$ 给出。可用于同化的数据为观测值 $y_0 = 0$、$y_1 = 1$ 和 $y_2 = 2$。同化中使用的预报模型是持续性模型 $M_k(x_k) = x_k$，因此在不允许模型误差的情况下，预报约束为 $x_{k+1} = x_k$。初始条件的背景场（先验）为 $x_0 \\sim \\mathcal{N}(x_b, \\sigma_b^2)$，其中 $x_b = 0$ 且 $\\sigma_b^2 = 1$。每个时刻的观测误差是独立的，并服从方差为 $\\sigma_o^2 = 1$ 的高斯分布。\n\n1. 解释为什么在强约束四维变分同化（4D-Var）下，不存在任何 $x_0$ 的选择可以精确拟合所有观测值 $y_0, y_1, y_2$ 而不违反模型约束。强约束4D-Var假设模型是完美的，即 $x_{k+1} = x_k$，并且只估计 $x_0$。\n\n2. 现在采用弱约束四维变分同化（4D-Var），引入一个可加性模型误差序列，其简化的参数形式为 $w_k \\equiv b$（对于 $k \\in \\{0,1\\}$），其中 $b \\in \\mathbb{R}$ 是整个时间窗口内的恒定偏差。假设每个 $w_k$ 都有一个零均值高斯先验，方差为 $\\sigma_q^2 = 1$，且在时间上相互独立。利用高斯先验、高斯似然以及误差源之间相互独立的假设，为 $(x_0, b)$ 构建相应的最大后验估计问题，将其简化为关于 $(x_0, b)$ 的二次最小化问题，并求解唯一的极小值点。计算此特定数据集的最优恒定模型误差偏差 $b^{\\star}$ 的值。不要对结果进行四舍五入；请以精确形式给出。\n\n你的最终答案应该是 $b^{\\star}$ 的单个值，不带单位，也无额外评注。",
            "solution": "该问题要求在两种不同的框架下分析一个简单的数据同化场景：强约束和弱约束四维变分同化（4D-Var）。\n\n第一部分：强约束4D-Var\n\n在强约束4D-Var公式中，预报模型被假设是完美的。给定的预报模型是持续性模型 $M_k(x_k) = x_k$，这意味着模型约束为 $x_{k+1} = x_k$（对于 $k \\in \\{0, 1\\}$）。在此设置中，控制变量仅为初始状态 $x_0$。\n\n在这个完美模型的假设下，整个同化窗口内的系统状态由初始状态决定：\n$$x_1 = M_0(x_0) = x_0$$\n$$x_2 = M_1(x_1) = x_1 = x_0$$\n因此，模型动力学施加了严格的约束 $x_0 = x_1 = x_2$。\n\n问题指出，要精确拟合观测值，就需要模型在每个时刻 $k$ 的状态等于相应的观测值 $y_k$。给定的观测值为 $y_0 = 0$、$y_1 = 1$ 和 $y_2 = 2$。因此，精确拟合将意味着：\n$$x_0 = y_0 = 0$$\n$$x_1 = y_1 = 1$$\n$$x_2 = y_2 = 2$$\n\n这三个条件 $x_0 = 0$、$x_1 = 1$ 和 $x_2 = 2$ 与模型约束 $x_0 = x_1 = x_2$ 直接矛盾。单个 $x_0$ 的值不可能同时满足 $x_0 = 0$、$x_0 = 1$ 和 $x_0 = 2$。因此，不存在任何初始状态 $x_0$ 的选择可以在不违反完美模型约束的情况下完美拟合所有三个观测值。强约束4D-Var会找到一个最优的 $x_0$ 来最小化一个代价函数，该函数平衡了与观测的拟合误差和与背景场的拟合误差，但在这种情况下，它永远无法实现与所有观测的零拟合误差。\n\n第二部分：弱约束4D-Var\n\n在弱约束4D-Var公式中，模型被允许是不完美的。这是通过引入一个模型误差项 $w_k$ 来实现的。现在的模型动力学由下式给出：\n$$x_{k+1} = M_k(x_k) + w_k = x_k + w_k$$\n问题为模型误差指定了一个简化的参数化形式，即在整个时间窗口内它是一个恒定偏差：$w_k \\equiv b$（对于 $k \\in \\{0, 1\\}$）。现在，同化的控制变量是初始状态 $x_0$ 和恒定模型误差偏差 $b$。\n\n目标是找到 $(x_0, b)$ 的值，以最大化后验概率密度。在误差服从高斯分布的假设下，这等同于最小化一个二次代价函数 $J(x_0, b)$。该代价函数是三项之和：背景项（$J_b$）、模型误差项（$J_q$）和观测项（$J_o$）。\n$$J(x_0, b) = J_b(x_0) + J_q(b) + J_o(x_0, b)$$\n\n1.  背景项惩罚初始状态 $x_0$ 与背景估计 $x_b$ 的偏差：\n    $$J_b(x_0) = \\frac{1}{2\\sigma_b^2}(x_0 - x_b)^2$$\n    当 $x_b = 0$ 且 $\\sigma_b^2 = 1$ 时，此项变为 $J_b(x_0) = \\frac{1}{2}x_0^2$。\n\n2.  模型误差项惩罚模型误差与其先验估计（零均值）的偏离。由于模型误差序列为 $w_0 = b$ 和 $w_1 = b$，且每个 $w_k$ 的先验是独立的，方差为 $\\sigma_q^2$，因此该项为：\n    $$J_q(b) = \\sum_{k=0}^{1} \\frac{1}{2\\sigma_q^2}w_k^2 = \\frac{1}{2\\sigma_q^2}b^2 + \\frac{1}{2\\sigma_q^2}b^2 = \\frac{b^2}{\\sigma_q^2}$$\n    当 $\\sigma_q^2 = 1$ 时，此项变为 $J_q(b) = b^2$。\n\n3.  观测项惩罚模型轨迹与观测值之间的拟合误差。首先，我们用控制变量 $x_0, b$ 来表示轨迹 $x_1, x_2$：\n    $$x_1 = x_0 + w_0 = x_0 + b$$\n    $$x_2 = x_1 + w_1 = (x_0 + b) + b = x_0 + 2b$$\n    观测项为：\n    $$J_o(x_0, b) = \\sum_{k=0}^{2} \\frac{1}{2\\sigma_o^2}(y_k - Hx_k)^2$$\n    当观测算子为 $H x_k = x_k$，观测值为 $y_0 = 0$、$y_1 = 1$、$y_2 = 2$，方差为 $\\sigma_o^2 = 1$ 时，此项变为：\n    $$J_o(x_0, b) = \\frac{1}{2} \\left[ (y_0 - x_0)^2 + (y_1 - x_1)^2 + (y_2 - x_2)^2 \\right]$$\n    $$J_o(x_0, b) = \\frac{1}{2} \\left[ (0 - x_0)^2 + (1 - (x_0 + b))^2 + (2 - (x_0 + 2b))^2 \\right]$$\n\n结合这些项，总代价函数为：\n$$J(x_0, b) = \\frac{1}{2}x_0^2 + b^2 + \\frac{1}{2} \\left[ x_0^2 + (1 - x_0 - b)^2 + (2 - x_0 - 2b)^2 \\right]$$\n为了找到最小化 $J$ 的最优值 $(x_0^\\star, b^\\star)$，我们计算 $J$ 关于 $x_0$ 和 $b$ 的梯度，并将其设为零。\n\n关于 $x_0$ 的偏导数：\n$$\\frac{\\partial J}{\\partial x_0} = x_0 + \\frac{1}{2} \\left[ 2x_0 + 2(1 - x_0 - b)(-1) + 2(2 - x_0 - 2b)(-1) \\right]$$\n$$\\frac{\\partial J}{\\partial x_0} = x_0 + x_0 - (1 - x_0 - b) - (2 - x_0 - 2b)$$\n$$\\frac{\\partial J}{\\partial x_0} = 2x_0 - 1 + x_0 + b - 2 + x_0 + 2b = 4x_0 + 3b - 3$$\n\n关于 $b$ 的偏导数：\n$$\\frac{\\partial J}{\\partial b} = 2b + \\frac{1}{2} \\left[ 2(1 - x_0 - b)(-1) + 2(2 - x_0 - 2b)(-2) \\right]$$\n$$\\frac{\\partial J}{\\partial b} = 2b - (1 - x_0 - b) - 2(2 - x_0 - 2b)$$\n$$\\frac{\\partial J}{\\partial b} = 2b - 1 + x_0 + b - 4 + 2x_0 + 4b = 3x_0 + 7b - 5$$\n\n将偏导数设为零，得到关于 $(x_0, b)$ 的线性方程组：\n1) $4x_0 + 3b = 3$\n2) $3x_0 + 7b = 5$\n\n我们可以求解这个方程组。从方程（1）中，我们将 $x_0$ 用 $b$ 表示：\n$$4x_0 = 3 - 3b \\implies x_0 = \\frac{3 - 3b}{4}$$\n将这个 $x_0$ 的表达式代入方程（2）：\n$$3\\left(\\frac{3 - 3b}{4}\\right) + 7b = 5$$\n将整个方程乘以 $4$ 以消去分数：\n$$3(3 - 3b) + 28b = 20$$\n$$9 - 9b + 28b = 20$$\n$$19b = 11$$\n$$b^\\star = \\frac{11}{19}$$\n这就是最优的恒定模型误差偏差。问题要求的就是这个值。Hessian矩阵的正定性保证了这是一个唯一的极小值点。",
            "answer": "$$\\boxed{\\frac{11}{19}}$$"
        }
    ]
}