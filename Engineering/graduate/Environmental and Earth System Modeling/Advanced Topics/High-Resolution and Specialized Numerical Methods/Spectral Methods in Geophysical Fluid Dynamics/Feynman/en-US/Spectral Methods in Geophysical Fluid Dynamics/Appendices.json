{
    "hands_on_practices": [
        {
            "introduction": "A central advantage of spectral methods is their ability to transform complex differential operators into simple algebraic multipliers. This exercise provides a foundational demonstration of this principle. By deriving the spectral representation of the biharmonic operator $\\nabla^{4}$, you will see firsthand how its action on a field is reduced to a straightforward multiplication in the spectral domain, a property crucial for efficiently solving partial differential equations .",
            "id": "3914974",
            "problem": "Consider a scalar field $q(\\theta,\\phi)$ on the unit sphere, represented in standard spherical coordinates $\\theta \\in [0,\\pi]$ and $\\phi \\in [0,2\\pi)$. The unit sphere implies the geometric radius $a$ is $a = 1$, so all operators are dimensionless. The Laplace–Beltrami operator $\\nabla^{2}$ (also called the spherical Laplacian) on the unit sphere is defined by\n$$\n\\nabla^{2} f(\\theta,\\phi) \\equiv \\frac{1}{\\sin\\theta}\\frac{\\partial}{\\partial \\theta}\\!\\left(\\sin\\theta\\,\\frac{\\partial f}{\\partial \\theta}\\right) + \\frac{1}{\\sin^{2}\\theta}\\,\\frac{\\partial^{2} f}{\\partial \\phi^{2}}.\n$$\nAssume $q(\\theta,\\phi)$ admits a spherical harmonic expansion\n$$\nq(\\theta,\\phi) = \\sum_{\\ell=0}^{\\infty}\\sum_{m=-\\ell}^{\\ell} \\hat{q}_{\\ell m}\\,Y_{\\ell}^{m}(\\theta,\\phi),\n$$\nwhere $Y_{\\ell}^{m}(\\theta,\\phi)$ are the orthonormal spherical harmonics on the unit sphere. Using the completeness and orthogonality of $Y_{\\ell}^{m}$ and the definition of the Laplace–Beltrami operator on the sphere, derive the spectral (spherical harmonic) representation of the biharmonic operator $\\nabla^{4} \\equiv \\nabla^{2}\\nabla^{2}$ acting on $q(\\theta,\\phi)$, and compute the corresponding eigenvalues in terms of the total wavenumber $\\ell$. Your final answer must be a single closed-form analytic expression in terms of $\\ell$ only, corresponding to the eigenvalue of $\\nabla^{4}$ acting on $Y_{\\ell}^{m}$ on the unit sphere. No numerical approximation is required.",
            "solution": "The problem statement has been subjected to a rigorous validation process.\n\n**Step 1: Extract Givens**\n- Scalar field on the unit sphere: $q(\\theta,\\phi)$, with $\\theta \\in [0,\\pi]$ and $\\phi \\in [0,2\\pi)$.\n- Unit sphere radius: $a = 1$.\n- Laplace–Beltrami operator: $\\nabla^{2} f(\\theta,\\phi) \\equiv \\frac{1}{\\sin\\theta}\\frac{\\partial}{\\partial \\theta}\\!\\left(\\sin\\theta\\,\\frac{\\partial f}{\\partial \\theta}\\right) + \\frac{1}{\\sin^{2}\\theta}\\,\\frac{\\partial^{2} f}{\\partial \\phi^{2}}$.\n- Spherical harmonic expansion: $q(\\theta,\\phi) = \\sum_{\\ell=0}^{\\infty}\\sum_{m=-\\ell}^{\\ell} \\hat{q}_{\\ell m}\\,Y_{\\ell}^{m}(\\theta,\\phi)$.\n- Basis functions: $Y_{\\ell}^{m}(\\theta,\\phi)$ are the orthonormal spherical harmonics on the unit sphere.\n- Biharmonic operator definition: $\\nabla^{4} \\equiv \\nabla^{2}\\nabla^{2}$.\n- Objective: Derive the spectral representation of $\\nabla^{4} q(\\theta,\\phi)$ and compute the corresponding eigenvalues of the $\\nabla^4$ operator in terms of the total wavenumber $\\ell$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, as it is based on standard, well-established principles of mathematical physics and differential geometry concerning the Laplace–Beltrami operator and spherical harmonics. It is well-posed, with all necessary definitions provided to determine a unique, meaningful solution for the eigenvalues. The language is objective and precise. The problem is self-contained, consistent, and mathematically feasible. No flaws related to scientific unsoundness, incompleteness, or ambiguity have been identified.\n\n**Step 3: Verdict and Action**\nThe problem is deemed valid. A solution will be derived.\n\nThe derivation proceeds from the fundamental properties of spherical harmonics with respect to the Laplace–Beltrami operator. The spherical harmonics $Y_{\\ell}^{m}(\\theta,\\phi)$ are, by definition, the eigenfunctions of the Laplace–Beltrami operator $\\nabla^2$ on the surface of a sphere. For a sphere of radius $a$, the eigenvalue equation is:\n$$\n\\nabla^{2} Y_{\\ell}^{m}(\\theta,\\phi) = -\\frac{\\ell(\\ell+1)}{a^2} Y_{\\ell}^{m}(\\theta,\\phi)\n$$\nwhere $\\ell$ is the total wavenumber (a non-negative integer, $\\ell \\ge 0$) and $m$ is the zonal wavenumber (an integer, $-\\ell \\le m \\le \\ell$). The problem specifies a unit sphere, for which $a=1$. Therefore, the eigenvalue equation simplifies to:\n$$\n\\nabla^{2} Y_{\\ell}^{m}(\\theta,\\phi) = -\\ell(\\ell+1) Y_{\\ell}^{m}(\\theta,\\phi)\n$$\nThe value $-\\ell(\\ell+1)$ is the eigenvalue of the operator $\\nabla^2$ corresponding to the eigenfunction $Y_{\\ell}^{m}$.\n\nThe problem asks for the spectral representation and eigenvalues of the biharmonic operator, $\\nabla^{4}$, defined as $\\nabla^{4} \\equiv \\nabla^{2}\\nabla^{2}$. This means applying the Laplace–Beltrami operator twice. The linearity of $\\nabla^2$ is a critical property.\n\nLet us find the effect of $\\nabla^4$ on a single spherical harmonic basis function $Y_{\\ell}^{m}(\\theta,\\phi)$.\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = \\nabla^{2} \\left( \\nabla^{2} Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nWe substitute the result from the eigenvalue equation for $\\nabla^{2} Y_{\\ell}^{m}(\\theta,\\phi)$:\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = \\nabla^{2} \\left( -\\ell(\\ell+1) Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nSince $-\\ell(\\ell+1)$ is a scalar constant for any given $\\ell$, it can be factored out of the linear operator $\\nabla^2$:\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = -\\ell(\\ell+1) \\left( \\nabla^{2} Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nNow, we apply the eigenvalue property of $\\nabla^2$ a second time:\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = -\\ell(\\ell+1) \\left( -\\ell(\\ell+1) Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nMultiplying the scalar factors yields:\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = \\left( -\\ell(\\ell+1) \\right)^2 Y_{\\ell}^{m}(\\theta,\\phi)\n$$\n$$\n\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) = (\\ell(\\ell+1))^2 Y_{\\ell}^{m}(\\theta,\\phi)\n$$\nThis is an eigenvalue equation for the operator $\\nabla^4$. It shows that the spherical harmonics $Y_{\\ell}^{m}$ are also eigenfunctions of the biharmonic operator $\\nabla^4$, with the corresponding eigenvalues given by $(\\ell(\\ell+1))^2$. The eigenvalue depends only on the total wavenumber $\\ell$, not on the zonal wavenumber $m$.\n\nTo find the spectral representation of $\\nabla^{4}q(\\theta,\\phi)$, we apply the operator to the spherical harmonic expansion of $q(\\theta,\\phi)$. Due to the linearity of $\\nabla^4$, we can apply the operator to each term in the series individually:\n$$\n\\nabla^{4} q(\\theta,\\phi) = \\nabla^{4} \\left( \\sum_{\\ell=0}^{\\infty}\\sum_{m=-\\ell}^{\\ell} \\hat{q}_{\\ell m}\\,Y_{\\ell}^{m}(\\theta,\\phi) \\right) = \\sum_{\\ell=0}^{\\infty}\\sum_{m=-\\ell}^{\\ell} \\hat{q}_{\\ell m} \\left( \\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nSubstituting our result for $\\nabla^{4} Y_{\\ell}^{m}(\\theta,\\phi)$:\n$$\n\\nabla^{4} q(\\theta,\\phi) = \\sum_{\\ell=0}^{\\infty}\\sum_{m=-\\ell}^{\\ell} \\hat{q}_{\\ell m} \\left( (\\ell(\\ell+1))^2 Y_{\\ell}^{m}(\\theta,\\phi) \\right)\n$$\nThis is the spectral representation of $\\nabla^{4}q(\\theta,\\phi)$. The spherical harmonic coefficients of $\\nabla^{4}q$ are $(\\ell(\\ell+1))^2 \\hat{q}_{\\ell m}$.\n\nThe problem explicitly asks for the eigenvalue of $\\nabla^4$ acting on $Y_{\\ell}^m$ as a closed-form analytic expression in terms of $\\ell$. From the eigenvalue equation $\\nabla^{4} Y_{\\ell}^{m} = (\\ell(\\ell+1))^2 Y_{\\ell}^{m}$, this eigenvalue is clearly $(\\ell(\\ell+1))^2$.",
            "answer": "$$\n\\boxed{(\\ell(\\ell+1))^2}\n$$"
        },
        {
            "introduction": "The structure of a physical field is directly mirrored in its spectral representation, and understanding this link is key to interpreting model outputs and data. This practice focuses on a fundamental example: a zonally symmetric field, which depends only on latitude. You will prove why such a field is composed exclusively of zonal spherical harmonic modes ($m=0$), reinforcing the role of orthogonality in decomposing geophysical fields .",
            "id": "3915028",
            "problem": "Consider a scalar field on the unit sphere that depends only on geographic latitude, denoted $f(\\phi)$, where longitude is $\\lambda \\in [0,2\\pi)$ and latitude is $\\phi \\in \\left[-\\frac{\\pi}{2},\\frac{\\pi}{2}\\right]$. Let colatitude be $\\theta = \\frac{\\pi}{2}-\\phi$, so that $\\cos\\theta = \\sin\\phi$ and $\\sin\\theta = \\cos\\phi$. The complex spherical harmonics $Y_{\\ell}^{m}(\\theta,\\lambda)$ are defined by\n$$\nY_{\\ell}^{m}(\\theta,\\lambda) \\;=\\; N_{\\ell m}\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\exp(i m \\lambda),\n$$\nwith $P_{\\ell}^{m}$ the associated Legendre function (using the Condon–Shortley phase convention) and\n$$\nN_{\\ell m} \\;=\\; \\sqrt{\\frac{2\\ell+1}{4\\pi}\\,\\frac{(\\ell - m)!}{(\\ell + m)!}}.\n$$\nAssume the standard $L^{2}$ inner product on the unit sphere, so the spherical harmonic coefficient $a_{\\ell m}$ of $f$ is defined by the surface inner product\n$$\na_{\\ell m} \\;=\\; \\int_{0}^{2\\pi}\\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,Y_{\\ell}^{m}(\\theta,\\lambda)^{\\ast}\\,\\cos\\phi\\,\\mathrm{d}\\phi\\,\\mathrm{d}\\lambda,\n$$\nwhere ${}^{\\ast}$ denotes complex conjugation and the surface element is $\\mathrm{d}\\Omega=\\cos\\phi\\,\\mathrm{d}\\phi\\,\\mathrm{d}\\lambda$ on the unit sphere.\n\nStarting from the above definitions and only the fundamental orthogonality of the complex exponentials on $[0,2\\pi)$, namely\n$$\n\\int_{0}^{2\\pi} \\exp\\!\\big(i(m-m')\\lambda\\big)\\,\\mathrm{d}\\lambda \\;=\\; 2\\pi\\,\\delta_{m m'},\n$$\nderive a single closed-form expression for $a_{\\ell m}$ in terms of a one-dimensional integral over $\\phi$, and explain rigorously why only zonal wavenumber $m=0$ modes can be nonzero for a latitude-only field $f(\\phi)$. Your final answer must be a single analytic expression for $a_{\\ell m}$ written entirely in terms of $f(\\phi)$, $\\ell$, $m$, the Legendre polynomial $P_{\\ell}$, and standard constants. No numerical evaluation is required, and no units are needed. Express the final answer as a single expression; do not provide multiple cases separately.",
            "solution": "The problem as stated is valid. It is scientifically grounded in the principles of mathematical physics, internally consistent, well-posed, and contains all necessary information for a unique solution. We may therefore proceed with the derivation.\n\nThe spherical harmonic coefficient $a_{\\ell m}$ for a scalar field $f$ on the unit sphere is given by the inner product:\n$$\na_{\\ell m} \\;=\\; \\int_{0}^{2\\pi}\\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,Y_{\\ell}^{m}(\\theta,\\lambda)^{\\ast}\\,\\cos\\phi\\,\\mathrm{d}\\phi\\,\\mathrm{d}\\lambda\n$$\nwhere ${}^{\\ast}$ denotes complex conjugation, $\\phi$ is the latitude, $\\lambda$ is the longitude, and $\\theta = \\frac{\\pi}{2}-\\phi$ is the colatitude. The surface element on the unit sphere is $\\mathrm{d}\\Omega=\\cos\\phi\\,\\mathrm{d}\\phi\\,\\mathrm{d}\\lambda$.\n\nThe complex spherical harmonics $Y_{\\ell}^{m}(\\theta, \\lambda)$ are defined as:\n$$\nY_{\\ell}^{m}(\\theta,\\lambda) \\;=\\; N_{\\ell m}\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\exp(i m \\lambda)\n$$\nwith $N_{\\ell m}$ being a real-valued normalization constant and $P_{\\ell}^{m}$ being the real-valued associated Legendre function. The complex conjugate is therefore:\n$$\nY_{\\ell}^{m}(\\theta,\\lambda)^{\\ast} \\;=\\; N_{\\ell m}\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\exp(-i m \\lambda)\n$$\nSubstituting this into the expression for $a_{\\ell m}$:\n$$\na_{\\ell m} \\;=\\; \\int_{0}^{2\\pi}\\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,\\left( N_{\\ell m}\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\exp(-i m \\lambda) \\right)\\,\\cos\\phi\\,\\mathrm{d}\\phi\\,\\mathrm{d}\\lambda\n$$\nThe problem states that the scalar field $f$ is a function of latitude only, i.e., $f(\\phi)$. The colatitude $\\theta$ is also only a function of $\\phi$. Therefore, the terms $f(\\phi)$, $N_{\\ell m}$, $P_{\\ell}^{m}(\\cos\\theta)$, and $\\cos\\phi$ are all independent of the longitude $\\lambda$. We can separate the double integral into a product of two single-variable integrals using Fubini's theorem:\n$$\na_{\\ell m} \\;=\\; N_{\\ell m} \\left( \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\cos\\phi\\,\\mathrm{d}\\phi \\right) \\left( \\int_{0}^{2\\pi} \\exp(-i m \\lambda)\\,\\mathrm{d}\\lambda \\right)\n$$\nWe now focus on the integral over longitude, $\\lambda$:\n$$\n\\int_{0}^{2\\pi} \\exp(-i m \\lambda)\\,\\mathrm{d}\\lambda\n$$\nThis integral can be evaluated using the provided orthogonality relation for complex exponentials:\n$$\n\\int_{0}^{2\\pi} \\exp\\!\\big(i(k-k')\\lambda\\big)\\,\\mathrm{d}\\lambda \\;=\\; 2\\pi\\,\\delta_{k k'}\n$$\nTo match our integral to this form, we can write $\\exp(-im\\lambda)$ as $\\exp(i(0-m)\\lambda)$. This corresponds to setting $k=0$ and $k'=m$ in the orthogonality relation. The evaluation is therefore:\n$$\n\\int_{0}^{2\\pi} \\exp(-i m \\lambda)\\,\\mathrm{d}\\lambda \\;=\\; 2\\pi\\,\\delta_{0 m}\n$$\nThe Kronecker delta, $\\delta_{0m}$, is equal to $1$ if $m=0$ and is equal to $0$ if $m \\neq 0$.\n\nSubstituting this result back into the expression for $a_{\\ell m}$:\n$$\na_{\\ell m} \\;=\\; N_{\\ell m} \\left( \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}^{m}(\\cos\\theta)\\,\\cos\\phi\\,\\mathrm{d}\\phi \\right) (2\\pi\\,\\delta_{0 m})\n$$\nThe presence of the factor $\\delta_{0m}$ provides the rigorous reason why only zonal wavenumber $m=0$ modes can be nonzero. If the zonal wavenumber $m$ is any integer other than zero, $\\delta_{0m}=0$, which forces the entire coefficient $a_{\\ell m}$ to be zero. Physically, a field $f(\\phi)$ that is independent of longitude is zonally symmetric and contains no wave-like variations in the zonal direction. Therefore, its spectral representation cannot contain any non-zonal ($m \\neq 0$) components.\n\nSince $a_{\\ell m} = 0$ for all $m \\neq 0$, we only need to evaluate the expression for the case $m=0$. For $m=0$, we have $\\delta_{00}=1$. The coefficient $a_{\\ell 0}$ is:\n$$\na_{\\ell 0} \\;=\\; 2\\pi\\,N_{\\ell 0} \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}^{0}(\\cos\\theta)\\,\\cos\\phi\\,\\mathrm{d}\\phi\n$$\nWe now simplify the terms for $m=0$. The normalization constant $N_{\\ell m}$ becomes:\n$$\nN_{\\ell 0} \\;=\\; \\sqrt{\\frac{2\\ell+1}{4\\pi}\\,\\frac{(\\ell - 0)!}{(\\ell + 0)!}} \\;=\\; \\sqrt{\\frac{2\\ell+1}{4\\pi}} \\;=\\; \\frac{\\sqrt{2\\ell+1}}{2\\sqrt{\\pi}}\n$$\nThe associated Legendre function $P_{\\ell}^{m}(x)$ for $m=0$ is identical to the ordinary Legendre polynomial $P_{\\ell}(x)$. Thus, $P_{\\ell}^{0}(\\cos\\theta) = P_{\\ell}(\\cos\\theta)$. Using the given relation $\\cos\\theta = \\sin\\phi$, we have $P_{\\ell}^{0}(\\cos\\theta) = P_{\\ell}(\\sin\\phi)$.\n\nSubstituting these simplified terms into the expression for $a_{\\ell 0}$:\n$$\na_{\\ell 0} \\;=\\; 2\\pi \\left( \\frac{\\sqrt{2\\ell+1}}{2\\sqrt{\\pi}} \\right) \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}(\\sin\\phi)\\,\\cos\\phi\\,\\mathrm{d}\\phi\n$$\nSimplifying the constants:\n$$\na_{\\ell 0} \\;=\\; \\sqrt{\\pi(2\\ell+1)} \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}(\\sin\\phi)\\,\\cos\\phi\\,\\mathrm{d}\\phi\n$$\nTo provide a single closed-form expression for $a_{\\ell m}$ that is valid for all integer $m$, we combine the results for $m=0$ and $m\\neq0$ using the Kronecker delta:\n$$\na_{\\ell m} \\;=\\; \\delta_{m0} \\sqrt{\\pi(2\\ell+1)} \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi)\\,P_{\\ell}(\\sin\\phi)\\,\\cos\\phi\\,\\mathrm{d}\\phi\n$$\nThis single expression satisfies all conditions. It yields zero for $m \\neq 0$ and gives the correct non-zero value for $m=0$. The expression is in terms of $f(\\phi)$, $\\ell$, $m$ (via $\\delta_{m0}$), the Legendre polynomial $P_{\\ell}$, and standard constants.",
            "answer": "$$\n\\boxed{\\delta_{m0} \\sqrt{\\pi(2\\ell+1)} \\int_{-\\frac{\\pi}{2}}^{\\frac{\\pi}{2}} f(\\phi) P_{\\ell}(\\sin\\phi) \\cos\\phi \\,\\mathrm{d}\\phi}\n$$"
        },
        {
            "introduction": "This culminating exercise synthesizes the principles of spectral decomposition into a practical and powerful application from computational fluid dynamics. You will implement an efficient solver for a coupled Helmholtz system, a core component of semi-implicit time-stepping schemes in weather and ocean models. This hands-on problem demonstrates how combining horizontal Fourier analysis with a vertical modal decomposition completely diagonalizes the system, leading to a highly efficient solution algorithm .",
            "id": "3914998",
            "problem": "Consider the linear, hydrostatic, multilayer shallow-water system under a semi-implicit time discretization on a periodic, square domain of side length $2\\pi$, in which the prognostic update for the layer-thickness perturbation vector field $u(x,y)\\in\\mathbb{R}^N$ (with $N$ vertical layers) requires solving a horizontally elliptic, vertically coupled Helmholtz system of the abstract form\n$$\n\\left(I - \\mu\\,\\nabla^2 \\otimes B\\right) u = f,\n$$\nwhere $I$ is the $N\\times N$ identity, $\\mu>0$ is a constant parameter emerging from the semi-implicit treatment of fast gravity waves, $\\nabla^2$ is the horizontal Laplace operator on a periodic domain, $\\otimes$ denotes the Kronecker product with respect to the vertical and horizontal spaces, $B\\in\\mathbb{R}^{N\\times N}$ is a symmetric positive semidefinite vertical coupling matrix encoding hydrostatic barotropic/baroclinic coupling, and $f(x,y)\\in\\mathbb{R}^N$ is a given right-hand side. On the periodic square domain of side length $2\\pi$, the horizontal Fourier modes are $e^{i(k_x x + k_y y)}$ with integer wavenumbers $k_x,k_y\\in\\mathbb{Z}$, and satisfy $\\nabla^2 e^{i(k_x x + k_y y)} = -\\left(k_x^2+k_y^2\\right)e^{i(k_x x + k_y y)}$.\n\nYour tasks are:\n- Derive, from first principles starting with the multilayer shallow-water equations and the spectral representation of the horizontal Laplace operator on a periodic domain, why transforming the vertical coordinate into barotropic/baroclinic modes diagonalizes the vertical coupling and yields a block-diagonal structure across horizontal wavenumbers and vertical modes.\n- Implement a solver that, for each discrete horizontal Fourier mode, inverts the coupled Helmholtz system in two different but mathematically equivalent ways:\n  $1.$ Direct vertical-coupled inversion: for each horizontal wavenumber, invert the $N\\times N$ matrix $A(k_x,k_y) = I + \\mu\\,(k_x^2+k_y^2)\\,B$ and apply it to the Fourier coefficients of $f$.\n  $2.$ Modal-diagonal inversion: compute the orthonormal eigen-decomposition $B = Q \\Lambda Q^\\top$ with $\\Lambda=\\mathrm{diag}(\\lambda_1,\\dots,\\lambda_N)$, transform the Fourier coefficients of $f$ to modal space via $Q^\\top$, and for each mode $i$ invert the scalar Helmholtz factor $1+\\mu\\,(k_x^2+k_y^2)\\,\\lambda_i$, then transform back via $Q$.\n- Demonstrate numerically, on a discrete grid using the discrete Fourier transform, that both inversions produce the same solution up to floating-point roundoff by reporting the maximum absolute difference in physical space between the two solutions.\n\nDiscretization and implementation details:\n- Use a uniform grid with $N_x$ points in $x$ and $N_y$ points in $y$ on the periodic domain of side length $2\\pi$. Use the complex-to-complex discrete Fourier transform to represent fields spectrally in the horizontal directions.\n- Compute Fourier wavenumbers in radians per unit length via $k_x = 2\\pi\\,\\mathrm{fftfreq}(N_x, d=(2\\pi)/N_x)$ and $k_y = 2\\pi\\,\\mathrm{fftfreq}(N_y, d=(2\\pi)/N_y)$ so that $k_x,k_y\\in\\mathbb{Z}$, and form $k^2 = k_x^2 + k_y^2$.\n- For reproducibility, construct the right-hand side $f$ as a real-valued array with independent, identically distributed standard normal entries using a fixed pseudorandom seed per test case. Arrange $f$ as an array of shape $(N, N_y, N_x)$, one horizontal field per layer. Apply the discrete Fourier transform independently to each layer.\n\nTest suite:\nProvide the maximum absolute difference between the two inversion methods in physical space for each of the following parameter sets. For each test, set the pseudorandom number generator seed to the stated value before constructing $f$.\n- Test $1$ (happy path with a barotropic null mode): $N=2$, $N_x=8$, $N_y=8$, $\\mu=0.1$, and\n$$\nB=\\begin{bmatrix}\n1 & -1\\\\\n-1 & 1\n\\end{bmatrix},\n$$\nseed $=123$.\n- Test $2$ (three-layer with a barotropic null mode and stronger coupling): $N=3$, $N_x=16$, $N_y=8$, $\\mu=1.0$, and\n$$\nB=\\begin{bmatrix}\n1 & -1 & 0\\\\\n-1 & 2 & -1\\\\\n0 & -1 & 1\n\\end{bmatrix},\n$$\nseed $=1$.\n- Test $3$ (three-layer strictly positive definite coupling and one-dimensional strip grid): $N=3$, $N_x=1$, $N_y=16$, $\\mu=0.01$, and\n$$\nB=\\begin{bmatrix}\n2 & -1 & 0\\\\\n-1 & 2 & -1\\\\\n0 & -1 & 2\n\\end{bmatrix},\n$$\nseed $=7$.\n\nRequired program output:\n- Your program must compute, for each test, the maximum absolute difference between the physical-space solutions obtained by the two inversion methods described above, i.e.,\n$$\n\\max_{i\\in\\{1,\\dots,N\\},\\,y,\\,x}\\left|u^{\\mathrm{direct}}_i(x,y) - u^{\\mathrm{modal}}_i(x,y)\\right|,\n$$\nand aggregate these three values into a single Python list literal printed on one line.\n- Final output format: a single line containing the three results as a comma-separated list enclosed in square brackets, with no extra whitespace or text, e.g., \"[r1,r2,r3]\".\n- No physical units are required because all quantities are nondimensional in this setup. Angles are measured in radians implicitly by the spectral representation, and no percentages are used.\n\nYour program must be a single, self-contained script that constructs the test fields, performs the spectral inversions, and prints the required list in the exact format specified.",
            "solution": "The problem presented is a valid task in computational science, specifically within the field of environmental and earth system modeling. It asks for a derivation and numerical implementation of a spectral solver for a system of Helmholtz equations, which is a standard component in semi-implicit numerical weather prediction and ocean models. The problem is scientifically grounded, well-posed, and all parameters and procedures are explicitly defined.\n\nThe core of the problem is to solve the linear, elliptic partial differential equation system for the layer-thickness perturbation vector field $u(x,y) \\in \\mathbb{R}^N$:\n$$\n\\left(I - \\mu\\,\\nabla^2 \\otimes B\\right) u = f\n$$\nwhere $I$ is the $N \\times N$ identity matrix, $\\mu > 0$ is a constant, $\\nabla^2$ is the horizontal Laplacian on a periodic square domain of side length $2\\pi$, $B \\in \\mathbb{R}^{N\\times N}$ is a symmetric positive semidefinite vertical coupling matrix, and $f(x,y) \\in \\mathbb{R}^N$ is a given forcing field. The notation $\\nabla^2 \\otimes B$ signifies that the scalar operator $\\nabla^2$ acts on the horizontal components of the fields, while the matrix $B$ acts on the vertical (layer) components.\n\nWe will first derive, from first principles, how a two-step transformation—first into horizontal Fourier space and then into a vertical modal space—completely diagonalizes the problem. Subsequently, we will describe the implementation of two numerically distinct but mathematically equivalent solution methods.\n\n**Derivation of Decoupling**\n\nThe solution strategy hinges on the properties of the linear operators involved. The horizontal operator, $\\nabla^2$, and the vertical operator, represented by multiplication by the matrix $B$, can be diagonalized in their respective basis representations.\n\n**1. Decoupling in Horizontal Wavenumber Space via Fourier Transform**\n\nThe problem is set on a periodic domain $[0, 2\\pi) \\times [0, 2\\pi)$. The natural basis functions for linear, constant-coefficient differential operators on such a domain are the complex exponentials, which are the eigenfunctions of the Laplacian operator. Any sufficiently smooth vector field $u(x,y)$ can be represented by a Fourier series:\n$$\nu(x,y) = \\sum_{k_x \\in \\mathbb{Z}} \\sum_{k_y \\in \\mathbb{Z}} \\hat{u}(k_x, k_y) e^{i(k_x x + k_y y)}\n$$\nwhere $\\hat{u}(k_x, k_y) \\in \\mathbb{C}^N$ is the vector of Fourier coefficients for the horizontal wavenumber pair $(k_x, k_y)$. The Laplacian acting on this representation is:\n$$\n\\nabla^2 u(x,y) = \\sum_{k_x, k_y} \\hat{u}(k_x, k_y) \\nabla^2 e^{i(k_x x + k_y y)} = \\sum_{k_x, k_y} -(k_x^2 + k_y^2) \\hat{u}(k_x, k_y) e^{i(k_x x + k_y y)}\n$$\nWe represent the right-hand side $f(x,y)$ in the same basis:\n$$\nf(x,y) = \\sum_{k_x, k_y} \\hat{f}(k_x, k_y) e^{i(k_x x + k_y y)}\n$$\nSubstituting these series representations into the governing equation gives:\n$$\n\\sum_{k_x, k_y} \\left( I \\hat{u}(k_x, k_y) - \\mu (-(k_x^2 + k_y^2)) B \\hat{u}(k_x, k_y) \\right) e^{i(k_x x + k_y y)} = \\sum_{k_x, k_y} \\hat{f}(k_x, k_y) e^{i(k_x x + k_y y)}\n$$\nDue to the orthogonality of the Fourier basis functions $\\{e^{i(k_x x + k_y y)}\\}$, the equality must hold for the coefficients of each mode independently. This transforms the single partial differential equation system into a vast set of independent linear algebraic systems, one for each wavenumber pair $(k_x, k_y)$.\nLet $k^2 = k_x^2 + k_y^2$. For each $(k_x, k_y)$, we have:\n$$\n\\left( I + \\mu k^2 B \\right) \\hat{u}(k_x, k_y) = \\hat{f}(k_x, k_y)\n$$\nThis is an $N \\times N$ system of linear equations for the vector of Fourier coefficients $\\hat{u}(k_x, k_y)$. The original PDE system has thus been block-diagonalized across horizontal wavenumbers.\n\n**2. Decoupling in Vertical Modal Space via Eigendecomposition**\n\nNow we focus on solving the $N \\times N$ matrix system for a single, fixed wavenumber pair $(k_x, k_y)$. The matrix governing this system is $A(k) = I + \\mu k^2 B$. The matrix $B$ is specified as real and symmetric. By the spectral theorem, it is orthogonally diagonalizable. There exists an orthogonal matrix $Q$ whose columns are the eigenvectors of $B$, and a diagonal matrix $\\Lambda$ whose diagonal entries are the corresponding real eigenvalues $\\lambda_1, \\lambda_2, \\dots, \\lambda_N$, such that:\n$$\nB = Q \\Lambda Q^\\top\n$$\nThe columns of $Q$ represent the vertical \"modes\" of the system (e.g., the barotropic mode and the baroclinic modes). Substituting this decomposition into our matrix system:\n$$\n(I + \\mu k^2 Q \\Lambda Q^\\top) \\hat{u}(k_x, k_y) = \\hat{f}(k_x, k_y)\n$$\nUsing the property that $I = Q Q^\\top$ since $Q$ is orthogonal:\n$$\n(Q Q^\\top + Q (\\mu k^2 \\Lambda) Q^\\top) \\hat{u}(k_x, k_y) = \\hat{f}(k_x, k_y)\n$$\nFactoring out $Q$ and $Q^\\top$:\n$$\nQ (I + \\mu k^2 \\Lambda) Q^\\top \\hat{u}(k_x, k_y) = \\hat{f}(k_x, k_y)\n$$\nLeft-multiply by $Q^\\top$:\n$$\n(I + \\mu k^2 \\Lambda) Q^\\top \\hat{u}(k_x, k_y) = Q^\\top \\hat{f}(k_x, k_y)\n$$\nWe define the solution and forcing vectors in the basis of vertical modes:\n- $\\hat{u}^*(k_x, k_y) = Q^\\top \\hat{u}(k_x, k_y)$ (transform to modal space)\n- $\\hat{f}^*(k_x, k_y) = Q^\\top \\hat{f}(k_x, k_y)$ (transform to modal space)\n\nThe system becomes:\n$$\n(I + \\mu k^2 \\Lambda) \\hat{u}^*(k_x, k_y) = \\hat{f}^*(k_x, k_y)\n$$\nThe matrix $(I + \\mu k^2 \\Lambda)$ is diagonal, with diagonal entries $(1 + \\mu k^2 \\lambda_i)$. This means the system of $N$ coupled equations for the modal coefficients $\\hat{u}^*$ has decoupled into $N$ independent scalar equations:\n$$\n(1 + \\mu k^2 \\lambda_i) \\hat{u}^*_i(k_x, k_y) = \\hat{f}^*_i(k_x, k_y), \\quad \\text{for } i = 1, \\dots, N\n$$\nThe solution for each scalar component is trivial: $\\hat{u}^*_i = \\hat{f}^*_i / (1 + \\mu k^2 \\lambda_i)$. Once all $\\hat{u}^*_i$ are found, the solution in the original vertical coordinates is recovered by transforming back: $\\hat{u}(k_x, k_y) = Q \\hat{u}^*(k_x, k_y)$. This completes the derivation, showing that the combination of horizontal Fourier transform and vertical modal transform fully diagonalizes the Helmholtz operator.\n\n**Numerical Implementation**\n\nThe derivation above directly motivates two distinct but equivalent numerical solution methods. The continuous Fourier transform is approximated by the Discrete Fourier Transform (DFT), efficiently computed via the Fast Fourier Transform (FFT).\n\n**Method 1: Direct Vertical-Coupled Inversion**\nThis method follows the first stage of the derivation.\n1.  For each vertical layer $j \\in \\{1, \\dots, N\\}$, compute the 2D DFT of the forcing field $f_j(x,y)$ to obtain the spectral coefficients $\\hat{f}_j(k_x, k_y)$.\n2.  For each discrete wavenumber pair $(k_x, k_y)$:\n    a. Construct the $N \\times N$ matrix $A(k) = I + \\mu (k_x^2+k_y^2) B$.\n    b. Solve the $N \\times N$ linear system $A(k) \\hat{u}(k_x, k_y) = \\hat{f}(k_x, k_y)$ for $\\hat{u}(k_x, k_y)$ using a standard linear algebra library function (e.g., matrix inversion).\n3.  For each vertical layer $j$, perform a 2D inverse DFT on the computed solution coefficients $\\hat{u}_j(k_x, k_y)$ to obtain the physical-space solution $u_j(x,y)$.\n\n**Method 2: Modal-Diagonal Inversion**\nThis method follows the full diagonalization.\n1.  Compute the orthonormal eigendecomposition of the vertical coupling matrix, $B = Q \\Lambda Q^\\top$.\n2.  Compute the 2D DFT of the forcing $f(x,y)$ to get $\\hat{f}(k_x, k_y)$.\n3.  For each wavenumber pair $(k_x, k_y)$, transform the forcing coefficients into the vertical modal basis: $\\hat{f}^*(k_x, k_y) = Q^\\top \\hat{f}(k_x, k_y)$.\n4.  For each vertical mode $i \\in \\{1, \\dots, N\\}$ and each wavenumber pair $(k_x, k_y)$, solve the decoupled scalar equation:\n    $$\n    \\hat{u}^*_i(k_x, k_y) = \\frac{\\hat{f}^*_i(k_x, k_y)}{1 + \\mu (k_x^2+k_y^2) \\lambda_i}\n    $$\n5.  For each wavenumber pair $(k_x, k_y)$, transform the solution coefficients from the modal basis back to the physical vertical basis: $\\hat{u}(k_x, k_y) = Q \\hat{u}^*(k_x, k_y)$.\n6.  Perform a 2D inverse DFT on the coefficients $\\hat{u}(k_x, k_y)$ to obtain the physical-space solution $u(x,y)$.\n\nBoth methods are algorithmically different but mathematically equivalent. They solve the same set of linear equations. Therefore, if implemented correctly, they should yield the same solution, differing only by floating-point roundoff errors. The numerical experiment is designed to confirm this equivalence.",
            "answer": "```python\nimport numpy as np\n\ndef solve_helmholtz(N, Nx, Ny, mu, B, seed):\n    \"\"\"\n    Solves the multilayer Helmholtz system using two methods and returns the max difference.\n    \"\"\"\n    # Set the pseudorandom seed for reproducibility\n    np.random.seed(seed)\n    \n    # 1. Construct the right-hand side f in physical space\n    # f is real-valued with i.i.d. standard normal entries\n    f_phys = np.random.standard_normal(size=(N, Ny, Nx))\n    \n    # 2. Compute wavenumbers\n    # The problem specifies kx, ky should be integers. \n    # fftfreq(N, d=L/N) yields frequencies in cycles per unit length.\n    # Wavenumber (in rad/unit length) = 2*pi * frequency.\n    #\n    # freq_x = fftfreq(Nx, d=(2*np.pi)/Nx)\n    # kx = 2*np.pi * freq_x = 2*np.pi * [0, 1, ..., N/2-1, -N/2, ..., -1] / (2*pi)\n    # So kx = [0, 1, ..., N/2-1, -N/2, ..., -1], which are integers.\n    kx_1d = 2 * np.pi * np.fft.fftfreq(Nx, d=(2 * np.pi / Nx))\n    ky_1d = 2 * np.pi * np.fft.fftfreq(Ny, d=(2 * np.pi / Ny))\n    \n    kx_2d, ky_2d = np.meshgrid(kx_1d, ky_1d)\n    k_squared = kx_2d**2 + ky_2d**2  # Shape: (Ny, Nx)\n    \n    # 3. Transform f to spectral space\n    f_hat = np.fft.fft2(f_phys, axes=(1, 2))  # Shape: (N, Ny, Nx)\n\n    # --- Method 1: Direct Vertical-Coupled Inversion ---\n    \n    u_hat_direct = np.zeros_like(f_hat)\n    I = np.identity(N)\n    \n    # Loop over each point in horizontal spectral space\n    for iy in range(Ny):\n        for ix in range(Nx):\n            k2 = k_squared[iy, ix]\n            # Form the N x N matrix for this wavenumber\n            A = I + mu * k2 * B\n            # Invert the matrix and solve for u_hat\n            A_inv = np.linalg.inv(A)\n            u_hat_direct[:, iy, ix] = A_inv @ f_hat[:, iy, ix]\n            \n    # Transform solution back to physical space\n    u_phys_direct = np.real(np.fft.ifft2(u_hat_direct, axes=(1, 2)))\n\n    # --- Method 2: Modal-Diagonal Inversion ---\n    \n    # 2a. Eigendecomposition of B\n    lambdas, Q = np.linalg.eigh(B) # eigh for symmetric matrices\n    \n    # 2b. Transform f_hat to modal space\n    # f_hat_star = Q.T @ f_hat\n    # Use einsum for clean broadcasting over (Ny, Nx) dimensions\n    f_hat_star = np.einsum('ij,jyx->iyx', Q.T, f_hat)\n    \n    # 2c. Solve scalar Helmholtz equations in modal space\n    # Denominator shape will broadcast from (N, 1, 1) and (Ny, Nx) to (N, Ny, Nx)\n    denominator = 1.0 + mu * lambdas[:, np.newaxis, np.newaxis] * k_squared\n    \n    # Handle potential division by zero, though problem setup prevents this\n    # Since mu > 0, B is PSD (lambdas >= 0), k_squared >= 0, denominator >= 1.\n    u_hat_star = f_hat_star / denominator\n    \n    # 2d. Transform solution back to physical vertical space\n    # u_hat_modal = Q @ u_hat_star\n    u_hat_modal = np.einsum('ij,jyx->iyx', Q, u_hat_star)\n\n    # Transform solution back to physical grid space\n    u_phys_modal = np.real(np.fft.ifft2(u_hat_modal, axes=(1, 2)))\n\n    # --- 4. Compare solutions ---\n    \n    # Compute the maximum absolute difference between the two solutions\n    max_diff = np.max(np.abs(u_phys_direct - u_phys_modal))\n    \n    return max_diff\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"N\": 2, \"Nx\": 8, \"Ny\": 8, \"mu\": 0.1, \n            \"B\": np.array([[1.0, -1.0], [-1.0, 1.0]]),\n            \"seed\": 123\n        },\n        {\n            \"N\": 3, \"Nx\": 16, \"Ny\": 8, \"mu\": 1.0,\n            \"B\": np.array([[1.0, -1.0, 0.0], [-1.0, 2.0, -1.0], [0.0, -1.0, 1.0]]),\n            \"seed\": 1\n        },\n        {\n            \"N\": 3, \"Nx\": 1, \"Ny\": 16, \"mu\": 0.01,\n            \"B\": np.array([[2.0, -1.0, 0.0], [-1.0, 2.0, -1.0], [0.0, -1.0, 2.0]]),\n            \"seed\": 7\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        max_diff = solve_helmholtz(\n            N=case[\"N\"],\n            Nx=case[\"Nx\"],\n            Ny=case[\"Ny\"],\n            mu=case[\"mu\"],\n            B=case[\"B\"],\n            seed=case[\"seed\"]\n        )\n        results.append(max_diff)\n\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}