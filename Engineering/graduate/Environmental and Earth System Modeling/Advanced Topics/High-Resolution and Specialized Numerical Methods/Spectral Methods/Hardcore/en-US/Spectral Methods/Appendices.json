{
    "hands_on_practices": [
        {
            "introduction": "The fundamental power of spectral methods lies in their ability to transform complex calculus operations into simple algebra. This exercise guides you through a first-principles derivation of the spectral differentiation rule for periodic functions. By working through this problem, you will see precisely how differentiation in physical space becomes a straightforward multiplication in Fourier space, a property that is key to the high accuracy and efficiency of spectral solvers .",
            "id": "3914646",
            "problem": "Consider a one-dimensional, zonally periodic tracer field $u(x)$ on the interval $x \\in [0,2\\pi)$ used in idealized environmental and Earth system modeling, with periodic boundary conditions and a Fourier series representation. Let the complex-exponential Fourier series be defined by\n$$\nu(x) = \\sum_{k\\in\\mathbb{Z}} \\hat{u}_k \\exp(i k x),\n$$\nwhere the Fourier coefficients $\\hat{u}_k$ are given by the definition\n$$\n\\hat{u}_k = \\frac{1}{2\\pi}\\int_{0}^{2\\pi} u(x)\\exp(-i k x)\\,\\mathrm{d}x.\n$$\nStarting from these definitions and the property that differentiation is a linear operator, derive the general relation between the Fourier coefficients of $u(x)$ and the Fourier coefficients of its first spatial derivative $u_x(x) = \\frac{\\mathrm{d}u}{\\mathrm{d}x}(x)$ on this periodic domain. Then apply your derived relation to the specific tracer field\n$$\nu(x) = \\sin(3x) + 0.5\\,\\cos(5x),\n$$\nto compute the spectral derivative and reconstruct $u_x(x)$ in physical space. In your derivation, explicitly identify the nonzero Fourier coefficients of $u(x)$ and show how they transform under differentiation, and then simplify the result to an analytic expression for $u_x(x)$ in terms of elementary trigonometric functions of $x$. Express the final answer as a single closed-form function of $x$. No rounding is required, and no units are to be reported.",
            "solution": "The problem as stated is valid. It is a well-posed, self-contained, and scientifically grounded exercise in the application of spectral methods, which are fundamental to environmental and Earth system modeling. We shall proceed with the derivation and solution.\n\nThe core of the problem lies in the property of the Fourier series that relates differentiation in physical space to a simple algebraic operation in spectral (Fourier) space. We will first derive this general property and then apply it to the specific function provided.\n\n**Part 1: General Relation for the Spectral Derivative**\n\nWe begin with the definition of a function $u(x)$ on a periodic domain $x \\in [0, 2\\pi)$ via its complex-exponential Fourier series:\n$$u(x) = \\sum_{k\\in\\mathbb{Z}} \\hat{u}_k \\exp(i k x)$$\nHere, $k$ is the integer wavenumber and $\\hat{u}_k$ are the complex Fourier coefficients. The first spatial derivative of $u(x)$ is $u_x(x) = \\frac{\\mathrm{d}u}{\\mathrm{d}x}$. Since differentiation is a linear operator, we can differentiate the series term-by-term. This operation is justified for functions that are sufficiently smooth, such as the one given in the problem.\n$$u_x(x) = \\frac{\\mathrm{d}}{\\mathrm{d}x} \\left( \\sum_{k\\in\\mathbb{Z}} \\hat{u}_k \\exp(i k x) \\right) = \\sum_{k\\in\\mathbb{Z}} \\hat{u}_k \\frac{\\mathrm{d}}{\\mathrm{d}x} (\\exp(i k x))$$\nThe derivative of the complex exponential function with respect to $x$ is:\n$$\\frac{\\mathrm{d}}{\\mathrm{d}x} (\\exp(i k x)) = i k \\exp(i k x)$$\nSubstituting this result back into the series for $u_x(x)$, we find:\n$$u_x(x) = \\sum_{k\\in\\mathbb{Z}} (i k \\hat{u}_k) \\exp(i k x)$$\nBy definition, the function $u_x(x)$ also has a Fourier series representation with coefficients denoted by $\\widehat{(u_x)}_k$:\n$$u_x(x) = \\sum_{k\\in\\mathbb{Z}} \\widehat{(u_x)}_k \\exp(i k x)$$\nBy equating the two series representations for $u_x(x)$ and comparing the terms for each wavenumber $k$, we obtain the general relation between the Fourier coefficients of a function and its derivative:\n$$\\widehat{(u_x)}_k = i k \\hat{u}_k$$\nThis fundamental result shows that differentiation in physical space is equivalent to multiplication by $i k$ in spectral space.\n\n**Part 2: Application to a Specific Tracer Field**\n\nWe are given the specific tracer field:\n$$u(x) = \\sin(3x) + 0.5\\cos(5x)$$\nTo apply the spectral differentiation rule, we must first find the non-zero Fourier coefficients, $\\hat{u}_k$, of this function. We use Euler's formulas to express $\\sin(3x)$ and $\\cos(5x)$ in terms of complex exponentials:\n$$\\sin(3x) = \\frac{\\exp(i3x) - \\exp(-i3x)}{2i}$$\n$$\\cos(5x) = \\frac{\\exp(i5x) + \\exp(-i5x)}{2}$$\nSubstituting these into the expression for $u(x)$, and noting that $0.5 = \\frac{1}{2}$:\n$$u(x) = \\frac{\\exp(i3x) - \\exp(-i3x)}{2i} + \\frac{1}{2} \\left( \\frac{\\exp(i5x) + \\exp(-i5x)}{2} \\right)$$\n$$u(x) = \\frac{1}{2i}\\exp(i3x) - \\frac{1}{2i}\\exp(-i3x) + \\frac{1}{4}\\exp(i5x) + \\frac{1}{4}\\exp(-i5x)$$\nSince $\\frac{1}{i} = -i$, we have:\n$$u(x) = \\left(-\\frac{i}{2}\\right)\\exp(i3x) + \\left(\\frac{i}{2}\\right)\\exp(-i3x) + \\frac{1}{4}\\exp(i5x) + \\frac{1}{4}\\exp(-i5x)$$\nBy comparing this directly to the general form $u(x) = \\sum_{k\\in\\mathbb{Z}} \\hat{u}_k \\exp(i k x)$, we can explicitly identify the non-zero Fourier coefficients of $u(x)$:\n- For $k=3$: $\\hat{u}_3 = -\\frac{i}{2}$\n- For $k=-3$: $\\hat{u}_{-3} = \\frac{i}{2}$\n- For $k=5$: $\\hat{u}_5 = \\frac{1}{4}$\n- For $k=-5$: $\\hat{u}_{-5} = \\frac{1}{4}$\nAll other coefficients $\\hat{u}_k$ are zero for $k \\notin \\{-5, -3, 3, 5\\}$.\n\nNext, we apply the differentiation rule $\\widehat{(u_x)}_k = i k \\hat{u}_k$ to find the Fourier coefficients of the derivative, $u_x(x)$:\n- For $k=3$: $\\widehat{(u_x)}_3 = i(3)\\hat{u}_3 = 3i\\left(-\\frac{i}{2}\\right) = -\\frac{3i^2}{2} = \\frac{3}{2}$\n- For $k=-3$: $\\widehat{(u_x)}_{-3} = i(-3)\\hat{u}_{-3} = -3i\\left(\\frac{i}{2}\\right) = -\\frac{3i^2}{2} = \\frac{3}{2}$\n- For $k=5$: $\\widehat{(u_x)}_5 = i(5)\\hat{u}_5 = 5i\\left(\\frac{1}{4}\\right) = \\frac{5i}{4}$\n- For $k=-5$: $\\widehat{(u_x)}_{-5} = i(-5)\\hat{u}_{-5} = -5i\\left(\\frac{1}{4}\\right) = -\\frac{5i}{4}$\n\n**Part 3: Reconstruction of the Derivative in Physical Space**\n\nWe now reconstruct $u_x(x)$ from its Fourier coefficients $\\widehat{(u_x)}_k$:\n$$u_x(x) = \\sum_{k \\in \\{-5,-3,3,5\\}} \\widehat{(u_x)}_k \\exp(i k x)$$\n$$u_x(x) = \\widehat{(u_x)}_{-5}\\exp(-i5x) + \\widehat{(u_x)}_{-3}\\exp(-i3x) + \\widehat{(u_x)}_{3}\\exp(i3x) + \\widehat{(u_x)}_{5}\\exp(i5x)$$\nSubstituting the coefficient values we just calculated:\n$$u_x(x) = \\left(-\\frac{5i}{4}\\right)\\exp(-i5x) + \\left(\\frac{3}{2}\\right)\\exp(-i3x) + \\left(\\frac{3}{2}\\right)\\exp(i3x) + \\left(\\frac{5i}{4}\\right)\\exp(i5x)$$\nTo simplify this expression and return to real-valued trigonometric functions, we group terms with opposite wavenumbers:\n$$u_x(x) = \\frac{3}{2}\\left(\\exp(i3x) + \\exp(-i3x)\\right) + \\frac{5i}{4}\\left(\\exp(i5x) - \\exp(-i5x)\\right)$$\nRecalling Euler's formulas for cosine and sine, $2\\cos(\\theta) = \\exp(i\\theta) + \\exp(-i\\theta)$ and $2i\\sin(\\theta) = \\exp(i\\theta) - \\exp(-i\\theta)$, we can write:\n$$u_x(x) = \\frac{3}{2}(2\\cos(3x)) + \\frac{5i}{4}(2i\\sin(5x))$$\n$$u_x(x) = 3\\cos(3x) + \\frac{10i^2}{4}\\sin(5x)$$\nUsing the identity $i^2 = -1$ and simplifying the fraction, we arrive at the final closed-form expression for the derivative:\n$$u_x(x) = 3\\cos(3x) - \\frac{5}{2}\\sin(5x)$$\nThis result is identical to that obtained by direct differentiation of the original function $u(x)$, confirming the correctness of the spectral method.",
            "answer": "$$\n\\boxed{3\\cos(3x) - \\frac{5}{2}\\sin(5x)}\n$$"
        },
        {
            "introduction": "Building on the principle of spectral differentiation, this practice moves from theory to a full-fledged simulation of a nonlinear physical system. You will implement a pseudospectral solver for the two-dimensional Euler equations, a cornerstone model in geophysical fluid dynamics. This hands-on coding exercise addresses the practical challenges of computing nonlinear terms, introducing the critical concepts of aliasing error and its mitigation through dealiasing, and assesses the solver's fidelity by monitoring the conservation of physical invariants like energy and enstrophy .",
            "id": "3914652",
            "problem": "Consider the two-dimensional incompressible Euler equations on a square periodic domain for the vorticity field. Let the computational domain be $[0,2\\pi]\\times[0,2\\pi]$ with periodic boundary conditions, and angles expressed in radians. Define the vorticity $\\,\\omega(x,y,t)\\,$, the streamfunction $\\,\\psi(x,y,t)\\,$, and the velocity $\\,\\mathbf{u}(x,y,t)=(u_x,u_y)\\,$. The governing equations are\n$$\\frac{\\partial \\omega}{\\partial t} + J(\\psi,\\omega) = 0,$$\nwith the Jacobian $\\,J(\\psi,\\omega) = \\frac{\\partial \\psi}{\\partial x}\\frac{\\partial \\omega}{\\partial y} - \\frac{\\partial \\psi}{\\partial y}\\frac{\\partial \\omega}{\\partial x}\\,$ and the Poisson relation $\\,\\nabla^2 \\psi = \\omega\\,$. The velocity is recovered from the streamfunction by $\\,u_x = -\\frac{\\partial \\psi}{\\partial y}\\,$ and $\\,u_y = \\frac{\\partial \\psi}{\\partial x}\\,$.\n\nThe goal is to compute the time evolution of the vorticity using a pseudospectral method with Fast Fourier Transform (FFT) and two-thirds dealiasing, and then quantify the conservation properties of kinetic energy and enstrophy for the inviscid dynamics. The kinetic energy density $\\,E\\,$ and the enstrophy density $\\,Z\\,$ are defined by\n$$E(t) = \\frac{1}{2}\\langle |\\mathbf{u}(x,y,t)|^2 \\rangle, \\quad Z(t) = \\frac{1}{2}\\langle \\omega(x,y,t)^2 \\rangle,$$\nwhere $\\,\\langle \\cdot \\rangle\\,$ denotes the spatial average over the domain. For the inviscid two-dimensional Euler equations, both $\\,E(t)\\,$ and $\\,Z(t)\\,$ are invariants of motion in the continuous setting. In this problem, you will assess how well these invariants are preserved by a pseudospectral discretization with dealiasing and explicit time stepping.\n\nNumerical method specification:\n- Spatial discretization is Fourier pseudospectral on an $\\,N\\times N\\,$ grid with $\\,N\\,$ even, on the domain $\\,L_x=L_y=2\\pi\\,$.\n- Wavenumbers are defined consistently with the discrete Fourier transform; denote $\\,k_x\\,$ and $\\,k_y\\,$ as integer-valued angular wavenumbers due to $\\,L_x=L_y=2\\pi\\,$.\n- Spectral differentiation uses multiplication by $\\,\\mathrm{i}k_x\\,$ or $\\,\\mathrm{i}k_y\\,$ in Fourier space.\n- The nonlinear advection term $\\,J(\\psi,\\omega)\\,$ is computed pseudospectrally by transforming the needed fields to physical space, multiplying, and transforming back.\n- Two-thirds dealiasing is enforced by zeroing all Fourier modes with $\\,|k_x| > K_c\\,$ or $\\,|k_y| > K_c\\,$, where $\\,K_c = \\left\\lfloor \\frac{N}{3} \\right\\rfloor\\,$, both before forming physical-space products and after transforming the products back to spectral space. The same truncation is applied to the updated vorticity spectrum at the end of each time step.\n- Time stepping uses the classical fourth-order Runge–Kutta method for the inviscid dynamics $\\,\\frac{\\partial \\omega}{\\partial t} = -J(\\psi,\\omega)\\,$.\n\nEnergy and enstrophy diagnostics:\n- At the initial time $\\,t=0\\,$, compute $\\,E(0)\\,$ and $\\,Z(0)\\,$ from the initial vorticity using the streamfunction relation and velocity recovery defined above.\n- After integrating to the final time $\\,t=T\\,$, compute $\\,E(T)\\,$ and $\\,Z(T)\\,$.\n- For each test case, report two values:\n    1. If $\\,E(0) > 0\\,$, return the relative change $\\,\\Delta E = \\frac{E(T)-E(0)}{E(0)}\\,$; if $\\,E(0)=0\\,$, return $\\,E(T)\\,$ as a dimensionless scalar.\n    2. If $\\,Z(0) > 0\\,$, return the relative change $\\,\\Delta Z = \\frac{Z(T)-Z(0)}{Z(0)}\\,$; if $\\,Z(0)=0\\,$, return $\\,Z(T)\\,$ as a dimensionless scalar.\nAll reported values are dimensionless scalars.\n\nTest suite:\nFor each case, specify $\\,N\\,$, time step $\\,\\Delta t\\,$, number of time steps $\\,n_\\text{steps}\\,$, and the initial vorticity $\\,\\omega(x,y,0)\\,$ as an analytic function, with angles in radians.\n\n- Case $\\,\\text{A1}\\,$ (baseline resolution, conservative time step):\n    - $\\,N=64\\,$, $\\,\\Delta t = 0.0025\\,$, $\\,n_\\text{steps} = 400\\,$ so $\\,T = 1.0\\,$.\n    - $\\,\\omega(x,y,0) = \\sin(x)\\cos(y) + 0.5\\cos(2x)\\cos(y) - 0.25\\sin(y)\\,$.\n- Case $\\,\\text{A2}\\,$ (same initial condition, larger time step):\n    - $\\,N=64\\,$, $\\,\\Delta t = 0.01\\,$, $\\,n_\\text{steps} = 200\\,$ so $\\,T = 2.0\\,$.\n    - $\\,\\omega(x,y,0) = \\sin(x)\\cos(y) + 0.5\\cos(2x)\\cos(y) - 0.25\\sin(y)\\,$.\n- Case $\\,\\text{Z0}\\,$ (zero vorticity edge case):\n    - $\\,N=32\\,$, $\\,\\Delta t = 0.01\\,$, $\\,n_\\text{steps} = 100\\,$ so $\\,T = 1.0\\,$.\n    - $\\,\\omega(x,y,0) = 0\\,$.\n- Case $\\,\\text{B}\\,$ (higher resolution, mixed-mode initial condition):\n    - $\\,N=96\\,$, $\\,\\Delta t = 0.002\\,$, $\\,n_\\text{steps} = 300\\,$ so $\\,T = 0.6\\,$.\n    - $\\,\\omega(x,y,0) = \\sin(x) + \\sin(y) + 0.1\\sin(x+y) + 0.1\\sin(2x-y)\\,$.\n\nOutput format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a two-element list $\\,[$energy\\_metric$, $enstrophy\\_metric$]\\,$. For example, the output must be of the form\n$$[ [a_1,b_1], [a_2,b_2], [a_3,b_3], [a_4,b_4] ]$$\nwith all values as decimals. The final values are dimensionless by construction; therefore, no physical unit is required in the output.\n\nYour program must be a complete, runnable program that implements the pseudospectral solver with dealiasing and produces the specified output for the four test cases.",
            "solution": "The user has provided a valid problem statement. The task is to simulate the two-dimensional incompressible Euler equations for vorticity on a doubly periodic domain using a pseudospectral method. The simulation results will be used to quantify the numerical conservation of kinetic energy and enstrophy, two invariants of the continuous system. The numerical scheme involves a fourth-order Runge-Kutta (RK4) method for time integration and a two-thirds dealiasing rule to control aliasing errors arising from the nonlinear advection term.\n\nThe solution is structured as follows:\n1.  **Governing Equations and Spectral Representation**: A review of the Euler equations in vorticity-streamfunction form and their representation in Fourier space.\n2.  **Pseudospectral Method for the Nonlinear Term**: A description of how the Jacobian term $J(\\psi, \\omega)$ is computed using a mix of spectral and physical space operations.\n3.  **Dealiasing**: An explanation of the two-thirds rule and its specific application as described in the problem statement.\n4.  **Time Integration**: The implementation of the RK4 scheme for advancing the vorticity spectrum in time.\n5.  **Diagnostic Calculations**: The formulas for computing kinetic energy and enstrophy from the vorticity spectrum using Parseval's theorem.\n6.  **Algorithm Implementation**: A summary of the computational workflow for solving each test case.\n\n**1. Governing Equations and Spectral Representation**\n\nThe governing equations are the vorticity evolution equation and the Poisson equation relating vorticity $\\omega$ to the streamfunction $\\psi$:\n$$\n\\frac{\\partial \\omega}{\\partial t} + J(\\psi,\\omega) = 0 \\quad \\text{where} \\quad J(\\psi,\\omega) = \\frac{\\partial \\psi}{\\partial x}\\frac{\\partial \\omega}{\\partial y} - \\frac{\\partial \\psi}{\\partial y}\\frac{\\partial \\omega}{\\partial x}\n$$\n$$\n\\nabla^2 \\psi = \\omega\n$$\nThe domain is a square $[0, 2\\pi] \\times [0, 2\\pi]$ with periodic boundary conditions. This periodicity makes a Fourier series representation natural. A scalar field $f(x,y,t)$ on this domain can be represented as:\n$$\nf(x,y,t) = \\sum_{k_x=-\\infty}^{\\infty} \\sum_{k_y=-\\infty}^{\\infty} \\hat{f}(k_x, k_y, t) e^{i(k_x x + k_y y)}\n$$\nwhere $k_x$ and $k_y$ are integer wavenumbers and $\\hat{f}(k_x, k_y, t)$ are the complex Fourier coefficients. In a numerical context, we use the Discrete Fourier Transform (DFT) on an $N \\times N$ grid. The wavenumbers become discrete and finite, ranging from $-N/2$ to $N/2-1$.\n\nSpatial derivatives are computed efficiently in Fourier space. The Fourier transform of a partial derivative is:\n$$\n\\mathcal{F}\\left(\\frac{\\partial f}{\\partial x}\\right) = i k_x \\hat{f}(k_x, k_y) \\quad \\text{and} \\quad \\mathcal{F}\\left(\\frac{\\partial f}{\\partial y}\\right) = i k_y \\hat{f}(k_x, k_y)\n$$\nThe Poisson equation $\\nabla^2 \\psi = \\omega$ becomes algebraic in Fourier space:\n$$\n( (ik_x)^2 + (ik_y)^2 ) \\hat{\\psi} = - (k_x^2 + k_y^2) \\hat{\\psi} = \\hat{\\omega}\n$$\nThis allows us to solve for the streamfunction spectrum $\\hat{\\psi}$ directly from the vorticity spectrum $\\hat{\\omega}$:\n$$\n\\hat{\\psi}(k_x, k_y) = -\\frac{\\hat{\\omega}(k_x, k_y)}{k_x^2 + k_y^2} \\quad \\text{for} \\quad (k_x, k_y) \\neq (0,0)\n$$\nFor the mean mode $(k_x, k_y) = (0,0)$, the denominator is zero. The average of the initial vorticity is zero for all test cases, so $\\hat{\\omega}(0,0)=0$. The average value of the streamfunction $\\hat{\\psi}(0,0)$ is physically irrelevant as it does not affect the velocity field (which depends on derivatives of $\\psi$), so we set $\\hat{\\psi}(0,0) = 0$.\n\n**2. Pseudospectral Method for the Nonlinear Term**\n\nThe nonlinear Jacobian term $J(\\psi, \\omega)$ involves products of fields, which correspond to convolutions in Fourier space. Direct evaluation of these convolutions is computationally expensive ($O(N^4)$). The pseudospectral method provides a more efficient $O(N^2 \\log N)$ approach:\n1.  Start with the spectral fields $\\hat{\\omega}$ and $\\hat{\\psi}$.\n2.  Compute the spectral representations of the required derivatives, e.g., $\\widehat{\\frac{\\partial \\psi}{\\partial x}} = i k_x \\hat{\\psi}$.\n3.  Apply the inverse Fast Fourier Transform (IFFT) to these spectral derivatives to obtain the corresponding fields in physical space, e.g., $\\frac{\\partial \\psi}{\\partial x}(x,y)$.\n4.  Perform the multiplications in physical space to compute $J(x,y) = \\frac{\\partial \\psi}{\\partial x}\\frac{\\partial \\omega}{\\partial y} - \\frac{\\partial \\psi}{\\partial y}\\frac{\\partial \\omega}{\\partial x}$.\n5.  Apply the forward Fast Fourier Transform (FFT) to $J(x,y)$ to obtain its spectrum, $\\hat{J}(k_x, k_y)$.\n\nThe time evolution of the vorticity spectrum is then given by $\\frac{\\partial \\hat{\\omega}}{\\partial t} = - \\hat{J}$.\n\n**3. Dealiasing**\n\nThe multiplication in physical space can create artificial high-frequency modes due to the periodic nature of the DFT, a phenomenon known as aliasing. The two-thirds dealiasing rule is applied to prevent this. The cutoff wavenumber is defined as $K_c = \\lfloor N/3 \\rfloor$.\nThe procedure, as specified in the problem, involves three filtering steps:\n1.  **Before Products**: Before transforming the derivatives (e.g., $\\widehat{\\frac{\\partial \\psi}{\\partial x}}$) to physical space for multiplication, all Fourier coefficients for which $|k_x| > K_c$ or $|k_y| > K_c$ are set to zero. This ensures the fields being multiplied have their spectral content limited.\n2.  **After Products**: After computing the product (the Jacobian) in physical space and transforming it back to Fourier space, the resulting spectrum $\\hat{J}$ is truncated again using the same rule. This removes the high-frequency content generated by the multiplication that could cause aliasing.\n3.  **End of Timestep**: After the full RK4 time step is completed, the updated vorticity spectrum $\\hat{\\omega}(t+\\Delta t)$ is truncated one final time.\n\nThis procedure ensures that all non-linear interactions are free of aliasing errors.\n\n**4. Time Integration**\n\nThe semi-discretized equation for the vorticity spectrum is an ordinary differential equation (ODE):\n$$\n\\frac{d\\hat{\\omega}(t)}{dt} = \\mathcal{R}(\\hat{\\omega}(t))\n$$\nwhere $\\mathcal{R}(\\hat{\\omega}(t)) = -\\hat{J}(\\psi,\\omega)$ is the right-hand side, which includes the pseudospectral calculation with dealiasing. This system of ODEs is integrated using the classical fourth-order Runge-Kutta (RK4) method. For a timestep from $t_n$ to $t_{n+1}=t_n+\\Delta t$:\n$$\n\\begin{aligned}\n    k_1 &= \\mathcal{R}(\\hat{\\omega}_n) \\\\\n    k_2 &= \\mathcal{R}(\\hat{\\omega}_n + \\frac{\\Delta t}{2} k_1) \\\\\n    k_3 &= \\mathcal{R}(\\hat{\\omega}_n + \\frac{\\Delta t}{2} k_2) \\\\\n    k_4 &= \\mathcal{R}(\\hat{\\omega}_n + \\Delta t k_3) \\\\\n    \\hat{\\omega}_{n+1} &= \\hat{\\omega}_n + \\frac{\\Delta t}{6} (k_1 + 2k_2 + 2k_3 + k_4)\n\\end{aligned}\n$$\nAfter computing $\\hat{\\omega}_{n+1}$, the end-of-step dealiasing filter is applied.\n\n**5. Diagnostic Calculations**\n\nThe kinetic energy $E$ and enstrophy $Z$ are computed from the vorticity spectrum $\\hat{\\omega}$ using Parseval's theorem. For the DFT normalization used by NumPy, the spatial average of a squared field $\\langle f^2 \\rangle$ is related to its FFT $\\hat{f}_{FFT}$ by:\n$$\n\\langle f^2 \\rangle = \\frac{1}{N^2} \\sum_{j,l=0}^{N-1} |f(x_j, y_l)|^2 = \\frac{1}{N^4} \\sum_{k_x, k_y} |\\hat{f}_{FFT}(k_x, k_y)|^2\n$$\nThe enstrophy $Z = \\frac{1}{2} \\langle \\omega^2 \\rangle$ is therefore:\n$$\nZ(t) = \\frac{1}{2N^4} \\sum_{k_x, k_y} |\\hat{\\omega}(k_x, k_y, t)|^2\n$$\nThe kinetic energy $E = \\frac{1}{2} \\langle |\\mathbf{u}|^2 \\rangle = \\frac{1}{2} \\langle u_x^2 + u_y^2 \\rangle$ can also be expressed in terms of $\\hat{\\omega}$. First, we find the velocity spectra: $\\hat{u}_x = -ik_y \\hat{\\psi}$ and $\\hat{u}_y = ik_x \\hat{\\psi}$. Substituting $\\hat{\\psi}$, we have:\n$$\nE(t) = \\frac{1}{2N^4} \\sum_{(k_x,k_y) \\neq (0,0)} (k_x^2 + k_y^2) |\\hat{\\psi}|^2 = \\frac{1}{2N^4} \\sum_{(k_x,k_y) \\neq (0,0)} \\frac{|\\hat{\\omega}(k_x, k_y, t)|^2}{k_x^2 + k_y^2}\n$$\nThe $(k_x,k_y)=(0,0)$ mode is excluded as it contains no kinetic energy.\n\n**6. Algorithm Implementation**\n\nFor each test case, the solver proceeds as follows:\n1.  Set up the computational grid ($N \\times N$) and corresponding 2D wavenumber arrays ($k_x, k_y$). Pre-compute the inverse Laplacian operator and the dealiasing mask.\n2.  Evaluate the initial vorticity $\\omega(x,y,0)$ on the grid and compute its spectrum $\\hat{\\omega}(0)$ via FFT. Apply the dealiasing filter to this initial spectrum.\n3.  Calculate the initial energy $E(0)$ and enstrophy $Z(0)$ using the spectral formulas.\n4.  Loop for the specified number of time steps ($n_\\text{steps}$), advancing $\\hat{\\omega}$ at each step using the RK4 method. The function for the RHS of the ODE encapsulates the full pseudospectral and dealiasing procedure for the Jacobian.\n5.  After the final time step, calculate the final energy $E(T)$ and enstrophy $Z(T)$.\n6.  Compute the required output metrics ($\\Delta E$ or $E(T)$, and $\\Delta Z$ or $Z(T)$) and store them.\n7.  After processing all cases, format the results into the specified string format and print to standard output.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        # Case A1: (N, dt, n_steps, omega_func)\n        (64, 0.0025, 400, lambda x, y: np.sin(x)*np.cos(y) + 0.5*np.cos(2*x)*np.cos(y) - 0.25*np.sin(y)),\n        # Case A2\n        (64, 0.01, 200, lambda x, y: np.sin(x)*np.cos(y) + 0.5*np.cos(2*x)*np.cos(y) - 0.25*np.sin(y)),\n        # Case Z0\n        (32, 0.01, 100, lambda x, y: np.zeros_like(x)),\n        # Case B\n        (96, 0.002, 300, lambda x, y: np.sin(x) + np.sin(y) + 0.1*np.sin(x+y) + 0.1*np.sin(2*x-y))\n    ]\n\n    results = []\n    for params in test_cases:\n        result = _run_solver(*params)\n        results.append(result)\n        \n    # Format the output into the specified string format: [[a1,b1],[a2,b2],...]\n    # Using str(r) produces spaces, e.g., '[1.2, 3.4]'\n    # The template 'f\"[{','.join(map(str, results))}]\"' produces '[[1.2, 3.4],[5.6, 7.8]]'\n    # which seems to be the intended format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef _run_solver(N, dt, n_steps, omega_func):\n    \"\"\"\n    Solves the 2D Euler equations for a single test case.\n    \"\"\"\n    # 1. Grid, Wavenumbers, and Pre-computation\n    L = 2.0 * np.pi\n    dx = L / N\n    # Physical grid\n    x = np.arange(N) * dx\n    X, Y = np.meshgrid(x, x, indexing='ij')\n\n    # Wavenumber grid (integer angular wavenumbers for domain size 2*pi)\n    k_1d = np.fft.fftfreq(N) * N\n    kx, ky = np.meshgrid(k_1d, k_1d, indexing='ij')\n    \n    # Inverse Laplacian for Poisson solve: inv_lap = -1/(k_x^2+k_y^2)\n    k_sq = kx**2 + ky**2\n    # Avoid division by zero for the k=0 mode.\n    # The w_hat[0,0] is zero, so psi_hat[0,0] will be 0.\n    inv_lap = np.divide(-1.0, k_sq, out=np.zeros_like(k_sq), where=(k_sq != 0))\n\n    # Dealiasing filter setup (2/3 rule)\n    Kc = N // 3\n    dealias_mask = (np.abs(kx) > Kc) | (np.abs(ky) > Kc)\n\n    def dealias(f_hat):\n        \"\"\"Applies the dealiasing filter to a spectral field.\"\"\"\n        f_hat[dealias_mask] = 0.0\n        return f_hat\n\n    # 2. Diagnostics: Energy and Enstrophy Calculation\n    def calculate_invariants(w_hat):\n        \"\"\"Computes kinetic energy and enstrophy from the vorticity spectrum.\"\"\"\n        # Enstrophy Z = 0.5 * <w^2>. Using Parseval's theorem for numpy's DFT.\n        enstrophy = 0.5 * np.sum(np.abs(w_hat)**2) / (N**4)\n\n        # Energy E = 0.5 * <|u|^2> = sum(|w_hat|^2 / k^2) / (2*N^4)\n        energy_spec = np.divide(np.abs(w_hat)**2, k_sq, out=np.zeros_like(k_sq), where=(k_sq != 0))\n        energy = 0.5 * np.sum(energy_spec) / (N**4)\n        \n        return energy, enstrophy\n\n    # 3. RHS of the Vorticity Equation (Pseudospectral with Dealiasing)\n    def compute_rhs(w_hat):\n        \"\"\"Computes the spectral representation of -J(psi, omega).\"\"\"\n        # Get streamfunction spectrum\n        psi_hat = w_hat * inv_lap\n\n        # Spectral derivatives of psi and omega.\n        dpsidx_hat = 1j * kx * psi_hat\n        dpsidy_hat = 1j * ky * psi_hat\n        domegadx_hat = 1j * kx * w_hat\n        domegady_hat = 1j * ky * w_hat\n\n        # Dealias before transforming to physical space (before product).\n        dpsidx_hat = dealias(dpsidx_hat)\n        dpsidy_hat = dealias(dpsidy_hat)\n        domegadx_hat = dealias(domegadx_hat)\n        domegady_hat = dealias(domegady_hat)\n        \n        # Transform to physical space via IFFT\n        dpsidx_phys = np.fft.ifft2(dpsidx_hat).real\n        dpsidy_phys = np.fft.ifft2(dpsidy_hat).real\n        domegady_phys = np.fft.ifft2(domegady_hat).real\n        \n        # Calculate Jacobian product in physical space\n        # J(psi, omega) = (dpsi/dx)*(domega/dy) - (dpsi/dy)*(domega/dx)\n        # We need d(omega)/dx, so we must also transform domegadx_hat\n        domegadx_phys = np.fft.ifft2(domegadx_hat).real\n        jacobian_phys = dpsidx_phys * domegady_phys - dpsidy_phys * domegadx_phys\n        \n        # Transform Jacobian back to spectral space\n        jacobian_hat = np.fft.fft2(jacobian_phys)\n        \n        # Dealias the product spectrum and return RHS = -J_hat\n        return -dealias(jacobian_hat)\n\n    # 4. Initial Condition and Initial Diagnostics\n    omega_phys_0 = omega_func(X, Y)\n    omega_hat = np.fft.fft2(omega_phys_0)\n    omega_hat = dealias(omega_hat) # Dealias initial state\n\n    E0, Z0 = calculate_invariants(omega_hat)\n\n    # 5. Time Integration (RK4)\n    for _ in range(n_steps):\n        k1 = compute_rhs(omega_hat)\n        k2 = compute_rhs(omega_hat + 0.5 * dt * k1)\n        k3 = compute_rhs(omega_hat + 0.5 * dt * k2)\n        k4 = compute_rhs(omega_hat + dt * k3)\n        \n        omega_hat += (dt / 6.0) * (k1 + 2.0 * k2 + 2.0 * k3 + k4)\n        \n        # Dealias at the end of the step\n        omega_hat = dealias(omega_hat)\n\n    # 6. Final Diagnostics and Metrics\n    ET, ZT = calculate_invariants(omega_hat)\n\n    # Calculate metrics as specified\n    if E0 > 1e-16: # Use a small tolerance for zero check\n        delta_E = (ET - E0) / E0\n    else:\n        delta_E = ET\n\n    if Z0 > 1e-16: # Use a small tolerance for zero check\n        delta_Z = (ZT - Z0) / Z0\n    else:\n        delta_Z = ZT\n        \n    return [delta_E, delta_Z]\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "A robust numerical model requires careful analysis of errors arising from both spatial and temporal discretization. This final practice explores the crucial interaction between a perfect-in-space Fourier spectral method and a discrete time-stepping scheme. By deriving the numerical dispersion relation for linearized gravity waves, you will learn to quantify how accurately your model propagates waves compared to the true physical system . This type of analysis is an essential skill for developing, validating, and interpreting the results of complex environmental models.",
            "id": "3914649",
            "problem": "Consider one-dimensional linearized shallow-water dynamics on a periodic domain of length $L$ with constant mean depth $H$ and gravitational acceleration $g$. The prognostic variables are free-surface displacement $\\eta(x,t)$ and horizontal velocity $u(x,t)$, which satisfy the coupled system\n$$\n\\frac{\\partial \\eta}{\\partial t} + H\\,\\frac{\\partial u}{\\partial x} = 0,\\qquad\n\\frac{\\partial u}{\\partial t} + g\\,\\frac{\\partial \\eta}{\\partial x} = 0,\n$$\nwith $x \\in [0,L]$ and periodic boundary conditions. The spatial derivatives are approximated using a Fourier spectral method on a uniform grid, so that for each resolved Fourier mode with wavenumber $k \\in \\frac{2\\pi}{L}\\mathbb{Z}$, the spatial derivative operator acts exactly as multiplication by $i k$ on the Fourier coefficient of that mode. Time integration is performed by applying the explicit second-order Runge–Kutta method (also known as Heun’s method) with a constant time step $\\Delta t$ to the semi-discrete (in space) system for each Fourier mode.\n\nStarting from the governing equations and the definition of the Fourier spectral representation, derive the continuous dispersion relation $\\omega(k)$ for linear gravity waves under this spatial discretization. Then, derive the discrete-in-time dispersion relation for the second-order Runge–Kutta time integrator applied to the semi-discrete system, and from it determine the leading-order numerical phase speed error for a given mode. Define the exact gravity-wave phase speed as $c = \\sqrt{g H}$ and the nondimensional parameter $\\mu = c\\,|k|\\,\\Delta t$. The numerical phase speed $c_{\\mathrm{num}}$ is defined by $c_{\\mathrm{num}} = \\omega_{\\mathrm{d}}(k,\\Delta t)/|k|$, where $\\omega_{\\mathrm{d}}(k,\\Delta t)$ is the discrete numerical frequency obtained from the time-stepping amplification factor. Express your final answer as a single closed-form symbolic expression for the leading-order relative phase speed error\n$$\n\\frac{c_{\\mathrm{num}} - c}{c}\n$$\nin terms of $\\mu$ only. No rounding is required; provide the exact leading-order expression. Angles, if any, should be treated in radians. Units are not required in the final expression because the requested quantity is nondimensional.",
            "solution": "The problem statement has been validated and is deemed to be scientifically grounded, well-posed, objective, and complete. All necessary information is provided, and the problem constitutes a standard, non-trivial exercise in the numerical analysis of partial differential equations relevant to environmental and earth system modeling. The solution process may proceed.\n\nThe governing linearized shallow-water equations are:\n$$\n\\frac{\\partial \\eta}{\\partial t} + H\\,\\frac{\\partial u}{\\partial x} = 0\n$$\n$$\n\\frac{\\partial u}{\\partial t} + g\\,\\frac{\\partial \\eta}{\\partial x} = 0\n$$\nwhere $\\eta(x,t)$ is the free-surface displacement, $u(x,t)$ is the horizontal velocity, $H$ is the constant mean depth, and $g$ is the gravitational acceleration.\n\nFirst, we derive the continuous dispersion relation. We assume plane-wave solutions of the form:\n$$\n\\eta(x,t) = \\hat{\\eta} \\exp(i(kx - \\omega t))\n$$\n$$\nu(x,t) = \\hat{u} \\exp(i(kx - \\omega t))\n$$\nwhere $k$ is the wavenumber and $\\omega$ is the angular frequency. Substituting these into the governing equations yields a system of algebraic equations for the amplitudes $\\hat{\\eta}$ and $\\hat{u}$:\n$$\n-i\\omega \\hat{\\eta} + i k H \\hat{u} = 0\n$$\n$$\n-i\\omega \\hat{u} + i k g \\hat{\\eta} = 0\n$$\nThis system can be written in matrix form as:\n$$\n\\begin{pmatrix} -i\\omega & ikH \\\\ ikg & -i\\omega \\end{pmatrix} \\begin{pmatrix} \\hat{\\eta} \\\\ \\hat{u} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}\n$$\nFor a non-trivial solution to exist, the determinant of the coefficient matrix must be zero:\n$$\n\\det \\begin{pmatrix} -i\\omega & ikH \\\\ ikg & -i\\omega \\end{pmatrix} = (-i\\omega)^2 - (ikH)(ikg) = -\\omega^2 - i^2 k^2 gH = -\\omega^2 + k^2 gH = 0\n$$\nThis gives the dispersion relation $\\omega^2 = k^2 gH$. Defining the exact gravity-wave phase speed as $c = \\sqrt{gH}$, the dispersion relation becomes $\\omega^2 = c^2 k^2$, which implies $\\omega(k) = \\pm c|k|$. The spatial discretization by the Fourier spectral method is exact for each resolved mode, meaning the semi-discrete system preserves this continuous dispersion relation.\n\nNext, we formulate the semi-discrete system. For a single Fourier mode with wavenumber $k$, the spatial derivative $\\frac{\\partial}{\\partial x}$ is replaced by multiplication by $ik$. Let $\\hat{\\eta}_k(t)$ and $\\hat{u}_k(t)$ be the Fourier coefficients for mode $k$. The system of ordinary differential equations (ODEs) for these coefficients is:\n$$\n\\frac{d\\hat{\\eta}_k}{dt} = -ikH \\hat{u}_k\n$$\n$$\n\\frac{d\\hat{u}_k}{dt} = -ikg \\hat{\\eta}_k\n$$\nLet the state vector be $\\mathbf{y}_k(t) = \\begin{pmatrix} \\hat{\\eta}_k(t) \\\\ \\hat{u}_k(t) \\end{pmatrix}$. The system is $\\frac{d\\mathbf{y}_k}{dt} = \\mathbf{M}_k \\mathbf{y}_k$, where the matrix $\\mathbf{M}_k$ is:\n$$\n\\mathbf{M}_k = \\begin{pmatrix} 0 & -ikH \\\\ -ikg & 0 \\end{pmatrix} = -ik \\begin{pmatrix} 0 & H \\\\ g & 0 \\end{pmatrix}\n$$\nThe eigenvalues of $\\mathbf{M}_k$ are given by $\\lambda_M^2 - (-ikH)(-ikg) = 0$, which simplifies to $\\lambda_M^2 = -k^2 gH = -c^2 k^2$. Thus, the eigenvalues are $\\lambda_M = \\pm i c |k|$. These correspond to the exact frequencies $\\omega = \\mp i \\lambda_M = \\pm c|k|$.\n\nNow, we apply the second-order Runge-Kutta method (Heun's method) with time step $\\Delta t$ to the system $\\frac{d\\mathbf{y}_k}{dt} = \\mathbf{M}_k \\mathbf{y}_k$. The update rule is:\n$$\n\\mathbf{y}_k^{n+1} = \\mathbf{y}_k^n + \\frac{\\Delta t}{2} \\left( \\mathbf{M}_k \\mathbf{y}_k^n + \\mathbf{M}_k(\\mathbf{y}_k^n + \\Delta t \\mathbf{M}_k \\mathbf{y}_k^n) \\right)\n$$\n$$\n\\mathbf{y}_k^{n+1} = \\left( \\mathbf{I} + \\Delta t \\mathbf{M}_k + \\frac{(\\Delta t)^2}{2} \\mathbf{M}_k^2 \\right) \\mathbf{y}_k^n\n$$\nThe amplification matrix is $\\mathbf{G}_k = \\mathbf{I} + \\Delta t \\mathbf{M}_k + \\frac{(\\Delta t)^2}{2} \\mathbf{M}_k^2$. The eigenvalues of $\\mathbf{G}_k$, denoted $\\lambda_G$, are related to the eigenvalues of $\\mathbf{M}_k$ by the same polynomial:\n$$\n\\lambda_G = 1 + \\Delta t \\lambda_M + \\frac{(\\Delta t)^2}{2} \\lambda_M^2\n$$\nLet us analyze one of the propagating modes, corresponding to an eigenvalue $\\lambda_M = -i c |k|$. Substituting this into the expression for $\\lambda_G$:\n$$\n\\lambda_G = 1 + \\Delta t(-ic|k|) + \\frac{(\\Delta t)^2}{2} (-ic|k|)^2 = 1 - i c|k|\\Delta t - \\frac{1}{2}c^2 k^2 (\\Delta t)^2\n$$\nUsing the nondimensional parameter $\\mu = c|k|\\Delta t$, the amplification factor for this mode is:\n$$\n\\lambda_G = 1 - \\frac{1}{2}\\mu^2 - i\\mu\n$$\nThe numerical solution is amplified by $\\lambda_G$ at each time step. We define the numerical frequency $\\omega_{\\mathrm{d}}$ such that $\\lambda_G = \\exp(-i\\omega_{\\mathrm{d}}\\Delta t)$. This implies that the amplitude of the numerical wave is not perfectly conserved, as $|\\lambda_G| \\neq 1$. Let $\\omega_{\\mathrm{d}} = \\omega_{\\mathrm{d,R}} + i \\omega_{\\mathrm{d,I}}$. Then $\\lambda_G = \\exp(\\omega_{\\mathrm{d,I}}\\Delta t) \\exp(-i\\omega_{\\mathrm{d,R}}\\Delta t)$. The numerical phase speed $c_{\\mathrm{num}}$ is determined by the real part of the frequency, $c_{\\mathrm{num}} = \\omega_{\\mathrm{d,R}}/|k|$. The argument of $\\lambda_G$ is related to $\\omega_{\\mathrm{d,R}}$:\n$$\n\\arg(\\lambda_G) = -\\omega_{\\mathrm{d,R}}\\Delta t\n$$\nFrom the expression for $\\lambda_G$:\n$$\n\\arg(\\lambda_G) = \\arctan\\left(\\frac{-\\mu}{1-\\frac{1}{2}\\mu^2}\\right) = -\\arctan\\left(\\frac{\\mu}{1-\\frac{1}{2}\\mu^2}\\right)\n$$\nTherefore, $\\omega_{\\mathrm{d,R}}\\Delta t = \\arctan\\left(\\frac{\\mu}{1-\\frac{1}{2}\\mu^2}\\right)$. For small $\\mu$ (i.e., small $\\Delta t$), we can use Taylor series expansions. Let $x = \\frac{\\mu}{1-\\frac{1}{2}\\mu^2} = \\mu(1-\\frac{1}{2}\\mu^2)^{-1} \\approx \\mu(1+\\frac{1}{2}\\mu^2) = \\mu + \\frac{1}{2}\\mu^3 + O(\\mu^5)$.\nThe Taylor series for $\\arctan(x)$ is $x - \\frac{x^3}{3} + O(x^5)$.\n$$\n\\omega_{\\mathrm{d,R}}\\Delta t = \\left(\\mu + \\frac{1}{2}\\mu^3\\right) - \\frac{1}{3}\\left(\\mu + \\frac{1}{2}\\mu^3\\right)^3 + O(\\mu^5) = \\mu + \\frac{1}{2}\\mu^3 - \\frac{1}{3}\\mu^3 + O(\\mu^5)\n$$\n$$\n\\omega_{\\mathrm{d,R}}\\Delta t = \\mu + \\frac{1}{6}\\mu^3 + O(\\mu^5)\n$$\nSubstituting back $\\mu = c|k|\\Delta t$:\n$$\n\\omega_{\\mathrm{d,R}}\\Delta t = c|k|\\Delta t + \\frac{1}{6}(c|k|\\Delta t)^3 + O((\\Delta t)^5)\n$$\nDividing by $\\Delta t$:\n$$\n\\omega_{\\mathrm{d,R}} = c|k| + \\frac{1}{6}c^3|k|^3(\\Delta t)^2 + O((\\Delta t)^4)\n$$\nThe numerical phase speed is $c_{\\mathrm{num}} = \\omega_{\\mathrm{d,R}}/|k|$:\n$$\nc_{\\mathrm{num}} = c + \\frac{1}{6}c^3|k|^2(\\Delta t)^2 + O((\\Delta t)^4)\n$$\nThe relative phase speed error is $\\frac{c_{\\mathrm{num}} - c}{c}$:\n$$\n\\frac{c_{\\mathrm{num}} - c}{c} = \\frac{1}{c}\\left(\\frac{1}{6}c^3|k|^2(\\Delta t)^2 + O((\\Delta t)^4)\\right) = \\frac{1}{6}c^2|k|^2(\\Delta t)^2 + O((\\Delta t)^4)\n$$\nThe leading-order term of this error is $\\frac{1}{6}(c|k|\\Delta t)^2$. Written in terms of $\\mu$, this is:\n$$\n\\frac{c_{\\mathrm{num}} - c}{c} \\approx \\frac{1}{6}\\mu^2\n$$\nThis is the leading-order relative phase speed error for the scheme.",
            "answer": "$$\n\\boxed{\\frac{1}{6}\\mu^{2}}\n$$"
        }
    ]
}