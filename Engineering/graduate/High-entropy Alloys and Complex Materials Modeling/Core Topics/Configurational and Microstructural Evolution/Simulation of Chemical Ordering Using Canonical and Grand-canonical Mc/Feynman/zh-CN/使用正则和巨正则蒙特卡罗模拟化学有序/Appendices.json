{
    "hands_on_practices": [
        {
            "introduction": "任何蒙特卡洛模拟的效率和准确性都取决于能否快速、精确地计算一个提议移动所引起的能量变化 $\\Delta E$。这项练习聚焦于这一核心步骤，指导您使用团簇展开模型来计算单点原子替换的能量变化，并应用正则系综与巨正则系综的Metropolis准则。这是掌握蒙特卡洛方法基础的绝佳实践。",
            "id": "3756606",
            "problem": "考虑一个位于尺寸为 $N \\times N$ 的二维周期性方格点阵上的多组分合金，其构型能量由团簇展开给出。团簇展开能量定义为 $E(\\sigma) = \\sum_{\\alpha} J_{\\alpha} \\Phi_{\\alpha}(\\sigma)$，其中 $\\sigma$ 表示构型（每个点阵格点上的物种），$J_{\\alpha}$ 是通过密度泛函理论（DFT）校准的有效团簇相互作用（ECI），$\\Phi_{\\alpha}(\\sigma)$ 是团簇 $\\alpha$ 的团簇函数。假设只有以发生嬗变的格点为中心的局域团簇对能量变化有贡献。在本问题中，你将使用点团簇和最近邻对团簇来计算单个格点上提议的嬗变所引起的能量变化。\n\n基本原理和假设：\n- 构型能量 $E(\\sigma)$ 由一个在具有周期性边界条件的方格点阵上、截断至点团簇和最近邻对团簇的有限团簇展开给出。\n- 最近邻由曼哈顿距离为 $1$ 定义（上、下、左、右）。\n- 正则系综 Metropolis 接受概率为 $p_{\\text{can}} = \\min\\left(1, \\exp(-\\beta \\Delta E)\\right)$，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是温度。\n- 巨正则系综接受概率为 $p_{\\text{gc}} = \\min\\left(1, \\exp\\left[-\\beta \\left(\\Delta E - \\sum_{s} \\mu_{s} \\Delta N_{s}\\right)\\right]\\right)$，其中 $\\mu_{s}$ 是物种 $s$ 的化学势，$\\Delta N_{s}$ 是提议的嬗变引起的物种 $s$ 数量的变化。对于从物种 $s_{\\text{old}}$ 到 $s_{\\text{new}}$ 的单格点嬗变，$\\Delta N_{s_{\\text{new}}} = +1$，$\\Delta N_{s_{\\text{old}}} = -1$，所有其他的 $\\Delta N_{s} = 0$，因此有效能量变化为 $\\Delta E_{\\text{eff}} = \\Delta E - (\\mu_{s_{\\text{new}}} - \\mu_{s_{\\text{old}}})$。\n- 玻尔兹曼常数 $k_{\\mathrm{B}}$ 必须使用电子伏特每开尔文单位：$k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5} \\ \\mathrm{eV/K}$。\n\n使用的团簇函数定义：\n- 格点 $i$ 上的点团簇贡献：为每种物种分配的能量，其 ECI 向量为 $\\mathbf{J}^{\\text{point}}$，使得贡献等于 $J^{\\text{point}}_{\\sigma_{i}}$。\n- 最近邻对 $(i,j)$ 的对团簇贡献：为每种有序物种对分配的能量，其 ECI 矩阵 $J^{\\text{pair}}_{a,b}$ 在 $a$ 和 $b$ 上对称；贡献等于 $J^{\\text{pair}}_{\\sigma_{i},\\sigma_{j}}$。\n\n任务：\n- 对每个测试用例，仅使用涉及嬗变格点的局域点团簇和最近邻对团簇贡献，计算单个格点上提议的嬗变所导致的能量变化 $\\Delta E$（单位：电子伏特）。在点阵边缘使用周期性边界条件。然后，在指定的温度和化学势下，计算正则接受概率 $p_{\\text{can}}$ 和巨正则接受概率 $p_{\\text{gc}}$。\n\n物种映射：\n- 使用三种物种，标记为 $A, B, C$，分别映射到整数 $0, 1, 2$。\n\n单位和数值输出要求：\n- 以电子伏特（eV）表示 $\\Delta E$。\n- 以小数形式表示接受概率 $p_{\\text{can}}$ 和 $p_{\\text{gc}}$。\n- 将所有输出四舍五入到六位小数。\n\n最终输出格式：\n- 你的程序应生成单行输出，包含一个由方括号括起来的列表的逗号分隔列表。每个内部列表必须是 $[\\Delta E, p_{\\text{can}}, p_{\\text{gc}}]$ 的形式，对应一个测试用例，其值四舍五入到六位小数。例如，格式为 $[[x_{1},y_{1},z_{1}],[x_{2},y_{2},z_{2}],\\ldots]$。\n\n测试套件：\n- 以下所有索引均为零基索引 $(0 \\leq i,j  N)$。\n\n1) 正常路径情况（非平凡邻域，混合物种）：\n- 点阵尺寸：$N = 4$。\n- 构型 $\\sigma$ （物种整数网格）：\n$$\n\\begin{bmatrix}\n0   1  2  0 \\\\\n1   0  1  2 \\\\\n2   1  0  1 \\\\\n0   2  1  0\n\\end{bmatrix}\n$$\n- 嬗变格点：$(i,j) = (0,1)$。\n- 提议的嬗变：$B \\to C$（旧物种 $1$，新物种 $2$）。\n- 点 ECI（单位：eV）：$\\mathbf{J}^{\\text{point}} = [0.12, \\ 0.00, \\ -0.05]$。\n- 对 ECI（单位：eV），对称矩阵 $J^{\\text{pair}}$：\n$$\n\\begin{bmatrix}\n0.00   0.02   -0.01 \\\\\n0.02   0.00   0.015 \\\\\n-0.01  0.015  0.00\n\\end{bmatrix}\n$$\n- 温度：$T = 1000$ K。\n- 化学势（单位：eV）：$\\boldsymbol{\\mu} = [0.10, \\ 0.00, \\ -0.02]$。\n\n2) 边界条件（无变化移动）：\n- 点阵尺寸：$N = 3$。\n- 构型 $\\sigma$：\n$$\n\\begin{bmatrix}\n0  0  0 \\\\\n0  0  0 \\\\\n0  0  0\n\\end{bmatrix}\n$$\n- 嬗变格点：$(i,j) = (1,1)$。\n- 提议的嬗变：$A \\to A$（旧物种 $0$，新物种 $0$）。\n- 点 ECI（单位：eV）：$\\mathbf{J}^{\\text{point}} = [0.12, \\ 0.00, \\ -0.05]$。\n- 对 ECI（单位：eV），对称矩阵 $J^{\\text{pair}}$：\n$$\n\\begin{bmatrix}\n0.00   0.02   -0.01 \\\\\n0.02   0.00   0.015 \\\\\n-0.01  0.015  0.00\n\\end{bmatrix}\n$$\n- 温度：$T = 500$ K。\n- 化学势（单位：eV）：$\\boldsymbol{\\mu} = [0.0, \\ 0.0, \\ 0.0]$。\n\n3) 边缘情况（与周围物种有强烈的有利相互作用）：\n- 点阵尺寸：$N = 4$。\n- 构型 $\\sigma$：\n$$\n\\begin{bmatrix}\n2  2  2  2 \\\\\n2  1  1  2 \\\\\n2  1  0  2 \\\\\n2  2  2  2\n\\end{bmatrix}\n$$\n- 嬗变格点：$(i,j) = (1,2)$。\n- 提议的嬗变：$B \\to A$（旧物种 $1$，新物种 $0$）。\n- 点 ECI（单位：eV）：$\\mathbf{J}^{\\text{point}} = [0.12, \\ 0.00, \\ -0.05]$。\n- 对 ECI（单位：eV），对称矩阵 $J^{\\text{pair}}$：\n$$\n\\begin{bmatrix}\n0.00   0.01   -0.08 \\\\\n0.01   0.00   0.02 \\\\\n-0.08  0.02   0.00\n\\end{bmatrix}\n$$\n- 温度：$T = 300$ K。\n- 化学势（单位：eV）：$\\boldsymbol{\\mu} = [0.0, \\ 0.0, \\ 0.0]$。\n\n4) 巨正则惩罚（化学势不利于新物种）：\n- 点阵尺寸：$N = 4$。\n- 构型 $\\sigma$：\n$$\n\\begin{bmatrix}\n0  1  0  2 \\\\\n1  2  1  0 \\\\\n0  1  2  1 \\\\\n2  0  1  0\n\\end{bmatrix}\n$$\n- 嬗变格点：$(i,j) = (0,0)$。\n- 提议的嬗变：$A \\to B$（旧物种 $0$，新物种 $1$）。\n- 点 ECI（单位：eV）：$\\mathbf{J}^{\\text{point}} = [0.12, \\ 0.00, \\ -0.05]$。\n- 对 ECI（单位：eV），对称矩阵 $J^{\\text{pair}}$：\n$$\n\\begin{bmatrix}\n0.00   0.02   -0.01 \\\\\n0.02   0.00   0.015 \\\\\n-0.01  0.015  0.00\n\\end{bmatrix}\n$$\n- 温度：$T = 800$ K。\n- 化学势（单位：eV）：$\\boldsymbol{\\mu} = [0.0, \\ -0.30, \\ 0.0]$。\n\n你的程序必须为每个测试用例计算三元组 $[\\Delta E, p_{\\text{can}}, p_{\\text{gc}}]$，并按照上述确切格式生成单行输出。所有能量必须以电子伏特（eV）为单位，所有概率必须是小数。将每个数字四舍五入到六位小数。",
            "solution": "该问题被评估为有效，因为它具有科学依据、问题明确、客观，并包含得出唯一解所需的所有必要信息。它描述了材料建模中的一个标准计算任务，该任务基于统计力学和固态物理学的基本原理。\n\n问题的核心是计算二维方格点阵上多组分合金中单格点嬗变的构型能量变化 $\\Delta E$，并随后在正则系综和巨正则系综中计算此移动的 Metropolis 接受概率。对于给定的构型 $\\sigma$（即每个点阵格点上的物种分配），系统的构型能量 $E(\\sigma)$ 由团簇展开模型定义。问题陈述指出，该展开被截断，仅包括点相互作用和最近邻对相互作用。\n\n构型 $\\sigma$ 的能量由以下公式给出：\n$$ E(\\sigma) = \\sum_{i} E_{i}^{\\text{point}} + \\sum_{\\langle i, j \\rangle} E_{i,j}^{\\text{pair}} $$\n其中第一个和式遍历所有点阵格点 $i$，第二个和式遍历所有唯一的最近邻对 $\\langle i, j \\rangle$。格点 $i$ 上的点能量取决于该格点上的物种 $\\sigma_i$，$E_{i}^{\\text{point}} = J^{\\text{point}}_{\\sigma_i}$。格点对 $(i,j)$ 的对能量取决于这些格点上的物种，$E_{i,j}^{\\text{pair}} = J^{\\text{pair}}_{\\sigma_i, \\sigma_j}$。\n\n我们的任务是计算当单个格点 $k$ 上的物种从旧物种 $s_{\\text{old}}$ 嬗变为新物种 $s_{\\text{new}}$ 时的能量变化 $\\Delta E = E_{\\text{final}} - E_{\\text{initial}}$。根据问题陈述，我们只需要考虑以嬗变格点 $k$ 为中心的局域团簇。这是因为只有涉及格点 $k$ 的能量项会发生变化。变化包括两部分：\n1. 格点 $k$ 上的点能量变化。\n2. 涉及格点 $k$ 的所有对的对能量变化。\n\n点能量的变化为：\n$$ \\Delta E_{\\text{point}} = J^{\\text{point}}_{s_{\\text{new}}} - J^{\\text{point}}_{s_{\\text{old}}} $$\n\n在二维方格点阵上，格点 $k$ 有四个最近邻。设 $k$ 的最近邻格点集合为 $\\mathcal{N}(k)$。对能量贡献的变化是每个对 $(k, j)$ 的变化之和，其中 $j \\in \\mathcal{N}(k)$：\n$$ \\Delta E_{\\text{pair}} = \\sum_{j \\in \\mathcal{N}(k)} \\left( J^{\\text{pair}}_{s_{\\text{new}}, \\sigma_{j}} - J^{\\text{pair}}_{s_{\\text{old}}, \\sigma_{j}} \\right) $$\n其中 $\\sigma_j$ 是相邻格点 $j$ 上的物种。\n\n构型能量的总变化是这两部分贡献之和：\n$$ \\Delta E = \\Delta E_{\\text{point}} + \\Delta E_{\\text{pair}} $$\n\n点阵是周期性的，因此在一个 $N \\times N$ 网格上（使用 0 基索引），坐标为 $(i, j)$ 的格点的四个最近邻坐标为：\n- 上：$((i - 1 + N) \\pmod N, j)$\n- 下：$((i + 1) \\pmod N, j)$\n- 左：$(i, (j - 1 + N) \\pmod N)$\n- 右：$(i, (j + 1) \\pmod N)$\n\n一旦计算出 $\\Delta E$，我们就可以确定接受概率。热能由 $k_{\\mathrm{B}}T$ 给出，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，给定为 $k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5} \\ \\mathrm{eV/K}$。我们定义逆温度 $\\beta = 1 / (k_{\\mathrm{B}}T)$。\n\n正则系综接受概率 $p_{\\text{can}}$ 由 Metropolis 准则给出：\n$$ p_{\\text{can}} = \\min\\left(1, \\exp(-\\beta \\Delta E)\\right) $$\n如果 $\\Delta E \\leq 0$，移动总是被接受（$p_{\\text{can}} = 1$）。如果 $\\Delta E  0$，移动以小于 $1$ 的概率被接受，从而惩罚能量上不利的变化。\n\n在巨正则系综中，接受概率 $p_{\\text{gc}}$ 取决于有效能量变化 $\\Delta E_{\\text{eff}}$，该变化包括了抵抗化学势 $\\mu_s$ 改变粒子数所做的功。对于从 $s_{\\text{old}}$ 到 $s_{\\text{new}}$ 的嬗变，物种 $s_{\\text{new}}$ 的原子数增加一（$\\Delta N_{s_{\\text{new}}} = +1$），而物种 $s_{\\text{old}}$ 的原子数减少一（$\\Delta N_{s_{\\text{old}}} = -1$）。巨势能的变化是 $\\Delta \\Omega = \\Delta E - \\sum_s \\mu_s \\Delta N_s$。这可以简化为：\n$$ \\Delta E_{\\text{eff}} = \\Delta E - (\\mu_{s_{\\text{new}}} - \\mu_{s_{\\text{old}}}) $$\n巨正则接受概率则为：\n$$ p_{\\text{gc}} = \\min\\left(1, \\exp(-\\beta \\Delta E_{\\text{eff}})\\right) $$\n\n解决每个测试用例的算法如下：\n1. 识别格点 $(i,j)$ 上嬗变的旧物种 $s_{\\text{old}}$ 和新物种 $s_{\\text{new}}$。\n2. 应用周期性边界条件，确定格点 $(i,j)$ 的四个最近邻的物种。\n3. 计算 $\\Delta E_{\\text{point}} = J^{\\text{point}}_{s_{\\text{new}}} - J^{\\text{point}}_{s_{\\text{old}}}$。\n4. 通过对四个邻居求和变化量 $J^{\\text{pair}}_{s_{\\text{new}}, \\sigma_j} - J^{\\text{pair}}_{s_{\\text{old}}, \\sigma_j}$ 来计算 $\\Delta E_{\\text{pair}}$。\n5. 计算总能量变化 $\\Delta E = \\Delta E_{\\text{point}} + \\Delta E_{\\text{pair}}$。\n6. 计算 $\\beta = 1 / (k_{\\mathrm{B}}T)$。\n7. 计算 $p_{\\text{can}} = \\min(1, \\exp(-\\beta \\Delta E))$。\n8. 计算 $\\Delta E_{\\text{eff}} = \\Delta E - (\\mu_{s_{\\text{new}}} - \\mu_{s_{\\text{old}}})$。\n9. 计算 $p_{\\text{gc}} = \\min(1, \\exp(-\\beta \\Delta E_{\\text{eff}}))$。\n10. 将 $\\Delta E$、$p_{\\text{can}}$ 和 $p_{\\text{gc}}$ 的结果四舍五入到六位小数。\n\n此过程将应用于问题陈述中提供的每个测试用例。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the energy change and acceptance probabilities for single-site\n    transmutations in a 2D lattice model of a multi-component alloy.\n    \"\"\"\n    k_B = 8.617333262145e-5  # Boltzmann constant in eV/K\n\n    test_cases = [\n        {\n            \"N\": 4,\n            \"sigma\": np.array([\n                [0, 1, 2, 0],\n                [1, 0, 1, 2],\n                [2, 1, 0, 1],\n                [0, 2, 1, 0]\n            ]),\n            \"site\": (0, 1),\n            \"transmutation\": (1, 2),  # old - new\n            \"J_point\": np.array([0.12, 0.00, -0.05]),\n            \"J_pair\": np.array([\n                [0.00, 0.02, -0.01],\n                [0.02, 0.00, 0.015],\n                [-0.01, 0.015, 0.00]\n            ]),\n            \"T\": 1000.0,\n            \"mu\": np.array([0.10, 0.00, -0.02])\n        },\n        {\n            \"N\": 3,\n            \"sigma\": np.array([\n                [0, 0, 0],\n                [0, 0, 0],\n                [0, 0, 0]\n            ]),\n            \"site\": (1, 1),\n            \"transmutation\": (0, 0),\n            \"J_point\": np.array([0.12, 0.00, -0.05]),\n            \"J_pair\": np.array([\n                [0.00, 0.02, -0.01],\n                [0.02, 0.00, 0.015],\n                [-0.01, 0.015, 0.00]\n            ]),\n            \"T\": 500.0,\n            \"mu\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"N\": 4,\n            \"sigma\": np.array([\n                [2, 2, 2, 2],\n                [2, 1, 1, 2],\n                [2, 1, 0, 2],\n                [2, 2, 2, 2]\n            ]),\n            \"site\": (1, 2),\n            \"transmutation\": (1, 0),\n            \"J_point\": np.array([0.12, 0.00, -0.05]),\n            \"J_pair\": np.array([\n                [0.00, 0.01, -0.08],\n                [0.01, 0.00, 0.02],\n                [-0.08, 0.02, 0.00]\n            ]),\n            \"T\": 300.0,\n            \"mu\": np.array([0.0, 0.0, 0.0])\n        },\n        {\n            \"N\": 4,\n            \"sigma\": np.array([\n                [0, 1, 0, 2],\n                [1, 2, 1, 0],\n                [0, 1, 2, 1],\n                [2, 0, 1, 0]\n            ]),\n            \"site\": (0, 0),\n            \"transmutation\": (0, 1),\n            \"J_point\": np.array([0.12, 0.00, -0.05]),\n            \"J_pair\": np.array([\n                [0.00, 0.02, -0.01],\n                [0.02, 0.00, 0.015],\n                [-0.01, 0.015, 0.00]\n            ]),\n            \"T\": 800.0,\n            \"mu\": np.array([0.0, -0.30, 0.0])\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        sigma = case[\"sigma\"]\n        i, j = case[\"site\"]\n        s_old, s_new = case[\"transmutation\"]\n        J_point = case[\"J_point\"]\n        J_pair = case[\"J_pair\"]\n        T = case[\"T\"]\n        mu = case[\"mu\"]\n\n        # No change in energy or species count if old == new\n        if s_old == s_new:\n            delta_E = 0.0\n            p_can = 1.0\n            p_gc = 1.0\n            all_results.append(f\"[{delta_E:.6f},{p_can:.6f},{p_gc:.6f}]\")\n            continue\n\n        # 1. Identify nearest neighbors with periodic boundary conditions\n        neighbors_pos = [\n            ((i - 1 + N) % N, j),  # Up\n            ((i + 1) % N, j),      # Down\n            (i, (j - 1 + N) % N),  # Left\n            (i, (j + 1) % N)       # Right\n        ]\n        neighbor_species = [sigma[pos] for pos in neighbors_pos]\n\n        # 2. Calculate energy change delta_E\n        # Point energy change\n        delta_E_point = J_point[s_new] - J_point[s_old]\n\n        # Pair energy change\n        delta_E_pair = 0.0\n        for s_neighbor in neighbor_species:\n            delta_E_pair += J_pair[s_new, s_neighbor] - J_pair[s_old, s_neighbor]\n        \n        delta_E = delta_E_point + delta_E_pair\n\n        # 3. Calculate acceptance probabilities\n        if T == 0:\n            # Handle T=0 case to avoid division by zero, although not in tests\n            beta = float('inf')\n        else:\n            beta = 1.0 / (k_B * T)\n\n        # Canonical acceptance probability\n        p_can = min(1.0, np.exp(-beta * delta_E))\n\n        # Grand-canonical acceptance probability\n        delta_mu = mu[s_new] - mu[s_old]\n        delta_E_eff = delta_E - delta_mu\n        p_gc = min(1.0, np.exp(-beta * delta_E_eff))\n\n        all_results.append(f\"[{delta_E:.6f},{p_can:.6f},{p_gc:.6f}]\")\n\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "为何需要复杂的蒙特卡洛模拟？这项练习通过将经典的Bragg-Williams平均场理论与精确解进行对比，回答了这个问题。您将通过“纸上推演”亲身揭示平均场近似如何因忽略局域涨落而高估临界温度 $T_c^{\\mathrm{BW}}$，从而深刻理解蒙特卡洛方法在精确预测相变行为中的重要性。",
            "id": "3756593",
            "problem": "考虑一个规则晶格上的二元合金，其最近邻对相互作用可以映射到自旋-$\\frac{1}{2}$伊辛模型。设物种 $A$ 和 $B$ 由自旋变量 $\\sigma_i \\in \\{+1,-1\\}$ 表示，构型哈密顿量为 $H = -J \\sum_{\\langle i j \\rangle} \\sigma_i \\sigma_j$，其中 $J0$ 有利于化学有序，求和遍及所有不同的最近邻对。序参量是子晶格磁化强度 $m = \\langle \\sigma_i \\rangle$，它对应于长程化学有序。正则系综在等原子分数 $x_A = x_B = \\frac{1}{2}$ 时具有固定的组分，而巨正则系综则固定化学势 $\\mu_A$ 和 $\\mu_B$；在热力学极限下，对于等原子组分，当 $\\mu_A = \\mu_B$ 时，这两个系综中的有序化转变在相同温度下发生。\n\nBragg–Williams 平均场近似将波动的局域环境替换为其平均值。从正则和巨正则配分函数的核心统计力学定义出发，并利用自旋所感受到的有效场的平均场近似，推导 Bragg–Williams 临界温度 $T_c^{\\mathrm{BW}}$ 作为配位数 $z$ 和相互作用强度 $J$ 的函数。作为二维蒙特卡洛（MC, Monte Carlo）结果的参考，使用经过充分检验的方晶格伊辛模型的精确临界温度，\n$$\n\\frac{k_B T_c^{\\mathrm{MC}}}{J} = \\frac{2}{\\ln\\!\\big(1+\\sqrt{2}\\big)},\n$$\n它对应于热力学极限下的正则蒙特卡洛模拟，并且在等原子组分且 $\\mu_A=\\mu_B$ 的条件下，可以通过巨正则蒙特卡洛模拟得到。\n\n对于配位数为 $z=4$ 的方晶格，计算比率\n$$\nR \\equiv \\frac{T_c^{\\mathrm{BW}}}{T_c^{\\mathrm{MC}}}.\n$$\n将你的最终答案表示为一个纯数（无量纲），并四舍五入到四位有效数字。在你的推导过程中，从第一性原理出发简要论证 $T_c^{\\mathrm{BW}}$ 对 $z$ 的依赖关系，并解释为何即使在固定组分的情况下，蒙特卡洛结果也反映了非平均场配位效应。除了基本定义和所提供的精确二维参考值之外，不要提供任何中间的简化公式。",
            "solution": "该问题要求使用 Bragg–Williams 平均场近似推导二元合金体系在伊辛模型下的临界温度，然后将此结果与二维方晶格的精确解进行比较。\n\n该系统由伊辛哈密顿量描述：\n$$\nH = -J \\sum_{\\langle i, j \\rangle} \\sigma_i \\sigma_j\n$$\n其中 $\\sigma_i \\in \\{+1, -1\\}$ 代表格点 $i$ 上的物种，$J  0$ 是相互作用能，求和遍及所有最近邻对。该问题采用 Bragg–Williams 平均场理论 (MFT) 进行求解。\n\n在 MFT 中，所有邻近自旋对单个自旋 $\\sigma_i$ 的作用被一个平均的、非涨落的有效场所取代。单个自旋 $\\sigma_i$ 与其 $z$ 个最近邻相互作用的哈密顿量为：\n$$\nH_i = -J \\sigma_i \\sum_{j \\in \\text{nn}(i)} \\sigma_j\n$$\nMFT 的核心假设是将每个邻近自旋 $\\sigma_j$ 替换为其热平均值，即单位格点的磁化强度 $m = \\langle \\sigma_j \\rangle$。这一近似产生了一个有效的单自旋哈密顿量：\n$$\nH_i^{\\mathrm{MF}} \\approx -J \\sigma_i \\sum_{j \\in \\text{nn}(i)} m = -J z m \\sigma_i\n$$\n这是单个自旋 $\\sigma_i$ 在有效磁场 $h_{\\mathrm{eff}} = Jzm$ 中的哈密顿量。现在问题简化为求解磁化强度 $m$ 的自洽值。\n\n$\\sigma_i$ 的热平均值必须等于 $m$。我们使用由 $H_i^{\\mathrm{MF}}$ 描述的单自旋系统的玻尔兹曼分布来计算这个平均值。单个自旋的配分函数为：\n$$\nZ_1 = \\sum_{\\sigma_i \\in \\{+1, -1\\}} \\exp(-\\beta H_i^{\\mathrm{MF}}) = \\sum_{\\sigma_i \\in \\{+1, -1\\}} \\exp(\\beta J z m \\sigma_i)\n$$\n其中 $\\beta = 1/(k_B T)$。计算求和得到：\n$$\nZ_1 = \\exp(\\beta J z m) + \\exp(-\\beta J z m) = 2 \\cosh(\\beta J z m)\n$$\n$\\sigma_i$ 的热平均值则为：\n$$\n\\langle \\sigma_i \\rangle = \\frac{1}{Z_1} \\sum_{\\sigma_i \\in \\{+1, -1\\}} \\sigma_i \\exp(\\beta J z m \\sigma_i) = \\frac{(+1)\\exp(\\beta J z m) + (-1)\\exp(-\\beta J z m)}{2 \\cosh(\\beta J z m)}\n$$\n$$\n\\langle \\sigma_i \\rangle = \\frac{2 \\sinh(\\beta J z m)}{2 \\cosh(\\beta J z m)} = \\tanh(\\beta J z m)\n$$\n自洽条件是 $m = \\langle \\sigma_i \\rangle$，这导出了方程：\n$$\nm = \\tanh(\\beta J z m)\n$$\n临界温度 $T_c$ 是指当系统从高温无序相（$m=0$）冷却时，首次出现 $m$ 的非零解的温度。在 $T_c$ 附近，磁化强度 $m$ 是无穷小。我们可以通过对双曲正切函数在小自变量 $x = \\beta J z m$ 处进行泰勒展开来分析自洽方程，$\\tanh(x) \\approx x - x^3/3 + \\dots$。\n$$\nm \\approx (\\beta J z m) - \\frac{1}{3}(\\beta J z m)^3\n$$\n一个解始终是 $m=0$，对应于顺磁（无序）相。为了存在非平凡解（$m \\neq 0$），我们可以两边同除以 $m$：\n$$\n1 \\approx \\beta J z - \\frac{1}{3}(\\beta J z)^2 m^2\n$$\n相变发生在函数 $f(m) = \\tanh(\\beta J z m)$ 在 $m=0$ 处的斜率恰好等于函数 $g(m)=m$ 的斜率（即 1）的那一点。\n$$\n\\left. \\frac{d}{dm} \\tanh(\\beta J z m) \\right|_{m=0} = \\left. \\beta J z \\cdot \\text{sech}^2(\\beta J z m) \\right|_{m=0} = \\beta J z\n$$\n将此斜率设为 1，得到临界点的条件：\n$$\n\\beta_c J z = 1 \\implies \\frac{1}{k_B T_c^{\\mathrm{BW}}} J z = 1\n$$\n求解 Bragg–Williams 临界温度 $T_c^{\\mathrm{BW}}$：\n$$\nk_B T_c^{\\mathrm{BW}} = Jz\n$$\n这个结果表明，在平均场近似中，临界温度与配位数 $z$ 成正比。这是因为自旋感受到的有效有序场 $h_{\\mathrm{eff}} = Jzm$ 与邻居数量 $z$ 呈线性关系。更大的配位数导致更强的协作效应，需要更大的热能（$k_B T$）来破坏有序状态。\n\n平均场理论高估了临界温度，因为它忽略了涨落和局域关联。通过假设每个邻居都具有相同的平均自旋 $m$，它忽略了自旋态是相互关联的这一事实。蒙特卡洛（MC）模拟从精确的玻尔兹曼分布中采样构型，能够正确地捕捉这些关联。涨落会使系统趋向无序，因此在 MC 模拟或精确解中得到的真实临界温度低于 MFT 的预测值。这种差异在低维系统（如 $d=2$ 的方晶格）中尤其大，因为在这些系统中涨落起着更主导的作用。\n\n现在，我们计算方晶格的比率 $R = T_c^{\\mathrm{BW}} / T_c^{\\mathrm{MC}}$。\n对于方晶格，配位数为 $z=4$。Bragg–Williams 预测为：\n$$\nk_B T_c^{\\mathrm{BW}} = 4J \\implies \\frac{k_B T_c^{\\mathrm{BW}}}{J} = 4\n$$\n问题给出了二维方晶格伊辛模型的精确临界温度，它对应于热力学极限下正则 MC 模拟的结果：\n$$\n\\frac{k_B T_c^{\\mathrm{MC}}}{J} = \\frac{2}{\\ln(1+\\sqrt{2})}\n$$\n因此，比率 $R$ 为：\n$$\nR = \\frac{T_c^{\\mathrm{BW}}}{T_c^{\\mathrm{MC}}} = \\frac{k_B T_c^{\\mathrm{BW}}/J}{k_B T_c^{\\mathrm{MC}}/J} = \\frac{4}{\\frac{2}{\\ln(1+\\sqrt{2})}} = 2 \\ln(1+\\sqrt{2})\n$$\n我们现在计算 $R$ 的数值：\n$$\n\\sqrt{2} \\approx 1.41421356\n$$\n$$\n1 + \\sqrt{2} \\approx 2.41421356\n$$\n$$\n\\ln(1+\\sqrt{2}) \\approx \\ln(2.41421356) \\approx 0.88137359\n$$\n$$\nR \\approx 2 \\times 0.88137359 \\approx 1.76274718\n$$\n四舍五入到四位有效数字，我们得到 $R \\approx 1.763$。这证实了对于二维方晶格，平均场理论将临界温度高估了约 $1.763$ 倍。",
            "answer": "$$\\boxed{1.763}$$"
        },
        {
            "introduction": "大规模蒙特卡洛模拟的计算成本高昂，最大化地利用每一次模拟的数据至关重要。本练习将介绍强大的直方图重加权技术，它允许您利用在某一温度下的数据来预测材料在其他（未直接模拟的）温度下的性质。通过这项编码实践，您将学会一种高级数据分析方法，并体会到数值稳定性在科学计算中的重要性。",
            "id": "3756514",
            "problem": "给定两个独立的正则蒙特卡洛（MC）数据集，它们代表了一个多组分合金在两个相近的绝对温度下的总能量和一个标量化学有序参数的样本。物理背景是正则系综，其中一个能量为 $E$ 的微观态在绝对温度 $T$ 下出现的概率正比于 $\\exp(-\\beta E)$，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数。任务是实现单直方图重加权方法，以在某个中间温度下估算有序参数的系综平均值，需要分别基于每个数据集进行估算，并验证两者之间的一致性。\n\n从以下基本定义开始：\n- 正则系综的平衡概率密度由 $p_{\\beta}(s) \\propto \\exp(-\\beta E(s))$ 给出，其中 $s$ 表示一个能量为 $E(s)$ 的微观态，且 $\\beta = 1/(k_{\\mathrm{B}} T)$。\n- 在逆温度 $\\beta$ 下，可观测量 $A$ 的系综平均值定义为 $\\langle A \\rangle_{\\beta} = \\sum_{s} A(s) p_{\\beta}(s)$（如果微观态空间是连续的，则为相应的积分）。\n- 所提供的数据集是由蒙特卡洛动力学产生的独立样本，该动力学在各自的温度下保持了正则分布。\n\n仅使用这些定义和重要性采样的逻辑，推导一个数值稳定的表达式，用于将一个标量可观测量的样本平均值从一个逆温度 $\\beta_0$ 重加权到另一个逆温度 $\\beta^{\\star}$。然后实现一个算法，以分别从每个数据集中计算 $\\langle \\eta \\rangle_{\\beta^{\\star}}$ 的重加权估计值。对两个数据集使用相同的玻尔兹曼常数。实现重加权时，要使其对于较大的 $|\\beta^{\\star} - \\beta_0|$ 值和大幅值的能量具有鲁棒性，以避免数值上溢或下溢。\n\n物理单位：\n- 能量必须以电子伏特（eV）为单位。\n- 温度必须以开尔文（K）为单位。\n- 使用的玻尔兹曼常数为 $k_{\\mathrm{B}} = 8.617\\,333\\,262\\,145 \\times 10^{-5}$ eV/K。\n- 有序参数 $\\eta$ 是无量纲的。\n\n角度单位不适用。如果计算任何分数差，请以小数形式表示（不要使用百分号）。\n\n数值规范和输出格式：\n- 对于每个测试用例，在指定的中间温度 $T^{\\star}$ 下计算两个独立的 $\\langle \\eta \\rangle$ 重加权估计值，一个仅使用在 $T_1$ 温度下采样的数据集，另一个仅使用在 $T_2$ 温度下采样的数据集。然后计算这两个估计值之间的绝对差。通过检查绝对差是否小于或等于指定的绝对容差 $\\tau$，来确定这两个估计值是否在容差范围内一致。\n- 对于每个测试用例，程序必须按顺序输出一个包含四个条目的列表：来自 $T_1$ 数据集的估计值、来自 $T_2$ 数据集的估计值、绝对差，以及一个布尔值，指示差值是否在给定容差范围内。所有浮点输出必须四舍五入到六位小数。\n- 您的程序应生成单行输出，其中包含所有测试用例的结果，形式为一个用方括号括起来的逗号分隔列表，其中每个测试用例的结果本身也是如上所述的列表。例如，一个有效的输出格式为 $[[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],\\ldots]$，其中每个 $a_i$、$b_i$、$c_i$ 是浮点数，每个 $d_i$ 是布尔值。\n\n测试套件：\n使用以下四个测试用例，每个用例都指定了温度、容差和数据集。能量和有序参数以列表形式给出；列表中的每个数字都是一个标量值。\n\n- 测试用例 1（温度分离适中，直方图重叠良好）：\n  - $T_1 = 900$ K，$T_2 = 1100$ K，$T^{\\star} = 1000$ K，$\\tau = 0.1$。\n  - $T_1$ 下的数据集：能量（单位 eV）$[-3.25,-3.10,-3.05,-2.95,-3.40,-2.80,-3.00,-3.30,-2.90,-3.15]$ 和有序参数 $\\eta$ $[0.83,0.70,0.66,0.58,0.95,0.45,0.62,0.87,0.53,0.74]$。\n  - $T_2$ 下的数据集：能量（单位 eV）$[-3.05,-2.95,-2.85,-2.75,-3.10,-2.90,-2.80,-3.00,-2.70,-2.88]$ 和有序参数 $\\eta$ $[0.66,0.58,0.49,0.41,0.70,0.53,0.45,0.62,0.37,0.52]$。\n\n- 测试用例 2（温度分离极小；接近恒等的重加权）：\n  - $T_1 = 1000$ K，$T_2 = 1005$ K，$T^{\\star} = 1002.5$ K，$\\tau = 0.01$。\n  - $T_1$ 下的数据集：能量（单位 eV）$[-3.02,-3.01,-2.99,-3.00,-3.03,-2.98,-2.97,-3.04]$ 和有序参数 $\\eta$ $[0.63,0.62,0.61,0.62,0.64,0.60,0.59,0.65]$。\n  - $T_2$ 下的数据集：能量（单位 eV）$[-3.01,-3.00,-2.99,-2.98,-3.02,-2.97,-3.03,-2.96]$ 和有序参数 $\\eta$ $[0.62,0.62,0.61,0.60,0.63,0.59,0.64,0.58]$。\n\n- 测试用例 3（分离较宽但仍有重叠）：\n  - $T_1 = 600$ K，$T_2 = 800$ K，$T^{\\star} = 700$ K，$\\tau = 0.1$。\n  - $T_1$ 下的数据集：能量（单位 eV）$[-3.60,-3.50,-3.40,-3.70,-3.20,-3.30,-3.55,-3.45]$ 和有序参数 $\\eta$ $[0.93,0.88,0.83,0.96,0.73,0.78,0.91,0.86]$。\n  - $T_2$ 下的数据集：能量（单位 eV）$[-3.30,-3.20,-3.10,-3.00,-3.40,-3.25,-3.15,-2.95]$ 和有序参数 $\\eta$ $[0.78,0.73,0.68,0.63,0.83,0.75,0.70,0.60]$。\n\n- 测试用例 4（直方图重叠差；预计不一致）：\n  - $T_1 = 300$ K，$T_2 = 900$ K，$T^{\\star} = 600$ K，$\\tau = 0.02$。\n  - $T_1$ 下的数据集：能量（单位 eV）$[-4.50,-4.40,-4.60,-4.70,-4.30,-4.20,-4.55,-4.35]$ 和有序参数 $\\eta$ $[0.98,0.96,0.99,1.00,0.94,0.92,0.99,0.95]$。\n  - $T_2$ 下的数据集：能量（单位 eV）$[-3.10,-3.00,-2.90,-2.80,-3.20,-2.95,-2.85,-2.75]$ 和有序参数 $\\eta$ $[0.68,0.63,0.58,0.53,0.73,0.60,0.55,0.50]$。\n\n您的程序必须：\n- 通过最大指数移位，使用权重 $\\exp(-(\\beta^{\\star}-\\beta_0) E_i)$ 的数值稳定计算来实现单直方图重加权，以避免上溢或下溢。\n- 对于每个测试用例，计算在 $T^{\\star}$ 下的两个 $\\langle \\eta \\rangle$ 估计值、它们的绝对差以及它们是否在容差范围内。\n- 输出单行，包含一个列表，每个测试用例对应一个条目，其中每个条目是按指定顺序包含四个所需输出的列表，所有浮点数四舍五入到六位小数，例如 $[[x_{1,1},x_{1,2},x_{1,3},x_{1,4}],[x_{2,1},x_{2,2},x_{2,3},x_{2,4}],\\ldots]$。",
            "solution": "## **问题验证**\n\n### 步骤 1：提取给定信息\n- **物理背景**：正则系综（恒定的 N, V, T）。\n- **概率密度**：$p_{\\beta}(s) \\propto \\exp(-\\beta E(s))$，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$。\n- **系综平均**：$\\langle A \\rangle_{\\beta} = \\sum_{s} A(s) p_{\\beta}(s)$。\n- **数据**：为每个测试用例提供了两个独立的正则蒙特卡洛数据集。每个数据集包含一系列总能量（$E$）和一个标量化学有序参数（$\\eta$）。这些数据集是在两个相近的绝对温度 $T_1$ 和 $T_2$ 下采样的。\n- **任务**：1. 实现单直方图重加权，以估算在中间温度 $T^{\\star}$ 下的系综平均值 $\\langle \\eta \\rangle$。2. 分别基于每个数据集进行此估算。3. 验证两个估计值的相互一致性。\n- **推导要求**：从第一性原理（定义和重要性采样）推导出一个数值稳定的重加权表达式。\n- **数值稳定性**：实现必须对数值上溢/下溢具有鲁棒性，特别是对于较大的 $|\\beta^{\\star} - \\beta_0|$ 和大幅值的能量。\n- **物理单位**：能量（$E$）：电子伏特（eV）。温度（$T$）：开尔文（K）。\n- **物理常数**：玻尔兹曼常数，$k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5}$ eV/K。\n- **可观测量**：有序参数 $\\eta$（无量纲）。\n- **输出规范**：对于每个测试用例，生成一个包含四个条目的列表：1. 从 $T_1$ 数据集估计的 $\\langle \\eta \\rangle_{T^{\\star}}$（浮点数，四舍五入到6位小数）。2. 从 $T_2$ 数据集估计的 $\\langle \\eta \\rangle_{T^{\\star}}$（浮点数，四舍五入到6位小数）。3. 两个估计值之间的绝对差（浮点数，四舍五入到6位小数）。4. 一个布尔值，指示绝对差是否在给定的容差 $\\tau$ 内（即，差值 $\\le \\tau$）。\n- **最终输出格式**：一个包含列表的列表的单行，例如 `[[res1_1,res1_2,res1_3,res1_4],[res2_1,res2_2,res2_3,res2_4],...]`。\n- **测试用例**：提供了四个测试用例，包含 $T_1$、$T_2$、$T^{\\star}$、$\\tau$ 的具体值以及相应的能量和有序参数数据集。\n\n### 步骤 2：使用提取的给定信息进行验证\n1.  **科学依据**：该问题基于统计力学的基本原理（正则系综、玻尔兹曼统计）和一种标准的、广泛使用的计算技术（直方图重加权，一种重要性采样形式）。整个设置在科学上是有效的，并且是计算材料科学中的标准做法。\n2.  **适定性**：该问题是适定的。它要求实现一个特定的、明确定义的算法（单直方图重加权）来计算一个量（$\\langle \\eta \\rangle_{T^{\\star}}$），该量存在唯一的理论值（在统计不确定性范围内）。所提供的显式数据集和参数使得解是唯一可确定的。\n3.  **客观性**：问题以精确、客观的语言陈述。定义、任务和要求的输出都是明确的。\n4.  **完整性和一致性**：问题是自洽的。所有必要的信息——常数、公式、数据和输出格式——都已提供。没有内部矛盾。\n5.  **相关性**：该问题与模拟复杂材料中化学有序性的特定主题直接相关，这是蒙特卡洛方法的关键应用领域。\n\n### 步骤 3：结论与行动\n问题陈述是有效的。它在科学上是合理的，是适定的、客观的且完整的。我将继续进行求解。\n\n---\n\n## **算法与理论推导**\n\n### **1. 单直方图重加权原理**\n\n目标是使用从一个不同的原始逆温度 $\\beta_0 = 1/(k_{\\mathrm{B}} T_0)$ 下的正则系综中采样的一组微观态，来估算一个可观测量 $\\eta$ 在目标逆温度 $\\beta^{\\star} = 1/(k_{\\mathrm{B}} T^{\\star})$ 下的系综平均值。\n\n在逆温度 $\\beta^{\\star}$ 下，一个可观测量 $A$（在本例中为有序参数 $\\eta$）的正则系综平均值的正式定义是：\n$$\n\\langle A \\rangle_{\\beta^{\\star}} = \\frac{\\int A(s) \\exp(-\\beta^{\\star} E(s)) \\, ds}{\\int \\exp(-\\beta^{\\star} E(s)) \\, ds}\n$$\n其中积分遍及系统的所有可能微观态 $s$。\n\n在 $\\beta_0$ 下进行的蒙特卡洛模拟会生成一个包含 $N$ 个微观态的序列 $\\{s_1, s_2, \\ldots, s_N\\}$，这些微观态是根据玻尔兹曼概率密度 $p_{\\beta_0}(s) \\propto \\exp(-\\beta_0 E(s))$ 采样的。因此，对于任何函数 $f(s)$，积分可以近似为对采样微观态的求和：\n$$\n\\int f(s) \\exp(-\\beta_0 E(s)) \\, ds \\approx C \\sum_{i=1}^N f(s_i)\n$$\n其中 $C$ 是一个比例常数。\n\n为了计算 $\\langle A \\rangle_{\\beta^{\\star}}$，我们可以通过引入因子 $1 = \\frac{\\exp(-\\beta_0 E(s))}{\\exp(-\\beta_0 E(s))}$ 来重写积分。这种技术被称为重要性采样。\n$$\n\\langle A \\rangle_{\\beta^{\\star}} = \\frac{\\int A(s) \\exp(-(\\beta^{\\star} - \\beta_0) E(s)) \\exp(-\\beta_0 E(s)) \\, ds}{\\int \\exp(-(\\beta^{\\star} - \\beta_0) E(s)) \\exp(-\\beta_0 E(s)) \\, ds}\n$$\n项 $\\exp(-\\beta_0 E(s)) \\, ds$ 对应于采样态 $\\{s_i\\}$ 所依据的概率测度。因此，我们可以使用可用的蒙特卡洛样本 $\\{s_i\\}$ 及其对应的能量 $\\{E_i\\}$ 和可观测量值 $\\{A_i=\\eta_i\\}$ 来近似积分。表达式变为：\n$$\n\\langle A \\rangle_{\\beta^{\\star}} \\approx \\frac{\\sum_{i=1}^N A_i \\exp(-(\\beta^{\\star} - \\beta_0) E_i)}{\\sum_{i=1}^N \\exp(-(\\beta^{\\star} - \\beta_0) E_i)}\n$$\n这是单直方图重加权的基本公式。它允许通过对每个样本 $i$ 用因子 $\\exp(-(\\beta^{\\star} - \\beta_0) E_i)$ 进行重加权，来估算在非模拟运行温度下的系综平均值。\n\n### **2. 数值稳定的实现**\n\n直接计算重加权公式中的指数项可能导致数值不稳定。如果指数 $-(\\beta^{\\star} - \\beta_0) E_i$ 是一个大的正数，$\\exp(-(\\beta^{\\star} - \\beta_0) E_i)$ 可能会超过可表示的最大浮点数值（上溢）。如果指数是一个大幅值的负数，结果可能变为零（下溢），导致精度损失。\n\n为确保数值稳定性，我们可以利用最终表达式是一个比率这一事实。设样本 $i$ 的未归一化重加权项为 $w'_i = \\exp(-(\\beta^{\\star} - \\beta_0) E_i)$。我们可以在分子和分母上同乘以一个任意常数 $K$ 而不改变结果：\n$$\n\\langle A \\rangle_{\\beta^{\\star}} \\approx \\frac{\\sum_{i=1}^N A_i (K w'_i)}{\\sum_{i=1}^N (K w'_i)}\n$$\n对 $K$ 的明智选择可以防止数值问题。设 $x_i = -(\\beta^{\\star} - \\beta_0) E_i$ 为指数的参数。我们找到所有指数中的最大值 $x_{\\max} = \\max_i\\{x_i\\}$。然后我们选择 $K = \\exp(-x_{\\max})$。重新缩放后的权重变为：\n$$\nw_i = K w'_i = \\exp(-x_{\\max}) \\exp(x_i) = \\exp(x_i - x_{\\max})\n$$\n根据构造，这个新指数的参数 $(x_i - x_{\\max})$ 总是小于或等于零。\n- $w_i$ 的最大值是 $\\exp(0) = 1$，这防止了任何上溢的可能性。\n- 对于远小于 $x_{\\max}$ 的指数 $x_i$，权重 $w_i$ 可能会下溢为零。这是可以接受的，因为这些状态对重加权和的贡献本来就可以忽略不计。\n\n因此，数值稳定的重加权公式为：\n$$\n\\langle A \\rangle_{\\beta^{\\star}} \\approx \\frac{\\sum_{i=1}^N A_i \\exp(x_i - x_{\\max})}{\\sum_{i=1}^N \\exp(x_i - x_{\\max})} \\quad \\text{其中} \\quad x_i = -(\\beta^{\\star} - \\beta_0) E_i \\quad \\text{且} \\quad x_{\\max} = \\max_i\\{x_i\\}\n$$\n\n### **3. 算法大纲**\n\n对于每个测试用例，执行以下过程：\n1.  定义玻尔兹曼常数 $k_{\\mathrm{B}} = 8.617333262145 \\times 10^{-5}$ eV/K。\n2.  定义一个函数 `reweight(T_0, E_data, eta_data, T_star)`，该函数实现上述的数值稳定计算。\n    a. 在函数内部，计算 $\\beta_0 = 1/(k_{\\mathrm{B}} T_0)$ 和 $\\beta^{\\star} = 1/(k_{\\mathrm{B}} T^{\\star})$。\n    b. 计算指数向量 $x_i = -(\\beta^{\\star} - \\beta_0) E_i$。\n    c. 找到最大指数 $x_{\\max}$。\n    d. 计算稳定权重 $w_i = \\exp(x_i - x_{\\max})$。\n    e. 返回加权平均值 $\\sum_i (\\eta_i w_i) / \\sum_i w_i$。\n3.  对于每个测试用例，调用 `reweight` 函数两次：\n    a. 获取估计值 1 ($\\eta^{\\star}_1$)：`reweight(T_1, E_1_data, eta_1_data, T_star)`。\n    b. 获取估计值 2 ($\\eta^{\\star}_2$)：`reweight(T_2, E_2_data, eta_2_data, T_star)`。\n4.  计算绝对差：$\\Delta\\eta = |\\eta^{\\star}_1 - \\eta^{\\star}_2|$。\n5.  通过检查 $\\Delta\\eta \\le \\tau$ 来确定一致性。\n6.  为当前测试用例存储四个结果（$\\eta^{\\star}_1$、$\\eta^{\\star}_2$、$\\Delta\\eta$ 和布尔一致性检查）。\n7.  处理完所有测试用例后，按照问题陈述的规定，将收集到的结果格式化为单个字符串，确保所有浮点数都四舍五入到六位小数。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n    # Boltzmann constant in eV/K\n    k_B = 8.617333262145e-5\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"T1\": 900, \"T2\": 1100, \"T_star\": 1000, \"tau\": 0.1,\n            \"E1\": [-3.25, -3.10, -3.05, -2.95, -3.40, -2.80, -3.00, -3.30, -2.90, -3.15],\n            \"eta1\": [0.83, 0.70, 0.66, 0.58, 0.95, 0.45, 0.62, 0.87, 0.53, 0.74],\n            \"E2\": [-3.05, -2.95, -2.85, -2.75, -3.10, -2.90, -2.80, -3.00, -2.70, -2.88],\n            \"eta2\": [0.66, 0.58, 0.49, 0.41, 0.70, 0.53, 0.45, 0.62, 0.37, 0.52]\n        },\n        {\n            \"T1\": 1000, \"T2\": 1005, \"T_star\": 1002.5, \"tau\": 0.01,\n            \"E1\": [-3.02, -3.01, -2.99, -3.00, -3.03, -2.98, -2.97, -3.04],\n            \"eta1\": [0.63, 0.62, 0.61, 0.62, 0.64, 0.60, 0.59, 0.65],\n            \"E2\": [-3.01, -3.00, -2.99, -2.98, -3.02, -2.97, -3.03, -2.96],\n            \"eta2\": [0.62, 0.62, 0.61, 0.60, 0.63, 0.59, 0.64, 0.58]\n        },\n        {\n            \"T1\": 600, \"T2\": 800, \"T_star\": 700, \"tau\": 0.1,\n            \"E1\": [-3.60, -3.50, -3.40, -3.70, -3.20, -3.30, -3.55, -3.45],\n            \"eta1\": [0.93, 0.88, 0.83, 0.96, 0.73, 0.78, 0.91, 0.86],\n            \"E2\": [-3.30, -3.20, -3.10, -3.00, -3.40, -3.25, -3.15, -2.95],\n            \"eta2\": [0.78, 0.73, 0.68, 0.63, 0.83, 0.75, 0.70, 0.60]\n        },\n        {\n            \"T1\": 300, \"T2\": 900, \"T_star\": 600, \"tau\": 0.02,\n            \"E1\": [-4.50, -4.40, -4.60, -4.70, -4.30, -4.20, -4.55, -4.35],\n            \"eta1\": [0.98, 0.96, 0.99, 1.00, 0.94, 0.92, 0.99, 0.95],\n            \"E2\": [-3.10, -3.00, -2.90, -2.80, -3.20, -2.95, -2.85, -2.75],\n            \"eta2\": [0.68, 0.63, 0.58, 0.53, 0.73, 0.60, 0.55, 0.50]\n        }\n    ]\n\n    def reweight(T_0, E_data, eta_data, T_star, k_B_val):\n        \"\"\"\n        Calculates the reweighted average of an observable using a numerically stable method.\n\n        Args:\n            T_0 (float): The temperature at which the data was sampled.\n            E_data (list): List of energy values from the MC simulation.\n            eta_data (list): List of observable values from the MC simulation.\n            T_star (float): The target temperature for reweighting.\n            k_B_val (float): The Boltzmann constant.\n\n        Returns:\n            float: The estimated average of the observable at T_star.\n        \"\"\"\n        E_arr = np.array(E_data)\n        eta_arr = np.array(eta_data)\n\n        beta_0 = 1.0 / (k_B_val * T_0)\n        beta_star = 1.0 / (k_B_val * T_star)\n        delta_beta = beta_star - beta_0\n\n        exponents = -delta_beta * E_arr\n        \n        # Numerical stabilization by shifting exponents\n        max_exponent = np.max(exponents)\n        weights = np.exp(exponents - max_exponent)\n\n        reweighted_avg = np.sum(eta_arr * weights) / np.sum(weights)\n        return reweighted_avg\n\n    all_results = []\n    for case in test_cases:\n        T1, E1, eta1 = case[\"T1\"], case[\"E1\"], case[\"eta1\"]\n        T2, E2, eta2 = case[\"T2\"], case[\"E2\"], case[\"eta2\"]\n        T_star, tau = case[\"T_star\"], case[\"tau\"]\n\n        # Estimate from dataset 1\n        eta_star_1 = reweight(T1, E1, eta1, T_star, k_B)\n\n        # Estimate from dataset 2\n        eta_star_2 = reweight(T2, E2, eta2, T_star, k_B)\n\n        # Compute difference and check consistency\n        diff = abs(eta_star_1 - eta_star_2)\n        is_consistent = diff = tau\n\n        result_list = [eta_star_1, eta_star_2, diff, is_consistent]\n        all_results.append(result_list)\n\n    # Format the final output string\n    formatted_results = []\n    for res in all_results:\n        # Format: float, float, float, boolean\n        # .6f handles rounding for printing.\n        part_str = f\"[{res[0]:.6f},{res[1]:.6f},{res[2]:.6f},{str(res[3])}]\"\n        formatted_results.append(part_str)\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}