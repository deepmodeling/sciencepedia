## 引言
功能展开计数（Functional Expansion Tallies, FETs）是蒙特卡罗[粒子输运模拟](@entry_id:753220)中的一种高级计数技术，旨在以连续的[解析函数](@entry_id:139584)形式精确重构空间、能量、角度或时间相关的物理量。与传统的、基于离散网格的[直方图](@entry_id:178776)计数方法相比，FET通过提供平滑的函数表示，极大地提升了物理场描述的保真度和灵活性，并使其能够直接用于后续的分析计算，例如求导或耦合。然而，有效利用这一强大工具需要深入理解其背后的数学原理和统计机制。本文旨在系统性地解决这一知识需求，为读者构建一个关于FET的完整知识体系。

本文将分为三个核心部分，引导读者逐步精通FET。在“原理与机制”一章中，我们将奠定该方法的数学基础，从[函数空间](@entry_id:143478)投影理论出发，探讨基函数的选择、展开的收敛性，并推导蒙特卡罗估计量的形式及其统计特性。随后，在“应用与跨学科联系”一章中，我们将展示FET在解决实际[反应堆物理](@entry_id:158170)问题中的威力，包括处理复杂几何与[材料界面](@entry_id:751731)、计算导数与边界量，并将其置于多物理场耦合和更广阔的计算科学（如计算化学、天体物理学）的背景中进行审视。最后，“动手实践”部分将提供一系列精心设计的问题，帮助读者将理论知识转化为解决具体问题的实践能力。

## 原理与机制

本章旨在阐述功能展开计数（Functional Expansion Tallies, FETs）背后的基本原理和核心机制。我们将从数学基础出发，系统地探讨如何将一个连续的物理场表示为一组基函数的[级数展开](@entry_id:142878)，并分析该展开的收敛性与精度。随后，我们将这些理论概念与蒙特卡罗[粒子输运模拟](@entry_id:753220)的具体实践相结合，推导不同类型的计数估计量，并深入研究这些估计量的统计特性，包括它们的[无偏性](@entry_id:902438)、相合性、方差及协方差。

### 函数展开原理：将场投影到基函数上

功能展开计数的核心思想是，将一个定义在物理域 $D$ 上的[连续函数](@entry_id:137361)（例如，中子标通量 $f(\mathbf{r})$）表示为一组预先选择的**基函数**（basis functions）$\{\phi_n(\mathbf{r})\}_{n=0}^\infty$ 的线性组合。这个过程在数学上被严谨地描述为在一个[函数空间](@entry_id:143478)中进行**投影**（projection）。

为建立这一框架，我们引入**希尔伯特空间**（Hilbert space）的概念，具体来说是加权 $L^2$ 空间 $L^2_w(D)$。该空间由所有在域 $D$ 上满足 $\int_D |f(\mathbf{r})|^2 w(\mathbf{r}) dV  \infty$ 的函数构成，其中 $w(\mathbf{r})$ 是一个已知的、[几乎处处](@entry_id:146631)为正的**权函数**（weight function）。这个空间配备了一个**[内积](@entry_id:750660)**（inner product），定义为：
$$
\langle g, h \rangle_w = \int_D g(\mathbf{r}) h(\mathbf{r}) w(\mathbf{r}) dV
$$
以及一个由该[内积](@entry_id:750660)诱导的**范数**（norm）：
$$
\| g \|_{2,w} = \sqrt{\langle g, g \rangle_w}
$$
在这个框架下，函数 $f(\mathbf{r})$ 的近似展开 $P_N f = \sum_{n=0}^{N} a_n \phi_n(\mathbf{r})$ 的系数 $\{a_n\}$ 可以通过两种等价的方式确定 。第一种是**最小二乘法**（least-squares approach），其目标是寻找一组系数 $\{a_n\}$，使得近似解与真实解之间的残差 $r_N = f - P_N f$ 的范数最小化，即最小化 $\|f - \sum_{n=0}^{N} a_n \phi_n\|_{2,w}^2$。第二种是**伽辽金法**（Galerkin approach），它要求残差 $r_N$ 与展开所用的基函数（在此作为[检验函数](@entry_id:166589)）正交。即，对于所有 $m \in \{0, \dots, N\}$，满足 $\langle f - \sum_{n=0}^{N} a_n \phi_n, \phi_m \rangle_w = 0$。在连续的[函数空间](@entry_id:143478)中，这两种方法会导出完全相同的[线性方程组](@entry_id:148943)来求解系数 $\{a_n\}$，这个方程组被称为**法方程**（normal equations）。

当基函数集合 $\{\phi_n\}$ 是**标准正交**（orthonormal）的，即满足 $\langle \phi_m, \phi_n \rangle_w = \delta_{mn}$（其中 $\delta_{mn}$ 是克罗内克符号），求解过程将得到极大的简化。在这种情况下，法方程退化，每个系数都可以独立地通过简单的[内积](@entry_id:750660)运算直接求得：
$$
a_n = \langle f, \phi_n \rangle_w = \int_D f(\mathbf{r}) \phi_n(\mathbf{r}) w(\mathbf{r}) dV
$$
这正是傅里叶级数系数的标准形式。因此，功能展开计数本质上就是计算待求物理场在所选[标准正交基](@entry_id:147779)上的**[傅里叶系数](@entry_id:144886)**。

将 FET 与其他计数方法进行比较，可以更清晰地理解其特点 。传统的**网格计数**（mesh tally）通过在空间划分的每个单元（或称[体元](@entry_id:267802)）$V_k$ 内计算平均值 $\bar{f}_k$ 来近似场，这相当于将场投影到一组分片常数的基函数上。而**点探测器计数**（point-detector tally）则旨在估计场在单个点 $\mathbf{r}_0$ 的值 $f(\mathbf{r}_0)$，它提供的是高度局部化的信息，而不产生全局的函数表示。与之不同，FET 的目标是计算一组**展开系数** $\{a_n\}$，这些系数共同描述了函数在整个域 $D$ 上的全局行为。

### 展开的收敛性与精度

一个自然而重要的问题是：在什么条件下，由 FET 得到的截断级数 $S_N(\mathbf{r}) = \sum_{n=0}^{N} a_n \phi_n(\mathbf{r})$ 能够随着展开项数 $N$ 的增加而收敛到真实的函数 $f(\mathbf{r})$？

答案取决于基函数的性质。对于一个给定的希尔伯特空间 $L^2_w(D)$，一个[标准正交基](@entry_id:147779) $\{\phi_n\}$ 要能表示空间中的任意函数，它必须是**完备的**（complete）。完备性意味着该空间中唯一与所有基函数 $\phi_n$ 都正交的函数是零函数。对于一个标准正交且完备的基，任何属于该空间的函数 $f$ 的傅里叶级数都会在 $L^2_w$ 范数意义下收敛到 $f$ 本身，即 $\|f - S_N\|_{2,w} \to 0$ 当 $N \to \infty$ 。因此，选择一个相对于所研究问题域和权函数是完备的基函数系，是保证 FET 理论上收敛的先决条件。

展开的**收敛速度**（rate of convergence）则与被展开函数 $f(\mathbf{r})$ 的**光滑性**（smoothness）密切相关 。

*   如果函数 $f(\mathbf{r})$ 在其定义域上是**解析的**（analytic），即可以进行[泰勒展开](@entry_id:145057)，那么其在光滑[正交多项式](@entry_id:146918)基（如勒让德或[切比雪夫多项式](@entry_id:145074)）下的展开系数将会以**几何速率**（或称指数速率）衰减，例如 $|a_n| \sim O(\rho^{-n})$，其中 $\rho  1$。这种快速收敛被称为**谱精度**（spectral accuracy），意味着仅用相对较少的基函数就能达到非常高的近似精度。

*   然而，如果函数 $f(\mathbf{r})$ 存在**不光滑**的特征，例如在某处有**跳变间断**（jump discontinuity），那么展开系数的衰减速度将显著减慢，变为**代数速率**，例如 $|a_n| \sim O(n^{-1})$。这种[收敛速度](@entry_id:636873)要慢得多。

更重要的是，当使用全局光滑基函数（如多项式）来近似一个具有间断的函数时，会在[间断点](@entry_id:144108)附近产生一种被称为**[吉布斯现象](@entry_id:138701)**（Gibbs phenomenon）的振荡伪影。截断级数 $S_N(\mathbf{r})$ 会在间断点两侧出现“过冲”和“下冲”，即使增加展开项数 $N$，这些[过冲](@entry_id:147201)的幅度也不会减小，只是振荡的范围向间断点收缩。这对于需要精确捕捉界面效应的[反应堆物理](@entry_id:158170)计算来说是一个严峻的挑战  。

### 实际应用：界面问题与基函数的选择

在核反应堆中，不同材料（如燃料、慢化剂、吸收体）的交界处形成了**材料界面**（material interface）。虽然中子标通量 $\phi(x)$ 在这些界面上通常是连续的，但许多重要的物理量，如反应率密度 $r(x) = \Sigma_a(x)\phi(x)$（其中 $\Sigma_a(x)$ 是宏观吸收截面），由于材料性质的突变（$\Sigma_a(x)$ 的跳变）而呈现出间断性 。

这就直接导致了上一节讨论的收敛性问题。如果采用一组在整个反应堆区域上定义的**[全局基函数](@entry_id:749917)**（global-basis）进行 FET，比如在整个一维平板上使用[勒让德多项式](@entry_id:141510)，那么在材料界面处，重构出的反应率就会不可避免地出现[吉布斯振荡](@entry_id:749902)，并且收敛速度缓慢。

为解决这一问题，一种更先进的策略是采用**多区域 FET**（multi-region FET）。其核心思想是，沿着材料界面将物理域划分为多个子区域。在每个子区域内部，物理性质是光滑的，因此可以在每个子区域内独立地使用一套基函数进行展开。例如，在由两种材料构成的平板中，可以在 $[-a, 0)$ 和 $(0, a]$ 两个区间上分别使用两套独立的勒让德多项式展开。通过这种方式，间断被自然地处理为子区域的边界，避免了在区域内部产生[吉布斯现象](@entry_id:138701)，并能在每个光滑的子区域内实现快速的[谱收敛](@entry_id:142546) 。

选择合适的基函数是成功实施 FET 的关键。基函数的选择必须与问题的几何形状、坐标系以及[内积](@entry_id:750660)定义中的权函数 $w(\mathbf{r})$ 相匹配，以确保正交性。

*   对于一维区间 $[-1, 1]$，**[勒让德多项式](@entry_id:141510)**（Legendre polynomials）$P_n(x)$ 关于权函数 $w(x)=1$ 和物理微元 $dV=dx$ 是正交的。**[第一类切比雪夫多项式](@entry_id:185845)**（Chebyshev polynomials）$T_n(x)$ 则是关于权函数 $w(x)=(1-x^2)^{-1/2}$ 和 $dV=dx$ 正交 。

*   对于二维[单位圆盘](@entry_id:172324)，**[泽尼克多项式](@entry_id:163902)**（Zernike polynomials）$Z_n^m(\rho, \theta)$ 是一个常用的选择。它们在极坐标下，关于权函数 $w(\rho, \theta)=1$ 和物理面积微元 $dV=\rho d\rho d\theta$ 是正交的 。

*   对于三维可分离坐标系，基函数通常由一维基函数的[张量积](@entry_id:140694)构成。选择的依据是确保基函数与该坐标系的**雅可比行列式**（Jacobian）所引入的权重正交 。
    *   **[笛卡尔坐标系](@entry_id:169789)** $(x, y, z)$：体积微元 $dV=dxdydz$，[雅可比因子](@entry_id:186289)为1。适合使用[勒让德多项式](@entry_id:141510)在三个方向上的[张量积](@entry_id:140694)。
    *   **[圆柱坐标系](@entry_id:266798)** $(r, \varphi, z)$：体积微元 $dV=rdrd\varphi dz$，[雅可比因子](@entry_id:186289)为 $r$。[方位角](@entry_id:164011)方向使用[傅里叶级数](@entry_id:139455) $e^{im\varphi}$，轴向使用勒让德多项式，而径向则需使用关于权函数 $w(r)=r$ 正交的**贝塞尔函数**（Bessel functions）$J_m(k r)$。
    *   **[球坐标系](@entry_id:167517)** $(r, \theta, \varphi)$：体积微元 $dV=r^2\sin\theta drd\theta d\varphi$，[雅可比因子](@entry_id:186289)为 $r^2\sin\theta$。角向部分使用关于 $\sin\theta$ 权函数正交的**球谐函数**（Spherical Harmonics）$Y_{lm}(\theta, \varphi)$，而径向则需使用关于权函数 $w(r)=r^2$ 正交的**[球贝塞尔函数](@entry_id:153247)**（spherical Bessel functions）$j_l(k r)$。

### 蒙特卡罗估计机制

到目前为止，我们讨论的都是确定性的函数展开。在蒙特卡罗模拟中，我们无法直接计算积分形式的系数 $a_n = \int_D f(\mathbf{r}) \phi_n(\mathbf{r}) w(\mathbf{r}) dV$，因为真实的标通量 $f(\mathbf{r})$ 是未知的。我们能做的，是通过模拟大量粒子径迹来**估计**这些系数。

我们可以从第一性原理出发，推导出一个**[无偏估计量](@entry_id:756290)**（unbiased estimator）。以**[径迹长度估计量](@entry_id:1133281)**（track-length estimator）为例，其核心物理原理是：标通量 $f(\mathbf{r})$ 的物理意义是在 $\mathbf{r}$ 点处单位体积内粒子径迹长度的期望密度 。将这个期望关系代入系数的积分定义中，并通过[交换积分](@entry_id:177036)与期望的顺序，可以得到单个粒子历史（history）$i$ 对系数 $a_n$ 的贡献（即**分数**，score）：
$$
\hat{I}_{n,i} = \sum_{k=1}^{K_i} \int_{\text{track } ik} W_{ik} \phi_n(\mathbf{r}) w(\mathbf{r}) ds
$$
其中，求和遍历了该粒子历史中的所有径迹段 $k$，$W_{ik}$ 是粒子在该径迹段上的[统计权重](@entry_id:186394)，积分则沿着粒子飞行的直线路径进行。对 $N$ 个独立粒子历史得到的分数取平均，再除以[归一化常数](@entry_id:752675) $\langle\phi_n, \phi_n\rangle_w$，就构成了对系数 $a_n$ 的[无偏估计](@entry_id:756289)。

除了[径迹长度估计量](@entry_id:1133281)，还有其他几种常见的估计机制 ：

*   **径迹长度 FET 估计量**：如上所述，对每次飞跃（free-flight）事件，累加粒子权重 $W$ 乘以基函数 $\phi_n$ 沿着径迹的积分。对于一个以单位源粒子归一化的体积展开系数 $a_m = \int_V \phi(\mathbf{r}) B_m(\mathbf{r}) dV$，其单位为长度（例如 cm）。

*   **碰撞 FET 估计量**（collision estimator）：利用关系式 $\phi(\mathbf{r}) = C(\mathbf{r})/\Sigma_t(\mathbf{r})$，其中 $C(\mathbf{r})$ 是碰撞率密度，$\Sigma_t$ 是总[宏观截面](@entry_id:1127564)。在每次位于 $V$ 内的碰撞点 $\mathbf{r}_c$，累加分数值 $W \cdot B_m(\mathbf{r}_c) / \Sigma_t(\mathbf{r}_c)$。其单位同样是长度。

*   **流 FET 估计量**（current estimator）：用于估计表面上的物理量，如表面流系数 $c_m = \int_S J(\mathbf{r}) \tilde{B}_m(\mathbf{r}) dS$。在每次穿越表面 $S$ 的事件中，在穿越点 $\mathbf{r}_s$ 累加分数值 $W \cdot \tilde{B}_m(\mathbf{r}_s) \cdot (\mathbf{\Omega}\cdot\mathbf{n})$，其中 $\mathbf{\Omega}$ 是粒子方向，$\mathbf{n}$ 是表面法向。这种系数是无量纲的。

### FET 估计量的统计特性

对 FET 估计量的统计特性进行分析，对于理解和应用该方法至关重要。

首先是**[无偏性](@entry_id:902438)**（unbiasedness）与**相合性**（consistency）的区别 。一个估计量 $\hat{a}_n$ 是无偏的，意味着对于任意有限的粒子历史数 $H$，其[期望值](@entry_id:150961)都等于[真值](@entry_id:636547)，即 $\mathbb{E}[\hat{a}_n] = a_n$。我们构造的蒙特卡罗分数平均值正是这样一个[无偏估计量](@entry_id:756290)。相合性则是一个[渐近性质](@entry_id:177569)，指当粒子历史数 $H \to \infty$ 时，估计量在概率上收敛于真值，即 $\hat{a}_n \xrightarrow{p} a_n$。对于一个方差有限的[无偏估计量](@entry_id:756290)，[大数定律](@entry_id:140915)保证了其相合性。

其次是估计量的**方差**（variance）与**协方差**（covariance） 。对于由 $H$ 个[独立同分布](@entry_id:169067)的粒子历史计算的[系数估计](@entry_id:175952)量 $\hat{a}_n$，其方差满足：
$$
\mathrm{Var}[\hat{a}_n] = \frac{\mathrm{Var}[X_n]}{H}
$$
其中 $X_n$ 是单个历史的分数。这表明，与其他蒙特卡罗方法一样，FET 估计量的统计不确定度（标准差）随着粒子历史数的平方根递减，即 $\sigma(\hat{a}_n) \propto 1/\sqrt{H}$ 。

FET 的一个关键统计特征是，不同系数的估计量 $\hat{a}_m$ 和 $\hat{a}_n$ 通常是**相关的**（correlated）。这是因为它们都是从同一组粒子历史中计算得到的。对于同一个粒子历史，其径迹对系数 $a_m$ 的分数贡献 $X_{m,h}$ 和对系数 $a_n$ 的分数贡献 $X_{n,h}$ 都是该径迹的函数，因此它们通常不是独立的。这种历史内的相关性导致了最终估计量之间的协方差不为零：
$$
\mathrm{Cov}(\hat{a}_m, \hat{a}_n) = \frac{\mathrm{Cov}(X_m, X_n)}{H}
$$
这意味着，当从估计的系数重构物理场并进行[不确定度传播](@entry_id:146574)时，必须考虑这个完整的协方差矩阵，而不能简单地认为各个系数的[统计误差](@entry_id:755391)是独立的  。

最后，我们必须认识到 FET 的误差包含两个来源 。第一个是**[截断误差](@entry_id:140949)**（truncation error），源于我们使用有限项 $N$ 的级数来近似一个[无穷级数](@entry_id:143366)，其大小由 $\|f - S_N\|_{2,w}$ 衡量。第二个是**[统计误差](@entry_id:755391)**（statistical error），源于我们用有限的粒子历史数 $H$ 来估计真实的系数，其大小由 $\|S_N - \hat{S}_N\|_{2,w}$ 衡量。要获得精确的物理场重构，必须同时控制这两种误差，即选择足够大的展开阶数 $N$ 以减小[截断误差](@entry_id:140949)，并运行足够多的粒子历史 $H$ 以减小统计误差。