{
    "hands_on_practices": [
        {
            "introduction": "在粒子输运模拟中，最核心的任务之一是确定粒子沿其飞行路径的下一个事件。在均匀介质中，这简化为一个基本的竞争：粒子是在介质内部发生碰撞，还是先到达几何边界。本练习  要求您推导粒子在不发生碰撞的情况下到达边界的概率，这是理解和实现蒙特卡罗输运算法的基石。",
            "id": "4247018",
            "problem": "在一个单一均匀材料区域内，一个中性粒子在蒙特卡罗（MC）中子输运模拟中被追踪。在该区域内，宏观总截面处处恒定，等于 $\\Sigma_{t}$（单位为逆长度）。考虑沿粒子直线飞行方向测量的一维路径坐标 $s \\geq 0$。沿 $s$ 的碰撞过程被建模为泊松点过程，其速率为每单位长度 $\\Sigma_{t}$，因此在任何长度为 $s$ 的区间内的碰撞次数是一个均值为 $\\Sigma_{t} s$ 的泊松随机变量。粒子从一个内部点出发，其沿飞行方向到最近材料边界的已知直线距离记为 $d_{\\text{surf}}  0$。沿该射线遇到的第一个事件必须是在材料中发生碰撞或穿过边界。\n\n从泊松过程模型及其对首次碰撞自由程长度分布的推论出发，推导第一个事件是穿过边界而非碰撞的条件概率。该概率需表示为仅含 $\\Sigma_{t}$ 和 $d_{\\text{surf}}$ 的单一闭式解析表达式。最终结果只用 $\\Sigma_{t}$ 和 $d_{\\text{surf}}$ 表示。无需数值近似，最终表达式中不应包含任何单位。",
            "solution": "问题陈述经评估在科学上是合理的、适定的，并包含了获得唯一且有意义解所需的所有信息。它代表了中性粒子输运理论和蒙特卡罗模拟方法中的一个基本概念。\n\n问题的核心在于确定两个互斥事件中哪一个先发生的概率：是粒子-介质相互作用（碰撞），还是粒子穿过材料边界。粒子在碰撞前行进的距离是一个随机变量，而沿其飞行路径到边界的距离是一个固定的已知值。\n\n设 $S$ 为随机变量，表示粒子从其起点到首次碰撞所行进的路径长度。问题陈述指出，碰撞过程是一个泊松点过程，其速率为每单位长度 $\\Sigma_{t}$。该模型的一个直接且基本的推论是，到第一个事件（碰撞）的距离 $S$ 是一个服从指数分布的随机变量。\n\n对于在宏观总截面为 $\\Sigma_{t}$ 的均匀介质中行进的粒子，其首次碰撞距离 $S$ 的概率密度函数 (PDF)，记为 $f_S(s)$，由下式给出：\n$$f_S(s) = \\Sigma_{t} \\exp(-\\Sigma_{t} s), \\quad \\text{for } s \\geq 0$$\n该函数描述了在特定路径长度 $s$ 处发生碰撞的概率密度。\n\n为了求粒子行进一定距离而*不*发生碰撞的概率，我们需要生存函数，它是累积分布函数 (CDF) 的补函数。CDF，$F_S(s) = P(S \\leq s)$，是在距离 $s$ 或之前发生碰撞的概率。它通过将 PDF 从 $0$ 积分到 $s$ 来计算：\n$$F_S(s) = \\int_{0}^{s} f_S(s') ds' = \\int_{0}^{s} \\Sigma_{t} \\exp(-\\Sigma_{t} s') ds'$$\n计算该积分得到：\n$$F_S(s) = [-\\exp(-\\Sigma_{t} s')]_{0}^{s} = -\\exp(-\\Sigma_{t} s) - (-\\exp(0)) = 1 - \\exp(-\\Sigma_{t} s)$$\n\n生存函数 $R(s) = P(S  s)$ 给出了粒子在其首次碰撞前行进距离大于 $s$ 的概率。它的计算方法如下：\n$$R(s) = P(S  s) = 1 - F_S(s) = 1 - (1 - \\exp(-\\Sigma_{t} s)) = \\exp(-\\Sigma_{t} s)$$\n\n问题为粒子指定了两种可能的“第一事件”：\n1. 在材料内部发生碰撞。\n2. 穿过材料区域的边界。\n\n沿粒子飞行方向到最近边界的距离是一个确定值 $d_{\\text{surf}}$。\n\n当且仅当随机确定的首次碰撞路径长度 $S$ 大于到边界的固定距离 $d_{\\text{surf}}$ 时，穿过边界才会是第一个事件。因此，第一个事件是穿过边界的概率，等价于粒子在行进距离 $d_{\\text{surf}}$ 内未发生碰撞而存活的概率。\n\n我们要求解 $P(\\text{第一个事件是穿过边界})$。这可以表示为：\n$$P(\\text{第一个事件是穿过边界}) = P(S  d_{\\text{surf}})$$\n使用上面推导出的生存函数 $R(s)$，我们可以通过令 $s = d_{\\text{surf}}$ 来计算此概率：\n$$P(S  d_{\\text{surf}}) = R(d_{\\text{surf}}) = \\exp(-\\Sigma_{t} d_{\\text{surf}})$$\n\n这个表达式表示在给定粒子的起始位置、方向和材料属性的情况下，粒子到达边界的条件概率。它是蒙特卡罗程序中粒子追踪算法的基石。该算法通常从分布 $f_S(s)$ 中抽取一个路径长度 $s$，并将其与 $d_{\\text{surf}}$ 进行比较。如果 $s  d_{\\text{surf}}$，粒子就被移动到边界；否则，它就被移动到距离为 $s$ 的碰撞位置。前一种情况发生的概率就是我们已经推导出的结果。",
            "answer": "$$\\boxed{\\exp(-\\Sigma_{t} d_{\\text{surf}})}$$"
        },
        {
            "introduction": "真实的反应堆具有复杂的非均匀性，这要求我们将路径长度抽样方法从简单的均匀介质推广到更普遍的情况。本练习  探讨了当材料属性随空间位置变化时，如何对粒子路径长度进行抽样。您需要设计一个稳健的数值算法来求解路径长度，因为简单的解析解已不再适用，这是高级模拟程序开发中的一个核心挑战。",
            "id": "4246978",
            "problem": "在一个非均匀核反应堆堆芯内的蒙特卡罗（MC）中子输运模拟中，考虑一个位于位置 $\\boldsymbol{r}_0 \\in \\mathbb{R}^3$、方向为 $\\boldsymbol{\\Omega}$ 的粒子，在总宏观截面为 $\\Sigma_t(\\boldsymbol{r}) \\ge 0$ 的介质中行进。沿长度为 $s \\ge 0$ 的直线路径的光学厚度由以下线积分定义：\n$$\n\\tau(s) \\equiv \\int_{0}^{s} \\Sigma_t\\big(\\boldsymbol{r}_0 + s' \\boldsymbol{\\Omega}\\big)\\, \\mathrm{d}s' .\n$$\n自由程长度通过抽取一个均匀随机数 $\\xi \\sim \\mathcal{U}(0,1)$ 并求解方程\n$$\n\\tau(s) \\;=\\; -\\ln \\xi\n$$\n来抽样。\n假设几何结构由不重叠的凸多面体区域（例如，轴对齐的长方体或一般的凸多面体）组成，并且在每个区域内，函数 $\\Sigma_t(\\boldsymbol{r})$ 是可测且局部有界的，沿任何直射线的有限线段都具有明确定义的线积分。射线穿过一系列区域，将路径划分为连续的、具有有限长度的线段，这些线段终止于材料界面或计算域的边界。\n\n请你选择一个算法描述，该描述最正确、最稳健地规定了一个求解 $\\tau(s) = -\\ln \\xi$ 的数值求根方案，并且该方案：\n- 仅使用沿 $\\boldsymbol{\\Omega}$ 的、由几何派生的线段边界来为未知数 $s$ 构建一个有效的括号区间，并且\n- 以足够的精度计算沿射线段所需的 $\\Sigma_t$ 线积分，\n- 并且采用一种求根方法，其收敛性由 $\\tau(s)$ 的单调性保证。\n\n以下哪个选项最正确且最稳健？\n\nA. 从一个任意的初始猜测值 $s^{(0)}0$ 开始，对 $f(s) \\equiv \\tau(s) + \\ln \\xi = 0$ 应用纯牛顿迭代法，使用导数 $f'(s)=\\dfrac{\\mathrm{d}\\Sigma_t(\\boldsymbol{r}_0 + s\\boldsymbol{\\Omega})}{\\mathrm{d}s}$。不强制任何括号区间。如果牛顿步长超出了当前材料区域，接受该步长并继续；由于导数使用了 $\\Sigma_t$ 的梯度，即使跨越不连续点，收敛也很快。\n\nB. 从 $\\boldsymbol{r}_0$ 沿 $\\boldsymbol{\\Omega}$ 执行确定性射线追踪，以产生由 $j$ 索引的连续线段，每个线段长度为 $\\ell_j0$，由几何界面界定。对每个线段，通过一种对于 $\\Sigma_t$ 的局部变化足够精确的求积法（例如，如果 $\\Sigma_t$ 在段内变化，则使用自适应高斯求积；如果 $\\Sigma_t$ 是常数，则进行精确计算）来评估线段光学深度\n$$\nI_j \\;\\equiv\\; \\int_{0}^{\\ell_j} \\Sigma_t\\big(\\boldsymbol{r}_j^{\\text{start}} + s' \\boldsymbol{\\Omega}\\big)\\,\\mathrm{d}s'\n$$\n累加部分和 $\\tau_k \\equiv \\sum_{j=1}^{k} I_j$，直到找到第一个满足 $\\tau_{k^\\star-1} \\le -\\ln \\xi \\le \\tau_{k^\\star}$ 的索引 $k^\\star$（约定 $\\tau_0 \\equiv 0$）。这将根括在第 $k^\\star$ 段的起点和终点之间，即 $s_L \\equiv \\sum_{j=1}^{k^\\star-1} \\ell_j$ 和 $s_U \\equiv \\sum_{j=1}^{k^\\star} \\ell_j$。然后，通过找到以下方程的根，求解从第 $k^\\star$ 段起点开始的局部剩余距离 $\\delta \\in [0,\\ell_{k^\\star}]$：\n$$\ng(\\delta) \\;\\equiv\\; \\int_{0}^{\\delta} \\Sigma_t\\big(\\boldsymbol{r}_{k^\\star}^{\\text{start}} + s' \\boldsymbol{\\Omega}\\big)\\,\\mathrm{d}s' \\;-\\; \\big((- \\ln \\xi) - \\tau_{k^\\star-1}\\big) \\;=\\; 0 ,\n$$\n使用一种带保护的牛顿法：在第 $n$ 次迭代时，计算牛顿法提议的步长\n$$\n\\delta_{\\text{N}}^{(n+1)} \\;=\\; \\delta^{(n)} - \\frac{g(\\delta^{(n)})}{\\Sigma_t\\big(\\boldsymbol{r}_{k^\\star}^{\\text{start}} + \\delta^{(n)} \\boldsymbol{\\Omega}\\big)} ,\n$$\n并且仅当它位于 $[0,\\ell_{k^\\star}]$ 区间内并减小 $|g|$ 时才接受它；否则，对当前 $\\delta$ 的括号区间执行一步二分法。当 $|g(\\delta)| \\le \\varepsilon_\\tau$ 或当括号区间宽度 $\\le \\varepsilon_s$ 时终止，其中 $\\varepsilon_\\tau0$ 和 $\\varepsilon_s0$ 是用户公差。最终路径长度是 $s^\\star = s_L + \\delta$。\n\nC. 不使用几何信息，预先估计沿射线的全局界限 $\\Sigma_{\\min}$ 和 $\\Sigma_{\\max}$，并通过 $s_L \\equiv (-\\ln \\xi)/\\Sigma_{\\max}$ 和 $s_U \\equiv (-\\ln \\xi)/\\Sigma_{\\min}$ 来界定括号区间。在 $[s_L,s_U]$ 上，使用二分法求解 $f(s) \\equiv \\tau(s) + \\ln \\xi = 0$，其中每次 $f(s)$ 求值都使用固定分区的梯形法则，其子区间数量是预先确定的，与 $\\Sigma_t$ 的局部变化无关。\n\nD. 完全用抽样主函数自由程 $s' \\equiv (-\\ln \\xi)/\\Sigma_{\\text{maj}}$ 来代替求根，其中全局主函数 $\\Sigma_{\\text{maj}} \\ge \\Sigma_t(\\boldsymbol{r})$ 在所有地方都成立，然后以概率 $\\Sigma_t(\\boldsymbol{r}_0 + s'\\boldsymbol{\\Omega})/\\Sigma_{\\text{maj}}$ 接受在 $s'$ 处的碰撞，否则重复（delta-tracking）。这避免了括号区间和积分计算，同时仍能抽取正确的路径长度，因此这是在非均匀几何中求解 $\\tau(s) = -\\ln \\xi$ 的最稳健方法。\n\n选择唯一最佳选项。",
            "solution": "题目要求找到最正确和最稳健的数值算法，用于在非均匀介质的蒙特卡罗模拟中，从方程 $\\tau(s) = -\\ln \\xi$ 求解粒子自由程长度 $s$，其中 $\\tau(s)$ 是光学厚度。该算法必须满足三个特定标准：\n1.  使用由几何派生的线段边界来为 $s$ 构建一个括号区间。\n2.  准确地计算总宏观截面 $\\Sigma_t(\\boldsymbol{r})$ 的线积分。\n3.  使用一种保证收敛的求根方法。\n\n需要求解的方程是 $f(s) = \\tau(s) + \\ln \\xi = 0$，其中光学厚度由下式给出\n$$\n\\tau(s) = \\int_{0}^{s} \\Sigma_t\\big(\\boldsymbol{r}_0 + s' \\boldsymbol{\\Omega}\\big)\\, \\mathrm{d}s'\n$$\n随机变量 $\\xi$ 从均匀分布 $\\mathcal{U}(0,1)$ 中抽取，因此 $-\\ln \\xi$ 是一个正实数。函数 $\\tau(s)$ 具有非负导数 $\\tau'(s) = \\Sigma_t(\\boldsymbol{r}_0 + s \\boldsymbol{\\Omega}) \\ge 0$，这意味着 $\\tau(s)$ 是 $s$ 的一个非减函数。这种单调性是确保唯一根存在（假设粒子路径在完美真空中的长度不是无限的）并允许使用稳健求根算法的关键属性。\n\n现在，我们根据问题的要求评估每个选项。\n\nA. **从一个任意的初始猜测值 $s^{(0)}0$ 开始，对 $f(s) \\equiv \\tau(s) + \\ln \\xi = 0$ 应用纯牛顿迭代法，使用导数 $f'(s)=\\dfrac{\\mathrm{d}\\Sigma_t(\\boldsymbol{r}_0 + s\\boldsymbol{\\Omega})}{\\mathrm{d}s}$。不强制任何括号区间。如果牛顿步长超出了当前材料区域，接受该步长并继续；由于导数使用了 $\\Sigma_t$ 的梯度，即使跨越不连续点，收敛也很快。**\n\n该选项存在几个根本性缺陷。\n- **错误的导数**：根据微积分基本定理，$f(s) = \\tau(s) + \\ln \\xi$ 关于 $s$ 的导数是 $f'(s) = \\tau'(s) = \\Sigma_t(\\boldsymbol{r}_0 + s \\boldsymbol{\\Omega})$。该选项错误地陈述导数为 $\\dfrac{\\mathrm{d}\\Sigma_t(\\boldsymbol{r}_0 + s\\boldsymbol{\\Omega})}{\\mathrm{d}s}$。这应该是 $\\tau(s)$ 的二阶导数。\n- **缺乏稳健性**：纯牛顿法，没有保护或括号区间，不是全局收敛的。宏观截面 $\\Sigma_t(\\boldsymbol{r})$ 在材料界面上是不连续的。这些不连续点意味着导数 $f'(s)$ 本身也是不连续的。在此类不连续点上应用牛顿法是不稳定的，可能导致发散、振荡或走向非物理（负）的路径长度。断言在不连续点上收敛很快是错误的；这恰恰是该方法最可能失败的地方。\n- **未能满足标准**：该算法不使用几何来形成括号区间（标准1），其收敛性也无法保证（标准3）。盲目接受跨越材料边界的步长的过程是导致灾难性失败的根源。\n\n因此，选项A是**错误的**。\n\nB. **执行确定性射线追踪……累加部分和……将根括在括号内……求解局部剩余距离……使用一种带保护的牛顿法……**\n\n该选项描述了一个复杂的多阶段算法，直接解决了问题的复杂性。\n1.  **射线追踪和括号区间构建**：该算法首先通过几何模型确定性地追踪粒子的路径射线 $\\boldsymbol{r}_0 + s \\boldsymbol{\\Omega}$。这会识别出一系列由 $j$ 索引的路径线段，每个线段长度为 $\\ell_j$。这是现代蒙特卡罗程序中的标准流程。\n2.  **括号区间识别**：然后计算每个线段的光学深度 $I_j$，并将其累加为部分和 $\\tau_k = \\sum_{j=1}^{k} I_j$。通过检查条件 $\\tau_{k^\\star-1} \\le -\\ln \\xi \\le \\tau_{k^\\star}$（约定 $\\tau_0 \\equiv 0$），它识别出碰撞必须发生的特定线段 $k^\\star$。这稳健地为总路径长度 $s$ 建立了一个紧凑的括号区间，即 $s \\in [\\sum_{j=1}^{k^\\star-1} \\ell_j, \\sum_{j=1}^{k^\\star} \\ell_j]$。这完美地满足了标准1。\n3.  **局部求根问题**：问题随后被重构为在该线段 $k^\\star$ 内寻找剩余距离 $\\delta$。方程变为在 $\\delta \\in [0, \\ell_{k^\\star}]$ 内求解 $g(\\delta) = 0$，其中 $g(\\delta) = \\int_{0}^{\\delta} \\Sigma_t\\big(\\boldsymbol{r}_{k^\\star}^{\\text{start}} + s' \\boldsymbol{\\Omega}\\big)\\,\\mathrm{d}s' - C$，而 $C = (-\\ln \\xi) - \\tau_{k^\\star-1}$ 是待行进的剩余光学深度。\n4.  **积分精度**：该选项正确地指明，线段积分 $I_j$ 应通过适合 $\\Sigma_t$ 局部行为的方法来评估，例如，如果它变化则使用自适应求积，如果它恒定则使用直接解析计算。这满足了标准2。\n5.  **稳健的求根方法**：为了求解 $\\delta$，它提出了一种带保护的牛顿法。牛顿迭代使用正确的导数 $g'(\\delta) = \\Sigma_t(\\boldsymbol{r}_{k^\\star}^{\\text{start}} + \\delta \\boldsymbol{\\Omega})$。“保护”措施——如果牛顿步长无效或超出了已知括号区间 $[0, \\ell_{k^\\star}]$，则退回到二分法步长——将牛顿法的快速局部收敛性与二分法的保证收敛性结合起来。由于函数 $g(\\delta)$ 在括号区间内是单调的，收敛性得到了保证。这满足了标准3。\n\n该算法是一个全面、正确且稳健的解决方案，代表了该领域的最佳实践。\n\n因此，选项B是**正确的**。\n\nC. **不使用几何信息，预先估计沿射线的全局界限 $\\Sigma_{\\min}$ 和 $\\Sigma_{\\max}$，并通过 $s_L \\equiv (-\\ln \\xi)/\\Sigma_{\\max}$ 和 $s_U \\equiv (-\\ln \\xi)/\\Sigma_{\\min}$ 来界定括号区间。在 $[s_L,s_U]$ 上，使用二分法求解 $f(s) \\equiv \\tau(s) + \\ln \\xi = 0$，其中每次 $f(s)$ 求值都使用固定分区的梯形法则……**\n\n这个选项在数值上是幼稚且不切实际的。\n- **括号区间构建**：括号区间由不等式 $\\Sigma_{\\min} s \\le \\tau(s) \\le \\Sigma_{\\max} s$ 导出。虽然在数学上是合理的，但在没有任何形式的射线追踪的情况下，为复杂几何找到紧凑的全局界限 $\\Sigma_{\\min}$ 和 $\\Sigma_{\\max}$ 通常是不可能的，或者会导致非常宽松的界限（例如，如果可能存在空隙，则 $\\Sigma_{\\min} \\approx 0$），使得上界 $s_U$ 过大，方法效率低下。这种方法明确地未能满足要求几何派生线段边界的标准1。\n- **积分方法**：对于一个分段定义且可能在材料界面有巨大跳跃的函数 $\\Sigma_t(\\boldsymbol{r}(s))$，使用“固定分区的梯形法则，其子区间数量是预先确定的”是一个糟糕的选择。除非使用极其大量的子区间，否则这种方法的精度会非常低，从而使其效率极低。这未能满足要求足够精度的标准2。\n- **求根方法**：虽然二分法保证收敛（满足标准3），但其效率在很大程度上取决于初始括号区间的质量和函数求值的成本。在该提议的方案中，这两者都很差。\n\n因此，选项C是**错误的**。\n\nD. **完全用抽样主函数自由程 $s' \\equiv (-\\ln \\xi)/\\Sigma_{\\text{maj}}$ 来代替求根，其中全局主函数 $\\Sigma_{\\text{maj}} \\ge \\Sigma_t(\\boldsymbol{r})$ 在所有地方都成立，然后以概率 $\\Sigma_t(\\boldsymbol{r}_0 + s'\\boldsymbol{\\Omega})/\\Sigma_{\\text{maj}}$ 接受在 $s'$ 处的碰撞，否则重复（delta-tracking）。这避免了括号区间和积分计算，同时仍能抽取正确的路径长度，因此这是在非均匀几何中求解 $\\tau(s) = -\\ln \\xi$ 的最稳健方法。**\n\n这个选项描述了 delta-tracking（或 Woodcock/主函数核）方法。这是一种在复杂几何中抽样路径长度的有效且通常高效的算法。然而，它是通过求根来求解方程 $\\tau(s) = -\\ln \\xi$ 的一种*替代*方法。问题明确要求一个“用于求解 $\\tau(s) = -\\ln \\xi$ 的数值求根方案”，该方案遵循与括号区间构建和积分相关的特定约束。delta-tracking 方法是一种接受-拒绝技术，它巧妙地绕过了计算积分 $\\tau(s)$ 和求解所得方程根的需要。它不构建括号区间，不计算 $\\Sigma_t$ 的积分，也不采用问题陈述意图下的求根器。因此，尽管它是一种有效的输运算法，但它不是对关于如何通过求根实现直接反演方法所提问题的回答。\n\n因此，作为对所提问题的回答，选项D是**错误的**。\n\n总之，选项B是唯一描述了正确、稳健且高效的数值求根方案的选项，该方案满足了问题陈述中指定的所有标准。",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "理论公式在计算机上的实现必须仔细考虑有限精度算术带来的影响。本练习  将我们带回到基本的指数抽样公式，但关注于一个关键的软件工程问题：数值稳健性。您将分析当随机数趋于极端值时该公式为何会失效，并评估确保代码稳定且能产生物理上合理结果的策略。",
            "id": "4247024",
            "problem": "在均匀区域中进行连续能量蒙特卡罗（MC）中子输运模拟时，若总宏观截面为 $\\Sigma_t$，自由程距离的采样方法是：使用一个在区间 $(0,1)$ 内的均匀伪随机数，对其进行自然对数变换，再乘以 $1/\\Sigma_t$ 进行缩放。这种采样方法源于碰撞的泊松过程模型，该模型意味着自由程呈指数分布。考虑在电气和电子工程师协会（IEEE）754 双精度浮点算术下实现，其中最小的正非规格化数约为 $2^{-1074}$，接近 $1$ 处的单位舍入误差约为 $2^{-52}$。当均匀随机数 $\\xi$ 极其接近 $0$ 或 $1$ 时，可能会出现数值问题，包括但不限于返回 $s=0$ 或 $s=\\infty$、在计算接近 $1$ 的对数时发生灾难性抵消、极长的自由程因可表示范围限制而被截断，以及对极小或极大的 $\\Sigma_t$ 值敏感。\n\n假设模拟可能遇到小至 $10^{-8}\\,\\mathrm{cm}^{-1}$ 或大至 $10^{2}\\,\\mathrm{cm}^{-1}$ 的 $\\Sigma_t$。请选择以下所有策略，以确保在 IEEE 754 双精度算术中，当 $\\xi$ 极其接近 $0$ 或 $1$ 时，能够对指数自由程分布进行数值上稳健且无偏的采样，同时防止出现病态情况。\n\nA. 将均匀随机数 $\\xi$ 限制在闭区间 $[\\varepsilon,1-\\varepsilon]$ 内，其中 $\\varepsilon=2^{-52}$（双精度下接近 $1$ 的单位舍入误差），然后计算对数。这避免了无穷大和 $0$ 距离，且不会给分布带来偏差。\n\nB. 通过在随机数生成器（RNG）返回 $\\xi\\in\\{0,1\\}$ 时重新采样来保证 $\\xi\\in(0,1)$；此外，使用 $\\operatorname{nextafter}$ 函数将数值上等于 $0$ 或 $1$ 的值映射到最接近的可表示的内部值；并使用 $\\operatorname{log1p}$ 通过一个数学上等价的变换来计算对数，例如，计算 $-\\operatorname{log1p}(-\\xi)$ 并乘以 $1/\\Sigma_t$ 进行缩放。\n\nC. 用一阶泰勒近似替换对数：对于接近 $1$ 的 $\\xi$，设置 $s=(1-\\xi)/\\Sigma_t$；对于接近 $0$ 的 $\\xi$，设置 $s=\\xi/\\Sigma_t$，并在这些区间之间切换以避免极端值。\n\nD. 在确保 $\\xi\\in(0,1)$ 的前提下（使用一个能产生严格在 $(0,1)$ 内部的均匀随机数的 53 位整数到双精度的映射），在扩展精度（例如 long double）下计算对数和缩放；然后将结果转换为 double 以供后续使用。\n\nE. 通过将采样值 $s$ 替换为 $\\min(s,L)$，以系统尺寸 $L$ 来限制自由程，从而避免当 $\\xi$ 极其小时出现过大的 $s$；这在物理上是合理的，因为粒子在碰撞前会离开该区域。\n\n选择所有适用项。",
            "solution": "该问题要求识别出用于采样中子自由程距离 $s$ 的数值上稳健且无偏的策略。采样基于指数概率密度函数 $p(s) = \\Sigma_t e^{-\\Sigma_t s}$（$s \\ge 0$），其中 $\\Sigma_t$ 是总宏观截面。\n\n从该分布中采样的标准方法是逆变换采样法。累积分布函数（CDF）为 $F(s) = \\int_0^s \\Sigma_t e^{-\\Sigma_t s'} ds' = 1 - e^{-\\Sigma_t s}$。我们将 CDF 等于一个均匀随机数 $\\xi \\sim U(0,1)$：\n$$ \\xi = 1 - e^{-\\Sigma_t s} $$\n解出 $s$：\n$$ 1 - \\xi = e^{-\\Sigma_t s} $$\n$$ \\ln(1 - \\xi) = -\\Sigma_t s $$\n$$ s = -\\frac{\\ln(1 - \\xi)}{\\Sigma_t} $$\n因为如果 $\\xi$ 是 $(0,1)$ 上的均匀随机数，那么 $1-\\xi$ 也是 $(0,1)$ 上的均匀随机数，所以采样公式通常写为：\n$$ s = -\\frac{\\ln(\\xi)}{\\Sigma_t} $$\n这是问题陈述中隐含的公式。任务是评估各种策略，以便使用 IEEE 754 双精度算术稳健且无偏地计算此公式。\n\n主要的数值挑战出现在 $\\xi \\in (0,1)$ 定义域的极端处：\n1.  当 $\\xi \\to 0^+$ 时，$\\ln(\\xi) \\to -\\infty$，因此 $s \\to +\\infty$。如果伪随机数生成器（RNG）返回 $\\xi=0$，将导致无限长的路径。最小可表示正数限制了最大路径长度。对于 `double` 类型，最小的正非规格化数是 $d_{min} \\approx 2^{-1074}$，因此最大路径长度约为 $s_{max} \\approx -\\frac{\\ln(2^{-1074})}{\\Sigma_t} = \\frac{1074 \\ln(2)}{\\Sigma_t} \\approx \\frac{744.4}{\\Sigma_t}$。\n2.  当 $\\xi \\to 1^-$ 时，$\\ln(\\xi) \\to 0^-$，因此 $s \\to 0^+$。如果 $\\xi$ 非常接近 $1$，例如 $\\xi = 1-\\delta$ 且 $\\delta  2^{-53}$，则 $\\xi$ 的浮点表示可能恰好为 $1$。这导致 $\\ln(\\xi)$ 的计算结果为 $0$，从而产生物理上不正确的路径长度 $s=0$。这个问题是一种灾难性抵消。\n\n一个有效的策略必须解决这些问题，同时不引入系统性误差（偏差）到采样中。\n\n### 逐项分析\n\n**A. 将均匀随机数 $\\xi$ 限制在闭区间 $[\\varepsilon,1-\\varepsilon]$ 内，其中 $\\varepsilon=2^{-52}$（双精度下接近 $1$ 的单位舍入误差），然后计算对数。这避免了无穷大和 $0$ 距离，且不会给分布带来偏差。**\n\n该策略提议在随机数 $\\xi$ 落入区间 $[\\varepsilon, 1-\\varepsilon]$ 之外时对其进行修改。\n- 通过强制 $\\xi \\ge \\varepsilon = 2^{-52}$，我们人为地将最大路径长度限制为 $s_{max} = -\\frac{\\ln(2^{-52})}{\\Sigma_t} = \\frac{52 \\ln(2)}{\\Sigma_t}$。所有本应比这更长的路径都被截断了。这消除了分布尾部的一部分，特别是那些本应由 $(0, \\varepsilon)$ 内的 $\\xi$ 产生的样本。发生这种情况的概率是 $\\varepsilon$。\n- 通过强制 $\\xi \\le 1-\\varepsilon$，我们人为地设置了一个最小的非零路径长度 $s_{min} = -\\frac{\\ln(1-2^{-52})}{\\Sigma_t} \\approx \\frac{2^{-52}}{\\Sigma_t}$。这消除了所有比该值更短的路径长度。\n通过截断其定义域来改变目标分布的采样值会引入系统性误差，根据定义，这就是偏差。声称这“不会给分布带来偏差”是不正确的。\n\n**结论：不正确**\n\n**B. 通过在随机数生成器（RNG）返回 $\\xi\\in\\{0,1\\}$ 时重新采样来保证 $\\xi\\in(0,1)$；此外，使用 $\\operatorname{nextafter}$ 函数将数值上等于 $0$ 或 $1$ 的值映射到最接近的可表示的内部值；并使用 $\\operatorname{log1p}$ 通过一个数学上等价的变换来计算对数，例如，计算 $-\\operatorname{log1p}(-\\xi)$ 并乘以 $1/\\Sigma_t$ 进行缩放。**\n\n这个选项提出了一个复合策略。\n1.  **保证 $\\xi\\in(0,1)$**：如果 $\\xi=0$ 或 $\\xi=1$，进行重新采样是一种完全有效且无偏的方法，可以确保随机数位于所期望的开区间内。使用 `nextafter` 的替代建议是一种实用方法，它会引入极小的偏差，但在计算上高效且稳健；在许多情况下，这是一种可接受的权衡。关键在于系统地处理了端点。\n2.  **使用 `log1p`**：`log1p(x)` 函数被设计用于在 $|x|$ 很小时精确计算 $\\ln(1+x)$。该提议是按 $s = \\frac{-\\operatorname{log1p}(-\\xi)}{\\Sigma_t} = \\frac{-\\ln(1-\\xi)}{\\Sigma_t}$ 计算路径长度。如前所述，这是用于对指数分布进行采样的统计学上等价的公式。其数值优势是显著的：\n    - 对于短路径长度，$\\xi$ 接近 $0$。`log1p` 的参数是 $-\\xi$，这个值很小。这正是 `log1p` 能提供高精度，避免困扰 $\\ln(1-\\xi)$ 直接计算的抵消问题的区间。\n    - 对于长路径长度，$\\xi$ 接近 $1$。设 $\\xi = 1-\\delta$，其中 $\\delta$ 很小。公式变为 $s = \\frac{-\\ln(\\delta)}{\\Sigma_t}$，这是数值稳定的。\n“数学上等价的变换”一词是在统计意义上使用的——$s = -\\ln(\\xi)/\\Sigma_t$ 和 $s = -\\ln(1-\\xi)/\\Sigma_t$ 都从相同的指数分布中产生样本。这是数值蒙特卡罗方法中一种标准且强烈推荐的技术。\n\n**结论：正确**\n\n**C. 用一阶泰勒近似替换对数：对于接近 $1$ 的 $\\xi$，设置 $s=(1-\\xi)/\\Sigma_t$；对于接近 $0$ 的 $\\xi$，设置 $s=\\xi/\\Sigma_t$，并在这些区间之间切换以避免极端值。**\n\n这提议使用近似。\n- 对于接近 $1$ 的 $\\xi$，设 $\\xi=1-\\delta$。精确公式为 $s = -\\frac{\\ln(1-\\delta)}{\\Sigma_t}$。$\\ln(1-\\delta)$ 的泰勒级数是 $-\\delta - \\frac{\\delta^2}{2} - \\dots$。提议的近似 $s \\approx \\frac{\\delta}{\\Sigma_t} = \\frac{1-\\xi}{\\Sigma_t}$ 只使用了一阶项。这会引入系统性误差（偏差），因为它忽略了所有高阶项。采样的路径长度将系统性地小于精确值。\n- 对于接近 $0$ 的 $\\xi$，提议为 $s=\\xi/\\Sigma_t$。这似乎是替代公式 $s = -\\frac{\\ln(1-\\xi)}{\\Sigma_t} \\approx \\frac{\\xi}{\\Sigma_t}$ 的一阶近似。\n在任何一种情况下，使用泰勒近似，根据定义，就是一种近似。它不会从原分布中产生精确样本，而是从一个近似分布中产生。由于目标是“无偏采样”，并且存在像选项 B 这样的精确方法，这是一个较差且有偏的策略。\n\n**结论：不正确**\n\n**D. 在确保 $\\xi\\in(0,1)$ 的前提下（使用一个能产生严格在 $(0,1)$ 内部的均匀随机数的 53 位整数到双精度的映射），在扩展精度（例如 long double）下计算对数和缩放；然后将结果转换为 double 以供后续使用。**\n\n这个选项描述了另一种同样有效的实现数值稳健性的方法。\n1.  **高质量 RNG**：通过映射一个 53 位整数来生成随机数 $\\xi$，使得 $\\xi \\in (0,1)$（例如 $\\xi = (I+0.5)/2^{53}$），这是高质量 RNG 的标准技术。它内在地避免了端点 $0$ 和 $1$，从而防止了 $\\ln(0)$ 并极大地缓解了接近 $1$ 时的抵消问题，因为最接近 $1$ 的值将是 $1 - 0.5/2^{53} = 1 - 2^{-54}$。\n2.  **扩展精度**：使用扩展精度（例如，通常使用 80 位的 `long double`）执行关键计算 $s = -\\frac{\\ln(\\xi)}{\\Sigma_t}$，可以提供更多的有效位数和更宽的指数范围。这减少了对数求值和最终缩放中的舍入误差，从而产生更准确的结果。\n3.  **转换为 double**：最终结果被转换回标准的 `double` 精度，以供模拟的其余部分使用。这是一个标准程序。中间使用更高精度可确保最终的 `double` 结果尽可能接近真实的数学值（即，它是正确舍入的）。\n这整个策略通过提高精度和使用稳健的 RNG 来直接解决数值误差问题。这是实现稳健、偏差最小的采样的有效方法。\n\n**结论：正确**\n\n**E. 通过将采样值 $s$ 替换为 $\\min(s,L)$，以系统尺寸 $L$ 来限制自由程，从而避免当 $\\xi$ 极其小时出现过大的 $s$；这在物理上是合理的，因为粒子在碰撞前会离开该区域。**\n\n这个选项混淆了蒙特卡罗模拟的两个不同步骤：（1）从物理分布中采样路径长度和（2）在几何模型中输运粒子。\n- 采样步骤必须从碰撞距离的真实、无偏的概率分布中抽样，即指数分布 $p(s) = \\Sigma_t e^{-\\Sigma_t s}$。这个分布有一个无限的尾部。\n- 输运步骤获取这个采样距离 $s$，并将其与到最近边界的距离 $d_b$ 进行比较。然后粒子被移动 $\\min(s, d_b)$ 的距离。\n该提议是通过将采样值 $s$ 替换为 $\\min(s,L)$ 来修改采样器本身。这从根本上改变了被采样的分布。新的分布不再是指数分布。例如，采样值的平均值将严格小于真实的平均自由程 $1/\\Sigma_t$。这在物理自由程分布的采样中引入了显著的偏差。虽然处理边界穿越至关重要，但它与在无限介质中对路径长度分布进行采样是两个独立的逻辑步骤。\n\n**结论：不正确**",
            "answer": "$$\\boxed{BD}$$"
        }
    ]
}