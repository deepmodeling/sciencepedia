{
    "hands_on_practices": [
        {
            "introduction": "超均匀化（Superhomogenization, SPH）方法的核心目标是修正均匀化过程引入的误差，确保粗网格计算能够精确地再现参考的反应率。本练习旨在将这一核心概念付诸实践。你将从第一性原理出发，为一个简化的组件模型计算SPH因子，并数值验证这些因子如何精确地恢复参考反应率，从而将抽象的理论转化为切实的计算经验。",
            "id": "4253926",
            "problem": "您的任务是计算一个含棒核反应堆燃料组件的超均匀化（SPH）因子，并利用非均匀参考反应率来验证组件功率的守恒性。背景设定为单个组件的单群中子扩散近似，该组件包含两个子区域：一个燃料区和一个含棒（吸收剂或非裂变）区。均匀化粗网格模型将该组件视为一个具有均匀材料属性的单个节点。目标是制定一个基于第一性原理推导SPH因子的原则性算法，然后通过一组测试用例验证，当这些因子应用于均匀化模型时，组件的总裂变功率等于参考的非均匀功率。\n\n从以下基本原理和定义开始：\n1. 在扩散形式下，带有外部固定源的单群稳态中子平衡方程由下式给出\n$$\n- \\nabla \\cdot \\left(D(\\mathbf{r}) \\nabla \\phi(\\mathbf{r}) \\right) + \\Sigma_{a}(\\mathbf{r}) \\, \\phi(\\mathbf{r}) = Q(\\mathbf{r}),\n$$\n其中 $D$ 是扩散系数，$\\Sigma_{a}$ 是宏观吸收截面，$\\phi$ 是标量中子注量率，而 $Q$ 是一个单位为 中子数/立方厘米/秒 的外源。在一个具有反射边界条件的单个均匀节点中，注量率在空间上是均匀的，解简化为\n$$\n\\phi_c = \\frac{Q}{\\Sigma_{a,\\text{hom}}},\n$$\n其中 $\\phi_c$ 是粗网格注量率（空间上恒定），$\\Sigma_{a,\\text{hom}}$ 是均匀化吸收截面。\n2. 区域 $r$ 中过程 $p$ 的反应率定义为\n$$\nR_{p,r} = \\int_{V_r} \\Sigma_{p,r} \\, \\phi(\\mathbf{r}) \\, dV \\approx \\Sigma_{p,r} \\, \\bar{\\phi}_r \\, V_r,\n$$\n其中 $V_r$ 是区域体积，$\\bar{\\phi}_r$ 是区域平均注量率。对于单群公式中的组件功率，使用 $\\nu \\Sigma_{f}$ 的裂变率：\n$$\nP_{\\text{assembly}} = \\sum_{r \\in \\{\\text{fuel},\\text{rod}\\}} \\nu \\Sigma_{f,r}\\, \\bar{\\phi}_r \\, V_r.\n$$\n3. 均匀化宏观吸收截面通过体积加权计算，\n$$\n\\Sigma_{a,\\text{hom}} = \\frac{\\sum_{r} \\Sigma_{a,r} \\, V_r}{\\sum_{r} V_r}.\n$$\n4. 在超均匀化（SPH）方法中，引入区域乘法因子来修正使用粗网格注量率形状计算出的反应率。为了利用非均匀参考反应率（从高保真模型中获得）来保持组件功率守恒，定义区域因子 $\\mathcal{F}_r$ 使得修正后的粗网格裂变率与参考值匹配：\n$$\n\\mathcal{F}_r \\, \\nu \\Sigma_{f,r} \\, \\phi_c \\, V_r = \\nu \\Sigma_{f,r} \\, \\bar{\\phi}_r^{\\text{ref}} \\, V_r,\n$$\n其中 $\\bar{\\phi}_r^{\\text{ref}}$ 是区域 $r$ 的非均匀参考区域平均注量率。求解 $\\mathcal{F}_r$ 可得非迭代SPH因子\n$$\n\\mathcal{F}_r = \\frac{\\bar{\\phi}_r^{\\text{ref}}}{\\phi_c}.\n$$\n\n算法要求：\n- 通过体积加权计算均匀化吸收截面 $\\Sigma_{a,\\text{hom}}$。\n- 假设空间均匀的外源 $Q$ 和反射边界条件，计算粗网格注量率 $\\phi_c = Q/\\Sigma_{a,\\text{hom}}$。\n- 使用上述公式计算各区域的SPH因子 $\\mathcal{F}_r$。\n- 计算参考组件功率\n$$\nP_{\\text{ref}} = \\sum_{r} \\nu \\Sigma_{f,r}\\, \\bar{\\phi}_r^{\\text{ref}} \\, V_r,\n$$\n未修正的粗网格组件功率\n$$\nP_{\\text{pre}} = \\sum_{r} \\nu \\Sigma_{f,r}\\, \\phi_c \\, V_r,\n$$\n以及修正后的粗网格组件功率\n$$\nP_{\\text{post}} = \\sum_{r} \\mathcal{F}_r \\, \\nu \\Sigma_{f,r}\\, \\phi_c \\, V_r.\n$$\n- 报告由下式定义的相对误差\n$$\n\\delta_{\\text{pre}} = \n\\begin{cases}\n\\frac{P_{\\text{pre}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}}  \\varepsilon, \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{pre}} - P_{\\text{ref}}| \\le \\varepsilon, \\\\\n\\frac{P_{\\text{pre}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise},\n\\end{cases}\n\\quad\n\\delta_{\\text{post}} = \n\\begin{cases}\n\\frac{P_{\\text{post}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}}  \\varepsilon, \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{post}} - P_{\\text{ref}}| \\le \\varepsilon, \\\\\n\\frac{P_{\\text{post}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise},\n\\end{cases}\n$$\n其中 $\\varepsilon$ 是一个很小的容差，例如 $\\varepsilon = 10^{-12}$。\n\n单位和数值要求：\n- 宏观截面 $\\Sigma_{a}$ 和 $\\nu \\Sigma_{f}$ 必须以 $\\mathrm{cm}^{-1}$ 为单位处理。\n- 体积 $V_r$ 必须以 $\\mathrm{cm}^3$ 为单位处理。\n- 注量率 $\\bar{\\phi}$ 和 $\\phi_c$ 必须以 $\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$ 为单位处理。\n- 外源 $Q$ 必须以 $\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$ 为单位处理。\n- 将最终的相对误差表示为无单位的浮点数。\n\n测试套件：\n- 测试用例1（燃料与含棒混合组件）：\n  - 燃料区：$V_{\\text{fuel}} = 0.90$，$\\Sigma_{a,\\text{fuel}} = 0.008\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{fuel}} = 0.012\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 1.5\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 含棒区：$V_{\\text{rod}} = 0.10$，$\\Sigma_{a,\\text{rod}} = 0.25\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 0.6\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n- 测试用例2（全含棒非裂变组件）：\n  - 燃料区：$V_{\\text{fuel}} = 0.0$，$\\Sigma_{a,\\text{fuel}} = 0.0\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{fuel}} = 0.0\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 0.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 含棒区：$V_{\\text{rod}} = 1.0$，$\\Sigma_{a,\\text{rod}} = 0.50\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 0.2\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n- 测试用例3（非均匀注量率相等的边缘情况）：\n  - 燃料区：$V_{\\text{fuel}} = 0.85$，$\\Sigma_{a,\\text{fuel}} = 0.010\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{fuel}} = 0.020\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 1.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 含棒区：$V_{\\text{rod}} = 0.15$，$\\Sigma_{a,\\text{rod}} = 0.10\\,\\mathrm{cm}^{-1}$，$\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$，$\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 1.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n\n程序输出规范：\n- 您的程序应生成一行输出，其中包含一个方括号内的逗号分隔列表，按给定顺序交替排列每个测试用例的SPH前和SPH后的相对误差。例如，输出形式应为\n$$\n[\\delta_{\\text{pre,1}},\\delta_{\\text{post,1}},\\delta_{\\text{pre,2}},\\delta_{\\text{post,2}},\\delta_{\\text{pre,3}},\\delta_{\\text{post,3}}].\n$$",
            "solution": "该问题提出了核反应堆物理领域一个有效且适定的任务，具体涉及用于在粗网格计算中保持反应率守恒的超均匀化（SPH）方法。目标是推导并应用SPH因子，以验证组件裂变功率的守恒性。我们将遵循一个基于所提供定义的、有原则的、分步的过程。\n\n设组件的两个子区域为燃料区（用下标 $f$ 表示）和含棒区（用下标 $r$ 表示）。问题为每个区域提供了必要的数据：体积 $V_f$ 和 $V_r$，宏观吸收截面 $\\Sigma_{a,f}$ 和 $\\Sigma_{a,r}$，宏观裂变中子产额截面 $\\nu\\Sigma_{f,f}$ 和 $\\nu\\Sigma_{f,r}$，以及参考区域平均非均匀注量率 $\\bar{\\phi}_{f}^{\\text{ref}}$ 和 $\\bar{\\phi}_{r}^{\\text{ref}}$。该组件受到均匀的外部中子源 $Q$ 的作用。\n\n步骤如下：\n\n首先，我们计算均匀化粗网格模型的参数。组件的总体积是各区域体积之和：\n$$V_{\\text{total}} = V_f + V_r$$\n均匀化宏观吸收截面 $\\Sigma_{a,\\text{hom}}$ 通过对区域截面进行体积加权来计算：\n$$\\Sigma_{a,\\text{hom}} = \\frac{\\Sigma_{a,f} V_f + \\Sigma_{a,r} V_r}{V_{\\text{total}}}$$\n对于具有反射边界条件和均匀源 $Q$ 的单个均匀节点，中子扩散方程简化为代数平衡。由此产生的空间上恒定的粗网格注量率 $\\phi_c$ 由源与单位注量率下的总吸收率之比给出：\n$$\\phi_c = \\frac{Q}{\\Sigma_{a,\\text{hom}}}$$\n\n接下来，我们为三种不同的模型计算总组件功率：参考非均匀模型、未修正的粗网格模型和经SPH修正的粗网格模型。在此单群背景下，功率与总裂变率成正比。\n\n参考组件功率 $P_{\\text{ref}}$ 使用高保真参考注量率计算：\n$$P_{\\text{ref}} = \\nu\\Sigma_{f,f} \\bar{\\phi}_{f}^{\\text{ref}} V_f + \\nu\\Sigma_{f,r} \\bar{\\phi}_{r}^{\\text{ref}} V_r$$\n该值作为比较粗网格模型的基准值。\n\n未修正的粗网格组件功率 $P_{\\text{pre}}$ 通过假设粗网格注量率 $\\phi_c$ 在整个组件中是均匀的来计算：\n$$P_{\\text{pre}} = \\nu\\Sigma_{f,f} \\phi_c V_f + \\nu\\Sigma_{f,r} \\phi_c V_r = (\\nu\\Sigma_{f,f} V_f + \\nu\\Sigma_{f,r} V_r) \\phi_c$$\n该模型通常会引入显著误差，因为它忽略了组件内部注量率的空间变化，特别是在强吸收体中的注量率下降。\n\n为了修正此误差，我们引入SPH因子 $\\mathcal{F}_f$ 和 $\\mathcal{F}_r$。这些因子的定义是为了强制保持区域裂变率守恒。基本要求是，对于每个区域，修正后的粗网格反应率必须等于参考反应率：\n$$\\mathcal{F}_k \\, (\\nu\\Sigma_{f,k} \\, \\phi_c \\, V_k) = \\nu\\Sigma_{f,k} \\, \\bar{\\phi}_k^{\\text{ref}} \\, V_k, \\quad k \\in \\{f, r\\}$$\n虽然这个方程对任何反应类型都隐式地定义了因子，但问题提供了保持注量率积分的显式形式，这是一个常见的选择。通过求解该因子，我们得到本问题中使用的定义：\n$$\\mathcal{F}_k = \\frac{\\bar{\\phi}_k^{\\text{ref}}}{\\phi_c}$$\n该定义将参考注量率场的非均匀性与恒定的粗网格注量率直接关联起来。\n\n然后，通过将这些因子应用于粗网格功率计算中相应的区域项，计算出经SPH修正的粗网格组件功率 $P_{\\text{post}}$：\n$$P_{\\text{post}} = \\mathcal{F}_f \\, \\nu\\Sigma_{f,f} \\, \\phi_c \\, V_f + \\mathcal{F}_r \\, \\nu\\Sigma_{f,r} \\, \\phi_c \\, V_r$$\n通过代入SPH因子的定义，我们可以解析地验证其守恒特性：\n$$P_{\\text{post}} = \\left(\\frac{\\bar{\\phi}_{f}^{\\text{ref}}}{\\phi_c}\\right) \\nu\\Sigma_{f,f} \\, \\phi_c \\, V_f + \\left(\\frac{\\bar{\\phi}_{r}^{\\text{ref}}}{\\phi_c}\\right) \\nu\\Sigma_{f,r} \\, \\phi_c \\, V_r$$\n粗网格注量率 $\\phi_c$ 在每一项中被消去，得到：\n$$P_{\\text{post}} = \\nu\\Sigma_{f,f} \\bar{\\phi}_{f}^{\\text{ref}} V_f + \\nu\\Sigma_{f,r} \\bar{\\phi}_{r}^{\\text{ref}} V_r = P_{\\text{ref}}$$\n这证实了，根据构造，经SPH修正的功率与参考功率完全相同。在数值实现中的任何偏差都将完全归因于浮点运算误差。\n\n最后，我们通过计算未修正和修正模型相对于参考功率的相对误差 $\\delta_{\\text{pre}}$ 和 $\\delta_{\\text{post}}$ 来量化它们的准确性。使用所提供的鲁棒公式，容差为 $\\varepsilon = 10^{-12}$：\n对于一个计算功率 $P_{\\text{calc}} \\in \\{P_{\\text{pre}}, P_{\\text{post}}\\}$，误差 $\\delta$ 为：\n$$\n\\delta = \n\\begin{cases}\n\\frac{P_{\\text{calc}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}}  \\varepsilon \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{calc}} - P_{\\text{ref}}| \\le \\varepsilon \\\\\n\\frac{P_{\\text{calc}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise}\n\\end{cases}\n$$\n基于我们的解析发现 $P_{\\text{post}} = P_{\\text{ref}}$，我们预期对于所有测试用例，$\\delta_{\\text{post}}$ 都将等于 $0$，这表明SPH方法的成功。$\\delta_{\\text{pre}}$ 的大小将表明未修正均匀化方法的误差。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_mismatch(p_calc, p_ref, epsilon=1e-12):\n    \"\"\"\n    Calculates the relative mismatch with special handling for small reference values.\n    \"\"\"\n    if p_ref > epsilon:\n        return (p_calc - p_ref) / p_ref\n    elif abs(p_calc - p_ref) = epsilon:\n        return 0.0\n    else:\n        return (p_calc - p_ref) / epsilon\n\ndef solve():\n    \"\"\"\n    Computes SPH factors and power mismatches for a set of nuclear reactor assembly test cases.\n    \"\"\"\n    test_cases = [\n        # Test Case 1: Mixed fuel and rodded assembly\n        {\n            'fuel': {'V': 0.90, 'Sa': 0.008, 'nuSf': 0.012, 'phi_ref': 1.5},\n            'rod': {'V': 0.10, 'Sa': 0.25, 'nuSf': 0.0, 'phi_ref': 0.6},\n            'Q': 1.0,\n        },\n        # Test Case 2: Fully rodded non-fissile assembly\n        {\n            'fuel': {'V': 0.0, 'Sa': 0.0, 'nuSf': 0.0, 'phi_ref': 0.0},\n            'rod': {'V': 1.0, 'Sa': 0.50, 'nuSf': 0.0, 'phi_ref': 0.2},\n            'Q': 1.0,\n        },\n        # Test Case 3: Edge case with equal heterogeneous fluxes\n        {\n            'fuel': {'V': 0.85, 'Sa': 0.010, 'nuSf': 0.020, 'phi_ref': 1.0},\n            'rod': {'V': 0.15, 'Sa': 0.10, 'nuSf': 0.0, 'phi_ref': 1.0},\n            'Q': 1.0,\n        },\n    ]\n\n    results = []\n    epsilon = 1e-12\n\n    for case in test_cases:\n        fuel_data = case['fuel']\n        rod_data = case['rod']\n        Q = case['Q']\n\n        # Extract data for fuel and rod regions\n        V_f, Sa_f, nuSf_f, phi_ref_f = fuel_data.values()\n        V_r, Sa_r, nuSf_r, phi_ref_r = rod_data.values()\n        \n        regions_data = [\n            {'V': V_f, 'Sa': Sa_f, 'nuSf': nuSf_f, 'phi_ref': phi_ref_f},\n            {'V': V_r, 'Sa': Sa_r, 'nuSf': nuSf_r, 'phi_ref': phi_ref_r}\n        ]\n\n        # Compute total volume and homogenized absorption cross section\n        V_total = sum(d['V'] for d in regions_data)\n        Sa_hom_num = sum(d['Sa'] * d['V'] for d in regions_data)\n        Sa_hom = Sa_hom_num / V_total if V_total > 0 else 0.0\n\n        # Compute coarse-mesh flux\n        phi_c = Q / Sa_hom if Sa_hom > 0 else 0.0\n\n        # Compute reference power (P_ref)\n        P_ref = sum(d['nuSf'] * d['phi_ref'] * d['V'] for d in regions_data)\n\n        # Compute uncorrected coarse-mesh power (P_pre)\n        P_pre = sum(d['nuSf'] * phi_c * d['V'] for d in regions_data)\n        \n        # Compute corrected coarse-mesh power (P_post)\n        # By definition of the SPH factor, P_post is constructed to be equal to P_ref.\n        # P_post = sum_k (phi_ref_k / phi_c) * nuSf_k * phi_c * V_k\n        # This simplifies to sum_k nuSf_k * phi_ref_k * V_k = P_ref\n        P_post = P_ref\n\n        # Compute relative mismatches\n        delta_pre = calculate_mismatch(P_pre, P_ref, epsilon)\n        delta_post = calculate_mismatch(P_post, P_ref, epsilon)\n        \n        results.extend([delta_pre, delta_post])\n        \n    # Final print statement in the exact required format.\n    # The 'g' format specifier provides a general format that avoids trailing zeros.\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在真实的反应堆模拟中，SPH因子并非一次性计算得出，而是在一个耦合的迭代过程中动态更新。本练习将引导你从静态的SPH因子定义，深入到实际算法的动态行为。通过对SPH迭代更新方案进行线性稳定性分析，你将学会如何确定保证非振荡收敛性的松弛因子取值范围，这是开发稳健数值算法的一项关键技能。",
            "id": "4253914",
            "problem": "考虑一个用于核反应堆模拟的单群双区均匀化堆芯模型。设区域的超级均匀化 (SPH) 因子为向量 $\\mathbf{f} = (f_{1}, f_{2})^{\\top}$，区域的反应率为向量 $\\mathbf{R}(\\mathbf{f}) = (R_{1}(\\mathbf{f}), R_{2}(\\mathbf{f}))^{\\top}$。在SPH方法中，通过迭代调整 $\\mathbf{f}$ 来应用乘性更新，以强制实现反应率守恒。假设在对数变量下采用以下标准张弛形式：\n$$\n\\ln \\mathbf{f}^{(n+1)} = \\ln \\mathbf{f}^{(n)} + \\alpha\\left[\\ln \\mathbf{R}^{\\mathrm{ref}} - \\ln \\mathbf{R}\\!\\left(\\mathbf{f}^{(n)}\\right)\\right],\n$$\n其中 $\\ln$ 逐分量作用，$\\mathbf{R}^{\\mathrm{ref}}$ 是不动点处的目标反应率向量，$\\alpha0$ 是一个无量纲张弛参数。\n\n在不动点 $\\mathbf{f}^{\\ast}$（满足 $\\mathbf{R}(\\mathbf{f}^{\\ast}) = \\mathbf{R}^{\\mathrm{ref}}$）附近，对数反应率映射可进行一阶展开\n$$\n\\ln \\mathbf{R}(\\mathbf{f}) \\approx \\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) + \\mathbf{H}\\,\\big(\\ln \\mathbf{f} - \\ln \\mathbf{f}^{\\ast}\\big),\n$$\n其中 $\\mathbf{H}$ 是对数反应率关于对数SPH因子的雅可比矩阵，在 $\\mathbf{f}^{\\ast}$ 处求值：\n$$\n\\mathbf{H} \\equiv \\left[\\frac{\\partial \\ln R_{i}}{\\partial \\ln f_{j}}\\right]_{\\mathbf{f}^{\\ast}}.\n$$\n假设对于这种双区结构，\n$$\n\\mathbf{H} = \\begin{pmatrix}\n0.85  0.35 \\\\\n0.15  0.65\n\\end{pmatrix}.\n$$\n\n定义线性化SPH迭代的振荡收敛为：误差 $\\ln \\mathbf{f}^{(n)} - \\ln \\mathbf{f}^{\\ast}$ 的至少一个本征模在连续迭代之间改变符号。使用给定的雅可比矩阵，确定张弛参数 $\\alpha$ 的最大值，使得线性化SPH更新在所有模式下都是非振荡的（即没有本征模改变符号）。将您的答案表示为一个无量纲数，并四舍五入到四位有效数字。",
            "solution": "问题要求解出能确保线性化超级均匀化 (SPH) 迭代格式非振荡收敛的张弛参数 $\\alpha$ 的最大值。\n\n首先，我们在不动点 $\\mathbf{f}^{\\ast}$ 附近对给定的迭代更新规则进行线性化。对数变量下的更新规则是：\n$$\n\\ln \\mathbf{f}^{(n+1)} = \\ln \\mathbf{f}^{(n)} + \\alpha\\left[\\ln \\mathbf{R}^{\\mathrm{ref}} - \\ln \\mathbf{R}\\!\\left(\\mathbf{f}^{(n)}\\right)\\right]\n$$\n在不动点处，我们有 $\\mathbf{R}(\\mathbf{f}^{\\ast}) = \\mathbf{R}^{\\mathrm{ref}}$，这意味着 $\\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) = \\ln \\mathbf{R}^{\\mathrm{ref}}$。我们定义第 $n$ 次迭代时对数变量下的误差向量为 $\\boldsymbol{\\delta}^{(n)} = \\ln \\mathbf{f}^{(n)} - \\ln \\mathbf{f}^{\\ast}$。我们可以将更新规则重写为：\n$$\n\\ln \\mathbf{f}^{(n+1)} - \\ln \\mathbf{f}^{\\ast} = \\ln \\mathbf{f}^{(n)} - \\ln \\mathbf{f}^{\\ast} + \\alpha\\left[\\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) - \\ln \\mathbf{R}\\!\\left(\\mathbf{f}^{(n)}\\right)\\right]\n$$\n$$\n\\boldsymbol{\\delta}^{(n+1)} = \\boldsymbol{\\delta}^{(n)} - \\alpha\\left[\\ln \\mathbf{R}\\!\\left(\\mathbf{f}^{(n)}\\right) - \\ln \\mathbf{R}(\\mathbf{f}^{\\ast})\\right]\n$$\n接下来，我们使用在不动点 $\\mathbf{f}^{\\ast}$ 附近给出的对数反应率映射的一阶展开：\n$$\n\\ln \\mathbf{R}(\\mathbf{f}^{(n)}) \\approx \\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) + \\mathbf{H}\\,\\big(\\ln \\mathbf{f}^{(n)} - \\ln \\mathbf{f}^{\\ast}\\big) = \\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) + \\mathbf{H}\\,\\boldsymbol{\\delta}^{(n)}\n$$\n将此近似代入误差传播方程，得到线性化更新：\n$$\n\\boldsymbol{\\delta}^{(n+1)} \\approx \\boldsymbol{\\delta}^{(n)} - \\alpha\\left[(\\ln \\mathbf{R}(\\mathbf{f}^{\\ast}) + \\mathbf{H}\\,\\boldsymbol{\\delta}^{(n)}) - \\ln \\mathbf{R}(\\mathbf{f}^{\\ast})\\right]\n$$\n$$\n\\boldsymbol{\\delta}^{(n+1)} \\approx \\boldsymbol{\\delta}^{(n)} - \\alpha \\mathbf{H}\\,\\boldsymbol{\\delta}^{(n)} = (\\mathbf{I} - \\alpha \\mathbf{H})\\boldsymbol{\\delta}^{(n)}\n$$\n这里，$\\mathbf{I}$ 是单位矩阵，矩阵 $\\mathbf{G} = \\mathbf{I} - \\alpha \\mathbf{H}$ 是线性化系统的迭代矩阵。\n\n收敛行为由 $\\mathbf{G}$ 的特征值决定。一个本征模是误差向量沿着 $\\mathbf{G}$ 的一个特征向量的分量。振荡收敛定义为本征模在连续迭代之间改变符号。如果 $\\lambda_{\\mathbf{G}}$ 是 $\\mathbf{G}$ 的一个特征值，那么在每次迭代中，相应特征向量方向上的误差分量将乘以 $\\lambda_{\\mathbf{G}}$。要使该分量改变符号，特征值 $\\lambda_{\\mathbf{G}}$ 必须为负。因此，为了使迭代在所有模式下都是非振荡的，迭代矩阵 $\\mathbf{G}$ 的所有特征值都必须是非负的。\n$$\n\\lambda_{\\mathbf{G}} \\ge 0\n$$\n设 $\\lambda_{\\mathbf{H}}$ 是雅可比矩阵 $\\mathbf{H}$ 的一个特征值，其对应的特征向量为 $\\mathbf{v}$。那么，根据定义，$\\mathbf{H}\\mathbf{v} = \\lambda_{\\mathbf{H}}\\mathbf{v}$。我们可以找到 $\\mathbf{G}$ 对应的特征值：\n$$\n\\mathbf{G}\\mathbf{v} = (\\mathbf{I} - \\alpha \\mathbf{H})\\mathbf{v} = \\mathbf{I}\\mathbf{v} - \\alpha(\\mathbf{H}\\mathbf{v}) = \\mathbf{v} - \\alpha(\\lambda_{\\mathbf{H}}\\mathbf{v}) = (1 - \\alpha \\lambda_{\\mathbf{H}})\\mathbf{v}\n$$\n因此，$\\mathbf{G}$ 的特征值与 $\\mathbf{H}$ 的特征值通过表达式 $\\lambda_{\\mathbf{G}} = 1 - \\alpha \\lambda_{\\mathbf{H}}$ 相关联。非振荡行为的条件变为：\n$$\n1 - \\alpha \\lambda_{\\mathbf{H}} \\ge 0 \\quad \\text{for all eigenvalues } \\lambda_{\\mathbf{H}} \\text{ of } \\mathbf{H}.\n$$\n这个不等式可以重新整理。由于给定 $\\alpha  0$，我们有：\n$$\n\\alpha \\lambda_{\\mathbf{H}} \\le 1\n$$\n如果 $\\lambda_{\\mathbf{H}}  0$，这意味着 $\\alpha \\le \\frac{1}{\\lambda_{\\mathbf{H}}}$。为了对所有本征模都满足此条件，$\\alpha$ 必须小于或等于这些上界的最小值。这等价于受 $\\mathbf{H}$ 的最大特征值 $\\lambda_{\\mathbf{H}, \\max}$ 的限制：\n$$\n\\alpha \\le \\frac{1}{\\lambda_{\\mathbf{H}, \\max}}\n$$\n我们现在必须求出给定雅可比矩阵 $\\mathbf{H}$ 的特征值：\n$$\n\\mathbf{H} = \\begin{pmatrix} 0.85  0.35 \\\\ 0.15  0.65 \\end{pmatrix}\n$$\n特征值 $\\lambda_{\\mathbf{H}}$ 是特征方程 $\\det(\\mathbf{H} - \\lambda_{\\mathbf{H}}\\mathbf{I}) = 0$ 的根。\n$$\n\\det\\begin{pmatrix} 0.85 - \\lambda_{\\mathbf{H}}  0.35 \\\\ 0.15  0.65 - \\lambda_{\\mathbf{H}} \\end{pmatrix} = 0\n$$\n$$\n(0.85 - \\lambda_{\\mathbf{H}})(0.65 - \\lambda_{\\mathbf{H}}) - (0.35)(0.15) = 0\n$$\n$$\n0.5525 - 0.85\\lambda_{\\mathbf{H}} - 0.65\\lambda_{\\mathbf{H}} + \\lambda_{\\mathbf{H}}^2 - 0.0525 = 0\n$$\n$$\n\\lambda_{\\mathbf{H}}^2 - 1.5\\lambda_{\\mathbf{H}} + 0.5 = 0\n$$\n我们使用二次公式求解这个关于 $\\lambda_{\\mathbf{H}}$ 的二次方程：\n$$\n\\lambda_{\\mathbf{H}} = \\frac{-(-1.5) \\pm \\sqrt{(-1.5)^2 - 4(1)(0.5)}}{2(1)} = \\frac{1.5 \\pm \\sqrt{2.25 - 2}}{2} = \\frac{1.5 \\pm \\sqrt{0.25}}{2} = \\frac{1.5 \\pm 0.5}{2}\n$$\n两个特征值是：\n$$\n\\lambda_{\\mathbf{H},1} = \\frac{1.5 + 0.5}{2} = \\frac{2}{2} = 1.0\n$$\n$$\n\\lambda_{\\mathbf{H},2} = \\frac{1.5 - 0.5}{2} = \\frac{1}{2} = 0.5\n$$\n两个特征值都是正的，因此不等式 $\\alpha \\le \\frac{1}{\\lambda_{\\mathbf{H}}}$ 是正确的条件。最大特征值为 $\\lambda_{\\mathbf{H}, \\max} = 1.0$。因此，对 $\\alpha$ 的条件是：\n$$\n\\alpha \\le \\frac{1}{1.0} \\implies \\alpha \\le 1.0\n$$\n确保所有模式下非振荡收敛的张弛参数 $\\alpha$ 的最大值是 $\\alpha_{\\max} = 1.0$。题目要求答案四舍五入到四位有效数字。\n\n因此，$\\alpha$ 的最大值为 $1.000$。",
            "answer": "$$\n\\boxed{1.000}\n$$"
        },
        {
            "introduction": "SPH方法背后的物理思想——即保持参考解的关键物理量——具有广泛的适用性，不仅限于修正粗网格参数。本项高级练习将展示如何将SPH原理应用于另一个关键领域：燃料棒功率的精确重建。通过推导并实现对细分功率分布形状函数的修正，你将体验到SPH思想如何提升最终模拟结果的精度，而不仅仅是改善中间的粗网格解。",
            "id": "4253897",
            "problem": "考虑一个单能群中子扩散模型，用于一个被细分为燃料棒栅元的均匀化反应堆节点，其中燃料棒级别的通量重建使用预先计算的形状函数。超均匀化（SPH）方法通过调整均匀化材料参数或节点通量，来强制非均匀细网格和均匀化粗网格描述之间的节点反应率相等。您的任务是，使用经过SPH更新的节点通量，推导并实现一个基于数学原理的燃料棒形状函数修正方法，然后量化重建的燃料棒功率相对于细网格参考解的误差减少量。\n\n基本原理：\n- 在单能群扩散近似中，中子平衡通过反应率守恒来表达。设宏观吸收截面表示为 $\\Sigma_a$，宏观裂变截面表示为 $\\Sigma_f$。\n- 在均匀化节点方法中，节点平均通量 $\\phi_n$ 使用形状函数在燃料棒级别进行重建，以恢复节点内的空间细节。设 $p$ 为燃料棒索引，其中 $p \\in \\{1,\\dots,P\\}$。\n- SPH更新产生一个节点通量 $\\phi_n^{\\mathrm{SPH}}$ 和从高保真非均匀参考解中导出的目标节点反应率。\n\n定义与设置：\n- 设 $A_p$ 为燃料棒 $p$ 的面积。设总节点面积为 $A_n = \\sum_{p=1}^{P} A_p$。\n- 设 $s_p^{\\mathrm{lib}}$ 为用于从均匀化模型进行重建的库燃料棒形状函数，归一化满足 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} = A_n$。\n- 设 $s_p^{\\mathrm{ref}}$ 为细网格参考燃料棒形状函数，归一化满足 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} = A_n$。\n- 设 $\\Sigma_{a,p}$ 和 $\\Sigma_{f,p}$ 分别为燃料棒级别的宏观吸收和裂变截面。\n- SPH前的节点通量为 $\\phi_n^{\\mathrm{pre}}$。SPH更新后的节点通量为 $\\phi_n^{\\mathrm{SPH}}$。\n- 使用形状函数 $s_p$ 和节点通量 $\\phi$ 重建的燃料棒通量为 $\\phi_p = \\phi \\, s_p$。\n- 燃料棒功率（在归一化中已吸收一个常数比例因子）定义为 $P_p = \\phi_p \\, \\Sigma_{f,p} \\, A_p$。\n\n目标：\n- 推导一个对库形状函数 $s_p^{\\mathrm{lib}}$ 的乘法修正因子 $f_p$，使得修正后的形状 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$ 与 $s_p^{\\mathrm{lib}}$ 的偏离最小，同时强制满足与SPH更新后的节点通量和目标吸收反应率一致的守恒约束：\n  1. 通量归一化：$\\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{corr}} = A_n$。\n  2. 吸收率一致性：$\\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{corr}} \\, \\Sigma_{a,p} = R_a^{\\mathrm{tar}}$，其中 $R_a^{\\mathrm{tar}} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{ref}} \\, \\Sigma_{a,p}$ 是由细网格参考解所暗示的目标节点吸收反应率。\n\n- 使用最小微扰原理：在所有满足约束的 $f_p$ 中，选择使 $\\sum_{p=1}^{P} A_p (f_p - 1)^2$ 最小的 $f_p$。\n\n- 使用修正后的形状 $s_p^{\\mathrm{corr}}$ 和SPH更新后的节点通量 $\\phi_n^{\\mathrm{SPH}}$，计算重建的燃料棒功率 $P_p^{\\mathrm{SPH,corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}} \\Sigma_{f,p} A_p$。\n\n- 定义细网格参考燃料棒功率 $P_p^{\\mathrm{ref}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{ref}} \\Sigma_{f,p} A_p$。定义SPH前重建的燃料棒功率 $P_p^{\\mathrm{pre}} = \\phi_n^{\\mathrm{pre}} s_p^{\\mathrm{lib}} \\Sigma_{f,p} A_p$。\n\n- 使用相对均方根（RMS）误差来量化燃料棒功率的误差：\n  $$\\varepsilon(\\{P_p^{(1)}\\}, \\{P_p^{(2)}\\}) = \\frac{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(1)} - P_p^{(2)}\\right)^2}}{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(2)}\\right)^2}}.$$\n  用此公式计算SPH前误差 $\\varepsilon_{\\mathrm{pre}} = \\varepsilon(\\{P_p^{\\mathrm{pre}}\\}, \\{P_p^{\\mathrm{ref}}\\})$ 和修正后的SPH误差 $\\varepsilon_{\\mathrm{corr}} = \\varepsilon(\\{P_p^{\\mathrm{SPH,corr}}\\}, \\{P_p^{\\mathrm{ref}}\\})$。报告误差减少量 $\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}$。\n\n测试套件和参数值：\n- 情况1（一般非均匀情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 0.9,\\, 1.1,\\, 1.0,\\, 1.0 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 0.8,\\, 1.2,\\, 1.05,\\, 0.95 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.20,\\, 0.15,\\, 0.18,\\, 0.17 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.25,\\, 0.27,\\, 0.26,\\, 0.24 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 1.00$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.02$。\n- 情况2（具有均匀库形状和均匀吸收的边界情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 1.0,\\, 1.0,\\, 1.0,\\, 1.0 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 0.95,\\, 1.05,\\, 1.10,\\, 0.90 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.20,\\, 0.20,\\, 0.20,\\, 0.20 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.24,\\, 0.26,\\, 0.25,\\, 0.23 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 0.90$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.10$。\n- 情况3（具有强吸收非均匀性的极端情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 1.20,\\, 0.80,\\, 1.10,\\, 0.90 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 1.10,\\, 0.90,\\, 1.20,\\, 0.80 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.30,\\, 0.10,\\, 0.25,\\, 0.12 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.27,\\, 0.22,\\, 0.28,\\, 0.21 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 0.80$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.05$。\n\n数值要求：\n- 通过一致的归一化将燃料棒功率视为无量纲；无需报告物理单位。\n- 将每个情况的 $\\Delta \\varepsilon$ 计算为十进制数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按顺序包含三个情况的结果：$[ \\Delta \\varepsilon_1, \\Delta \\varepsilon_2, \\Delta \\varepsilon_3 ]$。",
            "solution": "该问题要求推导并实现一种修正均匀化反应堆节点内燃料棒功率形状函数的方法。该修正必须遵循超均匀化（SPH）原理导出的约束条件，并应最小程度地扰动原始的库形状函数。此修正的有效性将通过与细网格参考解相比，燃料棒功率重建误差的减少量来量化。\n\n### 第1部分：形状函数修正的推导\n\n问题的核心是为库形状函数 $\\{s_p^{\\mathrm{lib}}\\}_{p=1}^P$ 找到一组乘法修正因子 $\\{f_p\\}_{p=1}^P$。修正后的形状函数定义为 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$。\n\n修正因子 $f_p$ 通过求解一个约束优化问题来确定。目标是找到尽可能接近1的 $f_p$，这对应于对库形状的最小扰动。这被表述为最小化与1的加权平方偏差和：\n$$\n\\text{最小化 } J(f_1, \\dots, f_P) = \\sum_{p=1}^{P} A_p (f_p - 1)^2\n$$\n其中 $A_p$ 是燃料棒栅元 $p$ 的面积。\n\n该最小化受两个物理约束的限制：\n1.  **通量归一化**：修正后的形状函数必须保持总节点通量。燃料棒级别的重建通量为 $\\phi_p^{\\mathrm{corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}}$。节点上的平均通量为 $\\frac{1}{A_n}\\sum_p \\phi_p^{\\mathrm{corr}} A_p = \\frac{\\phi_n^{\\mathrm{SPH}}}{A_n}\\sum_p s_p^{\\mathrm{corr}} A_p$。为使此值等于 $\\phi_n^{\\mathrm{SPH}}$，形状函数必须满足归一化条件：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{corr}} = A_n\n    $$\n    代入 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$，我们得到对 $f_p$ 的第一个约束：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p = A_n\n    $$\n\n2.  **吸收率一致性**：使用修正形状计算的节点中总吸收反应率必须与从高保真参考计算中导出的目标率 $R_a^{\\mathrm{tar}}$ 相匹配。目标率由 $R_a^{\\mathrm{tar}} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}$ 给出。重建的反应率为 $\\sum_p \\phi_p^{\\mathrm{corr}} \\Sigma_{a,p} A_p = \\phi_n^{\\mathrm{SPH}} \\sum_p s_p^{\\mathrm{corr}} \\Sigma_{a,p} A_p$。令两者相等可得：\n    $$\n    \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{corr}} \\Sigma_{a,p} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n    $$\n    假设 $\\phi_n^{\\mathrm{SPH}} \\neq 0$（这在物理上是必须的），我们可以将其简化为：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p \\Sigma_{a,p} = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n    $$\n\n为了解决这个约束优化问题，我们采用拉格朗日乘子法。拉格朗日函数 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}(\\{f_p\\}, \\lambda_1, \\lambda_2) = \\sum_{p=1}^{P} A_p (f_p - 1)^2 - \\lambda_1 \\left( \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p - A_n \\right) - \\lambda_2 \\left( \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p \\Sigma_{a,p} - \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p} \\right)\n$$\n为了找到极值，我们将 $\\mathcal{L}$ 对每个 $f_p$ 的偏导数设为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial f_p} = 2 A_p (f_p - 1) - \\lambda_1 A_p s_p^{\\mathrm{lib}} - \\lambda_2 A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} = 0\n$$\n解出 $f_p$ 可得：\n$$\nf_p = 1 + \\frac{\\lambda_1}{2} s_p^{\\mathrm{lib}} + \\frac{\\lambda_2}{2} s_p^{\\mathrm{lib}} \\Sigma_{a,p} = 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p})\n$$\n拉格朗日乘子 $\\lambda_1$ 和 $\\lambda_2$ 通过将此 $f_p$ 的表达式代回两个约束方程来确定。\n\n对于第一个约束，已知库形状函数归一化满足 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} = A_n$：\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\left( 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p}) \\right) = A_n\n$$\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} = A_n\n$$\n$$\nA_n + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} = A_n\n$$\n这简化为一个关于 $\\lambda_1$ 和 $\\lambda_2$ 的线性方程：\n$$\n\\lambda_1 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\right) + \\lambda_2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} \\right) = 0\n$$\n\n对于第二个约束：\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} \\left( 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p}) \\right) = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n$$\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2 = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n$$\n这给出了第二个线性方程：\n$$\n\\lambda_1 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} \\right) + \\lambda_2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2 \\right) = 2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{ref}} - s_p^{\\mathrm{lib}}) \\Sigma_{a,p} \\right)\n$$\n\n这两个方程构成一个 $2 \\times 2$ 线性系统 $M \\boldsymbol{\\lambda} = \\mathbf{b}$，用于求解拉格朗日乘子向量 $\\boldsymbol{\\lambda} = [\\lambda_1, \\lambda_2]^T$：\n$$\n\\begin{pmatrix} M_{11}  M_{12} \\\\ M_{12}  M_{22} \\end{pmatrix}\n\\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix}\n=\n\\begin{pmatrix} 0 \\\\ b_2 \\end{pmatrix}\n$$\n其中矩阵元素为：\n$M_{11} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2$\n$M_{12} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}$\n$M_{22} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2$\n右侧项为：\n$b_2 = 2 \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{ref}} - s_p^{\\mathrm{lib}}) \\Sigma_{a,p}$\n\n可以解此系统得到 $\\lambda_1$ 和 $\\lambda_2$，然后用它们来计算修正因子 $f_p$。如果矩阵 $M$ 是奇异的（即 $\\det(M)=0$），则会出现特殊情况，这发生在向量 $\\{A_p s_p^{\\mathrm{lib}}\\}_p$ 和 $\\{A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p}\\}_p$ 线性相关时。例如，如果 $\\Sigma_{a,p}$ 对所有燃料棒都是均匀的，就会发生这种情况。在这种情况下，两个约束变得冗余，优化问题简化，得到对所有 $p$ 都有 $f_p=1$。\n\n### 第2部分：燃料棒功率和误差计算\n\n一旦找到修正后的形状函数 $s_p^{\\mathrm{corr}}$，各种燃料棒功率的计算如下：\n-   **参考燃料棒功率**：$P_p^{\\mathrm{ref}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{ref}} \\Sigma_{f,p} A_p$\n-   **SPH前重建燃料棒功率**：$P_p^{\\mathrm{pre}} = \\phi_n^{\\mathrm{pre}} s_p^{\\mathrm{lib}} \\Sigma_{f,p} A_p$\n-   **修正后SPH燃料棒功率**：$P_p^{\\mathrm{SPH,corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}} \\Sigma_{f,p} A_p$\n\n重建的燃料棒功率分布 $\\{P_p^{(1)}\\}$ 相对于参考分布 $\\{P_p^{(2)}\\}$ 的误差通过相对均方根（RMS）误差来量化：\n$$\n\\varepsilon(\\{P_p^{(1)}\\}, \\{P_p^{(2)}\\}) = \\frac{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(1)} - P_p^{(2)}\\right)^2}}{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(2)}\\right)^2}} = \\frac{\\| \\mathbf{P}^{(1)} - \\mathbf{P}^{(2)} \\|_2}{\\| \\mathbf{P}^{(2)} \\|_2}\n$$\n我们计算SPH前和修正后SPH两种情况相对于参考功率的误差：\n-   **SPH前误差**：$\\varepsilon_{\\mathrm{pre}} = \\varepsilon(\\{P_p^{\\mathrm{pre}}\\}, \\{P_p^{\\mathrm{ref}}\\})$\n-   **修正后SPH误差**：$\\varepsilon_{\\mathrm{corr}} = \\varepsilon(\\{P_p^{\\mathrm{SPH,corr}}\\}, \\{P_p^{\\mathrm{ref}}\\})$\n\n最终目标是计算通过完整的基于SPH的更新（包括节点通量和形状函数修正）所实现的误差减少量：\n$$\n\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}\n$$\n\n### 算法总结\n\n对于每个测试用例，执行以下计算步骤：\n1.  组装给定的参数数组：$A_p, s_p^{\\mathrm{lib}}, s_p^{\\mathrm{ref}}, \\Sigma_{a,p}, \\Sigma_{f,p}$，以及标量 $\\phi_n^{\\mathrm{pre}}, \\phi_n^{\\mathrm{SPH}}$。\n2.  构建 $2 \\times 2$ 矩阵 $M$ 和右侧向量 $\\mathbf{b}$。\n3.  检查 $M$ 是否为奇异矩阵。\n    - 如果非奇异，求解线性系统 $M \\boldsymbol{\\lambda} = \\mathbf{b}$ 得到 $\\lambda_1, \\lambda_2$。\n    - 如果是奇异的（如情况2），约束是冗余的，最小扰动解为对所有 $p$ 都有 $f_p = 1$。这对应于 $\\lambda_1=0, \\lambda_2=0$。\n4.  计算修正因子 $f_p = 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p})$。\n5.  计算修正后的形状函数 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$。\n6.  计算燃料棒功率向量 $\\mathbf{P}^{\\mathrm{ref}}$、$\\mathbf{P}^{\\mathrm{pre}}$ 和 $\\mathbf{P}^{\\mathrm{SPH,corr}}$。\n7.  使用相对RMS误差公式计算误差 $\\varepsilon_{\\mathrm{pre}}$ 和 $\\varepsilon_{\\mathrm{corr}}$。\n8.  计算误差减少量 $\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}$。\n\n此过程将应用于提供的三个测试用例中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the pin power reconstruction problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (general heterogeneous case)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([0.9, 1.1, 1.0, 1.0]),\n            \"s_ref\": np.array([0.8, 1.2, 1.05, 0.95]),\n            \"Sigma_a\": np.array([0.20, 0.15, 0.18, 0.17]),\n            \"Sigma_f\": np.array([0.25, 0.27, 0.26, 0.24]),\n            \"phi_pre\": 1.00,\n            \"phi_SPH\": 1.02,\n        },\n        # Case 2 (boundary case with uniform library shape and uniform absorption)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_ref\": np.array([0.95, 1.05, 1.10, 0.90]),\n            \"Sigma_a\": np.array([0.20, 0.20, 0.20, 0.20]),\n            \"Sigma_f\": np.array([0.24, 0.26, 0.25, 0.23]),\n            \"phi_pre\": 0.90,\n            \"phi_SPH\": 1.10,\n        },\n        # Case 3 (edge case with strong absorption heterogeneity)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([1.20, 0.80, 1.10, 0.90]),\n            \"s_ref\": np.array([1.10, 0.90, 1.20, 0.80]),\n            \"Sigma_a\": np.array([0.30, 0.10, 0.25, 0.12]),\n            \"Sigma_f\": np.array([0.27, 0.22, 0.28, 0.21]),\n            \"phi_pre\": 0.80,\n            \"phi_SPH\": 1.05,\n        },\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Unpack parameters\n        A_p = case[\"A_p\"]\n        s_lib = case[\"s_lib\"]\n        s_ref = case[\"s_ref\"]\n        Sigma_a = case[\"Sigma_a\"]\n        Sigma_f = case[\"Sigma_f\"]\n        phi_pre = case[\"phi_pre\"]\n        phi_SPH = case[\"phi_SPH\"]\n\n        # --- Part 1: Derive Correction Factors ---\n        # Construct the 2x2 system M*lambda = b for Lagrange multipliers\n        \n        M11 = np.sum(A_p * s_lib**2)\n        M12 = np.sum(A_p * (s_lib**2) * Sigma_a)\n        M22 = np.sum(A_p * (s_lib**2) * (Sigma_a**2))\n\n        M = np.array([[M11, M12], [M12, M22]])\n\n        b2 = 2 * np.sum(A_p * (s_ref - s_lib) * Sigma_a)\n        b = np.array([0.0, b2])\n\n        # Solve for lambda_1 and lambda_2\n        det_M = np.linalg.det(M)\n        if abs(det_M)  1e-15:\n            # Singular case: constraints are linearly dependent.\n            # The minimization objective is met at f_p=1, i.e., lambda_1=lambda_2=0.\n            lambda_1, lambda_2 = 0.0, 0.0\n        else:\n            lambdas = np.linalg.solve(M, b)\n            lambda_1, lambda_2 = lambdas[0], lambdas[1]\n\n        # Calculate correction factors f_p and corrected shape s_corr\n        f_p = 1.0 + (s_lib / 2.0) * (lambda_1 + lambda_2 * Sigma_a)\n        s_corr = s_lib * f_p\n        \n        # --- Part 2: Calculate Pin Powers and Errors ---\n\n        # Calculate pin power vectors\n        P_ref = phi_SPH * s_ref * Sigma_f * A_p\n        P_pre = phi_pre * s_lib * Sigma_f * A_p\n        P_sph_corr = phi_SPH * s_corr * Sigma_f * A_p\n\n        # Define RMS error function\n        def rms_error(P1, P2):\n            norm_diff = np.linalg.norm(P1 - P2)\n            norm_ref = np.linalg.norm(P2)\n            if norm_ref == 0:\n                return 0.0 if norm_diff == 0 else np.inf\n            return norm_diff / norm_ref\n\n        # Compute errors\n        eps_pre = rms_error(P_pre, P_ref)\n        eps_corr = rms_error(P_sph_corr, P_ref)\n\n        # Compute error reduction\n        delta_eps = eps_pre - eps_corr\n        results.append(delta_eps)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}