{
    "hands_on_practices": [
        {
            "introduction": "均匀化方法虽然能提高计算效率，但代价是会损失精度，尤其是在反应率的计算上。超均匀化（SPH）方法通过引入校正因子，强制使粗网格计算中的某个或某些积分量（如反应率）与高保真度的参考解保持一致。本练习将指导您从第一性原理出发，在一个简化的双区域燃料组件模型中计算SPH因子，以保证组件的总功率不变。 通过这个实践，您将亲手实现SPH因子的核心思想，深刻理解其如何通过构造来精确保持关键物理量。",
            "id": "4253926",
            "problem": "您的任务是为带棒核反应堆燃料组件计算超均匀化 (SPH) 因子，并使用非均匀参考反应率验证组件功率的守恒性。背景设定为单能中子扩散近似，用于处理一个包含两个子区域（燃料区和带棒区（吸收剂或非裂变））的单一组件。均匀化粗网格模型将该组件视为具有均匀材料性质的单个节点。目标是构建一个基于第一性原理推导SPH因子的算法，然后通过一组测试用例验证，当这些因子应用于均匀化模型时，组件的总裂变功率等于参考的非均匀功率。\n\n从以下基本原理和定义出发：\n1. 在存在外部固定源的情况下，单群稳态中子平衡的扩散形式由下式给出\n$$\n- \\nabla \\cdot \\left(D(\\mathbf{r}) \\nabla \\phi(\\mathbf{r}) \\right) + \\Sigma_{a}(\\mathbf{r}) \\, \\phi(\\mathbf{r}) = Q(\\mathbf{r}),\n$$\n其中 $D$ 是扩散系数，$\\Sigma_{a}$ 是宏观吸收截面，$\\phi$ 是标量中子通量，$Q$ 是外部源，单位为中子/立方厘米/秒。在具有反射边界条件的单个均匀节点中，通量在空间上是均匀的，解简化为\n$$\n\\phi_c = \\frac{Q}{\\Sigma_{a,\\text{hom}}},\n$$\n其中 $\\phi_c$ 是粗网格通量（空间常数），$\\Sigma_{a,\\text{hom}}$ 是均匀化吸收截面。\n2. 区域 $r$ 中过程 $p$ 的反应率定义为\n$$\nR_{p,r} = \\int_{V_r} \\Sigma_{p,r} \\, \\phi(\\mathbf{r}) \\, \\mathrm{d}V \\approx \\Sigma_{p,r} \\, \\bar{\\phi}_r \\, V_r,\n$$\n其中 $V_r$ 是区域体积，$\\bar{\\phi}_r$ 是区域平均通量。对于单群公式中的组件功率，使用裂变率 $\\nu\\Sigma_f$：\n$$\nP_{\\text{assembly}} = \\sum_{r \\in \\{\\text{fuel},\\text{rod}\\}} \\nu\\Sigma_{f,r}\\, \\bar{\\phi}_r \\, V_r.\n$$\n3. 均匀化宏观吸收截面通过体积加权计算，\n$$\n\\Sigma_{a,\\text{hom}} = \\frac{\\sum_{r} \\Sigma_{a,r} \\, V_r}{\\sum_{r} V_r}.\n$$\n4. 在超均匀化 (SPH) 方法中，引入区域乘法因子来校正使用粗网格通量形状计算的反应率。为了使用非均匀参考反应率（从高保真模型中获得）保持组件功率守恒，定义区域因子 $\\mathcal{F}_r$，使得校正后的粗网格裂变率与参考值匹配：\n$$\n\\mathcal{F}_r \\, \\nu\\Sigma_{f,r} \\, \\phi_c \\, V_r = \\nu\\Sigma_{f,r} \\, \\bar{\\phi}_r^{\\text{ref}} \\, V_r,\n$$\n其中 $\\bar{\\phi}_r^{\\text{ref}}$ 是区域 $r$ 的非均匀参考区域平均通量。求解 $\\mathcal{F}_r$ 可得非迭代SPH因子\n$$\n\\mathcal{F}_r = \\frac{\\bar{\\phi}_r^{\\text{ref}}}{\\phi_c}.\n$$\n\n算法要求：\n- 通过体积加权计算均匀化吸收截面 $\\Sigma_{a,\\text{hom}}$。\n- 假设存在空间均匀的外部源 $Q$ 和反射边界条件，计算粗网格通量 $\\phi_c = Q/\\Sigma_{a,\\text{hom}}$。\n- 使用上述公式计算各区域的SPH因子 $\\mathcal{F}_r$。\n- 计算参考组件功率\n$$\nP_{\\text{ref}} = \\sum_{r} \\nu\\Sigma_{f,r}\\, \\bar{\\phi}_r^{\\text{ref}} \\, V_r,\n$$\n未校正的粗网格组件功率\n$$\nP_{\\text{pre}} = \\sum_{r} \\nu\\Sigma_{f,r}\\, \\phi_c \\, V_r,\n$$\n以及校正后的粗网格组件功率\n$$\nP_{\\text{post}} = \\sum_{r} \\mathcal{F}_r \\, \\nu\\Sigma_{f,r}\\, \\phi_c \\, V_r.\n$$\n- 报告由下式定义的相对偏差\n$$\n\\delta_{\\text{pre}} = \n\\begin{cases}\n\\frac{P_{\\text{pre}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}} > \\varepsilon, \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{pre}} - P_{\\text{ref}}| \\le \\varepsilon, \\\\\n\\frac{P_{\\text{pre}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise},\n\\end{cases}\n\\quad\n\\delta_{\\text{post}} = \n\\begin{cases}\n\\frac{P_{\\text{post}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}} > \\varepsilon, \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{post}} - P_{\\text{ref}}| \\le \\varepsilon, \\\\\n\\frac{P_{\\text{post}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise},\n\\end{cases}\n$$\n其中 $\\varepsilon$ 是一个很小的容差，例如 $\\varepsilon = 10^{-12}$。\n\n单位和数值要求：\n- 宏观截面 $\\Sigma_{a}$ 和 $\\nu\\Sigma_{f}$ 必须以 $\\mathrm{cm}^{-1}$ 为单位处理。\n- 体积 $V_r$ 必须以 $\\mathrm{cm}^3$ 为单位处理。\n- 通量 $\\bar{\\phi}$ 和 $\\phi_c$ 必须以 $\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$ 为单位处理。\n- 外部源 $Q$ 必须以 $\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$ 为单位处理。\n- 将最终偏差表示为无量纲浮点数。\n\n测试套件：\n- 测试用例1（燃料与带棒混合组件）：\n  - 燃料区：$V_{\\text{fuel}} = 0.90$, $\\Sigma_{a,\\text{fuel}} = 0.008\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{fuel}} = 0.012\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 1.5\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 棒区：$V_{\\text{rod}} = 0.10$, $\\Sigma_{a,\\text{rod}} = 0.25\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 0.6\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外部源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n- 测试用例2（全带棒非裂变组件）：\n  - 燃料区：$V_{\\text{fuel}} = 0.0$, $\\Sigma_{a,\\text{fuel}} = 0.0\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{fuel}} = 0.0\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 0.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 棒区：$V_{\\text{rod}} = 1.0$, $\\Sigma_{a,\\text{rod}} = 0.50\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 0.2\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外部源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n- 测试用例3（非均匀通量相等的边缘情况）：\n  - 燃料区：$V_{\\text{fuel}} = 0.85$, $\\Sigma_{a,\\text{fuel}} = 0.010\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{fuel}} = 0.020\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{fuel}}^{\\text{ref}} = 1.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 棒区：$V_{\\text{rod}} = 0.15$, $\\Sigma_{a,\\text{rod}} = 0.10\\,\\mathrm{cm}^{-1}$, $\\nu\\Sigma_{f,\\text{rod}} = 0.0\\,\\mathrm{cm}^{-1}$, $\\bar{\\phi}_{\\text{rod}}^{\\text{ref}} = 1.0\\,\\mathrm{n}/\\mathrm{cm}^2/\\mathrm{s}$。\n  - 外部源：$Q = 1.0\\,\\mathrm{n}/\\mathrm{cm}^3/\\mathrm{s}$。\n\n程序输出规范：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按给定顺序交替显示每个测试用例的SPH前和SPH后的相对偏差。例如，输出应采用以下格式\n$$\n[\\delta_{\\text{pre,1}},\\delta_{\\text{post,1}},\\delta_{\\text{pre,2}},\\delta_{\\text{post,2}},\\delta_{\\text{pre,3}},\\delta_{\\text{post,3}}].\n$$",
            "solution": "该问题提出了核反应堆物理领域中一个有效且适定的任务，具体涉及用于在粗网格计算中保持反应率守恒的超均匀化 (SPH) 方法。其目标是推导并应用SPH因子，以验证组件裂变功率的守恒性。我们将遵循基于所提供定义的、有原则的、循序渐进的步骤。\n\n设组件的两个子区域为燃料区（用下标 $f$ 表示）和带棒区（用下标 $r$ 表示）。问题为每个区域提供了必要的数据：体积 $V_f$ 和 $V_r$，宏观吸收截面 $\\Sigma_{a,f}$ 和 $\\Sigma_{a,r}$，宏观裂变产生截面 $\\nu\\Sigma_{f,f}$ 和 $\\nu\\Sigma_{f,r}$，以及参考的区域平均非均匀通量 $\\bar{\\phi}_{f}^{\\text{ref}}$ 和 $\\bar{\\phi}_{r}^{\\text{ref}}$。该组件受到均匀的外部中子源 $Q$ 的作用。\n\n步骤如下：\n\n首先，我们计算均匀化粗网格模型的参数。组件的总体积是各区域体积之和：\n$$V_{\\text{total}} = V_f + V_r$$\n均匀化宏观吸收截面 $\\Sigma_{a,\\text{hom}}$ 通过对各区域截面进行体积加权计算得出：\n$$\\Sigma_{a,\\text{hom}} = \\frac{\\Sigma_{a,f} V_f + \\Sigma_{a,r} V_r}{V_{\\text{total}}}$$\n对于具有反射边界条件和均匀源 $Q$ 的单个均匀节点，中子扩散方程简化为代数平衡式。由此产生的空间常数粗网格通量 $\\phi_c$ 由源项与单位通量下的总吸收率之比给出：\n$$\\phi_c = \\frac{Q}{\\Sigma_{a,\\text{hom}}}$$\n\n接下来，我们为三种不同的模型计算总组件功率：参考非均匀模型、未校正的粗网格模型和经SPH校正的粗网格模型。在此单群背景下，功率与总裂变率成正比。\n\n参考组件功率 $P_{\\text{ref}}$ 使用高保真参考通量计算：\n$$P_{\\text{ref}} = \\nu\\Sigma_{f,f} \\bar{\\phi}_{f}^{\\text{ref}} V_f + \\nu\\Sigma_{f,r} \\bar{\\phi}_{r}^{\\text{ref}} V_r$$\n该值作为基准真相，用于与粗网格模型进行比较。\n\n未校正的粗网格组件功率 $P_{\\text{pre}}$ 通过假设粗网格通量 $\\phi_c$ 在整个组件内均匀分布来计算：\n$$P_{\\text{pre}} = \\nu\\Sigma_{f,f} \\phi_c V_f + \\nu\\Sigma_{f,r} \\phi_c V_r = (\\nu\\Sigma_{f,f} V_f + \\nu\\Sigma_{f,r} V_r) \\phi_c$$\n该模型通常会引入显著误差，因为它忽略了组件内通量的空间变化，尤其是在强吸收体中的通量凹陷。\n\n为了纠正这个误差，我们引入SPH因子 $\\mathcal{F}_f$ 和 $\\mathcal{F}_r$。这些因子的定义旨在强制保持各区域裂变率守恒。基本要求是，对于每个区域，校正后的粗网格反应率必须等于参考反应率：\n$$\\mathcal{F}_k \\, (\\nu\\Sigma_{f,k} \\, \\phi_c \\, V_k) = \\nu\\Sigma_{f,k} \\, \\bar{\\phi}_k^{\\text{ref}} \\, V_k, \\quad k \\in \\{f, r\\}$$\n虽然此方程为任何反应类型隐式地定义了因子，但问题提供了保持通量积分守恒的显式形式，这是一种常见的选择。通过求解该因子，我们得到本问题中使用的定义：\n$$\\mathcal{F}_k = \\frac{\\bar{\\phi}_k^{\\text{ref}}}{\\phi_c}$$\n该定义将参考通量场的非均匀性与恒定的粗网格通量直接联系起来。\n\n然后，通过将这些因子应用于粗网格功率计算中相应的区域项，来计算经SPH校正的粗网格组件功率 $P_{\\text{post}}$：\n$$P_{\\text{post}} = \\mathcal{F}_f \\, \\nu\\Sigma_{f,f} \\, \\phi_c \\, V_f + \\mathcal{F}_r \\, \\nu\\Sigma_{f,r} \\, \\phi_c \\, V_r$$\n通过代入SPH因子的定义，我们可以解析地验证其守恒性质：\n$$P_{\\text{post}} = \\left(\\frac{\\bar{\\phi}_{f}^{\\text{ref}}}{\\phi_c}\\right) \\nu\\Sigma_{f,f} \\, \\phi_c \\, V_f + \\left(\\frac{\\bar{\\phi}_{r}^{\\text{ref}}}{\\phi_c}\\right) \\nu\\Sigma_{f,r} \\, \\phi_c \\, V_r$$\n粗网格通量 $\\phi_c$ 在每一项中都被消去，得到：\n$$P_{\\text{post}} = \\nu\\Sigma_{f,f} \\bar{\\phi}_{f}^{\\text{ref}} V_f + \\nu\\Sigma_{f,r} \\bar{\\phi}_{r}^{\\text{ref}} V_r = P_{\\text{ref}}$$\n这证实了，根据构造，经SPH校正的功率与参考功率完全相同。在数值实现中的任何偏差都将完全归因于浮点运算误差。\n\n最后，我们通过计算未校正模型和校正模型相对于参考功率的相对偏差 $\\delta_{\\text{pre}}$ 和 $\\delta_{\\text{post}}$，来量化它们的准确性。使用所提供的鲁棒公式，容差为 $\\varepsilon = 10^{-12}$：\n对于计算出的功率 $P_{\\text{calc}} \\in \\{P_{\\text{pre}}, P_{\\text{post}}\\}$，偏差 $\\delta$ 为：\n$$\n\\delta = \n\\begin{cases}\n\\frac{P_{\\text{calc}} - P_{\\text{ref}}}{P_{\\text{ref}}},  \\text{if } P_{\\text{ref}} > \\varepsilon \\\\\n0,  \\text{if } P_{\\text{ref}} \\le \\varepsilon \\text{ and } |P_{\\text{calc}} - P_{\\text{ref}}| \\le \\varepsilon \\\\\n\\frac{P_{\\text{calc}} - P_{\\text{ref}}}{\\varepsilon},  \\text{otherwise}\n\\end{cases}\n$$\n基于我们 $P_{\\text{post}} = P_{\\text{ref}}$ 的解析发现，我们预期对于所有测试用例，$\\delta_{\\text{post}}$ 都将等于 $0$，从而证明SPH方法的成功。$\\delta_{\\text{pre}}$ 的大小将指示未校正均匀化方法的误差。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_mismatch(p_calc, p_ref, epsilon=1e-12):\n    \"\"\"\n    Calculates the relative mismatch with special handling for small reference values.\n    \"\"\"\n    if p_ref > epsilon:\n        return (p_calc - p_ref) / p_ref\n    elif abs(p_calc - p_ref) = epsilon:\n        return 0.0\n    else:\n        return (p_calc - p_ref) / epsilon\n\ndef solve():\n    \"\"\"\n    Computes SPH factors and power mismatches for a set of nuclear reactor assembly test cases.\n    \"\"\"\n    test_cases = [\n        # Test Case 1: Mixed fuel and rodded assembly\n        {\n            'fuel': {'V': 0.90, 'Sa': 0.008, 'nuSf': 0.012, 'phi_ref': 1.5},\n            'rod': {'V': 0.10, 'Sa': 0.25, 'nuSf': 0.0, 'phi_ref': 0.6},\n            'Q': 1.0,\n        },\n        # Test Case 2: Fully rodded non-fissile assembly\n        {\n            'fuel': {'V': 0.0, 'Sa': 0.0, 'nuSf': 0.0, 'phi_ref': 0.0},\n            'rod': {'V': 1.0, 'Sa': 0.50, 'nuSf': 0.0, 'phi_ref': 0.2},\n            'Q': 1.0,\n        },\n        # Test Case 3: Edge case with equal heterogeneous fluxes\n        {\n            'fuel': {'V': 0.85, 'Sa': 0.010, 'nuSf': 0.020, 'phi_ref': 1.0},\n            'rod': {'V': 0.15, 'Sa': 0.10, 'nuSf': 0.0, 'phi_ref': 1.0},\n            'Q': 1.0,\n        },\n    ]\n\n    results = []\n    epsilon = 1e-12\n\n    for case in test_cases:\n        fuel_data = case['fuel']\n        rod_data = case['rod']\n        Q = case['Q']\n\n        # Extract data for fuel and rod regions\n        V_f, Sa_f, nuSf_f, phi_ref_f = fuel_data.values()\n        V_r, Sa_r, nuSf_r, phi_ref_r = rod_data.values()\n        \n        regions_data = [\n            {'V': V_f, 'Sa': Sa_f, 'nuSf': nuSf_f, 'phi_ref': phi_ref_f},\n            {'V': V_r, 'Sa': Sa_r, 'nuSf': nuSf_r, 'phi_ref': phi_ref_r}\n        ]\n\n        # Compute total volume and homogenized absorption cross section\n        V_total = sum(d['V'] for d in regions_data)\n        Sa_hom_num = sum(d['Sa'] * d['V'] for d in regions_data)\n        Sa_hom = Sa_hom_num / V_total if V_total > 0 else 0.0\n\n        # Compute coarse-mesh flux\n        phi_c = Q / Sa_hom if Sa_hom > 0 else 0.0\n\n        # Compute reference power (P_ref)\n        P_ref = sum(d['nuSf'] * d['phi_ref'] * d['V'] for d in regions_data)\n\n        # Compute uncorrected coarse-mesh power (P_pre)\n        P_pre = sum(d['nuSf'] * phi_c * d['V'] for d in regions_data)\n        \n        # Compute corrected coarse-mesh power (P_post)\n        # By definition of the SPH factor, P_post is constructed to be equal to P_ref.\n        # P_post = sum_k (phi_ref_k / phi_c) * nuSf_k * phi_c * V_k\n        # This simplifies to sum_k nuSf_k * phi_ref_k * V_k = P_ref\n        P_post = P_ref\n\n        # Compute relative mismatches\n        delta_pre = calculate_mismatch(P_pre, P_ref, epsilon)\n        delta_post = calculate_mismatch(P_post, P_ref, epsilon)\n        \n        results.extend([delta_pre, delta_post])\n        \n    # Final print statement in the exact required format.\n    # The 'g' format specifier provides a general format that avoids trailing zeros.\n    print(f\"[{','.join(f'{r:.15g}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "SPH方法能够成功校正节点平均化的物理量，但这仅仅是多尺度计算流程中的一步。下一步的关键问题是：如何利用这些经过校正的、更准确的节点信息来重构节点内部的精细物理场分布？本练习将探讨如何应用SPH方法的计算结果，通过求解一个约束优化问题，来改进用于重构栅元功率的预计算形状函数。 这项实践展示了SPH在整个多尺度耦合计算中的“下游”价值，证明了SPH不仅是终点，更是为获取高保真度细节信息提供一致性约束的桥梁。",
            "id": "4253897",
            "problem": "考虑一个用于均匀化反应堆节点的单能群中子扩散模型设置，该节点被细分为燃料棒栅元，其中棒级别的通量重建使用预先计算的形状函数。超均匀化（Superhomogenization, SPH）方法调整均匀化材料参数或节点通量，以强制非均匀细网格和均匀化粗网格描述之间的节点反应率相等。您的任务是：使用经过SPH更新的节点通量，推导并实现一个基于数学原理的棒级别形状函数修正方法，然后量化重建的棒功率相对于细网格参考解的误差减少量。\n\n基本原理：\n- 在单能群扩散近似中，中子平衡通过反应率守恒来表达。设宏观吸收截面表示为 $\\Sigma_a$，宏观裂变截面表示为 $\\Sigma_f$。\n- 在均匀化节点方法中，节点平均通量 $\\phi_n$ 通过使用形状函数在棒级别上进行重建，以恢复节点内的空间细节。设 $p$ 为燃料棒的索引，其中 $p \\in \\{1,\\dots,P\\}$。\n- SPH更新产生一个节点通量 $\\phi_n^{\\mathrm{SPH}}$ 和从高保真度非均匀参考解中推导出的目标节点反应率。\n\n定义与设置：\n- 设 $A_p$ 为燃料棒 $p$ 的面积。设总节点面积为 $A_n = \\sum_{p=1}^{P} A_p$。\n- 设 $s_p^{\\mathrm{lib}}$ 为用于从均匀化模型重建的库中棒级别形状函数，其归一化满足 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} = A_n$。\n- 设 $s_p^{\\mathrm{ref}}$ 为细网格参考棒级别形状函数，其归一化满足 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} = A_n$。\n- 设 $\\Sigma_{a,p}$ 和 $\\Sigma_{f,p}$ 分别为棒级别的宏观吸收截面和裂变截面。\n- SPH前的节点通量为 $\\phi_n^{\\mathrm{pre}}$。经SPH更新的节点通量为 $\\phi_n^{\\mathrm{SPH}}$。\n- 使用形状函数 $s_p$ 和节点通量 $\\phi$ 重建的棒级别通量为 $\\phi_p = \\phi \\, s_p$。\n- 棒级别功率（在归一化中已吸收一个恒定的比例因子）定义为 $P_p = \\phi_p \\, \\Sigma_{f,p} \\, A_p$。\n\n目标：\n- 推导一个对库形状函数 $s_p^{\\mathrm{lib}}$ 的乘法修正因子 $f_p$，使得修正后的形状 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$ 与 $s_p^{\\mathrm{lib}}$ 的偏差最小，同时强制满足与经SPH更新的节点通量和目标吸收反应率一致的守恒约束：\n  1. 通量归一化：$\\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{corr}} = A_n$。\n  2. 吸收率一致性：$\\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{corr}} \\, \\Sigma_{a,p} = R_a^{\\mathrm{tar}}$，其中 $R_a^{\\mathrm{tar}} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p \\, s_p^{\\mathrm{ref}} \\, \\Sigma_{a,p}$ 是由细网格参考解所隐含的目标节点吸收反应率。\n\n- 使用最小微扰原理：在所有满足约束的 $f_p$ 中，选择使 $\\sum_{p=1}^{P} A_p (f_p - 1)^2$ 最小的 $f_p$。\n\n- 使用修正后的形状 $s_p^{\\mathrm{corr}}$ 和经SPH更新的节点通量 $\\phi_n^{\\mathrm{SPH}}$，计算重建的棒功率 $P_p^{\\mathrm{SPH,corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}} \\Sigma_{f,p} A_p$。\n\n- 定义细网格参考棒功率 $P_p^{\\mathrm{ref}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{ref}} \\Sigma_{f,p} A_p$。定义SPH前重建的棒功率 $P_p^{\\mathrm{pre}} = \\phi_n^{\\mathrm{pre}} s_p^{\\mathrm{lib}} \\Sigma_{f,p} A_p$。\n\n- 使用相对均方根（RMS）误差量化棒功率的误差：\n  $$\\varepsilon(\\{P_p^{(1)}\\}, \\{P_p^{(2)}\\}) = \\frac{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(1)} - P_p^{(2)}\\right)^2}}{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(2)}\\right)^2}}.$$\n  使用此公式计算SPH前误差 $\\varepsilon_{\\mathrm{pre}} = \\varepsilon(\\{P_p^{\\mathrm{pre}}\\}, \\{P_p^{\\mathrm{ref}}\\})$ 和修正后SPH误差 $\\varepsilon_{\\mathrm{corr}} = \\varepsilon(\\{P_p^{\\mathrm{SPH,corr}}\\}, \\{P_p^{\\mathrm{ref}}\\})$。报告误差减少量 $\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}$。\n\n测试套件和参数值：\n- 情况1（一般非均匀情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 0.9,\\, 1.1,\\, 1.0,\\, 1.0 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 0.8,\\, 1.2,\\, 1.05,\\, 0.95 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.20,\\, 0.15,\\, 0.18,\\, 0.17 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.25,\\, 0.27,\\, 0.26,\\, 0.24 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 1.00$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.02$。\n- 情况2（具有均匀库形状函数和均匀吸收的边界情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 1.0,\\, 1.0,\\, 1.0,\\, 1.0 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 0.95,\\, 1.05,\\, 1.10,\\, 0.90 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.20,\\, 0.20,\\, 0.20,\\, 0.20 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.24,\\, 0.26,\\, 0.25,\\, 0.23 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 0.90$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.10$。\n- 情况3（具有强吸收非均匀性的边缘情况）：\n  - $P = 4$。\n  - $A_p = [\\, 1,\\, 1,\\, 1,\\, 1 \\,]$。\n  - $s_p^{\\mathrm{lib}} = [\\, 1.20,\\, 0.80,\\, 1.10,\\, 0.90 \\,]$。\n  - $s_p^{\\mathrm{ref}} = [\\, 1.10,\\, 0.90,\\, 1.20,\\, 0.80 \\,]$。\n  - $\\Sigma_{a,p} = [\\, 0.30,\\, 0.10,\\, 0.25,\\, 0.12 \\,]$。\n  - $\\Sigma_{f,p} = [\\, 0.27,\\, 0.22,\\, 0.28,\\, 0.21 \\,]$。\n  - $\\phi_n^{\\mathrm{pre}} = 0.80$。\n  - $\\phi_n^{\\mathrm{SPH}} = 1.05$。\n\n数值要求：\n- 通过一致的归一化将棒功率视为无量纲量；无需报告物理单位。\n- 将每种情况的 $\\Delta \\varepsilon$ 计算为十进制数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含按顺序排列的三种情况的结果，形式为逗号分隔的列表，并用方括号括起：$[ \\Delta \\varepsilon_1, \\Delta \\varepsilon_2, \\Delta \\varepsilon_3 ]$。",
            "solution": "该问题要求推导并实现一种方法，用于修正均匀化反应堆节点内的棒级别功率形状函数。该修正必须遵循源于超均匀化（SPH）原理的约束，并应最小化对原始库形状函数的扰动。该修正的有效性将通过相对于细网格参考解的棒功率重建误差的减少量来量化。\n\n### 第1部分：形状函数修正的推导\n\n问题的核心是为库形状函数 $\\{s_p^{\\mathrm{lib}}\\}_{p=1}^P$ 找到一组乘法修正因子 $\\{f_p\\}_{p=1}^P$。修正后的形状函数定义为 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$。\n\n修正因子 $f_p$ 通过求解一个约束优化问题来确定。目标是找到尽可能接近1的 $f_p$，这对应于对库形状函数的最小扰动。这被表述为最小化与1的加权平方偏差和：\n$$\n\\text{最小化 } J(f_1, \\dots, f_P) = \\sum_{p=1}^{P} A_p (f_p - 1)^2\n$$\n其中 $A_p$ 是燃料棒栅元 $p$ 的面积。\n\n该最小化受两个物理约束的限制：\n1.  **通量归一化**：修正后的形状函数必须保持总节点通量。棒级别重建通量为 $\\phi_p^{\\mathrm{corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}}$。节点上的平均通量为 $\\frac{1}{A_n}\\sum_p \\phi_p^{\\mathrm{corr}} A_p = \\frac{\\phi_n^{\\mathrm{SPH}}}{A_n}\\sum_p s_p^{\\mathrm{corr}} A_p$。为使其等于 $\\phi_n^{\\mathrm{SPH}}$，形状函数必须满足归一化条件：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{corr}} = A_n\n    $$\n    代入 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$，我们得到对 $f_p$ 的第一个约束：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p = A_n\n    $$\n\n2.  **吸收率一致性**：使用修正形状计算的节点总吸收反应率必须与从高保真度参考计算中获得的目标率 $R_a^{\\mathrm{tar}}$ 相匹配。目标率给出为 $R_a^{\\mathrm{tar}} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}$。重建的率为 $\\sum_p \\phi_p^{\\mathrm{corr}} \\Sigma_{a,p} A_p = \\phi_n^{\\mathrm{SPH}} \\sum_p s_p^{\\mathrm{corr}} \\Sigma_{a,p} A_p$。将两者相等可得：\n    $$\n    \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{corr}} \\Sigma_{a,p} = \\phi_n^{\\mathrm{SPH}} \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n    $$\n    假设 $\\phi_n^{\\mathrm{SPH}} \\neq 0$（这在物理上是必须的），我们可以将其简化为：\n    $$\n    \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p \\Sigma_{a,p} = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n    $$\n\n为了解决这个约束优化问题，我们采用拉格朗日乘子法。拉格朗日函数 $\\mathcal{L}$ 是：\n$$\n\\mathcal{L}(\\{f_p\\}, \\lambda_1, \\lambda_2) = \\sum_{p=1}^{P} A_p (f_p - 1)^2 - \\lambda_1 \\left( \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p - A_n \\right) - \\lambda_2 \\left( \\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} f_p \\Sigma_{a,p} - \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p} \\right)\n$$\n为了找到极值，我们将 $\\mathcal{L}$ 对每个 $f_p$ 的偏导数设为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial f_p} = 2 A_p (f_p - 1) - \\lambda_1 A_p s_p^{\\mathrm{lib}} - \\lambda_2 A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} = 0\n$$\n解出 $f_p$，我们得到：\n$$\nf_p = 1 + \\frac{\\lambda_1}{2} s_p^{\\mathrm{lib}} + \\frac{\\lambda_2}{2} s_p^{\\mathrm{lib}} \\Sigma_{a,p} = 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p})\n$$\n拉格朗日乘子 $\\lambda_1$ 和 $\\lambda_2$ 是通过将这个 $f_p$ 的表达式代回到两个约束方程中来确定的。\n\n对于第一个约束，已知库形状函数被归一化以至于 $\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} = A_n$：\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\left( 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p}) \\right) = A_n\n$$\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} = A_n\n$$\n$$\nA_n + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} = A_n\n$$\n这简化为关于 $\\lambda_1$ 和 $\\lambda_2$ 的一个线性方程：\n$$\n\\lambda_1 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\right) + \\lambda_2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} \\right) = 0\n$$\n\n对于第二个约束：\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} \\left( 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p}) \\right) = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n$$\n$$\n\\sum_{p=1}^{P} A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p} + \\frac{\\lambda_1}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} + \\frac{\\lambda_2}{2} \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2 = \\sum_{p=1}^{P} A_p s_p^{\\mathrm{ref}} \\Sigma_{a,p}\n$$\n这给出了第二个线性方程：\n$$\n\\lambda_1 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p} \\right) + \\lambda_2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2 \\right) = 2 \\left( \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{ref}} - s_p^{\\mathrm{lib}}) \\Sigma_{a,p} \\right)\n$$\n\n这两个方程构成了一个关于拉格朗日乘子向量 $\\boldsymbol{\\lambda} = [\\lambda_1, \\lambda_2]^T$ 的 $2 \\times 2$ 线性系统 $M \\boldsymbol{\\lambda} = \\mathbf{b}$：\n$$\n\\begin{pmatrix} M_{11}  M_{12} \\\\ M_{12}  M_{22} \\end{pmatrix}\n\\begin{pmatrix} \\lambda_1 \\\\ \\lambda_2 \\end{pmatrix}\n=\n\\begin{pmatrix} 0 \\\\ b_2 \\end{pmatrix}\n$$\n其中矩阵元素为：\n$M_{11} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2$\n$M_{12} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}$\n$M_{22} = \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{lib}})^2 \\Sigma_{a,p}^2$\n右侧项为：\n$b_2 = 2 \\sum_{p=1}^{P} A_p (s_p^{\\mathrm{ref}} - s_p^{\\mathrm{lib}}) \\Sigma_{a,p}$\n\n该系统可以求解出 $\\lambda_1$ 和 $\\lambda_2$，然后用它们来计算修正因子 $f_p$。一个特殊情况是如果矩阵 $M$ 是奇异的（即 $\\det(M)=0$），这发生在向量 $\\{A_p s_p^{\\mathrm{lib}}\\}_p$ 和 $\\{A_p s_p^{\\mathrm{lib}} \\Sigma_{a,p}\\}_p$ 线性相关时。例如，如果所有棒的 $\\Sigma_{a,p}$ 都相同，就会发生这种情况。在这种情况下，两个约束变得冗余，最小化问题简化，得到对所有 $p$ 都有 $f_p=1$。\n\n### 第2部分：棒功率与误差计算\n\n一旦找到修正后的形状函数 $s_p^{\\mathrm{corr}}$，各种棒功率的计算如下：\n- **参考棒功率**： $P_p^{\\mathrm{ref}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{ref}} \\Sigma_{f,p} A_p$\n- **SPH前重建棒功率**： $P_p^{\\mathrm{pre}} = \\phi_n^{\\mathrm{pre}} s_p^{\\mathrm{lib}} \\Sigma_{f,p} A_p$\n- **修正后SPH棒功率**： $P_p^{\\mathrm{SPH,corr}} = \\phi_n^{\\mathrm{SPH}} s_p^{\\mathrm{corr}} \\Sigma_{f,p} A_p$\n\n重建的棒功率分布 $\\{P_p^{(1)}\\}$ 相对于参考 $\\{P_p^{(2)}\\}$ 的误差由相对均方根（RMS）误差量化：\n$$\n\\varepsilon(\\{P_p^{(1)}\\}, \\{P_p^{(2)}\\}) = \\frac{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(1)} - P_p^{(2)}\\right)^2}}{\\sqrt{\\sum_{p=1}^{P} \\left(P_p^{(2)}\\right)^2}} = \\frac{\\| \\mathbf{P}^{(1)} - \\mathbf{P}^{(2)} \\|_2}{\\| \\mathbf{P}^{(2)} \\|_2}\n$$\n我们计算SPH前和修正后SPH情况相对于参考功率的误差：\n- **SPH前误差**： $\\varepsilon_{\\mathrm{pre}} = \\varepsilon(\\{P_p^{\\mathrm{pre}}\\}, \\{P_p^{\\mathrm{ref}}\\})$\n- **修正后SPH误差**： $\\varepsilon_{\\mathrm{corr}} = \\varepsilon(\\{P_p^{\\mathrm{SPH,corr}}\\}, \\{P_p^{\\mathrm{ref}}\\})$\n\n最终目标是计算通过完整的基于SPH的更新（包括节点通量和形状函数修正）所实现的误差减少量：\n$$\n\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}\n$$\n\n### 算法总结\n\n对每个测试用例，执行以下计算步骤：\n1.  组装给定的参数数组：$A_p, s_p^{\\mathrm{lib}}, s_p^{\\mathrm{ref}}, \\Sigma_{a,p}, \\Sigma_{f,p}$，以及标量 $\\phi_n^{\\mathrm{pre}}, \\phi_n^{\\mathrm{SPH}}$。\n2.  构造 $2 \\times 2$ 矩阵 $M$ 和右侧向量 $\\mathbf{b}$。\n3.  检查 $M$ 是否是奇异的。\n    - 如果非奇异，求解线性系统 $M \\boldsymbol{\\lambda} = \\mathbf{b}$ 得到 $\\lambda_1, \\lambda_2$。\n    - 如果是奇异的（如情况2），则约束是冗余的，最小扰动解为对所有 $p$ 都有 $f_p = 1$。这对应于 $\\lambda_1=0, \\lambda_2=0$。\n4.  计算修正因子 $f_p = 1 + \\frac{s_p^{\\mathrm{lib}}}{2} (\\lambda_1 + \\lambda_2 \\Sigma_{a,p})$。\n5.  计算修正后的形状函数 $s_p^{\\mathrm{corr}} = s_p^{\\mathrm{lib}} f_p$。\n6.  计算棒功率向量 $\\mathbf{P}^{\\mathrm{ref}}$, $\\mathbf{P}^{\\mathrm{pre}}$, 和 $\\mathbf{P}^{\\mathrm{SPH,corr}}$。\n7.  使用相对RMS误差公式计算误差 $\\varepsilon_{\\mathrm{pre}}$ 和 $\\varepsilon_{\\mathrm{corr}}$。\n8.  计算误差减少量 $\\Delta \\varepsilon = \\varepsilon_{\\mathrm{pre}} - \\varepsilon_{\\mathrm{corr}}$。\n\n此过程应用于所提供的三个测试用例中的每一个。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the pin power reconstruction problem for the given test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1 (general heterogeneous case)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([0.9, 1.1, 1.0, 1.0]),\n            \"s_ref\": np.array([0.8, 1.2, 1.05, 0.95]),\n            \"Sigma_a\": np.array([0.20, 0.15, 0.18, 0.17]),\n            \"Sigma_f\": np.array([0.25, 0.27, 0.26, 0.24]),\n            \"phi_pre\": 1.00,\n            \"phi_SPH\": 1.02,\n        },\n        # Case 2 (boundary case with uniform library shape and uniform absorption)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_ref\": np.array([0.95, 1.05, 1.10, 0.90]),\n            \"Sigma_a\": np.array([0.20, 0.20, 0.20, 0.20]),\n            \"Sigma_f\": np.array([0.24, 0.26, 0.25, 0.23]),\n            \"phi_pre\": 0.90,\n            \"phi_SPH\": 1.10,\n        },\n        # Case 3 (edge case with strong absorption heterogeneity)\n        {\n            \"P\": 4,\n            \"A_p\": np.array([1.0, 1.0, 1.0, 1.0]),\n            \"s_lib\": np.array([1.20, 0.80, 1.10, 0.90]),\n            \"s_ref\": np.array([1.10, 0.90, 1.20, 0.80]),\n            \"Sigma_a\": np.array([0.30, 0.10, 0.25, 0.12]),\n            \"Sigma_f\": np.array([0.27, 0.22, 0.28, 0.21]),\n            \"phi_pre\": 0.80,\n            \"phi_SPH\": 1.05,\n        },\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Unpack parameters\n        A_p = case[\"A_p\"]\n        s_lib = case[\"s_lib\"]\n        s_ref = case[\"s_ref\"]\n        Sigma_a = case[\"Sigma_a\"]\n        Sigma_f = case[\"Sigma_f\"]\n        phi_pre = case[\"phi_pre\"]\n        phi_SPH = case[\"phi_SPH\"]\n\n        # --- Part 1: Derive Correction Factors ---\n        # Construct the 2x2 system M*lambda = b for Lagrange multipliers\n        \n        M11 = np.sum(A_p * s_lib**2)\n        M12 = np.sum(A_p * (s_lib**2) * Sigma_a)\n        M22 = np.sum(A_p * (s_lib**2) * (Sigma_a**2))\n\n        M = np.array([[M11, M12], [M12, M22]])\n\n        b2 = 2 * np.sum(A_p * (s_ref - s_lib) * Sigma_a)\n        b = np.array([0.0, b2])\n\n        # Solve for lambda_1 and lambda_2\n        det_M = np.linalg.det(M)\n        if abs(det_M)  1e-15:\n            # Singular case: constraints are linearly dependent.\n            # The minimization objective is met at f_p=1, i.e., lambda_1=lambda_2=0.\n            lambda_1, lambda_2 = 0.0, 0.0\n        else:\n            lambdas = np.linalg.solve(M, b)\n            lambda_1, lambda_2 = lambdas[0], lambdas[1]\n\n        # Calculate correction factors f_p and corrected shape s_corr\n        f_p = 1.0 + (s_lib / 2.0) * (lambda_1 + lambda_2 * Sigma_a)\n        s_corr = s_lib * f_p\n        \n        # --- Part 2: Calculate Pin Powers and Errors ---\n\n        # Calculate pin power vectors\n        P_ref = phi_SPH * s_ref * Sigma_f * A_p\n        P_pre = phi_pre * s_lib * Sigma_f * A_p\n        P_sph_corr = phi_SPH * s_corr * Sigma_f * A_p\n\n        # Define RMS error function\n        def rms_error(P1, P2):\n            norm_diff = np.linalg.norm(P1 - P2)\n            norm_ref = np.linalg.norm(P2)\n            if norm_ref == 0:\n                return 0.0 if norm_diff == 0 else np.inf\n            return norm_diff / norm_ref\n\n        # Compute errors\n        eps_pre = rms_error(P_pre, P_ref)\n        eps_corr = rms_error(P_sph_corr, P_ref)\n\n        # Compute error reduction\n        delta_eps = eps_pre - eps_corr\n        results.append(delta_eps)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在理论上，将SPH因子定义为参考反应率与均匀化反应率之比是简洁而优雅的，但在实际的数值计算中，这种简单的定义可能非常脆弱。当均匀化反应率趋近于零时，该比值会变得不稳定，导致计算出的SPH因子出现剧烈振荡或无意义的值。本练习要求您识别出在反应堆物理中可能导致这种情况的真实场景，并从数值稳定性的角度评估不同的“正则化”策略，以确保计算的鲁棒性。 这项实践促使我们超越理想化的数学公式，直面真实世界中数值算法的挑战，这对于开发可靠的工程模拟软件至关重要。",
            "id": "4253882",
            "problem": "核反应堆堆芯中的一个粗网格均匀化节点通过超级均匀化 (Superhomogenization, SPH) 方法进行修正，以使每个能群中的节点积分反应率与高分辨率非均匀参考解的反应率相匹配。对于反应道 $x$（例如，裂变或吸收）和能群 $g$，定义节点体积 $V$ 上的非均匀反应率为\n$$\nR_{x,g}^{\\text{het}} \\equiv \\int_V \\Sigma_{x,g}^{\\text{het}}(\\mathbf{r}) \\, \\phi_g^{\\text{het}}(\\mathbf{r}) \\, \\mathrm{d}V,\n$$\n相应的均匀化反应率为\n$$\nR_{x,g}^{\\text{hom}} \\equiv \\int_V \\Sigma_{x,g}^{\\text{hom}} \\, \\phi_g^{\\text{hom}}(\\mathbf{r}) \\, \\mathrm{d}V.\n$$\nSPH修正因子 $F_{x,g}$ 假设在节点内是均匀的，并由以下约束条件隐式定义\n$$\nR_{x,g}^{\\text{het}} \\stackrel{!}{=} \\int_V F_{x,g} \\, \\Sigma_{x,g}^{\\text{hom}} \\, \\phi_g^{\\text{hom}}(\\mathbf{r}) \\, \\mathrm{d}V \\;=\\; F_{x,g} \\, R_{x,g}^{\\text{hom}}.\n$$\n因此，如果 $R_{x,g}^{\\text{hom}} \\neq 0$，一个自然的估计量是 $F_{x,g} = R_{x,g}^{\\text{het}}/R_{x,g}^{\\text{hom}}$。在实践中，$F_{x,g}$ 是通过迭代获得的，并且对 $R_{x,g}^{\\text{het}}$ 和 $R_{x,g}^{\\text{hom}}$ 中的数值噪声和模型误差很敏感。\n\n仅使用这些定义和反应率的基本性质（非负性、对截面和通量的线性关系），请指出在反应堆模拟中可能出现 $R_{x,g}^{\\text{het}} \\approx 0$ 的物理上可能的情形，解释为什么在这些情况下 SPH 问题会变得病态，并选择一种合适的正则化策略来解决病态问题，同时在主阶上保持全局平衡。可能有多个选项是正确的。\n\n选择正确的选项：\n\nA. 在一个不含易裂变核素的水反射层节点中，对于 $x=\\text{fission}$ 和任意能群 $g$，有 $R_{x,g}^{\\text{het}} \\approx 0$。SPH 约束 $R_{x,g}^{\\text{het}} = F_{x,g} R_{x,g}^{\\text{hom}}$ 变得病态，因为该约束退化为 $0 \\approx F_{x,g} \\, R_{x,g}^{\\text{hom}}$。如果 $R_{x,g}^{\\text{hom}} \\approx 0$，这会使 $F_{x,g}$ 不受约束；如果 $R_{x,g}^{\\text{hom}}$ 很小但不为零，这会使 $F_{x,g}$ 对 $R_{x,g}^{\\text{het}}$ 的微小扰动极其敏感。一种稳健的正则化方法是用一个平滑估计量替换该比率\n$$\nF_{x,g}^{(\\varepsilon)} \\;=\\; \\frac{R_{x,g}^{\\text{het}} + \\varepsilon}{R_{x,g}^{\\text{hom}} + \\varepsilon},\n$$\n其中 $\\varepsilon > 0$ 的选择相对于典型的非零节点积分反应率要小，但相对于数值噪声要大，从而使约束保留有限的信息量。\n\nB. 在寿期初具有热化谱的新 $\\mathrm{UO}_2$ 燃料节点中，对于热群 $g=2$ 中的吸收反应 $x=\\text{absorption}$，有 $R_{x,2}^{\\text{het}} \\approx 0$，因为慢化剂吸收了大部分热中子。SPH 约束不是病态的，因此不推荐进行正则化。\n\nC. 在一个含高浓度溶解硼的含硼水慢化剂节点中，对于快群 $g=1$ 中的移出反应 $x=\\text{removal}$，有 $R_{x,1}^{\\text{het}} \\approx 0$，因为在轻水中，快能区的散射可以忽略不计。SPH 约束是病态的，推荐的补救措施是完全消除能群 $g=1$ 的 $x=\\text{removal}$ 约束。\n\nD. 在一个重水反射层节点中，对于快群 $g=1$ 中的吸收反应 $x=\\text{absorption}$，可能有 $R_{x,1}^{\\text{het}} \\approx 0$，因为在该能群中，宏观吸收截面比散射截面小几个数量级。这会导致病态，因为该约束提供的关于 $F_{x,1}$ 的信息很少，并且会放大测量或迭代噪声。一种有原则的正则化方法是求解带 Tikhonov 惩罚项的约束条件的加权最小二乘拟合，\n$$\n\\min_{\\{F_{x,g}\\}} \\;\\sum_{x,g} w_{x,g} \\,\\big(F_{x,g} R_{x,g}^{\\text{hom}} - R_{x,g}^{\\text{het}}\\big)^2 \\;+\\; \\alpha \\sum_{x,g} (F_{x,g}-1)^2,\n$$\n其中 $w_{x,g} = 1/(R_{x,g}^{\\text{het}}+\\varepsilon)^2$ 对接近零的目标进行降权，而当约束无信息量时，$\\alpha0$ 将 $F_{x,g}$ 锚定在 1 附近，从而在主阶上保持全局平衡。\n\nE. 在任何邻近反射边界的节点中，对于任何 $x$ 和 $g$，总是有 $R_{x,g}^{\\text{het}} \\approx 0$，因为反射边界会抑制反应率。因此，SPH 约束是病态的，正确的补救措施是在所有邻近边界的节点中强制令 $F_{x,g} \\equiv 1$。",
            "solution": "用户需要对问题陈述进行批判性验证，然后是详细的解答和对所提供选项的评估。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n- 反应道 $x$ 和能群 $g$ 在节点体积 $V$ 上的非均匀反应率：$R_{x,g}^{\\text{het}} \\equiv \\int_V \\Sigma_{x,g}^{\\text{het}}(\\mathbf{r}) \\, \\phi_g^{\\text{het}}(\\mathbf{r}) \\, \\mathrm{d}V$。\n- 均匀化反应率：$R_{x,g}^{\\text{hom}} \\equiv \\int_V \\Sigma_{x,g}^{\\text{hom}} \\, \\phi_g^{\\text{hom}}(\\mathbf{r}) \\, \\mathrm{d}V$。\n- SPH 修正因子 $F_{x,g}$ 在节点内是均匀的。\n- SPH 约束：$R_{x,g}^{\\text{het}} \\stackrel{!}{=} \\int_V F_{x,g} \\, \\Sigma_{x,g}^{\\text{hom}} \\, \\phi_g^{\\text{hom}}(\\mathbf{r}) \\, \\mathrm{d}V = F_{x,g} \\, R_{x,g}^{\\text{hom}}$。\n- SPH 因子的估计量：$F_{x,g} = R_{x,g}^{\\text{het}}/R_{x,g}^{\\text{hom}}$ (对于 $R_{x,g}^{\\text{hom}} \\neq 0$)。\n- 反应率的基本性质：非负性、对截面和通量的线性关系。\n- 任务是指出可能出现 $R_{x,g}^{\\text{het}} \\approx 0$ 的物理上可能的情形，解释由此产生的病态问题，并选择合适的正则化策略。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据：** 问题陈述牢固地植根于核反应堆物理和计算方法领域。超级均匀化 (SPH) 是一种标准的、有详细文档记录的技术，通过保持来自更高保真度输运解的反应率来提高粗网格节点计算的准确性。反应率和 SPH 因子的定义是标准的。除以近零量导致的病态问题是数值分析中的一个基本概念。各项前提都是科学合理的。\n- **适定性：** 识别病态场景和评估正则化方法的问题是适定的。它要求将已建立的物理原理和数值推理应用于给定的框架。\n- **客观性：** 语言技术性强、精确，并且没有主观或模棱两可的术语。\n- **其他标准：** 问题是自洽的，没有矛盾，并且与 SPH 方法的主题直接相关。它在应用物理和数值方法方面提出了一个不平凡的挑战。\n\n**步骤3：结论与行动**\n问题陈述有效。我将继续进行解答。\n\n### 解答推导与选项分析\n\n问题的核心在于 SPH 约束方程 $R_{x,g}^{\\text{het}} = F_{x,g} R_{x,g}^{\\text{hom}}$。因子 $F_{x,g}$ 计算为比率 $F_{x,g} = R_{x,g}^{\\text{het}} / R_{x,g}^{\\text{hom}}$。当分母 $R_{x,g}^{\\text{hom}}$ 非常接近于零时，就会出现病态。在实践中，由于数值噪声和模型差异，参考率 $R_{x,g}^{\\text{het}}$ 也会是一个小的非零数。两个小的、带噪声的数的比率在数值上是不稳定的，并且对扰动高度敏感，导致 $F_{x,g}$ 出现大的、非物理的波动。一个稳健的方法必须能稳定这个计算。\n\n任务是根据以下几点来评估每个选项：\n1.  导致 $R_{x,g}^{\\text{het}} \\approx 0$ 的场景的物理合理性。\n2.  病态分析的正确性。\n3.  所提出的正则化策略的适当性。\n\n**选项 A 分析**\n- **场景：** 一个水反射层节点（包含像 $\\text{H}_2\\text{O}$ 这样的材料，但不含易裂变同位素），用于裂变反应 ($x=\\text{fission}$)。\n- **合理性：** 根据定义，反射层材料不含易裂变核素（例如 $^{\\text{235}}\\text{U}$、$^{239}\\text{Pu}$）。因此，宏观裂变截面 $\\Sigma_{\\text{fission},g}^{\\text{het}}(\\mathbf{r})$ 在反射层节点体积 $V$ 内处处恒等于零。因此，积分的非均匀裂变率 $R_{\\text{fission},g}^{\\text{het}} = \\int_V 0 \\cdot \\phi_g^{\\text{het}}(\\mathbf{r}) \\, \\mathrm{d}V = 0$。在实际模拟中，由于数值噪声，该值可能是一个小的非零数，因此 $R_{x,g}^{\\text{het}} \\approx 0$ 是一个物理上正确且确定的场景。\n- **病态性：** 均匀化裂变截面 $\\Sigma_{\\text{fission},g}^{\\text{hom}}$ 也将为零，因为它是 $\\Sigma_{\\text{fission},g}^{\\text{het}}$ 的体积平均值。这使得 $R_{\\text{fission},g}^{\\text{hom}} = 0$。SPH 约束变为 $0 = F_{\\text{fission},g} \\cdot 0$，这对任何有限的 $F_{\\text{fission},g}$ 值都成立。该因子完全不受约束。如果数值噪声使 $R_{\\text{fission},g}^{\\text{het}}$ 和 $R_{\\text{fission},g}^{\\text{hom}}$ 成为小的非零数，它们的比率会变得不稳定。这个解释是正确的。\n- **正则化：** 所提出的估计量是 $F_{x,g}^{(\\varepsilon)} = (R_{x,g}^{\\text{het}} + \\varepsilon)/(R_{x,g}^{\\text{hom}} + \\varepsilon)$。对于所述情况，其中 $R^{\\text{het}}$ 和 $R^{\\text{hom}}$ 都近似为零，这给出 $F_{x,g}^{(\\varepsilon)} \\approx \\varepsilon/\\varepsilon = 1$。这是一个稳定且物理上合理的结果；它表明，如果不发生反应，则不需要修正 ($F=1$)。这种形式的正则化，被称为加法平滑或伪计数，能有效防止除以零并稳定估计量。如文中所述，$\\varepsilon$ 的选择是偏差和方差之间的一种权衡。\n- **结论：** 正确。\n\n**选项 B 分析**\n- **场景：** 一个新$\\text{UO}_2$燃料节点，用于热吸收 ($x=\\text{absorption}$，$g=\\text{thermal}$)。\n- **合理性：** 该陈述声称 $R_{\\text{absorption},2}^{\\text{het}} \\approx 0$，因为慢化剂吸收了大部分热中子。这在根本上是错误的。在热中子反应堆中，燃料的主要目的是吸收热中子以引起裂变。$^{\\text{235}}\\text{U}$ 和 $^{\\text{238}}\\text{U}$ 都具有显著的热吸收截面。燃料节点中的热中子吸收率是整个反应堆堆芯中最大和最重要的反应率之一，远非近似为零。虽然慢化剂也吸收一些中子，但在燃料-慢化剂栅元内，大部分吸收发生在燃料中。\n- **结论：** 不正确。其物理前提在事实上是不成立的。\n\n**选项 C 分析**\n- **场景：** 一个含硼水慢化剂节点，用于快群移出 ($x=\\text{removal}$，$g=\\text{fast}$)。\n- **合理性：** 从能群 $g$ 的移出截面 $\\Sigma_{R,g}$ 代表了所有将中子从该能群中移出的过程，即吸收和移出散射：$\\Sigma_{R,g} = \\Sigma_{a,g} + \\sum_{g' \\neq g} \\Sigma_{s, g \\to g'}$. 对于最快的能群 ($g=1$)，这主要是散射到较低能群（慢化）。该陈述声称移出率接近于零，因为“在轻水中，快能区的散射可以忽略不计”。这是大错特错的。轻水 ($\\text{H}_2\\text{O}$) 是一种优良的慢化剂，正是因为其氢核对快中子有非常大的散射截面，导致高效的能量损失。在水中，由于散射导致的快群移出率非常高，不可忽略。\n- **结论：** 不正确。其物理前提在事实上是不成立的。\n\n**选项 D 分析**\n- **场景：** 一个重水 ($\\text{D}_2\\text{O}$) 反射层节点，用于快群吸收 ($x=\\text{absorption}$，$g=\\text{fast}$)。\n- **合理性：** 选择重水作为慢化剂/反射层是因为其在整个能谱上具有极低的中子吸收截面。虽然快中子在 $\\text{D}_2\\text{O}$ 中的主要相互作用是散射（慢化），但吸收仍然会发生，只是速率非常低。因此，$\\Sigma_{a,1}^{\\text{het}}$ 比散射截面小几个数量级。由此产生的反应率 $R_{a,1}^{\\text{het}}$ 将比其他主要反应率（如散射率）小得多。前提 $R_{a,1}^{\\text{het}} \\approx 0$ 在物理上是合理的。\n- **病态性：** 与情况 A 一样，一个非常小的目标反应率 $R_{a,1}^{\\text{het}}$ 和一个相应也很小的均匀化率 $R_{a,1}^{\\text{hom}}$ 导致了病态的比率 $F_{a,1} = R_{a,1}^{\\text{het}}/R_{a,1}^{\\text{hom}}$，这会放大数值噪声。该分析是正确的。\n- **正则化：** 所提出的方法是一种 Tikhonov 正则化的加权最小二乘拟合。\n$$ \\min_{\\{F_{x,g}\\}} \\;\\sum_{x,g} w_{x,g} \\,\\big(F_{x,g} R_{x,g}^{\\text{hom}} - R_{x,g}^{\\text{het}}\\big)^2 \\;+\\; \\alpha \\sum_{x,g} (F_{x,g}-1)^2 $$\n这是处理病态反问题的标准而强大的技术。\n    1.  加权因子 $w_{x,g} = 1/(R_{x,g}^{\\text{het}}+\\varepsilon)^2$ 正确地对无信息量的约束（即目标 $R_{x,g}^{\\text{het}}$ 接近零的约束）进行降权，减少它们对解的影响。\n    2.  Tikhonov 惩罚项 $\\alpha \\sum_{x,g} (F_{x,g}-1)^2$ 在数据项提供信息很少时，使解偏向于 $F_{x,g} = 1$。这在物理上是合理的，因为 $F_{x,g}=1$ 对应于使用未修正的均匀化截面，当没有可靠的修正可用时，这是最佳估计。\n该策略是稳健、有原则且描述正确的。\n- **结论：** 正确。\n\n**选项 E 分析**\n- **场景：** 任何邻近反射边界的节点。\n- **合理性：** 该陈述声称，对于任何邻近反射边界的节点，所有反应率都近似为零。在中子扩散理论中，反射边界条件 $\\mathbf{J} \\cdot \\mathbf{\\hat{n}} = 0$ 模拟的是一个对称面。它意味着垂直于边界的通量梯度为零。这种情况通常发生在对称反应堆堆芯的中心，那里的中子通量处于其*最大值*，而不是零。因此，与通量成正比的反应率 ($\\text{Rate} = \\Sigma \\phi$) 在这些中心节点中将是最高的。其物理前提与现实恰恰相反。\n- **结论：** 不正确。其物理前提在事实上是不成立的。",
            "answer": "$$\\boxed{AD}$$"
        }
    ]
}