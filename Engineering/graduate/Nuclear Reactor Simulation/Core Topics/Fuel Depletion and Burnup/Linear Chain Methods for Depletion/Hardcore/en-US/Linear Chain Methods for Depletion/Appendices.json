{
    "hands_on_practices": [
        {
            "introduction": "While the classic Bateman equations elegantly describe pure radioactive decay, the environment inside a nuclear reactor includes intense neutron fields that drive transmutation reactions. This practice extends the fundamental decay chain model to incorporate these neutron-induced processes. You will derive the governing equations from first principles, revealing that the elegant mathematical structure of the solution is preserved, with decay constants generalized into total removal rates and production coefficients expanded to include reaction-based pathways . Mastering this derivation solidifies your understanding of the linear system that forms the analytical core of modern depletion and burnup codes.",
            "id": "4233533",
            "problem": "Consider a linear transmutation-decay chain of three nuclides, labeled $1 \\to 2 \\to 3$, evolving under a time-independent, one-energy-group neutron flux $\\phi$ in a homogeneous medium. Each nuclide $i \\in \\{1,2,3\\}$ undergoes radioactive decay with decay constant $\\lambda_i$ and neutron-induced removal with microscopic cross section $\\sigma_{i,r}$, so that the total per-nucleus removal rate is $\\alpha_i \\equiv \\lambda_i + \\phi \\sigma_{i,r}$. Production along the chain occurs only from $1$ to $2$ and from $2$ to $3$ (no direct production from $1$ to $3$), with effective link rates defined as $p_{12} \\equiv \\beta_{1\\to 2}\\lambda_1 + \\phi \\sigma_{1\\to 2}$ and $p_{23} \\equiv \\beta_{2\\to 3}\\lambda_2 + \\phi \\sigma_{2\\to 3}$, where $\\beta_{i\\to i+1}$ is the decay branching fraction into the chain and $\\sigma_{i\\to i+1}$ is the microscopic cross section for the neutron reaction that transmutes $i$ to $i+1$. Assume $\\phi$, all $\\lambda_i$, all $\\sigma_{i,r}$, and all $\\sigma_{i\\to i+1}$ are constants in time, and assume $\\alpha_1$, $\\alpha_2$, and $\\alpha_3$ are pairwise distinct. The initial nuclide amounts at time $t=0$ are $N_1(0)$, $N_2(0)$, and $N_3(0)$.\n\nStarting only from the fundamental population balance principle for each nuclide—namely, that the rate of change equals the total production into the nuclide minus the total removal out of it—derive the coupled linear Ordinary Differential Equations (ODEs) governing $N_1(t)$, $N_2(t)$, and $N_3(t)$. Using these ODEs, show that the presence of neutron-induced transmutation modifies the structure of the classical Bateman coefficients by replacing the purely radioactive decay constants with the total removal rates $\\alpha_i$ in all exponential factors and partial-fraction denominators. Then, explicitly compute the modified Bateman coefficients $C_1(t)$, $C_2(t)$, and $C_3(t)$, defined by the representation\n$$\nN_3(t) \\equiv C_1(t)\\,N_1(0) + C_2(t)\\,N_2(0) + C_3(t)\\,N_3(0),\n$$\nexpressed in terms of $t$, $\\alpha_i$, and $p_{ij}$. You may assume no other production or loss pathways beyond those specified. Provide your final result as a closed-form analytic expression for the row vector $(C_1(t),\\,C_2(t),\\,C_3(t))$. No numerical rounding is required, and no units need be reported for the final expression.",
            "solution": "The problem is first validated according to the specified criteria.\n\n### Step 1: Extract Givens\n-   **Nuclide Chain:** A linear chain of three nuclides, $1 \\to 2 \\to 3$.\n-   **Neutron Flux:** $\\phi$, constant and time-independent.\n-   **Decay Constant:** $\\lambda_i$ for nuclide $i \\in \\{1,2,3\\}$.\n-   **Microscopic Removal Cross Section:** $\\sigma_{i,r}$ for nuclide $i$.\n-   **Total Per-Nucleus Removal Rate:** $\\alpha_i \\equiv \\lambda_i + \\phi \\sigma_{i,r}$ for nuclide $i$.\n-   **Effective Link Rates:**\n    -   $p_{12} \\equiv \\beta_{1\\to 2}\\lambda_1 + \\phi \\sigma_{1\\to 2}$\n    -   $p_{23} \\equiv \\beta_{2\\to 3}\\lambda_2 + \\phi \\sigma_{2\\to 3}$\n-   **Decay Branching Fraction:** $\\beta_{i\\to i+1}$.\n-   **Microscopic Transmutation Cross Section:** $\\sigma_{i\\to i+1}$.\n-   **Constraints:** All parameters ($\\phi$, $\\lambda_i$, $\\sigma_{i,r}$, $\\sigma_{i\\to i+1}$) are constant. The removal rates $\\alpha_1$, $\\alpha_2$, and $\\alpha_3$ are pairwise distinct.\n-   **Initial Conditions:** Nuclide amounts at time $t=0$ are $N_1(0)$, $N_2(0)$, and $N_3(0)$.\n-   **Objective:** Derive the governing ODEs and find the coefficients $C_1(t)$, $C_2(t)$, and $C_3(t)$ in the expression $N_3(t) = C_1(t)N_1(0) + C_2(t)N_2(0) + C_3(t)N_3(0)$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded:** The problem describes nuclear transmutation and decay using the standard depletion equations (also known as Bateman equations, generalized for burnup). This is a fundamental and well-established model in nuclear reactor physics and engineering. The definitions of removal rates and production pathways are standard. The problem is scientifically sound.\n-   **Well-Posed:** The problem is to solve a system of coupled linear first-order ordinary differential equations with constant coefficients and specified initial conditions. This constitutes a well-posed initial value problem, which guarantees a unique and stable solution. The explicit condition that $\\alpha_1$, $\\alpha_2$, and $\\alpha_3$ are pairwise distinct ensures that the denominators in the standard solution form are non-zero, which is critical for the method employed.\n-   **Objective:** The problem statement uses precise, unambiguous mathematical and physical terminology. All quantities are formally defined. There are no subjective or opinion-based components.\n\n### Step 3: Verdict and Action\nThe problem is scientifically sound, well-posed, objective, and self-contained. It is a valid problem. The solution process may proceed.\n\n### Derivation of the Governing ODEs\n\nThe evolution of the nuclide concentrations $N_i(t)$ is governed by the population balance principle: the time rate of change of a nuclide's population is equal to its total production rate minus its total removal rate.\n\nFor nuclide $1$:\n-   Production Rate: $0$ (it is the start of the chain).\n-   Removal Rate: This occurs via radioactive decay (rate $\\lambda_1 N_1$) and neutron-induced reactions (rate $\\phi \\sigma_{1,r} N_1$). The total removal rate is $(\\lambda_1 + \\phi \\sigma_{1,r}) N_1 = \\alpha_1 N_1$.\n-   The ODE for $N_1(t)$ is:\n    $$ \\frac{dN_1}{dt} = - \\alpha_1 N_1(t) $$\n\nFor nuclide $2$:\n-   Production Rate: Nuclide $2$ is produced from nuclide $1$. The production rate is the sum of the rate from decay of nuclide $1$ ($\\beta_{1\\to 2}\\lambda_1 N_1$) and the rate from neutron transmutation of nuclide $1$ ($\\phi \\sigma_{1\\to 2} N_1$). The total production rate is $(\\beta_{1\\to 2}\\lambda_1 + \\phi \\sigma_{1\\to 2}) N_1 = p_{12} N_1$.\n-   Removal Rate: Similar to nuclide $1$, the total removal rate is $(\\lambda_2 + \\phi \\sigma_{2,r}) N_2 = \\alpha_2 N_2$.\n-   The ODE for $N_2(t)$ is:\n    $$ \\frac{dN_2}{dt} = p_{12} N_1(t) - \\alpha_2 N_2(t) $$\n\nFor nuclide $3$:\n-   Production Rate: Nuclide $3$ is produced from nuclide $2$ at a total rate of $(\\beta_{2\\to 3}\\lambda_2 + \\phi \\sigma_{2\\to 3}) N_2 = p_{23} N_2$.\n-   Removal Rate: The total removal rate is $(\\lambda_3 + \\phi \\sigma_{3,r}) N_3 = \\alpha_3 N_3$.\n-   The ODE for $N_3(t)$ is:\n    $$ \\frac{dN_3}{dt} = p_{23} N_2(t) - \\alpha_3 N_3(t) $$\n\nThese three equations form a system of coupled, linear first-order ODEs.\n\n### Solution of the ODEs and Derivation of Coefficients\n\nThe system is linear, so the solution can be expressed as a linear combination of the initial conditions, $N_3(t) = C_1(t)N_1(0) + C_2(t)N_2(0) + C_3(t)N_3(0)$. We can find each coefficient $C_i(t)$ by solving the system for the case where only the corresponding initial condition $N_i(0)$ is non-zero, a direct application of the principle of superposition.\n\n**1. Derivation of $C_3(t)$**\nAssume initial conditions $N_1(0)=0$, $N_2(0)=0$, and $N_3(0) \\neq 0$. The system simplifies significantly. $N_1(t)=0$ and $N_2(t)=0$ for all $t \\ge 0$. The equation for $N_3(t)$ becomes:\n$$ \\frac{dN_3}{dt} = - \\alpha_3 N_3(t) $$\nWith the initial condition $N_3(0)$, the solution is:\n$$ N_3(t) = N_3(0) \\exp(-\\alpha_3 t) $$\nBy definition, this solution is $C_3(t)N_3(0)$, so:\n$$ C_3(t) = \\exp(-\\alpha_3 t) $$\n\n**2. Derivation of $C_2(t)$**\nAssume initial conditions $N_1(0)=0$, $N_2(0) \\neq 0$, and $N_3(0)=0$.\nThe equation for $N_2(t)$ is $\\frac{dN_2}{dt} = -\\alpha_2 N_2(t)$, which gives $N_2(t) = N_2(0)\\exp(-\\alpha_2 t)$.\nThe equation for $N_3(t)$ becomes a non-homogeneous linear ODE:\n$$ \\frac{dN_3}{dt} + \\alpha_3 N_3(t) = p_{23} N_2(t) = p_{23} N_2(0) \\exp(-\\alpha_2 t) $$\nUsing the integrating factor $I(t) = \\exp(\\int \\alpha_3 dt) = \\exp(\\alpha_3 t)$, we get:\n$$ \\frac{d}{dt}(N_3(t) \\exp(\\alpha_3 t)) = p_{23} N_2(0) \\exp(-\\alpha_2 t) \\exp(\\alpha_3 t) = p_{23} N_2(0) \\exp((\\alpha_3 - \\alpha_2)t) $$\nIntegrating from $0$ to $t$ and using the initial condition $N_3(0)=0$:\n$$ N_3(t) \\exp(\\alpha_3 t) = \\int_0^t p_{23} N_2(0) \\exp((\\alpha_3 - \\alpha_2)\\tau) d\\tau = p_{23} N_2(0) \\left[ \\frac{\\exp((\\alpha_3 - \\alpha_2)\\tau)}{\\alpha_3 - \\alpha_2} \\right]_0^t $$\nThe condition $\\alpha_2 \\neq \\alpha_3$ is used here.\n$$ N_3(t) \\exp(\\alpha_3 t) = p_{23} N_2(0) \\frac{\\exp((\\alpha_3 - \\alpha_2)t) - 1}{\\alpha_3 - \\alpha_2} $$\nMultiplying by $\\exp(-\\alpha_3 t)$:\n$$ N_3(t) = p_{23} N_2(0) \\frac{\\exp(-\\alpha_2 t) - \\exp(-\\alpha_3 t)}{\\alpha_3 - \\alpha_2} $$\nTherefore, the coefficient $C_2(t)$ is:\n$$ C_2(t) = p_{23} \\frac{\\exp(-\\alpha_2 t) - \\exp(-\\alpha_3 t)}{\\alpha_3 - \\alpha_2} $$\n\n**3. Derivation of $C_1(t)$**\nAssume initial conditions $N_1(0) \\neq 0$, $N_2(0)=0$, and $N_3(0)=0$.\nFirst, solve for $N_1(t)$: $N_1(t) = N_1(0) \\exp(-\\alpha_1 t)$.\nNext, solve for $N_2(t)$:\n$$ \\frac{dN_2}{dt} + \\alpha_2 N_2(t) = p_{12} N_1(0) \\exp(-\\alpha_1 t) $$\nUsing the integrating factor $\\exp(\\alpha_2 t)$ and initial condition $N_2(0)=0$, the solution is:\n$$ N_2(t) = p_{12} N_1(0) \\frac{\\exp(-\\alpha_1 t) - \\exp(-\\alpha_2 t)}{\\alpha_2 - \\alpha_1} $$\nNow, solve for $N_3(t)$:\n$$ \\frac{dN_3}{dt} + \\alpha_3 N_3(t) = p_{23} N_2(t) = p_{23} p_{12} N_1(0) \\frac{\\exp(-\\alpha_1 t) - \\exp(-\\alpha_2 t)}{\\alpha_2 - \\alpha_1} $$\nUsing the integrating factor $\\exp(\\alpha_3 t)$ and $N_3(0)=0$:\n$$ N_3(t)\\exp(\\alpha_3 t) = \\frac{p_{23} p_{12} N_1(0)}{\\alpha_2-\\alpha_1} \\int_0^t \\left( \\exp((\\alpha_3-\\alpha_1)\\tau) - \\exp((\\alpha_3-\\alpha_2)\\tau) \\right) d\\tau $$\n$$ N_3(t)\\exp(\\alpha_3 t) = \\frac{p_{23} p_{12} N_1(0)}{\\alpha_2-\\alpha_1} \\left( \\frac{\\exp((\\alpha_3-\\alpha_1)t)-1}{\\alpha_3-\\alpha_1} - \\frac{\\exp((\\alpha_3-\\alpha_2)t)-1}{\\alpha_3-\\alpha_2} \\right) $$\nMultiplying by $\\exp(-\\alpha_3 t)$ and rearranging gives:\n$$ N_3(t) = \\frac{p_{23} p_{12} N_1(0)}{\\alpha_2-\\alpha_1} \\left( \\frac{\\exp(-\\alpha_1 t) - \\exp(-\\alpha_3 t)}{\\alpha_3-\\alpha_1} - \\frac{\\exp(-\\alpha_2 t) - \\exp(-\\alpha_3 t)}{\\alpha_3-\\alpha_2} \\right) $$\nTo obtain the standard symmetric Bateman form, we collect terms with the same exponential factor:\n$$ C_1(t) = p_{12} p_{23} \\left[ \\frac{\\exp(-\\alpha_1 t)}{(\\alpha_2-\\alpha_1)(\\alpha_3-\\alpha_1)} + \\frac{\\exp(-\\alpha_2 t)}{(\\alpha_1-\\alpha_2)(\\alpha_3-\\alpha_2)} + \\frac{\\exp(-\\alpha_3 t)}{(\\alpha_1-\\alpha_3)(\\alpha_2-\\alpha_3)} \\right] $$\nThis expression for $C_1(t)$ demonstrates the modified structure requested. Compared to the classical Bateman equation for pure radioactive decay, the decay constants $\\lambda_i$ are replaced by the total removal rates $\\alpha_i = \\lambda_i + \\phi \\sigma_{i,r}$ in all exponential terms and denominators. Furthermore, the intermediate production terms, which would be simple decay constants (or branching fractions times decay constants), are replaced by the effective link rates $p_{ij} = \\beta_{i\\to i+1}\\lambda_i + \\phi \\sigma_{i\\to i+1}$, which account for production by both decay and neutron capture.\n\nThe final result is the row vector of these three coefficients.",
            "answer": "$$ \\boxed{\\begin{pmatrix} p_{12} p_{23} \\left( \\frac{\\exp(-\\alpha_1 t)}{(\\alpha_2-\\alpha_1)(\\alpha_3-\\alpha_1)} + \\frac{\\exp(-\\alpha_2 t)}{(\\alpha_1-\\alpha_2)(\\alpha_3-\\alpha_2)} + \\frac{\\exp(-\\alpha_3 t)}{(\\alpha_1-\\alpha_3)(\\alpha_2-\\alpha_3)} \\right) & p_{23} \\frac{\\exp(-\\alpha_2 t) - \\exp(-\\alpha_3 t)}{\\alpha_3 - \\alpha_2} & \\exp(-\\alpha_3 t) \\end{pmatrix}} $$"
        },
        {
            "introduction": "Analytical solutions provide deep physical insight, but practical reactor analysis relies on numerical methods to handle complex geometries and evolving conditions. A critical skill for any computational scientist is verifying that a numerical code correctly implements its underlying mathematical model. This exercise  provides direct, hands-on experience with this process by tasking you with implementing a simple numerical solver and comparing its results against a known analytic solution. By quantifying the error using standard norms, you will gain a practical appreciation for how numerical parameters, such as the time step $\\Delta t$, influence the accuracy and stability of a simulation.",
            "id": "4233519",
            "problem": "Consider a three-nuclide linear transmutation-decay chain representative of depletion in nuclear reactor simulation. Let the number density vector be $y(t) = \\begin{bmatrix} N_1(t) \\\\ N_2(t) \\\\ N_3(t) \\end{bmatrix}$, where $N_i(t)$ denotes the atomic number density of nuclide $i$ in atoms per cubic centimeter. The evolution is governed by an Ordinary Differential Equation (ODE) with constant coefficients and a constant source term for the first nuclide:\n$$\n\\frac{d}{dt} y(t) = A\\,y(t) + s,\n$$\nwhere\n$$\nA = \\begin{bmatrix}\n-\\lambda_1 & 0 & 0 \\\\\nb_1 \\lambda_1 & -\\lambda_2 & 0 \\\\\n0 & b_2 \\lambda_2 & -\\lambda_3\n\\end{bmatrix}, \\quad\ns = \\begin{bmatrix} q \\\\ 0 \\\\ 0 \\end{bmatrix}.\n$$\nHere, $\\lambda_i$ are constant removal rates in $\\mathrm{s}^{-1}$ that may include both radioactive decay and effective neutron-induced removal (e.g., absorption), $b_1$ and $b_2$ are branching yields for transfer to the next nuclide in the chain (dimensionless), and $q$ is a constant external production rate of nuclide $1$ in atoms per cubic centimeter per second. Time $t$ is measured in seconds. Assume the initial condition $y(0) = y_0$ is specified.\n\nTask:\n1. Starting from the fundamental definition of a linear time-invariant system and the principle of superposition, derive the analytic solution $y(t)$ to the system with constant matrix $A$ and constant source $s$. Do not use pre-stated shortcut formulas; derive the expression from first principles by considering the homogeneous and particular solutions and combining them using variation of constants.\n2. Design a first-order numerical implementation that updates the chain sequentially using the linear chain method with explicit time marching over a fixed time step $\\Delta t$. Within each time step, update nuclide $1$ using its removal and source, then update nuclide $2$ using the outflow from nuclide $1$ computed with the values from the beginning of the step, and finally update nuclide $3$ using the outflow from nuclide $2$ computed with the values from the beginning of the step. This explicit sequential update must use the parent’s pre-update values in each sub-step.\n3. For each case in the test suite below, compute the final state $y(T)$ at final time $T$ using both the analytic solution and the numerical implementation, and compute two error norms across the three nuclides at $t=T$: the relative $L^2$ norm and the relative $L^\\infty$ norm, defined as\n$$\nE_2 = \\frac{\\|y_{\\text{num}}(T) - y_{\\text{exact}}(T)\\|_2}{\\|y_{\\text{exact}}(T)\\|_2}, \\quad\nE_\\infty = \\frac{\\|y_{\\text{num}}(T) - y_{\\text{exact}}(T)\\|_\\infty}{\\|y_{\\text{exact}}(T)\\|_\\infty}.\n$$\nBoth $E_2$ and $E_\\infty$ are dimensionless.\n4. Your program must implement this procedure and produce a single line of output containing the results as a comma-separated list enclosed in square brackets of the form $[E_2^{(1)},E_\\infty^{(1)},E_2^{(2)},E_\\infty^{(2)},\\dots]$, where the superscript indicates the test case index.\n\nPhysical and numerical units:\n- Time $t$ must be in seconds.\n- Removal rates $\\lambda_i$ must be in $\\mathrm{s}^{-1}$.\n- The source $q$ must be in atoms per cubic centimeter per second.\n- Number densities $N_i(t)$ must be in atoms per cubic centimeter.\n- The error norms must be dimensionless.\n\nTest suite:\n- Case $1$ (happy path, moderate time step): $\\lambda_1 = 0.02$, $\\lambda_2 = 0.15$, $\\lambda_3 = 10^{-6}$, $b_1 = 1$, $b_2 = 1$, $q = 10^{19}$, $y_0 = \\begin{bmatrix} 2\\times 10^{20} \\\\ 0 \\\\ 0 \\end{bmatrix}$, $\\Delta t = 0.5$, $T = 10$.\n- Case $2$ (small time step boundary): identical parameters to Case $1$ but $\\Delta t = 0.01$ and $T = 10$.\n- Case $3$ (large time step stress): identical parameters to Case $1$ but $\\Delta t = 2.0$ and $T = 10$.\n- Case $4$ (stiff chain): $\\lambda_1 = 5.0$, $\\lambda_2 = 0.05$, $\\lambda_3 = 10^{-5}$, $b_1 = 1$, $b_2 = 1$, $q = 10^{19}$, $y_0 = \\begin{bmatrix} 10^{19} \\\\ 2\\times 10^{18} \\\\ 0 \\end{bmatrix}$, $\\Delta t = 0.1$, $T = 10$.\n- Case $5$ (near-degenerate equal rates): $\\lambda_1 = 0.1$, $\\lambda_2 = 0.1$, $\\lambda_3 = 0.1$, $b_1 = 1$, $b_2 = 1$, $q = 5\\times 10^{18}$, $y_0 = \\begin{bmatrix} 10^{20} \\\\ 5\\times 10^{19} \\\\ 0 \\end{bmatrix}$, $\\Delta t = 0.5$, $T = 10$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,\\dots]$). Each $result_i$ must be a floating-point number corresponding to the specified error norms for each test case.",
            "solution": "The problem is assessed to be valid as it is scientifically grounded in the principles of nuclear transmutation and decay, mathematically well-posed as a linear initial value problem, and objectively formulated with all necessary parameters and conditions specified.\n\n### Step 1: Derivation of the Analytic Solution\n\nThe problem describes the evolution of a three-nuclide system governed by the linear, inhomogeneous ordinary differential equation (ODE) with constant coefficients:\n$$\n\\frac{d}{dt} y(t) = A\\,y(t) + s\n$$\nwith the initial condition $y(0) = y_0$. The vectors $y(t)$ and $s$, and the matrix $A$ are given by:\n$$\ny(t) = \\begin{bmatrix} N_1(t) \\\\ N_2(t) \\\\ N_3(t) \\end{bmatrix}, \\quad\nA = \\begin{bmatrix}\n-\\lambda_1 & 0 & 0 \\\\\nb_1 \\lambda_1 & -\\lambda_2 & 0 \\\\\n0 & b_2 \\lambda_2 & -\\lambda_3\n\\end{bmatrix}, \\quad\ns = \\begin{bmatrix} q \\\\ 0 \\\\ 0 \\end{bmatrix}\n$$\nThe solution to a linear inhomogeneous ODE is the sum of the general solution to the corresponding homogeneous equation, $y_h(t)$, and a particular solution to the inhomogeneous equation, $y_p(t)$.\n\n**1. Homogeneous Solution:**\nThe homogeneous equation is $\\frac{d}{dt} y_h(t) = A y_h(t)$. The solution to this system is given by:\n$$\ny_h(t) = e^{At} C\n$$\nwhere $C$ is a constant vector determined by the initial conditions, and $e^{At}$ is the matrix exponential, defined by its Taylor series expansion:\n$$\ne^{At} = I + At + \\frac{(At)^2}{2!} + \\frac{(At)^3}{3!} + \\dots = \\sum_{k=0}^\\infty \\frac{(At)^k}{k!}\n$$\nwhere $I$ is the identity matrix.\n\n**2. Particular Solution (Variation of Constants):**\nTo find a particular solution, we use the method of variation of constants, where the constant vector $C$ is promoted to a time-dependent function, $c(t)$. We propose a solution of the form:\n$$\ny(t) = e^{At} c(t)\n$$\nSubstituting this into the original inhomogeneous ODE:\n$$\n\\frac{d}{dt} [e^{At} c(t)] = A [e^{At} c(t)] + s\n$$\nApplying the product rule for differentiation to the left-hand side:\n$$\n\\left(\\frac{d}{dt} e^{At}\\right) c(t) + e^{At} \\frac{d}{dt} c(t) = A e^{At} c(t) + s\n$$\nThe derivative of the matrix exponential is $\\frac{d}{dt} e^{At} = A e^{At}$. Substituting this gives:\n$$\nA e^{At} c(t) + e^{At} \\frac{d}{dt} c(t) = A e^{At} c(t) + s\n$$\nThe term $A e^{At} c(t)$ cancels from both sides, leaving:\n$$\ne^{At} \\frac{d}{dt} c(t) = s\n$$\nMultiplying by the inverse of $e^{At}$, which is $e^{-At}$:\n$$\n\\frac{d}{dt} c(t) = e^{-At} s\n$$\nIntegrating both sides from $\\tau=0$ to $\\tau=t$:\n$$\n\\int_0^t \\frac{d}{d\\tau} c(\\tau) \\,d\\tau = \\int_0^t e^{-A\\tau} s \\,d\\tau\n$$\n$$\nc(t) - c(0) = \\int_0^t e^{-A\\tau} s \\,d\\tau\n$$\n\n**3. Combining and Applying the Initial Condition:**\nThe full solution is $y(t) = e^{At} c(t) = e^{At} \\left(c(0) + \\int_0^t e^{-A\\tau} s \\,d\\tau\\right)$.\nAt $t=0$, we have $y(0) = y_0$. Applying this to our solution form:\n$$\ny(0) = e^{A \\cdot 0} c(0) = I c(0) = c(0)\n$$\nThus, the integration constant vector is the initial condition vector, $c(0) = y_0$.\nSubstituting this back, the complete solution is:\n$$\ny(t) = e^{At} \\left(y_0 + \\int_0^t e^{-A\\tau} s \\,d\\tau\\right) = e^{At} y_0 + e^{At} \\int_0^t e^{-A\\tau} s \\,d\\tau\n$$\nThe integral term can be simplified by moving $e^{At}$ inside the integral (as it is constant with respect to the integration variable $\\tau$):\n$$\ny(t) = e^{At} y_0 + \\int_0^t e^{A(t-\\tau)} s \\,d\\tau\n$$\nSince $A$ and $s$ are constant, and $A$ is invertible for the given test cases (all $\\lambda_i > 0$), the integral can be evaluated directly:\n$$\n\\int_0^t e^{A(t-\\tau)} s \\,d\\tau = \\left[ -A^{-1} e^{A(t-\\tau)} \\right]_{\\tau=0}^{\\tau=t} s = \\left( -A^{-1} e^{A \\cdot 0} - (-A^{-1} e^{At}) \\right) s = A^{-1} (e^{At} - I) s\n$$\nTherefore, the final analytic solution is:\n$$\ny_{\\text{exact}}(t) = e^{At} y_0 + A^{-1}(e^{At} - I)s\n$$\nThis form will be used for the exact calculation at $t=T$.\n\n### Step 2: Numerical Implementation\n\nThe problem specifies a first-order numerical scheme with explicit time marching. The system of ODEs is:\n$$\n\\frac{d N_1}{dt} = -\\lambda_1 N_1 + q \\\\\n\\frac{d N_2}{dt} = b_1 \\lambda_1 N_1 - \\lambda_2 N_2 \\\\\n\\frac{d N_3}{dt} = b_2 \\lambda_2 N_2 - \\lambda_3 N_3\n$$\nThe numerical method is a forward Euler update rule over a time step $\\Delta t$. Let $y^n$ denote the nuclide density vector at time $t_n = n \\Delta t$. The vector at the next time step, $y^{n+1}$, is found by approximating the derivative as $\\frac{dy}{dt} \\approx \\frac{y^{n+1} - y^n}{\\Delta t}$ and evaluating the right-hand side at time $t_n$.\n$$\n\\frac{y^{n+1} - y^n}{\\Delta t} = A y^n + s\n$$\nThis gives the update rule:\n$$\ny^{n+1} = y^n + \\Delta t (A y^n + s)\n$$\nThis formulation is consistent with the problem's descriptive requirement to use \"pre-update values\" for the parent nuclides in each sequential update step. The implementation will start with the initial condition $y_{\\text{num}}(0) = y_0$ and iteratively apply this formula for a total of $N = T / \\Delta t$ steps to find $y_{\\text{num}}(T)$.\n\n### Step 3: Error Norm Calculation\n\nAt the final time $T$, we will have the analytic solution $y_{\\text{exact}}(T)$ and the numerical approximation $y_{\\text{num}}(T)$. The relative error norms are computed as follows:\n\nThe relative $L^2$ (Euclidean) norm error:\n$$\nE_2 = \\frac{\\|y_{\\text{num}}(T) - y_{\\text{exact}}(T)\\|_2}{\\|y_{\\text{exact}}(T)\\|_2} = \\frac{\\sqrt{\\sum_{i=1}^3 (N_{i, \\text{num}}(T) - N_{i, \\text{exact}}(T))^2}}{\\sqrt{\\sum_{i=1}^3 (N_{i, \\text{exact}}(T))^2}}\n$$\nThe relative $L^\\infty$ (maximum) norm error:\n$$\nE_\\infty = \\frac{\\|y_{\\text{num}}(T) - y_{\\text{exact}}(T)\\|_\\infty}{\\|y_{\\text{exact}}(T)\\|_\\infty} = \\frac{\\max_i |N_{i, \\text{num}}(T) - N_{i, \\text{exact}}(T)|}{\\max_i |N_{i, \\text{exact}}(T)|}\n$$\nThese quantities will be computed for each test case provided.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Solves the nuclear depletion problem for a set of test cases.\n    For each case, it computes the exact solution and a numerical approximation,\n    then calculates the relative L2 and L-infinity error norms.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path, moderate time step)\n        {'lambda1': 0.02, 'lambda2': 0.15, 'lambda3': 1e-6, 'b1': 1.0, 'b2': 1.0, 'q': 1e19,\n         'y0': np.array([2e20, 0, 0]), 'dt': 0.5, 'T': 10.0},\n        # Case 2 (small time step boundary)\n        {'lambda1': 0.02, 'lambda2': 0.15, 'lambda3': 1e-6, 'b1': 1.0, 'b2': 1.0, 'q': 1e19,\n         'y0': np.array([2e20, 0, 0]), 'dt': 0.01, 'T': 10.0},\n        # Case 3 (large time step stress)\n        {'lambda1': 0.02, 'lambda2': 0.15, 'lambda3': 1e-6, 'b1': 1.0, 'b2': 1.0, 'q': 1e19,\n         'y0': np.array([2e20, 0, 0]), 'dt': 2.0, 'T': 10.0},\n        # Case 4 (stiff chain)\n        {'lambda1': 5.0, 'lambda2': 0.05, 'lambda3': 1e-5, 'b1': 1.0, 'b2': 1.0, 'q': 1e19,\n         'y0': np.array([1e19, 2e18, 0]), 'dt': 0.1, 'T': 10.0},\n        # Case 5 (near-degenerate equal rates)\n        {'lambda1': 0.1, 'lambda2': 0.1, 'lambda3': 0.1, 'b1': 1.0, 'b2': 1.0, 'q': 5e18,\n         'y0': np.array([1e20, 5e19, 0]), 'dt': 0.5, 'T': 10.0},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        # Extract parameters for the current case\n        l1, l2, l3 = case['lambda1'], case['lambda2'], case['lambda3']\n        b1, b2 = case['b1'], case['b2']\n        q = case['q']\n        y0 = case['y0'].astype(np.float64).reshape(3, 1)\n        dt = case['dt']\n        T = case['T']\n\n        # Define the system matrix A and source vector s\n        A = np.array([\n            [-l1, 0, 0],\n            [b1 * l1, -l2, 0],\n            [0, b2 * l2, -l3]\n        ], dtype=np.float64)\n        \n        s = np.array([q, 0, 0], dtype=np.float64).reshape(3, 1)\n\n        # 1. Analytic Solution\n        # y_exact(t) = exp(At) * y0 + A_inv * (exp(At) - I) * s\n        I = np.identity(3)\n        A_inv = np.linalg.inv(A)\n        exp_At = expm(A * T)\n        \n        term1 = exp_At @ y0\n        term2 = A_inv @ (exp_At - I) @ s\n        y_exact_T = term1 + term2\n\n        # 2. Numerical Solution (Forward Euler)\n        # y_n+1 = y_n + dt * (A * y_n + s)\n        num_steps = int(round(T / dt))\n        y_num = y0.copy()\n        \n        for _ in range(num_steps):\n            y_num = y_num + dt * (A @ y_num + s)\n        \n        y_num_T = y_num\n\n        # 3. Error Calculation\n        diff_vec = y_num_T - y_exact_T\n        \n        # Calculate norms\n        norm_exact_2 = np.linalg.norm(y_exact_T, ord=2)\n        norm_exact_inf = np.linalg.norm(y_exact_T, ord=np.inf)\n        \n        norm_diff_2 = np.linalg.norm(diff_vec, ord=2)\n        norm_diff_inf = np.linalg.norm(diff_vec, ord=np.inf)\n\n        # Avoid division by zero if the exact solution is zero (unlikely here)\n        E2 = norm_diff_2 / norm_exact_2 if norm_exact_2 > 0 else 0.0\n        Einf = norm_diff_inf / norm_exact_inf if norm_exact_inf > 0 else 0.0\n\n        results.extend([E2, Einf])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "In a functioning reactor, depletion and neutronics are deeply coupled phenomena: changing nuclide inventories alter the macroscopic cross sections, which reshapes the neutron flux, which in turn drives further transmutation and depletion. This advanced practice moves beyond simple, constant-flux models to tackle this feedback loop using a predictor-corrector algorithm. You will implement a method that uses first-order sensitivity analysis to predict how the flux shape responds to inventory changes, then use this updated flux to achieve a more accurate inventory solution in a corrector step . This exercise offers a glimpse into the sophisticated, iterative schemes that enable high-fidelity reactor simulations, connecting the theories of depletion, transport, and numerical analysis into a cohesive, practical workflow.",
            "id": "4233562",
            "problem": "You are asked to implement a mathematically principled flux-shape predictor within a linear-chain depletion context. The model consists of $m$ spatial zones and a three-nuclide sequential chain in each zone. All quantities in this problem are dimensionless by construction, and the normalization imposes a fixed scalar constraint on the flux shape. Your task is to derive from first principles how to update the flux shape due to inventory changes via a sensitivity-based predictor, how this change affects transmutation chain rates, and how to compute corrected inventories using a predictor-corrector approach.\n\nThe fundamental base for the derivation is the following set of laws and definitions, which you must start from:\n\n- The discrete balance equation for steady-state neutron transport under a linear operator can be represented for a flux shape vector $\\phi \\in \\mathbb{R}^m$ as $L(\\Sigma)\\,\\phi = q$, with a normalization constraint $w^\\top \\phi = P$. Here, $L(\\Sigma) = K - \\operatorname{diag}(\\Sigma)$ is a linear operator depending on the macroscopic absorption cross section vector $\\Sigma \\in \\mathbb{R}^m$, $K \\in \\mathbb{R}^{m \\times m}$ is a coupling matrix, $q \\in \\mathbb{R}^m$ is a fixed source, $w \\in \\mathbb{R}^m$ is a weighting vector, and $P \\in \\mathbb{R}$ is the fixed normalization magnitude.\n- The first-order sensitivity of the flux shape to a parameter vector can be derived by differentiating the governing equations and the normalization constraint.\n- The chain depletion is modeled by a linear Ordinary Differential Equation (ODE) for the inventory vector in each zone with constant rates over a time step, governed by a matrix that depends linearly on the local flux via reaction terms.\n\nThe system has three nuclides per zone, labeled $X_1 \\to X_2 \\to X_3$, with the following dynamics in zone $k$:\n- The inventory vector is $N_k = [N_{k,1}, N_{k,2}, N_{k,3}]^\\top$.\n- The macroscopic absorption cross section in zone $k$ is $\\Sigma_k = \\alpha_1 N_{k,1} + \\alpha_2 N_{k,2} + \\alpha_3 N_{k,3}$, where $\\alpha_i$ are fixed coefficients.\n- The chain rates in zone $k$ depend on the local flux component $\\phi_k$ and reaction coefficients $s_1$ and $s_2$:\n  - The $X_1 \\to X_2$ rate is $r_{12,k} = s_1\\,\\phi_k\\,N_{k,1}$.\n  - The $X_2 \\to X_3$ rate is $r_{23,k} = s_2\\,\\phi_k\\,N_{k,2}$.\n- The decay removal rates are $d_1$ and $d_2$ for $X_1$ and $X_2$, respectively. The depletion matrix $A_k(\\phi_k)$ in zone $k$ is\n  $$\n  A_k(\\phi_k) =\n  \\begin{bmatrix}\n    -(d_1 + s_1 \\phi_k) & 0 & 0 \\\\\n    s_1 \\phi_k & -(d_2 + s_2 \\phi_k) & 0 \\\\\n    0 & s_2 \\phi_k & 0\n  \\end{bmatrix}.\n  $$\n\nDefine the augmented linear system\n$$\n\\begin{bmatrix}\nL(\\Sigma) & c \\\\\nw^\\top & 0\n\\end{bmatrix}\n\\begin{bmatrix}\n\\phi \\\\ \\lambda\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nq \\\\ P\n\\end{bmatrix},\n$$\nwhere $c = w$ and $\\lambda$ is a Lagrange multiplier enforcing the normalization. This augmented system encodes both the balance equation and the normalization constraint. To form the flux-shape predictor, consider a change $\\Delta \\Sigma$ induced by the predictor inventories $N_k^{\\mathrm{pred}}$ and compute the first-order correction\n$$\n\\phi_{\\mathrm{pred}} \\approx \\phi + J_\\Sigma\\,\\Delta \\Sigma,\n$$\nwhere $J_\\Sigma \\in \\mathbb{R}^{m \\times m}$ is the Jacobian matrix with columns $\\frac{\\partial \\phi}{\\partial \\Sigma_k}$ determined by differentiating the augmented system with respect to $\\Sigma_k$.\n\nThe predictor step uses the matrix exponential to advance inventories in each zone with constant rates over a time step $\\Delta t$:\n$$\nN_k^{\\mathrm{pred}} = \\exp\\!\\left(A_k(\\phi_k)\\,\\Delta t\\right)\\,N_k.\n$$\nWith the predictor flux $\\phi_{\\mathrm{pred}}$ and the predictor inventories $N_k^{\\mathrm{pred}}$, form corrected inventories using a symmetric predictor-corrector (Heun method):\n$$\nN_k^{\\mathrm{corr}} = N_k + \\tfrac{1}{2}\\,\\Delta t \\left( A_k(\\phi_k)\\,N_k + A_k(\\phi_{\\mathrm{pred},k})\\,N_k^{\\mathrm{pred}} \\right).\n$$\n\nYour program must implement this procedure for the following fixed parameters, test cases, and required outputs. All variables are dimensionless, so no physical units are used.\n\nFixed model parameters shared by all test cases:\n- Number of zones $m = 2$.\n- Coupling matrix $K = \\begin{bmatrix} 2.0 & -0.5 \\\\ -0.5 & 1.5 \\end{bmatrix}$.\n- Source $q = \\begin{bmatrix} 0.1 \\\\ 0.1 \\end{bmatrix}$.\n- Weight vector $w = \\begin{bmatrix} 1.0 \\\\ 1.0 \\end{bmatrix}$ and normalization magnitude $P = 1.0$.\n- Cross section coefficients $\\alpha_1 = 0.02$, $\\alpha_2 = 0.01$, $\\alpha_3 = 0.005$.\n- Reaction coefficients $s_1 = 0.03$, $s_2 = 0.025$.\n- Decay removal coefficients $d_1 = 0.001$, $d_2 = 0.0015$.\n\nFor each test case, the input consists of an initial inventory per zone and a time step $\\Delta t$. The test suite is:\n- Test case $1$ (general case): $\\Delta t = 1.0$, $N_1 = [10.0, 2.0, 0.0]^\\top$, $N_2 = [8.0, 1.0, 0.0]^\\top$.\n- Test case $2$ (small time step edge case): $\\Delta t = 0.0001$, $N_1 = [10.0, 2.0, 0.0]^\\top$, $N_2 = [8.0, 1.0, 0.0]^\\top$.\n- Test case $3$ (zero components edge case): $\\Delta t = 0.5$, $N_1 = [15.0, 0.0, 0.0]^\\top$, $N_2 = [0.0, 5.0, 0.0]^\\top$.\n\nFor each test case, perform the following steps:\n1. Compute the macroscopic absorption vector $\\Sigma$ from the initial inventories.\n2. Solve the augmented system for the initial flux shape $\\phi$ with normalization $w^\\top \\phi = P$.\n3. Build the zone-wise depletion matrices $A_k(\\phi_k)$ and compute predictor inventories $N_k^{\\mathrm{pred}}$ using the matrix exponential over $\\Delta t$.\n4. Compute $\\Delta \\Sigma$ from $N_k^{\\mathrm{pred}} - N_k$.\n5. Compute the flux-shape Jacobian $J_\\Sigma$ by differentiating the augmented system with respect to each component of $\\Sigma$ and solving for $\\frac{\\partial \\phi}{\\partial \\Sigma_k}$ using the same augmented matrix.\n6. Form the predicted flux $\\phi_{\\mathrm{pred}} = \\phi + J_\\Sigma\\,\\Delta \\Sigma$.\n7. Compute the initial total chain rate $R_{12}^{\\mathrm{init}} = \\sum_{k=1}^m s_1\\,\\phi_k\\,N_{k,1}$ and the predicted total chain rate $R_{12}^{\\mathrm{pred}} = \\sum_{k=1}^m s_1\\,\\phi_{\\mathrm{pred},k}\\,N_{k,1}^{\\mathrm{pred}}$.\n8. Form corrected inventories $N_k^{\\mathrm{corr}} = N_k + \\tfrac{1}{2}\\,\\Delta t \\left( A_k(\\phi_k)\\,N_k + A_k(\\phi_{\\mathrm{pred},k})\\,N_k^{\\mathrm{pred}} \\right)$.\n\nYour program must output, for each test case in order, the following aggregated results on a single line as a comma-separated list enclosed in square brackets:\n- The relative $L^2$ change in flux shape magnitude $\\left\\|\\phi_{\\mathrm{pred}} - \\phi\\right\\|_2 / \\left\\|\\phi\\right\\|_2$.\n- The initial total $X_1 \\to X_2$ chain rate $R_{12}^{\\mathrm{init}}$.\n- The predicted total $X_1 \\to X_2$ chain rate $R_{12}^{\\mathrm{pred}}$.\n- The corrected inventories for all zones in order, concatenated as $[N_{1,1}^{\\mathrm{corr}}, N_{1,2}^{\\mathrm{corr}}, N_{1,3}^{\\mathrm{corr}}, N_{2,1}^{\\mathrm{corr}}, N_{2,2}^{\\mathrm{corr}}, N_{2,3}^{\\mathrm{corr}}]$.\n\nTherefore, for three test cases, the program outputs $3$ blocks of $9$ numbers each, in order, as a single list with $27$ floats:\n$$\n\\big[\n\\text{rel\\_flux\\_change}_1,\\; R_{12,1}^{\\mathrm{init}},\\; R_{12,1}^{\\mathrm{pred}},\\; N_{1,1,1}^{\\mathrm{corr}},\\; N_{1,2,1}^{\\mathrm{corr}},\\; N_{1,3,1}^{\\mathrm{corr}},\\; N_{2,1,1}^{\\mathrm{corr}},\\; N_{2,2,1}^{\\mathrm{corr}},\\; N_{2,3,1}^{\\mathrm{corr}},\\; \\text{rel\\_flux\\_change}_2,\\; \\ldots,\\; N_{2,3,3}^{\\mathrm{corr}}\n\\big].\n$$\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\text{result}_1,\\text{result}_2,\\text{result}_3]$). No additional text should be printed.",
            "solution": "The problem requires the implementation of a predictor-corrector depletion algorithm with flux feedback calculated via a first-order sensitivity analysis. We will detail the mathematical and algorithmic procedure for a single time step, which is then applied to each test case.\n\n**1. Initial State Calculation (Flux and Depletion Rates)**\n\nThe initial state of the system is defined by the nuclide inventories $N_k$ in each of the $m$ zones. These inventories determine the macroscopic absorption cross sections $\\Sigma_k$, which in turn influence the neutron flux shape $\\phi$.\n\nFirst, we calculate the macroscopic absorption cross section for each zone $k \\in \\{1, \\dots, m\\}$ using the given linear relationship with the nuclide number densities $N_{k,i}$ and coefficients $\\alpha_i$:\n$$\n\\Sigma_k = \\sum_{i=1}^{3} \\alpha_i N_{k,i}\n$$\nThis defines the macroscopic absorption cross section vector $\\Sigma = [\\Sigma_1, \\dots, \\Sigma_m]^\\top$.\n\nWith $\\Sigma$ known, the steady-state neutron flux shape $\\phi$ is found by solving the discrete neutron balance equation along with its normalization constraint. The problem specifies an augmented linear system that combines both equations:\n$$\n\\begin{bmatrix}\nL(\\Sigma) & c \\\\\nw^\\top & 0\n\\end{bmatrix}\n\\begin{bmatrix}\n\\phi \\\\ \\lambda\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nq \\\\ P\n\\end{bmatrix}\n$$\nHere, $L(\\Sigma) = K - \\operatorname{diag}(\\Sigma)$ is the linear transport operator, $K$ is the coupling matrix, $q$ is the fixed neutron source, $w$ is a weighting vector, $P$ is the total power normalization, $c=w$ is a given choice for the augmented system, and $\\lambda$ is a Lagrange multiplier enforcing the constraint. Let us define the augmented matrix $A_{\\text{aug}}(\\Sigma)$ and the augmented right-hand side vector $b_{\\text{aug}}$:\n$$\nA_{\\text{aug}}(\\Sigma) = \\begin{bmatrix} K - \\operatorname{diag}(\\Sigma) & w \\\\ w^\\top & 0 \\end{bmatrix}, \\quad b_{\\text{aug}} = \\begin{bmatrix} q \\\\ P \\end{bmatrix}\n$$\nThe augmented state vector $[\\phi^\\top, \\lambda]^\\top$ is found by solving this $(m+1) \\times (m+1)$ linear system:\n$$\n\\begin{bmatrix} \\phi \\\\ \\lambda \\end{bmatrix} = A_{\\text{aug}}^{-1}(\\Sigma) \\, b_{\\text{aug}}\n$$\nThis provides the initial flux vector $\\phi = [\\phi_1, \\dots, \\phi_m]^\\top$.\n\n**2. Predictor Step: Inventory Evolution**\n\nThe change in nuclide inventories over a time step $\\Delta t$ is governed by a system of linear ordinary differential equations, $\\frac{d N_k}{dt} = A_k(\\phi_k) N_k$. For a constant flux $\\phi_k$ over the step, the solution is given by the matrix exponential. The predictor step calculates the predicted inventories $N_k^{\\text{pred}}$ by assuming the initial flux $\\phi$ remains constant over the entire time step $\\Delta t$.\n\nFor each zone $k$, the depletion matrix $A_k(\\phi_k)$ is constructed using the initial flux component $\\phi_k$, decay constants $d_i$, and reaction coefficients $s_i$:\n$$\nA_k(\\phi_k) =\n\\begin{bmatrix}\n-(d_1 + s_1 \\phi_k) & 0 & 0 \\\\\ns_1 \\phi_k & -(d_2 + s_2 \\phi_k) & 0 \\\\\n0 & s_2 \\phi_k & 0\n\\end{bmatrix}\n$$\nThe predicted inventory vector $N_k^{\\text{pred}}$ is then calculated as:\n$$\nN_k^{\\text{pred}} = \\exp(A_k(\\phi_k)\\,\\Delta t)\\,N_k\n$$\n\n**3. Flux Shape Predictor: Sensitivity Analysis**\n\nThe change in inventories, $\\Delta N_k = N_k^{\\text{pred}} - N_k$, induces a change in the macroscopic cross sections, $\\Delta \\Sigma$. This, in turn, perturbs the flux shape. We approximate this flux perturbation, $\\Delta \\phi$, using a first-order Taylor expansion:\n$$\n\\phi(\\Sigma + \\Delta\\Sigma) \\approx \\phi(\\Sigma) + J_\\Sigma \\Delta\\Sigma\n$$\nwhere $J_\\Sigma$ is the Jacobian matrix of the flux with respect to the cross sections, with entries $(J_\\Sigma)_{ij} = \\frac{\\partial \\phi_i}{\\partial \\Sigma_j}$. The predicted flux is therefore $\\phi_{\\text{pred}} = \\phi + \\Delta\\phi = \\phi + J_\\Sigma \\Delta\\Sigma$.\n\nTo find the columns of the Jacobian, $\\frac{\\partial \\phi}{\\partial \\Sigma_j}$, we differentiate the augmented system $A_{\\text{aug}}(\\Sigma)[\\phi^\\top, \\lambda]^\\top = b_{\\text{aug}}$ with respect to a single cross section component $\\Sigma_j$, using the product rule:\n$$\n\\frac{\\partial A_{\\text{aug}}}{\\partial \\Sigma_j} \\begin{bmatrix} \\phi \\\\ \\lambda \\end{bmatrix} + A_{\\text{aug}} \\frac{\\partial}{\\partial \\Sigma_j} \\begin{bmatrix} \\phi \\\\ \\lambda \\end{bmatrix} = \\frac{\\partial b_{\\text{aug}}}{\\partial \\Sigma_j} = \\mathbf{0}\n$$\nThe derivative of the augmented matrix with respect to $\\Sigma_j$ is:\n$$\n\\frac{\\partial A_{\\text{aug}}}{\\partial \\Sigma_j} = \\frac{\\partial}{\\partial \\Sigma_j} \\begin{bmatrix} K - \\operatorname{diag}(\\Sigma) & w \\\\ w^\\top & 0 \\end{bmatrix} = \\begin{bmatrix} -\\operatorname{diag}(e_j) & \\mathbf{0}_{m\\times1} \\\\ \\mathbf{0}_{1\\times m} & 0 \\end{bmatrix}\n$$\nwhere $e_j$ is the $j$-th standard basis vector in $\\mathbb{R}^m$. Applying this matrix to the state vector yields:\n$$\n\\frac{\\partial A_{\\text{aug}}}{\\partial \\Sigma_j} \\begin{bmatrix} \\phi \\\\ \\lambda \\end{bmatrix} = \\begin{bmatrix} -\\phi_j e_j \\\\ 0 \\end{bmatrix}\n$$\nThis is an $(m+1)$-dimensional vector with the value $-\\phi_j$ at position $j$ and zeros elsewhere. Rearranging the differentiated equation gives a linear system for the sensitivity vector:\n$$\nA_{\\text{aug}} \\begin{bmatrix} \\partial \\phi / \\partial \\Sigma_j \\\\ \\partial \\lambda / \\partial \\Sigma_j \\end{bmatrix} = - \\begin{bmatrix} -\\phi_j e_j \\\\ 0 \\end{bmatrix} = \\begin{bmatrix} \\phi_j e_j \\\\ 0 \\end{bmatrix}\n$$\nFor each $j \\in \\{1, \\dots, m\\}$, we solve this linear system. The top $m$ components of the solution vector form the $j$-th column of the Jacobian $J_\\Sigma$. The matrix $A_{\\text{aug}}$ is the same one used to find the initial flux, which allows for efficient solution.\n\nWith the Jacobian $J_\\Sigma$ computed, we first calculate the change in cross sections from the predictor inventories:\n$$\n\\Delta \\Sigma_k = \\sum_{i=1}^{3} \\alpha_i (N_{k,i}^{\\text{pred}} - N_{k,i})\n$$\nwhich gives the vector $\\Delta\\Sigma$. The predicted flux is then found:\n$$\n\\phi_{\\text{pred}} = \\phi + J_\\Sigma\\,\\Delta\\Sigma\n$$\n\n**4. Corrector Step: Corrected Inventories**\n\nThe final step is to improve the inventory calculation using a corrector step. The problem specifies a symmetric predictor-corrector method, which is the Heun or trapezoidal rule method. This method averages the rates at the beginning of the time step (using initial state $\\phi, N_k$) and the end of the time step (using predicted state $\\phi_{\\text{pred}}, N_k^{\\text{pred}}$).\n\nThe corrected inventory $N_k^{\\text{corr}}$ is calculated using the formula:\n$$\nN_k^{\\text{corr}} = N_k + \\frac{\\Delta t}{2} \\left( A_k(\\phi_k) N_k + A_k(\\phi_{\\mathrm{pred},k}) N_k^{\\text{pred}} \\right)\n$$\nwhere $A_k(\\phi_{\\mathrm{pred},k})$ is the depletion matrix constructed using the predicted flux $\\phi_{\\mathrm{pred}, k}$ in zone $k$. This completes the predictor-corrector cycle.\n\n**5. Required Outputs**\n\nFinally, for each test case, we compute the specified output quantities:\n- The relative $L^2$ norm of the flux change: $\\frac{\\|\\phi_{\\text{pred}} - \\phi\\|_2}{\\|\\phi\\|_2}$.\n- The initial total rate for the reaction $X_1 \\to X_2$: $R_{12}^{\\text{init}} = \\sum_{k=1}^m s_1\\,\\phi_k\\,N_{k,1}$.\n- The predicted total rate for the reaction $X_1 \\to X_2$: $R_{12}^{\\text{pred}} = \\sum_{k=1}^m s_1\\,\\phi_{\\text{pred},k}\\,N_{k,1}^{\\text{pred}}$.\n- The concatenated vector of corrected inventories for all zones.\n\nThis procedure is implemented and repeated for all test cases provided.",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Implements a predictor-corrector depletion calculation with flux feedback\n    based on first-order sensitivity analysis.\n    \"\"\"\n    \n    # Fixed model parameters\n    m = 2  # Number of zones\n    K = np.array([[2.0, -0.5], [-0.5, 1.5]])\n    q = np.array([0.1, 0.1])\n    w = np.array([1.0, 1.0])\n    P = 1.0\n    alphas = np.array([0.02, 0.01, 0.005])  # alpha_1, alpha_2, alpha_3\n    s1, s2 = 0.03, 0.025\n    d1, d2 = 0.001, 0.0015\n\n    # Test cases\n    test_cases = [\n        # (dt, N1_initial, N2_initial)\n        (1.0, np.array([10.0, 2.0, 0.0]), np.array([8.0, 1.0, 0.0])),\n        (0.0001, np.array([10.0, 2.0, 0.0]), np.array([8.0, 1.0, 0.0])),\n        (0.5, np.array([15.0, 0.0, 0.0]), np.array([0.0, 5.0, 0.0]))\n    ]\n    \n    all_results = []\n\n    for dt, N1_init, N2_init in test_cases:\n        N_init = [N1_init, N2_init]\n\n        # Step 1: Compute initial macroscopic absorption vector Sigma\n        Sigma = np.array([np.dot(alphas, N) for N in N_init])\n\n        # Step 2: Solve for the initial flux shape phi\n        L = K - np.diag(Sigma)\n        A_aug = np.zeros((m + 1, m + 1))\n        A_aug[:m, :m] = L\n        A_aug[:m, m] = w\n        A_aug[m, :m] = w\n        b_aug = np.append(q, P)\n        \n        x_aug = np.linalg.solve(A_aug, b_aug)\n        phi = x_aug[:m]\n\n        # Step 3: Compute predictor inventories N_pred\n        N_pred = []\n        depletion_matrices_init = []\n        for k in range(m):\n            phi_k = phi[k]\n            A_k = np.array([\n                [-(d1 + s1 * phi_k), 0, 0],\n                [s1 * phi_k, -(d2 + s2 * phi_k), 0],\n                [0, s2 * phi_k, 0]\n            ])\n            depletion_matrices_init.append(A_k)\n            N_k_pred = expm(A_k * dt) @ N_init[k]\n            N_pred.append(N_k_pred)\n\n        # Step 4: Compute Delta_Sigma\n        Sigma_pred = np.array([np.dot(alphas, N) for N in N_pred])\n        Delta_Sigma = Sigma_pred - Sigma\n\n        # Step 5: Compute the flux-shape Jacobian J_Sigma\n        J_Sigma = np.zeros((m, m))\n        for j in range(m):\n            rhs_j = np.zeros(m + 1)\n            rhs_j[j] = phi[j]\n            sensitivity_vec_aug = np.linalg.solve(A_aug, rhs_j)\n            J_Sigma[:, j] = sensitivity_vec_aug[:m]\n\n        # Step 6: Form the predicted flux phi_pred\n        phi_pred = phi + J_Sigma @ Delta_Sigma\n\n        # Step 7: Compute initial and predicted total chain rates\n        R12_init = s1 * (phi[0] * N1_init[0] + phi[1] * N2_init[0])\n        R12_pred = s1 * (phi_pred[0] * N_pred[0][0] + phi_pred[1] * N_pred[1][0])\n\n        # Step 8: Form corrected inventories N_corr\n        N_corr_flat = []\n        for k in range(m):\n            phi_pred_k = phi_pred[k]\n            A_k_pred = np.array([\n                [-(d1 + s1 * phi_pred_k), 0, 0],\n                [s1 * phi_pred_k, -(d2 + s2 * phi_pred_k), 0],\n                [0, s2 * phi_pred_k, 0]\n            ])\n            # Heun's method\n            deriv_init = depletion_matrices_init[k] @ N_init[k]\n            deriv_pred = A_k_pred @ N_pred[k]\n            N_k_corr = N_init[k] + 0.5 * dt * (deriv_init + deriv_pred)\n            N_corr_flat.extend(N_k_corr)\n\n        # Aggregate results for this test case\n        rel_flux_change = np.linalg.norm(phi_pred - phi) / np.linalg.norm(phi)\n        \n        case_results = [\n            rel_flux_change,\n            R12_init,\n            R12_pred\n        ]\n        case_results.extend(N_corr_flat)\n        all_results.extend(case_results)\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{val:.12f}' for val in all_results)}]\")\n\nsolve()\n```"
        }
    ]
}