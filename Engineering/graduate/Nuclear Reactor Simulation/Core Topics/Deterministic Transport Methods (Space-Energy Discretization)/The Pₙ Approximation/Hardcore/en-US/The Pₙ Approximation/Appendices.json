{
    "hands_on_practices": [
        {
            "introduction": "The entire framework of the spherical harmonics approximation is built upon the properties of Legendre polynomials. This first practice  takes you back to these fundamentals, guiding you to derive the first few polynomials directly from the Rodrigues' formula. By confirming their normalization and orthogonality, you will gain a firm grasp of the mathematical machinery that makes the $P_N$ method work.",
            "id": "4256614",
            "problem": "In one-dimensional slab-geometry neutron transport, the Spherical Harmonics ($P_{n}$) approximation expands the angular dependence of the neutron angular flux in terms of Legendre polynomials in the direction cosine variable $\\mu \\in [-1,1]$. Starting from the fundamental definition of the Legendre polynomials via the Rodrigues construction and viewing them as the orthogonal eigenfunctions associated with the Legendre differential operator on $[-1,1]$ with unit weight, derive the first four Legendre polynomials $P_{0}(\\mu)$ through $P_{3}(\\mu)$. Then, confirm that the normalization is consistent with transport conventions, namely that $P_{l}(1)=1$ for $l=0,1,2,3$ and that the weight-$1$ orthogonality on $[-1,1]$ holds so that the self-inner-products satisfy $\\int_{-1}^{1} P_{l}(\\mu)^{2} \\, d\\mu = \\frac{2}{2l+1}$ for $l=0,1,2,3$, and the cross-inner-products $\\int_{-1}^{1} P_{l}(\\mu) P_{m}(\\mu) \\, d\\mu=0$ for $l \\neq m$ with $l,m \\in \\{0,1,2,3\\}$. Provide the four polynomials explicitly in closed form as functions of $\\mu$. The final answer must be the four polynomials collected as a single row matrix. No rounding is required.",
            "solution": "The problem requires the derivation of the first four Legendre polynomials, $P_{0}(\\mu)$ through $P_{3}(\\mu)$, starting from the Rodrigues construction. These polynomials are fundamental in the $P_{n}$ approximation method for the neutron transport equation, where they form an orthogonal basis for expanding the angular dependence of the neutron flux over the domain of the direction cosine, $\\mu \\in [-1, 1]$. After deriving the polynomials, their normalization and orthogonality properties, which are crucial for their use in transport theory, must be explicitly verified.\n\nThe Rodrigues' formula for the Legendre polynomials, $P_{l}(\\mu)$, is given by:\n$$ P_{l}(\\mu) = \\frac{1}{2^{l} l!} \\frac{d^{l}}{d\\mu^{l}} (\\mu^2 - 1)^l $$\nWe will apply this formula for $l=0, 1, 2, 3$.\n\nFor $l=0$:\n$$ P_{0}(\\mu) = \\frac{1}{2^{0} 0!} \\frac{d^{0}}{d\\mu^{0}} (\\mu^2 - 1)^0 = \\frac{1}{1 \\cdot 1} \\cdot 1 = 1 $$\n\nFor $l=1$:\n$$ P_{1}(\\mu) = \\frac{1}{2^{1} 1!} \\frac{d}{d\\mu} (\\mu^2 - 1)^1 = \\frac{1}{2} (2\\mu) = \\mu $$\n\nFor $l=2$:\n$$ P_{2}(\\mu) = \\frac{1}{2^{2} 2!} \\frac{d^2}{d\\mu^2} (\\mu^2 - 1)^2 = \\frac{1}{8} \\frac{d^2}{d\\mu^2} (\\mu^4 - 2\\mu^2 + 1) $$\nThe first derivative is $\\frac{d}{d\\mu}(\\mu^4 - 2\\mu^2 + 1) = 4\\mu^3 - 4\\mu$.\nThe second derivative is $\\frac{d}{d\\mu}(4\\mu^3 - 4\\mu) = 12\\mu^2 - 4$.\nThus,\n$$ P_{2}(\\mu) = \\frac{1}{8} (12\\mu^2 - 4) = \\frac{4}{8} (3\\mu^2 - 1) = \\frac{1}{2} (3\\mu^2 - 1) $$\n\nFor $l=3$:\n$$ P_{3}(\\mu) = \\frac{1}{2^{3} 3!} \\frac{d^3}{d\\mu^3} (\\mu^2 - 1)^3 = \\frac{1}{8 \\cdot 6} \\frac{d^3}{d\\mu^3} (\\mu^6 - 3\\mu^4 + 3\\mu^2 - 1) $$\nThe first derivative is $6\\mu^5 - 12\\mu^3 + 6\\mu$.\nThe second derivative is $30\\mu^4 - 36\\mu^2 + 6$.\nThe third derivative is $120\\mu^3 - 72\\mu$.\nThus,\n$$ P_{3}(\\mu) = \\frac{1}{48} (120\\mu^3 - 72\\mu) = \\frac{24}{48} (5\\mu^3 - 3\\mu) = \\frac{1}{2} (5\\mu^3 - 3\\mu) $$\n\nThe first four Legendre polynomials are:\n$P_0(\\mu) = 1$\n$P_1(\\mu) = \\mu$\n$P_2(\\mu) = \\frac{1}{2}(3\\mu^2 - 1)$\n$P_3(\\mu) = \\frac{1}{2}(5\\mu^3 - 3\\mu)$\n\nNext, we verify the normalization condition $P_{l}(1)=1$ for $l = 0, 1, 2, 3$.\nFor $l=0$: $P_{0}(1) = 1$.\nFor $l=1$: $P_{1}(1) = 1$.\nFor $l=2$: $P_{2}(1) = \\frac{1}{2}(3(1)^2 - 1) = \\frac{1}{2}(2) = 1$.\nFor $l=3$: $P_{3}(1) = \\frac{1}{2}(5(1)^3 - 3(1)) = \\frac{1}{2}(2) = 1$.\nThe normalization condition is satisfied.\n\nFinally, we verify the orthogonality relations on the interval $[-1,1]$ with a weight of $1$.\n\nFirst, the self-inner-products: $\\int_{-1}^{1} P_{l}(\\mu)^2 \\, d\\mu = \\frac{2}{2l+1}$.\nFor $l=0$: $\\int_{-1}^{1} P_{0}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} 1^2 \\, d\\mu = [\\mu]_{-1}^{1} = 1 - (-1) = 2$. The formula gives $\\frac{2}{2(0)+1} = 2$.\nFor $l=1$: $\\int_{-1}^{1} P_{1}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\mu^2 \\, d\\mu = \\left[\\frac{\\mu^3}{3}\\right]_{-1}^{1} = \\frac{1}{3} - \\frac{-1}{3} = \\frac{2}{3}$. The formula gives $\\frac{2}{2(1)+1} = \\frac{2}{3}$.\nFor $l=2$: $\\int_{-1}^{1} P_{2}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\left(\\frac{1}{2}(3\\mu^2 - 1)\\right)^2 \\, d\\mu = \\frac{1}{4} \\int_{-1}^{1} (9\\mu^4 - 6\\mu^2 + 1) \\, d\\mu = \\frac{1}{4} \\left[ \\frac{9\\mu^5}{5} - 2\\mu^3 + \\mu \\right]_{-1}^{1} = \\frac{1}{4} \\left( (\\frac{9}{5} - 2 + 1) - (-\\frac{9}{5} + 2 - 1) \\right) = \\frac{1}{4} \\left( \\frac{4}{5} - (-\\frac{4}{5}) \\right) = \\frac{1}{4} \\left(\\frac{8}{5}\\right) = \\frac{2}{5}$. The formula gives $\\frac{2}{2(2)+1} = \\frac{2}{5}$.\nFor $l=3$: $\\int_{-1}^{1} P_{3}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\left(\\frac{1}{2}(5\\mu^3 - 3\\mu)\\right)^2 \\, d\\mu = \\frac{1}{4} \\int_{-1}^{1} (25\\mu^6 - 30\\mu^4 + 9\\mu^2) \\, d\\mu = \\frac{1}{4} \\left[ \\frac{25\\mu^7}{7} - 6\\mu^5 + 3\\mu^3 \\right]_{-1}^{1} = \\frac{1}{4} \\left( (\\frac{25}{7} - 6 + 3) - (-\\frac{25}{7} + 6 - 3) \\right) = \\frac{1}{4} \\left( \\frac{4}{7} - (-\\frac{4}{7}) \\right) = \\frac{1}{4} \\left(\\frac{8}{7}\\right) = \\frac{2}{7}$. The formula gives $\\frac{2}{2(3)+1} = \\frac{2}{7}$.\nAll self-inner-products are correct.\n\nSecond, the cross-inner-products: $\\int_{-1}^{1} P_{l}(\\mu) P_{m}(\\mu) \\, d\\mu = 0$ for $l \\neq m$.\nWe note that $P_l(\\mu)$ is an even function for even $l$ and an odd function for odd $l$. The integral of a product of an even and an odd function over a symmetric interval like $[-1,1]$ is zero.\nCases with mixed parity ($l$ even, $m$ odd, or vice versa):\n$\\int_{-1}^{1} P_{0}(\\mu)P_{1}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{0}(\\mu)P_{3}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{1}(\\mu)P_{2}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{2}(\\mu)P_{3}(\\mu) \\, d\\mu = 0$\nThese are all zero due to the parity of the integrands.\n\nCases with same parity:\nFor $l=0, m=2$:\n$\\int_{-1}^{1} P_{0}(\\mu)P_{2}(\\mu) \\, d\\mu = \\int_{-1}^{1} (1) \\left(\\frac{1}{2}(3\\mu^2 - 1)\\right) \\, d\\mu = \\frac{1}{2} [\\mu^3 - \\mu]_{-1}^{1} = \\frac{1}{2} ((1-1) - (-1 - (-1))) = 0$.\nFor $l=1, m=3$:\n$\\int_{-1}^{1} P_{1}(\\mu)P_{3}(\\mu) \\, d\\mu = \\int_{-1}^{1} (\\mu) \\left(\\frac{1}{2}(5\\mu^3 - 3\\mu)\\right) \\, d\\mu = \\frac{1}{2} \\int_{-1}^{1} (5\\mu^4 - 3\\mu^2) \\, d\\mu = \\frac{1}{2} [\\mu^5 - \\mu^3]_{-1}^{1} = \\frac{1}{2} ((1-1) - (-1 - (-1))) = 0$.\nThe orthogonality is confirmed for all pairs with $l, m \\in \\{0, 1, 2, 3\\}$ and $l \\neq m$.\n\nThe derivation and verification are complete. The four polynomials are provided in the final answer.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix} 1 & \\mu & \\frac{1}{2}(3\\mu^2 - 1) & \\frac{1}{2}(5\\mu^3 - 3\\mu) \\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While transport solvers compute the abstract moments of the angular distribution, the ultimate goal is often to understand the physical angular flux, $\\psi(x,\\mu)$. This exercise  provides hands-on experience in the crucial process of reconstructing the flux from its moments. Furthermore, it challenges you to confront a key limitation of the truncated $P_N$ method: its potential to produce unphysical negative flux values, a phenomenon you will learn to detect computationally.",
            "id": "4256647",
            "problem": "Consider one-speed, steady-state neutron transport in one-dimensional slab geometry, where the angular flux $\\psi(x,\\mu)$ depends on the spatial coordinate $x$ and the direction cosine $\\mu \\in [-1,1]$. The spherical harmonics (SH) approach approximates angular dependence using Legendre polynomials $P_{\\ell}(\\mu)$, and transport solvers often compute a finite set of Legendre moments $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{N}$, where each moment is defined by the fundamental relation $\\phi_{\\ell}(x) = \\int_{-1}^{1} \\psi(x,\\mu) P_{\\ell}(\\mu)\\,d\\mu$. The Legendre polynomials satisfy the well-tested orthogonality property $\\int_{-1}^{1} P_{\\ell}(\\mu) P_{m}(\\mu)\\,d\\mu = \\frac{2}{2\\ell+1}\\delta_{\\ell m}$, where $\\delta_{\\ell m}$ is the Kronecker delta. Physical angular flux must satisfy $\\psi(x,\\mu) \\ge 0$ for all $\\mu \\in [-1,1]$ and all $x$.\n\nStarting only from these facts, derive how to reconstruct an approximate angular flux $\\psi_{N}(x,\\mu)$ from the computed moments $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{N}$ using a truncated expansion in Legendre polynomials for $N=3$. Then implement this reconstruction and assess the positivity of $\\psi_{3}(x,\\mu)$ across the entire angular domain $\\mu \\in [-1,1]$ by evaluating the reconstructed $\\psi_{3}(x,\\mu)$ on a uniform grid of $M=1001$ points in $\\mu$ and checking whether the minimum value is nonnegative.\n\nYour program must:\n- Implement the reconstruction algorithm that maps a given list of moments $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\}$ at a fixed spatial coordinate $x$ to the truncated-angular-flux approximation $\\psi_{3}(x,\\mu)$ using Legendre polynomials up to order $3$.\n- Evaluate $\\psi_{3}(x,\\mu)$ on a uniform grid in $\\mu$ with $M=1001$ points over $[-1,1]$.\n- Return a boolean indicating whether the reconstructed flux is nonnegative at all sampled angles, i.e., whether $\\min_{\\mu \\in [-1,1]} \\psi_{3}(x,\\mu) \\ge 0$.\n\nNo physical units are required because $\\mu$ is dimensionless by definition (cosine of polar angle), and no angles explicitly appear in the input; thus no angle unit specification is needed. The positivity check must be exact in the sense of the numerical grid described.\n\nUse the following test suite of moment sets at a single spatial location $x$:\n- Test $1$ (isotropic positive reference): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.0, 0.0, 0.0\\}$.\n- Test $2$ (strong first-moment anisotropy): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.6, 0.0, 0.0\\}$.\n- Test $3$ (linearly anisotropic but positive underlying distribution with $A=0.7$, $\\alpha=0.8$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.4, 0.37333333333333335, 0.0, 0.0\\}$.\n- Test $4$ (even anisotropy via $P_{2}$ component with $A=0.9$, $\\beta=1.5$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.8, 0.0, 0.54, 0.0\\}$.\n- Test $5$ (boundary-linear case with $A=0.5$, $\\alpha=1.0$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.3333333333333333, 0.0, 0.0\\}$.\n- Test $6$ (non-realizable moment set with zero scalar flux): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{0.0, 0.3, 0.0, 0.0\\}$.\n- Test $7$ (mixed higher-order anisotropy): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.2, 0.1, -0.05\\}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,\\dots]$), where each entry is a boolean corresponding to the positivity assessment for the respective test case, in the order listed above.",
            "solution": "The problem requires the derivation of a method to reconstruct an approximate angular neutron flux, $\\psi_N(x, \\mu)$, from a given set of its Legendre moments, $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{N}$, and then to implement this reconstruction for $N=3$ to assess its positivity. The problem is set in one-dimensional slab geometry, where $\\psi$ depends on position $x$ and the cosine of the polar angle, $\\mu \\in [-1,1]$. The derivation will be performed at a fixed spatial coordinate $x$, so the dependence on $x$ will be omitted for notational simplicity, e.g., $\\psi(\\mu)$ and $\\phi_{\\ell}$.\n\nThe foundation of the spherical harmonics ($P_N$) method is the approximation of the angular flux $\\psi(\\mu)$ by a truncated series of Legendre polynomials, $P_{\\ell}(\\mu)$:\n$$\n\\psi_N(\\mu) = \\sum_{\\ell=0}^{N} c_{\\ell} P_{\\ell}(\\mu)\n$$\nHere, $\\psi_N(\\mu)$ is the $N$-th order approximation to the true flux $\\psi(\\mu)$, and $\\{c_{\\ell}\\}_{\\ell=0}^{N}$ are the unknown expansion coefficients we must determine.\n\nThe problem provides the definition of the Legendre moments of the flux:\n$$\n\\phi_m = \\int_{-1}^{1} \\psi(\\mu) P_m(\\mu) \\,d\\mu\n$$\nTo connect the given moments $\\{\\phi_m\\}$ to the unknown coefficients $\\{c_\\ell\\}$, we enforce the condition that the moments of the approximated flux $\\psi_N(\\mu)$ must be equal to the given moments for all orders up to $N$:\n$$\n\\phi_m = \\int_{-1}^{1} \\psi_N(\\mu) P_m(\\mu) \\,d\\mu \\quad \\text{for } m = 0, 1, \\dots, N\n$$\nSubstituting the series expansion for $\\psi_N(\\mu)$ into this equation gives:\n$$\n\\phi_m = \\int_{-1}^{1} \\left( \\sum_{\\ell=0}^{N} c_{\\ell} P_{\\ell}(\\mu) \\right) P_m(\\mu) \\,d\\mu\n$$\nBy linearity of the integral, we can interchange the summation and integration:\n$$\n\\phi_m = \\sum_{\\ell=0}^{N} c_{\\ell} \\int_{-1}^{1} P_{\\ell}(\\mu) P_m(\\mu) \\,d\\mu\n$$\nThe problem statement provides the orthogonality property of the Legendre polynomials:\n$$\n\\int_{-1}^{1} P_{\\ell}(\\mu) P_m(\\mu) \\,d\\mu = \\frac{2}{2\\ell+1} \\delta_{\\ell m}\n$$\nwhere $\\delta_{\\ell m}$ is the Kronecker delta, which is $1$ if $\\ell = m$ and $0$ otherwise.\n\nSubstituting this orthogonality relation into the equation for $\\phi_m$:\n$$\n\\phi_m = \\sum_{\\ell=0}^{N} c_{\\ell} \\left( \\frac{2}{2\\ell+1} \\delta_{\\ell m} \\right)\n$$\nFor a given $m$ (where $0 \\le m \\le N$), the sum over $\\ell$ collapses to a single non-zero term, which occurs when $\\ell=m$:\n$$\n\\phi_m = c_m \\left( \\frac{2}{2m+1} \\right)\n$$\nWe can now solve for the unknown coefficient $c_m$:\n$$\nc_m = \\frac{2m+1}{2} \\phi_m\n$$\nThis provides a direct relationship between the expansion coefficients and the given moments. By substituting this expression for $c_\\ell$ back into the original series for $\\psi_N(\\mu)$, we obtain the final reconstruction formula:\n$$\n\\psi_N(\\mu) = \\sum_{\\ell=0}^{N} \\frac{2\\ell+1}{2} \\phi_{\\ell} P_{\\ell}(\\mu)\n$$\nThe problem specifies an approximation of order $N=3$. Therefore, the reconstruction formula to be implemented is:\n$$\n\\psi_3(\\mu) = \\frac{1}{2}\\phi_0 P_0(\\mu) + \\frac{3}{2}\\phi_1 P_1(\\mu) + \\frac{5}{2}\\phi_2 P_2(\\mu) + \\frac{7}{2}\\phi_3 P_3(\\mu)\n$$\nThe first four Legendre polynomials are:\n- $P_0(\\mu) = 1$\n- $P_1(\\mu) = \\mu$\n- $P_2(\\mu) = \\frac{1}{2}(3\\mu^2 - 1)$\n- $P_3(\\mu) = \\frac{1}{2}(5\\mu^3 - 3\\mu)$\n\nThe numerical task is to evaluate this expression for $\\psi_3(\\mu)$ for a given set of moments $\\{\\phi_0, \\phi_1, \\phi_2, \\phi_3\\}$ over a uniform grid of $M=1001$ points in the domain $\\mu \\in [-1,1]$. After computing the values of $\\psi_3(\\mu)$ on this grid, we find the minimum value. If this minimum is greater than or equal to $0$, the reconstructed flux is considered non-negative, and the assessment is positive (True). Otherwise, it is negative (False). The physical axiom $\\psi(x,\\mu) \\ge 0$ is not always preserved by the truncated $P_N$ approximation, and this procedure is designed to test for this violation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import legendre\n\ndef solve():\n    \"\"\"\n    Solves the problem by reconstructing the angular flux from moments\n    for a series of test cases and checking for positivity.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: Isotropic positive reference\n        [1.0, 0.0, 0.0, 0.0],\n        # Test 2: Strong first-moment anisotropy\n        [1.0, 0.6, 0.0, 0.0],\n        # Test 3: Linearly anisotropic but positive underlying distribution\n        [1.4, 0.37333333333333335, 0.0, 0.0],\n        # Test 4: Even anisotropy via P2 component\n        [1.8, 0.0, 0.54, 0.0],\n        # Test 5: Boundary-linear case\n        [1.0, 0.3333333333333333, 0.0, 0.0],\n        # Test 6: Non-realizable moment set with zero scalar flux\n        [0.0, 0.3, 0.0, 0.0],\n        # Test 7: Mixed higher-order anisotropy\n        [1.0, 0.2, 0.1, -0.05],\n    ]\n\n    def check_positivity_for_moments(moments, M=1001, N=3):\n        \"\"\"\n        Reconstructs the P3-approximated angular flux from Legendre moments\n        and checks if it is non-negative over the angular domain.\n\n        Args:\n            moments (list or np.ndarray): A list of Legendre moments [phi_0, phi_1, phi_2, phi_3].\n            M (int): The number of points in the uniform angular grid.\n            N (int): The order of the P_N approximation.\n\n        Returns:\n            bool: True if the minimum of the reconstructed flux is >= 0, False otherwise.\n        \"\"\"\n        # Create a uniform grid of M points for the direction cosine mu in [-1, 1].\n        mu_grid = np.linspace(-1.0, 1.0, M)\n        \n        # Initialize the reconstructed flux array.\n        psi_N = np.zeros_like(mu_grid)\n        \n        # The reconstruction formula is:\n        # psi_N(mu) = sum_{l=0 to N} (2*l + 1) / 2 * phi_l * P_l(mu)\n        for l in range(N + 1):\n            # Get the Legendre polynomial of order l.\n            # scipy.special.legendre(l) returns a callable poly1d object.\n            P_l = legendre(l)\n            phi_l = moments[l]\n            psi_N += (2 * l + 1) / 2.0 * phi_l * P_l(mu_grid)\n            \n        # Find the minimum value of the reconstructed flux on the grid.\n        min_psi = np.min(psi_N)\n        \n        # Return True if the minimum value is non-negative, False otherwise.\n        # A small tolerance is not used as per problem specification.\n        return min_psi >= 0.0\n\n    results = []\n    for case in test_cases:\n        is_positive = check_positivity_for_moments(case)\n        results.append(is_positive)\n\n    # Final print statement in the exact required format \"[True,False,True,...]\".\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "To solve the $P_N$ equations on a computer, they must be discretized, leading to a large system of linear algebraic equations. This final practice  provides a look 'under the hood' at the structure of this system for a three-dimensional problem. By analyzing the sparsity pattern and memory footprint, you will gain critical insight into the computational challenges and efficiency considerations inherent in practical reactor simulation codes.",
            "id": "4256665",
            "problem": "Consider the steady-state neutron transport equation in three spatial dimensions for a homogeneous, isotropic medium with an isotropic internal source in a cube domain. Let the angular flux be denoted by $\\psi(\\mathbf{r},\\boldsymbol{\\Omega})$, where $\\mathbf{r}\\in\\Omega\\subset\\mathbb{R}^3$ and $\\boldsymbol{\\Omega}\\in\\mathbb{S}^2$. The steady-state balance is given by the Boltzmann transport equation\n$$\n\\boldsymbol{\\Omega}\\cdot\\nabla \\psi(\\mathbf{r},\\boldsymbol{\\Omega}) + \\Sigma_t \\psi(\\mathbf{r},\\boldsymbol{\\Omega})\n= \\frac{\\Sigma_s}{4\\pi}\\int_{\\mathbb{S}^2}\\psi(\\mathbf{r},\\boldsymbol{\\Omega}')\\,d\\boldsymbol{\\Omega}' + \\frac{Q}{4\\pi},\n$$\nwith total macroscopic cross section $\\Sigma_t$, isotropic scattering cross section $\\Sigma_s$, and isotropic volumetric source $Q$. Introduce the spherical harmonics expansion up to order $N=3$ (the $P_3$ approximation),\n$$\n\\psi(\\mathbf{r},\\boldsymbol{\\Omega}) \\approx \\sum_{\\ell=0}^{3}\\sum_{m=-\\ell}^{\\ell}\\phi_{\\ell}^{m}(\\mathbf{r})\\,Y_{\\ell}^{m}(\\boldsymbol{\\Omega}),\n$$\nwhere $Y_{\\ell}^{m}$ are the (complex or real) spherical harmonics and $\\phi_{\\ell}^{m}(\\mathbf{r})$ are the angular moments (unknown scalar fields). By orthogonality of $Y_{\\ell}^{m}$ on $\\mathbb{S}^2$, one obtains a coupled system of partial differential equations for the moments $\\{\\phi_{\\ell}^{m}\\}$, in which the streaming operator couples orders $\\ell$ only to adjacent orders $\\ell\\pm 1$, and the isotropic source appears only in the $\\ell=0$ equation. Assume a cubic domain $\\Omega=[0,L]^3$ with $L>0$, homogeneous and isotropic material coefficients $\\Sigma_t$ and $\\Sigma_s$, and an isotropic source $Q$ that is spatially uniform.\n\nYou are to formalize the $P_3$ system and, without computing coefficients, determine the sparsity structure of the global algebraic matrix obtained by a standard continuous, trilinear ($Q_1$) finite element method on a uniform hexahedral mesh, under the following modeling choices that characterize only the nonzero pattern (not the values):\n\n- Angular-moment coupling rule: For each angular moment index $(\\ell,m)$ with $\\ell\\in\\{0,1,2,3\\}$ and $m\\in\\{-\\ell,\\ldots,\\ell\\}$, the corresponding algebraic row couples to:\n  - itself (i.e., to $(\\ell,m)$),\n  - all moments in the adjacent lower order $\\ell-1$ (i.e., to all $(\\ell-1,m')$ for $m'\\in\\{-(\\ell-1),\\ldots,(\\ell-1)\\}$) if $\\ell>0$,\n  - all moments in the adjacent higher order $\\ell+1$ (i.e., to all $(\\ell+1,m')$ for $m'\\in\\{-(\\ell+1),\\ldots,(\\ell+1)\\}$) if $\\ell<3$,\n  and to no other moments.\n- Spatial coupling rule: After $Q_1$ finite element discretization on a uniform structured mesh with $N_x$, $N_y$, and $N_z$ elements along the $x$, $y$, and $z$ directions (so that the number of mesh nodes is $(N_x+1)(N_y+1)(N_z+1)$), the assembled global matrix has nonzeros corresponding to the face-neighbor stencil. For a node with coordinates $(i_x,i_y,i_z)$, where $i_x\\in\\{0,\\ldots,N_x\\}$, $i_y\\in\\{0,\\ldots,N_y\\}$, and $i_z\\in\\{0,\\ldots,N_z\\}$, the row couples to:\n  - the same node $(i_x,i_y,i_z)$,\n  - the present face neighbors $(i_x\\pm 1,i_y,i_z)$ if within bounds,\n  - the present face neighbors $(i_x,i_y\\pm 1,i_z)$ if within bounds,\n  - the present face neighbors $(i_x,i_y,i_z\\pm 1)$ if within bounds.\n  There is no coupling to edge or corner diagonal neighbors, and no coupling outside the mesh bounds.\n\nAdopt the following ordering conventions for the global degrees of freedom:\n\n- Moments are ordered by increasing $\\ell\\in\\{0,1,2,3\\}$, and within each $\\ell$ by increasing $m\\in\\{-\\ell,\\ldots,\\ell\\}$.\n- At each spatial node, all angular moments are grouped contiguously using the above moment order.\n- Spatial nodes are ordered lexicographically by $(i_x,i_y,i_z)$, with $i_x$ varying fastest, then $i_y$, then $i_z$.\n\nUnder these assumptions, define the global sparse matrix $A$ of size $n_{\\text{unk}}\\times n_{\\text{unk}}$, where $n_{\\text{unk}}$ is the total number of unknowns (number of nodes times the number of moments). Your task is to compute, for each specified mesh, the following integer metrics:\n\n- The total number of unknowns $n_{\\text{unk}}$.\n- The total number of distinct nonzero entries $\\mathrm{nnz}(A)$ in the assembled matrix $A$.\n- The maximum number of nonzeros in any single row, denoted $\\mathrm{nnz}_{\\max}$.\n- The half-bandwidth $b$ defined by $b=\\max\\{|j-i|:A_{ij}\\neq 0\\}$ under the specified degree-of-freedom ordering.\n\nYour program must implement the above structural rules exactly (do not substitute any alternative stencils or couplings), and must compute the metrics by constructing the sparsity pattern implied by these rules. Do not eliminate boundary degrees of freedom and do not reduce rows due to boundary conditions; treat all nodal and moment unknowns as algebraic unknowns.\n\nUse the following test suite of meshes, given as tuples $(N_x,N_y,N_z)$:\n\n- $(1,1,1)$,\n- $(2,1,1)$,\n- $(2,2,2)$,\n- $(3,2,1)$.\n\nYour program should produce a single line of output containing the results for the four test cases as a comma-separated list enclosed in square brackets, where each test case result is itself a list in the form $[n_{\\text{unk}},\\mathrm{nnz}(A),\\mathrm{nnz}_{\\max},b]$. For example, an output with placeholder integers would look like $[[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],[a_3,b_3,c_3,d_3],[a_4,b_4,c_4,d_4]]$. All outputs are integers with no units.",
            "solution": "The problem requires the calculation of four structural metrics for a global system matrix arising from a specific discretization of the steady-state neutron transport equation. The metrics are the total number of unknowns ($n_{\\text{unk}}$), the total number of non-zero entries ($\\mathrm{nnz}(A)$), the maximum number of non-zeros in any single row ($\\mathrm{nnz}_{\\max}$), and the half-bandwidth ($b$). The solution is derived by analyzing the matrix structure as specified by the problem's coupling and ordering rules, without computing the actual matrix coefficients.\n\nThe global matrix structure is determined by two sets of rules: one for the coupling between the angular moments of the spherical harmonics expansion, and one for the coupling between spatial nodes of the finite element mesh. The degrees of freedom (DoFs) are ordered such that all angular moments are grouped together at each spatial node, and the spatial nodes are ordered lexicographically. This structure implies that the sparsity pattern of the global matrix $A$ corresponds to the Kronecker product of a spatial coupling matrix, $M_{\\text{spat}}$, and an angular moment coupling matrix, $M_{\\text{ang}}$.\n\nFirst, we analyze the angular coupling matrix $M_{\\text{ang}}$.\nThe $P_3$ approximation involves moments up to order $N=3$. The total number of angular moments, $N_{\\text{mom}}$, is given by the sum of moments for each order $\\ell \\in \\{0, 1, 2, 3\\}$:\n$$\nN_{\\text{mom}} = \\sum_{\\ell=0}^{3} (2\\ell+1) = 1 + 3 + 5 + 7 = 16\n$$\nThe problem specifies the coupling rule for any row of $M_{\\text{ang}}$ corresponding to a moment of order $\\ell$: it couples to itself, to all moments of order $\\ell-1$ (if $\\ell>0$), and to all moments of order $\\ell+1$ (if $\\ell<3$). The number of non-zeros in a row of $M_{\\text{ang}}$ for an order-$\\ell$ moment is:\n\\begin{itemize}\n    \\item For $\\ell=0$: $1$ (self) + $(2(1)+1)$ (order 1) = $4$ couplings.\n    \\item For $\\ell=1$: $1$ (self) + $(2(0)+1)$ (order 0) + $(2(2)+1)$ (order 2) = $1+1+5=7$ couplings.\n    \\item For $\\ell=2$: $1$ (self) + $(2(1)+1)$ (order 1) + $(2(3)+1)$ (order 3) = $1+3+7=11$ couplings.\n    \\item For $\\ell=3$: $1$ (self) + $(2(2)+1)$ (order 2) = $1+5=6$ couplings.\n\\end{itemize}\nThe maximum numbers of non-zeros in any row of $M_{\\text{ang}}$ is therefore $\\mathrm{nnz}_{\\max}(M_{\\text{ang}}) = \\max(4, 7, 11, 6) = 11$.\nThe total number of non-zeros in $M_{\\text{ang}}$ is the sum of non-zeros over all rows. Since there are $2\\ell+1$ moments of order $\\ell$, we have:\n$$\n\\mathrm{nnz}(M_{\\text{ang}}) = (1 \\times 4) + (3 \\times 7) + (5 \\times 11) + (7 \\times 6) = 4 + 21 + 55 + 42 = 122\n$$\n\nNext, we analyze the spatial coupling matrix $M_{\\text{spat}}$.\nFor a uniform hexahedral mesh with $N_x, N_y, N_z$ elements, there are $N_{nodes} = (N_x+1)(N_y+1)(N_z+1)$ spatial nodes. The problem specifies that a node couples to itself and its face-neighbors (a 7-point stencil).\nThe number of non-zeros in a row of $M_{\\text{spat}}$ for a given node is $1$ (self-coupling) plus the number of its face neighbors. The total number of non-zeros, $\\mathrm{nnz}(M_{\\text{spat}})$, is the sum of these row counts over all nodes. The maximum number of non-zeros in any row, $\\mathrm{nnz}_{\\max}(M_{\\text{spat}})$, corresponds to the node with the most neighbors. For a 3D grid, an interior node has $6$ neighbors, a face-node $5$, an edge-node $4$, and a corner-node $3$. The values of $\\mathrm{nnz}(M_{\\text{spat}})$ and $\\mathrm{nnz}_{\\max}(M_{\\text{spat}})$ depend on the specific mesh dimensions $(N_x, N_y, N_z)$.\n\nWith the properties of $M_{\\text{ang}}$ and $M_{\\text{spat}}$, we can compute the four required metrics for the global matrix $A$.\n\\begin{enumerate}\n    \\item \\textbf{Total number of unknowns ($n_{\\text{unk}}$)}: This is the product of the number of spatial nodes and the number of angular moments per node.\n    $$n_{\\text{unk}} = N_{\\text{nodes}} \\times N_{\\text{mom}} = ((N_x+1)(N_y+1)(N_z+1)) \\times 16$$\n    \\item \\textbf{Total number of non-zeros ($\\mathrm{nnz}(A)$)}: For a Kronecker product structure, the total number of non-zeros is the product of the non-zeros of the constituent matrices.\n    $$\\mathrm{nnz}(A) = \\mathrm{nnz}(M_{\\text{spat}}) \\times \\mathrm{nnz}(M_{\\text{ang}}) = \\mathrm{nnz}(M_{\\text{spat}}) \\times 122$$\n    \\item \\textbf{Maximum row non-zeros ($\\mathrm{nnz}_{\\max}$)}: Similarly, the maximum number of non-zeros in a row of the Kronecker product is the product of the maximum row non-zeros of the constituent matrices.\n    $$\\mathrm{nnz}_{\\max} = \\mathrm{nnz}_{\\max}(M_{\\text{spat}}) \\times \\mathrm{nnz}_{\\max}(M_{\\text{ang}}) = (1 + \\text{max\\_neighbors}) \\times 11$$\n    \\item \\textbf{Half-bandwidth ($b$)}: The half-bandwidth is $b = \\max |k - k'|$ over all pairs $(k,k')$ where $A_{k,k'} \\neq 0$. The global index $k$ for a DoF at spatial node $p$ and moment $q$ is $k = p \\cdot N_{\\text{mom}} + q$. The spatial nodes are indexed lexicographically, $p = i_x + i_y(N_x+1) + i_z(N_x+1)(N_y+1)$. The difference is $k - k' = (p-p')N_{\\text{mom}} + (q-q')$. This difference is maximized when the spatial index difference $|p-p'|$ is maximized. The largest spatial index jump between face neighbors occurs for neighbors in the $z$-direction, where $|p-p'| = (N_x+1)(N_y+1)$. The maximum possible absolute difference between coupled angular moment indices $|q-q'|$ is 11. The half-bandwidth is then:\n    $$b = \\max|p-p'| \\cdot N_{\\text{mom}} + \\max|q-q'| = ((N_x+1)(N_y+1)) \\times 16 + 11$$\n\\end{enumerate}\nThese formulas are implemented for each test case to obtain the final results.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_metrics(Nx, Ny, Nz):\n    \"\"\"\n    Computes structural metrics for the global matrix based on problem rules.\n\n    Args:\n        Nx (int): Number of elements along the x-direction.\n        Ny (int): Number of elements along the y-direction.\n        Nz (int): Number of elements along the z-direction.\n\n    Returns:\n        list: A list containing [n_unk, nnz(A), nnz_max, b].\n    \"\"\"\n    # 1. Angular moment analysis (constant for all test cases)\n    # The P_3 approximation has orders l=0,1,2,3.\n    # Total number of moments is (3+1)^2 = 16.\n    N_mom = 16\n\n    # Number of couplings for a row of moment order l, based on the rule:\n    # row couples to self, all moments in l-1, and all moments in l+1.\n    # Moments per order l: 2*l+1.\n    # l=0: 1(self) + (2*1+1) = 4\n    # l=1: 1(self) + (2*0+1) + (2*2+1) = 7\n    # l=2: 1(self) + (2*1+1) + (2*3+1) = 11\n    # l=3: 1(self) + (2*2+1) = 6\n    nnz_row_ang = {0: 4, 1: 7, 2: 11, 3: 6}\n    moments_per_l = {0: 1, 1: 3, 2: 5, 3: 7}\n\n    # Total nonzeros in the angular coupling matrix M_ang\n    nnz_M_ang = sum(moments_per_l[l] * nnz_row_ang[l] for l in range(4))\n\n    # Max nonzeros in any row of M_ang\n    max_row_nnz_M_ang = max(nnz_row_ang.values())\n    \n    # max|q-q'| from coupling between l=2 and l=3 moments under specified indexing.\n    # Indices are 0-15. Coupling is between adjacent orders. max diff is between\n    # last moment of l=3 (index 15) and first of l=2 (index 4), giving 11.\n    max_delta_q = 11\n\n    # 2. Spatial node analysis (depends on the mesh)\n    num_nodes_x = Nx + 1\n    num_nodes_y = Ny + 1\n    num_nodes_z = Nz + 1\n    N_nodes = num_nodes_x * num_nodes_y * num_nodes_z\n\n    # Calculate total nonzeros and max row nonzeros for the spatial coupling matrix M_spat\n    total_spatial_couplings = 0\n    max_neighbors = 0\n    for iz in range(num_nodes_z):\n        for iy in range(num_nodes_y):\n            for ix in range(num_nodes_x):\n                neighbors = 0\n                if ix > 0: neighbors += 1\n                if ix  num_nodes_x - 1: neighbors += 1\n                if iy > 0: neighbors += 1\n                if iy  num_nodes_y - 1: neighbors += 1\n                if iz > 0: neighbors += 1\n                if iz  num_nodes_z - 1: neighbors += 1\n\n                # Couplings for this node's row in M_spat is 1 (self) + neighbors\n                row_couplings = 1 + neighbors\n                total_spatial_couplings += row_couplings\n                if neighbors > max_neighbors:\n                    max_neighbors = neighbors\n\n    nnz_M_spat = total_spatial_couplings\n    max_row_nnz_M_spat = 1 + max_neighbors\n\n    # 3. Combine results for the global matrix A\n    # Total number of unknowns\n    n_unk = N_nodes * N_mom\n\n    # Total number of nonzeros, based on Kronecker product structure\n    nnz_A = nnz_M_spat * nnz_M_ang\n\n    # Maximum nonzeros in any single row\n    nnz_max = max_row_nnz_M_spat * max_row_nnz_M_ang\n\n    # Half-bandwidth b = max|k-k'|\n    # The largest jump in lexicographic node index p is the z-stride.\n    z_stride = num_nodes_x * num_nodes_y\n    # b = max| (p-p')*N_mom + (q-q') | = max|p-p'|*N_mom + max|q-q'|\n    b = z_stride * N_mom + max_delta_q\n\n    return [int(n_unk), int(nnz_A), int(nnz_max), int(b)]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1, 1, 1),\n        (2, 1, 1),\n        (2, 2, 2),\n        (3, 2, 1),\n    ]\n\n    results = []\n    for case in test_cases:\n        metrics = calculate_metrics(*case)\n        results.append(metrics)\n\n    # Final print statement in the exact required format.\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}