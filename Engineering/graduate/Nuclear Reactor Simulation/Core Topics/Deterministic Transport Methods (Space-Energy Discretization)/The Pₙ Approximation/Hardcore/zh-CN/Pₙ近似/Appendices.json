{
    "hands_on_practices": [
        {
            "introduction": "球谐函数（$P_n$）方法的核心是使用勒让德多项式作为基函数来展开中子角通量。在应用这些基函数之前，我们必须首先掌握它们的生成方式和基本性质。本练习将引导你使用罗德里格斯公式（Rodrigues' formula）推导前几个勒让德多项式，并验证其正交性和归一化属性，这些属性对于后续推导和应用至关重要 。通过这个基础计算，你将对 $P_n$ 近似所依赖的数学工具有更深刻的理解。",
            "id": "4256614",
            "problem": "在一维板几何中子输运中，球谐函数 ($P_{n}$) 近似将中子角通量的角相关性展开为方向余弦变量 $\\mu \\in [-1,1]$ 上的勒让德多项式。从勒让德多项式通过 Rodrigues 构造法的基本定义出发，并将其视为在 $[-1,1]$ 上与单位权重的勒让德微分算子相关的正交本征函数，推导出前四个勒让德多项式 $P_{0}(\\mu)$ 到 $P_{3}(\\mu)$。然后，确认其归一化符合输运惯例，即对于 $\\ell=0,1,2,3$ 有 $P_{\\ell}(1)=1$，并且在 $[-1,1]$ 上权重为1的正交性成立，使得自内积满足 $\\int_{-1}^{1} P_{\\ell}(\\mu)^{2} \\, d\\mu = \\frac{2}{2\\ell+1}$ (对于 $\\ell=0,1,2,3$)，以及互内积满足 $\\int_{-1}^{1} P_{\\ell}(\\mu) P_{m}(\\mu) \\, d\\mu=0$ (对于 $\\ell \\neq m$ 且 $\\ell,m \\in \\{0,1,2,3\\}$)。以 $\\mu$ 的函数形式明确给出这四个多项式的闭式表达式。最终答案必须是这四个多项式组成的单个行矩阵。无需四舍五入。",
            "solution": "该问题要求从 Rodrigues 构造法出发，推导前四个勒让德多项式 $P_{0}(\\mu)$ 到 $P_{3}(\\mu)$。这些多项式是中子输运方程的 $P_{n}$ 近似方法的基础，它们构成了一个正交基，用于在方向余弦定义域 $\\mu \\in [-1, 1]$ 上展开中子通量的角相关性。在推导出这些多项式之后，必须明确验证它们的归一化和正交性，这些性质在输运理论中的应用至关重要。\n\n勒让德多项式 $P_{\\ell}(\\mu)$ 的 Rodrigues 公式如下：\n$$ P_{\\ell}(\\mu) = \\frac{1}{2^{\\ell} \\ell!} \\frac{d^{\\ell}}{d\\mu^{\\ell}} (\\mu^2 - 1)^\\ell $$\n我们将对 $\\ell=0, 1, 2, 3$ 应用此公式。\n\n对于 $\\ell=0$：\n$$ P_{0}(\\mu) = \\frac{1}{2^{0} 0!} \\frac{d^{0}}{d\\mu^{0}} (\\mu^2 - 1)^0 = \\frac{1}{1 \\cdot 1} \\cdot 1 = 1 $$\n\n对于 $\\ell=1$：\n$$ P_{1}(\\mu) = \\frac{1}{2^{1} 1!} \\frac{d}{d\\mu} (\\mu^2 - 1)^1 = \\frac{1}{2} (2\\mu) = \\mu $$\n\n对于 $\\ell=2$：\n$$ P_{2}(\\mu) = \\frac{1}{2^{2} 2!} \\frac{d^2}{d\\mu^2} (\\mu^2 - 1)^2 = \\frac{1}{8} \\frac{d^2}{d\\mu^2} (\\mu^4 - 2\\mu^2 + 1) $$\n一阶导数为 $\\frac{d}{d\\mu}(\\mu^4 - 2\\mu^2 + 1) = 4\\mu^3 - 4\\mu$。\n二阶导数为 $\\frac{d}{d\\mu}(4\\mu^3 - 4\\mu) = 12\\mu^2 - 4$。\n因此，\n$$ P_{2}(\\mu) = \\frac{1}{8} (12\\mu^2 - 4) = \\frac{4}{8} (3\\mu^2 - 1) = \\frac{1}{2} (3\\mu^2 - 1) $$\n\n对于 $\\ell=3$：\n$$ P_{3}(\\mu) = \\frac{1}{2^{3} 3!} \\frac{d^3}{d\\mu^3} (\\mu^2 - 1)^3 = \\frac{1}{8 \\cdot 6} \\frac{d^3}{d\\mu^3} (\\mu^6 - 3\\mu^4 + 3\\mu^2 - 1) $$\n一阶导数为 $6\\mu^5 - 12\\mu^3 + 6\\mu$。\n二阶导数为 $30\\mu^4 - 36\\mu^2 + 6$。\n三阶导数为 $120\\mu^3 - 72\\mu$。\n因此，\n$$ P_{3}(\\mu) = \\frac{1}{48} (120\\mu^3 - 72\\mu) = \\frac{24}{48} (5\\mu^3 - 3\\mu) = \\frac{1}{2} (5\\mu^3 - 3\\mu) $$\n\n前四个勒让德多项式是：\n$P_0(\\mu) = 1$\n$P_1(\\mu) = \\mu$\n$P_2(\\mu) = \\frac{1}{2}(3\\mu^2 - 1)$\n$P_3(\\mu) = \\frac{1}{2}(5\\mu^3 - 3\\mu)$\n\n接下来，我们验证对于 $\\ell = 0, 1, 2, 3$ 的归一化条件 $P_{\\ell}(1)=1$。\n对于 $\\ell=0$：$P_{0}(1) = 1$。\n对于 $\\ell=1$：$P_{1}(1) = 1$。\n对于 $\\ell=2$：$P_{2}(1) = \\frac{1}{2}(3(1)^2 - 1) = \\frac{1}{2}(2) = 1$。\n对于 $\\ell=3$：$P_{3}(1) = \\frac{1}{2}(5(1)^3 - 3(1)) = \\frac{1}{2}(2) = 1$。\n归一化条件得到满足。\n\n最后，我们验证在区间 $[-1,1]$ 上权重为 $1$ 的正交关系。\n\n首先，自内积：$\\int_{-1}^{1} P_{\\ell}(\\mu)^2 \\, d\\mu = \\frac{2}{2\\ell+1}$。\n对于 $\\ell=0$：$\\int_{-1}^{1} P_{0}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} 1^2 \\, d\\mu = [\\mu]_{-1}^{1} = 1 - (-1) = 2$。公式给出 $\\frac{2}{2(0)+1} = 2$。\n对于 $\\ell=1$：$\\int_{-1}^{1} P_{1}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\mu^2 \\, d\\mu = \\left[\\frac{\\mu^3}{3}\\right]_{-1}^{1} = \\frac{1}{3} - \\frac{-1}{3} = \\frac{2}{3}$。公式给出 $\\frac{2}{2(1)+1} = \\frac{2}{3}$。\n对于 $\\ell=2$：$\\int_{-1}^{1} P_{2}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\left(\\frac{1}{2}(3\\mu^2 - 1)\\right)^2 \\, d\\mu = \\frac{1}{4} \\int_{-1}^{1} (9\\mu^4 - 6\\mu^2 + 1) \\, d\\mu = \\frac{1}{4} \\left[ \\frac{9\\mu^5}{5} - 2\\mu^3 + \\mu \\right]_{-1}^{1} = \\frac{1}{4} \\left( (\\frac{9}{5} - 2 + 1) - (-\\frac{9}{5} + 2 - 1) \\right) = \\frac{1}{4} \\left( \\frac{4}{5} - (-\\frac{4}{5}) \\right) = \\frac{1}{4} \\left(\\frac{8}{5}\\right) = \\frac{2}{5}$。公式给出 $\\frac{2}{2(2)+1} = \\frac{2}{5}$。\n对于 $\\ell=3$：$\\int_{-1}^{1} P_{3}(\\mu)^2 \\, d\\mu = \\int_{-1}^{1} \\left(\\frac{1}{2}(5\\mu^3 - 3\\mu)\\right)^2 \\, d\\mu = \\frac{1}{4} \\int_{-1}^{1} (25\\mu^6 - 30\\mu^4 + 9\\mu^2) \\, d\\mu = \\frac{1}{4} \\left[ \\frac{25\\mu^7}{7} - 6\\mu^5 + 3\\mu^3 \\right]_{-1}^{1} = \\frac{1}{4} \\left( (\\frac{25}{7} - 6 + 3) - (-\\frac{25}{7} + 6 - 3) \\right) = \\frac{1}{4} \\left( \\frac{4}{7} - (-\\frac{4}{7}) \\right) = \\frac{1}{4} \\left(\\frac{8}{7}\\right) = \\frac{2}{7}$。公式给出 $\\frac{2}{2(3)+1} = \\frac{2}{7}$。\n所有自内积均正确。\n\n其次，互内积：$\\int_{-1}^{1} P_{\\ell}(\\mu) P_{m}(\\mu) \\, d\\mu = 0$ (对于 $\\ell \\neq m$)。\n我们注意到，当 $\\ell$ 为偶数时，$P_\\ell(\\mu)$ 是偶函数；当 $\\ell$ 为奇数时，$P_\\ell(\\mu)$ 是奇函数。在对称区间如 $[-1,1]$ 上，一个偶函数与一个奇函数的乘积的积分为零。\n奇偶性混合的情况（$\\ell$ 偶，$m$ 奇，或反之）：\n$\\int_{-1}^{1} P_{0}(\\mu)P_{1}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{0}(\\mu)P_{3}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{1}(\\mu)P_{2}(\\mu) \\, d\\mu = 0$\n$\\int_{-1}^{1} P_{2}(\\mu)P_{3}(\\mu) \\, d\\mu = 0$\n由于被积函数的奇偶性，这些积分都为零。\n\n奇偶性相同的情况：\n对于 $\\ell=0, m=2$：\n$\\int_{-1}^{1} P_{0}(\\mu)P_{2}(\\mu) \\, d\\mu = \\int_{-1}^{1} (1) \\left(\\frac{1}{2}(3\\mu^2 - 1)\\right) \\, d\\mu = \\frac{1}{2} [\\mu^3 - \\mu]_{-1}^{1} = \\frac{1}{2} ((1-1) - (-1 - (-1))) = 0$。\n对于 $\\ell=1, m=3$：\n$\\int_{-1}^{1} P_{1}(\\mu)P_{3}(\\mu) \\, d\\mu = \\int_{-1}^{1} (\\mu) \\left(\\frac{1}{2}(5\\mu^3 - 3\\mu)\\right) \\, d\\mu = \\frac{1}{2} \\int_{-1}^{1} (5\\mu^4 - 3\\mu^2) \\, d\\mu = \\frac{1}{2} [\\mu^5 - \\mu^3]_{-1}^{1} = \\frac{1}{2} ((1-1) - (-1 - (-1))) = 0$。\n对于所有 $\\ell, m \\in \\{0, 1, 2, 3\\}$ 且 $\\ell \\neq m$ 的数对，正交性得到证实。\n\n推导和验证完成。这四个多项式在最终答案中给出。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix} 1  \\mu  \\frac{1}{2}(3\\mu^2 - 1)  \\frac{1}{2}(5\\mu^3 - 3\\mu) \\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在实际的中子输运计算中，求解器通常直接计算的是角通量的勒让德矩（moments），而非完整的角通量本身。因此，从这些计算出的矩重构角通量是一项关键的后处理任务。本练习将指导你实现一个重构算法，将抽象的矩转换为具体的角通量分布，并探讨一个 $P_n$ 近似方法的关键物理局限性：重构出的角通量是否保证为非负值 。这项实践连接了理论计算与物理现实，突出了近似方法在实际应用中的细微之处。",
            "id": "4256647",
            "problem": "考虑一维平板几何中的单速、稳态中子输运，其中角通量 $\\psi(x,\\mu)$ 取决于空间坐标 $x$ 和方向余弦 $\\mu \\in [-1,1]$。球谐函数 (SH) 方法使用勒让德多项式 $P_{\\ell}(\\mu)$ 来近似角相关性，输运求解器通常计算一组有限的勒让德矩 $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{n}$，其中每个矩由基本关系 $\\phi_{\\ell}(x) = \\int_{-1}^{1} \\psi(x,\\mu) P_{\\ell}(\\mu)\\,d\\mu$ 定义。勒让德多项式满足经过充分检验的正交性 $\\int_{-1}^{1} P_{\\ell}(\\mu) P_{m}(\\mu)\\,d\\mu = \\frac{2}{2\\ell+1}\\delta_{\\ell m}$，其中 $\\delta_{\\ell m}$ 是克罗内克 δ。物理角通量必须对所有的 $\\mu \\in [-1,1]$ 和所有的 $x$ 满足 $\\psi(x,\\mu) \\ge 0$。\n\n仅从这些事实出发，推导如何使用勒让德多项式的截断展开（对于 $n=3$），从计算出的矩 $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{n}$ 重构近似角通量 $\\psi_{n}(x,\\mu)$。然后实现此重构，并通过在 $\\mu$ 的 $M=1001$ 个点的均匀网格上评估重构的 $\\psi_{3}(x,\\mu)$ 并检查其最小值是否为非负，来评估 $\\psi_{3}(x,\\mu)$ 在整个角域 $\\mu \\in [-1,1]$ 上的正性。\n\n您的程序必须：\n- 实现重构算法，该算法使用最高到3阶的勒让德多项式，将固定空间坐标 $x$ 处的给定矩列表 $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\}$ 映射到截断角通量近似 $\\psi_{3}(x,\\mu)$。\n- 在 $[-1,1]$ 范围内包含 $M=1001$ 个点的 $\\mu$ 均匀网格上评估 $\\psi_{3}(x,\\mu)$。\n- 返回一个布尔值，指示重构的通量在所有采样角度上是否为非负，即 $\\min_{\\mu \\in [-1,1]} \\psi_{3}(x,\\mu) \\ge 0$ 是否成立。\n\n不需要物理单位，因为根据定义 $\\mu$ 是无量纲的（极角的余弦），并且输入中没有明确出现角度；因此不需要指定角度单位。正性检验必须在所述数值网格的意义上是精确的。\n\n在单个空间位置 $x$ 使用以下矩集测试套件：\n- 测试 1 (各向同性正参考): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.0, 0.0, 0.0\\}$。\n- 测试 2 (强一阶矩各向异性): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.6, 0.0, 0.0\\}$。\n- 测试 3 (线性各向异性但具有正潜在分布，其中 $A=0.7$, $\\alpha=0.8$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.4, 0.37333333333333335, 0.0, 0.0\\}$。\n- 测试 4 (通过 $P_{2}$ 分量实现的偶数阶各向异性，其中 $A=0.9$, $\\beta=1.5$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.8, 0.0, 0.54, 0.0\\}$。\n- 测试 5 (边界线性情况，其中 $A=0.5$, $\\alpha=1.0$): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.3333333333333333, 0.0, 0.0\\}$。\n- 测试 6 (标量通量为零的不可实现矩集): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{0.0, 0.3, 0.0, 0.0\\}$。\n- 测试 7 (混合高阶各向异性): $\\{\\phi_{0},\\phi_{1},\\phi_{2},\\phi_{3}\\} = \\{1.0, 0.2, 0.1, -0.05\\}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[result1,result2,\\dots]$），其中每个条目是对应于相应测试用例的正性评估的布尔值，顺序与上面列出的一致。",
            "solution": "该问题要求推导一种方法，用于从给定的一组勒让德矩 $\\{\\phi_{\\ell}(x)\\}_{\\ell=0}^{n}$ 重构近似角中子通量 $\\psi_n(x, \\mu)$，然后实现此 $n=3$ 的重构以评估其正性。该问题设定在一维平板几何中，其中 $\\psi$ 取决于位置 $x$ 和极角余弦 $\\mu \\in [-1,1]$。推导将在一个固定的空间坐标 $x$ 上进行，因此为简化符号，将省略对 $x$ 的依赖，例如写作 $\\psi(\\mu)$ 和 $\\phi_{\\ell}$。\n\n球谐函数 ($P_n$) 方法的基础是用勒让德多项式 $P_{\\ell}(\\mu)$ 的截断级数来近似角通量 $\\psi(\\mu)$：\n$$\n\\psi_n(\\mu) = \\sum_{\\ell=0}^{n} c_{\\ell} P_{\\ell}(\\mu)\n$$\n在这里，$\\psi_n(\\mu)$ 是对真实通量 $\\psi(\\mu)$ 的 $n$ 阶近似，而 $\\{c_{\\ell}\\}_{\\ell=0}^{n}$ 是我们必须确定的未知展开系数。\n\n问题给出了通量的勒让德矩的定义：\n$$\n\\phi_m = \\int_{-1}^{1} \\psi(\\mu) P_m(\\mu) \\,d\\mu\n$$\n为了将给定的矩 $\\{\\phi_m\\}$ 与未知的系数 $\\{c_\\ell\\}$ 联系起来，我们强制要求近似通量 $\\psi_n(\\mu)$ 的矩必须等于给定的矩，直到阶数 $n$：\n$$\n\\phi_m = \\int_{-1}^{1} \\psi_n(\\mu) P_m(\\mu) \\,d\\mu \\quad \\text{for } m = 0, 1, \\dots, n\n$$\n将 $\\psi_n(\\mu)$ 的级数展开式代入此方程可得：\n$$\n\\phi_m = \\int_{-1}^{1} \\left( \\sum_{\\ell=0}^{n} c_{\\ell} P_{\\ell}(\\mu) \\right) P_m(\\mu) \\,d\\mu\n$$\n根据积分的线性性质，我们可以交换求和与积分的顺序：\n$$\n\\phi_m = \\sum_{\\ell=0}^{n} c_{\\ell} \\int_{-1}^{1} P_{\\ell}(\\mu) P_m(\\mu) \\,d\\mu\n$$\n问题陈述提供了勒让德多项式的正交性：\n$$\n\\int_{-1}^{1} P_{\\ell}(\\mu) P_m(\\mu) \\,d\\mu = \\frac{2}{2\\ell+1} \\delta_{\\ell m}\n$$\n其中 $\\delta_{\\ell m}$ 是克罗内克 δ，当 $\\ell = m$ 时为 $1$，否则为 $0$。\n\n将此正交关系代入 $\\phi_m$ 的方程中：\n$$\n\\phi_m = \\sum_{\\ell=0}^{n} c_{\\ell} \\left( \\frac{2}{2\\ell+1} \\delta_{\\ell m} \\right)\n$$\n对于给定的 $m$ (其中 $0 \\le m \\le n$), 对 $\\ell$ 的求和会收缩为唯一的非零项，这发生在 $\\ell=m$ 时：\n$$\n\\phi_m = c_m \\left( \\frac{2}{2m+1} \\right)\n$$\n我们现在可以解出未知系数 $c_m$：\n$$\nc_m = \\frac{2m+1}{2} \\phi_m\n$$\n这提供了展开系数和给定矩之间的直接关系。将 $c_\\ell$ 的这个表达式代回 $\\psi_n(\\mu)$ 的原始级数中，我们得到最终的重构公式：\n$$\n\\psi_n(\\mu) = \\sum_{\\ell=0}^{n} \\frac{2\\ell+1}{2} \\phi_{\\ell} P_{\\ell}(\\mu)\n$$\n问题指定了阶数为 $n=3$ 的近似。因此，要实现的重构公式是：\n$$\n\\psi_3(\\mu) = \\frac{1}{2}\\phi_0 P_0(\\mu) + \\frac{3}{2}\\phi_1 P_1(\\mu) + \\frac{5}{2}\\phi_2 P_2(\\mu) + \\frac{7}{2}\\phi_3 P_3(\\mu)\n$$\n前四个勒让德多项式是：\n- $P_0(\\mu) = 1$\n- $P_1(\\mu) = \\mu$\n- $P_2(\\mu) = \\frac{1}{2}(3\\mu^2 - 1)$\n- $P_3(\\mu) = \\frac{1}{2}(5\\mu^3 - 3\\mu)$\n\n数值任务是在域 $\\mu \\in [-1,1]$ 的一个包含 $M=1001$ 个点的均匀网格上，为给定的一组矩 $\\{\\phi_0, \\phi_1, \\phi_2, \\phi_3\\}$ 计算这个 $\\psi_3(\\mu)$ 表达式。在计算出此网格上 $\\psi_3(\\mu)$ 的值后，我们找到其最小值。如果这个最小值大于或等于 $0$，则重构的通量被认为是非负的，评估结果为正 (True)。否则，为负 (False)。物理公理 $\\psi(x,\\mu) \\ge 0$ 并不总是被截断的 $P_n$ 近似所保持，而这个程序就是为了测试这种违规情况而设计的。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import legendre\n\ndef solve():\n    \"\"\"\n    Solves the problem by reconstructing the angular flux from moments\n    for a series of test cases and checking for positivity.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: Isotropic positive reference\n        [1.0, 0.0, 0.0, 0.0],\n        # Test 2: Strong first-moment anisotropy\n        [1.0, 0.6, 0.0, 0.0],\n        # Test 3: Linearly anisotropic but positive underlying distribution\n        [1.4, 0.37333333333333335, 0.0, 0.0],\n        # Test 4: Even anisotropy via P2 component\n        [1.8, 0.0, 0.54, 0.0],\n        # Test 5: Boundary-linear case\n        [1.0, 0.3333333333333333, 0.0, 0.0],\n        # Test 6: Non-realizable moment set with zero scalar flux\n        [0.0, 0.3, 0.0, 0.0],\n        # Test 7: Mixed higher-order anisotropy\n        [1.0, 0.2, 0.1, -0.05],\n    ]\n\n    def check_positivity_for_moments(moments, M=1001, n_order=3):\n        \"\"\"\n        Reconstructs the Pn-approximated angular flux from Legendre moments\n        and checks if it is non-negative over the angular domain.\n\n        Args:\n            moments (list or np.ndarray): A list of Legendre moments [phi_0, phi_1, phi_2, phi_3].\n            M (int): The number of points in the uniform angular grid.\n            n_order (int): The order of the P_n approximation.\n\n        Returns:\n            bool: True if the minimum of the reconstructed flux is = 0, False otherwise.\n        \"\"\"\n        # Create a uniform grid of M points for the direction cosine mu in [-1, 1].\n        mu_grid = np.linspace(-1.0, 1.0, M)\n        \n        # Initialize the reconstructed flux array.\n        psi_n = np.zeros_like(mu_grid)\n        \n        # The reconstruction formula is:\n        # psi_n(mu) = sum_{l=0 to n} (2*l + 1) / 2 * phi_l * P_l(mu)\n        for l in range(n_order + 1):\n            # Get the Legendre polynomial of order l.\n            # scipy.special.legendre(l) returns a callable poly1d object.\n            P_l = legendre(l)\n            phi_l = moments[l]\n            psi_n += (2 * l + 1) / 2.0 * phi_l * P_l(mu_grid)\n            \n        # Find the minimum value of the reconstructed flux on the grid.\n        min_psi = np.min(psi_n)\n        \n        # Return True if the minimum value is non-negative, False otherwise.\n        # A small tolerance is not used as per problem specification.\n        return min_psi = 0.0\n\n    results = []\n    for case in test_cases:\n        is_positive = check_positivity_for_moments(case)\n        results.append(is_positive)\n\n    # Final print statement in the exact required format \"[True,False,True,...]\".\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "为了解决实际的工程问题，我们不仅要在角度上进行 $P_n$ 离散，还必须在空间上进行离散，这通常会产生一个大规模的代数方程组。求解这个方程组的效率在很大程度上取决于其全局矩阵的结构特性。本练习将带你从 $P_n$ 近似和有限元空间离散的耦合规则出发，分析最终生成的全局稀疏矩阵的结构 。通过计算未知数总数、非零元数量和带宽等指标，你将学会如何评估数值模型的计算成本和内存需求，这是进行大规模科学计算时不可或缺的技能。",
            "id": "4256665",
            "problem": "考虑在立方体区域中，具有各向同性内源的均匀各向同性介质内的三维空间稳态中子输运方程。设角通量表示为 $\\psi(\\mathbf{r},\\boldsymbol{\\Omega})$，其中 $\\mathbf{r}\\in\\Omega\\subset\\mathbb{R}^3$ 且 $\\boldsymbol{\\Omega}\\in\\mathbb{S}^2$。稳态平衡由玻尔兹曼输运方程给出\n$$\n\\boldsymbol{\\Omega}\\cdot\\nabla \\psi(\\mathbf{r},\\boldsymbol{\\Omega}) + \\Sigma_t \\psi(\\mathbf{r},\\boldsymbol{\\Omega})\n= \\frac{\\Sigma_s}{4\\pi}\\int_{\\mathbb{S}^2}\\psi(\\mathbf{r},\\boldsymbol{\\Omega}')\\,d\\boldsymbol{\\Omega}' + \\frac{Q}{4\\pi},\n$$\n其中，$\\Sigma_t$ 为总宏观截面，$\\Sigma_s$ 为各向同性散射截面，$Q$ 为各向同性体源。引入阶数最高为 $n=3$ 的球谐函数展开（$P_3$ 近似），\n$$\n\\psi(\\mathbf{r},\\boldsymbol{\\Omega}) \\approx \\sum_{\\ell=0}^{3}\\sum_{m=-\\ell}^{\\ell}\\phi_{\\ell}^{m}(\\mathbf{r})\\,Y_{\\ell}^{m}(\\boldsymbol{\\Omega}),\n$$\n其中 $Y_{\\ell}^{m}$ 是（复数或实数）球谐函数，$\\phi_{\\ell}^{m}(\\mathbf{r})$ 是角矩（未知的标量场）。利用 $Y_{\\ell}^{m}$ 在 $\\mathbb{S}^2$ 上的正交性，可以得到一个关于矩 $\\{\\phi_{\\ell}^{m}\\}$ 的偏微分方程耦合系统，其中流算子仅将阶 $\\ell$ 与相邻的阶 $\\ell\\pm 1$ 耦合，而各向同性源仅出现在 $\\ell=0$ 的方程中。假设区域为立方体 $\\Omega=[0,L]^3$（其中 $L0$），材料系数 $\\Sigma_t$ 和 $\\Sigma_s$ 是均匀且各向同性的，各向同性源 $Q$ 在空间上是均匀的。\n\n本题要求你形式化 $P_3$ 系统，并且在不计算系数的情况下，确定通过在均匀六面体网格上使用标准的连续三线性 ($Q_1$) 有限元方法得到的全局代数矩阵的稀疏结构。此过程需遵循以下仅描述非零模式（而非具体数值）的建模选择：\n\n- 角矩耦合规则：对于每个角矩索引 $(\\ell,m)$（其中 $\\ell\\in\\{0,1,2,3\\}$ 且 $m\\in\\{-\\ell,\\ldots,\\ell\\}$），对应的代数行耦合到：\n  - 自身（即，耦合到 $(\\ell,m)$），\n  - 如果 $\\ell0$，耦合到相邻低阶 $\\ell-1$ 中的所有矩（即，耦合到所有 $(\\ell-1,m')$，其中 $m'\\in\\{-(\\ell-1),\\ldots,(\\ell-1)\\}$），\n  - 如果 $\\ell3$，耦合到相邻高阶 $\\ell+1$ 中的所有矩（即，耦合到所有 $(\\ell+1,m')$，其中 $m'\\in\\{-(\\ell+1),\\ldots,(\\ell+1)\\}$），\n  且不与其他任何矩耦合。\n- 空间耦合规则：在具有 $N_x$、$N_y$ 和 $N_z$ 个单元（因此节点数为 $(N_x+1)(N_y+1)(N_z+1)$）的均匀结构化网格上进行 $Q_1$ 有限元离散后，组装的全局矩阵的非零元对应于面相邻模板。对于坐标为 $(i_x,i_y,i_z)$ 的节点（其中 $i_x\\in\\{0,\\ldots,N_x\\}$，$i_y\\in\\{0,\\ldots,N_y\\}$，$i_z\\in\\{0,\\ldots,N_z\\}$），该行耦合到：\n  - 同一节点 $(i_x,i_y,i_z)$，\n  - 存在的面相邻节点 $(i_x\\pm 1,i_y,i_z)$（如果在边界内），\n  - 存在的面相邻节点 $(i_x,i_y\\pm 1,i_z)$（如果在边界内），\n  - 存在的面相邻节点 $(i_x,i_y,i_z\\pm 1)$（如果在边界内）。\n  不存在与边或角对角相邻节点的耦合，也不存在与网格边界外的耦合。\n\n对全局自由度采用以下排序约定：\n\n- 矩按 $\\ell\\in\\{0,1,2,3\\}$ 递增排序，在每个 $\\ell$ 内按 $m\\in\\{-\\ell,\\ldots,\\ell\\}$ 递增排序。\n- 在每个空间节点处，所有角矩都按照上述矩顺序连续分组。\n- 空间节点按 $(i_x,i_y,i_z)$ 字典序排序，其中 $i_x$ 变化最快，然后是 $i_y$，然后是 $i_z$。\n\n在这些假设下，定义大小为 $n_{\\text{unk}}\\times n_{\\text{unk}}$ 的全局稀疏矩阵 $A$，其中 $n_{\\text{unk}}$ 是未知数的总数（节点数乘以矩的数量）。你的任务是为每个指定的网格计算以下整数指标：\n\n- 未知数总数 $n_{\\text{unk}}$。\n- 组装后矩阵 $A$ 中不同非零元的总数 $\\mathrm{nnz}(A)$。\n- 任意单行中的最大非零元数，记为 $\\mathrm{nnz}_{\\max}$。\n- 半带宽 $b$，定义为 $b=\\max\\{|j-i|:A_{ij}\\neq 0\\}$，其中排序方式为指定的自由度排序。\n\n你的程序必须严格实现上述结构规则（不得替换为任何替代的模板或耦合方式），并且必须通过构建这些规则所隐含的稀疏模式来计算这些指标。不要消除边界自由度，也不要因为边界条件而减少行数；将所有节点和矩未知数都视为代数未知数。\n\n使用以下网格测试套件，以元组 $(N_x,N_y,N_z)$ 的形式给出：\n\n- $(1,1,1)$,\n- $(2,1,1)$,\n- $(2,2,2)$,\n- $(3,2,1)$.\n\n你的程序应该生成单行输出，其中包含四个测试用例的结果，格式为一个逗号分隔的列表，并用方括号括起来。每个测试用例的结果本身也是一个列表，形式为 $[n_{\\text{unk}},\\mathrm{nnz}(A),\\mathrm{nnz}_{\\max},b]$。例如，使用占位符整数的输出应如下所示：$[[a_1,b_1,c_1,d_1],[a_2,b_2,c_2,d_2],[a_3,b_3,c_3,d_3],[a_4,b_4,c_4,d_4]]$。所有输出均为不带单位的整数。",
            "solution": "该问题要求计算一个全局系统矩阵的四个结构指标，该矩阵源于对稳态中子输运方程的特定离散化。这些指标是未知数总数（$n_{\\text{unk}}$）、非零元总数（$\\mathrm{nnz}(A)$）、任意单行中的最大非零元数（$\\mathrm{nnz}_{\\max}$）以及半带宽（$b$）。该解是通过分析问题中指定的耦合和排序规则所决定的矩阵结构得出的，而无需计算实际的矩阵系数。\n\n全局矩阵的结构由两套规则决定：一套用于球谐函数展开的角矩之间的耦合，另一套用于有限元网格的空间节点之间的耦合。自由度（DoF）的排序方式是，在每个空间节点上将所有角矩组合在一起，然后按字典序对空间节点进行排序。这种结构意味着全局矩阵 $A$ 的稀疏模式对应于一个空间耦合矩阵 $M_{\\text{spat}}$ 和一个角矩耦合矩阵 $M_{\\textang}}$ 的克罗内克积。\n\n首先，我们分析角耦合矩阵 $M_{\\text{ang}}$。\n$P_3$ 近似涉及最高阶为 $n=3$ 的矩。角矩的总数 $N_{\\text{mom}}$ 由各阶 $\\ell \\in \\{0, 1, 2, 3\\}$ 的矩数之和给出：\n$$\nN_{\\text{mom}} = \\sum_{\\ell=0}^{3} (2\\ell+1) = 1 + 3 + 5 + 7 = 16\n$$\n问题指定了 $M_{\\text{ang}}$ 中对应于 $\\ell$ 阶矩的任意行的耦合规则：它与自身耦合，与所有 $\\ell-1$ 阶的矩耦合（如果 $\\ell>0$），以及与所有 $\\ell+1$ 阶的矩耦合（如果 $\\ell3$）。对于一个 $\\ell$ 阶矩， $M_{\\textang}}$ 对应行中的非零元数目为：\n\\begin{itemize}\n    \\item 对于 $\\ell=0$：1（自身）+ $(2(1)+1)$（1阶） = 4 个耦合。\n    \\item 对于 $\\ell=1$：1（自身）+ $(2(0)+1)$（0阶）+ $(2(2)+1)$（2阶） = $1+1+5=7$ 个耦合。\n    \\item 对于 $\\ell=2$：1（自身）+ $(2(1)+1)$（1阶）+ $(2(3)+1)$（3阶） = $1+3+7=11$ 个耦合。\n    \\item 对于 $\\ell=3$：1（自身）+ $(2(2)+1)$（2阶） = $1+5=6$ 个耦合。\n\\end{itemize}\n因此，$M_{\\text{ang}}$ 任意行中的最大非零元数为 $\\mathrm{nnz}_{\\max}(M_{\\text{ang}}) = \\max(4, 7, 11, 6) = 11$。\n$M_{\\text{ang}}$ 中的非零元总数是所有行的非零元之和。由于存在 $2\\ell+1$ 个 $\\ell$ 阶矩，我们有：\n$$\n\\mathrm{nnz}(M_{\\text{ang}}) = (1 \\times 4) + (3 \\times 7) + (5 \\times 11) + (7 \\times 6) = 4 + 21 + 55 + 42 = 122\n$$\n\n接下来，我们分析空间耦合矩阵 $M_{\\text{spat}}$。\n对于一个具有 $N_x, N_y, N_z$ 个单元的均匀六面体网格，存在 $N_{nodes} = (N_x+1)(N_y+1)(N_z+1)$ 个空间节点。问题规定一个节点与其自身及其面相邻节点耦合（一个七点模板）。\n$M_{\\text{spat}}$ 中给定节点对应行的非零元数为 1（自耦合）加上其面相邻节点的数量。非零元总数 $\\mathrm{nnz}(M_{\\text{spat}})$ 是所有节点上这些行计数之和。任意行中的最大非零元数 $\\mathrm{nnz}_{\\max}(M_{\\text{spat}})$ 对应于具有最多相邻节点的节点。对于三维网格，内部节点有 6 个相邻节点，面节点有 5 个，边节点有 4 个，角节点有 3 个。$\\mathrm{nnz}(M_{\\text{spat}})$ 和 $\\mathrm{nnz}_{\\max}(M_{\\text{spat}})$ 的值取决于具体的网格维度 $(N_x, N_y, N_z)$。\n\n利用 $M_{\\textang}}$ 和 $M_{\\text{spat}}$ 的性质，我们可以计算全局矩阵 $A$ 所需的四个指标。\n\\begin{enumerate}\n    \\item \\textbf{未知数总数 ($n_{\\text{unk}}$)}：这是空间节点数与每个节点的角矩数之积。\n    $$n_{\\text{unk}} = N_{\\text{nodes}} \\times N_{\\text{mom}} = ((N_x+1)(N_y+1)(N_z+1)) \\times 16$$\n    \\item \\textbf{非零元总数 ($\\mathrm{nnz}(A)$)}：对于克罗内克积结构，非零元总数是构成矩阵的非零元数之积。\n    $$\\mathrm{nnz}(A) = \\mathrm{nnz}(M_{\\text{spat}}) \\times \\mathrm{nnz}(M_{\\text{ang}}) = \\mathrm{nnz}(M_{\\text{spat}}) \\times 122$$\n    \\item \\textbf{行最大非零元数 ($\\mathrm{nnz}_{\\max}$)}：类似地，克罗内克积矩阵行中的最大非零元数是构成矩阵的行最大非零元数之积。\n    $$\\mathrm{nnz}_{\\max} = \\mathrm{nnz}_{\\max}(M_{\\text{spat}}) \\times \\mathrm{nnz}_{\\max}(M_{\\text{ang}}) = (1 + \\text{max\\_neighbors}) \\times 11$$\n    \\item \\textbf{半带宽 ($b$)}：半带宽是 $b = \\max |k - k'|$，遍及所有满足 $A_{k,k'} \\neq 0$ 的对 $(k,k')$。空间节点 $p$ 和矩 $q$ 处的自由度的全局索引 $k$ 为 $k = p \\cdot N_{\\text{mom}} + q$。空间节点按字典序索引，$p = i_x + i_y(N_x+1) + i_z(N_x+1)(N_y+1)$。差值为 $k - k' = (p-p')N_{\\text{mom}} + (q-q')$。当空间索引差 $|p-p'|$ 最大化时，这个差值也达到最大。面相邻节点之间最大的空间索引跳跃发生在z方向的相邻节点，此时 $|p-p'| = (N_x+1)(N_y+1)$。耦合矩之间最大的角索引差 $|\\Delta q| = |q-q'|$ 也必须找到。使用矩索引方案 $j_{\\text{mom}}(\\ell, m) = \\ell^2+\\ell+m$ 和耦合规则， $|\\Delta q|$ 的最大可能值为 $11$，对应于 $\\ell=3$ 阶的矩（例如，$q=15$）和 $\\ell=2$ 阶的矩（例如，$q=4$）之间的耦合。半带宽则为：\n    $$b = \\max|p-p'| \\cdot N_{\\text{mom}} + \\max|q-q'| = ((N_x+1)(N_y+1)) \\times 16 + 11$$\n\\end{enumerate}\n对每个测试用例实施这些公式以获得最终结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_metrics(Nx, Ny, Nz):\n    \"\"\"\n    Computes structural metrics for the global matrix based on problem rules.\n\n    Args:\n        Nx (int): Number of elements along the x-direction.\n        Ny (int): Number of elements along the y-direction.\n        Nz (int): Number of elements along the z-direction.\n\n    Returns:\n        list: A list containing [n_unk, nnz(A), nnz_max, b].\n    \"\"\"\n    # 1. Angular moment analysis (constant for all test cases)\n    # The P_3 approximation has orders l=0,1,2,3.\n    # Total number of moments is (n+1)^2 = (3+1)^2 = 16.\n    N_mom = 16\n\n    # Number of couplings for a row of moment order l, based on the rule:\n    # row couples to self, all moments in l-1, and all moments in l+1.\n    # Moments per order l: 2*l+1.\n    # l=0: 1(self) + (2*1+1) = 4\n    # l=1: 1(self) + (2*0+1) + (2*2+1) = 7\n    # l=2: 1(self) + (2*1+1) + (2*3+1) = 11\n    # l=3: 1(self) + (2*2+1) = 6\n    nnz_row_ang = {0: 4, 1: 7, 2: 11, 3: 6}\n    moments_per_l = {0: 1, 1: 3, 2: 5, 3: 7}\n\n    # Total nonzeros in the angular coupling matrix M_ang\n    nnz_M_ang = sum(moments_per_l[l] * nnz_row_ang[l] for l in range(4))\n\n    # Max nonzeros in any row of M_ang\n    max_row_nnz_M_ang = max(nnz_row_ang.values())\n\n    # Max difference in moment indices for bandwidth calculation. This corresponds\n    # to coupling between l=2 and l=3 moments under the specified indexing.\n    # The index is j_mom(l,m) = l*l + l+m. max|j_mom(l1,m1)-j_mom(l2,m2)| = 11.\n    max_delta_q = 11\n\n    # 2. Spatial node analysis (depends on the mesh)\n    num_nodes_x = Nx + 1\n    num_nodes_y = Ny + 1\n    num_nodes_z = Nz + 1\n    N_nodes = num_nodes_x * num_nodes_y * num_nodes_z\n\n    # Calculate total nonzeros and max row nonzeros for the spatial coupling matrix M_spat\n    total_spatial_couplings = 0\n    max_neighbors = 0\n    for iz in range(num_nodes_z):\n        for iy in range(num_nodes_y):\n            for ix in range(num_nodes_x):\n                neighbors = 0\n                if ix  0: neighbors += 1\n                if ix  num_nodes_x - 1: neighbors += 1\n                if iy  0: neighbors += 1\n                if iy  num_nodes_y - 1: neighbors += 1\n                if iz  0: neighbors += 1\n                if iz  num_nodes_z - 1: neighbors += 1\n\n                # Couplings for this node's row in M_spat is 1 (self) + neighbors\n                row_couplings = 1 + neighbors\n                total_spatial_couplings += row_couplings\n                if neighbors  max_neighbors:\n                    max_neighbors = neighbors\n\n    nnz_M_spat = total_spatial_couplings\n    max_row_nnz_M_spat = 1 + max_neighbors\n\n    # 3. Combine results for the global matrix A\n    # Total number of unknowns\n    n_unk = N_nodes * N_mom\n\n    # Total number of nonzeros, based on Kronecker product structure\n    nnz_A = nnz_M_spat * nnz_M_ang\n\n    # Maximum nonzeros in any single row\n    nnz_max = max_row_nnz_M_spat * max_row_nnz_M_ang\n\n    # Half-bandwidth b = max|k-k'|\n    # The largest jump in lexicographic node index p is the z-stride.\n    z_stride = num_nodes_x * num_nodes_y\n    # b = max| (p-p')*N_mom + (q-q') | = max|p-p'|*N_mom + max|q-q'|\n    b = z_stride * N_mom + max_delta_q\n\n    return [int(n_unk), int(nnz_A), int(nnz_max), int(b)]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1, 1, 1),\n        (2, 1, 1),\n        (2, 2, 2),\n        (3, 2, 1),\n    ]\n\n    results = []\n    for case in test_cases:\n        metrics = calculate_metrics(*case)\n        results.append(metrics)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}