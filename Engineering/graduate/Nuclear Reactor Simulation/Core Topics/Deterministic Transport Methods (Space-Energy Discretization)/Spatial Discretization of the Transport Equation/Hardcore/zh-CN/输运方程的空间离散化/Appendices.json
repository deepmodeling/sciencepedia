{
    "hands_on_practices": [
        {
            "introduction": "将连续的输运方程转化为离散的代数系统的核心在于对控制体上的粒子平衡进行建模。本练习将引导你推导离散泄漏项，它代表了粒子流出任意控制体的净通量。通过这个基本推导，你将掌握在有限体积法中应用高斯散度定理，并理解迎风格式在保证数值解稳定性中的关键作用。",
            "id": "4251181",
            "problem": "考虑一个二维空间中的稳态单能中子输运问题，其角度通过离散纵标法 (SN) 进行离散。令 $\\boldsymbol{\\Omega}_{m}$ 为离散方向之一。对于一个三角形控制体 $\\mathcal{T} \\subset \\mathbb{R}^{2}$，其边索引为 $e \\in \\{1,2,3\\}$，令 $\\mathbf{n}_{e}$ 表示边 $e$ 上的外向单位法向量，$\\ell_{e}$ 表示边 $e$ 的长度。令 $\\psi_{m}(\\mathbf{x})$ 为方向 $\\boldsymbol{\\Omega}_{m}$ 的角通量。在标准的有限体积意义下，假设采用分片常数近似：$\\mathcal{T}$ 内部的单元平均角通量为 $\\,\\psi_{\\mathcal{T},m}\\,$，边 $e$ 上的边平均角通量为 $\\psi_{e,m}$，其值取关于 $\\boldsymbol{\\Omega}_{m}$ 的迎风值（即，流入边使用相邻单元的平均值，流出边使用内部单元的平均值）。\n\n从稳态线性玻尔兹曼输运方程的流项 $\\,\\boldsymbol{\\Omega}_{m} \\cdot \\nabla \\psi_{m}\\,$ 出发，仅使用基本原理（包括散度定理和有限体积控制体平衡），推导在方向 $\\boldsymbol{\\Omega}_{m}$ 上从 $\\mathcal{T}$ 的净泄漏表达式，该表达式应为使用边的外向法向量对 $\\mathcal{T}$ 的所有边求和的形式。明确说明 $\\,\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}\\,$ 的符号如何决定流入与流出，并通过使用一个标量的正部和负部，将迎风选择合并到一个单一的闭合形式表达式中。您可以定义，对于任意标量 $a$，其正部为 $a^{+} \\equiv \\max(a,0)$，负部为 $a^{-} \\equiv \\min(a,0)$。\n\n请提供净泄漏 $L_{m}(\\mathcal{T})$ 的最终表达式，该表达式应是一个关于 $\\,\\boldsymbol{\\Omega}_{m}$、$\\,\\mathbf{n}_{e}$、$\\,\\ell_{e}$、$\\,\\psi_{\\mathcal{T},m}\\,$ 以及每个流入边 $e$ 的相邻单元平均值 $\\,\\psi_{N(e),m}\\,$ 的解析表达式。最终答案必须是单一的闭合形式解析表达式。不需要进行数值计算。",
            "solution": "该问题是有效的，因为它具有科学依据、是适定的、客观的，并且代表了数值中子输运理论领域的一个标准推导。\n\n对于给定的离散方向 $\\boldsymbol{\\Omega}_{m}$，从控制体 $\\mathcal{T}$ 的净泄漏 $L_{m}(\\mathcal{T})$ 是稳态玻尔兹曼输运方程中流项的体积分。\n\n我们从流项 $\\boldsymbol{\\Omega}_{m} \\cdot \\nabla \\psi_{m}$ 开始，并将其在二维三角形控制体 $\\mathcal{T}$ 上积分：\n$$\nL_{m}(\\mathcal{T}) = \\int_{\\mathcal{T}} (\\boldsymbol{\\Omega}_{m} \\cdot \\nabla \\psi_{m}) \\, dA\n$$\n由于离散方向 $\\boldsymbol{\\Omega}_{m}$ 是一个常数向量，我们可以使用矢量恒等式 $\\nabla \\cdot (f \\mathbf{v}) = f(\\nabla \\cdot \\mathbf{v}) + \\mathbf{v} \\cdot \\nabla f$。设 $f = \\psi_m$ 和 $\\mathbf{v} = \\boldsymbol{\\Omega}_m$，并注意到 $\\nabla \\cdot \\boldsymbol{\\Omega}_m = 0$，我们有 $\\boldsymbol{\\Omega}_{m} \\cdot \\nabla \\psi_{m} = \\nabla \\cdot (\\psi_{m} \\boldsymbol{\\Omega}_{m})$。泄漏积分变为：\n$$\nL_{m}(\\mathcal{T}) = \\int_{\\mathcal{T}} \\nabla \\cdot (\\psi_{m} \\boldsymbol{\\Omega}_{m}) \\, dA\n$$\n我们应用散度定理，在二维情况下，该定理将一个面积上散度的积分与其边界 $\\partial \\mathcal{T}$ 上的线积分联系起来：\n$$\nL_{m}(\\mathcal{T}) = \\oint_{\\partial \\mathcal{T}} (\\psi_{m} \\boldsymbol{\\Omega}_{m}) \\cdot \\mathbf{n} \\, ds\n$$\n其中 $\\mathbf{n}$ 是边界 $\\partial \\mathcal{T}$ 上的外向单位法向量。\n\n三角形控制体的边界 $\\partial \\mathcal{T}$ 由三条直边组成，索引为 $e \\in \\{1, 2, 3\\}$。边界积分可以表示为在这些边上的积分之和：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} \\int_{e} (\\psi_{m} \\boldsymbol{\\Omega}_{m}) \\cdot \\mathbf{n}_{e} \\, ds\n$$\n其中 $\\mathbf{n}_{e}$ 是边 $e$ 上的常数外向单位法向量。由于 $\\boldsymbol{\\Omega}_{m}$ 和 $\\mathbf{n}_{e}$ 在每条边上都是常数，它们的点积可以移到积分号外：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}) \\int_{e} \\psi_{m}(\\mathbf{x}) \\, ds\n$$\n在有限体积法中，我们使用边平均角通量 $\\psi_{e,m}$，其定义为：\n$$\n\\psi_{e,m} = \\frac{1}{\\ell_{e}} \\int_{e} \\psi_{m}(\\mathbf{x}) \\, ds\n$$\n其中 $\\ell_{e}$ 是边 $e$ 的长度。将此代入泄漏表达式，我们得到净泄漏的离散形式：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}) \\ell_{e} \\psi_{e,m}\n$$\n问题指定了一阶迎风格式。边平均通量 $\\psi_{e,m}$ 的值由中子相对于边的流动方向决定。标量积 $\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}$ 的符号决定了一条边是控制体 $\\mathcal{T}$ 的流入边界还是流出边界：\n- 如果 $\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e} > 0$，则中子速度垂直于边的分量指向外部。这是一条 **流出** 边。迎风近似规定边上的通量由“上游”值决定，即内部单元的平均通量 $\\psi_{\\mathcal{T},m}$。因此，$\\psi_{e,m} = \\psi_{\\mathcal{T},m}$。\n- 如果 $\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}  0$，则中子速度垂直于边的分量指向内部。这是一条 **流入** 边。迎风近似取自相邻单元的通量 $\\psi_{N(e),m}$。因此，$\\psi_{e,m} = \\psi_{N(e),m}$。\n- 如果 $\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e} = 0$，则流动方向与边平行，该边对净泄漏没有贡献。\n\n我们可以使用标量 $a$ 的已定义正部 $a^{+} \\equiv \\max(a,0)$ 和负部 $a^{-} \\equiv \\min(a,0)$，将此迎风格式表示为单个表达式。\n令 $C_e = \\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}$。边 $e$ 对净泄漏的贡献是 $C_e \\ell_e \\psi_{e,m}$。\n对于流出边 ($C_e > 0$)，贡献为 $C_e \\ell_e \\psi_{\\mathcal{T},m}$。这可以写成 $C_e^{+} \\ell_e \\psi_{\\mathcal{T},m}$，因为 $C_e > 0 \\implies C_e^{+} = C_e$ 且 $C_e^{-} = 0$。\n对于流入边 ($C_e  0$)，贡献为 $C_e \\ell_e \\psi_{N(e),m}$。这可以写成 $C_e^{-} \\ell_e \\psi_{N(e),m}$，因为 $C_e  0 \\implies C_e^{-} = C_e$ 且 $C_e^{+} = 0$。\n总净泄漏是所有边上这些贡献的总和：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} \\left[ (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{+} \\ell_{e} \\psi_{\\mathcal{T},m} + (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-} \\ell_{e} \\psi_{N(e),m} \\right]\n$$\n这是一个有效的闭合形式表达式。但是，我们可以进一步简化它。我们使用恒等式 $a^{+} = a - a^{-}$，其中 $a = \\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}$。将此代入表达式中：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} \\left[ \\left((\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e}) - (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-}\\right) \\ell_{e} \\psi_{\\mathcal{T},m} + (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-} \\ell_{e} \\psi_{N(e),m} \\right]\n$$\n重新整理各项：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})\\ell_{e}\\psi_{\\mathcal{T},m} + \\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-} \\ell_{e} \\left( \\psi_{N(e),m} - \\psi_{\\mathcal{T},m} \\right)\n$$\n我们来考察第一项。由于 $\\psi_{\\mathcal{T},m}$ 和 $\\boldsymbol{\\Omega}_{m}$ 对于该控制体是常数，我们可以写成：\n$$\n\\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})\\ell_{e}\\psi_{\\mathcal{T},m} = \\psi_{\\mathcal{T},m} \\left( \\boldsymbol{\\Omega}_{m} \\cdot \\sum_{e=1}^{3} \\mathbf{n}_{e}\\ell_{e} \\right)\n$$\n对于任何闭合体积（或二维中的面积），由表面积（二维中为边长）缩放的外向法向量的矢量和为零。这是散度定理应用于常数向量场的一个推论。即 $\\sum_{e=1}^{3} \\mathbf{n}_{e}\\ell_{e} = \\oint_{\\partial\\mathcal{T}} \\mathbf{n} \\, ds = \\mathbf{0}$。\n因此，第一项为零：\n$$\n\\psi_{\\mathcal{T},m} \\left( \\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{0} \\right) = 0\n$$\n这就给我们留下了净泄漏的简化最终表达式：\n$$\nL_{m}(\\mathcal{T}) = \\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-} \\ell_{e} (\\psi_{N(e),m} - \\psi_{\\mathcal{T},m})\n$$\n这个优美的形式表明，单元的净泄漏是由单元平均通量与流入面上迎风通量之间的差异驱动的，并由投影流入面积加权。",
            "answer": "$$\n\\boxed{\\sum_{e=1}^{3} (\\boldsymbol{\\Omega}_{m} \\cdot \\mathbf{n}_{e})^{-} \\ell_{e} (\\psi_{N(e),m} - \\psi_{\\mathcal{T},m})}\n$$"
        },
        {
            "introduction": "在选择了离散化方法后，评估其数值特性至关重要。菱形差分（Diamond Difference）格式因其简洁和理论上的二阶精度而被广泛研究，但它也存在一个著名缺陷。这个练习提供了一个具体的计算场景，旨在揭示菱形差分格式如何在光学厚度大的区域内产生非物理的负通量，从而加深对数值格式选择中精度、简单性和物理真实性之间权衡的理解。",
            "id": "4251235",
            "problem": "考虑离散纵标法（SN法）中，对于单一纵标方向余弦 $\\,\\mu>0\\,$ 的一维均匀板元。角通量 $\\,\\psi(x,\\mu)\\,$ 的稳态单能输运方程为\n$$\n\\mu\\,\\frac{d\\psi}{dx} + \\Sigma_{t}\\,\\psi = q,\n$$\n其中 $\\,\\Sigma_{t}\\,$ 是总宏观截面，$\\,q\\,$ 是板元内恒定的体积角源。设空间板元宽度为 $\\,\\Delta x\\,$，左边界位于 $\\,x=0\\,$，其给定的入射角通量为 $\\,\\psi_{L}=\\psi(0,\\mu)\\,$，右边界位于 $\\,x=\\Delta x\\,$，其未知的出射角通量为 $\\,\\psi_{R}=\\psi(\\Delta x,\\mu)\\,$。设板元在方向 $\\,\\mu\\,$ 上的光学厚度为 $\\,\\tau \\equiv \\Sigma_{t}\\Delta x/\\mu\\,$。\n\n应用菱形差分空间离散格式到板元上的输运方程，计算在以下光学厚情况下的右边界角通量 $\\,\\psi_{R}\\,$ 和板元中心角通量 $\\,\\psi_{c}\\,$：\n- $\\,\\Sigma_{t} = 1\\,\\text{cm}^{-1}\\,$,\n- $\\,\\mu = 0.1\\,$,\n- $\\,\\tau = 20\\,$,\n- $\\,q = 0.2\\,\\text{neutrons}\\,\\text{cm}^{-3}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}\\,$,\n- $\\,\\psi_{L} = 1\\,\\text{neutrons}\\,\\text{cm}^{-2}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}\\,$.\n\n请提供用菱形差分格式计算得到的该板元的 $\\,\\psi_{R}\\,$ 和 $\\,\\psi_{c}\\,$ 值。将每个角通量以 neutrons cm$^{-2}$ s$^{-1}$ sr$^{-1}$ 为单位表示，并将您的答案四舍五入到四位有效数字。请按 $\\,\\psi_{R}\\,$、$\\,\\psi_{c}\\,$ 的顺序报告这两个值。",
            "solution": "问题陈述已经过验证，被认为是中子输运数值方法领域中一个适定的、有科学依据的问题。我们可以开始求解。\n\n该问题要求使用菱形差分 (DD) 空间离散格式，计算一维板元的出射角通量 $\\psi_{R}$ 和板元中心角通量 $\\psi_{c}$。控制方程是针对单一方向余弦 $\\mu > 0$ 的稳态单能输运方程：\n$$\n\\mu\\,\\frac{d\\psi}{dx} + \\Sigma_{t}\\,\\psi = q\n$$\n其中 $\\psi(x,\\mu)$ 是角通量，$\\Sigma_t$ 是恒定的总宏观截面，$\\,q\\,$ 是恒定的体积角源。\n\n菱形差分格式由两个基本方程定义，这两个方程描述了一个宽度为 $\\Delta x$、左边界通量为 $\\psi_L$、右边界通量为 $\\psi_R$ 的空间板元。\n\n第一个方程是通过对输运方程在板元宽度上（从 $x=0$ 到 $x=\\Delta x$）进行积分得出的：\n$$\n\\int_{0}^{\\Delta x} \\left( \\mu\\,\\frac{d\\psi}{dx} + \\Sigma_{t}\\,\\psi \\right) dx = \\int_{0}^{\\Delta x} q \\, dx\n$$\n执行积分得到板元守恒方程：\n$$\n\\mu\\,[\\psi(\\Delta x) - \\psi(0)] + \\Sigma_{t} \\int_{0}^{\\Delta x} \\psi(x) \\, dx = q\\,\\Delta x\n$$\n在菱形差分格式中，板元平均通量 $\\bar{\\psi} = \\frac{1}{\\Delta x} \\int_{0}^{\\Delta x} \\psi(x) \\, dx$ 由板元中心通量 $\\psi_{c}$ 近似。使用记号 $\\psi_L = \\psi(0)$ 和 $\\psi_R = \\psi(\\Delta x)$，守恒方程变为：\n$$\n\\mu\\,(\\psi_R - \\psi_L) + \\Sigma_{t}\\,\\psi_{c}\\,\\Delta x = q\\,\\Delta x\n$$\n\n第二个方程是菱形差分辅助关系式，它通过假设板元内通量呈线性分布，将板元中心通量与板元边界通量代数地联系起来：\n$$\n\\psi_{c} = \\frac{\\psi_L + \\psi_R}{2}\n$$\n\n我们现在得到了一个关于两个未知数 $\\psi_R$ 和 $\\psi_c$ 的二元线性方程组。我们可以通过将辅助关系式代入守恒方程来求解该方程组：\n$$\n\\mu\\,(\\psi_R - \\psi_L) + \\Sigma_{t}\\,\\left( \\frac{\\psi_L + \\psi_R}{2} \\right)\\,\\Delta x = q\\,\\Delta x\n$$\n为了求解 $\\psi_R$，我们合并含有 $\\psi_R$ 的项：\n$$\n\\mu\\,\\psi_R + \\frac{\\Sigma_{t}\\,\\Delta x}{2}\\,\\psi_R = q\\,\\Delta x + \\mu\\,\\psi_L - \\frac{\\Sigma_{t}\\,\\Delta x}{2}\\,\\psi_L\n$$\n$$\n\\psi_R\\,\\left( \\mu + \\frac{\\Sigma_{t}\\,\\Delta x}{2} \\right) = q\\,\\Delta x + \\psi_L\\,\\left( \\mu - \\frac{\\Sigma_{t}\\,\\Delta x}{2} \\right)\n$$\n分离出 $\\psi_R$ 可得：\n$$\n\\psi_R = \\frac{q\\,\\Delta x + \\psi_L\\,\\left( \\mu - \\frac{\\Sigma_{t}\\,\\Delta x}{2} \\right)}{\\mu + \\frac{\\Sigma_{t}\\,\\Delta x}{2}}\n$$\n此表达式可以通过分子分母同除以 $\\mu$ 来简化：\n$$\n\\psi_R = \\frac{\\frac{q\\,\\Delta x}{\\mu} + \\psi_L\\,\\left( 1 - \\frac{\\Sigma_t\\,\\Delta x}{2\\mu} \\right)}{1 + \\frac{\\Sigma_t\\,\\Delta x}{2\\mu}}\n$$\n问题中定义了板元的光学厚度为 $\\tau \\equiv \\Sigma_{t}\\Delta x/\\mu$。将 $\\tau$ 代入 $\\psi_R$ 的表达式中：\n$$\n\\psi_R = \\frac{\\frac{q}{\\Sigma_t}\\,\\tau + \\psi_L\\,\\left( 1 - \\frac{\\tau}{2} \\right)}{1 + \\frac{\\tau}{2}}\n$$\n给定值为：\n- $\\Sigma_{t} = 1\\,\\text{cm}^{-1}$\n- $\\mu = 0.1$\n- $\\tau = 20$\n- $q = 0.2\\,\\text{neutrons}\\,\\text{cm}^{-3}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}$\n- $\\psi_{L} = 1\\,\\text{neutrons}\\,\\text{cm}^{-2}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}$\n\n首先，我们计算源与截面之比 $S = q/\\Sigma_t$：\n$$\nS = \\frac{0.2}{1} = 0.2\\,\\text{neutrons}\\,\\text{cm}^{-2}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}\n$$\n现在我们将数值代入 $\\psi_R$ 的表达式中：\n$$\n\\psi_R = \\frac{(0.2)\\,(20) + (1)\\,\\left( 1 - \\frac{20}{2} \\right)}{1 + \\frac{20}{2}} = \\frac{4 + (1 - 10)}{1 + 10} = \\frac{4 - 9}{11} = -\\frac{5}{11}\n$$\n因此，出射角通量为 $\\psi_R = -5/11$。四舍五入到四位有效数字，得到：\n$$\n\\psi_R \\approx -0.4545\\,\\text{neutrons}\\,\\text{cm}^{-2}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}\n$$\n角通量为负值是一个非物理的结果，但这是将菱形差分格式应用于此光学厚问题时在数学上正确的结果。这种现象是该方法的一个已知缺陷，在实际程序中需要通过所谓的“菱形差分通量修正”来纠正。\n\n接下来，我们使用辅助关系式计算板元中心通量 $\\psi_c$：\n$$\n\\psi_c = \\frac{\\psi_L + \\psi_R}{2} = \\frac{1 + (-\\frac{5}{11})}{2} = \\frac{\\frac{11}{11} - \\frac{5}{11}}{2} = \\frac{\\frac{6}{11}}{2} = \\frac{3}{11}\n$$\n因此，板元中心角通量为 $\\psi_c = 3/11$。四舍五入到四位有效数字，得到：\n$$\n\\psi_c \\approx 0.2727\\,\\text{neutrons}\\,\\text{cm}^{-2}\\,\\text{s}^{-1}\\,\\text{sr}^{-1}\n$$\n所求的值，四舍五入到四位有效数字，分别为 $\\psi_R = -0.4545$ 和 $\\psi_c = 0.2727$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -0.4545  0.2727 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "本章的最终实践将理论与应用相结合，要求你构建一个简单的中子输运求解器，以量化分析不同空间离散格式的影响。通过亲手实现稳健但精度较低的阶梯特征线法（Step Characteristics）和高阶但可能存在缺陷的菱形差分法，你将直观地体验到网格分辨率和格式阶数对解的准确性的影响。这个综合性练习涵盖了选择、实施和分析空间离散方法的完整过程。",
            "id": "4251221",
            "problem": "您的任务是设计并实现一个一维离散纵标求解器，用以量化当空间离散变化而角度离散保持固定时，计算得到的棒板中的棒功率分布如何变化。其科学背景是稳态、单能、一维平板几何中的输运方程，该模型具有各向同性散射和各向同性外源，可代表简化的核反应堆燃料棒排。目标是分析空间离散的网格分辨率和空间阶数对结果的敏感性。\n\n该问题的基本依据是板几何中的稳态单能输运方程，\n$$\n\\mu \\frac{d \\psi(x,\\mu)}{dx} + \\Sigma_t(x)\\,\\psi(x,\\mu) = Q(x),\n$$\n其中 $\\psi(x,\\mu)$ 是角通量，$\\mu$ 是方向余弦，$\\Sigma_t(x)$ 是总宏观截面（单位为 $\\mathrm{cm}^{-1}$），$Q(x)$ 是各向同性单位角度源，其单位与 $\\Sigma_t \\psi$ 相同。各向同性源由标量通量 $\\phi(x)$ 和外源 $S_{\\mathrm{ext}}(x)$ 定义为\n$$\nQ(x) = \\frac{1}{2}\\,\\Sigma_s(x)\\,\\phi(x) + \\frac{1}{2}\\,S_{\\mathrm{ext}}(x),\n$$\n其中 $\\phi(x) = \\int_{-1}^{1} \\psi(x,\\mu)\\,d\\mu$。边界条件为真空，意味着入射角通量在两个边界处均为零。角度离散固定为双角度离散纵标子集（记为 $S_2$），其方向余弦为 $\\mu_1 = +1/\\sqrt{3}$ 和 $\\mu_2 = -1/\\sqrt{3}$，且求积权重相等，为 $w_1 = w_2 = 1$。\n\n您需要将空间域离散为均匀的栅格，并使用源迭代法：给定当前标量通量的近似值，计算每个栅格的各向同性源，在正向和负向进行扫描以获得角通量，然后通过求积更新标量通量。扫描必须使用以下两种空间离散方法之一来实现：\n\n- 阶梯特征线法（零阶）：在每个宽度为 $\\Delta x$ 且系数恒定的栅格内，对于给定的方向余弦大小 $|\\mu|$ 和入射角通量 $\\psi_{\\mathrm{in}}$，定义光学厚度 $\\tau = \\Sigma_t \\Delta x / |\\mu|$ 和栅格内各向同性源 $Q$。出射角通量和栅格平均角通量为\n$$\n\\psi_{\\mathrm{out}} = \\psi_{\\mathrm{in}} e^{-\\tau} + \\frac{Q}{\\Sigma_t} \\left(1 - e^{-\\tau}\\right),\n$$\n$$\n\\psi_{\\mathrm{avg}} = a\\,\\psi_{\\mathrm{in}} + (1-a)\\,\\frac{Q}{\\Sigma_t}, \\quad a = \\frac{1 - e^{-\\tau}}{\\tau}.\n$$\n\n- 菱形差分法（一阶）：在每个栅格内，假设角通量呈线性变化，对于从入射侧到出射侧的扫描坐标，以 $|\\mu|$ 进行的离散平衡方程为\n$$\n\\frac{|\\mu|}{\\Delta x}\\left(\\psi_{\\mathrm{out}} - \\psi_{\\mathrm{in}}\\right) + \\Sigma_t\\,\\psi_{\\mathrm{avg}} = Q, \\quad \\psi_{\\mathrm{avg}} = \\frac{\\psi_{\\mathrm{in}} + \\psi_{\\mathrm{out}}}{2}.\n$$\n求解 $\\psi_{\\mathrm{out}}$ 可得\n$$\n\\psi_{\\mathrm{out}} = \\frac{Q + \\left(\\frac{|\\mu|}{\\Delta x} - \\frac{\\Sigma_t}{2}\\right)\\psi_{\\mathrm{in}}}{\\frac{|\\mu|}{\\Delta x} + \\frac{\\Sigma_t}{2}}, \\quad \\psi_{\\mathrm{avg}} = \\frac{\\psi_{\\mathrm{in}} + \\psi_{\\mathrm{out}}}{2}.\n$$\n如果此更新产生负角通量，则应用非负修正，在该栅格中设置 $\\psi_{\\mathrm{out}} = \\max(\\psi_{\\mathrm{out}}, 0)$ 和 $\\psi_{\\mathrm{avg}} = \\max(\\psi_{\\mathrm{avg}}, 0)$。\n\n几何结构是一个一维的燃料棒阵列。共有 $N_{\\mathrm{pin}} = 10$ 根燃料棒，每根宽度为 $w_{\\mathrm{pin}} = 1\\,\\mathrm{cm}$，总长度为 $L = N_{\\mathrm{pin}}\\,w_{\\mathrm{pin}} = 10\\,\\mathrm{cm}$。燃料棒在两种材料（燃料和吸收体）之间交替，其宏观截面（单位为 $\\mathrm{cm}^{-1}$）和外源（单位与源一致）如下：\n\n- 燃料：$\\Sigma_t = 0.6$, $\\Sigma_s = 0.45$, $\\nu \\Sigma_f = 0.12$, $S_{\\mathrm{ext}} = 0.2$。\n- 吸收体：$\\Sigma_t = 1.5$, $\\Sigma_s = 0.5$, $\\nu \\Sigma_f = 0.03$, $S_{\\mathrm{ext}} = 0$。\n\n标量通量需在每个栅格中通过源迭代计算，收敛容差为相对无穷范数变化小于 $10^{-10}$。燃料棒 $p$ 中的棒功率定义为\n$$\nP_p = \\sum_{i \\in \\text{cells of pin } p} \\nu\\Sigma_f^{(p)}\\,\\phi_i\\,\\Delta x,\n$$\n其单位与单位深度的功率成正比。此处，$\\phi_i$ 是栅格平均标量通量，$\\Delta x$ 是栅格宽度。参考棒功率分布 $P^{\\mathrm{ref}}_p$ 使用阶梯特征线法离散，每根燃料棒含 $200$ 个栅格进行计算。\n\n您的程序必须计算几种情况下的棒功率分布，这些情况改变了网格分辨率和空间阶数，同时保持角度离散固定为 $S_2$。对于每种情况，计算与参考值的最大绝对相对偏差，\n$$\n\\epsilon = \\max_{p=1,\\dots,N_{\\mathrm{pin}}} \\left| \\frac{P_p - P^{\\mathrm{ref}}_p}{P^{\\mathrm{ref}}_p} \\right|.\n$$\n将 $\\epsilon$ 报告为十进制数。\n\n物理单位：空间长度单位必须是 $\\mathrm{cm}$，截面单位必须是 $\\mathrm{cm}^{-1}$，报告的敏感性度量 $\\epsilon$ 必须是无量纲的十进制数。\n\n角度单位：方向由无量纲的方向余弦表示；无需进行角度单位转换。\n\n测试套件：\n- 情况 1：每根燃料棒 4 个栅格，阶梯特征线法。\n- 情况 2：每根燃料棒 1 个栅格，阶梯特征线法。\n- 情况 3：每根燃料棒 4 个栅格，菱形差分法。\n- 情况 4：每根燃料棒 20 个栅格，菱形差分法。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔的结果列表（例如，$[result_1,result_2,result_3,result_4]$），其中每个 $result_i$ 是对应测试用例的 $\\epsilon$ 的十进制值，顺序如上所述。",
            "solution": "用户要求设计并实现一个一维离散纵标求解器，以分析棒功率分布对空间离散方法的敏感性。该问题在科学上是合理的，定义明确，并包含了进行数值求解所需的所有信息。下文介绍了解决该问题的方法。\n\n### 1. 问题描述\n\n该物理系统由稳态、单能、一维平板几何中的中子输运方程控制：\n$$\n\\mu \\frac{d \\psi(x,\\mu)}{dx} + \\Sigma_t(x)\\,\\psi(x,\\mu) = Q(x, \\mu)\n$$\n其中 $\\psi(x,\\mu)$ 是在位置 $x$ 沿方向 $\\mu$（与x轴夹角的余弦）行进的角中子通量，$\\Sigma_t(x)$ 是总宏观截面，而 $Q(x, \\mu)$ 是中子源。对于此问题，散射和外源是各向同性的，因此源项与方向 $\\mu$ 无关，由下式给出：\n$$\nQ(x) = \\frac{1}{2}\\,\\Sigma_s(x)\\,\\phi(x) + \\frac{1}{2}\\,S_{\\mathrm{ext}}(x)\n$$\n这里，$\\Sigma_s(x)$ 是散射截面，$S_{\\mathrm{ext}}(x)$ 是外源，$\\phi(x)$ 是标量通量，定义为角通量在所有方向上的积分：\n$$\n\\phi(x) = \\int_{-1}^{1} \\psi(x,\\mu)\\,d\\mu\n$$\n问题域是一个长度为 $L=10\\,\\mathrm{cm}$ 的平板，由 $N_{\\mathrm{pin}}=10$ 根交替的燃料棒和吸收棒组成。位于 $x=0$ 和 $x=L$ 的边界是真空，意味着没有中子进入平板：$\\psi(0, \\mu  0) = 0$ 且 $\\psi(L, \\mu  0) = 0$。\n\n### 2. 离散化\n\n为了数值求解该积分-微分输运方程，我们必须对其自变量：空间（$x$）和角度（$\\mu$）进行离散化。\n\n#### 2.1. 角度离散化\n连续的角度变量 $\\mu$ 使用离散纵标（$S_N$）方法进行离散化。问题指定了一个 $S_2$ 求积组，包含两个方向 $\\mu_m$ 和相应的权重 $w_m$：\n$$\n\\mu_1 = 1/\\sqrt{3}, \\quad w_1 = 1 \\\\\n\\mu_2 = -1/\\sqrt{3}, \\quad w_2 = 1\n$$\n这将单个积分-微分方程转换为一个由两个耦合常微分方程组成的系统，每个离散方向 $\\mu_m$ 对应一个方程：\n$$\n\\mu_m \\frac{d \\psi_m(x)}{dx} + \\Sigma_t(x)\\,\\psi_m(x) = Q(x), \\quad m=1,2\n$$\n标量通量现在通过加权和来近似：\n$$\n\\phi(x) \\approx \\sum_{m=1}^{2} w_m \\psi_m(x) = \\psi_1(x) + \\psi_2(x)\n$$\n\n#### 2.2. 空间离散化\n空间域 $x \\in [0, L]$ 被划分为一个由 $N_c$ 个栅格组成的均匀网格，每个栅格的宽度为 $\\Delta x = L/N_c$。在每个栅格 $i$ 内，材料属性（$\\Sigma_{t,i}$, $\\Sigma_{s,i}$ 等）被假定为常数。栅格 $i$ 的材料由它所在的10根燃料棒中的哪一根决定。设 $N_{cpp}$ 是每根燃料棒的栅格数。索引为 $i$ 的栅格属于燃料棒 $p = \\lfloor i / N_{cpp} \\rfloor$。如果 $p$ 是偶数，则燃料棒 $p$ 是燃料棒；如果 $p$ 是奇数，则为吸收棒（使用0-基索引）。\n\n### 3. 数值解法：源迭代\n\n该方程组使用源迭代法求解。此迭代过程如下：\n\n1.  **初始化**：对标量通量剖面 $\\phi^{(0)}(x)$ 进行初始猜测。一个常见的选择是对所有栅格设置 $\\phi^{(0)}(x) = 0$。\n2.  **迭代**：对于每次迭代 $k = 0, 1, 2, \\dots$：\n    a.  **计算源**：使用当前标量通量迭代值 $\\phi_i^{(k)}$ 计算每个栅格 $i$ 的栅格平均各向同性源 $Q_i^{(k)}$：\n        $$\n        Q_i^{(k)} = \\frac{1}{2}\\,\\Sigma_{s,i}\\,\\phi_i^{(k)} + \\frac{1}{2}\\,S_{\\mathrm{ext},i}\n        $$\n    b.  **输运扫描**：对于每个离散纵标 $\\mu_m$，在整个网格上求解空间离散的输运方程，以找到新的栅格平均角通量 $\\psi_{m,i}^{(k+1)}$。这个过程被称为输运扫描，它将边界条件和中子在整个网格上传播。\n        -   如果 $\\mu_m  0$，扫描从左到右进行（从 $i=0$ 到 $N_c-1$）。左边界的入射通量为 $\\psi_{\\mathrm{in},0}=0$。栅格 $i$ 的出射通量 $\\psi_{\\mathrm{out},i}$ 成为栅格 $i+1$ 的入射通量 $\\psi_{\\mathrm{in},i+1}$。\n        -   如果 $\\mu_m  0$，扫描从右到左进行（从 $i=N_c-1$ 到 $0$）。右边界的入射通量为 $\\psi_{\\mathrm{in},N_c}=0$。栅格 $i$ 的出射通量成为栅格 $i-1$ 的入射通量。\n    c.  **更新标量通量**：通过将新计算的角通量与其求积权重相加来计算标量通量的下一次迭代值 $\\phi_i^{(k+1)}$：\n        $$\n        \\phi_i^{(k+1)} = \\sum_{m=1}^{2} w_m \\psi_{m,i}^{(k+1)}\n        $$\n    d.  **检查收敛性**：将新的标量通量 $\\phi^{(k+1)}$ 与前一个 $\\phi^{(k)}$ 进行比较。当变化的相对无穷范数低于指定的容差 $\\epsilon_{\\mathrm{tol}} = 10^{-10}$ 时，迭代收敛：\n        $$\n        \\frac{\\|\\phi^{(k+1)} - \\phi^{(k)}\\|_\\infty}{\\|\\phi^{(k+1)}\\|_\\infty}  \\epsilon_{\\mathrm{tol}}\n        $$\n3.  **终止**：最终收敛的标量通量为 $\\phi = \\phi^{(k+1)}$。\n\n### 4. 扫描中的空间离散格式\n\n输运扫描的核心是在每个栅格中求解出射角通量和栅格平均角通量。问题指定了两种方法。\n\n#### 4.1. 阶梯特征线法 (SC)\n这是一种零阶方法，假设栅格内的源是平坦的。它源自输运方程在具有恒定属性的单个栅格上的解析解。关键参数是光学厚度 $\\tau_i = \\Sigma_{t,i} \\Delta x / |\\mu_m|$。出射通量 $\\psi_{\\mathrm{out}}$ 和栅格平均通量 $\\psi_{\\mathrm{avg}}$ 为：\n$$\n\\psi_{\\mathrm{out}} = \\psi_{\\mathrm{in}} e^{-\\tau_i} + \\frac{Q_i}{\\Sigma_{t,i}} \\left(1 - e^{-\\tau_i}\\right)\n$$\n$$\n\\psi_{\\mathrm{avg}} = a\\,\\psi_{\\mathrm{in}} + (1-a)\\,\\frac{Q_i}{\\Sigma_{t,i}}, \\quad \\text{where } a = \\frac{1 - e^{-\\tau_i}}{\\tau_i}\n$$\n对于小的 $\\tau_i$，系数 $a$ 使用泰勒级数展开计算，$a \\approx 1 - \\tau_i/2$，以避免数值不稳定性。\n\n#### 4.2. 菱形差分法 (DD)\n这是一种一阶方法，假设角通量在栅格内呈线性变化。这个假设导出了关系式 $\\psi_{\\mathrm{avg}} = (\\psi_{\\mathrm{in}} + \\psi_{\\mathrm{out}})/2$。将此代入离散化的平衡方程并求解 $\\psi_{\\mathrm{out}}$ 可得：\n$$\n\\psi_{\\mathrm{out}} = \\frac{Q_i + \\left(\\frac{|\\mu_m|}{\\Delta x} - \\frac{\\Sigma_{t,i}}{2}\\right)\\psi_{\\mathrm{in}}}{\\frac{|\\mu_m|}{\\Delta x} + \\frac{\\Sigma_{t,i}}{2}}\n$$\n菱形差分法一个众所周知的问题是它可能产生不符合物理的负通量，特别是在光学厚度大或通量梯度陡峭的区域。问题指定了非负修正方法。如果计算出的 $\\psi_{\\mathrm{out}}$ 为负，则将其设置为零。然后用此修正值重新计算栅格平均通量：$\\psi_{\\mathrm{avg}} = (\\psi_{\\mathrm{in}} + \\psi_{\\mathrm{out}})/2$。在验证过程中推导出，如果入射通量 $\\psi_{\\mathrm{in}}$ 是非负的，则 $\\psi_{\\mathrm{avg}}$ 的初始计算也保证是非负的，因此对其进行单独的钳位是多余的。\n\n### 5. 后处理与分析\n\n一旦源迭代收敛到最终的标量通量分布 $\\phi_i$，便可计算棒功率和误差度量。\n\n1.  **参考解**：首先，计算一个高保真度的参考解。根据问题要求，这使用阶梯特征线法，并采用每根燃料棒 $N_{cpp}=200$ 个栅格的精细网格。\n2.  **棒功率计算**：对于给定的燃料棒 $p$（包含一组栅格），棒功率 $P_p$ 计算为该棒内的总裂变率：\n    $$\n    P_p = \\sum_{i \\in \\text{cells of pin } p} \\nu\\Sigma_f^{(p)}\\,\\phi_i\\,\\Delta x = (\\nu\\Sigma_f^{(p)} \\Delta x) \\sum_{i \\in \\text{cells of pin } p} \\phi_i\n    $$\n    其中 $\\nu\\Sigma_f^{(p)}$ 是每次裂变的中子产额乘以燃料棒 $p$ 中材料的裂变截面。此计算得出参考棒功率 $P^{\\mathrm{ref}}_p$。\n3.  **测试案例与误差度量**：对于由其自身的网格尺寸和空间格式定义的每个测试案例，运行求解器以找到相应的棒功率 $P_p$。每个案例的准确性通过与参考功率分布的最大绝对相对偏差来量化：\n    $$\n    \\epsilon = \\max_{p=1,\\dots,N_{\\mathrm{pin}}} \\left| \\frac{P_p - P^{\\mathrm{ref}}_p}{P^{\\mathrm{ref}}_p} \\right|\n    $$\n4.  **最终输出**：收集并报告为四个指定测试案例计算出的 $\\epsilon$ 值。此分析展示了空间离散阶数和网格分辨率的选择如何影响一个关键工程参数——棒功率分布的准确性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the 1D discrete ordinates solver for the specified test cases.\n    \"\"\"\n    # --- Problem Constants ---\n    N_PIN = 10\n    W_PIN = 1.0  # cm\n    TOTAL_L = N_PIN * W_PIN  # cm\n    TOL = 1e-10\n\n    # Material Properties\n    # Fuel: pin indices 0, 2, 4, 6, 8\n    # Absorber: pin indices 1, 3, 5, 7, 9\n    mat_prop = {\n        'fuel': {'sigt': 0.6, 'sigs': 0.45, 'nusigf': 0.12, 'sext': 0.2},\n        'absorber': {'sigt': 1.5, 'sigs': 0.5, 'nusigf': 0.03, 'sext': 0.0}\n    }\n\n    # Angular Quadrature (S2)\n    mus = np.array([1.0 / np.sqrt(3.0), -1.0 / np.sqrt(3.0)])\n    weights = np.array([1.0, 1.0])\n\n    def run_simulation(cells_per_pin, scheme):\n        \"\"\"\n        Runs a 1D S2 transport simulation for a given geometry and discretization scheme.\n\n        Args:\n            cells_per_pin (int): Number of spatial cells discretizing each pin.\n            scheme (str): Spatial discretization scheme ('sc' for Step Characteristics, \n                          'dd' for Diamond Difference).\n\n        Returns:\n            np.ndarray: An array of the computed power for each of the N_PIN pins.\n        \"\"\"\n        n_cells = N_PIN * cells_per_pin\n        dx = TOTAL_L / n_cells\n\n        # --- Setup Mesh and Material Properties ---\n        sigt = np.zeros(n_cells)\n        sigs = np.zeros(n_cells)\n        nusigf = np.zeros(n_cells)\n        sext = np.zeros(n_cells)\n\n        for i in range(n_cells):\n            pin_idx = int(i / cells_per_pin)\n            mat_key = 'fuel' if pin_idx % 2 == 0 else 'absorber'\n            sigt[i] = mat_prop[mat_key]['sigt']\n            sigs[i] = mat_prop[mat_key]['sigs']\n            nusigf[i] = mat_prop[mat_key]['nusigf']\n            sext[i] = mat_prop[mat_key]['sext']\n\n        # --- Source Iteration ---\n        phi = np.zeros(n_cells)\n        phi_old = np.ones(n_cells)\n\n        while np.linalg.norm(phi - phi_old, ord=np.inf) / (np.linalg.norm(phi, ord=np.inf) + 1e-12) > TOL:\n            phi_old = phi.copy()\n            source = 0.5 * sigs * phi + 0.5 * sext\n            \n            # Reset scalar flux for new update\n            phi.fill(0.0)\n\n            for m in range(len(mus)):\n                mu = mus[m]\n                w = weights[m]\n                abs_mu = np.abs(mu)\n                \n                psi_avg_m = np.zeros(n_cells)\n\n                if mu > 0:  # Forward sweep (left to right)\n                    psi_in = 0.0  # Vacuum BC at x=0\n                    for i in range(n_cells):\n                        if scheme == 'sc':\n                            if sigt[i] > 0:\n                                tau = sigt[i] * dx / abs_mu\n                                if tau  1e-8:\n                                    exp_m_tau = 1.0 - tau\n                                    one_minus_exp_m_tau = tau\n                                    a = 1.0 - tau / 2.0\n                                else:\n                                    exp_m_tau = np.exp(-tau)\n                                    one_minus_exp_m_tau = 1.0 - exp_m_tau\n                                    a = one_minus_exp_m_tau / tau\n                                psi_out = psi_in * exp_m_tau + (source[i] / sigt[i]) * one_minus_exp_m_tau\n                                psi_avg_m[i] = a * psi_in + (1.0 - a) * (source[i] / sigt[i])\n                            else: # sigt == 0\n                                psi_out = psi_in + source[i] * dx / abs_mu\n                                psi_avg_m[i] = (psi_in + psi_out) / 2.0\n\n                        elif scheme == 'dd':\n                            den = abs_mu / dx + sigt[i] / 2.0\n                            num = source[i] + (abs_mu / dx - sigt[i] / 2.0) * psi_in\n                            psi_out = num / den\n                            \n                            # Non-negative fix-up\n                            if psi_out  0:\n                                psi_out = 0.0\n                            \n                            psi_avg_m[i] = (psi_in + psi_out) / 2.0\n                        \n                        psi_in = psi_out\n\n                else:  # Backward sweep (right to left)\n                    psi_in = 0.0  # Vacuum BC at x=L\n                    for i in range(n_cells - 1, -1, -1):\n                        if scheme == 'sc':\n                            if sigt[i] > 0:\n                                tau = sigt[i] * dx / abs_mu\n                                if tau  1e-8:\n                                    exp_m_tau = 1.0 - tau\n                                    one_minus_exp_m_tau = tau\n                                    a = 1.0 - tau / 2.0\n                                else:\n                                    exp_m_tau = np.exp(-tau)\n                                    one_minus_exp_m_tau = 1.0 - exp_m_tau\n                                    a = one_minus_exp_m_tau / tau\n                                psi_out = psi_in * exp_m_tau + (source[i] / sigt[i]) * one_minus_exp_m_tau\n                                psi_avg_m[i] = a * psi_in + (1.0 - a) * (source[i] / sigt[i])\n                            else: # sigt == 0\n                                psi_out = psi_in + source[i] * dx / abs_mu\n                                psi_avg_m[i] = (psi_in + psi_out) / 2.0\n                        \n                        elif scheme == 'dd':\n                            den = abs_mu / dx + sigt[i] / 2.0\n                            num = source[i] + (abs_mu / dx - sigt[i] / 2.0) * psi_in\n                            psi_out = num / den\n\n                            # Non-negative fix-up\n                            if psi_out  0:\n                                psi_out = 0.0\n                            \n                            psi_avg_m[i] = (psi_in + psi_out) / 2.0\n                        \n                        psi_in = psi_out\n                \n                phi += w * psi_avg_m\n\n        # --- Post-processing: Calculate Pin Powers ---\n        pin_powers = np.zeros(N_PIN)\n        for p in range(N_PIN):\n            cell_start_idx = p * cells_per_pin\n            cell_end_idx = (p + 1) * cells_per_pin\n            \n            # nusigf is constant within a pin\n            pin_nusigf = nusigf[cell_start_idx]\n            \n            # Sum of scalar flux over cells in the pin\n            phi_sum_in_pin = np.sum(phi[cell_start_idx:cell_end_idx])\n            \n            pin_powers[p] = pin_nusigf * phi_sum_in_pin * dx\n            \n        return pin_powers\n\n    # --- Calculations ---\n    \n    # 1. Compute reference pin powers\n    ref_cells_per_pin = 200\n    p_ref = run_simulation(ref_cells_per_pin, 'sc')\n\n    # 2. Define and run test cases\n    test_cases = [\n        (4, 'sc'),    # Case 1\n        (1, 'sc'),    # Case 2\n        (4, 'dd'),    # Case 3\n        (20, 'dd'),   # Case 4\n    ]\n\n    results = []\n    for (cells_per_pin, scheme) in test_cases:\n        p_test = run_simulation(cells_per_pin, scheme)\n        \n        # Calculate max absolute relative deviation (epsilon)\n        # Add a small number to denominator to avoid division by zero if ref power is zero\n        rel_diff = np.abs((p_test - p_ref) / (p_ref + 1e-12))\n        epsilon = np.max(rel_diff)\n        results.append(epsilon)\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n\n```"
        }
    ]
}