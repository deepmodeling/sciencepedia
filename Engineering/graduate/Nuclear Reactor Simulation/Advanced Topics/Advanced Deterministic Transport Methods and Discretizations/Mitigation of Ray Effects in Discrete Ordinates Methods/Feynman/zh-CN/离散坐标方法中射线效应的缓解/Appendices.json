{
    "hands_on_practices": [
        {
            "introduction": "我们从离散纵标法的核心——求积组——开始。离散方向的选择并非是随意的。本练习  将引导您探究标准水平对称求积组的结构特性，揭示出一种为从源头上防止最严重形式的射线效应而做出的刻意设计。通过检验其构造，您将理解为何某些会加剧射线伪影的特定方向（例如与笛卡尔坐标轴对齐的方向）被有意地排除了。",
            "id": "4235200",
            "problem": "考虑用于核反应堆模拟中子输运的三维离散纵标法（$N$阶水平对称求积，记为 $S_{N}$）。角向积分在单位球面上进行，使用方向余弦 $(\\mu,\\eta,\\xi)$（满足 $\\mu^{2}+\\eta^{2}+\\xi^{2}=1$），并且求积权重严格为正。水平对称求积将第一卦限的方向划分为若干“水平”(level)，每个水平中的成员由一个定义该水平的三元组的排列生成，并通过符号对称性扩展到整个球面，从而使完整的求积组具有 $N(N+2)$ 个方向。该构造受以下条件约束：对直到 $N-1$ 阶的角矩的精确性（等价于，与直到总阶数为 $N-1$ 的球谐函数的正交性条件），以及求积的归一化和对称性。\n\n你的任务是符号化地构造一个 $S_{12}$ 水平对称求积，列举出明确的第一卦限方向余弦及其重数，而不计算数值横坐标或权重。使用以下科学标准结构：\n\n- 令 $L=\\frac{N}{2}=6$ 表示第一卦限中的水平数。\n- 对于其中的5个水平（A类），定义形式为 $(\\alpha_{\\ell},\\alpha_{\\ell},\\beta_{\\ell})$ 的三元组，其中 $\\ell\\in\\{1,2,3,4,5\\}$，$\\alpha_{\\ell},\\beta_{\\ell}\\in(0,1)$ 且 $2\\alpha_{\\ell}^{2}+\\beta_{\\ell}^{2}=1$。每个A类水平通过其元素的排列产生3个不同的第一卦限方向。\n- 对于其中的1个水平（B类），定义一个三元组 $(\\gamma_{1},\\gamma_{2},\\gamma_{3})$，其中 $\\gamma_{1},\\gamma_{2},\\gamma_{3}\\in(0,1)$，均不相同，且 $\\gamma_{1}^{2}+\\gamma_{2}^{2}+\\gamma_{3}^{2}=1$。B类水平通过所有排列产生6个不同的第一卦限方向。\n- 为每个水平分配一个单一权重 $w_{\\ell}>0$，该权重用于该水平中的每个排列。施加矩约束，以确保在球面面积测度下，对于所有满足 $r+s+t\\leq N-1$ 的单项式 $\\mu^{r}\\eta^{s}\\xi^{t}$ 都是精确的，同时满足由符号变化和排列所隐含的对称性条件。\n\n该构造在应用符号对称性后，产生 $3\\times 5+6=21$ 个第一卦限方向和总共 $N(N+2)=168$ 个方向。\n\n仅使用上述符号构造和水平对称求积的定义约束，判断是否有任何构造出的方向与笛卡尔坐标轴对齐（即，是否有任何方向的 $(\\mu,\\eta,\\xi)$ 等于 $(\\pm 1,0,0)$、$(0,\\pm 1,0)$ 或 $(0,0,\\pm 1)$），已知这些方向会加剧离散纵标输运中的射线效应。\n\n计算所构造的完整 $S_{12}$ 水平对称求积组中包含的与坐标轴对齐的方向总数。最终答案以不带单位的整数形式表示。无需四舍五入。",
            "solution": "目标是确定在一个特定构造的 $S_{12}$ 水平对称求积组内与坐标轴对齐的方向总数。与坐标轴对齐的方向定义为三个笛卡尔分量中有两个为零的向量。在单位球面上，这些方向是 $(\\pm 1, 0, 0)$、$(0, \\pm 1, 0)$ 和 $(0, 0, \\pm 1)$。总共有6个这样的方向。\n\n问题描述了完整求积组的构造，该求积组包含 $N(N+2) = 12(12+2) = 168$ 个方向。该集合由第一卦限中的21个唯一方向作为基础生成。生成过程包括对这些第一卦限方向应用符号对称性。设一个第一卦限方向由方向余弦三元组 $(\\mu_0, \\eta_0, \\xi_0)$ 表示，根据第一卦限的定义，$\\mu_0 \\ge 0$, $\\eta_0 \\ge 0$, $\\xi_0 \\ge 0$。从这单个第一卦限方向生成的完整方向集由集合 $\\{(\\pm \\mu_0, \\pm \\eta_0, \\pm \\xi_0)\\}$ 给出，唯一方向的数量取决于是否有分量为零。\n\n对于完整求积组中的一个方向 $(\\mu, \\eta, \\xi)$ 要与坐标轴对齐，例如 $(\\pm 1, 0, 0)$，其分量的绝对值必须为 $(|\\mu|, |\\eta|, |\\xi|) = (1, 0, 0)$。由于分量的绝对值在符号变化下是不变的，这要求相应的第一卦限方向 $(\\mu_0, \\eta_0, \\xi_0)$ 必须是 $(1, 0, 0)$ 的一个排列。因此，问题的核心是确定是否有任何指定的第一卦限方向的分量可以等于0或1。\n\n第一卦限方向的构造被划分为两种类型的水平。\n\n1.  **A类水平**：有5个这样的水平，对应 $\\ell \\in \\{1, 2, 3, 4, 5\\}$。这些水平中任何方向的方向余弦都是三元组 $(\\alpha_{\\ell}, \\alpha_{\\ell}, \\beta_{\\ell})$ 的排列。问题明确说明了对这些值的约束：$\\alpha_{\\ell} \\in (0,1)$ 且 $\\beta_{\\ell} \\in (0,1)$。符号 $(0,1)$ 表示开区间，意味着 $0  \\alpha_{\\ell}  1$ 且 $0  \\beta_{\\ell}  1$。因此，分量 $\\alpha_{\\ell}$ 或 $\\beta_{\\ell}$ 都不能等于0或1。这样，从A类水平派生出的任何方向都不可能是 $(1,0,0)$ 的排列。\n\n2.  **B类水平**：有1个这样的水平。这个水平中任何方向的方向余弦都是三元组 $(\\gamma_1, \\gamma_2, \\gamma_3)$ 的排列。问题说明了对这些值的约束：$\\gamma_{1}, \\gamma_{2}, \\gamma_{3} \\in (0,1)$，并且它们都互不相同。这同样意味着对于 $i \\in \\{1, 2, 3\\}$，有 $0  \\gamma_i  1$。与A类水平一样，这些分量都不能等于0或1。这样，从B类水平派生出的任何方向都不可能是 $(1,0,0)$ 的排列。\n\n整个第一卦限方向集完全由来自A类和B类水平的方向组成。问题陈述中提供的约束条件 $\\alpha_{\\ell}, \\beta_{\\ell}, \\gamma_i \\in (0,1)$ 是决定性的。它们严格禁止第一卦限方向的任何分量为0或1。\n\n设 $(\\mu_0, \\eta_0, \\xi_0)$ 是21个第一卦限方向中的任意一个。根据以上分析，我们有 $\\mu_0  0$, $\\eta_0  0$ 且 $\\xi_0  0$。当通过应用符号对称性生成完整求积组时，我们得到形如 $(\\pm \\mu_0, \\pm \\eta_0, \\pm \\xi_0)$ 的方向。由于 $\\mu_0, \\eta_0, \\xi_0$ 均不为零，所以这些生成方向的任何分量都不能为零。\n\n然而，一个与坐标轴对齐的方向必须有两个零分量。由于所构造的整个 $S_{12}$ 集合中没有任何方向可以有零分量，因此它们中没有任何一个可能与坐标轴对齐。在许多现代离散纵标法中，这种将分量严格限制在 $(0,1)$ 范围内的求积组构造特性是刻意为之的，其目的正是为了避免将纵标点放置在坐标轴上，从而减轻射线效应。\n\n因此，在指定的 $S_{12}$ 求积组中，与坐标轴对齐的方向总数为 $0$。",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "射线效应不仅是角度离散化的产物，它同样受到我们空间离散化方式的影响。本练习  旨在探讨“数值扩散”这一概念，这是一种由简单空间格式（如一阶迎风格式）引入的人为效应。您将通过推导一个量化该效应的指标——数值扩散长度，来理解低阶格式如何无意中模糊或缓解射线效应所特有的尖锐束状伪影。",
            "id": "4235151",
            "problem": "考虑一个通过离散纵标 ($S_{N}$) 方法进行离散化的一维板状几何、单能中子输运问题。令 $x$ 表示空间坐标，并令方向余弦为 $0  \\mu \\leq 1$ 的单个纵标表示流动方向。连续流动算子为 $\\mu \\frac{\\partial \\psi}{\\partial x}$，其中 $\\psi(x)$ 是角通量。假设空间离散化在像元宽度为 $h$ 的均匀网格上使用一阶迎风有限体积格式。\n\n离散纵标 ($S_{N}$) 方法中的射线效应表现为角空间中网格尺度的束状伪影，并通过空间离散化进行传播。为了量化所选空间格式如何减轻这些伪影，定义数值扩散长度如下：引入流动算子的一阶迎风离散化的修正方程分析所隐含的等效人工扩散。然后，对于波数为 $k_{\\max}=\\pi/h$ 的网格尺度傅里叶模式，将数值扩散长度 $\\ell_{\\text{num}}$ 定义为仅由人工扩散使该模式的振幅减小 $\\exp(-1)$ 倍时沿 $x$ 的距离。\n\n从连续流动算子和一阶迎风有限体积离散化的定义出发，仅使用基于泰勒级数的修正方程分析和扩散作用下的傅里叶模式衰减，推导出 $\\ell_{\\text{num}}$ 关于 $h$ 和基本常数的解析表达式。最后，以米为单位表示 $\\ell_{\\text{num}}$，并以单个封闭形式的表达式给出结果。无需四舍五入。",
            "solution": "该问题要求推导在离散纵标方法背景下，一维流动算子的一阶迎风离散化的数值扩散长度 $\\ell_{\\text{num}}$。推导过程主要分为四个步骤：（1）离散化连续流动算子；（2）进行修正方程分析以识别出人工扩散项；（3）在瞬态框架下分析傅里叶模式的衰减；（4）计算最高波数模式衰减 $\\exp(-1)$ 倍时的特定长度尺度。\n\n步骤1：流动算子的离散化\n\n我们考虑连续的一维流动算子 $\\mu \\frac{\\partial \\psi}{\\partial x}$，其中 $\\psi(x)$ 是角通量，$\\mu  0$ 是方向余弦。我们在一个像元宽度为 $h$ 的均匀空间网格上离散化该算子。像元由 $i$ 索引，中心位于 $x_i$，边界位于 $x_{i \\pm 1/2}$。\n\n使用有限体积法，我们将算子在一个像元 $i$ 上积分，从 $x_{i-1/2}$ 到 $x_{i+1/2}$：\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\mu \\frac{\\partial \\psi}{\\partial x} \\, dx = \\mu [\\psi(x_{i+1/2}) - \\psi(x_{i-1/2})]\n$$\n通过除以像元宽度 $h$，得到像元平均算子：\n$$\n\\frac{1}{h} \\int_{x_{i-1/2}}^{x_{i+1/2}} \\mu \\frac{\\partial \\psi}{\\partial x} \\, dx = \\frac{\\mu}{h} [\\psi(x_{i+1/2}) - \\psi(x_{i-1/2})]\n$$\n对于一阶迎风格式，像元边界上的通量由迎风像元的像元平均通量来近似。由于方向余弦 $\\mu$ 是正的，中子流向 $x$ 正方向。因此，迎风方向在左侧（从像元 $i-1$ 到像元 $i$）。令 $\\psi_i$ 表示像元 $i$ 中的像元平均通量。边界通量的迎风近似为：\n$$\n\\psi(x_{i-1/2}) \\approx \\psi_{i-1}\n$$\n$$\n\\psi(x_{i+1/2}) \\approx \\psi_i\n$$\n将这些近似代入有限体积表达式，得到像元 $i$ 处的离散化流动算子：\n$$\n\\left( \\mu \\frac{\\partial \\psi}{\\partial x} \\right)_{\\text{discrete}, i} = \\mu \\frac{\\psi_i - \\psi_{i-1}}{h}\n$$\n\n步骤2：修正方程分析和人工扩散\n\n为了确定离散格式求解的等效连续方程，我们进行修正方程分析。我们将离散通量值 $\\psi_i$ 和 $\\psi_{i-1}$ 替换为它们围绕像元中心 $x_i$ 的泰勒级数展开式。位于 $x_{i-1} = x_i - h$ 处的通量 $\\psi_{i-1}$ 展开为：\n$$\n\\psi_{i-1} = \\psi(x_i - h) = \\psi(x_i) - h \\left.\\frac{\\partial \\psi}{\\partial x}\\right|_{x_i} + \\frac{h^2}{2} \\left.\\frac{\\partial^2 \\psi}{\\partial x^2}\\right|_{x_i} - O(h^3)\n$$\n将此展开式代入离散算子，并为与连续函数保持符号一致性，将 $\\psi(x_i)$ 表示为 $\\psi_i$：\n$$\n\\mu \\frac{\\psi_i - \\psi_{i-1}}{h} = \\frac{\\mu}{h} \\left[ \\psi_i - \\left( \\psi_i - h \\frac{\\partial \\psi}{\\partial x} + \\frac{h^2}{2} \\frac{\\partial^2 \\psi}{\\partial x^2} - O(h^3) \\right) \\right]\n$$\n$$\n= \\frac{\\mu}{h} \\left[ h \\frac{\\partial \\psi}{\\partial x} - \\frac{h^2}{2} \\frac{\\partial^2 \\psi}{\\partial x^2} + O(h^3) \\right]\n$$\n$$\n= \\mu \\frac{\\partial \\psi}{\\partial x} - \\frac{\\mu h}{2} \\frac{\\partial^2 \\psi}{\\partial x^2} + O(h^2)\n$$\n这个结果表明，一阶迎风格式近似了原始流动算子加上一个主阶截断误差项 $-\\frac{\\mu h}{2} \\frac{\\partial^2 \\psi}{\\partial x^2}$。该项具有扩散算子的形式，即 $-D_{\\text{art}} \\frac{\\partial^2 \\psi}{\\partial x^2}$，其中人工扩散系数为：\n$$\nD_{\\text{art}} = \\frac{\\mu h}{2}\n$$\n问题要求的是由这种“仅人工扩散”引起的衰减。\n\n步骤3：傅里叶模式衰减\n\n为了分析空间模式的衰减，通常考虑一个瞬态平流问题，$\\frac{\\partial \\psi}{\\partial t} + \\mu \\frac{\\partial \\psi}{\\partial x} = 0$。用一阶迎风格式离散化空间部分，得到修正的偏微分方程：\n$$\n\\frac{\\partial \\psi}{\\partial t} + \\mu \\frac{\\partial \\psi}{\\partial x} = D_{\\text{art}} \\frac{\\partial^2 \\psi}{\\partial x^2} = \\frac{\\mu h}{2} \\frac{\\partial^2 \\psi}{\\partial x^2}\n$$\n这是一个平流-扩散方程。我们分析它对单个空间傅里叶模式 $\\psi(x,t) = A(t) \\exp(ikx)$ 的影响，其中 $k$ 是波数。将其代入修正方程得到：\n$$\n\\frac{dA(t)}{dt} \\exp(ikx) + \\mu A(t) (ik) \\exp(ikx) = \\frac{\\mu h}{2} A(t) (ik)^2 \\exp(ikx)\n$$\n除以 $\\exp(ikx)$ 得到关于振幅 $A(t)$ 的常微分方程：\n$$\n\\frac{dA(t)}{dt} = -ik\\mu A(t) - k^2 \\frac{\\mu h}{2} A(t) = \\left( -ik\\mu - k^2 \\frac{\\mu h}{2} \\right) A(t)\n$$\n其解为 $A(t) = A(0) \\exp\\left( \\left( -ik\\mu - k^2 \\frac{\\mu h}{2} \\right) t \\right)$。振幅的模值演化如下：\n$$\n|A(t)| = |A(0)| \\left| \\exp(-ik\\mu t) \\exp\\left(-k^2 \\frac{\\mu h}{2} t\\right) \\right| = |A(0)| \\exp\\left(-k^2 \\frac{\\mu h}{2} t\\right)\n$$\n模式的衰减由指数的实部决定，该实部源于人工扩散项。\n\n步骤4：数值扩散长度的计算\n\n问题将 $\\ell_{\\text{num}}$ 定义为空间距离。我们可以通过考虑傅里叶模式传播的速度，将时间演化与空间传播联系起来。这个速度由波包的群速度 $v_g$ 给出。对于平流-扩散方程，色散关系为 $\\omega(k) = k\\mu - i k^2 \\frac{\\mu h}{2}$。群速度是 $\\omega$ 的实部对 $k$ 的导数：\n$$\nv_g = \\frac{d(\\text{Re}(\\omega))}{dk} = \\frac{d(k\\mu)}{dk} = \\mu\n$$\n一个波包在时间 $t = x/v_g = x/\\mu$ 内传播距离 $x$。我们可以将振幅衰减表示为传播距离 $x$ 的函数：\n$$\n|A(x)| = |A_0| \\exp\\left(-k^2 \\frac{\\mu h}{2} \\frac{x}{\\mu}\\right) = |A_0| \\exp\\left(-\\frac{k^2 h x}{2}\\right)\n$$\n注意，对方向余弦 $\\mu$ 的依赖性已经消除了。数值扩散长度 $\\ell_{\\text{num}}$ 是振幅减小 $\\exp(-1)$ 倍时的距离 $x$，即 $|A(\\ell_{\\text{num}})|/|A_0| = \\exp(-1)$。\n$$\n\\exp\\left(-\\frac{k^2 h \\ell_{\\text{num}}}{2}\\right) = \\exp(-1)\n$$\n对两边取自然对数，得到：\n$$\n\\frac{k^2 h \\ell_{\\text{num}}}{2} = 1 \\implies \\ell_{\\text{num}} = \\frac{2}{k^2 h}\n$$\n问题指定我们必须针对网格尺度的傅里叶模式计算这个值，该模式具有网格上可能的最大波数 $k_{\\max} = \\pi/h$。将这个值代入 $k$：\n$$\n\\ell_{\\text{num}} = \\frac{2}{\\left(\\frac{\\pi}{h}\\right)^2 h} = \\frac{2}{\\frac{\\pi^2}{h^2} h} = \\frac{2h}{\\pi^2}\n$$\n数值扩散长度的表达式用像元宽度 $h$ 和基本数学常数 $\\pi$ 表示。如果 $h$ 以米为单位给出，则 $\\ell_{\\text{num}}$ 也将以米为单位，符合要求。",
            "answer": "$$\\boxed{\\frac{2h}{\\pi^2}}$$"
        },
        {
            "introduction": "源项的性质是决定射线效应严重程度的关键因素，其中局域化源是主要诱因。这个动手编码练习  将对这一原理进行直接且定量的展示。通过比较点源与空间分布的体源所产生的角通量密度分布，您将使用一个简单的方差度量来证明，在物理上扩展源可以产生更平滑、更真实的角通量密度，从而有效缓解射线效应。",
            "id": "4235231",
            "problem": "考虑在均匀、无限介质中，有纯吸收（无散射）的稳态、单能线性输运方程，表示为 $\\boldsymbol{\\Omega}\\cdot\\nabla \\psi(\\mathbf{r},\\boldsymbol{\\Omega}) + \\Sigma_t \\psi(\\mathbf{r},\\boldsymbol{\\Omega}) = q(\\mathbf{r})/(4\\pi)$，其中 $\\psi(\\mathbf{r},\\boldsymbol{\\Omega})$ 是角通量，$\\Sigma_t$ 是总宏观截面，$\\boldsymbol{\\Omega}$ 是单位方向向量，$q(\\mathbf{r})$ 是各向同性源密度。在离散纵标（$S_N$）方法中，射线效应表现为由于通量集中在有限的一组离散方向上而引起的人为角度条纹。分布式体积源可以通过将方向性贡献分散到多个纵标上来减缓这些效应。您的任务是通过计算两种源配置下固定观察位置处 $\\psi(\\boldsymbol{\\Omega})$ 的角方差来定量地证明这种减缓效果：一种是各向同性点源，另一种是均匀立方体体积源。在三维空间中进行计算。\n\n基本原理和假设：\n- 使用上述线性输运方程作为基本模型，具有纯吸收、零散射和无限介质。\n- 各向同性点源位于原点，总发射率 $S_0$（单位：粒子/秒）。\n- 均匀体积源占据一个以原点为中心、边长为 $a$ 的立方体，其强度为 $s_v$（单位：粒子/立方厘米·秒），选择该强度以使总发射率与点源相等，即 $s_v a^3 = S_0$。\n- 在所有测试用例中，观察点的位置为 $\\mathbf{r}_{\\text{obs}}$，并且位于立方体外部。\n\n离散近似和算法定义：\n1. 离散纵标求积：\n   - 通过将在 $\\left[-1,1\\right]$ 上的 $\\mu = \\cos\\theta$ 使用 $N_\\mu$ 个 Gauss–Legendre 节点和权重，以及在 $\\left[0,2\\pi\\right)$ 上的方位角 $\\phi$ 使用 $N_\\phi$ 个等间距节点相结合，在单位球面上构造一个乘积求积。方向向量为 $\\boldsymbol{\\Omega}_{n} = (\\sin\\theta_i\\cos\\phi_j,\\,\\sin\\theta_i\\sin\\phi_j,\\,\\mu_i)$，权重为 $w_n = w^{(\\mu)}_i \\cdot \\Delta\\phi$，其中 $\\Delta\\phi = 2\\pi/N_\\phi$，$w^{(\\mu)}_i$ 是 Gauss–Legendre 权重。权重之和必须为 $4\\pi$。\n   - 角度必须以弧度为单位。\n\n2. 在 $\\mathbf{r}_{\\text{obs}}$ 处的角通量构造：\n   - 对于位于位置 $\\mathbf{r}_s$ 的源点，其对 $\\mathbf{r}_{\\text{obs}}$ 处角通量的贡献大小，沿着视线方向 $\\widehat{\\mathbf{d}} = (\\mathbf{r}_{\\text{obs}} - \\mathbf{r}_s)/\\lVert \\mathbf{r}_{\\text{obs}} - \\mathbf{r}_s\\rVert$ 和路径长度 $L = \\lVert \\mathbf{r}_{\\text{obs}} - \\mathbf{r}_s\\rVert$，由沿程衰减和几何稀释给出：$A(\\mathbf{r}_s) = \\left(\\frac{Q_s}{4\\pi}\\right) \\frac{e^{-\\Sigma_t L}}{L^2}$，其中 $Q_s$ 是分配给源点的发射率（对于点源，只有一个源点，$Q_s = S_0$；对于离散为 $M$ 个子点的体积源，每个子点的 $Q_s = S_0/M$）。\n   - 在离散纵标近似中，将来自 $\\mathbf{r}_s$ 的贡献分配给与 $\\widehat{\\mathbf{d}}$ 角分离最小的单个求积方向 $\\boldsymbol{\\Omega}_{n^*}$；等价地，选择 $n^* = \\underset{n}{\\arg\\max}\\, \\boldsymbol{\\Omega}_n\\cdot \\widehat{\\mathbf{d}}$。将 $A(\\mathbf{r}_s)$ 累加到 $n=n^*$ 的 $\\psi_n$ 中。\n   - 对于点源配置，只有一个 $\\mathbf{r}_s = \\mathbf{0}$。\n   - 对于体积源配置，通过一个包含 $M = N^3$ 个点的笛卡尔网格来近似均匀源，这些点位于立方体中心，均匀间隔，覆盖边长为 $a$ 的立方体。\n\n3. 角方差度量：\n   - 设 $\\{\\psi_n\\}_{n=1}^N$ 是构造的离散角通量值，$\\{w_n\\}_{n=1}^N$ 是相应的求积权重，且 $\\sum_{n=1}^N w_n = 4\\pi$。\n   - 计算加权平均值 $\\mu_\\psi = \\frac{1}{4\\pi}\\sum_{n=1}^N w_n \\psi_n$。\n   - 计算加权方差 $V_\\psi = \\frac{1}{4\\pi}\\sum_{n=1}^N w_n \\left(\\psi_n - \\mu_\\psi\\right)^2$。\n   - 报告归一化角方差（变异系数的平方）$C = \\frac{V_\\psi}{\\mu_\\psi^2}$，此值为无量纲。\n   - 定义方差缩减比 $\\rho = \\frac{C_{\\text{vol}}}{C_{\\text{point}}}$，其中 $C_{\\text{vol}}$ 和 $C_{\\text{point}}$ 分别是体积源和点源的归一化方差。$\\rho  1$ 的值表示射线效应得到减缓。\n\n单位和数值细节：\n- 长度单位必须是厘米 (cm)。\n- 截面 $\\Sigma_t$ 的单位必须是逆厘米 ($\\text{cm}^{-1}$)。\n- 源发射率 $S_0$ 的单位必须是粒子/秒 ($\\text{s}^{-1}$)，但您应将 $S_0$ 设为 1，以使最终输出无量纲且与任意缩放无关。\n- 角度必须以弧度为单位。\n\n测试套件：\n对于每个测试用例，应用上述算法计算给定观察点处的 $\\rho$。使用指定的求积大小和体积立方体参数。将所有测试用例的结果汇总到下面指定的单个输出行中。\n\n- 测试用例 1（一般情况，中等吸收，中等求积）：\n  - $\\Sigma_t = 0.1\\,\\text{cm}^{-1}$,\n  - $\\mathbf{r}_{\\text{obs}} = (10.0,\\,4.0,\\,2.0)\\,\\text{cm}$,\n  - $N_\\mu = 8$, $N_\\phi = 16$,\n  - 立方体边长 $a = 6.0\\,\\text{cm}$,\n  - 体积源离散化 $M = 1000$ (即每边 $N=10$)。\n\n- 测试用例 2（粗糙求积，预计射线效应更强）：\n  - $\\Sigma_t = 0.1\\,\\text{cm}^{-1}$,\n  - $\\mathbf{r}_{\\text{obs}} = (10.0,\\,4.0,\\,2.0)\\,\\text{cm}$,\n  - $N_\\mu = 4$, $N_\\phi = 8$,\n  - 立方体边长 $a = 6.0\\,\\text{cm}$,\n  - 体积源离散化 $M = 216$ (即每边 $N=6$)。\n\n- 测试用例 3（近点体积源，边界条件）：\n  - $\\Sigma_t = 0.1\\,\\text{cm}^{-1}$,\n  - $\\mathbf{r}_{\\text{obs}} = (10.0,\\,4.0,\\,2.0)\\,\\text{cm}$,\n  - $N_\\mu = 8$, $N_\\phi = 16$,\n  - 立方体边长 $a = 0.5\\,\\text{cm}$,\n  - 体积源离散化 $M = 1000$ (即每边 $N=10$)。\n\n- 测试用例 4（更高吸收，鲁棒性检查）：\n  - $\\Sigma_t = 0.7\\,\\text{cm}^{-1}$,\n  - $\\mathbf{r}_{\\text{obs}} = (10.0,\\,4.0,\\,2.0)\\,\\text{cm}$,\n  - $N_\\mu = 8$, $N_\\phi = 16$,\n  - 立方体边长 $a = 6.0\\,\\text{cm}$,\n  - 体积源离散化 $M = 1000$ (即每边 $N=10$)。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含上述四个测试用例的方差缩减比，形式为方括号内以逗号分隔的列表，例如 $\\left[\\rho_1,\\rho_2,\\rho_3,\\rho_4\\right]$。每个 $\\rho_i$ 必须是浮点数（无量纲）。程序必须直接运行，无需用户输入，并且必须根据规定的定义和单位在内部计算所有量。",
            "solution": "该解法首先构建角域的离散表示，然后模拟从两种不同源配置到固定观察点的粒子输运。其核心思想是表明，空间分布源将通量沉积在更宽的离散角方向范围内，从而与高度局域化的点源相比，降低了角方差。\n\n第一步是将连续角变量 $\\boldsymbol{\\Omega}$ 离散化为一组有限的 $N = N_\\mu \\times N_\\phi$ 个方向 $\\{\\boldsymbol{\\Omega}_n\\}$ 及相应的权重 $\\{w_n\\}$。这里采用乘积求积法。极角余弦 $\\mu = \\cos\\theta \\in [-1, 1]$ 使用 $N_\\mu$ 点的 Gauss-Legendre 求积进行离散化，得到一组节点 $\\{\\mu_i\\}_{i=1}^{N_\\mu}$ 和权重 $\\{w^{(\\mu)}_i\\}_{i=1}^{N_\\mu}$。极角则为 $\\theta_i = \\arccos(\\mu_i)$。这些权重的和为 $\\sum_{i=1}^{N_\\mu} w^{(\\mu)}_i = 2$。方位角 $\\phi \\in [0, 2\\pi)$ 被离散为 $N_\\phi$ 个均匀间隔的角度 $\\{\\phi_j\\}_{j=0}^{N_\\phi-1}$，其中 $\\phi_j = j \\cdot \\Delta\\phi$，角区间宽度为 $\\Delta\\phi = 2\\pi/N_\\phi$。与一对 $(\\mu_i, \\phi_j)$ 对应的离散方向 $\\boldsymbol{\\Omega}_n$ 在笛卡尔坐标系中表示为：\n$$ \\boldsymbol{\\Omega}_n = (\\sin\\theta_i\\cos\\phi_j, \\sin\\theta_i\\sin\\phi_j, \\mu_i) = (\\sqrt{1-\\mu_i^2}\\cos\\phi_j, \\sqrt{1-\\mu_i^2}\\sin\\phi_j, \\mu_i) $$\n与此方向相关的权重 $w_n$ 是极向权重和方位权重的乘积，$w_n = w^{(\\mu)}_i \\cdot \\Delta\\phi$。所有权重的总和为 $\\sum_{n=1}^{N} w_n = \\sum_{i=1}^{N_\\mu} w^{(\\mu)}_i \\sum_{j=0}^{N_\\phi-1} \\Delta\\phi = 2 \\cdot (N_\\phi \\cdot \\frac{2\\pi}{N_\\phi}) = 4\\pi$，这在单位球面上是正确归一化的。\n\n第二步是角通量计算。观察点 $\\mathbf{r}_{\\text{obs}}$ 处的角通量 $\\psi(\\mathbf{r}_{\\text{obs}}, \\boldsymbol{\\Omega})$ 是通过对所有源位置的贡献求和来构建的。对于位于位置 $\\mathbf{r}_s$、强度为 $Q_s$ 的源元，其沿视线的未碰撞通量贡献基于几何 $1/L^2$ 稀释和指数衰减。路径长度为 $L = \\lVert \\mathbf{r}_{\\text{obs}} - \\mathbf{r}_s\\rVert$。贡献的大小为：\n$$ A(\\mathbf{r}_s) = \\left(\\frac{Q_s}{4\\pi}\\right) \\frac{e^{-\\Sigma_t L}}{L^2} $$\n在离散纵标法中，这个沿精确方向 $\\widehat{\\mathbf{d}} = (\\mathbf{r}_{\\text{obs}}-\\mathbf{r}_s)/L$ 传播的连续贡献，被分配给角度上“最接近”的单个离散纵标 $\\boldsymbol{\\Omega}_{n^*}$。这通过最大化点积来找到：\n$$ n^* = \\underset{n}{\\arg\\max}\\ (\\boldsymbol{\\Omega}_n \\cdot \\widehat{\\mathbf{d}}) $$\n然后，通过累加这些贡献来更新初始化为零的离散角通量数组 $\\{\\psi_n = 0\\}_{n=1}^N$：$\\psi_{n^*} \\leftarrow \\psi_{n^*} + A(\\mathbf{r}_s)$。对所有源位置重复此过程。考虑两种源模型：\n1.  位于原点的单个点源，$\\mathbf{r}_s = \\mathbf{0}$，总强度 $Q_s = S_0$。这导致对一个特定纵标 $\\psi_{n^*}$ 的单个非零贡献，这是射线效应的特征。\n2.  一个体积源，其中边长为 $a$ 的立方体被离散为 $M=N^3$ 个相同的子立方体。每个子立方体由其中心的点源 $\\mathbf{r}_{s_k}$ 表示。总源强度 $S_0$ 在这些点之间平均分配，因此每个点的强度为 $Q_s = S_0/M$。通量是通过对所有 $M$ 个点的贡献求和来计算的。由于每个点 $\\mathbf{r}_{s_k}$ 定义了一个略有不同的视线方向 $\\widehat{\\mathbf{d}}_k$，总通量被分散到多个离散纵标上，从而减缓了射线效应。\n\n第三步是角方差量化。为量化角通量分布的平滑度，计算归一化方差。给定离散通量值集 $\\{\\psi_n\\}$ 和权重集 $\\{w_n\\}$，计算加权平均角通量（等效于标量通量除以 $4\\pi$）：\n$$ \\mu_\\psi = \\frac{1}{4\\pi}\\sum_{n=1}^N w_n \\psi_n $$\n接下来，计算加权方差：\n$$ V_\\psi = \\frac{1}{4\\pi}\\sum_{n=1}^N w_n \\left(\\psi_n - \\mu_\\psi\\right)^2 $$\n最后，无量纲的归一化角方差，或变异系数的平方，由以下公式给出：\n$$ C = \\frac{V_\\psi}{\\mu_\\psi^2} $$\n这个度量 $C$ 对点源（$C_{\\text{point}}$）和体积源（$C_{\\text{vol}}$）分别进行计算。\n\n最后一步是计算方差缩减比。体积源在减缓射线效应方面的有效性通过比率 $\\rho$ 来衡量：\n$$ \\rho = \\frac{C_{\\text{vol}}}{C_{\\text{point}}} $$\n$\\rho  1$ 的值表明，与点源相比，体积源产生更平滑的角通量分布（相对方差更低），从而证明了射线效应的减缓。该算法为每个测试用例实现这些步骤以计算相应的 $\\rho_i$。对于所有计算，总源强度设置为 $S_0=1$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom numpy.polynomial.legendre import leggauss\n\nclass RayEffectMitigationSimulator:\n    \"\"\"\n    Simulates particle transport from different sources to quantify ray effect mitigation.\n    \"\"\"\n    def __init__(self, sigma_t, r_obs, N_mu, N_phi, a, M):\n        \"\"\"\n        Initializes the simulator with parameters for a single test case.\n        \"\"\"\n        self.sigma_t = sigma_t\n        self.r_obs = np.array(r_obs, dtype=float)\n        self.N_mu = N_mu\n        self.N_phi = N_phi\n        self.a = a\n        self.M = M\n        self.S0 = 1.0  # Normalized total source strength, as per problem.\n\n        # Generate the discrete ordinates quadrature set upon initialization.\n        self.omegas, self.weights = self._generate_quadrature_set()\n\n    def _generate_quadrature_set(self):\n        \"\"\"\n        Constructs the product quadrature set (directions and weights).\n        \"\"\"\n        # Get N_mu Gauss-Legendre nodes (mu) and weights (w_mu) on [-1, 1].\n        # The sum of numpy's `leggauss` weights is 2.\n        mu_nodes, mu_weights = leggauss(self.N_mu)\n        \n        # Generate N_phi uniform azimuthal angles on [0, 2*pi).\n        phi_nodes = np.linspace(0.0, 2.0 * np.pi, self.N_phi, endpoint=False)\n        delta_phi = 2.0 * np.pi / self.N_phi\n        \n        num_directions = self.N_mu * self.N_phi\n        omegas = np.zeros((num_directions, 3))\n        weights = np.zeros(num_directions)\n        \n        idx = 0\n        for i in range(self.N_mu):\n            mu = mu_nodes[i]\n            w_mu = mu_weights[i]\n            # sin(theta) = sqrt(1 - cos^2(theta))\n            sin_theta = np.sqrt(1.0 - mu**2)\n            for j in range(self.N_phi):\n                phi = phi_nodes[j]\n                \n                # Convert from spherical to Cartesian coordinates for the direction vector.\n                omegas[idx, 0] = sin_theta * np.cos(phi)\n                omegas[idx, 1] = sin_theta * np.sin(phi)\n                omegas[idx, 2] = mu\n                \n                # The weight for this direction is the product of polar and azimuthal weights.\n                weights[idx] = w_mu * delta_phi\n                idx += 1\n        \n        return omegas, weights\n\n    def _calculate_normalized_variance(self, source_type):\n        \"\"\"\n        Calculates the normalized angular variance for a given source configuration.\n        \"\"\"\n        # 1. Generate source points and their individual strengths.\n        if source_type == 'point':\n            source_points = np.array([[0.0, 0.0, 0.0]])\n            q_s = self.S0\n        elif source_type == 'volumetric':\n            N = int(round(self.M**(1./3.)))\n            if N**3 != self.M:\n                # This check ensures M is a perfect cube as expected.\n                raise ValueError(f\"M={self.M} is not a perfect cube.\")\n            \n            # Create coordinates for sub-source points at the center of each sub-volume.\n            coords1d = np.linspace(-self.a / 2.0 + self.a / (2.0 * N), self.a / 2.0 - self.a / (2.0 * N), N)\n            x, y, z = np.meshgrid(coords1d, coords1d, coords1d, indexing='ij')\n            source_points = np.vstack([x.ravel(), y.ravel(), z.ravel()]).T\n            q_s = self.S0 / self.M\n        else:\n            raise ValueError(\"Invalid source type specified.\")\n\n        # 2. Calculate the discrete angular flux psi_n.\n        num_directions = len(self.weights)\n        psi_n = np.zeros(num_directions)\n\n        for r_s in source_points:\n            d = self.r_obs - r_s\n            L = np.linalg.norm(d)\n            if L == 0.0: continue # Observer is at a source point. Skip.\n            \n            d_hat = d / L\n            \n            # Calculate contribution magnitude: geometric dilution and attenuation.\n            A = (q_s / (4.0 * np.pi)) * np.exp(-self.sigma_t * L) / (L**2)\n\n            # Find the discrete ordinate that best matches the line-of-sight direction.\n            dot_products = self.omegas @ d_hat\n            n_star = np.argmax(dot_products)\n            \n            # Accumulate the contribution to the corresponding angular flux bin.\n            psi_n[n_star] += A\n        \n        # 3. Compute the normalized variance C.\n        # Weighted mean of the angular flux.\n        mu_psi = np.sum(self.weights * psi_n) / (4.0 * np.pi)\n        \n        # According to the problem, C = V / mu^2. If mu is zero, C is undefined.\n        # However, for the given test cases, mu_psi will be non-zero.\n        if mu_psi == 0.0:\n            return np.nan\n\n        # Weighted variance of the angular flux.\n        V_psi = np.sum(self.weights * (psi_n - mu_psi)**2) / (4.0 * np.pi)\n        \n        # Normalized variance (squared coefficient of variation).\n        C = V_psi / (mu_psi**2)\n        \n        return C\n\n    def compute_reduction_ratio(self):\n        \"\"\"\n        Computes the variance reduction ratio rho = C_vol / C_point.\n        \"\"\"\n        C_point = self._calculate_normalized_variance('point')\n        C_vol = self._calculate_normalized_variance('volumetric')\n\n        if C_point == 0.0:\n            return np.nan # C_point should be large and positive, but handle this case.\n\n        rho = C_vol / C_point\n        return rho\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (sigma_t, r_obs, N_mu, N_phi, a, M)\n        {'sigma_t': 0.1, 'r_obs': (10.0, 4.0, 2.0), 'N_mu': 8, 'N_phi': 16, 'a': 6.0, 'M': 1000},\n        {'sigma_t': 0.1, 'r_obs': (10.0, 4.0, 2.0), 'N_mu': 4, 'N_phi': 8, 'a': 6.0, 'M': 216},\n        {'sigma_t': 0.1, 'r_obs': (10.0, 4.0, 2.0), 'N_mu': 8, 'N_phi': 16, 'a': 0.5, 'M': 1000},\n        {'sigma_t': 0.7, 'r_obs': (10.0, 4.0, 2.0), 'N_mu': 8, 'N_phi': 16, 'a': 6.0, 'M': 1000},\n    ]\n\n    results = []\n    for params in test_cases:\n        # Instantiate the simulator for the current test case.\n        simulator = RayEffectMitigationSimulator(**params)\n        # Compute the variance reduction ratio.\n        rho = simulator.compute_reduction_ratio()\n        results.append(rho)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}