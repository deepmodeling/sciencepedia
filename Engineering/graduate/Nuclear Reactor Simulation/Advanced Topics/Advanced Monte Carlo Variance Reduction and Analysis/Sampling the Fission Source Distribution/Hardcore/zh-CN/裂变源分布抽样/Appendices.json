{
    "hands_on_practices": [
        {
            "introduction": "准确模拟裂变源是蒙特卡洛中子输运计算的核心。本实践从裂变中子能量的物理模型入手，要求您对比两种重要的能量谱模型：相对简单的麦克斯韦谱和物理上更精细的 Madland–Nix 模型。通过这个练习，您将亲手实践推导它们的解析矩，并设计相应的抽样算法，从而深化对裂变源能量分布物理基础的理解。",
            "id": "4247542",
            "problem": "要求您构建一个完整、可运行的程序，用于比较核反应堆模拟中两种用于瞬发裂变中子源能量的、具有物理动机的概率模型：麦克斯韦谱和 Madland–Nix 谱。您的程序必须为每种能谱实现具有科学依据的抽样方法，并且必须计算能量的一阶矩和二阶矩，以量化能谱选择对源能量分布的影响。所有与能量相关的量都必须以兆电子伏 (MeV) 为单位表示。在需要时，角度必须以弧度处理。程序必须以指定格式将最终结果生成在单行中。\n\n从以下基本原理出发，不使用任何未从这些原理推导出的简化公式：\n\n- 非相对论动能关系：对于质量为 $m$ 的粒子，其动能为 $E = \\frac{1}{2} m v^{2}$。当一个粒子从一个移动源各向同性地发射时，对于速度叠加，实验室坐标系下的速度平方为 $v^{2} = v'^{2} + V^{2} + 2 v' V \\cos\\theta$，其中 $\\theta \\in [0,\\pi]$。\n- 处于热平衡状态的粒子速率的麦克斯韦-玻尔兹曼分布及其导出的能量分布。\n- 用于描述从移动的裂变碎片发射中子的核蒸发图像，其中在碎片坐标系中的发射是各向同性的，质心发射能量 $E'$ 由一个具有特征发射温度 $T$ 的指数分布建模。\n- 能量守恒以及在碎片坐标系中发射的各向同性。\n\n您必须执行以下任务：\n\n1. 定义麦克斯韦源能量模型。用于描述从静止源发出的瞬发裂变中子能量 $E$ 的麦克斯韦模型是通过将麦克斯韦-玻尔兹曼速率分布转换为能量分布得到的。您必须推导出以发射温度参数 $T_{\\mathrm{M}}$ 表示的、经过适当归一化的概率密度函数 (Probability Density Function, PDF)，然后推导出单位分别为 MeV 和 $\\mathrm{MeV}^{2}$ 的一阶矩 $\\mathbb{E}[E]$ 和二阶矩 $\\mathbb{E}[E^{2}]$。您还必须设计一个抽样方法，以抽取与此 PDF 一致的 $E$ 的独立样本。\n\n2. 定义 Madland–Nix 源能量模型。Madland–Nix 模型处理从两类移动的裂变碎片（轻碎片和重碎片，标记为 $i \\in \\{L,H\\}$）的发射。在碎片坐标系中，中子发射能量 $E'$ 服从特征温度为 $T_{i}$ 的指数分布，且发射方向是各向同性的。在实验室坐标系中，碎片的运动产生一个非相对论运动学增益参数\n$$\nE_{b,i} = \\frac{\\mathrm{KE}_{\\mathrm{frag},i}}{A_{i}},\n$$\n其中 $\\mathrm{KE}_{\\mathrm{frag},i}$ 是碎片类别 $i$ 的动能，而 $A_{i}$ 是其质量数。使用 $E = \\frac{1}{2} m v^{2}$ 和非相对论速度叠加，证明发射中子的实验室能量可以写为\n$$\nE = E' + E_{b,i} + 2 \\sqrt{E' E_{b,i}} \\, \\mu,\n$$\n其中由于各向同性，$\\mu = \\cos\\theta$ 在 $[-1,1]$ 上均匀分布。推导每个碎片类别的一阶矩 $\\mathbb{E}[E]$ 和二阶矩 $\\mathbb{E}[E^{2}]$ 作为 $T_{i}$ 和 $E_{b,i}$ 的函数，然后推导通过等概率混合轻、重两类碎片得到的总 Madland–Nix 谱的矩。设计一个抽样方法，通过抽取 $E'$ 和 $\\mu$ 的样本并如上式组合得到 $E$，以抽取与此模型一致的 $E$ 的独立样本。\n\n3. 量化能谱选择的影响。对于下文的每个测试用例，计算 Madland–Nix 模型与麦克斯韦模型之间能量矩的差异：\n$$\n\\Delta m_{1} = \\mathbb{E}_{\\mathrm{MN}}[E] - \\mathbb{E}_{\\mathrm{M}}[E], \\quad \\Delta m_{2} = \\mathbb{E}_{\\mathrm{MN}}[E^{2}] - \\mathbb{E}_{\\mathrm{M}}[E^{2}],\n$$\n其中 $\\Delta m_{1}$ 以 MeV 为单位报告，$\\Delta m_{2}$ 以 $\\mathrm{MeV}^{2}$ 为单位报告。您的程序必须为两种模型实现抽样器，并根据模型定义计算推导出的解析矩差值。为确保确定性输出，您必须报告四舍五入到六位小数的解析矩差值。在内部，您必须通过使用固定的随机种子为每个测试用例的每个分布生成至少 $N = 100{,}000$ 个样本来验证抽样方法，以确认抽样得到的矩差值与解析值在合理的蒙特卡洛误差范围内一致，但您不得打印这些内部验证结果。\n\n物理单位要求：所有能量都必须以 $\\mathrm{MeV}$ 为单位处理和报告，二阶矩以 $\\mathrm{MeV}^{2}$ 为单位。没有需要报告的角度。\n\n您的测试套件包含三个用例，涵盖典型、低温和高温区间。对于每个用例，参数值如下：\n\n- 用例 1（典型热裂变）：麦克斯韦参数 $T_{\\mathrm{M}} = 1.3$；Madland–Nix 参数：轻碎片 $T_{L} = 1.0$，$\\mathrm{KE}_{\\mathrm{frag},L} = 100.0$，$A_{L} = 96$，得到 $E_{b,L} = \\mathrm{KE}_{\\mathrm{frag},L}/A_{L}$；重碎片 $T_{H} = 0.8$，$\\mathrm{KE}_{\\mathrm{frag},H} = 70.0$，$A_{H} = 140$，得到 $E_{b,H} = \\mathrm{KE}_{\\mathrm{frag},H}/A_{H}$。\n\n- 用例 2（较低温度）：麦克斯韦参数 $T_{\\mathrm{M}} = 0.5$；Madland–Nix 参数：轻碎片 $T_{L} = 0.6$，$\\mathrm{KE}_{\\mathrm{frag},L} = 90.0$，$A_{L} = 100$，得到 $E_{b,L}$；重碎片 $T_{H} = 0.5$，$\\mathrm{KE}_{\\mathrm{frag},H} = 80.0$，$A_{H} = 135$，得到 $E_{b,H}$。\n\n- 用例 3（较高温度）：麦克斯韦参数 $T_{\\mathrm{M}} = 2.0$；Madland–Nix 参数：轻碎片 $T_{L} = 1.6$，$\\mathrm{KE}_{\\mathrm{frag},L} = 110.0$，$A_{L} = 95$，得到 $E_{b,L}$；重碎片 $T_{H} = 1.2$，$\\mathrm{KE}_{\\mathrm{frag},H} = 60.0$，$A_{H} = 141$，得到 $E_{b,H}$。\n\n您的程序必须：\n\n- 为麦克斯韦谱和 Madland–Nix 谱实现符合上述物理推导的抽样器。\n- 根据您推导的公式，为每个用例计算解析的 $\\Delta m_{1}$ 和 $\\Delta m_{2}$。\n- 在内部使用每个谱、每个用例 $N = 100{,}000$ 个样本和一个固定的种子来验证蒙特卡洛估计的矩差值是否接近解析差值，但不要打印验证结果。\n- 生成单行输出，其中包含按 $[\\Delta m_{1}^{(1)},\\Delta m_{2}^{(1)},\\Delta m_{1}^{(2)},\\Delta m_{2}^{(2)},\\Delta m_{1}^{(3)},\\Delta m_{2}^{(3)}]$ 顺序排列的解析结果，以逗号分隔并用方括号括起，四舍五入到六位小数。\n\n程序输出中除此单行列表外，不得包含任何其他文本。",
            "solution": "我们从非相对论动能关系开始。对于质量为 $m$ 的粒子，其动能为 $E = \\frac{1}{2} m v^{2}$。如果一个质心速率为 $v'$ 的中子从一个以速率 $V$ 移动的碎片上各向同性地发射，则实验室速率满足 $v^{2} = v'^{2} + V^{2} + 2 v' V \\cos\\theta$，其中 $\\theta$ 在 $[0,\\pi]$ 上均匀分布，因此 $\\mu = \\cos\\theta$ 在 $[-1,1]$ 上均匀分布。用能量变量表示，$E' = \\frac{1}{2} m v'^{2}$，$E_{b} = \\frac{1}{2} m V^{2}$，以及\n$$\nE = E' + E_{b} + 2 \\sqrt{E' E_{b}} \\, \\mu.\n$$\n\n麦克斯韦模型。对于静止源（无增益），温度为 $T_{\\mathrm{M}}$ 的麦克斯韦-玻尔兹曼速率分布导出能量分布\n$$\nf_{\\mathrm{M}}(E; T_{\\mathrm{M}}) = \\frac{2}{\\sqrt{\\pi}} \\frac{E^{1/2}}{T_{\\mathrm{M}}^{3/2}} \\exp\\!\\left(-\\frac{E}{T_{\\mathrm{M}}}\\right), \\quad E \\ge 0,\n$$\n这是一个形状参数为 $k = \\frac{3}{2}$、尺度参数为 $\\theta = T_{\\mathrm{M}}$ 的伽马分布。根据通过\n$$\n\\mathbb{E}[E^{n}] = \\int_{0}^{\\infty} E^{n} f_{\\mathrm{M}}(E; T_{\\mathrm{M}}) \\, \\mathrm{d}E,\n$$\n推导出的伽马分布性质，我们得到\n$$\n\\mathbb{E}_{\\mathrm{M}}[E] = k \\theta = \\frac{3}{2} T_{\\mathrm{M}}, \\qquad \\mathbb{E}_{\\mathrm{M}}[E^{2}] = \\theta^{2} k (k + 1) = \\frac{15}{4} T_{\\mathrm{M}}^{2}.\n$$\n与 $f_{\\mathrm{M}}$ 一致的抽样方法是从形状参数为 $k = \\frac{3}{2}$、尺度参数为 $\\theta = T_{\\mathrm{M}}$ 的伽马分布中抽取 $E$，这可以通过变换 $E = \\frac{1}{2} m v^{2}$ 以及关联速率和能量 PDF 的雅可比行列式从麦克斯韦-玻尔兹曼速率分布推导得出。\n\nMadland–Nix 模型。在碎片坐标系中，我们用指数 PDF 对发射能量进行建模\n$$\nf_{E'}(E'; T_{i}) = \\frac{1}{T_{i}} \\exp\\!\\left( - \\frac{E'}{T_{i}} \\right), \\quad E' \\ge 0,\n$$\n这与温度为 $T_{i}$ 的蒸发谱和各向同性角度一致。每个核子的碎片动能为\n$$\nE_{b,i} = \\frac{\\mathrm{KE}_{\\mathrm{frag},i}}{A_{i}},\n$$\n因此，从碎片类别 $i \\in \\{L,H\\}$ 发射的中子的实验室坐标系能量为\n$$\nE = E' + E_{b,i} + 2 \\sqrt{E' E_{b,i}} \\, \\mu, \\quad \\mu \\sim \\mathrm{Uniform}(-1,1).\n$$\n我们通过以 $E'$ 和 $\\mu$ 为条件来推导每个碎片类别的一阶矩：\n$$\n\\mathbb{E}[E \\mid E'] = E' + E_{b,i} + 2 \\sqrt{E' E_{b,i}} \\, \\mathbb{E}[\\mu] = E' + E_{b,i},\n$$\n因为根据对称性 $\\mathbb{E}[\\mu] = 0$。因此\n$$\n\\mathbb{E}_{i}[E] = \\mathbb{E}[E'] + E_{b,i} = T_{i} + E_{b,i}.\n$$\n接下来，我们推导二阶矩。给定 $E'$，我们有\n$$\nE^{2} = \\left( E' + E_{b,i} + 2 \\sqrt{E' E_{b,i}} \\, \\mu \\right)^{2} = (E' + E_{b,i})^{2} + 4 \\sqrt{E' E_{b,i}} \\, \\mu (E' + E_{b,i}) + 4 E' E_{b,i} \\mu^{2}.\n$$\n对 $\\mu$ 取期望，使用 $\\mathbb{E}[\\mu] = 0$ 和 $\\mathbb{E}[\\mu^{2}] = \\frac{1}{3}$，得到\n$$\n\\mathbb{E}[E^{2} \\mid E'] = (E' + E_{b,i})^{2} + \\frac{4}{3} E' E_{b,i}.\n$$\n对 $E'$ 解除条件需要指数分布的矩，即 $\\mathbb{E}[E'] = T_{i}$ 和 $\\mathbb{E}[E'^{2}] = 2 T_{i}^{2}$。代入得：\n$$\n\\mathbb{E}_{i}[E^{2}] = \\mathbb{E}[E'^{2}] + 2 E_{b,i} \\mathbb{E}[E'] + E_{b,i}^{2} + \\frac{4}{3} E_{b,i} \\mathbb{E}[E'] = 2 T_{i}^{2} + E_{b,i}^{2} + \\frac{10}{3} E_{b,i} T_{i}.\n$$\n总的 Madland–Nix 谱是轻、重碎片的等概率混合，因此其矩是各碎片类别矩的平均值：\n$$\n\\mathbb{E}_{\\mathrm{MN}}[E] = \\frac{1}{2} \\left( T_{L} + E_{b,L} + T_{H} + E_{b,H} \\right),\n$$\n$$\n\\mathbb{E}_{\\mathrm{MN}}[E^{2}] = \\frac{1}{2} \\left( 2 T_{L}^{2} + E_{b,L}^{2} + \\frac{10}{3} E_{b,L} T_{L} + 2 T_{H}^{2} + E_{b,H}^{2} + \\frac{10}{3} E_{b,H} T_{H} \\right).\n$$\n因此，Madland–Nix 模型和麦克斯韦模型之间的矩差为\n$$\n\\Delta m_{1} = \\mathbb{E}_{\\mathrm{MN}}[E] - \\frac{3}{2} T_{\\mathrm{M}},\n$$\n$$\n\\Delta m_{2} = \\mathbb{E}_{\\mathrm{MN}}[E^{2}] - \\frac{15}{4} T_{\\mathrm{M}}^{2}.\n$$\n\n抽样方法。对于麦克斯韦模型，从形状为 $k = \\frac{3}{2}$、尺度为 $\\theta = T_{\\mathrm{M}}$ 的伽马分布中抽样 $E$ 与上面推导的 $f_{\\mathrm{M}}(E; T_{\\mathrm{M}})$ 一致。对于 Madland–Nix 模型，一个物理上一致的抽样器按以下步骤进行：以相等的概率选择碎片类别 $i$；从均值为 $T_{i}$ 的指数分布中抽样 $E'$；从 $[-1,1]$ 中均匀抽样 $\\mu$；计算 $E = E' + E_{b,i} + 2 \\sqrt{E' E_{b,i}} \\, \\mu$。该构造直接源于从碎片坐标系到实验室坐标系的能量非相对论变换以及发射的各向同性。\n\n验证。虽然最终报告的结果必须是四舍五入到六位小数的解析矩差值，但我们可以使用蒙特卡洛 (Monte Carlo, MC) 估计来验证抽样器。使用每个测试用例的每个分布 $N = 100{,}000$ 个样本和一个固定的随机种子，我们计算 $E$ 和 $E^2$ 的样本均值，并检查它们是否接近推导出的矩。根据中心极限定理 (Central Limit Theorem, CLT)，抽样误差的尺度与 $N^{-1/2}$ 相当，确保对于所选的 $N$，MC 估计值将接近解析值。\n\n实现细节。对于每个测试用例，根据给定参数通过 $E_{b,i} = \\mathrm{KE}_{\\mathrm{frag},i}/A_{i}$ 计算 $E_{b,i}$。然后使用上述公式以所需单位计算 $\\Delta m_{1}$ 和 $\\Delta m_{2}$。按照描述在内部执行 MC 验证，但仅以指定的单行格式打印最终的解析差值：$[\\Delta m_{1}^{(1)},\\Delta m_{2}^{(1)},\\Delta m_{1}^{(2)},\\Delta m_{2}^{(2)},\\Delta m_{1}^{(3)},\\Delta m_{2}^{(3)}]$，四舍五入到六位小数。不允许有其他输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef maxwellian_moments(T_M):\n    \"\"\"\n    Analytical moments for Maxwellian energy distribution (Gamma k=3/2, theta=T_M).\n    Returns (m1, m2): mean and second moment in MeV and MeV^2.\n    \"\"\"\n    m1 = 1.5 * T_M\n    m2 = (15.0 / 4.0) * (T_M ** 2)\n    return m1, m2\n\ndef madland_nix_moments(T_L, Eb_L, T_H, Eb_H):\n    \"\"\"\n    Analytical moments for Madland–Nix mixture (equal weights of light and heavy fragments).\n    E' ~ Exp(scale=T_i), mu ~ Uniform(-1,1), E = E' + Eb_i + 2*sqrt(E'*Eb_i)*mu\n    Returns (m1, m2): mean and second moment in MeV and MeV^2.\n    \"\"\"\n    # Per-fragment moments\n    m1_L = T_L + Eb_L\n    m2_L = 2.0 * (T_L ** 2) + (Eb_L ** 2) + (10.0 / 3.0) * Eb_L * T_L\n\n    m1_H = T_H + Eb_H\n    m2_H = 2.0 * (T_H ** 2) + (Eb_H ** 2) + (10.0 / 3.0) * Eb_H * T_H\n\n    # Mixture average\n    m1 = 0.5 * (m1_L + m1_H)\n    m2 = 0.5 * (m2_L + m2_H)\n    return m1, m2\n\ndef sample_maxwellian(T_M, N, rng):\n    \"\"\"\n    Sample energies from Maxwellian distribution using Gamma(k=3/2, theta=T_M).\n    Returns array of energies in MeV.\n    \"\"\"\n    # numpy's gamma uses shape k and scale theta\n    return rng.gamma(shape=1.5, scale=T_M, size=N)\n\ndef sample_madland_nix(T_L, Eb_L, T_H, Eb_H, N, rng):\n    \"\"\"\n    Sample energies from Madland–Nix distribution via physical construction.\n    Returns array of energies in MeV.\n    \"\"\"\n    # Choose fragment class indices: 0 for L, 1 for H\n    frag_choices = rng.integers(0, 2, size=N)  # equal probability\n    # Prepare arrays for parameters per sample\n    T = np.where(frag_choices == 0, T_L, T_H)\n    Eb = np.where(frag_choices == 0, Eb_L, Eb_H)\n\n    # Sample E' exponential with mean T (scale=T), mu uniform(-1,1)\n    E_prime = rng.exponential(scale=T, size=N)\n    mu = rng.uniform(low=-1.0, high=1.0, size=N)\n\n    # Construct lab energy\n    E = E_prime + Eb + 2.0 * np.sqrt(E_prime * Eb) * mu\n    # Numerical safeguard: E can be slightly negative due to rounding when E' and Eb are tiny; clip at 0\n    E = np.clip(E, 0.0, None)\n    return E\n\ndef compute_deltas(case, N_verify=100_000, seed=12345):\n    \"\"\"\n    For a given case, compute analytical delta moments and perform internal MC verification.\n    Returns (delta_m1, delta_m2) analytical values.\n    \"\"\"\n    T_M, T_L, KE_L, A_L, T_H, KE_H, A_H = case\n    Eb_L = KE_L / A_L\n    Eb_H = KE_H / A_H\n\n    # Analytical moments\n    m1_M, m2_M = maxwellian_moments(T_M)\n    m1_MN, m2_MN = madland_nix_moments(T_L, Eb_L, T_H, Eb_H)\n    delta_m1 = m1_MN - m1_M\n    delta_m2 = m2_MN - m2_M\n\n    # Internal MC verification (not printed)\n    rng = np.random.default_rng(seed)\n    # Sample Maxwellian\n    E_M = sample_maxwellian(T_M, N_verify, rng)\n    # Sample Madland–Nix\n    E_MN = sample_madland_nix(T_L, Eb_L, T_H, Eb_H, N_verify, rng)\n\n    # Compute sample moments\n    m1_M_sample = float(np.mean(E_M))\n    m2_M_sample = float(np.mean(E_M ** 2))\n    m1_MN_sample = float(np.mean(E_MN))\n    m2_MN_sample = float(np.mean(E_MN ** 2))\n    # Sample deltas (not used for output)\n    _delta_m1_sample = m1_MN_sample - m1_M_sample\n    _delta_m2_sample = m2_MN_sample - m2_M_sample\n    # Could assert closeness if desired; omitted to keep silent output\n\n    return delta_m1, delta_m2\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case tuple: (T_M, T_L, KE_L, A_L, T_H, KE_H, A_H)\n    test_cases = [\n        (1.3, 1.0, 100.0, 96.0, 0.8, 70.0, 140.0),   # Case 1\n        (0.5, 0.6, 90.0, 100.0, 0.5, 80.0, 135.0),   # Case 2\n        (2.0, 1.6, 110.0, 95.0, 1.2, 60.0, 141.0),   # Case 3\n    ]\n\n    results = []\n    for case in test_cases:\n        delta_m1, delta_m2 = compute_deltas(case)\n        # Round to six decimal places as required\n        results.append(f\"{delta_m1:.6f}\")\n        results.append(f\"{delta_m2:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在蒙特卡洛模拟中，根据能量和空间分布生成源中子后，关键的一步是统计这些源点，以构建下一代裂变源的空间分布。本练习聚焦于最常见的源表示方法——基于网格的组织图统计，并指导您推导该估计量的统计性质。理解这种估计量的方差对于评估模拟的统计质量和收敛性至关重要。",
            "id": "4247590",
            "problem": "考虑一个稳态中子输运特征值模拟，其中裂变源密度 $S(\\mathbf{r})$ 与中子产生率成正比，并且为了采样的目的，将其归一化使得 $\\int S(\\mathbf{r}) \\,\\mathrm{d}\\mathbf{r} = 1$。空间域被划分为一个由不相交的网格单元 $\\{c\\}$ 组成的网格，这些单元覆盖了整个区域。将网格单元概率 $p_c$ 定义为裂变出生位置 $\\mathbf{r}$ 位于网格单元 $c$ 内的概率，即 $p_c = \\int_{c} S(\\mathbf{r}) \\,\\mathrm{d}\\mathbf{r}$。\n\n假设您在一次蒙特卡洛（MC）模拟中从 $S(\\mathbf{r})$ 获得了 $N$ 个独立的裂变出生样本 $\\{\\mathbf{r}_i\\}_{i=1}^{N}$，并且每个抽样历史都带有一个由粒子数控制或非模拟技术产生的正权重 $w_i  0$。假设在网格单元间的抽样服从参数为 $\\{p_c\\}$ 的多项分布，并将权重 $\\{w_i\\}$ 视为从模拟迭代中已知的确定性常数。对于一个固定的网格单元 $c$，从 $p_c$ 的定义以及指示函数和期望的性质出发，构建一个 $p_c$ 的一致的基于网格的直方图估计量，该估计量利用指示函数 $\\mathbf{1}\\{\\mathbf{r}_i \\in c\\}$ 和权重 $\\{w_i\\}$。然后，在所述的多项分布抽样假设下，以封闭形式推导您估计量的方差，仅用 $p_c$、$N$ 和权重 $\\{w_i\\}$ 表示。\n\n将方差的最终结果表示为一个封闭形式的解析表达式。不需要进行数值计算。如果您选择解释结果，请在解题部分进行，但最终答案必须是无单位的单一封闭形式方差表达式。",
            "solution": "问题陈述经评估有效。其科学基础是粒子输运的蒙特卡洛模拟原理，问题提出得当，信息充分，可得到唯一解，且语言客观。其前提和定义是计算核反应堆物理领域的标准。\n\n任务是为网格单元概率 $p_c$ 构建一个一致的估计量，然后推导该估计量的方差。\n\n首先，我们构建 $p_c$ 的估计量。网格单元概率 $p_c$ 定义为归一化裂变源密度 $S(\\mathbf{r})$ 在网格单元 $c$ 体积上的积分：\n$$\np_c = \\int_{c} S(\\mathbf{r}) \\,\\mathrm{d}\\mathbf{r}\n$$\n通过引入网格单元 $c$ 的指示函数，可以将积分区域扩展到整个空间。该指示函数记为 $\\mathbf{1}\\{\\mathbf{r} \\in c\\}$，如果 $\\mathbf{r}$ 在网格单元 $c$ 中，则其值为 $1$，否则为 $0$。$p_c$ 的定义可以重写为：\n$$\np_c = \\int_{\\text{all space}} \\mathbf{1}\\{\\mathbf{r} \\in c\\} S(\\mathbf{r}) \\,\\mathrm{d}\\mathbf{r}\n$$\n这个表达式正是函数 $\\mathbf{1}\\{\\mathbf{r} \\in c\\}$ 的期望值的定义，其中 $\\mathbf{r}$ 是一个概率密度函数为 $S(\\mathbf{r})$ 的随机变量。因此，我们有：\n$$\np_c = E[\\mathbf{1}\\{\\mathbf{r} \\in c\\}]\n$$\n我们有从 $S(\\mathbf{r})$ 中抽取的 $N$ 个独立样本 $\\{\\mathbf{r}_i\\}_{i=1}^{N}$，每个样本 $i$ 都具有一个确定性的正权重 $w_i  0$。$p_c$ 的一个基于网格的直方图估计量 $\\hat{p}_c$ 可以构建为在每个样本点上评估的指示函数的加权和。设该估计量的形式为：\n$$\n\\hat{p}_c = C \\sum_{i=1}^{N} w_i \\mathbf{1}\\{\\mathbf{r}_i \\in c\\}\n$$\n其中 $C$ 是一个归一化常数。为了使该估计量是一致的，我们要求它是无偏的，即其期望必须等于真值 $p_c$。让我们计算 $\\hat{p}_c$ 的期望。由于权重 $\\{w_i\\}$ 被视为确定性常数，并且期望算子是线性的，我们有：\n$$\nE[\\hat{p}_c] = E\\left[ C \\sum_{i=1}^{N} w_i \\mathbf{1}\\{\\mathbf{r}_i \\in c\\} \\right] = C \\sum_{i=1}^{N} w_i E[\\mathbf{1}\\{\\mathbf{r}_i \\in c\\}]\n$$\n对于从 $S(\\mathbf{r})$ 中抽取的每个样本 $\\mathbf{r}_i$，指示函数的期望为 $E[\\mathbf{1}\\{\\mathbf{r}_i \\in c\\}] = p_c$。将此代入方程中得到：\n$$\nE[\\hat{p}_c] = C \\sum_{i=1}^{N} w_i p_c = C p_c \\left( \\sum_{i=1}^{N} w_i \\right)\n$$\n为确保无偏性，我们设定 $E[\\hat{p}_c] = p_c$。\n$$\np_c = C p_c \\left( \\sum_{j=1}^{N} w_j \\right)\n$$\n由于 $p_c$ 可以不为零，我们可以用它来除，从而解出 $C$：\n$$\n1 = C \\left( \\sum_{j=1}^{N} w_j \\right) \\implies C = \\frac{1}{\\sum_{j=1}^{N} w_j}\n$$\n因此， $p_c$ 的一致的加权直方图估计量为：\n$$\n\\hat{p}_c = \\frac{\\sum_{i=1}^{N} w_i \\mathbf{1}\\{\\mathbf{r}_i \\in c\\}}{\\sum_{j=1}^{N} w_j}\n$$\n\n接下来，我们推导该估计量的方差 $\\text{Var}(\\hat{p}_c)$。让我们定义随机变量 $X_i = \\mathbf{1}\\{\\mathbf{r}_i \\in c\\}$ 和总权重 $W_{tot} = \\sum_{j=1}^{N} w_j$。由于权重是确定性的，所以 $W_{tot}$ 是一个常数。该估计量可以写成：\n$$\n\\hat{p}_c = \\frac{1}{W_{tot}} \\sum_{i=1}^{N} w_i X_i\n$$\n那么方差为：\n$$\n\\text{Var}(\\hat{p}_c) = \\text{Var}\\left( \\frac{1}{W_{tot}} \\sum_{i=1}^{N} w_i X_i \\right)\n$$\n利用常数 $a$ 的性质 $\\text{Var}(aY) = a^2 \\text{Var}(Y)$，我们可以将常数项 $1/W_{tot}$ 提出：\n$$\n\\text{Var}(\\hat{p}_c) = \\frac{1}{W_{tot}^2} \\text{Var}\\left( \\sum_{i=1}^{N} w_i X_i \\right)\n$$\n问题陈述指出样本 $\\{\\mathbf{r}_i\\}$ 是独立的。因此，随机变量 $\\{X_i\\}$ 也是独立的。对于独立随机变量之和，和的方差是方差之和。此外，由于权重 $\\{w_i\\}$ 是常数，对于独立的 $Y_i$，我们使用性质 $\\text{Var}(\\sum a_i Y_i) = \\sum a_i^2 \\text{Var}(Y_i)$：\n$$\n\\text{Var}(\\hat{p}_c) = \\frac{1}{W_{tot}^2} \\sum_{i=1}^{N} \\text{Var}(w_i X_i) = \\frac{1}{W_{tot}^2} \\sum_{i=1}^{N} w_i^2 \\text{Var}(X_i)\n$$\n现在，我们必须求出 $X_i$ 的方差。随机变量 $X_i = \\mathbf{1}\\{\\mathbf{r}_i \\in c\\}$ 可以以概率 $P(\\mathbf{r}_i \\in c) = p_c$ 取值 $1$，以概率 $1 - p_c$ 取值 $0$。这是一个参数为 $p_c$ 的伯努利分布。伯努利分布的随机变量的方差由 $p(1 - p)$ 给出。因此，对于所有的 $i$：\n$$\n\\text{Var}(X_i) = p_c(1 - p_c)\n$$\n将此结果代回到我们估计量方差的表达式中：\n$$\n\\text{Var}(\\hat{p}_c) = \\frac{1}{W_{tot}^2} \\sum_{i=1}^{N} w_i^2 [p_c(1 - p_c)]\n$$\n项 $p_c(1 - p_c)$ 相对于求和索引 $i$ 是常数，因此可以从和中提出：\n$$\n\\text{Var}(\\hat{p}_c) = \\frac{p_c(1 - p_c)}{W_{tot}^2} \\sum_{i=1}^{N} w_i^2\n$$\n最后，将 $W_{tot}$ 的定义代回表达式，我们得到估计量方差的封闭形式表达式，用 $p_c$、$N$ 和权重 $\\{w_i\\}$ 表示：\n$$\n\\text{Var}(\\hat{p}_c) = \\frac{p_c(1 - p_c) \\sum_{i=1}^{N} w_i^2}{\\left(\\sum_{j=1}^{N} w_j\\right)^2}\n$$\n这就是网格单元概率 $p_c$ 的加权直方图估计量方差的最终解析表达式。",
            "answer": "$$\n\\boxed{\\frac{p_c(1 - p_c) \\sum_{i=1}^{N} w_i^2}{\\left(\\sum_{j=1}^{N} w_j\\right)^2}}\n$$"
        },
        {
            "introduction": "为了提高模拟效率，我们常使用方差缩减技术，这些技术会有意地偏倚中子的随机游走过程。然而，为保证结果的正确性，这些技术必须是“公平的”，即不能在最终估计中引入系统偏差。本练习通过一个简化的几何模型，展示了天真地使用轮盘赌技术可能导致的偏差，并要求您推导保持估计无偏所需的权重修正因子，这对正确应用高级抽样方法至关重要。",
            "id": "4247534",
            "problem": "考虑一个用于蒙特卡罗（MC）中子模拟中对裂变源分布进行抽样的单能、一维平板输运模型。该几何结构沿正$x$轴由三个连续区域组成：左侧燃料板 $\\mathcal{U} = [0, L]$、真空板 $\\mathcal{V} = [L, L+H]$ 和右侧燃料板 $\\mathcal{W} = [L+H, 2L+H]$，其中 $L  0$ 且 $H  0$。燃料区具有恒定的宏观总截面 $\\Sigma_{t}  0$，是纯吸收的（无散射），并具有宏观裂变截面 $\\Sigma_{f}  0$。真空区是理想真空，其 $\\Sigma_{t} = 0$。中子是单能的，为简化起见，$\\mathcal{U}$ 中的所有源中子都向右流，不发生角度再分布。您可以使用的基本事实是比尔-朗伯指数衰减定律以及MC估计量相对于粒子权重的线性关系。\n\n在 $\\mathcal{U}$ 中维持着一个均匀的裂变源密度 $S_{0}$（单位长度单位时间内的中子数），我们将 $\\mathcal{W}$ 中的目标裂变源分布定义为\n$$\nS_{\\text{true}}(x) = \\nu \\Sigma_{f} \\phi(x), \\quad x \\in [L+H, 2L+H],\n$$\n其中 $\\nu$ 是每次裂变产生的平均中子数，$\\phi(x)$ 是由从 $\\mathcal{U}$ 穿过真空区流向 $\\mathcal{W}$ 的源中子产生的（单能）标量通量。假设在 $x=0$ 和 $x=2L+H$ 处为真空边界。\n\n现在，在真空板 $\\mathcal{V}$ 中按如下方式实现一个朴素的俄罗斯轮盘赌：每当一个统计权重为 $w$ 的粒子进入 $\\mathcal{V}$ 时，它以概率 $r \\in (0,1)$ 被杀死，如果存活，则以不变的权重 $w$ 继续进入 $\\mathcal{W}$。不采用其他方差缩减或偏倚方法，所有计数都与粒子权重成正比。此轮盘赌在每个粒子历史中至多应用一次，具体是在从 $\\mathcal{U}$ 首次穿越到 $\\mathcal{V}$ 时。\n\n从第一性原理和给定的基本事实出发，推导在这种朴素轮盘赌下 $\\mathcal{W}$ 中的期望裂变源分布 $S_{\\text{RR}}(x)$，并计算由下式定义的乘性偏倚因子 $B$\n$$\nB = \\frac{\\mathbb{E}[\\hat{S}_{\\text{RR}}(x)]}{S_{\\text{true}}(x)},\n$$\n在此设置中，该因子应与 $x$ 无关。然后，确定一个恒定的权重重缩放校正因子 $C$，应用于在 $\\mathcal{V}$ 中轮盘赌后每个存活粒子的权重，使得校正后的估计量在期望上对所有 $x \\in [L+H, 2L+H]$ 都能恢复 $S_{\\text{true}}(x)$。\n\n将您的最终答案表示为一个二元行矩阵 $\\begin{pmatrix} B  C \\end{pmatrix}$，其形式为关于 $r$ 的闭式解。不需要进行数值舍入，最终表达式中不应包含任何物理单位。",
            "solution": "该问题要求推导由朴素俄罗斯轮盘赌方案引入的偏倚，并确定一个使该方案无偏的校正因子。我们将按要求从第一性原理出发进行推导。\n\n首先，我们建立右侧燃料板 $\\mathcal{W} = [L+H, 2L+H]$ 中真实的、未受扰动的裂变源分布 $S_{\\text{true}}(x)$。该源由标量中子通量 $\\phi(x)$ 产生，该通量源于在左侧燃料板 $\\mathcal{U} = [0, L]$ 中产生并向右流的中子。\n\n$\\mathcal{U}$ 中的源是均匀密度 $S_{0}$。考虑位于位置 $x' \\in [0, L]$ 的一个微分源元 $S_{0}dx'$。这些中子向右流。根据比尔-朗伯定律，来自该源元的未碰撞中子通量在穿过材料时会发生衰减。在 $\\mathcal{U}$ 内到达其右边界 $x=L$ 的路径长度为 $L-x'$。在真空区 $\\mathcal{V}=[L, L+H]$ 中的路径长度为 $H$，但总截面 $\\Sigma_t = 0$，因此没有衰减。在 $\\mathcal{W}$ 内到达点 $x \\in \\mathcal{W}$ 的路径长度为 $x-(L+H)$。\n\n来自 $x'$ 处源元对 $x$ 处标量通量的贡献为：\n$$\nd\\phi(x) = S_{0} \\exp(-\\Sigma_{t}(L-x')) \\exp(-0 \\cdot H) \\exp(-\\Sigma_{t}(x-(L+H))) dx'\n$$\n为求得 $x \\in \\mathcal{W}$ 处的总标量通量 $\\phi(x)$，我们必须对所有源位置 $x' \\in \\mathcal{U}$ 进行积分：\n$$\n\\phi(x) = \\int_{0}^{L} S_{0} \\exp(-\\Sigma_{t}(L-x')) \\exp(-\\Sigma_{t}(x-L-H)) dx'\n$$\n包含 $x$ 的项相对于积分变量 $x'$ 是常数。我们可以将其提出：\n$$\n\\phi(x) = S_{0} \\exp(-\\Sigma_{t}(x-L-H)) \\int_{0}^{L} \\exp(-\\Sigma_{t}(L-x')) dx'\n$$\n该积分的计算结果为：\n$$\n\\int_{0}^{L} \\exp(-\\Sigma_{t}(L-x')) dx' = \\left[ \\frac{1}{\\Sigma_{t}} \\exp(-\\Sigma_{t}(L-x')) \\right]_{x'=0}^{L} = \\frac{1}{\\Sigma_{t}} (1 - \\exp(-\\Sigma_{t}L))\n$$\n因此，$\\mathcal{W}$ 区域中真实的标量通量为：\n$$\n\\phi(x) = \\frac{S_{0}}{\\Sigma_{t}} (1 - \\exp(-\\Sigma_{t}L)) \\exp(-\\Sigma_{t}(x-L-H))\n$$\n真实的裂变源分布定义为 $S_{\\text{true}}(x) = \\nu \\Sigma_{f} \\phi(x)$，这给出：\n$$\nS_{\\text{true}}(x) = \\frac{\\nu \\Sigma_{f} S_{0}}{\\Sigma_{t}} (1 - \\exp(-\\Sigma_{t}L)) \\exp(-\\Sigma_{t}(x-L-H))\n$$\n\n接下来，我们分析朴素俄罗斯轮盘赌的影响。一个权重为 $w$ 的粒子进入真空区域 $\\mathcal{V}$ 时，以概率 $r$ 被杀死，以概率 $1-r$ 存活。如果存活，其权重保持为 $w$。所有计数都与粒子的权重成正比。\n\n考虑一个源于 $x' \\in \\mathcal{U}$ 的粒子历史。在没有轮盘赌的情况下，它对 $x \\in \\mathcal{W}$ 处标量通量的贡献将与其权重成正比，该权重呈指数衰减。我们用 $T_1(x, x')$ 表示一个在 $x'$ 处的单位权重源粒子对 $x$ 处计数的贡献。在这种情况下，通量的 $T_1$ 是 $\\exp(-\\Sigma_{t}(L-x')) \\exp(-\\Sigma_{t}(x-L-H))$。\n使用轮盘赌后，粒子的贡献是一个随机变量。\n- 以概率 $r$，粒子被杀死，其贡献为 $0$。\n- 以概率 $1-r$，它存活下来，权重不变，因此其贡献为 $T_1(x, x')$。\n\n来自这个单一历史的期望贡献 $\\mathbb{E}[T_{\\text{RR}}(x, x')]$ 是：\n$$\n\\mathbb{E}[T_{\\text{RR}}(x, x')] = T_1(x, x') \\times (1-r) + 0 \\times r = (1-r) T_1(x, x')\n$$\n期望标量通量 $\\phi_{\\text{RR}}(x)$ 是通过对源分布 $S_0$ 上的期望贡献进行积分得到的。由于期望的线性性质，积分和期望算子可以交换：\n$$\n\\phi_{\\text{RR}}(x) = \\mathbb{E}\\left[\\int_{0}^{L} S_{0} T_{\\text{RR}}(x, x') dx'\\right] = \\int_{0}^{L} S_{0} \\mathbb{E}[T_{\\text{RR}}(x, x')] dx'\n$$\n$$\n\\phi_{\\text{RR}}(x) = \\int_{0}^{L} S_{0} (1-r) T_1(x, x') dx' = (1-r) \\int_{0}^{L} S_{0} T_1(x, x') dx' = (1-r)\\phi(x)\n$$\n问题陈述蒙特卡罗估计量相对于粒子权重是线性的。估计的裂变源 $\\hat{S}_{\\text{RR}}(x)$ 与加权粒子的通量成正比。因此，该估计量的期望值 $S_{\\text{RR}}(x) = \\mathbb{E}[\\hat{S}_{\\text{RR}}(x)]$ 为：\n$$\nS_{\\text{RR}}(x) = \\nu \\Sigma_{f} \\phi_{\\text{RR}}(x) = \\nu \\Sigma_{f} (1-r) \\phi(x) = (1-r) S_{\\text{true}}(x)\n$$\n这就是朴素轮盘赌下的期望裂变源分布。\n\n乘性偏倚因子 $B$ 定义为期望估计值与真实值的比率：\n$$\nB = \\frac{\\mathbb{E}[\\hat{S}_{\\text{RR}}(x)]}{S_{\\text{true}}(x)} = \\frac{S_{\\text{RR}}(x)}{S_{\\text{true}}(x)} = \\frac{(1-r) S_{\\text{true}}(x)}{S_{\\text{true}}(x)} = 1-r\n$$\n该偏倚因子确实与 $x$ 无关。\n\n最后，我们确定使估计量无偏的恒定权重重缩放校正因子 $C$。如果一个估计量的期望等于真实值，则该估计量是无偏的。在蒙特卡罗方法中，这是通过确保粒子的期望权重在诸如俄罗斯轮盘赌等统计博弈中守恒来实现的。\n\n设 $w$ 是进入轮盘赌区域 $\\mathcal{V}$ 的粒子的权重。在校正方案中，如果粒子存活，其权重被重缩放为 $w' = Cw$。存活概率为 $1-r$。经过校正的轮盘赌后的期望权重 $\\mathbb{E}[w_{\\text{corr}}]$ 是：\n$$\n\\mathbb{E}[w_{\\text{corr}}] = (Cw) \\times (1-r) + 0 \\times r = Cw(1-r)\n$$\n为使期望权重守恒，我们必须有 $\\mathbb{E}[w_{\\text{corr}}] = w$：\n$$\nCw(1-r) = w\n$$\n因为对于到达轮盘赌区域的粒子 $w  0$ 且 $r \\in (0,1)$，我们可以除以 $w(1-r) \\neq 0$：\n$$\nC = \\frac{1}{1-r}\n$$\n使用此校正因子，任何历史的期望贡献变为 $C \\times (1-r) \\times T_1(x, x') = \\frac{1}{1-r} (1-r) T_1(x, x') = T_1(x, x')$。这就恢复了真实的期望值，使估计量变得无偏。\n\n所需的两个量是偏倚因子 $B = 1-r$ 和校正因子 $C = \\frac{1}{1-r}$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1-r  \\frac{1}{1-r}\n\\end{pmatrix}\n}\n$$"
        }
    ]
}