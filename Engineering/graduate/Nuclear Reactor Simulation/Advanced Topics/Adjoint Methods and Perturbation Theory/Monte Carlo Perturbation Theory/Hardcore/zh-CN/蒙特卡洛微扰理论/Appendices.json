{
    "hands_on_practices": [
        {
            "introduction": "蒙特卡洛微扰理论的核心在于“得分”的计算，它量化了在参数微小改变时，粒子历史的概率密度会如何变化。本练习将引导你深入理解这一核心概念，通过将粒子历史分解为自由飞行和碰撞事件，精确地构建在模拟过程中逐事件累积的似然比(Likelihood Ratio, LR)得分。掌握这项基本技能是实现任何基于LR方法的灵敏度分析程序的第一步 ()。",
            "id": "4236703",
            "problem": "一个固定源中子输运问题通过模拟蒙特卡罗(MC)方法进行模拟。几何结构是分片均匀的，在其中一个子区域 $D$ 内，仅微观吸收截面受到一个小的乘性微扰。具体来说，对于 $0$ 邻域内的 $\\varepsilon$，吸收和散射宏观截面满足 $\\Sigma_a(\\mathbf{r};\\varepsilon) = (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$ 和 $\\Sigma_s(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r})$，因此 $\\Sigma_t(\\mathbf{r};\\varepsilon) = \\Sigma_s^0(\\mathbf{r}) + (1+\\varepsilon)\\,\\Sigma_a^0(\\mathbf{r})$，其中仅在 $D$ 内有 $\\Sigma_a^0(\\mathbf{r})0$。源概率密度函数(PDF) $q(\\mathbf{r},\\mathbf{\\Omega},E)$ 以及所有的角/能量散射PDF都与 $\\varepsilon$ 无关，并且几何结构没有受到微扰。响应定义为 $R = h(X)$，其中 $X$ 表示一个完整的模拟历史（从源到终止），而 $h$ 是一个有界的计数泛函，它不显式依赖于 $\\varepsilon$（例如，在与 $D$ 不相交的探测器体积内，标量通量的径迹长度估计）。\n\n令 $p_\\varepsilon(X)$ 表示参数为 $\\varepsilon$ 下的模拟历史PDF，令 $\\mathbb{E}_\\varepsilon[\\cdot]$ 表示关于 $p_\\varepsilon$ 的期望值。我们感兴趣的量是 $\\delta R \\equiv \\left.\\dfrac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}$。\n\n似然比(LR)或得分函数恒等式指出，如果 $p_\\varepsilon$ 在 $\\varepsilon$ 上可微且 $h(X)$ 可积，则 $\\delta R = \\mathbb{E}_0\\!\\left[R\\,S(X)\\right]$，其中 $S(X) \\equiv \\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}$ 是单历史得分，它可以沿着模拟径迹作为单事件贡献的总和进行累积。\n\n以下哪个选项正确地描述了在这种情况下，为估计 $\\delta R$ 而无需运行微扰系统的一种可实现的单事件LR累积方法？选择所有适用的选项。\n\n- A. 在 $D$ 内的每个长度为 $\\ell$ 的自由飞行段上，将飞行贡献 $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$ 加到运行得分上。在 $D$ 内发生的每次反应类型为 $c\\in\\{a,s,f,\\dots\\}$ 的模拟碰撞中，加上碰撞贡献 $\\displaystyle\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}-\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$。对于 $D$ 之外的事件或角/能量抽样，不添加任何项，并且仅当源PDF依赖于 $\\varepsilon$ 时才添加源项 $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln q\\right|_{\\varepsilon=0}$。从独立同分布的标称历史 $X_n\\sim p_0$ 中构建无偏估计量 $\\widehat{\\delta R}=\\dfrac{1}{N}\\sum_{n=1}^{N} h(X_n)\\,S(X_n)$。\n\n- B. 忽略自由飞行贡献，仅在 $D$ 内的事件中添加碰撞贡献，即在每次类型为 $c$ 的碰撞中将得分增加 $\\dfrac{\\partial \\Sigma_c(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\big|_{\\varepsilon=0}$，而不进行任何通过 $\\Sigma_t$ 的归一化或减去总截面项。像选项A中那样构建 $\\widehat{\\delta R}$。\n\n- C. 在 $D$ 内的每个自由飞行段上，加上 $-\\displaystyle\\int_{\\text{segment}}\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\Big|_{\\varepsilon=0}\\,\\mathrm{d}s$，在 $D$ 内的每次碰撞中，加上 $\\left.\\dfrac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r};\\varepsilon)\\right|_{\\varepsilon=0}$。不需要其他项。像选项A中那样构建 $\\widehat{\\delta R}$。\n\n- D. 针对给定的仅吸收微扰进行特例化，在 $D$ 内的每个自由飞行段上累积 $-\\displaystyle\\int_{\\text{segment}}\\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s$。在 $D$ 内发生碰撞时，如果反应是吸收，则加上 $1-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$；如果是散射，则加上 $-\\dfrac{\\Sigma_a^0(\\mathbf{r})}{\\Sigma_t^0(\\mathbf{r})}$。对于 $D$ 之外的事件、边界穿越、角/能量抽样或源（因为 $q$ 与 $\\varepsilon$ 无关），不添加任何得分。通过将单历史得分乘以 $R$ 并对标称历史进行平均来估计 $\\delta R$。\n\n- E. 每次穿越 $D$ 和未微扰区域之间的边界时，添加一个等于 $\\left(\\Sigma_t^0\\big|_{\\text{inside }D}-\\Sigma_t^0\\big|_{\\text{outside }D}\\right)\\times \\ell_{\\text{prev}}$ 的跳跃项，其中 $\\ell_{\\text{prev}}$ 是紧邻的前一个自由飞行长度，以解释 $\\Sigma_t$ 的不连续性。此外，自由飞行和碰撞贡献是不必要的。像选项A中那样构建 $\\widehat{\\delta R}$。\n\n假设采用标准的模拟MC抽样：根据指数衰减定律进行自由飞行，根据与反应截面成正比的概率选择反应类型，在吸收时终止历史，没有方差缩减偏倚，也没有裂变源耦合（即固定源）。陈述所有正确的选项。",
            "solution": "我们从第一性原理开始：模拟蒙特卡罗(MC)方法根据输运过程的概率密度函数(PDF) $p_\\varepsilon(X)$ 对中子历史 $X$ 进行抽样，该PDF是由碰撞间的指数衰减、与反应宏观截面成正比的反应类型选择、从给定的角/能量PDF中抽样散射运动学以及源PDF $q$ 所决定的。响应为 $R=h(X)$，它不显式依赖于 $\\varepsilon$。似然比(LR)恒等式（也称为得分函数恒等式）断言\n$$\n\\delta R \\equiv \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\mathbb{E}_\\varepsilon[R]\\right|_{\\varepsilon=0}\n= \\left.\\frac{\\mathrm{d}}{\\mathrm{d}\\varepsilon}\\int h(X)\\,p_\\varepsilon(X)\\,\\mathrm{d}X\\right|_{\\varepsilon=0}\n= \\int h(X)\\, \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0} p_0(X)\\,\\mathrm{d}X\n= \\mathbb{E}_0\\!\\left[R\\,S(X)\\right],\n$$\n其中单历史得分为\n$$\nS(X) \\equiv \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln p_\\varepsilon(X)\\right|_{\\varepsilon=0}。\n$$\n为了实现 $S(X)$ 的单事件累积，我们将 $\\ln p_\\varepsilon(X)$ 分解为各事件贡献的总和。对于事件之间沿路径 $\\gamma_j$ 的一系列长度为 $\\ell_j$ 的自由飞行段 $j=1,\\dots,J$ 和在位置 $\\mathbf{r}_k$ 发生的一系列碰撞 $k=1,\\dots,K$，在模拟抽样中我们有：\n- 自由飞行存活因子 $\\exp\\!\\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)$，因此有对数项 $-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s$，\n- 反应类型选择概率 $\\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)/\\Sigma_t(\\mathbf{r}_k;\\varepsilon)$，因此有对数项 $\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)$，\n- 角和能量PDF以及源 $q$，根据假设它们不依赖于 $\\varepsilon$。\n\n因此，\n$$\n\\ln p_\\varepsilon(X)\n= \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\Sigma_t(\\mathbf{r};\\varepsilon)\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon) - \\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right)\n+ \\text{与 }\\varepsilon\\text{ 无关的项}，\n$$\n所以\n$$\nS(X) = \\sum_{j=1}^{J} \\left(-\\int_{\\gamma_j} \\left.\\frac{\\partial \\Sigma_t(\\mathbf{r};\\varepsilon)}{\\partial \\varepsilon}\\right|_{\\varepsilon=0}\\,\\mathrm{d}s\\right)\n+ \\sum_{k=1}^{K} \\left(\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_{c_k}(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\n- \\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t(\\mathbf{r}_k;\\varepsilon)\\right|_{\\varepsilon=0}\\right)。\n$$\n因为只有 $\\Sigma_a$ 受到微扰且仅在 $D$ 内部，所以在 $D$ 内部我们有\n$$\n\\left.\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\right|_{\\varepsilon=0} = \\Sigma_a^0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_a\\right|_{\\varepsilon=0} = 1,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_s\\right|_{\\varepsilon=0} = 0,\\quad\n\\left.\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right|_{\\varepsilon=0} = \\frac{\\Sigma_a^0}{\\Sigma_t^0},\n$$\n而在 $D$ 外部，所有这些导数均为 $0$。因此，得分仅在粒子位于 $D$ 内时累积：\n- 对于 $D$ 内的任何自由飞行段 $\\gamma$，飞行贡献为\n$$\nS_{\\text{flight}}(\\gamma) = -\\int_{\\gamma} \\Sigma_a^0(\\mathbf{r})\\,\\mathrm{d}s.\n$$\n- 对于 $D$ 内的一次碰撞：\n  - 如果反应是吸收 ($c=a$)，碰撞贡献为\n  $$\n  S_{\\text{coll}} = \\left(1\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = 1 - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\n  - 如果反应是散射 ($c=s$)，碰撞贡献为\n  $$\n  S_{\\text{coll}} = \\left(0\\right) - \\left(\\frac{\\Sigma_a^0}{\\Sigma_t^0}\\right) = - \\frac{\\Sigma_a^0}{\\Sigma_t^0}.\n  $$\n没有源项（因为 $q$ 与 $\\varepsilon$ 无关），没有来自角/能量抽样的项（根据假设），也没有显式的边界穿越跳跃项，因为 $\\ln p_\\varepsilon$ 是积分和局部反应概率的总和；边界仅仅是对路径积分进行分段。\n\n在确立了这些原则之后，我们来评估每个选项：\n\n- 选项A：此选项陈述了通用的单事件LR累积方法，该方法直接源于将 $\\ln p_\\varepsilon(X)$ 分解为自由飞行和碰撞贡献，其中仅当源和其他抽样贡献的PDF依赖于 $\\varepsilon$ 时才包括它们。它与推导出的形式相匹配：\n$$\nS = \\sum_{\\text{segments}} \\left(-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s\\right)\n+ \\sum_{\\text{collisions}} \\left(\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\right),\n$$\n其贡献仅限于 $D$ 内部。估计量 $\\widehat{\\delta R} = \\frac{1}{N}\\sum h(X_n) S(X_n)$ 是标准的LR估计量。结论：正确。\n\n- 选项B：此选项忽略了自由飞行贡献，并在碰撞时添加了一个未归一化的 $\\frac{\\partial \\Sigma_c}{\\partial \\varepsilon}$。根据推导，碰撞项必须是反应概率对数的导数，即 $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_c - \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$，而自由飞行存活贡献了 $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$。省略飞行项并且未能减去 $\\ln \\Sigma_t$ 部分会导致有偏的得分。结论：不正确。\n\n- 选项C：此选项使用了一个飞行项 $-\\int \\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t\\,\\mathrm{d}s$ 和一个碰撞项 $+\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$。正确的飞行贡献来自于 $-\\int \\Sigma_t\\,\\mathrm{d}s$ 的导数，而不是其对数的导数；因此它应该是 $-\\int \\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}\\,\\mathrm{d}s$。碰撞项应该是反应截面和总截面对数导数之差，而不是一个单独的 $\\frac{\\partial}{\\partial \\varepsilon}\\ln \\Sigma_t$。这重复计算了总截面并错误地指定了飞行贡献。结论：不正确。\n\n- 选项D：这是选项A针对给定微扰的特例化。它使用\n$$\nS_{\\text{flight}} = -\\int \\Sigma_a^0\\,\\mathrm{d}s,\\quad\nS_{\\text{coll}} = \\begin{cases}\n1 - \\Sigma_a^0/\\Sigma_t^0,  c=a,\\\\\n-\\Sigma_a^0/\\Sigma_t^0,  c=s,\n\\end{cases}\n$$\n仅应用于 $D$ 内部，没有源项或边界穿越项。这与推导出的表达式完全匹配。结论：正确。\n\n- 选项E：该选项假设存在一个与 $\\Sigma_t^0$ 的差异乘以先前的飞行长度成正比的边界穿越跳跃项，并省去了基于原理的自由飞行和碰撞贡献。当几何形状固定时，$\\ln p_\\varepsilon$ 的导数中不存在这样的边界跳跃；贡献来自于沿路径对 $\\frac{\\partial \\Sigma_t}{\\partial \\varepsilon}$ 的积分以及局部的反应对数概率。结论：不正确。\n\n因此，正确的选项是 A 和 D。",
            "answer": "$$\\boxed{AD}$$"
        },
        {
            "introduction": "学会了如何构建LR得分后，一个关键的实际问题是：它是否总是最佳选择？本练习将LR方法与更直观的有限差分(Finite Difference, FD)方法进行对比，探讨它们在偏差、方差、计算效率以及对不同类型微扰（如截面微扰与几何微扰）的适用性方面的优劣。通过这项实践，你将能够为具体的反应堆分析问题选择更合适的微扰计算方法 ()。",
            "id": "4236727",
            "problem": "一位反应堆物理分析师正在考虑使用两种蒙特卡洛微扰技术来估算临界反应堆中响应的导数，包括有效增殖因子 ($k_\\text{eff}$) 和区域积分通量。该参数化输运模型依赖于一个标量参数 $\\theta$，该参数用于缩放某个材料区域内局域的微观吸收截面。设 $R(\\theta)$ 表示一个可微的响应泛函，它可以表示为关于参数依赖的路径分布 $p_\\theta(X)$ 的期望值，其中 $X$ 是由蒙特卡洛输运模拟生成的随机历史（中子路径和相互作用序列）。该分析师考虑：\n\n(i) 一种单次运行的似然比 (LR) 估计量，它使用得分函数 $s_\\theta(X) = \\frac{\\partial}{\\partial \\theta}\\ln p_\\theta(X)$，基于标称参数下的一个共同的历史系综来构建导数估计量，以及\n\n(ii) 一种两次运行的相关有限差分 (FD) 估计量，它使用共同随机数 (CRN) 来耦合在 $\\theta+\\epsilon$ 和 $\\theta-\\epsilon$ 处的两次模拟，然后用步长为 $\\epsilon$ 的中心差商来近似导数。\n\n从期望值的基本定义以及方差和协方差的基本性质出发，该分析师寻求在实际反应堆问题中在这两种方法之间进行选择的标准，包括微扰在固定几何内修改材料截面的情况，以及微扰对应于将控制棒边界移动一小段距离的情况。以下哪些陈述是正确的？\n\n- A. 对于局限于固定几何形状内的微小截面微扰，$\\frac{dR}{d\\theta}$ 的单次运行 LR 估计量是无偏的，并且当 $\\epsilon \\to 0$ 时其方差不会激增，而相关中心 FD 导数估计量的方差按 $O\\!\\left(\\epsilon^{-2}(1-\\rho)\\right)$ 比例变化，其中 $\\rho$ 是两次运行响应之间的相关系数。因此，除非当 $\\epsilon \\to 0$ 时有 $1-\\rho = O(\\epsilon^2)$，否则对于非常小的步长，LR 方法通常具有更高的效率。\n\n- B. 当微扰是移动材料界面（例如，控制棒边界）的几何变化，且移动距离与平均自由程相当时，对于穿过移动边界的径迹，若无专门的表面项修正，标准路径 LR 得分 $s_\\theta(X)$ 没有良好定义，因此对于此类形状微扰，通常首选相关 FD 方法。\n\n- C. 如果需要计算关于许多独立截面的梯度，LR 方法可以通过累加一个得分函数项的向量，在单次模拟中提供所有偏导数，而相关 FD 方法每个参数都需要一对单独的运行；因此，在高维参数空间中，LR 通常更有效率。\n\n- D. 在具有高吸收的光学厚微扰区域中，由于指数衰减，LR 得分总是具有有界方差，因此无论相关水平如何，LR 的性能都统一优于相关 FD。\n\n- E. 对于一个光滑的响应 $R(\\theta)$，中心 FD 导数估计量具有 $O(\\epsilon^2)$ 的截断偏差，其方差表现为 $\\frac{\\mathrm{Var}(Y_{+}) + \\mathrm{Var}(Y_{-}) - 2\\,\\mathrm{Cov}(Y_{+},Y_{-})}{4\\epsilon^2}$；在使用共同随机数且方差近似相等的情况下，这简化为 $\\approx \\frac{\\sigma^2}{2N\\epsilon^2}(1-\\rho)$，这意味着要达到有竞争力的效率，需要当 $\\epsilon \\to 0$ 时有 $\\rho \\to 1$。",
            "solution": "问题要求评估比较两种蒙特卡洛微扰技术的陈述：单次运行的似然比（LR）方法和两次运行的相关有限差分（FD）方法。我们首先对这些估计量及其性质进行形式化描述。\n\n设响应由期望值 $R(\\theta) = \\mathbb{E}_{p_\\theta}[f(X)] = \\int f(X) p_\\theta(X) dX$ 给出，其中 $f(X)$ 是粒子历史 $X$ 的得分，$p_\\theta(X)$ 是该历史的概率密度，依赖于参数 $\\theta$。\n\n**1. 似然比 (LR) 方法**\n\n响应的导数是 $\\frac{dR}{d\\theta} = \\frac{d}{d\\theta} \\int f(X) p_\\theta(X) dX$。在微分和积分可以互换的条件下（即积分域与 $\\theta$ 无关，且 $p_\\theta(X)$ 足够光滑），我们有：\n$$ \\frac{dR}{d\\theta} = \\int f(X) \\frac{\\partial p_\\theta(X)}{\\partial \\theta} dX = \\int f(X) \\left( \\frac{1}{p_\\theta(X)} \\frac{\\partial p_\\theta(X)}{\\partial \\theta} \\right) p_\\theta(X) dX $$\n这可以写成一个期望值：\n$$ \\frac{dR}{d\\theta} = \\mathbb{E}_{p_\\theta} \\left[ f(X) \\frac{\\partial \\ln p_\\theta(X)}{\\partial \\theta} \\right] = \\mathbb{E}_{p_\\theta} [f(X) s_\\theta(X)] $$\n其中 $s_\\theta(X) = \\frac{\\partial}{\\partial \\theta}\\ln p_\\theta(X)$ 是得分函数。基于从标称分布 $p_\\theta(X)$ 中抽取的 $N$ 个样本 $\\{X_i\\}_{i=1}^N$ 的 LR 估计量是：\n$$ \\left( \\frac{dR}{d\\theta} \\right)_{\\text{LR}} = \\frac{1}{N} \\sum_{i=1}^N f(X_i) s_\\theta(X_i) $$\n只要算子互换有效，该估计量就是无偏的。其方差为 $\\frac{1}{N}\\mathrm{Var}_{p_\\theta}[f(X)s_\\theta(X)]$，这是一个与任何有限差分步长无关的常数。\n\n**2. 有限差分 (FD) 方法**\n\n导数的中心差分近似为：\n$$ \\frac{dR}{d\\theta} \\approx \\frac{R(\\theta+\\epsilon) - R(\\theta-\\epsilon)}{2\\epsilon} $$\nFD 估计量使用两次独立的模拟，一次在 $\\theta+\\epsilon$ 处，一次在 $\\theta-\\epsilon$ 处。设 $Y_+ = f(X_+)$ 其中 $X_+ \\sim p_{\\theta+\\epsilon}$ 且 $Y_- = f(X_-)$ 其中 $X_- \\sim p_{\\theta-\\epsilon}$。基于 $N$ 对样本的估计量是：\n$$ \\left( \\frac{dR}{d\\theta} \\right)_{\\text{FD}} = \\frac{\\bar{Y}_+ - \\bar{Y}_-}{2\\epsilon} = \\frac{1}{N} \\sum_{i=1}^N \\frac{f(X_{+,i}) - f(X_{-,i})}{2\\epsilon} $$\n使用共同随机数 (CRN) 会在 $Y_{+,i}$ 和 $Y_{-,i}$ 之间引入正相关。\n\n*   **FD 的偏差：** $R(\\theta)$ 在 $\\theta$ 附近的泰勒展开表明，中心差分公式的截断偏差为 $O(\\epsilon^2)$：\n    $$ \\frac{R(\\theta+\\epsilon) - R(\\theta-\\epsilon)}{2\\epsilon} = \\frac{dR}{d\\theta} + \\frac{\\epsilon^2}{6}\\frac{d^3R}{d\\theta^3} + O(\\epsilon^4) $$\n*   **FD 的方差：** 该估计量的方差为：\n    $$ \\mathrm{Var}\\left[\\left(\\frac{dR}{d\\theta}\\right)_{\\text{FD}}\\right] = \\mathrm{Var}\\left[\\frac{\\bar{Y}_+ - \\bar{Y}_-}{2\\epsilon}\\right] = \\frac{\\mathrm{Var}(\\bar{Y}_+) + \\mathrm{Var}(\\bar{Y}_-) - 2\\mathrm{Cov}(\\bar{Y}_+, \\bar{Y}_-)}{4\\epsilon^2} $$\n    对于大的 $N$，这等于 $\\frac{1}{N} \\frac{\\mathrm{Var}(Y_+) + \\mathrm{Var}(Y_-) - 2\\mathrm{Cov}(Y_+, Y_-)}{4\\epsilon^2}$。如果我们假设 $\\mathrm{Var}(Y_+) \\approx \\mathrm{Var}(Y_-) \\approx \\sigma^2$ 并定义相关系数 $\\rho = \\frac{\\mathrm{Cov}(Y_+, Y_-)}{\\sqrt{\\mathrm{Var}(Y_+)\\mathrm{Var}(Y_-)}}$，则方差变为：\n    $$ \\mathrm{Var}\\left[\\left(\\frac{dR}{d\\theta}\\right)_{\\text{FD}}\\right] \\approx \\frac{2\\sigma^2 - 2\\rho\\sigma^2}{4N\\epsilon^2} = \\frac{\\sigma^2(1-\\rho)}{2N\\epsilon^2} $$\n该方差按 $O(\\epsilon^{-2}(1-\\rho))$ 比例变化。\n\n有了这些基础知识，我们来评估每个选项。\n\n**选项 A:**\n该陈述讨论了固定几何形状中的微小截面微扰。\n- LR 估计量是无偏的这一说法是正确的。对于截面微扰，积分域是固定的，路径概率密度 $p_\\theta(X)$ 对于不同的 $\\theta$ 通常在同一组路径上非零，这允许微分和积分的互换。\n- 其方差在 $\\epsilon \\to 0$ 时不激增的说法也是正确的。LR 估计量的公式和方差与任何有限差分步长 $\\epsilon$ 无关。\n- 相关中心 FD 估计量的方差按 $O(\\epsilon^{-2}(1-\\rho))$ 比例变化的说法是正确的，如上所述。\n- 结论是，除非当 $\\epsilon \\to 0$ 时 $1-\\rho = O(\\epsilon^2)$，否则对于非常小的步长，LR 通常效率更高。FD 方法的总误差有两个组成部分：一个 $O(\\epsilon^2)$ 的偏差项和一个 $O(\\epsilon^{-2}(1-\\rho))$ 的统计方差项。为了使方差在 $\\epsilon \\to 0$ 时保持有界，因子 $1-\\rho$ 必须以至少 $O(\\epsilon^2)$ 的速率趋于零。如果不满足此条件，FD 方差将在 $\\epsilon \\to 0$ 时发散，使得具有固定方差的 LR 方法更有效率。该陈述是对效率权衡的正确分析。对于平滑变化的截面，CRN 通常可以实现 $1-\\rho = O(\\epsilon^2)$，但该陈述将其作为一个条件的逻辑是合理的。\n**结论：正确。**\n\n**选项 B:**\n该陈述讨论了几何微扰，例如移动控制棒边界。\n- 几何微扰改变了区域边界。这意味着概率密度 $p_\\theta(X)$ 的支撑集随 $\\theta$ 变化。对于一条穿过被微扰边界的路径 $X$，$p_\\theta(X)$ 可能对某些 $\\theta$ 值为非零，而对其他值为零。这种不可微性和缺乏绝对连续性使得简单的导数和积分互换失效。得分 $s_\\theta(X)$ 变得不适定 (ill-defined)，在边界处涉及到狄拉克函数。\n- 为了处理这个问题，需要引入表面积分（边界项）的专门技术，这些技术是对标准“路径 LR 得分”的修正。\n- 在没有这些复杂修正的情况下，FD 方法是一种更直接和鲁棒的方法。它直接模拟边界在 $\\theta+\\epsilon$ 和 $\\theta-\\epsilon$ 处的系统。尽管如果路径差异显著，CRN 的有效性可能会降低，但该方法仍然适用。因此，在标准实践中，对于此类问题，确实通常首选相关 FD 方法。\n**结论：正确。**\n\n**选项 C:**\n该陈述比较了这两种方法在处理具有许多独立参数（例如，不同区域或能群中的截面）的问题时的表现。\n- 对于 LR 方法，要计算关于参数向量 $\\vec{\\theta} = (\\theta_1, \\dots, \\theta_M)$ 的梯度 $\\nabla_\\theta R$，需要计算得分向量 $\\vec{s}_{\\vec{\\theta}}(X) = (\\frac{\\partial \\ln p_{\\vec{\\theta}}(X)}{\\partial \\theta_1}, \\dots, \\frac{\\partial \\ln p_{\\vec{\\theta}}(X)}{\\partial \\theta_M})$。所有导数 $\\frac{\\partial R}{\\partial \\theta_j} = \\mathbb{E}[f(X) s_{\\theta_j}(X)]$ 都是关于同一个标称分布 $p_{\\vec{\\theta}}(X)$ 的期望。因此，可以通过对每个历史 $X_i$ 累加计数 $f(X_i)$ 与得分向量的每个分量的乘积，使用单次蒙特卡洛模拟来估计所有 $M$ 个偏导数。计算成本大致相当于一次模拟的成本，外加计算 $M$ 个得分分量的（通常很小的）开销。\n- 对于 FD 方法，估计每个偏导数 $\\frac{\\partial R}{\\partial \\theta_j}$ 需要在参数值为 $\\vec{\\theta} \\pm \\epsilon \\hat{e}_j$ 处进行一对模拟，其中 $\\hat{e}_j$ 是第 $j$ 个参数的单位向量。要估计整个梯度，必须对所有 $M$ 个参数重复此过程，需要 $M$ 对运行，总共 $2M$ 次模拟。\n- 因此，在高维参数空间（$M \\gg 1$）中，LR 通常更有效率的结论是正确的，因为其成本大致与 $M$ 无关，而 FD 的成本随 $M$ 线性扩展。\n**结论：正确。**\n\n**选项 D:**\n该陈述对 LR 方法在光学厚、高吸收区域的表现做出了一个强有力的断言。\n- 该断言声称“由于指数衰减，LR 得分的方差总是有界的”。这在事实上是错误的。LR 估计量的方差 $\\mathrm{Var}[f(X)s_\\theta(X)]$ 在恰好此类问题中可能非常大甚至无穷大。虽然衰减降低了长中子路径的概率，但此类稀有路径的得分 $s_\\theta(X)$ 可能极其大。得分随着在微扰区域内的每次相互作用而累积。如果一个微扰减少了吸收，那么以前稀有（高度衰减）的路径会变得更可能发生，而这些路径在导数计算中带有很大的权重，从而导致高方差。这个问题是 LR 方法一个众所周知的局限性，尤其是在深穿透或屏蔽问题中。高吸收并不能保证方差小或有界；它常常使情况变得更糟。\n- 随后的结论“无论相关水平如何，LR 的性能都统一优于相关 FD”是错误的。方法的选择高度依赖于具体问题，并且鉴于关于 LR 方差的前提存在缺陷，这种概括是没有根据的。如果相关性高和/或 LR 方差过大，相关 FD 方法可能更优。\n**结论：不正确。**\n\n**选项 E:**\n该陈述分析了中心 FD 估计量的误差分量。\n- 对于光滑响应 $R(\\theta)$，偏差被正确地确定为 $O(\\epsilon^2)$。这是中心差分的一个标准结果。\n- 方差公式 $\\frac{\\mathrm{Var}(Y_{+}) + \\mathrm{Var}(Y_{-}) - 2\\,\\mathrm{Cov}(Y_{+},Y_{-})}{4\\epsilon^2}$ 是量 $\\frac{Y_+ - Y_-}{2\\epsilon}$（即样本大小为 $N=1$ 时）的方差的正确表达式。\n- 在使用共同随机数和方差近似相等的假设下（令 $\\sigma^2 \\approx \\mathrm{Var}(Y_\\pm)$ 并考虑样本大小为 $N$），简化为 $\\approx \\frac{\\sigma^2}{2N\\epsilon^2}(1-\\rho)$ 也是一个标准且正确的推导。\n- “要达到有竞争力的效率需要当 $\\epsilon \\to 0$ 时 $\\rho \\to 1$”的推论是一个直接且至关重要的结果。为了防止方差因 $\\epsilon^{-2}$ 项而激增，因子 $(1-\\rho)$ 必须趋于零。由于 $\\rho \\le 1$，这意味着 $\\rho$ 必须趋近于 1。这一见解对于理解相关 FD 方法的行为至关重要。\n**结论：正确。**\n\n最终总结：陈述 A、B、C 和 E 是对蒙特卡洛输运中 LR 和相关 FD 方法的性质及比较优点的正确描述。陈述 D 不正确，因为它错误地描述了 LR 估计量在光学厚问题中方差的行为。",
            "answer": "$$\\boxed{ABCE}$$"
        },
        {
            "introduction": "理论的价值最终体现在实践和验证中。本练习将理论与编程实践相结合，要求你编写一个程序来计算灵敏度，该程序使用一个与微扰理论紧密相关的伴随加权蒙特卡洛估计量。更重要的是，你将通过与确定论计算结果进行对比来验证你的蒙特卡洛模拟，这是建立对任何复杂模拟代码可信度的关键一步 ()。",
            "id": "4236743",
            "problem": "考虑一个适用于核反应堆模拟的一维平板模型。设空间变量为无量纲，并限定在区间 $x \\in [0,1]$ 内。正向中子扩散问题由方程 $-D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S(x)$ 及边界条件 $\\phi(0) = 0$ 和 $\\phi(1) = 0$ 定义，其中 $D  0$ 是扩散系数，$\\Sigma_a  0$ 是吸收系数，$S(x)$ 是给定的中子源，$\\phi(x)$ 是标量通量。定义响应泛函为 $R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx$（以无量纲单位表示）。\n\n您的任务是利用蒙特卡洛微扰理论的第一性原理，推导并实现一个针对吸收系数微小扰动 $\\delta \\Sigma_a(x)$ 的伴随加权灵敏度估计量。该估计量必须与针对同一模型的确定性伴随计算结果进行比较。请从以下基本原理出发：\n\n- 标量通量的正向扩散算子 $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$，在 $[0,1]$ 上具有齐次狄利克雷边界条件。\n- 由伴随算子 $A^\\dagger$ 作用于伴随通量 $\\psi^\\dagger(x)$ 所定义的伴随问题，该伴随通量对应于响应泛函 $R[\\phi]$，且具有相同类型的边界条件。\n- 响应变化与算子变分的伴随加权相互作用之间的一阶微扰理论关系，以在 $[0,1]$ 上的内积形式表示。\n\n构建一个程序，该程序能够：\n1. 对常数源 $S(x) = S_0$ 和常数系数 $D$ 和 $\\Sigma_a$ 求解正向问题，以获得 $\\phi(x)$。\n2. 在相同的域和边界条件下求解伴随问题，以获得 $\\psi^\\dagger(x)$。\n3. 使用基于伴随的微扰框架，计算对 $\\delta \\Sigma_a(x)$ 的确定性一阶灵敏度。\n4. 通过在 $x \\in [0,1]$ 上抽样并应用从第一性原理推导出的伴随加权估计量，计算相同灵敏度的蒙特卡洛估计值。在 $[0,1]$ 上使用均匀抽样，并以无量纲单位表示所有量。\n5. 使用定义为 $|S_{\\text{MC}} - S_{\\text{DET}}| / |S_{\\text{DET}}|$ 的相对差异，比较蒙特卡洛估计值和基于确定性伴随的结果，并为每个测试用例返回一个布尔值，指示相对差异是否小于指定的容差。\n\n使用以下测试套件，所有参数均以无量纲单位表示：\n- 测试用例 1：$D = 0.2$，$\\Sigma_a = 0.5$，$S_0 = 1.0$，$\\delta \\Sigma_a(x) = 0.05$，对于所有 $x \\in [0,1]$。\n- 测试用例 2：$D = 0.2$，$\\Sigma_a = 0.5$，$S_0 = 1.0$，对于 $x \\in [0.4, 0.6]$，$\\delta \\Sigma_a(x) = 0.1$，其他地方 $\\delta \\Sigma_a(x) = 0$。\n- 测试用例 3：$D = 0.3$，$\\Sigma_a = 0.01$，$S_0 = 1.0$，$\\delta \\Sigma_a(x) = 0.02$，对于所有 $x \\in [0,1]$。\n- 测试用例 4：$D = 0.05$，$\\Sigma_a = 2.0$，$S_0 = 1.0$，$\\delta \\Sigma_a(x) = -0.02$，对于所有 $x \\in [0,1]$。\n\n蒙特卡洛抽样细节：\n- 对每个测试用例，在 $[0,1]$ 上使用 $N = 500000$ 个独立的 $x$ 均匀样本。\n- 使用在精细空间网格上的确定性数值积分来计算基于伴随的灵敏度，以供比较。\n\n验收标准：\n- 对每个测试用例，如果相对差异小于 $0.01$，则生成布尔值 $true$，否则生成 $false$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，“[true,false,true,false]”），列表中的每个条目按上面列出的顺序对应于各个测试用例。所有值都应为指定的无量纲浮点数或布尔值；输出中不使用任何物理单位。",
            "solution": "该问题已经过验证并确认为有效。它在科学上基于核反应堆物理学的既定原理，具体来说是一维中子扩散理论和一阶微扰理论。该问题是适定的，具有足够的信息和一致的条件来推导出唯一且有意义的解。\n\n任务是推导并实现一个伴随加权的蒙特卡洛估计量，用于计算响应泛函对吸收截面扰动的灵敏度，并将其与确定性计算进行比较。该过程涉及多个步骤，基于微分方程和微扰理论的原理。\n\n### 1. 正向问题及其解\n\n该物理系统由无量纲宽度为 1 的平板中的标量通量 $\\phi(x)$ 的一维单群中子扩散方程描述：\n$$ -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi = S_0, \\quad x \\in (0, 1) $$\n边界条件为齐次狄利克雷条件 $\\phi(0) = 0$ 和 $\\phi(1) = 0$。参数 $D$、$\\Sigma_a$ 和 $S_0$ 是正常数。\n\n这是一个二阶线性常系数常微分方程。其解可以通过将一个特解与齐次方程的通解相结合来找到。\n设 $k^2 = \\Sigma_a / D$。方程可以写为 $\\phi''(x) - k^2 \\phi(x) = -S_0/D$。\n一个特解是 $\\phi_p(x) = S_0 / \\Sigma_a$。\n齐次解是 $\\phi_h(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx)$。\n通解是 $\\phi(x) = C_1 \\cosh(kx) + C_2 \\sinh(kx) + S_0 / \\Sigma_a$。\n\n应用边界条件求出常数 $C_1$ 和 $C_2$，得到一个可以表示为对称形式的解：\n$$ \\phi(x) = \\frac{S_0}{\\Sigma_a} \\left( 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} \\right) $$\n其中 $k = \\sqrt{\\Sigma_a / D}$。这个正向通量的解析表达式将用于后续计算。\n\n### 2. 伴随问题及其解\n\n伴随问题对于高效计算响应泛函的灵敏度是必要的。响应泛函由下式给出：\n$$ R[\\phi] = \\int_0^1 \\Sigma_a \\phi(x) \\, dx $$\n这是通量 $\\phi$ 的一个线性泛函。在内积表示法 $\\langle f, g \\rangle = \\int_0^1 f(x)g(x)dx$ 中，响应为 $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$。\n\n伴随方程定义为 $A^\\dagger \\psi^\\dagger = S^\\dagger$，其中 $A^\\dagger$ 是正向算子 $A[\\phi] = -D \\frac{d^2 \\phi}{dx^2} + \\Sigma_a \\phi$ 的伴随算子，$S^\\dagger$ 是伴随源。伴随算子 $A^\\dagger$ 通过关系式 $\\langle \\psi^\\dagger, A\\phi \\rangle = \\langle A^\\dagger\\psi^\\dagger, \\phi \\rangle$ 求得。对于给定的算子以及施加在 $\\phi$ 和 $\\psi^\\dagger$ 上的齐次狄利克雷边界条件，该算子是自伴随的，即 $A^\\dagger = A$。\n\n伴随源 $S^\\dagger$ 是响应泛函的核。对于 $R[\\phi] = \\langle \\Sigma_a, \\phi \\rangle$，伴随源是 $S^\\dagger(x) = \\Sigma_a$。\n\n因此，伴随通量 $\\psi^\\dagger(x)$ 的伴随问题是：\n$$ -D \\frac{d^2 \\psi^\\dagger}{dx^2} + \\Sigma_a \\psi^\\dagger = \\Sigma_a, \\quad x \\in (0, 1) $$\n边界条件为 $\\psi^\\dagger(0) = 0$ 和 $\\psi^\\dagger(1) = 0$。\n\n该方程在结构上与正向问题相同，只是源项 $S_0$ 被替换为 $\\Sigma_a$。通过观察，一个特解是 $\\psi^\\dagger_p(x)=1$。遵循与求解正向通量相同的求解过程，我们得到伴随通量的解析解：\n$$ \\psi^\\dagger(x) = 1 - \\frac{\\cosh(k(x - 1/2))}{\\cosh(k/2)} $$\n其中 $k$ 与正向问题中的相同。\n\n### 3. 一阶微扰理论和确定性灵敏度\n\n我们关心的是由吸收截面的微小扰动 $\\Sigma_a \\rightarrow \\Sigma_a + \\delta\\Sigma_a(x)$ 引起的响应的一阶变化 $\\delta R$。这个扰动同时影响算子 $A$ 和响应泛函 $R$。\n扰动后的算子是 $A' = A + \\delta A$，其中 $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$。\n扰动后的响应泛函是 $R'[\\phi'] = \\int_0^1 (\\Sigma_a + \\delta\\Sigma_a)\\phi' dx$，其中 $\\phi'$ 是扰动后的通量。\n\n一阶变化 $\\delta R$ 由下式给出：\n$$ \\delta R = R'[\\phi'] - R[\\phi] \\approx \\underbrace{\\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx}_{\\text{Direct Effect}} + \\underbrace{\\int_0^1 \\Sigma_a \\delta\\phi(x) \\, dx}_{\\text{Indirect Effect}} $$\n其中 $\\delta\\phi = \\phi' - \\phi$。\n间接效应可以使用伴随通量来评估。根据一阶微扰理论，$A\\delta\\phi \\approx -\\delta A \\phi$。\n$$ \\text{Indirect Effect} = \\langle \\Sigma_a, \\delta\\phi \\rangle = \\langle S^\\dagger, \\delta\\phi \\rangle = \\langle A^\\dagger \\psi^\\dagger, \\delta\\phi \\rangle = \\langle \\psi^\\dagger, A \\delta\\phi \\rangle \\approx \\langle \\psi^\\dagger, -\\delta A \\phi \\rangle $$\n代入 $\\delta A[\\phi] = \\delta\\Sigma_a(x)\\phi(x)$，间接效应变为 $-\\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx$。\n\n结合直接和间接效应，我们记为 $S_{DET}$ 的总灵敏度为：\n$$ S_{DET} = \\delta R \\approx \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) \\, dx - \\int_0^1 \\psi^\\dagger(x) \\delta\\Sigma_a(x) \\phi(x) \\, dx $$\n$$ S_{DET} = \\int_0^1 \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x)) \\, dx $$\n此积分将使用推导出的 $\\phi(x)$ 和 $\\psi^\\dagger(x)$ 的解析表达式进行高精度数值计算，以作为确定性参考值。\n\n### 4. 蒙特卡洛灵敏度估计量\n\n$S_{DET}$ 的积分可以使用蒙特卡洛方法进行估计。问题指定从区间 $[0, 1]$ 中均匀抽样空间变量 $x$。设被积函数为 $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$。\n该积分为 $S_{DET} = \\int_0^1 I(x) \\, dx$。\n\n对于从均匀分布 $U(0, 1)$（其在 $[0, 1]$ 上的概率密度函数为 $p(x) = 1$）中抽取的 $N$ 个独立样本 $\\{x_i\\}_{i=1}^N$，该积分的蒙特卡洛估计量为被积函数的样本均值：\n$$ S_{MC} = \\frac{1}{N} \\sum_{i=1}^{N} I(x_i) = \\frac{1}{N} \\sum_{i=1}^{N} \\delta\\Sigma_a(x_i) \\phi(x_i) (1 - \\psi^\\dagger(x_i)) $$\n这就是问题所要求的“伴随加权灵敏度估计量”。项 $\\phi(x_i) (1 - \\psi^\\dagger(x_i))$ 表示在位置 $x_i$ 的扰动对灵敏度的贡献，该贡献由该点的正向和伴随通量加权。\n\n### 5. 计算流程\n\n对于每个测试用例，执行以下流程：\n1.  定义物理参数 $D$, $\\Sigma_a$, $S_0$ 和扰动函数 $\\delta\\Sigma_a(x)$。\n2.  基于这些参数定义正向通量 $\\phi(x)$ 和伴随通量 $\\psi^\\dagger(x)$ 的解析函数。\n3.  通过在域 $[0, 1]$（或 $\\delta\\Sigma_a(x) \\neq 0$ 的相关子域）上对被积函数 $I(x) = \\delta\\Sigma_a(x) \\phi(x) (1 - \\psi^\\dagger(x))$ 进行数值积分，计算确定性灵敏度 $S_{DET}$。\n4.  通过在 $[0, 1]$ 中生成 $N = 500000$ 个 $x$ 的均匀随机样本，对每个样本评估 $I(x)$，并计算平均值，来计算蒙特卡洛估计值 $S_{MC}$。\n5.  计算相对差异 $RelDiff = |S_{MC} - S_{DET}| / |S_{DET}|$。\n6.  将相对差异与 $0.01$ 的容差进行比较。如果 $RelDiff  0.01$，则该测试用例的结果为 `true`，否则为 `false`。\n对所有指定的测试用例重复此流程，并收集布尔结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Solves the problem of comparing deterministic and Monte Carlo sensitivity\n    calculations for a 1D neutron diffusion problem.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.05,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.05, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.2, 'Sigma_a': 0.5, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.1 if 0.4 = x = 0.6 else 0.0,\n            'delta_Sigma_a_info': {'type': 'piecewise', 'val': 0.1, 'range': (0.4, 0.6)}\n        },\n        {\n            'D': 0.3, 'Sigma_a': 0.01, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: 0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': 0.02, 'range': (0.0, 1.0)}\n        },\n        {\n            'D': 0.05, 'Sigma_a': 2.0, 'S0': 1.0,\n            'delta_Sigma_a_func': lambda x: -0.02,\n            'delta_Sigma_a_info': {'type': 'const', 'val': -0.02, 'range': (0.0, 1.0)}\n        },\n    ]\n\n    N_samples = 500000\n    tolerance = 0.01\n    results = []\n    \n    # Set a seed for reproducibility of Monte Carlo results\n    np.random.seed(0)\n\n    for case in test_cases:\n        D = case['D']\n        Sigma_a = case['Sigma_a']\n        S0 = case['S0']\n        delta_Sigma_a_func = case['delta_Sigma_a_func']\n        delta_Sigma_a_info = case['delta_Sigma_a_info']\n\n        k = np.sqrt(Sigma_a / D)\n        cosh_k_half = np.cosh(k / 2.0)\n\n        # Analytic forward flux phi(x)\n        def phi(x):\n            return (S0 / Sigma_a) * (1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half)\n\n        # Analytic adjoint flux psi_dagger(x)\n        def psi_dagger(x):\n            return 1.0 - np.cosh(k * (x - 0.5)) / cosh_k_half\n\n        # Integrand for sensitivity calculation\n        def integrand(x):\n            return delta_Sigma_a_func(x) * phi(x) * (1.0 - psi_dagger(x))\n\n        # 1. Deterministic sensitivity calculation using numerical integration\n        # The integral is non-zero only where delta_Sigma_a is non-zero.\n        integration_range = delta_Sigma_a_info['range']\n        s_det, _ = integrate.quad(integrand, integration_range[0], integration_range[1])\n\n        # 2. Monte Carlo sensitivity calculation\n        # Generate uniform random samples for x in [0, 1]\n        x_samples = np.random.uniform(0.0, 1.0, N_samples)\n        \n        # Evaluate the integrand at sample points\n        # Use vectorized operations for efficiency\n        delta_vals = np.zeros(N_samples)\n        if delta_Sigma_a_info['type'] == 'const':\n            delta_vals[:] = delta_Sigma_a_info['val']\n        elif delta_Sigma_a_info['type'] == 'piecewise':\n            low, high = delta_Sigma_a_info['range']\n            mask = (x_samples = low)  (x_samples = high)\n            delta_vals[mask] = delta_Sigma_a_info['val']\n        \n        integrand_samples = delta_vals * phi(x_samples) * (1.0 - psi_dagger(x_samples))\n\n        # The MC estimate is the mean of the integrand values,\n        # since the integral is over a domain of length 1.\n        s_mc = np.mean(integrand_samples)\n        \n        # 3. Comparison\n        if s_det != 0:\n            relative_difference = np.abs(s_mc - s_det) / np.abs(s_det)\n        else: # Should not happen in these test cases\n            relative_difference = 0.0 if s_mc == 0.0 else float('inf')\n\n        is_within_tolerance = relative_difference  tolerance\n        results.append(str(is_within_tolerance).lower())\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}