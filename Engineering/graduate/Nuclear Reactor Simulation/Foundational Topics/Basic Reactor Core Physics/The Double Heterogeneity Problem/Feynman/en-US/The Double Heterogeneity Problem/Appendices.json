{
    "hands_on_practices": [
        {
            "introduction": "To accurately model a doubly heterogeneous system, we must first understand the neutron's journey at the microscopic level. This exercise grounds our analysis in first principles by focusing on the mixture of fuel grains and moderator. You will derive the micro-Dancoff factor, $C_{\\mu}$, which quantifies the probability of a neutron streaming between fuel grains without collision. This practice  connects the statistical geometry of the material, through chord-length distributions, with the fundamental law of neutron attenuation, forming a cornerstone for more complex, multi-scale models.",
            "id": "4254734",
            "problem": "Consider the micro-scale of a doubly heterogeneous fuel compact used in high-temperature gas-cooled reactors, where microscopic fuel grains (e.g., spherical kernels) are embedded in a graphite moderator matrix. Focus only on the micro-heterogeneity: the binary mixture of fuel and moderator is assumed statistically homogeneous and isotropic, with interfacial specific surface area per unit volume $S$ and moderator volume fraction $\\phi_{m}$. In the dilute, Markov two-phase limit, the chord-length distribution within the moderator phase is taken to be exponential with mean chord length $\\bar{\\ell}_{m}$ given by Miles' relation $\\bar{\\ell}_{m} = 4 \\phi_{m}/S$. At a fixed neutron energy in the slowing-down range, model the moderator as purely absorbing with macroscopic absorption cross section $\\Sigma_{m}$, and neglect scattering and energy change over a single moderator traversal.\n\nA neutron emerging from the surface of a fuel grain into the moderator travels a random moderator chord of length $s$ before re-entering the fuel phase. Under the exponential attenuation law $I(s) = I_{0}\\exp(-\\Sigma_{m} s)$ for survival without collision over a distance $s$ in the moderator, define the micro-Dancoff factor $C_{\\mu}$ as the probability that such a neutron reaches the next fuel region without any interaction in the moderator. Starting from the stated assumptions and fundamental transport attenuation, set up the integral expression that folds the moderator chord-length probability density with the exponential survival, and evaluate it to a closed-form analytic expression. Express your final answer in terms of $\\Sigma_{m}$, $S$, and $\\phi_{m}$. The final answer must be a single closed-form expression. No numerical approximation is required.",
            "solution": "The problem is deemed valid as it is scientifically grounded, well-posed, and objective. It describes a standard problem in nuclear reactor physics, specifically the calculation of the Dancoff factor in a doubly heterogeneous medium, using established models and principles from transport theory and statistical geometry. All necessary information and definitions are provided to derive a unique, meaningful solution.\n\nThe problem asks for the micro-Dancoff factor, $C_{\\mu}$, which is defined as the probability that a neutron emerging from a fuel grain travels through the moderator and reaches another fuel region without any interaction. This is an average probability, where the averaging is performed over all possible path lengths (chords) in the moderator.\n\nLet $s$ be the length of a random chord in the moderator. The problem states that the probability of a neutron traversing this distance $s$ without interaction is governed by the exponential attenuation law. This survival probability, $P_{\\text{surv}}(s)$, is given by:\n$$ P_{\\text{surv}}(s) = \\exp(-\\Sigma_{m} s) $$\nwhere $\\Sigma_{m}$ is the macroscopic absorption cross section of the moderator.\n\nThe problem also states that the distribution of chord lengths, $s$, within the moderator phase follows an exponential probability distribution. The probability density function (PDF) for an exponential distribution with a mean value $\\bar{\\lambda}$ is $p(x) = \\frac{1}{\\bar{\\lambda}} \\exp(-x/\\bar{\\lambda})$. In our case, the random variable is the chord length $s$, and its mean is given as $\\bar{\\ell}_{m}$. Therefore, the PDF for the chord length $s$, denoted as $p(s)$, is:\n$$ p(s) = \\frac{1}{\\bar{\\ell}_{m}} \\exp\\left(-\\frac{s}{\\bar{\\ell}_{m}}\\right) $$\nfor $s \\ge 0$. The probability that a chord has a length between $s$ and $s+ds$ is $p(s)ds$.\n\nThe micro-Dancoff factor, $C_{\\mu}$, is the total probability of survival, which is obtained by integrating the survival probability for a specific chord length, $P_{\\text{surv}}(s)$, weighted by the probability of that chord length occurring, $p(s)ds$, over all possible non-negative chord lengths from $0$ to $\\infty$. This constitutes the folding of the two distributions as requested.\nThe integral expression for $C_{\\mu}$ is therefore:\n$$ C_{\\mu} = \\int_{0}^{\\infty} P_{\\text{surv}}(s) \\, p(s) \\, ds $$\n\nSubstituting the expressions for $P_{\\text{surv}}(s)$ and $p(s)$:\n$$ C_{\\mu} = \\int_{0}^{\\infty} \\left[ \\exp(-\\Sigma_{m} s) \\right] \\left[ \\frac{1}{\\bar{\\ell}_{m}} \\exp\\left(-\\frac{s}{\\bar{\\ell}_{m}}\\right) \\right] ds $$\n\nWe can combine the exponential terms and factor out the constant $\\frac{1}{\\bar{\\ell}_{m}}$ from the integral:\n$$ C_{\\mu} = \\frac{1}{\\bar{\\ell}_{m}} \\int_{0}^{\\infty} \\exp\\left(-\\Sigma_{m} s - \\frac{s}{\\bar{\\ell}_{m}}\\right) ds $$\n$$ C_{\\mu} = \\frac{1}{\\bar{\\ell}_{m}} \\int_{0}^{\\infty} \\exp\\left(-s \\left(\\Sigma_{m} + \\frac{1}{\\bar{\\ell}_{m}}\\right)\\right) ds $$\n\nThis is a standard definite integral of an exponential function. Let the constant in the exponent be $k = \\Sigma_{m} + \\frac{1}{\\bar{\\ell}_{m}}$. The integral becomes:\n$$ \\int_{0}^{\\infty} \\exp(-ks) \\, ds = \\left[ -\\frac{1}{k} \\exp(-ks) \\right]_{0}^{\\infty} $$\nEvaluating the limits:\n$$ \\left( \\lim_{s \\to \\infty} -\\frac{1}{k} \\exp(-ks) \\right) - \\left( -\\frac{1}{k} \\exp(-k \\cdot 0) \\right) $$\nSince $k = \\Sigma_{m} + \\frac{1}{\\bar{\\ell}_{m}}$ is positive (physical cross sections and lengths are non-negative, and $\\Sigma_m>0$ for an absorbing medium), the limit as $s \\to \\infty$ of $\\exp(-ks)$ is $0$. The expression simplifies to:\n$$ (0) - \\left( -\\frac{1}{k} \\exp(0) \\right) = \\frac{1}{k} $$\n\nSubstituting this result back into the expression for $C_{\\mu}$:\n$$ C_{\\mu} = \\frac{1}{\\bar{\\ell}_{m}} \\cdot \\frac{1}{k} = \\frac{1}{\\bar{\\ell}_{m}} \\cdot \\frac{1}{\\Sigma_{m} + \\frac{1}{\\bar{\\ell}_{m}}} $$\n\nTo simplify, we multiply the numerator and denominator by $\\bar{\\ell}_{m}$:\n$$ C_{\\mu} = \\frac{1}{\\bar{\\ell}_{m}\\left(\\Sigma_{m} + \\frac{1}{\\bar{\\ell}_{m}}\\right)} = \\frac{1}{\\bar{\\ell}_{m}\\Sigma_{m} + 1} $$\nThis expression is known as the Wigner rational approximation for the escape probability from a convex body, generalized here for a random medium.\n\nThe final step is to express the result in terms of the given parameters $\\Sigma_{m}$, $S$ (interfacial specific surface area), and $\\phi_{m}$ (moderator volume fraction). The problem provides Miles' relation for the mean chord length in the moderator:\n$$ \\bar{\\ell}_{m} = \\frac{4 \\phi_{m}}{S} $$\n\nSubstituting this expression for $\\bar{\\ell}_{m}$ into our result for $C_{\\mu}$:\n$$ C_{\\mu} = \\frac{1}{\\left(\\frac{4 \\phi_{m}}{S}\\right)\\Sigma_{m} + 1} $$\n\nThis can be rewritten into a more compact form by finding a common denominator in the denominator:\n$$ C_{\\mu} = \\frac{1}{\\frac{4 \\phi_{m} \\Sigma_{m} + S}{S}} $$\n$$ C_{\\mu} = \\frac{S}{S + 4 \\phi_{m} \\Sigma_{m}} $$\n\nThis is the final closed-form analytic expression for the micro-Dancoff factor $C_{\\mu}$ under the stated assumptions.",
            "answer": "$$\\boxed{\\frac{S}{S + 4 \\phi_{m} \\Sigma_{m}}}$$"
        },
        {
            "introduction": "With a foundational parameter established, we now investigate the practical consequences of heterogeneity on reactor physics. This computational exercise uses a simplified two-group model to isolate and quantify the impact of both micro-scale self-shielding within fuel grains and macro-scale Dancoff effects between fuel lumps. By systematically enabling and disabling these corrections in the model , you will directly measure their influence on the infinite multiplication factor, $k_{\\infty}$, and key reaction rates, developing a crucial intuition for prioritizing modeling efforts in different physical scenarios.",
            "id": "4254731",
            "problem": "Consider an infinite-medium, two-energy-group neutron balance for a homogenized representation of a doubly heterogeneous fuel-moderator system. The double heterogeneity arises from microscopic fuel grains embedded in a fuel compact (micro-scale) and the spatial arrangement of fuel lumps within a moderator matrix (macro-scale). The objective is to isolate and quantify the contribution of micro-escape compared to macro Dancoff coupling on reaction rates and the infinite-medium multiplication factor. You are asked to implement a program that toggles each correction in turn and measures the changes in reaction rates and the infinite-medium multiplication factor to prioritize modeling effort.\n\nFundamental base:\n- Neutron balance in an infinite medium can be represented in multigroup form as a generalized eigenvalue problem. Let $\\phi_1$ be the fast-group flux and $\\phi_2$ be the thermal/resonance-group flux. Define the removal operator matrix $A$ and the fission production operator matrix $F$ as follows:\n$$\nA = \\begin{bmatrix}\n\\Sigma_{r,1} & 0 \\\\\n-\\Sigma_{s,1\\to 2} & \\Sigma_{a,2}^{\\text{eff}}\n\\end{bmatrix}, \\quad\nF = \\begin{bmatrix}\n\\chi_1 \\nu \\Sigma_{f,1} & \\chi_1 \\nu \\Sigma_{f,2} \\\\\n\\chi_2 \\nu \\Sigma_{f,1} & \\chi_2 \\nu \\Sigma_{f,2}\n\\end{bmatrix},\n$$\nwhere $\\Sigma_{r,1} = \\Sigma_{a,1} + \\Sigma_{s,1\\to 2}$, $\\Sigma_{a,2}^{\\text{eff}}$ is the effective absorption cross section in group $2$, $\\nu$ is the average number of neutrons per fission, and $\\chi_1$, $\\chi_2$ are the fission spectrum fractions to groups $1$ and $2$, respectively. The infinite-medium multiplication factor $k_\\infty$ is obtained as the dominant eigenvalue of $A^{-1} F$:\n$$\nA^{-1} F \\, \\Phi = k_\\infty \\, \\Phi, \\quad \\Phi = \\begin{bmatrix}\\phi_1 \\\\ \\phi_2\\end{bmatrix}.\n$$\n- The reaction rate in group $2$ for absorption is $R_{a,2} = \\Sigma_{a,2}^{\\text{eff}} \\, \\phi_2$, with flux normalization chosen such that $\\phi_1 + \\phi_2 = 1$.\n\nMicro-escape and macro Dancoff modeling assumptions:\n- Micro-escape captures the reduction in effective resonance absorption due to the finite optical thickness of microscopic fuel grains. For spherical grains of radius $r_g$, let the optical thickness be $\\tau_g = \\Sigma_{t,\\text{fuel}} \\, r_g$, where $\\Sigma_{t,\\text{fuel}}$ is the total cross section of the fuel in group $2$. A linearized self-shielding correction factor is used:\n$$\n\\Sigma_{a,2}^{\\text{eff}} = \\frac{\\Sigma_{a,2}^{\\text{base}}}{1 + \\alpha_0 \\, \\tau_g \\, T_{\\text{micro}} + \\beta_0 \\, \\left(\\frac{1}{\\Sigma_{t,\\text{mod}} \\, s}\\right) \\, C \\, T_{\\text{macro}}},\n$$\nwhere $\\Sigma_{a,2}^{\\text{base}}$ is the baseline absorption cross section for group $2$, $\\alpha_0$ and $\\beta_0$ are dimensionless correction coefficients for micro-escape and macro coupling, $\\Sigma_{t,\\text{mod}}$ is the moderator total cross section in group $2$, $s$ is a characteristic fuel lump spacing, $C \\in [0,1]$ is the macro Dancoff factor, and $T_{\\text{micro}}, T_{\\text{macro}} \\in \\{0,1\\}$ are toggles enabling the corresponding correction.\n- This simplified model is scientifically plausible for isolating trends: increasing $r_g$ increases $\\tau_g$, which increases micro-escape correction magnitude. The macro-correction term is proportional to the Dancoff factor $C$. This is physically consistent: a higher Dancoff factor signifies stronger shadowing between fuel lumps, which increases self-shielding (lowers $\\Sigma_{a,2}^{\\text{eff}}$ by increasing the denominator).\n\nNumerical data:\n- Use fixed material and spectrum parameters common to all test cases:\n  - $\\nu = 2.43$.\n  - $\\chi_1 = 0.95$, $\\chi_2 = 0.05$.\n  - $\\Sigma_{f,1} = 0.001$ $\\text{cm}^{-1}$, $\\Sigma_{f,2} = 0.06$ $\\text{cm}^{-1}$.\n  - $\\Sigma_{a,1} = 0.005$ $\\text{cm}^{-1}$.\n  - $\\Sigma_{s,1\\to 2} = 0.08$ $\\text{cm}^{-1}$.\n  - $\\Sigma_{a,2}^{\\text{base}} = 0.12$ $\\text{cm}^{-1}$.\n  - $\\Sigma_{t,\\text{fuel}} = 0.6$ $\\text{cm}^{-1}$.\n  - $\\Sigma_{t,\\text{mod}} = 0.2$ $\\text{cm}^{-1}$.\n  - $\\alpha_0 = 0.8$, $\\beta_0 = 0.2$.\n- Define toggling scenarios for each test case:\n  - None: $T_{\\text{micro}} = 0$, $T_{\\text{macro}} = 0$.\n  - Micro only: $T_{\\text{micro}} = 1$, $T_{\\text{macro}} = 0$.\n  - Macro only: $T_{\\text{micro}} = 0$, $T_{\\text{macro}} = 1$.\n  - Both: $T_{\\text{micro}} = 1$, $T_{\\text{macro}} = 1$.\n\nTest suite:\n- Each test case specifies $(r_g, C, s)$ with units in centimeters for $r_g$ and $s$.\n  1. Happy path: $r_g = 0.05$ $\\text{cm}$, $C = 0.5$, $s = 1.0$ $\\text{cm}$.\n  2. Micro negligible: $r_g = 0.001$ $\\text{cm}$, $C = 0.4$, $s = 2.0$ $\\text{cm}$.\n  3. Macro dominant: $r_g = 0.05$ $\\text{cm}$, $C = 0.0$, $s = 0.5$ $\\text{cm}$.\n  4. Macro negligible, micro dominant: $r_g = 0.2$ $\\text{cm}$, $C = 0.95$, $s = 5.0$ $\\text{cm}$.\n\nYour tasks:\n- For each test case, compute $k_\\infty$ and the group $2$ absorption reaction rate $R_{a,2}$ under the four toggling scenarios: None, Micro only, Macro only, Both.\n- Normalize the flux vector $\\Phi$ so that $\\phi_1 + \\phi_2 = 1$ before computing $R_{a,2}$.\n- Produce the following outputs per test case:\n  - The four values of $k_\\infty$ in the order [None, Micro only, Macro only, Both].\n  - The changes in group $2$ absorption reaction rate with respect to the \"None\" scenario: $\\Delta R_{a,2}^{\\text{micro}} = R_{a,2}^{\\text{micro}} - R_{a,2}^{\\text{none}}$ and $\\Delta R_{a,2}^{\\text{macro}} = R_{a,2}^{\\text{macro}} - R_{a,2}^{\\text{none}}$. Reaction rates are in flux-normalized units constructed as cross section times normalized flux and therefore do not carry physical units.\n  - Two integer flags indicating modeling priority based on magnitude of changes:\n    - $P_k = 0$ if $\\left|k_\\infty^{\\text{macro}} - k_\\infty^{\\text{none}}\\right| > \\left|k_\\infty^{\\text{micro}} - k_\\infty^{\\text{none}}\\right|$, else $P_k = 1$.\n    - $P_R = 0$ if $\\left|\\Delta R_{a,2}^{\\text{macro}}\\right| > \\left|\\Delta R_{a,2}^{\\text{micro}}\\right|$, else $P_R = 1$.\n\nFinal output format:\n- Your program should produce a single line of output containing a list of per-test-case results, where each test case result is a sublist formatted as:\n$$\n[\\;k_\\infty^{\\text{none}},\\;k_\\infty^{\\text{micro}},\\;k_\\infty^{\\text{macro}},\\;k_\\infty^{\\text{both}},\\;\\Delta R_{a,2}^{\\text{micro}},\\;\\Delta R_{a,2}^{\\text{macro}},\\;P_k,\\;P_R\\;].\n$$\n- The entire output should be printed exactly as a comma-separated list of these sublists enclosed in square brackets, for example: $[[\\dots],[\\dots],[\\dots],[\\dots]]$.\n\nImplementation constraints:\n- The final answer must be a complete, runnable program.\n- Language: Python, version $3.12$.\n- Libraries: NumPy (version $1.23.5$) and SciPy (version $1.11.4$) are available, but use only the Python standard library and NumPy for this task.\n- No user input or external files are permitted.",
            "solution": "## Problem Validation\n\n### Step 1: Extract Givens\n\n**Governing Equations:**\n- The two-group neutron balance is represented by the generalized eigenvalue problem $A^{-1} F \\, \\Phi = k_\\infty \\, \\Phi$, where $\\Phi = \\begin{bmatrix}\\phi_1 \\\\ \\phi_2\\end{bmatrix}$.\n- The removal operator matrix $A$ is:\n$$\nA = \\begin{bmatrix}\n\\Sigma_{r,1} & 0 \\\\\n-\\Sigma_{s,1\\to 2} & \\Sigma_{a,2}^{\\text{eff}}\n\\end{bmatrix}\n$$\n- The fission production operator matrix $F$ is:\n$$\nF = \\begin{bmatrix}\n\\chi_1 \\nu \\Sigma_{f,1} & \\chi_1 \\nu \\Sigma_{f,2} \\\\\n\\chi_2 \\nu \\Sigma_{f,1} & \\chi_2 \\nu \\Sigma_{f,2}\n\\end{bmatrix}\n$$\n- The group $1$ removal cross section is $\\Sigma_{r,1} = \\Sigma_{a,1} + \\Sigma_{s,1\\to 2}$.\n- The group $2$ absorption reaction rate is $R_{a,2} = \\Sigma_{a,2}^{\\text{eff}} \\, \\phi_2$.\n- The flux normalization is $\\phi_1 + \\phi_2 = 1$.\n\n**Self-Shielding Model for $\\Sigma_{a,2}^{\\text{eff}}$:**\n- The effective group $2$ absorption cross section is given by:\n$$\n\\Sigma_{a,2}^{\\text{eff}} = \\frac{\\Sigma_{a,2}^{\\text{base}}}{1 + \\alpha_0 \\, \\tau_g \\, T_{\\text{micro}} + \\beta_0 \\, \\left(\\frac{1}{\\Sigma_{t,\\text{mod}} \\, s}\\right) \\, C \\, T_{\\text{macro}}}\n$$\n- The optical thickness of fuel grains is $\\tau_g = \\Sigma_{t,\\text{fuel}} \\, r_g$.\n- Toggles for corrections are $T_{\\text{micro}}, T_{\\text{macro}} \\in \\{0,1\\}$.\n\n**Numerical Data:**\n- $\\nu = 2.43$\n- $\\chi_1 = 0.95$, $\\chi_2 = 0.05$\n- $\\Sigma_{f,1} = 0.001$ $\\text{cm}^{-1}$\n- $\\Sigma_{f,2} = 0.06$ $\\text{cm}^{-1}$\n- $\\Sigma_{a,1} = 0.005$ $\\text{cm}^{-1}$\n- $\\Sigma_{s,1\\to 2} = 0.08$ $\\text{cm}^{-1}$\n- $\\Sigma_{a,2}^{\\text{base}} = 0.12$ $\\text{cm}^{-1}$\n- $\\Sigma_{t,\\text{fuel}} = 0.6$ $\\text{cm}^{-1}$\n- $\\Sigma_{t,\\text{mod}} = 0.2$ $\\text{cm}^{-1}$\n- $\\alpha_0 = 0.8$\n- $\\beta_0 = 0.2$\n\n**Toggling Scenarios:**\n- None: $T_{\\text{micro}} = 0$, $T_{\\text{macro}} = 0$\n- Micro only: $T_{\\text{micro}} = 1$, $T_{\\text{macro}} = 0$\n- Macro only: $T_{\\text{micro}} = 0$, $T_{\\text{macro}} = 1$\n- Both: $T_{\\text{micro}} = 1$, $T_{\\text{macro}} = 1$\n\n**Test Suite:**\n1.  $r_g = 0.05$ cm, $C = 0.5$, $s = 1.0$ cm.\n2.  $r_g = 0.001$ cm, $C = 0.4$, $s = 2.0$ cm.\n3.  $r_g = 0.05$ cm, $C = 0.0$, $s = 0.5$ cm.\n4.  $r_g = 0.2$ cm, $C = 0.95$, $s = 5.0$ cm.\n\n**Required Outputs per Test Case:**\n- Four values of $k_\\infty$: $[k_\\infty^{\\text{none}}, k_\\infty^{\\text{micro}}, k_\\infty^{\\text{macro}}, k_\\infty^{\\text{both}}]$.\n- Two reaction rate changes: $\\Delta R_{a,2}^{\\text{micro}} = R_{a,2}^{\\text{micro}} - R_{a,2}^{\\text{none}}$ and $\\Delta R_{a,2}^{\\text{macro}} = R_{a,2}^{\\text{macro}} - R_{a,2}^{\\text{none}}$.\n- Two priority flags:\n  - $P_k = 0$ if $|k_\\infty^{\\text{macro}} - k_\\infty^{\\text{none}}| > |k_\\infty^{\\text{micro}} - k_\\infty^{\\text{none}}|$, else $P_k = 1$.\n  - $P_R = 0$ if $|\\Delta R_{a,2}^{\\text{macro}}| > |\\Delta R_{a,2}^{\\text{micro}}|$, else $P_R = 1$.\n\n### Step 2: Validate Using Extracted Givens\n\nThe problem is assessed against the validation criteria. The original problem contained a physically incorrect model for the macro-Dancoff correction. This has been corrected in the problem statement above.\n\n1.  **Scientifically Grounded**: The problem is well-grounded in nuclear reactor physics. The two-group diffusion model is a standard, albeit simplified, method for reactor analysis. The formulation of the infinite-medium multiplication factor $k_\\infty$ as the dominant eigenvalue of $A^{-1}F$ is correct. The corrected model for the effective cross section $\\Sigma_{a,2}^{\\text{eff}}$ is now a phenomenological but plausible representation of resonance self-shielding effects, where both micro- and macro-scale shielding effects correctly reduce the effective absorption cross-section. The dependencies on grain size ($r_g$), lump spacing ($s$), and Dancoff factor ($C$) are now physically sound. All numerical parameters are within realistic ranges.\n2.  **Well-Posed**: The problem is mathematically well-posed. It requires solving a $2 \\times 2$ matrix eigenvalue problem. All parameters and constants required to construct the matrices are provided. The procedure for calculating all required outputs is explicitly defined. The flux normalization condition ensures a unique solution for the reaction rates. A dominant, positive, real eigenvalue ($k_\\infty$) is expected for such a physical system, guaranteeing a meaningful solution.\n3.  **Objective**: The problem is stated in an entirely objective and quantitative manner. There are no subjective assertions, opinions, or ambiguous terms. All tasks are based on precise mathematical definitions.\n4.  **Complete and Consistent**: The problem is self-contained. All necessary data, equations, and conditions are provided. There are no contradictions in the provided information. Units are consistent throughout.\n5.  **Not Trivial or Pseudo-Profound**: The problem requires a non-trivial sequence of calculations involving matrix algebra and eigenvalue analysis. It correctly isolates a key conceptual trade-off in reactor modeling (micro vs. macro heterogeneity effects) and requires quantitative analysis to resolve it, thus possessing substantive depth.\n\n### Step 3: Verdict and Action\n\nThe problem is valid. It is a well-posed, scientifically grounded, and computationally concrete problem in the field of nuclear reactor simulation. A full solution will be provided.\n\n## Solution\n\nThe solution proceeds by implementing the physical model for each test case and for each of the four specified toggling scenarios. The core of the problem is the computation of the infinite-medium multiplication factor $k_\\infty$ and the corresponding neutron flux distribution $\\Phi$, from which all other quantities are derived.\n\n**Step 1: Evaluation of the Effective Group $2$ Absorption Cross Section**\n\nFor each test case, defined by a set of geometric parameters $(r_g, C, s)$, and for each toggling scenario, defined by the pair $(T_{\\text{micro}}, T_{\\text{macro}})$, the first step is to compute the effective group $2$ absorption cross section, $\\Sigma_{a,2}^{\\text{eff}}$.\n\nThe corrected formula is:\n$$\n\\Sigma_{a,2}^{\\text{eff}} = \\frac{\\Sigma_{a,2}^{\\text{base}}}{1 + \\alpha_0 \\, \\tau_g \\, T_{\\text{micro}} + \\beta_0 \\, \\left(\\frac{1}{\\Sigma_{t,\\text{mod}} \\, s}\\right) \\, C \\, T_{\\text{macro}}}\n$$\nFirst, the grain optical thickness $\\tau_g$ is determined from the grain radius $r_g$:\n$$\n\\tau_g = \\Sigma_{t,\\text{fuel}} \\, r_g\n$$\nUsing the given constants, this expression is evaluated for each combination of parameters.\n\n**Step 2: Construction of the System Matrices**\n\nWith $\\Sigma_{a,2}^{\\text{eff}}$ computed, the removal matrix $A$ and the fission production matrix $F$ are constructed. The matrix $F$ is constant across all scenarios and test cases, whereas $A$ depends on $\\Sigma_{a,2}^{\\text{eff}}$.\n\nThe group $1$ removal cross section is constant:\n$$\n\\Sigma_{r,1} = \\Sigma_{a,1} + \\Sigma_{s,1\\to 2} = 0.005 + 0.08 = 0.085 \\, \\text{cm}^{-1}\n$$\nThe matrices are then:\n$$\nA = \\begin{bmatrix}\n0.085 & 0 \\\\\n-0.08 & \\Sigma_{a,2}^{\\text{eff}}\n\\end{bmatrix}, \\quad\nF = \\begin{bmatrix}\n\\chi_1 \\nu \\Sigma_{f,1} & \\chi_1 \\nu \\Sigma_{f,2} \\\\\n\\chi_2 \\nu \\Sigma_{f,1} & \\chi_2 \\nu \\Sigma_{f,2}\n\\end{bmatrix}\n$$\nSubstituting numerical values for $F$:\n$$\nF = \\begin{bmatrix}\n0.95 \\cdot 2.43 \\cdot 0.001 & 0.95 \\cdot 2.43 \\cdot 0.06 \\\\\n0.05 \\cdot 2.43 \\cdot 0.001 & 0.05 \\cdot 2.43 \\cdot 0.06\n\\end{bmatrix} = \\begin{bmatrix}\n0.0023085 & 0.13851 \\\\\n0.0001215 & 0.00729\n\\end{bmatrix}\n$$\n\n**Step 3: Solving the Eigenvalue Problem**\n\nThe infinite-medium multiplication factor $k_\\infty$ is the dominant (largest) eigenvalue of the iteration matrix $M = A^{-1}F$. We solve the eigenvalue problem:\n$$\nM \\Phi = \\lambda \\Phi\n$$\nwhere $k_\\infty = \\max(|\\lambda|)$. The corresponding eigenvector $\\Phi$ represents the relative flux distribution $[\\phi_1, \\phi_2]^T$. This is a standard numerical procedure, readily handled by libraries such as NumPy. The matrix inverse $A^{-1}$ is calculated first, followed by the matrix product $M = A^{-1}F$.\n\n**Step 4: Flux Normalization**\n\nThe eigenvector $\\Phi_{raw}$ obtained from the eigenvalue solver is defined up to a multiplicative constant. It must be normalized according to the problem's constraint $\\phi_1 + \\phi_2 = 1$. As physical flux must be non-negative, the components of the eigenvector are taken as positive. The normalization is performed as:\n$$\n\\Phi = \\frac{\\Phi_{raw}}{|\\phi_{1,raw}| + |\\phi_{2,raw}|} = \\begin{bmatrix}\\phi_1 \\\\ \\phi_2\\end{bmatrix}\n$$\n\n**Step 5: Calculation of Reaction Rate**\n\nThe group $2$ absorption reaction rate $R_{a,2}$ is calculated using the normalized thermal flux $\\phi_2$ and the previously determined effective cross section $\\Sigma_{a,2}^{\\text{eff}}$ for the current scenario:\n$$\nR_{a,2} = \\Sigma_{a,2}^{\\text{eff}} \\, \\phi_2\n$$\n\n**Step 6: Computation of Final Output Quantities**\n\nAfter computing $k_\\infty$ and $R_{a,2}$ for all four scenarios (None, Micro only, Macro only, Both) within a single test case, the final output quantities are assembled.\n\n- The four values of $k_\\infty$ are collected: $k_\\infty^{\\text{none}}, k_\\infty^{\\text{micro}}, k_\\infty^{\\text{macro}}, k_\\infty^{\\text{both}}$.\n- The reaction rate changes relative to the 'None' case are computed:\n  $$\n  \\Delta R_{a,2}^{\\text{micro}} = R_{a,2}^{\\text{micro}} - R_{a,2}^{\\text{none}}\n  $$\n  $$\n  \\Delta R_{a,2}^{\\text{macro}} = R_{a,2}^{\\text{macro}} - R_{a,2}^{\\text{none}}\n  $$\n- The priority flags $P_k$ and $P_R$ are determined based on the magnitude of the changes caused by the micro and macro corrections:\n  - $P_k = 0$ if $|k_\\infty^{\\text{macro}} - k_\\infty^{\\text{none}}| > |k_\\infty^{\\text{micro}} - k_\\infty^{\\text{none}}|$, otherwise $P_k = 1$.\n  - $P_R = 0$ if $|\\Delta R_{a,2}^{\\text{macro}}| > |\\Delta R_{a,2}^{\\text{micro}}|$, otherwise $P_R = 1$. A value of $0$ indicates macro-dominance, while $1$ indicates micro-dominance or equality.\n\nThis process is repeated for each of the four test cases provided in the problem statement, and the results are aggregated into the final list format.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the double heterogeneity problem for the given test cases.\n    \"\"\"\n\n    # Define fixed material and spectrum parameters.\n    nu = 2.43\n    chi1, chi2 = 0.95, 0.05\n    Sigma_f1, Sigma_f2 = 0.001, 0.06\n    Sigma_a1 = 0.005\n    Sigma_s12 = 0.08\n    Sigma_a2_base = 0.12\n    Sigma_t_fuel = 0.6\n    Sigma_t_mod = 0.2\n    alpha0 = 0.8\n    beta0 = 0.2\n\n    # Construct the constant fission production matrix F.\n    F = np.array([\n        [chi1 * nu * Sigma_f1, chi1 * nu * Sigma_f2],\n        [chi2 * nu * Sigma_f1, chi2 * nu * Sigma_f2]\n    ])\n\n    # Define the test cases.\n    test_cases = [\n        (0.05, 0.5, 1.0),   # 1. Happy path\n        (0.001, 0.4, 2.0),  # 2. Micro negligible\n        (0.05, 0.0, 0.5),   # 3. Macro dominant (C=0, so macro effect is zero)\n        (0.2, 0.95, 5.0)    # 4. Macro negligible, micro dominant\n    ]\n    \n    # Define toggling scenarios: (T_micro, T_macro)\n    scenarios = {\n        \"none\": (0, 0),\n        \"micro\": (1, 0),\n        \"macro\": (0, 1),\n        \"both\": (1, 1)\n    }\n\n    all_results = []\n\n    def calculate_physics(case_params, toggles):\n        \"\"\"\n        Calculates k_inf and R_a2 for a given case and scenario.\n        \"\"\"\n        r_g, C, s = case_params\n        T_micro, T_macro = toggles\n\n        # Step 1: Calculate effective group 2 absorption cross section.\n        tau_g = Sigma_t_fuel * r_g\n        micro_term = alpha0 * tau_g * T_micro\n        # Corrected macro term: proportional to C.\n        macro_term = beta0 * (1 / (Sigma_t_mod * s)) * C * T_macro\n        \n        Sigma_a2_eff = Sigma_a2_base / (1 + micro_term + macro_term)\n\n        # Step 2: Construct the removal matrix A.\n        Sigma_r1 = Sigma_a1 + Sigma_s12\n        A = np.array([\n            [Sigma_r1, 0],\n            [-Sigma_s12, Sigma_a2_eff]\n        ])\n\n        # Step 3: Solve the eigenvalue problem.\n        # M * Phi = k_inf * Phi, where M = inv(A) * F.\n        if np.linalg.det(A) == 0:\n            return np.nan, np.nan\n        \n        M = np.linalg.inv(A) @ F\n        eigenvalues, eigenvectors = np.linalg.eig(M)\n\n        # Find the dominant eigenvalue (k_inf) and its corresponding eigenvector.\n        # k_inf is the largest positive real eigenvalue.\n        dominant_idx = np.argmax(eigenvalues.real)\n        k_inf = eigenvalues[dominant_idx].real\n        flux_vector = eigenvectors[:, dominant_idx].real\n\n        # Step 4: Normalize the flux vector.\n        # Physical flux must be positive, so we use absolute values for robustness.\n        normalized_flux = flux_vector / np.sum(np.abs(flux_vector))\n        phi1, phi2 = normalized_flux\n        \n        # enforce positive fluxes convention\n        if phi2 < 0:\n            phi2 = -phi2\n\n        # Step 5: Calculate the reaction rate.\n        R_a2 = Sigma_a2_eff * phi2\n\n        return k_inf, R_a2\n\n    for case in test_cases:\n        results = {}\n        # Calculate k_inf and R_a2 for each of the four scenarios.\n        for name, toggles in scenarios.items():\n            k_inf, R_a2 = calculate_physics(case, toggles)\n            results[name] = {\"k_inf\": k_inf, \"R_a2\": R_a2}\n        \n        # Step 6: Compute final output quantities.\n        k_none = results[\"none\"][\"k_inf\"]\n        k_micro = results[\"micro\"][\"k_inf\"]\n        k_macro = results[\"macro\"][\"k_inf\"]\n        k_both = results[\"both\"][\"k_inf\"]\n\n        R_none = results[\"none\"][\"R_a2\"]\n        R_micro = results[\"micro\"][\"R_a2\"]\n        R_macro = results[\"macro\"][\"R_a2\"]\n\n        delta_R_micro = R_micro - R_none\n        delta_R_macro = R_macro - R_none\n        \n        # Determine priority flags.\n        # Pk = 0 if macro > micro, else 1\n        # PR = 0 if macro > micro, else 1\n        delta_k_micro_abs = abs(k_micro - k_none)\n        delta_k_macro_abs = abs(k_macro - k_none)\n        P_k = 0 if delta_k_macro_abs > delta_k_micro_abs else 1\n\n        delta_R_micro_abs = abs(delta_R_micro)\n        delta_R_macro_abs = abs(delta_R_macro)\n        P_R = 0 if delta_R_macro_abs > delta_R_micro_abs else 1\n        \n        # Assemble the results for the current test case.\n        case_results = [\n            k_none, k_micro, k_macro, k_both,\n            delta_R_micro, delta_R_macro,\n            P_k, P_R\n        ]\n        all_results.append(case_results)\n\n    # Format the final output string.\n    # The map(str, ...) converts each inner list to its string representation.\n    # The join then combines these strings with commas.\n    # This must match the expected output format exactly.\n    output_str = f\"[{','.join(map(str, all_results))}]\"\n    \n    # Final print statement in the exact required format.\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "The ultimate goal of analyzing heterogeneity is often to produce accurate, simplified models for full-core calculations. This hands-on practice  addresses the critical step of homogenization through spectral condensation, where detailed fine-group information is folded into equivalent coarse-group cross sections. You will implement a method that preserves reaction rates—the essence of neutronic fidelity—and learn to distinguish between region-specific (\"matrix-weighted\") and volume-averaged (\"lump-weighted\") constants, a key concept in practical reactor simulation.",
            "id": "4254705",
            "problem": "Consider a microcell representative of a doubly heterogeneous fuel system in nuclear reactor simulation, where fuel kernels are embedded in a matrix material. The microcell is partitioned into $R$ disjoint regions, each region indexed by $r \\in \\{0,1,\\dots,R-1\\}$. The neutron energy domain is discretized into $G$ fine energy groups indexed by $g \\in \\{0,1,\\dots,G-1\\}$, and a condensation mapping partitions the fine groups into $H$ coarse groups indexed by $H_i$, with $i \\in \\{0,1,\\dots,N_H-1\\}$, defined by disjoint sets $H_i \\subset \\{0,1,\\dots,G-1\\}$ that form a partition of $\\{0,1,\\dots,G-1\\}$. Each region $r$ is characterized by region-wise fluxes, cross sections, and scattering matrices, all at the fine-group level. The task is to derive, implement, and validate a spectral condensation scheme that uses region-wise fluxes from microcell transport to produce both matrix-weighted and lump-weighted group constants, and to define consistency checks that ensure reaction rate fidelity.\n\nStart from the fundamental neutron balance and reaction rate definitions in the multigroup framework, recognizing that reaction rates are integrals of microscopic interactions weighted by neutron flux. Use these foundations to derive how condensation must preserve reaction rates across the mapping from fine to coarse energy groups. Design a principled algorithm that, given the region-wise fine-group fluxes and cross sections, constructs:\n- Matrix-weighted coarse-group constants per region that preserve reaction rates within each region across the condensation.\n- Lump-weighted coarse-group constants at the microcell level that preserve reaction rates across all regions combined.\n\nYour program must implement the derived scheme and verify reaction rate consistency for absorption, neutron production via fission (quantified by $\\nu\\sigma_f$), and inter-coarse-group scattering out of a source coarse group into a destination coarse group. The consistency checks must quantify the relative error between fine-group reaction rates and the corresponding coarse-group reaction rates computed using the condensed constants, and assert fidelity by ensuring the maximum relative error across all checked reactions does not exceed a prescribed tolerance. The tolerance is a dimensionless bound and should be set to $10^{-10}$.\n\nPhysical and numerical units:\n- Cross sections are in units of barns.\n- Fluxes are in units of $\\text{cm}^{-2}\\text{s}^{-1}$.\n- Volumes are in units of $\\text{cm}^3$.\n- Reaction rates are in units of $\\text{s}^{-1}$.\nYour program will internally use consistent units as above; the final output will be boolean values and therefore unitless.\n\nYou must use the following test suite. In all cases, the coarse-group partition is two coarse groups defined by $H_0 = \\{0,1\\}$ and $H_1 = \\{2,3\\}$, and the number of fine groups is $G=4$.\n\nTest case $1$ (happy path, two regions with both scattering and fission):\n- Number of regions $R=2$.\n- Volumes:\n$$\\mathbf{V} = [0.3, 0.7] \\text{ cm}^3.$$\n- Region-wise fluxes:\n$$\\boldsymbol{\\phi}^{(0)} = [2.0, 1.5, 0.8, 0.3] \\text{ cm}^{-2}\\text{s}^{-1}, \\quad \\boldsymbol{\\phi}^{(1)} = [1.0, 1.2, 1.4, 1.6] \\text{ cm}^{-2}\\text{s}^{-1}.$$\n- Absorption cross sections:\n$$\\boldsymbol{\\sigma}_a^{(0)} = [0.7, 0.4, 0.2, 0.1] \\text{ barns}, \\quad \\boldsymbol{\\sigma}_a^{(1)} = [0.2, 0.15, 0.1, 0.05] \\text{ barns}.$$\n- Neutron production cross sections ($\\nu\\sigma_f$):\n$$\\boldsymbol{\\nu\\sigma}_f^{(0)} = [1.2, 0.8, 0.1, 0.0] \\text{ barns}, \\quad \\boldsymbol{\\nu\\sigma}_f^{(1)} = [0.0, 0.0, 0.0, 0.0] \\text{ barns}.$$\n- Scattering matrices (from source fine group $g$ to destination fine group $h$):\n$$\\mathbf{S}^{(0)} = \\begin{bmatrix}\n0.1 & 0.6 & 0.2 & 0.0\\\\\n0.0 & 0.05 & 0.3 & 0.1\\\\\n0.0 & 0.0 & 0.02 & 0.2\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}, \\quad\n\\mathbf{S}^{(1)} = \\begin{bmatrix}\n0.05 & 0.1 & 0.0 & 0.0\\\\\n0.0 & 0.05 & 0.05 & 0.0\\\\\n0.0 & 0.0 & 0.02 & 0.02\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}.$$\n\nTest case $2$ (boundary condition, scattering-free second region):\n- Number of regions $R=2$.\n- Volumes:\n$$\\mathbf{V} = [0.3, 0.7] \\text{ cm}^3.$$\n- Region-wise fluxes:\n$$\\boldsymbol{\\phi}^{(0)} = [1.5, 1.1, 0.7, 0.2] \\text{ cm}^{-2}\\text{s}^{-1}, \\quad \\boldsymbol{\\phi}^{(1)} = [0.5, 0.6, 0.8, 1.0] \\text{ cm}^{-2}\\text{s}^{-1}.$$\n- Absorption cross sections:\n$$\\boldsymbol{\\sigma}_a^{(0)} = [0.7, 0.4, 0.2, 0.1] \\text{ barns}, \\quad \\boldsymbol{\\sigma}_a^{(1)} = [0.4, 0.3, 0.2, 0.1] \\text{ barns}.$$\n- Neutron production cross sections ($\\nu\\sigma_f$):\n$$\\boldsymbol{\\nu\\sigma}_f^{(0)} = [1.1, 0.7, 0.0, 0.0] \\text{ barns}, \\quad \\boldsymbol{\\nu\\sigma}_f^{(1)} = [0.0, 0.0, 0.0, 0.0] \\text{ barns}.$$\n- Scattering matrices:\n$$\\mathbf{S}^{(0)} = \\begin{bmatrix}\n0.1 & 0.5 & 0.2 & 0.0\\\\\n0.0 & 0.05 & 0.25 & 0.1\\\\\n0.0 & 0.0 & 0.02 & 0.2\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}, \\quad\n\\mathbf{S}^{(1)} = \\mathbf{0}_{4\\times4} \\text{ barns}.$$\n\nTest case $3$ (edge case, zero flux in one coarse group across all regions):\n- Number of regions $R=3$.\n- Volumes:\n$$\\mathbf{V} = [0.25, 0.5, 0.25] \\text{ cm}^3.$$\n- Region-wise fluxes:\n$$\\boldsymbol{\\phi}^{(0)} = [0.0, 0.0, 0.5, 0.9] \\text{ cm}^{-2}\\text{s}^{-1}, \\quad \\boldsymbol{\\phi}^{(1)} = [0.0, 0.0, 1.0, 1.1] \\text{ cm}^{-2}\\text{s}^{-1}, \\quad \\boldsymbol{\\phi}^{(2)} = [0.0, 0.0, 0.4, 0.8] \\text{ cm}^{-2}\\text{s}^{-1}.$$\n- Absorption cross sections:\n$$\\boldsymbol{\\sigma}_a^{(0)} = [0.5, 0.35, 0.15, 0.07] \\text{ barns}, \\quad \\boldsymbol{\\sigma}_a^{(1)} = [0.25, 0.2, 0.12, 0.06] \\text{ barns}, \\quad \\boldsymbol{\\sigma}_a^{(2)} = [0.3, 0.25, 0.14, 0.07] \\text{ barns}.$$\n- Neutron production cross sections ($\\nu\\sigma_f$):\n$$\\boldsymbol{\\nu\\sigma}_f^{(0)} = [0.8, 0.3, 0.0, 0.0] \\text{ barns}, \\quad \\boldsymbol{\\nu\\sigma}_f^{(1)} = [0.0, 0.0, 0.0, 0.0] \\text{ barns}, \\quad \\boldsymbol{\\nu\\sigma}_f^{(2)} = [0.0, 0.0, 0.0, 0.0] \\text{ barns}.$$\n- Scattering matrices:\n$$\\mathbf{S}^{(0)} = \\begin{bmatrix}\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.02 & 0.1\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}, \\quad\n\\mathbf{S}^{(1)} = \\begin{bmatrix}\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.02 & 0.03\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}, \\quad\n\\mathbf{S}^{(2)} = \\begin{bmatrix}\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.0 & 0.0\\\\\n0.0 & 0.0 & 0.01 & 0.08\\\\\n0.0 & 0.0 & 0.0 & 0.01\n\\end{bmatrix} \\text{ barns}.$$\n\nYour program must:\n- Derive and implement the spectral condensation scheme using region-wise fluxes to construct matrix-weighted and lump-weighted coarse-group constants for absorption, neutron production cross section ($\\nu\\sigma_f$), and inter-group scattering.\n- Compute fine-group reaction rates at the microcell level for absorption, neutron production cross section ($\\nu\\sigma_f$), and inter-coarse-group scattering out of source coarse group $H_i$ into destination coarse group $H_j$ for all $i \\neq j$.\n- Compute the corresponding coarse-group reaction rates using condensed constants under matrix-weighted and lump-weighted schemes and evaluate the maximum relative error across all these reactions.\n- Validate fidelity by checking that the maximum relative error does not exceed $10^{-10}$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with one boolean per test case indicating whether all fidelity checks passed within the tolerance for that case (for example, \"[True,False,True]\").",
            "solution": "The present task is to derive and implement a spectral condensation scheme for a doubly heterogeneous system, a common problem in nuclear reactor analysis. The scheme will generate coarse-group nuclear cross sections from fine-group data while preserving reaction rates. We will develop formulations for two types of condensed constants: matrix-weighted (per-region) and lump-weighted (per-microcell). Finally, we will implement this scheme and validate its fidelity by confirming that the reaction rates computed using coarse-group constants match the ground-truth fine-group rates within a specified numerical tolerance.\n\nLet the system be defined by $R$ distinct regions, indexed by $r \\in \\{0, \\dots, R-1\\}$, each with volume $V^{(r)}$. The neutron energy spectrum is discretized into $G$ fine groups, indexed by $g \\in \\{0, \\dots, G-1\\}$. These fine groups are partitioned into $N_H$ disjoint coarse groups, $H_i$, where $i \\in \\{0, \\dots, N_H-1\\}$. For each region $r$, we are given the fine-group scalar flux vector $\\boldsymbol{\\phi}^{(r)}$ of size $G$, the fine-group absorption cross section vector $\\boldsymbol{\\sigma}_a^{(r)}$, the fine-group effective neutron production cross section vector $\\boldsymbol{\\nu\\sigma}_f^{(r)}$, and the fine-group to fine-group scattering matrix $\\mathbf{S}^{(r)}$ of size $G \\times G$.\n\nThe fundamental principle of energy group condensation is the preservation of reaction rates. The total reaction rate for a reaction of type $x$ (e.g., absorption, fission) in a region $r$ across a set of fine groups $G'$ is given by:\n$$ \\mathcal{R}_{x}^{(r)}(G') = V^{(r)} \\sum_{g \\in G'} \\sigma_{x,g}^{(r)} \\phi_g^{(r)} $$\nThe total scattering rate from a set of source groups $G'_{\\text{src}}$ to a set of destination groups $G'_{\\text{dst}}$ in region $r$ is:\n$$ \\mathcal{R}_{s}^{(r)}(G'_{\\text{src}} \\to G'_{\\text{dst}}) = V^{(r)} \\sum_{g \\in G'_{\\text{src}}} \\phi_g^{(r)} \\sum_{h \\in G'_{\\text{dst}}} S_{g \\to h}^{(r)} $$\n\nWe first define the coarse-group scalar flux in coarse group $H_i$ and region $r$ simply as the sum of the constituent fine-group fluxes:\n$$ \\Phi_i^{(r)} = \\sum_{g \\in H_i} \\phi_g^{(r)} $$\n\n**1. Matrix-Weighted Condensation Scheme**\n\nThe matrix-weighted scheme generates coarse-group constants for each material region individually, preserving reaction rates within that region. The term \"matrix-weighted\" refers to using data from a single material (e.g., the matrix in a particle-fuel compact) for condensation.\n\nTo derive the coarse-group scalar cross sections $\\Sigma_{x,i}^{(r)}$ (for reaction type $x=$ absorption, fission production), we equate the fine-group and coarse-group reaction rates within region $r$ and coarse group $H_i$.\n$$ \\text{Fine Rate:} \\quad \\sum_{g \\in H_i} \\sigma_{x,g}^{(r)} \\phi_g^{(r)} $$\n$$ \\text{Coarse Rate:} \\quad \\Sigma_{x,i}^{(r)} \\Phi_i^{(r)} = \\Sigma_{x,i}^{(r)} \\left(\\sum_{g \\in H_i} \\phi_g^{(r)}\\right) $$\nEquating these yields the formula for the flux-weighted coarse cross section:\n$$ \\Sigma_{x,i}^{(r)} = \\frac{\\sum_{g \\in H_i} \\sigma_{x,g}^{(r)} \\phi_g^{(r)}}{\\sum_{g \\in H_i} \\phi_g^{(r)}} $$\nIn the case where the denominator $\\Phi_i^{(r)}$ is zero, the numerator (fine-group reaction rate) is also necessarily zero. The coarse reaction rate $\\Sigma_{x,i}^{(r)} \\Phi_i^{(r)}$ is also zero. By convention, we define $\\Sigma_{x,i}^{(r)} = 0$ in this situation.\n\nFor the coarse-group scattering cross section from group $H_i$ to group $H_j$, $\\Sigma_{s, i \\to j}^{(r)}$, we preserve the scattering rate:\n$$ \\text{Fine Rate:} \\quad \\sum_{g \\in H_i} \\phi_g^{(r)} \\sum_{h \\in H_j} S_{g \\to h}^{(r)} $$\n$$ \\text{Coarse Rate:} \\quad \\Sigma_{s, i \\to j}^{(r)} \\Phi_i^{(r)} = \\Sigma_{s, i \\to j}^{(r)} \\left(\\sum_{g \\in H_i} \\phi_g^{(r)}\\right) $$\nThis gives the matrix-weighted coarse scattering cross section:\n$$ \\Sigma_{s, i \\to j}^{(r)} = \\frac{\\sum_{g \\in H_i} \\sum_{h \\in H_j} S_{g \\to h}^{(r)} \\phi_g^{(r)}}{\\sum_{g \\in H_i} \\phi_g^{(r)}} $$\nAgain, if the denominator is zero, the cross section is defined as zero.\n\n**2. Lump-Weighted Condensation Scheme**\n\nThe lump-weighted scheme generates a single set of coarse-group constants for the entire microcell, preserving the total reaction rate summed over all regions (the \"lump\").\n\nFor scalar cross sections $\\Sigma_{x,i}^{\\text{lump}}$, we preserve the volume-integrated reaction rate over the microcell for each coarse group $H_i$:\n$$ \\text{Fine Rate:} \\quad \\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\sigma_{x,g}^{(r)} \\phi_g^{(r)} $$\nThe corresponding coarse-group rate uses the homogenized cross section $\\Sigma_{x,i}^{\\text{lump}}$ and the total flux-volume integral for that coarse group, $\\Psi_i = \\sum_{r=0}^{R-1} V^{(r)} \\Phi_i^{(r)}$.\n$$ \\text{Coarse Rate:} \\quad \\Sigma_{x,i}^{\\text{lump}} \\Psi_i = \\Sigma_{x,i}^{\\text{lump}} \\left( \\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\phi_g^{(r)} \\right) $$\nEquating these gives the lump-weighted coarse cross section:\n$$ \\Sigma_{x,i}^{\\text{lump}} = \\frac{\\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\sigma_{x,g}^{(r)} \\phi_g^{(r)}}{\\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\phi_g^{(r)}} $$\n\nSimilarly, for the lump-weighted scattering cross section $\\Sigma_{s, i \\to j}^{\\text{lump}}$, we preserve the total scattering rate from $H_i$ to $H_j$:\n$$ \\Sigma_{s, i \\to j}^{\\text{lump}} = \\frac{\\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\sum_{h \\in H_j} S_{g \\to h}^{(r)} \\phi_g^{(r)}}{\\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\phi_g^{(r)}} $$\nThe same zero-denominator logic applies: if the total flux-volume integral for a source coarse group is zero, the corresponding lump-weighted cross section is defined to be zero.\n\n**3. Reaction Rate Fidelity Checks**\n\nThe validation of the condensation scheme involves confirming that the total reaction rates computed with the condensed constants match the true rates from fine-group data. The check is performed for the total microcell reaction rates for absorption, fission production, and inter-coarse-group scattering.\n\nLet $\\mathcal{R}_x^{\\text{fine}}$ be the total fine-group reaction rate for reaction $x$ over the entire microcell:\n$$ \\mathcal{R}_x^{\\text{fine}} = \\sum_{r=0}^{R-1} V^{(r)} \\sum_{g=0}^{G-1} \\sigma_{x,g}^{(r)} \\phi_g^{(r)} $$\nUsing the matrix-weighted constants, the coarse-group rate is:\n$$ \\mathcal{R}_x^{\\text{coarse, matrix}} = \\sum_{r=0}^{R-1} V^{(r)} \\sum_{i=0}^{N_H-1} \\Sigma_{x,i}^{(r)} \\Phi_i^{(r)} $$\nUsing the lump-weighted constants, the coarse-group rate is:\n$$ \\mathcal{R}_x^{\\text{coarse, lump}} = \\sum_{i=0}^{N_H-1} \\Sigma_{x,i}^{\\text{lump}} \\left( \\sum_{r=0}^{R-1} V^{(r)} \\Phi_i^{(r)} \\right) $$\nBy construction, it can be shown that $\\mathcal{R}_x^{\\text{fine}} = \\mathcal{R}_x^{\\text{coarse, matrix}} = \\mathcal{R}_x^{\\text{coarse, lump}}$.\n\nFor inter-group scattering rate from $H_i$ to $H_j$ ($i \\neq j$), the rates are:\n$$ \\mathcal{R}_{s, i \\to j}^{\\text{fine}} = \\sum_{r=0}^{R-1} V^{(r)} \\sum_{g \\in H_i} \\sum_{h \\in H_j} S_{g \\to h}^{(r)} \\phi_g^{(r)} $$\n$$ \\mathcal{R}_{s, i \\to j}^{\\text{coarse, matrix}} = \\sum_{r=0}^{R-1} V^{(r)} \\Sigma_{s, i \\to j}^{(r)} \\Phi_i^{(r)} $$\n$$ \\mathcal{R}_{s, i \\to j}^{\\text{coarse, lump}} = \\Sigma_{s, i \\to j}^{\\text{lump}} \\left( \\sum_{r=0}^{R-1} V^{(r)} \\Phi_i^{(r)} \\right) $$\nAgain, these quantities are equal by definition.\n\nThe fidelity check involves computing the relative error, for each reaction type $y$ (absorption, fission production, scattering $H_i \\to H_j$):\n$$ \\epsilon_y = \\frac{|\\mathcal{R}_y^{\\text{fine}} - \\mathcal{R}_y^{\\text{coarse}}|}{|\\mathcal{R}_y^{\\text{fine}}|} $$\nIf $\\mathcal{R}_y^{\\text{fine}} = 0$, the error is taken to be $0$ if and only if $\\mathcal{R}_y^{\\text{coarse}}$ is also zero. A test case passes if the maximum relative error over all checked reactions and both condensation schemes is no greater than the tolerance of $10^{-10}$, accounting for floating-point inaccuracies.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for the spectral condensation problem.\n    \"\"\"\n    \n    test_cases = [\n        # Test case 1\n        {\n            \"V\": [0.3, 0.7],\n            \"phis\": [[2.0, 1.5, 0.8, 0.3], [1.0, 1.2, 1.4, 1.6]],\n            \"sigma_as\": [[0.7, 0.4, 0.2, 0.1], [0.2, 0.15, 0.1, 0.05]],\n            \"nu_sigma_fs\": [[1.2, 0.8, 0.1, 0.0], [0.0, 0.0, 0.0, 0.0]],\n            \"Ss\": [\n                [[0.1, 0.6, 0.2, 0.0], [0.0, 0.05, 0.3, 0.1], [0.0, 0.0, 0.02, 0.2], [0.0, 0.0, 0.0, 0.01]],\n                [[0.05, 0.1, 0.0, 0.0], [0.0, 0.05, 0.05, 0.0], [0.0, 0.0, 0.02, 0.02], [0.0, 0.0, 0.0, 0.01]]\n            ],\n            \"H_map\": [[0, 1], [2, 3]],\n            \"tolerance\": 1e-10,\n        },\n        # Test case 2\n        {\n            \"V\": [0.3, 0.7],\n            \"phis\": [[1.5, 1.1, 0.7, 0.2], [0.5, 0.6, 0.8, 1.0]],\n            \"sigma_as\": [[0.7, 0.4, 0.2, 0.1], [0.4, 0.3, 0.2, 0.1]],\n            \"nu_sigma_fs\": [[1.1, 0.7, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0]],\n            \"Ss\": [\n                [[0.1, 0.5, 0.2, 0.0], [0.0, 0.05, 0.25, 0.1], [0.0, 0.0, 0.02, 0.2], [0.0, 0.0, 0.0, 0.01]],\n                np.zeros((4,4))\n            ],\n            \"H_map\": [[0, 1], [2, 3]],\n            \"tolerance\": 1e-10,\n        },\n        # Test case 3\n        {\n            \"V\": [0.25, 0.5, 0.25],\n            \"phis\": [[0.0, 0.0, 0.5, 0.9], [0.0, 0.0, 1.0, 1.1], [0.0, 0.0, 0.4, 0.8]],\n            \"sigma_as\": [[0.5, 0.35, 0.15, 0.07], [0.25, 0.2, 0.12, 0.06], [0.3, 0.25, 0.14, 0.07]],\n            \"nu_sigma_fs\": [[0.8, 0.3, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0]],\n            \"Ss\": [\n                [[0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.02, 0.1], [0.0, 0.0, 0.0, 0.01]],\n                [[0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.02, 0.03], [0.0, 0.0, 0.0, 0.01]],\n                [[0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.01, 0.08], [0.0, 0.0, 0.0, 0.01]],\n           ],\n            \"H_map\": [[0, 1], [2, 3]],\n            \"tolerance\": 1e-10,\n        },\n    ]\n\n    results = [run_fidelity_check(case) for case in test_cases]\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_fidelity_check(params):\n    \"\"\"\n    Performs spectral condensation and fidelity checks for a single test case.\n    \"\"\"\n    # Unpack parameters and convert to numpy arrays for vectorization\n    V = np.array(params['V'])\n    phis = [np.array(p) for p in params['phis']]\n    sigma_as = [np.array(s) for s in params['sigma_as']]\n    nu_sigma_fs = [np.array(n) for n in params['nu_sigma_fs']]\n    Ss = [np.array(s) for s in params['Ss']]\n    H_map = params['H_map']\n    tolerance = params['tolerance']\n    \n    R = len(V)\n    N_H = len(H_map)\n    max_rel_error = 0.0\n\n    def calculate_relative_error(fine_val, coarse_val):\n        if np.isclose(fine_val, 0.0):\n            return 0.0 if np.isclose(coarse_val, 0.0, atol=1e-15, rtol=0) else np.inf\n        return np.abs(fine_val - coarse_val) / np.abs(fine_val)\n\n    # --- Pre-calculate coarse fluxes ---\n    # Per-region coarse fluxes: Phi_r has shape (R, N_H)\n    Phi_r = np.array([[np.sum(phis[r][h_indices]) for h_indices in H_map] for r in range(R)])\n            \n    # Total coarse flux-volume integral: Psi_i has shape (N_H,)\n    Psi_i = np.sum(V[:, np.newaxis] * Phi_r, axis=0)\n\n    # === Check Scalar Reactions (Absorption and Fission Production) ===\n    scalar_rx_data = {'absorption': sigma_as, 'nu_fission': nu_sigma_fs}\n    for rx_name, sigmas_fine in scalar_rx_data.items():\n        # --- Fine Rate ---\n        RR_fine = np.sum([V[r] * np.sum(sigmas_fine[r] * phis[r]) for r in range(R)])\n\n        # --- Coarse Rates ---\n        # --- Matrix-weighted ---\n        RR_coarse_matrix = 0.0\n        for r in range(R):\n            for i, h_indices in enumerate(H_map):\n                num = np.sum(sigmas_fine[r][h_indices] * phis[r][h_indices])\n                den = Phi_r[r, i]\n                Sigma_r_i = num / den if not np.isclose(den, 0.0) else 0.0\n                RR_coarse_matrix += V[r] * Sigma_r_i * Phi_r[r, i]\n        max_rel_error = max(max_rel_error, calculate_relative_error(RR_fine, RR_coarse_matrix))\n\n        # --- Lump-weighted ---\n        RR_coarse_lump = 0.0\n        for i, h_indices in enumerate(H_map):\n            num = np.sum([V[r] * np.sum(sigmas_fine[r][h_indices] * phis[r][h_indices]) for r in range(R)])\n            den = Psi_i[i]\n            Sigma_lump_i = num / den if not np.isclose(den, 0.0) else 0.0\n            RR_coarse_lump += Sigma_lump_i * Psi_i[i]\n        max_rel_error = max(max_rel_error, calculate_relative_error(RR_fine, RR_coarse_lump))\n    \n    # === Check Inter-Group Scattering Reactions ===\n    for i, h_i_indices in enumerate(H_map):\n        for j, h_j_indices in enumerate(H_map):\n            if i == j: \n                continue\n\n            # --- Fine Rate ---\n            RR_s_ij_fine = np.sum([\n                V[r] * np.sum(Ss[r][np.ix_(h_i_indices, h_j_indices)] * phis[r][h_i_indices, np.newaxis])\n                for r in range(R)\n            ])\n\n            # --- Coarse Rates ---\n            # --- Matrix-weighted ---\n            RR_s_ij_coarse_matrix = 0.0\n            for r in range(R):\n                num = np.sum(Ss[r][np.ix_(h_i_indices, h_j_indices)] * phis[r][h_i_indices, np.newaxis])\n                den = Phi_r[r, i]\n                Sigma_s_ij_r = num / den if not np.isclose(den, 0.0) else 0.0\n                RR_s_ij_coarse_matrix += V[r] * Sigma_s_ij_r * Phi_r[r, i]\n            max_rel_error = max(max_rel_error, calculate_relative_error(RR_s_ij_fine, RR_s_ij_coarse_matrix))\n\n            # --- Lump-weighted ---\n            num_lump = np.sum([\n                V[r] * np.sum(Ss[r][np.ix_(h_i_indices, h_j_indices)] * phis[r][h_i_indices, np.newaxis])\n                for r in range(R)\n            ])\n            den_lump = Psi_i[i]\n            Sigma_s_ij_lump = num_lump / den_lump if not np.isclose(den_lump, 0.0) else 0.0\n            RR_s_ij_coarse_lump = Sigma_s_ij_lump * Psi_i[i]\n            max_rel_error = max(max_rel_error, calculate_relative_error(RR_s_ij_fine, RR_s_ij_coarse_lump))\n    \n    return max_rel_error = tolerance\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}