## 引言
在现代[集成电路](@entry_id:265543)（IC）设计中，布局（Placement）是连接逻辑综合与物理实现的桥梁，是决定芯片最终性能、功耗和面积（PPA）的关键环节。随着芯片规模进入数十亿晶体管的时代，如何将海量的标准单元、宏单元和I/O端口高效地放置在硅片上，成为电子设计自动化（EDA）领域面临的核心挑战之一。一个优秀的布局不仅要最小化总线长以降低延迟和功耗，还必须满足严苛的时序约束，避免物理重叠，并为后续的布线流程留出足够空间。

本文旨在系统性地揭示支撑现代布局工具的三大核心算法：[最小割](@entry_id:1127910)（Min-cut）布局、二次（Quadratic）布局以及先进的解析（Analytical）布局方法。我们将深入探讨这些方法背后的数学原理、优化策略及其在应对真实世界设计复杂性时的演进。通过本文的学习，您将理解这些算法如何将一个看似棘手的[组合优化](@entry_id:264983)问题，转化为可计算、可迭代优化的数学模型，并最终在多个相互冲突的目标之间找到一个可行的最佳平衡点。

在接下来的内容中，我们将从理论到实践。在“原理与机制”部分，我们将奠定基础，详细介绍电路的数学表示方法，并深入剖析[最小割](@entry_id:1127910)、二次和现代[解析布局](@entry_id:1121000)算法的核心思想。在“应用与跨学科连接”部分，我们将视野拓宽至实际工程挑战，探讨如何增强这些算法以处理大规模问题，如何整合物理约束，以及布局如何与时序等其他设计维度相互作用。最后，在“动手实践”部分，您将有机会通过具体的计算练习，亲身体验这些算法的运作方式。

## 原理与机制

在介绍完布局问题的背景和重要性之后，本章将深入探讨几种核心布局算法背后的基本原理与关键机制。我们将从电路网表的数学抽象模型出发，系统性地讲解[最小割](@entry_id:1127910)（Min-cut）布局、二次（Quadratic）布局以及现代解析（Analytical）布局方法。这些方法虽然在策略上有所不同，但共同构成了现代电子设计自动化（EDA）中物理设计流程的基石。

### 基础模型：网表与几何的数学表示

任何计算性布局算法的第一步都是将物理电路的描述转化为严谨的数学模型。这主要涉及两个方面：连接性（拓扑）的表示和物理几何的表示。

#### 网表[超图表示](@entry_id:1126295)

一个电路网表描述了大量模块（或标准单元）以及连接它们引脚（pin）的导线（net）。为了对连接关系进行建模，最自然的方式是使用**[超图](@entry_id:270943)（hypergraph）** $H=(V, E)$。

-   **顶点 (Vertices, V)**：在以模块为单位进行布局的场景中，[超图](@entry_id:270943)的每个顶点 $v_i$ 代表一个可移动的模块 $i$。因此，顶点集合为 $V=\{v_1, v_2, \dots, v_n\}$，其中 $n$ 是模块总数。

-   **超边 (Hyperedges, E)**：每条导线（net）连接了两个或多个引脚，这些引脚可能分布在不同的模块上。一条导线自然地对应于一条超边。超边是顶点集的一个子集。如果导线 $e$ 连接到了模块 $i$ 上的任意一个或多个引脚，那么顶点 $v_i$ 就属于超边 $e$。即使一条导线连接到同一个模块的多个引脚，在模块级别的超图中，该模块也只在对应的超边中出现一次。形式上，超边 $e$ 定义为 $e = \{ v_i \in V \mid \text{导线 } e \text{ 连接到模块 } i \text{ 的至少一个引脚} \}$。此外，每条导线通常会根据其时序关键性等因素被赋予一个权重 $w_e$，这个权重也自然地成为了对应超边的权重 。

这种以模块为顶点的[超图](@entry_id:270943)模型是分割式和分析式布局算法的标准出发点，因为它直接将优化变量（模块的位置）与图的实体对应起来。

#### 几何坐标表示

为了描述模块在版图上的物理位置和方向，我们需要建立一个坐标系统。通常，我们使用一个全局的二维[笛卡尔坐标系](@entry_id:169789)。每个模块 $i$ 的位置由其**锚点（anchor point）** 的全局坐标 $\mathbf{r}_i = (x_i, y_i)$ 来定义。锚点是模块内部定义的一个参考点，例如其几何中心。

模块上的引脚位置则是在模块的[局部坐标系](@entry_id:751394)中通过**局部偏移向量（local offset vector）** $\mathbf{p}_{i\alpha}$ 定义的，该[向量表示](@entry_id:166424)引脚 $\alpha$ 相对于模块锚点的位置。

模块不仅可以平移，还可以旋转和翻转。这些操作统称为**[刚体变换](@entry_id:150396)（rigid body motion）**。在[集成电路布局](@entry_id:1126553)中，通常只允许**曼哈顿[等距同构](@entry_id:273188)（Manhattan isometries）**，即以90度为增量的旋转和关于坐标轴的翻转。每种合法的朝向 $o_i$ 都可以由一个[正交矩阵](@entry_id:169220) $Q(o_i)$ 来表示。

要计算一个引脚 $(i, \alpha)$ 在版图上的绝对坐标 $\mathbf{x}_{i\alpha}$，我们需要首先将它的局部偏移向量 $\mathbf{p}_{i\alpha}$ 根据模块的朝向 $o_i$进行旋转/翻转，然后再将结果平移到模块锚点的全局位置 $\mathbf{r}_i$。这个变换过程可以表示为：
$$
\mathbf{x}_{i\alpha} = \mathbf{r}_i + Q(o_i)\mathbf{p}_{i\alpha}
$$
。例如，如果一个模块绕其锚点逆时针旋转角度 $\theta_i$，其对应的[旋转矩阵](@entry_id:140302)为：
$$
Q(o_i) = R(\theta_i) = \begin{pmatrix} \cos(\theta_i)  -\sin(\theta_i) \\ \sin(\theta_i)  \cos(\theta_i) \end{pmatrix}
$$
若引脚的局部偏移为 $(\delta x_{i\alpha}, \delta y_{i\alpha})$，模块锚点位置为 $(X_i, Y_i)$，则其绝对坐标 $(x_{i\alpha}, y_{i\alpha})$ 为：
$$
x_{i\alpha} = X_i + \delta x_{i\alpha} \cos(\theta_i) - \delta y_{i\alpha} \sin(\theta_i)
$$
$$
y_{i\alpha} = Y_i + \delta x_{i\alpha} \sin(\theta_i) + \delta y_{i\alpha} \cos(\theta_i)
$$
。这个坐标变换公式是所有分析式布局方法计算线长目标函数的基础。

### [最小割布局](@entry_id:1127911)（Min-Cut Placement）

[最小割布局](@entry_id:1127911)是一种经典的“[分而治之](@entry_id:273215)”策略。其核心思想是，首先将所有模块（以及它们所占的版图区域）一分为二，然后对每个子区域和[子网](@entry_id:156282)表递归地进行分割，直到每个区域内的模块数量足够少，可以进行详细布局。

#### 分割与切割度量

在每一次分割中，算法将模块集合 $V$ 划分为两个不相交的子集 $S$ 和 $\bar{S}$（即 $V$ 的一个**二分（bipartition）**）。理想的分割应该使得跨越两个分区之间的连线数量尽可能少，因为这些连线通常会更长，并占用宝贵的布线资源。这个“跨越分区的连线数量”就是通过**切割度量（cut metric）**来量化的。

考虑一条超边（导线）$e$，它在分区 $S$ 中的引脚（更准确地说是模块）数量为 $|e \cap S|$，在 $\bar{S}$ 中的数量为 $|e \cap \bar{S}|$。当且仅当一条导线同时连接了两个分区中的模块，即 $|e \cap S| \ge 1$ 且 $|e \cap \bar{S}| \ge 1$ 时，我们称这条导线被**切割（cut）**。

最基本和直观的切割度量是**切割导线数（cut-net metric）**，它简单地计算被切割的导线总数：
$$
C_{\mathrm{cut}}(S) = \sum_{e \in E} \mathbf{1}\big(|e \cap S| \ge 1 \text{ and } |e \cap \bar{S}| \ge 1\big)
$$
其中 $\mathbf{1}(\cdot)$ 是[指示函数](@entry_id:186820)。这个度量等价于**连接性度量（connectivity metric）**，即 $\sum_{e \in E} (\lambda(e) - 1)$，其中 $\lambda(e)$ 是导线 $e$ 接触的分区数量（在此为1或2）。

为了更精细地衡量切割的代价，研究人员提出了其他度量。**引脚求和度量（sum-of-pins metric）** 计算每个被切割的导线中，需要“移动”到另一侧以消除切割的最小引脚数：
$$
C_{\mathrm{sop}}(S) = \sum_{e \in E} \min\big(|e \cap S|, |e \cap \bar{S}|\big)
$$
另一种常见的模型是将每条 $k$ 引脚的超边近似为包含所有 $\binom{k}{2}$ 对引脚连接的**团（clique）**。在此模型下，切割代价为跨越分区的边数：
$$
C_{\mathrm{clique}}(S) = \sum_{e \in E} |e \cap S| \cdot |e \cap \bar{S}|
$$
这些度量之间存在一定的关系，例如 $C_{\mathrm{clique}}(S) \ge C_{\mathrm{sop}}(S) \ge C_{\mathrm{cut}}(S)$。选择哪种度量会影响分割算法（如Fiduccia-Mattheyses算法）的行为和最终的布局质量 。

#### [几何映射](@entry_id:749852)

在网表被分割为两部分（例如，具有总单元面积 $s_1$ 和 $s_2$）之后，必须将它们映射到几何空间。这通常通过将父布局区域沿某一坐标轴切割成两个子区域来实现。

这个过程必须考虑**利用率（utilization）** $u_k$，即单元面积与分配给它的区域面积之比。为了给布线留出空间，利用率通常小于1。因此，面积为 $s_k$ 的分区需要一个面积为 $A_k = s_k / u_k$ 的子区域。父区域的面积必须等于两个子区域所需面[积之和](@entry_id:266697)，即 $W H = A_1 + A_2$。

分割可以是**垂直的**或**水平的**。例如，对于一个宽度为 $W$、高度为 $H$ 的父区域：
-   **垂直分割**：产生两个高度为 $H$ 的子区域，其宽度分别为 $w_k = A_k / H$。
-   **水平分割**：产生两个宽度为 $W$ 的子区域，其高度分别为 $h_k = A_k / W$。

在选择分割方向时，必须满足**高宽比（aspect ratio）** 的约束，即子区域的高度与宽度之比 $\rho$ 必须在指定的范围 $[\rho_{\min}, \rho_{\max}]$ 内。算法会计算两种分割方向下产生的子区域高宽比，并选择一个满足约束的方向。如果两种方向都满足，可以选择其中之一；如果都不满足，则通常选择一个违反约束最小的方向 。这个[几何映射](@entry_id:749852)步骤确保了递归过程中的每个子问题都有一个形状合理的物理区域。

### [二次布局](@entry_id:1130359)（Quadratic Placement）

与分割式方法不同，[二次布局](@entry_id:1130359)将布局问题转化为一个连续的、可解析求解的优化问题。其核心思想是用一个简单的二次函数来近似总线长。

#### 二次线长模型

对于一个连接模块 $i$ 和 $j$ 的双引脚导线，其线长的平方（或相关的能量）可以被建模为一个二次项，就像一个连接它们的弹簧：
$$
E_{ij}(x, y) = w_{ij}((x_i - x_j)^2 + (y_i - y_j)^2)
$$
其中 $w_{ij}$ 是导线的权重（弹簧的劲度系数）。这个模型的美妙之处在于，总线长能量是所有模块坐标的二次函数，其最小化问题有成熟的解决方法。

然而，电路中存在大量多引脚导线（超边）。为了应用二次模型，必须将超边分解为边的集合。
-   **星型模型（Star Model）**：为每条超边 $e$ 引入一个虚拟的[中心点](@entry_id:636820)，其坐标 $(\bar{x}_e, \bar{y}_e)$ 是该超边所有引脚坐标的平均值。然后，线长能量被定义为所有引脚到这个[中心点](@entry_id:636820)的平方距离之和：$E_e = w_e \sum_{i \in e} ((x_i - \bar{x}_e)^2 + (y_i - \bar{y}_e)^2)$。
-   **团模型（Clique Model）**：将一条 $m$ 引脚的超边分解为连接每对引脚的 $\binom{m}{2}$ 条普通边。

一个重要的理论结果是，星型模型在数学上与一个特定的团模型是等价的。如果星型模型中超边的权重为 $w$，那么只要在团模型中，每条边的权重被设置为 $\alpha = w/m$（其中 $m$ 是超边的引脚数），两个模型将产生完全相同的二次能量函数。这为将超图网表转化为适用于二次优化的[加权图](@entry_id:274716)模型提供了坚实的理论基础 。

#### [求解线性系统](@entry_id:146035)

将所有导线的二次能量相加，我们得到整个布局的总能量函数 $\Phi(x, y)$。由于 $x$ 和 $y$ 坐标在能量函数中是[解耦](@entry_id:160890)的，我们可以独立地最小化它们。以 $x$ 坐标为例，总能量可以写成一个二次型：
$$
\Phi_x(x) = x^T L x
$$
其中 $x$ 是所有模块 $x$ 坐标组成的向量，而 $L$ 是一个被称为**图拉普拉斯矩阵（Graph Laplacian）**的特殊矩阵。$L$ 由导线权重构建，其对角元素 $L_{ii}$ 是连接到模块 $i$ 的所有导线权重之和，非对角元素 $L_{ij}$ 是连接模块 $i$ 和 $j$ 的导线权重总和的负值。

最小化 $\Phi_x(x)$ 的条件是其梯度为零，这导出了一个[线性方程组](@entry_id:148943)：
$$
L x = \mathbf{0}
$$
然而，对于一个没有任何外部连接（即“悬浮”）的网表，矩阵 $L$ 是奇异的。它的[零空间](@entry_id:171336)包含了全一向量 $\mathbf{1}$，这意味着可以将所有模块整体平移任意距离而总能量不变，因此解不唯一。

为了得到唯一且有意义的解，我们必须引入**锚点（anchors）**。
-   **固定对象**：在实际电路中，总有一些位置固定的对象，如I/O端口或预先布局好的宏单元。我们可以将[坐标向量](@entry_id:153319) $x$ 分为可移动部分 $x_f$ 和固定部分 $x_p$。通过对二次能量函数求导，最终得到的线性系统只涉及可移动变量 $x_f$：
    $$
    L_{ff}x_f = b_x
    $$
    其中 $L_{ff}$ 是拉普拉斯矩阵对应于可移动模块的子矩阵。右端项 $b_x$ 则是由可移动模块与固定模块之间的连接产生的，可以推导得出 $b_x = W_{fp}x_p$，其中 $W_{fp}$ 是连接可移动与固定模块的权重矩阵 。
-   **软锚点**：另一种方法是添加“软锚点”，即用非常弱的弹簧将每个（或部分）模块连接到版图上的某个期望位置（例如，均匀分布的格点）。这相当于在能量函数中加入了类似 $E_{\text{anchor}} = \frac{1}{2}a_i(x_i - g_i)^2$ 的项，其中 $a_i$ 是锚点弹簧的劲度。只要至少有一个模块被锚定（即至少有一个 $a_i  0$），系统矩阵就会变为非奇异的（更准确地说是对称正定），从而保证[解的唯一性](@entry_id:143619) 。

### 现代解析式布局

[二次布局](@entry_id:1130359)方法虽然优雅，但其模型过于简化，导致了两个主要问题：线长模型不准确和单元严重重叠。现代解析式布局通过引入更复杂的模型和技术来解决这些问题，将问题转化为一个[非线性优化](@entry_id:143978)任务。

#### 更精确的线长模型：平滑的HPWL

业界标准的线长度量是**[半周长线长](@entry_id:1125886)（Half-Perimeter Wirelength, HPWL）**，即包围一条导线所有引脚的最小[边界框](@entry_id:635282)（bounding box）的半[周长](@entry_id:263239)。对于一条导线，其HPWL为 $(\max_i x_i - \min_i x_i) + (\max_i y_i - \min_i y_i)$。与二次模型相比，HPWL对长线的惩罚较小，更符合实际的布线代价。例如，在一个随机扰动模型下，为了使二次模型的[期望值](@entry_id:150961)与HPWL的[期望值](@entry_id:150961)相匹配，二次项的权重必须与扰动的大小成反比，这说明了二次模型内在的偏差 。

HPWL的主要缺点是其包含的 $\max$ 和 $\min$ 函数是**不可微的**，这使得基于梯度的优化方法难以应用。现代解析式布局通过一个精巧的数学工具来解决此问题：**log-sum-exp (LSE)** 函数。LSE函数通过一个“温度”参数 $\tau$ 来平滑地逼近 $\max$ 函数：
$$
\text{smax}(\{x_i\}, \tau) = \tau \ln\left( \sum_{i=1}^{n} \exp\left(\frac{x_i}{\tau}\right) \right)
$$
当 $\tau \to 0^+$ 时，这个函数收敛到真实的 $\max\{x_i\}$。利用恒等式 $\min\{x_i\} = -\max\{-x_i\}$，我们也可以构造出 $\min$ 函数的光滑近似。将这两者结合，便得到了一个处处可微的HPWL近似函数，从而可以应用梯度下降等[非线性优化](@entry_id:143978)算法 。

#### 密度管理与单元重叠消除

单纯最小化线长（无论是二次模型还是HPWL）的另一个严重后果是，所有相互连接的模块都会被拉到同一个点，导致灾难性的单元重叠。因此，必须在[目标函数](@entry_id:267263)中加入一个**排斥力（spreading force）** 或**密度惩罚项（density penalty）**。

一种常见的方法是在每对模块之间引入一个**[排斥势能](@entry_id:185622)**，当它们靠得太近时，该势能会急剧增加。例如，可以定义一个[势能函数](@entry_id:200753) $g(d) = \beta (d^2 + \epsilon)^{-1}$，其中 $d = x_i - x_j$ 是模块间距，$\beta$ 是排斥强度，$\epsilon$ 是一个小的[平滑参数](@entry_id:897002)以避免除以零。

总的目标函数变为线长项和所有[排斥势能](@entry_id:185622)项之和。由于[排斥势能](@entry_id:185622)是坐标的[非线性](@entry_id:637147)函数，整个布局问题也变成了**[非线性优化](@entry_id:143978)问题**。这类问题通常通过迭代求解，在每一步中，[非线性](@entry_id:637147)函数被局部近似为一个二次函数。排斥力的引入，相当于在系统的Hessian矩阵（二次项系数矩阵）中，除了原有的[图拉普拉斯矩阵](@entry_id:275190) $L$ 外，还增加了一个依赖于当前模块位置的附加项 $H_{\mathrm{rep}}(x)$。系统的**有效拉普拉斯矩阵**变为 $L_{\mathrm{eff}}(x) = L + H_{\mathrm{rep}}(x)$。求解这样的[非线性系统](@entry_id:168347)是现代解析式布局的核心挑战之一 。

#### 求解大规模[线性系统](@entry_id:147850)

无论是求解[二次布局](@entry_id:1130359)的单一线性系统 $Lx=b$，还是在[非线性](@entry_id:637147)布局的每次迭代中求解 $L_{\mathrm{eff}}(x) \Delta x = -\nabla E(x)$，核心计算任务都是求解一个大规模、稀疏、[对称正定](@entry_id:145886)（SPD）的线性方程组。

**共轭梯度法（Conjugate Gradient, CG）** 是解决此类问题的标准[迭代算法](@entry_id:160288)。CG算法的收敛速度主要取决于系统矩阵的**[条件数](@entry_id:145150)（condition number）** $\kappa$，即[最大特征值](@entry_id:1127078)与[最小特征值](@entry_id:177333)之比。条件数越大，收敛越慢。

对于类似芯片的网格状结构，[图拉普拉斯矩阵](@entry_id:275190)的[条件数](@entry_id:145150) $\kappa(L)$ 会随着芯片尺寸 $n$ 的增长而迅速恶化，其增长规模为 $\Theta(n^2)$。这意味着，对于一个 $n \times n$ 的网格，CG的收敛迭代次数将与 $n$ 成正比，即 $O(n)$。在实践中，为了加速收敛，必须使用**预条件（preconditioning）** 技术。即使是简单的对角（Jacobi）预条件，虽然不能改变条件数的[渐近增长](@entry_id:637505)趋势，但也能显著改善常数因子，从而在实际应用中获得可观的加速效果 。

综上所述，从简单的分割和二次模型，到考虑了精确线长和物理密度的复杂非线性模型，布局算法的发展体现了在建模精度和[计算效率](@entry_id:270255)之间不断权衡与创新的过程。