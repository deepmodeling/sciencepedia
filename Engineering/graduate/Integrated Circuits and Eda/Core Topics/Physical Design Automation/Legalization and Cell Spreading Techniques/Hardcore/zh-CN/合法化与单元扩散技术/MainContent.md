## 引言
在集成电路（IC）设计的漫长旅程中，[全局布局](@entry_id:1125677)为数百万个标准单元勾勒出了一幅宏伟蓝图，但这幅蓝图是建立在连续、理想化的坐标空间之上。然而，现实的硅片是一个由离散行和场点构成的严格世界。如何将这种理想化的布局转化为一个无重叠、符合所有物理规则且性能优越的可制造版图？这正是**合法化（Legalization）**与**单元扩展（Cell Spreading）**技术所要解决的核心挑战。这两个步骤不仅是连接抽象概念与物理现实的桥梁，更是决定芯片最终性能、功耗、可布线性乃至可靠性的关键所在。一个糟糕的合法化方案可能会完全摧毁[全局布局](@entry_id:1125677)阶段的优化成果，而无效的单元扩展则可能导致局部拥塞、[IR压降](@entry_id:272464)和热点等致命问题。

为了系统性地掌握这些关键技术，本文将引导您开启一段从理论到实践的[深度学习](@entry_id:142022)之旅。在第一章**“原理和机制”**中，我们将深入剖析合法化的物理约束、评估指标以及驱动单元移动的底层算法。随后的第二章**“应用与跨学科联系”**将通过丰富的实例，展示这些技术如何在复杂的设计场景中发挥作用，并令人惊讶地揭示其与流[体力](@entry_id:174230)学、地球物理学等领域的深刻联系。最后，在第三章**“动手实践”**中，您将通过一系列精心设计的问题，亲手应用所学知识，体验解决真实布局挑战的乐趣与精髓。

## 原理和机制

在[集成电路物理设计](@entry_id:1126338)中，[全局布局](@entry_id:1125677)（Global Placement）阶段的输出是标准单元在二维平面上的连续坐标。这些坐标代表了在线长、时序和拥塞等高级目标下的优化位置。然而，这些理想化的连续坐标在物理上是无法制造的。标准单元必须被放置在离散的、预定义的“合法”位置上，这一过程被称为**合法化（Legalization）**。此外，为了确保后续布线的成功，常常需要主动将单元从高密度区域移到低密度区域，这个过程被称为**单元扩展（Cell Spreading）**。本章将深入探讨合法化和单元扩展的核心原理、关键约束、评估指标以及实现这些目标的算法机制。

### 合法化问题：约束与目标

合法化的首要任务是将每个单元从其连续的[全局布局](@entry_id:1125677)位置“对齐（snap）”到一个有效的物理版图位置，同时满足一系列严格的[设计规则](@entry_id:1123586)。定义什么是“合法”位置是这一过程的起点。

#### 定义合法放置空间

标准单元版图通常被组织成水平的**行（rows）**。每一行都像一个货架，由一系列离散的、等间距的**场点（sites）**组成。一个标准单元的宽度是场点间距的整数倍，合法化必须将每个单元精确地放置在这些场点上，不能有任何重叠。然而，并非行内的所有场点都是可用的。多种物理结构会产生“放置阻塞（placement blockages）”，从而将可用的放置空间分割成不连续的区间。

典型的阻塞包括 ：
*   **行端盖（Endcaps）**：放置在每一行两端的特殊单元，用于确保行边界处满足复杂的[设计规则](@entry_id:1123586)。它们自身会占据场点，并且通常会引入一个额外的**禁入区（keep-out margin）**，以防止邻近的功能单元违反扩散层或阱的间距规则。
*   **阱接触单元（Well-taps）**：在CMOS工艺中，必须周期性地插入阱接触单元，以确保N阱和P阱（或P衬底）被正确地连接到电源（VDD）和地（VSS）。这些预先放置的单元及其周围的禁入区同样会形成不可用的场点区间。
*   **电源总线（Power Stripes）**：当垂直的电源总线穿过标准单元行时，会切断行，形成一个**行断点（row-break）**。这个区域内的场点不能用于放置标准单元。

综合这些约束，一行的可用放置空间实际上是由一系列不相交的连续场点区间（或称为**空隙（gaps）**）组成的。合法化的任务就是在这些离散的、被分割的空隙中为所有单元找到无重叠的位置。

除了位置约束，单元的**朝向（orientation）**也必须合法。标准单元在设计时，其内部的VDD和[VSS](@entry_id:635952)引脚通常分别位于单元边界的顶部和底部。现代设计为了高效共享电源网络，常常采用**交替的VDD/[VSS](@entry_id:635952)电源轨结构**。例如，偶数行的顶部是VDD轨，底部是[VSS](@entry_id:635952)轨；而奇数行则相反。这就要求放置在特定行中的单元必须选择能使其电源引脚正确对齐的朝向。

标准单元的四种基本[几何变换](@entry_id:150649)是：$R0$（原始朝向）、$MX$（绕x轴翻转，即垂直翻转）、$MY$（绕y轴翻转，即水平翻转）和$R180$（旋转180度）。通过分析这些变换对单元顶部和底部电源引脚的影响，可以确定每种行类型所允许的合法朝向集合 。
*   在VDD在顶部、[VSS](@entry_id:635952)在底部的行（例如偶数行）中，只有保持VDD在顶部的变换是合法的。这些变换是 **$R0$ 和 $MY$**。
*   在[VSS](@entry_id:635952)在顶部、VDD在底部的行（例如奇数行）中，只有将[VSS](@entry_id:635952)置于顶部的变换是合法的。这些变换是 **$MX$ 和 $R180$**。

这种严格的朝向规则确保了所有单元都能通过直接邻接（abutment）的方式连接到行电源轨，这是实现高密度和低功耗设计的关键。

#### 评估合法化质量

一个“合法”的布局方案有无数种，但它们的质量却千差万别。一个优秀的合法化算法不仅要找到一个无重叠的布局，还必须尽可能地保持[全局布局](@entry_id:1125677)的优化成果，并为后续的设计阶段（如布线）创造有利条件。因此，评估合法化质量需要一个多维度的指标体系 。

*   **总位移（Total Displacement）**：这是衡量合法化后单元位置 $(x_i^{\mathrm{leg}}, y_i^{\mathrm{leg}})$ 与其[全局布局](@entry_id:1125677)目标位置 $(x_i^{\mathrm{gp}}, y_i^{\mathrm{gp}})$ 之间偏差的核心指标。通常使用**[曼哈顿距离](@entry_id:141126)**之和来量化：$\sum_{i} (|x_i^{\mathrm{leg}} - x_i^{\mathrm{gp}}| + |y_i^{\mathrm{leg}} - y_i^{\mathrm{gp}}|)$。最小化总位移旨在最大程度地保留[全局布局](@entry_id:1125677)阶段在时序和线长方面的优化结果。

*   **[半周长线长](@entry_id:1125886)变化量（ΔHPWL）**：[半周长线长](@entry_id:1125886)（HPWL）是布局阶段估算线长最常用的代理模型。合法化过程中的单元移动会改变网络的[边界框](@entry_id:635282)，从而影响HPWL。一个好的合法化方案应尽可能减小或至少控制HPWL的增长，因为线长直接关系到信号延迟、功耗和布线资源消耗。

*   **最大单元箱[溢出](@entry_id:172355)（Maximum Bin Overflow）**：为了进行有效的拥塞管理，版图区域被划分为一个个**单元箱（bins）**。每个单元箱都有一个基于可用面积的容量。合法化后，如果某个单元箱内所有单元的总面积超过了其容量，就会发生**[溢出](@entry_id:172355)（overflow）**。最大溢出值是衡量局部区域单元密度的关键指标。高溢出意味着严重的局部拥塞，极有可能导致后续布线失败。单元扩展的主要目的就是消除或减小最大[溢出](@entry_id:172355)。

*   **引脚可访问性违例（Pin-Access Violations）**：这是一个更精细的指标，衡量合法化布局对可制造性的影响。即使单元不重叠，如果它们的放置方式使得某些引脚被邻近单元或布线障碍物阻挡，导致详细布线器无法在遵守[设计规则](@entry_id:1123586)的前提下连接到这些引脚，就产生了引脚可访问性违例。先进的合法化工具会预测并避免这类问题。

*   **运行时间（Runtime）**：在紧迫的芯片设计周期中，工具的执行效率至关重要。更快的合法化算法意味着设计者可以在给定的时间内进行更多的设计迭代，从而有更多机会探索设计空间，最终实现更好的整体设计质量（Quality of Result, QoR）。

理解这些目标之间的相互作用至关重要。例如，最小化总位移和最小化HPWL增长并非总是等价的。考虑一个单行布局中的网络，其HPWL仅取决于最左端和最右端引脚的相对位置。HPWL的改变量 $\Delta H$ 等于最右端引脚的位移减去最左端引脚的位移，即 $\Delta H = \Delta x_{\max} - \Delta x_{\min}$。只有当 $\Delta x_{\max} \le \Delta x_{\min}$ 时（即网络的两个端点向内收缩或左端点向右移动得比右端点更多），HPWL才不会增加。然而，一个旨在最小化总位移 $\sum |\Delta x_i|$ 的算法，可能会为了迁就中间单元而将整个网络向一个方向平移，导致 $\Delta x_{\max}$ 和 $\Delta x_{\min}$ 同号且 $\Delta x_{\max} > \Delta x_{\min}$，从而增加了HPWL 。

更有甚者，仅仅是将连续坐[标量化](@entry_id:634761)到离散场点这一看似简单的操作，本身就会对HPWL产生统计意义上的负面影响。我们可以将单元从其连续位置 $(x_i, y_i)$ 对齐到最[近场](@entry_id:269780)点 $(x_i', y_i')$ 所产生的误差 $q_i = x_i' - x_i$ 建模为一个均匀分布的[随机变量](@entry_id:195330)。对于一个包含 $n$ 个引脚的网络，其HPWL的变化量是这些[量化误差](@entry_id:196306)范围的[期望值](@entry_id:150961)。对于一个在 $[a, b]$ 区间上均匀分布的[随机变量](@entry_id:195330)，其 $n$ 个[独立同分布](@entry_id:169067)样本的范围的[期望值](@entry_id:150961)为 $(b-a)\frac{n-1}{n+1}$。因此，对于场点间距为 $s_x$ 和 $s_y$ 的网格，由于对齐操作导致的HPWL期望增加量为 $\frac{n-1}{n+1}(s_x + s_y)$ 。这个结果清晰地表明，合法化过程从一开始就面临着固有的线长增长压力，凸显了在多重约束和目标之间进行权衡的必要性。

### 合法化与单元扩展的算法机制

为了在满足所有硬约束的同时优化上述质量指标，学术界和工业界已经发展出多种算法。这些算法的复杂性和优化能力各不相同，从简单的贪心[启发式](@entry_id:261307)到复杂的[全局优化](@entry_id:634460)框架。

#### 贪心与局部方法

最直观的合法化方法之一是采用贪心策略，逐个放置单元。**“俄罗斯方块”（Tetris）式合法化**就是这类方法的典型代表 。该算法首先根据单元的理想x坐标对其进行排序，然后按照这个顺序，依次将每个单元放置到当前可用的、最靠前（通常是最左边）的合法位置。

这种方法的优点是简单、快速。然而，它在优化质量和稳定性方面存在严重缺陷。从优化的角度看，贪心选择本质上是在执行一种**[字典序](@entry_id:143032)最小化（lexicographical minimization）**。它会不惜一切代价为排序靠前的单元找到位移最小的位置，而完全不考虑这一决定对后续单元可能造成的灾难性影响。一个局部最优的选择可能严重挤压后续单元的放置空间，迫使它们产生巨大的位移，从而导致整体较差的总位移或HPWL。

更严重的问题在于其**不稳定性（instability）**。由于算法的行为依赖于单元的排序，而排序又取决于单元的理想坐标 $x_i^\star$，对 $x_i^\star$ 的微小扰动（例如，两个单元的理想位置非常接近）就可能导致它们的处理顺序发生翻转。这种顺序的改变可能引发连锁反应，导致最终的合法化布局发生剧烈变化。此外，将连续位置对齐到离散场点的“取整”操作本身也是一个不连续的函数。这些由排序和取整引入的**阈值效应**使得整个合法化映射变得不连续 。

#### 基于动态规划的精确行内合法化

与贪心法的短视形成鲜明对比，对于某些结构良好且规模有限的子问题，我们可以使用动态规划（Dynamic Programming, DP）来求得精确的最优解。单行合法化就是一个典型的例子，特别是当单元的相对顺序必须保持不变时。

我们可以将一行中的可用放置空间视为由固定障碍物分割开的若干个空隙。问题就变成了如何将一个有序的单元序列分配到这些有序的空隙中，以最小化总位移成本（例如，总平方位移 $\sum (x_i - x_i^\star)^2$）。

这个问题可以通过[动态规划](@entry_id:141107)求解 。我们可以定义一个状态 $DP(i, j)$ 为“将前 $i$ 个单元放置在前 $j$ 个空隙中的最小累积成本”。为了计算 $DP(i, j)$，我们枚举最后一个空隙（第 $j$ 个空隙）中放置了多少个单元。假设我们将第 $k+1$ 到第 $i$ 个单元作为一个连续的簇放置在第 $j$ 个空隙中，那么前 $k$ 个单元必须被最优地放置在前 $j-1$ 个空隙中，其成本由子问题 $DP(k, j-1)$ 给出。[递推关系式](@entry_id:274285)可以写为：
$$
DP(i, j) = \min_{0 \le k \le i} \{ DP(k, j-1) + \text{LocalCost}(k+1, i, j) \}
$$
其中 $\text{LocalCost}(p, q, j)$ 是将单元 $p$ 到 $q$ 作为一个整体放置在第 $j$ 个空隙中的最小成本。这个局部成本可以通过求解一个简单的二次[函数最小化](@entry_id:138381)问题来得到。通过填充整个DP表格，我们最终可以得到放置所有单元的全局最小成本。这种方法保证了在给定约束（如单元顺序）下的最优性，为评估[启发式算法](@entry_id:176797)提供了一个黄金标准。

#### 全局扩展的[数学优化](@entry_id:165540)方法

处理大规模设计时，逐行或贪心的方法往往无法有效处理跨越多行的全局密度问题。因此，需要更全局化的视角和更强大的优化工具。

一种被广泛应用的方法是将单元扩展问题建模为一个**[最小费用流](@entry_id:163804)（Min-Cost Flow）**问题 。在这个模型中，我们将版[图划分](@entry_id:152532)为许多单元箱。每个单元被看作一个“供应”节点，其供应量等于该单元的面积。每个单元箱被看作一个“需求”节点，其需求量（或容量）等于该单元箱的可用放置面积。我们构建一个从单元节点到单元箱节点的二分图，图中的一条边 $(i, j)$ 代表将单元 $i$ 的一部分面积“流动”到单元箱 $j$。

问题的关键在于定义每条边上的单[位流](@entry_id:164631)量成本 $c_{ij}$。这个成本需要反映将单元 $i$ 放置到单元箱 $j$ 中所付出的代价。一个典型的成本函数是位移和线长惩罚的加权和：
$$
c_{ij} = \alpha \lVert q_j - p_i \rVert_1 + \beta \sum_{n \in \mathcal{N}(i)} \delta_{ij}^{n}
$$
这里，$p_i$ 是单元 $i$ 的初始位置，$q_j$ 是单元箱 $j$ 的中心位置，$\lVert \cdot \rVert_1$ 是[曼哈顿距离](@entry_id:141126)。$\delta_{ij}^{n}$ 是一项巧妙的**线性化HPWL惩罚项**，它估算了将单元 $i$ 移动到 $q_j$ 时，其所连接的每个网络 $n$ 的HPWL增长量。通过求解这个[最小费用流](@entry_id:163804)问题，我们可以得到一个“扩散”的单元[面积分](@entry_id:275394)布，它在满足所有单元箱容量约束的前提下，最小化了总的位移和线长代价。这个连续的[面积分](@entry_id:275394)布随后需要通过一个离散化步骤（Detailed Placement）来得到最终的合法单元位置。

另一种非常直观且强大的全局方法是基于**[静电场](@entry_id:268546)类比（Electrostatic Analogy）** 。这个模型将单元视为携带“电荷”的粒子，它们在真空中（即版图的可用空间）相互排斥。单元密度越高的区域，“电荷”密度也越高，从而产生更强的排斥[力场](@entry_id:147325)，将单元推向电荷密度较低的区域（即空白区域）。

在数学上，我们可以将单元 $i$ 的面积 $A_i$ 建模为一个位于其中心 $\mathbf{r}_i$ 的负[点电荷](@entry_id:263616)，[电荷密度](@entry_id:144672)为 $\rho(\mathbf{x}) = -\sum_{i} A_i \delta(\mathbf{x}-\mathbf{r}_i)$。这个[电荷分布](@entry_id:144400)在空间中产生一个伪电场势 $\phi(\mathbf{x})$，该[势场](@entry_id:143025)满足二维泊松方程 $\nabla^2\phi = \rho$。在无界空间中，该方程的解（通过[格林函数法](@entry_id:186948)）为：
$$
\phi(\mathbf{x}) = -\frac{1}{2\pi} \sum_{i=1}^{N} A_{i} \ln(|\mathbf{x}-\mathbf{r}_{i}|)
$$
单元扩展的驱动力来自于这个[势场](@entry_id:143025)的负梯度，即“电场” $\mathbf{E} = -\nabla\phi(\mathbf{x})$。计算可得：
$$
\mathbf{E}(\mathbf{x}) = \frac{1}{2\pi} \sum_{i=1}^{N} A_{i} \frac{\mathbf{x}-\mathbf{r}_{i}}{|\mathbf{x}-\mathbf{r}_{i}|^{2}}
$$
这个场是所有单元产生的排斥场的线性叠加。每个单元 $i$ 在空间中产生一个径向向外的场，其强度正比于单元面积 $A_i$，反比于距离。因此，任何位置上的单元都会被其他单元推开，从而自然地实现了从高密度区域到低密度区域的平滑扩散。

这些基于[数学优化](@entry_id:165540)的全局方法，如**Abacus合法化器**（其核心是一个凸二次规划问题），与贪心法相比具有根本性的优势：它们的解到输入的映射是**连续的** 。这意味着对输入（理想位置）的微小扰动只会导致输出（合法化位置）的微小变化。这种**稳定性**对于在复杂的、迭代的设计流程中获得可预测和收敛的结果至关重要。

### 高级主题：为物理完整性而扩展

最初，单元扩展主要用于解决布线拥塞。然而，现代[超大规模集成电路设计](@entry_id:270740)面临着日益严峻的物理挑战，如功耗和散热。单元的局部密度不仅影响布通性，还直接决定了局部的功耗密度，进而影响电源网络的[电压稳定性](@entry_id:1133890)和芯片的温度分布。因此，先进的合法化和扩展算法必须将这些物理效应纳入其优化目标中。

#### 功耗完整性（[IR压降](@entry_id:272464)）

电源分配网络（PDN）并非理想导体，而是具有电阻。当标准单元工作时，它们从PDN中汲取电流。根据欧姆定律，电流流过电阻会产生[电压降](@entry_id:263648)，即**[IR压降](@entry_id:272464)**。如果局部区域的单元密度过高，会导致该区域的瞬时电流需求过大，从而引发严重的[IR压降](@entry_id:272464)，可能导致电路[时序违规](@entry_id:177649)甚至功能失效。

单元扩展通过将高功耗单元分散开，可以有效均衡电流需求，从而缓解峰值[IR压降](@entry_id:272464)。我们可以通过一个简化的模型来量化这一效应 。考虑一个由[电阻率](@entry_id:143840)为 $r$ 的一维导线建模的电源轨，其两端接有[理想电压源](@entry_id:276609) $V_{\text{DD}}$。导线上的[电压降](@entry_id:263648) $u(x) = V_{\text{DD}} - V(x)$ 满足一个[二阶微分方程](@entry_id:269365)：$\frac{d^2u}{dx^2} = -r i(x)$，其中 $i(x)$ 是沿线分布的电流消耗密度。

通过求解这个边界值问题可以发现，当总电流 $I_{\text{tot}}$ 集中在一个小区域时，中心点的最大[电压降](@entry_id:263648) $u_{\text{max, conc}}$ 远大于将同样总电流均匀分布在整条导线上时的最大[电压降](@entry_id:263648) $u_{\text{max, spread}}$。其比值为 $R = \frac{u_{\text{max, spread}}}{u_{\text{max, conc}}} = \frac{L}{2L-w}$，其中 $L$ 是导线长度，$w$ 是集中区域的宽度。当 $w \ll L$ 时，这个比值远小于1，这雄辩地证明了单元扩展对于改善功耗完整性的重要性。

#### 热完整性（热点缓解）

与[IR压降](@entry_id:272464)类似，高单元密度和高开关活动率的区域会成为功耗热点，导致局部温度急剧升高。**热点（Hotspots）**会严重影响芯片的性能和可靠性，例如降低晶体管寿命、增加漏电功耗和恶化时序。

因此，一个**热感知（thermally-aware）**的扩展算法是必需的。我们可以通过一个集总的RC热[网络模型](@entry_id:136956)来建立单元布局与温度之间的关系 。在这个模型中，每个单元箱的[稳态](@entry_id:139253)温升 $\Delta T_i = T_i - T_{\text{amb}}$ 与所有单元箱的功耗 $P_j$ 之间通过一个**热导矩阵 $G$** 建立线性关系：$G \Delta T = P$。功耗 $P_j$ 本身则由进入该单元箱的单元面积 $a_k$ 和其开关活动因子 $\alpha_k$ 共同决定（$P_j = \sum_k \kappa a_k \alpha_k$）。

这个模型的关键在于，一个单元箱的温度不仅取决于自身的功耗，还受到邻近单元箱通过[热传导](@entry_id:143509)（由 $G$ 的非对角线元素表示）传来的热量的影响。通过求解 $T = T_{\text{amb}}\mathbf{1} + G^{-1}P$，我们可以得到任意单元布局下的精确温度分布图。

有了这个物理模型，就可以将其整合到扩展算法的[目标函数](@entry_id:267263)中。例如，可以增加一个惩罚项，即惩罚温度升高的[平方和](@entry_id:161049) $\mu \sum_i (\Delta T_i)^2$，或者更精细地只惩罚超过安全阈值 $T_{\text{lim}}$ 的温度 $\mu \sum_i (T_i - T_{\text{lim}})_+^2$。通过这种方式，扩展算法可以在平衡位移、线长和拥塞的同时，主动地将高功耗单元驱离热点区域，从而实现一个电、热、布线资源都更均衡的优化布局。这体现了现代[EDA工具](@entry_id:1124132)中[多物理场](@entry_id:164478)协同设计的核心思想。