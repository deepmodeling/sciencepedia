{
    "hands_on_practices": [
        {
            "introduction": "一切性能分析始于理想模型。这个练习将引导我们从第一性原理出发，推导理想ADC的核心性能指标——信噪比（SNR）。通过这个实践（），你将能亲手计算出由量化噪声决定的理论性能上限，从而深刻理解ADC的分辨率、满量程范围与信噪比之间的内在联系。",
            "id": "4255221",
            "problem": "一个具有 $N$ 位的模拟数字转换器 (ADC) 中的理想中置式均匀量化器，在其满量程峰峰值范围 $V_{\\mathrm{pp,FS}}$ 内，将一个零均值输入映射到 $2^{N}$ 个等间距码之一。最低有效位 (LSB) 步长定义为该均匀划分所隐含的码间距。考虑一个单音、零均值正弦输入 $x(t) = A \\sin(2 \\pi f_{0} t)$，其峰值幅度为 $A$，且严格处于量化器的无过载区域内，因此永远不会发生削波。假设量化误差定义为 $e(t) = x(t) - \\hat{x}(t)$，其中 $\\hat{x}(t)$ 是量化后的输出，并且假设 $e(t)$ 与 $x(t)$ 无关，在其由均匀量化器步长决定的支撑集上均匀分布。\n\n令 $N = 13$，$V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$，且 $A = 0.80~\\mathrm{V}$。将所有功率视为在多个周期上的时间平均值。完全从第一性原理出发，从上述定义开始，包括正弦波的功率定义、由满量程范围和位分辨率得出的 LSB 定义，以及由理想均匀量化器引起的量化误差的均匀概率密度函数。不得在未从这些基础推导的情况下引用任何公式。\n\n任务：\n- 推导以 LSB 为单位表示的输入峰值幅度。\n- 推导以 $\\mathrm{LSB}^{2}$ 为单位的预期量化噪声功率。\n- 推导信噪比 (SNR)，定义为正弦信号功率与量化噪声功率之比，以分贝表示。\n\n以以下有序三元组形式报告您的最终数值结果：$\\big[$以 LSB 为单位的峰值幅度, 以 $\\mathrm{LSB}^{2}$ 为单位的量化噪声功率, 以 $\\mathrm{dB}$ 为单位的 SNR$\\big]$。以分贝表示 SNR，并将 SNR 四舍五入到四位有效数字。在最终报告的三元组中不要包含任何单位；此处的单位仅为解释说明。",
            "solution": "问题要求基于第一性原理，推导并计算模拟数字转换器 (ADC) 的三个关键性能指标：以最低有效位 (LSB) 为单位的峰值输入幅度、以 $\\mathrm{LSB}^2$ 为单位的量化噪声功率，以及以分贝为单位的信噪比 (SNR)。该问题提法明确且科学合理，为得出唯一解提供了所有必要的参数。\n\n给定参数如下：\n- ADC 分辨率：$N = 13$ 位\n- 满量程峰峰值范围：$V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$\n- 输入信号：$x(t) = A \\sin(2 \\pi f_{0} t)$，峰值幅度 $A = 0.80~\\mathrm{V}$\n\n我们将按顺序完成这三项任务。\n\n首先，我们推导以 LSB 为单位的输入信号峰值幅度。\n量化器的基本步长，即最低有效位 (LSB)，定义为将满量程峰峰值范围 $V_{\\mathrm{pp,FS}}$ 均匀划分为 $2^N$ 个电平。因此，对应于一个 LSB 的电压（记为 $\\Delta$）为：\n$$ \\Delta = \\frac{V_{\\mathrm{pp,FS}}}{2^N} $$\n代入给定值 $V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$ 和 $N = 13$：\n$$ \\Delta = \\frac{2.56}{2^{13}} = \\frac{2.56}{8192}~\\mathrm{V} $$\n输入信号的峰值幅度给定为 $A = 0.80~\\mathrm{V}$。为了以 LSB 为单位表示该幅度（我们记为 $A_{\\mathrm{LSB}}$），我们计算 $A$ 与 $\\Delta$ 的比值：\n$$ A_{\\mathrm{LSB}} = \\frac{A}{\\Delta} = \\frac{0.80~\\mathrm{V}}{\\frac{2.56}{8192}~\\mathrm{V}} = \\frac{0.80 \\times 8192}{2.56} $$\n我们可以将比值 $\\frac{0.80}{2.56}$ 简化为 $\\frac{80}{256} = \\frac{5 \\times 16}{16 \\times 16} = \\frac{5}{16}$。\n$$ A_{\\mathrm{LSB}} = \\frac{5}{16} \\times 8192 = 5 \\times \\frac{8192}{16} = 5 \\times 512 = 2560 $$\n因此，输入正弦波的峰值幅度为 $2560$ LSB。不发生削波的条件得到满足，因为满量程峰值幅度为 $\\frac{V_{\\mathrm{pp,FS}}}{2} = \\frac{2.56}{2} = 1.28~\\mathrm{V}$，而 $A = 0.80~\\mathrm{V}  1.28~\\mathrm{V}$。同样，以 LSB 为单位，满量程峰值幅度为 $\\frac{A_{FS}}{ \\Delta} = \\frac{1.28}{\\Delta} = \\frac{1.28 \\times 8192}{2.56} = \\frac{1}{2}\\times 8192 = 4096$ LSB。$A_{\\mathrm{LSB}} = 2560  4096$。\n\n其次，我们推导以 $\\mathrm{LSB}^2$ 为单位的预期量化噪声功率。\n问题陈述量化误差 $e(t) = x(t) - \\hat{x}(t)$ 在其支撑集上均匀分布。对于步长为 $\\Delta$ 的理想中置式均匀量化器，任何输入值的误差都限制在区间 $[-\\frac{\\Delta}{2}, +\\frac{\\Delta}{2}]$ 内。因此，误差的概率密度函数 (PDF) $p(e)$ 为：\n$$ p(e) = \\begin{cases} \\frac{1}{\\Delta}  \\text{for } -\\frac{\\Delta}{2} \\le e \\le \\frac{\\Delta}{2} \\\\ 0  \\text{otherwise} \\end{cases} $$\n量化噪声功率 $P_n$ 是误差的均方值 $E[e^2]$。对于零均值过程，这等于其方差。由于围绕零的对称分布，误差的均值确实为零：$E[e] = \\int_{-\\infty}^{\\infty} e \\, p(e) \\, de = \\int_{-\\Delta/2}^{\\Delta/2} e \\, \\frac{1}{\\Delta} \\, de = 0$。\n噪声功率计算如下：\n$$ P_n = E[e^2] = \\int_{-\\infty}^{\\infty} e^2 p(e) \\, de = \\int_{-\\Delta/2}^{\\Delta/2} e^2 \\frac{1}{\\Delta} \\, de $$\n$$ P_n = \\frac{1}{\\Delta} \\left[ \\frac{e^3}{3} \\right]_{-\\Delta/2}^{\\Delta/2} = \\frac{1}{3\\Delta} \\left[ \\left(\\frac{\\Delta}{2}\\right)^3 - \\left(-\\frac{\\Delta}{2}\\right)^3 \\right] $$\n$$ P_n = \\frac{1}{3\\Delta} \\left[ \\frac{\\Delta^3}{8} - \\left(-\\frac{\\Delta^3}{8}\\right) \\right] = \\frac{1}{3\\Delta} \\left( \\frac{2\\Delta^3}{8} \\right) = \\frac{\\Delta^2}{12} $$\n这是以 $\\mathrm{V}^2$ 为单位的噪声功率。问题要求以 $\\mathrm{LSB}^2$ 为单位的功率。由于 $1~\\mathrm{LSB}$ 对应于电压 $\\Delta$，因此 $1~\\mathrm{LSB}^2$ 对应于功率 $\\Delta^2~\\mathrm{V}^2$。要将 $P_n$ 转换为以 $\\mathrm{LSB}^2$ 为单位，我们除以 $\\Delta^2$：\n$$ P_{n, \\mathrm{LSB}^2} = \\frac{P_n}{\\Delta^2} = \\frac{\\Delta^2/12}{\\Delta^2} = \\frac{1}{12} $$\n量化噪声功率为 $\\frac{1}{12}~\\mathrm{LSB}^2$，在给定模型下，这个结果与具体的 ADC 参数无关。\n\n第三，我们推导以分贝为单位的信噪比 (SNR)。\n正弦输入信号 $x(t) = A \\sin(2 \\pi f_0 t)$ 的功率是其均方值，通过在一个周期 $T = 1/f_0$ 上求平均来计算：\n$$ P_s = \\frac{1}{T} \\int_0^T x(t)^2 \\, dt = \\frac{1}{T} \\int_0^T \\left( A \\sin(2 \\pi f_0 t) \\right)^2 \\, dt = \\frac{A^2}{T} \\int_0^T \\sin^2(2 \\pi f_0 t) \\, dt $$\n使用三角恒等式 $\\sin^2(\\theta) = \\frac{1}{2}(1 - \\cos(2\\theta))$，积分变为：\n$$ P_s = \\frac{A^2}{T} \\int_0^T \\frac{1}{2}(1 - \\cos(4 \\pi f_0 t)) \\, dt = \\frac{A^2}{2T} \\left[ t - \\frac{\\sin(4 \\pi f_0 t)}{4 \\pi f_0} \\right]_0^T $$\n$$ P_s = \\frac{A^2}{2T} \\left[ (T - 0) - (0 - 0) \\right] = \\frac{A^2}{2} $$\nSNR 是信号功率 $P_s$ 与量化噪声功率 $P_n$ 之比。必须使用相同单位（例如 $\\mathrm{V}^2$）的功率。\n$$ \\mathrm{SNR} = \\frac{P_s}{P_n} = \\frac{A^2/2}{\\Delta^2/12} = \\frac{6A^2}{\\Delta^2} = 6 \\left(\\frac{A}{\\Delta}\\right)^2 $$\n在第一项任务中，我们得出 $\\frac{A}{\\Delta} = A_{\\mathrm{LSB}} = 2560$。代入此值：\n$$ \\mathrm{SNR} = 6 \\times (2560)^2 = 6 \\times 6553600 = 39321600 $$\n以分贝 ($\\mathrm{dB}$) 为单位的 SNR 定义为功率比的以 10 为底的对数的 10 倍：\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}(\\mathrm{SNR}) = 10 \\log_{10}(39321600) $$\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}(3.93216 \\times 10^7) = 10 \\left( \\log_{10}(3.93216) + \\log_{10}(10^7) \\right) $$\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\left( \\log_{10}(3.93216) + 7 \\right) \\approx 10(0.5946268 + 7) = 10(7.5946268) \\approx 75.946268 $$\n按照要求将结果四舍五入到四位有效数字，得到 $75.95$。\n\n三项任务的最终结果是：峰值幅度为 $2560$ LSB，量化噪声功率为 $\\frac{1}{12}~\\mathrm{LSB}^2$，信噪比为 $75.95~\\mathrm{dB}$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 2560  \\frac{1}{12}  75.95 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在理想模型之外，真实世界的ADC会引入非线性失真，产生不必要的杂散信号。本练习聚焦于衡量这种失真性能的关键指标——无杂散动态范围（SFDR）。你将根据给定的频谱数据（），学习如何正确识别并计算SFDR，同时辨析在工程实践中应如何处理谐波与非谐波杂散。",
            "id": "4255224",
            "problem": "一个模数转换器 (ADC) 在其第一奈奎斯特区内受到单音输入信号的激励。在使用相干记录和保持音调幅度的窗函数进行的稳态频谱测量中，离散时间频谱显示了一个主导的三次谐波，其电平为 $-70\\,\\mathrm{dBc}$，以及几个非谐波杂散分量（spurs），其中最大的非谐波杂散分量电平为 $-68\\,\\mathrm{dBc}$。假设所有报告的杂散电平均是根据相对于载波的分贝（dBc）定义相对于基波音调测量的，即对于任何功率为 $P_{x}$ 的频谱分量和功率为 $P_{1}$ 的基波，其相对于载波的分贝（dBc）电平为 $10\\log_{10}\\!\\big(P_{x}/P_{1}\\big)$，并且根据定义，基波音调的电平为 $0\\,\\mathrm{dBc}$。我们关注的杂散分量位于第一奈奎斯特区内，并且不是由记录长度或频谱泄漏引起的混叠伪影。\n\n从上述定义和“杂散分量是除基波音调外的任何离散谱线”这一概念出发，推导以基波和最大杂散分量表示的无杂散动态范围 (SFDR) 的适当表达式，并用它来计算该转换器的 SFDR。在您的推导中，请明确说明根据常见的模数转换器测量实践，在确定 SFDR 时是否应将谐波包含在杂散分量中。\n\n将最终的 SFDR 值以 $\\mathrm{dBc}$ 表示，并将您的答案四舍五入到三位有效数字。对于最终答案，仅报告数值，不带单位。",
            "solution": "该问题陈述经评估具有科学依据、提法恰当、客观且完整。它描述了模数转换器（ADC）特性表征中的一个标准场景，并提供了计算所要求的性能指标所需的所有数据。因此，可以推导出解决方案。\n\n无杂散动态范围（SFDR）是一个关键指标，用于量化在杂散信号干扰或被误认为所需信号之前，ADC 的动态范围。它被定义为基波（或载波）信号功率与输出频谱中最大杂散分量功率之比。\n\n设 $P_1$ 为基波音调的功率，$P_{spur,max}$ 为最大杂散分量的功率。SFDR 作为功率比为：\n$$ \\mathrm{SFDR}_{\\mathrm{ratio}} = \\frac{P_1}{P_{spur,max}} $$\n当用分贝表示时，这变为：\n$$ \\mathrm{SFDR}_{\\mathrm{dB}} = 10\\log_{10}(\\mathrm{SFDR}_{\\mathrm{ratio}}) = 10\\log_{10}\\left(\\frac{P_1}{P_{spur,max}}\\right) $$\n利用对数的性质，该表达式可以重写为基波功率的分贝值（$P_{1,\\mathrm{dB}}$）与最大杂散功率的分贝值（$P_{spur,max,\\mathrm{dB}}$）之差：\n$$ \\mathrm{SFDR}_{\\mathrm{dB}} = P_{1,\\mathrm{dB}} - P_{spur,max,\\mathrm{dB}} $$\n问题以相对于载波的分贝（$\\mathrm{dBc}$）提供了功率电平。一个功率为 $P_x$ 的频谱分量，其电平 $L_x$（以 $\\mathrm{dBc}$ 为单位）定义为：\n$$ L_{x, \\mathrm{dBc}} = 10\\log_{10}\\left(\\frac{P_x}{P_1}\\right) $$\n根据定义，基波音调的电平为 $L_{1, \\mathrm{dBc}} = 10\\log_{10}(P_1/P_1) = 10\\log_{10}(1) = 0\\,\\mathrm{dBc}$，如问题所述。\n\n最大杂散分量的电平（以 $\\mathrm{dBc}$ 为单位）为：\n$$ L_{spur,max, \\mathrm{dBc}} = 10\\log_{10}\\left(\\frac{P_{spur,max}}{P_1}\\right) $$\n我们现在可以推导以 $\\mathrm{dBc}$ 值表示的 SFDR 表达式。请注意，$\\mathrm{SFDR}_{\\mathrm{dB}} = 10\\log_{10}(P_1/P_{spur,max}) = -10\\log_{10}(P_{spur,max}/P_1)$。将其与杂散电平（以 $\\mathrm{dBc}$ 为单位）的定义进行比较，我们发现：\n$$ \\mathrm{SFDR}_{\\mathrm{dBc}} = -L_{spur,max, \\mathrm{dBc}} $$\n由于 SFDR 通常表示为代表动态范围的正值，这等同于最大杂散电平（以 $\\mathrm{dBc}$ 为单位）的绝对值：\n$$ \\mathrm{SFDR}_{\\mathrm{dBc}} = |L_{spur,max, \\mathrm{dBc}}| $$\n等效地，它是基波与最大杂散分量之间的幅度差：\n$$ \\mathrm{SFDR}_{\\mathrm{dBc}} = L_{1, \\mathrm{dBc}} - L_{spur,max, \\mathrm{dBc}} = 0 - L_{spur,max, \\mathrm{dBc}} = -L_{spur,max, \\mathrm{dBc}} $$\n\n下一步是确定最大的杂散分量。问题陈述中提到“杂散分量是除基波音调外的任何离散谱线”。这个定义明确包括了谐波。此外，在“常见的模数转换器测量实践”中，SFDR 几乎普遍是通过寻找频谱中最大的单个无用音调来确定的，而不管其来源如何。SFDR 的目的是定义没有任何显著杂散能量的范围。限制性的杂散分量是由 ADC 的非线性产生的谐波，还是一个非谐波相关的音调（例如，来自时钟馈通或其他干扰），这对于 SFDR 本身的值是无关紧要的，因为任何类型的杂散分量都可能损坏信号。因此，必须将谐波视为最大杂散分量的候选者。\n\n问题提供了两个可能是最大杂散分量的候选者的电平：\n$1$。主导的三次谐波，其电平为 $L_{H3} = -70\\,\\mathrm{dBc}$。\n$2$。最大的非谐波杂散分量，其电平为 $L_{NHS} = -68\\,\\mathrm{dBc}$。\n\n为了找到最大的杂散分量，我们必须比较这两个电平。在分贝标度中，较大的功率电平对应于较小的负值。\n由于 $-68 > -70$，所以电平为 $-68\\,\\mathrm{dBc}$ 的杂散分量比电平为 $-70\\,\\mathrm{dBc}$ 的分量具有更高的功率电平。因此，整个频谱中最大的杂散分量是非谐波杂散分量。\n$$ L_{spur,max, \\mathrm{dBc}} = \\max(L_{H3}, L_{NHS}) = \\max(-70\\,\\mathrm{dBc}, -68\\,\\mathrm{dBc}) = -68\\,\\mathrm{dBc} $$\n\n使用推导出的 SFDR 表达式，我们可以计算其值：\n$$ \\mathrm{SFDR}_{\\mathrm{dBc}} = -L_{spur,max, \\mathrm{dBc}} = -(-68\\,\\mathrm{dBc}) = 68\\,\\mathrm{dBc} $$\n\n问题要求答案四舍五入到三位有效数字。计算值为 $68$，有两位有效数字。为了用三位有效数字表示，我们将其写为 $68.0$。\n因此，该转换器的 SFDR 为 $68.0\\,\\mathrm{dBc}$。",
            "answer": "$$\n\\boxed{68.0}\n$$"
        },
        {
            "introduction": "理论计算为我们提供了基准，但实际的性能验证则需要更复杂的工程方法。这个综合性实践（）将带领你编写一个完整的ADC验证程序。你将实现时域和频域两种SNR估算方法，并学习如何诊断因非相干采样、窗函数选择或校准误差等实际问题所导致的测量差异。",
            "id": "4255222",
            "problem": "您的任务是为模拟数字转换器（ADC）模型构建一套严格的验证方法，该方法用于比较两种信噪比（SNR）估计器：一种是基于模型拟合的时域估计器，另一种是基于离散傅里叶变换（DFT）的频域估计器。您必须定义在 $0.5$ dB 内达成一致的验收标准，并诊断由加窗选择或校准误差引起的不一致。解决方案必须从第一性原理推导，并实现为一个完整、可运行的程序。\n\n从以下基本依据和核心定义开始：\n\n- ADC 是一个 $N$ 位均匀量化器，其满量程峰峰值电压为 $V_{\\mathrm{pp}}$。最低有效位（LSB）的步长为 $\\Delta = V_{\\mathrm{pp}} / 2^N$。\n- 输入信号为离散时间正弦波 $x[n] = A \\sin(2\\pi f_{\\mathrm{in}} n / f_s)$，其振幅 $A$ 相对于 $V_{\\mathrm{pp}}/2$ 表示，采样率为 $f_s$，共采样 $N_s$ 个点。量化后可能会施加数字增益误差 $g$ 和数字失调误差 $o$，使得报告的数字输出为 $y[n] = g \\cdot q[n] + o$，其中 $q[n]$ 是以伏特为单位的量化值，并被裁剪到 ADC 范围内。\n- 信噪比（SNR）定义为 $ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig}}}{P_{\\mathrm{noise}}}\\right) $，其中 $P_{\\mathrm{sig}}$ 是信号功率，$P_{\\mathrm{noise}}$ 是噪声功率。\n- 加窗序列 $x_w[n] = w[n] \\cdot x[n]$ 的离散时间 DFT 为 $X[k] = \\sum_{n=0}^{N_s-1} x_w[n] e^{-j 2\\pi k n / N_s}$。帕塞瓦尔定理（Parseval’s theorem）将时域能量与频域能量关联起来：$\\sum_{n=0}^{N_s-1} |x_w[n]|^2 = \\frac{1}{N_s} \\sum_{k=0}^{N_s-1} |X[k]|^2$。平均功率是时域能量除以 $N_s$，等于 $\\frac{1}{N_s^2} \\sum_{k=0}^{N_s-1} |X[k]|^2$。\n- 当信号音在 $N_s$ 个采样点内完成整数个周期时，即 $C = f_{\\mathrm{in}} N_s / f_s$ 为整数时，发生相干采样。否则，能量会泄漏到其他频率仓（频谱泄漏），泄漏程度取决于所用的窗函数 $w[n]$。\n\n实施以下方法学：\n\n1. 生成频率为 $f_{\\mathrm{in}}$、振幅为 $A = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$（其中 $\\alpha$ 为振幅分数）的理想正弦波 $x[n]$。使用步长为 $\\Delta$ 的中点归整（mid-tread rounding）将 $x[n]$ 量化为 $q[n]$，并将其裁剪至 $[-V_{\\mathrm{pp}}/2, V_{\\mathrm{pp}}/2]$ 范围内。施加数字增益 $g$ 和失调 $o$ 以产生 $y[n] = g \\cdot q[n] + o$。\n2. 时域SNR估计：使用最小二乘法，通过一个包含未知振幅、相位和直流失调的单音模型来拟合 $y[n]$。使用基函数 $\\sin(2\\pi f_{\\mathrm{in}} n / f_s)$、$\\cos(2\\pi f_{\\mathrm{in}} n / f_s)$ 和 $1$ 来获得系数 $B_1$、$B_2$ 和 $C$。拟合后的信号为 $s_{\\mathrm{fit}}[n] = B_1 \\sin(2\\pi f_{\\mathrm{in}} n / f_s) + B_2 \\cos(2\\pi f_{\\mathrm{in}} n / f_s)$，直流分量为 $C$。计算 $P_{\\mathrm{sig,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} s_{\\mathrm{fit}}[n]^2$ 和 $P_{\\mathrm{noise,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} (y[n] - C - s_{\\mathrm{fit}}[n])^2$。然后 $\\mathrm{SNR}_{\\mathrm{td}} = 10 \\log_{10} \\left( \\frac{P_{\\mathrm{sig,td}}}{P_{\\mathrm{noise,td}}} \\right)$。\n3. 频域SNR估计：从 $y[n]$ 中移除均值，应用指定的窗函数 $w[n]$（矩形窗、汉宁窗或布莱克曼窗），计算 DFT $X[k]$ 和每个频率仓的能量 $E[k] = |X[k]|^2 / N_s^2$。在正频率范围 $k \\in [1, \\lfloor N_s/2 \\rfloor - 1]$ 内识别基波频率仓索引 $k_{\\mathrm{peak}}$。根据窗函数定义主瓣捕获宽度 $m$（对于矩形窗和汉宁窗，m=1；对于布莱克曼窗，m=2）。构建信号频率仓集合 $\\mathcal{S}$，该集合包含 $k_{\\mathrm{peak}} + r$（其中 $r \\in [-m, m]$）及其对称对应项 $N_s - (k_{\\mathrm{peak}} + r)$，裁剪至有效索引范围内，并排除直流分量（$k=0$）。计算 $P_{\\mathrm{sig,fft}} = \\sum_{k \\in \\mathcal{S}} E[k]$，$P_{\\mathrm{noise,fft}} = \\sum_{k \\notin \\mathcal{S}, k \\neq 0} E[k]$，以及 $\\mathrm{SNR}_{\\mathrm{fft}} = 10 \\log_{10} \\left( \\frac{P_{\\mathrm{sig,fft}}}{P_{\\mathrm{noise,fft}}} \\right)$。\n4. 验收标准：如果 $|\\mathrm{SNR}_{\\mathrm{td}} - \\mathrm{SNR}_{\\mathrm{fft}}| \\le 0.5$ dB，则两个 SNR 估计值被视为一致。\n5. 差异诊断：\n   - 如果采样是非相干的（即 $C$ 在某个容差范围内不是整数）且捕获的信号能量分数 $\\rho = P_{\\mathrm{sig,fft}} / (P_{\\mathrm{sig,fft}} + P_{\\mathrm{noise,fft}})$ 低于一个阈值（例如 $\\rho  0.9$），则怀疑存在加窗泄漏，特别是对于矩形窗。\n   - 如果最小二乘法拟合的振幅 $A_{\\mathrm{LS}} = \\sqrt{B_1^2 + B_2^2}$ 与标称模拟振幅 $A_{\\mathrm{nom}} = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$ 的相对差异超过一个阈值（例如 $|A_{\\mathrm{LS}} - A_{\\mathrm{nom}}| / A_{\\mathrm{nom}}  0.02$），或者如果拟合的直流分量 $C$ 的偏差超过 $0.5$ LSB（即 $|C|  0.5 \\Delta$），则怀疑存在校准误差。\n   - 组合标志以生成诊断代码：$0$ 表示无问题，$1$ 表示怀疑加窗泄漏，$2$ 表示怀疑校准误差，$3$ 表示两者皆有。\n\n使用 $V_{\\mathrm{pp}} = 1$ V，这样 $\\Delta = 1/2^N$ V，并将所有 SNR 值以 dB 表示，四舍五入到三位小数。如果涉及角度，必须以弧度为单位。\n\n测试套件：\n实施该方法学，对以下参数集进行验证，以检验不同方面：\n- 案例1（理想情况，相干，正确加窗）：$N = 12$，$N_s = 4096$，$f_s = 10^6$ Hz，$C = 205$ 个周期，$f_{\\mathrm{in}} = C \\cdot f_s / N_s$，$\\alpha = 0.9$，窗函数 = 汉宁窗（Hann），$g = 1.0$，$o = 0.0$ V。\n- 案例2（非相干，不当加窗）：$N = 12$，$N_s = 4096$，$f_s = 10^6$ Hz，$C = 205.5$ 个周期，$f_{\\mathrm{in}} = C \\cdot f_s / N_s$，$\\alpha = 0.9$，窗函数 = 矩形窗，$g = 1.0$，$o = 0.0$ V。\n- 案例3（校准误差）：$N = 12$，$N_s = 4096$，$f_s = 10^6$ Hz，$C = 205$ 个周期，$f_{\\mathrm{in}} = C \\cdot f_s / N_s$，$\\alpha = 0.9$，窗函数 = 汉宁窗，$g = 1.05$，$o = 0.5 \\Delta$ V。\n- 案例4（低振幅边缘情况）：$N = 10$，$N_s = 4096$，$f_s = 10^6$ Hz，$C = 123.3$ 个周期，$f_{\\mathrm{in}} = C \\cdot f_s / N_s$，$\\alpha = 2 / 2^{10}$，窗函数 = 布莱克曼窗，$g = 1.0$，$o = 0.0$ V。\n\n您的程序应生成单行输出，其中包含一个逗号分隔的 Python 风格列表的列表，每个子列表对应一个测试案例，其中的条目按顺序为 $[\\mathrm{SNR}_{\\mathrm{td}}, \\mathrm{SNR}_{\\mathrm{fft}}, \\mathrm{accept}, \\mathrm{diag}]$，其中 $\\mathrm{accept}$ 为 $1$ 表示真，$0$ 表示假，$\\mathrm{diag}$ 是上述的诊断代码。例如，最终格式应类似于 $[[x_1,y_1,a_1,d_1],[x_2,y_2,a_2,d_2],...]$，其中 $\\mathrm{SNR}$ 值四舍五入到三位小数。",
            "solution": "问题陈述已经过严格审查，并被确定为有效。它在科学上基于数字信号处理和模拟数字转换器表征的原理。该问题定义明确，为实现验证方法学提供了一套清晰、独立且可形式化的指令。测试用例设计精良，旨在探究该方法学的特定方面，如相干与非相干采样、加窗效应和校准误差。一些次要的模糊之处，例如术语“rectangular Hann”和检查整数周期的容差，都通过基于上下文的合理解释得以解决。“rectangular Hann (Hann)”被理解为汉宁窗，并且假定浮点数比较时使用一个小的数值容差。所概述的方法学是可靠的，可以实施以产生唯一且有意义的解决方案。\n\n实现将系统地遵循问题陈述中定义的步骤进行。\n\n### 1. 信号生成和 ADC 模型\n\n首先，我们生成离散时间输入信号，并通过 ADC 模型进行处理。\n\n时间向量为 $N_s$ 个样本定义为 $n = 0, 1, \\dots, N_s-1$。\n输入正弦波由下式给出：\n$$\nx[n] = A \\sin\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right)\n$$\n其中振幅为 $A = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$，输入频率为 $f_{\\mathrm{in}} = C \\cdot f_s / N_s$。当 $V_{\\mathrm{pp}} = 1$ V 时，这简化为 $A = \\alpha/2$。\n\nADC 是一个 $N$ 位均匀量化器，其最低有效位（LSB）步长为 $\\Delta = V_{\\mathrm{pp}} / 2^N = 1/2^N$。问题指定了一个中点量化器。量化过程通过将输入电压（按 LSB 大小缩放）四舍五入到最接近的 $\\Delta$ 整数倍来建模。\n$$\nq[n] = \\Delta \\cdot \\left\\lfloor \\frac{x[n]}{\\Delta} + 0.5 \\right\\rfloor = \\Delta \\cdot \\mathrm{round}\\left(\\frac{x[n]}{\\Delta}\\right)\n$$\n问题陈述中提到将 $q[n]$ 裁剪至 $[-V_{\\mathrm{pp}}/2, V_{\\mathrm{pp}}/2]$ 范围。然而，对于所有提供的测试用例，输入振幅分数 $\\alpha \\le 1$，这确保了输入信号 $x[n]$ 在 ADC 的满量程范围内。因此，量化输出 $q[n]$ 也将在此范围内，使得对于给定参数，裁剪操作是多余的。\n\n最后，将数字增益（$g$）和失调（$o$）误差应用于量化信号，以产生最终输出：\n$$\ny[n] = g \\cdot q[n] + o\n$$\n\n### 2. 时域 SNR 估计（$\\mathrm{SNR}_{\\mathrm{td}}$）\n\n此方法通过将参数模型拟合到输出数据 $y[n]$ 来估计 SNR。该模型是在已知输入频率 $f_{\\mathrm{in}}$ 下带有直流失调的纯正弦波。\n$$\ny_{\\mathrm{model}}[n] = B_1 \\sin\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right) + B_2 \\cos\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right) + C_{dc}\n$$\n未知系数 $\\beta = [B_1, B_2, C_{dc}]^T$ 是通过最小化 $y[n]$ 和 $y_{\\mathrm{model}}[n]$ 之间的平方误差和来确定的。这是一个线性最小二乘问题，可以表示为矩阵形式 $\\mathbf{y} = \\mathbf{M}\\beta$，其中 $\\mathbf{y}$ 是 $y[n]$ 样本的向量，$\\mathbf{M}$ 是一个其列为基函数的矩阵：\n$$\n\\mathbf{M} = \\begin{bmatrix}\n\\sin(\\omega_0 \\cdot 0)  \\cos(\\omega_0 \\cdot 0)  1 \\\\\n\\sin(\\omega_0 \\cdot 1)  \\cos(\\omega_0 \\cdot 1)  1 \\\\\n\\vdots  \\vdots  \\vdots \\\\\n\\sin(\\omega_0 \\cdot (N_s-1))  \\cos(\\omega_0 \\cdot (N_s-1))  1\n\\end{bmatrix}\n$$\n其中 $\\omega_0 = 2\\pi f_{\\mathrm{in}}/f_s$。系数的最小二乘解为 $\\hat{\\beta} = (\\mathbf{M}^T\\mathbf{M})^{-1}\\mathbf{M}^T\\mathbf{y}$。\n\n一旦找到系数 $\\hat{B}_1, \\hat{B}_2, \\hat{C}_{dc}$，就可分离信号和噪声分量。拟合的信号分量（交流部分）是：\n$$\ns_{\\mathrm{fit}}[n] = \\hat{B}_1 \\sin(\\omega_0 n) + \\hat{B}_2 \\cos(\\omega_0 n)\n$$\n表示噪声的残差为：\n$$\ne[n] = y[n] - (s_{\\mathrm{fit}}[n] + \\hat{C}_{dc})\n$$\n信号和噪声的平均功率计算如下：\n$$\nP_{\\mathrm{sig,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} s_{\\mathrm{fit}}[n]^2\n\\quad \\text{和} \\quad\nP_{\\mathrm{noise,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} e[n]^2\n$$\n然后，时域信噪比（以分贝计）为：\n$$\n\\mathrm{SNR}_{\\mathrm{td}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig,td}}}{P_{\\mathrm{noise,td}}}\\right)\n$$\n\n### 3. 频域 SNR 估计（$\\mathrm{SNR}_{\\mathrm{fft}}$）\n\n此方法从信号的离散傅里叶变换（DFT）中估计 SNR。\n\n首先，移除输出信号的均值以分离交流分量：$y'[n] = y[n] - \\bar{y}$，其中 $\\bar{y} = \\frac{1}{N_s}\\sum_{n=0}^{N_s-1} y[n]$。\n接下来，对去趋势信号应用窗函数 $w[n]$，以减少非相干采样情况下的频谱泄漏：$y_w[n] = y'[n] \\cdot w[n]$。问题指定了矩形窗、汉宁窗或布莱克曼窗。\n\n计算加窗序列的 DFT：\n$$\nX[k] = \\sum_{n=0}^{N_s-1} y_w[n] e^{-j 2\\pi kn / N_s}\n$$\n根据问题的定义（与帕塞瓦尔定理一致），每个频率仓 $k$ 中的功率为：\n$$\nP_{spec}[k] = \\frac{|X[k]|^2}{N_s^2}\n$$\n加窗信号的总平均功率为 $\\sum_{k=0}^{N_s-1} P_{spec}[k]$。\n\n为了将信号与噪声分开，我们识别基波频率峰值。找到对应于正频率范围 $k \\in [1, \\lfloor N_s/2 \\rfloor - 1]$ 内最大功率的频率仓索引 $k_{\\mathrm{peak}}$。围绕峰值及其负频率镜像的一组频率仓 $\\mathcal{S}$ 被指定为信号仓。该集合包括频率仓 $k_{\\mathrm{peak}} + r$（其中 $r \\in [-m, m]$）及其对称对应项 $N_s - (k_{\\mathrm{peak}} + r)$，其中 $m$ 是主瓣捕获宽度（对于矩形窗/汉宁窗，_m_=1；对于布莱克曼窗，_m_=2）。直流仓（$k=0$）被排除。\n\n信号功率是信号仓中功率的总和，噪声功率是所有其他非直流仓中功率的总和：\n$$\nP_{\\mathrm{sig,fft}} = \\sum_{k \\in \\mathcal{S}} P_{spec}[k]\n\\quad \\text{和} \\quad\nP_{\\mathrm{noise,fft}} = \\sum_{k \\notin \\mathcal{S}, k \\neq 0} P_{spec}[k]\n$$\n频域信噪比（以分贝计）为：\n$$\n\\mathrm{SNR}_{\\mathrm{fft}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig,fft}}}{P_{\\mathrm{noise,fft}}}\\right)\n$$\n\n### 4. 验收和差异诊断\n\n比较两个 SNR 估计值。如果它们的绝对差在 $0.5$ dB 阈值内，则测试被接受：\n$$\n|\\mathrm{SNR}_{\\mathrm{td}} - \\mathrm{SNR}_{\\mathrm{fft}}| \\le 0.5\n$$\n\n如果估计值不一致，则执行诊断以确定可能的原因。\n形成一个二进制诊断代码：\n- **加窗泄漏（标志=1）：** 如果采样是非相干的并且信号能量“泄漏”到相邻的频率仓中，则怀疑此问题。通过测试周期数 $C$ 是否为整数（在小的容差范围内，例如 $10^{-6}$）来检查相干性。泄漏由捕获的信号能量分数 $\\rho = P_{\\mathrm{sig,fft}} / (P_{\\mathrm{sig,fft}} + P_{\\mathrm{noise,fft}})$ 来量化。如果采样非相干且 $\\rho  0.9$，则设置此标志。\n- **校准误差（标志=2）：** 如果存在显著的增益或失调误差，则怀疑此问题。\n    - 如果最小二乘拟合振幅 $A_{\\mathrm{LS}} = \\sqrt{\\hat{B}_1^2 + \\hat{B}_2^2}$ 与标称模拟振幅 $A_{\\mathrm{nom}} = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$ 之间的相对差异超过 $2\\%$，则标记振幅误差：$|A_{\\mathrm{LS}} - A_{\\mathrm{nom}}| / A_{\\mathrm{nom}}  0.02$。\n    - 如果拟合的直流失调的幅度 $|\\hat{C}_{dc}|$ 超过半个 LSB，则标记失调误差：$|\\hat{C}_{dc}|  0.5 \\Delta$。\n如果满足任一条件，则设置此标志。\n\n最终的诊断代码是所设标志的总和（$0$：无，$1$：泄漏，$2$：校准，$3$：两者皆有）。\n\n整个方法学被封装在一个程序中，该程序处理指定的测试用例并按要求格式输出结果。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the ADC verification methodology on a suite of test cases.\n    \"\"\"\n\n    def run_adc_analysis(N, Ns, fs, C, alpha, window_name, g, o_val_expr):\n        \"\"\"\n        Performs the complete ADC analysis for a single parameter set.\n        \"\"\"\n        # --- Constants and Derived Parameters ---\n        Vpp = 1.0\n        Delta = Vpp / (2**N)\n        o = eval(o_val_expr, {\"Delta\": Delta}) # Evaluate offset expression\n        fin = C * fs / Ns\n        A_nom = alpha * (Vpp / 2.0)\n        \n        # --- 1. Signal Generation and ADC Model ---\n        n = np.arange(Ns)\n        x = A_nom * np.sin(2 * np.pi * fin * n / fs)\n        \n        # Quantization (mid-tread)\n        q = Delta * np.round(x / Delta)\n        \n        # Apply digital gain and offset\n        y = g * q + o\n\n        # --- 2. Time-Domain SNR Estimation ---\n        # Set up least-squares problem: y = M * beta\n        v_sin = np.sin(2 * np.pi * fin * n / fs)\n        v_cos = np.cos(2 * np.pi * fin * n / fs)\n        v_dc = np.ones(Ns)\n        M = np.vstack([v_sin, v_cos, v_dc]).T\n        \n        # Solve for coefficients [B1, B2, C_dc]\n        beta, residuals, rank, s = np.linalg.lstsq(M, y, rcond=None)\n        B1, B2, C_dc = beta[0], beta[1], beta[2]\n        \n        # Reconstruct signal and calculate powers\n        s_fit = B1 * v_sin + B2 * v_cos\n        P_sig_td = np.mean(s_fit**2)\n        \n        # The residual from lstsq is sum of squares, not mean. We use our definition.\n        noise_td_res = y - (s_fit + C_dc)\n        P_noise_td = np.mean(noise_td_res**2)\n        \n        # Handle case of zero noise to avoid division by zero\n        if P_noise_td  1e-20:\n             snr_td = np.inf\n        else:\n             snr_td = 10 * np.log10(P_sig_td / P_noise_td)\n\n        # --- 3. Frequency-Domain SNR Estimation ---\n        y_detrend = y - np.mean(y)\n        \n        if window_name == 'rectangular':\n            w = np.ones(Ns)\n        elif window_name == 'Hann':\n            w = np.hanning(Ns)\n        elif window_name == 'Blackman':\n            w = np.blackman(Ns)\n        else:\n            raise ValueError(\"Unknown window type\")\n\n        y_w = y_detrend * w\n        X_fft = np.fft.fft(y_w)\n        \n        # Per-bin power spectrum\n        P_spec = (np.abs(X_fft)**2) / (Ns**2)\n\n        # Find peak bin in the positive frequency range [1, Ns/2 - 1]\n        pos_freq_range = slice(1, Ns // 2)\n        k_peak = np.argmax(P_spec[pos_freq_range]) + 1\n        \n        # Define signal bin set S\n        if window_name in ['rectangular', 'Hann']:\n            m = 1\n        else: # Blackman\n            m = 2\n        \n        signal_bins = set()\n        for r in range(-m, m + 1):\n            k = k_peak + r\n            if 1 = k  Ns:\n                signal_bins.add(k)\n                signal_bins.add(Ns - k)\n\n        P_sig_fft = 0\n        P_noise_fft = 0\n        \n        for k in range(1, Ns):\n            if k in signal_bins:\n                P_sig_fft += P_spec[k]\n            else:\n                P_noise_fft += P_spec[k]\n        \n        if P_noise_fft  1e-20:\n            snr_fft = np.inf\n        else:\n            snr_fft = 10 * np.log10(P_sig_fft / P_noise_fft)\n\n        # --- 4. Acceptance Criterion ---\n        accept = 1 if abs(snr_td - snr_fft) = 0.5 else 0\n\n        # --- 5. Discrepancy Diagnosis ---\n        diag_code = 0\n        \n        # Windowing leakage check\n        is_coherent = abs(C - round(C))  1e-6\n        if P_sig_fft + P_noise_fft > 1e-20:\n            rho = P_sig_fft / (P_sig_fft + P_noise_fft)\n        else:\n            rho = 1.0\n\n        if not is_coherent and rho  0.9:\n            diag_code |= 1\n        \n        # Calibration error check\n        A_ls = np.sqrt(B1**2 + B2**2)\n        rel_amp_error = abs(A_ls - A_nom) / A_nom if A_nom > 1e-9 else 0\n        dc_offset_in_lsb = abs(C_dc) / Delta\n        \n        if rel_amp_error > 0.02 or dc_offset_in_lsb > 0.5:\n            diag_code |= 2\n            \n        return [round(snr_td, 3), round(snr_fft, 3), accept, diag_code]\n\n    # Test cases from the problem statement\n    test_cases = [\n        # Case 1: Happy path, coherent, proper window\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205, 'alpha': 0.9, 'window_name': 'Hann', 'g': 1.0, 'o_val_expr': '0.0'},\n        # Case 2: Non-coherent, poor window\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205.5, 'alpha': 0.9, 'window_name': 'rectangular', 'g': 1.0, 'o_val_expr': '0.0'},\n        # Case 3: Calibration errors\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205, 'alpha': 0.9, 'window_name': 'Hann', 'g': 1.05, 'o_val_expr': '0.5 * Delta'},\n        # Case 4: Low-amplitude edge case\n        {'N': 10, 'Ns': 4096, 'fs': 1e6, 'C': 123.3, 'alpha': 2 / (2**10), 'window_name': 'Blackman', 'g': 1.0, 'o_val_expr': '0.0'},\n    ]\n    \n    results = []\n    for case in test_cases:\n        result = run_adc_analysis(**case)\n        results.append(result)\n        \n    # Format the final output as a string representing a list of lists.\n    # e.g., [[val1, val2, ...], [val1, val2, ...]]\n    result_str = '[' + ','.join([str(r) for r in results]) + ']'\n    print(result_str)\n\nsolve()\n```"
        }
    ]
}