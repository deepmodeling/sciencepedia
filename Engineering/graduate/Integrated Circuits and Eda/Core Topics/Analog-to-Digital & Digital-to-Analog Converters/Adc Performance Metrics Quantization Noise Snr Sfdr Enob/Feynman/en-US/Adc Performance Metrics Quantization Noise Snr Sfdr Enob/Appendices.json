{
    "hands_on_practices": [
        {
            "introduction": "Understanding the theoretical performance limit of an Analog-to-Digital Converter is the first step in mastering its application. This exercise guides you through a first-principles derivation of the Signal-to-Noise Ratio ($\\mathrm{SNR}$) for an ideal quantizer, considering only the fundamental noise source: quantization error. By working from the basic definitions of signal power and quantization noise power, you will build the foundational $\\mathrm{SNR}$ formula that serves as the ultimate benchmark for any ADC. ",
            "id": "4255221",
            "problem": "An ideal mid-tread uniform quantizer within an Analog-to-Digital Converter (ADC) with $N$ bits maps a zero-mean input to one of $2^{N}$ equally spaced codes across its full-scale peak-to-peak range $V_{\\mathrm{pp,FS}}$. The least significant bit (LSB) step size is defined as the code spacing implied by this uniform partition. Consider a single-tone, zero-mean sinusoidal input $x(t) = A \\sin(2 \\pi f_{0} t)$ with peak amplitude $A$ that is strictly within the no-overload region of the quantizer so that clipping never occurs. Assume the quantization error is defined as $e(t) = x(t) - \\hat{x}(t)$, where $\\hat{x}(t)$ is the quantized output, and that $e(t)$ is independent of $x(t)$ and is distributed uniformly over its support determined by the step size of the uniform quantizer.\n\nLet $N = 13$, $V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$, and $A = 0.80~\\mathrm{V}$. Treat all powers as time averages over many periods. Work entirely from first principles, starting from the definitions above, including the definition of power for a sinusoid, the definition of LSB from the full-scale range and bit resolution, and the uniform probability density function for the quantization error induced by the ideal uniform quantizer. Do not invoke any formula without derivation from these bases.\n\nTasks:\n- Derive the input’s peak amplitude represented in LSB units.\n- Derive the expected quantization noise power in $\\mathrm{LSB}^{2}$.\n- Derive the signal-to-noise ratio (SNR), defined as the ratio of the sinusoidal signal power to the quantization noise power, expressed in decibels.\n\nReport your final numerical results in the following ordered triple: $\\big[$peak amplitude in LSB, quantization noise power in $\\mathrm{LSB}^{2}$, SNR in $\\mathrm{dB}\\big]$. Express the SNR in decibels and round the SNR to four significant figures. Do not include any units in your final reported triple; units are specified here only for interpretation.",
            "solution": "The problem requires the derivation and calculation of three key performance metrics for an Analog-to-Digital Converter (ADC) based on first principles: the peak input amplitude in units of the least significant bit (LSB), the quantization noise power in units of $\\mathrm{LSB}^2$, and the signal-to-noise ratio (SNR) in decibels. The problem is well-posed and scientifically sound, providing all necessary parameters for a unique solution.\n\nThe given parameters are:\n- ADC resolution: $N = 13$ bits\n- Full-scale peak-to-peak range: $V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$\n- Input signal: $x(t) = A \\sin(2 \\pi f_{0} t)$ with peak amplitude $A = 0.80~\\mathrm{V}$\n\nWe will address each of the three tasks sequentially.\n\nFirst, we derive the peak amplitude of the input signal in LSB units.\nThe fundamental step size of the quantizer, known as the Least Significant Bit (LSB), is defined by uniformly partitioning the full-scale peak-to-peak range $V_{\\mathrm{pp,FS}}$ into $2^N$ levels. The voltage corresponding to one LSB, denoted by $\\Delta$, is therefore:\n$$ \\Delta = \\frac{V_{\\mathrm{pp,FS}}}{2^N} $$\nSubstituting the given values $V_{\\mathrm{pp,FS}} = 2.56~\\mathrm{V}$ and $N = 13$:\n$$ \\Delta = \\frac{2.56}{2^{13}} = \\frac{2.56}{8192}~\\mathrm{V} $$\nThe input signal's peak amplitude is given as $A = 0.80~\\mathrm{V}$. To express this amplitude in LSB units, which we denote as $A_{\\mathrm{LSB}}$, we compute the ratio of $A$ to $\\Delta$:\n$$ A_{\\mathrm{LSB}} = \\frac{A}{\\Delta} = \\frac{0.80~\\mathrm{V}}{\\frac{2.56}{8192}~\\mathrm{V}} = \\frac{0.80 \\times 8192}{2.56} $$\nWe can simplify the ratio $\\frac{0.80}{2.56}$ as $\\frac{80}{256} = \\frac{5 \\times 16}{16 \\times 16} = \\frac{5}{16}$.\n$$ A_{\\mathrm{LSB}} = \\frac{5}{16} \\times 8192 = 5 \\times \\frac{8192}{16} = 5 \\times 512 = 2560 $$\nThus, the peak amplitude of the input sinusoid is $2560$ LSBs. The condition that clipping does not occur is satisfied, as the full-scale peak amplitude is $\\frac{V_{\\mathrm{pp,FS}}}{2} = \\frac{2.56}{2} = 1.28~\\mathrm{V}$, and $A = 0.80~\\mathrm{V} < 1.28~\\mathrm{V}$. Also, in LSB units, the full scale peak amplitude is $\\frac{A_{FS}}{ \\Delta} = \\frac{1.28}{\\Delta} = \\frac{1.28 \\times 8192}{2.56} = \\frac{1}{2}\\times 8192 = 4096$ LSBs. $A_{\\mathrm{LSB}} = 2560 < 4096$.\n\nSecond, we derive the expected quantization noise power in units of $\\mathrm{LSB}^2$.\nThe problem states that the quantization error, $e(t) = x(t) - \\hat{x}(t)$, is uniformly distributed over its support. For an ideal uniform mid-tread quantizer with step size $\\Delta$, the error for any input value is confined to the interval $[-\\frac{\\Delta}{2}, +\\frac{\\Delta}{2}]$. The probability density function (PDF) of the error, $p(e)$, is therefore:\n$$ p(e) = \\begin{cases} \\frac{1}{\\Delta} & \\text{for } -\\frac{\\Delta}{2} \\le e \\le \\frac{\\Delta}{2} \\\\ 0 & \\text{otherwise} \\end{cases} $$\nThe quantization noise power, $P_n$, is the mean-square value of the error, $E[e^2]$. For a zero-mean process, this is equal to its variance. The mean of the error is indeed zero due to the symmetric distribution around zero: $E[e] = \\int_{-\\infty}^{\\infty} e \\, p(e) \\, de = \\int_{-\\Delta/2}^{\\Delta/2} e \\, \\frac{1}{\\Delta} \\, de = 0$.\nThe noise power is calculated as:\n$$ P_n = E[e^2] = \\int_{-\\infty}^{\\infty} e^2 p(e) \\, de = \\int_{-\\Delta/2}^{\\Delta/2} e^2 \\frac{1}{\\Delta} \\, de $$\n$$ P_n = \\frac{1}{\\Delta} \\left[ \\frac{e^3}{3} \\right]_{-\\Delta/2}^{\\Delta/2} = \\frac{1}{3\\Delta} \\left[ \\left(\\frac{\\Delta}{2}\\right)^3 - \\left(-\\frac{\\Delta}{2}\\right)^3 \\right] $$\n$$ P_n = \\frac{1}{3\\Delta} \\left[ \\frac{\\Delta^3}{8} - \\left(-\\frac{\\Delta^3}{8}\\right) \\right] = \\frac{1}{3\\Delta} \\left( \\frac{2\\Delta^3}{8} \\right) = \\frac{\\Delta^2}{12} $$\nThis is the noise power in units of $\\mathrm{V}^2$. The problem asks for the power in units of $\\mathrm{LSB}^2$. Since $1~\\mathrm{LSB}$ corresponds to a voltage of $\\Delta$, $1~\\mathrm{LSB}^2$ corresponds to a power of $\\Delta^2~\\mathrm{V}^2$. To convert $P_n$ to units of $\\mathrm{LSB}^2$, we divide by $\\Delta^2$:\n$$ P_{n, \\mathrm{LSB}^2} = \\frac{P_n}{\\Delta^2} = \\frac{\\Delta^2/12}{\\Delta^2} = \\frac{1}{12} $$\nThe quantization noise power is $\\frac{1}{12}~\\mathrm{LSB}^2$, a result that is independent of the specific ADC parameters, given the model.\n\nThird, we derive the Signal-to-Noise Ratio (SNR) in decibels.\nThe power of the sinusoidal input signal $x(t) = A \\sin(2 \\pi f_0 t)$ is its mean-square value, computed by averaging over one period $T = 1/f_0$:\n$$ P_s = \\frac{1}{T} \\int_0^T x(t)^2 \\, dt = \\frac{1}{T} \\int_0^T \\left( A \\sin(2 \\pi f_0 t) \\right)^2 \\, dt = \\frac{A^2}{T} \\int_0^T \\sin^2(2 \\pi f_0 t) \\, dt $$\nUsing the trigonometric identity $\\sin^2(\\theta) = \\frac{1}{2}(1 - \\cos(2\\theta))$, the integral becomes:\n$$ P_s = \\frac{A^2}{T} \\int_0^T \\frac{1}{2}(1 - \\cos(4 \\pi f_0 t)) \\, dt = \\frac{A^2}{2T} \\left[ t - \\frac{\\sin(4 \\pi f_0 t)}{4 \\pi f_0} \\right]_0^T $$\n$$ P_s = \\frac{A^2}{2T} \\left[ (T - 0) - (0 - 0) \\right] = \\frac{A^2}{2} $$\nThe SNR is the ratio of the signal power $P_s$ to the quantization noise power $P_n$. It is essential to use powers in the same units (e.g., $\\mathrm{V}^2$).\n$$ \\mathrm{SNR} = \\frac{P_s}{P_n} = \\frac{A^2/2}{\\Delta^2/12} = \\frac{6A^2}{\\Delta^2} = 6 \\left(\\frac{A}{\\Delta}\\right)^2 $$\nFrom our first task, we found that $\\frac{A}{\\Delta} = A_{\\mathrm{LSB}} = 2560$. Substituting this value:\n$$ \\mathrm{SNR} = 6 \\times (2560)^2 = 6 \\times 6553600 = 39321600 $$\nThe SNR in decibels ($\\mathrm{dB}$) is defined as $10$ times the base-$10$ logarithm of the power ratio:\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}(\\mathrm{SNR}) = 10 \\log_{10}(39321600) $$\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}(3.93216 \\times 10^7) = 10 \\left( \\log_{10}(3.93216) + \\log_{10}(10^7) \\right) $$\n$$ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\left( \\log_{10}(3.93216) + 7 \\right) \\approx 10(0.5946268 + 7) = 10(7.5946268) \\approx 75.946268 $$\nRounding the result to four significant figures as requested gives $75.95$.\n\nThe final results for the three tasks are: a peak amplitude of $2560$ LSBs, a quantization noise power of $\\frac{1}{12}~\\mathrm{LSB}^2$, and an SNR of $75.95~\\mathrm{dB}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 2560 & \\frac{1}{12} & 75.95 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "In practice, an ADC's performance is limited by more than just its resolution. This exercise moves beyond the ideal model to explore one of the most critical non-idealities in high-speed data conversion: sampling clock jitter. You will derive the relationship between the RMS timing error, $\\sigma_t$, of the clock and the resulting $\\mathrm{SNR}$, and then apply this model to determine the stringent jitter requirements for a high-frequency application. ",
            "id": "4255227",
            "problem": "An analog-to-digital converter (ADC) digitizes a single-tone sinusoidal input of frequency $f_{\\mathrm{in}} = 100\\,\\text{MHz}$. The sampling clock exhibits independent, zero-mean, random edge timing error with root-mean-square (RMS) value $\\sigma_{t}$, which is uncorrelated with the input and stationary. Assume the following:\n- The input is $x(t) = A \\sin(2\\pi f_{\\mathrm{in}} t)$, with finite, nonzero amplitude $A$.\n- Quantization noise and thermal noise are negligible compared to sampling jitter effects.\n- The sampling jitter is sufficiently small so that a first-order time-perturbation approximation of the sampling operation is valid, i.e., $2\\pi f_{\\mathrm{in}} \\sigma_{t} \\ll 1$.\n- The Signal-to-Noise Ratio (SNR) in decibels is defined by $\\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}\\!\\big(P_{\\mathrm{signal}}/P_{\\mathrm{noise}}\\big)$, where $P_{\\mathrm{signal}}$ and $P_{\\mathrm{noise}}$ are time-averaged powers.\n\nStarting from the small-perturbation model of sampling in time and the definition of RMS for sinusoidal signals, derive the expression for the SNR limited solely by sampling clock jitter as a function of $f_{\\mathrm{in}}$ and $\\sigma_{t}$. Then, enforce the requirement that the SNR at $f_{\\mathrm{in}} = 100\\,\\text{MHz}$ be at least $70\\,\\text{dB}$ and compute the corresponding maximum allowable RMS jitter $\\sigma_{t}$.\n\nExpress your final numerical answer for the maximum allowable $\\sigma_{t}$ in femtoseconds, and round your answer to four significant figures.",
            "solution": "We begin with the input sinusoid $x(t) = A \\sin(2\\pi f_{\\mathrm{in}} t)$. Suppose the sampling instant has a small random timing error $\\Delta t$ with RMS value $\\sigma_{t}$, zero mean, and independent of the input. Under the small-perturbation assumption, we linearize the sampling operation about the ideal time:\n$$\nx(t+\\Delta t) \\approx x(t) + x'(t)\\,\\Delta t,\n$$\nso the sampling error due to jitter is\n$$\ne(t) \\approx x'(t)\\,\\Delta t.\n$$\nFor $x(t) = A \\sin(2\\pi f_{\\mathrm{in}} t)$, the time derivative is\n$$\nx'(t) = 2\\pi f_{\\mathrm{in}} A \\cos\\!\\big(2\\pi f_{\\mathrm{in}} t\\big).\n$$\nHence,\n$$\ne(t) \\approx 2\\pi f_{\\mathrm{in}} A \\cos\\!\\big(2\\pi f_{\\mathrm{in}} t\\big)\\,\\Delta t.\n$$\nWe compute the RMS values. The RMS of the sinusoid $x(t)$ is\n$$\nx_{\\mathrm{rms}} = \\frac{A}{\\sqrt{2}}.\n$$\nAssuming that $\\Delta t$ is independent of $\\cos(2\\pi f_{\\mathrm{in}} t)$ and that the phase of the sinusoid is effectively uniformly distributed over $[0,2\\pi)$ in the time averaging, the RMS of the error is\n$$\ne_{\\mathrm{rms}} = \\sqrt{\\mathbb{E}\\{e(t)^{2}\\}} = \\sqrt{\\mathbb{E}\\{(2\\pi f_{\\mathrm{in}} A \\cos(2\\pi f_{\\mathrm{in}} t)\\,\\Delta t)^{2}\\}}.\n$$\nIndependence and stationarity give\n$$\ne_{\\mathrm{rms}} = 2\\pi f_{\\mathrm{in}} A \\sqrt{\\mathbb{E}\\{\\cos^{2}(2\\pi f_{\\mathrm{in}} t)\\}} \\,\\sqrt{\\mathbb{E}\\{\\Delta t^{2}\\}} = 2\\pi f_{\\mathrm{in}} A \\cdot \\frac{1}{\\sqrt{2}} \\cdot \\sigma_{t} = \\frac{2\\pi f_{\\mathrm{in}} A \\sigma_{t}}{\\sqrt{2}}.\n$$\nTherefore, the jitter-limited Signal-to-Noise Ratio (as a power ratio) is\n$$\n\\mathrm{SNR} = \\frac{x_{\\mathrm{rms}}^{2}}{e_{\\mathrm{rms}}^{2}} = \\frac{\\left(\\frac{A}{\\sqrt{2}}\\right)^{2}}{\\left(\\frac{2\\pi f_{\\mathrm{in}} A \\sigma_{t}}{\\sqrt{2}}\\right)^{2}} = \\frac{1}{(2\\pi f_{\\mathrm{in}} \\sigma_{t})^{2}}.\n$$\nConverting to decibels using $\\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}(\\mathrm{SNR})$ yields\n$$\n\\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}\\!\\left(\\frac{1}{(2\\pi f_{\\mathrm{in}} \\sigma_{t})^{2}}\\right) = -20 \\log_{10}\\!\\big(2\\pi f_{\\mathrm{in}} \\sigma_{t}\\big).\n$$\nTo ensure $\\mathrm{SNR}_{\\mathrm{dB}} \\geq 70\\,\\text{dB}$ at $f_{\\mathrm{in}} = 100\\,\\text{MHz}$, we require\n$$\n-20 \\log_{10}\\!\\big(2\\pi f_{\\mathrm{in}} \\sigma_{t}\\big) \\geq 70 \\;\\;\\Longleftrightarrow\\;\\; \\log_{10}\\!\\big(2\\pi f_{\\mathrm{in}} \\sigma_{t}\\big) \\leq -\\frac{70}{20} = -3.5.\n$$\nExponentiating base $10$,\n$$\n2\\pi f_{\\mathrm{in}} \\sigma_{t} \\leq 10^{-3.5} = \\frac{1}{10^{3.5}} = \\frac{1}{10^{70/20}}.\n$$\nThus, the maximum allowable RMS jitter is\n$$\n\\sigma_{t,\\max} = \\frac{1}{2\\pi f_{\\mathrm{in}} \\, 10^{70/20}}.\n$$\nNow substitute $f_{\\mathrm{in}} = 100\\,\\text{MHz} = 100 \\times 10^{6}\\,\\text{Hz}$:\n$$\n\\sigma_{t,\\max} = \\frac{1}{2\\pi \\cdot (100 \\times 10^{6}) \\cdot 10^{70/20}}.\n$$\nCompute $10^{70/20} = 10^{3.5} \\approx 3162.277660$, and $2\\pi \\cdot 100 \\times 10^{6} \\approx 6.283185307 \\times 10^{8}$. Therefore,\n$\n2\\pi f_{\\mathrm{in}} \\cdot 10^{70/20} \\approx (6.283185307 \\times 10^{8}) \\cdot 3162.277660 \\approx 1.986917652 \\times 10^{12},\n$\nand\n$$\n\\sigma_{t,\\max} \\approx \\frac{1}{1.986917652 \\times 10^{12}} \\,\\text{s} \\approx 5.033164543 \\times 10^{-13}\\,\\text{s}.\n$$\nConverting seconds to femtoseconds using $1\\,\\text{fs} = 10^{-15}\\,\\text{s}$,\n$\n\\sigma_{t,\\max} \\approx 5.033164543 \\times 10^{-13}\\,\\text{s} \\times 10^{15}\\,\\text{fs/s} \\approx 503.3164543\\,\\text{fs}.\n$\nRounded to four significant figures, the maximum allowable RMS jitter is $503.3\\,\\text{fs}$.",
            "answer": "$$\\boxed{503.3}$$"
        },
        {
            "introduction": "Bridging the gap between theory and application requires robust methods for measurement and verification. This comprehensive coding exercise challenges you to build a verification suite that compares two distinct Signal-to-Noise Ratio ($\\mathrm{SNR}$) estimation techniques: time-domain least-squares fitting and frequency-domain FFT analysis. By implementing this methodology and running it against various test cases, you will gain practical skills in diagnosing common measurement pitfalls such as spectral leakage and calibration errors. ",
            "id": "4255222",
            "problem": "You are tasked with building a rigorous verification methodology for an Analog-to-Digital Converter (ADC) model that compares two Signal-to-Noise Ratio (SNR) estimators: a time-domain estimator based on model fitting, and a frequency-domain estimator based on the Discrete Fourier Transform (DFT). You must define acceptance criteria for agreement within $0.5$ dB and diagnose discrepancies attributable to windowing choices or calibration errors. The solution must be derived from first principles and implemented as a complete, runnable program.\n\nBegin from the following fundamental bases and core definitions:\n\n- The ADC is an $N$-bit uniform quantizer with full-scale peak-to-peak voltage $V_{\\mathrm{pp}}$. The Least Significant Bit (LSB) step size is $\\Delta = V_{\\mathrm{pp}} / 2^N$.\n- The input is a discrete-time sinusoid $x[n] = A \\sin(2\\pi f_{\\mathrm{in}} n / f_s)$ with $A$ expressed relative to $V_{\\mathrm{pp}}/2$, sampled at rate $f_s$, over $N_s$ samples. A digital gain error $g$ and a digital offset error $o$ may be applied after quantization such that the reported digital output is $y[n] = g \\cdot q[n] + o$, where $q[n]$ is the quantized value in volts, clipped to the ADC range.\n- Signal-to-Noise Ratio (SNR) is defined as $ \\mathrm{SNR}_{\\mathrm{dB}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig}}}{P_{\\mathrm{noise}}}\\right) $, where $P_{\\mathrm{sig}}$ is the signal power and $P_{\\mathrm{noise}}$ is the noise power.\n- The discrete-time DFT of a windowed sequence $x_w[n] = w[n] \\cdot x[n]$ is $X[k] = \\sum_{n=0}^{N_s-1} x_w[n] e^{-j 2\\pi k n / N_s}$. Parseval’s theorem relates the time-domain energy to the frequency-domain energy by $\\sum_{n=0}^{N_s-1} |x_w[n]|^2 = \\frac{1}{N_s} \\sum_{k=0}^{N_s-1} |X[k]|^2$. The average power is the time-domain energy divided by $N_s$, which equals $\\frac{1}{N_s^2} \\sum_{k=0}^{N_s-1} |X[k]|^2$.\n- Coherent sampling occurs when the tone completes an integer number of cycles in $N_s$ samples, that is, when $C = f_{\\mathrm{in}} N_s / f_s$ is an integer. Otherwise, energy leaks across bins (spectral leakage), which depends on the window $w[n]$.\n\nImplement the following methodology:\n\n1. Generate an ideal sinusoid $x[n]$ at frequency $f_{\\mathrm{in}}$ and amplitude $A = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$, where $\\alpha$ is the amplitude fraction. Quantize $x[n]$ using mid-tread rounding to $q[n]$ with step $\\Delta$, clipped to $[-V_{\\mathrm{pp}}/2, V_{\\mathrm{pp}}/2]$. Apply a digital gain $g$ and offset $o$ to produce $y[n] = g \\cdot q[n] + o$.\n2. Time-domain SNR estimation: Fit $y[n]$ with a single-tone model that includes unknown amplitude, phase, and DC offset using least squares. Use the basis functions $\\sin(2\\pi f_{\\mathrm{in}} n / f_s)$, $\\cos(2\\pi f_{\\mathrm{in}} n / f_s)$, and $1$ to obtain coefficients $B_1$, $B_2$, and $C$. The fitted signal is $s_{\\mathrm{fit}}[n] = B_1 \\sin(2\\pi f_{\\mathrm{in}} n / f_s) + B_2 \\cos(2\\pi f_{\\mathrm{in}} n / f_s)$ and DC component $C$. Compute $P_{\\mathrm{sig,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} s_{\\mathrm{fit}}[n]^2$ and $P_{\\mathrm{noise,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} (y[n] - C - s_{\\mathrm{fit}}[n])^2$. Then $\\mathrm{SNR}_{\\mathrm{td}} = 10 \\log_{10} \\left( \\frac{P_{\\mathrm{sig,td}}}{P_{\\mathrm{noise,td}}} \\right)$.\n3. Frequency-domain SNR estimation: Remove the mean from $y[n]$, apply a specified window $w[n]$ (rectangular, Hann, or Blackman), compute the DFT $X[k]$, and the per-bin energy $E[k] = |X[k]|^2 / N_s^2$. Identify the fundamental bin index $k_{\\mathrm{peak}}$ in the positive-frequency range $k \\in [1, \\lfloor N_s/2 \\rfloor - 1]$. Define a main-lobe capture width $m$ depending on the window (for rectangular and Hann, $m=1$; for Blackman, $m=2$). Form the signal bin set $\\mathcal{S}$ that includes $k_{\\mathrm{peak}} + r$ for $r \\in [-m, m]$ and their symmetric counterparts $N_s - (k_{\\mathrm{peak}} + r)$, clipped to valid indices, and exclude DC ($k=0$). Compute $P_{\\mathrm{sig,fft}} = \\sum_{k \\in \\mathcal{S}} E[k]$, $P_{\\mathrm{noise,fft}} = \\sum_{k \\notin \\mathcal{S}, k \\neq 0} E[k]$, and $\\mathrm{SNR}_{\\mathrm{fft}} = 10 \\log_{10} \\left( \\frac{P_{\\mathrm{sig,fft}}}{P_{\\mathrm{noise,fft}}} \\right)$.\n4. Acceptance criterion: The two SNR estimates agree if $|\\mathrm{SNR}_{\\mathrm{td}} - \\mathrm{SNR}_{\\mathrm{fft}}| \\le 0.5$ dB.\n5. Discrepancy diagnosis:\n   - Windowing leakage suspected if sampling is non-coherent (i.e., $C$ is not an integer within a tolerance) and the captured signal energy fraction $\\rho = P_{\\mathrm{sig,fft}} / (P_{\\mathrm{sig,fft}} + P_{\\mathrm{noise,fft}})$ is below a threshold (e.g., $\\rho < 0.9$), especially for rectangular windows.\n   - Calibration error suspected if the least-squares amplitude $A_{\\mathrm{LS}} = \\sqrt{B_1^2 + B_2^2}$ differs from the nominal analog amplitude $A_{\\mathrm{nom}} = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$ by more than a relative threshold (e.g., $|A_{\\mathrm{LS}} - A_{\\mathrm{nom}}| / A_{\\mathrm{nom}} > 0.02$), or if the fitted DC $C$ deviates by more than $0.5$ LSB (i.e., $|C| > 0.5 \\Delta$).\n   - Combine flags to produce a diagnosis code: $0$ for no issue, $1$ for windowing leakage suspected, $2$ for calibration error suspected, $3$ for both.\n\nUse $V_{\\mathrm{pp}} = 1$ V so that $\\Delta = 1/2^N$ V, and express all SNR values in dB, rounded to three decimal places. Angles, if any, must be in radians.\n\nTest Suite:\nImplement the methodology for the following parameter sets to validate different facets:\n- Case $1$ (happy path, coherent, proper window): $N = 12$, $N_s = 4096$, $f_s = 10^6$ Hz, $C = 205$ cycles, $f_{\\mathrm{in}} = C \\cdot f_s / N_s$, $\\alpha = 0.9$, window = Hann, $g = 1.0$, $o = 0.0$ V.\n- Case $2$ (non-coherent, poor window): $N = 12$, $N_s = 4096$, $f_s = 10^6$ Hz, $C = 205.5$ cycles, $f_{\\mathrm{in}} = C \\cdot f_s / N_s$, $\\alpha = 0.9$, window = rectangular, $g = 1.0$, $o = 0.0$ V.\n- Case $3$ (calibration errors): $N = 12$, $N_s = 4096$, $f_s = 10^6$ Hz, $C = 205$ cycles, $f_{\\mathrm{in}} = C \\cdot f_s / N_s$, $\\alpha = 0.9$, window = Hann, $g = 1.05$, $o = 0.5 \\Delta$ V.\n- Case $4$ (low-amplitude edge case): $N = 10$, $N_s = 4096$, $f_s = 10^6$ Hz, $C = 123.3$ cycles, $f_{\\mathrm{in}} = C \\cdot f_s / N_s$, $\\alpha = 2 / 2^{10}$, window = Blackman, $g = 1.0$, $o = 0.0$ V.\n\nYour program should produce a single line of output containing the results as a comma-separated Python-style list of lists, one per test case, with entries in the order $[\\mathrm{SNR}_{\\mathrm{td}}, \\mathrm{SNR}_{\\mathrm{fft}}, \\mathrm{accept}, \\mathrm{diag}]$, where $\\mathrm{accept}$ is $1$ for true and $0$ for false, and $\\mathrm{diag}$ is the diagnosis code described above. For example, the final format should look like $[[x_1,y_1,a_1,d_1],[x_2,y_2,a_2,d_2],...]$, with $\\mathrm{SNR}$ values rounded to three decimals.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically grounded in the principles of digital signal processing and analog-to-digital converter characterization. The problem is well-posed, providing a clear, self-contained, and formalizable set of instructions to implement a verification methodology. The test cases are well-designed to probe specific aspects of the methodology, such as coherent vs. non-coherent sampling, windowing effects, and calibration errors. Minor ambiguities, such as the term \"rectangular Hann\" and the tolerance for checking integer cycles, are resolved by reasonable interpretation based on context. \"rectangular Hann (Hann)\" is taken to mean the Hann window, and a small numerical tolerance is assumed for floating-point comparisons. The outlined methodology is sound and can be implemented to produce a unique and meaningful solution.\n\nThe implementation will proceed by systematically following the steps defined in the problem statement.\n\n### 1. Signal Generation and ADC Model\n\nFirst, we generate the discrete-time input signal and process it through the ADC model.\n\nThe time vector is defined for $N_s$ samples as $n = 0, 1, \\dots, N_s-1$.\nThe input sinusoid is given by:\n$$\nx[n] = A \\sin\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right)\n$$\nwhere the amplitude is $A = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$ and the input frequency is $f_{\\mathrm{in}} = C \\cdot f_s / N_s$. With $V_{\\mathrm{pp}} = 1$ V, this simplifies to $A = \\alpha/2$.\n\nThe ADC is an $N$-bit uniform quantizer with a Least Significant Bit (LSB) step size of $\\Delta = V_{\\mathrm{pp}} / 2^N = 1/2^N$. The problem specifies a mid-tread quantizer. The quantization process is modeled by rounding the input voltage, scaled by the LSB size, to the nearest integer multiple of $\\Delta$.\n$$\nq[n] = \\Delta \\cdot \\left\\lfloor \\frac{x[n]}{\\Delta} + 0.5 \\right\\rfloor = \\Delta \\cdot \\mathrm{round}\\left(\\frac{x[n]}{\\Delta}\\right)\n$$\nThe problem statement mentions clipping $q[n]$ to the range $[-V_{\\mathrm{pp}}/2, V_{\\mathrm{pp}}/2]$. However, for all test cases provided, the input amplitude fraction $\\alpha \\le 1$, which ensures the input signal $x[n]$ is within the ADC's full-scale range. Consequently, the quantized output $q[n]$ will also reside within this range, making the clipping operation redundant for the given parameters.\n\nFinally, digital gain ($g$) and offset ($o$) errors are applied to the quantized signal to produce the final output:\n$$\ny[n] = g \\cdot q[n] + o\n$$\n\n### 2. Time-Domain SNR Estimation ($\\mathrm{SNR}_{\\mathrm{td}}$)\n\nThis method estimates SNR by fitting a parametric model to the output data $y[n]$. The model is a pure sinusoid with a DC offset, at the known input frequency $f_{\\mathrm{in}}$.\n$$\ny_{\\mathrm{model}}[n] = B_1 \\sin\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right) + B_2 \\cos\\left(\\frac{2\\pi f_{\\mathrm{in}} n}{f_s}\\right) + C_{dc}\n$$\nThe unknown coefficients $\\beta = [B_1, B_2, C_{dc}]^T$ are determined by minimizing the sum of squared errors between $y[n]$ and $y_{\\mathrm{model}}[n]$. This is a linear least-squares problem, which can be expressed in matrix form as $\\mathbf{y} = \\mathbf{M}\\beta$, where $\\mathbf{y}$ is the vector of $y[n]$ samples and $\\mathbf{M}$ is a matrix whose columns are the basis functions:\n$$\n\\mathbf{M} = \\begin{bmatrix}\n\\sin(\\omega_0 \\cdot 0) & \\cos(\\omega_0 \\cdot 0) & 1 \\\\\n\\sin(\\omega_0 \\cdot 1) & \\cos(\\omega_0 \\cdot 1) & 1 \\\\\n\\vdots & \\vdots & \\vdots \\\\\n\\sin(\\omega_0 \\cdot (N_s-1)) & \\cos(\\omega_0 \\cdot (N_s-1)) & 1\n\\end{bmatrix}\n$$\nwhere $\\omega_0 = 2\\pi f_{\\mathrm{in}}/f_s$. The least-squares solution for the coefficients is $\\hat{\\beta} = (\\mathbf{M}^T\\mathbf{M})^{-1}\\mathbf{M}^T\\mathbf{y}$.\n\nOnce the coefficients $\\hat{B}_1, \\hat{B}_2, \\hat{C}_{dc}$ are found, the signal and noise components are separated. The fitted signal component (AC part) is:\n$$\ns_{\\mathrm{fit}}[n] = \\hat{B}_1 \\sin(\\omega_0 n) + \\hat{B}_2 \\cos(\\omega_0 n)\n$$\nThe residual error, which represents the noise, is:\n$$\ne[n] = y[n] - (s_{\\mathrm{fit}}[n] + \\hat{C}_{dc})\n$$\nThe average power of the signal and noise are calculated as:\n$$\nP_{\\mathrm{sig,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} s_{\\mathrm{fit}}[n]^2\n\\quad \\text{and} \\quad\nP_{\\mathrm{noise,td}} = \\frac{1}{N_s} \\sum_{n=0}^{N_s-1} e[n]^2\n$$\nThe time-domain SNR in decibels is then:\n$$\n\\mathrm{SNR}_{\\mathrm{td}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig,td}}}{P_{\\mathrm{noise,td}}}\\right)\n$$\n\n### 3. Frequency-Domain SNR Estimation ($\\mathrm{SNR}_{\\mathrm{fft}}$)\n\nThis method estimates SNR from the Discrete Fourier Transform (DFT) of the signal.\n\nFirst, the mean of the output signal is removed to isolate the AC components: $y'[n] = y[n] - \\bar{y}$, where $\\bar{y} = \\frac{1}{N_s}\\sum_{n=0}^{N_s-1} y[n]$.\nNext, a window function $w[n]$ is applied to the detrended signal to reduce spectral leakage in the case of non-coherent sampling: $y_w[n] = y'[n] \\cdot w[n]$. The problem specifies rectangular, Hann, or Blackman windows.\n\nThe DFT of the windowed sequence is computed:\n$$\nX[k] = \\sum_{n=0}^{N_s-1} y_w[n] e^{-j 2\\pi kn / N_s}\n$$\nAccording to the problem's definition, which is consistent with Parseval's theorem, the power in each frequency bin $k$ is:\n$$\nP_{spec}[k] = \\frac{|X[k]|^2}{N_s^2}\n$$\nThe total average power of the windowed signal is $\\sum_{k=0}^{N_s-1} P_{spec}[k]$.\n\nTo separate signal from noise, we identify the fundamental frequency peak. The bin index $k_{\\mathrm{peak}}$ corresponding to the maximum power in the positive frequency range, $k \\in [1, \\lfloor N_s/2 \\rfloor - 1]$, is located. A set of bins $\\mathcal{S}$ around the peak and its negative-frequency image are designated as signal bins. This set includes bins $k_{\\mathrm{peak}} + r$ for $r \\in [-m, m]$ and their symmetric counterparts $N_s - (k_{\\mathrm{peak}} + r)$, where $m$ is the main-lobe capture width ($m=1$ for rectangular/Hann, $m=2$ for Blackman). The DC bin ($k=0$) is excluded.\n\nThe signal power is the sum of power in the signal bins, and the noise power is the sum of power in all other non-DC bins:\n$$\nP_{\\mathrm{sig,fft}} = \\sum_{k \\in \\mathcal{S}} P_{spec}[k]\n\\quad \\text{and} \\quad\nP_{\\mathrm{noise,fft}} = \\sum_{k \\notin \\mathcal{S}, k \\neq 0} P_{spec}[k]\n$$\nThe frequency-domain SNR in decibels is:\n$$\n\\mathrm{SNR}_{\\mathrm{fft}} = 10 \\log_{10}\\left(\\frac{P_{\\mathrm{sig,fft}}}{P_{\\mathrm{noise,fft}}}\\right)\n$$\n\n### 4. Acceptance and Discrepancy Diagnosis\n\nThe two SNR estimates are compared. The test is accepted if their absolute difference is within a $0.5$ dB threshold:\n$$\n|\\mathrm{SNR}_{\\mathrm{td}} - \\mathrm{SNR}_{\\mathrm{fft}}| \\le 0.5\n$$\n\nIf the estimates disagree, a diagnosis is performed to identify the likely cause.\nA binary diagnosis code is formed:\n- **Windowing Leakage (flag=1):** This is suspected if sampling is non-coherent and the signal energy is \"leaking\" into adjacent bins. Coherence is checked by testing if the number of cycles $C$ is an integer (within a small tolerance, e.g., $10^{-6}$). Leakage is quantified by the captured signal energy fraction $\\rho = P_{\\mathrm{sig,fft}} / (P_{\\mathrm{sig,fft}} + P_{\\mathrm{noise,fft}})$. If sampling is non-coherent and $\\rho < 0.9$, this flag is set.\n- **Calibration Error (flag=2):** This is suspected if there's a significant gain or offset error.\n    - An amplitude error is flagged if the relative difference between the least-squares fitted amplitude $A_{\\mathrm{LS}} = \\sqrt{\\hat{B}_1^2 + \\hat{B}_2^2}$ and the nominal analog amplitude $A_{\\mathrm{nom}} = \\alpha \\cdot (V_{\\mathrm{pp}}/2)$ exceeds $2\\%$: $|A_{\\mathrm{LS}} - A_{\\mathrm{nom}}| / A_{\\mathrm{nom}} > 0.02$.\n    - An offset error is flagged if the magnitude of the fitted DC offset $|\\hat{C}_{dc}|$ exceeds half an LSB: $|\\hat{C}_{dc}| > 0.5 \\Delta$.\nIf either condition is met, this flag is set.\n\nThe final diagnosis code is the sum of the set flags ($0$: None, $1$: Leakage, $2$: Calibration, $3$: Both).\n\nThe entire methodology is encapsulated into a program that processes the specified test cases and outputs the results in the required format.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the ADC verification methodology on a suite of test cases.\n    \"\"\"\n\n    def run_adc_analysis(N, Ns, fs, C, alpha, window_name, g, o_val_expr):\n        \"\"\"\n        Performs the complete ADC analysis for a single parameter set.\n        \"\"\"\n        # --- Constants and Derived Parameters ---\n        Vpp = 1.0\n        Delta = Vpp / (2**N)\n        o = eval(o_val_expr, {\"Delta\": Delta}) # Evaluate offset expression\n        fin = C * fs / Ns\n        A_nom = alpha * (Vpp / 2.0)\n        \n        # --- 1. Signal Generation and ADC Model ---\n        n = np.arange(Ns)\n        x = A_nom * np.sin(2 * np.pi * fin * n / fs)\n        \n        # Quantization (mid-tread)\n        q = Delta * np.round(x / Delta)\n        \n        # Apply digital gain and offset\n        y = g * q + o\n\n        # --- 2. Time-Domain SNR Estimation ---\n        # Set up least-squares problem: y = M * beta\n        v_sin = np.sin(2 * np.pi * fin * n / fs)\n        v_cos = np.cos(2 * np.pi * fin * n / fs)\n        v_dc = np.ones(Ns)\n        M = np.vstack([v_sin, v_cos, v_dc]).T\n        \n        # Solve for coefficients [B1, B2, C_dc]\n        beta, residuals, rank, s = np.linalg.lstsq(M, y, rcond=None)\n        B1, B2, C_dc = beta[0], beta[1], beta[2]\n        \n        # Reconstruct signal and calculate powers\n        s_fit = B1 * v_sin + B2 * v_cos\n        P_sig_td = np.mean(s_fit**2)\n        \n        # The residual from lstsq is sum of squares, not mean. We use our definition.\n        noise_td_res = y - (s_fit + C_dc)\n        P_noise_td = np.mean(noise_td_res**2)\n        \n        # Handle case of zero noise to avoid division by zero\n        if P_noise_td < 1e-20:\n             snr_td = np.inf\n        else:\n             snr_td = 10 * np.log10(P_sig_td / P_noise_td)\n\n        # --- 3. Frequency-Domain SNR Estimation ---\n        y_detrend = y - np.mean(y)\n        \n        if window_name == 'rectangular':\n            w = np.ones(Ns)\n        elif window_name == 'Hann':\n            w = np.hanning(Ns)\n        elif window_name == 'Blackman':\n            w = np.blackman(Ns)\n        else:\n            raise ValueError(\"Unknown window type\")\n\n        y_w = y_detrend * w\n        X_fft = np.fft.fft(y_w)\n        \n        # Per-bin power spectrum, accounting for window gain\n        # For SNR, relative powers matter, so coherent gain correction isn't strictly needed\n        # if both signal and noise are summed from the same spectrum.\n        # But for accurate power reporting, it would be needed.\n        # The problem defines power based on Parseval's theorem which doesn't include window gain correction.\n        P_spec = (np.abs(X_fft)**2) / (Ns**2)\n\n        # Find peak bin in the positive frequency range [1, Ns/2 - 1]\n        pos_freq_range = slice(1, Ns // 2)\n        k_peak = np.argmax(P_spec[pos_freq_range]) + 1\n        \n        # Define signal bin set S\n        if window_name in ['rectangular', 'Hann']:\n            m = 1\n        else: # Blackman\n            m = 2\n        \n        signal_bins = set()\n        for r in range(-m, m + 1):\n            k = k_peak + r\n            if 1 <= k < Ns:\n                signal_bins.add(k)\n                signal_bins.add(Ns - k)\n\n        P_sig_fft = 0\n        P_noise_fft = 0\n        \n        for k in range(1, Ns):\n            if k in signal_bins:\n                P_sig_fft += P_spec[k]\n            else:\n                P_noise_fft += P_spec[k]\n        \n        if P_noise_fft < 1e-20:\n            snr_fft = np.inf\n        else:\n            snr_fft = 10 * np.log10(P_sig_fft / P_noise_fft)\n\n        # --- 4. Acceptance Criterion ---\n        accept = 1 if abs(snr_td - snr_fft) <= 0.5 else 0\n\n        # --- 5. Discrepancy Diagnosis ---\n        diag_code = 0\n        \n        # Windowing leakage check\n        is_coherent = abs(C - round(C)) < 1e-6\n        if P_sig_fft + P_noise_fft > 0:\n            rho = P_sig_fft / (P_sig_fft + P_noise_fft)\n        else:\n            rho = 1\n            \n        if not is_coherent and rho < 0.9:\n            diag_code |= 1\n        \n        # Calibration error check\n        A_ls = np.sqrt(B1**2 + B2**2)\n        rel_amp_error = abs(A_ls - A_nom) / A_nom if A_nom > 1e-9 else 0\n        dc_offset_in_lsb = abs(C_dc) / Delta\n        \n        if rel_amp_error > 0.02 or dc_offset_in_lsb > 0.5:\n            diag_code |= 2\n            \n        return [round(snr_td, 3), round(snr_fft, 3), accept, diag_code]\n\n    # Test cases from the problem statement\n    test_cases = [\n        # Case 1: Happy path, coherent, proper window\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205, 'alpha': 0.9, 'window_name': 'Hann', 'g': 1.0, 'o_val_expr': '0.0'},\n        # Case 2: Non-coherent, poor window\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205.5, 'alpha': 0.9, 'window_name': 'rectangular', 'g': 1.0, 'o_val_expr': '0.0'},\n        # Case 3: Calibration errors\n        {'N': 12, 'Ns': 4096, 'fs': 1e6, 'C': 205, 'alpha': 0.9, 'window_name': 'Hann', 'g': 1.05, 'o_val_expr': '0.5 * Delta'},\n        # Case 4: Low-amplitude edge case\n        {'N': 10, 'Ns': 4096, 'fs': 1e6, 'C': 123.3, 'alpha': 2 / (2**10), 'window_name': 'Blackman', 'g': 1.0, 'o_val_expr': '0.0'},\n    ]\n    \n    results = []\n    for case in test_cases:\n        result = run_adc_analysis(**case)\n        results.append(result)\n        \n    # Format the final output as a string representing a list of lists.\n    # e.g., [[val1, val2, ...], [val1, val2, ...]]\n    result_str = '[' + ','.join([str(r) for r in results]) + ']'\n    print(result_str)\n\nsolve()\n```"
        }
    ]
}