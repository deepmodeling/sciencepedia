{
    "hands_on_practices": [
        {
            "introduction": "A core challenge in QM/MM simulations is accurately describing the interaction between the quantum mechanical (QM) and molecular mechanical (MM) regions. This practice focuses on the non-bonded van der Waals forces, which are typically modeled with a classical potential like the Lennard-Jones function. By applying the standard Lorentz-Berthelot mixing rules, you will perform a fundamental calculation  that illustrates how parameters are combined to describe the coupling at the QM/MM interface.",
            "id": "3853643",
            "problem": "Consider a Quantum Mechanics/Molecular Mechanics (QM/MM) simulation of an enzyme active site in which a single Quantum Mechanics (QM) atom interacts nonbondedly with a single Molecular Mechanics (MM) atom through a classical Lennard-Jones potential. The QM atom represents a catalytic oxygen in the QM region and the MM atom represents an aliphatic carbon in the protein environment. The Lennard-Jones potential is given by $V_{LJ}(r) = 4\\epsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^6\\right]$, where $r$ is the interatomic separation, $\\epsilon$ is the well-depth parameter, and $\\sigma$ is the characteristic diameter parameter. The QM and MM atom Lennard-Jones parameters, taken from a commonly used biomolecular force field, are:\n- QM oxygen: $\\epsilon_{\\mathrm{QM}} = 0.50$ kJ mol$^{-1}$, $\\sigma_{\\mathrm{QM}} = 0.316$ nm.\n- MM carbon: $\\epsilon_{\\mathrm{MM}} = 0.40$ kJ mol$^{-1}$, $\\sigma_{\\mathrm{MM}} = 0.340$ nm.\n\nAssume the QM oxygen and MM carbon are separated by $r = 0.400$ nm. Using the Lorentz-Berthelot mixing rules appropriate for heterogeneous pairs in a biomolecular force field, explain how $\\epsilon$ and $\\sigma$ are obtained for the mixed QM/MM pair and then compute the Lennard-Jones interaction energy $V_{LJ}(r)$ for this pair at the given separation. Express the final energy in kJ mol$^{-1}$ and round your answer to four significant figures.",
            "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded, well-posed, and objective. It presents a standard computational chemistry problem with all necessary data and defines a clear, unambiguous task. The provided parameters are realistic, and the required methodology (Lorentz-Berthelot mixing rules) is a standard convention in the field of molecular simulation.\n\nThe problem asks for the calculation of the Lennard-Jones interaction energy, $V_{LJ}$, between a Quantum Mechanics (QM) atom and a Molecular Mechanics (MM) atom. This is a common scenario in QM/MM simulations, where the interaction between the QM region (treated with quantum mechanics) and the MM region (treated with a classical force field) must be described. The non-bonded part of this interaction is typically modeled using classical potentials, such as the Lennard-Jones potential.\n\nThe Lennard-Jones potential for an interaction between two particles, $i$ and $j$, is given by:\n$$V_{LJ}(r_{ij}) = 4\\epsilon_{ij}\\left[\\left(\\frac{\\sigma_{ij}}{r_{ij}}\\right)^{12} - \\left(\\frac{\\sigma_{ij}}{r_{ij}}\\right)^6\\right]$$\nwhere $r_{ij}$ is the distance between the particles, $\\epsilon_{ij}$ is the depth of the potential well, and $\\sigma_{ij}$ is the finite distance at which the inter-particle potential is zero.\n\nThe parameters $\\epsilon_{ij}$ and $\\sigma_{ij}$ for a heterogeneous pair (where atom $i \\neq$ atom $j$) are typically derived from the parameters of the individual atoms ($\\epsilon_i$, $\\sigma_i$ and $\\epsilon_j$, $\\sigma_j$) using combining rules, often referred to as mixing rules. The problem specifies the use of the Lorentz-Berthelot mixing rules, which are commonly employed in biomolecular force fields. These rules are:\n\n1.  The arithmetic mean for the diameter parameter, $\\sigma_{ij}$ (Lorentz rule):\n    $$\\sigma_{ij} = \\frac{\\sigma_i + \\sigma_j}{2}$$\n2.  The geometric mean for the well-depth parameter, $\\epsilon_{ij}$ (Berthelot rule):\n    $$\\epsilon_{ij} = \\sqrt{\\epsilon_i \\epsilon_j}$$\n\nLet us denote the QM oxygen atom as QM and the MM carbon atom as MM. The provided parameters are:\n- QM oxygen: $\\epsilon_{\\mathrm{QM}} = 0.50$ kJ mol$^{-1}$, $\\sigma_{\\mathrm{QM}} = 0.316$ nm.\n- MM carbon: $\\epsilon_{\\mathrm{MM}} = 0.40$ kJ mol$^{-1}$, $\\sigma_{\\mathrm{MM}} = 0.340$ nm.\n\nFirst, we apply the Lorentz-Berthelot mixing rules to determine the effective parameters, $\\epsilon_{\\mathrm{QM/MM}}$ and $\\sigma_{\\mathrm{QM/MM}}$, for the QM-MM interaction.\n\nUsing the arithmetic mean for $\\sigma_{\\mathrm{QM/MM}}$:\n$$\\sigma_{\\mathrm{QM/MM}} = \\frac{\\sigma_{\\mathrm{QM}} + \\sigma_{\\mathrm{MM}}}{2} = \\frac{0.316 \\text{ nm} + 0.340 \\text{ nm}}{2} = \\frac{0.656 \\text{ nm}}{2} = 0.328 \\text{ nm}$$\n\nUsing the geometric mean for $\\epsilon_{\\mathrm{QM/MM}}$:\n$$\\epsilon_{\\mathrm{QM/MM}} = \\sqrt{\\epsilon_{\\mathrm{QM}} \\epsilon_{\\mathrm{MM}}} = \\sqrt{(0.50 \\text{ kJ mol}^{-1})(0.40 \\text{ kJ mol}^{-1})} = \\sqrt{0.20} \\text{ kJ mol}^{-1}$$\n\nNow, we can compute the Lennard-Jones interaction energy, $V_{LJ}(r)$, at the given separation $r = 0.400$ nm using the mixed parameters.\nThe formula is:\n$$V_{LJ}(r) = 4\\epsilon_{\\mathrm{QM/MM}}\\left[\\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^{12} - \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^6\\right]$$\n\nFirst, we calculate the ratio $\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}$:\n$$\\frac{\\sigma_{\\mathrm{QM/MM}}}{r} = \\frac{0.328 \\text{ nm}}{0.400 \\text{ nm}} = 0.820$$\n\nNext, we compute the two terms within the brackets:\n$$ \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^6 = (0.820)^6 \\approx 0.3040523264 $$\n$$ \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^{12} = \\left((0.820)^6\\right)^2 \\approx (0.3040523264)^2 \\approx 0.0924477213 $$\n\nNow, substitute these values back into the Lennard-Jones equation:\n$$V_{LJ}(r) = 4(\\sqrt{0.20} \\text{ kJ mol}^{-1}) \\left[ 0.0924477213 - 0.3040523264 \\right]$$\n$$V_{LJ}(r) = 4(\\sqrt{0.20} \\text{ kJ mol}^{-1}) \\left[ -0.2116046051 \\right]$$\n\nUsing the value $\\sqrt{0.20} \\approx 0.4472135955$:\n$$V_{LJ}(r) \\approx 4 \\times 0.4472135955 \\times (-0.2116046051) \\text{ kJ mol}^{-1}$$\n$$V_{LJ}(r) \\approx 1.788854382 \\times (-0.2116046051) \\text{ kJ mol}^{-1}$$\n$$V_{LJ}(r) \\approx -0.37853110 \\text{ kJ mol}^{-1}$$\n\nThe problem requires the answer to be rounded to four significant figures.\n$$V_{LJ}(r) \\approx -0.3785 \\text{ kJ mol}^{-1}$$\nThis negative value indicates that at a separation of $0.400$ nm, the interaction between the QM oxygen and the MM carbon is attractive, which is expected as this distance is greater than the Lennard-Jones diameter $\\sigma_{\\mathrm{QM/MM}} = 0.328$ nm.",
            "answer": "$$\\boxed{-0.3785}$$"
        },
        {
            "introduction": "Calculating an accurate activation free energy ($\\Delta G^{\\ddagger}$) is a primary goal when modeling enzymatic reactions. This exercise  guides you through assembling $\\Delta G^{\\ddagger}$ from its constituent thermodynamic components: electronic energy, zero-point energy, and entropy. Furthermore, it introduces you to the critical task of diagnosing sources of error in Density Functional Theory (DFT) calculations, helping you to assess whether discrepancies between different methods arise from the functional itself or from the underlying electron density.",
            "id": "3853648",
            "problem": "An enzymatic phosphoryl transfer reaction is studied with a Quantum Mechanics/Molecular Mechanics (QM/MM) hybrid model, where the Quantum Mechanics (QM) region is treated with Density Functional Theory (DFT) and the Molecular Mechanics (MM) region is treated with a classical force field. Two exchange-correlation functionals are used for the QM region: Becke–3–Lee–Yang–Parr with dispersion (B3LYP-D3) and Perdew–Burke–Ernzerhof hybrid with dispersion (PBE0-D3). For each functional, self-consistent-field (SCF) densities are used, and, separately, density-corrected DFT is evaluated on a Hartree–Fock (HF) density. The reaction barrier is quantified by the Gibbs free energy of activation, defined as $\\Delta G^{\\ddagger} = G_{\\mathrm{TS}} - G_{\\mathrm{R}}$, where $\\mathrm{TS}$ denotes the transition state and $\\mathrm{R}$ denotes the reactant state. From equilibrium statistical mechanics, $G = H - T S$, where $H$ is enthalpy, $T$ is temperature, and $S$ is entropy. Under a condensed-phase QM/MM approximation where $p V$ changes are negligible, the enthalpic difference is well approximated by the electronic energy difference plus zero-point energy (ZPE) contributions: $\\Delta H \\approx \\Delta E_{\\mathrm{elec}} + \\Delta \\mathrm{ZPE}$. The total barrier can then be assembled from contributions measured relative to the reactant.\n\nAll data below are reported as differences between the transition state and reactant, at temperature $T = 300$ $\\mathrm{K}$. Electronic energy differences $\\Delta E_{\\mathrm{elec}}$ and zero-point energy differences $\\Delta \\mathrm{ZPE}$ are given in $\\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$. Entropy differences $\\Delta S$ are given in $\\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$.\n\nSelf-consistent densities (SCF):\n- B3LYP-D3: $\\Delta E_{\\mathrm{elec}} = 52.1$, $\\Delta \\mathrm{ZPE} = -1.6$, $\\Delta S = -47.0$.\n- PBE0-D3: $\\Delta E_{\\mathrm{elec}} = 58.4$, $\\Delta \\mathrm{ZPE} = -1.3$, $\\Delta S = -49.5$.\n\nHartree–Fock density (density-corrected DFT):\n- B3LYP-D3 on HF density: $\\Delta E_{\\mathrm{elec}} = 55.5$, $\\Delta \\mathrm{ZPE} = -1.5$, $\\Delta S = -48.0$.\n- PBE0-D3 on HF density: $\\Delta E_{\\mathrm{elec}} = 56.8$, $\\Delta \\mathrm{ZPE} = -1.4$, $\\Delta S = -48.8$.\n\nUsing only fundamental thermodynamic relations and the definitions above, compute the self-consistent functional discrepancy in the barrier\n$$\n\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}} \\equiv \\Delta G^{\\ddagger}_{\\mathrm{PBE0\\text{-}D3,\\,SCF}} - \\Delta G^{\\ddagger}_{\\mathrm{B3LYP\\text{-}D3,\\,SCF}}\n$$\nexpressed in $\\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$.\n\nThen assess whether the discrepancy between functionals is likely dominated by functional-driven error or density-driven error by comparing the magnitude of the discrepancy on the self-consistent densities versus that on the Hartree–Fock density. Use the following decision rule: if the magnitude of the discrepancy decreases by at least $50\\%$ upon using the Hartree–Fock density, classify the discrepancy as density-driven; otherwise, classify it as functional-driven. Report the classification as a binary indicator $I$ with $I = 0$ for density-driven and $I = 1$ for functional-driven.\n\nRound $\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}$ to four significant figures. Express the final answer as a two-entry row matrix containing first $\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}$ (in $\\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$) and second the indicator $I$. No units should appear inside the final reported matrix.",
            "solution": "The problem has been validated and is deemed valid. It is scientifically grounded, well-posed, and objective. It presents a standard computational chemistry problem with all necessary data and defines a clear, unambiguous task for calculating thermodynamic properties and diagnosing computational errors.\n\nThe primary goal is to compute the self-consistent functional discrepancy, $\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}$, and then classify the source of the discrepancy between the two DFT functionals.\n\nThe Gibbs free energy of activation, $\\Delta G^{\\ddagger}$, is calculated using the provided thermodynamic relation:\n$$ \\Delta G^{\\ddagger} = \\Delta H^{\\ddagger} - T \\Delta S^{\\ddagger} $$\nUsing the given approximation for the enthalpy change, $\\Delta H^{\\ddagger} \\approx \\Delta E_{\\mathrm{elec}} + \\Delta \\mathrm{ZPE}$, the expression becomes:\n$$ \\Delta G^{\\ddagger} \\approx \\Delta E_{\\mathrm{elec}} + \\Delta \\mathrm{ZPE} - T \\Delta S^{\\ddagger} $$\nAll calculations will use the temperature $T = 300 \\, \\mathrm{K}$. A crucial step is to ensure consistent units. Since $\\Delta E_{\\mathrm{elec}}$ and $\\Delta \\mathrm{ZPE}$ are in $\\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$ and $\\Delta S^{\\ddagger}$ is in $\\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$, the entropy term $T \\Delta S^{\\ddagger}$ must be converted from $\\mathrm{J} \\cdot \\mathrm{mol}^{-1}$ to $\\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$ by dividing by 1000.\n\n**Part 1: Compute $\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}$**\n\nFirst, we calculate the activation free energy for each functional using their self-consistent (SCF) densities.\n\nFor B3LYP-D3 (SCF):\n- $\\Delta E_{\\mathrm{elec}} = 52.1 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta \\mathrm{ZPE} = -1.6 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta S = -47.0 \\, \\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$\n$$ \\Delta G^{\\ddagger}_{\\mathrm{B3LYP\\text{-}D3,\\,SCF}} = 52.1 + (-1.6) - \\frac{300 \\times (-47.0)}{1000} = 50.5 + 14.1 = 64.6 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\n\nFor PBE0-D3 (SCF):\n- $\\Delta E_{\\mathrm{elec}} = 58.4 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta \\mathrm{ZPE} = -1.3 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta S = -49.5 \\, \\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$\n$$ \\Delta G^{\\ddagger}_{\\mathrm{PBE0\\text{-}D3,\\,SCF}} = 58.4 + (-1.3) - \\frac{300 \\times (-49.5)}{1000} = 57.1 + 14.85 = 71.95 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\n\nNow, we compute the discrepancy between the two functionals:\n$$ \\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}} = \\Delta G^{\\ddagger}_{\\mathrm{PBE0\\text{-}D3,\\,SCF}} - \\Delta G^{\\ddagger}_{\\mathrm{B3LYP\\text{-}D3,\\,SCF}} $$\n$$ \\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}} = 71.95 - 64.6 = 7.35 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\nRounding to four significant figures gives $7.350 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$.\n\n**Part 2: Classify the Discrepancy and Determine Indicator $I$**\n\nNext, we repeat the calculations using the Hartree-Fock (HF) density to assess if the error is density-driven or functional-driven.\n\nFor B3LYP-D3 on HF density:\n- $\\Delta E_{\\mathrm{elec}} = 55.5 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta \\mathrm{ZPE} = -1.5 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta S = -48.0 \\, \\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$\n$$ \\Delta G^{\\ddagger}_{\\mathrm{B3LYP\\text{-}D3,\\,HF}} = 55.5 + (-1.5) - \\frac{300 \\times (-48.0)}{1000} = 54.0 + 14.4 = 68.4 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\n\nFor PBE0-D3 on HF density:\n- $\\Delta E_{\\mathrm{elec}} = 56.8 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta \\mathrm{ZPE} = -1.4 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $\\Delta S = -48.8 \\, \\mathrm{J} \\cdot \\mathrm{mol}^{-1} \\cdot \\mathrm{K}^{-1}$\n$$ \\Delta G^{\\ddagger}_{\\mathrm{PBE0\\text{-}D3,\\,HF}} = 56.8 + (-1.4) - \\frac{300 \\times (-48.8)}{1000} = 55.4 + 14.64 = 70.04 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\n\nThe discrepancy on the HF density is:\n$$ \\Delta \\Delta G^{\\ddagger}_{\\mathrm{HF}} = \\Delta G^{\\ddagger}_{\\mathrm{PBE0\\text{-}D3,\\,HF}} - \\Delta G^{\\ddagger}_{\\mathrm{B3LYP\\text{-}D3,\\,HF}} $$\n$$ \\Delta \\Delta G^{\\ddagger}_{\\mathrm{HF}} = 70.04 - 68.4 = 1.64 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1} $$\n\nFinally, we apply the decision rule. We compare the magnitude of the discrepancy on the HF density to the magnitude on the SCF densities.\n- $|\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}| = |7.350| = 7.350 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n- $|\\Delta \\Delta G^{\\ddagger}_{\\mathrm{HF}}| = |1.64| = 1.64 \\, \\mathrm{kJ} \\cdot \\mathrm{mol}^{-1}$\n\nThe percentage reduction in the discrepancy is:\n$$ \\text{Reduction} = \\frac{|\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}| - |\\Delta \\Delta G^{\\ddagger}_{\\mathrm{HF}}|}{|\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}|} \\times 100\\% = \\frac{7.350 - 1.64}{7.350} \\times 100\\% \\approx 77.7\\% $$\nSince the discrepancy decreases by more than $50\\%$ when both functionals are evaluated on a common (HF) density, the original discrepancy is classified as **density-driven**. This means the difference in the self-consistent electron densities produced by the two functionals was the primary source of the disagreement in their predicted barriers.\nAccording to the problem's rule, this corresponds to the indicator $I=0$.\n\nThe final answer is composed of the calculated discrepancy $\\Delta \\Delta G^{\\ddagger}_{\\mathrm{SCF}}$ and the indicator $I$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 7.350 & 0 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Large-scale QM/MM simulations produce rich datasets that hold deep mechanistic insights, but these are often obscured by the statistical bias introduced by methods like umbrella sampling. This practice challenges you to write a program that uses the principles of importance reweighting to analyze biased simulation data . By doing so, you will learn to calculate the unbiased energetic contribution of each protein residue to the reaction barrier, a powerful method for pinpointing the key players in enzymatic catalysis.",
            "id": "3853637",
            "problem": "You are modeling an enzymatic reaction mechanism using Quantum Mechanics/Molecular Mechanics (QM/MM). Consider umbrella sampling along a one-dimensional reaction coordinate. Each umbrella window applies a harmonic bias to the reaction coordinate while sampling the system. You are provided, for selected umbrella windows, sets of frames with the reaction coordinate values and per-residue nonbonded interaction energies between the Molecular Mechanics (MM) residues and the Quantum Mechanics (QM) region. Assume all energies are given in kJ/mol and the reaction coordinate is a scalar value in Å.\n\nStarting from the canonical ensemble and the Boltzmann distribution, justify a method to compute unbiased ensemble averages from samples generated under a known bias potential. Then, define the per-residue MM contribution to the Potential of Mean Force (PMF) barrier as the difference between the unbiased ensemble average interaction energy at a transition-state window and at a reactant-state window, with the following assumptions: the per-residue MM energy samples are sums of Coulombic and Lennard-Jones interactions and the harmonic umbrella bias is given by a quadratic potential in the reaction coordinate.\n\nImplement a program that:\n- Computes unbiased ensemble averages of the per-residue MM interaction energies at each specified window via importance reweighting of frames by the known umbrella bias.\n- Computes, for each residue, the MM contribution to the PMF barrier as the difference between the transition-state average and the reactant-state average.\n- Identifies the $K$ residues with the largest stabilizing effects (i.e., the most negative barrier contributions), breaking ties by ascending residue index.\n- Returns, for each test case, a list of pairs $[r,\\Delta G_r]$ where $r$ is the $1$-based residue index and $\\Delta G_r$ is the barrier contribution in kJ/mol, rounded to three decimals.\n\nFundamental base to use:\n- Canonical ensemble with Boltzmann distribution $p(\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x}))$, where $\\beta = 1/(R T)$ in molar units, $R$ is the molar gas constant, $T$ is the absolute temperature, and $U$ is the potential energy.\n- Importance sampling and reweighting: if samples are drawn from a biased distribution with bias potential $U_\\text{bias}$, unbiased expectations are recovered by weighting observables by $\\exp(+\\beta U_\\text{bias})$.\n- Harmonic umbrella bias $U_\\text{bias}(s) = \\tfrac{1}{2} k (s - s_0)^2$ for reaction coordinate $s$, force constant $k$, and center $s_0$.\n\nDefinitions:\n- Quantum Mechanics/Molecular Mechanics (QM/MM) uses a quantum mechanical description for the chemically active region and a classical molecular mechanics description for the environment.\n- The per-residue MM interaction energy $E_{r,ij}$ is the nonbonded energy of residue $r$ with the QM region for frame $j$ in window $i$.\n\nUnits and output:\n- All energies must be interpreted and reported in kJ/mol.\n- Temperature is in K.\n- The output for each test case is a list of $K$ pairs $[r,\\Delta G_r]$ where $\\Delta G_r$ is a float rounded to three decimals (kJ/mol).\n- Your program should produce a single line of output containing the results for all provided test cases as a comma-separated list enclosed in square brackets, for example: $[[$pair\\_list\\_for\\_case\\_1$],[$pair\\_list\\_for\\_case\\_2$],[$pair\\_list\\_for\\_case\\_3$]]$.\n\nNumerical stability:\n- When computing weights $w_j \\propto \\exp(\\beta U_\\text{bias}(s_j))$, implement a numerically stable normalization (e.g., subtract the maximum exponent before exponentiation) to avoid overflow in $\\exp$.\n\nTest suite:\nFor each test case, the program must hardcode the following parameters.\n\nTest case $1$ (happy path):\n- Temperature $T = 300$ K.\n- Reactant window parameters: $k = 1000$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 1.0$ Å, frames:\n  - Reaction coordinate samples $s_\\mathrm{R} = [\\,0.95,\\,0.98,\\,1.02,\\,1.05,\\,0.90\\,]$.\n  - Per-residue energies (rows are frames, columns are residues $r = 1,2,3,4,5$):\n    - Frame $1$: $[-2.0,\\,1.5,\\,-0.5,\\,0.0,\\,0.2]$\n    - Frame $2$: $[-1.8,\\,1.2,\\,-0.6,\\,0.1,\\,0.3]$\n    - Frame $3$: $[-2.2,\\,1.6,\\,-0.4,\\,0.1,\\,0.2]$\n    - Frame $4$: $[-1.9,\\,1.4,\\,-0.5,\\,0.0,\\,0.1]$\n    - Frame $5$: $[-2.1,\\,1.3,\\,-0.6,\\,-0.1,\\,0.2]$\n- Transition-state window parameters: $k = 1000$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 2.0$ Å, frames:\n  - Reaction coordinate samples $s_\\mathrm{TS} = [\\,1.95,\\,2.00,\\,2.05,\\,1.97,\\,2.02\\,]$.\n  - Per-residue energies:\n    - Frame $1$: $[-3.5,\\,2.0,\\,-0.8,\\,-0.2,\\,0.1]$\n    - Frame $2$: $[-3.8,\\,2.3,\\,-0.9,\\,-0.3,\\,0.0]$\n    - Frame $3$: $[-3.6,\\,2.1,\\,-0.7,\\,-0.2,\\,0.0]$\n    - Frame $4$: $[-3.7,\\,2.2,\\,-0.8,\\,-0.1,\\,-0.1]$\n    - Frame $5$: $[-3.9,\\,2.4,\\,-0.9,\\,-0.2,\\,0.1]$\n- Return the $K = 3$ residues with the most negative contributions.\n\nTest case $2$ (boundary condition: zero contributions and tie-handling):\n- Temperature $T = 300$ K.\n- Reactant window: $k = 800$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 1.0$ Å, frames:\n  - $s_\\mathrm{R} = [\\,1.00,\\,1.02,\\,0.98\\,]$.\n  - Energies (four residues):\n    - Frame $1$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - Frame $2$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - Frame $3$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- Transition-state window: $k = 800$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 2.0$ Å, frames:\n  - $s_\\mathrm{TS} = [\\,2.00,\\,2.02,\\,1.98\\,]$.\n  - Energies (four residues):\n    - Frame $1$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - Frame $2$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - Frame $3$: $[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- Return the $K = 2$ residues with the most negative contributions (all zero; break ties by ascending index).\n\nTest case $3$ (edge case: very stiff bias and large deviations):\n- Temperature $T = 310$ K.\n- Reactant window: $k = 2000$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 1.0$ Å, frames:\n  - $s_\\mathrm{R} = [\\,0.70,\\,0.85,\\,1.00,\\,1.15,\\,1.30,\\,0.90\\,]$.\n  - Energies (four residues):\n    - Frame $1$: $[\\, -1.0,\\,0.5,\\,0.2,\\,0.0\\,]$\n    - Frame $2$: $[\\, -1.2,\\,0.6,\\,0.3,\\,0.1\\,]$\n    - Frame $3$: $[\\, -1.1,\\,0.4,\\,0.2,\\,0.0\\,]$\n    - Frame $4$: $[\\, -1.3,\\,0.7,\\,0.4,\\,0.2\\,]$\n    - Frame $5$: $[\\, -0.8,\\,0.6,\\,0.1,\\,0.0\\,]$\n    - Frame $6$: $[\\, -1.0,\\,0.5,\\,0.2,\\,-0.1\\,]$\n- Transition-state window: $k = 2000$ kJ mol$^{-1}$ Å$^{-2}$, $s_0 = 2.0$ Å, frames:\n  - $s_\\mathrm{TS} = [\\,1.70,\\,1.85,\\,2.00,\\,2.15,\\,2.30,\\,2.10\\,]$.\n  - Energies (four residues):\n    - Frame $1$: $[\\, -2.0,\\,1.0,\\,0.3,\\,-0.1\\,]$\n    - Frame $2$: $[\\, -2.2,\\,1.1,\\,0.4,\\,-0.1\\,]$\n    - Frame $3$: $[\\, -2.1,\\,0.9,\\,0.3,\\,-0.2\\,]$\n    - Frame $4$: $[\\, -2.3,\\,1.2,\\,0.5,\\,-0.1\\,]$\n    - Frame $5$: $[\\, -1.8,\\,1.1,\\,0.2,\\,0.0\\,]$\n    - Frame $6$: $[\\, -2.0,\\,1.0,\\,0.3,\\,-0.1\\,]$\n- Return the $K = 2$ residues with the most negative contributions.\n\nYour program must hardcode these three test cases and produce a single line containing the results as a comma-separated list enclosed in square brackets, where each test case result is a list of $K$ pairs $[r,\\Delta G_r]$ in kJ/mol, rounded to three decimals.",
            "solution": "The problem requires the calculation of per-residue contributions to an enzymatic reaction barrier from biased simulation data obtained via QM/MM umbrella sampling. This involves applying the principles of statistical mechanics to correct for the sampling bias and extract unbiased observables.\n\nThe theoretical foundation for this analysis lies in the canonical ($NVT$) ensemble, where the probability density of a system state with configuration $\\mathbf{x}$ and potential energy $U(\\mathbf{x})$ is given by the Boltzmann distribution:\n$$ p(\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x})) $$\nwhere $\\beta = (RT)^{-1}$, $R$ is the molar gas constant ($8.314462618 \\times 10^{-3}$ kJ mol$^{-1}$ K$^{-1}$), and $T$ is the absolute temperature. The equilibrium ensemble average of an observable $A(\\mathbf{x})$ is its expectation value over this distribution:\n$$ \\langle A \\rangle = \\frac{\\int A(\\mathbf{x}) \\exp(-\\beta U(\\mathbf{x})) d\\mathbf{x}}{\\int \\exp(-\\beta U(\\mathbf{x})) d\\mathbf{x}} $$\nIn umbrella sampling, a bias potential, $U_\\text{bias}(\\mathbf{x})$, is added to the system's potential, such that the simulation samples from a biased distribution $p'(\\mathbf{x})$ corresponding to the potential $U'(\\mathbf{x}) = U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x})$. To recover the unbiased ensemble average $\\langle A \\rangle$ from samples generated under this biased potential, we employ the technique of importance sampling. We can rewrite the expression for $\\langle A \\rangle$ by multiplying and dividing the integrand by $\\exp(-\\beta U_\\text{bias}(\\mathbf{x}))$:\n$$ \\langle A \\rangle = \\frac{\\int A(\\mathbf{x}) \\exp(+\\beta U_\\text{bias}(\\mathbf{x})) \\exp(-\\beta (U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x}))) d\\mathbf{x}}{\\int \\exp(+\\beta U_\\text{bias}(\\mathbf{x})) \\exp(-\\beta (U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x}))) d\\mathbf{x}} $$\nThese integrals can be interpreted as expectation values over the biased distribution $p'(\\mathbf{x}) \\propto \\exp(-\\beta U'(\\mathbf{x}))$. For a discrete set of $N$ configurations (frames) $\\{\\mathbf{x}_j\\}$ sampled from the biased simulation, the integrals become sums:\n$$ \\langle A \\rangle \\approx \\frac{\\sum_{j=1}^{N} A_j \\exp(+\\beta U_{\\text{bias},j})}{\\sum_{j=1}^{N} \\exp(+\\beta U_{\\text{bias},j})} $$\nwhere $A_j$ and $U_{\\text{bias},j}$ are the values of the observable and the bias potential at frame $j$, respectively. The term $w_j = \\exp(+\\beta U_{\\text{bias},j})$ is the reweighting factor for each frame.\n\nThe problem specifies a harmonic bias potential centered on the reaction coordinate $s$:\n$$ U_\\text{bias}(s_j) = \\frac{1}{2} k (s_j - s_0)^2 $$\nThe observable of interest, $A$, is the per-residue MM-QM nonbonded interaction energy, $E_r$, for residue $r$. Its value in frame $j$ is $E_{r,j}$. The unbiased ensemble average of this energy in a given window is therefore:\n$$ \\langle E_r \\rangle = \\frac{\\sum_{j=1}^{N} E_{r,j} \\exp\\left( \\beta \\frac{1}{2} k (s_j - s_0)^2 \\right)}{\\sum_{j=1}^{N} \\exp\\left( \\beta \\frac{1}{2} k (s_j - s_0)^2 \\right)} $$\nNumerically, the exponential terms can become very large, risking floating-point overflow. This is mitigated by normalizing the exponents. Let $B_j = \\beta U_{\\text{bias},j}$ and $B_\\text{max} = \\max_j\\{B_j\\}$. The weight for each frame $j$ can be calculated as $w'_j = \\exp(B_j - B_\\text{max})$. The formula for the average remains the same with these scaled weights, as the $\\exp(B_\\text{max})$ term cancels from the numerator and denominator:\n$$ \\langle E_r \\rangle = \\frac{\\sum_{j=1}^{N} E_{r,j} w'_j}{\\sum_{j=1}^{N} w'_j} $$\nThis ensures that the largest exponent is $0$ and no overflow occurs.\n\nThe per-residue MM contribution to the activation free energy barrier, $\\Delta G_r$, is defined as the change in the unbiased average interaction energy between the transition state (TS) and reactant (R) states:\n$$ \\Delta G_r = \\langle E_r \\rangle_\\text{TS} - \\langle E_r \\rangle_\\text{R} $$\nA negative value of $\\Delta G_r$ indicates that the residue's interaction with the QM region is more favorable (lower energy) at the transition state than in the reactant state, implying a stabilizing effect on the transition state.\n\nThe computational procedure is as follows:\n1. For each test case, define the system parameters: temperature $T$, number of top residues to report $K$, and the data for the reactant and transition-state windows.\n2. For each window (reactant and transition-state):\n   a. Calculate the inverse thermal energy, $\\beta = (RT)^{-1}$, using $R = 8.314462618 \\times 10^{-3}$ kJ mol$^{-1}$ K$^{-1}$.\n   b. For each frame $j$, calculate the harmonic bias potential energy $U_{\\text{bias},j} = \\frac{1}{2} k (s_j - s_0)^2$.\n   c. Compute the raw exponents $B_j = \\beta U_{\\text{bias},j}$.\n   d. For numerical stability, subtract the maximum exponent $B_\\text{max}$ and compute the unnormalized weights $w'_j = \\exp(B_j - B_\\text{max})$.\n   e. For each residue $r$, calculate the unbiased average energy $\\langle E_r \\rangle$ as the weighted average of its energies $E_{r,j}$ across all frames using the weights $w'_j$.\n3. For each residue $r$, compute the barrier contribution $\\Delta G_r = \\langle E_r \\rangle_\\text{TS} - \\langle E_r \\rangle_\\text{R}$.\n4. Create a list of tuples containing the barrier contribution and the $1$-based residue index, $(\\Delta G_r, r)$.\n5. Sort this list first by $\\Delta G_r$ in ascending order (to find the most negative contributions) and then by residue index in ascending order to break ties.\n6. Select the top $K$ results from the sorted list and format them as pairs $[r, \\Delta G_r]$, with $\\Delta G_r$ rounded to three decimal places.\n7. Collate the results from all test cases into a single list and print as a formatted string.",
            "answer": "```python\nimport numpy as np\n\n# Universal molar gas constant in kJ/(mol*K)\nR_KJ_PER_MOL_K = 8.314462618 / 1000\n\ndef compute_unbiased_averages(T, k, s0, s_samples, E_samples):\n    \"\"\"\n    Computes unbiased ensemble averages of per-residue energies from a biased window.\n\n    Args:\n        T (float): Temperature in Kelvin.\n        k (float): Harmonic force constant in kJ/mol/Å^2.\n        s0 (float): Harmonic potential center in Å.\n        s_samples (np.ndarray): Array of reaction coordinate values for each frame.\n        E_samples (np.ndarray): 2D array (frames x residues) of interaction energies.\n\n    Returns:\n        np.ndarray: Array of unbiased average energies for each residue.\n    \"\"\"\n    beta = 1.0 / (R_KJ_PER_MOL_K * T)\n    \n    # Calculate bias energies for each frame\n    U_bias = 0.5 * k * (s_samples - s0)**2\n    \n    # Calculate exponents for reweighting, ensuring numerical stability\n    exponents = beta * U_bias\n    max_exponent = np.max(exponents)\n    weights = np.exp(exponents - max_exponent)\n    \n    # Sum of weights for normalization\n    sum_of_weights = np.sum(weights)\n    \n    # Calculate weighted average energies for each residue\n    # E_samples.T is (residues x frames), weights is (frames,)\n    # The @ operator performs matrix-vector multiplication\n    weighted_energies = E_samples.T @ weights\n    unbiased_avg_energies = weighted_energies / sum_of_weights\n    \n    return unbiased_avg_energies\n\ndef solve():\n    \"\"\"\n    Processes all test cases to identify residues with the largest stabilizing effects.\n    \"\"\"\n    test_cases = [\n        # Test case 1 (happy path)\n        {\n            \"T\": 300.0,\n            \"K\": 3,\n            \"reactant\": {\n                \"k\": 1000.0, \"s0\": 1.0,\n                \"s\": np.array([0.95, 0.98, 1.02, 1.05, 0.90]),\n                \"E\": np.array([\n                    [-2.0, 1.5, -0.5, 0.0, 0.2],\n                    [-1.8, 1.2, -0.6, 0.1, 0.3],\n                    [-2.2, 1.6, -0.4, 0.1, 0.2],\n                    [-1.9, 1.4, -0.5, 0.0, 0.1],\n                    [-2.1, 1.3, -0.6, -0.1, 0.2]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 1000.0, \"s0\": 2.0,\n                \"s\": np.array([1.95, 2.00, 2.05, 1.97, 2.02]),\n                \"E\": np.array([\n                    [-3.5, 2.0, -0.8, -0.2, 0.1],\n                    [-3.8, 2.3, -0.9, -0.3, 0.0],\n                    [-3.6, 2.1, -0.7, -0.2, 0.0],\n                    [-3.7, 2.2, -0.8, -0.1, -0.1],\n                    [-3.9, 2.4, -0.9, -0.2, 0.1]\n                ])\n            }\n        },\n        # Test case 2 (boundary condition: zero contributions and tie-handling)\n        {\n            \"T\": 300.0,\n            \"K\": 2,\n            \"reactant\": {\n                \"k\": 800.0, \"s0\": 1.0,\n                \"s\": np.array([1.00, 1.02, 0.98]),\n                \"E\": np.array([\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 800.0, \"s0\": 2.0,\n                \"s\": np.array([2.00, 2.02, 1.98]),\n                \"E\": np.array([\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0]\n                ])\n            }\n        },\n        # Test case 3 (edge case: very stiff bias and large deviations)\n        {\n            \"T\": 310.0,\n            \"K\": 2,\n            \"reactant\": {\n                \"k\": 2000.0, \"s0\": 1.0,\n                \"s\": np.array([0.70, 0.85, 1.00, 1.15, 1.30, 0.90]),\n                \"E\": np.array([\n                    [-1.0, 0.5, 0.2, 0.0],\n                    [-1.2, 0.6, 0.3, 0.1],\n                    [-1.1, 0.4, 0.2, 0.0],\n                    [-1.3, 0.7, 0.4, 0.2],\n                    [-0.8, 0.6, 0.1, 0.0],\n                    [-1.0, 0.5, 0.2, -0.1]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 2000.0, \"s0\": 2.0,\n                \"s\": np.array([1.70, 1.85, 2.00, 2.15, 2.30, 2.10]),\n                \"E\": np.array([\n                    [-2.0, 1.0, 0.3, -0.1],\n                    [-2.2, 1.1, 0.4, -0.1],\n                    [-2.1, 0.9, 0.3, -0.2],\n                    [-2.3, 1.2, 0.5, -0.1],\n                    [-1.8, 1.1, 0.2, 0.0],\n                    [-2.0, 1.0, 0.3, -0.1]\n                ])\n            }\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        # Calculate unbiased averages for reactant state\n        avg_E_reactant = compute_unbiased_averages(\n            case[\"T\"],\n            case[\"reactant\"][\"k\"],\n            case[\"reactant\"][\"s0\"],\n            case[\"reactant\"][\"s\"],\n            case[\"reactant\"][\"E\"]\n        )\n\n        # Calculate unbiased averages for transition state\n        avg_E_ts = compute_unbiased_averages(\n            case[\"T\"],\n            case[\"transition_state\"][\"k\"],\n            case[\"transition_state\"][\"s0\"],\n            case[\"transition_state\"][\"s\"],\n            case[\"transition_state\"][\"E\"]\n        )\n\n        # Calculate barrier contributions\n        delta_G = avg_E_ts - avg_E_reactant\n        \n        # Pair contributions with 1-based residue indices\n        num_residues = delta_G.shape[0]\n        results_with_indices = []\n        for i in range(num_residues):\n            residue_index = i + 1\n            results_with_indices.append((delta_G[i], residue_index))\n        \n        # Sort by contribution (ascending) and then by index (ascending) to break ties\n        results_with_indices.sort()\n\n        # Select top K and format for output\n        K = case[\"K\"]\n        case_output = []\n        for dG, r_idx in results_with_indices[:K]:\n            case_output.append([r_idx, round(dG, 3)])\n        \n        all_results.append(case_output)\n\n    # Format the final output string\n    # Using repr() to get space-less string representation of lists\n    results_str = [repr(result).replace(\" \", \"\") for result in all_results]\n    print(f\"[[{','.join(results_str)}]]\")\n\nsolve()\n```"
        }
    ]
}