{
    "hands_on_practices": [
        {
            "introduction": "QM/MM 模拟的核心在于如何描述量子区域与经典环境之间的“对话”。本练习将聚焦于非键相互作用，特别是通过 Lennard-Jones 势能建模的范德华力。通过一个具体的计算，您将实践如何为跨越 QM 和 MM 边界的原子对（例如，一个 QM 原子和一个 MM 原子）推导相互作用参数，这是构建整个 QM/MM 能量函数的基本步骤 。",
            "id": "3853643",
            "problem": "考虑一个酶活性位点的量子力学/分子力学 (QM/MM) 模拟，其中一个量子力学 (QM) 原子通过经典的 Lennard-Jones 势与一个分子力学 (MM) 原子发生非键相互作用。QM 原子代表 QM 区域中的一个催化氧原子，MM 原子代表蛋白质环境中的一个脂肪族碳原子。Lennard-Jones 势由 $V_{LJ}(r) = 4\\epsilon\\left[\\left(\\frac{\\sigma}{r}\\right)^{12} - \\left(\\frac{\\sigma}{r}\\right)^6\\right]$ 给出，其中 $r$ 是原子间距，$\\epsilon$ 是势阱深度参数，$\\sigma$ 是特征直径参数。QM 和 MM 原子的 Lennard-Jones 参数取自一个常用的生物分子力场，具体如下：\n- QM 氧原子：$\\epsilon_{\\mathrm{QM}} = 0.50$ kJ mol$^{-1}$，$\\sigma_{\\mathrm{QM}} = 0.316$ nm。\n- MM 碳原子：$\\epsilon_{\\mathrm{MM}} = 0.40$ kJ mol$^{-1}$，$\\sigma_{\\mathrm{MM}} = 0.340$ nm。\n\n假设 QM 氧原子和 MM 碳原子的间距为 $r = 0.400$ nm。使用适用于生物分子力场中异构对的 Lorentz-Berthelot 混合规则，解释如何获得混合的 QM/MM 对的 $\\epsilon$ 和 $\\sigma$，然后计算在该给定间距下这对原子的 Lennard-Jones 相互作用能 $V_{LJ}(r)$。以 kJ mol$^{-1}$ 为单位表示最终能量，并将答案四舍五入到四位有效数字。",
            "solution": "问题陈述已经过验证，被认为是有效的。它具有科学依据，提法得当且客观。它提出了一个标准的计算化学问题，包含了所有必要的数据，并定义了一个清晰、明确的任务。所提供的参数是符合实际的，并且所要求的方法（Lorentz-Berthelot 混合规则）是分子模拟领域的标准惯例。\n\n该问题要求计算一个量子力学 (QM) 原子和一个分子力学 (MM) 原子之间的 Lennard-Jones 相互作用能 $V_{LJ}$。这是 QM/MM 模拟中的一个常见情景，其中 QM 区域（用量子力学处理）和 MM 区域（用经典力场处理）之间的相互作用必须被描述。这种相互作用的非键部分通常使用经典势来建模，例如 Lennard-Jones 势。\n\n两个粒子 $i$ 和 $j$ 之间相互作用的 Lennard-Jones 势由以下公式给出：\n$$V_{LJ}(r_{ij}) = 4\\epsilon_{ij}\\left[\\left(\\frac{\\sigma_{ij}}{r_{ij}}\\right)^{12} - \\left(\\frac{\\sigma_{ij}}{r_{ij}}\\right)^6\\right]$$\n其中 $r_{ij}$ 是粒子间的距离，$\\epsilon_{ij}$ 是势阱深度，$\\sigma_{ij}$ 是粒子间势能为零时的有限距离。\n\n对于异构对（原子 $i \\neq$ 原子 $j$），参数 $\\epsilon_{ij}$ 和 $\\sigma_{ij}$ 通常通过使用组合规则（也常称为混合规则）从单个原子（$\\epsilon_i$, $\\sigma_i$ 和 $\\epsilon_j$, $\\sigma_j$）的参数中推导出来。该问题指定使用 Lorentz-Berthelot 混合规则，这在生物分子力场中被广泛采用。这些规则是：\n\n1.  直径参数 $\\sigma_{ij}$ 的算术平均值（Lorentz 规则）：\n    $$\\sigma_{ij} = \\frac{\\sigma_i + \\sigma_j}{2}$$\n2.  势阱深度参数 $\\epsilon_{ij}$ 的几何平均值（Berthelot 规则）：\n    $$\\epsilon_{ij} = \\sqrt{\\epsilon_i \\epsilon_j}$$\n\n让我们将 QM 氧原子表示为 QM，将 MM 碳原子表示为 MM。提供的参数如下：\n- QM 氧原子：$\\epsilon_{\\mathrm{QM}} = 0.50$ kJ mol$^{-1}$，$\\sigma_{\\mathrm{QM}} = 0.316$ nm。\n- MM 碳原子：$\\epsilon_{\\mathrm{MM}} = 0.40$ kJ mol$^{-1}$，$\\sigma_{\\mathrm{MM}} = 0.340$ nm。\n\n首先，我们应用 Lorentz-Berthelot 混合规则来确定 QM-MM 相互作用的有效参数 $\\epsilon_{\\mathrm{QM/MM}}$ 和 $\\sigma_{\\mathrm{QM/MM}}$。\n\n使用算术平均计算 $\\sigma_{\\mathrm{QM/MM}}$：\n$$\\sigma_{\\mathrm{QM/MM}} = \\frac{\\sigma_{\\mathrm{QM}} + \\sigma_{\\mathrm{MM}}}{2} = \\frac{0.316 \\text{ nm} + 0.340 \\text{ nm}}{2} = \\frac{0.656 \\text{ nm}}{2} = 0.328 \\text{ nm}$$\n\n使用几何平均计算 $\\epsilon_{\\mathrm{QM/MM}}$：\n$$\\epsilon_{\\mathrm{QM/MM}} = \\sqrt{\\epsilon_{\\mathrm{QM}} \\epsilon_{\\mathrm{MM}}} = \\sqrt{(0.50 \\text{ kJ mol}^{-1})(0.40 \\text{ kJ mol}^{-1})} = \\sqrt{0.20} \\text{ kJ mol}^{-1}$$\n\n现在，我们可以使用混合参数计算在给定间距 $r = 0.400$ nm 处的 Lennard-Jones 相互作用能 $V_{LJ}(r)$。公式如下：\n$$V_{LJ}(r) = 4\\epsilon_{\\mathrm{QM/MM}}\\left[\\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^{12} - \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^6\\right]$$\n\n首先，我们计算比率 $\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}$：\n$$\\frac{\\sigma_{\\mathrm{QM/MM}}}{r} = \\frac{0.328 \\text{ nm}}{0.400 \\text{ nm}} = 0.820$$\n\n接下来，我们计算括号内的两项：\n$$ \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^6 = (0.820)^6 \\approx 0.3040523264 $$\n$$ \\left(\\frac{\\sigma_{\\mathrm{QM/MM}}}{r}\\right)^{12} = \\left((0.820)^6\\right)^2 \\approx (0.3040523264)^2 \\approx 0.0924477213 $$\n\n现在，将这些值代回 Lennard-Jones 方程：\n$$V_{LJ}(r) = 4(\\sqrt{0.20} \\text{ kJ mol}^{-1}) \\left[ 0.0924477213 - 0.3040523264 \\right]$$\n$$V_{LJ}(r) = 4(\\sqrt{0.20} \\text{ kJ mol}^{-1}) \\left[ -0.2116046051 \\right]$$\n\n使用值 $\\sqrt{0.20} \\approx 0.4472135955$：\n$$V_{LJ}(r) \\approx 4 \\times 0.4472135955 \\times (-0.2116046051) \\text{ kJ mol}^{-1}$$\n$$V_{LJ}(r) \\approx 1.788854382 \\times (-0.2116046051) \\text{ kJ mol}^{-1}$$\n$$V_{LJ}(r) \\approx -0.37853110 \\text{ kJ mol}^{-1}$$\n\n问题要求将答案四舍五入到四位有效数字。\n$$V_{LJ}(r) \\approx -0.3785 \\text{ kJ mol}^{-1}$$\n这个负值表明，在 $0.400$ nm 的间距下，QM 氧原子和 MM 碳原子之间的相互作用是吸引性的，这是符合预期的，因为这个距离大于 Lennard-Jones 直径 $\\sigma_{\\mathrm{QM/MM}} = 0.328$ nm。",
            "answer": "$$\\boxed{-0.3785}$$"
        },
        {
            "introduction": "在静态相互作用的基础上，我们进而模拟动态的化学反应过程。计算酶促反应的自由能垒通常需要使用增强抽样方法，如伞形抽样（umbrella sampling），它通过施加偏置势来有效探索反应路径。本练习将引导您从统计力学的基本原理出发，推导如何为一个给定的采样宽度选择合适的偏置弹簧常数 $k$，这是成功进行自由能计算的关键设置步骤 。",
            "id": "3853659",
            "problem": "在一项关于酶促反应坐标 $q$ 的量子力学/分子力学 (QM/MM) 伞形采样研究中，坐标 $q$ 定义为活性位点中两个键距之差。每个窗口施加一个以 $q_{0}$ 为中心的谐波偏置势 $U_{\\text{bias}}(q)=\\frac{1}{2}k\\,(q-q_{0})^{2}$。假设在每个窗口内，无偏置的平均力势在约束尺度上是局部平坦的，因此采样分布主要由 $U_{\\text{bias}}(q)$ 主导。从具有玻尔兹曼权重 $p(q)\\propto \\exp\\!\\big(-\\beta U_{\\text{bias}}(q)\\big)$ 的正则系综和定义 $\\beta=1/(k_{B}T)$ 出发，推导 $q$ 围绕 $q_{0}$ 的方差 $\\sigma^{2}$ 与弹性常数 $k$ 之间的关系，过程中不使用任何现成公式。然后，对于温度 $T=310 \\ \\mathrm{K}$ 时期望的标准差 $\\sigma=0.050 \\ \\mathrm{\\AA}$，计算所需的弹性常数 $k$，单位为 $\\mathrm{kcal \\, mol^{-1} \\, \\AA^{-2}}$。使用玻尔兹曼常数 $k_{B}=1.987204\\times 10^{-3} \\ \\mathrm{kcal \\, mol^{-1} \\, K^{-1}}$。将您的数值答案四舍五入到三位有效数字，并以 $\\mathrm{kcal \\, mol^{-1} \\, \\AA^{-2}}$ 为单位报告。\n\n最后，基于正则系综中高斯窗口统计的第一性原理进行简要讨论，说明窗口中心间距 $\\Delta q$ 与 $\\sigma$ 的相对选择如何影响直方图重叠以及诸如加权直方图分析方法 (WHAM) 等自由能估计器的稳定性，特别是在 QM/MM 背景下，量子区域的能量涨落会减少有效样本量。您的讨论将不会按数值评分，也不会影响所需的计算。",
            "solution": "我们在正则系综中进行研究，其中单个伞形窗口中反应坐标 $q$ 的概率密度与玻尔兹曼因子成正比。对于谐波偏置势 $U_{\\text{bias}}(q)=\\frac{1}{2}k\\,(q-q_{0})^{2}$，未归一化的密度为\n$$\np(q)\\propto \\exp\\!\\left(-\\beta \\frac{1}{2}k\\,(q-q_{0})^{2}\\right),\n$$\n其中 $\\beta=\\frac{1}{k_{B}T}$。这是关于变量 $x=q-q_{0}$ 的高斯形式。为求得方差，我们计算该高斯分布的二阶中心矩。令 $x=q-q_{0}$ 并写出\n$$\np(x)\\propto \\exp\\!\\left(-\\frac{1}{2}\\beta k \\, x^{2}\\right).\n$$\n参数为 $a=\\frac{1}{2}\\beta k$ 的归一化高斯分布为\n$$\np(x)=\\sqrt{\\frac{\\beta k}{2\\pi}} \\, \\exp\\!\\left(-\\frac{1}{2}\\beta k \\, x^{2}\\right),\n$$\n这是根据标准高斯积分 $\\int_{-\\infty}^{\\infty} \\exp(-a x^{2}) \\, dx=\\sqrt{\\frac{\\pi}{a}}$（对于 $a>0$）得出的。方差为\n$$\n\\sigma^{2}=\\langle x^{2}\\rangle=\\int_{-\\infty}^{\\infty} x^{2} \\, p(x)\\, dx.\n$$\n使用标准高斯矩 $\\int_{-\\infty}^{\\infty} x^{2}\\exp(-a x^{2})\\, dx=\\frac{\\sqrt{\\pi}}{2a^{3/2}}$ 和上述归一化，我们得到\n$$\n\\langle x^{2}\\rangle=\\frac{1}{\\beta k}.\n$$\n因此，\n$$\n\\sigma^{2}=\\frac{1}{\\beta k}=\\frac{k_{B}T}{k},\n$$\n所以，在温度 $T$ 下实现方差 $\\sigma^{2}$ 所需的弹性常数为\n$$\nk=\\frac{k_{B}T}{\\sigma^{2}}.\n$$\n\n现在我们为指定参数计算数值。给定 $T=310 \\ \\mathrm{K}$，$k_{B}=1.987204\\times 10^{-3} \\ \\mathrm{kcal \\, mol^{-1} \\, K^{-1}}$ 和 $\\sigma=0.050 \\ \\mathrm{\\AA}$，我们有\n$$\nk_{B}T=\\left(1.987204\\times 10^{-3} \\ \\mathrm{kcal \\, mol^{-1} \\, K^{-1}}\\right)\\times \\left(310 \\ \\mathrm{K}\\right)=6.1603324\\times 10^{-1} \\ \\mathrm{kcal \\, mol^{-1}},\n$$\n并且\n$$\n\\sigma^{2}=(0.050 \\ \\mathrm{\\AA})^{2}=2.50\\times 10^{-3} \\ \\mathrm{\\AA^{2}}.\n$$\n因此，\n$$\nk=\\frac{6.1603324\\times 10^{-1} \\ \\mathrm{kcal \\, mol^{-1}}}{2.50\\times 10^{-3} \\ \\mathrm{\\AA^{2}}}=2.46413296\\times 10^{2} \\ \\mathrm{kcal \\, mol^{-1} \\, \\AA^{-2}}.\n$$\n四舍五入到三位有效数字，得到\n$$\nk=2.46\\times 10^{2} \\ \\mathrm{kcal \\, mol^{-1} \\, \\AA^{-2}}.\n$$\n\n窗口重叠影响讨论：由于每个伞形窗口采样的都是方差为 $\\sigma^{2}=\\frac{k_{B}T}{k}$ 的高斯分布 $p(q)\\propto \\exp\\!\\left(-\\frac{1}{2}\\beta k (q-q_{0})^{2}\\right)$，相邻窗口中心间距 $\\Delta q$ 与标准差 $\\sigma$ 之比 $\\Delta q/\\sigma$ 决定了直方图的重叠程度。当 $\\Delta q \\lesssim \\sigma$ 时，相邻的高斯分布会大量重叠，这通过提供共享的支持域和减少窗口间的外推，改善了诸如加权直方图分析方法 (WHAM) 等自由能估计器的条件。相反，当 $\\Delta q\\gg \\sigma$ 时，重叠消失，导致相对自由能约束不良、估计器方差增大和可能的偏差。在 QM/MM 设置中，量子区域的能量涨落和更长的自相关时间会减少有效样本量；为了在这些条件下保持稳健的重叠，可以将目标 $\\Delta q$ 设置在 $0.5\\sigma$ 到 $\\sigma$ 的量级，或者减小 $k$（从而增大 $\\sigma$），同时确保偏置势足够强以将采样局域在 $q_{0}$ 附近。考虑到 QM/MM 的统计效率低下问题，平衡 $\\sigma$ 和 $\\Delta q$ 可以改善重建的平均力势的收敛性和稳定性。",
            "answer": "$$\\boxed{2.46 \\times 10^{2}}$$"
        },
        {
            "introduction": "仿真的终点是获得化学和生物学上的洞见。在得到反应路径的自由能曲线后，我们如何确定是酶的哪些部分促进了催化？本练习模拟了一个真实的研究任务：通过编写程序来分析伞形抽样产生的偏置数据，您将学习如何使用重要性重加权方法（importance reweighting）来计算每个氨基酸残基对总反应能垒的贡献，从而精确定位酶催化机制中的关键角色 。",
            "id": "3853637",
            "problem": "您正在使用量子力学/分子力学 (QM/MM) 方法模拟一个酶促反应机理。考虑沿一维反应坐标进行伞形采样。在对系统进行采样时，每个伞形窗口都对反应坐标施加一个谐波偏置。对于选定的伞形窗口，您将获得一组包含反应坐标值以及分子力学 (MM) 残基与量子力学 (QM) 区域之间逐残基非键相互作用能的帧。假设所有能量的单位均为 kJ/mol，反应坐标是一个以 Å 为单位的标量值。\n\n从正则系综和玻尔兹曼分布出发，论证一种从已知偏置势下生成的样本中计算无偏系综平均值的方法。然后，将每个残基的 MM 对平均力势 (PMF) 能垒的贡献定义为过渡态窗口和反应物态窗口处无偏系综平均相互作用能之差，并基于以下假设：每个残基的 MM 能量样本是库仑相互作用和 Lennard-Jones 相互作用的总和，并且谐波伞形偏置由反应坐标中的二次势给出。\n\n实现一个程序，该程序：\n- 通过已知伞形偏置对帧进行重要性重加权，计算每个指定窗口中逐残基 MM 相互作用能的无偏系综平均值。\n- 对每个残基，计算其 MM 对 PMF 能垒的贡献，即过渡态平均值与反应物态平均值之差。\n- 识别出具有最大稳定效应（即能垒贡献最负）的 $K$ 个残基，若贡献值相同则按残基索引升序排列。\n- 对每个测试用例，返回一个由 $[r,\\Delta G_r]$ 对组成的列表，其中 $r$ 是从 1 开始的残基索引，$\\Delta G_r$ 是以 kJ/mol 为单位的能垒贡献，四舍五入到三位小数。\n\n使用的基本原理：\n- 正则系综与玻尔兹曼分布 $p(\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x}))$，其中 $\\beta = 1/(R T)$（以摩尔单位计），$R$ 是摩尔气体常数，$T$ 是绝对温度，$U$ 是势能。\n- 重要性采样和重加权：如果样本是从具有偏置势 $U_\\text{bias}$ 的偏置分布中抽取的，则通过将可观测量乘以权重 $\\exp(+\\beta U_\\text{bias})$ 来恢复无偏期望值。\n- 谐波伞形偏置 $U_\\text{bias}(s) = \\tfrac{1}{2} k (s - s_0)^2$，其中 $s$ 为反应坐标，$k$ 为力常数，$s_0$ 为中心位置。\n\n定义：\n- 量子力学/分子力学 (QM/MM) 对化学活性区域使用量子力学描述，对环境使用经典分子力学描述。\n- 逐残基 MM 相互作用能 $E_{r,ij}$ 是窗口 $i$ 中第 $j$ 帧时残基 $r$ 与 QM 区域的非键能量。\n\n单位和输出：\n- 所有能量必须以 kJ/mol 为单位进行解释和报告。\n- 温度单位为 K。\n- 每个测试用例的输出是一个包含 $K$ 个 $[r,\\Delta G_r]$ 对的列表，其中 $\\Delta G_r$ 是一个四舍五入到三位小数的浮点数 (kJ/mol)。\n- 您的程序应生成单行输出，其中包含所有给定测试用例的结果，格式为一个由方括号括起来的逗号分隔列表，例如：$[[$pair\\_list\\_for\\_case\\_1$],[$pair\\_list\\_for\\_case\\_2$],[$pair\\_list\\_for\\_case\\_3$]]$。\n\n数值稳定性：\n- 在计算权重 $w_j \\propto \\exp(\\beta U_\\text{bias}(s_j))$ 时，请实现一个数值稳定的归一化方法（例如，在求幂之前减去最大指数），以避免 $\\exp$ 函数中的溢出。\n\n测试套件：\n对于每个测试用例，程序必须硬编码以下参数。\n\n测试用例 1（正常路径）：\n- 温度 $T = 300$ K。\n- 反应物窗口参数：$k = 1000$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 1.0$ Å，帧：\n  - 反应坐标样本 $s_\\mathrm{R} = [\\,0.95,\\,0.98,\\,1.02,\\,1.05,\\,0.90\\,]$。\n  - 逐残基能量（行为帧，列为残基 $r = 1,2,3,4,5$）：\n    - 第 1 帧：$[-2.0,\\,1.5,\\,-0.5,\\,0.0,\\,0.2]$\n    - 第 2 帧：$[-1.8,\\,1.2,\\,-0.6,\\,0.1,\\,0.3]$\n    - 第 3 帧：$[-2.2,\\,1.6,\\,-0.4,\\,0.1,\\,0.2]$\n    - 第 4 帧：$[-1.9,\\,1.4,\\,-0.5,\\,0.0,\\,0.1]$\n    - 第 5 帧：$[-2.1,\\,1.3,\\,-0.6,\\,-0.1,\\,0.2]$\n- 过渡态窗口参数：$k = 1000$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 2.0$ Å，帧：\n  - 反应坐标样本 $s_\\mathrm{TS} = [\\,1.95,\\,2.00,\\,2.05,\\,1.97,\\,2.02\\,]$。\n  - 逐残基能量：\n    - 第 1 帧：$[-3.5,\\,2.0,\\,-0.8,\\,-0.2,\\,0.1]$\n    - 第 2 帧：$[-3.8,\\,2.3,\\,-0.9,\\,-0.3,\\,0.0]$\n    - 第 3 帧：$[-3.6,\\,2.1,\\,-0.7,\\,-0.2,\\,0.0]$\n    - 第 4 帧：$[-3.7,\\,2.2,\\,-0.8,\\,-0.1,\\,-0.1]$\n    - 第 5 帧：$[-3.9,\\,2.4,\\,-0.9,\\,-0.2,\\,0.1]$\n- 返回贡献最负的 $K = 3$ 个残基。\n\n测试用例 2（边界条件：零贡献和相同值处理）：\n- 温度 $T = 300$ K。\n- 反应物窗口：$k = 800$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 1.0$ Å，帧：\n  - $s_\\mathrm{R} = [\\,1.00,\\,1.02,\\,0.98\\,]$。\n  - 能量（四个残基）：\n    - 第 1 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - 第 2 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - 第 3 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- 过渡态窗口：$k = 800$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 2.0$ Å，帧：\n  - $s_\\mathrm{TS} = [\\,2.00,\\,2.02,\\,1.98\\,]$。\n  - 能量（四个残基）：\n    - 第 1 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - 第 2 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n    - 第 3 帧：$[\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- 返回贡献最负的 $K = 2$ 个残基（全部为零；按索引升序处理相同值）。\n\n测试用例 3（边缘情况：非常强的偏置和大的偏差）：\n- 温度 $T = 310$ K。\n- 反应物窗口：$k = 2000$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 1.0$ Å，帧：\n  - $s_\\mathrm{R} = [\\,0.70,\\,0.85,\\,1.00,\\,1.15,\\,1.30,\\,0.90\\,]$。\n  - 能量（四个残基）：\n    - 第 1 帧：$[\\, -1.0,\\,0.5,\\,0.2,\\,0.0\\,]$\n    - 第 2 帧：$[\\, -1.2,\\,0.6,\\,0.3,\\,0.1\\,]$\n    - 第 3 帧：$[\\, -1.1,\\,0.4,\\,0.2,\\,0.0\\,]$\n    - 第 4 帧：$[\\, -1.3,\\,0.7,\\,0.4,\\,0.2\\,]$\n    - 第 5 帧：$[\\, -0.8,\\,0.6,\\,0.1,\\,0.0\\,]$\n    - 第 6 帧：$[\\, -1.0,\\,0.5,\\,0.2,\\,-0.1\\,]$\n- 过渡态窗口：$k = 2000$ kJ mol$^{-1}$ Å$^{-2}$，$s_0 = 2.0$ Å，帧：\n  - $s_\\mathrm{TS} = [\\,1.70,\\,1.85,\\,2.00,\\,2.15,\\,2.30,\\,2.10\\,]$。\n  - 能量（四个残基）：\n    - 第 1 帧：$[\\, -2.0,\\,1.0,\\,0.3,\\,-0.1\\,]$\n    - 第 2 帧：$[\\, -2.2,\\,1.1,\\,0.4,\\,-0.1\\,]$\n    - 第 3 帧：$[\\, -2.1,\\,0.9,\\,0.3,\\,-0.2\\,]$\n    - 第 4 帧：$[\\, -2.3,\\,1.2,\\,0.5,\\,-0.1\\,]$\n    - 第 5 帧：$[\\, -1.8,\\,1.1,\\,0.2,\\,0.0\\,]$\n    - 第 6 帧：$[\\, -2.0,\\,1.0,\\,0.3,\\,-0.1\\,]$\n- 返回贡献最负的 $K = 2$ 个残基。\n\n您的程序必须硬编码这三个测试用例，并生成单行输出，其中包含结果，格式为一个由方括号括起来的逗号分隔列表，每个测试用例的结果是一个包含 $K$ 个 $[r,\\Delta G_r]$ 对（单位 kJ/mol，四舍五入到三位小数）的列表。",
            "solution": "该问题要求根据通过 QM/MM 伞形采样获得的偏置模拟数据，计算每个残基对酶促反应能垒的贡献。这涉及应用统计力学原理来校正采样偏差并提取无偏的可观测量。\n\n该分析的理论基础在于正则 ($NVT$) 系综，其中具有构型 $\\mathbf{x}$ 和势能 $U(\\mathbf{x})$ 的系统状态的概率密度由玻尔兹曼分布给出：\n$$ p(\\mathbf{x}) \\propto \\exp(-\\beta U(\\mathbf{x})) $$\n其中 $\\beta = (RT)^{-1}$，$R$ 是摩尔气体常数（$8.314462618 \\times 10^{-3}$ kJ mol$^{-1}$ K$^{-1}$），$T$ 是绝对温度。可观测量 $A(\\mathbf{x})$ 的平衡系综平均值是其在该分布上的期望值：\n$$ \\langle A \\rangle = \\frac{\\int A(\\mathbf{x}) \\exp(-\\beta U(\\mathbf{x})) d\\mathbf{x}}{\\int \\exp(-\\beta U(\\mathbf{x})) d\\mathbf{x}} $$\n在伞形采样中，一个偏置势 $U_\\text{bias}(\\mathbf{x})$ 被添加到系统的势能中，使得模拟从对应于势 $U'(\\mathbf{x}) = U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x})$ 的偏置分布 $p'(\\mathbf{x})$ 中进行采样。为了从该偏置势下生成的样本中恢复无偏系综平均值 $\\langle A \\rangle$，我们采用重要性采样技术。我们可以通过在被积函数上乘以和除以 $\\exp(-\\beta U_\\text{bias}(\\mathbf{x}))$ 来重写 $\\langle A \\rangle$ 的表达式：\n$$ \\langle A \\rangle = \\frac{\\int A(\\mathbf{x}) \\exp(+\\beta U_\\text{bias}(\\mathbf{x})) \\exp(-\\beta (U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x}))) d\\mathbf{x}}{\\int \\exp(+\\beta U_\\text{bias}(\\mathbf{x})) \\exp(-\\beta (U(\\mathbf{x}) + U_\\text{bias}(\\mathbf{x}))) d\\mathbf{x}} $$\n这些积分可以解释为在偏置分布 $p'(\\mathbf{x}) \\propto \\exp(-\\beta U'(\\mathbf{x}))$ 上的期望值。对于从偏置模拟中采样的一组离散的 $N$ 个构型（帧）$\\{\\mathbf{x}_j\\}$，积分变为求和：\n$$ \\langle A \\rangle \\approx \\frac{\\sum_{j=1}^{N} A_j \\exp(+\\beta U_{\\text{bias},j})}{\\sum_{j=1}^{N} \\exp(+\\beta U_{\\text{bias},j})} $$\n其中 $A_j$ 和 $U_{\\text{bias},j}$ 分别是第 $j$ 帧处可观测量和偏置势的值。项 $w_j = \\exp(+\\beta U_{\\text{bias},j})$ 是每帧的重加权因子。\n\n问题指定了一个以反应坐标 $s$ 为中心的谐波偏置势：\n$$ U_\\text{bias}(s_j) = \\frac{1}{2} k (s_j - s_0)^2 $$\n我们感兴趣的可观测量 $A$ 是残基 $r$ 的逐残基 MM-QM 非键相互作用能 $E_r$。其在第 $j$ 帧的值为 $E_{r,j}$。因此，给定窗口中该能量的无偏系综平均值为：\n$$ \\langle E_r \\rangle = \\frac{\\sum_{j=1}^{N} E_{r,j} \\exp\\left( \\beta \\frac{1}{2} k (s_j - s_0)^2 \\right)}{\\sum_{j=1}^{N} \\exp\\left( \\beta \\frac{1}{2} k (s_j - s_0)^2 \\right)} $$\n在数值上，指数项可能变得非常大，有浮点溢出的风险。这可以通过对指数进行归一化来缓解。设 $B_j = \\beta U_{\\text{bias},j}$ 和 $B_\\text{max} = \\max_j\\{B_j\\}$。每帧 $j$ 的权重可以计算为 $w'_j = \\exp(B_j - B_\\text{max})$。使用这些缩放后的权重，平均值的公式保持不变，因为 $\\exp(B_\\text{max})$ 项从分子和分母中被消除了：\n$$ \\langle E_r \\rangle = \\frac{\\sum_{j=1}^{N} E_{r,j} w'_j}{\\sum_{j=1}^{N} w'_j} $$\n这确保了最大指数为 0，并且不会发生溢出。\n\n每个残基的 MM 对活化自由能能垒的贡献 $\\Delta G_r$ 定义为过渡态 (TS) 和反应物态 (R) 之间无偏平均相互作用能的变化：\n$$ \\Delta G_r = \\langle E_r \\rangle_\\text{TS} - \\langle E_r \\rangle_\\text{R} $$\n$\\Delta G_r$ 的负值表示该残基与 QM 区域的相互作用在过渡态时比在反应物态时更有利（能量更低），这意味着对过渡态有稳定作用。\n\n计算过程如下：\n1. 对每个测试用例，定义系统参数：温度 $T$、要报告的前 $K$ 个残基的数量，以及反应物窗口和过渡态窗口的数据。\n2. 对每个窗口（反应物态和过渡态）：\n   a. 使用 $R = 8.314462618 \\times 10^{-3}$ kJ mol$^{-1}$ K$^{-1}$ 计算逆热能 $\\beta = (RT)^{-1}$。\n   b. 对每帧 $j$，计算谐波偏置势能 $U_{\\text{bias},j} = \\frac{1}{2} k (s_j - s_0)^2$。\n   c. 计算原始指数 $B_j = \\beta U_{\\text{bias},j}$。\n   d. 为保证数值稳定性，减去最大指数 $B_\\text{max}$ 并计算未归一化的权重 $w'_j = \\exp(B_j - B_\\text{max})$。\n   e. 对每个残基 $r$，使用权重 $w'_j$ 计算其在所有帧上的能量 $E_{r,j}$ 的加权平均值，从而得到无偏平均能量 $\\langle E_r \\rangle$。\n3. 对每个残基 $r$，计算能垒贡献 $\\Delta G_r = \\langle E_r \\rangle_\\text{TS} - \\langle E_r \\rangle_\\text{R}$。\n4. 创建一个包含能垒贡献和从 1 开始的残基索引的元组列表 $(\\Delta G_r, r)$。\n5. 首先按 $\\Delta G_r$ 升序（以找到贡献最负的值），然后按残基索引升序对该列表进行排序，以处理相同值。\n6. 从排序后的列表中选择前 $K$ 个结果，并将其格式化为 $[r, \\Delta G_r]$ 对，其中 $\\Delta G_r$ 四舍五入到三位小数。\n7. 将所有测试用例的结果整理到一个列表中，并以格式化字符串的形式打印出来。",
            "answer": "```python\nimport numpy as np\n\n# Universal molar gas constant in kJ/(mol*K)\nR_KJ_PER_MOL_K = 8.314462618 / 1000\n\ndef compute_unbiased_averages(T, k, s0, s_samples, E_samples):\n    \"\"\"\n    Computes unbiased ensemble averages of per-residue energies from a biased window.\n\n    Args:\n        T (float): Temperature in Kelvin.\n        k (float): Harmonic force constant in kJ/mol/Å^2.\n        s0 (float): Harmonic potential center in Å.\n        s_samples (np.ndarray): Array of reaction coordinate values for each frame.\n        E_samples (np.ndarray): 2D array (frames x residues) of interaction energies.\n\n    Returns:\n        np.ndarray: Array of unbiased average energies for each residue.\n    \"\"\"\n    beta = 1.0 / (R_KJ_PER_MOL_K * T)\n    \n    # Calculate bias energies for each frame\n    U_bias = 0.5 * k * (s_samples - s0)**2\n    \n    # Calculate exponents for reweighting, ensuring numerical stability\n    exponents = beta * U_bias\n    max_exponent = np.max(exponents)\n    weights = np.exp(exponents - max_exponent)\n    \n    # Sum of weights for normalization\n    sum_of_weights = np.sum(weights)\n    \n    # Calculate weighted average energies for each residue\n    # E_samples.T is (residues x frames), weights is (frames,)\n    # The @ operator performs matrix-vector multiplication\n    weighted_energies = E_samples.T @ weights\n    unbiased_avg_energies = weighted_energies / sum_of_weights\n    \n    return unbiased_avg_energies\n\ndef solve():\n    \"\"\"\n    Processes all test cases to identify residues with the largest stabilizing effects.\n    \"\"\"\n    test_cases = [\n        # Test case 1 (happy path)\n        {\n            \"T\": 300.0,\n            \"K\": 3,\n            \"reactant\": {\n                \"k\": 1000.0, \"s0\": 1.0,\n                \"s\": np.array([0.95, 0.98, 1.02, 1.05, 0.90]),\n                \"E\": np.array([\n                    [-2.0, 1.5, -0.5, 0.0, 0.2],\n                    [-1.8, 1.2, -0.6, 0.1, 0.3],\n                    [-2.2, 1.6, -0.4, 0.1, 0.2],\n                    [-1.9, 1.4, -0.5, 0.0, 0.1],\n                    [-2.1, 1.3, -0.6, -0.1, 0.2]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 1000.0, \"s0\": 2.0,\n                \"s\": np.array([1.95, 2.00, 2.05, 1.97, 2.02]),\n                \"E\": np.array([\n                    [-3.5, 2.0, -0.8, -0.2, 0.1],\n                    [-3.8, 2.3, -0.9, -0.3, 0.0],\n                    [-3.6, 2.1, -0.7, -0.2, 0.0],\n                    [-3.7, 2.2, -0.8, -0.1, -0.1],\n                    [-3.9, 2.4, -0.9, -0.2, 0.1]\n                ])\n            }\n        },\n        # Test case 2 (boundary condition: zero contributions and tie-handling)\n        {\n            \"T\": 300.0,\n            \"K\": 2,\n            \"reactant\": {\n                \"k\": 800.0, \"s0\": 1.0,\n                \"s\": np.array([1.00, 1.02, 0.98]),\n                \"E\": np.array([\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 800.0, \"s0\": 2.0,\n                \"s\": np.array([2.00, 2.02, 1.98]),\n                \"E\": np.array([\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0],\n                    [0.0, 0.0, 0.0, 0.0]\n                ])\n            }\n        },\n        # Test case 3 (edge case: very stiff bias and large deviations)\n        {\n            \"T\": 310.0,\n            \"K\": 2,\n            \"reactant\": {\n                \"k\": 2000.0, \"s0\": 1.0,\n                \"s\": np.array([0.70, 0.85, 1.00, 1.15, 1.30, 0.90]),\n                \"E\": np.array([\n                    [-1.0, 0.5, 0.2, 0.0],\n                    [-1.2, 0.6, 0.3, 0.1],\n                    [-1.1, 0.4, 0.2, 0.0],\n                    [-1.3, 0.7, 0.4, 0.2],\n                    [-0.8, 0.6, 0.1, 0.0],\n                    [-1.0, 0.5, 0.2, -0.1]\n                ])\n            },\n            \"transition_state\": {\n                \"k\": 2000.0, \"s0\": 2.0,\n                \"s\": np.array([1.70, 1.85, 2.00, 2.15, 2.30, 2.10]),\n                \"E\": np.array([\n                    [-2.0, 1.0, 0.3, -0.1],\n                    [-2.2, 1.1, 0.4, -0.1],\n                    [-2.1, 0.9, 0.3, -0.2],\n                    [-2.3, 1.2, 0.5, -0.1],\n                    [-1.8, 1.1, 0.2, 0.0],\n                    [-2.0, 1.0, 0.3, -0.1]\n                ])\n            }\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        # Calculate unbiased averages for reactant state\n        avg_E_reactant = compute_unbiased_averages(\n            case[\"T\"],\n            case[\"reactant\"][\"k\"],\n            case[\"reactant\"][\"s0\"],\n            case[\"reactant\"][\"s\"],\n            case[\"reactant\"][\"E\"]\n        )\n\n        # Calculate unbiased averages for transition state\n        avg_E_ts = compute_unbiased_averages(\n            case[\"T\"],\n            case[\"transition_state\"][\"k\"],\n            case[\"transition_state\"][\"s0\"],\n            case[\"transition_state\"][\"s\"],\n            case[\"transition_state\"][\"E\"]\n        )\n\n        # Calculate barrier contributions\n        delta_G = avg_E_ts - avg_E_reactant\n        \n        # Pair contributions with 1-based residue indices\n        num_residues = delta_G.shape[0]\n        results_with_indices = []\n        for i in range(num_residues):\n            residue_index = i + 1\n            results_with_indices.append((delta_G[i], residue_index))\n        \n        # Sort by contribution (ascending) and then by index (ascending) to break ties\n        results_with_indices.sort()\n\n        # Select top K and format for output\n        K = case[\"K\"]\n        case_output = []\n        for dG, r_idx in results_with_indices[:K]:\n            case_output.append([r_idx, round(dG, 3)])\n        \n        all_results.append(case_output)\n\n    # Format the final output string\n    # Using repr() to get space-less string representation of lists\n    results_str = [repr(result).replace(\" \", \"\") for result in all_results]\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        }
    ]
}