{
    "hands_on_practices": [
        {
            "introduction": "Before diving into the complexities of a dynamic simulation, it's crucial to master the underlying thermodynamic principles. This first practice grounds your understanding in the fundamental relationship between pH, $\\mathrm{p}K_a$, and the protonation state of a titratable site . By deriving the classic Henderson-Hasselbalch form from the law of mass action, you will see precisely how the environment's acidity dictates the equilibrium, a cornerstone concept for all CpHMD methods.",
            "id": "3840646",
            "problem": "In a Constant pH Molecular Dynamics (CpHMD) simulation, titration of a monoprotic site is governed by the classical acid dissociation equilibrium. Consider a single titratable site that can exist in a protonated state $\\mathrm{HA}$ and a deprotonated state $\\mathrm{A}^{-}$, coupled to a proton reservoir at a fixed acidity characterized by $\\mathrm{pH}$. The quantities $\\mathrm{pH}$ and $\\mathrm{p}K_a$ are defined by the thermodynamic activities of the proton and the acid dissociation constant, respectively, via $\\mathrm{pH} = -\\log_{10}\\left(a_{\\mathrm{H}^{+}}\\right)$ and $\\mathrm{p}K_a = -\\log_{10}\\left(K_{a}\\right)$. Assume ideal dilute behavior so that activities are well-approximated by concentrations. The fraction protonated at equilibrium is defined by $\\theta = \\frac{[\\mathrm{HA}]}{[\\mathrm{HA}] + [\\mathrm{A}^{-}]}$.\n\nStarting from the chemical equilibrium $\\mathrm{HA} \\rightleftharpoons \\mathrm{A}^{-} + \\mathrm{H}^{+}$, the law of mass action, and the above definitions of $\\mathrm{pH}$ and $\\mathrm{p}K_a$, derive $\\theta$ as a function of $\\mathrm{pH}$ and $\\mathrm{p}K_a$, without invoking any pre-existing shortcut formulas. Then, for a titratable site with $\\mathrm{p}K_a = 6.6$ in a reservoir at $\\mathrm{pH} = 7.4$, compute the numerical value of $\\theta$. Finally, obtain the leading-order asymptotic expressions for $\\theta$ in the limits $\\mathrm{pH} - \\mathrm{p}K_a \\to -\\infty$ and $\\mathrm{pH} - \\mathrm{p}K_a \\to +\\infty$.\n\nReport the numerical value of $\\theta$ as a dimensionless fraction, rounded to five significant figures. For the asymptotic limits, report dimensionless leading-order expressions. Provide your three results in the order: numerical $\\theta$ at the specified $\\mathrm{pH}$ and $\\mathrm{p}K_a$, leading-order expression for $\\mathrm{pH} \\ll \\mathrm{p}K_a$, and leading-order expression for $\\mathrm{pH} \\gg \\mathrm{p}K_a$. Present the final answers as a single row matrix.",
            "solution": "The problem statement is subjected to validation.\n\n### Step 1: Extract Givens\n-   **Equilibrium:** A single titratable site exists in a protonated state $\\mathrm{HA}$ and a deprotonated state $\\mathrm{A}^{-}$, coupled to a proton reservoir. The chemical equilibrium is $\\mathrm{HA} \\rightleftharpoons \\mathrm{A}^{-} + \\mathrm{H}^{+}$.\n-   **Definitions:**\n    -   $\\mathrm{pH} = -\\log_{10}\\left(a_{\\mathrm{H}^{+}}\\right)$\n    -   $\\mathrm{p}K_a = -\\log_{10}\\left(K_{a}\\right)$\n    -   Fraction protonated: $\\theta = \\frac{[\\mathrm{HA}]}{[\\mathrm{HA}] + [\\mathrm{A}^{-}]}$\n-   **Assumptions:** Ideal dilute behavior, where activities are approximated by concentrations (e.g., $a_{\\mathrm{H}^{+}} \\approx [\\mathrm{H}^{+}]$).\n-   **Constants:** For the numerical calculation, $\\mathrm{p}K_a = 6.6$ and $\\mathrm{pH} = 7.4$.\n-   **Required Outputs:**\n    1.  Derive $\\theta$ as a function of $\\mathrm{pH}$ and $\\mathrm{p}K_a$.\n    2.  Compute the numerical value of $\\theta$ for the given constants, rounded to five significant figures.\n    3.  Obtain the leading-order asymptotic expressions for $\\theta$ in the limits $\\mathrm{pH} - \\mathrm{p}K_a \\to -\\infty$ and $\\mathrm{pH} - \\mathrm{p}K_a \\to +\\infty$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded:** The problem describes the fundamental principles of acid-base equilibrium, governed by the law of mass action. The concepts of $\\mathrm{pH}$, $\\mathrm{p}K_a$, and protonation states are central to physical chemistry and biochemistry, and their application in the context of Constant pH Molecular Dynamics (CpHMD) is a standard practice in computational biophysics. The problem is scientifically sound.\n-   **Well-Posed:** The problem is clearly stated, with all necessary definitions and data provided. It requests a derivation, a numerical calculation, and an asymptotic analysis, all of which are well-defined mathematical tasks leading to a unique solution.\n-   **Objective:** The language is precise and quantitative. There are no subjective or opinion-based statements.\n-   **Completeness and Consistency:** The problem is self-contained. The provided information is sufficient and consistent for deriving the requested results.\n-   **Other Checks:** The problem is not trivial, unrealistic, or ill-posed. It represents a standard derivation and application of a core chemical principle.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\n\nThe process begins with the acid dissociation equilibrium for a monoprotic acid $\\mathrm{HA}$:\n$$\n\\mathrm{HA} \\rightleftharpoons \\mathrm{A}^{-} + \\mathrm{H}^{+}\n$$\nAccording to the law of mass action, the acid dissociation constant, $K_{a}$, is defined as the ratio of the concentrations of the products to the reactants at equilibrium:\n$$\nK_{a} = \\frac{[\\mathrm{A}^{-}] [\\mathrm{H}^{+}]}{[\\mathrm{HA}]}\n$$\nThe problem specifies that we should assume ideal dilute behavior, so activities are replaced by molar concentrations.\n\nWe can rearrange this expression to find the ratio of the deprotonated species concentration to the protonated species concentration:\n$$\n\\frac{[\\mathrm{A}^{-}]}{[\\mathrm{HA}]} = \\frac{K_{a}}{[\\mathrm{H}^{+}]}\n$$\nThe problem defines $\\mathrm{p}K_a$ and $\\mathrm{pH}$ as follows:\n$$\n\\mathrm{p}K_a = -\\log_{10}(K_{a}) \\implies K_{a} = 10^{-\\mathrm{p}K_a}\n$$\n$$\n\\mathrm{pH} = -\\log_{10}([\\mathrm{H}^{+}]) \\implies [\\mathrm{H}^{+}] = 10^{-\\mathrm{pH}}\n$$\nSubstituting these expressions for $K_{a}$ and $[\\mathrm{H}^{+}]$ into the ratio equation gives:\n$$\n\\frac{[\\mathrm{A}^{-}]}{[\\mathrm{HA}]} = \\frac{10^{-\\mathrm{p}K_a}}{10^{-\\mathrm{pH}}} = 10^{\\mathrm{pH} - \\mathrm{p}K_a}\n$$\nThis equation is a form of the Henderson-Hasselbalch equation.\n\nThe fraction of the site that is in the protonated state, $\\theta$, is defined as:\n$$\n\\theta = \\frac{[\\mathrm{HA}]}{[\\mathrm{HA}] + [\\mathrm{A}^{-}]}\n$$\nTo express $\\theta$ as a function of the ratio we derived, we can divide both the numerator and the denominator by $[\\mathrm{HA}]$:\n$$\n\\theta = \\frac{\\frac{[\\mathrm{HA}]}{[\\mathrm{HA}]}}{\\frac{[\\mathrm{HA}]}{[\\mathrm{HA}]} + \\frac{[\\mathrm{A}^{-}]}{[\\mathrm{HA}]}} = \\frac{1}{1 + \\frac{[\\mathrm{A}^{-}]}{[\\mathrm{HA}]}}\n$$\nSubstituting the expression for the concentration ratio, we arrive at the desired function for $\\theta$ in terms of $\\mathrm{pH}$ and $\\mathrm{p}K_a$:\n$$\n\\theta(\\mathrm{pH}, \\mathrm{p}K_a) = \\frac{1}{1 + 10^{\\mathrm{pH} - \\mathrm{p}K_a}}\n$$\n\nNext, we compute the numerical value of $\\theta$ for the given parameters: $\\mathrm{p}K_a = 6.6$ and $\\mathrm{pH} = 7.4$.\nFirst, calculate the exponent:\n$$\n\\mathrm{pH} - \\mathrm{p}K_a = 7.4 - 6.6 = 0.8\n$$\nNow, substitute this value into the expression for $\\theta$:\n$$\n\\theta = \\frac{1}{1 + 10^{0.8}}\n$$\nCalculating the value of $10^{0.8}$:\n$$\n10^{0.8} \\approx 6.30957344\n$$\nTherefore, $\\theta$ is:\n$$\n\\theta = \\frac{1}{1 + 6.30957344} = \\frac{1}{7.30957344} \\approx 0.136806657\n$$\nRounding to five significant figures as requested, we get:\n$$\n\\theta \\approx 0.13681\n$$\n\nFinally, we determine the leading-order asymptotic expressions for $\\theta$. Let the variable $\\Delta = \\mathrm{pH} - \\mathrm{p}K_a$. The function is $\\theta(\\Delta) = \\frac{1}{1 + 10^{\\Delta}}$.\n\nCase 1: $\\mathrm{pH} \\ll \\mathrm{p}K_a$, which corresponds to the limit $\\Delta \\to -\\infty$.\nIn this limit, the term $10^{\\Delta}$ approaches $0$:\n$$\n\\lim_{\\Delta \\to -\\infty} 10^{\\Delta} = 0\n$$\nSo, the expression for $\\theta$ becomes:\n$$\n\\lim_{\\Delta \\to -\\infty} \\theta(\\Delta) = \\lim_{\\Delta \\to -\\infty} \\frac{1}{1 + 10^{\\Delta}} = \\frac{1}{1 + 0} = 1\n$$\nThe leading-order expression for $\\theta$ is $1$. This is physically intuitive: at very low $\\mathrm{pH}$ (highly acidic conditions relative to the $\\mathrm{p}K_a$), the equilibrium strongly favors the protonated state $\\mathrm{HA}$, so the fraction protonated approaches $1$.\n\nCase 2: $\\mathrm{pH} \\gg \\mathrm{p}K_a$, which corresponds to the limit $\\Delta \\to +\\infty$.\nIn this limit, the term $10^{\\Delta}$ approaches $+\\infty$. The $1$ in the denominator becomes negligible compared to $10^{\\Delta}$:\n$$\n1 + 10^{\\Delta} \\sim 10^{\\Delta} \\quad \\text{as} \\quad \\Delta \\to +\\infty\n$$\nSo, the asymptotic behavior of $\\theta$ is:\n$$\n\\theta(\\Delta) \\approx \\frac{1}{10^{\\Delta}} = 10^{-\\Delta} \\quad \\text{for large positive } \\Delta\n$$\nSubstituting back $\\Delta = \\mathrm{pH} - \\mathrm{p}K_a$:\n$$\n\\theta \\approx 10^{-(\\mathrm{pH} - \\mathrm{p}K_a)} = 10^{\\mathrm{p}K_a - \\mathrm{pH}}\n$$\nThe leading-order expression for $\\theta$ is $10^{\\mathrm{p}K_a - \\mathrm{pH}}$. This is also physically intuitive: at very high $\\mathrm{pH}$ (highly basic conditions relative to the $\\mathrm{p}K_a$), the site is almost completely deprotonated, and the small remaining fraction of protonated species decreases exponentially as the $\\mathrm{pH}$ increases.\n\nThe three results are the numerical value $0.13681$, the asymptotic limit $1$ for $\\mathrm{pH} \\ll \\mathrm{p}K_a$, and the asymptotic limit $10^{\\mathrm{p}K_a - \\mathrm{pH}}$ for $\\mathrm{pH} \\gg \\mathrm{p}K_a$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.13681 & 1 & 10^{\\mathrm{p}K_a - \\mathrm{pH}} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "How does a simulation translate the macroscopic concept of pH into a microscopic decision to protonate or deprotonate a residue? This exercise takes you into the engine room of many CpHMD algorithms, which use Monte Carlo moves within a semi-grand canonical ensemble . You will derive the Metropolis acceptance probability for a protonation state change, revealing how the system's potential energy change is weighed against the chemical potential of the proton reservoir to drive the simulation toward equilibrium.",
            "id": "3840624",
            "problem": "A single titratable residue in a Constant pH Molecular Dynamics (CpHMD) simulation is coupled to a proton reservoir modeled in the semi-grand canonical ensemble. The coupling is implemented via occasional Metropolis Monte Carlo (MC) trial moves that change the protonation state. Consider a trial deprotonation move that removes one proton from the system, changing the number of protons by $\\Delta N_{H^+}=-1$. The simulation is conducted at absolute temperature $T=298.15$ Kelvin. The intramolecular potential energy difference between the proposed deprotonated state and the current protonated state is $\\Delta U=+50.0$ kilojoules per mole. Assume ideal solution behavior so that the proton activity is equal to its molar concentration and is given by $a_{H^+}=10^{-\\mathrm{pH}}$. The proton reservoir is characterized by a chemical potential $\\mu_{H^+}$ that obeys the thermodynamic relation $\\mu_{H^+}=\\mu_{H^+}^{\\circ}+RT\\ln a_{H^+}$, where $R$ is the gas constant and the standard chemical potential $\\mu_{H^+}^{\\circ}$ defines the zero of energy for the reservoir; take $\\mu_{H^+}^{\\circ}=0$ kilojoules per mole so that only the activity term contributes. Use $R=8.314462618\\times 10^{-3}$ kilojoules per mole per Kelvin. The system pH is $\\mathrm{pH}=7$.\n\nStarting from the semi-grand canonical ensemble definition of the Boltzmann weight, which for a state with potential energy $U$ and proton number $N_{H^+}$ is proportional to $\\exp\\!\\big(-\\beta\\,[U-\\mu_{H^+}N_{H^+}]\\big)$ with $\\beta=(RT)^{-1}$ in molar units, derive the Metropolis acceptance probability for the trial deprotonation move and compute its numerical value at the specified conditions. Express the final acceptance probability as a unitless decimal. Round your answer to four significant figures.",
            "solution": "The problem is first validated to ensure it is scientifically sound, self-contained, and well-posed.\n\n**Step 1: Extract Givens**\n- Ensemble: Semi-grand canonical ensemble.\n- Boltzmann weight: Proportional to $\\exp(-\\beta[U-\\mu_{H^+}N_{H^+}])$, where $\\beta=(RT)^{-1}$.\n- Process: Metropolis Monte Carlo (MC) trial deprotonation move.\n- Change in proton number: $\\Delta N_{H^+} = -1$.\n- Temperature: $T=298.15$ Kelvin.\n- Intramolecular potential energy difference: $\\Delta U = +50.0$ kilojoules per mole.\n- Proton activity: $a_{H^+} = 10^{-\\mathrm{pH}}$.\n- Proton chemical potential: $\\mu_{H^+} = \\mu_{H^+}^{\\circ} + RT\\ln a_{H^+}$.\n- Standard chemical potential: $\\mu_{H^+}^{\\circ} = 0$ kilojoules per mole.\n- Gas constant: $R = 8.314462618 \\times 10^{-3}$ kilojoules per mole per Kelvin.\n- System pH: $\\mathrm{pH}=7$.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, describing a standard procedure in computational chemical biology (Constant pH Molecular Dynamics). The thermodynamic framework (semi-grand canonical ensemble), the form of the chemical potential, and the Metropolis acceptance criterion are standard in statistical mechanics. All necessary data are provided, and the values are physically realistic. The problem is well-posed, objective, and contains no internal contradictions or logical flaws.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A full, reasoned solution will be provided.\n\n**Derivation and Calculation**\nThe Metropolis acceptance probability, $P_{\\text{acc}}$, for a trial move from an initial state $i$ to a final state $j$ is given by:\n$$\nP_{\\text{acc}}(i \\to j) = \\min\\left(1, \\frac{\\pi_j}{\\pi_i}\\right)\n$$\nwhere $\\pi_i$ and $\\pi_j$ are the equilibrium probabilities of the respective states. In the semi-grand canonical ensemble, the probability $\\pi$ of a state with intramolecular potential energy $U$ and particle number $N_{H^+}$ is proportional to its Boltzmann weight:\n$$\n\\pi \\propto \\exp\\left(-\\beta\\left[U - \\mu_{H^+}N_{H^+}\\right]\\right)\n$$\nHere, $\\beta = (RT)^{-1}$, $\\mu_{H^+}$ is the chemical potential of the proton, and $N_{H^+}$ is the number of protons on the titratable site.\n\nLet the initial state $i$ be the protonated state, with energy $U_i$ and proton number $N_{H^+, i} = 1$. Let the final state $j$ be the deprotonated state, with energy $U_j$ and proton number $N_{H^+, j} = 0$. The ratio of the probabilities is:\n$$\n\\frac{\\pi_j}{\\pi_i} = \\frac{\\exp\\left(-\\beta\\left[U_j - \\mu_{H^+}N_{H^+, j}\\right]\\right)}{\\exp\\left(-\\beta\\left[U_i - \\mu_{H^+}N_{H^+, i}\\right]\\right)} = \\exp\\left(-\\beta\\left[(U_j - U_i) - \\mu_{H^+}(N_{H^+, j} - N_{H^+, i})\\right]\\right)\n$$\nWe identify the terms with the given quantities:\n- The change in intramolecular potential energy is $\\Delta U = U_j - U_i$.\n- The change in the number of protons on the site is $\\Delta N_{H^+} = N_{H^+, j} - N_{H^+, i} = 0 - 1 = -1$.\n\nSubstituting these into the ratio gives:\n$$\n\\frac{\\pi_j}{\\pi_i} = \\exp\\left(-\\beta\\left[\\Delta U - \\mu_{H^+}\\Delta N_{H^+}\\right]\\right) = \\exp\\left(-\\frac{\\Delta U - \\mu_{H^+}\\Delta N_{H^+}}{RT}\\right)\n$$\nNext, we express the chemical potential $\\mu_{H^+}$ in terms of the given parameters. The relation is $\\mu_{H^+} = \\mu_{H^+}^{\\circ} + RT\\ln a_{H^+}$. With the standard chemical potential $\\mu_{H^+}^{\\circ} = 0$ and the proton activity $a_{H^+} = 10^{-\\mathrm{pH}}$, we have:\n$$\n\\mu_{H^+} = RT\\ln(10^{-\\mathrm{pH}}) = -(\\mathrm{pH}) (RT\\ln 10)\n$$\nThe argument of the exponential, which represents the change in the semi-grand free energy, is $\\Delta\\Omega^* = \\Delta U - \\mu_{H^+}\\Delta N_{H^+}$. For the deprotonation move ($\\Delta N_{H^+} = -1$):\n$$\n\\Delta\\Omega^* = \\Delta U - \\left(-(\\mathrm{pH}) (RT\\ln 10)\\right)(-1) = \\Delta U - (\\mathrm{pH}) (RT\\ln 10)\n$$\nThe acceptance probability is therefore:\n$$\nP_{\\text{acc}} = \\min\\left(1, \\exp\\left(-\\frac{\\Delta\\Omega^*}{RT}\\right)\\right) = \\min\\left(1, \\exp\\left(-\\frac{\\Delta U - (\\mathrm{pH})(RT\\ln 10)}{RT}\\right)\\right)\n$$\nThis can be simplified to:\n$$\nP_{\\text{acc}} = \\min\\left(1, \\exp\\left(-\\frac{\\Delta U}{RT} + \\mathrm{pH}\\ln 10\\right)\\right)\n$$\nNow we can substitute the numerical values.\nFirst, calculate the thermal energy $RT$:\n$$\nRT = \\left(8.314462618 \\times 10^{-3} \\frac{\\text{kJ}}{\\text{mol} \\cdot \\text{K}}\\right) \\times (298.15 \\text{ K}) \\approx 2.478957 \\frac{\\text{kJ}}{\\text{mol}}\n$$\nThe problem specifies $\\Delta U = +50.0$ kJ/mol and $\\mathrm{pH}=7$.\nThe exponent is:\n$$\n-\\frac{\\Delta U}{RT} + \\mathrm{pH}\\ln 10 = -\\frac{50.0 \\frac{\\text{kJ}}{\\text{mol}}}{2.478957 \\frac{\\text{kJ}}{\\text{mol}}} + 7 \\ln 10\n$$\nUsing $\\ln 10 \\approx 2.302585$:\n$$\n\\text{Exponent} \\approx -20.169784 + 7 \\times 2.302585 = -20.169784 + 16.118095 = -4.051689\n$$\nThe probability ratio is:\n$$\n\\exp(-4.051689) \\approx 0.0173928\n$$\nThe acceptance probability is the minimum of $1$ and this value:\n$$\nP_{\\text{acc}} = \\min(1, 0.0173928) = 0.0173928\n$$\nRounding the result to four significant figures, we get $0.01739$.",
            "answer": "$$\n\\boxed{0.01739}\n$$"
        },
        {
            "introduction": "A simulation produces a stream of data, but when is it enough? This final practice addresses the critical and often overlooked task of assessing convergence and estimating statistical error, which separates a preliminary run from a robust scientific result . You will implement a complete statistical pipeline—from maximum likelihood estimation to block averaging—to determine not only the value of a $\\mathrm{p}K_a$, but also its reliability, providing a powerful framework for ensuring your computational measurements are sound.",
            "id": "5247475",
            "problem": "You are tasked with designing, formalizing, and implementing convergence diagnostics for estimating the acid dissociation constant ($\\mathrm{p}K_a$) in constant pH molecular dynamics (CpHMD), grounded in first principles. Consider a single monoprotic titratable site simulated at multiple hydrogen ion concentration conditions, where the system is at quasi-equilibrium at each hydrogen ion concentration value. At each hydrogen ion concentration value $pH_i$, you observe a time series of a binary deprotonation indicator $y_{i,t} \\in \\{0,1\\}$ for frames $t = 1,2,\\dots,T$, where $y_{i,t} = 1$ denotes the site is deprotonated. Assume each $y_{i,t}$ is an independent and identically distributed Bernoulli random variable at fixed $pH_i$ with success probability $\\alpha_i$, and that for a monoprotic acid the macroscopic fraction deprotonated obeys the Henderson–Hasselbalch relation $\\alpha_i = \\dfrac{1}{1 + 10^{\\mathrm{p}K_a - pH_i}}$. Your goal is to construct from these first principles a statistically principled estimator $\\hat{pK}_a$ by maximum likelihood across all $pH_i$, and to propose two independent convergence diagnostics: a running estimate stability criterion and a block-averaged uncertainty criterion. The stopping rule must declare convergence only if both diagnostics agree and a minimum observation time has elapsed.\n\nUsing only the above base, implement the following requirements.\n\n1) Estimation model. For any collection of counts $\\{k_i, n_i\\}$ where $k_i$ is the number of deprotonated observations and $n_i$ is the total number of observations at hydrogen ion concentration $pH_i$, derive and implement the one-dimensional maximum likelihood estimator $\\hat{pK}_a$ by minimizing the negative log-likelihood implied by independent Bernoulli observations and the Henderson–Hasselbalch relation. Your program must compute $\\hat{pK}_a$ numerically without closed-form shortcuts.\n\n2) Running estimate diagnostic. Define a cumulative-time estimator $\\hat{pK}_a(\\tau)$ computed from $\\{k_i(\\tau), n_i(\\tau)\\}$, where $k_i(\\tau)$ and $n_i(\\tau)$ are the cumulative counts up to frame $\\tau$ at each $pH_i$. For a specified stride $s$, compute the sequence $\\hat{pK}_a(s), \\hat{pK}_a(2s), \\dots, \\hat{pK}_a(m s)$ where $m s \\le T$. Define the running stability diagnostic to be satisfied if the range of the most recent $r$ values, taken at times not less than a minimum time $\\tau_{\\min}$, is strictly less than a tolerance $\\varepsilon$. That is, with the last $r$ values $u_1,\\dots,u_r$, require $\\max_j u_j - \\min_j u_j < \\varepsilon$.\n\n3) Block-averaged uncertainty diagnostic. Partition each time series at each hydrogen ion concentration evenly into non-overlapping blocks of length $L$ frames, discarding any incomplete tail block. For each block $b = 1,\\dots,B$, compute a blockwise estimator $\\hat{pK}_a^{(b)}$ by maximum likelihood using only that block’s counts across all hydrogen ion concentrations. Let the sample variance across blocks be $s^2 = \\dfrac{1}{B-1} \\sum_{b=1}^{B} \\left(\\hat{pK}_a^{(b)} - \\bar{p}\\right)^2$, where $\\bar{p} = \\dfrac{1}{B}\\sum_{b=1}^{B} \\hat{pK}_a^{(b)}$. Define the block-averaged standard error as $s_{\\hat{pK}_a} = \\sqrt{s^2/B}$. The block diagnostic is satisfied if $B \\ge 2$ and $s_{\\hat{pK}_a} < \\sigma_{\\max}$.\n\n4) Stopping rule. Declare convergence if and only if both the running estimate diagnostic and the block-averaged uncertainty diagnostic are satisfied, and the total observed time $T$ is at least $\\tau_{\\min}$. The reported point estimate must be the final running estimate $\\hat{pK}_a(T)$, and the reported uncertainty must be $s_{\\hat{pK}_a}$.\n\n5) Numerical reproducibility. Your implementation must perform the one-dimensional optimization for $\\hat{pK}_a$ over a bounded domain chosen as a function of the hydrogen ion concentration grid, and must protect against numerical underflow or overflow in the Henderson–Hasselbalch probabilities. All randomness used to generate synthetic observations must be seeded and specified in the test suite.\n\nTest suite. Implement your program to generate synthetic data according to the Bernoulli model described above with the Henderson–Hasselbalch relation. For each test case, generate binary time series independently at each hydrogen ion concentration using a fixed seed and a specified true acid dissociation constant $\\mathrm{p}K_a^\\star$ (the program must not use $\\mathrm{p}K_a^\\star$ for estimation or diagnostics). The hydrogen ion concentration values, lengths, and parameters are:\n\n- Test case A (happy path):\n  - Seed: $12345$.\n  - Hydrogen ion concentration grid: $[5.0, 6.0, 7.0, 8.0]$.\n  - True acid dissociation constant for data generation: $\\mathrm{p}K_a^\\star = 6.5$.\n  - Frames per hydrogen ion concentration: $T = 4000$.\n  - Running stride: $s = 200$.\n  - Running window count: $r = 3$.\n  - Running tolerance: $\\varepsilon = 0.05$.\n  - Block length: $L = 250$.\n  - Maximum allowed standard error: $\\sigma_{\\max} = 0.10$.\n  - Minimum time: $\\tau_{\\min} = 1000$.\n\n- Test case B (insufficient sampling):\n  - Seed: $67890$.\n  - Hydrogen ion concentration grid: $[5.5, 6.0, 7.0, 7.5]$.\n  - True acid dissociation constant for data generation: $\\mathrm{p}K_a^\\star = 6.4$.\n  - Frames per hydrogen ion concentration: $T = 600$.\n  - Running stride: $s = 100$.\n  - Running window count: $r = 3$.\n  - Running tolerance: $\\varepsilon = 0.05$.\n  - Block length: $L = 200$.\n  - Maximum allowed standard error: $\\sigma_{\\max} = 0.08$.\n  - Minimum time: $\\tau_{\\min} = 600$.\n\n- Test case C (edge case with non-divisible blocks and tighter tolerance):\n  - Seed: $24680$.\n  - Hydrogen ion concentration grid: $[6.0, 6.5, 7.0, 7.5, 8.0]$.\n  - True acid dissociation constant for data generation: $\\mathrm{p}K_a^\\star = 7.0$.\n  - Frames per hydrogen ion concentration: $T = 1792$.\n  - Running stride: $s = 128$.\n  - Running window count: $r = 4$.\n  - Running tolerance: $\\varepsilon = 0.03$.\n  - Block length: $L = 256$.\n  - Maximum allowed standard error: $\\sigma_{\\max} = 0.06$.\n  - Minimum time: $\\tau_{\\min} = 1024$.\n\nAll quantities are dimensionless; no physical units are required.\n\nProgram output specification. Your program must generate the data for each test case, perform estimation and diagnostics, and return, for each test case in order A, B, C, a list of three values: the convergence boolean, the final estimate $\\hat{pK}_a(T)$ rounded to four decimal places, and the block-averaged standard error $s_{\\hat{pK}_a}$ rounded to four decimal places. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result\\_A,result\\_B,result\\_C]$), where each $result\\_*$ is itself a list in the form $[converged,\\hat{pK}_a,s_{\\hat{pK}_a}]$.",
            "solution": "The problem statement has been meticulously validated and is determined to be valid. It is scientifically grounded in the principles of statistical mechanics and chemical equilibrium, well-posed with a clear mathematical and algorithmic structure, and provides a complete, self-contained set of requirements and test data. There are no contradictions, ambiguities, or factual inaccuracies. We may therefore proceed with a complete solution.\n\nThe task is to formalize and implement a set of convergence diagnostics for estimating the acid dissociation constant, $\\mathrm{p}K_a$, from constant hydrogen ion concentration molecular dynamics (CpHMD) simulations. This involves three primary components: a maximum likelihood estimator for $\\mathrm{p}K_a$, a running estimate stability diagnostic, and a block-averaged uncertainty diagnostic.\n\n**1. Maximum Likelihood Estimation of $\\mathrm{p}K_a$**\n\nThe estimation is founded on a statistical model of the simulation data. For each hydrogen ion concentration condition, indexed by $i$, we observe a time series of a binary deprotonation indicator, $y_{i,t} \\in \\{0, 1\\}$. It is assumed that for a fixed $pH_i$, the observations $y_{i,t}$ are independent and identically distributed (i.i.d.) Bernoulli random variables with a success probability $\\alpha_i$, which represents the fraction of deprotonated molecules.\nThe probability of observing $k_i$ deprotonated states in $n_i$ total frames at $pH_i$ is given by the binomial probability mass function:\n$$ P(k_i | n_i, \\alpha_i) = \\binom{n_i}{k_i} \\alpha_i^{k_i} (1-\\alpha_i)^{n_i-k_i} $$\nThe deprotonation probability $\\alpha_i$ is linked to the macroscopic $\\mathrm{p}K_a$ and the simulation's $pH_i$ via the Henderson-Hasselbalch relation:\n$$ \\alpha_i(\\mathrm{p}K_a) = \\frac{1}{1 + 10^{\\mathrm{p}K_a - pH_i}} $$\nSince the simulations at different $pH_i$ values are independent, the total likelihood function $L(\\mathrm{p}K_a)$ for a set of observations $\\{k_i, n_i\\}$ across all $pH$ conditions is the product of the individual binomial probabilities:\n$$ L(\\mathrm{p}K_a; \\{k_i, n_i\\}) = \\prod_{i} \\binom{n_i}{k_i} \\left[\\alpha_i(\\mathrm{p}K_a)\\right]^{k_i} \\left[1-\\alpha_i(\\mathrm{p}K_a)\\right]^{n_i-k_i} $$\nThe maximum likelihood estimator (MLE) $\\hat{pK}_a$ is the value of $\\mathrm{p}K_a$ that maximizes $L(\\mathrm{p}K_a)$. It is computationally more convenient to maximize the natural logarithm of the likelihood, $\\ln L(\\mathrm{p}K_a)$:\n$$ \\ln L(\\mathrm{p}K_a) = \\sum_{i} \\left[ \\ln\\binom{n_i}{k_i} + k_i \\ln \\alpha_i(\\mathrm{p}K_a) + (n_i - k_i) \\ln(1 - \\alpha_i(\\mathrm{p}K_a)) \\right] $$\nMaximizing $\\ln L(\\mathrm{p}K_a)$ is equivalent to minimizing its negative, the negative log-likelihood (NLL). The term $\\ln\\binom{n_i}{k_i}$ is constant with respect to $\\mathrm{p}K_a$ and can be omitted from the optimization objective. The function to minimize is therefore:\n$$ f(\\mathrm{p}K_a) = - \\sum_{i} \\left[ k_i \\ln \\alpha_i(\\mathrm{p}K_a) + (n_i - k_i) \\ln(1 - \\alpha_i(\\mathrm{p}K_a)) \\right] $$\nTo derive a numerically stable form, we substitute the Henderson-Hasselbalch expressions for $\\alpha_i$ and $1-\\alpha_i$:\n- $1 - \\alpha_i(\\mathrm{p}K_a) = 1 - \\frac{1}{1 + 10^{\\mathrm{p}K_a - pH_i}} = \\frac{10^{\\mathrm{p}K_a - pH_i}}{1 + 10^{\\mathrm{p}K_a - pH_i}}$\n- $\\ln \\alpha_i(\\mathrm{p}K_a) = -\\ln(1 + 10^{\\mathrm{p}K_a - pH_i})$\n- $\\ln(1 - \\alpha_i(\\mathrm{p}K_a)) = (\\mathrm{p}K_a - pH_i)\\ln(10) - \\ln(1 + 10^{\\mathrm{p}K_a - pH_i})$\n\nSubstituting and simplifying, the objective function becomes:\n$$ f(\\mathrm{p}K_a) = \\sum_{i} \\left[ n_i \\ln(1 + 10^{\\mathrm{p}K_a - pH_i}) - (n_i - k_i)(\\mathrm{p}K_a - pH_i)\\ln(10) \\right] $$\nThe term $\\ln(1 + 10^x)$, where $x = \\mathrm{p}K_a - pH_i$, is susceptible to numerical overflow. It can be computed robustly as $\\ln(1 + e^{x \\ln 10})$, for which stable library functions (e.g., `logaddexp`) exist. The minimization of this one-dimensional function $f(\\mathrm{p}K_a)$ will be performed numerically over a bounded interval, chosen to be slightly larger than the range of simulated $pH_i$ values, e.g., $[\\min(pH_i) - 2, \\max(pH_i) + 2]$.\n\n**2. Convergence Diagnostics and Stopping Rule**\n\nTwo independent diagnostics are required to assess the convergence of the $\\mathrm{p}K_a$ estimate.\n\n**A. Running Estimate Stability Diagnostic**\nThis diagnostic assesses the stability of the $\\mathrm{p}K_a$ estimate as more data is accumulated.\n1.  Define a cumulative-time estimator $\\hat{pK}_a(\\tau)$ as the MLE computed using data from frames $1$ to $\\tau$ for all $pH_i$ conditions.\n2.  Compute a sequence of these estimators at regular time intervals: $\\hat{pK}_a(s), \\hat{pK}_a(2s), \\dots, \\hat{pK}_a(ms)$, where $s$ is the stride and $ms \\le T$ is the total simulation length.\n3.  The diagnostic is satisfied if the range (maximum minus minimum) of the most recent $r$ estimates, taken from times $\\tau \\ge \\tau_{\\min}$, is strictly less than a tolerance $\\varepsilon$. Formally, let $\\{u_1, u_2, \\dots, u_m\\}$ be the sequence of estimates $\\hat{pK}_a(\\tau)$ calculated at times $\\tau \\ge \\tau_{\\min}$. If $m \\ge r$, the condition is $\\max(u_{m-r+1}, \\dots, u_m) - \\min(u_{m-r+1}, \\dots, u_m) < \\varepsilon$.\n\n**B. Block-Averaged Uncertainty Diagnostic**\nThis diagnostic estimates the statistical uncertainty of the $\\mathrm{p}K_a$ estimate using the block averaging method.\n1.  For each $pH_i$, partition the time series of length $T$ into $B = \\lfloor T/L \\rfloor$ non-overlapping blocks, each of length $L$. Any trailing data that does not form a full block is discarded.\n2.  For each block index $b \\in \\{1, \\dots, B\\}$, compute a block-specific MLE, $\\hat{pK}_a^{(b)}$, using only the data from that block across all $pH_i$ conditions.\n3.  The set of block estimates $\\{\\hat{pK}_a^{(b)}\\}_{b=1}^B$ is treated as a sample of i.i.d. random variables. The standard error of their mean is calculated as an estimate of the uncertainty in the overall $\\mathrm{p}K_a$. First, compute the sample mean $\\bar{p} = \\frac{1}{B}\\sum_{b=1}^{B} \\hat{pK}_a^{(b)}$ and sample variance $s^2 = \\frac{1}{B-1} \\sum_{b=1}^{B} (\\hat{pK}_a^{(b)} - \\bar{p})^2$.\n4.  The block-averaged standard error is $s_{\\hat{pK}_a} = \\sqrt{s^2/B}$.\n5.  The diagnostic is satisfied if the number of blocks is at least $2$ (i.e., $B \\ge 2$) and the standard error is below a specified threshold: $s_{\\hat{pK}_a} < \\sigma_{\\max}$.\n\n**C. Stopping Rule**\nConvergence is declared if and only if all three of the following conditions are met:\n1.  The total simulation time $T$ has reached or exceeded a minimum time: $T \\ge \\tau_{\\min}$.\n2.  The running estimate stability diagnostic is satisfied.\n3.  The block-averaged uncertainty diagnostic is satisfied.\n\nIf convergence is achieved, the reported point estimate is the final cumulative-time estimate $\\hat{pK}_a(T)$, and the reported uncertainty is the block-averaged standard error $s_{\\hat{pK}_a}$.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import minimize_scalar\n\ndef nll_pka(pka, k, n, phs, log10_val):\n    \"\"\"\n    Computes the negative log-likelihood for a given pKa.\n\n    Args:\n        pka (float): The candidate pKa value.\n        k (np.ndarray): Array of deprotonated counts for each pH.\n        n (np.ndarray): Array of total counts (frames) for each pH.\n        phs (np.ndarray): Array of pH values.\n        log10_val (float): The value of np.log(10).\n\n    Returns:\n        float: The negative log-likelihood.\n    \"\"\"\n    x = (pka - phs) * log10_val\n    # Numerically stable calculation of log(1 + 10^(pka - pH))\n    log_term = np.logaddexp(0, x)\n    \n    # an_i = 1 / (1 + 10^{pK_a - pH_i}) -> log(a_i) = -log_term\n    # 1-an_i = 10^{pKa-pH_i} / (1+10...) -> log(1-a_i) = x - log_term, so log(1-a_i) = (pka-ph_i) * log(10) - log_term\n    # NLL = - sum_i { k_i log(a_i) + (n_i-k_i) log(1-a_i) }\n    # NLL = - sum_i { -k_i*log_term + (n_i-k_i)*(x - log_term) }\n    # NLL = - sum_i { (n_i-k_i)*x - n_i*log_term }\n    # NLL = sum_i { n_i*log_term - (n_i-k_i)*x }\n    \n    return np.sum(n * log_term - (n - k) * x)\n\ndef calculate_pka(k, n, phs):\n    \"\"\"\n    Calculates the maximum likelihood estimate of pKa.\n    \n    Args:\n        k (np.ndarray): Array of deprotonated counts.\n        n (np.ndarray): Array of total counts.\n        phs (np.ndarray): Array of pH values.\n        \n    Returns:\n        float: The estimated pKa value.\n    \"\"\"\n    # If all states are the same across all pHs, the likelihood is monotonic.\n    # The optimizer will hit the bounds, which is an acceptable outcome.\n    if np.all(k == 0) or np.all(k == n):\n        # A more sophisticated approach might return +/- inf, but for this problem,\n        # letting the bounded optimizer find the edge is sufficient.\n        pass\n\n    log10_val = np.log(10)\n    \n    # Define a bounded search domain as per the problem description.\n    bounds = (min(phs) - 2.0, max(phs) + 2.0)\n    \n    result = minimize_scalar(\n        nll_pka,\n        args=(k, n, phs, log10_val),\n        bounds=bounds,\n        method='bounded'\n    )\n    \n    return result.x\n\ndef generate_data(pka_star, phs, T, seed):\n    \"\"\"Generates synthetic CpHMD data.\"\"\"\n    rng = np.random.default_rng(seed)\n    data = []\n    for ph in phs:\n        alpha = 1.0 / (1.0 + 10**(pka_star - ph))\n        time_series = rng.binomial(1, alpha, size=T)\n        data.append(time_series)\n    return np.array(data)\n\ndef run_diagnostics(params):\n    \"\"\"\n    Performs estimation and diagnostics for a single test case.\n    \"\"\"\n    # Unpack parameters\n    pka_star = params['pka_star']\n    phs = np.array(params['phs'])\n    T = params['T']\n    seed = params['seed']\n    s = params['stride']\n    r = params['run_window']\n    epsilon = params['run_tol']\n    L = params['block_len']\n    sigma_max = params['max_se']\n    tau_min = params['min_time']\n\n    # 1. Generate synthetic data\n    data = generate_data(pka_star, phs, T, seed)\n\n    # 2. Running estimate diagnostic\n    running_pka_estimates = []\n    times = list(range(s, T + 1, s))\n    for t in times:\n        sub_data = data[:, :t]\n        k = np.sum(sub_data, axis=1)\n        n = np.full_like(k, t)\n        pka_est = calculate_pka(k, n, phs)\n        running_pka_estimates.append(pka_est)\n\n    running_check = False\n    relevant_estimates = []\n    for i in range(len(times)):\n        if times[i] >= tau_min:\n            relevant_estimates.append(running_pka_estimates[i])\n\n    if len(relevant_estimates) >= r:\n        last_r_values = relevant_estimates[-r:]\n        pka_range = max(last_r_values) - min(last_r_values)\n        if pka_range < epsilon:\n            running_check = True\n\n    # 3. Block-averaged uncertainty diagnostic\n    num_blocks = T // L\n    block_check = False\n    std_error = np.nan\n\n    if num_blocks >= 2:\n        block_pka_estimates = []\n        for b in range(num_blocks):\n            start, end = b * L, (b + 1) * L\n            block_data = data[:, start:end]\n            k_block = np.sum(block_data, axis=1)\n            n_block = np.full_like(k_block, L)\n            pka_block = calculate_pka(k_block, n_block, phs)\n            block_pka_estimates.append(pka_block)\n        \n        s2 = np.var(block_pka_estimates, ddof=1)\n        std_error = np.sqrt(s2 / num_blocks)\n        if std_error < sigma_max:\n            block_check = True\n\n    # 4. Stopping rule\n    time_check = T >= tau_min\n    converged = running_check and block_check and time_check\n\n    # Final reported values\n    final_pka = running_pka_estimates[-1] if running_pka_estimates else np.nan\n\n    return [converged, round(final_pka, 4), round(std_error, 4) if not np.isnan(std_error) else np.nan]\n\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        { # Test Case A (happy path)\n            'seed': 12345, 'phs': [5.0, 6.0, 7.0, 8.0], 'pka_star': 6.5,\n            'T': 4000, 'stride': 200, 'run_window': 3, 'run_tol': 0.05,\n            'block_len': 250, 'max_se': 0.10, 'min_time': 1000\n        },\n        { # Test Case B (insufficient sampling)\n            'seed': 67890, 'phs': [5.5, 6.0, 7.0, 7.5], 'pka_star': 6.4,\n            'T': 600, 'stride': 100, 'run_window': 3, 'run_tol': 0.05,\n            'block_len': 200, 'max_se': 0.08, 'min_time': 600\n        },\n        { # Test Case C (edge case)\n            'seed': 24680, 'phs': [6.0, 6.5, 7.0, 7.5, 8.0], 'pka_star': 7.0,\n            'T': 1792, 'stride': 128, 'run_window': 4, 'run_tol': 0.03,\n            'block_len': 256, 'max_se': 0.06, 'min_time': 1024\n        }\n    ]\n\n    all_results = []\n    for params in test_cases:\n        result = run_diagnostics(params)\n        all_results.append(result)\n\n    # Format the final output string\n    results_str = []\n    for res in all_results:\n        conv, pka, err = res\n        pka_str = f\"{pka:.4f}\"\n        err_str = f\"{err:.4f}\" if not np.isnan(err) else \"nan\"\n        results_str.append(f\"[{conv},{pka_str},{err_str}]\")\n    \n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        }
    ]
}