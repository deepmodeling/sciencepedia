{
    "hands_on_practices": [
        {
            "introduction": "The displacement of water molecules from a binding site is a key driver of ligand recognition and affinity. This exercise provides a foundational calculation, connecting the abstract thermodynamic quantities of enthalpy ($\\Delta H$) and entropy ($\\Delta S$) to the concrete event of displacing a single water molecule . By computing the Gibbs free energy change ($\\Delta G$), you will gain a quantitative understanding of why removing certain 'unhappy' or high-energy waters is favorable, a core principle behind hotspot identification.",
            "id": "3864100",
            "problem": "A single hydration site in a protein pocket has been characterized using Grid Inhomogeneous Solvation Theory (GIST), yielding a water enthalpy of $-8$ kilocalories per mole and an entropy penalty of $-10$ calories per mole per Kelvin relative to bulk water. Consider a computational mapping experiment in which a purely nonpolar fragment is placed into the pocket and displaces exactly one water molecule, with the following assumptions: the fragment creates negligible direct enthalpic interactions with the pocket and incurs negligible configurational entropy changes upon placement; the only thermodynamic effect is the removal of the water from the pocket to the bulk. Using the definition of Gibbs free energy and standard thermodynamic sign conventions, compute the free energy change of the displacement process at temperature $T=300$ Kelvin. Express your final answer in kilocalories per mole, and round your answer to four significant figures.",
            "solution": "The problem asks for the change in Gibbs free energy, $\\Delta G$, for a molecular displacement process at a constant temperature. The fundamental thermodynamic relationship governing this process is the Gibbs-Helmholtz equation:\n$$\n\\Delta G = \\Delta H - T\\Delta S\n$$\nwhere $\\Delta H$ is the change in enthalpy, $T$ is the absolute temperature, and $\\Delta S$ is the change in entropy.\n\nThe process in question is the displacement of a single water molecule from a hydration site within a protein pocket to the bulk solvent by a nonpolar fragment. This can be represented by the following equilibrium:\n$$\n\\text{Fragment}_{\\text{bulk}} + \\text{Water}_{\\text{site}} \\rightleftharpoons \\text{Fragment}_{\\text{site}} + \\text{Water}_{\\text{bulk}}\n$$\nThe total free energy change for this displacement, $\\Delta G_{\\text{displacement}}$, is the sum of the free energy changes for each component involved:\n$$\n\\Delta G_{\\text{displacement}} = (G_{\\text{Fragment, site}} - G_{\\text{Fragment, bulk}}) + (G_{\\text{Water, bulk}} - G_{\\text{Water, site}})\n$$\nThe problem provides a critical set of simplifying assumptions. First, the binding of the nonpolar fragment is assumed to be thermodynamically silent: \"the fragment creates negligible direct enthalpic interactions with the pocket and incurs negligible configurational entropy changes upon placement.\" This implies that the free energy change associated with moving the fragment from the bulk to the site is approximately zero:\n$$\nG_{\\text{Fragment, site}} - G_{\\text{Fragment, bulk}} \\approx 0\n$$\nSecond, the problem states that \"the only thermodynamic effect is the removal of the water from the pocket to the bulk.\" This confirms that we can neglect the fragment's contribution and focus solely on the change in the water molecule's state. Therefore, the total free energy of displacement is equal to the free energy change of the water molecule as it moves from the site to the bulk:\n$$\n\\Delta G_{\\text{displacement}} \\approx G_{\\text{Water, bulk}} - G_{\\text{Water, site}}\n$$\nLet us expand this term using the definitions of enthalpy and entropy:\n$$\n\\Delta G_{\\text{displacement}} = (H_{\\text{Water, bulk}} - T S_{\\text{Water, bulk}}) - (H_{\\text{Water, site}} - T S_{\\text{Water, site}})\n$$\nRearranging the terms gives:\n$$\n\\Delta G_{\\text{displacement}} = (H_{\\text{Water, bulk}} - H_{\\text{Water, site}}) - T(S_{\\text{Water, bulk}} - S_{\\text{Water, site}})\n$$\nThe problem provides the thermodynamic properties of the water at the site relative to the bulk water. These are known as excess properties in the context of Grid Inhomogeneous Solvation Theory (GIST).\nThe \"water enthalpy of $-8$ kilocalories per mole\" refers to the excess enthalpy, $\\Delta H_{\\text{exc}}$:\n$$\n\\Delta H_{\\text{exc}} = H_{\\text{Water, site}} - H_{\\text{Water, bulk}} = -8 \\text{ kcal/mol}\n$$\nThe \"entropy penalty of $-10$ calories per mole per Kelvin\" refers to the excess entropy, $\\Delta S_{\\text{exc}}$. The term \"penalty\" signifies an unfavorable contribution, and a negative value for $\\Delta S_{\\text{exc}}$ indicates that the water is more ordered in the site than in the bulk.\n$$\n\\Delta S_{\\text{exc}} = S_{\\text{Water, site}} - S_{\\text{Water, bulk}} = -10 \\text{ cal mol}^{-1} \\text{ K}^{-1}\n$$\nThe terms in our expression for $\\Delta G_{\\text{displacement}}$ are the negative of these excess properties:\n$$\nH_{\\text{Water, bulk}} - H_{\\text{Water, site}} = - \\Delta H_{\\text{exc}} = -(-8 \\text{ kcal/mol}) = +8 \\text{ kcal/mol}\n$$\n$$\nS_{\\text{Water, bulk}} - S_{\\text{Water, site}} = - \\Delta S_{\\text{exc}} = -(-10 \\text{ cal mol}^{-1} \\text{ K}^{-1}) = +10 \\text{ cal mol}^{-1} \\text{ K}^{-1}\n$$\nNow, we can substitute these values back into the equation for $\\Delta G_{\\text{displacement}}$:\n$$\n\\Delta G_{\\text{displacement}} = (+8 \\text{ kcal/mol}) - T(+10 \\text{ cal mol}^{-1} \\text{ K}^{-1})\n$$\nThe temperature is given as $T = 300 \\text{ K}$. Before performing the subtraction, we must ensure the units are consistent. We convert the entropy term from calories to kilocalories.\n$$\n1 \\text{ kcal} = 1000 \\text{ cal}\n$$\nSo, the entropy change is:\n$$\n-\\Delta S_{\\text{exc}} = +10 \\text{ cal mol}^{-1} \\text{ K}^{-1} = +10 \\times 10^{-3} \\text{ kcal mol}^{-1} \\text{ K}^{-1} = 0.010 \\text{ kcal mol}^{-1} \\text{ K}^{-1}\n$$\nNow, we calculate the full entropic contribution to the free energy, $T(-\\Delta S_{\\text{exc}})$:\n$$\nT(-\\Delta S_{\\text{exc}}) = (300 \\text{ K}) \\times (0.010 \\text{ kcal mol}^{-1} \\text{ K}^{-1}) = 3.0 \\text{ kcal/mol}\n$$\nFinally, we compute the total free energy change for the displacement process:\n$$\n\\Delta G_{\\text{displacement}} = 8 \\text{ kcal/mol} - 3.0 \\text{ kcal/mol} = 5.0 \\text{ kcal/mol}\n$$\nThe positive sign of $\\Delta G_{\\text{displacement}}$ indicates that displacing this particular water molecule is thermodynamically unfavorable. This is expected, as the water is in a low-enthalpy, highly-stabilized state (a \"happy\" water), and the entropic gain from releasing it to the bulk is insufficient to overcome the large enthalpic penalty of breaking its favorable interactions in the pocket.\n\nThe problem asks for the answer to be rounded to four significant figures.\n$$\n\\Delta G_{\\text{displacement}} = 5.000 \\text{ kcal/mol}\n$$",
            "answer": "$$\n\\boxed{5.000}\n$$"
        },
        {
            "introduction": "While considering single water molecules is instructive, real binding pockets are three-dimensional volumes, and advanced methods like Grid Inhomogeneous Solvation Theory (GIST) provide detailed maps of thermodynamic properties throughout this space. This practice guides you through the essential task of processing this volumetric data, performing a numerical integration to calculate the total free energy of a defined pocket region . Mastering this allows you to translate complex density fields into a single, actionable metric for assessing a site's druggability.",
            "id": "3864113",
            "problem": "You are given volumetric solvent thermodynamic fields from Grid Inhomogeneous Solvation Theory (GIST) for an explicit-solvent mapping around a macromolecular surface. The fields are the enthalpy density $h(\\mathbf{r})$ and the entropy density $s(\\mathbf{r})$, each defined per unit volume. You are also given a temperature $T$ and a rectangular pocket region defined by axis-aligned bounds. Assume a uniform Cartesian grid with spacings $\\Delta x$, $\\Delta y$, and $\\Delta z$ and origin at $(0,0,0)$. The center of the voxel with integer indices $(i,j,k)$ is located at $\\left((i+\\tfrac{1}{2})\\Delta x, (j+\\tfrac{1}{2})\\Delta y, (k+\\tfrac{1}{2})\\Delta z\\right)$. A voxel is included in the pocket if and only if its center lies within the closed interval of each bound. All enthalpy density values $h$ are given in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$, all entropy density values $s$ are given in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$, the temperature $T$ is in $\\mathrm{K}$, and all grid spacings are in $\\mathrm{nm}$. Your task is to compute the net free energy associated with the pocket region by numerical integration over the grid.\n\nBase your reasoning on the definition of Gibbs free energy $G$ at constant temperature and pressure, the meaning of volumetric densities, and Riemann-sum discretization. Your algorithm must:\n- derive the integrand that relates the given densities to the local free energy density field using fundamental thermodynamic definitions,\n- perform a discrete numerical integration over the specified region by summing contributions of all voxels whose centers fall within the region,\n- return the total free energy in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$.\n\nExpress each final result as a floating-point number in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$, rounded to six decimal places. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\texttt{result1},\\texttt{result2},\\texttt{result3}]$).\n\nTest Suite:\nFor each test case below, implement the specified grid, fields, temperature, and region. Use the inclusion rule defined above. For compactness, when a field is constant, it applies to all grid points; otherwise, values are given explicitly per voxel index.\n\n- Test case $1$ (happy path, uniform fields):\n  - Grid shape: $2 \\times 2 \\times 2$.\n  - Spacings: $\\Delta x = \\Delta y = \\Delta z = 0.5\\ \\mathrm{nm}$.\n  - Temperature: $T = 300\\ \\mathrm{K}$.\n  - Enthalpy density: $h(\\mathbf{r}) \\equiv 2.0\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Entropy density: $s(\\mathbf{r}) \\equiv 0.005\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Pocket bounds: $x \\in [0.0, 1.0]$, $y \\in [0.0, 1.0]$, $z \\in [0.0, 1.0]$ (all in $\\mathrm{nm}$).\n\n- Test case $2$ (anisotropic spacing, heterogeneous fields):\n  - Grid shape: $2 \\times 2 \\times 1$.\n  - Spacings: $\\Delta x = 0.2\\ \\mathrm{nm}$, $\\Delta y = 0.25\\ \\mathrm{nm}$, $\\Delta z = 0.4\\ \\mathrm{nm}$.\n  - Temperature: $T = 310\\ \\mathrm{K}$.\n  - Enthalpy density $h_{i,j,k}$ in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$:\n    - $h_{0,0,0} = 1.0$, $h_{0,1,0} = 2.0$, $h_{1,0,0} = 3.0$, $h_{1,1,0} = 4.0$.\n  - Entropy density $s_{i,j,k}$ in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$:\n    - $s_{0,0,0} = 0.002$, $s_{0,1,0} = 0.000$, $s_{1,0,0} = 0.004$, $s_{1,1,0} = 0.001$.\n  - Pocket bounds: $x \\in [0.0, 1.0]$, $y \\in [0.0, 1.0]$, $z \\in [0.0, 0.4]$.\n\n- Test case $3$ (empty region boundary condition):\n  - Grid shape: $2 \\times 2 \\times 2$.\n  - Spacings: $\\Delta x = \\Delta y = \\Delta z = 0.5\\ \\mathrm{nm}$.\n  - Temperature: $T = 300\\ \\mathrm{K}$.\n  - Enthalpy density: $h(\\mathbf{r}) \\equiv 1.0\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Entropy density: $s(\\mathbf{r}) \\equiv 0.001\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Pocket bounds: $x \\in [10.0, 11.0]$, $y \\in [10.0, 11.0]$, $z \\in [10.0, 11.0]$.\n\n- Test case $4$ (single-voxel, strongly favorable solvation, negative free energy):\n  - Grid shape: $1 \\times 1 \\times 1$.\n  - Spacings: $\\Delta x = \\Delta y = \\Delta z = 0.5\\ \\mathrm{nm}$.\n  - Temperature: $T = 300\\ \\mathrm{K}$.\n  - Enthalpy density: $h_{0,0,0} = 0.1\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Entropy density: $s_{0,0,0} = 0.010\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$.\n  - Pocket bounds: $x \\in [0.0, 1.0]$, $y \\in [0.0, 1.0]$, $z \\in [0.0, 1.0]$.\n\nYour program should compute the free energy for each test case and print a single line in the exact format $[\\texttt{v1},\\texttt{v2},\\texttt{v3},\\texttt{v4}]$, where each $\\texttt{v}$ is the rounded value in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}$ as specified above.",
            "solution": "The problem requires the calculation of the total Gibbs free energy, $G_{pocket}$, within a specified rectangular region of space, termed a \"pocket.\" We are provided with volumetric density fields for enthalpy, $h(\\mathbf{r})$, and entropy, $s(\\mathbf{r})$, on a discrete Cartesian grid, along with a constant temperature, $T$. The solution will be derived from fundamental thermodynamic principles and implemented as a numerical integration over the grid voxels that fall within the pocket.\n\nFirst, we establish the theoretical foundation. The Gibbs free energy, $G$, is related to enthalpy, $H$, and entropy, $S$, at a constant temperature, $T$, by the equation:\n$$G = H - TS$$\nThis relationship also holds for their corresponding volumetric densities. Let $g(\\mathbf{r})$, $h(\\mathbf{r})$, and $s(\\mathbf{r})$ represent the Gibbs free energy, enthalpy, and entropy per unit volume at a spatial position $\\mathbf{r}$, respectively. The local free energy density is therefore given by:\n$$g(\\mathbf{r}) = h(\\mathbf{r}) - T s(\\mathbf{r})$$\nThe units provided are consistent for this calculation. The enthalpy density $h(\\mathbf{r})$ is in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$, the entropy density $s(\\mathbf{r})$ is in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}$, and the temperature $T$ is in $\\mathrm{K}$. The product $T s(\\mathbf{r})$ thus has units of $(\\mathrm{K}) \\times (\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}\\,\\mathrm{nm}^{-3}) = \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$, which matches the units of $h(\\mathbf{r})$. Consequently, the free energy density $g(\\mathbf{r})$ is correctly expressed in $\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}$.\n\nThe total free energy within the pocket volume, $V_p$, is the integral of the free energy density over this volume:\n$$G_{pocket} = \\iiint_{V_p} g(\\mathbf{r}) \\, dV = \\iiint_{V_p} [h(\\mathbf{r}) - T s(\\mathbf{r})] \\, dV$$\n\nThe problem specifies that the fields are defined on a discrete grid. This continuous integral can be approximated by a numerical summation, specifically a Riemann sum. The integration domain is partitioned into discrete volume elements, or voxels. The contribution of each voxel to the total free energy is the product of the free energy density evaluated at a representative point within the voxel (in this case, its center) and the voxel's volume.\n\nLet the grid have spacings $\\Delta x$, $\\Delta y$, and $\\Delta z$. The volume of each voxel is constant:\n$$\\Delta V = \\Delta x \\Delta y \\Delta z$$\nThe center of a voxel with integer indices $(i, j, k)$ is located at the coordinates $\\mathbf{r}_{i,j,k} = \\left((i+\\tfrac{1}{2})\\Delta x, (j+\\tfrac{1}{2})\\Delta y, (k+\\tfrac{1}{2})\\Delta z\\right)$. The enthalpy and entropy densities for this voxel are denoted as $h_{i,j,k}$ and $s_{i,j,k}$.\n\nThe total free energy is the sum of contributions from all voxels whose centers lie within the pocket boundaries, defined by $x \\in [x_{min}, x_{max}]$, $y \\in [y_{min}, y_{max}]$, and $z \\in [z_{min}, z_{max}]$. Let $\\mathcal{S}$ be the set of all voxel indices $(i,j,k)$ whose centers lie in the pocket.\n\n$$\n\\mathcal{S} = \\left\\{ (i,j,k) \\mid\n\\begin{array}{l}\nx_{min} \\le (i+\\tfrac{1}{2})\\Delta x \\le x_{max} \\\\\ny_{min} \\le (j+\\tfrac{1}{2})\\Delta y \\le y_{max} \\\\\nz_{min} \\le (k+\\tfrac{1}{2})\\Delta z \\le z_{max}\n\\end{array}\n\\right\\}\n$$\n\nThe total pocket free energy $G_{pocket}$ is then calculated by summing the contributions from each voxel in the set $\\mathcal{S}$:\n$$G_{pocket} \\approx \\sum_{(i,j,k) \\in \\mathcal{S}} [h_{i,j,k} - T s_{i,j,k}] \\cdot \\Delta V$$\nwhere the units of $G_{pocket}$ will be $(\\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{nm}^{-3}) \\times (\\mathrm{nm}^3) = \\mathrm{kJ}\\,\\mathrm{mol}^{-1}$, as required.\n\nThe algorithm to be implemented is as follows:\n1. For a given test case, define the grid dimensions ($N_x, N_y, N_z$), grid spacings ($\\Delta x, \\Delta y, \\Delta z$), temperature ($T$), pocket boundaries, and the gridded enthalpy ($h_{i,j,k}$) and entropy ($s_{i,j,k}$) fields.\n2. Calculate the volume of a single voxel, $\\Delta V = \\Delta x \\Delta y \\Delta z$.\n3. Initialize a variable for the total free energy, $G_{total}$, to $0.0$.\n4. Iterate through all voxel indices $i$ from $0$ to $N_x-1$, $j$ from $0$ to $N_y-1$, and $k$ from $0$ to $N_z-1$.\n5. For each voxel $(i,j,k)$, compute the coordinates of its center: $x_c = (i+0.5)\\Delta x$, $y_c = (j+0.5)\\Delta y$, $z_c = (k+0.5)\\Delta z$.\n6. Check if the center $(x_c, y_c, z_c)$ falls within the closed interval of the pocket boundaries.\n7. If the voxel is inside the pocket region, calculate its contribution to the free energy: $\\Delta G_{i,j,k} = (h_{i,j,k} - T s_{i,j,k}) \\times \\Delta V$.\n8. Add this contribution to the running total: $G_{total} = G_{total} + \\Delta G_{i,j,k}$.\n9. After iterating through all voxels, the final value of $G_{total}$ is the result for the test case. This value is then rounded to six decimal places.\nThis procedure will be applied to each test case provided.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the net free energy for several test cases based on GIST fields.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"grid_shape\": (2, 2, 2),\n            \"spacings\": (0.5, 0.5, 0.5),\n            \"T\": 300.0,\n            \"h_field\": np.full((2, 2, 2), 2.0),\n            \"s_field\": np.full((2, 2, 2), 0.005),\n            \"pocket_bounds\": ((0.0, 1.0), (0.0, 1.0), (0.0, 1.0))\n        },\n        {\n            \"grid_shape\": (2, 2, 1),\n            \"spacings\": (0.2, 0.25, 0.4),\n            \"T\": 310.0,\n            \"h_field\": np.array([\n                [[1.0], [2.0]], # i=0, j=0,1 ; k=0\n                [[3.0], [4.0]]  # i=1, j=0,1 ; k=0\n            ]),\n            \"s_field\": np.array([\n                [[0.002], [0.000]],\n                [[0.004], [0.001]]\n            ]),\n            \"pocket_bounds\": ((0.0, 1.0), (0.0, 1.0), (0.0, 0.4))\n        },\n        {\n            \"grid_shape\": (2, 2, 2),\n            \"spacings\": (0.5, 0.5, 0.5),\n            \"T\": 300.0,\n            \"h_field\": np.full((2, 2, 2), 1.0),\n            \"s_field\": np.full((2, 2, 2), 0.001),\n            \"pocket_bounds\": ((10.0, 11.0), (10.0, 11.0), (10.0, 11.0))\n        },\n        {\n            \"grid_shape\": (1, 1, 1),\n            \"spacings\": (0.5, 0.5, 0.5),\n            \"T\": 300.0,\n            \"h_field\": np.full((1, 1, 1), 0.1),\n            \"s_field\": np.full((1, 1, 1), 0.010),\n            \"pocket_bounds\": ((0.0, 1.0), (0.0, 1.0), (0.0, 1.0))\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_pocket_energy(\n            grid_shape=case[\"grid_shape\"],\n            spacings=case[\"spacings\"],\n            T=case[\"T\"],\n            h_field=case[\"h_field\"],\n            s_field=case[\"s_field\"],\n            pocket_bounds=case[\"pocket_bounds\"]\n        )\n        results.append(f\"{result:.6f}\")\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\ndef calculate_pocket_energy(grid_shape, spacings, T, h_field, s_field, pocket_bounds):\n    \"\"\"\n    Calculates the free energy of a pocket by integrating over GIST fields.\n\n    Args:\n        grid_shape (tuple): The dimensions (Nx, Ny, Nz) of the grid.\n        spacings (tuple): The grid spacings (dx, dy, dz) in nm.\n        T (float): The temperature in K.\n        h_field (np.ndarray): The 3D enthalpy density field in kJ/mol/nm^3.\n        s_field (np.ndarray): The 3D entropy density field in kJ/mol/K/nm^3.\n        pocket_bounds (tuple): The pocket region as ((xmin, xmax), (ymin, ymax), (zmin, zmax)).\n\n    Returns:\n        float: The total free energy of the pocket in kJ/mol.\n    \"\"\"\n    Nx, Ny, Nz = grid_shape\n    dx, dy, dz = spacings\n    (xmin, xmax), (ymin, ymax), (zmin, zmax) = pocket_bounds\n    \n    # Calculate the volume of a single voxel\n    dV = dx * dy * dz\n    \n    total_free_energy = 0.0\n    \n    for i in range(Nx):\n        for j in range(Ny):\n            for k in range(Nz):\n                # Calculate the center of the voxel (i, j, k)\n                xc = (i + 0.5) * dx\n                yc = (j + 0.5) * dy\n                zc = (k + 0.5) * dz\n                \n                # Check if the voxel center is within the pocket bounds\n                if (xmin = xc = xmax) and \\\n                   (ymin = yc = ymax) and \\\n                   (zmin = zc = zmax):\n                    \n                    # Retrieve the enthalpy and entropy densities for this voxel\n                    h_ijk = h_field[i, j, k]\n                    s_ijk = s_field[i, j, k]\n                    \n                    # Calculate the free energy density g = h - T*s\n                    g_ijk = h_ijk - T * s_ijk\n                    \n                    # Add this voxel's contribution to the total free energy\n                    total_free_energy += g_ijk * dV\n                    \n    return total_free_energy\n\nsolve()\n```"
        },
        {
            "introduction": "Proteins are inherently dynamic, and their binding sites can adopt multiple conformations, each with a unique solvation structure. This advanced practice moves beyond the static picture by integrating solvent mapping with protein dynamics modeled by a Markov State Model (MSM) . You will learn to compute state-specific hotspot strengths and combine them into an equilibrium-weighted average, providing a more realistic and robust assessment of a binding site's potential. This exercise bridges the gap between conformational ensemble analysis and structure-based drug design.",
            "id": "3864027",
            "problem": "You are given a discrete-time Markov State Model (MSM) of pocket conformations and solvent-mapping derived probe interaction free energies across a grid for each state. The goal is to compute state-specific hotspot strengths and their equilibrium-weighted aggregate. The design must proceed from first principles, explicitly using the Boltzmann distribution for occupancy and the stationary distribution of the Markov chain.\n\nDefinitions and fundamental base:\n- A Markov State Model (MSM) is defined by a row-stochastic transition matrix $P \\in \\mathbb{R}^{n \\times n}$ for $n$ metastable pocket conformational states, where each entry $P_{ij}$ is the probability of transitioning from state $i$ to state $j$ in one time step, and $\\sum_{j=1}^{n} P_{ij} = 1$ for all $i$.\n- The stationary distribution $\\boldsymbol{\\pi} \\in \\mathbb{R}^{n}$ of the Markov chain satisfies $\\boldsymbol{\\pi}^{\\top} = \\boldsymbol{\\pi}^{\\top} P$ and $\\sum_{i=1}^{n} \\pi_i = 1$, with $\\pi_i \\geq 0$ for all $i$.\n- For each state $s \\in \\{1,\\dots,n\\}$, a solvent mapping provides a set of probe interaction free energies $\\{\\Delta G_{s,i}\\}_{i=1}^{m_s}$ at $m_s$ distinct grid points. These energies are expressed in kilojoules per mole (kJ/mol).\n- The Boltzmann distribution gives the relative occupancy of a probe at grid point $i$ in state $s$ as proportional to $\\exp(-\\beta \\Delta G_{s,i})$, where $\\beta = 1/(k_{\\mathrm{B}} T)$, $T$ is the absolute temperature in Kelvin (K), and $k_{\\mathrm{B}}$ is the Boltzmann constant expressed in kilojoules per mole per Kelvin (kJ/mol/K).\n- The normalized occupancy probabilities within a state $s$ are $p_{s,i} = \\frac{\\exp(-\\beta \\Delta G_{s,i})}{\\sum_{j=1}^{m_s} \\exp(-\\beta \\Delta G_{s,j})}$, which obey $\\sum_{i=1}^{m_s} p_{s,i} = 1$.\n- A hotspot is operationally defined for this problem as the set of grid points in a given state whose occupancy probability exceeds a threshold $\\tau \\in (0,1)$. The state-specific hotspot strength is the cumulative occupancy mass above the threshold: $H_s(\\tau) = \\sum_{i=1}^{m_s} p_{s,i} \\cdot \\mathbf{1}\\{p_{s,i} \\ge \\tau\\}$, where $\\mathbf{1}\\{\\cdot\\}$ is the indicator function.\n- The equilibrium-weighted aggregate hotspot strength is $H_{\\mathrm{eq}}(\\tau) = \\sum_{s=1}^{n} \\pi_s \\, H_s(\\tau)$.\n\nTask:\n- For each test case, compute $H_s(\\tau)$ for all states $s$ and then compute $H_{\\mathrm{eq}}(\\tau)$ using the stationary distribution $\\boldsymbol{\\pi}$ of the given transition matrix $P$.\n\nPhysical and numerical units:\n- Energies $\\Delta G_{s,i}$ are given in kJ/mol.\n- Temperature $T$ is given in Kelvin (K).\n- Use $k_{\\mathrm{B}} = 0.008314462618\\ \\mathrm{kJ}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$.\n- Hotspot strengths $H_s(\\tau)$ and $H_{\\mathrm{eq}}(\\tau)$ are unitless (dimensionless probabilities).\n- Express all outputs as floats rounded to six decimal places (i.e., with six digits after the decimal point). Angles are not involved. Percentages are not to be used anywhere; use decimal fractions instead.\n\nTest suite:\nFor each test case, you are provided with:\n- A row-stochastic transition matrix $P$.\n- A list of energy arrays, where the $s$-th array specifies $\\{\\Delta G_{s,i}\\}_{i=1}^{m_s}$.\n- A temperature $T$ in Kelvin.\n- A threshold $\\tau$.\n\nCompute the per-state hotspot strengths $H_s(\\tau)$ for all states $s$ and $H_{\\mathrm{eq}}(\\tau)$.\n\nTest Case 1 (happy path, three metastable states, heterogeneous energies):\n- $P = \\begin{bmatrix}\n0.90  0.09  0.01 \\\\\n0.05  0.90  0.05 \\\\\n0.02  0.08  0.90\n\\end{bmatrix}$\n- Energies:\n  - State $1$: $\\{-4.0, -2.5, -1.0, 0.5, 3.0\\}$ kJ/mol\n  - State $2$: $\\{-1.5, -1.0, -0.5, 0.0, 1.0\\}$ kJ/mol\n  - State $3$: $\\{-5.0, -3.0, -2.0, -1.0, 2.0\\}$ kJ/mol\n- $T = 300$ K\n- $\\tau = 0.20$\n\nTest Case 2 (edge case, uniform energies in one state, near-absorbing dynamics):\n- $P = \\begin{bmatrix}\n0.98  0.02 \\\\\n0.03  0.97\n\\end{bmatrix}$\n- Energies:\n  - State $1$: $\\{0.0, 0.0, 0.0, 0.0\\}$ kJ/mol\n  - State $2$: $\\{-2.0, -2.0, -2.0, -2.0\\}$ kJ/mol\n- $T = 310$ K\n- $\\tau = 0.25$\n\nTest Case 3 (boundary coverage, four states with sharp and diffuse hotspots):\n- $P = \\begin{bmatrix}\n0.85  0.10  0.03  0.02 \\\\\n0.06  0.80  0.10  0.04 \\\\\n0.05  0.15  0.75  0.05 \\\\\n0.02  0.08  0.10  0.80\n\\end{bmatrix}$\n- Energies:\n  - State $1$: $\\{-6.0, -1.0, 2.0, 4.0, -0.5\\}$ kJ/mol\n  - State $2$: $\\{-0.2, -0.1, 0.0, 0.1, 0.2\\}$ kJ/mol\n  - State $3$: $\\{-3.0, -2.9, -2.8, 3.0, 4.0\\}$ kJ/mol\n  - State $4$: $\\{-1.0, 1.0, 2.0, -0.5, -0.2\\}$ kJ/mol\n- $T = 290$ K\n- $\\tau = 0.30$\n\nFinal output format:\n- Your program should produce a single line of output containing the concatenated results across all test cases as a comma-separated list enclosed in square brackets.\n- For each test case, output the per-state hotspot strengths $H_s(\\tau)$ for all states $s$ in order of state index, followed by the equilibrium aggregate $H_{\\mathrm{eq}}(\\tau)$, all rounded to six decimal places.\n- Concretely, if Test Case 1 has $n_1$ states, Test Case 2 has $n_2$ states, and Test Case 3 has $n_3$ states, then the output format is $[H_{1,1}, \\dots, H_{1,n_1}, H_{1,\\mathrm{eq}}, H_{2,1}, \\dots, H_{2,n_2}, H_{2,\\mathrm{eq}}, H_{3,1}, \\dots, H_{3,n_3}, H_{3,\\mathrm{eq}}]$, where the first index denotes the test case and the second index denotes the state.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of statistical mechanics and Markov chain theory, well-posed with all necessary information provided, and objective in its definitions and goals. The task is to compute state-specific and equilibrium-weighted hotspot strengths for a protein pocket based on a Markov State Model (MSM) of its conformations and associated solvent-probe interaction energies.\n\nThe solution proceeds algorithmically in three main steps for each test case, based on the fundamental principles provided.\n\n**Step 1: Calculation of the Stationary Distribution ($\\boldsymbol{\\pi}$)**\n\nThe foundation of an equilibrium analysis of an MSM is its stationary distribution, $\\boldsymbol{\\pi}$. This vector $\\boldsymbol{\\pi} = (\\pi_1, \\pi_2, \\dots, \\pi_n)$ lists the equilibrium probabilities of finding the system in each of the $n$ conformational states. It is defined by the property that it is invariant under the action of the transition matrix $P$. Mathematically, this is expressed as the left eigenvector equation:\n$$ \\boldsymbol{\\pi}^{\\top} P = \\boldsymbol{\\pi}^{\\top} $$\nThis equation, along with the normalization condition $\\sum_{i=1}^{n} \\pi_i = 1$, uniquely determines $\\boldsymbol{\\pi}$ for an irreducible and aperiodic Markov chain (which the given transition matrices represent).\n\nTo solve for $\\boldsymbol{\\pi}$, we can rewrite the equation as $\\boldsymbol{\\pi}^{\\top} (P - I) = \\mathbf{0}^{\\top}$, where $I$ is the identity matrix and $\\mathbf{0}$ is the zero vector. Transposing this gives $(P^{\\top} - I) \\boldsymbol{\\pi} = \\mathbf{0}$. This means $\\boldsymbol{\\pi}$ is the right eigenvector of the transposed matrix $P^{\\top}$ corresponding to an eigenvalue of $\\lambda=1$. Numerically, this is a standard and robustly solvable eigenvalue problem. We find the eigenvector, take its real components (as the stationary distribution must be real), and normalize it so that its elements sum to $1$.\n\n**Step 2: Calculation of State-Specific Hotspot Strengths ($H_s(\\tau)$)**\n\nFor each conformational state $s$, we are given a set of probe interaction free energies $\\{\\Delta G_{s,i}\\}$ at various grid points $i$. The occupancy of a probe at a specific grid point is governed by the principles of Boltzmann statistics. The probability $p_{s,i}$ of a probe occupying grid point $i$ within state $s$ is proportional to its Boltzmann factor, $\\exp(-\\beta \\Delta G_{s,i})$, where $\\beta = 1/(k_{\\mathrm{B}} T)$ is the inverse thermal energy.\n\nTo obtain a valid probability distribution for each state, we normalize these factors by their sum over all grid points within that state. The sum $Z_s = \\sum_{j=1}^{m_s} \\exp(-\\beta \\Delta G_{s,j})$ is the partition function for the probe within the pocket of state $s$. The normalized occupancy probability is thus:\n$$ p_{s,i} = \\frac{\\exp(-\\beta \\Delta G_{s,i})}{Z_s} = \\frac{\\exp(-\\beta \\Delta G_{s,i})}{\\sum_{j=1}^{m_s} \\exp(-\\beta \\Delta G_{s,j})} $$\nNumerically, to avoid overflow when calculating the exponential of large negative energies, a standard technique is to use a log-sum-exp stabilization. We compute $L_{s,i} = -\\beta \\Delta G_{s,i}$, find $L_{s,\\max} = \\max_i L_{s,i}$, and then calculate probabilities as:\n$$ p_{s,i} = \\frac{\\exp(L_{s,i} - L_{s,\\max})}{\\sum_{j=1}^{m_s} \\exp(L_{s,j} - L_{s,\\max})} $$\nThis transformation prevents numerical overflow while yielding the same final probabilities.\n\nAccording to the problem's definition, a hotspot consists of grid points where the occupancy probability $p_{s,i}$ meets or exceeds a given threshold $\\tau$. The state-specific hotspot strength, $H_s(\\tau)$, is the total probability mass of these hotspot grid points:\n$$ H_s(\\tau) = \\sum_{i=1}^{m_s} p_{s,i} \\cdot \\mathbf{1}\\{p_{s,i} \\ge \\tau\\} $$\nwhere $\\mathbf{1}\\{\\cdot\\}$ is the indicator function, which is $1$ if the condition inside is true and $0$ otherwise.\n\n**Step 3: Calculation of Equilibrium-Weighted Aggregate Hotspot Strength ($H_{\\mathrm{eq}}(\\tau)$)**\n\nThe overall, or equilibrium, properties of the system are an average over all states, weighted by their equilibrium populations $\\pi_s$. The aggregate hotspot strength $H_{\\mathrm{eq}}(\\tau)$ is therefore calculated as the expectation of the state-specific hotspot strengths $H_s(\\tau)$ over the stationary distribution $\\boldsymbol{\\pi}$:\n$$ H_{\\mathrm{eq}}(\\tau) = \\sum_{s=1}^{n} \\pi_s H_s(\\tau) $$\nThis final value represents the total hotspot probability mass, averaged over the conformational ensemble at thermal equilibrium.\n\nBy implementing these three steps for each test case, we can compute the required quantities. The procedure synthetically combines principles from linear algebra, statistical mechanics, and probability theory to model a physically relevant problem in computational drug design.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Computes state-specific and equilibrium-weighted hotspot strengths for\n    a series of Markov State Models and associated solvent-mapping energies.\n    \"\"\"\n    \n    # Define physical constants and test cases from the problem statement.\n    K_B = 0.008314462618  # Boltzmann constant in kJ/mol/K\n\n    test_cases = [\n        (\n            np.array([\n                [0.90, 0.09, 0.01],\n                [0.05, 0.90, 0.05],\n                [0.02, 0.08, 0.90]\n            ]),\n            [\n                np.array([-4.0, -2.5, -1.0, 0.5, 3.0]),\n                np.array([-1.5, -1.0, -0.5, 0.0, 1.0]),\n                np.array([-5.0, -3.0, -2.0, -1.0, 2.0])\n            ],\n            300.0,\n            0.20\n        ),\n        (\n            np.array([\n                [0.98, 0.02],\n                [0.03, 0.97]\n            ]),\n            [\n                np.array([0.0, 0.0, 0.0, 0.0]),\n                np.array([-2.0, -2.0, -2.0, -2.0])\n            ],\n            310.0,\n            0.25\n        ),\n        (\n            np.array([\n                [0.85, 0.10, 0.03, 0.02],\n                [0.06, 0.80, 0.10, 0.04],\n                [0.05, 0.15, 0.75, 0.05],\n                [0.02, 0.08, 0.10, 0.80]\n            ]),\n            [\n                np.array([-6.0, -1.0, 2.0, 4.0, -0.5]),\n                np.array([-0.2, -0.1, 0.0, 0.1, 0.2]),\n                np.array([-3.0, -2.9, -2.8, 3.0, 4.0]),\n                np.array([-1.0, 1.0, 2.0, -0.5, -0.2])\n            ],\n            290.0,\n            0.30\n        )\n    ]\n\n    all_results = []\n\n    def compute_stationary_distribution(p_matrix):\n        \"\"\"\n        Calculates the stationary distribution of a Markov chain.\n        The stationary distribution pi satisfies pi^T * P = pi^T.\n        This is equivalent to finding the right eigenvector of P^T\n        for the eigenvalue 1.\n        \"\"\"\n        eigenvalues, eigenvectors = linalg.eig(p_matrix.T)\n        # Find the index of the eigenvalue that is close to 1.0\n        # This handles potential floating point inaccuracies.\n        idx = np.where(np.isclose(eigenvalues, 1.0))[0][0]\n        # The eigenvector is complex, take the real part.\n        pi_unnormalized = eigenvectors[:, idx].real\n        # Normalize to ensure it's a probability distribution (sums to 1).\n        pi = pi_unnormalized / np.sum(pi_unnormalized)\n        return pi\n\n    for case in test_cases:\n        p_matrix, energies_list, temp, threshold = case\n        n_states = p_matrix.shape[0]\n\n        # Step 1: Calculate the stationary distribution\n        pi = compute_stationary_distribution(p_matrix)\n\n        # Step 2: Calculate state-specific hotspot strengths\n        h_s_list = []\n        beta = 1.0 / (K_B * temp)\n        \n        for s in range(n_states):\n            delta_g_s = energies_list[s]\n            \n            # Calculate Boltzmann factors and probabilities using a\n            # numerically stable method (log-sum-exp trick) to prevent overflow.\n            log_weights = -beta * delta_g_s\n            # Shift by the max value to keep exponents in a small range\n            log_weights_shifted = log_weights - np.max(log_weights)\n            weights = np.exp(log_weights_shifted)\n            probs = weights / np.sum(weights)\n\n            # A hotspot comprises points with occupancy probability >= threshold.\n            # The hotspot strength is the sum of these probabilities.\n            h_s = np.sum(probs[probs >= threshold])\n            h_s_list.append(h_s)\n\n        # Step 3: Calculate the equilibrium-weighted aggregate hotspot strength\n        h_eq = np.sum(pi * np.array(h_s_list))\n        \n        # Collect results for this case\n        all_results.extend(h_s_list)\n        all_results.append(h_eq)\n\n    # Format the final output string as required.\n    # Each value is a float rounded to six decimal places.\n    output_str = \",\".join([f\"{r:.6f}\" for r in all_results])\n    print(f\"[{output_str}]\")\n\nsolve()\n```"
        }
    ]
}