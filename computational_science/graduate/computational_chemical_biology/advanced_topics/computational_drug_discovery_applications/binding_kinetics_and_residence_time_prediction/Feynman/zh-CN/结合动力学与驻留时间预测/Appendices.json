{
    "hands_on_practices": [
        {
            "introduction": "要预测一个分子的结合停留时间，核心在于理解描述其从结合口袋中解离的速率理论。本练习将引导你推导并对比两种描述速率的关键理论：过渡态理论（Transition State Theory, TST）和在过阻尼极限下的克拉默斯理论（Kramers' theory）。通过这个实践，你将深入理解扩散（或摩擦）在决定解离速率中的重要作用，并明白为何更复杂的克拉默斯理论能够修正经典过渡态理论的预测 。",
            "id": "3837022",
            "problem": "一个配体通过一个单一的主导反应坐标 $x$ 从蛋白质上解离，沿着该坐标定义了平均力势 (PMF) $W(x)$。其动力学是过阻尼的，具有恒定的坐标扩散系数 $D$，并且可以用朗之万方程的斯摩洛霍夫斯基极限很好地描述。假设在 $x=x_{a}$ 处存在一个亚稳态的结合最小值，并在 $x=x^{\\ddagger}$ 处存在一个单一的势垒顶点，它将结合盆与逃逸区分隔开。在最小值和势垒顶点附近，PMF 是局部二次的，其曲率分别为 $W''(x_{a})>0$ 和 $W''(x^{\\ddagger})<0$，势垒高度为 $\\Delta W^{\\ddagger}=W(x^{\\ddagger})-W(x_{a})$。将结合盆入口处的边界视为反射边界，将在 $x^{\\ddagger}$ 处的势垒穿越视为吸收边界。\n\n从过阻尼扩散在 PMF 中的第一性原理以及平均首达时 (MFPT) 的定义出发，推导解离速率 $k_{\\mathrm{off}}$ 的表达式，该表达式用 $D$、$W''(x_{a})$、$W''(x^{\\ddagger})$、温度 $T$ 和 $\\Delta W^{\\ddagger}$ 表示，并使用适用于高势垒的适当渐近近似。然后，使用标准的艾林形式写下过渡态理论 (TST) 对速率的预测，假设 PMF 势垒 $\\Delta W^{\\ddagger}$ 是活化自由能。\n\n使用以下科学上合理的参数：\n- 温度 $T=300\\,\\mathrm{K}$。\n- 扩散系数 $D=0.10\\,\\mathrm{nm}^{2}\\,\\mathrm{ns}^{-1}$。\n- 曲率 $W''(x_{a})=2.0\\,k_{B}T\\,\\mathrm{nm}^{-2}$ 和 $W''(x^{\\ddagger})=-1.0\\,k_{B}T\\,\\mathrm{nm}^{-2}$。\n- 势垒高度 $\\Delta W^{\\ddagger}=12\\,k_{B}T$。\n\n这里，$k_B$ 是玻尔兹曼常数，$h$ 是普朗克常数。使用 $k_{B}=1.380649\\times 10^{-23}\\,\\mathrm{J\\,K^{-1}}$ 和 $h=6.62607015\\times 10^{-34}\\,\\mathrm{J\\,s}$。\n\n以 $\\mathrm{s}^{-1}$ 为单位，数值计算 $k_{\\mathrm{off}}^{\\mathrm{MFPT}}$ 和 $k_{\\mathrm{off}}^{\\mathrm{TST}}$，然后报告单一量 $r=k_{\\mathrm{off}}^{\\mathrm{MFPT}}/k_{\\mathrm{off}}^{\\mathrm{TST}}$。将您的最终 $r$ 值四舍五入至四位有效数字。将 $r$ 表示为无单位的小数。",
            "solution": "用户提供了一个科学基础扎实、问题明确且包含所有求解所需信息的问题。这是化学反应速率理论领域的一个标准问题，具体来说是比较过阻尼极限下的克拉默斯理论与过渡态理论 (TST)。该问题是有效的。\n\n解离速率 $k_{\\mathrm{off}}$ 是配体逃离结合口袋的平均首达时 (MFPT) 的倒数。该问题描述了一维平均力势 (PMF) $W(x)$ 上的过阻尼动力学。\n\n首先，我们将基于 MFPT 推导速率表达式，在本情境中即为高摩擦（斯摩洛霍夫斯基）极限下的克拉默斯速率。一个粒子从 $x_0$ 开始，到达吸收边界 $x_b$，同时在 $x_a$ 处有反射边界，其 MFPT $\\tau(x_0)$ 由庞特里亚金方程的积分给出：\n$$ \\tau(x_0) = \\frac{1}{D} \\int_{x_0}^{x_b} dx \\, \\exp\\left(\\frac{W(x)}{k_B T}\\right) \\int_{x_a}^{x} dy \\, \\exp\\left(-\\frac{W(y)}{k_B T}\\right) $$\n其中 $D$ 是扩散系数，$k_B$ 是玻尔兹曼常数，$T$ 是温度。\n\n对于从势阱中逃逸，我们认为起始点是势阱最小值 $x_a$，逃逸点是势垒最大值 $x^{\\ddagger}$。另一个边界是反射的，远离势阱，我们可以取其在 $x \\to -\\infty$。为了找到总速率，我们应该对阱中起始位置的平衡分布求 MFPT 的平均值。对于高势垒 $\\Delta W^{\\ddagger} \\gg k_B T$ 的情况，这可以很好地近似为从势阱最小值 $x_a$ 开始的 MFPT。平均逃逸时间 $\\tau$ 的表达式为：\n$$ \\tau = \\frac{1}{D} \\int_{x_a}^{x^{\\ddagger}} dx \\, \\exp\\left(\\frac{W(x)}{k_B T}\\right) \\int_{-\\infty}^{x} dy \\, \\exp\\left(-\\frac{W(y)}{k_B T}\\right) $$\n这些嵌套积分可以使用鞍点近似法进行评估。内层积分主要由势能最小值 $y=x_a$ 周围的区域决定，外层积分主要由势能最大值 $x=x^{\\ddagger}$ 周围的区域决定。在这些点附近，PMF 可以二次近似为：\n$W(y) \\approx W(x_a) + \\frac{1}{2} W''(x_a) (y-x_a)^2$\n$W(x) \\approx W(x^{\\ddagger}) + \\frac{1}{2} W''(x^{\\ddagger}) (x-x^{\\ddagger})^2 = W(x^{\\ddagger}) - \\frac{1}{2} |W''(x^{\\ddagger})| (x-x^{\\ddagger})^2$\n\n使用这些近似计算双重积分是克拉默斯理论的一个标准结果。得到的平均逃逸时间为：\n$$ \\tau = \\frac{2\\pi k_B T}{D \\sqrt{W''(x_a)|W''(x^{\\ddagger})|}} \\exp\\left(\\frac{\\Delta W^{\\ddagger}}{k_B T}\\right) $$\n其中 $\\Delta W^{\\ddagger} = W(x^{\\ddagger}) - W(x_a)$。解离速率是这个时间的倒数：\n$$ k_{\\mathrm{off}}^{\\mathrm{MFPT}} = \\frac{1}{\\tau} = \\frac{D \\sqrt{W''(x_a)|W''(x^{\\ddagger})|}}{2\\pi k_B T} \\exp\\left(-\\frac{\\Delta W^{\\ddagger}}{k_B T}\\right) $$\n这就是过阻尼（斯摩洛霍夫斯基）极限下的克拉默斯速率。\n\n接下来，我们写出由过渡态理论 (TST) 以其标准艾林形式预测的速率。该理论假设任何穿过势垒顶点的轨迹都是反应性的，并将速率计算为：\n$$ k_{\\mathrm{off}}^{\\mathrm{TST}} = \\frac{k_B T}{h} \\exp\\left(-\\frac{\\Delta G^{\\ddagger}}{k_B T}\\right) $$\n其中 $h$ 是普朗克常数，$\\Delta G^{\\ddagger}$ 是吉布斯活化自由能。根据指示，我们取 $\\Delta G^{\\ddagger} = \\Delta W^{\\ddagger}$。\n$$ k_{\\mathrm{off}}^{\\mathrm{TST}} = \\frac{k_B T}{h} \\exp\\left(-\\frac{\\Delta W^{\\ddagger}}{k_B T}\\right) $$\n\n我们需要计算比率 $r = k_{\\mathrm{off}}^{\\mathrm{MFPT}}/k_{\\mathrm{off}}^{\\mathrm{TST}}$。\n$$ r = \\frac{\\frac{D \\sqrt{W''(x_a)|W''(x^{\\ddagger})|}}{2\\pi k_B T} \\exp\\left(-\\frac{\\Delta W^{\\ddagger}}{k_B T}\\right)}{\\frac{k_B T}{h} \\exp\\left(-\\frac{\\Delta W^{\\ddagger}}{k_B T}\\right)} $$\n指数项相互抵消，剩下指前因子的比率：\n$$ r = \\frac{D h \\sqrt{W''(x_a)|W''(x^{\\ddagger})|}}{2\\pi (k_B T)^2} $$\n这个比率通常被认为是透射系数 $\\kappa$，它校正了 TST 未考虑但在扩散克拉默斯模型中已计入的重返穿越事件。\n\n现在，我们将给定的参数值代入 $r$ 的表达式中。首先进行符号代换是有利的。\n给定：\n$W''(x_a) = 2.0\\,k_{B}T\\,\\mathrm{nm}^{-2}$\n$|W''(x^{\\ddagger})| = 1.0\\,k_{B}T\\,\\mathrm{nm}^{-2}$\n\n平方根下的项变为：\n$$ \\sqrt{W''(x_a)|W''(x^{\\ddagger})|} = \\sqrt{(2.0\\,k_{B}T\\,\\mathrm{nm}^{-2})(1.0\\,k_{B}T\\,\\mathrm{nm}^{-2})} = \\sqrt{2.0} \\frac{k_B T}{\\mathrm{nm}^2} $$\n将此代入 $r$ 的表达式：\n$$ r = \\frac{D h \\left(\\sqrt{2.0} \\frac{k_B T}{\\mathrm{nm}^2}\\right)}{2\\pi (k_B T)^2} = \\frac{\\sqrt{2} D h}{2\\pi k_B T (\\mathrm{nm}^2)} $$\n这个简化的表达式已准备好进行数值计算。让我们使用所提供的国际单位制（SI）数值，除非发生单位抵消。\n$D = 0.10\\,\\mathrm{nm}^{2}\\,\\mathrm{ns}^{-1} = 0.10\\,\\mathrm{nm}^{2}\\,(10^{-9}\\,\\mathrm{s})^{-1} = 1.0 \\times 10^8\\,\\mathrm{nm}^{2}\\,\\mathrm{s}^{-1}$\n$h = 6.62607015 \\times 10^{-34}\\,\\mathrm{J\\,s}$\n$k_B = 1.380649 \\times 10^{-23}\\,\\mathrm{J\\,K^{-1}}$\n$T = 300\\,\\mathrm{K}$\n\n$k_B T$ 项为：\n$k_B T = (1.380649 \\times 10^{-23}\\,\\mathrm{J\\,K^{-1}}) \\times (300\\,\\mathrm{K}) = 4.141947 \\times 10^{-21}\\,\\mathrm{J}$\n\n现在我们计算 $r$：\n$$ r = \\frac{\\sqrt{2} (1.0 \\times 10^8\\,\\mathrm{nm}^{2}\\,\\mathrm{s}^{-1}) (6.62607015 \\times 10^{-34}\\,\\mathrm{J\\,s})}{2\\pi (4.141947 \\times 10^{-21}\\,\\mathrm{J}) (\\mathrm{nm}^2)} $$\n$\\mathrm{nm}^2$ 的单位直接抵消。剩下的单位是 $(\\mathrm{s}^{-1})(\\mathrm{J\\,s}) / \\mathrm{J}$，是无量纲的，符合预期。\n$$ r = \\frac{\\sqrt{2} \\times 1.0 \\times 10^8 \\times 6.62607015 \\times 10^{-34}}{2\\pi \\times 4.141947 \\times 10^{-21}} $$\n$$ r = \\frac{9.37080 \\times 10^{-26}}{2.60232 \\times 10^{-20}} $$\n$$ r = 3.60094 \\times 10^{-6} $$\n四舍五入到四位有效数字，我们得到 $r = 3.601 \\times 10^{-6}$。\n\n作为分析的一部分，我们可以计算各个速率。\n$k_{\\mathrm{off}}^{\\mathrm{TST}} = \\frac{k_B T}{h} \\exp(-12) = \\frac{4.141947 \\times 10^{-21}\\,\\mathrm{J}}{6.62607015 \\times 10^{-34}\\,\\mathrm{J\\,s}} \\exp(-12) \\approx (6.2506 \\times 10^{12}\\,\\mathrm{s}^{-1}) \\times (6.1442 \\times 10^{-6}) \\approx 3.841 \\times 10^7\\,\\mathrm{s}^{-1}$。\n$k_{\\mathrm{off}}^{\\mathrm{MFPT}} = r \\times k_{\\mathrm{off}}^{\\mathrm{TST}} = (3.60094 \\times 10^{-6}) \\times (3.84068 \\times 10^7\\,\\mathrm{s}^{-1}) \\approx 138.3\\,\\mathrm{s}^{-1}$。\n$r$ 的值非常小，表明在这种高摩擦（过阻尼）机制中，被 TST 忽略的势垒重返穿越事件极为频繁，导致速率远慢于 TST 的预测。\n\n最终要求的量是 $r$ 的数值，四舍五入到四位有效数字。\n$r \\approx 3.601 \\times 10^{-6}$。这可以写成 $0.000003601$。",
            "answer": "$$\\boxed{3.601 \\times 10^{-6}}$$"
        },
        {
            "introduction": "在计算生物学模拟中，对结合与非结合状态的定义，尤其是边界条件的选择，对停留时间的计算结果有着决定性的影响。本练习通过一个简化的无势能一维扩散模型，让你亲手求解平均首过时间（mean first passage time）。你将直接比较在口袋入口处设置反射边界（Reflective Boundary）与吸收边界（Absorbing Boundary）所导致的差异，从而深刻体会到模拟设置的细微之处如何显著改变动力学可观测量 。",
            "id": "3837047",
            "problem": "一个配体探索一个粗粒化的反应坐标，该坐标参数化了其从蛋白质结合口袋的口部到溶剂本体的运动。将此坐标建模为一维区间 $[0, L]$，位置为 $x \\in [0, L]$，其中 $x = 0$ 表示口袋口，$x = L$ 表示进入溶剂本体的入口。假设为过阻尼扩散，扩散系数 $D$ 为常数且无漂移，因此概率密度的演化由扩散方程（等价于力为零的Smoluchowski方程）决定，而相关的平均首达时间问题由后向Kolmogorov方程决定。将配体在外壳区域的驻留时间定义为由边界条件指定的到达离开事件的平均时间。考虑口袋口 $x = 0$ 处的两种边界条件模型：\n\n情况 R（反射性口袋边界）：$x = 0$ 处的边界是反射性的，而 $x = L$ 处的边界是吸收性的。物理上，这代表了一种计算方案，该方案阻止重新进入更深的口袋状态，同时允许逃逸到溶剂本体；驻留时间是首次到达 $x = L$ 的平均时间。\n\n情况 A（吸收性口袋边界）：$x = 0$ 和 $x = L$ 处的边界都是吸收性的。物理上，这代表了当轨迹重新进入口袋（$x = 0$）或逃逸到溶剂本体（$x = L$）时，轨迹的终止；驻留时间是首次到达任一吸收边界的平均时间。\n\n假设配体的初始位置 $x_0$ 在 $[0, a]$ 上均匀分布，其中 $0  a  L$，这代表了一种靠近口袋口的局域化制备。利用以下基本事实：对于生成元为 $\\mathcal{L} = D \\,\\frac{d^2}{dx^2}$ 的一维过阻尼扩散，从起始点 $x$ 出发的平均首达时间 $T(x)$ 满足后向方程 $-1 = \\mathcal{L} T(x)$，且服从由物理模型决定的边界条件。通过求解相应的边值问题并将 $T(x)$ 在 $[0, a]$ 上的均匀初始分布上进行平均，推导平均驻留时间 $\\langle \\tau_R \\rangle$ 和 $\\langle \\tau_A \\rangle$ 的解析表达式。然后，根据您的推导，从下面选择正确的选项，该选项给出了两种平均值，并正确解释了反射与吸收边界条件对计算出的驻留时间的影响：\n\nA. $\\langle \\tau_R \\rangle = \\dfrac{L^2}{2D} - \\dfrac{a^2}{6D}$ 且 $\\langle \\tau_A \\rangle = \\dfrac{L a}{4D} - \\dfrac{a^2}{6D}$；对于任何 $0  a  L$，$x = 0$ 处的反射边界相对于吸收边界模型，增加了计算出的驻留时间。\n\nB. $\\langle \\tau_R \\rangle = \\dfrac{L a}{4D} - \\dfrac{a^2}{6D}$ 且 $\\langle \\tau_A \\rangle = \\dfrac{L^2}{2D} - \\dfrac{a^2}{6D}$；$x = 0$ 处的吸收边界相对于反射模型，增加了计算出的驻留时间。\n\nC. $\\langle \\tau_R \\rangle = \\langle \\tau_A \\rangle = \\dfrac{L^2 - a^2}{2D}$；计算出的驻留时间与口袋口是反射性还是吸收性无关。\n\nD. $\\langle \\tau_R \\rangle = \\dfrac{L^2 - a^2}{2D}$ 且 $\\langle \\tau_A \\rangle = \\dfrac{a(L - a)}{2D}$；对于 $a \\to 0$，两个平均驻留时间都趋于零，因此当制备是强局域化时，$x = 0$ 处的边界条件不影响驻留时间。",
            "solution": "我们从平均首达时间的定义和后向Kolmogorov方程开始。对于在一维区间上、扩散系数 $D$ 为常数且无漂移的过阻尼扩散，其生成元为 $\\mathcal{L} = D \\,\\dfrac{d^2}{dx^2}$。到达指定吸收边界集的平均首达时间 $T(x)$ 满足后向方程\n$$\n-1 = D\\,\\frac{d^2 T}{dx^2}(x),\n$$\n其边界条件由物理模型给出。在点 $x_b$ 处的反射边界施加诺伊曼条件 $\\dfrac{dT}{dx}(x_b) = 0$，因为在正向问题中没有概率流穿过该边界，因此在后向算子中没有梯度贡献。在点 $x_b$ 处的吸收边界施加狄利克雷条件 $T(x_b) = 0$，因为从吸收点开始的首达时间为零。\n\n情况 R：在 $x = 0$ 处反射，在 $x = L$ 处吸收，首达 $x = L$。边值问题是\n$$\n-1 = D\\,T''(x), \\quad \\text{with} \\quad T'(0) = 0, \\quad T(L) = 0.\n$$\n积分 $T''(x) = -\\dfrac{1}{D}$ 得到\n$$\nT'(x) = -\\frac{x}{D} + C_1.\n$$\n$x=0$ 处的反射边界施加 $T'(0) = 0$，因此 $C_1 = 0$ 且 $T'(x) = -\\dfrac{x}{D}$。再次积分：\n$$\nT(x) = -\\frac{x^2}{2D} + C_2.\n$$\n施加 $T(L) = 0$ 来确定 $C_2 = \\dfrac{L^2}{2D}$。因此\n$$\nT_R(x) = \\frac{L^2 - x^2}{2D}.\n$$\n在 $[0, a]$ 上的均匀初始分布上的平均值为\n$$\n\\langle \\tau_R \\rangle = \\frac{1}{a} \\int_0^a T_R(x)\\,dx = \\frac{1}{a} \\int_0^a \\frac{L^2 - x^2}{2D}\\,dx = \\frac{1}{2D a} \\left( L^2 a - \\frac{a^3}{3} \\right) = \\frac{L^2}{2D} - \\frac{a^2}{6D}.\n$$\n\n情况 A：在 $x = 0$ 和 $x = L$ 处都吸收，首达任一边界。边值问题是\n$$\n-1 = D\\,T''(x), \\quad \\text{with} \\quad T(0) = 0, \\quad T(L) = 0.\n$$\n积分 $T''(x) = -\\dfrac{1}{D}$ 得到\n$$\nT'(x) = -\\frac{x}{D} + C_1, \\quad T(x) = -\\frac{x^2}{2D} + C_1 x + C_2.\n$$\n应用 $T(0) = 0$ 得到 $C_2 = 0$。应用 $T(L) = 0$ 得到\n$$\n-\\frac{L^2}{2D} + C_1 L = 0 \\quad \\Rightarrow \\quad C_1 = \\frac{L}{2D}.\n$$\n因此\n$$\nT_A(x) = -\\frac{x^2}{2D} + \\frac{L x}{2D} = \\frac{x(L - x)}{2D}.\n$$\n在 $[0, a]$ 上的均匀初始分布上取平均值：\n$$\n\\langle \\tau_A \\rangle = \\frac{1}{a} \\int_0^a T_A(x)\\,dx = \\frac{1}{a} \\int_0^a \\frac{x(L - x)}{2D}\\,dx = \\frac{1}{2D a} \\left( \\frac{L a^2}{2} - \\frac{a^3}{3} \\right) = \\frac{L a}{4D} - \\frac{a^2}{6D}.\n$$\n\n比较和解释。计算差值：\n$$\n\\langle \\tau_R \\rangle - \\langle \\tau_A \\rangle = \\left( \\frac{L^2}{2D} - \\frac{a^2}{6D} \\right) - \\left( \\frac{L a}{4D} - \\frac{a^2}{6D} \\right) = \\frac{1}{D} \\left( \\frac{L^2}{2} - \\frac{L a}{4} \\right) = \\frac{L}{D} \\left( \\frac{L}{2} - \\frac{a}{4} \\right).\n$$\n对于任何 $0  a  L$，我们有 $\\dfrac{L}{2} - \\dfrac{a}{4}  0$，因此 $\\langle \\tau_R \\rangle  \\langle \\tau_A \\rangle$。物理上，$x=0$ 处的反射边界禁止了通过重新进入口袋的离开方式，从而将可用的逃逸路线限制到溶剂本体，相对于 $x=0$ 处的吸收边界（它允许在任一端终止）增加了计算出的驻留时间。在极限 $a \\to 0$（制备任意靠近 $x = 0$）下，由于在 $x = 0$ 处的立即吸收，$\\langle \\tau_A \\rangle \\to 0$，而 $\\langle \\tau_R \\rangle \\to \\dfrac{L^2}{2D}$ 保持有限。\n\n逐项分析：\n\nA. 此选项报告了 $\\langle \\tau_R \\rangle = \\dfrac{L^2}{2D} - \\dfrac{a^2}{6D}$ 和 $\\langle \\tau_A \\rangle = \\dfrac{L a}{4D} - \\dfrac{a^2}{6D}$，与上面的解析推导相符。它也正确地解释了对于任何 $0  a  L$，反射边界相对于吸收边界模型会增加驻留时间的效果。结论：正确。\n\nB. 此选项交换了两个表达式，将较大的表达式分配给吸收情况，较小的分配给反射情况，并得出吸收边界增加了驻留时间的结论。这与推导和物理解释相矛盾；赋值是错误的。结论：错误。\n\nC. 此选项声称相等且与边界条件无关，共同值为 $\\dfrac{L^2 - a^2}{2D}$。这与后向问题的解不一致；平均首达时间依赖于边界条件，并且给出的具体表达式与两种情况的平均值都不匹配。结论：错误。\n\nD. 此选项给出了 $\\langle \\tau_R \\rangle = \\dfrac{L^2 - a^2}{2D}$ 和 $\\langle \\tau_A \\rangle = \\dfrac{a(L - a)}{2D}$，并断言当 $a \\to 0$ 时两者都消失。虽然当 $a \\to 0$ 时 $\\dfrac{a(L - a)}{2D} \\to 0$，但 $\\dfrac{L^2 - a^2}{2D} \\to \\dfrac{L^2}{2D} \\neq 0$，因此所述的极限和效果声称是错误的。此外，反射情况的平均值缺少了在 $[0, a]$ 上对 $x^2$ 积分时产生的 $\\dfrac{1}{3}$ 修正因子，因此与推导出的 $\\langle \\tau_R \\rangle$ 不匹配。结论：错误。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "无论是通过分子动力学模拟还是单分子实验，我们最终得到的数据通常是一系列测得的停留时间（dwell times）。如何从这些原始数据中提取出具有统计意义的动力学参数，是计算化学生物学中的一项关键技能。本练习将指导你运用最大似然估计（Maximum Likelihood Estimation, MLE）这一强大的统计工具，为符合单步指数过程和多步Gamma过程的两种解离模型估算平均停留时间（$\\tau_{\\mathrm{res}}$）及其置信区间，让你掌握从数据到结论的完整分析流程 。",
            "id": "3837054",
            "problem": "考虑一个计算化学生物学中的单分子结合实验，其中驻留时间（配体在解离前与受体保持结合的持续时间）被记录为一系列以秒为单位的正实数。在单步马尔可夫解离过程中，驻留时间是无记忆性的，并服从指数分布。在多步顺序解离中，解离前必须经过几个中间态，驻留时间呈非指数性，并且可以通过伽马分布族很好地建模，这与多个指数等待时间之和是一致的。从独立同分布观测的似然函数定义以及底层微观状态的马尔可夫性质出发，推导一种方法来估计指数和非指数驻留时间模型下的结合驻留时间及其不确定性。\n\n使用的定义：\n- 驻留时间是平均驻留时间，记为 $\\tau_{\\mathrm{res}}$。\n- 对于指数模型，参数是解离速率 $k_{\\mathrm{off}}$，使得 $\\tau_{\\mathrm{res}}$ 等于指数分布的均值。\n- 对于非指数模型，使用由正形状参数 $ \\alpha $ 和正速率参数 $ \\beta $ 参数化的伽马分布，这与连续时间马尔可夫链中的顺序步骤一致。\n\n您必须：\n- 基于似然原理，推导每种模型下参数的最大似然估计量。\n- 从这些参数估计中，获得每种模型的 $\\tau_{\\mathrm{res}}$ 估计值。\n- 以小数形式（例如，$ 0.95 $）量化在置信水平 $ 1 - \\alpha $ 下 $\\tau_{\\mathrm{res}}$ 的双侧置信区间，确保科学真实性和正确性。对于指数模型，使用从基本分布结果推导出的精确置信区间。对于伽马模型，使用基于费雪信息和delta方法的渐近方法。\n- 将解决方案实现为一个完整、可运行的程序。\n\n所有涉及物理单位的答案必须以秒表示。置信水平必须指定为小数，任何概率或置信水平不得使用百分号表示。最终输出必须是数值浮点值。\n\n测试套件：\n为以下四个测试用例提供结果。每个测试用例包含一个模型标识符和以秒为单位的驻留时间列表，以及以小数表示的置信水平 $ 1 - \\alpha $。在您的实现和计算中使用这些确切的列表。\n\n- 测试用例 $ 1 $ （指数模型，中等样本量的典型情况）：model $ = $ \"exp\", times $ = [\\, $0.41$, $0.28$, $0.55$, $0.32$, $0.77$, $1.09$, $0.63$, $0.40$, $0.94$, $0.35$ \\,]$, 置信水平 $ 1 - \\alpha = $ $0.95$。\n- 测试用例 $ 2 $ （伽马模型，具有多个步骤的非指数模型，中等样本量）：model $ = $ \"gamma\", times $ = [\\, $0.17$, $0.62$, $1.35$, $0.84$, $0.49$, $1.05$, $1.84$, $0.73$, $0.98$, $1.20$ \\,]$, 置信水平 $ 1 - \\alpha = $ $0.95$。\n- 测试用例 $ 3 $ （指数模型，小样本边缘情况）：model $ = $ \"exp\", times $ = [\\, $2.50$, $0.30$, $0.80$ \\,]$, 置信水平 $ 1 - \\alpha = $ $0.95$。\n- 测试用例 $ 4 $ （伽马模型，具有重尾的非指数模型，小样本）：model $ = $ \"gamma\", times $ = [\\, $0.02$, $0.05$, $0.10$, $0.20$, $1.00$, $2.50$, $3.00$ \\,]$, 置信水平 $ 1 - \\alpha = $ $0.95$。\n\n要求的最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。将所有测试用例的结果汇总成一个扁平的浮点数列表，每个测试用例按以下顺序排列：$ [\\, \\hat{\\tau}_{\\mathrm{res}}, \\mathrm{CI}_{\\mathrm{lower}}, \\mathrm{CI}_{\\mathrm{upper}} \\,] $。将所有测试用例的这些三元组连接起来，为所有四个测试用例生成一个单一列表。例如，生成 $ [\\, \\text{result}_{1}, \\text{result}_{2}, \\dots \\,] $，其中每个 $ \\text{result}_{i} $ 是一个浮点数。所有输出均以秒表示，并将每个浮点数四舍五入到 $ 6 $ 位小数。",
            "solution": "任务是推导并实现一种方法，用于从一组观测到的驻留时间 $t_1, t_2, \\dots, t_n$ 中估计结合驻留时间 $\\tau_{\\mathrm{res}}$ 及其相应的置信区间。该推导基于最大似然估计（MLE）原理，针对两种不同的解离动力学模型：单步指数过程和多步伽马过程。\n\n设给定的 $n$ 个独立同分布（i.i.d.）的驻留时间集合为 $\\mathbf{t} = \\{t_1, t_2, \\dots, t_n\\}$。给定数据 $\\mathbf{t}$，参数矢量 $\\theta$ 的似然函数 $L(\\theta; \\mathbf{t})$ 是观测值的联合概率密度函数（PDF）：\n$$L(\\theta; \\mathbf{t}) = \\prod_{i=1}^{n} f(t_i; \\theta)$$\nMLE $\\hat{\\theta}$ 是使 $L(\\theta; \\mathbf{t})$ 最大化的 $\\theta$ 值，或者等价地，使对数似然函数 $\\ell(\\theta; \\mathbf{t}) = \\ln L(\\theta; \\mathbf{t})$ 最大化的 $\\theta$ 值。\n\n为避免与伽马分布的形状参数 $\\alpha$ 混淆，我们将置信区间的显著性水平表示为 $\\alpha_{sig}$。因此，置信水平为 $1 - \\alpha_{sig}$。\n\n### 模型1：指数驻留时间\n\n对于单步马尔可夫解离过程，驻留时间服从指数分布。其PDF由下式给出：\n$$f(t; k_{\\mathrm{off}}) = k_{\\mathrm{off}} e^{-k_{\\mathrm{off}} t}$$\n对于 $t  0$，其中 $k_{\\mathrm{off}}$ 是解离速率常数。驻留时间 $\\tau_{\\mathrm{res}}$ 是该分布的均值，$\\tau_{\\mathrm{res}} = E[T] = 1/k_{\\mathrm{off}}$。\n\n$n$ 个观测值的对数似然函数为：\n$$\\ell(k_{\\mathrm{off}}; \\mathbf{t}) = \\ln \\left( \\prod_{i=1}^{n} k_{\\mathrm{off}} e^{-k_{\\mathrm{off}} t_i} \\right) = \\sum_{i=1}^{n} (\\ln k_{\\mathrm{off}} - k_{\\mathrm{off}} t_i) = n \\ln k_{\\mathrm{off}} - k_{\\mathrm{off}} \\sum_{i=1}^{n} t_i$$\n为了找到 $k_{\\mathrm{off}}$ 的MLE，我们将 $\\ell$ 对 $k_{\\mathrm{off}}$ 求导，并令结果为零：\n$$\\frac{d\\ell}{dk_{\\mathrm{off}}} = \\frac{n}{k_{\\mathrm{off}}} - \\sum_{i=1}^{n} t_i = 0$$\n求解 $k_{\\mathrm{off}}$ 可得其MLE $\\hat{k}_{\\mathrm{off}}$：\n$$\\hat{k}_{\\mathrm{off}} = \\frac{n}{\\sum_{i=1}^{n} t_i} = \\frac{1}{\\bar{t}}$$\n其中 $\\bar{t} = \\frac{1}{n}\\sum_{i=1}^{n} t_i$ 是驻留时间的样本均值。\n\n根据MLE的不变性，驻留时间的MLE $\\hat{\\tau}_{\\mathrm{res}}$ 可通过对 $\\hat{k}_{\\mathrm{off}}$ 应用相同的变换得到：\n$$\\hat{\\tau}_{\\mathrm{res}} = \\frac{1}{\\hat{k}_{\\mathrm{off}}} = \\bar{t}$$\n因此，对于指数模型，估计的驻留时间是观测驻留时间的样本均值。\n\n为了构建 $\\tau_{\\mathrm{res}}$ 的精确置信区间，我们利用这样一个事实：对于 $n$ 个均值为 $\\tau_{\\mathrm{res}}$ 的独立同分布指数随机变量 $T_i$，这些变量的和除以均值后服从一个明确定义的分布。量 $2 \\sum_{i=1}^n T_i / \\tau_{\\mathrm{res}}$ 服从自由度为 $2n$ 的卡方（$\\chi^2$）分布。\n$$ \\frac{2 \\sum_{i=1}^{n} T_i}{\\tau_{\\mathrm{res}}} \\sim \\chi^2_{2n} $$\n通过找到临界值 $\\chi^2_{\\alpha_{sig}/2, 2n}$ 和 $\\chi^2_{1-\\alpha_{sig}/2, 2n}$，可以构建置信水平为 $1 - \\alpha_{sig}$ 的双侧置信区间，使得：\n$$ P\\left( \\chi^2_{\\alpha_{sig}/2, 2n}  \\frac{2 \\sum t_i}{\\tau_{\\mathrm{res}}}  \\chi^2_{1-\\alpha_{sig}/2, 2n} \\right) = 1 - \\alpha_{sig} $$\n对不等式进行变换以求解 $\\tau_{\\mathrm{res}}$，得到精确置信区间：\n$$ \\left( \\frac{2 \\sum t_i}{\\chi^2_{1-\\alpha_{sig}/2, 2n}}, \\frac{2 \\sum t_i}{\\chi^2_{\\alpha_{sig}/2, 2n}} \\right) $$\n代入 $\\sum t_i = n\\bar{t} = n\\hat{\\tau}_{\\mathrm{res}}$，该区间为：\n$$ \\mathrm{CI} = \\left( \\frac{2n\\hat{\\tau}_{\\mathrm{res}}}{\\chi^2_{1-\\alpha_{sig}/2, 2n}}, \\frac{2n\\hat{\\tau}_{\\mathrm{res}}}{\\chi^2_{\\alpha_{sig}/2, 2n}} \\right) $$\n\n### 模型2：伽马驻留时间\n\n对于多步解离，驻留时间通过具有形状参数 $\\alpha  0$ 和速率参数 $\\beta  0$ 的伽马分布进行建模。其PDF为：\n$$f(t; \\alpha, \\beta) = \\frac{\\beta^\\alpha}{\\Gamma(\\alpha)} t^{\\alpha-1} e^{-\\beta t}$$\n其中 $\\Gamma(\\alpha)$ 是伽马函数。该分布的均值即为驻留时间，$\\tau_{\\mathrm{res}} = E[T] = \\alpha/\\beta$。\n\n$n$ 个观测值的对数似然函数为：\n$$\\ell(\\alpha, \\beta; \\mathbf{t}) = \\ln \\left( \\prod_{i=1}^{n} \\frac{\\beta^\\alpha}{\\Gamma(\\alpha)} t_i^{\\alpha-1} e^{-\\beta t_i} \\right) = n(\\alpha \\ln \\beta - \\ln \\Gamma(\\alpha)) + (\\alpha-1)\\sum_{i=1}^{n} \\ln t_i - \\beta \\sum_{i=1}^{n} t_i$$\n为了找到MLE，我们对 $\\alpha$ 和 $\\beta$ 求偏导数，并令其为零：\n$$ \\frac{\\partial\\ell}{\\partial\\beta} = \\frac{n\\alpha}{\\beta} - \\sum_{i=1}^{n} t_i = 0 \\implies \\hat{\\beta} = \\frac{\\hat{\\alpha}}{\\bar{t}} $$\n$$ \\frac{\\partial\\ell}{\\partial\\alpha} = n \\ln \\beta - n \\psi(\\alpha) + \\sum_{i=1}^{n} \\ln t_i = 0 $$\n其中 $\\psi(\\alpha) = \\frac{d}{d\\alpha}\\ln\\Gamma(\\alpha)$ 是双伽马函数。将 $\\hat{\\beta}$ 的表达式代入第二个方程，得到一个关于 $\\hat{\\alpha}$ 的方程：\n$$ n \\ln\\left(\\frac{\\hat{\\alpha}}{\\bar{t}}\\right) - n \\psi(\\hat{\\alpha}) + \\sum_{i=1}^{n} \\ln t_i = 0 \\implies \\ln(\\hat{\\alpha}) - \\psi(\\hat{\\alpha}) = \\ln(\\bar{t}) - \\frac{1}{n}\\sum_{i=1}^{n} \\ln t_i $$\n这个关于 $\\hat{\\alpha}$ 的超越方程必须通过数值方法求解。一旦求得 $\\hat{\\alpha}$，就可以通过 $\\hat{\\beta} = \\hat{\\alpha}/\\bar{t}$ 计算出 $\\hat{\\beta}$。\n利用MLE的不变性，驻留时间的MLE为：\n$$\\hat{\\tau}_{\\mathrm{res}} = \\frac{\\hat{\\alpha}}{\\hat{\\beta}} = \\frac{\\hat{\\alpha}}{\\hat{\\alpha}/\\bar{t}} = \\bar{t}$$\n值得注意的是，平均驻留时间的MLE同样是样本均值，就像在指数模型中一样。\n\n对于置信区间，采用渐近方法。中心极限定理指出，对于大样本 $n$，样本均值 $\\bar{t}$ 近似服从均值为 $\\tau_{\\mathrm{res}}$、方差为 $\\text{Var}(T)/n$ 的正态分布。伽马分布变量 $T$ 的方差为 $\\text{Var}(T) = \\alpha/\\beta^2$。估计量 $\\hat{\\tau}_{\\mathrm{res}} = \\bar{t}$ 的标准误是：\n$$ SE(\\hat{\\tau}_{\\mathrm{res}}) = \\sqrt{\\frac{\\text{Var}(T)}{n}} = \\sqrt{\\frac{\\alpha}{n\\beta^2}} $$\n我们用其MLE $\\hat{\\alpha}$ 和 $\\hat{\\beta}$ 替换真实参数 $\\alpha$ 和 $\\beta$，得到估计的标准误：\n$$ \\widehat{SE}(\\hat{\\tau}_{\\mathrm{res}}) = \\sqrt{\\frac{\\hat{\\alpha}}{n\\hat{\\beta}^2}} = \\sqrt{\\frac{\\hat{\\alpha}}{n(\\hat{\\alpha}/\\bar{t})^2}} = \\sqrt{\\frac{\\bar{t}^2}{n\\hat{\\alpha}}} = \\frac{\\bar{t}}{\\sqrt{n\\hat{\\alpha}}} = \\frac{\\hat{\\tau}_{\\mathrm{res}}}{\\sqrt{n\\hat{\\alpha}}} $$\n那么，置信水平为 $1 - \\alpha_{sig}$ 的渐近双侧置信区间为：\n$$ \\mathrm{CI} = \\hat{\\tau}_{\\mathrm{res}} \\pm z_{1-\\alpha_{sig}/2} \\cdot \\widehat{SE}(\\hat{\\tau}_{\\mathrm{res}}) = \\hat{\\tau}_{\\mathrm{res}} \\left( 1 \\pm \\frac{z_{1-\\alpha_{sig}/2}}{\\sqrt{n\\hat{\\alpha}}} \\right) $$\n其中 $z_{1-\\alpha_{sig}/2}$ 是标准正态分布的上 $1 - \\alpha_{sig}/2$ 分位数。该区间依赖于MLE的渐近正态性，适用于伽马模型，因为在这种模型下不存在精确且易于处理的枢轴量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import chi2, gamma, norm\nfrom scipy.special import digamma, polygamma\nimport sys\nimport warnings\n\ndef calculate_exp_model(times, confidence_level):\n    \"\"\"\n    Calculates residence time and its confidence interval for the exponential model.\n\n    Args:\n        times (list or np.ndarray): List of observed dwell times in seconds.\n        confidence_level (float): The confidence level for the interval (e.g., 0.95).\n\n    Returns:\n        tuple: A tuple containing (tau_res_hat, ci_lower, ci_upper).\n    \"\"\"\n    times = np.asarray(times)\n    n = len(times)\n    if n == 0:\n        return np.nan, np.nan, np.nan\n\n    # MLE for residence time is the sample mean\n    tau_res_hat = np.mean(times)\n    \n    # Per the derivation, an exact CI is based on the Chi-squared distribution\n    alpha_sig = 1.0 - confidence_level\n    df = 2 * n\n    \n    # Sum of observations\n    sum_t = np.sum(times)\n    \n    # Chi-squared critical values\n    chi2_lower_crit = chi2.ppf(alpha_sig / 2, df)\n    chi2_upper_crit = chi2.ppf(1 - alpha_sig / 2, df)\n    \n    # The upper bound of the CI uses the lower critical value of chi2, and vice-versa.\n    ci_upper = (2 * sum_t) / chi2_lower_crit if chi2_lower_crit > 0 else np.inf\n    ci_lower = (2 * sum_t) / chi2_upper_crit if chi2_upper_crit > 0 else 0\n    \n    return tau_res_hat, ci_lower, ci_upper\n\ndef calculate_gamma_model(times, confidence_level):\n    \"\"\"\n    Calculates residence time and its CI for the Gamma model.\n\n    Args:\n        times (list or np.ndarray): List of observed dwell times in seconds.\n        confidence_level (float): The confidence level for the interval (e.g., 0.95).\n\n    Returns:\n        tuple: A tuple containing (tau_res_hat, ci_lower, ci_upper).\n    \"\"\"\n    times = np.asarray(times)\n    n = len(times)\n    if n == 0:\n        return np.nan, np.nan, np.nan\n\n    # MLE for residence time is the sample mean\n    tau_res_hat = np.mean(times)\n\n    # Use scipy's built-in MLE fitter for the Gamma distribution to get alpha_hat\n    # The Gamma PDF in scipy is parameterized by a shape 'a', loc, and scale.\n    # Our PDF has shape=alpha, rate=beta. The relationship is scale = 1/beta.\n    # We assume loc=0.\n    # The fitter solves the transcendental equation for alpha numerically.\n    # A known issue in older scipy versions might cause warnings for small samples.\n    with warnings.catch_warnings():\n        warnings.simplefilter(\"ignore\", category=RuntimeWarning)\n        try:\n            alpha_hat, _, _ = gamma.fit(times, floc=0)\n        except Exception:\n            # Fallback for numerical instability, especially with very small samples\n            # or extreme data, although gamma.fit is generally robust.\n            return tau_res_hat, np.nan, np.nan\n    \n    # Asymptotic CI based on the Normal approximation and the delta method\n    alpha_sig = 1.0 - confidence_level\n    z_crit = norm.ppf(1 - alpha_sig / 2)\n    \n    # Standard error of tau_res_hat\n    se_tau = tau_res_hat / np.sqrt(n * alpha_hat)\n    \n    margin_of_error = z_crit * se_tau\n    \n    ci_lower = tau_res_hat - margin_of_error\n    ci_upper = tau_res_hat + margin_of_error\n    \n    # A physical dwell time cannot be negative.\n    ci_lower = max(0, ci_lower)\n\n    return tau_res_hat, ci_lower, ci_upper\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        (\"exp\", [0.41, 0.28, 0.55, 0.32, 0.77, 1.09, 0.63, 0.40, 0.94, 0.35], 0.95),\n        (\"gamma\", [0.17, 0.62, 1.35, 0.84, 0.49, 1.05, 1.84, 0.73, 0.98, 1.20], 0.95),\n        (\"exp\", [2.50, 0.30, 0.80], 0.95),\n        (\"gamma\", [0.02, 0.05, 0.10, 0.20, 1.00, 2.50, 3.00], 0.95),\n    ]\n\n    all_results = []\n    for model, times, conf_level in test_cases:\n        if model == \"exp\":\n            results = calculate_exp_model(times, conf_level)\n        elif model == \"gamma\":\n            results = calculate_gamma_model(times, conf_level)\n        else:\n            raise ValueError(f\"Unknown model type: {model}\")\n        \n        all_results.extend(results)\n\n    # Format output to 6 decimal places as required.\n    formatted_results = [f\"{val:.6f}\" for val in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}