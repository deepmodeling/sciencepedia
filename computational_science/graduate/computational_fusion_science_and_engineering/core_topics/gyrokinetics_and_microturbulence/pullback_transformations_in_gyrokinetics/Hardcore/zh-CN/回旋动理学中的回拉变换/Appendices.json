{
    "hands_on_practices": [
        {
            "introduction": "在磁约束聚变等离子体中，粒子往往表现出多种时间尺度分离的运动。回拉变换等现代哈密顿方法的一个核心应用，就是通过对快时间尺度运动进行平均，来系统地导出描述慢时间尺度演化的有效理论。这个练习将引导您通过对“弹跳运动”这一快变量进行平均，来推导引导中心坐标系下的“弹跳中心哈密顿量”，这是理解捕获粒子长期输运性质的关键一步，也是掌握回拉变换思想的经典范例 ()。",
            "id": "4033770",
            "problem": "考虑一个质量为 $m$、电荷为 $q$ 的单个捕获离子，该离子位于一个静态、轴对称、大环径比的环形磁约束装置中。该离子的动力学在导心和回旋动理学框架下进行描述，您将通过由哈密顿李变换（HLT）生成的拉回变换，构建最低阶的反弹中心（BC）描述。沿着一条选定的磁力线，其磁场强度在最小值附近被建模为弧长坐标 $s$ 的一个光滑函数，\n$$\nB(s) \\equiv B_{0}\\left[1 + (R_{m}-1)\\,\\frac{s^{2}}{s_{m}^{2}}\\right],\n$$\n其中 $B_{0}$ 是 $s=0$ 处的最小磁场强度，$s_{m}>0$ 是界定局部磁阱的转折点所在的弧长位置，而 $R_{m} \\equiv B_{\\max}/B_{0} > 1$ 是磁镜比。假设不存在静电势，并忽略超出最低阶的漂移阶修正。该离子具有固定的磁矩 $\\mu$，并在 $s=0$ 附近进行小振幅反弹振荡。\n\n从回旋动理学（GK）中导心和反弹中心动力学的适当基本定律和核心定义出发，包括导心哈密顿量和沿磁力线的最低阶运动方程，使用哈密顿李变换拉回方法消除快反弹相位，并构建作为反弹作用量 $J_{b}$ 函数的最低阶反弹中心哈密顿量 $H_{\\mathrm{BC}}^{(0)}$。您的推导必须：\n- 从用平行正则动量和磁矩表示的导心哈密顿量开始，\n- 对 $s=0$ 附近的平行动力学进行线性化，以获得小振幅反弹频率，\n- 定义与平行振荡相关的反弹作用量 $J_{b}$，\n- 执行与到反弹中心的拉回变换一致的、对反弹相位的最低阶平均。\n\n在您的最终表达式中，指明哪些项依赖于磁镜比 $R_{m}$ 和通过 $B(s)$ 在 $s=0$ 处的导数表示的局部场强曲率。将最终答案表示为关于 $J_{b}$、$\\mu$、$B_{0}$、$R_{m}$、$s_{m}$ 和 $m$ 的 $H_{\\mathrm{BC}}^{(0)}$ 的单个闭式解析表达式。无需进行数值计算。如果您引入任何缩写，请在首次使用时写出全称，例如：回旋动理学（GK）、反弹中心（BC）、哈密顿李变换（HLT）。",
            "solution": "该问题陈述是高等离子体物理学中一个适定且有科学依据的练习，特别是在回旋动理学和哈密顿力学主题内。它要求在一组特定的有效物理近似下，推导捕获离子的最低阶反弹中心哈密顿量。所有提供的信息都是自洽的，足以进行推导。因此，该问题被认为是有效的。\n\n目标是通过对捕获离子的快反弹运动进行平均，来构建其最低阶反弹中心（BC）哈密顿量 $H_{\\mathrm{BC}}^{(0)}$。这是通过哈密顿李变换（HLT）拉回实现的，在最低阶上，这等同于相位平均。推导过程分为四个步骤。\n\n首先，我们建立导心（GC）哈密顿量。在没有静电势的情况下，导心哈密顿量 $H_{\\mathrm{GC}}$ 是用导心变量表示的粒子动能。它是与平行于磁场的运动相关的动能和回旋运动能量之和。\n$$\nH_{\\mathrm{GC}} = \\frac{p_{\\parallel}^{2}}{2m} + \\mu B\n$$\n此处，$p_{\\parallel} = m v_{\\parallel}$ 是平行正则动量（也是动理动量，因为磁矢势的贡献已由导心变换处理），$m$ 是离子质量，$\\mu$ 是磁矩（一个绝热不变量），$B$ 是磁场强度。问题给出了沿磁力线的磁场强度大小的空间依赖关系，由弧长 $s$ 参数化：\n$$\nB(s) = B_{0}\\left[1 + (R_{m}-1)\\frac{s^{2}}{s_{m}^{2}}\\right]\n$$\n其中 $B_{0}$ 是 $s=0$ 处的最小磁场强度，$R_{m}$ 是磁镜比，$s_{m}$ 是磁阱的特征长度尺度。将此代入导心哈密顿量，得到：\n$$\nH_{\\mathrm{GC}}(s, p_{\\parallel}) = \\frac{p_{\\parallel}^{2}}{2m} + \\mu B_{0}\\left[1 + (R_{m}-1)\\frac{s^{2}}{s_{m}^{2}}\\right]\n$$\n这个哈密顿量是导心动力学的一个运动常数。\n\n第二，我们分析平行动力学以求出反弹频率。平行坐标 $(s, p_{\\parallel})$ 的运动方程由哈密顿方程给出：\n$$\n\\dot{s} = \\frac{\\partial H_{\\mathrm{GC}}}{\\partial p_{\\parallel}} = \\frac{p_{\\parallel}}{m}\n$$\n$$\n\\dot{p}_{\\parallel} = -\\frac{\\partial H_{\\mathrm{GC}}}{\\partial s} = -\\mu B_{0} (R_{m}-1) \\frac{2s}{s_{m}^{2}}\n$$\n对 $\\dot{s}$ 关于时间求导，并代入 $\\dot{p}_{\\parallel}$，得到坐标 $s$ 的运动方程：\n$$\n\\ddot{s} = \\frac{\\dot{p}_{\\parallel}}{m} = -\\left[ \\frac{2 \\mu B_{0} (R_{m}-1)}{m s_{m}^{2}} \\right] s\n$$\n这是简谐振子的方程，$\\ddot{s} + \\omega_{b}^{2}s = 0$。通过比较这两种形式，我们确定小振幅反弹频率 $\\omega_{b}$ 的平方：\n$$\n\\omega_{b}^{2} = \\frac{2 \\mu B_{0} (R_{m}-1)}{m s_{m}^{2}}\n$$\n因此，反弹频率为：\n$$\n\\omega_{b} = \\sqrt{\\frac{2 \\mu B_{0} (R_{m}-1)}{m s_{m}^{2}}}\n$$\n\n第三，我们定义反弹作用量 $J_{b}$。反弹作用量是与反弹相位角共轭的正则作用量变量。对于一维谐振子，其作用量 $J$ 与其能量 $E_{\\mathrm{osc}}$ 和频率 $\\omega$ 通过 $E_{\\mathrm{osc}} = J \\omega$ 相关联。在我们的例子中，“振子能量”是哈密顿量中与平行运动相关的部分，我们可以将其定义为 $H_{\\parallel} = H_{\\mathrm{GC}} - \\mu B_{0}$。\n$$\nH_{\\parallel}(s, p_{\\parallel}) = \\frac{p_{\\parallel}^{2}}{2m} + \\mu \\left( B(s) - B_{0} \\right) = \\frac{p_{\\parallel}^{2}}{2m} + \\mu B_{0} (R_{m}-1)\\frac{s^{2}}{s_{m}^{2}}\n$$\n这代表了谐振的能量。由于 $H_{\\mathrm{GC}}$ 是一个运动常数，所以 $H_{\\parallel}$ 也是。反弹作用量 $J_{b}$ 与该能量的关系为：\n$$\nJ_{b} = \\frac{H_{\\parallel}}{\\omega_{b}} = \\frac{H_{\\mathrm{GC}} - \\mu B_{0}}{\\omega_{b}}\n$$\n\n第四，我们构建最低阶反弹中心哈密顿量 $H_{\\mathrm{BC}}^{(0)}$。到 BC 框架的 HLT 拉回旨在消除对快反弹相位的依赖。在最低阶上，得到的哈密顿量 $H_{\\mathrm{BC}}^{(0)}$ 是原始哈密顿量 $H_{\\mathrm{GC}}$ 的反弹平均。平均过程将哈密顿量从一个 $(s, p_{\\parallel})$ 的函数转换为一个反弹作用量 $J_{b}$ 的函数。根据第三步中推导出的关系，我们可以完全用在一个反弹周期内保持不变的量来表示 $H_{\\mathrm{GC}}$：$J_{b}$、$\\mu$ 以及磁场参数。\n$$\nH_{\\mathrm{GC}} = J_{b} \\omega_{b} + \\mu B_{0}\n$$\n由于该表达式已经与反弹相位无关，其在反弹运动上的平均值就是其本身。因此，最低阶 BC 哈密顿量为：\n$$\nH_{\\mathrm{BC}}^{(0)}(J_{b}) = J_{b} \\omega_{b} + \\mu B_{0}\n$$\n代入 $\\omega_{b}$ 的表达式：\n$$\nH_{\\mathrm{BC}}^{(0)}(J_{b}) = J_{b} \\sqrt{\\frac{2 \\mu B_{0} (R_{m}-1)}{m s_{m}^{2}}} + \\mu B_{0}\n$$\n按要求，我们指明其依赖关系。第一项 $J_b \\omega_b$ 通过因子 $(R_{m}-1)$ 依赖于磁镜比 $R_{m}$。该项也依赖于 $s=0$ 处的局部场强曲率。磁场的二阶导数为 $B''(s) = \\frac{d^{2}B}{ds^{2}} = \\frac{2 B_{0} (R_{m}-1)}{s_{m}^{2}}$。因此，反弹频率可以写成 $\\omega_{b} = \\sqrt{\\mu B''(0)/m}$。反弹中心哈密顿量的第一项与该曲率的平方根成正比，这表明了捕获势的形状与粒子反弹动力学之间的联系。最终表达式以给定的参数形式呈现。",
            "answer": "$$\\boxed{H_{\\mathrm{BC}}^{(0)} = J_{b} \\sqrt{\\frac{2 \\mu B_{0} (R_{m} - 1)}{m s_{m}^{2}}} + \\mu B_{0}}$$"
        },
        {
            "introduction": "从粒子坐标到回旋中心坐标的回拉变换中，一个关键步骤是“回旋平均”电势。这一操作在数学上会引入贝塞尔函数 $J_0(k_{\\perp} \\rho)$，它描述了有限拉莫半径效应对粒子感受到的波场的修正。在实际的解析模型和数值模拟中，为了简化计算，常常需要对贝塞尔函数进行级数展开并截断。这个练习提供了一个绝佳的机会，让您亲手计算这种数学近似（即贝塞尔级数截断）如何直接导致物理预测的误差（粒子漂移的相位误差），从而深刻理解理论简化与模型精度之间的权衡 ()。",
            "id": "4033713",
            "problem": "考虑一个均匀磁场 $\\mathbf{B} = B \\,\\hat{\\mathbf{z}}$ 和一个单模、静电、垂直平面波势 $\\phi(\\mathbf{r}) = \\Phi_0 \\cos(\\mathbf{k}_{\\perp} \\cdot \\mathbf{r})$，其中 $|\\mathbf{k}_{\\perp}| = k_{\\perp}$，$\\Phi_0$ 是一个恒定振幅。一个质量为 $m$、电荷为 $q$ 的带电粒子进行快速的回旋运动，其回旋频率为 $\\Omega \\equiv |q| B/(m c)$，拉莫尔半径为 $\\rho \\equiv v_{\\perp}/\\Omega$，其中 $v_{\\perp}$ 是垂直速度。在回旋动理学描述中，回旋中心位置 $\\mathbf{X}$ 的慢漂移动力学是通过从粒子坐标到回旋中心坐标的拉回变换得到的，该变换给出了进入回旋中心运动方程的回旋平均势。对于单个垂直平面波模式，拉回变换的回旋平均产生 $\\phi_{\\text{gy}}(\\mathbf{X}) = \\Phi_0 J_0(k_{\\perp} \\rho) \\cos(\\mathbf{k}_{\\perp} \\cdot \\mathbf{X})$，其中 $J_0$ 是第一类零阶贝塞尔函数。\n\n假设粒子停留在点 $\\mathbf{X}_0$ 的一个小邻域内，使得在所考虑的时间范围内 $\\nabla \\phi_{\\text{gy}}$ 的空间变化可以被视为局部恒定（即，漂移位移足够小，以至于 $|\\mathbf{k}_{\\perp} \\cdot (\\mathbf{X}-\\mathbf{X}_0)| \\ll 1$）。在此局域近似下，回旋平均的 $\\mathbf{E}\\times\\mathbf{B}$ 漂移为 $\\mathbf{v}_E \\approx (c/B)\\,\\hat{\\mathbf{z}} \\times \\nabla \\phi_{\\text{gy}}(\\mathbf{X}_0)$，其大小为 $V_E \\approx (c/B)\\,k_{\\perp} \\Phi_0 J_0(k_{\\perp} \\rho)$。假设我们不精确计算 $J_0(k_{\\perp} \\rho)$，而是在 $p \\in \\mathbb{N}_0$ 阶截断其麦克劳林级数，使用\n$$\nJ_0(x) \\approx J_0^{(p)}(x) \\equiv \\sum_{n=0}^{p} (-1)^{n} \\frac{(x^2/4)^{n}}{(n!)^2}.\n$$\n当漂移位移与波数为 $k_{\\perp}$ 的模式的波相位进行比较时，这种截断会在漂移速度中引入一个误差，该误差随时间累积成一个相位误差。将累积漂移相位定义为 $\\varphi(t) \\equiv k_{\\perp} \\Delta s(t)$，其中 $\\Delta s(t)$ 是在时间 $t$ 内由 $\\mathbf{v}_E$ 产生的沿垂直于 $\\mathbf{k}_{\\perp}$ 方向的漂移位移。在 $N$ 个回旋周期（$T_c \\equiv 2\\pi/\\Omega$）后，由于截断贝塞尔级数而产生的累积相位误差为 $\\Delta \\varphi(N) \\equiv \\varphi_{\\text{exact}}(N T_c) - \\varphi_{\\text{trunc}}(N T_c)$。\n\n从洛伦兹力定律和 $\\mathbf{E}\\times\\mathbf{B}$ 漂移的定义出发，结合拉回变换提供的回旋平均场，使用上面指定的截断 $J_0^{(p)}(k_{\\perp} \\rho)$，推导 $\\Delta \\varphi(N)$ 关于 $N$、$k_{\\perp}$、$\\rho$、$\\Phi_0$、$B$、$c$ 和 $\\Omega$ 的解析表达式。将最终的相位误差以弧度为单位，表示为单个闭合形式的表达式。",
            "solution": "该问题已经过验证，被认为是计算等离子体物理学中一个适定、有科学依据的问题。它自洽、一致，没有使其无效的缺陷。我们开始推导。\n\n目标是求出因截断回旋平均 $\\mathbf{E}\\times\\mathbf{B}$ 漂移表达式中的贝塞尔函数而产生的累积相位误差 $\\Delta \\varphi(N)$。该相位误差定义为在 $N$ 个回旋周期后，精确相位与截断相位之差：\n$$\n\\Delta \\varphi(N) \\equiv \\varphi_{\\text{exact}}(N T_c) - \\varphi_{\\text{trunc}}(N T_c)\n$$\n其中 $T_c = 2\\pi/\\Omega$ 是回旋周期。\n\n累积漂移相位由 $\\varphi(t) = k_{\\perp} \\Delta s(t)$ 给出，其中 $\\Delta s(t)$ 是回旋中心在时间 $t$ 内沿垂直于波矢量 $\\mathbf{k}_{\\perp}$ 方向的位移。问题指出，在局域近似中，漂移速度 $\\mathbf{v}_E$ 被认为是恒定的。漂移速度由 $\\mathbf{v}_E \\approx (c/B)\\,\\hat{\\mathbf{z}} \\times \\nabla \\phi_{\\text{gy}}(\\mathbf{X}_0)$ 给出。由于 $\\nabla \\phi_{\\text{gy}} \\propto \\mathbf{k}_{\\perp}$ 且 $\\mathbf{k}_{\\perp}$ 垂直于 $\\hat{\\mathbf{z}}$，矢量 $\\hat{\\mathbf{z}} \\times \\mathbf{k}_{\\perp}$ 垂直于 $\\mathbf{k}_{\\perp}$。因此，漂移位移 $\\Delta \\mathbf{s}(t) = \\mathbf{v}_E t$ 完全在垂直于 $\\mathbf{k}_{\\perp}$ 的方向上。该位移的大小为 $\\Delta s(t) = V_E t$，其中 $V_E = |\\mathbf{v}_E|$。\n\n因此，在时间 $t$ 的累积相位为 $\\varphi(t) = k_{\\perp} V_E t$。漂移速度的大小给出为 $V_E \\approx (c/B)\\,k_{\\perp} \\Phi_0 J_0(k_{\\perp} \\rho)$。这构成了精确计算和截断计算的基础。\n\n首先，我们计算精确的累积相位 $\\varphi_{\\text{exact}}$。精确的漂移速度 $V_{E, \\text{exact}}$ 使用完整的贝塞尔函数 $J_0(k_{\\perp} \\rho)$：\n$$\nV_{E, \\text{exact}} = \\frac{c k_{\\perp} \\Phi_0}{B} J_0(k_{\\perp} \\rho)\n$$\n总耗时为 $t = N T_c = 2\\pi N/\\Omega$。精确相位为：\n$$\n\\varphi_{\\text{exact}}(N T_c) = k_{\\perp} V_{E, \\text{exact}} (N T_c) = k_{\\perp} \\left( \\frac{c k_{\\perp} \\Phi_0}{B} J_0(k_{\\perp} \\rho) \\right) \\left( \\frac{2\\pi N}{\\Omega} \\right)\n$$\n$$\n\\varphi_{\\text{exact}}(N T_c) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} J_0(k_{\\perp} \\rho)\n$$\n接下来，我们使用截断近似计算相位 $\\varphi_{\\text{trunc}}$。此时，漂移速度基于截断的贝塞尔函数 $J_0^{(p)}(k_{\\perp} \\rho)$：\n$$\nJ_0^{(p)}(x) \\equiv \\sum_{n=0}^{p} (-1)^{n} \\frac{(x^2/4)^{n}}{(n!)^2}\n$$\n截断的漂移速度为：\n$$\nV_{E, \\text{trunc}} = \\frac{c k_{\\perp} \\Phi_0}{B} J_0^{(p)}(k_{\\perp} \\rho)\n$$\n截断相位为：\n$$\n\\varphi_{\\text{trunc}}(N T_c) = k_{\\perp} V_{E, \\text{trunc}} (N T_c) = k_{\\perp} \\left( \\frac{c k_{\\perp} \\Phi_0}{B} J_0^{(p)}(k_{\\perp} \\rho) \\right) \\left( \\frac{2\\pi N}{\\Omega} \\right)\n$$\n$$\n\\varphi_{\\text{trunc}}(N T_c) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} J_0^{(p)}(k_{\\perp} \\rho)\n$$\n累积相位误差 $\\Delta \\varphi(N)$ 是这两个量之差：\n$$\n\\Delta \\varphi(N) = \\varphi_{\\text{exact}}(N T_c) - \\varphi_{\\text{trunc}}(N T_c)\n$$\n$$\n\\Delta \\varphi(N) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} J_0(k_{\\perp} \\rho) - \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} J_0^{(p)}(k_{\\perp} \\rho)\n$$\n提取公因式，我们得到：\n$$\n\\Delta \\varphi(N) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} \\left( J_0(k_{\\perp} \\rho) - J_0^{(p)}(k_{\\perp} \\rho) \\right)\n$$\n代入截断级数 $J_0^{(p)}$ 的定义，我们得到相位误差的最终表达式：\n$$\n\\Delta \\varphi(N) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} \\left( J_0(k_{\\perp} \\rho) - \\sum_{n=0}^{p} \\frac{(-1)^{n}}{(n!)^2} \\left( \\frac{k_{\\perp}^2 \\rho^2}{4} \\right)^{n} \\right)\n$$\n此表达式以弧度为单位，提供了一个单一的闭合形式表达式，该表达式依赖于给定的参数 $N$、$k_{\\perp}$、$\\rho$、$\\Phi_0$、$B$、$c$ 和 $\\Omega$ 以及截断阶数 $p$。\n括号中的项表示 $J_0(k_{\\perp}\\rho)$ 的泰勒级数在 $p$ 阶项之后的余项，可以表示为从 $n=p+1$ 开始的无穷级数：\n$$\nJ_0(k_{\\perp} \\rho) - J_0^{(p)}(k_{\\perp} \\rho) = \\sum_{n=p+1}^{\\infty} \\frac{(-1)^{n}}{(n!)^2} \\left( \\frac{k_{\\perp}^2 \\rho^2}{4} \\right)^{n}\n$$\n因此，推导出的表达式是完整且正确的解析结果。",
            "answer": "$$\\boxed{\\Delta \\varphi(N) = \\frac{2\\pi N c \\Phi_0 k_{\\perp}^2}{B \\Omega} \\left( J_0(k_{\\perp} \\rho) - \\sum_{n=0}^{p} \\frac{(-1)^{n}}{(n!)^2} \\left( \\frac{k_{\\perp}^2 \\rho^2}{4} \\right)^{n} \\right)}$$"
        },
        {
            "introduction": "将连续的回旋动理学理论转化为离散的数值模拟算法，需要精巧的设计以保证基本物理守恒律。在“网格-粒子”（PIC）模拟中，回拉变换具体体现为在回旋中心和模拟网格之间传递信息的算法。这个实践项目要求您为一个“$\\delta f$”回旋动理学PIC模型设计并实现一个离散的回拉变换方案，其核心挑战在于确保粒子权重从回旋中心空间映射到粒子空间的过程中，总电荷在离散网格上严格守恒 ()。这不仅是算法层面的练习，更是对物理守恒性如何在计算中得以维持的深刻体验。",
            "id": "4033726",
            "problem": "请考虑在$\\delta f$（delta f）粒子模拟（PIC）回旋动理学算法中，回旋中心相空间与粒子相空间之间的变换。您的任务是设计一个离散拉回方案，该方案将粒子权重从回旋中心空间映射到粒子空间，同时在一维周期性区域中保持总电荷守恒。该方案必须从与电荷守恒和回旋相平均的一致离散表示相符的第一性原理推导得出。数值实现必须使用一阶云中单元（Cloud-In-Cell）进行电荷分配和插值，以用于网格到粒子和粒子到网格的操作。\n\n假设以下建模假设和计算设置：\n- 区域为一维、周期性，长度为 $L$，用 $N_g$ 个均匀间隔的网格节点离散化，网格间距为 $\\Delta x = L/N_g$。\n- 每个标记点（计算粒子）具有一个回旋中心位置 $R_p \\in [0,L)$ 和一个标量权重 $w_p^{\\mathrm{gc}}$，代表其在回旋中心坐标系中的$\\delta f$权重。\n- 每个标记点的拉莫尔半径以标量 $\\rho_p$ 给出。为简化这个一维模型，回旋相环沿区域坐标投影为一组位置 $x_{p,k}$，这些位置是通过从 $R_p$ 进行余弦位移和角度采样获得的。\n- 回旋相采样使用 $N_\\theta$ 个在整个 $2\\pi$ 弧度上均匀间隔的角度。所有角度必须以弧度为单位。\n- 静电势 $\\phi(x)$ 定义在网格节点上。从网格到粒子的插值使用与从粒子到网格的分配相同的一阶云中单元权重。\n\n您的任务是：\n1. 从总电荷在拉回映射（从回旋中心权重到粒子空间权重）下必须保持不变的要求以及一阶云中单元形状函数的离散性质出发，推导出一个离散拉回规则，确保在映射后，网格上分配的总电荷完全守恒。您必须明确定义电势的离散回旋相平均以及映射如何使用它。\n2. 在一个程序中实现所推导的方案，该程序：\n   - 生成一组具有位置 $R_p$ 和回旋中心权重 $w_p^{\\mathrm{gc}}$ 的标记点。\n   - 使用 $N_\\theta$ 个采样角度 $\\theta_k = 2\\pi k/N_\\theta$（其中 $k=0,1,\\ldots,N_\\theta-1$）以及一维投影 $x_{p,k} = R_p + \\rho_p \\cos\\theta_k$（并周期性折叠到 $[0,L)$ 内），为每个标记点构建回旋相环位置 $x_{p,k}$。\n   - 使用一阶云中单元插值法在 $x_{p,k}$ 处对 $\\phi$ 进行插值。\n   - 使用一阶云中单元从以下两种表示法在网格上分配电荷：\n     (a) 回旋中心表示法，其中回旋相环使用原始的 $w_p^{\\mathrm{gc}}$ 离散地平均到网格上，以及\n     (b) 粒子空间表示法，其中映射后的粒子空间权重（待推导）从所有的 $x_{p,k}$ 分配。\n   - 计算映射前后网格上的总电荷，并返回其绝对差值。\n3. 使用无量纲的归一化单位。不需要进行物理单位转换。\n4. 使用以下五个参数集的测试套件。对于所有测试，将随机数生成器种子设置为 $42$，以确保任何随机初始化的可复现性：\n   - 测试 1（基准，均匀场）：$L=1$，$N_g=32$，$N_\\theta=8$，标记点数 $N_p=50$，所有标记点的 $\\rho_p=0.05$，系数 $\\alpha=0.3$，所有网格节点的电势 $\\phi(x)=0$。\n   - 测试 2（单模电势）：$L=1$，$N_g=64$，$N_\\theta=16$，$N_p=100$，$\\rho_p=0.04$，$\\alpha=1.0$，电势 $\\phi(x)=0.1\\sin(2\\pi x)$ 在网格节点 $x_j=j\\Delta x$ 处采样。\n   - 测试 3（零拉莫尔半径）：$L=1$，$N_g=64$，$N_\\theta=8$，$N_p=75$，$\\rho_p=0.0$，$\\alpha=0.5$，电势 $\\phi(x)=0.05\\sin(4\\pi x)+0.02\\cos(6\\pi x)$ 在网格节点 $x_j=j\\Delta x$ 处采样。\n   - 测试 4（随机电势）：$L=1$，$N_g=128$，$N_\\theta=12$，$N_p=200$，$\\rho_p=0.03$，$\\alpha=0.7$，电势 $\\phi(x)$ 是一个长度为 $N_g$ 的随机数组，由独立的标准正态分布条目乘以 $0.2$ 生成。\n   - 测试 5（高波数和最少回旋相采样）：$L=1$，$N_g=32$，$N_\\theta=1$，$N_p=5$，$\\rho_p=0.1$，$\\alpha=2.0$，电势 $\\phi(x)=0.1\\sin(8\\pi x)$ 在网格节点 $x_j=j\\Delta x$ 处采样。\n\n标记点初始化：\n- 标记点位置 $R_p$ 必须是 $[0,L)$ 内的独立均匀采样。\n- 回旋中心权重 $w_p^{\\mathrm{gc}}$ 必须是从均值为 $0$、标准差为 $0.1$ 的正态分布中进行的独立采样。\n\n数值方案细节：\n- 一阶云中单元形状函数必须将位于位置 $x$ 的标记点分配到两个最近的网格节点上，权重与到节点的线性距离成比例，并采用周期性边界条件。\n- 在位置 $x$ 处对 $\\phi$ 的插值必须使用相同的云中单元权重。\n\n最终输出要求：\n- 您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，\"[result1,result2,result3]\"）。\n- 对于五个测试中的每一个，结果是回旋中心表示法分配的总网格电荷与经过拉回映射后的粒子空间表示法分配的总网格电荷之间的绝对差值。每个结果都必须是浮点数。",
            "solution": "问题陈述已经过分析，并被认为是有效的。它在计算等离子体物理学原理，特别是回旋动理学粒子模拟（PIC）方法方面具有科学依据。问题是适定的、客观的，并包含足够的信息来推导和实现一个独特且有意义的解决方案。该问题要求推导一个从回旋中心坐标到粒子空间坐标的离散拉回变换，该变换能够守恒分配到网格上的总电荷。\n\n问题的核心在于建立一个一致的电荷分配和电势插值数值方案，以保证所需的守恒性质。我们将首先从第一性原理推导电荷守恒条件，然后概述其数值验证的算法。\n\n令 $S(x-x_j)$ 表示一阶云中单元（CIC）形状函数，它将位于位置 $x$ 的粒子的权重分配到位置为 $x_j$ 的网格节点上。对于一个长度为 $L$、具有 $N_g$ 个大小为 $\\Delta x = L/N_g$ 的网格单元的一维周期性区域，形状函数具有单位分解的性质：对于任何位置 $x$，$\\sum_{j=0}^{N_g-1} S(x-x_j) = 1$。\n\n我们被要求比较两种从一组回旋动理学标记点计算网格上电荷密度 $\\rho_j$ 的方法。每个标记点 $p$ 由其回旋中心位置 $R_p$ 和其回旋中心权重 $w_p^{\\mathrm{gc}}$ 定义。其回旋运动由一个包含 $N_\\theta$ 个离散点的环表示，$x_{p,k} = R_p + \\rho_p \\cos\\theta_k$，其中 $k=0, \\dots, N_\\theta-1$ 且 $\\theta_k = 2\\pi k / N_\\theta$。所有位置都受 $[0, L)$ 上的周期性边界条件约束。\n\n**方法(a)：回旋中心表示法**\n在此表示法中，每个标记点的电荷被“涂抹”在其回旋环上。粒子 $p$ 对网格节点 $j$ 的电荷密度贡献是形状函数的离散回旋相平均，并按回旋中心权重进行缩放。将回旋相平均离散化为对 $N_\\theta$ 个环上点的求和，我们得到：\n$$\n\\rho_{p,j}^{\\mathrm{gc}} = w_p^{\\mathrm{gc}} \\left( \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} S(x_{p,k} - x_j) \\right)\n$$\n这在数值上通过在 $N_\\theta$ 个环上点 $x_{p,k}$ 的每一个点上分配 $w_p^{\\mathrm{gc}}/N_\\theta$ 的权重来实现。\n\n此表示法在网格上的总电荷 $Q^{\\mathrm{gc}}$ 是所有网格节点上电荷的总和：\n$$\nQ^{\\mathrm{gc}} = \\sum_{j=0}^{N_g-1} \\sum_{p} \\rho_{p,j}^{\\mathrm{gc}} = \\sum_p w_p^{\\mathrm{gc}} \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\left( \\sum_{j=0}^{N_g-1} S(x_{p,k} - x_j) \\right)\n$$\n利用单位分解性质 $\\sum_j S(x_{p,k} - x_j) = 1$，表达式简化为：\n$$\nQ^{\\mathrm{gc}} = \\sum_p w_p^{\\mathrm{gc}} \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} (1) = \\sum_p w_p^{\\mathrm{gc}}\n$$\n网格上的总电荷就是回旋中心权重的总和。\n\n**方法(b)：粒子空间表示法（拉回）**\n拉回变换将回旋中心权重 $w_p^{\\mathrm{gc}}$ 映射到一组粒子空间权重 $w_{p,k}^{\\mathrm{ps}}$，每个权重对应离散回旋环上的一个点。在delta-f回旋动理学中，这种变换的一般形式是：\n$$\nw_{p,k}^{\\mathrm{ps}} = w_p^{\\mathrm{gc}} - \\alpha \\left( \\phi(x_{p,k}) - \\langle \\phi \\rangle_{R_p} \\right)\n$$\n这里，$\\alpha$ 是一个给定的系数，$\\phi(x_{p,k})$ 是环上点 $x_{p,k}$ 处的静电势，而 $\\langle \\phi \\rangle_{R_p}$ 是粒子 $p$ 的离散回旋相平均电势。我们的任务是定义 $\\langle \\phi \\rangle_{R_p}$ 以使总电荷守恒。\n\n在此表示法中，分配到节点 $j$ 的来自粒子 $p$ 的电荷，源于在其相应位置 $x_{p,k}$ 分配粒子空间权重 $w_{p,k}^{\\mathrm{ps}}$。为保持与方法(a)一致的归一化，我们在每个点 $x_{p,k}$ 分配一个 $w_{p,k}^{\\mathrm{ps}}/N_\\theta$ 的权重：\n$$\n\\rho_{p,j}^{\\mathrm{ps}} = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} w_{p,k}^{\\mathrm{ps}} S(x_{p,k} - x_j)\n$$\n此表示法在网格上的总电荷 $Q^{\\mathrm{ps}}$ 为：\n$$\nQ^{\\mathrm{ps}} = \\sum_{j=0}^{N_g-1} \\sum_p \\rho_{p,j}^{\\mathrm{ps}} = \\sum_p \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} w_{p,k}^{\\mathrm{ps}} \\left( \\sum_{j=0}^{N_g-1} S(x_{p,k} - x_j) \\right)\n$$\n再次利用单位分解性质，这简化为：\n$$\nQ^{\\mathrm{ps}} = \\sum_p \\left( \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} w_{p,k}^{\\mathrm{ps}} \\right)\n$$\n这表明，分配到网格上的总电荷是所有粒子各自粒子空间权重总和的累加。\n\n**守恒规则的推导**\n我们要求总电荷在拉回变换下保持守恒，即 $Q^{\\mathrm{gc}} = Q^{\\mathrm{ps}}$。为使此式对任意标记点分布均成立，守恒必须在每个粒子的基础上成立：粒子 $p$ 分配的总电荷在两种表示法中必须相同。根据上述表达式，这意味着：\n$$\nw_p^{\\mathrm{gc}} = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} w_{p,k}^{\\mathrm{ps}}\n$$\n代入 $w_{p,k}^{\\mathrm{ps}}$ 的表达式：\n$$\nw_p^{\\mathrm{gc}} = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\left( w_p^{\\mathrm{gc}} - \\alpha \\left( \\phi(x_{p,k}) - \\langle \\phi \\rangle_{R_p} \\right) \\right)\n$$\n$$\nw_p^{\\mathrm{gc}} = w_p^{\\mathrm{gc}} - \\frac{\\alpha}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\left( \\phi(x_{p,k}) - \\langle \\phi \\rangle_{R_p} \\right)\n$$\n为使此方程成立，求和项必须为零：\n$$\n\\sum_{k=0}^{N_\\theta-1} \\left( \\phi(x_{p,k}) - \\langle \\phi \\rangle_{R_p} \\right) = 0\n$$\n$$\n\\sum_{k=0}^{N_\\theta-1} \\phi(x_{p,k}) = \\sum_{k=0}^{N_\\theta-1} \\langle \\phi \\rangle_{R_p} = N_\\theta \\langle \\phi \\rangle_{R_p}\n$$\n这得出了离散回旋相平均电势所需的定义：\n$$\n\\langle \\phi \\rangle_{R_p} = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\phi(x_{p,k})\n$$\n这是回旋环上离散点处电势值的算术平均值。\n\n为了完成该方案，我们必须指定如何计算 $\\phi(x_{p,k})$，因为电势 $\\phi$ 仅在网格节点 $x_j$ 上有定义。根据问题要求，我们使用一阶CIC插值，这与分配方案是一致的：\n$$\n\\phi(x) = \\sum_{j=0}^{N_g-1} \\phi_j S(x-x_j)\n$$\n其中 $\\phi_j = \\phi(x_j)$ 是电势的网格值。\n因此，$\\phi(x_{p,k}) = \\sum_{j=0}^{N_g-1} \\phi_j S(x_{p,k}-x_j)$。\n\n**推导的离散拉回方案总结：**\n1.  对于每个粒子 $p$，生成其回旋环位置 $\\{x_{p,k}\\}$。\n2.  对于每个环上点 $x_{p,k}$，使用CIC插值从网格值 $\\{\\phi_j\\}$ 计算插值电势 $\\phi(x_{p,k})$。\n3.  计算离散回旋平均电势 $\\langle \\phi \\rangle_{R_p}$，作为 $\\phi(x_{p,k})$ 值的算术平均值。\n4.  计算粒子空间权重 $w_{p,k}^{\\mathrm{ps}} = w_p^{\\mathrm{gc}} - \\alpha(\\phi(x_{p,k}) - \\langle \\phi \\rangle_{R_p})$。\n5.  为计算回旋中心表示法的电荷密度，使用CIC方案在每个位置 $x_{p,k}$ 分配 $w_p^{\\mathrm{gc}}/N_\\theta$ 的权重。\n6.  为计算粒子空间表示法的电荷密度，使用CIC方案在每个位置 $x_{p,k}$ 分配 $w_{p,k}^{\\mathrm{ps}}/N_\\theta$ 的权重。\n\n通过这种构造，两种方案中所有分配权重的总和在数学上是完全相同的，确保了网格上的总电荷在浮点精度范围内是守恒的。数值实现将通过计算两种方法得到的总网格电荷的绝对差来验证这一点。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements a charge-conserving pullback scheme for a 1D\n    gyrokinetic PIC model, then runs a suite of tests to verify conservation.\n    \"\"\"\n\n    def deposit(grid, pos, weight, L, Ng):\n        \"\"\"\n        Deposits a particle's weight onto the grid using a first-order\n        Cloud-In-Cell (CIC) scheme with periodic boundary conditions.\n        \"\"\"\n        dx = L / Ng\n        norm_pos = pos / dx\n        j_low = int(norm_pos)\n        h = norm_pos - j_low\n        \n        j_low_idx = j_low % Ng\n        j_high_idx = (j_low + 1) % Ng\n        \n        grid[j_low_idx] += weight * (1.0 - h)\n        grid[j_high_idx] += weight * h\n\n    def interpolate(pos, grid, L, Ng):\n        \"\"\"\n        Interpolates a grid quantity to a particle's position using a\n        first-order Cloud-In-Cell (CIC) scheme with periodic boundaries.\n        \"\"\"\n        dx = L / Ng\n        norm_pos = pos / dx\n        j_low = int(norm_pos)\n        h = norm_pos - j_low\n        \n        j_low_idx = j_low % Ng\n        j_high_idx = (j_low + 1) % Ng\n        \n        return grid[j_low_idx] * (1.0 - h) + grid[j_high_idx] * h\n\n    def run_test(L, Ng, Ntheta, Np, rho_val, alpha, phi_func):\n        \"\"\"\n        Executes a single test case for the pullback scheme verification.\n        \"\"\"\n        # --- Setup ---\n        dx = L / Ng\n        grid_nodes = np.linspace(0, L, Ng, endpoint=False)\n        phi_grid = phi_func(grid_nodes)\n        \n        rho_gc_grid = np.zeros(Ng)\n        rho_ps_grid = np.zeros(Ng)\n        \n        # --- Marker Initialization ---\n        # Set seed within the test runner for reproducibility of each test\n        # even if run in different orders or contexts. The problem states a\n        # global seed, but localizing it ensures test independence.\n        np.random.seed(42)\n        gyrocenter_positions = np.random.uniform(0, L, Np)\n        gyrocenter_weights = np.random.normal(0, 0.1, Np)\n        larmor_radii = np.full(Np, rho_val)\n\n        # --- Main Loop over Particles ---\n        for p in range(Np):\n            Rp = gyrocenter_positions[p]\n            w_gc = gyrocenter_weights[p]\n            rho_p = larmor_radii[p]\n\n            # Generate gyro-ring positions\n            thetas = 2 * np.pi * np.arange(Ntheta) / Ntheta\n            # Ensure periodic wrapping into [0, L)\n            x_pk = (Rp + rho_p * np.cos(thetas)) % L\n\n            # --- Method (a): Gyrocenter Deposition ---\n            for k in range(Ntheta):\n                deposit(rho_gc_grid, x_pk[k], w_gc / Ntheta, L, Ng)\n\n            # --- Method (b): Particle-Space Pullback and Deposition ---\n            # 1. Interpolate potential to ring points\n            phi_at_ring_points = np.zeros(Ntheta)\n            for k in range(Ntheta):\n                phi_at_ring_points[k] = interpolate(x_pk[k], phi_grid, L, Ng)\n            \n            # 2. Compute discrete gyro-averaged potential\n            gyro_avg_phi = np.mean(phi_at_ring_points)\n\n            # 3. Compute particle-space weights and deposit\n            for k in range(Ntheta):\n                # Calculate particle-space weight for this segment of the ring\n                w_ps_k = w_gc - alpha * (phi_at_ring_points[k] - gyro_avg_phi)\n                # Deposit this weight\n                deposit(rho_ps_grid, x_pk[k], w_ps_k / Ntheta, L, Ng)\n        \n        # --- Calculate Total Charge and Difference ---\n        total_charge_gc = np.sum(rho_gc_grid)\n        total_charge_ps = np.sum(rho_ps_grid)\n        \n        return abs(total_charge_gc - total_charge_ps)\n\n    # --- Test Suite Definition ---\n    test_cases = [\n        # Test 1: baseline, uniform field\n        (1.0, 32, 8, 50, 0.05, 0.3, lambda x: np.zeros_like(x)),\n        # Test 2: single-mode potential\n        (1.0, 64, 16, 100, 0.04, 1.0, lambda x: 0.1 * np.sin(2 * np.pi * x)),\n        # Test 3: zero Larmor radius\n        (1.0, 64, 8, 75, 0.0, 0.5, lambda x: 0.05 * np.sin(4 * np.pi * x) + 0.02 * np.cos(6 * np.pi * x)),\n        # Test 4: random potential\n        (1.0, 128, 12, 200, 0.03, 0.7, \n         lambda x: 0.2 * np.random.RandomState(42).standard_normal(len(x))),\n        # Test 5: high wavenumber and minimal gyrophase sampling\n        (1.0, 32, 1, 5, 0.1, 2.0, lambda x: 0.1 * np.sin(8 * np.pi * x)),\n    ]\n\n    results = []\n    for case in test_cases:\n        L, Ng, Ntheta, Np, rho_val, alpha, phi_func = case\n        result = run_test(L, Ng, Ntheta, Np, rho_val, alpha, phi_func)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}