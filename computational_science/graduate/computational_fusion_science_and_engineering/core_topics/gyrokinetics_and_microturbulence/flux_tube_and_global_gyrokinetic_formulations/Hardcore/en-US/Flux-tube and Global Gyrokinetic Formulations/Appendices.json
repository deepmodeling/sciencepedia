{
    "hands_on_practices": [
        {
            "introduction": "To simulate plasma turbulence within a flux-tube, we must first characterize the magnetic geometry that confines the plasma. This exercise provides foundational practice by starting from the global Grad-Shafranov equation, which describes magnetohydrodynamic (MHD) equilibrium, and deriving the key local geometric quantities for a simplified tokamak. By calculating parameters like the safety factor $q$ and the magnetic field variation, you will perform the essential first step of translating a global equilibrium into the local inputs required by a flux-tube gyrokinetic model .",
            "id": "3981627",
            "problem": "In axisymmetric, static, ideal Magnetohydrodynamics (MHD), equilibria in a tokamak satisfy the Grad–Shafranov equation for the poloidal flux function $\\psi(R,Z)$,\n$$\n\\Delta^{*}\\psi \\equiv R \\frac{\\partial}{\\partial R}\\left(\\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}\\right) + \\frac{\\partial^{2}\\psi}{\\partial Z^{2}} = - \\mu_{0} R^{2} \\frac{d p}{d \\psi} - F(\\psi)\\,\\frac{d F}{d \\psi},\n$$\nwhere $R$ is the cylindrical major-radius coordinate, $Z$ is the vertical coordinate, $\\mu_{0}$ is the vacuum permeability, $p(\\psi)$ is the scalar pressure, and $F(\\psi) \\equiv R B_{\\phi}$ with $B_{\\phi}$ the toroidal magnetic field.\n\nConstruct a simple large-aspect-ratio, concentric-circular tokamak equilibrium by prescribing a linear pressure profile $p(\\psi) = p_{a} - \\alpha \\psi$ with constant $\\alpha > 0$ and a constant toroidal field function $F^{2}(\\psi) = F_{0}^{2}$, where $p_{a}$ and $F_{0}$ are constants. Assume small inverse aspect ratio $\\epsilon \\equiv r/R_{0} \\ll 1$, where $r$ is the minor radius labeling the concentric flux surfaces and $R_{0}$ is the major radius at the magnetic axis, and retain only leading-order terms in $\\epsilon$. Use the coordinate relations $R(\\theta) = R_{0} + r\\cos\\theta$ and $Z(\\theta) = r\\sin\\theta$ for the flux surface with poloidal angle $\\theta$. Treat $\\psi$ as a function of $r$ to leading order and impose regularity at $r=0$.\n\nStarting from the Grad–Shafranov equation, derive the leading-order $\\psi(r)$ consistent with the prescribed $p(\\psi)$ and $F(\\psi)$. Then, using the magnetic-field representation $\\mathbf{B} = \\nabla\\psi \\times \\nabla\\phi + F(\\psi)\\,\\nabla\\phi$, where $\\phi$ is the toroidal angle, derive the safety factor $q(\\psi)$ from its first-principles definition as the field-line helicity, $q = \\frac{1}{2\\pi}\\oint \\frac{d\\phi}{d\\theta}\\,d\\theta$, with $d\\phi/d\\theta = \\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}$. In the same ordering, identify the leading-order expressions for the geometric factors most relevant to flux-tube gyrokinetics, namely $|\\nabla\\psi|$ on a given surface and the magnetic-field strength variation $B(\\theta)$ along that surface.\n\nProvide the final answer as a single closed-form analytic expression for $q(\\psi)$ in terms of $\\mu_{0}$, $\\alpha$, $F_{0}$, and $R_{0}$. The safety factor is dimensionless; no units are required in the final answer. Do not provide intermediate results in the final answer.",
            "solution": "The user wants me to solve a problem in computational fusion science and engineering, specifically related to tokamak equilibria and their properties relevant to gyrokinetics.\n\nHere's my plan:\n1.  **Validate the Problem**: I'll go through my mandatory validation checklist.\n    *   **Step 1: Extract Givens**: I will list all the equations, definitions, and assumptions provided in the problem statement.\n    *   **Step 2: Validate**: I will check for scientific grounding, well-posedness, objectivity, and other criteria. The problem seems to be a standard textbook exercise in MHD equilibrium theory, so it should be valid. It asks for a derivation based on the Grad-Shafranov equation under specific assumptions (large aspect ratio, linear pressure, constant toroidal field function).\n    *   **Step 3: Verdict**: Assuming it's valid, I will proceed to the solution.\n\n2.  **Solve the Problem**:\n    *   **Part 1: Solve the Grad–Shafranov equation for $\\psi(r)$**.\n        *   The Grad–Shafranov equation is given: $\\Delta^{*}\\psi = - \\mu_{0} R^{2} \\frac{d p}{d \\psi} - F(\\psi)\\,\\frac{d F}{d \\psi}$.\n        *   The prescribed profiles are $p(\\psi) = p_{a} - \\alpha \\psi$ and $F^{2}(\\psi) = F_{0}^{2}$.\n        *   This means $\\frac{d p}{d \\psi} = -\\alpha$ and $F\\frac{dF}{d\\psi} = \\frac{1}{2}\\frac{d(F^2)}{d\\psi} = \\frac{1}{2}\\frac{d(F_0^2)}{d\\psi} = 0$.\n        *   The Grad–Shafranov equation simplifies to $\\Delta^{*}\\psi = \\mu_{0} R^{2} \\alpha$.\n        *   I need to express the operator $\\Delta^{*}$ in the $(r, \\theta)$ coordinates and apply the large-aspect-ratio approximation.\n        *   The coordinates are $R = R_0 + r \\cos\\theta$ and $Z = r \\sin\\theta$.\n        *   The operator is $\\Delta^{*}\\psi = R \\frac{\\partial}{\\partial R}\\left(\\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}\\right) + \\frac{\\partial^{2}\\psi}{\\partial Z^{2}}$.\n        *   In cylindrical coordinates $(R, \\phi, Z)$, the Laplacian is $\\nabla^2 = \\frac{1}{R}\\frac{\\partial}{\\partial R}(R\\frac{\\partial}{\\partial R}) + \\frac{1}{R^2}\\frac{\\partial^2}{\\partial \\phi^2} + \\frac{\\partial^2}{\\partial Z^2}$.\n        *   The operator can be rewritten. $\\Delta^{*}\\psi = \\nabla^2\\psi - \\frac{1}{R}\\frac{\\partial\\psi}{\\partial R} - \\frac{1}{R^2}\\frac{\\partial^2\\psi}{\\partial\\phi^2}$. Since we have axisymmetry, $\\frac{\\partial}{\\partial\\phi} = 0$, so $\\Delta^{*}\\psi = \\nabla^2\\psi - \\frac{1}{R}\\frac{\\partial\\psi}{\\partial R}$.\n        *   The problem states to assume $\\psi = \\psi(r)$ to leading order. I need to transform the Laplacian to toroidal coordinates $(r, \\theta, \\phi)$.\n        *   The Jacobian of the transformation $(R, Z) \\to (r, \\theta)$ is needed.\n        *   $R = R_0 + r\\cos\\theta$, $Z = r\\sin\\theta$.\n        *   $\\frac{\\partial R}{\\partial r} = \\cos\\theta$, $\\frac{\\partial R}{\\partial \\theta} = -r\\sin\\theta$.\n        *   $\\frac{\\partial Z}{\\partial r} = \\sin\\theta$, $\\frac{\\partial Z}{\\partial \\theta} = r\\cos\\theta$.\n        *   The inverse relations are needed to express $\\frac{\\partial}{\\partial R}$ and $\\frac{\\partial}{\\partial Z}$.\n        *   Or, I can use the standard expression for the Laplacian in toroidal coordinates. For $\\psi(r)$, $\\frac{\\partial \\psi}{\\partial \\theta} = 0$. The Laplacian is $\\nabla^2\\psi = \\frac{1}{r(R_0+r\\cos\\theta)}\\frac{\\partial}{\\partial r}\\left(r(R_0+r\\cos\\theta)\\frac{\\partial\\psi}{\\partial r}\\right)$.\n        *   Let's do the transformation manually to be sure.\n            $\\frac{\\partial}{\\partial r} = \\frac{\\partial R}{\\partial r}\\frac{\\partial}{\\partial R} + \\frac{\\partial Z}{\\partial r}\\frac{\\partial}{\\partial Z} = \\cos\\theta \\frac{\\partial}{\\partial R} + \\sin\\theta \\frac{\\partial}{\\partial Z}$.\n            $\\frac{\\partial}{\\partial \\theta} = \\frac{\\partial R}{\\partial \\theta}\\frac{\\partial}{\\partial R} + \\frac{\\partial Z}{\\partial \\theta}\\frac{\\partial}{\\partial Z} = -r\\sin\\theta \\frac{\\partial}{\\partial R} + r\\cos\\theta \\frac{\\partial}{\\partial Z}$.\n            Solving for $\\frac{\\partial}{\\partial R}$ and $\\frac{\\partial}{\\partial Z}$:\n            $\\frac{\\partial}{\\partial R} = \\cos\\theta \\frac{\\partial}{\\partial r} - \\frac{\\sin\\theta}{r} \\frac{\\partial}{\\partial \\theta}$.\n            $\\frac{\\partial}{\\partial Z} = \\sin\\theta \\frac{\\partial}{\\partial r} + \\frac{\\cos\\theta}{r} \\frac{\\partial}{\\partial \\theta}$.\n        *   Now apply this to $\\Delta^{*}\\psi(r)$:\n            $\\frac{\\partial \\psi}{\\partial r}$ is the only non-zero derivative. Let's denote it $\\psi'$.\n            $\\frac{\\partial\\psi}{\\partial R} = \\cos\\theta \\psi'(r)$.\n            $\\frac{\\partial\\psi}{\\partial Z} = \\sin\\theta \\psi'(r)$.\n            $\\frac{\\partial^2\\psi}{\\partial Z^2} = \\frac{\\partial}{\\partial Z}(\\sin\\theta \\psi') = (\\sin\\theta \\frac{\\partial}{\\partial r} + \\frac{\\cos\\theta}{r} \\frac{\\partial}{\\partial \\theta})(\\sin\\theta \\psi')$.\n            $= \\sin\\theta \\frac{\\partial}{\\partial r}(\\sin\\theta \\psi') + \\frac{\\cos\\theta}{r} \\frac{\\partial}{\\partial \\theta}(\\sin\\theta \\psi') = \\sin^2\\theta \\psi'' + \\frac{\\cos\\theta}{r}(\\cos\\theta \\psi') = \\sin^2\\theta \\psi'' + \\frac{\\cos^2\\theta}{r}\\psi'$.\n            $R \\frac{\\partial}{\\partial R}(\\frac{1}{R}\\frac{\\partial\\psi}{\\partial R}) = R (\\cos\\theta \\frac{\\partial}{\\partial r} - \\frac{\\sin\\theta}{r} \\frac{\\partial}{\\partial \\theta}) (\\frac{\\cos\\theta \\psi'}{R})$.\n            $= R (\\cos\\theta \\frac{\\partial}{\\partial r}(\\frac{\\cos\\theta \\psi'}{R}) - \\frac{\\sin\\theta}{r} \\frac{\\partial}{\\partial \\theta}(\\frac{\\cos\\theta \\psi'}{R}))$.\n            The $\\frac{\\partial}{\\partial r}$ term: $\\frac{\\partial}{\\partial r}(\\frac{\\cos\\theta \\psi'}{R_0+r\\cos\\theta}) = \\frac{\\cos\\theta \\psi''}{R} - \\frac{\\cos\\theta \\psi'}{R^2}\\frac{\\partial R}{\\partial r} = \\frac{\\cos\\theta \\psi''}{R} - \\frac{\\cos^2\\theta \\psi'}{R^2}$.\n            The $\\frac{\\partial}{\\partial \\theta}$ term: $\\frac{\\partial}{\\partial \\theta}(\\frac{\\cos\\theta \\psi'}{R_0+r\\cos\\theta}) = \\frac{-\\sin\\theta \\psi'}{R} - \\frac{\\cos\\theta\\psi'}{R^2}(-r\\sin\\theta) = \\frac{-\\sin\\theta \\psi'}{R} + \\frac{r\\sin\\theta\\cos\\theta\\psi'}{R^2}$.\n            Putting it together for the first term of $\\Delta^*$:\n            $R (\\cos\\theta(\\frac{\\cos\\theta \\psi''}{R} - \\frac{\\cos^2\\theta \\psi'}{R^2}) - \\frac{\\sin\\theta}{r}(\\frac{-\\sin\\theta \\psi'}{R} + \\frac{r\\sin\\theta\\cos\\theta\\psi'}{R^2}))$.\n            $= \\cos^2\\theta \\psi'' - \\frac{\\cos^3\\theta \\psi'}{R} + \\frac{\\sin^2\\theta \\psi'}{r} - \\frac{\\sin^2\\theta\\cos\\theta\\psi'}{R}$.\n            $= \\cos^2\\theta \\psi'' + \\frac{\\sin^2\\theta}{r}\\psi' - \\frac{\\cos\\theta( \\cos^2\\theta + \\sin^2\\theta)\\psi'}{R} = \\cos^2\\theta \\psi'' + \\frac{\\sin^2\\theta}{r}\\psi' - \\frac{\\cos\\theta}{R}\\psi'$.\n            So, $\\Delta^*\\psi = (\\cos^2\\theta \\psi'' + \\frac{\\sin^2\\theta}{r}\\psi' - \\frac{\\cos\\theta}{R}\\psi') + (\\sin^2\\theta \\psi'' + \\frac{\\cos^2\\theta}{r}\\psi')$.\n            $\\Delta^*\\psi = (\\cos^2\\theta + \\sin^2\\theta) \\psi'' + (\\frac{\\sin^2\\theta}{r} + \\frac{\\cos^2\\theta}{r})\\psi' - \\frac{\\cos\\theta}{R}\\psi'$.\n            $\\Delta^*\\psi = \\psi'' + \\frac{1}{r}\\psi' - \\frac{\\cos\\theta}{R_0+r\\cos\\theta}\\psi' = \\frac{1}{r}\\frac{d}{dr}(r\\psi') - \\frac{\\cos\\theta}{R_0+r\\cos\\theta}\\psi'$.\n        *   This is the full expression for $\\psi(r)$. Now I apply the large aspect ratio approximation $\\epsilon = r/R_0 \\ll 1$.\n        *   $R = R_0(1 + \\frac{r}{R_0}\\cos\\theta) \\approx R_0$. So $\\frac{\\cos\\theta}{R_0+r\\cos\\theta} \\approx \\frac{\\cos\\theta}{R_0}$.\n        *   The Grad-Shafranov eqn becomes: $\\frac{1}{r}\\frac{d}{dr}(r\\frac{d\\psi}{dr}) - \\frac{\\cos\\theta}{R_0}\\frac{d\\psi}{dr} \\approx \\mu_0 (R_0+r\\cos\\theta)^2 \\alpha \\approx \\mu_0 R_0^2 \\alpha (1+2\\frac{r}{R_0}\\cos\\theta)$.\n        *   This equation has $\\theta$ dependence. But the problem states to treat $\\psi$ as a function of $r$ only to leading order. This means I must average over $\\theta$. Or perhaps I should have taken the leading order approximation earlier.\n        *   Let's check the problem statement again: \"treat $\\psi$ as a function of $r$ to leading order\". This implies that $\\psi(r,\\theta) = \\psi_0(r) + \\psi_1(r, \\theta)$ where $\\psi_1$ is small.\n        *   Let's expand the terms in the GS equation in $\\epsilon$.\n        *   $\\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}$ and $\\frac{\\partial^2\\psi}{\\partial Z^2}$.\n        *   $\\psi=\\psi(r)$. $\\nabla\\psi = \\frac{d\\psi}{dr}\\nabla r$. $r = \\sqrt{(R-R_0)^2 + Z^2}$.\n        *   $\\nabla r = \\frac{(R-R_0)\\hat{R} + Z\\hat{Z}}{\\sqrt{(R-R_0)^2+Z^2}} = \\frac{r\\cos\\theta \\hat{R} + r\\sin\\theta\\hat{Z}}{r} = \\cos\\theta\\hat{R} + \\sin\\theta\\hat{Z}$.\n        *   $\\frac{\\partial\\psi}{\\partial R} = \\frac{d\\psi}{dr}\\frac{\\partial r}{\\partial R} = \\frac{d\\psi}{dr} \\frac{R-R_0}{r} = \\frac{d\\psi}{dr}\\cos\\theta$.\n        *   $\\frac{\\partial\\psi}{\\partial Z} = \\frac{d\\psi}{dr}\\frac{\\partial r}{\\partial Z} = \\frac{d\\psi}{dr} \\frac{Z}{r} = \\frac{d\\psi}{dr}\\sin\\theta$.\n        *   This is what I used before. Let's re-evaluate the expansion.\n        *   $R = R_0(1+\\epsilon\\cos\\theta)$. The right hand side (RHS) is $\\mu_0 R^2 \\alpha \\approx \\mu_0 R_0^2 \\alpha(1+2\\epsilon\\cos\\theta)$.\n        *   The left hand side (LHS) is $\\Delta^*\\psi$. I had $\\Delta^*\\psi = \\psi'' + \\frac{1}{r}\\psi' - \\frac{\\cos\\theta}{R}\\psi'$.\n        *   To leading order in $\\epsilon$, we neglect $\\epsilon$ terms. $R \\approx R_0$.\n        *   LHS $\\approx \\psi'' + \\frac{1}{r}\\psi'$. RHS $\\approx \\mu_0 \\alpha R_0^2$.\n        *   The leading order GS equation is $\\frac{1}{r}\\frac{d}{dr}(r\\frac{d\\psi}{dr}) = \\mu_0 \\alpha R_0^2$. This is a much simpler approach and probably what's intended.\n        *   Let's integrate this ODE.\n        *   $r\\frac{d\\psi}{dr} = \\int \\mu_0 \\alpha R_0^2 r dr = \\frac{1}{2}\\mu_0 \\alpha R_0^2 r^2 + C_1$.\n        *   $\\frac{d\\psi}{dr} = \\frac{1}{2}\\mu_0 \\alpha R_0^2 r + \\frac{C_1}{r}$.\n        *   The problem states \"impose regularity at $r=0$\". This means the solution must be well-behaved at the origin.\n        *   $\\frac{d\\psi}{dr}$ must not diverge at $r=0$. This requires $C_1=0$.\n        *   So $\\frac{d\\psi}{dr} = \\frac{1}{2}\\mu_0 \\alpha R_0^2 r$.\n        *   Integrate again: $\\psi(r) = \\int \\frac{1}{2}\\mu_0 \\alpha R_0^2 r dr = \\frac{1}{4}\\mu_0 \\alpha R_0^2 r^2 + C_2$.\n        *   We can set the constant $C_2=0$ by defining $\\psi=0$ at the magnetic axis ($r=0$).\n        *   So, $\\psi(r) = \\frac{1}{4}\\mu_0 \\alpha R_0^2 r^2$.\n        *   This gives the leading order $\\psi(r)$.\n\n    *   **Part 2: Derive the safety factor $q(\\psi)$**.\n        *   Definition: $q = \\frac{1}{2\\pi}\\oint \\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta} d\\theta$.\n        *   Magnetic field: $\\mathbf{B} = \\nabla\\psi \\times \\nabla\\phi + F(\\psi)\\nabla\\phi$.\n        *   The gradient of the toroidal angle $\\phi$ in cylindrical coordinates is $\\nabla\\phi = \\frac{1}{R}\\hat{\\phi}$.\n        *   So $\\mathbf{B} = \\frac{1}{R}\\nabla\\psi \\times \\hat{\\phi} + \\frac{F}{R}\\hat{\\phi}$.\n        *   $\\nabla\\psi = \\frac{\\partial\\psi}{\\partial R}\\hat{R} + \\frac{\\partial\\psi}{\\partial Z}\\hat{Z}$.\n        *   $\\hat{R}\\times\\hat{\\phi} = \\hat{Z}$, $\\hat{Z}\\times\\hat{\\phi} = -\\hat{R}$.\n        *   So $\\nabla\\psi \\times \\hat{\\phi} = \\frac{\\partial\\psi}{\\partial R}\\hat{Z} - \\frac{\\partial\\psi}{\\partial Z}\\hat{R}$.\n        *   $\\mathbf{B} = \\frac{1}{R}(-\\frac{\\partial\\psi}{\\partial Z}\\hat{R} + \\frac{\\partial\\psi}{\\partial R}\\hat{Z}) + \\frac{F}{R}\\hat{\\phi} = B_R\\hat{R} + B_Z\\hat{Z} + B_\\phi\\hat{\\phi}$.\n        *   This is the poloidal field $\\mathbf{B}_p = \\frac{1}{R}\\nabla\\psi \\times \\hat{\\phi}$ and the toroidal field $\\mathbf{B}_T = \\frac{F}{R}\\hat{\\phi}$.\n        *   Now for the dot products in the $q$ formula.\n        *   $\\mathbf{B}\\cdot\\nabla\\phi = (\\mathbf{B}_p + \\mathbf{B}_T) \\cdot \\nabla\\phi = \\mathbf{B}_T \\cdot \\nabla\\phi = (F\\nabla\\phi)\\cdot\\nabla\\phi = F (\\nabla\\phi\\cdot\\nabla\\phi) = F|\\nabla\\phi|^2$.\n        *   In cylindrical coordinates, $\\nabla\\phi = \\frac{1}{R}\\hat{\\phi}$. So $|\\nabla\\phi|^2 = \\frac{1}{R^2}$.\n        *   $\\mathbf{B}\\cdot\\nabla\\phi = F/R^2$. This is also correct.\n        *   $\\mathbf{B}\\cdot\\nabla\\theta$. We need $\\nabla\\theta$.\n        *   $R = R_0+r\\cos\\theta \\implies \\cos\\theta = (R-R_0)/r$.\n        *   $Z = r\\sin\\theta \\implies \\sin\\theta = Z/r$.\n        *   $\\theta = \\arctan(Z/(R-R_0))$.\n        *   $\\nabla\\theta = \\frac{\\partial\\theta}{\\partial R}\\hat{R} + \\frac{\\partial\\theta}{\\partial Z}\\hat{Z}$.\n        *   $\\frac{\\partial\\theta}{\\partial R} = \\frac{1}{1+(Z/(R-R_0))^2} \\frac{-Z}{(R-R_0)^2} = \\frac{(R-R_0)^2}{(R-R_0)^2+Z^2} \\frac{-Z}{(R-R_0)^2} = \\frac{-Z}{r^2} = -\\frac{r\\sin\\theta}{r^2} = -\\frac{\\sin\\theta}{r}$.\n        *   $\\frac{\\partial\\theta}{\\partial Z} = \\frac{1}{1+(Z/(R-R_0))^2} \\frac{1}{R-R_0} = \\frac{(R-R_0)^2}{r^2} \\frac{1}{R-R_0} = \\frac{R-R_0}{r^2} = \\frac{r\\cos\\theta}{r^2} = \\frac{\\cos\\theta}{r}$.\n        *   So $\\nabla\\theta = \\frac{1}{r}(-\\sin\\theta \\hat{R} + \\cos\\theta \\hat{Z})$.\n        *   $\\mathbf{B}\\cdot\\nabla\\theta = (B_R\\hat{R} + B_Z\\hat{Z})\\cdot\\nabla\\theta = \\frac{1}{R}(-\\frac{\\partial\\psi}{\\partial Z}\\hat{R} + \\frac{\\partial\\psi}{\\partial R}\\hat{Z})\\cdot \\frac{1}{r}(-\\sin\\theta \\hat{R} + \\cos\\theta \\hat{Z})$.\n        *   $= \\frac{1}{Rr}(\\frac{\\partial\\psi}{\\partial Z}\\sin\\theta + \\frac{\\partial\\psi}{\\partial R}\\cos\\theta)$.\n        *   Using $\\frac{\\partial\\psi}{\\partial R} = \\frac{d\\psi}{dr}\\cos\\theta$ and $\\frac{\\partial\\psi}{\\partial Z} = \\frac{d\\psi}{dr}\\sin\\theta$ for $\\psi=\\psi(r)$.\n        *   $\\mathbf{B}\\cdot\\nabla\\theta = \\frac{1}{Rr}((\\frac{d\\psi}{dr}\\sin\\theta)\\sin\\theta + (\\frac{d\\psi}{dr}\\cos\\theta)\\cos\\theta) = \\frac{1}{Rr}\\frac{d\\psi}{dr}(\\sin^2\\theta+\\cos^2\\theta) = \\frac{1}{Rr}\\frac{d\\psi}{dr}$.\n        *   Now assemble the integrand for $q$:\n        *   $q = \\frac{1}{2\\pi}\\oint \\frac{F/R^2}{(1/Rr)(d\\psi/dr)} d\\theta = \\frac{1}{2\\pi}\\oint \\frac{F r}{R(d\\psi/dr)} d\\theta$.\n        *   This confirms my previous expression for the integrand.\n        *   Substitute $R=R_0+r\\cos\\theta$ and expand to the correct order.\n        *   $F=F_0$ (constant). $d\\psi/dr$ is function of $r$ only.\n        *   $q(r) = \\frac{F_0 r}{d\\psi/dr} \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{d\\theta}{R_0+r\\cos\\theta}$.\n        *   The integral is $\\int_0^{2\\pi} \\frac{d\\theta}{a+b\\cos\\theta} = \\frac{2\\pi}{\\sqrt{a^2-b^2}}$ for $a>|b|$. Here $a=R_0, b=r$.\n        *   So $\\frac{1}{2\\pi}\\int_0^{2\\pi} \\frac{d\\theta}{R_0+r\\cos\\theta} = \\frac{1}{2\\pi} \\frac{2\\pi}{\\sqrt{R_0^2-r^2}} = \\frac{1}{R_0\\sqrt{1-r^2/R_0^2}}$.\n        *   The problem asks to retain only leading-order terms in $\\epsilon=r/R_0$.\n        *   So $\\frac{1}{R_0\\sqrt{1-\\epsilon^2}} \\approx \\frac{1}{R_0}(1+\\frac{1}{2}\\epsilon^2) \\approx \\frac{1}{R_0}$ to leading order.\n        *   This brings me back to $q(r) \\approx \\frac{F_0 r}{R_0 (d\\psi/dr)}$.\n        *   Using $d\\psi/dr = \\frac{1}{2}\\mu_0\\alpha R_0^2 r$, I get $q(r) \\approx \\frac{F_0 r}{R_0 (\\frac{1}{2}\\mu_0\\alpha R_0^2 r)} = \\frac{2F_0}{\\mu_0\\alpha R_0^3}$.\n        *   This is the same result. The derivation is consistent. The result is a constant. The question asks for $q(\\psi)$, but since it's a constant, it's just the constant value.\n\n    *   **Part 3: Identify leading-order expressions for $|\\nabla\\psi|$ and $B(\\theta)$**.\n        *   $|\\nabla\\psi|$: As calculated earlier, for $\\psi=\\psi(r)$, $\\nabla\\psi=\\frac{d\\psi}{dr}\\nabla r$ and $|\\nabla r|=1$.\n        *   So $|\\nabla\\psi| = |\\frac{d\\psi}{dr}|$.\n        *   Since $\\psi \\propto r^2$ and we can assume $\\psi$ increases from the axis, $\\frac{d\\psi}{dr} = \\frac{1}{2}\\mu_0\\alpha R_0^2 r$. This is positive for $r>0$.\n        *   So $|\\nabla\\psi| = \\frac{1}{2}\\mu_0\\alpha R_0^2 r$. This depends on the flux surface, i.e., on $r$ (or $\\psi$).\n        *   $B(\\theta)$: Magnetic field strength $B=|\\mathbf{B}|$.\n        *   $\\mathbf{B} = \\mathbf{B}_p + \\mathbf{B}_T$. In an orthogonal system these would add in quadrature.\n        *   $B^2 = B_p^2 + B_T^2$.\n        *   $B_T = B_\\phi = \\frac{F(\\psi)}{R} = \\frac{F_0}{R_0+r\\cos\\theta}$.\n        *   $B_p = |\\mathbf{B}_p| = \\frac{|\\nabla\\psi|}{R} = \\frac{1}{R}\\frac{d\\psi}{dr}$.\n        *   To leading order in $\\epsilon = r/R_0 \\ll 1$, the poloidal field $B_p$ is much smaller than the toroidal field $B_T$.\n        *   $B_p \\approx \\frac{1}{R_0}\\frac{d\\psi}{dr} = \\frac{1}{R_0}(\\frac{1}{2}\\mu_0\\alpha R_0^2 r) = \\frac{1}{2}\\mu_0\\alpha R_0 r$.\n        *   $B_T \\approx \\frac{F_0}{R_0}$.\n        *   $B_p/B_T \\approx (\\frac{1}{2}\\mu_0\\alpha R_0 r) / (F_0/R_0) = \\frac{\\mu_0\\alpha R_0^2 r}{2F_0}$.\n        *   From the $q$ expression, $q \\approx \\frac{2F_0}{\\mu_0\\alpha R_0^3}$, so $\\mu_0\\alpha R_0^3 = 2F_0/q$.\n        *   $B_p/B_T \\approx \\frac{r}{R_0} \\frac{\\mu_0\\alpha R_0^3}{2F_0} = \\frac{r}{R_0} \\frac{2F_0/q}{2F_0} = \\frac{r}{R_0} \\frac{1}{q} = \\epsilon/q$.\n        *   Since $\\epsilon \\ll 1$, $B_p \\ll B_T$ (assuming $q$ is of order unity, which it is in tokamaks).\n        *   So $B^2 = B_T^2 + B_p^2 \\approx B_T^2$.\n        *   $B \\approx B_T = \\frac{F_0}{R_0+r\\cos\\theta} = \\frac{F_0}{R_0(1+\\epsilon\\cos\\theta)}$.\n        *   To leading order in $\\epsilon$, we can expand this:\n        *   $B(\\theta) \\approx \\frac{F_0}{R_0}(1 - \\epsilon\\cos\\theta) = \\frac{F_0}{R_0}(1 - \\frac{r}{R_0}\\cos\\theta)$.\n        *   This is the standard expression for the magnetic field variation on a flux surface in a large aspect ratio tokamak.\nThe problem is scientifically grounded, well-posed, objective, and falls within the specified domain. It is a standard derivation in MHD theory. Therefore, the problem is valid.\n\nFirst, we simplify the Grad–Shafranov equation using the prescribed profiles for pressure $p(\\psi)$ and the toroidal field function $F(\\psi)$. Given $p(\\psi) = p_{a} - \\alpha \\psi$, the pressure gradient term is $\\frac{dp}{d\\psi} = -\\alpha$. Given $F^{2}(\\psi) = F_{0}^{2}$, where $F_0$ is a constant, the corresponding term is $F(\\psi)\\frac{dF}{d\\psi} = \\frac{1}{2}\\frac{d(F^{2})}{d\\psi} = \\frac{1}{2}\\frac{d(F_{0}^{2})}{d\\psi} = 0$. Substituting these into the Grad–Shafranov equation yields:\n$$\n\\Delta^{*}\\psi = - \\mu_{0} R^{2} (-\\alpha) - 0 = \\mu_{0} \\alpha R^{2}\n$$\nThe problem specifies a large-aspect-ratio expansion, $\\epsilon \\equiv r/R_0 \\ll 1$, and that $\\psi$ should be treated as a function of the minor radius $r$ only at leading order, i.e., $\\psi = \\psi(r)$. The operator $\\Delta^{*}$ in toroidal coordinates $(r, \\theta)$ is given by:\n$$\n\\Delta^{*}\\psi = \\frac{1}{r}\\frac{\\partial}{\\partial r}\\left(r \\frac{\\partial \\psi}{\\partial r}\\right) + \\frac{1}{r^2}\\frac{\\partial^2\\psi}{\\partial\\theta^2} - \\frac{1}{R}\\left(\\cos\\theta\\frac{\\partial\\psi}{\\partial r} - \\frac{\\sin\\theta}{r}\\frac{\\partial\\psi}{\\partial\\theta}\\right)\n$$\nSince $\\psi = \\psi(r)$, derivatives with respect to $\\theta$ vanish, so $\\frac{\\partial\\psi}{\\partial\\theta}=0$ and $\\frac{\\partial^2\\psi}{\\partial\\theta^2}=0$. The operator simplifies to:\n$$\n\\Delta^{*}\\psi = \\frac{1}{r}\\frac{d}{dr}\\left(r \\frac{d\\psi}{dr}\\right) - \\frac{\\cos\\theta}{R}\\frac{d\\psi}{dr}\n$$\nThe full equation is then:\n$$\n\\frac{1}{r}\\frac{d}{dr}\\left(r \\frac{d\\psi}{dr}\\right) - \\frac{\\cos\\theta}{R_0+r\\cos\\theta}\\frac{d\\psi}{dr} = \\mu_{0} \\alpha (R_0+r\\cos\\theta)^2\n$$\nTo obtain the leading-order equation, we retain only the lowest-order terms in $\\epsilon = r/R_0$. We approximate $R \\approx R_0$ on both sides of the equation. The $\\cos\\theta$ term on the left-hand side is of order $\\epsilon$ compared to the first term, and the $\\cos\\theta$ terms on the right-hand side are also of order $\\epsilon$ and $\\epsilon^2$. Dropping these terms gives the leading-order equation:\n$$\n\\frac{1}{r}\\frac{d}{dr}\\left(r \\frac{d\\psi}{dr}\\right) = \\mu_{0} \\alpha R_{0}^{2}\n$$\nIntegrating this ordinary differential equation once with respect to $r$:\n$$\nr \\frac{d\\psi}{dr} = \\int \\mu_{0} \\alpha R_{0}^{2} r \\,dr = \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r^2 + C_1\n$$\nDividing by $r$ gives $\\frac{d\\psi}{dr} = \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r + \\frac{C_1}{r}$. The condition of regularity at the magnetic axis ($r=0$) requires that physical quantities like the magnetic field do not diverge. Since the poloidal magnetic field is proportional to $\\frac{1}{R}|\\nabla\\psi| \\sim \\frac{1}{R_0}\\frac{d\\psi}{dr}$, we must have $\\frac{d\\psi}{dr}$ be finite at $r=0$. This implies we must set the integration constant $C_1=0$. Thus:\n$$\n\\frac{d\\psi}{dr} = \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r\n$$\nIntegrating a second time gives $\\psi(r)$:\n$$\n\\psi(r) = \\int \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r \\,dr = \\frac{1}{4}\\mu_{0} \\alpha R_{0}^{2} r^2 + C_2\n$$\nWe can define the poloidal flux to be zero at the magnetic axis, $\\psi(0)=0$, which sets $C_2=0$. The leading-order poloidal flux function is therefore:\n$$\n\\psi(r) = \\frac{1}{4}\\mu_{0} \\alpha R_{0}^{2} r^2\n$$\nNext, we derive the safety factor $q(\\psi)$ from its definition $q = \\frac{1}{2\\pi}\\oint \\frac{d\\phi}{d\\theta}\\,d\\theta$, where the differential ratio follows the magnetic field line. This ratio is given by $\\frac{d\\phi}{d\\theta} = \\frac{\\mathbf{B}\\cdot\\nabla\\phi}{\\mathbf{B}\\cdot\\nabla\\theta}$.\nThe magnetic field is $\\mathbf{B} = \\nabla\\psi \\times \\nabla\\phi + F(\\psi)\\nabla\\phi$. The contravariant basis vectors are $\\nabla\\phi = \\frac{1}{R}\\hat{\\phi}$ and $\\nabla\\theta = \\frac{1}{r}(-\\sin\\theta\\hat{R}+\\cos\\theta\\hat{Z})$.\nThe numerator is $\\mathbf{B}\\cdot\\nabla\\phi = F(\\psi)|\\nabla\\phi|^2 = F(\\psi)/R^2$.\nFor the denominator, we need the poloidal magnetic field $\\mathbf{B}_p = \\nabla\\psi \\times \\nabla\\phi$. Given $\\psi=\\psi(r)$, we have $\\nabla\\psi = \\frac{d\\psi}{dr}\\nabla r = \\frac{d\\psi}{dr}(\\cos\\theta\\hat{R} + \\sin\\theta\\hat{Z})$.\nThen, $\\mathbf{B}_p = \\frac{1}{R}\\nabla\\psi \\times \\hat{\\phi} = \\frac{1}{R}\\frac{d\\psi}{dr}(\\cos\\theta\\hat{Z} - \\sin\\theta\\hat{R})$.\nThe dot product is $\\mathbf{B}\\cdot\\nabla\\theta = \\mathbf{B}_p\\cdot\\nabla\\theta = \\frac{1}{R}\\frac{d\\psi}{dr}(\\cos\\theta\\hat{Z} - \\sin\\theta\\hat{R}) \\cdot \\frac{1}{r}(\\cos\\theta\\hat{Z} - \\sin\\theta\\hat{R}) = \\frac{1}{Rr}\\frac{d\\psi}{dr}$.\nThus, the integrand is $\\frac{d\\phi}{d\\theta} = \\frac{F/R^2}{(1/Rr)(d\\psi/dr)} = \\frac{F r}{R (d\\psi/dr)}$.\nThe safety factor is the integral over a flux surface (constant $r$):\n$$\nq(r) = \\frac{1}{2\\pi}\\int_{0}^{2\\pi} \\frac{F(r) r}{R(\\theta) \\frac{d\\psi}{dr}} \\,d\\theta\n$$\nSubstituting $F=F_0$, $R=R_0+r\\cos\\theta$, and $d\\psi/dr = \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r$:\n$$\nq(r) = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\frac{F_0 r}{(R_0+r\\cos\\theta) (\\frac{1}{2}\\mu_0 \\alpha R_0^2 r)} \\,d\\theta = \\frac{2 F_0}{\\mu_0 \\alpha R_0^2} \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\frac{d\\theta}{R_0+r\\cos\\theta}\n$$\nThe integral is $\\int_{0}^{2\\pi} \\frac{d\\theta}{a+b\\cos\\theta} = \\frac{2\\pi}{\\sqrt{a^2-b^2}}$. Here $a=R_0$ and $b=r$.\n$$\nq(r) = \\frac{2 F_0}{\\mu_0 \\alpha R_0^2} \\frac{1}{\\sqrt{R_0^2-r^2}} = \\frac{2 F_0}{\\mu_0 \\alpha R_0^3 \\sqrt{1-(r/R_0)^2}}\n$$\nWe are asked for the leading-order expression in $\\epsilon=r/R_0$. We expand the result for small $\\epsilon$:\n$$\nq(r) = \\frac{2 F_0}{\\mu_0 \\alpha R_0^3} (1 - \\epsilon^2)^{-1/2} = \\frac{2 F_0}{\\mu_0 \\alpha R_0^3} (1 + O(\\epsilon^2))\n$$\nTo leading order, the safety factor is constant:\n$$\nq \\approx \\frac{2 F_0}{\\mu_0 \\alpha R_0^3}\n$$\nSince this expression is independent of $r$, it is also independent of $\\psi$. Thus, $q(\\psi)$ is this constant value.\n\nFor completeness, we identify the other requested geometric factors.\nThe magnitude of the poloidal flux gradient on a flux surface is:\n$$\n|\\nabla\\psi| = \\left|\\frac{d\\psi}{dr}\\right| = \\frac{1}{2}\\mu_{0} \\alpha R_{0}^{2} r\n$$\nThe magnetic field strength variation along a flux surface is $B(\\theta) = |\\mathbf{B}| = \\sqrt{B_p^2 + B_T^2}$.\n$B_T = B_\\phi = \\frac{F_0}{R} = \\frac{F_0}{R_0+r\\cos\\theta}$.\n$B_p = \\frac{|\\nabla\\psi|}{R} = \\frac{(1/2)\\mu_0 \\alpha R_0^2 r}{R_0+r\\cos\\theta}$.\nIn the large-aspect-ratio limit, $B_p/B_T = \\frac{\\mu_0 \\alpha R_0^2 r}{2F_0} = \\frac{r}{R_0 q} = \\epsilon/q \\ll 1$. Thus $B_p^2$ is negligible compared to $B_T^2$.\n$$\nB(\\theta) \\approx |B_T| = \\frac{F_0}{R_0+r\\cos\\theta} = \\frac{F_0}{R_0(1+\\epsilon\\cos\\theta)} \\approx \\frac{F_0}{R_0}(1-\\epsilon\\cos\\theta) = \\frac{F_0}{R_0}\\left(1-\\frac{r}{R_0}\\cos\\theta\\right)\n$$\nThe final answer required is the expression for $q(\\psi)$.",
            "answer": "$$\n\\boxed{\\frac{2F_0}{\\mu_0 \\alpha R_0^3}}\n$$"
        },
        {
            "introduction": "A defining feature of toroidal magnetic confinement is the spatial variation of the magnetic field strength, which creates a \"magnetic mirror\" effect. This practice explores the direct consequences of this geometry on single-particle dynamics, specifically the phenomenon of particle trapping. Applying the principles of energy and magnetic moment conservation, you will derive the condition for a particle to be trapped and calculate the fraction of trapped particles on a given flux surface, a critical parameter that strongly influences plasma transport, stability, and heating mechanisms .",
            "id": "3981597",
            "problem": "Consider a circular, concentric, large-aspect-ratio (LAR) tokamak of major radius $R_{0}$ and minor radius $r \\ll R_{0}$, with inverse aspect ratio $\\epsilon = r / R_{0}$. In the local flux-tube (FT) gyrokinetic (GK) formulation, one follows a single magnetic field line on a given flux surface, parameterized by the poloidal angle $\\theta$. The magnitude of the magnetic field on that flux surface is determined by toroidal geometry as\n$$\nB(\\theta) = \\frac{B_{0}}{1 + \\epsilon \\cos \\theta},\n$$\nwhere $B_{0}$ is the toroidal field at $R_{0}$. The minimum field is at the outboard midplane $\\theta = 0$, $B_{\\min} = B_{0}/(1+\\epsilon)$, and the maximum field is at the inboard midplane $\\theta = \\pi$, $B_{\\max} = B_{0}/(1-\\epsilon)$.\n\nAssume the gyrokinetic invariants of motion hold along the field line: conservation of total kinetic energy $E = \\tfrac{1}{2} m v^{2}$ and conservation of magnetic moment $\\mu = \\tfrac{m v_{\\perp}^{2}}{2 B}$. Define the pitch-angle parameter at the outboard midplane reference location $\\theta = 0$ by $\\lambda \\equiv v_{\\perp}^{2}(\\theta=0)/v^{2}$, and introduce the normalized field\n$$\nb(\\theta) \\equiv \\frac{B(\\theta)}{B_{\\min}} = \\frac{1+\\epsilon}{1+\\epsilon \\cos \\theta},\n$$\nso that $b_{\\min} = 1$ and $b_{\\max} = \\frac{1+\\epsilon}{1-\\epsilon}$.\n\nStarting from the stated invariants and definitions, derive the condition for a particle to be magnetically trapped along the field line in terms of $\\lambda$ and $b_{\\max}$, showing that the trapping condition can be written as $\\lambda\\, B_{\\max} > 1$ under the normalization used here. Then, assuming an isotropic distribution of velocity directions at $\\theta=0$ (so that the cosine of the pitch angle, $u \\equiv \\cos \\alpha_{0}$, is uniformly distributed on $[-1,1]$), compute the exact trapped fraction $f_{t}(\\epsilon)$ of particles on the flux surface as a function of $\\epsilon$.\n\nFinally, evaluate $f_{t}$ for $\\epsilon = 0.2$, and report the numerical value as a dimensionless decimal. Round your answer to four significant figures.",
            "solution": "The problem asks for two main results derived from a standard model of particle motion in a large-aspect-ratio tokamak: first, the condition for a particle to be magnetically trapped, and second, the fraction of trapped particles on a given flux surface assuming an isotropic velocity distribution, evaluated for a specific inverse aspect ratio $\\epsilon$.\n\nFirst, we derive the condition for magnetic trapping. A particle's motion along a magnetic field line is governed by the conservation of its total kinetic energy, $E$, and its magnetic moment, $\\mu$. These are given as:\n$$\nE = \\frac{1}{2} m (v_{\\perp}^{2} + v_{\\|}^{2}) = \\text{constant}\n$$\n$$\n\\mu = \\frac{m v_{\\perp}^{2}}{2 B} = \\text{constant}\n$$\nHere, $m$ is the particle mass, $v_{\\perp}$ is the component of velocity perpendicular to the magnetic field $\\vec{B}$, $v_{\\|}$ is the component parallel to $\\vec{B}$, and $B=|\\vec{B}|$. From the definition of $\\mu$, we can express the perpendicular kinetic energy as $\\frac{1}{2}m v_{\\perp}^{2} = \\mu B$. Substituting this into the energy conservation equation yields:\n$$\nE = \\mu B(\\theta) + \\frac{1}{2} m v_{\\|}^{2}(\\theta)\n$$\nwhere we have explicitly noted the dependence of $B$ and $v_{\\|}$ on the poloidal angle $\\theta$. We can solve for $v_{\\|}^{2}$:\n$$\nv_{\\|}^{2}(\\theta) = \\frac{2}{m}(E - \\mu B(\\theta))\n$$\nA particle is considered \"trapped\" if its parallel motion reverses direction at some point along the field line before completing a full poloidal circuit. This reversal point, known as a bounce point or turning point $\\theta_b$, is where $v_{\\|}(\\theta_b) = 0$. From the equation for $v_{\\|}^{2}$, this occurs when the particle's total energy equals its perpendicular energy:\n$$\nE = \\mu B(\\theta_b)\n$$\nSince $v_{\\|}^{2}$ must be non-negative, a particle with given $E$ and $\\mu$ can only access regions where $E \\ge \\mu B(\\theta)$. The magnetic field $B(\\theta)$ varies along the field line, reaching a maximum value $B_{\\max}$ at the inboard midplane ($\\theta = \\pi$). If a particle's energy $E$ is less than the maximum possible \"potential\" energy $\\mu B_{\\max}$, it will be reflected before it reaches the point of maximum field. Thus, the condition for a particle to be trapped is:\n$$\nE < \\mu B_{\\max}\n$$\nTo make this condition more practical, we express $E$ and $\\mu$ in terms of quantities at a reference location, which is the outboard midplane ($\\theta=0$) where the magnetic field is minimum, $B(0) = B_{\\min}$. At this location, the total velocity is $v$, and the perpendicular velocity is $v_{\\perp}(0)$. The conserved quantities are:\n$$\nE = \\frac{1}{2} m v^{2}\n$$\n$$\n\\mu = \\frac{m v_{\\perp}^{2}(0)}{2 B_{\\min}}\n$$\nSubstituting these expressions into the trapping inequality $E < \\mu B_{\\max}$ gives:\n$$\n\\frac{1}{2} m v^{2} < \\left(\\frac{m v_{\\perp}^{2}(0)}{2 B_{\\min}}\\right) B_{\\max}\n$$\nWe can cancel the term $\\frac{1}{2}m$ from both sides, which is valid since $m>0$:\n$$\nv^{2} < \\frac{v_{\\perp}^{2}(0)}{B_{\\min}} B_{\\max}\n$$\nRearranging this inequality to group dimensionless quantities, we get:\n$$\n1 < \\frac{v_{\\perp}^{2}(0)}{v^{2}} \\frac{B_{\\max}}{B_{\\min}}\n$$\nThe problem defines the pitch-angle parameter at the outboard midplane as $\\lambda \\equiv v_{\\perp}^{2}(0)/v^{2}$ and the normalized field maximum as $b_{\\max} \\equiv B_{\\max}/B_{\\min}$. Using these definitions, the condition for a particle to be trapped becomes:\n$$\n\\lambda b_{\\max} > 1\n$$\nIt is noted that the problem statement contains a typographical error in asking to show that the trapping condition is $\\lambda\\, B_{\\max} > 1$. This expression is dimensionally inconsistent, as $\\lambda$ is dimensionless while $B_{\\max}$ has units of magnetic field. The derived condition, $\\lambda b_{\\max} > 1$, is the physically and dimensionally correct one, consistent with the provided normalizations.\n\nNext, we calculate the fraction of trapped particles, $f_t(\\epsilon)$. The problem specifies an isotropic velocity distribution at the reference location $\\theta=0$. This implies that the cosine of the pitch angle at $\\theta=0$, denoted $u \\equiv \\cos \\alpha_{0} = v_{\\|}(0)/v$, is uniformly distributed over the interval $[-1, 1]$.\nThe pitch-angle parameter $\\lambda$ can be expressed in terms of $u$:\n$$\n\\lambda = \\frac{v_{\\perp}^{2}(0)}{v^{2}} = \\frac{v^{2} - v_{\\|}^{2}(0)}{v^{2}} = 1 - \\frac{v_{\\|}^{2}(0)}{v^{2}} = 1 - \\left(\\frac{v_{\\|}(0)}{v}\\right)^{2} = 1 - u^{2}\n$$\nSubstituting this into the trapping condition $\\lambda b_{\\max} > 1$:\n$$\n(1 - u^{2}) b_{\\max} > 1\n$$\nWe solve for the range of $u$ that corresponds to trapped particles:\n$$\n1 - u^{2} > \\frac{1}{b_{\\max}}\n$$\n$$\nu^{2} < 1 - \\frac{1}{b_{\\max}}\n$$\nThis inequality holds if $-\\sqrt{1 - 1/b_{\\max}} < u < \\sqrt{1 - 1/b_{\\max}}$.\nThe fraction of trapped particles is the probability that $u$ falls within this interval. Since $u$ is uniformly distributed on $[-1, 1]$, its probability density function is $p(u) = 1/2$ for $u \\in [-1, 1]$ and $0$ otherwise. The trapped fraction $f_t$ is found by integrating this probability density over the trapped region:\n$$\nf_t = \\int_{-\\sqrt{1 - 1/b_{\\max}}}^{\\sqrt{1 - 1/b_{\\max}}} p(u) \\, du = \\int_{-\\sqrt{1 - 1/b_{\\max}}}^{\\sqrt{1 - 1/b_{\\max}}} \\frac{1}{2} \\, du = \\frac{1}{2} \\left[ u \\right]_{-\\sqrt{1 - 1/b_{\\max}}}^{\\sqrt{1 - 1/b_{\\max}}}\n$$\n$$\nf_t = \\frac{1}{2} \\left[ \\sqrt{1 - \\frac{1}{b_{\\max}}} - \\left(-\\sqrt{1 - \\frac{1}{b_{\\max}}}\\right) \\right] = \\sqrt{1 - \\frac{1}{b_{\\max}}}\n$$\nNow, we express this fraction in terms of the inverse aspect ratio $\\epsilon$. The normalized maximum field is given by $b_{\\max} = \\frac{1+\\epsilon}{1-\\epsilon}$. Substituting this into the expression for $f_t$:\n$$\nf_t(\\epsilon) = \\sqrt{1 - \\frac{1}{(1+\\epsilon)/(1-\\epsilon)}} = \\sqrt{1 - \\frac{1-\\epsilon}{1+\\epsilon}}\n$$\nSimplifying the term inside the square root:\n$$\nf_t(\\epsilon) = \\sqrt{\\frac{(1+\\epsilon) - (1-\\epsilon)}{1+\\epsilon}} = \\sqrt{\\frac{1+\\epsilon-1+\\epsilon}{1+\\epsilon}} = \\sqrt{\\frac{2\\epsilon}{1+\\epsilon}}\n$$\nThis is the exact analytical expression for the trapped fraction as a function of $\\epsilon$.\n\nFinally, we evaluate $f_t$ for the given value $\\epsilon = 0.2$:\n$$\nf_t(0.2) = \\sqrt{\\frac{2 \\times 0.2}{1 + 0.2}} = \\sqrt{\\frac{0.4}{1.2}} = \\sqrt{\\frac{1}{3}}\n$$\nTo obtain the numerical value, we compute:\n$$\nf_t(0.2) = \\frac{1}{\\sqrt{3}} \\approx 0.577350269...\n$$\nRounding this result to four significant figures as requested gives $0.5774$.",
            "answer": "$$\n\\boxed{0.5774}\n$$"
        },
        {
            "introduction": "The core of gyrokinetic theory is its ability to describe the complex, nonlinear dynamics of plasma turbulence. This computational exercise delves into the heart of this process by calculating the rate of energy transfer between different types of fluctuations. By implementing the spectral triad interaction formalism, you will directly compute how energy flows from unstable drift waves to stable zonal flows, gaining hands-on experience with the fundamental self-regulation mechanism that governs the saturation of turbulence in a magnetized plasma .",
            "id": "3981576",
            "problem": "Consider a local \"flux-tube\" spectral representation of an electrostatic, magnetized plasma, in which the perpendicular dynamics are treated on a two-dimensional periodic domain in the radial coordinate $x$ and the binormal coordinate $y$. Work within the electrostatic, low-frequency, gyrokinetic limit where the perpendicular velocity field is given by the electric cross magnetic (E×B) drift, and the perpendicular dynamics can be represented by an incompressible streamfunction. In normalized gyrokinetic units, let the electrostatic potential be the streamfunction $\\,\\phi(x,y,t)\\,$, and define the vorticity $\\,\\zeta(x,y,t)\\,$ by the Laplacian of the streamfunction. Take the fundamental definitions:\n- $\\,\\mathbf{v}_{E\\times B} = \\hat{\\mathbf{z}} \\times \\nabla \\phi\\,$,\n- $\\,\\zeta = \\nabla^2 \\phi\\,$,\n- $\\,J(\\phi,\\zeta) = \\partial_x \\phi\\,\\partial_y \\zeta - \\partial_y \\phi\\,\\partial_x \\zeta\\,$,\n- The perpendicular energy density associated with the E×B flow at mode $(k_x,k_y)$ is proportional to $\\,k_\\perp^2\\,|\\phi_{k_x,k_y}|^2\\,$, where $\\,k_\\perp^2 = k_x^2 + k_y^2\\,$.\n\nUsing only the above foundational definitions and the properties of Fourier transforms on a periodic domain, derive the spectral triad interaction form of the nonlinear term and, from it, the spectral expression for the nonlinear energy transfer rate into a given mode $(k_x,k_y)$. A \"triad\" refers to a triple of wavevectors $(\\mathbf{k},\\mathbf{p},\\mathbf{q})$ satisfying $\\,\\mathbf{k}=\\mathbf{p}+\\mathbf{q}\\,$. A \"zonal flow\" denotes a mode with $\\,k_y=0\\,$ and $\\,k_x\\neq 0\\,$. A \"drift wave\" denotes a mode with $\\,k_y\\neq 0\\,$. Your task is to algorithmically compute the instantaneous nonlinear energy transfer rate from drift waves to zonal flows by summing, for each zonal mode $\\mathbf{k}$, only the triad contributions whose interacting partners $\\mathbf{p}$ and $\\mathbf{q}$ are both drift-wave modes. Express all rates in normalized, dimensionless units.\n\nImplementation details to respect:\n- Use a discrete spectral set of integer wave numbers $\\,k_x, k_y \\in \\mathbb{Z}\\,$ consistent with a $\\,2\\pi\\,$-periodic domain in both $x$ and $y$, so that derivatives in real space correspond to multiplication by $\\,i k_x\\,$ or $\\,i k_y\\,$ in spectral space.\n- Let $\\,\\phi_{k_x,k_y}\\,$ be complex amplitudes of the spectral modes.\n- The vorticity in spectral space satisfies $\\,\\zeta_{k_x,k_y} = -k_\\perp^2\\,\\phi_{k_x,k_y}\\,$.\n- The nonlinear energy transfer rate into a zonal mode $\\mathbf{k}$ is computed by contracting the mode's complex amplitude with the nonlinear spectral term obtained from the triad sum, taking the real part to produce a physically meaningful rate. The total drift-to-zonal transfer is the sum over all zonal target modes.\n\nYour program must use the following test suite of spectral configurations, each specified as a list of mode tuples $\\,[(k_x,k_y),\\phi_{k_x,k_y}]\\,$. For all cases, treat modes not listed as having zero amplitude. Compute, for each case, a single scalar representing the total nonlinear energy transfer rate from drift waves into all zonal modes present in that case, using only triads whose two interacting partners are both drift-wave modes.\n\nTest Suite:\n1. Case A (two drift waves forming a single zonal target):\n   - Modes: $\\,[(1,1),\\,1.0+0.5i],\\,[(1,-1),\\,0.7-0.2i],\\,[(2,0),\\,0.05+0.01i]\\,$.\n2. Case B (zonal-only configuration, no drift waves):\n   - Modes: $\\,[(1,0),\\,0.4+0.0i],\\,[(2,0),\\,-0.3+0.1i],\\,[(-1,0),\\,0.1-0.2i]\\,$.\n3. Case C (single drift wave plus a zonal, insufficient for a drift-drift triad):\n   - Modes: $\\,[(1,1),\\,0.6-0.5i],\\,[(2,0),\\,0.2+0.05i]\\,$.\n4. Case D (multiple drift waves forming multiple zonal targets, plus extras):\n   - Modes: $\\,[(2,2),\\,0.8+0.3i],\\,[(-1,-2),\\,-0.5+0.1i],\\,[(0,3),\\,0.4+0.9i],\\,[(1,-3),\\,0.3-0.6i],\\,[(1,2),\\,0.6-0.1i],\\,[(1,-2),\\,-0.2+0.4i],\\,[(3,2),\\,0.2+0.2i],\\,[(1,0),\\,0.15-0.05i],\\,[(2,0),\\,-0.1+0.05i],\\,[(3,0),\\,0.12-0.07i]\\,$.\n\nFinal output format:\n- Your program should produce a single line of output containing the four scalar results for Cases A–D as a comma-separated list enclosed in square brackets (e.g., \"[rA,rB,rC,rD]\"). Each scalar must be a float representing the drift-to-zonal nonlinear energy transfer rate for that case, in normalized, dimensionless units.\n\nNo external input is permitted. The program must be self-contained and compute the requested quantities directly from the provided spectral data. Angles are not involved in this problem; no angle units are required. Physical units are not required because all quantities are in normalized, dimensionless form.",
            "solution": "The problem is valid. It is a well-posed problem in computational plasma physics, specifically concerning nonlinear energy transfer in 2D gyrokinetic turbulence, which is modeled by the Hasegawa-Mima equation or a similar vorticity advection equation. All definitions are standard and the computational goal is clear and achievable.\n\nThe solution requires deriving the spectral expression for the nonlinear energy transfer rate and then implementing a numerical calculation for the given test cases, subject to the specified constraints.\n\nThe fundamental equation governing the evolution of vorticity $\\,\\zeta(x,y,t)\\,$ in this system is the vorticity advection equation, which in the absence of linear terms and dissipation is:\n$$\n\\frac{\\partial \\zeta}{\\partial t} + \\mathbf{v}_{E\\times B} \\cdot \\nabla \\zeta = 0\n$$\nThe nonlinear advection term can be written using the Jacobian operator, $\\,J(\\phi,\\zeta)\\,$:\n$$\n\\mathbf{v}_{E\\times B} \\cdot \\nabla \\zeta = (\\hat{\\mathbf{z}} \\times \\nabla \\phi) \\cdot \\nabla \\zeta = \\frac{\\partial \\phi}{\\partial x}\\frac{\\partial \\zeta}{\\partial y} - \\frac{\\partial \\phi}{\\partial y}\\frac{\\partial \\zeta}{\\partial x} = J(\\phi, \\zeta)\n$$\nThus, the governing equation is $\\,\\partial_t \\zeta = -J(\\phi, \\zeta)\\,$.\nWe represent the fields $\\,\\phi\\,$ and $\\,\\zeta\\,$ by their complex Fourier amplitudes on a doubly periodic domain of size $\\,2\\pi \\times 2\\pi\\,$:\n$$\n\\phi(x,y) = \\sum_{\\mathbf{k}} \\phi_{\\mathbf{k}} e^{i(k_x x + k_y y)} \\quad , \\quad \\zeta(x,y) = \\sum_{\\mathbf{k}} \\zeta_{\\mathbf{k}} e^{i(k_x x + k_y y)}\n$$\nwhere $\\,\\mathbf{k}=(k_x, k_y)\\,$ is the wavevector with integer components.\nIn spectral space, spatial derivatives become algebraic multiplications: $\\,\\partial_x \\rightarrow i k_x\\,$ and $\\,\\partial_y \\rightarrow i k_y\\,$. The Laplacian operator becomes $\\,\\nabla^2 \\rightarrow -(k_x^2+k_y^2) = -k_\\perp^2\\,$. The relationship $\\,\\zeta = \\nabla^2\\phi\\,$ becomes:\n$$\n\\zeta_{\\mathbf{k}} = -k_\\perp^2 \\phi_{\\mathbf{k}}\n$$\nThe Fourier transform of the nonlinear Jacobian term $\\,J(\\phi, \\zeta)\\,$ is a convolution over wavevectors. Let's denote the spectral representation of the Jacobian by $\\,J_{\\mathbf{k}}\\,$:\n$$\nJ_{\\mathbf{k}} = \\mathcal{F}[J(\\phi, \\zeta)]_{\\mathbf{k}} = \\sum_{\\mathbf{p}+\\mathbf{q}=\\mathbf{k}} (p_y q_x - p_x q_y) \\phi_{\\mathbf{p}} \\zeta_{\\mathbf{q}}\n$$\nThe summation is over all pairs of wavevectors $\\,(\\mathbf{p}, \\mathbf{q})\\,$ that sum to the target wavevector $\\,\\mathbf{k}\\,$. This three-wavevector interaction is known as a triad interaction. The term $\\,p_y q_x - p_x q_y\\,$ is the z-component of the cross product $\\,\\mathbf{q} \\times \\mathbf{p}\\,$. The vorticity evolution equation in spectral space is:\n$$\n\\frac{\\partial \\zeta_{\\mathbf{k}}}{\\partial t} = -J_{\\mathbf{k}}\n$$\nUsing the relation $\\,\\zeta_{\\mathbf{k}} = -k_\\perp^2 \\phi_{\\mathbf{k}}\\,$, we find the evolution equation for the potential $\\,\\phi_{\\mathbf{k}}\\,$ (for $\\,k_\\perp \\neq 0\\,$):\n$$\n-k_\\perp^2 \\frac{\\partial \\phi_{\\mathbf{k}}}{\\partial t} = -J_{\\mathbf{k}} \\implies \\frac{\\partial \\phi_{\\mathbf{k}}}{\\partial t} = \\frac{J_{\\mathbf{k}}}{k_\\perp^2}\n$$\nThe perpendicular kinetic energy density associated with mode $\\,\\mathbf{k}\\,$ is given as proportional to $\\,k_\\perp^2 |\\phi_{\\mathbf{k}}|^2\\,$. Let's define the energy as $\\,E_{\\mathbf{k}} = \\frac{1}{2} k_\\perp^2 |\\phi_{\\mathbf{k}}|^2 = \\frac{1}{2} k_\\perp^2 \\phi_{\\mathbf{k}} \\phi_{\\mathbf{k}}^*\\,$. The rate of change of this energy, which is the nonlinear energy transfer rate $\\,T_{\\mathbf{k}}\\,$, is:\n$$\nT_{\\mathbf{k}} = \\frac{dE_{\\mathbf{k}}}{dt} = \\frac{1}{2} k_\\perp^2 \\left( \\frac{\\partial \\phi_{\\mathbf{k}}}{\\partial t} \\phi_{\\mathbf{k}}^* + \\phi_{\\mathbf{k}} \\frac{\\partial \\phi_{\\mathbf{k}}^*}{\\partial t} \\right) = k_\\perp^2 \\text{Re}\\left( \\frac{\\partial \\phi_{\\mathbf{k}}}{\\partial t} \\phi_{\\mathbf{k}}^* \\right)\n$$\nSubstituting the expression for $\\,\\partial_t \\phi_{\\mathbf{k}}\\,$:\n$$\nT_{\\mathbf{k}} = k_\\perp^2 \\text{Re}\\left( \\frac{J_{\\mathbf{k}}}{k_\\perp^2} \\phi_{\\mathbf{k}}^* \\right) = \\text{Re}( J_{\\mathbf{k}} \\phi_{\\mathbf{k}}^* )\n$$\nThis expression is consistent with the problem's instruction to contract the complex amplitude with the nonlinear term. Here, $\\,J_\\mathbf{k}\\,$ is the relevant nonlinear term driving the energy dynamics.\n\nTo obtain a computationally symmetric form for $\\,J_{\\mathbf{k}}\\,$, we exploit the properties of the convolution sum. Swapping the dummy indices $\\,\\mathbf{p}\\,$ and $\\,\\mathbf{q}\\,$ and using $\\,\\zeta_{\\mathbf{p}} = -p_\\perp^2 \\phi_{\\mathbf{p}}\\,$ and $\\,\\zeta_{\\mathbf{q}} = -q_\\perp^2 \\phi_{\\mathbf{q}}\\,$, we can write $\\,J_{\\mathbf{k}}\\,$ as:\n$$\nJ_{\\mathbf{k}} = \\frac{1}{2} \\sum_{\\mathbf{p}+\\mathbf{q}=\\mathbf{k}} (p_y q_x - p_x q_y) (\\phi_{\\mathbf{p}} \\zeta_{\\mathbf{q}} - \\phi_{\\mathbf{q}} \\zeta_{\\mathbf{p}})\n$$\n$$\nJ_{\\mathbf{k}} = \\frac{1}{2} \\sum_{\\mathbf{p}+\\mathbf{q}=\\mathbf{k}} (p_y q_x - p_x q_y) (\\phi_{\\mathbf{p}} (-q_\\perp^2 \\phi_{\\mathbf{q}}) - \\phi_{\\mathbf{q}} (-p_\\perp^2 \\phi_{\\mathbf{p}}))\n$$\n$$\nJ_{\\mathbf{k}} = \\frac{1}{2} \\sum_{\\mathbf{p}+\\mathbf{q}=\\mathbf{k}} (p_y q_x - p_x q_y) (p_\\perp^2 - q_\\perp^2) \\phi_{\\mathbf{p}} \\phi_{\\mathbf{q}}\n$$\nThe problem requires computing the total energy transfer rate from drift waves to zonal flows. This involves summing $\\,T_{\\mathbf{k}}\\,$ over all zonal modes $\\,\\mathbf{k}\\,$ (where $\\,k_y=0, k_x \\neq 0\\,$), with the condition that the interacting triad partners $\\,\\mathbf{p}\\,$ and $\\,\\mathbf{q}\\,$ must both be drift-wave modes (i.e., $\\,p_y \\neq 0\\,$ and $\\,q_y \\neq 0\\,$).\nFor a zonal target mode $\\,\\mathbf{k}=(k_x, 0)\\,$, the triad condition $\\,\\mathbf{k}=\\mathbf{p}+\\mathbf{q}\\,$ implies $\\,p_y+q_y=0\\,$, or $\\,q_y=-p_y\\,$. Since $\\,\\mathbf{p}\\,$ and $\\,\\mathbf{q}\\,$ must both be drift waves, it means $\\,p_y \\neq 0\\,$.\n\nThe algorithm to be implemented is as follows:\n1. For each test case, parse the provided spectral data into a dictionary mapping wavevectors $\\,(k_x, k_y)\\,$ to their complex amplitudes $\\,\\phi_{k_x, k_y}\\,$.\n2. Identify the sets of zonal modes and drift-wave modes from the keys of this dictionary.\n3. Initialize the total drift-to-zonal energy transfer rate to zero.\n4. Iterate through each zonal mode $\\,\\mathbf{k}\\,$ as the target mode.\n5. For each $\\,\\mathbf{k}\\,$, compute its nonlinear drive $\\,J_{\\mathbf{k}}\\,$ by summing over all possible interacting partners $\\,\\mathbf{p}\\,$ that are drift waves. The second partner $\\,\\mathbf{q}\\,$ is determined by $\\,\\mathbf{q} = \\mathbf{k}-\\mathbf{p}\\,$. We must verify that this $\\,\\mathbf{q}\\,$ is also present in the given list of drift-wave modes.\n6. The summation counts each pair $\\,(\\mathbf{p},\\mathbf{q})\\,$ twice (once as $\\,(\\mathbf{p},\\mathbf{q})\\,$ and once as $\\,(\\mathbf{q},\\mathbf{p})\\,$), so the symmetrized formula with the factor of $\\,1/2\\,$ is correctly implemented by summing over all ordered pairs and dividing the result by $\\,2\\,$. The algorithm will iterate over $\\,\\mathbf{p}\\,$, find $\\,\\mathbf{q}\\,$, and perform the calculation; this naturally counts each interaction twice, so a final division by 2 is appropriate.\n7. The contribution to $\\,J_{\\mathbf{k}}\\,$ from a single triad $\\,(\\mathbf{k}, \\mathbf{p}, \\mathbf{q})\\,$ is given by the term inside the summation.\n8. Once $\\,J_{\\mathbf{k}}\\,$ is fully computed for a zonal mode $\\,\\mathbf{k}\\,$, the energy transfer rate into it is $\\,T_{\\mathbf{k}} = \\text{Re}(\\phi_{\\mathbf{k}}^* J_{\\mathbf{k}})\\,$.\n9. Sum $\\,T_{\\mathbf{k}}\\,$ over all zonal modes $\\,\\mathbf{k}\\,$ to get the total transfer rate for the given test case.\nThis procedure will be applied to all four test cases.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the nonlinear energy transfer rate from drift waves to zonal flows\n    for a series of test cases in a 2D gyrokinetic model.\n    \"\"\"\n\n    test_cases = [\n        # Case A: two drift waves forming a single zonal target\n        [((1, 1), 1.0 + 0.5j), ((1, -1), 0.7 - 0.2j), ((2, 0), 0.05 + 0.01j)],\n        # Case B: zonal-only configuration, no drift waves\n        [((1, 0), 0.4 + 0.0j), ((2, 0), -0.3 + 0.1j), ((-1, 0), 0.1 - 0.2j)],\n        # Case C: single drift wave plus a zonal, insufficient for a drift-drift triad\n        [((1, 1), 0.6 - 0.5j), ((2, 0), 0.2 + 0.05j)],\n        # Case D: multiple drift waves forming multiple zonal targets\n        [\n            ((2, 2), 0.8 + 0.3j), ((-1, -2), -0.5 + 0.1j), ((0, 3), 0.4 + 0.9j),\n            ((1, -3), 0.3 - 0.6j), ((1, 2), 0.6 - 0.1j), ((1, -2), -0.2 + 0.4j),\n            ((3, 2), 0.2 + 0.2j), ((1, 0), 0.15 - 0.05j), ((2, 0), -0.1 + 0.05j),\n            ((3, 0), 0.12 - 0.07j)\n        ],\n    ]\n\n    results = []\n    for case_modes in test_cases:\n        phi_map = {k_vec: amp for k_vec, amp in case_modes}\n        \n        all_k_vecs = set(phi_map.keys())\n        zonal_k_vecs = {k for k in all_k_vecs if k[1] == 0 and k[0] != 0}\n        drift_k_vecs = {k for k in all_k_vecs if k[1] != 0}\n\n        total_transfer_case = 0.0\n\n        if not drift_k_vecs:\n            results.append(0.0)\n            continue\n\n        for k_vec in zonal_k_vecs:\n            kx, ky = k_vec\n            \n            # This is the spectral representation of the Jacobian J(phi, zeta) for mode k.\n            J_k = 0.0j\n            \n            # Sum over all interacting drift-wave modes p.\n            for p_vec in drift_k_vecs:\n                px, py = p_vec\n                \n                # Determine the required partner mode q.\n                q_vec = (kx - px, ky - py)\n                \n                # Check if q is a drift wave and exists in the system.\n                # Since ky=0 and py!=0, qy=-py!=0, so q is automatically a drift wave.\n                # We only need to check if it's in the provided modes.\n                if q_vec not in drift_k_vecs:\n                    continue\n\n                qx, qy = q_vec\n                \n                phi_p = phi_map[p_vec]\n                phi_q = phi_map[q_vec]\n                \n                p_perp_sq = px**2 + py**2\n                q_perp_sq = qx**2 + qy**2\n                \n                # Symmetrized coupling coefficient for the triad (k, p, q)\n                # C(p,q) = (py*qx - px*qy) * (p_perp^2 - q_perp^2)\n                coupling_coeff = (py * qx - px * qy) * (p_perp_sq - q_perp_sq)\n                \n                J_k += coupling_coeff * phi_p * phi_q\n\n            # The loop over p_vec counts each (p,q) pair a second time as (q,p).\n            # The symmetric form of J_k requires a 1/2 factor to correct this.\n            J_k *= 0.5\n            \n            # Calculate energy transfer rate for mode k: T_k = Re(phi_k^* * J_k)\n            phi_k_conj = phi_map[k_vec].conjugate()\n            T_k = (phi_k_conj * J_k).real\n            \n            total_transfer_case += T_k\n\n        results.append(total_transfer_case)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}