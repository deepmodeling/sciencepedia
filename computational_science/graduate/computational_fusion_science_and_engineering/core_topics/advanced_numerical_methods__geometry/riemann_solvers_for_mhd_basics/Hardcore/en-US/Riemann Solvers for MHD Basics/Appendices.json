{
    "hands_on_practices": [
        {
            "introduction": "Degenerate states in Magnetohydrodynamics (MHD), where distinct characteristic wave speeds collapse, pose a significant challenge for many numerical schemes. A classic example is the case with a vanishing normal magnetic field component ($B_x \\to 0$), where several wave families travel at the same speed, making a full characteristic decomposition of the wave structure impossible. This practice introduces the Harten–Lax–van Leer–Einfeldt (HLLE) solver, a robust approximate Riemann solver that circumvents these degeneracies by constructing a simplified two-wave model of the Riemann fan. By manually calculating the HLLE flux for a specific degenerate Riemann problem , you will gain a concrete understanding of how this solver ensures stability and produces a physically reasonable, albeit diffusive, solution where more complex solvers might fail.",
            "id": "4041169",
            "problem": "Consider the one-dimensional ideal Magnetohydrodynamics (MHD) Riemann problem in Cartesian geometry along the $x$-direction, with nondimensional units where magnetic permeability is unity and all quantities are expressed in code units. The ideal MHD conserved state vector and flux in the $x$-direction are defined by the standard conservation laws with total energy, momentum, and magnetic field consistent with divergence-free magnetic field ($\\partial B_x/\\partial x = 0$). The adiabatic index is $\\gamma = 5/3$. The left and right primitive states at the interface $x=0$ are symmetric and given by\n$$\n\\rho_L = 1,\\quad p_L = 1,\\quad u_{x,L} = \\frac{1}{2},\\quad u_{y,L} = 0,\\quad u_{z,L} = 0,\\quad B_{x} = 0,\\quad B_{y,L} = 1,\\quad B_{z,L} = 0,\n$$\n$$\n\\rho_R = 1,\\quad p_R = 1,\\quad u_{x,R} = -\\frac{1}{2},\\quad u_{y,R} = 0,\\quad u_{z,R} = 0,\\quad B_{x} = 0,\\quad B_{y,R} = -1,\\quad B_{z,R} = 0.\n$$\nStarting from the conservation form of the ideal MHD equations and the characteristic wave families, explain the degeneracy and expected compound wave behavior in the limit $B_x \\to 0$, and justify the use of a two-wave Harten–Lax–van Leer–Einfeldt (HLLE) Riemann solver for robustness in this degenerate limit. Then, using fast magnetosonic bounding speeds computed self-consistently from the given left/right states, compute the HLLE numerical flux vector at $x=0$ for the conserved variables ordered as\n$$\n\\left[\\rho,\\ \\rho u_x,\\ \\rho u_y,\\ \\rho u_z,\\ B_y,\\ B_z,\\ E\\right],\n$$\nwhere the total energy is $E = \\frac{p}{\\gamma-1} + \\frac{1}{2}\\rho\\left(u_x^2 + u_y^2 + u_z^2\\right) + \\frac{1}{2}\\left(B_x^2 + B_y^2 + B_z^2\\right)$ and the $x$-flux of total energy is $(E + p_t)u_x - B_x(u_x B_x + u_y B_y + u_z B_z)$ with $p_t = p + \\frac{1}{2}(B_x^2 + B_y^2 + B_z^2)$. Express your final flux in exact analytical form. Do not include units in the final answer and do not round.",
            "solution": "The problem requires explaining the wave degeneracy for $B_x \\to 0$ and then calculating the Harten–Lax–van Leer–Einfeldt (HLLE) flux for the given states.\n\nIn the limit $B_x \\to 0$, the Alfvén speed $v_{Ax} = |B_x|/\\sqrt{\\rho}$ vanishes. This leads to a critical degeneracy in the MHD wave speeds. The seven characteristic speeds, normally distinct, collapse. Specifically, the two Alfvén waves, two slow magnetosonic waves, and the contact discontinuity all propagate at the fluid velocity $u_x$. This five-fold degeneracy means the system's Jacobian matrix is non-diagonalizable, causing solvers that rely on a full characteristic decomposition (like the Roe solver) to fail.\n\nThe HLLE solver is a robust alternative that assumes a simplified two-wave structure bounded by the fastest left-going ($S_L$) and right-going ($S_R$) signal speeds. Its flux formula is:\n$$\n\\mathbf{F}_{HLLE} = \\frac{S_R \\mathbf{F}_L - S_L \\mathbf{F}_R + S_L S_R (\\mathbf{U}_R - \\mathbf{U}_L)}{S_R - S_L}\n$$\nThis formulation's robustness stems from its simplicity, making it insensitive to wave degeneracies.\n\n**Step 1: Compute Left/Right State and Flux Vectors**\nGiven $\\gamma = 5/3$.\nLeft State ($L$): $\\rho_L=1, p_L=1, u_{x,L}=1/2, u_{y,L}=0, u_{z,L}=0, B_x=0, B_{y,L}=1, B_{z,L}=0$.\nRight State ($R$): $\\rho_R=1, p_R=1, u_{x,R}=-1/2, u_{y,R}=0, u_{z,R}=0, B_x=0, B_{y,R}=-1, B_{z,R}=0$.\n\nTotal energy $E$:\n$E_L = \\frac{p_L}{\\gamma-1} + \\frac{1}{2}\\rho_L(u_{x,L}^2+u_{y,L}^2+u_{z,L}^2) + \\frac{1}{2}(B_x^2+B_{y,L}^2+B_{z,L}^2) = \\frac{1}{2/3} + \\frac{1}{2}(1)(\\frac{1}{4}) + \\frac{1}{2}(1) = \\frac{3}{2} + \\frac{1}{8} + \\frac{1}{2} = \\frac{17}{8}$.\nBy symmetry, $E_R = E_L = 17/8$.\n\nConserved state vectors $\\mathbf{U}_L$ and $\\mathbf{U}_R$:\n$\\mathbf{U}_L = [1, 1/2, 0, 0, 1, 0, 17/8]^T$.\n$\\mathbf{U}_R = [1, -1/2, 0, 0, -1, 0, 17/8]^T$.\n\nTotal pressure $p_t = p + \\frac{1}{2}(B_y^2+B_z^2)$:\n$p_{t,L} = 1 + \\frac{1}{2}(1^2) = 3/2$.\n$p_{t,R} = 1 + \\frac{1}{2}((-1)^2) = 3/2$.\n\nFlux vectors $\\mathbf{F}_L$ and $\\mathbf{F}_R$ (with $B_x=0$):\n$\\mathbf{F}_L = [\\rho_L u_{x,L}, \\rho_L u_{x,L}^2+p_{t,L}, \\rho_L u_{x,L} u_{y,L}, \\rho_L u_{x,L} u_{z,L}, u_{x,L}B_{y,L}, u_{x,L}B_{z,L}, (E_L+p_{t,L})u_{x,L}]^T = [1/2, 1(1/4)+3/2, 0, 0, 1/2, 0, (17/8+12/8)(1/2)]^T = [1/2, 7/4, 0, 0, 1/2, 0, 29/16]^T$.\n$\\mathbf{F}_R = [\\rho_R u_{x,R}, \\rho_R u_{x,R}^2+p_{t,R}, \\dots]^T = [-1/2, 1(1/4)+3/2, 0, 0, (-1/2)(-1), 0, (29/8)(-1/2)]^T = [-1/2, 7/4, 0, 0, 1/2, 0, -29/16]^T$.\n\n**Step 2: Compute Signal Speeds**\nThe bounding speeds are $S_L = \\min(u_{x,L} - c_{f,L}, u_{x,R} - c_{f,R})$ and $S_R = \\max(u_{x,L} + c_{f,L}, u_{x,R} + c_{f,R})$.\nFor $B_x=0$, the fast magnetosonic speed squared is $c_f^2 = (\\gamma p + B_y^2 + B_z^2)/\\rho$.\n$c_{f,L}^2 = ((5/3)(1) + 1^2)/1 = 8/3 \\implies c_{f,L} = \\sqrt{8/3}$.\n$c_{f,R}^2 = ((5/3)(1) + (-1)^2)/1 = 8/3 \\implies c_{f,R} = \\sqrt{8/3}$.\n$S_L = \\min(1/2 - \\sqrt{8/3}, -1/2 - \\sqrt{8/3}) = -1/2 - \\sqrt{8/3}$.\n$S_R = \\max(1/2 + \\sqrt{8/3}, -1/2 + \\sqrt{8/3}) = 1/2 + \\sqrt{8/3}$.\nBy symmetry, $S_L = -S_R$.\n\n**Step 3: Compute HLLE Flux**\nFor $S_L = -S_R$, the HLLE flux formula simplifies:\n$$\n\\mathbf{F}_{HLLE} = \\frac{1}{2}(\\mathbf{F}_L + \\mathbf{F}_R) - \\frac{S_R}{2}(\\mathbf{U}_R - \\mathbf{U}_L)\n$$\nWe have:\n$\\mathbf{F}_L + \\mathbf{F}_R = [0, 7/2, 0, 0, 1, 0, 0]^T$.\n$\\mathbf{U}_R - \\mathbf{U}_L = [0, -1, 0, 0, -2, 0, 0]^T$.\n\nSubstituting into the formula:\n$$\n\\mathbf{F}_{HLLE} = \\frac{1}{2} \\begin{pmatrix} 0 \\\\ 7/2 \\\\ 0 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix} - \\frac{1/2 + \\sqrt{8/3}}{2} \\begin{pmatrix} 0 \\\\ -1 \\\\ 0 \\\\ 0 \\\\ -2 \\\\ 0 \\\\ 0 \\end{pmatrix}\n$$\nThe non-zero components are:\nFlux of $\\rho u_x$: $\\frac{1}{2}(\\frac{7}{2}) - \\frac{1/2 + \\sqrt{8/3}}{2}(-1) = \\frac{7}{4} + \\frac{1}{4} + \\frac{\\sqrt{8/3}}{2} = 2 + \\frac{1}{2}\\frac{2\\sqrt{2}}{\\sqrt{3}} = 2 + \\frac{\\sqrt{6}}{3}$.\nFlux of $B_y$: $\\frac{1}{2}(1) - \\frac{1/2 + \\sqrt{8/3}}{2}(-2) = \\frac{1}{2} + \\frac{1}{2} + \\sqrt{8/3} = 1 + \\frac{2\\sqrt{2}}{\\sqrt{3}} = 1 + \\frac{2\\sqrt{6}}{3}$.\n\nThe final HLLE numerical flux vector is:\n$$\n\\mathbf{F}_{HLLE} = \\left[ 0, \\ 2 + \\frac{\\sqrt{6}}{3}, \\ 0, \\ 0, \\ 1 + \\frac{2\\sqrt{6}}{3}, \\ 0, \\ 0 \\right]^T\n$$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0 & 2 + \\frac{\\sqrt{6}}{3} & 0 & 0 & 1 + \\frac{2\\sqrt{6}}{3} & 0 & 0 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Moving beyond a single calculation, a critical skill in computational science is the ability to write code that not only implements an algorithm but also actively monitors its own performance and validity. In complex systems like MHD, where non-physical states (e.g., negative pressure) or numerical instabilities can arise, robust diagnostics are not just helpful but essential for code verification. This exercise involves implementing a basic Harten-Lax-van Leer (HLL) Riemann solver and designing a suite of diagnostics to probe its behavior across a range of challenging test cases. By programming these automated checks , you will learn to identify conditions that require special numerical handling, such as near-degenerate wave speeds or the formation of unphysical intermediate states, a crucial step in developing reliable and trustworthy simulation codes.",
            "id": "4041223",
            "problem": "Consider the one-dimensional Riemann problem for ideal magnetohydrodynamics (MHD) along the $x$-direction, appropriate to magnetized shock tube configurations used in computational fusion science and engineering. The conservative state vector is $U = (\\rho, \\rho v_x, \\rho v_y, \\rho v_z, E, B_x, B_y, B_z)$, where $\\rho$ is mass density, $(v_x, v_y, v_z)$ is velocity, $(B_x, B_y, B_z)$ is magnetic field, and $E$ is total energy. The ideal gas law is assumed with ratio of specific heats $\\gamma$, and dimensionless units are used (no physical units are required). The one-dimensional flux in the $x$-direction is $F(U)$ determined by the ideal MHD equations. Let the gas pressure be $p$, the total pressure be $p_t = p + \\frac{1}{2} \\lVert B \\rVert^2$, and define $E = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho \\lVert v \\rVert^2 + \\frac{1}{2}\\lVert B \\rVert^2$, with $\\lVert v \\rVert^2 = v_x^2 + v_y^2 + v_z^2$ and $\\lVert B \\rVert^2 = B_x^2 + B_y^2 + B_z^2$. The flux components along $x$ are:\n$$F_\\rho = \\rho v_x,$$\n$$F_{\\rho v_x} = \\rho v_x^2 + p_t - B_x^2,$$\n$$F_{\\rho v_y} = \\rho v_x v_y - B_x B_y,$$\n$$F_{\\rho v_z} = \\rho v_x v_z - B_x B_z,$$\n$$F_E = (E + p_t) v_x - B_x (v_x B_x + v_y B_y + v_z B_z),$$\n$$F_{B_x} = 0,$$\n$$F_{B_y} = B_y v_x - B_x v_y,$$\n$$F_{B_z} = B_z v_x - B_x v_z.$$\nThe one-dimensional ideal MHD eigenstructure along $x$ contains seven characteristic speeds. Let the sound speed squared be $a^2 = \\gamma p/\\rho$, the Alfvén speed squared based on total field be $v_A^2 = \\lVert B \\rVert^2/\\rho$, and the Alfvén speed squared along $x$ be $v_{Ax}^2 = B_x^2/\\rho$. The fast and slow magnetosonic speeds are obtained from the roots\n$$c_{f,s}^2 = \\frac{1}{2}\\left[a^2 + v_A^2 \\pm \\sqrt{(a^2 + v_A^2)^2 - 4 a^2 v_{Ax}^2}\\right],$$\nand the Alfvén speed along $x$ is $c_A = \\sqrt{v_{Ax}^2}$. The seven characteristic speeds are $v_x \\pm c_f$, $v_x \\pm c_A$, $v_x \\pm c_s$, and $v_x$. Degeneracy occurs when the square-root discriminant approaches zero, or when characteristic speeds coalesce, which is common near the Brio–Wu shock tube configuration when $B_x$ is small or tangential magnetic components reverse.\n\nTask. Starting from the above conservative and flux forms and the ideal MHD eigenstructure definitions, implement an approximate Riemann solver using the Harten–Lax–van Leer (HLL) two-wave approximation with Davis wave-speed estimates $S_L = \\min(v_{x,L} - c_{f,L}, v_{x,R} - c_{f,R})$ and $S_R = \\max(v_{x,L} + c_{f,L}, v_{x,R} + c_{f,R})$, where subscripts $L$ and $R$ denote left and right states. Construct the HLL intermediate state $U^\\star$ only when $S_L < 0 < S_R$, otherwise use the upwind flux. From $U^\\star$, compute the implied intermediate density $\\rho^\\star$ and gas pressure $p^\\star = (\\gamma - 1)\\left(E^\\star - \\frac{1}{2}\\rho^\\star \\lVert v^\\star \\rVert^2 - \\frac{1}{2}\\lVert B^\\star \\rVert^2\\right)$.\n\nDesign and compute the following diagnostics for each test case:\n- An eigenvalue spacing diagnostic defined as the minimum gap between sorted characteristic speeds at the left and right states, normalized by the maximum absolute speed over both states: $$g = \\frac{\\min\\left(\\Delta \\lambda_L, \\Delta \\lambda_R\\right)}{\\max\\left(\\max|\\lambda_L|, \\max|\\lambda_R|, \\varepsilon\\right)},$$ where $\\Delta \\lambda$ is the minimum adjacent difference within the sorted list of seven speeds, and $\\varepsilon$ is a small positive number to avoid division by zero chosen as $\\varepsilon = 10^{-12}$.\n- A positivity diagnostic $q$ equal to $1$ if both $\\rho^\\star > 0$ and $p^\\star > 0$ when the HLL intermediate state exists, and equal to $1$ if no intermediate state is constructed (i.e., purely upwind flux is used). Otherwise set $q = 0$.\n- A tangential reversal diagnostic $r$ equal to $1$ if $B_{y,L} B_{y,R} < 0$ or $B_{z,L} B_{z,R} < 0$, else $0$.\n- A special handling flag $h$ equal to $1$ if either $g < 10^{-3}$, or $q = 0$, or $(r = 1$ and $|B_x| < 10^{-2})$, otherwise $0$.\n\nYour program must compute these diagnostics for the following set of left–right states, all with $\\gamma = 2$ and shared $B_x$ per case, representing a test suite that exercises typical, near-degenerate, and boundary behaviors:\n- Case $1$ (canonical Brio–Wu-like): left $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (1, 1, 0, 0, 0, 0.75, 1, 0)$; right $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (0.125, 0.1, 0, 0, 0, 0.75, -1, 0)$.\n- Case $2$ (near-degenerate $B_x$): same as Case $1$ but with $B_x = 10^{-6}$ for both left and right.\n- Case $3$ (low-pressure stress test): left $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (1, 10^{-3}, 0, 0, 0, 0.75, 1, 0)$; right $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (0.125, 10^{-6}, 0, 0, 0, 0.75, -1, 0)$.\n- Case $4$ (no tangential field): left $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (1, 1, 0, 0, 0, 0.75, 0, 0)$; right $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (0.125, 0.1, 0, 0, 0, 0.75, 0, 0)$.\n- Case $5$ (equal states): left equals right $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z) = (1, 1, 0, 0, 0, 0.75, 0, 0)$.\n\nAll quantities are dimensionless. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a four-element list $[g, q, r, h]$ with $g$ printed as a floating-point number rounded to six decimal places, and $q$, $r$, $h$ printed as integers. The overall output format is therefore a list of lists, for example $[[g_1,q_1,r_1,h_1],[g_2,q_2,r_2,h_2],\\dots]$.",
            "solution": "The solution requires implementing the specified calculations in a structured manner for each test case. For each pair of left ($L$) and right ($R$) initial states, four diagnostic quantities are computed: an eigenvalue spacing metric $g$, a positivity-of-solution metric $q$, a tangential field reversal metric $r$, and a composite special handling flag $h$.\n\nThe logical flow for processing each test case is as follows:\n\nFirst, we represent the fluid states. The problem provides initial states in primitive variables $(\\rho, p, v_x, v_y, v_z, B_x, B_y, B_z)$. The MHD equations are formulated in terms of a conservative state vector $U = (\\rho, \\rho v_x, \\rho v_y, \\rho v_z, E, B_x, B_y, B_z)^T$. The total energy density, $E$, is related to the primitive variables via the ideal gas law with a ratio of specific heats $\\gamma$:\n$$E = \\frac{p}{\\gamma - 1} + \\frac{1}{2}\\rho \\lVert \\vec{v} \\rVert^2 + \\frac{1}{2}\\lVert \\vec{B} \\rVert^2$$\nA necessary initial step is to convert the given left and right primitive states into their conservative vector form, $U_L$ and $U_R$.\n\nSecond, we compute the characteristic wave speeds for both left and right states. These speeds are the eigenvalues of the Jacobian matrix $\\partial F / \\partial U$. The problem provides the standard formulas for the seven one-dimensional characteristic speeds along the $x$-direction: $v_x$, $v_x \\pm c_s$, $v_x \\pm c_A$, and $v_x \\pm c_f$. Calculation of these speeds requires several intermediate physical quantities for each state, including the sound speed ($a$), total Alfvén speed ($v_A$), and normal-component Alfvén speed ($v_{Ax}$), leading to the fast ($c_f$) and slow ($c_s$) magnetosonic speeds.\n\nThird, we compute the four specified diagnostics, which requires the implementation of the Harten-Lax-van Leer (HLL) Riemann solver logic.\n\n1.  **Eigenvalue Spacing Diagnostic $g$**: This metric quantifies the degree of degeneracy among the characteristic speeds. For each state ($L$ and $R$), we form a sorted list of the seven eigenvalues, $\\lambda$. We then find the minimum difference between adjacent eigenvalues, $\\Delta \\lambda = \\min_i (\\lambda_{i+1} - \\lambda_i)$. The diagnostic $g$ is then calculated as:\n    $$g = \\frac{\\min\\left(\\Delta \\lambda_L, \\Delta \\lambda_R\\right)}{\\max\\left(\\max|\\lambda_L|, \\max|\\lambda_R|, \\varepsilon\\right)}$$\n    where $\\varepsilon$ is a small regularization parameter ($10^{-12}$).\n\n2.  **Tangential Reversal Diagnostic $r$**: This checks for a sign change in the tangential components of the magnetic field across the interface:\n    $$r = 1 \\text{ if } (B_{y,L} B_{y,R} < 0) \\text{ or } (B_{z,L} B_{z,R} < 0), \\text{ otherwise } r = 0.$$\n\n3.  **Positivity Diagnostic $q$**: This diagnostic verifies if the HLL solver maintains the physical positivity of density and pressure. We first compute the HLL signal speeds using the Davis estimates:\n    $$S_L = \\min(v_{x,L} - c_{f,L}, v_{x,R} - c_{f,R})$$\n    $$S_R = \\max(v_{x,L} + c_{f,L}, v_{x,R} + c_{f,R})$$\n    If $S_L < 0 < S_R$, an intermediate HLL state $U^\\star$ is computed from the integral form of the conservation laws:\n    $$U^\\star = \\frac{S_R U_R - S_L U_L - (F_R - F_L)}{S_R - S_L}$$\n    From the components of $U^\\star$, we extract the intermediate density $\\rho^\\star$ and calculate the intermediate pressure $p^\\star$:\n    $$p^\\star = (\\gamma - 1)\\left(E^\\star - \\frac{1}{2}\\rho^\\star \\lVert \\vec{v}^\\star \\rVert^2 - \\frac{1}{2}\\lVert \\vec{B}^\\star \\rVert^2\\right)$$\n    The diagnostic $q$ is set to $1$ if both $\\rho^\\star > 0$ and $p^\\star > 0$. Otherwise, $q$ is $0$. If $S_L < 0 < S_R$ is not met, no intermediate state is formed, and $q$ is set to $1$.\n\n4.  **Special Handling Flag $h$**: This is a composite flag that aggregates indicators of numerical difficulty. It is set to $1$ if any of the following conditions are met, and $0$ otherwise:\n    $$h = 1 \\text{ if } (g < 10^{-3}) \\text{ or } (q = 0) \\text{ or } (r = 1 \\text{ and } |B_x| < 10^{-2})$$\n\nThis complete logical framework is implemented for each of the five test cases, and the resulting four-component diagnostic vectors $[g, q, r, h]$ are formatted as specified.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    gamma = 2.0\n    epsilon = 1e-12\n\n    test_cases = [\n        # Case 1: Canonical Brio-Wu-like\n        {'p_left': (1.0, 1.0, 0.0, 0.0, 0.0, 0.75, 1.0, 0.0),\n         'p_right': (0.125, 0.1, 0.0, 0.0, 0.0, 0.75, -1.0, 0.0)},\n        # Case 2: Near-degenerate Bx\n        {'p_left': (1.0, 1.0, 0.0, 0.0, 0.0, 1e-6, 1.0, 0.0),\n         'p_right': (0.125, 0.1, 0.0, 0.0, 0.0, 1e-6, -1.0, 0.0)},\n        # Case 3: Low-pressure stress test\n        {'p_left': (1.0, 1e-3, 0.0, 0.0, 0.0, 0.75, 1.0, 0.0),\n         'p_right': (0.125, 1e-6, 0.0, 0.0, 0.0, 0.75, -1.0, 0.0)},\n        # Case 4: No tangential field\n        {'p_left': (1.0, 1.0, 0.0, 0.0, 0.0, 0.75, 0.0, 0.0),\n         'p_right': (0.125, 0.1, 0.0, 0.0, 0.0, 0.75, 0.0, 0.0)},\n        # Case 5: Equal states\n        {'p_left': (1.0, 1.0, 0.0, 0.0, 0.0, 0.75, 0.0, 0.0),\n         'p_right': (1.0, 1.0, 0.0, 0.0, 0.0, 0.75, 0.0, 0.0)}\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result = compute_diagnostics(case['p_left'], case['p_right'], gamma, epsilon)\n        all_results.append(result)\n\n    formatted_results = []\n    for res in all_results:\n        g, q, r, h = res\n        formatted_results.append(f\"[{g:.6f},{q},{r},{h}]\")\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\ndef primitive_to_conservative(prim, gamma):\n    \"\"\"\n    Converts primitive variables (rho, p, vx, vy, vz, Bx, By, Bz)\n    to conservative variables (rho, rho*vx, rho*vy, rho*vz, E, Bx, By, Bz).\n    \"\"\"\n    rho, p, vx, vy, vz, Bx, By, Bz = prim\n    v_sq = vx**2 + vy**2 + vz**2\n    B_sq = Bx**2 + By**2 + Bz**2\n    \n    E = p / (gamma - 1) + 0.5 * rho * v_sq + 0.5 * B_sq\n    \n    return np.array([rho, rho * vx, rho * vy, rho * vz, E, Bx, By, Bz])\n\ndef calculate_flux(prim, cons, gamma):\n    \"\"\"\n    Calculates the 1D MHD flux vector F(U) in the x-direction.\n    \"\"\"\n    rho, p, vx, vy, vz, Bx, By, Bz = prim\n    E = cons[4]\n    \n    B_sq = Bx**2 + By**2 + Bz**2\n    pt = p + 0.5 * B_sq\n    v_dot_B = vx * Bx + vy * By + vz * Bz\n\n    F = np.zeros(8)\n    F[0] = rho * vx\n    F[1] = rho * vx**2 + pt - Bx**2\n    F[2] = rho * vx * vy - Bx * By\n    F[3] = rho * vx * vz - Bx * Bz\n    F[4] = (E + pt) * vx - Bx * v_dot_B\n    F[5] = 0\n    F[6] = By * vx - Bx * vy\n    F[7] = Bz * vx - Bx * vz\n    \n    return F\n\ndef calculate_speeds(prim, gamma):\n    \"\"\"\n    Calculates the seven characteristic speeds for a given state.\n    Returns a sorted list of speeds and the fast magnetosonic speed cf.\n    \"\"\"\n    rho, p, vx, vy, vz, Bx, By, Bz = prim\n    \n    if rho <= 0:\n        return np.zeros(7), 0.0\n\n    a2 = gamma * p / rho\n    B_sq = Bx**2 + By**2 + Bz**2\n    va2 = B_sq / rho\n    vax2 = Bx**2 / rho\n    \n    # Ensure discriminant is non-negative\n    term = (a2 + va2)**2 - 4 * a2 * vax2\n    discriminant_sqrt = np.sqrt(max(0, term))\n    \n    cf2 = 0.5 * (a2 + va2 + discriminant_sqrt)\n    cs2 = 0.5 * (a2 + va2 - discriminant_sqrt)\n    \n    cf = np.sqrt(cf2)\n    cs = np.sqrt(cs2)\n    ca = np.sqrt(vax2)\n    \n    speeds = sorted([vx - cf, vx + cf, vx - ca, vx + ca, vx - cs, vx + cs, vx])\n    return np.array(speeds), cf\n\ndef compute_diagnostics(p_left, p_right, gamma, epsilon):\n    \"\"\"\n    Computes the diagnostics g, q, r, h for a given left/right state.\n    \"\"\"\n    # Unpack primitives\n    rho_L, p_L, vx_L, vy_L, vz_L, Bx_L, By_L, Bz_L = p_left\n    rho_R, p_R, vx_R, vy_R, vz_R, Bx_R, By_R, Bz_R = p_right\n    \n    # Diagnostic g: Eigenvalue spacing\n    speeds_L, cf_L = calculate_speeds(p_left, gamma)\n    speeds_R, cf_R = calculate_speeds(p_right, gamma)\n    \n    delta_lambda_L = np.min(np.diff(speeds_L)) if len(speeds_L) > 1 else np.inf\n    delta_lambda_R = np.min(np.diff(speeds_R)) if len(speeds_R) > 1 else np.inf\n    \n    min_delta_lambda = min(delta_lambda_L, delta_lambda_R)\n    max_abs_speed = max(np.max(np.abs(speeds_L)), np.max(np.abs(speeds_R)), epsilon)\n    \n    g = min_delta_lambda / max_abs_speed\n\n    # Diagnostic r: Tangential reversal\n    r = 1 if (By_L * By_R < 0) or (Bz_L * Bz_R < 0) else 0\n\n    # Diagnostic q: Positivity\n    S_L = min(vx_L - cf_L, vx_R - cf_R)\n    S_R = max(vx_L + cf_L, vx_R + cf_R)\n    \n    q = 1 # Default value\n    if S_L < 0 < S_R:\n        U_L = primitive_to_conservative(p_left, gamma)\n        U_R = primitive_to_conservative(p_right, gamma)\n        \n        F_L = calculate_flux(p_left, U_L, gamma)\n        F_R = calculate_flux(p_right, U_R, gamma)\n        \n        U_star = (S_R * U_R - S_L * U_L - (F_R - F_L)) / (S_R - S_L)\n\n        rho_star = U_star[0]\n        if rho_star <= 0:\n            q = 0\n        else:\n            mom_x_star, mom_y_star, mom_z_star = U_star[1], U_star[2], U_star[3]\n            E_star = U_star[4]\n            Bx_star, By_star, Bz_star = U_star[5], U_star[6], U_star[7]\n            \n            v_sq_star = (mom_x_star**2 + mom_y_star**2 + mom_z_star**2) / rho_star**2\n            B_sq_star = Bx_star**2 + By_star**2 + Bz_star**2\n            \n            p_star = (gamma - 1) * (E_star - 0.5 * rho_star * v_sq_star - 0.5 * B_sq_star)\n            \n            if p_star <= 0:\n                q = 0\n    else:\n        # Per problem, upwind case considered positive\n        q = 1\n\n    # Diagnostic h: Special handling flag\n    # Bx is common to left and right states\n    Bx = Bx_L \n    h = 1 if (g < 1e-3) or (q == 0) or (r == 1 and abs(Bx) < 1e-2) else 0\n\n    return [g, q, r, h]\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "While robust solvers like HLL are invaluable, scientific simulations often demand higher accuracy to resolve fine-scale structures, motivating the use of more sophisticated methods like the Roe solver. However, these high-resolution schemes can introduce unique numerical artifacts, such as entropy-violating expansion shocks, particularly near \"sonic points\" where a characteristic speed passes through zero. This problem explores the concept of an \"entropy fix,\" a targeted modification to the numerical dissipation within a Roe-type solver that adds just enough diffusion to regularize the solution and prevent the formation of these unphysical shocks. This practice  challenges you to think critically about the core principles of finite-volume schemes, analyzing how to implement a necessary numerical correction while rigorously preserving the fundamental conservation law that the entire method is designed to solve.",
            "id": "4041240",
            "problem": "Consider a one-dimensional interface at location $x_{i+\\frac{1}{2}}$ in a finite-volume discretization of the ideal Magnetohydrodynamics (MHD) equations, written in conservative form as $\\partial_t U + \\partial_x F(U) = 0$, where $U$ is the vector of conserved variables and $F(U)$ is the flux vector. The interface has left and right reconstructed states $U_L$ and $U_R$, and the finite-volume update of the cell-averaged conserved variables $U_i$ is of the form $U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)$. A Roe-type solver uses a linearization of the flux Jacobian $A = \\partial F/\\partial U$ about a Roe-averaged state $\\tilde{U}$ at the interface and its right-eigenvector matrix $R(\\tilde{U})$ and eigenvalues $\\{\\tilde{\\lambda}_p\\}$ to construct a numerical flux\n$$\nF_{i+\\frac{1}{2}} = \\frac{1}{2}\\left(F(U_L) + F(U_R)\\right) - \\frac{1}{2}\\, R(\\tilde{U})\\, \\Phi(\\Lambda)\\, R(\\tilde{U})^{-1}\\, (U_R - U_L),\n$$\nwhere $\\Lambda = \\mathrm{diag}(\\tilde{\\lambda}_1,\\dots,\\tilde{\\lambda}_m)$ and $m$ is the number of waves in the one-dimensional MHD Riemann problem, and $\\Phi(\\Lambda)$ is a diagonal matrix that reduces to $\\mathrm{diag}(|\\tilde{\\lambda}_1|,\\dots,|\\tilde{\\lambda}_m|)$ in the absence of any special treatment. It is observed in computational fusion plasma simulations that near sonic or Alfvénic degeneracy where $\\tilde{\\lambda}_p \\approx 0$, Roe-type solvers can admit entropy-violating expansion shocks unless an entropy fix is applied. An entropy fix can be achieved by locally modifying the characteristic speeds used in the dissipation term, for example replacing $|\\tilde{\\lambda}_p|$ by a smoothed magnitude $\\phi(\\tilde{\\lambda}_p;\\delta)$ that depends on a local threshold $\\delta > 0$ computed from interface states, with $\\phi(\\tilde{\\lambda}_p;\\delta) = |\\tilde{\\lambda}_p|$ for $|\\tilde{\\lambda}_p| \\ge \\delta$ and $\\phi(\\tilde{\\lambda}_p;\\delta)$ a strictly increasing, even function for $|\\tilde{\\lambda}_p| < \\delta$ to avoid vanishing dissipation.\n\nFrom the fundamental base consisting of the conservation law $\\partial_t U + \\partial_x F(U) = 0$, the finite-volume update $U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)$, and the Roe linearization of $A$ with eigen-decomposition, reason through how an entropy fix implemented by modifying eigenvalues near degeneracies must be coupled to corresponding flux corrections to preserve conservation of $U$. In particular, explain what objects in the numerical flux must be altered and which must be left unchanged to ensure that the resulting update remains conservative and respects the entropy condition.\n\nWhich of the following prescriptions correctly implements an entropy fix by locally modifying eigenvalues and ensures conservation through appropriate flux corrections in a one-dimensional ideal MHD Roe-type solver?\n\nA. Replace each $|\\tilde{\\lambda}_p|$ in the dissipation term by $\\phi(\\tilde{\\lambda}_p;\\delta)$ at the interface, leaving $R(\\tilde{U})$ and $R(\\tilde{U})^{-1}$ as computed from the Roe-averaged state, and recompute the single interface flux $F_{i+\\frac{1}{2}}$ using the modified diagonal matrix $\\Phi(\\Lambda) = \\mathrm{diag}(\\phi(\\tilde{\\lambda}_1;\\delta),\\dots,\\phi(\\tilde{\\lambda}_m;\\delta))$ without altering $U_L$ or $U_R$; update $U_i$ via the conservative flux difference.\n\nB. Modify the primitive variables near the interface by adding a small offset to velocity components when $|\\tilde{\\lambda}_p|$ is small, then compute $F_{i+\\frac{1}{2}}$ from these altered states using the original dissipation matrix with $|\\tilde{\\lambda}_p|$, and finally project back to conserved variables for the update.\n\nC. Globally floor the magnitudes of all eigenvalues by enforcing $|\\tilde{\\lambda}_p| \\ge \\delta$ in every cell, but keep the original dissipation matrix at interfaces; to offset the excess dissipation near sonic points, add a non-conservative source term $S_i$ to the update $U_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right) + \\Delta t\\, S_i$.\n\nD. Adjust the right-eigenvectors $R(\\tilde{U})$ by an ad hoc rotation near degeneracy to avoid close alignment of slow and Alfvén waves, keep $|\\tilde{\\lambda}_p|$ unchanged in the dissipation term, and compute $F_{i+\\frac{1}{2}}$ as usual.\n\nE. Switch to the Harten–Lax–van Leer (HLL) flux by estimating left and right signal speeds $S_L$ and $S_R$ from the minimum and maximum of locally modified eigenvalues, and then add the Roe-type dissipation term with unmodified $|\\tilde{\\lambda}_p|$ on top of the HLL flux at each interface to ensure conservation.\n\nSelect the option that is consistent with the stated requirements and justify how it follows from the conservation law, finite-volume formulation, and eigen-decomposition principles for the one-dimensional MHD Riemann problem.",
            "solution": "The problem asks to identify the correct procedure for implementing an entropy fix in a one-dimensional ideal Magnetohydrodynamics (MHD) Roe-type solver, ensuring that the numerical scheme remains conservative.\n\nThe fundamental requirement of a conservative numerical scheme for a law of the form $\\partial_t U + \\partial_x F(U) = 0$ is that the update can be written in \"flux-difference\" form:\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)\n$$\nThis form guarantees that when the total change of the quantity $U$ is summed over a domain of cells, the internal fluxes cancel in a telescoping series, leaving only the fluxes at the domain boundaries. This numerically mimics the integral form of the conservation law, $\\frac{d}{dt} \\int_{x_a}^{x_b} U dx = F(U(x_a)) - F(U(x_b))$. This cancellation requires that the numerical flux $F_{i+\\frac{1}{2}}$ is a single-valued function computed at the interface between cell $i$ and cell $i+1$, based on the states on either side. That is, the flux leaving cell $i$ must be identical to the flux entering cell $i+1$.\n\nThe Roe numerical flux is given as:\n$$\nF_{i+\\frac{1}{2}} = \\frac{1}{2}\\left(F(U_L) + F(U_R)\\right) - \\frac{1}{2} D_{i+\\frac{1}{2}}\n$$\nwhere the second term, $D_{i+\\frac{1}{2}} = R(\\tilde{U})\\, \\Phi(\\Lambda)\\, R(\\tilde{U})^{-1}\\, (U_R - U_L)$, represents the numerical dissipation.\n\nThe problem states that an entropy fix is needed for cases where an eigenvalue $\\tilde{\\lambda}_p$ approaches zero, causing the corresponding dissipation $|\\tilde{\\lambda}_p|$ to vanish and admitting an unphysical expansion shock. The fix involves replacing $|\\tilde{\\lambda}_p|$ with a function $\\phi(\\tilde{\\lambda}_p;\\delta)$ that ensures dissipation does not vanish within a certain range $|\\tilde{\\lambda}_p| < \\delta$. This modification directly affects the dissipation matrix, which becomes:\n$$\n\\Phi(\\Lambda) \\to \\Phi_{\\mathrm{fix}}(\\Lambda) = \\mathrm{diag}(\\phi(\\tilde{\\lambda}_1;\\delta),\\dots,\\phi(\\tilde{\\lambda}_m;\\delta))\n$$\nTo maintain the conservative property of the scheme, this modification must be contained entirely within the calculation of the single numerical flux value, $F_{i+\\frac{1}{2}}$. The procedure must be:\n1.  Obtain the reconstructed states $U_L$ and $U_R$ at the interface $x_{i+\\frac{1}{2}}$.\n2.  From $U_L$ and $U_R$, compute the Roe-averaged state $\\tilde{U}$ and its eigen-decomposition: eigenvalues $\\{\\tilde{\\lambda}_p\\}$ and eigenvector matrices $R(\\tilde{U})$ and $R(\\tilde{U})^{-1}$.\n3.  Construct the modified diagonal matrix of eigenvalue magnitudes, $\\Phi_{\\mathrm{fix}}(\\Lambda)$.\n4.  Assemble the new numerical flux $F_{i+\\frac{1}{2}}^{\\mathrm{fix}}$ using the modified dissipation term:\n    $$\n    F_{i+\\frac{1}{2}}^{\\mathrm{fix}} = \\frac{1}{2}\\left(F(U_L) + F(U_R)\\right) - \\frac{1}{2}\\, R(\\tilde{U})\\, \\Phi_{\\mathrm{fix}}(\\Lambda)\\, R(\\tilde{U})^{-1}\\, (U_R - U_L)\n    $$\n5.  Use this single, well-defined flux value $F_{i+\\frac{1}{2}}^{\\mathrm{fix}}$ in the standard finite-volume update formula for cells $i$ and $i+1$.\n\n**Option-by-Option Analysis**\n\n**A. Replace each $|\\tilde{\\lambda}_p|$ in the dissipation term by $\\phi(\\tilde{\\lambda}_p;\\delta)$ at the interface, leaving $R(\\tilde{U})$ and $R(\\tilde{U})^{-1}$ as computed from the Roe-averaged state, and recompute the single interface flux $F_{i+\\frac{1}{2}}$ using the modified diagonal matrix $\\Phi(\\Lambda) = \\mathrm{diag}(\\phi(\\tilde{\\lambda}_1;\\delta),\\dots,\\phi(\\tilde{\\lambda}_m;\\delta))$ without altering $U_L$ or $U_R$; update $U_i$ via the conservative flux difference.**\nThis option precisely follows the logic derived above. The modification is correctly localized within the dissipation term of the flux calculation. It leaves the fundamental components ($U_L$, $U_R$, $R(\\tilde{U})$) untouched and uses the resulting single flux value in the standard conservative update. This is the canonical method for implementing such an entropy fix while preserving conservation. This is the correct approach.\n\n**B.** Modifying the primitive variables is an ad-hoc and non-standard approach. It can violate the Roe property and makes the flux a function of artificially altered states, compromising conservation.\n\n**C.** The addition of a non-conservative source term explicitly breaks the conservative nature of the scheme. The purpose of a conservative scheme is to approximate a conservation law; adding artificial sources defeats this purpose.\n\n**D.** The right-eigenvectors represent the physical wave modes. An \"ad hoc rotation\" breaks this physical connection and is unmotivated. This also fails to address the core problem of vanishing dissipation.\n\n**E.** This option describes a confused hybrid scheme. Simply adding a Roe dissipation term to an HLL flux is not a standard or correct procedure and would re-introduce the potential for entropy violation that the fix is meant to cure.",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}