{
    "hands_on_practices": [
        {
            "introduction": "Before modeling the complex journey of a neutral beam through a fusion plasma, we must first understand the fundamental rates of the underlying atomic processes. This exercise grounds our analysis in first-principles kinetic theory by tasking you with the calculation of a reaction rate coefficient, a cornerstone of plasma modeling. By deriving a Maxwellian-averaged rate coefficient for electron-impact ionization from a standard cross-section model, you will directly connect microscopic physics to the macroscopic attenuation of the beam, developing a critical skill for quantitative analysis in fusion science .",
            "id": "4014438",
            "problem": "A monoenergetic deuterium neutral ($\\mathrm{D}^{0}$) beam traverses a uniform, stationary plasma segment in a tokamak neutral beam injection line. The plasma electrons are isotropic and Maxwellian at electron temperature $T_{e} = 2$ keV. Neutral attenuation in this segment is dominated by electron-impact ionization of $\\mathrm{D}^{0}$.\n\nStarting from kinetic theory and the definition of the reaction rate coefficient as the velocity-space average of the product $\\sigma v$, derive the Maxwellian-averaged rate coefficient $\\langle \\sigma v \\rangle$ for electron-impact ionization of $\\mathrm{D}^{0}$ by electrons at temperature $T_{e}$. Assume the electron-impact ionization cross section is modeled by the Lotz formula for a hydrogenic atom,\n$$\n\\sigma_{i}(E_{e}) = \n\\begin{cases}\n\\dfrac{a_{L} \\ln\\!\\left( \\dfrac{E_{e}}{I} \\right)}{E_{e} I}, & E_{e} \\ge I, \\\\\n0, & E_{e} < I,\n\\end{cases}\n$$\nwhere $E_{e}$ is the electron kinetic energy in electron-volts (eV), $I$ is the ionization threshold in eV, and $a_{L}$ is the Lotz coefficient. Use $I = 13.6$ eV and $a_{L} = 4.5 \\times 10^{-18}$ m$^{2}$ eV$^{2}$.\n\nThen, using your computed $\\langle \\sigma v \\rangle$, evaluate the transmitted neutral fraction along a straight beamline segment of length $L = 3.0$ m, with uniform electron density $n_{e} = 1.0 \\times 10^{19}$ m$^{-3}$. Treat the neutral beam speed as constant, determined by the beam energy $E_{b} = 80$ keV and the deuterium atomic mass $m_{D} = 3.3436 \\times 10^{-27}$ kg. Assume the relative speed in electron–neutral collisions is dominated by electron thermal motion, and neglect any other attenuation processes (such as charge exchange with ions or interactions with residual gas).\n\nYou may assume the following physical constants: electron mass $m_{e} = 9.1093837015 \\times 10^{-31}$ kg and elementary charge $e = 1.602176634 \\times 10^{-19}$ C. Express any intermediate energies in electron-volts where appropriate, and ensure unit consistency in the final $\\langle \\sigma v \\rangle$.\n\nCompute the final transmitted fraction $N(L)/N(0)$ as a dimensionless decimal. Round your final answer to three significant figures.",
            "solution": "The solution is structured in two main parts: first, the derivation and calculation of the Maxwellian-averaged rate coefficient $\\langle \\sigma v \\rangle$, and second, the calculation of the neutral beam attenuation and the transmitted fraction.\n\n**Part 1: Derivation of the Maxwellian-Averaged Rate Coefficient $\\langle \\sigma v \\rangle$**\n\nThe Maxwellian-averaged rate coefficient for a reaction between two species, $1$ and $2$, is defined as the average of the product of their relative speed $v_{rel} = |\\mathbf{v}_1 - \\mathbf{v}_2|$ and the reaction cross-section $\\sigma(v_{rel})$ over their velocity distributions.\n$$ \\langle \\sigma v \\rangle = \\iint f_1(\\mathbf{v}_1) f_2(\\mathbf{v}_2) |\\mathbf{v}_1 - \\mathbf{v}_2| \\sigma(|\\mathbf{v}_1 - \\mathbf{v}_2|) d^3\\mathbf{v}_1 d^3\\mathbf{v}_2 $$\nHere, species $1$ are the electrons ($e$) and species $2$ are the deuterium neutrals ($\\mathrm{D}^0$). The neutral beam is monoenergetic, so its velocity distribution is a Dirac delta function, $f_D(\\mathbf{v}_D) = \\delta(\\mathbf{v}_D - \\mathbf{v}_b)$, where $\\mathbf{v}_b$ is the constant beam velocity. The electrons are Maxwellian, with a normalized distribution\n$$ f_e(\\mathbf{v}_e) = \\left(\\frac{m_e}{2\\pi k_B T_e}\\right)^{3/2} \\exp\\left(-\\frac{m_e v_e^2}{2 k_B T_e}\\right) $$\nSubstituting the delta function for $f_D$ simplifies the expression for $\\langle \\sigma v \\rangle$:\n$$ \\langle \\sigma v \\rangle = \\int f_e(\\mathbf{v}_e) |\\mathbf{v}_e - \\mathbf{v}_b| \\sigma(|\\mathbf{v}_e - \\mathbf{v}_b|) d^3\\mathbf{v}_e $$\nThe problem states to assume the relative speed is dominated by electron thermal motion. This implies that the electron thermal speed is much greater than the neutral beam speed ($v_{th,e} \\gg v_b$). We verify this:\nThe electron thermal energy is given as $T_e = 2$ keV. The characteristic thermal speed is $v_{th,e} = \\sqrt{2 k_B T_e / m_e}$.\n$k_B T_e = 2000 \\text{ eV} \\times (1.602 \\times 10^{-19} \\text{ J/eV}) \\approx 3.204 \\times 10^{-16} \\text{ J}$.\n$v_{th,e} \\approx \\sqrt{2 (3.204 \\times 10^{-16} \\text{ J}) / (9.109 \\times 10^{-31} \\text{ kg})} \\approx 2.65 \\times 10^7 \\text{ m/s}$.\nThe beam energy is $E_b = 80$ keV. The beam speed is $v_b = \\sqrt{2 E_b / m_D}$.\n$E_b = 80000 \\text{ eV} \\times (1.602 \\times 10^{-19} \\text{ J/eV}) \\approx 1.282 \\times 10^{-14} \\text{ J}$.\n$v_b = \\sqrt{2 (1.282 \\times 10^{-14} \\text{ J}) / (3.3436 \\times 10^{-27} \\text{ kg})} \\approx 2.77 \\times 10^6 \\text{ m/s}$.\nSince $v_b \\approx 0.1 v_{th,e}$, the assumption $v_b \\ll v_{th,e}$ is justified, and we can approximate the relative speed $|\\mathbf{v}_e - \\mathbf{v}_b| \\approx v_e$. The integral becomes:\n$$ \\langle \\sigma v \\rangle \\approx \\int f_e(\\mathbf{v}_e) v_e \\sigma(v_e) d^3\\mathbf{v}_e $$\nTransforming to spherical coordinates in velocity space ($d^3\\mathbf{v}_e = 4\\pi v_e^2 dv_e$) and integrating over the angular parts gives:\n$$ \\langle \\sigma v \\rangle = \\int_0^\\infty 4\\pi v_e^2 f_e(v_e) v_e \\sigma(v_e) dv_e = 4\\pi \\left(\\frac{m_e}{2\\pi k_B T_e}\\right)^{3/2} \\int_0^\\infty v_e^3 \\sigma(v_e) \\exp\\left(-\\frac{m_e v_e^2}{2 k_B T_e}\\right) dv_e $$\nWe change the integration variable from speed $v_e$ to kinetic energy $E_e = \\frac{1}{2}m_e v_e^2$. This implies $v_e = \\sqrt{2E_e/m_e}$ and $dv_e = (1/\\sqrt{2m_e E_e}) dE_e$. The term $v_e^3 dv_e$ becomes $(2E_e/m_e) (dE_e/m_e) = (2E_e/m_e^2) dE_e$. Substituting these into the integral, we arrive at the standard formula for the rate coefficient as an energy integral:\n$$ \\langle \\sigma v \\rangle = \\sqrt{\\frac{8}{\\pi m_e}} (k_B T_e)^{-3/2} \\int_0^\\infty E_e \\sigma(E_e) \\exp\\left(-\\frac{E_e}{k_B T_e}\\right) dE_e $$\nThe Lotz cross-section $\\sigma_i(E_e)$ is given in mixed units (m$^2$, eV). To perform the calculation correctly, all quantities must be in SI units.\nGiven values in SI units:\n- Elementary charge $e = 1.602176634 \\times 10^{-19}$ C gives the conversion $1 \\text{ eV} = 1.602176634 \\times 10^{-19}$ J.\n- Ionization threshold $I_{SI} = 13.6 \\text{ eV} \\times e = 2.17896 \\times 10^{-18}$ J.\n- Electron thermal energy $k_B T_e = 2000 \\text{ eV} \\times e = 3.20435 \\times 10^{-16}$ J.\n- Lotz coefficient $a_{L,SI} = 4.5 \\times 10^{-18} \\text{ m}^2 \\text{eV}^2 \\times e^2 = 1.15514 \\times 10^{-55} \\text{ m}^2 \\text{J}^2$.\n- Electron mass $m_e = 9.1093837 \\times 10^{-31}$ kg.\n\nIn SI units, the cross-section is $\\sigma_i(E_e) = \\frac{a_{L,SI} \\ln(E_e/I_{SI})}{E_e I_{SI}}$ for $E_e \\ge I_{SI}$, and 0 otherwise.\nSubstituting this into the integral for $\\langle \\sigma v \\rangle$:\n$$ \\langle \\sigma v \\rangle = \\sqrt{\\frac{8}{\\pi m_e}} (k_B T_e)^{-3/2} \\int_{I_{SI}}^\\infty E_e \\left[ \\frac{a_{L,SI} \\ln(E_e/I_{SI})}{E_e I_{SI}} \\right] \\exp\\left(-\\frac{E_e}{k_B T_e}\\right) dE_e $$\nThe $E_e$ terms in the integrand cancel.\n$$ \\langle \\sigma v \\rangle = \\frac{a_{L,SI}}{I_{SI}} \\sqrt{\\frac{8}{\\pi m_e}} (k_B T_e)^{-3/2} \\int_{I_{SI}}^\\infty \\ln\\left(\\frac{E_e}{I_{SI}}\\right) \\exp\\left(-\\frac{E_e}{k_B T_e}\\right) dE_e $$\nLet's solve the integral. Let $x = E_e/k_B T_e$ and $x_I = I_{SI}/k_B T_e$. Then $E_e = x k_B T_e$ and $dE_e = k_B T_e dx$.\n$$ \\int_{x_I}^\\infty \\ln\\left(\\frac{x k_B T_e}{I_{SI}}\\right) \\exp(-x) (k_B T_e) dx = (k_B T_e) \\int_{x_I}^\\infty \\ln\\left(\\frac{x}{x_I}\\right) e^{-x} dx $$\nThe integral $\\int_{x_I}^\\infty (\\ln x - \\ln x_I) e^{-x} dx$ can be related to the exponential integral function $E_1(z) = \\int_z^\\infty (e^{-t}/t) dt$. Using integration by parts, one can show $\\int_z^\\infty \\ln(t) e^{-t} dt = \\ln(z)e^{-z} + E_1(z)$. The integral becomes:\n$$ \\int_{x_I}^\\infty \\ln(x/x_I) e^{-x} dx = E_1(x_I) $$\nThus, the original energy integral evaluates to $(k_B T_e) E_1(x_I)$.\nSubstituting this back into the expression for $\\langle \\sigma v \\rangle$:\n$$ \\langle \\sigma v \\rangle = \\frac{a_{L,SI}}{I_{SI}} \\sqrt{\\frac{8}{\\pi m_e}} (k_B T_e)^{-3/2} (k_B T_e) E_1\\left(\\frac{I_{SI}}{k_B T_e}\\right) $$\n$$ \\langle \\sigma v \\rangle = \\frac{a_{L,SI}}{I_{SI}} \\sqrt{\\frac{8}{\\pi m_e k_B T_e}} E_1\\left(\\frac{I_{SI}}{k_B T_e}\\right) $$\nNow, we compute the numerical value. The argument of $E_1$ is $x_I = I_{SI}/(k_B T_e) = (13.6 \\text{ eV})/(2000 \\text{ eV}) = 0.0068$.\nFor small $z$, the exponential integral has the series expansion $E_1(z) \\approx -\\gamma - \\ln(z)$, where $\\gamma \\approx 0.57721566$ is the Euler-Mascheroni constant.\n$E_1(0.0068) \\approx -0.577216 - \\ln(0.0068) = -0.577216 - (-4.99003) \\approx 4.4128$.\nLet's compute the prefactor:\n$$ \\frac{a_{L,SI}}{I_{SI}} = \\frac{1.15514 \\times 10^{-55} \\text{ m}^2\\text{J}^2}{2.17896 \\times 10^{-18} \\text{ J}} = 5.3013 \\times 10^{-38} \\text{ m}^2\\text{J} $$\n$$ \\sqrt{\\frac{8}{\\pi m_e k_B T_e}} = \\sqrt{\\frac{8}{\\pi (9.10938 \\times 10^{-31})(3.20435 \\times 10^{-16})}} \\approx \\sqrt{8.7221 \\times 10^{45}} \\approx 9.3392 \\times 10^{22} (\\text{kg J})^{-1/2} $$\nCombining these:\n$$ \\langle \\sigma v \\rangle \\approx (5.3013 \\times 10^{-38}) \\times (9.3392 \\times 10^{22}) \\times 4.4128 $$\n$$ \\langle \\sigma v \\rangle \\approx (4.9510 \\times 10^{-15}) \\times 4.4128 \\approx 2.1847 \\times 10^{-14} \\text{ m}^3\\text{s}^{-1} $$\n\n**Part 2: Calculation of the Transmitted Neutral Fraction**\nThe attenuation of the neutral beam density, $n_b$, along its path length $z$ is described by the differential equation:\n$$ \\frac{d n_b(z)}{dt} = -n_b(z) n_e \\langle \\sigma v \\rangle $$\nUsing the relationship $dz = v_b dt$, where $v_b$ is the constant beam speed, we get:\n$$ \\frac{d n_b(z)}{dz} = -\\frac{n_b(z) n_e \\langle \\sigma v \\rangle}{v_b} $$\nFor a uniform plasma ($n_e$ is constant), we integrate this equation over the path length $L$:\n$$ \\int_{n_b(0)}^{n_b(L)} \\frac{dn_b}{n_b} = -\\frac{n_e \\langle \\sigma v \\rangle}{v_b} \\int_0^L dz $$\n$$ \\ln\\left(\\frac{n_b(L)}{n_b(0)}\\right) = -\\frac{n_e \\langle \\sigma v \\rangle L}{v_b} $$\nThe transmitted fraction is $N(L)/N(0) = n_b(L)/n_b(0)$.\n$$ \\frac{N(L)}{N(0)} = \\exp\\left(-\\frac{n_e \\langle \\sigma v \\rangle L}{v_b}\\right) $$\nWe need to calculate the beam speed $v_b$ from its energy $E_b = 80$ keV.\n$E_{b,SI} = 80 \\times 10^3 \\text{ eV} \\times (1.6021766 \\times 10^{-19} \\text{ J/eV}) = 1.28174 \\times 10^{-14}$ J.\n$m_D = 3.3436 \\times 10^{-27}$ kg.\n$$ v_b = \\sqrt{\\frac{2 E_{b,SI}}{m_D}} = \\sqrt{\\frac{2(1.28174 \\times 10^{-14} \\text{ J})}{3.3436 \\times 10^{-27} \\text{ kg}}} \\approx 2.7688 \\times 10^6 \\text{ m/s} $$\nNow we calculate the exponent in the attenuation formula:\n$$ \\text{Exponent} = \\frac{n_e \\langle \\sigma v \\rangle L}{v_b} = \\frac{(1.0 \\times 10^{19} \\text{ m}^{-3})(2.1847 \\times 10^{-14} \\text{ m}^3\\text{s}^{-1})(3.0 \\text{ m})}{2.7688 \\times 10^6 \\text{ m/s}} $$\n$$ \\text{Exponent} \\approx \\frac{6.5541 \\times 10^5}{2.7688 \\times 10^6} \\approx 0.23671 $$\nThe transmitted fraction is:\n$$ \\frac{N(L)}{N(0)} = \\exp(-0.23671) \\approx 0.78923 $$\nRounding the final answer to three significant figures, we get $0.789$.",
            "answer": "$$\\boxed{0.789}$$"
        },
        {
            "introduction": "Building on the concept of reaction rates, we now move to modeling a key NBI subsystem: the neutralizer. In this component, a beam of ions is converted into the desired fast neutrals, but competing processes like re-ionization (stripping) can reduce efficiency. This practice challenges you to capture this dynamic interplay by deriving and solving a system of coupled differential equations for the fractions of ions ($f_i$), neutrals ($f_n$), and residual ions ($f_r$) as they evolve along the neutralizer's length . Mastering this type of system modeling is essential for predicting and optimizing the performance of real-world NBI hardware.",
            "id": "4014511",
            "problem": "A collimated beam used in Neutral Beam Injection (NBI) traverses a uniform gas neutralizer of length $L$, gas number density $n_g$, and experiences two dominant collisional processes: charge exchange converting incident ions to neutrals, and stripping (ionization) converting neutrals to residual ions. Assume a single-species beam and a spatially uniform neutralizer. The foundational base is the kinetic theory of binary collisions: the reaction probability per unit time for a particle moving with speed $v$ in a background of number density $n_g$ with reaction cross section $\\sigma$ is $n_g \\sigma v$. For a beam coordinated by axial position $x$ along the neutralizer, use $dt = dx / v$ to convert time-rate equations to spatial-rate equations. Let the species fractions be $f_i(x)$ for ions, $f_n(x)$ for neutrals, and $f_r(x)$ for residual ions, with initial conditions $f_i(0) = f_{i0}$, $f_n(0) = f_{n0}$, $f_r(0) = f_{r0}$, and $f_{i0} + f_{n0} + f_{r0} = 1$. Let the charge exchange cross section be $\\sigma_{in}$ and the stripping cross section be $\\sigma_{nr}$.\n\nTask:\n1. Starting from the continuity of species fractions and the collision-rate model above, derive the coupled differential equations in $x$ that govern $f_i(x)$, $f_n(x)$, and $f_r(x)$ in a uniform neutralizer.\n2. Solve these coupled equations analytically to obtain $f_i(L)$, $f_n(L)$, and $f_r(L)$ in terms of $n_g$, $L$, $\\sigma_{in}$, $\\sigma_{nr}$, and the initial fractions $f_{i0}$, $f_{n0}$, $f_{r0}$. You must handle the special case when $n_g \\sigma_{in} = n_g \\sigma_{nr}$ by taking the appropriate mathematical limit.\n3. Implement a complete, runnable program that uses your derived analytic solution to compute the exit fractions for the following test suite. Use cross sections in $\\mathrm{m}^2$, $n_g$ in $\\mathrm{m}^{-3}$, and $L$ in $\\mathrm{m}$. All reported species fractions are dimensionless. Express each fraction as a float rounded to eight decimal places.\n\nTest suite (each tuple lists $(n_g, L, \\sigma_{in}, \\sigma_{nr}, f_{i0}, f_{n0}, f_{r0})$):\n- Case A (general case): $(1.0 \\times 10^{20}, 1.0, 1.2 \\times 10^{-19}, 2.0 \\times 10^{-20}, 1.0, 0.0, 0.0)$\n- Case B (equality edge case with $n_g \\sigma_{in} = n_g \\sigma_{nr}$): $(5.0 \\times 10^{19}, 0.5, 1.0 \\times 10^{-19}, 1.0 \\times 10^{-19}, 1.0, 0.0, 0.0)$\n- Case C (mixed initial fractions, low density): $(1.0 \\times 10^{18}, 1.0, 1.2 \\times 10^{-19}, 2.0 \\times 10^{-20}, 0.7, 0.3, 0.0)$\n- Case D (long neutralizer, high density): $(2.0 \\times 10^{20}, 3.0, 8.0 \\times 10^{-20}, 3.0 \\times 10^{-20}, 1.0, 0.0, 0.0)$\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list of per-case triplets enclosed in square brackets, with no spaces, and each fraction rounded to eight decimal places. For example, a two-case output would look like: \"[[f_iA,f_nA,f_rA],[f_iB,f_nB,f_rB]]\".",
            "solution": "**Part 1: Derivation of the Governing Differential Equations**\nThe problem describes the evolution of three species fractions along the neutralizer axis $x$: incident ions ($f_i$), neutrals ($f_n$), and residual ions ($f_r$). The rate of change of any species is based on the kinetic model where the reaction probability per unit time for a particle of speed $v$ is $n_g \\sigma v$. We convert this to a spatial rate using $dx = v dt$.\n\n1.  **Incident Ions ($f_i$):** These are lost only through charge exchange (ion $\\to$ neutral) with cross section $\\sigma_{in}$.\n    $$ \\frac{df_i}{dt} = - f_i \\cdot (n_g \\sigma_{in} v) \\implies \\frac{df_i}{dx} = -n_g \\sigma_{in} f_i $$\n2.  **Neutrals ($f_n$):** These are gained from charge exchange of incident ions and lost through stripping (neutral $\\to$ residual ion) with cross section $\\sigma_{nr}$.\n    $$ \\frac{df_n}{dt} = f_i \\cdot (n_g \\sigma_{in} v) - f_n \\cdot (n_g \\sigma_{nr} v) \\implies \\frac{df_n}{dx} = n_g \\sigma_{in} f_i - n_g \\sigma_{nr} f_n $$\n3.  **Residual Ions ($f_r$):** These are gained only from stripping of neutrals.\n    $$ \\frac{df_r}{dt} = f_n \\cdot (n_g \\sigma_{nr} v) \\implies \\frac{df_r}{dx} = n_g \\sigma_{nr} f_n $$\nLet's define the attenuation coefficients (inverse lengths) $k_{in} = n_g \\sigma_{in}$ and $k_{nr} = n_g \\sigma_{nr}$. The system of coupled ODEs is:\n$$\n\\frac{df_i}{dx} = -k_{in} f_i \\\\\n\\frac{df_n}{dx} = k_{in} f_i - k_{nr} f_n \\\\\n\\frac{df_r}{dx} = k_{nr} f_n\n$$\nThe total fraction is conserved: $f_i(x) + f_n(x) + f_r(x) = 1$ for all $x$.\n\n**Part 2: Analytical Solution of the Equations**\nWe solve this system sequentially with initial conditions $f_i(0)=f_{i0}$, $f_n(0)=f_{n0}$, and $f_r(0)=f_{r0}$.\n\n1.  **Solution for $f_i(x)$:** The first equation is a simple separable ODE, whose solution is:\n    $$ f_i(x) = f_{i0} e^{-k_{in} x} $$\n2.  **Solution for $f_n(x)$:** Substitute the solution for $f_i(x)$ into the second ODE:\n    $$ \\frac{df_n}{dx} + k_{nr} f_n = k_{in} f_{i0} e^{-k_{in} x} $$\n    This is a first-order linear ODE. We consider two cases.\n    \n    **General Case ($k_{in} \\neq k_{nr}$):**\n    Using an integrating factor $e^{k_{nr} x}$, the solution is found to be:\n    $$ f_n(x) = f_{n0} e^{-k_{nr} x} + \\frac{k_{in} f_{i0}}{k_{nr} - k_{in}} (e^{-k_{in} x} - e^{-k_{nr} x}) $$\n    \n    **Special Case ($k_{in} = k_{nr} = k$):**\n    When the coefficients are equal, the ODE becomes $\\frac{df_n}{dx} + k f_n = k f_{i0} e^{-k x}$. The solution is found by integrating $\\frac{d}{dx}(f_n e^{kx}) = k f_{i0}$. This yields:\n    $$ f_n(x) = (f_{n0} + k f_{i0} x) e^{-k x} $$\n    This result can also be found by taking the limit of the general solution as $k_{nr} \\to k_{in}$ using L'Hôpital's rule.\n\n3.  **Solution for $f_r(x)$:** We use the conservation law for simplicity:\n    $$ f_r(x) = 1 - f_i(x) - f_n(x) $$\n\n**Final Expressions for $x=L$:**\nTo implement the solution, we define the dimensionless optical depths $\\tau_{in} = k_{in}L = n_g \\sigma_{in} L$ and $\\tau_{nr} = k_{nr}L = n_g \\sigma_{nr} L$. The final fractions are:\n\n*   **General Case ($\\tau_{in} \\neq \\tau_{nr}$):**\n    $$ f_i(L) = f_{i0} e^{-\\tau_{in}} $$\n    $$ f_n(L) = f_{n0} e^{-\\tau_{nr}} + \\frac{\\tau_{in} f_{i0}}{\\tau_{nr} - \\tau_{in}} (e^{-\\tau_{in}} - e^{-\\tau_{nr}}) $$\n    $$ f_r(L) = 1 - f_i(L) - f_n(L) $$\n\n*   **Special Case ($\\tau_{in} = \\tau_{nr} = \\tau$):**\n    $$ f_i(L) = f_{i0} e^{-\\tau} $$\n    $$ f_n(L) = (f_{n0} + \\tau f_{i0}) e^{-\\tau} $$\n    $$ f_r(L) = 1 - f_i(L) - f_n(L) $$\nThese analytical expressions are implemented in the provided program to compute the results for the test suite.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the exit species fractions for a neutral beam passing through a uniform gas neutralizer.\n    The solution is based on the analytical solution of the coupled rate equations.\n    \"\"\"\n\n    test_cases = [\n        # Case A (general case)\n        (1.0e20, 1.0, 1.2e-19, 2.0e-20, 1.0, 0.0, 0.0),\n        # Case B (equality edge case)\n        (5.0e19, 0.5, 1.0e-19, 1.0e-19, 1.0, 0.0, 0.0),\n        # Case C (mixed initial fractions, low density)\n        (1.0e18, 1.0, 1.2e-19, 2.0e-20, 0.7, 0.3, 0.0),\n        # Case D (long neutralizer, high density)\n        (2.0e20, 3.0, 8.0e-20, 3.0e-20, 1.0, 0.0, 0.0),\n    ]\n\n    def calculate_fractions(ng, L, sig_in, sig_nr, f_i0, f_n0, f_r0):\n        \"\"\"\n        Computes the final fractions (f_i, f_n, f_r) based on derived analytical solutions.\n        \n        Args:\n            ng (float): Gas number density (m^-3).\n            L (float): Length of the neutralizer (m).\n            sig_in (float): Charge exchange cross section (m^2).\n            sig_nr (float): Stripping cross section (m^2).\n            f_i0 (float): Initial incident ion fraction.\n            f_n0 (float): Initial neutral fraction.\n            f_r0 (float): Initial residual ion fraction.\n            \n        Returns:\n            tuple: A tuple containing the final fractions (f_i, f_n, f_r).\n        \"\"\"\n        tau_in = ng * sig_in * L\n        tau_nr = ng * sig_nr * L\n\n        # To handle numerical stability, check if tau_in and tau_nr are very close.\n        # A small tolerance is better than direct equality for floating-point numbers.\n        if abs(tau_in - tau_nr) < 1e-12:\n            # Special case: tau_in = tau_nr = tau\n            tau = tau_in\n            f_i = f_i0 * np.exp(-tau)\n            f_n = (f_n0 + tau * f_i0) * np.exp(-tau)\n        else:\n            # General case: tau_in != tau_nr\n            exp_in = np.exp(-tau_in)\n            exp_nr = np.exp(-tau_nr)\n            \n            f_i = f_i0 * exp_in\n            f_n = f_n0 * exp_nr + (tau_in * f_i0 / (tau_nr - tau_in)) * (exp_in - exp_nr)\n\n        # f_r is determined by conservation\n        f_r = 1.0 - f_i - f_n\n\n        return f_i, f_n, f_r\n\n    results = []\n    for case in test_cases:\n        f_i, f_n, f_r = calculate_fractions(*case)\n        # Format each triplet of fractions as \"[f_i,f_n,f_r]\" with 8 decimal places\n        result_str = f\"[{f_i:.8f},{f_n:.8f},{f_r:.8f}]\"\n        results.append(result_str)\n\n    # Combine all case strings into the final output format \"[[...],[...],...]\"\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "To accurately predict heating and current drive, we must account for the complexities of both the beam and the plasma, including the fact that realistic neutral beams are composed of multiple energy species. This capstone practice introduces the powerful and widely used Monte Carlo method to simulate the stochastic nature of particle transport and deposition. You will build a simulation to model the deposition profile from a multi-species beam and, crucially, learn how to verify the statistical reliability of your results—an indispensable skill for any computational scientist . This exercise provides direct experience with the techniques used in modern, comprehensive NBI codes.",
            "id": "4014426",
            "problem": "You are tasked with building a complete, runnable program that performs scientifically realistic Monte Carlo (MC) sampling for Neutral Beam Injection (NBI) species and verifies the statistical convergence of deposition histograms. The program must implement a sampler consistent with measured full-energy, half-energy, and third-energy species fractions, denoted by $f_{1}$, $f_{1/2}$, and $f_{1/3}$, respectively, and assess convergence for $N = 10^6$ independent neutral histories. The computational model is one-dimensional along the beamline coordinate $x$ into a plasma volume of finite length $L$ (in meters). Depositions occur at the first interaction point sampled from an exponential mean free path model; this is grounded in the Beer–Lambert law for attenuation and a standard first-collision model.\n\nFundamental base and modeling assumptions:\n- Neutral Beam Injection (NBI) is represented by the one-dimensional transport of neutrals with species-dependent mean free paths. The exponential path length model is derived from the Beer–Lambert law, which states $dI/dx = -I/\\lambda$, yielding the probability density of the first interaction position $p(x \\mid \\lambda) = (1/\\lambda)\\exp(-x/\\lambda)$ for $x \\ge 0$, where $\\lambda$ is the mean free path (in meters).\n- The measured energy component fractions $f_{1}$, $f_{1/2}$, $f_{1/3}$ satisfy $f_{1} + f_{1/2} + f_{1/3} = 1$ and serve as the categorical sampling probabilities for the species identity. The deposition probability density along $x$ is therefore the mixture \n$$\np(x) = f_{1}\\frac{1}{\\lambda_{1}}e^{-x/\\lambda_{1}} + f_{1/2}\\frac{1}{\\lambda_{1/2}}e^{-x/\\lambda_{1/2}} + f_{1/3}\\frac{1}{\\lambda_{1/3}}e^{-x/\\lambda_{1/3}},\n$$\ntruncated to the interval $[0, L]$ because only deposition inside the plasma volume $[0, L]$ is recorded.\n- Histograms are computed over $B$ uniform bins spanning $[0, L]$. Deposition density per unit length in bin $i$ is estimated by the bin count divided by $N$ and by the bin width, so that the estimator has units of $\\text{per meter}$.\n\nRequirements for the MC algorithm and convergence verification:\n- Species sampling: draw the species identity for each history according to $f_{1}$, $f_{1/2}$, $f_{1/3}$.\n- Path-length sampling: for the selected species with mean free path $\\lambda_{s}$, draw a path length $x$ from the exponential distribution $p(x \\mid \\lambda_{s})$.\n- Deposition acceptance: accept a deposition event if $x \\in [0, L]$; otherwise it is outside the modeled plasma segment and is not counted in the histogram.\n- Histogram estimation: compute a histogram with $B$ bins covering $[0, L]$, convert counts to deposition density per unit length by dividing by $N$ and by the bin width.\n- Convergence check: perform two independent MC realizations (with distinct seeds) of size $N = 10^6$, compute the per-bin deposition density arrays, and define the per-bin relative difference as\n$$\n\\Delta_i = \n\\begin{cases}\n\\frac{\\lvert h_i^{(1)} - h_i^{(2)} \\rvert}{\\frac{1}{2}(h_i^{(1)} + h_i^{(2)})} & \\text{if } \\frac{1}{2}(h_i^{(1)} + h_i^{(2)}) > 0, \\\\\n0 & \\text{otherwise},\n\\end{cases}\n$$\nwhere $h_i^{(1)}$ and $h_i^{(2)}$ are the deposition densities in bin $i$ from the two runs. The test passes if $\\max_i \\Delta_i \\le 0.02$.\n\nPhysical and numerical units:\n- All lengths, including $L$ and $\\lambda$ values, must be in meters.\n- No angles are used.\n- The final outputs are booleans; no physical units are printed.\n\nTest suite:\nImplement the program to evaluate the following three test cases. For each case, run two independent MC realizations with $N = 10^6$ histories, compute the per-bin relative differences as defined above, and return whether the maximum relative difference is less than or equal to $0.02$.\n\n- Case $1$ (general mixed beam):\n  - Species fractions: $f_{1} = 0.60$, $f_{1/2} = 0.25$, $f_{1/3} = 0.15$.\n  - Mean free paths: $\\lambda_{1} = 0.25\\,\\text{m}$, $\\lambda_{1/2} = 0.18\\,\\text{m}$, $\\lambda_{1/3} = 0.12\\,\\text{m}$.\n  - Plasma segment length: $L = 1.0\\,\\text{m}$.\n  - Number of bins: $B = 100$.\n\n- Case $2$ (near-single-species boundary):\n  - Species fractions: $f_{1} = 0.98$, $f_{1/2} = 0.02$, $f_{1/3} = 0.00$.\n  - Mean free paths: $\\lambda_{1} = 0.50\\,\\text{m}$, $\\lambda_{1/2} = 0.50\\,\\text{m}$, $\\lambda_{1/3} = 0.50\\,\\text{m}$.\n  - Plasma segment length: $L = 0.50\\,\\text{m}$.\n  - Number of bins: $B = 50$.\n\n- Case $3$ (highly transparent beam, long mean free paths):\n  - Species fractions: $f_{1} = 0.33$, $f_{1/2} = 0.34$, $f_{1/3} = 0.33$.\n  - Mean free paths: $\\lambda_{1} = 10.0\\,\\text{m}$, $\\lambda_{1/2} = 5.0\\,\\text{m}$, $\\lambda_{1/3} = 3.0\\,\\text{m}$.\n  - Plasma segment length: $L = 2.0\\,\\text{m}$.\n  - Number of bins: $B = 40$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[ \\text{result}_1, \\text{result}_2, \\text{result}_3 ]$, where each $\\text{result}_i$ is a boolean indicating whether the corresponding case meets the $\\le 0.02$ per-bin maximum relative difference criterion. The output must strictly match the format $[result1,result2,result3]$ with no additional text.",
            "solution": "The problem requires the implementation and verification of a one-dimensional Monte Carlo simulation for Neutral Beam Injection (NBI) deposition. The core task is to sample particle deposition locations based on a physical model and then to assess the statistical convergence of the resulting deposition profiles.\n\nThe physical model is grounded in the Beer–Lambert law, which describes the attenuation of a beam through a medium. This law gives rise to a probability density function $p(x \\mid \\lambda) = (1/\\lambda)\\exp(-x/\\lambda)$ for the first interaction distance $x$, where $\\lambda$ is the mean free path. The NBI beam is composed of three species with different energies (full, half, and third), characterized by distinct mean free paths $\\lambda_{1}$, $\\lambda_{1/2}$, and $\\lambda_{1/3}$, and species fractions $f_{1}$, $f_{1/2}$, and $f_{1/3}$. These fractions satisfy the closure relation $f_{1} + f_{1/2} + f_{1/3} = 1$. The overall probability density function for deposition at a position $x$ is thus a mixture model:\n$$\np(x) = f_{1}p(x \\mid \\lambda_{1}) + f_{1/2}p(x \\mid \\lambda_{1/2}) + f_{1/3}p(x \\mid \\lambda_{1/3})\n$$\nThe simulation considers depositions only within a finite plasma volume of length $L$, i.e., for $x \\in [0, L]$.\n\nThe Monte Carlo algorithm proceeds by simulating $N = 10^6$ independent neutral particle histories. For each history, two sequential sampling steps are performed:\n$1.$ **Species Sampling**: The identity of the neutral particle species ($s \\in \\{1, 1/2, 1/3\\}$) is chosen randomly. This is a draw from a categorical distribution with probabilities given by the species fractions $\\{f_{1}, f_{1/2}, f_{1/3}\\}$. Computationally, this is achieved by partitioning the interval $[0, 1)$ into three segments of lengths $f_{1}$, $f_{1/2}$, and $f_{1/3}$, and determining which segment a uniform random number $u \\in [0, 1)$ falls into.\n\n$2.$ **Path-Length Sampling**: Once a species $s$ with mean free path $\\lambda_s$ is selected, a path length $x$ is sampled from its corresponding exponential distribution $p(x \\mid \\lambda_s)$. This is most efficiently done using the inverse transform sampling method. The cumulative distribution function (CDF) is $F(x) = 1 - \\exp(-x/\\lambda_s)$. Setting the CDF equal to a uniform random number $u \\in [0, 1)$ and solving for $x$ yields the sampling formula:\n$$\nx = F^{-1}(u) = -\\lambda_s \\ln(1 - u)\n$$\nSince if $u$ is uniform on $[0, 1)$, then $1-u$ is also uniform on $[0, 1)$, we can simplify the formula to $x = -\\lambda_s \\ln(u)$.\n\nAfter sampling a path length $x$, the deposition is recorded only if it occurs within the plasma domain, i.e., if $0 \\le x \\le L$. Particles with $x > L$ are considered to have passed through the plasma segment without interaction and are not counted.\n\nThe collected deposition positions are binned into a histogram with $B$ uniformly spaced bins over the interval $[0, L]$. The bin width is therefore $\\Delta x = L/B$. To obtain an estimate of the deposition density (in units of $\\text{m}^{-1}$), the count $C_i$ in each bin $i$ is normalized by the total number of initial histories $N$ and the bin width $\\Delta x$. The estimator for the deposition density in bin $i$ is:\n$$\nh_i = \\frac{C_i}{N \\cdot \\Delta x}\n$$\nTo verify statistical convergence, this entire process is executed twice with different random number generator seeds, producing two independent deposition density histograms, $h^{(1)}$ and $h^{(2)}$. The per-bin relative difference, $\\Delta_i$, is calculated as:\n$$\n\\Delta_i = \n\\begin{cases}\n\\frac{\\lvert h_i^{(1)} - h_i^{(2)} \\rvert}{\\frac{1}{2}(h_i^{(1)} + h_i^{(2)})} & \\text{if } \\frac{1}{2}(h_i^{(1)} + h_i^{(2)}) > 0, \\\\\n0 & \\text{otherwise}\n\\end{cases}\n$$\nThe convergence test is passed if the maximum of these relative differences over all bins does not exceed a tolerance of $0.02$, i.e., if $\\max_i \\Delta_i \\le 0.02$. A boolean result is returned for each test case.\n\nThe implementation utilizes the `numpy` library for efficient, vectorized operations. Generating all $N$ random numbers for species and path-length sampling in single array operations is significantly more performant than iterating through individual histories. For a given test case, two independent simulations are run. The resulting histograms are normalized, their relative differences are computed, and the maximum difference is compared against the threshold to determine the final boolean outcome. This procedure is repeated for all three test cases provided.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_mc_simulation(N, fractions, lambdas, L, B, seed):\n    \"\"\"\n    Performs a vectorized Monte Carlo simulation for NBI deposition.\n\n    Args:\n        N (int): Total number of particle histories to simulate.\n        fractions (list[float]): Species fractions [f_1, f_1/2, f_1/3].\n        lambdas (list[float]): Mean free paths [lambda_1, lambda_1/2, lambda_1/3] in meters.\n        L (float): Length of the plasma segment in meters.\n        B (int): Number of bins for the histogram.\n        seed (int): Seed for the random number generator.\n\n    Returns:\n        numpy.ndarray: The normalized deposition density histogram.\n    \"\"\"\n    # Initialize a random number generator with a specific seed for reproducibility.\n    rng = np.random.default_rng(seed)\n\n    # 1. Species Sampling: Draw N species indices (0, 1, or 2) based on fractions.\n    species_indices = rng.choice(3, size=N, p=fractions)\n\n    # 2. Path-Length Sampling (vectorized):\n    # Map the sampled species indices to their corresponding mean free paths.\n    lambdas_per_particle = np.array(lambdas)[species_indices]\n\n    # Generate N uniform random numbers for inverse transform sampling.\n    # rng.random() generates floats in the interval [0.0, 1.0).\n    u = rng.random(size=N)\n\n    # Calculate path lengths x = -lambda * ln(u).\n    # np.log(0) would be -inf, but rng.random() does not produce 0.\n    path_lengths = -lambdas_per_particle * np.log(u)\n\n    # 3. Deposition Acceptance: Filter for particles that deposit within [0, L].\n    # The condition x >= 0 is implicitly met since lambda > 0 and ln(u) <= 0.\n    deposited_positions = path_lengths[path_lengths <= L]\n\n    # 4. Histogram Estimation: Bin the successful deposition positions.\n    # np.histogram returns counts per bin and the bin edges.\n    counts, _ = np.histogram(deposited_positions, bins=B, range=(0, L))\n\n    # 5. Normalization: Convert counts to deposition density per unit length.\n    bin_width = L / B\n    # Normalize by the total number of initial histories (N), not the number deposited.\n    if N == 0 or bin_width == 0:\n        return np.zeros(B)\n    deposition_density = counts / (N * bin_width)\n\n    return deposition_density\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general mixed beam)\n        {\n            \"fractions\": [0.60, 0.25, 0.15],\n            \"lambdas\": [0.25, 0.18, 0.12],\n            \"L\": 1.0,\n            \"B\": 100,\n        },\n        # Case 2 (near-single-species boundary)\n        {\n            \"fractions\": [0.98, 0.02, 0.00],\n            \"lambdas\": [0.50, 0.50, 0.50],\n            \"L\": 0.50,\n            \"B\": 50,\n        },\n        # Case 3 (highly transparent beam, long mean free paths)\n        {\n            \"fractions\": [0.33, 0.34, 0.33],\n            \"lambdas\": [10.0, 5.0, 3.0],\n            \"L\": 2.0,\n            \"B\": 40,\n        },\n    ]\n    \n    N_histories = 10**6\n    convergence_threshold = 0.02\n    results = []\n\n    for case in test_cases:\n        # Run two independent MC realizations with distinct seeds.\n        h1 = run_mc_simulation(\n            N=N_histories,\n            fractions=case[\"fractions\"],\n            lambdas=case[\"lambdas\"],\n            L=case[\"L\"],\n            B=case[\"B\"],\n            seed=42  # First fixed seed for reproducibility.\n        )\n        h2 = run_mc_simulation(\n            N=N_histories,\n            fractions=case[\"fractions\"],\n            lambdas=case[\"lambdas\"],\n            L=case[\"L\"],\n            B=case[\"B\"],\n            seed=99  # Second fixed seed for reproducibility.\n        )\n\n        # Calculate the per-bin relative difference.\n        avg_h = 0.5 * (h1 + h2)\n        \n        # Use np.errstate to prevent division-by-zero warnings.\n        with np.errstate(divide='ignore', invalid='ignore'):\n            relative_difference = np.abs(h1 - h2) / avg_h\n            # As per the problem spec, where the denominator is zero, the diff is zero.\n            # This handles bins where both runs had zero counts.\n            relative_difference[avg_h == 0] = 0.0\n\n        # Find the maximum relative difference across all bins.\n        max_relative_difference = np.max(relative_difference)\n\n        # Check if the convergence criterion is met.\n        is_converged = max_relative_difference <= convergence_threshold\n        results.append(is_converged)\n\n    # Print results in the specified format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}