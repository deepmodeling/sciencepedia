## Introduction
The stable confinement of a high-temperature plasma is the central challenge of magnetic fusion energy. In devices like tokamaks, this confinement is achieved by carefully shaping magnetic fields to balance the immense plasma pressure. Understanding and predicting this state of magnetohydrodynamic (MHD) equilibrium is the first and most fundamental step in analyzing plasma performance, stability, and control. However, the full set of MHD equations is notoriously complex. This article addresses the crucial simplification that makes this problem tractable: the reduction of the 3D vector force-balance equation to a single 2D scalar equation in axisymmetric systems.

This article will guide you through the theory and application of the Grad–Shafranov equation, the cornerstone of MHD equilibrium analysis. In the **Principles and Mechanisms** chapter, we will derive the equation from first principles, explore the physical meaning of the [poloidal flux](@entry_id:753562) function $\psi$, and detail the formulation of the fixed-boundary problem and its numerical solution. Next, the **Applications and Interdisciplinary Connections** chapter demonstrates how [equilibrium solutions](@entry_id:174651) are used to calculate critical plasma parameters like the safety factor, reconstruct experimental data, and serve as the foundation for stability analysis and dynamic control models. Finally, the **Hands-On Practices** section provides a roadmap for implementing your own equilibrium solvers, from basic discretization to advanced nonlinear techniques. By the end, you will have a comprehensive understanding of how to compute and interpret the [magnetic structure](@entry_id:201216) that holds a star on Earth.

## Principles and Mechanisms

### The Fundamental Equation of Magnetostatic Equilibrium

The behavior of a magnetically confined plasma, on macroscopic scales, is governed by the equations of magnetohydrodynamics (MHD). For the purpose of determining the equilibrium state of a plasma in a confinement device, we are interested in configurations that are stationary in time. A static equilibrium is defined as a state where the plasma fluid velocity is zero ($\mathbf{v} = \mathbf{0}$) and all macroscopic quantities are independent of time ($\partial/\partial t = 0$).

The starting point for describing this equilibrium is the single-fluid MHD momentum equation:
$$
\rho \left( \frac{\partial \mathbf{v}}{\partial t} + (\mathbf{v} \cdot \nabla) \mathbf{v} \right) = \mathbf{J} \times \mathbf{B} - \nabla p + \rho_e \mathbf{E} + \mathbf{F}_{\text{ext}}
$$
where $\rho$ is the mass density, $\mathbf{v}$ is the fluid velocity, $\mathbf{J}$ is the current density, $\mathbf{B}$ is the magnetic field, $p$ is the scalar plasma pressure (assuming an isotropic pressure tensor and negligible viscosity), $\rho_e$ is the net charge density, $\mathbf{E}$ is the electric field, and $\mathbf{F}_{\text{ext}}$ represents external [body forces](@entry_id:174230) like gravity.

To arrive at the fundamental equation of magnetostatic equilibrium, we must apply a set of simplifying, yet physically well-justified, assumptions . First, we assume a **steady state**, so all time derivatives vanish. Second, we assume a **static plasma**, meaning the bulk fluid flow is zero, $\mathbf{v} = \mathbf{0}$. This immediately eliminates the inertial term, $(\mathbf{v} \cdot \nabla) \mathbf{v}$. Third, we invoke the **[quasineutrality](@entry_id:184567) approximation**, which states that on macroscopic scales, the plasma has no significant net charge density, so $\rho_e \approx 0$, eliminating the electrostatic force term $\rho_e \mathbf{E}$. Furthermore, for a static plasma, the ideal Ohm's Law, $\mathbf{E} + \mathbf{v} \times \mathbf{B} = \mathbf{0}$, simplifies to $\mathbf{E} = \mathbf{0}$. Finally, external forces such as gravity are entirely negligible compared to the immense electromagnetic and pressure forces in a fusion plasma.

Under these assumptions—a static, steady-state, quasineutral, ideal plasma with isotropic pressure—the full momentum equation reduces to a simple, elegant balance between the Lorentz force and the pressure [gradient force](@entry_id:166847):
$$
\nabla p = \mathbf{J} \times \mathbf{B}
$$
This equation is the cornerstone of MHD equilibrium theory. It states that in a static equilibrium, the [plasma pressure gradient](@entry_id:1129798) is everywhere balanced by the [magnetic force](@entry_id:185340) generated by the interaction of the [plasma current](@entry_id:182365) with the magnetic field.

A subtle but important question is whether a force density of the form $\mathbf{J} \times \mathbf{B}$ can always be expressed as the gradient of a single-valued scalar function $p$. A necessary condition for any vector field to be the gradient of a scalar is that it must be curl-free. The compatibility of the force-balance equation thus requires $\nabla \times (\mathbf{J} \times \mathbf{B}) = \mathbf{0}$. Using a standard vector identity and the solenoidal conditions on the magnetic field ($\nabla \cdot \mathbf{B} = 0$) and the [steady-state current](@entry_id:276565) density ($\nabla \cdot \mathbf{J} = 0$), this [compatibility condition](@entry_id:171102) reduces to $(\mathbf{B} \cdot \nabla)\mathbf{J} = (\mathbf{J} \cdot \nabla)\mathbf{B}$. While this appears restrictive, the existence of nested magnetic surfaces in axisymmetric systems, a direct consequence of $\nabla \cdot \mathbf{B} = 0$, provides the geometric structure needed to ensure this condition is met, thereby guaranteeing that a globally consistent scalar pressure field $p$ can exist .

### The Poloidal Flux Function in Axisymmetric Systems

The [force balance](@entry_id:267186) equation is a three-dimensional vector equation. For toroidal confinement devices like tokamaks, which possess a high degree of symmetry around the torus's central axis, a powerful simplification is possible. In a [cylindrical coordinate system](@entry_id:266798) $(R, \phi, Z)$, where $R$ is the major radius, $\phi$ is the toroidal angle, and $Z$ is the vertical coordinate, **axisymmetry** implies that all physical quantities are independent of $\phi$ ($\partial/\partial\phi = 0$).

The solenoidal nature of the magnetic field, $\nabla \cdot \mathbf{B} = 0$, allows us to define a [magnetic vector potential](@entry_id:141246) $\mathbf{A}$ such that $\mathbf{B} = \nabla \times \mathbf{A}$. In an axisymmetric system, this leads to the definition of a crucial scalar quantity, the **[poloidal magnetic flux](@entry_id:1129914) function**, $\psi(R,Z)$. It can be formally defined as the average toroidal [line integral](@entry_id:138107) of the vector potential :
$$
\psi(R,Z) \equiv \frac{1}{2\pi} \oint \mathbf{A} \cdot d\mathbf{l} = \frac{1}{2\pi} \int_0^{2\pi} A_\phi(R, \phi, Z) R \, d\phi
$$
For an axisymmetric system, we can always choose a gauge where $\mathbf{A}$ is also axisymmetric. In this gauge, the integral simplifies to $\psi(R,Z) = R A_\phi(R,Z)$. The physical meaning of $\psi$ is that $2\pi\psi$ represents the total magnetic flux passing through a disk of radius $R$ at height $Z$.

The true power of $\psi$ lies in its relationship to the magnetic field. The poloidal components of the magnetic field, $\mathbf{B}_p = B_R \hat{\mathbf{R}} + B_Z \hat{\mathbf{Z}}$, can be expressed directly in terms of the [partial derivatives](@entry_id:146280) of $\psi$. Starting from $\mathbf{B} = \nabla \times \mathbf{A}$ in an axisymmetric gauge, one finds :
$$
B_R(R,Z) = -\frac{1}{R} \frac{\partial \psi}{\partial Z}
$$
$$
B_Z(R,Z) = \frac{1}{R} \frac{\partial \psi}{\partial R}
$$
These relationships can be written more compactly as $\mathbf{B}_p = \frac{1}{R} \nabla \psi \times \hat{\boldsymbol{\phi}}$.

From this, we can prove a fundamental property. The dot product of the magnetic field with the gradient of $\psi$ is:
$$
\mathbf{B} \cdot \nabla \psi = B_R \frac{\partial \psi}{\partial R} + B_Z \frac{\partial \psi}{\partial Z} = \left(-\frac{1}{R}\frac{\partial \psi}{\partial Z}\right)\frac{\partial \psi}{\partial R} + \left(\frac{1}{R}\frac{\partial \psi}{\partial R}\right)\frac{\partial \psi}{\partial Z} = 0
$$
Since $\nabla \psi$ is by definition normal to surfaces of constant $\psi$, the condition $\mathbf{B} \cdot \nabla \psi = 0$ proves that the magnetic field vector $\mathbf{B}$ is everywhere tangent to surfaces of constant $\psi$. These surfaces are therefore known as **[magnetic flux surfaces](@entry_id:751623)**. The plasma is confined on a set of nested, toroidal magnetic surfaces. The magnitude of the poloidal field is also directly related to $\psi$ :
$$
|\mathbf{B}_p| = \sqrt{B_R^2 + B_Z^2} = \frac{1}{R} \sqrt{\left(\frac{\partial \psi}{\partial R}\right)^2 + \left(\frac{\partial \psi}{\partial Z}\right)^2} = \frac{|\nabla \psi|}{R}
$$
This expression reveals a key geometric feature of toroidal confinement: for a given spacing of flux surfaces (i.e., a given $|\nabla \psi|$), the poloidal magnetic field is stronger on the inboard side (small $R$) of the torus than on the outboard side (large $R$).

### The Free Functions of Equilibrium: $p(\psi)$ and $F(\psi)$

We have established two fundamental properties of static, ideal MHD equilibria: the pressure is constant along magnetic field lines ($\mathbf{B} \cdot \nabla p = 0$), and the field lines themselves lie on surfaces of constant $\psi$. Combining these facts, it follows that the plasma pressure $p$ must be constant on each [magnetic flux surface](@entry_id:751622). This means that pressure is not an arbitrary function of $R$ and $Z$, but is instead a function of $\psi$ alone: $p = p(\psi)$ .

A similar property holds for the [toroidal magnetic field](@entry_id:756057). By examining the force balance equation in axisymmetry, one can show that the quantity $F \equiv R B_\phi$ must also be a flux function, i.e., $F = F(\psi)$. The function $p(\psi)$ is known as the **pressure profile**, and $F(\psi)$ is often called the **toroidal field function** or poloidal current function.

These two scalar functions, $p(\psi)$ and $F(\psi)$, are not determined by the [equilibrium equation](@entry_id:749057) itself. They are "free functions" that must be specified to define a particular equilibrium solution. Their physical significance is profound:
-   **$p(\psi)$**: This function directly specifies the plasma pressure on each flux surface, defining the thermodynamic state of the confined plasma. Its derivative, $dp/d\psi$, acts as a source for the [toroidal plasma](@entry_id:202484) current.
-   **$F(\psi)$**: This function determines the toroidal magnetic field via $B_\phi = F(\psi)/R$. Its derivative, $dF/d\psi$, acts as a source for the poloidal plasma current, which flows within each flux surface in the poloidal ($R-Z$) plane .

Together, $p(\psi)$ and $F(\psi)$ completely specify the sources of current and pressure that are balanced by the magnetic field geometry in an MHD equilibrium.

### The Grad–Shafranov Equation and the Fixed-Boundary Problem

By substituting the expressions for $\mathbf{B}$ and $\mathbf{J}$ (derived from $\mathbf{B}$) in terms of $\psi$, $p(\psi)$, and $F(\psi)$ into the [force balance](@entry_id:267186) equation, the three-dimensional vector problem can be reduced to a single, two-dimensional, scalar partial differential equation (PDE) for the [poloidal flux](@entry_id:753562) function $\psi(R,Z)$. This is the celebrated **Grad–Shafranov equation**:
$$
\Delta^* \psi = - \mu_0 R^2 \frac{dp}{d\psi} - F(\psi) \frac{dF}{d\psi}
$$
Here, $\Delta^*$ is the Grad–Shafranov operator, defined in [cylindrical coordinates](@entry_id:271645) as:
$$
\Delta^* \psi \equiv R^2 \nabla \cdot \left( \frac{1}{R^2} \nabla \psi \right) = \frac{\partial^2 \psi}{\partial R^2} - \frac{1}{R} \frac{\partial \psi}{\partial R} + \frac{\partial^2 \psi}{\partial Z^2}
$$
The Grad–Shafranov equation is a semi-linear, elliptic PDE. The terms on the right-hand side, which depend on the derivatives of the free functions $p(\psi)$ and $F(\psi)$, act as the source for the poloidal flux.

A **fixed-boundary equilibrium problem** is a specific mathematical formulation for solving this equation . In this formulation, we pre-define:
1.  A computational domain $\Omega$ in the poloidal plane, which represents the cross-section of the plasma.
2.  A Dirichlet boundary condition on the boundary of this domain, $\partial \Omega$, specifying the value of the poloidal flux on it, i.e., $\psi|_{\partial \Omega} = \psi_b$. Usually, $\psi_b$ is a constant, making the boundary itself a flux surface.
3.  The functional forms of the two free functions, $p(\psi)$ and $F(\psi)$, inside the domain $\Omega$.

Physically, the boundary $\partial \Omega$ is taken to be the **Last Closed Flux Surface (LCFS)**, which defines the edge of the confined plasma. "Fixing the boundary" means that the shape of the plasma is prescribed as an input to the problem. The solver's task is then to find the internal [magnetic structure](@entry_id:201216), $\psi(R,Z)$, that is in force balance, given this fixed shape and the specified pressure and current profiles. This is in contrast to a [free-boundary problem](@entry_id:636836), where external coil currents are specified and the plasma's shape and position are found self-consistently as part of the solution.

### Numerical Solution of the Fixed-Boundary Problem

#### Discretization of the Operator

To solve the Grad–Shafranov equation numerically, one must first discretize the $\Delta^*$ operator. A common approach is the finite difference method on a uniform grid in $(R,Z)$. For a conservative and second-order accurate scheme, it is best to work with the self-adjoint form of the operator, $\Delta^*\psi = R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) + \frac{\partial^2\psi}{\partial Z^2}$.

Using central differences on a grid with spacing $\Delta R$ and $\Delta Z$, the second derivative in $Z$ at a node $(i,j)$ is straightforwardly approximated as:
$$
\left. \frac{\partial^2\psi}{\partial Z^2} \right|_{i,j} \approx \frac{\psi_{i,j+1} - 2\psi_{i,j} + \psi_{i,j-1}}{(\Delta Z)^2}
$$
The radial part requires more care due to the $1/R$ factors. A robust method approximates the derivatives at the "faces" between grid points . This leads to the following discrete form for the radial part of the operator:
$$
\left. R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) \right|_{i,j} \approx \frac{R_i}{(\Delta R)^2} \left[ \frac{\psi_{i-1,j}}{R_{i-1/2}} - \left(\frac{1}{R_{i+1/2}} + \frac{1}{R_{i-1/2}}\right)\psi_{i,j} + \frac{\psi_{i+1,j}}{R_{i+1/2}} \right]
$$
where $R_{i\pm1/2} = R_i \pm \Delta R/2$ are the radial locations of the cell faces. Combining these gives a [5-point stencil](@entry_id:174268) that relates the value of $\Delta^*\psi$ at a point $(i,j)$ to the values of $\psi$ at that point and its four nearest neighbors. This discretization transforms the PDE into a large system of coupled algebraic equations, which can then be solved using matrix methods or iterative solvers.

#### Specifying the Equilibrium Profiles

A practical challenge in using a [fixed-boundary solver](@entry_id:1125044) is the choice of the free functions $p(\psi)$ and $F(\psi)$. These functions determine the distribution of pressure and current within the plasma and are critical for stability and performance. In practice, they are not chosen arbitrarily. Instead, they are constrained by global, physically measurable quantities .

Two of the most important global parameters are the total [toroidal plasma](@entry_id:202484) current, $I_p$, and the [poloidal beta](@entry_id:1129912), $\beta_p$.
-   The **total current** $I_p$ is the integral of the toroidal current density, $J_\phi = R \frac{dp}{d\psi} + \frac{F}{\mu_0 R} \frac{dF}{d\psi}$, over the plasma cross-section.
-   The **[poloidal beta](@entry_id:1129912)** $\beta_p$ is a dimensionless measure of plasma pressure relative to the pressure of the poloidal magnetic field, $\beta_p = (2\mu_0 \int p \, dA) / (\int B_p^2 \, dA)$.

Specifying desired values for $I_p$ and $\beta_p$ imposes two independent, global, integral constraints on the problem. These two constraints are not sufficient to uniquely determine the infinite-dimensional functional forms of $p(\psi)$ and $F(\psi)$. However, if one parameterizes the profiles (e.g., $p(\psi) = p_0 (1-\hat{\psi})^\alpha$), these global constraints can be used to solve for two of the free parameters (e.g., the amplitude $p_0$ and another parameter related to $F$). This is a common procedure in [equilibrium reconstruction](@entry_id:749060) and analysis, where the profile shapes are assumed or parameterized, and their amplitudes are adjusted to match experimental measurements.

### Advanced Topics and Numerical Challenges

#### Separatrix and X-points

In modern tokamaks, the plasma is often bounded by a **[separatrix](@entry_id:175112)**, a special flux surface that separates the closed, [nested flux surfaces](@entry_id:752411) of the core plasma from the open field lines in the scrape-off layer. A [separatrix](@entry_id:175112) is characterized by the presence of one or more **X-points**, which are null points of the poloidal magnetic field ($|\mathbf{B}_p|=0$, or equivalently $|\nabla\psi|=0$).

The presence of a separatrix and X-points on the boundary of the computational domain introduces significant numerical challenges .
1.  **Reduced Regularity**: In a realistic model, the source terms $p'(\psi)$ and $F'(\psi)$ are non-zero inside the plasma but zero in the vacuum outside. This [jump discontinuity](@entry_id:139886) across the separatrix means the solution $\psi$ to the Grad–Shafranov equation is typically only $C^1$ (continuous with continuous first derivatives). The second derivatives normal to the [separatrix](@entry_id:175112) are discontinuous. Standard [high-order numerical methods](@entry_id:142601) (like spectral or high-order [finite element methods](@entry_id:749389)) lose their rapid convergence properties for non-smooth solutions.
2.  **Geometric Singularity**: The X-point itself is a geometric singularity (a corner) in the boundary. Elliptic theory shows that solutions to PDEs in domains with corners are themselves singular at the corner, with derivatives that may become unbounded.

These issues require special treatment. One approach is to use highly non-uniform, **anisotropically refined meshes** that are densified near the [separatrix](@entry_id:175112) and especially near the X-point to resolve the sharp features of the solution. Another common technique is to modify the physical model by **smoothing the profile functions** $p(\psi)$ and $F(\psi)$ across the separatrix. This creates a thin transition layer instead of a sharp boundary, which makes the source terms in the PDE smooth and restores the high regularity of the solution $\psi$. This improves the performance of [numerical solvers](@entry_id:634411), at the cost of a slight deviation from the ideal sharp-boundary model .

#### Inverse Problems and Physical Constraints

While fixed-boundary solvers solve the "[forward problem](@entry_id:749531)" (given profiles, find the geometry), a common task in experimental data analysis is the "inverse problem": given magnetic measurements and a fixed boundary shape, find the profiles $p(\psi)$ and $F(\psi)$ that best fit the data. This is typically formulated as a least-squares optimization problem.

A challenge in these inversion procedures is that [unconstrained optimization](@entry_id:137083) can lead to non-physical solutions, such as pressure profiles that are not monotonically decreasing outwards, or toroidal fields that violate engineering constraints. Enforcing these physical constraints is crucial. A robust method that preserves the [convexity](@entry_id:138568) of the optimization problem is to parameterize the profiles in a way that builds in the constraints . For example, to enforce pressure monotonicity ($dp/d\psi \le 0$), one can expand $dp/d\psi$ in a basis of non-negative functions with non-positive coefficients. Bound constraints on $F(\psi)$ can be imposed as a set of linear [inequality constraints](@entry_id:176084) on the coefficients of its [basis expansion](@entry_id:746689). The resulting problem is a **Quadratic Program (QP)**—the minimization of a quadratic objective function subject to [linear constraints](@entry_id:636966). This formulation is computationally robust and guarantees that the resulting profiles are physically admissible.