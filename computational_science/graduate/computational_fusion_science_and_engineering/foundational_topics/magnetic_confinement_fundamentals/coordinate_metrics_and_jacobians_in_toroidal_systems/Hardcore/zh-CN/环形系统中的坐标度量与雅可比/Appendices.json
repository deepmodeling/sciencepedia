{
    "hands_on_practices": [
        {
            "introduction": "我们实践的第一步是从最基本的原理出发，学习如何从一个给定的环状等离子体几何形状推导出其度规张量和雅可比行列式。这个练习将几何嵌入（例如包含沙夫拉诺夫位移的圆形截面）与描述该空间局部属性（如长度和体积）的关键数学工具直接联系起来。掌握这项基本技能对于在任何曲线坐标系中进行后续的物理分析和数值模拟至关重要。",
            "id": "3959669",
            "problem": "考虑一个具有圆形横截面的轴对称环形等离子体，其小半径坐标为 $r$，极向角为 $\\theta$，环向角为 $\\phi$（角度以弧度为单位）。主半径为 $R_0$，磁轴因 Shafranov 位移 $\\,\\Delta(r)\\,$ 而径向移动，该位移是 $r$ 的光滑函数。由 $(r,\\theta,\\phi)$ 标记的磁通面在三维欧几里得空间中的几何嵌入由柱坐标 $(R,\\phi,Z)$ 指定为\n$$\nR(r,\\theta) \\;=\\; R_0 \\;+\\; \\Delta(r) \\;+\\; r \\cos\\theta, \n\\qquad\nZ(r,\\theta) \\;=\\; r \\sin\\theta,\n$$\n其通常的笛卡尔表示为 $(x,y,z)=(R\\cos\\phi,\\,R\\sin\\phi,\\,Z)$。仅使用欧几里得空间中曲线坐标的第一性原理（协变基矢量、度规张量和坐标雅可比的定义），推导坐标卡 $(r,\\theta,\\phi)$ 的协变度规分量 $g_{\\phi\\phi}$ 和坐标雅可比 $J$，并保留所有对 Shafranov 位移导数 $\\Delta'(r)$ 的依赖关系。假设坐标卡是右手的，并取雅可比为正。用 $R_0$、$\\Delta(r)$、$\\Delta'(r)$、$r$ 和 $\\theta$ 将最终答案表示为单行矩阵 $\\big(g_{\\phi\\phi},\\,J\\big)$。",
            "solution": "该问题要求推导给定环形坐标系 $(r, \\theta, \\phi)$ 的协变度规张量分量 $g_{\\phi\\phi}$ 和坐标雅可比 $J$。推导必须从第一性原理出发。\n\n首先，我们建立欧几里得空间中一个点的位置矢量 $\\mathbf{x}$，该点由曲线坐标 $(r, \\theta, \\phi)$ 描述。问题给出了到柱坐标 $(R, \\phi, Z)$ 然后到笛卡尔坐标 $(x, y, z)$ 的变换。设笛卡尔基矢量为 $(\\hat{\\mathbf{i}}, \\hat{\\mathbf{j}}, \\hat{\\mathbf{k}})$。\n\n给定的关系式为：\n$$R(r,\\theta) = R_0 + \\Delta(r) + r \\cos\\theta$$\n$$Z(r,\\theta) = r \\sin\\theta$$\n笛卡尔坐标表示为：\n$$x(r,\\theta,\\phi) = R(r,\\theta) \\cos\\phi$$\n$$y(r,\\theta,\\phi) = R(r,\\theta) \\sin\\phi$$\n$$z(r,\\theta) = Z(r,\\theta) = r \\sin\\theta$$\n因此，位置矢量 $\\mathbf{x}(r, \\theta, \\phi)$ 为：\n$$\\mathbf{x}(r, \\theta, \\phi) = R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{j}} + r \\sin\\theta \\, \\hat{\\mathbf{k}}$$\n\n协变基矢量 $\\mathbf{e}_i$ 定义为位置矢量关于曲线坐标 $q^i$ 的偏导数。在我们的例子中，坐标为 $(q^1, q^2, q^3) = (r, \\theta, \\phi)$。\n$$\\mathbf{e}_r = \\frac{\\partial \\mathbf{x}}{\\partial r}, \\quad \\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{x}}{\\partial \\theta}, \\quad \\mathbf{e}_\\phi = \\frac{\\partial \\mathbf{x}}{\\partial \\phi}$$\n\n协变度规张量的分量 $g_{ij}$ 由基矢量的点积给出：\n$$g_{ij} = \\mathbf{e}_i \\cdot \\mathbf{e}_j$$\n\n我们需要求 $g_{\\phi\\phi}$。我们首先计算基矢量 $\\mathbf{e}_\\phi$：\n$$\\mathbf{e}_\\phi = \\frac{\\partial}{\\partial \\phi} \\left( R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{j}} + r \\sin\\theta \\, \\hat{\\mathbf{k}} \\right)$$\n$$\\mathbf{e}_\\phi = -R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{j}}$$\n现在我们将 $g_{\\phi\\phi}$ 计算为 $\\mathbf{e}_\\phi$ 与自身的标量积：\n$$g_{\\phi\\phi} = \\mathbf{e}_\\phi \\cdot \\mathbf{e}_\\phi = (-R(r,\\theta) \\sin\\phi)^2 + (R(r,\\theta) \\cos\\phi)^2$$\n$$g_{\\phi\\phi} = R(r,\\theta)^2 \\sin^2\\phi + R(r,\\theta)^2 \\cos^2\\phi = R(r,\\theta)^2 (\\sin^2\\phi + \\cos^2\\phi)$$\n$$g_{\\phi\\phi} = R(r,\\theta)^2$$\n代入给定的 $R(r, \\theta)$ 表达式：\n$$g_{\\phi\\phi} = (R_0 + \\Delta(r) + r \\cos\\theta)^2$$\n\n接下来，我们推导坐标雅可比 $J$。雅可比是变换的体积元，由基矢量的标量三重积的模给出，即 $J = |\\mathbf{e}_r \\cdot (\\mathbf{e}_\\theta \\times \\mathbf{e}_\\phi)|$。这等价于从 $(r, \\theta, \\phi)$ 到 $(x, y, z)$ 变换的雅可比矩阵行列式的绝对值。\n$$J = \\left| \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}\\right) \\right|$$\n问题指定雅可比取正值，这与该定义一致。计算此行列式的一个便捷方法是使用雅可比的链式法则，引入柱坐标 $(R, \\phi, Z)$ 作为中间坐标系。\n$$ \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}\\right) = \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(R,\\phi,Z)}\\right) \\det\\left(\\frac{\\partial(R,\\phi,Z)}{\\partial(r,\\theta,\\phi)}\\right) $$\n首先，我们求从柱坐标到笛卡尔坐标变换的雅可比。坐标按 $(R, \\phi, Z)$ 排序以对应右手系。\n$$ \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(R,\\phi,Z)}\\right) = \\det \\begin{pmatrix} \\cos\\phi & -R\\sin\\phi & 0 \\\\ \\sin\\phi & R\\cos\\phi & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = R(\\cos^2\\phi + \\sin^2\\phi) = R $$\n其次，我们求从我们的环形坐标 $(r,\\theta,\\phi)$ 到中间柱坐标 $(R,Z,\\phi)$ 变换的雅可比。注意重新排序为 $(R,Z,\\phi)$ 以匹配矩阵计算。\n$$R = R(r,\\theta), \\quad Z = Z(r,\\theta), \\quad \\phi=\\phi$$\n$$ \\det\\left(\\frac{\\partial(R,Z,\\phi)}{\\partial(r,\\theta,\\phi)}\\right) = \\det \\begin{pmatrix} \\frac{\\partial R}{\\partial r} & \\frac{\\partial R}{\\partial \\theta} & \\frac{\\partial R}{\\partial \\phi} \\\\ \\frac{\\partial Z}{\\partial r} & \\frac{\\partial Z}{\\partial \\theta} & \\frac{\\partial Z}{\\partial \\phi} \\\\ \\frac{\\partial \\phi}{\\partial r} & \\frac{\\partial \\phi}{\\partial \\theta} & \\frac{\\partial \\phi}{\\partial \\phi} \\end{pmatrix} = \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta & 0 \\\\ \\sin\\theta & r\\cos\\theta & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\n行列式由左上角的 $2 \\times 2$ 子行列式给出：\n$$ (\\Delta'(r)+\\cos\\theta)(r\\cos\\theta) - (-r\\sin\\theta)(\\sin\\theta) = r\\Delta'(r)\\cos\\theta + r\\cos^2\\theta + r\\sin^2\\theta $$\n$$ = r\\Delta'(r)\\cos\\theta + r(\\cos^2\\theta + \\sin^2\\theta) = r(1 + \\Delta'(r)\\cos\\theta) $$\n注意到关于手性（handedness）的一个微妙之处至关重要。如定义的变换，坐标顺序为 $(r, \\theta, \\phi)$，自然产生一个左手系，其雅可比行列式将为负。在中间步骤中不同的坐标排序，例如 $(R, \\phi, Z)$ 对比 $(r, \\theta, \\phi)$，可能会引入符号变化。让我们通过交换列来验证完整的雅可比行列式符号，以匹配从 $(r,\\theta,\\phi)$到 $(R,\\phi,Z)$ 的映射。\n$$ \\det\\left(\\frac{\\partial(R,\\phi,Z)}{\\partial(r,\\theta,\\phi)}\\right) = \\det \\begin{pmatrix} \\frac{\\partial R}{\\partial r} & \\frac{\\partial R}{\\partial \\theta} & \\frac{\\partial R}{\\partial \\phi} \\\\ \\frac{\\partial \\phi}{\\partial r} & \\frac{\\partial \\phi}{\\partial \\theta} & \\frac{\\partial \\phi}{\\partial \\phi} \\\\ \\frac{\\partial Z}{\\partial r} & \\frac{\\partial Z}{\\partial \\theta} & \\frac{\\partial Z}{\\partial \\phi} \\end{pmatrix} = \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta & 0 \\\\ 0 & 0 & 1 \\\\ \\sin\\theta & r\\cos\\theta & 0 \\end{pmatrix} $$\n沿第二行展开：\n$$ -1 \\times \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta \\\\ \\sin\\theta & r\\cos\\theta \\end{pmatrix} = -r(1 + \\Delta'(r)\\cos\\theta) $$\n变换 $\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}$ 的完整行列式是两个行列式的乘积：\n$$ \\det = R \\times [-r(1 + \\Delta'(r)\\cos\\theta)] = -rR(1 + \\Delta'(r)\\cos\\theta) $$\n雅可比 $J$ 是体积元，必须为正。按照指示，我们取正值，这对应于选择一个形成右手系的坐标排序。\n$$ J = | -rR(1 + \\Delta'(r)\\cos\\theta) | $$\n对于一个物理上相关的环形等离子体，$r>0$，$R>0$，并且 Shafranov 位移导数 $\\Delta'(r)$ 足够小，使得 $1+\\Delta'(r)\\cos\\theta > 0$。因此：\n$$ J = rR(1 + \\Delta'(r)\\cos\\theta) $$\n代入 $R(r, \\theta)$ 的表达式：\n$$ J = r(R_0 + \\Delta(r) + r\\cos\\theta)(1 + \\Delta'(r)\\cos\\theta) $$\n\n最终答案要求一个行矩阵 $(g_{\\phi\\phi}, J)$。\n$g_{\\phi\\phi} = (R_0 + \\Delta(r) + r \\cos\\theta)^2$\n$J = r(R_0 + \\Delta(r) + r \\cos\\theta)(1 + \\Delta'(r)\\cos\\theta)$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n(R_0 + \\Delta(r) + r \\cos\\theta)^2 & r(R_0 + \\Delta(r) + r \\cos\\theta)(1 + \\Delta'(r)\\cos\\theta)\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在掌握了度规和雅可比行列式的基本计算之后，我们将探讨这些几何量如何受到物理定律的约束。在磁约束聚变中，Boozer坐标系因其能简化漂移运动和输运方程而备受青睐，但这种简化是有代价的：坐标系的雅可比行列式 $J$ 必须与磁场强度 $B$ 的平方成反比。通过这个练习，我们将分析性地推导出在磁轴附近，磁场的微小变化如何直接导致雅可比行列式产生相应的角度依赖性，从而加深对“好”坐标系物理本质的理解。",
            "id": "3959767",
            "problem": "考虑环形等离子体中的直场线磁流形坐标，记为 $(\\psi,\\theta,\\phi)$，其中 $\\psi$ 是一个嵌套磁面标签（与环向磁通量成正比），$\\theta$ 是极向角，$\\phi$ 是环向角。坐标雅可比 $J$ 由 $J^{-1} = (\\nabla \\psi \\times \\nabla \\theta) \\cdot \\nabla \\phi$ 定义。假设磁场 $\\boldsymbol{B}$ 是无散的，并允许使用 Clebsch 表示 $\\boldsymbol{B} = \\nabla \\psi \\times \\nabla \\alpha$，其中磁力线在 $(\\theta,\\phi)$ 中是直的，因此 $\\alpha = \\theta - \\iota(\\psi)\\,\\phi$，而 $\\iota(\\psi)$ 是旋转变换。在 Boozer 坐标中，$\\boldsymbol{B}$ 的协变分量是磁面函数：$\\boldsymbol{B} = I(\\psi)\\,\\nabla \\phi + G(\\psi)\\,\\nabla \\theta$，其中 $I(\\psi)$ 和 $G(\\psi)$ 分别是环向和极向协变系数。\n\n假设在磁轴附近，给定磁面上的磁场大小随极向角的变化为 $B(\\theta) \\approx B_0 \\left(1 - \\epsilon \\cos \\theta\\right)$，其中 $0<\\epsilon \\ll 1$，$B_0$ 是轴上参考场强。在 $\\epsilon$ 的主导阶下，并将 $I(\\psi)$、$G(\\psi)$ 和 $\\iota(\\psi)$ 视为在所选磁面上的常数，推导上述定义所隐含的 Boozer 坐标雅可比 $J(\\theta)$ 的一阶极向角相关性。你的推导必须从给定的坐标和磁场定义开始，并且只使用标准的矢量微积分恒等式和磁流形坐标的性质。\n\n将你的最终答案表示为关于 $I$、$G$、$\\iota$、$B_0$、$\\epsilon$ 和 $\\theta$ 的单个闭式解析表达式 $J(\\theta)$，保留到 $\\epsilon$ 阶的项。指定角度 $\\theta$ 以弧度为单位。不需要进行数值计算。",
            "solution": "该问题陈述被评估为有效。它在科学上基于磁流体动力学和等离子体物理学的既定原理，特别是关于环向磁约束。所提供的定义和关系在聚变科学领域是标准的。该问题是适定的、客观的，并包含足够的信息来推导出一个唯一的解析解。\n\n推导过程是通过关联所提供的磁场 $\\boldsymbol{B}$ 和坐标雅可比 $J$ 的各种定义来进行的。背景设定是一个直场线磁流形坐标系 $(\\psi, \\theta, \\phi)$，其中 $\\psi$ 是磁面标签，$\\theta$ 是极向角，$\\phi$ 是环向角。\n\n我们得到了磁场 $\\boldsymbol{B}$ 的两种表示。第一种是 Clebsch 形式，对于其中 $\\alpha = \\theta - \\iota(\\psi)\\phi$ 的直场线，其形式为：\n$$\n\\boldsymbol{B} = \\nabla\\psi \\times \\nabla\\alpha = \\nabla\\psi \\times \\nabla(\\theta - \\iota(\\psi)\\phi)\n$$\n在单个磁面上，$\\iota(\\psi)$ 被视为常数 $\\iota$。此外，我们可以将 $\\alpha$ 的梯度展开为 $\\nabla\\alpha = \\nabla\\theta - \\iota\\nabla\\phi - \\phi\\frac{\\mathrm{d}\\iota}{\\mathrm{d}\\psi}\\nabla\\psi$。\n\n磁场的逆变分量 $B^i = \\boldsymbol{B} \\cdot \\nabla q^i$ 可以从这种形式计算得出。极向逆变分量 $B^\\theta$ 是：\n$$\nB^\\theta = \\boldsymbol{B} \\cdot \\nabla\\theta = (\\nabla\\psi \\times \\nabla\\alpha) \\cdot \\nabla\\theta = \\nabla\\psi \\cdot (\\nabla\\alpha \\times \\nabla\\theta)\n$$\n代入 $\\nabla\\alpha$ 的展开式：\n$$\nB^\\theta = \\nabla\\psi \\cdot \\left[ \\left(\\nabla\\theta - \\iota\\nabla\\phi - \\phi\\frac{\\mathrm{d}\\iota}{\\mathrm{d}\\psi}\\nabla\\psi\\right) \\times \\nabla\\theta \\right]\n$$\n使用矢量恒等式 $(\\nabla\\theta \\times \\nabla\\theta = 0)$ 和 $((\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\psi = 0)$，上式简化为：\n$$\nB^\\theta = \\nabla\\psi \\cdot (-\\iota\\nabla\\phi \\times \\nabla\\theta) = \\iota \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi)\n$$\n根据定义，坐标雅可比 $J$ 由 $J^{-1} = (\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\phi = \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi)$ 给出。因此，我们发现：\n$$\nB^\\theta = \\iota J^{-1}\n$$\n类似地，对于环向逆变分量 $B^\\phi$：\n$$\nB^\\phi = \\boldsymbol{B} \\cdot \\nabla\\phi = (\\nabla\\psi \\times \\nabla\\alpha) \\cdot \\nabla\\phi = \\nabla\\psi \\cdot (\\nabla\\alpha \\times \\nabla\\phi)\n$$\n$$\nB^\\phi = \\nabla\\psi \\cdot \\left[ (\\nabla\\theta - \\iota\\nabla\\phi) \\times \\nabla\\phi \\right] = \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi) - \\iota \\nabla\\psi \\cdot (\\nabla\\phi \\times \\nabla\\phi)\n$$\n这简化为：\n$$\nB^\\phi = \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi) = J^{-1}\n$$\n所以，场的逆变表示具有分量 $B^\\psi=0$，$B^\\theta=\\iota/J$ 和 $B^\\phi=1/J$。\n\n提供的第二种表示是 Boozer 坐标的协变形式：\n$$\n\\boldsymbol{B} = G(\\psi)\\nabla\\theta + I(\\psi)\\nabla\\phi\n$$\n在所选磁面上，$G(\\psi)$ 和 $I(\\psi)$ 被视为常数 $G$ 和 $I$。这里，$B_\\theta = G$ 和 $B_\\phi = I$ 是协变分量。\n\n为找到这些量之间的关系，我们通过组合协变和逆变形式来计算磁场大小的平方 $B^2 = \\boldsymbol{B} \\cdot \\boldsymbol{B}$：\n$$\nB^2 = \\boldsymbol{B} \\cdot \\boldsymbol{B} = (G\\nabla\\theta + I\\nabla\\phi) \\cdot \\boldsymbol{B} = G(\\boldsymbol{B} \\cdot \\nabla\\theta) + I(\\boldsymbol{B} \\cdot \\nabla\\phi)\n$$\n代入逆变分量 $B^\\theta$ 和 $B^\\phi$ 的表达式：\n$$\nB^2 = G B^\\theta + I B^\\phi = G(\\iota J^{-1}) + I(J^{-1}) = \\frac{G\\iota + I}{J}\n$$\n这个关于 Boozer 坐标的基本关系可以重新整理，以磁场强度 $B$ 来表示雅可比 $J$：\n$$\nJ = \\frac{G\\iota + I}{B^2}\n$$\n问题给出了磁面上磁场大小的极向角变化：\n$$\nB(\\theta) \\approx B_0 (1 - \\epsilon \\cos\\theta)\n$$\n我们需要计算到 $\\epsilon$ 的一阶。我们首先计算 $B^2(\\theta)$：\n$$\nB^2(\\theta) \\approx \\left[B_0(1 - \\epsilon \\cos\\theta)\\right]^2 = B_0^2 (1 - 2\\epsilon \\cos\\theta + \\epsilon^2 \\cos^2\\theta)\n$$\n只保留到 $\\epsilon$ 阶的项，我们有：\n$$\nB^2(\\theta) \\approx B_0^2 (1 - 2\\epsilon \\cos\\theta)\n$$\n现在，将此代入 $J$ 的表达式中：\n$$\nJ(\\theta) \\approx \\frac{G\\iota + I}{B_0^2(1 - 2\\epsilon \\cos\\theta)} = \\frac{G\\iota + I}{B_0^2} (1 - 2\\epsilon \\cos\\theta)^{-1}\n$$\n为了得到 $\\epsilon$ 的一阶最终表达式，我们对小的 $|x|$ 应用二项式近似 $(1+x)^n \\approx 1+nx$。这里，$x = -2\\epsilon \\cos\\theta$ 且 $n=-1$：\n$$\n(1 - 2\\epsilon \\cos\\theta)^{-1} \\approx 1 + (-1)(-2\\epsilon \\cos\\theta) = 1 + 2\\epsilon \\cos\\theta\n$$\n将此代回，我们得到雅可比极向角相关性的最终表达式：\n$$\nJ(\\theta) \\approx \\frac{G\\iota + I}{B_0^2} (1 + 2\\epsilon \\cos\\theta)\n$$",
            "answer": "$$\n\\boxed{\\frac{G\\iota + I}{B_0^2} \\left(1 + 2\\epsilon \\cos\\theta\\right)}\n$$"
        },
        {
            "introduction": "理论推导和分析是基础，但最终我们需要在计算机上实现这些坐标系。这个最终的实践练习将我们带入计算聚变科学的核心挑战之一：坐标奇异性。通过为一个简单的环状坐标系编写程序，我们将学习如何基于雅可比行列式 $|J|$ 和度规张量 $g$ 的条件数来自动检测这些数值“雷区”，并实施一种巧妙的网格重构策略来规避它们，从而确保数值模拟的稳定性和准确性。",
            "id": "3959688",
            "problem": "给定一个用于计算聚变科学与工程的圆形同心环通量坐标映射，由大半径 $R_0$ 和小半径 $a$ 定义。计算坐标 $(\\rho,\\theta,\\zeta)$ 通过以下方式映射到欧几里得笛卡尔坐标 $(x,y,z)$：\n$$\nx = \\big(R_0 + \\rho \\cos\\theta\\big)\\cos\\zeta,\\quad\ny = \\big(R_0 + \\rho \\cos\\theta\\big)\\sin\\zeta,\\quad\nz = \\rho \\sin\\theta,\n$$\n其中所有角度均以弧度为单位。考虑 $(\\rho,\\theta,\\zeta)$ 空间中的一个直线网格。您的任务是基于度规张量和雅可比矩阵，推导并实现一个坐标奇异性检测测试，然后应用一种网格重构策略来对问题区域附近的网格进行正则化。\n\n基本原理：\n- 坐标基向量为 $\\mathbf{e}_i = \\partial\\mathbf{r}/\\partial u^i$，其中 $u^1=\\rho$, $u^2=\\theta$, $u^3=\\zeta$，且 $\\mathbf{r}=(x,y,z)$。\n- 度规张量的协变分量形式为 $g_{ij} = \\mathbf{e}_i\\cdot\\mathbf{e}_j$。\n- 度规张量的行列式为 $\\det g = \\det(A^\\top A)$，其中 $A$ 是雅可比矩阵，其元素为 $A_{\\alpha i} = \\partial x^\\alpha/\\partial u^i$，且 $\\alpha\\in\\{x,y,z\\}$。\n- 雅可比行列式为 $J = \\det A$，对于到欧几里得空间的映射，它满足 $\\det g = J^2$。\n\n问题要求：\n1. 基于上述基本原理，推导给定映射的度规张量 $g_{ij}$ 的显式结构，并说明如何在每个网格点计算 $\\det g$ 和 $J$。您的推导必须仅基于所提供的定义。\n2. 定义一个奇异性检测准则，如果一个网格点满足 $|J| < \\tau_{\\text{abs}}$ 或度规矩阵 $g$ 的 2-范数条件数超过 $\\kappa_{\\max}$，则将其标记为问题点。使用 $\\tau_{\\text{abs}} = 10^{-6}$ 和 $\\kappa_{\\max} = 10^{12}$。\n3. 提出并实现一种网格重构策略，用于对此环形系统中的问题区域附近的网格进行正则化。您的策略必须是纯算法的，并且不得引入新的物理学。使用以下方法：\n   - 通过交错角向网格来排除精确的奇异线：对于整数索引 $j,k$，设置 $\\theta_j = 2\\pi\\left(j+\\tfrac{1}{2}\\right)/N_\\theta$ 和 $\\zeta_k = 2\\pi\\left(k+\\tfrac{1}{2}\\right)/N_\\zeta$。\n   - 通过径向平移的聚类映射来精确避免 $\\rho=0$：设置 $\\rho_i = \\epsilon + (a-\\epsilon)\\left(\\frac{i+\\tfrac{1}{2}}{N_\\rho}\\right)^p$，其中 $\\epsilon = 10^{-3}a$ 且 $p=2$。\n4. 实现一个程序，该程序：\n   - 使用包含端点的均匀网格构建初始网格：$\\rho_i = a\\,\\frac{i}{N_\\rho-1}$, $\\theta_j = 2\\pi\\,\\frac{j}{N_\\theta-1}$, $\\zeta_k = 2\\pi\\,\\frac{k}{N_\\zeta-1}$。\n   - 在每个网格点上计算 $g_{ij}$、$\\det g$、$J$ 以及 $g$ 的 2-范数条件数。\n   - 应用奇异性检测准则，并统计网格重构前被标记的点数。\n   - 按照第 3 项构建重构后的网格，并重复检测过程，统计网格重构后被标记的点数。\n   - 对于每个测试用例，报告一个元组，其中包含网格重构前被标记的点数、网格重构后被标记的点数、网格重构前 $|J|$ 的最小值以及网格重构后 $|J|$ 的最小值。\n5. 角度单位必须是弧度。除此角度单位规定外，不需要其他物理单位。\n\n测试套件：\n- 使用以下参数集 $(R_0,a,N_\\rho,N_\\theta,N_\\zeta)$：\n  - 案例 1（理想路径）：$(R_0,a,N_\\rho,N_\\theta,N_\\zeta) = (3.0,1.0,64,65,33)$。\n  - 案例 2（边界接近角环）：$(R_0,a,N_\\rho,N_\\theta,N_\\zeta) = (1.0,1.0,64,65,33)$。\n  - 案例 3（采样到精确内部简并的纺锤环区域）：$(R_0,a,N_\\rho,N_\\theta,N_\\zeta) = (0.8,1.0,41,65,33)$。\n  - 案例 4（粗网格）：$(R_0,a,N_\\rho,N_\\theta,N_\\zeta) = (3.0,1.0,8,13,7)$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，每个元素对应一个测试用例，并且本身是一个包含四个值的列表 $[\\text{flags\\_before},\\text{flags\\_after},\\min|J|_{\\text{before}},\\min|J|_{\\text{after}}]$。例如，格式必须类似于 $[[\\cdot,\\cdot,\\cdot,\\cdot],[\\cdot,\\cdot,\\cdot,\\cdot],\\ldots]$，不含多余文本。",
            "solution": "该问题要求推导环形坐标系的几何特性，实现奇异性检测算法，并评估一种网格重构策略。整个过程将基于微分几何原理在坐标变换中的应用。\n\n笛卡尔坐标 $(x, y, z)$ 是环形坐标 $(\\rho, \\theta, \\zeta)$ 的函数：\n$$\nx = \\big(R_0 + \\rho \\cos\\theta\\big)\\cos\\zeta \\\\\ny = \\big(R_0 + \\rho \\cos\\theta\\big)\\sin\\zeta \\\\\nz = \\rho \\sin\\theta\n$$\n其中 $R_0$ 是大半径，$\\rho$ 是小径向坐标，受小半径 $a$ 的限制。\n\n### 步骤 1：度规张量和雅可比矩阵的推导\n\n我们分析的基础是计算基向量与笛卡尔空间之间的关系。笛卡尔坐标中的位置向量 $\\mathbf{r}$ 是：\n$$\n\\mathbf{r}(\\rho, \\theta, \\zeta) = \\big(R_0 + \\rho \\cos\\theta\\big)\\cos\\zeta \\;\\hat{\\mathbf{i}} + \\big(R_0 + \\rho \\cos\\theta\\big)\\sin\\zeta \\;\\hat{\\mathbf{j}} + \\rho \\sin\\theta \\;\\hat{\\mathbf{k}}\n$$\n协变基向量 $\\mathbf{e}_i$ 定义为位置向量 $\\mathbf{r}$ 关于计算坐标 $u^i \\in \\{\\rho, \\theta, \\zeta\\}$ 的偏导数。\n\n关于 $\\rho$ 的基向量是：\n$$\n\\mathbf{e}_\\rho = \\frac{\\partial \\mathbf{r}}{\\partial \\rho} = (\\cos\\theta\\cos\\zeta, \\cos\\theta\\sin\\zeta, \\sin\\theta)\n$$\n关于 $\\theta$ 的基向量是：\n$$\n\\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{r}}{\\partial \\theta} = (-\\rho\\sin\\theta\\cos\\zeta, -\\rho\\sin\\theta\\sin\\zeta, \\rho\\cos\\theta)\n$$\n关于 $\\zeta$ 的基向量是：\n$$\n\\mathbf{e}_\\zeta = \\frac{\\partial \\mathbf{r}}{\\partial \\zeta} = \\big(-(R_0 + \\rho\\cos\\theta)\\sin\\zeta, (R_0 + \\rho\\cos\\theta)\\cos\\zeta, 0\\big)\n$$\n这些基向量构成了雅可比矩阵 $A$ 的列，其中 $A_{\\alpha i} = \\partial x^\\alpha / \\partial u^i$：\n$$\nA = \\begin{pmatrix} \\mathbf{e}_\\rho & \\mathbf{e}_\\theta & \\mathbf{e}_\\zeta \\end{pmatrix} = \n\\begin{pmatrix}\n\\cos\\theta \\cos\\zeta & -\\rho \\sin\\theta \\cos\\zeta & -(R_0 + \\rho \\cos\\theta)\\sin\\zeta \\\\\n\\cos\\theta \\sin\\zeta & -\\rho \\sin\\theta \\sin\\zeta & (R_0 + \\rho \\cos\\theta)\\cos\\zeta \\\\\n\\sin\\theta & \\rho \\cos\\theta & 0\n\\end{pmatrix}\n$$\n度规张量分量 $g_{ij}$ 由这些基向量的点积给出，$g_{ij} = \\mathbf{e}_i \\cdot \\mathbf{e}_j$。\n$$\ng_{\\rho\\rho} = \\mathbf{e}_\\rho \\cdot \\mathbf{e}_\\rho = (\\cos\\theta\\cos\\zeta)^2 + (\\cos\\theta\\sin\\zeta)^2 + (\\sin\\theta)^2 = \\cos^2\\theta(\\cos^2\\zeta + \\sin^2\\zeta) + \\sin^2\\theta = 1\n$$\n$$\ng_{\\theta\\theta} = \\mathbf{e}_\\theta \\cdot \\mathbf{e}_\\theta = (-\\rho\\sin\\theta\\cos\\zeta)^2 + (-\\rho\\sin\\theta\\sin\\zeta)^2 + (\\rho\\cos\\theta)^2 = \\rho^2\\sin^2\\theta + \\rho^2\\cos^2\\theta = \\rho^2\n$$\n$$\ng_{\\zeta\\zeta} = \\mathbf{e}_\\zeta \\cdot \\mathbf{e}_\\zeta = (R_0 + \\rho\\cos\\theta)^2\\sin^2\\zeta + (R_0 + \\rho\\cos\\theta)^2\\cos^2\\zeta = (R_0 + \\rho\\cos\\theta)^2\n$$\n非对角分量为零，表明这是一个正交坐标系。例如：\n$$\ng_{\\rho\\theta} = \\mathbf{e}_\\rho \\cdot \\mathbf{e}_\\theta = -\\rho\\cos\\theta\\sin\\theta\\cos^2\\zeta - \\rho\\cos\\theta\\sin\\theta\\sin^2\\zeta + \\rho\\sin\\theta\\cos\\theta = -\\rho\\cos\\theta\\sin\\theta + \\rho\\cos\\theta\\sin\\theta = 0\n$$\n类似的计算表明 $g_{\\rho\\zeta}=0$ 和 $g_{\\theta\\zeta}=0$。因此，度规张量是对角矩阵：\n$$\ng = \\begin{pmatrix}\n1 & 0 & 0 \\\\\n0 & \\rho^2 & 0 \\\\\n0 & 0 & (R_0 + \\rho\\cos\\theta)^2\n\\end{pmatrix}\n$$\n对角矩阵的行列式是其对角元素的乘积：\n$$\n\\det g = g_{\\rho\\rho} g_{\\theta\\theta} g_{\\zeta\\zeta} = \\rho^2 (R_0 + \\rho\\cos\\theta)^2\n$$\n雅可比行列式 $J = \\det A$，通过在草稿中进行代数余子式展开计算，得到 $J = -\\rho(R_0 + \\rho\\cos\\theta)$。我们可以使用已建立的关系 $\\det g = J^2$ 来验证这一点：\n$$\nJ^2 = \\big(-\\rho(R_0 + \\rho\\cos\\theta)\\big)^2 = \\rho^2 (R_0 + \\rho\\cos\\theta)^2 = \\det g\n$$\n这证实了我们的推导。其绝对值为 $|J| = \\rho |R_0 + \\rho\\cos\\theta|$。\n\n### 步骤 2：奇异性检测准则\n\n坐标奇异性发生在映射不是局部一对一的地方，这由消失的雅可比行列式 $|J| = 0$ 表示。问题提供了两个将点标记为问题点的准则：\n1.  $|J| < \\tau_{\\text{abs}}$，其中 $\\tau_{\\text{abs}} = 10^{-6}$。\n2.  度规张量的 2-范数条件数 $\\kappa_2(g)$ 超过 $\\kappa_{\\max} = 10^{12}$。\n\n对于像 $g$ 这样的对称正定矩阵，其 2-范数条件数是其最大特征值与最小特征值的比值，即 $\\kappa_2(g) = \\lambda_{\\max}/\\lambda_{\\min}$。由于 $g$ 是对角矩阵，其特征值就是其对角线元素：\n$$\n\\lambda_1 = 1, \\quad \\lambda_2 = \\rho^2, \\quad \\lambda_3 = (R_0 + \\rho\\cos\\theta)^2\n$$\n因此，条件数为：\n$$\n\\kappa_2(g) = \\frac{\\max(1, \\rho^2, (R_0 + \\rho\\cos\\theta)^2)}{\\min(1, \\rho^2, (R_0 + \\rho\\cos\\theta)^2)}\n$$\n$|J|$ 的奇异性在以下情况出现：\na) $\\rho \\to 0$。在这种情况下，$\\lambda_2 \\to 0$，导致 $\\lambda_{\\min} \\to 0$ 且 $\\kappa_2(g) \\to \\infty$。这对应于环面的轴（嵌套环面的中心）。\nb) $R_0 + \\rho\\cos\\theta \\to 0$。在这种情况下，$\\lambda_3 \\to 0$，导致 $\\lambda_{\\min} \\to 0$ 且 $\\kappa_2(g) \\to \\infty$。这对应于笛卡尔坐标的 $z$ 轴，对于角环（$R_0=a$）或纺锤环（$R_0 < a$），$z$ 轴可以成为定义域的一部分。\n\n因此，两个准则检测到的是相同的物理奇异点。\n\n### 步骤 3：网格重构策略\n\n初始的“均匀”网格定义为：\n$$\n\\rho_i = a\\,\\frac{i}{N_\\rho-1}, \\quad \\theta_j = 2\\pi\\,\\frac{j}{N_\\theta-1}, \\quad \\zeta_k = 2\\pi\\,\\frac{k}{N_\\zeta-1}\n$$\n该网格显式地采样了奇异点。对于 $i=0$，我们有 $\\rho_0=0$。在 $R_0 \\le a$ 的情况下，奇异点可能在 $\\theta=\\pi$ 处发生。对于像 $N_\\theta=65$ 这样的奇数个点，索引 $j=(N_\\theta-1)/2=32$ 会得到 $\\theta_{32} = 2\\pi \\frac{32}{64} = \\pi$，从而采样到该奇异点。\n\n所提出的网格重构策略旨在避免这些精确的奇异位置：\n$$\n\\rho_i = \\epsilon + (a-\\epsilon)\\left(\\frac{i+\\tfrac{1}{2}}{N_\\rho}\\right)^p, \\quad \\theta_j = 2\\pi\\left(j+\\tfrac{1}{2}\\right)/N_\\theta, \\quad \\zeta_k = 2\\pi\\left(k+\\tfrac{1}{2}\\right)/N_\\zeta\n$$\n其中 $\\epsilon = 10^{-3}a$ 且 $p=2$。\n\n重构网格分析：\n-   **径向网格**：最小的 $\\rho$ 值为 $\\rho_0 = \\epsilon + (a-\\epsilon)(0.5/N_\\rho)^p > \\epsilon > 0$。这避免了 $\\rho=0$ 的奇异性。指数 $p=2$ 使点在中心附近聚集，从而在曲率高的区域提高分辨率，同时仍然避开轴线。\n-   **角向网格**：“单元中心”或“交错”的角向网格 $\\theta_j$ 和 $\\zeta_k$ 定义在半开区间上。它们不采样端点 $0$ 和 $2\\pi$。如验证中所讨论，对于奇数 $N_\\theta$，点 $\\theta=\\pi$ 会被采样。然而，新的径向和角向网格的组合旨在防止 $|J|$ 变为零。例如，在角环（$R_0=a$）的情况下，奇异点发生在 $(\\rho=a, \\theta=\\pi)$。重构后的网格不会精确采样 $\\rho=a$（最大 $\\rho$ 小于 $a$），因此即使采样了 $\\theta=\\pi$，也能避免奇异点。对于纺锤环，类似的论证表明，离散点对 $(\\rho_i, \\theta_j)$ 不会满足奇异性条件 $R_0 + \\rho\\cos\\theta=0$。\n\n实现部分将构建两种网格，在每个点上计算度量 $|J|$ 和 $\\kappa_2(g)$，根据奇异性准则统计被标记的点数，并报告所需的统计数据以进行比较。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the toroidal coordinate singularity problem for a given set of test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (R0, a, N_rho, N_theta, N_zeta)\n        (3.0, 1.0, 64, 65, 33),  # Case 1: Standard torus\n        (1.0, 1.0, 64, 65, 33),  # Case 2: Horn torus\n        (0.8, 1.0, 41, 65, 33),  # Case 3: Spindle torus\n        (3.0, 1.0, 8, 13, 7),    # Case 4: Coarse grid\n    ]\n\n    results = []\n    \n    # Singularity detection parameters\n    tau_abs = 1.0e-6\n    kappa_max = 1.0e12\n\n    for R0, a, N_rho, N_theta, N_zeta in test_cases:\n        \n        # --- Part 1: Initial Uniform Grid ---\n        \n        # Construct initial uniform grids\n        rho_vals_unif = np.linspace(0.0, a, N_rho)\n        theta_vals_unif = np.linspace(0.0, 2 * np.pi, N_theta)\n        zeta_vals_unif = np.linspace(0.0, 2 * np.pi, N_zeta)\n\n        # Create meshgrid\n        RHO, THETA, _ = np.meshgrid(rho_vals_unif, theta_vals_unif, zeta_vals_unif, indexing='ij')\n\n        # Calculate |J| and condition number of g\n        abs_J = RHO * np.abs(R0 + RHO * np.cos(THETA))\n        \n        lambda1 = np.ones_like(RHO)\n        lambda2 = RHO**2\n        lambda3 = (R0 + RHO * np.cos(THETA))**2\n        \n        l_max = np.maximum.reduce([lambda1, lambda2, lambda3])\n        l_min = np.minimum.reduce([lambda1, lambda2, lambda3])\n\n        # Avoid division by zero warnings and handle inf/nan results\n        with np.errstate(divide='ignore', invalid='ignore'):\n            cond_g = l_max / l_min\n        \n        # Replace non-finite values (inf, nan) with a value larger than kappa_max\n        cond_g[~np.isfinite(cond_g)] = kappa_max + 1.0\n\n        # Apply singularity criteria and count flagged points\n        flagged_mask_before = (abs_J < tau_abs) | (cond_g > kappa_max)\n        flags_before = np.sum(flagged_mask_before)\n        min_J_before = np.min(abs_J)\n\n        # --- Part 2: Regridded Mesh ---\n\n        # Regridding parameters\n        epsilon = 1.0e-3 * a\n        p = 2.0\n\n        # Construct regridded meshes\n        i = np.arange(N_rho)\n        rho_vals_regrid = epsilon + (a - epsilon) * ((i + 0.5) / N_rho)**p\n        \n        j = np.arange(N_theta)\n        theta_vals_regrid = 2 * np.pi * (j + 0.5) / N_theta\n\n        k = np.arange(N_zeta)\n        zeta_vals_regrid = 2 * np.pi * (k + 0.5) / N_zeta\n\n        # Create new meshgrid\n        RHO_re, THETA_re, _ = np.meshgrid(rho_vals_regrid, theta_vals_regrid, zeta_vals_regrid, indexing='ij')\n\n        # Recalculate |J| and condition number of g\n        abs_J_re = RHO_re * np.abs(R0 + RHO_re * np.cos(THETA_re))\n\n        lambda1_re = np.ones_like(RHO_re)\n        lambda2_re = RHO_re**2\n        lambda3_re = (R0 + RHO_re * np.cos(THETA_re))**2\n\n        l_max_re = np.maximum.reduce([lambda1_re, lambda2_re, lambda3_re])\n        l_min_re = np.minimum.reduce([lambda1_re, lambda2_re, lambda3_re])\n\n        # Condition number calculation is safe as l_min_re will not be zero\n        cond_g_re = l_max_re / l_min_re\n        \n        # Apply singularity criteria and count flagged points\n        flagged_mask_after = (abs_J_re < tau_abs) | (cond_g_re > kappa_max)\n        flags_after = np.sum(flagged_mask_after)\n        min_J_after = np.min(abs_J_re)\n\n        # Store results for the current case\n        results.append([int(flags_before), int(flags_after), min_J_before, min_J_after])\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}