{
    "hands_on_practices": [
        {
            "introduction": "The safety factor, $q(r)$, is arguably the most important parameter characterizing a tokamak's magnetic configuration, as it governs plasma stability. This exercise reverses the typical problem-solving direction; instead of calculating $q(r)$ from a given current profile, you will determine the specific toroidal current density, $J_\\phi(r)$, required to produce an idealized, perfectly flat safety factor profile. This foundational practice solidifies the direct physical link between the plasma current, the poloidal magnetic field it generates, and the resulting field line helicity. ",
            "id": "359464",
            "problem": "In a tokamak, the magnetic field lines trace out helical paths on nested toroidal surfaces. The safety factor, $q(r)$, is a crucial parameter that quantifies the pitch of these helical field lines. It's defined as the number of toroidal transits a field line makes for one poloidal transit. For a large-aspect-ratio tokamak ($R_0 \\gg a$) with a circular plasma cross-section, the safety factor at a minor radius $r$ is given by the expression:\n$$\nq(r) = \\frac{r B_\\phi}{R_0 B_\\theta(r)}\n$$\nwhere $r$ is the minor radius, $R_0$ is the major radius, $B_\\phi$ is the toroidal magnetic field, and $B_\\theta(r)$ is the poloidal magnetic field. The poloidal magnetic field is generated by the toroidal plasma current density, $J_\\phi(r)$. The relationship between $B_\\theta(r)$ and $J_\\phi(r)$ is given by Ampère's law in its differential form, which for this geometry simplifies to:\n$$\nJ_\\phi(r) = \\frac{1}{\\mu_0 r} \\frac{d}{dr}\\big(r B_\\theta(r)\\big)\n$$\nwhere $\\mu_0$ is the permeability of free space.\n\nFor certain plasma stability considerations, it is desirable to have a specific safety factor profile. Consider an idealized scenario where the safety factor profile is perfectly flat throughout the plasma, i.e., $q(r) = q_0$ for all $r \\in [0, a]$, where $q_0$ is a positive constant and $a$ is the minor radius of the plasma edge. Assume the toroidal magnetic field $B_\\phi$ is uniform across the plasma cross-section.\n\nDerive the functional form of the toroidal current density profile, $J_\\phi(r)$, that produces this perfectly flat safety factor profile.",
            "solution": "1. The safety factor is defined by\n$$\nq(r)=\\frac{r\\,B_\\phi}{R_0\\,B_\\theta(r)}=q_0\\,,\n$$\nso\n$$\nB_\\theta(r)=\\frac{r\\,B_\\phi}{R_0\\,q_0}\\,.\n$$\n2. Compute\n$$\nr\\,B_\\theta(r)\n=\\frac{r^2\\,B_\\phi}{R_0\\,q_0}\n\\quad\\Longrightarrow\\quad\n\\frac{d}{dr}\\bigl(r\\,B_\\theta(r)\\bigr)\n=\\frac{2r\\,B_\\phi}{R_0\\,q_0}\\,.\n$$\n3. Ampère’s law gives\n$$\nJ_\\phi(r)\n=\\frac{1}{\\mu_0\\,r}\\,\\frac{d}{dr}\\bigl(r\\,B_\\theta(r)\\bigr)\n=\\frac{1}{\\mu_0\\,r}\\,\\frac{2r\\,B_\\phi}{R_0\\,q_0}\n=\\frac{2\\,B_\\phi}{\\mu_0\\,R_0\\,q_0}\\,.\n$$\nThus $J_\\phi(r)$ is uniform across the plasma radius.",
            "answer": "$$\\boxed{\\frac{2\\,B_\\phi}{\\mu_0\\,R_0\\,q_0}}$$"
        },
        {
            "introduction": "In a real tokamak, the safety factor profile is not flat but varies with radial location. This spatial variation gives rise to special \"rational\" magnetic surfaces where the field lines close upon themselves after a finite number of transits. This exercise will guide you through calculating the precise locations of these critical surfaces for a realistic, non-linear $q$-profile, a fundamental skill for predicting the location of magnetohydrodynamic (MHD) instabilities. ",
            "id": "4056088",
            "problem": "In an axisymmetric tokamak, magnetic field lines lie on nested toroidal magnetic surfaces labeled by the minor radius $r$ and the associated normalized radius $\\rho = r/a$, where $a$ is the plasma minor radius. The safety factor $q$ is defined as the field-line helicity, i.e., the ratio of toroidal to poloidal turns a field line makes per single circuit, and rational surfaces are those on which $q$ takes the rational value $q = m/n$ for integers $m$ and $n$, so that field lines close after $n$ poloidal and $m$ toroidal circuits.\n\nConsider a realistic monotonic safety-factor profile parameterized by the normalized radius $\\rho$ as\n$$\nq(\\rho) = q_{0} + \\frac{(q_{a} - q_{0})\\,\\rho^{2}}{1 + s\\,\\rho^{2}},\n$$\nwith $q_{0} = 0.9$, $q_{a} = 3.5$, $s = 0.8$, and plasma minor radius $a = 0.6\\,\\mathrm{m}$. Assume the plasma is well confined, so $0 \\leq \\rho \\leq 1$.\n\nStarting from the fundamental definition of rational surfaces $q(r) = m/n$, derive the condition for the existence of such surfaces in the given profile, and compute the minor radii $r$ (in meters) of the rational surfaces corresponding to the integer pairs $(m,n) = (2,1)$, $(3,2)$, and $(5,3)$. Your derivation should proceed from the base definition of $q$ as a field-line winding number and the given profile, without introducing any ad hoc shortcuts beyond algebraic manipulation.\n\nExpress your final numerical radii in meters and round your answers to four significant figures. If any pair $(m,n)$ does not correspond to a surface within the plasma (i.e., no solution with $0 \\leq \\rho \\leq 1$), state this and omit it from the final numerical set.",
            "solution": "The problem requires finding the minor radii $r$ of specific rational magnetic surfaces in a tokamak. A rational surface is defined by the condition that the safety factor $q$ is a rational number, $q = m/n$, where $m$ and $n$ are integers.\n\nThe given safety-factor profile is a function of the normalized minor radius $\\rho = r/a$:\n$$\nq(\\rho) = q_{0} + \\frac{(q_{a} - q_{0})\\,\\rho^{2}}{1 + s\\,\\rho^{2}}\n$$\nwhere $q_0 = 0.9$, $q_a = 3.5$, $s = 0.8$, and $a = 0.6\\,\\mathrm{m}$. The plasma is confined within $0 \\leq \\rho \\leq 1$.\n\nFirst, we derive the general condition for the existence of a rational surface within the plasma. To do this, we must determine the range of $q$ values spanned by the profile for $\\rho \\in [0, 1]$. We evaluate the profile at the boundaries of this domain:\nAt the magnetic axis ($\\rho = 0$):\n$$\nq(0) = q_{0} + \\frac{(q_{a} - q_{0})(0)^{2}}{1 + s(0)^{2}} = q_{0} = 0.9\n$$\nAt the plasma edge ($\\rho = 1$):\n$$\nq(1) = q_{0} + \\frac{(q_{a} - q_{0})(1)^{2}}{1 + s(1)^{2}} = q_{0} + \\frac{q_{a} - q_{0}}{1 + s}\n$$\nSubstituting the given values:\n$$\nq(1) = 0.9 + \\frac{3.5 - 0.9}{1 + 0.8} = 0.9 + \\frac{2.6}{1.8} = \\frac{9}{10} + \\frac{26}{18} = \\frac{9}{10} + \\frac{13}{9} = \\frac{81 + 130}{90} = \\frac{211}{90} \\approx 2.3444\n$$\nTo determine if rational surfaces exist between these values, we must check the monotonicity of the $q(\\rho)$ function. We compute the derivative of $q$ with respect to $\\rho$:\n$$\n\\frac{dq}{d\\rho} = (q_{a} - q_{0}) \\frac{d}{d\\rho}\\left(\\frac{\\rho^{2}}{1 + s\\,\\rho^{2}}\\right) = (q_{a} - q_{0}) \\left( \\frac{2\\rho(1 + s\\,\\rho^{2}) - \\rho^{2}(2s\\rho)}{(1 + s\\,\\rho^{2})^{2}} \\right)\n$$\n$$\n\\frac{dq}{d\\rho} = (q_{a} - q_{0}) \\left( \\frac{2\\rho + 2s\\rho^{3} - 2s\\rho^{3}}{(1 + s\\,\\rho^{2})^{2}} \\right) = \\frac{2\\rho(q_{a} - q_{0})}{(1 + s\\,\\rho^{2})^{2}}\n$$\nGiven $q_a = 3.5 > q_0 = 0.9$, the term $(q_a - q_0)$ is positive. For $\\rho > 0$, the numerator $2\\rho(q_a - q_0)$ is positive, and the denominator $(1+s\\rho^2)^2$ is always positive. Therefore, $dq/d\\rho > 0$ for $\\rho \\in (0, 1]$. This confirms that $q(\\rho)$ is a strictly monotonically increasing function.\n\nThe condition for the existence of a rational surface $q=m/n$ within the plasma is that its value must lie within the range of the $q$-profile, i.e., $q(0) \\leq m/n \\leq q(1)$. Numerically, this is $0.9 \\leq m/n \\leq 211/90$.\n\nTo find the location $\\rho$ of a rational surface, we set $q(\\rho) = m/n$. Let's denote the specific rational value as $Q = m/n$.\n$$\nQ = q_{0} + \\frac{(q_{a} - q_{0})\\,\\rho^{2}}{1 + s\\,\\rho^{2}}\n$$\nWe solve this equation for $\\rho^2$:\n$$\nQ - q_{0} = \\frac{(q_{a} - q_{0})\\,\\rho^{2}}{1 + s\\,\\rho^{2}}\n$$\n$$\n(Q - q_{0})(1 + s\\,\\rho^{2}) = (q_{a} - q_{0})\\,\\rho^{2}\n$$\n$$\nQ - q_{0} + s(Q - q_{0})\\,\\rho^{2} = (q_{a} - q_{0})\\,\\rho^{2}\n$$\n$$\nQ - q_{0} = \\rho^{2} \\left[ (q_{a} - q_{0}) - s(Q - q_{0}) \\right]\n$$\n$$\n\\rho^{2} = \\frac{Q - q_{0}}{(q_{a} - q_{0}) - s(Q - q_{0})}\n$$\nThe minor radius is then $r = a\\rho$.\n\nWe now apply this formula to the requested $(m,n)$ pairs.\n\n1.  **Pair $(m,n) = (2,1)$**:\n    $Q = 2/1 = 2$. This value is within the existence range $[0.9, 211/90]$.\n    $$\n    \\rho^{2} = \\frac{2 - 0.9}{(3.5 - 0.9) - 0.8(2 - 0.9)} = \\frac{1.1}{2.6 - 0.8(1.1)} = \\frac{1.1}{2.6 - 0.88} = \\frac{1.1}{1.72} = \\frac{110}{172} = \\frac{55}{86}\n    $$\n    $\\rho = \\sqrt{55/86} \\approx 0.799709$. This is in the valid range $0 \\leq \\rho \\leq 1$.\n    The minor radius is:\n    $$\n    r = a \\rho = 0.6 \\times \\sqrt{\\frac{55}{86}} \\approx 0.6 \\times 0.799709 \\approx 0.479825\\,\\mathrm{m}\n    $$\n    Rounding to four significant figures, $r_{(2,1)} \\approx 0.4798\\,\\mathrm{m}$.\n\n2.  **Pair $(m,n) = (3,2)$**:\n    $Q = 3/2 = 1.5$. This value is within the existence range $[0.9, 211/90]$.\n    $$\n    \\rho^{2} = \\frac{1.5 - 0.9}{(3.5 - 0.9) - 0.8(1.5 - 0.9)} = \\frac{0.6}{2.6 - 0.8(0.6)} = \\frac{0.6}{2.6 - 0.48} = \\frac{0.6}{2.12} = \\frac{60}{212} = \\frac{15}{53}\n    $$\n    $\\rho = \\sqrt{15/53} \\approx 0.531995$. This is in the valid range $0 \\leq \\rho \\leq 1$.\n    The minor radius is:\n    $$\n    r = a \\rho = 0.6 \\times \\sqrt{\\frac{15}{53}} \\approx 0.6 \\times 0.531995 \\approx 0.319197\\,\\mathrm{m}\n    $$\n    Rounding to four significant figures, $r_{(3,2)} \\approx 0.3192\\,\\mathrm{m}$.\n\n3.  **Pair $(m,n) = (5,3)$**:\n    $Q = 5/3 \\approx 1.6667$. This value is within the existence range $[0.9, 211/90]$.\n    $$\n    \\rho^{2} = \\frac{5/3 - 0.9}{(3.5 - 0.9) - 0.8(5/3 - 0.9)}\n    $$\n    Let's work with fractions: $Q - q_0 = 5/3 - 9/10 = (50 - 27)/30 = 23/30$.\n    Denominator: $(2.6) - (0.8)(23/30) = 13/5 - (4/5)(23/30) = 13/5 - 92/150 = (390 - 92)/150 = 298/150 = 149/75$.\n    $$\n    \\rho^2 = \\frac{23/30}{149/75} = \\frac{23}{30} \\times \\frac{75}{149} = \\frac{23}{2 \\times 15} \\times \\frac{5 \\times 15}{149} = \\frac{115}{298}\n    $$\n    $\\rho = \\sqrt{115/298} \\approx 0.621213$. This is in the valid range $0 \\leq \\rho \\leq 1$.\n    The minor radius is:\n    $$\n    r = a \\rho = 0.6 \\times \\sqrt{\\frac{115}{298}} \\approx 0.6 \\times 0.621213 \\approx 0.372728\\,\\mathrm{m}\n    $$\n    Rounding to four significant figures, $r_{(5,3)} \\approx 0.3727\\,\\mathrm{m}$.\n\nAll three pairs correspond to rational surfaces that exist within the specified plasma volume.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.4798 & 0.3192 & 0.3727 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Moving from analytical models to computational practice is a key step in fusion science. This advanced exercise requires you to implement a field-line-following algorithm to generate Poincaré sections, a powerful tool for visualizing magnetic field topology. By tracing field lines in a realistic, shaped, and perturbed tokamak geometry using straight-field-line coordinates, you will directly apply the concept that the safety factor $q$ governs the field line trajectory and gain insight into how magnetic islands or chaotic regions are identified computationally. ",
            "id": "4056092",
            "problem": "Consider a large aspect ratio tokamak configuration with nested toroidal magnetic flux surfaces labeled by the poloidal magnetic flux $\\psi$. A magnetic field line is a curve whose tangent is parallel to the magnetic field $\\mathbf{B}$ at every point. In straight-field-line coordinates $(\\psi,\\theta,\\phi)$, the coordinates are constructed such that magnetic field lines appear as straight lines when projected onto the $(\\theta,\\phi)$ plane. A Poincaré section at specified poloidal cuts consists of the set of intersection points of a single magnetic field line with surfaces defined by fixed poloidal angles, expressed here in terms of cylindrical coordinates $(R,Z)$.\n\nAssume an equilibrium geometry parameterized by a modified Miller-like model for the shape of flux surfaces, including a small non-axisymmetric harmonic perturbation. For a given flux surface characterized by the minor radius $r(\\psi)$, the cylindrical coordinates $(R,Z)$ are given by\n$$\nR(\\psi,\\theta,\\phi) = R_0 + \\Delta(\\psi) + r(\\psi)\\,\\cos\\!\\big(\\theta + \\delta \\sin\\theta\\big) + \\varepsilon_r\\,r(\\psi)\\,\\cos\\!\\big(m\\,\\theta - n\\,\\phi\\big),\n$$\n$$\nZ(\\psi,\\theta,\\phi) = \\kappa\\,r(\\psi)\\,\\sin\\theta + \\varepsilon_z\\,r(\\psi)\\,\\sin\\!\\big(m\\,\\theta - n\\,\\phi\\big),\n$$\nwhere $R_0$ is the major radius, $a$ is the minor radius at the plasma edge, $\\kappa$ is the elongation, $\\delta$ is the triangularity, $\\Delta(\\psi)$ is the Shafranov shift, and $\\varepsilon_r$ and $\\varepsilon_z$ are small dimensionless amplitudes of a non-axisymmetric $(m,n)$ perturbation. The safety factor profile is $q(\\psi)$, which is assumed constant on a flux surface.\n\nYour task is to implement field line following in straight-field-line coordinates and compute the Poincaré sections at specified poloidal cuts. You must:\n\n- Treat the magnetic field line parametrically along a curve parameter that advances the poloidal angle in radians, starting from an initial point $(\\psi,\\theta_0,\\phi_0)$ on a given flux surface.\n- Enforce that the magnetic field line remains on the same flux surface (constant $\\psi$), and that its advance in the toroidal angle is determined by the safety factor on that surface.\n- For each specified poloidal cut $\\theta=\\theta_{\\mathrm{cut}}$, compute a sequence of $N$ successive intersections, recording $(R,Z)$ at those points using the provided geometry. Angles must be in radians. Distances must be in meters.\n- Use the Shafranov shift model $\\Delta(\\psi) = \\Delta_0\\,[r(\\psi)/a]^2$ with a given constant $\\Delta_0$ in meters.\n- Report $(R,Z)$ values in meters for each intersection. No other units are permitted in the output.\n\nDesign your implementation for numerical robustness and clarity. The program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is a nested list of intersection points grouped by poloidal cut, and each intersection point is the list $[R,Z]$ with $R$ and $Z$ floats in meters. For example, the overall format must follow $[\\text{case}_1,\\text{case}_2,\\dots]$ where each $\\text{case}_i$ is a nested list.\n\nUse the following test suite. All angles are in radians, and all distances are in meters.\n\nTest Case 1 (general case with non-axisymmetric $(m,n)=(2,1)$):\n- Major radius $R_0 = 3.0\\,\\mathrm{m}$, minor radius $a = 1.0\\,\\mathrm{m}$.\n- Elongation $\\kappa = 1.7$, triangularity $\\delta = 0.35$.\n- Shafranov shift scale $\\Delta_0 = 0.12\\,\\mathrm{m}$.\n- Flux surface minor radius $r(\\psi) = 0.6\\,\\mathrm{m}$.\n- Safety factor $q(\\psi) = 1.7$.\n- Non-axisymmetry amplitudes $\\varepsilon_r = 0.01$, $\\varepsilon_z = 0.005$, integers $m = 2$, $n = 1$.\n- Initial angles $\\theta_0 = 0.4$, $\\phi_0 = 0.0$.\n- Poloidal cuts $\\theta_{\\mathrm{cut}} \\in \\{0.0, \\pi/2, \\pi\\}$.\n- Number of intersections per cut $N = 5$.\n\nTest Case 2 (boundary case with rational safety factor):\n- Major radius $R_0 = 3.0\\,\\mathrm{m}$, minor radius $a = 1.0\\,\\mathrm{m}$.\n- Elongation $\\kappa = 1.6$, triangularity $\\delta = 0.25$.\n- Shafranov shift scale $\\Delta_0 = 0.10\\,\\mathrm{m}$.\n- Flux surface minor radius $r(\\psi) = 0.4\\,\\mathrm{m}$.\n- Safety factor $q(\\psi) = 2.0$.\n- Non-axisymmetry amplitudes $\\varepsilon_r = 0.008$, $\\varepsilon_z = 0.004$, integers $m = 2$, $n = 1$.\n- Initial angles $\\theta_0 = 0.1$, $\\phi_0 = 1.0$.\n- Poloidal cuts $\\theta_{\\mathrm{cut}} \\in \\{\\pi/4\\}$.\n- Number of intersections per cut $N = 8$.\n\nTest Case 3 (edge case with high elongation and $(m,n)=(3,2)$):\n- Major radius $R_0 = 3.0\\,\\mathrm{m}$, minor radius $a = 1.0\\,\\mathrm{m}$.\n- Elongation $\\kappa = 2.0$, triangularity $\\delta = 0.20$.\n- Shafranov shift scale $\\Delta_0 = 0.20\\,\\mathrm{m}$.\n- Flux surface minor radius $r(\\psi) = 0.95\\,\\mathrm{m}$.\n- Safety factor $q(\\psi) = \\sqrt{2}$.\n- Non-axisymmetry amplitudes $\\varepsilon_r = 0.02$, $\\varepsilon_z = 0.01$, integers $m = 3$, $n = 2$.\n- Initial angles $\\theta_0 = 2.2$, $\\phi_0 = 0.5$.\n- Poloidal cuts $\\theta_{\\mathrm{cut}} \\in \\{0.0, 2.0\\}$.\n- Number of intersections per cut $N = 6$.\n\nYour program must compute and return, for each test case and each specified poloidal cut, the list of $N$ successive intersection points as $[R,Z]$ pairs. The final output must be a single line containing a comma-separated list enclosed in square brackets, aggregating the three test case results as nested lists in the order Test Case $1$, Test Case $2$, Test Case $3$.",
            "solution": "The task is to trace a magnetic field line in a perturbed tokamak equilibrium and compute the coordinates of its intersections with specified poloidal planes. This generates what is known as a Poincaré plot, a standard tool for visualizing the structure of magnetic fields in fusion devices.\n\nThe core of the problem lies in understanding the properties of straight-field-line coordinates $(\\psi, \\theta, \\phi)$. By construction, in these coordinates, magnetic field lines become straight lines on the $(\\theta, \\phi)$ plane. The constant of proportionality between the toroidal angle $\\phi$ and the poloidal angle $\\theta$ along a field line is the safety factor, $q$. The differential equation for a field line is thus:\n$$\n\\frac{d\\phi}{d\\theta} = q(\\psi).\n$$\nSince the problem states that a field line remains on a single flux surface, $\\psi$ is constant, and therefore $q(\\psi)$ is also constant along the trajectory. We can integrate this simple ordinary differential equation from an initial point $(\\theta_0, \\phi_0)$ to find the toroidal angle $\\phi$ at any other poloidal angle $\\theta$:\n$$\n\\int_{\\phi_0}^{\\phi} d\\phi' = \\int_{\\theta_0}^{\\theta} q(\\psi) d\\theta' \\implies \\phi - \\phi_0 = q(\\psi)(\\theta - \\theta_0).\n$$\nThis gives the field line trajectory in the $(\\theta, \\phi)$ plane:\n$$\n\\phi(\\theta) = \\phi_0 + q(\\psi)(\\theta - \\theta_0).\n$$\nA poloidal cut is a surface of constant poloidal angle, $\\theta = \\theta_{\\mathrm{cut}}$. Since $\\theta$ is a periodic coordinate with period $2\\pi$, a field line will repeatedly intersect this plane at poloidal angles given by $\\theta_{\\mathrm{cut}} + 2\\pi k$ for any integer $k$. The problem asks for $N$ successive intersections. Assuming the field line is followed in the direction of increasing $\\theta$, we first need to find the first intersection that occurs at or after the starting angle $\\theta_0$.\nLet the sequence of intersection poloidal angles be $\\theta_j^{\\mathrm{int}}$. For a given $\\theta_{\\mathrm{cut}}$, the first such angle at or after $\\theta_0$ is $\\theta_{\\mathrm{cut}} + 2\\pi k_0$, where $k_0$ is the smallest integer satisfying $\\theta_{\\mathrm{cut}} + 2\\pi k_0 \\ge \\theta_0$. This can be expressed as:\n$$\nk_0 = \\left\\lceil \\frac{\\theta_0 - \\theta_{\\mathrm{cut}}}{2\\pi} \\right\\rceil.\n$$\nThe subsequent $N$ intersection poloidal angles are then given by:\n$$\n\\theta_j^{\\mathrm{int}} = \\theta_{\\mathrm{cut}} + 2\\pi (k_0 + j), \\quad \\text{for } j = 0, 1, \\dots, N-1.\n$$\nFor each $\\theta_j^{\\mathrm{int}}$, we can calculate the corresponding toroidal angle $\\phi_j^{\\mathrm{int}}$ using the field line equation:\n$$\n\\phi_j^{\\mathrm{int}} = \\phi_0 + q(\\psi)(\\theta_j^{\\mathrm{int}} - \\theta_0).\n$$\nOnce we have the coordinates $(\\psi, \\theta_j^{\\mathrm{int}}, \\phi_j^{\\mathrm{int}})$ for each of the $N$ intersection points, we transform them to cylindrical coordinates $(R_j, Z_j)$ using the provided geometrical mapping. First, the Shafranov shift $\\Delta(\\psi)$ is calculated based on the minor radius of the flux surface, $r(\\psi)$, and the minor radius at the plasma edge, $a$:\n$$\n\\Delta(\\psi) = \\Delta_0 \\left( \\frac{r(\\psi)}{a} \\right)^2.\n$$\nThen, the cylindrical coordinates $(R_j, Z_j)$ for the $j$-th intersection point are computed as:\n$$\nR_j = R_0 + \\Delta(\\psi) + r(\\psi)\\,\\cos\\!\\big(\\theta_j^{\\mathrm{int}} + \\delta \\sin\\theta_j^{\\mathrm{int}}\\big) + \\varepsilon_r\\,r(\\psi)\\,\\cos\\!\\big(m\\,\\theta_j^{\\mathrm{int}} - n\\,\\phi_j^{\\mathrm{int}}\\big)\n$$\n$$\nZ_j = \\kappa\\,r(\\psi)\\,\\sin\\theta_j^{\\mathrm{int}} + \\varepsilon_z\\,r(\\psi)\\,\\sin\\!\\big(m\\,\\theta_j^{\\mathrm{int}} - n\\,\\phi_j^{\\mathrm{int}}\\big)\n$$\nThis procedure is repeated for each specified poloidal cut $\\theta_{\\mathrm{cut}}$ and for each test case. The algorithm is deterministic and numerically stable, as it only involves direct evaluation of trigonometric and algebraic functions. All quantities are provided and well-defined.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef format_list_recursively(item):\n    \"\"\"\n    Recursively formats a nested list structure into a string without spaces.\n    This is to ensure the output format is strictly a comma-separated list\n    as is common in computational problem settings.\n    \"\"\"\n    if isinstance(item, list):\n        return f\"[{','.join(format_list_recursively(x) for x in item)}]\"\n    else:\n        # Format floats to a reasonable precision, can be adjusted if needed.\n        if isinstance(item, float):\n            return f\"{item:.15g}\" # Use general format to avoid trailing zeros\n        return str(item)\n\ndef compute_intersections_for_case(params):\n    \"\"\"\n    Computes Poincaré section points for a single test case.\n    \"\"\"\n    R0, a, kappa, delta, Delta0, r_psi, q_psi, eps_r, eps_z, m, n, theta0, phi0, theta_cuts, N = params\n    \n    # Calculate Shafranov shift, which is constant for the given flux surface\n    shafranov_shift = Delta0 * (r_psi / a)**2\n    \n    case_results = []\n    \n    for theta_cut in theta_cuts:\n        cut_points = []\n        \n        # Determine the starting integer k0 for the poloidal turns.\n        # k0 is the smallest integer such that theta_cut + 2*pi*k0 >= theta0\n        k0 = np.ceil((theta0 - theta_cut) / (2 * np.pi))\n        \n        for j in range(N):\n            # Calculate the poloidal angle of the intersection\n            theta_int = theta_cut + 2 * np.pi * (k0 + j)\n            \n            # Calculate the corresponding toroidal angle\n            phi_int = phi0 + q_psi * (theta_int - theta0)\n            \n            # Calculate R and Z coordinates using the provided geometry\n            # Axisymmetric part\n            R_axisym = R0 + shafranov_shift + r_psi * np.cos(theta_int + delta * np.sin(theta_int))\n            Z_axisym = kappa * r_psi * np.sin(theta_int)\n            \n            # Non-axisymmetric perturbation\n            arg_pert = m * theta_int - n * phi_int\n            R_pert = eps_r * r_psi * np.cos(arg_pert)\n            Z_pert = eps_z * r_psi * np.sin(arg_pert)\n            \n            R = R_axisym + R_pert\n            Z = Z_axisym + Z_pert\n            \n            cut_points.append([R, Z])\n            \n        case_results.append(cut_points)\n        \n    return case_results\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1\n        (3.0, 1.0, 1.7, 0.35, 0.12, 0.6, 1.7, 0.01, 0.005, 2, 1, 0.4, 0.0, [0.0, np.pi/2, np.pi], 5),\n        # Test Case 2\n        (3.0, 1.0, 1.6, 0.25, 0.10, 0.4, 2.0, 0.008, 0.004, 2, 1, 0.1, 1.0, [np.pi/4], 8),\n        # Test Case 3\n        (3.0, 1.0, 2.0, 0.20, 0.20, 0.95, np.sqrt(2), 0.02, 0.01, 3, 2, 2.2, 0.5, [0.0, 2.0], 6),\n    ]\n\n    all_results = []\n    for case_params in test_cases:\n        result_for_case = compute_intersections_for_case(case_params)\n        all_results.append(result_for_case)\n\n    # Final print statement in the exact required format (no spaces).\n    print(format_list_recursively(all_results))\n\nsolve()\n```"
        }
    ]
}