{
    "hands_on_practices": [
        {
            "introduction": "The first step in analyzing physical phenomena in a toroidal device is to establish a suitable coordinate system. This practice grounds your understanding by guiding you through the derivation of the metric tensor and the Jacobian for a simplified, circular toroidal geometry. By starting from the familiar Euclidean line element, you will see how the geometry is encoded in the metric tensor components, providing the essential tool for measuring lengths, areas, and volumes within the curved coordinate system .",
            "id": "4056484",
            "problem": "Consider an axisymmetric toroidal plasma in the circular concentric flux-surface approximation used in computational fusion science and engineering. Let the major radius be a constant $R_{0} > 0$, and adopt the flux coordinates $(r,\\theta,\\phi)$ defined by the geometric mapping into cylindrical coordinates $(R,\\phi,Z)$ via $R(r,\\theta) = R_{0} + r \\cos\\theta$ and $Z(r,\\theta) = r \\sin\\theta$, with the toroidal angle $\\phi$ preserved. Assume three-dimensional Euclidean space with the standard Euclidean metric and define the covariant metric tensor $g_{ij}$ induced by this mapping through the covariant basis vectors obtained from the coordinate transformation. Angles $\\theta$ and $\\phi$ are measured in radians.\n\nStarting from the fundamental definition of a metric induced by a smooth coordinate mapping in Euclidean space and the Euclidean line element expressed in cylindrical coordinates, derive the covariant metric tensor $g_{ij}(r,\\theta,\\phi)$ in the $(r,\\theta,\\phi)$ coordinates, compute its determinant $g = \\det(g_{ij})$, and use it to obtain the Jacobian factor $\\sqrt{g}$ of the transformation from Cartesian coordinates to $(r,\\theta,\\phi)$. Provide your final answer as a single closed-form analytic expression for $\\sqrt{g}$ in terms of $r$, $\\theta$, and $R_{0}$. No numerical approximation is required, and no units should be included in the final expression.",
            "solution": "The problem requires the derivation of the Jacobian factor $\\sqrt{g}$ for a specific toroidal coordinate system $(r, \\theta, \\phi)$ used in fusion science. The derivation must proceed from the fundamental definition of the metric tensor $g_{ij}$ induced by the coordinate transformation from Euclidean space.\n\nThe starting point is the infinitesimal line element $ds^2$ in three-dimensional Euclidean space. It is convenient to express this line element in cylindrical coordinates $(R, \\phi, Z)$, where it takes the well-known form:\n$$\nds^2 = dR^2 + R^2 d\\phi^2 + dZ^2\n$$\nThis expression represents the metric of the embedding Euclidean space, described in a coordinate system adapted to the toroidal symmetry.\n\nThe problem provides the transformation from the toroidal coordinates $(r, \\theta, \\phi)$ to the cylindrical coordinates $(R, \\phi, Z)$ as:\n$$\n\\begin{cases}\nR(r, \\theta) = R_0 + r \\cos\\theta \\\\\nZ(r, \\theta) = r \\sin\\theta \\\\\n\\phi = \\phi\n\\end{cases}\n$$\nwhere $R_0$ is the constant major radius.\n\nTo express the line element $ds^2$ in terms of the toroidal coordinates, we must find the differentials $dR$ and $dZ$ in terms of $dr$ and $d\\theta$. Using the chain rule for differentiation, we have:\n$$\ndR = \\frac{\\partial R}{\\partial r} dr + \\frac{\\partial R}{\\partial \\theta} d\\theta\n$$\n$$\ndZ = \\frac{\\partial Z}{\\partial r} dr + \\frac{\\partial Z}{\\partial \\theta} d\\theta\n$$\nWe compute the necessary partial derivatives from the transformation equations:\n$$\n\\frac{\\partial R}{\\partial r} = \\cos\\theta\n$$\n$$\n\\frac{\\partial R}{\\partial \\theta} = -r \\sin\\theta\n$$\n$$\n\\frac{\\partial Z}{\\partial r} = \\sin\\theta\n$$\n$$\n\\frac{\\partial Z}{\\partial \\theta} = r \\cos\\theta\n$$\nSubstituting these into the differential expressions yields:\n$$\ndR = \\cos\\theta \\, dr - r \\sin\\theta \\, d\\theta\n$$\n$$\ndZ = \\sin\\theta \\, dr + r \\cos\\theta \\, d\\theta\n$$\nThe differential $d\\phi$ remains unchanged. Now, we substitute these expressions for $dR$ and $dZ$, along with the expression for $R$, into the cylindrical line element $ds^2$:\n$$\nds^2 = (\\cos\\theta \\, dr - r \\sin\\theta \\, d\\theta)^2 + (R_0 + r \\cos\\theta)^2 d\\phi^2 + (\\sin\\theta \\, dr + r \\cos\\theta \\, d\\theta)^2\n$$\nLet's expand the squared terms involving $dr$ and $d\\theta$:\n$$\n(\\cos\\theta \\, dr - r \\sin\\theta \\, d\\theta)^2 = \\cos^2\\theta \\, dr^2 - 2r \\sin\\theta \\cos\\theta \\, dr d\\theta + r^2 \\sin^2\\theta \\, d\\theta^2\n$$\n$$\n(\\sin\\theta \\, dr + r \\cos\\theta \\, d\\theta)^2 = \\sin^2\\theta \\, dr^2 + 2r \\sin\\theta \\cos\\theta \\, dr d\\theta + r^2 \\cos^2\\theta \\, d\\theta^2\n$$\nSumming these two results gives the poloidal part of the line element, $dR^2 + dZ^2$:\n$$\ndR^2 + dZ^2 = (\\cos^2\\theta + \\sin^2\\theta) dr^2 + (-2r \\sin\\theta \\cos\\theta + 2r \\sin\\theta \\cos\\theta) dr d\\theta + (r^2 \\sin^2\\theta + r^2 \\cos^2\\theta) d\\theta^2\n$$\nUsing the trigonometric identity $\\sin^2\\theta + \\cos^2\\theta = 1$, this simplifies to:\n$$\ndR^2 + dZ^2 = dr^2 + r^2 d\\theta^2\n$$\nSubstituting this simplified expression back into the total line element $ds^2$, we obtain:\n$$\nds^2 = dr^2 + r^2 d\\theta^2 + (R_0 + r \\cos\\theta)^2 d\\phi^2\n$$\nThe general form of the line element in an arbitrary coordinate system $(x^1, x^2, x^3)$ is given by $ds^2 = \\sum_{i,j} g_{ij} dx^i dx^j$. By identifying our coordinates as $(x^1, x^2, x^3) = (r, \\theta, \\phi)$, we can directly read the components of the covariant metric tensor $g_{ij}$ from the coefficients of the differential terms $dr^2$, $d\\theta^2$, and $d\\phi^2$.\n$$\ng_{rr} = 1\n$$\n$$\ng_{\\theta\\theta} = r^2\n$$\n$$\ng_{\\phi\\phi} = (R_0 + r \\cos\\theta)^2\n$$\nSince there are no cross-terms (e.g., $dr d\\theta$), all off-diagonal components are zero: $g_{ij} = 0$ for $i \\neq j$. The metric tensor in matrix form is therefore:\n$$\ng_{ij} = \\begin{pmatrix}\n1 & 0 & 0 \\\\\n0 & r^2 & 0 \\\\\n0 & 0 & (R_0 + r \\cos\\theta)^2\n\\end{pmatrix}\n$$\nThe next step is to compute the determinant of the metric tensor, denoted by $g$. For a diagonal matrix, the determinant is the product of its diagonal elements:\n$$\ng = \\det(g_{ij}) = g_{rr} g_{\\theta\\theta} g_{\\phi\\phi} = (1)(r^2)((R_0 + r \\cos\\theta)^2)\n$$\n$$\ng = r^2 (R_0 + r \\cos\\theta)^2\n$$\nThe Jacobian factor of the transformation from Cartesian coordinates to the $(r, \\theta, \\phi)$ coordinates is given by $\\sqrt{g}$. Taking the square root of the determinant, we find:\n$$\n\\sqrt{g} = \\sqrt{r^2 (R_0 + r \\cos\\theta)^2} = |r| |R_0 + r \\cos\\theta|\n$$\nIn the context of toroidal geometry, the coordinate $r$ represents a minor radius and is, by definition, non-negative, so $|r| = r$. The quantity $R = R_0 + r \\cos\\theta$ represents the major radial position in cylindrical coordinates, which for any physical point in space must be non-negative. In typical fusion applications, the domain of interest is $r < R_0$, which guarantees $R > 0$. Therefore, we can drop the absolute value signs.\n$$\n\\sqrt{g} = r (R_0 + r \\cos\\theta)\n$$\nThis expression is the Jacobian factor, which relates the volume element in Cartesian coordinates $dV = dx \\, dy \\, dz$ to the volume element in these toroidal coordinates $dV = \\sqrt{g} \\, dr \\, d\\theta \\, d\\phi$.",
            "answer": "$$\n\\boxed{r(R_{0} + r \\cos \\theta)}\n$$"
        },
        {
            "introduction": "Once the metric tensor is known, the next step is to understand how vectors and tensors change from point to point in our curved coordinate system. This is described by the Christoffel symbols, which quantify the effects of the coordinate system's curvature. This exercise  provides direct, hands-on practice in calculating these essential symbols from the metric tensor you explored previously, building the machinery needed for writing physical laws like the geodesic equation or fluid momentum equations in toroidal coordinates.",
            "id": "4056521",
            "problem": "In an axisymmetric tokamak with circular, concentric magnetic flux surfaces, introduce flux coordinates $(r,\\theta,\\phi)$ defined by the smooth mapping to cylindrical coordinates $(R,\\phi,Z)$,\n$$\nR(r,\\theta) = R_{0} + r \\cos\\theta,\\quad Z(r,\\theta) = r \\sin\\theta,\\quad \\phi = \\phi,\n$$\nwhere $R_{0} > 0$ is the major radius of the magnetic axis, $r \\ge 0$ is the minor radius labeling flux surfaces, $\\theta \\in [0,2\\pi)$ is the poloidal angle, and $\\phi \\in [0,2\\pi)$ is the toroidal angle. The ambient three-dimensional space is Euclidean, with line element in cylindrical coordinates given by\n$$\n\\mathrm{d}l^{2} = \\mathrm{d}R^{2} + R^{2}\\,\\mathrm{d}\\phi^{2} + \\mathrm{d}Z^{2}.\n$$\nTreat $(r,\\theta,\\phi)$ as a curvilinear coordinate system on the embedded toroidal surface family. Using first principles of differential geometry in Euclidean space, compute the covariant metric components $g_{ij}$ induced by the above embedding such that\n$$\n\\mathrm{d}l^{2} = g_{ij}\\,\\mathrm{d}x^{i}\\mathrm{d}x^{j},\\quad x^{1}=r,\\;x^{2}=\\theta,\\;x^{3}=\\phi,\n$$\nand obtain the corresponding inverse metric $g^{ij}$. Then, using the definition of Christoffel symbols of the Levi-Civita connection,\n$$\n\\Gamma^{k}_{\\;ij} = \\frac{1}{2} g^{kl}\\left(\\partial_{i} g_{jl} + \\partial_{j} g_{il} - \\partial_{l} g_{ij}\\right),\n$$\nderive all nonzero Christoffel symbols $\\Gamma^{k}_{\\;ij}$ for this circular concentric tokamak metric. Express the final answer by listing only the nonzero Christoffel symbols in the following fixed order as a single row vector:\n$$\n\\left(\\Gamma^{r}_{\\;\\theta\\theta},\\;\\Gamma^{r}_{\\;\\phi\\phi},\\;\\Gamma^{\\theta}_{\\;r\\theta},\\;\\Gamma^{\\theta}_{\\;\\theta r},\\;\\Gamma^{\\theta}_{\\;\\phi\\phi},\\;\\Gamma^{\\phi}_{\\;r\\phi},\\;\\Gamma^{\\phi}_{\\;\\phi r},\\;\\Gamma^{\\phi}_{\\;\\theta\\phi},\\;\\Gamma^{\\phi}_{\\;\\phi\\theta}\\right).\n$$\nNo numerical evaluation is required; provide a closed-form analytical expression in terms of $r$, $\\theta$, $R_{0}$, and $R(r,\\theta)$. If you introduce any intermediate quantities, clearly define them. The final answer must be the single row vector above and contain no units.",
            "solution": "The ambient space is Euclidean, so the induced metric in any curvilinear coordinates follows from the pullback of the Euclidean line element. Starting from the cylindrical-coordinate line element,\n$$\n\\mathrm{d}l^{2} = \\mathrm{d}R^{2} + R^{2}\\,\\mathrm{d}\\phi^{2} + \\mathrm{d}Z^{2},\n$$\nwe express $\\mathrm{d}R$ and $\\mathrm{d}Z$ in terms of $(r,\\theta,\\phi)$ using\n$$\nR(r,\\theta) = R_{0} + r \\cos\\theta,\\quad Z(r,\\theta) = r \\sin\\theta.\n$$\nTheir differentials are\n$$\n\\mathrm{d}R = \\frac{\\partial R}{\\partial r}\\,\\mathrm{d}r + \\frac{\\partial R}{\\partial \\theta}\\,\\mathrm{d}\\theta = \\cos\\theta\\,\\mathrm{d}r - r \\sin\\theta\\,\\mathrm{d}\\theta,\n$$\n$$\n\\mathrm{d}Z = \\frac{\\partial Z}{\\partial r}\\,\\mathrm{d}r + \\frac{\\partial Z}{\\partial \\theta}\\,\\mathrm{d}\\theta = \\sin\\theta\\,\\mathrm{d}r + r \\cos\\theta\\,\\mathrm{d}\\theta.\n$$\nCompute $\\mathrm{d}R^{2} + \\mathrm{d}Z^{2}$:\n\\begin{align*}\n\\mathrm{d}R^{2} + \\mathrm{d}Z^{2} &= \\left(\\cos\\theta\\,\\mathrm{d}r - r \\sin\\theta\\,\\mathrm{d}\\theta\\right)^{2} + \\left(\\sin\\theta\\,\\mathrm{d}r + r \\cos\\theta\\,\\mathrm{d}\\theta\\right)^{2} \\\\\n&= \\left(\\cos^{2}\\theta + \\sin^{2}\\theta\\right)\\mathrm{d}r^{2} + r^{2}\\left(\\sin^{2}\\theta + \\cos^{2}\\theta\\right)\\mathrm{d}\\theta^{2} + 2\\left(\\cos\\theta(-r\\sin\\theta) + \\sin\\theta(r\\cos\\theta)\\right)\\mathrm{d}r\\,\\mathrm{d}\\theta \\\\\n&= \\mathrm{d}r^{2} + r^{2}\\,\\mathrm{d}\\theta^{2}.\n\\end{align*}\nTherefore, the line element becomes\n$$\n\\mathrm{d}l^{2} = \\mathrm{d}r^{2} + r^{2}\\,\\mathrm{d}\\theta^{2} + R^{2}(r,\\theta)\\,\\mathrm{d}\\phi^{2}.\n$$\nFrom this diagonal form, the covariant metric components in $(r,\\theta,\\phi)$ are\n$$\ng_{rr} = 1,\\quad g_{\\theta\\theta} = r^{2},\\quad g_{\\phi\\phi} = R^{2}(r,\\theta),\\quad g_{r\\theta}=g_{r\\phi}=g_{\\theta\\phi}=0.\n$$\nThe inverse metric (contravariant components) is the matrix inverse of the diagonal $g_{ij}$, hence\n$$\ng^{rr} = 1,\\quad g^{\\theta\\theta} = \\frac{1}{r^{2}},\\quad g^{\\phi\\phi} = \\frac{1}{R^{2}(r,\\theta)},\n$$\nwith other components zero.\n\nNext, compute the needed coordinate derivatives of the nonconstant metric components. We note\n$$\nR(r,\\theta) = R_{0} + r \\cos\\theta,\\quad \\frac{\\partial R}{\\partial r} = \\cos\\theta,\\quad \\frac{\\partial R}{\\partial \\theta} = - r \\sin\\theta,\n$$\nso\n\\begin{align*}\n\\partial_{r} g_{\\theta\\theta} &= \\partial_{r} (r^{2}) = 2r, & \\partial_{\\theta} g_{\\theta\\theta} &= 0, & \\partial_{\\phi} g_{\\theta\\theta} &= 0, \\\\\n\\partial_{r} g_{\\phi\\phi} &= \\partial_{r} \\left(R^{2}\\right) = 2 R \\,\\partial_{r} R = 2 R \\cos\\theta, \\\\\n\\partial_{\\theta} g_{\\phi\\phi} &= \\partial_{\\theta} \\left(R^{2}\\right) = 2 R \\,\\partial_{\\theta} R = 2 R (- r \\sin\\theta) = - 2 r R \\sin\\theta, \\\\\n\\partial_{\\phi} g_{\\phi\\phi} &= 0,\n\\end{align*}\nand all derivatives of $g_{rr}$ vanish because $g_{rr}=1$ is constant.\n\nWe now apply the Levi-Civita Christoffel definition\n$$\n\\Gamma^{k}_{\\;ij} = \\frac{1}{2} g^{kl}\\left(\\partial_{i} g_{jl} + \\partial_{j} g_{il} - \\partial_{l} g_{ij}\\right),\n$$\nwith indices ordered as $(x^{1},x^{2},x^{3})=(r,\\theta,\\phi)$, and use the fact that $g_{ij}$ is diagonal. Many terms vanish due to zeros in $g_{ij}$ and their derivatives; we enumerate the nonzero results:\n\n1. For $k=r$, $i=j=\\theta$:\n\\begin{align*}\n\\Gamma^{r}_{\\;\\theta\\theta} &= \\frac{1}{2} g^{rr}\\left(\\partial_{\\theta} g_{\\theta r} + \\partial_{\\theta} g_{r\\theta} - \\partial_{r} g_{\\theta\\theta}\\right) \\\\\n&= \\frac{1}{2} \\cdot 1 \\cdot \\left(0 + 0 - 2r\\right) = - r.\n\\end{align*}\n\n2. For $k=r$, $i=j=\\phi$:\n\\begin{align*}\n\\Gamma^{r}_{\\;\\phi\\phi} &= \\frac{1}{2} g^{rr}\\left(\\partial_{\\phi} g_{\\phi r} + \\partial_{\\phi} g_{r\\phi} - \\partial_{r} g_{\\phi\\phi}\\right) \\\\\n&= \\frac{1}{2} \\cdot 1 \\cdot \\left(0 + 0 - 2 R \\cos\\theta\\right) = - R \\cos\\theta.\n\\end{align*}\n\n3. For $k=\\theta$, $i=r$, $j=\\theta$ (and by symmetry $i \\leftrightarrow j$):\n\\begin{align*}\n\\Gamma^{\\theta}_{\\;r\\theta} &= \\frac{1}{2} g^{\\theta\\theta}\\left(\\partial_{r} g_{\\theta\\theta} + \\partial_{\\theta} g_{r\\theta} - \\partial_{\\theta} g_{r\\theta}\\right) \\\\\n&= \\frac{1}{2} \\cdot \\frac{1}{r^{2}} \\cdot (2r) = \\frac{1}{r}, \\\\\n\\Gamma^{\\theta}_{\\;\\theta r} &= \\Gamma^{\\theta}_{\\;r\\theta} = \\frac{1}{r}.\n\\end{align*}\n\n4. For $k=\\theta$, $i=j=\\phi$:\n\\begin{align*}\n\\Gamma^{\\theta}_{\\;\\phi\\phi} &= \\frac{1}{2} g^{\\theta\\theta}\\left(\\partial_{\\phi} g_{\\phi\\theta} + \\partial_{\\phi} g_{\\theta\\phi} - \\partial_{\\theta} g_{\\phi\\phi}\\right) \\\\\n&= \\frac{1}{2} \\cdot \\frac{1}{r^{2}} \\cdot \\left(0 + 0 - (-2 r R \\sin\\theta)\\right) \\\\\n&= \\frac{1}{2} \\cdot \\frac{1}{r^{2}} \\cdot (2 r R \\sin\\theta) = \\frac{R \\sin\\theta}{r}.\n\\end{align*}\n\n5. For $k=\\phi$, $i=r$, $j=\\phi$ (and by symmetry $i \\leftrightarrow j$):\n\\begin{align*}\n\\Gamma^{\\phi}_{\\;r\\phi} &= \\frac{1}{2} g^{\\phi\\phi}\\left(\\partial_{r} g_{\\phi\\phi} + \\partial_{\\phi} g_{r\\phi} - \\partial_{\\phi} g_{r\\phi}\\right) \\\\\n&= \\frac{1}{2} \\cdot \\frac{1}{R^{2}} \\cdot (2 R \\cos\\theta) = \\frac{\\cos\\theta}{R}, \\\\\n\\Gamma^{\\phi}_{\\;\\phi r} &= \\Gamma^{\\phi}_{\\;r\\phi} = \\frac{\\cos\\theta}{R}.\n\\end{align*}\n\n6. For $k=\\phi$, $i=\\theta$, $j=\\phi$ (and by symmetry $i \\leftrightarrow j$):\n\\begin{align*}\n\\Gamma^{\\phi}_{\\;\\theta\\phi} &= \\frac{1}{2} g^{\\phi\\phi}\\left(\\partial_{\\theta} g_{\\phi\\phi} + \\partial_{\\phi} g_{\\theta\\phi} - \\partial_{\\phi} g_{\\theta\\phi}\\right) \\\\\n&= \\frac{1}{2} \\cdot \\frac{1}{R^{2}} \\cdot (- 2 r R \\sin\\theta) = - \\frac{r \\sin\\theta}{R}, \\\\\n\\Gamma^{\\phi}_{\\;\\phi\\theta} &= \\Gamma^{\\phi}_{\\;\\theta\\phi} = - \\frac{r \\sin\\theta}{R}.\n\\end{align*}\n\nAll other Christoffel symbols vanish because the metric is diagonal and its nonconstant components depend only on $r$ and $\\theta$ as given above, with no $\\phi$ dependence and no cross terms in $g_{ij}$.\n\nCollecting the nonzero symbols in the specified order,\n$$\n\\left(\\Gamma^{r}_{\\;\\theta\\theta},\\;\\Gamma^{r}_{\\;\\phi\\phi},\\;\\Gamma^{\\theta}_{\\;r\\theta},\\;\\Gamma^{\\theta}_{\\;\\theta r},\\;\\Gamma^{\\theta}_{\\;\\phi\\phi},\\;\\Gamma^{\\phi}_{\\;r\\phi},\\;\\Gamma^{\\phi}_{\\;\\phi r},\\;\\Gamma^{\\phi}_{\\;\\theta\\phi},\\;\\Gamma^{\\phi}_{\\;\\phi\\theta}\\right)\n=\n\\left(- r,\\; - R \\cos\\theta,\\; \\frac{1}{r},\\; \\frac{1}{r},\\; \\frac{R \\sin\\theta}{r},\\; \\frac{\\cos\\theta}{R},\\; \\frac{\\cos\\theta}{R},\\; - \\frac{r \\sin\\theta}{R},\\; - \\frac{r \\sin\\theta}{R}\\right),\n$$\nwhere $R = R_{0} + r \\cos\\theta$.",
            "answer": "$$\\boxed{\\begin{pmatrix}-r & -R\\cos\\theta & \\frac{1}{r} & \\frac{1}{r} & \\frac{R\\sin\\theta}{r} & \\frac{\\cos\\theta}{R} & \\frac{\\cos\\theta}{R} & -\\frac{r\\sin\\theta}{R} & -\\frac{r\\sin\\theta}{R}\\end{pmatrix}}$$"
        },
        {
            "introduction": "Ultimately, the goal of defining coordinates and metrics is to solve physical equations. This practice bridges the gap between continuous theory and computational implementation, focusing on the ubiquitous Laplace-Beltrami operator which governs diffusion and wave phenomena. You will use the metric tensor components to construct a discrete version of this operator on a toroidal surface, a task that requires careful attention to preserving fundamental properties like self-adjointness in the numerical scheme . This exercise exemplifies the core work of a computational physicist: translating physical laws into robust and accurate algorithms.",
            "id": "4056482",
            "problem": "You are asked to derive and implement a discrete form of the Laplace-Beltrami operator on a two-dimensional flux surface embedded in three-dimensional Euclidean space, and to verify its self-adjointness with respect to the metric-weighted inner product. The flux surface is a circular torus parameterized by the poloidal angle $\\,\\theta\\,$ and toroidal angle $\\,\\phi\\,$, both in radians, with major radius $\\,R_0 > 0\\,$ and minor radius $\\,a > 0\\,$ such that $\\,a < R_0\\,$. The surface is given by the map from angles to Cartesian coordinates,\n$$\n\\mathbf{r}(\\theta,\\phi) = \\big( (R_0 + a \\cos\\theta)\\cos\\phi,\\; (R_0 + a \\cos\\theta)\\sin\\phi,\\; a\\sin\\theta \\big).\n$$\nStarting from the coordinate-invariant definition of the Laplace-Beltrami operator in terms of the metric tensor and the associated volume form, and from the induced metric on the embedded surface obtained via pullback of the Euclidean metric, derive a discretization on a uniform angular grid in $\\,\\theta\\,$ and $\\,\\phi\\,$ that:\n- Is expressed in divergence form using midpoint (edge) coefficients built from the metric quantities.\n- Enforces periodic boundary conditions in $\\,\\theta\\,$ and $\\,\\phi\\,$ (angles are in radians).\n- Is self-adjoint with respect to the discrete metric-weighted inner product\n$$\n\\langle u, v \\rangle = \\sum_{i=0}^{N_\\theta-1}\\sum_{j=0}^{N_\\phi-1} \\sqrt{g(\\theta_i,\\phi_j)}\\,\\Delta\\theta\\,\\Delta\\phi\\; u_{i,j}\\,v_{i,j},\n$$\nwhere $\\,\\Delta\\theta = \\frac{2\\pi}{N_\\theta}\\,$, $\\,\\Delta\\phi = \\frac{2\\pi}{N_\\phi}\\,$, $\\,\\theta_i = i \\Delta\\theta\\,$, $\\,\\phi_j = j \\Delta\\phi\\,$, and $\\,\\sqrt{g}\\,$ is the square root of the determinant of the metric tensor on the surface. Self-adjointness in the discrete sense means the stiffness matrix $\\,A\\,$ of the discrete operator satisfies $\\,W A = (W A)^\\top\\,$, where $\\,W\\,$ is the diagonal matrix of the weights $\\,\\sqrt{g(\\theta_i,\\phi_j)}\\,\\Delta\\theta\\,\\Delta\\phi\\,$.\n\nImplement your derivation by constructing the sparse matrix $\\,A\\,$ on a uniform $\\,N_\\theta \\times N_\\phi\\,$ grid using the divergence-form stencil with shared edge coefficients\n$$\n\\text{edge coefficient along } \\theta: \\quad c_\\theta = \\sqrt{g}\\,g^{\\theta\\theta},\\qquad\n\\text{edge coefficient along } \\phi: \\quad c_\\phi = \\sqrt{g}\\,g^{\\phi\\phi},\n$$\nand midpoint (edge) averaging for $\\,c_\\theta\\,$ along $\\,\\theta\\,$ and appropriate treatment for $\\,c_\\phi\\,$ along $\\,\\phi\\,$ given its dependence on $\\,\\theta\\,$ only. Then verify numerically, for each test case, that $\\,W A\\,$ is symmetric by checking that the maximum absolute difference of $\\,W A - (W A)^\\top\\,$ is less than or equal to a specified tolerance.\n\nAngles must be in radians.\n\nUse the following test suite, where each tuple is $\\,(\\,R_0,\\,a,\\,N_\\theta,\\,N_\\phi,\\,\\text{tolerance}\\,)\\,$:\n- Case $\\,1\\,$ (happy path): $\\,(\\,3.0,\\,1.0,\\,32,\\,64,\\,10^{-12}\\,)\\,$.\n- Case $\\,2\\,$ (coarse boundary case): $\\,(\\,3.0,\\,1.0,\\,4,\\,4,\\,10^{-12}\\,)\\,$.\n- Case $\\,3\\,$ (near-unity aspect ratio): $\\,(\\,1.2,\\,1.0,\\,16,\\,24,\\,10^{-12}\\,)\\,$.\n- Case $\\,4\\,$ (higher resolution but still computationally moderate): $\\,(\\,2.5,\\,0.5,\\,64,\\,96,\\,10^{-12}\\,)\\,$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\,\\text{result1},\\text{result2},\\text{result3},\\text{result4}\\,]$), where each result is a boolean indicating whether the symmetry criterion $\\,\\|W A - (W A)^\\top\\|_{\\max} \\le \\text{tolerance}\\,$ holds for the corresponding test case.",
            "solution": "The problem requires the derivation and implementation of a discrete Laplace-Beltrami operator on a toroidal surface and the numerical verification of its self-adjointness. The process involves several steps, starting from the geometric definition of the surface to the construction of a sparse matrix representing the operator.\n\n### 1. Derivation of the Metric Tensor\n\nThe toroidal surface is parameterized by $\\mathbf{r}(\\theta, \\phi)$, where $\\theta \\in [0, 2\\pi)$ is the poloidal angle and $\\phi \\in [0, 2\\pi)$ is the toroidal angle.\n$$ \\mathbf{r}(\\theta,\\phi) = \\big( (R_0 + a \\cos\\theta)\\cos\\phi,\\; (R_0 + a \\cos\\theta)\\sin\\phi,\\; a\\sin\\theta \\big) $$\nThe components of the metric tensor, $g_{ij}$, are induced by the Euclidean metric of the ambient $\\mathbb{R}^3$ space. They are calculated as the inner products of the tangent basis vectors, $\\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{r}}{\\partial \\theta}$ and $\\mathbf{e}_\\phi = \\frac{\\partial \\mathbf{r}}{\\partial \\phi}$.\n\nFirst, we compute the tangent vectors:\n$$ \\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{r}}{\\partial \\theta} = \\begin{pmatrix} -a\\sin\\theta\\cos\\phi \\\\ -a\\sin\\theta\\sin\\phi \\\\ a\\cos\\theta \\end{pmatrix} $$\n$$ \\mathbf{e}_\\phi = \\frac{\\partial \\mathbf{r}}{\\partial \\phi} = \\begin{pmatrix} -(R_0 + a\\cos\\theta)\\sin\\phi \\\\ (R_0 + a\\cos\\theta)\\cos\\phi \\\\ 0 \\end{pmatrix} $$\n\nNext, we calculate the metric tensor components $g_{ij} = \\mathbf{e}_i \\cdot \\mathbf{e}_j$:\n$$ g_{\\theta\\theta} = \\mathbf{e}_\\theta \\cdot \\mathbf{e}_\\theta = (-a\\sin\\theta\\cos\\phi)^2 + (-a\\sin\\theta\\sin\\phi)^2 + (a\\cos\\theta)^2 = a^2\\sin^2\\theta(\\cos^2\\phi + \\sin^2\\phi) + a^2\\cos^2\\theta = a^2 $$\n$$ g_{\\phi\\phi} = \\mathbf{e}_\\phi \\cdot \\mathbf{e}_\\phi = (-(R_0 + a\\cos\\theta)\\sin\\phi)^2 + ((R_0 + a\\cos\\theta)\\cos\\phi)^2 = (R_0 + a\\cos\\theta)^2 $$\n$$ g_{\\theta\\phi} = \\mathbf{e}_\\theta \\cdot \\mathbf{e}_\\phi = a\\sin\\theta\\cos\\phi(R_0 + a\\cos\\theta)\\sin\\phi - a\\sin\\theta\\sin\\phi(R_0 + a\\cos\\theta)\\cos\\phi = 0 $$\n\nThe metric tensor is diagonal, as expected for a surface of revolution with orthogonal parameterization:\n$$ g_{ij} = \\begin{pmatrix} a^2 & 0 \\\\ 0 & (R_0 + a\\cos\\theta)^2 \\end{pmatrix} $$\n\nThe determinant of the metric tensor, $g$, is:\n$$ g = \\det(g_{ij}) = a^2 (R_0 + a\\cos\\theta)^2 $$\nThe volume element on the surface is $\\sqrt{g}\\,d\\theta\\,d\\phi$, where $\\sqrt{g} = a(R_0 + a\\cos\\theta)$. The condition $R_0 > a > 0$ ensures that $\\sqrt{g}$ is always positive.\n\nThe inverse metric tensor, $g^{ij}$, is also diagonal:\n$$ g^{ij} = \\begin{pmatrix} 1/a^2 & 0 \\\\ 0 & 1/(R_0 + a\\cos\\theta)^2 \\end{pmatrix} $$\nThus, $g^{\\theta\\theta} = 1/a^2$ and $g^{\\phi\\phi} = 1/(R_0 + a\\cos\\theta)^2$.\n\n### 2. The Laplace-Beltrami Operator in Divergence Form\n\nFor a scalar function $f(\\theta, \\phi)$, the Laplace-Beltrami operator, $\\Delta_{LB}$, is defined in coordinates as:\n$$ \\Delta_{LB} f = \\frac{1}{\\sqrt{g}} \\sum_{i,j} \\frac{\\partial}{\\partial u^i} \\left( \\sqrt{g} g^{ij} \\frac{\\partial f}{\\partial u^j} \\right) $$\nSubstituting our coordinates and metric components, and using the fact that the metric is diagonal, we obtain the divergence form:\n$$ \\Delta_{LB} f = \\frac{1}{\\sqrt{g}} \\left[ \\frac{\\partial}{\\partial \\theta} \\left( \\sqrt{g} g^{\\theta\\theta} \\frac{\\partial f}{\\partial \\theta} \\right) + \\frac{\\partial}{\\partial \\phi} \\left( \\sqrt{g} g^{\\phi\\phi} \\frac{\\partial f}{\\partial \\phi} \\right) \\right] $$\nThe problem defines edge coefficients $c_\\theta = \\sqrt{g}g^{\\theta\\theta}$ and $c_\\phi = \\sqrt{g}g^{\\phi\\phi}$:\n$$ c_\\theta(\\theta) = a(R_0 + a\\cos\\theta) \\cdot \\frac{1}{a^2} = \\frac{R_0 + a\\cos\\theta}{a} $$\n$$ c_\\phi(\\theta) = a(R_0 + a\\cos\\theta) \\cdot \\frac{1}{(R_0 + a\\cos\\theta)^2} = \\frac{a}{R_0 + a\\cos\\theta} $$\nNote that both coefficients depend only on $\\theta$. The operator can now be written as:\n$$ \\Delta_{LB} f = \\frac{1}{\\sqrt{g}} \\left[ \\frac{\\partial}{\\partial \\theta} \\left( c_\\theta(\\theta) \\frac{\\partial f}{\\partial \\theta} \\right) + \\frac{\\partial}{\\partial \\phi} \\left( c_\\phi(\\theta) \\frac{\\partial f}{\\partial \\phi} \\right) \\right] $$\n\n### 3. Finite Difference Discretization and Self-Adjointness\n\nWe discretize the operator on a uniform grid $(\\theta_i, \\phi_j)$ with spacings $\\Delta\\theta = 2\\pi/N_\\theta$ and $\\Delta\\phi = 2\\pi/N_\\phi$. A second-order accurate finite difference scheme that guarantees self-adjointness is constructed by evaluating fluxes on the edges of the grid cells.\n\nLet $L f = \\frac{\\partial}{\\partial \\theta} ( c_\\theta \\frac{\\partial f}{\\partial \\theta} ) + \\frac{\\partial}{\\partial \\phi} ( c_\\phi \\frac{\\partial f}{\\partial \\phi} )$. Thus, $\\Delta_{LB} f = \\frac{1}{\\sqrt{g}} L f$.\nAt a grid point $(i,j)$, the discrete form of $(Lf)_{i,j}$ is:\n$$ (L f)_{i,j} \\approx \\frac{1}{\\Delta\\theta} \\left[ (c_\\theta \\frac{\\partial f}{\\partial \\theta})_{i+1/2,j} - (c_\\theta \\frac{\\partial f}{\\partial \\theta})_{i-1/2,j} \\right] + \\frac{1}{\\Delta\\phi} \\left[ (c_\\phi \\frac{\\partial f}{\\partial \\phi})_{i,j+1/2} - (c_\\phi \\frac{\\partial f}{\\partial \\phi})_{i,j-1/2} \\right] $$\nUsing centered differences for derivatives and evaluating coefficients at cell edges (midpoints):\n$$ (L f)_{i,j} \\approx \\frac{1}{\\Delta\\theta} \\left[ c_{\\theta,i+1/2} \\frac{f_{i+1,j}-f_{i,j}}{\\Delta\\theta} - c_{\\theta,i-1/2} \\frac{f_{i,j}-f_{i-1,j}}{\\Delta\\theta} \\right] + \\frac{1}{\\Delta\\phi} \\left[ c_{\\phi, i} \\frac{f_{i,j+1}-f_{i,j}}{\\Delta\\phi} - c_{\\phi, i} \\frac{f_{i,j}-f_{i,j-1}}{\\Delta\\phi} \\right] $$\nHere, $c_{\\theta,i\\pm1/2} = c_\\theta(\\theta_{i\\pm1/2})$ and $c_{\\phi,i} = c_\\phi(\\theta_i)$. Since $c_\\phi$ depends only on $\\theta$, its value is constant along the $\\phi$ direction for a given $i$.\n\nThe matrix $A$ of the discrete operator maps the vector of function values $\\mathbf{f}$ to the vector $(\\Delta_{LB} f)_{i,j}$, so $(A\\mathbf{f})_{k} = \\frac{1}{\\sqrt{g}_{i,j}}(L f)_{i,j}$, where $k=i N_\\phi + j$.\nThe self-adjointness condition is that the matrix $WA$ is symmetric, where $W$ is the diagonal matrix of inner product weights $w_{i,j} = \\sqrt{g}_{i,j}\\,\\Delta\\theta\\,\\Delta\\phi$.\nLet's examine an element of the matrix product $S = WA$. For a global index $k$ corresponding to grid point $(i,j)$, the $k$-th diagonal element of $W$ is $W_{k,k}=w_{i,j}$. The action on a vector $\\mathbf{f}$ is:\n$$ (S \\mathbf{f})_k = (W A \\mathbf{f})_k = W_{k,k} (A \\mathbf{f})_k = (\\sqrt{g}_{i,j}\\Delta\\theta\\Delta\\phi) \\left(\\frac{1}{\\sqrt{g}_{i,j}} (L f)_{i,j}\\right) = \\Delta\\theta\\Delta\\phi \\, (L f)_{i,j} $$\nSo, the matrix $S = WA$ is the discrete representation of the operator $\\Delta\\theta\\Delta\\phi \\cdot L$. The symmetry of $S$ (i.e., $S=S^\\top$) is what we need to verify.\n\nLet's look at the off-diagonal elements of $S$. Let $k = i N_\\phi + j$.\nThe coefficient multiplying $f_{i+1,j}$ in the expression for $(S \\mathbf{f})_k$ gives the matrix element $S_{k, l}$ where $l=(i+1)N_\\phi+j$:\n$$ S_{k,l} = \\Delta\\theta\\Delta\\phi \\cdot \\frac{c_{\\theta,i+1/2}}{\\Delta\\theta^2} = \\frac{\\Delta\\phi}{\\Delta\\theta} c_{\\theta,i+1/2} $$\nNow, consider the element $S_{l,k}$. This is the coefficient of $f_{i,j}$ in the expression for $(S\\mathbf{f})_l$. The stencil at point $l=(i+1,j)$ has a term for its neighbor at $(i,j)$:\n$$ \\Delta\\theta\\Delta\\phi \\left( \\dots - c_{\\theta,(i+1)-1/2} \\frac{f_{i+1,j} - f_{i,j}}{\\Delta\\theta^2} \\right) = \\Delta\\theta\\Delta\\phi \\left( \\dots + \\frac{c_{\\theta,i+1/2}}{\\Delta\\theta^2}f_{i,j} \\right)$$\nThe coefficient is $\\frac{\\Delta\\phi}{\\Delta\\theta} c_{\\theta,i+1/2}$. Thus, $S_{k,l} = S_{l,k}$. This symmetry arises from using the same interface coefficient $c_{\\theta,i+1/2}$ for the flux between cells $(i,j)$ and $(i+1,j)$.\n\nA similar argument holds for the $\\phi$ direction. Let $l=iN_\\phi+(j+1)$.\n$$ S_{k,l} = \\Delta\\theta\\Delta\\phi \\cdot \\frac{c_{\\phi,i}}{\\Delta\\phi^2} = \\frac{\\Delta\\theta}{\\Delta\\phi}c_{\\phi,i} $$\nThe element $S_{l,k}$ is the coefficient of $f_{i,j}$ in the expression for $(S\\mathbf{f})_l$. The stencil at $(i,j+1)$ uses coefficient $c_{\\phi,i}$ (it only depends on $i$) and gives:\n$$ \\Delta\\theta\\Delta\\phi \\left( \\dots c_{\\phi,i} \\frac{f_{i,j+2}-2f_{i,j+1}+f_{i,j}}{\\Delta\\phi^2} \\right) = \\Delta\\theta\\Delta\\phi \\left(\\dots + \\frac{c_{\\phi,i}}{\\Delta\\phi^2}f_{i,j} \\right) $$\nThe coefficient is $\\frac{\\Delta\\theta}{\\Delta\\phi} c_{\\phi,i}$. Thus, $S_{k,l}=S_{l,k}$.\nSince all off-diagonal elements are symmetric, the matrix $S = WA$ is symmetric.\n\n### 4. Implementation Strategy\n\nTo verify this numerically, we will construct the sparse matrix $S=WA$ directly. For each grid point $(i, j)$ corresponding to row $k = iN_\\phi+j$, we compute the five stencil entries (center and four neighbors) based on the derived formula for $S$. The neighbors' indices are determined with periodic boundary conditions. The resulting sparse matrix $S$ is then checked for symmetry by computing the maximum absolute element of $S - S^\\top$. This value should be close to zero, within the machine precision limit or a specified tolerance.\n\nThe algorithm is as follows:\n1.  For each test case, set up the grid parameters ($N_\\theta, N_\\phi, \\Delta\\theta, \\Delta\\phi$).\n2.  Compute the coefficient arrays $c_\\theta$ on the $\\theta$-midpoint grid and $c_\\phi$ on the $\\theta$-node grid.\n3.  Initialize data structures for building a sparse matrix (e.g., lists for data, row indices, and column indices).\n4.  Iterate through every grid point $(i, j)$:\n    a. Determine the 1D index $k$ for the current point and the 1D indices for its four neighbors, respecting periodic boundaries.\n    b. Calculate the five non-zero matrix elements for row $k$ of matrix $S = WA$.\n    c. Append these five elements and their corresponding indices to the data structures.\n5.  Construct the sparse matrix $S$ from the collected data.\n6.  Calculate the difference matrix $D = S - S^\\top$.\n7.  Find the maximum absolute value in $D$, $\\|D\\|_{\\max}$.\n8.  Compare $\\|D\\|_{\\max}$ with the given tolerance to determine if the matrix is symmetric.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import csr_matrix\n\ndef create_and_verify_laplacian(R0, a, N_theta, N_phi, tolerance):\n    \"\"\"\n    Derives, implements, and verifies the self-adjointness of a discrete\n    Laplace-Beltrami operator on a toroidal flux surface.\n\n    Args:\n        R0 (float): Major radius of the torus.\n        a (float): Minor radius of the torus.\n        N_theta (int): Number of grid points in the poloidal direction.\n        N_phi (int): Number of grid points in the toroidal direction.\n        tolerance (float): The tolerance for the symmetry check.\n\n    Returns:\n        bool: True if the WA matrix is symmetric within the tolerance, False otherwise.\n    \"\"\"\n    # 1. Grid setup\n    d_theta = 2.0 * np.pi / N_theta\n    d_phi = 2.0 * np.pi / N_phi\n    \n    # 2. Coordinates\n    # Node-centered grid for theta (for c_phi and sqrt(g))\n    theta_nodes = np.arange(N_theta) * d_theta\n    # Edge-centered/midpoint grid for theta (for c_theta)\n    theta_halfs = (np.arange(N_theta) + 0.5) * d_theta\n\n    # 3. Geometric coefficients\n    # c_theta = sqrt(g) * g^{theta,theta} evaluated at midpoints theta_{i+1/2}\n    c_theta_half = (R0 + a * np.cos(theta_halfs)) / a\n    # c_phi = sqrt(g) * g^{phi,phi} evaluated at nodes theta_i\n    c_phi_node = a / (R0 + a * np.cos(theta_nodes))\n\n    # 4. Sparse matrix S = WA construction\n    total_points = N_theta * N_phi\n    # Pre-allocate for a 5-point stencil\n    data = np.zeros(total_points * 5)\n    row_indices = np.zeros(total_points * 5, dtype=int)\n    col_indices = np.zeros(total_points * 5, dtype=int)\n    \n    dv = d_theta * d_phi\n    idx_counter = 0\n\n    for i in range(N_theta):\n        for j in range(N_phi):\n            k = i * N_phi + j  # Current point's 1D index\n\n            # Neighbor indices with periodic boundary conditions\n            ip1 = (i + 1) % N_theta\n            im1 = (i - 1 + N_theta) % N_theta\n            jp1 = (j + 1) % N_phi\n            jm1 = (j - 1 + N_phi) % N_phi\n\n            k_ip1_j = ip1 * N_phi + j\n            k_im1_j = im1 * N_phi + j\n            k_i_jp1 = i * N_phi + jp1\n            k_i_jm1 = i * N_phi + jm1\n\n            # Get coefficients for the finite difference stencil of S=WA\n            # For c_theta, index i corresponds to theta_{i+1/2} and im1 to theta_{i-1/2}\n            c_th_p = c_theta_half[i]\n            c_th_m = c_theta_half[im1]\n            c_ph = c_phi_node[i]\n            \n            # Off-diagonal elements for row k of matrix S = WA\n            \n            # Neighbor i+1\n            s_ip1 = dv * c_th_p / (d_theta**2)\n            data[idx_counter] = s_ip1\n            row_indices[idx_counter] = k\n            col_indices[idx_counter] = k_ip1_j\n            idx_counter += 1\n\n            # Neighbor i-1\n            s_im1 = dv * c_th_m / (d_theta**2)\n            data[idx_counter] = s_im1\n            row_indices[idx_counter] = k\n            col_indices[idx_counter] = k_im1_j\n            idx_counter += 1\n\n            # Neighbor j+1\n            s_jp1 = dv * c_ph / (d_phi**2)\n            data[idx_counter] = s_jp1\n            row_indices[idx_counter] = k\n            col_indices[idx_counter] = k_i_jp1\n            idx_counter += 1\n\n            # Neighbor j-1\n            s_jm1 = dv * c_ph / (d_phi**2)\n            data[idx_counter] = s_jm1\n            row_indices[idx_counter] = k\n            col_indices[idx_counter] = k_i_jm1\n            idx_counter += 1\n            \n            # Diagonal element for row k\n            s_diag = - (s_ip1 + s_im1 + s_jp1 + s_jm1)\n            data[idx_counter] = s_diag\n            row_indices[idx_counter] = k\n            col_indices[idx_counter] = k\n            idx_counter += 1\n            \n    # 5. Create sparse matrix S=WA\n    S = csr_matrix((data, (row_indices, col_indices)), shape=(total_points, total_points))\n    \n    # 6. Check for symmetry: S must equal S^T\n    # The comparison is done by finding the max absolute difference.\n    diff_matrix = S - S.transpose()\n    max_abs_diff = np.abs(diff_matrix).max()\n    \n    return max_abs_diff <= tolerance\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (3.0, 1.0, 32, 64, 1e-12),\n        (3.0, 1.0, 4, 4, 1e-12),\n        (1.2, 1.0, 16, 24, 1e-12),\n        (2.5, 0.5, 64, 96, 1e-12),\n    ]\n\n    results = []\n    for R0, a, N_theta, N_phi, tolerance in test_cases:\n        is_symmetric = create_and_verify_laplacian(R0, a, N_theta, N_phi, tolerance)\n        results.append(is_symmetric)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}