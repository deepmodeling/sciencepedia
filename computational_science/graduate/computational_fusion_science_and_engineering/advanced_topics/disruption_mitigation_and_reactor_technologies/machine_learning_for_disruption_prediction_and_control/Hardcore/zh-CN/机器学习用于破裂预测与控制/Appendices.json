{
    "hands_on_practices": [
        {
            "introduction": "建立可靠的机器学习模型需要稳健的验证方法。对于来自实验（如托卡马克放电）的时间序列数据，由于时间数据泄漏，标准的交叉验证方法可能会失效，导致对模型性能的评估过于乐观。本练习  旨在探讨这一关键问题，教您如何识别泄漏并设计正确的、基于放电的交叉验证策略，以确保对模型性能进行真实可靠的评估。",
            "id": "4003862",
            "problem": "考虑一个采集自托卡马克等离子体实验的数据集，该数据集包含 $S$ 次放电（炮），索引为 $i \\in \\{1,\\dots,S\\}$。每次放电 $i$ 提供了一个诊断信号的多变量时间序列 $\\{x^{(i)}(t)\\}_{t=0}^{T^{(i)}}$，采样间隔为 $\\Delta t$，其中 $x^{(i)}(t) \\in \\mathbb{R}^d$ 是对于某个固定的窗口长度 $\\tau$，从时间窗口 $[t-\\tau, t]$ 中因果地计算出的特征。对于发生破裂的放电，令 $t_d^{(i)}$ 表示破裂时间。破裂预警任务是对于某个给定的预警时间 $L > 0$，仅使用特征 $x^{(i)}(t)$ 来预测某个时间点 $t$ 是否位于破裂前的时间区间 $[t_d^{(i)} - L, t_d^{(i)})$ 内。因此，对于破裂放电，正确的标签函数为 $y^{(i)}(t) = \\mathbb{1}\\{t \\in [t_d^{(i)} - L, t_d^{(i)})\\}$；对于未破裂放电，标签函数为 $y^{(i)}(t) = 0$。\n\n假设由于日志记录延迟和时钟漂移，在构建标签时引入了一个固定的、每次放电特有的时间未对准量 $\\delta^{(i)}$，因此数据集使用的标签为 $\\tilde{y}^{(i)}(t) = \\mathbb{1}\\{t + \\delta^{(i)} \\in [t_d^{(i)} - L, t_d^{(i)})\\}$，其中 $\\delta^{(i)}$ 的量级为几十毫秒，且 $|\\delta^{(i)}| \\ll T^{(i)}$。特征 $x^{(i)}(t)$ 仍然是因果计算的，没有使用未来的样本。\n\n你的任务是执行 $K$ 折交叉验证（Cross-Validation, CV）来估计模型的泛化能力。考虑了两种交叉验证方案：窗口级别的随机 $K$ 折交叉验证，该方案将单个时间窗口划分到不同的折（fold）中，而不考虑其所属的放电编号；以及放电级别的分组 $K$ 折交叉验证，该方案将整次放电分配到某个折中。假设对于较小的延迟，特征过程在单次放电内的自相关性很高，即自相关函数 $\\rho^{(i)}(\\Delta) = \\mathbb{E}[\\langle x^{(i)}(t), x^{(i)}(t+\\Delta)\\rangle]/(\\|x^{(i)}(t)\\|_2 \\|x^{(i)}(t+\\Delta)\\|_2)$ 在 $|\\Delta| \\leq |\\delta^{(i)}|$ 时满足 $\\rho^{(i)}(\\Delta) \\approx 1$。\n\n请从第一性原理出发，利用因果性、训练集与测试集之间的独立性以及自相关效应的定义，推断在标签未对准情况下交叉验证中存在的时间泄漏（temporal leakage）问题。然后，设计一个放电级别的划分方案，该方案既能消除泄漏，又能最大化训练数据在不同操作条件下的多样性。每次放电的操作条件由一些标量描述符来概括，例如等离子体电流 $I_p^{(i)}$、边缘安全因子 $q_{95}^{(i)}$ 和归一化比压 $\\beta_N^{(i)}$。假设每次破裂放电的正样本窗口数量约为 $n_+^{(i)} \\approx L/\\Delta t$，并将每次放电的类别权重 $w^{(i)}$ 定义为：对于破裂放电，$w^{(i)} = n_+^{(i)}$；对于未破裂放电，$w^{(i)} = c \\cdot n_-^{(i)}$，其中 $c > 0$ 为某个常数，$n_-^{(i)}$ 是负样本窗口的数量。\n\n以下哪个选项正确地指出了未对准的标签如何在交叉验证中引入时间泄漏，并指定了一个有效的、能够在消除泄漏的同时最大化训练多样性的放电级别划分设计？\n\nA. 在窗口级别的随机 $K$ 折交叉验证中，未对准的标签 $\\tilde{y}^{(i)}(t)$ 意味着，对于放电 $i$ 中位于时间 $t$ 的一个测试窗口，存在来自同一次放电、时间点在 $t' \\approx t + \\delta^{(i)}$ 且标签相同的训练窗口。由于 $\\rho^{(i)}(\\delta^{(i)}) \\approx 1$，$x^{(i)}(t)$ 和 $x^{(i)}(t')$ 几乎相同，因此训练集包含了与测试特征几乎重复且标签匹配的样本，这违反了独立性假设，并导致了时间泄漏。\n\nB. 一个能够消除泄漏并最大化多样性的方案是：按放电进行分组 $K$ 折交叉验证，同时对每折进行分层，以通过权重 $w^{(i)}$ 平衡破裂与未破裂的放电，并通过最小化各折直方图之间的散度来匹配 $\\{I_p^{(i)}, q_{95}^{(i)}, \\beta_N^{(i)}\\}$ 在各折中的经验分布。这确保了同一次放电的所有窗口都位于同一个折中，消除了训练集和测试集之间在单次放电内的时间重叠，强制执行了正确的标签对准 $y^{(i)}(t)$，并通过平衡操作条件最大化了训练多样性。\n\nC. 随机地将窗口分配到不同的折中，同时确保每个折具有相同数量的窗口，这足以消除泄漏，因为每个折的样本数量是独立性的主要决定因素。仅靠相等的数量也能最大化多样性。\n\nD. 使用一个前向的窗口 $[t, t+\\tau]$ 来计算特征，同时保持未对准的标签 $\\tilde{y}^{(i)}(t)$，可以在不产生泄漏的情况下提高预测性能，因为标签的偏移 $\\delta^{(i)}$ 抵消了未来信息的使用，使得任务是适定的。\n\n选择所有正确选项。",
            "solution": "### 问题验证\n\n首先，我必须仔细验证问题陈述。\n\n**步骤1：提取已知条件**\n\n*   **数据集：** $S$ 次托卡马克放电（炮），索引为 $i \\in \\{1,\\dots,S\\}$。\n*   **时间序列数据：** 对于每次放电 $i$，一个多变量时间序列 $\\{x^{(i)}(t)\\}_{t=0}^{T^{(i)}}$，采样间隔为 $\\Delta t$。\n*   **特征：** $x^{(i)}(t) \\in \\mathbb{R}^d$ 是从时间窗口 $[t-\\tau, t]$ 因果地计算出的特征。\n*   **破裂时间：** 对于破裂放电，$t_d^{(i)}$ 是破裂时间。\n*   **预警时间：** 一个固定的预警时间 $L > 0$ 定义了预警窗口。\n*   **正确标签：** 对于破裂放电，$y^{(i)}(t) = \\mathbb{1}\\{t \\in [t_d^{(i)} - L, t_d^{(i)})\\}$；对于未破裂放电，$y^{(i)}(t) = 0$。\n*   **未对准标签：** 数据集使用标签 $\\tilde{y}^{(i)}(t) = \\mathbb{1}\\{t + \\delta^{(i)} \\in [t_d^{(i)} - L, t_d^{(i)})\\}$，因为存在一个固定的、每次放电特有的时间未对准量 $\\delta^{(i)}$。\n*   **未对准量级：** $\\delta^{(i)}$ 的量级为几十毫秒，且 $|\\delta^{(i)}| \\ll T^{(i)}$。\n*   **交叉验证（CV）方案：**\n    1.  窗口级别的随机 $K$ 折交叉验证。\n    2.  放电级别的分组 $K$ 折交叉验证。\n*   **自相关假设：** 单次放电内的特征自相关函数 $\\rho^{(i)}(\\Delta) = \\mathbb{E}[\\langle x^{(i)}(t), x^{(i)}(t+\\Delta)\\rangle]/(\\|x^{(i)}(t)\\|_2 \\|x^{(i)}(t+\\Delta)\\|_2)$ 在 $|\\Delta| \\leq |\\delta^{(i)}|$ 时满足 $\\rho^{(i)}(\\Delta) \\approx 1$。\n*   **放电描述符：** 每次放电的标量操作条件由等离子体电流 $I_p^{(i)}$、边缘安全因子 $q_{95}^{(i)}$ 和归一化比压 $\\beta_N^{(i)}$ 给出。\n*   **窗口计数与权重：** 每次破裂放电的正样本窗口数量 $n_+^{(i)} \\approx L/\\Delta t$。每次放电的类别权重 $w^{(i)}$ 对于破裂放电是 $n_+^{(i)}$，对于未破裂放电是 $c \\cdot n_-^{(i)}$（$c > 0$，$n_-^{(i)}$ 是负样本窗口的数量）。\n*   **任务：** 分析由未对准标签引起的交叉验证中的时间泄漏，并设计一个无泄漏、多样性最大化的放电级别划分方案。\n\n**步骤2：使用提取的已知条件进行验证**\n\n*   **科学依据：** 该问题牢固地植根于计算聚变科学和机器学习领域，这是一个主要的研究领域。破裂预测、托卡马克诊断、操作参数（$I_p, q_{95}, \\beta_N$）、时间序列分析、交叉验证和时间数据泄漏都是该领域中标准且成熟的概念。时间基准未对准（$\\delta^{(i)}$）的情景是实验物理学中一个现实的数据质量问题。\n*   **适定性：** 该问题提供了一个清晰而完整的设置。所有术语都已定义，背景已明确，问题要求对特定现象（泄漏）进行原则性分析，并设计一种方法来应对它。基于所提供的信息，可以进行独特且有意义的分析。\n*   **客观性：** 问题以精确、正式的语言陈述，使用数学符号和既定的技术术语。它没有主观断言或模糊不清之处。\n\n**步骤3：结论与行动**\n\n问题陈述是**有效的**。它在科学上是合理的，适定的，客观的，并且与计算聚变科学的机器学习领域直接相关。我现在将进行解答推导。\n\n### 解答推导\n\n这个问题有两个部分：首先，分析在给定的数据条件下，特定交叉验证方案引入的时间泄漏；其次，设计一个鲁棒的交叉验证方案。\n\n**第一部分：窗口级别交叉验证中的时间泄漏分析**\n\n交叉验证的基本原则是估计模型在未见过的数据上的泛化误差。这要求训练集和测试集是独立的。在来自单一过程（一次等离子体放电）的时间序列数据中，邻近时间点的样本不是独立的；它们在时间上是相关的。\n\n1.  **交叉验证方案：** 考虑的第一个方案是窗口级别的随机 $K$ 折交叉验证。该方案汇集了所有放电 $i \\in \\{1, \\dots, S\\}$ 的所有时间窗口 $(x^{(i)}(t), \\tilde{y}^{(i)}(t))$，并将其随机划分为 $K$ 个折。这意味着对于任何给定的放电 $i$，其部分时间窗口可能在训练集中，而其他部分则在测试集中。\n\n2.  **自相关：** 问题陈述指出，对于小的延迟 $\\Delta$，特征的自相关性 $\\rho^{(i)}(\\Delta)$ 很高。具体来说，对于等于未对准时间的延迟，$\\rho^{(i)}(|\\delta^{(i)}|) \\approx 1$。这意味着对于小的 $\\Delta$，特征向量 $x^{(i)}(t)$ 和 $x^{(i)}(t+\\Delta)$ 几乎相同。\n\n3.  **违反独立性（泄漏）：** 让我们考虑一个来自放电 $i$ 的测试样本 $(x^{(i)}(t_{test}), \\tilde{y}^{(i)}(t_{test}))$。由于随机的窗口级别划分，来自同一次放电、时间点相近的样本，例如 $(x^{(i)}(t_{train}), \\tilde{y}^{(i)}(t_{train}))$ 其中 $t_{train} \\approx t_{test}$，很有可能位于训练集中。由于高度的自相关性，测试特征 $x^{(i)}(t_{test})$ 与训练特征 $x^{(i)}(t_{train})$ 几乎相同。如果它们的标签也相同，模型基本上可以在训练期间“记住”测试样本。这会给模型在真正的新数据上的性能带来一个被人为夸大且无效的估计。这种现象被称为时间泄漏。\n\n4.  **未对准标签的作用：** 标签未对准 $\\delta^{(i)}$ 并不是导致泄漏的原因，但它提供了一个特定的时间尺度来分析泄漏，如选项A中所强调的。真正的原因是自相关性与将单个时间序列（一次放电）划分到训练/测试集中的组合。未对准的标签是 $\\tilde{y}^{(i)}(t) = \\mathbb{1}\\{t + \\delta^{(i)} \\in [t_d^{(i)} - L, t_d^{(i)}) \\}$。\n\n**第二部分：设计鲁棒的交叉验证方案**\n\n一个鲁棒的交叉验证方案必须解决两个主要挑战：\n\n1.  **消除泄漏：** 为防止上述的时间泄漏，必须在独立实验单元（即等离子体放电）的层面上强制执行训练集和测试集之间的独立性。因此，来自单次放电 $i$ 的所有数据（所有时间窗口）都必须属于同一个折。这种方案被称为分组 $K$ 折交叉验证，其中每次放电 $i$ 是一个组。\n\n2.  **最大化训练多样性：** 托卡马克等离子体在不同的条件下运行，这些条件由 $I_p^{(i)}, q_{95}^{(i)}, \\beta_N^{(i)}$ 等参数概括。简单地将放电随机分配到不同的折中，可能会导致某些折不能代表整个数据集。例如，某个折可能包含不成比例的高电流放电。一个在其他 $K-1$ 个折上训练的模型，将在一个它没有充分接触过的工况区间上进行测试，这会导致一个差的、高方差的泛化误差估计。为了最大化多样性并获得稳定的估计，必须对折进行分层。这意味着划分放电时，要使关键特征的分布在所有 $K$ 个折中尽可能相似。需要分层的特征是：\n    *   放电结果（破裂 vs. 未破裂），可能使用提供的权重 $w^{(i)}$ 来平衡每个类别在各折中的总“重要性”。\n    *   操作条件参数 $\\{I_p^{(i)}, q_{95}^{(i)}, \\beta_N^{(i)}\\}$。这是一个多维分层问题。一个常见且有效的方法是根据这些参数对放电进行分箱，并确保每个箱均匀分布在各个折中，或者更一般地，使用一种优化算法，该算法通过最小化每个折中这些参数经验分布之间的某种散度度量（如Wasserstein距离或直方图矩的差异）来进行划分。\n\n这个由两部分组成的策略——按放电进行分组 $K$ 折交叉验证，再加上按放电级别的属性进行分层——构成了解决此问题的最先进方法。\n\n### 逐项分析\n\n**A. 在窗口级别的随机 $K$ 折交叉验证中，未对准的标签 $\\tilde{y}^{(i)}(t)$ 意味着，对于放电 $i$ 中位于时间 $t$ 的一个测试窗口，存在来自同一次放电、时间点在 $t' \\approx t + \\delta^{(i)}$ 且标签相同的训练窗口。由于 $\\rho^{(i)}(\\delta^{(i)}) \\approx 1$，$x^{(i)}(t)$ 和 $x^{(i)}(t')$ 几乎相同，因此训练集包含了与测试特征几乎重复且标签匹配的样本，这违反了独立性假设，并导致了时间泄漏。**\n\n该选项正确地指出了时间泄漏的机制。\n1.  它正确地指责了窗口级别的随机 $K$ 折交叉验证因划分同一次放电的数据而存在缺陷。\n2.  它正确地使用了给定的自相关属性 $\\rho^{(i)}(\\delta^{(i)}) \\approx 1$，来说明由延迟 $\\delta^{(i)}$ 分隔的特征几乎相同。\n3.  它声称在时间 $t$ 和 $t' = t+\\delta^{(i)}$ 的窗口标签是相同的。让我们检查一下：$\\tilde{y}^{(i)}(t) = \\mathbb{1}\\{t+\\delta^{(i)} \\in [t_d^{(i)}-L, t_d^{(i)})\\}$ 且 $\\tilde{y}^{(i)}(t+\\delta^{(i)}) = \\mathbb{1}\\{t+2\\delta^{(i)} \\in [t_d^{(i)}-L, t_d^{(i)}) \\}$。由于预警时间 $L$ 通常是几百毫秒，而未对准量 $\\delta^{(i)}$ 是几十毫秒，所以 $L \\gg |\\delta^{(i)}|$。因此，对于大多数标签为1的时间点 $t$，其后 $\\delta^{(i)}$ 的时间点标签也为1。对于标签为0的点也是如此。标签只会在预警窗口的两个边界附近不同。因此，“标签匹配”的说法对于绝大多数样本是近似正确的。\n4.  由此得出这构成了对独立性的违反并导致泄漏的结论是正确的。模型正在对自己已经在训练中见过的几乎重复的数据进行测试。\n**结论：正确。**\n\n**B. 一个能够消除泄漏并最大化多样性的方案是：按放电进行分组 $K$ 折交叉验证，同时对每折进行分层，以通过权重 $w^{(i)}$ 平衡破裂与未破裂的放电，并通过最小化各折直方图之间的散度来匹配 $\\{I_p^{(i)}, q_{95}^{(i)}, \\beta_N^{(i)}\\}$ 在各折中的经验分布。这确保了同一次放电的所有窗口都位于同一个折中，消除了训练集和测试集之间在单次放电内的时间重叠，强制执行了正确的标签对准 $y^{(i)}(t)$，并通过平衡操作条件最大化了训练多样性。**\n\n该选项描述了上面推导出的鲁棒交叉验证方案。\n1.  `按放电进行分组 K 折交叉验证`是消除时间泄漏的正确方法。\n2.  `对每折进行分层`以平衡放电类型并匹配操作参数（$\\{I_p^{(i)}, q_{95}^{(i)}, \\beta_N^{(i)}\\}$）的分布，是最大化多样性并确保折具有代表性的正确方法。\n3.  `消除了训练集和测试集之间在单次放电内的时间重叠`的说法是按放电分组的直接且正确的结果。\n4.  `强制执行了正确的标签对准 y^{(i)}(t)`这一子句不精确。划分方案本身只划分数据，不修改数据。然而，按放电分组是在每个折的模型训练阶段正确处理每次放电的未对准量 $\\delta^{(i)}$ 的必要先决条件。如果没有放电级别的分组，就不可能对标签应用正确的、每次放电特有的时间移位。从这个意义上说，所描述的方案*使得*强制执行正确的对准成为可能。鉴于该选项的所有其他部分都以高精度描述了理想的方法，这种不精确性是措辞上的小瑕疵，而非根本性的概念错误。所描述的整体方案在科学上是正确的。\n**结论：正确。**\n\n**C. 随机地将窗口分配到不同的折中，同时确保每个折具有相同数量的窗口，这足以消除泄漏，因为每个折的样本数量是独立性的主要决定因素。仅靠相等的数量也能最大化多样性。**\n\n该选项根本上是错误的。\n1.  `随机地将窗口分配到不同的折中`是导致时间泄漏的有缺陷方法的定义，它并不能消除泄漏。\n2.  声称`每个折的样本数量是独立性的主要决定因素`是错误的。样本的来源和相关结构决定了独立性，而不是它们的数量。\n3.  声称`仅靠相等的数量也能最大化多样性`是错误的。窗口数量相等的折可能在操作条件分布上存在巨大差异，导致多样性差。\n**结论：不正确。**\n\n**D. 使用一个前向的窗口 $[t, t+\\tau]$ 来计算特征，同时保持未对准的标签 $\\tilde{y}^{(i)}(t)$，可以在不产生泄漏的情况下提高预测性能，因为标签的偏移 $\\delta^{(i)}$ 抵消了未来信息的使用，使得任务是适定的。**\n\n该选项提出了一种非因果的建模方法。\n1.  任务是提供*预警*，这需要一个只使用过去和现在信息的因果模型。从前向窗口 $[t, t+\\tau]$ 计算特征使用了未来的信息，违反了因果性。\n2.  标签是 $\\tilde{y}^{(i)}(t) = y^{(i)}(t+\\delta^{(i)})$，它涉及时间 $t+\\delta^{(i)}$ 的事件。使用来自 $[t, t+\\tau]$ 的特征来预测这一点，意味着模型被要求使用一个可能包含甚至晚于 $t+\\delta^{(i)}$（如果 $\\tau \\ge \\delta^{(i)}$）的窗口中的信息来预测 $t+\\delta^{(i)}$ 的事件。这不是预测，而是内插或描述。\n3.  标签偏移`抵消`了未来数据使用的推理是毫无根据的。使用未来数据来预测未来事件是典型的违反因果性的行为，会导致不切实际地夸大性能指标，并产生一个在实践中无用的模型。\n**结论：不正确。**",
            "answer": "$$\\boxed{AB}$$"
        },
        {
            "introduction": "破裂预测模型为我们提供了概率，但控制系统需要一个二元决策：采取缓解措施，或不采取。最佳决策取决于对不同错误成本的权衡——漏报一次破裂（假阴性）的代价远高于一次错误的警报（假阳性）。在本练习中 ，您将应用贝叶斯决策理论，推导触发缓解措施的最优概率阈值，从而将概率性预测转化为具有成本效益的行动。",
            "id": "4003916",
            "problem": "在托卡马克破裂预测与控制系统中，一个机器学习分类器输出一个校准后的后验概率 $q(\\mathbf{x}) = P(y=1 \\mid \\mathbf{x})$，表示等离子体在短时间窗口 $\\Delta t$ 内将发生破裂，其中 $y=1$ 表示即将发生破裂，$y=0$ 表示不会立即发生破裂。控制决策是一个二元动作：触发缓解 ($a=1$) 或不触发缓解 ($a=0$)。当 $a=1$ 且 $y=0$ 时，发生假正例（FP），产生代价 $C_{\\mathrm{FP}}$；当 $a=0$ 且 $y=1$ 时，发生假反例（FN），产生代价 $C_{\\mathrm{FN}}$。假设分类器的概率在先验破裂率为 $p = P(y=1)$ 的数据分布下是良好校准的。\n\n从风险最小化原则和对每个 $\\mathbf{x}$ 的条件期望损失（贝叶斯风险）的定义出发，推导在非对称代价 $C_{\\mathrm{FP}}$ 和 $C_{\\mathrm{FN}}$ 下，当且仅当 $q(\\mathbf{x}) \\ge \\tau^{\\star}$ 时触发缓解动作的最优阈值 $\\tau^{\\star}$。然后，为一个先验概率 $p = 0.15$、代价 $C_{\\mathrm{FP}} = 1.7$（归一化代价单位）和 $C_{\\mathrm{FN}} = 9.3$（归一化代价单位）的系统，数值计算 $\\tau^{\\star}$，假设概率 $q(\\mathbf{x})$ 是相对于相同先验 $p$ 的校准后验概率。将阈值表示为不带单位的小数，并将答案四舍五入至四位有效数字。",
            "solution": "所提出的问题是有效的。这是一个将贝叶斯决策理论应用于带有非对称代价的二元分类任务的明确定义的应用，这是机器学习及其应用中的一个标准且有科学依据的问题。托卡马克破裂预测的背景是计算聚变科学中一个现实且重要的研究领域。所有必要的参数都已提供，目标也已明确说明。\n\n我们首先建立最小化期望损失（也称为贝叶斯风险）的框架。对于由特征向量 $\\mathbf{x}$ 表示的每个特定等离子体状态，都需要做出触发缓解（$a=1$）或不触发（$a=0$）的决策。最优决策规则选择在给定观测值 $\\mathbf{x}$ 的情况下最小化条件期望损失的动作。\n\n分类器提供了即将发生破裂的后验概率，$q(\\mathbf{x}) = P(y=1 \\mid \\mathbf{x})$，其中 $y=1$ 表示破裂，$y=0$ 表示稳定运行。因此，不发生破裂的概率为 $P(y=0 \\mid \\mathbf{x}) = 1 - q(\\mathbf{x})$。\n\n问题为错误决策定义了一个代价结构。设 $L(a, y)$ 是当真实结果为 $y$ 时采取行动 $a$ 所产生的损失。根据问题陈述：\n\\begin{itemize}\n    \\item 假正例（FP）的代价：采取行动 $a=1$（缓解），但真实状态是 $y=0$（无破裂）。损失为 $L(1, 0) = C_{\\mathrm{FP}}$。\n    \\item 假反例（FN）的代价：采取行动 $a=0$（不缓解），但真实状态是 $y=1$（破裂）。损失为 $L(0, 1) = C_{\\mathrm{FN}}$。\n\\end{itemize}\n正确决策的代价默认为零，这是专注于错误所致损失的标准惯例。\n\\begin{itemize}\n    \\item 真正例（TP）的代价：采取行动 $a=1$，真实状态是 $y=1$。损失为 $L(1, 1) = 0$。\n    \\item 真反例（TN）的代价：采取行动 $a=0$，真实状态是 $y=0$。损失为 $L(0, 0) = 0$。\n\\end{itemize}\n\n对于每个行动 $a$，其条件期望损失（或风险）$R(a \\mid \\mathbf{x})$ 是该行动可能产生的所有损失与其条件概率加权的和。\n\n对于行动 $a=1$（触发缓解），条件期望损失是：\n$$R(a=1 \\mid \\mathbf{x}) = L(1, 1)P(y=1 \\mid \\mathbf{x}) + L(1, 0)P(y=0 \\mid \\mathbf{x})$$\n代入已知值和概率：\n$$R(a=1 \\mid \\mathbf{x}) = (0) \\cdot q(\\mathbf{x}) + C_{\\mathrm{FP}} \\cdot (1 - q(\\mathbf{x})) = C_{\\mathrm{FP}}(1 - q(\\mathbf{x}))$$\n\n对于行动 $a=0$（不触发缓解），条件期望损失是：\n$$R(a=0 \\mid \\mathbf{x}) = L(0, 1)P(y=1 \\mid \\mathbf{x}) + L(0, 0)P(y=0 \\mid \\mathbf{x})$$\n代入已知值和概率：\n$$R(a=0 \\mid \\mathbf{x}) = C_{\\mathrm{FN}} \\cdot q(\\mathbf{x}) + (0) \\cdot (1 - q(\\mathbf{x})) = C_{\\mathrm{FN}}q(\\mathbf{x})$$\n\n贝叶斯最优决策规则是选择具有最小条件期望损失的行动。如果触发缓解（$a=1$）的风险小于或等于不触发的风险，我们应该触发缓解。问题指定决策规则为当 $q(\\mathbf{x}) \\ge \\tau^{\\star}$ 时触发，这意味着将边界情况（风险相等）分配给行动 $a=1$。因此，我们在以下条件下触发缓解：\n$$R(a=1 \\mid \\mathbf{x}) \\le R(a=0 \\mid \\mathbf{x})$$\n代入风险的表达式：\n$$C_{\\mathrm{FP}}(1 - q(\\mathbf{x})) \\le C_{\\mathrm{FN}}q(\\mathbf{x})$$\n我们现在解这个关于 $q(\\mathbf{x})$ 的不等式，以找到缓解是最优行动的条件。\n$$C_{\\mathrm{FP}} - C_{\\mathrm{FP}}q(\\mathbf{x}) \\le C_{\\mathrm{FN}}q(\\mathbf{x})$$\n$$C_{\\mathrm{FP}} \\le C_{\\mathrm{FN}}q(\\mathbf{x}) + C_{\\mathrm{FP}}q(\\mathbf{x})$$\n$$C_{\\mathrm{FP}} \\le (C_{\\mathrm{FP}} + C_{\\mathrm{FN}})q(\\mathbf{x})$$\n假设 $C_{\\mathrm{FP}} + C_{\\mathrm{FN}}  0$，这是物理上要求的，因为代价不能为负，我们可以在不改变不等式方向的情况下进行除法：\n$$q(\\mathbf{x}) \\ge \\frac{C_{\\mathrm{FP}}}{C_{\\mathrm{FP}} + C_{\\mathrm{FN}}}$$\n这个不等式定义了决策规则。当且仅当分类器的输出概率 $q(\\mathbf{x})$ 超过某个阈值时，才选择缓解行动 $a=1$。通过将其与期望的决策规则形式 $q(\\mathbf{x}) \\ge \\tau^{\\star}$进行比较，我们可以直接确定最优阈值 $\\tau^{\\star}$。\n$$\\tau^{\\star} = \\frac{C_{\\mathrm{FP}}}{C_{\\mathrm{FP}} + C_{\\mathrm{FN}}}$$\n值得注意的是，这个最优阈值仅取决于错误分类的代价，并且与破裂的先验概率 $p=P(y=1)$无关。先验概率对于训练和校准分类器是相关的，以确保 $q(\\mathbf{x})$ 是一个正确的后验概率，但它本身不进入阈值的计算。\n\n现在，我们使用给定的代价计算 $\\tau^{\\star}$ 的数值：$C_{\\mathrm{FP}} = 1.7$ 和 $C_{\\mathrm{FN}} = 9.3$。\n$$\\tau^{\\star} = \\frac{1.7}{1.7 + 9.3}$$\n$$\\tau^{\\star} = \\frac{1.7}{11.0}$$\n$$\\tau^{\\star} = 0.154545\\overline{45}...$$\n问题要求将答案四舍五入到四位有效数字。\n$$\\tau^{\\star} \\approx 0.1545$$\n这是触发缓解系统的最优阈值。如果 $q(\\mathbf{x}) \\ge 0.1545$，则采取行动 $a=1$，否则采取行动 $a=0$。",
            "answer": "$$\n\\boxed{0.1545}\n$$"
        },
        {
            "introduction": "简单的二元分类器预测破裂*是否*会发生，但无法预测*何时*发生。对于先进的控制系统而言，了解风险随时间演变的过程更为重要。生存分析，特别是Cox比例风险模型，正是为模拟事件发生时间数据而设计的，使其成为完成此项任务的完美工具。这项高级实践  将指导您实现Cox模型的核心——偏对数似然函数，使您能够构建可预测破裂瞬时风险的模型。",
            "id": "4003911",
            "problem": "您的任务是形式化并计算一个基于风险的机器学习模型的偏对数似然，该模型用于预测磁约束聚变等离子体（托卡马克）中的破裂时间。该模型是带有随时间变化协变量的 Cox 比例风险 (CPH) 模型。您必须从第一性原理出发，使用风险率、生存函数和比例风险假设的定义，推导出右删失情况下的偏对数似然，然后针对小的、分段恒定的协变量轨迹进行算法实现。所有时间量必须以秒为单位表示，任何计算出的数值输出必须是无量纲的实数。\n\n需要使用的定义和假设：\n- 炮 $i$ 的瞬时风险率 $h_i(t)$ 是当 $t$ 推进时条件事件率的极限，定义为 $h_i(t) = \\lim_{\\Delta t \\to 0^+} \\frac{\\mathbb{P}(T_i \\in [t, t + \\Delta t) \\mid T_i \\ge t)}{\\Delta t}$，其中 $T_i$ 是事件时间（破裂时间）或删失时间。\n- 生存函数 $S_i(t)$ 满足 $S_i(t) = \\mathbb{P}(T_i \\ge t)$，并通过 $S_i(t) = \\exp\\left(-\\int_0^t h_i(u) \\, du\\right)$ 与风险率相关。\n- 比例风险假设假定 $h_i(t) = h_0(t) \\, \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_i(t)\\right)$，其中 $h_0(t)$ 是所有炮共有的未指定的基准风险，$\\boldsymbol{\\beta}$ 是一个恒定的系数向量，$\\mathbf{x}_i(t)$ 是特定于炮的、可能随时间变化的协变量向量。\n- 协变量随时间分段恒定。对于在时间 $t_j$ 发生的任何事件（破裂），用于炮 $i$ 的协变量值必须是左极限 $\\mathbf{x}_i(t_j^-)$，即 $t_j$ 之前的值。\n- 存在右删失：如果一炮在时间 $c_i$ 被删失，它对直到时间 $t  c_i$ 的风险集有贡献，但不产生事件贡献。\n\n您的任务：\n- 推导偏对数似然。该似然仅通过比例风险结构依赖于观测到的事件时间的顺序和协变量，并通过在每个事件时间对风险集进行条件化来消除 $h_0(t)$。\n- 实现一个程序，为给定的 $\\boldsymbol{\\beta}$ 和一个炮数据集计算偏对数似然，其中每炮都有一个删失或事件时间以及一系列分段恒定的协变量段。在每个事件时间使用正确的左极限协变量评估，并将每个事件时间 $t_j$ 的风险集构建为所有满足 $t_j \\le T_i$ 的炮 $i$（事件时间被视为在 $t_j$ 之前处于风险中）。\n- 您必须以秒为单位处理所有时间，并生成无量纲的偏对数似然值。\n\n要使用的协变量：\n- 协变量向量 $\\mathbf{x}_i(t)$ 是三维的，$\\mathbf{x}_i(t) = \\left[x_{1i}(t), x_{2i}(t), x_{3i}(t)\\right]$。将 $x_{1i}(t)$ 解释为归一化等离子体电流比（无量纲），$x_{2i}(t)$ 解释为以特斯拉为单位的锁模径向磁扰动幅度，以及 $x_{3i}(t)$ 解释为以 $10^{19}\\,\\mathrm{m}^{-3}$ 为单位的线平均密度（相对于此标度是无量纲的）。单位应一致处理，但最终计算出的似然是无量纲的。\n\n测试套件：\n- 数据集 A（混合事件和删失，时变协变量）：\n    - 炮 1：在 3.0 s 发生事件；分段：\n        - $[0.0, 1.0)$ s: $\\mathbf{x} = (1.20, 1.0\\times 10^{-4}, 0.60)$\n        - $[1.0, 2.5)$ s: $\\mathbf{x} = (1.30, 2.0\\times 10^{-4}, 0.58)$\n        - $[2.5, 3.0)$ s: $\\mathbf{x} = (1.40, 4.0\\times 10^{-4}, 0.55)$\n    - 炮 2：在 4.0 s 删失；分段：\n        - $[0.0, 2.0)$ s: $\\mathbf{x} = (1.00, 1.0\\times 10^{-4}, 0.62)$\n        - $[2.0, 4.0)$ s: $\\mathbf{x} = (1.05, 1.5\\times 10^{-4}, 0.60)$\n    - 炮 3：在 2.2 s 发生事件；分段：\n        - $[0.0, 1.0)$ s: $\\mathbf{x} = (1.50, 3.0\\times 10^{-4}, 0.50)$\n        - $[1.0, 2.2)$ s: $\\mathbf{x} = (1.60, 5.0\\times 10^{-4}, 0.49)$\n    - 炮 4：在 3.5 s 删失；分段：\n        - $[0.0, 1.5)$ s: $\\mathbf{x} = (0.90, 1.0\\times 10^{-4}, 0.65)$\n        - $[1.5, 3.5)$ s: $\\mathbf{x} = (1.00, 2.5\\times 10^{-4}, 0.64)$\n- 数据集 B（全部删失）：\n    - 炮 1：在 2.0 s 删失；分段：\n        - $[0.0, 2.0)$ s: $\\mathbf{x} = (1.10, 2.0\\times 10^{-4}, 0.60)$\n    - 炮 2：在 3.0 s 删失；分段：\n        - $[0.0, 3.0)$ s: $\\mathbf{x} = (1.30, 1.0\\times 10^{-4}, 0.55)$\n- 数据集 C（事件发生在协变量变化边界；确保使用左极限）：\n    - 炮 1：在 1.0 s 发生事件；分段：\n        - $[0.0, 1.0)$ s: $\\mathbf{x} = (1.00, 2.0\\times 10^{-4}, 0.60)$\n        - $[1.0, 2.0)$ s: $\\mathbf{x} = (1.20, 5.0\\times 10^{-4}, 0.60)$\n    - 炮 2：在 2.0 s 删失；分段：\n        - $[0.0, 2.0)$ s: $\\mathbf{x} = (1.00, 1.0\\times 10^{-4}, 0.60)$\n- 数据集 D（事件发生时只有一个受试对象处于风险中）：\n    - 炮 1：在 2.0 s 发生事件；分段：\n        - $[0.0, 2.0)$ s: $\\mathbf{x} = (1.10, 2.0\\times 10^{-4}, 0.60)$\n    - 炮 2：在 1.0 s 删失；分段：\n        - $[0.0, 1.0)$ s: $\\mathbf{x} = (0.90, 1.0\\times 10^{-4}, 0.70)$\n\n待评估的系数向量：\n- 情况 1：$\\boldsymbol{\\beta} = (0.50, 3000.0, -0.50)$\n- 情况 2：$\\boldsymbol{\\beta} = (0.70, 4000.0, -0.90)$\n- 情况 3：$\\boldsymbol{\\beta} = (0.00, 0.00, 0.00)$\n\n计算要求：\n- 对于每个数据集和系数向量，使用正确的风险集构建和左极限协变量评估，将偏对数似然值计算为单个实数。\n- 使用自然对数。\n- 所提供的数据集中不存在事件时间的并列情况；如果事件恰好发生在协变量段边界 $t_b$ 处，请使用紧邻 $t_b$ 之前的段的协变量值（左极限）。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果按以下顺序排列：\n    - 数据集 A 与情况 1，数据集 A 与情况 2，数据集 A 与情况 3，数据集 B 与情况 1，数据集 C 与情况 2，数据集 D 与情况 1。\n- 将每个结果表示为四舍五入到 $6$ 位小数的浮点数。\n- 示例格式：$\\texttt{[r_1,r_2,r_3,r_4,r_5,r_6]}$，其中每个 $r_k$ 是一个无量纲的实数。",
            "solution": "该问题要求推导和实现带有随时间变化协变量的 Cox 比例风险 (CPH) 模型的偏对数似然。推导从风险率和生存函数的基本定义开始，最终得出一个与未指定的基准风险无关的表达式。\n\n设有 $N$ 个独立的炮（受试对象）。对于每炮 $i \\in \\{1, \\dots, N\\}$，观测数据是一个三元组 $(T_i, \\delta_i, \\mathbf{x}_i(\\cdot))$，其中 $T_i$ 是观测时间（事件时间或删失时间），$\\delta_i$ 是事件指示符，对于事件（破裂）$\\delta_i=1$，对于右删失 $\\delta_i=0$，而 $\\mathbf{x}_i(t)$ 是炮 $i$ 在时间 $t$ 的协变量向量。\n\n炮 $i$ 在时间 $t$ 的瞬时风险率 $h_i(t)$ 定义为在给定生存至时间 $t$ 的条件下，在时间 $t$ 发生事件的瞬时速率：\n$$h_i(t) = \\lim_{\\Delta t \\to 0^+} \\frac{\\mathbb{P}(T_i \\in [t, t + \\Delta t) \\mid T_i \\ge t)}{\\Delta t}$$\n生存函数 $S_i(t) = \\mathbb{P}(T_i \\ge t)$ 通过 $S_i(t) = \\exp\\left(-\\int_0^t h_i(u) \\, du\\right)$ 与风险率相关。在时间 $t$ 发生事件的概率密度函数是 $f_i(t) = h_i(t)S_i(t)$。\n\n所有 $N$ 个炮的观测数据的全似然是发生事件的炮的概率密度与被删失的炮的生存概率的乘积：\n$$ L = \\prod_{i=1}^N [f_i(T_i)]^{\\delta_i} [S_i(T_i)]^{1-\\delta_i} = \\prod_{i=1}^N [h_i(T_i)S_i(T_i)]^{\\delta_i} [S_i(T_i)]^{1-\\delta_i} = \\prod_{i=1}^N [h_i(T_i)]^{\\delta_i} S_i(T_i) $$\nCox 比例风险模型假设炮 $i$ 的风险率可以分解为一个公共的基准风险函数 $h_0(t)$ 和一个依赖于协变量的项：\n$$ h_i(t) = h_0(t) \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_i(t)\\right) $$\n将此代入全似然表达式会得到一个依赖于未知函数 $h_0(t)$ 的公式。\n\n为了消除这种依赖性，Sir David Cox 提出了使用偏似然的方法。其构造方法是考虑不同的事件时间集合，按 $t_{(1)}  t_{(2)}  \\dots  t_{(D)}$ 排序，其中 $D$ 是观测到的事件总数。在每个事件时间 $t_{(j)}$，我们定义风险集 $\\mathcal{R}(t_{(j)})$ 为所有仍有事件风险的炮 $i$ 的集合，即它们的事件或删失时间 $T_i$ 大于或等于 $t_{(j)}$：$\\mathcal{R}(t_{(j)}) = \\{i \\mid T_i \\ge t_{(j)}\\}$。\n\n设 $i_j$ 是在时间 $t_{(j)}$ 唯一发生失效的炮的索引。偏似然考虑的是在风险集 $\\mathcal{R}(t_{(j)})$ 中的所有炮中，于此时间点恰好发生一次失效的条件下，具体是炮 $i_j$ 在 $t_{(j)}$ 发生失效的条件概率。在一个小的时间区间 $[t_{(j)}, t_{(j)}+\\Delta t)$ 内，炮 $k$ 失效的概率近似为 $h_k(t_{(j)}) \\Delta t$。那么条件概率为：\n$$ \\mathbb{P}(\\text{炮 } i_j \\text{ 失效} \\mid \\text{在 } \\mathcal{R}(t_{(j)}) \\text{ 中发生一次失效}) = \\frac{h_{i_j}(t_{(j)}) \\Delta t}{\\sum_{k \\in \\mathcal{R}(t_{(j)})} h_k(t_{(j)}) \\Delta t} = \\frac{h_{i_j}(t_{(j)})}{\\sum_{k \\in \\mathcal{R}(t_{(j)})} h_k(t_{(j)})} $$\n将比例风险假设代入此表达式：\n$$ \\frac{h_0(t_{(j)}) \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_{i_j}(t_{(j)})\\right)}{\\sum_{k \\in \\mathcal{R}(t_{(j)})} h_0(t_{(j)}) \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_k(t_{(j)})\\right)} = \\frac{\\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_{i_j}(t_{(j)}^-)\\right)}{\\sum_{k \\in \\mathcal{R}(t_{(j)})} \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_k(t_{(j)}^-)\\right)} $$\n基准风险 $h_0(t_{(j)})$ 被消去。对于时变协变量，使用的值是左极限 $\\mathbf{x}_k(t_{(j)}^-)$，即事件发生前一刻的值。\n\n总偏似然 $L_p(\\boldsymbol{\\beta})$ 是在所有 $D$ 个事件时间上这些条件概率的乘积（假设事件时间没有并列）：\n$$ L_p(\\boldsymbol{\\beta}) = \\prod_{j=1}^{D} \\frac{\\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_{i_j}(t_{(j)}^-)\\right)}{\\sum_{k \\in \\mathcal{R}(t_{(j)})} \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_k(t_{(j)}^-)\\right)} $$\n偏对数似然 $\\ell_p(\\boldsymbol{\\beta})$ 是 $L_p(\\boldsymbol{\\beta})$ 的自然对数：\n$$ \\ell_p(\\boldsymbol{\\beta}) = \\ln\\left(L_p(\\boldsymbol{\\beta})\\right) = \\sum_{j=1}^{D} \\left( \\boldsymbol{\\beta}^\\top \\mathbf{x}_{i_j}(t_{(j)}^-) - \\ln\\left[\\sum_{k \\in \\mathcal{R}(t_{(j)})} \\exp\\left(\\boldsymbol{\\beta}^\\top \\mathbf{x}_k(t_{(j)}^-)\\right)\\right] \\right) $$\n如果没有事件发生（$D=0$），则求和为空，乘积是对空集的乘积，结果为 $1$。因此，$\\ell_p(\\boldsymbol{\\beta}) = \\ln(1) = 0$。\n\n计算此值的算法如下：\n1.  将每炮 $i$ 的数据表示为 $(T_i, \\delta_i, \\text{segments}_i)$，其中 $\\text{segments}_i$ 是元组 `(start_time, covariate_vector)` 的列表。\n2.  提取所有 $\\delta_i=1$ 的炮。设其事件时间为 $\\{t_{(1)}, t_{(2)}, \\dots, t_{(D)}\\}$，按升序排序。设相应的炮索引为 $\\{i_1, i_2, \\dots, i_D\\}$。\n3.  如果 $D=0$，则偏对数似然为 $0.0$。\n4.  初始化总对数似然变量 $\\ell_{total}$ 为 $0.0$。\n5.  从 $1$ 到 $D$ 遍历每个事件 $j$，其事件时间为 $t_{(j)}$，受试对象索引为 $i_j$：\n    a. 构建风险集 $\\mathcal{R}(t_{(j)}) = \\{k \\mid T_k \\ge t_{(j)}\\}$。\n    b. 对于风险集 $\\mathcal{R}(t_{(j)})$ 中的每炮 $k$，确定其在左极限时间 $t_{(j)}^-$ 的协变量向量。对于由开始时间定义的分段恒定协变量，这对应于找到炮 $k$ 的具有最大开始时间 $t_s$ 且满足 $t_s  t_{(j)}$ 的分段。\n    c. 为风险集 $\\mathcal{R}(t_{(j)})$ 中的每炮 $k$ 计算风险评分 $\\eta_k = \\boldsymbol{\\beta}^\\top \\mathbf{x}_k(t_{(j)}^-)$。\n    d. 计算风险集上风险评分指数的总和：$S_j = \\sum_{k \\in \\mathcal{R}(t_{(j)})} \\exp(\\eta_k)$。\n    e. 识别发生事件的炮的风险评分 $\\eta_{i_j}$。\n    f. 此事件对对数似然的贡献是 $\\eta_{i_j} - \\ln(S_j)$。\n    g. 将此贡献加到 $\\ell_{total}$ 上。\n6.  最终值 $\\ell_{total}$ 即为偏对数似然。所有计算均使用浮点算术和自然对数。问题指定的协变量和 $\\boldsymbol{\\beta}$ 的单位确保了 $\\boldsymbol{\\beta}^\\top \\mathbf{x}$ 项是无量纲的，从而使最终的对数似然也是无量纲的。",
            "answer": "$$\n\\boxed{[-5.572111, -7.231267, -2.484907, 0.000000, -0.513015, 0.000000]}\n$$"
        }
    ]
}