{
    "hands_on_practices": [
        {
            "introduction": "To numerically model a tokamak plasma, we must first establish a coordinate system that naturally aligns with its nested magnetic surfaces. This exercise provides foundational practice in this area by asking you to implement a mapping from abstract flux coordinates to physical cylindrical coordinates for an elliptical plasma. By calculating key geometric quantities like the metric tensor and the Jacobian, you will gain hands-on experience with the mathematical machinery essential for discretizing equations and performing calculations in a plasma-centric coordinate system, including a simple model for how external coil fields can shift the plasma's position .",
            "id": "3982360",
            "problem": "You are tasked with implementing flux-coordinate geometry for an axisymmetric free-boundary equilibrium in toroidal geometry, showing plasma–coil coupling through a coil-induced vertical magnetic field that shifts the magnetic axis. The mapping from flux coordinates to cylindrical coordinates must be used to derive metric coefficients and the Jacobian. The computations must be numerically stable across the domain, including near the magnetic axis, and must adhere to specified units.\n\nBegin from the following foundational principles appropriate to computational fusion science and engineering:\n- Maxwell’s equations imply that external coils can produce an approximately uniform vertical magnetic field in the plasma region if the coils are sufficiently far away. For a straight segment approximation with total Ampere-turns and effective length, the vertical magnetic field is taken as uniform: $$B_Z = \\mu_0 \\frac{N I}{L_{\\mathrm{eff}}},$$ where $$\\mu_0 = 4 \\pi \\times 10^{-7} \\ \\mathrm{T \\cdot m/A},$$ $$N$$ is the number of turns, $$I$$ is the coil current in $$\\mathrm{A},$$ and $$L_{\\mathrm{eff}}$$ is an effective length in $$\\mathrm{m}.$$\n- In axisymmetry, the flux surfaces can be parameterized by flux coordinates $(\\psi, \\theta, \\phi)$, where $\\psi$ is a dimensionless poloidal flux label (normalized to have $\\psi \\in [0,1]$), $\\theta$ is the poloidal angle in radians, and $\\phi$ is the toroidal angle in radians. The cylindrical coordinates $(R, Z, \\phi)$ are related to flux coordinates through a geometric mapping.\n- The plasma–coil coupling is reflected by a Shafranov-like horizontal shift of flux surfaces, modeled here by a coil-field-dependent center radius $R_c(\\psi)$.\n\nDefine the flux-surface mapping and its parameters as follows:\n- Major radius baseline: $R_0 = 3.0 \\ \\mathrm{m}.$\n- Edge minor radius: $a_{\\mathrm{edge}} = 1.0 \\ \\mathrm{m}.$\n- Elongation (vertical stretching): $\\kappa = 1.7 \\ \\text{(dimensionless)}.$\n- Coil geometry: $N = 20 \\ \\text{turns}, \\quad L_{\\mathrm{eff}} = 8.0 \\ \\mathrm{m}.$\n- Coil-induced vertical field: $B_Z(I) = \\mu_0 \\frac{N I}{L_{\\mathrm{eff}}} \\ \\mathrm{T}.$\n- Coil-induced center shift coefficient: $\\sigma = 0.2 \\ \\mathrm{m/T}.$\n- Center radius with coupling: $R_c(\\psi) = R_0 + \\sigma B_Z(I) \\, \\psi.$\n- Elliptical cross-section with minor radius profile: $a(\\psi) = a_{\\mathrm{edge}} \\sqrt{\\max(\\psi, \\varepsilon)},$ where $\\varepsilon = 10^{-6}$ is a regularization parameter to ensure numerical stability near the axis.\n- Mapping from flux coordinates to cylindrical coordinates:\n  $$R(\\psi, \\theta) = R_c(\\psi) + a(\\psi) \\cos\\theta,$$\n  $$Z(\\psi, \\theta) = \\kappa \\, a(\\psi) \\sin\\theta,$$\n  with $\\phi$ identified as the cylindrical toroidal angle.\n\nFrom this mapping, derive the covariant basis vectors $\\mathbf{e}_\\psi = \\frac{\\partial \\mathbf{r}}{\\partial \\psi}, \\ \\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{r}}{\\partial \\theta}, \\ \\mathbf{e}_\\phi = \\frac{\\partial \\mathbf{r}}{\\partial \\phi},$ where $\\mathbf{r} = R \\, \\hat{\\mathbf{e}}_R + Z \\, \\hat{\\mathbf{e}}_Z$ in cylindrical coordinates (with $\\hat{\\mathbf{e}}_R, \\hat{\\mathbf{e}}_\\phi, \\hat{\\mathbf{e}}_Z$ orthonormal). Using this, compute the covariant metric components and the Jacobian:\n- Covariant metric components:\n  $$g_{\\psi\\psi} = \\mathbf{e}_\\psi \\cdot \\mathbf{e}_\\psi = \\left(\\frac{\\partial R}{\\partial \\psi}\\right)^2 + \\left(\\frac{\\partial Z}{\\partial \\psi}\\right)^2,$$\n  $$g_{\\psi\\theta} = \\mathbf{e}_\\psi \\cdot \\mathbf{e}_\\theta = \\left(\\frac{\\partial R}{\\partial \\psi}\\right)\\left(\\frac{\\partial R}{\\partial \\theta}\\right) + \\left(\\frac{\\partial Z}{\\partial \\psi}\\right)\\left(\\frac{\\partial Z}{\\partial \\theta}\\right),$$\n  $$g_{\\theta\\theta} = \\mathbf{e}_\\theta \\cdot \\mathbf{e}_\\theta = \\left(\\frac{\\partial R}{\\partial \\theta}\\right)^2 + \\left(\\frac{\\partial Z}{\\partial \\theta}\\right)^2,$$\n  $$g_{\\phi\\phi} = \\mathbf{e}_\\phi \\cdot \\mathbf{e}_\\phi = R^2.$$\n- Jacobian for the coordinate transformation $(\\psi, \\theta, \\phi) \\mapsto (x, y, z)$:\n  $$J(\\psi, \\theta) = \\left|\\mathbf{e}_\\psi \\cdot \\left(\\mathbf{e}_\\theta \\times \\mathbf{e}_\\phi \\right)\\right|.$$\n\nExpress all angles in radians and lengths in meters. Return the Jacobian in $\\mathrm{m^3}$ and $g_{\\phi\\phi}$ in $\\mathrm{m^2}$. For numerical stability, when computing $\\frac{\\partial a}{\\partial \\psi}$ use the regularized rule\n$$\n\\frac{\\partial a}{\\partial \\psi} =\n\\begin{cases}\n\\frac{a_{\\mathrm{edge}}}{2 \\sqrt{\\psi}}, & \\psi \\ge \\varepsilon, \\\\\n\\frac{a_{\\mathrm{edge}}}{2 \\sqrt{\\varepsilon}}, & \\psi < \\varepsilon,\n\\end{cases}\n$$\nand use $\\frac{d R_c}{d \\psi} = \\sigma B_Z(I).$\n\nYour program must compute, for each test case, the pair $(J(\\psi, \\theta), \\ g_{\\phi\\phi}(\\psi, \\theta))$ and output a single line that aggregates all test case results into a comma-separated list enclosed in square brackets, ordered by test cases in the sequence given and, within each case, with $J$ first and then $g_{\\phi\\phi}$. Each float must be rounded to six decimal places.\n\nUse the following test suite, which covers a general case, a coil-on case, an edge case, and a near-axis stability case:\n1. $I = 0 \\ \\mathrm{A}, \\ \\psi = 0.25, \\ \\theta = 0 \\ \\mathrm{rad}.$\n2. $I = 50{,}000 \\ \\mathrm{A}, \\ \\psi = 0.5, \\ \\theta = \\frac{\\pi}{2} \\ \\mathrm{rad}.$\n3. $I = 100{,}000 \\ \\mathrm{A}, \\ \\psi = 1.0, \\ \\theta = \\pi \\ \\mathrm{rad}.$\n4. $I = 100{,}000 \\ \\mathrm{A}, \\ \\psi = 10^{-8}, \\ \\theta = \\frac{\\pi}{3} \\ \\mathrm{rad}.$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order:\n`[J_1, g_{\\phi\\phi,1}, J_2, g_{\\phi\\phi,2}, J_3, g_{\\phi\\phi,3}, J_4, g_{\\phi\\phi,4}],`\nwith each value rounded to six decimal places.",
            "solution": "The problem is valid as it is scientifically grounded in the principles of magnetohydrodynamics for toroidal plasmas, well-posed with a complete set of definitions and parameters, and objectively stated. It represents a standard computational exercise in fusion plasma physics.\n\nThe solution requires calculating the Jacobian $J$ of the coordinate transformation and the metric component $g_{\\phi\\phi}$ for a given geometric mapping from flux coordinates $(\\psi, \\theta, \\phi)$ to cylindrical coordinates $(R, Z, \\phi)$. The mapping models an elliptical, shifted plasma cross-section, where the shift depends on an external vertical magnetic field, thus coupling the plasma geometry to external coils.\n\nFirst, we define all constants and given functions:\n- Vacuum permeability: $\\mu_0 = 4 \\pi \\times 10^{-7} \\ \\mathrm{T \\cdot m/A}$\n- Coil parameters: $N = 20 \\ \\text{turns}, \\ L_{\\mathrm{eff}} = 8.0 \\ \\mathrm{m}$\n- Geometric parameters: $R_0 = 3.0 \\ \\mathrm{m}, \\ a_{\\mathrm{edge}} = 1.0 \\ \\mathrm{m}, \\ \\kappa = 1.7$\n- Coupling coefficient: $\\sigma = 0.2 \\ \\mathrm{m/T}$\n- Regularization parameter: $\\varepsilon = 10^{-6}$\n\nThe external vertical magnetic field $B_Z$ induced by the coils is given by:\n$$B_Z(I) = \\mu_0 \\frac{N I}{L_{\\mathrm{eff}}}$$\n\nThe flux-surface geometry is defined by the following mapping:\n$$R(\\psi, \\theta) = R_c(\\psi) + a(\\psi) \\cos\\theta$$\n$$Z(\\psi, \\theta) = \\kappa \\, a(\\psi) \\sin\\theta$$\nwhere the center radius $R_c(\\psi)$ and minor radius $a(\\psi)$ are:\n$$R_c(\\psi) = R_0 + \\sigma B_Z(I) \\, \\psi$$\n$$a(\\psi) = a_{\\mathrm{edge}} \\sqrt{\\max(\\psi, \\varepsilon)}$$\n\nTo compute the metric components and the Jacobian, we need the partial derivatives of $R$ and $Z$ with respect to $\\psi$ and $\\theta$. We first find the derivatives of $R_c(\\psi)$ and $a(\\psi)$ with respect to $\\psi$.\n$$ \\frac{dR_c}{d\\psi} = \\sigma B_Z(I) $$\nThe derivative of the minor radius, $a'(\\psi) = \\frac{da}{d\\psi}$, is given by the regularized, piecewise formula:\n$$\na'(\\psi) = \\frac{da}{d\\psi} =\n\\begin{cases}\n\\frac{a_{\\mathrm{edge}}}{2 \\sqrt{\\psi}}, & \\text{if } \\psi \\ge \\varepsilon \\\\\n\\frac{a_{\\mathrm{edge}}}{2 \\sqrt{\\varepsilon}}, & \\text{if } \\psi < \\varepsilon\n\\end{cases}\n$$\n\nUsing the chain rule, we find the partial derivatives of the cylindrical coordinates:\n$$ \\frac{\\partial R}{\\partial \\psi} = \\frac{dR_c}{d\\psi} + \\frac{da}{d\\psi}\\cos\\theta = \\sigma B_Z(I) + a'(\\psi)\\cos\\theta $$\n$$ \\frac{\\partial R}{\\partial \\theta} = -a(\\psi)\\sin\\theta $$\n$$ \\frac{\\partial Z}{\\partial \\psi} = \\kappa \\frac{da}{d\\psi}\\sin\\theta = \\kappa a'(\\psi)\\sin\\theta $$\n$$ \\frac{\\partial Z}{\\partial \\theta} = \\kappa a(\\psi)\\cos\\theta $$\n\nThe metric component $g_{\\phi\\phi}$ is defined as the square of the major radius $R$:\n$$ g_{\\phi\\phi}(\\psi, \\theta) = R(\\psi, \\theta)^2 = (R_c(\\psi) + a(\\psi)\\cos\\theta)^2 $$\n\nThe Jacobian of the transformation from $(\\psi, \\theta, \\phi)$ to Cartesian coordinates is given by $J = \\left|\\det\\left(\\frac{\\partial(x,y,z)}{\\partial(\\psi,\\theta,\\phi)}\\right)\\right|$. In an axisymmetric cylindrical system, this simplifies to $J = R \\left| \\frac{\\partial R}{\\partial \\psi} \\frac{\\partial Z}{\\partial \\theta} - \\frac{\\partial R}{\\partial \\theta} \\frac{\\partial Z}{\\partial \\psi} \\right|$. Let's compute the determinant term:\n$$ \\mathcal{J}_{2D} = \\frac{\\partial R}{\\partial \\psi} \\frac{\\partial Z}{\\partial \\theta} - \\frac{\\partial R}{\\partial \\theta} \\frac{\\partial Z}{\\partial \\psi} $$\n$$ = (\\sigma B_Z(I) + a'(\\psi)\\cos\\theta)(\\kappa a(\\psi)\\cos\\theta) - (-a(\\psi)\\sin\\theta)(\\kappa a'(\\psi)\\sin\\theta) $$\n$$ = \\kappa a(\\psi)\\sigma B_Z(I)\\cos\\theta + \\kappa a(\\psi)a'(\\psi)\\cos^2\\theta + \\kappa a(\\psi)a'(\\psi)\\sin^2\\theta $$\n$$ = \\kappa a(\\psi)\\sigma B_Z(I)\\cos\\theta + \\kappa a(\\psi)a'(\\psi)(\\cos^2\\theta + \\sin^2\\theta) $$\n$$ = \\kappa a(\\psi) (a'(\\psi) + \\sigma B_Z(I)\\cos\\theta) $$\nThe full Jacobian $J$ is then:\n$$ J(\\psi, \\theta) = R(\\psi, \\theta) |\\mathcal{J}_{2D}| = R(\\psi, \\theta) \\left| \\kappa a(\\psi) (a'(\\psi) + \\sigma B_Z(I)\\cos\\theta) \\right| $$\nFor typical physical parameters, the term inside the absolute value is positive, so we can write:\n$$ J(\\psi, \\theta) = \\kappa R(\\psi, \\theta) a(\\psi) (a'(\\psi) + \\sigma B_Z(I)\\cos\\theta) $$\n\nThese derived formulae are implemented numerically for each test case.\n- For Test Case 1: $I=0$. The system has no coil-induced shift. $B_Z=0$, so $R_c(\\psi) = R_0$. Jacobian simplifies to $J=\\kappa R a a'$.\n- For Test Case 2: $I=50 \\ \\mathrm{kA}$. A moderate vertical field is applied, causing a $\\psi$-dependent shift. Since $\\theta=\\pi/2$, $\\cos\\theta=0$, which simplifies calculations for $R$ and $J$.\n- For Test Case 3: $I=100 \\ \\mathrm{kA}$. A larger field is applied at the plasma edge ($\\psi=1$) and on the inboard side ($\\theta=\\pi$), where the shift has the largest effect on decreasing the major radius.\n- For Test Case 4: $I=100 \\ \\mathrm{kA}$. This tests the numerical stability near the magnetic axis ($\\psi \\to 0$). Since $\\psi = 10^{-8} < \\varepsilon$, the regularized formulas for $a(\\psi)$ and $a'(\\psi)$ are invoked to prevent division by zero and maintain well-behaved geometric quantities.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the Jacobian and g_phiphi metric component for a set of test cases\n    based on a model of flux-coordinate geometry for an axisymmetric toroidal plasma.\n    \"\"\"\n\n    # Define physical and geometric constants from the problem statement.\n    MU_0 = 4 * np.pi * 1e-7  # T*m/A\n    R0 = 3.0  # m\n    A_EDGE = 1.0  # m\n    KAPPA = 1.7  # dimensionless\n    N_TURNS = 20.0\n    L_EFF = 8.0  # m\n    SIGMA = 0.2  # m/T\n    EPSILON = 1e-6  # Regularization parameter\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (I [A], psi [dimless], theta [rad])\n        (0.0, 0.25, 0.0),\n        (50000.0, 0.5, np.pi / 2),\n        (100000.0, 1.0, np.pi),\n        (100000.0, 1e-8, np.pi / 3),\n    ]\n\n    results = []\n    for i_val, psi, theta in test_cases:\n        # Step 1: Calculate the coil-induced vertical magnetic field.\n        b_z = MU_0 * (N_TURNS * i_val) / L_EFF\n\n        # Step 2: Calculate psi-dependent geometric quantities with regularization.\n        psi_eff = max(psi, EPSILON)\n        a_psi = A_EDGE * np.sqrt(psi_eff)\n        \n        if psi >= EPSILON:\n            a_prime_psi = A_EDGE / (2 * np.sqrt(psi))\n        else:\n            a_prime_psi = A_EDGE / (2 * np.sqrt(EPSILON))\n\n        # Step 3: Calculate the center radius with plasma-coil coupling.\n        r_c_psi = R0 + SIGMA * b_z * psi\n\n        # Step 4: Compute the mapping to cylindrical coordinates.\n        cos_theta = np.cos(theta)\n        r_psi_theta = r_c_psi + a_psi * cos_theta\n\n        # Step 5: Compute the required metric component g_phiphi.\n        g_phiphi = r_psi_theta**2\n\n        # Step 6: Compute the Jacobian of the transformation.\n        # J = kappa * R * a * (a' + sigma * B_Z * cos(theta))\n        jacobian = KAPPA * r_psi_theta * a_psi * (a_prime_psi + SIGMA * b_z * cos_theta)\n\n        # Step 7: Append results, formatted to six decimal places.\n        results.append(f\"{jacobian:.6f}\")\n        results.append(f\"{g_phiphi:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Having established a way to describe plasma geometry, the next step is to solve for the magnetic equilibrium itself. This practice guides you through the process of numerically solving the Grad–Shafranov equation, the master equation for axisymmetric magnetohydrodynamic equilibrium, using the finite difference method on a rectangular grid. You will implement the core components of a free-boundary solver, learning how to represent both distributed plasma currents and localized external coil currents as sources in a partial differential equation, and how to extract physical quantities like the total plasma current from the solution .",
            "id": "3982361",
            "problem": "A free-boundary axisymmetric equilibrium in a Tokamak is governed by magnetostatic laws and force balance. Under axisymmetry, define the poloidal flux function $\\psi(R,Z)$ such that the poloidal magnetic field components satisfy $B_R = -\\frac{1}{R}\\frac{\\partial \\psi}{\\partial Z}$ and $B_Z = \\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}$, where $R$ is the cylindrical radius and $Z$ is the vertical coordinate. The axisymmetric toroidal current density $j_\\phi$ is related to the flux function by Ampère’s law, $\\nabla \\times \\mathbf{B} = \\mu_0 \\mathbf{j}$, giving $j_\\phi = -\\frac{1}{\\mu_0 R}\\Delta^* \\psi$, where the elliptic operator $\\Delta^*$ is defined by\n$$\n\\Delta^* \\psi \\equiv R \\frac{\\partial}{\\partial R}\\left(\\frac{1}{R} \\frac{\\partial \\psi}{\\partial R}\\right) + \\frac{\\partial^2 \\psi}{\\partial Z^2} = \\frac{\\partial^2 \\psi}{\\partial R^2} - \\frac{1}{R} \\frac{\\partial \\psi}{\\partial R} + \\frac{\\partial^2 \\psi}{\\partial Z^2}.\n$$\nIn the plasma region, force balance $\\mathbf{j} \\times \\mathbf{B} = \\nabla p$ combined with axisymmetry yields the Grad–Shafranov equation (GSE),\n$$\n\\Delta^* \\psi = -\\mu_0 R^2 \\frac{dp}{d\\psi} - F(\\psi) \\frac{dF}{d\\psi},\n$$\nwhere $p(\\psi)$ is the pressure profile and $F(\\psi) \\equiv R B_\\phi$ encodes the toroidal field contribution. External poloidal field coils are represented as toroidal current distributions $j_{\\phi,\\text{coil}}(R,Z)$ that couple to the plasma through Maxwell’s equations and contribute directly to $\\Delta^* \\psi$. In a free-boundary computation that includes coils within the computational domain, one may superpose coil currents and plasma currents via\n$$\n\\Delta^* \\psi = -\\mu_0 R j_{\\phi,\\text{coil}}(R,Z) - \\mu_0 R^2 \\frac{dp}{d\\psi} - F(\\psi) \\frac{dF}{d\\psi},\n$$\nand then recover $j_\\phi$ consistently from $\\psi$.\n\nUsing only the fundamental relations above, derive a finite difference discretization of the operator $\\Delta^*$ on a uniform rectangular grid and assemble a linear system for the unknown nodal values of $\\psi$ with homogeneous Dirichlet boundary conditions $\\psi=0$ on the boundary. Treat the coils as localized toroidal current densities modeled by normalized Gaussian rings centered at coil locations. Specifically, for a coil located at $(R_0,Z_0)$ with total current $I$, approximate its toroidal current density by\n$$\nj_{\\phi,\\text{coil}}(R,Z) = I \\, g(R,Z), \\quad g(R,Z) = \\frac{1}{2\\pi \\sigma_R \\sigma_Z} \\exp\\left(-\\frac{(R-R_0)^2}{2\\sigma_R^2} - \\frac{(Z-Z_0)^2}{2\\sigma_Z^2}\\right),\n$$\nand renormalize $g$ numerically on the discrete grid so that $\\int g\\, dR\\, dZ = 1$ holds to machine precision within the computational domain. Assume a simple plasma model with $F(\\psi) = F_0$ constant so that $\\frac{dF}{d\\psi} = 0$, and take $\\frac{dp}{d\\psi} = p'_0$ constant inside a prescribed elliptical plasma region and zero outside it. The computational domain and parameters are as follows:\n\n- Domain: $R \\in [1.0,3.0]$ meters and $Z \\in [-1.0,1.0]$ meters, uniformly discretized on $N_R = 81$ and $N_Z = 81$ nodes.\n- Permeability of free space: $\\mu_0 = 4\\pi \\times 10^{-7}$ henry per meter.\n- Coil Gaussian widths: $\\sigma_R = 0.02$ meters and $\\sigma_Z = 0.02$ meters.\n- Plasma region: an ellipse centered at $(R_c,Z_c)$ with semi-axes $a_R$ and $a_Z$, defined by points satisfying $(\\frac{R-R_c}{a_R})^2 + (\\frac{Z-Z_c}{a_Z})^2 \\le 1$.\n- Pressure gradient: $\\frac{dp}{d\\psi} = p'_0$ (units of pascal per weber), constant inside the plasma ellipse and zero outside.\n- Toroidal field function: $F(\\psi) = F_0$ with $\\frac{dF}{d\\psi} = 0$.\n\nTasks:\n\n1. Starting from the definition of $\\Delta^*$, derive a second-order accurate finite difference stencil on the uniform grid for interior nodes. Assemble the sparse linear system $\\mathbf{A}\\mathbf{\\Psi}=\\mathbf{b}$, where $\\mathbf{\\Psi}$ are the interior nodal values of $\\psi$, with homogeneous Dirichlet boundary conditions.\n2. Construct $j_{\\phi,\\text{coil}}(R,Z)$ on the grid as the sum of renormalized Gaussian rings for each coil, and construct the right-hand side source $S(R,Z) = -\\mu_0 R j_{\\phi,\\text{coil}}(R,Z) - \\mu_0 R^2 p'_0 \\chi_{\\text{plasma}}(R,Z)$, where $\\chi_{\\text{plasma}}$ is the indicator function of the plasma ellipse.\n3. Solve the linear system for $\\psi$, compute the discrete residual $\\mathcal{R} = \\Delta^* \\psi - S$ on interior nodes using the same stencil, and report the maximum absolute residual value in units of webers per meter squared.\n4. Compute the plasma toroidal current $I_p$ by integrating $j_{\\phi,\\text{plasma}}(R,Z) = -\\frac{1}{\\mu_0 R}\\Delta^* \\psi(R,Z) - j_{\\phi,\\text{coil}}(R,Z)$ over the plasma region. Report $I_p$ in amperes.\n\nDesign a program that performs the above steps for the following test suite, covering a range of plasma–coil coupling scenarios:\n\n- Test case $1$ (general case): $p'_0 = -1.0\\times 10^6$ pascal per weber, plasma ellipse with $R_c = 2.0$ meters, $Z_c = 0.0$ meters, $a_R = 0.5$ meters, $a_Z = 0.3$ meters, one coil at $R_0 = 3.0$ meters, $Z_0 = 0.6$ meters, $I = 1.0 \\times 10^6$ amperes.\n- Test case $2$ (symmetric coils): same plasma as test case $1$, two coils at $(R_0,Z_0) = (3.0,0.6)$ and $(R_0,Z_0) = (3.0,-0.6)$, each with $I = 1.0 \\times 10^6$ amperes.\n- Test case $3$ (vacuum limit): $p'_0 = 0.0$, no plasma (set $a_R = 0.0$ and $a_Z = 0.0$ so that $\\chi_{\\text{plasma}}=0$ everywhere), two coils at $(R_0,Z_0) = (3.0,0.6)$ and $(R_0,Z_0) = (3.0,-0.6)$, each with $I = 1.0 \\times 10^6$ amperes.\n- Test case $4$ (edge case with tiny plasma): $p'_0 = -2.0\\times 10^6$ pascal per weber, plasma ellipse with $R_c = 2.0$ meters, $Z_c = 0.0$ meters, $a_R = 0.15$ meters, $a_Z = 0.10$ meters, two coils at $(R_0,Z_0) = (3.0,0.6)$ and $(R_0,Z_0) = (3.0,-0.6)$, each with $I = 0.5 \\times 10^6$ amperes.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each test case contributing a two-element list $[\\text{residual\\_max}, I_p]$ in the order of the test suite. The first element must be the maximum absolute residual in webers per meter squared and the second element must be the plasma current in amperes. For example, the output format must be like `[[r_1,i_1],[r_2,i_2],[r_3,i_3],[r_4,i_4]]` with numeric values substituted.",
            "solution": "The derivation begins from magnetostatics and axisymmetry. With the poloidal flux function $\\psi(R,Z)$ defined such that $B_R = -\\frac{1}{R}\\frac{\\partial \\psi}{\\partial Z}$ and $B_Z = \\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}$, the toroidal component of the curl of $\\mathbf{B}$ is\n$$\n(\\nabla \\times \\mathbf{B})_\\phi = \\frac{\\partial B_R}{\\partial Z} - \\frac{\\partial B_Z}{\\partial R}.\n$$\nUsing the axisymmetric expressions for $B_R$ and $B_Z$, compute each derivative:\n$$\n\\frac{\\partial B_R}{\\partial Z} = \\frac{\\partial}{\\partial Z}\\left(-\\frac{1}{R}\\frac{\\partial \\psi}{\\partial Z}\\right) = -\\frac{1}{R} \\frac{\\partial^2 \\psi}{\\partial Z^2},\n$$\n$$\n\\frac{\\partial B_Z}{\\partial R} = \\frac{\\partial}{\\partial R}\\left(\\frac{1}{R}\\frac{\\partial \\psi}{\\partial R}\\right) = -\\frac{1}{R^2}\\frac{\\partial \\psi}{\\partial R} + \\frac{1}{R}\\frac{\\partial^2 \\psi}{\\partial R^2}.\n$$\nTherefore,\n$$\n(\\nabla \\times \\mathbf{B})_\\phi = -\\frac{1}{R}\\frac{\\partial^2 \\psi}{\\partial Z^2} - \\left(-\\frac{1}{R^2}\\frac{\\partial \\psi}{\\partial R} + \\frac{1}{R}\\frac{\\partial^2 \\psi}{\\partial R^2}\\right) = -\\frac{1}{R}\\left(\\frac{\\partial^2 \\psi}{\\partial R^2} - \\frac{1}{R}\\frac{\\partial \\psi}{\\partial R} + \\frac{\\partial^2 \\psi}{\\partial Z^2}\\right) = -\\frac{1}{R}\\Delta^* \\psi.\n$$\nAmpère’s law $\\nabla \\times \\mathbf{B} = \\mu_0 \\mathbf{j}$ then yields $j_\\phi = \\frac{1}{\\mu_0}(\\nabla \\times \\mathbf{B})_\\phi = -\\frac{1}{\\mu_0 R}\\Delta^* \\psi$. In a plasma region with pressure $p(\\psi)$ and toroidal field function $F(\\psi) \\equiv R B_\\phi$, force balance $\\mathbf{j} \\times \\mathbf{B} = \\nabla p$ implies the Grad–Shafranov equation\n$$\n\\Delta^* \\psi = -\\mu_0 R^2 \\frac{dp}{d\\psi} - F(\\psi) \\frac{dF}{d\\psi}.\n$$\nWhen external toroidal coil currents $j_{\\phi,\\text{coil}}(R,Z)$ are present alongside plasma currents, Maxwell’s relation adds them linearly to the source of $\\Delta^* \\psi$ since $\\Delta^* \\psi = - \\mu_0 R j_\\phi.$ With $F(\\psi) = F_0$ constant so $\\frac{dF}{d\\psi} = 0$, one obtains the computationally convenient form\n$$\n\\Delta^* \\psi = -\\mu_0 R j_{\\phi,\\text{coil}}(R,Z) - \\mu_0 R^2 \\frac{dp}{d\\psi}.\n$$\n\nDiscretization follows from the definition of $\\Delta^*$. On a uniform grid with $R$ spacing $\\Delta R$ and $Z$ spacing $\\Delta Z$, for an interior node at $(R_i,Z_j)$, approximate derivatives by second-order central differences:\n$$\n\\frac{\\partial^2 \\psi}{\\partial R^2}\\bigg|_{i,j} \\approx \\frac{\\psi_{i+1,j} - 2\\psi_{i,j} + \\psi_{i-1,j}}{\\Delta R^2},\n\\quad\n\\frac{\\partial \\psi}{\\partial R}\\bigg|_{i,j} \\approx \\frac{\\psi_{i+1,j} - \\psi_{i-1,j}}{2\\Delta R},\n$$\n$$\n\\frac{\\partial^2 \\psi}{\\partial Z^2}\\bigg|_{i,j} \\approx \\frac{\\psi_{i,j+1} - 2\\psi_{i,j} + \\psi_{i,j-1}}{\\Delta Z^2}.\n$$\nInserting these into $\\Delta^* \\psi = \\frac{\\partial^2 \\psi}{\\partial R^2} - \\frac{1}{R}\\frac{\\partial \\psi}{\\partial R} + \\frac{\\partial^2 \\psi}{\\partial Z^2}$ at $R=R_i$ yields a linear stencil:\n$$\n\\Delta^* \\psi\\big|_{i,j} \\approx \\left(\\frac{1}{\\Delta R^2} - \\frac{1}{2 R_i \\Delta R}\\right)\\psi_{i+1,j} + \\left(\\frac{1}{\\Delta R^2} + \\frac{1}{2 R_i \\Delta R}\\right)\\psi_{i-1,j} + \\frac{1}{\\Delta Z^2}\\psi_{i,j+1} + \\frac{1}{\\Delta Z^2}\\psi_{i,j-1} - \\left(\\frac{2}{\\Delta R^2} + \\frac{2}{\\Delta Z^2}\\right)\\psi_{i,j}.\n$$\nHomogeneous Dirichlet boundary conditions $\\psi=0$ on the domain boundary allow eliminating boundary nodes from the unknown vector and assembling a sparse matrix $\\mathbf{A}$ representing the stencil at interior nodes. For each interior node, coefficients multiply the unknowns at neighboring interior nodes; neighbors on the boundary contribute known values equal to zero and thus do not alter the right-hand side. The source term at each interior node is $S_{i,j} = -\\mu_0 R_i j_{\\phi,\\text{coil}}(R_i,Z_j) - \\mu_0 R_i^2 p'_0 \\chi_{\\text{plasma}}(R_i,Z_j)$.\n\nThe coil model $j_{\\phi,\\text{coil}}$ uses Gaussian rings. For each coil at $(R_0,Z_0)$ with current $I$, define\n$$\ng(R,Z) = \\frac{1}{2\\pi \\sigma_R \\sigma_Z} \\exp\\left(-\\frac{(R-R_0)^2}{2\\sigma_R^2} - \\frac{(Z-Z_0)^2}{2\\sigma_Z^2}\\right).\n$$\nTo ensure $\\int g\\, dR\\, dZ = 1$ on the discrete grid, compute the discrete sum $G = \\sum_{i,j} g(R_i,Z_j) \\Delta R \\Delta Z$ and renormalize $\\tilde{g} = g/G$. The coil current density contribution is then $j_{\\phi,\\text{coil}} = I \\tilde{g}$, and when multiple coils are present, superpose $j_{\\phi,\\text{coil}} = \\sum_k I_k \\tilde{g}_k$.\n\nSolving the linear system $\\mathbf{A}\\mathbf{\\Psi}=\\mathbf{b}$ with a sparse direct solver yields the interior values of $\\psi$. The discrete residual is computed by applying the same finite difference stencil to the full grid (with boundary zeros) and subtracting the source $S$:\n$$\n\\mathcal{R}_{i,j} = (\\Delta^* \\psi)_{i,j}^{\\text{disc}} - S_{i,j}.\n$$\nThe maximum norm $\\max_{i,j} |\\mathcal{R}_{i,j}|$ is reported in webers per meter squared. The plasma toroidal current density is extracted from the solution by subtracting coil contributions using Ampère’s relation:\n$$\nj_{\\phi,\\text{plasma}}(R_i,Z_j) = -\\frac{1}{\\mu_0 R_i}(\\Delta^* \\psi)_{i,j}^{\\text{disc}} - j_{\\phi,\\text{coil}}(R_i,Z_j),\n$$\nand integrating over the plasma ellipse:\n$$\nI_p = \\sum_{i,j \\in \\text{plasma}} j_{\\phi,\\text{plasma}}(R_i,Z_j) \\Delta R \\Delta Z.\n$$\n\nAlgorithmic steps implemented by the program:\n\n- Construct uniform grids in $R$ and $Z$ with $N_R = 81$ and $N_Z = 81$ on the specified domain, compute $\\Delta R$ and $\\Delta Z$.\n- Build the sparse matrix $\\mathbf{A}$ using the derived stencil coefficients, mapping each interior node $(i,j)$ to a linear index.\n- For each test case:\n  - Form the plasma indicator $\\chi_{\\text{plasma}}$ from the ellipse definition using provided $R_c$, $Z_c$, $a_R$, $a_Z$.\n  - Assemble $j_{\\phi,\\text{coil}}$ by summing renormalized Gaussian rings for all coils.\n  - Form $S$ from $j_{\\phi,\\text{coil}}$ and $p'_0$.\n  - Solve $\\mathbf{A}\\mathbf{\\Psi}=\\mathbf{b}$ for $\\psi$.\n  - Compute the discrete residual $\\mathcal{R}$ and its maximum absolute value.\n  - Compute $j_{\\phi,\\text{plasma}}$ from $\\psi$ and integrate over the plasma region to obtain $I_p$.\n- Produce a single-line output `[[r_1,i_1],[r_2,i_2],[r_3,i_3],[r_4,i_4]]` where $r_k$ is in webers per meter squared and $i_k$ is in amperes.\n\nThis construction is principle-based: the operator $\\Delta^*$ originates from magnetostatics and the discretization uses second-order accurate finite differences consistent with the operator’s $R$-dependent term. Coil–plasma coupling enters through superposition in the source term using $j_{\\phi,\\text{coil}}$ derived from a physically plausible localized current density. The plasma current is extracted consistently from the solved $\\psi$ via Ampère’s relation, subtracting coil contributions to isolate the plasma component.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.sparse import coo_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef build_grid(R_min, R_max, Z_min, Z_max, NR, NZ):\n    R = np.linspace(R_min, R_max, NR)\n    Z = np.linspace(Z_min, Z_max, NZ)\n    dR = (R_max - R_min) / (NR - 1)\n    dZ = (Z_max - Z_min) / (NZ - 1)\n    return R, Z, dR, dZ\n\ndef interior_index(i, j, NZ_interior):\n    # Map interior grid (i in [1..NR-2], j in [1..NZ-2]) to linear index\n    return (i - 1) * NZ_interior + (j - 1)\n\ndef build_delta_star_matrix(R, dR, dZ):\n    # This function is not used in the final code but left for structural consistency.\n    pass\n\ndef assemble_matrix(R, dR, dZ, NR, NZ):\n    # Build sparse matrix for interior nodes\n    NZ_interior = NZ - 2\n    N_interior = (NR - 2) * (NZ - 2)\n    rows = []\n    cols = []\n    data = []\n\n    inv_dR2 = 1.0 / (dR * dR)\n    inv_dZ2 = 1.0 / (dZ * dZ)\n\n    for i in range(1, NR - 1):\n        Ri = R[i]\n        for j in range(1, NZ - 1):\n            idx = interior_index(i, j, NZ_interior)\n            # Coefficients based on stencil:\n            coeff_center = -(2.0 * inv_dR2 + 2.0 * inv_dZ2)\n            coeff_Rp = inv_dR2 - (1.0 / (2.0 * Ri * dR))\n            coeff_Rm = inv_dR2 + (1.0 / (2.0 * Ri * dR))\n            coeff_Zp = inv_dZ2\n            coeff_Zm = inv_dZ2\n\n            # Center\n            rows.append(idx); cols.append(idx); data.append(coeff_center)\n\n            # i+1,j neighbor\n            if i + 1 <= NR - 2:\n                id_n = interior_index(i + 1, j, NZ_interior)\n                rows.append(idx); cols.append(id_n); data.append(coeff_Rp)\n            # i-1,j neighbor\n            if i - 1 >= 1:\n                id_n = interior_index(i - 1, j, NZ_interior)\n                rows.append(idx); cols.append(id_n); data.append(coeff_Rm)\n            # i,j+1 neighbor\n            if j + 1 <= NZ - 2:\n                id_n = interior_index(i, j + 1, NZ_interior)\n                rows.append(idx); cols.append(id_n); data.append(coeff_Zp)\n            # i,j-1 neighbor\n            if j - 1 >= 1:\n                id_n = interior_index(i, j - 1, NZ_interior)\n                rows.append(idx); cols.append(id_n); data.append(coeff_Zm)\n\n    A = coo_matrix((data, (rows, cols)), shape=(N_interior, N_interior)).tocsr()\n    return A\n\ndef apply_delta_star_disc(psi, R, dR, dZ):\n    # Apply discrete Delta* operator to full grid psi (including boundary), return interior values array\n    NR = psi.shape[0]\n    NZ = psi.shape[1]\n    inv_dR2 = 1.0 / (dR * dR)\n    inv_dZ2 = 1.0 / (dZ * dZ)\n    NZ_interior = NZ - 2\n    result = np.zeros(((NR - 2) * (NZ - 2),), dtype=float)\n    for i in range(1, NR - 1):\n        Ri = R[i]\n        for j in range(1, NZ - 1):\n            idx = interior_index(i, j, NZ_interior)\n            term_R2 = (psi[i + 1, j] - 2.0 * psi[i, j] + psi[i - 1, j]) * inv_dR2\n            term_Z2 = (psi[i, j + 1] - 2.0 * psi[i, j] + psi[i, j - 1]) * inv_dZ2\n            term_R1 = (psi[i + 1, j] - psi[i - 1, j]) / (2.0 * dR)\n            result[idx] = term_R2 - (1.0 / Ri) * term_R1 + term_Z2\n    return result\n\ndef gaussian_ring(R, Z, R0, Z0, sigR, sigZ):\n    # Evaluate unnormalized Gaussian ring on grid\n    RR = R[:, None]\n    ZZ = Z[None, :]\n    g = np.exp(-0.5 * ((RR - R0) ** 2 / (sigR ** 2) + (ZZ - Z0) ** 2 / (sigZ ** 2)))\n    # Prefactor 1/(2*pi*sigR*sigZ) for proper normalization in continuous plane\n    g *= (1.0 / (2.0 * np.pi * sigR * sigZ))\n    return g\n\ndef normalize_on_grid(g, dR, dZ):\n    total = np.sum(g) * dR * dZ\n    if total <= 0.0:\n        return g\n    return g / total\n\ndef build_coil_current_density(R, Z, dR, dZ, coils, sigR, sigZ):\n    # coils: list of (R0, Z0, I)\n    j = np.zeros((len(R), len(Z)), dtype=float)\n    for (R0, Z0, I) in coils:\n        g = gaussian_ring(R, Z, R0, Z0, sigR, sigZ)\n        g_norm = normalize_on_grid(g, dR, dZ)\n        j += I * g_norm\n    return j\n\ndef plasma_indicator(R, Z, Rc, Zc, aR, aZ):\n    # Ellipse indicator\n    RR = R[:, None]\n    ZZ = Z[None, :]\n    if aR <= 0.0 or aZ <= 0.0:\n        return np.zeros((len(R), len(Z)), dtype=float)\n    val = ((RR - Rc) / aR) ** 2 + ((ZZ - Zc) / aZ) ** 2\n    return (val <= 1.0).astype(float)\n\ndef solve_case(params, grid, A):\n    R, Z, dR, dZ = grid\n    NR = len(R); NZ = len(Z)\n    NZ_interior = NZ - 2\n    mu0 = 4.0 * np.pi * 1e-7  # H/m\n\n    # Unpack params\n    pprime = params['pprime']\n    Rc, Zc = params['plasma_center']\n    aR, aZ = params['plasma_axes']\n    coils = params['coils']\n    sigR = params['sigma_R']\n    sigZ = params['sigma_Z']\n\n    # Build source terms\n    chi = plasma_indicator(R, Z, Rc, Zc, aR, aZ)\n    jcoil = build_coil_current_density(R, Z, dR, dZ, coils, sigR, sigZ)\n    # S = -mu0 * R * jcoil - mu0 * R^2 * pprime * chi\n    RR = R[:, None]\n    S = -mu0 * RR * jcoil - mu0 * (RR ** 2) * pprime * chi\n\n    # Right-hand side vector b for interior nodes\n    b = np.zeros(((NR - 2) * (NZ - 2),), dtype=float)\n    for i in range(1, NR - 1):\n        for j in range(1, NZ - 1):\n            idx = interior_index(i, j, NZ_interior)\n            b[idx] = S[i, j]\n\n    # Solve A psi_interior = b\n    psi_interior = spsolve(A, b)\n\n    # Assemble full psi grid with boundary zeros\n    psi = np.zeros((NR, NZ), dtype=float)\n    for i in range(1, NR - 1):\n        for j in range(1, NZ - 1):\n            idx = interior_index(i, j, NZ_interior)\n            psi[i, j] = psi_interior[idx]\n\n    # Compute discrete residual on interior: R_disc = Delta* psi - S\n    Lpsi_interior = apply_delta_star_disc(psi, R, dR, dZ)\n    residual_interior = Lpsi_interior - b  # since b = S at interior\n    residual_max = float(np.max(np.abs(residual_interior)))\n\n    # Compute j_phi_plasma from solution: j_plasma = -(1/(mu0 R)) Delta*psi - jcoil\n    # First, reconstruct Delta*psi on full grid interior values in array form\n    # Map Lpsi_interior back to grid\n    Lpsi_grid = np.zeros((NR, NZ), dtype=float)\n    for i in range(1, NR - 1):\n        for j in range(1, NZ - 1):\n            idx = interior_index(i, j, NZ_interior)\n            Lpsi_grid[i, j] = Lpsi_interior[idx]\n    j_plasma = np.zeros_like(Lpsi_grid)\n    # Avoid divide by zero at R=0 (not in domain)\n    j_plasma[1:NR-1, 1:NZ-1] = -(1.0 / (mu0 * RR[1:NR-1, 0][:, None])) * Lpsi_grid[1:NR-1, 1:NZ-1] - jcoil[1:NR-1, 1:NZ-1]\n    # Integrate over plasma region to get Ip\n    Ip = float(np.sum(j_plasma * chi) * dR * dZ)\n\n    return residual_max, Ip\n\ndef solve():\n    # Define grid and matrix\n    R_min, R_max = 1.0, 3.0\n    Z_min, Z_max = -1.0, 1.0\n    NR, NZ = 81, 81\n    R, Z, dR, dZ = build_grid(R_min, R_max, Z_min, Z_max, NR, NZ)\n    A = assemble_matrix(R, dR, dZ, NR, NZ)\n\n    # Define test cases\n    test_cases = [\n        # Test case 1\n        {\n            'pprime': -1.0e6,  # Pa/Wb\n            'plasma_center': (2.0, 0.0),\n            'plasma_axes': (0.5, 0.3),\n            'coils': [(3.0, 0.6, 1.0e6)],\n            'sigma_R': 0.02,\n            'sigma_Z': 0.02\n        },\n        # Test case 2\n        {\n            'pprime': -1.0e6,\n            'plasma_center': (2.0, 0.0),\n            'plasma_axes': (0.5, 0.3),\n            'coils': [(3.0, 0.6, 1.0e6), (3.0, -0.6, 1.0e6)],\n            'sigma_R': 0.02,\n            'sigma_Z': 0.02\n        },\n        # Test case 3 (vacuum, no plasma)\n        {\n            'pprime': 0.0,\n            'plasma_center': (2.0, 0.0),\n            'plasma_axes': (0.0, 0.0),  # no plasma\n            'coils': [(3.0, 0.6, 1.0e6), (3.0, -0.6, 1.0e6)],\n            'sigma_R': 0.02,\n            'sigma_Z': 0.02\n        },\n        # Test case 4 (tiny plasma)\n        {\n            'pprime': -2.0e6,\n            'plasma_center': (2.0, 0.0),\n            'plasma_axes': (0.15, 0.10),\n            'coils': [(3.0, 0.6, 0.5e6), (3.0, -0.6, 0.5e6)],\n            'sigma_R': 0.02,\n            'sigma_Z': 0.02\n        }\n    ]\n\n    grid = (R, Z, dR, dZ)\n    results = []\n    for case in test_cases:\n        residual_max, Ip = solve_case(case, grid, A)\n        results.append([residual_max, Ip])\n\n    # Final print statement in the exact required format.\n    # Ensure simple float string formatting without extra text\n    def format_list(lst):\n        return \"[\" + \",\".join(str(x) if not isinstance(x, list) else format_list(x) for x in lst) + \"]\"\n    print(format_list(results))\n\nsolve()\n```"
        },
        {
            "introduction": "While discretizing the entire domain is a straightforward way to solve for equilibrium, it can be computationally intensive, especially in the vast vacuum region where the physics is simpler. This practice introduces a more advanced and efficient concept central to modern equilibrium solvers: the boundary integral method. By focusing on the vacuum region governed by Laplace's equation, you will derive and analyze the Dirichlet-to-Neumann map, an operator that encapsulates the entire vacuum response into a relationship between quantities on the plasma-vacuum boundary, providing a powerful alternative to domain-filling grids .",
            "id": "3982367",
            "problem": "A circular plasma boundary in an axisymmetric free-boundary equilibrium is surrounded by a current-free vacuum region in which the magnetic field lines are governed by magnetostatics. In the vacuum region, starting from Maxwell’s equations of magnetostatics, the magnetic field $\\boldsymbol{B}$ obeys $\\nabla \\cdot \\boldsymbol{B} = 0$ and $\\nabla \\times \\boldsymbol{B} = \\mu_0 \\boldsymbol{J}$, where $\\mu_0$ is the vacuum permeability and $\\boldsymbol{J}$ is the current density. In the exterior vacuum region, where $\\boldsymbol{J} = \\boldsymbol{0}$, it follows that $\\nabla \\times \\boldsymbol{B} = \\boldsymbol{0}$ and $\\nabla \\cdot \\boldsymbol{B} = \\boldsymbol{0}$. Consequently, there exists a scalar magnetic potential $\\Phi$ such that $\\boldsymbol{B} = -\\nabla \\Phi$ and $\\Phi$ satisfies the Laplace equation $\\nabla^2 \\Phi = 0$. This framework underpins plasma–coil coupling in free-boundary equilibrium solvers: coil currents outside the plasma region determine boundary conditions for the vacuum field, and the resulting normal magnetic field at the plasma boundary constrains the plasma boundary shape.\n\nConsider the two-dimensional exterior of a circle of radius $R$ in the plane, with polar coordinates $(r,\\theta)$ and the circular boundary at $r=R$. Outside the circle, $\\Phi$ satisfies $\\nabla^2 \\Phi = 0$ and decays at infinity. Suppose the Dirichlet boundary data (the value of $\\Phi$ on $r=R$) is prescribed as $g(\\theta) = \\cos(n\\theta)$ for a nonnegative integer $n$. The Dirichlet-to-Neumann (DtN) map $\\Lambda$ takes the Dirichlet data $g(\\theta)$ on the boundary to the negative of the normal derivative of the harmonic solution at the boundary. In the context of free-boundary equilibrium solvers, this $\\Lambda$ encapsulates the vacuum coupling: given a boundary trace of a vacuum harmonic function consistent with external coils, the DtN map returns the normal magnetic field required to satisfy equilibrium constraints at the plasma boundary.\n\nYour tasks are:\n\n1. Derive, from the Laplace equation in polar coordinates and the requirement of decay at infinity, the general form of the exterior harmonic solution for one Fourier mode and show that the Dirichlet-to-Neumann map on the circle is diagonal in Fourier modes. In particular, show that if $g(\\theta) = \\cos(n\\theta)$ at $r=R$ with $n \\ge 1$, then the corresponding harmonic solution outside the circle is $\\Phi(r,\\theta) = \\left(\\frac{R}{r}\\right)^n \\cos(n\\theta)$ and its outward normal derivative at $r=R$ is $\\frac{\\partial \\Phi}{\\partial r}\\big\\rvert_{r=R} = -\\frac{n}{R} \\cos(n\\theta)$. For $n=0$, show that the only decaying solution consistent with a constant Dirichlet data is the trivial $\\Phi \\equiv 0$ so that the Neumann data is $0$. Thus, the Dirichlet-to-Neumann map acts by $\\Lambda[\\cos(n\\theta)] = -\\frac{n}{R} \\cos(n\\theta)$ for $n \\ge 1$ and $\\Lambda[1] = 0$.\n\n2. Using the boundary integral viewpoint for the Laplace equation with the free-space Green’s function $G(\\boldsymbol{x},\\boldsymbol{y}) = -\\frac{1}{2\\pi}\\ln\\|\\boldsymbol{x} - \\boldsymbol{y}\\|$, explain why the Dirichlet-to-Neumann map on smooth boundaries is a nonlocal linear operator and why it diagonalizes on the circle in the Fourier basis. You are not required to implement the integral; use it to conceptually motivate the spectral form of $\\Lambda$.\n\n3. Implement a numerical program to approximate the Neumann data from the Dirichlet data using a radial finite difference at the boundary and compare it to the exact Dirichlet-to-Neumann map derived above. Specifically, sample $\\theta$ uniformly on $[0,2\\pi)$ in radians with $N_\\theta$ points, set the Dirichlet data at $r=R$ as $g(\\theta) = \\cos(n\\theta)$, and approximate the radial derivative at $r=R$ by the forward difference\n$$\n\\left.\\frac{\\partial \\Phi}{\\partial r}\\right\\rvert_{r=R} \\approx \\frac{\\Phi(R+\\Delta r,\\theta) - \\Phi(R,\\theta)}{\\Delta r},\n$$\nwhere $\\Delta r>0$ is a small step and $\\Phi(r,\\theta) = \\left(\\frac{R}{r}\\right)^n \\cos(n\\theta)$ is the exact exterior harmonic solution. Compute the maximum absolute discrepancy over $\\theta$ between this finite-difference approximation and the exact Dirichlet-to-Neumann result $-\\frac{n}{R} \\cos(n\\theta)$.\n\n4. Use the following test suite of parameter values $(R,n,N_\\theta,\\Delta r)$, with angles in radians and all lengths expressed in consistent dimensionless units:\n\n- Test case 1 (happy path): $(R,n,N_\\theta,\\Delta r) = (1.0, 3, 256, 10^{-4})$.\n- Test case 2 (boundary condition mode): $(R,n,N_\\theta,\\Delta r) = (0.5, 0, 128, 10^{-3})$.\n- Test case 3 (high mode, well-resolved): $(R,n,N_\\theta,\\Delta r) = (2.0, 15, 512, 10^{-3})$.\n- Test case 4 (large step, challenging): $(R,n,N_\\theta,\\Delta r) = (1.0, 50, 128, 5 \\times 10^{-2})$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4]\"), where each result is the maximum absolute discrepancy (a float) for the corresponding test case. Angles must be in radians, and the outputs must be pure numbers without any unit indicators.",
            "solution": "The problem statement has been validated and found to be scientifically grounded, well-posed, and objective. It presents a standard problem in potential theory applied to plasma physics, involving analytical derivation, conceptual explanation, and numerical implementation. We now proceed with a complete solution.\n\nThe solution is presented in three parts as requested: derivation of the Dirichlet-to-Neumann map, a conceptual explanation using the boundary integral viewpoint, and a description of the numerical implementation for computing the approximation error.\n\n### 1. Derivation of the Exterior Harmonic Solution and Dirichlet-to-Neumann Map\n\nWe are tasked with solving the Laplace equation $\\nabla^2 \\Phi = 0$ in the exterior of a circle of radius $R$, i.e., for $r > R$, with the boundary condition $\\Phi(R,\\theta) = g(\\theta) = \\cos(n\\theta)$ and a decay condition at infinity.\n\nThe Laplace equation in polar coordinates $(r,\\theta)$ is:\n$$\n\\nabla^2 \\Phi = \\frac{1}{r}\\frac{\\partial}{\\partial r}\\left(r \\frac{\\partial \\Phi}{\\partial r}\\right) + \\frac{1}{r^2}\\frac{\\partial^2 \\Phi}{\\partial \\theta^2} = 0\n$$\nWe use the method of separation of variables, assuming a solution of the form $\\Phi(r,\\theta) = U(r)V(\\theta)$. Substituting this into the equation and rearranging gives:\n$$\n\\frac{r}{U(r)}\\frac{d}{dr}\\left(r \\frac{dU}{dr}\\right) = -\\frac{1}{V(\\theta)}\\frac{d^2 V}{d\\theta^2}\n$$\nSince the left side depends only on $r$ and the right side only on $\\theta$, both must be equal to a constant, which we denote by $\\lambda$. This gives two ordinary differential equations:\n1. Angular equation: $\\frac{d^2 V}{d\\theta^2} + \\lambda V = 0$\n2. Radial equation: $r\\frac{d}{dr}\\left(r \\frac{dU}{dr}\\right) - \\lambda U = 0 \\implies r^2 \\frac{d^2 U}{dr^2} + r \\frac{dU}{dr} - \\lambda U = 0$\n\nFor the solution to be single-valued and continuous in the domain, $V(\\theta)$ must be $2\\pi$-periodic. This requires $\\lambda = k^2$ for a non-negative integer $k$. The solutions for $V(\\theta)$ are linear combinations of $\\cos(k\\theta)$ and $\\sin(k\\theta)$.\n\nWith $\\lambda = k^2$, the radial equation becomes a Cauchy-Euler equation: $r^2 U'' + rU' - k^2 U = 0$.\n- For $k \\ge 1$, the general solution is $U_k(r) = A_k r^k + B_k r^{-k}$.\n- For $k = 0$, the equation is $r(rU')' = 0$, which integrates to $U_0(r) = A_0 + B_0 \\ln r$.\n\nThe general solution for $\\Phi$ is a superposition of these modes:\n$$\n\\Phi(r,\\theta) = A_0 + B_0 \\ln r + \\sum_{k=1}^{\\infty} \\left( (A_k r^k + B_k r^{-k}) \\cos(k\\theta) + (C_k r^k + D_k r^{-k}) \\sin(k\\theta) \\right)\n$$\nThe problem specifies that the solution must decay at infinity ($r \\to \\infty$). For the physical problem of a magnetic potential, this corresponds to the magnetic field $\\boldsymbol{B} = -\\nabla \\Phi$ vanishing at infinity. This implies that $\\Phi$ must be bounded as $r \\to \\infty$. The terms $B_0 \\ln r$, $A_k r^k$, and $C_k r^k$ are unbounded. Therefore, we must set $B_0=0$, $A_k=0$, and $C_k=0$ for all $k \\ge 1$. If we impose the stronger, and common, condition that $\\Phi \\to 0$ as $r \\to \\infty$, we must also set $A_0=0$. The general decaying exterior harmonic function is:\n$$\n\\Phi(r,\\theta) = A_0 + \\sum_{k=1}^{\\infty} \\left( B_k r^{-k} \\cos(k\\theta) + D_k r^{-k} \\sin(k\\theta) \\right)\n$$\nNow we apply the specific Dirichlet boundary condition $g(\\theta) = \\cos(n\\theta)$ at $r=R$.\n\n**Case 1: $n \\ge 1$**\nThe boundary condition is $\\Phi(R,\\theta) = \\cos(n\\theta)$. Matching this with the general solution:\n$$\nA_0 + \\sum_{k=1}^{\\infty} \\left( B_k R^{-k} \\cos(k\\theta) + D_k R^{-k} \\sin(k\\theta) \\right) = \\cos(n\\theta)\n$$\nBy the orthogonality of the Fourier basis functions on $[0, 2\\pi]$, we can equate coefficients. This yields $A_0=0$, $D_k=0$ for all $k$, and $B_k=0$ for all $k \\neq n$. For $k=n$, we must have $B_n R^{-n} = 1$, which implies $B_n = R^n$.\nThe unique decaying solution is therefore:\n$$\n\\Phi(r,\\theta) = (R^n r^{-n}) \\cos(n\\theta) = \\left(\\frac{R}{r}\\right)^n \\cos(n\\theta)\n$$\nThis matches the form provided in the problem. The outward normal derivative at the boundary $r=R$ is $\\frac{\\partial \\Phi}{\\partial r}\\big\\rvert_{r=R}$.\n$$\n\\frac{\\partial \\Phi}{\\partial r} = \\frac{\\partial}{\\partial r} \\left( R^n r^{-n} \\cos(n\\theta) \\right) = R^n (-n r^{-n-1}) \\cos(n\\theta) = -n \\frac{R^n}{r^{n+1}} \\cos(n\\theta)\n$$\nEvaluating at $r=R$:\n$$\n\\frac{\\partial \\Phi}{\\partial r}\\bigg\\rvert_{r=R} = -n \\frac{R^n}{R^{n+1}} \\cos(n\\theta) = -\\frac{n}{R} \\cos(n\\theta)\n$$\nThe problem defines the Dirichlet-to-Neumann map $\\Lambda$ in a way that leads to $\\Lambda[\\cos(n\\theta)] = -\\frac{n}{R} \\cos(n\\theta)$. Although there is an internal sign convention ambiguity in the problem's textual definition of $\\Lambda$ versus its final formula (the textual definition implies a result of $\\frac{n}{R}\\cos(n\\theta)$), we proceed by using the explicit formula as the target for the task.\n\n**Case 2: $n = 0$**\nThe boundary condition is $g(\\theta) = \\cos(0\\theta) = 1$. The general decaying solution for this mode is $\\Phi(r,\\theta) = A_0$. Applying the boundary condition at $r=R$ gives $A_0 = 1$. The solution is $\\Phi(r,\\theta) = 1$. This solution does not decay to $0$ at infinity, but it is bounded. For the physical field to vanish, this is sufficient. The normal derivative is $\\frac{\\partial \\Phi}{\\partial r} = \\frac{\\partial (1)}{\\partial r} = 0$. So for $g(\\theta)=1$, the Neumann data is $0$. This matches the problem's conclusion that $\\Lambda[1]=0$.\n\nOverall, the DtN map acts on the Fourier basis as $\\cos(n\\theta) \\mapsto -\\frac{n}{R}\\cos(n\\theta)$ and $\\sin(n\\theta) \\mapsto -\\frac{n}{R}\\sin(n\\theta)$ for $n \\ge 1$, and $1 \\mapsto 0$. This is the action of a diagonal operator in this basis, with eigenvalues (the diagonal entries) equal to $-\\frac{|n|}{R}$.\n\n### 2. Boundary Integral Viewpoint\n\nThe solution $\\Phi$ to the Laplace equation can be represented via Green's second identity. For a point $\\boldsymbol{x}$ in the exterior domain, the value of $\\Phi$ is given by an integral over the boundary $\\partial\\Omega$:\n$$\n\\Phi(\\boldsymbol{x}) = \\int_{\\partial\\Omega} \\left( G(\\boldsymbol{x},\\boldsymbol{y}) \\frac{\\partial \\Phi}{\\partial \\nu_y}(\\boldsymbol{y}) - \\Phi(\\boldsymbol{y}) \\frac{\\partial G}{\\partial \\nu_y}(\\boldsymbol{x},\\boldsymbol{y}) \\right) dS_y\n$$\nwhere $\\boldsymbol{y}$ is a point on the boundary, $G(\\boldsymbol{x},\\boldsymbol{y}) = -\\frac{1}{2\\pi}\\ln\\|\\boldsymbol{x} - \\boldsymbol{y}\\|$ is the free-space Green's function for the 2D Laplacian, and $\\frac{\\partial}{\\partial \\nu_y}$ is the outward normal derivative at $\\boldsymbol{y}$. Taking the limit as $\\boldsymbol{x}$ approaches a point on the boundary results in a boundary integral equation (BIE) that relates the Dirichlet data $u = \\Phi|_{\\partial\\Omega}$ to the Neumann data $q = \\frac{\\partial \\Phi}{\\partial \\nu}|_{\\partial\\Omega}$.\n\nThe key properties emerge from the nature of the integral operators:\n- **Nonlocality:** The operators are defined by integrals over the entire boundary $\\partial\\Omega$. For instance, the single-layer potential is $(Sq)(\\boldsymbol{x}) = \\int_{\\partial\\Omega} G(\\boldsymbol{x},\\boldsymbol{y}) q(\\boldsymbol{y}) dS_y$. The value at a single point $\\boldsymbol{x}$ depends on the values of the function $q$ across the entire boundary. Consequently, the DtN map $\\Lambda$, which is constructed from these operators, is also a nonlocal operator.\n- **Diagonalization on a Circle:** For a circular boundary of radius $R$, we can parameterize points by their angle $\\theta$. The kernels of the boundary integral operators, such as $G((R,\\theta_x),(R,\\theta_y))$, depend only on the difference of the angles, $\\theta_x - \\theta_y$. An integral operator whose kernel depends only on the difference of its arguments is a convolution operator. A fundamental theorem of Fourier analysis states that convolution operators are diagonalized by the Fourier basis $\\{e^{ik\\theta}\\}_{k \\in \\mathbb{Z}}$ (or equivalently, $\\{\\cos(k\\theta), \\sin(k\\theta)\\}$). The DtN map $\\Lambda$, being composed of such convolution operators for a circular domain, is therefore also diagonal in the Fourier basis.\n\n### 3. Numerical Approximation and Discrepancy\n\nWe are asked to approximate the normal derivative $\\frac{\\partial \\Phi}{\\partial r}\\big\\rvert_{r=R}$ using a forward finite difference scheme and compute its maximum absolute discrepancy from the exact result.\n\nThe exact solution for the Dirichlet data $g(\\theta)=\\cos(n\\theta)$ ($n \\ge 1$) is $\\Phi(r,\\theta) = (R/r)^n \\cos(n\\theta)$.\nThe finite difference approximation for the derivative at $r=R$ is:\n$$\n\\left.\\frac{\\partial \\Phi}{\\partial r}\\right\\rvert_{r=R}^{\\text{approx}} = \\frac{\\Phi(R+\\Delta r,\\theta) - \\Phi(R,\\theta)}{\\Delta r}\n$$\nSubstituting the expressions for $\\Phi$:\n$$\n\\left.\\frac{\\partial \\Phi}{\\partial r}\\right\\rvert_{r=R}^{\\text{approx}} = \\frac{\\left(\\frac{R}{R+\\Delta r}\\right)^n \\cos(n\\theta) - \\left(\\frac{R}{R}\\right)^n \\cos(n\\theta)}{\\Delta r} = \\left[ \\frac{(1+\\Delta r/R)^{-n} - 1}{\\Delta r} \\right] \\cos(n\\theta)\n$$\nThe exact derivative is:\n$$\n\\left.\\frac{\\partial \\Phi}{\\partial r}\\right\\rvert_{r=R}^{\\text{exact}} = -\\frac{n}{R} \\cos(n\\theta)\n$$\nThe discrepancy is the absolute difference between these two quantities. We need to find the maximum of this discrepancy over the sampled angles $\\theta_j = j \\frac{2\\pi}{N_\\theta}$ for $j=0, \\dots, N_\\theta-1$.\n$$\n\\text{Discrepancy}(\\theta) = \\left| \\left[ \\frac{(1+\\Delta r/R)^{-n} - 1}{\\Delta r} \\right] \\cos(n\\theta) - \\left( -\\frac{n}{R} \\cos(n\\theta) \\right) \\right|\n$$\n$$\n= \\left| \\left( \\frac{(1+\\Delta r/R)^{-n} - 1}{\\Delta r} + \\frac{n}{R} \\right) \\cos(n\\theta) \\right|\n$$\nThe maximum absolute value of this expression is achieved when $|\\cos(n\\theta)|=1$. Thus, the maximum discrepancy is:\n$$\n\\text{Max Discrepancy} = \\left| \\frac{(1+\\Delta r/R)^{-n} - 1}{\\Delta r} + \\frac{n}{R} \\right|\n$$\nThis is the quantity to be calculated. For the special case $n=0$, the boundary data is $g(\\theta)=1$. The bounded solution is $\\Phi(r,\\theta)=1$.\n$$\n\\left.\\frac{\\partial \\Phi}{\\partial r}\\right\\rvert_{r=R}^{\\text{approx}} = \\frac{\\Phi(R+\\Delta r,\\theta) - \\Phi(R,\\theta)}{\\Delta r} = \\frac{1-1}{\\Delta r} = 0\n$$\nThe exact derivative is $\\frac{\\partial \\Phi}{\\partial r} = 0$. The discrepancy is $0$.\n\nThe implementation will compute the full expression for maximal accuracy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the maximum absolute discrepancy between the analytical Neumann data\n    and a finite-difference approximation for the exterior Laplace problem on a circle.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (R, n, N_theta, delta_r)\n        (1.0, 3, 256, 1.0e-4),\n        (0.5, 0, 128, 1.0e-3),\n        (2.0, 15, 512, 1.0e-3),\n        (1.0, 50, 128, 5.0e-2),\n    ]\n\n    results = []\n    for R, n, N_theta, delta_r in test_cases:\n        # The task is to compute the maximum absolute discrepancy over theta.\n        # The discrepancy function is:\n        # D(theta) = abs(numerical_derivative(theta) - exact_derivative(theta))\n        #\n        # numerical_derivative(theta) = [ ((1 + delta_r/R)**(-n) - 1) / delta_r ] * cos(n*theta)\n        # exact_derivative(theta) = -(n/R) * cos(n*theta)\n        #\n        # D(theta) = abs( ( ((1 + delta_r/R)**(-n) - 1) / delta_r + n/R ) * cos(n*theta) )\n        #\n        # The maximum value of D(theta) occurs when abs(cos(n*theta)) is maximized, which is 1.\n        # Therefore, we only need to compute the scalar prefactor.\n\n        if n == 0:\n            # For n=0, the solution is Phi(r,theta)=1 (for BC=1).\n            # The numerical derivative is (1-1)/delta_r = 0.\n            # The exact derivative is -0/R = 0.\n            # The discrepancy is 0.\n            discrepancy = 0.0\n        else:\n            # For n >= 1\n            # This is the factor that multiplies cos(n*theta) in the numerical derivative\n            numerical_factor = ((1.0 + delta_r / R)**(-n) - 1.0) / delta_r\n            \n            # This is the factor that multiplies cos(n*theta) in the exact derivative\n            exact_factor = -n / R\n            \n            # The max discrepancy is the absolute difference of these factors\n            discrepancy = abs(numerical_factor - exact_factor)\n            \n        results.append(discrepancy)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}