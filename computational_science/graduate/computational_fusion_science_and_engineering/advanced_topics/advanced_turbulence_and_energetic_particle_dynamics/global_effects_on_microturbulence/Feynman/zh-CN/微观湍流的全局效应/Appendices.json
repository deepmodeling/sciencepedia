{
    "hands_on_practices": [
        {
            "introduction": "在微观湍流的理论研究中，一个核心区别在于局域模型和全局模型。虽然局域模型为了简化分析，假设等离子体在径向上是均匀的，但真实托卡马克中的等离子体参数（如安全因子 $q$）会随径向位置变化。本练习旨在通过一个具体的计算任务，帮助你理解这种径向变化（特别是磁剪切）如何影响湍流模式的增长位置和径向结构，从而将简单的局域图像与更真实的全局行为联系起来。",
            "id": "3985680",
            "problem": "给定一个简化的、但在物理上一致的计算模型，用于量化全局磁剪切如何影响环形等离子体中的微观湍流增长和径向模结构。设小半径归一化为 $r \\in [0,1]$。安全因子剖面 $q(r)$ 定义了局部磁剪切为\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr}.\n$$\n考虑一个由离子温度梯度（Ion Temperature Gradient, ITG）机制驱动的无量纲局域线性增长率，其模型为一个高斯剖面，\n$$\n\\gamma_{0}(r) = \\Gamma \\exp\\left(-\\frac{(r - r_{p})^{2}}{2 w_{p}^{2}}\\right),\n$$\n其中 $\\Gamma$、$r_{p}$ 和 $w_{p}$ 是正常数。包含一个具有系数 $\\nu$ 的垂直波数惩罚项和极向波数 $k_{y}$，因此，基准局域模型（不考虑全局磁剪切效应）为\n$$\n\\gamma_{\\mathrm{b}}(r) = \\gamma_{0}(r) - \\nu k_{y}^{2}.\n$$\n为了引入全局磁剪切效应，将径向波数建模为\n$$\nk_{x}(r) = k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}},\n$$\n其中 $\\theta_{\\mathrm{rms}}$ 是以弧度为单位的均方根极向角展宽。全局增长率变为\n$$\n\\gamma_{\\mathrm{g}}(r) = \\gamma_{0}(r) - \\nu \\left( k_{y}^{2} + \\left(k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}} \\right)^{2} \\right).\n$$\n将峰值位置 $r_{\\mathrm{b}}$ 和 $r_{\\mathrm{g}}$ 定义为 $\\gamma_{\\mathrm{b}}(r)$ 和 $\\gamma_{\\mathrm{g}}(r)$ 分别达到其最大值的半径，以及峰值位移\n$$\n\\Delta r = r_{\\mathrm{g}} - r_{\\mathrm{b}}.\n$$\n假设缓变径向包络 $A(r)$ 满足一维扩散-增长平衡，\n$$\nD_{r} \\frac{d^{2} A}{dr^{2}} + \\gamma(r) A = \\lambda A,\n$$\n其中 $D_{r}$ 是一个正常数径向扩散系数，$\\lambda$ 是一个本征值，证明在 $\\gamma(r)$ 取最大值的峰值半径 $r_{0}$ 附近，包络宽度满足如下标度关系\n$$\nw \\approx \\sqrt{\\frac{D_{r}}{\\kappa}}, \\quad \\text{其中} \\quad \\kappa = -\\left.\\frac{d^{2}\\gamma}{dr^{2}}\\right|_{r=r_{0}}.\n$$\n在本问题中，你将计算 $\\hat{s}(r)$，评估 $\\Delta r$，并通过基准和全局情况下的宽度 $w_{\\mathrm{b}}$ 和 $w_{\\mathrm{g}}$ 来量化径向模结构的变化。\n\n算法要求：\n- 在 $r \\in [0,1]$ 上使用包含 $N$ 个点的均匀网格，其中 $N = 4001$。使用中心差分来近似 $\\frac{dq}{dr}$ 以及 $\\gamma(r)$ 在峰值处的二阶导数。\n- 找到 $r_{\\mathrm{b}}$ 和 $r_{\\mathrm{g}}$，即 $\\gamma_{\\mathrm{b}}(r)$ 和 $\\gamma_{\\mathrm{g}}(r)$ 达到其最大值的网格点。\n- 通过网格间距为 $h$ 的二阶中心有限差分计算 $\\kappa_{\\mathrm{b}} = -\\gamma_{\\mathrm{b}}''(r_{\\mathrm{b}})$ 和 $\\kappa_{\\mathrm{g}} = -\\gamma_{\\mathrm{g}}''(r_{\\mathrm{g}})$；如果峰值出现在边界上，则将其视为数值边界情况，报告宽度为 $0.0$。\n- 计算 $w_{\\mathrm{b}} = \\sqrt{D_{r}/\\kappa_{\\mathrm{b}}}$ 和 $w_{\\mathrm{g}} = \\sqrt{D_{r}/\\kappa_{\\mathrm{g}}}$；如果由于数值噪声导致 $\\kappa \\le 0$，则将相应的宽度设置为 $0.0$。\n\n所有量均为无量纲；角度以弧度为单位。\n\n测试套件：\n对于下面的每个测试用例，$q(r)$ 是一个二次剖面 $q(r) = q_{0} + \\alpha r + \\beta r^{2}$。所有用例均使用相同的微观湍流模型参数。\n\n- 共享微观湍流参数：\n  - $k_{y} = 0.30$\n  - $\\theta_{\\mathrm{rms}} = 0.70$\n  - $\\Gamma = 0.50$\n  - $r_{p} = 0.55$\n  - $w_{p} = 0.12$\n  - $\\nu = 0.80$\n  - $D_{r} = 0.0020$\n\n- 用例 1（$q(r)$ 单调递增，具有中到强剪切）：\n  - $q_{0} = 1.0$, $\\alpha = 1.2$, $\\beta = 0.8$\n\n- 用例 2（弱剪切，$q(r)$ 近乎平坦）：\n  - $q_{0} = 2.0$, $\\alpha = 0.05$, $\\beta = 0.0$\n\n- 用例 3（芯部反剪切，$dq/dr$ 在小 $r$ 处为负，但在大 $r$ 处为正）：\n  - $q_{0} = 1.3$, $\\alpha = -0.8$, $\\beta = 1.2$\n\n你的程序必须：\n- 在网格上计算 $\\hat{s}(r)$、$\\gamma_{\\mathrm{b}}(r)$ 和 $\\gamma_{\\mathrm{g}}(r)$。\n- 确定 $r_{\\mathrm{b}}$、$r_{\\mathrm{g}}$ 和 $\\Delta r$。\n- 使用基于曲率的公式计算 $w_{\\mathrm{b}}$ 和 $w_{\\mathrm{g}}$。\n- 对于每个测试用例，生成一个结果列表，其中按顺序包含恰好三个浮点数 $[\\Delta r, w_{\\mathrm{b}}, w_{\\mathrm{g}}]$。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含所有测试用例的结果，格式为由方括号括起来的列表的逗号分隔列表，例如 $[[x_{1},y_{1},z_{1}],[x_{2},y_{2},z_{2}],[x_{3},y_{3},z_{3}]]]，其中每个 $x_{i}$、$y_{i}$ 和 $z_{i}$ 都是按规定计算的浮点数。",
            "solution": "问题陈述已经过严格验证，被认为是自洽的、科学上合理的和适定的。所有提供的方程、参数和定义都与计算等离子体物理学中用于研究磁约束几何形状对微观不稳定性影响的既定（尽管是简化的）模型相一致。计算任务有明确的规定，包括数值方法和边界情况的处理，确保可以获得唯一且可验证的解。\n\n求解过程通过实现指定的模型和数值算法来进行。我们首先建立一个离散的径向网格，然后对每个测试用例，分步计算感兴趣的物理量。\n\n首先，为归一化小半径 $r \\in [0,1]$ 定义一个包含 $N=4001$ 个点的均匀径向网格。网格间距为 $h = 1/(N-1)$。所有函数都将在这个离散网格上进行评估。\n\n对于由参数 $\\{q_0, \\alpha, \\beta\\}$ 定义的每个测试用例，我们执行以下计算：\n\n1.  **安全因子和磁剪切**：在径向网格 $r$ 上计算二次安全因子剖面 $q(r) = q_{0} + \\alpha r + \\beta r^{2}$。其导数 $\\frac{dq}{dr}$ 使用二阶精度的数值格式进行近似。`numpy.gradient` 函数是合适的，因为它对内部点使用中心差分，在边界处使用二阶单边差分，符合问题要求。然后计算磁剪切 $\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr}$。在 $r=0$ 处，该表达式通过取极限计算，得到 $\\hat{s}(0) = 0$。\n\n2.  **增长率剖面**：计算局域 ITG 增长率 $\\gamma_{0}(r) = \\Gamma \\exp\\left(-\\frac{(r - r_{p})^{2}}{2 w_{p}^{2}}\\right)$。该剖面代表了不稳定性的驱动项。随后，确定基准增长率 $\\gamma_{\\mathrm{b}}(r) = \\gamma_{0}(r) - \\nu k_{y}^{2}$ 和全局增长率 $\\gamma_{\\mathrm{g}}(r) = \\gamma_{0}(r) - \\nu \\left( k_{y}^{2} + \\left(k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}} \\right)^{2} \\right)$。$\\gamma_{\\mathrm{g}}(r)$ 中与 $\\hat{s}(r)^2$ 成正比的项模拟了磁剪切的稳定化效应，该效应增强了与径向波数相关的阻尼。\n\n3.  **峰值位置和位移**：通过识别与 $\\gamma_{\\mathrm{b}}(r)$ 和 $\\gamma_{\\mathrm{g}}(r)$ 的最大值相对应的网格索引，找到基准模型和全局模型的最大增长率位置 $r_{\\mathrm{b}}$ 和 $r_{\\mathrm{g}}$。峰值位移则简单地为 $\\Delta r = r_{\\mathrm{g}} - r_{\\mathrm{b}}$。$\\gamma_{\\mathrm{g}}(r)$ 中的剪切阻尼项通常是 $r$ 的一个非恒定函数，这导致 $r_{\\mathrm{g}}$ 与 $r_{\\mathrm{b}}$ 不同。\n\n4.  **模宽度计算**：本征模包络的径向宽度 $w_{\\mathrm{b}}$ 和 $w_{\\mathrmg}$ 使用提供的公式 $w \\approx \\sqrt{D_{r}/\\kappa}$ 进行估算。量 $\\kappa = -\\left.\\frac{d^{2}\\gamma}{dr^{2}}\\right|_{r=r_{0}}$ 代表增长率剖面在其峰值 $r_0$ 处的曲率。更大的正曲率（更“尖”的剖面）对应于更小的宽度。我们在各自的峰值位置 $r_{\\mathrm{b}}$ 和 $r_{\\mathrm{g}}$ 处计算 $\\kappa_{\\mathrm{b}}$ 和 $\\kappa_{\\mathrmg}$。二阶导数使用二阶中心有限差分公式进行近似：\n$$\n\\gamma''(r_{i}) \\approx \\frac{\\gamma(r_{i+1}) - 2\\gamma(r_{i}) + \\gamma(r_{i-1})}{h^2}\n$$\n其中 $r_i$ 是网格上的峰值位置。根据问题的规定，如果峰值位于边界点（索引 $0$ 或 $N-1$），则无法使用此公式计算二阶导数，相应的宽度设置为 $0.0$。同样，如果数值效应导致计算出的 $\\kappa \\le 0$（这意味着峰值不是局部最大值或位于平坦顶部），宽度也设置为 $0.0$，因为该公式在物理上无意义或会产生非实数结果。\n\n将此程序系统地应用于三个测试用例，每个用例代表一种不同的磁剪切情景：中到强单调剪切、弱剪切和反剪切。收集每个用例的结果 $[\\Delta r, w_{\\mathrm{b}}, w_{\\mathrmg}]$ 并将其格式化为最终的输出字符串。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the impact of global magnetic shear on microturbulence growth rates and mode structures\n    for different safety factor profiles in a toroidal plasma.\n    \"\"\"\n\n    # Shared microturbulence parameters\n    ky = 0.30\n    theta_rms = 0.70\n    Gamma = 0.50\n    rp = 0.55\n    wp = 0.12\n    nu = 0.80\n    Dr = 0.0020\n\n    # Numerical grid parameters\n    N = 4001\n    r = np.linspace(0.0, 1.0, N)\n    h = r[1] - r[0]\n\n    # Test cases for q(r) = q0 + alpha*r + beta*r^2\n    test_cases = [\n        # Case 1: Monotonic increasing q(r) with moderate-to-strong shear\n        {'q0': 1.0, 'alpha': 1.2, 'beta': 0.8},\n        # Case 2: Weak shear, nearly flat q(r)\n        {'q0': 2.0, 'alpha': 0.05, 'beta': 0.0},\n        # Case 3: Reversed shear in the core\n        {'q0': 1.3, 'alpha': -0.8, 'beta': 1.2}\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        q0 = case['q0']\n        alpha = case['alpha']\n        beta = case['beta']\n\n        # 1. Compute q-profile and magnetic shear s_hat\n        q = q0 + alpha * r + beta * r**2\n        dq_dr = np.gradient(q, h)\n        \n        # Guard against division by zero in r/q, though q is positive for all cases.\n        # At r=0, s_hat is 0. np.gradient handles r[0]=0 correctly.\n        with np.errstate(divide='ignore', invalid='ignore'):\n            s_hat = (r / q) * dq_dr\n        if q[0] != 0: # Ensure s_hat[0] = 0 as per limit.\n             s_hat[0] = 0.0\n\n\n        # 2. Compute growth rate profiles\n        gamma0 = Gamma * np.exp(-(r - rp)**2 / (2 * wp**2))\n        gamma_b = gamma0 - nu * ky**2\n        shear_damping_term = nu * (ky * s_hat * theta_rms)**2\n        gamma_g = gamma_b - shear_damping_term\n\n        # 3. Find peak locations and peak shift\n        idx_b = np.argmax(gamma_b)\n        r_b = r[idx_b]\n        idx_g = np.argmax(gamma_g)\n        r_g = r[idx_g]\n        delta_r = r_g - r_b\n\n        # 4. Compute mode widths wb and wg\n        \n        # Baseline width wb\n        if idx_b == 0 or idx_b == N - 1:\n            w_b = 0.0\n        else:\n            gamma_b_pp = (gamma_b[idx_b + 1] - 2 * gamma_b[idx_b] + gamma_b[idx_b - 1]) / h**2\n            kappa_b = -gamma_b_pp\n            if kappa_b = 0:\n                w_b = 0.0\n            else:\n                w_b = np.sqrt(Dr / kappa_b)\n        \n        # Global width wg\n        if idx_g == 0 or idx_g == N - 1:\n            w_g = 0.0\n        else:\n            gamma_g_pp = (gamma_g[idx_g + 1] - 2 * gamma_g[idx_g] + gamma_g[idx_g - 1]) / h**2\n            kappa_g = -gamma_g_pp\n            if kappa_g = 0:\n                w_g = 0.0\n            else:\n                w_g = np.sqrt(Dr / kappa_g)\n        \n        all_results.append([delta_r, w_b, w_g])\n\n    # Format the final output string\n    # e.g., [[-0.05,0.1,0.08],[-0.001,0.1,0.099]]\n    outer_parts = []\n    for inner_list in all_results:\n        inner_str = ','.join(map(str, inner_list))\n        outer_parts.append(f'[{inner_str}]')\n    final_output = f\"[{','.join(outer_parts)}]\"\n\n    print(final_output)\n\nsolve()\n\n```"
        },
        {
            "introduction": "在认识到湍流模式具有径向尺度后，下一个关键的全局效应便是“湍流扩展”。这一现象指的是在不稳定区域产生的湍流能够“渗透”到相邻的稳定区域，导致热量输运范围超出线性不稳定的区域，这是纯局域模型无法描述的。本练习将指导你使用一个包含物理思想的卷积核来模拟这一非局域过程，并定量比较局域（磁通管）模型与考虑了扩展效应的全局模型在热通量剖面上的差异。",
            "id": "3985706",
            "problem": "考虑一个具有小半径 $a$ 和大半径 $R$ 的轴对称托卡马克平衡。设径向坐标为 $r \\in [0,a]$。安全因子（磁力线螺距）剖面为 $q(r)$，磁剪切定义为 $\\hat{s}(r) \\equiv \\frac{r}{q(r)} \\frac{dq}{dr}$。离子温度剖面为 $T_i(r)$，离子温度梯度标长为 $L_{T_i}(r) \\equiv -\\left(\\frac{d \\ln T_i}{dr}\\right)^{-1}$。在离子温度梯度（ITG）驱动的湍流中，离子热扩散系数的局域（磁通管）准线性估计由 $\\chi_i(r) \\equiv \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_\\perp(r)^2}$ 给出，其中 $\\gamma_{\\mathrm{lin}}(r)$ 是局域线性增长率，$k_\\perp(r)$ 是局域垂直波数。一个基于线性ITG理论的标准参数化形式假设 $\\gamma_{\\mathrm{lin}}(r) \\equiv \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right)$ 且 $k_\\perp(r) \\equiv k_{y,0}$ 在 $r$ 上为常数。局域热通量密度建模为 $Q_{\\mathrm{loc}}(r) \\equiv -\\chi_i(r) \\frac{d T_i}{dr}$，并采用归一化单位，使得密度和温度的前置因子为单位一，从而使 $Q_{\\mathrm{loc}}(r)$ 无量纲。\n\n全局效应的产生是因为本征模具有有限的径向范围，并相干地耦合相邻的磁面。为了模拟这种效应，定义一个归一化的径向模强度核函数\n$$\nI(r_0,r) \\equiv \\frac{\\exp\\left( - \\frac{(r-r_0)^2}{2 w(r_0)^2} \\right)}{\\int_0^a \\exp\\left( - \\frac{(r'-r_0)^2}{2 w(r_0)^2} \\right) \\, dr'},\n$$\n其宽度为\n$$\nw(r_0) \\equiv \\frac{w_0}{\\sqrt{|\\hat{s}(r_0)| + s_{\\min}}},\n$$\n其中 $w_0$ 是基础宽度，$s_{\\min}$ 是一个小的正则化常数，以避免在零剪切处发散。全局热通量剖面则为\n$$\nQ_{\\mathrm{glob}}(r_0) \\equiv \\int_0^a I(r_0,r)\\, Q_{\\mathrm{loc}}(r)\\, dr,\n$$\n其中 $Q_{\\mathrm{loc}}(r)$ 是磁通管的预测值。用于量化全局效应的比较度量是域归一化均方根（RMS）差异\n$$\n\\epsilon \\equiv \\frac{\\left(\\int_0^a \\left[Q_{\\mathrm{glob}}(r) - Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}}{\\left(\\int_0^a \\left[Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}},\n$$\n该值为无量纲。\n\n您的任务是编写一个完整、可运行的程序，该程序：\n1.  使用中点构建径向网格以避免在 $r=0$ 和 $r=a$ 处的奇异点，网格包含 $N$ 个宽度为 $\\Delta r = a/N$ 的均匀单元，网格点为 $r_i = \\left(i+\\tfrac{1}{2}\\right)\\Delta r$，其中 $i=0,1,\\dots,N-1$。\n2.  对于下面的每个测试用例，从 $T_i(r)$、$\\gamma_{\\mathrm{lin}}(r)$ 和 $k_\\perp(r)$ 计算 $Q_{\\mathrm{loc}}(r)$，然后通过离散求和对使用核函数 $I(r_0,r)$ 的积分进行数值计算来计算 $Q_{\\mathrm{glob}}(r_0)$，确保对于每个 $r_0$，核函数在截断域 $[0,a]$ 上被正确归一化。最后，使用与所定义网格一致的离散求和法进行数值积分来计算 $\\epsilon$。\n3.  生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[x_1,x_2,x_3]$）作为结果，其中 $x_j$ 是相应测试用例的 $\\epsilon$ 值，每个值四舍五入到 $6$ 位小数。程序必须无需输入，并且必须使用嵌入在代码中的指定参数。\n\n对所有测试用例使用以下科学上一致且自洽的平衡和参数化：\n- 安全因子剖面：$q(r) = q_0 + q_1 \\left(\\frac{r}{a}\\right)^2$，因此 $\\frac{dq}{dr} = \\frac{2 q_1 r}{a^2}$ 且 $\\hat{s}(r) = \\frac{r}{q(r)} \\frac{2 q_1 r}{a^2}$。\n- 温度剖面：$T_i(r) = T_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2\\right]$，因此 $\\frac{dT_i}{dr} = -\\frac{2 T_0 r}{a^2}$ 且 $\\frac{d \\ln T_i}{dr} = \\frac{1}{T_i}\\frac{dT_i}{dr}$，其中 $\\frac{R}{L_{T_i}(r)} \\equiv -R \\frac{d \\ln T_i}{dr}$。\n- 垂直波数：$k_\\perp(r) \\equiv k_{y,0}$。\n- 线性增长率：$\\gamma_{\\mathrm{lin}}(r) \\equiv \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right)$。\n- 局域热通量：$Q_{\\mathrm{loc}}(r) \\equiv -\\chi_i(r)\\frac{dT_i}{dr}$，其中 $\\chi_i(r) \\equiv \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}$。\n\n所有量都通过适当的归一化处理为无量纲量，因此输出值必须是无量纲浮点数。\n\n实现以下测试套件，该套件探测典型条件、近边际稳定性以及强全局耦合：\n- 测试用例 1（基线）：\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 3.0$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.08$, $s_{\\min} = 0.05$, $N = 512$。\n- 测试用例 2（近边际ITG）：\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 4.5$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.08$, $s_{\\min} = 0.05$, $N = 512$。\n- 测试用例 3（宽全局模包络）：\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 3.0$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.25$, $s_{\\min} = 0.05$, $N = 512$。\n\n最终输出格式要求：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表作为结果，每个浮点值四舍五入到 $6$ 位小数，例如 $[0.123456,0.000001,0.987654]$。",
            "solution": "该问题要求计算一个度量 $\\epsilon$，它量化了托卡马克等离子体中湍流热通量的“全局”模型与更简单的“局域”模型之间的偏差。解决方案首先推导所有必要物理量作为小半径 $r$ 的函数表达式，然后在一个指定的数值网格上离散化这些量，最后通过离散求和执行所需的数值积分，以计算局域通量 $Q_{\\mathrm{loc}}(r)$、全局通量 $Q_{\\mathrm{glob}}(r)$ 和度量 $\\epsilon$。\n\n首先，我们建立数值网格。径向域为 $r \\in [0, a]$。我们使用一个包含 $N$ 个单元的均匀网格，每个单元的宽度为 $\\Delta r = a/N$。网格点位于每个单元的中心：\n$$\nr_i = \\left(i + \\frac{1}{2}\\right) \\Delta r = \\left(i + \\frac{1}{2}\\right) \\frac{a}{N} \\quad \\text{for } i = 0, 1, \\dots, N-1.\n$$\n这种中点网格避免了 $r=0$ 处的坐标奇异点和 $r=a$ 处的边界，在这些地方某些剖面定义可能变得不适定。\n\n接下来，我们在此网格上计算等离子体剖面及其导数。\n离子温度剖面由 $T_i(r) = T_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2\\right]$ 给出。其径向导数为：\n$$\n\\frac{dT_i}{dr} = \\frac{d}{dr} \\left( T_0 \\left[1 - \\frac{r^2}{a^2}\\right] \\right) = -\\frac{2 T_0 r}{a^2}.\n$$\n离子温度梯度标长 $L_{T_i}(r)$ 通过 $\\frac{1}{L_{T_i}(r)} \\equiv -\\frac{d \\ln T_i}{dr}$ 定义。对数导数为：\n$$\n\\frac{d \\ln T_i}{dr} = \\frac{1}{T_i(r)} \\frac{dT_i}{dr} = \\frac{1}{T_0(1 - r^2/a^2)} \\left(-\\frac{2 T_0 r}{a^2}\\right) = -\\frac{2r/a^2}{1 - r^2/a^2} = -\\frac{2r}{a^2 - r^2}.\n$$\n湍流的关键驱动项是归一化的逆标长 $\\frac{R}{L_{T_i}(r)}$：\n$$\n\\frac{R}{L_{T_i}(r)} = -R \\frac{d \\ln T_i}{dr} = -R \\left(-\\frac{2r}{a^2 - r^2}\\right) = \\frac{2Rr}{a^2 - r^2}.\n$$\n安全因子剖面为 $q(r) = q_0 + q_1 \\left(\\frac{r}{a}\\right)^2$。其导数为 $\\frac{dq}{dr} = \\frac{2 q_1 r}{a^2}$。磁剪切 $\\hat{s}(r)$ 则为：\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr} = \\frac{r}{q_0 + q_1 (r/a)^2} \\left(\\frac{2 q_1 r}{a^2}\\right) = \\frac{2 q_1 (r/a)^2}{q_0 + q_1 (r/a)^2}.\n$$\n利用这些解析表达式，我们可以在每个网格点 $r_i$ 上计算每个量的值。\n\n离子热通量密度的局域（磁通管）模型 $Q_{\\mathrm{loc}}(r)$ 构建如下。ITG不稳定性的局域线性增长率为：\n$$\n\\gamma_{\\mathrm{lin}}(r) = \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right).\n$$\n准线性离子热扩散系数为 $\\chi_i(r) = \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_\\perp(r)^2}$，其中垂直波数 $k_\\perp(r)$ 是一个常数 $k_{y,0}$。因此，$\\chi_i(r) = \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}$。局域热通量则为：\n$$\nQ_{\\mathrm{loc}}(r) = -\\chi_i(r) \\frac{d T_i}{dr} = -\\left(\\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}\\right) \\left(-\\frac{2 T_0 r}{a^2}\\right) = \\frac{2 T_0 r}{a^2 k_{y,0}^2} \\gamma_{\\mathrm{lin}}(r).\n$$\n该表达式允许直接计算局域热通量值的向量 $Q_{\\mathrm{loc},i} = Q_{\\mathrm{loc}}(r_i)$，对于所有 $i=0, \\dots, N-1$。\n\n为了模拟全局效应，局域通量与一个径向模强度核函数 $I(r_0,r)$ 进行卷积，以获得全局热通量 $Q_{\\mathrm{glob}}(r_0)$。核函数的宽度 $w(r_0)$ 取决于局域磁剪切：\n$$\nw(r_0) = \\frac{w_0}{\\sqrt{|\\hat{s}(r_0)| + s_{\\min}}}.\n$$\n强度核函数是一个归一化的高斯函数：\n$$\nI(r_0,r) = \\frac{\\exp\\left( - \\frac{(r-r_0)^2}{2 w(r_0)^2} \\right)}{C(r_0)}, \\quad \\text{其中} \\quad C(r_0) = \\int_0^a \\exp\\left( - \\frac{(r'-r_0)^2}{2 w(r_0)^2} \\right) \\, dr'.\n$$\n在位置 $r_0$ 处的全局热通量是积分：\n$$\nQ_{\\mathrm{glob}}(r_0) = \\int_0^a I(r_0,r) Q_{\\mathrm{loc}}(r) dr.\n$$\n我们对这个计算进行离散化。对于每个网格点 $r_{0,i} = r_i$，我们计算 $Q_{\\mathrm{glob}}(r_i)$。归一化积分 $C(r_i)$ 和卷积积分通过网格上的离散求和来近似：\n$$\nC(r_i) \\approx \\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w(r_i)^2} \\right) \\Delta r.\n$$\n$$\nQ_{\\mathrm{glob}}(r_i) \\approx \\sum_{j=0}^{N-1} I(r_i,r_j) Q_{\\mathrm{loc}}(r_j) \\Delta r = \\sum_{j=0}^{N-1} \\frac{\\exp\\left( - \\frac{(r_j-r_i)^2}{2 w(r_i)^2} \\right)}{C(r_i)} Q_{\\mathrm{loc}}(r_j) \\Delta r.\n$$\n代入 $C(r_i)$ 的离散形式，$\\Delta r$ 因子被消去，从而得到每个网格点 $r_i$ 处全局通量的加权平均值：\n$$\nQ_{\\mathrm{glob}, i} = \\frac{\\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w_i^2} \\right) Q_{\\mathrm{loc},j}}{\\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w_i^2} \\right)},\n$$\n其中 $w_i = w(r_i)$，$Q_{\\mathrm{glob}, i} = Q_{\\mathrm{glob}}(r_i)$，$Q_{\\mathrm{loc}, j} = Q_{\\mathrm{loc}}(r_j)$。此操作对所有 $i=0, \\dots, N-1$ 执行，以获得 $Q_{\\mathrm{glob}}(r)$ 的完整剖面。\n\n最后，我们计算域归一化均方根差异 $\\epsilon$。其定义中的积分也用离散求和代替：\n$$\n\\epsilon = \\frac{\\left(\\int_0^a \\left[Q_{\\mathrm{glob}}(r) - Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}}{\\left(\\int_0^a \\left[Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}} \\approx \\frac{\\left(\\sum_i \\left(Q_{\\mathrm{glob},i} - Q_{\\mathrm{loc},i}\\right)^2 \\Delta r\\right)^{1/2}}{\\left(\\sum_i \\left(Q_{\\mathrm{loc},i}\\right)^2 \\Delta r\\right)^{1/2}}.\n$$\n单元宽度 $\\Delta r$ 再次从分子和分母中消去，剩下两个离散向量 $Q_{\\mathrm{glob}}$ 和 $Q_{\\mathrm{loc}}$ 之间归一化均方根误差的标准公式：\n$$\n\\epsilon \\approx \\sqrt{\\frac{\\sum_{i=0}^{N-1} \\left(Q_{\\mathrm{glob},i} - Q_{\\mathrm{loc},i}\\right)^2}{\\sum_{i=0}^{N-1} \\left(Q_{\\mathrm{loc},i}\\right)^2}}.\n$$\n需要检查以确保分母不为零，对于给定的参数，这是预期的，因为 ITG 驱动项 $\\frac{R}{L_{T_i}(r)}$ 在等离子体半径的一个有限部分上超过其临界值。此过程应用于每个测试用例，以获得所需的 $\\epsilon$ 值。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_epsilon(params: dict) -> float:\n    \"\"\"\n    Computes local and global heat fluxes and the RMS difference metric epsilon.\n    \n    Args:\n        params: A dictionary containing all the necessary physical and numerical parameters.\n    \n    Returns:\n        The calculated dimensionless metric epsilon.\n    \"\"\"\n    # Unpack parameters\n    a = params[\"a\"]\n    R = params[\"R\"]\n    q0 = params[\"q0\"]\n    q1 = params[\"q1\"]\n    T0 = params[\"T0\"]\n    R_LTi_crit = params[\"R/LTi_crit\"]\n    gamma0 = params[\"gamma0\"]\n    ky0 = params[\"ky0\"]\n    w0 = params[\"w0\"]\n    s_min = params[\"s_min\"]\n    N = params[\"N\"]\n\n    # 1. Construct the radial grid\n    dr = a / N\n    r = (np.arange(N) + 0.5) * dr\n\n    # 2. Compute profiles\n    # Avoid division by zero at r=0 by using a small epsilon, though the grid avoids r=0.\n    r_safe = np.maximum(r, 1e-12)\n\n    # Safety factor and magnetic shear\n    r_over_a_sq = (r / a)**2\n    q = q0 + q1 * r_over_a_sq\n    s_hat = (2 * q1 * r_over_a_sq) / (q0 + q1 * r_over_a_sq)\n\n    # Temperature gradient and ITG drive term\n    # T_i(r) = T0 * (1 - (r/a)**2)\n    # dTi/dr = -2 * T0 * r / a**2\n    # R/L_Ti(r) = 2*R*r / (a**2 - r**2)\n    dTi_dr = -2 * T0 * r / a**2\n    # The grid points r are strictly less than a, so a**2 - r**2 > 0.\n    R_over_LTi = (2 * R * r) / (a**2 - r**2)\n\n    # 3. Compute local heat flux Q_loc\n    gamma_lin = gamma0 * np.maximum(0, R_over_LTi - R_LTi_crit)\n    chi_i = gamma_lin / ky0**2\n    Q_loc = -chi_i * dTi_dr\n    \n    # 4. Compute global heat flux Q_glob\n    # Mode width w(r_0)\n    w = w0 / np.sqrt(np.abs(s_hat) + s_min)\n    \n    Q_glob = np.zeros(N)\n    \n    # Convolution integral via discrete summation\n    for i in range(N):\n        r0_i = r[i]\n        w_i = w[i]\n        \n        # Gaussian kernel centered at r0_i with width w_i\n        kernel = np.exp(-(r - r0_i)**2 / (2 * w_i**2))\n        \n        # Weighted average of Q_loc\n        # This is the discrete equivalent of the convolution integral with a normalized kernel\n        kernel_sum = np.sum(kernel)\n        if kernel_sum > 0:\n            Q_glob[i] = np.sum(kernel * Q_loc) / kernel_sum\n        else:\n            Q_glob[i] = 0.0\n\n    # 5. Compute the metric epsilon\n    # The dr factor in the integrals cancels out\n    sum_Q_loc_sq = np.sum(Q_loc**2)\n    \n    if sum_Q_loc_sq == 0:\n        # If there is no local flux, the global flux is also zero, and the difference is zero.\n        # This can happen in a fully stable case.\n        return 0.0\n\n    sum_diff_sq = np.sum((Q_glob - Q_loc)**2)\n    \n    epsilon = np.sqrt(sum_diff_sq / sum_Q_loc_sq)\n    \n    return epsilon\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1 (baseline)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 3.0, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.08,\n            \"s_min\": 0.05, \"N\": 512\n        },\n        # Test case 2 (near-marginal ITG)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 4.5, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.08,\n            \"s_min\": 0.05, \"N\": 512\n        },\n        # Test case 3 (broad global mode envelope)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 3.0, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.25,\n            \"s_min\": 0.05, \"N\": 512\n        },\n    ]\n\n    results = []\n    for case_params in test_cases:\n        epsilon = calculate_epsilon(case_params)\n        results.append(f\"{epsilon:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "理解并设计输运垒是全局效应研究中最重要的应用之一，它直接关系到聚变装置约束性能的提升。其核心物理机制在于，等离子体中 $E \\times B$ 流的强剪切能够有效“撕裂”湍流涡旋，从而抑制输运。本练习将让你亲手实践这一原理：通过计算给定的径向电场剖面所产生的 $E \\times B$ 剪切抑制率 ($\\gamma_E$)，并将其与湍流增长率 ($\\gamma_L$) 进行比较，你将能够准确识别出输运垒可能形成的径向位置。",
            "id": "3985700",
            "problem": "给定一个类托卡马克装置的一维径向变化剖面，其小半径为 $a$，半径 $r \\in [r_{\\min}, a]$。目标是根据给定的径向电场 $E_r(r)$ 计算电场叉磁场 (E×B) 剪切率 $\\gamma_E(r)$，使用标准漂移波标度律从第一性原理估算局域线性离子温度梯度 (ITG) 不稳定性增长率 $\\gamma_L(r)$，然后识别输运垒的位置，在这些位置上 $\\gamma_E(r)  \\gamma_L(r)$。该问题必须使用有限差分法进行数值求解，并且最终结果必须按规定格式呈现。\n\n基本原理：\n- E×B 漂移速度大小为 $v_E(r) = \\frac{|E_r(r)|}{B(r)}$，其中 $B(r)$ 是磁场大小。\n- 局域 E×B 角频率为 $\\omega_E(r) = \\frac{v_E(r)}{r} = \\frac{E_r(r)}{B(r)\\,r}$。\n- E×B 剪切率定义为\n$$\n\\gamma_E(r) = \\left| r\\,\\frac{d}{dr}\\left(\\omega_E(r)\\right) \\right| = \\left| r\\,\\frac{d}{dr}\\left( \\frac{E_r(r)}{B(r)\\,r} \\right) \\right|.\n$$\n- 离子抗磁漂移频率为\n$$\n\\omega_{\\ast i}(r) = \\frac{k_y(r)\\,T_i(r)}{e\\,B(r)\\,L_n(r)},\n$$\n其中 $e$ 是元电荷，$T_i(r)$ 是离子温度，$k_y(r)$ 是副法向波数，$L_n(r)$ 是密度梯度标长，定义为 $L_n(r) = -\\frac{n(r)}{dn/dr}$，其中 $n(r)$ 是离子密度。\n- ITG 驱动强度取决于 $\\eta_i(r) = \\frac{L_n(r)}{L_T(r)}$，其中 $L_T(r) = -\\frac{T_i(r)}{dT_i/dr}$ 是离子温度梯度标长。\n- 一个广泛使用的局域线性 ITG 增长率的类流体标度律为\n$$\n\\gamma_L(r) = \\alpha\\,\\omega_{\\ast i}(r)\\,\\max\\left(0,\\eta_i(r) - \\eta_c\\right)\\,S(r),\n$$\n其中 $\\alpha$ 是一个量级为 1 的系数，$\\eta_c$ 是一个阈值参数，$S(r)$ 是一个捕捉全局磁剪切效应的稳定因子。使用近似的磁剪切稳定化\n$$\nS(r) = \\frac{1}{1 + \\hat{s}(r)^2}, \\quad \\hat{s}(r) = \\frac{r}{q(r)}\\frac{dq}{dr},\n$$\n其中安全因子剖面 $q(r)$ 在下面给出。\n\n数值要求：\n- 对于所有径向导数，内部点使用中心有限差分，边界点使用单边差分。在计算 $L_n(r)$ 和 $L_T(r)$ 时，要防止除以过分接近零的值，以确保数值稳定性。\n- 所有物理量必须使用国际单位制 (SI) 处理。具体来说，$r$ 以 $\\mathrm{m}$ 为单位，$E_r$ 以 $\\mathrm{V/m}$ 为单位，$B$ 以 $\\mathrm{T}$ 为单位，$n$ 以 $\\mathrm{m^{-3}}$ 为单位，$T_i$ 以焦耳为单位（给定的剖面以千电子伏特为单位，但在计算中需转换为焦耳）。角度不直接使用；波数 $k_y(r)$ 以 $\\mathrm{m^{-1}}$ 为单位。\n\n判定规则：\n- 当 $\\gamma_E(r)  \\gamma_L(r)$ 时，认为该处局域存在输运垒。识别满足此不等式的连续径向区间（相连的网格点集），并报告每个区间的中心半径。\n\n最终输出格式：\n- 您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表（例如：$[result_1,result_2,result_3]$），其中每个 $result_i$ 是对应测试案例的输运垒中心半径列表，单位为米，四舍五入到三位小数，以浮点数表示。如果在某个测试案例中未找到输运垒，则该案例输出一个空列表 $[]$。\n\n测试套件：\n- 在 $[r_{\\min}, a]$ 上使用一个包含 $N = 200$ 个点的均匀径向网格，其中 $r_{\\min} = 0.05\\,\\mathrm{m}$，$a = 0.50\\,\\mathrm{m}$。\n\n- 物理常数：\n  - 元电荷 $e = 1.602176634\\times 10^{-19}\\,\\mathrm{C}$。\n  - 氘离子质量 $m_i = 3.343583719\\times 10^{-27}\\,\\mathrm{kg}$（主要公式中不直接需要，但为完整性而提供）。\n\n- 除非另有说明，所有案例中使用的全局参数为：$\\alpha = 0.3$，$\\eta_c = 1.0$，大半径 $R_0 = 1.7\\,\\mathrm{m}$（仅为背景信息；公式中不直接需要），以及副法向波数定义为 $k_y(r) = \\frac{m}{r}$，其中整数模数 $m$ 由每个案例指定。将 $B(r)$ 视为每个案例指定的环向场大小 $B_t$。\n\n- 安全因子剖面：\n$$\nq(r) = q_0 + q_1\\left(\\frac{r}{a}\\right)^2,\n$$\n其中 $q_0$ 和 $q_1$ 由每个案例指定。\n\n- 案例 1（“边界 $E_r$ 峰值”）：\n  - $B_t = 2.0\\,\\mathrm{T}$，$m = 40$，$q_0 = 1.0$，$q_1 = 1.5$。\n  - 密度：$n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$，其中 $n_0 = 1.0\\times 10^{20}\\,\\mathrm{m^{-3}}$，$L_{n0} = 0.25\\,\\mathrm{m}$。\n  - 离子温度（单位为千电子伏特，内部计算时转换为焦耳）：$T_i(r) = T_0\\left(1 - 0.8\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$，其中 $T_0 = 2.5\\,\\mathrm{keV}$，$T_{\\mathrm{edge}} = 0.5\\,\\mathrm{keV}$。\n  - 径向电场：$E_r(r) = E_0 \\exp\\left(-\\frac{(r - r_p)^2}{2\\sigma^2}\\right)$，其中 $E_0 = 15000\\,\\mathrm{V/m}$，$r_p = 0.45\\,\\mathrm{m}$，$\\sigma = 0.05\\,\\mathrm{m}$。\n\n- 案例 2（“弱 $E_r$，强梯度”）：\n  - $B_t = 2.0\\,\\mathrm{T}$，$m = 60$，$q_0 = 1.2$，$q_1 = 1.0$。\n  - 密度：$n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$，其中 $n_0 = 1.1\\times 10^{20}\\,\\mathrm{m^{-3}}$，$L_{n0} = 0.20\\,\\mathrm{m}$。\n  - 离子温度（单位为千电子伏特，内部计算时转换为焦耳）：$T_i(r) = T_0\\left(1 - 0.9\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$，其中 $T_0 = 3.0\\,\\mathrm{keV}$，$T_{\\mathrm{edge}} = 0.4\\,\\mathrm{keV}$。\n  - 径向电场：$E_r(r) = E_0 \\exp\\left(-\\frac{(r - r_p)^2}{2\\sigma^2}\\right)$，其中 $E_0 = 2000\\,\\mathrm{V/m}$，$r_p = 0.40\\,\\mathrm{m}$，$\\sigma = 0.06\\,\\mathrm{m}$。\n\n- 案例 3（“双峰 $E_r$”）：\n  - $B_t = 1.8\\,\\mathrm{T}$，$m = 50$，$q_0 = 1.0$，$q_1 = 1.8$。\n  - 密度：$n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$，其中 $n_0 = 0.9\\times 10^{20}\\,\\mathrm{m^{-3}}$，$L_{n0} = 0.30\\,\\mathrm{m}$。\n  - 离子温度（单位为千电子伏特，内部计算时转换为焦耳）：$T_i(r) = T_0\\left(1 - 0.7\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$，其中 $T_0 = 2.2\\,\\mathrm{keV}$，$T_{\\mathrm{edge}} = 0.6\\,\\mathrm{keV}$。\n  - 径向电场：两个高斯函数的和\n$$\nE_r(r) = E_1 \\exp\\left(-\\frac{(r - r_{p1})^2}{2\\sigma_1^2}\\right) + E_2 \\exp\\left(-\\frac{(r - r_{p2})^2}{2\\sigma_2^2}\\right),\n$$\n其中 $E_1 = 8000\\,\\mathrm{V/m}$，$r_{p1} = 0.20\\,\\mathrm{m}$，$\\sigma_1 = 0.03\\,\\mathrm{m}$，以及 $E_2 = 12000\\,\\mathrm{V/m}$，$r_{p2} = 0.42\\,\\mathrm{m}$，$\\sigma_2 = 0.04\\,\\mathrm{m}$。\n\n您的程序必须：\n- 完全按照规定构造径向网格和剖面。\n- 在网格上计算 $\\gamma_E(r)$ 和 $\\gamma_L(r)$。\n- 确定 $\\gamma_E(r)  \\gamma_L(r)$ 的连续输运垒区域。\n- 输出单行：一个包含三个条目的列表，每个条目分别是案例 1、2 和 3 的输运垒中心半径列表（单位为 $\\mathrm{m}$），四舍五入到三位小数。例如，一个可接受的输出格式是 $[[0.452],[\\,],[0.205,0.421]]$；然而，确切的数值取决于您的计算。",
            "solution": "该问题在计算聚变等离子体物理领域内是适定的且具有科学依据。它提出了一个用于识别托卡马克等离子体中输运垒的标准（尽管简化了）模型。我们的任务是比较由 E×B 剪切率 $\\gamma_E$ 代表的湍流抑制率，与由离子温度梯度 (ITG) 模线性增长率 $\\gamma_L$ 的估计值代表的湍流驱动。当抑制作用主导驱动作用时，即 $\\gamma_E(r)  \\gamma_L(r)$ 时，形成输运垒。\n\n求解过程首先建立一个数值框架，然后在离散网格上计算感兴趣的物理量，最后应用判定规则来识别输运垒的位置。所有计算均以国际单位制 (SI) 进行。\n\n**1. 数值框架**\n\n连续径向域 $r \\in [r_{\\min}, a]$（其中 $r_{\\min} = 0.05\\,\\mathrm{m}$ 和 $a = 0.50\\,\\mathrm{m}$）被离散化为一个包含 $N=200$ 个点的均匀网格。设网格点为 $r_j$，其中 $j = 0, 1, \\dots, N-1$，恒定间距为 $\\Delta r = (a - r_{\\min})/(N-1)$。\n\n给定的离子密度 $n(r)$、离子温度 $T_i(r)$、安全因子 $q(r)$ 和径向电场 $E_r(r)$ 的解析剖面在每个网格点 $r_j$ 上进行求值。以千电子伏特 ($\\mathrm{keV}$) 提供的离子温度，使用转换公式 $1\\,\\mathrm{keV} = 1000 \\times e$ 转换为焦耳 ($J$)，其中 $e \\approx 1.602 \\times 10^{-19}\\,\\mathrm{C}$ 是元电荷。\n\n该问题需要数值计算几个径向导数，如 $dn/dr$、$dT_i/dr$、$dq/dr$ 以及 E×B 角频率的导数。这些都使用有限差分法计算。对于内部网格点 $j=1, \\dots, N-2$，使用二阶中心差分格式：\n$$\n\\left(\\frac{df}{dr}\\right)_{r_j} \\approx \\frac{f(r_{j+1}) - f(r_{j-1})}{2\\Delta r}\n$$\n对于边界点 $j=0$ 和 $j=N-1$，必须采用单边差分格式（例如，$j=0$ 处使用前向差分，$j=N-1$ 处使用后向差分）以保持数值稳定性和正确性。一个标准的数值库函数，如 `numpy.gradient`，可以自然地处理这个要求。\n\n**2. ITG 增长率 $\\gamma_L(r)$ 的计算**\n\n局域线性 ITG 增长率由以下公式给出：\n$$\n\\gamma_L(r) = \\alpha\\,\\omega_{\\ast i}(r)\\,\\max\\left(0,\\eta_i(r) - \\eta_c\\right)\\,S(r)\n$$\n在每个网格点上计算 $\\gamma_L(r_j)$ 涉及几个中间步骤：\n\n*   **梯度标长**：首先，计算密度梯度标长 $L_n(r)$ 和温度梯度标长 $L_T(r)$。这需要对密度和温度剖面进行数值求导：\n    $$\n    L_n(r_j) = -\\frac{n(r_j)}{(dn/dr)_{r_j}}, \\quad L_T(r_j) = -\\frac{T_i(r_j)}{(dT_i/dr)_{r_j}}\n    $$\n*   **$\\eta_i$ 参数**：这些标长之比定义了 ITG 不稳定性驱动参数 $\\eta_i$：\n    $$\n    \\eta_i(r_j) = \\frac{L_n(r_j)}{L_T(r_j)}\n    $$\n*   **磁剪切与稳定化**：磁剪切 $\\hat{s}(r)$ 由安全因子剖面 $q(r)$ 及其数值导数 $dq/dr$ 计算得出：\n    $$\n    \\hat{s}(r_j) = \\frac{r_j}{q(r_j)}\\left(\\frac{dq}{dr}\\right)_{r_j}\n    $$\n    然后用它来求出剪切稳定因子 $S(r)$：\n    $$\n    S(r_j) = \\frac{1}{1 + \\hat{s}(r_j)^2}\n    $$\n*   **离子抗磁频率**：离子抗磁漂移频率 $\\omega_{\\ast i}(r)$ 计算如下：\n    $$\n    \\omega_{\\ast i}(r_j) = \\frac{k_y(r_j)\\,T_i(r_j)}{e\\,B(r_j)\\,L_n(r_j)}\n    $$\n    这里，磁场 $B(r_j)$ 是给定案例的恒定环向场 $B_t$，副法向波数为 $k_y(r_j) = m/r_j$，其中 $m$ 是该案例的模数。\n*   **最终组合**：在网格上计算出所有分量后，即可组合出 $\\gamma_L(r_j)$。按规定使用参数 $\\alpha=0.3$ 和 $\\eta_c=1.0$。\n\n**3. E×B 剪切率 $\\gamma_E(r)$ 的计算**\n\nE×B 剪切率用于衡量等离子体 E×B 流的径向剪切，定义为：\n$$\n\\gamma_E(r) = \\left| r\\,\\frac{d}{dr}\\left( \\omega_E(r) \\right) \\right|\n$$\n其中 $\\omega_E(r) = E_r(r) / (B(r)r)$ 是 E×B 角频率。计算过程如下：\n\n*   **E×B 角频率**：首先，在网格上计算 $\\omega_E(r_j)$ 的剖面。这里，$B(r)$ 同样是恒定的 $B_t$。\n    $$\n    \\omega_E(r_j) = \\frac{E_r(r_j)}{B_t\\,r_j}\n    $$\n*   **数值微分**：使用与之前相同的有限差分格式，数值计算角频率的径向导数 $(d\\omega_E/dr)_{r_j}$。\n*   **最终组合**：然后在每个网格点上计算 E×B 剪切率：\n    $$\n    \\gamma_E(r_j) = \\left| r_j \\left(\\frac{d\\omega_E}{dr}\\right)_{r_j} \\right|\n    $$\n\n**4. 输运垒的识别**\n\n输运垒被定义为 E×B 剪切率超过 ITG 增长率的区域。在每个网格点上检查此条件：\n$$\n\\gamma_E(r_j)  \\gamma_L(r_j)\n$$\n此比较产生一个布尔数组，指示潜在输运垒形成的位置。为了满足问题要求，我们必须识别该条件成立的连续径向区间（相连的网格点集）。\n\n用于此识别的算法如下：\n1.  生成一个表示条件 $\\gamma_E(r_j)  \\gamma_L(r_j)$ 的布尔数组。\n2.  在此数组中识别每个连续 `True` 值块的起始和结束索引。\n3.  对于每个由起始索引 $j_{start}$ 和结束索引 $j_{end}$ 定义的已识别块，相应的径向区间为 $[r_{j_{start}}, r_{j_{end}}]$。\n4.  此区间的中心半径计算为 $(r_{j_{start}} + r_{j_{end}})/2$。\n5.  为每个测试案例收集所有这些中心半径，并作为最终结果呈现，四舍五入到三位小数。如果某个案例没有找到这样的区域，则报告一个空列表。\n\n通过对三个测试案例分别执行此程序，我们可以根据提供的等离子体剖面和物理模型确定输运垒的位置。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and identifies transport barrier locations in a tokamak-like device\n    by comparing the E×B shearing rate with the ITG growth rate.\n    \"\"\"\n\n    # Physical constants\n    E_CHARGE = 1.602176634e-19  # Elementary charge in Coulombs\n\n    # Global simulation parameters\n    N_POINTS = 200\n    R_MIN = 0.05  # m\n    A_RADIUS = 0.50  # m\n    ALPHA = 0.3\n    ETA_C = 1.0\n\n    # Radial grid\n    r_grid = np.linspace(R_MIN, A_RADIUS, N_POINTS)\n\n    # Test case definitions\n    test_cases = [\n        {\n            \"name\": \"Case 1: edge-peaked Er\",\n            \"Bt\": 2.0, \"m\": 40, \"q0\": 1.0, \"q1\": 1.5,\n            \"n0\": 1.0e20, \"Ln0\": 0.25,\n            \"T0_kev\": 2.5, \"T_edge_kev\": 0.5, \"Ti_factor\": 0.8,\n            \"E0\": 15000.0, \"rp\": 0.45, \"sigma\": 0.05\n        },\n        {\n            \"name\": \"Case 2: weak Er, strong gradients\",\n            \"Bt\": 2.0, \"m\": 60, \"q0\": 1.2, \"q1\": 1.0,\n            \"n0\": 1.1e20, \"Ln0\": 0.20,\n            \"T0_kev\": 3.0, \"T_edge_kev\": 0.4, \"Ti_factor\": 0.9,\n            \"E0\": 2000.0, \"rp\": 0.40, \"sigma\": 0.06\n        },\n        {\n            \"name\": \"Case 3: dual-peaked Er\",\n            \"Bt\": 1.8, \"m\": 50, \"q0\": 1.0, \"q1\": 1.8,\n            \"n0\": 0.9e20, \"Ln0\": 0.30,\n            \"T0_kev\": 2.2, \"T_edge_kev\": 0.6, \"Ti_factor\": 0.7,\n            \"E1\": 8000.0, \"rp1\": 0.20, \"sigma1\": 0.03,\n            \"E2\": 12000.0, \"rp2\": 0.42, \"sigma2\": 0.04,\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # --- 1. Evaluate profiles on the grid ---\n        \n        # Safety factor q(r)\n        q_profile = case[\"q0\"] + case[\"q1\"] * (r_grid / A_RADIUS)**2\n        \n        # Density n(r)\n        n_profile = case[\"n0\"] * np.exp(-r_grid / case[\"Ln0\"])\n        \n        # Ion Temperature Ti(r) in Joules\n        T0_J = case[\"T0_kev\"] * 1000 * E_CHARGE\n        T_edge_J = case[\"T_edge_kev\"] * 1000 * E_CHARGE\n        Ti_profile_J = T0_J * (1 - case[\"Ti_factor\"] * (r_grid / A_RADIUS)**2) + T_edge_J\n        \n        # Radial Electric Field Er(r)\n        if \"E0\" in case: # Single Gaussian\n            Er_profile = case[\"E0\"] * np.exp(-(r_grid - case[\"rp\"])**2 / (2 * case[\"sigma\"]**2))\n        else: # Dual Gaussian for Case 3\n            gauss1 = case[\"E1\"] * np.exp(-(r_grid - case[\"rp1\"])**2 / (2 * case[\"sigma1\"]**2))\n            gauss2 = case[\"E2\"] * np.exp(-(r_grid - case[\"rp2\"])**2 / (2 * case[\"sigma2\"]**2))\n            Er_profile = gauss1 + gauss2\n            \n        # --- 2. Compute ITG growth rate gamma_L ---\n        \n        # Numerical derivatives using second-order accurate differences\n        dn_dr = np.gradient(n_profile, r_grid)\n        dTi_dr = np.gradient(Ti_profile_J, r_grid)\n        dq_dr = np.gradient(q_profile, r_grid)\n        \n        # Gradient scale lengths. Add a small epsilon to denominator for safety.\n        epsilon = 1e-12\n        Ln_profile = -n_profile / (dn_dr + epsilon)\n        LT_profile = -Ti_profile_J / (dTi_dr + epsilon)\n        \n        # eta_i parameter\n        eta_i_profile = Ln_profile / (LT_profile + epsilon)\n        \n        # Magnetic shear and stabilization factor\n        s_hat_profile = (r_grid / q_profile) * dq_dr\n        S_factor = 1.0 / (1.0 + s_hat_profile**2)\n        \n        # Ion diamagnetic frequency\n        ky_profile = case[\"m\"] / r_grid\n        omega_star_i = (ky_profile * Ti_profile_J) / (E_CHARGE * case[\"Bt\"] * Ln_profile)\n        \n        # ITG growth rate gamma_L\n        itg_drive = np.maximum(0, eta_i_profile - ETA_C)\n        gamma_L = ALPHA * omega_star_i * itg_drive * S_factor\n        \n        # --- 3. Compute ExB shearing rate gamma_E ---\n        \n        # ExB angular frequency\n        omega_E = Er_profile / (case[\"Bt\"] * r_grid)\n        \n        # Derivative of omega_E\n        d_omega_E_dr = np.gradient(omega_E, r_grid)\n        \n        # ExB shearing rate gamma_E\n        gamma_E = np.abs(r_grid * d_omega_E_dr)\n        \n        # --- 4. Identify transport barriers ---\n        \n        is_barrier = gamma_E > gamma_L\n        barrier_centers = []\n        \n        # Find contiguous blocks of 'True'\n        padded_condition = np.concatenate(([False], is_barrier, [False]))\n        diff = np.diff(padded_condition.astype(int))\n        starts = np.where(diff == 1)[0]\n        ends = np.where(diff == -1)[0] - 1\n        \n        if starts.size > 0:\n            for start_idx, end_idx in zip(starts, ends):\n                # Check for valid block\n                if start_idx = end_idx:\n                    center_radius = (r_grid[start_idx] + r_grid[end_idx]) / 2.0\n                    barrier_centers.append(round(center_radius, 3))\n\n        all_results.append(barrier_centers)\n\n    # --- 5. Format and print final output ---\n    \n    # Manually construct string to match format [[...], [...], ...] without extra spaces\n    result_strings = []\n    for res_list in all_results:\n        if not res_list:\n            result_strings.append(\"[]\")\n        else:\n            # Format numbers to 3 decimal places\n            formatted_numbers = [f\"{num:.3f}\" for num in res_list]\n            result_strings.append(f\"[{','.join(formatted_numbers)}]\")\n    \n    final_output = f\"[{','.join(result_strings)}]\"\n    print(final_output)\n\nsolve()\n```"
        }
    ]
}