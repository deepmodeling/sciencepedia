{
    "hands_on_practices": [
        {
            "introduction": "理解现代科学模拟所产生的数据规模，是认识原位数据处理必要性的第一步。这项练习提供了一个动手实践的机会，让你通过“信封背面”式的估算，来亲身感受数据量的庞大以及原位压缩如何直接缓解I/O瓶颈。通过计算未压缩和压缩后数据集的大小，并评估其对文件系统写入时间的影响，你将对原位约减带来的性能优势有一个定量的认识。",
            "id": "3994993",
            "problem": "在计算聚变科学中，一次高保真度湍流解析回旋动理学模拟在每个输出检查点都会生成一个原位标量诊断场。该场在 $512^3$ 个点的均匀网格上进行离散化，每个样本存储为单精度浮点值，占用 $4$ 字节。在写入持续输入/输出（I/O）带宽为每秒 $100$ 吉字节的并行文件系统之前，一个节点内原位压缩器对该场实现了 $10$ 的压缩比。为保证单位一致性，定义 $1$ 吉字节（GB）为 $10^9$ 字节。\n\n仅使用以下基本定义：(i) 数据大小等于样本数与每样本字节数的乘积，(ii) 压缩比等于未压缩大小除以压缩后大小，以及 (iii) I/O 时间等于数据大小除以持续带宽，确定以下三个量：\n1. 未压缩数据的大小（以吉字节为单位）。\n2. 压缩后数据的大小（以吉字节为单位）。\n3. 在所述文件系统上写入压缩数据集所需的缩减 I/O 时间（以秒为单位）。\n\n将这两个大小以 GB 表示，时间以秒表示。将这三个量中的每一个都四舍五入到四位有效数字。你的最终答案必须以单行矩阵的形式提供，其中包含按上述顺序列出的三个四舍五入后的值，不带单位。",
            "solution": "在进行求解之前，对问题陈述进行严格验证。\n\n### 步骤 1：提取已知条件\n- 网格离散化：$512^3$ 个点\n- 每样本字节数：$4$ 字节（单精度浮点）\n- 压缩比，$C_r$：$10$\n- 持续 I/O 带宽，$R_{IO}$：每秒 $100$ 吉字节\n- 吉字节（GB）的定义：$1 \\text{ GB} = 10^9 \\text{ 字节}$\n- 数据大小的定义：（样本数） $\\times$ （每样本字节数）\n- 压缩比的定义：（未压缩大小） / （压缩后大小）\n- I/O 时间的定义：（数据大小） / （持续带宽）\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据：** 该问题基于数据存储、压缩和传输速率等基本概念，这些是高性能计算和计算科学的核心。所提供的值（$512^3$ 网格、$4$ 字节浮点数、$10:1$ 压缩比、$100$ GB/s 带宽）对于当代大规模科学模拟是现实的。将吉字节明确定义为 $10^9$ 字节（而不是 $2^{30}$ 字节）是精确性的标志。\n- **适定性：** 提供了所有必要的数据和定义。要确定的三个量已明确指定，并且可以从已知条件中推导出一个唯一的解。\n- **客观性：** 问题以精确、定量和无偏见的语言陈述。\n\n### 步骤 3：结论与行动\n该问题被认为是 **有效的**，因为它是自洽的、科学上合理的且适定的。现在将推导正式解。\n\n### 求解推导\n设 $N$ 为总样本数（网格点数），$B_s$ 为每样本字节数，$S_u$ 为未压缩数据大小，$S_c$ 为压缩后数据大小，$C_r$ 为压缩比，$R_{IO}$ 为 I/O 带宽，$T_{IO}$ 为 I/O 时间。\n\n给定的值为：\n- $N = 512^3$\n- $B_s = 4$ 字节\n- $C_r = 10$\n- $R_{IO} = 100 \\text{ GB/s}$\n- 从字节到吉字节的转换因子是 $1 \\text{ GB} = 10^9 \\text{ 字节}$。\n\n需要确定的三个量是：\n1. $S_u$，以 GB 为单位。\n2. $S_c$，以 GB 为单位。\n3. 压缩数据的 $T_{IO}$，以秒为单位。\n\n**1. 未压缩数据大小 ($S_u$)**\n\n根据所给定义，未压缩数据的大小（以字节为单位）是样本数与每样本字节数的乘积。\n$$S_{u, \\text{bytes}} = N \\times B_s$$\n代入给定值：\n$$S_{u, \\text{bytes}} = 512^3 \\times 4$$\n由于 $512 = 2^9$，我们有：\n$$S_{u, \\text{bytes}} = (2^9)^3 \\times 2^2 = 2^{27} \\times 2^2 = 2^{29} \\text{ bytes}$$\n$$S_{u, \\text{bytes}} = 536,870,912 \\text{ bytes}$$\n为了将此大小转换为吉字节（GB），我们除以 $10^9$。\n$$S_u = \\frac{S_{u, \\text{bytes}}}{10^9} = \\frac{536,870,912}{10^9} \\text{ GB}$$\n$$S_u = 0.536870912 \\text{ GB}$$\n按要求四舍五入到四位有效数字：\n$$S_u \\approx 0.5369 \\text{ GB}$$\n\n**2. 压缩后数据大小 ($S_c$)**\n\n压缩比定义为未压缩大小除以压缩后大小。\n$$C_r = \\frac{S_u}{S_c}$$\n整理以求压缩后大小 $S_c$：\n$$S_c = \\frac{S_u}{C_r}$$\n为确保准确性，使用 $S_u$ 的未四舍五入值和给定的 $C_r$：\n$$S_c = \\frac{0.536870912 \\text{ GB}}{10}$$\n$$S_c = 0.0536870912 \\text{ GB}$$\n四舍五入到四位有效数字：\n$$S_c \\approx 0.05369 \\text{ GB}$$\n\n**3. 缩减的 I/O 时间 ($T_{IO}$)**\n\nI/O 时间定义为要写入的数据大小除以持续 I/O 带宽。要写入的数据是压缩数据集，因此其大小为 $S_c$。\n$$T_{IO} = \\frac{S_c}{R_{IO}}$$\n单位是一致的（$S_c$ 以 GB 为单位，$R_{IO}$ 以 GB/s 为单位），所以结果时间将以秒为单位。\n为确保准确性，使用 $S_c$ 的未四舍五入值：\n$$T_{IO} = \\frac{0.0536870912 \\text{ GB}}{100 \\text{ GB/s}}$$\n$$T_{IO} = 0.000536870912 \\text{ s}$$\n四舍五入到四位有效数字：\n$$T_{IO} \\approx 0.0005369 \\text{ s}$$\n\n所要求的三个量，四舍五入到四位有效数字后，分别为 $0.5369$，$0.05369$ 和 $0.0005369$。这些将按规定以行矩阵形式呈现。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.5369  0.05369  0.0005369\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在确立了数据约减的必要性之后，一个关键问题随之而来：“我们的约减损失了多少信息？”。这项实践引入了一个核心的保真度度量——归一化均方误差（$NMSE$），用于定量评估约减后数据的质量。通过一个具体的例子，你将学会如何将一个数学上的误差度量与物理量的保持（例如湍流能谱）联系起来，这是设计可靠原位工作流的一项关键技能。",
            "id": "3994958",
            "problem": "在磁流体力学（MHD）湍流模拟中部署了一个高性能计算原位工作流，以减少诊断数据的移动，同时保留与输运分析相关的谱能量特性。该工作流对单个快照中平面外磁场分量 $B_{z}$ 的一维线切片应用基于物理信息的稀疏变换和阈值化，从而生成一个降维数据集。考虑一个离散实值向量 $x \\in \\mathbb{R}^{N}$，它表示沿网格线对 $B_{z}$ 的均匀间隔采样，以及其原位降维重构 $\\hat{x} \\in \\mathbb{R}^{N}$。归一化均方误差（NMSE）由核心信号处理量定义为\n$$\nNMSE \\equiv \\frac{\\|x - \\hat{x}\\|_{2}^{2}}{\\|x\\|_{2}^{2}},\n$$\n其中 $\\|\\cdot\\|_{2}$ 表示欧几里得范数。根据标准离散傅里叶变换的约定，Parseval定理指出，物理空间中的总能量在不考虑归一化常数的情况下等于频谱空间中的总能量；因此，NMSE 的一个界限为积分谱能量的相对误差提供了一个界限。\n\n假设在 $N=6$ 个点处的模拟线切片及其降维重构为\n$$\nx = \\begin{pmatrix} 3.0 \\\\ -2.0 \\\\ 4.0 \\\\ 1.0 \\\\ -5.0 \\\\ 2.0 \\end{pmatrix}, \\qquad\n\\hat{x} = \\begin{pmatrix} 2.9 \\\\ -1.95 \\\\ 4.05 \\\\ 0.9 \\\\ -5.05 \\\\ 2.1 \\end{pmatrix}.\n$$\n\n使用上述核心定义，计算此次降维的 $NMSE$。然后，通过使用阈值 $NMSE \\leq 10^{-3}$ 来判断该降维是否以所需保真度保留了能谱。在此工作流中采用该阈值是为了确保在Parseval等价性的意义下，积分谱能量的相对误差被限制在最多 $10^{-3}$。\n\n报告两个量：\n- 标量 $NMSE$，四舍五入到四位有效数字。此值无量纲，不包含单位。\n- 指示符 $I$，定义为如果 $NMSE \\leq 10^{-3}$ 则 $I = 1$，否则 $I = 0$。将 $I$ 报告为精确整数。\n\n将你的最终答案表示为一个二元行矩阵 $\\begin{pmatrix} NMSE  I \\end{pmatrix}$。",
            "solution": "问题要求计算两个量：给定数据降维过程的归一化均方误差（$NMSE$），以及一个用于判断 $NMSE$ 是否满足指定保真度阈值的二进制指示符 $I$。\n\n问题提供了以下定义和数据：\n原始数据向量为 $x \\in \\mathbb{R}^{N}$，其降维重构为 $\\hat{x} \\in \\mathbb{R}^{N}$，其中 $N=6$。向量给定如下：\n$$\nx = \\begin{pmatrix} 3.0 \\\\ -2.0 \\\\ 4.0 \\\\ 1.0 \\\\ -5.0 \\\\ 2.0 \\end{pmatrix}, \\qquad\n\\hat{x} = \\begin{pmatrix} 2.9 \\\\ -1.95 \\\\ 4.05 \\\\ 0.9 \\\\ -5.05 \\\\ 2.1 \\end{pmatrix}\n$$\n归一化均方误差定义为：\n$$\nNMSE \\equiv \\frac{\\|x - \\hat{x}\\|_{2}^{2}}{\\|x\\|_{2}^{2}}\n$$\n指示变量 $I$ 定义为如果 $NMSE \\leq 10^{-3}$ 则 $I = 1$，否则 $I = 0$。\n\n首先，我们计算 $NMSE$ 表达式的分子，即误差向量 $x - \\hat{x}$ 的欧几里得范数的平方。\n令误差向量为 $d = x - \\hat{x}$。\n$$\nd = \\begin{pmatrix} 3.0 - 2.9 \\\\ -2.0 - (-1.95) \\\\ 4.0 - 4.05 \\\\ 1.0 - 0.9 \\\\ -5.0 - (-5.05) \\\\ 2.0 - 2.1 \\end{pmatrix} = \\begin{pmatrix} 0.1 \\\\ -0.05 \\\\ -0.05 \\\\ 0.1 \\\\ 0.05 \\\\ -0.1 \\end{pmatrix}\n$$\n$d$ 的欧几里得范数的平方是其各分量平方之和：\n$$\n\\|x - \\hat{x}\\|_{2}^{2} = \\|d\\|_{2}^{2} = (0.1)^{2} + (-0.05)^{2} + (-0.05)^{2} + (0.1)^{2} + (0.05)^{2} + (-0.1)^{2}\n$$\n$$\n\\|x - \\hat{x}\\|_{2}^{2} = 0.01 + 0.0025 + 0.0025 + 0.01 + 0.0025 + 0.01 = 0.0375\n$$\n\n接下来，我们计算 $NMSE$ 表达式的分母，即原始数据向量 $x$ 的欧几里得范数的平方。\n$$\n\\|x\\|_{2}^{2} = (3.0)^{2} + (-2.0)^{2} + (4.0)^{2} + (1.0)^{2} + (-5.0)^{2} + (2.0)^{2}\n$$\n$$\n\\|x\\|_{2}^{2} = 9.0 + 4.0 + 16.0 + 1.0 + 25.0 + 4.0 = 59.0\n$$\n\n现在，我们可以计算 $NMSE$：\n$$\nNMSE = \\frac{0.0375}{59.0} \\approx 0.0006355932...\n$$\n问题要求将此值四舍五入到四位有效数字。前四位有效数字是 $6$、$3$、$5$ 和 $5$。第五位有效数字是 $9$，大于或等于 $5$，因此我们将第四位数字向上取整。\n$$\nNMSE \\approx 0.0006356\n$$\n用科学记数法表示，这便是 $6.356 \\times 10^{-4}$。\n\n最后，我们确定指示符 $I$ 的值。条件是 $NMSE \\leq 10^{-3}$。阈值为 $10^{-3} = 0.001$。\n我们将计算出的 $NMSE$ 与此阈值进行比较：\n$$\n0.0006356 \\leq 0.001\n$$\n这个不等式成立。因此，根据定义，指示符 $I$ 为 $1$。\n\n所需的两个量是 $NMSE = 6.356 \\times 10^{-4}$ 和 $I=1$。",
            "answer": "$$\\boxed{\\begin{pmatrix} 6.356 \\times 10^{-4}  1 \\end{pmatrix}}$$"
        },
        {
            "introduction": "真实世界的高性能计算环境是动态变化的，数据生成速率和系统处理能力都可能波动。这项高级实践将超越静态约减技术，引导你设计一个智能的自适应工作流。你将基于控制理论，开发一个能根据系统实时状态（如处理队列长度 $q_k$）动态调整数据约减率 $r_k$ 的反馈控制器，以确保系统的稳定性和效率。通过理论推导和编程实现，这项练习将理论与实践相结合，展示了构建稳健的、可用于生产环境的科学工作流的前沿方法。",
            "id": "3994971",
            "problem": "考虑一个用于计算聚变科学与工程的高性能计算（HPC）管道中的原位数据约减控制器，其中流式诊断数据在进入处理队列前必须被约减，以避免下游处理能力过载。设队列长度由一个非负离散时间状态 $q_k$ 表示，单位为千兆字节（GB），该状态根据守恒定律（质量平衡）和非负性约束，以 $\\Delta t = 1\\,\\mathrm{s}$ 的时间步长更新\n$$\nq_{k+1} = \\max\\!\\Big(0,\\; q_k + \\Delta t\\big(\\lambda_\\mathrm{eff}(k) - \\mu(k)\\big)\\Big),\n$$\n其中 $\\lambda_\\mathrm{eff}(k) = r_k\\,\\lambda(k)$ 是约减后的有效到达率，$\\lambda(k)$ 是输入数据率（单位：GB/s），$\\mu(k)$ 是下游服务容量（单位：GB/s），而 $r_k\\in[0,1]$ 是在时间 $k$ 的约减比，解释为约减后保留的数据分数。控制目标是仅使用当前测量值 $(q_k,\\lambda(k),\\mu(k))$ 和一个可调标量参数 $\\gamma \\in (0,1)$ 来为 $r_k$ 设计一个反馈律，使得闭环队列动态对平衡点 $q^\\star = 0$ 是全局渐近稳定的，并且有效到达率在每一步都保持在服务容量以下，即 $\\lambda_\\mathrm{eff}(k) \\le \\mu(k)$。使用离散时间李雅普诺夫方法对队列长度动态进行稳定性论证。论证需从质量平衡更新和非负性约束的基本出发点开始，且不援引快捷公式。\n\n然后，您必须实现所推导的控制器，并对以下包含三个案例的确定性测试套件进行闭环动态仿真。在所有案例中，使用 $\\Delta t = 1\\,\\mathrm{s}$，并将所有结果以千兆字节（GB）表示。正弦定义中出现的角度，单位为弧度。\n\n为每个测试案例定义以下序列和参数：\n- 案例A（具有突发流量的一般可变性）：$T = 300$, $q_0 = 20\\,\\mathrm{GB}$, $\\mu(k) = 5\\,\\mathrm{GB/s}$ 对所有 $k$, $\\lambda(k) = L_0 + A\\sin\\!\\big(2\\pi k / 25\\big) + B(k)$，其中 $L_0 = 6\\,\\mathrm{GB/s}$, $A = 2\\,\\mathrm{GB/s}$，并且 $B(k)$ 在 $k\\in\\{50,51,52,53,54,150,151,152,153,154\\}$ 时等于 $5\\,\\mathrm{GB/s}$，否则为 $0\\,\\mathrm{GB/s}$。使用 $\\gamma = 0.3$。\n- 案例B（次容量状态）：$T = 200$, $q_0 = 10\\,\\mathrm{GB}$, $\\mu(k) = 5\\,\\mathrm{GB/s}$ 对所有 $k$, $\\lambda(k) = 3 + 0.5\\sin\\!\\big(2\\pi k / 30\\big)$，单位为 $\\mathrm{GB/s}$。使用 $\\gamma = 0.4$。\n- 案例C（容量下降伴随大突发流量）：$T = 400$, $q_0 = 0\\,\\mathrm{GB}$, $\\mu(k) = 0\\,\\mathrm{GB/s}$ 对 $k\\in\\{100,101,\\dots,110\\}$，否则 $\\mu(k)=4\\,\\mathrm{GB/s}$，$\\lambda(k) = L_0 + A\\sin\\!\\big(2\\pi k / 20\\big) + B(k)$，其中 $L_0 = 10\\,\\mathrm{GB/s}$, $A = 5\\,\\mathrm{GB/s}$，并且 $B(k)$ 在 $k\\in\\{80,81,\\dots,90,250,251,\\dots,260\\}$ 时等于 $15\\,\\mathrm{GB/s}$，否则为 $0\\,\\mathrm{GB/s}$。使用 $\\gamma = 0.6$。\n\n您的程序必须：\n- 实现所推导的反馈控制器 $r_k$，并对每个案例进行队列动态仿真。\n- 为保证数值安全性，通过任何能保持物理意义（即无论 $r_k$ 为何值，无数据到达意味着 $\\lambda_\\mathrm{eff}(k)=0$）的明确约定来处理 $\\lambda(k)=0$ 的情况。\n- 生成单行输出，其中包含每个案例的最终队列长度 $q_T$（单位为GB），形式为用方括号括起来的逗号分隔列表。将每个数字四舍五入到三位小数。例如，输出格式必须类似于 $[x_A,x_B,x_C]$，其中 $x_A$、$x_B$、$x_C$ 分别是案例 A、B 和 C 的最终队列长度（单位为GB），并四舍五入到三位小数。",
            "solution": "问题陈述经评估有效。它在科学上基于控制理论和排队模型的既定原理，问题设定良好，为理论推导和数值仿真提供了所有必要信息，且其语言和目标均客观。未发现与科学不健全、不完整、矛盾或模糊相关的问题。因此，我们可以着手解决。\n\n目标是为约减比 $r_k \\in [0, 1]$ 设计一个反馈控制律，以确保队列长度 $q_k$ 对平衡点 $q^\\star=0$ 的全局渐近稳定性，并受限于有效到达率不超过服务容量的约束，即 $\\lambda_\\mathrm{eff}(k) \\le \\mu(k)$。$r_k$ 的控制律必须仅使用当前可用的信息，即状态 $q_k$ 和系统参数 $\\lambda(k)$ 及 $\\mu(k)$。\n\n系统动态由以下离散时间更新方程给出：\n$$\nq_{k+1} = \\max\\!\\Big(0,\\; q_k + \\Delta t\\big(\\lambda_\\mathrm{eff}(k) - \\mu(k)\\big)\\Big)\n$$\n其中 $\\lambda_\\mathrm{eff}(k) = r_k \\lambda(k)$ 且 $\\Delta t = 1\\,\\mathrm{s}$。根据定义，状态 $q_k$ 是非负的。\n\n为证明稳定性，我们采用一个离散时间李雅普诺夫函数。对于一个状态为非负量且目标是将其驱动到零的系统，一个自然的选择是状态本身。设候选李雅普诺夫函数为 $V(q_k) = q_k$。\n要使其成为一个有效的李雅普诺夫函数，必须满足：\n1.  对于所有 $q_k  0$，$V(q_k)  0$ 且 $V(0) = 0$。由于 $q_k$ 代表物理队列长度，它是非负的，因此该条件得到满足。\n2.  李雅普诺夫差分 $\\Delta V_k = V(q_{k+1}) - V(q_k) = q_{k+1} - q_k$ 必须是负定的，即对于 $q_k  0$ 时，$\\Delta V_k  0$。\n\n我们为 $r_k$ 设计的控制必须确保此条件。反馈控制中的一个常用策略是对状态强制施加指数衰减。我们寻求一个控制律，试图在 $q_k  0$ 时强制实现关系 $q_{k+1} \\approx (1-\\gamma)q_k$，其中 $\\gamma \\in (0,1)$ 是某个速率参数。\n\n我们暂时假设 $\\max(0, \\cdot)$ 操作不激活，即 $q_k + \\Delta t(\\lambda_\\mathrm{eff}(k) - \\mu(k))  0$。那么 $q_{k+1} = q_k + \\Delta t(\\lambda_\\mathrm{eff}(k) - \\mu(k))$。为达到期望的衰减，我们设定：\n$$\nq_k + \\Delta t\\big(\\lambda_\\mathrm{eff}(k) - \\mu(k)\\big) = (1-\\gamma)q_k\n$$\n求解期望的有效到达率 $\\lambda_\\mathrm{eff}^\\mathrm{des}(k)$，可得：\n$$\n\\Delta t\\big(\\lambda_\\mathrm{eff}^\\mathrm{des}(k) - \\mu(k)\\big) = -\\gamma q_k\n$$\n$$\n\\lambda_\\mathrm{eff}^\\mathrm{des}(k) = \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\n$$\n有效到达率不能为负，所以我们必须取其正部：\n$$\n\\lambda_\\mathrm{eff}^\\mathrm{des}(k) = \\max\\left(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\\right)\n$$\n实际的有效到达率 $\\lambda_\\mathrm{eff}(k) = r_k \\lambda(k)$ 也受限于输入数据率 $\\lambda(k)$，即 $\\lambda_\\mathrm{eff}(k) \\le \\lambda(k)$。因此，最接近我们期望速率的可实现有效速率是：\n$$\n\\lambda_\\mathrm{eff}(k) = \\min\\left(\\lambda(k), \\max\\left(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\\right)\\right)\n$$\n由此，我们推导出 $r_k$ 的控制律。假设 $\\lambda(k)  0$：\n$$\nr_k = \\frac{\\lambda_\\mathrm{eff}(k)}{\\lambda(k)} = \\frac{1}{\\lambda(k)} \\min\\left(\\lambda(k), \\max\\left(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\\right)\\right)\n$$\n这可以通过将 $1/\\lambda(k)$ 项移入最小值函数内部来重写：\n$$\nr_k = \\min\\left(1, \\frac{1}{\\lambda(k)}\\max\\left(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\\right)\\right)\n$$\n$$\nr_k = \\min\\left(1, \\max\\left(0, \\frac{\\mu(k)}{\\lambda(k)} - \\frac{\\gamma q_k}{\\Delta t \\lambda(k)}\\right)\\right)\n$$\n这等效于对目标控制值进行饱和处理：\n$$\nr_k = \\mathrm{sat}_{[0,1]}\\left(\\frac{\\mu(k)}{\\lambda(k)} - \\frac{\\gamma q_k}{\\Delta t \\lambda(k)}\\right)\n$$\n如果 $\\lambda(k)=0$，该表达式是奇异的。然而，在这种情况下，对于任何有效的 $r_k \\in [0,1]$，都有 $\\lambda_\\mathrm{eff}(k) = r_k \\cdot 0 = 0$。我们期望的速率公式也得出 $\\lambda_\\mathrm{eff}(k)=0$，因此逻辑是一致的。我们采用一个约定，即如果 $\\lambda(k)=0$，我们可以设置 $r_k=1$，这同样导致 $\\lambda_\\mathrm{eff}(k)=0$。\n\n现在我们来正式证明使用此控制器的闭环系统的稳定性。\n\n**稳定性分析：**\n设 $V(q_k) = q_k$。我们分析 $\\Delta V_k = q_{k+1} - q_k$。控制器设置 $\\lambda_\\mathrm{eff}(k) = r_k \\lambda(k)$。\n我们来分析动态方程中max函数内部的项：\n$q_k + \\Delta t(\\lambda_\\mathrm{eff}(k) - \\mu(k)) = q_k + \\Delta t \\left(\\min\\left(\\lambda(k), \\max\\left(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}\\right)\\right) - \\mu(k)\\right)$。\n我们考虑项 $\\mu(k) - \\frac{\\gamma q_k}{\\Delta t}$ 的两种主要情况。\n\n情况1：$\\mu(k) - \\frac{\\gamma q_k}{\\Delta t}  0$。\n在这种情况下，$\\lambda_\\mathrm{eff}(k) = \\min(\\lambda(k), \\mu(k) - \\frac{\\gamma q_k}{\\Delta t})$。\n子情况1a：$\\lambda(k) \\le \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}$。这对应于 $r_k=1$。\n那么 $\\lambda_\\mathrm{eff}(k) = \\lambda(k)$。更新项变为 $q_k + \\Delta t(\\lambda(k) - \\mu(k))$。根据子情况的条件，$\\lambda(k) - \\mu(k) \\le -\\frac{\\gamma q_k}{\\Delta t}$。因此，$q_k + \\Delta t(\\lambda(k) - \\mu(k)) \\le q_k - \\gamma q_k = (1-\\gamma)q_k$。\n由于 $\\gamma \\in (0,1)$ 且 $q_k \\ge 0$，我们有 $0 \\le (1-\\gamma)q_k \\le q_k$。\n那么 $q_{k+1} = \\max(0, q_k + \\Delta t(\\lambda(k) - \\mu(k))) \\le (1-\\gamma)q_k$。\n李雅普诺夫差分为 $\\Delta V_k = q_{k+1} - q_k \\le (1-\\gamma)q_k - q_k = -\\gamma q_k$。\n\n子情况1b：$\\lambda(k)  \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}$。这对应于 $0  r_k  1$。\n那么 $\\lambda_\\mathrm{eff}(k) = \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}$。\n更新项变为 $q_k + \\Delta t((\\mu(k) - \\frac{\\gamma q_k}{\\Delta t}) - \\mu(k)) = q_k - \\gamma q_k = (1-\\gamma)q_k$。\n和之前一样，这是非负的，所以 $q_{k+1} = (1-\\gamma)q_k$。\n李雅普诺夫差分为 $\\Delta V_k = q_{k+1} - q_k = -\\gamma q_k$。\n\n情况2：$\\mu(k) - \\frac{\\gamma q_k}{\\Delta t} \\le 0$。\n在这种情况下，$\\max(0, \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}) = 0$。这对应于 $r_k=0$。\n那么 $\\lambda_\\mathrm{eff}(k) = \\min(\\lambda(k), 0) = 0$。\n更新项变为 $q_k + \\Delta t(0 - \\mu(k)) = q_k - \\Delta t \\mu(k)$。\n所以 $q_{k+1} = \\max(0, q_k - \\Delta t \\mu(k))$。\n李雅普诺夫差分为 $\\Delta V_k = q_{k+1} - q_k = \\max(0, q_k - \\Delta t \\mu(k)) - q_k$。\n如果 $q_k - \\Delta t \\mu(k) \\ge 0$，$\\Delta V_k = (q_k - \\Delta t \\mu(k)) - q_k = -\\Delta t \\mu(k) \\le 0$（因为 $\\mu(k) \\ge 0$）。\n如果 $q_k - \\Delta t \\mu(k)  0$，$\\Delta V_k = 0 - q_k = -q_k  0$（对于 $q_k  0$）。\n在所有子情况中，对于 $q_k  0$，我们都有 $\\Delta V_k \\le 0$。\n\n这表明 $V(q_k)$ 是一个非增函数，从而证明了李雅普诺夫意义下的稳定性。为建立渐近稳定性，我们援引离散时间系统的 LaSalle 不变性原理。设 $E = \\{q \\ge 0 \\mid \\Delta V(q) = 0\\}$。\n根据我们的分析，$\\Delta V_k = 0$ 当且仅当以下情况之一成立：\n(i) $q_k = 0$。\n(ii) $q_k  0$，且情况2的条件适用（$r_k=0$），同时 $\\mu(k)=0$。如果 $\\mu(k)=0$，那么 $q_{k+1} = \\max(0, q_k) = q_k$，因此 $\\Delta V_k = 0$。\n\n系统轨迹必须收敛到包含在 $E$ 中的最大不变集 $M$。一个轨迹只有在对所有 $j \\ge k$ 都有 $q_j$ 恒定，且要求对所有 $j \\ge k$ 都有 $\\mu(j)=0$ 的情况下，才能保持在集合 $\\{q  0\\} \\cap E$ 中。假设下游处理能力不是永久为零（即条件 $\\mu(k)=0$ 不会对于所有 $k \\to \\infty$ 持续存在），那么没有轨迹可以无限期地停留在 $\\{q  0\\} \\cap E$ 中。因此，$E$ 中唯一的不变集是单点集 $M = \\{0\\}$。根据 LaSalle 不变性原理，所有从任意 $q_0 \\ge 0$ 开始的轨迹都必须收敛到 $M$，这意味着 $\\lim_{k \\to \\infty} q_k = 0$。这证明了平衡点 $q^\\star=0$ 的全局渐近稳定性。\n\n最后，设计约束 $\\lambda_\\mathrm{eff}(k) \\le \\mu(k)$ 得到满足。\n如果 $r_k=1$，根据构造（子情况1a），此约束成立。\n如果 $0 \\le r_k  1$，则 $\\lambda_\\mathrm{eff}(k) \\le \\mu(k) - \\frac{\\gamma q_k}{\\Delta t}$。由于 $\\gamma, q_k, \\Delta t$ 都是非负的，$\\frac{\\gamma q_k}{\\Delta t} \\ge 0$，这意味着 $\\lambda_\\mathrm{eff}(k) \\le \\mu(k)$。该约束对所有 $k$ 都成立。\n\n现在将实现所推导的控制器，以仿真所提供的测试案例。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements the derived feedback controller and simulates the closed-loop \n    queue dynamics for three test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"name\": \"Case A\",\n            \"T\": 300,\n            \"q0\": 20.0,\n            \"gamma\": 0.3,\n            \"mu_func\": lambda k: 5.0,\n            \"lambda_func\": lambda k: 6.0 + 2.0 * np.sin(2 * np.pi * k / 25) + \\\n                                   (5.0 if (50 = k = 54) or (150 = k = 154) else 0.0),\n        },\n        {\n            \"name\": \"Case B\",\n            \"T\": 200,\n            \"q0\": 10.0,\n            \"gamma\": 0.4,\n            \"mu_func\": lambda k: 5.0,\n            \"lambda_func\": lambda k: 3.0 + 0.5 * np.sin(2 * np.pi * k / 30),\n        },\n        {\n            \"name\": \"Case C\",\n            \"T\": 400,\n            \"q0\": 0.0,\n            \"gamma\": 0.6,\n            \"mu_func\": lambda k: 0.0 if 100 = k = 110 else 4.0,\n            \"lambda_func\": lambda k: 10.0 + 5.0 * np.sin(2 * np.pi * k / 20) + \\\n                                   (15.0 if (80 = k = 90) or (250 = k = 260) else 0.0),\n        }\n    ]\n\n    final_queue_lengths = []\n    delta_t = 1.0  # Time step in seconds, as given\n\n    for case in test_cases:\n        T = case[\"T\"]\n        q_k = case[\"q0\"]\n        gamma = case[\"gamma\"]\n        mu_func = case[\"mu_func\"]\n        lambda_func = case[\"lambda_func\"]\n\n        # Simulation loop from k=0 to T-1\n        for k in range(T):\n            lambda_k = lambda_func(k)\n            mu_k = mu_func(k)\n\n            # --- Controller Logic ---\n            # Calculate reduction ratio r_k\n            if lambda_k = 1e-9:  # Numerical safety for lambda(k) approx 0\n                r_k = 1.0  # Convention: effective rate will be 0 anyway\n            else:\n                # Target reduction ratio based on the derived control law\n                r_k_target = (mu_k / lambda_k) - (gamma * q_k) / (delta_t * lambda_k)\n                # Saturate to the valid range [0, 1]\n                r_k = np.clip(r_k_target, 0.0, 1.0)\n\n            # --- System Dynamics ---\n            # Calculate effective arrival rate\n            lambda_eff_k = r_k * lambda_k\n\n            # Update queue length q_k -> q_{k+1}\n            q_k = np.maximum(0.0, q_k + delta_t * (lambda_eff_k - mu_k))\n\n        # After T steps, the final queue length is q_T\n        final_queue_lengths.append(q_k)\n\n    # Format the output as specified: [x_A,x_B,x_C] rounded to 3 decimal places.\n    formatted_results = [f\"{q:.3f}\" for q in final_queue_lengths]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}