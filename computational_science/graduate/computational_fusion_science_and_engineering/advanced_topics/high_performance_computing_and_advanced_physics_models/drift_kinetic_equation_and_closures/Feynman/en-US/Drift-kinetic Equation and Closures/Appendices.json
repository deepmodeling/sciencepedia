{
    "hands_on_practices": [
        {
            "introduction": "To bridge the gap between kinetic theory and fluid models, we introduce \"closures,\" which express higher-order moments like heat flux in terms of lower-order ones like temperature. This first practice explores the fundamental difference between local and nonlocal closures for parallel heat transport. You will implement and compare the classical local Spitzer–Härm model, valid in highly collisional plasmas, with a nonlocal model derived from kinetic theory, observing how nonlocal effects become dominant as collisionality decreases.",
            "id": "3969012",
            "problem": "Consider a straight, uniform magnetic field line parameterized by a one-dimensional (1D) coordinate $s \\in [0,L]$ with periodic boundary conditions. In steady state, the parallel energy balance is given by the conservation law $\\partial_s q(s) = S(s)$, where $q(s)$ is the parallel heat flux (in $\\mathrm{W}/\\mathrm{m}^2$) and $S(s)$ is a volumetric heating source (in $\\mathrm{W}/\\mathrm{m}^3$). The electron temperature $T(s)$ (in $\\mathrm{K}$) is determined by a closure for $q(s)$ derived from the drift-kinetic equation. You will compare two closures:\n\n- A local closure, consistent with Spitzer–Härm theory, where the heat flux is proportional to the local gradient $\\partial_s T(s)$.\n- A nonlocal closure derived from a linearized drift-kinetic equation with a Bhatnagar–Gross–Krook (BGK) collision operator, which introduces a mode-dependent suppression of conduction over the parallel mean free path.\n\nThe fundamental base for the derivation consists of:\n- The drift-kinetic equation for the electron distribution function $f(s,v_{\\parallel})$ along the field line, linearized about a Maxwellian background, in steady state, with a BGK collision term of frequency $\\nu$.\n- Fourier analysis on a periodic domain and energy conservation $\\partial_s q = S$.\n- The standard local constitutive relation between $q$ and $\\partial_s T$ in the collisional limit.\n\nLet the domain length be $L = 2\\,\\mathrm{m}$, the constant parallel thermal conductivity be $\\kappa_{\\parallel} = 200\\,\\mathrm{W}/(\\mathrm{m}\\cdot\\mathrm{K})$, and the source be mean-free (zero spatial average) with the form\n$$\nS(s) = S_0\\left[\\sin\\left(\\frac{2\\pi s}{L}\\right) + \\frac{1}{2}\\sin\\left(\\frac{4\\pi s}{L}\\right)\\right],\n$$\nwhere $S_0 = 1000\\,\\mathrm{W}/\\mathrm{m}^3$.\n\nDefine the effective collisionality as the dimensionless parameter\n$$\n\\nu^\\ast \\equiv \\frac{L}{\\lambda},\n$$\nwhere $\\lambda$ is the parallel mean free path. Very large $\\nu^\\ast$ corresponds to highly collisional conditions and very small $\\nu^\\ast$ corresponds to collisionless, nonlocal conduction.\n\nTasks:\n1. Starting from the drift-kinetic equation with the BGK operator in steady state, derive the nonlocal closure in Fourier space for $q$ as a function of the wavenumber magnitude $|k|$ and mean free path $\\lambda$, and use this to obtain a closed equation for $T(s)$ in Fourier space that correctly reduces to the local collisional limit when $\\lambda \\to 0$.\n2. Implement a periodic Fourier-spectral solver that, given $S(s)$, computes $T_{\\mathrm{local}}(s)$ using the local closure and $T_{\\mathrm{nonlocal}}(s)$ using the nonlocal closure derived in Task 1. Ensure the zero-wavenumber component is treated consistently with energy conservation (i.e., $S$ has zero mean, so the $k=0$ temperature mode is set to zero reference).\n3. Quantify the discrepancy between the local and nonlocal solutions by computing the normalized root-mean-square difference\n$$\nD(\\nu^\\ast) \\equiv \\left[\\frac{\\int_0^L \\left(T_{\\mathrm{nonlocal}}(s) - T_{\\mathrm{local}}(s)\\right)^2 \\,\\mathrm{d}s}{\\int_0^L T_{\\mathrm{local}}(s)^2 \\,\\mathrm{d}s}\\right]^{1/2},\n$$\nwhich is dimensionless.\n\nPhysical units: Use the given values in International System of Units (SI). The final discrepancy values $D(\\nu^\\ast)$ are dimensionless and must be reported as decimal numbers.\n\nAngle unit: All angles in trigonometric functions are in radians.\n\nTest suite:\n- Use the collisionality values $\\nu^\\ast \\in \\{0.01,\\,0.1,\\,1,\\,10,\\,100\\}$, corresponding to mean free paths $\\lambda = L/\\nu^\\ast$.\n- For each $\\nu^\\ast$ in the test suite, compute $D(\\nu^\\ast)$ as specified above.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[0.123,0.456,0.789,1.234,5.678]\").\n- Each entry should be a float in decimal form.",
            "solution": "The user-provided problem statement is subjected to validation.\n\n### Step 1: Extract Givens\n- **Domain:** A one-dimensional spatial coordinate $s \\in [0,L]$ with periodic boundary conditions.\n- **Governing Equation:** The steady-state parallel energy balance is $\\partial_s q(s) = S(s)$.\n- **Variables:** $q(s)$ is the parallel heat flux, $S(s)$ is a volumetric heating source, and $T(s)$ is the electron temperature.\n- **Parameters and Functions:**\n  - Domain length: $L = 2\\,\\mathrm{m}$.\n  - Constant parallel thermal conductivity: $\\kappa_{\\parallel} = 200\\,\\mathrm{W}/(\\mathrm{m}\\cdot\\mathrm{K})$.\n  - Volumetric heat source: $S(s) = S_0\\left[\\sin\\left(\\frac{2\\pi s}{L}\\right) + \\frac{1}{2}\\sin\\left(\\frac{4\\pi s}{L}\\right)\\right]$, with $S_0 = 1000\\,\\mathrm{W}/\\mathrm{m}^3$.\n- **Closures:**\n  - Local (Spitzer–Härm): $q(s)$ is proportional to the local gradient $\\partial_s T(s)$.\n  - Nonlocal (BGK-derived): Introduces mode-dependent suppression of conduction.\n- **Definitions:**\n  - Effective collisionality: $\\nu^\\ast \\equiv L/\\lambda$, where $\\lambda$ is the parallel mean free path.\n- **Tasks:**\n  1. Derive the nonlocal closure for $q(s)$ in Fourier space and obtain a closed equation for $T(s)$.\n  2. Implement a periodic Fourier-spectral solver for the temperature profiles $T_{\\mathrm{local}}(s)$ and $T_{\\mathrm{nonlocal}}(s)$.\n  3. Compute the normalized root-mean-square difference $D(\\nu^\\ast) \\equiv \\left[\\frac{\\int_0^L \\left(T_{\\mathrm{nonlocal}}(s) - T_{\\mathrm{local}}(s)\\right)^2 \\,\\mathrm{d}s}{\\int_0^L T_{\\mathrm{local}}(s)^2 \\,\\mathrm{d}s}\\right]^{1/2}$.\n- **Test Suite:** $\\nu^\\ast \\in \\{0.01,\\,0.1,\\,1,\\,10,\\,100\\}$.\n- **Boundary Conditions/Constraints:** Periodic boundary conditions. The source $S(s)$ has a zero spatial average. The $k=0$ (zero-wavenumber) mode of the temperature solution is set to zero.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded:** The problem is rooted in fundamental plasma physics, specifically the kinetic theory of heat transport along magnetic field lines. The drift-kinetic equation, BGK collision operator, Spitzer-Härm conductivity, and the concept of nonlocal transport are all standard and well-established topics in fusion plasma science. The formulation is scientifically sound.\n2.  **Well-Posed:** The governing equation is a second-order elliptic-type problem on a periodic domain. The source term $S(s)$ correctly has a zero mean, satisfying the necessary condition for a steady-state solution on a periodic domain. The specification that the mean temperature ($\\hat{T}_{k=0}$) is zero removes the remaining ambiguity, making the problem well-posed for the temperature perturbation.\n3.  **Objective:** The problem is stated using precise mathematical and physical terminology. All parameters are defined quantitatively. There is no subjective or ambiguous language.\n4.  **Completeness:** All necessary physical constants ($L$, $\\kappa_\\parallel$, $S_0$), functional forms ($S(s)$), and computational tasks are explicitly defined. The problem is self-contained.\n5.  **Consistency:** The physical parameters and units are consistent within the SI system. The mathematical constraints (periodicity, zero-mean source) are mutually consistent.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. It is a well-defined and scientifically rigorous problem in computational plasma physics. I will now proceed with the solution.\n\n### Solution\n\nThe problem requires us to solve for the steady-state temperature profile $T(s)$ along a periodic one-dimensional domain under the influence of a heat source $S(s)$. The core of the problem lies in comparing a local and a nonlocal model for the heat flux $q(s)$, which closes the system of equations.\n\nThe governing equation is the energy conservation law:\n$$ \\frac{\\partial q(s)}{\\partial s} = S(s) $$\nSince the problem is posed on a periodic domain, Fourier analysis is the natural method of solution. A function $f(s)$ on $s \\in [0,L]$ can be represented by its Fourier series coefficients $\\hat{f}_k$, where $f(s) = \\sum_{k} \\frac{\\hat{f}_k}{L} e^{iks}$ and the wavenumbers are discrete multiples of the fundamental wavenumber, $k = \\frac{2\\pi n}{L}$ for integer $n$. The continuous Fourier transform is defined as $\\hat{f}(k) = \\int_0^L f(s) e^{-iks} ds$. Using this definition, differentiation in real space becomes multiplication in Fourier space: $\\widehat{\\partial_s f}(k) = ik\\hat{f}(k)$.\n\nApplying the Fourier transform to the energy balance equation, we get:\n$$ ik\\hat{q}_k = \\hat{S}_k $$\nThis relation holds for each wavenumber $k$ and must be satisfied by both the local and nonlocal models. Note that for $k=0$, the left side is zero, which implies $\\hat{S}_{k=0} = \\int_0^L S(s) ds = 0$. The given source term $S(s)$ consists of sinusoids with integer numbers of wavelengths on the domain, so its integral is indeed zero, satisfying this consistency condition.\n\n#### 1. Local and Nonlocal Closures in Fourier Space\n\n**Local Closure (Spitzer-Härm Model):**\nIn the collisional limit (short mean free path, $\\lambda \\to 0$), the heat flux is described by a local Fickian diffusion law, where it is proportional to the negative local temperature gradient.\n$$ q_{\\mathrm{local}}(s) = -\\kappa_{\\parallel} \\frac{\\partial T_{\\mathrm{local}}(s)}{\\partial s} $$\nwhere $\\kappa_{\\parallel}$ is the constant parallel thermal conductivity. In Fourier space, this relationship becomes:\n$$ \\hat{q}_{\\mathrm{local},k} = -\\kappa_{\\parallel} (ik) \\hat{T}_{\\mathrm{local},k} $$\nSubstituting this into the transformed energy balance equation gives:\n$$ ik \\left( -\\kappa_{\\parallel} ik \\hat{T}_{\\mathrm{local},k} \\right) = \\hat{S}_k $$\n$$ \\kappa_{\\parallel} k^2 \\hat{T}_{\\mathrm{local},k} = \\hat{S}_k $$\nFor any non-zero wavenumber ($k \\neq 0$), we can solve for the Fourier mode of the local temperature:\n$$ \\hat{T}_{\\mathrm{local},k} = \\frac{\\hat{S}_k}{\\kappa_{\\parallel} k^2} $$\nAs specified, the mean temperature is set to zero, so $\\hat{T}_{\\mathrm{local},k=0} = 0$.\n\n**Nonlocal Closure (BGK Model):**\nIn the weakly collisional (or collisionless) limit, the mean free path $\\lambda$ is comparable to or larger than the scale length of temperature variations. Particles carry energy over long distances, so the heat flux at a point $s$ depends on the temperature profile over a region around $s$. This is a nonlocal effect. Starting from the linearized drift-kinetic equation with a BGK collision operator, one can derive a closure for the heat flux. The result can be expressed as a modification to the conductivity in Fourier space, making it wavenumber-dependent.\n$$ \\hat{q}_{\\mathrm{nonlocal},k} = -ik \\kappa_{\\mathrm{eff}}(k) \\hat{T}_{\\mathrm{nonlocal},k} $$\nThe effective conductivity $\\kappa_{\\mathrm{eff}}(k)$ represents the suppression of heat transport at short wavelengths (large $|k|$). A widely used and physically motivated algebraic approximation for the BGK model's response is:\n$$ \\kappa_{\\mathrm{eff}}(k) = \\frac{\\kappa_{\\parallel}}{1 + |k|\\lambda} $$\nHere, $\\lambda$ is the mean free path. This form correctly captures the required physics:\n- For long wavelengths ($|k|\\lambda \\ll 1$), $\\kappa_{\\mathrm{eff}} \\approx \\kappa_{\\parallel}$, so the closure recovers the local model. This corresponds to the collisional limit where $\\lambda \\to 0$.\n- For short wavelengths ($|k|\\lambda \\gg 1$), $\\kappa_{\\mathrm{eff}} \\approx \\kappa_{\\parallel} / (|k|\\lambda)$, showing that conduction is strongly suppressed.\n\nUsing this nonlocal closure, the heat flux is:\n$$ \\hat{q}_{\\mathrm{nonlocal},k} = -ik \\hat{T}_{\\mathrm{nonlocal},k} \\frac{\\kappa_{\\parallel}}{1 + |k|\\lambda} $$\nSubstituting this into the energy balance equation:\n$$ ik \\left( -ik \\hat{T}_{\\mathrm{nonlocal},k} \\frac{\\kappa_{\\parallel}}{1 + |k|\\lambda} \\right) = \\hat{S}_k $$\n$$ \\frac{\\kappa_{\\parallel} k^2}{1 + |k|\\lambda} \\hat{T}_{\\mathrm{nonlocal},k} = \\hat{S}_k $$\nSolving for the nonlocal temperature modes ($k \\neq 0$):\n$$ \\hat{T}_{\\mathrm{nonlocal},k} = \\frac{\\hat{S}_k (1 + |k|\\lambda)}{\\kappa_{\\parallel} k^2} $$\nComparing this with the local solution, we see that $\\hat{T}_{\\mathrm{nonlocal},k} = \\hat{T}_{\\mathrm{local},k} (1 + |k|\\lambda)$. This clearly shows that nonlocal effects amplify the temperature perturbations for a given heat source, as conduction is less efficient. The mean temperature is again set to zero: $\\hat{T}_{\\mathrm{nonlocal},k=0} = 0$.\n\n#### 2. Algorithmic Design for the Fourier-Spectral Solver\n\nThe solution will be computed numerically using the Fast Fourier Transform (FFT) algorithm.\n1.  **Discretization:** The spatial domain $s \\in [0,L]$ is discretized into $N$ equally spaced points, $s_j = j (L/N)$ for $j = 0, 1, \\dots, N-1$.\n2.  **Source Term:** The source function $S(s)$ is evaluated on this grid to produce an array of values $S_j = S(s_j)$.\n3.  **Fourier Transform:** The FFT algorithm (`numpy.fft.fft`) is applied to the array $S_j$ to obtain its discrete Fourier coefficients, which are proportional to $\\hat{S}_k$. The corresponding array of wavenumbers $k$ is generated using `numpy.fft.fftfreq`.\n4.  **Solve in Fourier Space:** The Fourier coefficients of the temperature profiles are calculated using the derived algebraic expressions:\n    - A mask is used to handle the $k=0$ mode, setting $\\hat{T}_{k=0}=0$ and avoiding division by zero for other modes.\n    - For $k \\neq 0$:\n      - $\\hat{T}_{\\mathrm{local},k} = \\hat{S}_k / (\\kappa_{\\parallel} k^2)$\n      - $\\hat{T}_{\\mathrm{nonlocal},k} = \\hat{T}_{\\mathrm{local},k} (1 + |k|\\lambda)$\n    These operations are performed on the arrays of Fourier coefficients.\n5.  Although not required for the final calculation of $D(\\nu^\\ast)$, one could transform back to real space using the inverse FFT (`numpy.fft.ifft`) to obtain the temperature profiles $T_{\\mathrm{local}}(s_j)$ and $T_{\\mathrm{nonlocal}}(s_j)$.\n\n#### 3. Calculation of the Discrepancy $D(\\nu^\\ast)$\n\nThe normalized root-mean-square difference $D(\\nu^\\ast)$ is defined as:\n$$ D(\\nu^\\ast) = \\left[\\frac{\\int_0^L \\left(T_{\\mathrm{nonlocal}}(s) - T_{\\mathrm{local}}(s)\\right)^2 \\,\\mathrm{d}s}{\\int_0^L T_{\\mathrm{local}}(s)^2 \\,\\mathrm{d}s}\\right]^{1/2} $$\nComputing these integrals in Fourier space is both elegant and numerically superior. By Parseval's theorem, for a function $f(s)$ with Fourier transform $\\hat{f}(k)$, we have $\\int_0^L |f(s)|^2 ds = \\frac{1}{L} \\sum_k |\\hat{f}_k|^2$.\nLet $\\Delta T(s) = T_{\\mathrm{nonlocal}}(s) - T_{\\mathrm{local}}(s)$. Its Fourier transform is $\\Delta\\hat{T}_k = \\hat{T}_{\\mathrm{nonlocal},k} - \\hat{T}_{\\mathrm{local},k}$.\nThe expression for $D(\\nu^\\ast)$ becomes:\n$$ D^2(\\nu^\\ast) = \\frac{\\frac{1}{L} \\sum_k |\\hat{T}_{\\mathrm{nonlocal},k} - \\hat{T}_{\\mathrm{local},k}|^2}{\\frac{1}{L} \\sum_k |\\hat{T}_{\\mathrm{local},k}|^2} = \\frac{\\sum_k |\\Delta\\hat{T}_k|^2}{\\sum_k |\\hat{T}_{\\mathrm{local},k}|^2} $$\nSubstituting the expressions for the temperature modes:\n$$ \\Delta\\hat{T}_k = \\hat{T}_{\\mathrm{local},k} (1 + |k|\\lambda) - \\hat{T}_{\\mathrm{local},k} = \\hat{T}_{\\mathrm{local},k} |k|\\lambda $$\nThus, the squared discrepancy is:\n$$ D^2(\\nu^\\ast) = \\frac{\\sum_{k \\neq 0} |\\hat{T}_{\\mathrm{local},k} |k|\\lambda|^2}{\\sum_{k \\neq 0} |\\hat{T}_{\\mathrm{local},k}|^2} = \\lambda^2 \\frac{\\sum_{k \\neq 0} k^2 |\\hat{T}_{\\mathrm{local},k}|^2}{\\sum_{k \\neq 0} |\\hat{T}_{\\mathrm{local},k}|^2} $$\nThe summation excludes $k=0$ since the mean temperature is zero. The calculation can be performed directly on the computed arrays of Fourier coefficients. The algorithm is as follows:\n1.  For each given $\\nu^\\ast$, calculate $\\lambda = L/\\nu^\\ast$.\n2.  Compute the arrays for $\\hat{T}_{\\mathrm{local},k}$ and $\\Delta\\hat{T}_k = \\hat{T}_{\\mathrm{local},k} |k|\\lambda$.\n3.  Calculate the sum of squares of the elements in each array (`np.sum(np.abs(array)**2)`).\n4.  Compute $D(\\nu^\\ast)$ as the square root of the ratio of these sums.\nThis process is repeated for each value of $\\nu^\\ast$ in the test suite.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the discrepancy between local and nonlocal heat flux models\n    for a 1D periodic plasma problem.\n    \"\"\"\n\n    # 1. Define problem parameters from the statement\n    L = 2.0  # Domain length in meters\n    kappa_parallel = 200.0  # Parallel thermal conductivity in W/(m*K)\n    S0 = 1000.0  # Source amplitude in W/m^3\n    nu_star_values = [0.01, 0.1, 1.0, 10.0, 100.0]\n\n    # 2. Set up the numerical grid and wavenumbers\n    N = 2048  # Number of grid points for spectral accuracy\n    s = np.linspace(0, L, N, endpoint=False)  # Spatial grid\n    ds = s[1] - s[0]\n\n    # Wavenumbers for the FFT\n    k = 2 * np.pi * np.fft.fftfreq(N, d=ds)\n    k_abs = np.abs(k)\n\n    # 3. Define the source term and compute its Fourier transform\n    S = S0 * (np.sin(2 * np.pi * s / L) + 0.5 * np.sin(4 * np.pi * s / L))\n    S_hat = np.fft.fft(S)\n\n    # Create a mask to handle the k=0 mode to avoid division by zero\n    k0_mask = (k == 0)\n    # The `where` argument in np.divide prevents division by zero warnings\n    # and sets the result to 0 where the condition is false.\n    safe_k_squared = np.where(k0_mask, 1.0, k**2)\n\n    # 4. Calculate the Fourier coefficients of the local temperature solution\n    # T_local_hat = S_hat / (kappa_parallel * k^2)\n    T_local_hat = np.divide(S_hat, kappa_parallel * safe_k_squared, where=~k0_mask)\n    T_local_hat[k0_mask] = 0.0 # Explicitly set the k=0 mode to zero as per problem statement\n\n    # 5. Loop through each collisionality value and compute the discrepancy D\n    results = []\n    for nu_star in nu_star_values:\n        lambda_mfp = L / nu_star  # Mean free path\n\n        # Calculate the Fourier coefficients of the nonlocal temperature solution\n        # T_nonlocal_hat = T_local_hat * (1 + |k|*lambda)\n        nonlocal_factor = 1.0 + k_abs * lambda_mfp\n        T_nonlocal_hat = T_local_hat * nonlocal_factor\n\n        # Calculate the difference in Fourier space\n        delta_T_hat = T_nonlocal_hat - T_local_hat\n\n        # Use Parseval's theorem to compute the integrals from Fourier coefficients.\n        # The normalization constants of the FFT and the integral definition cancel out.\n        # Numerator: integral of (T_nonlocal - T_local)^2\n        numerator_integral = np.sum(np.abs(delta_T_hat)**2)\n        \n        # Denominator: integral of T_local^2\n        denominator_integral = np.sum(np.abs(T_local_hat)**2)\n        \n        # Avoid division by zero if the local solution is trivial (not the case here)\n        if denominator_integral == 0:\n            discrepancy = 0.0\n        else:\n            discrepancy = np.sqrt(numerator_integral / denominator_integral)\n        \n        results.append(discrepancy)\n\n    # 6. Print the final results in the specified format\n    print(f\"[{','.join(f'{r:.12f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Having seen the physical impact of nonlocality, we now investigate its mathematical origins. A nonlocal closure can be rigorously derived from the linearized drift-kinetic equation, where it manifests as a convolution operation in real space or a multiplicative response function in Fourier space. In this exercise , you will prove this equivalence by deriving the convolution kernel's Fourier representation from the drift-kinetic response and demonstrating that both methods yield the same heat flux, confirming the closure's kinetic foundation.",
            "id": "3969031",
            "problem": "You are tasked with demonstrating, from first principles, how nonlocal closures for parallel heat flux in a magnetized plasma can be implemented numerically via convolution kernels and evaluating their consistency against solutions of the underlying drift-kinetic equation. Work entirely in dimensionless units. Consider a one-dimensional periodic domain along the magnetic field line of length $L$, with coordinate $s \\in [0,L)$ and a grid of $N$ equispaced points. Assume a straight, uniform magnetic field and a linearized drift-kinetic model with the Bhatnagar-Gross-Krook (BGK) collision operator. Let $f_0(v)$ denote a dimensionless Maxwellian distribution in the parallel velocity $v$, and let $f_1(s,v)$ denote a small perturbation driven by a prescribed temperature field $T(s)$. The dimensionless Maxwellian is given by $f_0(v) = \\frac{1}{\\sqrt{\\pi}} e^{-v^2}$. The linearized drift-kinetic equation in this simplified setting is\n$$\nv \\frac{\\partial f_1}{\\partial s} + \\nu f_1 = S(s,v),\n$$\nwhere $\\nu > 0$ is a constant dimensionless collision frequency and $S(s,v)$ is a source representing the temperature-gradient drive. The parallel heat flux is obtained from the moment of $f_1$,\n$$\nq(s) = \\int_{-\\infty}^{\\infty} v^3 f_1(s,v) \\, dv.\n$$\nA nonlocal closure can be posed as a convolution between the temperature gradient and a kernel $K(\\Delta)$,\n$$\nq(s) = - \\int_{-\\infty}^{\\infty} K(\\Delta)\\, \\frac{\\partial T}{\\partial s}(s - \\Delta)\\, d\\Delta,\n$$\nwhere $K(\\Delta)$ is derived from the Green's function solution of the drift-kinetic equation and depends on $\\nu$ and the velocity weighting induced by $f_0(v)$.\n\nYour program must do the following for each test case:\n\n- Derive, implement, and use a numerically stable method for computing the parallel heat flux $q(s)$ from the drift-kinetic equation under periodic boundary conditions. Use the spectral (Fourier) representation associated with the periodic domain to obtain $q(s)$ from $T(s)$ based on the drift-kinetic response. This computation should be performed by evaluating the velocity integral that arises from solving the drift-kinetic equation in Fourier space, using an explicit numerical quadrature over $v$ on a bounded interval approximating $(-\\infty,\\infty)$.\n\n- Independently construct the nonlocal convolution kernel implied by the drift-kinetic Green's function and implement the closure $q_{\\text{closure}}(s) = - \\int K(\\Delta) \\frac{\\partial T}{\\partial s}(s-\\Delta)\\, d\\Delta$. You may implement this convolution via its Fourier representation, using the Fourier symbol of the kernel obtained by analytic manipulation of the drift-kinetic solution and performing a well-resolved numerical quadrature over $v$.\n\n- Compute the consistency metric between the two heat fluxes as the relative $L^2$ error:\n$$\n\\epsilon = \\frac{\\left\\| q_{\\text{closure}} - q_{\\text{dk}} \\right\\|_2}{\\left\\| q_{\\text{dk}} \\right\\|_2},\n$$\nwhere $q_{\\text{dk}}(s)$ is the heat flux obtained from the drift-kinetic solution and $\\|\\cdot\\|_2$ denotes the discrete $L^2$ norm over the grid.\n\nThe test suite consists of three cases, each specified by parameters $(L,N,\\nu,a,k_{\\text{mode}})$ and the temperature profile\n$$\nT(s) = 1 + a \\sin\\left(\\frac{2\\pi k_{\\text{mode}}}{L} s\\right).\n$$\n\nUse exactly these three test cases:\n\n- Case $1$: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,0.5,0.1,1)$.\n- Case $2$: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,5.0,0.1,1)$.\n- Case $3$: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,0.2,0.1,4)$.\n\nFor each case, compute and report the single floating-point number $\\epsilon$ as defined above. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,result_3]$). Since all quantities are dimensionless, no physical units are required, and angles are in radians by construction of the Fourier modes.",
            "solution": "### Problem Validation\n\nThis phase ensures the problem is scientifically sound, well-posed, and complete before a solution is attempted.\n\n#### Step 1: Extract Givens\n\nThe problem statement provides the following information:\n-   **Domain**: One-dimensional and periodic, with coordinate $s \\in [0,L)$ and $N$ equispaced grid points.\n-   **Linearized Drift-Kinetic Equation (DKE)**: $v \\frac{\\partial f_1}{\\partial s} + \\nu f_1 = S(s,v)$, where $\\nu > 0$ is a constant dimensionless collision frequency.\n-   **Equilibrium Distribution**: $f_0(v) = \\frac{1}{\\sqrt{\\pi}} e^{-v^2}$ is a dimensionless Maxwellian.\n-   **Perturbation**: $f_1(s,v)$ is a small perturbation.\n-   **Source Term**: $S(s,v)$ is a source driven by a prescribed temperature field $T(s)$.\n-   **Parallel Heat Flux**: $q(s) = \\int_{-\\infty}^{\\infty} v^3 f_1(s,v) \\, dv$.\n-   **Nonlocal Closure**: $q(s) = - \\int_{-\\infty}^{\\infty} K(\\Delta)\\, \\frac{\\partial T}{\\partial s}(s - \\Delta)\\, d\\Delta$.\n-   **Temperature Profile**: $T(s) = 1 + a \\sin\\left(\\frac{2\\pi k_{\\text{mode}}}{L} s\\right)$.\n-   **Consistency Metric**: $\\epsilon = \\frac{\\left\\| q_{\\text{closure}} - q_{\\text{dk}} \\right\\|_2}{\\left\\| q_{\\text{dk}} \\right\\|_2}$, where $\\|\\cdot\\|_2$ is the discrete $L^2$ norm.\n-   **Test Cases**:\n    -   Case 1: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,0.5,0.1,1)$.\n    -   Case 2: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,5.0,0.1,1)$.\n    -   Case 3: $(L,N,\\nu,a,k_{\\text{mode}}) = (10,256,0.2,0.1,4)$.\n\n#### Step 2: Validate Using Extracted Givens\n\nThe problem is evaluated against the validation criteria:\n-   **Scientifically Grounded**: The problem is firmly rooted in plasma kinetic theory. The linearized drift-kinetic equation with a Bhatnagar-Gross-Krook (BGK) collision operator is a standard, simplified model used to study kinetic transport phenomena, such as parallel heat flux. The concept of a nonlocal closure as a convolution is a cornerstone of modern transport modeling in fusion plasmas. The problem is scientifically sound.\n-   **Well-Posed**: The problem is well-posed. The use of a linear partial differential equation on a periodic domain with a specified driving term allows for a unique solution via Fourier analysis. The parameters are well-defined, and the objective is a quantitative comparison, which is unambiguous.\n-   **Objective**: The problem is stated in precise, objective mathematical language. The tasks are quantitative and free of subjective interpretation.\n-   **Completeness**: All necessary equations, parameters, and definitions are provided. The source term $S(s,v)$ is standardly derived from the context of a temperature-driven perturbation in a BGK model, and the problem provides enough context to formalize it.\n-   **No Other Flaws**: The problem is not trivial, metaphorical, or contradictory. It presents a standard, meaningful exercise in computational plasma physics.\n\n#### Step 3: Verdict and Action\n\nThe problem is **valid**. A full solution will be provided.\n\n### Solution Derivation\n\nThe objective is to compute the parallel heat flux $q(s)$ using two formally equivalent methods and to quantify their numerical consistency. The first method involves a direct solution of the drift-kinetic equation, while the second uses a nonlocal convolution closure. Both methods will be implemented in Fourier space.\n\n#### 1. Method 1: Direct Solution of the Drift-Kinetic Equation ($q_{\\text{dk}}$)\n\nThe linearized drift-kinetic equation is given by:\n$$\nv \\frac{\\partial f_1}{\\partial s} + \\nu f_1 = S(s,v)\n$$\nThe source term $S(s,v)$ for a temperature perturbation $T(s)$ arises from the BGK collision operator's action, $\\nu(f_{1,M} - f_1)$, where $f_{1,M}$ is the first-order perturbation of the Maxwellian distribution. For a temperature perturbation $\\delta T(s) = T(s) - 1$, this is $f_{1,M}(s,v) = (v^2 - 1/2)f_0(v)\\delta T(s)$. The DKE thus becomes:\n$$\nv \\frac{\\partial f_1}{\\partial s} + \\nu f_1 = \\nu \\left(v^2 - \\frac{1}{2}\\right)f_0(v)\\delta T(s)\n$$\nWe solve this equation in Fourier space. A function $g(s)$ on the periodic domain $s \\in [0,L)$ can be represented by its Fourier series $g(s) = \\sum_j \\hat{g}(k_j) e^{ik_j s}$, where $k_j = 2\\pi j / L$ are the discrete wavenumbers. The derivative operator $\\frac{\\partial}{\\partial s}$ transforms to multiplication by $ik_j$. Applying the Fourier transform to the DKE yields:\n$$\nik_j v \\hat{f}_1(k_j, v) + \\nu \\hat{f}_1(k_j, v) = \\nu \\left(v^2 - \\frac{1}{2}\\right) f_0(v) \\widehat{\\delta T}(k_j)\n$$\nSolving for $\\hat{f}_1(k_j, v)$:\n$$\n\\hat{f}_1(k_j, v) = \\frac{\\nu \\left(v^2 - \\frac{1}{2}\\right) f_0(v)}{\\nu + ik_j v} \\widehat{\\delta T}(k_j)\n$$\nThe parallel heat flux is $q(s) = \\int_{-\\infty}^{\\infty} v^3 f_1(s,v) \\, dv$. Its Fourier transform is $\\hat{q}(k_j) = \\int_{-\\infty}^{\\infty} v^3 \\hat{f}_1(k_j,v) \\, dv$. Substituting the expression for $\\hat{f}_1$ gives the heat flux spectrum, $\\hat{q}_{\\text{dk}}(k_j)$:\n$$\n\\hat{q}_{\\text{dk}}(k_j) = \\left[ \\int_{-\\infty}^{\\infty} \\frac{\\nu v^3 \\left(v^2 - \\frac{1}{2}\\right) f_0(v)}{\\nu + ik_j v} \\, dv \\right] \\widehat{\\delta T}(k_j)\n$$\nWe define the kinetic response function, $\\chi(k_j)$, as the term in the brackets:\n$$\n\\chi(k_j) = \\nu \\int_{-\\infty}^{\\infty} \\frac{v^3 \\left(v^2 - \\frac{1}{2}\\right) f_0(v)}{\\nu + ik_j v} \\, dv\n$$\nsuch that $\\hat{q}_{\\text{dk}}(k_j) = \\chi(k_j) \\widehat{\\delta T}(k_j)$. For $k_j=0$, the integral has an odd integrand in $v$ and is thus zero, so $\\chi(0) = 0$. This is physically correct, as a spatially uniform temperature perturbation does not drive a heat flux.\n\nTo compute $q_{\\text{dk}}(s)$ numerically:\n1.  Discretize the domain $s$ into $N$ points.\n2.  Compute $\\delta T(s) = a \\sin(2\\pi k_{\\text{mode}} s / L)$ on the grid.\n3.  Compute $\\widehat{\\delta T}(k_j)$ using a Fast Fourier Transform (FFT).\n4.  For each wavenumber $k_j$, compute $\\chi(k_j)$ by performing a numerical quadrature of the velocity integral over a sufficiently large, finite interval (e.g., $v \\in [-8, 8]$).\n5.  Calculate the heat flux spectrum $\\hat{q}_{\\text{dk}}(k_j) = \\chi(k_j) \\widehat{\\delta T}(k_j)$.\n6.  Compute $q_{\\text{dk}}(s)$ by applying an inverse FFT to $\\hat{q}_{\\text{dk}}(k_j)$.\n\n#### 2. Method 2: Nonlocal Closure Formulation ($q_{\\text{closure}}$)\n\nThe nonlocal closure for the heat flux is given as a convolution:\n$$\nq(s) = - \\int_{-\\infty}^{\\infty} K(\\Delta)\\, \\frac{\\partial T}{\\partial s}(s - \\Delta)\\, d\\Delta\n$$\nThis is $q(s) = -(K * \\frac{\\partial T}{\\partial s})(s)$. By the convolution theorem, its Fourier transform is:\n$$\n\\hat{q}_{\\text{closure}}(k_j) = -\\hat{K}(k_j) \\widehat{\\frac{\\partial T}{\\partial s}}(k_j)\n$$\nSince $\\frac{\\partial T}{\\partial s} = \\frac{\\partial \\delta T}{\\partial s}$, its Fourier transform is $ik_j \\widehat{\\delta T}(k_j)$. Therefore:\n$$\n\\hat{q}_{\\text{closure}}(k_j) = -\\hat{K}(k_j) (ik_j \\widehat{\\delta T}(k_j))\n$$\nTo find the convolution kernel's Fourier symbol $\\hat{K}(k_j)$, we enforce consistency with the direct DKE solution by equating the two expressions for the heat flux spectrum:\n$$\n\\hat{q}_{\\text{dk}}(k_j) = \\hat{q}_{\\text{closure}}(k_j) \\implies \\chi(k_j) \\widehat{\\delta T}(k_j) = -\\hat{K}(k_j) (ik_j \\widehat{\\delta T}(k_j))\n$$\nFor $k_j \\neq 0$, this yields:\n$$\n\\hat{K}(k_j) = \\frac{\\chi(k_j)}{-ik_j} = \\frac{i \\chi(k_j)}{k_j} = \\frac{i\\nu}{k_j} \\int_{-\\infty}^{\\infty} \\frac{v^3 (v^2 - 1/2) f_0(v)}{\\nu + ik_j v} \\, dv\n$$\nFor the case $k_j = 0$, we must take the limit $k \\to 0$. This corresponds to the highly collisional, local transport limit (Spitzer-Härm conductivity).\n$$\n\\hat{K}(0) = \\lim_{k\\to 0} \\frac{i\\chi(k)}{k} = \\lim_{k\\to 0} \\frac{i}{k} \\left[ \\nu \\int_{-\\infty}^\\infty v^3 (v^2-1/2)f_0(v) \\left( \\frac{1}{\\nu} - \\frac{ikv}{\\nu^2} + \\mathcal{O}(k^2) \\right) dv \\right]\n$$\nThe first term in the expansion integrates to zero (odd function). The second term survives:\n$$\n\\hat{K}(0) = \\lim_{k\\to 0} \\frac{i}{k} \\left[ -i \\frac{k}{\\nu} \\int_{-\\infty}^\\infty v^4 (v^2-1/2)f_0(v) dv \\right] = \\frac{1}{\\nu} \\int_{-\\infty}^\\infty (v^6 - \\frac{1}{2}v^4) \\frac{e^{-v^2}}{\\sqrt{\\pi}} dv\n$$\nUsing standard Gaussian integrals, $\\int_{-\\infty}^\\infty v^{2n} e^{-v^2} dv = \\Gamma(n+1/2)$, we find $\\int v^4 f_0(v) dv = 3/4$ and $\\int v^6 f_0(v) dv = 15/8$.\n$$\n\\hat{K}(0) = \\frac{1}{\\nu} \\left( \\frac{15}{8} - \\frac{1}{2} \\frac{3}{4} \\right) = \\frac{1}{\\nu} \\left( \\frac{15}{8} - \\frac{3}{8} \\right) = \\frac{12}{8\\nu} = \\frac{3}{2\\nu}\n$$\n\nTo compute $q_{\\text{closure}}(s)$ numerically:\n1.  Discretize the domain $s$ and compute $T(s) = 1 + \\delta T(s)$.\n2.  Compute $\\hat{T}(k_j)$ using an FFT.\n3.  Compute the Fourier transform of the temperature gradient: $\\widehat{\\frac{\\partial T}{\\partial s}}(k_j) = ik_j \\hat{T}(k_j)$.\n4.  For each wavenumber $k_j$, compute $\\hat{K}(k_j)$ using its definition in terms of $\\chi(k_j)$ (for $k_j \\neq 0$) and its limiting value (for $k_j=0$).\n5.  Calculate the heat flux spectrum $\\hat{q}_{\\text{closure}}(k_j) = -\\hat{K}(k_j) \\widehat{\\frac{\\partial T}{\\partial s}}(k_j)$.\n6.  Compute $q_{\\text{closure}}(s)$ by applying an inverse FFT.\n\n#### 3. Consistency Metric\n\nThe numerical consistency between the two methods is assessed using the relative $L^2$ error. On the discrete grid $s_m = m L/N$, the discrete $L^2$ norm of a vector $x$ is $\\|x\\|_2 = \\sqrt{\\sum_{m=0}^{N-1} |x_m|^2}$. The error metric is:\n$$\n\\epsilon = \\frac{\\left\\| q_{\\text{closure}} - q_{\\text{dk}} \\right\\|_2}{\\left\\| q_{\\text{dk}} \\right\\|_2}\n$$\nBy construction, the two methods are mathematically equivalent. The computed error $\\epsilon$ will therefore be a measure of the numerical floating-point inaccuracies accumulated through the different computational paths (e.g., division by $k_j$ in the calculation of $\\hat{K}(k_j)$), and it is expected to be very small.",
            "answer": "```python\nimport numpy as np\nfrom scipy import integrate\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test cases and prints the results.\n    \"\"\"\n    test_cases = [\n        # (L, N, nu, a, k_mode)\n        (10.0, 256, 0.5, 0.1, 1),\n        (10.0, 256, 5.0, 0.1, 1),\n        (10.0, 256, 0.2, 0.1, 4),\n    ]\n\n    results = []\n    for case in test_cases:\n        epsilon = compute_consistency(*case)\n        results.append(epsilon)\n\n    print(f\"[{','.join(f'{r:.5e}' for r in results)}]\")\n\ndef compute_consistency(L, N, nu, a, k_mode):\n    \"\"\"\n    Computes the consistency metric for a single test case.\n\n    This function demonstrates the equivalence of two methods for calculating\n    the parallel heat flux in a magnetized plasma:\n    1. q_dk: Direct solution of the linearized drift-kinetic equation.\n    2. q_closure: Application of a nonlocal convolution closure.\n\n    The consistency is measured by the relative L2 error between the two.\n    \"\"\"\n    # 1. Setup Grid, Temperature Profile, and Fourier Space Variables\n    s = np.linspace(0, L, N, endpoint=False)\n    k = 2 * np.pi * np.fft.fftfreq(N, d=L / N)\n\n    T_s = 1.0 + a * np.sin(2 * np.pi * k_mode / L * s)\n    delta_T_s = T_s - 1.0\n\n    # 2. Define Integrands and Helper Functions\n    def f0(v):\n        \"\"\"Dimensionless Maxwellian distribution.\"\"\"\n        return np.exp(-v**2) / np.sqrt(np.pi)\n\n    def chi_integrand(v, k_val, nu_val):\n        \"\"\"Integrand for the kinetic response function chi(k).\"\"\"\n        if np.abs(nu_val + 1j * k_val * v) < 1e-15:\n            # This is a resonance, but integration over it should be handled\n            # by the quadrature. For a single point, return 0.\n            return 0.0\n        numerator = nu_val * v**3 * (v**2 - 0.5) * f0(v)\n        denominator = nu_val + 1j * k_val * v\n        return numerator / denominator\n\n    # Velocity integration limits\n    v_max = 8.0\n\n    # 3. Compute Kinetic Response Function chi(k)\n    chi_k = np.zeros(N, dtype=complex)\n    for j, k_val in enumerate(k):\n        if k_val == 0:\n            chi_k[j] = 0.0  # DC component of T does not drive heat flux\n            continue\n\n        # Use scipy.integrate.quad on real and imaginary parts separately\n        real_part, _ = integrate.quad(lambda v: chi_integrand(v, k_val, nu).real, -v_max, v_max, epsabs=1e-12, epsrel=1e-12)\n        imag_part, _ = integrate.quad(lambda v: chi_integrand(v, k_val, nu).imag, -v_max, v_max, epsabs=1e-12, epsrel=1e-12)\n        chi_k[j] = real_part + 1j * imag_part\n        \n    # 4. Method 1: Compute q_dk from Drift-Kinetic Equation\n    delta_T_k = np.fft.fft(delta_T_s)\n    q_dk_k = chi_k * delta_T_k\n    q_dk = np.fft.ifft(q_dk_k).real\n\n    # 5. Method 2: Compute q_closure from Nonlocal Closure\n    # 5.1 Compute kernel symbol K_hat(k)\n    K_k_hat = np.zeros(N, dtype=complex)\n    for j, k_val in enumerate(k):\n        if k_val == 0:\n            # Collisional limit (Spitzer-Harm conductivity)\n            K_k_hat[j] = 3.0 / (2.0 * nu)\n        else:\n            K_k_hat[j] = 1j * chi_k[j] / k_val\n\n    # 5.2 Compute q_closure_hat = -K_hat * dT/ds_hat\n    T_k = np.fft.fft(T_s)\n    dTds_k = 1j * k * T_k\n    q_closure_k = -K_k_hat * dTds_k\n    q_closure = np.fft.ifft(q_closure_k).real\n\n    # 6. Compute Consistency Metric (Relative L2 Error)\n    norm_diff = np.linalg.norm(q_closure - q_dk)\n    norm_q_dk = np.linalg.norm(q_dk)\n\n    if norm_q_dk == 0:\n        epsilon = 0.0 if norm_diff == 0 else np.inf\n    else:\n        epsilon = norm_diff / norm_q_dk\n        \n    return epsilon\n\nsolve()\n```"
        },
        {
            "introduction": "We now apply our understanding of closures to a crucial problem in fusion reactors: impurity transport. In a multi-species plasma, the radial particle fluxes are not independent; they are linked by the ambipolarity constraint, which self-consistently determines the radial electric field $E_r$. This exercise  tasks you with modeling this process by first calculating the ambipolar $E_r$ from the main ion and electron fluxes and then using it to solve for the steady-state impurity profile, revealing the mechanism of the inward \"impurity pinch.\"",
            "id": "3969019",
            "problem": "You are to derive and implement a computational model for steady-state impurity accumulation in a magnetically confined plasma using the drift-kinetic equation and closure relations. The setting is an axisymmetric, large-aspect-ratio tokamak in which species are described by a drift-kinetic equation and collisional closures leading to linear transport coefficients. The goal is to compute how the impurity profile is affected by a flux-surface-averaged radial electric field through the ambipolarity constraint, and then solve for the steady-state impurity profile from drift-kinetic balance.\n\nStart from the drift-kinetic equation (DKE) for species $s$,\n$$\nv_{\\parallel} \\nabla_{\\parallel} f_s + \\mathbf{v}_{\\mathrm{d},s} \\cdot \\nabla f_s + \\frac{q_s E_r}{m_s} \\frac{\\partial f_s}{\\partial v_{\\parallel}} = C[f_s],\n$$\nwhere $f_s$ is the distribution function, $v_{\\parallel}$ is the parallel velocity, $\\mathbf{v}_{\\mathrm{d},s}$ is the drift velocity, $q_s$ is the species charge, $m_s$ is the mass, $E_r$ is the flux-surface-averaged radial electric field, and $C[\\cdot]$ is the collision operator. In the collisional regime and for small deviations from a Maxwellian equilibria, flux-surface averaging and linearization yield a closure where the radial particle flux of species $s$ takes a linear, Fickian form with a field-driven term,\n$$\n\\Gamma_s(r) = - D_s(r) \\frac{d n_s}{d r}(r) + M_s(r)\\, n_s(r)\\, E_r(r),\n$$\nwhere $\\Gamma_s$ is the flux-surface-averaged radial particle flux, $D_s(r)$ is the particle diffusion coefficient, $M_s(r)$ is a mobility-like coefficient, and $n_s(r)$ is the species density.\n\nAmbipolarity requires that the net charge flux vanishes,\n$$\n\\sum_s Z_s \\Gamma_s(r) = 0,\n$$\nwhere $Z_s$ is the species charge number defined by $q_s = Z_s e$ and $e$ is the elementary charge. In steady state, assume the impurity species has zero net radial flux, $\\Gamma_z(r) = 0$, and that quasi-neutrality is maintained with a small impurity fraction such that the ambipolarity constraint is dominated by the main ions and electrons. Under these assumptions, the ambipolarity constraint determines $E_r(r)$ self-consistently in terms of the main ion and electron density profiles and their transport coefficients. With the obtained $E_r(r)$, the impurity steady-state condition $\\Gamma_z(r) = 0$ becomes a first-order ordinary differential equation (ODE) for the impurity density $n_z(r)$, which you must solve subject to a boundary condition at the plasma edge $r=a$.\n\nYou will implement this model in a one-dimensional radial domain $r \\in [0,a]$ with prescribed analytic profiles for the electron and ion densities and constant (or weakly varying) transport coefficients. Specifically, use:\n- Electron density profile $n_e(r) = n_{e0} \\exp\\left(-\\frac{r}{L_e}\\right)$ and ion density profile $n_i(r) = n_{i0} \\exp\\left(-\\frac{r}{L_i}\\right)$.\n- Electron and ion diffusion coefficients $D_e(r) = D_{e0}$ and $D_i(r) = D_{i0}$ (constants).\n- Electron and ion mobility-like coefficients $M_e(r) = \\mu_e$ and $M_i(r) = \\mu_i$ (constants).\n- Impurity diffusion coefficient $D_z(r) = D_{z0} \\left(1 + \\alpha_z \\frac{r}{a}\\right)$ and mobility-like coefficient $M_z(r) = \\mu_z$ (constant).\n- Impurity boundary condition $n_z(a) = n_{z,\\mathrm{edge}}$ at the plasma edge.\n\nUnits to use and report in the derivation and implementation:\n- Radius $r$ and plasma minor radius $a$ in meters ($\\mathrm{m}$).\n- Densities $n_s$ in inverse cubic meters ($\\mathrm{m}^{-3}$).\n- Diffusion coefficients $D_s$ in square meters per second ($\\mathrm{m}^2\\,\\mathrm{s}^{-1}$).\n- Mobility-like coefficients $M_s$ in square meters per volt per second ($\\mathrm{m}^2\\,\\mathrm{V}^{-1}\\,\\mathrm{s}^{-1}$).\n- Radial electric field $E_r$ in volts per meter ($\\mathrm{V}\\,\\mathrm{m}^{-1}$).\n\nTasks:\n1. Starting from the drift-kinetic equation and continuity, derive the linear closure form for $\\Gamma_s(r)$, and obtain an expression for $E_r(r)$ from the ambipolarity constraint under the assumption $\\Gamma_z(r) = 0$ and small impurity fraction (so that $\\sum_s Z_s \\Gamma_s(r) \\approx \\Gamma_i(r) - \\Gamma_e(r) = 0$).\n2. Using the impurity steady-state condition $\\Gamma_z(r) = 0$, derive the first-order ODE for $n_z(r)$ and solve it to obtain the steady-state impurity profile $n_z(r)$ in terms of $E_r(r)$ and the impurity transport coefficients. Use the boundary condition $n_z(a) = n_{z,\\mathrm{edge}}$.\n3. Implement a numerical algorithm to compute $E_r(r)$ on a uniform grid in $r \\in [0,a]$, integrate the derived ODE for $n_z(r)$, and finally report the central-to-edge impurity density ratio $R_z = n_z(0)/n_z(a)$ as a dimensionless float. Use the trapezoidal rule for radial integrations and handle potential near-singularities in the ambipolarity denominator by setting $E_r(r) = 0$ where $\\left|\\mu_i n_i(r) - \\mu_e n_e(r)\\right|$ falls below a small threshold (you may choose an appropriate numerical threshold).\n\nTest Suite:\nImplement your program to compute $R_z$ for the following four scientifically plausible test cases. Each case specifies $(a, n_{e0}, L_e, n_{i0}, L_i, D_{e0}, D_{i0}, \\mu_e, \\mu_i, D_{z0}, \\alpha_z, \\mu_z, n_{z,\\mathrm{edge}})$, with the units as specified above.\n\n- Case $1$ (typical collisional regime with moderate electric field and inward impurity pinch):\n  - $a = 0.5$, $n_{e0} = 5.0 \\times 10^{19}$, $L_e = 0.15$, $n_{i0} = 5.0 \\times 10^{19}$, $L_i = 0.25$, $D_{e0} = 1.2$, $D_{i0} = 0.3$, $\\mu_e = 0.006$, $\\mu_i = 0.004$, $D_{z0} = 0.2$, $\\alpha_z = 0.8$, $\\mu_z = 0.003$, $n_{z,\\mathrm{edge}} = 1.0 \\times 10^{18}$.\n- Case $2$ (near-ambipolar balance with very small $E_r$ and weak impurity peaking):\n  - $a = 0.5$, $n_{e0} = 4.0 \\times 10^{19}$, $L_e = 0.30$, $n_{i0} = 4.0 \\times 10^{19}$, $L_i = 0.30$, $D_{e0} = 0.5$, $D_{i0} = 0.5$, $\\mu_e = 0.0099$, $\\mu_i = 0.0100$, $D_{z0} = 0.15$, $\\alpha_z = 0.0$, $\\mu_z = 0.004$, $n_{z,\\mathrm{edge}} = 8.0 \\times 10^{17}$.\n- Case $3$ (strong electron drive producing larger inward $E_r$ and stronger impurity peaking):\n  - $a = 0.6$, $n_{e0} = 6.0 \\times 10^{19}$, $L_e = 0.12$, $n_{i0} = 5.5 \\times 10^{19}$, $L_i = 0.50$, $D_{e0} = 1.0$, $D_{i0} = 0.2$, $\\mu_e = 0.012$, $\\mu_i = 0.003$, $D_{z0} = 0.12$, $\\alpha_z = 0.3$, $\\mu_z = 0.006$, $n_{z,\\mathrm{edge}} = 1.2 \\times 10^{18}$.\n- Case $4$ (radially increasing impurity diffusivity that mitigates peaking):\n  - $a = 0.4$, $n_{e0} = 3.0 \\times 10^{19}$, $L_e = 0.25$, $n_{i0} = 3.2 \\times 10^{19}$, $L_i = 0.22$, $D_{e0} = 0.7$, $D_{i0} = 0.6$, $\\mu_e = 0.007$, $\\mu_i = 0.008$, $D_{z0} = 0.5$, $\\alpha_z = 2.0$, $\\mu_z = 0.005$, $n_{z,\\mathrm{edge}} = 9.0 \\times 10^{17}$.\n\nYour program should produce a single line of output containing the four central-to-edge ratios as a comma-separated list enclosed in square brackets, with each float rounded to six decimal places. For example: \"[r1,r2,r3,r4]\". All four outputs $r1$, $r2$, $r3$, and $r4$ must be dimensionless floats computed from the corresponding case. No other text should be printed.",
            "solution": "The user has provided a well-posed problem from computational plasma physics. This problem is scientifically grounded, free of contradictions, and contains all necessary information for a unique solution. The provided parameters and profiles are physically realistic for a tokamak plasma. Therefore, the problem is deemed valid.\n\nThe solution will be developed in three parts as requested:\n1.  Derivation of the radial electric field, $E_r(r)$.\n2.  Derivation and solution of the ordinary differential equation (ODE) for the impurity density profile, $n_z(r)$, leading to an expression for the central-to-edge ratio, $R_z$.\n3.  A description of the numerical algorithm to compute $R_z$.\n\n**1. Derivation of the Radial Electric Field $E_r(r)$**\n\nThe problem starts from the drift-kinetic framework, which, after significant theoretical development (linearization of the distribution function, expansion in small gyroradius, and moment-taking), yields a linear relationship between the radial particle flux $\\Gamma_s$ and the thermodynamic drives (gradients) and fields. The problem provides this relationship for a species $s$ as:\n$$\n\\Gamma_s(r) = - D_s(r) \\frac{d n_s}{d r}(r) + M_s(r)\\, n_s(r)\\, E_r(r)\n$$\nHere, the first term is a standard Fick's law diffusion, and the second is a convective term driven by the radial electric field $E_r(r)$, often called a pinch.\n\nThe radial electric field is determined by the ambipolarity constraint, which dictates that in a steady state, there can be no net radial current.\n$$\n\\sum_s Z_s e \\Gamma_s(r) = 0 \\implies \\sum_s Z_s \\Gamma_s(r) = 0\n$$\nwhere $Z_s$ is the charge number of species $s$. The problem states to assume a small impurity fraction, such that the ambipolarity condition is dominated by the main ions (i) and electrons (e). With $Z_i=+1$ for a hydrogenic plasma and $Z_e=-1$, the condition simplifies to:\n$$\nZ_i \\Gamma_i(r) + Z_e \\Gamma_e(r) \\approx 0 \\implies (1)\\Gamma_i(r) + (-1)\\Gamma_e(r) = 0 \\implies \\Gamma_i(r) = \\Gamma_e(r)\n$$\nWe substitute the given expressions for $\\Gamma_i$ and $\\Gamma_e$ into this equality:\n$$\n- D_i(r) \\frac{d n_i}{d r}(r) + M_i(r)\\, n_i(r)\\, E_r(r) = - D_e(r) \\frac{d n_e}{d r}(r) + M_e(r)\\, n_e(r)\\, E_r(r)\n$$\nRearranging to solve for $E_r(r)$:\n$$\nE_r(r) \\left( M_i(r) n_i(r) - M_e(r) n_e(r) \\right) = D_i(r) \\frac{d n_i}{d r}(r) - D_e(r) \\frac{d n_e}{d r}(r)\n$$\n$$\nE_r(r) = \\frac{D_i(r) \\frac{d n_i}{d r}(r) - D_e(r) \\frac{d n_e}{d r}(r)}{M_i(r) n_i(r) - M_e(r) n_e(r)}\n$$\nThe problem specifies the density profiles as $n_s(r) = n_{s0} \\exp(-r/L_s)$. The derivatives are $\\frac{d n_s}{d r} = -\\frac{1}{L_s} n_s(r)$. Substituting these into the expression for $E_r(r)$:\n$$\nE_r(r) = \\frac{D_i(r) \\left(-\\frac{1}{L_i} n_i(r)\\right) - D_e(r) \\left(-\\frac{1}{L_e} n_e(r)\\right)}{M_i(r) n_i(r) - M_e(r) n_e(r)} = \\frac{\\frac{D_e(r)}{L_e} n_e(r) - \\frac{D_i(r)}{L_i} n_i(r)}{M_i(r) n_i(r) - M_e(r) n_e(r)}\n$$\nFinally, using the given constant transport coefficients $D_e(r)=D_{e0}$, $D_i(r)=D_{i0}$, $M_e(r)=\\mu_e$, and $M_i(r)=\\mu_i$, we obtain the final analytical expression for the radial electric field:\n$$\nE_r(r) = \\frac{\\frac{D_{e0}}{L_e} n_{e0} e^{-r/L_e} - \\frac{D_{i0}}{L_i} n_{i0} e^{-r/L_i}}{\\mu_i n_{i0} e^{-r/L_i} - \\mu_e n_{e0} e^{-r/L_e}}\n$$\n\n**2. Derivation of the Impurity Density Profile $n_z(r)$**\n\nThe second task is to find the steady-state impurity profile, $n_z(r)$. The steady-state condition for impurities is given as zero net radial flux, $\\Gamma_z(r) = 0$.\n$$\n\\Gamma_z(r) = - D_z(r) \\frac{d n_z}{d r}(r) + M_z(r)\\, n_z(r)\\, E_r(r) = 0\n$$\nThis can be rearranged into a first-order, linear, homogeneous ordinary differential equation for $n_z(r)$:\n$$\nD_z(r) \\frac{d n_z}{d r} = M_z(r) n_z(r) E_r(r) \\implies \\frac{d n_z}{d r} = \\left( \\frac{M_z(r) E_r(r)}{D_z(r)} \\right) n_z(r)\n$$\nThis ODE is separable:\n$$\n\\frac{1}{n_z} dn_z = \\frac{M_z(r) E_r(r)}{D_z(r)} dr\n$$\nWe integrate from the plasma edge $r'=a$ to an arbitrary radius $r'<r$: Let's integrate from $r$ to $a$.\n$$\n\\int_{n_z(r)}^{n_z(a)} \\frac{1}{n'_z} dn'_z = \\int_r^a \\frac{M_z(r') E_r(r')}{D_z(r')} dr'\n$$\n$$\n\\ln(n_z(a)) - \\ln(n_z(r)) = \\int_r^a \\frac{M_z(r') E_r(r')}{D_z(r')} dr'\n$$\nUsing the property $\\ln(x) - \\ln(y) = \\ln(x/y)$ and exponentiating gives the solution for $n_z(r)$:\n$$\n\\ln\\left(\\frac{n_z(r)}{n_z(a)}\\right) = -\\int_r^a \\frac{M_z(r') E_r(r')}{D_z(r')} dr' = \\int_a^r \\frac{M_z(r') E_r(r')}{D_z(r')} dr'\n$$\n$$\nn_z(r) = n_z(a) \\exp\\left( \\int_a^r \\frac{M_z(r') E_r(r')}{D_z(r')} dr' \\right)\n$$\nWith the boundary condition $n_z(a) = n_{z, \\text{edge}}$, the profile is fully determined. The target quantity is the central-to-edge impurity density ratio, $R_z = n_z(0)/n_z(a)$. Setting $r=0$ in the above expression:\n$$\nn_z(0) = n_{z, \\text{edge}} \\exp\\left( \\int_a^0 \\frac{M_z(r') E_r(r')}{D_z(r')} dr' \\right)\n$$\nDividing by $n_z(a) = n_{z, \\text{edge}}$ and reversing the limits of integration yields the final expression for $R_z$:\n$$\nR_z = \\frac{n_z(0)}{n_z(a)} = \\exp\\left( -\\int_0^a \\frac{M_z(r') E_r(r')}{D_z(r')} dr' \\right)\n$$\nSubstituting the provided forms for the impurity transport coefficients, $M_z(r')=\\mu_z$ and $D_z(r')=D_{z0}(1 + \\alpha_z r'/a)$, the integral becomes:\n$$\nR_z = \\exp\\left( -\\int_0^a \\frac{\\mu_z E_r(r')}{D_{z0}(1 + \\alpha_z r'/a)} dr' \\right)\n$$\n\n**3. Numerical Implementation Strategy**\n\nTo compute $R_z$, we must numerically evaluate the integral derived above. The strategy is as follows:\n1.  **Discretize the Domain**: A uniform radial grid is defined over $r \\in [0, a]$ with $N+1$ points, $r_j = j \\cdot \\Delta r$ for $j=0, 1, \\dots, N$, where $\\Delta r = a/N$. A sufficiently large value of $N$ (e.g., $10000$) is chosen for accuracy.\n2.  **Evaluate Profiles**: The electron and ion density profiles, $n_e(r_j)$ and $n_i(r_j)$, are computed at each grid point using their analytical expressions.\n3.  **Compute Electric Field**: The radial electric field $E_r(r_j)$ is computed at each grid point using the derived formula. A key numerical issue is the potential for the denominator, $\\mu_i n_i(r) - \\mu_e n_e(r)$, to become zero or very small, leading to a singularity. As instructed, if the absolute value of this denominator falls below a small threshold $\\epsilon$ (e.g., $\\epsilon=10^{-9}$), we set $E_r(r_j)=0$ at that point to avoid numerical instability, which is a physically-motivated regularization (a near-zero denominator implies a very large field, which would rapidly redistribute particles to remove the condition).\n4.  **Evaluate Integrand**: The integrand of the exponent, $I(r_j) = \\frac{\\mu_z E_r(r_j)}{D_z(r_j)}$, is computed at each grid point. The impurity diffusion coefficient $D_z(r_j) = D_{z0}(1 + \\alpha_z r_j/a)$ is also evaluated on the grid.\n5.  **Numerical Integration**: The definite integral $K = \\int_0^a I(r') dr'$ is calculated using the trapezoidal rule, as specified: $K \\approx \\Delta r \\left( \\frac{I(r_0)+I(r_N)}{2} + \\sum_{j=1}^{N-1} I(r_j) \\right)$. This is efficiently implemented using standard numerical libraries.\n6.  **Final Calculation**: The ratio $R_z$ is computed as $R_z = \\exp(-K)$.\n\nThis procedure is systematically applied to each test case to obtain the required results.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the central-to-edge impurity density ratio R_z for several test cases\n    based on a drift-kinetic transport model in a tokamak plasma.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: typical collisional regime with moderate electric field\n        (0.5, 5.0e19, 0.15, 5.0e19, 0.25, 1.2, 0.3, 0.006, 0.004, 0.2, 0.8, 0.003, 1.0e18),\n        # Case 2: near-ambipolar balance with very small E_r\n        (0.5, 4.0e19, 0.30, 4.0e19, 0.30, 0.5, 0.5, 0.0099, 0.0100, 0.15, 0.0, 0.004, 8.0e17),\n        # Case 3: strong electron drive producing larger inward E_r\n        (0.6, 6.0e19, 0.12, 5.5e19, 0.50, 1.0, 0.2, 0.012, 0.003, 0.12, 0.3, 0.006, 1.2e18),\n        # Case 4: radially increasing impurity diffusivity\n        (0.4, 3.0e19, 0.25, 3.2e19, 0.22, 0.7, 0.6, 0.007, 0.008, 0.5, 2.0, 0.005, 9.0e17),\n    ]\n\n    results = []\n\n    def calculate_ratio(params):\n        \"\"\"\n        Calculates R_z for a single set of parameters.\n        \"\"\"\n        a, n_e0, L_e, n_i0, L_i, D_e0, D_i0, mu_e, mu_i, D_z0, alpha_z, mu_z, n_z_edge = params\n\n        # 1. Set up the radial grid\n        N_POINTS = 10001\n        r = np.linspace(0, a, N_POINTS)\n\n        # 2. Evaluate density profiles\n        n_e = n_e0 * np.exp(-r / L_e)\n        n_i = n_i0 * np.exp(-r / L_i)\n\n        # 3. Compute the radial electric field E_r(r)\n        # Numerator: D_i * dn_i/dr - D_e * dn_e/dr\n        # with dn_s/dr = -n_s/L_s\n        er_num = (D_e0 / L_e) * n_e - (D_i0 / L_i) * n_i\n        \n        # Denominator: M_i * n_i - M_e * n_e\n        er_denom = mu_i * n_i - mu_e * n_e\n\n        # Handle potential numerical singularity\n        # As per problem, set E_r = 0 where denominator is too small.\n        # This is equivalent to setting the numerator or E_r itself to 0\n        # at those points.\n        threshold = 1e-9\n        e_r = np.zeros_like(r)\n        safe_indices = np.abs(er_denom) >= threshold\n        e_r[safe_indices] = er_num[safe_indices] / er_denom[safe_indices]\n        \n        # 4. Evaluate the integrand for the R_z calculation\n        # Impurity diffusion coefficient profile\n        d_z = D_z0 * (1 + alpha_z * r / a)\n        \n        # Ensure D_z is not zero to avoid division by zero\n        # (not an issue with given parameters, but good practice)\n        d_z[d_z == 0] = np.inf # To make integrand zero\n        \n        # Integrand: (mu_z * E_r) / D_z\n        integrand = (mu_z * e_r) / d_z\n\n        # 5. Numerical integration using trapezoidal rule\n        # R_z = exp(-Integral)\n        integral_val = np.trapz(integrand, r)\n\n        # 6. Final calculation of R_z\n        R_z = np.exp(-integral_val)\n        \n        return R_z\n\n    for case in test_cases:\n        results.append(calculate_ratio(case))\n\n    # Print results in the specified format\n    print(f\"[{','.join([f'{res:.6f}' for res in results])}]\")\n\nsolve()\n```"
        }
    ]
}