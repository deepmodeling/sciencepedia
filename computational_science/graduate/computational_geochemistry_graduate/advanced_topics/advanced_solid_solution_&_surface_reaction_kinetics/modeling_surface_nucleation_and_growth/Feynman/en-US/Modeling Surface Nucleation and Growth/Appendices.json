{
    "hands_on_practices": [
        {
            "introduction": "Understanding nucleation begins with deriving the energy barrier that controls its rate. This foundational exercise guides you through the first-principles derivation of the critical radius and nucleation barrier for a nucleus on a substrate, using the classical spherical cap model. By comparing the result to the homogeneous case, you will directly quantify the catalytic role of a surface in promoting nucleation, a central concept in geochemistry .",
            "id": "4089764",
            "problem": "In a computational geochemistry study of mineral precipitation from an aqueous solution onto a planar silicate substrate, consider a nucleus that forms as a spherical cap with a fixed contact angle $\\theta$ at the three-phase contact line. Assume the following idealizations typical of Classical Nucleation Theory (CNT), defined here as the continuum thermodynamic framework that models the work of formation of a nucleus using bulk free-energy and interfacial energy contributions: (i) line tension is negligible, (ii) the nucleus is isotropic with a single nucleus-solution interfacial energy $\\gamma$, (iii) the thermodynamic driving force is a uniform volumetric free-energy difference $\\Delta \\mu$ between the solid and the solution (positive and defined as the magnitude of the free-energy decrease per unit volume upon forming the solid phase), and (iv) the substrate is planar and chemically homogeneous, so mechanical equilibrium at the contact line is described by Young’s equation.\n\nStarting from the fundamental CNT expression that the reversible work of formation of a nucleus of characteristic radius $r$ is the sum of a bulk term and interfacial terms, derive from first principles the critical radius $r^{*}$ and the nucleation barrier $\\Delta G^{*}$ for the heterogeneous case of a spherical cap nucleus with contact angle $\\theta$, expressed in terms of $\\Delta \\mu$, $\\gamma$, and $\\theta$. Use only the geometry of a spherical cap and Young’s equation to reduce interfacial energies to $\\gamma$ and $\\theta$, and do not assume any target expressions for $r^{*}$ or $\\Delta G^{*}$.\n\nThen, using the same $\\Delta \\mu$ and $\\gamma$, derive and evaluate the corresponding homogeneous (fully spherical) critical radius and barrier. Finally, compute all quantities numerically for the parameters $\\Delta \\mu = 2.0 \\times 10^{8}\\ \\mathrm{J}\\ \\mathrm{m}^{-3}$, $\\gamma = 0.15\\ \\mathrm{J}\\ \\mathrm{m}^{-2}$, and $\\theta = \\pi/3$ (radians).\n\nReport your final numerical answers, rounded to four significant figures, in the order $\\left(r^{*}_{\\mathrm{het}}, \\Delta G^{*}_{\\mathrm{het}}, r^{*}_{\\mathrm{hom}}, \\Delta G^{*}_{\\mathrm{hom}}\\right)$. Express $r^{*}$ in nanometers and $\\Delta G^{*}$ in Joules. The angle $\\theta$ is given in radians.",
            "solution": "The problem is first validated.\n\n**Step 1: Extract Givens**\n-   **System:** A nucleus forming as a spherical cap on a planar substrate.\n-   **Contact Angle:** A fixed value $\\theta$.\n-   **Assumptions (CNT):**\n    -   Line tension is negligible.\n    -   The nucleus is isotropic with a single nucleus-solution interfacial energy, $\\gamma$.\n    -   The thermodynamic driving force is a uniform volumetric free-energy difference, $\\Delta \\mu > 0$.\n    -   The substrate is planar and homogeneous, and mechanical equilibrium is described by Young's equation.\n-   **Task 1 (Heterogeneous Case Derivation):** From the fundamental expression for the work of formation, derive the critical radius $r^{*}$ and nucleation barrier $\\Delta G^{*}$ for a spherical cap nucleus in terms of $\\Delta \\mu$, $\\gamma$, and $\\theta$, using the geometry of a spherical cap and Young's equation.\n-   **Task 2 (Homogeneous Case Derivation):** Derive the corresponding homogeneous (fully spherical) critical radius $r^{*}_{\\mathrm{hom}}$ and barrier $\\Delta G^{*}_{\\mathrm{hom}}$ using the same $\\Delta \\mu$ and $\\gamma$.\n-   **Task 3 (Numerical Calculation):**\n    -   Parameters: $\\Delta \\mu = 2.0 \\times 10^{8}\\ \\mathrm{J}\\ \\mathrm{m}^{-3}$, $\\gamma = 0.15\\ \\mathrm{J}\\ \\mathrm{m}^{-2}$, $\\theta = \\pi/3$ radians.\n    -   Reporting: Report numerical answers for $\\left(r^{*}_{\\mathrm{het}}, \\Delta G^{*}_{\\mathrm{het}}, r^{*}_{\\mathrm{hom}}, \\Delta G^{*}_{\\mathrm{hom}}\\right)$ rounded to four significant figures.\n    -   Units: $r^{*}$ in nanometers, $\\Delta G^{*}$ in Joules.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, well-posed, and objective. It is a standard problem in Classical Nucleation Theory (CNT), a fundamental concept in materials science and geochemistry. The assumptions are standard for an introductory treatment of CNT. The problem is self-contained, providing all necessary parameters and a clear set of tasks. The provided numerical values for $\\Delta \\mu$, $\\gamma$, and $\\theta$ are physically realistic for mineral nucleation processes. The problem is not trivial, ill-posed, or unverifiable.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A full, reasoned solution will be provided.\n\nThe reversible work of formation, $\\Delta G$, of a nucleus is the sum of a bulk free-energy term, which is negative and favors nucleation, and an interfacial energy term, which is positive and opposes nucleation.\n$$\n\\Delta G = \\Delta G_{\\mathrm{bulk}} + \\Delta G_{\\mathrm{surface}}\n$$\n\n**Heterogeneous Nucleation (Spherical Cap)**\n\nFirst, we define the geometry of a spherical cap of radius of curvature $r$ and contact angle $\\theta$.\nThe volume of the spherical cap, $V_{\\mathrm{cap}}$, is given by:\n$$\nV_{\\mathrm{cap}}(r) = \\frac{\\pi r^3}{3} (2 - 3\\cos\\theta + \\cos^3\\theta) = \\frac{\\pi r^3}{3} (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\nThe surface area of the curved part of the cap (the nucleus-solution interface), $A_{\\mathrm{cap}}$, is:\n$$\nA_{\\mathrm{cap}}(r) = 2\\pi r^2(1-\\cos\\theta)\n$$\nThe area of the base of the cap (the substrate-nucleus interface), $A_{\\mathrm{base}}$, is:\n$$\nA_{\\mathrm{base}}(r) = \\pi(r\\sin\\theta)^2 = \\pi r^2 \\sin^2\\theta\n$$\n\nThe Gibbs free energy of formation for the spherical cap nucleus is:\n$$\n\\Delta G_{\\mathrm{het}}(r) = -V_{\\mathrm{cap}}(r)\\Delta\\mu + \\Delta E_{\\mathrm{surface}}\n$$\nThe change in surface energy, $\\Delta E_{\\mathrm{surface}}$, accounts for the creation of the nucleus-solution interface and the replacement of a substrate-solution interface with a substrate-nucleus interface. Let $\\gamma$ be the nucleus-solution interfacial energy, $\\gamma_{\\mathrm{sub-nuc}}$ be the substrate-nucleus interfacial energy, and $\\gamma_{\\mathrm{sub-sol}}$ be the substrate-solution interfacial energy.\n$$\n\\Delta E_{\\mathrm{surface}} = A_{\\mathrm{cap}}(r)\\gamma + A_{\\mathrm{base}}(r)(\\gamma_{\\mathrm{sub-nuc}} - \\gamma_{\\mathrm{sub-sol}})\n$$\nYoung's equation describes the balance of horizontal forces at the three-phase contact line:\n$$\n\\gamma_{\\mathrm{sub-sol}} = \\gamma_{\\mathrm{sub-nuc}} + \\gamma\\cos\\theta\n$$\nRearranging gives $\\gamma_{\\mathrm{sub-nuc}} - \\gamma_{\\mathrm{sub-sol}} = -\\gamma\\cos\\theta$. Substituting this into the surface energy expression:\n$$\n\\Delta E_{\\mathrm{surface}} = A_{\\mathrm{cap}}(r)\\gamma - A_{\\mathrm{base}}(r)\\gamma\\cos\\theta\n$$\n$$\n\\Delta E_{\\mathrm{surface}} = [2\\pi r^2(1-\\cos\\theta)]\\gamma - [\\pi r^2 \\sin^2\\theta]\\gamma\\cos\\theta\n$$\nUsing the identity $\\sin^2\\theta = 1 - \\cos^2\\theta = (1-\\cos\\theta)(1+\\cos\\theta)$:\n$$\n\\Delta E_{\\mathrm{surface}} = \\gamma \\pi r^2 (1-\\cos\\theta) [2 - (1+\\cos\\theta)\\cos\\theta]\n$$\n$$\n\\Delta E_{\\mathrm{surface}} = \\gamma \\pi r^2 (1-\\cos\\theta) [2 - \\cos\\theta - \\cos^2\\theta]\n$$\nFactoring the quadratic term $2 - x - x^2 = (2+x)(1-x)$, we get:\n$$\n\\Delta E_{\\mathrm{surface}} = \\gamma \\pi r^2 (1-\\cos\\theta)^2 (2+\\cos\\theta)\n$$\nNow, we assemble the full expression for $\\Delta G_{\\mathrm{het}}(r)$:\n$$\n\\Delta G_{\\mathrm{het}}(r) = - \\frac{\\pi r^3}{3} (1-\\cos\\theta)^2(2+\\cos\\theta) \\Delta\\mu + \\pi r^2 \\gamma (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\nThe critical radius, $r^{*}_{\\mathrm{het}}$, is found by maximizing $\\Delta G_{\\mathrm{het}}(r)$ with respect to $r$:\n$$\n\\frac{d(\\Delta G_{\\mathrm{het}})}{dr} = -\\pi r^2 (1-\\cos\\theta)^2(2+\\cos\\theta) \\Delta\\mu + 2\\pi r \\gamma (1-\\cos\\theta)^2(2+\\cos\\theta) = 0\n$$\nFor a non-trivial nucleus ($r \\neq 0$), we can divide by the common factors:\n$$\n-r \\Delta\\mu + 2\\gamma = 0\n$$\n$$\nr^{*}_{\\mathrm{het}} = \\frac{2\\gamma}{\\Delta\\mu}\n$$\nThe nucleation barrier, $\\Delta G^{*}_{\\mathrm{het}}$, is $\\Delta G_{\\mathrm{het}}(r^{*}_{\\mathrm{het}})$. Substituting $r^{*}_{\\mathrm{het}}$ into the equation for $\\Delta G_{\\mathrm{het}}(r)$:\n$$\n\\Delta G^{*}_{\\mathrm{het}} = \\left( -\\frac{\\pi \\Delta\\mu}{3} (r^{*}_{\\mathrm{het}})^3 + \\pi \\gamma (r^{*}_{\\mathrm{het}})^2 \\right) (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\n$$\n\\Delta G^{*}_{\\mathrm{het}} = \\left( -\\frac{\\pi \\Delta\\mu}{3} \\left(\\frac{2\\gamma}{\\Delta\\mu}\\right)^3 + \\pi \\gamma \\left(\\frac{2\\gamma}{\\Delta\\mu}\\right)^2 \\right) (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\n$$\n\\Delta G^{*}_{\\mathrm{het}} = \\left( -\\frac{8\\pi\\gamma^3}{3(\\Delta\\mu)^2} + \\frac{4\\pi\\gamma^3}{(\\Delta\\mu)^2} \\right) (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\n$$\n\\Delta G^{*}_{\\mathrm{het}} = \\left( \\frac{4\\pi\\gamma^3}{3(\\Delta\\mu)^2} \\right) (1-\\cos\\theta)^2(2+\\cos\\theta)\n$$\n\n**Homogeneous Nucleation (Full Sphere)**\n\nFor a fully spherical nucleus, the geometry is simpler. The volume is $V_{\\mathrm{hom}}(r) = \\frac{4}{3}\\pi r^3$ and the surface area is $A_{\\mathrm{hom}}(r) = 4\\pi r^2$.\nThe Gibbs free energy of formation is:\n$$\n\\Delta G_{\\mathrm{hom}}(r) = -V_{\\mathrm{hom}}(r)\\Delta\\mu + A_{\\mathrm{hom}}(r)\\gamma = -\\frac{4}{3}\\pi r^3 \\Delta\\mu + 4\\pi r^2 \\gamma\n$$\nFinding the critical radius, $r^{*}_{\\mathrm{hom}}$, by differentiation:\n$$\n\\frac{d(\\Delta G_{\\mathrm{hom}})}{dr} = -4\\pi r^2 \\Delta\\mu + 8\\pi r \\gamma = 0\n$$\n$$\n-r \\Delta\\mu + 2\\gamma = 0 \\implies r^{*}_{\\mathrm{hom}} = \\frac{2\\gamma}{\\Delta\\mu}\n$$\nThe critical radius for homogeneous nucleation is identical to the heterogeneous case.\nThe homogeneous nucleation barrier, $\\Delta G^{*}_{\\mathrm{hom}}$, is $\\Delta G_{\\mathrm{hom}}(r^{*}_{\\mathrm{hom}})$:\n$$\n\\Delta G^{*}_{\\mathrm{hom}} = -\\frac{4}{3}\\pi \\left(\\frac{2\\gamma}{\\Delta\\mu}\\right)^3\\Delta\\mu + 4\\pi \\left(\\frac{2\\gamma}{\\Delta\\mu}\\right)^2\\gamma\n$$\n$$\n\\Delta G^{*}_{\\mathrm{hom}} = -\\frac{32\\pi\\gamma^3}{3(\\Delta\\mu)^2} + \\frac{16\\pi\\gamma^3}{(\\Delta\\mu)^2} = \\frac{-32+48}{3} \\frac{\\pi\\gamma^3}{(\\Delta\\mu)^2}\n$$\n$$\n\\Delta G^{*}_{\\mathrm{hom}} = \\frac{16\\pi\\gamma^3}{3(\\Delta\\mu)^2}\n$$\nThe relationship between the heterogeneous and homogeneous barriers is $\\Delta G^{*}_{\\mathrm{het}} = \\Delta G^{*}_{\\mathrm{hom}} \\cdot S(\\theta)$, where $S(\\theta) = \\frac{(1-\\cos\\theta)^2(2+\\cos\\theta)}{4}$ is the geometric shape factor.\n\n**Numerical Calculation**\n\nThe given parameters are $\\Delta \\mu = 2.0 \\times 10^{8}\\ \\mathrm{J}\\ \\mathrm{m}^{-3}$, $\\gamma = 0.15\\ \\mathrm{J}\\ \\mathrm{m}^{-2}$, and $\\theta = \\pi/3$. From this, $\\cos\\theta = \\cos(\\pi/3) = 0.5$.\n\n1.  **Critical Radii ($r^{*}_{\\mathrm{het}}$ and $r^{*}_{\\mathrm{hom}}$):**\n$$\nr^{*}_{\\mathrm{het}} = r^{*}_{\\mathrm{hom}} = \\frac{2\\gamma}{\\Delta\\mu} = \\frac{2 \\times 0.15\\ \\mathrm{J}\\ \\mathrm{m}^{-2}}{2.0 \\times 10^8\\ \\mathrm{J}\\ \\mathrm{m}^{-3}} = 1.5 \\times 10^{-9}\\ \\mathrm{m}\n$$\nConverting to nanometers ($1\\ \\mathrm{nm} = 10^{-9}\\ \\mathrm{m}$), we get $r^{*}_{\\mathrm{het}} = r^{*}_{\\mathrm{hom}} = 1.5\\ \\mathrm{nm}$. Rounded to four significant figures, this is $1.500\\ \\mathrm{nm}$.\n\n2.  **Homogeneous Nucleation Barrier ($\\Delta G^{*}_{\\mathrm{hom}}$):**\n$$\n\\Delta G^{*}_{\\mathrm{hom}} = \\frac{16\\pi\\gamma^3}{3(\\Delta\\mu)^2} = \\frac{16\\pi(0.15)^3}{3(2.0 \\times 10^8)^2} = \\frac{16\\pi(0.003375)}{3(4.0 \\times 10^{16})} \\ \\mathrm{J}\n$$\n$$\n\\Delta G^{*}_{\\mathrm{hom}} \\approx 1.413717 \\times 10^{-18}\\ \\mathrm{J}\n$$\nRounded to four significant figures, $\\Delta G^{*}_{\\mathrm{hom}} = 1.414 \\times 10^{-18}\\ \\mathrm{J}$.\n\n3.  **Heterogeneous Nucleation Barrier ($\\Delta G^{*}_{\\mathrm{het}}$):**\nFirst, we compute the shape factor $S(\\theta)$:\n$$\nS(\\pi/3) = \\frac{(1-\\cos(\\pi/3))^2(2+\\cos(\\pi/3))}{4} = \\frac{(1-0.5)^2(2+0.5)}{4} = \\frac{(0.5)^2(2.5)}{4} = \\frac{0.25 \\times 2.5}{4} = 0.15625\n$$\nNow, we find $\\Delta G^{*}_{\\mathrm{het}}$:\n$$\n\\Delta G^{*}_{\\mathrm{het}} = \\Delta G^{*}_{\\mathrm{hom}} \\cdot S(\\pi/3) = (1.413717 \\times 10^{-18}) \\times 0.15625 \\ \\mathrm{J} \\approx 2.20893 \\times 10^{-19}\\ \\mathrm{J}\n$$\nRounded to four significant figures, $\\Delta G^{*}_{\\mathrm{het}} = 2.209 \\times 10^{-19}\\ \\mathrm{J}$.\n\nThe final numerical answers in the specified order are $\\left(r^{*}_{\\mathrm{het}}, \\Delta G^{*}_{\\mathrm{het}}, r^{*}_{\\mathrm{hom}}, \\Delta G^{*}_{\\mathrm{hom}}\\right)$.\n$r^{*}_{\\mathrm{het}} = 1.500\\ \\mathrm{nm}$\n$\\Delta G^{*}_{\\mathrm{het}} = 2.209 \\times 10^{-19}\\ \\mathrm{J}$\n$r^{*}_{\\mathrm{hom}} = 1.500\\ \\mathrm{nm}$\n$\\Delta G^{*}_{\\mathrm{hom}} = 1.414 \\times 10^{-18}\\ \\mathrm{J}$",
            "answer": "$$\\boxed{\\begin{pmatrix} 1.500 & 2.209 \\times 10^{-19} & 1.500 & 1.414 \\times 10^{-18} \\end{pmatrix}}$$"
        },
        {
            "introduction": "Crystal surfaces in nature are rarely perfect, often featuring steps, kinks, and other defects that can act as preferential nucleation sites. This practice challenges you to extend the classical model to account for two competing nucleation pathways: on a flat terrace and at a pre-existing step. By deriving the energy barriers for both and creating a dominance criterion, you will develop the skill of modeling more complex, realistic growth environments .",
            "id": "4089731",
            "problem": "A crystal surface in an aqueous geochemical environment is growing from solution under a fixed supersaturation. Adatoms land on terraces, diffuse, and aggregate into stable two-dimensional nuclei either on the terrace or at pre-existing straight steps. Assume the following physically motivated model.\n\n- The terrace-stabilized two-dimensional nucleus is approximated by a compact circular island with isotropic step edge free energy per unit length $\\beta$ and thermodynamic driving force per unit area $\\Delta g$. The atomic area is $\\Omega$, and the chemical potential driving force per atom is $\\Delta\\mu$, related by $\\Delta g = \\Delta \\mu / \\Omega$ with $\\Delta \\mu > 0$.\n- A step-attached nucleus is approximated by a compact semicircular island that shares a straight edge with the pre-existing step. To anchor the nucleus to the step, two kinks must be formed, each costing a kink formation energy $E_k$, for a total kink penalty $2E_k$.\n- Let the areal density of steps (total step length per unit area) be $\\rho_s$.\n- The adatom concentration on terraces is uniform and equal to $c$.\n- The kinetic prefactors for the formation of a stable nucleus are $\\nu_t$ for terrace nucleation and $\\nu_s$ for step-attached nucleation, respectively. Treat the formation of a stable nucleus in both cases as bimolecular with respect to $c$, so that the prefactor enters as $\\nu_t c^2$ (per unit area) for terrace nucleation and $\\nu_s c^2$ (per unit step length) for step-attached nucleation.\n- The temperature is $T$ and the Boltzmann constant is $k_B$.\n\nUsing capillarity arguments for the reversible work to form a circular island on a terrace and a semicircular island attached to a straight step, and using Transition State Theory (TST) to relate the nucleation barrier to the kinetic rate via an Arrhenius factor, do the following:\n\n- Derive the terrace nucleation rate per unit area $J_t$.\n- Derive the step-attached nucleation rate per unit area $J_s$ as $\\rho_s$ times a rate per unit step length.\n- Derive the net nucleation rate per unit area $J_{\\mathrm{net}} = J_t + J_s$ and provide a criterion that determines whether terrace or step-attached nucleation dominates.\n- Define the dimensionless dominance ratio $R \\equiv J_s / J_t$ in closed form in terms of $\\beta$, $\\Delta\\mu$, $\\Omega$, $E_k$, $\\rho_s$, $\\nu_s$, $\\nu_t$, $k_B$, and $T$ only.\n\nReport as your final answer the single closed-form analytic expression for $R$. Do not insert any numerical values. No units are required for $R$ since it is dimensionless. The net nucleation rate $J_{\\mathrm{net}}$ and the dominance criterion must be shown in your derivation but are not required in the final answer box.",
            "solution": "The user's request is to derive the ratio of step-attached to terrace nucleation rates, $R \\equiv J_s / J_t$, based on a provided physical model for two-dimensional crystal growth. The derivation will proceed by first calculating the thermodynamic barrier for each nucleation pathway and then constructing the corresponding rates using Transition State Theory.\n\n**Step 1: Reversible Work and Nucleation Barrier for Terrace Nucleation**\n\nThe formation of a two-dimensional nucleus on a terrace is modeled as the creation of a compact circular island of radius $r$. The reversible work of formation, $\\Delta G_t(r)$, consists of two terms: a positive term for the energy cost of creating a new step edge and a negative term for the free energy gained from the solid-liquid phase transformation.\n\nThe energy cost is the product of the step's circumference, $2\\pi r$, and the step edge free energy per unit length, $\\beta$.\nThe energy gain is the product of the island's area, $\\pi r^2$, and the thermodynamic driving force per unit area, $\\Delta g$.\n\nThus, the total reversible work is:\n$$\n\\Delta G_t(r) = (2\\pi r) \\beta - (\\pi r^2) \\Delta g\n$$\n\nThe nucleation barrier, $\\Delta G_t^*$, is the maximum of this function, which corresponds to the critical nucleus. To find the critical radius, $r_t^*$, we take the derivative of $\\Delta G_t(r)$ with respect to $r$ and set it to zero:\n$$\n\\frac{d(\\Delta G_t)}{dr} = 2\\pi\\beta - 2\\pi r \\Delta g = 0\n$$\nSolving for $r$ gives the critical radius:\n$$\nr_t^* = \\frac{\\beta}{\\Delta g}\n$$\nSubstituting $r_t^*$ back into the expression for $\\Delta G_t(r)$ gives the nucleation barrier for terrace nucleation:\n$$\n\\Delta G_t^* = \\Delta G_t(r_t^*) = 2\\pi\\left(\\frac{\\beta}{\\Delta g}\\right)\\beta - \\pi\\left(\\frac{\\beta}{\\Delta g}\\right)^2 \\Delta g = \\frac{2\\pi\\beta^2}{\\Delta g} - \\frac{\\pi\\beta^2}{\\Delta g} = \\frac{\\pi\\beta^2}{\\Delta g}\n$$\nThe problem provides the relationship $\\Delta g = \\Delta\\mu / \\Omega$. Substituting this into the expression for the barrier yields:\n$$\n\\Delta G_t^* = \\frac{\\pi\\beta^2\\Omega}{\\Delta\\mu}\n$$\n\n**Step 2: Terrace Nucleation Rate ($J_t$)**\n\nAccording to Transition State Theory, the nucleation rate is given by a kinetic prefactor multiplied by an Arrhenius term containing the nucleation barrier. The problem states the kinetic prefactor for terrace nucleation is $\\nu_t c^2$ per unit area. Therefore, the terrace nucleation rate per unit area, $J_t$, is:\n$$\nJ_t = \\nu_t c^2 \\exp\\left(-\\frac{\\Delta G_t^*}{k_B T}\\right) = \\nu_t c^2 \\exp\\left(-\\frac{\\pi\\beta^2\\Omega}{k_B T \\Delta\\mu}\\right)\n$$\n\n**Step 3: Reversible Work and Nucleation Barrier for Step-Attached Nucleation**\n\nA step-attached nucleus is modeled as a semicircular island of radius $r$. The reversible work of formation, $\\Delta G_s(r)$, now includes the energy cost of the curved edge, the energy gain from the area transformed, and an additional penalty for creating two kinks to anchor the nucleus to the straight step.\n\nThe energy cost for the curved edge is its length, $\\pi r$, times $\\beta$.\nThe energy gain is the area of the semicircle, $\\frac{1}{2}\\pi r^2$, times $\\Delta g$.\nThe kink penalty is given as $2E_k$.\n\nThe total reversible work is:\n$$\n\\Delta G_s(r) = (\\pi r)\\beta - \\left(\\frac{1}{2}\\pi r^2\\right)\\Delta g + 2E_k\n$$\nTo find the critical nucleus size, $r_s^*$, we again differentiate with respect to $r$ and set to zero:\n$$\n\\frac{d(\\Delta G_s)}{dr} = \\pi\\beta - \\pi r \\Delta g = 0\n$$\nThis gives the same critical radius as the terrace case:\n$$\nr_s^* = \\frac{\\beta}{\\Delta g}\n$$\nSubstituting $r_s^*$ back gives the nucleation barrier for step-attached nucleation:\n$$\n\\Delta G_s^* = \\Delta G_s(r_s^*) = \\pi\\left(\\frac{\\beta}{\\Delta g}\\right)\\beta - \\frac{1}{2}\\pi\\left(\\frac{\\beta}{\\Delta g}\\right)^2 \\Delta g + 2E_k = \\frac{\\pi\\beta^2}{\\Delta g} - \\frac{1}{2}\\frac{\\pi\\beta^2}{\\Delta g} + 2E_k = \\frac{1}{2}\\frac{\\pi\\beta^2}{\\Delta g} + 2E_k\n$$\nSubstituting $\\Delta g = \\Delta\\mu / \\Omega$:\n$$\n\\Delta G_s^* = \\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} + 2E_k\n$$\n\n**Step 4: Step-Attached Nucleation Rate ($J_s$)**\n\nThe kinetic prefactor for step-attached nucleation is given as $\\nu_s c^2$ per unit step length. The rate per unit step length is therefore:\n$$\nJ_{s, \\text{length}} = \\nu_s c^2 \\exp\\left(-\\frac{\\Delta G_s^*}{k_B T}\\right)\n$$\nThe total step-attached nucleation rate per unit area, $J_s$, is this rate multiplied by the areal density of steps, $\\rho_s$:\n$$\nJ_s = \\rho_s J_{s, \\text{length}} = \\rho_s \\nu_s c^2 \\exp\\left(-\\frac{\\Delta G_s^*}{k_B T}\\right) = \\rho_s \\nu_s c^2 \\exp\\left(-\\frac{1}{k_B T}\\left[\\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} + 2E_k\\right]\\right)\n$$\n\n**Step 5: Net Nucleation Rate and Dominance Criterion**\n\nThe net nucleation rate per unit area, $J_{\\mathrm{net}}$, is the sum of the rates from both pathways:\n$$\nJ_{\\mathrm{net}} = J_t + J_s = \\nu_t c^2 \\exp\\left(-\\frac{\\pi\\beta^2\\Omega}{k_B T \\Delta\\mu}\\right) + \\rho_s \\nu_s c^2 \\exp\\left(-\\frac{1}{k_B T}\\left[\\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} + 2E_k\\right]\\right)\n$$\nThe dominant nucleation mechanism is determined by the relative magnitudes of $J_s$ and $J_t$.\n- Step-attached nucleation dominates if $J_s > J_t$.\n- Terrace nucleation dominates if $J_t > J_s$.\nThe crossover occurs when $J_s = J_t$.\n\n**Step 6: Dominance Ratio ($R$)**\n\nThe dimensionless dominance ratio is defined as $R \\equiv J_s / J_t$. We can compute this by dividing the expressions derived in Step 4 and Step 2.\n$$\nR = \\frac{J_s}{J_t} = \\frac{\\rho_s \\nu_s c^2 \\exp\\left(-\\frac{\\Delta G_s^*}{k_B T}\\right)}{\\nu_t c^2 \\exp\\left(-\\frac{\\Delta G_t^*}{k_B T}\\right)}\n$$\nThe term $c^2$ cancels from the numerator and denominator. We can combine the exponential terms:\n$$\nR = \\frac{\\rho_s \\nu_s}{\\nu_t} \\exp\\left(\\frac{\\Delta G_t^* - \\Delta G_s^*}{k_B T}\\right)\n$$\nNow, we compute the difference in the nucleation barriers, $\\Delta G_t^* - \\Delta G_s^*$:\n$$\n\\Delta G_t^* - \\Delta G_s^* = \\left(\\frac{\\pi\\beta^2\\Omega}{\\Delta\\mu}\\right) - \\left(\\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} + 2E_k\\right) = \\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} - 2E_k\n$$\nSubstituting this difference back into the expression for $R$ yields the final closed-form expression:\n$$\nR = \\frac{\\rho_s \\nu_s}{\\nu_t} \\exp\\left(\\frac{1}{k_B T}\\left(\\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} - 2E_k\\right)\\right)\n$$\nThis expression depends only on the parameters specified in the problem statement.\nThe dominance criterion can be stated in terms of $R$: step-attached nucleation dominates when $R > 1$, and terrace nucleation dominates when $R < 1$.",
            "answer": "$$\\boxed{\\frac{\\rho_s \\nu_s}{\\nu_t} \\exp\\left(\\frac{1}{k_B T}\\left(\\frac{\\pi\\beta^2\\Omega}{2\\Delta\\mu} - 2E_k\\right)\\right)}$$"
        },
        {
            "introduction": "Analytical models provide invaluable insight, but calculating free energy landscapes in complex systems often requires advanced computational methods. This practice bridges theory and simulation by guiding you through the implementation of an umbrella sampling protocol to compute a nucleation free energy profile. By building and applying the Weighted Histogram Analysis Method (WHAM) to simulated data, you will gain hands-on experience with the state-of-the-art techniques used to quantify reaction barriers in computational geochemistry .",
            "id": "4089734",
            "problem": "You are tasked with designing and implementing a complete umbrella sampling protocol to compute the one-dimensional free energy profile $\\Delta G(n)$ of two-dimensional cluster formation on a surface in the context of computational geochemistry. The protocol must be principled, start from equilibrium statistical mechanics, and be implementable in a single program. You must justify the choice of collective variable and bias, and then reconstruct the unbiased $\\Delta G(n)$ from biased histograms using a statistically sound method based on first principles. The collective variable should be the integer cluster size $n$ (number of adatoms in the largest connected surface cluster; treat $n$ as a discrete one-dimensional coordinate), and the biasing potential should be a harmonic function of $n$. The underlying thermodynamic driving forces are a favorable chemical potential difference and an unfavorable line tension term, both expressed in a simplified but physically meaningful model for two-dimensional nucleation.\n\nFundamental base to use in your derivation and algorithm:\n- Canonical ensemble at temperature $T$: microstate weights are proportional to $\\exp(-\\beta E)$ with $\\beta = 1/(R T)$, where $R$ is the gas constant.\n- The unbiased equilibrium probability distribution of a collective variable $n$ is $P(n) \\propto \\exp(-\\beta F(n))$, where $F(n)$ is the potential of mean force along $n$ (equal to the free energy profile up to an additive constant).\n- Under a time-independent bias potential $W(n)$ added to the system Hamiltonian, the sampled distribution becomes $P_W(n) \\propto \\exp(-\\beta[F(n) + W(n)])$.\n- Histogram reweighting must be derived from these definitions to combine multiple biased windows into a single unbiased $P(n)$, using a self-consistent approach justified from maximum likelihood and partition function consistency. A commonly used method that satisfies these requirements is the Weighted Histogram Analysis Method (WHAM), but you must derive its functional form from the above fundamental base rather than treat it as a black box.\n\nYour program must:\n1. Define a physically motivated “true” free energy model for two-dimensional cluster formation on a surface: $$\\Delta G_{\\text{true}}(n) = \\sigma n^{1/2} - \\Delta \\mu \\, n,$$ where $\\sigma$ is an effective line tension in $\\mathrm{kJ/mol}$, and $\\Delta \\mu$ is a chemical potential difference per particle in $\\mathrm{kJ/mol}$. Treat $n$ as an integer in a specified range.\n2. Construct multiple umbrella sampling windows with harmonic bias potentials of the form $$W_i(n) = \\tfrac{1}{2} k_i \\left(n - n_{0,i}\\right)^2,$$ where $k_i$ is in $\\mathrm{kJ/mol}$ per $(\\text{count})^2$ and $n_{0,i}$ is an integer center for window $i$.\n3. For each window $i$, compute the expected biased probability distribution over the specified $n$ range using $\\Delta G_{\\text{true}}(n) + W_i(n)$ and the canonical ensemble at the given $T$, deterministically convert this distribution to integer histogram counts $H_i(n)$ that sum to a specified total $N_i$ per window, and then reconstruct an unbiased distribution $P(n)$ by combining all windows through a self-consistent histogram reweighting scheme grounded in the above principles.\n4. Convert the reconstructed $P(n)$ into a relative free energy profile $\\Delta G(n)$ via $\\Delta G(n) = - R T \\ln P(n) + C$, and choose the constant $C$ such that the minimum of $\\Delta G(n)$ over the domain equals $0$.\n5. Identify the critical cluster size $n^\\star$ as the integer $n$ that maximizes $\\Delta G(n)$ over the domain where there is sampling support, and compute the corresponding barrier height $\\Delta G^\\star = \\Delta G(n^\\star)$.\n\nUnits and numerical requirements:\n- Use $R = 8.314462618 \\times 10^{-3}$ $\\mathrm{kJ/(mol \\cdot K)}$; all free energies must be computed and reported in $\\mathrm{kJ/mol}$.\n- Temperature $T$ must be in $\\mathrm{K}$.\n- Report barrier heights $\\Delta G^\\star$ rounded to three decimal places. Report $n^\\star$ as integers.\n- Angles are not used. Percentages must not be used anywhere.\n\nTest suite:\nImplement your protocol for the following three scientifically plausible cases, each representing different regimes and testing coverage and edge behavior. For each case, build the specified umbrella windows, generate deterministic histograms as described, perform the self-consistent reconstruction, and report $n^\\star$ and $\\Delta G^\\star$.\n\nCase 1 (happy path, barrier near the middle of range):\n- $T = 300$ $\\mathrm{K}$, $\\sigma = 10.0$ $\\mathrm{kJ/mol}$, $\\Delta \\mu = 0.5$ $\\mathrm{kJ/mol}$.\n- $n \\in \\{1, 2, \\dots, 180\\}$.\n- Umbrella windows: centers $n_{0,i} \\in \\{60, 90, 110, 130, 150\\}$; identical bias stiffness $k_i = 0.010$ $\\mathrm{kJ/mol}$ per $(\\text{count})^2$ for all $i$; total counts $N_i = 30000$ for all $i$.\n\nCase 2 (moderate barrier, fewer windows):\n- $T = 300$ $\\mathrm{K}$, $\\sigma = 6.0$ $\\mathrm{kJ/mol}$, $\\Delta \\mu = 0.4$ $\\mathrm{kJ/mol}$.\n- $n \\in \\{1, 2, \\dots, 120\\}$.\n- Umbrella windows: centers $n_{0,i} \\in \\{35, 55, 75, 95\\}$; identical bias stiffness $k_i = 0.015$ $\\mathrm{kJ/mol}$ per $(\\text{count})^2$ for all $i$; total counts $N_i = 25000$ for all $i$.\n\nCase 3 (edge case, barrier near $n=1$):\n- $T = 300$ $\\mathrm{K}$, $\\sigma = 2.5$ $\\mathrm{kJ/mol}$, $\\Delta \\mu = 1.2$ $\\mathrm{kJ/mol}$.\n- $n \\in \\{1, 2, \\dots, 30\\}$.\n- Umbrella windows: centers $n_{0,i} \\in \\{1, 3, 6, 10, 15\\}$; identical bias stiffness $k_i = 0.050$ $\\mathrm{kJ/mol}$ per $(\\text{count})^2$ for all $i$; total counts $N_i = 15000$ for all $i$.\n\nDeterministic histogram construction rule:\nFor each window $i$ and discrete set of $n$ values, compute the normalized biased probabilities $p_i(n) \\propto \\exp\\left(-\\beta[\\Delta G_{\\text{true}}(n) + W_i(n)]\\right)$ and deterministically convert them to integer counts $H_i(n)$ that sum to $N_i$ by using the following rule: compute $x_n = N_i p_i(n)$, let $f_n = \\lfloor x_n \\rfloor$, sum $F = \\sum_n f_n$, compute remainder $r = N_i - F$, compute fractional parts $\\phi_n = x_n - f_n$, and set $H_i(n) = f_n + 1$ for the $r$ indices with the largest $\\phi_n$ and $H_i(n) = f_n$ for all others.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order\n[$n^\\star_1, \\Delta G^\\star_1, n^\\star_2, \\Delta G^\\star_2, n^\\star_3, \\Delta G^\\star_3],$$\nwhere subscripts indicate the case index. The $\\Delta G^\\star_i$ values must be in $\\mathrm{kJ/mol}$ rounded to three decimal places, and each $n^\\star_i$ must be an integer.",
            "solution": "The objective is to formulate and implement a complete computational protocol for determining the one-dimensional free energy profile, $\\Delta G(n)$, for two-dimensional surface nucleation. The protocol uses umbrella sampling with harmonic biasing potentials and a self-consistent histogram reweighting method to reconstruct the unbiased free energy landscape from biased simulation data. The collective variable is the number of adatoms in the largest cluster, denoted by the integer $n$.\n\n**1. Theoretical Foundation**\n\nThe foundation of this analysis lies in the principles of equilibrium statistical mechanics within the canonical ensemble. At a constant temperature $T$, the probability $P(\\mathbf{x})$ of a system being in a specific microstate $\\mathbf{x}$ with energy $E(\\mathbf{x})$ is given by the Boltzmann distribution:\n$$ P(\\mathbf{x}) = \\frac{e^{-\\beta E(\\mathbf{x})}}{Z} $$\nwhere $\\beta = 1/(R T)$ is the inverse thermal energy ($R$ is the gas constant), and $Z = \\sum_{\\mathbf{x}} e^{-\\beta E(\\mathbf{x})}$ is the canonical partition function.\n\nThe free energy (or potential of mean force) $F(n)$ along a collective variable $n$ is related to the equilibrium probability distribution $P(n)$ of observing a certain value of $n$:\n$$ P(n) = \\sum_{\\mathbf{x}} P(\\mathbf{x}) \\delta(n(\\mathbf{x}) - n) \\propto e^{-\\beta F(n)} $$\nThis implies $F(n) = -RT \\ln P(n) + C$, where $C$ is an arbitrary constant. The core challenge in many systems is that standard simulations do not adequately sample high-energy regions of the $F(n)$ profile, such as transition states.\n\nUmbrella sampling overcomes this by introducing a bias potential, $W(n)$, into the system's Hamiltonian. A series of simulations, indexed by $i$, are run with different biasing potentials $W_i(n)$. In simulation $i$, the system evolves under a modified energy function $E'(\\mathbf{x}) = E(\\mathbf{x}) + W_i(n(\\mathbf{x}))$. The resulting biased probability distribution, $P_{W_i}(n)$, is:\n$$ P_{W_i}(n) \\propto e^{-\\beta(F(n) + W_i(n))} $$\nEach simulation $i$ generates a histogram of observed cluster sizes, $H_i(n)$, over a total of $N_i = \\sum_n H_i(n)$ samples. Our goal is to combine these biased histograms $\\{H_i(n)\\}$ from all $M$ windows to obtain the best possible estimate of the single, unbiased distribution $P(n)$.\n\n**2. Derivation of the Self-Consistent Reweighting Method**\n\nThe Weighted Histogram Analysis Method (WHAM) provides a statistically optimal way to achieve this. It can be derived by maximizing the likelihood of observing the collected set of histograms. Here, we derive its central equations from the principle of self-consistency.\n\nLet $P(n)$ be the unknown unbiased probability distribution we wish to determine. The probability of observing state $n$ in the $i$-th biased simulation is related to $P(n)$ by reintroducing the bias:\n$$ P_{W_i}(n) = \\frac{P(n) e^{-\\beta W_i(n)}}{\\sum_k P(k) e^{-\\beta W_k(n)}} $$\nThe number of counts we expect to observe in bin $n$ of simulation $i$ is $N_i P_{W_i}(n)$.\n\nA robust estimator for the unbiased probability $P(n)$ is proportional to the total number of times state $n$ was observed across all simulations, corrected for the biases. The total number of counts in bin $n$ is $\\sum_i H_i(n)$. To obtain the unbiased probability, we must normalize this sum by the total \"sampling effort\" directed at bin $n$. The sampling effort in simulation $j$ is proportional to its total number of samples $N_j$ and the probability of being in bin $n$, which depends on the bias $W_j(n)$ and the free energy $f_j$ of that simulation window. This leads to the first WHAM equation:\n\n$$ P(n) = \\frac{\\sum_{i=1}^M H_i(n)}{\\sum_{j=1}^M N_j e^{\\beta f_j - \\beta W_j(n)}} \\quad \\quad (1) $$\nHere, $f_j$ is a parameter representing the free energy of the $j$-th biased simulation. It is required for combining data from different thermodynamic ensembles (the biased windows).\n\nThe parameters $f_j$ are not known a priori. They must be determined self-consistently. The partition function of window $j$ can be written in terms of the unbiased distribution $P(n)$ as $Z_j \\propto \\sum_n P(n) e^{-\\beta W_j(n)}$. Taking the logarithm and relating it to the free energy $f_j \\propto -RT \\ln Z_j$, we arrive at the second WHAM equation, which ensures consistency between the window free energies and the global unbiased distribution:\n\n$$ e^{-\\beta f_j} = \\sum_n P(n) e^{-\\beta W_j(n)} \\quad \\quad (2) $$\n\nEquations (1) and (2) form a coupled, non-linear system that must be solved for the unknowns $P(n)$ and $\\{f_j\\}$. This is achieved through a self-consistent iterative procedure:\n1.  Provide an initial guess for the free energies $\\{f_j\\}$, for example, $f_j = 0$ for all $j=1, \\dots, M$.\n2.  Calculate the unnormalized probability distribution $P(n)$ for all $n$ using equation (1).\n3.  Normalize the distribution: $P(n) \\leftarrow P(n) / \\sum_k P(k)$.\n4.  Calculate new estimates for the free energies $\\{f_j\\}$ using equation (2): $f_j \\leftarrow -RT \\ln \\left( \\sum_n P(n) e^{-\\beta W_j(n)} \\right)$.\n5.  Repeat steps 2-4 until the values of $\\{f_j\\}$ (and consequently $P(n)$) converge to a stable solution.\n\n**3. Algorithmic Protocol**\n\nThe problem specifies the models and procedures to implement this framework.\n\n**Model Specification:**\n- The \"true\" underlying free energy is given by $\\Delta G_{\\text{true}}(n) = \\sigma n^{1/2} - \\Delta \\mu \\, n$. This model captures the competition between the unfavorable line tension of a 2D cluster (circumference $\\propto \\sqrt{\\text{Area}} \\propto \\sqrt{n}$) and the favorable bulk chemical potential driving growth (proportional to area, $n$).\n- The umbrella sampling bias for each window $i$ is a harmonic potential: $W_i(n) = \\frac{1}{2} k_i (n - n_{0,i})^2$.\n\n**Data Generation (Simulation of a Simulation):**\nFor each case, we first generate the \"observed\" data.\n1.  For each window $i$, we compute the total biased free energy profile: $G_{i, \\text{biased}}(n) = \\Delta G_{\\text{true}}(n) + W_i(n)$.\n2.  We calculate the corresponding exact biased probability distribution: $p_i(n) = C_i \\exp(-\\beta G_{i, \\text{biased}}(n))$, where $C_i$ is a normalization constant ensuring $\\sum_n p_i(n) = 1$.\n3.  These probabilities are converted into deterministic integer histograms $H_i(n)$ summing to a specified total $N_i$ using the rounding rule provided in the problem statement. This rule preserves the total count $N_i$ while minimizing the rounding error.\n\n**Reconstruction and Analysis:**\n1.  The generated histograms $\\{H_i(n)\\}$ and known bias potentials $\\{W_i(n)\\}$ are used as input to the self-consistent WHAM iteration described above.\n2.  Upon convergence, the final unbiased probability distribution $P(n)$ is obtained.\n3.  The reconstructed free energy profile is calculated as $\\Delta G(n) = -RT \\ln P(n)$. Note that this is only meaningful for states $n$ with non-zero probability, i.e., where at least one histogram had a count.\n4.  The profile is shifted by a constant such that its minimum value over the sampled domain is zero: $\\Delta G(n) \\leftarrow \\Delta G(n) - \\min(\\Delta G(n))$.\n5.  The critical cluster size $n^\\star$ is identified as the integer value of $n$ that maximizes the reconstructed $\\Delta G(n)$. The nucleation barrier is then $\\Delta G^\\star = \\Delta G(n^\\star)$.\n\nThis complete protocol allows for the robust determination of free energy barriers from biased simulations, forming a cornerstone of computational studies in geochemistry, materials science, and biophysics.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a complete umbrella sampling and WHAM reconstruction protocol\n    to compute free energy barriers for 2D nucleation.\n    \"\"\"\n    R = 8.314462618e-3  # Gas constant in kJ/(mol·K)\n\n    test_cases = [\n        {\n            \"T\": 300.0, \"sigma\": 10.0, \"delta_mu\": 0.5,\n            \"n_range\": np.arange(1, 181),\n            \"window_centers\": [60, 90, 110, 130, 150],\n            \"k\": 0.010, \"N\": 30000\n        },\n        {\n            \"T\": 300.0, \"sigma\": 6.0, \"delta_mu\": 0.4,\n            \"n_range\": np.arange(1, 121),\n            \"window_centers\": [35, 55, 75, 95],\n            \"k\": 0.015, \"N\": 25000\n        },\n        {\n            \"T\": 300.0, \"sigma\": 2.5, \"delta_mu\": 1.2,\n            \"n_range\": np.arange(1, 31),\n            \"window_centers\": [1, 3, 6, 10, 15],\n            \"k\": 0.050, \"N\": 15000\n        }\n    ]\n\n    final_results = []\n\n    for case in test_cases:\n        T = case[\"T\"]\n        sigma = case[\"sigma\"]\n        delta_mu = case[\"delta_mu\"]\n        n_coords = case[\"n_range\"]\n        window_centers = case[\"window_centers\"]\n        k = case[\"k\"]\n        N_samples_per_window = case[\"N\"]\n        \n        beta = 1.0 / (R * T)\n        num_bins = len(n_coords)\n        num_windows = len(window_centers)\n\n        # 1. Define true free energy and generate \"experimental\" data\n        \n        # True free energy model\n        delta_g_true = sigma * np.sqrt(n_coords) - delta_mu * n_coords\n\n        # Construct bias potentials and histograms\n        bias_potentials = np.zeros((num_windows, num_bins))\n        histograms = np.zeros((num_windows, num_bins), dtype=int)\n        \n        for i in range(num_windows):\n            n0_i = window_centers[i]\n            \n            # Harmonic bias potential for window i\n            W_i = 0.5 * k * (n_coords - n0_i)**2\n            bias_potentials[i, :] = W_i\n            \n            # Biased free energy and probability distribution\n            g_biased = delta_g_true + W_i\n            # Use log-sum-exp trick for numerical stability\n            g_biased_min = np.min(g_biased)\n            log_p_biased = -beta * (g_biased - g_biased_min)\n            p_biased = np.exp(log_p_biased)\n            p_biased /= np.sum(p_biased)\n            \n            # Deterministic histogram generation rule\n            expected_counts = N_samples_per_window * p_biased\n            floor_counts = np.floor(expected_counts).astype(int)\n            num_remainders = N_samples_per_window - np.sum(floor_counts)\n            \n            histograms[i, :] = floor_counts\n            if num_remainders > 0:\n                frac_parts = expected_counts - floor_counts\n                indices_to_increment = np.argsort(frac_parts)[-num_remainders:]\n                histograms[i, indices_to_increment] += 1\n        \n        # 2. Reconstruct unbiased free energy using WHAM\n        \n        # WHAM self-consistent iteration\n        f_j = np.zeros(num_windows)  # Window free energies\n        P_n = np.ones(num_bins) / num_bins # Initial guess for probabilities\n        \n        # Pre-compute some terms for efficiency\n        N_j_array = np.full(num_windows, N_samples_per_window)\n        H_total_n = np.sum(histograms, axis=0)\n        exp_neg_beta_W = np.exp(-beta * bias_potentials)\n        \n        # Convergence parameters\n        max_iter = 10000\n        tol = 1e-12\n\n        for iteration in range(max_iter):\n            f_j_old = np.copy(f_j)\n            \n            # Equation (1): Update P(n)\n            # Numerator is H_total_n\n            # Denominator: sum_j N_j * exp(beta*f_j) * exp(-beta*W_j(n))\n            exp_beta_f = np.exp(beta * f_j)\n            denominator = (N_j_array[:, np.newaxis] * exp_beta_f[:, np.newaxis] * exp_neg_beta_W).sum(axis=0)\n            \n            # Avoid division by zero for bins that are never sampled\n            P_n = np.zeros_like(denominator)\n            valid_mask = denominator > 0\n            P_n[valid_mask] = H_total_n[valid_mask] / denominator[valid_mask]\n            \n            # Normalize P(n)\n            P_n /= np.sum(P_n)\n            \n            # Equation (2): Update f_j\n            # exp(-beta*f_j) = sum_n P(n) * exp(-beta*W_j(n))\n            sum_val = np.sum(P_n[np.newaxis, :] * exp_neg_beta_W, axis=1)\n            \n            # Avoid log(0) for windows with no overlap with data\n            f_j = np.full_like(f_j, np.inf)\n            valid_f = sum_val > 0\n            f_j[valid_f] = - (1.0/beta) * np.log(sum_val[valid_f])\n\n            # Shift f_j to prevent drift (optional but good practice)\n            f_j -= f_j[0]\n\n            # Check for convergence\n            if np.max(np.abs(f_j - f_j_old))  tol:\n                break\n        \n        # 3. Calculate free energy profile and find the barrier\n        \n        # Only calculate G for bins with sampling support\n        sampled_mask = P_n > 0\n        \n        delta_g_recon = np.full_like(P_n, np.inf)\n        delta_g_recon[sampled_mask] = - (1.0/beta) * np.log(P_n[sampled_mask])\n\n        # Normalize so that the minimum is 0\n        delta_g_recon -= np.min(delta_g_recon[sampled_mask])\n\n        # Find critical cluster size and barrier height\n        n_sampled = n_coords[sampled_mask]\n        g_sampled = delta_g_recon[sampled_mask]\n        \n        max_idx = np.argmax(g_sampled)\n        n_star = int(n_sampled[max_idx])\n        dG_star = g_sampled[max_idx]\n        \n        final_results.extend([n_star, round(dG_star, 3)])\n\n    output_str = \",\".join(map(str, final_results))\n    print(f\"[{output_str}]\")\n\n\nsolve()\n```"
        }
    ]
}