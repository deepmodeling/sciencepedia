{
    "hands_on_practices": [
        {
            "introduction": "This first exercise provides a fundamental starting point for understanding ion association models. By making a simplifying assumption of an ideal solution, we can focus entirely on the core principles: setting up and solving the simultaneous equations for mass balance and the law of mass action. Mastering this manual calculation for a simple 1:1 electrolyte like $\\mathrm{NaCl}$ builds the essential algebraic foundation needed for more complex computational models .",
            "id": "4083233",
            "problem": "An aqueous sodium chloride solution at standard laboratory conditions is represented using a classical ion association model in which only three chemical species are present: the sodium ion $\\text{Na}^{+}$, the chloride ion $\\text{Cl}^{-}$, and the neutral contact ion pair $\\text{NaCl}^{0}$. The total molality of sodium chloride added to water is $m_{\\mathrm{NaCl,total}} = 1.0$ mol kg⁻¹. Assume an ideal solution for speciation (activity coefficients equal to unity) and neglect all other associated species or hydrolysis products. The molality-based ion-pair association constant is given as $K_{\\mathrm{ip}} = 0.2$ kg mol⁻¹ at the stated conditions.\n\nStarting from the law of mass action and conservation laws appropriate for this system, determine the molality of the neutral ion pair $m_{\\mathrm{NaCl}^{0}}$ and the molalities of the free ions $m_{\\mathrm{Na}^{+}}$ and $m_{\\mathrm{Cl}^{-}}$. Express all molalities in mol kg⁻¹ and round your results to four significant figures. Report your final values in the order $(m_{\\mathrm{NaCl}^{0}},\\, m_{\\mathrm{Na}^{+}},\\, m_{\\mathrm{Cl}^{-}})$.",
            "solution": "The problem requires the determination of the equilibrium molalities of the species $\\text{Na}^{+}$, $\\text{Cl}^{-}$, and $\\text{NaCl}^{0}$ in an aqueous solution, given the total molality of added $\\text{NaCl}$ and the ion-pair association constant. The solution is based on the law of mass action and principles of mass conservation.\n\nThe chemical equilibrium for the formation of the neutral ion pair $\\text{NaCl}^{0}$ from its constituent free ions is given by the reaction:\n$$\n\\text{Na}^{+} + \\text{Cl}^{-} \\rightleftharpoons \\text{NaCl}^{0}\n$$\nThe law of mass action for this reaction defines the molality-based association constant, $K_{\\mathrm{ip}}$.\n$$\nK_{\\mathrm{ip}} = \\frac{a_{\\mathrm{NaCl}^{0}}}{a_{\\mathrm{Na}^{+}} a_{\\mathrm{Cl}^{-}}}\n$$\nwhere $a_i$ represents the activity of species $i$. The problem specifies the assumption of an ideal solution for the purpose of speciation, which means the activity coefficients, $\\gamma_i$, of all species are equal to unity ($1$). Since activity is defined as $a_i = \\gamma_i m_i$, where $m_i$ is the molality, this assumption simplifies the mass action expression to:\n$$\nK_{\\mathrm{ip}} = \\frac{m_{\\mathrm{NaCl}^{0}}}{m_{\\mathrm{Na}^{+}} m_{\\mathrm{Cl}^{-}}}\n$$\nThe problem provides $K_{\\mathrm{ip}} = 0.2 \\, \\mathrm{kg}\\,\\mathrm{mol}^{-1}$.\n\nNext, we establish the mass balance (conservation) equations for the sodium and chloride components. The total molality of sodium chloride added to the solution is $m_{\\mathrm{NaCl,total}} = 1.0 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}$.\n\nThe total molality of sodium, $m_{\\mathrm{Na,total}}$, is distributed between the free sodium ion, $\\text{Na}^{+}$, and the ion pair, $\\text{NaCl}^{0}$. Thus, the mass balance for sodium is:\n$$\nm_{\\mathrm{Na,total}} = m_{\\mathrm{Na}^{+}} + m_{\\mathrm{NaCl}^{0}} = m_{\\mathrm{NaCl,total}}\n$$\nSimilarly, the total molality of chloride, $m_{\\mathrm{Cl,total}}$, is distributed between the free chloride ion, $\\text{Cl}^{-}$, and the ion pair, $\\text{NaCl}^{0}$. The mass balance for chloride is:\n$$\nm_{\\mathrm{Cl,total}} = m_{\\mathrm{Cl}^{-}} + m_{\\mathrm{NaCl}^{0}} = m_{\\mathrm{NaCl,total}}\n$$\nFrom these two mass balance equations, it is evident that:\n$$\nm_{\\mathrm{Na}^{+}} + m_{\\mathrm{NaCl}^{0}} = m_{\\mathrm{Cl}^{-}} + m_{\\mathrm{NaCl}^{0}}\n$$\nThis implies that the molalities of the free ions must be equal:\n$$\nm_{\\mathrm{Na}^{+}} = m_{\\mathrm{Cl}^{-}}\n$$\nTo solve the system, let us define a variable $x$ representing the molality of the free ions:\n$$\nx = m_{\\mathrm{Na}^{+}} = m_{\\mathrm{Cl}^{-}}\n$$\nUsing the mass balance equation for sodium, we can express the molality of the ion pair, $m_{\\mathrm{NaCl}^{0}}$, in terms of $x$:\n$$\nm_{\\mathrm{NaCl}^{0}} = m_{\\mathrm{NaCl,total}} - m_{\\mathrm{Na}^{+}} = m_{\\mathrm{NaCl,total}} - x\n$$\nNow, substitute the expressions for $m_{\\mathrm{Na}^{+}}$, $m_{\\mathrm{Cl}^{-}}$, and $m_{\\mathrm{NaCl}^{0}}$ into the law of mass action equation:\n$$\nK_{\\mathrm{ip}} = \\frac{m_{\\mathrm{NaCl,total}} - x}{x \\cdot x} = \\frac{m_{\\mathrm{NaCl,total}} - x}{x^2}\n$$\nRearranging this equation yields a quadratic equation in $x$:\n$$\nK_{\\mathrm{ip}} x^2 = m_{\\mathrm{NaCl,total}} - x\n$$\n$$\nK_{\\mathrm{ip}} x^2 + x - m_{\\mathrm{NaCl,total}} = 0\n$$\nThis is a standard quadratic equation of the form $ax^2 + bx + c = 0$, with $a = K_{\\mathrm{ip}}$, $b = 1$, and $c = -m_{\\mathrm{NaCl,total}}$. The solution for $x$ is given by the quadratic formula:\n$$\nx = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a} = \\frac{-1 \\pm \\sqrt{1^2 - 4(K_{\\mathrm{ip}})(-m_{\\mathrm{NaCl,total}})}}{2K_{\\mathrm{ip}}}\n$$\n$$\nx = \\frac{-1 \\pm \\sqrt{1 + 4 K_{\\mathrm{ip}} m_{\\mathrm{NaCl,total}}}}{2 K_{\\mathrm{ip}}}\n$$\nSince $x$ represents molality, it must be a positive, real quantity. The term under the square root, $1 + 4 K_{\\mathrm{ip}} m_{\\mathrm{NaCl,total}}$, is positive since $K_{\\mathrm{ip}}  0$ and $m_{\\mathrm{NaCl,total}}  0$. Furthermore, $\\sqrt{1 + 4 K_{\\mathrm{ip}} m_{\\mathrm{NaCl,total}}}  1$. Therefore, the root with the minus sign, $\\frac{-1 - \\sqrt{\\dots}}{2 K_{\\mathrm{ip}}}$, would yield a negative value for $x$, which is physically meaningless. We must choose the positive root:\n$$\nx = \\frac{-1 + \\sqrt{1 + 4 K_{\\mathrm{ip}} m_{\\mathrm{NaCl,total}}}}{2 K_{\\mathrm{ip}}}\n$$\nWe are given $m_{\\mathrm{NaCl,total}} = 1.0 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}$ and $K_{\\mathrm{ip}} = 0.2 \\, \\mathrm{kg}\\,\\mathrm{mol}^{-1}$. Substituting these values into the expression for $x$:\n$$\nx = \\frac{-1 + \\sqrt{1 + 4(0.2)(1.0)}}{2(0.2)} = \\frac{-1 + \\sqrt{1 + 0.8}}{0.4} = \\frac{-1 + \\sqrt{1.8}}{0.4}\n$$\nCalculating the numerical value:\n$$\nx \\approx \\frac{-1 + 1.3416407865}{0.4} \\approx \\frac{0.3416407865}{0.4} \\approx 0.85410196625 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}\n$$\nTherefore, the molalities of the free ions are:\n$$\nm_{\\mathrm{Na}^{+}} = m_{\\mathrm{Cl}^{-}} = x \\approx 0.85410196625 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}\n$$\nRounding to four significant figures, we get:\n$$\nm_{\\mathrm{Na}^{+}} = m_{\\mathrm{Cl}^{-}} = 0.8541 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}\n$$\nNow, we calculate the molality of the neutral ion pair, $m_{\\mathrm{NaCl}^{0}}$:\n$$\nm_{\\mathrm{NaCl}^{0}} = m_{\\mathrm{NaCl,total}} - x = 1.0 - 0.85410196625 \\approx 0.14589803375 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}\n$$\nRounding to four significant figures:\n$$\nm_{\\mathrm{NaCl}^{0}} = 0.1459 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}\n$$\nThe final calculated molalities are $m_{\\mathrm{NaCl}^{0}} = 0.1459 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}$, $m_{\\mathrm{Na}^{+}} = 0.8541 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}$, and $m_{\\mathrm{Cl}^{-}} = 0.8541 \\, \\mathrm{mol}\\,\\mathrm{kg}^{-1}$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.1459  0.8541  0.8541 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Real-world solutions are not ideal, and accounting for non-ideality introduces a circular dependency that is best handled computationally. This practice moves beyond the ideal assumption by incorporating activity coefficients, which depend on the ionic strength that is itself determined by the speciation we aim to find. You will implement an iterative algorithm to find a self-consistent solution for a simple electrolyte, a core technique used in all modern geochemical speciation software .",
            "id": "4083219",
            "problem": "You are tasked with implementing an iterative ion association model for a fully dissociable symmetric monovalent electrolyte, written generically as $A^{+}B^{-}$, in water at $T = 25\\,^{\\circ}\\mathrm{C}$ on the molality scale. The goal is to compute the mean activity coefficient $\\gamma_{\\pm}$ of the electrolyte in the presence of ion pairing, by updating speciation and ionic strength to self-consistency.\n\nUse the following fundamental base and definitions:\n- The association reaction is $A^{+} + B^{-} \\rightleftharpoons AB(\\mathrm{aq})$. The thermodynamic ion-pairing constant on the molality scale is defined as\n$$\nK_{\\mathrm{ip}} \\equiv \\frac{a_{AB}}{a_{A^{+}}\\,a_{B^{-}}},\n$$\nwhere $a_{i}$ denotes the activity of species $i$ with the molality standard state $m^{\\ominus} = 1\\,\\mathrm{mol}\\,\\mathrm{kg}^{-1}$.\n- Activities are $a_{i} = m_{i}\\,\\gamma_{i}$ for all species $i$, where $m_{i}$ is molality and $\\gamma_{i}$ is the activity coefficient. Assume the neutral ion pair has $\\gamma_{AB} = 1$.\n- The total stoichiometric (analytical) molality of the electrolyte is $m_{\\mathrm{tot}}$. Mass balance gives $m_{\\mathrm{tot}} = m_{A^{+}} + m_{AB} = m_{B^{-}} + m_{AB}$. Due to symmetry and charge neutrality, $m_{A^{+}} = m_{B^{-}} \\equiv m$, and therefore $m_{\\mathrm{tot}} = m + m_{AB}$.\n- The ionic strength is\n$$\nI = \\frac{1}{2} \\sum_{i} m_{i} z_{i}^{2}.\n$$\nFor the present case, $z_{A^{+}} = +1$ and $z_{B^{-}} = -1$, while the neutral ion pair $AB$ does not contribute to ionic strength. Therefore, $I = \\frac{1}{2}(m \\cdot 1^{2} + m \\cdot 1^{2}) = m$.\n- The mean activity coefficient of the electrolyte is defined as\n$$\n\\gamma_{\\pm} \\equiv \\sqrt{\\gamma_{A^{+}} \\gamma_{B^{-}}}.\n$$\nFor a symmetric monovalent electrolyte, $\\gamma_{A^{+}} = \\gamma_{B^{-}}$, so $\\gamma_{\\pm} = \\gamma_{A^{+}} = \\gamma_{B^{-}}$.\n- For monovalent ions at $T = 25\\,^{\\circ}\\mathrm{C}$ in water, use the Davies equation as a well-tested approximation for the single-ion activity coefficient:\n$$\n\\log_{10} \\gamma_{i} = -A z_{i}^{2} \\left( \\frac{\\sqrt{I}}{1 + \\sqrt{I}} - 0.3 I \\right),\n$$\nwith $A = 0.509$ and $z_{i} \\in \\{+1,-1\\}$.\n\nTask and algorithmic requirements:\n- For given $m_{\\mathrm{tot}}$ (in $\\mathrm{mol}\\,\\mathrm{kg}^{-1}$) and $K_{\\mathrm{ip}}$ (dimensionless on the molality standard state), compute $\\gamma_{\\pm}$ by iteratively updating speciation and ionic strength to self-consistency. The iteration must:\n  1. Initialize with $I^{(0)} = m_{\\mathrm{tot}}$.\n  2. At iteration $k$, compute $\\gamma_{\\pm}^{(k)}$ from the Davies equation using $I^{(k)}$ and $z_{i}^{2} = 1$.\n  3. Impose the mass action relation with activities and mass balance to update the free-ion molality $m^{(k+1)}$ and thus $I^{(k+1)}$. Use the definitions above and the assumption $\\gamma_{AB} = 1$.\n  4. Stop when $|I^{(k+1)} - I^{(k)}|  \\tau$ with tolerance $\\tau = 10^{-12}\\,\\mathrm{mol}\\,\\mathrm{kg}^{-1}$, or after a maximum of $N_{\\max} = 1000$ iterations. If $K_{\\mathrm{ip}} = 0$, treat the special case exactly.\n- Scientific realism: adopt only the stated assumptions; do not introduce any others.\n- The output of your program must be the computed $\\gamma_{\\pm}$ values (dimensionless) for each test case, rounded to six decimal places.\n\nTest suite:\nCompute $\\gamma_{\\pm}$ for the following $(m_{\\mathrm{tot}}, K_{\\mathrm{ip}})$ pairs, where $m_{\\mathrm{tot}}$ is in $\\mathrm{mol}\\,\\mathrm{kg}^{-1}$ and $K_{\\mathrm{ip}}$ is dimensionless:\n1. $m_{\\mathrm{tot}} = 0.01$, $K_{\\mathrm{ip}} = 0$.\n2. $m_{\\mathrm{tot}} = 0.1$, $K_{\\mathrm{ip}} = 10$.\n3. $m_{\\mathrm{tot}} = 0.0001$, $K_{\\mathrm{ip}} = 100$.\n4. $m_{\\mathrm{tot}} = 0.5$, $K_{\\mathrm{ip}} = 1$.\n5. $m_{\\mathrm{tot}} = 0.000001$, $K_{\\mathrm{ip}} = 1000000$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each result rounded to six decimal places and expressed as dimensionless floats (e.g., $[0.987654,0.876543,0.765432]$).",
            "solution": "To compute the mean activity coefficient, $\\gamma_{\\pm}$, for the electrolyte $A^{+}B^{-}$, we must find a self-consistent solution for the free-ion molality, ionic strength, and activity coefficients. The calculation combines three key components: mass conservation, the law of mass action for the ion-pairing equilibrium, and an activity coefficient model.\n\n1.  **Conservation of Mass**: The total molality of the electrolyte, $m_{\\mathrm{tot}}$, is distributed between the free ions ($A^{+}$ and $B^{-}$) and the neutral ion pair ($AB$). Let $m$ be the molality of the free ions $A^{+}$ and $B^{-}$, so $m \\equiv m_{A^{+}} = m_{B^{-}}$. The molality of the ion pair is $m_{AB}$. The mass balance equation is:\n    $$m_{\\mathrm{tot}} = m + m_{AB}$$\n\n2.  **Law of Mass Action**: The ion-pairing reaction $A^{+} + B^{-} \\rightleftharpoons AB(\\mathrm{aq})$ is described by the thermodynamic equilibrium constant $K_{\\mathrm{ip}}$:\n    $$K_{\\mathrm{ip}} = \\frac{a_{AB}}{a_{A^{+}} a_{B^{-}}}$$\n    The activity of a species $i$ is given by $a_{i} = m_{i}\\gamma_{i}$. For the symmetric electrolyte, $a_{A^{+}} = m\\gamma_{A^{+}}$ and $a_{B^{-}} = m\\gamma_{B^{-}}$. We use the mean activity coefficient definition $\\gamma_{\\pm} = \\sqrt{\\gamma_{A^{+}}\\gamma_{B^{-}}}$. Since $\\gamma_{A^{+}} = \\gamma_{B^{-}}$ for this system, we have $\\gamma_{\\pm} = \\gamma_{A^{+}} = \\gamma_{B^{-}}$. The activity of the neutral ion pair is $a_{AB} = m_{AB}\\gamma_{AB}$. With the given assumption that $\\gamma_{AB} = 1$, the mass action expression becomes:\n    $$K_{\\mathrm{ip}} = \\frac{m_{AB}}{(m \\gamma_{\\pm})^2}$$\n\n3.  **Activity Coefficient Model**: The single-ion activity coefficients, and thus $\\gamma_{\\pm}$, are dependent on the ionic strength $I$. The ionic strength is defined as $I = \\frac{1}{2} \\sum_{i} m_{i} z_{i}^{2}$. For this system, with $z_{A^{+}} = +1$ and $z_{B^{-}} = -1$, the ionic strength is simply equal to the free-ion molality:\n    $$I = \\frac{1}{2} (m \\cdot 1^2 + m \\cdot 1^2) = m$$\n    The Davies equation is used to calculate $\\gamma_{\\pm}$ from $I$:\n    $$\\log_{10} \\gamma_{\\pm} = -A z^{2} \\left( \\frac{\\sqrt{I}}{1 + \\sqrt{I}} - 0.3 I \\right)$$\n    With the constant $A=0.509$ and $z^2 = 1^2 = 1$, this simplifies to:\n    $$\\log_{10} \\gamma_{\\pm} = -0.509 \\left( \\frac{\\sqrt{I}}{1 + \\sqrt{I}} - 0.3 I \\right)$$\n\nTo find the self-consistent solution, we combine these equations. We substitute $m_{AB} = m_{\\mathrm{tot}} - m$ from mass balance into the mass action law:\n$$K_{\\mathrm{ip}} = \\frac{m_{\\mathrm{tot}} - m}{(m \\gamma_{\\pm})^2}$$\nThis can be rearranged into a quadratic equation for the free-ion molality $m$:\n$$K_{\\mathrm{ip}} \\gamma_{\\pm}^2 m^2 + m - m_{\\mathrm{tot}} = 0$$\n\nSince $\\gamma_{\\pm}$ depends on $m$ (because $I=m$), this is a nonlinear equation in $m$. We solve it using the specified iterative fixed-point algorithm.\n\n**Algorithmic Procedure**\n\nGiven $m_{\\mathrm{tot}}$ and $K_{\\mathrm{ip}}$.\n\n**Special Case:** If $K_{\\mathrm{ip}} = 0$, no ion pairs form. Therefore, $m_{AB} = 0$, and the free-ion molality is equal to the total molality, $m = m_{\\mathrm{tot}}$. The ionic strength is $I = m_{\\mathrm{tot}}$. The mean activity coefficient $\\gamma_{\\pm}$ is calculated directly from the Davies equation using this ionic strength.\n\n**Iterative Procedure for $K_{\\mathrm{ip}} > 0$:**\nAn iterative approach is used to find the free-ion molality $m$ (and ionic strength $I=m$) that satisfies the system of equations. The iteration proceeds as follows:\n\n1.  **Initialization**: Start with an initial guess for the ionic strength. A reasonable choice is to assume no ion pairing, so $I^{(0)} = m_{\\mathrm{tot}}$.\n\n2.  **Iteration**: For each step $k = 0, 1, 2, \\dots$ up to a maximum of $N_{\\max} = 1000$:\n    a.  Set the current ionic strength $I_{current} = I^{(k)}$.\n    b.  Calculate the mean activity coefficient $\\gamma_{\\pm}^{(k)}$ using the Davies equation with $I_{current}$:\n        $$\\gamma_{\\pm}^{(k)} = 10^{\\left[-0.509 \\left( \\frac{\\sqrt{I_{current}}}{1 + \\sqrt{I_{current}}} - 0.3 I_{current} \\right)\\right]}$$\n    c.  Using this $\\gamma_{\\pm}^{(k)}$, solve the quadratic equation $K_{\\mathrm{ip}} (\\gamma_{\\pm}^{(k)})^2 m^2 + m - m_{\\mathrm{tot}} = 0$ for a new free-ion molality $m^{(k+1)}$. The physically meaningful solution (positive molality) is:\n        $$m^{(k+1)} = \\frac{-1 + \\sqrt{1 + 4 K_{\\mathrm{ip}} (\\gamma_{\\pm}^{(k)})^2 m_{\\mathrm{tot}}}}{2 K_{\\mathrm{ip}} (\\gamma_{\\pm}^{(k)})^2}$$\n    d.  Update the ionic strength: $I^{(k+1)} = m^{(k+1)}$.\n    e.  **Convergence Check**: Compare the new ionic strength with the previous one. If $|I^{(k+1)} - I^{(k)}|  \\tau$, where the tolerance $\\tau = 10^{-12}\\,\\mathrm{mol}\\,\\mathrm{kg}^{-1}$, the system is considered converged. The iteration is terminated.\n\n3.  **Final Calculation**: Once the iteration has converged to a final ionic strength $I_{final}$, the final mean activity coefficient $\\gamma_{\\pm}$ is calculated one last time using the Davies equation with $I_{final}$. This ensures that the returned $\\gamma_{\\pm}$ is fully consistent with the final state of the system.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the mean activity coefficient for a symmetric monovalent electrolyte\n    using an iterative ion association model.\n    \"\"\"\n    \n    # Constants from the problem statement\n    A_DAVIES = 0.509\n    TOLERANCE = 1e-12\n    MAX_ITERATIONS = 1000\n\n    def calculate_gamma_final(m_tot_val, K_ip_val):\n        \"\"\"\n        Calculates the mean activity coefficient for a single test case.\n\n        Args:\n            m_tot_val (float): Total stoichiometric molality in mol/kg.\n            K_ip_val (float): Dimensionless ion-pairing constant.\n\n        Returns:\n            float: The calculated mean activity coefficient, gamma_pm.\n        \"\"\"\n\n        # Special case: No ion pairing\n        if K_ip_val == 0:\n            I_final = m_tot_val\n        else:\n            # Iterative solution for K_ip  0\n            # Initialize ionic strength assuming no association\n            I_current = m_tot_val \n\n            for _ in range(MAX_ITERATIONS):\n                I_old = I_current\n\n                # Step 1: Calculate gamma_pm from the current ionic strength I\n                sqrt_I = np.sqrt(I_old)\n                log10_gamma = -A_DAVIES * (sqrt_I / (1.0 + sqrt_I) - 0.3 * I_old)\n                gamma_pm = 10**log10_gamma\n\n                # Step 2: Solve the quadratic equation for the new free-ion molality 'm'\n                # a*m^2 + b*m + c = 0\n                # a = K_ip * gamma_pm^2\n                # b = 1\n                # c = -m_tot\n                a_quad = K_ip_val * gamma_pm**2\n                b_quad = 1.0\n                c_quad = -m_tot_val\n                \n                # The physically meaningful root for m must be positive.\n                m_new = (-b_quad + np.sqrt(b_quad**2 - 4 * a_quad * c_quad)) / (2 * a_quad)\n                \n                # The ionic strength I is equal to the free-ion molality m\n                I_current = m_new\n\n                # Step 3: Check for convergence\n                if np.abs(I_current - I_old)  TOLERANCE:\n                    break\n            \n            I_final = I_current\n\n        # After convergence (or max iterations), calculate the final gamma_pm\n        # with the self-consistent final ionic strength.\n        sqrt_I_final = np.sqrt(I_final)\n        log10_gamma_final = -A_DAVIES * (sqrt_I_final / (1.0 + sqrt_I_final) - 0.3 * I_final)\n        gamma_pm_final = 10**log10_gamma_final\n        \n        return gamma_pm_final\n\n    # Test cases from the problem statement\n    test_cases = [\n        (0.01, 0),\n        (0.1, 10),\n        (0.0001, 100),\n        (0.5, 1),\n        (0.000001, 1000000)\n    ]\n\n    results = []\n    for m_tot, K_ip in test_cases:\n        gamma_pm_result = calculate_gamma_final(m_tot, K_ip)\n        # Format the result to six decimal places, as a string\n        results.append(f\"{gamma_pm_result:.6f}\")\n\n    # Print the final output in the required format\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Natural waters are rarely simple, single-electrolyte systems; they are complex mixtures where different ions compete for pairing partners. This advanced computational exercise scales up the iterative, self-consistent approach to a mixed-electrolyte system containing calcium, sulfate, and carbonate. Solving this problem demonstrates how to model competitive ion association, a critical skill for accurately predicting speciation and mineral saturation in realistic geochemical environments .",
            "id": "4083189",
            "problem": "You are tasked with computing the distribution of calcium ion $\\text{Ca}^{2+}$ among the neutral ion pairs $\\text{CaSO}_4^0$, $\\text{CaCO}_3^0$, and the free ion $\\text{Ca}^{2+}$ under a set of closed-system conditions specified by given total analytical concentrations and ion association constants. The system is at standard temperature $25\\,^\\circ\\mathrm{C}$ and pressure, and only the following aqueous species are present: $\\text{Ca}^{2+}$, $\\text{SO}_4^{2-}$, $\\text{CO}_3^{2-}$, $\\text{CaSO}_4^0$, and $\\text{CaCO}_3^0$. Assume that the neutral species have unit activity coefficients, the solution is well mixed, and there are no other complexation reactions. Concentrations are on the molarity scale, denoted by M (moles per liter). All calculations must use physically consistent thermodynamic definitions.\n\nFundamental base for the calculation:\n- The law of mass action defines the ion association constants for neutral pairs as $K_{\\mathrm{ip}} = \\dfrac{a_{\\text{pair}}}{a_{\\text{cation}}\\,a_{\\text{anion}}}$, where $a_i$ denotes the activity of species $i$.\n- For each species, activity is $a_i = \\gamma_i\\,c_i$, where $\\gamma_i$ is the activity coefficient and $c_i$ is the molar concentration.\n- The ionic strength $I$ of the solution is $$I = \\dfrac{1}{2}\\sum_i c_i z_i^2,$$ where $z_i$ is the charge number of ion $i$ and the sum is over the charged (free) ions only.\n- The Davies equation (a widely used extension of the Debye–Hückel theory) at $25\\,^\\circ\\mathrm{C}$ gives the activity coefficient of an ion of charge $z$ as $$\\log_{10}\\gamma_i = -A z_i^2\\left(\\dfrac{\\sqrt{I}}{1+\\sqrt{I}} - 0.3 I\\right),$$ where $A = 0.51$ is the Debye–Hückel constant at $25\\,^\\circ\\mathrm{C}$.\n\nUnknowns and constraints:\n- Let $c_{\\mathrm{Ca^{2+}}}$, $c_{\\mathrm{SO_4^{2-}}}$, and $c_{\\mathrm{CO_3^{2-}}}$ denote the free ion concentrations in M.\n- The neutral pair concentrations satisfy the mass action relationships:\n  $$c_{\\mathrm{CaSO_4^0}} = K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}}\\,\\dfrac{\\gamma_{\\mathrm{Ca^{2+}}}\\,\\gamma_{\\mathrm{SO_4^{2-}}}}{\\gamma_{\\mathrm{CaSO_4^0}}}\\,c_{\\mathrm{Ca^{2+}}}\\,c_{\\mathrm{SO_4^{2-}}},\\quad \\gamma_{\\mathrm{CaSO_4^0}} = 1,$$\n  $$c_{\\mathrm{CaCO_3^0}} = K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}}\\,\\dfrac{\\gamma_{\\mathrm{Ca^{2+}}}\\,\\gamma_{\\mathrm{CO_3^{2-}}}}{\\gamma_{\\mathrm{CaCO_3^0}}}\\,c_{\\mathrm{Ca^{2+}}}\\,c_{\\mathrm{CO_3^{2-}}},\\quad \\gamma_{\\mathrm{CaCO_3^0}} = 1.$$\n- The mass balances (analytical totals) are\n  $$C_{\\mathrm{Ca}}^{\\mathrm{T}} = c_{\\mathrm{Ca^{2+}}} + c_{\\mathrm{CaSO_4^0}} + c_{\\mathrm{CaCO_3^0}},$$\n  $$C_{\\mathrm{SO_4}}^{\\mathrm{T}} = c_{\\mathrm{SO_4^{2-}}} + c_{\\mathrm{CaSO_4^0}},$$\n  $$C_{\\mathrm{CO_3}}^{\\mathrm{T}} = c_{\\mathrm{CO_3^{2-}}} + c_{\\mathrm{CaCO_3^0}}.$$\n- Electrically neutral closed systems without additional supporting electrolyte satisfy $$2\\,C_{\\mathrm{Ca}}^{\\mathrm{T}} = 2\\,C_{\\mathrm{SO_4}}^{\\mathrm{T}} + 2\\,C_{\\mathrm{CO_3}}^{\\mathrm{T}},$$ which is enforced in the provided test cases.\n\nYour computational task:\n- For each given parameter set, solve for $c_{\\mathrm{Ca^{2+}}}$, $c_{\\mathrm{SO_4^{2-}}}$, and $c_{\\mathrm{CO_3^{2-}}}$ such that the mass balances and mass action relationships are simultaneously satisfied, with activity coefficients computed self-consistently via the Davies equation using the ionic strength from the free ions.\n- Compute the fractions of total calcium present as $\\text{Ca}^{2+}$, $\\text{CaSO}_4^0$, and $\\text{CaCO}_3^0$, respectively:\n  $$f_{\\mathrm{Ca^{2+}}} = \\dfrac{c_{\\mathrm{Ca^{2+}}}}{C_{\\mathrm{Ca}}^{\\mathrm{T}}},\\quad f_{\\mathrm{CaSO_4^0}} = \\dfrac{c_{\\mathrm{CaSO_4^0}}}{C_{\\mathrm{Ca}}^{\\mathrm{T}}},\\quad f_{\\mathrm{CaCO_3^0}} = \\dfrac{c_{\\mathrm{CaCO_3^0}}}{C_{\\mathrm{Ca}}^{\\mathrm{T}}}.$$\n- Express all input concentrations in M and return the fractions as decimals rounded to six decimal places.\n\nTest suite:\n- Case 1 (moderate concentrations): $C_{\\mathrm{Ca}}^{\\mathrm{T}} = 0.02\\,\\mathrm{M}$, $C_{\\mathrm{SO_4}}^{\\mathrm{T}} = 0.012\\,\\mathrm{M}$, $C_{\\mathrm{CO_3}}^{\\mathrm{T}} = 0.008\\,\\mathrm{M}$, $K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}} = 10^{2.31}$, $K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}} = 10^{3.22}$.\n- Case 2 (no carbonate, weaker sulfate pairing): $C_{\\mathrm{Ca}}^{\\mathrm{T}} = 0.02\\,\\mathrm{M}$, $C_{\\mathrm{SO_4}}^{\\mathrm{T}} = 0.02\\,\\mathrm{M}$, $C_{\\mathrm{CO_3}}^{\\mathrm{T}} = 0.0\\,\\mathrm{M}$, $K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}} = 10^{1.80}$, $K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}} = 10^{3.22}$.\n- Case 3 (higher totals, stronger carbonate pairing): $C_{\\mathrm{Ca}}^{\\mathrm{T}} = 0.10\\,\\mathrm{M}$, $C_{\\mathrm{SO_4}}^{\\mathrm{T}} = 0.07\\,\\mathrm{M}$, $C_{\\mathrm{CO_3}}^{\\mathrm{T}} = 0.03\\,\\mathrm{M}$, $K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}} = 10^{2.00}$, $K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}} = 10^{3.80}$.\n- Case 4 (very dilute): $C_{\\mathrm{Ca}}^{\\mathrm{T}} = 0.0001\\,\\mathrm{M}$, $C_{\\mathrm{SO_4}}^{\\mathrm{T}} = 0.00006\\,\\mathrm{M}$, $C_{\\mathrm{CO_3}}^{\\mathrm{T}} = 0.00004\\,\\mathrm{M}$, $K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}} = 10^{2.31}$, $K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}} = 10^{3.22}$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of lists, with each inner list holding $[f_{\\mathrm{Ca^{2+}}}, f_{\\mathrm{CaSO_4^0}}, f_{\\mathrm{CaCO_3^0}}]$ for the corresponding test case, rounded to six decimal places and with no spaces, enclosed in square brackets. For example: $[[0.123456,0.234567,0.641977],[\\dots]]$.",
            "solution": "The equilibrium distribution of calcium species is found by solving a system of coupled non-linear equations derived from mass balance and the law of mass action. The activity coefficients, which depend on the solution's ionic strength, introduce the non-linearity.\n\nThe fundamental relationship for the formation of a neutral ion pair like $\\text{CaSO}_4^0$ is given by the law of mass action:\n$$K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}} = \\dfrac{a_{\\mathrm{CaSO_4^0}}}{a_{\\mathrm{Ca^{2+}}}\\,a_{\\mathrm{SO_4^{2-}}}} = \\dfrac{\\gamma_{\\mathrm{CaSO_4^0}}\\,c_{\\mathrm{CaSO_4^0}}}{\\left(\\gamma_{\\mathrm{Ca^{2+}}}\\,c_{\\mathrm{Ca^{2+}}}\\right)\\left(\\gamma_{\\mathrm{SO_4^{2-}}}\\,c_{\\mathrm{SO_4^{2-}}}\\right)}$$\nGiven the assumption that the activity coefficient of a neutral species is unity ($\\gamma_{\\text{pair}}=1$), we can express the concentration of the ion pair as:\n$$c_{\\mathrm{CaSO_4^0}} = K_{\\mathrm{ip}}^{\\mathrm{CaSO_4^0}}\\,\\gamma_{\\mathrm{Ca^{2+}}}\\,\\gamma_{\\mathrm{SO_4^{2-}}}\\,c_{\\mathrm{Ca^{2+}}}\\,c_{\\mathrm{SO_4^{2-}}}$$\nAn analogous equation holds for the $\\text{CaCO}_3^0$ ion pair:\n$$c_{\\mathrm{CaCO_3^0}} = K_{\\mathrm{ip}}^{\\mathrm{CaCO_3^0}}\\,\\gamma_{\\mathrm{Ca^{2+}}}\\,\\gamma_{\\mathrm{CO_3^{2-}}}\\,c_{\\mathrm{Ca^{2+}}}\\,c_{\\mathrm{CO_3^{2-}}}$$\nThese two equations are coupled with the three mass balance equations:\n$$C_{\\mathrm{Ca}}^{\\mathrm{T}} = c_{\\mathrm{Ca^{2+}}} + c_{\\mathrm{CaSO_4^0}} + c_{\\mathrm{CaCO_3^0}}$$\n$$C_{\\mathrm{SO_4}}^{\\mathrm{T}} = c_{\\mathrm{SO_4^{2-}}} + c_{\\mathrm{CaSO_4^0}}$$\n$$C_{\\mathrm{CO_3}}^{\\mathrm{T}} = c_{\\mathrm{CO_3^{2-}}} + c_{\\mathrm{CaCO_3^0}}$$\nThe activity coefficients ($\\gamma_{\\mathrm{Ca^{2+}}}$, $\\gamma_{\\mathrm{SO_4^{2-}}}$, $\\gamma_{\\mathrm{CO_3^{2-}}}$) are calculated using the Davies equation, which depends on the ionic strength, $I$. The ionic strength itself depends on the concentrations of the free ions:\n$$I = \\dfrac{1}{2}\\left(c_{\\mathrm{Ca^{2+}}}z_{\\mathrm{Ca^{2+}}}^2 + c_{\\mathrm{SO_4^{2-}}}z_{\\mathrm{SO_4^{2-}}}^2 + c_{\\mathrm{CO_3^{2-}}}z_{\\mathrm{CO_3^{2-}}}^2\\right) = 2\\left(c_{\\mathrm{Ca^{2+}}} + c_{\\mathrm{SO_4^{2-}}} + c_{\\mathrm{CO_3^{2-}}}\\right)$$\nThis creates a circular dependency: the species concentrations depend on the activity coefficients, which in turn depend on the species concentrations via the ionic strength.\n\nThis system of five equations and five unknown concentrations ($c_{\\mathrm{Ca^{2+}}}$, $c_{\\mathrm{SO_4^{2-}}}$, $c_{\\mathrm{CO_3^{2-}}}$, $c_{\\mathrm{CaSO_4^0}}$, $c_{\\mathrm{CaCO_3^0}}$) must be solved simultaneously. A common and robust method is to use a numerical solver. We define the free ion concentrations, $[c_{\\mathrm{Ca^{2+}}}, c_{\\mathrm{SO_4^{2-}}}, c_{\\mathrm{CO_3^{2-}}}]$, as the primary variables to be solved for. For any given guess of these three concentrations, all other quantities (ionic strength, activity coefficients, and ion pair concentrations) can be calculated. The mass balance equations can then be rewritten as residual functions, where the goal is to find the free ion concentrations that make the residuals equal to zero.\n\nThe solution procedure is as follows:\n1.  Make an initial guess for the free ion concentrations, $[c_{\\mathrm{Ca^{2+}}}, c_{\\mathrm{SO_4^{2-}}}, c_{\\mathrm{CO_3^{2-}}}]$.\n2.  Use a numerical algorithm (such as a bound-constrained, non-linear least-squares solver) to iteratively adjust the free ion concentrations to minimize the sum of squares of the mass balance residuals.\n3.  In each iteration of the solver, the residuals are calculated based on the current guess of free ion concentrations, which involves re-calculating the ionic strength, activity coefficients, and ion pair concentrations.\n4.  Once the solver converges to a solution for the free ion concentrations, the final equilibrium concentrations of the neutral pairs are calculated.\n5.  Finally, the required fractions of calcium species are computed by dividing their equilibrium concentrations by the total analytical concentration of calcium, $C_{\\mathrm{Ca}}^{\\mathrm{T}}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import least_squares\n\n# Davies activity coefficient for ions at 25 C\n# log10(gamma) = -A * z^2 * ( sqrt(I)/(1+sqrt(I)) - 0.3*I ), A=0.51\ndef davies_gamma(z, I):\n    if I = 0.0:\n        return 1.0\n    A = 0.51\n    term = np.sqrt(I)\n    log10_gamma = -A * (z ** 2) * (term / (1.0 + term) - 0.3 * I)\n    return 10.0 ** log10_gamma\n\ndef solve_case(C_Ca, C_SO4, C_CO3, K_ip_CaSO4, K_ip_CaCO3):\n    # Residual function for least squares\n    def residuals(c):\n        # Enforce non-negativity softly via bounds in solver; here we just use c directly\n        cCa, cSO4, cCO3 = c\n\n        # Ionic strength from free ions (z=+2, -2, -2)\n        I = 2.0 * (cCa + cSO4 + cCO3)  # since I = 0.5 * sum(c_i z_i^2) and z^2=4 - I = 2*(sum free)\n        # Activity coefficients via Davies equation\n        gamma_Ca = davies_gamma(2.0, I)\n        gamma_SO4 = davies_gamma(-2.0, I)\n        gamma_CO3 = davies_gamma(-2.0, I)\n\n        # Neutral species have gamma = 1\n        cCaSO4 = K_ip_CaSO4 * gamma_Ca * gamma_SO4 * cCa * cSO4\n        cCaCO3 = K_ip_CaCO3 * gamma_Ca * gamma_CO3 * cCa * cCO3\n\n        r1 = cCa + cCaSO4 + cCaCO3 - C_Ca\n        r2 = cSO4 + cCaSO4 - C_SO4\n        r3 = cCO3 + cCaCO3 - C_CO3\n        return np.array([r1, r2, r3])\n\n    # Initial guess: half of totals (small positive floor to avoid zero)\n    x0 = np.array([\n        max(C_Ca * 0.5, 1e-20),\n        max(C_SO4 * 0.5, 1e-20),\n        max(C_CO3 * 0.5, 1e-20),\n    ])\n\n    # Bounds: nonnegative concentrations\n    lower_bounds = np.array([0.0, 0.0, 0.0])\n    upper_bounds = np.array([np.inf, np.inf, np.inf])\n\n    # Solve using trust-region reflective least squares with bounds\n    res = least_squares(residuals, x0, bounds=(lower_bounds, upper_bounds), method='trf', xtol=1e-14, ftol=1e-14, gtol=1e-14, max_nfev=2000)\n\n    cCa, cSO4, cCO3 = res.x\n    # Recompute pairs for final reporting\n    I = 2.0 * (cCa + cSO4 + cCO3)\n    gamma_Ca = davies_gamma(2.0, I)\n    gamma_SO4 = davies_gamma(-2.0, I)\n    gamma_CO3 = davies_gamma(-2.0, I)\n    cCaSO4 = K_ip_CaSO4 * gamma_Ca * gamma_SO4 * cCa * cSO4\n    cCaCO3 = K_ip_CaCO3 * gamma_Ca * gamma_CO3 * cCa * cCO3\n\n    # Numerical safety: clip tiny negatives due to solver tolerances\n    cCa = max(cCa, 0.0)\n    cCaSO4 = max(cCaSO4, 0.0)\n    cCaCO3 = max(cCaCO3, 0.0)\n\n    # Fractions of total calcium\n    f_free = cCa / C_Ca if C_Ca  0 else 0.0\n    f_CaSO4 = cCaSO4 / C_Ca if C_Ca  0 else 0.0\n    f_CaCO3 = cCaCO3 / C_Ca if C_Ca  0 else 0.0\n\n    return [f_free, f_CaSO4, f_CaCO3]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (C_Ca_T [M], C_SO4_T [M], C_CO3_T [M], K_ip_CaSO4, K_ip_CaCO3)\n    test_cases = [\n        (0.02, 0.012, 0.008, 10.0**2.31, 10.0**3.22),\n        (0.02, 0.02, 0.0, 10.0**1.80, 10.0**3.22),\n        (0.10, 0.07, 0.03, 10.0**2.00, 10.0**3.80),\n        (0.0001, 0.00006, 0.00004, 10.0**2.31, 10.0**3.22),\n    ]\n\n    results = []\n    for C_Ca, C_SO4, C_CO3, K_s, K_c in test_cases:\n        fractions = solve_case(C_Ca, C_SO4, C_CO3, K_s, K_c)\n        # Round to 6 decimal places as required\n        rounded = [float(f\"{x:.6f}\") for x in fractions]\n        results.append(rounded)\n\n    # Final print statement in the exact required format: [[a,b,c],[...],...], no spaces\n    out = '[' + ','.join('[' + ','.join(f\"{x:.6f}\" for x in triple) + ']' for triple in results) + ']'\n    print(out)\n\nsolve()\n```"
        }
    ]
}