{
    "hands_on_practices": [
        {
            "introduction": "Inverse geochemical modeling begins by translating the principle of mass conservation into a system of linear equations. However, real-world chemical data often includes measurement errors and reflects unmodeled processes, leading to overdetermined systems with no exact solution. This exercise guides you through the foundational process of constructing the matrix equation $A x = b$ from process stoichiometries and then applying the method of ordinary least squares (OLS) to find the vector of process extents $x$ that provides the best possible fit to the observed data $b$ .",
            "id": "4082574",
            "problem": "A groundwater sample is analyzed for elemental totals on a molality basis, yielding the column vector of observed totals $b$ for the ordered element set $\\{\\mathrm{Na}, \\mathrm{Ca}, \\mathrm{Cl}, \\mathrm{C}, \\mathrm{S}\\}$ as\n$$\nb \\;=\\; \\begin{pmatrix}\n5 \\times 10^{-3} \\\\\n2 \\times 10^{-3} \\\\\n6 \\times 10^{-3} \\\\\n2 \\times 10^{-3} \\\\\n1 \\times 10^{-3}\n\\end{pmatrix} \\ \\text{mol kg}^{-1}.\n$$\nAssume the water chemistry arises from the linear superposition of three geochemical processes that transfer moles of elements per mole of process, represented by the component transfer vectors with respect to the same ordered element set:\n$$\nr_1 \\;=\\; \\begin{pmatrix} 1 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\qquad\nr_2 \\;=\\; \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix}, \\qquad\nr_3 \\;=\\; \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}.\n$$\nHere, $r_1$ represents a process adding one mole of sodium and one mole of chloride per mole of process (e.g., dissolution of halite), $r_2$ represents a process adding one mole of calcium and one mole of carbon per mole of process (e.g., dissolution of calcite with dissolved inorganic carbon accounting), and $r_3$ represents a process adding one mole of sulfur per mole of process (e.g., sulfate input). Let $x = (x_1, x_2, x_3)^{\\top}$ be the column vector of process extents in $\\text{mol kg}^{-1}$, where $x_j$ is the mole transfer of process $j$ per kilogram of water.\n\nStarting from the principle of conservation of mass for elements and the linearity of superposition, construct the $5 \\times 3$ stoichiometric mapping matrix $A$ such that the forward model is $A x = b$ in the absence of measurement noise. Then, acknowledging that measurement noise and unmodeled processes can render $A x = b$ inconsistent, derive from first principles the ordinary least squares (OLS) estimator that minimizes the Euclidean norm of the residual vector, $\\|A x - b\\|_2$, and compute the corresponding estimate of $x$ for the given data. Express your final numerical values of $x_1$, $x_2$, and $x_3$ in $\\text{mol kg}^{-1}$, and round each to four significant figures. Provide your final answer as a single row matrix.",
            "solution": "The problem is assessed as valid. It is scientifically grounded in the principle of mass conservation, mathematically well-posed as a linear least squares problem, and objectively stated with all necessary data provided.\n\nThe problem requires determining the process extents, represented by the vector $x$, that best explain the observed elemental totals, represented by the vector $b$, under a linear superposition model. The relationship is given by the forward model $A x = b$.\n\nFirst, we construct the stoichiometric mapping matrix $A$. The total elemental concentrations $b$ are the sum of contributions from each process $j$, weighted by its extent $x_j$. This is expressed as a linear combination of the process transfer vectors $r_j$:\n$$x_1 r_1 + x_2 r_2 + x_3 r_3 = b$$\nThis equation is equivalent to the matrix-vector multiplication $A x = b$, where the columns of the matrix $A$ are the component transfer vectors $r_1$, $r_2$, and $r_3$.\nGiven the component transfer vectors for the ordered element set $\\{\\mathrm{Na}, \\mathrm{Ca}, \\mathrm{Cl}, \\mathrm{C}, \\mathrm{S}\\}$:\n$$r_1 = \\begin{pmatrix} 1 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\quad r_2 = \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix}, \\quad r_3 = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}$$\nThe $5 \\times 3$ stoichiometric matrix $A$ is formed by arranging these vectors as its columns:\n$$A = \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix}$$\nThe full system $A x = b$ is:\n$$\\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} x_1 \\\\ x_2 \\\\ x_3 \\end{pmatrix} = \\begin{pmatrix} 5 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 6 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix}$$\nThis represents a system of $5$ equations in $3$ unknowns. From the first and third rows, we have $x_1 = 5 \\times 10^{-3}$ and $x_1 = 6 \\times 10^{-3}$, which is a contradiction. The system is overdetermined and inconsistent, meaning no exact solution for $x$ exists. This is expected in real-world scenarios due to measurement noise and unmodeled processes.\n\nWe therefore seek an approximate solution by minimizing the discrepancy between the modeled concentrations $A x$ and the observed concentrations $b$. The ordinary least squares (OLS) method finds the vector $x$ that minimizes the squared Euclidean norm of the residual vector, $r = A x - b$. The objective function to minimize is $S(x)$:\n$$S(x) = \\| A x - b \\|_2^2 = (A x - b)^{\\top} (A x - b)$$\nExpanding the expression:\n$$S(x) = (x^{\\top} A^{\\top} - b^{\\top})(A x - b) = x^{\\top} A^{\\top} A x - x^{\\top} A^{\\top} b - b^{\\top} A x + b^{\\top} b$$\nSince $b^{\\top} A x$ is a scalar, it is equal to its transpose $(b^{\\top} A x)^{\\top} = x^{\\top} A^{\\top} b$. Thus, the objective function becomes:\n$$S(x) = x^{\\top} (A^{\\top} A) x - 2 x^{\\top} (A^{\\top} b) + b^{\\top} b$$\nTo find the minimum, we compute the gradient of $S(x)$ with respect to $x$ and set it to the zero vector.\n$$\\nabla_x S(x) = \\frac{\\partial S}{\\partial x} = 2 (A^{\\top} A) x - 2 A^{\\top} b$$\nSetting the gradient to zero, $\\nabla_x S(x) = 0$:\n$$2 (A^{\\top} A) x - 2 A^{\\top} b = 0$$\n$$A^{\\top} A x = A^{\\top} b$$\nThis is the system of normal equations. The OLS estimate for $x$, denoted $\\hat{x}$, is found by solving this system. If the matrix $A^{\\top} A$ is invertible, the unique solution is:\n$$\\hat{x} = (A^{\\top} A)^{-1} A^{\\top} b$$\nThe matrix $A^{\\top} A$ is invertible if and only if the columns of $A$ (the vectors $r_j$) are linearly independent. By inspection of the vectors $r_1$, $r_2$, and $r_3$, they are indeed linearly independent.\n\nWe proceed with the calculation. First, compute $A^{\\top} A$:\n$$A^{\\top} = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix}$$\n$$A^{\\top} A = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix} \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix} = \\begin{pmatrix} 2  0  0 \\\\ 0  2  0 \\\\ 0  0  1 \\end{pmatrix}$$\nThis is a diagonal matrix, which is easily invertible. Its inverse is:\n$$(A^{\\top} A)^{-1} = \\begin{pmatrix} \\frac{1}{2}  0  0 \\\\ 0  \\frac{1}{2}  0 \\\\ 0  0  1 \\end{pmatrix}$$\nNext, we compute $A^{\\top} b$:\n$$A^{\\top} b = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix} \\begin{pmatrix} 5 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 6 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} (5 \\times 10^{-3}) + (6 \\times 10^{-3}) \\\\ (2 \\times 10^{-3}) + (2 \\times 10^{-3}) \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} 11 \\times 10^{-3} \\\\ 4 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix}$$\nFinally, we compute the OLS estimate $\\hat{x}$:\n$$\\hat{x} = (A^{\\top} A)^{-1} (A^{\\top} b) = \\begin{pmatrix} \\frac{1}{2}  0  0 \\\\ 0  \\frac{1}{2}  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} 11 \\times 10^{-3} \\\\ 4 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} \\times 11 \\times 10^{-3} \\\\ \\frac{1}{2} \\times 4 \\times 10^{-3} \\\\ 1 \\times 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} 5.5 \\times 10^{-3} \\\\ 2.0 \\times 10^{-3} \\\\ 1.0 \\times 10^{-3} \\end{pmatrix}$$\nThe estimated process extents are $\\hat{x}_1 = 5.5 \\times 10^{-3}$ mol kg$^{-1}$, $\\hat{x}_2 = 2.0 \\times 10^{-3}$ mol kg$^{-1}$, and $\\hat{x}_3 = 1.0 \\times 10^{-3}$ mol kg$^{-1}$.\n\nRounding each value to four significant figures as requested:\n$\\hat{x}_1 = 5.500 \\times 10^{-3}$\n$\\hat{x}_2 = 2.000 \\times 10^{-3}$\n$\\hat{x}_3 = 1.000 \\times 10^{-3}$\n\nThe final answer is presented as a row matrix.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n5.500 \\times 10^{-3}  2.000 \\times 10^{-3}  1.000 \\times 10^{-3}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While the ordinary least squares method provides the best mathematical fit for an overdetermined system, its solutions are not guaranteed to be physically meaningful. In many geochemical contexts, such as mixing models or reaction extents, negative coefficients are nonsensical. This practice introduces the critical concept of constrained optimization by demonstrating a scenario where OLS fails, challenging you to reformulate the problem using Nonnegative Least Squares (NNLS) to obtain a physically valid result .",
            "id": "4082503",
            "problem": "You are modeling conservative mixture contributions of geochemical end-members to an observed water sample using inverse geochemical mass-balance modeling. Let there be $n$ end-members and $m$ conservative species. Denote the end-member composition matrix by $A \\in \\mathbb{R}^{m \\times n}$ where column $j$ contains the concentrations of the $m$ species for end-member $j$ expressed in milligrams per liter (mg/L). Denote the observed sample composition by $b \\in \\mathbb{R}^{m}$ in milligrams per liter (mg/L). The linear mass-balance model without closure can be written as $A f \\approx b$, where $f \\in \\mathbb{R}^{n}$ are unknown nonnegative contribution coefficients (unitless), one per end-member, whose absolute scale is not constrained by a closure condition. The standard unconstrained inverse fit solves the Ordinary Least Squares (OLS) problem: minimize the sum of squared residuals $\\lVert A f - b \\rVert_{2}^{2}$ over $f \\in \\mathbb{R}^{n}$. However, OLS can yield negative entries in $f$, which are physically meaningless. A physically consistent alternative is the Nonnegative Least Squares (NNLS) problem: minimize $\\lVert A f - b \\rVert_{2}^{2}$ subject to $f \\ge 0$ (component-wise).\n\nUsing only the following fundamental base:\n- Conservation for conservative tracers: the mixture prediction satisfies $A f$ as a linear combination of end-member compositions.\n- The Euclidean norm definition $\\lVert x \\rVert_{2}^{2} = \\sum_{i=1}^{m} x_{i}^{2}$ and the principle of least squares as minimizing $\\lVert A f - b \\rVert_{2}^{2}$.\n- The nonnegativity constraint $f \\ge 0$ as a physical requirement for source contributions.\n\nConstruct and analyze a concrete counterexample where the OLS solution yields a negative coefficient, and then reformulate and solve the corresponding NNLS problem.\n\nImplement a program that, for each specified test case, does all of the following:\n- Solves the OLS problem $\\min_{f \\in \\mathbb{R}^{n}} \\lVert A f - b \\rVert_{2}^{2}$ and returns the vector $f_{\\mathrm{OLS}}$ and its residual norm $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$.\n- Checks whether any component of $f_{\\mathrm{OLS}}$ is strictly negative (use a strict comparison against $0$ with a numerical tolerance of $10^{-10}$; that is, count as negative if $f_{j}  -10^{-10}$) and returns a boolean indicator.\n- Solves the NNLS problem $\\min_{f \\in \\mathbb{R}_{\\ge 0}^{n}} \\lVert A f - b \\rVert_{2}^{2}$ and returns the vector $f_{\\mathrm{NNLS}}$ and its residual norm $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2}$.\n\nAll concentrations in $A$ and $b$ are in milligrams per liter (mg/L). The unknowns $f$ are unitless.\n\nYour program must run the following test suite, which is designed to probe different geometric regimes of the mixing cone spanned by the end-members:\n- Test Case $1$ (counterexample with negative OLS coefficient): $m = 2$, $n = 2$. End-members have compositions\n$$\nA = \\begin{bmatrix}\n6  1 \\\\\n1  6\n\\end{bmatrix}\n\\quad \\text{(mg/L for species $S_{1}$ and $S_{2}$ in rows)},\n$$\nand the observed sample is\n$$\nb = \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix} \\ \\text{mg/L}.\n$$\n- Test Case $2$ (interior point in the nonnegative cone, exact mixture): Same $A$ as above,\n$$\nb = \\tfrac{1}{2} \\begin{bmatrix} 6 \\\\ 1 \\end{bmatrix} + \\tfrac{1}{2} \\begin{bmatrix} 1 \\\\ 6 \\end{bmatrix} = \\begin{bmatrix} 3.5 \\\\ 3.5 \\end{bmatrix} \\ \\text{mg/L}.\n$$\n- Test Case $3$ (boundary point on a ray of the cone, exact mixture): Same $A$ as above,\n$$\nb = 2 \\begin{bmatrix} 1 \\\\ 6 \\end{bmatrix} = \\begin{bmatrix} 2 \\\\ 12 \\end{bmatrix} \\ \\text{mg/L}.\n$$\n\nFor each test case, the required result is a list containing, in order:\n- The entries of $f_{\\mathrm{OLS}}$ (all $n$ values, unitless).\n- The entries of $f_{\\mathrm{NNLS}}$ (all $n$ values, unitless).\n- The scalar residual norm $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$ (unit mg/L).\n- The scalar residual norm $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2}$ (unit mg/L).\n- The indicator for whether $f_{\\mathrm{OLS}}$ contains any negative component, returned as an integer $1$ if negative exists and $0$ otherwise.\n\nNumerical formatting requirements:\n- Round every floating-point number to $6$ decimal places.\n- The negativity indicator must be an integer $0$ or $1$.\n- The final output must be a single line containing a Python-style list of the per-case lists. For example, the outermost structure must look like $[ [\\cdots], [\\cdots], [\\cdots] ]$ with commas separating cases and values, and no extra text.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example: $[[\\text{case1\\_values}], [\\text{case2\\_values}], [\\text{case3\\_values}]]$.",
            "solution": "The problem requires an analysis and implementation of two methods for solving an inverse geochemical mass-balance model: Ordinary Least Squares (OLS) and Nonnegative Least Squares (NNLS). The core of the problem is to demonstrate a scenario where the standard OLS method yields a physically nonsensical result (a negative contribution coefficient) and how the NNLS formulation corrects this by enforcing physical constraints. The analysis will be grounded in the provided fundamental principles of conservation, least squares, and nonnegativity.\n\nThe model is described by the linear system $A f \\approx b$, where $A \\in \\mathbb{R}^{m \\times n}$ is the matrix of end-member compositions for $m$ species and $n$ end-members, $b \\in \\mathbb{R}^{m}$ is the vector of observed concentrations in a sample, and $f \\in \\mathbb{R}^{n}$ is the vector of unknown contribution coefficients. The principle of conservation for conservative tracers dictates that the composition of a mixture is a linear combination of the end-member compositions, which is expressed as the product $A f$. The goal of inverse modeling is to find the vector $f$ that best explains the observed sample $b$.\n\nThe \"best\" fit is defined by the principle of least squares, which seeks to minimize the sum of squared differences between the predicted concentrations $A f$ and the observed concentrations $b$. This is equivalent to minimizing the squared Euclidean norm of the residual vector, $r = A f - b$. The objective function to be minimized is thus $J(f) = \\lVert A f - b \\rVert_{2}^{2} = \\sum_{i=1}^{m} ( (A f)_i - b_i )^2$.\n\n**1. Ordinary Least Squares (OLS) Solution**\n\nThe OLS approach solves the minimization problem without any constraints on the coefficients $f$.\n$$\n\\min_{f \\in \\mathbb{R}^{n}} \\lVert A f - b \\rVert_{2}^{2}\n$$\nTo find the minimum, we compute the gradient of the objective function with respect to $f$ and set it to zero. The objective function can be written as $J(f) = (A f - b)^T (A f - b) = f^T A^T A f - 2 f^T A^T b + b^T b$. The gradient is:\n$$\n\\nabla_f J(f) = 2 A^T A f - 2 A^T b\n$$\nSetting the gradient to zero, $\\nabla_f J(f) = \\vec{0}$, gives the normal equations:\n$$\nA^T A f = A^T b\n$$\nIf the matrix $A^T A$ is invertible (which is true if the columns of $A$, representing the end-members, are linearly independent), there exists a unique solution for $f$:\n$$\nf_{\\mathrm{OLS}} = (A^T A)^{-1} A^T b\n$$\nThe matrix $(A^T A)^{-1} A^T$ is known as the Moore-Penrose pseudoinverse of $A$. This solution gives the smallest possible residual norm, but as will be shown, the components of $f_{\\mathrm{OLS}}$ can be negative, which contradicts the physical meaning of $f$ as source contributions.\n\n**2. Nonnegative Least Squares (NNLS) Solution**\n\nTo enforce physical realism, we must add the nonnegativity constraint, $f \\ge 0$, meaning each component $f_j \\ge 0$. This transforms the problem into a constrained optimization problem:\n$$\n\\min_{f \\in \\mathbb{R}_{\\ge 0}^{n}} \\lVert A f - b \\rVert_{2}^{2} \\quad \\text{subject to} \\quad f_j \\ge 0 \\text{ for } j=1, \\dots, n\n$$\nThis is the NNLS problem. Unlike OLS, it generally does not have a simple closed-form solution. It requires iterative numerical algorithms, such as an active-set method (e.g., the Lawson-Hanson algorithm), to find the solution. These algorithms iteratively determine which components of $f$ should be zero (the \"active set\" of constraints) and solve a smaller unconstrained least squares problem for the remaining components. The solution must satisfy the Karush-Kuhn-Tucker (KKT) conditions for optimality. The NNLS solution, $f_{\\mathrm{NNLS}}$, guarantees a physically meaningful result by design. A key trade-off is that the residual norm for NNLS must be greater than or equal to the OLS residual norm, i.e., $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2} \\ge \\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$, since the solution space is more constrained.\n\n**3. Numerical Implementation Strategy**\n\nThe numerical solution will be implemented in Python.\n- For the OLS problem, we will use `numpy.linalg.lstsq`, a robust solver for linear least-squares problems that computes $f_{\\mathrm{OLS}}$.\n- For the NNLS problem, we will use `scipy.optimize.nnls`, which implements the Lawson-Hanson active-set algorithm.\n- The residual norms, $\\lVert A f - b \\rVert_{2}$, will be calculated using `numpy.linalg.norm`.\n- The check for negative coefficients in $f_{\\mathrm{OLS}}$ will be implemented as a component-wise comparison $f_j  -10^{-10}$.\n\n**4. Analysis of Test Cases**\n\nAll test cases use $m=2$ species, $n=2$ end-members, and the end-member composition matrix:\n$$\nA = \\begin{bmatrix}\n6  1 \\\\\n1  6\n\\end{bmatrix}\n$$\n\n**Test Case 1: Counterexample**\nThe observed sample is $b = \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix}$.\n- **OLS Solution**: Since $A$ is a square, invertible matrix, the exact solution $f = A^{-1} b$ is also the OLS solution.\n$$\nf_{\\mathrm{OLS}} = A^{-1} b = \\frac{1}{35} \\begin{bmatrix} 6  -1 \\\\ -1  6 \\end{bmatrix} \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix} = \\frac{1}{35} \\begin{bmatrix} 119 \\\\ -14 \\end{bmatrix} = \\begin{bmatrix} 3.4 \\\\ -0.4 \\end{bmatrix}\n$$\nThe second coefficient, $f_2 = -0.4$, is negative. This is physically invalid, as it would imply a \"negative contribution\" or removal of end-member $2$. The residual norm is $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2} = 0$, as the fit is mathematically perfect. The negativity indicator is $1$.\n- **NNLS Solution**: The algorithm must find the best nonnegative solution. The OLS solution is infeasible. The NNLS solution must lie on the boundary of the feasible region ($f_1 \\ge 0, f_2 \\ge 0$). By inspection, setting $f_2=0$ and solving for $f_1$ to best fit $b$ yields the problem of projecting $b$ onto the vector $a_1 = [6, 1]^T$. This gives $f_1 = (a_1^T a_1)^{-1} a_1^T b = (37)^{-1} (121) \\approx 3.270270$. So, $f_{\\mathrm{NNLS}} = [3.270270, 0]^T$. The nonzero residual norm for this solution is approximately $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2} \\approx 2.301586$. This represents the minimum possible error given the nonnegativity constraint.\n\n**Test Case 2: Interior Point**\nThe observed sample is $b = \\begin{bmatrix} 3.5 \\\\ 3.5 \\end{bmatrix}$. This sample is constructed as an exact, positive mixture: $b = 0.5 a_1 + 0.5 a_2$.\n- **OLS Solution**: The exact solution is $f_{\\mathrm{OLS}} = [0.5, 0.5]^T$. Both components are positive. The residual norm is $0$. The negativity indicator is $0$.\n- **NNLS Solution**: Since the OLS solution is already in the feasible region ($f_{\\mathrm{OLS}} \\ge 0$), it is also the optimal solution for the NNLS problem. Thus, $f_{\\mathrm{NNLS}} = [0.5, 0.5]^T$, and the residual norm is $0$.\n\n**Test Case 3: Boundary Point**\nThe observed sample is $b = \\begin{bmatrix} 2 \\\\ 12 \\end{bmatrix}$. This sample is constructed as an exact mixture lying on a boundary of the nonnegative cone: $b = 0 a_1 + 2 a_2$.\n- **OLS Solution**: The exact solution is $f_{\\mathrm{OLS}} = [0, 2]^T$. The components are nonnegative. The residual norm is $0$. The negativity indicator is $0$.\n- **NNLS Solution**: As in Case 2, the OLS solution is already feasible for the NNLS problem ($f_{\\mathrm{OLS}} \\ge 0$). Therefore, it is also the NNLS solution. $f_{\\mathrm{NNLS}} = [0, 2]^T$, and the residual norm is $0$.\n\nThese test cases effectively demonstrate that OLS can fail by producing non-physical results (Case 1), while NNLS always provides a physically valid solution. When the unconstrained OLS solution happens to be nonnegative (Cases 2 and 3), the NNLS solution is identical.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import nnls\n\ndef solve():\n    \"\"\"\n    Solves OLS and NNLS problems for three geochemical mass-balance test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (np.array([[6, 1], [1, 6]]), np.array([20, 1])),\n        (np.array([[6, 1], [1, 6]]), np.array([3.5, 3.5])),\n        (np.array([[6, 1], [1, 6]]), np.array([2, 12]))\n    ]\n\n    all_results = []\n    \n    # Define the numerical tolerance for negativity check\n    negativity_tolerance = -1e-10\n\n    for A, b in test_cases:\n        # Solve the Ordinary Least Squares (OLS) problem\n        # A is a full-rank square matrix, so rcond=None ensures behavior of a standard solve.\n        f_ols, _, _, _ = np.linalg.lstsq(A, b, rcond=None)\n        \n        # Calculate the OLS residual norm\n        norm_ols = np.linalg.norm(A @ f_ols - b)\n\n        # Check if any component of f_ols is negative\n        is_negative_ols = 1 if np.any(f_ols  negativity_tolerance) else 0\n\n        # Solve the Nonnegative Least Squares (NNLS) problem\n        f_nnls, norm_nnls = nnls(A, b)\n\n        # Assemble the results for the current case\n        # The result must be a single list containing all values in order.\n        case_result_list = []\n        case_result_list.extend(f_ols.tolist())\n        case_result_list.extend(f_nnls.tolist())\n        case_result_list.append(norm_ols)\n        case_result_list.append(norm_nnls)\n        case_result_list.append(is_negative_ols)\n        \n        all_results.append(case_result_list)\n\n    # Format the final output string as a list of lists with 6 decimal places for floats.\n    case_strings = []\n    for result_list in all_results:\n        formatted_values = []\n        for value in result_list:\n            if isinstance(value, (float, np.floating)):\n                # Round to 6 decimal places and format\n                formatted_values.append(f\"{value:.6f}\")\n            else:\n                # The integer flag\n                formatted_values.append(str(value))\n        \n        case_strings.append(f\"[{','.join(formatted_values)}]\")\n    \n    final_output_string = f\"[{','.join(case_strings)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "The power of inverse modeling is greatly enhanced by incorporating additional scientific knowledge to constrain the solution space. This practice moves beyond simple non-negativity to a more sophisticated bound-constrained least squares problem, where prior information about reaction kinetics and stoichiometric limits is used to set physically-based upper bounds on reaction extents. By integrating a rate law into the inverse model, you will learn to formulate and solve a more realistic and robust problem that is representative of advanced geochemical system analysis .",
            "id": "4082512",
            "problem": "You are tasked with designing and implementing an inverse geochemical mass-balance model that estimates the extents of three coupled processes in an aqueous system: pyrite oxidation, calcite dissolution, and carbon dioxide degassing. The setting is a well-mixed aqueous reactor with measured input (initial) and output (final) concentrations of selected dissolved species. The inverse model must be constrained by a physical upper bound on pyrite oxidation derived from a surface-area limited rate law and oxidant stoichiometry.\n\nFundamental base:\n- Mass conservation for a reactive transport system in a control volume states that the change in measured, dissolved species concentrations between initial and final states equals the sum of stoichiometric contributions from all reaction extents. Let the vector of measured concentration changes be denoted by $\\Delta \\mathbf{C} \\in \\mathbb{R}^m$ and the vector of reaction extents by $\\mathbf{x} \\in \\mathbb{R}^n$, with a stoichiometric matrix $\\mathbf{S} \\in \\mathbb{R}^{m \\times n}$. Then $\\Delta \\mathbf{C} = \\mathbf{S}\\,\\mathbf{x}$ for an exact mass-balance fit.\n- A physically sound rate law for surface-controlled oxidation under oxidant-replete conditions is a zero-order rate in oxidant activity proportional to available reactive surface area. For pyrite oxidation, the rate per unit volume is $r_{\\mathrm{pyr}} = k\\,A$, where $k$ is the intrinsic rate constant in $\\mathrm{mmol}\\,\\mathrm{m}^{-2}\\,\\mathrm{hr}^{-1}$, and $A$ is the available pyrite surface area per volume in $\\mathrm{m}^2\\,\\mathrm{L}^{-1}$. Over a residence time $t$ (in $\\mathrm{hr}$), the integrated maximum extent per liter is $x_{\\mathrm{pyr}}^{\\max} = k\\,A\\,t$.\n- Independent of the kinetic upper bound, oxidant supply imposes a material limit via stoichiometry. For pyrite oxidation, the reaction consumes $3.75$ moles of dissolved oxygen per mole of pyrite, so $x_{\\mathrm{pyr}} \\leq C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75$ if no other oxygen sources are present.\n\nProcess definitions and stoichiometry:\n- Pyrite oxidation (idealized overall): $\\mathrm{FeS}_2 + \\tfrac{15}{4}\\,\\mathrm{O}_2 + \\tfrac{7}{2}\\,\\mathrm{H}_2\\mathrm{O} \\rightarrow \\mathrm{Fe(OH)}_3 + 2\\,\\mathrm{SO}_4^{2-} + 4\\,\\mathrm{H}^+$. Measured stoichiometric effects per mole of pyrite oxidized: $\\Delta \\mathrm{SO}_4^{2-} = +2$, $\\Delta \\mathrm{O}_2 = -3.75$, $\\Delta \\mathrm{Alkalinity} = -4$.\n- Calcite dissolution (acid-neutralizing path): $\\mathrm{CaCO}_3 + \\mathrm{H}^+ \\rightarrow \\mathrm{Ca}^{2+} + \\mathrm{HCO}_3^-$. Measured stoichiometric effects per mole of calcite dissolved: $\\Delta \\mathrm{Ca}^{2+} = +1$, $\\Delta \\mathrm{DIC} = +1$, $\\Delta \\mathrm{Alkalinity} = +1$.\n- Carbon dioxide degassing: $\\mathrm{HCO}_3^- \\rightleftharpoons \\mathrm{CO}_2(\\mathrm{g}) + \\mathrm{OH}^-$. In a closed-system alkalinity sense, degassing reduces dissolved inorganic carbon without changing alkalinity. Measured stoichiometric effects per mole of carbon dioxide degassed: $\\Delta \\mathrm{DIC} = -1$, $\\Delta \\mathrm{Alkalinity} = 0$.\n\nLet the measured species vector be $\\left[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}\\right]$ in that order, all expressed as millimoles per liter. Let the reaction extent vector be $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$, all expressed in millimoles per liter. Then the stoichiometric matrix is\n$$\n\\mathbf{S} =\n\\begin{bmatrix}\n2  0  0 \\\\\n0  1  0 \\\\\n0  1  -1 \\\\\n-3.75  0  0 \\\\\n-4  1  0\n\\end{bmatrix}.\n$$\n\nInverse modeling task:\n- Given initial and final concentrations for each species, compute $\\Delta \\mathbf{C} = \\mathbf{C}_{\\mathrm{final}} - \\mathbf{C}_{\\mathrm{initial}}$.\n- Estimate the nonnegative reaction extents $\\mathbf{x}$ by solving a bound-constrained linear least squares problem\n$$\n\\min_{\\mathbf{x}} \\left\\|\\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}\\right\\|_2 \\quad \\text{subject to} \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u},\n$$\nwhere lower bounds are $\\mathbf{l} = [0,0,0]$ and upper bounds are $\\mathbf{u} = [x_{\\mathrm{pyr}}^{\\max}, +\\infty, +\\infty]$ with $x_{\\mathrm{pyr}}^{\\max} = \\min\\left(k\\,A\\,t, C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75\\right)$.\n\nUnits and reporting:\n- All concentrations and reaction extents must be handled and reported in millimoles per liter. Time is in hours, surface area per volume is in square meters per liter, and the rate constant is in millimoles per square meter per hour. Report reaction extents in millimoles per liter as decimal floats.\n- Angles are not used in this problem.\n- Percentages are not used in this problem.\n\nTest suite:\nFor each case, the initial and final measured concentrations are provided as $\\left[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}\\right]$ in millimoles per liter. Rate parameters are provided as $k$ (in $\\mathrm{mmol}\\,\\mathrm{m}^{-2}\\,\\mathrm{hr}^{-1}$), $A$ (in $\\mathrm{m}^2\\,\\mathrm{L}^{-1}$), and $t$ (in hours).\n\n- Case $1$ (happy path with active oxidant-supply constraint):\n    - Initial: $[0.20, 1.00, 2.00, 0.25, 2.50]$\n    - Final: $[0.52, 1.25, 2.05, 0.10, 2.20]$\n    - Parameters: $k = 0.10$, $A = 0.80$, $t = 1.00$\n- Case $2$ (happy path with active oxidant-supply constraint):\n    - Initial: $[0.10, 0.80, 1.80, 1.00, 2.20]$\n    - Final: $[0.40, 1.10, 2.00, 0.30, 2.10]$\n    - Parameters: $k = 0.12$, $A = 3.00$, $t = 2.00$\n- Case $3$ (edge case with negligible sulfate change and small oxygen drawdown):\n    - Initial: $[0.30, 1.20, 2.20, 0.10, 2.80]$\n    - Final: $[0.30, 1.35, 2.05, 0.08, 2.95]$\n    - Parameters: $k = 0.05$, $A = 0.50$, $t = 1.00$\n\nYour program should compute the bound-constrained least-squares estimate of $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$ for each case, and produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each case result is itself a list of three decimal floats ordered as $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$ (for example, $[[0.1,0.2,0.3],[...],[...]]$). No other text should be printed.",
            "solution": "The user-provided problem is assessed to be **valid**. It is scientifically grounded in the principles of geochemical mass-balance, is mathematically well-posed as a bound-constrained linear least squares problem, and is specified with sufficient, consistent, and objective information to enable a unique solution.\n\nThe task is to determine the extents of a set of three geochemical reactions—pyrite oxidation, calcite dissolution, and carbon dioxide degassing—that best explain the observed changes in aqueous chemistry between an initial and a final state. The reaction extents, represented by the vector $\\mathbf{x} = [x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}]^T$ in units of $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$, are the unknown variables we seek to estimate.\n\nThe core of the model is the linear mass-balance equation:\n$$\n\\mathbf{S}\\,\\mathbf{x} \\approx \\Delta \\mathbf{C}\n$$\nHere, $\\Delta \\mathbf{C} = \\mathbf{C}_{\\mathrm{final}} - \\mathbf{C}_{\\mathrm{initial}}$ is the vector of measured changes in the concentrations of $m=5$ chemical species: $[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}]$. The matrix $\\mathbf{S}$ is the $m \\times n$ ($5 \\times 3$) stoichiometric matrix, which quantifies the change in each species per unit extent of each reaction. As provided, it is:\n$$\n\\mathbf{S} =\n\\begin{bmatrix}\n2  0  0 \\\\\n0  1  0 \\\\\n0  1  -1 \\\\\n-3.75  0  0 \\\\\n-4  1  0\n\\end{bmatrix}\n$$\nSince the system is overdetermined ($mn$) and measurements contain inherent uncertainty, an exact solution where $\\mathbf{S}\\,\\mathbf{x} = \\Delta \\mathbf{C}$ is unlikely. Therefore, the problem is formulated as finding the vector $\\mathbf{x}$ that minimizes the squared Euclidean norm of the residual vector, $\\mathbf{r} = \\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}$. This is a linear least squares problem.\n\nFurthermore, the solution must be physically meaningful. Reaction extents cannot be negative. Additionally, the extent of pyrite oxidation, $x_{\\mathrm{pyr}}$, is limited by both reaction kinetics and the availability of the oxidant, dissolved oxygen ($\\mathrm{O}_2$). These constraints are incorporated as bounds on the vector $\\mathbf{x}$. The full optimization problem is:\n$$\n\\min_{\\mathbf{x}} \\left\\|\\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}\\right\\|_2^2 \\quad \\text{subject to} \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u}\n$$\nThe lower bounds, $\\mathbf{l}$, enforce non-negativity for all reactions:\n$$\n\\mathbf{l} = [0, 0, 0]^T\n$$\nThe upper bounds, $\\mathbf{u}$, constrain only pyrite oxidation, with calcite dissolution and degassing being unconstrained from above. The upper bound for $x_{\\mathrm{pyr}}$ is the minimum of two physical limits:\n$1$. The kinetic limit, based on a surface-controlled rate law: $x_{\\mathrm{pyr,kin}} = k\\,A\\,t$, where $k$ is the rate constant, $A$ is the reactive surface area, and $t$ is the residence time.\n$2$. The oxidant supply limit, based on stoichiometry: $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75$, where $C_{\\mathrm{O}_2,\\mathrm{initial}}$ is the initial concentration of dissolved oxygen.\nThus, $x_{\\mathrm{pyr}}^{\\max} = \\min(x_{\\mathrm{pyr,kin}}, x_{\\mathrm{pyr,ox}})$. The upper bound vector is:\n$$\n\\mathbf{u} = [x_{\\mathrm{pyr}}^{\\max}, \\infty, \\infty]^T\n$$\nThis bound-constrained linear least squares problem can be reliably solved using numerical optimization algorithms, such as the trust-region reflective method, which is implemented in the `scipy.optimize.lsq_linear` function.\n\nThe solution proceeds by processing each test case:\n\n**Case $1$**:\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.20, 1.00, 2.00, 0.25, 2.50]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.52, 1.25, 2.05, 0.10, 2.20]^T$\n- $\\Delta \\mathbf{C} = [0.32, 0.25, 0.05, -0.15, -0.30]^T$\n- Parameters: $k=0.10$, $A=0.80$, $t=1.00$.\n- $x_{\\mathrm{pyr,kin}} = 0.10 \\times 0.80 \\times 1.00 = 0.08$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 0.25 / 3.75 \\approx 0.0667$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- The oxidant supply is the more restrictive constraint. $x_{\\mathrm{pyr}}^{\\max} \\approx 0.0667$.\n- The bounds are $\\mathbf{l} = [0, 0, 0]^T$ and $\\mathbf{u} = [0.0667, \\infty, \\infty]^T$. Solving yields the extents $\\mathbf{x}_1$.\n\n**Case $2$**:\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.10, 0.80, 1.80, 1.00, 2.20]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.40, 1.10, 2.00, 0.30, 2.10]^T$\n- $\\Delta \\mathbf{C} = [0.30, 0.30, 0.20, -0.70, -0.10]^T$\n- Parameters: $k=0.12$, $A=3.00$, $t=2.00$.\n- $x_{\\mathrm{pyr,kin}} = 0.12 \\times 3.00 \\times 2.00 = 0.72$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 1.00 / 3.75 \\approx 0.2667$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- The oxidant supply is the more restrictive constraint. $x_{\\mathrm{pyr}}^{\\max} \\approx 0.2667$.\n- The bounds are $\\mathbf{l} = [0, 0, 0]^T$ and $\\mathbf{u} = [0.2667, \\infty, \\infty]^T$. Solving yields the extents $\\mathbf{x}_2$.\n\n**Case $3$**:\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.30, 1.20, 2.20, 0.10, 2.80]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.30, 1.35, 2.05, 0.08, 2.95]^T$\n- $\\Delta \\mathbf{C} = [0.00, 0.15, -0.15, -0.02, 0.15]^T$\n- Parameters: $k=0.05$, $A=0.50$, $t=1.00$.\n- $x_{\\mathrm{pyr,kin}} = 0.05 \\times 0.50 \\times 1.00 = 0.025$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 0.10 / 3.75 \\approx 0.0267$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$.\n- In this case, the kinetic rate is the more restrictive constraint. $x_{\\mathrm{pyr}}^{\\max} = 0.025$.\n- The bounds are $\\mathbf{l} = [0, 0, 0]^T$ and $\\mathbf{u} = [0.025, \\infty, \\infty]^T$. Solving yields the extents $\\mathbf{x}_3$.\n\nThe implementation will systematically apply this procedure to each test case to generate the final list of reaction extent vectors.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import lsq_linear\n\ndef solve():\n    \"\"\"\n    Solves for the reaction extents of a geochemical system using a\n    bound-constrained linear least squares inverse model.\n    \"\"\"\n    # Define the stoichiometric matrix S.\n    # Rows correspond to species: SO4, Ca, DIC, O2, Alkalinity.\n    # Columns correspond to reactions: Pyrite oxidation, Calcite dissolution, CO2 degassing.\n    S = np.array([\n        [2.0, 0.0, 0.0],\n        [0.0, 1.0, 0.0],\n        [0.0, 1.0, -1.0],\n        [-3.75, 0.0, 0.0],\n        [-4.0, 1.0, 0.0]\n    ])\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"initial\": np.array([0.20, 1.00, 2.00, 0.25, 2.50]),\n            \"final\": np.array([0.52, 1.25, 2.05, 0.10, 2.20]),\n            \"params\": {\"k\": 0.10, \"A\": 0.80, \"t\": 1.00}\n        },\n        {\n            \"initial\": np.array([0.10, 0.80, 1.80, 1.00, 2.20]),\n            \"final\": np.array([0.40, 1.10, 2.00, 0.30, 2.10]),\n            \"params\": {\"k\": 0.12, \"A\": 3.00, \"t\": 2.00}\n        },\n        {\n            \"initial\": np.array([0.30, 1.20, 2.20, 0.10, 2.80]),\n            \"final\": np.array([0.30, 1.35, 2.05, 0.08, 2.95]),\n            \"params\": {\"k\": 0.05, \"A\": 0.50, \"t\": 1.00}\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack data for the current case.\n        C_initial = case[\"initial\"]\n        C_final = case[\"final\"]\n        params = case[\"params\"]\n        k, A, t = params[\"k\"], params[\"A\"], params[\"t\"]\n\n        # Step 1: Compute the vector of concentration changes, delta_C.\n        delta_C = C_final - C_initial\n\n        # Step 2: Calculate the upper bound for pyrite oxidation extent, x_pyr_max.\n        # This is the minimum of the kinetic limit and the oxidant supply limit.\n        x_pyr_kin_limit = k * A * t\n        \n        # O2 is the 4th species in the concentration vector (index 3).\n        C_O2_initial = C_initial[3]\n        x_pyr_ox_limit = C_O2_initial / 3.75\n        \n        x_pyr_max = min(x_pyr_kin_limit, x_pyr_ox_limit)\n\n        # Step 3: Define the lower and upper bounds for the reaction extents vector x.\n        # Lower bounds are all zero (reactions cannot proceed in reverse).\n        lower_bounds = [0.0, 0.0, 0.0]\n        # Upper bounds are infinite for calcite and degassing, and x_pyr_max for pyrite.\n        upper_bounds = [x_pyr_max, np.inf, np.inf]\n        \n        bounds = (lower_bounds, upper_bounds)\n\n        # Step 4: Solve the bound-constrained linear least squares problem.\n        # min ||S*x - delta_C||_2 subject to l = x = u\n        result = lsq_linear(S, delta_C, bounds=bounds)\n        \n        # The solution vector x contains the estimated reaction extents.\n        solution_extents = result.x.tolist()\n        results.append(solution_extents)\n\n    # Final print statement in the exact required format.\n    # e.g., [[x1,y1,z1],[x2,y2,z2]]\n    # Use of join and map requires converting the inner list to a string representation.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}