{
    "hands_on_practices": [
        {
            "introduction": "逆地球化学质量平衡模型的核心是将地球化学过程转化为一个线性代数系统。本练习将指导您如何根据观测数据和候选过程，构建基本的 $\\mathbf{A}\\mathbf{x} = \\mathbf{b}$ 模型。您将通过一个由于测量误差而导致方程组不一致的典型场景，学习如何从第一性原理推导并应用普通最小二乘法 (OLS) 来寻找最佳拟合解 。",
            "id": "4082574",
            "problem": "一个地下水样本以质量摩尔浓度为基准进行了总元素分析，对于有序元素集 $\\{\\mathrm{Na}, \\mathrm{Ca}, \\mathrm{Cl}, \\mathrm{C}, \\mathrm{S}\\}$，得到观测总量的列向量 $b$ 为\n$$\nb \\;=\\; \\begin{pmatrix}\n5 \\times 10^{-3} \\\\\n2 \\times 10^{-3} \\\\\n6 \\times 10^{-3} \\\\\n2 \\times 10^{-3} \\\\\n1 \\times 10^{-3}\n\\end{pmatrix} \\ \\text{mol kg}^{-1}.\n$$\n假设水的化学成分源于三个地球化学过程的线性叠加，每个过程每摩尔会传递若干摩尔的元素，由相对于同一有序元素集的组分传递向量表示：\n$$\nr_1 \\;=\\; \\begin{pmatrix} 1 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\qquad\nr_2 \\;=\\; \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix}, \\qquad\nr_3 \\;=\\; \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}.\n$$\n此处，$r_1$ 代表一个每摩尔过程增加一摩尔钠和一摩尔氯的过程（例如，石盐溶解），$r_2$ 代表一个每摩尔过程增加一摩尔钙和一摩尔碳的过程（例如，方解石溶解并计入溶解的无机碳），而 $r_3$ 代表一个每摩尔过程增加一摩尔硫的过程（例如，硫酸盐输入）。令 $x = (x_1, x_2, x_3)^{\\top}$ 为过程广度的列向量，单位为 $\\text{mol kg}^{-1}$，其中 $x_j$ 是过程 $j$ 每千克水所传递的摩尔数。\n\n从元素质量守恒原理和叠加的线性性质出发，构建 $5 \\times 3$ 的化学计量映射矩阵 $A$，使得在没有测量噪声的情况下，正演模型为 $A x = b$。然后，认识到测量噪声和未建模的过程可能导致 $A x = b$ 不相容，请从第一性原理推导最小化残差向量的欧几里得范数 $\\|A x - b\\|_2$ 的普通最小二乘（OLS）估计量，并为给定数据计算 $x$ 的相应估计值。以 $\\text{mol kg}^{-1}$ 为单位表示 $x_1$、$x_2$ 和 $x_3$ 的最终数值，并将每个值四舍五入到四位有效数字。以单行矩阵的形式提供你的最终答案。",
            "solution": "该问题被评估为有效。它在科学上基于质量守恒原理，在数学上是一个适定的线性最小二乘问题，并且陈述客观，提供了所有必要的数据。\n\n该问题要求确定由向量 $x$ 表示的过程广度，该广度能在线性叠加模型下最好地解释由向量 $b$ 表示的观测元素总量。这种关系由正演模型 $A x = b$ 给出。\n\n首先，我们构建化学计量映射矩阵 $A$。总元素浓度 $b$ 是每个过程 $j$ 贡献的总和，并按其广度 $x_j$ 加权。这表示为过程传递向量 $r_j$ 的线性组合：\n$$x_1 r_1 + x_2 r_2 + x_3 r_3 = b$$\n该方程等价于矩阵-向量乘法 $A x = b$，其中矩阵 $A$ 的列是组分传递向量 $r_1$、$r_2$ 和 $r_3$。\n给定有序元素集 $\\{\\mathrm{Na}, \\mathrm{Ca}, \\mathrm{Cl}, \\mathrm{C}, \\mathrm{S}\\}$ 的组分传递向量：\n$$r_1 = \\begin{pmatrix} 1 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\quad r_2 = \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\\\ 1 \\\\ 0 \\end{pmatrix}, \\quad r_3 = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}$$\n通过将这些向量作为其列来构成 $5 \\times 3$ 的化学计量矩阵 $A$：\n$$A = \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix}$$\n完整的系统 $A x = b$ 为：\n$$\\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} x_1 \\\\ x_2 \\\\ x_3 \\end{pmatrix} = \\begin{pmatrix} 5 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 6 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix}$$\n这代表了一个包含 5 个方程和 3 个未知数的方程组。从第一行和第三行，我们得到 $x_1 = 5 \\times 10^{-3}$ 和 $x_1 = 6 \\times 10^{-3}$，这是一个矛盾。该系统是超定的且不相容的，意味着不存在 $x$ 的精确解。在现实世界的情景中，由于测量噪声和未建模的过程，这是预料之中的。\n\n因此，我们通过最小化建模浓度 $A x$ 和观测浓度 $b$ 之间的差异来寻求一个近似解。普通最小二乘（OLS）法找到向量 $x$，以最小化残差向量 $r = A x - b$ 的欧几里得范数的平方。要最小化的目标函数是 $S(x)$：\n$$S(x) = \\| A x - b \\|_2^2 = (A x - b)^{\\top} (A x - b)$$\n展开表达式：\n$$S(x) = (x^{\\top} A^{\\top} - b^{\\top})(A x - b) = x^{\\top} A^{\\top} A x - x^{\\top} A^{\\top} b - b^{\\top} A x + b^{\\top} b$$\n由于 $b^{\\top} A x$ 是一个标量，它等于其转置 $(b^{\\top} A x)^{\\top} = x^{\\top} A^{\\top} b$。因此，目标函数变为：\n$$S(x) = x^{\\top} (A^{\\top} A) x - 2 x^{\\top} (A^{\\top} b) + b^{\\top} b$$\n为了找到最小值，我们计算 $S(x)$ 相对于 $x$ 的梯度，并将其设为零向量。\n$$\\nabla_x S(x) = \\frac{\\partial S}{\\partial x} = 2 (A^{\\top} A) x - 2 A^{\\top} b$$\n将梯度设为零，$\\nabla_x S(x) = 0$：\n$$2 (A^{\\top} A) x - 2 A^{\\top} b = 0$$\n$$A^{\\top} A x = A^{\\top} b$$\n这是正规方程组。$x$ 的 OLS 估计值，记为 $\\hat{x}$，可以通过求解该方程组得到。如果矩阵 $A^{\\top} A$ 是可逆的，则唯一解为：\n$$\\hat{x} = (A^{\\top} A)^{-1} A^{\\top} b$$\n矩阵 $A^{\\top} A$ 可逆的充分必要条件是 $A$ 的列（即向量 $r_j$）是线性无关的。通过检视向量 $r_1$、$r_2$ 和 $r_3$，它们确实是线性无关的。\n\n我们继续进行计算。首先，计算 $A^{\\top} A$：\n$$A^{\\top} = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix}$$\n$$A^{\\top} A = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix} \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 1  0  0 \\\\ 0  1  0 \\\\ 0  0  1 \\end{pmatrix} = \\begin{pmatrix} 2  0  0 \\\\ 0  2  0 \\\\ 0  0  1 \\end{pmatrix}$$\n这是一个对角矩阵，很容易求逆。其逆矩阵是：\n$$(A^{\\top} A)^{-1} = \\begin{pmatrix} \\frac{1}{2}  0  0 \\\\ 0  \\frac{1}{2}  0 \\\\ 0  0  1 \\end{pmatrix}$$\n接下来，我们计算 $A^{\\top} b$：\n$$A^{\\top} b = \\begin{pmatrix} 1  0  1  0  0 \\\\ 0  1  0  1  0 \\\\ 0  0  0  0  1 \\end{pmatrix} \\begin{pmatrix} 5 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 6 \\times 10^{-3} \\\\ 2 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} (5 \\times 10^{-3}) + (6 \\times 10^{-3}) \\\\ (2 \\times 10^{-3}) + (2 \\times 10^{-3}) \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} 11 \\times 10^{-3} \\\\ 4 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix}$$\n最后，我们计算 OLS 估计值 $\\hat{x}$：\n$$\\hat{x} = (A^{\\top} A)^{-1} (A^{\\top} b) = \\begin{pmatrix} \\frac{1}{2}  0  0 \\\\ 0  \\frac{1}{2}  0 \\\\ 0  0  1 \\end{pmatrix} \\begin{pmatrix} 11 \\times 10^{-3} \\\\ 4 \\times 10^{-3} \\\\ 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} \\times 11 \\times 10^{-3} \\\\ \\frac{1}{2} \\times 4 \\times 10^{-3} \\\\ 1 \\times 1 \\times 10^{-3} \\end{pmatrix} = \\begin{pmatrix} 5.5 \\times 10^{-3} \\\\ 2.0 \\times 10^{-3} \\\\ 1.0 \\times 10^{-3} \\end{pmatrix}$$\n估计的过程广度为 $\\hat{x}_1 = 5.5 \\times 10^{-3}$ mol kg$^{-1}$，$\\hat{x}_2 = 2.0 \\times 10^{-3}$ mol kg$^{-1}$，以及 $\\hat{x}_3 = 1.0 \\times 10^{-3}$ mol kg$^{-1}$。\n\n按照要求将每个值四舍五入到四位有效数字：\n$\\hat{x}_1 = 5.500 \\times 10^{-3}$\n$\\hat{x}_2 = 2.000 \\times 10^{-3}$\n$\\hat{x}_3 = 1.000 \\times 10^{-3}$\n\n最终答案以行矩阵的形式呈现。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n5.500 \\times 10^{-3}  2.000 \\times 10^{-3}  1.000 \\times 10^{-3}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "虽然普通最小二乘法 (OLS) 是一个强大的工具，但它可能会产生物理上无意义的解，例如负的混合分数。本练习通过一个具体的反例，突出了这一局限性，并引入了非负最小二乘法 (NNLS) 作为解决方案。通过亲手编写代码解决这个问题，您将学会如何通过施加非负约束来确保模型结果的物理真实性，这是从纯数学拟合迈向可靠地球化学建模的关键一步 。",
            "id": "4082503",
            "problem": "您正在使用反向地球化学质量平衡模型，对一个观测水样中地球化学端元的保守混合贡献进行建模。设存在 $n$ 个端元和 $m$ 个保守物种。将端元组分矩阵表示为 $A \\in \\mathbb{R}^{m \\times n}$，其中第 $j$ 列包含端元 $j$ 的 $m$ 个物种的浓度，单位为毫克/升 (mg/L)。将观测到的样品组分表示为 $b \\in \\mathbb{R}^{m}$，单位为毫克/升 (mg/L)。没有闭合条件的线性质量平衡模型可以写成 $A f \\approx b$，其中 $f \\in \\mathbb{R}^{n}$ 是未知的非负贡献系数（无单位），每个端元一个，其绝对尺度不受闭合条件约束。标准的无约束反演拟合求解普通最小二乘法 (OLS) 问题：在 $f \\in \\mathbb{R}^{n}$ 上最小化残差平方和 $\\lVert A f - b \\rVert_{2}^{2}$。然而，OLS 可能会在 $f$ 中产生负值，这在物理上是无意义的。一个物理上一致的替代方法是非负最小二乘法 (NNLS) 问题：在 $f \\ge 0$ (逐分量) 的约束下，最小化 $\\lVert A f - b \\rVert_{2}^{2}$。\n\n仅使用以下基本原理：\n- 保守示踪剂的守恒原理：混合物预测满足 $A f$ 作为端元组分的线性组合。\n- 欧几里得范数定义 $\\lVert x \\rVert_{2}^{2} = \\sum_{i=1}^{m} x_{i}^{2}$ 和最小二乘法原理，即最小化 $\\lVert A f - b \\rVert_{2}^{2}$。\n- 非负性约束 $f \\ge 0$ 作为源贡献的物理要求。\n\n构建并分析一个具体反例，其中 OLS 解产生一个负系数，然后重新构建并求解相应的 NNLS 问题。\n\n实现一个程序，对每个指定的测试用例，完成以下所有操作：\n- 求解 OLS 问题 $\\min_{f \\in \\mathbb{R}^{n}} \\lVert A f - b \\rVert_{2}^{2}$，并返回向量 $f_{\\mathrm{OLS}}$ 及其残差范数 $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$。\n- 检查 $f_{\\mathrm{OLS}}$ 的任何分量是否严格为负（使用与 $0$ 的严格比较，数值容差为 $10^{-10}$；也就是说，如果 $f_{j}  -10^{-10}$ 则计为负），并返回一个布尔指示符。\n- 求解 NNLS 问题 $\\min_{f \\in \\mathbb{R}_{\\ge 0}^{n}} \\lVert A f - b \\rVert_{2}^{2}$，并返回向量 $f_{\\mathrm{NNLS}}$ 及其残差范数 $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2}$。\n\n$A$ 和 $b$ 中的所有浓度单位均为毫克/升 (mg/L)。未知数 $f$ 无单位。\n\n您的程序必须运行以下测试套件，该套件旨在探测由端元张成的混合锥的不同几何区域：\n- 测试用例 1 (OLS 系数为负的反例)：$m = 2$, $n = 2$。端元组成为\n$$\nA = \\begin{bmatrix}\n6  1 \\\\\n1  6\n\\end{bmatrix}\n\\quad \\text{(mg/L，行分别为物种 $S_{1}$ 和 $S_{2}$)},\n$$\n观测到的样品为\n$$\nb = \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix} \\ \\text{mg/L}。\n$$\n- 测试用例 2 (非负锥中的内点，精确混合)：$A$ 同上，\n$$\nb = \\tfrac{1}{2} \\begin{bmatrix} 6 \\\\ 1 \\end{bmatrix} + \\tfrac{1}{2} \\begin{bmatrix} 1 \\\\ 6 \\end{bmatrix} = \\begin{bmatrix} 3.5 \\\\ 3.5 \\end{bmatrix} \\ \\text{mg/L}。\n$$\n- 测试用例 3 (锥的射线上的一点，精确混合)：$A$ 同上，\n$$\nb = 2 \\begin{bmatrix} 1 \\\\ 6 \\end{bmatrix} = \\begin{bmatrix} 2 \\\\ 12 \\end{bmatrix} \\ \\text{mg/L}。\n$$\n\n对于每个测试用例，所需的结果是一个列表，按顺序包含：\n- $f_{\\mathrm{OLS}}$ 的各项（所有 $n$ 个值，无单位）。\n- $f_{\\mathrm{NNLS}}$ 的各项（所有 $n$ 个值，无单位）。\n- 标量残差范数 $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$（单位 mg/L）。\n- 标量残差范数 $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2}$（单位 mg/L）。\n- 指示 $f_{\\mathrm{OLS}}$ 是否包含任何负分量的指示符，如果存在负值则返回整数 $1$，否则返回 $0$。\n\n数值格式要求：\n- 将每个浮点数四舍五入到 $6$ 位小数。\n- 负值指示符必须是整数 $0$ 或 $1$。\n- 最终输出必须是单行，包含一个 Python 风格的列表，其中每个元素是对应测试用例的列表。例如，最外层结构必须看起来像 $[ [\\cdots], [\\cdots], [\\cdots] ]$，用逗号分隔用例和值，且无额外文本。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如：$[[\\text{case1\\_values}], [\\text{case2\\_values}], [\\text{case3\\_values}]]$.",
            "solution": "该问题要求对解决反向地球化学质量平衡模型的两种方法进行分析和实现：普通最小二乘法 (OLS) 和非负最小二乘法 (NNLS)。问题的核心是展示一个标准 OLS 方法产生物理上无意义结果（负贡献系数）的场景，以及 NNLS 公式如何通过强制施加物理约束来纠正这一点。该分析将基于所提供的守恒、最小二乘和非负性等基本原理。\n\n模型由线性系统 $A f \\approx b$ 描述，其中 $A \\in \\mathbb{R}^{m \\times n}$ 是 $m$ 个物种和 $n$ 个端元的端元组分矩阵，$b \\in \\mathbb{R}^{m}$ 是样品中观测到的浓度向量，$f \\in \\mathbb{R}^{n}$ 是未知贡献系数的向量。保守示踪剂的守恒原理规定，混合物的组分是端元组分的线性组合，表示为乘积 $A f$。反向建模的目标是找到最能解释观测样品 $b$ 的向量 $f$。\n\n“最佳”拟合由最小二乘法原理定义，该原理旨在最小化预测浓度 $A f$ 与观测浓度 $b$ 之间的平方差之和。这等同于最小化残差向量 $r = A f - b$ 的欧几里得范数的平方。因此，要最小化的目标函数是 $J(f) = \\lVert A f - b \\rVert_{2}^{2} = \\sum_{i=1}^{m} ( (A f)_i - b_i )^2$。\n\n**1. 普通最小二乘法 (OLS) 解**\n\nOLS 方法解决的是对系数 $f$ 没有任何约束的最小化问题。\n$$\n\\min_{f \\in \\mathbb{R}^{n}} \\lVert A f - b \\rVert_{2}^{2}\n$$\n为找到最小值，我们计算目标函数相对于 $f$ 的梯度并将其设为零。目标函数可以写成 $J(f) = (A f - b)^T (A f - b) = f^T A^T A f - 2 f^T A^T b + b^T b$。梯度是：\n$$\n\\nabla_f J(f) = 2 A^T A f - 2 A^T b\n$$\n将梯度设为零，即 $\\nabla_f J(f) = \\vec{0}$，得到正规方程：\n$$\nA^T A f = A^T b\n$$\n如果矩阵 $A^T A$ 是可逆的（如果 $A$ 的列，即各端元，是线性无关的，则该条件成立），那么 $f$ 存在唯一解：\n$$\nf_{\\mathrm{OLS}} = (A^T A)^{-1} A^T b\n$$\n矩阵 $(A^T A)^{-1} A^T$ 被称为 $A$ 的 Moore-Penrose 伪逆。该解给出了最小可能的残差范数，但如下所示，$f_{\\mathrm{OLS}}$ 的分量可以是负数，这与 $f$ 作为源贡献的物理意义相矛盾。\n\n**2. 非负最小二乘法 (NNLS) 解**\n\n为强制实现物理真实性，我们必须添加非负性约束 $f \\ge 0$，即每个分量 $f_j \\ge 0$。这将问题转化为一个约束优化问题：\n$$\n\\min_{f \\in \\mathbb{R}_{\\ge 0}^{n}} \\lVert A f - b \\rVert_{2}^{2} \\quad \\text{约束条件为} \\quad f_j \\ge 0 \\text{ for } j=1, \\dots, n\n$$\n这就是 NNLS 问题。与 OLS 不同，它通常没有简单的闭式解。它需要迭代数值算法来求解，例如活动集方法（如 Lawson-Hanson 算法）。这些算法迭代地确定 $f$ 的哪些分量应为零（约束的“活动集”），并对其余分量求解一个较小的无约束最小二乘问题。解必须满足 Karush-Kuhn-Tucker (KKT) 最优性条件。NNLS 解 $f_{\\mathrm{NNLS}}$ 通过设计保证了物理上有意义的结果。一个关键的权衡是，NNLS 的残差范数必须大于或等于 OLS 的残差范数，即 $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2} \\ge \\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2}$，因为解空间受到的约束更强。\n\n**3. 数值实现策略**\n\n数值解将用 Python 实现。\n- 对于 OLS 问题，我们将使用 `numpy.linalg.lstsq`，这是一个鲁棒的线性最小二乘问题求解器，可计算 $f_{\\mathrm{OLS}}$。\n- 对于 NNLS 问题，我们将使用 `scipy.optimize.nnls`，它实现了 Lawson-Hanson 活动集算法。\n- 残差范数 $\\lVert A f - b \\rVert_{2}$ 将使用 `numpy.linalg.norm` 计算。\n- 对 $f_{\\mathrm{OLS}}$ 中负系数的检查将实现为逐分量比较 $f_j  -10^{-10}$。\n\n**4. 测试用例分析**\n\n所有测试用例都使用 $m=2$ 个物种，$n=2$ 个端元，以及端元组分矩阵：\n$$\nA = \\begin{bmatrix}\n6  1 \\\\\n1  6\n\\end{bmatrix}\n$$\n\n**测试用例 1：反例**\n观测样品为 $b = \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix}$。\n- **OLS 解**：由于 $A$ 是一个方形可逆矩阵，精确解 $f = A^{-1} b$ 也是 OLS 解。\n$$\nf_{\\mathrm{OLS}} = A^{-1} b = \\frac{1}{35} \\begin{bmatrix} 6  -1 \\\\ -1  6 \\end{bmatrix} \\begin{bmatrix} 20 \\\\ 1 \\end{bmatrix} = \\frac{1}{35} \\begin{bmatrix} 119 \\\\ -14 \\end{bmatrix} = \\begin{bmatrix} 3.4 \\\\ -0.4 \\end{bmatrix}\n$$\n第二个系数 $f_2 = -0.4$ 是负数。这在物理上是无效的，因为它意味着“负贡献”或端元 2 的移除。残差范数为 $\\lVert A f_{\\mathrm{OLS}} - b \\rVert_{2} = 0$，因为拟合在数学上是完美的。负值指示符为 $1$。\n- **NNLS 解**：算法必须找到最佳的非负解。OLS 解是不可行的。NNLS 解必须位于可行域（$f_1 \\ge 0, f_2 \\ge 0$）的边界上。通过观察，设 $f_2=0$ 并求解 $f_1$ 以最佳拟合 $b$，问题就变成了将 $b$ 投影到向量 $a_1 = [6, 1]^T$ 上。这得到 $f_1 = (a_1^T a_1)^{-1} a_1^T b = (37)^{-1} (121) \\approx 3.270270$。因此，$f_{\\mathrm{NNLS}} = [3.270270, 0]^T$。该解的非零残差范数约为 $\\lVert A f_{\\mathrm{NNLS}} - b \\rVert_{2} \\approx 2.301586$。这代表了在非负性约束下可能达到的最小误差。\n\n**测试用例 2：内点**\n观测样品为 $b = \\begin{bmatrix} 3.5 \\\\ 3.5 \\end{bmatrix}$。该样品被构造成一个精确的正混合物：$b = 0.5 a_1 + 0.5 a_2$。\n- **OLS 解**：精确解为 $f_{\\mathrm{OLS}} = [0.5, 0.5]^T$。两个分量都是正数。残差范数为 $0$。负值指示符为 $0$。\n- **NNLS 解**：由于 OLS 解已经位于可行域内（$f_{\\mathrm{OLS}} \\ge 0$），它也是 NNLS 问题的最优解。因此，$f_{\\mathrm{NNLS}} = [0.5, 0.5]^T$，残差范数为 $0$。\n\n**测试用例 3：边界点**\n观测样品为 $b = \\begin{bmatrix} 2 \\\\ 12 \\end{bmatrix}$。该样品被构造成一个位于非负锥边界上的精确混合物：$b = 0 a_1 + 2 a_2$。\n- **OLS 解**：精确解为 $f_{\\mathrm{OLS}} = [0, 2]^T$。分量均为非负。残差范数为 $0$。负值指示符为 $0$。\n- **NNLS 解**：与情况 2 类似，OLS 解对于 NNLS 问题已经是可行的（$f_{\\mathrm{OLS}} \\ge 0$）。因此，它也是 NNLS 解。$f_{\\mathrm{NNLS}} = [0, 2]^T$，残差范数为 $0$。\n\n这些测试用例有效地证明了 OLS 可能会因产生非物理结果（情况 1）而失败，而 NNLS 总能提供物理上有效的解。当无约束的 OLS 解恰好为非负时（情况 2 和 3），NNLS 解与其相同。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import nnls\n\ndef solve():\n    \"\"\"\n    Solves OLS and NNLS problems for three geochemical mass-balance test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (np.array([[6, 1], [1, 6]]), np.array([20, 1])),\n        (np.array([[6, 1], [1, 6]]), np.array([3.5, 3.5])),\n        (np.array([[6, 1], [1, 6]]), np.array([2, 12]))\n    ]\n\n    all_results = []\n    \n    # Define the numerical tolerance for negativity check\n    negativity_tolerance = -1e-10\n\n    for A, b in test_cases:\n        # Solve the Ordinary Least Squares (OLS) problem\n        # A is a full-rank square matrix, so rcond=None ensures behavior of a standard solve.\n        f_ols, _, _, _ = np.linalg.lstsq(A, b, rcond=None)\n        \n        # Calculate the OLS residual norm\n        norm_ols = np.linalg.norm(A @ f_ols - b)\n\n        # Check if any component of f_ols is negative\n        is_negative_ols = 1 if np.any(f_ols  negativity_tolerance) else 0\n\n        # Solve the Nonnegative Least Squares (NNLS) problem\n        f_nnls, norm_nnls = nnls(A, b)\n\n        # Assemble the results for the current case\n        # The result must be a single list containing all values in order.\n        case_result_list = []\n        case_result_list.extend(f_ols.tolist())\n        case_result_list.extend(f_nnls.tolist())\n        case_result_list.append(norm_ols)\n        case_result_list.append(norm_nnls)\n        case_result_list.append(is_negative_ols)\n        \n        all_results.append(case_result_list)\n\n    # Format the final output string as a list of lists with 6 decimal places for floats.\n    case_strings = []\n    for result_list in all_results:\n        formatted_values = []\n        for value in result_list:\n            if isinstance(value, (float, np.floating)):\n                # Round to 6 decimal places and format\n                formatted_values.append(f\"{value:.6f}\")\n            else:\n                # The integer flag\n                formatted_values.append(str(value))\n        \n        case_strings.append(f\"[{','.join(formatted_values)}]\")\n    \n    final_output_string = f\"[{','.join(case_strings)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "真实世界的地球化学过程不仅是不可逆的，其反应程度还常常受到反应动力学和反应物供应的限制。这个高级实践将挑战您将这些复杂的物理约束整合到逆模型中。您将学习如何根据速率定律和化学计量关系为特定反应（如黄铁矿氧化）设置上限，并应用边界约束最小二乘法来求解反应程度，从而构建一个更加精确和贴近现实的地球化学模型 。",
            "id": "4082512",
            "problem": "您的任务是设计并实现一个反向地球化学质量平衡模型，用于估算一个水生系统中三个耦合过程的程度：黄铁矿氧化、方解石溶解和二氧化碳脱气。场景是一个充分混合的水相反应器，其中测量了所选溶解物质的输入（初始）和输出（最终）浓度。该反向模型必须受到一个物理上限的约束，该上限源于受表面积限制的速率定律和氧化剂化学计量。\n\n基本原理：\n- 控制体积内反应输运系统的质量守恒表明，在初始和最终状态之间测得的溶解物质浓度的变化，等于所有反应程度的化学计量贡献之和。设测得的浓度变化向量为 $\\Delta \\mathbf{C} \\in \\mathbb{R}^m$，反应程度向量为 $\\mathbf{x} \\in \\mathbb{R}^n$，化学计量矩阵为 $\\mathbf{S} \\in \\mathbb{R}^{m \\times n}$。那么，对于一个精确的质量平衡拟合，有 $\\Delta \\mathbf{C} = \\mathbf{S}\\,\\mathbf{x}$。\n- 在氧化剂充足的条件下，一个物理上合理的表面控制氧化速率定律是，速率为零级，与氧化剂活度无关，但与可用的反应性表面积成正比。对于黄铁矿氧化，单位体积的速率为 $r_{\\mathrm{pyr}} = k\\,A$，其中 $k$ 是内在速率常数，单位为 $\\mathrm{mmol}\\,\\mathrm{m}^{-2}\\,\\mathrm{hr}^{-1}$，$A$ 是单位体积内可用的黄铁矿表面积，单位为 $\\mathrm{m}^2\\,\\mathrm{L}^{-1}$。在停留时间 $t$（单位为 $\\mathrm{hr}$）内，每升的最大综合反应程度为 $x_{\\mathrm{pyr}}^{\\max} = k\\,A\\,t$。\n- 独立于动力学上限，氧化剂的供应通过化学计量施加了物质限制。对于黄铁矿氧化，反应每消耗一摩尔黄铁矿，会消耗 $3.75$ 摩尔的溶解氧，因此如果没有其他氧源，则 $x_{\\mathrm{pyr}} \\leq C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75$。\n\n过程定义和化学计量：\n- 黄铁矿氧化（理想化总反应）：$\\mathrm{FeS}_2 + \\tfrac{15}{4}\\,\\mathrm{O}_2 + \\tfrac{7}{2}\\,\\mathrm{H}_2\\mathrm{O} \\rightarrow \\mathrm{Fe(OH)}_3 + 2\\,\\mathrm{SO}_4^{2-} + 4\\,\\mathrm{H}^+$。每摩尔黄铁矿氧化测得的化学计量效应：$\\Delta \\mathrm{SO}_4^{2-} = +2$, $\\Delta \\mathrm{O}_2 = -3.75$, $\\Delta \\mathrm{Alkalinity} = -4$。\n- 方解石溶解（酸中和路径）：$\\mathrm{CaCO}_3 + \\mathrm{H}^+ \\rightarrow \\mathrm{Ca}^{2+} + \\mathrm{HCO}_3^-$。每摩尔方解石溶解测得的化学计量效应：$\\Delta \\mathrm{Ca}^{2+} = +1$, $\\Delta \\mathrm{DIC} = +1$, $\\Delta \\mathrm{Alkalinity} = +1$。\n- 二氧化碳脱气：$\\mathrm{HCO}_3^- \\rightleftharpoons \\mathrm{CO}_2(\\mathrm{g}) + \\mathrm{OH}^-$。在封闭系统碱度的意义上，脱气减少了溶解无机碳而不改变碱度。每摩尔二氧化碳脱气测得的化学计量效应：$\\Delta \\mathrm{DIC} = -1$, $\\Delta \\mathrm{Alkalinity} = 0$。\n\n设测得的物质向量为 $\\left[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}\\right]$，按此顺序排列，所有单位均为毫摩尔/升。设反应程度向量为 $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$，所有单位均为毫摩尔/升。那么化学计量矩阵为\n$$\n\\mathbf{S} =\n\\begin{bmatrix}\n2  0  0 \\\\\n0  1  0 \\\\\n0  1  -1 \\\\\n-3.75  0  0 \\\\\n-4  1  0\n\\end{bmatrix}.\n$$\n\n反向建模任务：\n- 给定每种物质的初始和最终浓度，计算 $\\Delta \\mathbf{C} = \\mathbf{C}_{\\mathrm{final}} - \\mathbf{C}_{\\mathrm{initial}}$。\n- 通过求解一个带边界约束的线性最小二乘问题来估计非负反应程度 $\\mathbf{x}$\n$$\n\\min_{\\mathbf{x}} \\left\\|\\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}\\right\\|_2 \\quad \\text{subject to} \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u},\n$$\n其中下界为 $\\mathbf{l} = [0,0,0]$，上界为 $\\mathbf{u} = [x_{\\mathrm{pyr}}^{\\max}, +\\infty, +\\infty]$，其中 $x_{\\mathrm{pyr}}^{\\max} = \\min\\left(k\\,A\\,t, C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75\\right)$。\n\n单位与报告：\n- 所有浓度和反应程度必须以毫摩尔/升为单位进行处理和报告。时间单位为小时，单位体积表面积为平方米/升，速率常数为毫摩尔/平方米/小时。以十进制浮点数形式报告反应程度，单位为毫摩尔/升。\n- 本问题不使用角度。\n- 本问题不使用百分比。\n\n测试套件：\n对于每个案例，初始和最终测量的浓度以 $\\left[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}\\right]$ 的形式提供，单位为毫摩尔/升。速率参数以 $k$（单位 $\\mathrm{mmol}\\,\\mathrm{m}^{-2}\\,\\mathrm{hr}^{-1}$），$A$（单位 $\\mathrm{m}^2\\,\\mathrm{L}^{-1}$）和 $t$（单位小时）的形式提供。\n\n- 案例 $1$（理想情况，有活性氧化剂供应约束）：\n    - 初始：$[0.20, 1.00, 2.00, 0.25, 2.50]$\n    - 最终：$[0.52, 1.25, 2.05, 0.10, 2.20]$\n    - 参数：$k = 0.10$, $A = 0.80$, $t = 1.00$\n- 案例 $2$（理想情况，动力学上限比氧化剂供应更具限制性）：\n    - 初始：$[0.10, 0.80, 1.80, 1.00, 2.20]$\n    - 最终：$[0.40, 1.10, 2.00, 0.30, 2.10]$\n    - 参数：$k = 0.12$, $A = 3.00$, $t = 2.00$\n- 案例 $3$（边缘情况，硫酸盐变化可忽略，氧气消耗量小）：\n    - 初始：$[0.30, 1.20, 2.20, 0.10, 2.80]$\n    - 最终：$[0.30, 1.35, 2.05, 0.08, 2.95]$\n    - 参数：$k = 0.05$, $A = 0.50$, $t = 1.00$\n\n您的程序应为每个案例计算 $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$ 的带边界约束的最小二乘估计值，并生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果，每个案例的结果本身是一个包含三个十进制浮点数的列表，顺序为 $\\left[x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}\\right]$（例如，$[[0.1,0.2,0.3],[...],[...]]$）。不应打印其他任何文本。",
            "solution": "用户提供的问题被评估为**有效**。它在科学上基于地球化学质量平衡的原理，在数学上被恰当地表述为一个带边界约束的线性最小二乘问题，并且提供了充分、一致和客观的信息以获得唯一解。\n\n任务是确定一组三个地球化学反应——黄铁矿氧化、方解石溶解和二氧化碳脱气——的反应程度，这些反应程度能够最好地解释在初始和最终状态之间观察到的水化学变化。反应程度由向量 $\\mathbf{x} = [x_{\\mathrm{pyr}}, x_{\\mathrm{cal}}, x_{\\mathrm{deg}}]^T$ 表示，单位为 $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$，是我们试图估计的未知变量。\n\n模型的核心是线性质量平衡方程：\n$$\n\\mathbf{S}\\,\\mathbf{x} \\approx \\Delta \\mathbf{C}\n$$\n在这里，$\\Delta \\mathbf{C} = \\mathbf{C}_{\\mathrm{final}} - \\mathbf{C}_{\\mathrm{initial}}$ 是测得的 $m=5$ 种化学物质：$[\\mathrm{SO}_4^{2-}, \\mathrm{Ca}^{2+}, \\mathrm{DIC}, \\mathrm{O}_2, \\mathrm{Alkalinity}]$ 浓度变化的向量。矩阵 $\\mathbf{S}$ 是 $m \\times n$（$5 \\times 3$）的化学计量矩阵，它量化了每单位反应程度下每种物质的变化。如所提供，它是：\n$$\n\\mathbf{S} =\n\\begin{bmatrix}\n2  0  0 \\\\\n0  1  0 \\\\\n0  1  -1 \\\\\n-3.75  0  0 \\\\\n-4  1  0\n\\end{bmatrix}\n$$\n由于系统是超定的（$mn$）并且测量包含固有的不确定性，因此不太可能存在一个精确解使得 $\\mathbf{S}\\,\\mathbf{x} = \\Delta \\mathbf{C}$。因此，问题被表述为找到向量 $\\mathbf{x}$，以最小化残差向量 $\\mathbf{r} = \\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}$ 的平方欧几里得范数。这是一个线性最小二乘问题。\n\n此外，解必须具有物理意义。反应程度不能为负。另外，黄铁矿氧化的程度 $x_{\\mathrm{pyr}}$ 受反应动力学和氧化剂溶解氧（$\\mathrm{O}_2$）的可用性双重限制。这些限制被作为对向量 $\\mathbf{x}$ 的边界条件引入。完整的优化问题是：\n$$\n\\min_{\\mathbf{x}} \\left\\|\\mathbf{S}\\,\\mathbf{x} - \\Delta \\mathbf{C}\\right\\|_2^2 \\quad \\text{subject to} \\quad \\mathbf{l} \\le \\mathbf{x} \\le \\mathbf{u}\n$$\n下界 $\\mathbf{l}$ 对所有反应强制施加非负性：\n$$\n\\mathbf{l} = [0, 0, 0]^T\n$$\n上界 $\\mathbf{u}$ 仅约束黄铁矿氧化，而方解石溶解和脱气没有上界约束。$x_{\\mathrm{pyr}}$ 的上界是两个物理限制中的较小者：\n1. 动力学限制，基于表面控制速率定律：$x_{\\mathrm{pyr,kin}} = k\\,A\\,t$，其中 $k$ 是速率常数，$A$ 是反应表面积，$t$ 是停留时间。\n2. 氧化剂供应限制，基于化学计量：$x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75$，其中 $C_{\\mathrm{O}_2,\\mathrm{initial}}$ 是溶解氧的初始浓度。\n因此，$x_{\\mathrm{pyr}}^{\\max} = \\min(x_{\\mathrm{pyr,kin}}, x_{\\mathrm{pyr,ox}})$。上界向量为：\n$$\n\\mathbf{u} = [x_{\\mathrm{pyr}}^{\\max}, \\infty, \\infty]^T\n$$\n这个带边界约束的线性最小二乘问题可以使用数值优化算法可靠地求解，例如在 `scipy.optimize.lsq_linear` 函数中实现的信赖域反射方法。\n\n求解过程是对每个测试案例进行处理：\n\n**案例 $1$**：\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.20, 1.00, 2.00, 0.25, 2.50]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.52, 1.25, 2.05, 0.10, 2.20]^T$\n- $\\Delta \\mathbf{C} = [0.32, 0.25, 0.05, -0.15, -0.30]^T$\n- 参数：$k=0.10$, $A=0.80$, $t=1.00$。\n- $x_{\\mathrm{pyr,kin}} = 0.10 \\times 0.80 \\times 1.00 = 0.08$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 0.25 / 3.75 \\approx 0.0667$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- 氧化剂供应是更具限制性的约束。$x_{\\mathrm{pyr}}^{\\max} = 0.0667$。\n- 边界为 $\\mathbf{l} = [0, 0, 0]^T$ 和 $\\mathbf{u} = [0.0667, \\infty, \\infty]^T$。求解得到反应程度 $\\mathbf{x}_1$。\n\n**案例 $2$**：\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.10, 0.80, 1.80, 1.00, 2.20]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.40, 1.10, 2.00, 0.30, 2.10]^T$\n- $\\Delta \\mathbf{C} = [0.30, 0.30, 0.20, -0.70, -0.10]^T$\n- 参数：$k=0.12$, $A=3.00$, $t=2.00$。\n- $x_{\\mathrm{pyr,kin}} = 0.12 \\times 3.00 \\times 2.00 = 0.72$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 1.00 / 3.75 \\approx 0.2667$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- 氧化剂供应再次成为更具限制性的约束。$x_{\\mathrm{pyr}}^{\\max} = 0.2667$。应注意，此案例的问题描述“动力学上限比氧化剂供应更具限制性”与所提供的数据不一致。计算将使用正确推导出的边界进行。\n- 边界为 $\\mathbf{l} = [0, 0, 0]^T$ 和 $\\mathbf{u} = [0.2667, \\infty, \\infty]^T$。求解得到反应程度 $\\mathbf{x}_2$。\n\n**案例 $3$**：\n- $\\mathbf{C}_{\\mathrm{initial}} = [0.30, 1.20, 2.20, 0.10, 2.80]^T$\n- $\\mathbf{C}_{\\mathrm{final}} = [0.30, 1.35, 2.05, 0.08, 2.95]^T$\n- $\\Delta \\mathbf{C} = [0.00, 0.15, -0.15, -0.02, 0.15]^T$\n- 参数：$k=0.05$, $A=0.50$, $t=1.00$。\n- $x_{\\mathrm{pyr,kin}} = 0.05 \\times 0.50 \\times 1.00 = 0.025$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- $x_{\\mathrm{pyr,ox}} = C_{\\mathrm{O}_2,\\mathrm{initial}}/3.75 = 0.10 / 3.75 \\approx 0.0267$ $\\mathrm{mmol}\\,\\mathrm{L}^{-1}$。\n- 在此案例中，动力学速率是更具限制性的约束。$x_{\\mathrm{pyr}}^{\\max} = 0.025$。\n- 边界为 $\\mathbf{l} = [0, 0, 0]^T$ 和 $\\mathbf{u} = [0.025, \\infty, \\infty]^T$。求解得到反应程度 $\\mathbf{x}_3$。\n\n该实现将系统地将此过程应用于每个测试案例，以生成最终的反应程度向量列表。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import lsq_linear\n\ndef solve():\n    \"\"\"\n    Solves for the reaction extents of a geochemical system using a\n    bound-constrained linear least squares inverse model.\n    \"\"\"\n    # Define the stoichiometric matrix S.\n    # Rows correspond to species: SO4, Ca, DIC, O2, Alkalinity.\n    # Columns correspond to reactions: Pyrite oxidation, Calcite dissolution, CO2 degassing.\n    S = np.array([\n        [2.0, 0.0, 0.0],\n        [0.0, 1.0, 0.0],\n        [0.0, 1.0, -1.0],\n        [-3.75, 0.0, 0.0],\n        [-4.0, 1.0, 0.0]\n    ])\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"initial\": np.array([0.20, 1.00, 2.00, 0.25, 2.50]),\n            \"final\": np.array([0.52, 1.25, 2.05, 0.10, 2.20]),\n            \"params\": {\"k\": 0.10, \"A\": 0.80, \"t\": 1.00}\n        },\n        {\n            \"initial\": np.array([0.10, 0.80, 1.80, 1.00, 2.20]),\n            \"final\": np.array([0.40, 1.10, 2.00, 0.30, 2.10]),\n            \"params\": {\"k\": 0.12, \"A\": 3.00, \"t\": 2.00}\n        },\n        {\n            \"initial\": np.array([0.30, 1.20, 2.20, 0.10, 2.80]),\n            \"final\": np.array([0.30, 1.35, 2.05, 0.08, 2.95]),\n            \"params\": {\"k\": 0.05, \"A\": 0.50, \"t\": 1.00}\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack data for the current case.\n        C_initial = case[\"initial\"]\n        C_final = case[\"final\"]\n        params = case[\"params\"]\n        k, A, t = params[\"k\"], params[\"A\"], params[\"t\"]\n\n        # Step 1: Compute the vector of concentration changes, delta_C.\n        delta_C = C_final - C_initial\n\n        # Step 2: Calculate the upper bound for pyrite oxidation extent, x_pyr_max.\n        # This is the minimum of the kinetic limit and the oxidant supply limit.\n        x_pyr_kin_limit = k * A * t\n        \n        # O2 is the 4th species in the concentration vector (index 3).\n        C_O2_initial = C_initial[3]\n        x_pyr_ox_limit = C_O2_initial / 3.75\n        \n        x_pyr_max = min(x_pyr_kin_limit, x_pyr_ox_limit)\n\n        # Step 3: Define the lower and upper bounds for the reaction extents vector x.\n        # Lower bounds are all zero (reactions cannot proceed in reverse).\n        lower_bounds = [0.0, 0.0, 0.0]\n        # Upper bounds are infinite for calcite and degassing, and x_pyr_max for pyrite.\n        upper_bounds = [x_pyr_max, np.inf, np.inf]\n        \n        bounds = (lower_bounds, upper_bounds)\n\n        # Step 4: Solve the bound-constrained linear least squares problem.\n        # min ||S*x - delta_C||_2 subject to l = x = u\n        result = lsq_linear(S, delta_C, bounds=bounds)\n        \n        # The solution vector x contains the estimated reaction extents.\n        solution_extents = result.x.tolist()\n        results.append(solution_extents)\n\n    # Final print statement in the exact required format.\n    # e.g., [[x1,y1,z1],[x2,y2,z2]]\n    # Use of join and map requires converting the inner list to a string representation.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}