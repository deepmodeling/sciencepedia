{
    "hands_on_practices": [
        {
            "introduction": "The first step in building any robust geochemical model is translating fundamental chemical principles—mass action, mass balance, and electroneutrality—into a solvable mathematical form. This practice guides you through this critical derivation for the seawater carbonate system, a cornerstone of chemical oceanography. By constructing a single residual function for hydrogen ion activity from measured parameters, you will develop the foundational skill of formulating a well-posed problem suitable for numerical solution, as demonstrated in this hypothetical scenario .",
            "id": "4086594",
            "problem": "A closed, isothermal seawater sample at fixed temperature and salinity is analyzed for dissolved inorganic carbon (DIC) and total alkalinity. Let the measured dissolved inorganic carbon (DIC) be $C_{\\mathrm{T}}$ and the measured total alkalinity be $A_{\\mathrm{T}}$. The acidity scale is defined by the hydrogen ion activity, with $\\mathrm{pH}$ on the free hydrogen scale defined as $\\mathrm{pH} = -\\log_{10}(a_{\\mathrm{H^+}})$, where $a_{\\mathrm{H^+}}$ is the activity of the hydrogen ion $\\mathrm{H^+}$. Activities $a_i$ and molar concentrations $[i]$ are related by $a_i = \\gamma_i [i]$, where $\\gamma_i$ is the species-specific activity coefficient at the given ionic strength set by the salinity. The system is assumed to be equilibrated with respect to the carbonate and borate acid–base reactions, and water auto-protolysis, under the following constraints and definitions:\n\n- Carbonate equilibria are governed by activity-based acid dissociation constants $K_1$ and $K_2$ defined by $K_1 = \\dfrac{a_{\\mathrm{HCO_3^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{CO_2^*}}}$ and $K_2 = \\dfrac{a_{\\mathrm{CO_3^{2-}}} a_{\\mathrm{H^+}}}{a_{\\mathrm{HCO_3^-}}}$, where $\\mathrm{CO_2^*}$ denotes the sum $\\mathrm{CO_2(aq)} + \\mathrm{H_2CO_3}$.\n- Borate equilibrium is governed by the activity-based acid dissociation constant $K_{\\mathrm{B}} = \\dfrac{a_{\\mathrm{B(OH)_4^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{B(OH)_3}}}$ with total boron $B_{\\mathrm{T}}$ determined by the salinity via a known empirical relation (treated here as a given parameter).\n- Water auto-protolysis is described by the thermodynamic constant $K_{\\mathrm{w}} = a_{\\mathrm{H^+}} a_{\\mathrm{OH^-}}$.\n\nAssume that phosphate, silicate, organic acids/bases, and minor acid–base systems are negligible, and that the strong-ion background is fixed by the salinity such that the definition of total alkalinity $A_{\\mathrm{T}}$ reduces to the standard carbonate–borate–water form. Under this assumption, the total alkalinity is expressible as the net base excess relative to the reference acid, specifically\n$$\nA_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}] + [\\mathrm{B(OH)_4^-}] + [\\mathrm{OH^-}] - [\\mathrm{H^+}] \\, .\n$$\n\nThe mass-balance definitions are\n$$\nC_{\\mathrm{T}} = [\\mathrm{CO_2^*}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}]\n\\quad\\text{and}\\quad\nB_{\\mathrm{T}} = [\\mathrm{B(OH)_3}] + [\\mathrm{B(OH)_4^-}] \\, .\n$$\n\nStarting strictly from the above activity-based equilibrium definitions and mass balances together with electroneutrality formalized through $A_{\\mathrm{T}}$, derive a single scalar residual function of the hydrogen ion activity, $R(a_{\\mathrm{H^+}})$, that is zero at equilibrium when $a_{\\mathrm{H^+}}$ is consistent with the measured $C_{\\mathrm{T}}$ and $A_{\\mathrm{T}}$ at the given temperature and salinity. Your derivation must:\n\n- Use only the activity-based constants $K_1$, $K_2$, $K_{\\mathrm{B}}$, and $K_{\\mathrm{w}}$ and activity coefficients $\\gamma_i$.\n- Eliminate all unknown intermediate activities and concentrations of $\\mathrm{CO_2^*}$, $\\mathrm{HCO_3^-}$, $\\mathrm{CO_3^{2-}}$, $\\mathrm{B(OH)_3}$, $\\mathrm{B(OH)_4^-}$, and $\\mathrm{OH^-}$ in favor of $a_{\\mathrm{H^+}}$, $C_{\\mathrm{T}}$, $B_{\\mathrm{T}}$, and the constants.\n- Produce a closed-form analytic expression $R(a_{\\mathrm{H^+}})$ that depends only on $a_{\\mathrm{H^+}}$, $C_{\\mathrm{T}}$, $A_{\\mathrm{T}}$, $B_{\\mathrm{T}}$, $K_1$, $K_2$, $K_{\\mathrm{B}}$, $K_{\\mathrm{w}}$, and the relevant $\\gamma_i$ and is suitable for numerical root-finding.\n\nExpress the final residual $R(a_{\\mathrm{H^+}})$ explicitly as a function of $a_{\\mathrm{H^+}}$, without introducing any additional variables beyond those specified. The final answer must be a single closed-form analytic expression, not an equation. No numerical evaluation is required and no rounding applies.",
            "solution": "The problem requires the derivation of a single scalar residual function, $R(a_{\\mathrm{H^+}})$, which equals zero when the hydrogen ion activity, $a_{\\mathrm{H^+}}$, is consistent with the measured dissolved inorganic carbon, $C_{\\mathrm{T}}$, and total alkalinity, $A_{\\mathrm{T}}$. The function must be expressed in terms of the given parameters: $a_{\\mathrm{H^+}}$, $C_{\\mathrm{T}}$, $A_{\\mathrm{T}}$, $B_{\\mathrm{T}}$, the activity-based equilibrium constants $K_1$, $K_2$, $K_{\\mathrm{B}}$, $K_{\\mathrm{w}}$, and the relevant activity coefficients $\\gamma_i$.\n\nA suitable residual function can be defined as the difference between the alkalinity calculated from the system's state (defined by $a_{\\mathrm{H^+}}$, $C_{\\mathrm{T}}$, and $B_{\\mathrm{T}}$) and the measured alkalinity, $A_{\\mathrm{T}}$. Let us denote the calculated alkalinity as $A_{\\mathrm{T,calc}}$. The residual function is then:\n$$\nR(a_{\\mathrm{H^+}}) = A_{\\mathrm{T,calc}}(a_{\\mathrm{H^+}}, C_{\\mathrm{T}}, B_{\\mathrm{T}}) - A_{\\mathrm{T}}\n$$\nThe problem specifies the definition of total alkalinity in terms of molar concentrations:\n$$\nA_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}] + [\\mathrm{B(OH)_4^-}] + [\\mathrm{OH^-}] - [\\mathrm{H^+}]\n$$\nOur task is to express each concentration on the right-hand side as a function of $a_{\\mathrm{H^+}}$, the total concentrations $C_{\\mathrm{T}}$ and $B_{\\mathrm{T}}$, and the fundamental constants.\n\nTo facilitate the derivation, it is convenient to first define stoichiometric equilibrium constants, which are \"mixed\" constants relating activities of some species (here, $\\mathrm{H^+}$) to concentrations of others. These are standard in chemical oceanography and will be substituted out at the end to satisfy the problem constraints.\n\nThe activity-based constant $K_1$ is $K_1 = \\frac{a_{\\mathrm{HCO_3^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{CO_2^*}}}$. Using the relation $a_i = \\gamma_i [i]$, we have $K_1 = \\frac{\\gamma_{\\mathrm{HCO_3^-}}[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{CO_2^*}}[\\mathrm{CO_2^*}]}$. We define the stoichiometric constant $K'_1$ as:\n$$\nK'_1 = \\frac{[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{[\\mathrm{CO_2^*}]} = K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\n$$\nSimilarly, for the second carbonate equilibrium and the borate equilibrium:\n$$\nK'_2 = \\frac{[\\mathrm{CO_3^{2-}}] a_{\\mathrm{H^+}}}{[\\mathrm{HCO_3^-}]} = K_2 \\frac{\\gamma_{\\mathrm{HCO_3^-}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\n$$\n$$\nK'_{\\mathrm{B}} = \\frac{[\\mathrm{B(OH)_4^-}] a_{\\mathrm{H^+}}}{[\\mathrm{B(OH)_3}]} = K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}\n$$\n\nNow, we derive the contributions to $A_{\\mathrm{T,calc}}$ term by term.\n\n**1. Carbonate System Contribution ($A_{\\mathrm{C}}$)**\n\nThe total dissolved inorganic carbon is $C_{\\mathrm{T}} = [\\mathrm{CO_2^*}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}]$.\nUsing the definitions of $K'_1$ and $K'_2$, we express $[\\mathrm{CO_2^*}]$ and $[\\mathrm{CO_3^{2-}}]$ in terms of $[\\mathrm{HCO_3^-}]$ and $a_{\\mathrm{H^+}}$:\n$$\n[\\mathrm{CO_2^*}] = \\frac{[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{K'_1}, \\quad [\\mathrm{CO_3^{2-}}] = \\frac{K'_2 [\\mathrm{HCO_3^-}]}{a_{\\mathrm{H^+}}}\n$$\nSubstituting into the $C_{\\mathrm{T}}$ equation:\n$$\nC_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] \\left( \\frac{a_{\\mathrm{H^+}}}{K'_1} + 1 + \\frac{K'_2}{a_{\\mathrm{H^+}}} \\right) = [\\mathrm{HCO_3^-}] \\frac{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}{K'_1 a_{\\mathrm{H^+}}}\n$$\nSolving for the concentrations of bicarbonate and carbonate:\n$$\n[\\mathrm{HCO_3^-}] = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}}}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\n$$\n[\\mathrm{CO_3^{2-}}] = \\frac{K'_2}{a_{\\mathrm{H^+}}} [\\mathrm{HCO_3^-}] = C_{\\mathrm{T}} \\frac{K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\nThe carbonate contribution to alkalinity is $A_{\\mathrm{C}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}]$:\n$$\nA_{\\mathrm{C}} = C_{\\mathrm{T}} \\left( \\frac{K'_1 a_{\\mathrm{H^+}}}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + \\frac{2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} \\right) = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\n\n**2. Borate System Contribution ($A_{\\mathrm{B}}$)**\n\nThe total boron is $B_{\\mathrm{T}} = [\\mathrm{B(OH)_3}] + [\\mathrm{B(OH)_4^-}]$.\nFrom the definition of $K'_{\\mathrm{B}}$, we have $[\\mathrm{B(OH)_3}] = \\frac{[\\mathrm{B(OH)_4^-}] a_{\\mathrm{H^+}}}{K'_{\\mathrm{B}}}$.\nSubstituting into the $B_{\\mathrm{T}}$ equation:\n$$\nB_{\\mathrm{T}} = [\\mathrm{B(OH)_4^-}] \\left( \\frac{a_{\\mathrm{H^+}}}{K'_{\\mathrm{B}}} + 1 \\right) = [\\mathrm{B(OH)_4^-}] \\frac{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}}{K'_{\\mathrm{B}}}\n$$\nThe borate contribution to alkalinity is $A_{\\mathrm{B}} = [\\mathrm{B(OH)_4^-}]$:\n$$\nA_{\\mathrm{B}} = B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}}\n$$\n\n**3. Water Auto-protolysis Contribution ($A_{\\mathrm{W}}$)**\n\nThe remaining terms are $[\\mathrm{OH^-}]$ and $[\\mathrm{H^+}]$.\nFrom $K_{\\mathrm{w}} = a_{\\mathrm{H^+}} a_{\\mathrm{OH^-}}$, we have $a_{\\mathrm{OH^-}} = K_{\\mathrm{w}} / a_{\\mathrm{H^+}}$. The concentration is $[\\mathrm{OH^-}] = a_{\\mathrm{OH^-}} / \\gamma_{\\mathrm{OH^-}} = \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}}$.\nThe hydrogen ion concentration is $[\\mathrm{H^+}] = a_{\\mathrm{H^+}} / \\gamma_{\\mathrm{H^+}}$.\nThe contribution from water and hydrogen ions is $A_{\\mathrm{W}} = [\\mathrm{OH^-}] - [\\mathrm{H^+}]$:\n$$\nA_{\\mathrm{W}} = \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}}\n$$\n\n**4. Assembling the Residual Function**\n\nCombining all contributions, the calculated total alkalinity is:\n$$\nA_{\\mathrm{T,calc}} = A_{\\mathrm{C}} + A_{\\mathrm{B}} + A_{\\mathrm{W}} = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}}\n$$\nThe residual function $R(a_{\\mathrm{H^+}}) = A_{\\mathrm{T,calc}} - A_{\\mathrm{T}}$ is therefore:\n$$\nR(a_{\\mathrm{H^+}}) = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}\n$$\n\n**5. Final Expression in terms of Fundamental Constants**\n\nFinally, we substitute the definitions of the stoichiometric constants ($K'_1, K'_2, K'_{\\mathrm{B}}$) back into the expression for $R(a_{\\mathrm{H^+}})$ to meet the explicit requirements of the problem statement.\n\nFor the carbonate term's numerator: $K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2 = \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)$.\nFor the carbonate term's denominator: $(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2 = (a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)$.\nFor the borate term: $K'_{\\mathrm{B}} = K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}$.\n\nSubstituting these yields the final, complete expression for the residual function $R(a_{\\mathrm{H^+}})$. This expression depends only on $a_{\\mathrm{H^+}}$ and the specified known parameters.\n$$\nR(a_{\\mathrm{H^+}}) = C_{\\mathrm{T}} \\frac{\\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)}{(a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)} + B_{\\mathrm{T}} \\frac{K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}}{a_{\\mathrm{H^+}} + K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}\n$$\nThis is the required closed-form analytic expression suitable for numerical root-finding to determine the equilibrium $a_{\\mathrm{H^+}}$ of the seawater sample.",
            "answer": "$$\\boxed{C_{\\mathrm{T}} \\frac{\\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)}{(a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)} + B_{\\mathrm{T}} \\frac{K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}}{a_{\\mathrm{H^+}} + K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}}$$"
        },
        {
            "introduction": "Once a model is formulated, its utility extends beyond simple prediction to analysis and hypothesis testing. This hands-on coding practice explores the concept of sensitivity analysis, a powerful tool for understanding which parameters most influence a model's output. By calculating the sensitivity of free metal activity to changes in complex formation constants, you will learn how to numerically solve the governing equilibrium equation and use the model to assess the validity of simplifying assumptions, such as neglecting minor species .",
            "id": "4086518",
            "problem": "Consider an aqueous system containing a single metal species $M$ and a set of monodentate ligands $\\{L_i\\}_{i=1}^N$ that form only $1{:}1$ complexes $ML_i$. Assume ideal behavior so that activities equal concentrations. Let $K_i$ denote the conditional formation constant of complex $ML_i$, $C_{\\mathrm{M}}^{\\mathrm{T}}$ the total analytical concentration of $M$, and $C_i^{\\mathrm{T}}$ the total analytical concentration of ligand $L_i$. The objective is to analyze the conditions under which simplifying assumptions, such as ignoring minor complexes, are valid by quantifying the local sensitivity of the free metal activity to small perturbations in individual stability constants $K_j$. Starting from fundamental laws, use the mass action law for $ML_i$ formation and the mass balance relations for both $M$ and each $L_i$, and derive the equations needed to compute the free metal activity $a_{\\mathrm{M}}$ and its local sensitivity with respect to $K_j$. You must implement an algorithm that solves for $a_{\\mathrm{M}}$ from the mass balance and mass action relations without relying on shortcut formulas, and then evaluates the local logarithmic sensitivity $S_j = \\dfrac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$ using appropriate differentiation grounded in these laws.\n\nYour program must:\n- Represent activities as dimensionless quantities and treat all $K_i$ as dimensionless conditional formation constants at fixed conditions.\n- Solve the scalar nonlinear equation implied by the mass balance of $M$ coupled with the mass action relationships for the complexes to obtain $a_{\\mathrm{M}}$.\n- Compute, for a specified index $j$, the local logarithmic sensitivity $S_j = \\dfrac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$ via implicit differentiation of the governing equation. The program should not assume any pre-derived sensitivity formula; it must derive and implement it from first principles within the program logic.\n- Express each final sensitivity result as a decimal number without units.\n\nTest suite specification:\nYou are given three test cases that exercise different geochemical process contexts (titration-like end state, evaporation, and mixing). For each case, use the specified parameters to compute the final totals to be used in the equilibrium calculation, and then compute the sensitivity $S_j$ for the given $j$.\n\n**Case 1** (titration-like end state):\n- Number of ligands $N$: $3$.\n- Metal total $C_{\\mathrm{M}}^{\\mathrm{T}}$: $10^{-6}$.\n- Ligand totals $(C_1^{\\mathrm{T}}, C_2^{\\mathrm{T}}, C_3^{\\mathrm{T}})$: $(5 \\times 10^{-6}, 10^{-6}, 10^{-8})$.\n- Formation constants $(K_1, K_2, K_3)$: $(10^{6}, 10^{4}, 10^{2})$.\n- Sensitivity index $j$: $3$.\n\n**Case 2** (evaporation):\n- Number of ligands $N$: $3$.\n- Initial metal total $C_{\\mathrm{M},0}^{\\mathrm{T}}$: $10^{-9}$.\n- Initial ligand totals $(C_{1,0}^{\\mathrm{T}}, C_{2,0}^{\\mathrm{T}}, C_{3,0}^{\\mathrm{T}})$: $(10^{-9}, 10^{-10}, 10^{-12})$.\n- Volume shrink ratio $\\phi$: $0.1$ (final volume equals $\\phi$ times the initial volume).\n- Compute final analytical totals by scaling all initial totals by $1/\\phi$.\n- Formation constants $(K_1, K_2, K_3)$: $(10^{7}, 10^{5}, 10^{1})$.\n- Sensitivity index $j$: $3$.\n\n**Case 3** (mixing):\n- Number of ligands $N$: $3$.\n- Solution $\\mathrm{A}$ totals $(C_{\\mathrm{M},\\mathrm{A}}^{\\mathrm{T}}, C_{1,\\mathrm{A}}^{\\mathrm{T}}, C_{2,\\mathrm{A}}^{\\mathrm{T}}, C_{3,\\mathrm{A}}^{\\mathrm{T}})$: $(10^{-5}, 10^{-6}, 0, 10^{-9})$.\n- Solution $\\mathrm{B}$ totals $(C_{\\mathrm{M},\\mathrm{B}}^{\\mathrm{T}}, C_{1,\\mathrm{B}}^{\\mathrm{T}}, C_{2,\\mathrm{B}}^{\\mathrm{T}}, C_{3,\\mathrm{B}}^{\\mathrm{T}})$: $(10^{-7}, 0, 10^{-6}, 10^{-8})$.\n- Mixing fraction $p$: $0.3$ (final mixture is $p$ of solution $\\mathrm{A}$ and $(1-p)$ of solution $\\mathrm{B}$).\n- Compute final analytical totals by $C_{\\mathrm{M}}^{\\mathrm{T}} = p\\,C_{\\mathrm{M},\\mathrm{A}}^{\\mathrm{T}} + (1-p)\\,C_{\\mathrm{M},\\mathrm{B}}^{\\mathrm{T}}$ and similarly for each ligand total $C_i^{\\mathrm{T}}$.\n- Formation constants $(K_1, K_2, K_3)$: $(10^{5}, 10^{8}, 10^{2})$.\n- Sensitivity index $j$: $3$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, namely $[S_1,S_2,S_3]$, where each $S_k$ is the computed decimal sensitivity for case $k$. Express each $S_k$ as a decimal number without units. No other text should be printed.",
            "solution": "The problem requires the derivation and implementation of a method to compute the free metal activity and its local logarithmic sensitivity with respect to a given formation constant in an aqueous system. The analysis will be based on the fundamental principles of chemical equilibrium, namely the Law of Mass Action and the principle of Mass Conservation.\n\nLet $a_{\\mathrm{M}}$ denote the activity (concentration) of the free metal $M$, and $a_i$ the activity of the free ligand $L_i$. The system contains $N$ such ligands. We assume ideal behavior, where activities are equal to concentrations.\n\nThe formation of a $1{:}1$ complex $ML_i$ is governed by the reaction $M + L_i \\rightleftharpoons ML_i$. The Law of Mass Action for this equilibrium is given by the conditional formation constant $K_i$:\n$$K_i = \\frac{[ML_i]}{[M] [L_i]} = \\frac{a_{ML_i}}{a_{\\mathrm{M}} a_i}$$\nwhere $a_{ML_i}$ is the activity of the complex. This can be rearranged to express the complex concentration as:\n$$a_{ML_i} = K_i a_{\\mathrm{M}} a_i$$\n\nThe mass balance equations express the conservation of total analytical concentrations, denoted $C_{\\mathrm{M}}^{\\mathrm{T}}$ for the metal and $C_i^{\\mathrm{T}}$ for each ligand $L_i$.\nThe total metal concentration is the sum of the free metal and all complexed forms:\n$$C_{\\mathrm{M}}^{\\mathrm{T}} = [M] + \\sum_{i=1}^{N} [ML_i] = a_{\\mathrm{M}} + \\sum_{i=1}^{N} K_i a_{\\mathrm{M}} a_i$$\nThe total concentration for each ligand $L_i$ is the sum of its free form and its complexed form:\n$$C_i^{\\mathrm{T}} = [L_i] + [ML_i] = a_i + K_i a_{\\mathrm{M}} a_i = a_i (1 + K_i a_{\\mathrm{M}})$$\nFrom the ligand mass balance, we can express the free ligand activity $a_i$ in terms of $a_{\\mathrm{M}}$ and known total concentrations:\n$$a_i = \\frac{C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}}$$\n\nTo obtain a single governing equation for the free metal activity $a_{\\mathrm{M}}$, we substitute the expression for $a_i$ into the metal mass balance equation:\n$$C_{\\mathrm{M}}^{\\mathrm{T}} = a_{\\mathrm{M}} + \\sum_{i=1}^{N} K_i a_{\\mathrm{M}} \\left( \\frac{C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right) = a_{\\mathrm{M}} \\left( 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right)$$\nThis is a scalar nonlinear equation in the single unknown $a_{\\mathrm{M}}$. To solve it numerically, we define a residual function $f(a_{\\mathrm{M}})$ and find its root:\n$$f(a_{\\mathrm{M}}) = a_{\\mathrm{M}} \\left( 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right) - C_{\\mathrm{M}}^{\\mathrm{T}} = 0$$\nThe solution to $f(a_{\\mathrm{M}}) = 0$ must lie in the physically meaningful interval $(0, C_{\\mathrm{M}}^{\\mathrm{T}}]$. A numerical root-finding algorithm, such as Brent's method, can be employed to find $a_{\\mathrm{M}}$ within this interval.\n\nThe second part of the problem is to compute the local logarithmic sensitivity, $S_j$, defined as:\n$$S_j = \\frac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$$\nUsing the chain rule of differentiation, this can be rewritten as:\n$$S_j = \\frac{\\partial \\ln a_{\\mathrm{M}}}{\\partial a_{\\mathrm{M}}} \\cdot \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} \\cdot \\frac{\\partial K_j}{\\partial \\ln K_j} = \\frac{1}{a_{\\mathrm{M}}} \\cdot \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} \\cdot K_j = \\frac{K_j}{a_{\\mathrm{M}}} \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j}$$\nTo find the derivative $\\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j}$, we apply implicit differentiation to the governing equation $f(a_{\\mathrm{M}}, \\{K_i\\}_{i=1}^N) = 0$. The total differential of $f$ is zero:\n$$df = \\frac{\\partial f}{\\partial a_{\\mathrm{M}}} da_{\\mathrm{M}} + \\sum_{i=1}^{N} \\frac{\\partial f}{\\partial K_i} dK_i = 0$$\nConsidering a perturbation only in $K_j$ while holding other constants fixed (i.e., $dK_i=0$ for $i \\neq j$), this simplifies to:\n$$\\frac{\\partial f}{\\partial a_{\\mathrm{M}}} \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} + \\frac{\\partial f}{\\partial K_j} = 0 \\implies \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} = - \\frac{\\partial f / \\partial K_j}{\\partial f / \\partial a_{\\mathrm{M}}}$$\nWe must now compute these two partial derivatives from the expression for $f$.\nThe partial derivative with respect to $a_{\\mathrm{M}}$ is:\n$$\\frac{\\partial f}{\\partial a_{\\mathrm{M}}} = \\frac{\\partial}{\\partial a_{\\mathrm{M}}} \\left[ a_{\\mathrm{M}} + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}} a_{\\mathrm{M}}}{1 + K_i a_{\\mathrm{M}}} - C_{\\mathrm{M}}^{\\mathrm{T}} \\right] = 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}$$\nThe partial derivative with respect to a specific formation constant $K_j$ affects only the $j$-th term in the summation:\n$$\\frac{\\partial f}{\\partial K_j} = \\frac{\\partial}{\\partial K_j} \\left[ \\frac{K_j C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{1 + K_j a_{\\mathrm{M}}} \\right] = \\frac{C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{(1 + K_j a_{\\mathrm{M}})^2}$$\nSubstituting these derivatives back into the expression for $S_j$:\n$$S_j = \\frac{K_j}{a_{\\mathrm{M}}} \\left( - \\frac{\\frac{C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{(1 + K_j a_{\\mathrm{M}})^2}}{1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}} \\right)$$\nSimplifying this expression yields the final formula for the sensitivity:\n$$S_j = - \\frac{\\frac{K_j C_j^{\\mathrm{T}}}{(1 + K_j a_{\\mathrm{M}})^2}}{1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}}$$\nThe algorithm is thus:\n1. For each test case, calculate the final total concentrations $C_{\\mathrm{M}}^{\\mathrm{T}}$ and $\\{C_i^{\\mathrm{T}}\\}$.\n2. Solve the nonlinear equation $f(a_{\\mathrm{M}}) = 0$ to find the equilibrium free metal activity $a_{\\mathrm{M}}$.\n3. Substitute the obtained value of $a_{\\mathrm{M}}$ along with the problem parameters into the derived expression for $S_j$ to compute the sensitivity for the specified index $j$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import optimize\n\ndef solve():\n    \"\"\"\n    Computes local logarithmic sensitivities for three geochemical scenarios.\n    \"\"\"\n\n    def calculate_sensitivity_for_case(C_M_T, C_L_T, K, j_idx):\n        \"\"\"\n        Calculates the equilibrium and sensitivity for a single case.\n\n        Args:\n            C_M_T (float): Total analytical concentration of the metal.\n            C_L_T (np.ndarray): Array of total analytical concentrations of ligands.\n            K (np.ndarray): Array of conditional formation constants.\n            j_idx (int): 0-based index of the ligand for sensitivity analysis.\n\n        Returns:\n            float: The calculated logarithmic sensitivity S_j.\n        \"\"\"\n        # 1. Define the residual function f(a_M) whose root is the equilibrium\n        #    free metal activity a_M.\n        #    f(a_M) = a_M * (1 + sum(K_i * C_i_T / (1 + K_i * a_M))) - C_M_T\n        def residual_f(a_M, C_M_T_arg, C_L_T_arg, K_arg):\n            sum_term = np.sum(K_arg * C_L_T_arg / (1.0 + K_arg * a_M))\n            return a_M * (1.0 + sum_term) - C_M_T_arg\n\n        # 2. Numerically solve for a_M using Brent's method.\n        # The physically valid search interval for a_M is (0, C_M_T]. We use a small\n        # positive value as the lower bound for numerical stability.\n        try:\n            a_M = optimize.brentq(\n                residual_f,\n                1e-30,\n                C_M_T,\n                args=(C_M_T, C_L_T, K)\n            )\n        except ValueError:\n            # This should not occur for the given well-posed problems.\n            return np.nan\n\n        # 3. Compute the local logarithmic sensitivity S_j from the derived formula:\n        #    S_j = - (numerator_j) / (denominator)\n        #    where numerator_j = (K_j * C_j_T) / (1 + K_j * a_M)^2\n        #    and denominator = 1 + sum_i [ (K_i * C_i_T) / (1 + K_i * a_M)^2 ]\n\n        # Calculate the numerator term for the specified index j\n        numerator_j = (K[j_idx] * C_L_T[j_idx]) / (1.0 + K[j_idx] * a_M)**2\n\n        # Calculate the denominator\n        all_terms_denom = (K * C_L_T) / (1.0 + K * a_M)**2\n        denominator = 1.0 + np.sum(all_terms_denom)\n\n        # Calculate the final sensitivity\n        S_j = -numerator_j / denominator\n        \n        return S_j\n\n    # --- Test Case 1: Titration-like end state ---\n    C_M_T1 = 1e-6\n    C_L_T1 = np.array([5e-6, 1e-6, 1e-8])\n    K1 = np.array([1e6, 1e4, 1e2])\n    j1 = 3  # 1-based index from problem statement\n\n    # --- Test Case 2: Evaporation ---\n    C_M0_2 = 1e-9\n    C_L0_T2 = np.array([1e-9, 1e-10, 1e-12])\n    phi2 = 0.1\n    K2 = np.array([1e7, 1e5, 1e1])\n    j2 = 3  # 1-based index\n\n    C_M_T2 = C_M0_2 / phi2\n    C_L_T2 = C_L0_T2 / phi2\n\n    # --- Test Case 3: Mixing ---\n    C_A = {'M': 1e-5, 'L1': 1e-6, 'L2': 0.0, 'L3': 1e-9}\n    C_B = {'M': 1e-7, 'L1': 0.0, 'L2': 1e-6, 'L3': 1e-8}\n    p3 = 0.3\n    K3 = np.array([1e5, 1e8, 1e2])\n    j3 = 3  # 1-based index\n\n    C_M_T3 = p3 * C_A['M'] + (1.0 - p3) * C_B['M']\n    C_L_T3 = np.array([\n        p3 * C_A['L1'] + (1.0 - p3) * C_B['L1'],\n        p3 * C_A['L2'] + (1.0 - p3) * C_B['L2'],\n        p3 * C_A['L3'] + (1.0 - p3) * C_B['L3']\n    ])\n\n    test_cases_params = [\n        {'C_M_T': C_M_T1, 'C_L_T': C_L_T1, 'K': K1, 'j_idx': j1 - 1},\n        {'C_M_T': C_M_T2, 'C_L_T': C_L_T2, 'K': K2, 'j_idx': j2 - 1},\n        {'C_M_T': C_M_T3, 'C_L_T': C_L_T3, 'K': K3, 'j_idx': j3 - 1}\n    ]\n\n    results = []\n    for params in test_cases_params:\n        s_j = calculate_sensitivity_for_case(**params)\n        results.append(s_j)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Many realistic geochemical systems are too complex to be reduced to a single equation and must be modeled as a coupled system of nonlinear equations. This advanced practice challenges you to build a solver for such a system using the powerful Newton-Raphson method. You will analytically derive the Jacobian matrix for a multi-acid titration scenario and implement a complete numerical solver, gaining experience with the sophisticated techniques required for stable and efficient modeling of complex multi-component equilibria .",
            "id": "4086555",
            "problem": "Consider a closed, well-mixed aqueous system at temperature $25~^\\circ\\text{C}$ containing two weak acids, carbonic acid (modeled as diprotic) and phosphoric acid (modeled as triprotic), initially dissolved in pure water, that is titrated by a strong base sodium hydroxide. Assume ideal solution behavior so that activities equal molar concentrations. The strong base fully dissociates into sodium ions and hydroxide ions, and water auto-ionizes. Assume no gas exchange and no precipitation. Your task is to formulate and solve the equilibrium problem using Newton iterations where the residuals are derived from mass action, mass balance, and electroneutrality, and the Jacobian matrix is assembled from analytic derivatives of the mass-action residuals.\n\nFundamental base for derivation:\n\n- Law of mass action: for a reaction of the form $A \\rightleftharpoons B$, the equilibrium condition is $K = \\dfrac{a_B}{a_A}$, where $a_X$ denotes the activity of species $X$ and $K$ is the equilibrium constant.\n- Charge balance (electroneutrality): the sum of positive charges equals the sum of negative charges in solution.\n- Conservation of mass (mass balance): for each element, the sum of concentrations of all species containing that element equals its total analytical concentration.\n- Mixing rule: after mixing volumes, the concentration of a conservative solute is its total moles divided by the total volume.\n\nChemistry definitions and constants:\n\n- Carbonic acid equilibria:\n  - $ \\mathrm{H_2CO_3} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{HCO_3^-} $ with equilibrium constant $K_{C1}$,\n  - $ \\mathrm{HCO_3^-} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{CO_3^{2-}} $ with equilibrium constant $K_{C2}$.\n- Phosphoric acid equilibria:\n  - $ \\mathrm{H_3PO_4} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{H_2PO_4^-} $ with equilibrium constant $K_{P1}$,\n  - $ \\mathrm{H_2PO_4^-} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{HPO_4^{2-}} $ with equilibrium constant $K_{P2}$,\n  - $ \\mathrm{HPO_4^{2-}} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{PO_4^{3-}} $ with equilibrium constant $K_{P3}$.\n- Water auto-ionization: $ \\mathrm{H_2O} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{OH^-} $ with equilibrium constant $K_w$.\n\nUse the following thermodynamic data at $25~^\\circ\\text{C}$:\n- $K_w = 10^{-14}$,\n- $K_{C1} = 10^{-6.35}$, $K_{C2} = 10^{-10.33}$,\n- $K_{P1} = 10^{-2.15}$, $K_{P2} = 10^{-7.20}$, $K_{P3} = 10^{-12.35}$.\n\nUnknowns and residuals:\n\nLet the unknown vector be $ \\mathbf{x} = (H, C_0, P_0) $, where $H = [\\mathrm{H^+}]$, $C_0 = [\\mathrm{H_2CO_3}]$, and $P_0 = [\\mathrm{H_3PO_4}]$ in mol/L. Secondary species concentrations are expressed by mass action in terms of $H$, $C_0$, and $P_0$:\n- $[\\mathrm{HCO_3^-}] = K_{C1} \\dfrac{C_0}{H}$,\n- $[\\mathrm{CO_3^{2-}}] = K_{C1} K_{C2} \\dfrac{C_0}{H^2}$,\n- $[\\mathrm{H_2PO_4^-}] = K_{P1} \\dfrac{P_0}{H}$,\n- $[\\mathrm{HPO_4^{2-}}] = K_{P1} K_{P2} \\dfrac{P_0}{H^2}$,\n- $[\\mathrm{PO_4^{3-}}] = K_{P1} K_{P2} K_{P3} \\dfrac{P_0}{H^3}$,\n- $[\\mathrm{OH^-}] = \\dfrac{K_w}{H}$.\n\nAfter mixing an initial acid solution volume $V_0$ with total analytical concentrations $C_{T0}$ (carbon) and $P_{T0}$ (phosphorus) with a base solution volume $V_b$ of sodium hydroxide concentration $C_b$, the mixed totals and conservative sodium concentration are:\n- $V = V_0 + V_b$,\n- $C_T = \\dfrac{C_{T0} V_0}{V}$,\n- $P_T = \\dfrac{P_{T0} V_0}{V}$,\n- $[\\mathrm{Na^+}] = \\dfrac{C_b V_b}{V}$.\n\nFormulate the residual vector $\\mathbf{r}(\\mathbf{x})$ as:\n- Carbon mass balance residual:\n  $$ r_1 = C_0 + K_{C1} \\frac{C_0}{H} + K_{C1} K_{C2} \\frac{C_0}{H^2} - C_T. $$\n- Phosphate mass balance residual:\n  $$ r_2 = P_0 + K_{P1} \\frac{P_0}{H} + K_{P1} K_{P2} \\frac{P_0}{H^2} + K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^3} - P_T. $$\n- Electroneutrality residual (positive charges minus negative charges):\n  $$ r_3 = H + [\\mathrm{Na^+}] - \\frac{K_w}{H} - \\left( K_{C1} \\frac{C_0}{H} + 2 K_{C1} K_{C2} \\frac{C_0}{H^2} + K_{P1} \\frac{P_0}{H} + 2 K_{P1} K_{P2} \\frac{P_0}{H^2} + 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^3} \\right). $$\n\nDerive and implement the analytic Jacobian matrix $ \\mathbf{J} = \\dfrac{\\partial \\mathbf{r}}{\\partial \\mathbf{x}} $ with entries:\n- $$ \\frac{\\partial r_1}{\\partial H} = - K_{C1} \\frac{C_0}{H^2} - 2 K_{C1} K_{C2} \\frac{C_0}{H^3}, \\quad \\frac{\\partial r_1}{\\partial C_0} = 1 + \\frac{K_{C1}}{H} + \\frac{K_{C1} K_{C2}}{H^2}, \\quad \\frac{\\partial r_1}{\\partial P_0} = 0. $$\n- $$ \\frac{\\partial r_2}{\\partial H} = - K_{P1} \\frac{P_0}{H^2} - 2 K_{P1} K_{P2} \\frac{P_0}{H^3} - 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, \\quad \\frac{\\partial r_2}{\\partial P_0} = 1 + \\frac{K_{P1}}{H} + \\frac{K_{P1} K_{P2}}{H^2} + \\frac{K_{P1} K_{P2} K_{P3}}{H^3}, \\quad \\frac{\\partial r_2}{\\partial C_0} = 0. $$\n- $$ \\frac{\\partial r_3}{\\partial H} = 1 + \\frac{K_w}{H^2} + K_{C1} \\frac{C_0}{H^2} + 4 K_{C1} K_{C2} \\frac{C_0}{H^3} + K_{P1} \\frac{P_0}{H^2} + 4 K_{P1} K_{P2} \\frac{P_0}{H^3} + 9 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_3}{\\partial C_0} = - \\left( \\frac{K_{C1}}{H} + \\frac{2 K_{C1} K_{C2}}{H^2} \\right), \\quad \\frac{\\partial r_3}{\\partial P_0} = - \\left( \\frac{K_{P1}}{H} + \\frac{2 K_{P1} K_{P2}}{H^2} + \\frac{3 K_{P1} K_{P2} K_{P3}}{H^3} \\right). $$\n\nAlgorithmic requirements:\n\n- Implement a Newton iteration to solve $ \\mathbf{r}(\\mathbf{x}) = \\mathbf{0} $ using the analytic Jacobian $ \\mathbf{J} $, with a damping or backtracking strategy to enforce positivity constraints $ H  0 $, $ C_0 \\ge 0 $, $ P_0 \\ge 0 $.\n- Initialize with $H = 10^{-7}$ mol/L, $C_0 = C_T$, $P_0 = P_T$ for each test case.\n- Solve to a tolerance such that the Euclidean norm of $ \\mathbf{r} $ is below $10^{-12}$ in units of mol/L.\n\nTest suite:\n\nFor each case, parameters are given as tuples $ (V_0, C_{T0}, P_{T0}, V_b, C_b) $, with volumes in L and concentrations in mol/L.\n\n- Case $1$ (balanced titration, moderate concentrations): $ (1.0, 0.01, 0.005, 0.05, 0.1) $.\n- Case $2$ (no base added, acidic): $ (1.0, 0.01, 0.005, 0.0, 0.1) $.\n- Case $3$ (strong base overshoot): $ (1.0, 0.01, 0.005, 0.5, 0.1) $.\n- Case $4$ (trace carbon, dilute base): $ (1.0, 1.0 \\times 10^{-6}, 0.0, 1.0 \\times 10^{-3}, 0.01) $.\n\nOutput specification:\n\n- For each test case, compute the equilibrium hydrogen concentration $ H $ and report the potential of Hydrogen (pH) defined as $ \\mathrm{pH} = - \\log_{10} H $.\n- Express the final pH values as dimensionless floats rounded to $6$ decimal places.\n- Your program should produce a single line of output containing the pH results for the four test cases as a comma-separated list enclosed in square brackets, for example, $[\\mathrm{pH}_1,\\mathrm{pH}_2,\\mathrm{pH}_3,\\mathrm{pH}_4]$.",
            "solution": "The problem is solved by formulating the multi-acid titration equilibrium using the law of mass action combined with mass balances and electroneutrality. The primary unknowns are the concentrations of hydrogen ions $H = [\\mathrm{H^+}]$, undissociated carbonic acid $C_0 = [\\mathrm{H_2CO_3}]$, and undissociated phosphoric acid $P_0 = [\\mathrm{H_3PO_4}]$, all in mol/L. Secondary species are expressed via mass action in terms of these unknowns, and the residual vector combines two mass balances and one charge balance.\n\nStarting point and definitions:\n\n- The mass action expressions for the conjugate bases of the acids directly follow from the reactions. For a generic dissociation step $ \\mathrm{HA} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{A^-} $, the equilibrium condition $ K = \\dfrac{[\\mathrm{H^+}][\\mathrm{A^-}]}{[\\mathrm{HA}]} $ implies $ [\\mathrm{A^-}] = K \\dfrac{[\\mathrm{HA}]}{[\\mathrm{H^+}]} $. For diprotic and triprotic acids, sequential application yields powers of $H$ in the denominators. Water auto-ionization gives $ [\\mathrm{OH^-}] = \\dfrac{K_w}{H} $.\n- The mass balances for the two acid systems enforce conservation: $ C_T = [\\mathrm{H_2CO_3}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}] $ and $ P_T = [\\mathrm{H_3PO_4}] + [\\mathrm{H_2PO_4^-}] + [\\mathrm{HPO_4^{2-}}] + [\\mathrm{PO_4^{3-}}] $. Substituting the mass action expressions leads to residuals $ r_1 $ and $ r_2 $.\n- Electroneutrality enforces the sum of charges to vanish. Positive charges are from $ \\mathrm{H^+} $ and conservative $ \\mathrm{Na^+} $. Negative charges include $ \\mathrm{OH^-} $, $ \\mathrm{HCO_3^-} $ (single negative charge), $ \\mathrm{CO_3^{2-}} $ (double negative charge), $ \\mathrm{H_2PO_4^-} $ (single negative charge), $ \\mathrm{HPO_4^{2-}} $ (double negative charge), and $ \\mathrm{PO_4^{3-}} $ (triple negative charge). Substituting mass action expressions yields residual $ r_3 $.\n\nAnalytic Jacobian:\n\nTo perform Newton iterations, we require the Jacobian entries $ \\dfrac{\\partial r_i}{\\partial x_j} $. Differentiating the residual definitions with respect to the unknowns $ H $, $ C_0 $, and $ P_0 $ yields:\n\n- Carbon mass balance derivatives:\n  $$ \\frac{\\partial r_1}{\\partial H} = - K_{C1} \\frac{C_0}{H^2} - 2 K_{C1} K_{C2} \\frac{C_0}{H^3}, \\quad \\frac{\\partial r_1}{\\partial C_0} = 1 + \\frac{K_{C1}}{H} + \\frac{K_{C1} K_{C2}}{H^2}, \\quad \\frac{\\partial r_1}{\\partial P_0} = 0. $$\n  These follow from differentiating $ H^{-1} $ and $ H^{-2} $ with respect to $ H $ and linear dependence on $ C_0 $.\n- Phosphate mass balance derivatives:\n  $$ \\frac{\\partial r_2}{\\partial H} = - K_{P1} \\frac{P_0}{H^2} - 2 K_{P1} K_{P2} \\frac{P_0}{H^3} - 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_2}{\\partial P_0} = 1 + \\frac{K_{P1}}{H} + \\frac{K_{P1} K_{P2}}{H^2} + \\frac{K_{P1} K_{P2} K_{P3}}{H^3}, \\quad \\frac{\\partial r_2}{\\partial C_0} = 0. $$\n  These similarly follow from the powers in the mass action expressions.\n- Electroneutrality derivatives:\n  $$ \\frac{\\partial r_3}{\\partial H} = 1 + \\frac{K_w}{H^2} + K_{C1} \\frac{C_0}{H^2} + 4 K_{C1} K_{C2} \\frac{C_0}{H^3} + K_{P1} \\frac{P_0}{H^2} + 4 K_{P1} K_{P2} \\frac{P_0}{H^3} + 9 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_3}{\\partial C_0} = - \\left( \\frac{K_{C1}}{H} + \\frac{2 K_{C1} K_{C2}}{H^2} \\right), \\quad \\frac{\\partial r_3}{\\partial P_0} = - \\left( \\frac{K_{P1}}{H} + \\frac{2 K_{P1} K_{P2}}{H^2} + \\frac{3 K_{P1} K_{P2} K_{P3}}{H^3} \\right). $$\n  The derivative of $ -\\dfrac{K_w}{H} $ with respect to $ H $ is $ + \\dfrac{K_w}{H^2} $. For the anions, the outer negative sign in $ r_3 $ reverses the signs of the derivatives of the anion terms, and the powers of $ H $ yield coefficients $ 1 $, $ 4 $, and $ 9 $ associated with $ H^{-1} $, $ H^{-2} $, and $ H^{-3} $ terms due to differentiation.\n\nNewton method:\n\n- Initialize $ H^{(0)} = 10^{-7} $ mol/L, $ C_0^{(0)} = C_T $, $ P_0^{(0)} = P_T $.\n- At iteration $ k $, compute $ \\mathbf{r}(\\mathbf{x}^{(k)}) $ and $ \\mathbf{J}(\\mathbf{x}^{(k)}) $, solve the linear system $ \\mathbf{J} \\Delta \\mathbf{x} = - \\mathbf{r} $ for $ \\Delta \\mathbf{x } $, and propose $ \\mathbf{x}^{(k+1)} = \\mathbf{x}^{(k)} + \\alpha \\Delta \\mathbf{x} $ with damping factor $ \\alpha \\in (0,1] $ chosen to enforce $ H^{(k+1)}  0 $, $ C_0^{(k+1)} \\ge 0 $, $ P_0^{(k+1)} \\ge 0 $ and to decrease $ \\lVert \\mathbf{r} \\rVert_2 $. A simple backtracking/step-limiting strategy is used: compute the largest $ \\alpha $ such that positivity constraints hold, then reduce $ \\alpha $ geometrically until $ \\lVert \\mathbf{r}(\\mathbf{x}^{(k)} + \\alpha \\Delta \\mathbf{x}) \\rVert_2 $ decreases sufficiently compared to $ \\lVert \\mathbf{r}(\\mathbf{x}^{(k)}) \\rVert_2 $.\n- Terminate when $ \\lVert \\mathbf{r} \\rVert_2  10^{-12} $ mol/L or after a maximum number of iterations if convergence is slow. The final hydrogen concentration yields $ \\mathrm{pH} = - \\log_{10} H $.\n\nMixing and test cases:\n\nFor each test case, compute $ V = V_0 + V_b $, $ C_T = \\dfrac{C_{T0} V_0}{V} $, $ P_T = \\dfrac{P_{T0} V_0}{V} $, and $ [\\mathrm{Na^+}] = \\dfrac{C_b V_b}{V} $. Solve the system and report pH values rounded to $6$ decimals. The four specified cases probe balanced titration, acid-only conditions, base overshoot, and trace concentration regimes, which together test stability and correctness across realistic geochemical regimes.\n\nImplementation notes:\n\n- All calculations use mol/L units, and pH is dimensionless by definition $ - \\log_{10} H $.\n- The Jacobian is assembled strictly from the analytic derivatives provided above, which is essential for robust Newton convergence in nonlinear speciation problems.",
            "answer": "```python\nimport numpy as np\n\n# Constants at 25 C\nKW = 10.0 ** (-14.0)\nKC1 = 10.0 ** (-6.35)\nKC2 = 10.0 ** (-10.33)\nKP1 = 10.0 ** (-2.15)\nKP2 = 10.0 ** (-7.20)\nKP3 = 10.0 ** (-12.35)\n\ndef mix_params(V0, CT0, PT0, Vb, Cb):\n    V = V0 + Vb\n    CT = CT0 * V0 / V\n    PT = PT0 * V0 / V\n    Na = Cb * Vb / V\n    return V, CT, PT, Na\n\ndef residuals_and_jacobian(x, CT, PT, Na):\n    H, C0, P0 = x\n\n    # Guard small H to avoid numerical overflow in derivatives\n    H = max(H, 1e-20)\n\n    # Secondary species via mass action\n    HCO3 = KC1 * C0 / H\n    CO3  = KC1 * KC2 * C0 / (H**2)\n    H2PO4 = KP1 * P0 / H\n    HPO4  = KP1 * KP2 * P0 / (H**2)\n    PO4   = KP1 * KP2 * KP3 * P0 / (H**3)\n    OH    = KW / H\n\n    # Residuals: r1, r2, r3\n    r1 = C0 + HCO3 + CO3 - CT\n    r2 = P0 + H2PO4 + HPO4 + PO4 - PT\n    r3 = H + Na - OH - (HCO3 + 2.0*CO3 + H2PO4 + 2.0*HPO4 + 3.0*PO4)\n    r = np.array([r1, r2, r3], dtype=float)\n\n    # Jacobian entries (analytic)\n    # dr1/dH, dr1/dC0, dr1/dP0\n    dr1_dH  = -KC1*C0/(H**2) - 2.0*KC1*KC2*C0/(H**3)\n    dr1_dC0 = 1.0 + KC1/H + KC1*KC2/(H**2)\n    dr1_dP0 = 0.0\n\n    # dr2/dH, dr2/dP0, dr2/dC0\n    dr2_dH  = -KP1*P0/(H**2) - 2.0*KP1*KP2*P0/(H**3) - 3.0*KP1*KP2*KP3*P0/(H**4)\n    dr2_dP0 = 1.0 + KP1/H + KP1*KP2/(H**2) + KP1*KP2*KP3/(H**3)\n    dr2_dC0 = 0.0\n\n    # dr3/dH, dr3/dC0, dr3/dP0\n    dr3_dH  = 1.0 + KW/(H**2) + KC1*C0/(H**2) + 4.0*KC1*KC2*C0/(H**3) \\\n              + KP1*P0/(H**2) + 4.0*KP1*KP2*P0/(H**3) + 9.0*KP1*KP2*KP3*P0/(H**4)\n    dr3_dC0 = -(KC1/H + 2.0*KC1*KC2/(H**2))\n    dr3_dP0 = -(KP1/H + 2.0*KP1*KP2/(H**2) + 3.0*KP1*KP2*KP3/(H**3))\n\n    J = np.array([\n        [dr1_dH,  dr1_dC0, dr1_dP0],\n        [dr2_dH,  dr2_dC0, dr2_dP0],\n        [dr3_dH,  dr3_dC0, dr3_dP0]\n    ], dtype=float)\n\n    return r, J\n\ndef newton_solve(CT, PT, Na, max_iter=100, tol=1e-12):\n    # Initial guess\n    x = np.array([1e-7, CT, PT], dtype=float)\n    # Lower bounds to enforce positivity\n    lower_bounds = np.array([1e-20, 0.0, 0.0], dtype=float)\n\n    r, _ = residuals_and_jacobian(x, CT, PT, Na)\n    res_norm = np.linalg.norm(r)\n\n    for _ in range(max_iter):\n        r, J = residuals_and_jacobian(x, CT, PT, Na)\n        res_norm = np.linalg.norm(r)\n        if res_norm  tol:\n            break\n\n        try:\n            dx = np.linalg.solve(J, -r)\n        except np.linalg.LinAlgError:\n            # If singular, perturb slightly and continue\n            J_pert = J + 1e-16 * np.eye(3)\n            dx = np.linalg.lstsq(J_pert, -r, rcond=None)[0]\n\n        # Compute maximum alpha to keep variables above bounds\n        alpha_pos = 1.0\n        for i in range(3):\n            if dx[i]  0:\n                # ensure x[i] + alpha*dx[i] = lower_bounds[i]\n                denom = -dx[i]\n                if denom  0:\n                    alpha_i = max(0.0, (x[i] - lower_bounds[i]) / denom)\n                    alpha_pos = min(alpha_pos, alpha_i)\n        alpha = min(1.0, 0.99 * alpha_pos if alpha_pos  1.0 else 1.0)\n        if alpha = 0:\n            alpha = 1e-3\n\n        # Backtracking to reduce residual norm\n        base_norm = res_norm\n        for _bt in range(25):\n            x_trial = x + alpha * dx\n            # Enforce bounds softly\n            x_trial = np.maximum(x_trial, lower_bounds)\n            r_trial, _ = residuals_and_jacobian(x_trial, CT, PT, Na)\n            if np.linalg.norm(r_trial)  base_norm * (1 - 1e-4):\n                x = x_trial\n                break\n            alpha *= 0.5\n        else:\n            # If no sufficient decrease, take the best trial anyway\n            x = x_trial\n\n    # Final guard\n    x = np.maximum(x, lower_bounds)\n    return x\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1.0, 0.01, 0.005, 0.05, 0.1),               # Case 1\n        (1.0, 0.01, 0.005, 0.0, 0.1),                # Case 2\n        (1.0, 0.01, 0.005, 0.5, 0.1),                # Case 3\n        (1.0, 1.0e-6, 0.0, 1.0e-3, 0.01),            # Case 4\n    ]\n\n    results = []\n    for (V0, CT0, PT0, Vb, Cb) in test_cases:\n        _, CT, PT, Na = mix_params(V0, CT0, PT0, Vb, Cb)\n        x = newton_solve(CT, PT, Na)\n        H = x[0]\n        # Compute pH\n        pH = -np.log10(H)\n        results.append(f\"{pH:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}