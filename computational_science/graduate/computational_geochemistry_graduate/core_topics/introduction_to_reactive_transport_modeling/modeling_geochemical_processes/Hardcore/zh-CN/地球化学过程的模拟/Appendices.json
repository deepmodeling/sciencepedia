{
    "hands_on_practices": [
        {
            "introduction": "在地球化学建模中，首要任务是将描述系统的化学原理（如质量守恒、电荷平衡和化学平衡）转化为一组数学上可解的方程。本练习将重点关注海洋碳酸盐体系，这是海洋学和气候科学中的一个基本问题。通过从测量的总无机碳（DIC）和总碱度推导出一个关于氢离子活度 $a_{\\mathrm{H^+}}$ 的单一残差函数，您将掌握为数值求解器构建问题的核心代数技能 。",
            "id": "4086594",
            "problem": "一个封闭的、等温的海水样品在恒定温度和盐度下，被分析其溶解无机碳（DIC）和总碱度。设测得的溶解无机碳（DIC）为 $C_{\\mathrm{T}}$，测得的总碱度为 $A_{\\mathrm{T}}$。酸度标度由氢离子活度定义，其中自由氢标度上的 $\\mathrm{pH}$ 定义为 $\\mathrm{pH} = -\\log_{10}(a_{\\mathrm{H^+}})$，其中 $a_{\\mathrm{H^+}}$ 是氢离子 $\\mathrm{H^+}$ 的活度。活度 $a_i$ 和摩尔浓度 $[i]$ 通过 $a_i = \\gamma_i [i]$ 相关联，其中 $\\gamma_i$ 是在由盐度决定的给定离子强度下，特定物种的活度系数。假设系统在以下约束和定义下，关于碳酸盐和硼酸盐的酸碱反应以及水的自电离达到了平衡：\n\n- 碳酸盐平衡由基于活度的酸解离常数 $K_1$ 和 $K_2$ 控制，定义为 $K_1 = \\dfrac{a_{\\mathrm{HCO_3^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{CO_2^*}}}$ 和 $K_2 = \\dfrac{a_{\\mathrm{CO_3^{2-}}} a_{\\mathrm{H^+}}}{a_{\\mathrm{HCO_3^-}}}$，其中 $\\mathrm{CO_2^*}$ 表示 $\\mathrm{CO_2(aq)} + \\mathrm{H_2CO_3}$ 的总和。\n- 硼酸盐平衡由基于活度的酸解离常数 $K_{\\mathrm{B}} = \\dfrac{a_{\\mathrm{B(OH)_4^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{B(OH)_3}}}$ 控制，总硼量 $B_{\\mathrm{T}}$ 通过已知的经验关系由盐度确定（此处视为给定参数）。\n- 水的自电离由热力学常数 $K_{\\mathrm{w}} = a_{\\mathrm{H^+}} a_{\\mathrm{OH^-}}$ 描述。\n\n假设磷酸盐、硅酸盐、有机酸/碱以及次要的酸碱体系可以忽略不计，并且强离子背景由盐度固定，因此总碱度 $A_{\\mathrm{T}}$ 的定义简化为标准的碳酸盐-硼酸盐-水形式。在此假设下，总碱度可以表示为相对于参考酸的净碱过量，具体为\n$$\nA_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}] + [\\mathrm{B(OH)_4^-}] + [\\mathrm{OH^-}] - [\\mathrm{H^+}] \\, .\n$$\n\n质量平衡定义为\n$$\nC_{\\mathrm{T}} = [\\mathrm{CO_2^*}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}]\n\\quad\\text{和}\\quad\nB_{\\mathrm{T}} = [\\mathrm{B(OH)_3}] + [\\mathrm{B(OH)_4^-}] \\, .\n$$\n\n严格从上述基于活度的平衡定义和质量平衡，以及通过 $A_{\\mathrm{T}}$ 形式化的电中性出发，推导一个关于氢离子活度的单一标量残差函数 $R(a_{\\mathrm{H^+}})$。当 $a_{\\mathrm{H^+}}$ 与在给定温度和盐度下测得的 $C_{\\mathrm{T}}$ 和 $A_{\\mathrm{T}}$ 一致时，该函数在平衡时为零。您的推导必须：\n\n- 仅使用基于活度的常数 $K_1$、$K_2$、$K_{\\mathrm{B}}$ 和 $K_{\\mathrm{w}}$ 以及活度系数 $\\gamma_i$。\n- 消去所有未知的中间活度和 $\\mathrm{CO_2^*}$、$\\mathrm{HCO_3^-}$、$\\mathrm{CO_3^{2-}}$、$\\mathrm{B(OH)_3}$、$\\mathrm{B(OH)_4^-}$ 和 $\\mathrm{OH^-}$ 的浓度，用 $a_{\\mathrm{H^+}}$、$C_{\\mathrm{T}}$、$B_{\\mathrm{T}}$ 和常数来表示。\n- 得出一个闭式解析表达式 $R(a_{\\mathrm{H^+}})$，它只依赖于 $a_{\\mathrm{H^+}}$、$C_{\\mathrm{T}}$、$A_{\\mathrm{T}}$、$B_{\\mathrm{T}}$、$K_1$、$K_2$、$K_{\\mathrm{B}}$、$K_{\\mathrm{w}}$ 及相关的 $\\gamma_i$，并且适合于数值求根。\n\n将最终残差 $R(a_{\\mathrm{H^+}})$ 显式地表示为 $a_{\\mathrm{H^+}}$ 的函数，除了指定的变量外，不引入任何其他变量。最终答案必须是单个闭式解析表达式，而不是一个方程。不需要进行数值计算，也不适用四舍五入。",
            "solution": "问题要求推导一个单一标量残差函数 $R(a_{\\mathrm{H^+}})$，当氢离子活度 $a_{\\mathrm{H^+}}$ 与测得的溶解无机碳 $C_{\\mathrm{T}}$ 和总碱度 $A_{\\mathrm{T}}$ 一致时，该函数等于零。该函数必须用给定的参数表示：$a_{\\mathrm{H^+}}$、$C_{\\mathrm{T}}$、$A_{\\mathrm{T}}$、$B_{\\mathrm{T}}$、基于活度的平衡常数 $K_1$、$K_2$、$K_{\\mathrm{B}}$、$K_{\\mathrm{w}}$ 以及相关的活度系数 $\\gamma_i$。\n\n一个合适的残差函数可以定义为从系统状态（由 $a_{\\mathrm{H^+}}$、$C_{\\mathrm{T}}$ 和 $B_{\\mathrm{T}}$ 定义）计算出的碱度与测量的碱度 $A_{\\mathrm{T}}$ 之间的差值。让我们将计算出的碱度表示为 $A_{\\mathrm{T,calc}}$。那么残差函数是：\n$$\nR(a_{\\mathrm{H^+}}) = A_{\\mathrm{T,calc}}(a_{\\mathrm{H^+}}, C_{\\mathrm{T}}, B_{\\mathrm{T}}) - A_{\\mathrm{T}}\n$$\n问题指明了总碱度以摩尔浓度表示的定义：\n$$\nA_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}] + [\\mathrm{B(OH)_4^-}] + [\\mathrm{OH^-}] - [\\mathrm{H^+}]\n$$\n我们的任务是将右侧的每种浓度表示为 $a_{\\mathrm{H^+}}$、总浓度 $C_{\\mathrm{T}}$ 和 $B_{\\mathrm{T}}$ 以及基本常数的函数。\n\n为便于推导，首先定义化学计量平衡常数是方便的，这些是“混合”常数，关联某些物种（这里是 $\\mathrm{H^+}$）的活度与其他物种的浓度。这些在化学海洋学中是标准的，并将在最后被替换掉以满足问题的约束。\n\n基于活度的常数 $K_1$ 是 $K_1 = \\frac{a_{\\mathrm{HCO_3^-}} a_{\\mathrm{H^+}}}{a_{\\mathrm{CO_2^*}}}$。使用关系 $a_i = \\gamma_i [i]$，我们得到 $K_1 = \\frac{\\gamma_{\\mathrm{HCO_3^-}}[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{CO_2^*}}[\\mathrm{CO_2^*}]}$。我们定义化学计量常数 $K'_1$ 为：\n$$\nK'_1 = \\frac{[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{[\\mathrm{CO_2^*}]} = K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\n$$\n类似地，对于第二个碳酸盐平衡和硼酸盐平衡：\n$$\nK'_2 = \\frac{[\\mathrm{CO_3^{2-}}] a_{\\mathrm{H^+}}}{[\\mathrm{HCO_3^-}]} = K_2 \\frac{\\gamma_{\\mathrm{HCO_3^-}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\n$$\n$$\nK'_{\\mathrm{B}} = \\frac{[\\mathrm{B(OH)_4^-}] a_{\\mathrm{H^+}}}{[\\mathrm{B(OH)_3}]} = K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}\n$$\n\n现在，我们逐项推导对 $A_{\\mathrm{T,calc}}$ 的贡献。\n\n**1. 碳酸盐体系贡献 ($A_{\\mathrm{C}}$)**\n\n总溶解无机碳为 $C_{\\mathrm{T}} = [\\mathrm{CO_2^*}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}]$。\n使用 $K'_1$ 和 $K'_2$ 的定义，我们将 $[\\mathrm{CO_2^*}]$ 和 $[\\mathrm{CO_3^{2-}}]$ 用 $[\\mathrm{HCO_3^-}]$ 和 $a_{\\mathrm{H^+}}$ 表示：\n$$\n[\\mathrm{CO_2^*}] = \\frac{[\\mathrm{HCO_3^-}] a_{\\mathrm{H^+}}}{K'_1}, \\quad [\\mathrm{CO_3^{2-}}] = \\frac{K'_2 [\\mathrm{HCO_3^-}]}{a_{\\mathrm{H^+}}}\n$$\n代入 $C_{\\mathrm{T}}$ 方程：\n$$\nC_{\\mathrm{T}} = [\\mathrm{HCO_3^-}] \\left( \\frac{a_{\\mathrm{H^+}}}{K'_1} + 1 + \\frac{K'_2}{a_{\\mathrm{H^+}}} \\right) = [\\mathrm{HCO_3^-}] \\frac{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}{K'_1 a_{\\mathrm{H^+}}}\n$$\n求解碳酸氢盐和碳酸盐的浓度：\n$$\n[\\mathrm{HCO_3^-}] = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}}}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\n$$\n[\\mathrm{CO_3^{2-}}] = \\frac{K'_2}{a_{\\mathrm{H^+}}} [\\mathrm{HCO_3^-}] = C_{\\mathrm{T}} \\frac{K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\n碳酸盐对碱度的贡献是 $A_{\\mathrm{C}} = [\\mathrm{HCO_3^-}] + 2[\\mathrm{CO_3^{2-}}]$：\n$$\nA_{\\mathrm{C}} = C_{\\mathrm{T}} \\left( \\frac{K'_1 a_{\\mathrm{H^+}}}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + \\frac{2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} \\right) = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2}\n$$\n\n**2. 硼酸盐体系贡献 ($A_{\\mathrm{B}}$)**\n\n总硼量为 $B_{\\mathrm{T}} = [\\mathrm{B(OH)_3}] + [\\mathrm{B(OH)_4^-}]$。\n根据 $K'_{\\mathrm{B}}$ 的定义，我们有 $[\\mathrm{B(OH)_3}] = \\frac{[\\mathrm{B(OH)_4^-}] a_{\\mathrm{H^+}}}{K'_{\\mathrm{B}}}$。\n代入 $B_{\\mathrm{T}}$ 方程：\n$$\nB_{\\mathrm{T}} = [\\mathrm{B(OH)_4^-}] \\left( \\frac{a_{\\mathrm{H^+}}}{K'_{\\mathrm{B}}} + 1 \\right) = [\\mathrm{B(OH)_4^-}] \\frac{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}}{K'_{\\mathrm{B}}}\n$$\n硼酸盐对碱度的贡献是 $A_{\\mathrm{B}} = [\\mathrm{B(OH)_4^-}]$：\n$$\nA_{\\mathrm{B}} = B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}}\n$$\n\n**3. 水的自电离贡献 ($A_{\\mathrm{W}}$)**\n\n剩下的项是 $[\\mathrm{OH^-}]$ 和 $[\\mathrm{H^+}]$。\n从 $K_{\\mathrm{w}} = a_{\\mathrm{H^+}} a_{\\mathrm{OH^-}}$，我们得到 $a_{\\mathrm{OH^-}} = K_{\\mathrm{w}} / a_{\\mathrm{H^+}}$。浓度为 $[\\mathrm{OH^-}] = a_{\\mathrm{OH^-}} / \\gamma_{\\mathrm{OH^-}} = \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}}$。\n氢离子浓度为 $[\\mathrm{H^+}] = a_{\\mathrm{H^+}} / \\gamma_{\\mathrm{H^+}}$。\n来自水和氢离子的贡献是 $A_{\\mathrm{W}} = [\\mathrm{OH^-}] - [\\mathrm{H^+}]$：\n$$\nA_{\\mathrm{W}} = \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}}\n$$\n\n**4. 组装残差函数**\n\n结合所有贡献，计算出的总碱度为：\n$$\nA_{\\mathrm{T,calc}} = A_{\\mathrm{C}} + A_{\\mathrm{B}} + A_{\\mathrm{W}} = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}}\n$$\n因此，残差函数 $R(a_{\\mathrm{H^+}}) = A_{\\mathrm{T,calc}} - A_{\\mathrm{T}}$ 为：\n$$\nR(a_{\\mathrm{H^+}}) = C_{\\mathrm{T}} \\frac{K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2}{(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2} + B_{\\mathrm{T}} \\frac{K'_{\\mathrm{B}}}{a_{\\mathrm{H^+}} + K'_{\\mathrm{B}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}\n$$\n\n**5. 以基本常数表示的最终表达式**\n\n最后，我们将化学计量常数（$K'_1, K'_2, K'_{\\mathrm{B}}$）的定义代回到 $R(a_{\\mathrm{H^+}})$ 的表达式中，以满足问题陈述的明确要求。\n\n对于碳酸盐项的分子：$K'_1 a_{\\mathrm{H^+}} + 2K'_1 K'_2 = \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)$。\n对于碳酸盐项的分母：$(a_{\\mathrm{H^+}})^2 + K'_1 a_{\\mathrm{H^+}} + K'_1 K'_2 = (a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)$。\n对于硼酸盐项：$K'_{\\mathrm{B}} = K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}$。\n\n代入这些，得到残差函数 $R(a_{\\mathrm{H^+}})$ 的最终完整表达式。该表达式仅依赖于 $a_{\\mathrm{H^+}}$ 和指定的已知参数。\n$$\nR(a_{\\mathrm{H^+}}) = C_{\\mathrm{T}} \\frac{\\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)}{(a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)} + B_{\\mathrm{T}} \\frac{K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}}{a_{\\mathrm{H^+}} + K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}\n$$\n这就是所需的闭式解析表达式，适用于通过数值求根来确定海水样品的平衡 $a_{\\mathrm{H^+}}$。",
            "answer": "$$\\boxed{C_{\\mathrm{T}} \\frac{\\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + 2\\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)}{(a_{\\mathrm{H^+}})^2 + \\left(K_1 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{HCO_3^-}}}\\right) a_{\\mathrm{H^+}} + \\left(K_1 K_2 \\frac{\\gamma_{\\mathrm{CO_2^*}}}{\\gamma_{\\mathrm{CO_3^{2-}}}}\\right)} + B_{\\mathrm{T}} \\frac{K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}}{a_{\\mathrm{H^+}} + K_{\\mathrm{B}} \\frac{\\gamma_{\\mathrm{B(OH)_3}}}{\\gamma_{\\mathrm{B(OH)_4^-}}}} + \\frac{K_{\\mathrm{w}}}{a_{\\mathrm{H^+}} \\gamma_{\\mathrm{OH^-}}} - \\frac{a_{\\mathrm{H^+}}}{\\gamma_{\\mathrm{H^+}}} - A_{\\mathrm{T}}}$$"
        },
        {
            "introduction": "一旦建立了控制方程，下一步就是求解它们以找到系统的平衡状态。对于复杂的多物种体系，这通常需要强大的数值方法。本练习将介绍牛顿法，这是一种用于求解非线性方程组的高效技术，通过构建和使用解析导数（雅可比矩阵），您可以为一个复杂的多酸滴定系统实现快速稳定的收敛 。",
            "id": "4086555",
            "problem": "考虑一个温度为 $25$ $\\mathrm{^\\circ C}$ 的封闭、充分混合的水相体系，其中含有两种弱酸——碳酸（模拟为二元酸）和磷酸（模拟为三元酸），初始时溶解在纯水中，并用强碱氢氧化钠进行滴定。假设为理想溶液行为，因此活度等于摩尔浓度。强碱完全解离为钠离子和氢氧根离子，水会发生自电离。假设没有气体交换，也没有沉淀形成。您的任务是使用牛顿迭代法建立并求解该平衡问题，其中残差由质量作用、质量平衡和电中性导出，雅可比矩阵由质量作用残差的解析导数构成。\n\n推导的基本依据：\n\n- 质量作用定律：对于形式为 $A \\rightleftharpoons B$ 的反应，其平衡条件为 $K = \\dfrac{a_B}{a_A}$，其中 $a_X$ 表示物种 $X$ 的活度，$K$ 是平衡常数。\n- 电荷平衡（电中性）：溶液中正电荷的总和等于负电荷的总和。\n- 质量守恒（质量平衡）：对于每种元素，所有含有该元素的物种浓度之和等于其总分析浓度。\n- 混合法则：混合不同体积的溶液后，保守溶质的浓度为其总摩尔数除以总体积。\n\n化学定义与常数：\n\n- 碳酸平衡：\n  - $ \\mathrm{H_2CO_3} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{HCO_3^-} $，平衡常数为 $K_{C1}$，\n  - $ \\mathrm{HCO_3^-} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{CO_3^{2-}} $，平衡常数为 $K_{C2}$。\n- 磷酸平衡：\n  - $ \\mathrm{H_3PO_4} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{H_2PO_4^-} $，平衡常数为 $K_{P1}$，\n  - $ \\mathrm{H_2PO_4^-} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{HPO_4^{2-}} $，平衡常数为 $K_{P2}$，\n  - $ \\mathrm{HPO_4^{2-}} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{PO_4^{3-}} $，平衡常数为 $K_{P3}$。\n- 水的自电离：$ \\mathrm{H_2O} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{OH^-} $，平衡常数为 $K_w$。\n\n使用以下 $25$ $\\mathrm{^\\circ C}$ 时的热力学数据：\n- $K_w = 10^{-14}$，\n- $K_{C1} = 10^{-6.35}$，$K_{C2} = 10^{-10.33}$，\n- $K_{P1} = 10^{-2.15}$，$K_{P2} = 10^{-7.20}$，$K_{P3} = 10^{-12.35}$。\n\n未知数与残差：\n\n设未知向量为 $ \\mathbf{x} = (H, C_0, P_0) $，其中 $H = [\\mathrm{H^+}]$，$C_0 = [\\mathrm{H_2CO_3}]$，以及 $P_0 = [\\mathrm{H_3PO_4}]$，单位为 $\\mathrm{mol/L}$。次要物种的浓度通过质量作用定律以 $H$、$C_0$ 和 $P_0$ 表示：\n- $[\\mathrm{HCO_3^-}] = K_{C1} \\dfrac{C_0}{H}$，\n- $[\\mathrm{CO_3^{2-}}] = K_{C1} K_{C2} \\dfrac{C_0}{H^2}$，\n- $[\\mathrm{H_2PO_4^-}] = K_{P1} \\dfrac{P_0}{H}$，\n- $[\\mathrm{HPO_4^{2-}}] = K_{P1} K_{P2} \\dfrac{P_0}{H^2}$，\n- $[\\mathrm{PO_4^{3-}}] = K_{P1} K_{P2} K_{P3} \\dfrac{P_0}{H^3}$，\n- $[\\mathrm{OH^-}] = \\dfrac{K_w}{H}$。\n\n将初始体积为 $V_0$、总分析浓度为 $C_{T0}$（碳）和 $P_{T0}$（磷）的酸溶液与体积为 $V_b$、浓度为 $C_b$ 的氢氧化钠碱溶液混合后，混合后的总浓度和保守的钠离子浓度为：\n- $V = V_0 + V_b$，\n- $C_T = \\dfrac{C_{T0} V_0}{V}$，\n- $P_T = \\dfrac{P_{T0} V_0}{V}$，\n- $[\\mathrm{Na^+}] = \\dfrac{C_b V_b}{V}$。\n\n构建残差向量 $\\mathbf{r}(\\mathbf{x})$ 如下：\n- 碳质量平衡残差：\n  $$ r_1 = C_0 + K_{C1} \\frac{C_0}{H} + K_{C1} K_{C2} \\frac{C_0}{H^2} - C_T. $$\n- 磷酸盐质量平衡残差：\n  $$ r_2 = P_0 + K_{P1} \\frac{P_0}{H} + K_{P1} K_{P2} \\frac{P_0}{H^2} + K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^3} - P_T. $$\n- 电中性残差（正电荷减去负电荷）：\n  $$ r_3 = H + [\\mathrm{Na^+}] - \\frac{K_w}{H} - \\left( K_{C1} \\frac{C_0}{H} + 2 K_{C1} K_{C2} \\frac{C_0}{H^2} + K_{P1} \\frac{P_0}{H} + 2 K_{P1} K_{P2} \\frac{P_0}{H^2} + 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^3} \\right). $$\n\n推导并实现解析雅可比矩阵 $ \\mathbf{J} = \\dfrac{\\partial \\mathbf{r}}{\\partial \\mathbf{x}} $，其元素为：\n- $$ \\frac{\\partial r_1}{\\partial H} = - K_{C1} \\frac{C_0}{H^2} - 2 K_{C1} K_{C2} \\frac{C_0}{H^3}, \\quad \\frac{\\partial r_1}{\\partial C_0} = 1 + \\frac{K_{C1}}{H} + \\frac{K_{C1} K_{C2}}{H^2}, \\quad \\frac{\\partial r_1}{\\partial P_0} = 0. $$\n- $$ \\frac{\\partial r_2}{\\partial H} = - K_{P1} \\frac{P_0}{H^2} - 2 K_{P1} K_{P2} \\frac{P_0}{H^3} - 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, \\quad \\frac{\\partial r_2}{\\partial P_0} = 1 + \\frac{K_{P1}}{H} + \\frac{K_{P1} K_{P2}}{H^2} + \\frac{K_{P1} K_{P2} K_{P3}}{H^3}, \\quad \\frac{\\partial r_2}{\\partial C_0} = 0. $$\n- $$ \\frac{\\partial r_3}{\\partial H} = 1 + \\frac{K_w}{H^2} + K_{C1} \\frac{C_0}{H^2} + 4 K_{C1} K_{C2} \\frac{C_0}{H^3} + K_{P1} \\frac{P_0}{H^2} + 4 K_{P1} K_{P2} \\frac{P_0}{H^3} + 9 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_3}{\\partial C_0} = - \\left( \\frac{K_{C1}}{H} + \\frac{2 K_{C1} K_{C2}}{H^2} \\right), \\quad \\frac{\\partial r_3}{\\partial P_0} = - \\left( \\frac{K_{P1}}{H} + \\frac{2 K_{P1} K_{P2}}{H^2} + \\frac{3 K_{P1} K_{P2} K_{P3}}{H^3} \\right). $$\n\n算法要求：\n\n- 实现一个牛顿迭代来求解 $ \\mathbf{r}(\\mathbf{x}) = \\mathbf{0} $，使用解析雅可比矩阵 $ \\mathbf{J} $，并采用阻尼或回溯策略来强制执行正值约束 $ H > 0 $，$ C_0 \\ge 0 $，$ P_0 \\ge 0 $。\n- 对每个测试用例，使用 $ H = 10^{-7} $ $\\mathrm{mol/L}$，$ C_0 = C_T $，$ P_0 = P_T $ 进行初始化。\n- 求解至容差，使得 $ \\mathbf{r} $ 的欧几里得范数低于 $10^{-12}$，单位为 $\\mathrm{mol/L}$。\n\n测试套件：\n\n对于每个用例，参数以元组 $ (V_0, C_{T0}, P_{T0}, V_b, C_b) $ 的形式给出，体积单位为 $\\mathrm{L}$，浓度单位为 $\\mathrm{mol/L}$。\n\n- 用例 $1$（平衡滴定，中等浓度）：$ (1.0, 0.01, 0.005, 0.05, 0.1) $。\n- 用例 $2$（未加碱，酸性）：$ (1.0, 0.01, 0.005, 0.0, 0.1) $。\n- 用例 $3$（强碱过量）：$ (1.0, 0.01, 0.005, 0.5, 0.1) $。\n- 用例 $4$（痕量碳，稀碱）：$ (1.0, 1.0 \\times 10^{-6}, 0.0, 1.0 \\times 10^{-3}, 0.01) $。\n\n输出规格：\n\n- 对于每个测试用例，计算平衡氢离子浓度 $ H $，并报告定义为 $ \\mathrm{pH} = - \\log_{10} H $ 的pH值。\n- 将最终的 pH 值表示为四舍五入到 $6$ 位小数的无量纲浮点数。\n- 您的程序应生成单行输出，其中包含四个测试用例的 pH 结果，形式为包含在方括号中的逗号分隔列表，例如 $[\\mathrm{pH}_1,\\mathrm{pH}_2,\\mathrm{pH}_3,\\mathrm{pH}_4]$。",
            "solution": "该问题通过结合质量作用定律、质量平衡和电中性来构建多酸滴定平衡，从而得以解决。主要未知数是氢离子浓度 $H = [\\mathrm{H^+}]$、未解离的碳酸浓度 $C_0 = [\\mathrm{H_2CO_3}]$ 和未解离的磷酸浓度 $P_0 = [\\mathrm{H_3PO_4}]$，单位均为 $\\mathrm{mol/L}$。次要物种通过质量作用定律以这些未知数表示，残差向量则结合了两个质量平衡和一个电荷平衡。\n\n起点和定义：\n\n- 酸的共轭碱的质量作用表达式直接源自反应。对于一般的解离步骤 $ \\mathrm{HA} \\rightleftharpoons \\mathrm{H^+} + \\mathrm{A^-} $，平衡条件 $ K = \\dfrac{[\\mathrm{H^+}][\\mathrm{A^-}]}{[\\mathrm{HA}]} $ 意味着 $ [\\mathrm{A^-}] = K \\dfrac{[\\mathrm{HA}]}{[\\mathrm{H^+}]} $。对于二元和三元酸，顺序应用此规则导致分母中出现 $H$ 的幂。水的自电离给出 $ [\\mathrm{OH^-}] = \\dfrac{K_w}{H} $。\n- 两种酸体系的质量平衡强制执行守恒：$ C_T = [\\mathrm{H_2CO_3}] + [\\mathrm{HCO_3^-}] + [\\mathrm{CO_3^{2-}}] $ 和 $ P_T = [\\mathrm{H_3PO_4}] + [\\mathrm{H_2PO_4^-}] + [\\mathrm{HPO_4^{2-}}] + [\\mathrm{PO_4^{3-}}] $。代入质量作用表达式可得到残差 $ r_1 $ 和 $ r_2 $。\n- 电中性强制要求电荷总和为零。正电荷来自 $ \\mathrm{H^+} $ 和保守的 $ \\mathrm{Na^+} $。负电荷包括 $ \\mathrm{OH^-} $、$ \\mathrm{HCO_3^-} $（单位负电荷）、$ \\mathrm{CO_3^{2-}} $（二价负电荷）、$ \\mathrm{H_2PO_4^-} $（单位负电荷）、$ \\mathrm{HPO_4^{2-}} $（二价负电荷）和 $ \\mathrm{PO_4^{3-}} $（三价负电荷）。代入质量作用表达式可得到残差 $ r_3 $。\n\n解析雅可比矩阵：\n\n为了执行牛顿迭代，我们需要雅可比矩阵的元素 $ \\dfrac{\\partial r_i}{\\partial x_j} $。对残差定义式关于未知数 $ H $、$ C_0 $ 和 $ P_0 $ 求导，得到：\n\n- 碳质量平衡导数：\n  $$ \\frac{\\partial r_1}{\\partial H} = - K_{C1} \\frac{C_0}{H^2} - 2 K_{C1} K_{C2} \\frac{C_0}{H^3}, \\quad \\frac{\\partial r_1}{\\partial C_0} = 1 + \\frac{K_{C1}}{H} + \\frac{K_{C1} K_{C2}}{H^2}, \\quad \\frac{\\partial r_1}{\\partial P_0} = 0. $$\n  这些导数是通过对 $ H^{-1} $ 和 $ H^{-2} $ 关于 $ H $ 求导以及利用对 $ C_0 $ 的线性依赖性得出的。\n- 磷酸盐质量平衡导数：\n  $$ \\frac{\\partial r_2}{\\partial H} = - K_{P1} \\frac{P_0}{H^2} - 2 K_{P1} K_{P2} \\frac{P_0}{H^3} - 3 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_2}{\\partial P_0} = 1 + \\frac{K_{P1}}{H} + \\frac{K_{P1} K_{P2}}{H^2} + \\frac{K_{P1} K_{P2} K_{P3}}{H^3}, \\quad \\frac{\\partial r_2}{\\partial C_0} = 0. $$\n  这些同样源于质量作用表达式中的幂次。\n- 电中性导数：\n  $$ \\frac{\\partial r_3}{\\partial H} = 1 + \\frac{K_w}{H^2} + K_{C1} \\frac{C_0}{H^2} + 4 K_{C1} K_{C2} \\frac{C_0}{H^3} + K_{P1} \\frac{P_0}{H^2} + 4 K_{P1} K_{P2} \\frac{P_0}{H^3} + 9 K_{P1} K_{P2} K_{P3} \\frac{P_0}{H^4}, $$\n  $$ \\frac{\\partial r_3}{\\partial C_0} = - \\left( \\frac{K_{C1}}{H} + \\frac{2 K_{C1} K_{C2}}{H^2} \\right), \\quad \\frac{\\partial r_3}{\\partial P_0} = - \\left( \\frac{K_{P1}}{H} + \\frac{2 K_{P1} K_{P2}}{H^2} + \\frac{3 K_{P1} K_{P2} K_{P3}}{H^3} \\right). $$\n  $ -\\dfrac{K_w}{H} $ 关于 $ H $ 的导数是 $ + \\dfrac{K_w}{H^2} $。对于阴离子， $ r_3 $ 中的外部负号反转了阴离子项导数的符号，由于求导，与 $ H^{-1} $、$ H^{-2} $ 和 $ H^{-3} $ 项相关的系数分别为 $ 1 $、$ 4 $ 和 $ 9 $。\n\n牛顿法：\n\n- 初始化 $ H^{(0)} = 10^{-7} $ $\\mathrm{mol/L}$，$ C_0^{(0)} = C_T $，$ P_0^{(0)} = P_T $。\n- 在第 $ k $ 次迭代时，计算 $ \\mathbf{r}(\\mathbf{x}^{(k)}) $ 和 $ \\mathbf{J}(\\mathbf{x}^{(k)}) $，求解线性方程组 $ \\mathbf{J} \\Delta \\mathbf{x} = - \\mathbf{r} $ 得到 $ \\Delta \\mathbf{x } $，并提出新的解 $ \\mathbf{x}^{(k+1)} = \\mathbf{x}^{(k)} + \\alpha \\Delta \\mathbf{x} $，其中阻尼因子 $ \\alpha \\in (0,1] $ 的选择是为了强制满足 $ H^{(k+1)} > 0 $、$ C_0^{(k+1)} \\ge 0 $、$ P_0^{(k+1)} \\ge 0 $ 并减小 $\\| \\mathbf{r} \\|_2$。使用一个简单的回溯/步长限制策略：计算使正值约束成立的最大 $ \\alpha $，然后几何级数地减小 $ \\alpha $，直到 $\\| \\mathbf{r}(\\mathbf{x}^{(k)} + \\alpha \\Delta \\mathbf{x}) \\|_2$ 相对于 $\\| \\mathbf{r}(\\mathbf{x}^{(k)}) \\|_2$ 有足够的减小。\n- 当 $\\| \\mathbf{r} \\|_2  10^{-12} $ $\\mathrm{mol/L}$ 或达到最大迭代次数（如果收敛缓慢）时终止。最终的氢离子浓度可计算出 $ \\mathrm{pH} = - \\log_{10} H $。\n\n混合与测试用例：\n\n对于每个测试用例，计算 $ V = V_0 + V_b $、$ C_T = \\dfrac{C_{T0} V_0}{V} $、$ P_T = \\dfrac{P_{T0} V_0}{V} $ 和 $ [\\mathrm{Na^+}] = \\dfrac{C_b V_b}{V} $。求解该系统并报告四舍五入到 $6$ 位小数的 pH 值。这四个指定的用例分别探讨了平衡滴定、纯酸条件、碱过量和痕量浓度体系，共同测试了模型在实际地球化学体系中的稳定性和正确性。\n\n实现说明：\n\n- 所有计算均使用 $\\mathrm{mol/L}$ 单位，根据定义 $ - \\log_{10} H $，pH 是无量纲的。\n- 雅可比矩阵严格由上面提供的解析导数构成，这对于在非线性物种形成问题中实现稳健的牛顿收敛至关重要。",
            "answer": "```python\nimport numpy as np\n\n# Constants at 25 C\nKW = 10.0 ** (-14.0)\nKC1 = 10.0 ** (-6.35)\nKC2 = 10.0 ** (-10.33)\nKP1 = 10.0 ** (-2.15)\nKP2 = 10.0 ** (-7.20)\nKP3 = 10.0 ** (-12.35)\n\ndef mix_params(V0, CT0, PT0, Vb, Cb):\n    V = V0 + Vb\n    CT = CT0 * V0 / V if V > 0 else 0\n    PT = PT0 * V0 / V if V > 0 else 0\n    Na = Cb * Vb / V if V > 0 else 0\n    return V, CT, PT, Na\n\ndef residuals_and_jacobian(x, CT, PT, Na):\n    H, C0, P0 = x\n\n    # Guard small H to avoid numerical overflow in derivatives\n    H = max(H, 1e-20)\n\n    # Secondary species via mass action\n    HCO3 = KC1 * C0 / H\n    CO3  = KC1 * KC2 * C0 / (H**2)\n    H2PO4 = KP1 * P0 / H\n    HPO4  = KP1 * KP2 * P0 / (H**2)\n    PO4   = KP1 * KP2 * KP3 * P0 / (H**3)\n    OH    = KW / H\n\n    # Residuals: r1, r2, r3\n    r1 = C0 + HCO3 + CO3 - CT\n    r2 = P0 + H2PO4 + HPO4 + PO4 - PT\n    r3 = H + Na - OH - (HCO3 + 2.0*CO3 + H2PO4 + 2.0*HPO4 + 3.0*PO4)\n    r = np.array([r1, r2, r3], dtype=float)\n\n    # Jacobian entries (analytic)\n    # dr1/dH, dr1/dC0, dr1/dP0\n    dr1_dH  = -KC1*C0/(H**2) - 2.0*KC1*KC2*C0/(H**3)\n    dr1_dC0 = 1.0 + KC1/H + KC1*KC2/(H**2)\n    dr1_dP0 = 0.0\n\n    # dr2/dH, dr2/dP0, dr2/dC0\n    dr2_dH  = -KP1*P0/(H**2) - 2.0*KP1*KP2*P0/(H**3) - 3.0*KP1*KP2*KP3*P0/(H**4)\n    dr2_dP0 = 1.0 + KP1/H + KP1*KP2/(H**2) + KP1*KP2*KP3/(H**3)\n    dr2_dC0 = 0.0\n\n    # dr3/dH, dr3/dC0, dr3/dP0\n    dr3_dH  = 1.0 + KW/(H**2) + KC1*C0/(H**2) + 4.0*KC1*KC2*C0/(H**3) \\\n              + KP1*P0/(H**2) + 4.0*KP1*KP2*P0/(H**3) + 9.0*KP1*KP2*KP3*P0/(H**4)\n    dr3_dC0 = -(KC1/H + 2.0*KC1*KC2/(H**2))\n    dr3_dP0 = -(KP1/H + 2.0*KP1*KP2/(H**2) + 3.0*KP1*KP2*KP3/(H**3))\n\n    J = np.array([\n        [dr1_dH,  dr1_dC0, dr1_dP0],\n        [dr2_dH,  dr2_dC0, dr2_dP0],\n        [dr3_dH,  dr3_dC0, dr3_dP0]\n    ], dtype=float)\n\n    return r, J\n\ndef newton_solve(CT, PT, Na, max_iter=100, tol=1e-12):\n    # Initial guess\n    x = np.array([1e-7, max(0, CT), max(0, PT)], dtype=float)\n    # Lower bounds to enforce positivity\n    lower_bounds = np.array([1e-20, 0.0, 0.0], dtype=float)\n\n    r, _ = residuals_and_jacobian(x, CT, PT, Na)\n    res_norm = np.linalg.norm(r)\n\n    for _ in range(max_iter):\n        if res_norm  tol:\n            break\n        \n        r, J = residuals_and_jacobian(x, CT, PT, Na)\n        \n        try:\n            dx = np.linalg.solve(J, -r)\n        except np.linalg.LinAlgError:\n            # If singular, use least squares\n            dx = np.linalg.lstsq(J, -r, rcond=None)[0]\n\n        # Damping with backtracking line search\n        alpha = 1.0\n        # Compute maximum alpha to keep variables above bounds\n        for i in range(3):\n            if dx[i]  0:\n                # ensure x[i] + alpha*dx[i] >= lower_bounds[i]\n                denom = -dx[i]\n                if denom > 0:\n                    alpha_i = (x[i] - lower_bounds[i]) / denom\n                    alpha = min(alpha, alpha_i)\n        \n        alpha = min(alpha, 1.0) * 0.99\n\n        if alpha == 0:\n            alpha = 1e-3\n\n        # Backtracking to reduce residual norm\n        base_norm = np.linalg.norm(r)\n        for _bt in range(25):\n            x_trial = x + alpha * dx\n            x_trial = np.maximum(x_trial, lower_bounds) # Softly enforce\n            r_trial, _ = residuals_and_jacobian(x_trial, CT, PT, Na)\n            if np.linalg.norm(r_trial)  base_norm:\n                x = x_trial\n                res_norm = np.linalg.norm(r_trial)\n                break\n            alpha *= 0.5\n        else: # if loop finishes without break\n            # if no improvement, stop\n            break\n\n    x = np.maximum(x, lower_bounds)\n    return x\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (1.0, 0.01, 0.005, 0.05, 0.1),               # Case 1\n        (1.0, 0.01, 0.005, 0.0, 0.1),                # Case 2\n        (1.0, 0.01, 0.005, 0.5, 0.1),                # Case 3\n        (1.0, 1.0e-6, 0.0, 1.0e-3, 0.01),            # Case 4\n    ]\n\n    results = []\n    for (V0, CT0, PT0, Vb, Cb) in test_cases:\n        _, CT, PT, Na = mix_params(V0, CT0, PT0, Vb, Cb)\n        x_sol = newton_solve(CT, PT, Na)\n        H = x_sol[0]\n        # Compute pH\n        pH = -np.log10(H)\n        results.append(f\"{pH:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "建立并求解模型本身不是最终目的，而是将其作为理解地球化学过程的工具。本练习将从求解平衡状态转向分析模型对其参数变化的响应。通过计算游离金属浓度对络合物稳定常数的敏感性，我们可以识别出控制系统行为的关键反应，并评估简化模型假设的有效性，这是模型开发和解释中的一项关键技能 。",
            "id": "4086518",
            "problem": "考虑一个水溶液体系，其中含有一种金属物种 $M$ 和一组单齿配体 $\\{L_i\\}_{i=1}^N$，它们只形成 $1{:}1$ 的配合物 $ML_i$。假设为理想行为，因此活度等于浓度。令 $K_i$ 表示配合物 $ML_i$ 的条件形成常数，$C_{\\mathrm{M}}^{\\mathrm{T}}$ 表示 $M$ 的总分析浓度，$C_i^{\\mathrm{T}}$ 表示配体 $L_i$ 的总分析浓度。目标是通过量化自由金属活度对单个稳定常数 $K_j$ 微小扰动的局部灵敏度，来分析简化假设（例如忽略次要配合物）在何种条件下有效。从基本定律出发，利用 $ML_i$ 形成的质量作用定律以及 $M$ 和每种 $L_i$ 的质量平衡关系，推导出计算自由金属活度 $a_{\\mathrm{M}}$ 及其相对于 $K_j$ 的局部灵敏度所需的方程。您必须实现一个算法，该算法根据质量平衡和质量作用关系求解 $a_{\\mathrm{M}}$，而不依赖于快捷公式，然后使用基于这些定律的适当微分法来评估局部对数灵敏度 $S_j = \\dfrac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$。\n\n您的程序必须：\n- 将活度表示为无量纲量，并将所有 $K_i$ 视为固定条件下的无量纲条件形成常数。\n- 求解由 $M$ 的质量平衡与配合物的质量作用关系耦合所隐含的标量非线性方程，以获得 $a_{\\mathrm{M}}$。\n- 对于指定的指数 $j$，通过对控制方程进行隐式微分来计算局部对数灵敏度 $S_j = \\dfrac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$。程序不应假定任何预先推导的灵敏度公式；它必须在程序逻辑中从第一性原理推导并实现它。\n- 将每个最终灵敏度结果表示为无单位的十进制数。\n\n测试套件规范：\n给定三个测试用例，它们涵盖了不同的地球化学过程情景（类滴定终点状态、蒸发和混合）。对于每个案例，使用指定的参数计算用于平衡计算的最终总浓度，然后计算给定 $j$ 的灵敏度 $S_j$。\n\n案例 $\\mathbf{1}$ (类滴定终点状态):\n- 配体数量 $N$: $3$。\n- 金属总浓度 $C_{\\mathrm{M}}^{\\mathrm{T}}$: $10^{-6}$。\n- 配体总浓度 $(C_1^{\\mathrm{T}}, C_2^{\\mathrm{T}}, C_3^{\\mathrm{T}})$: $(5 \\times 10^{-6}, 10^{-6}, 10^{-8})$。\n- 形成常数 $(K_1, K_2, K_3)$: $(10^{6}, 10^{4}, 10^{2})$。\n- 灵敏度指数 $j$: $3$。\n\n案例 $\\mathbf{2}$ (蒸发):\n- 配体数量 $N$: $3$。\n- 初始金属总浓度 $C_{\\mathrm{M},0}^{\\mathrm{T}}$: $10^{-9}$。\n- 初始配体总浓度 $(C_{1,0}^{\\mathrm{T}}, C_{2,0}^{\\mathrm{T}}, C_{3,0}^{\\mathrm{T}})$: $(10^{-9}, 10^{-10}, 10^{-12})$。\n- 体积收缩比 $\\phi$: $0.1$ (最终体积等于初始体积乘以 $\\phi$)。\n- 通过将所有初始总浓度按 $1/\\phi$ 的比例缩放来计算最终分析总浓度。\n- 形成常数 $(K_1, K_2, K_3)$: $(10^{7}, 10^{5}, 10^{1})$。\n- 灵敏度指数 $j$: $3$。\n\n案例 $\\mathbf{3}$ (混合):\n- 配体数量 $N$: $3$。\n- 溶液 $\\mathrm{A}$ 总浓度 $(C_{\\mathrm{M},\\mathrm{A}}^{\\mathrm{T}}, C_{1,\\mathrm{A}}^{\\mathrm{T}}, C_{2,\\mathrm{A}}^{\\mathrm{T}}, C_{3,\\mathrm{A}}^{\\mathrm{T}})$: $(10^{-5}, 10^{-6}, 0, 10^{-9})$。\n- 溶液 $\\mathrm{B}$ 总浓度 $(C_{\\mathrm{M},\\mathrm{B}}^{\\mathrm{T}}, C_{1,\\mathrm{B}}^{\\mathrm{T}}, C_{2,\\mathrm{B}}^{\\mathrm{T}}, C_{3,\\mathrm{B}}^{\\mathrm{T}})$: $(10^{-7}, 0, 10^{-6}, 10^{-8})$。\n- 混合分数 $p$: $0.3$ (最终混合物是 $p$ 份溶液 $\\mathrm{A}$ 和 $(1-p)$ 份溶液 $\\mathrm{B}$)。\n- 通过 $C_{\\mathrm{M}}^{\\mathrm{T}} = p\\,C_{\\mathrm{M},\\mathrm{A}}^{\\mathrm{T}} + (1-p)\\,C_{\\mathrm{M},\\mathrm{B}}^{\\mathrm{T}}$ 计算最终分析总浓度，并对每种配体总浓度 $C_i^{\\mathrm{T}}$ 进行类似计算。\n- 形成常数 $(K_1, K_2, K_3)$: $(10^{5}, 10^{8}, 10^{2})$。\n- 灵敏度指数 $j$: $3$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，即 $[S_1,S_2,S_3]$，其中每个 $S_k$ 是为案例 $k$ 计算出的十进制灵敏度。将每个 $S_k$ 表示为无单位的十进制数。不应打印任何其他文本。",
            "solution": "该问题要求推导并实现一种方法，用于计算水溶液体系中自由金属活度及其相对于给定形成常数的局部对数灵敏度。\n\n该分析将基于化学平衡的基本原理，即质量作用定律和质量守恒原理。\n\n令 $a_{\\mathrm{M}}$ 表示自由金属 $M$ 的活度（浓度），$a_i$ 表示自由配体 $L_i$ 的活度。该体系包含 $N$ 种此类配体。我们假设理想行为，即活度等于浓度。\n\n$1{:}1$ 配合物 $ML_i$ 的形成受反应 $M + L_i \\rightleftharpoons ML_i$ 控制。该平衡的质量作用定律由条件形成常数 $K_i$ 给出：\n$$K_i = \\frac{[ML_i]}{[M] [L_i]} = \\frac{a_{ML_i}}{a_{\\mathrm{M}} a_i}$$\n其中 $a_{ML_i}$ 是配合物的活度。这可以重新排列以表示配合物浓度为：\n$$a_{ML_i} = K_i a_{\\mathrm{M}} a_i$$\n\n质量平衡方程表示总分析浓度的守恒，金属的总分析浓度记为 $C_{\\mathrm{M}}^{\\mathrm{T}}$，每种配体 $L_i$ 的总分析浓度记为 $C_i^{\\mathrm{T}}$。\n总金属浓度是自由金属和所有配合物形式的总和：\n$$C_{\\mathrm{M}}^{\\mathrm{T}} = [M] + \\sum_{i=1}^{N} [ML_i] = a_{\\mathrm{M}} + \\sum_{i=1}^{N} K_i a_{\\mathrm{M}} a_i$$\n每种配体 $L_i$ 的总浓度是其自由形式和配合物形式的总和：\n$$C_i^{\\mathrm{T}} = [L_i] + [ML_i] = a_i + K_i a_{\\mathrm{M}} a_i = a_i (1 + K_i a_{\\mathrm{M}})$$\n从配体的质量平衡中，我们可以用 $a_{\\mathrm{M}}$ 和已知的总浓度来表示自由配体活度 $a_i$：\n$$a_i = \\frac{C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}}$$\n\n为了获得自由金属活度 $a_{\\mathrm{M}}$ 的单一控制方程，我们将 $a_i$ 的表达式代入金属质量平衡方程：\n$$C_{\\mathrm{M}}^{\\mathrm{T}} = a_{\\mathrm{M}} + \\sum_{i=1}^{N} K_i a_{\\mathrm{M}} \\left( \\frac{C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right) = a_{\\mathrm{M}} \\left( 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right)$$\n这是一个关于单一未知数 $a_{\\mathrm{M}}$ 的标量非线性方程。为了数值求解它，我们定义一个残差函数 $f(a_{\\mathrm{M}})$ 并找到它的根：\n$$f(a_{\\mathrm{M}}) = a_{\\mathrm{M}} \\left( 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{1 + K_i a_{\\mathrm{M}}} \\right) - C_{\\mathrm{M}}^{\\mathrm{T}} = 0$$\n$f(a_{\\mathrm{M}}) = 0$ 的解必须位于具有物理意义的区间 $(0, C_{\\mathrm{M}}^{\\mathrm{T}}]$ 内。可以使用诸如 Brent 方法之类的数值求根算法在该区间内找到 $a_{\\mathrm{M}}$。\n\n问题的第二部分是计算局部对数灵敏度 $S_j$，其定义为：\n$$S_j = \\frac{\\partial \\ln a_{\\mathrm{M}}}{\\partial \\ln K_j}$$\n使用微分链式法则，这可以重写为：\n$$S_j = \\frac{\\partial \\ln a_{\\mathrm{M}}}{\\partial a_{\\mathrm{M}}} \\cdot \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} \\cdot \\frac{\\partial K_j}{\\partial \\ln K_j} = \\frac{1}{a_{\\mathrm{M}}} \\cdot \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} \\cdot K_j = \\frac{K_j}{a_{\\mathrm{M}}} \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j}$$\n为了求导数 $\\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j}$，我们对控制方程 $f(a_{\\mathrm{M}}, \\{K_i\\}_{i=1}^N) = 0$ 应用隐式微分。$f$ 的全微分为零：\n$$df = \\frac{\\partial f}{\\partial a_{\\mathrm{M}}} da_{\\mathrm{M}} + \\sum_{i=1}^{N} \\frac{\\partial f}{\\partial K_i} dK_i = 0$$\n考虑到仅在 $K_j$ 中有扰动，同时保持其他常数固定（即，对于 $i \\neq j$，$dK_i=0$），这简化为：\n$$\\frac{\\partial f}{\\partial a_{\\mathrm{M}}} \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} + \\frac{\\partial f}{\\partial K_j} = 0 \\implies \\frac{\\partial a_{\\mathrm{M}}}{\\partial K_j} = - \\frac{\\partial f / \\partial K_j}{\\partial f / \\partial a_{\\mathrm{M}}}$$\n我们现在必须从 $f$ 的表达式中计算这两个偏导数。\n关于 $a_{\\mathrm{M}}$ 的偏导数是：\n$$\\frac{\\partial f}{\\partial a_{\\mathrm{M}}} = \\frac{\\partial}{\\partial a_{\\mathrm{M}}} \\left[ a_{\\mathrm{M}} + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}} a_{\\mathrm{M}}}{1 + K_i a_{\\mathrm{M}}} - C_{\\mathrm{M}}^{\\mathrm{T}} \\right] = 1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}$$\n关于特定形成常数 $K_j$ 的偏导数只影响求和中的第 $j$ 项：\n$$\\frac{\\partial f}{\\partial K_j} = \\frac{\\partial}{\\partial K_j} \\left[ \\frac{K_j C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{1 + K_j a_{\\mathrm{M}}} \\right] = \\frac{C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{(1 + K_j a_{\\mathrm{M}})^2}$$\n将这些导数代回 $S_j$ 的表达式中：\n$$S_j = \\frac{K_j}{a_{\\mathrm{M}}} \\left( - \\frac{\\frac{C_j^{\\mathrm{T}} a_{\\mathrm{M}}}{(1 + K_j a_{\\mathrm{M}})^2}}{1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}} \\right)$$\n简化此表达式可得出灵敏度的最终公式：\n$$S_j = - \\frac{\\frac{K_j C_j^{\\mathrm{T}}}{(1 + K_j a_{\\mathrm{M}})^2}}{1 + \\sum_{i=1}^{N} \\frac{K_i C_i^{\\mathrm{T}}}{(1 + K_i a_{\\mathrm{M}})^2}}$$\n因此，算法如下：\n1. 对于每个测试用例，计算最终总浓度 $C_{\\mathrm{M}}^{\\mathrm{T}}$ 和 $\\{C_i^{\\mathrm{T}}\\}$。\n2. 求解非线性方程 $f(a_{\\mathrm{M}}) = 0$ 以找到平衡时的自由金属活度 $a_{\\mathrm{M}}$。\n3. 将获得的 $a_{\\mathrm{M}}$ 值以及问题参数代入推导出的 $S_j$ 表达式中，以计算指定指数 $j$ 的灵敏度。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import optimize\n\ndef solve():\n    \"\"\"\n    Computes local logarithmic sensitivities for three geochemical scenarios.\n    \"\"\"\n\n    def calculate_sensitivity_for_case(C_M_T, C_L_T, K, j_idx):\n        \"\"\"\n        Calculates the equilibrium and sensitivity for a single case.\n\n        Args:\n            C_M_T (float): Total analytical concentration of the metal.\n            C_L_T (np.ndarray): Array of total analytical concentrations of ligands.\n            K (np.ndarray): Array of conditional formation constants.\n            j_idx (int): 0-based index of the ligand for sensitivity analysis.\n\n        Returns:\n            float: The calculated logarithmic sensitivity S_j.\n        \"\"\"\n        # 1. Define the residual function f(a_M) whose root is the equilibrium\n        #    free metal activity a_M.\n        #    f(a_M) = a_M * (1 + sum(K_i * C_i_T / (1 + K_i * a_M))) - C_M_T\n        def residual_f(a_M, C_M_T_arg, C_L_T_arg, K_arg):\n            sum_term = np.sum(K_arg * C_L_T_arg / (1.0 + K_arg * a_M))\n            return a_M * (1.0 + sum_term) - C_M_T_arg\n\n        # 2. Numerically solve for a_M using Brent's method.\n        # The physically valid search interval for a_M is (0, C_M_T]. We use a small\n        # positive value as the lower bound for numerical stability.\n        try:\n            a_M = optimize.brentq(\n                residual_f,\n                1e-30,\n                C_M_T,\n                args=(C_M_T, C_L_T, K)\n            )\n        except ValueError:\n            # This can happen if the function does not cross zero at the interval ends,\n            # which for this problem implies a_M is very close to 0 or C_M_T.\n            # We can check the boundaries. If f(1e-30) is positive, a_M must be smaller.\n            # If f(C_M_T) is negative, a_M must be larger. Given the physics, this shouldn't happen.\n            # A ValueError would indicate an issue with the setup, but the cases are well-posed.\n            return np.nan\n\n        # 3. Compute the local logarithmic sensitivity S_j from the derived formula:\n        #    S_j = - (numerator_j) / (denominator)\n        #    where numerator_j = (K_j * C_j_T) / (1 + K_j * a_M)^2\n        #    and denominator = 1 + sum_i [ (K_i * C_i_T) / (1 + K_i * a_M)^2 ]\n\n        # Calculate the numerator term for the specified index j\n        numerator_j = (K[j_idx] * C_L_T[j_idx]) / (1.0 + K[j_idx] * a_M)**2\n\n        # Calculate the denominator\n        all_terms_denom = (K * C_L_T) / (1.0 + K * a_M)**2\n        denominator = 1.0 + np.sum(all_terms_denom)\n\n        # Calculate the final sensitivity\n        S_j = -numerator_j / denominator\n        \n        return S_j\n\n    # --- Test Case 1: Titration-like end state ---\n    C_M_T1 = 1e-6\n    C_L_T1 = np.array([5e-6, 1e-6, 1e-8])\n    K1 = np.array([1e6, 1e4, 1e2])\n    j1 = 3  # 1-based index from problem statement\n\n    # --- Test Case 2: Evaporation ---\n    C_M0_2 = 1e-9\n    C_L0_T2 = np.array([1e-9, 1e-10, 1e-12])\n    phi2 = 0.1\n    K2 = np.array([1e7, 1e5, 1e1])\n    j2 = 3  # 1-based index\n\n    C_M_T2 = C_M0_2 / phi2\n    C_L_T2 = C_L0_T2 / phi2\n\n    # --- Test Case 3: Mixing ---\n    C_A = {'M': 1e-5, 'L1': 1e-6, 'L2': 0.0, 'L3': 1e-9}\n    C_B = {'M': 1e-7, 'L1': 0.0, 'L2': 1e-6, 'L3': 1e-8}\n    p3 = 0.3\n    K3 = np.array([1e5, 1e8, 1e2])\n    j3 = 3  # 1-based index\n\n    C_M_T3 = p3 * C_A['M'] + (1.0 - p3) * C_B['M']\n    C_L_T3 = np.array([\n        p3 * C_A['L1'] + (1.0 - p3) * C_B['L1'],\n        p3 * C_A['L2'] + (1.0 - p3) * C_B['L2'],\n        p3 * C_A['L3'] + (1.0 - p3) * C_B['L3']\n    ])\n\n    test_cases_params = [\n        {'C_M_T': C_M_T1, 'C_L_T': C_L_T1, 'K': K1, 'j_idx': j1 - 1},\n        {'C_M_T': C_M_T2, 'C_L_T': C_L_T2, 'K': K2, 'j_idx': j2 - 1},\n        {'C_M_T': C_M_T3, 'C_L_T': C_L_T3, 'K': K3, 'j_idx': j3 - 1}\n    ]\n\n    results = []\n    for params in test_cases_params:\n        s_j = calculate_sensitivity_for_case(**params)\n        results.append(s_j)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}