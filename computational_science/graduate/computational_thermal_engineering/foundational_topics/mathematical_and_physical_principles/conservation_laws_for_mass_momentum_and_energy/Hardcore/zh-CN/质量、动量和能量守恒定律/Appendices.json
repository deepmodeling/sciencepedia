{
    "hands_on_practices": [
        {
            "introduction": "将守恒定律从其连续的积分形式转化为可在计算机上求解的离散形式，是计算流体动力学的核心任务。有限体积法（FVM）通过确保离散通量在相邻单元之间精确平衡，提供了一种天生就能保证全局守恒的强大方法。本练习将指导您推导质量守恒方程的有限体积格式，并通过编程实践来验证其关键的全局守恒特性 。",
            "id": "3944083",
            "problem": "考虑在控制体 $V$ 上，对于密度为 $\\rho$、速度为 $\\mathbf{u}$ 的流体，其质量守恒（连续性方程）的积分形式： $$\\frac{d}{dt}\\int_{V} \\rho \\, dV + \\oint_{\\partial V} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n} \\, dA = 0.$$ 使用有限体积法 (FVM)，一个通用的非结构化网格将区域划分为由索引 $i$ 标识的不重叠单元，每个单元的体积为 $|V_i|$，其边界 $\\partial V_i$ 由索引为 $f$ 的面组成。定义每个面 $f$ 的单值质量通量为 $$\\Phi_f = \\rho_f\\, (\\mathbf{u}_f\\cdot\\mathbf{n}_f)\\, A_f,$$ 其中 $\\rho_f$ 是一个面密度近似值，$\\mathbf{u}_f\\cdot\\mathbf{n}_f$ 是在面上的速度法向分量，而 $A_f$ 是面面积（在二维中为长度）。对于由相邻单元 $i$ 和 $j$ 共享的每个内部面 $f$，固定一个方向，其单位法向量 $\\mathbf{n}_f$ 从单元 $i$（左单元）指向单元 $j$（右单元）。对于单元 $i$ 的边界面 $f$，不存在相邻的右单元；不可渗透边界条件强制 $(\\mathbf{u}_f\\cdot\\mathbf{n}_f) = 0$，而周期性边界条件将成对的边界面识别为适当单元对之间的内部连接，从而使 $\\Phi_f$ 是单值的。\n\n任务 A（推导）：严格地从上述积分形式和定义出发，为通用非结构化网格上的连续性方程推导一个半离散 FVM 公式。针对每个单元 $i$，引入以定向单值面通量 $\\Phi_f$ 表示的半离散残差 $R_i$，并证明半离散常微分方程具有以下形式：$$\\frac{d}{dt}\\left(\\rho_i\\, |V_i|\\right) + R_i = 0,$$ 其中 $\\rho_i$ 是由 $\\rho_i = \\frac{1}{|V_i|}\\int_{V_i}\\rho\\, dV$ 定义的单元平均密度，且 $$R_i = \\sum_{f\\in \\partial V_i} s_{i,f}\\, \\Phi_f,$$ 其中，如果面 $f$ 的方向是从单元 $i$ 向外（即单元 $i$ 是 $f$ 的左单元），则 $s_{i,f} = +1$；如果面 $f$ 的方向是朝向单元 $i$ 向内（即单元 $i$ 是 $f$ 的右单元），则 $s_{i,f} = -1$。\n\n任务 B（全局守恒证明）：证明当所有边界面均为不可渗透或周期性时，所有单元的半离散残差 $R_i$ 之和恰好为零。你的证明必须仅依赖于单值面通量的性质和方向约定，而不假设任何专门的 $\\rho_f$ 插值格式，除了对于引用相同面 $f$ 的两个相邻单元，$\\rho_f$ 的值是相同的。\n\n任务 C（程序）：实现一个程序，为每个单元计算半离散残差，并在以下测试套件上数值验证全局守恒性质。在所有测试中，将所有量视为无量纲，这意味着输出是无单位的浮点数。\n\n测试定义：\n- 程序必须使用单值面通量 $\\Phi_f = \\rho_f\\, u_{n,f}\\, A_f$，其中 $u_{n,f}$ 表示在面 $f$ 上的法向速度分量。对于由单元 $i$ 和 $j$ 共享的内部面，使用算术平均 $\\rho_f = \\frac{1}{2}(\\rho_i + \\rho_j)$。对于边界面，使用 $\\rho_f = \\rho_i$（这个选择不影响不可渗透面，因为 $u_{n,f} = 0$），对于周期性边界，则将其视为映射的单元对之间的内部面，具有相同的单值 $\\Phi_f$。\n\n测试套件：\n- 测试 $1$（通用非结构化网格，不可渗透边界）：单元索引为 $i \\in \\{0,1,2,3,4\\}$，单元密度为 $[\\rho_0,\\rho_1,\\rho_2,\\rho_3,\\rho_4] = [1.0, 0.8, 1.3, 0.9, 1.1]$。面被指定为元组 $(\\ell, r, A_f, u_{n,f})$，其中 $\\ell$ 是左单元索引， $r$ 是右单元索引（对于边界面，$r$ 可以是 $\\text{None}$），$A_f$ 是面面积， $u_{n,f}$ 是法向速度。内部面：$(0,1,1.2,0.7)$、$(1,2,0.9,-1.1)$、$(2,3,1.5,0.3)$、$(3,4,1.1,-0.5)$、$(4,0,1.0,0.9)$、$(0,2,0.8,-0.4)$、$(1,3,1.3,0.2)$。不可渗透边界面：$(0,\\text{None},2.0,0.0)$、$(1,\\text{None},2.1,0.0)$、$(2,\\text{None},1.9,0.0)$、$(3,\\text{None},2.2,0.0)$、$(4,\\text{None},2.0,0.0)$。\n- 测试 $2$（结构化网格，左右周期性边界，上下不可渗透边界）：单元索引为 $i \\in \\{0,1,2,3\\}$，密度为 $[\\rho_0,\\rho_1,\\rho_2,\\rho_3] = [1.2, 0.7, 1.0, 0.9]$。内部面：$(0,1,1.0,0.4)$、$(2,3,1.0,-0.6)$、$(0,2,1.0,0.5)$、$(1,3,1.0,-0.3)$。视为内部面的周期性面：$(0,1,0.8,0.33)$、$(2,3,0.8,-0.21)$。不可渗透边界面（顶部和底部）：$(0,\\text{None},0.9,0.0)$、$(1,\\text{None},0.9,0.0)$、$(2,\\text{None},0.9,0.0)$、$(3,\\text{None},0.9,0.0)$。\n- 测试 $3$（所有面上的速度均为零）：使用与测试 $1$ 相同的单元和面，但将所有面（包括内部面）的 $u_{n,f}$ 设置为 $0.0$。\n\n你的程序应该使用上述定向残差定义，为每个测试计算全局总和 $\\sum_i R_i$。最终输出必须是单行，包含一个用方括号括起来的逗号分隔列表，其中依次包含测试 $1$、$2$ 和 $3$ 的三个浮点数。例如，输出格式必须完全像 $[x_1,x_2,x_3]$，其中每个 $x_k$ 是由你的程序计算出的浮点数。输出是无单位的，不需要任何单位转换。",
            "solution": "该问题具有科学依据、自成体系且提法明确。任务涉及质量守恒方程的半离散有限体积法 (FVM) 公式的标准推导、其内在守恒性质的证明以及数值验证。所有需要的数据和定义均已提供。该问题是有效的，解决方案如下所示。\n\n**任务 A：半离散 FVM 公式的推导**\n\n出发点是控制体 $V$ 中质量守恒的积分形式，流体密度为 $\\rho$，速度矢量为 $\\mathbf{u}$：\n$$ \\frac{d}{dt}\\int_{V} \\rho \\, dV + \\oint_{\\partial V} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n} \\, dA = 0 $$\n在有限体积法中，我们将此方程应用于计算网格中的每个单独单元（或控制体）$V_i$。对于单个单元 $i$，方程为：\n$$ \\frac{d}{dt}\\int_{V_i} \\rho \\, dV + \\oint_{\\partial V_i} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n}_i \\, dA = 0 $$\n其中 $\\mathbf{n}_i$ 是单元 $i$ 边界 $\\partial V_i$ 上的局部向外单位法向量。\n\n第一项表示单元 $i$ 内质量的变化率。我们引入单元平均密度 $\\rho_i$：\n$$ \\rho_i = \\frac{1}{|V_i|}\\int_{V_i}\\rho\\, dV $$\n其中 $|V_i|$ 是单元 $i$ 的体积。因此，单元中的质量为 $m_i = \\rho_i |V_i|$。时间导数项为：\n$$ \\frac{d}{dt}\\int_{V_i} \\rho \\, dV = \\frac{d}{dt} \\left(\\rho_i |V_i|\\right) $$\n问题陈述要求这种形式，它对固定网格和移动网格都具有通用性。\n\n第二项是表示流出单元 $i$ 的净质量通量的面积分。边界 $\\partial V_i$ 由一组平面组成，用索引 $f$ 标识。该积分可以离散化为对这些面的求和：\n$$ \\oint_{\\partial V_i} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n}_i \\, dA = \\sum_{f \\in \\partial V_i} \\int_{A_f} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n}_i \\, dA $$\nFVM 通过假设面上的值为常数，等于某些具有代表性的面心值 $\\rho_f$ 和 $\\mathbf{u}_f$，来近似每个面上的积分。单个面 $f$ 上的积分随后近似为：\n$$ \\int_{A_f} \\rho \\, \\mathbf{u}\\cdot\\mathbf{n}_i \\, dA \\approx \\rho_f (\\mathbf{u}_f \\cdot \\mathbf{n}_i) A_f $$\n其中 $A_f$ 是面 $f$ 的面积。\n\n问题定义了一个单值的、有向的面通量 $\\Phi_f$。对于“左”单元 $i$ 和“右”单元 $j$ 之间共享的每个内部面 $f$，定义一个固定的单位法向量 $\\mathbf{n}_f$，从 $i$ 指向 $j$。通量为 $\\Phi_f = \\rho_f\\, (\\mathbf{u}_f\\cdot\\mathbf{n}_f)\\, A_f$。我们必须将局部向外法向量 $\\mathbf{n}_i$ 与这个有向法向量 $\\mathbf{n}_f$ 关联起来。\n\n1.  如果单元 $i$ 是面 $f$ 的“左”单元，其向外法向量 $\\mathbf{n}_i$ 与面方向法向量相同，即 $\\mathbf{n}_i = \\mathbf{n}_f$。问题为此情况定义了一个符号因子 $s_{i,f} = +1$。流出单元 $i$、通过面 $f$ 的质量通量为：\n    $$ \\rho_f (\\mathbf{u}_f \\cdot \\mathbf{n}_i) A_f = \\rho_f (\\mathbf{u}_f \\cdot \\mathbf{n}_f) A_f = \\Phi_f = s_{i,f} \\Phi_f $$\n2.  如果单元 $i$ 是面 $f$ 的“右”单元（而其他某个单元 $j$ 是“左”单元），其向外法向量 $\\mathbf{n}_i$ 与面方向法向量相反，即 $\\mathbf{n}_i = -\\mathbf{n}_f$。问题为此情况定义了一个符号因子 $s_{i,f} = -1$。流出单元 $i$、通过面 $f$ 的质量通量为：\n    $$ \\rho_f (\\mathbf{u}_f \\cdot \\mathbf{n}_i) A_f = \\rho_f (\\mathbf{u}_f \\cdot (-\\mathbf{n}_f)) A_f = - \\rho_f (\\mathbf{u}_f \\cdot \\mathbf{n}_f) A_f = -\\Phi_f = s_{i,f} \\Phi_f $$\n\n在两种情况下，面 $f$ 对单元 $i$ 平衡的通量贡献都是 $s_{i,f}\\Phi_f$。对单元 $i$ 的所有面求和，总净通量为 $\\sum_{f \\in \\partial V_i} s_{i,f} \\Phi_f$。此和被定义为单元 $i$ 的半离散残差 $R_i$。\n\n将离散化的项代入单元 $i$ 的守恒定律，得到所需的半离散常微分方程：\n$$ \\frac{d}{dt}\\left(\\rho_i\\, |V_i|\\right) + R_i = 0 $$\n其中 $R_i = \\sum_{f\\in \\partial V_i} s_{i,f}\\, \\Phi_f$。至此完成推导。\n\n**任务 B：全局质量守恒证明**\n\n我们需要证明，对于仅有不可渗透或周期性边界的区域，区域中所有单元的半离散残差之和为零，即 $\\sum_i R_i = 0$。\n\n该和为：\n$$ \\sum_{i} R_i = \\sum_{i} \\left( \\sum_{f \\in \\partial V_i} s_{i,f} \\Phi_f \\right) $$\n此表达式对每个单元的面进行求和。我们可以将其重构为对网格中所有唯一面的求和。每个面对此全局和的贡献可以根据其类型进行分析。\n\n1.  **内部面**：根据方向的定义，一个内部面 $f$ 由恰好两个单元共享，即“左”单元 $i$ 和“右”单元 $j$。\n    -   它对左单元 $i$ 的残差 $R_i$ 有贡献。对于此贡献，$s_{i,f} = +1$，因此该项为 $+ \\Phi_f$。\n    -   它对右单元 $j$ 的残差 $R_j$ 有贡献。对于此贡献，$s_{j,f} = -1$，因此该项为 $- \\Phi_f$。\n    -   通量 $\\Phi_f$ 被定义为对该面是单值的。因此，该面 $f$ 对全局和 $\\sum_k R_k$ 的总贡献是其对 $R_i$ 和 $R_j$ 贡献之和：\n    $$ (+1)\\Phi_f + (-1)\\Phi_f = 0 $$\n    因此，所有内部面的贡献成对抵消，所有内部面对全局和的净贡献为零。\n\n2.  **边界面**：一个边界面 $f$ 仅属于一个单元 $i$。\n    -   **不可渗透边界**：物理条件是法向速度为零，$(\\mathbf{u}_f\\cdot\\mathbf{n}_f) = 0$。这直接导致通量为零：\n    $$ \\Phi_f = \\rho_f (\\mathbf{u}_f\\cdot\\mathbf{n}_f) A_f = 0 $$\n    该面对全局和的贡献为 $s_{i,f}\\Phi_f = 0$。\n    -   **周期性边界**：一个周期性边界面在概念上与另一个单元上的另一个周期性边界面配对，这对面被视为一个单独的内部面。也就是说，如果单元 $a$ 上的面 $f_a$ 与单元 $b$ 上的面 $f_b$ 周期性连接，这对面被视为连接单元 $a$ 和 $b$ 的一个概念性内部面 $f$。一个单元（例如，$a$）被指定为“左”，另一个（$b$）为“右”。通量 $\\Phi_f$ 对于此连接是单值的。就像一个常规内部面一样，对 $R_a$ 的贡献是 $+\\Phi_f$，对 $R_b$ 的贡献是 $-\\Phi_f$。它们的和为 $0$。\n\n由于区域边界完全是不可渗透或周期性的，所有面要么是内部的、不可渗透的，要么是周期性的。如上所示，每种类型的面对全局和 $\\sum_i R_i$ 的贡献之和均为零。因此，总质量通过该离散化是守恒的：\n$$ \\sum_i R_i = 0 $$\n至此完成证明。\n\n**任务 C：算法设计与实现**\n\n任务 C 的程序数值验证了任务 B 中证明的守恒性质。该算法直接为给定的测试用例实现了总残差和 $\\sum_i R_i$ 的计算。\n\n算法的核心如下：\n1.  对于每个测试用例，初始化一个大小与单元数相等的残差数组 $R$，所有元素设置为 $0.0$。\n2.  遍历测试用例网格数据中定义的每个面。每个面被指定为一个元组 $(\\ell, r, A_f, u_{n,f})$，其中 $\\ell$ 是左单元的索引， $r$ 是右单元的索引， $A_f$ 是面面积， $u_{n,f}$ 是法向速度分量。\n3.  对于每个面，计算单值通量 $\\Phi_f = \\rho_f u_{n,f} A_f$。面密度 $\\rho_f$ 根据问题的规则计算：\n    -   如果面是内部的（即 $r$ 不是 `None`），$\\rho_f = \\frac{1}{2}(\\rho_\\ell + \\rho_r)$，其中 $\\rho_\\ell$ 和 $\\rho_r$ 是左右单元的密度。这也适用于给定的周期性连接，它们被指定为内部面。\n    -   如果面是边界面（即 $r$ 是 `None`），$\\rho_f = \\rho_\\ell$。对于给定的不可渗透边界，这个选择无关紧要，因为 $u_{n,f}=0$。\n4.  根据方向更新相邻单元的残差。\n    -   将 $\\Phi_f$ 加到左单元的残差上：$R_\\ell \\leftarrow R_\\ell + \\Phi_f$。\n    -   如果面是内部的，从右单元的残差中减去 $\\Phi_f$：$R_r \\leftarrow R_r - \\Phi_f$。\n5.  处理完所有面后，计算残差数组中所有元素的和 $\\sum_i R_i$。这个和就是该测试用例的结果。\n\n基于任务 B 中的证明，所有测试用例都描述了封闭系统（仅有内部、不可渗透或作为内部处理的周期性面）。因此，在所有三个测试中，$\\sum_i R_i$ 的解析结果都恰好是 $0$。数值实现应该得到 $0.0$ 或一个非常接近它的值，在浮点精度的范围内。测试 $3$ 中所有速度均为零，提供了一个平凡的检验，因为所有通量 $\\Phi_f$ 都必须为零，导致所有残差 $R_i$ 及其和恒为零。下面的程序实现了这个逻辑。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by computing the sum of semi-discrete residuals for three test cases.\n    \"\"\"\n\n    # Test cases data structure:\n    # Each test case is a dictionary containing:\n    # 'densities': a list of cell densities [rho_0, rho_1, ...]\n    # 'faces': a list of face tuples (left_cell, right_cell, area, normal_velocity).\n    #          right_cell is None for boundary faces.\n    \n    test_cases_data = [\n        {\n            \"densities\": [1.0, 0.8, 1.3, 0.9, 1.1],\n            \"faces\": [\n                # Interior faces\n                (0, 1, 1.2, 0.7), \n                (1, 2, 0.9, -1.1),\n                (2, 3, 1.5, 0.3),\n                (3, 4, 1.1, -0.5),\n                (4, 0, 1.0, 0.9),\n                (0, 2, 0.8, -0.4),\n                (1, 3, 1.3, 0.2),\n                # Impermeable boundary faces\n                (0, None, 2.0, 0.0),\n                (1, None, 2.1, 0.0),\n                (2, None, 1.9, 0.0),\n                (3, None, 2.2, 0.0),\n                (4, None, 2.0, 0.0)\n            ],\n        },\n        {\n            \"densities\": [1.2, 0.7, 1.0, 0.9],\n            \"faces\": [\n                # Interior faces\n                (0, 1, 1.0, 0.4),\n                (2, 3, 1.0, -0.6),\n                (0, 2, 1.0, 0.5),\n                (1, 3, 1.0, -0.3),\n                # Periodic faces (treated as interior)\n                (0, 1, 0.8, 0.33),\n                (2, 3, 0.8, -0.21),\n                # Impermeable boundary faces\n                (0, None, 0.9, 0.0),\n                (1, None, 0.9, 0.0),\n                (2, None, 0.9, 0.0),\n                (3, None, 0.9, 0.0)\n            ],\n        },\n        {\n            # Test 3 uses Test 1 topology with zero velocities\n            \"densities\": [1.0, 0.8, 1.3, 0.9, 1.1],\n            \"faces\": [\n                (0, 1, 1.2, 0.0), \n                (1, 2, 0.9, 0.0),\n                (2, 3, 1.5, 0.0),\n                (3, 4, 1.1, 0.0),\n                (4, 0, 1.0, 0.0),\n                (0, 2, 0.8, 0.0),\n                (1, 3, 1.3, 0.0),\n                (0, None, 2.0, 0.0),\n                (1, None, 2.1, 0.0),\n                (2, None, 1.9, 0.0),\n                (3, None, 2.2, 0.0),\n                (4, None, 2.0, 0.0)\n            ],\n        },\n    ]\n\n    def compute_total_residual(densities, faces):\n        \"\"\"\n        Computes the sum of semi-discrete residuals for a given mesh configuration.\n        \"\"\"\n        num_cells = len(densities)\n        residuals = np.zeros(num_cells, dtype=np.float64)\n        \n        rho_cells = np.array(densities, dtype=np.float64)\n\n        for face in faces:\n            left_cell, right_cell, area, u_normal = face\n            \n            rho_face = 0.0\n            if right_cell is not None:\n                # Interior or periodic face\n                rho_face = 0.5 * (rho_cells[left_cell] + rho_cells[right_cell])\n            else:\n                # Boundary face\n                rho_face = rho_cells[left_cell]\n\n            # Calculate the single-valued face flux\n            flux = rho_face * u_normal * area\n            \n            # Update residuals for adjacent cells based on orientation\n            # Left cell ('i') has s_if = +1\n            residuals[left_cell] += flux\n            \n            if right_cell is not None:\n                # Right cell ('j') has s_jf = -1\n                residuals[right_cell] -= flux\n        \n        # Return the sum of all residuals, which should be zero for a closed system\n        return np.sum(residuals)\n\n    results = []\n    for case in test_cases_data:\n        total_residual = compute_total_residual(case[\"densities\"], case[\"faces\"])\n        results.append(total_residual)\n\n    # Format and print the final output as a single-line string\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在离散化计算域的内部之后，下一个关键步骤是在边界上施加物理上合理的条件。本练习介绍了一种在计算流体动力学中广泛应用的强大技术——“虚拟单元法”（ghost-cell method）——来处理边界问题。您将为绝热滑移壁推导并实现速度和温度的反射条件，从而确保在离散系统中精确满足零质量通量和零热通量等物理约束 。",
            "id": "3944112",
            "problem": "考虑一个牛顿可压缩流体，其密度为 $ \\rho $、速度矢量为 $ \\boldsymbol{u} $、温度为 $ T $、热导率为 $ k $、动力粘度为 $ \\mu $，该流体毗邻一个静止的局部平坦壁面。设壁面的单位法向量为 $ \\boldsymbol{n} $，指向流体域。假设流动在平行于壁面的切向方向上是局部均匀的，因此所有空间变化仅发生在法向方向上，并且壁面是绝热的并施加滑移边界条件。在有限体积法的虚拟单元法中，为了计算与边界一致的通量，位于距壁面距离为 $ h $ 的内部单元中心处的流体状态将被镜像反射到壁面另一侧同样距离为 $ h $ 的虚拟单元中心处。\n\n您的任务是推导速度和温度的反射条件，以确保以下所有条件在壁面处精确成立：\n- 法向质量通量为零。\n- 法向热通量为零。\n- 切向剪应力为零。\n\n仅从基本定律和定义出发，推导分解后的法向和切向速度分量以及温度的反射约束，这些约束应相对于壁面法线 $ \\boldsymbol{n} $ 进行表示。然后，将这些约束实现为一个算法，该算法在给定已知距离 $ h $ 处的内部状态和壁面法线 $ \\boldsymbol{n} $ 的情况下，生成虚拟状态，并计算在壁面处评估的三个标量值：\n- 法向质量通量 $ j_{m,n} $，单位为 $\\mathrm{kg/(m^2\\cdot s)}$。\n- 法向热通量 $ q_n $，单位为 $\\mathrm{W/m^2}$。\n- 切向剪应力的大小 $ \\tau_t $，单位为 $\\mathrm{Pa}$。\n\n使用以下对称两点公式，并将壁面置于内部和虚拟单元中心的中间：\n- 壁面法向速度 $ u_n^{w} $ 等于内部和虚拟法向速度分量的算术平均值，即 $ u_n^{w} = \\dfrac{u_n^{i} + u_n^{g}}{2} $。\n- 壁面法向温度梯度等于 $ \\dfrac{T^{g} - T^{i}}{2h} $。\n- 壁面法向的切向速度梯度等于 $ \\dfrac{\\boldsymbol{u}_{t}^{g} - \\boldsymbol{u}_{t}^{i}}{2h} $。\n\n定义矢量分解 $ u_n = \\boldsymbol{u}\\cdot\\boldsymbol{n} $ 和 $ \\boldsymbol{u}_{t} = \\boldsymbol{u} - u_n \\boldsymbol{n} $。您必须根据这些定义和基本定律来表达您的推导过程，并且您设计的算法必须能够计算虚拟状态，然后评估 $ j_{m,n} $、$ q_n $ 和 $ \\tau_t $。\n\n所有输入和输出必须采用国际单位制（SI）：\n- 速度分量，单位为 $ \\mathrm{m/s} $。\n- 温度，单位为 $ \\mathrm{K} $。\n- 密度，单位为 $ \\mathrm{kg/m^3} $。\n- 热导率，单位为 $ \\mathrm{W/(m\\cdot K)} $。\n- 动力粘度，单位为 $ \\mathrm{Pa\\cdot s} $。\n- 距离 $ h $，单位为 $ \\mathrm{m} $。\n\n测试套件：\n使用该算法处理以下四个测试用例。对于每个用例，从内部状态构建虚拟状态，然后计算三个壁面量。壁面法线 $ \\boldsymbol{n} $ 在使用前必须进行归一化。\n\n- 用例 1（一般斜向入射）：\n  - $ \\boldsymbol{n} = (0,\\,1,\\,0) $，\n  - $ \\boldsymbol{u}^{i} = (3,\\,-2,\\,1)\\,\\mathrm{m/s} $，\n  - $ T^{i} = 400\\,\\mathrm{K} $，\n  - $ \\rho^{i} = 1.2\\,\\mathrm{kg/m^3} $，\n  - $ k = 0.026\\,\\mathrm{W/(m\\cdot K)} $，\n  - $ \\mu = 1.8\\times 10^{-5}\\,\\mathrm{Pa\\cdot s} $，\n  - $ h = 0.01\\,\\mathrm{m} $。\n\n- 用例 2（任意壁面朝向）：\n  - $ \\boldsymbol{n} = (1,\\,2,\\,2) $，\n  - $ \\boldsymbol{u}^{i} = (10,\\,0,\\,-5)\\,\\mathrm{m/s} $，\n  - $ T^{i} = 300\\,\\mathrm{K} $，\n  - $ \\rho^{i} = 0.8\\,\\mathrm{kg/m^3} $，\n  - $ k = 0.5\\,\\mathrm{W/(m\\cdot K)} $，\n  - $ \\mu = 0.1\\,\\mathrm{Pa\\cdot s} $，\n  - $ h = 0.005\\,\\mathrm{m} $。\n\n- 用例 3（极小单元间距）：\n  - $ \\boldsymbol{n} = (0,\\,0,\\,1) $，\n  - $ \\boldsymbol{u}^{i} = (0.0,\\,5.0,\\,7.0)\\,\\mathrm{m/s} $，\n  - $ T^{i} = 750\\,\\mathrm{K} $，\n  - $ \\rho^{i} = 20.0\\,\\mathrm{kg/m^3} $，\n  - $ k = 15.0\\,\\mathrm{W/(m\\cdot K)} $，\n  - $ \\mu = 5.0\\,\\mathrm{Pa\\cdot s} $，\n  - $ h = 1.0\\times 10^{-9}\\,\\mathrm{m} $。\n\n- 用例 4（内部法向速度为零）：\n  - $ \\boldsymbol{n} = (0,\\,1,\\,0) $，\n  - $ \\boldsymbol{u}^{i} = (1,\\,0,\\,2)\\,\\mathrm{m/s} $，\n  - $ T^{i} = 500\\,\\mathrm{K} $，\n  - $ \\rho^{i} = 5.0\\,\\mathrm{kg/m^3} $，\n  - $ k = 2.0\\,\\mathrm{W/(m\\cdot K)} $，\n  - $ \\mu = 0.02\\,\\mathrm{Pa\\cdot s} $，\n  - $ h = 0.002\\,\\mathrm{m} $。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果本身必须是包含三个浮点数 $ [j_{m,n},\\,q_n,\\,\\tau_t] $ 的列表，单位为SI单位，并使用上述公式计算。例如，一个包含 $ N $ 个用例的输出应如下所示：$ [[a_1,b_1,c_1],[a_2,b_2,c_2],\\dots,[a_N,b_N,c_N]] $，使用此处所示的精确方括号和逗号格式。",
            "solution": "问题陈述经评估有效。其科学基础是连续介质力学原理，特别是质量、动量和能量的守恒定律。该问题是适定的，提供了所有必要的定义、物理量和数值公式，以推导出唯一且有意义的解。该问题是客观、完整的，其要求在计算流体力学中使用的理想化边界条件模型的背景下是物理上合理的。\n\n任务是推导壁面处速度和温度的反射条件，然后实现一个算法来计算壁面通量和应力。壁面是静止、绝热的，并施加滑移条件。\n\n给定一个有限体积法的虚拟单元环境，其中壁面位于内部单元中心（状态上标为$i$）和虚拟单元中心（状态上标为$g$）的中间。单元中心到壁面的距离为$h$。\n\n设 $\\boldsymbol{n}$ 是从壁面指向流体的单位法向量。速度矢量 $\\boldsymbol{u}$ 被分解为其法向分量 $u_n = \\boldsymbol{u}\\cdot\\boldsymbol{n}$ 和切向分量 $\\boldsymbol{u}_{t} = \\boldsymbol{u} - u_n \\boldsymbol{n}$。\n\n提供了以下用于计算壁面量（上标为$w$）的对称两点有限差分公式：\n- 壁面法向速度：$ u_n^{w} = \\dfrac{u_n^{i} + u_n^{g}}{2} $\n- 壁面法向温度梯度：$ \\left(\\dfrac{\\partial T}{\\partial n}\\right)\\bigg|_w = \\dfrac{T^{g} - T^{i}}{2h} $\n- 壁面法向的切向速度梯度：$ \\left(\\dfrac{\\partial \\boldsymbol{u}_{t}}{\\partial n}\\right)\\bigg|_w = \\dfrac{\\boldsymbol{u}_{t}^{g} - \\boldsymbol{u}_{t}^{i}}{2h} $\n\n我们现在根据内部单元状态（$T^i$, $u_n^i$, $\\boldsymbol{u}_t^i$）推导虚拟单元状态变量（$T^g$, $u_n^g$, $\\boldsymbol{u}_t^g$）的反射条件。\n\n**1. 法向质量通量为零**\n壁面处的法向质量通量为 $j_{m,n}^w = \\rho^w u_n^w$。条件是 $j_{m,n}^w = 0$。假设流体在壁面处的密度非零，即 $\\rho^w > 0$，此条件等效于要求壁面处的法向速度为零：\n$$ u_n^w = 0 $$\n使用为 $u_n^w$ 提供的有限差分公式：\n$$ \\dfrac{u_n^{i} + u_n^{g}}{2} = 0 $$\n求解虚拟单元的法向速度分量 $u_n^g$，得到反射条件：\n$$ u_n^{g} = -u_n^{i} $$\n该条件物理上代表一个不可穿透的壁面。\n\n**2. 法向热通量为零（绝热壁）**\n法向热通量由傅里叶热传导定律给出，$q_n = -k \\frac{\\partial T}{\\partial n}$。绝热壁条件要求壁面处的热通量为零：\n$$ q_n^w = -k^w \\left(\\dfrac{\\partial T}{\\partial n}\\right)\\bigg|_w = 0 $$\n假设壁面处的热导率 $k^w$ 非零，这意味着壁面处的法向温度梯度必须为零：\n$$ \\left(\\dfrac{\\partial T}{\\partial n}\\right)\\bigg|_w = 0 $$\n使用为梯度提供的有限差分公式：\n$$ \\dfrac{T^{g} - T^{i}}{2h} = 0 $$\n这给出了温度的反射条件：\n$$ T^{g} = T^{i} $$\n这是一个关于温度的齐次诺伊曼边界条件。\n\n**3. 切向剪应力为零（滑移壁）**\n对于仅在法向有变化的牛顿流体，壁面处的切向剪应力矢量由 $\\boldsymbol{\\tau}_{t}^w = \\mu^w \\left(\\dfrac{\\partial \\boldsymbol{u}_t}{\\partial n}\\right)\\bigg|_w$ 给出。滑移壁条件要求此应力为零：\n$$ \\boldsymbol{\\tau}_{t}^w = \\boldsymbol{0} $$\n假设壁面处的动力粘度 $\\mu^w > 0$ 非零，这意味着壁面处的切向速度的法向梯度必须为零：\n$$ \\left(\\dfrac{\\partial \\boldsymbol{u}_t}{\\partial n}\\right)\\bigg|_w = \\boldsymbol{0} $$\n使用为该梯度提供的有限差分公式：\n$$ \\dfrac{\\boldsymbol{u}_{t}^{g} - \\boldsymbol{u}_{t}^{i}}{2h} = \\boldsymbol{0} $$\n这给出了切向速度矢量的反射条件：\n$$ \\boldsymbol{u}_{t}^{g} = \\boldsymbol{u}_{t}^{i} $$\n这是一个自由滑移条件。\n\n**反射规则和虚拟状态构建总结**\n推导出的反射规则如下：\n- 温度：$T^g = T^i$\n- 法向速度：$u_n^g = -u_n^i$\n- 切向速度：$\\boldsymbol{u}_t^g = \\boldsymbol{u}_t^i$\n为了得到一个完整的状态，我们还需要密度。对于虚拟单元，一个常见的非耗散选择是反射密度：$\\rho^g = \\rho^i$。\n\n虚拟速度矢量 $\\boldsymbol{u}^g$ 可以从其分量重构：\n$$ \\boldsymbol{u}^g = \\boldsymbol{u}_t^g + u_n^g \\boldsymbol{n} = \\boldsymbol{u}_t^i - u_n^i \\boldsymbol{n} $$\n代入 $\\boldsymbol{u}_t^i = \\boldsymbol{u}^i - u_n^i \\boldsymbol{n}$：\n$$ \\boldsymbol{u}^g = (\\boldsymbol{u}^i - u_n^i \\boldsymbol{n}) - u_n^i \\boldsymbol{n} = \\boldsymbol{u}^i - 2u_n^i \\boldsymbol{n} = \\boldsymbol{u}^i - 2(\\boldsymbol{u}^i \\cdot \\boldsymbol{n})\\boldsymbol{n} $$\n\n**计算算法**\n要实现的算法如下：\n1. 对于给定的测试用例，接收内部状态 $(\\boldsymbol{u}^i, T^i, \\rho^i)$、流体属性 $(k, \\mu)$ 和几何参数 $(\\boldsymbol{n}, h)$。\n2. 归一化壁面法向量：$\\boldsymbol{n} \\leftarrow \\boldsymbol{n} / ||\\boldsymbol{n}||$。\n3. 将内部速度 $\\boldsymbol{u}^i$ 分解为法向和切向分量：$u_n^i = \\boldsymbol{u}^i \\cdot \\boldsymbol{n}$ 和 $\\boldsymbol{u}_t^i = \\boldsymbol{u}^i - u_n^i \\boldsymbol{n}$。\n4. 使用推导出的反射规则确定虚拟状态变量：$T^g = T^i$、$u_n^g = -u_n^i$ 和 $\\boldsymbol{u}_t^g = \\boldsymbol{u}_t^i$。我们也可以设置 $\\rho^g = \\rho^i$。\n5. 使用给定的数值公式和流体属性计算壁面上的三个标量值。\n    - **法向质量通量, $j_{m,n}$**：\n      设 $\\rho^w = (\\rho^i + \\rho^g)/2 = \\rho^i$。\n      $u_n^w = (u_n^i + u_n^g)/2 = (u_n^i - u_n^i)/2 = 0$。\n      $j_{m,n} = \\rho^w u_n^w = \\rho^i \\times 0 = 0$。\n    - **法向热通量, $q_n$**：\n      设 $k^w = k$。\n      $q_n = -k^w \\left(\\frac{T^g - T^i}{2h}\\right) = -k \\left(\\frac{T^i - T^i}{2h}\\right) = 0$。\n    - **切向剪应力大小, $\\tau_t$**：\n      设 $\\mu^w = \\mu$。应力矢量为 $\\boldsymbol{\\tau}_t^w = \\mu^w \\left(\\frac{\\boldsymbol{u}_t^g - \\boldsymbol{u}_t^i}{2h}\\right) = \\mu \\left(\\frac{\\boldsymbol{u}_t^i - \\boldsymbol{u}_t^i}{2h}\\right) = \\boldsymbol{0}$。\n      其大小为 $\\tau_t = ||\\boldsymbol{\\tau}_t^w|| = 0$。\n\n推导证实，如果根据这些规则构建虚拟单元状态，那么在壁面处对质量通量、热通量和切向应力的数值计算结果将精确为零，从而在离散有限差分框架内满足物理边界条件。该实现将显式执行这些计算。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of deriving and applying ghost-cell reflection conditions\n    for an adiabatic, slip wall in a compressible Newtonian fluid.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (general oblique incidence)\n        {\n            \"n\": (0.0, 1.0, 0.0), \"u_i\": (3.0, -2.0, 1.0), \"T_i\": 400.0,\n            \"rho_i\": 1.2, \"k\": 0.026, \"mu\": 1.8e-5, \"h\": 0.01\n        },\n        # Case 2 (arbitrary wall orientation)\n        {\n            \"n\": (1.0, 2.0, 2.0), \"u_i\": (10.0, 0.0, -5.0), \"T_i\": 300.0,\n            \"rho_i\": 0.8, \"k\": 0.5, \"mu\": 0.1, \"h\": 0.005\n        },\n        # Case 3 (very small cell spacing)\n        {\n            \"n\": (0.0, 0.0, 1.0), \"u_i\": (0.0, 5.0, 7.0), \"T_i\": 750.0,\n            \"rho_i\": 20.0, \"k\": 15.0, \"mu\": 5.0, \"h\": 1.0e-9\n        },\n        # Case 4 (zero interior normal velocity)\n        {\n            \"n\": (0.0, 1.0, 0.0), \"u_i\": (1.0, 0.0, 2.0), \"T_i\": 500.0,\n            \"rho_i\": 5.0, \"k\": 2.0, \"mu\": 0.02, \"h\": 0.002\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        # Extract interior state and parameters\n        n_unnormalized = np.array(case[\"n\"], dtype=float)\n        u_i = np.array(case[\"u_i\"], dtype=float)\n        T_i = float(case[\"T_i\"])\n        rho_i = float(case[\"rho_i\"])\n        k = float(case[\"k\"])\n        mu = float(case[\"mu\"])\n        h = float(case[\"h\"])\n        \n        # --- Step 1: Normalize the wall normal vector ---\n        n = n_unnormalized / np.linalg.norm(n_unnormalized)\n\n        # --- Step 2: Decompose interior velocity ---\n        # Normal component of interior velocity\n        u_n_i = np.dot(u_i, n)\n        # Tangential component of interior velocity\n        u_t_i = u_i - u_n_i * n\n\n        # --- Step 3: Determine ghost state variables from reflection rules ---\n        # Ghost temperature for adiabatic wall (zero gradient)\n        T_g = T_i\n        # Ghost normal velocity for impermeable wall (zero normal velocity)\n        u_n_g = -u_n_i\n        # Ghost tangential velocity for slip wall (zero tangential stress)\n        u_t_g = u_t_i\n        # Ghost density is typically reflected\n        rho_g = rho_i\n\n        # --- Step 4: Compute wall quantities using the provided formulas ---\n        \n        # Normal mass flux (j_m,n)\n        # Wall density is the average of interior and ghost cell densities\n        rho_w = (rho_i + rho_g) / 2.0\n        # Wall normal velocity from the symmetric formula\n        u_n_w = (u_n_i + u_n_g) / 2.0\n        j_mn_w = rho_w * u_n_w\n\n        # Normal heat flux (q_n)\n        # Wall thermal conductivity is assumed to be the given value k\n        # Wall-normal temperature gradient from the symmetric formula\n        dT_dn_w = (T_g - T_i) / (2.0 * h)\n        q_n_w = -k * dT_dn_w\n        \n        # Magnitude of tangential shear stress (tau_t)\n        # Wall viscosity is assumed to be the given value mu\n        # Wall-normal gradient of tangential velocity from the symmetric formula\n        du_tdn_w_vec = (u_t_g - u_t_i) / (2.0 * h)\n        # Tangential stress vector at the wall\n        tau_t_vec_w = mu * du_tdn_w_vec\n        # Magnitude of the tangential stress vector\n        tau_t_w = np.linalg.norm(tau_t_vec_w)\n        \n        results.append([j_mn_w, q_n_w, tau_t_w])\n\n    # Final print statement in the exact required format.\n    # The map(str, ...) is used to correctly format the list of lists.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "许多工程和科学问题涉及变形或移动的边界，例如活塞运动或流固耦合。本练习通过将有限体积法推广到时空控制体积的框架，来应对这一高级挑战。您将学习如何为移动网格推导一个完全守恒的数值格式，通过精确计算网格面运动产生的“扫掠通量”（sweep flux），确保在整个模拟过程中质量守恒达到机器精度 。",
            "id": "3944080",
            "problem": "考虑一个由相邻控制体组成的一维、时变网格，其面是移动的。设控制体 $i$ 的左右两面的位置分别为 $x_{i-\\frac{1}{2}}(t)$ 和 $x_{i+\\frac{1}{2}}(t)$，并以给定的面速度 $w_{i-\\frac{1}{2}}(t)$ 和 $w_{i+\\frac{1}{2}}(t)$ 移动。流体的密度为 $\\rho(x,t)$，欧拉速度为 $u(x,t)$，横截面积为单位1。从时空控制体上的连续性方程的积分形式出发，推导一个离散更新格式。该格式通过正确计算时间步长内移动面扫掠产生的通量，来保证在网格运动下是守恒的。在一个程序中实现所得到的更新格式，该程序使用时空控制体积分和面扫掠通量，以便在物理守恒要求净变化为零的情况下，质量能够保持到机器精度。\n\n您必须从以下基础理论出发：\n- 微分形式的连续性方程，$\\partial \\rho / \\partial t + \\nabla \\cdot (\\rho \\mathbf{u}) = 0$，并将其特化到一维空间。\n- 雷诺输运定理 (Reynolds Transport Theorem)，它将移动控制体内某个量的时间变化率与其边界上的通量联系起来。\n- 控制体质量的定义 $M_i(t) = \\int_{x_{i-\\frac{1}{2}}(t)}^{x_{i+\\frac{1}{2}}(t)} \\rho(x,t)\\, dx$。\n\n您不得引入任何超出推导守恒的面扫掠通量处理所必需的快捷公式；相反，应将离散更新与时空控制体积分和良定义的面轨迹明确联系起来。\n\n您的程序必须处理：\n- 一个包含 $N$ 个控制体和 $N+1$ 个面的一维网格。\n- 在每个测试用例的单个时间步长 $\\Delta t$ 内，给定面上恒定的面速度 $w_k$ 和欧拉速度 $u_k$。\n- 通过相对于相对速度 $(u_k - w_k)$ 进行迎风处理来选择面心密度，以确保离散化是守恒的。\n\n将在时间层 $[t^n, t^{n+1}]$ 上的面通量定义为面密度与相对平流速度乘积的时间积分，并用它来更新每个控制体中的质量。您的实现必须仅根据跨越其面的净通量来计算每个控制体的质量更新，并与时空控制体的几何形状保持一致。在 $t^n$ 时刻，每个控制体内的密度是分段常数，而面密度是根据 $(u_k - w_k)$ 的符号通过迎风格式获得的。\n\n全程使用的物理单位：\n- 长度单位为米，速度单位为米/秒，时间单位为秒，密度单位为千克/立方米，质量单位为千克。\n- 所有质量差的输出均以千克表示。\n\n测试套件：\n提供一个程序来评估以下四个独立的测试用例。在所有情况下，横截面积均为单位1。\n\n- 测试 1 (理想情况，具有均匀运动的精确拉格朗日输运)：一个控制体，初始宽度为 $1.0\\,\\mathrm{m}$，密度为 $\\rho_0 = 2.5\\,\\mathrm{kg/m^3}$。两个面的欧拉速度 $u_0 = u_1 = 1.75\\,\\mathrm{m/s}$，面速度 $w_0 = w_1 = 1.75\\,\\mathrm{m/s}$。时间步长为 $\\Delta t = 0.1\\,\\mathrm{s}$。计算每个控制体的最大绝对质量变化，并以浮点数（单位：千克）报告。\n\n- 测试 2 (几何边缘情况，具有非均匀面速度但拉格朗日对齐)：两个控制体，宽度为 $[0.3, 0.7]\\,\\mathrm{m}$，均匀密度为 $\\rho_0 = 1.0\\,\\mathrm{kg/m^3}$。三个面的欧拉速度为 $[0.2, 0.9, 1.4]\\,\\mathrm{m/s}$，面速度为 $[0.2, 0.9, 1.4]\\,\\mathrm{m/s}$。时间步长为 $\\Delta t = 0.12\\,\\mathrm{s}$。计算每个控制体的最大绝对质量变化，并以浮点数（单位：千克）报告。\n\n- 测试 3 (非拉格朗日流入/流出一致性)：两个控制体，宽度为 $[0.5, 0.5]\\,\\mathrm{m}$，初始密度为 $[3.0, 1.5]\\,\\mathrm{kg/m^3}$。三个面的欧拉速度为 $[0.6, 0.6, 0.6]\\,\\mathrm{m/s}$，面速度为 $[0.4, 0.0, -0.1]\\,\\mathrm{m/s}$。左边界的流入密度（当 $(u_0 - w_0) > 0$ 时使用）为 $3.0\\,\\mathrm{kg/m^3}$；右边界的流入密度（当 $(u_2 - w_2)  0$ 时使用）为 $2.0\\,\\mathrm{kg/m^3}$。时间步长为 $\\Delta t = 0.25\\,\\mathrm{s}$。计算通过您的守恒更新得到的区域总质量变化与解析的净边界贡献 $\\Delta t \\left[ \\rho_0^{\\mathrm{face}} (u_0 - w_0) - \\rho_2^{\\mathrm{face}} (u_2 - w_2) \\right]$ 之间的绝对差值，并以浮点数（单位：千克）报告。\n\n- 测试 4 (具有近乎瞬时运动的边界条件)：一个控制体，宽度为 $1.0\\,\\mathrm{m}$，密度为 $\\rho_0 = 1.0\\,\\mathrm{kg/m^3}$。两个面的欧拉速度 $u_0 = u_1 = 0.0\\,\\mathrm{m/s}$，面速度 $w_0 = w_1 = 10.0\\,\\mathrm{m/s}$。右边界的流入密度（当 $(u_1 - w_1)  0$ 时使用）为 $1.0\\,\\mathrm{kg/m^3}$。时间步长为 $\\Delta t = 1.0\\times 10^{-12}\\,\\mathrm{s}$。计算通过您的守恒更新得到的区域总质量变化与解析的净边界贡献之间的绝对差值，并以浮点数（单位：千克）报告。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含四个结果，格式为方括号括起来的逗号分隔列表（例如，`[r1,r2,r3,r4]`），其中每个 $r_k$ 是一个对应于测试 1 到 4 的浮点数（单位：千克）。",
            "solution": "该问题要求推导并实现一个用于移动网格上一维连续性方程的守恒数值格式。推导必须从时空控制体上的连续性方程积分形式开始，以正确地处理质量守恒。\n\n一维连续性方程的微分形式为：\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\frac{\\partial (\\rho u)}{\\partial x} = 0\n$$\n其中 $\\rho(x, t)$ 是流体密度，而 $u(x, t)$ 是流体速度。该方程可以表示为二维时空 $(x, t)$ 中的散度形式：\n$$\n\\nabla_{x,t} \\cdot \\mathbf{J} = 0\n$$\n其中时空通量矢量为 $\\mathbf{J} = (\\rho u, \\rho)$。\n\n为了获得控制体中质量的离散守恒更新，我们将此方程在一个时空控制体 $\\Omega_i$ 上积分。该体积是由空间控制体 $V_i(t) = [x_{i-\\frac{1}{2}}(t), x_{i+\\frac{1}{2}}(t)]$ 随着时间从 $t^n$ 演变到 $t^{n+1}$ 所扫掠出的区域。控制体的面以给定的速度 $w_{i-\\frac{1}{2}}(t)$ 和 $w_{i+\\frac{1}{2}}(t)$ 移动，使得 $\\frac{d}{dt}x_{k}(t) = w_{k}(t)$。\n\n对 $\\Omega_i$ 上的积分应用时空中的散度定理（或高斯定理，Divergence Theorem/Gauss's Theorem）：\n$$\n\\iint_{\\Omega_i} (\\nabla_{x,t} \\cdot \\mathbf{J}) \\,dx\\,dt = \\oint_{\\partial \\Omega_i} \\mathbf{J} \\cdot \\mathbf{n} \\,dS = 0\n$$\n其中 $\\partial \\Omega_i$ 是时空体积 $\\Omega_i$ 的边界，$\\mathbf{n}$ 是指向该边界外部的法向量。边界 $\\partial \\Omega_i$ 由四部分组成：\n1.  位于 $t=t^n$ 的底边界：空间域从 $x_{i-\\frac{1}{2}}(t^n)$ 到 $x_{i+\\frac{1}{2}}(t^n)$。外法线为 $\\mathbf{n}=(0, -1)$。积分为：\n    $$\n    \\int_{x_{i-\\frac{1}{2}}^n}^{x_{i+\\frac{1}{2}}^n} (\\rho u, \\rho) \\cdot (0, -1) \\,dx = -\\int_{x_{i-\\frac{1}{2}}^n}^{x_{i+\\frac{1}{2}}^n} \\rho(x, t^n) \\,dx = -M_i^n\n    $$\n    其中 $M_i^n$ 是在时间 $t^n$ 时控制体 $i$ 中的质量。\n\n2.  位于 $t=t^{n+1}$ 的顶边界：空间域从 $x_{i-\\frac{1}{2}}(t^{n+1})$ 到 $x_{i+\\frac{1}{2}}(t^{n+1})$。外法线为 $\\mathbf{n}=(0, 1)$。积分为：\n    $$\n    \\int_{x_{i-\\frac{1}{2}}^{n+1}}^{x_{i+\\frac{1}{2}}^{n+1}} (\\rho u, \\rho) \\cdot (0, 1) \\,dx = \\int_{x_{i-\\frac{1}{2}}^{n+1}}^{x_{i+\\frac{1}{2}}^{n+1}} \\rho(x, t^{n+1}) \\,dx = M_i^{n+1}\n    $$\n    其中 $M_i^{n+1}$ 是在时间 $t^{n+1}$ 时控制体 $i$ 中的质量。\n\n3.  左侧面边界，即路径 $x_{i-\\frac{1}{2}}(t)$，其中 $t \\in [t^n, t^{n+1}]$。此路径的切向量为 $(w_{i-\\frac{1}{2}}, 1)$。因此，指向外部（指向 $-x$ 方向）的法向量与 $(-1, w_{i-\\frac{1}{2}})$ 成比例。时空中的微分线元 $dS$ 满足 $\\mathbf{n}\\,dS = (-1, w_{i-\\frac{1}{2}})\\,dt$。穿过此边界的通量为：\n    $$\n    \\int_{t^n}^{t^{n+1}} (\\rho u, \\rho) \\cdot (-1, w_{i-\\frac{1}{2}}) \\,dt = \\int_{t^n}^{t^{n+1}} [-\\rho u + \\rho w_{i-\\frac{1}{2}}] \\,dt = -\\int_{t^n}^{t^{n+1}} \\rho(u - w_{i-\\frac{1}{2}}) \\,dt\n    $$\n    其中所有量都在面 $x_{i-\\frac{1}{2}}(t)$ 上取值。\n\n4.  右侧面边界，即路径 $x_{i+\\frac{1}{2}}(t)$，其中 $t \\in [t^n, t^{n+1}]$。切向量为 $(w_{i+\\frac{1}{2}}, 1)$。指向外部（指向 $+x$ 方向）的法向量与 $(1, -w_{i+\\frac{1}{2}})$ 成比例。因此，$\\mathbf{n}\\,dS = (1, -w_{i+\\frac{1}{2}})\\,dt$。通量为：\n    $$\n    \\int_{t^n}^{t^{n+1}} (\\rho u, \\rho) \\cdot (1, -w_{i+\\frac{1}{2}}) \\,dt = \\int_{t^n}^{t^{n+1}} [\\rho u - \\rho w_{i+\\frac{1}{2}}] \\,dt = \\int_{t^n}^{t^{n+1}} \\rho(u - w_{i+\\frac{1}{2}}) \\,dt\n    $$\n    其中量在 $x_{i+\\frac{1}{2}}(t)$ 上取值。\n\n将所有四个边界的贡献相加并设总和为零，得到精确的守恒定律：\n$$\n(M_i^{n+1} - M_i^n) + \\int_{t^n}^{t^{n+1}} \\rho_{i+\\frac{1}{2}}(u_{i+\\frac{1}{2}} - w_{i+\\frac{1}{2}}) \\,dt - \\int_{t^n}^{t^{n+1}} \\rho_{i-\\frac{1}{2}}(u_{i-\\frac{1}{2}} - w_{i-\\frac{1}{2}}) \\,dt = 0\n$$\n我们将穿过移动面 $k$ 的时间积分质量通量定义为 $\\mathcal{J}_k$：\n$$\n\\mathcal{J}_k = \\int_{t^n}^{t^{n+1}} \\rho_k (u_k - w_k) \\,dt\n$$\n守恒定律变为：\n$$\nM_i^{n+1} - M_i^n = -(\\mathcal{J}_{i+\\frac{1}{2}} - \\mathcal{J}_{i-\\frac{1}{2}})\n$$\n这是半离散的有限体积更新法则。为使其完全离散，我们需要对时间积分进行近似。使用一阶精度的矩形法则，并假设面速度 $w_k$ 和流体速度 $u_k$ 在时间步长 $\\Delta t = t^{n+1} - t^n$ 内是恒定的，积分通量为：\n$$\n\\mathcal{J}_k \\approx \\rho_k^{\\mathrm{face}} (u_k - w_k) \\Delta t\n$$\n其中 $\\rho_k^{\\mathrm{face}}$ 是在时间步长内面 $k$ 上的一个代表性密度。\n\n问题规定，$\\rho_k^{\\mathrm{face}}$ 由基于相对速度 $v_k^{\\mathrm{rel}} = u_k - w_k$ 符号的迎风格式确定。设面 $k$ 位于单元 $i-1$（其左侧）和单元 $i$（其右侧）之间。迎风密度选自相对于移动面而言流体来源的单元：\n- 如果 $v_k^{\\mathrm{rel}}  0$，流体从左向右穿过。我们使用上游单元 $i-1$ 的密度：$\\rho_k^{\\mathrm{face}} = \\rho_{i-1}^n$。\n- 如果 $v_k^{\\mathrm{rel}}  0$，流体从右向左穿过。我们使用上游单元 $i$ 的密度：$\\rho_k^{\\mathrm{face}} = \\rho_{i}^n$。\n- 如果 $v_k^{\\mathrm{rel}} = 0$，则没有质量传输，因此无论密度如何，通量都为零。\n\n在区域边界（面 $k=0$ 和面 $k=N$），迎风密度可能来自区域外部。这些是边界条件。\n- 在左边界（面 $k=0$）：如果 $v_0^{\\mathrm{rel}}  0$（流入），$\\rho_0^{\\mathrm{face}}$ 是一个给定的流入密度。如果 $v_0^{\\mathrm{rel}} \\le 0$（流出），$\\rho_0^{\\mathrm{face}} = \\rho_0^n$（第一个单元的密度）。\n- 在右边界（面 $k=N$）：如果 $v_N^{\\mathrm{rel}}  0$（流入），$\\rho_N^{\\mathrm{face}}$ 是一个给定的流入密度。如果 $v_N^{\\mathrm{rel}} \\ge 0$（流出），$\\rho_N^{\\mathrm{face}} = \\rho_{N-1}^n$（最后一个单元的密度）。\n\n单元 $i$ 中质量的完全离散更新为：\n$$\n\\Delta M_i = M_i^{n+1} - M_i^n = -\\Delta t \\left[ \\rho_{i+\\frac{1}{2}}^{\\mathrm{face}}(u_{i+\\frac{1}{2}} - w_{i+\\frac{1}{2}}) - \\rho_{i-\\frac{1}{2}}^{\\mathrm{face}}(u_{i-\\frac{1}{2}} - w_{i-\\frac{1}{2}}) \\right]\n$$\n区域内的总质量变化是各个单元变化的总和：\n$$\n\\Delta M_{\\mathrm{total}} = \\sum_{i=0}^{N-1} \\Delta M_i = \\sum_{i=0}^{N-1} -\\Delta t (F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}})\n$$\n其中 $F_k = \\rho_k^{\\mathrm{face}}(u_k - w_k)$ 是瞬时质量通量。这是一个伸缩求和：\n$$\n\\Delta M_{\\mathrm{total}} = -\\Delta t \\left[ (F_1 - F_0) + (F_2 - F_1) + \\dots + (F_N - F_{N-1}) \\right] = -\\Delta t (F_N - F_0) = \\Delta t (F_0 - F_N)\n$$\n这表明总质量变化仅取决于区域边界处的净通量，这是守恒格式的一个标志。问题中提到的“解析的净边界贡献”正是这个量，即 $\\Delta t (F_0 - F_N)$。因此，计算出的各单元质量变化之和与此解析边界贡献之间的差值应在机器精度内为零，这证实了实现的守恒性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_test_case(test_id, N, widths, rho_initial, u_faces, w_faces, dt, rho_L_inflow, rho_R_inflow):\n    \"\"\"\n    Computes the mass change in a 1D moving mesh system for a single time step.\n\n    The method implements a conservative finite volume scheme derived from\n    space-time control volume integration. Face densities are determined\n    by upwinding based on the relative velocity between the fluid and the mesh.\n    \"\"\"\n    N_faces = N + 1\n    \n    # Ensure inputs are numpy arrays for vectorized operations\n    widths = np.array(widths, dtype=float)\n    rho_initial = np.array(rho_initial, dtype=float)\n    u_faces = np.array(u_faces, dtype=float)\n    w_faces = np.array(w_faces, dtype=float)\n\n    # 1. Calculate initial mass in each control volume\n    mass_initial = rho_initial * widths\n    total_mass_initial = np.sum(mass_initial)\n\n    # 2. Calculate mass fluxes across each face\n    fluxes = np.zeros(N_faces, dtype=float)\n    v_rel = u_faces - w_faces\n\n    for k in range(N_faces):\n        rho_face = 0.0\n        \n        # Determine face density by upwinding on relative velocity v_rel = u - w\n        if v_rel[k] > 0:  # Flow is from Left to Right\n            if k == 0:  # Left boundary (inflow)\n                rho_face = rho_L_inflow\n            else:  # Internal face, upwind is cell k-1\n                rho_face = rho_initial[k - 1]\n        elif v_rel[k]  0:  # Flow is from Right to Left\n            if k == N:  # Right boundary (inflow)\n                rho_face = rho_R_inflow\n            else:  # Internal face, upwind is cell k\n                rho_face = rho_initial[k]\n        else: # v_rel[k] == 0\n            # Flux is zero, so rho_face value doesn't matter.\n            # Setting it to 0 is numerically safe.\n            rho_face = 0.0\n\n        fluxes[k] = rho_face * v_rel[k]\n\n    # 3. Calculate mass change in each control volume\n    mass_changes = np.zeros(N, dtype=float)\n    for i in range(N):\n        # Mass change is dt * (flux_in - flux_out) = -dt * (flux_right - flux_left)\n        mass_changes[i] = -dt * (fluxes[i + 1] - fluxes[i])\n\n    # 4. Compute the specific quantity required by the test case\n    if test_id in [1, 2]:\n        # For tests 1 and 2, report the maximum absolute per-control-volume mass change.\n        return np.max(np.abs(mass_changes))\n    elif test_id in [3, 4]:\n        # For tests 3 and 4, compare total numerical mass change with the\n        # analytical boundary contribution.\n        \n        # Total mass change computed by summing per-cell changes\n        numerical_total_mass_change = np.sum(mass_changes)\n        \n        # Analytical total mass change from net boundary fluxes\n        # The sum of cell changes telescopes to dt * (flux_left_boundary - flux_right_boundary)\n        analytical_total_mass_change = dt * (fluxes[0] - fluxes[N])\n        \n        # The difference should be zero for a conservative scheme.\n        return np.abs(numerical_total_mass_change - analytical_total_mass_change)\n\ndef solve():\n    \"\"\"\n    Main function to define, run, and report results for all test cases.\n    \"\"\"\n    # Test cases parameters:\n    # (test_id, N, widths, rho_initial, u_faces, w_faces, dt, rho_L_inflow, rho_R_inflow)\n    test_cases = [\n        # Test 1: Lagrangian transport, uniform motion\n        (1, 1, [1.0], [2.5], [1.75, 1.75], [1.75, 1.75], 0.1, 0.0, 0.0),\n        \n        # Test 2: Lagrangian transport, non-uniform motion\n        (2, 2, [0.3, 0.7], [1.0, 1.0], [0.2, 0.9, 1.4], [0.2, 0.9, 1.4], 0.12, 0.0, 0.0),\n\n        # Test 3: Non-Lagrangian flow with inflow/outflow\n        (3, 2, [0.5, 0.5], [3.0, 1.5], [0.6, 0.6, 0.6], [0.4, 0.0, -0.1], 0.25, 3.0, 2.0),\n\n        # Test 4: Boundary condition test with rapid motion\n        (4, 1, [1.0], [1.0], [0.0, 0.0], [10.0, 10.0], 1.0e-12, 0.0, 1.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_test_case(*case)\n        results.append(result)\n\n    # Format output as specified: a comma-separated list of floats in brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}