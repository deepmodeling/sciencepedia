{
    "hands_on_practices": [
        {
            "introduction": "要掌握快速多极子方法（FMM）的精髓，第一步是理解其计算效率的来源。这个练习将引导你通过第一性原理推导FMM核心操作的运算量，揭示该方法如何通过分层计算和避免稠密矩阵运算，从而实现近乎线性的计算复杂度。通过这个分析，你将深入理解FMM算法各个组成部分（M2M, L2L, M2L变换）对总成本的贡献 。",
            "id": "4123790",
            "problem": "考虑一个三维外部声散射问题，该问题由波数为 $k$ 的亥姆霍兹方程控制，通过边界元法（BEM）离散，并由快速多极子方法（FMM）加速。FMM 建立在一个覆盖立方计算域的均匀八叉树上，树的深度为 $L \\geq 1$。假设在每一层 $l = 1, 2, \\dots, L$，八叉树有 $8^{l}$ 个内部非空盒子。FMM 使用经典的球谐函数多极展开和局部展开，截断至角阶数 $p \\geq 1$。\n\n假设以下物理和算法上的标准条件：\n- 亥姆霍兹格林函数为 $G(\\mathbf{x}, \\mathbf{y}) = \\dfrac{\\exp(\\mathrm{i} k |\\mathbf{x} - \\mathbf{y}|)}{4 \\pi |\\mathbf{x} - \\mathbf{y}|}$。\n- 多极展开和局部展开在截断至 $p$ 阶的球谐函数基中表示。\n- 对于第 $l$ 层的每个内部盒子，其良好分离的相互作用列表（同一层中不相邻但其父节点是邻居的子节点）的基数是一个固定的常数，等于 $189$。\n- 每次多极到多极（M2M）的向上转换发生在每个子-父关系中一次，每次局部到局部（L2L）的向下转换发生在每个父-子关系中一次。\n- 采用一个成本模型，其中任何转换（M2M、M2L、L2L）的操作计数与所涉及的复球谐系数的数量成正比，并将每个系数的一次复数乘加运算计为一个操作单位。\n\n从这些假设和亥姆霍茲核的球谐展开的基本性质出发，完成以下任务：\n1. 推导每次展开保留的球谐系数数量，作为 $p$ 的函数。\n2. 估算所有层级 $l = 1, \\dots, L$ 上的多极到局部（M2L）相互作用的总数。\n3. 估算所有层级上多极到多极（M2M）转换的总数以及所有层级上局部到局部（L2L）转换的总数。\n4. 使用上述计数和成本模型，以 $p$ 和 $L$ 的单个封闭形式表达式，预测整个树上总操作数的渐近主导项。\n\n将您的最终答案表示为一个单一的符号表达式，代表以操作单位计的主导操作数。不需要四舍五入，最终表达式中也不报告物理单位。",
            "solution": "在尝试给出解答之前，首先将根据指定的标准对用户提供的问题进行验证。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n从问题陈述中逐字提取的已知条件如下：\n-   **问题域：**三维外部声散射。\n-   **控制方程：**波数为 $k$ 的亥姆霍兹方程。\n-   **数值方法：**由快速多极子方法（FMM）加速的边界元法（BEM）。\n-   **FMM 树结构：**覆盖立方计算域的均匀八叉树，深度为 $L \\geq 1$。\n-   **盒子数量：**在每一层 $l = 1, 2, \\dots, L$，八叉树有 $8^{l}$ 个内部非空盒子。\n-   **展开式：**经典的球谐函数多极展开和局部展开，截断至角阶数 $p \\geq 1$。\n-   **格林函数：**亥姆霍兹格林函数为 $G(\\mathbf{x}, \\mathbf{y}) = \\dfrac{\\exp(\\mathrm{i} k |\\mathbf{x} - \\mathbf{y}|)}{4 \\pi |\\mathbf{x} - \\mathbf{y}|}$。\n-   **基：**截断至 $p$ 阶的球谐函数基。\n-   **相互作用列表：**对于第 $l$ 层的每个内部盒子，其良好分离的相互作用列表的基数是一个固定的常数，等于 $189$。\n-   **转换规则：**\n    -   多极到多极（M2M）的向上转换发生在每个子-父关系中一次。\n    -   局部到局部（L2L）的向下转换发生在每个父-子关系中一次。\n-   **成本模型：**任何转换（M2M、M2L、L2L）的操作计数与所涉及的复球谐系数的数量成正比，并将每个系数的一次复数乘加运算计为一个操作单位。\n\n**步骤 2：使用提取的已知条件进行验证**\n-   **科学依据：**该问题坚实地植根于计算声学和快速多极子方法理论。亥姆霍兹方程、其格林函数、球谐展开、八叉树数据结构以及 M2M、M2L 和 L2L 转换的概念都是该领域的标准和基本要素。相互作用列表大小为 $189$ 的常数是在某些 FMM 实现中用于均匀网格的一个已知特定值，表示父节点为邻居的非相邻盒子的数量。\n-   **适定性：**该问题是适定的。它提供了一套清晰的假设，并要求推导操作计数，这会导出一个唯一的解析表达式。\n-   **客观性：**该问题以精确、客观和技术性的语言陈述，没有歧义或主观性陈述。\n-   **完整性与一致性：**该问题是自洽的。它提供了所有必要的参数（$L$、$p$）和常数（相互作用列表大小为 $189$，盒子数量按 $8^l$ 缩放）来进行分析。诸如均匀树且无空盒子的假设是简化的，但为算法分析的目的已明确陈述且是一致的。\n-   **现实性：**虽然完美均匀且完全填充的八叉树的假设是一种理想化情况，但它是教科书和研究论文中用于对 FMM 算法进行“最佳情况”或平均情况复杂度分析的标准模型。\n\n**步骤 3：结论与行动**\n该问题是有效的。它是快速多极子方法算法分析中的一个标准（尽管简化了）练习。将按要求提供解决方案。\n\n### 解题推导\n\n该问题要求逐步推导 FMM 加速的 BEM 代码中远场计算的主导操作数。\n\n**1. 球谐系数的数量**\n一个截断至阶数（最大度数）$p$ 的球谐展开包含所有度数 $n = 0, 1, \\dots, p$ 的球谐函数 $Y_{n}^{m}$。对于每个度数 $n$，阶数 $m$ 取 $-n$ 到 $n$ 之间的 $2n+1$ 个整数值。\n复系数的总数 $N_{\\text{coef}}$ 是每个度数直到 $p$ 的谐函数数量之和：\n$$N_{\\text{coef}}(p) = \\sum_{n=0}^{p} (2n+1)$$\n这是一个等差数列的和。我们可以这样计算它：\n$$N_{\\text{coef}}(p) = 2 \\sum_{n=0}^{p} n + \\sum_{n=0}^{p} 1 = 2 \\frac{p(p+1)}{2} + (p+1)$$\n$$N_{\\text{coef}}(p) = p(p+1) + (p+1) = (p+1)(p+1) = (p+1)^{2}$$\n所以，每个多极或局部展开都由 $(p+1)^2$ 个复系数表示。\n\n**2. 多极到局部（M2L）相互作用的总数**\nM2L 转换针对给定层级的每个盒子及其相互作用列表中的所有盒子执行。\n在任何层级 $l$（其中 $l \\in \\{1, 2, \\dots, L\\}$），有 $N_{\\text{box}}(l) = 8^l$ 个非空盒子。\n对于这 $8^l$ 个盒子中的每一个，相互作用列表的大小给定为一个常数 $N_{\\text{int}} = 189$。\n在第 $l$ 层的 M2L 转换操作数为 $N_{\\text{M2L}}(l) = N_{\\text{box}}(l) \\times N_{\\text{int}} = 8^l \\times 189$。\nM2L 相互作用的总数 $C_{\\text{M2L}}$ 是从 $l=1$ 到 $L$ 所有层级的总和：\n$$C_{\\text{M2L}} = \\sum_{l=1}^{L} N_{\\text{M2L}}(l) = \\sum_{l=1}^{L} 189 \\cdot 8^l = 189 \\sum_{l=1}^{L} 8^l$$\n这是一个等比级数求和：$\\sum_{i=1}^{n} r^i = r \\frac{r^n - 1}{r-1}$。当 $r=8$ 且 $n=L$ 时：\n$$C_{\\text{M2L}} = 189 \\left( 8 \\frac{8^L - 1}{8-1} \\right) = 189 \\left( \\frac{8}{7} (8^L - 1) \\right)$$\n因为 $189 = 27 \\times 7$，我们可以简化前置因子：\n$$C_{\\text{M2L}} = 27 \\times 7 \\times \\frac{8}{7} (8^L - 1) = 27 \\times 8 (8^L - 1) = 216(8^L - 1)$$\n\n**3. M2M 和 L2L 转换的总数**\n-   **多极到多极（M2M）转换：**这些发生在 FMM 算法的向上传递中。每个子-父对发生一次 M2M 转换。子节点是层级 $l=1, \\dots, L$ 的所有盒子。M2M 转换的总数 $C_{\\text{M2M}}$ 是树中所有子盒子的总数（不包括第 $0$ 层的根节点）。\n    $$C_{\\text{M2M}} = \\sum_{l=1}^{L} N_{\\text{box}}(l) = \\sum_{l=1}^{L} 8^l$$\n    使用相同的等比级数公式：\n    $$C_{\\text{M2M}} = \\frac{8}{7}(8^L - 1)$$\n-   **局部到局部（L2L）转换：**这些发生在向下传递中。每个父-子对发生一次 L2L 转换。逻辑与 M2M 情况相同；转换的数量是接收转换后展开的子节点总数。\n    $$C_{\\text{L2L}} = \\sum_{l=1}^{L} N_{\\text{box}}(l) = \\sum_{l=1}^{L} 8^l = \\frac{8}{7}(8^L - 1)$$\n\n**4. 总操作数的渐近主导项**\n成本模型指出，任何单个转换的操作计数等于系数的数量，即 $N_{\\text{coef}} = (p+1)^2$。\n远场部分的总操作计数 $O$ 是所有 M2M、L2L 和 M2L 转换成本的总和。\n\n-   **M2M 成本：** $O_{\\text{M2M}} = C_{\\text{M2M}} \\times N_{\\text{coef}} = \\frac{8}{7}(8^L - 1)(p+1)^2$。\n-   **L2L 成本：** $O_{\\text{L2L}} = C_{\\text{L2L}} \\times N_{\\text{coef}} = \\frac{8}{7}(8^L - 1)(p+1)^2$。\n-   **M2L 成本：** $O_{\\text{M2L}} = C_{\\text{M2L}} \\times N_{\\text{coef}} = 216(8^L - 1)(p+1)^2$。\n\n总操作计数为 $O_{\\text{total}} = O_{\\text{M2M}} + O_{\\text{L2L}} + O_{\\text{M2L}}$。\n$$O_{\\text{total}} = \\left( \\frac{8}{7} + \\frac{8}{7} + 216 \\right) (8^L - 1)(p+1)^2$$\n$$O_{\\text{total}} = \\left( \\frac{16}{7} + \\frac{1512}{7} \\right) (8^L - 1)(p+1)^2 = \\frac{1528}{7} (8^L - 1)(p+1)^2$$\n问题要求“渐近主导项”。成本的三个组成部分 $O_{\\text{M2M}}$、$O_{\\text{L2L}}$ 和 $O_{\\text{M2L}}$ 对 $L$ 和 $p$ 的依赖关系相同，即 $\\propto (8^L - 1)(p+1)^2$。因此，主导项是具有最大常数前置因子的那一个。\n-   M2M 的前置因子：$\\frac{8}{7} \\approx 1.14$\n-   L2L 的前置因子：$\\frac{8}{7} \\approx 1.14$\n-   M2L 的前置因子：$216$\n显然，$216$ 远大于 $\\frac{8}{7}$。总操作数的主导贡献来自 M2L 转换。这是 FMM 复杂度分析中的一个标准结果。\n该主导项的表达式为：\n$$O_{\\text{dominant}} = O_{\\text{M2L}} = 216(8^L - 1)(p+1)^2$$\n这是一个封闭形式的表达式，代表了在给定假设下操作成本的主导部分。",
            "answer": "$$\n\\boxed{216(8^{L} - 1)(p+1)^{2}}\n$$"
        },
        {
            "introduction": "虽然FMM在处理大规模问题时具有渐进优势，但其较高的算法开销意味着对于小规模问题，直接计算可能更有效。这个练习提供了一个实际的性能模型，用于计算FMM与直接方法之间的性能“拐点”，即FMM开始展现其速度优势的问题规模$N^{\\star}$。这对于在实际工程和科研应用中做出明智的算法选择至关重要 。",
            "id": "4123862",
            "problem": "考虑一个与亥姆霍兹方程相关的三维声学边界元法（BEM）矩阵向量乘积，其中核函数为自由空间格林函数，由 $G(\\mathbf{r}) = \\exp(i k r) / (4 \\pi r)$ 给出，其中 $r = \\|\\mathbf{r}\\|$。您希望在一个基于球谐函数的多极展开框架内，使用快速多极子方法（FMM）来加速此矩阵向量乘法。目标是确定一个临界边界元数量 $N^{\\star}$，当边界元数量达到该值时，FMM加速的矩阵向量乘积比密集的直接矩阵向量乘积更快。\n\n假设以下科学上真实且内部一致的设定：\n\n- 物理和离散化：\n  - 波数为 $k = 20 \\ \\mathrm{m}^{-1}$。\n  - 散射体近似为球形，半径为 $a = 0.5 \\ \\mathrm{m}$，因此 $k a = 10$。\n  - BEM采用一个由 $N$ 个边界元组成的网格。\n  - FMM的目标相对精度为 $10^{-3}$。\n  - 多极展开阶数由亥姆霍兹核的一个保守经验法则设定：$p = \\lceil k a + p_{0} \\rceil$，其中 $p_{0} = 4$。\n\n- 算法成本模型（浮点运算）：\n  - 对于密集的直接矩阵向量乘积，每对相互作用需要 $c_{\\mathrm{pair}} = 60$ 次浮点运算（flops），包括距离计算、$1/r$、复指数、复数缩放和累加。因此，总浮点运算次数为 $f_{\\mathrm{dense}}(N) = c_{\\mathrm{pair}} N^{2}$。\n  - 对于快速多极子方法（FMM），使用一个标准的低频亥姆霍兹球谐展开模型，其成本如下：\n    - 每个多极或局部展开包含 $(p+1)^{2}$ 个系数。\n    - 粒子到多极（P2M）和局部到粒子（L2P）的成本分别为每个边界元 $8 (p+1)^{2}$ 次浮点运算。\n    - 多极到局部（M2L）转换成本采用旋转/分解优化的实现，每次良分离盒子相互作用需要 $6 (p+1)^{3}$ 次浮点运算。\n    - 向上聚合（M2M）和向下传播（L2L）每次子贡献的成本均为 $2 (p+1)^{3}$ 次浮点运算，每个父节点有 $8$ 个子节点，因此M2M和L2L每个盒子的成本均为 $16 (p+1)^{3}$ 次浮点运算。\n    - 每个叶子盒子包含 $n_{0} = 64$ 个边界元。\n    - 每个盒子的良分离相互作用列表大小为 $L = 189$。\n    - 每个边界元的平均近场相互作用（FMM不处理的直接计算）为 $q = 40$ 对，每对的成本为密集的每对成本 $c_{\\mathrm{pair}}$。\n\n  在这些假设下，FMM的总浮点运算次数模型为\n  $$f_{\\mathrm{FMM}}(N, p) = N \\big( 8 (p+1)^{2} + 8 (p+1)^{2} + q \\, c_{\\mathrm{pair}} \\big) + \\frac{N}{n_{0}} \\big( L \\cdot 6 (p+1)^{3} + 16 (p+1)^{3} + 16 (p+1)^{3} \\big).$$\n\n- 硬件模型和算术强度：\n  - 处理器具有峰值双精度性能 $R = 2.5 \\times 10^{12}$ flops/s 和持续内存带宽 $B = 2.5 \\times 10^{11}$ bytes/s，因此 $R/B = 10$ flops/byte。\n  - 根据经验，在此BEM设置中，密集核函数计算的算术强度为 $I_{\\mathrm{dense}} \\approx 15$ flops/byte，FMM核心转换的算术强度为 $I_{\\mathrm{FMM}} \\approx 20$ flops/byte。因为 $I_{\\mathrm{dense}} > R/B$ 且 $I_{\\mathrm{FMM}} > R/B$，所以这两种方法在该硬件上都是计算密集型的，因此它们的执行时间主要由浮点运算次数决定：$T_{\\mathrm{dense}} \\approx f_{\\mathrm{dense}}(N) / R$ 和 $T_{\\mathrm{FMM}} \\approx f_{\\mathrm{FMM}}(N, p) / R$。\n\n任务：\n1. 使用以上数据，计算临界值 $N^{\\star}$，使得 $T_{\\mathrm{FMM}}(N^{\\star}) = T_{\\mathrm{dense}}(N^{\\star})$。\n2. 以无单位的边界元数量表示您的最终答案，并将答案四舍五入到三位有效数字。",
            "solution": "问题要求解的是临界边界元数量 $N^{\\star}$，在该数量下，直接矩阵向量乘积的计算时间 $T_{\\mathrm{dense}}$ 等于快速多极子方法（FMM）加速的矩阵向量乘积的计算时间 $T_{\\mathrm{FMM}}$。因此，临界条件是 $T_{\\mathrm{dense}}(N^{\\star}) = T_{\\mathrm{FMM}}(N^{\\star})$。\n\n问题提供了一个硬件模型，其中密集计算和FMM计算都是计算密集型的。这是因为它们各自的算术强度，$I_{\\mathrm{dense}} \\approx 15$ flops/byte 和 $I_{\\mathrm{FMM}} \\approx 20$ flops/byte，都大于机器的平衡点 $R/B = (2.5 \\times 10^{12}) / (2.5 \\times 10^{11}) = 10$ flops/byte。在这种情况下，执行时间 $T$ 由总浮点运算次数（flops）$f$ 和处理器峰值性能 $R$ 决定，即 $T \\approx f/R$。\n\n因此，通过代入基于浮点运算的时间模型，临界条件 $T_{\\mathrm{dense}}(N^{\\star}) = T_{\\mathrm{FMM}}(N^{\\star})$ 可以简化为：\n$$ \\frac{f_{\\mathrm{dense}}(N^{\\star})}{R} = \\frac{f_{\\mathrm{FMM}}(N^{\\star})}{R} $$\n处理器性能 $R$ 被消去，问题简化为求解使总浮点运算次数相等的 $N^{\\star}$：\n$$ f_{\\mathrm{dense}}(N^{\\star}) = f_{\\mathrm{FMM}}(N^{\\star}) $$\n\n首先，我们必须确定多极展开阶数 $p$。问题给出了经验法则 $p = \\lceil k a + p_{0} \\rceil$。使用给定值 $k = 20 \\ \\mathrm{m}^{-1}$、$a = 0.5 \\ \\mathrm{m}$ 和 $p_{0} = 4$：\n$$ k a = 20 \\times 0.5 = 10 $$\n$$ p = \\lceil 10 + 4 \\rceil = \\lceil 14 \\rceil = 14 $$\n\n接下来，我们将给定的总浮点运算次数成本模型代入我们的临界方程。\n密集矩阵向量乘积的成本由下式给出：\n$$ f_{\\mathrm{dense}}(N) = c_{\\mathrm{pair}} N^{2} $$\n其中 $c_{\\mathrm{pair}} = 60$。\n\nFMM加速乘积的成本由下式给出：\n$$ f_{\\mathrm{FMM}}(N, p) = N \\big( 8 (p+1)^{2} + 8 (p+1)^{2} + q \\, c_{\\mathrm{pair}} \\big) + \\frac{N}{n_{0}} \\big( L \\cdot 6 (p+1)^{3} + 16 (p+1)^{3} + 16 (p+1)^{3} \\big) $$\n该表达式可以简化并写为 $f_{\\mathrm{FMM}}(N, p) = C_{\\mathrm{FMM}} N$，其中 $C_{\\mathrm{FMM}}$ 是一个常数，表示FMM中每个元素的有效工作量：\n$$ C_{\\mathrm{FMM}} = 16 (p+1)^{2} + q \\, c_{\\mathrm{pair}} + \\frac{1}{n_{0}} \\left( 6L + 32 \\right) (p+1)^{3} $$\n\n临界方程变为：\n$$ c_{\\mathrm{pair}} (N^{\\star})^{2} = C_{\\mathrm{FMM}} N^{\\star} $$\n对于 $N^{\\star} > 0$ 的非平凡解，我们可以两边同除以 $N^{\\star}$：\n$$ c_{\\mathrm{pair}} N^{\\star} = C_{\\mathrm{FMM}} $$\n$$ N^{\\star} = \\frac{C_{\\mathrm{FMM}}}{c_{\\mathrm{pair}}} $$\n\n现在，我们代入给定的数值来计算 $C_{\\mathrm{FMM}}$：\n$p = 14$，所以 $p+1 = 15$。\n$c_{\\mathrm{pair}} = 60$。\n$q = 40$。\n$n_{0} = 64$。\n$L = 189$。\n\n我们来计算 $C_{\\mathrm{FMM}}$ 的各个组成部分：\n每个边界元的直接和近场相互作用成本是：\n$$ 16 (p+1)^{2} + q \\, c_{\\mathrm{pair}} = 16 (15)^{2} + 40 \\times 60 = 16 \\times 225 + 2400 = 3600 + 2400 = 6000 \\ \\text{次浮点运算} $$\n\n每个边界元的远场（FMM转换）成本是：\n$$ \\frac{1}{n_{0}} \\left( 6L + 32 \\right) (p+1)^{3} = \\frac{1}{64} \\left( 6 \\times 189 + 32 \\right) (15)^{3} $$\n$$ = \\frac{1}{64} \\left( 1134 + 32 \\right) (3375) $$\n$$ = \\frac{1}{64} \\left( 1166 \\right) (3375) $$\n$$ = \\frac{3935250}{64} = 61488.28125 \\ \\text{次浮点运算} $$\n\n每个边界元的总有效FMM成本是这些部分的总和：\n$$ C_{\\mathrm{FMM}} = 6000 + 61488.28125 = 67488.28125 $$\n\n最后，我们计算临界元素数量 $N^{\\star}$：\n$$ N^{\\star} = \\frac{C_{\\mathrm{FMM}}}{c_{\\mathrm{pair}}} = \\frac{67488.28125}{60} = 1124.8046875 $$\n\n问题要求将答案四舍五入到三位有效数字。数字 $1124.8046875$ 写成科学记数法是 $1.1248046875 \\times 10^{3}$。将尾数四舍五入到两位小数得到 $1.12$。因此，临界元素数量为：\n$$ N^{\\star} \\approx 1.12 \\times 10^{3} $$\n这对应于 $1120$ 个边界元。",
            "answer": "$$\\boxed{1.12 \\times 10^3}$$"
        }
    ]
}