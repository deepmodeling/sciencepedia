{
    "hands_on_practices": [
        {
            "introduction": "在任何显式时间积分的波动模拟中，稳定性是首要考虑的因素。自适应网格加密（AMR）通过在需要的地方使用更精细的网格来提高精度，但这种局部加密也带来了全局性的挑战。本练习将引导你从第一性原理出发，推导出一维声波方程的标准有限差分格式的Courant–Friedrichs–Lewy (CFL)稳定性极限。通过这个过程，你将深刻理解在AMR中，最精细的网格如何决定整个模拟所允许的最大时间步长，这是设计高效AMR算法时必须掌握的基本权衡。",
            "id": "4116322",
            "problem": "考虑在声速为 $c$ 的均匀介质中的一维声波传播，其由标量二阶波动方程 $\\frac{\\partial^{2} u}{\\partial t^{2}} = c^{2} \\frac{\\partial^{2} u}{\\partial x^{2}}$ 建模，其中 $u(x,t)$ 表示声压脉动。使用显式蛙跳时间积分格式和空间中心二阶有限差分，因此在间距为 $\\Delta x$、时间步长为 $\\Delta t$ 的均匀网格上，全离散格式为\n$$\nu_{j}^{n+1} - 2 u_{j}^{n} + u_{j}^{n-1} = \\left(\\frac{c \\Delta t}{\\Delta x}\\right)^{2} \\left(u_{j+1}^{n} - 2 u_{j}^{n} + u_{j-1}^{n}\\right),\n$$\n其中 $j$ 和 $n$ 为整数索引。从第一性原理出发，使用 von Neumann 平面波分析，推导该格式的 Courant–Friedrichs–Lewy (CFL) 稳定性极限，作为对 Courant 数 $\\nu$ 的约束，其中 $\\nu$ 定义为 $\\nu = \\frac{c \\Delta t}{\\Delta x}$。然后，考虑一种自适应网格加密策略，其中选择最精细的层级来以每个波长 $N_{\\mathrm{ppw}}$ 个点的分辨率解析最高相关声学频率 $f_{\\max}$。仅使用有充分依据的关于波长和频率的物理关系，用 $c$、$f_{\\max}$ 和 $N_{\\mathrm{ppw}}$ 表示最精细网格间距 $\\Delta x_{\\mathrm{fine}}$，并确定当全局时间步长受最精细网格限制时，满足 CFL 极限的最大允许全局时间步长 $\\Delta t_{\\max}$。\n\n对于 $c = 1500\\,\\mathrm{m/s}$、$f_{\\max} = 20000\\,\\mathrm{Hz}$ 和 $N_{\\mathrm{ppw}} = 12$，计算 $\\Delta t_{\\max}$ 的数值。将您的答案四舍五入到四位有效数字，并以秒为单位表示。",
            "solution": "首先对问题进行验证，以确保其具有科学依据、适定且客观。\n\n### 步骤 1：提取已知条件\n-   控制偏微分方程：$\\frac{\\partial^{2} u}{\\partial t^{2}} = c^{2} \\frac{\\partial^{2} u}{\\partial x^{2}}$\n-   离散有限差分格式：$u_{j}^{n+1} - 2 u_{j}^{n} + u_{j}^{n-1} = \\left(\\frac{c \\Delta t}{\\Delta x}\\right)^{2} \\left(u_{j+1}^{n} - 2 u_{j}^{n} + u_{j-1}^{n}\\right)$\n-   Courant 数的定义：$\\nu = \\frac{c \\Delta t}{\\Delta x}$\n-   声学介质和参数：声速 $c$，最高相关频率 $f_{\\max}$，每个波长的点数 $N_{\\mathrm{ppw}}$\n-   待求量：$\\nu$ 的 CFL 稳定性极限、最精细网格间距 $\\Delta x_{\\mathrm{fine}}$ 以及最大允许全局时间步长 $\\Delta t_{\\max}$。\n-   用于计算的数值：$c = 1500\\,\\mathrm{m/s}$，$f_{\\max} = 20000\\,\\mathrm{Hz}$，$N_{\\mathrm{ppw}} = 12$。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题基于经典的一维声学波动方程和一种标准的、广泛使用的显式时域有限差分 (FDTD) 方法（蛙跳格式）。von Neumann 稳定性分析法是分析偏微分方程数值方法的基本工具。波长、频率和波速之间的关系是波动物理学的基石。该问题完全基于物理学和数值分析的既定原理。\n-   **适定性**：问题陈述清晰，包含了推导所要求的解析表达式和计算最终数值所需的所有必要信息。各项任务按顺序且逻辑相连，导向一个唯一且有意义的解。\n-   **客观性**：问题以精确的技术语言陈述，没有歧义或主观论断。\n\n### 步骤 3：结论与行动\n该问题是有效的。我们现在将继续进行求解，求解过程包括三个部分：a) 推导 CFL 条件，b) 用物理量表示网格参数，以及 c) 计算最大时间步长。\n\n**第 1 部分：CFL 稳定性极限的推导**\n\n我们进行 von Neumann 稳定性分析。对于给定的波数 $k$，我们在离散网格 $x_j = j \\Delta x$ 上假设一个单一傅里叶模式解（平面波）。解的拟设为：\n$$\nu_j^n = G^n e^{i k x_j} = G^n e^{i k j \\Delta x}\n$$\n其中 $n$ 是时间索引，$j$ 是空间索引，$i = \\sqrt{-1}$，$G$ 是每个时间步长的放大因子。为使格式稳定，放大因子的幅值必须满足 $|G| \\le 1$。\n\n将拟设代入离散格式的左侧，得到：\n$$\nu_j^{n+1} - 2u_j^n + u_j^{n-1} = G^{n+1} e^{i k j \\Delta x} - 2G^n e^{i k j \\Delta x} + G^{n-1} e^{i k j \\Delta x} = G^n e^{i k j \\Delta x} \\left( G - 2 + \\frac{1}{G} \\right)\n$$\n代入右侧，得到：\n$$\n\\nu^2 \\left( u_{j+1}^n - 2u_j^n + u_{j-1}^n \\right) = \\nu^2 \\left( G^n e^{i k (j+1) \\Delta x} - 2G^n e^{i k j \\Delta x} + G^n e^{i k (j-1) \\Delta x} \\right)\n$$\n在右侧提取公因子 $G^n e^{i k j \\Delta x}$：\n$$\n\\nu^2 G^n e^{i k j \\Delta x} \\left( e^{i k \\Delta x} - 2 + e^{-i k \\Delta x} \\right)\n$$\n使用 Euler 公式 $e^{i\\theta} + e^{-i\\theta} = 2 \\cos(\\theta)$，上式化简为：\n$$\n\\nu^2 G^n e^{i k j \\Delta x} \\left( 2 \\cos(k \\Delta x) - 2 \\right) = -2 \\nu^2 G^n e^{i k j \\Delta x} \\left( 1 - \\cos(k \\Delta x) \\right)\n$$\n现在，使用三角恒等式 $1 - \\cos(\\theta) = 2 \\sin^2(\\theta/2)$：\n$$\n-4 \\nu^2 G^n e^{i k j \\Delta x} \\sin^2\\left(\\frac{k \\Delta x}{2}\\right)\n$$\n令变换后的左右两边相等，并除以公因子 $G^n e^{i k j \\Delta x}$（非零），我们得到一个关于 $G$ 的方程：\n$$\nG - 2 + \\frac{1}{G} = -4 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right)\n$$\n乘以 $G$ 并重新整理，得到一个关于放大因子 $G$ 的二次方程：\n$$\nG^2 - 2 \\left(1 - 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right)\\right) G + 1 = 0\n$$\n这是一个形如 $G^2 - 2\\alpha G + 1 = 0$ 的方程，其中 $\\alpha = 1 - 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right)$。其根为 $G = \\alpha \\pm \\sqrt{\\alpha^2 - 1}$。为了稳定性，我们要求 $|G| \\le 1$。如果 $|\\alpha| > 1$，则 $\\alpha^2 - 1 > 0$，根为实数。其中一个根的幅值将大于 1，导致指数增长和不稳定性。如果 $|\\alpha| \\le 1$，则 $\\alpha^2 - 1 \\le 0$，根为共轭复数 $G = \\alpha \\pm i\\sqrt{1-\\alpha^2}$。这些根的幅值为 $|G|^2 = \\alpha^2 + (1-\\alpha^2) = 1$，所以 $|G|=1$。这对应于一个稳定的、非耗散的格式。\n\n因此，稳定性条件是 $|\\alpha| \\le 1$，即：\n$$\n-1 \\le 1 - 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\le 1\n$$\n右侧不等式 $1 - 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\le 1$ 化简为 $-2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\le 0$，此式总是成立的，因为 $\\nu^2 \\ge 0$ 且正弦平方项是非负的。\n\n左侧不等式提供了稳定性约束：\n$$\n-1 \\le 1 - 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\implies 2 \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\le 2 \\implies \\nu^2 \\sin^2\\left(\\frac{k \\Delta x}{2}\\right) \\le 1\n$$\n这个条件必须对网格上可以表示的所有波数 $k$ 都成立。当自变量是 $\\pi/2$ 的奇数倍时，$\\sin^2\\left(\\frac{k \\Delta x}{2}\\right)$ 项取最大值。在间距为 $\\Delta x$ 的网格上能解析的最高频率是 Nyquist 频率，它对应于波长 $2\\Delta x$ 和波数 $k = \\pi/\\Delta x$。对于这个“最坏情况”的波数，该项变为 $\\sin^2\\left(\\frac{(\\pi/\\Delta x) \\Delta x}{2}\\right) = \\sin^2(\\pi/2) = 1$。\n\n因此，对所有模式的稳定性条件是：\n$$\n\\nu^2 \\le 1 \\implies |\\nu| \\le 1\n$$\n由于 $\\nu = \\frac{c \\Delta t}{\\Delta x}$ 是用正量定义的，CFL 稳定性极限是 $\\nu \\le 1$。\n\n**第 2 部分：自适应网格加密的网格间距**\n\n波长 $\\lambda$、频率 $f$ 和波速 $c$ 之间的关系是 $\\lambda = c/f$。为了正确解析波现象，空间网格必须足够精细，以采样感兴趣的最短波长。最短波长 $\\lambda_{\\min}$ 对应于最高频率 $f_{\\max}$：\n$$\n\\lambda_{\\min} = \\frac{c}{f_{\\max}}\n$$\n问题指定这个最短波长必须用每个波长 $N_{\\mathrm{ppw}}$ 个点来解析。这意味着一个波长 $\\lambda_{\\min}$ 必须跨越 $N_{\\mathrm{ppw}}$ 个大小为 $\\Delta x_{\\mathrm{fine}}$ 的网格单元。因此，\n$$\nN_{\\mathrm{ppw}} \\Delta x_{\\mathrm{fine}} = \\lambda_{\\min}\n$$\n求解最精细网格间距 $\\Delta x_{\\mathrm{fine}}$ 并代入 $\\lambda_{\\min}$ 的表达式：\n$$\n\\Delta x_{\\mathrm{fine}} = \\frac{\\lambda_{\\min}}{N_{\\mathrm{ppw}}} = \\frac{c}{f_{\\max} N_{\\mathrm{ppw}}}\n$$\n\n**第 3 部分：最大允许全局时间步长**\n\n在带有自适应网格加密的显式时间步进格式中，全局时间步长 $\\Delta t$ 必须足够小，以确保在域中最精细网格上的稳定性。CFL 条件必须在间距为 $\\Delta x_{\\mathrm{fine}}$ 的网格上成立：\n$$\n\\frac{c \\Delta t}{\\Delta x_{\\mathrm{fine}}} \\le 1\n$$\n当此条件处于其极限时，可以找到最大允许时间步长 $\\Delta t_{\\max}$：\n$$\n\\frac{c \\Delta t_{\\max}}{\\Delta x_{\\mathrm{fine}}} = 1 \\implies \\Delta t_{\\max} = \\frac{\\Delta x_{\\mathrm{fine}}}{c}\n$$\n代入第 2 部分中推导的 $\\Delta x_{\\mathrm{fine}}$ 的表达式：\n$$\n\\Delta t_{\\max} = \\frac{1}{c} \\left( \\frac{c}{f_{\\max} N_{\\mathrm{ppw}}} \\right) = \\frac{1}{f_{\\max} N_{\\mathrm{ppw}}}\n$$\n\n**第 4 部分：数值计算**\n\n给定 $c = 1500\\,\\mathrm{m/s}$，$f_{\\max} = 20000\\,\\mathrm{Hz}$ 和 $N_{\\mathrm{ppw}} = 12$。$\\Delta t_{\\max}$ 的最终表达式不需要 $c$ 的值，但它对于 $\\Delta x_{\\mathrm{fine}}$ 的中间推导是必需的。\n$$\n\\Delta t_{\\max} = \\frac{1}{f_{\\max} N_{\\mathrm{ppw}}} = \\frac{1}{(20000) \\times 12} = \\frac{1}{240000}\\,\\mathrm{s}\n$$\n将此转换为十进制值：\n$$\n\\Delta t_{\\max} = 0.0000041666... \\,\\mathrm{s} = 4.1666... \\times 10^{-6}\\,\\mathrm{s}\n$$\n四舍五入到四位有效数字，我们得到 $4.167 \\times 10^{-6}\\,\\mathrm{s}$。",
            "answer": "$$\n\\boxed{4.167 \\times 10^{-6}}\n$$"
        },
        {
            "introduction": "一个数值稳定的方案并不等同于一个准确的方案。波在离散网格上传播时，其速度可能会偏离真实的物理速度，这种现象被称为数值色散。本练习将通过冯·诺依曼分析，让你推导出一个标准差分格式的离散色散关系，并量化数值相速度误差。理解数值色散对于AMR至关重要，因为它揭示了为什么我们需要加密网格——即为了在关心的高频区域抑制相位误差，确保波形以正确的速度传播。",
            "id": "4116240",
            "problem": "考虑在具有恒定声速 $c$ 的均匀介质中，小振幅声扰动的一维传播，该过程由无限定义域上的线性波动方程 $u_{tt} = c^{2} u_{xx}$ 建模。假设空间网格是均匀的，间距为 $h$，时间步长是均匀的，为 $\\Delta t$。假设在自适应网格加密 (AMR) 层级的每个网格上，都使用相同的空间和时间上的显式二阶中心有限差分格式，并采用时间子循环来在不同加密级别上保持恒定的库朗数 $\\lambda = c \\Delta t / h$。\n\n以线性波动方程为基础，使用时间上的二阶中心差分近似 $u_{tt}$，使用空间上的二阶中心差分近似 $u_{xx}$，从而得到一个全离散的更新方程。通过代入平面波拟设 $u_{j}^{n} = \\Re\\{\\exp(i(k j h - \\omega n \\Delta t))\\}$（其中 $k$ 是物理波数，$\\omega$ 是角频率），进行 von Neumann 稳定性和色散分析，以推导出将无量纲时间频率 $\\Omega = \\omega \\Delta t$、无量纲空间波数 $\\theta = k h$ 和库朗数 $\\lambda$ 联系起来的离散色散关系。\n\n使用此离散色散关系，定义数值相速度 $v_{p,\\text{num}} = \\omega / k$ 和真实相速度 $v_{p,\\text{true}} = c$，并将归一化数值相速度误差 $E(k,h,\\Delta t) = v_{p,\\text{num}}/c - 1$ 确定为 $k$、$h$、$\\Delta t$ 和 $c$ 的精确解析函数。将最终答案表示为单个闭式表达式。无需四舍五入，该量为无量纲量，报告时无需单位。",
            "solution": "本题要求推导一维线性波动方程标准有限差分离散格式的归一化数值相速度误差。\n\n控制小振幅声扰动传播的偏微分方程 (PDE) 是线性波动方程：\n$$\nu_{tt} = c^{2} u_{xx}\n$$\n其中 $u(x, t)$ 是扰动，$c$ 是恒定声速，下标表示偏微分。\n\n我们在空间步长为 $h$、时间步长为 $\\Delta t$ 的均匀网格上离散化该方程。令 $u_j^n$ 表示 $u(jh, n\\Delta t)$ 的数值近似。时间和空间导数的二阶中心有限差分近似为：\n$$\nu_{tt} \\approx \\frac{u_j^{n+1} - 2u_j^n + u_j^{n-1}}{(\\Delta t)^2}\n$$\n$$\nu_{xx} \\approx \\frac{u_{j+1}^n - 2u_j^n + u_{j-1}^n}{h^2}\n$$\n将这些近似代入波动方程，得到全离散格式：\n$$\n\\frac{u_j^{n+1} - 2u_j^n + u_j^{n-1}}{(\\Delta t)^2} = c^2 \\frac{u_{j+1}^n - 2u_j^n + u_{j-1}^n}{h^2}\n$$\n这是一个显式格式。我们可以重新整理它来求解 $u_j^{n+1}$：\n$$\nu_j^{n+1} = 2u_j^n - u_j^{n-1} + \\left(\\frac{c \\Delta t}{h}\\right)^2 (u_{j+1}^n - 2u_j^n + u_{j-1}^n)\n$$\n引入库朗数 $\\lambda = \\frac{c \\Delta t}{h}$，方程简化为：\n$$\nu_j^{n+1} = 2u_j^n - u_j^{n-1} + \\lambda^2 (u_{j+1}^n - 2u_j^n + u_{j-1}^n)\n$$\n为了进行 von Neumann 稳定性和色散分析，我们将单个傅里叶模式（一个平面波拟设）代入离散方程。由于该方程是线性实系数方程，我们可以使用复数形式 $u_j^n = \\exp(i(kjh - \\omega n\\Delta t))$，其中 $k$ 是波数，$\\omega$ 是角频率。如问题陈述中所指定的，所得的色散关系对于解的实部 $\\Re\\{\\exp(i(kjh - \\omega n\\Delta t))\\}$ 也有效。\n\n离散方程中的各项变为：\n$u_j^{n\\pm 1} = \\exp(\\mp i\\omega\\Delta t) u_j^n$\n$u_{j\\pm 1}^n = \\exp(\\pm ikh) u_j^n$\n\n将这些代入格式中：\n$$\n\\exp(-i\\omega\\Delta t)u_j^n = 2u_j^n - \\exp(i\\omega\\Delta t)u_j^n + \\lambda^2 (\\exp(ikh)u_j^n - 2u_j^n + \\exp(-ikh)u_j^n)\n$$\n两边同除以非零公因子 $u_j^n$ 并整理可得：\n$$\n\\exp(-i\\omega\\Delta t) + \\exp(i\\omega\\Delta t) - 2 = \\lambda^2 (\\exp(ikh) + \\exp(-ikh) - 2)\n$$\n使用欧拉公式 $2\\cos(x) = \\exp(ix) + \\exp(-ix)$，我们可以将其写为：\n$$\n2\\cos(\\omega\\Delta t) - 2 = \\lambda^2 (2\\cos(kh) - 2)\n$$\n提出因子 $-2$ 并使用半角三角恒等式 $1 - \\cos(x) = 2\\sin^2(x/2)$，我们得到：\n$$\n-2(1 - \\cos(\\omega\\Delta t)) = -2\\lambda^2(1 - \\cos(kh))\n$$\n$$\n2\\sin^2\\left(\\frac{\\omega\\Delta t}{2}\\right) = 2\\lambda^2\\sin^2\\left(\\frac{kh}{2}\\right)\n$$\n$$\n\\sin^2\\left(\\frac{\\omega\\Delta t}{2}\\right) = \\lambda^2\\sin^2\\left(\\frac{kh}{2}\\right)\n$$\n开平方并考虑正向传播波的主支，得到离散色散关系：\n$$\n\\sin\\left(\\frac{\\omega\\Delta t}{2}\\right) = \\lambda \\sin\\left(\\frac{kh}{2}\\right)\n$$\n这个关系将数值频率 $\\omega$ 与波数 $k$ 联系起来。由此，我们可以解出 $\\omega$：\n$$\n\\frac{\\omega\\Delta t}{2} = \\arcsin\\left(\\lambda \\sin\\left(\\frac{kh}{2}\\right)\\right)\n$$\n$$\n\\omega = \\frac{2}{\\Delta t} \\arcsin\\left(\\lambda \\sin\\left(\\frac{kh}{2}\\right)\\right)\n$$\n数值相速度定义为 $v_{p,\\text{num}} = \\omega/k$。代入 $\\omega$ 的表达式：\n$$\nv_{p,\\text{num}} = \\frac{2}{k\\Delta t} \\arcsin\\left(\\lambda \\sin\\left(\\frac{kh}{2}\\right)\\right)\n$$\n问题要求的是归一化数值相速度误差 $E = \\frac{v_{p,\\text{num}}}{c} - 1$。真实相速度为 $v_{p,\\text{true}} = c$。\n$$\nE = \\frac{v_{p,\\text{num}}}{c} - 1 = \\frac{1}{c} \\left[ \\frac{2}{k\\Delta t} \\arcsin\\left(\\lambda \\sin\\left(\\frac{kh}{2}\\right)\\right) \\right] - 1\n$$\n最后，我们代入 $\\lambda = \\frac{c \\Delta t}{h}$，将误差用基本参数 $k$、$h$、$\\Delta t$ 和 $c$ 表示：\n$$\nE = \\frac{2}{ck\\Delta t} \\arcsin\\left(\\frac{c\\Delta t}{h} \\sin\\left(\\frac{kh}{2}\\right)\\right) - 1\n$$\n这就是归一化数值相速度误差的最终闭式表达式。",
            "answer": "$$\\boxed{\\frac{2}{c k \\Delta t} \\arcsin\\left(\\frac{c \\Delta t}{h} \\sin\\left(\\frac{kh}{2}\\right)\\right) - 1}$$"
        },
        {
            "introduction": "理解了稳定性的限制和对精度的需求后，接下来的关键问题是：如何智能地决定在何处加密网格？本练习提供了一个具体情境，让你设计一个静态AMR配置，以应对声速变化的介质。你将实现基于两个核心物理原则的加密准则：局部波长解析度和解的曲率，同时应用“振幅哨兵”来避免在声场可忽略的区域进行不必要的加密。这个实践将理论与应用相结合，模拟了真实AMR代码中加密决策的核心逻辑。",
            "id": "4116078",
            "problem": "给定一个具有空间变化声速的一维声学介质，要求您为声压的时谐快照计算一个自适应网格加密配置。目标是捕捉由短波长和剧烈振幅变化引起的关键小尺度效应，同时避免在其他地方过度加密。程序必须基于第一性原理为每个测试用例计算一个加密分布，并以指定的输出格式生成一个汇总摘要。\n\n物理模型是具有可变声速的一维线性声波方程，\n$$\n\\frac{\\partial^2 p}{\\partial t^2}(x,t) = c(x)^2 \\frac{\\partial^2 p}{\\partial x^2}(x,t),\n$$\n其中 $p(x,t)$ 是声压，$c(x)$ 是声速。考虑频率为 $f$（单位为 $\\mathrm{Hz}$）的时谐激励，并定义角频率 $\\omega = 2\\pi f$。对于缓慢变化的介质，局部空间波数为 $k(x) \\approx \\omega / c(x)$，局部波长为 $\\lambda(x) = c(x) / f$。\n\n我们考虑在 $t=0$ 时刻，空间分布如下的快照\n$$\np(x) = g(x) \\cos(\\phi(x)),\n$$\n其中\n$$\ng(x) = \\exp\\!\\left( -\\frac{(x-x_0)^2}{2\\sigma^2} \\right),\n\\quad\n\\phi(x) = \\omega s(x),\n\\quad\ns(x) = \\int_0^x \\frac{1}{c(\\xi)} \\,\\mathrm{d}\\xi,\n$$\n其中 $x \\in [0,L]$，$L$ 单位为 $\\mathrm{m}$，中心 $x_0$ 单位为 $\\mathrm{m}$，包络宽度参数 $\\sigma$ 单位为 $\\mathrm{m}$。介质是分段常数：\n$$\nc(x) =\n\\begin{cases}\nc_1, & 0 \\le x \\le x_s,\\\\\nc_2, & x_s < x \\le L,\n\\end{cases}\n$$\n其中 $c_1$ 和 $c_2$ 单位为 $\\mathrm{m/s}$，界面位置 $x_s$ 单位为 $\\mathrm{m}$。因此，\n$$\ns(x) =\n\\begin{cases}\n\\frac{x}{c_1}, & 0 \\le x \\le x_s,\\\\\n\\frac{x_s}{c_1} + \\frac{x-x_s}{c_2}, & x_s < x \\le L.\n\\end{cases}\n$$\n\n您必须从 $[0,L]$ 上的一个包含 $N_0$ 个单元的均匀基础网格（基础单元尺寸 $h_0 = L / N_0$）开始，构建一个静态自适应网格加密配置。每个中心为 $x_i$ 的基础单元 $i$ 可以通过二分法加密成 $2^{L_i}$ 个叶单元，其中 $L_i \\in \\{0,1,2,\\dots\\}$ 是局部加密级别。加密级别 $L_i$ 是使加密后的单元尺寸 $h_i = h_0 / 2^{L_i}$ 同时满足以下两个约束的最小级别：\n\n1. 波长分辨率约束，确保每个局部波长至少有 $M_{\\min}$ 个点：\n$$\nh_i \\le \\frac{\\lambda(x_i)}{M_{\\min}} = \\frac{c(x_i)}{f\\, M_{\\min}}.\n$$\n\n2. 基于泰勒余项的插值误差约束。对于一个尺寸为 $h$ 的单元上的二阶连续可微函数，其误差上限为一个常数乘以 $h^2$ 再乘以二阶导数的上确界。使用线性插值误差的经典界限，\n$$\nE_{\\text{lin}} \\le \\frac{h^2}{8} \\sup_{\\text{cell}} \\left| \\frac{\\mathrm{d}^2 p}{\\mathrm{d}x^2} \\right|,\n$$\n强制要求\n$$\n\\frac{h_i^2}{8} \\left| p''(x_i) \\right| \\le \\tau,\n$$\n其中 $\\tau$ 是用户指定的振幅误差容限（无量纲），从而得到曲率驱动的约束\n$$\nh_i \\le \\sqrt{\\frac{8 \\tau}{\\left| p''(x_i) \\right| + \\varepsilon}},\n$$\n其中 $\\varepsilon > 0$ 是一个小的正则化项，以避免除以零。\n\n为避免在声场可忽略的区域过度加密，应用振幅阈值保护：如果局部振幅满足 $\\left| p(x_i) \\right| < A_{\\min}$（无量纲），则无论上述约束如何，都设置 $L_i = 0$。该保护措施可防止在场值太小而无研究意义的区域进行加密。\n\n就本问题而言，在远离界面 $x_s$ 的地方，使用乘法法则处理 $p''(x)$，其中几乎处处有 $\\phi''(x)=0$（因为 $c(x)$ 是分段常数）。使用 $g'(x) = -\\frac{x-x_0}{\\sigma^2} g(x)$ 和 $g''(x) = \\left( \\frac{(x-x_0)^2}{\\sigma^4} - \\frac{1}{\\sigma^2} \\right) g(x)$，并记 $a(x) = \\cos(\\phi(x))$ 和 $b(x) = \\sin(\\phi(x))$，可得\n$$\np''(x) = g''(x)\\, a(x) \\;-\\; 2 g'(x)\\, \\phi'(x)\\, b(x) \\;-\\; g(x)\\, \\left( \\phi'(x) \\right)^2 a(x),\n$$\n其中 $\\phi'(x) = \\omega / c(x)$ 且当 $x \\ne x_s$ 时 $\\phi''(x)=0$。\n\n为每个测试用例定义以下汇总输出：\n- 叶单元总数，\n$$\nN_{\\text{leaf}} = \\sum_{i=0}^{N_0-1} 2^{L_i},\n$$\n- 使用的最大加密级别，\n$$\nL_{\\max} = \\max_i L_i,\n$$\n- 无振幅阈值保护时的假设过度加密比率，计算为在 $\\left| p(x_i) \\right| < A_{\\min}$ 的区域中，如果不应用振幅阈值保护，将被加密的叶单元所占的比例，\n$$\nR_{\\text{waste}} = \\frac{\\sum_{i: \\left| p(x_i) \\right| < A_{\\min}} 2^{\\widetilde{L}_i}}{\\sum_{i=0}^{N_0-1} 2^{\\widetilde{L}_i}},\n$$\n其中 $\\widetilde{L}_i$ 是在忽略振幅阈值保护的情况下，通过相同约束获得的加密级别。\n\n所有物理量必须使用以下单位：\n- 域长度 $L$ 单位为 $\\mathrm{m}$。\n- 声速 $c_1$ 和 $c_2$ 单位为 $\\mathrm{m/s}$。\n- 频率 $f$ 单位为 $\\mathrm{Hz}$。\n- 振幅容限 $\\tau$ 无量纲。\n- 振幅阈值 $A_{\\min}$ 无量纲。\n- 包络宽度参数 $\\sigma$ 和位置 $x$、$x_0$、$x_s$ 单位为 $\\mathrm{m}$。\n\n角度使用弧度。不应使用百分号；比率必须表示为小数。\n\n对所有测试用例使用以下固定的域和基础网格：\n- 域 $[0,L]$，其中 $L = 1$。\n- 基础单元数 $N_0 = 64$，因此 $h_0 = L / N_0$。\n- 声速值 $c_1 = 1500$，$c_2 = 1800$，界面位于 $x_s = 0.6$。\n\n您的程序必须为下面指定的四个测试用例计算自适应加密配置。对于每个用例，使用给定的参数和上述规则计算 $N_{\\text{leaf}}$、$L_{\\max}$ 和 $R_{\\text{waste}}$。\n\n测试套件（每个元组为 $(f, \\sigma, M_{\\min}, A_{\\min}, \\tau, x_0)$）：\n1. $(8000, 0.03, 12, 0.05, 0.005, 0.30)$\n2. $(20000, 0.02, 16, 0.01, 0.003, 0.40)$\n3. $(1500, 0.08, 10, 0.05, 0.008, 0.25)$\n4. $(12000, 0.025, 14, 0.02, 0.004, 0.58)$\n\n最终输出格式必须是包含四个结果列表的单行，每个结果本身是按 $[N_{\\text{leaf}}, L_{\\max}, R_{\\text{waste}}]$ 顺序排列的列表。例如，输出必须如下所示\n$$\n[ [N_1, L_{\\max,1}, R_1], [N_2, L_{\\max,2}, R_2], [N_3, L_{\\max,3}, R_3], [N_4, L_{\\max,4}, R_4] ].\n$$",
            "solution": "该问题要求为一维声波传播场景设计一个静态自适应网格加密（AMR）配置。目标是基于确保解析局部波长和高解曲率区域的标准，为域上的一组基础单元确定局部加密级别，同时避免在波幅可忽略不计的地方进行不必要的加密。\n\n物理模型是在声速 $c(x)$ 空间变化的介质中的线性声波方程：\n$$\n\\frac{\\partial^2 p}{\\partial t^2}(x,t) = c(x)^2 \\frac{\\partial^2 p}{\\partial x^2}(x,t)\n$$\n我们分析在 $t=0$ 时刻的声压场 $p(x)$ 的时谐快照，其表达式为：\n$$\np(x) = g(x) \\cos(\\phi(x))\n$$\n其中 $g(x)$ 是一个高斯包络，$\\phi(x)$ 是空间相位。各分量定义如下：\n- 包络：$g(x) = \\exp\\!\\left( -\\frac{(x-x_0)^2}{2\\sigma^2} \\right)$\n- 相位：$\\phi(x) = \\omega s(x) = 2\\pi f s(x)$，其中 $s(x)$ 是从原点开始的声学传播时间。\n\n域为 $x \\in [0, L]$，其中 $L=1 \\, \\mathrm{m}$。声速 $c(x)$ 是分段常数：\n$$\nc(x) =\n\\begin{cases}\nc_1 = 1500 \\, \\mathrm{m/s}, & 0 \\le x \\le x_s = 0.6 \\, \\mathrm{m} \\\\\nc_2 = 1800 \\, \\mathrm{m/s}, & 0.6 \\, \\mathrm{m} < x \\le 1 \\, \\mathrm{m}\n\\end{cases}\n$$\n这导致传播时间函数为：\n$$\ns(x) = \\int_0^x \\frac{1}{c(\\xi)} \\,\\mathrm{d}\\xi =\n\\begin{cases}\n\\frac{x}{c_1}, & 0 \\le x \\le x_s \\\\\n\\frac{x_s}{c_1} + \\frac{x-x_s}{c_2}, & x_s < x \\le L\n\\end{cases}\n$$\n计算域 $[0, L]$ 最初被离散化为一个包含 $N_0 = 64$ 个单元的均匀基础网格。基础单元的尺寸为 $h_0 = L / N_0 = 1/64 \\, \\mathrm{m}$。加密准则在每个基础单元 $i$ 的中心进行评估，其位置为 $x_i = (i + 0.5)h_0$，其中 $i = 0, 1, \\dots, N_0-1$。\n\n对于每个基础单元 $i$，我们确定一个加密级别 $L_i \\in \\{0, 1, 2, \\dots\\}$，这对应于将该单元细分为 $2^{L_i}$ 个尺寸为 $h_i = h_0 / 2^{L_i}$ 的更小的叶单元。级别 $L_i$ 是满足一组条件的最小非负整数。该过程首先确定没有振幅阈值保护时所需的级别，记为 $\\widetilde{L}_i$，然后应用保护措施得到最终级别 $L_i$。\n\n首先，我们根据两个物理和数值约束计算单元 $i$ 所需的单元尺寸 $h_{i, \\text{req}}$：\n\n1.  **波长分辨率约束**：为了准确表示波的振荡特性，局部单元尺寸 $h_i$ 必须是局部波长 $\\lambda(x_i) = c(x_i)/f$ 的一小部分。该约束确保每个波长至少有 $M_{\\min}$ 个网格点：\n    $$\n    h_i \\le h_{i, \\text{wave}} = \\frac{\\lambda(x_i)}{M_{\\min}} = \\frac{c(x_i)}{f M_{\\min}}\n    $$\n\n2.  **插值误差约束**：为了限制在单元内近似解（例如，使用线性基函数）所产生的误差，必须在曲率高的区域控制单元尺寸。该约束基于泰勒级数余项，它将误差与解的二阶导数 $p''(x_i)$ 联系起来。\n    $$\n    h_i \\le h_{i, \\text{curv}} = \\sqrt{\\frac{8 \\tau}{|p''(x_i)| + \\varepsilon}}\n    $$\n    这里，$\\tau$ 是一个指定的容限，$\\varepsilon$ 是一个小的正常数（例如，$\\varepsilon=10^{-12}$）以防止在曲率为零处出现除零错误。当 $x \\neq x_s$ 时，二阶导数 $p''(x)$ 使用乘法法则计算：\n    $$\n    p''(x) = g''(x) \\cos(\\phi(x)) - 2g'(x)\\phi'(x) \\sin(\\phi(x)) - g(x) (\\phi'(x))^2 \\cos(\\phi(x))\n    $$\n    其中 $\\phi'(x) = \\omega/c(x)$，$g'(x) = -\\frac{x-x_0}{\\sigma^2}g(x)$，以及 $g''(x) = \\left(\\frac{(x-x_0)^2}{\\sigma^4} - \\frac{1}{\\sigma^2}\\right)g(x)$。\n\n这两个约束中最严格的一个决定了单元 $i$ 所需的单元尺寸：\n$$\nh_{i, \\text{req}} = \\min(h_{i, \\text{wave}}, h_{i, \\text{curv}})\n$$\n由此，加密级别 $\\widetilde{L}_i$（无振幅阈值保护）是使 $h_0 / 2^{\\widetilde{L}_i} \\le h_{i, \\text{req}}$ 成立的最小整数。其计算方式为：\n$$\n\\widetilde{L}_i = \\max\\left(0, \\left\\lceil \\log_2\\left(\\frac{h_0}{h_{i, \\text{req}}}\\right)\\right\\rceil\\right)\n$$\n其中，向上取整函数 $\\lceil \\cdot \\rceil$ 确保不等式得到满足，而 max 函数确保级别为非负。\n\n接下来，应用**振幅阈值保护**。此规则可防止在解的振幅可忽略不计的区域进行加密，从而节省计算资源。\n$$\n\\text{如果 } |p(x_i)| < A_{\\min}, \\text{ 则 } L_i = 0. \\text{ 否则, } L_i = \\widetilde{L}_i.\n$$\n这个两步过程为每个基础单元生成最终的加密级别 $L_i$。\n\n最后，对于每个测试用例，我们从所有级别集合 $\\{L_i\\}$ 和 $\\{\\widetilde{L}_i\\}$ 中计算出三个汇总指标：\n-   **叶单元总数（$N_{\\text{leaf}}$）**：最终自适应网格中的单元总数。\n    $$\n    N_{\\text{leaf}} = \\sum_{i=0}^{N_0-1} 2^{L_i}\n    $$\n-   **最大加密级别（$L_{\\max}$）**：在域中任何地方使用的最深加密级别。\n    $$\n    L_{\\max} = \\max_{i} L_i\n    $$\n-   **过度加密比率（$R_{\\text{waste}}$）**：（在无保护的网格中）位于振幅低于阈值 $A_{\\min}$ 区域的单元总数所占的比例。这量化了由振幅阈值保护带来的效率提升。\n    $$\n    R_{\\text{waste}} = \\frac{\\sum_{i: |p(x_i)| < A_{\\min}} 2^{\\widetilde{L}_i}}{\\sum_{j=0}^{N_0-1} 2^{\\widetilde{L}_j}}\n    $$\n\n计算过程包括遍历四个测试用例，设置相应参数，为所有 $N_0=64$ 个基础单元评估上述量，然后计算最终的汇总指标。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes adaptive mesh refinement configurations for a 1D acoustic wave problem.\n    \"\"\"\n    \n    # Fixed domain and base mesh parameters\n    L = 1.0  # Domain length in m\n    N0 = 64  # Number of base cells\n    h0 = L / N0  # Base cell size in m\n    c1 = 1500.0  # Sound speed in first medium in m/s\n    c2 = 1800.0  # Sound speed in second medium in m/s\n    xs = 0.6  # Interface location in m\n    epsilon = 1e-12  # Regularization for curvature constraint\n\n    # Base cell centers\n    x = (np.arange(N0) + 0.5) * h0\n\n    # Test suite: (f, sigma, M_min, A_min, tau, x0)\n    test_cases = [\n        (8000.0, 0.03, 12, 0.05, 0.005, 0.30),\n        (20000.0, 0.02, 16, 0.01, 0.003, 0.40),\n        (1500.0, 0.08, 10, 0.05, 0.008, 0.25),\n        (12000.0, 0.025, 14, 0.02, 0.004, 0.58),\n    ]\n\n    results = []\n    \n    # Vectorized helper functions based on the problem description\n    def get_c(x_vals):\n        return np.where(x_vals = xs, c1, c2)\n\n    def get_s(x_vals):\n        return np.where(x_vals = xs, x_vals / c1, xs / c1 + (x_vals - xs) / c2)\n\n    for case in test_cases:\n        f, sigma, M_min, A_min, tau, x0 = case\n        \n        omega = 2.0 * np.pi * f\n        \n        # Calculate physical quantities at all cell centers\n        c_vals = get_c(x)\n        s_vals = get_s(x)\n                \n        # Wave profile\n        phi_vals = omega * s_vals\n        g_vals = np.exp(-((x - x0)**2) / (2.0 * sigma**2))\n        p_vals = g_vals * np.cos(phi_vals)\n        \n        # Second derivative p''(x)\n        g_prime_vals = -((x - x0) / sigma**2) * g_vals\n        g_prime_prime_vals = (((x - x0)**2 / sigma**4) - (1.0 / sigma**2)) * g_vals\n        phi_prime_vals = omega / c_vals\n        \n        cos_phi = np.cos(phi_vals)\n        sin_phi = np.sin(phi_vals)\n        \n        p_prime_prime_vals = (g_prime_prime_vals * cos_phi \n                              - 2.0 * g_prime_vals * phi_prime_vals * sin_phi \n                              - g_vals * phi_prime_vals**2 * cos_phi)\n\n        # 1. Wavelength resolution constraint\n        lambda_vals = c_vals / f\n        h_wave = lambda_vals / M_min\n        \n        # 2. Interpolation error (curvature) constraint\n        h_curv = np.sqrt(8.0 * tau / (np.abs(p_prime_prime_vals) + epsilon))\n        \n        # Required cell size (most restrictive)\n        h_req = np.minimum(h_wave, h_curv)\n        \n        # Refinement level without amplitude guard\n        # Use np.maximum with 1.0 to avoid log2 of numbers  1 giving negative results\n        ratio = h0 / h_req\n        tilde_L = np.ceil(np.log2(np.maximum(1.0, ratio))).astype(int)\n\n        # Apply amplitude guard\n        L = np.where(np.abs(p_vals)  A_min, 0, tilde_L)\n        \n        # Calculate aggregate metrics\n        N_leaf = int(np.sum(2**L))\n        L_max = int(np.max(L) if L.size > 0 else 0)\n        \n        # Calculate waste ratio\n        tilde_leaf_cells = 2**tilde_L\n        total_tilde_cells = np.sum(tilde_leaf_cells)\n        \n        waste_mask = np.abs(p_vals)  A_min\n        wasted_cells = np.sum(tilde_leaf_cells[waste_mask])\n        \n        R_waste = wasted_cells / total_tilde_cells if total_tilde_cells > 0 else 0.0\n\n        results.append([N_leaf, L_max, round(R_waste, 8)])\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}