{
    "hands_on_practices": [
        {
            "introduction": "一个优秀的数值格式不仅应具备数值上的精确性，还应能忠实地再现关键的物理现象。本练习将引导你通过“纸和笔”的方式，运用平面波分析法来检验交错网格格式的物理保真度。你将推导出离散平面波在刚性边界上的反射系数，并发现该格式能完美地模拟这一物理过程，这正是交错网格的一大优势。",
            "id": "4138263",
            "problem": "考虑在均匀、无损耗流体中的一维线性声学问题，该流体的质量密度为 $\\rho$，体积模量为 $K$，因此声速为 $c = \\sqrt{K/\\rho}$。控制方程是线性化的动量方程和连续性方程：\n$$\n\\frac{\\partial u}{\\partial t} = -\\frac{1}{\\rho}\\frac{\\partial p}{\\partial x}, \\qquad \\frac{\\partial p}{\\partial t} = -K \\frac{\\partial u}{\\partial x},\n$$\n其中 $u(x,t)$ 是质点速度（法向分量），$p(x,t)$ 是声压。\n\n在半空间 $x \\ge 0$ 上，使用标准的交错网格显式蛙跳时域有限差分 (FDTD) 格式，空间步长为 $\\Delta x$，时间步长为 $\\Delta t$。在该格式中，速度配置在整数空间索引和半整数时间索引处，声压配置在半整数空间索引和整数时间索引处：\n$$\nu_m^{n+1/2} = u_m^{n-1/2} - \\frac{\\Delta t}{\\rho \\Delta x}\\left( p_{m+1/2}^{n} - p_{m-1/2}^{n} \\right),\n$$\n$$\np_{m+1/2}^{n+1} = p_{m+1/2}^{n} - \\frac{K \\Delta t}{\\Delta x}\\left( u_{m+1}^{n+1/2} - u_m^{n+1/2} \\right),\n$$\n对于整数 $m \\ge 0$。通过对所有 $n$ 强制施加精确的运动学条件 $u_0^{n+1/2} = 0$，在 $x=0$ 处施加一个刚性壁边界。\n\n一个时谐正入射离散平面波从内部（$x>0$）入射到刚性壁上，产生一个反射波。假设一个单色稳态，其离散场是满足内部离散色散关系的入射和反射行波分量的叠加。设总场表示为\n$$\nu_m^{n+1/2} = U_{\\mathrm{i}} \\exp\\!\\left( i \\left( m k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right) + U_{\\mathrm{r}} \\exp\\!\\left( i \\left( - m k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right),\n$$\n$$\np_{m+1/2}^{n} = P_{\\mathrm{i}} \\exp\\!\\left( i \\left( (m+1/2) k \\Delta x - n \\omega \\Delta t \\right) \\right) + P_{\\mathrm{r}} \\exp\\!\\left( i \\left( - (m+1/2) k \\Delta x - n \\omega \\Delta t \\right) \\right),\n$$\n其中 $k$ 和 $\\omega$ 满足该格式的离散色散关系，$U_{\\mathrm{i}},U_{\\mathrm{r}},P_{\\mathrm{i}},P_{\\mathrm{r}}$ 是入射波和反射波的复振幅。\n\n将声压反射系数 $R$ 定义为在域内第一个声压平面（即 $x = \\Delta x/2$）处参考的复振幅比 $R = P_{\\mathrm{r}}/P_{\\mathrm{i}}$。从控制方程和给定的离散化出发，通过强制施加离散边界条件和内部更新关系来推导 $R$，不使用任何快捷公式。计算 $R$ 并将其与正入射刚性壁的连续解析值 $R = 1$ 进行比较。将 $R$ 的最终答案表示为一个无量纲复数。无需四舍五入。",
            "solution": "该问题要求在交错网格时域有限差分 (FDTD) 格式中，推导离散平面波入射到刚性壁边界上的声压反射系数 $R$。推导必须从给定的离散控制方程和边界条件出发。\n\nFDTD 控制方程为：\n$$\nu_m^{n+1/2} = u_m^{n-1/2} - \\frac{\\Delta t}{\\rho \\Delta x}\\left( p_{m+1/2}^{n} - p_{m-1/2}^{n} \\right) \\label{eq:1} \\tag{1}\n$$\n$$\np_{m+1/2}^{n+1} = p_{m+1/2}^{n} - \\frac{K \\Delta t}{\\Delta x}\\left( u_{m+1}^{n+1/2} - u_m^{n+1/2} \\right) \\label{eq:2} \\tag{2}\n$$\n\n假设的总场的离散平面波解为：\n$$\nu_m^{n+1/2} = U_{\\mathrm{i}} \\exp\\!\\left( i \\left( m k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right) + U_{\\mathrm{r}} \\exp\\!\\left( i \\left( - m k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right) \\label{eq:3} \\tag{3}\n$$\n$$\np_{m+1/2}^{n} = P_{\\mathrm{i}} \\exp\\!\\left( i \\left( (m+1/2) k \\Delta x - n \\omega \\Delta t \\right) \\right) + P_{\\mathrm{r}} \\exp\\!\\left( i \\left( - (m+1/2) k \\Delta x - n \\omega \\Delta t \\right) \\right) \\label{eq:4} \\tag{4}\n$$\n\n刚性壁边界条件施加在 $x=0$ 处，对应于空间索引 $m=0$。该条件为对所有时间索引 $n$，有 $u_0^{n+1/2} = 0$。\n\n步骤 1：应用边界条件。\n我们将 $m=0$ 代入总速度场的表达式，即方程 (\\ref{eq:3})：\n$$\nu_0^{n+1/2} = U_{\\mathrm{i}} \\exp\\!\\left( i \\left( 0 \\cdot k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right) + U_{\\mathrm{r}} \\exp\\!\\left( i \\left( - 0 \\cdot k \\Delta x - (n+1/2)\\omega \\Delta t \\right) \\right)\n$$\n$$\nu_0^{n+1/2} = \\left( U_{\\mathrm{i}} + U_{\\mathrm{r}} \\right) \\exp\\!\\left( -i (n+1/2)\\omega \\Delta t \\right)\n$$\n对所有 $n$ 强制施加边界条件 $u_0^{n+1/2} = 0$ 要求振幅因子为零：\n$$\nU_{\\mathrm{i}} + U_{\\mathrm{r}} = 0 \\implies U_{\\mathrm{r}} = -U_{\\mathrm{i}} \\label{eq:5} \\tag{5}\n$$\n这个方程关联了入射和反射速度波的复振幅。\n\n步骤 2：推导数值阻抗。\n每个波分量的声压和速度振幅之间的关系，可以通过将平面波解代入其中一个 FDTD 更新方程来找到。我们使用速度更新方程，即方程 (\\ref{eq:1})。首先，我们将其重写为：\n$$\n\\frac{u_m^{n+1/2} - u_m^{n-1/2}}{\\Delta t} = -\\frac{1}{\\rho}\\frac{p_{m+1/2}^{n} - p_{m-1/2}^{n}}{\\Delta x}\n$$\n左侧（LHS）变为：\n$$\n\\text{LHS} = \\frac{1}{\\Delta t} \\left[ U_{\\mathrm{i}} e^{imk\\Delta x} + U_{\\mathrm{r}} e^{-imk\\Delta x} \\right] \\left( e^{-i(n+1/2)\\omega\\Delta t} - e^{-i(n-1/2)\\omega\\Delta t} \\right)\n$$\n$$\n= \\frac{1}{\\Delta t} \\left[ U_{\\mathrm{i}} e^{imk\\Delta x} + U_{\\mathrm{r}} e^{-imk\\Delta x} \\right] e^{-in\\omega\\Delta t} \\left( e^{-i\\omega\\Delta t/2} - e^{i\\omega\\Delta t/2} \\right)\n$$\n$$\n= \\frac{-2i \\sin(\\omega\\Delta t/2)}{\\Delta t} \\left[ U_{\\mathrm{i}} e^{imk\\Delta x} + U_{\\mathrm{r}} e^{-imk\\Delta x} \\right] e^{-in\\omega\\Delta t}\n$$\n右侧（RHS）变为：\n$$\n\\text{RHS} = -\\frac{1}{\\rho \\Delta x} \\left[ \\left(P_{\\mathrm{i}} e^{i(m+1/2)k\\Delta x} + P_{\\mathrm{r}} e^{-i(m+1/2)k\\Delta x}\\right) - \\left(P_{\\mathrm{i}} e^{i(m-1/2)k\\Delta x} + P_{\\mathrm{r}} e^{-i(m-1/2)k\\Delta x}\\right) \\right] e^{-in\\omega\\Delta t}\n$$\n对入射波（i）和反射波（r）的项进行分组：\n$$\n= -\\frac{e^{-in\\omega\\Delta t}}{\\rho \\Delta x} \\left[ P_{\\mathrm{i}} e^{imk\\Delta x} (e^{ik\\Delta x/2} - e^{-ik\\Delta x/2}) + P_{\\mathrm{r}} e^{-imk\\Delta x} (e^{-ik\\Delta x/2} - e^{ik\\Delta x/2}) \\right]\n$$\n$$\n= -\\frac{e^{-in\\omega\\Delta t}}{\\rho \\Delta x} \\left[ P_{\\mathrm{i}} e^{imk\\Delta x} (2i \\sin(k\\Delta x/2)) - P_{\\mathrm{r}} e^{-imk\\Delta x} (2i \\sin(k\\Delta x/2)) \\right]\n$$\n$$\n= -\\frac{2i \\sin(k\\Delta x/2)}{\\rho \\Delta x} \\left[ P_{\\mathrm{i}} e^{imk\\Delta x} - P_{\\mathrm{r}} e^{-imk\\Delta x} \\right] e^{-in\\omega\\Delta t}\n$$\n令 LHS 和 RHS 相等，并消去公因子 $-2i e^{-in\\omega\\Delta t}$：\n$$\n\\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} \\left[ U_{\\mathrm{i}} e^{imk\\Delta x} + U_{\\mathrm{r}} e^{-imk\\Delta x} \\right] = \\frac{\\sin(k\\Delta x/2)}{\\rho \\Delta x} \\left[ P_{\\mathrm{i}} e^{imk\\Delta x} - P_{\\mathrm{r}} e^{-imk\\Delta x} \\right]\n$$\n由于此式必须对任何内部整数 $m$ 都成立，我们可以令线性无关基函数 $e^{imk\\Delta x}$ 和 $e^{-imk\\Delta x}$ 的系数相等。\n对于入射波分量（$e^{imk\\Delta x}$ 的系数）：\n$$\n\\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} U_{\\mathrm{i}} = \\frac{\\sin(k\\Delta x/2)}{\\rho \\Delta x} P_{\\mathrm{i}}\n$$\n这给出了入射波的数值特性阻抗 $Z_{\\mathrm{N}}$：\n$$\n\\frac{P_{\\mathrm{i}}}{U_{\\mathrm{i}}} = \\frac{\\rho \\Delta x}{\\Delta t} \\frac{\\sin(\\omega\\Delta t/2)}{\\sin(k\\Delta x/2)} \\equiv Z_{\\mathrm{N}} \\label{eq:6} \\tag{6}\n$$\n对于反射波分量（$e^{-imk\\Delta x}$ 的系数）：\n$$\n\\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} U_{\\mathrm{r}} = -\\frac{\\sin(k\\Delta x/2)}{\\rho \\Delta x} P_{\\mathrm{r}}\n$$\n这给出了反射波的阻抗：\n$$\n\\frac{P_{\\mathrm{r}}}{U_{\\mathrm{r}}} = -\\frac{\\rho \\Delta x}{\\Delta t} \\frac{\\sin(\\omega\\Delta t/2)}{\\sin(k\\Delta x/2)} = -Z_{\\mathrm{N}} \\label{eq:7} \\tag{7}\n$$\n\n步骤 3：计算反射系数。\n问题将声压反射系数定义为 $R = P_{\\mathrm{r}}/P_{\\mathrm{i}}$。我们可以使用上面推导出的关系来求这个比值。由方程 (\\ref{eq:6}) 和方程 (\\ref{eq:7})，我们有：\n$$\nP_{\\mathrm{i}} = Z_{\\mathrm{N}} U_{\\mathrm{i}}\n$$\n$$\nP_{\\mathrm{r}} = -Z_{\\mathrm{N}} U_{\\mathrm{r}}\n$$\n求比值得：\n$$\nR = \\frac{P_{\\mathrm{r}}}{P_{\\mathrm{i}}} = \\frac{-Z_{\\mathrm{N}} U_{\\mathrm{r}}}{Z_{\\mathrm{N}} U_{\\mathrm{i}}} = -\\frac{U_{\\mathrm{r}}}{U_{\\mathrm{i}}}\n$$\n现在，使用边界条件得到的结果，即方程 (\\ref{eq:5})，$U_{\\mathrm{r}} = -U_{\\mathrm{i}}$：\n$$\nR = -\\frac{(-U_{\\mathrm{i}})}{U_{\\mathrm{i}}} = 1\n$$\n声压反射系数恰好为 $1$。\n\n与连续解析值的比较：\n在连续线性声学中，$x=0$ 处的刚性壁施加了边界条件 $u(0, t) = 0$。总声压场为 $p(x,t) = p_i(x,t) + p_r(x,t) = P_i e^{i(kx - \\omega t)} + P_r e^{i(-kx - \\omega t)}$，总速度为 $u(x,t) = \\frac{1}{\\rho c}(P_i e^{i(kx - \\omega t)} - P_r e^{i(-kx - \\omega t)})$。条件 $u(0,t)=0$ 意味着 $P_i - P_r = 0$，所以 $P_r = P_i$。因此，声压反射系数 $R = P_r/P_i$ 为 $1$。\n\n我们推导出的离散反射系数 $R=1$ 与连续解析值完全匹配。这表明，对于满足离散色散关系的任何频率和波数，将速度节点置于边界并设为零的交错网格 FDTD 格式能够完美地复制刚性壁的物理行为。问题陈述中“在 $x=\\Delta x/2$ 处参考”的条款用于确定第一个声压节点的位置，但这并不改变 $R=P_r/P_i$ 的计算，因为在给定的拟设中，振幅 $P_i$ 和 $P_r$ 是以 $x=0$ 处的相位为参考来定义的。",
            "answer": "$$\\boxed{1}$$"
        },
        {
            "introduction": "理解了数值格式的物理特性后，我们必须对其数值精度进行严格的验证。本练习将介绍收敛率测试这一核心技术，它是衡量数值方法准确阶数的标准流程。通过在不同精度的网格上计算离散微分算子的误差，你将学会如何定义离散范数并量化计算出格式的收敛阶数，从而实验性地确认其理论精度。",
            "id": "4138382",
            "problem": "考虑在长度为 $L$ 的周期域上的一维线性声学一阶形式，写为耦合系统\n$$\n\\partial_t p(x,t) + \\kappa \\,\\partial_x u(x,t) = 0,\\qquad\n\\partial_t u(x,t) + \\frac{1}{\\rho}\\,\\partial_x p(x,t) = 0,\n$$\n其中 $p$ 是声压，$u$ 是粒子速度，$\\rho$ 是密度，$\\kappa$ 是体积模量，均为严格为正的常数。空间域为 $\\Omega = [0,L]$，具有周期性边界条件。我们旨在均匀交错网格上定义离散范数和半范数，并计算在网格细化下空间导数的交错有限差分近似的观测收敛率。\n\n在 $\\Omega$ 上定义一个具有 $N$ 个单元的均匀交错网格，网格间距为 $h = L/N$，单元中心位于 $x_i = (i+\\tfrac{1}{2})h$（对于 $i \\in \\{0,1,\\dots,N-1\\}$），单元面位于 $x_{i+\\tfrac{1}{2}} = ih$（对于 $i \\in \\{0,1,\\dots,N-1\\}$）；为实现周期性，将索引模 $N$。将在中心定义的离散标量场表示为 $\\{v_i\\}_{i=0}^{N-1}$，在面上定义的表示为 $\\{w_{i+\\tfrac{1}{2}}\\}_{i=0}^{N-1}$。\n\n1. 定义单元中心和面上的离散内积和 $\\mathsf{L}^2$ 范数如下\n$$\n\\langle v, \\tilde v\\rangle_{h,c} = \\sum_{i=0}^{N-1} h\\, v_i \\tilde v_i,\\quad \\|v\\|_{h,c} = \\sqrt{\\langle v, v\\rangle_{h,c}},\\qquad\n\\langle w, \\tilde w\\rangle_{h,f} = \\sum_{i=0}^{N-1} h\\, w_{i+\\tfrac{1}{2}} \\tilde w_{i+\\tfrac{1}{2}},\\quad \\|w\\|_{h,f} = \\sqrt{\\langle w, w\\rangle_{h,f}}.\n$$\n\n2. 定义具有周期性包裹的前向和后向交错差分算子，\n$$\n(D^+ v)_{i+\\tfrac{1}{2}} = \\frac{v_i - v_{i-1}}{h},\\qquad (D^- w)_i = \\frac{w_{i+\\tfrac{1}{2}} - w_{i-\\tfrac{1}{2}}}{h},\n$$\n对于 $i \\in \\{0,1,\\dots,N-1\\}$，其中索引模 $N$。这些分别近似了面上的 $\\partial_x v$ 和中心上的 $\\partial_x w$。\n\n3. 在交错网格上定义类 $\\mathsf{H}^1$ 半范数如下\n$$\n|v|_{h,c,1} = \\|D^+ v\\|_{h,f},\\qquad |w|_{h,f,1} = \\|D^- w\\|_{h,c}.\n$$\n\n4. 为在交错网格上采样的声学状态 $(p,u)$（其中 $p$ 在中心，$u$ 在面）定义基于能量的离散范数如下\n$$\n\\|(p,u)\\|_{E,h} = \\sqrt{ \\frac{1}{2} \\sum_{i=0}^{N-1} h\\left( \\frac{1}{\\kappa} p_i^2 + \\rho\\, u_{i+\\tfrac{1}{2}}^2 \\right)}.\n$$\n这是连续声能范数的离散模拟。下面要求的输出不需要物理单位，因为所报告的量是无量纲的收敛率。\n\n令 $L = 2\\pi$。对于 $2\\pi$ 周期性的光滑测试函数 $\\phi$ 和 $u$，通过 $v_i = \\phi(x_i)$ 和 $w_{i+\\tfrac{1}{2}} = u(x_{i+\\tfrac{1}{2}})$ 定义中心和面上的点采样，并用 $\\partial_x \\phi$ 和 $\\partial_x u$ 表示精确的空间导数。对于在选定的离散范数 $\\|\\cdot\\|_h$ 中测量的算子近似误差 $e_h$，将网格尺寸 $h$ 和 $h/2$ 之间的观测到的基于细化的收敛率定义为\n$$\nr = \\frac{\\log\\left(\\|e_h\\|_h / \\|e_{h/2}\\|_{h/2}\\right)}{\\log(2)}.\n$$\n\n你的程序必须实现这些定义，并为以下测试套件计算观测收敛率。对于每个测试，分别使用具有 $N_0$、$2N_0$ 和 $4N_0$ 个单元的三个连续细化的网格。对于每个测试，报告在两个最精细级别之间计算的单个观测率，即 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 1（交错梯度的能量加权误差）：令 $\\rho = 1.3$，$\\kappa = 2.6$，且 $\\phi(x) = \\exp(\\sin x)$。对于每个网格，从中心采样计算面上的 $D^+\\phi$ 和面上的精确 $\\partial_x \\phi$。构造对 $(p,u)$，其中中心的 $p \\equiv 0$，而 $u$ 等于面上的误差 $D^+\\phi - \\partial_x \\phi$。计算基于能量的范数 $\\|(p,u)\\|_{E,h}$ 和使用 $N_0 = 32$ 时的观测率 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 2（交错散度的中心 $\\mathsf{L}^2$ 误差）：令 $u(x) = \\exp(\\cos x)$。对于每个网格，在面上采样 $u$，在中心计算 $D^- u$，在中心评估精确的 $\\partial_x u$，计算中心 $\\mathsf{L}^2$ 范数 $\\|D^- u - \\partial_x u\\|_{h,c}$，并报告使用 $N_0 = 32$ 时的观测率 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 3（更高波数梯度的面 $\\mathsf{L}^2$ 误差）：令 $\\phi(x) = \\sin(10 x)$。对于每个网格，从中心采样计算面上的 $D^+\\phi$，并使用面 $\\mathsf{L}^2$ 范数 $\\|\\cdot\\|_{h,f}$ 将其与面上的精确 $\\partial_x \\phi$ 进行比较，并报告使用 $N_0 = 64$ 时的观测率 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 4（更高波数散度的中心 $\\mathsf{L}^2$ 误差）：令 $u(x) = \\sin(11 x)$。对于每个网格，从面采样计算中心上的 $D^- u$，并使用中心 $\\mathsf{L}^2$ 范数 $\\|\\cdot\\|_{h,c}$ 将其与中心上的精确 $\\partial_x u$ 进行比较，并报告使用 $N_0 = 64$ 时的观测率 $r_{(2N_0\\to 4N_0)}$。\n\n所有函数在 $[0,2\\pi]$ 上都是实值且光滑的，角度以弧度为单位。输出不需要物理单位，因为所报告的速率是无量纲的实数。\n\n你的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序为 $[\\text{测试 1 速率}, \\text{测试 2 速率}, \\text{测试 3 速率}, \\text{测试 4 速率}]$。输出必须是浮点数。示例格式：$[r_1,r_2,r_3,r_4]$。",
            "solution": "我们从连续的一阶声学方程开始。在周期性域 $\\Omega=[0,L]$ 上，状态 $(p,u)$ 的总声能为\n$$\n\\mathcal{E}(t) = \\frac{1}{2}\\int_0^L \\left(\\frac{1}{\\kappa}p(x,t)^2 + \\rho\\, u(x,t)^2\\right)\\,dx,\n$$\n对于具有周期性边界条件的光滑解，该能量在时间上是守恒的。这种连续能量为我们提供了一种自然的内积和范数，用以衡量离散化声学状态的误差。\n\n在一个具有 $N$ 个单元的均匀交错网格上，其中 $h=L/N$，我们将压力 $p$ 置于单元中心 $x_i=(i+\\tfrac{1}{2})h$，将速度 $u$ 置于单元面 $x_{i+\\tfrac{1}{2}}=ih$。离散内积\n$$\n\\langle v, \\tilde v\\rangle_{h,c} = \\sum_{i=0}^{N-1} h\\, v_i \\tilde v_i,\\qquad\n\\langle w, \\tilde w\\rangle_{h,f} = \\sum_{i=0}^{N-1} h\\, w_{i+\\tfrac{1}{2}} \\tilde w_{i+\\tfrac{1}{2}}\n$$\n分别是在中心和面上表示的函数的连续 $\\mathsf{L}^2$ 内积的一致黎曼和近似。相关的离散 $\\mathsf{L}^2$ 范数 $\\|v\\|_{h,c}$ 和 $\\|w\\|_{h,f}$ 是通过对自身内积取平方根得到的。\n\n交错有限差分算子 $D^+$ 和 $D^-$ 定义为\n$$\n(D^+ v)_{i+\\tfrac{1}{2}} = \\frac{v_i - v_{i-1}}{h},\\qquad (D^- w)_i = \\frac{w_{i+\\tfrac{1}{2}} - w_{i-\\tfrac{1}{2}}}{h},\n$$\n其中索引采用周期性包裹。这些算子近似了交错位置处的空间导数。泰勒展开表明其具有二阶精度。例如，对于一个光滑函数 $\\phi$，在 $x_{i+\\tfrac{1}{2}}$ 处展开：\n$$\n\\phi(x_i) = \\phi(x_{i+\\tfrac{1}{2}}) - \\frac{h}{2}\\phi'(x_{i+\\tfrac{1}{2}}) + \\frac{h^2}{8}\\phi''(x_{i+\\tfrac{1}{2}}) - \\frac{h^3}{48}\\phi^{(3)}(x_{i+\\tfrac{1}{2}}) + \\mathcal{O}(h^4),\n$$\n$$\n\\phi(x_{i-1}) = \\phi(x_{i+\\tfrac{1}{2}}) - \\frac{3h}{2}\\phi'(x_{i+\\tfrac{1}{2}}) + \\frac{9h^2}{8}\\phi''(x_{i+\\tfrac{1}{2}}) - \\frac{27h^3}{48}\\phi^{(3)}(x_{i+\\tfrac{1}{2}}) + \\mathcal{O}(h^4).\n$$\n相减并除以 $h$ 得到\n$$\n(D^+\\phi)_{i+\\tfrac{1}{2}} = \\phi'(x_{i+\\tfrac{1}{2}}) - \\frac{h^2}{24}\\phi^{(3)}(x_{i+\\tfrac{1}{2}}) + \\mathcal{O}(h^4),\n$$\n这表明截断误差的阶为 $\\mathcal{O}(h^2)$。类似的展开表明，$(D^- u)_i$ 以 $\\mathcal{O}(h^2)$ 的误差近似 $\\partial_x u(x_i)$。这表明对于足够光滑的函数，误差的离散 $\\mathsf{L}^2$ 范数会以 $\\mathcal{O}(h^2)$ 的速度减小，因此在均匀细化下的观测收敛率应接近 $2$。\n\n对于离散的索博列夫类型度量，我们为中心场定义类 $\\mathsf{H}^1$ 半范数 $|v|_{h,c,1} = \\|D^+ v\\|_{h,f}$，为面场定义类 $\\mathsf{H}^1$ 半范数 $|w|_{h,f,1} = \\|D^- w\\|_{h,c}$。这些是连续 $\\mathsf{H}^1$ 半范数 $|f|_{H^1}=\\|\\partial_x f\\|_{L^2}$ 的离散模拟，并考虑了导数的交错布局。\n\n状态 $(p,u)$ 的基于能量的离散范数为\n$$\n\\|(p,u)\\|_{E,h} = \\sqrt{\\frac{1}{2}\\sum_{i=0}^{N-1} h\\left(\\frac{1}{\\kappa}p_i^2 + \\rho\\, u_{i+\\tfrac{1}{2}}^2\\right)}.\n$$\n这反映了连续能量。它也可以用来度量一对误差 $(e_p,e_u)$；例如，取 $e_p\\equiv 0$ 和 $e_u=D^+\\phi - \\partial_x\\phi$ 会得到\n$$\n\\|(e_p,e_u)\\|_{E,h} = \\sqrt{\\frac{\\rho}{2}}\\;\\|D^+\\phi - \\partial_x\\phi\\|_{h,f},\n$$\n因此，基于能量的误差与 $D^+\\phi$ 的面 $\\mathsf{L}^2$ 误差以相同的速率收敛。\n\n为了计算观测收敛率，考虑一个包含 $N_0$、$2N_0$ 和 $4N_0$ 个单元的网格序列。对于每个网格，构建交错位置 $x_i$ 和 $x_{i+\\tfrac{1}{2}}$，对精确函数及其精确导数进行采样，应用离散算子（$D^+$ 或 $D^-$），并计算误差的离散范数。用 $\\|e_{h}\\|$ 表示在间距为 $h$ 的网格上的误差范数。将更精细级别之间的速率定义为\n$$\nr_{(2N_0\\to 4N_0)} = \\frac{\\log\\left(\\|e_{h/2}\\| / \\|e_{h/4}\\|\\right)}{\\log(2)}.\n$$\n对于光滑周期函数，这个观测到的速率应接近 $2$，反映了 $D^+$ 和 $D^-$ 的二阶一致性。\n\n我们现在详细说明测试：\n\n- 测试 1：选择 $\\rho=1.3$，$\\kappa=2.6$，$\\phi(x)=\\exp(\\sin x)$，$N_0=32$，$L=2\\pi$。对于每个 $N\\in\\{N_0,2N_0,4N_0\\}$，计算中心采样 $v_i=\\phi(x_i)$、面上的 $D^+v$、面上的精确导数 $\\partial_x\\phi(x)=\\cos(x)\\exp(\\sin x)$、面误差 $e_u=D^+v-\\partial_x\\phi$、当 $p\\equiv 0$ 时的能量范数，然后构造 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 2：选择 $u(x)=\\exp(\\cos x)$，$N_0=32$，$L=2\\pi$。对于每个 $N$，计算面采样 $w_{i+\\tfrac{1}{2}}=u(x_{i+\\tfrac{1}{2}})$、中心上的 $D^-w$、中心上的精确导数 $\\partial_x u(x)=-\\sin(x)\\exp(\\cos x)$，计算 $\\|D^-w-\\partial_x u\\|_{h,c}$，然后计算 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 3：选择 $\\phi(x)=\\sin(10x)$，$N_0=64$，$L=2\\pi$。对于每个 $N$，从中心采样计算面上的 $D^+\\phi$，面上的精确导数 $\\partial_x\\phi(x)=10\\cos(10x)$，计算面上的 $\\mathsf{L}^2$ 误差，然后计算 $r_{(2N_0\\to 4N_0)}$。\n\n- 测试 4：选择 $u(x)=\\sin(11x)$，$N_0=64$，$L=2\\pi$。对于每个 $N$，从面采样计算中心上的 $D^-u$，中心上的精确导数 $\\partial_x u(x)=11\\cos(11x)$，计算中心上的 $\\mathsf{L}^2$ 误差，然后计算 $r_{(2N_0\\to 4N_0)}$。\n\n从算法上讲，对于每个测试和细化级别：\n\n- 用 $h=L/N$ 为 $i\\in\\{0,\\dots,N-1\\}$ 构建 $x_i=(i+\\tfrac{1}{2})h$ 和 $x_{i+\\tfrac{1}{2}}=ih$。\n\n- 在所需位置评估相关的精确函数及其导数。\n\n- 使用索引的周期性包裹应用 $D^+$ 或 $D^-$。\n\n- 计算误差的离散 $\\mathsf{L}^2$ 范数或能量范数，视情况而定。\n\n- 在 $N_0$、$2N_0$ 和 $4N_0$ 处累积误差；使用上述公式计算 $r_{(2N_0\\to 4N_0)}$。\n\n最后，以指定格式单行输出四个速率。所有测试的预期速率都接近 $2$，但会因预渐近效应和测试函数的特定振荡内容而有微小偏差。",
            "answer": "```python\nimport numpy as np\n\ndef make_grid(N, L):\n    h = L / N\n    x_centers = (np.arange(N) + 0.5) * h\n    x_faces = np.arange(N) * h\n    return h, x_centers, x_faces\n\ndef D_plus_center_to_face(phi_center, h):\n    # (D^+ v)_{i+1/2} = (v_i - v_{i-1})/h with periodic wrap\n    return (phi_center - np.roll(phi_center, 1)) / h\n\ndef D_minus_face_to_center(u_face, h):\n    # (D^- w)_i = (w_{i+1/2} - w_{i-1/2})/h with periodic wrap\n    return (u_face - np.roll(u_face, 1)) / h\n\ndef L2_norm_center(arr_center, h):\n    return np.sqrt(h * np.sum(arr_center**2))\n\ndef L2_norm_face(arr_face, h):\n    return np.sqrt(h * np.sum(arr_face**2))\n\ndef energy_norm(p_center, u_face, h, rho, kappa):\n    return np.sqrt(0.5 * h * (np.sum((1.0/kappa) * p_center**2) + np.sum(rho * u_face**2)))\n\n# Test functions and derivatives\ndef phi_exp_sin(x):\n    return np.exp(np.sin(x))\n\ndef dphi_exp_sin(x):\n    return np.cos(x) * np.exp(np.sin(x))\n\ndef phi_sin_k(x, k):\n    return np.sin(k * x)\n\ndef dphi_sin_k(x, k):\n    return k * np.cos(k * x)\n\ndef u_exp_cos(x):\n    return np.exp(np.cos(x))\n\ndef du_exp_cos(x):\n    return -np.sin(x) * np.exp(np.cos(x))\n\ndef u_sin_k(x, k):\n    return np.sin(k * x)\n\ndef du_sin_k(x, k):\n    return k * np.cos(k * x)\n\ndef rate_from_errors(e_h, e_h2):\n    return np.log(e_h / e_h2) / np.log(2.0)\n\ndef observed_rate_grad_energy(phi_func, dphi_func, L, N0, rho, kappa):\n    Ns = [N0, 2*N0, 4*N0]\n    errs = []\n    for N in Ns:\n        h, xc, xf = make_grid(N, L)\n        phi_c = phi_func(xc)\n        dphi_exact_f = dphi_func(xf)\n        dplus_phi = D_plus_center_to_face(phi_c, h)\n        e_face = dplus_phi - dphi_exact_f\n        # Energy norm with p=0 and u = error\n        p_zero = np.zeros_like(phi_c)\n        en = energy_norm(p_zero, e_face, h, rho, kappa)\n        errs.append(en)\n    # Use the rate between the two finest levels\n    r = rate_from_errors(errs[1], errs[2])\n    return r\n\ndef observed_rate_div_L2(u_func, du_func, L, N0):\n    Ns = [N0, 2*N0, 4*N0]\n    errs = []\n    for N in Ns:\n        h, xc, xf = make_grid(N, L)\n        u_f = u_func(xf)\n        du_exact_c = du_func(xc)\n        dminus_u = D_minus_face_to_center(u_f, h)\n        e_center = dminus_u - du_exact_c\n        l2 = L2_norm_center(e_center, h)\n        errs.append(l2)\n    r = rate_from_errors(errs[1], errs[2])\n    return r\n\ndef observed_rate_grad_L2(phi_func, dphi_func, L, N0):\n    Ns = [N0, 2*N0, 4*N0]\n    errs = []\n    for N in Ns:\n        h, xc, xf = make_grid(N, L)\n        phi_c = phi_func(xc)\n        dphi_exact_f = dphi_func(xf)\n        dplus_phi = D_plus_center_to_face(phi_c, h)\n        e_face = dplus_phi - dphi_exact_f\n        l2 = L2_norm_face(e_face, h)\n        errs.append(l2)\n    r = rate_from_errors(errs[1], errs[2])\n    return r\n\ndef solve():\n    L = 2.0 * np.pi\n\n    test_cases = [\n        # Test 1: gradient energy norm with phi = exp(sin x), rho=1.3, kappa=2.6, N0=32\n        (\"grad_energy_exp_sin\", 32, 1.3, 2.6),\n        # Test 2: divergence L2 with u = exp(cos x), N0=32\n        (\"div_l2_exp_cos\", 32, None, None),\n        # Test 3: gradient L2 with phi = sin(10x), N0=64\n        (\"grad_l2_sin10\", 64, None, None),\n        # Test 4: divergence L2 with u = sin(11x), N0=64\n        (\"div_l2_sin11\", 64, None, None),\n    ]\n\n    results = []\n    for case in test_cases:\n        name, N0, rho, kappa = case\n        if name == \"grad_energy_exp_sin\":\n            r = observed_rate_grad_energy(phi_exp_sin, dphi_exp_sin, L, N0, rho, kappa)\n            results.append(r)\n        elif name == \"div_l2_exp_cos\":\n            r = observed_rate_div_L2(u_exp_cos, du_exp_cos, L, N0)\n            results.append(r)\n        elif name == \"grad_l2_sin10\":\n            r = observed_rate_grad_L2(lambda x: phi_sin_k(x, 10.0),\n                                      lambda x: dphi_sin_k(x, 10.0), L, N0)\n            results.append(r)\n        elif name == \"div_l2_sin11\":\n            r = observed_rate_div_L2(lambda x: u_sin_k(x, 11.0),\n                                     lambda x: du_sin_k(x, 11.0), L, N0)\n            results.append(r)\n        else:\n            results.append(float('nan'))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "当我们对数值格式的特性和精度有了信心后，最后一步是在一个完整的物理问题上验证我们编写的整个代码。本练习要求你构建一个二维声学模拟器，用以计算一个矩形腔体的共振频率。通过将模拟得到的频率与解析解进行比较，我们将完成一个关键的“验证与确认”(V&V)步骤，确保我们的程序能正确地求解控制方程。",
            "id": "4138364",
            "problem": "考虑在二维空间中，围绕静止流体状态的线性化一阶声学方程，由以下方程组给出：\n$$\n\\frac{\\partial p}{\\partial t} = -K \\left( \\frac{\\partial v_x}{\\partial x} + \\frac{\\partial v_y}{\\partial y} \\right), \\quad\n\\rho_0 \\frac{\\partial v_x}{\\partial t} = -\\frac{\\partial p}{\\partial x}, \\quad\n\\rho_0 \\frac{\\partial v_y}{\\partial t} = -\\frac{\\partial p}{\\partial y},\n$$\n其中 $p$ 是声压，$v_x$ 和 $v_y$ 是声学质点速度的分量，$K$ 是体积模量，$\\rho_0$ 是平衡密度。假设一个尺寸为 $L_x \\times L_y$ 的矩形腔，其壁面要么是刚性的，要么是压力释放的。刚性壁强制 $v_n=0$，即边界处的法向速度为零，这对应于 $p$ 的齐次诺伊曼条件。压力释放壁强制 $p=0$（狄利克雷条件）。对于矩形腔，连续本征频率为\n$$\nf_{m,n} = \\frac{c}{2} \\sqrt{\\left(\\frac{m}{L_x}\\right)^2 + \\left(\\frac{n}{L_y}\\right)^2},\n$$\n其中 $c$ 是声速。对于压力释放壁，$m,n \\in \\mathbb{N}$；对于刚性壁，$m,n \\in \\mathbb{N}_0$，并排除 $m=n=0$ 的平凡情况。\n\n您必须为此系统实现一个显式的二维交错网格格式（压力位于单元中心，速度分量位于单元面）。离散更新必须根据上述方程，使用与交错排列一致的有限差分法推导得出：\n- 压力 $p[i,j]$ 位于单元中心，坐标为 $x_i = (i+\\tfrac{1}{2})\\Delta x$，$y_j = (j+\\tfrac{1}{2})\\Delta y$，其中 $i=0,\\dots,N_x-1$，$j=0,\\dots,N_y-1$。\n- 速度 $v_x[i,j]$ 位于垂直面上，坐标为 $x = i \\Delta x$，$y = (j+\\tfrac{1}{2})\\Delta y$，其中 $i=0,\\dots,N_x$，$j=0,\\dots,N_y-1$。\n- 速度 $v_y[i,j]$ 位于水平面上，坐标为 $x = (i+\\tfrac{1}{2})\\Delta x$，$y = j \\Delta y$，其中 $i=0,\\dots,N_x-1$，$j=0,\\dots,N_y$。\n\n使用时间上蛙跳的方法，其中速度使用压力梯度从时间 $t^n$推进到 $t^{n+1/2}$，压力使用 $t^{n+1/2}$ 时的速度散度从 $t^n$ 推进到 $t^{n+1}$。边界条件必须按如下方式强制执行：\n- 对于刚性壁，将域边界上的法向速度分量设置为零（即，$v_x[0,\\cdot]=0$，$v_x[N_x,\\cdot]=0$，$v_y[\\cdot,0]=0$，$v_y[\\cdot,N_y]=0$），并使用对称的虚拟压力值，以在速度更新中产生零法向压力梯度（即，$p_{\\text{ghost,left}}=p[0,\\cdot]$，$p_{\\text{ghost,right}}=p[N_x-1,\\cdot]$，$p_{\\text{ghost,bottom}}=p[\\cdot,0]$，$p_{\\text{ghost,top}}=p[\\cdot,N_y-1]$）。\n- 对于压力释放壁，通过反对称的虚拟压力值在壁上强制 $p=0$（即，$p_{\\text{ghost,left}}=-p[0,\\cdot]$，$p_{\\text{ghost,right}}=-p[N_x-1,\\cdot]$，$p_{\\text{ghost,bottom}}=-p[\\cdot,0]$，$p_{\\text{ghost,top}}=-p[\\cdot,N_y-1]$），并让速度自由演化。\n\n通过将初始压力场设置为具有单位振幅和零初始速度的相应连续模态振型来初始化驻波：\n- 对于刚性壁（诺伊曼边界条件），使用 $p(x,y,0) = \\cos\\left(\\frac{m \\pi x}{L_x}\\right)\\cos\\left(\\frac{n \\pi y}{L_y}\\right)$。\n- 对于压力释放壁（狄利克雷边界条件），使用 $p(x,y,0) = \\sin\\left(\\frac{m \\pi x}{L_x}\\right)\\sin\\left(\\frac{n \\pi y}{L_y}\\right)$。\n\n根据交错格式的 Courant-Friedrichs-Lewy 安全条件选择时间步长 $\\Delta t$：\n$$\n\\Delta t = \\frac{\\text{CFL}}{c \\sqrt{\\left(\\frac{1}{\\Delta x}\\right)^2 + \\left(\\frac{1}{\\Delta y}\\right)^2}},\n$$\n其中 $\\text{CFL} \\in (0,1)$。模拟一个有限的持续时间 $T$，该时间足以分辨驻波的主导频率。使用离散傅里叶变换从一个非节点的内部点的压力时间历史中提取主导离散频率 $f_{\\text{FD}}$，并计算相对误差\n$$\n\\delta = \\frac{|f_{\\text{FD}} - f_{m,n}|}{f_{m,n}},\n$$\n该误差必须以无量纲小数形式报告（不使用百分号）。\n\n将上述内容在一个完整的程序中实现，并运行以下测试套件。使用一致的物理和数值单位：$L_x$ 和 $L_y$ 以米为单位，$c$ 以米/秒为单位，$\\rho_0$ 以千克/立方米为单位，$\\Delta t$ 以秒为单位，$f$ 以赫兹为单位。最终输出必须是每种情况下的相对误差 $\\delta$，四舍五入到六位小数。\n\n测试套件：\n- 情况 1（常规情况，刚性壁）：$L_x=1.2$ $\\mathrm{m}$，$L_y=0.8$ $\\mathrm{m}$，$N_x=64$，$N_y=48$，$m=1$，$n=0$，$c=343$ $\\mathrm{m/s}$，$\\rho_0=1.21$ $\\mathrm{kg/m^3}$，$\\text{CFL}=0.95$，$T=0.25$ $\\mathrm{s}$。\n- 情况 2（常规情况，压力释放壁）：$L_x=1.2$ $\\mathrm{m}$，$L_y=0.8$ $\\mathrm{m}$，$N_x=64$，$N_y=48$，$m=1$，$n=1$，$c=343$ $\\mathrm{m/s}$，$\\rho_0=1.21$ $\\mathrm{kg/m^3}$，$\\text{CFL}=0.95$，$T=0.25$ $\\mathrm{s}$。\n- 情况 3（边界情况：一个零索引模态和接近CFL极限，刚性壁）：$L_x=1.0$ $\\mathrm{m}$，$L_y=1.5$ $\\mathrm{m}$，$N_x=60$，$N_y=50$，$m=0$，$n=2$，$c=343$ $\\mathrm{m/s}$，$\\rho_0=1.21$ $\\mathrm{kg/m^3}$，$\\text{CFL}=0.99$，$T=0.30$ $\\mathrm{s}$。\n\n您的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[r_1,r_2,r_3]$），其中 $r_k$ 是上述三种情况的相对误差，四舍五入到六位小数。",
            "solution": "用户希望使用时域有限差分（FDTD）方法在交错网格上求解二维线性化声学方程，并根据解析本征频率验证数值结果。我已经验证了问题陈述，发现它在科学上是合理的、适定的和完整的。我现在将提供完整的解决方案。\n\n### **1. 控制方程与离散化**\n\n该问题涉及二维空间中的线性化一阶声学方程：\n$$\n\\frac{\\partial p}{\\partial t} = -K \\left( \\frac{\\partial v_x}{\\partial x} + \\frac{\\partial v_y}{\\partial y} \\right)\n$$\n$$\n\\rho_0 \\frac{\\partial v_x}{\\partial t} = -\\frac{\\partial p}{\\partial x}\n$$\n$$\n\\rho_0 \\frac{\\partial v_y}{\\partial t} = -\\frac{\\partial p}{\\partial y}\n$$\n这里，$p$ 是声压，$\\vec{v} = (v_x, v_y)$ 是质点速度，$K$ 是体积模量，$\\rho_0$ 是流体的平衡密度。声速由 $c = \\sqrt{K/\\rho_0}$ 给出。\n\n我们采用交错网格有限差分格式。压力 $p$ 定义在单元中心，而速度分量 $v_x$ 和 $v_y$ 定义在垂直于其各自方向的单元面上。设大小为 $L_x \\times L_y$ 的域被离散化为 $N_x \\times N_y$ 个单元，空间步长为 $\\Delta x = L_x/N_x$ 和 $\\Delta y = L_y/N_y$。离散场表示为：\n- $p_{i,j}^n \\approx p((i+\\frac{1}{2})\\Delta x, (j+\\frac{1}{2})\\Delta y, n\\Delta t)$\n- $v_{x, i,j}^{n+1/2} \\approx v_x(i\\Delta x, (j+\\frac{1}{2})\\Delta y, (n+\\frac{1}{2})\\Delta t)$\n- $v_{y, i,j}^{n+1/2} \\approx v_y((i+\\frac{1}{2})\\Delta x, j\\Delta y, (n+\\frac{1}{2})\\Delta t)$\n\n对于压力 $p$，索引 $i$ 的范围是 $0, \\dots, N_x-1$，$j$ 的范围是 $0, \\dots, N_y-1$。对于速度，索引延伸到域边界：$v_x$ 的 $i$ 范围是 $0, \\dots, N_x$，$v_y$ 的 $j$ 范围是 $0, \\dots, N_y$。\n\n使用蛙跳时间步进格式，其中压力在整数时间步 $n\\Delta t$ 处计算，速度在半整数时间步 $(n+\\frac{1}{2})\\Delta t$ 处计算。偏导数使用二阶中心差分近似，这在空间和时间上自然是交错的：\n\n速度更新方程由动量方程推导得出：\n$$\nv_{x, i,j}^{n+1/2} = v_{x, i,j}^{n-1/2} - \\frac{\\Delta t}{\\rho_0 \\Delta x} (p_{i,j}^n - p_{i-1,j}^n)\n$$\n$$\nv_{y, i,j}^{n+1/2} = v_{y, i,j}^{n-1/2} - \\frac{\\Delta t}{\\rho_0 \\Delta y} (p_{i,j}^n - p_{i,j-1}^n)\n$$\n\n压力更新方程由连续性方程推导得出：\n$$\np_{i,j}^{n+1} = p_{i,j}^n - K \\Delta t \\left( \\frac{v_{x, i+1,j}^{n+1/2} - v_{x, i,j}^{n+1/2}}{\\Delta x} + \\frac{v_{y, i,j+1}^{n+1/2} - v_{y, i,j}^{n+1/2}}{\\Delta y} \\right)\n$$\n这些方程构成了 FDTD 模拟循环的核心。\n\n### **2. 初始条件和边界条件**\n\n**初始条件**：模拟以压力的驻波模式进行初始化，对应于特定的模态 $(m, n)$，初始速度为零。对于蛙跳格式，我们根据指定的函数设置 $p^0$，并假设在时间 $t=-\\Delta t/2$ 时的速度为零。\n- 对于刚性壁（诺伊曼边界条件）：$p(x,y,0) = \\cos\\left(\\frac{m \\pi x}{L_x}\\right)\\cos\\left(\\frac{n \\pi y}{L_y}\\right)$。通过在压力网格坐标 $(x_i, y_j) = ((i+0.5)\\Delta x, (j+0.5)\\Delta y)$ 处评估此函数来初始化离散压力场 $p_{i,j}^0$。\n- 对于压力释放壁（狄利克雷边界条件）：$p(x,y,0) = \\sin\\left(\\frac{m \\pi x}{L_x}\\right)\\sin\\left(\\frac{n \\pi y}{L_y}\\right)$。\n\n**边界条件**：\n- **刚性壁**：此条件在边界处施加零法向速度（$v_n=0$），这对应于压力的齐次诺伊曼条件（$\\partial p/\\partial n = 0$）。在离散格式中，这是通过在每个时间步显式地将边界网格点上的法向速度分量设置为零来实现的：\n$v_{x,0,j} = 0$, $v_{x,N_x,j} = 0$, $v_{y,i,0} = 0$, 和 $v_{y,i,N_y} = 0$。此方法在 FDTD 框架内正确地模拟了壁上的零压力梯度。\n\n- **压力释放壁**：此条件在边界处施加零压力（$p=0$）。这是一个狄利克雷条件。我们通过在域外使用反对称的虚拟压力值来实现它。例如，为了更新左边界（$x=0$）处的速度 $v_{x,0,j}$，所需的压力梯度涉及一个虚拟压力值 $p_{-1,j}$。我们将此虚拟值设置为 $p_{-1,j} = -p_{0,j}$。这有效地以二阶精度模拟了 $p=0$ 的条件。四个边界上的速度更新变为：\n$$\nv_{x, 0,j}^{n+1/2} = v_{x, 0,j}^{n-1/2} - \\frac{\\Delta t}{\\rho_0 \\Delta x} (p_{0,j}^n - (-p_{0,j}^n)) = v_{x, 0,j}^{n-1/2} - \\frac{2\\Delta t}{\\rho_0 \\Delta x} p_{0,j}^n\n$$\n$$\nv_{x, N_x,j}^{n+1/2} = v_{x, N_x,j}^{n-1/2} - \\frac{\\Delta t}{\\rho_0 \\Delta x} ((-p_{N_x-1,j}^n) - p_{N_x-1,j}^n) = v_{x, N_x,j}^{n-1/2} + \\frac{2\\Delta t}{\\rho_0 \\Delta x} p_{N_x-1,j}^n\n$$\n类似的更新适用于 $v_{y,i,0}$ 和 $v_{y,i,N_y}$。\n\n### **3. 稳定性、频率分析和误差计算**\n\n**稳定性**：显式 FDTD 格式是条件稳定的。时间步长 $\\Delta t$ 必须满足 Courant-Friedrichs-Lewy (CFL) 条件。对于二维交错网格，该条件为：\n$$\n\\Delta t \\le \\frac{1}{c \\sqrt{\\left(\\frac{1}{\\Delta x}\\right)^2 + \\left(\\frac{1}{\\Delta y}\\right)^2}}\n$$\n我们使用一个安全因子 $\\text{CFL}  1$ 来设置时间步长：\n$$\n\\Delta t = \\frac{\\text{CFL}}{c \\sqrt{\\left(\\frac{1}{\\Delta x}\\right)^2 + \\left(\\frac{1}{\\Delta y}\\right)^2}}\n$$\n\n**频率分析**：模拟运行总时间 $T$。在每个时间步记录一个固定的、非节点的内部点的压力，形成一个离散时间信号。然后使用快速傅里叶变换（FFT）算法对该信号进行离散傅里叶变换（DFT）。对应于最大幅值分量（不包括直流分量）的频率被识别为主导离散频率 $f_{\\text{FD}}$。\n\n**误差计算**：网格的数值色散导致数值频率 $f_{\\text{FD}}$ 偏离连续系统的解析本征频率 $f_{m,n}$。我们使用相对误差 $\\delta$ 来量化这种偏差：\n$$\n\\delta = \\frac{|f_{\\text{FD}} - f_{m,n}|}{f_{m,n}}\n$$\n其中解析频率由下式给出\n$$\nf_{m,n} = \\frac{c}{2} \\sqrt{\\left(\\frac{m}{L_x}\\right)^2 + \\left(\\frac{n}{L_y}\\right)^2}\n$$\n$\\delta$ 的值作为衡量给定离散化下 FDTD 模拟准确性的指标。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        # Case 1: (happy path, rigid walls)\n        {'Lx': 1.2, 'Ly': 0.8, 'Nx': 64, 'Ny': 48, 'm': 1, 'n': 0, 'c': 343.0,\n         'rho0': 1.21, 'CFL': 0.95, 'T': 0.25, 'bc_type': 'rigid'},\n        # Case 2: (happy path, pressure-release walls)\n        {'Lx': 1.2, 'Ly': 0.8, 'Nx': 64, 'Ny': 48, 'm': 1, 'n': 1, 'c': 343.0,\n         'rho0': 1.21, 'CFL': 0.95, 'T': 0.25, 'bc_type': 'pressure-release'},\n        # Case 3: (edge case: one zero index mode and near-CFL limit, rigid walls)\n        {'Lx': 1.0, 'Ly': 1.5, 'Nx': 60, 'Ny': 50, 'm': 0, 'n': 2, 'c': 343.0,\n         'rho0': 1.21, 'CFL': 0.99, 'T': 0.30, 'bc_type': 'rigid'}\n    ]\n\n    results = []\n    for case in test_cases:\n        error = run_fdtd_simulation(**case)\n        results.append(f\"{error:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef run_fdtd_simulation(Lx, Ly, Nx, Ny, m, n, c, rho0, CFL, T, bc_type):\n    \"\"\"\n    Performs a 2D acoustic FDTD simulation for a single test case.\n    \"\"\"\n    # 1. Grid and Simulation Parameters\n    dx = Lx / Nx\n    dy = Ly / Ny\n    K = c**2 * rho0  # Bulk modulus\n\n    # Stability condition (CFL)\n    dt = CFL / (c * np.sqrt(1/dx**2 + 1/dy**2))\n    n_steps = int(T / dt)\n\n    # 2. Field Initialization\n    p = np.zeros((Nx, Ny))\n    vx = np.zeros((Nx + 1, Ny))\n    vy = np.zeros((Nx, Ny + 1))\n    \n    # Pressure grid coordinates (cell centers)\n    p_x_coords = (np.arange(Nx) + 0.5) * dx\n    p_y_coords = (np.arange(Ny) + 0.5) * dy\n    xx, yy = np.meshgrid(p_x_coords, p_y_coords, indexing='ij')\n\n    # Initial pressure field\n    if bc_type == 'rigid':\n        p = np.cos(m * np.pi * xx / Lx) * np.cos(n * np.pi * yy / Ly)\n    elif bc_type == 'pressure-release':\n        # For pressure-release, m and n must be >= 1. The problem ensures this.\n        p = np.sin(m * np.pi * xx / Lx) * np.sin(n * np.pi * yy / Ly)\n\n    # 3. Main FDTD Loop\n    pressure_history = np.zeros(n_steps)\n    probe_x, probe_y = Nx // 3, Ny // 3 # A non-nodal point for all cases\n    \n    # Update coefficients\n    C_vx = dt / (rho0 * dx)\n    C_vy = dt / (rho0 * dy)\n    C_px = K * dt / dx\n    C_py = K * dt / dy\n\n    for t_step in range(n_steps):\n        # --- (1) Update Velocity Fields (from n-1/2 to n+1/2) ---\n        # Interior points\n        vx[1:Nx, :] -= C_vx * (p[1:Nx, :] - p[0:Nx-1, :])\n        vy[:, 1:Ny] -= C_vy * (p[:, 1:Ny] - p[:, 0:Ny-1])\n        \n        # --- (2) Apply Velocity Boundary Conditions ---\n        if bc_type == 'rigid':\n            vx[0, :] = 0.0\n            vx[Nx, :] = 0.0\n            vy[:, 0] = 0.0\n            vy[:, Ny] = 0.0\n        elif bc_type == 'pressure-release':\n            # Use anti-symmetric ghost cells for p to update boundary velocities\n            vx[0, :] -= 2.0 * C_vx * p[0, :]\n            vx[Nx, :] += 2.0 * C_vx * p[Nx-1, :]\n            vy[:, 0] -= 2.0 * C_vy * p[:, 0]\n            vy[:, Ny] += 2.0 * C_vy * p[:, Ny-1]\n\n        # --- (3) Update Pressure Field (from n to n+1) ---\n        p[:, :] -= C_px * (vx[1:Nx+1, :] - vx[0:Nx, :])\n        p[:, :] -= C_py * (vy[:, 1:Ny+1] - vy[:, 0:Ny])\n\n        # --- (4) Store pressure at probe location ---\n        pressure_history[t_step] = p[probe_x, probe_y]\n\n    # 4. Frequency Analysis\n    # Analytical frequency\n    # For rigid BCs, m,n=0,0 is excluded. For p-release, m,n>=1.\n    if (m == 0 and n == 0):\n        f_mn = 0.0\n    else:\n        f_mn = (c / 2.0) * np.sqrt((m / Lx)**2 + (n / Ly)**2)\n\n    # Numerical frequency from FFT\n    fft_result = np.fft.fft(pressure_history)\n    fft_freqs = np.fft.fftfreq(n_steps, d=dt)\n    \n    # Find peak frequency in the positive spectrum\n    positive_freq_mask = fft_freqs > 0\n    if not np.any(positive_freq_mask):\n        return np.nan # Avoid error if no positive frequencies (e.g., T is too short)\n        \n    peak_idx = np.argmax(np.abs(fft_result[positive_freq_mask]))\n    f_fd = fft_freqs[positive_freq_mask][peak_idx]\n\n    # 5. Calculate Relative Error\n    if f_mn == 0:\n        # Avoid division by zero if analytical frequency is zero.\n        # This case should not be hit with the provided test suite.\n        return np.abs(f_fd)\n    \n    relative_error = np.abs(f_fd - f_mn) / f_mn\n    \n    return relative_error\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}