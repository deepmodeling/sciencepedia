{
    "hands_on_practices": [
        {
            "introduction": "This exercise establishes the fundamental principle of the Total-Field/Scattered-Field (TF/SF) method using a source-term approach. By deriving the equivalent sources for a finite-difference scheme on a Cartesian grid, you will gain a concrete understanding of how an incident wave is mathematically injected into the computational domain. This practice bridges the gap between the abstract concept of domain decomposition and its practical implementation, culminating in an analysis of the method's formal accuracy .",
            "id": "4148530",
            "problem": "Consider two-dimensional time-harmonic acoustics in a homogeneous medium of constant sound speed $c$. The complex acoustic pressure $u(x,y)$ at angular frequency $\\omega$ satisfies the Helmholtz equation $-\\Delta u - k^{2} u = 0$ in free space, where $k = \\omega/c$ is the wavenumber and $\\Delta$ is the Laplacian. A Total-Field/Scattered-Field (TF/SF) formulation is used to inject a known incident field $u^{\\text{inc}}(x,y)$ into a rectangular total-field region, while allowing outgoing scattered waves to pass through without reflection.\n\nLet the TF/SF boundary be aligned with a Cartesian grid of spacing $h$, with grid points $(x_{i},y_{j}) = (x_{0} + i h, y_{0} + j h)$, and let the TF/SF rectangle be the set of interior indices $\\{(i,j): 1 \\le i \\le N_{x}-1, 1 \\le j \\le N_{y}-1\\}$, so that its four faces lie on the index lines $i = 0$, $i = N_{x}$, $j = 0$, and $j = N_{y}$. Consider the standard second-order central-difference discrete Helmholtz operator $L_{h}$ acting on grid functions $v_{i,j}$:\n$$\n(L_{h} v)_{i,j} = \\frac{v_{i+1,j} - 2 v_{i,j} + v_{i-1,j}}{h^{2}} + \\frac{v_{i,j+1} - 2 v_{i,j} + v_{i,j-1}}{h^{2}} + k^{2} v_{i,j},\n$$\ndefined for interior indices $(i,j)$ whose stencil lies within the TF/SF rectangle. To inject the incident field by the TF/SF method, we introduce discrete equivalent sources $s_{i,j}$ supported only on the one-cell-thick layer of interior nodes adjacent to each TF/SF face. The collocation construction requires that, for each interior node whose stencil references one neighbor outside the TF/SF rectangle, the missing neighbor contribution be exactly replaced by a source term $s_{i,j}$ computed from the known incident field samples at the ghost neighbor.\n\nSuppose the incident field is a smooth plane wave $u^{\\text{inc}}(x,y) = \\exp(i k_{x} x + i k_{y} y)$ with $k_{x}^{2} + k_{y}^{2} = k^{2}$. Using the collocation method described above, derive explicit formulas for the equivalent source strengths $s_{i,j}$ on the four interior layers adjacent to the TF/SF faces, in terms of $u^{\\text{inc}}$ sampled at the appropriate ghost points one step outside the TF/SF rectangle. Then, under the assumption that the discrete Helmholtz problem using $L_{h}$ with these sources is stable and that $k h$ is sufficiently small, rigorously analyze the formal order of accuracy $m$ of the interior reconstruction $u_{h}$ of $u^{\\text{inc}}$ inside the TF/SF rectangle. Your analysis should start from the fundamental laws and core definitions, including the continuous Helmholtz equation and the definition of $L_{h}$, and should not invoke any shortcut formulas not derived from these bases. State the final order $m$ as a single integer. Provide no inequalities in your final answer. The final answer should contain only the value of $m$ with no units and no additional text.",
            "solution": "The problem asks for two results concerning a Total-Field/Scattered-Field (TF/SF) formulation for the two-dimensional Helmholtz equation. First, we must derive the explicit formulas for the discrete equivalent sources $s_{i,j}$ used to inject an incident plane wave. Second, we must determine the formal order of accuracy, $m$, of a pure-source reconstruction of the incident field within the total-field region.\n\nThe problem is well-posed and scientifically grounded in the principles of computational acoustics and numerical analysis of partial differential equations. All necessary information is provided, and the setup is consistent with standard, albeit simplified, implementations of the TF/SF method. We can therefore proceed with a full solution.\n\nThe continuous Helmholtz equation is given as\n$$\n\\Delta u + k^{2} u = 0,\n$$\nwhere $k = \\omega/c$ is the wavenumber. The incident field is a plane wave $u^{\\text{inc}}(x,y) = \\exp(i k_{x} x + i k_{y} y)$ which is an exact solution to this equation, provided $k_{x}^{2} + k_{y}^{2} = k^{2}$.\n\nThe discrete operator $L_{h}$ is the standard second-order central-difference approximation to the Helmholtz operator, $\\Delta + k^{2}$:\n$$\n(L_{h} v)_{i,j} = \\frac{v_{i+1,j} - 2 v_{i,j} + v_{i-1,j}}{h^{2}} + \\frac{v_{i,j+1} - 2 v_{i,j} + v_{i,j-1}}{h^{2}} + k^{2} v_{i,j}.\n$$\nThe computational domain for the total field $u_{i,j}$ consists of the grid indices $\\{(i,j): 1 \\le i \\le N_{x}-1, 1 \\le j \\le N_{y}-1\\}$.\n\nPart 1: Derivation of the source terms $s_{i,j}$\n\nThe source terms $s_{i,j}$ are non-zero only on the one-cell-thick layer of interior nodes adjacent to the TF/SF boundary. The \"collocation construction\" prescribes that for any node whose five-point stencil extends to a \"ghost\" neighbor outside the computational domain, the value at that ghost node is replaced by the known value of the incident field, $u^{\\text{inc}}$, sampled at that location. This modification is then treated as a source term.\n\nLet's write a discrete equation for a node $(i,j)$ in the interior of the domain, but on the layer adjacent to a boundary. Consider a node $(1,j)$ with $1 < j < N_y - 1$. The discrete Helmholtz equation, if it were to be satisfied perfectly, would be $(L_h u)_{1,j} = 0$. Expanding this gives:\n$$\n\\frac{u_{2,j} - 2 u_{1,j} + u_{0,j}}{h^{2}} + \\frac{u_{1,j+1} - 2 u_{1,j} + u_{1,j-1}}{h^{2}} + k^{2} u_{1,j} = 0.\n$$\nIn this equation, $u_{1,j}$, $u_{2,j}$, $u_{1,j+1}$, and $u_{1,j-1}$ are unknown total-field values inside the domain. The node $(0,j)$ is a ghost node. According to the problem's prescription, we replace $u_{0,j}$ with $u^{\\text{inc}}_{0,j} = u^{\\text{inc}}(x_0, y_j)$.\nThe equation becomes:\n$$\n\\frac{u_{2,j} - 2 u_{1,j} + u^{\\text{inc}}_{0,j}}{h^{2}} + \\frac{u_{1,j+1} - 2 u_{1,j} + u_{1,j-1}}{h^{2}} + k^{2} u_{1,j} = 0.\n$$\nTo formulate this as a linear system for the unknowns $u_{i,j}$ within the TF region, we move the term involving the known incident field to the right-hand side.\n$$\n\\frac{u_{2,j} - 2 u_{1,j}}{h^{2}} + \\frac{u_{1,j+1} - 2 u_{1,j} + u_{1,j-1}}{h^{2}} + k^{2} u_{1,j} = -\\frac{u^{\\text{inc}}_{0,j}}{h^{2}}.\n$$\nThe right-hand side is the source term $s_{1,j}$. We can systematically derive the sources for all four boundary-adjacent layers and corners. Let $u^{\\text{inc}}_{i,j} = u^{\\text{inc}}(x_{i}, y_j)$.\n\n1.  Left boundary layer ($i=1, 1 < j < N_y - 1$): The stencil involves the ghost node $(0,j)$.\n    $$s_{1,j} = -\\frac{1}{h^{2}} u^{\\text{inc}}_{0,j}$$\n2.  Right boundary layer ($i=N_x - 1, 1 < j < N_y - 1$): The stencil involves the ghost node $(N_x,j)$.\n    $$s_{N_x-1,j} = -\\frac{1}{h^{2}} u^{\\text{inc}}_{N_x, j}$$\n3.  Bottom boundary layer ($j=1, 1 < i < N_x - 1$): The stencil involves the ghost node $(i,0)$.\n    $$s_{i,1} = -\\frac{1}{h^{2}} u^{\\text{inc}}_{i,0}$$\n4.  Top boundary layer ($j=N_y - 1, 1 < i < N_x - 1$): The stencil involves the ghost node $(i,N_y)$.\n    $$s_{i,N_y-1} = -\\frac{1}{h^{2}} u^{\\text{inc}}_{i,N_y}$$\nThe corner nodes involve two ghost neighbors.\n5.  Bottom-left corner ($i=1, j=1$): The stencil involves ghost nodes $(0,1)$ and $(1,0)$.\n    $$s_{1,1} = -\\frac{1}{h^{2}} \\left( u^{\\text{inc}}_{0,1} + u^{\\text{inc}}_{1,0} \\right)$$\n6.  Bottom-right corner ($i=N_x-1, j=1$): The stencil involves ghost nodes $(N_x,1)$ and $(N_x-1,0)$.\n    $$s_{N_x-1,1} = -\\frac{1}{h^{2}} \\left( u^{\\text{inc}}_{N_x,1} + u^{\\text{inc}}_{N_x-1,0} \\right)$$\n7.  Top-left corner ($i=1, j=N_y-1$): The stencil involves ghost nodes $(0,N_y-1)$ and $(1,N_y)$.\n    $$s_{1,N_y-1} = -\\frac{1}{h^{2}} \\left( u^{\\text{inc}}_{0,N_y-1} + u^{\\text{inc}}_{1,N_y} \\right)$$\n8.  Top-right corner ($i=N_x-1, j=N_y-1$): The stencil involves ghost nodes $(N_x,N_y-1)$ and $(N_x-1,N_y)$.\n    $$s_{N_x-1,N_y-1} = -\\frac{1}{h^{2}} \\left( u^{\\text{inc}}_{N_x,N_y-1} + u^{\\text{inc}}_{N_x-1,N_y} \\right)$$\nFor all other interior nodes $\\{(i,j): 1 < i < N_x-1, 1 < j < N_y-1\\}$, the source term is zero: $s_{i,j}=0$.\n\nPart 2: Analysis of the Formal Order of Accuracy\n\nThe formal order of accuracy is determined by the order of the local truncation error (LTE), $\\tau_{i,j}$. The LTE is the residual obtained when the exact continuous solution, $u^{\\text{inc}}(x,y)$, is substituted into the discrete numerical scheme.\n\nLet $A_h$ be the discrete operator matrix for the unknowns within the TF region, and let $\\mathbf{s}$ be the vector of source terms derived above. The numerical solution $\\mathbf{u}_h$ is found by solving the linear system $A_h \\mathbf{u}_h = \\mathbf{s}$.\n\nThe LTE at a node $(i,j)$ is $\\tau_{i,j} = (A_h \\mathbf{u}^{\\text{inc}})_{i,j} - s_{i,j}$, where $\\mathbf{u}^{\\text{inc}}$ is the vector of exact solution samples at the grid points.\n\nLet's examine $\\tau_{i,j}$ for the different node types.\n- For a node $(i,j)$ not adjacent to a boundary ($1 < i < N_x-1, 1 < j < N_y-1$):\nThe discrete equation is $(L_h u_h)_{i,j} = 0$, so $(A_h \\mathbf{u}_h)_{i,j} = (L_h u_h)_{i,j}$ and $s_{i,j} = 0$.\nThe LTE is $\\tau_{i,j} = (L_h u^{\\text{inc}})_{i,j} - 0 = (L_h u^{\\text{inc}})_{i,j}$.\n\n- For a node on the boundary layer, e.g., $(1,j)$ with $1 < j < N_y-1$:\nThe discrete equation is $\\frac{u_{h,2,j} - 2u_{h,1,j}}{h^2} + \\frac{u_{h,1,j+1} - 2u_{h,1,j} + u_{h,1,j-1}}{h^2} + k^2 u_{h,1,j} = s_{1,j}$.\nSo, $(A_h \\mathbf{u}^{\\text{inc}})_{1,j} = \\frac{u^{\\text{inc}}_{2,j} - 2u^{\\text{inc}}_{1,j}}{h^2} + \\frac{u^{\\text{inc}}_{1,j+1} - 2u^{\\text{inc}}_{1,j} + u^{\\text{inc}}_{1,j-1}}{h^2} + k^2 u^{\\text{inc}}_{1,j}$.\nThe source is $s_{1,j} = -u^{\\text{inc}}_{0,j}/h^2$.\nThe LTE is:\n$$\n\\tau_{1,j} = \\left(\\frac{u^{\\text{inc}}_{2,j} - 2u^{\\text{inc}}_{1,j}}{h^2} + \\frac{u^{\\text{inc}}_{1,j+1} - 2u^{\\text{inc}}_{1,j} + u^{\\text{inc}}_{1,j-1}}{h^2} + k^2 u^{\\text{inc}}_{1,j}\\right) - \\left(-\\frac{u^{\\text{inc}}_{0,j}}{h^2}\\right)\n$$\n$$\n\\tau_{1,j} = \\frac{u^{\\text{inc}}_{2,j} - 2u^{\\text{inc}}_{1,j} + u^{\\text{inc}}_{0,j}}{h^2} + \\frac{u^{\\text{inc}}_{1,j+1} - 2u^{\\text{inc}}_{1,j} + u^{\\text{inc}}_{1,j-1}}{h^2} + k^2 u^{\\text{inc}}_{1,j} = (L_h u^{\\text{inc}})_{1,j}.\n$$\nThis demonstrates that the specific choice of source terms ensures that the LTE has the same form, $\\tau_{i,j} = (L_h u^{\\text{inc}})_{i,j}$, for all interior nodes $(i,j)$ of the TF region.\n\nTo find the order of the LTE, we perform a Taylor series expansion of $u^{\\text{inc}}(x,y)$ around a point $(x_i, y_j)$. Let $u \\equiv u^{\\text{inc}}$ and all derivatives be evaluated at $(x_i, y_j)$.\n$$\nu(x_i \\pm h, y_j) = u \\pm h \\frac{\\partial u}{\\partial x} + \\frac{h^2}{2!} \\frac{\\partial^2 u}{\\partial x^2} \\pm \\frac{h^3}{3!} \\frac{\\partial^3 u}{\\partial x^3} + \\frac{h^4}{4!} \\frac{\\partial^4 u}{\\partial x^4} + O(h^5)\n$$\nThe central difference for the second derivative in $x$ is:\n$$\n\\frac{u(x_i+h,y_j) - 2u(x_i,y_j) + u(x_i-h,y_j)}{h^2} = \\frac{1}{h^2} \\left( (u + h u_x + \\frac{h^2}{2}u_{xx} + \\dots) - 2u + (u - h u_x + \\frac{h^2}{2}u_{xx} - \\dots) \\right)\n$$\n$$\n= \\frac{1}{h^2} \\left( 2\\frac{h^2}{2}u_{xx} + 2\\frac{h^4}{24}u_{xxxx} + O(h^6) \\right) = \\frac{\\partial^2 u}{\\partial x^2} + \\frac{h^2}{12}\\frac{\\partial^4 u}{\\partial x^4} + O(h^4).\n$$\nAn identical result holds for the $y$-derivative.\nNow, we substitute these into the expression for $\\tau_{i,j}$:\n$$\n\\tau_{i,j} = (L_h u)_{i,j} = \\left( \\frac{\\partial^2 u}{\\partial x^2} + \\frac{h^2}{12}\\frac{\\partial^4 u}{\\partial x^4} + O(h^4) \\right) + \\left( \\frac{\\partial^2 u}{\\partial y^2} + \\frac{h^2}{12}\\frac{\\partial^4 u}{\\partial y^4} + O(h^4) \\right) + k^2 u.\n$$\nGrouping terms:\n$$\n\\tau_{i,j} = \\left( \\frac{\\partial^2 u}{\\partial x^2} + \\frac{\\partial^2 u}{\\partial y^2} + k^2 u \\right) + \\frac{h^2}{12} \\left( \\frac{\\partial^4 u}{\\partial x^4} + \\frac{\\partial^4 u}{\\partial y^4} \\right) + O(h^4).\n$$\nThe term in the first parenthesis is the continuous Helmholtz operator applied to $u = u^{\\text{inc}}$. Since $u^{\\text{inc}}$ is an exact solution, this term is zero:\n$$\n\\Delta u^{\\text{inc}} + k^2 u^{\\text{inc}} = 0.\n$$\nTherefore, the local truncation error is:\n$$\n\\tau_{i,j} = \\frac{h^2}{12} \\left( \\frac{\\partial^4 u^{\\text{inc}}}{\\partial x^4} + \\frac{\\partial^4 u^{\\text{inc}}}{\\partial y^4} \\right) + O(h^4).\n$$\nThe leading-order term in the LTE is of order $h^2$. The formal order of accuracy, $m$, is the exponent of $h$ in this leading term. Thus, $m=2$. The assumption of stability ensures that the global error of the solution $u_h$ has the same order as the LTE.",
            "answer": "$$\n\\boxed{2}\n$$"
        },
        {
            "introduction": "Building upon the foundational concepts, this practice explores a more advanced implementation typical of modern Finite-Difference Time-Domain (FDTD) solvers. You will derive the TF/SF correction terms for a fourth-order accurate scheme on a staggered grid, a common setup that enhances accuracy and stability. This exercise highlights the intricacies of implementing high-order methods, requiring careful derivation of both the spatial difference operators and the interpolation schemes needed to couple fields at the TF/SF interface .",
            "id": "4148468",
            "problem": "Consider one-dimensional linear acoustics in a homogeneous, lossless medium of constant mass density $\\rho_{0}$ and sound speed $c$, governed by the first-order system\n$$\n\\partial_{t} p(x,t) \\;=\\; -\\,\\rho_{0}\\,c^{2}\\,\\partial_{x} u(x,t),\n\\qquad\n\\partial_{t} u(x,t) \\;=\\; -\\,\\frac{1}{\\rho_{0}}\\,\\partial_{x} p(x,t),\n$$\nwhere $p$ is acoustic pressure and $u$ is particle velocity. Let a uniform staggered grid be used: pressure $p_{i}^{n}$ stored at integer spatial indices $x_{i} = i\\,\\Delta x$ and integer time $t^{n} = n\\,\\Delta t$, while velocity $u_{i+1/2}^{n+1/2}$ is stored at half spatial indices $x_{i+1/2} = (i+\\tfrac{1}{2})\\,\\Delta x$ and half time $t^{n+1/2} = (n+\\tfrac{1}{2})\\,\\Delta t$. The updates are the standard leapfrog form,\n$$\nu_{i+1/2}^{\\,n+1/2} \\;=\\; u_{i+1/2}^{\\,n-1/2} \\;-\\; \\frac{\\Delta t}{\\rho_{0}}\\,\\big(D_{x} p\\big)_{i+1/2}^{\\,n},\n\\qquad\np_{i}^{\\,n+1} \\;=\\; p_{i}^{\\,n} \\;-\\; \\rho_{0} c^{2} \\Delta t\\,\\big(D_{x} u\\big)_{i}^{\\,n+1/2},\n$$\nwhere $\\big(D_{x} p\\big)_{i+1/2}$ and $\\big(D_{x} u\\big)_{i}$ are discrete approximations to $\\partial_{x} p$ and $\\partial_{x} u$ at the respective grid locations. Assume both spatial derivatives are approximated by fourth-order accurate central finite differences formed from the minimal symmetric stencil consistent with the staggering.\n\nA Total-Field/Scattered-Field (TF/SF) formulation is used to inject a known right-traveling incident plane wave into the computational domain. In the Total-Field/Scattered-Field (TF/SF) method, the computational domain is partitioned at an interface index $i = i_{b}$ such that for $i \\le i_{b}$ the total field is advanced, while for $i > i_{b}$ only the scattered field is updated. At the TF/SF interface, the fourth-order stencil for $\\big(D_{x} u\\big)_{i_{b}}$ in the pressure update spans half-grid velocity values $u_{i_{b}-3/2}^{\\,n+1/2}$, $u_{i_{b}-1/2}^{\\,n+1/2}$, $u_{i_{b}+1/2}^{\\,n+1/2}$, and $u_{i_{b}+3/2}^{\\,n+1/2}$, where the two rightmost terms lie outside the total-field region and must be supplied consistently with the incident wave. The incident pressure field $p_{\\text{inc}}(x,t)$ is assumed analytic and right-going, so that $u_{\\text{inc}}(x,t) = p_{\\text{inc}}(x,t)/(\\rho_{0} c)$. To couple the incident field to the staggered velocity locations, use fourth-order accurate midpoint interpolation to evaluate $u_{\\text{inc}}$ at $x_{i+1/2}$ from four neighboring integer pressure samples $\\{p_{\\text{inc}}(x_{i-1},t), p_{\\text{inc}}(x_{i},t), p_{\\text{inc}}(x_{i+1},t), p_{\\text{inc}}(x_{i+2},t)\\}$.\n\nStarting from the continuous governing equations and Taylor-series expansions about the interface, derive:\n1. The fourth-order accurate central-difference stencil for $\\big(D_{x} u\\big)_{i}$ on the staggered grid in terms of $u_{i\\pm1/2}$ and $u_{i\\pm3/2}$.\n2. The fourth-order accurate midpoint interpolation formula for $u_{\\text{inc},\\,i+1/2}(t)$ in terms of four neighboring incident pressure samples at integer locations and the relation $u_{\\text{inc}} = p_{\\text{inc}}/(\\rho_{0}c)$.\n3. The explicit Total-Field/Scattered-Field correction term $\\mathcal{C}_{p}(i_{b})$ that must be added to the pressure update at index $i_{b}$, obtained by matching the incident flux contributions from the ghost half-grid velocities $u_{i_{b}+1/2}^{\\,n+1/2}$ and $u_{i_{b}+3/2}^{\\,n+1/2}$ via the interpolation in item 2.\n\nExpress your final answer as a single closed-form analytic expression for $\\mathcal{C}_{p}(i_{b})$ in terms of the incident pressure samples $\\{p_{\\text{inc},\\,j}^{\\,n+1/2}\\}$ at $j \\in \\{i_{b}-1, i_{b}, i_{b}+1, i_{b}+2, i_{b}+3\\}$, and the constants $c$, $\\Delta t$, and $\\Delta x$. No numerical rounding is required. Do not include units in your final boxed answer.",
            "solution": "The linearized first-order acoustics system provides the continuous flux forms that underpin the finite-difference update operators. On the staggered grid, the leapfrog scheme updates $u$ using the spatial derivative of $p$ at half steps, and $p$ using the derivative of $u$ at integer steps. To construct fourth-order accurate central-difference operators on the given staggering, we use Taylor expansions about the target spatial location and assemble symmetric stencils that cancel lower-order truncation terms.\n\nFirst, derive the fourth-order central difference for $\\big(D_{x} u\\big)_{i}$ at integer $x_{i}$ using staggered half indices. Consider the generic symmetric four-point approximation\n$$\n\\big(D_{x} u\\big)_{i} \\;\\approx\\; \\frac{1}{\\Delta x}\\,\\Big[\\,a\\,\\big(u_{i+1/2}-u_{i-1/2}\\big) \\;+\\; b\\,\\big(u_{i+3/2}-u_{i-3/2}\\big)\\,\\Big],\n$$\nwith unknown coefficients $a$ and $b$ to be determined such that the approximation is fourth-order accurate. Expand $u_{i\\pm 1/2}$ and $u_{i\\pm 3/2}$ in Taylor series around $x_{i}$:\n$$\nu_{i\\pm 1/2} \\;=\\; u(x_{i}) \\;\\pm\\; \\tfrac{1}{2}\\Delta x\\,u'(x_{i}) \\;+\\; \\tfrac{1}{8}\\Delta x^{2}\\,u''(x_{i}) \\;\\pm\\; \\tfrac{1}{48}\\Delta x^{3}\\,u^{(3)}(x_{i}) \\;+\\; \\tfrac{1}{384}\\Delta x^{4}\\,u^{(4)}(x_{i}) \\;+\\; \\mathcal{O}(\\Delta x^{5}),\n$$\n$$\nu_{i\\pm 3/2} \\;=\\; u(x_{i}) \\;\\pm\\; \\tfrac{3}{2}\\Delta x\\,u'(x_{i}) \\;+\\; \\tfrac{9}{8}\\Delta x^{2}\\,u''(x_{i}) \\;\\pm\\; \\tfrac{27}{48}\\Delta x^{3}\\,u^{(3)}(x_{i}) \\;+\\; \\tfrac{81}{384}\\Delta x^{4}\\,u^{(4)}(x_{i}) \\;+\\; \\mathcal{O}(\\Delta x^{5}).\n$$\nForm the differences:\n$$\nu_{i+1/2}-u_{i-1/2} \\;=\\; \\Delta x\\,u'(x_{i}) \\;+\\; \\tfrac{1}{24}\\Delta x^{3}\\,u^{(3)}(x_{i}) \\;+\\; \\mathcal{O}(\\Delta x^{5}),\n$$\n$$\nu_{i+3/2}-u_{i-3/2} \\;=\\; 3\\,\\Delta x\\,u'(x_{i}) \\;+\\; \\tfrac{27}{24}\\Delta x^{3}\\,u^{(3)}(x_{i}) \\;+\\; \\mathcal{O}(\\Delta x^{5}).\n$$\nSubstitute into the approximation and collect terms:\n$$\n\\frac{1}{\\Delta x}\\,\\Big[\\,a\\,(u_{i+1/2}-u_{i-1/2}) + b\\,(u_{i+3/2}-u_{i-3/2})\\Big]\n\\;=\\; (a + 3b)\\,u'(x_{i}) \\;+\\; \\Big(\\tfrac{a}{24} + \\tfrac{27b}{24}\\Big)\\,\\Delta x^{2}\\,u^{(3)}(x_{i}) \\;+\\; \\mathcal{O}(\\Delta x^{4}).\n$$\nFor fourth-order accuracy, we require $a + 3b = 1$ to match the first derivative and $\\tfrac{a}{24} + \\tfrac{27b}{24} = 0$ to cancel the $\\Delta x^{2}u^{(3)}$ term. Solving,\n$$\na + 3b = 1,\\qquad a + 27b = 0 \\;\\;\\Rightarrow\\;\\; b = -\\,\\frac{1}{24},\\quad a = \\frac{9}{8}.\n$$\nThus,\n$$\n\\big(D_{x} u\\big)_{i} \\;=\\; \\frac{1}{\\Delta x}\\,\\left[\\,\\frac{9}{8}\\,\\big(u_{i+1/2}-u_{i-1/2}\\big) \\;-\\; \\frac{1}{24}\\,\\big(u_{i+3/2}-u_{i-3/2}\\big)\\,\\right] \\;+\\; \\mathcal{O}(\\Delta x^{4}).\n$$\nBy identical reasoning on the opposite staggering, the fourth-order central difference for $\\big(D_{x} p\\big)_{i+1/2}$ is\n$$\n\\big(D_{x} p\\big)_{i+1/2} \\;=\\; \\frac{1}{\\Delta x}\\,\\left[\\,\\frac{9}{8}\\,\\big(p_{i+1}-p_{i}\\big) \\;-\\; \\frac{1}{24}\\,\\big(p_{i+2}-p_{i-1}\\big)\\,\\right] \\;+\\; \\mathcal{O}(\\Delta x^{4}).\n$$\n\nSecond, derive the fourth-order midpoint interpolation formula mapping integer pressure samples to a half-index velocity location. Consider a generic midpoint interpolation for a smooth function $f$:\n$$\nf_{i+1/2} \\;\\approx\\; w_{-1}\\,f_{i-1} \\;+\\; w_{0}\\,f_{i} \\;+\\; w_{1}\\,f_{i+1} \\;+\\; w_{2}\\,f_{i+2},\n$$\nwith weights $\\{w_{-1},w_{0},w_{1},w_{2}\\}$ chosen so the approximation is fourth-order accurate at $x_{i+1/2}$. Use Taylor expansions about $x_{i}$:\n$$\nf_{i-1} = f(x_{i}) - \\Delta x\\,f'(x_{i}) + \\tfrac{1}{2}\\Delta x^{2}\\,f''(x_{i}) - \\tfrac{1}{6}\\Delta x^{3}\\,f^{(3)}(x_{i}) + \\tfrac{1}{24}\\Delta x^{4}\\,f^{(4)}(x_{i}) + \\cdots,\n$$\n$$\nf_{i} = f(x_{i}),\n\\qquad\nf_{i+1} = f(x_{i}) + \\Delta x\\,f'(x_{i}) + \\tfrac{1}{2}\\Delta x^{2}\\,f''(x_{i}) + \\tfrac{1}{6}\\Delta x^{3}\\,f^{(3)}(x_{i}) + \\tfrac{1}{24}\\Delta x^{4}\\,f^{(4)}(x_{i}) + \\cdots,\n$$\n$$\nf_{i+2} = f(x_{i}) + 2\\Delta x\\,f'(x_{i}) + 2\\Delta x^{2}\\,f''(x_{i}) + \\tfrac{4}{3}\\Delta x^{3}\\,f^{(3)}(x_{i}) + \\tfrac{2}{3}\\Delta x^{4}\\,f^{(4)}(x_{i}) + \\cdots.\n$$\nAlso,\n$$\nf(x_{i+1/2}) = f(x_{i}) + \\tfrac{1}{2}\\Delta x\\,f'(x_{i}) + \\tfrac{1}{8}\\Delta x^{2}\\,f''(x_{i}) + \\tfrac{1}{48}\\Delta x^{3}\\,f^{(3)}(x_{i}) + \\tfrac{1}{384}\\Delta x^{4}\\,f^{(4)}(x_{i}) + \\cdots.\n$$\nMatch coefficients up to $\\Delta x^{4}$ by imposing\n$$\nw_{-1}+w_{0}+w_{1}+w_{2} = 1,\n$$\n$$\n(-1)w_{-1} + 0\\cdot w_{0} + 1\\cdot w_{1} + 2 w_{2} = \\tfrac{1}{2},\n$$\n$$\n\\tfrac{1}{2}w_{-1} + 0\\cdot w_{0} + \\tfrac{1}{2}w_{1} + 2 w_{2} = \\tfrac{1}{8},\n$$\n$$\n-\\tfrac{1}{6}w_{-1} + 0\\cdot w_{0} + \\tfrac{1}{6}w_{1} + \\tfrac{4}{3} w_{2} = \\tfrac{1}{48},\n$$\n$$\n\\tfrac{1}{24}w_{-1} + 0\\cdot w_{0} + \\tfrac{1}{24}w_{1} + \\tfrac{2}{3} w_{2} = \\tfrac{1}{384}.\n$$\nSolving this system yields the unique fourth-order midpoint weights\n$$\nw_{-1} = -\\,\\frac{1}{16},\\qquad w_{0} = \\frac{9}{16},\\qquad w_{1} = \\frac{9}{16},\\qquad w_{2} = -\\,\\frac{1}{16}.\n$$\nTherefore, the required interpolation for the incident velocity at half indices, exploiting the right-traveling plane-wave relation $u_{\\text{inc}} = p_{\\text{inc}}/(\\rho_{0}c)$, is\n$$\nu_{\\text{inc},\\,i+1/2}(t) \\;=\\; \\frac{1}{\\rho_{0} c}\\,\\Big[\\,-\\frac{1}{16}\\,p_{\\text{inc},\\,i-1}(t) \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i}(t) \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i+1}(t) \\;-\\; \\frac{1}{16}\\,p_{\\text{inc},\\,i+2}(t)\\,\\Big].\n$$\n\nThird, derive the Total-Field/Scattered-Field correction. At the interface index $i = i_{b}$, the fourth-order stencil for $\\big(D_{x} u\\big)_{i_{b}}$ appearing in the pressure update includes half-grid velocity values from both sides of the interface:\n$$\n\\big(D_{x} u\\big)_{i_{b}} \\;=\\; \\frac{1}{\\Delta x}\\,\\left[\\,\\frac{9}{8}\\,\\big(u_{i_{b}+1/2}-u_{i_{b}-1/2}\\big) \\;-\\; \\frac{1}{24}\\,\\big(u_{i_{b}+3/2}-u_{i_{b}-3/2}\\big)\\,\\right].\n$$\nThe values $u_{i_{b}-1/2}^{\\,n+1/2}$ and $u_{i_{b}-3/2}^{\\,n+1/2}$ lie inside the total-field region and are advanced as total field, so no correction is needed there. The values $u_{i_{b}+1/2}^{\\,n+1/2}$ and $u_{i_{b}+3/2}^{\\,n+1/2}$ lie outside; to inject the incident wave consistently, the discrete flux contributed by these ghost points must equal that of the incident field. Therefore, the correction to add to the pressure update at $i_{b}$ at time $n+1$ is the incident flux contribution from those ghost half-grid points:\n$$\n\\mathcal{C}_{p}(i_{b}) \\;=\\; -\\,\\rho_{0} c^{2}\\,\\Delta t\\;\\frac{1}{\\Delta x}\\,\\left[\\,\\frac{9}{8}\\,u_{\\text{inc},\\,i_{b}+1/2}^{\\,n+1/2} \\;-\\; \\frac{1}{24}\\,u_{\\text{inc},\\,i_{b}+3/2}^{\\,n+1/2}\\,\\right].\n$$\nApply the midpoint interpolation for each required half index:\n$$\nu_{\\text{inc},\\,i_{b}+1/2}^{\\,n+1/2} \\;=\\; \\frac{1}{\\rho_{0} c}\\,\\Big[\\,-\\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}-1}^{\\,n+1/2} \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2} \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2} \\;-\\; \\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2}\\,\\Big],\n$$\n$$\nu_{\\text{inc},\\,i_{b}+3/2}^{\\,n+1/2} \\;=\\; \\frac{1}{\\rho_{0} c}\\,\\Big[\\,-\\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2} \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2} \\;+\\; \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2} \\;-\\; \\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}+3}^{\\,n+1/2}\\,\\Big].\n$$\nSubstitute and simplify using $-\\rho_{0} c^{2} \\times (1/(\\rho_{0} c)) = -\\,c$:\n$$\n\\mathcal{C}_{p}(i_{b}) \\;=\\; -\\,\\frac{c\\,\\Delta t}{\\Delta x}\\,\\Bigg\\{\n\\frac{9}{8}\\,\\Big[\\,-\\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}-1}^{\\,n+1/2} + \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2} + \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2} - \\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2}\\Big]\n\\;-\\;\n\\frac{1}{24}\\,\\Big[\\,-\\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2} + \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2} + \\frac{9}{16}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2} - \\frac{1}{16}\\,p_{\\text{inc},\\,i_{b}+3}^{\\,n+1/2}\\Big]\n\\Bigg\\}.\n$$\nCombine coefficients for each integer index:\n- At $i_{b}-1$: coefficient $-\\tfrac{9}{8}\\cdot\\tfrac{1}{16} = -\\tfrac{9}{128}$.\n- At $i_{b}$: coefficient $\\tfrac{9}{8}\\cdot\\tfrac{9}{16} + \\tfrac{1}{24}\\cdot\\tfrac{1}{16} = \\tfrac{81}{128} + \\tfrac{1}{384} = \\tfrac{244}{384} = \\tfrac{61}{96}$.\n- At $i_{b}+1$: coefficient $\\tfrac{9}{8}\\cdot\\tfrac{9}{16} - \\tfrac{1}{24}\\cdot\\tfrac{9}{16} = \\tfrac{81}{128} - \\tfrac{9}{384} = \\tfrac{234}{384} = \\tfrac{39}{64}$.\n- At $i_{b}+2$: coefficient $-\\tfrac{9}{8}\\cdot\\tfrac{1}{16} - \\tfrac{1}{24}\\cdot\\tfrac{9}{16} = -\\tfrac{9}{128} - \\tfrac{9}{384} = -\\tfrac{36}{384} = -\\tfrac{3}{32}$.\n- At $i_{b}+3$: coefficient $\\tfrac{1}{24}\\cdot\\tfrac{1}{16} = \\tfrac{1}{384}$.\n\nTherefore, the closed-form TF/SF correction term is\n$$\n\\mathcal{C}_{p}(i_{b}) \\;=\\; -\\,\\frac{c\\,\\Delta t}{\\Delta x}\\,\\left[\\,-\\frac{9}{128}\\,p_{\\text{inc},\\,i_{b}-1}^{\\,n+1/2} \\;+\\; \\frac{61}{96}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2} \\;+\\; \\frac{39}{64}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2} \\;-\\; \\frac{3}{32}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2} \\;+\\; \\frac{1}{384}\\,p_{\\text{inc},\\,i_{b}+3}^{\\,n+1/2} \\right].\n$$\nThis expression implements the incident flux matching at the TF/SF interface for the fourth-order finite-difference scheme, using fourth-order midpoint interpolation to populate the required ghost half-grid velocities from known incident pressure samples.",
            "answer": "$$\\boxed{-\\frac{c\\,\\Delta t}{\\Delta x}\\left[-\\frac{9}{128}\\,p_{\\text{inc},\\,i_{b}-1}^{\\,n+1/2}+\\frac{61}{96}\\,p_{\\text{inc},\\,i_{b}}^{\\,n+1/2}+\\frac{39}{64}\\,p_{\\text{inc},\\,i_{b}+1}^{\\,n+1/2}-\\frac{3}{32}\\,p_{\\text{inc},\\,i_{b}+2}^{\\,n+1/2}+\\frac{1}{384}\\,p_{\\text{inc},\\,i_{b}+3}^{\\,n+1/2}\\right]}$$"
        },
        {
            "introduction": "This final practice moves from derivation to validation, a critical step in developing reliable simulation tools. You will implement a semi-analytical model to quantify the errors caused by numerical dispersion in a TF/SF simulation and test a common mitigation strategy: dispersion compensation. By comparing the far-field scattering directivity from your model with an exact solution, you will gain hands-on experience in diagnosing numerical artifacts and evaluating the effectiveness of techniques designed to improve simulation fidelity .",
            "id": "4148475",
            "problem": "Consider the two-dimensional acoustic wave equation for the acoustic pressure field $p(x,y,t)$ in a homogeneous medium with constant sound speed $c$, given by the partial differential equation $$\\frac{\\partial^2 p}{\\partial t^2} = c^2 \\nabla^2 p.$$ In numerical simulations using the Finite Difference Time Domain (FDTD) method, the Total-Field/Scattered-Field (TF/SF) formulation injects an incident plane wave into the computational domain. When using a second-order centered FDTD scheme on a uniform Cartesian grid with spatial step $\\Delta x = \\Delta y$ and time step $\\Delta t$, numerical phase velocity is dispersive and anisotropic. Consequently, a plane-wave injection at physical angular frequency $\\omega_{\\mathrm{phys}}$ will propagate with a direction-dependent numerical wavenumber $k_{\\mathrm{num}}(\\omega,\\theta)$ that differs from the physical wavenumber $k_{\\mathrm{phys}} = \\omega_{\\mathrm{phys}}/c$.\n\nAssume scattering from a sound-hard (Neumann) circular cylinder of radius $a$ under plane-wave incidence at angle $\\phi_{\\mathrm{inc}}$ in a two-dimensional (cylindrical) geometry. The exact continuous-field scattered pressure admits a separable series solution. In the far field at a fixed observation radius $r_{\\mathrm{ff}}$ and observation angle $\\psi$, the scattered field can be computed from a modal expansion whose coefficients depend on the boundary condition and $k a$, and whose outgoing waves are represented by Hankel functions of the first kind evaluated at $k r_{\\mathrm{ff}}$. In TF/SF, dispersion compensation modifies the injected angular frequency so that the direction-dependent numerical wavenumber along the injection direction matches the physical wavenumber. Specifically, for a given incident direction $\\phi_{\\mathrm{inc}}$, one can choose $\\omega_{\\mathrm{comp}}$ such that the injection produces $k_{\\mathrm{num}}(\\omega_{\\mathrm{comp}},\\phi_{\\mathrm{inc}}) = k_{\\mathrm{phys}}$.\n\nStarting from the acoustic wave equation and the sound-hard boundary condition $\\partial p/\\partial n = 0$ at the cylinder surface, and using the well-tested separable series solution for plane-wave scattering by a circular cylinder along with the discrete dispersion relation of the second-order centered FDTD scheme on a uniform grid, implement the following validation program for the TF/SF injection:\n\n1. Derive and use the discrete dispersion relation to obtain the numerical wavenumber $k_{\\mathrm{num}}(\\omega,\\theta)$ for a plane wave at angular frequency $\\omega$ propagating at angle $\\theta$ relative to the $x$-axis on a grid with step $\\Delta x$ and time step $\\Delta t$. Use this relation to:\n   - Compute the no-compensation injection, where $\\omega = \\omega_{\\mathrm{phys}}$, producing $k_{\\mathrm{in}}^{\\mathrm{no}} = k_{\\mathrm{num}}(\\omega_{\\mathrm{phys}},\\phi_{\\mathrm{inc}})$ and direction-dependent outgoing $k_{\\mathrm{out}}^{\\mathrm{no}}(\\psi) = k_{\\mathrm{num}}(\\omega_{\\mathrm{phys}},\\psi)$.\n   - Compute the compensation injection, where $\\omega = \\omega_{\\mathrm{comp}}$ is chosen so that $k_{\\mathrm{num}}(\\omega_{\\mathrm{comp}},\\phi_{\\mathrm{inc}}) = k_{\\mathrm{phys}}$, producing $k_{\\mathrm{in}}^{\\mathrm{comp}} = k_{\\mathrm{phys}}$ and outgoing $k_{\\mathrm{out}}^{\\mathrm{comp}}(\\psi) = k_{\\mathrm{num}}(\\omega_{\\mathrm{comp}},\\psi)$.\n   - For the exact continuous-field reference, use $k_{\\mathrm{in}}^{\\mathrm{exact}} = k_{\\mathrm{phys}}$ and $k_{\\mathrm{out}}^{\\mathrm{exact}}(\\psi) = k_{\\mathrm{phys}}$.\n\n2. For the sound-hard cylinder, compute the scattered field modal coefficients at the boundary using the Neumann boundary condition, and evaluate the far-field scattered pressure at radius $r_{\\mathrm{ff}}$ and angles $\\psi$ using the Hankel functions of the first kind. Construct the far-field directivity as the magnitude of the scattered field normalized by its maximum over $\\psi$.\n\n3. For each incident angle $\\phi_{\\mathrm{inc}}$ in a sweep, compute the root-mean-square (RMS) directivity error for no-compensation and compensation by comparing their predicted directivities against the exact continuous-field directivity. Aggregate the RMS errors across the angle sweep by taking the arithmetic mean for each injection type. Report the mean error reduction defined as $\\overline{E}_{\\mathrm{no}} - \\overline{E}_{\\mathrm{comp}}$, where $\\overline{E}_{\\mathrm{no}}$ and $\\overline{E}_{\\mathrm{comp}}$ are the mean RMS directivity errors across the angle sweep, respectively.\n\nPhysical and numerical units must be used consistently: sound speed $c$ in meters per second (m/s), frequency $f$ in Hertz (Hz), angular frequency $\\omega = 2 \\pi f$ in radians per second, radius $a$ and grid step $\\Delta x$ in meters (m), time step $\\Delta t$ in seconds (s), and angles $\\phi_{\\mathrm{inc}}$ and $\\psi$ in radians.\n\nYour program must produce a single line of output containing the mean error reduction (dimensionless) for each test case as a comma-separated list enclosed in square brackets. Use the following test suite to exercise different regimes:\n\n- Test Case 1 (happy path):\n  - $c = 343$ m/s\n  - $f_{\\mathrm{phys}} = 3000$ Hz\n  - $a = 0.05$ m\n  - $\\Delta x = 0.01$ m\n  - Courant number $S = c \\Delta t / \\Delta x = 0.5$ (compute $\\Delta t$ from $S$)\n  - $r_{\\mathrm{ff}} = 10.0$ m\n  - Incident angles $\\phi_{\\mathrm{inc}} \\in \\{0, \\pi/6, \\pi/4, \\pi/3, \\pi/2\\}$\n\n- Test Case 2 (dispersion-stressed, near stability boundary):\n  - $c = 343$ m/s\n  - $f_{\\mathrm{phys}} = 5700$ Hz\n  - $a = 0.02$ m\n  - $\\Delta x = 0.01$ m\n  - $S = 0.7$\n  - $r_{\\mathrm{ff}} = 8.0$ m\n  - Incident angles $\\phi_{\\mathrm{inc}} \\in \\{0, \\pi/8, \\pi/4, 3\\pi/8, \\pi/2\\}$\n\n- Test Case 3 (finer grid, small scatterer):\n  - $c = 343$ m/s\n  - $f_{\\mathrm{phys}} = 4500$ Hz\n  - $a = 0.01$ m\n  - $\\Delta x = 0.008$ m\n  - $S = 0.6$\n  - $r_{\\mathrm{ff}} = 6.0$ m\n  - Incident angles $\\phi_{\\mathrm{inc}} \\in \\{0, \\pi/6, \\pi/3, \\pi/2\\}$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\").",
            "solution": "The objective is to validate a dispersion compensation technique for the Total-Field/Scattered-Field (TF/SF) formulation in the Finite-Difference Time-Domain (FDTD) method for acoustic wave scattering. This is accomplished by comparing the far-field directivity patterns predicted by a semi-analytical model incorporating FDTD numerical dispersion against an exact analytical solution. The model considers three cases: the exact continuous field, the uncompensated FDTD field, and the dispersion-compensated FDTD field.\n\nThe analysis begins with the two-dimensional acoustic wave equation for pressure $p$ in a homogeneous medium with sound speed $c$:\n$$ \\frac{\\partial^2 p}{\\partial t^2} = c^2 \\left( \\frac{\\partial^2 p}{\\partial x^2} + \\frac{\\partial^2 p}{\\partial y^2} \\right) $$\nApplying a second-order centered finite-difference scheme on a uniform Cartesian grid with spatial step $\\Delta x = \\Delta y$ and time step $\\Delta t$, we discretize the equation. By substituting a discrete plane-wave trial solution of the form $p(i\\Delta x, j\\Delta y, n\\Delta t) \\propto \\exp[i(k_x i\\Delta x + k_y j\\Delta y - \\omega n\\Delta t)]$, we derive the numerical dispersion relation. This relation connects the numerical angular frequency $\\omega$ to the components of the numerical wavevector $\\mathbf{k}_{\\mathrm{num}} = (k_x, k_y)$. Let $\\theta$ be the propagation angle of the plane wave relative to the $x$-axis, such that $k_x = k_{\\mathrm{num}} \\cos\\theta$ and $k_y = k_{\\mathrm{num}} \\sin\\theta$. The dispersion relation is:\n$$ \\left( \\frac{\\sin(\\omega\\Delta t/2)}{\\Delta t} \\right)^2 = c^2 \\left[ \\left( \\frac{\\sin(k_{\\mathrm{num}} \\Delta x \\cos\\theta/2)}{\\Delta x} \\right)^2 + \\left( \\frac{\\sin(k_{\\mathrm{num}} \\Delta x \\sin\\theta/2)}{\\Delta x} \\right)^2 \\right] $$\nDefining the Courant number $S = c \\Delta t / \\Delta x$, the relation simplifies to:\n$$ \\frac{\\sin^2(\\omega\\Delta t/2)}{S^2} = \\sin^2\\left(\\frac{k_{\\mathrm{num}} \\Delta x \\cos\\theta}{2}\\right) + \\sin^2\\left(\\frac{k_{\\mathrm{num}} \\Delta x \\sin\\theta}{2}\\right) $$\nThis is a transcendental equation that must be solved numerically for the numerical wavenumber $k_{\\mathrm{num}}(\\omega, \\theta)$ given $\\omega$ and $\\theta$. A root-finding algorithm, such as the Brent method, is suitable for this purpose.\n\nNext, we consider the scattering of a plane wave by a sound-hard circular cylinder of radius $a$. The incident plane wave, with amplitude $1$ and wavenumber $k$, propagating at an angle $\\phi_{\\mathrm{inc}}$, is given in cylindrical coordinates $(r, \\phi)$ by $p_{\\mathrm{inc}}(r, \\phi) = e^{ikr\\cos(\\phi - \\phi_{\\mathrm{inc}})}$. This can be expanded in a series of Bessel functions. The scattered field $p_{\\mathrm{scat}}$ must satisfy the Helmholtz equation and be an outgoing wave. It has a series form involving Hankel functions of the first kind, $H_m^{(1)}$:\n$$ p_{\\mathrm{scat}}(r, \\phi) = \\sum_{m=-\\infty}^{\\infty} A_m H_m^{(1)}(kr) e^{im\\phi} $$\nThe total field is $p = p_{\\mathrm{inc}} + p_{\\mathrm{scat}}$. The coefficients $A_m$ are determined by the sound-hard (Neumann) boundary condition, $\\partial p/\\partial r = 0$ at $r=a$. This leads to:\n$$ A_m = -i^m \\frac{J'_m(ka)}{H_m^{(1)\\prime}(ka)} e^{-im\\phi_{\\mathrm{inc}}} $$\nwhere $J'_m$ and $H_m^{(1)\\prime}$ are the derivatives of the Bessel and Hankel functions with respect to their argument. The far-field scattered pressure at an observation point $(r_{\\mathrm{ff}}, \\psi)$ can be expressed as:\n$$ p_{\\mathrm{scat}}(r_{\\mathrm{ff}}, \\psi) = - \\sum_{m=0}^{\\infty} \\epsilon_m i^m \\frac{J'_m(k_{\\mathrm{in}}a)}{H_m^{(1)\\prime}(k_{\\mathrm{in}}a)} H_m^{(1)}(k_{\\mathrm{out}}(\\psi) r_{\\mathrm{ff}}) \\cos(m(\\psi - \\phi_{\\mathrm{inc}})) $$\nwhere $\\epsilon_0=1$ and $\\epsilon_m=2$ for $m>0$. This formulation allows us to model the numerical effects by using appropriate wavenumbers for the incident and scattered components.\n\nThree cases are analyzed:\n1.  **Exact Reference**: The medium is non-dispersive and isotropic. The incident wavenumber is the physical wavenumber, $k_{\\mathrm{in}}^{\\mathrm{exact}} = k_{\\mathrm{phys}} = \\omega_{\\mathrm{phys}}/c$. The outgoing wavenumber is also $k_{\\mathrm{out}}^{\\mathrm{exact}}(\\psi) = k_{\\mathrm{phys}}$ for all observation angles $\\psi$.\n2.  **No Compensation**: The injected wave has the physical angular frequency, $\\omega = \\omega_{\\mathrm{phys}}$. Due to numerical dispersion, the incident wavenumber becomes direction-dependent: $k_{\\mathrm{in}}^{\\mathrm{no}} = k_{\\mathrm{num}}(\\omega_{\\mathrm{phys}}, \\phi_{\\mathrm{inc}})$. The scattered waves also propagate with a direction-dependent wavenumber at the same frequency: $k_{\\mathrm{out}}^{\\mathrm{no}}(\\psi) = k_{\\mathrm{num}}(\\omega_{\\mathrm{phys}}, \\psi)$.\n3.  **Compensation**: The injection frequency $\\omega_{\\mathrm{comp}}$ is adjusted such that the numerical wavenumber along the incident direction matches the physical wavenumber: $k_{\\mathrm{num}}(\\omega_{\\mathrm{comp}}, \\phi_{\\mathrm{inc}}) = k_{\\mathrm{phys}}$. This determines $\\omega_{\\mathrm{comp}}$. The incident wavenumber is thus $k_{\\mathrm{in}}^{\\mathrm{comp}} = k_{\\mathrm{phys}}$. However, the scattered waves propagate away from the object at different angles, so their wavenumbers are determined by the compensated frequency and their direction of travel: $k_{\\mathrm{out}}^{\\mathrm{comp}}(\\psi) = k_{\\mathrm{num}}(\\omega_{\\mathrm{comp}}, \\psi)$.\n\nFor each case and for each incident angle $\\phi_{\\mathrm{inc}}$ in a given sweep, we compute the far-field directivity pattern, defined as the magnitude of the scattered pressure, normalized by its maximum value over all observation angles $\\psi \\in [0, 2\\pi)$. The root-mean-square (RMS) error of the directivity patterns from the no-compensation and compensation models is then calculated with respect to the exact reference pattern. These RMS errors, $E_{\\mathrm{no}}$ and $E_{\\mathrm{comp}}$, are averaged over the sweep of incident angles to yield $\\overline{E}_{\\mathrm{no}}$ and $\\overline{E}_{\\mathrm{comp}}$. The final metric is the mean error reduction, $\\overline{E}_{\\mathrm{no}} - \\overline{E}_{\\mathrm{comp}}$, which quantifies the improvement achieved by the compensation technique.",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import jv, jvp, yv, yvp, hankel1\nfrom scipy.optimize import brentq\n\ndef h1vp(v, z, n=1):\n    \"\"\"\n    Calculates the n-th derivative of the Hankel function of the first kind, H_v^(1)(z).\n    This is constructed from the derivatives of Bessel functions of the first and second kind.\n    \"\"\"\n    return jvp(v, z, n) + 1j * yvp(v, z, n)\n\ndef calculate_error_reduction(c, f_phys, a, dx, S, r_ff, phis_inc):\n    \"\"\"\n    Calculates the mean error reduction for a single test case.\n    \"\"\"\n    # Basic physical and numerical parameters\n    dt = S * dx / c\n    omega_phys = 2 * np.pi * f_phys\n    k_phys = omega_phys / c\n\n    def get_k_num(omega, theta, dx, dt, S):\n        \"\"\"\n        Solves the FDTD dispersion relation for the numerical wavenumber k_num.\n        \"\"\"\n        if omega  1e-9:\n            return 0.0\n        \n        # RHS of the dispersion relation root-finding equation\n        A_omega = np.sin(omega * dt / 2)**2 / S**2\n        \n        def dispersion_func(K, theta_val):\n            # K = k_num * dx / 2\n            return np.sin(K * np.cos(theta_val))**2 + np.sin(K * np.sin(theta_val))**2 - A_omega\n\n        try:\n            # Solve for K in the range [0, pi/2], corresponding to k_num in [0, pi/dx]\n            K_solution = brentq(dispersion_func, a=0, b=np.pi/2, args=(theta,), xtol=1e-12, rtol=1e-12)\n            k_num = 2 * K_solution / dx\n        except ValueError:\n            # This can occur if a solution doesn't exist in the interval,\n            # which implies a non-propagating (evanescent) wave.\n            return np.nan\n        return k_num\n\n    # Observation angles for directivity calculation\n    psi_angles = np.linspace(0, 2 * np.pi, 360, endpoint=False)\n    \n    memoized_k_num = {}\n    def get_k_num_memoized(omega, theta, dx_val, dt_val, S_val):\n        key = (omega, theta)\n        if key not in memoized_k_num:\n            memoized_k_num[key] = get_k_num(omega, theta, dx_val, dt_val, S_val)\n        return memoized_k_num[key]\n\n    def get_directivity(k_in, k_out_func, phi_inc, a, r_ff):\n        \"\"\"\n        Computes the normalized far-field directivity pattern.\n        \"\"\"\n        # Determine a safe upper limit for the summation order\n        M = int(np.ceil(np.real(k_in * a)) + 20)\n        m = np.arange(0, M + 1)\n        \n        # Modal coefficients depend on the incident field at the boundary\n        ka = k_in * a\n        jm_prime_ka = jvp(m, ka, 1)\n        hm_prime_ka = h1vp(m, ka, 1)\n        \n        # Ratio J_m' / H_m' to avoid large/small numbers\n        ratio = np.divide(jm_prime_ka, hm_prime_ka, out=np.zeros_like(jm_prime_ka, dtype=complex), where=np.abs(hm_prime_ka) > 1e-300)\n        \n        coeffs = -(1j)**m * ratio\n        \n        p_scat_magnitudes = np.zeros(len(psi_angles))\n        \n        epsilon = np.ones_like(m)\n        if M > 0:\n            epsilon[0] = 1\n            epsilon[1:] = 2\n\n        for i, psi in enumerate(psi_angles):\n            k_out = k_out_func(psi)\n            if k_out == 0 or np.isnan(k_out):\n                p_scat = 0.0\n            else:\n                kr_ff = k_out * r_ff\n                \n                cos_terms = np.cos(m * (psi - phi_inc))\n                hankel_terms = hankel1(m, kr_ff)\n                \n                series_sum = np.sum(epsilon * coeffs * hankel_terms * cos_terms)\n                p_scat = -series_sum\n            p_scat_magnitudes[i] = np.abs(p_scat)\n\n        # Normalize directivity\n        max_mag = np.max(p_scat_magnitudes)\n        return p_scat_magnitudes / max_mag if max_mag > 0 else np.zeros_like(p_scat_magnitudes)\n\n    errors_no_comp = []\n    errors_comp = []\n    \n    for phi_inc in phis_inc:\n        memoized_k_num.clear() # Clear memoization for each new phi_inc\n        k_out_no_comp_func_memo = lambda psi: get_k_num_memoized(omega_phys, psi, dx, dt, S)\n\n        # --- Exact Case ---\n        k_in_exact = k_phys\n        directivity_exact = get_directivity(k_in_exact, lambda psi: k_phys, phi_inc, a, r_ff)\n\n        # --- No-Compensation Case ---\n        k_in_no_comp = get_k_num_memoized(omega_phys, phi_inc, dx, dt, S)\n        directivity_no_comp = get_directivity(k_in_no_comp, k_out_no_comp_func_memo, phi_inc, a, r_ff)\n\n        # --- Compensation Case ---\n        K_phys = k_phys * dx / 2\n        rhs_sqrt = np.sqrt(np.sin(K_phys * np.cos(phi_inc))**2 + np.sin(K_phys * np.sin(phi_inc))**2)\n        arg_asin = S * rhs_sqrt\n        if arg_asin > 1.0: arg_asin = 1.0 # Clamp due to potential FP error\n        omega_comp = (2 / dt) * np.arcsin(arg_asin)\n        \n        k_in_comp = k_phys\n        k_out_comp_func_memo = lambda psi: get_k_num_memoized(omega_comp, psi, dx, dt, S)\n        directivity_comp = get_directivity(k_in_comp, k_out_comp_func_memo, phi_inc, a, r_ff)\n\n        # --- Calculate RMS Errors ---\n        rms_error_no_comp = np.sqrt(np.mean((directivity_no_comp - directivity_exact)**2))\n        rms_error_comp = np.sqrt(np.mean((directivity_comp - directivity_exact)**2))\n        \n        errors_no_comp.append(rms_error_no_comp)\n        errors_comp.append(rms_error_comp)\n\n    mean_error_no_comp = np.mean(errors_no_comp)\n    mean_error_comp = np.mean(errors_comp)\n    \n    return mean_error_no_comp - mean_error_comp\n\ndef solve():\n    test_cases = [\n        # Test Case 1\n        {\n            \"c\": 343.0, \"f_phys\": 3000.0, \"a\": 0.05, \"dx\": 0.01,\n            \"S\": 0.5, \"r_ff\": 10.0,\n            \"phis_inc\": [0, np.pi/6, np.pi/4, np.pi/3, np.pi/2]\n        },\n        # Test Case 2\n        {\n            \"c\": 343.0, \"f_phys\": 5700.0, \"a\": 0.02, \"dx\": 0.01,\n            \"S\": 0.7, \"r_ff\": 8.0,\n            \"phis_inc\": [0, np.pi/8, np.pi/4, 3*np.pi/8, np.pi/2]\n        },\n        # Test Case 3\n        {\n            \"c\": 343.0, \"f_phys\": 4500.0, \"a\": 0.01, \"dx\": 0.008,\n            \"S\": 0.6, \"r_ff\": 6.0,\n            \"phis_inc\": [0, np.pi/6, np.pi/3, np.pi/2]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_error_reduction(**case)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}