{
    "hands_on_practices": [
        {
            "introduction": "A foundational concept in chemical kinetics is the distinction between thermodynamic equilibrium and finite-rate kinetics. This exercise provides a hands-on exploration of this concept for thermal $NO$ formation, the dominant mechanism at high temperatures. You will compute the $NO$ concentration under both the equilibrium assumption (infinite time) and for a kinetically-controlled Perfectly Stirred Reactor (PSR) with a finite residence time, allowing you to directly quantify the deviation and understand when a system is limited by reaction rates versus thermodynamic constraints .",
            "id": "4045120",
            "problem": "Consider a dry-air mixture entering a perfectly stirred reactor (PSR) at temperature $T$ and total pressure $P$, with inlet mole fractions $y_{\\mathrm{N_2,in}} = 0.79$, $y_{\\mathrm{O_2,in}} = 0.21$, and $y_{\\mathrm{NO,in}} = 0$. The only chemically active reaction is the reversible formation of nitric oxide (NO) from nitrogen and oxygen, written as $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$. The goal is to derive and compute the equilibrium mole fraction of nitric oxide and compare it to the nitric oxide mole fraction resulting from finite-rate kinetics in the PSR, including the effect of reburning modeled as an enhancement of the backward rate.\n\nFundamental base and assumptions:\n\n- Ideal gas: $p_i = y_i P$, and $C_{\\mathrm{tot}} = P/(R T)$, where $R$ is the universal gas constant.\n- Thermodynamic equilibrium constant: $K_p(T) = \\exp\\!\\left(-\\Delta G^\\circ(T)/(R T)\\right)$, where $\\Delta G^\\circ(T)$ is the standard Gibbs free energy change of the reaction at temperature $T$.\n- Standard molar properties at $T = 298\\,\\mathrm{K}$ and constant heat capacities over the temperature range of interest:\n    - Standard enthalpy of formation: $\\Delta H_f^\\circ(\\mathrm{NO},298\\,\\mathrm{K}) = 90250\\,\\mathrm{J/mol}$, $\\Delta H_f^\\circ(\\mathrm{N_2},298\\,\\mathrm{K}) = 0\\,\\mathrm{J/mol}$, $\\Delta H_f^\\circ(\\mathrm{O_2},298\\,\\mathrm{K}) = 0\\,\\mathrm{J/mol}$.\n    - Standard molar entropies: $s^\\circ(\\mathrm{NO},298\\,\\mathrm{K}) = 210.76\\,\\mathrm{J/(mol\\,K)}$, $s^\\circ(\\mathrm{N_2},298\\,\\mathrm{K}) = 191.61\\,\\mathrm{J/(mol\\,K)}$, $s^\\circ(\\mathrm{O_2},298\\,\\mathrm{K}) = 205.15\\,\\mathrm{J/(mol\\,K)}$.\n    - Constant isobaric heat capacities: $c_p(\\mathrm{NO}) = 33.0\\,\\mathrm{J/(mol\\,K)}$, $c_p(\\mathrm{N_2}) = 32.0\\,\\mathrm{J/(mol\\,K)}$, $c_p(\\mathrm{O_2}) = 34.0\\,\\mathrm{J/(mol\\,K)}$.\n- Thermodynamic functions with constant heat capacities:\n    - $h^\\circ_i(T) = \\Delta H_f^\\circ(i,298) + c_{p,i}\\,(T - 298)$.\n    - $s^\\circ_i(T) = s^\\circ_i(298) + c_{p,i}\\,\\ln(T/298)$.\n    - $g^\\circ_i(T) = h^\\circ_i(T) - T\\,s^\\circ_i(T)$.\n    - $\\Delta G^\\circ(T) = 2\\,g^\\circ_{\\mathrm{NO}}(T) - g^\\circ_{\\mathrm{N_2}}(T) - g^\\circ_{\\mathrm{O_2}}(T)$.\n- Equilibrium constraint under ideal gas for $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$:\n    - With initial moles $n_{\\mathrm{N_2,0}} = 0.79$, $n_{\\mathrm{O_2,0}} = 0.21$, let the reaction extent be $\\xi \\ge 0$, then $n_{\\mathrm{N_2}} = 0.79 - \\xi$, $n_{\\mathrm{O_2}} = 0.21 - \\xi$, $n_{\\mathrm{NO}} = 2\\,\\xi$, total moles $n_{\\mathrm{tot}} = 1.0$, and the mole fractions $y_i = n_i/n_{\\mathrm{tot}}$.\n    - The equilibrium condition is $K_p(T) = \\left(p_{\\mathrm{NO}}\\right)^2/\\left(p_{\\mathrm{N_2}}\\,p_{\\mathrm{O_2}}\\right) = \\left(y_{\\mathrm{NO}}\\right)^2/\\left(y_{\\mathrm{N_2}}\\,y_{\\mathrm{O_2}}\\right)$, which yields a scalar nonlinear equation for $\\xi$ that must satisfy $0 \\le \\xi \\le 0.21$.\n- Kinetic PSR model (perfectly stirred reactor):\n    - Species mass balances: $dC_i/dt = (C_{i,\\mathrm{in}} - C_i)/\\tau + \\omega_i$, where $\\tau$ is the residence time, and $C_{i,\\mathrm{in}} = y_{i,\\mathrm{in}}\\,C_{\\mathrm{tot}}$ with $y_{\\mathrm{NO,in}} = 0$, $y_{\\mathrm{N_2,in}} = 0.79$, $y_{\\mathrm{O_2,in}} = 0.21$.\n    - Finite-rate reversible kinetics consistent with thermodynamics for the global reaction $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$:\n        - Forward rate: $r_f = k_f\\,C_{\\mathrm{N_2}}\\,C_{\\mathrm{O_2}}$ with $k_f(T) = A_f\\,\\exp(-E_f/(R T))$.\n        - Backward rate: $r_b = k_b\\,C_{\\mathrm{NO}}^2$, with $k_b(T) = k_f(T)/K_c(T)$ and $K_c(T) = K_p(T)$ because the reaction has $\\Delta \\nu = 0$.\n        - Reburning enhancement of the backward rate: $k_{rb}(T,\\phi) = \\alpha\\,\\phi\\,\\exp(-E_{rb}/(R T))$, with $0 \\le \\phi \\le 1$ representing the reburn intensity (fuel radical availability), and the effective backward rate is $r_b^{\\mathrm{eff}} = (k_b + k_{rb})\\,C_{\\mathrm{NO}}^2$.\n        - Net production rates: $\\omega_{\\mathrm{NO}} = 2\\,r_f - 2\\,r_b^{\\mathrm{eff}}$, $\\omega_{\\mathrm{N_2}} = -r_f + r_b^{\\mathrm{eff}}$, $\\omega_{\\mathrm{O_2}} = -r_f + r_b^{\\mathrm{eff}}$.\n    - Kinetic parameters (chosen to be scientifically plausible for high-temperature thermal nitric oxide formation and reburning pathways):\n        - Forward Arrhenius pre-exponential $A_f = 1.0\\times 10^5\\,\\mathrm{m^3/(mol\\,s)}$, activation energy $E_f = 2.8\\times 10^5\\,\\mathrm{J/mol}$.\n        - Reburning enhancement factor $\\alpha = 5.0\\times 10^5\\,\\mathrm{m^3/(mol\\,s)}$, activation energy $E_{rb} = 5.0\\times 10^4\\,\\mathrm{J/mol}$.\n    - Universal gas constant: $R = 8.314462618\\,\\mathrm{J/(mol\\,K)}$.\n\nTasks to be implemented in the program:\n\n1. For each test case, compute the equilibrium nitric oxide mole fraction $y_{\\mathrm{NO,eq}}$ by:\n    - Computing $\\Delta G^\\circ(T)$ using the stated constant heat capacity model and standard properties.\n    - Computing $K_p(T)$.\n    - Solving the nonlinear equilibrium equation for the reaction extent $\\xi$ in the admissible range $[0,0.21]$.\n    - Returning $y_{\\mathrm{NO,eq}} = 2\\,\\xi$.\n2. For each test case, compute the PSR nitric oxide mole fraction $y_{\\mathrm{NO,psr}}$ by:\n    - Setting up the ordinary differential equations for $C_{\\mathrm{N_2}}(t)$, $C_{\\mathrm{O_2}}(t)$, $C_{\\mathrm{NO}}(t)$ with the given inlet concentrations, residence time, and temperature-dependent rates including the reburn parameter $\\phi$.\n    - Numerically integrating to a final time sufficient to reach steady state (e.g., several multiples of $\\tau$) and obtaining the steady-state nitric oxide concentration $C_{\\mathrm{NO,ss}}$.\n    - Returning $y_{\\mathrm{NO,psr}} = C_{\\mathrm{NO,ss}}/C_{\\mathrm{tot}}$.\n\nPhysical units that must be used:\n\n- Temperature $T$ in $\\mathrm{K}$.\n- Pressure $P$ in $\\mathrm{Pa}$.\n- Time $\\tau$ in $\\mathrm{s}$.\n- Concentrations $C_i$ in $\\mathrm{mol/m^3}$.\n- Mole fractions $y_i$ are unitless decimals.\n\nTest suite:\n\n- Case $1$: $T = 1800\\,\\mathrm{K}$, $P = 101325\\,\\mathrm{Pa}$, $\\tau = 0.05\\,\\mathrm{s}$, $\\phi = 0.0$.\n- Case $2$: $T = 1800\\,\\mathrm{K}$, $P = 101325\\,\\mathrm{Pa}$, $\\tau = 1.0\\,\\mathrm{s}$, $\\phi = 0.0$.\n- Case $3$: $T = 2200\\,\\mathrm{K}$, $P = 101325\\,\\mathrm{Pa}$, $\\tau = 0.01\\,\\mathrm{s}$, $\\phi = 0.0$.\n- Case $4$: $T = 1800\\,\\mathrm{K}$, $P = 202650\\,\\mathrm{Pa}$, $\\tau = 0.05\\,\\mathrm{s}$, $\\phi = 0.0$.\n- Case $5$: $T = 1800\\,\\mathrm{K}$, $P = 101325\\,\\mathrm{Pa}$, $\\tau = 0.05\\,\\mathrm{s}$, $\\phi = 1.0$.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is a two-element list $[y_{\\mathrm{NO,eq}}, y_{\\mathrm{NO,psr}}]$ for the corresponding test case in the order specified above. For example: \"$[[0.00123,0.00098],[\\dots,\\dots],\\dots]$\".",
            "solution": "The problem is assessed to be valid as it is scientifically grounded in the principles of chemical thermodynamics and kinetics, is mathematically well-posed, and all necessary parameters and conditions are provided unambiguously. We proceed with the solution, which is divided into two main parts: the calculation of the equilibrium composition and the calculation of the steady-state composition in a perfectly stirred reactor (PSR) under finite-rate kinetics.\n\nFirst, we define the universal gas constant $R = 8.314462618\\,\\mathrm{J/(mol\\,K)}$ and the reference temperature $T_{ref} = 298\\,\\mathrm{K}$.\n\nPart 1: Equilibrium Nitric Oxide Mole Fraction ($y_{\\mathrm{NO,eq}}$)\n\nThe equilibrium state is governed by the thermodynamic equilibrium constant $K_p(T)$ for the reaction $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$. The equilibrium constant is related to the standard Gibbs free energy change of reaction, $\\Delta G^\\circ(T)$, by:\n$$K_p(T) = \\exp\\left(-\\frac{\\Delta G^\\circ(T)}{R T}\\right)$$\nThe standard Gibbs free energy change is given by $\\Delta G^\\circ(T) = \\Delta H^\\circ(T) - T \\Delta S^\\circ(T)$, where $\\Delta H^\\circ(T)$ and $\\Delta S^\\circ(T)$ are the standard enthalpy and entropy changes of reaction, respectively.\n\nWe are given thermodynamic data at $T_{ref} = 298\\,\\mathrm{K}$ and constant isobaric heat capacities $c_{p,i}$. The change in heat capacity for the reaction is:\n$$\\Delta c_p = 2 c_{p,\\mathrm{NO}} - c_{p,\\mathrm{N_2}} - c_{p,\\mathrm{O_2}} = 2(33.0) - 32.0 - 34.0 = 66.0 - 66.0 = 0\\,\\mathrm{J/(mol\\,K)}$$\nSince $\\Delta c_p = 0$, both the standard reaction enthalpy and entropy are independent of temperature:\n$\\Delta H^\\circ(T) = \\Delta H^\\circ(T_{ref}) + \\int_{T_{ref}}^T \\Delta c_p \\,dT' = \\Delta H^\\circ(T_{ref})$\n$\\Delta S^\\circ(T) = \\Delta S^\\circ(T_{ref}) + \\int_{T_{ref}}^T \\frac{\\Delta c_p}{T'} \\,dT' = \\Delta S^\\circ(T_{ref})$\n\nWe compute these constant values from the given standard properties at $T_{ref}$:\n$\\Delta H^\\circ(T_{ref}) = 2\\,\\Delta H_f^\\circ(\\mathrm{NO}, T_{ref}) - \\Delta H_f^\\circ(\\mathrm{N_2}, T_{ref}) - \\Delta H_f^\\circ(\\mathrm{O_2}, T_{ref}) = 2(90250) - 0 - 0 = 180500\\,\\mathrm{J/mol}$.\n$\\Delta S^\\circ(T_{ref}) = 2\\,s^\\circ(\\mathrm{NO}, T_{ref}) - s^\\circ(\\mathrm{N_2}, T_{ref}) - s^\\circ(\\mathrm{O_2}, T_{ref}) = 2(210.76) - 191.61 - 205.15 = 421.52 - 396.76 = 24.76\\,\\mathrm{J/(mol\\,K)}$.\n\nThus, the standard Gibbs free energy change at any temperature $T$ is:\n$$\\Delta G^\\circ(T) = 180500 - 24.76\\,T$$\nAnd the equilibrium constant is:\n$$K_p(T) = \\exp\\left(-\\frac{180500 - 24.76\\,T}{R T}\\right)$$\nFor a mixture with initial mole fractions $y_{\\mathrm{N_2,0}} = 0.79$ and $y_{\\mathrm{O_2,0}} = 0.21$, let $\\xi$ be the extent of reaction on a molar basis (per mole of initial mixture). The equilibrium mole fractions are $y_{\\mathrm{N_2}} = 0.79 - \\xi$, $y_{\\mathrm{O_2}} = 0.21 - \\xi$, and $y_{\\mathrm{NO}} = 2\\xi$. The total moles remain constant at $1.0$. The equilibrium condition is expressed as:\n$$K_p(T) = \\frac{y_{\\mathrm{NO}}^2}{y_{\\mathrm{N_2}} y_{\\mathrm{O_2}}} = \\frac{(2\\xi)^2}{(0.79 - \\xi)(0.21 - \\xi)}$$\nThis yields a nonlinear algebraic equation for $\\xi$:\n$$K_p(T) (\\xi^2 - \\xi + 0.1659) - 4\\xi^2 = 0$$\nor\n$$(K_p(T) - 4)\\xi^2 - K_p(T)\\xi + 0.1659 K_p(T) = 0$$\nWe solve this equation for $\\xi$ within the physically admissible range $[0, 0.21]$. A numerical root-finding algorithm is suitable for this task. Once $\\xi$ is found, the equilibrium mole fraction of nitric oxide is $y_{\\mathrm{NO,eq}} = 2\\xi$.\n\nPart 2: Finite-Rate PSR Nitric Oxide Mole Fraction ($y_{\\mathrm{NO,psr}}$)\n\nThe PSR is modeled by a system of ordinary differential equations (ODEs) describing the time evolution of species concentrations $C_i$:\n$$\\frac{dC_i}{dt} = \\frac{C_{i,\\mathrm{in}} - C_i}{\\tau} + \\omega_i$$\nwhere $\\tau$ is the residence time, $C_{i,\\mathrm{in}}$ are the inlet concentrations, and $\\omega_i$ are the net molar production rates from chemical reactions.\nThe total concentration is $C_{\\mathrm{tot}} = P/(RT)$. The inlet concentrations are:\n$C_{\\mathrm{N_2,in}} = 0.79\\, C_{\\mathrm{tot}}$, $C_{\\mathrm{O_2,in}} = 0.21\\, C_{\\mathrm{tot}}$, $C_{\\mathrm{NO,in}} = 0$.\n\nThe net production rates for the species involved in $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$ are:\n$\\omega_{\\mathrm{NO}} = 2(r_f - r_b^{\\mathrm{eff}})$\n$\\omega_{\\mathrm{N_2}} = -(r_f - r_b^{\\mathrm{eff}})$\n$\\omega_{\\mathrm{O_2}} = -(r_f - r_b^{\\mathrm{eff}})$\nwhere $r_f$ is the forward rate and $r_b^{\\mathrm{eff}}$ is the effective backward rate.\n\nThe forward rate is $r_f = k_f(T) C_{\\mathrm{N_2}} C_{\\mathrm{O_2}}$ with the rate constant given by the Arrhenius expression:\n$$k_f(T) = A_f \\exp\\left(-\\frac{E_f}{RT}\\right)$$\nwith $A_f = 1.0 \\times 10^5\\,\\mathrm{m^3/(mol\\,s)}$ and $E_f = 2.8 \\times 10^5\\,\\mathrm{J/mol}$.\n\nThe effective backward rate is $r_b^{\\mathrm{eff}} = (k_b(T) + k_{rb}(T, \\phi)) C_{\\mathrm{NO}}^2$. The thermodynamically consistent backward rate constant is $k_b(T) = k_f(T)/K_c(T)$. As the number of moles does not change in the reaction ($\\Delta \\nu = 2 - (1+1) = 0$), the concentration-based equilibrium constant $K_c(T)$ is equal to the pressure-based one, $K_c(T) = K_p(T)$.\nThe reburning enhancement rate constant is:\n$$k_{rb}(T, \\phi) = \\alpha \\phi \\exp\\left(-\\frac{E_{rb}}{RT}\\right)$$\nwith $\\alpha = 5.0 \\times 10^5\\,\\mathrm{m^3/(mol\\,s)}$, $E_{rb} = 5.0 \\times 10^4\\,\\mathrm{J/mol}$, and $\\phi$ is the reburn intensity.\n\nThe system of ODEs for the concentrations of the three species is:\n$$\\frac{dC_{\\mathrm{N_2}}}{dt} = \\frac{C_{\\mathrm{N_2,in}} - C_{\\mathrm{N_2}}}{\\tau} - k_f C_{\\mathrm{N_2}} C_{\\mathrm{O_2}} + (k_b + k_{rb}) C_{\\mathrm{NO}}^2$$\n$$\\frac{dC_{\\mathrm{O_2}}}{dt} = \\frac{C_{\\mathrm{O_2,in}} - C_{\\mathrm{O_2}}}{\\tau} - k_f C_{\\mathrm{N_2}} C_{\\mathrm{O_2}} + (k_b + k_{rb}) C_{\\mathrm{NO}}^2$$\n$$\\frac{dC_{\\mathrm{NO}}}{dt} = \\frac{C_{\\mathrm{NO,in}} - C_{\\mathrm{NO}}}{\\tau} + 2\\left(k_f C_{\\mathrm{N_2}} C_{\\mathrm{O_2}} - (k_b + k_{rb}) C_{\\mathrm{NO}}^2\\right)$$\nWe solve this initial value problem starting from the inlet concentrations, $C_i(0) = C_{i,\\mathrm{in}}$, and integrate until the concentrations reach a steady state. A final integration time of $10\\tau$ is generally sufficient. The steady-state concentration $C_{\\mathrm{NO,ss}}$ is the value of $C_{\\mathrm{NO}}(t)$ at the final time.\nThe PSR mole fraction is then $y_{\\mathrm{NO,psr}} = C_{\\mathrm{NO,ss}} / C_{\\mathrm{tot,ss}}$. Since the reaction stoichiometry implies $\\sum \\omega_i = 0$, the total concentration $C_{\\mathrm{tot}} = \\sum C_i$ evolves as $dC_{\\mathrm{tot}}/dt = (C_{\\mathrm{tot,in}} - C_{\\mathrm{tot}})/\\tau$, which means $C_{\\mathrm{tot,ss}} = C_{\\mathrm{tot,in}} = P/(RT)$. Thus, $y_{\\mathrm{NO,psr}} = C_{\\mathrm{NO,ss}} / (P/(RT))$.\n\nThe implementation will proceed by calculating these quantities for each test case.",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\nfrom scipy.optimize import brentq\n\ndef solve():\n    \"\"\"\n    Solves for equilibrium and PSR steady-state NO mole fractions\n    for a series of test cases.\n    \"\"\"\n    \n    # Fundamental constants and standard properties\n    R = 8.314462618  # J/(mol*K)\n    T_REF = 298.0  # K\n\n    # Standard enthalpies of formation at T_REF (J/mol)\n    H_F_NO = 90250.0\n    H_F_N2 = 0.0\n    H_F_O2 = 0.0\n\n    # Standard molar entropies at T_REF (J/(mol*K))\n    S_NO = 210.76\n    S_N2 = 191.61\n    S_O2 = 205.15\n\n    # Constant isobaric heat capacities (J/(mol*K))\n    CP_NO = 33.0\n    CP_N2 = 32.0\n    CP_O2 = 34.0\n\n    # Kinetic parameters\n    A_F = 1.0e5  # m^3/(mol*s)\n    E_F = 2.8e5  # J/mol\n    ALPHA_RB = 5.0e5 # m^3/(mol*s)\n    E_RB = 5.0e4   # J/mol\n\n    # Inlet mole fractions\n    Y_N2_IN = 0.79\n    Y_O2_IN = 0.21\n    Y_NO_IN = 0.0\n\n    # --- Thermodynamic Calculations ---\n    # Change in standard properties for N2 + O2 = 2*NO\n    # Since heat capacities are constant, Delta_H and Delta_S are constant\n    delta_H_0 = 2 * H_F_NO - H_F_N2 - H_F_O2\n    delta_S_0 = 2 * S_NO - S_N2 - S_O2\n    \n    # Delta Cp calculation\n    delta_Cp = 2 * CP_NO - CP_N2 - CP_O2\n    # NOTE: In this problem, delta_Cp happens to be 0, simplifying the thermo model.\n    # The code below is general for constant Cp, even if non-zero.\n    \n    def get_kp(T):\n        \"\"\"Calculates the equilibrium constant Kp at temperature T.\"\"\"\n        delta_H_T = delta_H_0 + delta_Cp * (T - T_REF)\n        delta_S_T = delta_S_0 + delta_Cp * np.log(T / T_REF)\n        delta_G_T = delta_H_T - T * delta_S_T\n        return np.exp(-delta_G_T / (R * T))\n\n    # --- Equilibrium Calculation ---\n    def calculate_y_no_eq(T):\n        \"\"\"Calculates the equilibrium NO mole fraction.\"\"\"\n        kp = get_kp(T)\n        \n        # We need to solve Kp = (2*xi)^2 / ((Y_N2_IN - xi) * (Y_O2_IN - xi)) for xi\n        # (Kp - 4)*xi^2 - Kp*xi + Kp*Y_N2_IN*Y_O2_IN = 0\n        def equilibrium_eqn(xi):\n            y_n2 = Y_N2_IN - xi\n            y_o2 = Y_O2_IN - xi\n            y_no = 2 * xi\n            # Avoid division by zero if xi is at a boundary\n            if y_n2 = 0 or y_o2 = 0:\n                # This case represents full consumption of a reactant, so the\n                # equilibrium term goes to infinity, kp would have to be infinite.\n                # Since Kp is finite, solution is not at boundary.\n                return -1.0 # Or some large residual\n            return y_no**2 / (y_n2 * y_o2) - kp\n            \n        # The physical range for xi is [0, min(Y_N2_IN, Y_O2_IN)]\n        # min(0.79, 0.21) = 0.21\n        xi_max = Y_O2_IN\n        try:\n            # Use a robust root finder\n            xi_eq = brentq(equilibrium_eqn, 0, xi_max * 0.99999)\n        except ValueError:\n            # If Kp is extremely small, the root is very close to 0.\n            # a simple check at the boundaries can tell us where the root must be\n             if equilibrium_eqn(0) * equilibrium_eqn(xi_max * 0.99999)  0:\n                 # This can happen if the function is monotonic and root is outside bounds, or no root\n                 # For this problem, should be very close to zero\n                 xi_eq = 0.0\n             else: # Should not happen, but for robustness\n                 raise\n                 \n        y_no_eq = 2 * xi_eq\n        return y_no_eq\n\n    # --- PSR Calculation ---\n    def psr_ode_system(t, C, C_in, tau, kf, kb_eff):\n        \"\"\"Defines the ODE system for the PSR.\"\"\"\n        C_N2, C_O2, C_NO = C\n        C_N2_in, C_O2_in, C_NO_in = C_in\n        \n        # Reaction rates\n        r_f = kf * C_N2 * C_O2\n        r_b_eff = kb_eff * C_NO**2\n        \n        # Net production rates\n        omega_N2 = -r_f + r_b_eff\n        omega_O2 = -r_f + r_b_eff\n        omega_NO = 2 * r_f - 2 * r_b_eff\n        \n        # Mass balance ODEs\n        dC_N2_dt = (C_N2_in - C_N2) / tau + omega_N2\n        dC_O2_dt = (C_O2_in - C_O2) / tau + omega_O2\n        dC_NO_dt = (C_NO_in - C_NO) / tau + omega_NO\n        \n        return [dC_N2_dt, dC_O2_dt, dC_NO_dt]\n\n    def calculate_y_no_psr(T, P, tau, phi):\n        \"\"\"Calculates the PSR steady-state NO mole fraction.\"\"\"\n        # Total concentration\n        C_tot = P / (R * T)\n        \n        # Inlet concentrations\n        C_N2_in = Y_N2_IN * C_tot\n        C_O2_in = Y_O2_IN * C_tot\n        C_NO_in = Y_NO_IN * C_tot\n        C_in = np.array([C_N2_in, C_O2_in, C_NO_in])\n        \n        # Rate constants\n        kf = A_F * np.exp(-E_F / (R * T))\n        kp = get_kp(T)\n        kc = kp # Since Delta_nu = 0\n        kb = kf / kc if kc  0 else float('inf')\n        krb = phi * ALPHA_RB * np.exp(-E_RB / (R * T))\n        kb_eff = kb + krb\n        \n        # Initial conditions for ODE solver (reactor starts empty of products)\n        C0 = np.array([C_N2_in, C_O2_in, C_NO_in])\n\n        # Integrate ODEs until steady state is reached (e.g., 10 * tau)\n        t_final = 10 * tau\n        sol = solve_ivp(\n            fun=psr_ode_system,\n            t_span=[0, t_final],\n            y0=C0,\n            args=(C_in, tau, kf, kb_eff),\n            method='BDF', # Good for stiff problems often found in kinetics\n            atol=1e-12,\n            rtol=1e-9\n        )\n        \n        # Extract steady-state concentration\n        C_NO_ss = sol.y[2, -1]\n        \n        # Convert to mole fraction\n        y_no_psr = C_NO_ss / C_tot\n        \n        return y_no_psr\n\n    test_cases = [\n        # T (K), P (Pa), tau (s), phi\n        (1800.0, 101325.0, 0.05, 0.0),\n        (1800.0, 101325.0, 1.0, 0.0),\n        (2200.0, 101325.0, 0.01, 0.0),\n        (1800.0, 202650.0, 0.05, 0.0),\n        (1800.0, 101325.0, 0.05, 1.0)\n    ]\n    \n    results = []\n    for T, P, tau, phi in test_cases:\n        y_no_eq = calculate_y_no_eq(T)\n        y_no_psr = calculate_y_no_psr(T, P, tau, phi)\n        results.append([y_no_eq, y_no_psr])\n    \n    # Format the final output string exactly as requested\n    formatted_results = ','.join([f\"[{res[0]:.6g},{res[1]:.6g}]\" for res in results])\n    print(f\"[{formatted_results}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Moving from fundamental formation mechanisms to practical control technologies, this practice tackles the modeling of Selective Non-Catalytic Reduction (SNCR). You will simulate $NO$ reduction via ammonia injection in a Plug Flow Reactor (PFR), which approximates the behavior of industrial boilers and furnaces. This exercise requires solving a system of coupled ordinary differential equations that account for reaction kinetics, turbulent mixing, and a spatially varying temperature profile, providing insight into the critical trade-offs between $NO$ reduction efficiency and undesirable ammonia slip .",
            "id": "4045109",
            "problem": "Consider a one-dimensional Plug Flow Reactor (PFR) used for nitric oxide reduction by ammonia injection, formally called Selective Non-Catalytic Reduction (SNCR). A stream containing nitric oxide (NO) at an inlet concentration $C_{\\mathrm{NO},\\mathrm{in}}$ (in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$) flows at constant axial velocity $u$ (in $\\mathrm{m}\\,\\mathrm{s}^{-1}$) through a reactor of length $L$ (in $\\mathrm{m}$). At axial location $x_0$ (in $\\mathrm{m}$), ammonia (NH$_3$) is injected as a point addition into the core flow, establishing an initially unmixed ammonia concentration $C_{\\mathrm{NH}_3,\\mathrm{target}}$ (in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$) in each fluid element crossing $x_0$. Turbulent micro-mixing downstream of $x_0$ is modeled as a first-order exchange between an unmixed ammonia pool and a mixed reactive pool with a characteristic mixing time $t_{\\mathrm{mix}}$ (in $\\mathrm{s}$). The gas temperature varies along the reactor as a known function $T(x)$ (in $\\mathrm{K}$). Assume constant pressure and negligible axial diffusion, consistent with the PFR approximation.\n\nAdopt the following widely used kinetic simplification in SNCR modeling: the desired reduction reaction is second order in nitric oxide and mixed ammonia with an Arrhenius temperature dependence, and an undesired first-order consumption of mixed ammonia with its own Arrhenius law captures net side reactions (for example, thermal oxidation or radical-initiated loss). Specifically, let the reaction rates be\n$$r_1(T,C_{\\mathrm{NO}},C_{\\mathrm{NH}_3,\\mathrm{m}}) = k_1(T)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}},\\quad k_1(T) = A_1\\,\\exp\\!\\left(-\\frac{E_1}{R\\,T}\\right),$$\n$$r_2(T,C_{\\mathrm{NH}_3,\\mathrm{m}}) = k_2(T)\\,C_{\\mathrm{NH}_3,\\mathrm{m}},\\quad k_2(T) = A_2\\,\\exp\\!\\left(-\\frac{E_2}{R\\,T}\\right),$$\nwhere $R$ is the universal gas constant (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$), $A_1$ (in $\\mathrm{m}^3\\,\\mathrm{mol}^{-1}\\,\\mathrm{s}^{-1}$) and $E_1$ (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}$) are the pre-exponential and activation energy for the desired reaction, and $A_2$ (in $\\mathrm{s}^{-1}$) and $E_2$ (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}$) are the corresponding parameters for the undesired consumption.\n\nLet the axial coordinate $x$ be mapped to a Lagrangian residence time $t$ via $t = x/u$. For $t  t_0 \\equiv x_0/u$, the injected ammonia concentrations are zero. At $t = t_0$, the unmixed ammonia concentration is instantaneously set to $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0^+) = C_{\\mathrm{NH}_3,\\mathrm{target}}$, while the mixed ammonia concentration is $C_{\\mathrm{NH}_3,\\mathrm{m}}(t_0^+) = 0$. For $t \\ge t_0$, mixing and reactions proceed according to mass action with the following coupled ordinary differential equations,\n$$\\frac{dC_{\\mathrm{NO}}}{dt} = -\\,k_1\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}},$$\n$$\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}} \\,-\\,k_1\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} \\,-\\,k_2\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NH}_3,\\mathrm{m}},$$\n$$\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\,\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}},$$\nwith the initial conditions at the reactor inlet $t=0$ given by $C_{\\mathrm{NO}}(0) = C_{\\mathrm{NO},\\mathrm{in}}$, $C_{\\mathrm{NH}_3,\\mathrm{m}}(0) = 0$, $C_{\\mathrm{NH}_3,\\mathrm{u}}(0) = 0$. These equations align with conservation of the injected ammonia subject to mixing and reactive sinks, and the PFR approximation relating axial position to time.\n\nDefine the nitric oxide reduction achieved as the dimensionless fraction\n$$\\phi = \\frac{C_{\\mathrm{NO},\\mathrm{in}} - C_{\\mathrm{NO}}(t_{\\mathrm{final}})}{C_{\\mathrm{NO},\\mathrm{in}}},$$\nwhere $t_{\\mathrm{final}} = L/u$ is the outlet residence time. Define the ammonia slip at the exit as\n$$S_{\\mathrm{NH}_3} = C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}}) + C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}}),$$\nwith units $\\mathrm{mol}\\,\\mathrm{m}^{-3}$. Your task is to compute $\\phi$ and $S_{\\mathrm{NH}_3}$ for each of the following test cases by integrating the above system with the specified parameters. Use the universal gas constant $R = 8.314\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$, the desired-reaction parameters $A_1 = 2.0\\times 10^7\\,\\mathrm{m}^3\\,\\mathrm{mol}^{-1}\\,\\mathrm{s}^{-1}$ and $E_1 = 6.5\\times 10^4\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}$, and the side-reaction parameters $A_2 = 1.0\\times 10^5\\,\\mathrm{s}^{-1}$ and $E_2 = 9.0\\times 10^4\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}$. For each test case, specify the temperature as a quadratic profile $T(x) = T_0 + a\\,x - b\\,x^2$ with $x$ in $\\mathrm{m}$ and $T$ in $\\mathrm{K}$. The target injected ammonia concentration is set stoichiometrically relative to the inlet nitric oxide as $C_{\\mathrm{NH}_3,\\mathrm{target}} = \\alpha\\,C_{\\mathrm{NO},\\mathrm{in}}$ with $\\alpha$ given.\n\nTest Suite (each line denotes $(L, u, x_0, t_{\\mathrm{mix}}, T_0, a, b, C_{\\mathrm{NO},\\mathrm{in}}, \\alpha)$, using the stated units):\n- Case $1$: $(10, 2, 4, 0.5, 950, 60, 4, 0.002, 1.1)$.\n- Case $2$: $(10, 2, 9, 0.5, 950, 60, 4, 0.002, 1.1)$.\n- Case $3$: $(10, 2, 4, 3.0, 950, 60, 4, 0.002, 1.1)$.\n- Case $4$: $(10, 2, 4, 0.5, 900, 20, 2, 0.002, 1.1)$.\n- Case $5$: $(10, 2, 0, 0.5, 950, 60, 4, 0.002, 1.1)$.\n\nYour program must:\n- Implement the above coupled ordinary differential equations using the provided kinetic model and temperature profiles.\n- Integrate from $t=0$ to $t=t_{\\mathrm{final}}$ with an instantaneous ammonia injection at $t=t_0$ as specified.\n- For each test case, compute the nitric oxide reduction fraction $\\phi$ (dimensionless, expressed as a decimal) and the ammonia slip $S_{\\mathrm{NH}_3}$ (expressed in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$).\n- Produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each test case reported as a two-element list $[\\phi, S_{\\mathrm{NH}_3}]$.\n\nScientific realism requirement: ensure that all computed concentrations remain non-negative by enforcing reaction rates that vanish when any reactive concentration would otherwise become negative due to numerical error.\n\nAngle units do not apply. Physical units must be respected as stated above.",
            "solution": "The user has provided a problem that is scientifically grounded, well-posed, and objective. It describes a standard chemical engineering problem involving reaction kinetics and transport in a Plug Flow Reactor (PFR) for Selective Non-Catalytic Reduction (SNCR) of nitric oxide. The model is based on established principles of mass conservation and Arrhenius kinetics. The system of ordinary differential equations (ODEs) is clearly defined, with all necessary parameters, initial conditions, and a discrete event (ammonia injection) specified. The problem is self-contained and free of contradictions or ambiguities. Therefore, the problem is deemed valid and a solution will be provided.\n\nThe problem requires the calculation of nitric oxide reduction efficiency $\\phi$ and ammonia slip $S_{\\mathrm{NH}_3}$ at the outlet of a PFR. This involves solving a system of coupled ODEs that model the concentrations of nitric oxide ($C_{\\mathrm{NO}}$), mixed ammonia ($C_{\\mathrm{NH}_3,\\mathrm{m}}$), and unmixed ammonia ($C_{\\mathrm{NH}_3,\\mathrm{u}}$).\n\nThe governing equations are provided for the time evolution of the concentrations in a fluid parcel, where residence time $t$ is related to axial position $x$ by $t = x/u$. The system is:\n$$\n\\frac{dC_{\\mathrm{NO}}}{dt} = -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}} -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} - k_2(T(ut))\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}}\n$$\nThe rate constants $k_1$ and $k_2$ are given by the Arrhenius laws:\n$$\nk_1(T) = A_1\\,\\exp\\left(-\\frac{E_1}{R\\,T}\\right) \\quad \\text{and} \\quad k_2(T) = A_2\\,\\exp\\left(-\\frac{E_2}{R\\,T}\\right)\n$$\nThe temperature profile is $T(x) = T_0 + a\\,x - b\\,x^2$. In the Lagrangian frame, this becomes $T(t) = T_0 + a(ut) - b(ut)^2$.\n\nThe process starts at $t=0$ with initial conditions $C_{\\mathrm{NO}}(0) = C_{\\mathrm{NO},\\mathrm{in}}$, $C_{\\mathrm{NH}_3,\\mathrm{m}}(0) = 0$, and $C_{\\mathrm{NH}_3,\\mathrm{u}}(0) = 0$. Since the source terms for the ammonia species are zero, these concentrations remain zero until the injection point at time $t_0 = x_0/u$. At $t=t_0$, the system state is changed discontinuously as per the problem description:\n$C_{\\mathrm{NO}}(t_0^+) = C_{\\mathrm{NO}}(t_0^-+) = C_{\\mathrm{NO},\\mathrm{in}}$\n$C_{\\mathrm{NH}_3,\\mathrm{m}}(t_0^+) = 0$\n$C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0^+) = C_{\\mathrm{NH}_3,\\mathrm{target}} = \\alpha \\, C_{\\mathrm{NO},\\mathrm{in}}$\n\nThe integration of the ODE system is thus required only over the time interval $[t_0, t_{\\mathrm{final}}]$, where $t_{\\mathrm{final}} = L/u$.\n\nThe third ODE for the unmixed ammonia, $\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}}$, is a linear, first-order equation that can be solved analytically. With the initial condition $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0) = C_{\\mathrm{NH}_3,\\mathrm{target}}$, the solution for $t \\ge t_0$ is:\n$$\nC_{\\mathrm{NH}_3,\\mathrm{u}}(t) = C_{\\mathrm{NH}_3,\\mathrm{target}} \\exp\\left(-\\frac{t-t_0}{t_{\\mathrm{mix}}}\\right)\n$$\nThis analytical solution can be substituted into the second ODE, which simplifies the numerical task by reducing the system from three to two coupled ODEs:\n$$\n\\frac{dC_{\\mathrm{NO}}}{dt} = -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{C_{\\mathrm{NH}_3,\\mathrm{target}}}{t_{\\mathrm{mix}}} \\exp\\left(-\\frac{t-t_0}{t_{\\mathrm{mix}}}\\right) - k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} - k_2(T(ut))\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\nThis reduced system is to be solved for the state vector $\\mathbf{y}(t) = [C_{\\mathrm{NO}}(t), C_{\\mathrm{NH}_3,\\mathrm{m}}(t)]^T$ over the interval $t \\in [t_0, t_{\\mathrm{final}}]$, with the initial condition at $t=t_0$:\n$$\n\\mathbf{y}(t_0) = [C_{\\mathrm{NO},\\mathrm{in}}, 0]^T\n$$\nDue to the wide range of timescales typical in chemical kinetics, this system is stiff and requires a suitable numerical integrator. The `scipy.integrate.solve_ivp` function with a method like 'LSODA' is well-suited for this purpose. The non-negativity of concentrations is enforced by ensuring the reaction rate terms are computed using $\\max(0, C)$ for each concentration $C$, as specified in the problem.\n\nFor each test case, the algorithm is as follows:\n1.  Extract parameters ($L, u, x_0, t_{\\mathrm{mix}}, T_0, a, b, C_{\\mathrm{NO},\\mathrm{in}}, \\alpha$) and given constants ($R, A_1, E_1, A_2, E_2$).\n2.  Calculate derived parameters: $t_0=x_0/u$, $t_{\\mathrm{final}}=L/u$, and $C_{\\mathrm{NH}_3,\\mathrm{target}}=\\alpha\\,C_{\\mathrm{NO},\\mathrm{in}}$.\n3.  Set the initial condition vector $\\mathbf{y}(t_0) = [C_{\\mathrm{NO},\\mathrm{in}}, 0]^T$.\n4.  If $t_0 \\ge t_{\\mathrm{final}}$, no reaction occurs post-injection within the reactor. $C_{\\mathrm{NO}}(t_{\\mathrm{final}}) = C_{\\mathrm{NO},\\mathrm{in}}$ and all ammonia concentrations are zero at the outlet.\n5.  If $t_0  t_{\\mathrm{final}}$, numerically integrate the reduced two-variable ODE system from $t_0$ to $t_{\\mathrm{final}}$.\n6.  From the numerical solution at $t_{\\mathrm{final}}$, retrieve the final concentrations $C_{\\mathrm{NO}}(t_{\\mathrm{final}})$ and $C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}})$.\n7.  Calculate the final unmixed ammonia concentration using the analytical solution: $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}}) = C_{\\mathrm{NH}_3,\\mathrm{target}} \\exp(-(t_{\\mathrm{final}}-t_0)/t_{\\mathrm{mix}})$.\n8.  Compute the required output metrics:\n    -   Nitric oxide reduction: $\\phi = \\frac{C_{\\mathrm{NO},\\mathrm{in}} - C_{\\mathrm{NO}}(t_{\\mathrm{final}})}{C_{\\mathrm{NO},\\mathrm{in}}}$\n    -   Ammonia slip: $S_{\\mathrm{NH}_3} = C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}}) + C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}})$\n9.  Store the pair $[\\phi, S_{\\mathrm{NH}_3}]$ for each test case and format the final output as specified.\n\nThis procedure will now be implemented in Python.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Solves the SNCR problem for a suite of test cases by integrating\n    the governing ODEs.\n    \"\"\"\n    \n    # Universal gas constant and kinetic parameters\n    R = 8.314  # J mol^-1 K^-1\n    A1 = 2.0e7   # m^3 mol^-1 s^-1\n    E1 = 6.5e4   # J mol^-1\n    A2 = 1.0e5   # s^-1\n    E2 = 9.0e4   # J mol^-1\n\n    # Test suite (L, u, x0, t_mix, T0, a, b, C_NO_in, alpha)\n    test_cases = [\n        (10, 2, 4, 0.5, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 9, 0.5, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 4, 3.0, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 4, 0.5, 900, 20, 2, 0.002, 1.1),\n        (10, 2, 0, 0.5, 950, 60, 4, 0.002, 1.1),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        L, u, x0, t_mix, T0, a, b, C_NO_in, alpha = case\n        \n        # Calculate derived parameters\n        t0 = x0 / u\n        t_final = L / u\n        C_NH3_target = alpha * C_NO_in\n\n        # If injection is at or after the outlet, no reaction occurs\n        if t0 = t_final:\n            phi = 0.0\n            S_NH3 = 0.0\n            results.append([phi, S_NH3])\n            continue\n\n        # Define the system of ODEs for the reduced 2-variable system\n        # This function captures necessary parameters from the current scope\n        def ode_system(t, y):\n            C_NO, C_NH3_m = y\n\n            # Enforce non-negativity as per problem spec\n            C_NO = max(0.0, C_NO)\n            C_NH3_m = max(0.0, C_NH3_m)\n            \n            # Calculate temperature at time t\n            x = u * t\n            T = T0 + a * x - b * x**2\n            \n            # Calculate Arrhenius rate constants\n            k1 = A1 * np.exp(-E1 / (R * T))\n            k2 = A2 * np.exp(-E2 / (R * T))\n            \n            # Source term from unmixed ammonia pool (analytical solution)\n            source_NH3_m = (C_NH3_target / t_mix) * np.exp(-(t - t0) / t_mix)\n            \n            # Reaction rates\n            r1 = k1 * C_NO * C_NH3_m\n            r2 = k2 * C_NH3_m\n            \n            # Derivatives\n            dC_NO_dt = -r1\n            dC_NH3_m_dt = source_NH3_m - r1 - r2\n            \n            return [dC_NO_dt, dC_NH3_m_dt]\n\n        # Initial conditions at injection time t0 for the reduced system\n        y0 = [C_NO_in, 0.0]\n        \n        # Time span for integration\n        t_span = [t0, t_final]\n\n        # Solve the ODE system\n        sol = solve_ivp(\n            ode_system, \n            t_span, \n            y0, \n            method='LSODA', \n            dense_output=True,\n            atol=1e-12, # Absolute tolerance\n            rtol=1e-9   # Relative tolerance\n        )\n        \n        # Extract final concentrations from the solver result\n        C_NO_final = sol.y[0, -1]\n        C_NH3_m_final = sol.y[1, -1]\n        \n        # Calculate final unmixed ammonia concentration from its analytical solution\n        C_NH3_u_final = C_NH3_target * np.exp(-(t_final - t0) / t_mix)\n        \n        # Compute reduction fraction phi\n        phi = (C_NO_in - C_NO_final) / C_NO_in\n        \n        # Compute ammonia slip S_NH3\n        S_NH3 = C_NH3_m_final + C_NH3_u_final\n        \n        results.append([phi, S_NH3])\n\n    # Format the final output string as a list of lists, with no spaces.\n    # e.g., [[val1,val2],[val3,val4]]\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "This capstone exercise elevates the task from analysis to system-level design and optimization, a core activity in engineering. You will model a complete staged combustion process using a network of Perfectly Stirred Reactors (PSRs) to represent the rich reburn, quench, and lean burnout zones. The challenge is to employ a numerical optimization algorithm to find the optimal air staging strategy that minimizes final $NO$ emissions while satisfying operational constraints, such as keeping carbon monoxide ($CO$) below a specified limit . This practice integrates kinetic modeling, reactor network simulation, and optimization to address a complex, real-world engineering problem.",
            "id": "4045182",
            "problem": "You are asked to build a computational model of nitrogen oxides (NOx) reburning with air staging using a chain of three perfectly stirred reactors (PSRs) representing a rich reburn zone, a quench mixing and reaction zone, and a lean burnout zone. The model must capture the coupled chemistry of fuel oxidation, carbon monoxide burnout, and nitric oxide reduction and reformation, while retaining thermodynamic consistency at the level of conservation of atoms within an ideal-gas framework. You must then compute the optimal quench air addition that brings the quench zone equivalence ratio close to a specified target while minimizing nitric oxide at the exit of the lean zone and keeping the exit carbon monoxide below a limit. The final program must output the optimal quench oxygen addition for each test case in a single-line list format as specified.\n\nBegin from the following foundations.\n\n- Species material balance for a steady-state Perfectly Stirred Reactor (PSR):\n  $$0 = \\dot{n}_{i,\\mathrm{in}} - \\dot{n}_{i,\\mathrm{out}} + V \\, \\mathcal{R}_i(\\mathbf{C}, T),$$\n  where $\\dot{n}_{i,\\mathrm{in}}$ and $\\dot{n}_{i,\\mathrm{out}}$ are inlet and outlet molar flow rates of species $i$ in $\\mathrm{mol/s}$, $V$ is the reactor volume in $\\mathrm{m^3}$, $T$ is the reactor temperature in $\\mathrm{K}$, $\\mathbf{C}$ is the vector of outlet concentrations in $\\mathrm{mol/m^3}$, and $\\mathcal{R}_i$ is the net gas-phase volumetric production rate of species $i$ in $\\mathrm{mol/(m^3 \\cdot s)}$. Assume ideal gas, so the volumetric flow is $\\dot{V} = \\left(\\sum_i \\dot{n}_{i,\\mathrm{out}}\\right) R_u T / P$, with $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$ and $P$ in $\\mathrm{Pa}$, and $C_i = \\dot{n}_{i,\\mathrm{out}} / \\dot{V}$.\n- Air composition is specified by oxygen and nitrogen with molar fraction of oxygen $0.21$. Take the molar ratio of nitrogen to oxygen in air to be $3.76$.\n- Define the global reaction set and kinetics (Arrhenius form) as follows (species in the set $\\{\\mathrm{CH_4}, \\mathrm{O_2}, \\mathrm{NO}, \\mathrm{CO}, \\mathrm{CO_2}, \\mathrm{H_2O}, \\mathrm{N_2}\\}$):\n  1. Reburning reduction of nitric oxide by methane:\n     $$\\mathrm{CH_4} + 4 \\ \\mathrm{NO} \\rightarrow 2 \\ \\mathrm{N_2} + \\mathrm{CO_2} + 2 \\ \\mathrm{H_2O}, \\quad r_1 = A_1 \\exp\\!\\left(-\\dfrac{E_1}{R_u T}\\right) C_{\\mathrm{CH_4}} C_{\\mathrm{NO}}.$$\n  2. Fuel-rich partial oxidation of methane to carbon monoxide:\n     $$\\mathrm{CH_4} + 1.5 \\ \\mathrm{O_2} \\rightarrow \\mathrm{CO} + 2 \\ \\mathrm{H_2O}, \\quad r_2 = A_2 \\exp\\!\\left(-\\dfrac{E_2}{R_u T}\\right) C_{\\mathrm{CH_4}} C_{\\mathrm{O_2}}.$$\n  3. Carbon monoxide oxidation:\n     $$\\mathrm{CO} + 0.5 \\ \\mathrm{O_2} \\rightarrow \\mathrm{CO_2}, \\quad r_3 = A_3 \\exp\\!\\left(-\\dfrac{E_3}{R_u T}\\right) C_{\\mathrm{CO}} C_{\\mathrm{O_2}}.$$\n  4. Thermal nitric oxide formation (globalized):\n     $$\\mathrm{N_2} + \\mathrm{O_2} \\rightarrow 2 \\ \\mathrm{NO}, \\quad r_4 = A_4 \\exp\\!\\left(-\\dfrac{E_4}{R_u T}\\right) C_{\\mathrm{O_2}}^{1/2} C_{\\mathrm{N_2}}^{1/2}.$$\n  The net source terms are assembled using stoichiometric coefficients consistent with the above reactions. All Arrhenius prefactors and activation energies will be given numerically below.\n\n- Three PSRs in series represent zones: rich ($\\mathrm{R}$), quench ($\\mathrm{Q}$), lean ($\\mathrm{L}$). The inlet to $\\mathrm{R}$ contains methane fuel, primary air to achieve a specified rich equivalence ratio, and an imposed inflow of nitric oxide representative of upstream emissions. The inlet to $\\mathrm{Q}$ is the outlet of $\\mathrm{R}$ perfectly and instantaneously mixed with quench air; the inlet to $\\mathrm{L}$ is the outlet of $\\mathrm{Q}$ mixed with sufficient lean air so that the global overall equivalence ratio meets a specified lean target. Neglect heat release in the energy balance and compute the quench and lean zone temperatures by ideal-gas enthalpy mixing of streams at constant molar heat capacity, using molar-weighted temperature averaging:\n  $$T_{\\mathrm{mix}} = \\dfrac{\\dot{n}_{\\mathrm{hot}} T_{\\mathrm{hot}} + \\dot{n}_{\\mathrm{cold}} T_{\\mathrm{cold}}}{\\dot{n}_{\\mathrm{hot}} + \\dot{n}_{\\mathrm{cold}}},$$\n  where $\\dot{n}$ denote total molar flow rates of the mixing streams and $T_{\\mathrm{cold}}$ is the air temperature.\n\n- Equivalence ratio for an arbitrary gas mixture is defined by the ratio of the stoichiometric oxidizer requirement of the combustible species present to the available oxygen:\n  $$\\phi = \\dfrac{2 \\ \\dot{n}_{\\mathrm{CH_4}} + 0.5 \\ \\dot{n}_{\\mathrm{CO}}}{\\dot{n}_{\\mathrm{O_2}}},$$\n  where all molar flows are those of the mixture at the instant considered. For the rich zone primary feed, let the primary oxygen flow be computed from the specified rich equivalence ratio $\\phi_{\\mathrm{R}}$ using the stoichiometric requirement of methane ($2$ mol $\\mathrm{O_2}$ per mol $\\mathrm{CH_4}$): \n  $$\\dot{n}_{\\mathrm{O_2,R}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{F}}}{\\phi_{\\mathrm{R}}}.$$\n  For the global lean target, the total oxygen added over all zones is \n  $$\\dot{n}_{\\mathrm{O_2,total}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{F}}}{\\phi_{\\mathrm{L}}}.$$\n  The remaining oxygen available for staging after the rich zone is \n  $$\\dot{n}_{\\mathrm{O_2,sec}} = \\max\\!\\left(0, \\ \\dot{n}_{\\mathrm{O_2,total}} - \\dot{n}_{\\mathrm{O_2,R}}\\right).$$\n\n- Decision variable and objective: choose the quench oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}} \\in [0, \\dot{n}_{\\mathrm{O_2,sec}}]$. The remaining secondary oxygen goes to the lean zone, $\\dot{n}_{\\mathrm{O_2,L}} = \\dot{n}_{\\mathrm{O_2,sec}} - \\dot{n}_{\\mathrm{O_2,Q}}$, with accompanying nitrogen in air at the specified ratio. The quench-zone equivalence ratio computed from the perfectly mixed quench inlet (before reaction) is\n  $$\\phi_{\\mathrm{Q,mix}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{CH_4,Q,in}} + 0.5 \\ \\dot{n}_{\\mathrm{CO,Q,in}}}{\\dot{n}_{\\mathrm{O_2,Q,in}}},$$\n  where the inlet flows are the sum of the rich-zone outlet and the quench air addition. The optimization objective is to minimize the exit nitric oxide molar fraction $\\hat{y}_{\\mathrm{NO,out}}$ at the lean-zone outlet while driving $\\phi_{\\mathrm{Q,mix}}$ close to a target $\\phi_{\\mathrm{Q,target}}$ and enforcing a carbon monoxide outlet molar fraction not exceeding a specified limit $\\hat{y}_{\\mathrm{CO,lim}}$. Use a differentiable penalty formulation:\n  $$J(\\dot{n}_{\\mathrm{O_2,Q}}) = \\hat{y}_{\\mathrm{NO,out}} + w_{\\phi}\\left(\\phi_{\\mathrm{Q,mix}} - \\phi_{\\mathrm{Q,target}}\\right)^2 + w_{\\mathrm{CO}} \\, \\max\\!\\left(0, \\ \\hat{y}_{\\mathrm{CO,out}} - \\hat{y}_{\\mathrm{CO,lim}}\\right)^2,$$\n  with weights $w_{\\phi}$ and $w_{\\mathrm{CO}}$ given below.\n\nImplement the above PSR-chain model, solve each PSR by satisfying the steady-state species balances using the specified kinetics, and then carry out a bounded scalar minimization in $\\dot{n}_{\\mathrm{O_2,Q}}$ for each test case. Express all flows in $\\mathrm{mol/s}$, volumes in $\\mathrm{m^3}$, pressures in $\\mathrm{Pa}$, and temperatures in $\\mathrm{K}$. For all computations use $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$. The program must return the optimal quench oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for each test case as a float rounded to six decimal places.\n\nKinetic parameters and constants to use in all cases:\n- Universal gas constant: $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$.\n- Pressure: $P = 101325 \\ \\mathrm{Pa}$.\n- Air oxygen fraction: $0.21$; air nitrogen to oxygen molar ratio: $3.76$.\n- Air temperature: $T_{\\mathrm{air}} = 300 \\ \\mathrm{K}$.\n- Reaction $1$ (reburn): $A_1 = 2.0 \\times 10^{6} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_1 = 8.0 \\times 10^{4} \\ \\mathrm{J/mol}$.\n- Reaction $2$ (rich oxidation): $A_2 = 1.0 \\times 10^{8} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_2 = 1.25 \\times 10^{5} \\ \\mathrm{J/mol}$.\n- Reaction $3$ (CO oxidation): $A_3 = 5.0 \\times 10^{6} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_3 = 7.0 \\times 10^{4} \\ \\mathrm{J/mol}$.\n- Reaction $4$ (thermal NO): $A_4 = 4.0 \\times 10^{3} \\ \\mathrm{s^{-1}}$, $E_4 = 2.8 \\times 10^{5} \\ \\mathrm{J/mol}$.\n- Penalty weights: $w_{\\phi} = 100.0$, $w_{\\mathrm{CO}} = 10^{6}$.\n\nTest suite. For each case below, run the optimization and report the optimal $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ in $\\mathrm{mol/s}$ rounded to six decimal places. Each case defines the fuel flow $\\dot{n}_{\\mathrm{F}}$ in $\\mathrm{mol/s}$, rich-zone equivalence ratio $\\phi_{\\mathrm{R}}$, lean global target $\\phi_{\\mathrm{L}}$, quench target $\\phi_{\\mathrm{Q,target}}$, rich-zone temperature $T_{\\mathrm{R}}$ in $\\mathrm{K}$, reactor volumes $V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}$ in $\\mathrm{m^3}$, inlet nitric oxide flow to the rich zone $\\dot{n}_{\\mathrm{NO,in}}$ in $\\mathrm{mol/s}$, and the allowable outlet carbon monoxide molar fraction limit $\\hat{y}_{\\mathrm{CO,lim}}$ (dimensionless mol fraction, expressible as a decimal).\n\n- Case A:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.2$, $\\phi_{\\mathrm{L}} = 0.85$, $\\phi_{\\mathrm{Q,target}} = 0.98$,\n  - $T_{\\mathrm{R}} = 1900$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.03, 0.05, 0.07)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 5.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.5 \\times 10^{-3}$.\n- Case B:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.2$, $\\phi_{\\mathrm{L}} = 0.85$, $\\phi_{\\mathrm{Q,target}} = 0.98$,\n  - $T_{\\mathrm{R}} = 1900$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.03, 0.05, 0.07)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 5.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 2.0 \\times 10^{-4}$.\n- Case C:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.4$, $\\phi_{\\mathrm{L}} = 0.90$, $\\phi_{\\mathrm{Q,target}} = 1.05$,\n  - $T_{\\mathrm{R}} = 2000$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.02, 0.04, 0.06)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 1.0 \\times 10^{-3}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.0 \\times 10^{-3}$.\n- Case D:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.1$, $\\phi_{\\mathrm{L}} = 0.98$, $\\phi_{\\mathrm{Q,target}} = 0.95$,\n  - $T_{\\mathrm{R}} = 1850$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.025, 0.035, 0.05)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 3.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.0 \\times 10^{-3}$.\n\nImplementation requirements and output specification:\n\n- Build the three-zone PSR chain exactly as described, using the given reactions, kinetics, and mixing rules. For each zone, solve the PSR steady-state species balances for the outlet molar flows using the ideal-gas relation to compute concentrations from the outlet molar flows.\n- The decision variable is the quench-zone oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}}$ in $\\mathrm{mol/s}$. Respect bounds $0 \\le \\dot{n}_{\\mathrm{O_2,Q}} \\le \\dot{n}_{\\mathrm{O_2,sec}}$.\n- Compute the objective $J(\\dot{n}_{\\mathrm{O_2,Q}})$ and minimize it for each case.\n- The final output must be a single line containing a Python list of four floats corresponding to $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for Cases A, B, C, and D, respectively, each rounded to six decimal places, and in $\\mathrm{mol/s}$, for example:\n  $$[\\mathrm{value\\_A},\\mathrm{value\\_B},\\mathrm{value\\_C},\\mathrm{value\\_D}]$$\n  where each $\\mathrm{value}$ is a decimal number with six digits after the decimal point and no units in the printed line.",
            "solution": "The user has provided a well-posed problem in computational combustion. The task is to model a three-stage NOx reburning process using a series of Perfectly Stirred Reactors (PSRs) and to find an optimal air staging strategy. The problem is scientifically grounded, free of contradictions, and contains all necessary information to construct a numerical solution. The model simplifications, such as a reduced kinetic mechanism and an isothermal assumption for each reactor (decoupled energy equation), are explicitly stated and are standard practice for conceptual-level process modeling.\n\nHerein, I will develop the solution by first establishing the mathematical framework for a single PSR, then constructing the three-reactor chain, and finally embedding this model within an optimization routine to solve for the specified test cases.\n\n### 1. Species and Stoichiometry\nThe model involves $N_s=7$ species: $\\mathrm{CH_4}$, $\\mathrm{O_2}$, $\\mathrm{NO}$, $\\mathrm{CO}$, $\\mathrm{CO_2}$, $\\mathrm{H_2O}$, and $\\mathrm{N_2}$. A consistent ordering is established for vector representation:\n$0: \\mathrm{CH_4}$, $1: \\mathrm{O_2}$, $2: \\mathrm{NO}$, $3: \\mathrm{CO}$, $4: \\mathrm{CO_2}$, $5: \\mathrm{H_2O}$, $6: \\mathrm{N_2}$.\n\nThe problem defines four global reactions. The net stoichiometric coefficient $\\nu_{ij}$ for species $j$ in reaction $i$ can be assembled into a matrix. Let the rows represent reactions $1-4$ and columns represent species $0-6$.\n$$\n\\nu = \\begin{pmatrix}\n-1  0  -4  0  1  2  2 \\\\\n-1  -1.5  0  1  0  2  0 \\\\\n0  -0.5  0  -1  1  0  0 \\\\\n0  -1  2  0  0  0  -1\n\\end{pmatrix}\n$$\n\n### 2. Kinetic and Rate Laws\nFor each reaction $j$, the rate $r_j$ is given by an Arrhenius expression multiplied by concentration terms. All concentrations $C_j$ are in $\\mathrm{mol/m^3}$ and temperature $T$ is in $\\mathrm{K}$. The universal gas constant is $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$.\nThe rate constants are $k_j(T) = A_j \\exp(-E_j / (R_u T))$. The reaction rates are:\n$$ r_1 = k_1(T) C_{\\mathrm{CH_4}} C_{\\mathrm{NO}} $$\n$$ r_2 = k_2(T) C_{\\mathrm{CH_4}} C_{\\mathrm{O_2}} $$\n$$ r_3 = k_3(T) C_{\\mathrm{CO}} C_{\\mathrm{O_2}} $$\n$$ r_4 = k_4(T) C_{\\mathrm{O_2}}^{1/2} C_{\\mathrm{N_2}}^{1/2} $$\nThe net volumetric production rate for each species $j$, $\\mathcal{R}_j$, is the sum of its production/consumption over all reactions:\n$$ \\mathcal{R}_j(\\mathbf{C}, T) = \\sum_{i=1}^{4} \\nu_{ij} r_i(\\mathbf{C}, T) = (\\boldsymbol{\\nu}^T \\mathbf{r})_j $$\nwhere $\\mathbf{r}$ is the column vector of reaction rates $[r_1, r_2, r_3, r_4]^T$.\n\n### 3. The Perfectly Stirred Reactor (PSR) Model\nThe steady-state mass balance for species $j$ in a PSR is:\n$$ 0 = \\dot{n}_{j,\\mathrm{in}} - \\dot{n}_{j,\\mathrm{out}} + V \\, \\mathcal{R}_j(\\mathbf{C}_{\\mathrm{out}}, T) $$\nwhere $\\dot{n}$ are molar flow rates in $\\mathrm{mol/s}$ and $V$ is the reactor volume in $\\mathrm{m^3}$.\nUnder the ideal gas assumption, the outlet concentrations $\\mathbf{C}_{\\mathrm{out}}$ are related to the outlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{out}}$:\n$$ C_{j, \\mathrm{out}} = \\frac{P}{R_u T} \\frac{\\dot{n}_{j, \\mathrm{out}}}{\\sum_{k=1}^{N_s} \\dot{n}_{k, \\mathrm{out}}} = \\frac{P}{R_u T} \\hat{y}_{j, \\mathrm{out}} $$\nwhere $P$ is the pressure in $\\mathrm{Pa}$ and $\\hat{y}_{j, \\mathrm{out}}$ is the mole fraction. Substituting this into the rate laws makes the PSR equation a system of $N_s$ coupled nonlinear algebraic equations for the unknown outlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{out}}$.\n$$ \\mathbf{F}(\\dot{\\mathbf{n}}_{\\mathrm{out}}) = \\dot{\\mathbf{n}}_{\\mathrm{in}} - \\dot{\\mathbf{n}}_{\\mathrm{out}} + V \\, \\boldsymbol{\\mathcal{R}}(\\dot{\\mathbf{n}}_{\\mathrm{out}}, T) = \\mathbf{0} $$\nThis system must be solved numerically. We will use a root-finding algorithm, specifically `scipy.optimize.root`, with the inlet flow rates as an initial guess for the outlet flow rates. To maintain physical validity during iterations, species concentrations and molar flows will be floored at a small positive number (e.g., $10^{-30}$) to prevent domain errors in functions like `sqrt`.\n\n### 4. The Three-Zone Reactor Chain Simulation\nThe simulation proceeds sequentially through the three reactors for a given decision variable $\\dot{n}_{\\mathrm{O_2,Q}}$.\n\n**a. Zone R (Rich Reactor):**\nThe inlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{in,R}}$ are determined by the fuel flow $\\dot{n}_{\\mathrm{F}}$ and the rich equivalence ratio $\\phi_{\\mathrm{R}}$.\n- Fuel: $\\dot{n}_{\\mathrm{CH_4,in,R}} = \\dot{n}_{\\mathrm{F}}$\n- Primary Air: $\\dot{n}_{\\mathrm{O_2,R}} = (2 \\dot{n}_{\\mathrm{F}}) / \\phi_{\\mathrm{R}}$ and $\\dot{n}_{\\mathrm{N_2,in,R}} = 3.76 \\cdot \\dot{n}_{\\mathrm{O_2,R}}$\n- Inlet NO: $\\dot{n}_{\\mathrm{NO,in,R}}$ is given by the case data.\n- Other species: $\\dot{n}_{j, \\mathrm{in,R}} = 0$.\nThe PSR equations are solved with volume $V_R$ and temperature $T_R$ to find the outlet flows $\\dot{\\mathbf{n}}_{\\mathrm{out,R}}$.\n\n**b. Zone Q (Quench Reactor):**\nThe inlet to this zone, $\\dot{\\mathbf{n}}_{\\mathrm{in,Q}}$, is the mixture of the rich zone outlet $\\dot{\\mathbf{n}}_{\\mathrm{out,R}}$ and the quench air stream.\n- Quench Air: This stream contains $\\dot{n}_{\\mathrm{O_2,Q}}$ (the decision variable) and $\\dot{n}_{\\mathrm{N_2,Q}} = 3.76 \\cdot \\dot{n}_{\\mathrm{O_2,Q}}$.\n- Inlet Mixture: $\\dot{\\mathbf{n}}_{\\mathrm{in,Q}} = \\dot{\\mathbf{n}}_{\\mathrm{out,R}} + \\dot{\\mathbf{n}}_{\\mathrm{air,Q}}$.\nThe temperature $T_Q$ is calculated by adiabatic mixing:\n$$ T_Q = \\frac{(\\sum \\dot{n}_{j,\\mathrm{out,R}}) T_R + (\\dot{n}_{\\mathrm{O_2,Q}} + \\dot{n}_{\\mathrm{N_2,Q}}) T_{\\mathrm{air}}}{\\sum \\dot{n}_{j,\\mathrm{out,R}} + \\dot{n}_{\\mathrm{O_2,Q}} + \\dot{n}_{\\mathrm{N_2,Q}}} $$\nThe PSR equations are then solved with volume $V_Q$ and calculated temperature $T_Q$ to find $\\dot{\\mathbf{n}}_{\\mathrm{out,Q}}$.\n\n**c. Zone L (Lean Reactor):**\nThe available secondary oxygen is $\\dot{n}_{\\mathrm{O_2,sec}} = (2 \\dot{n}_{\\mathrm{F}} / \\phi_{\\mathrm{L}}) - (2 \\dot{n}_{\\mathrm{F}} / \\phi_{\\mathrm{R}})$.\nThe lean air stream contains $\\dot{n}_{\\mathrm{O_2,L}} = \\dot{n}_{\\mathrm{O_2,sec}} - \\dot{n}_{\\mathrm{O_2,Q}}$ and corresponding nitrogen.\nThe inlet to the lean zone is the mixture of the quench outlet and lean air: $\\dot{\\mathbf{n}}_{\\mathrm{in,L}} = \\dot{\\mathbf{n}}_{\\mathrm{out,Q}} + \\dot{\\mathbf{n}}_{\\mathrm{air,L}}$.\nThe temperature $T_L$ is calculated by a similar mixing rule:\n$$ T_L = \\frac{(\\sum \\dot{n}_{j,\\mathrm{out,Q}}) T_Q + (\\dot{n}_{\\mathrm{O_2,L}} + \\dot{n}_{\\mathrm{N_2,L}}) T_{\\mathrm{air}}}{\\sum \\dot{n}_{j,\\mathrm{out,Q}} + \\dot{n}_{\\mathrm{O_2,L}} + \\dot{n}_{\\mathrm{N_2,L}}} $$\nThe PSR equations are solved with volume $V_L$ and temperature $T_L$ to find the final outlet flows $\\dot{\\mathbf{n}}_{\\mathrm{out,L}}$.\n\n### 5. Optimization\nThe goal is to find the optimal quench oxygen flow $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ that minimizes a cost function $J$. The search is bounded: $0 \\le \\dot{n}_{\\mathrm{O_2,Q}} \\le \\dot{n}_{\\mathrm{O_2,sec}}$.\nThe cost function $J$ is:\n$$ J(\\dot{n}_{\\mathrm{O_2,Q}}) = \\hat{y}_{\\mathrm{NO,out,L}} + w_{\\phi}\\left(\\phi_{\\mathrm{Q,mix}} - \\phi_{\\mathrm{Q,target}}\\right)^2 + w_{\\mathrm{CO}} \\, \\max\\!\\left(0, \\ \\hat{y}_{\\mathrm{CO,out,L}} - \\hat{y}_{\\mathrm{CO,lim}}\\right)^2 $$\n- $\\hat{y}_{\\mathrm{NO,out,L}}$ and $\\hat{y}_{\\mathrm{CO,out,L}}$ are the mole fractions of NO and CO at the exit of the lean zone.\n- $\\phi_{\\mathrm{Q,mix}}$ is the equivalence ratio of the pre-reaction mixture entering the quench zone:\n  $$ \\phi_{\\mathrm{Q,mix}} = \\frac{2 \\ \\dot{n}_{\\mathrm{CH_4,in,Q}} + 0.5 \\ \\dot{n}_{\\mathrm{CO,in,Q}}}{\\dot{n}_{\\mathrm{O_2,in,Q}}} $$\nA scalar bounded optimization algorithm, `scipy.optimize.minimize_scalar` with the 'bounded' method, is employed to find $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for each test case. If the PSR solver fails for a given $\\dot{n}_{\\mathrm{O_2,Q}}$, the objective function will return a large value to guide the optimizer away from such infeasible regions.\n\nThis entire procedure is implemented for each of the four test cases provided in the problem statement. The resulting optimal quench oxygen flow rates are collected and formatted as the final answer.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import root, minimize_scalar\n\n# Define global constants and structures\nSPECIES_MAP = {'CH4': 0, 'O2': 1, 'NO': 2, 'CO': 3, 'CO2': 4, 'H2O': 5, 'N2': 6}\nNUM_SPECIES = 7\n# Stoichiometric matrix (reactions x species)\n# R1: CH4 + 4NO - 2N2 + CO2 + 2H2O\n# R2: CH4 + 1.5O2 - CO + 2H2O\n# R3: CO + 0.5O2 - CO2\n# R4: N2 + O2 - 2NO\nNU = np.array([\n    # CH4,   O2,  NO,   CO, CO2, H2O,  N2\n    [-1.0,  0.0, -4.0,  0.0, 1.0, 2.0, 2.0],  # R1\n    [-1.0, -1.5,  0.0,  1.0, 0.0, 2.0, 0.0],  # R2\n    [ 0.0, -0.5,  0.0, -1.0, 1.0, 0.0, 0.0],  # R3\n    [ 0.0, -1.0,  2.0,  0.0, 0.0, 0.0,-1.0],  # R4\n], dtype=np.float64)\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the simulation and optimization for all test cases.\n    \"\"\"\n    # Universal constants and model parameters\n    RU = 8.314  # J/(mol.K)\n    P = 101325.0  # Pa\n    T_AIR = 300.0  # K\n    N2_O2_RATIO = 3.76\n\n    KINETICS = {\n        'A': np.array([2.0e6, 1.0e8, 5.0e6, 4.0e3], dtype=np.float64),\n        'E': np.array([8.0e4, 1.25e5, 7.0e4, 2.8e5], dtype=np.float64)\n    }\n    \n    W_PHI = 100.0\n    W_CO = 1.0e6\n\n    # Test cases defined in the problem\n    test_cases = [\n        {'name': 'A', 'n_f': 1.0, 'phi_r': 1.2, 'phi_l': 0.85, 'phi_q_target': 0.98,\n         'T_r': 1900, 'V': (0.03, 0.05, 0.07),\n         'n_no_in': 5.0e-4, 'y_co_lim': 1.5e-3},\n        {'name': 'B', 'n_f': 1.0, 'phi_r': 1.2, 'phi_l': 0.85, 'phi_q_target': 0.98,\n         'T_r': 1900, 'V': (0.03, 0.05, 0.07),\n         'n_no_in': 5.0e-4, 'y_co_lim': 2.0e-4},\n        {'name': 'C', 'n_f': 1.0, 'phi_r': 1.4, 'phi_l': 0.90, 'phi_q_target': 1.05,\n         'T_r': 2000, 'V': (0.02, 0.04, 0.06),\n         'n_no_in': 1.0e-3, 'y_co_lim': 1.0e-3},\n        {'name': 'D', 'n_f': 1.0, 'phi_r': 1.1, 'phi_l': 0.98, 'phi_q_target': 0.95,\n         'T_r': 1850, 'V': (0.025, 0.035, 0.05),\n         'n_no_in': 3.0e-4, 'y_co_lim': 1.0e-3}\n    ]\n\n    def calculate_rates(C, T):\n        \"\"\"Calculates the reaction rates.\"\"\"\n        C = np.maximum(C, 1e-30) # Floor concentrations to avoid math errors\n        k = KINETICS['A'] * np.exp(-KINETICS['E'] / (RU * T))\n        \n        r1 = k[0] * C[SPECIES_MAP['CH4']] * C[SPECIES_MAP['NO']]\n        r2 = k[1] * C[SPECIES_MAP['CH4']] * C[SPECIES_MAP['O2']]\n        r3 = k[2] * C[SPECIES_MAP['CO']] * C[SPECIES_MAP['O2']]\n        r4 = k[3] * np.sqrt(C[SPECIES_MAP['N2']] * C[SPECIES_MAP['O2']])\n        \n        return np.array([r1, r2, r3, r4])\n\n    def solve_psr(n_dot_in, V, T):\n        \"\"\"Solves the PSR non-linear algebraic equations.\"\"\"\n        def residuals(n_dot_out):\n            n_dot_out_phys = np.maximum(n_dot_out, 0.0)\n            n_dot_total_out = np.sum(n_dot_out_phys)\n            \n            if n_dot_total_out  1e-20:\n                C_out = np.zeros(NUM_SPECIES)\n            else:\n                C_out = (P / (RU * T)) * n_dot_out_phys / n_dot_total_out\n            \n            rates = calculate_rates(C_out, T)\n            R_net = NU.T @ rates\n            \n            return n_dot_in - n_dot_out_phys + V * R_net\n\n        sol = root(residuals, n_dot_in, method='hybr', tol=1e-8)\n        \n        if not sol.success:\n            return None\n        return np.maximum(sol.x, 0.0)\n\n    def objective_function(n_o2_q, params):\n        \"\"\"Simulates the 3-PSR chain and computes the objective function J.\"\"\"\n        n_f = params['n_f']\n        phi_r = params['phi_r']\n        phi_l = params['phi_l']\n        phi_q_target = params['phi_q_target']\n        y_co_lim = params['y_co_lim']\n        T_r = params['T_r']\n        V_r, V_q, V_l = params['V']\n        n_no_in = params['n_no_in']\n\n        # --- Zone R (Rich) ---\n        n_dot_in_r = np.zeros(NUM_SPECIES)\n        n_dot_in_r[SPECIES_MAP['CH4']] = n_f\n        n_o2_r = (2.0 * n_f) / phi_r\n        n_dot_in_r[SPECIES_MAP['O2']] = n_o2_r\n        n_dot_in_r[SPECIES_MAP['N2']] = n_o2_r * N2_O2_RATIO\n        n_dot_in_r[SPECIES_MAP['NO']] = n_no_in\n        \n        n_dot_out_r = solve_psr(n_dot_in_r, V_r, T_r)\n        if n_dot_out_r is None: return 1e12\n\n        # --- Zone Q (Quench) ---\n        n_dot_air_q = np.zeros(NUM_SPECIES)\n        n_dot_air_q[SPECIES_MAP['O2']] = n_o2_q\n        n_dot_air_q[SPECIES_MAP['N2']] = n_o2_q * N2_O2_RATIO\n        \n        n_dot_in_q = n_dot_out_r + n_dot_air_q\n        \n        n_total_out_r = np.sum(n_dot_out_r)\n        n_total_air_q = np.sum(n_dot_air_q)\n        T_q = ((n_total_out_r * T_r) + (n_total_air_q * T_AIR)) / (n_total_out_r + n_total_air_q)\n\n        # Calculate phi_q_mix for penalty term\n        phi_q_num = 2.0 * n_dot_in_q[SPECIES_MAP['CH4']] + 0.5 * n_dot_in_q[SPECIES_MAP['CO']]\n        phi_q_den = n_dot_in_q[SPECIES_MAP['O2']] + 1e-30 # Avoid division by zero\n        phi_q_mix = phi_q_num / phi_q_den\n        \n        n_dot_out_q = solve_psr(n_dot_in_q, V_q, T_q)\n        if n_dot_out_q is None: return 1e12\n\n        # --- Zone L (Lean) ---\n        n_o2_total = (2.0 * n_f) / phi_l\n        n_o2_sec = n_o2_total - n_o2_r\n        n_o2_l = n_o2_sec - n_o2_q\n\n        n_dot_air_l = np.zeros(NUM_SPECIES)\n        if n_o2_l  0:\n            n_dot_air_l[SPECIES_MAP['O2']] = n_o2_l\n            n_dot_air_l[SPECIES_MAP['N2']] = n_o2_l * N2_O2_RATIO\n\n        n_dot_in_l = n_dot_out_q + n_dot_air_l\n        \n        n_total_out_q = np.sum(n_dot_out_q)\n        n_total_air_l = np.sum(n_dot_air_l)\n        T_l = ((n_total_out_q * T_q) + (n_total_air_l * T_AIR)) / (n_total_out_q + n_total_air_l)\n\n        n_dot_out_l = solve_psr(n_dot_in_l, V_l, T_l)\n        if n_dot_out_l is None: return 1e12\n        \n        # --- Calculate Objective J ---\n        n_dot_total_out_l = np.sum(n_dot_out_l)\n        y_hat_out_l = n_dot_out_l / (n_dot_total_out_l + 1e-30)\n        \n        y_no_out = y_hat_out_l[SPECIES_MAP['NO']]\n        y_co_out = y_hat_out_l[SPECIES_MAP['CO']]\n        \n        penalty_phi = W_PHI * (phi_q_mix - phi_q_target)**2\n        penalty_co = W_CO * (np.maximum(0, y_co_out - y_co_lim))**2\n        \n        J = y_no_out + penalty_phi + penalty_co\n\n        return J\n\n    results = []\n    for case in test_cases:\n        # Calculate optimization bounds\n        n_f = case['n_f']\n        phi_r = case['phi_r']\n        phi_l = case['phi_l']\n        \n        n_o2_r = (2.0 * n_f) / phi_r\n        n_o2_total = (2.0 * n_f) / phi_l\n        n_o2_sec = max(0, n_o2_total - n_o2_r)\n        \n        bounds_n_o2_q = (0, n_o2_sec)\n\n        # Run optimization\n        opt_result = minimize_scalar(\n            objective_function,\n            args=(case,),\n            method='bounded',\n            bounds=bounds_n_o2_q,\n            options={'xatol': 1e-8, 'maxiter': 500}\n        )\n        \n        results.append(opt_result.x)\n\n    # Format and print the final results\n    print(f\"[{','.join([f'{r:.6f}' for r in results])}]\")\n\nsolve()\n```"
        }
    ]
}