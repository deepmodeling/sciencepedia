{
    "hands_on_practices": [
        {
            "introduction": "This exercise grounds our understanding of $NO_x$ formation in chemical thermodynamics. By implementing calculations based on the Zeldovich mechanism, you will determine the equilibrium concentration of thermal $NO$, which represents a theoretical upper limit for $NO$ formation at high temperatures. This practice  is fundamental for appreciating the strong temperature dependency of thermal $NO_x$ and establishes a crucial baseline for evaluating the effectiveness of various reduction strategies.",
            "id": "4045106",
            "problem": "A stoichiometric methane-air flame at high temperature generates thermal nitric oxide via the extended Zeldovich mechanism. Consider the pair of reversible elementary reactions known as the Zeldovich mechanism: $\\,\\mathrm{O} + \\mathrm{N_2} \\rightleftharpoons \\mathrm{NO} + \\mathrm{N}\\,$ and $\\,\\mathrm{N} + \\mathrm{O_2} \\rightleftharpoons \\mathrm{NO} + \\mathrm{O}\\,$. By the law of mass action under the ideal-gas approximation, combining these two reactions yields the overall reversible reaction $\\,\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}\\,$ with equilibrium constant $K_p(T)$ defined at standard state. The ideal-gas equilibrium constant is obtained from thermodynamics as $K_p(T) = \\exp\\!\\left(-\\Delta G^\\circ(T)/(R T)\\right)$, where $\\Delta G^\\circ(T)$ is the standard Gibbs free energy change at temperature $T$, $R$ is the universal gas constant, and $T$ is the absolute temperature. In ideal gases, partial pressures are $p_i = y_i P$, where $y_i$ are mole fractions and $P$ is the total pressure. For the overall reaction $\\,\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}\\,$, the equilibrium mole fraction of nitric oxide satisfies\n$$\\frac{(p_{\\mathrm{NO}})^2}{p_{\\mathrm{N_2}}\\,p_{\\mathrm{O_2}}} = K_p(T),\\quad\\text{so}\\quad y_{\\mathrm{NO}} = \\sqrt{K_p(T)\\,y_{\\mathrm{N_2}}\\,y_{\\mathrm{O_2}}}.$$\nAssume an ideal-gas post-flame mixture comprised of $\\mathrm{N_2}$, $\\mathrm{O_2}$, $\\mathrm{H_2O}$, and $\\mathrm{CO_2}$ at $T=2200\\ \\mathrm{K}$ and $P=1\\ \\mathrm{atm}$. To evaluate $K_p(T)$, use standard thermochemistry with the NASA seven-coefficient polynomial form for species standard-state properties at the high-temperature range. For each species, the dimensionless heat capacity at constant pressure, enthalpy, and entropy are given by\n$$\\frac{c_p^\\circ(T)}{R} = a_1 + a_2 T + a_3 T^2 + a_4 T^3 + a_5 T^4,$$\n$$\\frac{h^\\circ(T)}{R T} = a_1 + \\frac{a_2 T}{2} + \\frac{a_3 T^2}{3} + \\frac{a_4 T^3}{4} + \\frac{a_5 T^4}{5} + \\frac{a_6}{T},$$\n$$\\frac{s^\\circ(T)}{R} = a_1 \\ln T + a_2 T + \\frac{a_3 T^2}{2} + \\frac{a_4 T^3}{3} + \\frac{a_5 T^4}{4} + a_7,$$\nand the dimensionless Gibbs free energy is $g^\\circ(T)/(R T) = h^\\circ(T)/(R T) - s^\\circ(T)/R$. The standard Gibbs free energy change for the reaction $\\,\\mathrm{N_2} + \\mathrm{O_2} \\to 2\\,\\mathrm{NO}\\,$ is\n$$\\frac{\\Delta G^\\circ(T)}{R T} = 2\\,\\frac{g^\\circ_{\\mathrm{NO}}(T)}{R T} - \\frac{g^\\circ_{\\mathrm{N_2}}(T)}{R T} - \\frac{g^\\circ_{\\mathrm{O_2}}(T)}{R T},$$\nyielding $K_p(T) = \\exp\\!\\left(-\\Delta G^\\circ(T)/(R T)\\right)$. Use the following high-temperature NASA polynomial coefficients $(a_1,\\ldots,a_7)$ for the species, valid over $T \\in [1000,6000]\\ \\mathrm{K}$:\n- For $\\mathrm{N_2}$: $a_1=2.95257626$, $a_2=1.39690040\\times 10^{-3}$, $a_3=-4.92631603\\times 10^{-7}$, $a_4=7.86010367\\times 10^{-11}$, $a_5=-4.60755321\\times 10^{-15}$, $a_6=-9.23948688\\times 10^{2}$, $a_7=5.87188762$.\n- For $\\mathrm{O_2}$: $a_1=3.28253784$, $a_2=1.48308754\\times 10^{-3}$, $a_3=-7.57966669\\times 10^{-7}$, $a_4=2.09470555\\times 10^{-10}$, $a_5=-2.16717794\\times 10^{-14}$, $a_6=-1.08845772\\times 10^{3}$, $a_7=5.45323129$.\n- For $\\mathrm{NO}$: $a_1=2.26071716$, $a_2=1.19110565\\times 10^{-3}$, $a_3=-4.29170406\\times 10^{-7}$, $a_4=6.94576690\\times 10^{-11}$, $a_5=-4.03223084\\times 10^{-15}$, $a_6=9.84444553\\times 10^{2}$, $a_7=6.33965101$.\nAssume that reburning reduces the effective oxidizer available to the Zeldovich mechanism by consuming a fraction of $\\mathrm{O_2}$ via hydrocarbon injection. Model this by an effective oxygen mole fraction $y_{\\mathrm{O_2}}^{\\mathrm{eff}} = (1 - \\chi)\\,y_{\\mathrm{O_2}}$, where $\\chi \\in [0,1]$ is the reburn severity parameter (with $\\chi=0$ meaning no reburn, and $\\chi$ near $1$ meaning aggressive reburn that nearly eliminates $\\mathrm{O_2}$ available to form $\\mathrm{NO}$ thermally). Under this model, the equilibrium nitric oxide mole fraction is\n$$y_{\\mathrm{NO}}(T) = \\sqrt{K_p(T)\\,y_{\\mathrm{N_2}}\\,y_{\\mathrm{O_2}}^{\\mathrm{eff}}}.$$\nAll mole fractions must be provided as unitless decimals; the outputs must be in the same unitless decimal form. For this problem, take $T=2200\\ \\mathrm{K}$ and $P=1\\ \\mathrm{atm}$, and evaluate $y_{\\mathrm{NO}}$ for the following test suite of five cases, which explores baseline behavior, lean conditions, and reburning-induced reductions:\n- Case $1$ (baseline burned, small residual $\\mathrm{O_2}$): $y_{\\mathrm{N_2}}=0.740$, $y_{\\mathrm{O_2}}=0.010$, $y_{\\mathrm{CO_2}}=0.090$, $y_{\\mathrm{H_2O}}=0.160$, $\\chi=0.000$.\n- Case $2$ (nearly oxygen-free, boundary): $y_{\\mathrm{N_2}}=0.740$, $y_{\\mathrm{O_2}}=0.000$, $y_{\\mathrm{CO_2}}=0.090$, $y_{\\mathrm{H_2O}}=0.170$, $\\chi=0.000$.\n- Case $3$ (lean post-flame, elevated $\\mathrm{O_2}$): $y_{\\mathrm{N_2}}=0.700$, $y_{\\mathrm{O_2}}=0.050$, $y_{\\mathrm{CO_2}}=0.080$, $y_{\\mathrm{H_2O}}=0.170$, $\\chi=0.000$.\n- Case $4$ (moderate reburn): $y_{\\mathrm{N_2}}=0.740$, $y_{\\mathrm{O_2}}=0.010$, $y_{\\mathrm{CO_2}}=0.090$, $y_{\\mathrm{H_2O}}=0.160$, $\\chi=0.500$.\n- Case $5$ (aggressive reburn): $y_{\\mathrm{N_2}}=0.740$, $y_{\\mathrm{O_2}}=0.010$, $y_{\\mathrm{CO_2}}=0.090$, $y_{\\mathrm{H_2O}}=0.160$, $\\chi=0.950$.\nYour program must compute $K_p(T)$ from the provided NASA polynomial coefficients at $T=2200\\ \\mathrm{K}$, then compute $y_{\\mathrm{NO}}$ for each case using $y_{\\mathrm{O_2}}^{\\mathrm{eff}} = (1 - \\chi)\\,y_{\\mathrm{O_2}}$. The final output must be a single line containing the five results as a comma-separated list enclosed in square brackets, in the order of the test cases. Each entry should be the float value of $y_{\\mathrm{NO}}$ (unitless decimal). For example, an output should be of the form $\\,[\\alpha_1,\\alpha_2,\\alpha_3,\\alpha_4,\\alpha_5]$, where each $\\alpha_i$ is the computed mole fraction for case $i$.",
            "solution": "The problem requires the calculation of the equilibrium mole fraction of nitric oxide, $y_{\\mathrm{NO}}$, in a post-flame gas mixture for five different cases involving variations in composition and reburning severity. The calculation is based on the principles of chemical thermodynamics and the Zeldovich mechanism for thermal $\\mathrm{NO}$ formation. The entire process can be broken down into a sequence of steps, starting from the calculation of thermodynamic properties from first principles using the provided data.\n\nThe temperature is fixed at $T=2200\\ \\mathrm{K}$ and the pressure at $P=1\\ \\mathrm{atm}$. The foundation of the calculation is the equilibrium of the overall reaction $\\mathrm{N_2} + \\mathrm{O_2} \\rightleftharpoons 2\\,\\mathrm{NO}$. The equilibrium constant for this reaction, $K_p(T)$, is related to the mole fractions of the species at equilibrium. The problem provides a simplified model for the equilibrium mole fraction of $\\mathrm{NO}$:\n$$y_{\\mathrm{NO}}(T) = \\sqrt{K_p(T)\\,y_{\\mathrm{N_2}}\\,y_{\\mathrm{O_2}}^{\\mathrm{eff}}}$$\nHere, $y_{\\mathrm{N_2}}$ is the mole fraction of nitrogen, and $y_{\\mathrm{O_2}}^{\\mathrm{eff}}$ is the effective mole fraction of oxygen available for thermal $\\mathrm{NO}$ formation, given by $y_{\\mathrm{O_2}}^{\\mathrm{eff}} = (1 - \\chi)\\,y_{\\mathrm{O_2}}$, where $\\chi$ is the reburn severity parameter. This formula assumes that $\\mathrm{NO}$ is a trace species and its formation does not significantly alter the mole fractions of the major species $\\mathrm{N_2}$ and $\\mathrm{O_2}$.\n\nThe primary task is to first determine the value of the equilibrium constant $K_p(T)$ at $T=2200\\ \\mathrm{K}$. From chemical thermodynamics, $K_p(T)$ is related to the standard Gibbs free energy change of the reaction, $\\Delta G^\\circ(T)$, by the equation:\n$$K_p(T) = \\exp\\left(-\\frac{\\Delta G^\\circ(T)}{R T}\\right)$$\nwhere $R$ is the universal gas constant. The dimensionless quantity $\\Delta G^\\circ(T)/(R T)$ is calculated from the standard-state dimensionless Gibbs free energies of the reactants and products:\n$$\\frac{\\Delta G^\\circ(T)}{R T} = \\sum_i \\nu_i \\frac{g_i^\\circ(T)}{R T} = 2 \\left(\\frac{g^\\circ_{\\mathrm{NO}}(T)}{R T}\\right) - 1 \\left(\\frac{g^\\circ_{\\mathrm{N_2}}(T)}{R T}\\right) - 1 \\left(\\frac{g^\\circ_{\\mathrm{O_2}}(T)}{R T}\\right)$$\nwhere $\\nu_i$ are the stoichiometric coefficients of the reaction $\\mathrm{N_2} + \\mathrm{O_2} - 2\\,\\mathrm{NO} = 0$.\n\nThe dimensionless standard-state Gibbs free energy for each species $i$, $g_i^\\circ(T)/(R T)$, is determined from its standard-state dimensionless enthalpy, $h_i^\\circ(T)/(R T)$, and entropy, $s_i^\\circ(T)/R$:\n$$\\frac{g_i^\\circ(T)}{R T} = \\frac{h_i^\\circ(T)}{R T} - \\frac{s_i^\\circ(T)}{R}$$\n\nThe problem provides the NASA seven-coefficient polynomial forms to calculate these thermodynamic properties. For a given temperature $T$ and a set of species-specific coefficients $(a_1, a_2, a_3, a_4, a_5, a_6, a_7)$, the enthalpy and entropy are computed as follows:\n$$\\frac{h^\\circ(T)}{R T} = a_1 + \\frac{a_2 T}{2} + \\frac{a_3 T^2}{3} + \\frac{a_4 T^3}{4} + \\frac{a_5 T^4}{5} + \\frac{a_6}{T}$$\n$$\\frac{s^\\circ(T)}{R} = a_1 \\ln T + a_2 T + \\frac{a_3 T^2}{2} + \\frac{a_4 T^3}{3} + \\frac{a_5 T^4}{4} + a_7$$\n\nThe algorithmic procedure is as follows:\n1.  For each species involved in the reaction ($\\mathrm{N_2}$, $\\mathrm{O_2}$, $\\mathrm{NO}$), use its specific set of NASA coefficients and the given temperature $T=2200\\ \\mathrm{K}$ to calculate $h_i^\\circ(T)/(R T)$ and $s_i^\\circ(T)/R$.\n2.  For each species, calculate $g_i^\\circ(T)/(R T)$ by subtracting the dimensionless entropy from the dimensionless enthalpy.\n3.  Calculate the overall dimensionless Gibbs free energy change for the reaction, $\\Delta G^\\circ(T)/(R T)$.\n4.  Compute the equilibrium constant $K_p(T) = \\exp(-\\Delta G^\\circ(T)/(R T))$.\n5.  For each of the five test cases:\n    a. Use the provided values for $y_{\\mathrm{N_2}}$, $y_{\\mathrm{O_2}}$, and $\\chi$.\n    b. Calculate the effective oxygen mole fraction, $y_{\\mathrm{O_2}}^{\\mathrm{eff}} = (1 - \\chi)\\,y_{\\mathrm{O_2}}$.\n    c. Calculate the equilibrium mole fraction of nitric oxide, $y_{\\mathrm{NO}} = \\sqrt{K_p(T) \\cdot y_{\\mathrm{N_2}} \\cdot y_{\\mathrm{O_2}}^{\\mathrm{eff}}}$.\n6.  Collect the five resulting values of $y_{\\mathrm{NO}}$ and format them as a comma-separated list within square brackets.\n\nThis computational procedure is implemented to solve for the five specified cases. For Case $2$, where $y_{\\mathrm{O_2}}=0$, it is immediately evident that $y_{\\mathrm{NO}}$ will be $0$ without any complex calculation, as oxygen is a necessary reactant. The other cases demonstrate the dependence of thermal $\\mathrm{NO}$ formation on reactant concentration and the effectiveness of reburning as a reduction strategy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the equilibrium mole fraction of nitric oxide (NO) for several\n    post-flame gas mixture cases based on the Zeldovich mechanism.\n\n    The calculation involves:\n    1. Computing thermodynamic properties (enthalpy, entropy, Gibbs free energy)\n       for N2, O2, and NO using NASA 7-coefficient polynomials.\n    2. Determining the equilibrium constant K_p(T) for the reaction N2 + O2 = 2NO.\n    3. Applying a reburning model to calculate the effective O2 mole fraction.\n    4. Calculating the equilibrium NO mole fraction for each test case.\n    \"\"\"\n    T = 2200.0  # Temperature in Kelvin\n\n    # NASA 7-coefficient polynomial data for the high-temperature range\n    # (a1, a2, a3, a4, a5, a6, a7)\n    nasa_coeffs = {\n        'N2': (2.95257626E+00, 1.39690040E-03, -4.92631603E-07,\n               7.86010367E-11, -4.60755321E-15, -9.23948688E+02,\n               5.87188762E+00),\n        'O2': (3.28253784E+00, 1.48308754E-03, -7.57966669E-07,\n               2.09470555E-10, -2.16717794E-14, -1.08845772E+03,\n               5.45323129E+00),\n        'NO': (2.26071716E+00, 1.19110565E-03, -4.29170406E-07,\n               6.94576690E-11, -4.03223084E-15, 9.84444553E+02,\n               6.33965101E+00)\n    }\n\n    def calculate_g_over_RT(T, coeffs):\n        \"\"\"\n        Calculates the dimensionless standard-state Gibbs free energy g_i/(RT)\n        for a species at temperature T.\n        \"\"\"\n        a1, a2, a3, a4, a5, a6, a7 = coeffs\n        T2 = T * T\n        T3 = T2 * T\n        T4 = T3 * T\n\n        # Dimensionless standard-state enthalpy h/(RT)\n        h_over_RT = (a1 + a2 * T / 2.0 + a3 * T2 / 3.0 + a4 * T3 / 4.0 +\n                     a5 * T4 / 5.0 + a6 / T)\n\n        # Dimensionless standard-state entropy s/R\n        s_over_R = (a1 * np.log(T) + a2 * T + a3 * T2 / 2.0 + a4 * T3 / 3.0 +\n                    a5 * T4 / 4.0 + a7)\n        \n        # Dimensionless standard-state Gibbs free energy g/(RT) = h/(RT) - s/R\n        return h_over_RT - s_over_R\n\n    # Calculate g/(RT) for each species at T = 2200 K\n    g_over_RT_N2 = calculate_g_over_RT(T, nasa_coeffs['N2'])\n    g_over_RT_O2 = calculate_g_over_RT(T, nasa_coeffs['O2'])\n    g_over_RT_NO = calculate_g_over_RT(T, nasa_coeffs['NO'])\n\n    # Calculate dimensionless Gibbs free energy change for N2 + O2 = 2NO\n    # DeltaG/(RT) = sum(nu_i * g_i/(RT))\n    # nu_i are stoichiometric coefficients: 2 for NO, -1 for N2, -1 for O2\n    delta_g_over_RT = 2.0 * g_over_RT_NO - g_over_RT_N2 - g_over_RT_O2\n\n    # Calculate the equilibrium constant K_p\n    # K_p = exp(-DeltaG/(RT))\n    Kp = np.exp(-delta_g_over_RT)\n\n    # Test cases from the problem statement\n    # Each tuple: (y_N2, y_O2, chi)\n    test_cases = [\n        (0.740, 0.010, 0.000),  # Case 1\n        (0.740, 0.000, 0.000),  # Case 2\n        (0.700, 0.050, 0.000),  # Case 3\n        (0.740, 0.010, 0.500),  # Case 4\n        (0.740, 0.010, 0.950),  # Case 5\n    ]\n\n    results = []\n    for case in test_cases:\n        y_N2, y_O2, chi = case\n        \n        # Calculate effective O2 mole fraction\n        y_O2_eff = (1.0 - chi) * y_O2\n        \n        # Argument for the square root must be non-negative\n        arg = Kp * y_N2 * y_O2_eff\n        if arg  0:\n             # Should not happen with valid inputs but good practice\n             arg = 0.0\n        \n        # Calculate equilibrium NO mole fraction\n        y_NO = np.sqrt(arg)\n        results.append(y_NO)\n\n    # Format and print the final output as a single-line list of floats\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Moving from thermodynamic limits to kinetic realities, this practice explores a key reduction technology: Selective Non-Catalytic Reduction (SNCR). You will model a Plug Flow Reactor to simulate the injection of ammonia ($NH_3$) into a hot flue gas stream, solving for the time-dependent concentrations of $NO$ and $NH_3$. This exercise  highlights the critical interplay of the temperature window, residence time, and mixing efficiency in maximizing $NO$ destruction while controlling unwanted ammonia slip.",
            "id": "4045109",
            "problem": "Consider a one-dimensional Plug Flow Reactor (PFR) used for nitric oxide reduction by ammonia injection, formally called Selective Non-Catalytic Reduction (SNCR). A stream containing nitric oxide (NO) at an inlet concentration $C_{\\mathrm{NO},\\mathrm{in}}$ (in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$) flows at constant axial velocity $u$ (in $\\mathrm{m}\\,\\mathrm{s}^{-1}$) through a reactor of length $L$ (in $\\mathrm{m}$). At axial location $x_0$ (in $\\mathrm{m}$), ammonia (NH$_3$) is injected as a point addition into the core flow, establishing an initially unmixed ammonia concentration $C_{\\mathrm{NH}_3,\\mathrm{target}}$ (in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$) in each fluid element crossing $x_0$. Turbulent micro-mixing downstream of $x_0$ is modeled as a first-order exchange between an unmixed ammonia pool and a mixed reactive pool with a characteristic mixing time $t_{\\mathrm{mix}}$ (in $\\mathrm{s}$). The gas temperature varies along the reactor as a known function $T(x)$ (in $\\mathrm{K}$). Assume constant pressure and negligible axial diffusion, consistent with the PFR approximation.\n\nAdopt the following widely used kinetic simplification in SNCR modeling: the desired reduction reaction is second order in nitric oxide and mixed ammonia with an Arrhenius temperature dependence, and an undesired first-order consumption of mixed ammonia with its own Arrhenius law captures net side reactions (for example, thermal oxidation or radical-initiated loss). Specifically, let the reaction rates be\n$$r_1(T,C_{\\mathrm{NO}},C_{\\mathrm{NH}_3,\\mathrm{m}}) = k_1(T)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}},\\quad k_1(T) = A_1\\,\\exp\\!\\left(-\\frac{E_1}{R\\,T}\\right),$$\n$$r_2(T,C_{\\mathrm{NH}_3,\\mathrm{m}}) = k_2(T)\\,C_{\\mathrm{NH}_3,\\mathrm{m}},\\quad k_2(T) = A_2\\,\\exp\\!\\left(-\\frac{E_2}{R\\,T}\\right),$$\nwhere $R$ is the universal gas constant (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$), $A_1$ (in $\\mathrm{m}^3\\,\\mathrm{mol}^{-1}\\,\\mathrm{s}^{-1}$) and $E_1$ (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}$) are the pre-exponential and activation energy for the desired reaction, and $A_2$ (in $\\mathrm{s}^{-1}$) and $E_2$ (in $\\mathrm{J}\\,\\mathrm{mol}^{-1}$) are the corresponding parameters for the undesired consumption.\n\nLet the axial coordinate $x$ be mapped to a Lagrangian residence time $t$ via $t = x/u$. For $t  t_0 \\equiv x_0/u$, the injected ammonia concentrations are zero. At $t = t_0$, the unmixed ammonia concentration is instantaneously set to $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0^+) = C_{\\mathrm{NH}_3,\\mathrm{target}}$, while the mixed ammonia concentration is $C_{\\mathrm{NH}_3,\\mathrm{m}}(t_0^+) = 0$. For $t \\ge t_0$, mixing and reactions proceed according to mass action with the following coupled ordinary differential equations,\n$$\\frac{dC_{\\mathrm{NO}}}{dt} = -\\,k_1\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}},$$\n$$\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}} \\,-\\,k_1\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} \\,-\\,k_2\\!\\left(T(u\\,t)\\right)\\,C_{\\mathrm{NH}_3,\\mathrm{m}},$$\n$$\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\,\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}},$$\nwith the initial conditions at the reactor inlet $t=0$ given by $C_{\\mathrm{NO}}(0) = C_{\\mathrm{NO},\\mathrm{in}}$, $C_{\\mathrm{NH}_3,\\mathrm{m}}(0) = 0$, $C_{\\mathrm{NH}_3,\\mathrm{u}}(0) = 0$. These equations align with conservation of the injected ammonia subject to mixing and reactive sinks, and the PFR approximation relating axial position to time.\n\nDefine the nitric oxide reduction achieved as the dimensionless fraction\n$$\\phi = \\frac{C_{\\mathrm{NO},\\mathrm{in}} - C_{\\mathrm{NO}}(t_{\\mathrm{final}})}{C_{\\mathrm{NO},\\mathrm{in}}},$$\nwhere $t_{\\mathrm{final}} = L/u$ is the outlet residence time. Define the ammonia slip at the exit as\n$$S_{\\mathrm{NH}_3} = C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}}) + C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}}),$$\nwith units $\\mathrm{mol}\\,\\mathrm{m}^{-3}$. Your task is to compute $\\phi$ and $S_{\\mathrm{NH}_3}$ for each of the following test cases by integrating the above system with the specified parameters. Use the universal gas constant $R = 8.314\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$, the desired-reaction parameters $A_1 = 2.0\\times 10^7\\,\\mathrm{m}^3\\,\\mathrm{mol}^{-1}\\,\\mathrm{s}^{-1}$ and $E_1 = 6.5\\times 10^4\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}$, and the side-reaction parameters $A_2 = 1.0\\times 10^5\\,\\mathrm{s}^{-1}$ and $E_2 = 9.0\\times 10^4\\,\\mathrm{J}\\,\\mathrm{mol}^{-1}$. For each test case, specify the temperature as a quadratic profile $T(x) = T_0 + a\\,x - b\\,x^2$ with $x$ in $\\mathrm{m}$ and $T$ in $\\mathrm{K}$. The target injected ammonia concentration is set stoichiometrically relative to the inlet nitric oxide as $C_{\\mathrm{NH}_3,\\mathrm{target}} = \\alpha\\,C_{\\mathrm{NO},\\mathrm{in}}$ with $\\alpha$ given.\n\nTest Suite (each line denotes $(L, u, x_0, t_{\\mathrm{mix}}, T_0, a, b, C_{\\mathrm{NO},\\mathrm{in}}, \\alpha)$, using the stated units):\n- Case $1$: $(10, 2, 4, 0.5, 950, 60, 4, 0.002, 1.1)$.\n- Case $2$: $(10, 2, 9, 0.5, 950, 60, 4, 0.002, 1.1)$.\n- Case $3$: $(10, 2, 4, 3.0, 950, 60, 4, 0.002, 1.1)$.\n- Case $4$: $(10, 2, 4, 0.5, 900, 20, 2, 0.002, 1.1)$.\n- Case $5$: $(10, 2, 0, 0.5, 950, 60, 4, 0.002, 1.1)$.\n\nYour program must:\n- Implement the above coupled ordinary differential equations using the provided kinetic model and temperature profiles.\n- Integrate from $t=0$ to $t=t_{\\mathrm{final}}$ with an instantaneous ammonia injection at $t=t_0$ as specified.\n- For each test case, compute the nitric oxide reduction fraction $\\phi$ (dimensionless, expressed as a decimal) and the ammonia slip $S_{\\mathrm{NH}_3}$ (expressed in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$).\n- Produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each test case reported as a two-element list $[\\phi, S_{\\mathrm{NH}_3}]$.\n\nScientific realism requirement: ensure that all computed concentrations remain non-negative by enforcing reaction rates that vanish when any reactive concentration would otherwise become negative due to numerical error.\n\nAngle units do not apply. Physical units must be respected as stated above.",
            "solution": "The user has provided a problem that is scientifically grounded, well-posed, and objective. It describes a standard chemical engineering problem involving reaction kinetics and transport in a Plug Flow Reactor (PFR) for Selective Non-Catalytic Reduction (SNCR) of nitric oxide. The model is based on established principles of mass conservation and Arrhenius kinetics. The system of ordinary differential equations (ODEs) is clearly defined, with all necessary parameters, initial conditions, and a discrete event (ammonia injection) specified. The problem is self-contained and free of contradictions or ambiguities. Therefore, the problem is deemed valid and a solution will be provided.\n\nThe problem requires the calculation of nitric oxide reduction efficiency $\\phi$ and ammonia slip $S_{\\mathrm{NH}_3}$ at the outlet of a PFR. This involves solving a system of coupled ODEs that model the concentrations of nitric oxide ($C_{\\mathrm{NO}}$), mixed ammonia ($C_{\\mathrm{NH}_3,\\mathrm{m}}$), and unmixed ammonia ($C_{\\mathrm{NH}_3,\\mathrm{u}}$).\n\nThe governing equations are provided for the time evolution of the concentrations in a fluid parcel, where residence time $t$ is related to axial position $x$ by $t = x/u$. The system is:\n$$\n\\frac{dC_{\\mathrm{NO}}}{dt} = -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}} -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} - k_2(T(ut))\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}}\n$$\nThe rate constants $k_1$ and $k_2$ are given by the Arrhenius laws:\n$$\nk_1(T) = A_1\\,\\exp\\left(-\\frac{E_1}{R\\,T}\\right) \\quad \\text{and} \\quad k_2(T) = A_2\\,\\exp\\left(-\\frac{E_2}{R\\,T}\\right)\n$$\nThe temperature profile is $T(x) = T_0 + a\\,x - b\\,x^2$. In the Lagrangian frame, this becomes $T(t) = T_0 + a(ut) - b(ut)^2$.\n\nThe process starts at $t=0$ with initial conditions $C_{\\mathrm{NO}}(0) = C_{\\mathrm{NO},\\mathrm{in}}$, $C_{\\mathrm{NH}_3,\\mathrm{m}}(0) = 0$, and $C_{\\mathrm{NH}_3,\\mathrm{u}}(0) = 0$. Since the source terms for the ammonia species are zero, these concentrations remain zero until the injection point at time $t_0 = x_0/u$. At $t=t_0$, the system state is changed discontinuously as per the problem description:\n$C_{\\mathrm{NO}}(t_0^+) = C_{\\mathrm{NO}}(t_0^-+) = C_{\\mathrm{NO},\\mathrm{in}}$\n$C_{\\mathrm{NH}_3,\\mathrm{m}}(t_0^+) = 0$\n$C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0^+) = C_{\\mathrm{NH}_3,\\mathrm{target}} = \\alpha \\, C_{\\mathrm{NO},\\mathrm{in}}$\n\nThe integration of the ODE system is thus required only over the time interval $[t_0, t_{\\mathrm{final}}]$, where $t_{\\mathrm{final}} = L/u$.\n\nThe third ODE for the unmixed ammonia, $\\frac{dC_{\\mathrm{NH}_3,\\mathrm{u}}}{dt} = -\\frac{1}{t_{\\mathrm{mix}}}\\,C_{\\mathrm{NH}_3,\\mathrm{u}}$, is a linear, first-order equation that can be solved analytically. With the initial condition $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_0) = C_{\\mathrm{NH}_3,\\mathrm{target}}$, the solution for $t \\ge t_0$ is:\n$$\nC_{\\mathrm{NH}_3,\\mathrm{u}}(t) = C_{\\mathrm{NH}_3,\\mathrm{target}} \\exp\\left(-\\frac{t-t_0}{t_{\\mathrm{mix}}}\\right)\n$$\nThis analytical solution can be substituted into the second ODE, which simplifies the numerical task by reducing the system from three to two coupled ODEs:\n$$\n\\frac{dC_{\\mathrm{NO}}}{dt} = -k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\n$$\n\\frac{dC_{\\mathrm{NH}_3,\\mathrm{m}}}{dt} = \\frac{C_{\\mathrm{NH}_3,\\mathrm{target}}}{t_{\\mathrm{mix}}} \\exp\\left(-\\frac{t-t_0}{t_{\\mathrm{mix}}}\\right) - k_1(T(ut))\\,C_{\\mathrm{NO}}\\,C_{\\mathrm{NH}_3,\\mathrm{m}} - k_2(T(ut))\\,C_{\\mathrm{NH}_3,\\mathrm{m}}\n$$\nThis reduced system is to be solved for the state vector $\\mathbf{y}(t) = [C_{\\mathrm{NO}}(t), C_{\\mathrm{NH}_3,\\mathrm{m}}(t)]^T$ over the interval $t \\in [t_0, t_{\\mathrm{final}}]$, with the initial condition at $t=t_0$:\n$$\n\\mathbf{y}(t_0) = [C_{\\mathrm{NO},\\mathrm{in}}, 0]^T\n$$\nDue to the wide range of timescales typical in chemical kinetics, this system is stiff and requires a suitable numerical integrator. The `scipy.integrate.solve_ivp` function with a method like 'LSODA' is well-suited for this purpose. The non-negativity of concentrations is enforced by ensuring the reaction rate terms are computed using $\\max(0, C)$ for each concentration $C$, as specified in the problem.\n\nFor each test case, the algorithm is as follows:\n1.  Extract parameters ($L, u, x_0, t_{\\mathrm{mix}}, T_0, a, b, C_{\\mathrm{NO},\\mathrm{in}}, \\alpha$) and given constants ($R, A_1, E_1, A_2, E_2$).\n2.  Calculate derived parameters: $t_0=x_0/u$, $t_{\\mathrm{final}}=L/u$, and $C_{\\mathrm{NH}_3,\\mathrm{target}}=\\alpha\\,C_{\\mathrm{NO},\\mathrm{in}}$.\n3.  Set the initial condition vector $\\mathbf{y}(t_0) = [C_{\\mathrm{NO},\\mathrm{in}}, 0]^T$.\n4.  If $t_0 \\ge t_{\\mathrm{final}}$, no reaction occurs post-injection within the reactor. $C_{\\mathrm{NO}}(t_{\\mathrm{final}}) = C_{\\mathrm{NO},\\mathrm{in}}$ and all ammonia concentrations are zero at the outlet.\n5.  If $t_0  t_{\\mathrm{final}}$, numerically integrate the reduced two-variable ODE system from $t_0$ to $t_{\\mathrm{final}}$.\n6.  From the numerical solution at $t_{\\mathrm{final}}$, retrieve the final concentrations $C_{\\mathrm{NO}}(t_{\\mathrm{final}})$ and $C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}})$.\n7.  Calculate the final unmixed ammonia concentration using the analytical solution: $C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}}) = C_{\\mathrm{NH}_3,\\mathrm{target}} \\exp(-(t_{\\mathrm{final}}-t_0)/t_{\\mathrm{mix}})$.\n8.  Compute the required output metrics:\n    -   Nitric oxide reduction: $\\phi = \\frac{C_{\\mathrm{NO},\\mathrm{in}} - C_{\\mathrm{NO}}(t_{\\mathrm{final}})}{C_{\\mathrm{NO},\\mathrm{in}}}$\n    -   Ammonia slip: $S_{\\mathrm{NH}_3} = C_{\\mathrm{NH}_3,\\mathrm{m}}(t_{\\mathrm{final}}) + C_{\\mathrm{NH}_3,\\mathrm{u}}(t_{\\mathrm{final}})$\n9.  Store the pair $[\\phi, S_{\\mathrm{NH}_3}]$ for each test case and format the final output as specified.\n\nThis procedure will now be implemented in Python.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Solves the SNCR problem for a suite of test cases by integrating\n    the governing ODEs.\n    \"\"\"\n    \n    # Universal gas constant and kinetic parameters\n    R = 8.314  # J mol^-1 K^-1\n    A1 = 2.0e7   # m^3 mol^-1 s^-1\n    E1 = 6.5e4   # J mol^-1\n    A2 = 1.0e5   # s^-1\n    E2 = 9.0e4   # J mol^-1\n\n    # Test suite (L, u, x0, t_mix, T0, a, b, C_NO_in, alpha)\n    test_cases = [\n        (10, 2, 4, 0.5, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 9, 0.5, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 4, 3.0, 950, 60, 4, 0.002, 1.1),\n        (10, 2, 4, 0.5, 900, 20, 2, 0.002, 1.1),\n        (10, 2, 0, 0.5, 950, 60, 4, 0.002, 1.1),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        L, u, x0, t_mix, T0, a, b, C_NO_in, alpha = case\n        \n        # Calculate derived parameters\n        t0 = x0 / u\n        t_final = L / u\n        C_NH3_target = alpha * C_NO_in\n\n        # If injection is at or after the outlet, no reaction occurs\n        if t0 = t_final:\n            phi = 0.0\n            S_NH3 = 0.0\n            results.append([phi, S_NH3])\n            continue\n\n        # Define the system of ODEs for the reduced 2-variable system\n        # This function captures necessary parameters from the current scope\n        def ode_system(t, y):\n            C_NO, C_NH3_m = y\n\n            # Enforce non-negativity as per problem spec\n            C_NO = max(0.0, C_NO)\n            C_NH3_m = max(0.0, C_NH3_m)\n            \n            # Calculate temperature at time t\n            x = u * t\n            T = T0 + a * x - b * x**2\n            \n            # Calculate Arrhenius rate constants\n            k1 = A1 * np.exp(-E1 / (R * T))\n            k2 = A2 * np.exp(-E2 / (R * T))\n            \n            # Source term from unmixed ammonia pool (analytical solution)\n            source_NH3_m = (C_NH3_target / t_mix) * np.exp(-(t - t0) / t_mix)\n            \n            # Reaction rates\n            r1 = k1 * C_NO * C_NH3_m\n            r2 = k2 * C_NH3_m\n            \n            # Derivatives\n            dC_NO_dt = -r1\n            dC_NH3_m_dt = source_NH3_m - r1 - r2\n            \n            return [dC_NO_dt, dC_NH3_m_dt]\n\n        # Initial conditions at injection time t0 for the reduced system\n        y0 = [C_NO_in, 0.0]\n        \n        # Time span for integration\n        t_span = [t0, t_final]\n\n        # Solve the ODE system\n        sol = solve_ivp(\n            ode_system, \n            t_span, \n            y0, \n            method='LSODA', \n            dense_output=True,\n            atol=1e-12, # Absolute tolerance\n            rtol=1e-9   # Relative tolerance\n        )\n        \n        # Extract final concentrations from the solver result\n        C_NO_final = sol.y[0, -1]\n        C_NH3_m_final = sol.y[1, -1]\n        \n        # Calculate final unmixed ammonia concentration from its analytical solution\n        C_NH3_u_final = C_NH3_target * np.exp(-(t_final - t0) / t_mix)\n        \n        # Compute reduction fraction phi\n        phi = (C_NO_in - C_NO_final) / C_NO_in\n        \n        # Compute ammonia slip S_NH3\n        S_NH3 = C_NH3_m_final + C_NH3_u_final\n        \n        results.append([phi, S_NH3])\n\n    # Format the final output string as a list of lists, with no spaces.\n    # e.g., [[val1,val2],[val3,val4]]\n    print(str(results).replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "This final practice consolidates your skills into a comprehensive, system-level design challenge focused on $NO_x$ reburning and air staging. You will construct a model of a multi-zone combustion process using a chain of perfectly stirred reactors and apply optimization algorithms to find the ideal air staging strategy. The objective  is to minimize final $NO$ emissions while adhering to constraints on carbon monoxide ($CO$), reflecting the complex, multi-variable trade-offs inherent in modern combustor design.",
            "id": "4045182",
            "problem": "You are asked to build a computational model of nitrogen oxides (NOx) reburning with air staging using a chain of three perfectly stirred reactors (PSRs) representing a rich reburn zone, a quench mixing and reaction zone, and a lean burnout zone. The model must capture the coupled chemistry of fuel oxidation, carbon monoxide burnout, and nitric oxide reduction and reformation, while retaining thermodynamic consistency at the level of conservation of atoms within an ideal-gas framework. You must then compute the optimal quench air addition that brings the quench zone equivalence ratio close to a specified target while minimizing nitric oxide at the exit of the lean zone and keeping the exit carbon monoxide below a limit. The final program must output the optimal quench oxygen addition for each test case in a single-line list format as specified.\n\nBegin from the following foundations.\n\n- Species material balance for a steady-state Perfectly Stirred Reactor (PSR):\n  $$0 = \\dot{n}_{i,\\mathrm{in}} - \\dot{n}_{i,\\mathrm{out}} + V \\, \\mathcal{R}_i(\\mathbf{C}, T),$$\n  where $\\dot{n}_{i,\\mathrm{in}}$ and $\\dot{n}_{i,\\mathrm{out}}$ are inlet and outlet molar flow rates of species $i$ in $\\mathrm{mol/s}$, $V$ is the reactor volume in $\\mathrm{m^3}$, $T$ is the reactor temperature in $\\mathrm{K}$, $\\mathbf{C}$ is the vector of outlet concentrations in $\\mathrm{mol/m^3}$, and $\\mathcal{R}_i$ is the net gas-phase volumetric production rate of species $i$ in $\\mathrm{mol/(m^3 \\cdot s)}$. Assume ideal gas, so the volumetric flow is $\\dot{V} = \\left(\\sum_i \\dot{n}_{i,\\mathrm{out}}\\right) R_u T / P$, with $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$ and $P$ in $\\mathrm{Pa}$, and $C_i = \\dot{n}_{i,\\mathrm{out}} / \\dot{V}$.\n- Air composition is specified by oxygen and nitrogen with molar fraction of oxygen $0.21$. Take the molar ratio of nitrogen to oxygen in air to be $3.76$.\n- Define the global reaction set and kinetics (Arrhenius form) as follows (species in the set $\\{\\mathrm{CH_4}, \\mathrm{O_2}, \\mathrm{NO}, \\mathrm{CO}, \\mathrm{CO_2}, \\mathrm{H_2O}, \\mathrm{N_2}\\}$):\n  1. Reburning reduction of nitric oxide by methane:\n     $$\\mathrm{CH_4} + 4 \\ \\mathrm{NO} \\rightarrow 2 \\ \\mathrm{N_2} + \\mathrm{CO_2} + 2 \\ \\mathrm{H_2O}, \\quad r_1 = A_1 \\exp\\!\\left(-\\dfrac{E_1}{R_u T}\\right) C_{\\mathrm{CH_4}} C_{\\mathrm{NO}}.$$\n  2. Fuel-rich partial oxidation of methane to carbon monoxide:\n     $$\\mathrm{CH_4} + 1.5 \\ \\mathrm{O_2} \\rightarrow \\mathrm{CO} + 2 \\ \\mathrm{H_2O}, \\quad r_2 = A_2 \\exp\\!\\left(-\\dfrac{E_2}{R_u T}\\right) C_{\\mathrm{CH_4}} C_{\\mathrm{O_2}}.$$\n  3. Carbon monoxide oxidation:\n     $$\\mathrm{CO} + 0.5 \\ \\mathrm{O_2} \\rightarrow \\mathrm{CO_2}, \\quad r_3 = A_3 \\exp\\!\\left(-\\dfrac{E_3}{R_u T}\\right) C_{\\mathrm{CO}} C_{\\mathrm{O_2}}.$$\n  4. Thermal nitric oxide formation (globalized):\n     $$\\mathrm{N_2} + \\mathrm{O_2} \\rightarrow 2 \\ \\mathrm{NO}, \\quad r_4 = A_4 \\exp\\!\\left(-\\dfrac{E_4}{R_u T}\\right) C_{\\mathrm{O_2}}^{1/2} C_{\\mathrm{N_2}}^{1/2}.$$\n  The net source terms are assembled using stoichiometric coefficients consistent with the above reactions. All Arrhenius prefactors and activation energies will be given numerically below.\n\n- Three PSRs in series represent zones: rich ($\\mathrm{R}$), quench ($\\mathrm{Q}$), lean ($\\mathrm{L}$). The inlet to $\\mathrm{R}$ contains methane fuel, primary air to achieve a specified rich equivalence ratio, and an imposed inflow of nitric oxide representative of upstream emissions. The inlet to $\\mathrm{Q}$ is the outlet of $\\mathrm{R}$ perfectly and instantaneously mixed with quench air; the inlet to $\\mathrm{L}$ is the outlet of $\\mathrm{Q}$ mixed with sufficient lean air so that the global overall equivalence ratio meets a specified lean target. Neglect heat release in the energy balance and compute the quench and lean zone temperatures by ideal-gas enthalpy mixing of streams at constant molar heat capacity, using molar-weighted temperature averaging:\n  $$T_{\\mathrm{mix}} = \\dfrac{\\dot{n}_{\\mathrm{hot}} T_{\\mathrm{hot}} + \\dot{n}_{\\mathrm{cold}} T_{\\mathrm{cold}}}{\\dot{n}_{\\mathrm{hot}} + \\dot{n}_{\\mathrm{cold}}},$$\n  where $\\dot{n}$ denote total molar flow rates of the mixing streams and $T_{\\mathrm{cold}}$ is the air temperature.\n\n- Equivalence ratio for an arbitrary gas mixture is defined by the ratio of the stoichiometric oxidizer requirement of the combustible species present to the available oxygen:\n  $$\\phi = \\dfrac{2 \\ \\dot{n}_{\\mathrm{CH_4}} + 0.5 \\ \\dot{n}_{\\mathrm{CO}}}{\\dot{n}_{\\mathrm{O_2}}},$$\n  where all molar flows are those of the mixture at the instant considered. For the rich zone primary feed, let the primary oxygen flow be computed from the specified rich equivalence ratio $\\phi_{\\mathrm{R}}$ using the stoichiometric requirement of methane ($2$ mol $\\mathrm{O_2}$ per mol $\\mathrm{CH_4}$): \n  $$\\dot{n}_{\\mathrm{O_2,R}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{F}}}{\\phi_{\\mathrm{R}}}.$$\n  For the global lean target, the total oxygen added over all zones is \n  $$\\dot{n}_{\\mathrm{O_2,total}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{F}}}{\\phi_{\\mathrm{L}}}.$$\n  The remaining oxygen available for staging after the rich zone is \n  $$\\dot{n}_{\\mathrm{O_2,sec}} = \\max\\!\\left(0, \\ \\dot{n}_{\\mathrm{O_2,total}} - \\dot{n}_{\\mathrm{O_2,R}}\\right).$$\n\n- Decision variable and objective: choose the quench oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}} \\in [0, \\dot{n}_{\\mathrm{O_2,sec}}]$. The remaining secondary oxygen goes to the lean zone, $\\dot{n}_{\\mathrm{O_2,L}} = \\dot{n}_{\\mathrm{O_2,sec}} - \\dot{n}_{\\mathrm{O_2,Q}}$, with accompanying nitrogen in air at the specified ratio. The quench-zone equivalence ratio computed from the perfectly mixed quench inlet (before reaction) is\n  $$\\phi_{\\mathrm{Q,mix}} = \\dfrac{2 \\ \\dot{n}_{\\mathrm{CH_4,Q,in}} + 0.5 \\ \\dot{n}_{\\mathrm{CO,Q,in}}}{\\dot{n}_{\\mathrm{O_2,Q,in}}},$$\n  where the inlet flows are the sum of the rich-zone outlet and the quench air addition. The optimization objective is to minimize the exit nitric oxide molar fraction $\\hat{y}_{\\mathrm{NO,out}}$ at the lean-zone outlet while driving $\\phi_{\\mathrm{Q,mix}}$ close to a target $\\phi_{\\mathrm{Q,target}}$ and enforcing a carbon monoxide outlet molar fraction not exceeding a specified limit $\\hat{y}_{\\mathrm{CO,lim}}$. Use a differentiable penalty formulation:\n  $$J(\\dot{n}_{\\mathrm{O_2,Q}}) = \\hat{y}_{\\mathrm{NO,out}} + w_{\\phi}\\left(\\phi_{\\mathrm{Q,mix}} - \\phi_{\\mathrm{Q,target}}\\right)^2 + w_{\\mathrm{CO}} \\, \\max\\!\\left(0, \\ \\hat{y}_{\\mathrm{CO,out}} - \\hat{y}_{\\mathrm{CO,lim}}\\right)^2,$$\n  with weights $w_{\\phi}$ and $w_{\\mathrm{CO}}$ given below.\n\nImplement the above PSR-chain model, solve each PSR by satisfying the steady-state species balances using the specified kinetics, and then carry out a bounded scalar minimization in $\\dot{n}_{\\mathrm{O_2,Q}}$ for each test case. Express all flows in $\\mathrm{mol/s}$, volumes in $\\mathrm{m^3}$, pressures in $\\mathrm{Pa}$, and temperatures in $\\mathrm{K}$. For all computations use $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$. The program must return the optimal quench oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for each test case as a float rounded to six decimal places.\n\nKinetic parameters and constants to use in all cases:\n- Universal gas constant: $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$.\n- Pressure: $P = 101325 \\ \\mathrm{Pa}$.\n- Air oxygen fraction: $0.21$; air nitrogen to oxygen molar ratio: $3.76$.\n- Air temperature: $T_{\\mathrm{air}} = 300 \\ \\mathrm{K}$.\n- Reaction $1$ (reburn): $A_1 = 2.0 \\times 10^{6} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_1 = 8.0 \\times 10^{4} \\ \\mathrm{J/mol}$.\n- Reaction $2$ (rich oxidation): $A_2 = 1.0 \\times 10^{8} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_2 = 1.25 \\times 10^{5} \\ \\mathrm{J/mol}$.\n- Reaction $3$ (CO oxidation): $A_3 = 5.0 \\times 10^{6} \\ \\mathrm{m^3/(mol \\cdot s)}$, $E_3 = 7.0 \\times 10^{4} \\ \\mathrm{J/mol}$.\n- Reaction $4$ (thermal NO): $A_4 = 4.0 \\times 10^{3} \\ \\mathrm{s^{-1}}$, $E_4 = 2.8 \\times 10^{5} \\ \\mathrm{J/mol}$.\n- Penalty weights: $w_{\\phi} = 100.0$, $w_{\\mathrm{CO}} = 10^{6}$.\n\nTest suite. For each case below, run the optimization and report the optimal $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ in $\\mathrm{mol/s}$ rounded to six decimal places. Each case defines the fuel flow $\\dot{n}_{\\mathrm{F}}$ in $\\mathrm{mol/s}$, rich-zone equivalence ratio $\\phi_{\\mathrm{R}}$, lean global target $\\phi_{\\mathrm{L}}$, quench target $\\phi_{\\mathrm{Q,target}}$, rich-zone temperature $T_{\\mathrm{R}}$ in $\\mathrm{K}$, reactor volumes $V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}$ in $\\mathrm{m^3}$, inlet nitric oxide flow to the rich zone $\\dot{n}_{\\mathrm{NO,in}}$ in $\\mathrm{mol/s}$, and the allowable outlet carbon monoxide molar fraction limit $\\hat{y}_{\\mathrm{CO,lim}}$ (dimensionless mol fraction, expressible as a decimal).\n\n- Case A:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.2$, $\\phi_{\\mathrm{L}} = 0.85$, $\\phi_{\\mathrm{Q,target}} = 0.98$,\n  - $T_{\\mathrm{R}} = 1900$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.03, 0.05, 0.07)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 5.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.5 \\times 10^{-3}$.\n- Case B:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.2$, $\\phi_{\\mathrm{L}} = 0.85$, $\\phi_{\\mathrm{Q,target}} = 0.98$,\n  - $T_{\\mathrm{R}} = 1900$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.03, 0.05, 0.07)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 5.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 2.0 \\times 10^{-4}$.\n- Case C:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.4$, $\\phi_{\\mathrm{L}} = 0.90$, $\\phi_{\\mathrm{Q,target}} = 1.05$,\n  - $T_{\\mathrm{R}} = 2000$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.02, 0.04, 0.06)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 1.0 \\times 10^{-3}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.0 \\times 10^{-3}$.\n- Case D:\n  - $\\dot{n}_{\\mathrm{F}} = 1.0$, $\\phi_{\\mathrm{R}} = 1.1$, $\\phi_{\\mathrm{L}} = 0.98$, $\\phi_{\\mathrm{Q,target}} = 0.95$,\n  - $T_{\\mathrm{R}} = 1850$, $(V_{\\mathrm{R}}, V_{\\mathrm{Q}}, V_{\\mathrm{L}}) = (0.025, 0.035, 0.05)$,\n  - $\\dot{n}_{\\mathrm{NO,in}} = 3.0 \\times 10^{-4}$, $\\hat{y}_{\\mathrm{CO,lim}} = 1.0 \\times 10^{-3}$.\n\nImplementation requirements and output specification:\n\n- Build the three-zone PSR chain exactly as described, using the given reactions, kinetics, and mixing rules. For each zone, solve the PSR steady-state species balances for the outlet molar flows using the ideal-gas relation to compute concentrations from the outlet molar flows.\n- The decision variable is the quench-zone oxygen addition $\\dot{n}_{\\mathrm{O_2,Q}}$ in $\\mathrm{mol/s}$. Respect bounds $0 \\le \\dot{n}_{\\mathrm{O_2,Q}} \\le \\dot{n}_{\\mathrm{O_2,sec}}$.\n- Compute the objective $J(\\dot{n}_{\\mathrm{O_2,Q}})$ and minimize it for each case.\n- The final output must be a single line containing a Python list of four floats corresponding to $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for Cases A, B, C, and D, respectively, each rounded to six decimal places, and in $\\mathrm{mol/s}$, for example:\n  $$[\\mathrm{value\\_A},\\mathrm{value\\_B},\\mathrm{value\\_C},\\mathrm{value\\_D}]$$\n  where each $\\mathrm{value}$ is a decimal number with six digits after the decimal point and no units in the printed line.",
            "solution": "The user has provided a well-posed problem in computational combustion. The task is to model a three-stage NOx reburning process using a series of Perfectly Stirred Reactors (PSRs) and to find an optimal air staging strategy. The problem is scientifically grounded, free of contradictions, and contains all necessary information to construct a numerical solution. The model simplifications, such as a reduced kinetic mechanism and an isothermal assumption for each reactor (decoupled energy equation), are explicitly stated and are standard practice for conceptual-level process modeling.\n\nHerein, I will develop the solution by first establishing the mathematical framework for a single PSR, then constructing the three-reactor chain, and finally embedding this model within an optimization routine to solve for the specified test cases.\n\n### 1. Species and Stoichiometry\nThe model involves $N_s=7$ species: $\\mathrm{CH_4}$, $\\mathrm{O_2}$, $\\mathrm{NO}$, $\\mathrm{CO}$, $\\mathrm{CO_2}$, $\\mathrm{H_2O}$, and $\\mathrm{N_2}$. A consistent ordering is established for vector representation:\n$0: \\mathrm{CH_4}$, $1: \\mathrm{O_2}$, $2: \\mathrm{NO}$, $3: \\mathrm{CO}$, $4: \\mathrm{CO_2}$, $5: \\mathrm{H_2O}$, $6: \\mathrm{N_2}$.\n\nThe problem defines four global reactions. The net stoichiometric coefficient $\\nu_{ij}$ for species $j$ in reaction $i$ can be assembled into a matrix. Let the rows represent reactions $1-4$ and columns represent species $0-6$.\n$$\n\\nu = \\begin{pmatrix}\n-1  0  -4  0  1  2  2 \\\\\n-1  -1.5  0  1  0  2  0 \\\\\n0  -0.5  0  -1  1  0  0 \\\\\n0  -1  2  0  0  0  -1\n\\end{pmatrix}\n$$\n\n### 2. Kinetic and Rate Laws\nFor each reaction $j$, the rate $r_j$ is given by an Arrhenius expression multiplied by concentration terms. All concentrations $C_j$ are in $\\mathrm{mol/m^3}$ and temperature $T$ is in $\\mathrm{K}$. The universal gas constant is $R_u = 8.314 \\ \\mathrm{J/(mol \\cdot K)}$.\nThe rate constants are $k_j(T) = A_j \\exp(-E_j / (R_u T))$. The reaction rates are:\n$$ r_1 = k_1(T) C_{\\mathrm{CH_4}} C_{\\mathrm{NO}} $$\n$$ r_2 = k_2(T) C_{\\mathrm{CH_4}} C_{\\mathrm{O_2}} $$\n$$ r_3 = k_3(T) C_{\\mathrm{CO}} C_{\\mathrm{O_2}} $$\n$$ r_4 = k_4(T) C_{\\mathrm{O_2}}^{1/2} C_{\\mathrm{N_2}}^{1/2} $$\nThe net volumetric production rate for each species $j$, $\\mathcal{R}_j$, is the sum of its production/consumption over all reactions:\n$$ \\mathcal{R}_j(\\mathbf{C}, T) = \\sum_{i=1}^{4} \\nu_{ij} r_i(\\mathbf{C}, T) = (\\boldsymbol{\\nu}^T \\mathbf{r})_j $$\nwhere $\\mathbf{r}$ is the column vector of reaction rates $[r_1, r_2, r_3, r_4]^T$.\n\n### 3. The Perfectly Stirred Reactor (PSR) Model\nThe steady-state mass balance for species $j$ in a PSR is:\n$$ 0 = \\dot{n}_{j,\\mathrm{in}} - \\dot{n}_{j,\\mathrm{out}} + V \\, \\mathcal{R}_j(\\mathbf{C}_{\\mathrm{out}}, T) $$\nwhere $\\dot{n}$ are molar flow rates in $\\mathrm{mol/s}$ and $V$ is the reactor volume in $\\mathrm{m^3}$.\nUnder the ideal gas assumption, the outlet concentrations $\\mathbf{C}_{\\mathrm{out}}$ are related to the outlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{out}}$:\n$$ C_{j, \\mathrm{out}} = \\frac{P}{R_u T} \\frac{\\dot{n}_{j, \\mathrm{out}}}{\\sum_{k=1}^{N_s} \\dot{n}_{k, \\mathrm{out}}} = \\frac{P}{R_u T} \\hat{y}_{j, \\mathrm{out}} $$\nwhere $P$ is the pressure in $\\mathrm{Pa}$ and $\\hat{y}_{j, \\mathrm{out}}$ is the mole fraction. Substituting this into the rate laws makes the PSR equation a system of $N_s$ coupled nonlinear algebraic equations for the unknown outlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{out}}$.\n$$ \\mathbf{F}(\\dot{\\mathbf{n}}_{\\mathrm{out}}) = \\dot{\\mathbf{n}}_{\\mathrm{in}} - \\dot{\\mathbf{n}}_{\\mathrm{out}} + V \\, \\boldsymbol{\\mathcal{R}}(\\dot{\\mathbf{n}}_{\\mathrm{out}}, T) = \\mathbf{0} $$\nThis system must be solved numerically. We will use a root-finding algorithm, specifically `scipy.optimize.root`, with the inlet flow rates as an initial guess for the outlet flow rates. To maintain physical validity during iterations, species concentrations and molar flows will be floored at a small positive number (e.g., $10^{-30}$) to prevent domain errors in functions like `sqrt`.\n\n### 4. The Three-Zone Reactor Chain Simulation\nThe simulation proceeds sequentially through the three reactors for a given decision variable $\\dot{n}_{\\mathrm{O_2,Q}}$.\n\n**a. Zone R (Rich Reactor):**\nThe inlet molar flows $\\dot{\\mathbf{n}}_{\\mathrm{in,R}}$ are determined by the fuel flow $\\dot{n}_{\\mathrm{F}}$ and the rich equivalence ratio $\\phi_{\\mathrm{R}}$.\n- Fuel: $\\dot{n}_{\\mathrm{CH_4,in,R}} = \\dot{n}_{\\mathrm{F}}$\n- Primary Air: $\\dot{n}_{\\mathrm{O_2,R}} = (2 \\dot{n}_{\\mathrm{F}}) / \\phi_{\\mathrm{R}}$ and $\\dot{n}_{\\mathrm{N_2,in,R}} = 3.76 \\cdot \\dot{n}_{\\mathrm{O_2,R}}$\n- Inlet NO: $\\dot{n}_{\\mathrm{NO,in,R}}$ is given by the case data.\n- Other species: $\\dot{n}_{j, \\mathrm{in,R}} = 0$.\nThe PSR equations are solved with volume $V_R$ and temperature $T_R$ to find the outlet flows $\\dot{\\mathbf{n}}_{\\mathrm{out,R}}$.\n\n**b. Zone Q (Quench Reactor):**\nThe inlet to this zone, $\\dot{\\mathbf{n}}_{\\mathrm{in,Q}}$, is the mixture of the rich zone outlet $\\dot{\\mathbf{n}}_{\\mathrm{out,R}}$ and the quench air stream.\n- Quench Air: This stream contains $\\dot{n}_{\\mathrm{O_2,Q}}$ (the decision variable) and $\\dot{n}_{\\mathrm{N_2,Q}} = 3.76 \\cdot \\dot{n}_{\\mathrm{O_2,Q}}$.\n- Inlet Mixture: $\\dot{\\mathbf{n}}_{\\mathrm{in,Q}} = \\dot{\\mathbf{n}}_{\\mathrm{out,R}} + \\dot{\\mathbf{n}}_{\\mathrm{air,Q}}$.\nThe temperature $T_Q$ is calculated by adiabatic mixing:\n$$ T_Q = \\frac{(\\sum \\dot{n}_{j,\\mathrm{out,R}}) T_R + (\\dot{n}_{\\mathrm{O_2,Q}} + \\dot{n}_{\\mathrm{N_2,Q}}) T_{\\mathrm{air}}}{\\sum \\dot{n}_{j,\\mathrm{out,R}} + \\dot{n}_{\\mathrm{O_2,Q}} + \\dot{n}_{\\mathrm{N_2,Q}}} $$\nThe PSR equations are then solved with volume $V_Q$ and calculated temperature $T_Q$ to find $\\dot{\\mathbf{n}}_{\\mathrm{out,Q}}$.\n\n**c. Zone L (Lean Reactor):**\nThe available secondary oxygen is $\\dot{n}_{\\mathrm{O_2,sec}} = (2 \\dot{n}_{\\mathrm{F}} / \\phi_{\\mathrm{L}}) - (2 \\dot{n}_{\\mathrm{F}} / \\phi_{\\mathrm{R}})$.\nThe lean air stream contains $\\dot{n}_{\\mathrm{O_2,L}} = \\dot{n}_{\\mathrm{O_2,sec}} - \\dot{n}_{\\mathrm{O_2,Q}}$ and corresponding nitrogen.\nThe inlet to the lean zone is the mixture of the quench outlet and lean air: $\\dot{\\mathbf{n}}_{\\mathrm{in,L}} = \\dot{\\mathbf{n}}_{\\mathrm{out,Q}} + \\dot{\\mathbf{n}}_{\\mathrm{air,L}}$.\nThe temperature $T_L$ is calculated by a similar mixing rule:\n$$ T_L = \\frac{(\\sum \\dot{n}_{j,\\mathrm{out,Q}}) T_Q + (\\dot{n}_{\\mathrm{O_2,L}} + \\dot{n}_{\\mathrm{N_2,L}}) T_{\\mathrm{air}}}{\\sum \\dot{n}_{j,\\mathrm{out,Q}} + \\dot{n}_{\\mathrm{O_2,L}} + \\dot{n}_{\\mathrm{N_2,L}}} $$\nThe PSR equations are solved with volume $V_L$ and temperature $T_L$ to find the final outlet flows $\\dot{\\mathbf{n}}_{\\mathrm{out,L}}$.\n\n### 5. Optimization\nThe goal is to find the optimal quench oxygen flow $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ that minimizes a cost function $J$. The search is bounded: $0 \\le \\dot{n}_{\\mathrm{O_2,Q}} \\le \\dot{n}_{\\mathrm{O_2,sec}}$.\nThe cost function $J$ is:\n$$ J(\\dot{n}_{\\mathrm{O_2,Q}}) = \\hat{y}_{\\mathrm{NO,out,L}} + w_{\\phi}\\left(\\phi_{\\mathrm{Q,mix}} - \\phi_{\\mathrm{Q,target}}\\right)^2 + w_{\\mathrm{CO}} \\, \\max\\!\\left(0, \\ \\hat{y}_{\\mathrm{CO,out,L}} - \\hat{y}_{\\mathrm{CO,lim}}\\right)^2 $$\n- $\\hat{y}_{\\mathrm{NO,out,L}}$ and $\\hat{y}_{\\mathrm{CO,out,L}}$ are the mole fractions of NO and CO at the exit of the lean zone.\n- $\\phi_{\\mathrm{Q,mix}}$ is the equivalence ratio of the pre-reaction mixture entering the quench zone:\n  $$ \\phi_{\\mathrm{Q,mix}} = \\frac{2 \\ \\dot{n}_{\\mathrm{CH_4,in,Q}} + 0.5 \\ \\dot{n}_{\\mathrm{CO,in,Q}}}{\\dot{n}_{\\mathrm{O_2,in,Q}}} $$\nA scalar bounded optimization algorithm, `scipy.optimize.minimize_scalar` with the 'bounded' method, is employed to find $\\dot{n}_{\\mathrm{O_2,Q}}^{\\star}$ for each test case. If the PSR solver fails for a given $\\dot{n}_{\\mathrm{O_2,Q}}$, the objective function will return a large value to guide the optimizer away from such infeasible regions.\n\nThis entire procedure is implemented for each of the four test cases provided in the problem statement. The resulting optimal quench oxygen flow rates are collected and formatted as the final answer.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import root, minimize_scalar\n\n# Define global constants and structures\nSPECIES_MAP = {'CH4': 0, 'O2': 1, 'NO': 2, 'CO': 3, 'CO2': 4, 'H2O': 5, 'N2': 6}\nNUM_SPECIES = 7\n# Stoichiometric matrix (reactions x species)\n# R1: CH4 + 4NO - 2N2 + CO2 + 2H2O\n# R2: CH4 + 1.5O2 - CO + 2H2O\n# R3: CO + 0.5O2 - CO2\n# R4: N2 + O2 - 2NO\nNU = np.array([\n    # CH4,   O2,  NO,   CO, CO2, H2O,  N2\n    [-1.0,  0.0, -4.0,  0.0, 1.0, 2.0, 2.0],  # R1\n    [-1.0, -1.5,  0.0,  1.0, 0.0, 2.0, 0.0],  # R2\n    [ 0.0, -0.5,  0.0, -1.0, 1.0, 0.0, 0.0],  # R3\n    [ 0.0, -1.0,  2.0,  0.0, 0.0, 0.0,-1.0],  # R4\n], dtype=np.float64)\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the simulation and optimization for all test cases.\n    \"\"\"\n    # Universal constants and model parameters\n    RU = 8.314  # J/(mol.K)\n    P = 101325.0  # Pa\n    T_AIR = 300.0  # K\n    N2_O2_RATIO = 3.76\n\n    KINETICS = {\n        'A': np.array([2.0e6, 1.0e8, 5.0e6, 4.0e3], dtype=np.float64),\n        'E': np.array([8.0e4, 1.25e5, 7.0e4, 2.8e5], dtype=np.float64)\n    }\n    \n    W_PHI = 100.0\n    W_CO = 1.0e6\n\n    # Test cases defined in the problem\n    test_cases = [\n        {'name': 'A', 'n_f': 1.0, 'phi_r': 1.2, 'phi_l': 0.85, 'phi_q_target': 0.98,\n         'T_r': 1900, 'V': (0.03, 0.05, 0.07),\n         'n_no_in': 5.0e-4, 'y_co_lim': 1.5e-3},\n        {'name': 'B', 'n_f': 1.0, 'phi_r': 1.2, 'phi_l': 0.85, 'phi_q_target': 0.98,\n         'T_r': 1900, 'V': (0.03, 0.05, 0.07),\n         'n_no_in': 5.0e-4, 'y_co_lim': 2.0e-4},\n        {'name': 'C', 'n_f': 1.0, 'phi_r': 1.4, 'phi_l': 0.90, 'phi_q_target': 1.05,\n         'T_r': 2000, 'V': (0.02, 0.04, 0.06),\n         'n_no_in': 1.0e-3, 'y_co_lim': 1.0e-3},\n        {'name': 'D', 'n_f': 1.0, 'phi_r': 1.1, 'phi_l': 0.98, 'phi_q_target': 0.95,\n         'T_r': 1850, 'V': (0.025, 0.035, 0.05),\n         'n_no_in': 3.0e-4, 'y_co_lim': 1.0e-3}\n    ]\n\n    def calculate_rates(C, T):\n        \"\"\"Calculates the reaction rates.\"\"\"\n        C = np.maximum(C, 1e-30) # Floor concentrations to avoid math errors\n        k = KINETICS['A'] * np.exp(-KINETICS['E'] / (RU * T))\n        \n        r1 = k[0] * C[SPECIES_MAP['CH4']] * C[SPECIES_MAP['NO']]\n        r2 = k[1] * C[SPECIES_MAP['CH4']] * C[SPECIES_MAP['O2']]\n        r3 = k[2] * C[SPECIES_MAP['CO']] * C[SPECIES_MAP['O2']]\n        r4 = k[3] * np.sqrt(C[SPECIES_MAP['N2']] * C[SPECIES_MAP['O2']])\n        \n        return np.array([r1, r2, r3, r4])\n\n    def solve_psr(n_dot_in, V, T):\n        \"\"\"Solves the PSR non-linear algebraic equations.\"\"\"\n        def residuals(n_dot_out):\n            n_dot_out_phys = np.maximum(n_dot_out, 0.0)\n            n_dot_total_out = np.sum(n_dot_out_phys)\n            \n            if n_dot_total_out  1e-20:\n                C_out = np.zeros(NUM_SPECIES)\n            else:\n                C_out = (P / (RU * T)) * n_dot_out_phys / n_dot_total_out\n            \n            rates = calculate_rates(C_out, T)\n            R_net = NU.T @ rates\n            \n            return n_dot_in - n_dot_out_phys + V * R_net\n\n        sol = root(residuals, n_dot_in, method='hybr', tol=1e-8)\n        \n        if not sol.success:\n            return None\n        return np.maximum(sol.x, 0.0)\n\n    def objective_function(n_o2_q, params):\n        \"\"\"Simulates the 3-PSR chain and computes the objective function J.\"\"\"\n        n_f = params['n_f']\n        phi_r = params['phi_r']\n        phi_l = params['phi_l']\n        phi_q_target = params['phi_q_target']\n        y_co_lim = params['y_co_lim']\n        T_r = params['T_r']\n        V_r, V_q, V_l = params['V']\n        n_no_in = params['n_no_in']\n\n        # --- Zone R (Rich) ---\n        n_dot_in_r = np.zeros(NUM_SPECIES)\n        n_dot_in_r[SPECIES_MAP['CH4']] = n_f\n        n_o2_r = (2.0 * n_f) / phi_r\n        n_dot_in_r[SPECIES_MAP['O2']] = n_o2_r\n        n_dot_in_r[SPECIES_MAP['N2']] = n_o2_r * N2_O2_RATIO\n        n_dot_in_r[SPECIES_MAP['NO']] = n_no_in\n        \n        n_dot_out_r = solve_psr(n_dot_in_r, V_r, T_r)\n        if n_dot_out_r is None: return 1e12\n\n        # --- Zone Q (Quench) ---\n        n_dot_air_q = np.zeros(NUM_SPECIES)\n        n_dot_air_q[SPECIES_MAP['O2']] = n_o2_q\n        n_dot_air_q[SPECIES_MAP['N2']] = n_o2_q * N2_O2_RATIO\n        \n        n_dot_in_q = n_dot_out_r + n_dot_air_q\n        \n        n_total_out_r = np.sum(n_dot_out_r)\n        n_total_air_q = np.sum(n_dot_air_q)\n        T_q = ((n_total_out_r * T_r) + (n_total_air_q * T_AIR)) / (n_total_out_r + n_total_air_q)\n\n        # Calculate phi_q_mix for penalty term\n        phi_q_num = 2.0 * n_dot_in_q[SPECIES_MAP['CH4']] + 0.5 * n_dot_in_q[SPECIES_MAP['CO']]\n        phi_q_den = n_dot_in_q[SPECIES_MAP['O2']] + 1e-30 # Avoid division by zero\n        phi_q_mix = phi_q_num / phi_q_den\n        \n        n_dot_out_q = solve_psr(n_dot_in_q, V_q, T_q)\n        if n_dot_out_q is None: return 1e12\n\n        # --- Zone L (Lean) ---\n        n_o2_total = (2.0 * n_f) / phi_l\n        n_o2_sec = n_o2_total - n_o2_r\n        n_o2_l = n_o2_sec - n_o2_q\n\n        n_dot_air_l = np.zeros(NUM_SPECIES)\n        if n_o2_l  0:\n            n_dot_air_l[SPECIES_MAP['O2']] = n_o2_l\n            n_dot_air_l[SPECIES_MAP['N2']] = n_o2_l * N2_O2_RATIO\n\n        n_dot_in_l = n_dot_out_q + n_dot_air_l\n        \n        n_total_out_q = np.sum(n_dot_out_q)\n        n_total_air_l = np.sum(n_dot_air_l)\n        T_l = ((n_total_out_q * T_q) + (n_total_air_l * T_AIR)) / (n_total_out_q + n_total_air_l)\n\n        n_dot_out_l = solve_psr(n_dot_in_l, V_l, T_l)\n        if n_dot_out_l is None: return 1e12\n        \n        # --- Calculate Objective J ---\n        n_dot_total_out_l = np.sum(n_dot_out_l)\n        y_hat_out_l = n_dot_out_l / (n_dot_total_out_l + 1e-30)\n        \n        y_no_out = y_hat_out_l[SPECIES_MAP['NO']]\n        y_co_out = y_hat_out_l[SPECIES_MAP['CO']]\n        \n        penalty_phi = W_PHI * (phi_q_mix - phi_q_target)**2\n        penalty_co = W_CO * (np.maximum(0, y_co_out - y_co_lim))**2\n        \n        J = y_no_out + penalty_phi + penalty_co\n\n        return J\n\n    results = []\n    for case in test_cases:\n        # Calculate optimization bounds\n        n_f = case['n_f']\n        phi_r = case['phi_r']\n        phi_l = case['phi_l']\n        \n        n_o2_r = (2.0 * n_f) / phi_r\n        n_o2_total = (2.0 * n_f) / phi_l\n        n_o2_sec = max(0, n_o2_total - n_o2_r)\n        \n        bounds_n_o2_q = (0, n_o2_sec)\n\n        # Run optimization\n        opt_result = minimize_scalar(\n            objective_function,\n            args=(case,),\n            method='bounded',\n            bounds=bounds_n_o2_q,\n            options={'xatol': 1e-8, 'maxiter': 500}\n        )\n        \n        results.append(opt_result.x)\n\n    # Format and print the final results\n    print(f\"[{','.join([f'{r:.6f}' for r in results])}]\")\n\nsolve()\n```"
        }
    ]
}