{
    "hands_on_practices": [
        {
            "introduction": "The choice of grid is a fundamental decision in computational fluid dynamics, with profound implications for the stability and accuracy of a simulation. This exercise  provides a compelling, hands-on demonstration of why the MAC staggered grid is often preferred over a simple collocated grid for incompressible flows. By exploring a hypothetical \"checkerboard\" pressure field, you will discover how a collocated scheme can fail to produce a pressure gradient, leading to numerical decoupling, while the MAC scheme's staggered arrangement correctly captures its effect, ensuring robust pressure-velocity coupling.",
            "id": "4100591",
            "problem": "Consider an incompressible flow advanced by a projection method, where the pressure gradient enforces the divergence-free constraint in the velocity update. The pressure appears only through its discrete gradient. In a collocated finite difference scheme, the pressure $p$ and velocity $\\boldsymbol{u}$ are stored at cell centers, whereas in the Marker-and-Cell (MAC) scheme, the pressure $p$ is stored at cell centers and velocity components are stored on cell faces.\n\nWork on a two-dimensional, square, periodic domain discretized by a uniform Cartesian grid of spacing $h$, with integer indices $(i,j)$ for cell centers. Assume nondimensional variables so that $p$ is dimensionless. Define the following discrete operators:\n\n1. In the collocated scheme, approximate the discrete $x$-component of the pressure gradient at a cell center $(i,j)$ by the centered difference\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\mathrm{coll}} \\equiv \\frac{p_{i+1,j} - p_{i-1,j}}{2h}.\n$$\n\n2. In the MAC scheme, approximate the $x$-component of the pressure gradient collocated with the $u$-velocity at the vertical face $(i+\\tfrac{1}{2},j)$ by the one-sided difference\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\mathrm{MAC}} \\equiv \\frac{p_{i+1,j} - p_{i,j}}{h}.\n$$\n\nConsider the checkerboard pressure pattern\n$$\np_{i,j} = (-1)^{i+j}, \\quad \\text{for all integers } i,j,\n$$\non a grid with periodic boundary conditions. Using the above operators, compute and compare the discrete pressure gradients produced by this pattern. Then, specifically determine the MAC discrete $x$-component of the pressure gradient at the face between cells $(0,0)$ and $(1,0)$, i.e., at $(i+\\tfrac{1}{2},j) = (\\tfrac{1}{2},0)$.\n\nExpress your final answer as a single closed-form analytical expression in terms of $h$ only. No rounding is required. If any intermediate physical units would arise, assume nondimensionalization so that the final expression is unitless.",
            "solution": "The problem statement is found to be valid as it is scientifically grounded in the field of computational fluid dynamics, specifically concerning the numerical analysis of finite difference schemes for incompressible flows. It is a well-posed problem with all necessary definitions and conditions provided, allowing for a unique and verifiable solution. The problem is objective and uses standard, unambiguous terminology.\n\nWe are asked to compute and compare the discrete pressure gradients produced by a specific pressure field using two different finite difference approximations, one for a collocated grid and one for a Marker-And-Cell (MAC) staggered grid. Finally, we must compute a specific value for the MAC scheme.\n\nLet the uniform Cartesian grid have a spacing of $h$. The pressure field is given by the checkerboard pattern:\n$$\np_{i,j} = (-1)^{i+j}\n$$\nfor all integer indices $i$ and $j$.\n\nFirst, we analyze the discrete pressure gradient for the collocated scheme. The operator for the $x$-component of the gradient at a cell center $(i,j)$ is defined as:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\mathrm{coll}} \\equiv \\frac{p_{i+1,j} - p_{i-1,j}}{2h}\n$$\nTo evaluate this, we substitute the given pressure field. The pressure at the neighboring cell centers $(i+1,j)$ and $(i-1,j)$ are:\n$$\np_{i+1,j} = (-1)^{(i+1)+j} = (-1)^{i+j+1} = -(-1)^{i+j}\n$$\n$$\np_{i-1,j} = (-1)^{(i-1)+j} = (-1)^{i+j-1} = (-1)^{-1} (-1)^{i+j} = -(-1)^{i+j}\n$$\nSubstituting these expressions into the collocated gradient operator:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j}^{\\mathrm{coll}} = \\frac{-(-1)^{i+j} - \\left(-(-1)^{i+j}\\right)}{2h} = \\frac{-(-1)^{i+j} + (-1)^{i+j}}{2h} = \\frac{0}{2h} = 0\n$$\nThis result holds for any cell $(i,j)$. This demonstrates a critical weakness of the centered difference operator on a collocated grid: it is insensitive to the highest-frequency (checkerboard) mode. A non-zero pressure field produces a zero pressure gradient, which means the discrete projection step would fail to correct a velocity field that generates such a pressure. This is a primary motivation for using staggered grids in projection methods.\n\nNext, we analyze the discrete pressure gradient for the MAC scheme. The operator for the $x$-component of the gradient is located at the vertical cell face $(i+\\frac{1}{2},j)$ and is defined as:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\mathrm{MAC}} \\equiv \\frac{p_{i+1,j} - p_{i,j}}{h}\n$$\nWe substitute the checkerboard pressure field into this operator. We already have $p_{i+1,j} = -(-1)^{i+j}$ and we know $p_{i,j} = (-1)^{i+j}$.\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j}^{\\mathrm{MAC}} = \\frac{-(-1)^{i+j} - (-1)^{i+j}}{h} = \\frac{-2(-1)^{i+j}}{h}\n$$\nUnlike the collocated scheme, the MAC scheme produces a non-zero pressure gradient for the checkerboard pressure field. The magnitude of the gradient is constant, $| \\frac{-2}{h} | = \\frac{2}{h}$, but its sign alternates depending on the parity of $i+j$. This shows that the MAC grid arrangement and its associated finite difference operators can correctly \"see\" and respond to high-frequency pressure modes, which is a significant advantage for stability and accuracy.\n\nFinally, we are asked to determine the specific value of the MAC discrete $x$-component of the pressure gradient at the face $(i+\\frac{1}{2},j) = (\\frac{1}{2},0)$. This location corresponds to the face between cell $(0,0)$ and cell $(1,0)$. Thus, we must evaluate the general expression for $i=0$ and $j=0$.\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{\\frac{1}{2},0}^{\\mathrm{MAC}} = \\frac{-2(-1)^{0+0}}{h} = \\frac{-2(-1)^{0}}{h} = \\frac{-2(1)}{h} = -\\frac{2}{h}\n$$\nThis is the specific value requested.",
            "answer": "$$\n\\boxed{-\\frac{2}{h}}\n$$"
        },
        {
            "introduction": "With the staggered grid structure established as a robust choice, the next step is to correctly formulate the discrete operators that constitute the pressure Poisson equation. This practice  guides you through the crucial derivation of the five-point stencil for the Laplacian operator, which acts on the face-centered velocity data characteristic of the MAC grid. Mastering this Taylor series-based derivation is essential for understanding how continuous differential operators are translated into the discrete language of a computer simulation and for building a valid numerical method.",
            "id": "4100667",
            "problem": "Consider the incompressible Navierâ€“Stokes equations discretized on a Marker-and-Cell (MAC) grid on a two-dimensional rectangular domain with uniform grid spacings $\\Delta x$ and $\\Delta y$. The horizontal velocity component $u$ is stored at the centers of the vertical cell faces at locations $(x_{i+1/2}, y_{j}) = \\left((i+\\tfrac{1}{2})\\Delta x, j \\Delta y\\right)$. The face-centered Laplacian operator acting on $u$ at $(i+\\tfrac{1}{2}, j)$ is defined by the continuous operator $\\nabla^{2} u = \\frac{\\partial^{2} u}{\\partial x^{2}} + \\frac{\\partial^{2} u}{\\partial y^{2}}$ evaluated at that face location, and is to be approximated using second-order central differences that are consistent with the face-centered arrangement.\n\nStarting from the definition of second derivatives and Taylor expansions about $(x_{i+1/2}, y_{j})$, derive the five-point discrete stencil and its coefficients that approximate $\\nabla^{2} u$ at $(i+\\tfrac{1}{2}, j)$ using the neighboring face-centered values $u_{i+3/2, j}$, $u_{i+1/2, j}$, $u_{i-1/2, j}$, $u_{i+1/2, j+1}$, and $u_{i+1/2, j-1}$. Express the discrete operator in the form\n$$\n\\left(\\nabla^{2} u\\right)_{i+1/2, j} \\approx a_{0}\\,u_{i+1/2, j} + a_{\\mathrm{E}}\\,u_{i+3/2, j} + a_{\\mathrm{W}}\\,u_{i-1/2, j} + a_{\\mathrm{N}}\\,u_{i+1/2, j+1} + a_{\\mathrm{S}}\\,u_{i+1/2, j-1},\n$$\nand provide the coefficients $a_{0}$, $a_{\\mathrm{E}}$, $a_{\\mathrm{W}}$, $a_{\\mathrm{N}}$, and $a_{\\mathrm{S}}$ in terms of $\\Delta x$ and $\\Delta y$.\n\nAnswer format: Return the ordered row vector of coefficients $[a_{0}, a_{\\mathrm{E}}, a_{\\mathrm{W}}, a_{\\mathrm{N}}, a_{\\mathrm{S}}]$ as a single $1\\times 5$ row matrix. The final answer must be an exact symbolic expression. Do not include units in the final answer.",
            "solution": "The user wants to find the five-point stencil for the Laplacian operator, $\\nabla^{2} u$, on a staggered Marker-and-Cell (MAC) grid. The horizontal velocity component $u$ is located at the center of vertical cell faces, indexed as $(i+\\frac{1}{2}, j)$. The task is to derive the discrete approximation using second-order central differences.\n\nThe Laplacian operator in two dimensions is defined as:\n$$\n\\nabla^{2} u = \\frac{\\partial^{2} u}{\\partial x^{2}} + \\frac{\\partial^{2} u}{\\partial y^{2}}\n$$\nWe need to find a discrete approximation for this operator at the point $(x_{i+1/2}, y_{j})$. We will approximate each second-derivative term separately using central differences and then sum them. The approximation must use the specified neighboring face-centered velocity values: $u_{i+3/2, j}$, $u_{i-1/2, j}$, $u_{i+1/2, j+1}$, and $u_{i+1/2, j-1}$.\n\nFirst, let's approximate the term $\\frac{\\partial^{2} u}{\\partial x^{2}}$ at $(x_{i+1/2}, y_{j})$. We use Taylor series expansions for the neighboring points in the x-direction, $u_{i+3/2, j} = u(x_{i+1/2}+\\Delta x, y_j)$ and $u_{i-1/2, j} = u(x_{i+1/2}-\\Delta x, y_j)$, expanded around the central point $(x_{i+1/2}, y_j)$. Let $u_{i+1/2,j}$ denote $u(x_{i+1/2}, y_j)$.\n\nThe forward Taylor expansion is:\n$$\nu_{i+3/2, j} = u_{i+1/2, j} + \\Delta x \\left(\\frac{\\partial u}{\\partial x}\\right)_{i+1/2, j} + \\frac{(\\Delta x)^{2}}{2!} \\left(\\frac{\\partial^{2} u}{\\partial x^{2}}\\right)_{i+1/2, j} + \\frac{(\\Delta x)^{3}}{3!} \\left(\\frac{\\partial^{3} u}{\\partial x^{3}}\\right)_{i+1/2, j} + O((\\Delta x)^{4})\n$$\nThe backward Taylor expansion is:\n$$\nu_{i-1/2, j} = u_{i+1/2, j} - \\Delta x \\left(\\frac{\\partial u}{\\partial x}\\right)_{i+1/2, j} + \\frac{(\\Delta x)^{2}}{2!} \\left(\\frac{\\partial^{2} u}{\\partial x^{2}}\\right)_{i+1/2, j} - \\frac{(\\Delta x)^{3}}{3!} \\left(\\frac{\\partial^{3} u}{\\partial x^{3}}\\right)_{i+1/2, j} + O((\\Delta x)^{4})\n$$\nAdding these two expansions, the odd-order derivative terms cancel out:\n$$\nu_{i+3/2, j} + u_{i-1/2, j} = 2 u_{i+1/2, j} + (\\Delta x)^{2} \\left(\\frac{\\partial^{2} u}{\\partial x^{2}}\\right)_{i+1/2, j} + O((\\Delta x)^{4})\n$$\nNow, we can solve for the second derivative $\\frac{\\partial^{2} u}{\\partial x^{2}}$:\n$$\n\\left(\\frac{\\partial^{2} u}{\\partial x^{2}}\\right)_{i+1/2, j} = \\frac{u_{i-1/2, j} - 2 u_{i+1/2, j} + u_{i+3/2, j}}{(\\Delta x)^{2}} + O((\\Delta x)^{2})\n$$\nThis is the second-order central difference approximation for the second partial derivative with respect to $x$.\n\nNext, we approximate the term $\\frac{\\partial^{2} u}{\\partial y^{2}}$ at the same point $(x_{i+1/2}, y_{j})$. The neighboring points in the y-direction are $u_{i+1/2, j+1} = u(x_{i+1/2}, y_j+\\Delta y)$ and $u_{i+1/2, j-1} = u(x_{i+1/2}, y_j-\\Delta y)$. We perform Taylor series expansions in the y-variable:\n$$\nu_{i+1/2, j+1} = u_{i+1/2, j} + \\Delta y \\left(\\frac{\\partial u}{\\partial y}\\right)_{i+1/2, j} + \\frac{(\\Delta y)^{2}}{2!} \\left(\\frac{\\partial^{2} u}{\\partial y^{2}}\\right)_{i+1/2, j} + O((\\Delta y)^{3})\n$$\n$$\nu_{i+1/2, j-1} = u_{i+1/2, j} - \\Delta y \\left(\\frac{\\partial u}{\\partial y}\\right)_{i+1/2, j} + \\frac{(\\Delta y)^{2}}{2!} \\left(\\frac{\\partial^{2} u}{\\partial y^{2}}\\right)_{i+1/2, j} - O((\\Delta y)^{3})\n$$\nAdding these two expansions gives:\n$$\nu_{i+1/2, j+1} + u_{i+1/2, j-1} = 2 u_{i+1/2, j} + (\\Delta y)^{2} \\left(\\frac{\\partial^{2} u}{\\partial y^{2}}\\right)_{i+1/2, j} + O((\\Delta y)^{4})\n$$\nSolving for the second derivative $\\frac{\\partial^{2} u}{\\partial y^{2}}$:\n$$\n\\left(\\frac{\\partial^{2} u}{\\partial y^{2}}\\right)_{i+1/2, j} = \\frac{u_{i+1/2, j-1} - 2 u_{i+1/2, j} + u_{i+1/2, j+1}}{(\\Delta y)^{2}} + O((\\Delta y)^{2})\n$$\nThis is the second-order central difference approximation for the second partial derivative with respect to $y$.\n\nNow, we combine the two approximations to form the discrete Laplacian operator:\n$$\n\\left(\\nabla^{2} u\\right)_{i+1/2, j} \\approx \\frac{u_{i-1/2, j} - 2 u_{i+1/2, j} + u_{i+3/2, j}}{(\\Delta x)^{2}} + \\frac{u_{i+1/2, j-1} - 2 u_{i+1/2, j} + u_{i+1/2, j+1}}{(\\Delta y)^{2}}\n$$\nTo match the required form, we group the terms by their corresponding velocity components:\n$$\n\\left(\\nabla^{2} u\\right)_{i+1/2, j} \\approx \\left(-\\frac{2}{(\\Delta x)^{2}} - \\frac{2}{(\\Delta y)^{2}}\\right) u_{i+1/2, j} + \\frac{1}{(\\Delta x)^{2}} u_{i+3/2, j} + \\frac{1}{(\\Delta x)^{2}} u_{i-1/2, j} + \\frac{1}{(\\Delta y)^{2}} u_{i+1/2, j+1} + \\frac{1}{(\\Delta y)^{2}} u_{i+1/2, j-1}\n$$\nComparing this expression to the problem statement's required form:\n$$\n\\left(\\nabla^{2} u\\right)_{i+1/2, j} \\approx a_{0}\\,u_{i+1/2, j} + a_{\\mathrm{E}}\\,u_{i+3/2, j} + a_{\\mathrm{W}}\\,u_{i-1/2, j} + a_{\\mathrm{N}}\\,u_{i+1/2, j+1} + a_{\\mathrm{S}}\\,u_{i+1/2, j-1}\n$$\nWe can identify the coefficients:\n- The coefficient of the central node $u_{i+1/2, j}$ is $a_{0} = -\\frac{2}{(\\Delta x)^{2}} - \\frac{2}{(\\Delta y)^{2}} = -2\\left(\\frac{1}{(\\Delta x)^{2}} + \\frac{1}{(\\Delta y)^{2}}\\right)$.\n- The coefficient of the East node $u_{i+3/2, j}$ is $a_{\\mathrm{E}} = \\frac{1}{(\\Delta x)^{2}}$.\n- The coefficient of the West node $u_{i-1/2, j}$ is $a_{\\mathrm{W}} = \\frac{1}{(\\Delta x)^{2}}$.\n- The coefficient of the North node $u_{i+1/2, j+1}$ is $a_{\\mathrm{N}} = \\frac{1}{(\\Delta y)^{2}}$.\n- The coefficient of the South node $u_{i+1/2, j-1}$ is $a_{\\mathrm{S}} = \\frac{1}{(\\Delta y)^{2}}$.\n\nThe ordered vector of coefficients $[a_{0}, a_{\\mathrm{E}}, a_{\\mathrm{W}}, a_{\\mathrm{N}}, a_{\\mathrm{S}}]$ is therefore:\n$$\n\\left[ -2\\left(\\frac{1}{(\\Delta x)^{2}} + \\frac{1}{(\\Delta y)^{2}}\\right), \\frac{1}{(\\Delta x)^{2}}, \\frac{1}{(\\Delta x)^{2}}, \\frac{1}{(\\Delta y)^{2}}, \\frac{1}{(\\Delta y)^{2}} \\right]\n$$\nThis represents the five-point stencil for the Laplacian operator on a staggered grid for the $u$-velocity component.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -2\\left(\\frac{1}{(\\Delta x)^{2}} + \\frac{1}{(\\Delta y)^{2}}\\right) & \\frac{1}{(\\Delta x)^{2}} & \\frac{1}{(\\Delta x)^{2}} & \\frac{1}{(\\Delta y)^{2}} & \\frac{1}{(\\Delta y)^{2}} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Theoretical concepts and discrete formulas truly come to life when they are implemented in functional code. This final practice  challenges you to build the core component of an incompressible flow solver: the projection step itself. By taking a tentative velocity field that is not divergence-free, solving the discrete Poisson equation for the correcting potential, and applying the velocity update, you will directly enforce the incompressibility constraint and gain a tangible understanding of how the MAC scheme operates from start to finish.",
            "id": "4100607",
            "problem": "Consider a two-dimensional incompressible flow advanced by a projection method on a Marker-and-Cell (MAC) grid, where velocity components are stored on cell faces and the pressure (or pressure increment potential) is stored at cell centers. Start from the fundamental conservation of mass for an incompressible Newtonian fluid, namely $ \\nabla \\cdot \\mathbf{u} = 0 $, and the idea of Helmholtz decomposition that any sufficiently smooth vector field can be decomposed into a divergence-free part plus a gradient field. On a uniform rectangular lattice with spacings $ \\Delta x $ and $ \\Delta y $, define the discrete operators so that the discrete divergence acting on face-centered velocities yields a cell-centered scalar, and the discrete gradient acting on cell-centered scalars yields face-centered components. Assume periodic boundary conditions in both directions.\n\nUsing only these core principles and definitions, derive the discrete scalar Poisson problem for a cell-centered potential $ \\phi $ that enforces discrete incompressibility of the corrected velocity field over one time increment $ \\Delta t $ when a tentative velocity $ \\mathbf{u}^* $ is provided. The discrete divergence at cell center $ (i,j) $ must be computed by combining the face-normal differences at $ (i\\pm \\tfrac{1}{2},j) $ and $ (i,j\\pm \\tfrac{1}{2}) $ with periodic wrapping. The discrete gradient used in the velocity correction must be the face-normal difference of adjacent cell-centered potentials. Express all quantities in dimensionless form.\n\nImplement a program that:\n- Constructs face-centered tentative velocities $ u^* $ and $ v^* $ on an $ N_x \\times N_y $ periodic grid (cell centers) with spacings $ \\Delta x $ and $ \\Delta y $.\n- Forms the cell-centered right-hand side proportional to the discrete divergence of $ \\mathbf{u}^* $ scaled by $ \\Delta t $.\n- Solves the discrete periodic Poisson equation for $ \\phi $ using a spectral method consistent with the standard $ 5 $-point periodic Laplacian stencil.\n- Applies the velocity correction consistent with the derived discrete operators so that the corrected velocity $ \\mathbf{u}^{n+1} $ is as close to discrete divergence-free as machine precision permits.\n- Computes the maximum absolute value of the discrete divergence of the corrected velocity field for specified test cases, or the ratio of divergences when appropriate.\n\nUse the following precise discrete definitions on an $ N_x \\times N_y $ grid of cell centers with periodic indexing. All arrays for face-centered velocities $ u $ and $ v $ have shape $ (N_x, N_y) $, understood as $ u $ values located at positions $ (i+\\tfrac{1}{2},j) $ and $ v $ values at $ (i,j+\\tfrac{1}{2}) $, with $ i \\in \\{0,\\ldots,N_x-1\\} $ and $ j \\in \\{0,\\ldots,N_y-1\\} $:\n- Discrete divergence at each cell center:\n$$\n(\\nabla_h \\cdot \\mathbf{u})_{i,j} \\equiv \\frac{u_{i,j} - u_{i-1,j}}{\\Delta x} + \\frac{v_{i,j} - v_{i,j-1}}{\\Delta y},\n$$\nwith periodic wrap for indices $ i-1 $ and $ j-1 $.\n- Discrete gradient components evaluated on faces from a cell-centered scalar $ \\phi $:\n$$\n(\\partial_x^h \\phi)_{i+\\frac{1}{2},j} \\equiv \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{\\Delta x}, \\quad\n(\\partial_y^h \\phi)_{i,j+\\frac{1}{2}} \\equiv \\frac{\\phi_{i,j+1} - \\phi_{i,j}}{\\Delta y},\n$$\nwith periodic wrap on indices $ i+1 $ and $ j+1 $.\n- The periodic discrete Laplacian at cell centers is the standard $ 5 $-point stencil with periodic wraps in both directions.\n\nYour implementation must use a spectral solver for the periodic Poisson equation on cell centers that diagonalizes the discrete Laplacian in Fourier space: for wavenumbers $ k_x \\in \\{0,\\ldots,N_x-1\\} $ and $ k_y \\in \\{0,\\ldots,N_y-1\\} $, the eigenvalue of the discrete Laplacian is\n$$\n\\lambda(k_x,k_y) = \\frac{2\\left(\\cos\\left(\\frac{2\\pi k_x}{N_x}\\right) - 1\\right)}{\\Delta x^2} + \\frac{2\\left(\\cos\\left(\\frac{2\\pi k_y}{N_y}\\right) - 1\\right)}{\\Delta y^2}.\n$$\nEnforce a zero-mean solution for $ \\phi $ by setting the zero-frequency mode to zero, which is consistent with removing the nullspace mode of the periodic Laplacian. If the right-hand side is not zero-mean, subtract its mean before solving.\n\nTest Suite. Your program must run the following five independent test cases and aggregate the results into a single output:\n- Test $ 1 $ (happy path): $ N_x = 8 $, $ N_y = 6 $, $ \\Delta x = 1.0 $, $ \\Delta y = 1.0 $, $ \\Delta t = 0.1 $. Generate $ u^* $ and $ v^* $ as independent pseudorandom standard normal fields using a fixed seed $ 1 $. Solve for $ \\phi $, correct the velocity, and report the maximum absolute discrete divergence of the corrected field as a float.\n- Test $ 2 $ (no-op correction with constant increment): $ N_x = 8 $, $ N_y = 6 $, $ \\Delta x = 1.0 $, $ \\Delta y = 1.0 $, $ \\Delta t = 0.1 $. Generate $ u^* $ and $ v^* $ as independent pseudorandom standard normal fields with seed $ 2 $. Set $ \\phi $ to the constant $ 1.234 $ everywhere, apply the correction, and report the ratio of the maximum absolute discrete divergence after correction to that before correction as a float.\n- Test $ 3 $ (exact gradient cancellation): $ N_x = 16 $, $ N_y = 16 $, $ \\Delta x = 1.0 $, $ \\Delta y = 1.0 $, $ \\Delta t = 0.2 $. Define a cell-centered potential $ \\phi_{i,j} = \\sin\\!\\left(2\\pi \\frac{2\\, i}{N_x}\\right) + 0.5 \\cos\\!\\left(2\\pi \\frac{3\\, j}{N_y}\\right) $. Set $ u^* $ and $ v^* $ equal to $ \\Delta t $ times the corresponding discrete gradient components of $ \\phi $ on faces. Apply the correction with this same $ \\phi $ and report the maximum absolute discrete divergence as a float.\n- Test $ 4 $ (anisotropic grid spacings): $ N_x = 10 $, $ N_y = 12 $, $ \\Delta x = 0.5 $, $ \\Delta y = 0.8 $, $ \\Delta t = 0.05 $. Generate $ u^* $ and $ v^* $ as independent pseudorandom standard normal fields with seed $ 3 $. Solve for $ \\phi $, correct, and report the maximum absolute discrete divergence as a float.\n- Test $ 5 $ (zero time step edge case): $ N_x = 12 $, $ N_y = 7 $, $ \\Delta x = 1.0 $, $ \\Delta y = 1.0 $, $ \\Delta t = 0.0 $. Generate $ u^* $ and $ v^* $ as independent pseudorandom standard normal fields with seed $ 4 $. Do not solve for $ \\phi $; set $ \\phi $ to zero and apply the correction. Report the ratio of the maximum absolute discrete divergence after correction to that before correction as a float.\n\nAngle units are in radians. All quantities are dimensionless. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $ [r_1,r_2,r_3,r_4,r_5] $), where each $ r_k $ is a float. For reproducibility, format each float in scientific notation with six digits after the decimal point.",
            "solution": "The problem requires the derivation of the discrete Poisson equation for a pressure-like potential $\\phi$ within a projection method for incompressible flows on a staggered Marker-and-Cell (MAC) grid. This derivation begins from the fundamental principle of mass conservation for an incompressible fluid, $\\nabla \\cdot \\mathbf{u} = 0$, and the structure of a projection method.\n\nA projection method typically involves a two-step process to advance the velocity field from time $t^n$ to $t^{n+1} = t^n + \\Delta t$. First, an intermediate or tentative velocity field, $\\mathbf{u}^*$, is computed by advancing the momentum equation without considering the pressure gradient. This field $\\mathbf{u}^*$ does not, in general, satisfy the incompressibility constraint, i.e., $\\nabla \\cdot \\mathbf{u}^* \\neq 0$.\n\nThe second step is the projection step, which corrects $\\mathbf{u}^*$ to produce a new velocity field, $\\mathbf{u}^{n+1}$, that is discretely divergence-free. This correction is based on the Helmholtz decomposition, which states that any vector field ($\\mathbf{u}^*$ in this case) can be decomposed into a divergence-free component and the gradient of a scalar potential. The projection step effectively subtracts this gradient part from $\\mathbf{u}^*$. The correction is formulated as:\n$$\n\\mathbf{u}^{n+1} = \\mathbf{u}^* - \\nabla \\psi\n$$\nwhere $\\psi$ is a scalar potential. In the context of the Navier-Stokes equations, this potential is related to the time-integrated pressure, such that $\\nabla \\psi$ is proportional to $\\Delta t \\nabla p$. Let's define a potential $\\phi$ such that the update is written as:\n$$\n\\mathbf{u}^{n+1} = \\mathbf{u}^* - \\Delta t \\, \\nabla \\phi\n$$\nThe core requirement is that the corrected velocity field $\\mathbf{u}^{n+1}$ must satisfy the incompressibility constraint:\n$$\n\\nabla \\cdot \\mathbf{u}^{n+1} = 0\n$$\nSubstituting the expression for $\\mathbf{u}^{n+1}$ into the incompressibility condition yields:\n$$\n\\nabla \\cdot (\\mathbf{u}^* - \\Delta t \\, \\nabla \\phi) = 0\n$$\nAssuming the divergence operator is linear, we can distribute it across the terms:\n$$\n\\nabla \\cdot \\mathbf{u}^* - \\Delta t \\, (\\nabla \\cdot \\nabla \\phi) = 0\n$$\nThe term $\\nabla \\cdot \\nabla \\phi$ is the definition of the Laplacian operator, $\\nabla^2 \\phi$. This leads to the continuous Poisson equation for the potential $\\phi$:\n$$\n\\nabla^2 \\phi = \\frac{1}{\\Delta t} \\nabla \\cdot \\mathbf{u}^*\n$$\nThis equation states that the Laplacian of the potential $\\phi$ is proportional to the divergence of the tentative velocity field.\n\nTo translate this to the discrete MAC grid, we employ the provided discrete operators. The grid has cell centers indexed by $(i,j)$, horizontal velocity components $u$ located at face centers $(i+\\tfrac{1}{2},j)$, and vertical velocity components $v$ at face centers $(i,j+\\tfrac{1}{2})$. All indices are periodic.\n\nThe discrete divergence operator, $\\nabla_h \\cdot$, maps face-centered velocity fields to a cell-centered scalar field. At cell $(i,j)$, it is defined as:\n$$\n(\\nabla_h \\cdot \\mathbf{u})_{i,j} = \\frac{u_{i,j} - u_{i-1,j}}{\\Delta x} + \\frac{v_{i,j} - v_{i,j-1}}{\\Delta y}\n$$\nHere, $u_{i,j}$ denotes the velocity on the right face of cell $(i,j)$ (at position $i+\\tfrac{1}{2},j$), and $u_{i-1,j}$ denotes the velocity on the left face of cell $(i,j)$ (at position $i-\\tfrac{1}{2},j$). A similar convention applies to the vertical velocities $v$.\n\nThe discrete gradient operator, $\\nabla_h$, maps a cell-centered scalar field $\\phi$ to face-centered vector components. The horizontal component on the face at $(i+\\tfrac{1}{2},j)$ and the vertical component on the face at $(i,j+\\tfrac{1}{2})$ are:\n$$\n(\\partial_x^h \\phi)_{i+\\frac{1}{2},j} = \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{\\Delta x}\n$$\n$$\n(\\partial_y^h \\phi)_{i,j+\\frac{1}{2}} = \\frac{\\phi_{i,j+1} - \\phi_{i,j}}{\\Delta y}\n$$\n\nThe discrete Poisson equation is obtained by substituting these discrete operators into the continuous equation:\n$$\n\\nabla_h^2 \\phi = \\frac{1}{\\Delta t} \\nabla_h \\cdot \\mathbf{u}^*\n$$\nThe left-hand side, the discrete Laplacian $\\nabla_h^2 \\phi$, is the divergence of the gradient, $(\\nabla_h \\cdot \\nabla_h \\phi)$. Applying the discrete divergence operator to the discrete gradient gives:\n$$\n(\\nabla_h^2 \\phi)_{i,j} = \\frac{(\\partial_x^h \\phi)_{i+\\frac{1}{2},j} - (\\partial_x^h \\phi)_{i-\\frac{1}{2},j}}{\\Delta x} + \\frac{(\\partial_y^h \\phi)_{i,j+\\frac{1}{2}} - (\\partial_y^h \\phi)_{i,j-\\frac{1}{2}}}{\\Delta y}\n$$\nSubstituting the definitions for the gradient components:\n$$\n(\\nabla_h^2 \\phi)_{i,j} = \\frac{1}{\\Delta x} \\left( \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{\\Delta x} - \\frac{\\phi_{i,j} - \\phi_{i-1,j}}{\\Delta x} \\right) + \\frac{1}{\\Delta y} \\left( \\frac{\\phi_{i,j+1} - \\phi_{i,j}}{\\Delta y} - \\frac{\\phi_{i,j} - \\phi_{i,j-1}}{\\Delta y} \\right)\n$$\nThis simplifies to the standard 5-point finite difference stencil for the Laplacian on a rectangular grid:\n$$\n(\\nabla_h^2 \\phi)_{i,j} = \\frac{\\phi_{i+1,j} - 2\\phi_{i,j} + \\phi_{i-1,j}}{\\Delta x^2} + \\frac{\\phi_{i,j+1} - 2\\phi_{i,j} + \\phi_{i,j-1}}{\\Delta y^2}\n$$\nThe problem is to solve $\\nabla_h^2 \\phi = b$, where the right-hand side (RHS) is $b_{i,j} = \\frac{1}{\\Delta t} (\\nabla_h \\cdot \\mathbf{u}^*)_{i,j}$.\n\nThis linear system is solved efficiently using a spectral method given the periodic boundary conditions. The discrete Fourier transform (DFT) diagonalizes the discrete Laplacian operator. Taking the 2D DFT of the Poisson equation transforms it from a system of coupled difference equations to a set of independent algebraic equations in Fourier space:\n$$\n\\widehat{(\\nabla_h^2 \\phi)}(k_x,k_y) = \\hat{b}(k_x,k_y)\n$$\nThe Fourier transform of the discrete Laplacian operator is its eigenvalue, $\\lambda(k_x, k_y)$. Thus, for each wavenumber pair $(k_x, k_y)$, we have:\n$$\n\\lambda(k_x,k_y) \\hat{\\phi}(k_x,k_y) = \\hat{b}(k_x,k_y)\n$$\nThe eigenvalues for the 5-point stencil on an $N_x \\times N_y$ periodic grid are given as:\n$$\n\\lambda(k_x,k_y) = \\frac{2\\left(\\cos\\left(\\frac{2\\pi k_x}{N_x}\\right) - 1\\right)}{\\Delta x^2} + \\frac{2\\left(\\cos\\left(\\frac{2\\pi k_y}{N_y}\\right) - 1\\right)}{\\Delta y^2}\n$$\nThe solution for the Fourier coefficients of the potential is $\\hat{\\phi}(k_x,k_y) = \\hat{b}(k_x,k_y) / \\lambda(k_x,k_y)$. A complication arises for the zero-frequency mode $(k_x, k_y) = (0,0)$, where $\\lambda(0,0)=0$, reflecting the fact that the Laplacian's nullspace consists of constant functions. For a solution to exist, the RHS must be compatible, meaning its mean must be zero, i.e., $\\hat{b}(0,0)=0$. For the discrete divergence on a periodic domain, this condition is satisfied analytically. Numerically, we enforce this by subtracting any non-zero mean from the RHS due to floating-point error. To ensure a unique solution for $\\phi$, we enforce that $\\phi$ has a zero mean, which means its zero-frequency Fourier coefficient $\\hat{\\phi}(0,0)$ must be zero.\n\nThe solution algorithm is:\n1.  Compute the cell-centered RHS field, $b = \\frac{1}{\\Delta t} \\nabla_h \\cdot \\mathbf{u}^*$.\n2.  Ensure $b$ has zero mean: $b \\leftarrow b - \\text{mean}(b)$.\n3.  Compute the 2D DFT of $b$ to get $\\hat{b}(k_x,k_y)$.\n4.  Compute the Fourier coefficients of the potential: $\\hat{\\phi}(k_x,k_y) = \\hat{b}(k_x,k_y) / \\lambda(k_x,k_y)$ for $(k_x,k_y) \\neq (0,0)$, and set $\\hat{\\phi}(0,0)=0$.\n5.  Compute the inverse 2D DFT of $\\hat{\\phi}$ to obtain the cell-centered potential field $\\phi(i,j)$.\n\nOnce $\\phi$ is known, the final, discretely divergence-free velocity field $\\mathbf{u}^{n+1}$ is computed by applying the discrete correction:\n$$\nu_{i+\\frac{1}{2},j}^{n+1} = u_{i+\\frac{1}{2},j}^* - \\Delta t \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{\\Delta x}\n$$\n$$\nv_{i,j+\\frac{1}{2}}^{n+1} = v_{i,j+\\frac{1}{2}}^* - \\Delta t \\frac{\\phi_{i,j+1} - \\phi_{i,j}}{\\Delta y}\n$$\nThe divergence of this resulting field, $\\nabla_h \\cdot \\mathbf{u}^{n+1}$, should be zero up to machine precision.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy is not used, as FFT is in numpy.\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases for the projection method problem.\n    \"\"\"\n\n    def discrete_divergence(u, v, dx, dy):\n        \"\"\"Computes discrete divergence of face-centered u, v -> cell-centered scalar.\"\"\"\n        # u[i,j] is on right face of cell (i,j), u[i-1, j] is on left face\n        # In numpy, u[i-1] is np.roll(u, 1, axis=0)\n        div_x = (u - np.roll(u, 1, axis=0)) / dx\n        # v[i,j] is on top face of cell (i,j), v[i, j-1] is on bottom face\n        # In numpy, v[j-1] is np.roll(v, 1, axis=1)\n        div_y = (v - np.roll(v, 1, axis=1)) / dy\n        return div_x + div_y\n\n    def discrete_gradient(phi, dx, dy):\n        \"\"\"Computes discrete gradient of cell-centered phi -> face-centered vector.\"\"\"\n        # grad_x at (i+1/2, j) is (phi[i+1,j] - phi[i,j])/dx\n        # In numpy, phi[i+1] is np.roll(phi, -1, axis=0)\n        grad_x = (np.roll(phi, -1, axis=0) - phi) / dx\n        # grad_y at (i, j+1/2) is (phi[i,j+1] - phi[i,j])/dy\n        # In numpy, phi[j+1] is np.roll(phi, -1, axis=1)\n        grad_y = (np.roll(phi, -1, axis=1) - phi) / dy\n        return grad_x, grad_y\n\n    def solve_poisson_spectral(rhs, dx, dy):\n        \"\"\"Solves the periodic Poisson equation using a spectral method.\"\"\"\n        Nx, Ny = rhs.shape\n        \n        # Create wavenumber grids corresponding to FFT output\n        kx_indices = np.arange(Nx)\n        ky_indices = np.arange(Ny)\n        Kx, Ky = np.meshgrid(kx_indices, ky_indices, indexing='ij')\n\n        # Calculate eigenvalues of the 5-point discrete Laplacian\n        lambda_k = (2 * (np.cos(2 * np.pi * Kx / Nx) - 1) / dx**2 +\n                    2 * (np.cos(2 * np.pi * Ky / Ny) - 1) / dy**2)\n\n        # Handle the nullspace: prepare inverse eigenvalues\n        # Set lambda_k(0,0) to a non-zero value to avoid division by zero error.\n        # Its effect is nullified later.\n        lambda_k[0, 0] = 1.0 # arbitrary non-zero\n        inv_lambda_k = 1.0 / lambda_k\n        inv_lambda_k[0, 0] = 0.0 # Enforce zero mean for phi\n\n        # FFT of the right-hand side\n        rhs_hat = np.fft.fft2(rhs)\n\n        # Solve for phi in Fourier space\n        phi_hat = rhs_hat * inv_lambda_k\n\n        # Inverse FFT to get phi in real space\n        phi = np.fft.ifft2(phi_hat).real\n        \n        return phi\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test 1: happy path\n        {'Nx': 8, 'Ny': 6, 'dx': 1.0, 'dy': 1.0, 'dt': 0.1, 'seed': 1, 'mode': 'solve'},\n        # Test 2: no-op correction with constant increment\n        {'Nx': 8, 'Ny': 6, 'dx': 1.0, 'dy': 1.0, 'dt': 0.1, 'seed': 2, 'mode': 'const_phi'},\n        # Test 3: exact gradient cancellation\n        {'Nx': 16, 'Ny': 16, 'dx': 1.0, 'dy': 1.0, 'dt': 0.2, 'seed': None, 'mode': 'exact_grad'},\n        # Test 4: anisotropic grid spacings\n        {'Nx': 10, 'Ny': 12, 'dx': 0.5, 'dy': 0.8, 'dt': 0.05, 'seed': 3, 'mode': 'solve'},\n        # Test 5: zero time step edge case\n        {'Nx': 12, 'Ny': 7, 'dx': 1.0, 'dy': 1.0, 'dt': 0.0, 'seed': 4, 'mode': 'zero_dt'},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        Nx, Ny = case['Nx'], case['Ny']\n        dx, dy = case['dx'], case['dy']\n        dt = case['dt']\n        mode = case['mode']\n        \n        # --- 1. Construct tentative velocities u*, v* ---\n        if mode in ['solve', 'const_phi', 'zero_dt']:\n            rng = np.random.default_rng(case['seed'])\n            u_star = rng.standard_normal((Nx, Ny))\n            v_star = rng.standard_normal((Nx, Ny))\n        elif mode == 'exact_grad':\n            i, j = np.meshgrid(np.arange(Nx), np.arange(Ny), indexing='ij')\n            phi_exact = np.sin(2 * np.pi * 2 * i / Nx) + 0.5 * np.cos(2 * np.pi * 3 * j / Ny)\n            grad_phi_x, grad_phi_y = discrete_gradient(phi_exact, dx, dy)\n            u_star = dt * grad_phi_x\n            v_star = dt * grad_phi_y\n        \n        # --- Pre-correction divergence ---\n        div_u_star = discrete_divergence(u_star, v_star, dx, dy)\n        max_abs_div_before = np.max(np.abs(div_u_star))\n        \n        # --- 2. Solve for phi or set it ---\n        phi = None\n        if mode == 'solve':\n            # Form the RHS\n            rhs = div_u_star / dt\n            # Robustness: ensure RHS has zero mean\n            rhs -= np.mean(rhs)\n            # Solve Poisson equation\n            phi = solve_poisson_spectral(rhs, dx, dy)\n        elif mode == 'const_phi':\n            phi = np.full((Nx, Ny), 1.234)\n        elif mode == 'exact_grad':\n            # Use phi_exact for the correction\n            phi = phi_exact\n        elif mode == 'zero_dt':\n            # As per problem, set phi to zero.\n            # Note: correction is u_star - dt * grad(phi), so any phi is fine if dt=0.\n            phi = np.zeros((Nx, Ny))\n\n        # --- 3. Apply velocity correction ---\n        grad_phi_x, grad_phi_y = discrete_gradient(phi, dx, dy)\n        u_new = u_star - dt * grad_phi_x\n        v_new = v_star - dt * grad_phi_y\n\n        # --- 4. Compute final divergence and report ---\n        div_u_new = discrete_divergence(u_new, v_new, dx, dy)\n        max_abs_div_after = np.max(np.abs(div_u_new))\n        \n        if mode in ['const_phi', 'zero_dt']:\n            # Ratio of after to before\n            # Avoid division by zero if initial divergence is already zero\n            if max_abs_div_before > 1e-16:\n                result = max_abs_div_after / max_abs_div_before\n            else:\n                result = 1.0 if max_abs_div_after  1e-16 else np.inf\n            results.append(result)\n        else: # 'solve', 'exact_grad'\n            results.append(max_abs_div_after)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}