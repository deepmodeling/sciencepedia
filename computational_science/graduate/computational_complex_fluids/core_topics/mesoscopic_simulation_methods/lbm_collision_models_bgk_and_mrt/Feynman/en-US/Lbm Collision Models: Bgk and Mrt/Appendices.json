{
    "hands_on_practices": [
        {
            "introduction": "A critical step in validating the Lattice Boltzmann Method is to demonstrate that it correctly reproduces macroscopic fluid dynamics. This exercise guides you through the foundational Chapman-Enskog analysis, a powerful mathematical tool used to derive the Navier-Stokes equations from the LBE. By completing this derivation for the BGK model , you will establish the precise relationship between the microscopic relaxation parameter $\\tau$ and the macroscopic kinematic viscosity $\\nu$.",
            "id": "4092460",
            "problem": "Consider the isothermal, weakly compressible, Newtonian fluid modeled by the Lattice Boltzmann Method (LBM) on the two-dimensional nine-velocity lattice (D2Q9). The collision operator is of Bhatnagar–Gross–Krook (BGK) type with a single relaxation time. Let the discrete evolution be\n$$\nf_{\\alpha}(\\mathbf{x}+\\mathbf{e}_{\\alpha}\\,\\Delta t,t+\\Delta t)=f_{\\alpha}(\\mathbf{x},t)-\\frac{\\Delta t}{\\tau}\\left[f_{\\alpha}(\\mathbf{x},t)-f_{\\alpha}^{\\mathrm{eq}}(\\mathbf{x},t)\\right],\n$$\nwhere $f_{\\alpha}$ are the population functions associated with discrete velocities $\\mathbf{e}_{\\alpha}$, $f_{\\alpha}^{\\mathrm{eq}}$ is the second-order isothermal equilibrium, $\\Delta t$ is the time step, and $\\tau$ is the relaxation time. The hydrodynamic fields are defined by $ \\rho=\\sum_{\\alpha} f_{\\alpha}$ and $ \\rho \\,\\mathbf{u}=\\sum_{\\alpha}\\mathbf{e}_{\\alpha} f_{\\alpha}$. The D2Q9 quadrature satisfies the standard isotropy identities\n$$\n\\sum_{\\alpha} w_{\\alpha}\\, e_{\\alpha i} e_{\\alpha j}=c_{s}^{2}\\,\\delta_{ij},\\qquad\n\\sum_{\\alpha} w_{\\alpha}\\, e_{\\alpha i} e_{\\alpha j} e_{\\alpha k} e_{\\alpha l}=c_{s}^{4}\\left(\\delta_{ij}\\delta_{kl}+\\delta_{ik}\\delta_{jl}+\\delta_{il}\\delta_{jk}\\right),\n$$\nwhere $w_{\\alpha}$ are the lattice weights and $c_{s}^{2}$ is the lattice sound speed squared.\n\nStarting from these definitions and the discrete-time evolution, use a second-order Taylor expansion in $\\Delta t$ together with a Chapman–Enskog multiscale analysis to recover the Navier–Stokes equations at the hydrodynamic scale. From this recovery, derive the kinematic viscosity $ \\nu $ of the BGK model as a function of $ c_{s}^{2} $, $ \\tau $, and $ \\Delta t $. Then, evaluate the resulting expression in lattice units for $ \\Delta t=1 $ and $ c_{s}^{2}=1/3 $, expressing $ \\nu $ as a closed-form function of $ \\tau $ only. State clearly any assumptions required in your derivation. Your final answer must be a single analytic expression. No rounding is required. Express your answer in lattice units.",
            "solution": "The problem asks for the derivation of the kinematic viscosity $\\nu$ for the Lattice Boltzmann Method (LBM) with a Bhatnagar–Gross–Krook (BGK) collision operator. The derivation will be performed using a Chapman–Enskog multiscale analysis.\n\nThe discrete lattice Boltzmann equation (LBE) is given as:\n$$\nf_{\\alpha}(\\mathbf{x}+\\mathbf{e}_{\\alpha}\\,\\Delta t,t+\\Delta t) - f_{\\alpha}(\\mathbf{x},t) = -\\frac{\\Delta t}{\\tau}\\left[f_{\\alpha}(\\mathbf{x},t)-f_{\\alpha}^{\\mathrm{eq}}(\\mathbf{x},t)\\right]\n$$\nwhere $f_{\\alpha}$ are the particle distribution functions, $\\mathbf{e}_{\\alpha}$ are the discrete velocities, $\\Delta t$ is the time step, $\\tau$ is the relaxation time, and $f_{\\alpha}^{\\mathrm{eq}}$ is the equilibrium distribution function.\n\n**Step 1: Taylor Expansion**\nWe first perform a second-order Taylor expansion in $\\Delta t$ on the left-hand side of the LBE:\n$$\nf_{\\alpha}(\\mathbf{x}+\\mathbf{e}_{\\alpha}\\,\\Delta t,t+\\Delta t) = f_{\\alpha}(\\mathbf{x},t) + \\Delta t \\left(\\partial_t + \\mathbf{e}_{\\alpha} \\cdot \\nabla \\right) f_{\\alpha} + \\frac{(\\Delta t)^2}{2} \\left(\\partial_t + \\mathbf{e}_{\\alpha} \\cdot \\nabla \\right)^2 f_{\\alpha} + \\mathcal{O}((\\Delta t)^3)\n$$\nSubstituting this into the LBE and dividing by $\\Delta t$, we obtain the continuous Boltzmann equation with discretization effects:\n$$\n\\left(\\partial_t + e_{\\alpha i} \\partial_i \\right) f_{\\alpha} + \\frac{\\Delta t}{2} \\left(\\partial_t + e_{\\alpha i} \\partial_i \\right)^2 f_{\\alpha} = -\\frac{1}{\\tau} (f_{\\alpha} - f_{\\alpha}^{\\mathrm{eq}})\n$$\nHere, Einstein summation convention is used for spatial indices $i$.\n\n**Step 2: Chapman–Enskog Multiscale Expansion**\nAccording to the Chapman–Enskog procedure, we introduce a formal small parameter $\\epsilon$ (proportional to the Knudsen number) to separate the fast microscopic scales from the slow macroscopic scales.\nThe distribution function and the time and space derivatives are expanded as follows:\n$$\nf_{\\alpha} = f_{\\alpha}^{(0)} + \\epsilon f_{\\alpha}^{(1)} + \\epsilon^2 f_{\\alpha}^{(2)} + \\dots\n$$\n$$\n\\partial_t = \\epsilon \\partial_{t_1} + \\epsilon^2 \\partial_{t_2}\n$$\n$$\n\\partial_i = \\epsilon \\partial_{1i}\n$$\nA key assumption is that the distribution function $f_\\alpha$ depends on time only through the macroscopic variables, density $\\rho$ and velocity $\\mathbf{u}$. The equilibrium distribution $f_\\alpha^{\\mathrm{eq}}$ is a function of these local macroscopic variables. We assume the zeroth-order distribution is the equilibrium distribution, i.e., $f_{\\alpha}^{(0)} = f_{\\alpha}^{\\mathrm{eq}}$. The non-equilibrium parts, $f_{\\alpha}^{(k)}$ for $k \\geq 1$, are defined such that they do not contribute to the conserved quantities (mass and momentum):\n$$\n\\sum_{\\alpha} f_{\\alpha}^{(k)} = 0 \\quad \\text{and} \\quad \\sum_{\\alpha} e_{\\alpha i} f_{\\alpha}^{(k)} = 0 \\quad \\text{for } k \\geq 1\n$$\nThis ensures $\\rho = \\sum_{\\alpha} f_{\\alpha}^{(0)}$ and $\\rho u_i = \\sum_{\\alpha} e_{\\alpha i} f_{\\alpha}^{(0)}$.\n\nSubstituting the expansions into the Taylor-expanded LBE and collecting terms of the same order in $\\epsilon$:\n\n**Order $\\epsilon^1$:**\n$$\n(\\partial_{t_1} + e_{\\alpha i} \\partial_{1i}) f_{\\alpha}^{(0)} = -\\frac{1}{\\tau} f_{\\alpha}^{(1)}\n$$\nThis equation gives the first-order non-equilibrium distribution:\n$$\nf_{\\alpha}^{(1)} = -\\tau (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i}) f_{\\alpha}^{(0)}\n$$\n\n**Order $\\epsilon^2$:**\n$$\n\\partial_{t_2} f_{\\alpha}^{(0)} + (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i}) f_{\\alpha}^{(1)} + \\frac{\\Delta t}{2} (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i})^2 f_{\\alpha}^{(0)} = -\\frac{1}{\\tau} f_{\\alpha}^{(2)}\n$$\nWe can substitute the expression for $f_{\\alpha}^{(1)}$ into the second term:\n$$\n\\partial_{t_2} f_{\\alpha}^{(0)} - \\tau (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i})^2 f_{\\alpha}^{(0)} + \\frac{\\Delta t}{2} (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i})^2 f_{\\alpha}^{(0)} = -\\frac{1}{\\tau} f_{\\alpha}^{(2)}\n$$\nSimplifying, we get:\n$$\n\\partial_{t_2} f_{\\alpha}^{(0)} - \\left(\\tau - \\frac{\\Delta t}{2}\\right) (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i})^2 f_{\\alpha}^{(0)} = -\\frac{1}{\\tau} f_{\\alpha}^{(2)}\n$$\n\n**Step 3: Derivation of Macroscopic Equations**\nWe take moments of the scale-separated equations.\nSumming the $\\epsilon^1$ equation over $\\alpha$:\n$$\n\\sum_{\\alpha} (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i}) f_{\\alpha}^{(0)} = 0 \\implies \\partial_{t_1} \\rho + \\partial_{1i} (\\rho u_i) = 0\n$$\nThis is the continuity equation at the Euler scale. Multiplying by $e_{\\alpha j}$ and summing:\n$$\n\\sum_{\\alpha} e_{\\alpha j} (\\partial_{t_1} + e_{\\alpha i} \\partial_{1i}) f_{\\alpha}^{(0)} = 0 \\implies \\partial_{t_1} (\\rho u_j) + \\partial_{1i} \\Pi_{ij}^{(0)} = 0\n$$\nwhere $\\Pi_{ij}^{(0)} = \\sum_{\\alpha} e_{\\alpha i} e_{\\alpha j} f_{\\alpha}^{(0)}$ is the second moment of the equilibrium distribution. For the specified second-order isothermal equilibrium, this moment is $\\Pi_{ij}^{(0)} = \\rho u_i u_j + p \\delta_{ij}$, with pressure $p = \\rho c_s^2$. This gives the Euler momentum equation: $\\partial_{t_1}(\\rho u_j) + \\partial_{1i}(\\rho u_i u_j) = -\\partial_{1j} p$.\n\nNow, we combine the macroscopic equations at different scales. The full momentum equation is obtained by summing the $\\epsilon^1$ and $\\epsilon^2$ contributions:\n$$\n\\epsilon_1: \\quad \\partial_{t_1}(\\rho u_j) + \\partial_{1i}\\Pi_{ij}^{(0)} = 0\n$$\n$$\n\\epsilon_2: \\quad \\partial_{t_2}(\\rho u_j) + \\partial_{1i}\\left( \\left(1 - \\frac{\\Delta t}{2\\tau}\\right)\\Pi_{ij}^{(1)} \\right) = 0\n$$\nThe $\\epsilon^2$ momentum equation is derived by multiplying the $\\epsilon^2$ equation by $e_{\\alpha j}$, summing over $\\alpha$, and using the properties of $f_{\\alpha}^{(k)}$. Combining these two equations and re-forming the full derivatives $\\partial_t = \\epsilon\\partial_{t_1} + \\epsilon^2\\partial_{t_2}$ and $\\partial_i = \\epsilon\\partial_{1i}$:\n$$\n\\partial_t(\\rho u_j) + \\partial_i \\left( \\Pi_{ij}^{(0)} + \\left(1-\\frac{\\Delta t}{2\\tau}\\right) \\Pi_{ij}^{(1)} \\right) = \\mathcal{O}(\\epsilon^3)\n$$\nSubstituting $\\Pi_{ij}^{(0)} = \\rho u_i u_j + p \\delta_{ij}$:\n$$\n\\partial_t(\\rho u_j) + \\partial_i(\\rho u_i u_j) = -\\partial_j p - \\partial_i \\left( \\left(1-\\frac{\\Delta t}{2\\tau}\\right) \\Pi_{ij}^{(1)} \\right)\n$$\nThis equation has the form of the Navier–Stokes momentum equation, $\\partial_t(\\rho u_j) + \\partial_i(\\rho u_i u_j) = -\\partial_j p + \\partial_i \\sigma'_{ij}$, where $\\sigma'_{ij}$ is the viscous stress tensor. By comparison, we identify:\n$$\n\\sigma'_{ij} = - \\left(1 - \\frac{\\Delta t}{2\\tau}\\right) \\Pi_{ij}^{(1)}\n$$\n\n**Step 4: Viscosity Derivation**\nTo find the viscosity, we need to evaluate $\\Pi_{ij}^{(1)} = \\sum_{\\alpha} e_{\\alpha i} e_{\\alpha j} f_{\\alpha}^{(1)}$.\n$$\n\\Pi_{ij}^{(1)} = \\sum_{\\alpha} e_{\\alpha i} e_{\\alpha j} \\left( -\\tau (\\partial_{t_1} + e_{\\alpha k} \\partial_{1k}) f_{\\alpha}^{(0)} \\right) = -\\tau \\left( \\partial_{t_1} \\Pi_{ij}^{(0)} + \\partial_{1k} Q_{ijk}^{(0)} \\right)\n$$\nwhere $Q_{ijk}^{(0)} = \\sum_{\\alpha} e_{\\alpha i} e_{\\alpha j} e_{\\alpha k} f_{\\alpha}^{(0)}$.\nTo derive the viscous part of the stress tensor, which is linear in velocity gradients, we make the key assumption of a low Mach number flow. In this limit, we can neglect the time derivative term $\\partial_{t_1} \\Pi_{ij}^{(0)}$ and higher-order velocity terms in $Q_{ijk}^{(0)}$. We approximate $f_{\\alpha}^{(0)} \\approx w_{\\alpha} \\rho \\left(1 + \\frac{e_{\\alpha k} u_k}{c_s^2}\\right)$.\nThe third-order moment becomes:\n$$\nQ_{ijk}^{(0)} \\approx \\sum_{\\alpha} e_{\\alpha i} e_{\\alpha j} e_{\\alpha k} \\left( w_{\\alpha} \\rho \\frac{e_{\\alpha l} u_l}{c_s^2} \\right) = \\frac{\\rho u_l}{c_s^2} \\sum_{\\alpha} w_{\\alpha} e_{\\alpha i} e_{\\alpha j} e_{\\alpha k} e_{\\alpha l}\n$$\nUsing the provided isotropy identity for the fourth-rank tensor:\n$$\nQ_{ijk}^{(0)} \\approx \\frac{\\rho u_l}{c_s^2} c_s^4 (\\delta_{ij}\\delta_{kl} + \\delta_{ik}\\delta_{jl} + \\delta_{il}\\delta_{jk}) = \\rho c_s^2 (u_k \\delta_{ij} + u_j \\delta_{ik} + u_i \\delta_{jk})\n$$\nTaking the divergence, $\\partial_{1k} Q_{ijk}^{(0)}$, we get (assuming near incompressibility, $\\partial_l u_l \\approx 0$):\n$$\n\\partial_{1k} Q_{ijk}^{(0)} \\approx \\rho c_s^2 (\\partial_{1i} u_j + \\partial_{1j} u_i)\n$$\nThus, the non-equilibrium momentum flux tensor is:\n$$\n\\Pi_{ij}^{(1)} \\approx -\\tau \\rho c_s^2 (\\partial_{1i} u_j + \\partial_{1j} u_i)\n$$\nSubstituting this into the expression for the viscous stress tensor:\n$$\n\\sigma'_{ij} \\approx - \\left(1 - \\frac{\\Delta t}{2\\tau}\\right) \\left[ -\\tau \\rho c_s^2 (\\partial_i u_j + \\partial_j u_i) \\right]\n$$\n$$\n\\sigma'_{ij} \\approx \\rho c_s^2 \\left(\\tau - \\frac{\\Delta t}{2}\\right) (\\partial_i u_j + \\partial_j u_i)\n$$\nThe stress tensor for a Newtonian fluid is $\\sigma'_{ij} = \\rho \\nu (\\partial_i u_j + \\partial_j u_i) + \\text{bulk terms}$. Comparing the deviatoric (shear) parts, we identify the kinematic viscosity $\\nu$ as:\n$$\n\\nu = c_s^2 \\left(\\tau - \\frac{\\Delta t}{2}\\right)\n$$\n\n**Step 5: Evaluation in Lattice Units**\nThe problem asks for this expression to be evaluated in lattice units, where $\\Delta t=1$ and $c_s^2=1/3$.\nSubstituting these values:\n$$\n\\nu = \\frac{1}{3} \\left(\\tau - \\frac{1}{2}\\right)\n$$\nThis is the final expression for the kinematic viscosity of the LBM-BGK model as a function of the relaxation time $\\tau$ in lattice units. For numerical stability, viscosity must be positive, which implies $\\nu > 0$, leading to the condition $\\tau > 1/2$.",
            "answer": "$$\n\\boxed{\\frac{1}{3}\\left(\\tau - \\frac{1}{2}\\right)}\n$$"
        },
        {
            "introduction": "While the BGK model is conceptually simple, its single relaxation time is a significant limitation. The Multiple-Relaxation-Time (MRT) model overcomes this by allowing different kinetic modes to relax at independent rates, offering superior stability and flexibility. This practice  extends the Chapman-Enskog analysis to the MRT framework, allowing you to see how shear viscosity $\\nu$ can be tuned independently via its dedicated relaxation rate $s_\\nu$.",
            "id": "4092426",
            "problem": "Consider the Multiple-Relaxation-Time Lattice Boltzmann Method (MRT-LBM) on the two-dimensional nine-velocity lattice (D2Q9). The kinetic equation in velocity-discrete form with time step $\\Delta t$ and discrete velocities $\\{\\mathbf{c}_i\\}$ is\n$$\nf_i(\\mathbf{x}+\\mathbf{c}_i \\Delta t,t+\\Delta t)-f_i(\\mathbf{x},t)\n=\n-\\left[\\mathbf{M}^{-1}\\mathbf{S}\\,\\mathbf{M}\\left(\\mathbf{f}-\\mathbf{f}^{\\mathrm{eq}}\\right)\\right]_i\n$$\nwhere $\\mathbf{M}$ maps particle distribution functions $\\mathbf{f}$ to raw moments $\\mathbf{m}=\\mathbf{M}\\mathbf{f}$, $\\mathbf{S}$ is diagonal in moment space with relaxation rates $\\{s_k\\}$, and $\\mathbf{f}^{\\mathrm{eq}}$ are local equilibria constrained by mass and momentum conservation. Let the conserved moments be density $\\rho$ and momentum $\\rho \\mathbf{u}$, and let the second-order nonconserved moments include the shear modes associated with the deviatoric stress tensor.\n\nStarting from this discrete kinetic equation, perform a Chapman–Enskog expansion consistent with an isothermal, weakly compressible limit to recover the incompressible Navier–Stokes equations to second order in the Knudsen number. Identify the hydrodynamic shear viscosity $\\nu$ of the recovered equations in terms of the squared lattice speed of sound $c_s^2$, the time step $\\Delta t$, and the relaxation rate $s_{\\nu}$ associated with the second-order shear moments. You may assume that the D2Q9 lattice has the standard isothermal equation of state with $c_s^2=c^2/3$, where $c=\\Delta x/\\Delta t$ is the lattice particle speed, and that the second-order Hermite subspace is properly represented by the chosen moment basis.\n\nThen, for a D2Q9 implementation in lattice units with $\\Delta x=1$, $\\Delta t=1$, and hence $c=1$ and $c_s^2=1/3$, suppose you wish to realize the target kinematic shear viscosity $\\nu=0.07$ (in lattice units). Compute the value of the shear-mode relaxation rate $s_{\\nu}$ that achieves this viscosity. Express the final result as a pure number without units, rounded to four significant figures.",
            "solution": "The problem asks for two things: first, to identify the relationship between the kinematic shear viscosity $\\nu$ and the shear-mode relaxation rate $s_{\\nu}$ in the Multiple-Relaxation-Time Lattice Boltzmann Method (MRT-LBM) by performing a Chapman–Enskog expansion; and second, to calculate the specific value of $s_{\\nu}$ required to achieve a target viscosity $\\nu=0.07$ in lattice units.\n\nFirst, we address the derivation of the shear viscosity. The connection between the discrete kinetic equation of the LBM and the macroscopic Navier-Stokes equations is formally established through a Chapman–Enskog multiscale expansion. This procedure allows us to recover continuum-level fluid dynamics from the mesoscopic model.\n\nThe starting point is the MRT-LBM kinetic equation for the particle distribution functions $f_i(\\mathbf{x}, t)$:\n$$\nf_i(\\mathbf{x}+\\mathbf{c}_i \\Delta t, t+\\Delta t) - f_i(\\mathbf{x}, t) = -\\left[\\mathbf{M}^{-1}\\mathbf{S}\\,\\mathbf{M}\\left(\\mathbf{f}-\\mathbf{f}^{\\mathrm{eq}}\\right)\\right]_i\n$$\nHere, $\\mathbf{f}$ is the vector of distributions $\\{f_i\\}$, $\\mathbf{f}^{\\mathrm{eq}}$ is its local equilibrium, $\\mathbf{M}$ is the transformation matrix to moment space, and $\\mathbf{S}$ is the diagonal relaxation matrix with entries $s_k$.\n\nThe Chapman–Enskog analysis proceeds by introducing a small parameter $\\epsilon$, the Knudsen number, and expanding the distribution function, time derivative, and spatial gradient:\n1.  Expansion of the distribution function around equilibrium:\n    $$\n    f_i = f_i^{\\mathrm{eq}} + \\epsilon f_i^{(1)} + \\epsilon^2 f_i^{(2)} + O(\\epsilon^3)\n    $$\n2.  Multiscale expansion of time and space derivatives:\n    $$\n    \\partial_t = \\epsilon \\partial_{t_1} + \\epsilon^2 \\partial_{t_2} ; \\quad \\nabla = \\epsilon \\nabla_1\n    $$\nThe left-hand side of the kinetic equation is Taylor-expanded up to second order in the time step $\\Delta t$:\n$$\n\\Delta t D_t f_i + \\frac{(\\Delta t)^2}{2} D_t^2 f_i + O((\\Delta t)^3) = \\Omega_i[\\mathbf{f}]\n$$\nwhere $D_t = (\\partial_t + \\mathbf{c}_i \\cdot \\nabla)$ is the material derivative along the characteristic $\\mathbf{c}_i$, and $\\Omega_i$ is the collision operator on the right-hand side.\n\nSubstituting the Chapman–Enskog expansions into the Taylor-expanded kinetic equation and collecting terms of the same order in $\\epsilon$ yields a hierarchy of equations.\n\nAt order $\\epsilon^1$, we obtain:\n$$\n\\Delta t (\\partial_{t_1} + \\mathbf{c}_i \\cdot \\nabla_1) f_i^{\\mathrm{eq}} = -[\\mathbf{M}^{-1} \\mathbf{S} \\mathbf{M} \\mathbf{f}^{(1)}]_i\n$$\nSumming this equation over $i$ (for mass) and with a weight of $\\mathbf{c}_i$ (for momentum), and using the conservation properties of the equilibrium distribution ($\\sum_i f_i^{\\mathrm{eq}} = \\rho$, $\\sum_i \\mathbf{c}_i f_i^{\\mathrm{eq}} = \\rho \\mathbf{u}$), we recover the ideal Euler equations at the slow time scale $t_1$.\n\nAt order $\\epsilon^2$, the analysis yields the dissipative terms. The full derivation is extensive, but the crucial result is the expression for the non-equilibrium part of the momentum flux tensor (or pressure tensor), $\\mathbf{P}^{\\mathrm{neq}} = \\sum_i \\mathbf{c}_i \\mathbf{c}_i (\\mathbf{f} - \\mathbf{f}^{\\mathrm{eq}})$, which is identified with the viscous stress tensor. For the weakly compressible (isothermal) limit, the analysis shows that the off-diagonal components of this tensor, responsible for shear viscosity, are given by:\n$$\nP_{\\alpha\\beta}^{\\mathrm{neq}} = - \\rho c_s^2 \\Delta t \\left( \\frac{1}{s_{\\nu}} - \\frac{1}{2} \\right) (\\partial_{\\alpha} u_{\\beta} + \\partial_{\\beta} u_{\\alpha}) \\quad (\\text{for } \\alpha \\neq \\beta)\n$$\nThe term proportional to $1/s_{\\nu}$ arises from the first-order collision term, while the $-1/2$ term is a discrete lattice effect originating from the second-order term $\\frac{(\\Delta t)^2}{2}$ in the Taylor expansion.\n\nThe macroscopic momentum equation has the form $\\partial_t(\\rho u_{\\alpha}) + \\nabla_{\\beta} (\\rho u_{\\alpha} u_{\\beta} + p \\delta_{\\alpha\\beta}) = \\nabla_{\\beta} \\Pi_{\\alpha\\beta}$, where $\\Pi_{\\alpha\\beta}$ is the viscous stress tensor. Comparing the LBM-derived momentum equation with this form, we identify $\\Pi_{\\alpha\\beta} = -P_{\\alpha\\beta}^{\\mathrm{neq}}$. The Navier-Stokes equations define the shear stress tensor for an incompressible fluid as $\\Pi_{\\alpha\\beta} = \\rho \\nu (\\partial_{\\alpha} u_{\\beta} + \\partial_{\\beta} u_{\\alpha})$.\n\nBy equating these two expressions for the shear stress, we find the kinematic shear viscosity $\\nu$:\n$$\n\\rho \\nu (\\partial_{\\alpha} u_{\\beta} + \\partial_{\\beta} u_{\\alpha}) = - \\left[ - \\rho c_s^2 \\Delta t \\left( \\frac{1}{s_{\\nu}} - \\frac{1}{2} \\right) (\\partial_{\\alpha} u_{\\beta} + \\partial_{\\beta} u_{\\alpha}) \\right]\n$$\nThis gives the well-established relationship for viscosity in MRT-LBM:\n$$\n\\nu = c_s^2 \\Delta t \\left( \\frac{1}{s_{\\nu}} - \\frac{1}{2} \\right)\n$$\nThis is the required expression relating $\\nu$ to $s_{\\nu}$.\n\nNext, we compute the numerical value of $s_{\\nu}$. The problem provides the following parameters in lattice units:\n- Target kinematic shear viscosity: $\\nu = 0.07$\n- Lattice time step: $\\Delta t = 1$\n- Squared lattice speed of sound: $c_s^2 = 1/3$\n\nWe substitute these values into the derived formula for viscosity:\n$$\n0.07 = \\frac{1}{3} \\times 1 \\times \\left( \\frac{1}{s_{\\nu}} - \\frac{1}{2} \\right)\n$$\nNow, we solve this equation for $s_{\\nu}$:\n$$\n3 \\times 0.07 = \\frac{1}{s_{\\nu}} - \\frac{1}{2}\n$$\n$$\n0.21 = \\frac{1}{s_{\\nu}} - 0.5\n$$\n$$\n\\frac{1}{s_{\\nu}} = 0.21 + 0.5\n$$\n$$\n\\frac{1}{s_{\\nu}} = 0.71\n$$\n$$\ns_{\\nu} = \\frac{1}{0.71}\n$$\nCalculating the value of this fraction:\n$$\ns_{\\nu} = 1.4084507...\n$$\nThe problem requires the result to be rounded to four significant figures.\n$$\ns_{\\nu} \\approx 1.408\n$$\nThis value is within the linear stability range for LBM, which is $0  s_{\\nu}  2$.",
            "answer": "$$ \\boxed{1.408} $$"
        },
        {
            "introduction": "Theoretical models must contend with the realities of finite-precision arithmetic when implemented on a computer. This hands-on computational exercise  explores how round-off errors can accumulate and violate the exact conservation of mass and momentum, a critical issue in long-running simulations. By comparing the BGK and MRT collision schemes, you will gain practical insight into the superior numerical stability of the MRT model and test a common mitigation strategy.",
            "id": "4092445",
            "problem": "Consider the Lattice Boltzmann Method (LBM) for complex fluids on the two-dimensional, nine-velocity ($D2Q9$) lattice. The objective is to quantify how finite-precision round-off errors in moment-space collisions affect conservation of mass and momentum, by computing the drift in density $\\,\\rho\\,$ and velocity $\\,\\mathbf{u}\\,$ over many time steps, and to evaluate a mitigation strategy. Work in lattice units (all quantities are unitless).\n\nUse the following foundational base:\n- The discrete Boltzmann equation with collision-only updates (no streaming) for a homogeneous state, where populations $\\,f_i\\,$ evolve under either the single-relaxation-time Bhatnagar–Gross–Krook (BGK) collision or the Multi-Relaxation-Time (MRT) collision. For BGK, the collision acts directly in velocity space. For MRT, moments $\\,\\mathbf{m} = \\mathbf{M}\\mathbf{f}\\,$ are relaxed toward equilibrium moments $\\,\\mathbf{m}^{\\mathrm{eq}}\\,$ with a diagonal relaxation matrix $\\,\\mathbf{S}\\,$, then transformed back via $\\,\\mathbf{f} = \\mathbf{M}^{-1}\\mathbf{m}\\,$.\n- Use the standard $D2Q9$ velocities $\\,\\mathbf{c}_i\\,$ and weights $\\,w_i\\,$:\n  - Velocities $\\,\\mathbf{c}_0=(0,0)$, $\\,\\mathbf{c}_1=(1,0)$, $\\,\\mathbf{c}_2=(0,1)$, $\\,\\mathbf{c}_3=(-1,0)$, $\\,\\mathbf{c}_4=(0,-1)$, $\\,\\mathbf{c}_5=(1,1)$, $\\,\\mathbf{c}_6=(-1,1)$, $\\,\\mathbf{c}_7=(-1,-1)$, $\\,\\mathbf{c}_8=(1,-1)$.\n  - Weights $\\,w_0=\\frac{4}{9}$, $\\,w_{1,2,3,4}=\\frac{1}{9}$, $\\,w_{5,6,7,8}=\\frac{1}{36}$.\n- The standard velocity-space equilibrium $\\,f_i^{\\mathrm{eq}} = w_i \\rho \\left[1 + 3(\\mathbf{c}_i\\cdot\\mathbf{u}) + \\frac{9}{2}(\\mathbf{c}_i\\cdot\\mathbf{u})^2 - \\frac{3}{2}\\mathbf{u}^2\\right]$.\n- The standard $D2Q9$ moment transform $\\,\\mathbf{M}\\,$ (d’Humières/Lallemand–Luo basis) with rows:\n  - $[1,1,1,1,1,1,1,1,1]$,\n  - $[-4,-1,-1,-1,-1,2,2,2,2]$,\n  - $[4,-2,-2,-2,-2,1,1,1,1]$,\n  - $[0,1,0,-1,0,1,-1,-1,1]$,\n  - $[0,-2,0,2,0,1,-1,-1,1]$,\n  - $[0,0,1,0,-1,1,1,-1,-1]$,\n  - $[0,0,-2,0,2,1,1,-1,-1]$,\n  - $[0,1,-1,1,-1,0,0,0,0]$,\n  - $[0,0,0,0,0,1,-1,1,-1]$.\n- The corresponding equilibrium moments $\\,\\mathbf{m}^{\\mathrm{eq}}\\,$ consistent with the above transform:\n  - $\\,m_0^{\\mathrm{eq}} = \\rho$,\n  - $\\,m_1^{\\mathrm{eq}} = -2\\rho + 3\\rho(u_x^2 + u_y^2)$,\n  - $\\,m_2^{\\mathrm{eq}} = \\rho - 3\\rho(u_x^2 + u_y^2)$,\n  - $\\,m_3^{\\mathrm{eq}} = \\rho u_x$,\n  - $\\,m_4^{\\mathrm{eq}} = -\\rho u_x$,\n  - $\\,m_5^{\\mathrm{eq}} = \\rho u_y$,\n  - $\\,m_6^{\\mathrm{eq}} = -\\rho u_y$,\n  - $\\,m_7^{\\mathrm{eq}} = \\rho(u_x^2 - u_y^2)$,\n  - $\\,m_8^{\\mathrm{eq}} = \\rho u_x u_y$.\n\nImplement a single-site experiment (no spatial variation, no streaming) to isolate collision and round-off effects. Initialize at $\\,\\rho_0 = 1\\,$ and $\\,\\mathbf{u}_0 = (10^{-3}, -2\\times 10^{-3})\\,$ with populations $\\,\\mathbf{f} = \\mathbf{f}^{\\mathrm{eq}}(\\rho_0,\\mathbf{u}_0)\\,$. Superimpose a small non-equilibrium perturbation $\\,\\boldsymbol{\\delta}\\,$ onto $\\,\\mathbf{f}\\,$ with amplitude $\\,\\epsilon\\,$ such that $\\,\\sum_i \\delta_i = 0\\,$ and $\\,\\sum_i \\delta_i \\mathbf{c}_i = \\mathbf{0}\\,$, i.e., the perturbation preserves mass and momentum exactly at initialization.\n\nEvolve $\\,\\mathbf{f}\\,$ for $\\,N\\,$ collision steps under each specified model and precision. At each step, compute $\\,\\rho = \\sum_i f_i\\,$ and $\\,\\mathbf{u} = \\frac{1}{\\rho}\\sum_i f_i \\mathbf{c}_i\\,$. For BGK, use relaxation rate $\\,\\omega = 1/\\tau\\,$. For MRT, use $\\,\\mathbf{S}=\\mathrm{diag}(s_0,\\dots,s_8)\\,$ where the conserved moments have $\\,s_{0}=s_{3}=s_{5}=0\\,$ and all other $\\,s_j = \\omega\\,$. In the mitigation variant, enforce conservation in moment space by overwriting the conserved moments $\\,m_0, m_3, m_5\\,$ with their exact values $\\,\\rho, \\rho u_x, \\rho u_y\\,$ immediately before relaxation and inversion to velocity space.\n\nTest Suite:\n- Case $\\,1\\,$: MRT, $\\,\\tau=0.8\\,$, $\\,\\omega=1/\\tau\\,$, $\\,N=100000\\,$, $\\,\\epsilon=10^{-7}\\,$, single precision ($\\,\\text{float32}\\,$).\n- Case $\\,2\\,$: MRT, $\\,\\tau=0.8\\,$, $\\,\\omega=1/\\tau\\,$, $\\,N=100000\\,$, $\\,\\epsilon=10^{-7}\\,$, double precision ($\\,\\text{float64}\\,$).\n- Case $\\,3\\,$: MRT with conservation enforcement in moment space (mitigation), $\\,\\tau=0.8\\,$, $\\,\\omega=1/\\tau\\,$, $\\,N=100000\\,$, $\\,\\epsilon=10^{-7}\\,$, single precision ($\\,\\text{float32}\\,$).\n- Case $\\,4\\,$: BGK, $\\,\\tau=0.8\\,$, $\\,\\omega=1/\\tau\\,$, $\\,N=100000\\,$, $\\,\\epsilon=10^{-7}\\,$, single precision ($\\,\\text{float32}\\,$).\n- Case $\\,5\\,$: MRT, $\\,\\tau=0.6\\,$ (nearer to the stability bound), $\\,\\omega=1/\\tau\\,$, $\\,N=200000\\,$, $\\,\\epsilon=10^{-7}\\,$, single precision ($\\,\\text{float32}\\,$).\n\nFor each case, return the drift metrics after $\\,N\\,$ steps:\n- $\\,\\Delta \\rho = \\rho_N - \\rho_0\\,$,\n- $\\,\\Delta u_x = u_{x,N} - u_{x,0}\\,$,\n- $\\,\\Delta u_y = u_{y,N} - u_{y,0}\\,$.\n\nAll outputs must be unitless floats. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order\n$[\\Delta \\rho_1, \\Delta u_{x,1}, \\Delta u_{y,1}, \\Delta \\rho_2, \\Delta u_{x,2}, \\Delta u_{y,2}, \\dots, \\Delta \\rho_5, \\Delta u_{x,5}, \\Delta u_{y,5}]$.",
            "solution": "The problem is assessed to be valid. It is scientifically grounded in the established theory of the Lattice Boltzmann Method (LBM), is well-posed with all necessary parameters and initial conditions provided, and is formulated objectively. The task is to perform a numerical experiment to quantify the accumulation of floating-point round-off errors in different LBM collision models and to test a mitigation strategy. This is a standard and meaningful investigation in the field of computational fluid dynamics.\n\nWe will proceed with a full solution. The core of the problem is to simulate the evolution of the particle distribution functions, $\\,f_i(\\mathbf{x}, t)\\,$, at a single spatial point (a homogeneous system), thus isolating the collision step from the streaming step. The evolution is governed by the lattice Boltzmann equation, which, for a collision-only process, simplifies to:\n$$\nf_i(t+1) = f_i(t) + \\Omega_i(\\mathbf{f})\n$$\nwhere $\\,\\Omega_i\\,$ is the collision operator for the $\\,i\\,$th velocity direction. The simulation will be performed for a large number of steps, $\\,N\\,$, to observe the cumulative effect of round-off errors.\n\nThe simulation will be based on the two-dimensional, nine-velocity ($\\,D2Q9\\,$) model. The discrete velocities $\\,\\mathbf{c}_i\\,$ and corresponding weights $\\,w_i\\,$ are given as:\n- $\\,\\mathbf{c}_0=(0,0)\\,$, $\\,\\mathbf{c}_{1,2,3,4}=(\\pm 1, 0), (0, \\pm 1)\\,$, $\\,\\mathbf{c}_{5,6,7,8}=(\\pm 1, \\pm 1)\\,$\n- $\\,w_0=4/9\\,$, $\\,w_{1,2,3,4}=1/9\\,$, $\\,w_{5,6,7,8}=1/36\\,$\n\nThe macroscopic fluid density $\\,\\rho\\,$ and velocity $\\,\\mathbf{u}\\,$ are defined as moments of the distribution functions:\n$$\n\\rho = \\sum_{i=0}^{8} f_i \\quad \\quad \\mathbf{j} = \\rho\\mathbf{u} = \\sum_{i=0}^{8} f_i \\mathbf{c}_i\n$$\n\nThe system is initialized at $\\,\\rho_0 = 1\\,$ and $\\,\\mathbf{u}_0 = (10^{-3}, -2\\times 10^{-3})\\,$. The initial distribution functions $\\,\\mathbf{f}\\,$ are set to the equilibrium state $\\,\\mathbf{f}^{\\mathrm{eq}}(\\rho_0, \\mathbf{u}_0)\\,$ plus a small, non-equilibrium perturbation $\\,\\boldsymbol{\\delta}\\,$ of magnitude $\\,\\epsilon = 10^{-7}\\,$. The equilibrium distribution is the standard second-order expansion:\n$$\nf_i^{\\mathrm{eq}} = w_i \\rho \\left[1 + \\frac{\\mathbf{c}_i\\cdot\\mathbf{u}}{c_s^2} + \\frac{(\\mathbf{c}_i\\cdot\\mathbf{u})^2}{2c_s^4} - \\frac{\\mathbf{u}\\cdot\\mathbf{u}}{2c_s^2}\\right]\n$$\nWith the standard lattice speed of sound $\\,c_s^2 = 1/3\\,$, this becomes:\n$$\nf_i^{\\mathrm{eq}} = w_i \\rho \\left[1 + 3(\\mathbf{c}_i\\cdot\\mathbf{u}) + \\frac{9}{2}(\\mathbf{c}_i\\cdot\\mathbf{u})^2 - \\frac{3}{2}u^2\\right]\n$$\nThe perturbation $\\,\\boldsymbol{\\delta}\\,$ must preserve mass and momentum, i.e., $\\,\\sum_i \\delta_i = 0\\,$ and $\\,\\sum_i \\delta_i \\mathbf{c}_i = \\mathbf{0}\\,$. A valid perturbation is constructed, for instance, by setting $\\,\\delta_1 = \\epsilon\\,$, $\\,\\delta_3 = \\epsilon\\,$, and $\\,\\delta_0 = -2\\epsilon\\,$, with all other $\\,\\delta_i=0\\,$. This perturbation excites a non-equilibrium mode without immediately altering the conserved hydrodynamic variables. The initial populations are thus $\\,f_i(t=0) = f_i^{\\mathrm{eq}}(\\rho_0, \\mathbf{u}_0) + \\delta_i\\,$.\n\nWe will implement and compare three different collision schemes.\n\n1.  **Bhatnagar–Gross–Krook (BGK) Model**:\n    This model uses a single relaxation time $\\,\\tau\\,$ to relax all modes towards equilibrium. The collision operator is linear:\n    $$\n    \\Omega_i^{\\mathrm{BGK}} = -\\frac{1}{\\tau} (f_i - f_i^{\\mathrm{eq}}) = -\\omega (f_i - f_i^{\\mathrm{eq}})\n    $$\n    where $\\,\\omega = 1/\\tau\\,$ is the relaxation frequency. The post-collision state is $\\,f_i(t+1) = f_i(t) - \\omega (f_i(t) - f_i^{\\mathrm{eq}}(t))\\,$. While simple, this model couples all relaxation processes and is known to be less stable and accurate for complex flows compared to MRT. Round-off errors in the calculation of $\\,\\rho\\,$ and $\\,\\mathbf{u}\\,$ from $\\,\\mathbf{f}\\,$ can lead to a drift in these nominally conserved quantities over many steps.\n\n2.  **Multi-Relaxation-Time (MRT) Model**:\n    This model operates in moment space, allowing different relaxation rates for different moments. The process is:\n    a. Transform the populations $\\,\\mathbf{f}\\,$ into a vector of moments $\\,\\mathbf{m}\\,$ using a linear transformation matrix $\\,\\mathbf{M}\\,$: $\\,\\mathbf{m} = \\mathbf{M}\\mathbf{f}\\,$.\n    b. Relax the moments towards their equilibrium values $\\,\\mathbf{m}^{\\mathrm{eq}}\\,$:\n    $$\n    \\mathbf{m}^* = \\mathbf{m} - \\mathbf{S} (\\mathbf{m} - \\mathbf{m}^{\\mathrm{eq}})\n    $$\n    where $\\,\\mathbf{S} = \\mathrm{diag}(s_0, s_1, \\ldots, s_8)\\,$ is a diagonal matrix of relaxation rates.\n    c. Transform the post-collision moments $\\,\\mathbf{m}^*\\,$ back to population space: $\\,\\mathbf{f}(t+1) = \\mathbf{M}^{-1}\\mathbf{m}^*\\,$.\n\n    The specific $\\,D2Q9\\,$ moment basis (d'Humières/Lallemand-Luo) provided in the problem statement separates the moments into conserved quantities (density, momentum) and non-conserved kinetic modes. The conserved moments are $\\,m_0=\\rho\\,$, $\\,m_3=\\rho u_x\\,$, and $\\,m_5=\\rho u_y\\,$. For these, the relaxation rates are set to zero ($\\,s_0=s_3=s_5=0\\,$), which theoretically guarantees exact conservation of mass and momentum. All other non-conserved moments are relaxed with rate $\\,s_j = \\omega\\,$. Despite this theoretical guarantee, round-off errors introduced during the matrix multiplications ($\\,\\mathbf{M}\\mathbf{f}\\,$ and $\\,\\mathbf{M}^{-1}\\mathbf{m}^*\\,$) can still lead to a drift in the conserved quantities. The equilibrium moments $\\,\\mathbf{m}^{\\mathrm{eq}}\\,$ are calculated directly from $\\,\\rho\\,$ and $\\,\\mathbf{u}\\,$.\n\n3.  **MRT with Conservation Enforcement (Mitigation)**:\n    This is a variant of the MRT model designed to actively combat round-off error accumulation. The procedure is modified as follows:\n    a. From the current populations $\\,\\mathbf{f}(t)\\,$, compute the macroscopic quantities with the highest possible precision: $\\,\\rho_{\\mathrm{exact}} = \\sum_i f_i(t)\\,$ and $\\,(\\rho u_x)_{\\mathrm{exact}} = \\sum_i f_i(t) c_{ix}\\,$, $\\,(\\rho u_y)_{\\mathrm{exact}} = \\sum_i f_i(t) c_{iy}\\,$.\n    b. Transform to moment space: $\\,\\mathbf{m} = \\mathbf{M}\\mathbf{f}(t)\\,$.\n    c. **Enforce Conservation**: Overwrite the computed moments corresponding to conserved quantities with the exact values calculated in step (a):\n    $$\n    m_0 \\leftarrow \\rho_{\\mathrm{exact}} \\quad \\quad m_3 \\leftarrow (\\rho u_x)_{\\mathrm{exact}} \\quad \\quad m_5 \\leftarrow (\\rho u_y)_{\\mathrm{exact}}\n    $$\n    This step explicitly removes any round-off error that occurred in the $\\,\\mathbf{M}\\mathbf{f}\\,$ transformation for these specific moments.\n    d. Proceed with the relaxation step using the corrected moment vector $\\,\\mathbf{m}\\,$ and transform back to population space.\n\nFor each test case, we will initialize the system, iterate the specified collision model for $\\,N\\,$ steps using the designated floating-point precision ($\\,\\text{float32}\\,$ or $\\,\\text{float64}\\,$), and compute the final drift in density ($\\,\\Delta \\rho = \\rho_N - \\rho_0\\,$) and velocity components ($\\,\\Delta u_x = u_{x,N} - u_{x,0}\\,$, $\\,\\Delta u_y = u_{y,N} - u_{y,0}\\,$).",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the LBM round-off error problem by simulating collision steps\n    for different models and precisions.\n    \"\"\"\n    # Test cases as specified in the problem statement.\n    test_cases = [\n        {'model': 'mrt', 'tau': 0.8, 'N': 100000, 'epsilon': 1e-7, 'precision': np.float32, 'mitigation': False},\n        {'model': 'mrt', 'tau': 0.8, 'N': 100000, 'epsilon': 1e-7, 'precision': np.float64, 'mitigation': False},\n        {'model': 'mrt', 'tau': 0.8, 'N': 100000, 'epsilon': 1e-7, 'precision': np.float32, 'mitigation': True},\n        {'model': 'bgk', 'tau': 0.8, 'N': 100000, 'epsilon': 1e-7, 'precision': np.float32, 'mitigation': False},\n        {'model': 'mrt', 'tau': 0.6, 'N': 200000, 'epsilon': 1e-7, 'precision': np.float32, 'mitigation': False},\n    ]\n\n    # D2Q9 lattice constants (defined with high precision first)\n    C_base = np.array([[0, 0], [1, 0], [0, 1], [-1, 0], [0, -1], [1, 1], [-1, 1], [-1, -1], [1, -1]], dtype=np.float64)\n    W_base = np.array([4/9, 1/9, 1/9, 1/9, 1/9, 1/36, 1/36, 1/36, 1/36], dtype=np.float64)\n\n    # D2Q9 MRT transformation matrix (d'Humières/Lallemand-Luo basis)\n    M_base = np.array([\n        [ 1,  1,  1,  1,  1,  1,  1,  1,  1],\n        [-4, -1, -1, -1, -1,  2,  2,  2,  2],\n        [ 4, -2, -2, -2, -2,  1,  1,  1,  1],\n        [ 0,  1,  0, -1,  0,  1, -1, -1,  1],\n        [ 0, -2,  0,  2,  0,  1, -1, -1,  1],\n        [ 0,  0,  1,  0, -1,  1,  1, -1, -1],\n        [ 0,  0, -2,  0,  2,  1,  1, -1, -1],\n        [ 0,  1, -1,  1, -1,  0,  0,  0,  0],\n        [ 0,  0,  0,  0,  0,  1, -1,  1, -1]\n    ], dtype=np.float64)\n    M_inv_base = np.linalg.inv(M_base)\n\n    def calculate_feq(rho, u, C, W):\n        \"\"\"Calculates the equilibrium distribution functions f_eq.\"\"\"\n        cu = C @ u\n        u_sq = u @ u\n        feq = W * rho * (1 + 3 * cu + 4.5 * cu**2 - 1.5 * u_sq)\n        return feq\n\n    def calculate_meq(rho, u, DTYPE):\n        \"\"\"Calculates the equilibrium moments m_eq.\"\"\"\n        ux, uy = u\n        ux2, uy2 = ux**2, uy**2\n        u2 = ux2 + uy2\n        \n        meq = np.zeros(9, dtype=DTYPE)\n        meq[0] = rho\n        meq[1] = -2*rho + 3*rho*u2\n        meq[2] = rho - 3*rho*u2\n        meq[3] = rho*ux\n        meq[4] = -rho*ux\n        meq[5] = rho*uy\n        meq[6] = -rho*uy\n        meq[7] = rho*(ux2 - uy2)\n        meq[8] = rho*ux*uy\n        return meq\n\n    results = []\n    \n    for case in test_cases:\n        model = case['model']\n        tau = case['tau']\n        N = case['N']\n        epsilon = case['epsilon']\n        DTYPE = case['precision']\n        mitigation = case['mitigation']\n        \n        omega = 1.0 / tau\n\n        # Cast constants to the specified precision for the current case\n        C = C_base.astype(DTYPE)\n        W = W_base.astype(DTYPE)\n        M = M_base.astype(DTYPE)\n        M_inv = M_inv_base.astype(DTYPE)\n        \n        # Initial conditions\n        rho0 = DTYPE(1.0)\n        u0 = np.array([1e-3, -2e-3], dtype=DTYPE)\n        \n        # Initial populations at equilibrium + perturbation\n        f = calculate_feq(rho0, u0, C, W)\n        perturbation = np.zeros(9, dtype=DTYPE)\n        perturbation[0] = DTYPE(-2.0 * epsilon)\n        perturbation[1] = DTYPE(epsilon)\n        perturbation[3] = DTYPE(epsilon)\n        f += perturbation\n\n        # MRT relaxation matrix S (as a vector for element-wise multiplication)\n        S = np.full(9, omega, dtype=DTYPE)\n        S[0] = S[3] = S[5] = 0.0 # Conserved moments\n\n        # Main simulation loop\n        for _ in range(N):\n            if model == 'bgk':\n                rho = np.sum(f)\n                u = (f @ C) / rho\n                feq = calculate_feq(rho, u, C, W)\n                f = f - DTYPE(omega) * (f - feq)\n            \n            elif model == 'mrt':\n                if mitigation:\n                    # Enforce conservation before relaxation\n                    rho_exact = np.sum(f)\n                    j_exact = f @ C\n                    \n                    m = M @ f\n                    m[0] = rho_exact\n                    m[3] = j_exact[0]\n                    m[5] = j_exact[1]\n                else:\n                    m = M @ f\n\n                # Use macroscopic variables from moment space for consistency\n                rho_m = m[0]\n                # Avoid division by zero, although not expected here\n                if np.abs(rho_m)  DTYPE(1e-30): rho_m = DTYPE(1.0)\n                u_m = np.array([m[3], m[5]], dtype=DTYPE) / rho_m\n                \n                meq = calculate_meq(rho_m, u_m, DTYPE)\n                m_post = m - S * (m - meq)\n                f = M_inv @ m_post\n\n        # Final macroscopic properties\n        rho_N = np.sum(f)\n        u_N = (f @ C) / rho_N\n\n        # Calculate and store drifts\n        delta_rho = rho_N - rho0\n        delta_u = u_N - u0\n        \n        results.extend([delta_rho, delta_u[0], delta_u[1]])\n\n    # Print results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}