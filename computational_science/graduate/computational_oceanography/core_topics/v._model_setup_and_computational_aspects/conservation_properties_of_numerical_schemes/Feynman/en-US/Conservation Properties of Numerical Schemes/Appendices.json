{
    "hands_on_practices": [
        {
            "introduction": "The cornerstone of any conservative numerical scheme is its formulation in \"flux form.\" This structure ensures that the quantity being transported is passed from one grid cell to the next without any spurious creation or destruction within the domain. This exercise guides you through a foundational analytical derivation  to demonstrate precisely how this works. By summing the discrete update rule over all grid cells, you will see how interior fluxes cancel out in a \"telescoping sum,\" leaving only the net flux across the domain boundaries as the source of change for the total quantity.",
            "id": "3788105",
            "problem": "Consider the scalar tracer transport equation in two spatial dimensions, written in flux form as the conservation law $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$, discretized on a uniform Cartesian mesh with $N$ cells in the $x$-direction and $M$ cells in the $y$-direction, with grid spacings $\\Delta x$ and $\\Delta y$. Let cell centers be indexed by $(i,j)$ with $i \\in \\{1,\\dots,N\\}$ and $j \\in \\{1,\\dots,M\\}$. Face-normal velocities are defined at cell faces as $u_{i+1/2,j}$ on the east-west faces and $v_{i,j+1/2}$ on the north-south faces. Define centered face fluxes at time level $n$ by\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2},\n$$\nfor all interior faces, and let $F_{1/2,j}$, $F_{N+1/2,j}$, $G_{i,1/2}$, and $G_{i,M+1/2}$ denote the corresponding fluxes on the domain boundary faces (determined by the boundary conditions). Consider the explicit Euler update\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\nfor all interior cells $(i,j)$, where $\\Delta t$ is the time step.\n\nDefine the discrete global sum at time level $n$ by\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}.\n$$\nCompute the one-step change $\\Delta S \\equiv S^{n+1} - S^{n}$ exactly in closed form, expressed solely in terms of $\\Delta t$, $\\Delta x$, $\\Delta y$, and the boundary face fluxes $F_{1/2,j}$, $F_{N+1/2,j}$, $G_{i,1/2}$, and $G_{i,M+1/2}$. Then, based on your derivation, state the boundary and discrete-operator conditions under which the scheme is exactly conservative in the sense that $\\Delta S = 0$ holds to machine precision.\n\nYour final answer must be the single closed-form expression for $\\Delta S$ as requested. No numerical evaluation is required, and no rounding is needed. Do not include any units.",
            "solution": "The starting point is the discrete flux-form update, which approximates the continuous conservation law $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$ on a uniform grid. The explicit Euler update at each interior cell $(i,j)$ is\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\nwhere $F_{i+1/2,j}$ and $G_{i,j+1/2}$ are single-valued face fluxes located at the faces between two adjacent cells or at the domain boundary. These fluxes are constructed using centered averages of $q$ at adjacent cell centers and face-normal velocities at the same faces:\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2}.\n$$\nDefine the discrete global sum\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}, \\qquad \\Delta S \\equiv S^{n+1} - S^{n}.\n$$\nSumming the update over all interior cells yields\n\\begin{align*}\n\\Delta S \\;&=\\; \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( q^{n+1}_{i,j} - q^{n}_{i,j} \\right) \\\\\n&=\\; - \\Delta t \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right].\n\\end{align*}\nBecause $\\Delta x$ and $\\Delta y$ are constants, we reorganize the sums:\n\\begin{align*}\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right).\n\\end{align*}\nEach inner sum is a discrete telescoping sum. For the $x$-fluxes at fixed $j$,\n$$\n\\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;=\\; F_{N+1/2,j} - F_{1/2,j}.\n$$\nSimilarly, for the $y$-fluxes at fixed $i$,\n$$\n\\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right) \\;=\\; G_{i,M+1/2} - G_{i,1/2}.\n$$\nTherefore, the one-step change in the discrete global sum is exactly\n$$\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right).\n$$\nThis expression depends only on the boundary face fluxes. It follows that the scheme is exactly conservative in the discrete global sum, in the sense that $\\Delta S = 0$ to machine precision, under the following conditions:\n- Periodic boundary conditions in the $x$-direction and/or $y$-direction, which imply $F_{N+1/2,j} = F_{1/2,j}$ and/or $G_{i,M+1/2} = G_{i,1/2}$, respectively, rendering the corresponding sums zero.\n- Impermeable (no-normal-flow) boundary conditions, which impose $u_{1/2,j} = u_{N+1/2,j} = 0$ and $v_{i,1/2} = v_{i,M+1/2} = 0$, hence $F_{1/2,j} = F_{N+1/2,j} = 0$ and $G_{i,1/2} = G_{i,M+1/2} = 0$.\n- More generally, any boundary condition that enforces zero net boundary flux, i.e., $\\frac{1}{\\Delta x}\\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) + \\frac{1}{\\Delta y}\\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right) = 0$.\n\nThe conservation property arises because the discrete update is in flux form with single-valued face fluxes shared by adjacent cells, so interior contributions cancel exactly when summed globally, leaving only boundary contributions. The explicit Euler time integration does not alter this cancellation because it multiplies the discrete divergence uniformly by $\\Delta t$ without mixing spatial locations.",
            "answer": "$$\\boxed{- \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) - \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right)}$$"
        },
        {
            "introduction": "Moving from theory to practice, this exercise challenges you to verify the conservation property within a computational setting. For any robust ocean model, it is essential to confirm that numerical schemes behave as expected, and conservation is a primary benchmark. In this problem , you will implement a finite volume advection scheme and test the fundamental principle that the change in mass within any arbitrary group of cells is perfectly balanced by the net flux of mass across that group's boundary. This hands-on verification builds confidence in the numerical method and deepens the understanding of how local flux conservation translates to regional and global conservation.",
            "id": "3788063",
            "problem": "Consider a tracer being advected in an incompressible oceanic flow on an unstructured mesh. The tracer mass is defined for each control volume as $m_i = \\rho V_i q_i$, where $\\rho$ is the constant fluid density, $V_i$ is the volume of cell $i$, and $q_i$ is the dimensionless tracer mass fraction in cell $i$. The governing fundamental base is the integral conservation law for a passive scalar in a control volume derived from the conservation of mass and the divergence-free property of the velocity field: the time rate of change of mass in a control volume equals the net advective flux of mass through its boundary. In a Finite Volume (FV) conservative discretization with explicit time stepping and upwind face states, the mass exchange across each shared face is computed once, and then added to the adjacent cells with opposite signs to ensure local conservation.\n\nYou are given a small unstructured mesh in two spatial dimensions. Cells are indexed from $0$ to $4$, with volumes in $\\mathrm{m}^3$, faces are pairs of neighboring cells with associated face area in $\\mathrm{m}^2$ and an outward unit normal vector defined from the left cell to the right cell. The face-normal component of velocity determines the upwind side. For a face connecting cells $L$ and $R$ with face normal $\\boldsymbol{n}_f$ pointing from $L$ to $R$, the scalar flux through the face is determined using the upwind face value $q_{\\text{up}}$ chosen from the cell whose velocity projects positively onto $\\boldsymbol{n}_f$; if $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f = 0$, the face contributes zero mass flux. The mass flux through face $f$ is $F_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u}\\cdot\\boldsymbol{n}_f) \\, A_f$ in $\\mathrm{kg}\\,\\mathrm{s}^{-1}$, where $A_f$ is the face area. A single explicit time step of size $\\Delta t$ updates cell masses by accumulating the signed face flux contributions.\n\nDefine a closed subdomain $\\mathcal{S}$ as the set of indices $\\{1,2,3\\}$. The boundary of $\\mathcal{S}$ consists of faces that connect a cell in $\\mathcal{S}$ to a cell not in $\\mathcal{S}$. The outward orientation for the subdomain boundary is: if the face normal $\\boldsymbol{n}_f$ points from a cell in $\\mathcal{S}$ to a cell not in $\\mathcal{S}$, it is counted positively; otherwise, it is counted negatively. After one time step, the mass budget of $\\mathcal{S}$ should satisfy the closed-subdomain conservation property: the change in total mass of $\\mathcal{S}$ equals the negative of the net outward boundary flux multiplied by the time step, when evaluated consistently with the same face fluxes used for the cell updates.\n\nYour task is to implement a program that, for each test case below, performs a single explicit FV advection update using upwind fluxes on the given mesh, computes the total mass change in $\\mathcal{S}$, computes the net outward boundary flux of $\\mathcal{S}$ using the same face fluxes, and verifies closure by evaluating the residual\n$$\nR = \\left(\\sum_{i\\in \\mathcal{S}} m_i^{n+1} - \\sum_{i\\in \\mathcal{S}} m_i^{n}\\right) + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f,\n$$\nwhere $s_f$ is $+1$ if $\\boldsymbol{n}_f$ points from $\\mathcal{S}$ to its exterior and $-1$ otherwise. The residual $R$ must be assessed in $\\mathrm{kg}$. For each test case, return a boolean indicating whether $|R|$ is less than a specified absolute tolerance of $10^{-8}$ $\\mathrm{kg}$.\n\nMesh specification:\n- Cell volumes $V = [10^6,\\,10^6,\\,10^6,\\,10^6,\\,10^6]$ in $\\mathrm{m}^3$ for cells $[0,1,2,3,4]$.\n- Faces $f_0=(0,1)$, $f_1=(1,2)$, $f_2=(2,3)$, $f_3=(3,4)$.\n- Face areas $A_{f_0}=10^4$, $A_{f_1}=10^4$, $A_{f_2}=10^4$, $A_{f_3}=10^4$ in $\\mathrm{m}^2$.\n- Face normals $\\boldsymbol{n}_{f_k}=(1,0)$ for each face $f_k$, oriented from the lower-index cell to the higher-index cell.\n- Density $\\rho = 1025$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n- Initial tracer mass fractions $q = [0.035,\\,0.032,\\,0.030,\\,0.028,\\,0.027]$ (dimensionless).\n- Subdomain $\\mathcal{S} = \\{1,2,3\\}$.\n\nTest suite:\n- Case $1$ (happy path): $\\boldsymbol{u}=(0.5,\\,0.1)$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 600$ in $\\mathrm{s}$.\n- Case $2$ (zero flow): $\\boldsymbol{u}=(0,\\,0)$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 600$ in $\\mathrm{s}$.\n- Case $3$ (tangential to faces): $\\boldsymbol{u}=(0,\\,1.0)$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 1000$ in $\\mathrm{s}$.\n- Case $4$ (large time step): $\\boldsymbol{u}=(2.0,\\,0)$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 5000$ in $\\mathrm{s}$.\n\nAngle quantities are not used in this problem. All physical quantities must be handled in the units specified above, and the residual must be assessed in $\\mathrm{kg}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[result_1,result_2,result_3,result_4]$, where each $result_k$ is a boolean value indicating whether the closed-subdomain mass budget is satisfied within the specified absolute tolerance. No other text should be printed.",
            "solution": "The problem is subjected to a rigorous validation process.\n\n### Step 1: Extract Givens\n- **Governing Principle**: The time rate of change of mass in a control volume equals the net advective flux of mass through its boundary.\n- **Discretization**: Finite Volume (FV) method, explicit time stepping, upwind face states.\n- **Tracer Mass**: $m_i = \\rho V_i q_i$, where $\\rho$ is constant density, $V_i$ is volume of cell $i$, and $q_i$ is dimensionless tracer mass fraction.\n- **Mass Flux**: Face flux is $F_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u}\\cdot\\boldsymbol{n}_f) \\, A_f$, where $A_f$ is face area, $\\boldsymbol{n}_f$ is the face normal, and $q_{\\text{up}}$ is the upwind mass fraction. For a face between cells $L$ and $R$ with normal from $L$ to $R$, $q_{\\text{up}}=q_L$ if $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f > 0$, and $q_{\\text{up}}=q_R$ if $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f < 0$. If $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f=0$, flux is $0$.\n- **Mass Update**: Mass exchange is conservative; flux is computed once and applied with opposite signs to adjacent cells.\n- **Subdomain**: $\\mathcal{S} = \\{1,2,3\\}$.\n- **Subdomain Boundary**: Faces connecting a cell in $\\mathcal{S}$ to a cell not in $\\mathcal{S}$.\n- **Boundary Sign Convention**: $s_f = +1$ if $\\boldsymbol{n}_f$ points from $\\mathcal{S}$ to its exterior; $s_f = -1$ otherwise.\n- **Residual Definition**: $R = \\left(\\sum_{i\\in \\mathcal{S}} m_i^{n+1} - \\sum_{i\\in \\mathcal{S}} m_i^{n}\\right) + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f$.\n- **Verification Task**: For each test case, determine if $|R| < 10^{-8}$ kg.\n- **Mesh Data**:\n    - Cell indices: $0, 1, 2, 3, 4$.\n    - Cell volumes: $V = [10^6,\\,10^6,\\,10^6,\\,10^6,\\,10^6]$ $\\mathrm{m}^3$.\n    - Faces: $f_0=(0,1)$, $f_1=(1,2)$, $f_2=(2,3)$, $f_3=(3,4)$.\n    - Face areas: $A_{f_k}=10^4$ $\\mathrm{m}^2$ for all $k$.\n    - Face normals: $\\boldsymbol{n}_{f_k}=(1,0)$ for all $k$, oriented from lower-index to higher-index cell.\n- **Physical Constants and Initial Conditions**:\n    - Density: $\\rho = 1025$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n    - Initial mass fractions: $q = [0.035,\\,0.032,\\,0.030,\\,0.028,\\,0.027]$.\n- **Test Suite**:\n    - Case $1$: $\\boldsymbol{u}=(0.5,\\,0.1)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 600$ $\\mathrm{s}$.\n    - Case $2$: $\\boldsymbol{u}=(0,\\,0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 600$ $\\mathrm{s}$.\n    - Case $3$: $\\boldsymbol{u}=(0,\\,1.0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 1000$ $\\mathrm{s}$.\n    - Case $4$: $\\boldsymbol{u}=(2.0,\\,0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 5000$ $\\mathrm{s}$.\n- **Tolerance**: $10^{-8}$ $\\mathrm{kg}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded in the principles of continuum mechanics (mass conservation) and numerical methods for partial differential equations (Finite Volume method). The formulation is objective, self-contained, and mathematically consistent. The defined task is a direct verification of the conservation property inherent to the numerical scheme, which is a standard procedure in the validation of computational fluid dynamics codes. The provided data are complete and physically plausible. The problem is well-posed for a verification task. No flaws are identified.\n\n### Step 3: Verdict and Action\nThe problem is deemed **valid**. A full solution will be provided.\n\n### Principle-Based Solution\nThe fundamental principle underlying this problem is the conservation of mass, as expressed for a numerical Finite Volume (FV) scheme. A key property of a conservative FV scheme is that the change in a conserved quantity (here, tracer mass $m$) within a collection of control volumes is exactly accounted for by the net flux across the boundary of that collection. The problem requires a direct verification of this property for the subdomain $\\mathcal{S}$.\n\nThe total mass in cell $i$ at the initial time $t^n$ is $m_i^n = \\rho V_i q_i^n$. The mass update over a time step $\\Delta t$ is performed by summing the contributions from all faces connected to the cell. For a generic face $f$ connecting a \"left\" cell $L$ and a \"right\" cell $R$, with a normal vector $\\boldsymbol{n}_f$ pointing from $L$ to $R$, the mass flux $F_f$ is defined as:\n$$\nF_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u} \\cdot \\boldsymbol{n}_f) \\, A_f\n$$\nA positive flux $F_f$ indicates a net transfer of mass from cell $L$ to cell $R$. The mass in the cells is updated according to:\n$$\nm_L^{n+1} = m_L^n - \\Delta t F_f\n$$\n$$\nm_R^{n+1} = m_R^n + \\Delta t F_f\n$$\nThis formulation ensures that the mass lost by cell $L$ is gained by cell $R$, a property known as local conservation.\n\nThe total mass change within the subdomain $\\mathcal{S} = \\{1, 2, 3\\}$ after one time step is the sum of the mass changes in its constituent cells:\n$$\n\\Delta M_{\\mathcal{S}} = \\sum_{i \\in \\mathcal{S}} (m_i^{n+1} - m_i^n) = (m_1^{n+1} - m_1^n) + (m_2^{n+1} - m_2^n) + (m_3^{n+1} - m_3^n)\n$$\nThe cells in $\\mathcal{S}$ are connected by internal faces ($f_1$, $f_2$) and boundary faces ($f_0$, $f_3$).\n- Cell $1$ is connected to cells $0$ and $2$ via faces $f_0=(0,1)$ and $f_1=(1,2)$. Its mass change is $\\Delta m_1 = \\Delta t (F_{f_0} - F_{f_1})$.\n- Cell $2$ is connected to cells $1$ and $3$ via faces $f_1=(1,2)$ and $f_2=(2,3)$. Its mass change is $\\Delta m_2 = \\Delta t (F_{f_1} - F_{f_2})$.\n- Cell $3$ is connected to cells $2$ and $4$ via faces $f_2=(2,3)$ and $f_3=(3,4)$. Its mass change is $\\Delta m_3 = \\Delta t (F_{f_2} - F_{f_3})$.\n\nSumming these changes reveals a telescoping series for the internal fluxes:\n$$\n\\Delta M_{\\mathcal{S}} = \\Delta t [ (F_{f_0} - F_{f_1}) + (F_{f_1} - F_{f_2}) + (F_{f_2} - F_{f_3}) ] = \\Delta t (F_{f_0} - F_{f_3})\n$$\nThe total mass change in the subdomain is governed solely by the fluxes across its boundary, $\\partial\\mathcal{S} = \\{f_0, f_3\\}$.\n\nThe problem defines a residual $R$ to verify this closure:\n$$\nR = \\Delta M_{\\mathcal{S}} + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f\n$$\nWe must determine the signs $s_f$.\n- For face $f_0=(0,1)$, the normal $\\boldsymbol{n}_{f_0}$ points from outside $\\mathcal{S}$ (cell $0$) into $\\mathcal{S}$ (cell $1$). According to the sign convention, this is an inward-pointing normal, so $s_{f_0} = -1$.\n- For face $f_3=(3,4)$, the normal $\\boldsymbol{n}_{f_3}$ points from inside $\\mathcal{S}$ (cell $3$) to outside $\\mathcal{S}$ (cell $4$). This is an outward-pointing normal, so $s_{f_3} = +1$.\n\nThe boundary flux term is therefore $\\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f = \\Delta t (-F_{f_0} + F_{f_3})$.\nSubstituting this and the expression for $\\Delta M_{\\mathcal{S}}$ into the residual equation:\n$$\nR = \\Delta t(F_{f_0} - F_{f_3}) + \\Delta t(-F_{f_0} + F_{f_3}) = 0\n$$\nTheoretically, the residual must be exactly zero. The programming task is to implement the calculation for each test case and verify that the computed residual is zero within the specified floating-point tolerance of $10^{-8}$. This property holds regardless of the specific velocity $\\boldsymbol{u}$ or time step $\\Delta t$, as it is an algebraic consequence of the scheme's conservative structure.\n\nThe implementation will proceed as follows for each test case:\n1.  Define all mesh, initial condition, and physical constant data structures.\n2.  Calculate the initial mass $m_i^n = \\rho V_i q_i$ for all cells $i=0, ..., 4$.\n3.  Calculate the initial total mass in the subdomain, $M_{\\mathcal{S}}^n = \\sum_{i \\in \\mathcal{S}} m_i^n$.\n4.  For each face $f_k=(L,R)$, compute the face-normal velocity $\\boldsymbol{u} \\cdot \\boldsymbol{n}_{f_k}$, determine the upwind mass fraction $q_{\\text{up}}$, and calculate the mass flux $F_{f_k}$. These fluxes are stored.\n5.  Using the stored fluxes, update the mass in all cells to find $m_i^{n+1}$.\n6.  Calculate the final total mass in the subdomain, $M_{\\mathcal{S}}^{n+1} = \\sum_{i \\in \\mathcal{S}} m_i^{n+1}$.\n7.  The mass change in the subdomain is $\\Delta M_{\\mathcal{S}} = M_{\\mathcal{S}}^{n+1} - M_{\\mathcal{S}}^n$.\n8.  Calculate the boundary flux component of the residual, $B = \\Delta t (-F_{f_0} + F_{f_3})$.\n9.  Compute the final residual $R = \\Delta M_{\\mathcal{S}} + B$.\n10. Check if $|R| < 10^{-8}$ and record the boolean result.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and verifies the closed-subdomain conservation property for a\n    Finite Volume advection scheme on a simple unstructured mesh.\n    \"\"\"\n    # --- Define Static Problem Parameters ---\n\n    # Physical constant\n    rho = 1025.0  # kg/m^3\n\n    # Mesh geometry and initial conditions\n    V = np.array([1e6, 1e6, 1e6, 1e6, 1e6])  # Cell volumes in m^3\n    q_initial = np.array([0.035, 0.032, 0.030, 0.028, 0.027])  # Dimensionless tracer mass fraction\n\n    # Face definitions: {Left cell, Right cell, Area, Normal vector}\n    faces = [\n        {'L': 0, 'R': 1, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 1, 'R': 2, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 2, 'R': 3, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 3, 'R': 4, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n    ]\n\n    # Subdomain S and its boundary face information\n    subdomain_S_indices = [1, 2, 3]\n    \n    # Boundary faces are those connecting S to its exterior.\n    # The sign s_f is +1 if the normal points out of S, -1 otherwise.\n    # Face 0 (0->1): normal points into S -> s_f = -1\n    # Face 3 (3->4): normal points out of S -> s_f = +1\n    boundary_faces_info = {\n        0: -1.0,  # Face index and its sign s_f\n        3: 1.0\n    }\n\n    # Test suite\n    test_cases = [\n        {'u': np.array([0.5, 0.1]), 'dt': 600.0},\n        {'u': np.array([0.0, 0.0]), 'dt': 600.0},\n        {'u': np.array([0.0, 1.0]), 'dt': 1000.0},\n        {'u': np.array([2.0, 0.0]), 'dt': 5000.0},\n    ]\n\n    tolerance = 1e-8\n    results = []\n\n    # --- Iterate Through Test Cases ---\n    for case in test_cases:\n        u_vel = case['u']\n        dt = case['dt']\n        \n        # Calculate initial masses for all cells\n        m_n = rho * V * q_initial\n        \n        # Calculate initial total mass in subdomain S\n        m_S_n = np.sum(m_n[subdomain_S_indices])\n        \n        # Initialize new masses and array to store fluxes\n        m_np1 = m_n.copy()\n        face_fluxes = np.zeros(len(faces))\n\n        # --- Perform one explicit time step ---\n\n        # 1. Compute all face fluxes and update cell masses consistently\n        for i, face in enumerate(faces):\n            L, R = face['L'], face['R']\n            A, n_f = face['A'], face['n']\n            \n            # Project velocity onto the face normal\n            v_n = np.dot(u_vel, n_f)\n            \n            # Determine upwind tracer value based on flow direction\n            if v_n > 0:  # Flow from L to R, upwind is L\n                q_up = q_initial[L]\n            elif v_n < 0:  # Flow from R to L, upwind is R\n                q_up = q_initial[R]\n            else:  # Zero normal flow\n                q_up = 0.0  # Flux will be zero\n\n            # Calculate mass flux F_f through the face (kg/s)\n            F_f = rho * q_up * v_n * A\n            face_fluxes[i] = F_f\n            \n            # Apply flux to update masses of adjacent cells (local conservation)\n            m_np1[L] -= dt * F_f\n            m_np1[R] += dt * F_f\n            \n        # --- Verify Subdomain Conservation ---\n        \n        # 2. Calculate the total mass change in subdomain S\n        m_S_np1 = np.sum(m_np1[subdomain_S_indices])\n        mass_change_in_S = m_S_np1 - m_S_n\n        \n        # 3. Calculate the net outward boundary flux term for S\n        boundary_flux_sum = 0.0\n        for face_idx, s_f in boundary_faces_info.items():\n            boundary_flux_sum += s_f * face_fluxes[face_idx]\n        \n        # 4. Compute the residual R as defined in the problem\n        # R = (change in total mass) + dt * (net outward signed boundary flux)\n        residual = mass_change_in_S + dt * boundary_flux_sum\n        \n        # 5. Check if the absolute residual is within the specified tolerance\n        is_conserved = abs(residual) < tolerance\n        results.append(is_conserved)\n\n    # Print the final results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "While flux-form schemes offer exact conservation, some powerful and efficient methods, such as the semi-Lagrangian (SL) scheme, do not inherently possess this property due to interpolation processes. This can lead to a gradual, unphysical drift in the total mass of a tracer over long simulations, which is unacceptable for many oceanographic applications. This problem  addresses this real-world challenge by having you quantify the mass error from an SL step and derive a \"global mass fixer,\" a common a posteriori correction used to enforce conservation and maintain the physical integrity of the simulation.",
            "id": "3788093",
            "problem": "Consider an ocean tracer governed by the advection equation with no sources or sinks, so that the instantaneous global tracer mass in a closed ocean domain is given by the volume integral $M(t) = \\int_{\\Omega} q(\\mathbf{x}, t)\\, \\mathrm{d}V$, where $q$ is the tracer concentration in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and $\\Omega$ is the ocean domain. In the exact continuous dynamics, $M(t)$ is conserved in time for purely advective, divergence-free flow. However, a semi-Lagrangian (SL) numerical advection step may not preserve global mass due to interpolation and remapping errors.\n\nYou are given a horizontal ocean domain discretized into $N=4$ wet grid cells with volumes $\\{V_{i}\\}_{i=1}^{4}$ and tracer concentrations at the previous time level $t^{n}$, denoted $\\{q_{i}^{n}\\}_{i=1}^{4}$. After one SL tracer step to the new time level $t^{n+1}$, you obtain updated concentrations $\\{q_{i}^{*}\\}_{i=1}^{4}$ that do not, in general, conserve global mass. You will compute the global mass error and then apply a global mass fixer that adds a uniform concentration increment $\\delta$ to all wet cells so that the corrected concentrations $\\{q_{i}^{c}\\}_{i=1}^{4}$, with $q_{i}^{c} = q_{i}^{*} + \\delta$, exactly restore the initial global mass at $t^{n}$.\n\nUse the following data, which are scientifically plausible for large ocean grid cells:\n- Cell volumes (in $\\mathrm{m}^{3}$): $V_{1} = 1.20 \\times 10^{12}$, $V_{2} = 8.00 \\times 10^{11}$, $V_{3} = 1.50 \\times 10^{12}$, $V_{4} = 1.00 \\times 10^{12}$.\n- Initial concentrations (in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$) at $t^{n}$: $q_{1}^{n} = 2.000 \\times 10^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3}$.\n- Post-SL step concentrations (in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$) at $t^{n+1}$ before fixing: $q_{1}^{*} = 1.990 \\times 10^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3}$.\n\nStarting from the fundamental statement that the globally integrated mass for pure advection should be invariant in time, derive from first principles the expression for the global mass error after the SL step and the corresponding uniform correction $\\delta$ that restores conservation when applied to all wet cells. Then compute the value of $\\delta$ using the provided data.\n\nRound your final numerical result for $\\delta$ to four significant figures. Express the final answer in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.",
            "solution": "The problem requires the derivation and calculation of a uniform concentration correction, $\\delta$, to restore global mass conservation in a discretized ocean model after a non-conservative advection step. The core principle is that the total mass of the tracer should be invariant in the absence of sources or sinks.\n\nLet the ocean domain be discretized into $N=4$ grid cells with volumes $\\{V_i\\}_{i=1}^{4}$. Let $\\{q_i^n\\}_{i=1}^{4}$ be the tracer concentrations at time level $t^n$ and $\\{q_i^*\\}_{i=1}^{4}$ be the concentrations at time level $t^{n+1}$ after the semi-Lagrangian (SL) advection step.\n\nThe total tracer mass in the discrete system at time $t^n$ is given by the sum of mass in each cell:\n$$M^n = \\sum_{i=1}^{N} q_i^n V_i$$\nUsing the provided data:\n- Cell volumes: $V_{1} = 1.20 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{2} = 8.00 \\times 10^{11} \\, \\mathrm{m}^{3} = 0.80 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{3} = 1.50 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{4} = 1.00 \\times 10^{12} \\, \\mathrm{m}^{3}$.\n- Initial concentrations: $q_{1}^{n} = 2.000 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n\nWe calculate the initial mass $M^n$:\n$$M^n = (2.000 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.800 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.200 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.900 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^n = (2.400 \\times 10^{9}) + (1.440 \\times 10^{9}) + (3.300 \\times 10^{9}) + (1.900 \\times 10^{9})$$\n$$M^n = 9.040 \\times 10^{9} \\, \\mathrm{kg}$$\n\nSimilarly, the total mass after the SL step, $M^*$, is calculated using the post-SL concentrations $\\{q_i^*\\}_{i=1}^{4}$:\n- Post-SL concentrations: $q_{1}^{*} = 1.990 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n\n$$M^* = \\sum_{i=1}^{N} q_i^* V_i$$\n$$M^* = (1.990 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.810 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.190 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.880 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^* = (2.388 \\times 10^{9}) + (1.448 \\times 10^{9}) + (3.285 \\times 10^{9}) + (1.880 \\times 10^{9})$$\n$$M^* = 9.001 \\times 10^{9} \\, \\mathrm{kg}$$\n\nThe global mass error after the SL step is the difference between the mass after the step and the initial mass:\n$$\\Delta M = M^* - M^n = 9.001 \\times 10^{9} \\, \\mathrm{kg} - 9.040 \\times 10^{9} \\, \\mathrm{kg} = -0.039 \\times 10^{9} \\, \\mathrm{kg} = -3.9 \\times 10^{7} \\, \\mathrm{kg}$$\nThe negative sign indicates a numerical loss of mass.\n\nTo restore mass conservation, a uniform concentration correction $\\delta$ is added to each cell's concentration, yielding corrected concentrations $q_i^c = q_i^* + \\delta$. The total mass after correction, $M^c$, must equal the initial total mass, $M^n$. This is the \"first principle\" for this problem.\n$$M^c = M^n$$\nSubstituting the expression for $M^c$:\n$$\\sum_{i=1}^{N} q_i^c V_i = M^n$$\nSubstituting $q_i^c = q_i^* + \\delta$:\n$$\\sum_{i=1}^{N} (q_i^* + \\delta) V_i = M^n$$\nWe can distribute the sum:\n$$\\sum_{i=1}^{N} q_i^* V_i + \\sum_{i=1}^{N} \\delta V_i = M^n$$\nThe first term is $M^*$. The second term can be simplified by factoring out the constant $\\delta$:\n$$M^* + \\delta \\sum_{i=1}^{N} V_i = M^n$$\nLet $V_{total} = \\sum_{i=1}^{N} V_i$ be the total volume of the ocean domain. The equation becomes:\n$$M^* + \\delta V_{total} = M^n$$\nNow we solve for the correction $\\delta$:\n$$\\delta V_{total} = M^n - M^*$$\nThis leads to the derived expression for $\\delta$:\n$$\\delta = \\frac{M^n - M^*}{V_{total}} = \\frac{\\sum_{i=1}^{N} q_i^n V_i - \\sum_{i=1}^{N} q_i^* V_i}{\\sum_{i=1}^{N} V_i}$$\nThis expression represents the total mass deficit, $-(M^* - M^n)$, distributed uniformly over the total volume.\n\nNow, we compute the numerical value of $\\delta$. First, we calculate the total volume $V_{total}$:\n$$V_{total} = V_1 + V_2 + V_3 + V_4 = (1.20 + 0.80 + 1.50 + 1.00) \\times 10^{12} \\, \\mathrm{m}^{3}$$\n$$V_{total} = 4.50 \\times 10^{12} \\, \\mathrm{m}^{3}$$\nUsing the previously calculated masses:\n$$M^n - M^* = 9.040 \\times 10^{9} \\, \\mathrm{kg} - 9.001 \\times 10^{9} \\, \\mathrm{kg} = 0.039 \\times 10^{9} \\, \\mathrm{kg}$$\nNow, we compute $\\delta$:\n$$\\delta = \\frac{0.039 \\times 10^{9} \\, \\mathrm{kg}}{4.50 \\times 10^{12} \\, \\mathrm{m}^{3}}$$\n$$\\delta = \\frac{3.9 \\times 10^{7}}{4.50 \\times 10^{12}} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = \\frac{3.9}{4.50} \\times 10^{-5} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\n$$\\delta = 0.008666... \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = 8.666... \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\nRounding the result to four significant figures as requested:\n$$\\delta \\approx 8.667 \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\nThis positive value of $\\delta$ is added to each cell's concentration to compensate for the mass lost during the advection step.",
            "answer": "$$\\boxed{8.667 \\times 10^{-6}}$$"
        }
    ]
}