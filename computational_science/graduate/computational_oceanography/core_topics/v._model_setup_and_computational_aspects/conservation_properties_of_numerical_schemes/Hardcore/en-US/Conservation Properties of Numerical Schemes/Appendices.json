{
    "hands_on_practices": [
        {
            "introduction": "Understanding the conservation properties of a numerical scheme begins with a fundamental mathematical insight. This exercise guides you through an analytical derivation to prove how a discrete flux-form representation of a conservation law naturally leads to global conservation. By performing a symbolic summation, you will discover that the change in the total amount of a tracer over the entire domain depends solely on the fluxes across the system's boundaries, a discrete analogue of the Divergence Theorem .",
            "id": "3788105",
            "problem": "Consider the scalar tracer transport equation in two spatial dimensions, written in flux form as the conservation law $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$, discretized on a uniform Cartesian mesh with $N$ cells in the $x$-direction and $M$ cells in the $y$-direction, with grid spacings $\\Delta x$ and $\\Delta y$. Let cell centers be indexed by $(i,j)$ with $i \\in \\{1,\\dots,N\\}$ and $j \\in \\{1,\\dots,M\\}$. Face-normal velocities are defined at cell faces as $u_{i+1/2,j}$ on the east-west faces and $v_{i,j+1/2}$ on the north-south faces. Define centered face fluxes at time level $n$ by\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2},\n$$\nfor all interior faces, and let $F_{1/2,j}$, $F_{N+1/2,j}$, $G_{i,1/2}$, and $G_{i,M+1/2}$ denote the corresponding fluxes on the domain boundary faces (determined by the boundary conditions). Consider the explicit Euler update\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\nfor all interior cells $(i,j)$, where $\\Delta t$ is the time step.\n\nDefine the discrete global sum at time level $n$ by\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}.\n$$\nCompute the one-step change $\\Delta S \\equiv S^{n+1} - S^{n}$ exactly in closed form, expressed solely in terms of $\\Delta t$, $\\Delta x$, $\\Delta y$, and the boundary face fluxes $F_{1/2,j}$, $F_{N+1/2,j}$, $G_{i,1/2}$, and $G_{i,M+1/2}$. Then, based on your derivation, state the boundary and discrete-operator conditions under which the scheme is exactly conservative in the sense that $\\Delta S = 0$ holds to machine precision.\n\nYour final answer must be the single closed-form expression for $\\Delta S$ as requested. No numerical evaluation is required, and no rounding is needed. Do not include any units.",
            "solution": "The starting point is the discrete flux-form update, which approximates the continuous conservation law $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$ on a uniform grid. The explicit Euler update at each interior cell $(i,j)$ is\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\nwhere $F_{i+1/2,j}$ and $G_{i,j+1/2}$ are single-valued face fluxes located at the faces between two adjacent cells or at the domain boundary. These fluxes are constructed using centered averages of $q$ at adjacent cell centers and face-normal velocities at the same faces:\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2}.\n$$\nDefine the discrete global sum\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}, \\qquad \\Delta S \\equiv S^{n+1} - S^{n}.\n$$\nSumming the update over all interior cells yields\n\\begin{align*}\n\\Delta S \\;&=\\; \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( q^{n+1}_{i,j} - q^{n}_{i,j} \\right) \\\\\n&=\\; - \\Delta t \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right].\n\\end{align*}\nBecause $\\Delta x$ and $\\Delta y$ are constants, we reorganize the sums:\n\\begin{align*}\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right).\n\\end{align*}\nEach inner sum is a discrete telescoping sum. For the $x$-fluxes at fixed $j$,\n$$\n\\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;=\\; F_{N+1/2,j} - F_{1/2,j}.\n$$\nSimilarly, for the $y$-fluxes at fixed $i$,\n$$\n\\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right) \\;=\\; G_{i,M+1/2} - G_{i,1/2}.\n$$\nTherefore, the one-step change in the discrete global sum is exactly\n$$\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right).\n$$\nThis expression depends only on the boundary face fluxes. It follows that the scheme is exactly conservative in the discrete global sum, in the sense that $\\Delta S = 0$ to machine precision, under the following conditions:\n- Periodic boundary conditions in the $x$-direction and/or $y$-direction, which imply $F_{N+1/2,j} = F_{1/2,j}$ and/or $G_{i,M+1/2} = G_{i,1/2}$, respectively, rendering the corresponding sums zero.\n- Impermeable (no-normal-flow) boundary conditions, which impose $u_{1/2,j} = u_{N+1/2,j} = 0$ and $v_{i,1/2} = v_{i,M+1/2} = 0$, hence $F_{1/2,j} = F_{N+1/2,j} = 0$ and $G_{i,1/2} = G_{i,M+1/2} = 0$.\n- More generally, any boundary condition that enforces zero net boundary flux, i.e., $\\frac{1}{\\Delta x}\\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) + \\frac{1}{\\Delta y}\\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right) = 0$.\n\nThe conservation property arises because the discrete update is in flux form with single-valued face fluxes shared by adjacent cells, so interior contributions cancel exactly when summed globally, leaving only boundary contributions. The explicit Euler time integration does not alter this cancellation because it multiplies the discrete divergence uniformly by $\\Delta t$ without mixing spatial locations.",
            "answer": "$$\\boxed{- \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) - \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right)}$$"
        },
        {
            "introduction": "While the basic principle of conservation is simple, modern numerical schemes employ complex, non-linear components to achieve high accuracy and stability. This practice challenges you to implement a high-order Monotonic Upstream-Centered Scheme for Conservation Laws (MUSCL) with various Total Variation Diminishing (TVD) limiters. You will verify through a coding exercise that despite the non-linearity introduced by the limiters, the scheme remains perfectly conservative to machine precision, reinforcing the power of maintaining a strict flux-difference formulation .",
            "id": "3788113",
            "problem": "Consider the one-dimensional advection of a passive tracer under a constant, divergence-free velocity on a periodic domain. The governing conservation law is the linear advection equation $\\partial_t c + u \\,\\partial_x c = 0$ on the domain $x \\in [0,L]$ with periodic boundary conditions. Let $u$ and $L$ be constant. Discretize the domain into $N$ cells of uniform width $\\Delta x = L/N$ and let $C_i^n$ denote the cell-averaged tracer concentration in cell $i \\in \\{0,1,\\dots,N-1\\}$ at time $t^n = n\\,\\Delta t$, where $\\Delta t$ is the time step.\n\nAdopt a finite-volume update of the form\n$$\nC_i^{n+1} = C_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n\\right),\n$$\nwhere $F_{i+\\frac{1}{2}}^n$ is a numerical flux at the interface between cells $i$ and $i+1$ computed by an upwind Monotonic Upstream-Centered Scheme for Conservation Laws (MUSCL) with a Total Variation Diminishing (TVD) limiter. Denote the one-sided slopes by $\\delta_i^- = C_i - C_{i-1}$ and $\\delta_i^+ = C_{i+1} - C_i$, with indices taken modulo $N$ to enforce periodicity. Define the ratio $r_i = \\delta_i^- / \\delta_i^+$, using a safe convention that sets $r_i = 0$ whenever $\\delta_i^+ = 0$. Let $\\phi(r)$ be a TVD limiter function. Reconstruct the left and right interface states at $x_{i+\\frac{1}{2}}$ via\n$$\nC_{i+\\frac{1}{2}}^L = C_i + \\frac{1}{2}\\,\\phi(r_i)\\,\\delta_i^-, \\qquad\nC_{i+\\frac{1}{2}}^R = C_{i+1} - \\frac{1}{2}\\,\\phi(r_{i+1})\\,\\delta_{i+1}^-.\n$$\nUse upwind fluxes $F_{i+\\frac{1}{2}} = u\\,C_{i+\\frac{1}{2}}^L$ if $u \\ge 0$ and $F_{i+\\frac{1}{2}} = u\\,C_{i+\\frac{1}{2}}^R$ if $u < 0$. Advance in time using the second-order Strong Stability Preserving Runge–Kutta (SSPRK) scheme,\n$$\n\\begin{aligned}\nC^{(1)} &= C^n + \\Delta t\\,\\mathcal{L}(C^n),\\\\\nC^{n+1} &= \\tfrac{1}{2}\\,C^n + \\tfrac{1}{2}\\left[C^{(1)} + \\Delta t\\,\\mathcal{L}\\left(C^{(1)}\\right)\\right],\n\\end{aligned}\n$$\nwhere $\\mathcal{L}(C)$ denotes the conservative spatial operator corresponding to the flux differences above.\n\nImplement the following limiter families, with $\\phi(r)$ defined for $r \\in \\mathbb{R}$:\n- Minmod: $\\phi_{\\mathrm{mm}}(r) = \\max\\left(0, \\min(1,r)\\right)$.\n- Van Leer: $\\phi_{\\mathrm{vl}}(r) = \\dfrac{r + |r|}{1 + |r|}$.\n- Monotonized Central (MC): $\\phi_{\\mathrm{mc}}(r) = \\max\\left(0, \\min\\left(2r, \\dfrac{1+r}{2}, 2\\right)\\right)$.\n- Superbee: $\\phi_{\\mathrm{sb}}(r) = \\max\\left(0, \\min(2r,1), \\min(r,2)\\right)$.\n\nLet the Courant number be $\\nu = u\\,\\Delta t/\\Delta x$, and assume $\\nu \\in (0,1]$. The total tracer mass at time $t^n$ is $M^n = \\sum_{i=0}^{N-1} C_i^n\\,\\Delta x$. Under exact arithmetic and periodic boundaries, conservation implies $M^{n+1} = M^n$ for all $n$.\n\nTask: Write a complete, runnable program that:\n1. Implements the finite-volume MUSCL–TVD scheme with the four limiter choices above and time integrates using the SSPRK method.\n2. For each specified test case below, computes the initial total mass $M^0$, advances for a given number of steps $n_{\\mathrm{steps}}$, then computes the final total mass $M^{n_{\\mathrm{steps}}}$ and returns the absolute mass change $\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|$.\n\nUse $L = 1$ (dimensionless), $u = 1$ (dimensionless), and treat all reported quantities as dimensionless. Whenever trigonometric functions are used, interpret angles in radians. No physical units are required; all outputs must be dimensionless real numbers.\n\nTest suite (each case is a tuple of limiter, initial condition, number of cells $N$, Courant number $\\nu$, and number of steps $n_{\\mathrm{steps}}$):\n- Case $1$: limiter $=$ minmod, initial condition $c(x,0) = 1$ for $x < 0.3$ and $0$ otherwise (periodic interpretation), $N = 200$, $\\nu = 0.5$, $n_{\\mathrm{steps}} = 400$.\n- Case $2$: limiter $=$ superbee, initial condition $c(x,0) = \\exp\\!\\left(-\\left(\\dfrac{x - 0.5}{0.02}\\right)^2\\right)$, $N = 300$, $\\nu = 0.9$, $n_{\\mathrm{steps}} = 137$.\n- Case $3$: limiter $=$ van Leer, initial condition is a cosine bell with center $x_0 = 0.25$ and width $w = 0.2$, defined by $c(x,0) = \\tfrac{1}{2}\\left(1 - \\cos\\left(2\\pi\\,\\dfrac{x - x_0}{w}\\right)\\right)$ for $\\left|x - x_0\\right| \\le \\tfrac{w}{2}$ and $c(x,0) = 0$ otherwise, $N = 128$, $\\nu = 0.3$, $n_{\\mathrm{steps}} = 500$.\n- Case $4$: limiter $=$ MC, initial condition is a double square pulse $c(x,0) = 1$ on $[0.1, 0.15] \\cup [0.7, 0.75]$ and $0$ elsewhere, $N = 512$, $\\nu = 0.7$, $n_{\\mathrm{steps}} = 777$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain, in order, the absolute mass changes for Cases $1$ through $4$, i.e., $[\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|_{\\text{Case }1},\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|_{\\text{Case }2},\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|_{\\text{Case }3},\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|_{\\text{Case }4}]$. Each entry must be a floating-point number. The numerical method should achieve mass conservation to within double-precision roundoff, so values on the order of $10^{-12}$ or smaller are acceptable and indicate successful conservation.",
            "solution": "The problem centers on solving the one-dimensional linear advection equation, a fundamental conservation law given by:\n$$\n\\partial_t c + u \\,\\partial_x c = 0\n$$\nHere, $c(x,t)$ is the concentration of a passive tracer, $u$ is a constant advection velocity, $x \\in [0,L]$ is the spatial coordinate on a periodic domain, and $t$ is time. The core task is to implement a high-order, conservative numerical scheme and verify its mass-conservation property.\n\nThe numerical method is based on a finite-volume approach. The domain is discretized into $N$ cells of width $\\Delta x = L/N$. Integrating the governing equation over a cell $i$, from $x_{i-\\frac{1}{2}}$ to $x_{i+\\frac{1}{2}}$, yields the exact evolution equation for the cell-averaged concentration $C_i(t)$:\n$$\n\\frac{dC_i}{dt} + \\frac{1}{\\Delta x} \\left( u\\,c(x_{i+\\frac{1}{2}}, t) - u\\,c(x_{i-\\frac{1}{2}}, t) \\right) = 0\n$$\nThis is written in terms of numerical fluxes $F_{i \\pm \\frac{1}{2}}$ as a semi-discrete system of ordinary differential equations:\n$$\n\\frac{dC_i}{dt} = -\\frac{1}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right) \\equiv \\mathcal{L}(C)_i\n$$\nwhere $\\mathcal{L}(C)$ is the spatial operator. A scheme written in this form is \"conservative\" by construction, as the flux out of one cell is the flux into the adjacent cell.\n\nTo achieve second-order accuracy in space while maintaining non-oscillatory solutions, the problem specifies a Monotonic Upstream-Centered Scheme for Conservation Laws (MUSCL) with a Total Variation Diminishing (TVD) flux limiter. The numerical flux $F_{i+\\frac{1}{2}}$ at the interface between cells $i$ and $i+1$ is determined using reconstructed values of the concentration at the interface. The reconstruction is based on a linear profile within each cell, where the slope is limited to prevent over- and under-shoots near sharp gradients.\n\nThe reconstruction depends on the one-sided slopes $\\delta_i^- = C_i - C_{i-1}$ and $\\delta_i^+ = C_{i+1} - C_i$. The ratio of these slopes, $r_i = \\delta_i^- / \\delta_i^+$, is used to determine the extent of slope limiting. The problem defines the convention $r_i=0$ if $\\delta_i^+=0$. With a chosen TVD limiter function $\\phi(r)$, the reconstructed concentration at the left side of the interface $x_{i+\\frac{1}{2}}$ is:\n$$\nC_{i+\\frac{1}{2}}^L = C_i + \\frac{1}{2}\\,\\phi(r_i)\\,\\delta_i^-\n$$\nSince the velocity is specified as $u=1 > 0$, the upwind flux is determined by the state upwind of the interface, which is the left state:\n$$\nF_{i+\\frac{1}{2}} = u\\,C_{i+\\frac{1}{2}}^L = u\\left(C_i + \\frac{1}{2}\\,\\phi(r_i)\\,\\delta_i^-\\right)\n$$\nThe problem specifies four common TVD limiter functions: Minmod, Van Leer, Monotonized Central (MC), and Superbee.\n- Minmod: $\\phi_{\\mathrm{mm}}(r) = \\max\\left(0, \\min(1,r)\\right)$\n- Van Leer: $\\phi_{\\mathrm{vl}}(r) = \\dfrac{r + |r|}{1 + |r|}$\n- MC: $\\phi_{\\mathrm{mc}}(r) = \\max\\left(0, \\min\\left(2r, \\dfrac{1+r}{2}, 2\\right)\\right)$\n- Superbee: $\\phi_{\\mathrm{sb}}(r) = \\max\\left(0, \\min(2r,1), \\min(r,2)\\right)$\n\nFor time integration, the problem mandates the use of the second-order Strong Stability Preserving Runge–Kutta (SSPRK2) method. Given the concentration $C^n$ at time step $n$, the solution at step $n+1$ is found via a two-stage process using the spatial operator $\\mathcal{L}(C)$:\n$$\n\\begin{aligned}\nC^{(1)} &= C^n + \\Delta t\\,\\mathcal{L}(C^n) \\\\\nC^{n+1} &= \\tfrac{1}{2}\\,C^n + \\tfrac{1}{2}\\left[C^{(1)} + \\Delta t\\,\\mathcal{L}\\left(C^{(1)}\\right)\\right]\n\\end{aligned}\n$$\nThis method is chosen for its stability properties when used with TVD spatial discretizations.\n\nA key aspect of the problem is verifying the mass conservation property. The total mass at a given time $t^n$ is $M^n = \\sum_{i=0}^{N-1} C_i^n\\,\\Delta x$. The rate of change of total mass is $\\frac{dM}{dt} = \\Delta x \\sum_{i=0}^{N-1} \\frac{dC_i}{dt}$. Substituting the semi-discrete form:\n$$\n\\frac{dM}{dt} = \\Delta x \\sum_{i=0}^{N-1} \\mathcal{L}(C)_i = \\Delta x \\sum_{i=0}^{N-1} \\left[-\\frac{1}{\\Delta x}\\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)\\right] = -\\sum_{i=0}^{N-1} \\left(F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}\\right)\n$$\nLet's denote the flux at the right boundary of cell $i$ as $F_i$ (i.e., $F_i = F_{i+1/2}$). The update for cell $i$ uses fluxes $F_i$ and $F_{i-1}$. With periodic boundary conditions, the indices are taken modulo $N$, so $F_{-1} = F_{N-1}$. The sum becomes a telescoping series:\n$$\n\\sum_{i=0}^{N-1} (F_i - F_{i-1}) = (F_0 - F_{-1}) + (F_1 - F_0) + \\dots + (F_{N-1} - F_{N-2})\n$$\nWith $F_{-1} = F_{N-1}$, all terms cancel, and the sum is exactly zero.\n$$\n(F_0 - F_{N-1}) + (F_1 - F_0) + \\dots + (F_{N-1} - F_{N-2}) = (-F_{N-1} + F_0) + (-F_0+F_1) + \\dots + (-F_{N-2}+F_{N-1}) = 0\n$$\nThus, $\\frac{dM}{dt} = 0$. Since the SSPRK2 method is a linear combination of applications of this mass-conserving operator $\\mathcal{L}$, it also conserves mass exactly at each stage. In finite-precision arithmetic, any change in the total computed mass $\\left|M^{n_{\\mathrm{steps}}} - M^0\\right|$ will be attributable solely to floating-point roundoff errors, and is expected to be a very small number.\n\nThe implementation will proceed as follows:\n1. Define functions for the four specified TVD limiters.\n2. Define functions to generate the initial conditions for each test case.\n3. Create a core function to compute the spatial operator, $\\mathcal{L}(C)$, which involves calculating slopes, limiter ratios, reconstructing interface values, computing fluxes, and finally differencing the fluxes. Periodic boundary conditions will be handled using array rolling/shifting operations.\n4. Implement the main simulation logic that, for each test case, initializes the grid and concentration field, calculates the initial mass, iterates through the time steps using the SSPRK2 method, and finally computes the absolute change in total mass.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the MUSCL-TVD simulation for all test cases.\n    \"\"\"\n\n    # --- Limiter Functions ---\n    def phi_minmod(r):\n        return np.maximum(0, np.minimum(1, r))\n\n    def phi_vanleer(r):\n        # The formula is (r + |r|) / (1 + |r|).\n        # This is equivalent to max(0, 2*r / (1+r)) but avoids division by zero if r=-1.\n        # The given formula is safe for all r.\n        # np.abs(r) in denominator avoids issues if r = -1.\n        with np.errstate(divide='ignore', invalid='ignore'):\n            return (r + np.abs(r)) / (1 + np.abs(r))\n\n    def phi_mc(r):\n        # max(0, min(2r, (1+r)/2, 2))\n        return np.maximum(0, np.minimum(2 * r, np.minimum((1 + r) / 2, 2)))\n\n    def phi_superbee(r):\n        # max(0, min(2r, 1), min(r, 2))\n        return np.maximum(0, np.maximum(np.minimum(2 * r, 1), np.minimum(r, 2)))\n        \n    limiters = {\n        'minmod': phi_minmod,\n        'van Leer': phi_vanleer,\n        'MC': phi_mc,\n        'superbee': phi_superbee,\n    }\n\n    # --- Initial Condition Functions ---\n    def ic_case1(x):\n        # Square pulse\n        return np.where(x < 0.3, 1.0, 0.0)\n\n    def ic_case2(x):\n        # Gaussian\n        return np.exp(-((x - 0.5) / 0.02)**2)\n\n    def ic_case3(x):\n        # Cosine bell\n        x0, w = 0.25, 0.2\n        c = np.zeros_like(x)\n        mask = np.abs(x - x0) <= w / 2\n        c[mask] = 0.5 * (1 - np.cos(2 * np.pi * (x[mask] - x0) / w))\n        return c\n\n    def ic_case4(x):\n        # Double square pulse\n        c = np.zeros_like(x)\n        mask1 = (x >= 0.1) & (x <= 0.15)\n        mask2 = (x >= 0.7) & (x <= 0.75)\n        c[mask1 | mask2] = 1.0\n        return c\n\n    initial_conditions = {\n        'case1': ic_case1,\n        'case2': ic_case2,\n        'case3': ic_case3,\n        'case4': ic_case4,\n    }\n    \n    # --- Spatial Operator L(C) ---\n    def spatial_operator(C, dx, u, limiter_func):\n        N = len(C)\n        # Periodic boundary conditions via np.roll\n        C_im1 = np.roll(C, 1)  # C_{i-1}\n        C_ip1 = np.roll(C, -1) # C_{i+1}\n\n        # One-sided slopes\n        delta_minus = C - C_im1\n        delta_plus = C_ip1 - C\n\n        # Ratio r_i = delta_minus_i / delta_plus_i, with safe division\n        r = np.zeros(N)\n        mask = delta_plus != 0\n        r[mask] = delta_minus[mask] / delta_plus[mask]\n\n        # Apply limiter\n        phi_vals = limiter_func(r)\n\n        # Reconstruct left state at interface x_{i+1/2}\n        # C_L_{i+1/2} = C_i + 0.5 * phi(r_i) * delta_minus_i\n        C_L = C + 0.5 * phi_vals * delta_minus\n        \n        # Upwind flux (since u > 0, F_{i+1/2} = u * C_L_{i+1/2})\n        # F[i] corresponds to flux F_{i+1/2}\n        F = u * C_L\n\n        # Flux at interface x_{i-1/2}\n        # F_im12[i] corresponds to flux F_{i-1/2}\n        F_im12 = np.roll(F, 1)\n\n        # Spatial operator L(C)_i = - (F_{i+1/2} - F_{i-1/2}) / dx\n        return -(F - F_im12) / dx\n\n    # --- Main Simulation Runner ---\n    def run_simulation(limiter_name, ic_func, N, nu, n_steps):\n        L = 1.0\n        u = 1.0\n        dx = L / N\n        dt = nu * dx / u\n\n        # Grid of cell centers\n        x = (np.arange(N) + 0.5) * dx\n        \n        # Initial condition\n        C = ic_func(x)\n\n        # Initial mass\n        M0 = np.sum(C) * dx\n\n        limiter_func = limiters[limiter_name]\n        \n        # Time-stepping loop (SSPRK2)\n        for _ in range(n_steps):\n            # Stage 1\n            L_C = spatial_operator(C, dx, u, limiter_func)\n            C1 = C + dt * L_C\n            \n            # Stage 2\n            L_C1 = spatial_operator(C1, dx, u, limiter_func)\n            C = 0.5 * C + 0.5 * (C1 + dt * L_C1)\n        \n        # Final mass\n        M_final = np.sum(C) * dx\n\n        # Absolute mass change\n        return np.abs(M_final - M0)\n\n    # --- Test Cases ---\n    test_cases = [\n        ('minmod', initial_conditions['case1'], 200, 0.5, 400),\n        ('superbee', initial_conditions['case2'], 300, 0.9, 137),\n        ('van Leer', initial_conditions['case3'], 128, 0.3, 500),\n        ('MC', initial_conditions['case4'], 512, 0.7, 777),\n    ]\n\n    results = []\n    for case in test_cases:\n        limiter, ic_func, N, nu, n_steps = case\n        mass_change = run_simulation(limiter, ic_func, N, nu, n_steps)\n        results.append(mass_change)\n\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "In an ideal world, all numerical schemes would be perfectly conservative. However, some highly efficient methods, like semi-Lagrangian (SL) advection, sacrifice strict conservation for other desirable properties such as allowing large time steps. This exercise addresses the practical, real-world challenge of using non-conservative schemes in long-term simulations by introducing the concept of a 'mass fixer'—a post-processing step that restores the global inventory of a tracer, ensuring the physical realism of the model output .",
            "id": "3788093",
            "problem": "Consider an ocean tracer governed by the advection equation with no sources or sinks, so that the instantaneous global tracer mass in a closed ocean domain is given by the volume integral $M(t) = \\int_{\\Omega} q(\\mathbf{x}, t)\\, \\mathrm{d}V$, where $q$ is the tracer concentration in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ and $\\Omega$ is the ocean domain. In the exact continuous dynamics, $M(t)$ is conserved in time for purely advective, divergence-free flow. However, a semi-Lagrangian (SL) numerical advection step may not preserve global mass due to interpolation and remapping errors.\n\nYou are given a horizontal ocean domain discretized into $N=4$ wet grid cells with volumes $\\{V_{i}\\}_{i=1}^{4}$ and tracer concentrations at the previous time level $t^{n}$, denoted $\\{q_{i}^{n}\\}_{i=1}^{4}$. After one SL tracer step to the new time level $t^{n+1}$, you obtain updated concentrations $\\{q_{i}^{*}\\}_{i=1}^{4}$ that do not, in general, conserve global mass. You will compute the global mass error and then apply a global mass fixer that adds a uniform concentration increment $\\delta$ to all wet cells so that the corrected concentrations $\\{q_{i}^{c}\\}_{i=1}^{4}$, with $q_{i}^{c} = q_{i}^{*} + \\delta$, exactly restore the initial global mass at $t^{n}$.\n\nUse the following data, which are scientifically plausible for large ocean grid cells:\n- Cell volumes (in $\\mathrm{m}^{3}$): $V_{1} = 1.20 \\times 10^{12}$, $V_{2} = 8.00 \\times 10^{11}$, $V_{3} = 1.50 \\times 10^{12}$, $V_{4} = 1.00 \\times 10^{12}$.\n- Initial concentrations (in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$) at $t^{n}$: $q_{1}^{n} = 2.000 \\times 10^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3}$.\n- Post-SL step concentrations (in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$) at $t^{n+1}$ before fixing: $q_{1}^{*} = 1.990 \\times 10^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3}$.\n\nStarting from the fundamental statement that the globally integrated mass for pure advection should be invariant in time, derive from first principles the expression for the global mass error after the SL step and the corresponding uniform correction $\\delta$ that restores conservation when applied to all wet cells. Then compute the value of $\\delta$ using the provided data.\n\nRound your final numerical result for $\\delta$ to four significant figures. Express the final answer in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.",
            "solution": "The problem requires the derivation and calculation of a uniform concentration correction, $\\delta$, to restore global mass conservation in a discretized ocean model after a non-conservative advection step. The core principle is that the total mass of the tracer should be invariant in the absence of sources or sinks.\n\nLet the ocean domain be discretized into $N=4$ grid cells with volumes $\\{V_i\\}_{i=1}^{4}$. Let $\\{q_i^n\\}_{i=1}^{4}$ be the tracer concentrations at time level $t^n$ and $\\{q_i^*\\}_{i=1}^{4}$ be the concentrations at time level $t^{n+1}$ after the semi-Lagrangian (SL) advection step.\n\nThe total tracer mass in the discrete system at time $t^n$ is given by the sum of mass in each cell:\n$$M^n = \\sum_{i=1}^{N} q_i^n V_i$$\nUsing the provided data:\n- Cell volumes: $V_{1} = 1.20 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{2} = 8.00 \\times 10^{11} \\, \\mathrm{m}^{3} = 0.80 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{3} = 1.50 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{4} = 1.00 \\times 10^{12} \\, \\mathrm{m}^{3}$.\n- Initial concentrations: $q_{1}^{n} = 2.000 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n\nWe calculate the initial mass $M^n$:\n$$M^n = (2.000 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.800 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.200 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.900 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^n = (2.400 \\times 10^{9}) + (1.440 \\times 10^{9}) + (3.300 \\times 10^{9}) + (1.900 \\times 10^{9})$$\n$$M^n = 9.040 \\times 10^{9} \\, \\mathrm{kg}$$\n\nSimilarly, the total mass after the SL step, $M^*$, is calculated using the post-SL concentrations $\\{q_i^*\\}_{i=1}^{4}$:\n- Post-SL concentrations: $q_{1}^{*} = 1.990 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n\n$$M^* = \\sum_{i=1}^{N} q_i^* V_i$$\n$$M^* = (1.990 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.810 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.190 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.880 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^* = (2.388 \\times 10^{9}) + (1.448 \\times 10^{9}) + (3.285 \\times 10^{9}) + (1.880 \\times 10^{9})$$\n$$M^* = 9.001 \\times 10^{9} \\, \\mathrm{kg}$$\n\nThe global mass error after the SL step is the difference between the mass after the step and the initial mass:\n$$\\Delta M = M^* - M^n = 9.001 \\times 10^{9} \\, \\mathrm{kg} - 9.040 \\times 10^{9} \\, \\mathrm{kg} = -0.039 \\times 10^{9} \\, \\mathrm{kg} = -3.9 \\times 10^{7} \\, \\mathrm{kg}$$\nThe negative sign indicates a numerical loss of mass.\n\nTo restore mass conservation, a uniform concentration correction $\\delta$ is added to each cell's concentration, yielding corrected concentrations $q_i^c = q_i^* + \\delta$. The total mass after correction, $M^c$, must equal the initial total mass, $M^n$. This is the \"first principle\" for this problem.\n$$M^c = M^n$$\nSubstituting the expression for $M^c$:\n$$\\sum_{i=1}^{N} q_i^c V_i = M^n$$\nSubstituting $q_i^c = q_i^* + \\delta$:\n$$\\sum_{i=1}^{N} (q_i^* + \\delta) V_i = M^n$$\nWe can distribute the sum:\n$$\\sum_{i=1}^{N} q_i^* V_i + \\sum_{i=1}^{N} \\delta V_i = M^n$$\nThe first term is $M^*$. The second term can be simplified by factoring out the constant $\\delta$:\n$$M^* + \\delta \\sum_{i=1}^{N} V_i = M^n$$\nLet $V_{total} = \\sum_{i=1}^{N} V_i$ be the total volume of the ocean domain. The equation becomes:\n$$M^* + \\delta V_{total} = M^n$$\nNow we solve for the correction $\\delta$:\n$$\\delta V_{total} = M^n - M^*$$\nThis leads to the derived expression for $\\delta$:\n$$\\delta = \\frac{M^n - M^*}{V_{total}} = \\frac{\\sum_{i=1}^{N} q_i^n V_i - \\sum_{i=1}^{N} q_i^* V_i}{\\sum_{i=1}^{N} V_i}$$\nThis expression represents the total mass deficit, $-(M^* - M^n)$, distributed uniformly over the total volume.\n\nNow, we compute the numerical value of $\\delta$. First, we calculate the total volume $V_{total}$:\n$$V_{total} = V_1 + V_2 + V_3 + V_4 = (1.20 + 0.80 + 1.50 + 1.00) \\times 10^{12} \\, \\mathrm{m}^{3}$$\n$$V_{total} = 4.50 \\times 10^{12} \\, \\mathrm{m}^{3}$$\nUsing the previously calculated masses:\n$$M^n - M^* = 9.040 \\times 10^{9} \\, \\mathrm{kg} - 9.001 \\times 10^{9} \\, \\mathrm{kg} = 0.039 \\times 10^{9} \\, \\mathrm{kg}$$\nNow, we compute $\\delta$:\n$$\\delta = \\frac{0.039 \\times 10^{9} \\, \\mathrm{kg}}{4.50 \\times 10^{12} \\, \\mathrm{m}^{3}}$$\n$$\\delta = \\frac{3.9 \\times 10^{7}}{4.50 \\times 10^{12}} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = \\frac{3.9}{4.50} \\times 10^{-5} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\n$$\\delta = 0.008666... \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = 8.666... \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\nRounding the result to four significant figures as requested:\n$$\\delta \\approx 8.667 \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\nThis positive value of $\\delta$ is added to each cell's concentration to compensate for the mass lost during the advection step.",
            "answer": "$$\\boxed{8.667 \\times 10^{-6}}$$"
        }
    ]
}