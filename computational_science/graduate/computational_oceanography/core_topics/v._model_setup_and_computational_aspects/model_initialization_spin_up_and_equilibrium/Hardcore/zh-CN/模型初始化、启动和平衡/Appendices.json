{
    "hands_on_practices": [
        {
            "introduction": "在启动任何海洋环流模型的数值模拟之前，一个最基本且至关重要的步骤是选择一个合适的积分时间步长。这个练习将指导你完成这一过程，通过分析给定的初始流场，来确定保证数值稳定性所需的最大时间步长。通过这个实践，你将应用著名的 Courant–Friedrichs–Lewy (CFL) 条件，深刻理解流速、网格分辨率和时间步长三者之间为维持显式平流方案稳定而必须满足的内在联系。",
            "id": "3799525",
            "problem": "考虑在一个恒定科里奥利参数平面（通常称为 $f$ 平面）上的矩形盆地中，正压无辐散流的启动过程。盆地尺寸为 $L \\times L$，其中 $L=1.0\\times 10^{6}$ 米。水平离散化是均匀的，在 Arakawa C-网格上 $\\Delta x=\\Delta y=5.0\\times 10^{3}$ 米。模型启动时的初始速度场由给定的流函数 $\\psi(x,y)$ 根据地转运动学生成，即 $u(x,y)=-\\partial \\psi/\\partial y$ 和 $v(x,y)=\\partial \\psi/\\partial x$，其中\n$$\n\\psi(x,y)=U_{0}\\,\\lambda\\,\\tanh\\!\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right).\n$$\n此处 $U_{0}=1.0$ 米/秒和 $\\lambda=1.0\\times 10^{5}$ 米是固定参数。数值模型中的标量平流算子使用带 Strang 方向分裂的显式施主单元（一阶迎风）格式进行时间推进。对于这种方向分裂的显式平流更新，稳定性要求每个坐标方向上的 Courant–Friedrichs–Lewy (CFL) 数在所有网格点上都必须严格小于一。CFL 数定义为一个时间步长内平流的距离与相应网格间距的无量纲比率。\n\n从连续二维平流方程和给定的初始化条件出发，推导在整个区域上 $x$ 和 $y$ 方向的最大 Courant 数的表达式，并用它们来确定在初始启动过程中处处满足方向稳定性要求的最大允许时间步长。将你的最终答案表示为最大允许时间步长 $\\Delta t_{\\mathrm{max}}$（单位为秒），并将答案四舍五入到四位有效数字。在最终的方框答案中不要包含任何单位。",
            "solution": "在尝试任何解答之前，需对问题进行验证。\n\n### 步骤 1：提取已知条件\n-   **流动与几何**：在 $f$ 平面上的一个尺寸为 $L \\times L$ 的矩形盆地中的正压无辐散流。\n-   **参数**：\n    -   盆地边长：$L = 1.0 \\times 10^{6}$ 米。\n    -   网格间距：$\\Delta x = \\Delta y = 5.0 \\times 10^{3}$ 米。\n    -   流函数参数：$U_{0} = 1.0$ 米/秒。\n    -   流函数参数：$\\lambda = 1.0 \\times 10^{5}$ 米。\n-   **网格**：Arakawa C-网格。\n-   **初始化**：初始速度场 $(u, v)$ 通过地转运动学从流函数 $\\psi(x,y)$ 导出：$u(x,y) = -\\frac{\\partial \\psi}{\\partial y}$ 和 $v(x,y) = \\frac{\\partial \\psi}{\\partial x}$。\n-   **流函数**：$\\psi(x,y) = U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)$。\n-   **数值格式**：用于平流计算的、带 Strang 方向分裂的显式施主单元（一阶迎风）格式。\n-   **稳定性条件**：每个坐标方向的 Courant–Friedrichs–Lewy (CFL) 数必须严格小于 $1$：$C_x = \\frac{|u| \\Delta t}{\\Delta x}  1$ 和 $C_y = \\frac{|v| \\Delta t}{\\Delta y}  1$。\n-   **目标**：确定最大允许时间步长 $\\Delta t_{\\mathrm{max}}$，并将结果四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n对问题陈述的有效性进行评估。\n-   **科学依据**：该问题在计算地球物理流体动力学原理方面有充分的依据。$f$平面、地转平衡、流函数、Arakawa C-网格以及 CFL 稳定性条件等概念都是该领域的标准和基础概念。所给定的参数对于大尺度海洋模拟是物理上现实的。\n-   **适定性**：该问题是适定的。它要求为给定的显式数值格式和定义明确的初始速度场计算最大稳定时间步长。所有必要的信息都已提供，可以用来推导速度分量、找到其最大值，并应用稳定性判据来找到唯一的时间步长。\n-   **客观性与完整性**：问题以精确、客观的语言陈述。区域被指定为尺寸为 $L \\times L$ 的矩形盆地，通常解释为 $x \\in [0, L]$ 和 $y \\in [0, L]$。这个假设是充分的，并且与问题的结构一致。问题是自洽的，没有矛盾。\n\n### 步骤 3：结论与行动\n问题被判定为**有效**。将制定解决方案。\n\n显式、方向分裂的数值格式的稳定性要求在整个计算域中，每个方向的 Courant 数都严格小于一。这可以表示为关于时间步长 $\\Delta t$ 的两个条件：\n$$\n\\frac{|u(x,y)| \\Delta t}{\\Delta x}  1 \\quad \\text{对所有 } (x,y)\n$$\n$$\n\\frac{|v(x,y)| \\Delta t}{\\Delta y}  1 \\quad \\text{对所有 } (x,y)\n$$\n为确保这些条件处处成立，$\\Delta t$ 必须满足：\n$$\n\\Delta t  \\frac{\\Delta x}{\\max|u(x,y)|} \\quad \\text{和} \\quad \\Delta t  \\frac{\\Delta y}{\\max|v(x,y)|}\n$$\n因此，最大允许时间步长 $\\Delta t_{\\mathrm{max}}$ 是这两个上界的最小值：\n$$\n\\Delta t_{\\mathrm{max}} = \\min \\left( \\frac{\\Delta x}{\\max|u|}, \\frac{\\Delta y}{\\max|v|} \\right)\n$$\n其中 $\\max|u|$ 和 $\\max|v|$ 是整个盆地内速度分量的最大绝对值。\n\n首先，我们必须从给定的流函数 $\\psi(x,y)$ 推导速度分量 $u(x,y)$ 和 $v(x,y)$。\n流函数为：\n$$\n\\psi(x,y) = U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\n$$\n纬向速度分量 $u$ 通过对 $\\psi$ 关于 $y$ 求导得到：\n$$\nu(x,y) = -\\frac{\\partial \\psi}{\\partial y} = -\\frac{\\partial}{\\partial y} \\left[ U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) \\right]\n$$\n使用链式法则 $\\frac{d}{dz}\\tanh(z) = \\text{sech}^2(z)$，我们得到：\n$$\nu(x,y) = -U_{0}\\,\\lambda\\,\\left( \\text{sech}^2\\left(\\frac{y}{\\lambda}\\right) \\cdot \\frac{1}{\\lambda} \\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) = -U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\n$$\n经向速度分量 $v$ 通过对 $\\psi$ 关于 $x$ 求导得到：\n$$\nv(x,y) = \\frac{\\partial \\psi}{\\partial x} = \\frac{\\partial}{\\partial x} \\left[ U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) \\right]\n$$\n这得到：\n$$\nv(x,y) = U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\left( \\cos\\left(\\frac{\\pi x}{L}\\right) \\cdot \\frac{\\pi}{L} \\right) = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\cos\\left(\\frac{\\pi x}{L}\\right)\n$$\n接下来，我们求在区域 $x \\in [0, L]$ 和 $y \\in [0, L]$ 上 $u$ 和 $v$ 的最大绝对值。\n\n对于纬向速度 $u(x,y)$：\n$$\n|u(x,y)| = \\left|-U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\\right| = U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\left|\\sin\\left(\\frac{\\pi x}{L}\\right)\\right|\n$$\n函数 $\\text{sech}^2(z)$ 的最大值为 $1$，出现在 $z=0$ 处。在我们的情况下，这对应于 $y=0$。$|\\sin(\\theta)|$ 的最大值为 $1$。对于 $x \\in [0, L]$，项 $|\\sin(\\pi x/L)|$ 在 $x = L/2$ 处达到其最大值 $1$。因此，$|u|$ 的最大值为：\n$$\n\\max|u| = U_{0} \\cdot (1) \\cdot (1) = U_{0}\n$$\n给定 $U_{0} = 1.0$ 米/秒，我们有 $\\max|u| = 1.0$ 米/秒。\n\n对于经向速度 $v(x,y)$：\n$$\n|v(x,y)| = \\left|\\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\cos\\left(\\frac{\\pi x}{L}\\right)\\right| = \\frac{\\pi U_{0} \\lambda}{L}\\,\\left|\\tanh\\left(\\frac{y}{\\lambda}\\right)\\right|\\,\\left|\\cos\\left(\\frac{\\pi x}{L}\\right)\\right|\n$$\n$|\\cos(\\theta)|$ 的最大值为 $1$。对于 $x \\in [0, L]$，项 $|\\cos(\\pi x/L)|$ 在 $x=0$ 和 $x=L$ 处达到其最大值 $1$。函数 $|\\tanh(z)|$ 对于 $z \\ge 0$ 是单调递增的。对于 $y \\in [0, L]$，项 $|\\tanh(y/\\lambda)|$ 在 $y$ 的最大可能值处，即 $y=L$ 处，达到最大。因此，$|v|$ 的最大值为：\n$$\n\\max|v| = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{L}{\\lambda}\\right) \\cdot (1) = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{L}{\\lambda}\\right)\n$$\n我们现在代入给定的参数值：$U_{0} = 1.0$ 米/秒，$L=1.0\\times 10^{6}$ 米，以及 $\\lambda=1.0\\times 10^{5}$ 米。\n双曲正切函数的自变量为 $L/\\lambda = (1.0\\times 10^{6}) / (1.0\\times 10^{5}) = 10$。\n$$\n\\max|v| = \\frac{\\pi \\cdot (1.0) \\cdot (1.0\\times 10^{5})}{1.0\\times 10^{6}}\\,\\tanh(10) = 0.1\\,\\pi\\,\\tanh(10) \\text{ 米/秒}\n$$\n$\\tanh(10)$ 的值非常接近 $1$。具体来说，$\\tanh(10) \\approx 0.99999999587$。因此，$\\max|v|$ 略小于 $0.1\\pi$。\n$\\max|v| \\approx 0.1 \\times 3.14159 \\approx 0.31416$ 米/秒。\n\n现在我们可以计算两个时间步长约束。给定 $\\Delta x = \\Delta y = 5.0 \\times 10^{3}$ 米。\n来自纬向速度的约束是：\n$$\n\\Delta t_x = \\frac{\\Delta x}{\\max|u|} = \\frac{5.0 \\times 10^{3} \\text{ 米}}{U_{0}} = \\frac{5.0 \\times 10^{3}}{1.0} \\text{ 秒} = 5000 \\text{ 秒}\n$$\n来自经向速度的约束是：\n$$\n\\Delta t_y = \\frac{\\Delta y}{\\max|v|} = \\frac{5.0 \\times 10^{3} \\text{ 米}}{0.1\\,\\pi\\,\\tanh(10) \\text{ 米/秒}} \\approx \\frac{5000}{0.314159} \\text{ 秒} \\approx 15915.5 \\text{ 秒}\n$$\n最大允许时间步长 $\\Delta t_{\\mathrm{max}}$ 必须同时满足这两个条件，所以它是这两个值的最小值：\n$$\n\\Delta t_{\\mathrm{max}} = \\min(\\Delta t_x, \\Delta t_y) = \\min(5000 \\text{ 秒}, 15915.5 \\text{ 秒}) = 5000 \\text{ 秒}\n$$\n问题要求答案四舍五入到四位有效数字。数值 $5000$ 可以写成 $5.000 \\times 10^{3}$，这有四位有效数字。因此，数值 $5000$ 已经达到了所需的精度。\n最大允许时间步长是 $5000$ 秒。",
            "answer": "$$\n\\boxed{5000}\n$$"
        },
        {
            "introduction": "一个可靠的数值模型必须严格遵守基本的物理守恒定律，例如盐度和热量的守恒。此项实践将理论与实践紧密结合，引导你从连续介质力学的基本方程出发，推导全局守恒积分关系。接下来，你将把这一理论知识转化为一套可测试的初始化检查程序，以验证模型在自转调整（spin-up）过程中，总盐度等示踪剂总量是否守恒，这是评估模型长期积分稳定性和保真度的核心技能。",
            "id": "3799434",
            "problem": "考虑一个三维海洋区域，其中包含一种运动的流体，该流体携带一种在时间 $t=0$ 初始化的盐示踪剂。设质量分数盐度为 $S(\\mathbf{x},t)$（无量纲），原位密度为 $\\rho(\\mathbf{x},t)$（单位：$\\mathrm{kg}\\,\\mathrm{m}^{-3}$），速度场为 $\\mathbf{u}(\\mathbf{x},t)$（单位：$\\mathrm{m}\\,\\mathrm{s}^{-1}$）。设扩散盐通量为 $\\mathbf{J}_s(\\mathbf{x},t)$（单位：$\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$）。假设盐遵循基于基本连续介质力学的局部守恒定律：盐质量密度 $q(\\mathbf{x},t) \\equiv \\rho(\\mathbf{x},t) S(\\mathbf{x},t)$ 的守恒方程由平流和扩散的平衡给出，边界上可能存在外部源。该区域由一个封闭表面界定，其向外单位法向量为 $\\mathbf{n}$。\n\n任务1（推导）：从盐质量密度 $q(\\mathbf{x},t)$ 的局部守恒定律出发，利用雷诺输运定理和散度定理，推导一个全局积分关系式，将区域内总盐质量的时间变化率与通过边界的法向盐通量的面积分联系起来。清晰地陈述在何种边界条件假设下（例如，对于没有外部源的封闭海盆，法向速度为零且扩散通量为零），总盐质量的全局趋势必须为零。\n\n任务2（初始化检查）：提出一套计算海洋学模型应满足的初始化检查，以确保在向平衡态进行“spin-up”（预积分）期间，封闭海盆中总盐质量的漂移为零。您的检查应基于物理原理，并可从离散的模型场进行测试。至少应包括：\n- 一项检查，确保在封闭海盆中，对边界和时间积分的总外部盐通量小到可以忽略不计。\n- 一项检查，确保在指定容差范围内，全局盐质量的变化等于时间积分的总外部盐通量。\n- 一项场有效性检查（$S$ 和 $\\rho$ 的值应为有限值且在物理上合理的范围内）。\n为这些检查定义一个相对容差 $\\epsilon$，并解释应如何应用它。\n\n任务3（计算验证）：在一个程序中实现初始化检查，该程序用于评估几个离散的测试用例。对于每个测试用例，给定以下数据：\n- 一组体积单元，其体积为 $V_i$（单位：$\\mathrm{m}^3$）、密度为 $\\rho_i$（单位：$\\mathrm{kg}\\,\\mathrm{m}^{-3}$）、盐度为 $S_i$（无量纲质量分数）。\n- 一组边界网格面，其面积为 $A_j$（单位：$\\mathrm{m}^2$）。\n- 一个时间步长 $\\Delta t$（单位：$\\mathrm{s}$），以及在每个边界网格面 $j$ 上，离散时间 $n=0,\\dots,N-1$ 的单位面积盐质量通量序列 $F_{S,j}^{(n)}$（单位：$\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$），其中正的 $F_{S,j}^{(n)}$ 表示盐进入区域。\n- 预积分（spin-up）后报告的最终总盐质量 $M_{\\mathrm{model}}$（单位：$\\mathrm{kg}$）。\n\n程序必须计算初始总盐质量 $M_0 = \\sum_i \\rho_i S_i V_i$、时间积分的外部盐质量输入 $\\Delta M_{\\mathrm{ext}} = \\sum_{n=0}^{N-1} \\Delta t \\sum_j F_{S,j}^{(n)} A_j$ 和收支残差 $R = M_{\\mathrm{model}} - M_0 - \\Delta M_{\\mathrm{ext}}$（单位：$\\mathrm{kg}$）。对于没有外部源的封闭海盆，要求 $\\Delta M_{\\mathrm{ext}}$ 小到可以忽略不计。使用相对容差 $\\epsilon = 10^{-9}$（无量纲），如果 $\\lvert R \\rvert \\le \\epsilon \\max(M_0,1)$ 并且（对于封闭海盆）$\\lvert \\Delta M_{\\mathrm{ext}} \\rvert \\le \\epsilon \\max(M_0,1)$，且所有场均为有限值，满足 $0 \\le S_i \\le 1$ 和 $\\rho_i  0$，则声明测试通过。所有质量单位用 $\\mathrm{kg}$ 表示，时间单位用 $\\mathrm{s}$ 表示。\n\n测试套件：\n- 用例1（理想情况，封闭海盆）：$V = [10^8,\\,1.2\\times 10^8,\\,0.8\\times 10^8]$ $\\mathrm{m}^3$，$\\rho = [1025,\\,1025,\\,1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$S = [0.035,\\,0.035,\\,0.035]$，边界面积 $A = [2\\times 10^6,\\,3\\times 10^6]$ $\\mathrm{m}^2$，时间步长 $\\Delta t = 3600$ $\\mathrm{s}$，$N=24$，通量 $F_{S,j}^{(n)}=0$ 对所有 $j,n$ 成立，封闭海盆标志为真，且 $M_{\\mathrm{model}}=M_0$。\n- 用例2（可变场，封闭海盆）：$V = [2.0\\times 10^8,\\,1.5\\times 10^8]$ $\\mathrm{m}^3$，$\\rho = [1020,\\,1030]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$S = [0.034,\\,0.036]$，边界面积 $A = [1\\times 10^6]$ $\\mathrm{m}^2$，$\\Delta t = 1800$ $\\mathrm{s}$，$N=10$，通量 $F_{S,j}^{(n)}=0$，封闭海盆标志为真，且 $M_{\\mathrm{model}}=M_0$。\n- 用例3（封闭海盆中的错误外部源）：$V = [10^7]$ $\\mathrm{m}^3$，$\\rho = [1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$S = [0.035]$，边界面积 $A = [10^5]$ $\\mathrm{m}^2$，$\\Delta t = 100$ $\\mathrm{s}$，$N=1000$，通量 $F_{S,j}^{(n)} = [10^{-5}]$ $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$ 对所有 $n$ 成立，封闭海盆标志为真，且 $M_{\\mathrm{model}}=M_0$。\n- 用例4（边界容差边缘情况，封闭海盆）：$V = [10^9]$ $\\mathrm{m}^3$，$\\rho = [1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$S = [0.035]$，边界面积 $A = [10^5]$ $\\mathrm{m}^2$，$\\Delta t = 3600$ $\\mathrm{s}$，$N=1$，通量 $F_{S,j}^{(n)}=0$，封闭海盆标志为真，且 $M_{\\mathrm{model}}$ 等于 $M_0(1+\\epsilon)$，其中 $M_0$ 由您的程序根据提供的场计算得出。\n- 用例5（无效初始化，封闭海盆）：$V = [5\\times 10^8,\\,5\\times 10^8]$ $\\mathrm{m}^3$，$\\rho = [1025,\\,1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$S = [0.035,\\,\\text{非数值}]$，边界面积 $A = [10^6]$ $\\mathrm{m}^2$，$\\Delta t = 3600$ $\\mathrm{s}$，$N=5$，通量 $F_{S,j}^{(n)}=0$，封闭海盆标志为真，且任意 $M_{\\mathrm{model}}$（该用例应因无效的 $S$ 而失败）。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，“[result1,result2,result3,result4,result5]”），每个结果都是一个布尔值，指示相应的测试用例是否通过了所有初始化检查。",
            "solution": "所提出的问题是计算海洋学中一个明确定义的练习，要求应用连续介质力学的基本原理来验证模拟的数值完整性。任务从连续场理论逻辑地进展到离散数值检查。\n\n**任务1：全局盐守恒定律的推导**\n\n在流体体积内，像盐这样的示踪剂的守恒由一个局部守恒定律控制，该定律平衡了示踪剂质量密度的局部变化率与其通量的散度。设盐质量密度为 $q(\\mathbf{x},t) = \\rho(\\mathbf{x},t) S(\\mathbf{x},t)$，其中 $\\rho$ 是原位流体密度， $S$ 是盐的无量纲质量分数。盐质量的总通量 $\\mathbf{F}_q(\\mathbf{x},t)$ 是平流通量和扩散通量之和。平流通量表示由流体整体运动携带的盐，而扩散通量表示由分子或湍流混合引起的输运。平流通量由 $q\\mathbf{u} = \\rho S \\mathbf{u}$ 给出，其中 $\\mathbf{u}(\\mathbf{x},t)$ 是流体速度。扩散通量由 $\\mathbf{J}_s(\\mathbf{x},t)$ 给出。因此，总盐通量为 $\\mathbf{F}_q = \\rho S \\mathbf{u} + \\mathbf{J}_s$。\n\n盐质量的局部守恒定律，或称连续性方程，其微分形式表示为：\n$$\n\\frac{\\partial q}{\\partial t} + \\nabla \\cdot \\mathbf{F}_q = 0\n$$\n代入 $q$ 和 $\\mathbf{F}_q$ 的表达式，我们有：\n$$\n\\frac{\\partial (\\rho S)}{\\partial t} + \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) = 0\n$$\n为了获得整个海洋区域（由体积 $\\Omega$ 表示）的全局守恒关系，我们将此局部守恒定律在 $\\Omega$ 上积分：\n$$\n\\int_\\Omega \\frac{\\partial (\\rho S)}{\\partial t} \\,dV + \\int_\\Omega \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\,dV = 0\n$$\n我们分别分析每一项。区域中的总盐质量由体积积分 $M_s(t) = \\int_\\Omega \\rho S \\,dV$ 给出。对于一个固定的（欧拉）控制体积 $\\Omega$，时间导数可以移到积分符号之外（这是雷诺输运定理在静止区域上的应用，也称为莱布尼茨积分法则）：\n$$\n\\frac{d M_s}{dt} = \\frac{d}{dt} \\int_\\Omega \\rho S \\,dV = \\int_\\Omega \\frac{\\partial (\\rho S)}{\\partial t} \\,dV\n$$\n积分守恒定律中的第二项可以使用散度定理转换为一个边界面积分，该定理表明 $\\int_\\Omega \\nabla \\cdot \\mathbf{F} \\,dV = \\oint_{\\partial\\Omega} \\mathbf{F} \\cdot \\mathbf{n} \\,dA$，其中 $\\partial\\Omega$ 是区域的封闭边界面，$\\mathbf{n}$ 是向外的单位法向量。应用此定理可得：\n$$\n\\int_\\Omega \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\,dV = \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA\n$$\n这个边界面积分表示离开该区域的盐质量输运的净速率，即通量。\n\n将这两个结果代回到积分守恒方程中，得到全局积分关系式：\n$$\n\\frac{d M_s}{dt} + \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA = 0\n$$\n该方程表明，区域内总盐质量的时间变化率等于穿过其边界的净盐通量的负值。整理后，我们可以说质量增加的速率等于进入区域的净通量：\n$$\n\\frac{d M_s}{dt} = - \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA\n$$\n为了使总盐质量的全局趋势为零，即 $\\frac{d M_s}{dt} = 0$，总盐质量 $M_s$ 必须守恒。这要求净边界通量为零：\n$$\n\\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA = 0\n$$\n这个条件在“没有外部源的封闭海盆”中物理上是实现的。这样的系统在盐输运方面与周围环境隔离。确保这一点的标准边界条件是：\n1.  **不可渗透边界**：流体不能穿过边界，这意味着在边界各处速度的法向分量为零：$\\mathbf{u} \\cdot \\mathbf{n} = 0$ on $\\partial\\Omega$。\n2.  **零扩散通量**：没有盐通过边界进行扩散交换，这意味着扩散通量的法向分量为零：$\\mathbf{J}_s \\cdot \\mathbf{n} = 0$ on $\\partial\\Omega$。\n\n在这两个假设下，边界面积分中的两项都消失，从而导致 $\\frac{d M_s}{dt} = 0$ 和总盐质量守恒。\n\n**任务2：基于原理的初始化检查**\n\n任何有效的数值海洋模型都必须遵守上述推导出的原理。在模型的“spin-up”（预积分）期间，即从初始状态向动态一致的平衡态调整的过程中，验证质量守恒至关重要。我们为离散化模型提出了三个可测试的、基于原理的检查。\n\n1.  **场有效性与物理真实性检查：** 模型的初始状态必须是物理上合理的。这是在执行任何守恒检查之前的基本先决条件。对于每个离散单元 $i$：\n    -   所有提供的数据场（$V_i, \\rho_i, S_i$等）必须是有限数值（不是 `NaN` 或 `infinity`）。\n    -   盐度 $S_i$ 作为质量分数，必须在物理有效范围 $0 \\le S_i \\le 1$ 内。\n    -   密度 $\\rho_i$ 必须为正，即 $\\rho_i  0$。同样，单元体积 $V_i$、边界面面积 $A_j$ 和时间步长 $\\Delta t$ 都必须为正。\n\n2.  **封闭海盆通量检查：** 此检查验证被指定为“封闭海盆”的模型是否正确配置为零净边界通量。在模拟时间 $N\\Delta t$ 内添加到区域的总外部盐质量通过在时间和空间上离散化通量积分来计算：\n    $$ \\Delta M_{\\mathrm{ext}} = \\sum_{n=0}^{N-1} \\Delta t \\sum_j F_{S,j}^{(n)} A_j $$\n    其中 $F_{S,j}^{(n)}$ 是在时间步 $n$ 通过边界面 $j$ 进入区域的指定单位面积盐质量通量。对于一个真正的封闭海盆，$\\Delta M_{\\mathrm{ext}}$ 应精确为零。在数值计算中，我们要求它相对于总盐质量小到可以忽略不计。该检查使用相对容差 $\\epsilon$ 来表述：\n    $$ |\\Delta M_{\\mathrm{ext}}| \\le \\epsilon \\cdot \\max(|M_0|, 1) $$\n    其中 $M_0 = \\sum_i \\rho_i S_i V_i$ 是初始总盐质量。项 $\\max(|M_0|, 1)$ 提供了一个稳健的参考尺度，防止在 $M_0$ 为零或非常小时出现问题。\n\n3.  **全局盐质量收支闭合检查：** 此检查直接验证任务1中推导的离散全局守恒定律。从初始状态到最终状态的总盐质量变化必须等于通过边界进入的总质量。\n    -   初始总盐质量为 $M_0 = \\sum_i \\rho_i S_i V_i$。\n    -   模型报告的最终总盐质量为 $M_{\\mathrm{model}}$。\n    -   通过外部通量添加的总质量是如上定义的 $\\Delta M_{\\mathrm{ext}}$。\n    -   假设完美守恒和正确的外部强迫，预期的最终质量为 $M_0 + \\Delta M_{\\mathrm{ext}}$。\n    -   收支残差 $R = M_{\\mathrm{model}} - (M_0 + \\Delta M_{\\mathrm{ext}})$ 表示由于数值方案（例如，由于平流算法）在区域内被人为创造或销毁的总盐质量。这个残差通常被称为数值漂移。\n    -   对于一个数值上守恒的模型，这个残差必须小到可以忽略不计。检查如下：\n    $$ |R| \\le \\epsilon \\cdot \\max(|M_0|, 1) $$\n    通过此测试证实了模型的内部动力学在指定的容差 $\\epsilon$ 内保守示踪剂。失败则表明模型的数值实现存在缺陷。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_check(V, rho, S, A, dt, N, F_S, is_closed_basin, M_model_val):\n    \"\"\"\n    Performs initialization checks for a single test case.\n\n    Args:\n        V (np.ndarray): Array of cell volumes [m^3].\n        rho (np.ndarray): Array of cell densities [kg m^-3].\n        S (np.ndarray): Array of cell salinities (dimensionless).\n        A (np.ndarray): Array of boundary face areas [m^2].\n        dt (float): Time step [s].\n        N (int): Number of time steps.\n        F_S (np.ndarray): Array of boundary salt fluxes [kg m^-2 s^-1]\n                        of shape (N, num_faces). Positive is into domain.\n        is_closed_basin (bool): Flag indicating if it's a closed basin.\n        M_model_val (float or str): Reported final total salt mass [kg].\n                                    Can be a special string for case 4.\n\n    Returns:\n        bool: True if all checks pass, False otherwise.\n    \"\"\"\n    epsilon = 1e-9\n\n    # --- 1. Field Sanity and Physical Realism Check ---\n    all_fields = [V, rho, S, A, dt, N, F_S]\n    # Check for NaN or Inf in all numerical inputs\n    if any(np.any(np.isinf(field)) or np.any(np.isnan(field)) for field in all_fields):\n        return False\n    # Check positivity and bounds for relevant fields\n    if not (np.all(V > 0) and np.all(rho > 0) and np.all(A > 0) and dt > 0 and N >= 0):\n        return False\n    if not (np.all(S >= 0) and np.all(S = 1)):\n        return False\n\n    # --- 2. Calculations for Budget and Flux Checks ---\n\n    # Compute initial total salt mass M_0\n    M_0 = np.sum(rho * S * V)\n    \n    # Handle dynamic M_model for case 4\n    if isinstance(M_model_val, str) and M_model_val == 'M0*(1+epsilon)':\n      M_model = M_0 * (1 + epsilon)\n    else:\n      M_model = M_model_val\n      \n    # Check for NaN/Inf in M_model as well\n    if np.isinf(M_model) or np.isnan(M_model):\n        return False\n    \n    # Compute time-integrated external salt mass input Delta_M_ext\n    # Sum fluxes over all boundary faces for each time step\n    total_flux_per_timestep = np.sum(F_S * A, axis=1)\n    # Sum over all time steps and multiply by dt\n    delta_M_ext = dt * np.sum(total_flux_per_timestep)\n\n    # Compute budget residual R\n    R = M_model - M_0 - delta_M_ext\n\n    # --- 3. Tolerance Checks ---\n\n    # Establish the reference mass scale for relative tolerance\n    mass_scale = max(abs(M_0), 1.0)\n    \n    # Check 3a: Budget Closure Check\n    # The budget residual must be within tolerance.\n    is_budget_ok = abs(R) = epsilon * mass_scale\n    if not is_budget_ok:\n        return False\n\n    # Check 3b: Closed Basin Flux Check\n    # If it's a closed basin, external fluxes must be negligible.\n    if is_closed_basin:\n        is_flux_ok = abs(delta_M_ext) = epsilon * mass_scale\n        if not is_flux_ok:\n            return False\n            \n    # If all checks passed\n    return True\n\ndef solve():\n    \"\"\"\n    Main function to define test cases and run the checks.\n    \"\"\"\n    \n    # Define test cases based on the problem description\n    test_cases = [\n        # Case 1: Happy path, closed basin\n        {'V': np.array([1e8, 1.2e8, 0.8e8]),\n         'rho': np.array([1025.0, 1025.0, 1025.0]),\n         'S': np.array([0.035, 0.035, 0.035]),\n         'A': np.array([2e6, 3e6]),\n         'dt': 3600.0, 'N': 24,\n         'F_S': np.zeros((24, 2)),\n         'is_closed_basin': True,\n         'M_model_val': 1.07625e10\n        },\n        # Case 2: Variable fields, closed basin\n        {'V': np.array([2.0e8, 1.5e8]),\n         'rho': np.array([1020.0, 1030.0]),\n         'S': np.array([0.034, 0.036]),\n         'A': np.array([1e6]),\n         'dt': 1800.0, 'N': 10,\n         'F_S': np.zeros((10, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 1.2498e10\n        },\n        # Case 3: Erroneous external source in closed basin\n        {'V': np.array([1e7]),\n         'rho': np.array([1025.0]),\n         'S': np.array([0.035]),\n         'A': np.array([1e5]),\n         'dt': 100.0, 'N': 1000,\n         'F_S': np.full((1000, 1), 1e-5),\n         'is_closed_basin': True,\n         'M_model_val': 3.5875e8 # M_model = M_0 in this case\n        }, \n        # Case 4: Boundary tolerance edge, closed basin\n        # M_model is dynamically calculated based on M_0 for this case.\n        {'V': np.array([1e9]),\n         'rho': np.array([1025.0]),\n         'S': np.array([0.035]),\n         'A': np.array([1e5]),\n         'dt': 3600.0, 'N': 1,\n         'F_S': np.zeros((1, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 'M0*(1+epsilon)' \n        },\n        # Case 5: Invalid initialization (NaN in S)\n        {'V': np.array([5e8, 5e8]),\n         'rho': np.array([1025.0, 1025.0]),\n         'S': np.array([0.035, np.nan]),\n         'A': np.array([1e6]),\n         'dt': 3600.0, 'N': 5,\n         'F_S': np.zeros((5, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 1.0 # Arbitrary value, should fail before this is used\n        }\n    ]\n    \n    # Adjust M_model for case 1 to be exactly M0 without pre-calculating it by hand\n    case1 = test_cases[0]\n    case1['M_model_val'] = np.sum(case1['rho'] * case1['S'] * case1['V'])\n    \n    # Adjust M_model for case 2 to be exactly M0 without pre-calculating it by hand\n    case2 = test_cases[1]\n    case2['M_model_val'] = np.sum(case2['rho'] * case2['S'] * case2['V'])\n\n    # Adjust M_model for case 3 to be exactly M0\n    case3 = test_cases[2]\n    case3['M_model_val'] = np.sum(case3['rho'] * case3['S'] * case3['V'])\n\n    results = []\n    for case in test_cases:\n        result = run_check(\n            case['V'], case['rho'], case['S'], case['A'], \n            case['dt'], case['N'], case['F_S'], \n            case['is_closed_basin'], case['M_model_val']\n        )\n        results.append(result)\n\n    # Print the final results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "确定模型何时完成自转调整并达到统计平衡，是进行有效科学分析的前提，但这通常需要比简单监测总体能量更复杂的诊断方法。本项高级实践将指导你设计并实现一个基于能谱分析的精细化平衡判据。通过为合成速度场应用这一判据，你将学习如何通过评估动能谱在不同空间尺度上的稳定性和中尺度能量的波动性，来定量地判断模型是否已进入一个有意义的、统计上稳定的状态，这是在海洋模型分析中一项至关重要的高级技能。",
            "id": "3799427",
            "problem": "你的任务是为二维海洋模型速度场时间序列设计并实现一个谱均衡准则，用于诊断模型何时完成“起转”（spin up）并达到均衡状态。该准则必须基于跨空间尺度的动能谱的稳定化和中尺度方差的平台期。你的程序必须为几种测试场景生成具有受控谱特征的合成速度场，然后将该准则应用于每个场景，以返回一个布尔值，指示是否达到均衡。\n\n使用以下基本原理来构建准则及其算法实现。\n\n1. 二维流中的单位质量动能由速度分量 $u(x,y,t)$ 和 $v(x,y,t)$ 定义为 $K(t) = \\frac{1}{2} \\langle u(x,y,t)^2 + v(x,y,t)^2 \\rangle$，其中 $\\langle \\cdot \\rangle$ 表示在整个域上的空间平均。\n\n2. 对于一个尺寸为 $L_x \\times L_y$ 的周期性域，在一个 $N_x \\times N_y$ 点的均匀网格上进行离散化，网格间距为 $d_x$ 和 $d_y$（单位：米），离散傅里叶变换产生波数 $k_x = 2\\pi m / L_x$ 和 $k_y = 2\\pi n / L_y$，其中 $m$ 和 $n$ 是由频率网格给出的整数。离散帕塞瓦尔关系确保 $u^2$ 的空间平均值等于傅里叶振幅平方和乘以适当的归一化因子。\n\n3. 各向同性一维动能谱 $E(k,t)$ 是通过按波数大小 $k = \\sqrt{k_x^2 + k_y^2}$ 对二维谱动能密度进行分箱，并在环带上求和得到的。单位质量总动能满足 $\\int_0^{k_{\\max}} E(k,t)\\,dk \\approx \\frac{1}{2}\\langle u^2 + v^2 \\rangle$，误差取决于离散分箱的近似程度。\n\n4. 中尺度波段由长度尺度在 $L_{\\min}$ 和 $L_{\\max}$ 之间定义，映射到波数 $k_{\\min}^{\\text{meso}} = \\frac{2\\pi}{L_{\\max}}$ 和 $k_{\\max}^{\\text{meso}} = \\frac{2\\pi}{L_{\\min}}$。时间 $t$ 的中尺度方差是波段积分动能 $V_{\\text{meso}}(t) = \\sum_{k \\in [k_{\\min}^{\\text{meso}}, k_{\\max}^{\\text{meso}}]} E(k,t)$，通过离散箱计算。\n\n构建以下谱均衡准则。\n\n- 跨尺度的谱稳定化：计算两个时间平均谱，$\\overline{E}_1(k)$ 是在较早的时间窗口上的平均，$\\overline{E}_2(k)$ 是在较晚的时间窗口上的平均，两个窗口的长度均为 $W$ 个时间步。定义相对谱变化度量\n$$\nD_{\\text{spec}} = \\frac{\\sqrt{\\sum_{k} \\left(\\overline{E}_2(k) - \\overline{E}_1(k)\\right)^2}}{\\sqrt{\\sum_{k} \\overline{E}_2(k)^2}}.\n$$\n如果 $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$，则表示谱已稳定，其中 $\\varepsilon_{\\text{spec}}$ 是一个以小数形式给出的预设容差。\n\n- 中尺度平台期：在同一个较晚的窗口内，评估中尺度方差的变异系数\n$$\n\\mathrm{CV}_{\\text{meso}} = \\frac{\\mathrm{std}\\left(V_{\\text{meso}}(t)\\right)}{\\mathrm{mean}\\left(V_{\\text{meso}}(t)\\right)},\n$$\n其中标准差和均值是在最后 $W$ 个时间步上计算的。如果 $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$，则表示出现平台期，其中 $\\varepsilon_{\\text{cv}}$ 是一个以小数形式给出的预设容差。\n\n当且仅当两个条件都满足时，宣布模型达到均衡。\n\n用于测试的合成速度场生成必须按如下方式构建。\n\n- 在每个时间 $t$，生成物理域中均值为零的随机实值场 $u_0(x,y,t)$ 和 $v_0(x,y,t)$，将它们转换到傅里叶空间，乘以一个非负的、径向对称的谱滤波器 $F(k,t)$，然后进行逆变换以获得 $u(x,y,t)$ 和 $v(x,y,t)$。这可以保持实值性并施加一个受控的动能谱。\n\n- 谱滤波器必须是隔离中尺度能量并包含物理上合理的背景分量的叠加：\n$$\nF(k,t) = a_{\\text{meso}}(t)\\, \\exp\\left(-\\frac{(k - k_0)^2}{2\\sigma_k^2}\\right) + a_{\\text{bg}}\\,\\exp\\left(-\\left(\\frac{k}{k_{\\text{bg}}}\\right)^2\\right) + a_{\\text{small}},\n$$\n其中 $k_0$ 是中尺度波段中心，$\\sigma_k$ 是波段宽度，$a_{\\text{bg}}$ 控制大尺度背景，$k_{\\text{bg}}$ 是一个大尺度截止波数，$a_{\\text{small}}$ 是一个小尺度分量。时间依赖性 $a_{\\text{meso}}(t)$ 用于区分不同场景，并且必须被选择用来创建均衡和非均衡情况。\n\n单位与离散化要求。\n\n- 速度 $u$ 和 $v$ 必须以米/秒为单位处理。长度必须以米为单位。时间必须以秒为单位。波数 $k$ 的单位是弧度/米。各向同性谱 $E(k)$ 和中尺度方差 $V_{\\text{meso}}(t)$ 的单位必须是 $\\mathrm{m}^2/\\mathrm{s}^2$。\n\n算法任务。\n\n- 实现具有正确归一化的离散傅里叶变换，以便帕塞瓦尔关系能够一致地连接空间能量和谱能量。\n- 通过在 $k$-环带中对二维谱动能密度进行分箱来构建各向同性谱，箱宽等于最小波数增量。\n- 计算谱稳定化度量 $D_{\\text{spec}}$ 和中尺度平台期度量 $\\mathrm{CV}_{\\text{meso}}$。\n- 为每个测试用例返回一个布尔值，指示是否两个条件都满足。\n\n测试套件与参数。\n\n你必须精确实现以下三个测试用例。在所有情况下，设置 $N_x = N_y = 128$，$d_x = d_y = 5\\times 10^3$ (米)，$L_x = L_y = N_x d_x$，$k_0 = \\frac{2\\pi}{5\\times 10^4}$，$\\sigma_k = 4\\times 10^{-5}$，$a_{\\text{bg}} = 0.3$，$k_{\\text{bg}} = \\frac{2\\pi}{2\\times 10^5}$，$a_{\\text{small}} = 0.08$，$L_{\\min} = 1\\times 10^4$ (米)，以及 $L_{\\max} = 1\\times 10^5$ (米)。对于所有情况，时间步长为 $d_t = 3.6\\times 10^3$ (秒)。所有阈值必须是小数：$\\varepsilon_{\\text{spec}} = 0.1$ 和 $\\varepsilon_{\\text{cv}} = 0.05$。\n\n- 情况 A (均衡)：$T = 40$，窗口长度 $W = 12$，且 $a_{\\text{meso}}(t) = a_{\\max} \\left(1 - e^{-t/\\tau}\\right)$，其中 $a_{\\max} = 3.0$ 且 $\\tau = 10$。这会产生起转然后饱和。\n\n- 情况 B (临界但均衡)：$T = 40$，$W = 12$，且 $a_{\\text{meso}}(t) = a_{\\max} \\left(1 - e^{-t/\\tau}\\right)\\left(1 + \\delta \\sin\\left(\\frac{2\\pi t}{T_{\\text{osc}}}\\right)\\right)$，其中 $a_{\\max} = 2.5$，$\\tau = 10$，$\\delta = 0.03$，以及 $T_{\\text{osc}} = 12$。这会在饱和状态周围增加小的准周期性变化。\n\n- 情况 C (非均衡)：$T = 40$，$W = 12$，且 $a_{\\text{meso}}(t) = a_0 + r t$，其中 $a_0 = 0.05$ 且 $r = 0.05$。这会产生持续增长而没有饱和。\n\n最终输出格式。\n\n你的程序应生成一行输出，其中包含用方括号括起来的、以逗号分隔的结果列表，顺序与上述测试用例相同。例如，如果结果是 true、false 和 true，则输出必须是 \"[True,False,True]\"。",
            "solution": "用户提供了一个定义明确的计算海洋学问题，要求我设计、实现并应用一个用于数值模型的谱均衡准则。该问题在科学上是合理的，在算法上是详细的，并且所有参数都已指定。我将首先详细阐述理论和算法框架，然后进行实现。\n\n### 1. 基本原理\n问题的核心在于诊断湍流速度场的统计均衡，这种状态在海洋模型中通常被称为“起转”（spin-up）。这种状态不是静态的，而是统计平稳的，意味着其统计特性（如平均动能及其在不同空间尺度上的分布）不再表现出长期趋势。所提供的方法论基于应用于流体动力学的傅里叶分析和统计力学原理。\n\n- **动能与帕塞瓦尔定理**：在二维域中，单位质量总动能由 $K(t) = \\frac{1}{2} \\langle u(x,y,t)^2 + v(x,y,t)^2 \\rangle$ 给出，其中 $\\langle \\cdot \\rangle$ 表示空间平均。对于一个大小为 $N_x \\times N_y$ 的离散网格，这表示为 $K(t) = \\frac{1}{2 N_x N_y} \\sum_{i,j} (u_{ij}^2 + v_{ij}^2)$。帕塞瓦尔定理在傅里叶空间中提供了等效的表示。设 $\\hat{u}$ 和 $\\hat{v}$ 分别是 $u$ 和 $v$ 的离散傅里叶变换。根据像NumPy这样的库所使用的归一化，该定理表明 $\\sum_{i,j} |f_{ij}|^2 = \\frac{1}{N_x N_y} \\sum_{m,n} |\\hat{f}_{mn}|^2$。应用此定理，动能为：\n$$\nK(t) = \\frac{1}{2(N_x N_y)^2} \\sum_{m,n} (|\\hat{u}_{mn}(t)|^2 + |\\hat{v}_{mn}(t)|^2)\n$$\n这个方程建立了物理空间能量与其谱分布之间的基本联系。$E_{mn} = \\frac{1}{2(N_x N_y)^2} (|\\hat{u}_{mn}(t)|^2 + |\\hat{v}_{mn}(t)|^2)$ 项可以被解释为与单个傅里叶模式 $(m,n)$ 相关的动能。\n\n- **各向同性动能谱 $E(k,t)$**：在许多湍流系统中，能量分布被假定为各向同性，即仅取决于波数向量的大小，$k = \\sqrt{k_x^2 + k_y^2}$。一维谱 $E(k,t)$ 是通过将波数大小在特定范围内的所有二维模式 $(k_x, k_y)$ 的能量聚合起来构建的。我们将 $k$ 轴划分为多个箱（bin），并对所有波数大小 $k$ 落入每个箱内的模式的能量 $E_{mn}$ 求和。根据问题的规定，得到的对于箱 $i$ 的分箱谱 $E(k_i, t)$ 具有能量单位 $\\mathrm{m}^2/\\mathrm{s}^2$，总动能约等于所有箱的总和，$K(t) \\approx \\sum_i E(k_i, t)$。\n\n### 2. 算法设计\n\n**步骤 2.1：域和波数网格设置**\n物理域大小为 $L_x \\times L_y$，有 $N_x \\times N_y$ 个网格点，其中 $L_x = N_x d_x$ 且 $L_y = N_y d_y$。对应的波数为 $k_x = 2\\pi m / L_x$（对于 $m \\in \\{-N_x/2, \\dots, N_x/2-1\\}$）和 $k_y = 2\\pi n / L_y$（对于 $n \\in \\{-N_y/2, \\dots, N_y/2-1\\}$）。这些可以使用像 `numpy.fft.fftfreq` 这样的函数轻松生成。然后，我们计算波数大小的二维网格 $k_{mn} = \\sqrt{k_x^2(m) + k_y^2(n)}$。\n\n**步骤 2.2：合成速度场生成**\n对于每个时间步 $t$，我们生成具有预设谱形状的速度场。\n1. 使用标准正态分布创建两个随机实值场 $u_0(x,y,t)$ 和 $v_0(x,y,t)$。通过从每个场中减去空间平均值来强制零均值。\n2. 计算它们的二维傅里叶变换，$\\hat{u}_0(k_x,k_y,t)$ 和 $\\hat{v}_0(k_x,k_y,t)$。\n3. 定义依赖于时间和尺度的谱滤波器 $F(k,t)$：\n$$\nF(k,t) = a_{\\text{meso}}(t)\\, \\exp\\left(-\\frac{(k - k_0)^2}{2\\sigma_k^2}\\right) + a_{\\text{bg}}\\,\\exp\\left(-\\left(\\frac{k}{k_{\\text{bg}}}\\right)^2\\right) + a_{\\text{small}}\n$$\n   该滤波器通过一个中尺度能量峰值（第一项）、一个大尺度背景贡献（第二项）和一个小尺度白噪声基底（第三项）来塑造谱。时间演化由 $a_{\\text{meso}}(t)$ 控制，它在不同测试用例之间变化，以模拟均衡、临界和非均衡场景。\n4. 将滤波器应用于傅里叶变换后的随机场：$\\hat{u} = \\hat{u}_0 F(k,t)$ 和 $\\hat{v} = \\hat{v}_0 F(k,t)$。\n5. 最终的速度场 $u(x,y,t)$ 和 $v(x,y,t)$ 是通过对 $\\hat{u}$ 和 $\\hat{v}$ 应用二维逆傅里叶变换得到的。由于滤波器 $F(k,t)$ 是关于 $k$ 的实对称函数，它保持了实值场的傅里叶变换的厄米对称性，因此保证了输出的实值性。\n\n**步骤 2.3：各向同性谱计算**\n对于每个时间步 $t$：\n1. 计算二维动能谱密度矩阵：$E_{2D}(k_x, k_y, t) = \\frac{1}{2(N_x N_y)^2} (|\\hat{u}(k_x,k_y,t)|^2 + |\\hat{v}(k_x,k_y,t)|^2)$。\n2. 为一维谱定义箱。箱宽设置为最小波数增量，$\\Delta k = 2\\pi/L_x$。箱覆盖从 $k=0$ 到网格上最大波数的范围。\n3. 对所有波数大小 $k$ 落入每个箱内的模式 $(k_x, k_y)$，将 $E_{2D}$ 中的值求和。此操作产生各向同性分箱谱 $E(k_i, t)$。这可以使用 `scipy.stats.binned_statistic` 高效实现。\n\n**步骤 2.4：均衡准则的评估**\n在为 $t \\in [0, T-1]$ 生成谱的时间序列 $E(k_i, t)$ 后：\n1. **谱稳定化 ($D_{\\text{spec}})$**：\n   - 定义早期和晚期时间窗口。总共有 $T=40$ 个时间步，窗口长度为 $W=12$，晚期窗口涵盖时间步 $[28, 39]$，早期窗口涵盖 $[16, 27]$。\n   - 在这两个窗口上计算时间平均谱：\n     $\\overline{E}_1(k) = \\frac{1}{W}\\sum_{t=T-2W}^{T-W-1} E(k,t)$\n     $\\overline{E}_2(k) = \\frac{1}{W}\\sum_{t=T-W}^{T-1} E(k,t)$\n   - 计算相对谱变化度量：\n     $$\n     D_{\\text{spec}} = \\frac{\\sqrt{\\sum_{k} \\left(\\overline{E}_2(k) - \\overline{E}_1(k)\\right)^2}}{\\sqrt{\\sum_{k} \\overline{E}_2(k)^2}}\n     $$\n   - 谱稳定化的条件是 $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$，其中 $\\varepsilon_{\\text{spec}} = 0.1$。\n\n2. **中尺度平台期 ($\\mathrm{CV}_{\\text{meso}})$**：\n   - 首先，识别对应于中尺度波段 $[k_{\\min}^{\\text{meso}}, k_{\\max}^{\\text{meso}}]$ 的波数箱，其中 $k_{\\min}^{\\text{meso}} = 2\\pi/L_{\\max}$ 和 $k_{\\max}^{\\text{meso}} = 2\\pi/L_{\\min}$。\n   - 对于每个时间步 $t$，通过对这些箱上的谱能量求和来计算中尺度方差：$V_{\\text{meso}}(t) = \\sum_{k_i \\in \\text{mesoscale}} E(k_i, t)$。\n   - 使用来自晚期窗口（$t \\in [T-W, T-1]$）的 $V_{\\text{meso}}(t)$ 时间序列，计算其均值和标准差。\n   - 变异系数则为：\n     $$\n     \\mathrm{CV}_{\\text{meso}} = \\frac{\\mathrm{std}\\left(V_{\\text{meso}}(t)\\right)}{\\mathrm{mean}\\left(V_{\\text{meso}}(t)\\right)}\n     $$\n   - 出现平台期的条件是 $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$，其中 $\\varepsilon_{\\text{cv}} = 0.05$。\n\n最后，当且仅当 $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$ 和 $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$ 两个条件都满足时，模型被宣布达到均衡。对三个测试用例（A、B、C）中的每一个都重复此过程，这些用例通过 $a_{\\text{meso}}(t)$ 的函数形式来区分，分别设计用于测试均衡、临界和非均衡场景。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import binned_statistic\n\ndef solve():\n    \"\"\"\n    Designs and implements a spectral equilibration criterion for a 2D ocean model.\n    Generates synthetic velocity fields and applies the criterion to test scenarios.\n    \"\"\"\n\n    # For reproducibility of the random velocity fields\n    np.random.seed(42)\n\n    # Universal parameters\n    N_x, N_y = 128, 128\n    d_x = d_y = 5.0e3  # meters\n    L_x, L_y = N_x * d_x, N_y * d_y\n    \n    k0 = 2 * np.pi / 5.0e4\n    sigma_k = 4.0e-5\n    a_bg = 0.3\n    k_bg = 2 * np.pi / 2.0e5\n    a_small = 0.08\n    \n    L_min, L_max = 1.0e4, 1.0e5 # meters\n    k_meso_min = 2 * np.pi / L_max\n    k_meso_max = 2 * np.pi / L_min\n    \n    dt = 3.6e3  # seconds\n    T = 40  # Total number of time steps\n    W = 12  # Window length for averaging\n\n    eps_spec = 0.1\n    eps_cv = 0.05\n\n    # Define test cases\n    test_cases = [\n        {\n            \"name\": \"Case A (equilibrated)\",\n            \"a_meso_func\": lambda t: 3.0 * (1 - np.exp(-t / 10.0))\n        },\n        {\n            \"name\": \"Case B (borderline but equilibrated)\",\n            \"a_meso_func\": lambda t: 2.5 * (1 - np.exp(-t / 10.0)) * (1 + 0.03 * np.sin(2 * np.pi * t / 12.0))\n        },\n        {\n            \"name\": \"Case C (non-equilibrium)\",\n            \"a_meso_func\": lambda t: 0.05 + 0.05 * t\n        }\n    ]\n\n    results = []\n\n    # Pre-compute wavenumber grid\n    kx_1d = 2 * np.pi * np.fft.fftfreq(N_x, d=d_x)\n    ky_1d = 2 * np.pi * np.fft.fftfreq(N_y, d=d_y)\n    kx, ky = np.meshgrid(kx_1d, ky_1d, indexing='ij')\n    k_magnitude = np.sqrt(kx**2 + ky**2)\n    \n    # Define wavenumber bins for 1D spectrum\n    dk_min = 2 * np.pi / L_x\n    k_max_grid = np.max(k_magnitude)\n    k_bins = np.arange(0, k_max_grid + dk_min, dk_min)\n    k_bin_centers = (k_bins[:-1] + k_bins[1:]) / 2\n    num_k_bins = len(k_bin_centers)\n\n    for case in test_cases:\n        a_meso_func = case[\"a_meso_func\"]\n        \n        # Store time series of spectra and mesoscale variance\n        E_k_t = np.zeros((T, num_k_bins))\n        V_meso_t = np.zeros(T)\n\n        for t in range(T):\n            # 1. Generate synthetic velocity fields\n            u0 = np.random.randn(N_x, N_y)\n            v0 = np.random.randn(N_x, N_y)\n            u0 -= u0.mean()\n            v0 -= v0.mean()\n\n            u0_hat = np.fft.fft2(u0)\n            v0_hat = np.fft.fft2(v0)\n            \n            # 2. Construct and apply spectral filter\n            a_meso = a_meso_func(t)\n            F_k_t = (a_meso * np.exp(-(k_magnitude - k0)**2 / (2 * sigma_k**2)) +\n                     a_bg * np.exp(-(k_magnitude / k_bg)**2) +\n                     a_small)\n            \n            u_hat = u0_hat * F_k_t\n            v_hat = v0_hat * F_k_t\n            \n            # 3. Calculate 2D KE spectrum\n            # Factor of 0.5 for KE, (Nx*Ny)^-2 for Parseval's on FFT^2\n            E_2D = 0.5 / (N_x * N_y)**2 * (np.abs(u_hat)**2 + np.abs(v_hat)**2) \n            \n            # 4. Bin to create 1D isotropic spectrum E(k,t)\n            # The sum statistic ensures that E_k_t has units of energy (m^2/s^2)\n            E_k_t[t, :], _, _ = binned_statistic(\n                k_magnitude.flatten(), E_2D.flatten(), statistic='sum', bins=k_bins\n            )\n            \n            # 5. Calculate mesoscale variance V_meso(t)\n            meso_mask = (k_bin_centers >= k_meso_min)  (k_bin_centers = k_meso_max)\n            V_meso_t[t] = np.sum(E_k_t[t, meso_mask])\n\n        # 6. Evaluate equilibration criteria\n        \n        # Spectral stabilization metric D_spec\n        E1_bar = np.mean(E_k_t[T - 2*W : T - W, :], axis=0)\n        E2_bar = np.mean(E_k_t[T - W : T, :], axis=0)\n        \n        # Handle potential division by zero if E2_bar is all zeros\n        norm_E2 = np.sqrt(np.sum(E2_bar**2))\n        if norm_E2 > 0:\n            D_spec = np.sqrt(np.sum((E2_bar - E1_bar)**2)) / norm_E2\n        else:\n            D_spec = np.inf if np.any(E1_bar > 0) else 0.0\n\n        # Mesoscale plateau metric CV_meso\n        V_meso_later_window = V_meso_t[T - W : T]\n        mean_V_meso = np.mean(V_meso_later_window)\n        std_V_meso = np.std(V_meso_later_window)\n        \n        # Handle potential division by zero if mean is zero\n        CV_meso = std_V_meso / mean_V_meso if mean_V_meso > 0 else np.inf\n        \n        # Final decision\n        is_equilibrated = (D_spec = eps_spec) and (CV_meso = eps_cv)\n        results.append(is_equilibrated)\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}