{
    "hands_on_practices": [
        {
            "introduction": "We begin by examining the most intuitive grid structure, the Arakawa A-grid, where all variables are collocated at the same points. Through a theoretical analysis of the linearized shallow water equations, this exercise uncovers a critical flaw in this arrangement. You will demonstrate the existence of a \"computational mode\"—an unphysical, grid-scale pattern that the discrete gradient operator fails to \"see,\" leading to a complete and spurious decoupling of the pressure and velocity fields . Understanding this fundamental weakness provides the essential motivation for exploring more sophisticated grid structures.",
            "id": "3785714",
            "problem": "Consider the linearized rotating Shallow Water Equations (SWE) on an $f$-plane, linearized about a state of rest with mean depth $H$, gravitational acceleration $g$, and Coriolis parameter $f$. The continuous equations for the horizontal velocity components $u$, $v$ and the free-surface height $\\eta$ are\n$$\n\\frac{\\partial u}{\\partial t} - f v = - g \\frac{\\partial \\eta}{\\partial x}, \\quad\n\\frac{\\partial v}{\\partial t} + f u = - g \\frac{\\partial \\eta}{\\partial y}, \\quad\n\\frac{\\partial \\eta}{\\partial t} + H\\left(\\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}\\right) = 0.\n$$\nDiscretize these equations on a uniform Cartesian grid with grid spacings $\\Delta x$ and $\\Delta y$ using the Arakawa A-grid (A-grid) layout, where all prognostic variables $u_{i,j}(t)$, $v_{i,j}(t)$, and $\\eta_{i,j}(t)$ are collocated at the same grid points $(i,j)$ with $i \\in \\{0, \\dots, N_x-1\\}$ and $j \\in \\{0, \\dots, N_y-1\\}$ under doubly periodic boundary conditions. Use second-order centered differences in space to obtain a semi-discrete (continuous in time, discrete in space) system.\n\nDefine the face-normal volume fluxes across the vertical and horizontal cell faces by the arithmetic averages of the adjacent cell-centered velocities:\n$$\nQ^{x}_{i+\\frac{1}{2},j}(t) \\equiv H \\frac{u_{i+1,j}(t) + u_{i,j}(t)}{2}, \\quad\nQ^{y}_{i,j+\\frac{1}{2}}(t) \\equiv H \\frac{v_{i,j+1}(t) + v_{i,j}(t)}{2}.\n$$\n\nStarting from the fundamental continuous SWE stated above and standard centered finite differences, perform the following tasks:\n- Construct the semi-discrete A-grid SWE as explicit formulas for $\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t}$, $\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t}$, and $\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t}$ in terms of nearest-neighbor grid point values.\n- Consider the discrete checkerboard free-surface pattern $\\eta_{i,j}(t) = \\hat{\\eta} \\, (-1)^{i+j}$ with some constant amplitude $\\hat{\\eta} \\neq 0$ and initial velocities $u_{i,j}(0) = 0$, $v_{i,j}(0) = 0$ for all $i,j$. Demonstrate from the semi-discrete equations that this pattern produces no pressure-gradient forcing at any grid point, so that the velocities remain zero for all time and the face-normal fluxes $Q^{x}_{i+\\frac{1}{2},j}(t)$ and $Q^{y}_{i,j+\\frac{1}{2}}(t)$ remain zero for all time as well.\n- Interpret the temporal behavior of $\\eta_{i,j}(t)$ for this pattern as a normal mode with angular frequency $\\omega$, defined by $\\eta_{i,j}(t) = \\hat{\\eta} \\, (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t)$.\n\nWhat is the value of the discrete angular frequency $\\omega$ (in radians per second) of this checkerboard mode under the A-grid semi-discrete scheme you constructed? Express your final answer as a single exact number. No rounding is required. State your answer in radians per second as requested, but do not include units in your final boxed answer.",
            "solution": "The problem is assessed to be valid. It is self-contained, scientifically grounded in the principles of geophysical fluid dynamics and numerical methods, and well-posed. The tasks are clearly defined and build upon one another in a logically consistent manner.\n\nThe first step is to construct the semi-discrete form of the linearized rotating Shallow Water Equations (SWE) on an Arakawa A-grid. On an A-grid, all variables ($u$, $v$, $\\eta$) are collocated at the same grid points $(i,j)$. We use second-order centered finite differences for the spatial derivatives. For a generic function $\\phi(x,y)$, the discrete approximations at grid point $(i,j)$ are:\n$$\n\\left(\\frac{\\partial \\phi}{\\partial x}\\right)_{i,j} \\approx \\frac{\\phi_{i+1,j} - \\phi_{i-1,j}}{2\\Delta x}\n$$\n$$\n\\left(\\frac{\\partial \\phi}{\\partial y}\\right)_{i,j} \\approx \\frac{\\phi_{i,j+1} - \\phi_{i,j-1}}{2\\Delta y}\n$$\nApplying these operators to the given continuous SWE yields the semi-discrete system of ordinary differential equations in time for the variables at each grid point $(i,j)$:\n\nThe semi-discrete x-momentum equation is:\n$$\n\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t} - f v_{i,j} = -g \\frac{\\eta_{i+1,j} - \\eta_{i-1,j}}{2\\Delta x}\n$$\n\nThe semi-discrete y-momentum equation is:\n$$\n\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t} + f u_{i,j} = -g \\frac{\\eta_{i,j+1} - \\eta_{i,j-1}}{2\\Delta y}\n$$\n\nThe semi-discrete continuity equation is:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} + H\\left(\\frac{u_{i+1,j} - u_{i-1,j}}{2\\Delta x} + \\frac{v_{i,j+1} - v_{i,j-1}}{2\\Delta y}\\right) = 0\n$$\n\nNext, we analyze the behavior of the system for a checkerboard pattern in the free-surface height, given as $\\eta_{i,j}(t) = \\hat{\\eta} \\, (-1)^{i+j}$, where $\\hat{\\eta}$ is a non-zero constant amplitude. For this part of the analysis, the pattern is stationary. The initial conditions for velocity are $u_{i,j}(0) = 0$ and $v_{i,j}(0) = 0$ for all $(i,j)$.\n\nWe first evaluate the pressure gradient terms (the right-hand sides) of the momentum equations for this $\\eta$ field.\nFor the x-momentum equation, the pressure gradient forcing term is proportional to the difference $\\eta_{i+1,j} - \\eta_{i-1,j}$.\n$$\n\\eta_{i+1,j} = \\hat{\\eta} (-1)^{(i+1)+j} = \\hat{\\eta} (-1)^{i+j} (-1)^1 = -\\hat{\\eta} (-1)^{i+j}\n$$\n$$\n\\eta_{i-1,j} = \\hat{\\eta} (-1)^{(i-1)+j} = \\hat{\\eta} (-1)^{i+j} (-1)^{-1} = -\\hat{\\eta} (-1)^{i+j}\n$$\nTherefore, $\\eta_{i+1,j} = \\eta_{i-1,j}$, and the difference is zero:\n$$\n-g \\frac{\\eta_{i+1,j} - \\eta_{i-1,j}}{2\\Delta x} = 0\n$$\nFor the y-momentum equation, the pressure gradient forcing term is proportional to the difference $\\eta_{i,j+1} - \\eta_{i,j-1}$.\n$$\n\\eta_{i,j+1} = \\hat{\\eta} (-1)^{i+(j+1)} = \\hat{\\eta} (-1)^{i+j} (-1)^1 = -\\hat{\\eta} (-1)^{i+j}\n$$\n$$\n\\eta_{i,j-1} = \\hat{\\eta} (-1)^{i+(j-1)} = \\hat{\\eta} (-1)^{i+j} (-1)^{-1} = -\\hat{\\eta} (-1)^{i+j}\n$$\nTherefore, $\\eta_{i,j+1} = \\eta_{i,j-1}$, and the difference is zero:\n$$\n-g \\frac{\\eta_{i,j+1} - \\eta_{i,j-1}}{2\\Delta y} = 0\n$$\nThe checkerboard pattern for $\\eta$ creates no pressure gradient force in the discrete momentum equations because the second-order centered difference operator is \"blind\" to the highest frequency mode sustainable on the grid (the $2\\Delta x$ or $2\\Delta y$ Nyquist frequency).\n\nWith zero forcing, the momentum equations simplify to a homogeneous system:\n$$\n\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t} - f v_{i,j} = 0\n$$\n$$\n\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t} + f u_{i,j} = 0\n$$\nGiven the initial conditions $u_{i,j}(0) = 0$ and $v_{i,j}(0) = 0$, the unique solution to this linear system is $u_{i,j}(t) = 0$ and $v_{i,j}(t) = 0$ for all time $t$.\n\nNow we check the face-normal volume fluxes as defined in the problem:\n$$\nQ^{x}_{i+\\frac{1}{2},j}(t) = H \\frac{u_{i+1,j}(t) + u_{i,j}(t)}{2}\n$$\n$$\nQ^{y}_{i,j+\\frac{1}{2}}(t) = H \\frac{v_{i,j+1}(t) + v_{i,j}(t)}{2}\n$$\nSince $u_{i,j}(t) = 0$ and $v_{i,j}(t) = 0$ for all grid points and all time, it follows directly that $Q^{x}_{i+\\frac{1}{2},j}(t) = 0$ and $Q^{y}_{i,j+\\frac{1}{2}}(t) = 0$ for all time as well.\n\nFinally, we determine the angular frequency $\\omega$ of this checkerboard mode, interpreted as a normal mode $\\eta_{i,j}(t) = \\hat{\\eta} (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t)$.\nAs demonstrated above, if the free-surface height has a checkerboard spatial structure, the velocity field remains zero for all time, i.e., $u_{i,j}(t)=0$ and $v_{i,j}(t)=0$. Let's substitute this result into the semi-discrete continuity equation:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} + H\\left(\\frac{u_{i+1,j}(t) - u_{i-1,j}(t)}{2\\Delta x} + \\frac{v_{i,j+1}(t) - v_{i,j-1}(t)}{2\\Delta y}\\right) = 0\n$$\nSince all velocity components are zero, the divergence term is zero:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} + H\\left(\\frac{0 - 0}{2\\Delta x} + \\frac{0 - 0}{2\\Delta y}\\right) = 0\n$$\nThis simplifies the continuity equation to:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} = 0\n$$\nNow, we take the time derivative of the normal mode form for $\\eta_{i,j}(t)$:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} = \\frac{\\mathrm{d}}{\\mathrm{d}t}\\left[ \\hat{\\eta} (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t) \\right] = \\hat{\\eta} (-1)^{i+j} (-\\mathrm{i}\\omega) \\exp(-\\mathrm{i}\\omega t) = -\\mathrm{i}\\omega \\, \\eta_{i,j}(t)\n$$\nBy equating the two expressions for $\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t}$, we get:\n$$\n-\\mathrm{i}\\omega \\, \\eta_{i,j}(t) = 0\n$$\nThe problem states that the amplitude $\\hat{\\eta} \\neq 0$, which means that $\\eta_{i,j}(t)$ is not identically zero. For the equation to hold, the coefficient $-\\mathrm{i}\\omega$ must be zero.\n$$\n-\\mathrm{i}\\omega = 0 \\implies \\omega = 0\n$$\nThe angular frequency of the checkerboard mode on the Arakawa A-grid with centered differences is $0$. This means it is a stationary, non-propagating computational mode. It represents a flaw in this particular numerical scheme, as it allows for a non-trivial spatial structure in the height field to exist without any associated motion, completely decoupled from the dynamics.\nThe value of the discrete angular frequency $\\omega$ is $0$ radians per second.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "Building upon the theoretical discovery of the A-grid's spurious mode, this hands-on coding practice demonstrates the tangible consequences of this numerical artifact in a physically relevant scenario. You will set up a geostrophically balanced flow, deliberately contaminate the pressure field with the problematic checkerboard pattern, and then quantify the resulting imbalance by attempting to recover the pressure field from the velocities . This exercise provides a practical look at why such modes are detrimental and introduces numerical filtering as a common, albeit imperfect, mitigation strategy.",
            "id": "3785687",
            "problem": "Consider the linearized, inviscid, constant-depth shallow-water momentum equations under geostrophic balance on an $f$-plane, where the Coriolis parameter $f$ is constant and gravitational acceleration is $g$. The geostrophic balance states that $f \\mathbf{u} = -g \\hat{\\mathbf{k}} \\times \\nabla \\eta$, where $\\mathbf{u} = (u,v)$ is the horizontal velocity vector, $\\eta$ is the free-surface elevation, and $\\hat{\\mathbf{k}}$ is the unit vector normal to the horizontal plane. In Cartesian components this yields $-f v = -g \\, \\partial \\eta / \\partial x$ and $f u = -g \\, \\partial \\eta / \\partial y$. On a discrete, uniform Arakawa A-grid (collocated grid), all prognostic variables $u$, $v$, and $\\eta$ are defined at identical grid points. Centered finite differences are used to approximate spatial derivatives with periodic boundary conditions.\n\nYour task is to demonstrate that the Arakawa A-grid admits collocation-induced spurious modes that contaminate the discrete geostrophic relationship unless additional smoothing or filtering is applied. Specifically, you will:\n\n1. Start from the discrete geostrophic relations formulated on a uniform, periodic Arakawa A-grid using second-order centered finite differences for spatial derivatives. Define the discrete operators $D_x$ and $D_y$ for $\\partial / \\partial x$ and $\\partial / \\partial y$, respectively, and the discrete Laplacian operator $\\nabla^2 = D_{xx} + D_{yy}$ constructed from second-order centered differences.\n\n2. Given a smooth free-surface elevation field $\\eta_s(x,y)$ that is well-resolved on the grid, construct a geostrophically balanced velocity field $(u_s, v_s)$ using the discrete relations $f u_s = -g D_y \\eta_s$ and $-f v_s = -g D_x \\eta_s$. Then contaminate the elevation by superposing a grid-scale checkerboard mode $\\eta_{cb}(i,j) = A \\, (-1)^{i+j}$ to form $\\eta_t = \\eta_s + \\eta_{cb}$, while leaving $(u_s, v_s)$ unchanged. This models the collocation-induced spurious mode that is invisible to centered gradients on the Arakawa A-grid.\n\n3. Invert the geostrophic relations to reconstruct an elevation $\\eta_{\\text{inv}}$ from $(u_s, v_s)$ by forming the discrete Poisson equation for $\\eta$,\n$$\n\\nabla^2 \\eta = \\frac{f}{g}\\left(D_x v - D_y u\\right),\n$$\nand solving it with periodic boundary conditions using a spectral method based on the Fast Fourier Transform (FFT). Set the zero-wavenumber component of $\\eta_{\\text{inv}}$ to zero to define a unique solution.\n\n4. Define the geostrophic imbalance norm as the root-mean-square (RMS) difference between a target elevation and the geostrophically inverted elevation. Compute two RMS norms:\n   - The unsmoothed imbalance $N_{\\text{unsm}} = \\left(\\frac{1}{N_x N_y}\\sum_{i=0}^{N_y-1}\\sum_{j=0}^{N_x-1}\\left[\\eta_t(i,j) - \\eta_{\\text{inv}}(i,j)\\right]^2\\right)^{1/2}$.\n   - The smoothed imbalance $N_{\\text{sm}}$ computed after applying an isotropic, repeated one-two-one filter to $\\eta_t$:\n     $$\n     \\eta^{(k+1)}(i,j) = \\frac{1}{4}\\left(\\eta^{(k)}(i,j-1) + 2 \\eta^{(k)}(i,j) + \\eta^{(k)}(i,j+1)\\right),\n     $$\n     $$\n     \\eta^{(k+1)}(i,j) \\leftarrow \\frac{1}{4}\\left(\\eta^{(k+1)}(i-1,j) + 2 \\eta^{(k+1)}(i,j) + \\eta^{(k+1)}(i+1,j)\\right),\n     $$\n     with periodic indexing in both directions, repeated for a prescribed number of steps $K$. The final filtered elevation is $\\eta_{\\text{sm}} = \\eta^{(K)}$. Compute $N_{\\text{sm}}$ by replacing $\\eta_t$ with $\\eta_{\\text{sm}}$ in the RMS formula above.\n\n5. Use the following test suite of parameter sets to evaluate different regimes and edge cases. For each case, define grid, physical parameters, and fields as follows:\n   - The domain is doubly periodic with lengths $L_x$ and $L_y$ and $N_x \\times N_y$ grid points, giving spacings $\\Delta x = L_x / N_x$ and $\\Delta y = L_y / N_y$.\n   - The smooth elevation field is $\\eta_s(x,y) = H_s \\cos\\left(2\\pi m x/L_x\\right)\\cos\\left(2\\pi n y/L_y\\right)$ sampled at grid points, with integers $m$ and $n$.\n   - The checkerboard amplitude is $A$ in meters.\n   - The filter is applied for $K$ steps as specified.\n\nProvide results in meters. Use the following test cases:\n   1. Case 1 (well-resolved smooth field, no checkerboard): $N_x = 64$, $N_y = 64$, $L_x = 100000$ m, $L_y = 100000$ m, $f = 10^{-4}$ s$^{-1}$, $g = 9.81$ m s$^{-2}$, $H_s = 1$ m, $m = 4$, $n = 3$, $A = 0$ m, $K = 2$.\n   2. Case 2 (moderate checkerboard contamination): same as Case 1 but $A = 0.5$ m, $K = 2$.\n   3. Case 3 (strong checkerboard contamination): same as Case 1 but $A = 2.0$ m, $K = 2$.\n   4. Case 4 (coarser grid, higher smooth wavenumbers): $N_x = 32$, $N_y = 32$, $L_x = 100000$ m, $L_y = 100000$ m, $f = 10^{-4}$ s$^{-1}$, $g = 9.81$ m s$^{-2}$, $H_s = 1$ m, $m = 8$, $n = 8$, $A = 1.0$ m, $K = 4$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as\n[$N_{\\text{unsm}}^{(1)}$, $N_{\\text{sm}}^{(1)}$, $N_{\\text{unsm}}^{(2)}$, $N_{\\text{sm}}^{(2)}$, $N_{\\text{unsm}}^{(3)}$, $N_{\\text{sm}}^{(3)}$, $N_{\\text{unsm}}^{(4)}$, $N_{\\text{sm}}^{(4)}$],\nwhere the superscript indicates the test case number. Express all values in meters as floating-point numbers.",
            "solution": "The user's request to validate and solve the problem is addressed below.\n\n### I. Problem Validation\nThe problem statement was critically evaluated against the specified criteria.\n\n**1. Extraction of Givens:**\n-   **Equations**: Linearized, inviscid, constant-depth shallow-water geostrophic balance: $-f v = -g \\, \\partial \\eta / \\partial x$ and $f u = -g \\, \\partial \\eta / \\partial y$.\n-   **Discretization**: Arakawa A-grid (collocated) with periodic boundaries; second-order centered finite differences for derivatives ($D_x, D_y$).\n-   **Inversion**: Solve the discrete Poisson equation $\\nabla^2 \\eta = \\frac{f}{g}\\left(D_x v - D_y u\\right)$ via FFT, setting the mean of the solution to zero.\n-   **Fields**: Smooth elevation $\\eta_s(x,y) = H_s \\cos\\left(2\\pi m x/L_x\\right)\\cos\\left(2\\pi n y/L_y\\right)$ and checkerboard mode $\\eta_{cb}(i,j) = A \\, (-1)^{i+j}$. The total elevation is $\\eta_t = \\eta_s + \\eta_{cb}$.\n-   **Filter**: A repeated one-two-one filter applied for $K$ steps.\n-   **Metrics**: Unsmoothed imbalance $N_{\\text{unsm}} = \\text{RMS}(\\eta_t - \\eta_{\\text{inv}})$ and smoothed imbalance $N_{\\text{sm}} = \\text{RMS}(\\eta_{\\text{sm}} - \\eta_{\\text{inv}})$.\n-   **Parameters**: Four test cases are provided with specific values for grid dimensions ($N_x, N_y$), domain size ($L_x, L_y$), physical constants ($f, g$), and field parameters ($H_s, m, n, A, K$).\n\n**2. Validation Analysis:**\n-   **Scientific Grounding**: The problem is fundamentally sound. It addresses the well-known issue of spurious computational modes on Arakawa A-grids, a classic topic in computational geophysical fluid dynamics. The governing equations, numerical methods (centered differences, FFT-based Poisson solver), and filtering techniques are standard and correctly stated.\n-   **Well-Posedness**: The problem is well-posed. All necessary parameters are provided. The procedure is explicitly defined. The instruction to set the zero-wavenumber component of the solution to the Poisson equation to zero correctly handles the non-uniqueness of the solution on a periodic domain, ensuring a single, meaningful result. The right-hand side of the Poisson equation has a zero mean, which is the necessary condition for a solution to exist.\n-   **Objectivity**: The language is precise and objective. The tasks are quantitative and based on established numerical methods.\n\n**3. Verdict:**\nThe problem is **valid**. It is a well-structured, scientifically correct, and solvable problem that demonstrates an important concept in numerical modeling.\n\n### II. Reasoned Solution\nThe solution is developed by following the steps outlined in the problem statement. The core of the problem is to demonstrate how the Arakawa A-grid (collocated grid) fails to distinguish a high-frequency checkerboard pattern, leading to a spurious mode in the elevation field which is decoupled from the velocity field.\n\n**1. Discretization on the Arakawa A-Grid**\nOn an Arakawa A-grid, all variables ($u, v, \\eta$) are located at the same grid points $(x_j, y_i) = (j\\Delta x, i\\Delta y)$. The continuous geostrophic balance equations,\n$$ f u = -g \\frac{\\partial \\eta}{\\partial y} $$\n$$ f v = g \\frac{\\partial \\eta}{\\partial x} $$\nare discretized using second-order centered differences. For a field $\\phi$ defined on the grid points $\\phi_{i,j} = \\phi(y_i, x_j)$, the discrete gradient operators $D_x$ and $D_y$ are:\n$$ (D_x \\phi)_{i,j} = \\frac{\\phi_{i, j+1} - \\phi_{i, j-1}}{2\\Delta x} $$\n$$ (D_y \\phi)_{i,j} = \\frac{\\phi_{i+1, j} - \\phi_{i-1, j}}{2\\Delta y} $$\nwhere indices are handled periodically. The discrete geostrophic balance is thus:\n$$ f u_{i,j} = -g (D_y \\eta)_{i,j} $$\n$$ f v_{i,j} = g (D_x \\eta)_{i,j} $$\n\n**2. The Spurious Checkerboard Mode**\nThe central issue with the A-grid is its susceptibility to decoupling between the mass field ($\\eta$) and the velocity field ($u, v$) at the highest representable grid frequency. Consider the checkerboard elevation field, $\\eta_{cb}(i,j) = A (-1)^{i+j}$. Applying the discrete gradient operators to this mode yields:\n$$ (D_x \\eta_{cb})_{i,j} = \\frac{A(-1)^{i+j+1} - A(-1)^{i+j-1}}{2\\Delta x} = \\frac{A(-1)^{i+j}}{2\\Delta x} \\left( (-1)^1 - (-1)^{-1} \\right) = 0 $$\n$$ (D_y \\eta_{cb})_{i,j} = \\frac{A(-1)^{i+1+j} - A(-1)^{i-1+j}}{2\\Delta y} = \\frac{A(-1)^{i+j}}{2\\Delta y} \\left( (-1)^1 - (-1)^{-1} \\right) = 0 $$\nThe checkerboard mode resides in the null space of the centered difference operators. Consequently, adding $\\eta_{cb}$ to any smooth elevation field $\\eta_s$ does not alter the pressure gradients calculated by these operators, and therefore does not affect the geostrophically balanced velocity field. The velocity field remains balanced only with $\\eta_s$, while the total elevation $\\eta_t = \\eta_s + \\eta_{cb}$ is out of balance. This is the source of the geostrophic imbalance that the problem asks to quantify.\n\n**3. Inversion of Geostrophic Balance via Poisson Equation**\nTo reconstruct an elevation field $\\eta_{\\text{inv}}$ that is in geostrophic balance with a given velocity field $(u_s, v_s)$, we formulate and solve a Poisson equation. Taking the divergence of the geostrophic momentum equations yields the relative vorticity $\\zeta = \\frac{\\partial v}{\\partial x} - \\frac{\\partial u}{\\partial y}$. Combining this with the geostrophic relations gives:\n$$ \\nabla^2\\eta = \\frac{\\partial^2 \\eta}{\\partial x^2} + \\frac{\\partial^2 \\eta}{\\partial y^2} = \\frac{f}{g}\\left(\\frac{\\partial v}{\\partial x} - \\frac{\\partial u}{\\partial y}\\right) $$\nThe discrete form is:\n$$ (\\nabla^2_d \\eta)_{i,j} = (D_{xx} \\eta + D_{yy} \\eta)_{i,j} = \\frac{f}{g}((D_x v)_{i,j} - (D_y u)_{i,j}) $$\nwhere $\\nabla^2_d$ is the discrete Laplacian. This elliptic partial differential equation is solved efficiently on a periodic domain using the Fast Fourier Transform (FFT).\nThe method involves:\na. Transforming the right-hand side, $\\text{RHS} = \\frac{f}{g}(D_x v_s - D_y u_s)$, into Fourier space: $\\widehat{\\text{RHS}} = \\text{FFT}(\\text{RHS})$.\nb. Dividing by the Fourier representation of the discrete Laplacian operator, $\\widehat{\\nabla^2_d}$. For a wavenumber pair $(k_x, k_y)$, this operator is $\\widehat{\\nabla^2_d}(k_x, k_y) = \\frac{2}{\\Delta x^2}(\\cos(k_x \\Delta x) - 1) + \\frac{2}{\\Delta y^2}(\\cos(k_y \\Delta y) - 1)$.\nc. The solution in Fourier space is $\\widehat{\\eta}_{\\text{inv}} = \\widehat{\\text{RHS}} / \\widehat{\\nabla^2_d}$.\nd. At the zero-wavenumber $(k_x, k_y) = (0,0)$, $\\widehat{\\nabla^2_d}$ is zero, creating a singularity. As specified, the solution is made unique by setting the mean of $\\eta_{\\text{inv}}$ to zero, which corresponds to setting its zero-wavenumber Fourier coefficient $\\widehat{\\eta}_{\\text{inv}}(0,0)$ to zero.\ne. The final solution is obtained by an inverse FFT: $\\eta_{\\text{inv}} = \\text{IFFT}(\\widehat{\\eta}_{\\text{inv}})$.\nSince the velocities $(u_s, v_s)$ were derived from $\\eta_s$, we expect the inverted field $\\eta_{\\text{inv}}$ to be a close approximation of $\\eta_s$, up to a constant offset which is removed by our zero-mean condition.\n\n**4. Quantifying Imbalance and the Role of Filtering**\nThe geostrophic imbalance is quantified by the Root-Mean-Square (RMS) difference between a target elevation field and the geostrophically consistent field $\\eta_{\\text{inv}}$.\n-   The **unsmoothed imbalance**, $N_{\\text{unsm}} = \\text{RMS}(\\eta_t - \\eta_{\\text{inv}}) = \\text{RMS}((\\eta_s + \\eta_{cb}) - \\eta_{\\text{inv}})$. Since $\\eta_{\\text{inv}} \\approx \\eta_s$, this error is dominated by the checkerboard mode: $N_{\\text{unsm}} \\approx \\text{RMS}(\\eta_{cb})$. The RMS value of $\\eta_{cb}$ is simply its amplitude $A$.\n-   To mitigate this imbalance, a low-pass numerical filter is applied to the total elevation $\\eta_t$. The problem specifies a separable one-two-one filter, which damps high-frequency components. A single application of this filter in each direction has a transfer function that is zero for the checkerboard mode, effectively eliminating it. The filter also slightly damps the lower-frequency smooth signal $\\eta_s$. The **smoothed imbalance**, $N_{\\text{sm}} = \\text{RMS}(\\eta_{\\text{sm}} - \\eta_{\\text{inv}})$, measures the error after filtering. It is expected to be much smaller than $N_{\\text{unsm}}$ because the filter removes the dominant source of error, $\\eta_{cb}$. The remaining error in $N_{\\text{sm}}$ arises from the filter's slight distortion of the physical signal $\\eta_s$.\n\n**5. Simulation Procedure and Expected Results**\nFor each test case, the algorithm proceeds as follows:\n1.  Set up the grid and parameters.\n2.  Construct the smooth elevation field $\\eta_s$ and the checkerboard mode $\\eta_{cb}$.\n3.  Calculate the balanced velocities $(u_s, v_s)$ from $\\eta_s$.\n4.  Form the contaminated total elevation $\\eta_t = \\eta_s + \\eta_{cb}$.\n5.  Solve the Poisson equation for $\\eta_{\\text{inv}}$ using the velocities $(u_s, v_s)$.\n6.  Calculate the unsmoothed imbalance $N_{\\text{unsm}}$. This is expected to be approximately equal to the checkerboard amplitude $A$.\n7.  Apply the one-two-one filter $K$ times to $\\eta_t$ to get $\\eta_{\\text{sm}}$.\n8.  Calculate the smoothed imbalance $N_{\\text{sm}}$. This is expected to be significantly smaller than $N_{\\text{unsm}}$, demonstrating the filter's effectiveness.\n\nThe test cases are designed to explore this phenomenon under different conditions: no noise (Case 1), moderate and strong noise (Cases 2 and 3), and a case where the \"smooth\" signal itself has a high wavenumber (Case 4), testing the filter's selectivity.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Demonstrates the Arakawa A-grid spurious mode problem and its mitigation.\n    \"\"\"\n\n    def create_discrete_operators(Nx, Ny, dx, dy):\n        \"\"\"Creates functions for discrete differential operators.\"\"\"\n        \n        def d_dx(phi):\n            return (np.roll(phi, -1, axis=1) - np.roll(phi, 1, axis=1)) / (2 * dx)\n\n        def d_dy(phi):\n            return (np.roll(phi, -1, axis=0) - np.roll(phi, 1, axis=0)) / (2 * dy)\n            \n        return d_dx, d_dy\n\n    def solve_poisson_fft(rhs, Nx, Ny, dx, dy):\n        \"\"\"Solves the 2D periodic Poisson equation using FFT.\"\"\"\n        # Wavenumbers for real FFT\n        kx = 2 * np.pi * np.fft.rfftfreq(Nx, d=dx)\n        ky = 2 * np.pi * np.fft.fftfreq(Ny, d=dy)\n        Kx, Ky = np.meshgrid(kx, ky)\n\n        # Fourier representation of the 2nd-order centered difference Laplacian\n        lap_fourier = (2 / dx**2 * (np.cos(Kx * dx) - 1)) + \\\n                      (2 / dy**2 * (np.cos(Ky * dy) - 1))\n\n        # Perform FFT on the right-hand side\n        rhs_hat = np.fft.rfft2(rhs)\n\n        # Solve in Fourier space\n        solution_hat = np.zeros_like(rhs_hat)\n        \n        # Avoid division by zero at the zero-wavenumber\n        # This is safe because lap_fourier is non-zero for k != 0\n        non_zero_k = lap_fourier != 0\n        solution_hat[non_zero_k] = rhs_hat[non_zero_k] / lap_fourier[non_zero_k]\n        \n        # Enforce zero mean for the solution\n        solution_hat[0, 0] = 0.0\n\n        # Transform back to physical space\n        solution = np.fft.irfft2(solution_hat, s=(Ny, Nx))\n        \n        return solution\n\n    def apply_one_two_one_filter(phi, K):\n        \"\"\"Applies a 2D one-two-one filter K times.\"\"\"\n        phi_filtered = phi.copy()\n        for _ in range(K):\n            # X-direction pass\n            phi_filtered = 0.25 * (np.roll(phi_filtered, 1, axis=1) + 2 * phi_filtered + np.roll(phi_filtered, -1, axis=1))\n            # Y-direction pass\n            phi_filtered = 0.25 * (np.roll(phi_filtered, 1, axis=0) + 2 * phi_filtered + np.roll(phi_filtered, -1, axis=0))\n        return phi_filtered\n\n    def run_case(params):\n        \"\"\"Runs a single test case.\"\"\"\n        Nx, Ny, Lx, Ly, f, g, Hs, m, n, A, K = params\n\n        dx = Lx / Nx\n        dy = Ly / Ny\n\n        # Create grid\n        x = np.arange(Nx) * dx\n        y = np.arange(Ny) * dy\n        xx, yy = np.meshgrid(x, y)\n\n        # Create discrete operators\n        D_x, D_y = create_discrete_operators(Nx, Ny, dx, dy)\n        \n        # 1. Construct smooth elevation field\n        eta_s = Hs * np.cos(2 * np.pi * m * xx / Lx) * np.cos(2 * np.pi * n * yy / Ly)\n\n        # 2. Compute geostrophically balanced velocities from eta_s\n        u_s = -(g / f) * D_y(eta_s)\n        v_s = (g / f) * D_x(eta_s)\n\n        # 3. Contaminate elevation with checkerboard mode\n        ii, jj = np.meshgrid(np.arange(Ny), np.arange(Nx), indexing='ij')\n        eta_cb = A * (-1)**(ii + jj)\n        eta_t = eta_s + eta_cb\n\n        # 4. Invert for eta_inv from (u_s, v_s)\n        relative_vorticity = D_x(v_s) - D_y(u_s)\n        poisson_rhs = (f / g) * relative_vorticity\n        eta_inv = solve_poisson_fft(poisson_rhs, Nx, Ny, dx, dy)\n        \n        # Since eta_s has a zero mean over the domain, and we set the mean of eta_inv to zero,\n        # eta_inv should be a very close approximation of eta_s.\n\n        # 5. Compute unsmoothed imbalance norm\n        diff_unsm = eta_t - eta_inv\n        N_unsm = np.sqrt(np.mean(diff_unsm**2))\n\n        # 6. Apply filter to get eta_sm\n        eta_sm = apply_one_two_one_filter(eta_t, K)\n\n        # 7. Compute smoothed imbalance norm\n        diff_sm = eta_sm - eta_inv\n        N_sm = np.sqrt(np.mean(diff_sm**2))\n\n        return N_unsm, N_sm\n\n    test_cases = [\n        # Nx, Ny, Lx(m), Ly(m), f(s-1), g(m/s2), Hs(m), m, n, A(m), K\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 0.0, 2), # Case 1\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 0.5, 2), # Case 2\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 2.0, 2), # Case 3\n        (32, 32, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 8, 8, 1.0, 4), # Case 4\n    ]\n\n    results = []\n    for case in test_cases:\n        N_unsm, N_sm = run_case(case)\n        results.extend([N_unsm, N_sm])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Having established the limitations of the collocated A-grid, we now turn to the elegant solution: the staggered grid. This foundational exercise focuses on the Arakawa C-grid, the most widely used configuration in ocean modeling, where velocity components are staggered relative to scalar quantities like pressure. By deriving the discrete pressure gradient operators on this grid using Taylor series analysis , you will see firsthand how the staggered arrangement naturally computes gradients over a single grid cell, providing a tight coupling between the pressure and velocity fields and fundamentally preventing the spurious modes that plague the A-grid.",
            "id": "3785662",
            "problem": "Consider a uniform, rectilinear horizontal grid with spacings $\\Delta x$ and $\\Delta y$ in the $x$ and $y$ directions, respectively. On an Arakawa C-grid arrangement, let the scalar field $p(i,j)$ be stored at cell centers located at $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$ for integer indices $i$ and $j$. The $u$-velocity points are located at the centers of the east–west faces at $(x,y)=\\left(i\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$ (denoted by the half-index location $(i+\\frac{1}{2},j)$), and the $v$-velocity points are located at the centers of the north–south faces at $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,j\\Delta y\\right)$ (denoted by the half-index location $(i,j+\\frac{1}{2})$). Assume $p$ is sufficiently smooth.\n\nStarting from the definition of the gradient and using Taylor series, derive second-order accurate, centered, discrete approximations for the horizontal gradient $\\nabla_{h} p$ evaluated at the $u$ and $v$ locations, expressed solely in terms of $p(i,j)$ at cell centers and the uniform spacings $\\Delta x$ and $\\Delta y$. You should obtain one expression for the $x$-component and one for the $y$-component of $\\nabla_{h} p$ at the $u$ location $(i+\\frac{1}{2},j)$, and similarly one expression for the $x$-component and one for the $y$-component of $\\nabla_{h} p$ at the $v$ location $(i,j+\\frac{1}{2})$. Neglect boundary effects by assuming that all required neighboring indices exist.\n\nProvide your final result as a single row matrix containing four expressions in the following order:\n- the $x$-component at the $u$ location,\n- the $y$-component at the $u$ location,\n- the $x$-component at the $v$ location,\n- the $y$-component at the $v$ location.\n\nDo not include any equality signs in your final answer. No numerical evaluation or rounding is required. Use only the symbols $p(i,j)$, $\\Delta x$, and $\\Delta y$ in your expressions.",
            "solution": "This problem requires deriving the discrete horizontal gradient components of a scalar field $p$ at the staggered velocity locations on an Arakawa C-grid. We use Taylor series expansions to establish second-order accurate, centered finite difference approximations.\n\nThe grid locations are defined as:\n- Scalar $p(i,j)$ at $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$\n- Zonal velocity $u$ at $(i+\\frac{1}{2},j)$, i.e., $(x,y)=\\left(i\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$\n- Meridional velocity $v$ at $(i,j+\\frac{1}{2})$, i.e., $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,j\\Delta y\\right)$\n\n### 1. Gradient at the $u$-velocity location $(i+\\frac{1}{2}, j)$\n\n**a) x-component of the gradient, $\\frac{\\partial p}{\\partial x}$**\n\nThe $u$-velocity at $(i+\\frac{1}{2}, j)$ is located exactly between the scalar points $p(i,j)$ and $p(i+1,j)$ in the $x$-direction. This allows for a natural, compact, centered difference:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2},j} \\approx \\frac{p(i+1,j) - p(i,j)}{\\Delta x}\n$$\nTo verify its accuracy, we perform a Taylor series expansion of $p(i+1,j)$ and $p(i,j)$ around the $u$-point location $x_u = i\\Delta x$:\n$$\np(i+1,j) = p(x_u+\\frac{\\Delta x}{2}) = p(x_u) + \\frac{\\Delta x}{2} \\frac{\\partial p}{\\partial x} + \\frac{(\\Delta x)^2}{8} \\frac{\\partial^2 p}{\\partial x^2} + O((\\Delta x)^3)\n$$\n$$\np(i,j) = p(x_u-\\frac{\\Delta x}{2}) = p(x_u) - \\frac{\\Delta x}{2} \\frac{\\partial p}{\\partial x} + \\frac{(\\Delta x)^2}{8} \\frac{\\partial^2 p}{\\partial x^2} - O((\\Delta x)^3)\n$$\nSubtracting the second equation from the first gives:\n$$\np(i+1,j) - p(i,j) = \\Delta x \\frac{\\partial p}{\\partial x} + O((\\Delta x)^3)\n$$\nDividing by $\\Delta x$ shows that the approximation is second-order accurate:\n$$\n\\frac{p(i+1,j) - p(i,j)}{\\Delta x} = \\frac{\\partial p}{\\partial x} + O((\\Delta x)^2)\n$$\n\n**b) y-component of the gradient, $\\frac{\\partial p}{\\partial y}$**\n\nThe $u$-velocity location is not centered between scalar points in the $y$-direction. To obtain a centered, second-order accurate approximation, we must interpolate. A standard approach is to average the $y$-gradients from the columns $i$ and $i+1$. The centered $y$-gradient at column $i$ is $\\frac{p(i,j+1)-p(i,j-1)}{2\\Delta y}$, and at column $i+1$ it is $\\frac{p(i+1,j+1)-p(i+1,j-1)}{2\\Delta y}$. Averaging these two gives the gradient at the $u$-point between the columns:\n$$\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i+\\frac{1}{2},j} \\approx \\frac{1}{2} \\left( \\frac{p(i,j+1)-p(i,j-1)}{2\\Delta y} + \\frac{p(i+1,j+1)-p(i+1,j-1)}{2\\Delta y} \\right) = \\frac{p(i,j+1)+p(i+1,j+1) - p(i,j-1) - p(i+1,j-1)}{4\\Delta y}\n$$\nThis four-point stencil is second-order accurate.\n\n### 2. Gradient at the $v$-velocity location $(i,j+\\frac{1}{2})$\n\nThe derivations for the gradient at the $v$-point are analogous to those at the $u$-point due to the symmetry of the grid.\n\n**a) y-component of the gradient, $\\frac{\\partial p}{\\partial y}$**\n\nThe $v$-velocity at $(i, j+\\frac{1}{2})$ is located exactly between the scalar points $p(i,j)$ and $p(i,j+1)$ in the $y$-direction. This gives a compact, second-order accurate centered difference:\n$$\n\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}} \\approx \\frac{p(i,j+1) - p(i,j)}{\\Delta y}\n$$\n\n**b) x-component of the gradient, $\\frac{\\partial p}{\\partial x}$**\n\nSimilar to the transverse gradient at the $u$-point, we average the $x$-gradients from the rows $j$ and $j+1$:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j+\\frac{1}{2}} \\approx \\frac{1}{2} \\left( \\frac{p(i+1,j)-p(i-1,j)}{2\\Delta x} + \\frac{p(i+1,j+1)-p(i-1,j+1)}{2\\Delta x} \\right) = \\frac{p(i+1,j)+p(i+1,j+1) - p(i-1,j) - p(i-1,j+1)}{4\\Delta x}\n$$\nThis four-point stencil is also second-order accurate.\n\n### Summary of Expressions\nThe four requested discrete gradient expressions are:\n1.  x-component at the u-location: $\\frac{p(i+1,j) - p(i,j)}{\\Delta x}$\n2.  y-component at the u-location: $\\frac{p(i,j+1) + p(i+1,j+1) - p(i,j-1) - p(i+1,j-1)}{4\\Delta y}$\n3.  x-component at the v-location: $\\frac{p(i+1,j) + p(i+1,j+1) - p(i-1,j) - p(i-1,j+1)}{4\\Delta x}$\n4.  y-component at the v-location: $\\frac{p(i,j+1) - p(i,j)}{\\Delta y}$",
            "answer": "$$ \\boxed{ \\begin{pmatrix} \\frac{p(i+1,j) - p(i,j)}{\\Delta x}  \\frac{p(i,j+1) + p(i+1,j+1) - p(i,j-1) - p(i+1,j-1)}{4\\Delta y}  \\frac{p(i+1,j) + p(i+1,j+1) - p(i-1,j) - p(i-1,j+1)}{4\\Delta x}  \\frac{p(i,j+1) - p(i,j)}{\\Delta y} \\end{pmatrix} } $$"
        }
    ]
}