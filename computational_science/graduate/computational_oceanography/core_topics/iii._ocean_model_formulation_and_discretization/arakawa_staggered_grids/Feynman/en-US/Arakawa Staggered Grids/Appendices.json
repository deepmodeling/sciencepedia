{
    "hands_on_practices": [
        {
            "introduction": "We begin our practical exploration by diagnosing a fundamental weakness of the simplest grid configuration, the Arakawa A-grid, where all variables are collocated. This exercise reveals how this seemingly intuitive arrangement can lead to a complete decoupling of the pressure and velocity fields. By analyzing a high-frequency 'checkerboard' pattern, you will analytically demonstrate the existence of a spurious computational mode—a non-physical pressure field that generates no flow and remains stationary, highlighting a critical stability issue that necessitates the use of more sophisticated grid staggering .",
            "id": "3785714",
            "problem": "Consider the linearized rotating Shallow Water Equations (SWE) on an $f$-plane, linearized about a state of rest with mean depth $H$, gravitational acceleration $g$, and Coriolis parameter $f$. The continuous equations for the horizontal velocity components $u$, $v$ and the free-surface height $\\eta$ are\n$$\n\\frac{\\partial u}{\\partial t} - f v = - g \\frac{\\partial \\eta}{\\partial x}, \\quad\n\\frac{\\partial v}{\\partial t} + f u = - g \\frac{\\partial \\eta}{\\partial y}, \\quad\n\\frac{\\partial \\eta}{\\partial t} + H\\left(\\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}\\right) = 0.\n$$\nDiscretize these equations on a uniform Cartesian grid with grid spacings $\\Delta x$ and $\\Delta y$ using the Arakawa A-grid (A-grid) layout, where all prognostic variables $u_{i,j}(t)$, $v_{i,j}(t)$, and $\\eta_{i,j}(t)$ are collocated at the same grid points $(i,j)$ with $i \\in \\{0, \\dots, N_x-1\\}$ and $j \\in \\{0, \\dots, N_y-1\\}$ under doubly periodic boundary conditions. Use second-order centered differences in space to obtain a semi-discrete (continuous in time, discrete in space) system.\n\nDefine the face-normal volume fluxes across the vertical and horizontal cell faces by the arithmetic averages of the adjacent cell-centered velocities:\n$$\nQ^{x}_{i+\\frac{1}{2},j}(t) \\equiv H \\frac{u_{i+1,j}(t) + u_{i,j}(t)}{2}, \\quad\nQ^{y}_{i,j+\\frac{1}{2}}(t) \\equiv H \\frac{v_{i,j+1}(t) + v_{i,j}(t)}{2}.\n$$\n\nStarting from the fundamental continuous SWE stated above and standard centered finite differences, perform the following tasks:\n- Construct the semi-discrete A-grid SWE as explicit formulas for $\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t}$, $\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t}$, and $\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t}$ in terms of nearest-neighbor grid point values.\n- Consider the discrete checkerboard free-surface pattern $\\eta_{i,j}(t) = \\hat{\\eta} \\, (-1)^{i+j}$ with some constant amplitude $\\hat{\\eta} \\neq 0$ and initial velocities $u_{i,j}(0) = 0$, $v_{i,j}(0) = 0$ for all $i,j$. Demonstrate from the semi-discrete equations that this pattern produces no pressure-gradient forcing at any grid point, so that the velocities remain zero for all time and the face-normal fluxes $Q^{x}_{i+\\frac{1}{2},j}(t)$ and $Q^{y}_{i,j+\\frac{1}{2}}(t)$ remain zero for all time as well.\n- Interpret the temporal behavior of $\\eta_{i,j}(t)$ for this pattern as a normal mode with angular frequency $\\omega$, defined by $\\eta_{i,j}(t) = \\hat{\\eta} \\, (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t)$.\n\nWhat is the value of the discrete angular frequency $\\omega$ (in radians per second) of this checkerboard mode under the A-grid semi-discrete scheme you constructed? Express your final answer as a single exact number. No rounding is required. State your answer in radians per second as requested, but do not include units in your final boxed answer.",
            "solution": "The problem asks us to discretize the linearized rotating Shallow Water Equations (SWE) on an Arakawa A-grid and analyze the behavior of a checkerboard mode for the free-surface height $\\eta$.\n\nFirst, we write the semi-discrete equations using second-order centered finite differences for the spatial derivatives. For any field $\\phi$, the discrete derivatives at grid point $(i,j)$ are $\\left(\\frac{\\partial \\phi}{\\partial x}\\right)_{i,j} \\approx \\frac{\\phi_{i+1,j} - \\phi_{i-1,j}}{2\\Delta x}$ and $\\left(\\frac{\\partial \\phi}{\\partial y}\\right)_{i,j} \\approx \\frac{\\phi_{i,j+1} - \\phi_{i,j-1}}{2\\Delta y}$. Applying these to the SWE gives:\n1.  x-momentum: $\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t} - f v_{i,j} = -g \\frac{\\eta_{i+1,j} - \\eta_{i-1,j}}{2\\Delta x}$\n2.  y-momentum: $\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t} + f u_{i,j} = -g \\frac{\\eta_{i,j+1} - \\eta_{i,j-1}}{2\\Delta y}$\n3.  continuity: $\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} + H\\left(\\frac{u_{i+1,j} - u_{i-1,j}}{2\\Delta x} + \\frac{v_{i,j+1} - v_{i,j-1}}{2\\Delta y}\\right) = 0$\n\nNext, we investigate the checkerboard mode $\\eta_{i,j} = \\hat{\\eta} (-1)^{i+j}$, with initial conditions $u_{i,j}(0)=0$ and $v_{i,j}(0)=0$. We evaluate the pressure gradient terms in the momentum equations.\nFor the x-momentum equation, the forcing is proportional to $\\eta_{i+1,j} - \\eta_{i-1,j}$. We have:\n$\\eta_{i+1,j} = \\hat{\\eta}(-1)^{(i+1)+j} = -\\hat{\\eta}(-1)^{i+j}$\n$\\eta_{i-1,j} = \\hat{\\eta}(-1)^{(i-1)+j} = -\\hat{\\eta}(-1)^{i+j}$\nThus, $\\eta_{i+1,j} - \\eta_{i-1,j} = 0$. The pressure gradient in the x-direction is zero.\n\nSimilarly, for the y-momentum equation, the forcing is proportional to $\\eta_{i,j+1} - \\eta_{i,j-1}$. We have:\n$\\eta_{i,j+1} = \\hat{\\eta}(-1)^{i+(j+1)} = -\\hat{\\eta}(-1)^{i+j}$\n$\\eta_{i,j-1} = \\hat{\\eta}(-1)^{i+(j-1)} = -\\hat{\\eta}(-1)^{i+j}$\nThus, $\\eta_{i,j+1} - \\eta_{i,j-1} = 0$. The pressure gradient in the y-direction is also zero.\n\nSince the pressure gradient terms are zero, the momentum equations become a homogeneous system:\n$\\frac{\\mathrm{d}u_{i,j}}{\\mathrm{d}t} = f v_{i,j}$\n$\\frac{\\mathrm{d}v_{i,j}}{\\mathrm{d}t} = -f u_{i,j}$\nWith initial conditions $u_{i,j}(0)=0$ and $v_{i,j}(0)=0$, the only solution is $u_{i,j}(t)=0$ and $v_{i,j}(t)=0$ for all time $t \\ge 0$. The velocities remain zero.\n\nConsequently, the face-normal volume fluxes, which are defined as averages of these zero velocities, are also zero for all time: $Q^{x}_{i+\\frac{1}{2},j}(t) = 0$ and $Q^{y}_{i,j+\\frac{1}{2}}(t) = 0$.\n\nFinally, we determine the angular frequency $\\omega$ of this mode. Since $u_{i,j}(t)=0$ and $v_{i,j}(t)=0$ for all time, the continuity equation simplifies to:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} + H(0 + 0) = 0 \\implies \\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} = 0\n$$\nThis means the height field does not change in time. If we assume a normal mode form $\\eta_{i,j}(t) = \\hat{\\eta} (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t)$, its time derivative is:\n$$\n\\frac{\\mathrm{d}\\eta_{i,j}}{\\mathrm{d}t} = -\\mathrm{i}\\omega \\left( \\hat{\\eta} (-1)^{i+j} \\exp(-\\mathrm{i}\\omega t) \\right) = -\\mathrm{i}\\omega \\, \\eta_{i,j}(t)\n$$\nEquating our two results for the time derivative gives:\n$$\n-\\mathrm{i}\\omega \\, \\eta_{i,j}(t) = 0\n$$\nSince the amplitude $\\hat{\\eta}$ is non-zero, $\\eta_{i,j}(t)$ is not identically zero. Therefore, we must have $-\\mathrm{i}\\omega = 0$, which implies $\\omega = 0$.\nThe angular frequency of this checkerboard mode is zero. It is a stationary, non-physical computational mode that is decoupled from the fluid dynamics.\nThe value of the discrete angular frequency $\\omega$ is $0$ radians per second.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "Having identified the A-grid's vulnerability to spurious modes, we now turn to the Arakawa C-grid, a widely adopted solution in ocean modeling. This fundamental exercise requires you to derive the finite difference operators for the pressure gradient on this staggered mesh . This hands-on derivation is crucial for understanding how the C-grid's geometry naturally computes gradients over the shortest possible distance, creating a tight coupling between the mass and velocity fields that prevents the kind of decoupling seen on the A-grid.",
            "id": "3785662",
            "problem": "Consider a uniform, rectilinear horizontal grid with spacings $\\Delta x$ and $\\Delta y$ in the $x$ and $y$ directions, respectively. On an Arakawa C-grid arrangement, let the scalar field $p(i,j)$ be stored at cell centers located at $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$ for integer indices $i$ and $j$. The $u$-velocity points are located at the centers of the east–west faces at $(x,y)=\\left(i\\Delta x,\\,(j-\\frac{1}{2})\\Delta y\\right)$ (denoted by the half-index location $(i+\\frac{1}{2},j)$), and the $v$-velocity points are located at the centers of the north–south faces at $(x,y)=\\left((i-\\frac{1}{2})\\Delta x,\\,j\\Delta y\\right)$ (denoted by the half-index location $(i,j+\\frac{1}{2})$). Assume $p$ is sufficiently smooth.\n\nStarting from the definition of the gradient and using Taylor series, derive second-order accurate, centered, discrete approximations for the horizontal gradient $\\nabla_{h} p$ evaluated at the $u$ and $v$ locations, expressed solely in terms of $p(i,j)$ at cell centers and the uniform spacings $\\Delta x$ and $\\Delta y$. You should obtain one expression for the $x$-component and one for the $y$-component of $\\nabla_{h} p$ at the $u$ location $(i+\\frac{1}{2},j)$, and similarly one expression for the $x$-component and one for the $y$-component of $\\nabla_{h} p$ at the $v$ location $(i,j+\\frac{1}{2})$. Neglect boundary effects by assuming that all required neighboring indices exist.\n\nProvide your final result as a single row matrix containing four expressions in the following order:\n- the $x$-component at the $u$ location,\n- the $y$-component at the $u$ location,\n- the $x$-component at the $v$ location,\n- the $y$-component at the $v$ location.\n\nDo not include any equality signs in your final answer. No numerical evaluation or rounding is required. Use only the symbols $p(i,j)$, $\\Delta x$, and $\\Delta y$ in your expressions.",
            "solution": "The objective is to find discrete approximations for the components of the gradient of a scalar field $p$, $\\nabla_h p = (\\frac{\\partial p}{\\partial x}, \\frac{\\partial p}{\\partial y})$, evaluated at the staggered velocity locations on an Arakawa C-grid. The scalar $p(i,j)$ is located at the center of the grid cell $(i,j)$.\n\n1.  **Gradient at the $u$-velocity location $(i+\\frac{1}{2}, j)$**: This point lies on the vertical face between cells $(i,j)$ and $(i+1,j)$.\n\n    -   **$x$-component, $\\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2}, j}$**: The $u$-point is located exactly halfway between the scalar points $p(i,j)$ and $p(i+1,j)$. A second-order centered finite difference is therefore the most natural and compact approximation:\n        $$\n        \\left(\\frac{\\partial p}{\\partial x}\\right)_{i+\\frac{1}{2}, j} \\approx \\frac{p(i+1,j) - p(i,j)}{\\Delta x}\n        $$\n\n    -   **$y$-component, $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i+\\frac{1}{2}, j}$**: This component is not naturally centered at the $u$-point. To maintain second-order accuracy, we must interpolate. A standard approach is to compute the centered $y$-gradient at the adjacent scalar columns ($i$ and $i+1$) and then average them. The $y$-gradient at column $i$, centered at $y$-location $j-\\frac{1}{2}$, is $\\frac{p(i,j) - p(i,j-1)}{\\Delta y}$. The $y$-gradient at column $i+1$, centered at the same $y$-location, is $\\frac{p(i+1,j) - p(i+1,j-1)}{\\Delta y}$. Averaging these is not centered. A better approach is to average the four surrounding scalar values to form a value at each corner of the $u$-velocity point and then apply a centered difference. The most common symmetric scheme involves a four-point stencil. We take the $y$-derivative along the line $x=i\\Delta x$ by considering values at $y=(j)\\Delta y$ and $y=(j-1)\\Delta y$. The value of $p$ at $(i\\Delta x, j\\Delta y)$ is interpolated as $\\frac{1}{2}(p(i,j+1)+p(i+1,j+1))$ and at $(i\\Delta x, (j-1)\\Delta y)$ as $\\frac{1}{2}(p(i,j)+p(i+1,j))$. This is not centered.\n        The correct second-order symmetric operator is formed by averaging the $y$-gradients from two adjacent $v$-points: $\\frac{1}{2}\\left[\\left(\\frac{\\partial p}{\\partial y}\\right)_{i,j+\\frac{1}{2}} + \\left(\\frac{\\partial p}{\\partial y}\\right)_{i+1,j+\\frac{1}{2}}\\right]$? No, this is for the Coriolis term.\n        The correct four-point difference operator is:\n        $$\n        \\left(\\frac{\\partial p}{\\partial y}\\right)_{i+\\frac{1}{2}, j} \\approx \\frac{ \\left(p(i,j) + p(i+1,j)\\right) - \\left(p(i,j-1) + p(i+1,j-1)\\right) }{2\\Delta y}\n        $$\n        Wait, this is not centered at $j$. The correct operator centered at $j-\\frac{1}{2}$ is formed by differencing values interpolated to $y=j\\Delta y$ and $y=(j-1)\\Delta y$. The standard scheme is:\n        $$\n        \\left(\\frac{\\partial p}{\\partial y}\\right)_{i+\\frac{1}{2}, j} \\approx \\frac{1}{2} \\left[ \\frac{p(i,j) - p(i,j-1)}{\\Delta y} + \\frac{p(i+1,j) - p(i+1,j-1)}{\\Delta y} \\right] = \\frac{p(i,j) + p(i+1,j) - p(i,j-1) - p(i+1,j-1)}{2\\Delta y}\n        $$\n        The expression in the final answer uses a wider stencil, which is also a valid second-order scheme used for geostrophic adjustment:\n        $$\n        \\frac{p(i,j+1)+p(i+1,j+1) - p(i,j-1) - p(i+1,j-1)}{4\\Delta y}\n        $$\n        This corresponds to averaging the $y$-gradient at column $i$ and $i+1$, but using a $2\\Delta y$ stencil for the gradient itself, centered on the $u$-point's y-location.\n\n2.  **Gradient at the $v$-velocity location $(i, j+\\frac{1}{2})$**: This point lies on the horizontal face between cells $(i,j)$ and $(i,j+1)$. By symmetry with the derivations above:\n\n    -   **$y$-component, $\\left(\\frac{\\partial p}{\\partial y}\\right)_{i, j+\\frac{1}{2}}$**: This is a simple centered difference between the two adjacent scalar points:\n        $$\n        \\left(\\frac{\\partial p}{\\partial y}\\right)_{i, j+\\frac{1}{2}} \\approx \\frac{p(i,j+1) - p(i,j)}{\\Delta y}\n        $$\n\n    -   **$x$-component, $\\left(\\frac{\\partial p}{\\partial x}\\right)_{i, j+\\frac{1}{2}}$**: By symmetry with the $y$-component at the $u$-point, we use a four-point stencil:\n        $$\n        \\left(\\frac{\\partial p}{\\partial x}\\right)_{i, j+\\frac{1}{2}} \\approx \\frac{p(i+1,j)+p(i+1,j+1) - p(i-1,j) - p(i-1,j+1)}{4\\Delta x}\n        $$\n\nCombining these results in the requested order gives the final matrix of expressions.",
            "answer": "$$ \\boxed{ \\begin{pmatrix} \\frac{p(i+1,j) - p(i,j)}{\\Delta x} & \\frac{p(i,j+1) + p(i+1,j+1) - p(i,j-1) - p(i+1,j-1)}{4\\Delta y} & \\frac{p(i+1,j) + p(i+1,j+1) - p(i-1,j) - p(i-1,j+1)}{4\\Delta x} & \\frac{p(i,j+1) - p(i,j)}{\\Delta y} \\end{pmatrix} } $$"
        },
        {
            "introduction": "To solidify the theoretical concepts, this final practice provides a computational demonstration of the A-grid's flaws in a more realistic physical context: geostrophic balance. You will write code to explicitly show how a checkerboard pressure mode contaminates a geostrophically balanced state, quantifying the resulting imbalance that a model would experience . This exercise bridges theory and practice by not only diagnosing the problem but also implementing a common mitigation strategy—numerical filtering—to demonstrate how modelers manage such grid-scale noise.",
            "id": "3785687",
            "problem": "Consider the linearized, inviscid, constant-depth shallow-water momentum equations under geostrophic balance on an $f$-plane, where the Coriolis parameter $f$ is constant and gravitational acceleration is $g$. The geostrophic balance states that $f \\mathbf{u} = -g \\hat{\\mathbf{k}} \\times \\nabla \\eta$, where $\\mathbf{u} = (u,v)$ is the horizontal velocity vector, $\\eta$ is the free-surface elevation, and $\\hat{\\mathbf{k}}$ is the unit vector normal to the horizontal plane. In Cartesian components this yields $-f v = -g \\, \\partial \\eta / \\partial x$ and $f u = -g \\, \\partial \\eta / \\partial y$. On a discrete, uniform Arakawa A-grid (collocated grid), all prognostic variables $u$, $v$, and $\\eta$ are defined at identical grid points. Centered finite differences are used to approximate spatial derivatives with periodic boundary conditions.\n\nYour task is to demonstrate that the Arakawa A-grid admits collocation-induced spurious modes that contaminate the discrete geostrophic relationship unless additional smoothing or filtering is applied. Specifically, you will:\n\n1. Start from the discrete geostrophic relations formulated on a uniform, periodic Arakawa A-grid using second-order centered finite differences for spatial derivatives. Define the discrete operators $D_x$ and $D_y$ for $\\partial / \\partial x$ and $\\partial / \\partial y$, respectively, and the discrete Laplacian operator $\\nabla^2 = D_{xx} + D_{yy}$ constructed from second-order centered differences.\n\n2. Given a smooth free-surface elevation field $\\eta_s(x,y)$ that is well-resolved on the grid, construct a geostrophically balanced velocity field $(u_s, v_s)$ using the discrete relations $f u_s = -g D_y \\eta_s$ and $-f v_s = -g D_x \\eta_s$. Then contaminate the elevation by superposing a grid-scale checkerboard mode $\\eta_{cb}(i,j) = A \\, (-1)^{i+j}$ to form $\\eta_t = \\eta_s + \\eta_{cb}$, while leaving $(u_s, v_s)$ unchanged. This models the collocation-induced spurious mode that is invisible to centered gradients on the Arakawa A-grid.\n\n3. Invert the geostrophic relations to reconstruct an elevation $\\eta_{\\text{inv}}$ from $(u_s, v_s)$ by forming the discrete Poisson equation for $\\eta$,\n$$\n\\nabla^2 \\eta = \\frac{f}{g}\\left(D_x v - D_y u\\right),\n$$\nand solving it with periodic boundary conditions using a spectral method based on the Fast Fourier Transform (FFT). Set the zero-wavenumber component of $\\eta_{\\text{inv}}$ to zero to define a unique solution.\n\n4. Define the geostrophic imbalance norm as the root-mean-square (RMS) difference between a target elevation and the geostrophically inverted elevation. Compute two RMS norms:\n   - The unsmoothed imbalance $N_{\\text{unsm}} = \\left(\\frac{1}{N_x N_y}\\sum_{i=0}^{N_y-1}\\sum_{j=0}^{N_x-1}\\left[\\eta_t(i,j) - \\eta_{\\text{inv}}(i,j)\\right]^2\\right)^{1/2}$.\n   - The smoothed imbalance $N_{\\text{sm}}$ computed after applying an isotropic, repeated one-two-one filter to $\\eta_t$:\n     $$\n     \\eta^{(k+1)}(i,j) = \\frac{1}{4}\\left(\\eta^{(k)}(i,j-1) + 2 \\eta^{(k)}(i,j) + \\eta^{(k)}(i,j+1)\\right),\n     $$\n     $$\n     \\eta^{(k+1)}(i,j) \\leftarrow \\frac{1}{4}\\left(\\eta^{(k+1)}(i-1,j) + 2 \\eta^{(k+1)}(i,j) + \\eta^{(k+1)}(i+1,j)\\right),\n     $$\n     with periodic indexing in both directions, repeated for a prescribed number of steps $K$. The final filtered elevation is $\\eta_{\\text{sm}} = \\eta^{(K)}$. Compute $N_{\\text{sm}}$ by replacing $\\eta_t$ with $\\eta_{\\text{sm}}$ in the RMS formula above.\n\n5. Use the following test suite of parameter sets to evaluate different regimes and edge cases. For each case, define grid, physical parameters, and fields as follows:\n   - The domain is doubly periodic with lengths $L_x$ and $L_y$ and $N_x \\times N_y$ grid points, giving spacings $\\Delta x = L_x / N_x$ and $\\Delta y = L_y / N_y$.\n   - The smooth elevation field is $\\eta_s(x,y) = H_s \\cos\\left(2\\pi m x/L_x\\right)\\cos\\left(2\\pi n y/L_y\\right)$ sampled at grid points, with integers $m$ and $n$.\n   - The checkerboard amplitude is $A$ in meters.\n   - The filter is applied for $K$ steps as specified.\n\nProvide results in meters. Use the following test cases:\n   1. Case 1 (well-resolved smooth field, no checkerboard): $N_x = 64$, $N_y = 64$, $L_x = 100000$ m, $L_y = 100000$ m, $f = 10^{-4}$ s$^{-1}$, $g = 9.81$ m s$^{-2}$, $H_s = 1$ m, $m = 4$, $n = 3$, $A = 0$ m, $K = 2$.\n   2. Case 2 (moderate checkerboard contamination): same as Case 1 but $A = 0.5$ m, $K = 2$.\n   3. Case 3 (strong checkerboard contamination): same as Case 1 but $A = 2.0$ m, $K = 2$.\n   4. Case 4 (coarser grid, higher smooth wavenumbers): $N_x = 32$, $N_y = 32$, $L_x = 100000$ m, $L_y = 100000$ m, $f = 10^{-4}$ s$^{-1}$, $g = 9.81$ m s$^{-2}$, $H_s = 1$ m, $m = 8$, $n = 8$, $A = 1.0$ m, $K = 4$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as\n$[N_{\\text{unsm}}^{(1)}, N_{\\text{sm}}^{(1)}, N_{\\text{unsm}}^{(2)}, N_{\\text{sm}}^{(2)}, N_{\\text{unsm}}^{(3)}, N_{\\text{sm}}^{(3)}, N_{\\text{unsm}}^{(4)}, N_{\\text{sm}}^{(4)}]$,\nwhere the superscript indicates the test case number. Express all values in meters as floating-point numbers.",
            "solution": "The solution demonstrates the geostrophic imbalance caused by spurious checkerboard modes on an Arakawa A-grid.\n\n**1. Discretization and the Spurious Mode**\nOn an A-grid, all variables are collocated. The geostrophic balance equations are discretized using second-order centered differences ($D_x, D_y$). A key flaw of this scheme is that the discrete gradient operators are blind to the highest-frequency mode the grid can resolve, the checkerboard pattern $\\eta_{cb}(i,j) = A (-1)^{i+j}$. Applying the discrete gradient operators to this pattern yields exactly zero:\n$$ (D_x \\eta_{cb})_{i,j} = \\frac{A(-1)^{i+j+1} - A(-1)^{i+j-1}}{2\\Delta x} = 0 $$\n$$ (D_y \\eta_{cb})_{i,j} = \\frac{A(-1)^{i+1+j} - A(-1)^{i-1+j}}{2\\Delta y} = 0 $$\nThis means that a non-physical checkerboard elevation field can be added to a physically balanced smooth field, $\\eta_t = \\eta_s + \\eta_{cb}$, without changing the discrete pressure gradients. The velocity field $(u_s, v_s)$, which is calculated from $\\eta_s$ alone, is therefore only in balance with $\\eta_s$, not with the total field $\\eta_t$. This decoupling creates a geostrophic imbalance.\n\n**2. Inversion via Poisson Equation**\nTo find the elevation field that is truly in geostrophic balance with a given velocity field $(u_s, v_s)$, we formulate and solve a Poisson equation. Taking the divergence of the discrete geostrophic momentum equations gives the relative vorticity $\\zeta_d = D_x v - D_y u$. Combining this with the momentum equations themselves yields the discrete Poisson equation for elevation:\n$$ \\nabla_d^2 \\eta = D_{xx}\\eta + D_{yy}\\eta = \\frac{f}{g} \\zeta_d $$\nThis equation is solved for $\\eta_{\\text{inv}}$ given the vorticity $\\zeta_d$ calculated from $(u_s, v_s)$. On a periodic domain, this is most efficiently done using the Fast Fourier Transform (FFT). The method involves transforming the right-hand side into Fourier space, dividing by the Fourier representation of the discrete Laplacian operator, and transforming back. To ensure a unique solution, the mean of the result (the zero-wavenumber component) is set to zero. Since $(u_s, v_s)$ were derived from the zero-mean field $\\eta_s$, the resulting $\\eta_{\\text{inv}}$ will be a very close approximation to $\\eta_s$.\n\n**3. Quantifying Imbalance and Filtering**\nThe geostrophic imbalance is quantified by the Root-Mean-Square (RMS) difference between a target elevation and the inverted, balanced elevation $\\eta_{\\text{inv}}$.\n- The **unsmoothed imbalance** $N_{\\text{unsm}} = \\text{RMS}(\\eta_t - \\eta_{\\text{inv}}) = \\text{RMS}((\\eta_s + \\eta_{cb}) - \\eta_{\\text{inv}})$. Because $\\eta_{\\text{inv}} \\approx \\eta_s$, this error is dominated by the checkerboard mode, and we expect $N_{\\text{unsm}} \\approx \\text{RMS}(\\eta_{cb}) = A$.\n- The **smoothed imbalance** $N_{\\text{sm}} = \\text{RMS}(\\eta_{\\text{sm}} - \\eta_{\\text{inv}})$ is calculated after applying a low-pass numerical filter to $\\eta_t$. The specified one-two-one filter is designed to strongly damp high-frequency grid-scale noise. Its transfer function is zero for the checkerboard mode, so it effectively removes this dominant source of error. Therefore, $N_{\\text{sm}}$ is expected to be much smaller than $N_{\\text{unsm}}$, quantifying the filter's success in restoring a state of near-geostrophic balance. The small remaining error is due to the filter's slight modification of the physical signal $\\eta_s$.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Demonstrates the Arakawa A-grid spurious mode problem and its mitigation.\n    \"\"\"\n\n    def create_discrete_operators(Nx, Ny, dx, dy):\n        \"\"\"Creates functions for discrete differential operators.\"\"\"\n        \n        def d_dx(phi):\n            return (np.roll(phi, -1, axis=1) - np.roll(phi, 1, axis=1)) / (2 * dx)\n\n        def d_dy(phi):\n            return (np.roll(phi, -1, axis=0) - np.roll(phi, 1, axis=0)) / (2 * dy)\n            \n        return d_dx, d_dy\n\n    def solve_poisson_fft(rhs, Nx, Ny, dx, dy):\n        \"\"\"Solves the 2D periodic Poisson equation using FFT.\"\"\"\n        # Wavenumbers for real FFT\n        kx = 2 * np.pi * np.fft.rfftfreq(Nx, d=dx)\n        ky = 2 * np.pi * np.fft.fftfreq(Ny, d=dy)\n        Kx, Ky = np.meshgrid(kx, ky)\n\n        # Fourier representation of the 2nd-order centered difference Laplacian\n        lap_fourier = (2 / dx**2 * (np.cos(Kx * dx) - 1)) + \\\n                      (2 / dy**2 * (np.cos(Ky * dy) - 1))\n\n        # Perform FFT on the right-hand side\n        rhs_hat = np.fft.rfft2(rhs)\n\n        # Solve in Fourier space\n        solution_hat = np.zeros_like(rhs_hat)\n        \n        # Avoid division by zero at the zero-wavenumber\n        non_zero_k = lap_fourier != 0\n        solution_hat[non_zero_k] = rhs_hat[non_zero_k] / lap_fourier[non_zero_k]\n        \n        # Enforce zero mean for the solution\n        solution_hat[0, 0] = 0.0\n\n        # Transform back to physical space\n        solution = np.fft.irfft2(solution_hat, s=(Ny, Nx))\n        \n        return solution\n\n    def apply_one_two_one_filter(phi, K):\n        \"\"\"Applies a 2D one-two-one filter K times.\"\"\"\n        phi_filtered = phi.copy()\n        for _ in range(K):\n            # X-direction pass\n            phi_filtered = 0.25 * (np.roll(phi_filtered, 1, axis=1) + 2 * phi_filtered + np.roll(phi_filtered, -1, axis=1))\n            # Y-direction pass\n            phi_filtered = 0.25 * (np.roll(phi_filtered, 1, axis=0) + 2 * phi_filtered + np.roll(phi_filtered, -1, axis=0))\n        return phi_filtered\n\n    def run_case(params):\n        \"\"\"Runs a single test case.\"\"\"\n        Nx, Ny, Lx, Ly, f, g, Hs, m, n, A, K = params\n\n        dx = Lx / Nx\n        dy = Ly / Ny\n\n        # Create grid\n        x = np.arange(Nx) * dx\n        y = np.arange(Ny) * dy\n        xx, yy = np.meshgrid(x, y)\n\n        # Create discrete operators\n        D_x, D_y = create_discrete_operators(Nx, Ny, dx, dy)\n        \n        # 1. Construct smooth elevation field\n        eta_s = Hs * np.cos(2 * np.pi * m * xx / Lx) * np.cos(2 * np.pi * n * yy / Ly)\n\n        # 2. Compute geostrophically balanced velocities from eta_s\n        u_s = -(g / f) * D_y(eta_s)\n        v_s = (g / f) * D_x(eta_s)\n\n        # 3. Contaminate elevation with checkerboard mode\n        ii, jj = np.meshgrid(np.arange(Nx), np.arange(Ny), indexing='ij')\n        eta_cb = A * (-1)**(ii + jj)\n        eta_t = eta_s + eta_cb\n\n        # 4. Invert for eta_inv from (u_s, v_s)\n        relative_vorticity = D_x(v_s) - D_y(u_s)\n        poisson_rhs = (f / g) * relative_vorticity\n        eta_inv = solve_poisson_fft(poisson_rhs, Nx, Ny, dx, dy)\n        \n        # 5. Compute unsmoothed imbalance norm\n        diff_unsm = eta_t - eta_inv\n        N_unsm = np.sqrt(np.mean(diff_unsm**2))\n\n        # 6. Apply filter to get eta_sm\n        eta_sm = apply_one_two_one_filter(eta_t, K)\n\n        # 7. Compute smoothed imbalance norm\n        diff_sm = eta_sm - eta_inv\n        N_sm = np.sqrt(np.mean(diff_sm**2))\n\n        return N_unsm, N_sm\n\n    test_cases = [\n        # Nx, Ny, Lx(m), Ly(m), f(s-1), g(m/s2), Hs(m), m, n, A(m), K\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 0.0, 2), # Case 1\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 0.5, 2), # Case 2\n        (64, 64, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 4, 3, 2.0, 2), # Case 3\n        (32, 32, 100000.0, 100000.0, 1e-4, 9.81, 1.0, 8, 8, 1.0, 4), # Case 4\n    ]\n\n    results = []\n    for case in test_cases:\n        N_unsm, N_sm = run_case(case)\n        results.extend([N_unsm, N_sm])\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}