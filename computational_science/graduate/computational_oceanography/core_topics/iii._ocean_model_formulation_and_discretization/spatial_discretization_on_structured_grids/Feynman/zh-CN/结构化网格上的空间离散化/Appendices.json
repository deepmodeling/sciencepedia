{
    "hands_on_practices": [
        {
            "introduction": "有限差分方法的基础在于对导数进行精确的近似。本练习将引导你通过一个严谨的推导过程，为任意阶精度的中心差分格式导出其系数，这是理解和开发数值格式的一项基本技能。通过这个实践 ，你将掌握如何利用泰勒级数展开来构建满足特定精度要求的数值算子。",
            "id": "3810594",
            "problem": "考虑在一个间距为 $h$ 的均匀、结构化海洋模型网格上采样的一维光滑示踪剂场 $u(x)$ 的纬向梯度。您希望使用一个宽度为 $2m+1$ 个点（其中 $m \\in \\mathbb{N}$）的中心模板，在网格点 $x_{i}$ 处通过以下公式来近似 $\\partial_{x} u$：\n$$\n\\partial_{x} u(x_{i}) \\approx \\frac{1}{h} \\sum_{j=-m}^{m} c_{j} \\, u(x_{i} + j h),\n$$\n其中系数 $c_{j}$ 是无量纲的，并且与 $h$ 和 $x_{i}$ 无关。使用关于 $x_{i}$ 的泰勒级数匹配条件，推导系数 $c_{j}$，使得在这个均匀网格上，$\\partial_{x} u(x_{i})$ 的截断误差达到 $\\mathcal{O}(h^{2m})$ 阶。您的推导应从 $u(x_{i} + j h)$ 关于 $x_{i}$ 的泰勒展开开始，要求该公式对最高 $2m$ 次的多项式精确成立，并强制施加一阶导数的中心模板所隐含的必要对称性。请将您的最终结果表示为 $c_{j}$ 关于 $m$ 和 $j$ 的单个闭式解析表达式。\n\n不需要数值。请提供关于通用 $m$ 和 $j$ 的表达式。最终答案必须是单个闭式解析表达式（无单位）。",
            "solution": "用户希望我解决以下问题：\n考虑在一个间距为 $h$ 的均匀、结构化海洋模型网格上采样的一维光滑示踪剂场 $u(x)$ 的纬向梯度。您希望使用一个宽度为 $2m+1$ 个点（其中 $m \\in \\mathbb{N}$）的中心模板，在网格点 $x_{i}$ 处通过以下公式来近似 $\\partial_{x} u$：\n$$\n\\partial_{x} u(x_{i}) \\approx \\frac{1}{h} \\sum_{j=-m}^{m} c_{j} \\, u(x_{i} + j h),\n$$\n其中系数 $c_{j}$ 是无量纲的，并且与 $h$ 和 $x_{i}$ 无关。使用关于 $x_{i}$ 的泰勒级数匹配条件，推导系数 $c_{j}$，使得在这个均匀网格上，$\\partial_{x} u(x_{i})$ 的截断误差达到 $\\mathcal{O}(h^{2m})$ 阶。您的推导应从 $u(x_{i} + j h)$ 关于 $x_{i}$ 的泰勒展开开始，要求该公式对最高 $2m$ 次的多项式精确成立，并强制施加一阶导数的中心模板所隐含的必要对称性。请将您的最终结果表示为 $c_{j}$ 关于 $m$ 和 $j$ 的单个闭式解析表达式。\n\n不需要数值。请提供关于通用 $m$ 和 $j$ 的表达式。最终答案必须是单个闭式解析表达式（无单位）。\n\n### 第 1 步：提取已知条件\n- 待微分的场是一个光滑函数 $u(x)$。\n- 网格是均匀且结构化的，间距为 $h$。\n- 在点 $x_i$ 处一阶导数 $\\partial_x u$ 的近似由以下公式给出：$\\partial_{x} u(x_{i}) \\approx \\frac{1}{h} \\sum_{j=-m}^{m} c_{j} \\, u(x_{i} + j h)$。\n- 模板是中心的，宽度为 $2m+1$ 个点，其中 $m \\in \\mathbb{N}$。\n- 系数 $c_j$ 是无量纲的，且与 $h$ 和 $x_i$ 无关。\n- 期望的截断误差为 $\\mathcal{O}(h^{2m})$ 阶。\n- 推导方法是使用泰勒级数匹配，这等价于要求该公式对所有最高为 $2m$ 次的多项式都精确成立。\n- 必须强制施加一阶导数中心模板的对称性。\n- 最终目标是得到一个用 $m$ 和 $j$ 表示的关于 $c_j$ 的单个闭式解析表达式。\n\n### 第 2 步：使用提取的已知条件进行验证\n这个问题具有科学依据，因为它是数值分析中发展有限差分格式的一个基本问题，而有限差分格式广泛应用于计算科学与工程，包括计算海洋学。这个问题是适定的；它要求为给定的模板大小和精度阶数找到一组唯一的系数，这是一个被称为待定系数法的标准过程。问题陈述是客观的，并使用了精确的数学语言。没有矛盾、缺失信息或不切实际的假设。这个问题并非无足轻重，需要严谨的数学推导。\n\n### 第 3 步：结论与行动\n问题有效。我将继续推导解决方案。\n\n### 推导过程\n问题是求有限差分近似\n$$\n\\partial_{x} u(x_{i}) \\approx \\frac{1}{h} \\sum_{j=-m}^{m} c_{j} u(x_{i} + j h)\n$$\n的系数 $c_j$，使得该近似具有 $\\mathcal{O}(h^{2m})$ 阶的截断误差。\n\n我们首先将 $u(x_{i} + jh)$ 在点 $x_i$ 处进行泰勒级数展开：\n$$\nu(x_i + jh) = \\sum_{k=0}^{\\infty} \\frac{(jh)^k}{k!} \\frac{d^k u}{dx^k}\\bigg|_{x=x_i}\n$$\n将此展开式代入有限差分公式，得到：\n$$\n\\frac{1}{h} \\sum_{j=-m}^{m} c_{j} \\sum_{k=0}^{\\infty} \\frac{(jh)^k}{k!} u^{(k)}(x_i)\n$$\n其中 $u^{(k)}(x_i)$ 表示 $u$ 在 $x_i$ 处的 $k$ 阶导数。我们可以交换求和顺序：\n$$\n\\sum_{k=0}^{\\infty} \\frac{h^{k-1}}{k!} u^{(k)}(x_i) \\left( \\sum_{j=-m}^{m} c_j j^k \\right)\n$$\n我们希望这个表达式是 $\\partial_x u(x_i) = u^{(1)}(x_i)$ 的最佳近似。这意味着我们必须将级数中 $u^{(k)}(x_i)$ 的系数与目标表达式 $1 \\cdot u^{(1)}(x_i)$ 中的系数进行匹配。\n这就导出了一个关于系数 $c_j$ 的线性方程组：\n$$\n\\frac{h^{k-1}}{k!} \\left( \\sum_{j=-m}^{m} c_j j^k \\right) = \\delta_{k,1}\n$$\n其中 $\\delta_{k,1}$ 是克罗内克 delta 符号。这必须对尽可能多的 $k$ 值成立。该模板有 $2m+1$ 个点，允许我们指定 $2m+1$ 个约束条件。为了使格式的截断误差达到 $\\mathcal{O}(h^{2m})$ 阶，我们必须确保该公式对于最高 $2m$ 次的多项式是精确的，这对应于满足 $k=0, 1, \\dots, 2m$ 的条件。\n该方程组为：\n$$\n\\sum_{j=-m}^{m} c_j j^k = \\delta_{k,1}, \\quad \\text{对于 } k = 0, 1, 2, \\dots, 2m\n$$\n- 对于 $k=0$：$\\sum_{j=-m}^{m} c_j = 0$\n- 对于 $k=1$：$\\sum_{j=-m}^{m} c_j j = 1$\n- 对于 $k \\in \\{2, 3, \\dots, 2m\\}$：$\\sum_{j=-m}^{m} c_j j^k = 0$\n\n解决这个方程组的一个巧妙且具有建设性的方法是考虑拉格朗日插值多项式的微分。我们构造一个次数最多为 $2m$ 的多项式 $P(x)$，它在 $2m+1$ 个模板点 $\\{x_i + jh\\}_{j=-m}^m$ 上对函数 $u(x)$ 进行插值。导数的近似值即为 $u'(x_i) \\approx P'(x_i)$。\n\n让我们定义一个局部坐标 $s = (x-x_i)/h$，因此插值节点是整数 $s \\in \\{-m, \\dots, m\\}$。节点 $j$ 的拉格朗日基多项式为：\n$$\n\\ell_j(s) = \\prod_{\\substack{k=-m \\\\ k \\neq j}}^{m} \\frac{s-k}{j-k}\n$$\n插值多项式为 $p(s) = \\sum_{j=-m}^{m} u(x_i+jh) \\ell_j(s)$。关于 $x$ 的导数通过链式法则与关于 $s$ 的导数相关联：$\\frac{d}{dx} = \\frac{ds}{dx}\\frac{d}{ds} = \\frac{1}{h}\\frac{d}{ds}$。\n在 $x=x_i$（对应于 $s=0$）处计算导数，得到：\n$$\nP'(x_i) = \\frac{1}{h} \\frac{dp}{ds}\\bigg|_{s=0} = \\frac{1}{h} \\sum_{j=-m}^{m} u(x_i+jh) \\ell_j'(0)\n$$\n通过将其与给定的有限差分公式进行比较，我们确定系数为 $c_j = \\ell_j'(0)$。\n\n为了计算 $\\ell_j'(0)$，我们将 $\\ell_j(s)$ 写成 $N_j(s)/D_j$，其中分子是 $N_j(s) = \\prod_{k=-m, k \\neq j}^{m} (s-k)$，分母是常数 $D_j = \\prod_{k=-m, k \\neq j}^{m} (j-k)$。\n首先，我们分析 $j \\neq 0$ 的情况。我们可以将 $N_j(s)$ 表示为 $\\frac{P(s)}{s-j}$，其中 $P(s) = \\prod_{k=-m}^{m} (s-k)$。\n导数为 $N_j'(s) = \\frac{P'(s)(s-j) - P(s)}{(s-j)^2}$。\n在 $s=0$ 处，这给出 $N_j'(0) = \\frac{P'(0)(-j) - P(0)}{(-j)^2}$。由于 $P(s)$ 包含因子 $s$，我们有 $P(0)=0$。\n因此，$N_j'(0) = \\frac{-j P'(0)}{j^2} = -\\frac{P'(0)}{j}$。\n为了找到 $P'(0)$，我们将 $P(s)$ 写成 $P(s) = s \\prod_{k=1}^{m} (s-k) \\prod_{k=1}^{m} (s+k) = s \\prod_{k=1}^{m} (s^2-k^2)$。\n对 $s$ 求导得出 $P'(s) = \\prod_{k=1}^{m} (s^2-k^2) + s \\frac{d}{ds}\\left(\\prod_{k=1}^{m} (s^2-k^2)\\right)$。\n在 $s=0$ 处求值：$P'(0) = \\prod_{k=1}^{m} (-k^2) = (\\prod_{k=1}^{m} (-1)) (\\prod_{k=1}^{m} k^2) = (-1)^m (m!)^2$。\n因此，对于 $j \\neq 0$，$N_j'(0) = -\\frac{(-1)^m (m!)^2}{j}$。\n\n接下来，我们计算分母 $D_j = \\prod_{k=-m, k \\neq j}^{m} (j-k)$。\n$D_j = \\left(\\prod_{k=-m}^{j-1} (j-k)\\right) \\left(\\prod_{k=j+1}^{m} (j-k)\\right)$。\n第一部分是 $(j-(-m))\\cdots(j-(j-1)) = (j+m)\\cdots(1) = (j+m)!$。\n第二部分是 $(j-(j+1))\\cdots(j-m) = (-1)\\cdots(j-m)$。有 $m-j$ 个项，所以这个乘积是 $(-1)^{m-j} (m-j)!$。\n因此，$D_j = (m+j)! (-1)^{m-j} (m-j)!$。\n\n结合这些结果来求 $j \\neq 0$ 时的 $c_j$：\n$$\nc_j = \\frac{N_j'(0)}{D_j} = \\frac{-\\frac{(-1)^m (m!)^2}{j}}{(-1)^{m-j}(m+j)!(m-j)!} = \\frac{(-1)^{1+m-(m-j)}}{j} \\frac{(m!)^2}{(m+j)!(m-j)!}\n$$\n$$\nc_j = \\frac{(-1)^{j+1}}{j} \\frac{(m!)^2}{(m+j)!(m-j)!}\n$$\n这个公式对 $j \\in \\{-m, \\ldots, -1, 1, \\ldots, m\\}$ 有效。\n\n对于 $j=0$ 的情况，我们必须找到 $c_0 = \\ell'_0(0)$。\n问题指定了一阶导数的中心模板，这意味着反对称性，$c_{-j} = -c_j$。对于 $j=0$，这要求 $c_0 = -c_0$，即 $c_0=0$。\n另外，从我们的方程组来看，条件 $\\sum_{j=-m}^{m} c_j = 0$ 必须成立。\n推导出的 $j \\neq 0$ 的系数满足反对称性：\n$$\nc_{-j} = \\frac{(-1)^{-j+1}}{-j} \\frac{(m!)^2}{(m-j)!(m+j)!} = - \\frac{(-1)^{-j+1}}{j} \\frac{(m!)^2}{(m-j)!(m+j)!} = - \\frac{(-1)^{j+1}}{j} \\frac{(m!)^2}{(m+j)!(m-j)!} = -c_j\n$$\n因为 $(-1)^{-j+1} = (-1)^{-j+1+2j} = (-1)^{j+1}$。\n使用这个性质，当 $k=0$ 时的和变为：\n$$\n\\sum_{j=-m}^{m} c_j = c_0 + \\sum_{j=1}^{m} (c_j + c_{-j}) = c_0 + \\sum_{j=1}^{m} (c_j - c_j) = c_0\n$$\n因为这个和必须为零，所以我们必须有 $c_0=0$。因此，中心点的系数为零。\n\n系数 $c_j$ 的最终表达式由下式给出：\n$c_0=0$ 且对于 $j \\in \\{-m, \\dots, m\\}$ 且 $j \\neq 0$：\n$$\nc_j = \\frac{(-1)^{j+1}}{j} \\frac{(m!)^2}{(m+j)!(m-j)!}\n$$\n该公式提供了用于一阶导数的 $(2m+1)$ 点中心差分公式的系数，其精度为 $\\mathcal{O}(h^{2m})$ 阶。",
            "answer": "$$\n\\boxed{\\frac{(-1)^{j+1}}{j} \\frac{(m!)^2}{(m+j)!(m-j)!}}\n$$"
        },
        {
            "introduction": "对于物理系统而言，数值格式除了需要具备数学上的精度，还必须尊重基本的守恒定律。本练习  将提供验证离散质量守恒的动手经验，这是任何可靠的流体动力学模型的基石。你将通过编程实践，检验在不同边界条件下，一个精心设计的有限体积格式是如何确保总质量（或体积，在不可压缩流中）不发生虚假增减的。",
            "id": "3810605",
            "problem": "考虑一个结构化、均匀、矩形网格上的二维水平不可压缩海洋流场。从恒定密度流体的质量守恒定律开始，该定律可简化为水平速度的散度为零，即 $\\nabla \\cdot \\mathbf{u} = 0$。根据散度定理，域上散度的积分等于通过边界的净通量。在均匀网格上的有限体积 (FV) 离散化中，每个单元中的散度是根据面法向流计算出的单位面积净向外通量。在本问题中，你将在一个均匀笛卡尔网格上设计一个守恒离散算子，并验证所有单元上的离散积分散度等于净边界通量。对于具有周期性边界或零法向流的封闭边界的不可压缩测试场，此净通量必须为零。对于指定的开放边界，净通量必须等于规定的边界流入减去流出。\n\n给定一个均匀网格，在 $x$ 方向有 $N_x$ 个单元，在 $y$ 方向有 $N_y$ 个单元，覆盖一个长度为 $L_x$ (米) 和 $L_y$ (米) 的域。单元宽度为 $\\Delta x = L_x / N_x$ 和 $\\Delta y = L_y / N_y$。单元中心位于 $(x_i, y_j)$，其中 $x_i = (i + 1/2)\\Delta x$，$y_j = (j + 1/2)\\Delta y$，$i \\in \\{0, 1, \\dots, N_x - 1\\}$ 且 $j \\in \\{0, 1, \\dots, N_y - 1\\}$。\n\n通过一个平滑的流函数 $\\psi(x,y)$ 定义测试速度场，以确保在连续层面上的不可压缩性，其中 $u(x,y) = \\partial \\psi / \\partial y$ 和 $v(x,y) = - \\partial \\psi / \\partial x$，$u$ 是速度的 $x$ 分量，$v$ 是速度的 $y$ 分量，单位为米/秒。使用解析流函数 $\\psi(x,y) = A \\sin\\left( 2\\pi x / L_x \\right)\\sin\\left( 2\\pi y / L_y \\right)$，其中 $A$ 的单位是平方米/秒，$x$ 和 $y$ 的单位是米，这样 $u$ 和 $v$ 在整个域上都是良定义且平滑的。通过对 $\\psi$ 进行解析微分，在单元中心计算 $u$ 和 $v$。\n\n对于离散 FV 散度，采用以下设计决策：\n- 对于内面，通过对相邻单元中心值的算术平均，将单元中心速度线性插值到面上，以获得面法向速度，并乘以面长度得到面法向通量，单位为平方米/秒。\n- 对于周期性边界，环绕索引，使得 $i = N_x - 1$ 处的面连接到 $i = 0$ 处，$j = N_y - 1$ 处的面连接到 $j = 0$ 处，从而将这些面与内面等效处理。\n- 对于封闭边界（无法向流动的壁面），将外部边界上的法向通量设置为零。\n- 对于开放边界，在 $x$ 法向面上规定均匀的边界法向速度：西边界（$i=0$）处为 $u_{\\text{west}}$，东边界（$i=N_x-1$）处为 $u_{\\text{east}}$，单位均为米/秒。对于本问题，除非另有规定，否则在 $y$ 法向边界上将法向通量设置为零（无法向流动的壁面）。规定的边界速度直接用于计算边界面的法向通量，即乘以面长度。\n\n将离散净通量定义为离散散度的面积分，计算方法为所有单元的离散散度乘以单元面积 $\\Delta x \\Delta y$ 的总和。对于守恒的 FV 格式，这个总和等效于所有外部边界上向外面法向通量的代数和。离散净通量的单位是平方米/秒。\n\n实现一个程序，该程序：\n- 为每个测试用例构建网格和来自流函数的解析速度场。\n- 使用算术平均计算内面的面法向通量，并使用指定的边界规则计算边界面的面法向通量。\n- 将离散净通量计算为所有单元的净向外通量贡献的总和。\n- 检查净通量的绝对值是否低于按问题尺度缩放的容差，从而确认离散质量守恒。容差必须计算为 $\\epsilon = 10^{-9} \\max(L_x, L_y) U_{\\text{scale}} + 10^{-12}$，单位为平方米/秒，其中 $U_{\\text{scale}}$ 是内部 $u$ 和 $v$ 速度以及任何规定的边界速度的绝对值的最大值。\n\n你的程序应生成一行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，每个测试用例对应一个布尔值，表示是否确认了离散质量守恒。例如，格式必须与 $[ \\text{True}, \\text{False}, \\dots ]$ 完全一样，不得有任何附加文本。\n\n使用以下测试套件，它探讨了周期性、壁面边界、平衡的开放边界以及一个不平衡的开放边界情况：\n\n- 测试用例 1（周期性域，不可压缩解析场）：\n  - $N_x = 64$，$N_y = 64$，$L_x = 10^5$ 米，$L_y = 2\\times 10^5$ 米，$A = 10^4$ 平方米/秒。\n  - $x$ 边界条件是周期性的，$y$ 边界条件是周期性的。\n\n- 测试用例 2（封闭壁面，不可压缩解析场）：\n  - $N_x = 64$，$N_y = 64$，$L_x = 10^5$ 米，$L_y = 2\\times 10^5$ 米，$A = 10^4$ 平方米/秒。\n  - $x$ 边界条件是封闭壁面（零法向通量），$y$ 边界条件是封闭壁面（零法向通量）。\n\n- 测试用例 3（$x$ 方向为具有平衡流入/流出的开放边界，$y$ 方向为壁面）：\n  - $N_x = 64$，$N_y = 64$，$L_x = 10^5$ 米，$L_y = 2\\times 10^5$ 米，$A = 10^4$ 平方米/秒。\n  - $x$ 边界条件是开放的，具有均匀规定的速度 $u_{\\text{west}} = 0.3$ 米/秒和 $u_{\\text{east}} = 0.3$ 米/秒，$y$ 边界条件是封闭壁面（零法向通量）。\n\n- 测试用例 4（$x$ 方向为具有不平衡流入/流出的开放边界，$y$ 方向为壁面）：\n  - $N_x = 64$，$N_y = 64$，$L_x = 10^5$ 米，$L_y = 2\\times 10^5$ 米，$A = 10^4$ 平方米/秒。\n  - $x$ 边界条件是开放的，具有均匀规定的速度 $u_{\\text{west}} = 0.3$ 米/秒和 $u_{\\text{east}} = 0.25$ 米/秒，$y$ 边界条件是封闭壁面（零法向通量）。\n\n你的程序必须为每个测试用例评估离散净通量（单位为平方米/秒），应用上述容差检查，并以精确格式 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4]$ 在单行上输出布尔结果。",
            "solution": "其科学基础是恒定密度流体的质量守恒，在二维情况下表示为 $\\nabla \\cdot \\mathbf{u} = 0$。散度定理断言 $\\int_{\\Omega} \\nabla \\cdot \\mathbf{u}\\, \\mathrm{d}A = \\oint_{\\partial \\Omega} \\mathbf{u} \\cdot \\mathbf{n}\\, \\mathrm{d}s$，其中 $\\Omega$ 是域，$\\partial \\Omega$ 是边界。在均匀结构化网格上的有限体积 (FV) 离散化中，一个单元中 $\\mathbf{u}$ 的散度被定义为单位面积的净向外通量，由面法向通量计算得出。将所有单元的离散散度相加并乘以单元面积 $\\Delta x \\Delta y$ 会得到一个伸缩求和，其中内面的贡献成对抵消，只剩下外部边界通量的贡献。因此，离散净通量等于外部边界通量的代数和，这与连续的散度定理一致。对于周期性域或具有封闭壁面（零法向通量）的域中的不可压缩测试场，离散净通量必须为零，而对于开放边界，净通量等于规定的流入减去流出。\n\n我们构建一个均匀笛卡尔网格，在 $x$ 方向有 $N_x$ 个单元，在 $y$ 方向有 $N_y$ 个单元，覆盖长度为 $L_x$ 和 $L_y$ 的区域。单元宽度为 $\\Delta x = L_x / N_x$ 和 $\\Delta y = L_y / N_y$。单元中心位于 $(x_i, y_j)$，其中 $x_i = (i + 1/2)\\Delta x$，$y_j = (j + 1/2)\\Delta y$。\n\n为了确保在连续层面上的不可压缩性，我们定义一个流函数 $\\psi(x,y) = A \\sin\\left( 2\\pi x / L_x \\right)\\sin\\left( 2\\pi y / L_y \\right)$，其中 $A$ 的单位是平方米/秒。速度由 $\\mathbf{u} = (u,v)$ 导出，其中 $u(x,y) = \\partial \\psi / \\partial y = A \\left( \\frac{2\\pi}{L_y} \\right) \\sin\\left( \\frac{2\\pi x}{L_x} \\right)\\cos\\left( \\frac{2\\pi y}{L_y} \\right)$，$v(x,y) = -\\partial \\psi / \\partial x = -A \\left( \\frac{2\\pi}{L_x} \\right)\\cos\\left( \\frac{2\\pi x}{L_x} \\right)\\sin\\left( \\frac{2\\pi y}{L_y} \\right)$。这些解析公式在单元中心 $(x_i, y_j)$ 处被评估以产生 $u_{i,j}$ 和 $v_{i,j}$。\n\n在 FV 框架中，面法向通量是面法向速度乘以面长度。对于内面，我们通过对相邻单元中心速度进行算术平均，将法向速度线性插值到面上。具体来说，对于单元 $(i,j)$ 的东面和西面，面法向速度由 $u_{i,j}$ 与其在 $x$ 方向上的相邻值的平均值近似；对于北面和南面，面法向速度由 $v_{i,j}$ 与其在 $y$ 方向上的相邻值的平均值近似。面法向通量即为插值速度乘以面长度（$x$ 法向面为 $\\Delta y$，$y$ 法向面为 $\\Delta x$）。对于周期性边界，使用索引环绕，使得 $i = N_x - 1$ 处的面连接到 $i = 0$ 处，$j = N_y - 1$ 处的面连接到 $j = 0$ 处。对于封闭壁面，外部边界的面法向通量设置为零。对于开放边界，边界面的法向通量由给定的均匀边界法向速度规定：西边界上为 $u_{\\text{west}} \\Delta y$，东边界上为 $u_{\\text{east}} \\Delta y$；除非另有说明，$y$ 法向边界保持封闭（零通量）。\n\n单元 $(i,j)$ 中的离散散度使用四个面的净向外通量除以单位面积来计算。当计算整个域的离散净通量时，直接对每个单元的净向外通量贡献 $(F_{\\text{east}} - F_{\\text{west}}) + (F_{\\text{north}} - F_{\\text{south}})$ 求和是高效的，这等于单元散度乘以 $\\Delta x \\Delta y$。将此量在所有单元上求和，会导致内面贡献的抵消（因为每个内面通量在一个单元中以正号出现一次，在其邻居中以负号出现一次），最终只剩下外部边界通量的代数和。结果的单位是平方米/秒。\n\n为确认离散质量守恒，我们将离散净通量的绝对值与一个根据流场幅度和域大小缩放的容差进行比较。我们定义 $U_{\\text{scale}}$ 为内部速度 $u_{i,j}$ 和 $v_{i,j}$ 以及任何规定的边界速度的绝对值的最大值。容差为 $\\epsilon = 10^{-9} \\max(L_x, L_y) U_{\\text{scale}} + 10^{-12}$，单位是平方米/秒。如果绝对净通量小于或等于 $\\epsilon$，我们宣布守恒得到确认（布尔值 $\\text{True}$），否则为 $\\text{False}$。\n\n对于测试套件：\n- 测试用例 1 在两个方向上都使用周期性边界和解析不可压缩场。内部抵消和周期性环绕意味着离散净通量为零；布尔值应为 $\\text{True}$。\n- 测试用例 2 在两个方向上都使用封闭壁面。所有外部边界通量均为零，因此净通量应为零；布尔值应为 $\\text{True}$。\n- 测试用例 3 在 $x$ 方向使用具有平衡流入和流出（$u_{\\text{west}} = u_{\\text{east}} = 0.3$ 米/秒）的开放边界，在 $y$ 方向使用封闭壁面。东、西边界上的外部边界通量相互抵消，导致净通量为零；布尔值应为 $\\text{True}$。\n- 测试用例 4 在 $x$ 方向使用具有不平衡流入和流出（$u_{\\text{west}} = 0.3$ 米/秒，$u_{\\text{east}} = 0.25$ 米/秒）的开放边界，在 $y$ 方向使用封闭壁面。净通量约为 $(u_{\\text{east}} - u_{\\text{west}}) L_y \\approx (0.25 - 0.3)\\times 2\\times 10^5 = -10^4$ 平方米/秒（负号表示净流入），其量级远超容差，因此布尔值应为 $\\text{False}$。\n\n该程序为每个测试用例计算离散净通量，应用容差检查，并以指定格式在单行上输出一个布尔值列表 $[\\text{result}_1,\\text{result}_2,\\text{result}_3,\\text{result}_4]$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef construct_velocity_field(Nx, Ny, Lx, Ly, A):\n    \"\"\"\n    Construct analytic divergence-free velocity field from streamfunction:\n    psi(x,y) = A * sin(2*pi*x/Lx) * sin(2*pi*y/Ly)\n    u = dpsi/dy, v = -dpsi/dx\n    Evaluated at cell centers.\n    \"\"\"\n    dx = Lx / Nx\n    dy = Ly / Ny\n    i = np.arange(Nx)\n    j = np.arange(Ny)\n    x = (i + 0.5) * dx  # cell center x\n    y = (j + 0.5) * dy  # cell center y\n    X, Y = np.meshgrid(x, y, indexing=\"ij\")\n    # Analytic velocities\n    u = A * (2.0 * np.pi / Ly) * np.sin(2.0 * np.pi * X / Lx) * np.cos(2.0 * np.pi * Y / Ly)\n    v = -A * (2.0 * np.pi / Lx) * np.cos(2.0 * np.pi * X / Lx) * np.sin(2.0 * np.pi * Y / Ly)\n    return u, v, dx, dy\n\ndef compute_net_flux(u, v, dx, dy, bc_x, bc_y, U_west=0.0, U_east=0.0, V_south=0.0, V_north=0.0):\n    \"\"\"\n    Compute discrete net flux (m^2/s) by summing per-cell net outward flux contributions.\n    bc_x, bc_y: 'periodic', 'wall', or 'open'\n    For 'open' in x, use U_west and U_east (m/s). For y, V_south and V_north (m/s), though\n    test suite keeps y closed.\n    \"\"\"\n    Nx, Ny = u.shape\n    flux_sum = 0.0\n\n    # Helper functions to get face fluxes\n    for i in range(Nx):\n        for j in range(Ny):\n            # East face flux\n            if bc_x == 'periodic':\n                u_e = 0.5 * (u[i, j] + u[(i + 1) % Nx, j])\n                F_e = u_e * dy\n            else:\n                if i  Nx - 1:\n                    u_e = 0.5 * (u[i, j] + u[i + 1, j])\n                    F_e = u_e * dy\n                else:\n                    if bc_x == 'open':\n                        F_e = U_east * dy\n                    else:  # 'wall'\n                        F_e = 0.0\n\n            # West face flux\n            if bc_x == 'periodic':\n                u_w = 0.5 * (u[i, j] + u[(i - 1) % Nx, j])\n                F_w = u_w * dy\n            else:\n                if i > 0:\n                    u_w = 0.5 * (u[i - 1, j] + u[i, j])\n                    F_w = u_w * dy\n                else:\n                    if bc_x == 'open':\n                        F_w = U_west * dy\n                    else:  # 'wall'\n                        F_w = 0.0\n\n            # North face flux\n            if bc_y == 'periodic':\n                v_n = 0.5 * (v[i, j] + v[i, (j + 1) % Ny])\n                F_n = v_n * dx\n            else:\n                if j  Ny - 1:\n                    v_n = 0.5 * (v[i, j] + v[i, j + 1])\n                    F_n = v_n * dx\n                else:\n                    if bc_y == 'open':\n                        F_n = V_north * dx\n                    else:  # 'wall'\n                        F_n = 0.0\n\n            # South face flux\n            if bc_y == 'periodic':\n                v_s = 0.5 * (v[i, j] + v[i, (j - 1) % Ny])\n                F_s = v_s * dx\n            else:\n                if j > 0:\n                    v_s = 0.5 * (v[i, j - 1] + v[i, j])\n                    F_s = v_s * dx\n                else:\n                    if bc_y == 'open':\n                        F_s = V_south * dx\n                    else:  # 'wall'\n                        F_s = 0.0\n\n            # Net outward flux contribution for this cell equals divergence * area\n            flux_sum += (F_e - F_w) + (F_n - F_s)\n\n    return flux_sum\n\ndef tolerance(Lx, Ly, u, v, U_west=0.0, U_east=0.0, V_south=0.0, V_north=0.0):\n    \"\"\"\n    Compute tolerance epsilon = 1e-9 * max(Lx, Ly) * U_scale + 1e-12 (m^2/s),\n    where U_scale is max of interior speeds and boundary speeds.\n    \"\"\"\n    U_scale_interior = max(np.max(np.abs(u)), np.max(np.abs(v)))\n    U_scale_boundary = max(abs(U_west), abs(U_east), abs(V_south), abs(V_north))\n    U_scale = max(U_scale_interior, U_scale_boundary)\n    eps = 1e-9 * max(Lx, Ly) * U_scale + 1e-12\n    return eps\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1: periodic in both directions\n        {\n            \"Nx\": 64, \"Ny\": 64, \"Lx\": 1e5, \"Ly\": 2e5, \"A\": 1e4,\n            \"bc_x\": \"periodic\", \"bc_y\": \"periodic\",\n            \"U_west\": 0.0, \"U_east\": 0.0, \"V_south\": 0.0, \"V_north\": 0.0,\n        },\n        # Test case 2: closed walls in both directions\n        {\n            \"Nx\": 64, \"Ny\": 64, \"Lx\": 1e5, \"Ly\": 2e5, \"A\": 1e4,\n            \"bc_x\": \"wall\", \"bc_y\": \"wall\",\n            \"U_west\": 0.0, \"U_east\": 0.0, \"V_south\": 0.0, \"V_north\": 0.0,\n        },\n        # Test case 3: open x-boundaries with balanced inflow/outflow, walls in y\n        {\n            \"Nx\": 64, \"Ny\": 64, \"Lx\": 1e5, \"Ly\": 2e5, \"A\": 1e4,\n            \"bc_x\": \"open\", \"bc_y\": \"wall\",\n            \"U_west\": 0.3, \"U_east\": 0.3, \"V_south\": 0.0, \"V_north\": 0.0,\n        },\n        # Test case 4: open x-boundaries with imbalanced inflow/outflow, walls in y\n        {\n            \"Nx\": 64, \"Ny\": 64, \"Lx\": 1e5, \"Ly\": 2e5, \"A\": 1e4,\n            \"bc_x\": \"open\", \"bc_y\": \"wall\",\n            \"U_west\": 0.3, \"U_east\": 0.25, \"V_south\": 0.0, \"V_north\": 0.0,\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        Nx = case[\"Nx\"]; Ny = case[\"Ny\"]\n        Lx = case[\"Lx\"]; Ly = case[\"Ly\"]\n        A = case[\"A\"]\n        bc_x = case[\"bc_x\"]; bc_y = case[\"bc_y\"]\n        U_west = case[\"U_west\"]; U_east = case[\"U_east\"]\n        V_south = case[\"V_south\"]; V_north = case[\"V_north\"]\n\n        # Construct analytic divergence-free velocity field and grid metrics\n        u, v, dx, dy = construct_velocity_field(Nx, Ny, Lx, Ly, A)\n\n        # Compute discrete net flux (m^2/s)\n        net_flux = compute_net_flux(\n            u, v, dx, dy, bc_x, bc_y,\n            U_west=U_west, U_east=U_east, V_south=V_south, V_north=V_north\n        )\n\n        # Tolerance for conservation check\n        eps = tolerance(Lx, Ly, u, v, U_west=U_west, U_east=U_east, V_south=V_south, V_north=V_north)\n\n        # Conservation confirmed if |net_flux| = eps\n        results.append(abs(net_flux) = eps)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在之前概念的基础上，我们将进一步探索非线性动力学中更复杂物理量的守恒问题。本练习  深入研究了 Arakawa 提出的雅可比算子，这是地球物理流体动力学中的一个经典格式。你将通过实现和测试该格式，理解数值方法如何被巧妙地设计出来，以同时保持能量和拟涡能这两个对长期积分至关重要的物理不变量。",
            "id": "3810632",
            "problem": "您的任务是推导和验证在使用 Arakawa 雅可比格式的二维周期性结构化网格上的正压涡度方程的离散能量和拟能守恒。目标是从第一性原理出发，证明在没有外源强迫和扩散的情况下，该离散格式能保守这些不变量，并实现一个程序，在多个测试案例上数值验证其守恒特性。\n\n从 f 平面（科里奥利参数为常数）上的连续、无粘正压涡度方程开始：\n$$\n\\frac{\\partial \\zeta}{\\partial t} + J(\\psi, \\zeta) = 0,\n$$\n其中 $\\zeta$ 是相对涡度，$\\psi$ 是流函数，$J(\\psi, \\zeta)$ 是雅可比算子 $J(\\psi,\\zeta) = \\psi_x \\zeta_y - \\psi_y \\zeta_x$。对于二维不可压缩流，速度场通过流函数定义为 $u = -\\partial \\psi / \\partial y$ 和 $v = \\partial \\psi / \\partial x$，相对涡度满足 $\\zeta = \\nabla^2 \\psi$。\n\n定义连续不变量：\n- 单位密度的动能：\n$$\nE = \\frac{1}{2} \\int_{\\Omega} |\\nabla \\psi|^2 \\, dA = -\\frac{1}{2}\\int_{\\Omega} \\psi \\, \\zeta \\, dA,\n$$\n在周期性边界条件下。\n- 拟能：\n$$\nZ = \\frac{1}{2} \\int_{\\Omega} \\zeta^2 \\, dA.\n$$\n\n在均匀、周期性、结构化网格上离散化该区域，在 $x$ 方向上有 $N_x$ 个点，在 $y$ 方向上有 $N_y$ 个点，网格间距分别为 $d_x$ 和 $d_y$。用数组 $\\psi_{j,i}$ 和 $\\zeta_{j,i}$ 表示网格中心处的离散场，其中 $0 \\leq i \\leq N_x - 1$ 且 $0 \\leq j \\leq N_y - 1$，并在两个方向上施加周期性。对空间导数使用二阶中心差分。离散拉普拉斯算子为\n$$\n\\zeta_{j,i} = \\frac{\\psi_{j,i+1} - 2\\psi_{j,i} + \\psi_{j,i-1}}{d_x^2} + \\frac{\\psi_{j+1,i} - 2\\psi_{j,i} + \\psi_{j-1,i}}{d_y^2},\n$$\n其中指数周期性环绕。每个网格点上的 Arakawa 雅可比算子 $J^{A}(\\psi,\\zeta)$ 定义为三种二阶离散形式的平均值：\n$$\nJ^{A}(\\psi,\\zeta) = \\frac{1}{3}\\left(J_1 + J_2 + J_3\\right),\n$$\n其中\n$$\nJ_1 = \\frac{(\\psi_{j,i+1}-\\psi_{j,i-1})(\\zeta_{j+1,i}-\\zeta_{j-1,i}) - (\\psi_{j+1,i}-\\psi_{j-1,i})(\\zeta_{j,i+1}-\\zeta_{j,i-1})}{4 d_x d_y},\n$$\n$$\nJ_2 = \\frac{\\psi_{j,i+1}(\\zeta_{j+1,i+1}-\\zeta_{j-1,i+1}) - \\psi_{j,i-1}(\\zeta_{j+1,i-1}-\\zeta_{j-1,i-1}) - \\psi_{j+1,i}(\\zeta_{j+1,i+1}-\\zeta_{j+1,i-1}) + \\psi_{j-1,i}(\\zeta_{j-1,i+1}-\\zeta_{j-1,i-1})}{4 d_x d_y},\n$$\n$$\nJ_3 = \\frac{\\zeta_{j,i+1}(\\psi_{j+1,i+1}-\\psi_{j-1,i+1}) - \\zeta_{j,i-1}(\\psi_{j+1,i-1}-\\psi_{j-1,i-1}) - \\zeta_{j+1,i}(\\psi_{j+1,i+1}-\\psi_{j+1,i-1}) + \\zeta_{j-1,i}(\\psi_{j-1,i+1}-\\psi_{j-1,i-1})}{4 d_x d_y},\n$$\n所有指数都以 $N_x$ 和 $N_y$ 为模进行周期性解释。\n\n在周期性边界条件下，Arakawa 雅可比算子的设计使得以下离散内积为零，从而确保在没有强迫和扩散的情况下离散能量和拟能的守恒：\n$$\n\\sum_{j,i} \\psi_{j,i} \\, J^{A}(\\psi,\\zeta)_{j,i} \\, d_x d_y = 0, \\quad \\sum_{j,i} \\zeta_{j,i} \\, J^{A}(\\psi,\\zeta)_{j,i} \\, d_x d_y = 0.\n$$\n离散能量和拟能计算如下\n$$\nE_d = -\\frac{1}{2}\\sum_{j,i} \\psi_{j,i} \\, \\zeta_{j,i} \\, d_x d_y, \\quad Z_d = \\frac{1}{2}\\sum_{j,i} \\zeta_{j,i}^2 \\, d_x d_y.\n$$\n\n您的程序必须：\n1. 根据下述规范，在周期性网格上构建测试流函数 $\\psi_{j,i}$。\n2. 使用离散拉普拉斯算子计算 $\\zeta$。\n3. 使用 Arakawa 格式计算 $J^{A}(\\psi,\\zeta)$。\n4. 计算离散内积 $S_\\psi = \\sum \\psi \\, J^{A}(\\psi,\\zeta) \\, d_x d_y$ 和 $S_\\zeta = \\sum \\zeta \\, J^{A}(\\psi,\\zeta) \\, d_x d_y$。\n5. 对于每个测试案例，如果 $|S_\\psi|$ 和 $|S_\\zeta|$ 均小于一个固定的绝对容差 $T$，则返回布尔值 true，否则返回 false。在无量纲单位下使用 $T = 10^{-9}$。本次作业中所有量均视为无量纲；不使用物理单位。\n\n测试套件：\n- 案例 1 (理想情况)：$N_x = 32$，$N_y = 32$，$d_x = 1.0$，$d_y = 1.0$。用 $\\psi_{j,i} = \\sin\\left(2\\pi k_x x_i / L_x\\right) \\sin\\left(2\\pi k_y y_j / L_y\\right)$ 初始化，其中 $k_x=4$，$k_y=5$，$x_i = i d_x$，$y_j = j d_y$，$L_x = N_x d_x$，$L_y = N_y d_y$。\n- 案例 2 (各向异性网格)：$N_x = 64$，$N_y = 48$，$d_x = 1.0$，$d_y = 2.0$。用从种子为 $42$ 的标准正态分布中提取的可复现伪随机场初始化 $\\psi$。\n- 案例 3 (均匀场边界情况)：$N_x = 16$，$N_y = 16$，$d_x = 1.0$，$d_y = 1.0$。用 $\\psi_{j,i} = c$ 初始化，其中 $c = 2.0$ (常数)。\n- 案例 4 (最小周期分辨率)：$N_x = 3$，$N_y = 3$，$d_x = 1.0$，$d_y = 1.0$。用 $\\psi_{j,i} = i + 2 j$ 初始化 (一个周期性环绕的简单线性模式)。\n- 案例 5 (奇数尺寸，混合模态)：$N_x = 33$，$N_y = 31$，$d_x = 0.5$，$d_y = 0.7$。用 $\\psi_{j,i} = \\cos\\left(2\\pi m x_i / L_x\\right) + 0.5 \\sin\\left(2\\pi n y_j / L_y\\right)$ 初始化，其中 $m=3$，$n=7$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如“[result1,result2,result3,result4,result5]”。每个结果都必须是一个布尔值，表示对应测试案例的两个内积是否均低于容差。",
            "solution": "所提出的问题是计算流体动力学中一个适定且科学合理的问题，特别关注用于正压涡度方程的 Arakawa 雅可比算子的数值守恒特性。它要求从第一性原理出发，并通过数值验证来证明 Arakawa 离散格式保守动能和拟能的离散模拟量。该问题是自洽的，提供了所有必要的方程、参数和测试案例。\n\n### 问题验证\n\n**第 1 步：提取已知条件**\n\n- **控制方程**：$\\frac{\\partial \\zeta}{\\partial t} + J(\\psi, \\zeta) = 0$，其中 $\\zeta = \\nabla^2 \\psi$ 是相对涡度，$\\psi$ 是流函数，$J(\\psi, \\zeta) = \\psi_x \\zeta_y - \\psi_y \\zeta_x$ 是雅可比算子。\n- **连续不变量**：\n    - 动能：$E = \\frac{1}{2} \\int_{\\Omega} |\\nabla \\psi|^2 \\, dA = -\\frac{1}{2}\\int_{\\Omega} \\psi \\, \\zeta \\, dA$。\n    - 拟能：$Z = \\frac{1}{2} \\int_{\\Omega} \\zeta^2 \\, dA$。\n- **离散化**：均匀、周期性、结构化网格，有 $N_x \\times N_y$ 个点，间距为 $d_x, d_y$。\n- **离散拉普拉斯算子**：$\\zeta_{j,i} = \\frac{\\psi_{j,i+1} - 2\\psi_{j,i} + \\psi_{j,i-1}}{d_x^2} + \\frac{\\psi_{j+1,i} - 2\\psi_{j,i} + \\psi_{j-1,i}}{d_y^2}$。\n- **Arakawa 雅可比算子**：$J^{A}(\\psi,\\zeta) = \\frac{1}{3}\\left(J_1 + J_2 + J_3\\right)$，其中：\n    - $J_1 = \\frac{(\\psi_{j,i+1}-\\psi_{j,i-1})(\\zeta_{j+1,i}-\\zeta_{j-1,i}) - (\\psi_{j+1,i}-\\psi_{j-1,i})(\\zeta_{j,i+1}-\\zeta_{j,i-1})}{4 d_x d_y}$\n    - $J_2 = \\frac{\\psi_{j,i+1}(\\zeta_{j+1,i+1}-\\zeta_{j-1,i+1}) - \\psi_{j,i-1}(\\zeta_{j+1,i-1}-\\zeta_{j-1,i-1}) - \\psi_{j+1,i}(\\zeta_{j+1,i+1}-\\zeta_{j+1,i-1}) + \\psi_{j-1,i}(\\zeta_{j-1,i+1}-\\zeta_{j-1,i-1})}{4 d_x d_y}$\n    - $J_3 = \\frac{\\zeta_{j,i+1}(\\psi_{j+1,i+1}-\\psi_{j-1,i+1}) - \\zeta_{j,i-1}(\\psi_{j+1,i-1}-\\psi_{j-1,i-1}) - \\zeta_{j+1,i}(\\psi_{j+1,i+1}-\\psi_{j+1,i-1}) + \\zeta_{j-1,i}(\\psi_{j-1,i+1}-\\zeta_{j-1,i-1})}{4 d_x d_y}$\n- **离散守恒条件**：$\\sum_{j,i} \\psi_{j,i} \\, J^{A}(\\psi,\\zeta)_{j,i} \\, d_x d_y = 0$ 和 $\\sum_{j,i} \\zeta_{j,i} \\, J^{A}(\\psi,\\zeta)_{j,i} \\, d_x d_y = 0$。\n- **离散不变量**：\n    - 能量：$E_d = -\\frac{1}{2}\\sum_{j,i} \\psi_{j,i} \\, \\zeta_{j,i} \\, d_x d_y$。\n    - 拟能：$Z_d = \\frac{1}{2}\\sum_{j,i} \\zeta_{j,i}^2 \\, d_x d_y$。\n- **任务**：计算 $S_\\psi = \\sum \\psi \\, J^{A} \\, d_x d_y$ 和 $S_\\zeta = \\sum \\zeta \\, J^{A} \\, d_x d_y$。\n- **容差**：$T = 10^{-9}$。如果 $|S_\\psi|  T$ 且 $|S_\\zeta|  T$，则结果为 true。\n- **测试案例**：\n    1. $N_x=32, N_y=32, d_x=1, d_y=1$。$\\psi_{j,i} = \\sin(2\\pi k_x x_i / L_x) \\sin(2\\pi k_y y_j / L_y)$，其中 $k_x=4, k_y=5$。\n    2. $N_x=64, N_y=48, d_x=1, d_y=2$。$\\psi$ 为随机正态分布，种子为 $42$。\n    3. $N_x=16, N_y=16, d_x=1, d_y=1$。$\\psi_{j,i} = 2.0$。\n    4. $N_x=3, N_y=3, d_x=1, d_y=1$。$\\psi_{j,i} = i + 2j$。\n    5. $N_x=33, N_y=31, d_x=0.5, d_y=0.7$。$\\psi_{j,i} = \\cos(2\\pi m x_i / L_x) + 0.5 \\sin(2\\pi n y_j / L_y)$，其中 $m=3, n=7$。\n\n**第 2 步：使用提取的已知条件进行验证**\n该问题具有科学依据，适定且客观。它提出了一个对地球物理流体动力学中一个基础数值方法的标准验证研究。方程是正确的，参数是完整的，任务是明确的。\n\n**第 3 步：结论与行动**\n问题有效。将提供一个解决方案。\n\n### 基于原理的设计与求解\n\n#### 理论基础\n\n在周期性区域 $\\Omega$ 上，无粘正压涡度方程的连续动能 $E$ 和拟能 $Z$ 的时间演化由雅可比算子的性质决定。对不变量关于时间求导可得：\n\n$\\frac{dE}{dt} = \\frac{d}{dt} \\left(-\\frac{1}{2} \\int_{\\Omega} \\psi \\zeta \\, dA \\right) = -\\frac{1}{2} \\int_{\\Omega} \\left( \\psi_t \\zeta + \\psi \\zeta_t \\right) \\, dA$\n在周期性边界下，对第一项使用分部积分法（格林第一恒等式），$\\int \\psi_t \\zeta \\, dA = \\int \\psi_t \\nabla^2 \\psi \\, dA = -\\int \\nabla\\psi_t \\cdot \\nabla\\psi \\, dA$。对第二项应用相同的恒等式可得 $\\int \\psi \\zeta_t \\, dA = \\int \\psi \\nabla^2 \\psi_t \\, dA = -\\int \\nabla\\psi \\cdot \\nabla\\psi_t \\, dA$。因此，这两项相等，我们可以写成：\n$\\frac{dE}{dt} = -\\int_{\\Omega} \\psi \\zeta_t \\, dA$\n代入涡度方程 $\\zeta_t = -J(\\psi, \\zeta)$：\n$\\frac{dE}{dt} = \\int_{\\Omega} \\psi J(\\psi, \\zeta) \\, dA$\n\n类似地，对于拟能：\n$\\frac{dZ}{dt} = \\frac{d}{dt} \\left( \\frac{1}{2} \\int_{\\Omega} \\zeta^2 \\, dA \\right) = \\int_{\\Omega} \\zeta \\zeta_t \\, dA = -\\int_{\\Omega} \\zeta J(\\psi, \\zeta) \\, dA$\n\n能量和拟能的守恒（$dE/dt = 0$，$dZ/dt = 0$）取决于雅可比算子的积分性质：$\\int \\psi J(\\psi, \\zeta) \\, dA = 0$ 和 $\\int \\zeta J(\\psi, \\zeta) \\, dA = 0$。可以证明，在周期性区域上使用分部积分法，对于连续雅可比算子，这两个积分均为零。\n\n#### 离散模拟与 Arakawa 格式\n\n在离散化方程时，目标是找到一个离散雅可比算子 $J^A$，它能模仿这些关键的守恒性质。这确保了数值格式不会虚假地产生或耗散能量或拟能，从而实现更稳定和物理上一致的长期积分。离散能量 $E_d$ 和拟能 $Z_d$ 的时间导数分别为：\n\n$\\frac{dE_d}{dt} \\propto \\sum_{j,i} \\psi_{j,i} J^A_{j,i}$\n$\\frac{dZ_d}{dt} \\propto \\sum_{j,i} \\zeta_{j,i} J^A_{j,i}$\n\n其中求和遍及所有网格点。守恒要求这些和为零。标准的二阶中心差分近似雅可比算子不能保证这一点。\n\nAkio Arakawa 在其 1966 年的开创性论文中，引入了一种专门为满足这些离散守恒定律而构建的格式。算子 $J^A$ 是三种不同二阶精度模板（$J_1$、$J_2$ 和 $J_3$）的精心加权平均。每个分量的代数结构贡献了特定的守恒性质，它们的线性组合确保了两个二次不变量的守恒。实现这一点的基本数学原理是分部求和法，即分部积分法的离散模拟。当在周期性网格上求和时，离散雅可比算子中的各项会重新排列并抵消，从而在理论上迫使总和 $S_\\psi = \\sum \\psi J^A$ 和 $S_\\zeta = \\sum \\zeta J^A$ 精确为零。在浮点运算中，这些和将在机器精度范围内为零。\n\n#### 算法实现\n\n程序将为每个测试案例实现以下步骤：\n1.  **网格和场生成**：根据案例规范，构建二维网格坐标 $(x_i, y_j)$ 并初始化流函数数组 $\\psi_{j,i}$。\n2.  **涡度计算**：通过将所提供的二阶离散拉普拉斯算子应用于 $\\psi_{j,i}$，计算相对涡度场 $\\zeta_{j,i}$。这需要访问相邻的网格点，可以通过在周期性网格上使用数组移位操作来高效处理。\n3.  **Arakawa 雅可比算子计算**：在每个网格点上评估三个分量 $J_1$、$J_2$ 和 $J_3$。这是最复杂的一步，涉及大量访问第一、第二和对角相邻点的模板。同样，数组移位是同时在整个网格上实现这些模板的合适方法。最终的雅可比算子 $J^A$ 是这三个分量的平均值。\n4.  **守恒检查**：计算两个内积 $S_\\psi = d_x d_y \\sum_{j,i} \\psi_{j,i} J^A_{j,i}$ 和 $S_\\zeta = d_x d_y \\sum_{j,i} \\zeta_{j,i} J^A_{j,i}$。\n5.  **验证**：将 $S_\\psi$ 和 $S_\\zeta$ 的绝对值与指定的容差 $T=10^{-9}$ 进行比较。当且仅当两者都低于容差时，该案例通过。布尔结果被存储。\n\n此过程对各种场配置下的 Arakawa 雅可比算子的代数性质进行数值验证，以确认其守恒性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and verifies discrete conservation of energy and enstrophy for the\n    barotropic vorticity equation using the Arakawa Jacobian scheme.\n    \"\"\"\n    \n    test_cases = [\n        {'Nx': 32, 'Ny': 32, 'dx': 1.0, 'dy': 1.0, 'case_type': 'sinsin', 'params': {'kx': 4, 'ky': 5}},\n        {'Nx': 64, 'Ny': 48, 'dx': 1.0, 'dy': 2.0, 'case_type': 'random', 'params': {'seed': 42}},\n        {'Nx': 16, 'Ny': 16, 'dx': 1.0, 'dy': 1.0, 'case_type': 'constant', 'params': {'c': 2.0}},\n        {'Nx': 3, 'Ny': 3, 'dx': 1.0, 'dy': 1.0, 'case_type': 'linear', 'params': {}},\n        {'Nx': 33, 'Ny': 31, 'dx': 0.5, 'dy': 0.7, 'case_type': 'mixed_modes', 'params': {'m': 3, 'n': 7}}\n    ]\n    \n    TOLERANCE = 1e-9\n    results = []\n\n    for case in test_cases:\n        Nx, Ny, dx, dy = case['Nx'], case['Ny'], case['dx'], case['dy']\n        Lx, Ly = Nx * dx, Ny * dy\n\n        # 1. Construct test streamfunctions\n        x = np.arange(Nx) * dx\n        y = np.arange(Ny) * dy\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n        \n        psi = np.zeros((Ny, Nx))\n        \n        if case['case_type'] == 'sinsin':\n            kx, ky = case['params']['kx'], case['params']['ky']\n            # Note: The problem description has xx and yy swapped in indexing.\n            # Using standard meshgrid 'xy' indexing for visualization, but numpy 'ij' for array logic\n            xx_ij, yy_ij = np.meshgrid(x, y, indexing='ij')\n            psi = np.sin(2 * np.pi * kx * xx_ij / Lx) * np.sin(2 * np.pi * ky * yy_ij / Ly)\n        elif case['case_type'] == 'random':\n            seed = case['params']['seed']\n            rng = np.random.default_rng(seed)\n            psi = rng.standard_normal((Ny, Nx))\n        elif case['case_type'] == 'constant':\n            psi.fill(case['params']['c'])\n        elif case['case_type'] == 'linear':\n            # psi_j,i = i + 2j\n            psi = np.arange(Nx) + 2 * np.arange(Ny)[:, np.newaxis]\n        elif case['case_type'] == 'mixed_modes':\n            m, n = case['params']['m'], case['params']['n']\n            xx_ij, yy_ij = np.meshgrid(x, y, indexing='ij')\n            psi = np.cos(2 * np.pi * m * xx_ij / Lx) + 0.5 * np.sin(2 * np.pi * n * yy_ij / Ly)\n\n        # 2. Compute vorticity using discrete Laplacian\n        psi_ip1 = np.roll(psi, -1, axis=1)\n        psi_im1 = np.roll(psi, 1, axis=1)\n        psi_jp1 = np.roll(psi, -1, axis=0)\n        psi_jm1 = np.roll(psi, 1, axis=0)\n        \n        zeta = (psi_ip1 - 2*psi + psi_im1) / (dx**2) + \\\n               (psi_jp1 - 2*psi + psi_jm1) / (dy**2)\n               \n        # 3. Compute Arakawa Jacobian\n        # Pre-compute all shifted fields for clarity and efficiency\n        zeta_ip1 = np.roll(zeta, -1, axis=1)\n        zeta_im1 = np.roll(zeta, 1, axis=1)\n        zeta_jp1 = np.roll(zeta, -1, axis=0)\n        zeta_jm1 = np.roll(zeta, 1, axis=0)\n        \n        psi_jp1_ip1 = np.roll(psi, (-1, -1), axis=(0, 1))\n        psi_jm1_ip1 = np.roll(psi, (1, -1), axis=(0, 1))\n        psi_jp1_im1 = np.roll(psi, (-1, 1), axis=(0, 1))\n        psi_jm1_im1 = np.roll(psi, (1, 1), axis=(0, 1))\n\n        zeta_jp1_ip1 = np.roll(zeta, (-1, -1), axis=(0, 1))\n        zeta_jm1_ip1 = np.roll(zeta, (1, -1), axis=(0, 1))\n        zeta_jp1_im1 = np.roll(zeta, (-1, 1), axis=(0, 1))\n        zeta_jm1_im1 = np.roll(zeta, (1, 1), axis=(0, 1))\n\n        # J1\n        j1 = ((psi_ip1 - psi_im1) * (zeta_jp1 - zeta_jm1) - \n              (psi_jp1 - psi_jm1) * (zeta_ip1 - zeta_im1)) / (4 * dx * dy)\n        \n        # J2\n        j2 = (psi_ip1 * (zeta_jp1_ip1 - zeta_jm1_ip1) - \n              psi_im1 * (zeta_jp1_im1 - zeta_jm1_im1) -\n              psi_jp1 * (zeta_jp1_ip1 - zeta_jp1_im1) +\n              psi_jm1 * (zeta_jm1_ip1 - zeta_jm1_im1)) / (4 * dx * dy)\n\n        # J3\n        j3 = (zeta_ip1 * (psi_jp1_ip1 - psi_jm1_ip1) -\n              zeta_im1 * (psi_jp1_im1 - psi_jm1_im1) -\n              zeta_jp1 * (psi_jp1_ip1 - psi_jp1_im1) +\n              zeta_jm1 * (psi_jm1_ip1 - psi_jm1_im1)) / (4 * dx * dy)\n\n        j_arakawa = (j1 + j2 + j3) / 3.0\n\n        # 4. Compute discrete inner products\n        s_psi = np.sum(psi * j_arakawa) * dx * dy\n        s_zeta = np.sum(zeta * j_arakawa) * dx * dy\n        \n        # 5. Verify conservation\n        is_conserved = abs(s_psi)  TOLERANCE and abs(s_zeta)  TOLERANCE\n        results.append(is_conserved)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}