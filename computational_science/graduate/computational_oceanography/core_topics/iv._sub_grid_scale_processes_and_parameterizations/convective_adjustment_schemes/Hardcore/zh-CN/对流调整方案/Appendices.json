{
    "hands_on_practices": [
        {
            "introduction": "本节的第一个练习将回归到最基本的物理原理。在着手修正不稳定现象之前，我们必须能够准确地识别它。本练习将重点推导布伦特-维赛拉频率（Brunt-Väisälä frequency）的平方，$N^2$，这是判断连续分层流体静态稳定性的核心指标，为理解对流调整的必要性奠定了坚实的理论基础 。",
            "id": "3788352",
            "problem": "考虑一个占据深度为 $-100 \\le z \\le 0$ 米的一维海洋水柱，其中 $z$ 是垂直坐标，$z=0$ 位于海面，$z$ 轴向上为正。观测到的温度和盐度剖面随深度呈线性变化，由 $T(z) = T_{s} + \\gamma_{T} z$ 和 $S(z) = S_{s} + \\gamma_{S} z$ 给出，其中 $T_{s}$ 和 $S_{s}$ 是恒定的表面值，$\\gamma_{T}$ 和 $\\gamma_{S}$ 是恒定的垂直梯度。假设Boussinesq近似、静力平衡以及关于参考密度 $\\rho_{0}$ 的线性化状态方程成立，使得密度扰动满足 $\\rho' = -\\rho_{0}\\left(\\alpha\\,T' - \\beta\\,S'\\right)$，其中 $\\alpha$ 是热膨胀系数，$\\beta$ 是盐收缩系数。使用 $g = 9.81$ m s$^{-2}$，$\\alpha = 2\\times 10^{-4}$ K$^{-1}$，$\\beta = 8\\times 10^{-4}$ psu$^{-1}$，以及 $\\rho_{0} = 1025$ kg m$^{-3}$。从浮力 $b = -g\\,\\rho'/\\rho_{0}$ 和Brunt–Väisälä（浮力）频率的平方 $N^{2}(z) = \\partial b/\\partial z$ 的定义出发，推导一个用 $g$、$\\alpha$、$\\beta$、$\\gamma_{T}$ 和 $\\gamma_{S}$ 表示的 $N^{2}(z)$ 的解析表达式。然后，利用所推导表达式的符号，确定水柱中哪些深度会被一个对流调整方案标记为静力不稳定，该方案会瞬时均匀化任何 $N^{2}(z)  0$ 的子层。将最终的 $N^{2}(z)$ 表达式以 s$^{-2}$ 的国际单位制（SI）单位表示。只需报告 $N^{2}(z)$ 的解析表达式。不需要进行数值计算。",
            "solution": "首先验证问题，以确保其在科学上合理、良定且完整。\n\n### 第1步：提取已知条件\n- 域：一个一维海洋水柱，垂直坐标 $z$ 满足 $-100 \\le z \\le 0$ 米。$z=0$ 是海面。\n- 温度剖面：$T(z) = T_{s} + \\gamma_{T} z$，其中 $T_s$ 和 $\\gamma_T$ 是常数。\n- 盐度剖面：$S(z) = S_{s} + \\gamma_{S} z$，其中 $S_s$ 和 $\\gamma_S$ 是常数。\n- 近似：假设Boussinesq近似和静力平衡。\n- 线性化状态方程：密度扰动 $\\rho'$ 由 $\\rho' = -\\rho_{0}\\left(\\alpha\\,T' - \\beta\\,S'\\right)$ 给出，其中 $T'$ 和 $S'$ 分别是温度和盐度扰动。\n- 常数：\n    - 重力加速度：$g = 9.81$ m s$^{-2}$。\n    - 热膨胀系数：$\\alpha = 2\\times 10^{-4}$ K$^{-1}$。\n    - 盐收缩系数：$\\beta = 8\\times 10^{-4}$ psu$^{-1}$。\n    - 参考密度：$\\rho_{0} = 1025$ kg m$^{-3}$。\n- 定义：\n    - 浮力：$b = -g\\,\\rho'/\\rho_{0}$。\n    - Brunt–Väisälä（浮力）频率的平方：$N^{2}(z) = \\partial b/\\partial z$。\n- 任务：\n    1. 推导一个用 $g$、$\\alpha$、$\\beta$、$\\gamma_{T}$ 和 $\\gamma_{S}$ 表示的 $N^{2}(z)$ 的解析表达式。\n    2. 确定静力不稳定（$N^{2}(z)  0$）的深度。\n    3. 将最终的 $N^{2}(z)$ 表达式以 s$^{-2}$ 的国际单位制（SI）单位表示。\n    4. 只需报告 $N^{2}(z)$ 的解析表达式。\n\n### 第2步：使用提取的已知条件进行验证\n该问题有科学依据，使用了物理海洋学的标准概念和方程，例如Boussinesq近似、线性化状态方程，以及浮力和Brunt-Väisälä频率的定义。提供的数值常数符合物理实际。该问题是良定的；它提供了推导所求表达式所需的所有必要信息。语言客观明确。对最终输出的说明很具体，但没有引入任何与问题物理原理相矛盾的地方。因此，该问题被认为是有效的。\n\n### 第3步：结论与行动\n问题有效。现在开始推导解答。\n\n### 推导\nBrunt-Väisälä频率的平方 $N^{2}(z)$ 是流体柱静力稳定性的一个度量。它被定义为浮力的垂直梯度，即 $N^{2}(z) = \\partial b/\\partial z$。\n\n首先，我们建立浮力 $b(z)$ 的表达式。问题给出的定义是 $b = -g\\,\\rho'/\\rho_{0}$。密度扰动 $\\rho'$ 由线性化状态方程 $\\rho' = -\\rho_{0}(\\alpha T' - \\beta S')$ 给出。$T'$ 和 $S'$ 项代表与参考状态的偏差。为了计算背景剖面 $T(z)$ 和 $S(z)$ 的层化，相关的密度是 $\\rho(z) = \\rho_0(1 - \\alpha(T(z)-T_{ref}) + \\beta(S(z)-S_{ref}))$，其中 $T_{ref}$ 和 $S_{ref}$ 是恒定的参考值。相对于参考密度 $\\rho_0$ 的密度异常则为 $\\rho(z) - \\rho_0$。与此层化相关的浮力是 $b(z) = -g (\\rho(z)-\\rho_0)/\\rho_0 = g(\\alpha(T(z)-T_{ref}) - \\beta(S(z)-S_{ref}))$。\n\n为了求得 $N^{2}(z)$，我们将此 $b(z)$ 的表达式对垂直坐标 $z$ 求导：\n$$N^{2}(z) = \\frac{\\partial b}{\\partial z} = \\frac{\\partial}{\\partial z} \\left[ g\\left(\\alpha(T(z)-T_{ref}) - \\beta(S(z)-S_{ref})\\right) \\right]$$\n由于 $g$、$\\alpha$、$\\beta$、$T_{ref}$ 和 $S_{ref}$ 都是常数，微分得到：\n$$N^{2}(z) = g \\left( \\alpha \\frac{dT}{dz} - \\beta \\frac{dS}{dz} \\right)$$\n这是在给定的线性化状态方程下，Brunt-Väisälä频率平方的通用表达式。\n\n问题指定了温度和盐度的线性剖面：\n$T(z) = T_{s} + \\gamma_{T} z$\n$S(z) = S_{s} + \\gamma_{S} z$\n\n我们从这些剖面计算垂直梯度 $\\frac{dT}{dz}$ 和 $\\frac{dS}{dz}$：\n$$\\frac{dT}{dz} = \\frac{d}{dz} (T_{s} + \\gamma_{T} z) = \\gamma_{T}$$\n$$\\frac{dS}{dz} = \\frac{d}{dz} (S_{s} + \\gamma_{S} z) = \\gamma_{S}$$\n由于 $\\gamma_{T}$ 和 $\\gamma_{S}$ 是常数，温度和盐度的垂直梯度在整个水柱中是恒定的。\n\n将这些恒定的梯度代入 $N^{2}(z)$ 的表达式：\n$$N^{2}(z) = g \\left( \\alpha \\gamma_{T} - \\beta \\gamma_{S} \\right)$$\n由于右侧的所有项都是常数，因此 $N^{2}$ 本身也是一个常数，与深度 $z$ 无关。\n\n如果 $N^{2}(z)  0$，对流调整方案会将任何子层标记为静力不稳定。在本例中，由于 $N^{2}$ 是恒定的，该稳定性条件适用于整个水柱，即 $-100 \\le z \\le 0$ 米。不稳定的条件是：\n$$g \\left( \\alpha \\gamma_{T} - \\beta \\gamma_{S} \\right)  0$$\n由于 $g  0$，此不等式简化为：\n$$\\alpha \\gamma_{T} - \\beta \\gamma_{S}  0 \\quad \\text{或} \\quad \\alpha \\gamma_{T}  \\beta \\gamma_{S}$$\n如果满足此条件，则整个水柱都是静力不稳定的。如果 $\\alpha \\gamma_{T} \\ge \\beta \\gamma_{S}$，则整个水柱是稳定或中性的，其任何部分都不会被标记进行对流调整。\n\n对推導出的表达式的单位进行一致性检查。各项的单位是：\n- $[g]$ = m s$^{-2}$\n- $[\\alpha]$ = K$^{-1}$\n- $[\\gamma_T]$ = K m$^{-1}$\n- $[\\beta]$ = psu$^{-1}$ （psu是实用盐度单位，在此类计算中通常被视为无量纲的）\n- $[\\gamma_S]$ = psu m$^{-1}$\n\n因此，$N^{2}$ 的单位是：\n$$[\\text{m s}^{-2}] \\times ([\\text{K}^{-1}][\\text{K m}^{-1}] - [\\text{psu}^{-1}][\\text{psu m}^{-1}]) = [\\text{m s}^{-2}] \\times ([\\text{m}^{-1}] - [\\text{m}^{-1}]) = \\text{s}^{-2}$$\n该单位是频率平方的正确国际单位制（SI）单位。\n\n问题要求给出 $N^{2}(z)$ 的解析表达式。根据推导，该表达式为 $g(\\alpha \\gamma_T - \\beta \\gamma_S)$。",
            "answer": "$$\n\\boxed{g \\left( \\alpha \\gamma_{T} - \\beta \\gamma_{S} \\right)}\n$$"
        },
        {
            "introduction": "在建立了不稳定性的物理判据之后，这个练习将引导你将理论付诸实践，实现一个具体的数值解法。你将实现一种常见的对流调整方案，该方案通过识别并混合相邻的不稳定层来恢复稳定，并确保质量和示踪剂守恒——这是任何数值模型都必须满足的关键属性。通过这个练习，你将亲身体验在离散水体中恢复稳定性的过程 。",
            "id": "3788362",
            "problem": "考虑一个离散为 $N$ 层的一维垂直海洋水柱。每一层 $k \\in \\{0,1,\\dots,N-1\\}$ 都具有一个正厚度 $h_k$（单位为 $\\mathrm{m}$）、一个原位或位密度 $\\rho_k$（单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$）以及一个示踪剂浓度 $c_k$（例如，实用盐度），该浓度以实用盐度单位（psu，一个无量纲数）表示。示踪剂浓度受已知边界 $c_{\\min}$ 和 $c_{\\max}$ 的约束，即对于所有 $k$ 都有 $c_{\\min} \\leq c_k \\leq c_{\\max}$。如果密度随深度不减，即对于所有 $k \\in \\{0,1,\\dots,N-2\\}$ 都有 $\\rho_{k} \\leq \\rho_{k+1}$，则该水柱是稳定分层的。如果存在任何索引 $k$ 使得 $\\rho_{k}  \\rho_{k+1}$，则水柱包含一个静力不稳定对，并且必须应用垂直对流调整。\n\n您必须设计并实现一个对流调整方案，该方案通过在连续的不稳定块内均匀化示踪剂和密度来强制实现静力稳定性，同时保持分层的质量和示踪剂守恒。该方案必须：\n\n- 每当稳定性（$\\rho_{k} \\leq \\rho_{k+1}$）被破坏时，识别并合并相邻层成块，直到最终调整后的密度剖面 $\\tilde{\\rho}_k$ 随深度不减。\n- 对于每个由索引 $k \\in B$ 组成的混合块 $B$，使用块上的质量加权平均来计算调整后块内恒定的密度 $\\tilde{\\rho}_k$ 和示踪剂 $\\tilde{c}_k$。\n- 对每个测试用例，证明所有调整后的示踪剂值 $\\tilde{c}_k$ 都保持在原始边界 $[c_{\\min}, c_{\\max}]$ 内。\n- 确保最终调整后的密度剖面 $\\tilde{\\rho}_k$ 随深度不减。\n\n您的程序必须评估以下测试套件，在输入和计算中使用给定的单位。程序应仅输出布尔值，以指示每个测试用例是否同时满足以下两个条件：所有调整后的示踪剂值都在以 psu 表示的闭区间边界 $[c_{\\min}, c_{\\max}]$ 内，并且最终调整后的密度剖面（以 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ 表示）随深度不减。\n\n测试套件（每个用例指定了 $(h_k, \\rho_k, c_k, c_{\\min}, c_{\\max})$）：\n\n- 用例 A（一般不稳定的内部块）：\n  - 厚度 (单位 $\\mathrm{m}$): $[5.0, 7.5, 10.0, 12.5, 7.5]$\n  - 密度 (单位 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $[1025.5, 1026.0, 1024.5, 1023.0, 1027.0]$\n  - 示踪剂盐度 (单位 psu): $[34.2, 35.0, 33.0, 32.0, 36.0]$\n  - 边界 (单位 psu): $c_{\\min} = 0.0$, $c_{\\max} = 40.0$\n\n- 用例 B（整个水柱不稳定，包含极端示踪剂值）：\n  - 厚度 (单位 $\\mathrm{m}$): $[10.0, 10.0, 10.0, 10.0]$\n  - 密度 (单位 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $[1028.0, 1027.5, 1027.0, 1026.5]$\n  - 示踪剂盐度 (单位 psu): $[0.0, 40.0, 20.0, 35.0]$\n  - 边界 (单位 psu): $c_{\\min} = 0.0$, $c_{\\max} = 40.0$\n\n- 用例 C（已稳定的水柱，无需调整）：\n  - 厚度 (单位 $\\mathrm{m}$): $[8.0, 12.0, 15.0, 5.0]$\n  - 密度 (单位 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $[1023.0, 1024.0, 1025.0, 1026.0]$\n  - 示踪剂盐度 (单位 psu): $[33.5, 34.0, 34.5, 35.0]$\n  - 边界 (单位 psu): $c_{\\min} = 0.0$, $c_{\\max} = 40.0$\n\n- 用例 D（层厚度和示踪剂极端值对比大，整个水柱不稳定）：\n  - 厚度 (单位 $\\mathrm{m}$): $[1.0, 100.0, 1.0, 100.0]$\n  - 密度 (单位 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $[1026.0, 1025.0, 1024.0, 1023.0]$\n  - 示踪剂盐度 (单位 psu): $[0.0, 40.0, 0.0, 40.0]$\n  - 边界 (单位 psu): $c_{\\min} = 0.0$, $c_{\\max} = 40.0$\n\n算法和物理要求：\n\n- 仅在混合块内使用质量加权平均来计算调整后块内恒定的值 $\\tilde{\\rho}_k$ 和 $\\tilde{c}_k$。\n- 在由厚度 $h_k$ 给出的离散化下，精确保持总示踪剂质量和总水柱质量守恒。\n- 对所有 $k$ 强制执行静力稳定性约束 $\\tilde{\\rho}_k \\leq \\tilde{\\rho}_{k+1}$。\n- 对每个测试用例，验证并报告水柱中所有 $k$ 的最终调整后示踪剂值是否满足 $c_{\\min} \\leq \\tilde{c}_k \\leq c_{\\max}$。\n\n最终输出格式：\n\n您的程序应产生单行输出，其中包含四个测试用例的结果，格式为方括号内以逗号分隔的列表，例如 $[\\text{True},\\text{False},\\text{True},\\text{True}]$，其中每个布尔值按顺序对应于测试用例 $(\\text{A}, \\text{B}, \\text{C}, \\text{D})$。",
            "solution": "该问题要求为一维海洋水柱设计并实现一个对流调整方案。这是海洋模型中一种常见的参数化方法，用于消除静力不稳定性，即密度较大的水位于密度较小的水之上的情况。解决方案涉及识别此类不稳定性并模拟由此产生的垂直混合，这种混合会使不稳定区域内的属性均匀化。\n\n指导该方案的核心原则是在任何发生混合的流体块内，质量守恒和示踪剂守恒。水柱被离散化为 $N$ 层，对于 $k \\in \\{0, 1, \\dots, N-1\\}$，每层都具有厚度 $h_k$、密度 $\\rho_k$ 和示踪剂浓度 $c_k$。我们假定每层都有一个恒定的水平面积 $A$，该面积在所有计算中都会被约去，因此可以设为 $A=1$。第 $k$ 层的质量为 $m_k = \\rho_k V_k = \\rho_k (h_k A)$。第 $k$ 层的示踪剂量为 $C_k = c_k m_k = c_k \\rho_k h_k A$。\n\n当一个由索引集 $B$ 标识的连续层块变得不稳定并混合时，它会形成一个单一的、新的均匀层。根据守恒原则：\n1.  **质量守恒**：新层的总质量必须等于原始各层质量之和。\n2.  **示踪剂守恒**：新层中的示踪剂总量必须等于原始各层中示踪剂量之和。\n3.  **体积守恒**：新层的体积是原始各层体积之和。这意味着新厚度为 $\\tilde{h}_B = \\sum_{k \\in B} h_k$。\n\n根据这些原则，我们推导出均匀化块的属性。设新块具有属性 $\\tilde{h}_B, \\tilde{\\rho}_B, \\tilde{c}_B$。\n块中的总质量为 $M_B = \\sum_{k \\in B} m_k = A \\sum_{k \\in B} \\rho_k h_k$。总体积为 $V_B = A \\sum_{k \\in B} h_k = A \\tilde{h}_B$。\n新密度 $\\tilde{\\rho}_B$ 是总质量除以总体积：\n$$ \\tilde{\\rho}_B = \\frac{M_B}{V_B} = \\frac{A \\sum_{k \\in B} \\rho_k h_k}{A \\sum_{k \\in B} h_k} = \\frac{\\sum_{k \\in B} \\rho_k h_k}{\\sum_{k \\in B} h_k} $$\n这是初始密度的体积加权平均值。\n\n块中的示踪剂总量为 $C_B = \\sum_{k \\in B} C_k = A \\sum_{k \\in B} c_k \\rho_k h_k$。\n新示踪剂浓度 $\\tilde{c}_B$ 是示踪剂总量除以总质量：\n$$ \\tilde{c}_B = \\frac{C_B}{M_B} = \\frac{A \\sum_{k \\in B} c_k \\rho_k h_k}{A \\sum_{k \\in B} \\rho_k h_k} = \\frac{\\sum_{k \\in B} c_k \\rho_k h_k}{\\sum_{k \\in B} \\rho_k h_k} $$\n这是初始示踪剂浓度的质量加权平均值。\n\n如果对于任何相邻的层对 $k$ 和 $k+1$，有 $\\rho_k  \\rho_{k+1}$，则定义为存在不稳定性。算法必须解决所有此类不稳定性，直到整个水柱变得稳定，即对于所有 $k$ 都有 $\\tilde{\\rho}_k \\leq \\tilde{\\rho}_{k+1}$。对水柱进行单次遍历是不够的，因为合并两层可能会与合并块上方的层产生新的不稳定性。因此需要一个稳健的迭代方法。算法按以下步骤进行：\n\n1.  初始化一个指向最顶层的指针 $k=0$。\n2.  当 $k$ 小于倒数第二层的索引时，进行迭代。\n3.  在当前位置 $k$，比较密度 $\\rho_k$ 与其下一层的密度 $\\rho_{k+1}$。\n4.  如果 $\\rho_k  \\rho_{k+1}$（不稳定性），则合并第 $k$ 层和第 $k+1$ 层。使用上述平均公式计算索引 $k$ 处新层的属性。移除第 $k+1$ 层，总层数减一。合并后，新层可能与其上方（索引为 $k-1$）的层不稳定。为处理此问题，将指针 $k$ 后退一步，即 $k = \\max(0, k-1)$。\n5.  如果 $\\rho_k \\leq \\rho_{k+1}$（稳定），则通过增加指针移至下一对，$k = k+1$。\n6.  当指针遍历整个水柱而未发现任何不稳定性时，该过程终止。最终得到的密度剖面保证随深度不减。\n\n最后，我们必须为调整后的水柱验证两个条件：\n1.  最终密度剖面不减：对于所有 $k$ 都有 $\\tilde{\\rho}_{k} \\leq \\tilde{\\rho}_{k+1}$。所述算法的构建保证了这一结果。\n2.  所有最终示踪剂浓度 $\\tilde{c}_k$ 都在给定的边界 $[c_{\\min}, c_{\\max}]$ 内。$\\tilde{c}$ 的计算公式是初始浓度 $c_k$ 的加权平均，其中权重（质量 $\\rho_k h_k A$）均为正值。这类平均的一个特性是其结果必须位于输入值的范围之内。因为所有初始的 $c_k$ 都满足 $c_{\\min} \\leq c_k \\leq c_{\\max}$，所以任何混合值 $\\tilde{c}_k$ 也将满足 $c_{\\min} \\leq \\tilde{c}_k \\leq c_{\\max}$。\n\n因此，对于任何有效输入，一个正确实现的对流调整算法应始终产生一个满足这两个条件的结果。因此，每个测试用例的评估都应得出 `True`。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the convective adjustment scheme for all test cases\n    and print the verification results.\n    \"\"\"\n\n    test_cases = [\n        {\n            # Case A: General unstable interior block\n            \"h\": [5.0, 7.5, 10.0, 12.5, 7.5],\n            \"rho\": [1025.5, 1026.0, 1024.5, 1023.0, 1027.0],\n            \"c\": [34.2, 35.0, 33.0, 32.0, 36.0],\n            \"c_min\": 0.0,\n            \"c_max\": 40.0,\n        },\n        {\n            # Case B: Entire column unstable, extreme tracer values included\n            \"h\": [10.0, 10.0, 10.0, 10.0],\n            \"rho\": [1028.0, 1027.5, 1027.0, 1026.5],\n            \"c\": [0.0, 40.0, 20.0, 35.0],\n            \"c_min\": 0.0,\n            \"c_max\": 40.0,\n        },\n        {\n            # Case C: Already stable column, no adjustment needed\n            \"h\": [8.0, 12.0, 15.0, 5.0],\n            \"rho\": [1023.0, 1024.0, 1025.0, 1026.0],\n            \"c\": [33.5, 34.0, 34.5, 35.0],\n            \"c_min\": 0.0,\n            \"c_max\": 40.0,\n        },\n        {\n            # Case D: Large contrast in layer thicknesses and tracer extremes\n            \"h\": [1.0, 100.0, 1.0, 100.0],\n            \"rho\": [1026.0, 1025.0, 1024.0, 1023.0],\n            \"c\": [0.0, 40.0, 0.0, 40.0],\n            \"c_min\": 0.0,\n            \"c_max\": 40.0,\n        },\n    ]\n\n    def run_convective_adjustment(h_in, rho_in, c_in):\n        \"\"\"\n        Applies the convective adjustment algorithm to a water column.\n\n        Args:\n            h_in (list): Initial layer thicknesses.\n            rho_in (list): Initial layer densities.\n            c_in (list): Initial layer tracer concentrations.\n\n        Returns:\n            tuple: A tuple containing the adjusted lists (h_adj, rho_adj, c_adj).\n        \"\"\"\n        # Use lists for dynamic resizing during merging.\n        h_adj = list(h_in)\n        rho_adj = list(rho_in)\n        c_adj = list(c_in)\n\n        k = 0\n        # The loop must continue until a full pass without merges is completed.\n        while k  len(rho_adj) - 1:\n            # Check for instability\n            if rho_adj[k] > rho_adj[k+1]:\n                # Unstable pair found, merge layers k and k+1.\n                \n                # Properties of layer k\n                h1, rho1, c1 = h_adj[k], rho_adj[k], c_adj[k]\n                \n                # Properties of layer k+1\n                h2, rho2, c2 = h_adj[k+1], rho_adj[k+1], c_adj[k+1]\n\n                # Mass per unit area\n                m1 = rho1 * h1\n                m2 = rho2 * h2\n                total_mass = m1 + m2\n                \n                # Total tracer amount\n                tracer_amount1 = c1 * m1\n                tracer_amount2 = c2 * m2\n                total_tracer_amount = tracer_amount1 + tracer_amount2\n\n                # New merged layer properties\n                new_h = h1 + h2\n                # New density is volume-weighted average\n                new_rho = total_mass / new_h\n                # New tracer is mass-weighted average\n                new_c = total_tracer_amount / total_mass\n                \n                # Update layer k with merged properties\n                h_adj[k] = new_h\n                rho_adj[k] = new_rho\n                c_adj[k] = new_c\n                \n                # Remove layer k+1\n                h_adj.pop(k+1)\n                rho_adj.pop(k+1)\n                c_adj.pop(k+1)\n                \n                # Step back to check for instability with the layer above\n                k = max(0, k - 1)\n            else:\n                # Stable pair, move to the next one\n                k += 1\n        \n        return h_adj, rho_adj, c_adj\n\n    results = []\n    for case in test_cases:\n        h, rho, c, c_min, c_max = case[\"h\"], case[\"rho\"], case[\"c\"], case[\"c_min\"], case[\"c_max\"]\n\n        # Run the adjustment\n        h_adj, rho_adj, c_adj = run_convective_adjustment(h, rho, c)\n        \n        # --- Verification Step ---\n        \n        # 1. Verify stability: final density profile is non-decreasing\n        is_stable = all(rho_adj[k] = rho_adj[k+1] for k in range(len(rho_adj) - 1))\n        \n        # 2. Verify tracer bounds: all tracer values are within [c_min, c_max]\n        are_bounds_kept = all(c_min = val = c_max for val in c_adj)\n        \n        # The result is True if and only if both conditions are met.\n        results.append(is_stable and are_bounds_kept)\n\n    # Format the final output as a comma-separated list of booleans in brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在前一个练习实现的基础上，这最后一个练习将挑战你从模式开发者的角度思考问题，专注于算法的效率和稳健性。它对比了一种简单的迭代混合方法与一种更高级的、全局最优的方案，后者不仅能确保守恒性和确定性，还具有更优的计算性能 ($O(N \\log N)$)。该问题突显了在构建高质量、大规模海洋模型时所需做出的关键算法设计抉择 。",
            "id": "3788326",
            "problem": "您正在一个静力平衡 Boussinesq 海洋模型中实现一个单柱对流调整。该水柱被离散为 $N$ 个欧拉层，索引为 $i \\in \\{1,\\dots,N\\}$，各层具有厚度 $\\Delta z_i  0$、原位密度 $\\rho_i$ 和标量示踪物 $q_i$（例如，位温或溶解无机碳）。一个对流调整步骤必须产生一个静力稳定的密度剖面（密度随深度单调不减），在绝热重排下最小化重力势能，保持柱积分质量和示踪物守恒，并且即使在多个层具有相同密度时，在不同计算架构上也能保持确定性。\n\n仅从以下原则出发：\n- 静力稳定性要求密度不随深度减小，这等效于通过重新排序水块使得 $\\rho$ 随深度单调不减来实现。\n- 在绝热重排下，通过按密度对水块进行垂向排序，可以达到重力势能的最小值。\n- 守恒要求调整后的示踪物剖面 $q_i^{\\star}$ 满足 $\\sum_{i=1}^{N} \\Delta z_i \\, q_i^{\\star} = \\sum_{i=1}^{N} \\Delta z_i \\, q_i$，对于任何其他被动示踪物也同样如此，且层厚度保持不变。\n- 在 $\\rho$ 存在相同值的情况下，确定性要求有一个不受浮点数误差或运行时迭代顺序影响的平局打破规则。\n\n您寻求一个计算复杂度为 $O(N \\log N)$ 或更优的实现。请考虑以下算法设计：\n\nA. 对水块按复合键 $(\\rho_i, i)$ 进行稳定排序，其中 $i$ 是原始索引，得到一个排列 $p(\\cdot)$。按排序后的顺序，定义厚度前缀和 $H_k = \\sum_{j=1}^{k} \\Delta z_{p(j)}$ 和示踪物质量前缀和 $M_k^{(q)} = \\sum_{j=1}^{k} \\Delta z_{p(j)} \\, q_{p(j)}$。将排好序的列视为在累积厚度坐标上是分段常数。通过计算该排序剖面在每个区间 $[Z_{i-1}, Z_i)$ 上的精确层平均值，来重构原始网格上调整后的层平均示踪物，其中 $Z_i = \\sum_{m=1}^{i} \\Delta z_m$。这个计算利用部分和来评估必要的区间交集，时间复杂度为 $O(N)$。对任何示踪物应用相同的程序。排序成本占主导地位，产生 $O(N \\log N)$ 的复杂度。\n\nB. 重复扫描该列，如果 $\\rho_i  \\rho_{i+1}$，则将相邻的不稳定对 $(i,i+1)$ 替换为其厚度加权平均值来进行混合，直到没有密度倒置为止。如果一次扫描没有做任何更改，则提前退出。此过程避免了排序，并保证了局部守恒，并且相同密度通过扫描顺序被隐式处理。\n\nC. 对密度进行不稳定排序，对相等的 $\\rho$ 不进行平局打破处理，然后在排序后，通过将 $q$ 从排序后的坐标线性插值回原始深度来分配 $q_i^{\\star}$。这避免了重映射积分并减少了内存流量。对于相等的密度，排序可以选择任何顺序。\n\nD. 仅按位温对水块进行排序，忽略盐度，因为在许多地区，温度对密度的影响占主导地位。然后如设计 A 那样形成前缀和并进行重映射。这比在排序过程中评估非线性状态方程要便宜得多，并且温度的单调性往往意味着密度的单调性。\n\n哪种设计满足静力稳定性，最小化重力势能，精确守恒每列中的质量和示踪物，在存在密度相同值时具有确定性，并达到 $O(N \\log N)$ 的时间复杂度？选择最佳选项，并从稳定性、守恒性和算法复杂度的第一性原理出发，论证您的选择。",
            "solution": "在进行求解之前，需要对问题陈述进行验证。\n\n### 步骤 1：提取给定信息\n- **模型背景**：一个单柱静力平衡 Boussinesq 海洋模型。\n- **离散化**：$N$ 个欧拉层，索引为 $i \\in \\{1, \\dots, N\\}$。\n- **层属性**：\n    - 厚度：$\\Delta z_i  0$。\n    - 原位密度：$\\rho_i$。\n    - 标量示踪物：$q_i$。\n- **调整方案的必要属性**：\n    1.  产生一个静力稳定的密度剖面（密度随深度单调不减）。\n    2.  在绝热重排下最小化重力势能 (GPE)。\n    3.  保持柱积分的质量和示踪物守恒。\n    4.  具有确定性，尤其是在多个层具有相同密度时。\n- **指导原则**：\n    1.  **稳定性**：通过重新排序水块使 $\\rho$ 随深度单调不减，从而实现静力稳定。\n    2.  **GPE 最小值**：在绝热重排下，通过按密度对水块进行排序，可以达到 GPE 的最小值。\n    3.  **守恒性**：调整后的示踪物剖面 $q_i^{\\star}$ 必须满足 $\\sum_{i=1}^{N} \\Delta z_i \\, q_i^{\\star} = \\sum_{i=1}^{N} \\Delta z_i \\, q_i$，且层厚度 $\\Delta z_i$ 保持不变。这适用于所有被动示踪物。\n    4.  **确定性**：对于相等的密度 ($\\rho$)，需要一个不受浮点数误差或运行时执行顺序影响的平局打破规则。\n- **计算约束**：算法的时间复杂度必须为 $O(N \\log N)$ 或更优。\n\n### 步骤 2：使用提取的给定信息进行验证\n问题陈述具有科学依据、问题明确且客观。\n1.  **科学合理性**：问题描述了地球物理流体动力学中对流调整方案的物理基础。流体柱的重力势能在一个其密度剖面随深度单调增加（即最稠密的流体在底部）时达到最小，这是静力稳定性的一个基本概念。示踪物守恒和确定性的要求是数值气候和海洋模型的标准和关键要求。Boussinesq 近似是一个标准框架。\n2.  **问题明确性**：问题清晰地定义了初始状态、最终状态的期望属性以及约束条件（包括物理和计算约束）。它提出了一个关于算法设计的问题，该问题基于所提供的原则有明确的答案。\n3.  **清晰度和客观性**：所使用的术语（例如，`静力平衡`、`Boussinesq`、`欧拉层`、`静力稳定`、`计算复杂度`）在计算海洋学领域是标准和精确的。各项要求都是客观陈述的。\n\n### 步骤 3：结论和行动\n问题陈述有效。这是一个关于海洋模型数值方法的明确问题。我将继续推导解决方案并评估各个选项。\n\n### 从第一性原理推导\n核心任务是找到一个调整后的状态，该状态由固定欧拉层 $i=1,\\dots,N$ 中的示踪物值 $q_i^\\star$ 来表征，并满足一系列物理和计算约束。\n\n1.  **稳定性和 GPE 最小值**：原则指出，通过按密度对流体水块进行排序，可以实现最小 GPE 和静力稳定性。这里的“水块”是指包含在初始层 $i$ 中的流体，其体积（单位水平面积）为 $\\Delta z_i$，密度为 $\\rho_i$，示踪物浓度为 $q_i$。设 $p$ 是索引 $\\{1, \\dots, N\\}$ 的一个排列，使得 $\\rho_{p(1)} \\le \\rho_{p(2)} \\le \\dots \\le \\rho_{p(N)}$。这个排列定义了水块的最终垂直排列，该排列使 GPE 最小化。最轻的水块（最初来自层 $p(1)$）位于顶部，其次是来自 $p(2)$ 的水块，依此类推。\n\n2.  **确定性**：如果对于某个 $i \\ne j$ 有 $\\rho_i = \\rho_j$，则排序顺序是不明确的。一个确定性算法需要一个一致的平局打破规则。一种标准方法是使用复合键进行稳定排序。使用原始层索引 $i$ 作为次要键，即 $(\\rho_i, i)$，可以确保如果 $\\rho_i = \\rho_j$ 且 $i  j$，则来自层 $i$ 的水块排在来自层 $j$ 的水块之前。这保证了无论运行时条件如何，都能得到一个唯一的、确定性的排列 $p$。\n\n3.  **守恒和重映射**：调整过程重新排列了水块，但欧拉网格单元（层）是固定的。给定层 $i$ 中的最终示踪物浓度 $q_i^\\star$ 必须是与层 $i$ 重叠的已排序水块的示踪物浓度的体积加权平均值。\n    设垂直坐标为 $z$，其中 $z=0$ 位于水柱顶面。原始层 $i$ 占据深度区间 $[Z_{i-1}, Z_i)$，其中 $Z_i = \\sum_{m=1}^{i} \\Delta z_m$ 且 $Z_0=0$。\n    在排序后（最小 GPE）的状态下，水块按照排列 $p$ 的顺序堆叠。这定义了一个新的垂直坐标系统 $z'$。排序后的水块 $p(j)$ 在这个排序系统中占据区间 $[H_{j-1}, H_j)$，其中 $H_j = \\sum_{m=1}^{j} \\Delta z_{p(m)}$ 且 $H_0=0$。这个排序后水柱中的示踪物剖面 $q^{\\text{sorted}}(z')$ 是分段常数，对于 $z' \\in [H_{j-1}, H_j)$，$q^{\\text{sorted}}(z') = q_{p(j)}$。\n    原始层 $i$ 中的最终示踪物值由以下精确积分给出：\n    $$ q_i^{\\star} = \\frac{1}{\\Delta z_i} \\int_{Z_{i-1}}^{Z_i} q^{\\text{sorted}}(z') dz' $$\n    该积分表示将排序后的示踪物剖面重映射回原始欧拉网格。总示踪物是守恒的，因为 $\\sum_{i=1}^N \\Delta z_i q_i^\\star = \\sum_{i=1}^N \\int_{Z_{i-1}}^{Z_i} q^{\\text{sorted}}(z') dz' = \\int_{Z_0}^{Z_N} q^{\\text{sorted}}(z') dz' = \\int_{H_0}^{H_N} q^{\\text{sorted}}(z') dz' = \\sum_{j=1}^N \\Delta z_{p(j)} q_{p(j)} = \\sum_{i=1}^N \\Delta z_i q_i$。\n    为了高效地计算这些积分，我们可以使用前缀和。设 $M_k^{(q)} = \\sum_{j=1}^{j=k} \\Delta z_{p(j)} q_{p(j)}$ 为排序后水柱中的累积示踪物质量。对于任何 $Z$，积分 $\\int_0^Z q^{\\text{sorted}}(z') dz'$ 可以通过找到深度 $Z$ 所在的排序后水块 $p(k)$，并在 $M_{k-1}^{(q)}$ 和 $M_k^{(q)}$ 之间进行线性插值来计算。然后，层 $i$ 的积分是在 $Z_i$ 和 $Z_{i-1}$ 处积分值的差。由于序列 $\\{Z_i\\}$ 和 $\\{H_j\\}$ 都是单调的，对所有 $N$ 层的整个重映射过程可以通过对网格的一次遍历在 $O(N)$ 时间内完成。\n\n4.  **计算复杂度**：此过程中的主导步骤是排序，其复杂度为 $O(N \\log N)$。所有其他步骤（计算前缀和、重映射）都是 $O(N)$。因此，总复杂度为 $O(N \\log N)$。\n\n这个推导出的算法满足所有陈述的要求。我们现在根据这个正确的构造来评估给定的选项。\n\n### 逐项分析\n\n**A. 对水块按复合键 $(\\rho_i, i)$ 进行稳定排序，其中 $i$ 是原始索引，得到一个排列 $p(\\cdot)$。按排序后的顺序，定义厚度前缀和 $H_k = \\sum_{j=1}^{k} \\Delta z_{p(j)}$ 和示踪物质量前缀和 $M_k^{(q)} = \\sum_{j=1}^{k} \\Delta z_{p(j)} \\, q_{p(j)}$。将排好序的列视为在累积厚度坐标上是分段常数。通过计算该排序剖面在每个区间 $[Z_{i-1}, Z_i)$ 上的精确层平均值，来重构原始网格上调整后的层平均示踪物，其中 $Z_i = \\sum_{m=1}^{i} \\Delta z_m$。这个计算利用部分和来评估必要的区间交集，时间复杂度为 $O(N)$。对任何示踪物应用相同的程序。排序成本占主导地位，产生 $O(N \\log N)$ 的复杂度。**\n\n- **分析**：此选项精确地描述了从第一性原理推导出的算法。\n    - **稳定性/GPE**：按密度 $\\rho_i$ 排序正确地确定了最小 GPE 状态。\n    - **确定性**：对复合键 $(\\rho_i, i)$ 进行稳定排序正确且确定性地解决了平局问题。\n    - **守恒性**：使用前缀和计算排序剖面的精确层平均值是守恒重映射的一种标准且数学上精确的方法。\n    - **复杂度**：$O(N \\log N)$ 的排序主导了 $O(N)$ 的重映射成本，这个说法是正确的。\n- **结论**：**正确**。\n\n**B. 重复扫描该列，如果 $\\rho_i  \\rho_{i+1}$，则将相邻的不稳定对 $(i,i+1)$ 替换为其厚度加权平均值来进行混合，直到没有密度倒置为止。如果一次扫描没有做任何更改，则提前退出。此过程避免了排序，并保证了局部守恒，并且相同密度通过扫描顺序被隐式处理。**\n\n- **分析**：该算法描述了一种迭代的、局部的混合方案（类似于冒泡排序）。尽管它最终会通过混合不稳定的相邻层（$\\rho_i  \\rho_{i+1}$）来产生一个稳定的剖面，但它存在两个根本性缺陷。首先，在**稳定性/GPE**方面，此方法仅移除局部密度倒置，不能保证达到全局的重力势能最小值，因为它不混合非相邻的层。其次，在**复杂度**方面，最坏情况下该算法需要 $O(N^2)$ 的时间，不满足 $O(N \\log N)$ 的要求。\n- **结论**：**不正确**。\n\n**C. 对密度进行不稳定排序，对相等的 $\\rho$ 不进行平局打破处理，然后在排序后，通过将 $q$ 从排序后的坐标线性插值回原始深度来分配 $q_i^{\\star}$。这避免了重映射积分并减少了内存流量。对于相等的密度，排序可以选择任何顺序。**\n\n- **分析**：此选项违反了问题的多项要求。\n    - **确定性**：不稳定排序明确违反了确定性的要求。最终状态将取决于具体的排序实现，并可能取决于数据的初始内存布局，这对于科学模拟是不可接受的。\n    - **守恒性**：线性插值通常不是一个守恒操作。插值后的示踪物质量总和 $\\sum \\Delta z_i q_i^{\\star}$ 通常不等于初始总和 $\\sum \\Delta z_i q_i$。调整的原理是基于重排离散的水块，而不是创建一个连续场并通过插值对其进行重新采样。\n- **结论**：**不正确**。\n\n**D. 仅按位温对水块进行排序，忽略盐度，因为在许多地区，温度对密度的影响占主导地位。然后如设计 A 那样形成前缀和并进行重映射。这比在排序过程中评估非线性状态方程要便宜得多，并且温度的单调性往往意味着密度的单调性。**\n\n- **分析**：此选项提出了一个物理近似。\n    - **稳定性/GPE**：静力稳定性的基本原理是基于密度 $\\rho$，而不是位温 $\\theta$。虽然 $\\theta$ 通常是主导因素，但密度也取决于盐度 $S$。一个水柱可能对 $\\theta$ 是稳定的，但对 $\\rho$ 是不稳定的，如果一层较暖、较咸的水覆盖在一层较冷、较淡的水之上。这种情况在物理上很重要。仅按 $\\theta$ 排序不能保证最终状态相对于密度是静力稳定的，因此不能保证 GPE 的最小化。这违反了问题的一个主要原则。\n- **结论**：**不正确**。",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}