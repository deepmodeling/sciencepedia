{
    "hands_on_practices": [
        {
            "introduction": "湍流混合参数化方案的核心在于准确描述湍流动能（Turbulent Kinetic Energy, TKE）的生消过程。此过程由TKE收支方程控制，其中剪切产生项（shear production）和浮力产生/破坏项（buoyancy production/destruction）是主要的能量来源和汇。这项练习将引导你从雷诺平均方程出发，通过应用梯度扩散闭合，推导这些关键项的表达式，从而深化对平均流和层结如何控制湍流混合物理机制的理解 。",
            "id": "3807592",
            "problem": "考虑一个在 Boussinesq 近似下的水平均匀海洋边界层，垂直坐标 $z$ 向上为正。平均水平速度为 $\\boldsymbol{U}(z) = (U(z), V(z))$，平均浮力为 $b(z)$，其中 $b = -g \\rho^{\\prime}/\\rho_0$，$\\rho_0$ 是一个常参考密度。设湍动能变量为 $q^2 = \\overline{u^{\\prime 2}} + \\overline{v^{\\prime 2}} + \\overline{w^{\\prime 2}}$，如同 Mellor–Yamada 2.5 阶闭合方案中一样，因此湍动能为 $e = q^2/2$。假设如下：\n- 在 Boussinesq 近似下，雷诺平均动量方程和标量方程成立。\n- 湍流通量遵循顺梯度闭合，具有垂直涡粘性系数 $K_m \\ge 0$ 和标量扩散系数 $K_h \\ge 0$，这与 K-剖面参数化（KPP）和 Mellor–Yamada 闭合方案一致。\n- 平均场仅随 $z$ 变化，旋转和波动效应不显式地进入切变或浮力生成项。\n\n从 $q^2$ 收支中切变生成和浮力生成的定义（用雷诺应力和湍流浮力通量表示）出发，并采用所述的闭合方案，确定下列哪个选项正确地给出了出现在 $q^2$ 预报方程中的切变生成项 $P$ 和浮力生成（或耗散）项 $B$，以及对于稳定（$N^2 > 0$）和不稳定（$N^2 < 0$）层结的正确符号约定。这里 $N^2 = \\partial b/\\partial z$ 是浮力频率的平方。\n\n选择唯一正确的选项。\n\nA. $P = 2 K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = - 2 K_h N^2$。对于 $N^2 > 0$（稳定），$B < 0$，因此浮力破坏湍流；对于 $N^2 < 0$（不稳定），$B > 0$，因此浮力生成湍流。切变生成项 $P \\ge 0$ 恒成立。\n\nB. $P = K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = + 2 K_h N^2$。对于 $N^2 > 0$（稳定），$B > 0$，因此浮力生成湍流；对于 $N^2 < 0$（不稳定），$B < 0$，因此浮力破坏湍流。如果 $\\partial U/\\partial z$ 和 $\\partial V/\\partial z$ 符号相反，切变生成项 $P$ 可以为负。\n\nC. $P = 2 K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = - 2 K_m N^2$。对于 $N^2 > 0$（稳定），$B < 0$；对于 $N^2 < 0$（不稳定），$B > 0$。对于反气旋切变，切变生成项 $P \\le 0$。\n\nD. $P = 2 K_m \\left[\\dfrac{\\partial U}{\\partial z} + \\dfrac{\\partial V}{\\partial z}\\right]^2$ 且 $B = - 2 K_h N$。对于 $N^2 > 0$（稳定），$B < 0$；对于 $N^2 < 0$（不稳定），$B > 0$。切变生成项 $P$ 的符号会随着 $\\partial U/\\partial z$ 和 $\\partial V/\\partial z$ 的相对符号而改变。",
            "solution": "用户要求对问题陈述进行严格验证，然后详细推导解决方案并评估所提供的选项。\n\n**问题验证**\n\n**第一步：提取已知条件**\n- 系统是一个水平均匀的海洋边界层。\n- Boussinesq 近似有效。\n- 垂直坐标为 $z$，向上为正。\n- 平均水平速度为 $\\boldsymbol{U}(z) = (U(z), V(z))$。\n- 平均浮力为 $b(z)$。\n- 浮力定义为 $b = -g \\rho^{\\prime}/\\rho_0$，其中 $\\rho_0$ 是一个常参考密度。\n- 湍动能变量为 $q^2 = \\overline{u^{\\prime 2}} + \\overline{v^{\\prime 2}} + \\overline{w^{\\prime 2}}$。\n- 湍动能为 $e = q^2/2$。\n- 雷诺平均动量和标量方程成立。\n- 湍流通量使用顺梯度闭合方案建模，采用垂直涡粘性系数 $K_m \\ge 0$ 和垂直标量扩散系数 $K_h \\ge 0$。\n- 平均场仅是 $z$ 的函数。\n- 旋转和波动效应不显式包含在生成项中。\n- 浮力频率的平方为 $N^2 = \\partial b/\\partial z$。\n- 目标是找到 $q^2$ 预报方程中切变生成项 $P$ 和浮力生成项 $B$ 的表达式及其符号约定。\n\n**第二步：使用提取的已知条件进行验证**\n- **科学基础：** 该问题牢固地建立在地球物理流体动力学和湍流建模的标准理论框架内。雷诺平均、Boussinesq 近似、湍动能收支和顺梯度扩散（K-理论）等概念是该领域的基础。Mellor-Yamada 和 KPP 闭合方案是公认的参数化方案。该问题在科学上是合理的。\n- **适定性：** 该问题提供了一套清晰的假设和定义，可以从中唯一地推导出所需的量（$P$ 和 $B$）。问题具体而明确。\n- **客观性：** 问题陈述使用了物理海洋学的精确标准术语，不含主观或基于观点的语言。\n\n**第三步：结论与行动**\n问题陈述是有效的。它在科学上是合理的、适定的和客观的。我将继续推导解决方案。\n\n**推导**\n\n在所述假设下，湍动能 $e = q^2/2$ 的预报方程包括生成项和耗散项。$q^2$ 的方程就是 $e$ 方程的两倍。我们需要求的是出现在 $q^2$ 收支中的生成项。\n\n**1. 切变生成项, $P$**\n\n湍动能 $e$ 收支中的切变生成项由雷诺应力张量和平均速度梯度张量的乘积给出：\n$$ P_e = -\\overline{u'_i u'_j} \\frac{\\partial U_i}{\\partial x_j} $$\n此处暗含对重复指标求和。在给定背景下，平均流 $\\boldsymbol{U}$ 为 $(U(z), V(z), 0)$ 且仅随垂直坐标 $z$ (或 $x_3$) 变化。因此，平均速度梯度的非零分量仅有 $\\frac{\\partial U}{\\partial z} = \\frac{\\partial U_1}{\\partial x_3}$ 和 $\\frac{\\partial V}{\\partial z} = \\frac{\\partial U_2}{\\partial x_3}$。$e$ 的切变生成项简化为：\n$$ P_e = -\\left( \\overline{u'w'} \\frac{\\partial U}{\\partial z} + \\overline{v'w'} \\frac{\\partial V}{\\partial z} \\right) $$\n问题陈述指出，湍流通量使用涡粘性系数 $K_m$ 的顺梯度闭合方案进行建模。这意味着垂直湍流动量通量（雷诺应力）被参数化为：\n$$ \\overline{u'w'} = -K_m \\frac{\\partial U}{\\partial z} $$\n$$ \\overline{v'w'} = -K_m \\frac{\\partial V}{\\partial z} $$\n将这些闭合方案代入 $P_e$ 的表达式中：\n$$ P_e = - \\left( \\left(-K_m \\frac{\\partial U}{\\partial z}\\right) \\frac{\\partial U}{\\partial z} + \\left(-K_m \\frac{\\partial V}{\\partial z}\\right) \\frac{\\partial V}{\\partial z} \\right) $$\n$$ P_e = K_m \\left[ \\left(\\frac{\\partial U}{\\partial z}\\right)^2 + \\left(\\frac{\\partial V}{\\partial z}\\right)^2 \\right] $$\n问题要求的是出现在 $q^2 = 2e$ 预报方程中的切变生成项 $P$。$q^2$ 方程中的各项是 $e$ 方程中相应项的两倍。因此：\n$$ P = 2 P_e = 2 K_m \\left[ \\left(\\frac{\\partial U}{\\partial z}\\right)^2 + \\left(\\frac{\\partial V}{\\partial z}\\right)^2 \\right] $$\n根据定义，$K_m \\ge 0$，且方括号中的项是平方和，因此切变生成项 $P$ 必须为非负值，即 $P \\ge 0$。它代表平均动能通过平均切变转化为湍动能。\n\n**2. 浮力生成项, $B$**\n\n$e$ 收支中的浮力生成（或耗散）项是垂直湍流浮力通量 $B_e = \\overline{b'w'}$。符号约定为：轻流体（$\\rho' < 0$, $b' > 0$）的向上输运或重流体（$\\rho' > 0$, $b' < 0$）的向下输运会增强湍流。浮力的定义是 $b = -g \\rho'/\\rho_0$。因此浮力通量为：\n$$ B_e = \\overline{b'w'} = \\overline{\\left(-\\frac{g}{\\rho_0}\\rho'\\right)w'} = -\\frac{g}{\\rho_0}\\overline{\\rho'w'} $$\n对标量（浮力）使用顺梯度闭合，垂直湍流通量通过涡扩散系数 $K_h$ 参数化为：\n$$ \\overline{b'w'} = -K_h \\frac{\\partial b}{\\partial z} $$\n问题将浮力频率的平方定义为 $N^2 = \\frac{\\partial b}{\\partial z}$。代入可得：\n$$ B_e = - K_h N^2 $$\n$q^2$ 预报方程中的相应项 $B$ 是该值的两倍：\n$$ B = 2 B_e = -2 K_h N^2 $$\n现在我们分析 $B$ 的符号：\n- 如果层结是稳定的，浮力随高度增加，因此 $\\frac{\\partial b}{\\partial z} = N^2 > 0$。在这种情况下，$B = -2 K_h N^2 < 0$ (因为 $K_h \\ge 0$)。这个负项代表稳定层结对湍流的破坏作用，因为垂直运动必须做功来克服浮力。\n- 如果层结是不稳定的，浮力随高度减小，因此 $\\frac{\\partial b}{\\partial z} = N^2 < 0$。在这种情况下，$B = -2 K_h N^2 > 0$。这个正项代表对流生成的湍流，因为浮力会增强垂直运动。\n\n**推导结果总结：**\n- $q^2$ 方程中的切变生成项：$P = 2 K_m \\left[ \\left(\\frac{\\partial U}{\\partial z}\\right)^2 + \\left(\\frac{\\partial V}{\\partial z}\\right)^2 \\right]$，且 $P \\ge 0$。\n- $q^2$ 方程中的浮力生成项：$B = -2 K_h N^2$。\n- 对于稳定层结（$N^2 > 0$），$B < 0$（耗散）。\n- 对于不稳定层结（$N^2 < 0$），$B > 0$（生成）。\n\n**逐项分析**\n\n**A. $P = 2 K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = - 2 K_h N^2$。对于 $N^2 > 0$（稳定），$B < 0$，因此浮力破坏湍流；对于 $N^2 < 0$（不稳定），$B > 0$，因此浮力生成湍流。切变生成项 $P \\ge 0$ 恒成立。**\n- $P$ 的表达式正确。\n- $B$ 的表达式正确。\n- 对稳定和不稳定层结下 $B$ 的符号及其物理意义的分析正确。\n- 关于 $P \\ge 0$ 恒成立的陈述正确。\n- **结论：正确**\n\n**B. $P = K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = + 2 K_h N^2$。对于 $N^2 > 0$（稳定），$B > 0$，因此浮力生成湍流；对于 $N^2 < 0$（不稳定），$B < 0$，因此浮力破坏湍流。如果 $\\partial U/\\partial z$ 和 $\\partial V/\\partial z$ 符号相反，切变生成项 $P$ 可以为负。**\n- $P$ 的表达式缺少因子 2；它代表的是 $e$ 的生成项，而不是 $q^2$ 的生成项。这是不正确的。\n- $B$ 的表达式符号错误。这是不正确的。\n- 对 $B$ 的符号的物理学解释是颠倒的，因此不正确。\n- 关于 $P$ 可以为负的陈述不正确；$P$ 是平方和，恒为非负。\n- **结论：不正确**\n\n**C. $P = 2 K_m \\left[\\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2\\right]$ 且 $B = - 2 K_m N^2$。对于 $N^2 > 0$（稳定），$B < 0$；对于 $N^2 < 0$（不稳定），$B > 0$。对于反气旋切变，切变生成项 $P \\le 0$。**\n- $P$ 的表达式正确。\n- $B$ 的表达式错误地使用了动量的涡粘性系数 $K_m$，而不是标量的涡扩散系数 $K_h$。尽管在一些简化模型中可能假设 $K_m = K_h$（湍流普朗特数 $Pr_t = 1$），但这并非普遍成立，也未在假设中说明。正确的公式使用 $K_h$。这是不正确的。\n- 关于 $P \\le 0$ 的陈述不正确。如推导所示，$P \\ge 0$ 恒成立。“对于反气旋切变”这一条件与 $P$ 的符号无关。\n- **结论：不正确**\n\n**D. $P = 2 K_m \\left[\\dfrac{\\partial U}{\\partial z} + \\dfrac{\\partial V}{\\partial z}\\right]^2$ 且 $B = - 2 K_h N$。对于 $N^2 > 0$（稳定），$B < 0$；对于 $N^2 < 0$（不稳定），$B > 0$。切变生成项 $P$ 的符号会随着 $\\partial U/\\partial z$ 和 $\\partial V/\\partial z$ 的相对符号而改变。**\n- $P$ 的表达式不正确。它应该是切变分量平方的和，即 $2K_m ((\\partial U/\\partial z)^2 + (\\partial V/\\partial z)^2)$，而不是它们和的平方。\n- $B$ 的表达式不正确。它应与 $N^2$ 成正比，而不是 $N$。这在量纲上也不一致。$B$ 的单位是浮力通量，即 长度$^2$/时间$^3$。而 $-2K_h N$ 项的单位是 (长度$^2$/时间) $\\times$ (1/时间) = 长度$^2$/时间$^2$。\n- 关于 $P$ 的符号的陈述是基于此选项中提出的错误公式，对于切变生成的正确公式并不成立。\n- **结论：不正确**\n\n基于此分析，只有选项 A 是完全正确的。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在理解了湍流的基本物理驱动力之后，我们将其应用于一个具体的参数化方案：K剖面参数化（K-Profile Parameterization, KPP）。KPP方案的第一步，也是至关重要的一步，是确定湍流边界层的深度 $h$。这项诊断通过计算一个体积理查森数（bulk Richardson number）来实现，该数衡量了从海面到某一深度的总浮力稳定效应与剪切失稳效应的比率。通过这项编码练习，你将亲手实践如何根据离散的海洋剖面数据，从零开始实现这一核心诊断算法 。",
            "id": "3807670",
            "problem": "给定海洋表层的水平流和现场密度的离散垂直剖面。您的任务是使用K-剖面参数化（K-Profile Parameterization, KPP）的概念框架，从第一性原理推导出一个用于计算边界层深度的数值诊断方法。目标是计算整体理查森数剖面，并将首次穿越阈值的深度确定为边界层深度。您的程序必须实现完整的计算过程，并为测试套件生成指定的输出。\n\n基本原理和物理背景：\n- 假设Boussinesq近似、静力平衡和一个水平均匀的水柱。垂直坐标为深度$z$，从海面向下为正，海面处$z=0$。\n- 设$U(z)$和$V(z)$为水平流分量，单位为$\\mathrm{m}\\,\\mathrm{s}^{-1}$；设$\\rho(z)$为现场密度，单位为$\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n- 定义重力加速度$g = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$，参考密度$\\rho_0 = 1025\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n- K-剖面参数化（KPP）使用一个整体理查森数阈值$Ri_{b,cr}$来诊断边界层深度$h$，通常取值为$Ri_{b,cr} = 0.3$（无量纲）。Mellor–Yamada湍流闭合（MY）模型内部使用梯度理查森数，但此处要求的是基于浮力差和切变的整体理查森数，并从第一性原理推导。\n\n起始点定义：\n- 梯度理查森数定义为$Ri_g = N^2/S^2$，其中浮力频率为$N^2 = \\dfrac{g}{\\rho_0}\\dfrac{\\partial \\rho}{\\partial z}$，切变大小为$S^2 = \\left(\\dfrac{\\partial U}{\\partial z}\\right)^2 + \\left(\\dfrac{\\partial V}{\\partial z}\\right)^2$。\n- 对于从海面到深度$z$的有限层内的整体度量，用该层上的累积有限差分代替垂直梯度，并使用浮力异常$b(z) = g\\dfrac{\\rho(z) - \\rho_0}{\\rho_0}$（单位为$\\mathrm{m}\\,\\mathrm{s}^{-2}$）。令$b_s = b(0)$、$U_s = U(0)$和$V_s = V(0)$。您的推导必须得出一个无量纲的整体理查森数$Ri_b(z)$，该数依赖于这些从海面到深度的差值，并与K-剖面参数化框架保持一致。\n\n边界层深度诊断：\n- 从海面开始向下扫描，找到整体理查森数首次超过临界值$Ri_{b,cr}$的深度。设$z_i$和$z_{i+1}$是连续的两个深度，满足$Ri_b(z_i) \\le Ri_{b,cr}$和$Ri_b(z_{i+1}) > Ri_{b,cr}$。然后，将边界层深度$h$定义为在$z_i$和$z_{i+1}$之间沿$Ri_b(z)$剖面进行线性插值得到的穿越深度。\n- 如果在所有可用深度上都有$Ri_b(z) \\le Ri_{b,cr}$，则将$h$设置为可用的最深深度。如果在海面以下的第一个有效深度处$Ri_b(z) > Ri_{b,cr}$，则设$h = 0\\,\\mathrm{m}$。\n- 为保证数值稳健性，如果分母中的切变大小在某个深度恰好为零，则在分母上应用一个数值下限$\\epsilon = 10^{-12}$以避免除以零，并继续计算。此正则化方法必须明确说明并一致使用。\n\n单位与输出规范：\n- 将诊断出的边界层深度$h$以$\\mathrm{m}$为单位表示，并四舍五入到三位小数。\n- 本问题不使用角度。\n- 您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表，例如$[h_1,h_2,h_3]$。\n\n测试套件：\n使用上述定义和$Ri_{b,cr} = 0.3$，为以下三种情况计算诊断出的边界层深度$h$。\n\n情况A（包含密度跃层的常规“理想”情况）：\n- 深度：$z_k = k\\,\\mathrm{m}$，其中$k=0,1,2,\\dots,60$。\n- 流速：$U(z) = 0.5 - 0.005\\,z$ 和 $V(z) = 0.002\\,z$，单位为$\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 密度：$\\rho(z) = 1023.5 + 0.005\\,z + \\dfrac{0.4}{1 + \\exp\\!\\left(-\\dfrac{z - 25}{3}\\right)}$，单位为$\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n\n情况B（弱切变下的中性层结）：\n- 深度：$z_k = 2k\\,\\mathrm{m}$，其中$k=0,1,2,\\dots,25$（即从$0$到$50\\,\\mathrm{m}$，步长为$2\\,\\mathrm{m}$）。\n- 流速：$U(z) = 0.2 - 0.001\\,z$ 和 $V(z) = 0$，单位为$\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 密度：$\\rho(z) = 1025.0$，单位为$\\mathrm{kg}\\,\\mathrm{m}^{-3}$（随深度不变）。\n\n情况C（极弱切变下的强稳定层结）：\n- 深度：$z_k = 5k\\,\\mathrm{m}$，其中$k=0,1,2,\\dots,20$（即从$0$到$100\\,\\mathrm{m}$，步长为$5\\,\\mathrm{m}$）。\n- 流速：$U(z) = 0.1 - 0.0005\\,z$ 和 $V(z) = 0$，单位为$\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 密度：$\\rho(z) = 1024.0 + 0.01\\,z$，单位为$\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n\n算法要求：\n- 基于上述基本原理，使用从海面到深度的浮力和流速的有限差分来推导$Ri_b(z)$，不假设任何快捷公式。实现通过在首次阈值穿越点进行分段线性插值来诊断$h$的方法。\n- 如果切变平方项的分母为零，则应用数值下限$\\epsilon = 10^{-12}$。\n- 最终输出必须是形如$[h_A,h_B,h_C]$的单行文本，其中每个值都以$\\mathrm{m}$为单位，并四舍五入到三位小数。\n\n您的程序必须是一个完整、可运行的实现，不得要求任何用户输入或外部文件。它必须计算出$h_A$、$h_B$和$h_C$这三个值，并严格按照指定的输出格式打印它们。",
            "solution": "任务是基于K-剖面参数化（K-Profile Parameterization, KPP）框架，推导并实现一个用于诊断海洋边界层深度 $h$ 的数值方法。这涉及到计算一个整体理查森数剖面 $Ri_b(z)$，并找出它首次超过一个临界值的深度。\n\n推导和步骤如下：\n\n首先，我们确立基本原理。层结切变流的稳定性由理查森数表征，该数代表了混合层结流体所需的稳定势能与速度切变提供的不稳定动能之比。梯度理查森数由 $Ri_g = N^2 / S^2$ 给出。在一个深度 $z$ 向下为正的坐标系中，为使稳定密度剖面（密度 $\\rho$ 随深度 $z$ 增加）的浮力频率平方为正，$N^2$ 必须定义为 $N^2 = \\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial z}$。垂直切变的平方为 $S^2 = \\left(\\frac{\\partial U}{\\partial z}\\right)^2 + \\left(\\frac{\\partial V}{\\partial z}\\right)^2$。\n\n为了构建一个从海面（$z=0$）到深度 $z$ 的层内的整体理查森数 $Ri_b(z)$，我们用跨越该层的有限差分来替代无穷小导数。\n\n梯度 $\\frac{\\partial \\rho}{\\partial z}$ 由整体差分 $\\frac{\\rho(z) - \\rho(0)}{z-0}$ 近似。因此，整体浮力频率的平方为：\n$$ N^2_{bulk} = \\frac{g}{\\rho_0} \\frac{\\rho(z) - \\rho(0)}{z} $$\n该项的单位为 $\\mathrm{s}^{-2}$，量化了该层内的平均层结强度。\n\n类似地，速度梯度 $\\frac{\\partial U}{\\partial z}$ 和 $\\frac{\\partial V}{\\partial z}$ 分别由 $\\frac{U(z) - U(0)}{z-0}$ 和 $\\frac{V(z) - V(0)}{z-0}$ 近似。则整体切变的平方为：\n$$ S^2_{bulk} = \\left(\\frac{U(z) - U(0)}{z}\\right)^2 + \\left(\\frac{V(z) - V(0)}{z}\\right)^2 = \\frac{(U(z) - U(0))^2 + (V(z) - V(0))^2}{z^2} $$\n该项的单位也为 $\\mathrm{s}^{-2}$，代表了该层内的平均切变。\n\n整体理查森数 $Ri_b(z)$ 是这两个整体量的比值。它是一个无量纲参数，定义于 $z>0$：\n$$ Ri_b(z) = \\frac{N^2_{bulk}}{S^2_{bulk}} = \\frac{\\frac{g}{\\rho_0} \\frac{\\rho(z) - \\rho(0)}{z}}{\\frac{(U(z) - U(0))^2 + (V(z) - V(0))^2}{z^2}} $$\n通过简化表达式，我们得到需要实现的公式：\n$$ Ri_b(z) = \\frac{g z (\\rho(z) - \\rho(0))}{\\rho_0 \\left[ (U(z) - U(0))^2 + (V(z) - V(0))^2 \\right]} $$\n分母代表速度差的平方，如果深度 $z$ 处的速度与海面速度相同，则分母可能为零。为确保数值稳定性，如果分母为零，则通过加上一个小的下限值 $\\epsilon = 10^{-12}$ 对其进行正则化。\n\n建立了 $Ri_b(z)$ 的公式后，为一组离散垂直剖面诊断边界层深度 $h$ 的数值步骤如下：\n1.  对于在深度网格 $z_k$（其中 $k=0, 1, \\dots, N$ 且 $z_0 = 0$）上给定的剖面 $U(z_k)$、$V(z_k)$ 和 $\\rho(z_k)$，计算每个深度 $z_k$（其中 $k > 0$）的 $Ri_b(z_k)$ 值。\n2.  临界理查森数为 $Ri_{b,cr} = 0.3$。边界层深度 $h$ 通过找到 $Ri_b(z)$ 首次超过此阈值的最浅深度来确定。\n3.  搜索从海面以下的第一个网格点 $z_1$ 开始。如果 $Ri_b(z_1) > Ri_{b,cr}$，则认为边界层无限薄，我们设定 $h = 0\\,\\mathrm{m}$。\n4.  如果 $Ri_b(z_1) \\le Ri_{b,cr}$，我们向下迭代，找到第一个满足 $Ri_b(z_k) \\le Ri_{b,cr}$ 和 $Ri_b(z_{k+1}) > Ri_{b,cr}$ 的索引 $k \\ge 1$。\n5.  然后，通过在深度 $z_k$ 和 $z_{k+1}$ 之间对 $Ri_b(z)$ 剖面进行线性插值来找到边界层深度 $h$。$h$ 的值是插值后的理查森数等于 $Ri_{b,cr}$ 时的深度：\n    $$ h = z_k + (z_{k+1} - z_k) \\frac{Ri_{b,cr} - Ri_b(z_k)}{Ri_b(z_{k+1}) - Ri_b(z_k)} $$\n6.  如果在给定域中的任何 $k$ 都没有满足条件 $Ri_b(z_k) > Ri_{b,cr}$，这意味着整个水柱都在边界层内。在这种情况下，$h$ 被设置为可用的最深深度 $z_N$。\n\n对于三个测试案例中的每一个，都将实施这个基于原理的严谨过程，以确定 $h_A$、$h_B$ 和 $h_C$ 的值。最终结果按要求四舍五入到三位小数。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve for the boundary layer depth for three test cases.\n    \"\"\"\n\n    def calculate_bld(z_vals, U_func, V_func, rho_func):\n        \"\"\"\n        Calculates the boundary layer depth (h) for a given set of profiles.\n\n        Args:\n            z_vals (np.ndarray): Array of depths (m), starting from z=0.\n            U_func (callable): Function for U-velocity profile U(z).\n            V_func (callable): Function for V-velocity profile V(z).\n            rho_func (callable): Function for density profile rho(z).\n\n        Returns:\n            float: The calculated boundary layer depth in meters.\n        \"\"\"\n        g = 9.81\n        rho0 = 1025.0\n        Ri_b_cr = 0.3\n        epsilon = 1e-12\n\n        # Generate profiles from the functions\n        U_vals = U_func(z_vals)\n        V_vals = V_func(z_vals)\n        rho_vals = rho_func(z_vals)\n\n        # Extract surface values (at z=0)\n        U_s = U_vals[0]\n        V_s = V_vals[0]\n        rho_s = rho_vals[0]\n\n        # The bulk Richardson number is not defined at z=0.\n        # We compute it for all depths z > 0.\n        z_eff = z_vals[1:]\n        if len(z_eff) == 0:\n            return 0.0\n\n        # Calculate differences relative to the surface\n        delta_U = U_vals[1:] - U_s\n        delta_V = V_vals[1:] - V_s\n        delta_rho = rho_vals[1:] - rho_s\n        \n        # Calculate bulk Richardson number profile\n        # Numerator: g * z * (rho(z) - rho_s) / rho0\n        numerators = (g * z_eff / rho0) * delta_rho\n        \n        # Denominator: (U(z) - U_s)^2 + (V(z) - V_s)^2\n        denominators = delta_U**2 + delta_V**2\n        # Apply numerical floor to avoid division by zero\n        denominators[denominators == 0] = epsilon\n        \n        Ri_b_vals = numerators / denominators\n        \n        # Check if the BLD is shallower than the first grid point\n        if Ri_b_vals[0] > Ri_b_cr:\n            return 0.0\n\n        # Find the first index where Ri_b exceeds the critical value\n        crossing_idx = -1\n        # The loop iterates up to the second to last element of Ri_b_vals\n        for i in range(len(Ri_b_vals) - 1):\n            if Ri_b_vals[i] <= Ri_b_cr and Ri_b_vals[i+1] > Ri_b_cr:\n                crossing_idx = i\n                break\n        \n        # If no crossing is found, the BLD is the deepest point in the domain\n        if crossing_idx == -1:\n            return z_eff[-1]\n\n        # A crossing was found, perform linear interpolation\n        # Points for interpolation are (z, Ri_b)\n        z_i = z_eff[crossing_idx]\n        z_i_plus_1 = z_eff[crossing_idx + 1]\n        \n        Ri_b_i = Ri_b_vals[crossing_idx]\n        Ri_b_i_plus_1 = Ri_b_vals[crossing_idx + 1]\n        \n        # Linear interpolation formula to find h where Ri_b(h) = Ri_b_cr\n        h = z_i + (z_i_plus_1 - z_i) * (Ri_b_cr - Ri_b_i) / (Ri_b_i_plus_1 - Ri_b_i)\n        \n        return h\n\n    # --- Define Test Cases ---\n\n    # Case A: General case with a pycnocline\n    z_A = np.arange(0, 61, 1, dtype=float)\n    U_A = lambda z: 0.5 - 0.005 * z\n    V_A = lambda z: 0.002 * z\n    rho_A = lambda z: 1023.5 + 0.005 * z + 0.4 / (1 + np.exp(-(z - 25) / 3))\n\n    # Case B: Neutral stratification with weak shear\n    z_B = np.arange(0, 51, 2, dtype=float)\n    U_B = lambda z: 0.2 - 0.001 * z\n    V_B = lambda z: np.zeros_like(z)\n    rho_B = lambda z: np.full_like(z, 1025.0)\n\n    # Case C: Strong stable stratification with very weak shear\n    z_C = np.arange(0, 101, 5, dtype=float)\n    U_C = lambda z: 0.1 - 0.0005 * z\n    V_C = lambda z: np.zeros_like(z)\n    rho_C = lambda z: 1024.0 + 0.01 * z\n    \n    test_cases = [\n        (z_A, U_A, V_A, rho_A),\n        (z_B, U_B, V_B, rho_B),\n        (z_C, U_C, V_C, rho_C),\n    ]\n\n    results = []\n    for z_vals, U_func, V_func, rho_func in test_cases:\n        h = calculate_bld(z_vals, U_func, V_func, rho_func)\n        results.append(h)\n\n    # Format the final output as specified\n    formatted_results = [f\"{res:.3f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "确定边界层深度 $h$ 后，KPP方案通过一个“非局地”（nonlocal）输运项来模拟大尺度相干涡旋在边界层内的快速混合作用。然而，将这一物理概念转化为可靠的数值代码，必须严格保证示踪剂（如热量和盐度）的守恒。本练习将通过对比保守的通量散度格式和非保守的源汇项格式，揭示正确的数值离散方法对于物理守恒定律的重要性，这是计算海洋学中至关重要的一课 。",
            "id": "3807656",
            "problem": "考虑一个一维垂直海洋柱，其深度坐标 $z$ 从表面 $z=0$ 向下为正，一直到底部 $z=H$。设该海洋柱被离散为 $N$ 个有限体积单元，单元厚度为 $\\Delta z_i$（$i=1,\\dots,N$），单元界面位于深度 $z_{i-\\frac{1}{2}}$（$i=1,\\dots,N+1$），其中 $z_{\\frac{1}{2}}=0$ 且 $z_{N+\\frac{1}{2}}=H$。设预报量为位温 $\\theta$，单位为 $\\mathrm{K}$。一维示踪剂守恒定律由垂直通量形式给出：$\\partial \\theta / \\partial t = - \\partial F / \\partial z$，其中 $F$（单位为 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$）是 $\\theta$ 的垂直通量。\n\n在K-剖面参数化（K-Profile Parameterization, KPP）方案中，非局地输送由一个非局地通量项表示，该项在厚度为 $h$ 的湍流边界层内将规定的表面通量向下重新分配。假设没有底部通量，且内部没有 $\\theta$ 的生成或消耗。设在 $z=0$ 处施加的 $\\theta$ 表面通量为一个常数 $Q_\\theta$（单位为 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$），方向是向下进入海洋。构建一个非局地通量剖面 $F^{\\mathrm{nl}}(z)$，使得 $F^{\\mathrm{nl}}(0) = Q_\\theta$，$F^{\\mathrm{nl}}(h) = 0$，对于 $z>h$ 有 $F^{\\mathrm{nl}}(z)=0$，并且 $F^{\\mathrm{nl}}(z)$ 在 $0 \\le z \\le h$ 内平滑变化。使用为 $0 \\le \\sigma \\le 1$ 定义的三次形状函数 $S(\\sigma) = 1 - 3\\sigma^2 + 2\\sigma^3$（其中 $\\sigma = z/h$）来构建 $F^{\\mathrm{nl}}(z) = Q_\\theta \\, S(z/h)$（对于 $0 \\le z \\le h$）和 $F^{\\mathrm{nl}}(z) = 0$（对于 $z>h$）。\n\n您的任务是在给定的有限体积网格上，实现 $\\theta$ 的非局地输送的两种离散表示：\n\n1. 一种守恒的通量散度实现，将非局地项引起的单元趋势计算为单元界面上非局地通量的离散散度，即对每个单元 $i$ 计算 $-(F^{\\mathrm{nl}}_{i+\\frac{1}{2}} - F^{\\mathrm{nl}}_{i-\\frac{1}{2}})/\\Delta z_i$。\n\n2. 一种朴素的基于源项的实现，它分配一个与在单元中心评估的形状函数成正比的内部源项，即对于 $z_i \\le h$ 为 $(Q_\\theta/h) \\, S(z_i/h)$，否则为 $0$，其中 $z_i$ 是单元中心 $i$ 的深度。\n\n对于每种实现，计算由非局地项引起的 $\\theta$ 的整柱积分瞬时变化率，\n$$\n\\mathcal{R} = \\sum_{i=1}^{N} \\left( \\frac{\\partial \\theta_i}{\\partial t} \\right) \\Delta z_i,\n$$\n并将其与边界通量期望值 $Q_\\theta - 0$（单位 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$）进行比较，该期望值由守恒定律在整柱上积分 $\\int_0^H \\partial \\theta / \\partial t \\, dz = F(0) - F(H)$ 得出。\n\n对于每个测试用例，您必须输出两个浮点数：\n- 守恒的通量散度实现的绝对守恒误差，$|\\mathcal{R}_{\\mathrm{cons}} - Q_\\theta|$，单位为 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 朴素的基于源项的实现的绝对守恒误差，$|\\mathcal{R}_{\\mathrm{naive}} - Q_\\theta|$，单位为 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[\\text{result}_1,\\text{result}_2,\\dots]$），按每个测试用例成对排序：首先是守恒误差，然后是朴素误差，依此类推，适用于所有测试用例。\n\n测试套件：\n使用以下科学上合理且自洽的参数集。对于均匀网格，对所有 $i$ 取 $\\Delta z_i = H/N$。\n\n- 测试用例1：$H=50\\,\\mathrm{m}$, $N=50$, $h=30\\,\\mathrm{m}$, $Q_\\theta=2\\times 10^{-7}\\,\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 测试用例2：$H=50\\,\\mathrm{m}$, $N=10$, $h=50\\,\\mathrm{m}$, $Q_\\theta=-1\\times 10^{-7}\\,\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 测试用例3：$H=100\\,\\mathrm{m}$, $N=100$, $h=5\\,\\mathrm{m}$, $Q_\\theta=5\\times 10^{-8}\\,\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 测试用例4：非均匀网格，$N=30$，厚度 $\\Delta z_i$ 由 $\\Delta z_i=1\\,\\mathrm{m}$（对于 $i=1,\\dots,10$）和 $\\Delta z_i=2\\,\\mathrm{m}$（对于 $i=11,\\dots,30$）给出（因此 $H=\\sum_{i=1}^{30}\\Delta z_i=50\\,\\mathrm{m}$），$h=20\\,\\mathrm{m}$ 且 $Q_\\theta=3\\times 10^{-7}\\,\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n- 测试用例5：$H=80\\,\\mathrm{m}$, $N=80$, $h=20\\,\\mathrm{m}$, $Q_\\theta=0\\,\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$。\n\n您的程序必须实现上述两种方法，计算每个测试用例的 $|\\mathcal{R}_{\\mathrm{cons}} - Q_\\theta|$ 和 $|\\mathcal{R}_{\\mathrm{naive}} - Q_\\theta|$（单位为 $\\mathrm{K}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$），并以指定的单行格式打印结果。",
            "solution": "该问题要求基于K-剖面参数化（KPP）方案，实现并验证两种用于表示一维海洋柱中非局地示踪剂输送的数值方案。核心原则是位温 $\\theta$ 的守恒。\n\n示踪剂 $\\theta$ 的连续一维守恒定律由以下公式给出：\n$$\n\\frac{\\partial \\theta}{\\partial t} = - \\frac{\\partial F}{\\partial t}\n$$\n其中 $F(z)$ 是垂直通量。为了找到深度为 $H$ 的柱内 $\\theta$ 的总变化率，我们将此方程从表面（$z=0$）积分到底部（$z=H$）：\n$$\n\\int_0^H \\frac{\\partial \\theta}{\\partial t} dz = \\int_0^H \\left(-\\frac{\\partial F}{\\partial z}\\right) dz = -[F(z)]_0^H = F(0) - F(H)\n$$\n这个基本结果表明，一个守恒量的整柱积分变化率精确地等于其边界上的净通量。\n\n在这个问题中，通量是非局地通量 $F^{\\mathrm{nl}}(z)$。我们已知表面通量为 $F^{\\mathrm{nl}}(0) = Q_\\theta$ 且没有底部通量，这与 $z>h$ 时 $F^{\\mathrm{nl}}(z)=0$ 的定义一起，意味着对于所有测试用例（其中 $H \\ge h$），都有 $F^{\\mathrm{nl}}(H) = 0$。因此，精确的整柱积分变化率必须是：\n$$\n\\int_0^H \\frac{\\partial \\theta}{\\partial t} dz = Q_\\theta - 0 = Q_\\theta\n$$\n该积分的数值对应形式是对所有 $N$ 个网格单元的离散求和：\n$$\n\\mathcal{R} = \\sum_{i=1}^{N} \\left( \\frac{\\partial \\theta_i}{\\partial t} \\right) \\Delta z_i\n$$\n目标是为所提出的两种数值实现计算绝对守恒误差 $|\\mathcal{R} - Q_\\theta|$。\n\n**1. 守恒的通量散度实现**\n\n该方法直接离散化通量散度项。单元 $i$ 的趋势为：\n$$\n\\left( \\frac{\\partial \\theta_i}{\\partial t} \\right)_{\\mathrm{cons}} = -\\frac{F^{\\mathrm{nl}}_{i+\\frac{1}{2}} - F^{\\mathrm{nl}}_{i-\\frac{1}{2}}}{\\Delta z_i}\n$$\n其中 $F^{\\mathrm{nl}}_{i\\pm\\frac{1}{2}}$ 是在单元界面上评估的非局地通量。整柱积分的变化率为：\n$$\n\\mathcal{R}_{\\mathrm{cons}} = \\sum_{i=1}^{N} \\left( -\\frac{F^{\\mathrm{nl}}_{i+\\frac{1}{2}} - F^{\\mathrm{nl}}_{i-\\frac{1}{2}}}{\\Delta z_i} \\right) \\Delta z_i = -\\sum_{i=1}^{N} (F^{\\mathrm{nl}}_{i+\\frac{1}{2}} - F^{\\mathrm{nl}}_{i-\\frac{1}{2}})\n$$\n这个和是一个伸缩级数：\n$$\n\\mathcal{R}_{\\mathrm{cons}} = - \\left[ (F^{\\mathrm{nl}}_{1+\\frac{1}{2}} - F^{\\mathrm{nl}}_{\\frac{1}{2}}) + (F^{\\mathrm{nl}}_{2+\\frac{1}{2}} - F^{\\mathrm{nl}}_{1+\\frac{1}{2}}) + \\dots + (F^{\\mathrm{nl}}_{N+\\frac{1}{2}} - F^{\\mathrm{nl}}_{N-\\frac{1}{2}}) \\right] = - (F^{\\mathrm{nl}}_{N+\\frac{1}{2}} - F^{\\mathrm{nl}}_{\\frac{1}{2}})\n$$\n$$\n\\mathcal{R}_{\\mathrm{cons}} = F^{\\mathrm{nl}}_{\\frac{1}{2}} - F^{\\mathrm{nl}}_{N+\\frac{1}{2}}\n$$\n由于界面 $\\frac{1}{2}$ 位于 $z=0$，界面 $N+\\frac{1}{2}$ 位于 $z=H$，因此这变为 $\\mathcal{R}_{\\mathrm{cons}} = F^{\\mathrm{nl}}(0) - F^{\\mathrm{nl}}(H) = Q_\\theta - 0 = Q_\\theta$。\n该方法在构造上是“守恒的”，因为无论网格分辨率或通量剖面的具体形式如何，数值求和都精确地再现了净边界通量。数值守恒误差 $|\\mathcal{R}_{\\mathrm{cons}} - Q_\\theta|$ 应该为零，仅受浮点精度限制。\n\n**2. 朴素的基于源项的实现**\n\n该方法将非局地输送建模为施加在单元中心 $z_i$ 上的内部源项：\n$$\n\\left( \\frac{\\partial \\theta_i}{\\partial t} \\right)_{\\mathrm{naive}} = \\frac{Q_\\theta}{h} S(z_i/h) \\quad \\text{for } z_i \\le h, \\quad \\text{and } 0 \\text{ otherwise.}\n$$\n此公式不是直接从通量散度推导出来的，其守恒性无法保证。整柱积分的变化率为：\n$$\n\\mathcal{R}_{\\mathrm{naive}} = \\sum_{i \\text{ s.t. } z_i \\le h} \\left(\\frac{Q_\\theta}{h} S(z_i/h)\\right) \\Delta z_i\n$$\n这个和是积分 $\\int_0^h \\frac{Q_\\theta}{h} S(z/h) dz$ 的一个中点法则数值近似。我们可以通过代换 $\\sigma = z/h$（得出 $dz = h \\, d\\sigma$）来解析地计算这个积分：\n$$\n\\int_0^h \\frac{Q_\\theta}{h} S(z/h) dz = \\frac{Q_\\theta}{h} \\int_0^1 S(\\sigma) (h \\, d\\sigma) = Q_\\theta \\int_0^1 (1 - 3\\sigma^2 + 2\\sigma^3) d\\sigma\n$$\n$$\n= Q_\\theta \\left[ \\sigma - \\sigma^3 + \\frac{1}{2}\\sigma^4 \\right]_0^1 = Q_\\theta \\left( 1 - 1 + \\frac{1}{2} - 0 \\right) = \\frac{1}{2}Q_\\theta\n$$\n因为这种朴素方法的底层连续公式积分结果为 $Q_\\theta/2$，而不是 $Q_\\theta$，所以随着网格分辨率的提高，数值和 $\\mathcal{R}_{\\mathrm{naive}}$ 将收敛到 $Q_\\theta/2$。该方法未能守恒从表面加入的 $\\theta$ 总量。因此，守恒误差 $|\\mathcal{R}_{\\mathrm{naive}} - Q_\\theta|$ 将会很显著，对于任何非零的 $Q_\\theta$，其值将近似于 $|(Q_\\theta/2) - Q_\\theta| = |Q_\\theta/2|$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef S_shape(sigma):\n    \"\"\"\n    Computes the cubic shape function S(sigma) for sigma in [0, 1].\n    Returns 0 for sigma outside this range. This vectorized function handles\n    scalar and numpy array inputs.\n    \n    Args:\n        sigma (float or np.ndarray): The non-dimensional depth z/h.\n        \n    Returns:\n        float or np.ndarray: The value of the shape function.\n    \"\"\"\n    sigma_arr = np.asarray(sigma)\n    res = np.zeros_like(sigma_arr, dtype=float)\n    mask = (sigma_arr >= 0) & (sigma_arr <= 1)\n    s_masked = sigma_arr[mask]\n    res[mask] = 1.0 - 3.0 * s_masked**2 + 2.0 * s_masked**3\n    return res\n\ndef F_nl(z_coords, h_val, Q_theta_val):\n    \"\"\"\n    Computes the nonlocal flux F_nl(z) = Q_theta * S(z/h) for z <= h.\n    The flux is zero for z > h.\n    \n    Args:\n        z_coords (float or np.ndarray): The depth coordinate(s).\n        h_val (float): The boundary layer depth.\n        Q_theta_val (float): The surface flux of potential temperature.\n        \n    Returns:\n        float or np.ndarray: The nonlocal flux at the given depth(s).\n    \"\"\"\n    z_coords_arr = np.asarray(z_coords)\n    if h_val == 0:\n        return np.where(z_coords_arr == 0, Q_theta_val, 0.0)\n    sigma = z_coords_arr / h_val\n    return Q_theta_val * S_shape(sigma)\n\ndef calculate_errors_for_case(H, N, h, Q_theta, dz_values):\n    \"\"\"\n    Calculates the conservation errors for a single test case for both\n    the conservative and naive implementations.\n    \"\"\"\n    \n    # 1. Setup the grid (cell thicknesses, face depths, and cell center depths)\n    if dz_values is None:\n        dz = np.full(N, H / N, dtype=float)\n    else:\n        dz = dz_values\n\n    face_depths = np.zeros(N + 1, dtype=float)\n    face_depths[1:] = np.cumsum(dz)\n    cell_centers = face_depths[:-1] + dz / 2.0\n\n    # 2. Conservative Flux-Divergence Implementation\n    # The column-integrated rate of change, R_cons, is the sum of tendencies\n    # times cell thickness. For a flux-divergence scheme, this sum telescopes\n    # to the net boundary flux: F(z=0) - F(z=H).\n    \n    flux_top = F_nl(face_depths[0], h, Q_theta) \n    flux_bottom = F_nl(face_depths[-1], h, Q_theta)\n    R_cons = flux_top - flux_bottom\n    error_cons = abs(R_cons - Q_theta)\n\n    # 3. Naive Source-Based Implementation\n    # The tendency is defined as a source term at cell centers. The total change\n    # is the sum of (tendency * cell thickness) over all cells.\n    \n    R_naive = 0.0\n    # The term Q_theta/h is undefined if h=0. If h=0, the boundary layer\n    # has no depth, so no interior source term exists.\n    if h > 0:\n        mask_in_bl = cell_centers <= h\n        centers_in_bl = cell_centers[mask_in_bl]\n        dz_in_bl = dz[mask_in_bl]\n        \n        sigma_centers = centers_in_bl / h\n        tendencies = (Q_theta / h) * S_shape(sigma_centers)\n        \n        R_naive = np.sum(tendencies * dz_in_bl)\n\n    error_naive = abs(R_naive - Q_theta)\n    \n    return error_cons, error_naive\n\ndef solve():\n    \"\"\"\n    Main solver function to process all test cases and print results in the\n    specified format.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'H': 50.0, 'N': 50, 'h': 30.0, 'Q_theta': 2e-7, 'dz_spec': None},\n        {'H': 50.0, 'N': 10, 'h': 50.0, 'Q_theta': -1e-7, 'dz_spec': None},\n        {'H': 100.0, 'N': 100, 'h': 5.0, 'Q_theta': 5e-8, 'dz_spec': None},\n        {'H': 50.0, 'N': 30, 'h': 20.0, 'Q_theta': 3e-7, \n         'dz_spec': np.concatenate([np.full(10, 1.0), np.full(20, 2.0)])},\n        {'H': 80.0, 'N': 80, 'h': 20.0, 'Q_theta': 0.0, 'dz_spec': None},\n    ]\n\n    all_results = []\n    for case in test_cases:\n        error_cons, error_naive = calculate_errors_for_case(\n            H=case['H'],\n            N=case['N'],\n            h=case['h'],\n            Q_theta=case['Q_theta'],\n            dz_values=case['dz_spec']\n        )\n        all_results.append(error_cons)\n        all_results.append(error_naive)\n\n    # Final print statement in the exact required format.\n    # Results are formatted in scientific notation for precision and consistency.\n    print(f\"[{','.join(f'{r:.15e}' for r in all_results)}]\")\n\nsolve()\n```"
        }
    ]
}