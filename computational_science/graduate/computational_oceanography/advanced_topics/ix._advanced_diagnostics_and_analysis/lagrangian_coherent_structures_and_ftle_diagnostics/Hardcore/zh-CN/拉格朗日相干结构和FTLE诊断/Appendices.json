{
    "hands_on_practices": [
        {
            "introduction": "真实的海洋模型常常使用曲线坐标网格以更好地拟合海岸线和海盆的复杂几何形状。本练习旨在解决在这样的非笛卡尔坐标系下计算 FTLE 的挑战 。你需要处理坐标变换，在轨迹积分和流映射求导过程中正确使用雅可比矩阵，从而将在理想模型中学到的知识应用于更接近实际的海洋模型分析中。",
            "id": "3796951",
            "problem": "给定一个在矩形逻辑域 $(\\xi,\\eta)\\in[0,1]\\times[0,1]$ 上的曲线二维海洋模型网格，该网格被映射到物理空间 $(x,y)$，其中长度单位为米，时间单位为秒。该映射是平滑且可逆的，三角函数内的角度以弧度为单位进行计算。粒子遵循由常微分方程 $d\\mathbf{X}/dt=\\mathbf{u}(\\mathbf{X},t)$ 控制的轨迹，其中 $\\mathbf{X}=(x,y)$ 是粒子位置，$\\mathbf{u}=(u,v)$ 是欧拉速度场，单位为米/秒。您的任务是实现一个完整的流程，用于计算该曲面网格上指定种子位置的有限时间李雅普诺夫指数 $\\sigma_{t_0}^{t}$。\n\n从第一性原理开始：\n- 使用轨迹定义 $d\\mathbf{X}/dt=\\mathbf{u}(\\mathbf{X},t)$，以及通过轨迹积分将时间 $t_0$ 的初始位置映射到时间 $t$ 的最终位置的流映射 $\\boldsymbol{\\phi}_{t_0}^{t}$。\n- 使用由物理坐标中流映射的梯度定义的右柯西-格林应变张量来量化有限时间拉伸。\n- 将有限时间李雅普诺夫指数计算为由右柯西-格林应变张量所蕴含的最大物质拉伸的单位时间自然对数率。\n\n您必须在代码中实现以下流程步骤：\n1.  在时间 $t_0$ 于逻辑坐标 $(\\xi_0,\\eta_0)$ 中进行粒子播种，并通过网格映射将种子转换为初始物理坐标。\n2.  使用四阶龙格-库塔方法在逻辑坐标中进行轨迹积分，通过雅可比矩阵来解释曲线映射。具体来说，速度在物理坐标中定义，但积分在逻辑坐标中执行；因此，您必须使用沿轨迹评估的映射的逆雅可比矩阵将 $d\\mathbf{X}/dt$ 转换为 $d(\\xi,\\eta)/dt$。\n3.  将定义在曲线网格节点上的速度场值插值到任意粒子位置。在每个龙格-库塔子步骤中，使用逻辑坐标中的双线性插值来评估粒子位置处的欧拉速度。\n4.  通过关于初始逻辑坐标的中心有限差分对流映射进行差分，并通过种子点处的雅可比矩阵将其一致地映射到初始物理微分。此过程构建了流映射的物理坐标梯度。\n5.  对右柯西-格林应变张量进行特征分析，以获得主有限时间拉伸，从而得到有限时间李雅普诺夫指数 $\\sigma_{t_0}^{t}$。\n\n使用以下科学上合理且自洽的设置：\n- 曲线映射 $(\\xi,\\eta)\\mapsto(x,y)$:\n  $$x(\\xi,\\eta)=L_x\\left[\\xi+\\alpha\\,c\\,\\sin(2\\pi\\xi)\\sin(2\\pi\\eta)\\right],\\quad y(\\xi,\\eta)=L_y\\left[\\eta+\\alpha\\,c\\,\\sin(2\\pi\\xi)\\sin(2\\pi\\eta)\\right],$$\n  其中 $L_x$ 和 $L_y$ 是以米为单位的域大小，$\\alpha$ 是无量纲的网格曲率振幅，$c=0.05$ 是一个固定的无量纲常数，角度以弧度为单位。雅可比矩阵 $\\mathbf{J}=\\partial(x,y)/\\partial(\\xi,\\eta)$ 必须从这些表达式中导出，并用于映射初始物理微分以及通过 $\\mathbf{J}^{-1}$ 将物理速度转换为逻辑时间导数。\n- 在物理坐标中定义在网格节点上的欧拉速度场：\n  $$u(x,y)=S\\,y,\\quad v(x,y)=0,$$\n  其中 $S$ 是一个以逆秒为单位的恒定剪切率。通过在映射的物理位置 $(x(\\xi_i,\\eta_j),y(\\xi_i,\\eta_j))$ 采样此速度来填充曲线网格节点。\n- 有限时间李雅普诺夫指数定义：在种子点构建流映射的物理坐标梯度，形成相关的右柯西-格林应变张量，并计算最大物质拉伸的单位时间自然对数率。最终值以逆秒表示。\n\n数值要求：\n- 在逻辑坐标中以每个测试指定的固定时间步长 $\\Delta t$ 执行龙格-库塔积分。如果需要，通过裁剪确保逻辑坐标保持在 $[0,1]$ 内。\n- 对网格值 $u$ 和 $v$ 使用逻辑坐标中的双线性插值。\n- 在初始逻辑坐标中使用指定的微小逻辑增量 $\\delta_\\xi=\\delta_\\eta$ 进行中心差分，以近似最终物理位置相对于初始逻辑坐标的导数。通过种子点处的雅可比矩阵将这些逻辑微分映射到初始物理微分，以获得流映射的物理坐标梯度。\n- 使用对称特征分析获得右柯西-格林应变张量的最大特征值。\n\n单位与输出：\n- 长度必须以米为单位，时间以秒为单位，角度以弧度为单位，速度以米/秒为单位，有限时间李雅普诺夫指数必须以逆秒为单位报告。\n- 您的程序必须产生单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[result1,result2,result3]\"）。每个结果必须是格式化为六位小数的浮点数，并表示相应测试用例的有限时间李雅普诺夫指数 $\\sigma_{t_0}^{t}$（单位为 $\\mathrm{s}^{-1}$）。\n\n实现程序以评估以下测试套件，涵盖一般情况、边界邻近、反向时间积分和增加的网格曲率：\n- 测试 1 (一般情况): $N_x=50$, $N_y=40$, $L_x=100000\\,\\mathrm{m}$, $L_y=100000\\,\\mathrm{m}$, $\\alpha=0.10$, $S=10^{-5}\\,\\mathrm{s}^{-1}$, 种子点 $(\\xi_0,\\eta_0)=(0.35,0.65)$, $t_0=0\\,\\mathrm{s}$, $t=200000\\,\\mathrm{s}$, $\\Delta t=200\\,\\mathrm{s}$, $\\delta_\\xi=\\delta_\\eta=10^{-3}$。\n- 测试 2 (边界邻近): $N_x=50$, $N_y=40$, $L_x=100000\\,\\mathrm{m}$, $L_y=100000\\,\\mathrm{m}$, $\\alpha=0.10$, $S=10^{-5}\\,\\mathrm{s}^{-1}$, 种子点 $(\\xi_0,\\eta_0)=(0.05,0.10)$, $t_0=0\\,\\mathrm{s}$, $t=50000\\,\\mathrm{s}$, $\\Delta t=200\\,\\mathrm{s}$, $\\delta_\\xi=\\delta_\\eta=10^{-3}$。\n- 测试 3 (反向时间): $N_x=50$, $N_y=40$, $L_x=100000\\,\\mathrm{m}$, $L_y=100000\\,\\mathrm{m}$, $\\alpha=0.10$, $S=10^{-5}\\,\\mathrm{s}^{-1}$, 种子点 $(\\xi_0,\\eta_0)=(0.50,0.50)$, $t_0=0\\,\\mathrm{s}$, $t=-200000\\,\\mathrm{s}$, $\\Delta t=200\\,\\mathrm{s}$, $\\delta_\\xi=\\delta_\\eta=10^{-3}$。\n- 测试 4 (增加的曲率): $N_x=50$, $N_y=40$, $L_x=100000\\,\\mathrm{m}$, $L_y=100000\\,\\mathrm{m}$, $\\alpha=0.20$, $S=10^{-5}\\,\\mathrm{s}^{-1}$, 种子点 $(\\xi_0,\\eta_0)=(0.80,0.20)$, $t_0=0\\,\\mathrm{s}$, $t=200000\\,\\mathrm{s}$, $\\Delta t=200\\,\\mathrm{s}$, $\\delta_\\xi=\\delta_\\eta=10^{-3}$。\n\n您的程序应生成单行输出，其中包含四个测试的有限时间李雅普诺夫指数值，格式为具有六位小数的浮点数，单位为逆秒，并按测试顺序排列：\"[result_test1,result_test2,result_test3,result_test4]\"。",
            "solution": "用户提供的问题陈述已经过严格验证，被认为是科学有据、定义明确且客观的。它为在曲线网格上计算有限时间李雅普诺夫指数（FTLE）提供了一套完整且一致的定义、物理参数和数值要求。该问题是动力系统理论应用于流体动力学领域中的一项标准但计算密集型的任务。所指定的方法，包括龙格-库塔积分、双线性插值和柯西-格林应变张量的使用，都是恰当且成熟的。所提供的物理和数值常数是合理的。关于反向积分时间步长 $\\Delta t$ 符号的已识别歧义，通过遵循标准约定得以解决，即从 $t_0$ 到最终时间 $t  t_0$ 的反向积分使用负时间步长。我们继续提供完整的解决方案。\n\n问题的核心是计算有限时间李雅普诺夫指数 $\\sigma_{t_0}^{t}$，它量化了在时间间隔 $[t_0, t]$ 内无限接近的粒子之间的最大分离率。该求解方法涉及几个基于连续介质力学和数值分析基本原理的相互关联的步骤。\n\n首先，我们定义数学框架。\n\n**1. 坐标系与映射**\n粒子存在于具有笛卡尔坐标 $\\mathbf{X} = (x, y)^T$ 的物理空间中。它们的运动在具有坐标 $\\boldsymbol{\\xi} = (\\xi, \\eta)^T \\in [0,1] \\times [0,1]$ 的逻辑网格上进行分析。从逻辑空间到物理空间的映射由以下公式给出：\n$$x(\\xi,\\eta)=L_x\\left[\\xi+\\alpha\\,c\\,\\sin(2\\pi\\xi)\\sin(2\\pi\\eta)\\right]$$\n$$y(\\xi,\\eta)=L_y\\left[\\eta+\\alpha\\,c\\,\\sin(2\\pi\\xi)\\sin(2\\pi\\eta)\\right]$$\n其中 $L_x, L_y, \\alpha$ 和 $c$ 是问题中定义的常数。该映射的局部变形由雅可比矩阵 $\\mathbf{J}$ 描述，其分量是映射函数的偏导数：\n$$\n\\mathbf{J}(\\boldsymbol{\\xi}) = \\frac{\\partial(x,y)}{\\partial(\\xi,\\eta)} = \n\\begin{pmatrix} \n\\frac{\\partial x}{\\partial \\xi}  \\frac{\\partial x}{\\partial \\eta} \\\\\n\\frac{\\partial y}{\\partial \\xi}  \\frac{\\partial y}{\\partial \\eta} \n\\end{pmatrix}\n$$\n这些导数的解析表达式为：\n$$\\frac{\\partial x}{\\partial \\xi} = L_x [1 + 2\\pi\\alpha c \\cos(2\\pi\\xi)\\sin(2\\pi\\eta)]$$\n$$\\frac{\\partial x}{\\partial \\eta} = L_x [2\\pi\\alpha c \\sin(2\\pi\\xi)\\cos(2\\pi\\eta)]$$\n$$\\frac{\\partial y}{\\partial \\xi} = L_y [2\\pi\\alpha c \\cos(2\\pi\\xi)\\sin(2\\pi\\eta)]$$\n$$\\frac{\\partial y}{\\partial \\eta} = L_y [1 + 2\\pi\\alpha c \\sin(2\\pi\\xi)\\cos(2\\pi\\eta)]$$\n\n**2. 逻辑坐标中的轨迹积分**\n粒子轨迹由物理坐标系中的常微分方程（ODE）决定：\n$$\\frac{d\\mathbf{X}}{dt} = \\mathbf{u}(\\mathbf{X}, t)$$\n为了在结构化的逻辑域中执行积分，我们使用链式法则关联物理速度和逻辑速度：$\\frac{d\\mathbf{X}}{dt} = \\mathbf{J}(\\boldsymbol{\\xi}(t)) \\frac{d\\boldsymbol{\\xi}}{dt}$。这得到了逻辑坐标中的ODE：\n$$\\frac{d\\boldsymbol{\\xi}}{dt} = \\mathbf{J}^{-1}(\\boldsymbol{\\xi}(t)) \\, \\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}(t)), t)$$\n该常微分方程使用四阶龙格-库塔（RK4）方法进行数值积分。对于时间步长 $\\Delta t$，从时间 $t_n$ 的 $\\boldsymbol{\\xi}_n$ 到时间 $t_{n+1}$ 的 $\\boldsymbol{\\xi}_{n+1}$ 的更新为：\n$$\\boldsymbol{\\xi}_{n+1} = \\boldsymbol{\\xi}_n + \\frac{\\Delta t}{6}(\\mathbf{k}_1 + 2\\mathbf{k}_2 + 2\\mathbf{k}_3 + \\mathbf{k}_4)$$\n其中各个阶段计算如下：\n$$\n\\begin{aligned}\n\\mathbf{k}_1 = \\mathbf{J}^{-1}(\\boldsymbol{\\xi}_n) \\, \\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}_n), t_n) \\\\\n\\mathbf{k}_2 = \\mathbf{J}^{-1}(\\boldsymbol{\\xi}_n + \\frac{\\Delta t}{2}\\mathbf{k}_1) \\, \\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}_n + \\frac{\\Delta t}{2}\\mathbf{k}_1), t_n + \\frac{\\Delta t}{2}) \\\\\n\\mathbf{k}_3 = \\mathbf{J}^{-1}(\\boldsymbol{\\xi}_n + \\frac{\\Delta t}{2}\\mathbf{k}_2) \\, \\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}_n + \\frac{\\Delta t}{2}\\mathbf{k}_2), t_n + \\frac{\\Delta t}{2}) \\\\\n\\mathbf{k}_4 = \\mathbf{J}^{-1}(\\boldsymbol{\\xi}_n + \\Delta t\\mathbf{k}_3) \\, \\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}_n + \\Delta t\\mathbf{k}_3), t_n + \\Delta t)\n\\end{aligned}\n$$\n速度场 $\\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}))$ 在每个阶段通过对预先计算在逻辑网格节点上的值进行双线性插值来评估。对于积分时长 $T = t-t_0$，步数为 $N_{steps} = \\lceil |T|/\\Delta t \\rceil$，在RK4算法中使用的带符号时间步长为 $dt_{signed} = T/N_{steps}$。\n\n**3. 速度场插值**\n欧拉速度场 $\\mathbf{u} = (u,v)^T$ 由 $u(x,y)=S\\,y$ 和 $v(x,y)=0$ 给出。为便于高效插值，首先在逻辑网格的每个节点上计算速度分量。对于每个节点 $(\\xi_i, \\eta_j)$，其中 $\\xi_i = i/(N_x-1)$ 和 $\\eta_j = j/(N_y-1)$，我们找到相应的物理坐标 $(x_{ij}, y_{ij})$ 并评估速度分量 $u_{ij} = S\\,y_{ij}$ 和 $v_{ij}=0$。\n对于在RK4积分过程中遇到的任何任意逻辑坐标 $\\boldsymbol{\\xi}$，速度 $\\mathbf{u}(\\mathbf{X}(\\boldsymbol{\\xi}))$ 通过对预先计算的速度网格 $(u_{ij}, v_{ij})$ 进行双线性插值来近似。\n\n**4. 流映射梯度与柯西-格林应变张量**\n流映射 $\\boldsymbol{\\phi}_{t_0}^t$ 将时间 $t_0$ 的初始位置 $\\mathbf{X}_0 = \\mathbf{X}(\\boldsymbol{\\xi}_0)$ 映射到时间 $t$ 的最终位置 $\\mathbf{X}(t)$。FTLE的计算需要此映射的梯度 $\\mathbf{F} = \\frac{\\partial \\mathbf{X}(t)}{\\partial \\mathbf{X}_0}$。使用链式法则，这可以表示为：\n$$\\mathbf{F} = \\frac{\\partial \\mathbf{X}(t)}{\\partial \\boldsymbol{\\xi}_0} \\left( \\frac{\\partial \\mathbf{X}_0}{\\partial \\boldsymbol{\\xi}_0} \\right)^{-1} = \\frac{\\partial \\mathbf{X}(t)}{\\partial \\boldsymbol{\\xi}_0} \\mathbf{J}^{-1}(\\boldsymbol{\\xi}_0)$$\n项 $\\frac{\\partial \\mathbf{X}(t)}{\\partial \\boldsymbol{\\xi}_0}$ 使用中心有限差分计算。我们从扰动的初始逻辑位置积分四个辅助轨迹：$(\\xi_0 \\pm \\delta_\\xi, \\eta_0)$ 和 $(\\xi_0, \\eta_0 \\pm \\delta_\\eta)$。设最终物理位置分别为 $\\mathbf{X}_{\\xi\\pm}(t)$ 和 $\\mathbf{X}_{\\eta\\pm}(t)$。则导数矩阵近似为：\n$$\n\\frac{\\partial \\mathbf{X}(t)}{\\partial \\boldsymbol{\\xi}_0} \\approx \\begin{pmatrix} \n\\frac{x_{\\xi+}(t) - x_{\\xi-}(t)}{2 \\delta_\\xi}  \\frac{x_{\\eta+}(t) - x_{\\eta-}(t)}{2 \\delta_\\eta} \\\\\n\\frac{y_{\\xi+}(t) - y_{\\xi-}(t)}{2 \\delta_\\xi}  \\frac{y_{\\eta+}(t) - y_{\\eta-}(t)}{2 \\delta_\\eta}\n\\end{pmatrix}\n$$\n计算出 $\\mathbf{F}$ 后，通过 $\\mathbf{C} = \\mathbf{F}^T \\mathbf{F}$ 找到右柯西-格林应变张量 $\\mathbf{C}$。这个 $2 \\times 2$ 矩阵是对称半正定的。\n\n**5. 有限时间李雅普诺夫指数 (FTLE)**\n$\\mathbf{C}$ 的特征值，记为 $\\lambda_1, \\lambda_2$，量化了材料单元的主拉伸平方。最大拉伸为 $\\sqrt{\\lambda_{max}}$，其中 $\\lambda_{max} = \\max(\\lambda_1, \\lambda_2)$。FTLE场 $\\sigma_{t_0}^{t}$ 定义为该最大拉伸的自然对数，并由积分时间 $|t-t_0|$ 归一化：\n$$\\sigma_{t_0}^{t}(\\mathbf{X}_0) = \\frac{1}{|t-t_0|} \\ln\\sqrt{\\lambda_{max}} = \\frac{1}{2|t-t_0|} \\ln(\\lambda_{max})$$\n对称矩阵 $\\mathbf{C}$ 的特征值使用标准的数值特征求解器找到。\n\n实现将为每个提供的测试用例精确遵循这些步骤。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to solve the FTLE computation problem for the given test cases.\n    \"\"\"\n    \n    test_cases = [\n        {'Nx': 50, 'Ny': 40, 'Lx': 100000.0, 'Ly': 100000.0, 'alpha': 0.10, 'S': 1e-5, 'seed_xi': 0.35, 'seed_eta': 0.65, 't0': 0.0, 't_final': 200000.0, 'dt_mag': 200.0, 'delta': 1e-3},\n        {'Nx': 50, 'Ny': 40, 'Lx': 100000.0, 'Ly': 100000.0, 'alpha': 0.10, 'S': 1e-5, 'seed_xi': 0.05, 'seed_eta': 0.10, 't0': 0.0, 't_final': 50000.0, 'dt_mag': 200.0, 'delta': 1e-3},\n        {'Nx': 50, 'Ny': 40, 'Lx': 100000.0, 'Ly': 100000.0, 'alpha': 0.10, 'S': 1e-5, 'seed_xi': 0.50, 'seed_eta': 0.50, 't0': 0.0, 't_final': -200000.0, 'dt_mag': 200.0, 'delta': 1e-3},\n        {'Nx': 50, 'Ny': 40, 'Lx': 100000.0, 'Ly': 100000.0, 'alpha': 0.20, 'S': 1e-5, 'seed_xi': 0.80, 'seed_eta': 0.20, 't0': 0.0, 't_final': 200000.0, 'dt_mag': 200.0, 'delta': 1e-3},\n    ]\n\n    c = 0.05  # Fixed nondimensional constant\n    \n    results = []\n    for params in test_cases:\n        ftle = compute_ftle_for_case(c=c, **params)\n        results.append(f\"{ftle:.6f}\")\n\n    print(f\"[{','.join(results)}]\")\n\ndef get_mapping_functions(Lx, Ly, alpha, c):\n    \"\"\"Returns functions for the grid mapping and its Jacobian.\"\"\"\n    def map_to_physical(xi, eta):\n        term = alpha * c * np.sin(2 * np.pi * xi) * np.sin(2 * np.pi * eta)\n        x = Lx * (xi + term)\n        y = Ly * (eta + term)\n        return np.array([x, y])\n\n    def jacobian(xi, eta):\n        J = np.zeros((2, 2))\n        sin_2pi_xi, cos_2pi_xi = np.sin(2 * np.pi * xi), np.cos(2 * np.pi * xi)\n        sin_2pi_eta, cos_2pi_eta = np.sin(2 * np.pi * eta), np.cos(2 * np.pi * eta)\n        \n        factor = 2 * np.pi * alpha * c\n        \n        J[0, 0] = Lx * (1 + factor * cos_2pi_xi * sin_2pi_eta)\n        J[0, 1] = Lx * (factor * sin_2pi_xi * cos_2pi_eta)\n        J[1, 0] = Ly * (factor * cos_2pi_xi * sin_2pi_eta)\n        J[1, 1] = Ly * (1 + factor * sin_2pi_xi * cos_2pi_eta)\n        return J\n        \n    return map_to_physical, jacobian\n\ndef get_velocity_interpolator(Nx, Ny, S, map_func):\n    \"\"\"Returns a bilinear interpolator for the velocity field.\"\"\"\n    xi_grid = np.linspace(0, 1, Nx)\n    eta_grid = np.linspace(0, 1, Ny)\n    \n    u_grid = np.zeros((Ny, Nx))\n    v_grid = np.zeros((Ny, Nx)) # v is always 0 for this problem\n    \n    for j in range(Ny):\n        for i in range(Nx):\n            _, y_phys = map_func(xi_grid[i], eta_grid[j])\n            u_grid[j, i] = S * y_phys\n    \n    def interpolate(xi, eta):\n        # Normalize coordinates\n        px = xi * (Nx - 1)\n        py = eta * (Ny - 1)\n        \n        # Get indices of bottom-left corner of the cell\n        i = int(px)\n        j = int(py)\n\n        # Clip indices to stay within bounds\n        i = min(i, Nx - 2)\n        j = min(j, Ny - 2)\n        i = max(i, 0)\n        j = max(j, 0)\n        \n        # Local coordinates within the cell\n        wx = px - i\n        wy = py - j\n        \n        # Bilinear interpolation for u\n        u_interp = (u_grid[j, i] * (1 - wx) * (1 - wy) +\n                    u_grid[j, i + 1] * wx * (1 - wy) +\n                    u_grid[j + 1, i] * (1 - wx) * wy +\n                    u_grid[j + 1, i + 1] * wx * wy)\n\n        # v is zero everywhere, so interpolated v is also zero\n        v_interp = 0.0\n\n        return np.array([u_interp, v_interp])\n\n    return interpolate\n\ndef integrate_trajectory(xi0_eta0, t0, t_final, dt_mag, vel_interpolator, jacobian_func):\n    \"\"\"\n    Integrates a particle trajectory using RK4 from t0 to t_final.\n    \"\"\"\n    xi_eta = np.array(xi0_eta0, dtype=float)\n    t_current = t0\n    \n    integration_time = t_final - t0\n    if integration_time == 0:\n        return xi_eta\n    \n    num_steps = int(np.ceil(np.abs(integration_time) / dt_mag))\n    dt = integration_time / num_steps\n\n    def d_xi_eta_dt(pos_xi_eta):\n        # Clip logical coordinates to [0,1] for Jacobian and velocity evaluation\n        pos_xi_eta_clipped = np.clip(pos_xi_eta, 0.0, 1.0)\n        u_v = vel_interpolator(pos_xi_eta_clipped[0], pos_xi_eta_clipped[1])\n        J = jacobian_func(pos_xi_eta_clipped[0], pos_xi_eta_clipped[1])\n        try:\n            J_inv = np.linalg.inv(J)\n        except np.linalg.LinAlgError:\n            # If Jacobian is singular, velocity is zero. Not expected in this problem.\n            return np.zeros(2)\n        return J_inv @ u_v\n\n    for _ in range(num_steps):\n        k1 = d_xi_eta_dt(xi_eta)\n        k2 = d_xi_eta_dt(xi_eta + 0.5 * dt * k1)\n        k3 = d_xi_eta_dt(xi_eta + 0.5 * dt * k2)\n        k4 = d_xi_eta_dt(xi_eta + dt * k3)\n        xi_eta += (dt / 6.0) * (k1 + 2 * k2 + 2 * k3 + k4)\n        xi_eta = np.clip(xi_eta, 0.0, 1.0) # Clip after each step as per requirement\n\n    return xi_eta\n\ndef compute_ftle_for_case(Nx, Ny, Lx, Ly, alpha, S, c, seed_xi, seed_eta, t0, t_final, dt_mag, delta):\n    \"\"\"\n    Computes the FTLE for a single test case.\n    \"\"\"\n    map_to_physical, jacobian_func = get_mapping_functions(Lx, Ly, alpha, c)\n    vel_interpolator = get_velocity_interpolator(Nx, Ny, S, map_to_physical)\n\n    # Initial seed positions for central differencing\n    xi0 = np.array([seed_xi, seed_eta])\n    xi0_xp = np.array([seed_xi + delta, seed_eta])\n    xi0_xm = np.array([seed_xi - delta, seed_eta])\n    xi0_yp = np.array([seed_xi, seed_eta + delta])\n    xi0_ym = np.array([seed_xi, seed_eta - delta])\n    \n    # Integrate trajectories for each perturbed initial condition\n    final_xi_xp = integrate_trajectory(xi0_xp, t0, t_final, dt_mag, vel_interpolator, jacobian_func)\n    final_xi_xm = integrate_trajectory(xi0_xm, t0, t_final, dt_mag, vel_interpolator, jacobian_func)\n    final_xi_yp = integrate_trajectory(xi0_yp, t0, t_final, dt_mag, vel_interpolator, jacobian_func)\n    final_xi_ym = integrate_trajectory(xi0_ym, t0, t_final, dt_mag, vel_interpolator, jacobian_func)\n\n    # Map final logical positions to physical positions\n    X_final_xp = map_to_physical(final_xi_xp[0], final_xi_xp[1])\n    X_final_xm = map_to_physical(final_xi_xm[0], final_xi_xm[1])\n    X_final_yp = map_to_physical(final_xi_yp[0], final_xi_yp[1])\n    X_final_ym = map_to_physical(final_xi_ym[0], final_xi_ym[1])\n\n    # Compute derivative of final physical position w.r.t. initial logical position\n    dXdxi0 = np.zeros((2, 2))\n    dXdxi0[:, 0] = (X_final_xp - X_final_xm) / (2 * delta)\n    dXdxi0[:, 1] = (X_final_yp - X_final_ym) / (2 * delta)\n\n    # Compute Jacobian at the initial seed position\n    J0 = jacobian_func(xi0[0], xi0[1])\n    J0_inv = np.linalg.inv(J0)\n\n    # Compute the flow map gradient tensor F\n    F = dXdxi0 @ J0_inv\n    \n    # Compute the right Cauchy-Green strain tensor C\n    C = F.T @ F\n    \n    # Find the maximum eigenvalue of C\n    # eigvalsh is for Hermitian (or real symmetric) matrices\n    eigenvalues = np.linalg.eigvalsh(C)\n    lambda_max = np.max(eigenvalues)\n    \n    integration_time = np.abs(t_final - t0)\n    \n    if integration_time == 0 or lambda_max == 0:\n        return 0.0\n\n    # Compute the FTLE\n    ftle = (1.0 / (2.0 * integration_time)) * np.log(lambda_max)\n    \n    return ftle\n\nif __name__ == '__main__':\n    solve()\n```"
        },
        {
            "introduction": "海洋学数据本质上是球面的，但在分析中常常被投影到平面地图上，例如麦卡托投影。这个理论练习将探讨在这些投影坐标中直接计算 FTLE 所带来的影响，因为投影会扭曲真实的物理距离 。通过推导校正因子，你将深刻理解如何从投影数据中获得具有物理意义的拉伸率，这是确保 FTLE 诊断结果准确性的关键一步。",
            "id": "3797011",
            "problem": "在一个从初始时间 $t_{0}$ 到最终时间 $t_{1}$ 的有限时间间隔内，观测到一个球面上的二维水平海洋表面流，其中 $T = t_{1} - t_{0} \\neq 0$。令 $\\Phi_{t_{0}}^{t_{1}}$ 表示将每个初始位置沿轨迹带到其最终位置的流映射。对于一个点 $x_{0}$，有限时间李雅普诺夫指数 (Finite-Time Lyapunov Exponent, FTLE) 定义为 $\\sigma(x_{0}, t_{0}, T) = \\frac{1}{2 |T|} \\ln \\lambda_{\\max}\\!\\left(C(x_{0}, t_{0}, T)\\right)$，其中 $C = F^{\\top} F$ 是右柯西-格林应变张量，$F = \\nabla \\Phi_{t_{0}}^{t_{1}}(x_{0})$ 是流映射相对于所选空间坐标的形变梯度。假设所有的导数和张量都在一个每点都赋予了欧几里得度量的坐标系中进行评估。\n\n在实践中，许多计算海洋学工作流首先将位置 $(\\lambda, \\phi)$（其中 $\\lambda$ 是经度，$\\phi$ 是纬度，单位为弧度）重新投影到墨卡托坐标 $(x, y)$，然后再计算 $F$ 和 $\\sigma$。墨卡托投影是共形的、局部各向同性的，但具有一个依赖于纬度的尺度因子。令该投影写为 $P : (\\lambda, \\phi) \\mapsto (x, y)$，并令 $J(\\phi) = \\nabla P$ 表示其局部雅可比矩阵。对于半径为 $R$ 的球面上的墨卡托投影，$x = R \\lambda$ 且 $y = R \\ln\\!\\big(\\tan\\!\\big(\\frac{\\pi}{4} + \\frac{\\phi}{2}\\big)\\big)$，并且 $J(\\phi)$ 在 $x$ 和 $y$ 两个方向上相对于球面上真实的物理距离引入了一个局部各向同性尺度 $s(\\phi) = \\sec(\\phi)$。\n\n假设您在墨卡托坐标中，使用形变梯度 $F_{M} = \\nabla\\!\\big(P \\circ \\Phi_{t_{0}}^{t_{1}} \\circ P^{-1}\\big)$ 计算出了一个 FTLE 场 $\\sigma_{M}$，而没有考虑依赖于纬度的尺度因子。考虑一个在时间间隔 $T$ 内，从纬度 $\\phi_{0}$ 开始，到纬度 $\\phi_{1}$ 结束的单条轨迹。仅使用流映射、形变梯度和 FTLE 的基本定义，以及墨卡托投影是共形的且具有局部各向同性尺度 $s(\\phi)$ 这一事实，推导出球面上真实物理空间中校正后的 FTLE $\\sigma_{\\text{true}}$ 关于 $\\sigma_{M}$、$\\phi_{0}$、$\\phi_{1}$ 和 $T$ 的解析表达式。\n\n将您的最终结果表示为单个封闭形式的表达式。角度必须以弧度处理。不需要进行数值评估。",
            "solution": "用户希望找到球面上真实的有限时间李雅普诺夫指数 (FTLE) $\\sigma_{\\text{true}}$ 与在墨卡托坐标中计算的 FTLE $\\sigma_{M}$ 之间的关系。推导必须基于所提供的基本定义和性质。\n\n令 $p_{0}$ 为时间 $t_{0}$ 时球面上一个流体质点的初始位置，$p_{1}$ 为其在时间 $t_{1}$ 时的最终位置。流映射 $\\Phi_{\\text{true}} \\equiv \\Phi_{t_{0}}^{t_{1}}$ 将 $p_{0}$ 映射到 $p_{1}$，因此 $p_{1} = \\Phi_{\\text{true}}(p_{0})$。初始和最终纬度分别为 $\\phi_{0}$ 和 $\\phi_{1}$。\n\nFTLE 计算的核心是形变梯度 $F$，它描述了初始位置的一个无穷小位移向量如何被流拉伸和旋转。令 $d\\boldsymbol{x}_{\\text{phys},0}$ 为 $p_{0}$ 处球面切平面上的一个无穷小物理位移向量。经过时间间隔 $T = t_{1} - t_{0}$ 后，该向量在 $p_{1}$ 处变为 $d\\boldsymbol{x}_{\\text{phys},1}$。真实的形变梯度 $F_{\\text{true}}$ 关联这两个向量：\n$$d\\boldsymbol{x}_{\\text{phys},1} = F_{\\text{true}} \\, d\\boldsymbol{x}_{\\text{phys},0}$$\n\n问题指出，计算是在墨卡托坐标 $(x, y)$ 中进行的，该坐标是通过从球面坐标 $(\\lambda, \\phi)$ 进行投影 $P$ 得到的。问题给出，该投影是共形的，并具有局部各向同性尺度因子 $s(\\phi) = \\sec(\\phi)$。这意味着在纬度 $\\phi$ 处，一个物理位移向量 $d\\boldsymbol{x}_{\\text{phys}}$ 的长度与其在墨卡托坐标中相应表示 $d\\boldsymbol{m}$ 的长度相关，关系如下：\n$$\\|d\\boldsymbol{x}_{\\text{phys}}\\| = \\frac{1}{s(\\phi)} \\|d\\boldsymbol{m}\\| = \\cos(\\phi) \\|d\\boldsymbol{m}\\|$$\n由于缩放是各向同性的（在所有方向上都相同），向量关系是一个简单的标量乘法：\n$$d\\boldsymbol{x}_{\\text{phys}} = \\cos(\\phi) \\, d\\boldsymbol{m}$$\n\n令 $d\\boldsymbol{m}_{0}$ 为初始位置在墨卡托坐标中的一个无穷小位移。相应的物理位移为 $d\\boldsymbol{x}_{\\text{phys},0} = \\cos(\\phi_{0}) \\, d\\boldsymbol{m}_{0}$。令 $d\\boldsymbol{m}_{1}$ 为最终位置的相应位移。相应的物理位移为 $d\\boldsymbol{x}_{\\text{phys},1} = \\cos(\\phi_{1}) \\, d\\boldsymbol{m}_{1}$。\n\n在墨卡托坐标中计算的形变梯度 $F_{M}$ 将初始的墨卡托位移映射到最终的位移：\n$$d\\boldsymbol{m}_{1} = F_{M} \\, d\\boldsymbol{m}_{0}$$\n\n现在我们可以建立 $F_{\\text{true}}$ 和 $F_{M}$ 之间的关系。我们从真实形变梯度的定义开始：\n$$d\\boldsymbol{x}_{\\text{phys},1} = F_{\\text{true}} \\, d\\boldsymbol{x}_{\\text{phys},0}$$\n代入关联物理位移和墨卡托位移的表达式：\n$$\\cos(\\phi_{1}) \\, d\\boldsymbol{m}_{1} = F_{\\text{true}} \\, (\\cos(\\phi_{0}) \\, d\\boldsymbol{m}_{0})$$\n现在，代入 $d\\boldsymbol{m}_{1} = F_{M} \\, d\\boldsymbol{m}_{0}$:\n$$\\cos(\\phi_{1}) \\, (F_{M} \\, d\\boldsymbol{m}_{0}) = F_{\\text{true}} \\, \\cos(\\phi_{0}) \\, d\\boldsymbol{m}_{0}$$\n由于标量因子 $\\cos(\\phi_{0})$ 和 $\\cos(\\phi_{1})$ 与矩阵可交换，我们可以写成：\n$$(\\cos(\\phi_{1}) F_{M}) \\, d\\boldsymbol{m}_{0} = (\\cos(\\phi_{0}) F_{\\text{true}}) \\, d\\boldsymbol{m}_{0}$$\n该方程必须对任何无穷小位移 $d\\boldsymbol{m}_{0}$ 都成立，这意味着矩阵关系为：\n$$\\cos(\\phi_{1}) F_{M} = \\cos(\\phi_{0}) F_{\\text{true}}$$\n解出 $F_{\\text{true}}$，我们得到：\n$$F_{\\text{true}} = \\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})} F_{M}$$\n\n下一步是关联右柯西-格林应变张量。真实张量为 $C_{\\text{true}} = F_{\\text{true}}^{\\top} F_{\\text{true}}$，基于墨卡托投影的张量为 $C_{M} = F_{M}^{\\top} F_{M}$。\n$$C_{\\text{true}} = \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})} F_{M}\\right)^{\\top} \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})} F_{M}\\right)$$\n由于项 $\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}$ 是一个标量，它可以从转置和乘法中提出来：\n$$C_{\\text{true}} = \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)^{2} F_{M}^{\\top} F_{M} = \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)^{2} C_{M}$$\n\nFTLE 依赖于柯西-格林张量的最大特征值 $\\lambda_{\\max}$。如果一个矩阵 $A$ 被一个标量 $k$ 缩放形成 $B = kA$，它们的特征值关系为 $\\lambda_{i}(B) = k \\lambda_{i}(A)$。因此，最大特征值之间的关系为：\n$$\\lambda_{\\max}(C_{\\text{true}}) = \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)^{2} \\lambda_{\\max}(C_{M})$$\n\n最后，我们使用问题中提供的 FTLE 定义，$\\sigma = \\frac{1}{2 |T|} \\ln(\\lambda_{\\max}(C))$。\n真实的 FTLE 是：\n$$\\sigma_{\\text{true}} = \\frac{1}{2|T|} \\ln\\left(\\lambda_{\\max}(C_{\\text{true}})\\right)$$\n代入特征值的关系：\n$$\\sigma_{\\text{true}} = \\frac{1}{2|T|} \\ln\\left( \\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)^{2} \\lambda_{\\max}(C_{M}) \\right)$$\n使用对数性质 $\\ln(a \\cdot b) = \\ln(a) + \\ln(b)$:\n$$\\sigma_{\\text{true}} = \\frac{1}{2|T|} \\left[ \\ln\\left(\\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)^{2}\\right) + \\ln\\left(\\lambda_{\\max}(C_{M})\\right) \\right]$$\n使用对数性质 $\\ln(a^{b}) = b \\ln(a)$ 并分配 $\\frac{1}{2|T|}$ 项：\n$$\\sigma_{\\text{true}} = \\frac{1}{2|T|} \\left[ 2 \\ln\\left|\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right| \\right] + \\frac{1}{2|T|} \\ln\\left(\\lambda_{\\max}(C_{M})\\right)$$\n对于墨卡托投影的有效域 $\\phi \\in (-\\frac{\\pi}{2}, \\frac{\\pi}{2})$，有 $\\cos(\\phi) > 0$。因此绝对值是不必要的。\n$$\\sigma_{\\text{true}} = \\frac{1}{|T|} \\ln\\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right) + \\frac{1}{2|T|} \\ln\\left(\\lambda_{\\max}(C_{M})\\right)$$\n第二项恰好是在墨卡托坐标中计算的 FTLE 的定义，即 $\\sigma_{M}$。因此，我们得出最终关系：\n$$\\sigma_{\\text{true}} = \\sigma_{M} + \\frac{1}{|T|} \\ln\\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)$$\n该表达式给出了校正后的真实 FTLE，它用从未经校正的墨卡托投影计算出的 FTLE、初始和最终纬度 $\\phi_{0}$ 和 $\\phi_{1}$ 以及积分时间间隔 $T$ 来表示。",
            "answer": "$$\\boxed{\\sigma_{M} + \\frac{1}{|T|} \\ln\\left(\\frac{\\cos(\\phi_{1})}{\\cos(\\phi_{0})}\\right)}$$"
        }
    ]
}