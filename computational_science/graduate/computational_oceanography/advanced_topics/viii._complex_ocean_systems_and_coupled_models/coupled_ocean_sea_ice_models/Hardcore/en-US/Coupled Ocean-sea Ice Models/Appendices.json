{
    "hands_on_practices": [
        {
            "introduction": "A cornerstone of any sea ice model is its handling of the surface energy budget, where shortwave radiation is a dominant driver of melt. This first practice focuses on implementing a foundational component of the ice thermodynamic system: the partitioning of incoming solar energy. You will apply the Beer-Lambert Law within a common \"two-stream\" spectral framework to calculate how much radiation is reflected, absorbed within the ice, and transmitted to the ocean below, providing a crucial heat source for both layers .",
            "id": "3789166",
            "problem": "You are tasked with computing the partitioning of incident Shortwave Radiation (SWR) into three categories for a horizontally homogeneous sea ice slab over the ocean: surface reflection, absorption within ice, and transmission to the ocean. The sea ice is treated using a two-band spectral model (\"two-stream\" in the sense of two spectral streams) with distinct extinction coefficients. Your program must implement the partitioning for the specified test suite and produce the required outputs.\n\nThe physical setting is as follows. A downward SWR flux $F_0$ (in $\\mathrm{W\\,m^{-2}}$) is incident on the air-ice interface. A fraction $R_s$ (dimensionless) of $F_0$ is reflected at the surface due to optical properties of the air-ice interface (e.g., Fresnel reflection and immediate near-surface effects). The remaining fraction $(1 - R_s)$ enters the ice. Within the ice, the SWR is represented as two spectral streams with fractions $f_1$ and $f_2 = 1 - f_1$, each attenuated exponentially through the slab with extinction coefficients $k_1$ and $k_2$ (units $\\mathrm{m^{-1}}$) over thickness $H$ (in $\\mathrm{m}$). All radiation reaching the ice-ocean interface is assumed to transmit into the ocean, where it is absorbed without further reflection.\n\nYour derivation must start from physically grounded principles appropriate to computational oceanography and coupled ocean-sea ice models, specifically:\n- Energy conservation for radiative fluxes.\n- The Beer-Lambert Law (BLL) for attenuation in a homogeneous absorbing medium.\n\nBased on these principles, compute for each test case:\n- Surface reflection $F_{\\text{surf}}$ (in $\\mathrm{W\\,m^{-2}}$).\n- Absorption within ice $F_{\\text{abs}}$ (in $\\mathrm{W\\,m^{-2}}$).\n- Transmission to the ocean $F_{\\text{trans}}$ (in $\\mathrm{W\\,m^{-2}}$).\n\nYour program must process the following test suite with parameter sets $(F_0, H, R_s, f_1, k_1, k_2)$:\n1. Happy path: $(F_0 = 300\\,\\mathrm{W\\,m^{-2}}, H = 1.2\\,\\mathrm{m}, R_s = 0.06, f_1 = 0.55, k_1 = 1.2\\,\\mathrm{m^{-1}}, k_2 = 4.0\\,\\mathrm{m^{-1}})$.\n2. Boundary case (zero thickness): $(F_0 = 300\\,\\mathrm{W\\,m^{-2}}, H = 0.0\\,\\mathrm{m}, R_s = 0.06, f_1 = 0.55, k_1 = 1.2\\,\\mathrm{m^{-1}}, k_2 = 4.0\\,\\mathrm{m^{-1}})$.\n3. Edge case (very thick ice): $(F_0 = 300\\,\\mathrm{W\\,m^{-2}}, H = 5.0\\,\\mathrm{m}, R_s = 0.06, f_1 = 0.55, k_1 = 1.2\\,\\mathrm{m^{-1}}, k_2 = 4.0\\,\\mathrm{m^{-1}})$.\n4. Edge case (one non-attenuating stream): $(F_0 = 300\\,\\mathrm{W\\,m^{-2}}, H = 1.2\\,\\mathrm{m}, R_s = 0.06, f_1 = 0.30, k_1 = 0.0\\,\\mathrm{m^{-1}}, k_2 = 10.0\\,\\mathrm{m^{-1}})$.\n5. Edge case (high surface reflectance): $(F_0 = 300\\,\\mathrm{W\\,m^{-2}}, H = 1.2\\,\\mathrm{m}, R_s = 0.50, f_1 = 0.55, k_1 = 1.2\\,\\mathrm{m^{-1}}, k_2 = 4.0\\,\\mathrm{m^{-1}})$.\n\nAll outputs must be expressed in $\\mathrm{W\\,m^{-2}}$ as decimal floats with exactly six digits after the decimal. Your program should produce a single line of output containing the results as a comma-separated list of per-test-case triplets enclosed in square brackets, where each triplet is itself a bracketed comma-separated list in the order $[F_{\\text{surf}}, F_{\\text{abs}}, F_{\\text{trans}}]$. For example: $[[x_1,y_1,z_1],[x_2,y_2,z_2],\\dots]$.\n\nDo not read any input. Use the parameters provided above directly in your program. Ensure the computations follow from the specified principles, and ensure energy conservation such that $F_{\\text{surf}} + F_{\\text{abs}} + F_{\\text{trans}}$ equals $F_0$ within numerical tolerance.",
            "solution": "The problem has been validated and is deemed sound. It is scientifically grounded, well-posed, objective, and contains all necessary information for a unique and meaningful solution. The physical model, while simplified, is a standard representation used in computational oceanography and sea ice modeling.\n\nThe task is to compute the partitioning of incident Shortwave Radiation (SWR) into three components: surface reflection ($F_{\\text{surf}}$), absorption within the ice ($F_{\\text{abs}}$), and transmission to the ocean ($F_{\\text{trans}}$). The derivation will be based on the principles of energy conservation and the Beer-Lambert Law for radiative attenuation.\n\nLet $F_0$ be the downward SWR flux incident on the air-ice interface.\n\nStep 1: Surface Reflection\nThe problem states that a fraction $R_s$ of the incident flux is reflected at the surface. The total reflected flux, $F_{\\text{surf}}$, is therefore:\n$$\nF_{\\text{surf}} = R_s \\cdot F_0\n$$\nThis component of the radiation does not enter the ice slab.\n\nStep 2: Flux Entering the Ice\nBy energy conservation at the air-ice interface, the flux that is not reflected must penetrate the ice surface. Let this flux be $F_{\\text{in}}$.\n$$\nF_{\\text{in}} = F_0 - F_{\\text{surf}} = F_0 - R_s F_0 = (1 - R_s) F_0\n$$\n\nStep 3: Two-Band Spectral Attenuation\nThe problem specifies a two-band spectral model. The flux entering the ice, $F_{\\text{in}}$, is partitioned into two spectral streams.\n- The flux in the first stream at the surface ($z=0$) is $F_{1, \\text{in}} = f_1 \\cdot F_{\\text{in}}$.\n- The flux in the second stream at the surface ($z=0$) is $F_{2, \\text{in}} = f_2 \\cdot F_{\\text{in}} = (1 - f_1) F_{\\text{in}}$.\n\nEach stream is attenuated as it propagates through the ice of thickness $H$. The Beer-Lambert Law describes this exponential decay. The flux $F(z)$ at a depth $z$ for a stream with an extinction coefficient $k$ is given by $F(z) = F(0) e^{-kz}$, where $F(0)$ is the flux at the surface.\n\nThe flux of each stream that reaches the ice-ocean interface at depth $z=H$ is:\n- For the first stream: $F_{1, \\text{trans}}(H) = F_{1, \\text{in}} \\cdot e^{-k_1 H} = f_1 (1 - R_s) F_0 e^{-k_1 H}$.\n- For the second stream: $F_{2, \\text{trans}}(H) = F_{2, \\text{in}} \\cdot e^{-k_2 H} = (1 - f_1) (1 - R_s) F_0 e^{-k_2 H}$.\n\nStep 4: Transmission to the Ocean\nIt is stated that all radiation reaching the ice-ocean interface is transmitted into the ocean without further reflection. Therefore, the total transmitted flux, $F_{\\text{trans}}$, is the sum of the transmitted fluxes from both spectral streams.\n$$\nF_{\\text{trans}} = F_{1, \\text{trans}}(H) + F_{2, \\text{trans}}(H)\n$$\nSubstituting the expressions from Step 3:\n$$\nF_{\\text{trans}} = f_1 (1 - R_s) F_0 e^{-k_1 H} + (1 - f_1) (1 - R_s) F_0 e^{-k_2 H}\n$$\nFactoring out the common terms, we obtain the final expression for the transmitted flux:\n$$\nF_{\\text{trans}} = (1 - R_s) F_0 \\left[ f_1 e^{-k_1 H} + (1 - f_1) e^{-k_2 H} \\right]\n$$\n\nStep 5: Absorption within the Ice\nThe total incident flux must be conserved. It is either reflected, absorbed, or transmitted.\n$$\nF_0 = F_{\\text{surf}} + F_{\\text{abs}} + F_{\\text{trans}}\n$$\nWe can solve for the absorbed flux, $F_{\\text{abs}}$, by rearranging this conservation equation:\n$$\nF_{\\text{abs}} = F_0 - F_{\\text{surf}} - F_{\\text{trans}}\n$$\nThis approach ensures that the energy budget is closed by definition.\n\nAlternatively, we can calculate the absorbed flux directly as the difference between the energy that enters the ice and the energy that is transmitted through it:\n$$\nF_{\\text{abs}} = F_{\\text{in}} - F_{\\text{trans}}\n$$\nSubstituting the expressions for $F_{\\text{in}}$ and $F_{\\text{trans}}$:\n$$\nF_{\\text{abs}} = (1 - R_s) F_0 - (1 - R_s) F_0 \\left[ f_1 e^{-k_1 H} + (1 - f_1) e^{-k_2 H} \\right]\n$$\n$$\nF_{\\text{abs}} = (1 - R_s) F_0 \\left( 1 - \\left[ f_1 e^{-k_1 H} + (1 - f_1) e^{-k_2 H} \\right] \\right)\n$$\nBoth methods for calculating $F_{\\text{abs}}$ are equivalent and will yield the same numerical results, assuming floating-point arithmetic of sufficient precision. The numerical implementation will use the conservation of energy principle for its robustness.\n\nSummary of Formulas for Computation:\n1.  $F_{\\text{surf}} = R_s F_0$\n2.  $F_{\\text{trans}} = (1 - R_s) F_0 \\left[ f_1 e^{-k_1 H} + (1 - f_1) e^{-k_2 H} \\right]$\n3.  $F_{\\text{abs}} = F_0 - F_{\\text{surf}} - F_{\\text{trans}}$\n\nThese three formulas will be applied to each of the provided test cases to compute the required flux partitions.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the partitioning of incident Shortwave Radiation (SWR) for sea ice\n    into surface reflection, absorption within the ice, and transmission to the ocean.\n    The model is based on energy conservation and the Beer-Lambert Law for a\n    two-band spectral representation.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (F0, H, Rs, f1, k1, k2)\n    # F0: Incident SWR flux (W/m^2)\n    # H: Ice thickness (m)\n    # Rs: Surface reflectance (dimensionless)\n    # f1: Fraction of penetrating SWR in the first spectral band (dimensionless)\n    # k1: Extinction coefficient for the first band (1/m)\n    # k2: Extinction coefficient for the second band (1/m)\n    test_cases = [\n        # 1. Happy path\n        (300.0, 1.2, 0.06, 0.55, 1.2, 4.0),\n        # 2. Boundary case (zero thickness)\n        (300.0, 0.0, 0.06, 0.55, 1.2, 4.0),\n        # 3. Edge case (very thick ice)\n        (300.0, 5.0, 0.06, 0.55, 1.2, 4.0),\n        # 4. Edge case (one non-attenuating stream)\n        (300.0, 1.2, 0.06, 0.30, 0.0, 10.0),\n        # 5. Edge case (high surface reflectance)\n        (300.0, 1.2, 0.50, 0.55, 1.2, 4.0),\n    ]\n\n    results = []\n    for case in test_cases:\n        F0, H, Rs, f1, k1, k2 = case\n        f2 = 1.0 - f1\n\n        # 1. Compute surface reflection (F_surf)\n        # Fraction Rs of the incident flux F0 is reflected at the surface.\n        F_surf = Rs * F0\n\n        # 2. Compute transmission to the ocean (F_trans)\n        # The remaining flux (1 - Rs)*F0 enters the ice and is partitioned into\n        # two streams, f1 and f2, which are attenuated exponentially according\n        # to the Beer-Lambert Law.\n        F_in = (1.0 - Rs) * F0\n        \n        # Calculate transmitted flux for each stream and sum them.\n        # F_trans_1 = F_in * f1 * exp(-k1 * H)\n        # F_trans_2 = F_in * f2 * exp(-k2 * H)\n        # F_trans = F_trans_1 + F_trans_2\n        F_trans = F_in * (f1 * np.exp(-k1 * H) + f2 * np.exp(-k2 * H))\n\n        # 3. Compute absorption within the ice (F_abs)\n        # By energy conservation, the total flux must be accounted for.\n        # F0 = F_surf + F_abs + F_trans\n        F_abs = F0 - F_surf - F_trans\n\n        # Store the triplet [F_surf, F_abs, F_trans]\n        # In the edge case of H=0, F_abs can be a very small negative number\n        # due to floating point inaccuracies, so we clip it at 0.\n        if abs(F_abs)  1e-12:\n            F_abs = 0.0\n\n        results.append([F_surf, F_abs, F_trans])\n\n    # Format the final output string as specified.\n    # [[x1,y1,z1],[x2,y2,z2],...]\n    # Each number must have exactly six digits after the decimal point.\n    formatted_results = []\n    for res_triplet in results:\n        formatted_triplet = [f\"{val:.6f}\" for val in res_triplet]\n        formatted_results.append(f\"[{','.join(formatted_triplet)}]\")\n    \n    final_output = f\"[{','.join(formatted_results)}]\"\n\n    # Final print statement in the exact required format.\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "Numerical models are only as reliable as their adherence to fundamental physical principles. This exercise moves from modeling a single process to the critical practice of model verification, focusing on the conservation of mass. You will design a test in which a sea ice field melts completely, verifying that the freshwater flux into the ocean precisely matches the total decrease in ice mass, a check that must hold to machine precision in any robust coupled model .",
            "id": "3789184",
            "problem": "You are asked to implement and verify mass conservation for freshwater in a coupled ocean–sea ice model under a controlled melting scenario. The verification must start from the statement of conservation of mass: the decrease in total sea ice mass must equal the freshwater flux into the ocean resulting from melting when no other sources or sinks are present. You must use a discrete representation of the sea ice field on a rectangular grid, with the following physically grounded assumptions: (i) all meltwater is added to the ocean as freshwater, (ii) no freezing, sublimation, or snow processes act during the test interval, (iii) sea ice density is constant, and (iv) the ice thickness does not become negative; complete melting is handled by limiting melt to the available thickness.\n\nLet the total sea ice mass at time $t$ be $M_i(t) = \\rho_i \\int_{\\Omega} A(x,y) H_i(x,y,t) \\,\\mathrm{d}A$, where $A(x,y)$ is the ice area fraction, $H_i(x,y,t)$ is the ice thickness, $\\rho_i$ is the ice density, and $\\Omega$ is the horizontal domain. Let the spatially uniform melt rate be $\\dot{m}$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$ applied for duration $\\Delta t$ in $\\mathrm{s}$. Over one time step, the melt thickness applied at each grid cell is $\\Delta H_m(x,y) = \\min\\left(H_i(x,y,t), \\dot{m}\\,\\Delta t\\right)$, and the post-melt thickness is $H_i(x,y,t+\\Delta t) = H_i(x,y,t) - \\Delta H_m(x,y)$. The integrated freshwater flux into the ocean over the time step, measured in $\\mathrm{kg}$, is defined as $Q_{\\mathrm{fw}} = \\rho_i \\int_{\\Omega} A(x,y) \\,\\Delta H_m(x,y) \\,\\mathrm{d}A$. Under the assumptions above, conservation of mass implies $M_i(t) - M_i(t+\\Delta t) = Q_{\\mathrm{fw}}$.\n\nYou must implement a program that constructs a set of test cases in which the ice melts completely (that is, $H_i(x,y,t+\\Delta t) = 0$ everywhere), computes $M_i(t)$, $M_i(t+\\Delta t)$, and $Q_{\\mathrm{fw}}$ using double-precision arithmetic, and evaluates whether the equality $M_i(t) - M_i(t+\\Delta t) = Q_{\\mathrm{fw}}$ holds to machine precision. For numerical robustness in summation, you should use a compensated summation method to reduce round-off error. You must report the relative error\n$$E_{\\mathrm{rel}} = \\frac{\\left|Q_{\\mathrm{fw}} - \\left(M_i(t) - M_i(t+\\Delta t)\\right)\\right|}{\\max\\left(M_i(t), 1\\right)}$$\nand declare the test successful if $E_{\\mathrm{rel}} \\le \\tau$, where $\\tau$ is a threshold representing machine precision. Use $\\tau = 512\\,\\epsilon$, where $\\epsilon$ is the machine epsilon for double precision.\n\nPhysical units and constants:\n- Sea ice density $\\rho_i$ is specified in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n- Ice thickness $H_i$ and melt thickness $\\Delta H_m$ are specified in $\\mathrm{m}$.\n- Time step $\\Delta t$ is specified in $\\mathrm{s}$.\n- Cell areas are specified in $\\mathrm{m}^2$.\n- The freshwater flux $Q_{\\mathrm{fw}}$ and the total mass $M_i$ are in $\\mathrm{kg}$.\n\nImplement the following test suite. In every case, ensure complete melting by using $\\dot{m}\\,\\Delta t$ larger than or equal to the maximum initial thickness. Use a fixed pseudorandom seed to make the fields deterministic.\n\n- Test case $1$ (general two-dimensional domain, constant cell area):\n  - Grid size: $64 \\times 64$.\n  - Grid cell size: $\\Delta x = 10{,}000\\,\\mathrm{m}$, $\\Delta y = 10{,}000\\,\\mathrm{m}$ (constant over the domain).\n  - Ice area fraction: $A(x,y) = 0.6$ (constant).\n  - Initial thickness: Uniformly distributed in $[0.1, 2.0]\\,\\mathrm{m}$.\n  - Sea ice density: $\\rho_i = 917\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n  - Melt rate and time: $\\dot{m} = 3\\times 10^{-6}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 3\\times 10^{6}\\,\\mathrm{s}$.\n\n- Test case $2$ (spatially varying cell area and area fraction):\n  - Grid size: $32 \\times 32$.\n  - Grid cell sizes: $\\Delta x(i)$ linearly spaced from $5{,}000\\,\\mathrm{m}$ to $20{,}000\\,\\mathrm{m}$ along the $x$-direction, $\\Delta y(j)$ linearly spaced from $5{,}000\\,\\mathrm{m}$ to $20{,}000\\,\\mathrm{m}$ along the $y$-direction, so that the cell area is $\\Delta x(i)\\,\\Delta y(j)$.\n  - Ice area fraction: Uniformly distributed in $[0, 1]$.\n  - Initial thickness: Uniformly distributed in $[0.0, 2.0]\\,\\mathrm{m}$.\n  - Sea ice density: $\\rho_i = 917\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n  - Melt rate and time: $\\dot{m} = 3\\times 10^{-6}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 3\\times 10^{6}\\,\\mathrm{s}$.\n\n- Test case $3$ (no initial ice):\n  - Grid size: $16 \\times 16$.\n  - Grid cell size: $\\Delta x = 10{,}000\\,\\mathrm{m}$, $\\Delta y = 10{,}000\\,\\mathrm{m}$.\n  - Ice area fraction: Uniformly distributed in $[0, 1]$.\n  - Initial thickness: Identically $0\\,\\mathrm{m}$.\n  - Sea ice density: $\\rho_i = 917\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n  - Melt rate and time: $\\dot{m} = 3\\times 10^{-6}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 3\\times 10^{6}\\,\\mathrm{s}$.\n\n- Test case $4$ (thin new ice layer, structured area fraction):\n  - Grid size: $8 \\times 8$.\n  - Grid cell size: $\\Delta x = 10{,}000\\,\\mathrm{m}$, $\\Delta y = 10{,}000\\,\\mathrm{m}$.\n  - Ice area fraction: $A(i,j) = \\left(\\frac{i}{8}\\right)\\left(\\frac{j}{8}\\right)$ for indices $i=1,\\dots,8$, $j=1,\\dots,8$.\n  - Initial thickness: Uniformly distributed in $[0.005, 0.02]\\,\\mathrm{m}$.\n  - Sea ice density: $\\rho_i = 917\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n  - Melt rate and time: $\\dot{m} = 3\\times 10^{-6}\\,\\mathrm{m}\\,\\mathrm{s}^{-1}$, $\\Delta t = 3\\times 10^{6}\\,\\mathrm{s}$.\n\nYour program must compute $M_i(t)$, $M_i(t+\\Delta t)$, $Q_{\\mathrm{fw}}$, and $E_{\\mathrm{rel}}$ for each test case, evaluate the condition $E_{\\mathrm{rel}} \\le \\tau$, and produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[r_1,r_2,r_3,r_4]$, where each $r_k$ is a boolean indicating whether the verification succeeded for test case $k$.",
            "solution": "The problem requires the numerical verification of the principle of mass conservation for freshwater in a coupled ocean-sea ice model. The verification is performed under a controlled scenario of complete sea ice melt. The core of the task is to implement the physical model in a discrete-grid context and to check if the numerically computed change in ice mass equals the numerically computed freshwater flux, within a tolerance defined by machine precision.\n\nThe physical principle is the conservation of mass. In the given context, with no sources or sinks other than melting, the decrease in the total mass of sea ice, $M_i$, over a time interval $\\Delta t$ must be equal to the total mass of freshwater, $Q_{\\mathrm{fw}}$, that flows into the ocean due to melting. This is expressed by the equation:\n$$M_i(t) - M_i(t+\\Delta t) = Q_{\\mathrm{fw}}$$\nThe problem provides the continuous integral definitions for the total ice mass and the freshwater flux. The total mass at a time $t$ is given by the integral of ice volume multiplied by density over the domain $\\Omega$:\n$$M_i(t) = \\rho_i \\int_{\\Omega} A(x,y) H_i(x,y,t) \\,\\mathrm{d}A$$\nHere, $\\rho_i$ is the constant sea ice density, $A(x,y)$ is the ice area fraction (concentration), and $H_i(x,y,t)$ is the ice thickness.\n\nThe simulation is performed on a discrete rectangular grid with indices $(i,j)$. The continuous integrals are therefore approximated by summations over all grid cells. The area element $\\mathrm{d}A$ becomes the discrete cell area $\\text{Area}_{ij} = \\Delta x_i \\Delta y_j$. The discretized form of the initial mass is:\n$$M_i(t) = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot H_{i,ij}(t)$$\n\nThe melting process is modeled over a single time step of duration $\\Delta t$ with a uniform melt rate $\\dot{m}$. This defines a potential melt thickness $H_p = \\dot{m}\\Delta t$. The actual melt thickness in each cell, $\\Delta H_{m,ij}$, cannot exceed the ice thickness available in that cell. This is captured by the relation:\n$$\\Delta H_{m,ij} = \\min\\left(H_{i,ij}(t), H_p\\right)$$\nThe ice thickness after melting is:\n$$H_{i,ij}(t+\\Delta t) = H_{i,ij}(t) - \\Delta H_{m,ij}$$\nFrom this, the total mass at time $t+\\Delta t$ is computed as:\n$$M_i(t+\\Delta t) = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot H_{i,ij}(t+\\Delta t)$$\nThe total freshwater flux into the ocean is the sum of mass melted from all cells:\n$$Q_{\\mathrm{fw}} = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot \\Delta H_{m,ij}$$\n\nA key condition of the test cases is that melting is complete, i.e., $H_i(x,y,t+\\Delta t) = 0$ everywhere. This is ensured by choosing $H_p$ to be greater than the maximum possible initial ice thickness. Under this condition, $\\Delta H_{m,ij}$ simplifies to $H_{i,ij}(t)$ for all $(i,j)$, and consequently, $H_{i,ij}(t+\\Delta t)$ becomes $0$. This implies that the computed total mass $M_i(t+\\Delta t)$ will be $0$. The conservation equation then simplifies to verifying whether the computed $M_i(t)$ is equal to the computed $Q_{\\mathrm{fw}}$. Since $\\Delta H_{m,ij} = H_{i,ij}(t)$, the summations for $M_i(t)$ and $Q_{\\mathrm{fw}}$ are over identical sets of terms.\n$$M_i(t) = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot H_{i,ij}(t)$$\n$$Q_{\\mathrm{fw}} = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot \\Delta H_{m,ij} = \\sum_{i,j} \\rho_i \\cdot \\text{Area}_{ij} \\cdot A_{ij} \\cdot H_{i,ij}(t)$$\nThe verification thus becomes a test of numerical self-consistency.\n\nDue to the finite precision of floating-point arithmetic (double-precision, or $64$-bit, floats are used), summing a large number of values can lead to an accumulation of round-off errors. To mitigate this, the problem specifies the use of a compensated summation method. The Kahan summation algorithm is a standard choice for this purpose. It maintains a running compensation term, $c$, which accumulates the error lost in each addition. For each value $x$ to be added to the sum $s$:\n$1$. $y = x - c$ (Subtract the-prior error from the current term).\n$2$. $t = s + y$ (Add the corrected term to the sum; some low-order bits of $y$ may be lost).\n$3$. $c = (t - s) - y$ (The lost part is recovered and stored in $c$).\n$4$. $s = t$ (Update the sum).\nThis procedure ensures that the final sum is significantly more accurate than a naive summation.\n\nThe verification of the conservation law is performed by computing the relative error, $E_{\\mathrm{rel}}$:\n$$E_{\\mathrm{rel}} = \\frac{\\left|Q_{\\mathrm{fw}} - \\left(M_i(t) - M_i(t+\\Delta t)\\right)\\right|}{\\max\\left(M_i(t), 1\\right)}$\nThe use of $\\max(M_i(t), 1)$ in the denominator prevents division by zero or errors from a very small denominator, for instance in Test Case $3$ where the initial mass is zero. The test is considered successful if $E_{\\mathrm{rel}}$ is below a threshold $\\tau = 512\\epsilon$, where $\\epsilon$ is the machine epsilon for double-precision numbers. This tolerance allows for minute floating-point discrepancies that might arise even with compensated summation.\n\nThe implementation will proceed by constructing each of the four test cases. A fixed-seed pseudorandom number generator ensures the deterministic creation of ice thickness and area fraction fields. For each case, the algorithm will:\n$1$. Initialize the grid, parameters, and random fields.\n$2$. Calculate the per-cell values for initial mass, final mass, and freshwater flux.\n$3$. Sum these per-cell values using the Kahan-compensated summation algorithm to obtain the total quantities $M_i(t)$, $M_i(t+\\Delta t)$, and $Q_{\\mathrm{fw}}$.\n$4$. Compute $E_{\\mathrm{rel}}$ using these total quantities.\n$5$. Compare $E_{\\mathrm{rel}}$ with $\\tau$ to determine if the test passes.\nThe boolean results from all four tests are collected and printed in the specified format. Since the problem is constructed such that the quantities being compared are computed from identical terms, the numerical error is expected to be zero, and all tests should pass.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compensated_sum(arr: np.ndarray) - float:\n    \"\"\"\n    Performs Kahan compensated summation on a numpy array.\n    This reduces numerical error compared to a naive sum.\n    \"\"\"\n    s = np.float64(0.0)\n    c = np.float64(0.0)\n    for x in arr.flatten():\n        y = np.float64(x) - c\n        t = s + y\n        c = (t - s) - y\n        s = t\n    return s\n\ndef solve():\n    \"\"\"\n    Implements and verifies mass conservation for freshwater in a coupled \n    ocean–sea ice model under four controlled melting scenarios.\n    \"\"\"\n    \n    # Common physical constants and parameters\n    rho_i = np.float64(917.0)  # Sea ice density in kg/m^3\n    m_dot = np.float64(3e-6)   # Melt rate in m/s\n    delta_t = np.float64(3e6)  # Time step in s\n    potential_melt_thickness = m_dot * delta_t # Potential melt thickness in m\n\n    # Use a fixed seed for reproducible random fields\n    rng = np.random.default_rng(12345)\n\n    # Machine precision for verification\n    epsilon = np.finfo(np.float64).eps\n    tau = np.float64(512.0) * epsilon\n\n    results = []\n\n    # --- Test Case 1: General 2D domain, constant cell area ---\n    nx, ny = 64, 64\n    cell_area = np.float64(10000.0) * np.float64(10000.0)\n    A_frac = np.full((nx, ny), 0.6, dtype=np.float64)\n    H_initial = rng.uniform(0.1, 2.0, size=(nx, ny)).astype(np.float64)\n    \n    delta_H_melt = np.minimum(H_initial, potential_melt_thickness)\n    H_final = H_initial - delta_H_melt\n    \n    mass_terms_initial = rho_i * cell_area * A_frac * H_initial\n    mass_terms_final = rho_i * cell_area * A_frac * H_final\n    flux_terms = rho_i * cell_area * A_frac * delta_H_melt\n    \n    M_i_t = compensated_sum(mass_terms_initial)\n    M_i_t_dt = compensated_sum(mass_terms_final)\n    Q_fw = compensated_sum(flux_terms)\n    \n    mass_decrease = M_i_t - M_i_t_dt\n    denominator = max(M_i_t, 1.0)\n    E_rel = abs(Q_fw - mass_decrease) / denominator\n    results.append(E_rel = tau)\n\n    # --- Test Case 2: Spatially varying cell area and area fraction ---\n    nx, ny = 32, 32\n    dx = np.linspace(5000.0, 20000.0, nx, dtype=np.float64)\n    dy = np.linspace(5000.0, 20000.0, ny, dtype=np.float64)\n    cell_areas = np.outer(dx, dy)\n    A_frac = rng.uniform(0.0, 1.0, size=(nx, ny)).astype(np.float64)\n    H_initial = rng.uniform(0.0, 2.0, size=(nx, ny)).astype(np.float64)\n\n    delta_H_melt = np.minimum(H_initial, potential_melt_thickness)\n    H_final = H_initial - delta_H_melt\n\n    mass_terms_initial = rho_i * cell_areas * A_frac * H_initial\n    mass_terms_final = rho_i * cell_areas * A_frac * H_final\n    flux_terms = rho_i * cell_areas * A_frac * delta_H_melt\n\n    M_i_t = compensated_sum(mass_terms_initial)\n    M_i_t_dt = compensated_sum(mass_terms_final)\n    Q_fw = compensated_sum(flux_terms)\n\n    mass_decrease = M_i_t - M_i_t_dt\n    denominator = max(M_i_t, 1.0)\n    E_rel = abs(Q_fw - mass_decrease) / denominator\n    results.append(E_rel = tau)\n\n    # --- Test Case 3: No initial ice ---\n    nx, ny = 16, 16\n    cell_area = np.float64(10000.0) * np.float64(10000.0)\n    A_frac = rng.uniform(0.0, 1.0, size=(nx, ny)).astype(np.float64)\n    H_initial = np.zeros((nx, ny), dtype=np.float64)\n\n    delta_H_melt = np.minimum(H_initial, potential_melt_thickness)\n    H_final = H_initial - delta_H_melt\n\n    mass_terms_initial = rho_i * cell_area * A_frac * H_initial\n    mass_terms_final = rho_i * cell_area * A_frac * H_final\n    flux_terms = rho_i * cell_area * A_frac * delta_H_melt\n\n    M_i_t = compensated_sum(mass_terms_initial)\n    M_i_t_dt = compensated_sum(mass_terms_final)\n    Q_fw = compensated_sum(flux_terms)\n\n    mass_decrease = M_i_t - M_i_t_dt\n    denominator = max(M_i_t, 1.0)\n    E_rel = abs(Q_fw - mass_decrease) / denominator\n    results.append(E_rel = tau)\n\n    # --- Test Case 4: Thin new ice, structured area fraction ---\n    nx, ny = 8, 8\n    cell_area = np.float64(10000.0) * np.float64(10000.0)\n    i_indices = np.arange(1, nx + 1, dtype=np.float64).reshape(nx, 1)\n    j_indices = np.arange(1, ny + 1, dtype=np.float64).reshape(1, ny)\n    A_frac = (i_indices / np.float64(nx)) * (j_indices / np.float64(ny))\n    H_initial = rng.uniform(0.005, 0.02, size=(nx, ny)).astype(np.float64)\n    \n    delta_H_melt = np.minimum(H_initial, potential_melt_thickness)\n    H_final = H_initial - delta_H_melt\n\n    mass_terms_initial = rho_i * cell_area * A_frac * H_initial\n    mass_terms_final = rho_i * cell_area * A_frac * H_final\n    flux_terms = rho_i * cell_area * A_frac * delta_H_melt\n\n    M_i_t = compensated_sum(mass_terms_initial)\n    M_i_t_dt = compensated_sum(mass_terms_final)\n    Q_fw = compensated_sum(flux_terms)\n\n    mass_decrease = M_i_t - M_i_t_dt\n    denominator = max(M_i_t, 1.0)\n    E_rel = abs(Q_fw - mass_decrease) / denominator\n    results.append(E_rel = tau)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "This final practice challenges you to synthesize multiple physical processes into a coherent, coupled vertical column model, a core element of larger-scale climate simulations. You will derive and implement a single, energy-conserving time-step update for a system comprising snow, sea ice, and an ocean mixed layer, accounting for conductive fluxes, phase changes at two interfaces, and mixed-layer dynamics. Successfully constructing this update demonstrates the ability to translate complex, interacting physics into a consistent and verifiable numerical algorithm .",
            "id": "3789211",
            "problem": "You are asked to construct a one-dimensional vertical column model of a coupled snow–sea ice–ocean system and to implement one explicit time step update that obeys energy conservation. The column consists of a snow layer of depth $h_s$ lying atop a sea ice layer of thickness $h_i$, which in turn overlies an ocean mixed layer of depth $H_{ml}$. The ocean mixed layer is characterized by temperature $T_{ml}$ and practical salinity $S_{ml}$. The model is forced by a prescribed surface heat flux $Q_s$ (defined positive downward into the column), a prescribed deep-ocean heat flux $Q_b$ (defined positive upward into the mixed layer), and a snowfall rate $P$ (snow precipitation, defined positive downward). All fluxes and state changes must be handled so that the discrete time step update conserves energy in the column.\n\nYou must derive from first principles and implement discrete update relations for the prognostic variables $h_i$, $h_s$, $T_{ml}$, and $S_{ml}$ over a single time step of length $\\Delta t$. The derivation must use only widely accepted physical laws and core definitions applicable in computational oceanography, namely Fourier heat conduction, latent heat of fusion, and conservation of energy and salt. Do not assume any special formulas beyond these foundational principles. The final discrete update must enforce the following physically realistic constraints:\n- The ocean–ice interface is at the local seawater freezing temperature $T_f(S_{ml}) = \\lambda S_{ml}$, where $\\lambda = -0.054$ in $\\mathrm{^\\circ C/psu}$, and $T_f$ is expressed in degrees Celsius.\n- The snow–ice column conducts heat between a surface temperature $T_s$ and the interface temperature $T_f$ with a net downward conductive heat flux equal to the given surface flux as long as the surface remains at or below melting, $T_s \\le 0$ in degrees Celsius. If the implied $T_s$ from the surface flux would exceed $0$ in degrees Celsius, clamp $T_s$ to $0$ and treat the excess surface energy as available to melt snow first and then sea ice at the surface.\n- The turbulent ocean heat exchange with the ice–ocean interface is parameterized as a linear interfacial flux proportional to the mixed-layer to freezing-point temperature difference with coefficient $\\gamma$: $Q_{int} = \\gamma\\,(T_{ml} - T_f)$. This flux is positive upward (from ocean into ice) when $T_{ml}  T_f$.\n- The effective thermal resistance of the snow–ice stack is $R = h_s/k_s + h_i/k_i$, where $k_s$ and $k_i$ are the thermal conductivities of snow and ice, respectively. The conductive flux downward into the column is $Q_{cond} = (T_s - T_f)/R$.\n- Snowfall increases $h_s$ by $P\\,\\Delta t$. Melting reduces $h_s$ according to latent heat consumption; if all snow melts during the step, any remaining excess surface energy melts sea ice at the top surface.\n- Sea ice thickness changes due to latent heat at the interface plus any melt at the surface.\n- The mixed-layer heat content changes due to $Q_b$ and $Q_{int}$, and the mixed-layer salinity changes due to salt rejection during freezing or dilution during melting at the ice–ocean interface, using local conservation of salt. Assume any surface meltwater does not directly mix into the ocean mixed layer during the time step.\n\nYou must use the following constants and units:\n- Thermal conductivity of snow $k_s = 0.31$ in $\\mathrm{W\\,m^{-1}\\,K^{-1}}$.\n- Thermal conductivity of ice $k_i = 2.0$ in $\\mathrm{W\\,m^{-1}\\,K^{-1}}$.\n- Density of snow $\\rho_s = 330$ in $\\mathrm{kg\\,m^{-3}}$.\n- Density of ice $\\rho_i = 917$ in $\\mathrm{kg\\,m^{-3}}$.\n- Density of seawater $\\rho_w = 1025$ in $\\mathrm{kg\\,m^{-3}}$.\n- Specific heat capacity of seawater $c_{pw} = 3974$ in $\\mathrm{J\\,kg^{-1}\\,K^{-1}}$.\n- Latent heat of fusion $L_f = 3.34\\times10^5$ in $\\mathrm{J\\,kg^{-1}}$.\n- Interfacial heat exchange coefficient $\\gamma = 100$ in $\\mathrm{W\\,m^{-2}\\,K^{-1}}$.\n- Mixed-layer depth $H_{ml} = 50$ in $\\mathrm{m}$.\n- Time step $\\Delta t = 86400$ in $\\mathrm{s}$ (one day).\n\nYour derivation must start from the following base principles:\n- Fourier's law of heat conduction through a stack of layers, with additive thermal resistances.\n- Conservation of energy for the column, equating the net external energy input over the time step to the sum of internal energy changes (mixed-layer sensible heat plus latent heat consumed or released by phase change in snow and ice).\n- Conservation of salt for the mixed layer under brine rejection upon freezing and dilution upon melting at the ice–ocean interface.\n\nYour program must implement the derived update equations to compute $h_i^{n+1}$, $h_s^{n+1}$, $T_{ml}^{n+1}$, and $S_{ml}^{n+1}$ from $h_i^n$, $h_s^n$, $T_{ml}^n$, and $S_{ml}^n$. Then, for each test case, it must compute the signed energy residual\n$$\nR = \\Delta E_{ml} + \\Delta E_{snow,lat} + \\Delta E_{ice,lat} - (Q_s + Q_b)\\,\\Delta t,\n$$\nwhere $\\Delta E_{ml} = \\rho_w\\,c_{pw}\\,H_{ml}\\,(T_{ml}^{n+1} - T_{ml}^n)$ in $\\mathrm{J\\,m^{-2}}$, $\\Delta E_{snow,lat} = \\rho_s\\,L_f\\,(h_s^n - h_s^{n+1})$ in $\\mathrm{J\\,m^{-2}}$ (latent consumption is positive for net snow melting), and $\\Delta E_{ice,lat} = \\rho_i\\,L_f\\,(h_i^n - h_i^{n+1})$ in $\\mathrm{J\\,m^{-2}}$ (latent consumption is positive for net ice melting). A perfectly energy-conserving update will yield $R$ equal to $0$ in $\\mathrm{J\\,m^{-2}}$ up to numerical roundoff.\n\nAngles are not used; temperatures must be in degrees Celsius and all energies in $\\mathrm{J\\,m^{-2}}$. The program must produce a single line of output containing the $R$ values for all test cases as a comma-separated list enclosed in square brackets, for example, \"[$r_1$,$r_2$,$r_3$]\". Each $r_i$ must be printed as a floating-point number in $\\mathrm{J\\,m^{-2}}$.\n\nUse the following test suite of three parameter sets to exercise the update scheme:\n- Case $1$ (winter cooling, snow present): $h_i^n = 1.5$ in $\\mathrm{m}$, $h_s^n = 0.2$ in $\\mathrm{m}$, $T_{ml}^n = -1.5$ in $\\mathrm{^\\circ C}$, $S_{ml}^n = 32.0$ in $\\mathrm{psu}$, $Q_s = -50.0$ in $\\mathrm{W\\,m^{-2}}$, $Q_b = 2.0$ in $\\mathrm{W\\,m^{-2}}$, $P = 0.0$ in $\\mathrm{m\\,s^{-1}}$.\n- Case $2$ (summer melt, no snow): $h_i^n = 1.0$ in $\\mathrm{m}$, $h_s^n = 0.0$ in $\\mathrm{m}$, $T_{ml}^n = -1.0$ in $\\mathrm{^\\circ C}$, $S_{ml}^n = 30.0$ in $\\mathrm{psu}$, $Q_s = 150.0$ in $\\mathrm{W\\,m^{-2}}$, $Q_b = 2.0$ in $\\mathrm{W\\,m^{-2}}$, $P = 0.0$ in $\\mathrm{m\\,s^{-1}}$.\n- Case $3$ (strong cooling and light snowfall): $h_i^n = 0.5$ in $\\mathrm{m}$, $h_s^n = 0.3$ in $\\mathrm{m}$, $T_{ml}^n = -1.75$ in $\\mathrm{^\\circ C}$, $S_{ml}^n = 34.0$ in $\\mathrm{psu}$, $Q_s = -150.0$ in $\\mathrm{W\\,m^{-2}}$, $Q_b = 2.0$ in $\\mathrm{W\\,m^{-2}}$, $P = 1.0\\times10^{-7}$ in $\\mathrm{m\\,s^{-1}}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3]\"), where each element is the energy residual $R$ in $\\mathrm{J\\,m^{-2}}$ for the corresponding test case.",
            "solution": "The problem requires the derivation and implementation of a one-dimensional, explicit time-step update for a coupled snow–sea ice–ocean column model that conserves energy. The prognostic variables are the sea ice thickness $h_i$, snow depth $h_s$, mixed-layer temperature $T_{ml}$, and mixed-layer salinity $S_{ml}$. The derivation proceeds from the fundamental principles of heat conduction and conservation of energy and salt. All calculations are performed for a single time step $\\Delta t$ using the state at time $n$ to compute the state at time $n+1$.\n\nThe total energy of the column in Joules per square meter, $E_{total}$, can be expressed as the sum of the sensible heat in the ocean mixed layer and the latent heat stored in the snow and ice relative to a reference state of liquid water at the freezing point.\n$$ E_{total} = \\rho_w c_{pw} H_{ml} (T_{ml} - T_f) - \\rho_i L_f h_i - \\rho_s L_f h_s $$\nThe principle of energy conservation states that the change in the total energy of the system over a time step $\\Delta t$ must equal the net energy that has entered the system from external sources. The external energy fluxes are the surface heat flux $Q_s$ and the deep-ocean heat flux $Q_b$. Snowfall, $P$, also represents a mass and energy input. Since snow is already frozen, adding it to the column at rate $P$ is equivalent to an energy flux of $-\\rho_s L_f P$ relative to a liquid water reference. Thus, the total energy balance is:\n$$ \\frac{dE_{total}}{dt} = Q_s + Q_b - \\rho_s L_f P $$\nOur explicit update scheme must discretize this balance. We will derive the update equations for each state variable by considering the fluxes at each interface.\n\n**1. Initial Calculations at Time Step $n$**\n\nAt the beginning of the time step, several quantities are calculated based on the current state $(h_i^n, h_s^n, T_{ml}^n, S_{ml}^n)$.\n- The freezing temperature $T_f$ at the ice-ocean interface is a function of salinity:\n$$ T_f^n = \\lambda S_{ml}^n $$\nwhere $\\lambda = -0.054\\ \\mathrm{^\\circ C/psu}$.\n- The snow depth is updated with any new snowfall during the time step. This gives the total snow available for thermodynamic calculations:\n$$ h_s^* = h_s^n + P \\Delta t $$\n\n**2. Surface Energy Balance and Conductive Heat Flux**\n\nThe heat transfer through the snow and ice layers is governed by Fourier's law of conduction. The effective thermal resistance, $R^n$, of the composite slab is the sum of the resistances of the snow and ice layers:\n$$ R^n = \\frac{h_s^*}{k_s} + \\frac{h_i^n}{k_i} $$\nwhere $k_s$ and $k_i$ are the thermal conductivities of snow and ice, respectively.\n\nThe conductive heat flux, $Q_{cond}$, is positive downwards. The surface energy balance dictates the relationship between the atmospheric flux $Q_s$ and $Q_{cond}$.\nFirst, we determine the surface temperature, $T_{s,implied}$, that would be required if the entire surface flux $Q_s$ were conducted through the column:\n$$ Q_s = \\frac{T_{s,implied} - T_f^n}{R^n} \\implies T_{s,implied} = T_f^n + Q_s R^n $$\nTwo regimes are possible:\n- **No-melt regime ($T_{s,implied} \\le 0\\mathrm{^\\circ C}$):** The surface remains at or below freezing. The conductive flux is equal to the surface heat flux, $Q_{cond} = Q_s$. No energy is available for surface melt.\n- **Melt regime ($T_{s,implied}  0\\mathrm{^\\circ C}$):** The surface temperature cannot exceed the melting point and is clamped at $T_s = 0\\mathrm{^\\circ C}$. The conductive flux is then determined by the temperature gradient across the clamped surface and the ice-ocean interface:\n$$ Q_{cond} = \\frac{T_s - T_f^n}{R^n} = \\frac{0 - T_f^n}{R^n} = -\\frac{T_f^n}{R^n} $$\nThe portion of the surface heat flux $Q_s$ that is not conducted downwards is used to melt snow and/or ice at the surface. The flux available for surface melt, $F_{melt,s}$, is:\n$$ F_{melt,s} = Q_s - Q_{cond} $$\nThe total energy available for surface melt over the time step is $E_{melt,s} = F_{melt,s} \\Delta t$.\n\n**3. Phase Changes and Thickness Updates**\n\nThe thicknesses of snow and ice change due to surface melting and basal melting/freezing.\n\n**Surface Melt:**\nThe energy $E_{melt,s}$ first melts the available snow, $h_s^*$. The energy required to melt all snow is $E_{snow,max\\_melt} = \\rho_s L_f h_s^*$.\n- If $E_{melt,s} \\le E_{snow,max\\_melt}$, only snow melts. The change in snow depth due to melting is $\\Delta h_{s,melt} = -E_{melt,s} / (\\rho_s L_f)$. The new snow depth is $h_s^{n+1} = h_s^* + \\Delta h_{s,melt}$. No surface ice melt occurs, so $\\Delta h_{i,surf} = 0$.\n- If $E_{melt,s}  E_{snow,max\\_melt}$, all snow melts, so $h_s^{n+1} = 0$. The remaining energy, $E_{ice,surf\\_melt} = E_{melt,s} - E_{snow,max\\_melt}$, melts ice from the surface. The change in ice thickness due to surface melt is $\\Delta h_{i,surf} = -E_{ice,surf\\_melt} / (\\rho_i L_f)$.\n\n**Basal Melt/Growth:**\nAt the ice-ocean interface, heat is conducted from above ($Q_{cond}$) and supplied by the ocean from below ($Q_{int}^n$). The oceanic heat flux is parameterized as:\n$$ Q_{int}^n = \\gamma (T_{ml}^n - T_f^n) $$\nThe net heat flux at the interface available for phase change is $F_{basal} = Q_{cond} + Q_{int}^n$. A positive $F_{basal}$ value (net upward flux) causes melting, while a negative value causes freezing. The change in ice thickness at the base is given by the energy balance:\n$$ \\rho_i L_f \\frac{dh_i}{dt}\\bigg|_{basal} = -F_{basal} = -(Q_{cond} + Q_{int}^n) $$\nOver the time step $\\Delta t$, the change is:\n$$ \\Delta h_{i,basal} = -\\frac{(Q_{cond} + Q_{int}^n) \\Delta t}{\\rho_i L_f} $$\n\n**Total Thickness Update:**\nThe new ice thickness is the sum of the initial thickness and the changes at both surfaces:\n$$ h_i^{n+1} = h_i^n + \\Delta h_{i,surf} + \\Delta h_{i,basal} $$\nWe enforce the physical constraint $h_i^{n+1} \\ge 0$.\n\n**4. Mixed-Layer Temperature and Salinity Updates**\n\n**Temperature:**\nThe mixed layer exchanges heat with the ice above ($Q_{int}^n$, upward) and the deep ocean below ($Q_b$, upward). The net heat flux into the mixed layer is $Q_b - Q_{int}^n$. The change in mixed-layer temperature is:\n$$ \\rho_w c_{pw} H_{ml} \\frac{dT_{ml}}{dt} = Q_b - Q_{int}^n $$\n$$ T_{ml}^{n+1} = T_{ml}^n + \\frac{(Q_b - Q_{int}^n) \\Delta t}{\\rho_w c_{pw} H_{ml}} $$\n\n**Salinity:**\nMixed-layer salinity changes due to salt rejection during basal freezing and dilution from basal melting. We apply conservation of salt. The total salt in the mixed layer at time $n$ is $M_{salt}^n = S_{ml}^n \\rho_w H_{ml}$. The total water mass is $M_w^n = \\rho_w H_{ml}$. When a mass of ice $\\Delta m_{ice} = \\rho_i \\Delta h_{i,basal}$ forms or melts at the base, the water mass in the mixed layer changes by $\\Delta m_w = -\\Delta m_{ice}$.\n- If freezing ($\\Delta h_{i,basal}  0$), a mass of water $\\rho_i \\Delta h_{i,basal}$ is removed, leaving its salt behind. The new salinity increases.\n- If melting ($\\Delta h_{i,basal}  0$), a mass of freshwater $-\\rho_i \\Delta h_{i,basal}$ is added, diluting the salt. The new salinity decreases.\nBoth cases are described by the same conservation equation for the new salinity $S_{ml}^{n+1}$:\n$$ S_{ml}^{n+1} = \\frac{\\text{Total Salt}}{\\text{New Total Water Mass}} = \\frac{S_{ml}^n \\rho_w H_{ml}}{\\rho_w H_{ml} - \\rho_i \\Delta h_{i,basal}} $$\nThis ensures local salt conservation under the assumption that $H_{ml}$ remains constant.\n\n**5. Energy Conservation Residual**\n\nTo verify the energy-conserving nature of the scheme, we compute the residual $R$ as defined in the problem statement. This value represents the difference between the calculated change in the system's internal energy (sensible heat of the mixed layer plus latent heat of the snow and ice) and the total external energy input.\n$$ R = \\Delta E_{ml} + \\Delta E_{snow,lat} + \\Delta E_{ice,lat} - (Q_s + Q_b)\\Delta t $$\nThe components are calculated using the initial ($n$) and final ($n+1$) states:\n- $\\Delta E_{ml} = \\rho_w c_{pw} H_{ml} (T_{ml}^{n+1} - T_{ml}^n)$\n- $\\Delta E_{snow,lat} = \\rho_s L_f (h_s^n - h_s^{n+1})$\n- $\\Delta E_{ice,lat} = \\rho_i L_f (h_i^n - h_i^{n+1})$\n\nWith a consistent derivation, all internal energy exchanges cancel out, and $R$ should only reflect any mismatch between the model's total energy source/sink terms and the simplified external forcing term $(Q_s+Q_b)\\Delta t$. As derived in the thought process, the addition of snow mass $P$ represents an energy sink of $\\rho_s L_f P \\Delta t$ not accounted for in the external forcing term of the residual equation. Thus, we expect $R = -\\rho_s L_f P \\Delta t$. For cases where $P=0$, the residual $R$ should be zero up to floating-point precision.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print results.\n    \"\"\"\n    # Define physical constants and model parameters\n    constants = {\n        'k_s': 0.31,    # Thermal conductivity of snow (W m^-1 K^-1)\n        'k_i': 2.0,     # Thermal conductivity of ice (W m^-1 K^-1)\n        'rho_s': 330,   # Density of snow (kg m^-3)\n        'rho_i': 917,   # Density of ice (kg m^-3)\n        'rho_w': 1025,  # Density of seawater (kg m^-3)\n        'c_pw': 3974,   # Specific heat capacity of seawater (J kg^-1 K^-1)\n        'L_f': 3.34e5,  # Latent heat of fusion (J kg^-1)\n        'gamma': 100,   # Interfacial heat exchange coefficient (W m^-2 K^-1)\n        'H_ml': 50,     # Mixed-layer depth (m)\n        'delta_t': 86400, # Time step (s)\n        'lambda_tf': -0.054 # Freezing point salinity coefficient (°C / psu)\n    }\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (winter cooling, snow present)\n        {'h_i_n': 1.5, 'h_s_n': 0.2, 'T_ml_n': -1.5, 'S_ml_n': 32.0, 'Q_s': -50.0, 'Q_b': 2.0, 'P': 0.0},\n        # Case 2 (summer melt, no snow)\n        {'h_i_n': 1.0, 'h_s_n': 0.0, 'T_ml_n': -1.0, 'S_ml_n': 30.0, 'Q_s': 150.0, 'Q_b': 2.0, 'P': 0.0},\n        # Case 3 (strong cooling and light snowfall)\n        {'h_i_n': 0.5, 'h_s_n': 0.3, 'T_ml_n': -1.75, 'S_ml_n': 34.0, 'Q_s': -150.0, 'Q_b': 2.0, 'P': 1.0e-7}\n    ]\n\n    results = []\n    for case in test_cases:\n        residual = one_step_update(case, constants)\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef one_step_update(case, const):\n    \"\"\"\n    Performs one explicit time step update for the coupled system.\n    _n denotes state at the beginning of the time step.\n    _np1 denotes state at the end of the time step.\n    \"\"\"\n    # Unpack case data and constants for clarity\n    h_i_n, h_s_n = case['h_i_n'], case['h_s_n']\n    T_ml_n, S_ml_n = case['T_ml_n'], case['S_ml_n']\n    Q_s, Q_b, P = case['Q_s'], case['Q_b'], case['P']\n    \n    k_s, k_i = const['k_s'], const['k_i']\n    rho_s, rho_i, rho_w = const['rho_s'], const['rho_i'], const['rho_w']\n    c_pw, L_f = const['c_pw'], const['L_f']\n    gamma, H_ml = const['gamma'], const['H_ml']\n    delta_t, lambda_tf = const['delta_t'], const['lambda_tf']\n    \n    # --- DERIVATION IMPLEMENTATION ---\n\n    # 1. Initial Calculations at Time n\n    # Snow depth after precipitation, before any melting\n    h_s_star = h_s_n + P * delta_t\n    # Seawater freezing temperature at the interface\n    T_f_n = lambda_tf * S_ml_n\n\n    # 2. Surface Energy Balance and Conductive Heat Flux\n    # Thermal resistance of the snow/ice column. Epsilon avoids division by zero.\n    R_n = h_s_star / k_s + h_i_n / k_i if (h_s_star + h_i_n)  1e-9 else 0.0\n\n    Q_cond = 0.0\n    E_melt_s = 0.0  # Total energy available for surface melt over the time step\n\n    if R_n  1e-9:\n        # Implied surface temperature to balance the surface heat flux Q_s\n        T_s_implied = T_f_n + Q_s * R_n\n\n        if T_s_implied = 0.0:\n            # No surface melt. Conductive flux equals surface flux.\n            Q_cond = Q_s\n        else:\n            # Surface melt occurs. Surface temperature is clamped at 0°C.\n            # Conductive flux is now determined by T_s=0 and T_f_n\n            Q_cond = (0.0 - T_f_n) / R_n\n            # Excess energy flux available for melting\n            F_melt_s = Q_s - Q_cond\n            E_melt_s = F_melt_s * delta_t\n    else: # Case of no ice/snow\n      # All Qs goes to the ocean, no conduction.\n      # This case is not in the test suite but is handled for completeness.\n      E_melt_s = Q_s * delta_t if Q_s  0 else 0\n\n    # 3. Phase Changes and Thickness Updates\n    # Surface Melt\n    E_snow_max_melt = rho_s * L_f * h_s_star\n    delta_h_i_surf = 0.0\n\n    if E_melt_s = E_snow_max_melt:\n        # Not all snow melts (or no melt at all)\n        delta_h_s_melt = -E_melt_s / (rho_s * L_f)\n        h_s_np1 = h_s_star + delta_h_s_melt\n    else:\n        # All snow melts, and remaining energy melts ice\n        h_s_np1 = 0.0\n        E_ice_surf_melt = E_melt_s - E_snow_max_melt\n        delta_h_i_surf = -E_ice_surf_melt / (rho_i * L_f)\n    \n    # Basal Melt/Growth\n    Q_int_n = gamma * (T_ml_n - T_f_n)\n    delta_h_i_basal = -(Q_cond + Q_int_n) * delta_t / (rho_i * L_f)\n    \n    # Total Thickness Update\n    h_i_np1 = h_i_n + delta_h_i_surf + delta_h_i_basal\n    # Enforce non-negativity. If triggered, would slightly violate energy conservation\n    # as the excess melt energy is not transferred elsewhere.\n    h_i_np1 = max(0.0, h_i_np1)\n    \n    # 4. Mixed-Layer Updates\n    # Temperature\n    T_ml_np1 = T_ml_n + (Q_b - Q_int_n) * delta_t / (rho_w * c_pw * H_ml)\n    \n    # Salinity\n    denominator = rho_w * H_ml - rho_i * delta_h_i_basal\n    if denominator  1e-9:\n        S_ml_np1 = S_ml_n * (rho_w * H_ml) / denominator\n    else:\n        # Avoid division by zero/negative in unrealistic case of massive freezing\n        S_ml_np1 = S_ml_n\n\n    # 5. Energy Conservation Residual Calculation\n    Delta_E_ml = rho_w * c_pw * H_ml * (T_ml_np1 - T_ml_n)\n    Delta_E_snow_lat = rho_s * L_f * (h_s_n - h_s_np1)\n    Delta_E_ice_lat = rho_i * L_f * (h_i_n - h_i_np1)\n    E_ext = (Q_s + Q_b) * delta_t\n    R = Delta_E_ml + Delta_E_snow_lat + Delta_E_ice_lat - E_ext\n    \n    return R\n\nsolve()\n```"
        }
    ]
}