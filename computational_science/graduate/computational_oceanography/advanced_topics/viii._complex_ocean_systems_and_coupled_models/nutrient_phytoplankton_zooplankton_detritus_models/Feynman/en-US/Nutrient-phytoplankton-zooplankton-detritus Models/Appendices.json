{
    "hands_on_practices": [
        {
            "introduction": "Understanding the equilibrium points of a system is a fundamental first step in model analysis. This practice focuses on the core component of any marine ecosystem model: phytoplankton. By calculating the steady-state phytoplankton biomass, you will explore the balance between growth, driven by light and nutrients, and loss processes, providing a quantitative understanding of what controls plankton populations under stable environmental conditions. ",
            "id": "3804839",
            "problem": "Consider a well-mixed euphotic layer described by a Nutrient-Phytoplankton-Zooplankton-Detritus (NPZD) model, in which the phytoplankton biomass concentration $P$ (in millimoles of nitrogen per cubic meter) obeys a mass-balance with a source due to growth and sinks due to linear and quadratic losses. The instantaneous phytoplankton growth rate $\\mu(I,N)$ depends on photosynthetically available irradiance $I$ (in watts per square meter) and dissolved inorganic nitrogen $N$ (in millimoles of nitrogen per cubic meter). Assume the following widely used parameterization for light and nutrient limitation in phytoplankton growth:\n$$\n\\mu(I,N) \\;=\\; \\mu_{\\mathrm{max}} \\,\\tanh\\!\\left(\\frac{\\alpha\\, I}{\\mu_{\\mathrm{max}}}\\right)\\, \\frac{N}{K_N + N},\n$$\nwhere $\\mu_{\\mathrm{max}}$ is the maximum growth rate (in per day), $\\alpha$ is the initial photosynthesis–irradiance slope (in per day per watt per square meter), and $K_N$ is the half-saturation constant for nitrogen uptake (in millimoles of nitrogen per cubic meter). The net biomass tendency is\n$$\n\\frac{dP}{dt} \\;=\\; \\mu(I,N)\\,P \\;-\\; r_P\\,P \\;-\\; m_P\\,P^2,\n$$\nwhere $r_P$ is a linear loss rate (in per day) and $m_P$ is a quadratic loss coefficient (in per day per millimole of nitrogen per cubic meter).\n\nSuppose the system experiences constant conditions with $I = 80~\\mathrm{W}\\,\\mathrm{m}^{-2}$ and $N = 2.0~\\mathrm{mmol~N}\\,\\mathrm{m}^{-3}$. The parameters are:\n- $\\mu_{\\mathrm{max}} = 1.5~\\mathrm{d}^{-1}$,\n- $\\alpha = 0.03~\\mathrm{d}^{-1}\\,(\\mathrm{W}\\,\\mathrm{m}^{-2})^{-1}$,\n- $K_N = 0.5~\\mathrm{mmol~N}\\,\\mathrm{m}^{-3}$,\n- $r_P = 0.12~\\mathrm{d}^{-1}$,\n- $m_P = 0.30~\\mathrm{d}^{-1}\\,(\\mathrm{mmol~N}\\,\\mathrm{m}^{-3})^{-1}$.\n\nCompute the unique positive steady-state phytoplankton biomass $P^{*}$, defined by the balance between growth and losses $\\mu(I,N)\\,P = r_P\\,P + m_P\\,P^2$, under these conditions, and express your final answer in millimoles of nitrogen per cubic meter. Round your answer to four significant figures.",
            "solution": "The problem provides a differential equation describing the time evolution of phytoplankton biomass concentration, $P$, within the framework of a Nutrient-Phytoplankton-Zooplankton-Detritus (NPZD) model. The governing equation is:\n$$\n\\frac{dP}{dt} \\;=\\; \\mu(I,N)\\,P \\;-\\; r_P\\,P \\;-\\; m_P\\,P^2\n$$\nThe phytoplankton growth rate, $\\mu(I,N)$, is a function of irradiance $I$ and nutrient concentration $N$, and is given by:\n$$\n\\mu(I,N) \\;=\\; \\mu_{\\mathrm{max}} \\,\\tanh\\!\\left(\\frac{\\alpha\\, I}{\\mu_{\\mathrm{max}}}\\right)\\, \\frac{N}{K_N + N}\n$$\nThe problem asks for the unique positive steady-state phytoplankton biomass, denoted as $P^*$. A steady state is achieved when the biomass concentration no longer changes with time, which mathematically corresponds to the condition $\\frac{dP}{dt} = 0$. Setting the governing equation to zero yields:\n$$\n\\mu(I,N)\\,P \\;-\\; r_P\\,P \\;-\\; m_P\\,P^2 \\;=\\; 0\n$$\nThis equation can be factored by taking $P$ as a common term:\n$$\nP \\left( \\mu(I,N) - r_P - m_P\\,P \\right) \\;=\\; 0\n$$\nThis algebraic equation has two possible solutions for $P$. The first is the trivial solution $P=0$, representing the absence of phytoplankton. The second, non-trivial solution is found by setting the term in the parenthesis to zero:\n$$\n\\mu(I,N) - r_P - m_P\\,P \\;=\\; 0\n$$\nSolving for $P$ gives the positive steady-state biomass $P^*$:\n$$\nP^* \\;=\\; \\frac{\\mu(I,N) - r_P}{m_P}\n$$\nA positive steady state ($P^* > 0$) exists only if the net growth rate is positive, i.e., $\\mu(I,N) > r_P$. We must first calculate the value of $\\mu(I,N)$ using the provided constant conditions and parameters.\n\nThe given values are:\n- Irradiance, $I = 80~\\mathrm{W}\\,\\mathrm{m}^{-2}$\n- Nutrient concentration, $N = 2.0~\\mathrm{mmol~N}\\,\\mathrm{m}^{-3}$\n- Maximum growth rate, $\\mu_{\\mathrm{max}} = 1.5~\\mathrm{d}^{-1}$\n- Initial P-I slope, $\\alpha = 0.03~\\mathrm{d}^{-1}\\,(\\mathrm{W}\\,\\mathrm{m}^{-2})^{-1}$\n- Half-saturation constant, $K_N = 0.5~\\mathrm{mmol~N}\\,\\mathrm{m}^{-3}$\n- Linear loss rate, $r_P = 0.12~\\mathrm{d}^{-1}$\n- Quadratic loss coefficient, $m_P = 0.30~\\mathrm{d}^{-1}\\,(\\mathrm{mmol~N}\\,\\mathrm{m}^{-3})^{-1}$\n\nFirst, we calculate the argument of the hyperbolic tangent function, which represents the light-limitation term:\n$$\n\\frac{\\alpha\\, I}{\\mu_{\\mathrm{max}}} \\;=\\; \\frac{(0.03)(80)}{1.5} \\;=\\; \\frac{2.4}{1.5} \\;=\\; 1.6\n$$\nThis value is dimensionless, as required.\n\nNext, we calculate the nutrient-limitation term using the Michaelis-Menten formulation:\n$$\n\\frac{N}{K_N + N} \\;=\\; \\frac{2.0}{0.5 + 2.0} \\;=\\; \\frac{2.0}{2.5} \\;=\\; 0.8\n$$\nThis value is also dimensionless.\n\nNow, we can compute the realized phytoplankton growth rate $\\mu(I,N)$:\n$$\n\\mu(I,N) \\;=\\; \\mu_{\\mathrm{max}} \\tanh(1.6) \\left(0.8\\right) \\;=\\; (1.5) \\tanh(1.6) (0.8) \\;=\\; 1.2 \\tanh(1.6)~\\mathrm{d}^{-1}\n$$\nUsing the value for the hyperbolic tangent, $\\tanh(1.6) \\approx 0.9216654$, we find:\n$$\n\\mu(I,N) \\approx 1.2 \\times 0.9216654 \\approx 1.1059985~\\mathrm{d}^{-1}\n$$\nWe now check the condition for the existence of a positive steady state, $\\mu(I,N) > r_P$:\n$$\n1.1059985~\\mathrm{d}^{-1} > 0.12~\\mathrm{d}^{-1}\n$$\nThe condition is satisfied, confirming the existence of a unique positive steady-state biomass $P^*$. We can now proceed to calculate its value:\n$$\nP^* \\;=\\; \\frac{\\mu(I,N) - r_P}{m_P} \\;=\\; \\frac{1.1059985 - 0.12}{0.30}~\\mathrm{mmol~N\\,m^{-3}}\n$$\n$$\nP^* \\;=\\; \\frac{0.9859985}{0.30}~\\mathrm{mmol~N\\,m^{-3}} \\approx 3.2866617~\\mathrm{mmol~N\\,m^{-3}}\n$$\nThe problem requires the answer to be rounded to four significant figures.\n$$\nP^* \\approx 3.287~\\mathrm{mmol~N\\,m^{-3}}\n$$\nThis is the unique positive steady-state phytoplankton biomass concentration under the given conditions.",
            "answer": "$$\n\\boxed{3.287}\n$$"
        },
        {
            "introduction": "While steady states provide a static picture, understanding how a system behaves when perturbed from equilibrium is crucial for assessing its realism. This exercise moves from a single component to a classic predator-prey interaction, introducing the powerful technique of linear stability analysis. You will investigate how the inclusion of a quadratic mortality term—a form of self-limitation—provides a stabilizing feedback that dampens oscillations, a critical feature for building robust and ecologically plausible models. ",
            "id": "3804874",
            "problem": "Consider a reduced predator–prey subsystem of a Nutrient–Phytoplankton–Zooplankton–Detritus (NPZD) model under a stationary nutrient supply, in which the nutrient concentration is approximately constant at $N(t) \\approx N^{*}$. In this regime, the phytoplankton specific growth rate is treated as a constant $ \\mu $ and the grazing is represented by a Holling Type I functional response. The dynamical system for phytoplankton biomass $P$ and zooplankton biomass $Z$ is\n$$\n\\frac{dP}{dt} = \\left( \\mu - m_{L} \\right) P - g Z P - m_{P} P^{2}, \\qquad \\frac{dZ}{dt} = \\varepsilon g P Z - m_{Z} Z,\n$$\nwhere $ \\mu $ is the phytoplankton specific growth rate, $ m_{L} $ is linear non-grazing phytoplankton loss, $ g $ is the grazing coefficient, $ \\varepsilon $ is the zooplankton growth efficiency, $ m_{Z} $ is the zooplankton mortality rate, and $ m_{P} $ is the quadratic phytoplankton mortality coefficient. The units are: $ \\mu $ and $ m_{L} $ in day$^{-1}$, $ g $ in m$^{3}$ (mmol N)$^{-1}$ day$^{-1}$, $ \\varepsilon $ dimensionless, $ m_{Z} $ in day$^{-1}$, and $ m_{P} $ in m$^{3}$ (mmol N)$^{-1}$ day$^{-1}$. Assume $ m_{P} $ is small and assess its effect on the linear stability near the interior equilibrium.\n\nStarting from biomass conservation principles (rate of change equals growth minus losses) and the given functional forms, first find the interior equilibrium $ (P^{*}, Z^{*}) $ of the system when $ m_{P} = 0 $. Then form the Jacobian matrix of the system and evaluate it at $ (P^{*}, Z^{*}) $. Next, include the quadratic mortality term (retain $ m_{P} \\neq 0 $) and determine its contribution to the Jacobian evaluated at the same $ (P^{*}, Z^{*}) $. Using the resulting Jacobian, compute the real part of the eigenvalues of the linearization, to leading order in $ m_{P} $, at $ (P^{*}, Z^{*}) $. Finally, evaluate this real part numerically using\n$$\n\\mu = 1.5, \\quad m_{L} = 0.3, \\quad g = 0.4, \\quad \\varepsilon = 0.6, \\quad m_{Z} = 0.5, \\quad m_{P} = 0.02,\n$$\nand report your result. Round your answer to four significant figures and express it in day$^{-1}$.",
            "solution": "The problem asks for a linear stability analysis of a phytoplankton-zooplankton predator-prey system. The system's dynamics are given by:\n$$\n\\frac{dP}{dt} = \\left( \\mu - m_{L} \\right) P - g Z P - m_{P} P^{2}\n$$\n$$\n\\frac{dZ}{dt} = \\varepsilon g P Z - m_{Z} Z\n$$\nThe analysis is performed around the interior equilibrium point of the system without the quadratic phytoplankton mortality term (i.e., where $m_P=0$).\n\n**Step 1: Find the interior equilibrium $(P^{*}, Z^{*})$**\nWe set the time derivatives to zero for the case $m_P=0$, assuming $P > 0$ and $Z > 0$:\n$$\n\\frac{dZ}{dt} = 0 \\implies (\\varepsilon g P - m_{Z})Z = 0 \\implies P^{*} = \\frac{m_{Z}}{\\varepsilon g}\n$$\n$$\n\\frac{dP}{dt} = 0 \\implies (\\mu - m_L - gZ)P = 0 \\implies Z^{*} = \\frac{\\mu - m_{L}}{g}\n$$\nThe interior equilibrium is $(P^{*}, Z^{*}) = \\left(\\frac{m_{Z}}{\\varepsilon g}, \\frac{\\mu - m_{L}}{g}\\right)$.\n\n**Step 2: Compute the Jacobian Matrix**\nNext, we linearize the full system (with $m_P \\neq 0$) by computing its Jacobian matrix $J$ around the equilibrium point $(P^{*}, Z^{*})$. The elements of the Jacobian are the partial derivatives of the rate equations:\n$$\nJ(P, Z) = \\begin{pmatrix} \\frac{\\partial}{\\partial P}\\left(\\frac{dP}{dt}\\right) & \\frac{\\partial}{\\partial Z}\\left(\\frac{dP}{dt}\\right) \\\\ \\frac{\\partial}{\\partial P}\\left(\\frac{dZ}{dt}\\right) & \\frac{\\partial}{\\partial Z}\\left(\\frac{dZ}{dt}\\right) \\end{pmatrix}\n$$\nThe partial derivatives are:\n- $\\frac{\\partial}{\\partial P}\\left(\\frac{dP}{dt}\\right) = \\mu - m_{L} - g Z - 2 m_{P} P$\n- $\\frac{\\partial}{\\partial Z}\\left(\\frac{dP}{dt}\\right) = -g P$\n- $\\frac{\\partial}{\\partial P}\\left(\\frac{dZ}{dt}\\right) = \\varepsilon g Z$\n- $\\frac{\\partial}{\\partial Z}\\left(\\frac{dZ}{dt}\\right) = \\varepsilon g P - m_{Z}$\n\nEvaluating these at $(P^{*}, Z^{*})$:\n- $J_{11} = (\\mu - m_L) - g\\left(\\frac{\\mu - m_L}{g}\\right) - 2m_P\\left(\\frac{m_Z}{\\varepsilon g}\\right) = -\\frac{2m_P m_Z}{\\varepsilon g}$\n- $J_{12} = -g\\left(\\frac{m_Z}{\\varepsilon g}\\right) = -\\frac{m_Z}{\\varepsilon}$\n- $J_{21} = \\varepsilon g \\left(\\frac{\\mu - m_L}{g}\\right) = \\varepsilon(\\mu - m_L)$\n- $J_{22} = \\varepsilon g \\left(\\frac{m_Z}{\\varepsilon g}\\right) - m_Z = 0$\n\nThe Jacobian matrix at the equilibrium is:\n$$\nJ(P^{*}, Z^{*}) = \\begin{pmatrix} -\\frac{2 m_{P} m_{Z}}{\\varepsilon g} & -\\frac{m_{Z}}{\\varepsilon} \\\\ \\varepsilon (\\mu - m_{L}) & 0 \\end{pmatrix}\n$$\n\n**Step 3: Determine the Real Part of the Eigenvalues**\nThe eigenvalues $\\lambda$ of a 2x2 matrix are given by the roots of the characteristic equation $\\lambda^2 - \\mathrm{Tr}(J)\\lambda + \\det(J) = 0$. The real part of the eigenvalues is determined by the trace of the Jacobian:\n$$\n\\mathrm{Re}(\\lambda) = \\frac{\\mathrm{Tr}(J)}{2}\n$$\nThe trace of our Jacobian is:\n$$\n\\mathrm{Tr}(J) = J_{11} + J_{22} = -\\frac{2 m_{P} m_{Z}}{\\varepsilon g} + 0 = -\\frac{2 m_{P} m_{Z}}{\\varepsilon g}\n$$\nTherefore, the real part of the eigenvalues is:\n$$\n\\mathrm{Re}(\\lambda) = \\frac{1}{2} \\left(-\\frac{2 m_{P} m_{Z}}{\\varepsilon g}\\right) = -\\frac{m_{P} m_{Z}}{\\varepsilon g}\n$$\nThis negative real part, which is proportional to $m_P$, indicates that the quadratic mortality term provides a stabilizing effect to the system.\n\n**Step 4: Numerical Calculation**\nUsing the given parameter values: $m_{P} = 0.02$, $m_{Z} = 0.5$, $\\varepsilon = 0.6$, and $g = 0.4$.\n$$\n\\mathrm{Re}(\\lambda) = -\\frac{(0.02)(0.5)}{(0.6)(0.4)} = -\\frac{0.01}{0.24} = -\\frac{1}{24} \\approx -0.041666...~\\mathrm{day}^{-1}\n$$\nRounding the result to four significant figures gives $-0.04167$. Expressed in scientific notation, this is $-4.167 \\times 10^{-2}$.",
            "answer": "$$\n\\boxed{-4.167 \\times 10^{-2}}\n$$"
        },
        {
            "introduction": "The ultimate goal of ecosystem modeling is often to simulate the complex interplay of biological and physical processes over time. This capstone practice guides you through the formulation and implementation of a complete NPZD model subject to seasonal environmental forcing, including a time-varying mixed-layer depth. Your task is to derive the governing equations from first principles, run a year-long simulation, and, most critically, verify the model's integrity by testing for the conservation of total nitrogen—a fundamental check for any robust numerical model. ",
            "id": "3804878",
            "problem": "You are to formulate, implement, and test a single-box mixed-layer nutrient–phytoplankton–zooplankton–detritus model starting from first principles of mass conservation and nitrogen closure. All state variables are nitrogen concentrations expressed in $\\mathrm{mmol\\,N\\,m^{-3}}$, time is expressed in $\\mathrm{d}$, the mixed-layer depth is expressed in $\\mathrm{m}$, detrital sinking speed is expressed in $\\mathrm{m\\,d^{-1}}$, and light is expressed in $\\mathrm{W\\,m^{-2}}$. The mixed-layer is a box of time-varying thickness $h(t)$ subject to prescribed seasonal forcing in light $I(t)$ and thickness $h(t)$.\n\nBase the model on the following fundamental principles that you must explicitly use to derive a closed system of ordinary differential equations for concentrations $N(t)$, $P(t)$, $Z(t)$, $D(t)$:\n- Mass conservation in a time-varying control volume: if $X(t)$ is a concentration and $M_X(t)=h(t)X(t)$ is the corresponding inventory per unit area, then the balance law is\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t}\\left[h(t)X(t)\\right] = h(t)\\,S_X(t) + F_X(t),\n$$\nwhere $S_X(t)$ is the net internal source-minus-sink rate per unit volume for $X$ and $F_X(t)$ is any external flux per unit area acting on $X$. Transform this to a concentration equation, noting that $\\frac{\\mathrm{d}}{\\mathrm{d}t}\\left[h(t)X(t)\\right] = h(t)\\,\\frac{\\mathrm{d}X}{\\mathrm{d}t} + X(t)\\,\\frac{\\mathrm{d}h}{\\mathrm{d}t}$.\n- Nitrogen closure for internal processes: internal transformation rates must conserve nitrogen among $\\{N,P,Z,D\\}$ so that $\\sum_X h(t) S_X(t) = 0$, meaning that any removal from one pool appears as a gain in one or more of the other pools.\n- Detrital sinking export: the only external loss from the box is due to detrital sinking out of the bottom at flux $F_D(t) = - w\\,D(t)$, where $w$ is the detrital sinking speed. There are no other external sources or sinks.\n\nUse the following process descriptions to define the internal source-minus-sink terms $S_X(t)$:\n- Phytoplankton growth uses dissolved nutrient $N$ and is limited by light $I(t)$ and nutrient $N(t)$ via a saturating Michaelis–Menten form. Let the specific growth rate be\n$$\n\\mu(t) = \\mu_{\\max}\\,\\frac{I(t)}{K_I + I(t)}\\,\\frac{N(t)}{K_N + N(t)},\n$$\nso the volumetric uptake from $N$ and production into $P$ is $+\\mu(t)P(t)$ to $P$ and $-\\mu(t)P(t)$ to $N$.\n- Zooplankton grazing on phytoplankton follows a Holling type-III functional response in $P$ with ingestion rate\n$$\nG(t) = g_{\\max}\\,\\frac{P(t)^2}{K_g^2 + P(t)^2}\\,Z(t).\n$$\nA fraction $\\gamma$ of ingested nitrogen is assimilated into $Z$, a fraction $\\xi$ is directly excreted to $N$, and the remaining fraction $1-\\gamma-\\xi$ goes to detritus $D$ (e.g., sloppy feeding and fecal production).\n- Linear mortality of phytoplankton and zooplankton at rates $m_P P(t)$ and $m_Z Z(t)$, respectively, produce detritus.\n- Detritus remineralizes back to dissolved nutrient at rate $r D(t)$.\n- There is no other external source or sink; in particular, there is no entrainment of external water other than the geometric dilution term implied by the time-varying $h(t)$.\n\nFrom these principles, derive the concentration equations for $N(t)$, $P(t)$, $Z(t)$, and $D(t)$, and explicitly include the geometric dilution term associated with the changing mixed-layer thickness. The dilution term arises from the transformation from inventory to concentration and must be consistent with the base mass conservation identity above.\n\nPrescribe the seasonal forcing functions and parameters as follows:\n- Mixed-layer depth:\n$$\nh(t) = h_0 + h_a \\cos\\!\\left(\\frac{2\\pi (t - t_h)}{T}\\right),\n$$\nwith $h_0 = 50\\,\\mathrm{m}$, $h_a = 20\\,\\mathrm{m}$, $t_h = 20\\,\\mathrm{d}$, and $T = 365\\,\\mathrm{d}$. You must analytically compute $\\frac{\\mathrm{d}h}{\\mathrm{d}t}$ for use in the dilution term.\n- Light:\n$$\nI(t) = I_{\\mathrm{bg}} + I_0 \\max\\!\\left\\{0,\\ \\sin\\!\\left(\\frac{2\\pi (t - t_I)}{T}\\right)\\right\\},\n$$\nwith $I_{\\mathrm{bg}} = 30\\,\\mathrm{W\\,m^{-2}}$, $I_0 = 200\\,\\mathrm{W\\,m^{-2}}$, and $t_I = 80\\,\\mathrm{d}$.\n- Biological and sinking parameters:\n$\\mu_{\\max} = 1.2\\,\\mathrm{d^{-1}}$, $K_I = 50\\,\\mathrm{W\\,m^{-2}}$, $K_N = 0.5\\,\\mathrm{mmol\\,N\\,m^{-3}}$, $g_{\\max} = 1.0\\,\\mathrm{d^{-1}}$, $K_g = 0.3\\,\\mathrm{mmol\\,N\\,m^{-3}}$, $\\gamma = 0.3$, $\\xi = 0.1$, $m_P = 0.03\\,\\mathrm{d^{-1}}$, $m_Z = 0.02\\,\\mathrm{d^{-1}}$, $r = 0.1\\,\\mathrm{d^{-1}}$, and $w$ varies by test case.\n- Initial conditions at $t=0$: $N(0) = 5.0\\,\\mathrm{mmol\\,N\\,m^{-3}}$, $P(0) = 0.5\\,\\mathrm{mmol\\,N\\,m^{-3}}$, $Z(0) = 0.2\\,\\mathrm{mmol\\,N\\,m^{-3}}$, $D(0) = 0.1\\,\\mathrm{mmol\\,N\\,m^{-3}}$.\n\nSimulate the model over one seasonal cycle of length $T=365\\,\\mathrm{d}$ using an ordinary differential equation solver with tolerances sufficiently small to assess conservation (use relative tolerance less than $10^{-8}$ and absolute tolerance less than $10^{-10}$). Use a fixed output time grid with spacing no larger than $0.5\\,\\mathrm{d}$ to evaluate flux integrals.\n\nDefine the area-integrated total nitrogen per unit area as\n$$\nM(t) = h(t)\\,\\big(N(t)+P(t)+Z(t)+D(t)\\big).\n$$\nThe theoretical conservation statement implied by the principles above is\n$$\nM(T) - M(0) + \\int_0^T w\\,D(t)\\,\\mathrm{d}t = 0,\n$$\nbecause the only external loss from the box is detrital export $w D(t)$.\n\nYour task is to implement the derived ordinary differential equations, simulate the seasonal cycle, and compute for each test case the normalized residual\n$$\nR = \\frac{\\left|M(T) - M(0) + \\int_0^T w\\,D(t)\\,\\mathrm{d}t\\right|}{\\left|M(0)\\right| + \\int_0^T w\\,D(t)\\,\\mathrm{d}t},\n$$\nwhich is a dimensionless float measuring the deviation from exact conservation. Lower values of $R$ indicate better conservation.\n\nTest Suite:\n- Case A (baseline seasonal cycle): $w = 5.0\\,\\mathrm{m\\,d^{-1}}$, $h_a = 20\\,\\mathrm{m}$.\n- Case B (no export): $w = 0.0\\,\\mathrm{m\\,d^{-1}}$, $h_a = 20\\,\\mathrm{m}$.\n- Case C (large mixed-layer amplitude): $w = 5.0\\,\\mathrm{m\\,d^{-1}}$, $h_a = 40\\,\\mathrm{m}$.\n\nYour program should produce a single line of output containing the three normalized residuals as a comma-separated list enclosed in square brackets in the order [Case A, Case B, Case C]. For example, the output format must be exactly like $[r_A,r_B,r_C]$, where each $r$ is a float.",
            "solution": "We begin by deriving the system of ordinary differential equations (ODEs) that govern the concentrations of the four state variables: nutrient ($N$), phytoplankton ($P$), zooplankton ($Z$), and detritus ($D$). All concentrations are expressed in units of $\\mathrm{mmol\\,N\\,m^{-3}}$.\n\nThe fundamental principle provided is the conservation of mass for a constituent with concentration $X(t)$ within a control volume defined by a time-varying mixed-layer depth $h(t)$ and a unit surface area. The inventory per unit area is $M_X(t) = h(t)X(t)$. The conservation law is given as:\n$$\n\\frac{\\mathrm{d}}{\\mathrm{d}t}\\left[h(t)X(t)\\right] = h(t)\\,S_X(t) + F_X(t)\n$$\nwhere $S_X(t)$ is the net internal source-sink rate per unit volume and $F_X(t)$ is the external flux per unit area.\n\nApplying the product rule for differentiation to the left-hand side, as specified:\n$$\nh(t)\\frac{\\mathrm{d}X}{\\mathrm{d}t} + X(t)\\frac{\\mathrm{d}h}{\\mathrm{d}t} = h(t)S_X(t) + F_X(t)\n$$\nSolving for the rate of change of concentration, $\\frac{\\mathrm{d}X}{\\mathrm{d}t}$, yields the general form for our ODEs:\n$$\n\\frac{\\mathrm{d}X}{\\mathrm{d}t} = S_X(t) + \\frac{F_X(t)}{h(t)} - \\frac{X(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}\n$$\nThe term $-\\frac{X(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}$ is the geometric dilution/concentration term, which accounts for changes in concentration due to the expansion or contraction of the mixed-layer volume.\n\nNext, we define the internal source-sink terms, $S_X$, for each component based on the specified biological and chemical processes. Let the volumetric rates of these processes be:\n- Phytoplankton uptake of nutrients: $U(t) = \\mu(t)P(t)$, where $\\mu(t) = \\mu_{\\max}\\,\\frac{I(t)}{K_I + I(t)}\\,\\frac{N(t)}{K_N + N(t)}$.\n- Zooplankton grazing on phytoplankton: $G(t) = g_{\\max}\\,\\frac{P(t)^2}{K_g^2 + P(t)^2}\\,Z(t)$.\n- Phytoplankton mortality: $M_P(t) = m_P P(t)$.\n- Zooplankton mortality: $M_Z(t) = m_Z Z(t)$.\n- Detritus remineralization: $R_D(t) = r D(t)$.\n\nThe nitrogen flows for these processes define the $S_X$ terms:\n- For $S_N$: Nitrogen is consumed by phytoplankton uptake, and supplied by zooplankton excretion and detritus remineralization. The fraction of grazed material excreted to nitrogen is $\\xi$.\n$$ S_N(t) = -U(t) + \\xi G(t) + R_D(t) = -\\mu(t)P(t) + \\xi G(t) + r D(t) $$\n- For $S_P$: Phytoplankton grows via nutrient uptake and is lost to zooplankton grazing and mortality.\n$$ S_P(t) = U(t) - G(t) - M_P(t) = \\mu(t)P(t) - G(t) - m_P P(t) $$\n- For $S_Z$: Zooplankton grows by assimilating a fraction $\\gamma$ of grazed phytoplankton and is lost to mortality.\n$$ S_Z(t) = \\gamma G(t) - M_Z(t) = \\gamma G(t) - m_Z Z(t) $$\n- For $S_D$: Detritus is produced from unassimilated grazing (fraction $1-\\gamma-\\xi$), and from phytoplankton and zooplankton mortality. It is lost through remineralization.\n$$ S_D(t) = (1-\\gamma-\\xi)G(t) + M_P(t) + M_Z(t) - R_D(t) = (1-\\gamma-\\xi)G(t) + m_P P(t) + m_Z Z(t) - r D(t) $$\nThese internal terms conserve nitrogen, i.e., $S_N + S_P + S_Z + S_D = 0$.\n\nThe external fluxes, $F_X$, are specified as zero for all compartments except detritus, which has a sinking loss:\n$F_N(t) = 0$, $F_P(t) = 0$, $F_Z(t) = 0$, and $F_D(t) = -w D(t)$.\n\nThe time-varying forcing functions are:\n- Mixed-layer depth: $h(t) = h_0 + h_a \\cos\\!\\left(\\frac{2\\pi (t - t_h)}{T}\\right)$\n- Rate of change of mixed-layer depth: $\\frac{\\mathrm{d}h}{\\mathrm{d}t} = -h_a \\frac{2\\pi}{T} \\sin\\!\\left(\\frac{2\\pi (t - t_h)}{T}\\right)$\n- Light availability: $I(t) = I_{\\mathrm{bg}} + I_0 \\max\\!\\left\\{0,\\ \\sin\\!\\left(\\frac{2\\pi (t - t_I)}{T}\\right)\\right\\}$\n\nCombining all terms, we obtain the final system of ODEs:\n$$\n\\frac{\\mathrm{d}N}{\\mathrm{d}t} = \\left[ -\\mu(t)P(t) + \\xi G(t) + r D(t) \\right] - \\frac{N(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}\n$$\n$$\n\\frac{\\mathrm{d}P}{\\mathrm{d}t} = \\left[ \\mu(t)P(t) - G(t) - m_P P(t) \\right] - \\frac{P(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}\n$$\n$$\n\\frac{\\mathrm{d}Z}{\\mathrm{d}t} = \\left[ \\gamma G(t) - m_Z Z(t) \\right] - \\frac{Z(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}\n$$\n$$\n\\frac{\\mathrm{d}D}{\\mathrm{d}t} = \\left[ (1-\\gamma-\\xi)G(t) + m_P P(t) + m_Z Z(t) - r D(t) \\right] - \\frac{w}{h(t)}D(t) - \\frac{D(t)}{h(t)}\\frac{\\mathrm{d}h}{\\mathrm{d}t}\n$$\nThis system is solved numerically using a high-precision ODE solver from $t=0$ to $t=T=365\\,\\mathrm{d}$ with the provided initial conditions and parameters for each test case.\n\nThe final step is to compute the normalized conservation residual, $R$. This requires calculating the total nitrogen inventory $M(t) = h(t)(N(t)+P(t)+Z(t)+D(t))$ at the start and end of the simulation, and numerically integrating the detrital export flux $\\int_0^T w D(t) \\mathrm{d}t$. The trapezoidal rule is applied to the time series of $D(t)$ obtained from the ODE solver.\nThe residual is then:\n$$\nR = \\frac{\\left|M(T) - M(0) + \\int_0^T w\\,D(t)\\,\\mathrm{d}t\\right|}{\\left|M(0)\\right| + \\int_0^T w\\,D(t)\\,\\mathrm{d}t}\n$$\nA value of $R$ close to zero indicates that the numerical solution has accurately preserved the model's total nitrogen budget over the seasonal cycle.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp, trapezoid\n\ndef solve():\n    \"\"\"\n    Formulates, implements, and tests an NPZD model to compute conservation residuals.\n    \"\"\"\n\n    # --- Static Parameters ---\n    params = {\n        'mu_max': 1.2,      # d^-1\n        'K_I': 50.0,        # W m^-2\n        'K_N': 0.5,         # mmol N m^-3\n        'g_max': 1.0,       # d^-1\n        'K_g': 0.3,         # mmol N m^-3\n        'gamma': 0.3,       # dimensionless\n        'xi': 0.1,          # dimensionless\n        'm_P': 0.03,        # d^-1\n        'm_Z': 0.02,        # d^-1\n        'r': 0.1,           # d^-1\n        'T': 365.0,         # d\n        'h0': 50.0,         # m\n        'th': 20.0,         # d\n        'I_bg': 30.0,       # W m^-2\n        'I0': 200.0,        # W m^-2\n        'tI': 80.0,         # d\n    }\n\n    # --- Initial Conditions ---\n    y0 = np.array([\n        5.0,  # N(0)\n        0.5,  # P(0)\n        0.2,  # Z(0)\n        0.1   # D(0)\n    ])\n\n    # --- Test Cases ---\n    test_cases = [\n        {'name': 'Case A', 'w': 5.0, 'h_a': 20.0},\n        {'name': 'Case B', 'w': 0.0, 'h_a': 20.0},\n        {'name': 'Case C', 'w': 5.0, 'h_a': 40.0},\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # Combine static and case-specific parameters\n        current_params = {**params, **case}\n\n        # --- Forcing functions ---\n        def h(t, p):\n            return p['h0'] + p['h_a'] * np.cos(2 * np.pi * (t - p['th']) / p['T'])\n\n        def dh_dt(t, p):\n            return -p['h_a'] * (2 * np.pi / p['T']) * np.sin(2 * np.pi * (t - p['th']) / p['T'])\n\n        def I(t, p):\n            light_cycle = np.sin(2 * np.pi * (t - p['tI']) / p['T'])\n            return p['I_bg'] + p['I0'] * np.maximum(0, light_cycle)\n\n        # --- ODE System Definition ---\n        def npzd_model(t, y, p):\n            N, P, Z, D = y\n            \n            # Ensure concentrations remain non-negative\n            N = max(0, N)\n            P = max(0, P)\n            Z = max(0, Z)\n            D = max(0, D)\n\n            # --- Time-dependent forcings and parameters ---\n            h_t = h(t, p)\n            dh_dt_t = dh_dt(t, p)\n            I_t = I(t, p)\n            \n            # Dilution/concentration term factor\n            dilution_factor = dh_dt_t / h_t\n\n            # --- Biological Rates ---\n            # Phytoplankton growth\n            light_lim = I_t / (p['K_I'] + I_t)\n            nutrient_lim = N / (p['K_N'] + N)\n            mu = p['mu_max'] * light_lim * nutrient_lim\n            uptake = mu * P\n\n            # Zooplankton grazing\n            grazing_term = P**2 / (p['K_g']**2 + P**2)\n            grazing = p['g_max'] * grazing_term * Z\n            \n            # --- ODEs ---\n            dNdt = -uptake + p['xi'] * grazing + p['r'] * D - N * dilution_factor\n            dPdt = uptake - grazing - p['m_P'] * P - P * dilution_factor\n            dZdt = p['gamma'] * grazing - p['m_Z'] * Z - Z * dilution_factor\n            dDdt = (1 - p['gamma'] - p['xi']) * grazing + p['m_P'] * P + p['m_Z'] * Z - p['r'] * D - (p['w'] / h_t) * D - D * dilution_factor\n\n            return [dNdt, dPdt, dZdt, dDdt]\n\n        # --- Numerical Integration ---\n        t_span = [0, params['T']]\n        t_eval = np.arange(0, params['T'] + 0.5, 0.5)\n\n        sol = solve_ivp(\n            npzd_model,\n            t_span,\n            y0,\n            method='RK45',\n            t_eval=t_eval,\n            args=(current_params,),\n            rtol=1e-9,  # Stricter than required for better accuracy\n            atol=1e-11\n        )\n\n        # --- Post-processing: Conservation Check ---\n        t_sol, y_sol = sol.t, sol.y\n        N, P, Z, D_sol = y_sol\n\n        # Initial total nitrogen inventory M(0)\n        h0_val = h(0, current_params)\n        M0 = h0_val * np.sum(y0)\n\n        # Final total nitrogen inventory M(T)\n        yT = y_sol[:, -1]\n        hT_val = h(params['T'], current_params)\n        MT = hT_val * np.sum(yT)\n\n        # Integrated detrital export\n        w = current_params['w']\n        detrital_flux = w * D_sol\n        integrated_export = trapezoid(detrital_flux, t_sol)\n        \n        # Normalized residual R\n        numerator = np.abs(MT - M0 + integrated_export)\n        denominator = np.abs(M0) + integrated_export\n\n        # Handle case where denominator is zero (perfect conservation, no flux)\n        if denominator == 0:\n            if numerator == 0:\n                residual = 0.0\n            else:\n                residual = np.inf # Should not happen with solver tolerances\n        else:\n            residual = numerator / denominator\n        \n        results.append(residual)\n\n    # --- Final Output ---\n    print(f\"[{','.join(f'{r:.12e}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}