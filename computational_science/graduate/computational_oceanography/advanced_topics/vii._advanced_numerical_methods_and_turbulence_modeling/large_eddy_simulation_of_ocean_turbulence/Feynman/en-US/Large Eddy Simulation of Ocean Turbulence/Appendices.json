{
    "hands_on_practices": [
        {
            "introduction": "The foundation of many Large Eddy Simulations lies in the implementation of a subgrid-scale (SGS) model. This first practice provides a direct, hands-on experience with the classic Smagorinsky model, one of the cornerstones of LES. By applying it to a simplified one-dimensional shear flow, you will translate the theoretical concept of an eddy viscosity, which scales with the resolved strain rate, into a concrete numerical algorithm . This exercise is essential for understanding how SGS models act to dissipate energy at the grid scale, mimicking the effect of unresolved turbulent eddies.",
            "id": "3798395",
            "problem": "Consider a depth-invariant barotropic plane shear current resolved in Large Eddy Simulation (LES) for ocean turbulence. The resolved velocity field is assumed horizontally homogeneous in the $x$ direction and vertically invariant, so that the two-dimensional velocity can be written as $\\mathbf{u}(y,t) = (u(y,t), 0)$ with $y \\in [0,L_y)$ and periodic boundary conditions in $y$. The filtered incompressible momentum equation is the starting point. With molecular viscosity $\\nu$ and subgrid-scale (SGS) stress $\\tau_{ij}$ arising from filtering, the resolved momentum equation is\n$$\n\\frac{\\partial u_i}{\\partial t} + \\frac{\\partial (u_i u_j)}{\\partial x_j} = -\\frac{1}{\\rho} \\frac{\\partial p}{\\partial x_i} + \\nu \\frac{\\partial^2 u_i}{\\partial x_j \\partial x_j} - \\frac{\\partial \\tau_{ij}}{\\partial x_j},\n$$\nwhere $\\rho$ is the density and $p$ is the pressure. In the Smagorinsky closure, the deviatoric part of $\\tau_{ij}$ is modeled using an eddy viscosity $\\nu_t$ built from the magnitude of the resolved rate-of-strain tensor $S_{ij}$, with\n$$\nS_{ij} = \\frac{1}{2} \\left( \\frac{\\partial u_i}{\\partial x_j} + \\frac{\\partial u_j}{\\partial x_i} \\right), \\quad \\nu_t = (C_s \\Delta)^2 \\, \\lVert S \\rVert, \\quad \\lVert S \\rVert = \\sqrt{2 S_{ij} S_{ij}},\n$$\nwhere $C_s$ is the Smagorinsky constant and $\\Delta$ is the filter width, here taken equal to the uniform grid spacing $\\Delta y$. For the described one-dimensional shear flow $u(y,t)$, you must derive the appropriate expression for $\\lVert S \\rVert$ and formulate the update of $u$ over one explicit time step $\\Delta t$ using only the diffusive contribution from molecular viscosity and subgrid-scale eddy viscosity. Use a conservative discretization on a uniform periodic grid: compute the diffusive flux at cell faces as $f = (\\nu + \\nu_t) \\, \\partial_y u$ and then take its divergence at cell centers to obtain $\\partial_t u$.\n\nImplement a numerical solver that:\n- Builds the initial resolved velocity profile $u(y,0)$.\n- Computes the subgrid-scale eddy viscosity $\\nu_t$ at cell faces from the resolved shear magnitude at faces.\n- Forms the face diffusive flux $f$ and its discrete divergence to compute the tendency $\\partial_t u$ at cell centers.\n- Advances $u$ by one forward-Euler time step using only the diffusive term.\n- Reports the resolved velocity profile adjustment $\\Delta u(y) = u(y,\\Delta t) - u(y,0)$ and the updated center-point velocity $u(y=L_y/2,\\Delta t)$.\n\nAll computations and outputs must be expressed in meters per second ($\\mathrm{m/s}$). Angles, if present, must be in radians. Your program must produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a two-element list $[\\max|\\Delta u|, u_{\\mathrm{center}}]$ with both entries in $\\mathrm{m/s}$. The center point is the grid point at index $\\lfloor N/2 \\rfloor$.\n\nUse the following test suite of parameter sets, each specified as $(U_0, L_y, N, C_s, \\Delta t, \\nu, n)$, where $U_0$ is the amplitude of the initial profile, $L_y$ is the domain length, $N$ is the number of grid points, $C_s$ is the Smagorinsky constant, $\\Delta t$ is the time step, $\\nu$ is the molecular viscosity, and $n$ is the integer wavenumber in the periodic initial profile $u(y,0) = U_0 \\sin(2\\pi n y / L_y)$; for the uniform-flow edge case, use a constant initial profile $u(y,0) = U_0$:\n1. Case A (happy path, periodic shear): $(U_0 = 1.0\\,\\mathrm{m/s}, L_y = 2000\\,\\mathrm{m}, N = 129, C_s = 0.12, \\Delta t = 50\\,\\mathrm{s}, \\nu = 1\\times 10^{-5}\\,\\mathrm{m^2/s}, n = 1)$.\n2. Case B (edge case, uniform flow): $(U_0 = 0.8\\,\\mathrm{m/s}, L_y = 1000\\,\\mathrm{m}, N = 128, C_s = 0.17, \\Delta t = 100\\,\\mathrm{s}, \\nu = 1\\times 10^{-5}\\,\\mathrm{m^2/s}, \\text{uniform profile})$.\n3. Case C (stronger shear, higher wavenumber): $(U_0 = 0.5\\,\\mathrm{m/s}, L_y = 1000\\,\\mathrm{m}, N = 257, C_s = 0.20, \\Delta t = 10\\,\\mathrm{s}, \\nu = 1\\times 10^{-5}\\,\\mathrm{m^2/s}, n = 2)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each test case yielding $[\\max|\\Delta u|, u_{\\mathrm{center}}]$ in $\\mathrm{m/s}$, for example, $[[a_1,b_1],[a_2,b_2],[a_3,b_3]]$.",
            "solution": "The problem is assessed to be valid. It is scientifically grounded in the principles of computational fluid dynamics, specifically Large Eddy Simulation (LES). The problem is well-posed, with a clear initial condition, periodic boundary conditions, and a defined (albeit simplified) governing equation. All terms, parameters, and required outputs are defined objectively and unambiguously. The requested task is a standard numerical exercise in discretizing and solving a partial differential equation.\n\nThe solution proceeds in two main parts: first, a theoretical derivation of the simplified governing equation for the specified flow conditions, and second, a detailed description of the numerical algorithm used to solve it.\n\n### Theoretical Formulation\n\nThe problem starts with the filtered incompressible momentum equation and asks to formulate an update for a one-dimensional shear flow $\\mathbf{u}(y,t) = (u(y,t), 0, 0)$ considering only diffusive terms. The governing equation for this simplified system is:\n$$\n\\frac{\\partial u}{\\partial t} = \\frac{\\partial}{\\partial y} \\left( (\\nu + \\nu_t) \\frac{\\partial u}{\\partial y} \\right)\n$$\nwhere $\\nu$ is the molecular viscosity and $\\nu_t$ is the subgrid-scale (SGS) eddy viscosity. The eddy viscosity is defined by the Smagorinsky model as $\\nu_t = (C_s \\Delta)^2 \\lVert S \\rVert$, where $C_s$ is the Smagorinsky constant, $\\Delta$ is the filter width (equal to the grid spacing $\\Delta y$), and $\\lVert S \\rVert$ is the magnitude of the resolved rate-of-strain tensor $S_{ij}$.\n\nOur first step is to derive the specific expression for $\\lVert S \\rVert$ for the given velocity field $\\mathbf{u} = (u_1, u_2, u_3) = (u(y,t), 0, 0)$ in Cartesian coordinates $(x_1, x_2, x_3) = (x, y, z)$.\n\nThe components of the rate-of-strain tensor $S_{ij} = \\frac{1}{2} \\left( \\frac{\\partial u_i}{\\partial x_j} + \\frac{\\partial u_j}{\\partial x_i} \\right)$ are calculated as follows:\n- The diagonal components are all zero:\n  $S_{11} = \\frac{\\partial u}{\\partial x} = 0$, since $u$ does not depend on $x$.\n  $S_{22} = \\frac{\\partial 0}{\\partial y} = 0$.\n  $S_{33} = \\frac{\\partial 0}{\\partial z} = 0$.\n- The off-diagonal components involving derivatives with respect to $x$ or $z$ are zero. The only non-zero components are:\n  $S_{12} = S_{21} = \\frac{1}{2} \\left( \\frac{\\partial u_1}{\\partial x_2} + \\frac{\\partial u_2}{\\partial x_1} \\right) = \\frac{1}{2} \\left( \\frac{\\partial u}{\\partial y} + \\frac{\\partial 0}{\\partial x} \\right) = \\frac{1}{2} \\frac{\\partial u}{\\partial y}$.\n  $S_{13} = S_{31} = 0$ and $S_{23} = S_{32} = 0$.\n\nThe rate-of-strain tensor is thus:\n$$\nS = \\begin{pmatrix} 0 & \\frac{1}{2} \\frac{\\partial u}{\\partial y} & 0 \\\\ \\frac{1}{2} \\frac{\\partial u}{\\partial y} & 0 & 0 \\\\ 0 & 0 & 0 \\end{pmatrix}\n$$\nThe magnitude $\\lVert S \\rVert$ is defined as $\\lVert S \\rVert = \\sqrt{2 S_{ij} S_{ij}}$, where $S_{ij} S_{ij}$ is the sum of the squares of the tensor components (the squared Frobenius norm):\n$$\nS_{ij} S_{ij} = \\sum_{i,j=1}^3 S_{ij}^2 = S_{12}^2 + S_{21}^2 = \\left(\\frac{1}{2} \\frac{\\partial u}{\\partial y}\\right)^2 + \\left(\\frac{1}{2} \\frac{\\partial u}{\\partial y}\\right)^2 = 2 \\cdot \\frac{1}{4} \\left(\\frac{\\partial u}{\\partial y}\\right)^2 = \\frac{1}{2} \\left(\\frac{\\partial u}{\\partial y}\\right)^2\n$$\nSubstituting this into the definition of the magnitude:\n$$\n\\lVert S \\rVert = \\sqrt{2 \\cdot \\left(\\frac{1}{2} \\left(\\frac{\\partial u}{\\partial y}\\right)^2\\right)} = \\sqrt{\\left(\\frac{\\partial u}{\\partial y}\\right)^2} = \\left| \\frac{\\partial u}{\\partial y} \\right|\n$$\nThus, for this one-dimensional shear flow, the strain-rate magnitude is simply the absolute value of the velocity gradient. The eddy viscosity then becomes:\n$$\n\\nu_t = (C_s \\Delta y)^2 \\left| \\frac{\\partial u}{\\partial y} \\right|\n$$\n\n### Numerical Discretization\n\nWe employ a conservative finite volume method on a uniform, periodic grid. The domain $y \\in [0, L_y)$ is discretized into $N$ cells.\n\n1.  **Grid and Initial Profile:**\n    - The grid spacing is $\\Delta y = L_y / N$.\n    - Cell centers are located at $y_j = j \\Delta y$ for $j = 0, 1, \\ldots, N-1$. The velocity $u_j(t)$ is defined at these points.\n    - Cell faces are located at $y_{j+1/2} = (j+1/2)\\Delta y$.\n    - The initial velocity profile $u_j^0 = u(y_j, 0)$ is set according to the test case:\n      - For periodic shear: $u_j^0 = U_0 \\sin(2\\pi n y_j / L_y) = U_0 \\sin(2\\pi n j / N)$.\n      - For uniform flow: $u_j^0 = U_0$.\n\n2.  **Shear and Eddy Viscosity at Faces:**\n    The problem specifies that the eddy viscosity $\\nu_t$ is computed at cell faces based on the shear at faces. We approximate the shear at the face $j+1/2$ (between cells $j$ and $j+1$) using a second-order central difference:\n    $$\n    \\left( \\frac{\\partial u}{\\partial y} \\right)_{j+1/2} \\approx \\frac{u_{j+1} - u_j}{\\Delta y}\n    $$\n    Due to periodicity, $u_N = u_0$. This discrete shear is computed for all $N$ faces. The eddy viscosity at each face is then:\n    $$\n    \\nu_{t, j+1/2} = (C_s \\Delta y)^2 \\left| \\frac{u_{j+1} - u_j}{\\Delta y} \\right|\n    $$\n\n3.  **Diffusive Flux at Faces:**\n    The diffusive flux is $f = (\\nu + \\nu_t) \\frac{\\partial u}{\\partial y}$. At face $j+1/2$, the discrete flux $f_{j+1/2}$ is computed using the quantities already evaluated at the face:\n    $$\n    f_{j+1/2} = (\\nu + \\nu_{t, j+1/2}) \\left( \\frac{u_{j+1} - u_j}{\\Delta y} \\right)\n    $$\n\n4.  **Flux Divergence at Centers:**\n    The time tendency of the velocity at cell center $j$ is given by the divergence of the flux, $\\partial_t u = \\partial f / \\partial y$. This is discretized as a central difference of the face fluxes:\n    $$\n    \\left( \\frac{\\partial u}{\\partial t} \\right)_j = \\left( \\frac{\\partial f}{\\partial y} \\right)_j \\approx \\frac{f_{j+1/2} - f_{j-1/2}}{\\Delta y}\n    $$\n    For periodicity, the face \"left\" of cell $0$ (at $y_{-1/2}$) is the same as the face \"right\" of cell $N-1$ (at $y_{N-1/2}$). This is applied to all $N$ cell centers to find the array of time derivatives, $(\\partial u/\\partial t)_j$.\n\n5.  **Time Integration:**\n    A single forward-Euler step is used to update the velocity profile from time $t=0$ to $t=\\Delta t$. For each cell $j$:\n    $$\n    u_j(\\Delta t) = u_j(0) + \\Delta t \\left( \\frac{\\partial u}{\\partial t} \\right)_j\n    $$\n\n6.  **Output Calculation:**\n    - The velocity profile adjustment is $\\Delta u_j = u_j(\\Delta t) - u_j(0) = \\Delta t (\\partial u/\\partial t)_j$. The required output is $\\max_j |\\Delta u_j|$.\n    - The updated center-point velocity is $u_{\\mathrm{center}} = u_k(\\Delta t)$, where $k = \\lfloor N/2 \\rfloor$ is the index of the grid point at the center of the domain.\n\nThis numerical procedure is applied to each test case to generate the required results. For the uniform flow case, the initial shear is zero everywhere, leading to zero eddy viscosity and zero flux, resulting in no change in the velocity profile, as expected physically.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print the results.\n    \"\"\"\n    test_cases = [\n        # Case A: (U0, Ly, N, Cs, dt, nu, n)\n        (1.0, 2000.0, 129, 0.12, 50.0, 1e-5, 1),\n        # Case B: uniform flow, n is None\n        (0.8, 1000.0, 128, 0.17, 100.0, 1e-5, None),\n        # Case C\n        (0.5, 1000.0, 257, 0.20, 10.0, 1e-5, 2),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_simulation_step(*case)\n        results.append(result)\n\n    # Format the final output string to be exactly [[r1_1,r1_2],[r2_1,r2_2],...]\n    # without any spaces as per the example in the problem description.\n    output_str = str(results).replace(' ', '')\n    print(output_str)\n\ndef run_simulation_step(U0, Ly, N, Cs, dt, nu, n_wave):\n    \"\"\"\n    Performs a single time step of the diffusive LES model for a 1D shear flow.\n\n    Args:\n        U0 (float): Amplitude of the initial velocity profile [m/s].\n        Ly (float): Domain length [m].\n        N (int): Number of grid points.\n        Cs (float): Smagorinsky constant.\n        dt (float): Time step [s].\n        nu (float): Molecular viscosity [m^2/s].\n        n_wave (int or None): Wavenumber for the sinusoidal profile. If None, a uniform profile is used.\n\n    Returns:\n        list: A list containing [max|Δu|, u_center] in m/s.\n    \"\"\"\n    \n    # 1. Grid and Initial Profile\n    # The filter width Delta is equal to the grid spacing dy.\n    dy = Ly / N\n    # Grid points are at cell centers y_j = j * dy.\n    y = np.arange(N) * dy\n    \n    if n_wave is not None:\n        # Periodic shear profile: u(y,0) = U0 * sin(2*pi*n*y / Ly)\n        # which simplifies to u_j = U0 * sin(2*pi*n*j / N)\n        u0 = U0 * np.sin(2 * np.pi * n_wave * y / Ly)\n    else:\n        # Uniform flow profile\n        u0 = U0 * np.ones(N)\n\n    # 2. Compute shear and eddy viscosity at cell faces\n    # The shear at face j+1/2 is (u_{j+1} - u_j) / dy.\n    # np.roll(u0, -1) provides u_{j+1} with periodic boundary conditions.\n    shear_at_faces = (np.roll(u0, -1) - u0) / dy\n    \n    # Eddy viscosity nu_t = (Cs * Delta)^2 * |S|, where |S| = |du/dy|\n    nu_t_faces = (Cs * dy)**2 * np.abs(shear_at_faces)\n    \n    # 3. Compute diffusive flux at faces\n    # The flux is f = (nu + nu_t) * (du/dy). All terms are evaluated at faces.\n    flux_faces = (nu + nu_t_faces) * shear_at_faces\n    \n    # 4. Compute flux divergence at cell centers\n    # The divergence at cell j is (f_{j+1/2} - f_{j-1/2}) / dy.\n    # np.roll(flux_faces, 1) provides f_{j-1/2}.\n    flux_divergence = (flux_faces - np.roll(flux_faces, 1)) / dy\n    dudt = flux_divergence\n    \n    # 5. Advance in time with a single forward-Euler step\n    # u_new = u_old + dt * (du/dt)\n    u1 = u0 + dt * dudt\n    \n    # 6. Calculate and report outputs\n    # Velocity adjustment is Δu = u1 - u0 = dt * dudt\n    delta_u = dt * dudt\n    max_abs_delta_u = np.max(np.abs(delta_u))\n    \n    # Center-point is at index floor(N/2)\n    center_index = N // 2\n    u_center = u1[center_index]\n    \n    return [max_abs_delta_u, u_center]\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "While the static Smagorinsky model is a powerful tool, its primary limitation is the need to specify a universal constant, $C_s$. The development of dynamic models, which compute this coefficient automatically from the resolved flow field, was a major breakthrough. This practice delves into the theoretical heart of the dynamic procedure: the Germano identity . By explicitly calculating the Leonard ($L_{ij}$), cross ($C_{ij}$), and Reynolds ($R_{ij}$) terms for a given flow, you will deconstruct the sub-test-scale stress and gain a fundamental understanding of the scale interactions that dynamic models leverage to estimate SGS effects without a priori assumptions.",
            "id": "3798422",
            "problem": "Consider a one-dimensional transect across an ocean mixed layer where the horizontally homogeneous, incompressible velocity field has two nonzero Cartesian components, $u_{1}(x)$ and $u_{2}(x)$, interpreted as the zonal and meridional velocities, respectively. In a Large Eddy Simulation (LES), define a spatial filtering operator at the grid scale $\\Delta$ as $\\overline{f}(x) = \\int G_{\\Delta}(\\xi) f(x-\\xi) \\, d\\xi$ and a second, coarser test filter at $\\tilde{\\Delta} = \\alpha \\Delta$ as $\\widehat{f}(x) = \\int G_{\\tilde{\\Delta}}(\\xi) f(x-\\xi) \\, d\\xi$, where $G_{\\Delta}$ and $G_{\\tilde{\\Delta}}$ are normalized, even kernels. The subgrid-scale (SGS) stress at the grid scale is defined by $\\tau_{ij}(x) = \\overline{u_{i} u_{j}}(x) - \\overline{u}_{i}(x)\\,\\overline{u}_{j}(x)$, and the SGS stress at the test scale is $T_{ij}(x) = \\widehat{u_{i} u_{j}}(x) - \\widehat{u}_{i}(x)\\,\\widehat{u}_{j}(x)$. Start from these definitions and, by writing $u_{i} = \\overline{u}_{i} + u_{i}'$ with $u_{i}'$ the grid-scale subfilter fluctuation, derive the Germano decomposition of $T_{ij}$ into Leonard, cross, and Reynolds terms at the test scale.\n\nThen, compute these three terms for the off-diagonal component $i=1$, $j=2$ at a specific location $x_{0}$, using the following discrete, periodic, three-point representation. You are given the raw velocities at three equally spaced points with periodic boundary conditions:\n$$\nu_{1} = \\begin{pmatrix} 0.40 & 0.55 & 0.70 \\end{pmatrix} \\, , \\quad\nu_{2} = \\begin{pmatrix} 0.10 & -0.05 & 0.25 \\end{pmatrix} \\, ,\n$$\nwhere the entries correspond to $x_{1}$, $x_{2}=x_{0}$, $x_{3}$. The grid filter at scale $\\Delta$ is a discrete convolution centered at each point with weights $\\left( \\frac{1}{4}, \\frac{1}{2}, \\frac{1}{4} \\right)$ applied to the nearest neighbors and the point itself (using periodic extension), i.e.,\n$$\n\\overline{f}(x_{k}) = \\frac{1}{4} f(x_{k-1}) + \\frac{1}{2} f(x_{k}) + \\frac{1}{4} f(x_{k+1}) \\, ,\n$$\nwith indices taken modulo $3$. The test filter at scale $\\tilde{\\Delta}$ is the equal-weight average over the three points,\n$$\n\\widehat{f}(x_{2}) = \\frac{1}{3}\\left[ f(x_{1}) + f(x_{2}) + f(x_{3}) \\right] \\, .\n$$\nProceed as follows:\n1. Using the above definitions, derive the decomposition of $T_{12}$ at $x_{2}$ into a sum of three contributions that are customarily called the Leonard, cross, and Reynolds terms.\n2. Compute the filtered fields $\\overline{u}_{i}(x_{k})$, the fluctuations $u_{i}'(x_{k})$, and all test-filtered quantities needed to evaluate each term at $x_{2}$.\n3. Report the three values for the off-diagonal component at $x_{2}$ as a single row vector $\\left( L_{12}, C_{12}, R_{12} \\right)$.\n\nExpress the final components in $\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$. Provide exact values; do not round. The final answer must be a single row matrix containing the three components in the order Leonard, cross, Reynolds.",
            "solution": "The user has provided a problem statement that requires validation before a solution can be attempted.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\n-   **Velocity Field**: One-dimensional transect with two velocity components, $u_{1}(x)$ and $u_{2}(x)$.\n-   **Grid Filter**: $\\overline{f}(x) = \\int G_{\\Delta}(\\xi) f(x-\\xi) \\, d\\xi$ at scale $\\Delta$.\n-   **Test Filter**: $\\widehat{f}(x) = \\int G_{\\tilde{\\Delta}}(\\xi) f(x-\\xi) \\, d\\xi$ at scale $\\tilde{\\Delta} = \\alpha \\Delta$.\n-   **Grid-Scale SGS Stress**: $\\tau_{ij}(x) = \\overline{u_{i} u_{j}}(x) - \\overline{u}_{i}(x)\\,\\overline{u}_{j}(x)$.\n-   **Test-Scale SGS Stress**: $T_{ij}(x) = \\widehat{u_{i} u_{j}}(x) - \\widehat{u}_{i}(x)\\,\\widehat{u}_{j}(x)$.\n-   **Velocity Decomposition**: $u_{i} = \\overline{u}_{i} + u_{i}'$, where $u_{i}'$ is the subfilter fluctuation.\n-   **Raw Velocity Data**:\n    -   $u_{1} = \\begin{pmatrix} 0.40 & 0.55 & 0.70 \\end{pmatrix}$ at points $(x_{1}, x_{2}, x_{3})$.\n    -   $u_{2} = \\begin{pmatrix} 0.10 & -0.05 & 0.25 \\end{pmatrix}$ at points $(x_{1}, x_{2}, x_{3})$.\n-   **Evaluation Point**: $x_{0} = x_{2}$.\n-   **Discrete Grid Filter**: $\\overline{f}(x_{k}) = \\frac{1}{4} f(x_{k-1}) + \\frac{1}{2} f(x_{k}) + \\frac{1}{4} f(x_{k+1})$ with indices modulo $3$.\n-   **Discrete Test Filter**: $\\widehat{f}(x_{2}) = \\frac{1}{3}\\left[ f(x_{1}) + f(x_{2}) + f(x_{3}) \\right]$.\n-   **Tasks**:\n    1.  Derive the decomposition of $T_{12}$ at $x_2$ into Leonard, cross, and Reynolds terms.\n    2.  Compute all necessary filtered fields and fluctuations.\n    3.  Report the values of $(L_{12}, C_{12}, R_{12})$ at $x_{2}$.\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded**: The problem is based on the Germano identity, a fundamental concept in Large Eddy Simulation (LES) for turbulence modeling. The definitions of filters and subgrid-scale stresses are standard in the field of computational fluid dynamics and oceanography. The problem is scientifically sound.\n-   **Well-Posed**: All required data, definitions, and boundary conditions (periodic) are explicitly provided. The operations (filtering, decomposition) are well-defined for the given discrete dataset, leading to a unique solution.\n-   **Objective**: The problem is stated in precise, unbiased technical language.\n-   **Flaw Analysis**:\n    1.  **Scientific/Factual Unsoundness**: None.\n    2.  **Non-Formalizable/Irrelevant**: The problem is formalizable and directly relevant to LES of ocean turbulence.\n    3.  **Incomplete/Contradictory Setup**: None. The setup is self-contained and consistent.\n    4.  **Unrealistic/Infeasible**: The velocity values are physically plausible. The discrete model is a simplified but valid computational exercise.\n    5.  **Ill-Posed/Poorly Structured**: None. A unique, stable, and meaningful solution exists.\n    6.  **Pseudo-Profound/Trivial**: The problem requires a multi-step derivation and calculation, testing fundamental understanding. It is not trivial.\n    7.  **Outside Scientific Verifiability**: The calculations are mathematically verifiable.\n\n**Step 3: Verdict and Action**\n\n-   **Verdict**: The problem is **valid**.\n-   **Action**: Proceed with the solution.\n\n### Solution\n\nThe solution proceeds in three parts as requested: derivation of the Germano decomposition, computation of intermediate quantities, and calculation of the final components. We assume the given velocity components $u_1$ and $u_2$ are in units of $\\mathrm{m}\\,\\mathrm{s}^{-1}$, so the resulting stress components are in $\\mathrm{m}^{2}\\,\\mathrm{s}^{-2}$.\n\n**1. Germano Decomposition**\n\nThe test-scale subgrid-scale (SGS) stress is defined as $T_{ij} = \\widehat{u_{i} u_{j}} - \\widehat{u}_{i}\\widehat{u}_{j}$. We decompose the velocity field $u_i$ into its grid-filtered (resolved) part $\\overline{u}_i$ and its subfilter (unresolved) part $u_i'$, such that $u_i = \\overline{u}_i + u_i'$.\n\nSubstitute this decomposition into the definition of $T_{ij}$:\n$$\nT_{ij} = \\widehat{(\\overline{u}_i + u'_i)(\\overline{u}_j + u'_j)} - \\widehat{(\\overline{u}_i + u'_i)} \\widehat{(\\overline{u}_j + u'_j)}\n$$\nExpanding both terms and using the linearity of the filtering operators:\n$$\nT_{ij} = \\left(\\widehat{\\overline{u}_i \\overline{u}_j} + \\widehat{\\overline{u}_i u'_j} + \\widehat{u'_i \\overline{u}_j} + \\widehat{u'_i u'_j}\\right) - \\left((\\widehat{\\overline{u}}_i + \\widehat{u'_i})(\\widehat{\\overline{u}}_j + \\widehat{u'_j})\\right)\n$$\n$$\nT_{ij} = \\left(\\widehat{\\overline{u}_i \\overline{u}_j} + \\widehat{\\overline{u}_i u'_j} + \\widehat{u'_i \\overline{u}_j} + \\widehat{u'_i u'_j}\\right) - \\left(\\widehat{\\overline{u}}_i \\widehat{\\overline{u}}_j + \\widehat{\\overline{u}}_i \\widehat{u'_j} + \\widehat{u'_i} \\widehat{\\overline{u}}_j + \\widehat{u'_i} \\widehat{u'_j}\\right)\n$$\nWe group the terms based on the scales they represent:\n-   The **Leonard term**, $L_{ij}$, represents the stress arising from the resolved scales as seen by the test filter. It contains only resolved-scale quantities ($\\overline{u}$).\n    $$\n    L_{ij} = \\widehat{\\overline{u}_i \\overline{u}_j} - \\widehat{\\overline{u}}_i \\widehat{\\overline{u}}_j\n    $$\n-   The **cross term**, $C_{ij}$, represents the interaction between resolved and unresolved scales.\n    $$\n    C_{ij} = \\left(\\widehat{\\overline{u}_i u'_j} + \\widehat{u'_i \\overline{u}_j}\\right) - \\left(\\widehat{\\overline{u}}_i \\widehat{u'_j} + \\widehat{u'_i} \\widehat{\\overline{u}}_j\\right)\n    $$\n-   The **Reynolds term**, $R_{ij}$, represents the stress arising from the unresolved scales. It is analogous to an SGS stress but for the subfilter velocity fluctuations.\n    $$\n    R_{ij} = \\widehat{u'_i u'_j} - \\widehat{u'_i} \\widehat{u'_j}\n    $$\nThe complete decomposition is thus $T_{ij} = L_{ij} + C_{ij} + R_{ij}$.\n\n**2. Computation of Filtered Fields and Fluctuations**\n\nGiven the raw velocity data:\n$u_{1} = \\begin{pmatrix} 0.40 & 0.55 & 0.70 \\end{pmatrix}$\n$u_{2} = \\begin{pmatrix} 0.10 & -0.05 & 0.25 \\end{pmatrix}$\n\nFirst, we apply the grid filter $\\overline{f}(x_{k}) = \\frac{1}{4} f(x_{k-1}) + \\frac{1}{2} f(x_{k}) + \\frac{1}{4} f(x_{k+1)}$ with periodic boundary conditions (indices modulo $3$).\n\nFor $\\overline{u}_1$:\n$\\overline{u}_{1}(x_{1}) = \\frac{1}{4}(0.70) + \\frac{1}{2}(0.40) + \\frac{1}{4}(0.55) = 0.175 + 0.200 + 0.1375 = 0.5125$\n$\\overline{u}_{1}(x_{2}) = \\frac{1}{4}(0.40) + \\frac{1}{2}(0.55) + \\frac{1}{4}(0.70) = 0.100 + 0.275 + 0.175 = 0.55$\n$\\overline{u}_{1}(x_{3}) = \\frac{1}{4}(0.55) + \\frac{1}{2}(0.70) + \\frac{1}{4}(0.40) = 0.1375 + 0.350 + 0.100 = 0.5875$\nSo, $\\overline{u}_{1} = \\begin{pmatrix} 0.5125 & 0.55 & 0.5875 \\end{pmatrix}$.\n\nFor $\\overline{u}_2$:\n$\\overline{u}_{2}(x_{1}) = \\frac{1}{4}(0.25) + \\frac{1}{2}(0.10) + \\frac{1}{4}(-0.05) = 0.0625 + 0.050 - 0.0125 = 0.10$\n$\\overline{u}_{2}(x_{2}) = \\frac{1}{4}(0.10) + \\frac{1}{2}(-0.05) + \\frac{1}{4}(0.25) = 0.025 - 0.025 + 0.0625 = 0.0625$\n$\\overline{u}_{2}(x_{3}) = \\frac{1}{4}(-0.05) + \\frac{1}{2}(0.25) + \\frac{1}{4}(0.10) = -0.0125 + 0.125 + 0.025 = 0.1375$\nSo, $\\overline{u}_{2} = \\begin{pmatrix} 0.10 & 0.0625 & 0.1375 \\end{pmatrix}$.\n\nNext, we compute the fluctuations $u'_{i} = u_{i} - \\overline{u}_{i}$.\nFor $u'_1$:\n$u'_{1}(x_{1}) = 0.40 - 0.5125 = -0.1125$\n$u'_{1}(x_{2}) = 0.55 - 0.55 = 0$\n$u'_{1}(x_{3}) = 0.70 - 0.5875 = 0.1125$\nSo, $u'_{1} = \\begin{pmatrix} -0.1125 & 0 & 0.1125 \\end{pmatrix}$.\n\nFor $u'_2$:\n$u'_{2}(x_{1}) = 0.10 - 0.10 = 0$\n$u'_{2}(x_{2}) = -0.05 - 0.0625 = -0.1125$\n$u'_{2}(x_{3}) = 0.25 - 0.1375 = 0.1125$\nSo, $u'_{2} = \\begin{pmatrix} 0 & -0.1125 & 0.1125 \\end{pmatrix}$.\n\nNow we compute the test-filtered quantities at $x_2$ using $\\widehat{f}(x_{2}) = \\frac{1}{3}\\sum_{k=1}^{3} f(x_{k})$.\n$\\widehat{\\overline{u}}_{1}(x_{2}) = \\frac{1}{3}(0.5125 + 0.55 + 0.5875) = \\frac{1}{3}(1.65) = 0.55$\n$\\widehat{\\overline{u}}_{2}(x_{2}) = \\frac{1}{3}(0.10 + 0.0625 + 0.1375) = \\frac{1}{3}(0.30) = 0.10$\n$\\widehat{u'}_{1}(x_{2}) = \\frac{1}{3}(-0.1125 + 0 + 0.1125) = 0$\n$\\widehat{u'}_{2}(x_{2}) = \\frac{1}{3}(0 - 0.1125 + 0.1125) = 0$\n\nNext, we compute the test filter of the product fields.\nFor $L_{12}$, we need $\\widehat{\\overline{u}_{1} \\overline{u}_{2}}(x_2)$:\nThe product field $\\overline{u}_{1} \\overline{u}_{2}$ is:\n$(\\overline{u}_{1} \\overline{u}_{2})(x_{1}) = (0.5125)(0.10) = 0.05125$\n$(\\overline{u}_{1} \\overline{u}_{2})(x_{2}) = (0.55)(0.0625) = 0.034375$\n$(\\overline{u}_{1} \\overline{u}_{2})(x_{3}) = (0.5875)(0.1375) = 0.08078125$\n$\\widehat{\\overline{u}_{1} \\overline{u}_{2}}(x_{2}) = \\frac{1}{3}(0.05125 + 0.034375 + 0.08078125) = \\frac{1}{3}(0.16640625) = 0.05546875$.\n\nFor $C_{12}$, we need $\\widehat{\\overline{u}_{1} u'_{2} + u'_{1} \\overline{u}_{2}}(x_2)$:\nThe product field $(\\overline{u}_{1} u'_{2} + u'_{1} \\overline{u}_{2})$ is:\nAt $x_1$: $(0.5125)(0) + (-0.1125)(0.10) = -0.01125$\nAt $x_2$: $(0.55)(-0.1125) + (0)(0.0625) = -0.061875$\nAt $x_3$: $(0.5875)(0.1125) + (0.1125)(0.1375) = 0.06609375 + 0.01546875 = 0.0815625$\n$\\widehat{\\overline{u}_{1} u'_{2} + u'_{1} \\overline{u}_{2}}(x_{2}) = \\frac{1}{3}(-0.01125 - 0.061875 + 0.0815625) = \\frac{1}{3}(0.0084375) = 0.0028125$.\n\nFor $R_{12}$, we need $\\widehat{u'_{1} u'_{2}}(x_2)$:\nThe product field $u'_{1} u'_{2}$ is:\n$(u'_{1} u'_{2})(x_{1}) = (-0.1125)(0) = 0$\n$(u'_{1} u'_{2})(x_{2}) = (0)(-0.1125) = 0$\n$(u'_{1} u'_{2})(x_{3}) = (0.1125)(0.1125) = 0.01265625$\n$\\widehat{u'_{1} u'_{2}}(x_{2}) = \\frac{1}{3}(0 + 0 + 0.01265625) = 0.00421875$.\n\n**3. Calculation of $L_{12}$, $C_{12}$, and $R_{12}$ at $x_2$**\n\nNow we substitute the computed quantities into the definitions of the three terms at $x_{2}$.\n\n**Leonard Term ($L_{12}$):**\n$$L_{12}(x_{2}) = \\widehat{\\overline{u}_{1} \\overline{u}_{2}}(x_{2}) - \\widehat{\\overline{u}}_{1}(x_{2}) \\widehat{\\overline{u}}_{2}(x_{2})$$\n$$L_{12}(x_{2}) = 0.05546875 - (0.55)(0.10) = 0.05546875 - 0.055 = 0.00046875$$\n\n**Cross Term ($C_{12}$):**\n$$C_{12}(x_{2}) = \\left(\\widehat{\\overline{u}_{1} u'_{2} + u'_{1} \\overline{u}_{2}}\\right)(x_{2}) - \\left(\\widehat{\\overline{u}}_{1}(x_{2}) \\widehat{u'}_{2}(x_{2}) + \\widehat{u'}_{1}(x_{2}) \\widehat{\\overline{u}}_{2}(x_{2})\\right)$$\nSince $\\widehat{u'}_{1}(x_{2})=0$ and $\\widehat{u'}_{2}(x_{2})=0$, the second part vanishes.\n$$C_{12}(x_{2}) = 0.0028125 - \\left((0.55)(0) + (0)(0.10)\\right) = 0.0028125$$\n\n**Reynolds Term ($R_{12}$):**\n$$R_{12}(x_{2}) = \\widehat{u'_{1} u'_{2}}(x_{2}) - \\widehat{u'}_{1}(x_{2}) \\widehat{u'}_{2}(x_{2})$$\nSince $\\widehat{u'}_{1}(x_{2})=0$ and $\\widehat{u'}_{2}(x_{2})=0$, the second part vanishes.\n$$R_{12}(x_{2}) = 0.00421875 - (0)(0) = 0.00421875$$\n\nThe three components for the off-diagonal SGS stress term $T_{12}$ at location $x_2$ are $(L_{12}, C_{12}, R_{12})$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n0.00046875 & 0.0028125 & 0.00421875\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Building upon the foundational concepts of SGS modeling and the Germano identity, this final practice challenges you to implement a complete dynamic procedure. You will move from static assumptions to a model that intelligently adapts to the local state of the resolved turbulence, calculating both the eddy viscosity for momentum and the eddy diffusivity for a scalar . This comprehensive exercise involves multiple filtering operations and a least-squares minimization to determine the model coefficients, culminating in the estimation of the turbulent Prandtl number, $Pr_t$, a key parameter in simulating oceanic transport processes.",
            "id": "3798418",
            "problem": "You are tasked with implementing a dynamic Large Eddy Simulation procedure in two-dimensional computational oceanography to estimate the turbulent Prandtl number and compute the turbulent scalar diffusivity using test-filtered fields. The objective is to derive, implement, and evaluate a self-consistent algorithm that starts from fundamental filtered equations and the Germano identity, without shortcut formulas provided, and produces quantifiable results for specified test cases. You must express the turbulent scalar diffusivity in $\\mathrm{m^2/s}$ and return the requested outputs as floats.\n\nAssumptions and fundamental base:\n- Consider an incompressible, two-dimensional flow for the resolved (filtered) velocity field $\\tilde{\\boldsymbol{u}} = (\\tilde{u}, \\tilde{v})$ and a resolved scalar (for example, temperature) $\\tilde{\\theta}$ defined on a uniform periodic grid with spacings $\\Delta x$ and $\\Delta y$ in meters.\n- The resolved rate-of-strain tensor is $S_{ij} = \\tfrac{1}{2} \\left( \\partial_j \\tilde{u}_i + \\partial_i \\tilde{u}_j \\right)$, and its magnitude is $|S| = \\sqrt{2 S_{ij} S_{ij}}$ with the usual Einstein summation convention.\n- The subgrid-scale stress and flux are modeled via eddy viscosity and diffusivity closures:\n  - The subgrid-scale stress deviator is modeled by $\\tau_{ij}^{\\mathrm{model}} = -2 \\nu_t S_{ij}$, where $\\nu_t$ is the eddy viscosity.\n  - The subgrid-scale scalar flux is modeled by $q_i^{\\mathrm{model}} = -K_t \\partial_i \\tilde{\\theta}$, where $K_t$ is the eddy scalar diffusivity.\n- The eddy coefficients are assumed of Smagorinsky type but with dynamically determined coefficients:\n  - $\\nu_t = C_\\nu \\, \\Delta^2 \\, |S|$ and $K_t = C_\\theta \\, \\Delta^2 \\, |S|$, where $\\Delta$ is the base filter width and $C_\\nu$ and $C_\\theta$ are dynamic coefficients to be determined from test-filtered fields using the Germano framework.\n- The test filter is defined with width $\\hat{\\Delta} = \\alpha \\Delta$, implemented as a discrete two-dimensional top-hat filter (uniform average over a square stencil), and periodic boundary conditions are used for differencing and filtering.\n\nDynamic estimation via Germano identities:\n- Define the Leonard stress at the test-filter level by $L_{ij} = \\widehat{\\tilde{u}_i \\tilde{u}_j} - \\hat{\\tilde{u}}_i \\hat{\\tilde{u}}_j$, where the hat denotes test filtering.\n- Define the scalar Leonard flux by $L_i^\\theta = \\widehat{\\tilde{u}_i \\tilde{\\theta}} - \\hat{\\tilde{u}}_i \\hat{\\tilde{\\theta}}$.\n- Construct test-filtered model discrepancy tensors and vectors from the closures and apply least-squares minimization consistent with the Germano identity to determine $C_\\nu$ and $C_\\theta$.\n- The turbulent Prandtl number is defined as $Pr_t = \\nu_t / K_t = C_\\nu / C_\\theta$.\n- Enforce realizability by requiring $\\nu_t \\ge 0$ and $K_t \\ge 0$; if the least-squares procedure yields negative $C_\\nu$ or $C_\\theta$, set those to $0$.\n\nImplementation requirements:\n- Compute spatial gradients using central differences with periodic boundaries.\n- Compute $S_{xx}$, $S_{yy}$, $S_{xy}$ and $|S|$ from the resolved velocities.\n- Implement the test filter as a discrete two-dimensional top-hat filter of size $n_{\\hat{\\Delta}} \\times n_{\\hat{\\Delta}}$ grid points. The base filter width is $\\Delta = n_\\Delta \\Delta x$ and the test filter width is $\\hat{\\Delta} = n_{\\hat{\\Delta}} \\Delta x$. Use the same window size in both $x$ and $y$ and $\\Delta x = \\Delta y$.\n- For the velocity-based dynamic coefficient, construct the appropriate tensors, and perform least-squares minimization to obtain $C_\\nu$ by contracting over tensor components and summing over the domain.\n- For the scalar-based dynamic coefficient, construct the appropriate vectors, and perform least-squares minimization to obtain $C_\\theta$ by contracting over vector components and summing over the domain.\n- Compute the turbulent scalar diffusivity field as $K_t(\\boldsymbol{x}) = C_\\theta \\Delta^2 |S(\\boldsymbol{x})|$ in $\\mathrm{m^2/s}$ and report its spatial average for each test case.\n\nTest suite:\nYou must evaluate your algorithm on the following three cases. In all cases, use periodic boundaries, and the top-hat filter window sizes $n_\\Delta$ and $n_{\\hat{\\Delta}}$ are specified.\n\n- Case A (happy path):\n  - Grid: $N_x = 5$, $N_y = 5$, $\\Delta x = \\Delta y = 1 \\, \\mathrm{m}$.\n  - Filters: $n_\\Delta = 3$, $n_{\\hat{\\Delta}} = 5$, so $\\Delta = 3 \\, \\mathrm{m}$ and $\\hat{\\Delta} = 5 \\, \\mathrm{m}$.\n  - Velocity: $\\tilde{u}(x,y) = A y$, $\\tilde{v}(x,y) = 0$, with $A = 0.4 \\, \\mathrm{s^{-1}}$ and $y$ in $\\mathrm{m}$.\n  - Scalar: $\\tilde{\\theta}(x,y) = B x$, with $B = 0.1$ per meter and $x$ in $\\mathrm{m}$.\n\n- Case B (curvilinear shear):\n  - Grid: $N_x = 6$, $N_y = 6$, $\\Delta x = \\Delta y = 1 \\, \\mathrm{m}$.\n  - Filters: $n_\\Delta = 3$, $n_{\\hat{\\Delta}} = 5$, so $\\Delta = 3 \\, \\mathrm{m}$ and $\\hat{\\Delta} = 5 \\, \\mathrm{m}$.\n  - Domain lengths: $L_x = N_x \\Delta x$, $L_y = N_y \\Delta y$.\n  - Velocity: $\\tilde{u}(x,y) = U_0 \\sin\\left(2 \\pi y / L_y\\right)$, $\\tilde{v}(x,y) = U_0 \\sin\\left(2 \\pi x / L_x\\right)$, with $U_0 = 0.5 \\, \\mathrm{m/s}$.\n  - Scalar: $\\tilde{\\theta}(x,y) = B y$, with $B = 0.2$ per meter and $y$ in $\\mathrm{m}$.\n\n- Case C (near-quiescent flow):\n  - Grid: $N_x = 6$, $N_y = 6$, $\\Delta x = \\Delta y = 1 \\, \\mathrm{m}$.\n  - Filters: $n_\\Delta = 3$, $n_{\\hat{\\Delta}} = 5$, so $\\Delta = 3 \\, \\mathrm{m}$ and $\\hat{\\Delta} = 5 \\, \\mathrm{m}$.\n  - Velocity: $\\tilde{u}(x,y) = A y$, $\\tilde{v}(x,y) = 0$, with $A = 10^{-6} \\, \\mathrm{s^{-1}}$ and $y$ in $\\mathrm{m}$.\n  - Scalar: $\\tilde{\\theta}(x,y) = B x$, with $B = 0.3$ per meter and $x$ in $\\mathrm{m}$.\n\nFinal output specification:\n- For each case, compute and aggregate two floats: the dynamically estimated domain-averaged turbulent Prandtl number $Pr_t$ (dimensionless) and the domain-averaged turbulent scalar diffusivity $\\overline{K_t}$ in $\\mathrm{m^2/s}$.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as $[Pr_{t,A}, \\overline{K}_{t,A}, Pr_{t,B}, \\overline{K}_{t,B}, Pr_{t,C}, \\overline{K}_{t,C}]$.",
            "solution": "The problem statement is assessed to be valid. It is scientifically grounded in the principles of computational fluid dynamics, specifically Large Eddy Simulation (LES). It is well-posed, providing all necessary equations, boundary conditions, and data for the test cases. The language is objective and precise. The task is to implement a standard, non-trivial algorithm (the dynamic Smagorinsky model) from first principles and apply it to well-defined verification cases.\n\n### Theoretical Derivation\n\nThe core of the problem lies in the dynamic estimation of the coefficients for the subgrid-scale (SGS) models using the Germano identity. We are given the filtered governing equations for a resolved velocity field $\\tilde{\\boldsymbol{u}}$ and a resolved scalar field $\\tilde{\\theta}$. The SGS stress tensor $\\tau_{ij} = \\widetilde{u_i u_j} - \\tilde{u}_i \\tilde{u}_j$ and SGS scalar flux vector $q_i = \\widetilde{u_i \\theta} - \\tilde{u}_i \\tilde{\\theta}$ are unclosed and require modeling.\n\nThe problem specifies eddy viscosity and eddy diffusivity models:\n1.  SGS stress deviator model: $\\tau_{ij}^{\\mathrm{model}} = -2 \\nu_t S_{ij}$\n2.  SGS scalar flux model: $q_i^{\\mathrm{model}} = -K_t \\partial_i \\tilde{\\theta}$\n\nThe eddy coefficients $\\nu_t$ and $K_t$ are of the Smagorinsky type:\n$\\nu_t = C_\\nu \\Delta^2 |S|$\n$K_t = C_\\theta \\Delta^2 |S|$\n\nwhere $\\Delta$ is the grid filter width, $|S| = \\sqrt{2 S_{ij} S_{ij}}$ is the magnitude of the resolved rate-of-strain tensor $S_{ij} = \\frac{1}{2}(\\partial_j \\tilde{u}_i + \\partial_i \\tilde{u}_j)$, and $C_\\nu$ and $C_\\theta$ are coefficients to be determined dynamically.\n\nThe dynamic procedure introduces a second, coarser filtering operation, the test filter, denoted by a hat ($\\hat{\\cdot}$), with a characteristic width $\\hat{\\Delta} > \\Delta$. Applying the test filter to the resolved velocity field $\\tilde{\\boldsymbol{u}}$ yields a test-filtered field $\\hat{\\tilde{\\boldsymbol{u}}}$.\n\n**1. Dynamic Estimation of the Viscosity Coefficient $C_\\nu$**\n\nThe Germano identity for the SGS stresses is an exact relationship derived from the filtering operations:\n$$L_{ij} = T_{ij} - \\widehat{\\tau_{ij}}$$\nwhere $L_{ij} = \\widehat{\\tilde{u}_i \\tilde{u}_j} - \\hat{\\tilde{u}}_i \\hat{\\tilde{u}}_j$ is the Leonard stress tensor, representing the stress arising from interactions between resolved scales, and $T_{ij} = \\widehat{u_i u_j} - \\hat{u}_i \\hat{u}_j$ is the SGS stress at the test-filter level.\n\nWe model the unknown SGS stresses $\\tau_{ij}$ and $T_{ij}$ using the Smagorinsky closure, assuming the coefficient $C_\\nu$ is scale-invariant between $\\Delta$ and $\\hat{\\Delta}$:\n$$ \\tau_{ij} \\approx -2 C_\\nu \\Delta^2 |S| S_{ij} $$\n$$ T_{ij} \\approx -2 C_\\nu \\hat{\\Delta}^2 |\\hat{S}| \\hat{S}_{ij} $$\nwhere $\\hat{S}_{ij}$ is the rate-of-strain tensor of the test-filtered velocity field $\\hat{\\tilde{\\boldsymbol{u}}}$.\n\nSubstituting these models into the Germano identity yields:\n$$ L_{ij} \\approx -2 C_\\nu \\hat{\\Delta}^2 |\\hat{S}| \\hat{S}_{ij} - \\widehat{(-2 C_\\nu \\Delta^2 |S| S_{ij})} $$\nAssuming $C_\\nu$ is slowly varying such that it can be moved outside the test filter, we get:\n$$ L_{ij} \\approx C_\\nu \\left( 2 \\Delta^2 \\widehat{|S| S_{ij}} - 2 \\hat{\\Delta}^2 |\\hat{S}| \\hat{S}_{ij} \\right) $$\nLet us define the model tensor $M_{ij}$ as:\n$$ M_{ij} = 2 \\Delta^2 \\widehat{|S| S_{ij}} - 2 \\hat{\\Delta}^2 |\\hat{S}| \\hat{S}_{ij} $$\nThe identity becomes a system of local equations $L_{ij} = C_\\nu M_{ij}$. To find a single global value for $C_\\nu$, we minimize the squared error $e = \\sum_{\\text{domain}} (L_{ij} - C_\\nu M_{ij})^2$ using a least-squares approach. The summation is over all grid points and tensor components. This minimization leads to:\n$$ C_\\nu = \\frac{\\langle L_{ij} M_{ij} \\rangle}{\\langle M_{kl} M_{kl} \\rangle} $$\nwhere $\\langle \\cdot \\rangle$ denotes the inner product summed over the spatial domain, e.g., $\\langle A_{ij} B_{ij} \\rangle = \\sum_{\\text{points}} \\sum_{i,j} A_{ij} B_{ij}$.\n\n**2. Dynamic Estimation of the Diffusivity Coefficient $C_\\theta$**\n\nA parallel derivation applies to the scalar flux. The Germano identity for the scalar flux is:\n$$ L_i^\\theta = H_i - \\widehat{q_i} $$\nwhere $L_i^\\theta = \\widehat{\\tilde{u}_i \\tilde{\\theta}} - \\hat{\\tilde{u}}_i \\hat{\\tilde{\\theta}}$ is the scalar equivalent of the Leonard stress, and $H_i = \\widehat{u_i \\theta} - \\hat{u}_i \\hat{\\theta}$ is the SGS scalar flux at the test-filter level.\n\nThe model closures are:\n$$ q_i \\approx -C_\\theta \\Delta^2 |S| \\partial_i \\tilde{\\theta} $$\n$$ H_i \\approx -C_\\theta \\hat{\\Delta}^2 |\\hat{S}| \\partial_i \\hat{\\tilde{\\theta}} $$\nSubstituting these models into the identity and assuming a scale-invariant $C_\\theta$:\n$$ L_i^\\theta \\approx -C_\\theta \\hat{\\Delta}^2 |\\hat{S}| \\partial_i \\hat{\\tilde{\\theta}} - \\widehat{(-C_\\theta \\Delta^2 |S| \\partial_i \\tilde{\\theta})} $$\n$$ L_i^\\theta \\approx C_\\theta \\left( \\Delta^2 \\widehat{|S| \\partial_i \\tilde{\\theta}} - \\hat{\\Delta}^2 |\\hat{S}| \\partial_i \\hat{\\tilde{\\theta}} \\right) $$\nLet us define the model vector $N_i$:\n$$ N_i = \\Delta^2 \\widehat{|S| \\partial_i \\tilde{\\theta}} - \\hat{\\Delta}^2 |\\hat{S}| \\partial_i \\hat{\\tilde{\\theta}} $$\nThe least-squares minimization of the error $e' = \\sum_{\\text{domain}} (L_i^\\theta - C_\\theta N_i)^2$ gives:\n$$ C_\\theta = \\frac{\\langle L_i^\\theta N_i \\rangle}{\\langle N_k N_k \\rangle} $$\n\n**3. Final Quantities and Realizability**\n\nThe raw coefficients $C_\\nu$ and $C_\\theta$ calculated from the least-squares procedure are clipped to enforce realizability (i.e., non-negative diffusivity):\n$C_\\nu^{\\text{final}} = \\max(0, C_\\nu)$\n$C_\\theta^{\\text{final}} = \\max(0, C_\\theta)$\n\nThe turbulent Prandtl number is the ratio of the eddy viscosity to the eddy diffusivity:\n$$ Pr_t = \\frac{\\nu_t}{K_t} = \\frac{C_\\nu^{\\text{final}} \\Delta^2 |S|}{C_\\theta^{\\text{final}} \\Delta^2 |S|} = \\frac{C_\\nu^{\\text{final}}}{C_\\theta^{\\text{final}}} $$\nThis is a single, global value derived from the spatially averaged coefficients.\n\nThe turbulent scalar diffusivity field is given by:\n$$ K_t(\\boldsymbol{x}) = C_\\theta^{\\text{final}} \\Delta^2 |S(\\boldsymbol{x})| $$\nThe problem requires its spatial average over the domain:\n$$ \\overline{K_t} = \\langle K_t(\\boldsymbol{x}) \\rangle = C_\\theta^{\\text{final}} \\Delta^2 \\langle |S(\\boldsymbol{x})| \\rangle $$\n\n### Computational Algorithm\n\nThe implementation follows these derived principles through the following steps:\n1.  **Grid and Field Generation**: For each test case, generate the computational grid and populate the fields $\\tilde{u}$, $\\tilde{v}$, and $\\tilde{\\theta}$ according to the provided functions.\n2.  **Gradient Calculation**: Compute spatial derivatives (e.g., $\\partial_x \\tilde{u}$) using a second-order central difference scheme with periodic boundary conditions.\n3.  **Strain-Rate Tensor**: From the velocity gradients, compute the components of the strain-rate tensor $S_{xx}$, $S_{yy}$, $S_{xy}$ and its magnitude $|S|$.\n4.  **Test Filtering**: Apply a 2D top-hat filter of size $n_{\\hat{\\Delta}} \\times n_{\\hat{\\Delta}}$ to all base fields ($\\tilde{u}$, $\\tilde{v}$, $\\tilde{\\theta}$) and product fields (e.g., $\\tilde{u}^2$, $\\tilde{u}\\tilde{\\theta}$, $|S|S_{ij}$) to obtain their test-filtered counterparts (e.g., $\\hat{\\tilde{u}}$, $\\widehat{\\tilde{u}^2}$).\n5.  **Test-Filtered Gradients**: Compute gradients of the test-filtered velocity field to find the test-filtered strain-rate tensor $\\hat{S}_{ij}$ and its magnitude $|\\hat{S}|$.\n6.  **Leonard and Model Terms**: Assemble the Leonard terms ($L_{ij}, L_i^\\theta$) and model terms ($M_{ij}, N_i$) at each grid point using their definitions.\n7.  **Coefficient Calculation**: Compute the numerators and denominators for $C_\\nu$ and $C_\\theta$ by summing the inner products over the entire domain. Calculate the coefficients.\n8.  **Post-Processing**: Apply the realizability constraint by clipping coefficients at zero. Compute the final quantities $Pr_t$ and $\\overline{K_t}$.\n\nThis step-by-step procedure is applied to each test case to generate the required outputs.",
            "answer": "```python\nimport numpy as np\nfrom scipy.ndimage import uniform_filter\n\ndef solve():\n    \"\"\"\n    Main solver function that processes all test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case A: Happy path\n        {\n            \"name\": \"A\",\n            \"Nx\": 5, \"Ny\": 5, \"dx\": 1.0, \"dy\": 1.0,\n            \"n_delta\": 3, \"n_hat_delta\": 5,\n            \"u_func\": lambda x, y, p: p[\"A\"] * y,\n            \"v_func\": lambda x, y, p: 0.0 * x,\n            \"theta_func\": lambda x, y, p: p[\"B\"] * x,\n            \"params\": {\"A\": 0.4, \"B\": 0.1}\n        },\n        # Case B: Curvilinear shear\n        {\n            \"name\": \"B\",\n            \"Nx\": 6, \"Ny\": 6, \"dx\": 1.0, \"dy\": 1.0,\n            \"n_delta\": 3, \"n_hat_delta\": 5,\n            \"u_func\": lambda x, y, p: p[\"U0\"] * np.sin(2 * np.pi * y / p[\"Ly\"]),\n            \"v_func\": lambda x, y, p: p[\"U0\"] * np.sin(2 * np.pi * x / p[\"Lx\"]),\n            \"theta_func\": lambda x, y, p: p[\"B\"] * y,\n            \"params\": {\"U0\": 0.5, \"B\": 0.2}\n        },\n        # Case C: Near-quiescent flow\n        {\n            \"name\": \"C\",\n            \"Nx\": 6, \"Ny\": 6, \"dx\": 1.0, \"dy\": 1.0,\n            \"n_delta\": 3, \"n_hat_delta\": 5,\n            \"u_func\": lambda x, y, p: p[\"A\"] * y,\n            \"v_func\": lambda x, y, p: 0.0 * x,\n            \"theta_func\": lambda x, y, p: p[\"B\"] * x,\n            \"params\": {\"A\": 1e-6, \"B\": 0.3}\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        pr_t, k_t_avg = compute_les_params(case)\n        results.extend([pr_t, k_t_avg])\n\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\n\ndef compute_les_params(case):\n    \"\"\"\n    Computes the turbulent Prandtl number and averaged scalar diffusivity for a given case.\n    \"\"\"\n    # Unpack case parameters\n    Nx, Ny, dx, dy = case[\"Nx\"], case[\"Ny\"], case[\"dx\"], case[\"dy\"]\n    n_delta, n_hat_delta = case[\"n_delta\"], case[\"n_hat_delta\"]\n\n    # Model filter widths\n    grid_delta = n_delta * dx\n    test_delta = n_hat_delta * dx\n\n    # Grid setup\n    x_coords = np.arange(Nx) * dx\n    y_coords = np.arange(Ny) * dy\n    xx, yy = np.meshgrid(x_coords, y_coords, indexing='ij')\n\n    # Add domain lengths to params if needed by functions\n    case[\"params\"][\"Lx\"] = Nx * dx\n    case[\"params\"][\"Ly\"] = Ny * dy\n\n    # Define fields\n    u_tilde = case[\"u_func\"](xx, yy, case[\"params\"])\n    v_tilde = case[\"v_func\"](xx, yy, case[\"params\"])\n    theta_tilde = case[\"theta_func\"](xx, yy, case[\"params\"])\n\n    # --- Helper functions ---\n    def grad_x(f):\n        return (np.roll(f, -1, axis=0) - np.roll(f, 1, axis=0)) / (2 * dx)\n\n    def grad_y(f):\n        return (np.roll(f, -1, axis=1) - np.roll(f, 1, axis=1)) / (2 * dy)\n    \n    def test_filter(f):\n        # uniform_filter implements a top-hat filter for a given window size\n        return uniform_filter(f, size=n_hat_delta, mode='wrap')\n\n    # --- Calculations at the grid-filter level (\\Delta) ---\n    dudx = grad_x(u_tilde)\n    dudy = grad_y(u_tilde)\n    dvdx = grad_x(v_tilde)\n    dvdy = grad_y(v_tilde)\n\n    Sxx = dudx\n    Syy = dvdy\n    Sxy = 0.5 * (dudy + dvdx)\n    \n    # |S| = sqrt(2 * S_ij * S_ij)\n    abs_S = np.sqrt(2 * (Sxx**2 + Syy**2 + 2 * Sxy**2))\n\n    dthdx = grad_x(theta_tilde)\n    dthdy = grad_y(theta_tilde)\n\n    # --- Apply test filter ---\n    u_hat = test_filter(u_tilde)\n    v_hat = test_filter(v_tilde)\n    theta_hat = test_filter(theta_tilde)\n\n    # --- Calculations at the test-filter level (\\hat{\\Delta}) ---\n    du_hat_dx = grad_x(u_hat)\n    du_hat_dy = grad_y(u_hat)\n    dv_hat_dx = grad_x(v_hat)\n    dv_hat_dy = grad_y(v_hat)\n\n    Sxx_hat = du_hat_dx\n    Syy_hat = dv_hat_dy\n    Sxy_hat = 0.5 * (du_hat_dy + dv_hat_dx)\n    \n    abs_S_hat = np.sqrt(2 * (Sxx_hat**2 + Syy_hat**2 + 2 * Sxy_hat**2))\n\n    dth_hat_dx = grad_x(theta_hat)\n    dth_hat_dy = grad_y(theta_hat)\n    \n    # --- Leonard Tensors ---\n    Lxx = test_filter(u_tilde * u_tilde) - u_hat * u_hat\n    Lyy = test_filter(v_tilde * v_tilde) - v_hat * v_hat\n    Lxy = test_filter(u_tilde * v_tilde) - u_hat * u_hat\n    \n    Lx_theta = test_filter(u_tilde * theta_tilde) - u_hat * theta_hat\n    Ly_theta = test_filter(v_tilde * theta_tilde) - v_hat * theta_hat\n\n    # --- Model Tensors M_ij and N_i ---\n    # Terms for M_ij\n    hat_abs_S_Sxx = test_filter(abs_S * Sxx)\n    hat_abs_S_Syy = test_filter(abs_S * Syy)\n    hat_abs_S_Sxy = test_filter(abs_S * Sxy)\n\n    Mxx = 2 * grid_delta**2 * hat_abs_S_Sxx - 2 * test_delta**2 * abs_S_hat * Sxx_hat\n    Myy = 2 * grid_delta**2 * hat_abs_S_Syy - 2 * test_delta**2 * abs_S_hat * Syy_hat\n    Mxy = 2 * grid_delta**2 * hat_abs_S_Sxy - 2 * test_delta**2 * abs_S_hat * Sxy_hat\n\n    # Terms for N_i\n    hat_abs_S_dthdx = test_filter(abs_S * dthdx)\n    hat_abs_S_dthdy = test_filter(abs_S * dthdy)\n\n    Nx_vec = grid_delta**2 * hat_abs_S_dthdx - test_delta**2 * abs_S_hat * dth_hat_dx\n    Ny_vec = grid_delta**2 * hat_abs_S_dthdy - test_delta**2 * abs_S_hat * dth_hat_dy\n\n    # --- Least Squares to find C_nu and C_theta ---\n    # Numerator for C_nu: <L_ij M_ij>\n    L_M = Lxx * Mxx + Lyy * Myy + 2 * Lxy * Mxy\n    num_C_nu = np.sum(L_M)\n\n    # Denominator for C_nu: <M_ij M_ij>\n    M_M = Mxx**2 + Myy**2 + 2 * Mxy**2\n    den_C_nu = np.sum(M_M)\n\n    C_nu_raw = num_C_nu / den_C_nu if den_C_nu != 0 else 0.0\n\n    # Numerator for C_theta: <L_i^theta N_i>\n    Lth_N = Lx_theta * Nx_vec + Ly_theta * Ny_vec\n    num_C_theta = np.sum(Lth_N)\n\n    # Denominator for C_theta: <N_i N_i>\n    N_N = Nx_vec**2 + Ny_vec**2\n    den_C_theta = np.sum(N_N)\n    \n    C_theta_raw = num_C_theta / den_C_theta if den_C_theta != 0 else 0.0\n\n    # --- Realizability and Final Quantities ---\n    C_nu = max(0, C_nu_raw)\n    C_theta = max(0, C_theta_raw)\n    \n    # Turbulent Prandtl number\n    with np.errstate(divide='ignore', invalid='ignore'):\n        Pr_t = np.divide(C_nu, C_theta)\n        if not np.isfinite(Pr_t):\n            Pr_t = 0.0 # Define as 0 if C_theta is 0, to avoid nan/inf\n\n    # Spatially averaged turbulent scalar diffusivity\n    K_t_field = C_theta * grid_delta**2 * abs_S\n    K_t_avg = np.mean(K_t_field)\n\n    return Pr_t, K_t_avg\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}