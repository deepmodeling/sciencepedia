{
    "hands_on_practices": [
        {
            "introduction": "在计算电化学中，我们经常需要在恒定电极电势下研究反应。然而，标准的分子模拟通常在固定电荷系综中进行，计算的是亥姆霍兹自由能 $F$。本练习将通过基本的热力学推导，揭示如何将固定电荷模拟的结果转换为恒电势系综下的吉布斯自由能 $G_{\\Psi}$ 。理解这种勒让德变换是正确解释电化学反应模拟结果的理论基石。",
            "id": "4239531",
            "problem": "一个固定温度 $T$ 和体积 $V$ 的等温电化学系统包含一个电极，其净电荷为 $Q$，静电势（相对于外部参考）为 $\\Psi$。该系统的亥姆霍兹自由能为 $F(T,V,\\{N_i\\},Q)$，其中 $\\{N_i\\}$ 表示电解质中在所关注的反应期间保持不变的所有化学物种的粒子数集合。一个反应将初始状态 $1$ 连接到最终状态 $2$，在相同的 $T$、$V$ 和 $\\{N_i\\}$ 条件下，但电极电荷发生变化 $\\Delta Q = Q_2 - Q_1 \\neq 0$。在固定电荷模拟中，反应自由能计算为 $\\Delta F_Q = F(T,V,\\{N_i\\},Q_2) - F(T,V,\\{N_i\\},Q_1)$，分别保持初始和最终状态的指定电荷 $Q_1$ 和 $Q_2$。\n\n在恒定电势模拟方法中，适当的热力学势以静电势 $\\Psi$ 作为自然变量，这是通过对共轭对 $(Q,\\Psi)$ 进行勒让德变换得到的。仅从包含该系统电功项的基本热力学微分出发，推导必须加到固定电荷反应自由能 $\\Delta F_Q$ 上的修正项的解析表达式，以获得在固定电势 $\\Psi$ 下的反应自由能，记为 $\\Delta G_{\\Psi}$。将您的最终答案表示为仅含 $\\Psi$ 和 $\\Delta Q$ 的单个封闭形式表达式。不要引入任何数值。仅提供修正项（即必须加到 $\\Delta F_Q$ 上的量）作为您的最终答案。",
            "solution": "首先对问题进行验证，以确保其科学基础扎实、提法恰当且客观。\n\n### 步骤1：提取已知条件\n- **系统：** 一个固定温度 $T$ 和体积 $V$ 的等温电化学系统。\n- **状态变量：** 电极净电荷 $Q$，电极静电势 $\\Psi$。\n- **热力学势：** 亥姆霍兹自由能 $F(T,V,\\{N_i\\},Q)$，其中 $\\{N_i\\}$ 是固定的粒子数。\n- **过程：** 一个从初始状态 $1$ 到最终状态 $2$ 的反应。\n- **过程约束：** 反应在恒定的 $T$、$V$ 和 $\\{N_i\\}$ 下发生。\n- **电荷变化：** 电极上的电荷变化量为 $\\Delta Q = Q_2 - Q_1 \\neq 0$。\n- **固定电荷自由能：** 在固定电荷系综中，反应自由能由 $\\Delta F_Q = F(T,V,\\{N_i\\},Q_2) - F(T,V,\\{N_i\\},Q_1)$ 给出。\n- **恒定电势势：** 通过对 $F$ 关于共轭对 $(Q,\\Psi)$ 进行勒让德变换，得到一个与恒定电势模拟相关的新热力学势。我们将其记为 $G_{\\Psi}$。\n- **目标：** 推导必须加到 $\\Delta F_Q$ 上的修正项的解析表达式，以获得在固定电势 $\\Psi$ 下的反应自由能，记为 $\\Delta G_{\\Psi}$。修正项的最终答案应以 $\\Psi$ 和 $\\Delta Q$ 表示。\n\n### 步骤2：使用提取的已知条件进行验证\n- **科学基础扎实：** 该问题基于化学热力学和静电学的基本原理。使用勒让德变换在不同热力学系综之间切换（从固定电荷到固定电势）是统计力学中的一个标准且严谨的程序。这些概念在物理上和数学上都是合理的。\n- **提法恰当：** 问题定义清晰。它要求基于一个明确的起点（基本热力学微分）和指定的数学运算（勒让德变换）推导一个特定的量（$\\Delta G_{\\Psi} - \\Delta F_Q$）。预期会有一个唯一的解析解。\n- **客观性：** 语言正式、精确且无歧义。所有术语如“亥姆霍兹自由能”、“勒让德变换”和“共轭对”在物理学和化学中都有标准的、客观的含义。\n\n### 步骤3：结论与行动\n问题被判定为**有效**。这是计算电化学中的一个标准推导。现在将推导解答。\n\n起点是一个开放电化学系统的内能 $U$ 的基本方程，该方程包含改变电极电荷所需的可逆电功项 $\\Psi dQ$。可逆过程的热力学第一定律是：\n$$dU = TdS - PdV + \\sum_i \\mu_i dN_i + \\Psi dQ$$\n其中 $T$ 是温度，$S$ 是熵，$P$ 是压力，$V$ 是体积，$\\mu_i$ 是化学势，$N_i$ 是粒子数。\n\n亥姆霍兹自由能 $F$ 定义为 $F = U - TS$。其全微分为：\n$$dF = dU - d(TS) = dU - TdS - SdT$$\n代入 $dU$ 的表达式：\n$$dF = (TdS - PdV + \\sum_i \\mu_i dN_i + \\Psi dQ) - TdS - SdT$$\n$$dF = -SdT - PdV + \\Psi dQ + \\sum_i \\mu_i dN_i$$\n这是亥姆霍兹自由能作为其自然变量 $F(T,V,Q,\\{N_i\\})$ 函数的基本微分。从此表达式中，我们可以将电极电势 $\\Psi$ 确定为在恒定 $T$、$V$ 和 $\\{N_i\\}$ 条件下，$F$ 对电荷 $Q$ 的偏导数：\n$$\\Psi = \\left(\\frac{\\partial F}{\\partial Q}\\right)_{T,V,\\{N_i\\}}$$\n这证实了 $Q$ 和 $\\Psi$ 构成一个热力学变量的共轭对。\n\n问题要求转换到一个系综，其中电势 $\\Psi$ 是自变量，而不是电荷 $Q$。这通过勒让德变换实现。我们定义一个新的热力学势，记为 $G_{\\Psi}$，如下：\n$$G_{\\Psi} = F - \\Psi Q$$\n这个新势的全微分为：\n$$dG_{\\Psi} = dF - d(\\Psi Q) = dF - \\Psi dQ - Q d\\Psi$$\n代入推导出的 $dF$ 表达式：\n$$dG_{\\Psi} = (-SdT - PdV + \\Psi dQ + \\sum_i \\mu_i dN_i) - \\Psi dQ - Q d\\Psi$$\n包含 $\\Psi dQ$ 的项相互抵消，得到：\n$$dG_{\\Psi} = -SdT - PdV - Q d\\Psi + \\sum_i \\mu_i dN_i$$\n这证实了 $G_{\\Psi}$ 的自然变量是 $T$、$V$、$\\Psi$ 和 $\\{N_i\\}$。因此，$G_{\\Psi}$ 是恒定温度、体积和电极电势下系统的适当热力学势。\n\n在恒定电势下的反应自由能 $\\Delta G_{\\Psi}$ 是反应从状态 $1$ 到状态 $2$ 过程中 $G_{\\Psi}$ 的变化量。反应在恒定的 $T$、$V$、$\\{N_i\\}$ 和固定的电势 $\\Psi$ 下发生。因此，我们可以将 $G_{\\Psi}$ 的变化写为：\n$$\\Delta G_{\\Psi} = G_{\\Psi,2} - G_{\\Psi,1}$$\n使用定义 $G_{\\Psi} = F - \\Psi Q$，我们可以用初始和最终状态的亥姆霍茲自由能 $F$ 和电荷 $Q$ 来表示这个差值：\n$$\\Delta G_{\\Psi} = (F_2 - \\Psi Q_2) - (F_1 - \\Psi Q_1)$$\n由于在整个过程中电势 $\\Psi$ 保持恒定，我们可以重新组合各项：\n$$\\Delta G_{\\Psi} = (F_2 - F_1) - \\Psi(Q_2 - Q_1)$$\n我们识别出问题陈述中给出的项：\n- 固定电荷反应自由能：$\\Delta F_Q = F_2 - F_1$\n- 电极电荷的变化：$\\Delta Q = Q_2 - Q_1$\n\n将这些定义代入 $\\Delta G_{\\Psi}$ 的方程中：\n$$\\Delta G_{\\Psi} = \\Delta F_Q - \\Psi \\Delta Q$$\n问题要求的是必须加到 $\\Delta F_Q$ 上以获得 $\\Delta G_{\\Psi}$ 的修正项。如果我们将此修正项表示为 $C$，我们就是在寻找方程中 $C$ 的值：\n$$\\Delta G_{\\Psi} = \\Delta F_Q + C$$\n通过将其与推导出的关系进行比较，我们可以直接确定修正项：\n$$C = -\\Psi \\Delta Q$$\n这就是修正项的解析表达式，用恒定电势 $\\Psi$ 和电荷变化量 $\\Delta Q$ 表示。",
            "answer": "$$\\boxed{-\\Psi \\Delta Q}$$"
        },
        {
            "introduction": "电极/电解质界面是一个复杂的区域，其电势分布并非均匀。为了理解恒电势模拟如何描述这一界面，我们可以使用简化的物理模型，例如将紧密层和扩散层视为串联的电容器。本练习旨在推导在给定的总电势差 $V$ 下，电势如何在这些子层之间分配 。这个练习有助于我们从概念上理解电化学双电层的结构和电势分布规律。",
            "id": "4239490",
            "problem": "在使用恒定电势法（CPM）的恒定电势分子动力学模拟中，一个原子级别的、理想导电的电极相对于体相电解质参比被保持在固定的电势上。界面区域被分解为一个紧凑的亥姆霍兹内亚层和一个扩散外亚层。在一个小范围的施加偏压下，每个亚层都呈线性响应，并被建模为理想电容器，其有效电容分别为紧凑亚层的 $C_{1}$ 和扩散亚层的 $C_{2}$。这两个亚层在电极和体相参比之间串联。施加一个外部的电极-体相电势差 $V$，电极电荷会自洽地调整以维持恒定电势边界条件。\n\n仅从电容的定义、适用于串联连接的电荷守恒，以及在恒定电势边界条件下界面电势降之和等于施加偏压这一事实出发，推导分别跨越紧凑亚层和扩散亚层的电势降 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$ 关于 $C_{1}$、$C_{2}$ 和 $V$ 的闭合形式表达式。假设线性响应，并忽略任何法拉第过程，因此界面响应是纯电容性的。将每个电势降以伏特表示。无需数值四舍五入；仅提供代数表达式。",
            "solution": "该问题要求推导跨越电化学界面两个不同亚层的电势降 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$，这两个亚层被建模为串联的电容器。推导必须从指定的基本原理出发。\n\n设 $C_{1}$ 为紧凑内亚层的电容，$C_{2}$ 为扩散外亚层的电容。设 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$ 分别为跨越紧凑亚层和扩散亚层的电势降。电极与体相电解质之间的总施加电势差为 $V$。\n\n问题提供了推导中要使用的三个核心原理：\n\n1.  **电容的定义**：电容器上存储的电荷 $Q$、其电容 $C$ 以及其两端的电势差 $\\Delta \\phi$ 之间的关系由 $Q = C \\Delta \\phi$ 给出。对于我们的两个亚层，该原理产生两个方程：\n    $$Q_{1} = C_{1} \\Delta \\phi_{1} \\quad (1)$$\n    $$Q_{2} = C_{2} \\Delta \\phi_{2} \\quad (2)$$\n    其中 $Q_{1}$ 和 $Q_{2}$ 分别是跨越紧凑亚层和扩散亚层的分离电荷的量值。\n\n2.  **串联连接的电荷守恒**：这两个亚层被建模为串联的电容器。在电容器串联时，当在组合两端施加电压时，每个电容器上存储的电荷量值是相同的。这是电容器之间电隔离区域中电荷守恒和静电感应的直接结果。因此，我们有：\n    $$Q_{1} = Q_{2} = Q \\quad (3)$$\n    其中 $Q$ 是电极上电荷量值的单一值，并相应地分离在每个亚层上。\n\n3.  **电势降的求和**：整个界面上的总电势降 $V$ 是串联各组件上单个电势降的总和。\n    $$V = \\Delta \\phi_{1} + \\Delta \\phi_{2} \\quad (4)$$\n\n我们现在有了一个可以求解 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$ 的方程组。\n\n首先，我们结合方程 $(1)$、$(2)$ 和 $(3)$ 来关联这两个电势降：\n$$Q = C_{1} \\Delta \\phi_{1}$$\n$$Q = C_{2} \\Delta \\phi_{2}$$\n将这两个关于 $Q$ 的表达式相等，得到 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$ 之间的一个关系：\n$$C_{1} \\Delta \\phi_{1} = C_{2} \\Delta \\phi_{2}$$\n由此，我们可以用另一个电势降来表示一个电势降。例如：\n$$\\Delta \\phi_{2} = \\frac{C_{1}}{C_{2}} \\Delta \\phi_{1} \\quad (5)$$\n\n接下来，我们将此关系代入电势求和方程 $(4)$：\n$$V = \\Delta \\phi_{1} + \\left( \\frac{C_{1}}{C_{2}} \\Delta \\phi_{1} \\right)$$\n现在，我们可以求解 $\\Delta \\phi_{1}$。提出因子 $\\Delta \\phi_{1}$：\n$$V = \\Delta \\phi_{1} \\left( 1 + \\frac{C_{1}}{C_{2}} \\right)$$\n$$V = \\Delta \\phi_{1} \\left( \\frac{C_{2} + C_{1}}{C_{2}} \\right)$$\n分离出 $\\Delta \\phi_{1}$ 得到其关于给定数量 $V$、$C_{1}$ 和 $C_{2}$ 的表达式：\n$$\\Delta \\phi_{1} = V \\left( \\frac{C_{2}}{C_{1} + C_{2}} \\right)$$\n\n为了找到 $\\Delta \\phi_{2}$ 的表达式，我们可以将推导出的 $\\Delta \\phi_{1}$ 的表达式代回方程 $(5)$：\n$$\\Delta \\phi_{2} = \\frac{C_{1}}{C_{2}} \\Delta \\phi_{1} = \\frac{C_{1}}{C_{2}} \\left( V \\frac{C_{2}}{C_{1} + C_{2}} \\right)$$\n消去 $C_{2}$ 项：\n$$\\Delta \\phi_{2} = V \\left( \\frac{C_{1}}{C_{1} + C_{2}} \\right)$$\n\n或者，我们可以从方程 $(5)$ 中将 $\\Delta \\phi_{1}$ 表示为 $\\Delta \\phi_{1} = \\frac{C_{2}}{C_{1}} \\Delta \\phi_{2}$，并将其代入方程 $(4)$ 中先求解 $\\Delta \\phi_{2}$。结果是相同的。\n\n作为最后的检验，我们可以将我们推导出的 $\\Delta \\phi_{1}$ 和 $\\Delta \\phi_{2}$ 的表达式相加，以确保它们的和等于总施加电势 $V$：\n$$\\Delta \\phi_{1} + \\Delta \\phi_{2} = V \\left( \\frac{C_{2}}{C_{1} + C_{2}} \\right) + V \\left( \\frac{C_{1}}{C_{1} + C_{2}} \\right)$$\n$$\\Delta \\phi_{1} + \\Delta \\phi_{2} = V \\left( \\frac{C_{2} + C_{1}}{C_{1} + C_{2}} \\right) = V \\cdot 1 = V$$\n推导是一致的。这些表达式代表了静电条件下串联电容器的分压规则。每个电容器上的电势降与其电容成反比。\n\n最终推导出的电势降表达式为：\n对于紧凑亚层：$\\Delta \\phi_{1} = V \\frac{C_{2}}{C_{1} + C_{2}}$\n对于扩散亚层：$\\Delta \\phi_{2} = V \\frac{C_{1}}{C_{1} + C_{2}}$\n这些是所要求的闭合形式表达式。问题陈述中要求以“伏特”表示答案的指令被解释为指定结果量的物理单位，而不是对符号答案的格式要求。",
            "answer": "$$\\boxed{\\begin{aligned} \\Delta\\phi_1 &= V \\frac{C_2}{C_1 + C_2} \\\\ \\Delta\\phi_2 &= V \\frac{C_1}{C_1 + C_2} \\end{aligned}}$$"
        },
        {
            "introduction": "将恒电势的物理概念转化为可执行的计算方法是计算电化学的核心挑战之一。本练习提供了一个实现恒电势泊松方程求解器的编程实践，该求解器专为电化学模拟中常见的平板几何结构设计 。通过结合傅里叶变换和有限差分法，你将亲手构建一个能够精确控制金属表面电势并验证电荷平衡的算法，从而深入理解这些先进模拟方法的底层工作原理。",
            "id": "4239452",
            "problem": "实现一个自包含程序，使用 Martyna–Tuckerman 边界条件求解板状几何结构中的静电势，并演示在金属边界上的恒定电势控制。其物理和算法设置如下。\n\n考虑一个在面内方向上周期性、沿表面法线方向有限的三维域。设面内坐标为 $x$ 和 $y$，表面法向坐标为 $z$。该域在 $x$、$y$ 和 $z$ 方向上的长度分别为 $L_x$、$L_y$ 和 $L_z$，并在一个具有 $N_x$、$N_y$ 和 $N_z$ 个点的均匀网格上进行离散化。面内方向 $x$ 和 $y$ 是周期性的。金属表面位于 $z=0$ 处，真空向 $z=L_z$ 方向延伸。\n\n静电势 $\\phi(x,y,z)$ 满足源于线性电介质中高斯定律的泊松方程：\n$$\n\\nabla \\cdot \\mathbf{E} = \\frac{\\rho(x,y,z)}{\\epsilon_0}, \\quad \\mathbf{E} = -\\nabla \\phi(x,y,z),\n$$\n这得到\n$$\n\\nabla^2 \\phi(x,y,z) = -\\frac{\\rho(x,y,z)}{\\epsilon_0},\n$$\n其中 $\\rho(x,y,z)$ 是自由电荷密度，$\\epsilon_0$ 是真空介电常数。对于在 $z=0$ 处受恒定电势控制的理想金属边界，边界条件强制施加一个空间均匀的电势，其值等于一个预设值 $V_0$，即：\n$$\n\\phi(x,y,0) = V_0,\n$$\n并且出现在金属上的表面电荷密度 $\\sigma(x,y)$ 与法向电场通过以下关系相关联：\n$$\n\\sigma(x,y) = -\\epsilon_0 \\left.\\frac{\\partial \\phi}{\\partial z}\\right|_{z=0^+}.\n$$\n对于一个嵌入在 $z=L_z$ 上方真空中的板状体系，使用 Martyna–Tuckerman 边界条件来防止非周期性方向上周期性镜像之间的伪相互作用。在混合空间中，通过在面内坐标中使用二维傅里叶变换，每个具有波矢 $\\mathbf{k}=(k_x,k_y)$ 和大小 $|\\mathbf{k}|$ 的面内傅里叶分量都满足一个沿 $z$ 方向的一维方程，\n$$\n\\frac{d^2 \\phi_{\\mathbf{k}}(z)}{dz^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z) = -\\frac{\\rho_{\\mathbf{k}}(z)}{\\epsilon_0},\n$$\n其边界条件为\n$$\n\\phi_{\\mathbf{k}}(z=0) = \\begin{cases}\nV_0  &\\text{if } |\\mathbf{k}|=0,\\\\\n0  &\\text{if } |\\mathbf{k}|>0,\n\\end{cases}\n\\qquad\n\\left.\\frac{d \\phi_{\\mathbf{k}}}{dz}\\right|_{z=L_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(L_z) = 0.\n$$\n左边界条件强制施加一个与 $x$ 和 $y$ 无关的恒定金属电势。右边界条件是一个 Robin 条件，确保对于 $|\\mathbf{k}|>0$ 的情况，电势在真空中呈指数衰减；对于零模式 $|\\mathbf{k}|=0$，它简化为一个零法向导数条件。\n\n您的任务是实现一个求解器，该求解器在 $x$ 和 $y$ 方向上使用二维离散傅里叶变换，在 $z$ 方向上使用二阶有限差分方法，以求解给定 $\\rho(x,y,z)$ 时上述关于 $\\phi(x,y,z)$ 的边值问题，然后演示在 $z=0$ 处的电势控制以及金属边界上正确的感应表面电荷。\n\n算法要求：\n- 对面内方向 $x$ 和 $y$ 使用二维离散傅里叶变换，以获得由周期性晶胞给出的所有离散波矢 $\\mathbf{k}$ 对应的 $\\rho_{\\mathbf{k}}(z)$。设 $k_x$ 和 $k_y$ 为与网格相关联的离散波矢（单位为弧度/米）。\n- 对于每个大小为 $|\\mathbf{k}|$ 的面内模式，使用二阶中心有限差分对内部点进行离散化，并恰当整合边界条件，来求解沿 $z$ 方向的一维问题。$z$ 网格间距为 $h_z = L_z/(N_z-1)$。对于索引为 $i\\in\\{1,2,\\dots,N_z-2\\}$ 的内部点 $z_i$，该微分方程的有限差分近似为\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{i-1}) - 2\\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1})}{h_z^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z_i) = -\\frac{\\rho_{\\mathbf{k}}(z_i)}{\\epsilon_0}.\n$$\n应用如上所述的左边界 Dirichlet 条件 $\\phi_{\\mathbf{k}}(z_0)$。在右边界 $z_{N_z-1}=L_z$ 处，通过一阶前向差分公式施加 Robin 条件，\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{N_z-1}) - \\phi_{\\mathbf{k}}(z_{N_z-2})}{h_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(z_{N_z-1}) = 0.\n$$\n- 对每个 $\\mathbf{k}$，构建并求解所得的三对角线性系统以获得 $\\phi_{\\mathbf{k}}(z)$，然后通过二维傅里叶逆变换重构 $\\phi(x,y,z)$。\n\n验证指标：\n- 金属边界处的恒定电势控制：在重构 $\\phi(x,y,z)$ 后，测量边界电势与设定值的最大绝对偏差，定义为\n$$\n\\Delta V = \\max_{x,y} \\left| \\phi(x,y,0) - V_0 \\right|.\n$$\n以伏特为单位报告此量。\n- 金属边界处的电荷平衡：通过在 $z=0^+$ 处对法向电场进行积分来计算金属上的感应表面电荷，\n$$\nQ_{\\text{ind}} = \\iint \\sigma(x,y) \\, dx\\,dy = -\\epsilon_0 \\iint \\left.\\frac{\\partial \\phi}{\\partial z}\\right|_{z=0^+} \\, dx\\,dy,\n$$\n其中导数在边界处通过一阶前向差分 $(\\phi(x,y,h_z)-\\phi(x,y,0))/h_z$ 来近似。计算域中的总自由电荷，\n$$\nQ_{\\text{free}} = \\iiint \\rho(x,y,z) \\, dx\\,dy\\,dz.\n$$\n定义电荷平衡误差\n$$\n\\Delta Q = \\left| Q_{\\text{ind}} + Q_{\\text{free}} \\right|.\n$$\n以库仑为单位报告此量。\n\n物理单位：\n- 使用国际单位制 (SI)：长度单位为米，电荷密度单位为库仑/立方米，电势单位为伏特，真空介电常数 $\\epsilon_0$ 单位为法拉/米。\n\n测试套件：\n为以下四个测试用例实现求解器，以检验典型情况、中性、零电荷边界和靠近真空边界的电荷。对于所有测试用例，使用 $L_x=L_y=L_z=4.0\\times 10^{-9}\\,\\text{m}$，$N_x=N_y=32$ 以及 $N_z=64$。\n\n1. 典型情况：一个三维高斯自由电荷分布，总电荷 $Q=1.0\\times 10^{-18}\\,\\text{C}$，中心位于 $(x_c,y_c,z_c)=(L_x/2,L_y/2,1.0\\times 10^{-9}\\,\\text{m})$，宽度 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.1\\,\\text{V}$。对高斯函数进行归一化，使其在离散域上的积分恰好得到 $Q$。\n2. 中性偶极子：两个大小相等、符号相反的高斯电荷，$Q_1=+5.0\\times 10^{-19}\\,\\text{C}$ 位于 $(L_x/2,L_y/2,1.0\\times 10^{-9}\\,\\text{m})$，$Q_2=-5.0\\times 10^{-19}\\,\\text{C}$ 位于 $(L_x/2,L_y/2,1.4\\times 10^{-9}\\,\\text{m})$，宽度 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.0\\,\\text{V}$。将每个高斯函数归一化至其指定的总电荷。\n3. 零电荷：无自由电荷，$\\rho(x,y,z)=0$，且 $V_0=-0.2\\,\\text{V}$。\n4. 靠近真空的电荷：一个高斯电荷，总电荷 $Q=1.0\\times 10^{-18}\\,\\text{C}$，中心位于 $(L_x/2,L_y/2,3.5\\times 10^{-9}\\,\\text{m})$，宽度 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.05\\,\\text{V}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个以逗号分隔的列表，列表内容为每个测试用例的结果。每个结果本身也是一个逗号分隔的列表，包含两个浮点数，顺序为 $[\\Delta V,\\Delta Q]$，即：\n$$\n\\text{Output: } \\left[ [\\Delta V_1,\\Delta Q_1], [\\Delta V_2,\\Delta Q_2], [\\Delta V_3,\\Delta Q_3], [\\Delta V_4,\\Delta Q_4] \\right].\n$$\n所有 $\\Delta V$ 值必须以伏特为单位报告，所有 $\\Delta Q$ 值必须以库仑为单位报告。程序必须是自包含的，不接受任何输入，并使用指定的库。",
            "solution": "用户要求实现一个使用 Martyna–Tuckerman 边界条件的板状几何结构恒定电势泊松求解器。该问题在科学上是适定的，并为数值求解提供了所有必要的信息。其方法涉及一种混合方法：在周期性的面内方向上使用二维傅里叶变换，在受限的法线方向上使用有限差分法。\n\n### 1. 问题表述与策略\n\n物理系统由泊松方程 $\\nabla^2 \\phi = -\\rho/\\epsilon_0$ 控制，作用域在 $x$ 和 $y$ 方向上是周期性的，在 $z$ 方向上是有限的，范围从 $z=0$ 到 $z=L_z$。位于 $z=0$ 处的金属电极保持在恒定电势 $\\phi(x,y,0) = V_0$。在另一边界 $z=L_z$ 处，静电场被假定衰减到真空中，这通过 Martyna–Tuckerman 边界条件进行建模。\n\n解决此边值问题的策略是利用 $x-y$ 平面内的周期性。通过应用二维傅里叶变换，\n$$\n\\phi_{\\mathbf{k}}(z) = \\frac{1}{L_x L_y} \\iint \\phi(x,y,z) e^{-i(k_x x + k_y y)} \\,dx\\,dy,\n$$\n三维偏微分方程 (PDE) 被转换为一组针对每个面内波矢 $\\mathbf{k}=(k_x, k_y)$ 的独立的一维常微分方程 (ODE)：\n$$\n\\frac{d^2 \\phi_{\\mathbf{k}}(z)}{dz^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z) = -\\frac{\\rho_{\\mathbf{k}}(z)}{\\epsilon_0}.\n$$\n边界条件也同样被变换。$z=0$ 处的恒定电势条件仅影响零频率模式 ($|\\mathbf{k}|=0$)：\n$$\n\\phi_{\\mathbf{k}}(z=0) = \\begin{cases} V_0  \\text{if } |\\mathbf{k}|=0, \\\\ 0  \\text{if } |\\mathbf{k}|>0. \\end{cases}\n$$\n在 $z=L_z$ 处的 Martyna–Tuckerman 条件成为对每个傅里叶分量的 Robin 型边界条件：\n$$\n\\left.\\frac{d \\phi_{\\mathbf{k}}}{dz}\\right|_{z=L_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(L_z) = 0.\n$$\n\n### 2. 数值离散化与求解\n\n该算法的核心是为计算网格支持的每个离散波矢 $\\mathbf{k}$ 求解一维边值问题。在 $z$ 方向上一个包含 $N_z$ 个点、间距为 $h_z = L_z/(N_z-1)$ 的均匀网格上，采用二阶有限差分格式。\n\n对于内部网格点 $z_i$（其中 $i \\in \\{1, 2, \\dots, N_z-2\\}$），常微分方程近似为：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{i-1}) - 2\\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1})}{h_z^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z_i) = -\\frac{\\rho_{\\mathbf{k}}(z_i)}{\\epsilon_0}.\n$$\n整理各项，我们得到每个内部点的线性方程：\n$$\n\\phi_{\\mathbf{k}}(z_{i-1}) + \\left(-2 - |\\mathbf{k}|^2 h_z^2\\right) \\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1}) = -\\frac{h_z^2}{\\epsilon_0}\\rho_{\\mathbf{k}}(z_i).\n$$\n左边界处的电势 $\\phi_{\\mathbf{k}}(z_0)$ 由 Dirichlet 条件可知。该项被移到 $i=1$ 方程的右侧。\n\n在 $z=L_z=z_{N_z-1}$ 处的 Robin 边界条件使用一阶后向差分对导数进行离散化，正如问题陈述的公式中所指定的（尽管其名称为“前向差分”）：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{N_z-1}) - \\phi_{\\mathbf{k}}(z_{N_z-2})}{h_z} + |\\mathbf{k}| \\phi_{\\mathbf{k}}(z_{N_z-1}) = 0,\n$$\n这给出了一个用 $\\phi_{\\mathbf{k}}(z_{N_z-2})$ 表示 $\\phi_{\\mathbf{k}}(z_{N_z-1})$ 的表达式：\n$$\n\\phi_{\\mathbf{k}}(z_{N_z-1}) = \\frac{\\phi_{\\mathbf{k}}(z_{N_z-2})}{1 + |\\mathbf{k}| h_z}.\n$$\n此关系被代入最后一个内部点 $i=N_z-2$ 的有限差分方程中。这次代入消除了作为未知数的 $\\phi_{\\mathbf{k}}(z_{N_z-1})$，并方便地保留了针对未知数 $\\phi_{\\mathbf{k}}(z_1), \\dots, \\phi_{\\mathbf{k}}(z_{N_z-2})$ 的线性系统的三对角结构。所得系统具有一个对角占优的三对角矩阵，可以高效、准确地求解。\n\n在求解出 $i=1, \\dots, N_z-2$ 的 $\\phi_{\\mathbf{k}}(z_i)$ 后，右边界的值 $\\phi_{\\mathbf{k}}(z_{N_z-1})$ 由上述关系确定。对每个离散波矢 $\\mathbf{k}$ 重复此过程。\n\n### 3. 重构与验证\n\n一旦计算出所有 $\\mathbf{k}$ 的电势 $\\phi_{\\mathbf{k}}(z)$，通过对平面内波矢执行二维离散傅里叶逆变换，即可重构出完整的三维电势 $\\phi(x,y,z)$。\n\n该解通过两个指标进行验证：\n1.  **恒定电势控制 ($\\Delta V$)**：计算 $z=0$ 平面上计算出的电势与目标电势 $V_0$ 之间的最大偏差。一个理想的求解器将得出接近机器精度的 $\\Delta V$。\n    $$\n    \\Delta V = \\max_{x,y} \\left| \\phi(x,y,0) - V_0 \\right|.\n    $$\n2.  **电荷平衡 ($\\Delta Q$)**：该指标验证了整个系统的高斯定律。金属表面上的总感应电荷 $Q_{\\text{ind}}$ 必须与模拟单元中的总自由电荷 $Q_{\\text{free}}$ 相平衡。感应电荷通过对表面法向电场分量进行积分来计算：\n    $$\n    Q_{\\text{ind}} = -\\epsilon_0 \\iint_{z=0} \\frac{\\partial \\phi}{\\partial z} \\,dx\\,dy \\approx -\\epsilon_0 A_{xy} \\sum_{i,j} \\frac{\\phi(x_i,y_j,h_z) - \\phi(x_i,y_j,0)}{h_z},\n    $$\n    其中 $A_{xy}$ 是 $x-y$ 平面中一个网格单元的面积。自由电荷 $Q_{\\text{free}}$ 通过沿 $z$ 轴使用梯形法则对电荷密度 $\\rho(x,y,z)$ 在整个域体积上积分来计算。电荷平衡误差则为：\n    $$\n    \\Delta Q = \\left| Q_{\\text{ind}} + Q_{\\text{free}} \\right|.\n    $$\n对于电中性系统，如果 $Q_{\\text{free}}$ 为零，则 $Q_{\\text{ind}}$ 应为零。对于带有净电荷的系统，金属表面充当镜像电荷平面，$Q_{\\text{ind}}$ 应与 $Q_{\\text{free}}$ 完全平衡。\n\n实现过程首先为每个测试用例定义网格和电荷分布。对于高斯分布，在离散网格上进行仔细的归一化，以确保总电荷与指定值相匹配。然后，求解器的核心部分如上所述执行傅里叶空间分解、一维求解和实空间重构。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\n# Physical Constants\nEPSILON_0 = 8.854187817e-12  # Vacuum permittivity in F/m\n\ndef generate_gaussian(grid_coords, center, sigma, Q, dV):\n    \"\"\"\n    Generates a 3D Gaussian charge density on a grid, normalized to a total charge Q.\n    \"\"\"\n    x, y, z = grid_coords\n    xc, yc, zc = center\n    sx, sy, sz = sigma\n    \n    # Handle periodic boundaries for in-plane-directions\n    dx = np.abs(x - xc)\n    dy = np.abs(y - yc)\n    Lx = x[-1,0,0] - x[0,0,0] + (x[1,0,0]-x[0,0,0]) if x.shape[0] > 1 else 0\n    Ly = y[0,-1,0] - y[0,0,0] + (y[0,1,0]-y[0,0,0]) if y.shape[1] > 1 else 0\n    dx = np.minimum(dx, Lx - dx)\n    dy = np.minimum(dy, Ly - dy)\n\n    gauss = np.exp(-0.5 * ((dx / sx)**2 + (dy / sy)**2 + ((z - zc) / sz)**2))\n    \n    # Normalize on the discrete grid\n    current_q = np.sum(gauss) * dV\n    if np.abs(current_q) > 1e-30:\n        rho = (Q / current_q) * gauss\n    else: # Avoid division by zero if total charge is zero anyway\n        rho = np.zeros_like(gauss)\n        \n    return rho\n\ndef solve_1d_bvp(rho_k, k_mag, v0_k, hz, epsilon0, Nz):\n    \"\"\"\n    Solves the 1D BVP for a single k-vector.\n    d^2(phi)/dz^2 - k^2 * phi = -rho/epsilon0\n    \"\"\"\n    if Nz  3:\n        # Trivial cases not applicable for this problem's parameters\n        phi_k = np.zeros_like(rho_k)\n        if Nz > 0:\n            phi_k[0] = v0_k\n        return phi_k\n\n    k_hz = k_mag * hz\n    \n    # System size is Nz-2 for unknowns phi_1, ..., phi_{Nz-2}\n    M = Nz - 2\n    \n    # Tridiagonal matrix in banded format (l=1, u=1)\n    # ab[0,:] = super-diagonal (u)\n    # ab[1,:] = main-diagonal\n    # ab[2,:] = sub-diagonal (l)\n    ab = np.zeros((3, M))\n    \n    # Diagonals\n    d = -2.0 - k_hz**2\n    ab[0, 1:] = 1.0\n    ab[1, :] = d\n    ab[2, :-1] = 1.0\n    \n    # Modify last diagonal element due to Robin BC at z=Lz\n    # phi_{N-1} = phi_{N-2} / (1 + |k|*hz)\n    # Eq for N-2: phi_{N-3} + d*phi_{N-2} + phi_{N-1} = rhs\n    # -> phi_{N-3} + (d + 1/(1+|k|hz))*phi_{N-2} = rhs\n    if (1.0 + k_hz) > 1e-12:\n        ab[1, -1] += 1.0 / (1.0 + k_hz)\n    else: # k=0 case\n        ab[1, -1] += 1.0\n\n    # Right-hand side vector\n    b = -hz**2 * rho_k[1:-1] / epsilon0\n    b[0] -= v0_k  # Dirichlet BC at z=0\n\n    # Solve the tridiagonal system\n    phi_1_to_Nm2 = solve_banded((1, 1), ab, b)\n    \n    # Reconstruct the full phi_k vector\n    phi_Nm1 = 0.0\n    if (1.0 + k_hz) > 1e-12:\n        phi_Nm1 = phi_1_to_Nm2[-1] / (1.0 + k_hz)\n    else: # k=0 case\n        phi_Nm1 = phi_1_to_Nm2[-1]\n\n    phi_k = np.concatenate(([v0_k], phi_1_to_Nm2, [phi_Nm1]))\n    \n    return phi_k\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1: Happy path\n        {'charges': [{'Q': 1.0e-18, 'center': (2.0e-9, 2.0e-9, 1.0e-9)}],\n         'V0': 0.1, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 2: Neutral dipole\n        {'charges': [{'Q': 5.0e-19, 'center': (2.0e-9, 2.0e-9, 1.0e-9)},\n                     {'Q': -5.0e-19, 'center': (2.0e-9, 2.0e-9, 1.4e-9)}],\n         'V0': 0.0, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 3: Zero charge\n        {'charges': [], 'V0': -0.2, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 4: Charge near vacuum\n        {'charges': [{'Q': 1.0e-18, 'center': (2.0e-9, 2.0e-9, 3.5e-9)}],\n         'V0': 0.05, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)}\n    ]\n\n    results = []\n    \n    Lx, Ly, Lz = 4.0e-9, 4.0e-9, 4.0e-9\n    Nx, Ny, Nz = 32, 32, 64\n\n    # Grid setup\n    hx, hy = Lx / Nx, Ly / Ny\n    hz = Lz / (Nz - 1)\n    \n    x_1d = np.linspace(0, Lx, Nx, endpoint=False)\n    y_1d = np.linspace(0, Ly, Ny, endpoint=False)\n    z_1d = np.linspace(0, Lz, Nz, endpoint=True)\n\n    x, y, z = np.meshgrid(x_1d, y_1d, z_1d, indexing='ij')\n    grid_coords = (x, y, z)\n    dV = hx * hy * hz\n    \n    # Wavevectors\n    kx = 2 * np.pi * np.fft.fftfreq(Nx, d=hx)\n    ky = 2 * np.pi * np.fft.fftfreq(Ny, d=hy)\n    kx_grid, ky_grid = np.meshgrid(kx, ky, indexing='ij')\n    k_mag_grid = np.sqrt(kx_grid**2 + ky_grid**2)\n\n    for case in test_cases:\n        # 1. Generate charge density\n        rho_xyz = np.zeros((Nx, Ny, Nz))\n        for charge in case['charges']:\n            rho_xyz += generate_gaussian(grid_coords, charge['center'], case['sigma'], charge['Q'], dV)\n\n        # 2. Compute total free charge using trapezoidal rule for Z\n        # sum over x,y, then trapz over z\n        q_free_z = np.sum(rho_xyz, axis=(0,1)) * hx * hy\n        Q_free = np.trapz(q_free_z, dx=hz)\n\n        # 3. 2D FFT of charge density\n        rho_k_z = np.fft.fftn(rho_xyz, axes=(0, 1))\n        \n        # 4. Solve 1D BVP for each k-mode\n        phi_k_z = np.zeros_like(rho_k_z, dtype=complex)\n        V0 = case['V0']\n        \n        for i in range(Nx):\n            for j in range(Ny):\n                k_mag = k_mag_grid[i, j]\n                rho_k = rho_k_z[i, j, :]\n                \n                # Set V0 for k=0 mode, 0 otherwise\n                v0_k = V0 if k_mag  1e-9 else 0.0\n                \n                phi_k = solve_1d_bvp(rho_k, k_mag, v0_k, hz, EPSILON_0, Nz)\n                phi_k_z[i, j, :] = phi_k\n\n        # 5. Inverse 2D FFT to get real-space potential\n        phi_xyz = np.real(np.fft.ifftn(phi_k_z, axes=(0, 1)))\n\n        # 6. Verification metrics\n        # Delta V: Constant potential control\n        phi_at_z0 = phi_xyz[:, :, 0]\n        delta_V = np.max(np.abs(phi_at_z0 - V0))\n\n        # Delta Q: Charge balance\n        # Induced charge Q_ind\n        dphi_dz_at_z0 = (phi_xyz[:, :, 1] - phi_xyz[:, :, 0]) / hz\n        sigma_xy = -EPSILON_0 * dphi_dz_at_z0\n        Q_ind = np.sum(sigma_xy) * hx * hy\n        \n        delta_Q = np.abs(Q_ind + Q_free)\n        \n        results.append([delta_V, delta_Q])\n\n    # Final printing\n    print(f\"[{','.join([f'[{v},{q}]' for v, q in results])}]\")\n\nsolve()\n```"
        }
    ]
}