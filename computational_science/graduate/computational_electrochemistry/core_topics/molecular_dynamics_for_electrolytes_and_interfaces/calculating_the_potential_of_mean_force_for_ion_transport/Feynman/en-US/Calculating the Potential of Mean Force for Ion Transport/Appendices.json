{
    "hands_on_practices": [
        {
            "introduction": "Before calculating a Potential of Mean Force, one must first define the path, or reaction coordinate. In simulations with periodic boundary conditions, a naive choice of coordinate can create artificial discontinuities, leading to a corrupted PMF. This exercise  challenges you to think critically about the topological properties of the simulation space and select a mathematically sound coordinate definition that correctly handles periodicity.",
            "id": "4237573",
            "problem": "In a molecular dynamics simulation of ion transport across an electrochemical slab, you simulate a single monovalent ion in a rectangular box of dimensions $L_x \\times L_y \\times L_z$ with Periodic Boundary Conditions (PBC) applied in all directions. The slab spans the $x$–$y$ plane and is nominally centered at $z_{\\mathrm{slab}}$, with vacuum padding along $z$ but still subject to PBC. You seek to compute the Potential of Mean Force (PMF) for ion transport across the slab along the normal direction, using a one-dimensional reaction coordinate (also called a collective variable, CV) $\\xi(\\mathbf{R})$ that depends on the instantaneous positions $\\mathbf{R}$.\n\nThe PMF $W(\\xi)$ is defined, up to an additive constant, by the equilibrium marginal probability density $P(\\xi)$ via $W(\\xi) = -k_{\\mathrm{B}} T \\ln P(\\xi) + C$, where $k_{\\mathrm{B}}$ is the Boltzmann constant, $T$ is the absolute temperature, and $C$ is a constant independent of $\\xi$. In a slab geometry with PBC along $z$, a naive choice of the coordinate $z_i - z_{\\mathrm{slab}}$ for the ion’s $z$ position $z_i$ can produce discontinuities when the ion crosses the periodic boundary, which in turn can corrupt the histogram $P(\\xi)$ and the resulting PMF.\n\nYour goal is to select a definition of $\\xi$ that is a single-valued function of instantaneous positions, is wrap-aware under PBC along $z$, and avoids discontinuities across the entire admissible $z$ domain, while yielding a valid PMF for transport across the slab. Consider the following candidate definitions, where $L_z$ is the box length along $z$:\n\nA. $\\xi_A(\\mathbf{R}) = z_i - z_{\\mathrm{slab}}$, where $z_i$ and $z_{\\mathrm{slab}}$ are the wrapped positions in the primary simulation cell.\n\nB. $\\xi_B(\\mathbf{R}) = \\mathrm{wrap}_{(-L_z/2,\\,L_z/2]}\\!\\left(z_i - z_{\\mathrm{slab}}\\right)$, i.e., the signed minimum-image difference between $z_i$ and $z_{\\mathrm{slab}}$, mapped into the interval $(-L_z/2,\\,L_z/2]$.\n\nC. $\\xi_C(\\mathbf{R}; t)$ equals $z_i - z_{\\mathrm{slab}}$ but is “unwrapped” in time by adding or subtracting integer multiples of $L_z$ whenever the ion crosses a periodic boundary during the trajectory, so $\\xi_C$ can take values outside $(-L_z/2,\\,L_z/2]$ and depends on the crossing history.\n\nD. Define the angular variable $\\theta(\\mathbf{R}) = \\frac{2\\pi}{L_z}\\left[z_i - z_{\\mathrm{slab}}\\right]$ and the $2$-component CV\n$\\boldsymbol{\\xi}_D(\\mathbf{R}) = \\big(\\cos \\theta(\\mathbf{R}),\\, \\sin \\theta(\\mathbf{R})\\big)$. Sampling and biasing are performed by restraining $\\boldsymbol{\\xi}_D$ toward a target angle $\\theta_0$ through its components, and the PMF is reconstructed as a function of $\\theta$; the PMF as a function of $z$ follows by the linear map $z = z_{\\mathrm{slab}} + \\frac{L_z}{2\\pi}\\theta$.\n\nWhich option(s) provide a wrap-aware definition that is single-valued in $\\mathbf{R}$, avoids discontinuities over the entire admissible range under PBC along $z$, and yields a valid PMF for ion transport, up to an additive constant? Select all that apply.",
            "solution": "The problem requires the selection of a collective variable (CV), denoted as $\\xi(\\mathbf{R})$, for calculating the Potential of Mean Force (PMF) of ion transport across a slab in a simulation with Periodic Boundary Conditions (PBC) along the transport direction, $z$. The PMF, $W(\\xi)$, is related to the equilibrium probability density $P(\\xi)$ by $W(\\xi) = -k_{\\mathrm{B}} T \\ln P(\\xi) + C$, where $k_{\\mathrm{B}}$ is the Boltzmann constant, $T$ is the temperature, and $C$ is an arbitrary constant.\n\nA valid CV, $\\xi(\\mathbf{R})$, must satisfy several critical properties:\n$1$. It must be a single-valued function of the instantaneous atomic positions $\\mathbf{R}$. The PMF is an equilibrium property depending on the configuration space, not the history of a trajectory.\n$2$. It must be continuous with respect to particle movement. Since the simulation box is periodic in the $z$ direction, the physical space has the topology of a cylinder ($S^1 \\times \\mathbb{R}^2$). A point at $z = z_0$ is physically identical to a point at $z = z_0 + n L_z$ for any integer $n$, where $L_z$ is the box length. A CV that exhibits a discontinuity when a particle crosses this periodic boundary will lead to an incorrect sampling of the probability distribution $P(\\xi)$ and, consequently, an artifactual PMF.\n$3$. It must be \"wrap-aware\", meaning it correctly handles the periodicity of the system.\n\nWe will now evaluate each proposed definition of $\\xi$ against these criteria.\n\nA. $\\xi_A(\\mathbf{R}) = z_i - z_{\\mathrm{slab}}$, where $z_i$ and $z_{\\mathrm{slab}}$ are the wrapped positions in the primary simulation cell. Let the primary cell be defined by $z \\in [-L_z/2, L_z/2)$. The ion's position $z_i$ is always mapped into this interval. As the ion moves continuously across the periodic boundary, for example from a position $z_i = L_z/2 - \\epsilon$ to $z_i' = -L_z/2 + \\epsilon$ (where $\\epsilon$ is a small positive displacement), the value of $\\xi_A$ jumps from $\\xi_A \\approx L_z/2 - z_{\\mathrm{slab}}$ to $\\xi_A' \\approx -L_z/2 - z_{\\mathrm{slab}}$. This is a large, unphysical discontinuity in the reaction coordinate for an infinitesimal physical displacement. This discontinuity will create artificial barriers in the calculated PMF by severely depleting the measured probability density $P(\\xi)$ at the values corresponding to the boundary. Therefore, this definition is unsuitable.\n**Verdict: Incorrect.**\n\nB. $\\xi_B(\\mathbf{R}) = \\mathrm{wrap}_{(-L_z/2,\\,L_z/2]}\\!\\left(z_i - z_{\\mathrm{slab}}\\right)$. This is the signed minimum-image difference. This function computes the shortest vector between the ion at $z_i$ and the slab center at $z_{\\mathrm{slab}}$ considering all periodic images. While a standard operation in MD simulations for calculating forces, it is not a suitable CV for PMF calculations across the entire box. The `wrap` function itself introduces a discontinuity. When the argument $z_i - z_{\\mathrm{slab}}$ continuously crosses the value $L_z/2$, the output of $\\xi_B$ jumps from $L_z/2$ to $-L_z/2$. Physically, the ion is at a point maximally distant from the slab center, and the two ends of the CV's range, $-L_z/2$ and $L_z/2$, correspond to the same physical location. However, they are treated as distinct and far-apart points on the reaction coordinate axis. This creates the same problem as in option A: a discontinuity that corrupts the PMF calculation.\n**Verdict: Incorrect.**\n\nC. $\\xi_C(\\mathbf{R}; t)$ is the \"unwrapped\" coordinate, which is made continuous in time by adding or subtracting integer multiples of $L_z$ upon boundary crossings. For instance, if the ion moves from $z_i(t_1) = L_z - \\epsilon$ to $z_i(t_2) = \\epsilon$ in the primary cell, the unwrapped coordinate would change from $\\xi_C(t_1) \\approx z_{\\mathrm{ref}} + L_z - \\epsilon$ to $\\xi_C(t_2) \\approx z_{\\mathrm{ref}} + L_z + \\epsilon$, where $z_{\\mathrm{ref}}$ is some reference. The key issue here is that $\\xi_C$ is not a function of the instantaneous configuration $\\mathbf{R}$ alone. Its value depends on the trajectory history—specifically, the net number of times the ion has crossed the periodic boundary in a certain direction. A single configuration $\\mathbf{R}$ (e.g., the ion at a specific $z_i$) can correspond to multiple, distinct values of $\\xi_C$ (e.g., $z_i - z_{\\mathrm{slab}}$, $z_i - z_{\\mathrm{slab}} + L_z$, $z_i - z_{\\mathrm{slab}} - L_z$, etc.). The PMF is defined from the equilibrium probability distribution over the configurational phase space, $P(\\mathbf{R})$, and requires the CV to be a unique function of state, $\\xi(\\mathbf{R})$. Because $\\xi_C$ is history-dependent, it violates this fundamental requirement.\n**Verdict: Incorrect.**\n\nD. $\\boldsymbol{\\xi}_D(\\mathbf{R}) = \\big(\\cos \\theta(\\mathbf{R}),\\, \\sin \\theta(\\mathbf{R})\\big)$, with $\\theta(\\mathbf{R}) = \\frac{2\\pi}{L_z}\\left[z_i - z_{\\mathrm{slab}}\\right]$. This definition maps the one-dimensional periodic coordinate $z_i$ onto the unit circle in a two-dimensional space.\n$1$. **Single-valued function of $\\mathbf{R}$**: For any instantaneous position $z_i$, the angle $\\theta$ is uniquely defined modulo $2\\pi$, which in turn uniquely defines the values of $\\cos\\theta$ and $\\sin\\theta$. Thus, the two-component CV $\\boldsymbol{\\xi}_D$ is a single-valued function of the configuration $\\mathbf{R}$.\n$2$. **Continuity and Wrap-awareness**: Let's examine the behavior at the periodic boundary. Consider the same boundary crossing as before, where $z_i - z_{\\mathrm{slab}}$ goes from $L_z/2 - \\epsilon$ to $-L_z/2 + \\epsilon$. The corresponding angle $\\theta$ goes from $\\pi - \\delta$ to $-\\pi + \\delta$, where $\\delta = 2\\pi\\epsilon/L_z$. The CV $\\boldsymbol{\\xi}_D$ transitions from $(\\cos(\\pi-\\delta), \\sin(\\pi-\\delta))$ to $(\\cos(-\\pi+\\delta), \\sin(-\\pi+\\delta))$. As $\\delta \\to 0$, both points continuously approach $(\\cos(\\pi), \\sin(\\pi)) = (-1, 0)$ and $(\\cos(-\\pi), \\sin(-\\pi)) = (-1, 0)$. The mapping from the physical position $z_i$ to the point $(\\cos\\theta, \\sin\\theta)$ on the circle is perfectly continuous everywhere. The discontinuity of the linear coordinate is resolved by correctly representing the periodic topology.\n$3$. **Valid PMF**: Advanced sampling methods can apply biases or restraints on these two components, which is a well-established and robust technique. For example, one can restrain the angle $\\theta$ to a target $\\theta_0$ using a harmonic potential on the chord distance: $V(\\theta) = \\frac{1}{2} k [(\\cos\\theta - \\cos\\theta_0)^2 + (\\sin\\theta - \\sin\\theta_0)^2]$. From the sampled distributions, a PMF as a function of the angle, $W(\\theta)$, can be constructed. Since the angle $\\theta$ has a one-to-one linear mapping to the physical distance $z_i - z_{\\mathrm{slab}}$ within a single periodic image, $W(\\theta)$ is equivalent to the desired $W(z)$, up to a trivial scaling of the x-axis and an additive constant. This approach correctly handles the periodic nature of the problem and satisfies all the stated requirements.\n**Verdict: Correct.**",
            "answer": "$$\\boxed{D}$$"
        },
        {
            "introduction": "Once a simulation using a valid coordinate is complete, the raw data must be processed to yield the PMF. For constrained MD, this involves integrating the time-averaged constraint force, which serves as a direct measure of the free energy gradient. This practice problem  guides you through designing a robust analysis workflow, with a crucial emphasis on correctly estimating statistical errors from correlated time-series data.",
            "id": "4237554",
            "problem": "A monovalent ion is transported along the axis of a cylindrical nanopore immersed in liquid water at constant temperature $T$. The reaction coordinate $\\xi$ is defined as the axial position of the ion relative to the pore midplane, and a holonomic constraint $\\xi(\\mathbf{q})=\\xi_0$ with unit gradient in a mass-weighted metric is enforced during Molecular Dynamics (MD) using a Lagrange multiplier $\\lambda(t)$ that generates an instantaneous constraint force along $\\xi$. The system is thermostatted to sample the canonical ensemble. You run constrained MD at a set of discrete positions $\\{\\xi_i\\}_{i=0}^M$, each for a production time $T_i$ after equilibration, and you record the time series $\\lambda_i(t)$ in each window. Under the stated assumptions, metric corrections to the free-energy gradient are negligible. You wish to convert the measured time averages of the constraint force into the Potential of Mean Force (PMF) $W(\\xi)$ by numerical integration and report statistically meaningful error bars at each $\\xi$.\n\nWhich option correctly outlines a scientifically sound procedure to (i) measure the time average of the constraint force in each constrained MD window, (ii) estimate its statistical uncertainty accounting for time correlation, (iii) perform numerical integration to obtain $W(\\xi)$ relative to a chosen reference $\\xi_0$, and (iv) propagate the uncertainties to obtain error bars on $W(\\xi)$?\n\nA. In each window $i$, collect the Lagrange multiplier time series $\\lambda_i(t)$ after equilibration. Estimate the time average $\\langle \\lambda \\rangle_i$ and the integrated autocorrelation time $\\tau_i$ of $\\lambda_i(t)$; then compute the standard error of the mean as $\\sigma_{\\bar{\\lambda},i} \\approx \\sqrt{\\frac{2\\,\\tau_i}{T_i}}\\,s_{\\lambda,i}$, where $s_{\\lambda,i}$ is the standard deviation of $\\lambda_i(t)$ over the production trajectory of length $T_i$. Construct the PMF by trapezoidal integration,\n$$\nW(\\xi_j)-W(\\xi_0)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i}{2}\\left(\\langle \\lambda \\rangle_{i+1}+\\langle \\lambda \\rangle_{i}\\right),\n$$\nwith $\\Delta \\xi_i=\\xi_{i+1}-\\xi_i$, and set $W(\\xi_0)=0$ or any convenient reference. Assuming statistical independence between distinct windows, propagate uncertainties as\n$$\n\\sigma_{W}^2(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i^2}{4}\\left(\\sigma_{\\bar{\\lambda},i+1}^2+\\sigma_{\\bar{\\lambda},i}^2\\right).\n$$\nValidate by checking consistency of forward and backward integrations and overlap across neighboring windows.\n\nB. In each window, compute the instantaneous projection of the total physical force on the ion along $z$, $f_{z}(t)$, and average it to obtain $\\langle f_{z} \\rangle_i$. Estimate the error as $\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$, where $s_{f,i}$ is the standard deviation and $N_i$ is the number of saved frames, assuming independent samples. Integrate using Simpson’s rule,\n$$\nW(\\xi_j)-W(\\xi_0)\\approx -\\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i}{6}\\left(\\langle f_{z} \\rangle_{i}+4\\langle f_{z} \\rangle_{i+\\frac{1}{2}}+\\langle f_{z} \\rangle_{i+1}\\right),\n$$\nwhere midpoints $i+\\tfrac{1}{2}$ are obtained by interpolation. Report error bars by summing standard deviations linearly, $\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\sigma_{\\bar{f},i}$.\n\nC. Run umbrella sampling with a harmonic bias $U_{\\mathrm{bias}}(\\xi)=\\tfrac{1}{2}k(\\xi-\\xi_i)^2$ in windows centered at $\\xi_i$, collect biased histograms of $\\xi$, unbias them by dividing by $\\exp[-U_{\\mathrm{bias}}(\\xi)/k_{\\mathrm{B}}T]$, and estimate the PMF as $W(\\xi)=-k_{\\mathrm{B}}T\\ln P(\\xi)+\\text{const}$. Estimate errors from histogram counting statistics as $\\sqrt{P(\\xi)}$. No constraint forces or integration of averaged forces are needed.\n\nD. Record $\\lambda_i(t)$ in each constrained window and compute $\\langle \\lambda \\rangle_i$. Because the metric is constant, set the error of the mean to $\\sigma_{\\bar{\\lambda},i}=s_{\\lambda,i}/\\sqrt{N_i}$ without considering autocorrelation. Obtain $W(\\xi)$ by summing left-Riemann contributions,\n$$\nW(\\xi_j)-W(\\xi_0)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\langle \\lambda \\rangle_i,\n$$\nand propagate uncertainties by adding window-wise standard errors linearly,\n$$\n\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\sigma_{\\bar{\\lambda},i}.\n$$",
            "solution": "The problem statement describes the calculation of the Potential of Mean Force (PMF) for ion transport through a nanopore using constrained Molecular Dynamics (MD), a standard and important technique in computational chemistry and biophysics. The validation of the problem statement is as follows.\n\n**Problem Validation**\n\n**Step 1: Extract Givens**\n- System: A monovalent ion transported along the axis of a cylindrical nanopore in liquid water at constant temperature $T$.\n- Reaction Coordinate: $\\xi$ is the axial position of the ion relative to the pore midplane.\n- Simulation Method: Constrained MD enforcing a holonomic constraint $\\xi(\\mathbf{q})=\\xi_0$.\n- Constraint Details: The gradient of the constraint has unit magnitude in a mass-weighted metric.\n- Constraint Enforcement: A Lagrange multiplier $\\lambda(t)$ generates the constraint force.\n- Ensemble: Canonical ensemble, sampled via thermostatting.\n- Protocol: A series of constrained MD simulations are run at discrete positions $\\{\\xi_i\\}_{i=0}^M$.\n- Collected Data: The time series of the Lagrange multiplier, $\\lambda_i(t)$, is recorded for each window $i$ over a production time $T_i$.\n- Assumption: Metric corrections to the free-energy gradient are negligible.\n- Objective: To determine a procedure to calculate the PMF, $W(\\xi)$, by numerically integrating the mean constraint force, and to compute the associated statistical error bars.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded**: The problem is firmly based on the principles of statistical mechanics. The relationship between the PMF, $W(\\xi)$, and the mean force is fundamental. For a system constrained at a specific value of a reaction coordinate $\\xi$, the derivative of the PMF with respect to the coordinate is equal to the mean force required to hold the constraint. This mean force is provided by the constraint algorithm and is reported as the time average of the Lagrange multiplier, $\\langle \\lambda \\rangle$. The problem states that metric corrections are negligible, which simplifies the relationship to $\\frac{dW(\\xi)}{d\\xi} = \\langle \\lambda \\rangle_{\\xi}$. This is a standard formulation for thermodynamic integration using constraints.\n- **Well-Posed**: The problem is well-posed. It provides a clear physical scenario, specifies the simulation methodology and the data obtained, and asks for a valid data analysis procedure to compute a well-defined physical quantity ($W(\\xi)$) and its uncertainty. A unique solution (up to a reference constant for the PMF) exists and the methods to obtain it are standard.\n- **Objective**: The language is precise, technical, and free of ambiguity or subjective claims.\n\n**Step 3: Verdict and Action**\nThe problem statement is valid. It describes a physically meaningful and computationally relevant task based on sound scientific principles. I will proceed to derive the correct procedure and evaluate each option.\n\n**Derivation of the Correct Procedure**\n\n1.  **Mean Force from Lagrange Multiplier**: From first principles of statistical mechanics, the derivative of the PMF along the reaction coordinate $\\xi$ is the negative of the mean generalized force along that coordinate. In a constrained MD simulation, this force is balanced by the constraint force. Under the problem's assumption that metric corrections are negligible, the relationship is direct:\n    $$ \\frac{dW(\\xi)}{d\\xi} \\bigg|_{\\xi=\\xi_i} = \\langle \\lambda \\rangle_i $$\n    where $\\langle \\lambda \\rangle_i$ is the ensemble average of the Lagrange multiplier in the simulation window where the constraint $\\xi=\\xi_i$ is applied. This is estimated by the time average from a sufficiently long trajectory.\n\n2.  **Estimation of Mean and Statistical Error**: The time series $\\lambda_i(t)$ obtained from an MD simulation is autocorrelated. A naive calculation of the standard error of the mean, $s_{\\lambda,i}/\\sqrt{N_i}$ (where $s_{\\lambda,i}$ is the standard deviation and $N_i$ is the number of data points), assumes independent samples and will severely underestimate the true statistical uncertainty. The correct approach must account for this correlation. A standard method is to compute the integrated autocorrelation time, $\\tau_i$, of the time series. The variance of the sample mean $\\bar{\\lambda}_i$ is then given by:\n    $$ \\sigma^2_{\\bar{\\lambda},i} = \\frac{2\\tau_i}{T_i} s_{\\lambda,i}^2 $$\n    where $T_i$ is the total length of the time series. The standard error is the square root of this value. An alternative but asymptotically equivalent method is block averaging.\n\n3.  **Numerical Integration**: To obtain the PMF $W(\\xi)$, one must numerically integrate the mean force values:\n    $$ W(\\xi_j) - W(\\xi_0) = \\int_{\\xi_0}^{\\xi_j} \\langle \\lambda(\\xi') \\rangle d\\xi' $$\n    Given values of $\\langle \\lambda \\rangle_i$ at discrete points $\\{\\xi_i\\}$, a numerical quadrature rule must be used. The trapezoidal rule is a common and robust choice:\n    $$ W(\\xi_j) - W(\\xi_0) \\approx \\sum_{i=0}^{j-1} \\frac{\\xi_{i+1}-\\xi_i}{2} \\left( \\langle \\lambda \\rangle_{i+1} + \\langle \\lambda \\rangle_i \\right) $$\n    The PMF is defined up to an arbitrary additive constant, so $W(\\xi_0)$ can be set to $0$ to define a reference.\n\n4.  **Error Propagation**: The uncertainties in the individual mean force estimates, $\\sigma_{\\bar{\\lambda},i}$, must be propagated through the numerical integration. Since the simulations in different windows are independent, the estimates $\\langle \\lambda \\rangle_i$ are uncorrelated random variables. The variance of the integrated PMF at point $\\xi_j$, $\\sigma_W^2(\\xi_j)$, is found by summing the contributions from each $\\langle \\lambda \\rangle_k$ in quadrature, weighted by the square of their coefficient in the integration sum. For the trapezoidal rule, the exact propagation of variance is:\n    $$ \\sigma_W^2(\\xi_j) = \\text{Var}\\left( \\sum_{i=0}^{j-1} \\frac{\\Delta \\xi_i}{2} (\\langle \\lambda \\rangle_i + \\langle \\lambda \\rangle_{i+1}) \\right) $$\n    $$ \\sigma_W^2(\\xi_j) = \\left(\\frac{\\Delta \\xi_0}{2}\\right)^2\\sigma_{\\bar{\\lambda},0}^2 + \\sum_{k=1}^{j-1} \\left(\\frac{\\Delta \\xi_{k-1}+\\Delta \\xi_k}{2}\\right)^2\\sigma_{\\bar{\\lambda},k}^2 + \\left(\\frac{\\Delta \\xi_{j-1}}{2}\\right)^2\\sigma_{\\bar{\\lambda},j}^2 $$\n    where $\\Delta\\xi_i = \\xi_{i+1} - \\xi_i$.\n\n**Option-by-Option Analysis**\n\n**A. In each window $i$, collect the Lagrange multiplier time series $\\lambda_i(t)$ after equilibration. Estimate the time average $\\langle \\lambda \\rangle_i$ and the integrated autocorrelation time $\\tau_i$ of $\\lambda_i(t)$; then compute the standard error of the mean as $\\sigma_{\\bar{\\lambda},i} \\approx \\sqrt{\\frac{2\\,\\tau_i}{T_i}}\\,s_{\\lambda,i}$, where $s_{\\lambda,i}$ is the standard deviation of $\\lambda_i(t)$ over the production trajectory of length $T_i$. Construct the PMF by trapezoidal integration, ... and set $W(\\xi_0)=0$ or any convenient reference. Assuming statistical independence between distinct windows, propagate uncertainties as $\\sigma_{W}^2(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i^2}{4}\\left(\\sigma_{\\bar{\\lambda},i+1}^2+\\sigma_{\\bar{\\lambda},i}^2\\right)$. Validate by checking consistency of forward and backward integrations and overlap across neighboring windows.**\n\nThis option correctly identifies the data to be analyzed ($\\lambda_i(t)$) and the physical relationship $\\frac{dW}{d\\xi} = \\langle\\lambda\\rangle$. Crucially, it prescribes the correct statistical treatment for estimating the error of the mean from a correlated time series by using the integrated autocorrelation time $\\tau_i$. It uses a standard numerical integration method (trapezoidal rule). The proposed validation step is sound practice. The only identified flaw is in the error propagation formula. The given formula sums the variances of each trapezoidal segment, which incorrectly ignores the covariance between adjacent segments arising from their shared data points. This leads to an underestimation of the variance for interior points of the PMF profile. However, all other parts of the procedure are scientifically sound and represent best practices. Compared to the other options, this one is vastly superior.\n\n**Verdict: Correct.** Despite the subtle error in the variance propagation formula, this option outlines the most scientifically rigorous and practically sound procedure among the choices. The critical elements, especially the handling of autocorrelation, are correctly identified.\n\n**B. In each window, compute the instantaneous projection of the total physical force on the ion along $z$, $f_{z}(t)$, and average it to obtain $\\langle f_{z} \\rangle_i$. Estimate the error as $\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$, where $s_{f,i}$ is the standard deviation and $N_i$ is the number of saved frames, assuming independent samples. Integrate using Simpson’s rule, ... Report error bars by summing standard deviations linearly, $\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\sigma_{\\bar{f},i}$.**\n\nThis option contains multiple, severe errors.\n1.  **Error of the Mean**: It explicitly assumes independent samples ($\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$), ignoring the time correlation inherent to MD trajectories. This is a fundamental error that leads to a gross underestimation of statistical uncertainty.\n2.  **Error Propagation**: It proposes a linear sum of standard deviations, $\\sigma_W \\approx \\sum \\sigma_{\\bar{f}}$. This is mathematically incorrect. For independent variables, variances add, not standard deviations.\n3.  **Integration Method**: It proposes Simpson's rule which requires data points at mid-intervals that were not simulated, necessitating an extra interpolation step which complicates the procedure and error analysis unnecessarily.\n4.  **Source of Force**: It suggests using the physical force $f_z(t)$ instead of the provided Lagrange multiplier $\\lambda(t)$, which is a less direct approach.\n\n**Verdict: Incorrect.**\n\n**C. Run umbrella sampling with a harmonic bias $U_{\\mathrm{bias}}(\\xi)=\\tfrac{1}{2}k(\\xi-\\xi_i)^2$ in windows centered at $\\xi_i$, collect biased histograms of $\\xi$, unbias them by dividing by $\\exp[-U_{\\mathrm{bias}}(\\xi)/k_{\\mathrm{B}}T]$, and estimate the PMF as $W(\\xi)=-k_{\\mathrm{B}}T\\ln P(\\xi)+\\text{const}$. Estimate errors from histogram counting statistics as $\\sqrt{P(\\xi)}$. No constraint forces or integration of averaged forces are needed.**\n\nThis option describes a completely different and valid method (umbrella sampling) for calculating a PMF. However, the problem explicitly states that constrained MD simulations were run and the Lagrange multiplier time series $\\lambda_i(t)$ was collected. The task is to analyze *this specific data*. This option does not use the provided data or method at all.\n\n**Verdict: Incorrect.** The procedure is irrelevant to the question asked.\n\n**D. Record $\\lambda_i(t)$ in each constrained window and compute $\\langle \\lambda \\rangle_i$. Because the metric is constant, set the error of the mean to $\\sigma_{\\bar{\\lambda},i}=s_{\\lambda,i}/\\sqrt{N_i}$ without considering autocorrelation. Obtain $W(\\xi)$ by summing left-Riemann contributions, ... and propagate uncertainties by adding window-wise standard errors linearly, $\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\sigma_{\\bar{\\lambda},i}$.**\n\nThis option, like option B, contains critical flaws.\n1.  **Error of the Mean**: It incorrectly computes the standard error of the mean by ignoring autocorrelation, for the same reason as in option B. The statement about the \"constant metric\" does not justify ignoring time correlation of the observable $\\lambda(t)$.\n2.  **Error Propagation**: It proposes a weighted linear sum of standard errors. As with option B, this is a fundamental misunderstanding of error propagation.\nThe use of a left-Riemann sum is a valid, though low-accuracy, integration method, but this does not redeem the fatal flaws in the statistical analysis.\n\n**Verdict: Incorrect.**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "Molecular simulations are performed on finite systems, yet we often seek to understand macroscopic behavior, and this size discrepancy can introduce systematic errors. This is particularly true when long-range electrostatic forces are involved in ion transport. This hands-on coding exercise  demonstrates a standard and powerful technique for quantifying and correcting these finite-size artifacts by extrapolating results from several simulations to the physically relevant infinite-system limit.",
            "id": "4237613",
            "problem": "Consider a single ion constrained to move along a one-dimensional reaction coordinate $z$ within a periodic simulation cell of dimensions $L_x$, $L_y$, and $L_z$ (all in $\\mathrm{nm}$). The potential of mean force $W(z)$ is defined from first principles by the reversible work along $z$, which can be obtained by integrating the ensemble-averaged mean force $\\langle F_z(z) \\rangle$ over $z$. The periodic boundary conditions and long-range electrostatics introduce finite-size effects that bias the computed $W(z)$ away from its infinite-system limit. In many well-behaved cases, the leading finite-size bias scales linearly with the sum of inverse cell dimensions.\n\nYou will compute $W(z)$ for several finite cell sizes using a controlled synthetic mean-force model, and then extrapolate to the infinite-system limit via linear fits in the scalar $S = 1/L_x + 1/L_y + 1/L_z$. All computations must be carried out on a uniform grid $z \\in [0, Z_{\\max}]$ with $N = 101$ points.\n\nFundamental base and modeling assumptions:\n1. The potential of mean force $W(z)$ satisfies the integral definition $W(z) = W(0) + \\int_{0}^{z} \\langle F_z(z') \\rangle \\, \\mathrm{d}z'$, where $\\langle F_z(z) \\rangle$ is the ensemble-averaged mean force along $z$ and $W(0)$ is set to zero to fix the arbitrary additive constant.\n2. The synthetic infinite-system mean force is taken to be $F_{\\infty}(z) = \\Delta W \\, \\frac{\\pi}{Z_{\\max}} \\cos\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)$, which corresponds to an underlying infinite-system potential of mean force $W_{\\infty}(z) = \\Delta W \\, \\sin\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)$ with $W_{\\infty}(0) = 0$ and barrier peak at $z = Z_{\\max}/2$.\n3. The finite-size mean force is modeled as $F_{L}(z) = F_{\\infty}(z) + \\beta(z) \\, S$, where $S = 1/L_x + 1/L_y + 1/L_z$ and $\\beta(z) = K \\, \\sin\\!\\left(\\frac{2 \\pi z}{Z_{\\max}}\\right)$. This imposes a linear-in-$S$ bias of electrostatic origin in the force, which after integration yields a linear-in-$S$ bias in the potential of mean force.\n4. All energies should be expressed in kilojoules per mole ($\\mathrm{kJ/mol}$), all lengths in nanometers ($\\mathrm{nm}$), and angles implicitly in radians due to the trigonometric functions.\n\nYour program must execute the following steps:\n- Use $Z_{\\max} = 1.0 \\, \\mathrm{nm}$, $\\Delta W = 10.0 \\, \\mathrm{kJ/mol}$, $K = 2.0 \\, \\mathrm{kJ/mol}$, and a uniform grid of $N = 101$ points for $z$ between $0$ and $Z_{\\max}$ inclusive.\n- For each provided test case (each test case consists of multiple $(L_x, L_y, L_z)$ sets, each in $\\mathrm{nm}$), compute $S$ for each set, construct $F_{L}(z)$ over the grid, numerically integrate using the trapezoid rule to obtain $W_{L}(z)$ with $W_{L}(0) = 0$, and then, for each grid point $z$, perform a linear regression of $W_{L}(z)$ versus $S$ to estimate the intercept at $S=0$, which is $W_{\\infty}(z)$.\n- Let the barrier height be defined as $H = W_{\\infty}(Z_{\\max}/2) - W_{\\infty}(0)$; since $W_{\\infty}(0)=0$ by construction, this reduces to $H = W_{\\infty}(Z_{\\max}/2)$. Report $H$ in $\\mathrm{kJ/mol}$, rounded to three decimals.\n\nTest suite:\n- Case $1$ (balanced cubic boxes): $(L_x, L_y, L_z) \\in \\{(3.0,3.0,3.0), (4.0,4.0,4.0), (6.0,6.0,6.0), (8.0,8.0,8.0)\\}$.\n- Case $2$ (anisotropic, varying $L_x$): $(L_x, L_y, L_z) \\in \\{(3.0,6.0,6.0), (4.0,6.0,6.0), (8.0,6.0,6.0), (12.0,6.0,6.0)\\}$.\n- Case $3$ (edge case with very large transverse dimensions): $(L_x, L_y, L_z) \\in \\{(1000.0,1000.0,3.0), (1000.0,1000.0,4.0), (1000.0,1000.0,5.0), (1000.0,1000.0,6.0)\\}$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the barrier heights for the three cases as a comma-separated list enclosed in square brackets, e.g., $[h_1,h_2,h_3]$, where each $h_i$ is a floating-point number in $\\mathrm{kJ/mol}$ rounded to three decimals.",
            "solution": "The user-provided problem has been analyzed and is deemed valid. It is scientifically grounded in the principles of computational statistical mechanics, specifically concerning the calculation of potentials of mean force and the correction of finite-size artifacts in molecular simulations. The problem is well-posed, with all necessary parameters, models, and procedures specified unambiguously.\n\nThe objective is to determine the barrier height of an infinite-system potential of mean force (PMF), $W_{\\infty}(z)$, by extrapolating results from calculations at finite system sizes. This is a common and necessary procedure in computational chemistry and physics when dealing with long-range interactions under periodic boundary conditions.\n\nThe fundamental relationship between the PMF, $W(z)$, and the mean force, $\\langle F_z(z) \\rangle$, along a reaction coordinate $z$ is given by the integral:\n$$\nW(z) = W(z_0) + \\int_{z_0}^{z} \\langle F_z(z') \\rangle \\, \\mathrm{d}z'\n$$\nIn this problem, the reference point is set such that $z_0=0$ and $W(0)=0$.\n\nThe problem provides a synthetic model to test the extrapolation procedure. The true, infinite-system mean force is given as:\n$$\nF_{\\infty}(z) = \\Delta W \\, \\frac{\\pi}{Z_{\\max}} \\cos\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)\n$$\nwhere $\\Delta W = 10.0 \\, \\mathrm{kJ/mol}$ is the amplitude of the PMF and $Z_{\\max} = 1.0 \\, \\mathrm{nm}$ is the length of the reaction coordinate. Integrating this force from $0$ to $z$ yields the infinite-system PMF:\n$$\nW_{\\infty}(z) = \\int_{0}^{z} F_{\\infty}(z') \\, \\mathrm{d}z' = \\Delta W \\sin\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)\n$$\n\nFinite-size simulations introduce a bias. The model for the mean force in a finite system of dimensions $L_x, L_y, L_z$ is:\n$$\nF_{L}(z) = F_{\\infty}(z) + \\beta(z) S\n$$\nwhere $S$ is a scalar parameter related to the inverse system dimensions, $S = 1/L_x + 1/L_y + 1/L_z$, and the bias function $\\beta(z)$ is given by:\n$$\n\\beta(z) = K \\sin\\!\\left(\\frac{2 \\pi z}{Z_{\\max}}\\right)\n$$\nwith $K = 2.0 \\, \\mathrm{kJ/mol}$.\n\nThe PMF for the finite system, $W_L(z)$, is obtained by integrating $F_L(z)$:\n$$\nW_L(z) = \\int_{0}^{z} F_L(z') \\, \\mathrm{d}z' = \\int_{0}^{z} (F_{\\infty}(z') + \\beta(z')S) \\, \\mathrm{d}z' = W_{\\infty}(z) + S \\int_{0}^{z} \\beta(z') \\, \\mathrm{d}z'\n$$\nThis demonstrates that for a given point $z$, the calculated PMF, $W_L(z)$, is a linear function of the system size parameter $S$. The infinite-system value, $W_{\\infty}(z)$, is the intercept of this linear relationship at $S=0$.\n\nThe specified numerical procedure is as follows:\n1.  Discretize the reaction coordinate $z \\in [0, Z_{\\max}]$ into a uniform grid of $N=101$ points, denoted by $z_i$ where $i = 0, 1, \\dots, 100$. The grid spacing is $\\Delta z = Z_{\\max} / (N-1)$.\n2.  For each test case, a series of simulations with different box dimensions $(L_x, L_y, L_z)$ is provided. For each set of dimensions, calculate the corresponding $S$ value.\n3.  For each $S$ value, compute the finite-size mean force $F_L(z_i)$ at each grid point.\n4.  Numerically integrate $F_L(z)$ using the cumulative trapezoid rule to obtain the finite-size PMF profile $W_L(z_i)$. This is done by computing the sum:\n    $$\n    W_L(z_j) = \\sum_{i=1}^{j} \\frac{F_L(z_i) + F_L(z_{i-1})}{2} \\Delta z\n    $$\n    This ensures that $W_L(z_0) = W_L(0) = 0$.\n5.  For each grid point $z_i$, perform a linear regression on the collected data pairs $(S, W_L(z_i))$. The model for the regression is $W_L(z_i) = \\text{slope} \\cdot S + \\text{intercept}$. The intercept of this fit provides the extrapolated, infinite-system value $W_{\\infty}(z_i)$.\n6.  The barrier height, $H$, is defined as $H = W_{\\infty}(Z_{\\max}/2)$. The grid point corresponding to $z = Z_{\\max}/2$ is at index $i = (N-1)/2 = 50$.\n7.  The final result is the value of $W_{\\infty}(z_{50})$.\n\nCrucially, because the underlying model for $F_L(z)$ is exactly linear in $S$, and the integration and regression are deterministic numerical operations, the extrapolated profile $W_{\\infty}(z)$ will be identical for all three test cases, subject only to floating-point precision. The procedure effectively recovers the numerical integral of the pure $F_{\\infty}(z)$ component. The distinct sets of $(L_x, L_y, L_z)$ are simply different paths to the same $S=0$ limit. The numerically calculated barrier height will be a close approximation of the analytical value, which is $W_{\\infty}(Z_{\\max}/2) = \\Delta W \\sin(\\pi/2) = \\Delta W = 10.0 \\, \\mathrm{kJ/mol}$. The small difference arises from the discretization error of the trapezoid rule integration.\n\nThe implementation will now proceed according to these steps.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Computes the infinite-system PMF barrier height by extrapolating\n    from finite-size calculations based on a synthetic model.\n    \"\"\"\n    # Define the global constants and parameters from the problem statement.\n    Z_max = 1.0  # nm\n    delta_W = 10.0  # kJ/mol\n    K = 2.0  # kJ/mol\n    N = 101  # number of grid points\n\n    # Create the uniform one-dimensional grid for the reaction coordinate z.\n    z = np.linspace(0, Z_max, N)\n\n    # Define the synthetic force models as functions.\n    def F_inf(z_arr):\n        \"\"\"Infinite-system mean force.\"\"\"\n        return delta_W * (np.pi / Z_max) * np.cos(np.pi * z_arr / Z_max)\n\n    def beta(z_arr):\n        \"\"\"Finite-size bias contribution function.\"\"\"\n        return K * np.sin(2 * np.pi * z_arr / Z_max)\n\n    # Pre-calculate the force components on the grid.\n    F_inf_vals = F_inf(z)\n    beta_vals = beta(z)\n\n    # Define the test cases, each containing a series of simulation cell dimensions.\n    test_cases = [\n        # Case 1 (balanced cubic boxes)\n        [(3.0, 3.0, 3.0), (4.0, 4.0, 4.0), (6.0, 6.0, 6.0), (8.0, 8.0, 8.0)],\n        # Case 2 (anisotropic, varying Lx)\n        [(3.0, 6.0, 6.0), (4.0, 6.0, 6.0), (8.0, 6.0, 6.0), (12.0, 6.0, 6.0)],\n        # Case 3 (edge case with very large transverse dimensions)\n        [(1000.0, 1000.0, 3.0), (1000.0, 1000.0, 4.0), \n         (1000.0, 1000.0, 5.0), (1000.0, 1000.0, 6.0)],\n    ]\n\n    # A list to store the final rounded barrier height for each case.\n    results = []\n\n    # Process each test case.\n    for case in test_cases:\n        S_values = []\n        W_L_profiles = []  # List to store the PMF profile for each cell size.\n\n        # For each set of box dimensions in the current case...\n        for L_x, L_y, L_z in case:\n            # 1. Compute the system size parameter S.\n            S = 1.0 / L_x + 1.0 / L_y + 1.0 / L_z\n            S_values.append(S)\n\n            # 2. Construct the total finite-size mean force F_L(z).\n            F_L_vals = F_inf_vals + beta_vals * S\n            \n            # 3. Numerically integrate F_L(z) to get W_L(z) using the trapezoid rule.\n            # The 'initial=0' argument ensures W_L(0) = 0.\n            W_L_vals = cumulative_trapezoid(F_L_vals, z, initial=0)\n            W_L_profiles.append(W_L_vals)\n\n        # 4. Perform linear regression for each grid point to find W_infinity(z).\n        # We have a set of W_L(z_i) and S values. We need to find the intercept\n        # of the W_L(z_i) vs. S plot for each z_i.\n\n        # Transpose the list of profiles into an array where each row corresponds\n        # to a z-point and columns correspond to different S values.\n        W_L_by_z = np.array(W_L_profiles).T\n\n        # Array to store the extrapolated infinite-system PMF.\n        W_inf_extrapolated = np.zeros(N)\n\n        for i in range(N):\n            # Use np.polyfit for linear regression: W_L(z_i) = slope * S + intercept.\n            # polyfit returns [slope, intercept] for degree 1.\n            coefficients = np.polyfit(S_values, W_L_by_z[i], 1)\n            # The intercept is the extrapolated value at S=0, which is W_infinity(z_i).\n            W_inf_extrapolated[i] = coefficients[1]\n\n        # 5. Determine the barrier height.\n        # The barrier is at z = Z_max / 2.\n        # The corresponding grid index is (N-1)/2.\n        mid_point_index = (N - 1) // 2\n        barrier_height = W_inf_extrapolated[mid_point_index]\n\n        # 6. Round the result to three decimal places and store it.\n        results.append(f\"{barrier_height:.3f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}