{"hands_on_practices": [{"introduction": "The Resolution of the Identity approximation is fundamentally a least-squares fitting problem cast in a specific function space. This exercise provides a hands-on walk-through of the core mathematical machinery, demonstrating how the optimal fitting coefficients are determined by minimizing the residual error. By working through a concrete, albeit hypothetical, numerical example with both the overlap and Coulomb metrics, you will derive the normal equations from first principles and see how the choice of metric directly influences the resulting fit and its associated error [@problem_id:2802051].", "problem": "Consider a resolution-of-the-identity (RI) density fitting (DF) approximation of the product density $\\,\\rho(\\mathbf{r}) = \\varphi_{1}(\\mathbf{r})\\,\\varphi_{2}(\\mathbf{r})\\,$ in an auxiliary basis $\\{\\chi_{P}(\\mathbf{r})\\}_{P=1}^{2}$. Let the approximation be $\\tilde{\\rho}(\\mathbf{r}) = \\sum_{P=1}^{2} c_{P}\\,\\chi_{P}(\\mathbf{r})$, where the coefficients $\\{c_{P}\\}$ are determined by minimizing the squared norm of the residual with respect to a positive-definite bilinear form $(\\cdot|\\cdot)_{M}$ that defines an inner product on functions. Two metrics are considered:\n\n1. The overlap metric, with $(f|g)_{S} = \\int f(\\mathbf{r})\\,g(\\mathbf{r})\\,\\mathrm{d}\\mathbf{r}$.\n2. The Coulomb metric, with $(f|g)_{J} = \\int\\int f(\\mathbf{r})\\,|\\mathbf{r}-\\mathbf{r}'|^{-1}\\,g(\\mathbf{r}')\\,\\mathrm{d}\\mathbf{r}\\,\\mathrm{d}\\mathbf{r}'$.\n\nLet the metric matrices in the auxiliary basis, the projection vectors of $\\rho$ onto the auxiliary basis, and the self-inner products of $\\rho$ be given by\n$$\n\\mathbf{S} \\equiv \\big[(\\chi_{P}|\\chi_{Q})_{S}\\big] =\n\\begin{pmatrix}\n1  \\tfrac{1}{5} \\\\\n\\tfrac{1}{5}  \\tfrac{4}{5}\n\\end{pmatrix},\\qquad\n\\mathbf{J} \\equiv \\big[(\\chi_{P}|\\chi_{Q})_{J}\\big] =\n\\begin{pmatrix}\n\\tfrac{3}{2}  \\tfrac{3}{10} \\\\\n\\tfrac{3}{10}  \\tfrac{6}{5}\n\\end{pmatrix},\n$$\n$$\n\\mathbf{d}_{S} \\equiv \\big[(\\chi_{P}|\\rho)_{S}\\big] =\n\\begin{pmatrix}\n\\tfrac{1}{2} \\\\ \\tfrac{1}{10}\n\\end{pmatrix},\\qquad\n\\mathbf{d}_{J} \\equiv \\big[(\\chi_{P}|\\rho)_{J}\\big] =\n\\begin{pmatrix}\n\\tfrac{3}{5} \\\\ \\tfrac{1}{20}\n\\end{pmatrix},\n$$\n$$\nt_{S} \\equiv (\\rho|\\rho)_{S} = \\tfrac{2}{5},\\qquad\nt_{J} \\equiv (\\rho|\\rho)_{J} = \\tfrac{11}{20}.\n$$\n\nStarting from the definition of least-squares minimization in an inner-product space, derive the normal equations for the optimal DF coefficients in each metric and obtain the corresponding optimal coefficients $\\mathbf{c}_{S}$ and $\\mathbf{c}_{J}$. Using only first principles from variational minimization and inner products, derive an expression for the minimized squared error in each metric and evaluate these minimized squared errors from the data above. Finally, compute the ratio\n$$\nR \\equiv \\frac{\\|\\rho - \\tilde{\\rho}_{S}\\|_{S}}{\\|\\rho - \\tilde{\\rho}_{J}\\|_{J}},\n$$\nwhere $\\|\\cdot\\|_{M}$ is the norm induced by $(\\cdot|\\cdot)_{M}$, and $\\tilde{\\rho}_{S}$ and $\\tilde{\\rho}_{J}$ are the optimal DF approximations in the overlap and Coulomb metrics, respectively. Express your final answer for $R$ as an exact algebraic expression (do not decimalize and do not include units).", "solution": "We work in the Hilbert-space framework induced by a positive-definite bilinear form $(\\cdot|\\cdot)_{M}$, which defines an inner product and corresponding norm $\\|f\\|_{M} \\equiv \\sqrt{(f|f)_{M}}$. Given an auxiliary basis $\\{\\chi_{P}\\}_{P=1}^{2}$ and an approximation $\\tilde{\\rho} = \\sum_{P} c_{P}\\chi_{P}$, the squared error in metric $M$ is\n$$\nE_{M}^{2}(\\mathbf{c}) \\equiv \\|\\rho - \\tilde{\\rho}\\|_{M}^{2}\n= (\\rho - \\chi \\mathbf{c} \\,|\\, \\rho - \\chi \\mathbf{c})_{M},\n$$\nwhere $\\chi$ is the linear map from coefficient vectors to functions, $\\chi \\mathbf{c} \\equiv \\sum_{P} c_{P}\\chi_{P}$. Expanding the quadratic form using bilinearity and symmetry gives\n$$\nE_{M}^{2}(\\mathbf{c}) = (\\rho|\\rho)_{M} - 2\\,\\mathbf{c}^{\\mathsf{T}}\\mathbf{d}_{M} + \\mathbf{c}^{\\mathsf{T}}\\mathbf{M}\\,\\mathbf{c},\n$$\nwhere $\\mathbf{M}$ is the metric matrix with elements $M_{PQ} = (\\chi_{P}|\\chi_{Q})_{M}$ and $\\mathbf{d}_{M}$ is the projection vector with components $d_{M,P} = (\\chi_{P}|\\rho)_{M}$. The stationarity condition for the least-squares minimizer is obtained by setting the gradient with respect to $\\mathbf{c}$ to zero:\n$$\n\\frac{\\partial E_{M}^{2}}{\\partial \\mathbf{c}} = -2\\,\\mathbf{d}_{M} + 2\\,\\mathbf{M}\\,\\mathbf{c} = \\mathbf{0}\n\\quad\\Longrightarrow\\quad\n\\mathbf{M}\\,\\mathbf{c} = \\mathbf{d}_{M}.\n$$\nThese are the normal equations. Since $\\mathbf{M}$ is symmetric positive definite, the unique minimizer is\n$$\n\\mathbf{c}_{M} = \\mathbf{M}^{-1}\\mathbf{d}_{M}.\n$$\nAt the minimizer, substituting $\\mathbf{c}_{M}$ back into the quadratic form yields the minimized squared error:\n$$\nE_{M,\\min}^{2} = (\\rho|\\rho)_{M} - \\mathbf{d}_{M}^{\\mathsf{T}}\\mathbf{c}_{M}\n= t_{M} - \\mathbf{d}_{M}^{\\mathsf{T}}\\,\\mathbf{M}^{-1}\\mathbf{d}_{M}.\n$$\n\nWe now apply these general results to each metric.\n\nOverlap metric. Here $\\mathbf{M}=\\mathbf{S}$, $\\mathbf{d}_{M}=\\mathbf{d}_{S}$, and $t_{M}=t_{S}$. First compute $\\mathbf{S}^{-1}$. With\n$$\n\\mathbf{S} =\n\\begin{pmatrix}\n1  \\tfrac{1}{5} \\\\\n\\tfrac{1}{5}  \\tfrac{4}{5}\n\\end{pmatrix},\n\\quad\n\\det(\\mathbf{S}) = 1\\cdot\\tfrac{4}{5} - \\tfrac{1}{5}\\cdot\\tfrac{1}{5} = \\tfrac{19}{25},\n$$\nthe inverse is\n$$\n\\mathbf{S}^{-1} = \\frac{1}{\\det(\\mathbf{S})}\n\\begin{pmatrix}\n\\tfrac{4}{5}  -\\tfrac{1}{5} \\\\\n-\\tfrac{1}{5}  1\n\\end{pmatrix}\n= \\frac{25}{19}\n\\begin{pmatrix}\n\\tfrac{4}{5}  -\\tfrac{1}{5} \\\\\n-\\tfrac{1}{5}  1\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\tfrac{20}{19}  -\\tfrac{5}{19} \\\\\n-\\tfrac{5}{19}  \\tfrac{25}{19}\n\\end{pmatrix}.\n$$\nThus\n$$\n\\mathbf{c}_{S} = \\mathbf{S}^{-1}\\mathbfd_{S}\n=\n\\begin{pmatrix}\n\\tfrac{20}{19}  -\\tfrac{5}{19} \\\\\n-\\tfrac{5}{19}  \\tfrac{25}{19}\n\\end{pmatrix}\n\\begin{pmatrix}\n\\tfrac{1}{2} \\\\ \\tfrac{1}{10}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\tfrac{19}{38} \\\\ 0\n\\end{pmatrix}.\n$$\nThe minimized squared error is\n$$\nE_{S,\\min}^{2} = t_{S} - \\mathbf{d}_{S}^{\\mathsf{T}}\\,\\mathbf{c}_{S}\n= \\tfrac{2}{5} - \\left(\\tfrac{1}{2}\\cdot\\tfrac{19}{38} + \\tfrac{1}{10}\\cdot 0\\right)\n= \\tfrac{2}{5} - \\tfrac{19}{76}.\n$$\nBringing to a common denominator,\n$$\n\\tfrac{2}{5} = \\tfrac{152}{380},\\quad \\tfrac{19}{76} = \\tfrac{95}{380}\n\\;\\Longrightarrow\\;\nE_{S,\\min}^{2} = \\tfrac{152}{380} - \\tfrac{95}{380} = \\tfrac{57}{380} = \\tfrac{3}{20}.\n$$\n\nCoulomb metric. Here $\\mathbf{M}=\\mathbf{J}$, $\\mathbf{d}_{M}=\\mathbf{d}_{J}$, and $t_{M}=t_{J}$. Compute $\\mathbf{J}^{-1}$. With\n$$\n\\mathbf{J} =\n\\begin{pmatrix}\n\\tfrac{3}{2}  \\tfrac{3}{10} \\\\\n\\tfrac{3}{10}  \\tfrac{6}{5}\n\\end{pmatrix},\n\\quad\n\\det(\\mathbf{J}) = \\tfrac{3}{2}\\cdot\\tfrac{6}{5} - \\left(\\tfrac{3}{10}\\right)^{2}\n= \\tfrac{18}{10} - \\tfrac{9}{100} = \\tfrac{171}{100},\n$$\nthe inverse is\n$$\n\\mathbf{J}^{-1} = \\frac{1}{\\det(\\mathbf{J})}\n\\begin{pmatrix}\n\\tfrac{6}{5}  -\\tfrac{3}{10} \\\\\n-\\tfrac{3}{10}  \\tfrac{3}{2}\n\\end{pmatrix}\n= \\frac{100}{171}\n\\begin{pmatrix}\n\\tfrac{6}{5}  -\\tfrac{3}{10} \\\\\n-\\tfrac{3}{10}  \\tfrac{3}{2}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\tfrac{40}{57}  -\\tfrac{10}{57} \\\\\n-\\tfrac{10}{57}  \\tfrac{50}{57}\n\\end{pmatrix}.\n$$\nThus\n$$\n\\mathbf{c}_{J} = \\mathbf{J}^{-1}\\mathbf{d}_{J}\n=\n\\begin{pmatrix}\n\\tfrac{40}{57}  -\\tfrac{10}{57} \\\\\n-\\tfrac{10}{57}  \\tfrac{50}{57}\n\\end{pmatrix}\n\\begin{pmatrix}\n\\tfrac{3}{5} \\\\ \\tfrac{1}{20}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n\\tfrac{47}{114} \\\\ -\\tfrac{7}{114}\n\\end{pmatrix}.\n$$\nThe minimized squared error is\n$$\nE_{J,\\min}^{2} = t_{J} - \\mathbf{d}_{J}^{\\mathsf{T}}\\,\\mathbf{c}_{J}\n= \\tfrac{11}{20} - \\left(\\tfrac{3}{5}\\cdot\\tfrac{47}{114} + \\tfrac{1}{20}\\cdot\\left(-\\tfrac{7}{114}\\right)\\right).\n$$\nCompute the dot product:\n$$\n\\tfrac{3}{5}\\cdot\\tfrac{47}{114} = \\tfrac{141}{570} = \\tfrac{47}{190},\\qquad\n\\tfrac{1}{20}\\cdot\\left(-\\tfrac{7}{114}\\right) = -\\tfrac{7}{2280},\n$$\nso\n$$\n\\mathbf{d}_{J}^{\\mathsf{T}}\\,\\mathbf{c}_{J} = \\tfrac{47}{190} - \\tfrac{7}{2280}\n= \\frac{47\\cdot 12}{2280} - \\frac{7}{2280} = \\frac{564 - 7}{2280} = \\frac{557}{2280}.\n$$\nTherefore,\n$$\nE_{J,\\min}^{2} = \\tfrac{11}{20} - \\tfrac{557}{2280}\n= \\frac{11\\cdot 114}{2280} - \\frac{557}{2280}\n= \\frac{1254 - 557}{2280} = \\frac{697}{2280}.\n$$\n\nThe requested ratio of error norms is\n$$\nR \\equiv \\frac{\\|\\rho - \\tilde{\\rho}_{S}\\|_{S}}{\\|\\rho - \\tilde{\\rho}_{J}\\|_{J}}\n= \\sqrt{\\frac{E_{S,\\min}^{2}}{E_{J,\\min}^{2}}}\n= \\sqrt{\\frac{\\tfrac{3}{20}}{\\tfrac{697}{2280}}}\n= \\sqrt{\\frac{3}{20}\\cdot\\frac{2280}{697}}\n= \\sqrt{\\frac{6840}{13940}}\n= \\sqrt{\\frac{342}{697}}.\n$$\nThis is already in exact simplified algebraic form.", "answer": "$$\\boxed{\\sqrt{\\frac{342}{697}}}$$", "id": "2802051"}, {"introduction": "While the overlap metric offers a mathematically simpler path for density fitting, the choice of metric has critical physical consequences. An ideal fitting procedure should not introduce unphysical artifacts, such as underestimating the inherently positive-definite Hartree self-repulsion energy. This practice asks you to construct an explicit counterexample using a simplified but physically plausible model, demonstrating how overlap-metric fitting can indeed fail this crucial test and underscoring the theoretical motivation for using the more robust Coulomb metric [@problem_id:2802034].", "problem": "In resolution of the identity (RI) and density fitting (DF) approximations to the Coulomb (Hartree) energy in electronic structure theory, one may choose the overlap metric or the Coulomb metric to fit densities in an auxiliary basis. Consider two real, orthonormal, and spatially well-separated molecular orbitals, denoted by $\\chi_{a}(\\mathbf{r})$ and $\\chi_{b}(\\mathbf{r})$, each occupied by one electron. The target electron density is $\\rho(\\mathbf{r}) = \\chi_{a}(\\mathbf{r})^{2} + \\chi_{b}(\\mathbf{r})^{2}$. The Hartree energy is defined from first principles by\n$$\nJ[\\rho] = \\frac{1}{2} \\iint \\frac{\\rho(\\mathbf{r})\\,\\rho(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}'.\n$$\nYou are given the following precomputed, physically plausible integrals:\n- Overlap inner products of densities (the $L^{2}$ metric): $\\int \\chi_{a}(\\mathbf{r})^{4}\\, d\\mathbf{r} = 0.80$, $\\int \\chi_{b}(\\mathbf{r})^{4}\\, d\\mathbf{r} = 0.70$, and the cross term $\\int \\chi_{a}(\\mathbf{r})^{2}\\,\\chi_{b}(\\mathbf{r})^{2}\\, d\\mathbf{r} = 0.05$.\n- Coulomb inner products (the Coulomb metric): $(aa|aa) = \\iint \\frac{\\chi_{a}(\\mathbf{r})^{2}\\,\\chi_{a}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}' = 1.20$, $(bb|bb) = 0.80$, and $(aa|bb) = \\iint \\frac{\\chi_{a}(\\mathbf{r})^{2}\\,\\chi_{b}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}' = 0.05$. All Coulomb integrals are given in Hartree units $(E_{h})$.\n\nSuppose the auxiliary basis for DF consists of a single function $b_{1}(\\mathbf{r}) = \\chi_{a}(\\mathbf{r})^{2}$. In the overlap-metric DF, the fitted density is $\\rho_{\\text{fit}}(\\mathbf{r}) = c\\, b_{1}(\\mathbf{r})$, where the coefficient $c$ is chosen to minimize the squared error in the overlap metric, that is, to minimize $\\int \\left(\\rho(\\mathbf{r}) - c\\,b_{1}(\\mathbf{r})\\right)^{2}\\, d\\mathbf{r}$. The DF Hartree energy is then computed by inserting $\\rho_{\\text{fit}}$ into the Hartree functional:\n$$\nJ_{\\text{DF}} = \\frac{1}{2} \\iint \\frac{\\rho_{\\text{fit}}(\\mathbf{r})\\,\\rho_{\\text{fit}}(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}'.\n$$\n\nUsing only the given data and first-principles definitions, construct this explicit counterexample showing that overlap-metric DF underestimates the Hartree energy, and quantify the discrepancy\n$$\n\\Delta J \\equiv J_{\\text{DF}} - J_{\\text{exact}},\n$$\nwhere $J_{\\text{exact}} \\equiv J[\\rho]$. Provide $\\Delta J$ as a single real number. Round your final numeric answer to four significant figures. Express energies in Hartree units $(E_{h})$.", "solution": "The task is to compute the discrepancy $\\Delta J = J_{\\text{DF}} - J_{\\text{exact}}$. This requires the separate calculation of the exact Hartree energy, $J_{\\text{exact}}$, and the density-fitted Hartree energy, $J_{\\text{DF}}$.\n\nFirst, we calculate the exact Hartree energy, $J_{\\text{exact}}$.\nThe exact density is given as $\\rho(\\mathbf{r}) = \\chi_{a}(\\mathbf{r})^{2} + \\chi_{b}(\\mathbf{r})^{2}$. Substituting this into the Hartree energy functional:\n$$\nJ_{\\text{exact}} = \\frac{1}{2} \\iint \\frac{\\left(\\chi_{a}(\\mathbf{r})^{2} + \\chi_{b}(\\mathbf{r})^{2}\\right)\\left(\\chi_{a}(\\mathbf{r}')^{2} + \\chi_{b}(\\mathbf{r}')^{2}\\right)}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}'\n$$\nExpanding the product in the numerator yields four terms:\n$$\nJ_{\\text{exact}} = \\frac{1}{2} \\left[ \\iint \\frac{\\chi_{a}(\\mathbf{r})^{2}\\chi_{a}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}d\\mathbf{r}' + \\iint \\frac{\\chi_{a}(\\mathbf{r})^{2}\\chi_{b}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}d\\mathbf{r}' + \\iint \\frac{\\chi_{b}(\\mathbf{r})^{2}\\chi_{a}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}d\\mathbf{r}' + \\iint \\frac{\\chi_{b}(\\mathbf{r})^{2}\\chi_{b}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}d\\mathbf{r}' \\right]\n$$\nThese integrals correspond to the provided Coulomb integrals. Using the standard notation $(ij|kl) = \\iint \\frac{\\chi_i(\\mathbf{r})\\chi_j(\\mathbf{r})\\chi_k(\\mathbf{r}')\\chi_l(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}d\\mathbf{r}'$, the expression for $J_{\\text{exact}}$ becomes:\n$$\nJ_{\\text{exact}} = \\frac{1}{2} \\left[ (aa|aa) + (aa|bb) + (bb|aa) + (bb|bb) \\right]\n$$\nSince the orbitals are real, the integral is symmetric with respect to swapping indices before and after the bar, i.e., $(bb|aa) = (aa|bb)$. Therefore:\n$$\nJ_{\\text{exact}} = \\frac{1}{2} \\left[ (aa|aa) + 2(aa|bb) + (bb|bb) \\right]\n$$\nSubstituting the given numerical values:\n$$\nJ_{\\text{exact}} = \\frac{1}{2} \\left[ 1.20 + 2(0.05) + 0.80 \\right] = \\frac{1}{2} \\left[ 1.20 + 0.10 + 0.80 \\right] = \\frac{1}{2} (2.10) = 1.05 \\, E_h\n$$\nNext, we determine the density-fitted energy, $J_{\\text{DF}}$. This first requires finding the coefficient $c$ for the fitted density $\\rho_{\\text{fit}}(\\mathbf{r}) = c\\,b_{1}(\\mathbf{r})$. The coefficient $c$ is determined by minimizing the squared error in the overlap metric:\n$$\nE[c] = \\int \\left(\\rho(\\mathbf{r}) - \\rho_{\\text{fit}}(\\mathbf{r})\\right)^{2}\\, d\\mathbf{r} = \\int \\left(\\rho(\\mathbf{r}) - c\\,b_{1}(\\mathbf{r})\\right)^{2}\\, d\\mathbf{r}\n$$\nTo find the minimum, we set the derivative with respect to $c$ to zero:\n$$\n\\frac{dE}{dc} = \\int 2\\left(\\rho(\\mathbf{r}) - c\\,b_{1}(\\mathbf{r})\\right)(-b_{1}(\\mathbf{r}))\\, d\\mathbf{r} = 0\n$$\n$$\n-2 \\int \\rho(\\mathbf{r})\\,b_{1}(\\mathbf{r})\\, d\\mathbf{r} + 2c \\int b_{1}(\\mathbf{r})^{2}\\, d\\mathbf{r} = 0\n$$\nSolving for $c$ yields the standard least-squares solution:\n$$\nc = \\frac{\\int \\rho(\\mathbf{r})\\,b_{1}(\\mathbf{r})\\, d\\mathbf{r}}{\\int b_{1}(\\mathbf{r})^{2}\\, d\\mathbf{r}}\n$$\nWe compute the numerator and denominator separately. The auxiliary function is $b_{1}(\\mathbf{r}) = \\chi_{a}(\\mathbf{r})^{2}$.\nThe denominator is:\n$$\n\\int b_{1}(\\mathbf{r})^{2}\\, d\\mathbf{r} = \\int \\left(\\chi_{a}(\\mathbf{r})^{2}\\right)^{2}\\, d\\mathbf{r} = \\int \\chi_{a}(\\mathbf{r})^{4}\\, d\\mathbf{r} = 0.80\n$$\nThe numerator is, substituting $\\rho(\\mathbf{r}) = \\chi_{a}(\\mathbf{r})^{2} + \\chi_{b}(\\mathbf{r})^{2}$:\n$$\n\\int \\rho(\\mathbf{r})\\,b_{1}(\\mathbf{r})\\, d\\mathbf{r} = \\int \\left(\\chi_{a}(\\mathbf{r})^{2} + \\chi_{b}(\\mathbf{r})^{2}\\right)\\chi_{a}(\\mathbf{r})^{2}\\, d\\mathbf{r} = \\int \\chi_{a}(\\mathbf{r})^{4}\\, d\\mathbf{r} + \\int \\chi_{a}(\\mathbf{r})^{2}\\chi_{b}(\\mathbf{r})^{2}\\, d\\mathbf{r}\n$$\nUsing the provided overlap integrals:\n$$\n\\int \\rho(\\mathbf{r})\\,b_{1}(\\mathbf{r})\\, d\\mathbf{r} = 0.80 + 0.05 = 0.85\n$$\nNow we compute the coefficient $c$:\n$$\nc = \\frac{0.85}{0.80} = \\frac{17}{16} = 1.0625\n$$\nThe fitted density is $\\rho_{\\text{fit}}(\\mathbf{r}) = 1.0625\\, \\chi_{a}(\\mathbf{r})^{2}$. We now compute $J_{\\text{DF}}$ using this fitted density:\n$$\nJ_{\\text{DF}} = \\frac{1}{2} \\iint \\frac{\\rho_{\\text{fit}}(\\mathbf{r})\\,\\rho_{\\text{fit}}(\\mathbf{r}')}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}' = \\frac{1}{2} \\iint \\frac{\\left(c\\,\\chi_{a}(\\mathbf{r})^{2}\\right)\\left(c\\,\\chi_{a}(\\mathbf{r}')^{2}\\right)}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}'\n$$\n$$\nJ_{\\text{DF}} = \\frac{c^{2}}{2} \\iint \\frac{\\chi_{a}(\\mathbf{r})^{2}\\chi_{a}(\\mathbf{r}')^{2}}{|\\mathbf{r}-\\mathbf{r}'|}\\, d\\mathbf{r}\\, d\\mathbf{r}' = \\frac{c^{2}}{2} (aa|aa)\n$$\nSubstituting the values for $c$ and $(aa|aa)$:\n$$\nJ_{\\text{DF}} = \\frac{(1.0625)^{2}}{2} (1.20) = (1.0625)^{2} (0.60)\n$$\n$$\nJ_{\\text{DF}} = (1.12890625) \\times (0.60) = 0.67734375 \\, E_h\n$$\nFinally, we compute the discrepancy $\\Delta J$:\n$$\n\\Delta J = J_{\\text{DF}} - J_{\\text{exact}} = 0.67734375 - 1.05 = -0.37265625 \\, E_h\n$$\nThe problem requires the answer to be rounded to four significant figures.\n$$\n\\Delta J \\approx -0.3727 \\, E_h\n$$\nThe negative sign confirms that in this constructed example, overlap-metric density fitting underestimates the true Hartree energy.", "answer": "$$\n\\boxed{-0.3727}\n$$", "id": "2802034"}, {"introduction": "Translating the formal equations of density fitting into a high-performance computer program requires careful consideration of data movement and algorithm design. The central computational task involves a massive contraction of a three-index tensor with a density matrix, where the three-index tensor is too large to fit in memory. This exercise challenges you to think like a quantum chemistry software developer, analyzing different algorithmic strategies to identify the one that minimizes memory traffic and maximizes data reuse, which are the keys to an efficient implementation [@problem_id:2802080].", "problem": "In density-fitted Resolution of the Identity for Coulomb-type contractions, let $B_{\\lambda\\sigma,Q}$ denote three-center integrals contracted with the inverse square root of the auxiliary metric, $D_{\\lambda\\sigma}$ a general real symmetric atomic-orbital density matrix, and $b_Q$ the contracted auxiliary-space vector defined by\n$$\nb_Q \\;=\\; \\sum_{\\lambda}\\sum_{\\sigma} B_{\\lambda\\sigma,Q}\\,D_{\\lambda\\sigma}\\,.\n$$\nAssume the following fundamental constraints and capabilities that are standard in practical electronic structure implementations:\n1) The full three-index tensor $B_{\\lambda\\sigma,Q}$ is too large to store. An integral engine generates on-the-fly blocks $B_{\\Lambda\\Sigma,Q_T}$ for a chosen atomic-orbital shell-pair block $(\\Lambda,\\Sigma)$ and a chosen auxiliary tile $Q_T\\subset\\{1,\\dots,N_{\\mathrm{aux}}\\}$, where $|\\Lambda||\\Sigma||Q_T|$ fits in cache. The indices $\\lambda\\in\\Lambda$, $\\sigma\\in\\Sigma$, $Q\\in Q_T$.\n2) The density matrix $D_{\\lambda\\sigma}$ is dense and symmetric, $D_{\\lambda\\sigma}=D_{\\sigma\\lambda}$, and can be accessed efficiently by shell pairs. You may exploit the symmetry of both $D_{\\lambda\\sigma}$ and $B_{\\lambda\\sigma,Q}=B_{\\sigma\\lambda,Q}$ over the atomic-orbital pair indices.\n3) The global accumulator $b_Q$ of length $N_{\\mathrm{aux}}$ cannot remain entirely in cache, but a tile $b_{Q_T}$ can. Multiple threads are available; synchronization is expensive.\n4) To leading order in data movement, memory traffic is dominated by loads of $D_{\\lambda\\sigma}$ and stores to $b_Q$. Three-center blocks $B_{\\Lambda\\Sigma,Q_T}$ are produced and consumed on-the-fly and need not be written to main memory.\n\nStarting only from the definition of $b_Q$ and the above constraints, one wishes to design a blocked contraction that maximizes reuse of the on-the-fly atomic-orbital-to-auxiliary intermediates and minimizes memory traffic, quantified as total main-memory words transferred for $D_{\\lambda\\sigma}$ and $b_Q$.\n\nWhich of the following algorithmic designs best achieves this objective under the stated constraints? Select the single best option.\n\nA) Tile-first auxiliary accumulation with thread-private buffers and symmetry reduction. Partition auxiliary indices into tiles $Q_T$ of size $|Q_T|$ that fit in cache. For each thread and for each $Q_T$, zero a thread-private buffer $b_{Q_T}^{\\mathrm{(priv)}}$. Loop over screened atomic-orbital shell pairs $(\\Lambda,\\Sigma)$ restricted to $\\lambda\\ge\\sigma$; for each shell pair, request $B_{\\Lambda\\Sigma,Q_T}$ from the integral engine, load the corresponding $D_{\\Lambda\\Sigma}$ block once, and perform the fused update\n$$\nb_{Q_T}^{\\mathrm{(priv)}} \\mathrel{+}= \\sum_{\\lambda\\in\\Lambda}\\sum_{\\sigma\\in\\Sigma,\\;\\lambda\\ge\\sigma} (2-\\delta_{\\lambda\\sigma})\\, B_{\\lambda\\sigma,Q_T}\\, D_{\\lambda\\sigma},\n$$\nconsuming $B_{\\Lambda\\Sigma,Q_T}$ immediately and discarding it. After finishing all $(\\Lambda,\\Sigma)$ for this $Q_T$, reduce $b_{Q_T}^{\\mathrm{(priv)}}$ into the global $b_{Q_T}$ once. Proceed tile by tile over $Q_T$.\n\nB) Two-stage columnwise intermediate over atomic-orbital index with global write-back. Partition $\\sigma$ into blocks $\\Sigma$. For each $\\Sigma$ and for each auxiliary tile $Q_T$, form and write a large intermediate\n$$\nT_{\\Sigma,Q_T} \\;=\\; \\sum_{\\lambda} B_{\\lambda\\Sigma,Q_T}\\, D_{\\lambda\\Sigma},\n$$\nstoring it to main memory. After all $\\lambda$ are processed, read back $T_{\\Sigma,Q_T}$ and accumulate $b_{Q_T}\\mathrel{+}= \\sum_{\\sigma\\in\\Sigma} T_{\\sigma,Q_T}$.\n\nC) Auxiliary-major loop with global accumulator and per-pair atomic updates. Loop over auxiliary tiles $Q_T$. For each $Q_T$, loop over all atomic-orbital shell pairs $(\\Lambda,\\Sigma)$, generate $B_{\\Lambda\\Sigma,Q_T}$, load $D_{\\Lambda\\Sigma}$, and update the single shared global $b_{Q_T}$ directly as\n$$\nb_{Q_T} \\mathrel{+}= \\sum_{\\lambda\\in\\Lambda}\\sum_{\\sigma\\in\\Sigma} B_{\\lambda\\sigma,Q_T}\\, D_{\\lambda\\sigma},\n$$\nusing atomic additions to avoid race conditions among threads.\n\nD) Full-auxiliary accumulation without tiling. Loop once over all $(\\Lambda,\\Sigma)$; for each shell pair, generate $B_{\\Lambda\\Sigma,Q}$ for the full auxiliary space $Q=\\{1,\\dots,N_{\\mathrm{aux}}\\}$, load $D_{\\Lambda\\Sigma}$, and directly accumulate into the full $b_Q$ vector held in main memory, relying on hardware prefetching to hide memory latency.", "solution": "The problem asks for the most efficient algorithmic design to compute the auxiliary-space vector $b_Q$ defined by the contraction:\n$$\nb_Q \\;=\\; \\sum_{\\lambda}\\sum_{\\sigma} B_{\\lambda\\sigma,Q}\\,D_{\\lambda\\sigma}\n$$\nThe objective is to minimize main-memory traffic, defined as the total words loaded for the dense symmetric density matrix $D_{\\lambda\\sigma}$ and loaded/stored for the accumulator vector $b_Q$. The three-center integral tensor $B_{\\lambda\\sigma,Q}$ is generated on-the-fly in cache-fitting blocks $B_{\\Lambda\\Sigma,Q_T}$. We must respect all stated constraints regarding memory hierarchy, data access patterns, and parallel execution.\n\nThe core of the problem is a trade-off in data reuse, determined by the ordering of the loops over atomic-orbital (AO) shell pairs $(\\Lambda, \\Sigma)$ and auxiliary-function tiles $Q_T$. The total number of floating-point operations is fixed by the mathematical expression, so performance is dictated by data movement. Let $N_{\\mathrm{AO}}$ be the number of AO basis functions, $N_{\\mathrm{sh}}$ be the number of shells, $N_{\\mathrm{aux}}$ be the number of auxiliary basis functions, and $|Q_T|$ be the size of an auxiliary tile. The sizes of the primary data structures in main memory are $O(N_{\\mathrm{AO}}^2)$ for $D$ and $O(N_{\\mathrm{aux}})$ for $b$.\n\nWe analyze the two fundamental loop orderings.\n\n1.  **AO-Pair-Major Loop Ordering**: The outer loop iterates over shell pairs $(\\Lambda, \\Sigma)$, and the inner loop iterates over auxiliary tiles $Q_T$.\n    The structure is: `for each pair $(\\Lambda, \\Sigma)$ do ...`\n    - Load the density block $D_{\\Lambda\\Sigma}$ once. This minimizes the total loads for $D$ to a single pass over the matrix, which is optimal. Total traffic for $D$: approximately $N_{\\mathrm{AO}}^2/2$ words.\n    - `for each tile $Q_T$ do ...`\n        - Generate the integral block $B_{\\Lambda\\Sigma,Q_T}$.\n        - Compute the partial contribution for this tile.\n        - Load the accumulator tile $b_{Q_T}$, add the contribution, and store it back.\n    - This update to $b_{Q_T}$ must be performed for every pair $(\\Lambda, \\Sigma)$. The total traffic on the accumulator $b$ is therefore approximately $N_{\\mathrm{shpair}} \\times 2 \\times N_{\\mathrm{aux}}$, where $N_{\\mathrm{shpair}} \\approx N_{\\mathrm{sh}}^2/2$ is the number of unique shell pairs. Given that $N_{\\mathrm{sh}}$ is proportional to $N_{\\mathrm{AO}}$, this traffic scales as $O(N_{\\mathrm{AO}}^2 N_{\\mathrm{aux}})$, which is catastrophically large. This approach reuses $D$ perfectly but thrashes the accumulator $b$ in main memory.\n\n2.  **Auxiliary-Major Loop Ordering**: The outer loop iterates over auxiliary tiles $Q_T$, and the inner loop iterates over shell pairs $(\\Lambda, \\Sigma)$.\n    The structure is: `for each tile $Q_T$ do ...`\n    - Load the accumulator tile $b_{Q_T}$ into a cache-resident buffer. For parallel execution, each thread would use a private buffer $b_{Q_T}^{\\mathrm{(priv)}}$. This tile is loaded once.\n    - `for each pair $(\\Lambda, \\Sigma)$ do ...`\n        - Load the density block $D_{\\Lambda\\Sigma}$.\n        - Generate the integral block $B_{\\Lambda\\Sigma,Q_T}$.\n        - Compute the contribution and add it to the buffer $b_{Q_T}^{\\mathrm{(priv)}}$.\n    - After the inner loop over all pairs is complete, the thread-private buffer is reduced (e.g., added) into the global accumulator tile $b_{Q_T}$, which is then stored back to main memory.\n    - Traffic on the accumulator $b$: For each tile $Q_T$, we perform one load and one store (per thread, followed by a final reduction). The total traffic is thus of order $O(N_{\\mathrm{aux}})$. This is optimal for $b$.\n    - Traffic on the density matrix $D$: The entire density matrix must be read from main memory for *each* auxiliary tile $Q_T$. The total traffic for $D$ is approximately $N_{Q_T} \\times (N_{\\mathrm{AO}}^2/2) = (N_{\\mathrm{aux}} / |Q_T|) \\times (N_{\\mathrm{AO}}^2/2)$. This is significant but must be compared to the alternative.\n\n**Comparison of Traffic Costs**:\nLet $T_{AO-major}$ and $T_{Aux-major}$ be the dominant traffic terms.\n$T_{AO-major} \\approx (N_{\\mathrm{sh}}^2/2) \\times 2 N_{\\mathrm{aux}} \\approx (N_{\\mathrm{AO}}/\\bar{n})^2 N_{\\mathrm{aux}}$, where $\\bar{n}$ is the average number of functions per shell.\n$T_{Aux-major} \\approx (N_{\\mathrm{aux}} / |Q_T|) \\times (N_{\\mathrm{AO}}^2/2)$.\nThe ratio is $T_{AO-major} / T_{Aux-major} \\approx \\frac{(N_{\\mathrm{AO}}^2/\\bar{n}^2) N_{\\mathrm{aux}}}{(N_{\\mathrm{aux}}/|Q_T|) (N_{\\mathrm{AO}}^2/2)} = \\frac{2|Q_T|}{\\bar{n}^2}$.\nWith typical parameters where the cache-resident tile size $|Q_T|$ is in the thousands and $\\bar{n}^2$ is small (e.g., $10-100$), this ratio is much greater than $1$. Therefore, the AO-pair-major approach generates vastly more memory traffic. The auxiliary-major loop order is the superior strategy.\n\nNow we shall evaluate each option based on this analysis.\n\nA) This option describes the **auxiliary-major loop ordering**. It correctly identifies the need to tile the auxiliary dimension and make it the outer loop (`for each Q_T`). It proposes using thread-private buffers ($b_{Q_T}^{\\mathrm{(priv)}}$) to accumulate results for a tile, which is the correct way to manage parallel updates and avoid the high cost of synchronization (Constraint $3$). The final reduction into the global accumulator $b_{Q_T}$ minimizes traffic and write-contention for $b_Q$. The algorithm correctly utilizes symmetry with the $(2-\\delta_{\\lambda\\sigma})$ factor. While this approach re-reads the density matrix $D_{\\lambda\\sigma}$ for each auxiliary tile, our analysis shows this is the correct trade-off, leading to far less total memory traffic than the alternative of repeatedly updating the full $b_Q$ vector. This design is sound and practical.\nVerdict: **Correct**.\n\nB) This option proposes a **two-stage algorithm** that materializes a large intermediate tensor $T_{\\Sigma,Q_T}$. The full intermediate $T_{\\sigma,Q}$ would have dimensions $N_{\\mathrm{AO}} \\times N_{\\mathrm{aux}}$, which is an enormous memory requirement, often larger than the available main memory. Storing this intermediate to main memory and then reading it back, as the option suggests, constitutes massive memory traffic ($2 \\times N_{\\mathrm{AO}} \\times N_{\\mathrm{aux}}$ words). This contradicts the objective of minimizing memory traffic and the on-the-fly nature of modern electronic structure codes. This approach is grossly inefficient in terms of both memory footprint and traffic.\nVerdict: **Incorrect**.\n\nC) This option describes the **auxiliary-major loop ordering**, same as in option A. However, for parallel updates, it proposes using **atomic additions** directly to the single shared global accumulator $b_{Q_T}$. Atomic operations are a form of synchronization, which the problem explicitly states is expensive (Constraint $3$). In a loop over millions of shell pairs, having multiple threads constantly contending for atomic access to the same few memory locations in $b_{Q_T}$ would create a severe performance bottleneck, effectively serializing the computation and defeating the purpose of multithreading. The use of thread-private buffers as in option A is a vastly superior method for parallel accumulation.\nVerdict: **Incorrect**.\n\nD) This option describes the **AO-pair-major loop ordering**. As shown in our fundamental analysis, this leads to catastrophic memory traffic on the accumulator $b_Q$, requiring $O(N_{\\mathrm{shpair}})$ passes over the entire $b_Q$ vector, which resides in main memory. The suggestion to rely on hardware prefetching is computationally naive; prefetchers cannot overcome the bandwidth limitations imposed by such a traffic pattern. Furthermore, by proposing to generate $B_{\\Lambda\\Sigma,Q}$ for the *full* auxiliary space at once, this option may violate Constraint $1$, which states that only a tiled block $B_{\\Lambda\\Sigma,Q_T}$ is guaranteed to fit in cache.\nVerdict: **Incorrect**.\n\nIn conclusion, option A presents the most competent and well-reasoned algorithmic design that correctly balances the conflicting requirements of data reuse to minimize total memory traffic under the given constraints.", "answer": "$$\\boxed{A}$$", "id": "2802080"}]}