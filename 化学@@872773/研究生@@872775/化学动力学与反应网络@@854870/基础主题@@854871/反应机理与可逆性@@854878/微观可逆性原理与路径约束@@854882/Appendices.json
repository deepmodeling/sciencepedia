{"hands_on_practices": [{"introduction": "微观可逆性原理不仅适用于孤立的单个反应。当多个反应构成一个闭合循环时，热力学定律会对所有这些反应的速率常数施加一个严格的集体约束。本练习将引导您为最简单的反应循环推导出这个基本约束——即韦格沙伊德条件（Wegscheider condition）[@problem_id:2688106]，从而揭示动力学参数与吉布斯自由能作为状态函数的本质之间的深刻联系。", "problem": "考虑一个混合均匀、恒温的理想溶液，其中包含三种化学物质，它们通过形成闭合循环的三个基元可逆步骤相连：$A \\rightleftharpoons B$，$B \\rightleftharpoons C$ 和 $C \\rightleftharpoons A$。将六个一级反应速率常数记为 $k_{AB}^{+}$，$k_{AB}^{-}$，$k_{BC}^{+}$，$k_{BC}^{-}$，$k_{CA}^{+}$ 和 $k_{CA}^{-}$，其中，例如，$k_{AB}^{+}$ 是 $A \\to B$ 的速率常数，$k_{AB}^{-}$ 是 $B \\to A$ 的速率常数。假设每一步都是基元反应并遵循质量作用动力学，并且三个步骤的热力学标准态是一致的。\n\n仅从基本原理出发，即：(i) 质量作用动力学下基元步骤的平衡常数定义 $K_{ij} = \\frac{k_{ij}^{+}}{k_{ij}^{-}}$，该定义源于热力学平衡时的详细平衡原理；(ii) 平衡常数与标准吉布斯自由能变化之间的关系 $K_{ij} = \\exp\\!\\left(-\\frac{\\Delta G_{ij}^{\\circ}}{RT}\\right)$，其中 $R$ 是普适气体常数，$T$ 是绝对温度；以及 (iii) 标准吉布斯自由能是一个状态函数，因此围绕任何闭合循环的标准自由能变化之和为零，$\\Delta G_{AB}^{\\circ} + \\Delta G_{BC}^{\\circ} + \\Delta G_{CA}^{\\circ} = 0$。请推导此三步循环的热力学路径约束。\n\n定义环路产物比\n$$\nR \\equiv \\frac{k_{AB}^{+}\\,k_{BC}^{+}\\,k_{CA}^{+}}{k_{AB}^{-}\\,k_{BC}^{-}\\,k_{CA}^{-}}.\n$$\n在热力学平衡时，$R$ 的值是多少？请以单个精确数字（无单位）报告您的最终答案。", "solution": "我们被要求确定环路产物比\n$$\nR \\equiv \\frac{k_{AB}^{+}\\,k_{BC}^{+}\\,k_{CA}^{+}}{k_{AB}^{-}\\,k_{BC}^{-}\\,k_{CA}^{-}}\n$$\n在由三个基元可逆反应组成的循环达到热力学平衡时的值。推导必须基于质量作用动力学、基元反应平衡常数的定义、其与标准吉布斯自由能的联系以及状态函数性质。\n\n步骤1：由质量作用动力学和基元步骤的详细平衡原理推导平衡常数。对于单个具有一级速率常数 $k_{ij}^{+}$ 和 $k_{ij}^{-}$ 的基元可逆反应 $i \\rightleftharpoons j$，在热力学平衡时，正向和反向通量必须平衡（详细平衡原理），因此净通量为零。对于活度 $a_{i}$ 和 $a_{j}$，质量作用动力学给出正向速率 $r_{ij}^{+} = k_{ij}^{+} a_{i}$ 和反向速率 $r_{ij}^{-} = k_{ij}^{-} a_{j}$。在平衡时，$r_{ij}^{+} = r_{ij}^{-}$，因此 $k_{ij}^{+} a_{i}^{\\ast} = k_{ij}^{-} a_{j}^{\\ast}$，其中星号表示平衡值。因此，平衡常数，\n$$\nK_{ij} \\equiv \\frac{a_{j}^{\\ast}}{a_{i}^{\\ast}},\n$$\n满足\n$$\nK_{ij} = \\frac{k_{ij}^{+}}{k_{ij}^{-}}.\n$$\n\n步骤2：$K_{ij}$ 与标准吉布斯自由能之间的热力学关系。一个基元步骤的标准热力学关系是\n$$\nK_{ij} = \\exp\\!\\left(-\\frac{\\Delta G_{ij}^{\\circ}}{RT}\\right),\n$$\n其中 $\\Delta G_{ij}^{\\circ}$ 是 $i \\to j$ 转变的标准吉布斯自由能变化，$R$ 是普适气体常数，$T$ 是绝对温度。\n\n对循环 $A \\rightleftharpoons B$，$B \\rightleftharpoons C$ 和 $C \\rightleftharpoons A$ 中的每一步结合步骤1和步骤2，可得\n$$\n\\frac{k_{AB}^{+}}{k_{AB}^{-}} = \\exp\\!\\left(-\\frac{\\Delta G_{AB}^{\\circ}}{RT}\\right), \\quad\n\\frac{k_{BC}^{+}}{k_{BC}^{-}} = \\exp\\!\\left(-\\frac{\\Delta G_{BC}^{\\circ}}{RT}\\right), \\quad\n\\frac{k_{CA}^{+}}{k_{CA}^{-}} = \\exp\\!\\left(-\\frac{\\Delta G_{CA}^{\\circ}}{RT}\\right).\n$$\n\n步骤3：将围绕闭合环路的三个关系式相乘。环路产物比 $R$ 是正向与反向速率常数三个比率的乘积：\n$$\nR = \\left(\\frac{k_{AB}^{+}}{k_{AB}^{-}}\\right)\\left(\\frac{k_{BC}^{+}}{k_{BC}^{-}}\\right)\\left(\\frac{k_{CA}^{+}}{k_{CA}^{-}}\\right).\n$$\n使用步骤2中的热力学关系，\n$$\nR = \\exp\\!\\left(-\\frac{\\Delta G_{AB}^{\\circ}}{RT}\\right)\\exp\\!\\left(-\\frac{\\Delta G_{BC}^{\\circ}}{RT}\\right)\\exp\\!\\left(-\\frac{\\Delta G_{CA}^{\\circ}}{RT}\\right)\n= \\exp\\!\\left(-\\frac{\\Delta G_{AB}^{\\circ} + \\Delta G_{BC}^{\\circ} + \\Delta G_{CA}^{\\circ}}{RT}\\right).\n$$\n\n步骤4：应用标准吉布斯自由能的状态函数性质。因为标准吉布斯自由能是一个状态函数，所以围绕任何闭合循环的标准吉布斯自由能变化之和必须为零：\n$$\n\\Delta G_{AB}^{\\circ} + \\Delta G_{BC}^{\\circ} + \\Delta G_{CA}^{\\circ} = 0.\n$$\n将此代入 $R$ 的表达式中，\n$$\nR = \\exp\\!\\left(-\\frac{0}{RT}\\right) = \\exp(0) = 1.\n$$\n\n因此，由微观可逆性对此三步循环所施加的热力学路径约束是，正向与反向速率常数的环路产物比等于1，这即是此闭合网络的Wegscheider条件。", "answer": "$$\\boxed{1}$$", "id": "2688106"}, {"introduction": "在上一节推导循环约束的基础上，本练习将从抽象的理论推导转向具体的网络分析。给定一个特定的反应网络和一组速率常数，我们如何判断它在热力学上是否有效？本练习 [@problem_id:2688096] 将介绍来自化学反应网络理论的工具以及循环亲和势（cycle affinity）的概念，用以定量评估一个给定的动力学模型是否满足详细平衡原理。", "problem": "考虑一个包含两种化学物种 $X$ 和 $Y$ 以及三个复合物 $C_{1} = X$、$C_{2} = Y$ 和 $C_{3} = X+Y$ 的质量作用反应网络。所有三对复合物都通过可逆基元步骤相连：\n- $C_{1} \\rightleftharpoons C_{3}$，正向速率常数为 $k_{13}$，逆向速率常数为 $k_{31}$，\n- $C_{2} \\rightleftharpoons C_{3}$，正向速率常数为 $k_{23}$，逆向速率常数为 $k_{32}$，\n- $C_{1} \\rightleftharpoons C_{2}$，正向速率常数为 $k_{12}$，逆向速率常数为 $k_{21}$。\n\n假设为质量作用动力学，因此对于浓度向量 $(x,y)$，沿 $C_{i} \\to C_{j}$ 的单向通量是 $k_{ij}$ 乘以与源复合物 $C_{i}$ 对应的单项式。具体来说，$C_{1}$、$C_{2}$ 和 $C_{3}$ 的单项式分别为 $x$、$y$ 和 $xy$。\n\n对于给定的正速率常数\n$$\nk_{13} = 5,\\quad k_{31} = 2,\\quad k_{23} = 11,\\quad k_{32} = 7,\\quad k_{12} = 3,\\quad k_{21} = 13.\n$$\n仅使用微观可逆性原理（热力学平衡时的详细平衡）、质量作用动力学以及反应网络中复合物平衡的定义，回答以下问题。\n\n1. 推导一个联系 $k_{13}$、$k_{31}$、$k_{23}$、$k_{32}$、$k_{12}$ 和 $k_{21}$ 的、用于判断是否存在详细平衡态的必要且充分的代数约束。除了 $x$ 和 $y$ 的正性外，不要假设任何特殊值；从第一性原理出发推导该条件。\n\n2. 利用网络结构及其化学计量子空间，判断对于任意正速率常数，该网络是否容许一个复合物平衡态。根据化学反应网络理论的基本结果来证明你的结论。\n\n3. 定义标量循环亲和势\n$$\n\\Delta \\equiv \\ln\\!\\left(\\frac{k_{13}\\,k_{32}\\,k_{21}}{k_{31}\\,k_{23}\\,k_{12}}\\right).\n$$\n对上述给定的数值计算 $\\Delta$。报告你的答案，形式为一个无单位的纯数。将你的答案四舍五入到六位有效数字。", "solution": "本问题将按要求分三部分进行分析和解答。分析将严格遵守化学反应网络理论中给出的质量作用动力学、详细平衡和复合物平衡的定义。\n\n首先，对问题进行验证。\n已知条件：\n- 化学物种：$X$、$Y$，浓度为 $x > 0$，$y > 0$。\n- 复合物：$C_{1} = X$、$C_{2} = Y$、$C_{3} = X+Y$。\n- 反应：$C_{1} \\rightleftharpoons C_{3}$、$C_{2} \\rightleftharpoons C_{3}$、$C_{1} \\rightleftharpoons C_{2}$。\n- 质量作用动力学，单项式为：$\\psi_1 = x$，$\\psi_2 = y$，$\\psi_3 = xy$。$C_i \\to C_j$ 的通量为 $k_{ij} \\psi_i$。\n- 速率常数：$k_{13} = 5$，$k_{31} = 2$，$k_{23} = 11$，$k_{32} = 7$，$k_{12} = 3$，$k_{21} = 13$。\n- 任务：(1) 推导详细平衡约束。(2) 判断对于任意正速率常数是否存在复合物平衡。(3) 计算循环亲和势 $\\Delta$。\n\n验证结论：\n该问题在化学反应网络理论的形式框架内是适定的、有科学依据且客观的。它呈现了一个抽象的数学系统，并要求基于已建立的定理和定义对其性质进行分析。所给数据对于所需任务是完整和一致的。因此，该问题是**有效的**。\n\n接下来进行求解。\n\n1. 详细平衡约束的推导\n\n微观可逆性原理，或称详细平衡，要求在热力学平衡态下，每个正向基元反应的速率必须等于其相应逆向反应的速率。设这种平衡态的浓度为 $(x_e, y_e)$，其中 $x_e > 0$ 且 $y_e > 0$。我们将此原理应用于三个可逆反应对中的每一个。反应速率（通量）由速率常数与源复合物的单项式之积定义。\n\n对于反应 $C_{1} \\rightleftharpoons C_{3}$：\n正向通量为 $k_{13}\\psi_1 = k_{13}x$。逆向通量为 $k_{31}\\psi_3 = k_{31}xy$。在平衡时，这两者必须相等：\n$$k_{13}x_e = k_{31}x_e y_e$$\n由于 $x_e > 0$，我们可以除以 $x_e$ 得到一个关于 $y_e$ 的条件：\n$$y_e = \\frac{k_{13}}{k_{31}}$$\n\n对于反应 $C_{2} \\rightleftharpoons C_{3}$：\n正向通量为 $k_{23}\\psi_2 = k_{23}y$。逆向通量为 $k_{32}\\psi_3 = k_{32}xy$。在平衡时：\n$$k_{23}y_e = k_{32}x_e y_e$$\n由于 $y_e > 0$（由第一个条件和正速率常数确定），我们可以除以 $y_e$ 得到一个关于 $x_e$ 的条件：\n$$x_e = \\frac{k_{23}}{k_{32}}$$\n\n对于反应 $C_{1} \\rightleftharpoons C_{2}$：\n正向通量为 $k_{12}\\psi_1 = k_{12}x$。逆向通量为 $k_{21}\\psi_2 = k_{21}y$。在平衡时：\n$$k_{12}x_e = k_{21}y_e$$\n\n要存在一个详细平衡态，必须有一对 $(x_e, y_e)$ 同时满足所有三个条件。我们将从前两个反应推导出的 $x_e$ 和 $y_e$ 的表达式代入第三个反应的平衡方程中：\n$$k_{12}\\left(\\frac{k_{23}}{k_{32}}\\right) = k_{21}\\left(\\frac{k_{13}}{k_{31}}\\right)$$\n这个方程是对速率常数的一个约束。它是存在详细平衡态的必要条件。为了证明它也是充分的，假设这个关系成立。然后我们可以定义正浓度 $x_e = k_{23}/k_{32}$ 和 $y_e = k_{13}/k_{31}$。根据构造，这些值满足前两个反应的平衡条件，并且由于假定速率常数关系成立，它们也满足第三个反应的平衡条件。因此，这个代数约束是必要且充分的。为了清晰起见，重新整理可得：\n$$k_{12}k_{23}k_{31} = k_{13}k_{32}k_{21}$$\n这是所要求的代数约束，被称为韦格沙伊德(Wegscheider)条件。\n\n2. 复合物平衡态的存在性\n\n为了确定该网络是否对任意正速率常数都容许一个复合物平衡态，我们援引化学反应网络理论中的亏格零定理。如果一个网络是弱可逆的且其亏格为零，那么它保证对任意正速率常数集都容许一个复合物平衡态。\n\n亏格 $\\delta$ 定义为 $\\delta = n - l - s$，其中：\n- $n$ 是复合物的数量。\n- $l$ 是连通类的数量。\n- $s$ 是化学计量子空间的维数。\n\n让我们为给定网络计算这些量。\n- 复合物数量 $n$：复合物为 $C_{1}=X$、$C_{2}=Y$ 和 $C_{3}=X+Y$。因此，$n=3$。\n- 连通类数量 $l$：反应 $C_{1} \\leftrightarrow C_{2}$、$C_{2} \\leftrightarrow C_{3}$ 和 $C_{3} \\leftrightarrow C_{1}$ 将所有三个复合物连接成反应图中的一个单一组分。因此，只有一个连通类，所以 $l=1$。该网络也是弱可逆的，因为所有反应都是可逆的。\n- 化学计量子空间维数 $s$：化学计量子空间由与每个反应对应的反应向量 $C_{j}-C_{i}$ 张成。我们将复合物表示为物种空间 $(X, Y)$ 中的向量：\n  $$ \\mathbf{c}_1 = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}, \\quad \\mathbf{c}_2 = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}, \\quad \\mathbf{c}_3 = \\begin{pmatrix} 1 \\\\ 1 \\end{pmatrix} $$\n反应向量为：\n  $$ \\mathbf{v}_{12} = \\mathbf{c}_2 - \\mathbf{c}_1 = \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix} $$\n  $$ \\mathbf{v}_{23} = \\mathbf{c}_3 - \\mathbf{c}_2 = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} $$\n  $$ \\mathbf{v}_{31} = \\mathbf{c}_1 - \\mathbf{c}_3 = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} $$\n化学计量子空间 $S$ 是这三个向量的张成空间。我们检查线性相关性：\n  $$ \\mathbf{v}_{12} + \\mathbf{v}_{23} + \\mathbf{v}_{31} = \\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix} $$\n由于这些向量的和为零，它们是线性相关的。该子空间可以由其中任意两个向量张成，例如 $\\mathbf{v}_{12}$ 和 $\\mathbf{v}_{23}$，它们显然是线性无关的。因此，化学计量子空间的维数是 $s=2$。\n\n现在，我们计算亏格：\n$$\\delta = n - l - s = 3 - 1 - 2 = 0$$\n该网络的亏格为零。根据亏格零定理，由于网络也是弱可逆的，它对任意正速率常数的选择都容许一个复合物平衡态。因此，答案是肯定的。\n\n3. 循环亲和势 $\\Delta$ 的计算\n\n量 $\\Delta$ 定义为：\n$$ \\Delta \\equiv \\ln\\!\\left(\\frac{k_{13}\\,k_{32}\\,k_{21}}{k_{31}\\,k_{23}\\,k_{12}}\\right) $$\n该表达式代表了遍历复合物循环 $C_1 \\to C_3 \\to C_2 \\to C_1$ 所关联的热力学亲和势。注意，当且仅当对数的参数等于1时，系统处于详细平衡，这意味着 $\\Delta=0$。\n\n我们代入给定的速率常数值：\n$$ k_{13} = 5, \\quad k_{31} = 2, \\quad k_{23} = 11, \\quad k_{32} = 7, \\quad k_{12} = 3, \\quad k_{21} = 13 $$\n对数的参数是：\n$$ \\frac{k_{13}\\,k_{32}\\,k_{21}}{k_{31}\\,k_{23}\\,k_{12}} = \\frac{5 \\times 7 \\times 13}{2 \\times 11 \\times 3} = \\frac{455}{66} $$\n现在我们计算 $\\Delta$：\n$$ \\Delta = \\ln\\left(\\frac{455}{66}\\right) $$\n计算该值并四舍五入到六位有效数字：\n$$ \\frac{455}{66} \\approx 6.893939\\ldots $$\n$$ \\Delta = \\ln(6.893939\\ldots) \\approx 1.9306359\\ldots $$\n保留六位有效数字，结果是 $1.93064$。", "answer": "$$\\boxed{1.93064}$$", "id": "2688096"}, {"introduction": "我们的最终目标通常不只是检验一个给定的模型，而是要根据实验数据构建模型。这最后一个练习将理论与实际应用联系起来，展示了如何构建一个*保证*热力学一致性的动力学模型。您将基于底层的物种自由能，为速率常数建立一个参数化表示，并用它来拟合含噪声的实验数据 [@problem_id:2688053]。这项任务是现代系统生物学和化学工程中的核心技能。", "problem": "给定在复合物层面上表示的可逆质量作用反应网络。每个反应 $j$ 有一个反应物复合物 $y_j^-$ 和一个产物复合物 $y_j^+$，其中每个复合物是关于 $n$ 种化学物质的非负整数向量。假设理想热力学和微观可逆性原理（详细平衡）。请基于以下基本原理进行推导：（i）复合物的标准吉布斯生成自由能定义为各物种自由能的总和，（ii）理想混合物中平衡常数与标准吉布斯自由能差之间的关系，以及（iii）基元步骤在平衡状态下正向和逆向反应速率的稳态相等性。在开始时，请勿假设任何其他专门公式。\n\n您的任务是：\n- 仅使用上述基本原理，为每个可逆反应的未知正向和逆向速率常数推导出一个线性参数化。该参数化通过一个底层的物种自由能向量和每个反应的对称参数来实现，使得所有循环的详细平衡约束自动成立。\n- 构建一种估计方法，该方法在给定一些带噪声的正向和逆向速率常数的对数观测值的情况下，通过求解一个受规范约束（通过施加 $g_1 = 0$ 来固定物种自由能的加性不确定性）的线性最小二乘（LLS）问题（普通最小二乘（OLS）），来拟合物种自由能向量和每个反应的对称参数。该拟合模型必须忽略任何标记为非数字（NaN）的缺失观测值。\n- 根据拟合的物种自由能，计算每个反应的拟合正向与逆向速率常数之比。仅返回这些比率。这些比率必须表示为无量纲的浮点数。\n\n物理和数值约定：\n- 使用普适气体常数 $R = 8.314462618$ 焦耳每摩尔每开尔文。\n- 所有温度 $T$ 以开尔文为单位。\n- 物种自由能必须以焦耳每摩尔为单位。\n- 所有对数均为自然对数。\n- 输出的比率是无量纲实数；请以小数浮点数形式表示。\n\n对于下方的每个测试用例：\n- 给定 $n$（物种数）、$m$（反应数）、对于 $j = 1, \\dots, m$ 的复合物化学计量 $(y_j^{-}, y_j^{+})$、温度 $T$ 以及观测到的对数速率数据。某些条目缺失并概念性地标记为NaN；您的程序必须在LLS拟合中忽略这些缺失条目。\n- 针对未知物种自由能向量 $g \\in \\mathbb{R}^n$ 和未知的每个反应的对称参数 $h \\in \\mathbb{R}^m$ 构建一个单一的LLS问题，然后在约束 $g_1 = 0$ 下求解它以消除规范自由度。根据拟合的 $g$，按所给顺序计算反应的拟合正向与逆向比率。\n- 您的程序应按顺序汇总所有测试用例的结果。\n\n测试套件：\n\n- 测试用例 1（具有完整观测值的单分子循环）：\n  - $n = 3$，$m = 3$。\n  - 复合物：\n    - $y_1^- = (1, 0, 0)$，$y_1^+ = (0, 1, 0)$。\n    - $y_2^- = (0, 1, 0)$，$y_2^+ = (0, 0, 1)$。\n    - $y_3^- = (0, 0, 1)$，$y_3^+ = (1, 0, 0)$。\n  - 温度：$T = 298.15$。\n  - 观测到的对数速率常数（自然对数）：正向对数 $\\ell^{\\mathrm{f}} = (0.6, -0.2, 1.1)$，逆向对数 $\\ell^{\\mathrm{r}} = (1.4, 0.4, -0.3)$。\n\n- 测试用例 2（具有相同化学计量差异和缺失逆向观测值的二阶复合物）：\n  - $n = 2$，$m = 2$。\n  - 复合物：\n    - $y_1^- = (2, 0)$，$y_1^+ = (1, 1)$。\n    - $y_2^- = (1, 1)$，$y_2^+ = (0, 2)$。\n  - 温度：$T = 310.0$。\n  - 观测到的对数速率常数：正向对数 $\\ell^{\\mathrm{f}} = (2.0, 2.1)$，逆向对数 $\\ell^{\\mathrm{r}} = (1.0, \\mathrm{NaN})$。\n\n- 测试用例 3（具有大量级对数和缺失正向观测值的单物种链）：\n  - $n = 1$，$m = 2$。\n  - 复合物：\n    - $y_1^- = (1)$，$y_1^+ = (2)$。\n    - $y_2^- = (2)$，$y_2^+ = (3)$。\n  - 温度：$T = 350.0$。\n  - 观测到的对数速率常数：正向对数 $\\ell^{\\mathrm{f}} = (-8.0, \\mathrm{NaN})$，逆向对数 $\\ell^{\\mathrm{r}} = (-12.0, -15.0)$。\n\n最终输出规范：\n- 您的程序应生成单行输出，其中包含一个类似JSON的浮点数嵌套列表，第 $j$ 个内部列表按顺序包含测试用例 $j$ 的反应的拟合正向与逆向速率常数之比。\n- 例如，像 $[[r_{1,1}, r_{1,2}], [r_{2,1}], [r_{3,1}, r_{3,2}]]$ 这样的一行，其中每个 $r_{i,k}$ 是一个小数浮点数。", "solution": "问题陈述经评估有效。其科学基础是化学动力学和热力学原理，问题提法恰当，并包含推导唯一解所需的所有信息。我们将继续进行解法的推导和构建。\n\n### 1. 热力学一致的速率常数参数化的推导\n\n我们被给予了三个基本原理。我们将仅从这些原理出发推导出所需的形式。\n\n首先，令 $g \\in \\mathbb{R}^n$ 为 $n$ 种化学物质的标准摩尔吉布斯自由能向量，其中 $g_i$ 是物种 $i$ 的自由能。\n\n**基本原理 (i)：复合物的自由能**\n一个由非负整数向量 $y \\in \\mathbb{Z}_{\\ge 0}^n$ 表示的复合物，其标准吉布斯生成自由能是物种自由能的线性组合：\n$$G_{\\text{complex}}^\\circ(y) = y^T g = \\sum_{i=1}^n y_i g_i$$\n对于一个给定的反应 $j$，它将反应物复合物 $y_j^-$ 转化为产物复合物 $y_j^+$，该反应的标准吉布斯自由能变化 $\\Delta G_j^\\circ$ 是产物和反应物复合物自由能之差：\n$$\\Delta G_j^\\circ = G_{\\text{complex}}^\\circ(y_j^+) - G_{\\text{complex}}^\\circ(y_j^-) = (y_j^+)^T g - (y_j^-)^T g = (y_j^+ - y_j^-)^T g$$\n令向量 $s_j = y_j^+ - y_j^-$ 表示反应 $j$ 的净化学计量变化。因此，自由能变化可以紧凑地写为：\n$$\\Delta G_j^\\circ = s_j^T g$$\n\n**基本原理 (iii) 和 (ii)：详细平衡与平衡常数**\n根据质量作用动力学原理，对于一个基元反应 $j$，正向速率 $v_j^+$ 和逆向速率 $v_j^-$ 由下式给出：\n$$v_j^+ = k_j^+ \\prod_{i=1}^n [X_i]^{y_{ji}^-}$$\n$$v_j^- = k_j^- \\prod_{i=1}^n [X_i]^{y_{ji}^+}$$\n其中 $k_j^+$ 和 $k_j^-$ 分别是正向和逆向速率常数，$[X_i]$ 是物种 $i$ 的浓度。\n\n微观可逆性原理（详细平衡）断言，在平衡状态下，每个基元反应的正向和逆向速率相等：在平衡浓度 $[X_i]_{\\text{eq}}$下，$v_j^+ = v_j^-$。\n$$k_j^+ \\prod_{i=1}^n [X_i]_{\\text{eq}}^{y_{ji}^-} = k_j^- \\prod_{i=1}^n [X_i]_{\\text{eq}}^{y_{ji}^+}$$\n重新整理这个等式可以得到速率常数的比率：\n$$\\frac{k_j^+}{k_j^-} = \\frac{\\prod_{i=1}^n [X_i]_{\\text{eq}}^{y_{ji}^+}}{\\prod_{i=1}^n [X_i]_{\\text{eq}}^{y_{ji}^-}} = \\prod_{i=1}^n [X_i]_{\\text{eq}}^{y_{ji}^+ - y_{ji}^-} = \\prod_{i=1}^n [X_i]_{\\text{eq}}^{s_{ji}}$$\n根据定义，右侧是基于浓度的平衡常数 $K_{eq,j}$。因此，我们得到了一个关键关系：\n$$\\frac{k_j^+}{k_j^-} = K_{eq,j}$$\n现在，我们引用基本原理 (ii)，该原理将平衡常数与理想混合物的标准吉布斯自由能变化联系起来：\n$$K_{eq,j} = \\exp\\left(-\\frac{\\Delta G_j^\\circ}{RT}\\right)$$\n其中 $R$ 是普适气体常数，$T$ 是绝对温度。\n\n代入我们之前的结果，我们获得了对速率常数的热力学约束：\n$$\\frac{k_j^+}{k_j^-} = \\exp\\left(-\\frac{s_j^T g}{RT}\\right)$$\n对两边取自然对数，得到一个线性关系：\n$$\\log k_j^+ - \\log k_j^- = -\\frac{1}{RT} s_j^T g$$\n这个必须对每个反应 $j$ 都成立的方程是 Wegscheider-Lewis 条件，是详细平衡的数学表述。它约束了对数速率常数的差，但没有约束它们的和。\n\n为了找到一个通用的参数化，我们为每个反应引入一组 $m$ 个反应对称参数 $h_j \\in \\mathbb{R}$。这些参数捕捉了不由热力学决定的动力学方面（即活化能垒的高度）。让我们将 $h_j$ 定义为对数速率的平均值：\n$$h_j = \\frac{\\log k_j^+ + \\log k_j^-}{2}$$\n我们现在可以使用这个定义和热力学约束来求解 $\\log k_j^+$ 和 $\\log k_j^-$：\n$$\\log k_j^+ = h_j + \\frac{1}{2}(\\log k_j^+ - \\log k_j^-) = h_j - \\frac{1}{2RT} s_j^T g$$\n$$\\log k_j^- = h_j - \\frac{1}{2}(\\log k_j^+ - \\log k_j^-) = h_j + \\frac{1}{2RT} s_j^T g$$\n这两个方程代表了所需的线性参数化。它们将正向和逆向速率常数的对数表示为物种自由能 $g = (g_1, \\dots, g_n)^T$ 和每个反应的对称参数 $h = (h_1, \\dots, h_m)^T$ 的线性函数。任何 $g$ 和 $h$ 的选择都将产生自动满足详细平衡的速率常数。\n\n### 2. 线性最小二乘估计问题的构建\n\n我们被给予了带噪声的对数速率常数观测值，我们将其表示为 $\\ell_{j, \\text{obs}}^f$ 和 $\\ell_{j, \\text{obs}}^r$。我们的目标是通过最小化模型预测与观测值之间的误差平方和来估计参数 $g$ 和 $h$。这是一个线性最小二乘（LLS）问题。\n\n令未知参数向量为 $x = (g_1, \\dots, g_n, h_1, \\dots, h_m)^T \\in \\mathbb{R}^{n+m}$。所有反应的方程组可以写成矩阵形式 $Ax \\approx b_{\\text{obs}}$。\n观测向量是所有观测到的正向和逆向对数速率的拼接：\n$$b_{\\text{obs}} = \\left( \\ell_{1, \\text{obs}}^f, \\dots, \\ell_{m, \\text{obs}}^f, \\ell_{1, \\text{obs}}^r, \\dots, \\ell_{m, \\text{obs}}^r \\right)^T \\in \\mathbb{R}^{2m}$$\n设计矩阵 $A \\in \\mathbb{R}^{2m \\times (n+m)}$ 是基于推导出的线性模型构建的。如果参数向量排序为 $x = (g^T, h^T)^T$，矩阵 $A$ 具有以下分块结构：\n$$A = \\begin{pmatrix} -\\frac{1}{2RT} S & I_m \\\\ \\frac{1}{2RT} S & I_m \\end{pmatrix}$$\n其中 $S \\in \\mathbb{Z}^{m \\times n}$ 是化学计量矩阵，其第 $j$ 行为 $s_j^T$，$I_m$ 是 $m \\times m$ 的单位矩阵。\n\n**处理缺失数据**：问题指明某些观测值可能缺失（表示为NaN）。在LLS背景下，这通过简单地从设计矩阵 $A$ 和观测向量 $b_{\\text{obs}}$ 中移除相应的行来处理。如果 $b_k$ 是NaN，则系统的第 $k$ 行被丢弃。\n\n**规范约束**：单个物种的自由能 $g_i$ 不是绝对定义的；只有它们的差异在确定 $\\Delta G_j^\\circ$ 时才有意义。这通常导致设计矩阵 $A$ 是秩亏的。具体来说，如果存在一个守恒律（一个向量 $c \\in \\mathbb{R}^n$ 使得 $Sc=0$），那么与 $g$ 相关的 $A$ 的列是线性相关的，因为 $A_g c = 0$。为了获得唯一解，我们必须应用一个规范固定约束。问题指定了约束 $g_1 = 0$。这通过从参数向量中移除第一个未知数 $g_1$ 来实现，这对应于从设计矩阵 $A$ 中移除第一列。然后为简化的参数向量 $x' = (g_2, \\dots, g_n, h_1, \\dots, h_m)^T$ 求解LLS问题。\n\n最终的步骤如下：\n1.  构建完整的设计矩阵 $A$ 和观测向量 $b_{\\text{obs}}$。\n2.  识别 $b_{\\text{obs}}$ 中所有有效（非NaN）观测值的索引。通过仅选择与这些索引相对应的行，创建一个过滤后的矩阵 $A_{\\text{filt}}$ 和向量 $b_{\\text{filt}}$。\n3.  通过从 $A_{\\text{filt}}$ 中移除第一列来创建受约束的设计矩阵 $A_{\\text{constr}}$。\n4.  为简化的参数向量 $x'$ 求解LLS问题：\n    $$\\hat{x}' = \\arg\\min_{x'} \\|A_{\\text{constr}} x' - b_{\\text{filt}}\\|_2^2$$\n    这通常通过正规方程或更稳健的QR分解或SVD来求解，如`numpy.linalg.lstsq`中所实现的。\n5.  通过设置 $\\hat{g}_1 = 0$ 并从解 $\\hat{x}'$ 中填充 $\\hat{g}_2, \\dots, \\hat{g}_n$ 来重建完整的估计自由能向量 $\\hat{g}$。\n\n### 3. 拟合比率的计算\n\n一旦获得估计的自由能向量 $\\hat{g}$，每个反应 $j$ 的拟合正向与逆向速率常数之比可以直接从热力学关系中计算得出：\n$$\\left( \\frac{k_j^+}{k_j^-} \\right)_{\\text{fitted}} = \\exp\\left(-\\frac{s_j^T \\hat{g}}{RT}\\right)$$\n对每个反应 $j=1, \\dots, m$ 计算该值。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function that processes all test cases.\n    \"\"\"\n    R = 8.314462618  # Universal gas constant in J/(mol·K)\n\n    # Test cases defined in the problem statement\n    test_cases = [\n        # Test case 1: Unimolecular cycle\n        {\n            \"n\": 3, \"m\": 3, \"T\": 298.15,\n            \"complexes\": [((1, 0, 0), (0, 1, 0)), ((0, 1, 0), (0, 0, 1)), ((0, 0, 1), (1, 0, 0))],\n            \"lf\": [0.6, -0.2, 1.1],\n            \"lr\": [1.4, 0.4, -0.3]\n        },\n        # Test case 2: Second-order complexes, missing data\n        {\n            \"n\": 2, \"m\": 2, \"T\": 310.0,\n            \"complexes\": [((2, 0), (1, 1)), ((1, 1), (0, 2))],\n            \"lf\": [2.0, 2.1],\n            \"lr\": [1.0, np.nan]\n        },\n        # Test case 3: Single-species chain, missing data\n        {\n            \"n\": 1, \"m\": 2, \"T\": 350.0,\n            \"complexes\": [((1,), (2,)), ((2,), (3,))],\n            \"lf\": [-8.0, np.nan],\n            \"lr\": [-12.0, -15.0]\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        ratios = calculate_ratios_for_case(case, R)\n        all_results.append(ratios)\n\n    # Format the final output string to be JSON-like without spaces\n    # Example: [[r1,r2],[r3],[r4,r5]]\n    # str() on a list adds spaces, so we build the string manually.\n    outer_list_str = []\n    for inner_list in all_results:\n        inner_str = f\"[{','.join(map(str, inner_list))}]\"\n        outer_list_str.append(inner_str)\n    final_output = f\"[{','.join(outer_list_str)}]\"\n    print(final_output)\n\ndef calculate_ratios_for_case(case, R):\n    \"\"\"\n    Solves the LLS problem for a single test case and computes rate constant ratios.\n    \"\"\"\n    n, m, T = case[\"n\"], case[\"m\"], case[\"T\"]\n    lf_obs, lr_obs = case[\"lf\"], case[\"lr\"]\n    \n    # 1. Construct Stoichiometry Matrix S and observation vector b_obs\n    S = np.zeros((m, n))\n    for j, (y_minus, y_plus) in enumerate(case[\"complexes\"]):\n        # Handle single-element tuples correctly\n        y_minus_arr = np.zeros(n)\n        y_plus_arr = np.zeros(n)\n        y_minus_arr[:len(y_minus)] = y_minus\n        y_plus_arr[:len(y_plus)] = y_plus\n        s_j = y_plus_arr - y_minus_arr\n        S[j, :] = s_j\n    \n    b_obs = np.concatenate([np.array(lf_obs), np.array(lr_obs)])\n\n    # 2. Build the full design matrix A\n    num_params = n + m\n    A = np.zeros((2 * m, num_params))\n    \n    # Thermodynamic part (related to g)\n    thermo_block = S / (2 * R * T)\n    A[:m, :n] = -thermo_block  # Forward rates\n    A[m:, :n] = thermo_block   # Reverse rates\n    \n    # Kinetic part (related to h)\n    A[:m, n:] = np.identity(m)\n    A[m:, n:] = np.identity(m)\n\n    # 3. Filter for missing data (NaNs)\n    valid_indices = ~np.isnan(b_obs)\n    A_filt = A[valid_indices]\n    b_filt = b_obs[valid_indices]\n\n    # 4. Apply gauge constraint g_1 = 0\n    # This is done by removing the first column of the design matrix,\n    # corresponding to the parameter g_1 which is fixed to 0.\n    if n > 0:\n        A_constr = A_filt[:, 1:]\n    else:\n        A_constr = A_filt\n        \n    # 5. Solve the Linear Least Squares problem\n    # A_constr * x' = b_filt, where x' = (g_2, ..., g_n, h_1, ..., h_m)\n    if A_constr.shape[1] > 0:\n        x_prime_sol, _, _, _ = np.linalg.lstsq(A_constr, b_filt, rcond=None)\n    else: \n        x_prime_sol = np.array([])\n        # Need to solve for h parameters if n=1 (A_constr is empty)\n        # This case is handled by lstsq if A_constr has columns but 0 rows, but not if it has 0 columns.\n        if A_filt.shape[1] > 0:\n            # If n=1, A_constr is empty, we must solve for h's using A_filt's h-columns\n            A_h_only = A_filt[:,n:]\n            h_sol, _, _, _ = np.linalg.lstsq(A_h_only, b_filt, rcond=None)\n            x_prime_sol = h_sol\n\n    # 6. Reconstruct the full estimated free energy vector g_hat\n    g_hat = np.zeros(n)\n    if n > 1:\n        g_hat[1:] = x_prime_sol[:n-1]\n\n    # 7. Calculate and return the fitted forward-to-reverse rate constant ratios\n    ratios = []\n    for j in range(m):\n        s_j = S[j, :]\n        delta_G_hat = np.dot(s_j, g_hat)\n        ratio = np.exp(-delta_G_hat / (R * T))\n        ratios.append(ratio)\n        \n    return ratios\n\nsolve()\n```", "id": "2688053"}]}