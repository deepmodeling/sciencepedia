{"hands_on_practices": [{"introduction": "为了确保我们对副本交换分子动力学（REMD）有扎实的理解，让我们从一个旨在探讨其核心机制的思想实验开始。这个练习将检验您对交换接受概率与相邻副本的势能分布之间基本关系的理解 [@problem_id:2461578]。通过思考交换概率为零的极端情况，我们可以深刻地领会为何能量分布的重叠对于实现有效的副本交换至关重要，这也是精心设计温度阶梯的根本原因。", "problem": "考虑副本交换分子动力学 (Replica Exchange Molecular Dynamics, REMD)，其中在相邻温度 $T_i$ 和 $T_{i+1}$ 下的副本在经典分子动力学 (MD) 下演化时，会尝试交换它们的温度。每个副本在其指定的温度下对正则系综（NVT）进行抽样，因此一个势能为 $U(\\mathbf{x})$ 的构型 $\\mathbf{x}$ 的分布概率密度与 $\\exp(-\\beta U)$ 成正比，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$ 且 $k_{\\mathrm{B}}$ 是玻尔兹曼常数。交换移动的构建是为了满足相对于该对的联合正则分布的细致平衡条件。\n\n假设，在经过长时间的模拟，在副本 $i$ 和 $i+1$ 之间进行了多次交换尝试后，观察到这两个副本之间的交换接受率实际上为 $0$ (即所有尝试的交换都未被接受)。从正则抽样和细致平衡的第一性原理出发，推断这对它们的正则势能分布 $p_i(U)$ 和 $p_{i+1}(U)$ 之间的关系意味着什么，其中 $p_i(U)$ 是在温度 $T_i$ 下观察到势能 $U$ 的概率密度，$p_{i+1}(U)$ 是在温度 $T_{i+1}$ 下的相应分布。\n\n哪个陈述最能概括这一推论？\n\nA. 正则势能分布 $p_i(U)$ 和 $p_{i+1}(U)$ 几乎没有或完全没有重叠（即，在理想化的极限下，它们的支撑集实际上是不相交的），因此从一个分布中抽取的 $U$ 值很少（如果曾经有的话）会落入另一个分布的范围内。\n\nB. 平均势能相等，$\\langle U \\rangle_{T_i} = \\langle U \\rangle_{T_{i+1}}$，这抑制了交换。\n\nC. 两个副本访问相同的构型集，因此 $p_i(U) = p_{i+1}(U)$，但交换失败是因为交换没有提供任何好处。\n\nD. 分布很宽且强烈重叠，但交换失败是因为当温度不同时，细致平衡阻止了交换，使得接受概率与抽样能量无关，恒为 $0$。", "solution": "首先，我们分析并验证问题陈述的条件。\n\n**步骤 1：提取已知条件**\n- **方法：** 副本交换分子动力学 (REMD)。\n- **动力学：** 副本在正则系综（NVT）中通过经典分子动力学 (MD) 演化。\n- **温度：** 相邻副本处于温度 $T_i$ 和 $T_{i+1}$。\n- **统计权重：** 一个势能为 $U(\\mathbf{x})$ 的构型 $\\mathbf{x}$ 以与 $\\exp(-\\beta U)$ 成正比的概率密度分布，其中 $\\beta = 1/(k_{\\mathrm{B}} T)$。\n- **交换机制：** 交换的构建是为了满足细致平衡条件。\n- **观察：** 副本 $i$ 和 $i+1$ 之间的交换接受率实际上为 $0$。\n- **分布：** $p_i(U)$ 是在温度 $T_i$ 下的势能概率密度，$p_{i+1}(U)$ 是在 $T_{i+1}$ 下的相应分布。\n- **问题：** 零接受率对 $p_i(U)$ 和 $p_{i+1}(U)$ 之间的关系意味着什么？\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题描述了计算统计力学中的一个标准场景。所有概念——REMD、正则系综、玻尔兹曼因子、细致平衡——在科学上都是合理的并且陈述正确。问题提得很好，要求在这一框架内根据一个特定观察得出直接的物理推论。问题是自包含的、客观的，并且没有违反任何物理学或数学原理。当温度间隔选择不当时，“实际上为 0”的接受率是 REMD 模拟中一个常见的实际问题。\n\n**步骤 3：结论和行动**\n问题陈述有效。下面从第一性原理进行推导。\n\n**推导**\n\n假设有两个副本，一个处于逆温 $\\beta_i = 1/(k_{\\mathrm{B}} T_i)$，其构型为 $\\mathbf{x}_i$，势能为 $U_i = U(\\mathbf{x}_i)$；另一个处于逆温 $\\beta_{i+1} = 1/(k_{\\mathrm{B}} T_{i+1})$，其构型为 $\\mathbf{x}_{i+1}$，势能为 $U_{i+1} = U(\\mathbf{x}_{i+1})$。在组合系综中，此状态 $(\\mathbf{x}_i, \\mathbf{x}_{i+1})$ 的联合概率是独立正则概率的乘积：\n$$ P(\\mathbf{x}_i, \\mathbf{x}_{i+1}) \\propto \\exp(-\\beta_i U_i - \\beta_{i+1} U_{i+1}) $$\n一次交换移动提议交换构型（或等效地，交换温度），导致一个新状态，其中处于 $\\beta_i$ 的副本具有能量 $U_{i+1}$，而处于 $\\beta_{i+1}$ 的副本具有能量 $U_i$。这个新状态的概率是：\n$$ P(\\mathbf{x}_{i+1}, \\mathbf{x}_i) \\propto \\exp(-\\beta_i U_{i+1} - \\beta_{i+1} U_i) $$\n为了满足细致平衡，此移动的接受概率 $A$ 由 Metropolis 准则给出，因为交换的提议是对称的：\n$$ A(U_i, U_{i+1}) = \\min\\left(1, \\frac{P(\\text{new})}{P(\\text{old})}\\right) = \\min\\left(1, \\frac{\\exp(-\\beta_i U_{i+1} - \\beta_{i+1} U_i)}{\\exp(-\\beta_i U_i - \\beta_{i+1} U_{i+1})}\\right) $$\n简化指数的比率得到：\n$$ \\frac{P(\\text{new})}{P(\\text{old})} = \\exp(-\\beta_i U_{i+1} - \\beta_{i+1} U_i + \\beta_i U_i + \\beta_{i+1} U_{i+1}) = \\exp((\\beta_i - \\beta_{i+1})U_i - (\\beta_i - \\beta_{i+1})U_{i+1}) $$\n$$ = \\exp((\\beta_i - \\beta_{i+1})(U_i - U_{i+1})) $$\n令 $\\Delta\\beta = \\beta_i - \\beta_{i+1}$ 和 $\\Delta U = U_i - U_{i+1}$。接受概率为：\n$$ A(U_i, U_{i+1}) = \\min(1, \\exp(\\Delta\\beta \\Delta U)) $$\n问题陈述观察到的平均接受率实际上为 $0$。平均接受率 $\\langle A \\rangle$ 是 $A(U_i, U_{i+1})$ 在联合能量分布 $p(U_i, U_{i+1}) = p_i(U_i)p_{i+1}(U_{i+1})$ 上的期望值：\n$$ \\langle A \\rangle = \\int \\int A(U_i, U_{i+1}) p_i(U_i) p_{i+1}(U_{i+1}) \\,dU_i \\,dU_{i+1} $$\n要使 $\\langle A \\rangle$ 实际上为 $0$，鉴于 $A \\ge 0$ 且概率密度为非负，对于所有满足 $p_i(U_i)p_{i+1}(U_{i+1})  0$ 的对 $(U_i, U_{i+1})$，被积函数必须实际上为 $0$。这意味着对于由两个副本实际抽样的任何能量对，接受概率 $A(U_i, U_{i+1})$ 必须小到可以忽略。\n\n不失一般性地，我们假设 $T_{i+1}  T_i$。这意味着 $\\beta_{i+1}  \\beta_i$，因此 $\\Delta\\beta = \\beta_i - \\beta_{i+1}  0$。\n接受概率为 $A = \\min(1, \\exp(\\Delta\\beta \\Delta U))$。为了使 $A$ 接近 $0$，指数项必须非常小。这要求其参数为一个大的负数：\n$$ \\Delta\\beta \\Delta U \\ll 0 $$\n由于 $\\Delta\\beta  0$，这个条件要求 $\\Delta U = U_i - U_{i+1}$ 必须是一个大的负值。这意味着 $U_i \\ll U_{i+1}$。\n\n这个条件 $U_i \\ll U_{i+1}$ 必须对从各自的分布 $p_i(U)$ 和 $p_{i+1}(U)$ 中抽取的任何能量对 $(U_i, U_{i+1})$ 都成立。这对分布本身有着深远的影响。这意味着由低温副本 $i$ 抽样的任何能量值 $U_i$ 都显著小于由高温副本 $i+1$ 抽样的任何能量值 $U_{i+1}$。因此，$p_i(U)  0$ 的能量集合（$p_i$ 的支撑集）必须与 $p_{i+1}(U)  0$ 的能量集合（$p_{i+1}$ 的支撑集）不相交，并且完全位于后者的下方。换句话说，这两个势能分布不重叠。\n\n**逐项分析**\n\nA. 正则势能分布 $p_i(U)$ 和 $p_{i+1}(U)$ 几乎没有或完全没有重叠（即，在理想化的极限下，它们的支撑集实际上是不相交的），因此从一个分布中抽取的 $U$ 值很少（如果曾经有的话）会落入另一个分布的范围内。\n这个陈述是我们推导的直接而精确的结果。如果分布不重叠，那么对于任何抽样的对 $(U_i, U_{i+1})$，我们将有 $U_i$ 来自 $p_i(U)$ 的支撑集，$U_{i+1}$ 来自 $p_{i+1}(U)$ 的支撑集。由于平均能量随温度增加而增加（$\\langle U \\rangle_{T_{i+1}}  \\langle U \\rangle_{T_i}$），$p_i(U)$ 的支撑集必须位于比 $p_{i+1}(U)$ 的支撑集更低的能量区域。这保证了 $U_i  U_{i+1}$（如果能量分离很大，则很可能 $U_i \\ll U_{i+1}$），使得接受概率 $\\exp(\\Delta\\beta \\Delta U)$ 小到可以忽略。\n**结论：正确。**\n\nB. 平均势能相等，$\\langle U \\rangle_{T_i} = \\langle U \\rangle_{T_{i+1}}$，这抑制了交换。\n对于 $T_i \\neq T_{i+1}$ 的物理系统，这个前提在事实上是不正确的。平均能量 $\\langle U \\rangle$ 通过热容 $C_V = (\\partial \\langle U \\rangle / \\partial T)_V$ 与温度 $T$ 相关。由于对于稳定系统 $C_V  0$，$\\langle U \\rangle$ 必须是 $T$ 的单调递增函数，因此 $\\langle U \\rangle_{T_i} \\neq \\langle U \\rangle_{T_{i+1}}$。此外，如果平均能量相等，这将意味着分布 $p_i(U)$ 和 $p_{i+1}(U)$ 有很强的重叠，而这恰恰是获得*高*交换接受率的条件，而不是被抑制的条件。\n**结论：不正确。**\n\nC. 两个副本访问相同的构型集，因此 $p_i(U) = p_{i+1}(U)$，但交换失败是因为交换没有提供任何好处。\n对于不同的温度，前提 $p_i(U) = p_{i+1}(U)$ 是错误的。能量分布是依赖于温度的；通常，较高温度下的分布更宽，并向较高能量移动。即使我们假设性地接受这个前提，它也意味着完全重叠，从而导致高接受率，这与观察结果相矛盾。“好处”一词不属于正式接受准则的一部分。\n**结论：不正确。**\n\nD. 分布很宽且强烈重叠，但交换失败是因为当温度不同时，细致平衡阻止了交换，使得接受概率与抽样能量无关，恒为 $0$。\n“宽且强烈重叠”的分布这一前提会导致高接受率，而不是零。而“细致平衡阻止交换”的结论是一个根本性的误解。细致平衡是用来*推导*非零接受概率公式的原理。该公式明确依赖于温差和抽样能量，并且通常不为 $0$。\n**结论：不正确。**", "answer": "$$\\boxed{A}$$", "id": "2461578"}, {"introduction": "在掌握了基本概念之后，我们将转向一个更具实践性的问题，它涉及到设置REMD模拟时最关键的步骤之一：选择合适的温度阶梯。本练习 [@problem_id:2666613] 要求您基于系统的物理性质（如热容 $C_V$）来估算实现目标交换接受率所需的温度间隔 $\\Delta T$。通过这个计算，您将学会如何将抽象的Metropolis准则与具体的模拟设计决策联系起来，这对于优化REMD模拟的效率至关重要。", "problem": "为一个系统构建了一个副本交换分子动力学 (REMD) 温度阶梯，该系统在参考温度 $T = 300\\ \\mathrm{K}$ 附近的定容热容为 $C_V = 1000\\,k_{\\mathrm{B}}$。在具有恒定热容的正则系综能量涨落的高斯模型下，通过对两个副本的联合正则能量分布上的 Metropolis 接受准则进行平均，可以从第一性原理得到相邻温度 $T$ 和 $T+\\Delta T$ 之间的期望交换接受概率。仅使用正则系综的基本关系、Metropolis 准则以及由大热容证明合理的高斯近似，推导接受概率作为温度比的函数，并用它来估计该系统在 $T=300\\ \\mathrm{K}$ 时达到期望接受率 $0.3$ 所需的温度增量 $\\Delta T$。\n\n将 $\\Delta T$ 的最终答案以 $\\mathrm{K}$ 为单位表示，并将结果四舍五入到四位有效数字。", "solution": "该问题在科学上是合理的、自洽且定义明确的。它要求我们在一组特定的标准近似下，推导副本交换分子动力学（REMD）的接受概率，并进行数值计算。下面开始解答。\n\n副本交换的基本原理是在系统的副本扩展系综上执行蒙特卡洛移动，该移动包括交换两个副本的温度。考虑两个副本，$1$ 和 $2$，它们具有固定的构型，势能分别为 $U_1$ 和 $U_2$。副本 $1$ 处于温度 $T_1$ (逆温度 $\\beta_1 = 1/(k_{\\mathrm{B}} T_1)$)，副本 $2$ 处于温度 $T_2$ (逆温度 $\\beta_2 = 1/(k_{\\mathrm{B}} T_2)$)。在扩展正则系综中，此状态的总概率与 $\\exp(-\\beta_1 U_1 - \\beta_2 U_2)$ 成正比。\n\n我们提出一个交换操作，其中副本 $1$ 被赋予温度 $T_2$，而副本 $2$ 被赋予温度 $T_1$。构型的能量保持为 $U_1$ 和 $U_2$。新状态的概率与 $\\exp(-\\beta_2 U_1 - \\beta_1 U_2)$ 成正比。此交换的接受概率由 Metropolis 准则给出：\n$$\np_{\\text{swap}}(U_1, U_2) = \\min\\left(1, \\frac{\\exp(-\\beta_2 U_1 - \\beta_1 U_2)}{\\exp(-\\beta_1 U_1 - \\beta_2 U_2)}\\right)\n$$\n化简该比率得到：\n$$\n\\frac{\\exp(-\\beta_2 U_1 - \\beta_1 U_2)}{\\exp(-\\beta_1 U_1 - \\beta_2 U_2)} = \\exp\\left((\\beta_1 - \\beta_2)U_1 - (\\beta_1 - \\beta_2)U_2\\right) = \\exp\\left((\\beta_1 - \\beta_2)(U_1 - U_2)\\right)\n$$\n令 $\\Delta\\beta = \\beta_1 - \\beta_2$ 且 $\\Delta U = U_1 - U_2$。则接受概率为：\n$$\np_{\\text{swap}}(\\Delta U) = \\min(1, \\exp(\\Delta\\beta \\cdot \\Delta U))\n$$\n在模拟中，能量 $U_1$ 和 $U_2$ 不是固定的，而是从其各自温度下的正则概率分布 $P(U_1; T_1)$ 和 $P(U_2; T_2)$ 中抽取的随机变量。问题指出，由于热容很大，这些分布可以近似为高斯分布。根据统计力学，正则系综中能量涨落的方差与热容 $C_V$ 的关系为 $\\sigma_U^2 = \\langle U^2 \\rangle - \\langle U \\rangle^2 = k_{\\mathrm{B}} T^2 C_V$。\n因此，两个副本的能量分布为：\n$$\nU_1 \\sim \\mathcal{N}(\\langle U_1 \\rangle, \\sigma_{U_1}^2) \\quad \\text{其中} \\quad \\sigma_{U_1}^2 = k_{\\mathrm{B}} T_1^2 C_V\n$$\n$$\nU_2 \\sim \\mathcal{N}(\\langle U_2 \\rangle, \\sigma_{U_2}^2) \\quad \\text{其中} \\quad \\sigma_{U_2}^2 = k_{\\mathrm{B}} T_2^2 C_V\n$$\n问题指明 $C_V$ 是恒定的。平均能量的变化与 $C_V$ 的关系为 $d\\langle U \\rangle = C_V dT$。将其从 $T_1$ 积分到 $T_2$ 得到 $\\langle U_2 \\rangle - \\langle U_1 \\rangle = C_V (T_2-T_1)$。\n\n由于两个副本是独立的，能量差 $\\Delta U = U_1 - U_2$ 也是一个高斯随机变量。其均值和方差为：\n$$\n\\langle \\Delta U \\rangle = \\langle U_1 \\rangle - \\langle U_2 \\rangle = -C_V(T_2-T_1)\n$$\n$$\n\\sigma_{\\Delta U}^2 = \\text{Var}(U_1) + \\text{Var}(U_2) = k_{\\mathrm{B}} T_1^2 C_V + k_{\\mathrm{B}} T_2^2 C_V = k_{\\mathrm{B}} C_V (T_1^2 + T_2^2)\n$$\n期望接受概率 $\\langle p \\rangle$ 是通过对 $\\Delta U$ 的概率分布求 $p_{\\text{swap}}(\\Delta U)$ 的平均值得到的。令 $X = \\Delta\\beta \\cdot \\Delta U$。由于 $X$ 是高斯变量 $\\Delta U$ 的线性变换，所以 $X$ 也是高斯分布的。其均值 $\\langle X \\rangle$ 和方差 $\\sigma_X^2$ 为：\n$$\n\\langle X \\rangle = \\Delta\\beta \\langle \\Delta U \\rangle = \\left(\\frac{1}{k_{\\mathrm{B}} T_1} - \\frac{1}{k_{\\mathrm{B}} T_2}\\right) (-C_V(T_2-T_1)) = -\\frac{C_V}{k_{\\mathrm{B}}} \\frac{T_2-T_1}{T_1 T_2} (T_2-T_1) = -\\frac{C_V}{k_{\\mathrm{B}}} \\frac{(T_2-T_1)^2}{T_1 T_2}\n$$\n$$\n\\sigma_X^2 = (\\Delta\\beta)^2 \\sigma_{\\Delta U}^2 = \\left(\\frac{T_2-T_1}{k_{\\mathrm{B}} T_1 T_2}\\right)^2 k_{\\mathrm{B}} C_V (T_1^2 + T_2^2) = \\frac{C_V}{k_{\\mathrm{B}}} \\frac{(T_2-T_1)^2 (T_1^2+T_2^2)}{(T_1 T_2)^2}\n$$\n期望接受概率为 $\\langle p \\rangle = \\int_{-\\infty}^\\infty \\min(1, \\exp(x)) P(x) dx$，其中 $P(x)$ 是 $X$ 的高斯分布。一个常用的近似是 $\\langle p \\rangle \\approx 2\\Phi(\\langle X \\rangle / \\sigma_X)$，其中 $\\Phi(z)$ 是标准正态分布 $\\mathcal{N}(0, 1)$ 的累积分布函数 (CDF)。\n\n我们来计算比率 $\\langle X \\rangle / \\sigma_X$：\n$$\n\\frac{\\langle X \\rangle}{\\sigma_X} = \\frac{-\\frac{C_V}{k_{\\mathrm{B}}} \\frac{(T_2-T_1)^2}{T_1 T_2}}{\\sqrt{\\frac{C_V}{k_{\\mathrm{B}}} \\frac{(T_2-T_1)^2 (T_1^2+T_2^2)}{(T_1 T_2)^2}}} = \\frac{-\\sqrt{\\frac{C_V}{k_{\\mathrm{B}}}} (T_2-T_1)}{\\sqrt{T_1^2+T_2^2}}\n$$\n令 $T_1 = T$ 且 $T_2 = T+\\Delta T$。期望接受概率为：\n$$\n\\langle p \\rangle = 2\\Phi\\left(-\\sqrt{\\frac{C_V}{k_{\\mathrm{B}}}} \\frac{\\Delta T}{\\sqrt{T^2+(T+\\Delta T)^2}}\\right)\n$$\n为了将其表示为温度比 $r = T_2/T_1 = (T+\\Delta T)/T$ 的函数，我们注意到 $\\Delta T = T(r-1)$。代入此式可得：\n$$\n\\frac{\\Delta T}{\\sqrt{T^2+(T+\\Delta T)^2}} = \\frac{T(r-1)}{\\sqrt{T^2 + (rT)^2}} = \\frac{T(r-1)}{T\\sqrt{1+r^2}} = \\frac{r-1}{\\sqrt{1+r^2}}\n$$\n因此，作为温度比函数的接受概率为：\n$$\n\\langle p(r) \\rangle = 2\\Phi\\left(-\\sqrt{\\frac{C_V}{k_{\\mathrm{B}}}} \\frac{r-1}{\\sqrt{1+r^2}}\\right)\n$$\n这就完成了问题的第一部分。现在，我们必须根据给定的参数估计 $\\Delta T$：$\\langle p \\rangle = 0.3$，$C_V = 1000\\,k_{\\mathrm{B}}$ (所以 $C_V/k_{\\mathrm{B}} = 1000$)，以及 $T = 300\\ \\mathrm{K}$。\n需要求解的方程是：\n$$\n0.3 = 2\\Phi\\left(-\\sqrt{1000} \\frac{\\Delta T}{\\sqrt{300^2+(300+\\Delta T)^2}}\\right)\n$$\n首先，我们求出 $\\Phi$ 的自变量。令 $z$ 为该自变量。\n$$\n\\Phi(z) = \\frac{0.3}{2} = 0.15\n$$\n使用标准正态分布的逆累积分布函数，我们找到 $z$ 的值：\n$$\nz = \\Phi^{-1}(0.15) \\approx -1.036433\n$$\n因此，我们得到方程：\n$$\n-1.036433 = -\\sqrt{1000} \\frac{\\Delta T}{\\sqrt{300^2+(300+\\Delta T)^2}}\n$$\n令 $\\zeta = 1.036433$。方程简化为：\n$$\n\\zeta = \\sqrt{1000} \\frac{\\Delta T}{\\sqrt{300^2+(300+\\Delta T)^2}}\n$$\n两边平方得到：\n$$\n\\zeta^2 = 1000 \\frac{(\\Delta T)^2}{300^2+(300+\\Delta T)^2} \\implies \\frac{\\zeta^2}{1000} = \\frac{(\\Delta T)^2}{90000 + 90000 + 600\\Delta T + (\\Delta T)^2}\n$$\n令 $A = \\zeta^2/1000 \\approx (1.036433)^2/1000 \\approx 0.00107419$。\n$$\nA \\left(180000 + 600\\Delta T + (\\Delta T)^2\\right) = (\\Delta T)^2\n$$\n将其整理成标准二次方程形式 $a(\\Delta T)^2 + b(\\Delta T) + c = 0$：\n$$\n(1-A)(\\Delta T)^2 - (600A)\\Delta T - 180000A = 0\n$$\n代入 $A$ 的值：\n$$\n(1 - 0.00107419)(\\Delta T)^2 - (600 \\times 0.00107419)\\Delta T - (180000 \\times 0.00107419) = 0\n$$\n$$\n0.9989258 (\\Delta T)^2 - 0.644514 \\Delta T - 193.3542 = 0\n$$\n我们使用二次方程求根公式求解 $\\Delta T$，取正根，因为 $\\Delta T$ 必须为正：\n$$\n\\Delta T = \\frac{-b + \\sqrt{b^2-4ac}}{2a} = \\frac{0.644514 + \\sqrt{(-0.644514)^2 - 4(0.9989258)(-193.3542)}}{2(0.9989258)}\n$$\n$$\n\\Delta T = \\frac{0.644514 + \\sqrt{0.415398 + 772.633}}{1.9978516} = \\frac{0.644514 + \\sqrt{773.0484}}{1.9978516}\n$$\n$$\n\\Delta T = \\frac{0.644514 + 27.803748}{1.9978516} = \\frac{28.448262}{1.9978516} \\approx 14.2394\\ \\mathrm{K}\n$$\n将结果四舍五入到四位有效数字，得到 $\\Delta T = 14.24\\ \\mathrm{K}$。", "answer": "$$\\boxed{14.24}$$", "id": "2666613"}, {"introduction": "最后，我们进行一项综合性练习，它融合了分析理论与计算验证，这是计算科学家必备的一项关键技能。这个挑战 [@problem_id:2666530] 引入了一个具有已知状态密度的理想化模型系统，其平均交换接受概率可以通过解析方法精确推导。您的任务是首先完成这个解析推导，然后编写一个简短的程序，通过蒙特卡洛模拟来验证您的解析结果，从而确保您对REMD核心交换核的理论理解和实际实现都准确无误。", "problem": "设计一个完整的、可运行的程序，该程序针对具有已知态密度的系统，根据一个解析基准来验证副本交换分子动力学（REMD）的接受核。使用一个数学上易于处理的模型系统：一个具有 $f$ 个二次构型自由度的经典二次哈密顿量，其在逆温度 $\\beta$ 下的正则势能分布是形状参数为 $k = f/2$、尺度参数为 $1/\\beta$ 的伽马分布。具体来说，对于势能 $U \\ge 0$，其正则密度为\n$$\np_{\\beta}(U) = \\frac{\\beta^{k}}{\\Gamma(k)} U^{k - 1} e^{-\\beta U},\n$$\n其中 $k \\in \\{1,2,3,\\dots\\}$ 对系统是固定的。\n\n考虑两个分别处于逆温度 $\\beta_1$ 和 $\\beta_2$（$\\beta_1  \\beta_2  0$）的副本。交换它们温度（构型固定）的 Metropolis 交换接受因子为\n$$\nA(U_1, U_2) = \\min\\left(1, \\exp\\left[(\\beta_1 - \\beta_2)(U_1 - U_2)\\right]\\right),\n$$\n其中 $U_1 \\sim p_{\\beta_1}(\\cdot)$ 和 $U_2 \\sim p_{\\beta_2}(\\cdot)$ 是从上述正则密度中抽取的独立随机能量。系综平均接受概率是以下二重积分\n$$\n\\mathcal{A}(k, \\beta_1, \\beta_2) = \\int_0^\\infty \\int_0^\\infty p_{\\beta_1}(U_1)\\, p_{\\beta_2}(U_2)\\, \\min\\left(1, \\exp\\left[(\\beta_1 - \\beta_2)(U_1 - U_2)\\right]\\right)\\, dU_1\\, dU_2.\n$$\n\n任务：从第一性原理出发，推导出一个关于 $k$、$\\beta_1$ 和 $\\beta_2$ 的 $\\mathcal{A}(k, \\beta_1, \\beta_2)$ 的闭式解析表达式。然后实现一个程序，该程序：\n- 计算解析值 $\\mathcal{A}(k, \\beta_1, \\beta_2)$。\n- 通过蒙特卡洛方法独立地估计相同量，方法是将 $U_1$ 和 $U_2$ 作为形状为 $k$、尺度分别为 $1/\\beta_1$ 和 $1/\\beta_2$ 的独立伽马随机变量进行采样，并在 $n$ 次独立抽样上对 $A(U_1, U_2)$ 进行平均。\n- 使用样本标准误差来判断蒙特卡洛估计值是否在统计误差范围内与解析值一致，为下面定义的每个测试用例报告一个布尔值。\n\n您必须将能量和温度视为无量纲量（没有物理单位）。不涉及角度。不得使用百分比；所有比例必须以小数表示。\n\n测试套件：\n对于每个测试用例，参数为 $(k, \\text{beta1}, \\text{beta2}, n, \\text{随机种子})$：\n- 用例 1： $(k=1, \\text{beta1}=1.0, \\text{beta2}=1.0, n=100000, \\text{随机种子}=42)$\n- 用例 2： $(k=1, \\text{beta1}=1.0, \\text{beta2}=0.5, n=100000, \\text{随机种子}=43)$\n- 用例 3： $(k=3, \\text{beta1}=1.0, \\text{beta2}=0.8, n=100000, \\text{随机种子}=44)$\n- 用例 4： $(k=5, \\text{beta1}=3.0, \\text{beta2}=2.4, n=100000, \\text{随机种子}=45)$\n- 用例 5： $(k=10, \\text{beta1}=2.0, \\text{beta2}=1.6, n=100000, \\text{随机种子}=46)$\n- 用例 6： $(k=10, \\text{beta1}=1.0, \\text{beta2}=0.7, n=100000, \\text{随机种子}=47)$\n\n判定规则：\n对于每个用例，计算蒙特卡洛估计值 $\\widehat{\\mathcal{A}}$ 及其样本标准误差 $\\mathrm{SE} = s/\\sqrt{n}$，其中 $s$ 是 $n$ 个独立 $A(U_1, U_2)$ 值的无偏样本标准差。令 $\\mathcal{A}_{\\mathrm{an}}$ 表示解析值。如果满足\n$$\n\\left|\\widehat{\\mathcal{A}} - \\mathcal{A}_{\\mathrm{an}}\\right| \\le 4\\, \\mathrm{SE},\n$$\n则报告 $\\text{True}$，否则报告 $\\text{False}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含所有测试用例的结果，格式为方括号括起来的逗号分隔列表（例如，“[$\\text{result}_1,\\text{result}_2,\\dots$]”）。每个 $\\text{result}_i$ 必须是对应于第 $i$ 个测试用例的布尔值 $\\text{True}$ 或 $\\text{False}$，顺序与上面列出的一致。程序必须完全自包含，不需要任何用户输入或外部文件。请使用指定的运行时环境。", "solution": "该问题是有效的。它在科学上基于统计力学的原理，特别是正则系综和应用于副本交换分子动力学（REMD）的 Metropolis-Hastings 算法。模型系统，一个经典二次哈密顿量，是一个标准的教科书示例，其势能遵循伽马分布，这是一个公认的结果。该问题是适定的，提供了所有必要的参数和明确的目标：推导平均交换接受概率的闭式表达式，并通过蒙特卡洛模拟进行验证。语言精确客观。所有有效问题的条件均已满足。\n\n我们的目标是为 REMD 温度交换的系综平均接受概率 $\\mathcal{A}(k, \\beta_1, \\beta_2)$ 推导一个解析表达式，并实现一个程序通过蒙特卡洛模拟来验证该表达式。\n\n平均接受概率由以下积分给出：\n$$\n\\mathcal{A}(k, \\beta_1, \\beta_2) = \\int_0^\\infty \\int_0^\\infty p_{\\beta_1}(U_1)\\, p_{\\beta_2}(U_2)\\, \\min\\left(1, e^{(\\beta_1 - \\beta_2)(U_1 - U_2)}\\right)\\, dU_1\\, dU_2\n$$\n其中 $U_1$ 和 $U_2$ 分别是从正则概率密度 $p_{\\beta_1}(\\cdot)$ 和 $p_{\\beta_2}(\\cdot)$ 中抽取的独立随机势能。给定条件 $\\beta_1  \\beta_2$，我们可以将积分拆分为两个区域：\n$$\n\\mathcal{A} = \\underbrace{\\iint_{U_1 \\le U_2} p_{\\beta_1}(U_1) p_{\\beta_2}(U_2) e^{(\\beta_1 - \\beta_2)(U_1 - U_2)} dU_1 dU_2}_{I_A} + \\underbrace{\\iint_{U_1  U_2} p_{\\beta_1}(U_1) p_{\\beta_2}(U_2) dU_1 dU_2}_{I_B}\n$$\n$I_B$ 部分根据定义就是概率 $\\mathbb{P}(U_1  U_2)$，其中 $U_1 \\sim p_{\\beta_1}$，$U_2 \\sim p_{\\beta_2}$。\n\n现在分析 $I_A$。被积函数中的指数项可以展开：\n$$\np_{\\beta_1}(U_1) p_{\\beta_2}(U_2) e^{(\\beta_1 - \\beta_2)(U_1 - U_2)} = p_{\\beta_1}(U_1) p_{\\beta_2}(U_2) e^{\\beta_1 U_1 - \\beta_2 U_1 - \\beta_1 U_2 + \\beta_2 U_2}\n$$\n将指数项与概率密度中的指数项 $e^{-\\beta_1 U_1}$ 和 $e^{-\\beta_2 U_2}$ 合并，得到：\n$$\ne^{-\\beta_1 U_1 - \\beta_2 U_2 + (\\beta_1 U_1 - \\beta_2 U_1 - \\beta_1 U_2 + \\beta_2 U_2)} = e^{-\\beta_2 U_1 - \\beta_1 U_2}\n$$\n因此，$I_A$ 的被积函数（不含常数）为 $U_1^{k-1} U_2^{k-1} e^{-\\beta_2 U_1 - \\beta_1 U_2}$。这意味着：\n$$\np_{\\beta_1}(U_1) p_{\\beta_2}(U_2) e^{(\\beta_1 - \\beta_2)(U_1 - U_2)} = p_{\\beta_2}(U_1) p_{\\beta_1}(U_2)\n$$\n这是一个已知的恒等式。因此，积分 $I_A$ 变为：\n$$\nI_A = \\iint_{U_1 \\le U_2} p_{\\beta_2}(U_1) p_{\\beta_1}(U_2) dU_1 dU_2\n$$\n为了简化，我们对 $I_A$ 进行变量代换，令 $U_1' = U_2$ 和 $U_2' = U_1$。积分区域 $U_1 \\le U_2$ 变为 $U_2' \\le U_1'$（即 $U_1' \\ge U_2'$）。积分变为：\n$$\nI_A = \\iint_{U_1' \\ge U_2'} p_{\\beta_2}(U_2') p_{\\beta_1}(U_1') dU_1' dU_2'\n$$\n这正是从 $p_{\\beta_1}$ 和 $p_{\\beta_2}$ 中抽取的两个随机变量 $U_1'$ 和 $U_2'$ 满足 $U_1' \\ge U_2'$ 的概率。由于积分变量是虚设的，这与 $I_B$ 的形式完全相同。因此，$I_A = \\mathbb{P}(U_1 > U_2) = I_B$。\n平均接受概率为：\n$$\n\\mathcal{A} = I_A + I_B = 2 I_B = 2\\, \\mathbb{P}(U_1 > U_2)\n$$\n其中 $U_1 \\sim \\text{Gamma}(k, \\theta_1)$，$U_2 \\sim \\text{Gamma}(k, \\theta_2)$，尺度参数为 $\\theta_1 = 1/\\beta_1$ 和 $\\theta_2 = 1/\\beta_2$。\n要计算 $\\mathbb{P}(U_1 > U_2)$，可以考虑比率 $W = \\frac{U_1/\\theta_1}{U_1/\\theta_1 + U_2/\\theta_2}$。这是一个标准结论，如果分子和分母中的项是独立的标准伽马分布变量，则 $W$ 服从贝塔分布 $\\text{Beta}(k, k)$。\n不等式 $U_1 > U_2$ 等价于 $\\frac{U_1/\\theta_1}{U_2/\\theta_2} > \\frac{\\theta_1}{\\theta_2}$，这又等价于 $W > \\frac{\\theta_1}{\\theta_1 + \\theta_2}$。\n因此，$\\mathbb{P}(U_1 > U_2) = \\mathbb{P}\\left(W > \\frac{\\theta_1}{\\theta_1 + \\theta_2}\\right)$。这个概率由贝塔分布的累积分布函数（CDF）给出，即正则化不完全贝塔函数 $I_x(a, b)$：\n$$\n\\mathbb{P}(U_1 > U_2) = 1 - I_{\\frac{\\theta_1}{\\theta_1 + \\theta_2}}(k, k)\n$$\n利用对称性 $1 - I_x(k,k) = I_{1-x}(k,k)$，我们得到：\n$$\n\\mathbb{P}(U_1 > U_2) = I_{1-\\frac{\\theta_1}{\\theta_1 + \\theta_2}}(k, k) = I_{\\frac{\\theta_2}{\\theta_1 + \\theta_2}}(k, k)\n$$\n代入尺度参数 $\\theta_1 = 1/\\beta_1$ 和 $\\theta_2 = 1/\\beta_2$：\n$$\n\\frac{\\theta_2}{\\theta_1 + \\theta_2} = \\frac{1/\\beta_2}{1/\\beta_1 + 1/\\beta_2} = \\frac{1/\\beta_2}{(\\beta_1+\\beta_2)/(\\beta_1\\beta_2)} = \\frac{\\beta_1}{\\beta_1+\\beta_2}\n$$\n等等，代数错误。应该是：\n$$\n\\frac{\\theta_2}{\\theta_1 + \\theta_2} = \\frac{1/\\beta_2}{1/\\beta_1 + 1/\\beta_2} = \\frac{\\beta_1 \\beta_2 (1/\\beta_2)}{\\beta_1 \\beta_2 (1/\\beta_1 + 1/\\beta_2)} = \\frac{\\beta_1}{\\beta_2 + \\beta_1}\n$$\n因此，$\\mathbb{P}(U_1 > U_2) = I_{\\frac{\\beta_1}{\\beta_1+\\beta_2}}(k, k)$。\n最终解析表达式为：\n$$\n\\mathcal{A}_{\\mathrm{an}}(k, \\beta_1, \\beta_2) = 2 \\cdot I_{\\frac{\\beta_1}{\\beta_1+\\beta_2}}(k, k)\n$$\n然而，有一个更简单的推导。$\\mathcal{A}=2 \\mathbb{P}(U_1>U_2)$，其中 $U_1 \\sim \\text{Gamma}(k, 1/\\beta_1)$ and $U_2 \\sim \\text{Gamma}(k, 1/\\beta_2)$. $\\mathbb{P}(U_1 > U_2) = \\mathbb{P}(U_1/U_2 > 1)$. 令 $Z=U_1/U_2$. $Z \\frac{\\beta_1}{\\beta_2}$ 服从F分布，但这很复杂。\n让我们回到 $W = \\frac{U_1/\\theta_1}{U_1/\\theta_1 + U_2/\\theta_2}$. 这个是错的。应该是 $W = \\frac{X}{X+Y}$ where $X,Y \\sim \\text{Gamma}(k,1)$.\n$U_1/\\theta_1 \\sim \\text{Gamma}(k,1)$, $U_2/\\theta_2 \\sim \\text{Gamma}(k,1)$. Let $X' = U_1/\\theta_1, Y' = U_2/\\theta_2$.\n$U_1 > U_2 \\iff X'\\theta_1 > Y'\\theta_2 \\iff X'/Y' > \\theta_2/\\theta_1$.\n$W = X'/(X'+Y') \\sim \\text{Beta}(k,k)$. $X'/Y' = W/(1-W)$.\n$W/(1-W) > \\theta_2/\\theta_1 \\iff W\\theta_1 > (1-W)\\theta_2 \\iff W(\\theta_1+\\theta_2) > \\theta_2 \\iff W > \\frac{\\theta_2}{\\theta_1+\\theta_2}$.\n$\\mathbb{P}(U_1 > U_2) = \\mathbb{P}(W > \\frac{\\theta_2}{\\theta_1+\\theta_2}) = 1 - I_{\\frac{\\theta_2}{\\theta_1+\\theta_2}}(k,k) = I_{1-\\frac{\\theta_2}{\\theta_1+\\theta_2}}(k,k) = I_{\\frac{\\theta_1}{\\theta_1+\\theta_2}}(k,k)$.\n代入$\\theta_i = 1/\\beta_i$: $\\frac{\\theta_1}{\\theta_1+\\theta_2} = \\frac{1/\\beta_1}{1/\\beta_1+1/\\beta_2} = \\frac{\\beta_2}{\\beta_1+\\beta_2}$.\n所以 $\\mathbb{P}(U_1>U_2) = I_{\\frac{\\beta_2}{\\beta_1+\\beta_2}}(k, k)$.\n最终解析表达式为：\n$$\n\\mathcal{A}_{\\mathrm{an}}(k, \\beta_1, \\beta_2) = 2 \\cdot I_{\\frac{\\beta_2}{\\beta_1+\\beta_2}}(k, k)\n$$\n这个表达式是正确的。现在可以继续实现程序。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import betainc\n\ndef solve():\n    \"\"\"\n    Solves the REMD acceptance kernel verification problem.\n    Derives the analytic solution for the average acceptance probability and\n    verifies it against a Monte Carlo simulation for several test cases.\n    \"\"\"\n    \n    # Test Suite: (k, beta1, beta2, n_samples, seed)\n    test_cases = [\n        (1, 1.0, 1.0, 100000, 42),\n        (1, 1.0, 0.5, 100000, 43),\n        (3, 1.0, 0.8, 100000, 44),\n        (5, 3.0, 2.4, 100000, 45),\n        (10, 2.0, 1.6, 100000, 46),\n        (10, 1.0, 0.7, 100000, 47),\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        k, beta1, beta2, n, seed = case\n        \n        # --- Analytic Calculation ---\n        # The average acceptance probability is 2 * I_x(k, k), where\n        # I_x is the regularized incomplete beta function and x = beta2 / (beta1 + beta2).\n        if beta1 == beta2:\n            analytic_A = 1.0\n        else:\n            # This derivation is robust for beta1 > beta2\n            x_beta = beta2 / (beta1 + beta2)\n            analytic_A = 2.0 * betainc(k, k, x_beta)\n        \n        # --- Monte Carlo Estimation ---\n        rng = np.random.default_rng(seed)\n        \n        # The potential energy U for a canonical ensemble at inverse temperature beta\n        # follows a Gamma distribution with shape k and scale 1/beta.\n        scale1 = 1.0 / beta1\n        scale2 = 1.0 / beta2\n        \n        # Generate n independent energy samples for each replica.\n        U1_samples = rng.gamma(shape=k, scale=scale1, size=n)\n        U2_samples = rng.gamma(shape=k, scale=scale2, size=n)\n        \n        # Calculate the Metropolis acceptance factor for each pair of samples.\n        delta_beta = beta1 - beta2\n        delta_U = U1_samples - U2_samples\n        \n        # A = min(1, exp(delta_beta * delta_U))\n        acceptance_factors = np.minimum(1.0, np.exp(delta_beta * delta_U))\n        \n        # Compute the MC estimate (sample mean) and standard error.\n        mc_A = np.mean(acceptance_factors)\n        # Use ddof=1 for the unbiased sample standard deviation.\n        s = np.std(acceptance_factors, ddof=1)\n        se = s / np.sqrt(n)\n\n        # --- Decision Rule ---\n        # The Monte Carlo estimate agrees if it is within 4 standard errors\n        # of the analytic value.\n        is_consistent = np.abs(mc_A - analytic_A) = 4.0 * se\n        results.append(is_consistent)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2666530"}]}