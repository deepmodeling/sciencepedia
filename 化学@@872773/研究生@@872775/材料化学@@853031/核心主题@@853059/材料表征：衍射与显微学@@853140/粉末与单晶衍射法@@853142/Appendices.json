{"hands_on_practices": [{"introduction": "指标化是利用粉末衍射数据解析未知晶体结构时至关重要的第一步。这个过程就像是晶体的“指纹识别”，即通过一组精确测量的衍射峰位（$d$ 值）来确定材料独一无二的晶胞参数和布拉维晶格类型。本练习 ([@problem_id:2515451]) 将指导您完成这一逻辑推理过程，您将学习如何将倒易空间中的衍射数据与晶格的几何关系联系起来，并从一组理想的高精度数据中推导出晶胞参数。", "problem": "一个多晶样品产生了高分辨率的粉末衍射图谱，从中提取了前二十个衍射峰的位置作为晶面间距。峰位已经针对仪器零点漂移和样品位移进行了校正，可以认为其相对不确定度在 $1 \\times 10^{-4}$ 以内是准确的。测得的晶面间距（单位为埃）按 $d$ 值降序排列如下：\n$d_1 = 2.121320$, $d_2 = 1.500000$, $d_3 = 1.224745$, $d_4 = 1.060660$, $d_5 = 0.9486833$, $d_6 = 0.8660254$, $d_7 = 0.8017837$, $d_8 = 0.7500000$, $d_9 = 0.7071068$, $d_{10} = 0.6708204$, $d_{11} = 0.6390097$, $d_{12} = 0.6123724$, $d_{13} = 0.5883484$, $d_{14} = 0.5477226$, $d_{15} = 0.5303301$, $d_{16} = 0.5144958$, $d_{17} = 0.5000000$, $d_{18} = 0.4866643$, $d_{19} = 0.4743417$, $d_{20} = 0.4629100$。\n\n仅从布拉格定律 $2 d \\sin \\theta = \\lambda$ 和七大晶系的倒易点阵度规出发，概述现代软件中实现的典型粉末衍射指标化算法的主要逻辑步骤（例如，晶带轴指标化后进行穷举晶胞搜索和精修策略），包括：\n- 将晶面间距转换为倒易空间量并识别简单的有理数关系。\n- 使用系统消光准则和倒易空间中的线性检验来区分不同的布拉菲晶格。\n- 从前二十条谱线中提出并验证一个候选晶胞。\n- 为这二十个衍射峰指定与所选布拉菲晶格和倒易度规一致的米勒指数 $(h k l)$。\n- 针对二十个 $d$ 间距对晶格参数进行简单的最小二乘法精修。\n\n然后，对给定数据执行这些步骤，确定最可能的布拉菲晶格和晶胞参数，为前二十个衍射峰指定 $(h k l)$ 指数，并计算晶胞体积。在答案框中报告最佳候选晶胞的晶格参数 $a$（单位为埃）和晶胞体积 $V$（单位为立方埃）作为最终答案。将报告的两个量都四舍五入到四位有效数字。最终的数值答案在答案框内必须不带单位，但为清楚起见，此处指定了您应使用的单位：$a$ 的单位是埃，$V$ 的单位是 $\\text{\\AA}^3$。", "solution": "在尝试任何解答之前，首先对问题进行验证。\n\n首先，从问题陈述中逐字提取已知条件：\n- 来自多晶样品的二十个晶面间距集合：\n$d_1 = 2.121320$ Å, $d_2 = 1.500000$ Å, $d_3 = 1.224745$ Å, $d_4 = 1.060660$ Å, $d_5 = 0.9486833$ Å, $d_6 = 0.8660254$ Å, $d_7 = 0.8017837$ Å, $d_8 = 0.7500000$ Å, $d_9 = 0.7071068$ Å, $d_{10} = 0.6708204$ Å, $d_{11} = 0.6390097$ Å, $d_{12} = 0.6123724$ Å, $d_{13} = 0.5883484$ Å, $d_{14} = 0.5477226$ Å, $d_{15} = 0.5303301$ Å, $d_{16} = 0.5144958$ Å, $d_{17} = 0.5000000$ Å, $d_{18} = 0.4866643$ Å, $d_{19} = 0.4743417$ Å, $d_{20} = 0.4629100$ Å。\n- 晶面间距的相对不确定度：$1 \\times 10^{-4}$。\n- 使用的基本定律：布拉格定律 $2 d \\sin \\theta = \\lambda$ 和七大晶系的倒易点阵度规。\n- 任务：\n    1. 概述粉末衍射指标化算法的逻辑步骤。\n    2. 将这些步骤应用于给定数据。\n    3. 确定布拉菲晶格和晶胞参数。\n    4. 为前二十个衍射峰指定米勒指数 $(h k l)$。\n    5. 计算晶胞体积 $V$。\n- 报告要求：报告晶格参数 $a$ 和体积 $V$，四舍五入到四位有效数字。\n\n该问题是X射线晶体学中的一个典型练习，科学上合理、问题明确且客观。它基于基本原理，并提供了一套完整的理想化数据，适合教学环境。因此，该问题被认为是**有效的**，并将构建解答。\n\n对于未知结构材料（尤其是在此类问题中通常假定具有高晶体对称性的材料）的粉末衍射图谱进行指标化的通用程序，遵循一系列逻辑步骤。虽然现代算法高度复杂，并经常采用穷举搜索策略，但其核心逻辑基于下述原理。\n\n首先，必须将测量的处于正空间的晶面间距 $d_{hkl}$ 转换为倒易空间中的量。这是因为衍射之间的关系在倒易空间中更为简单。布拉格定律 $2 d \\sin \\theta = \\lambda$ 可以平方并重新整理。使用倒易点阵矢量大小的定义 $Q_{hkl} = 1/d_{hkl} = (2 \\sin \\theta)/\\lambda$，我们得到一个量 $Q_{hkl}^2 = 1/d_{hkl}^2$。$Q_{hkl}^2$ 的表达式是关于米勒指数 $(h, k, l)$ 和倒易晶格参数的二次型。对于一般的三斜晶系，其表达式为 $Q_{hkl}^2 = h^2 a^{*2} + k^2 b^{*2} + l^2 c^{*2} + 2hk a^* b^* \\cos \\gamma^* + 2hl a^* c^* \\cos \\beta^* + 2kl b^* c^* \\cos \\alpha^*$。对于更高对称性的晶系，此方程会显著简化。对于立方晶系，它变为 $Q_{hkl}^2 = (h^2+k^2+l^2)/a^2$，其中 $a$ 是晶格参数。\n\n其次，尝试区分不同的布拉菲晶格。这通过搜索观测到的 $Q_i^2$ 值之间的简单有理数关系来实现。对于立方晶格，$Q_i^2$ 值的比率必须是整数的比率，其中这些整数是三个平方数之和，$N = h^2+k^2+l^2$。此外，观测到的衍射集合中的系统消光对允许的 $(hkl)$ 指数施加了约束，这些约束是布拉菲晶格类型的特征。对于简单立方(P)晶格，所有可以写成三个平方数之和的整数 $N$ 值都是允许的（例如，$1, 2, 3, 4, 5, 6, 8, 9, ...$；$7, 15, 23, 28, ...$ 是禁戒的）。对于体心立方(I)晶格，衍射条件是 $h+k+l = 2n$（偶数），这意味着 $h^2+k^2+l^2$ 必须是偶数（例如，$N = 2, 4, 6, 8, 10, ...$）。对于面心立方(F)晶格，指数必须全部为偶数或全部为奇数，这导致允许的 $N$ 序列为 $3, 4, 8, 11, 12, 16, ...$。通过识别关联观测到的 $Q_i^2$ 值的乘数序列，可以推断出晶系和布拉菲晶格。\n\n第三，提出一个候选晶胞。对于立方晶系，一旦确定了布拉菲晶格，就可以使用任何单个衍射来提出一个试验晶格参数。例如，如果第一个峰的指数为 $(h_1k_1l_1)$，则 $a^2 = (h_1^2+k_1^2+l_1^2)/Q_1^2$。\n\n第四，必须通过为所有观测到的衍射峰一致地指定米勒指数来验证所提出的晶胞。已指标化衍射峰的计算值 $Q_{calc}^2$ 必须在实验不确定度范围内与观测值 $Q_{obs}^2$ 相匹配。一次成功的指标化，必须能解释所有观测到的谱线，在低角度区域没有任何未被指标化的谱线，并且指数必须满足所提出的布拉菲晶格的系统消光规律。\n\n第五，一旦找到有效的指标化解，就使用最小二乘法对晶格参数进行精修。此过程旨在最小化观测峰位和计算峰位之间加权平方差的总和。对于模型为 $Q_i^2 = N_i/a^2$ 的立方晶系，待拟合参数为 $P = 1/a^2$，需要最小化的函数是 $\\chi^2 = \\sum_i w_i (Q_{i,obs}^2 - N_i P)^2$，其中 $w_i$ 是统计权重，通常与每次观测不确定度的平方倒数有关。\n\n将此程序应用于所提供的数据：\n\n步骤1：将给定的二十个 $d$ 间距转换为 $Q_i^2 = 1/d_i^2$ 值（单位为 Å$^{-2}$）。\n$Q_1^2 = 1/(2.121320)^2 = 0.22222223$\n$Q_2^2 = 1/(1.500000)^2 = 0.44444444$\n$Q_3^2 = 1/(1.224745)^2 = 0.66666667$\n$Q_4^2 = 1/(1.060660)^2 = 0.88888889$\n以此类推。\n\n步骤2：我们检查这些 $Q^2$ 值的比率。令 $S = Q_1^2 = 0.22222223$。\n$Q_2^2/S = 2.0000000$\n$Q_3^2/S = 3.0000000$\n$Q_4^2/S = 4.0000000$\n这表明 $Q^2$ 值可能是一些基本值的整数倍。我们通过将每个 $Q_i^2$ 除以小的整数来寻找这个基本值，直到出现一个一致的常数。我们观察到 $Q_1^2/2 = 0.11111111$，$Q_2^2/4 = 0.11111111$，$Q_3^2/6 = 0.11111111$，等等。一个公因子 $C_0 = 1/9 \\approx 0.11111111$ Å$^{-2}$ 是显而易见的。因此，观测到的 $Q_i^2$ 值为 $Q_i^2 = N_i \\cdot C_0$，其中整数 $N_i$ 的序列是：\n$N_1 = 2$, $N_2 = 4$, $N_3 = 6$, $N_4 = 8$, $N_5 = 10$, $N_6 = 12$, $N_7 = 14$, $N_8 = 16$, $N_9 = 18$, $N_{10} = 20$, $N_{11} = 22$, $N_{12} = 24$, $N_{13} = 26$。\n对所有20个峰继续计算，我们发现 $N$ 值的序列是：$2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 30, 32, 34, 36, 38, 40, 42$。\n这个序列包含了从 $2$ 到 $26$ 的所有偶数，跳过了 $28$，然后从 $30$ 继续。整数 $28$ 不能写成三个整数的平方和。这个序列是体心立方（BCC 或 I）晶格的唯一特征。\n\n步骤3：晶系是立方晶系，布拉菲晶格是体心立方。$Q^2$ 的关系式是一个特例：$Q_{hkl}^2 = (h^2+k^2+l^2)/a^2$。我们找到的常数因子是 $C_0 = 1/a^2$。根据我们的分析，$C_0 \\approx 1/9$ Å$^{-2}$，这给出了一个试验晶格参数 $a = \\sqrt{9} = 3$ Å。\n\n步骤4：我们为每个观测到的衍射峰指定符合BCC选择定则（$h+k+l = \\text{偶数}$）的米勒指数 $(hkl)$。\n- $d_1, N=2: (110)$\n- $d_2, N=4: (200)$\n- $d_3, N=6: (211)$\n- $d_4, N=8: (220)$\n- $d_5, N=10: (310)$\n- $d_6, N=12: (222)$\n- $d_7, N=14: (321)$\n- $d_8, N=16: (400)$\n- $d_9, N=18: (330)$ 或 $(411)$\n- $d_{10}, N=20: (420)$\n- $d_{11}, N=22: (332)$\n- $d_{12}, N=24: (422)$\n- $d_{13}, N=26: (510)$ 或 $(431)$\n- $d_{14}, N=30: (521)$\n- $d_{15}, N=32: (440)$\n- $d_{16}, N=34: (530)$ 或 $(433)$\n- $d_{17}, N=36: (600)$ 或 $(442)$\n- $d_{18}, N=38: (611)$ 或 $(532)$\n- $d_{19}, N=40: (620)$\n- $d_{20}, N=42: (541)$\n所有二十个衍射峰都被指标化，并且图谱与BCC晶格完全一致。\n\n步骤5：执行最小二乘法精修以获得晶格参数 $a$ 的最佳值。模型是 $Q_i^2 = P \\cdot N_i$，其中 $P = 1/a^2$。一个统计上合理的方法是通过其方差的倒数对每个数据点进行加权。$Q^2$ 的不确定度为 $\\delta(Q_i^2) = 2 Q_i^2 (\\delta d_i/d_i)$。由于 $\\delta d/d$ 是常数，因此 $Q_i^2$ 的标准差 $\\sigma_i$ 与 $Q_i^2$ 成正比。权重为 $w_i = 1/\\sigma_i^2 \\propto 1/(Q_i^2)^2$。使用 $Q_i^2 \\approx P N_i$，权重为 $w_i \\propto 1/N_i^2$。对于通过原点的直线的斜率 $P$ 的加权最小二乘解是 $P = (\\sum w_i N_i Q_i^2) / (\\sum w_i N_i^2)$。代入 $w_i = 1/N_i^2$ 将其简化为 $P = \\frac{1}{n} \\sum_{i=1}^{n} \\frac{Q_i^2}{N_i}$，其中 $n = 20$。\n我们为每个峰计算 $Q_i^2/N_i = 1/(d_i^2 N_i)$ 的值：\n$1/(2.121320^2 \\times 2) = 0.111111115$\n$1/(1.500000^2 \\times 4) = 0.111111111$\n...\n$1/(0.4629100^2 \\times 42) = 0.111111111$\n每个单独的值都非常接近 $1/9$。对二十个值取平均：\n$P = \\frac{1}{20} \\sum_{i=1}^{20} \\frac{1}{d_i^2 N_i} = 0.11111111105$ Å$^{-2}$。\n然后从 $a = 1/\\sqrt{P}$ 计算精修后的晶格参数 $a$。\n$a = 1/\\sqrt{0.11111111105} = 3.00000000075$ Å。\n按要求四舍五入到四位有效数字，我们得到 $a = 3.000$ Å。\n立方晶格的晶胞体积为 $V = a^3$。\n$V = (3.00000000075 \\text{ Å})^3 = 27.00000000675$ Å$^3$。\n四舍五入到四位有效数字，体积为 $V = 27.00$ Å$^3$。\n确定的晶格是体心立方晶格，其晶格参数 $a = 3.000$ Å。", "answer": "$$\n\\boxed{\\begin{pmatrix} 3.000  27.00 \\end{pmatrix}}\n$$", "id": "2515451"}, {"introduction": "一旦通过指标化确定了候选晶胞，下一步便是精确地精修其晶格参数，同时校正仪器引入的系统误差。虽然我们通常依赖成熟的“黑箱”软件来完成这项任务，但真正的深刻理解源于亲手构建物理模型并实现优化过程。本练习 ([@problem_id:2515523]) 将挑战您编写一个程序，通过非线性最小二乘法对晶格参数、仪器零点漂移和样品位移误差进行同步精修，从而揭示物理模型与数值优化算法之间复杂的相互作用。", "problem": "给定您一份来自美国国家标准与技术研究院（NIST）硅标准的合成粉末X射线衍射峰位数据，该数据是在Bragg–Brentano衍射仪上测量的。您的任务是编写一个程序，通过对测量的$2\\theta$值进行非线性最小二乘法拟合，来精修立方晶格参数$a$，同时精修一个恒定的零点偏移和一个样品位移参数。\n\n从以下基本原理出发：\n- 布拉格定律：$n \\lambda = 2 d \\sin \\theta$，其中$n = 1$。\n- 对于立方晶系，晶面间距为：$d_{hkl}(a) = \\dfrac{a}{\\sqrt{h^2 + k^2 + l^2}}$。\n- 计算出的布拉格角（以弧度为单位）：$\\theta_{hkl}(a) = \\arcsin\\!\\left(\\dfrac{\\lambda}{2 d_{hkl}(a)}\\right)$。\n- 理想的计算位置（以度为单位）：$2\\theta_{B,hkl}(a) = 2 \\, \\theta_{hkl}(a) \\times \\dfrac{180}{\\pi}$。\n- Bragg–Brentano准聚焦几何中的系统误差模型：\n  - 一个恒定的零点偏移（仪器未对准）会对所有$2\\theta$值增加一个均匀的偏移量$z$（以度为单位）。\n  - 一个平坦样品位移$h$（沿垂直于衍射仪轴的方向），对于半径为$R$的衍射仪，产生的峰位偏移为\n    $$\\Delta(2\\theta)_{\\mathrm{disp}} = -\\dfrac{2 h}{R} \\cos\\!\\theta_{hkl}(a),$$\n    其中$\\Delta(2\\theta)_{\\mathrm{disp}}$以弧度为单位。相应的角度偏移为$\\Delta(2\\theta)_{\\mathrm{disp,deg}} = \\Delta(2\\theta)_{\\mathrm{disp}} \\times \\dfrac{180}{\\pi}$。\n- 因此，预测的峰位（以度为单位）为\n  $$2\\theta_{\\mathrm{calc},i}(a,z,h) = 2\\theta_{B,i}(a) + z + \\Delta(2\\theta)_{\\mathrm{disp,deg},i}(a,h).$$\n\n您必须找到$(a, z, h)$以最小化残差平方和\n$$S(a,z,h) = \\sum_{i=1}^{N} \\left[ 2\\theta_{\\mathrm{meas},i} - 2\\theta_{\\mathrm{calc},i}(a,z,h) \\right]^2.$$\n\n角度单位：\n- 所有给定的$2\\theta$值都以度为单位。\n- 在三角函数内部使用弧度。\n- 最终的$z$必须以度为单位报告。\n- 参数$h$必须以毫米（mm）为单位报告。\n- 衍射仪半径$R$以毫米（mm）为单位给出。\n- 波长$\\lambda$以埃（Å）为单位给出。\n- 晶格参数$a$必须以埃（Å）为单位报告。\n\n实现一个针对$(a,z,h)$的稳健的非线性最小二乘法精修。\n\n测试套件：\n- 所有情况的通用常数：\n  - 波长：$\\lambda = 1.5406 \\ \\mathrm{\\AA}$。\n  - 衍射仪半径：$R = 240.0 \\ \\mathrm{mm}$。\n  - 使用的衍射（密勒指数）：$(1,1,1)$, $(2,2,0)$, $(3,1,1)$, $(4,0,0)$, $(3,3,1)$, $(4,2,2)$, $(3,3,3)$, $(4,4,0)$。\n- 情况A（典型的微小正零点和微小正位移）：\n  - 测量的$2\\theta$值（度）：$[28.4167, 47.2802, 56.0978, 69.1087, 76.3544, 88.0186, 94.9368, 106.9185]$。\n- 情况B（负零点偏移，无位移）：\n  - 测量的$2\\theta$值（度）：$[28.4280, 47.2890, 56.1050, 69.1130, 76.3570, 88.0180, 94.9340, 106.9120]$。\n- 情况C（中等正零点，大正位移）：\n  - 测量的$2\\theta$值（度）：$[28.3080, 47.1785, 56.0013, 69.0208, 76.2717, 87.9457, 94.8702, 106.8632]$。\n\n科学现实性和约束条件：\n- 假设材料是具有金刚石立方对称性的硅；只对列出的衍射进行建模。\n- 使用物理上合理的参数边界，例如$a \\in [3.0, 7.0] \\ \\mathrm{\\AA}$，$z \\in [-1.0, 1.0] \\ \\mathrm{deg}$，以及$h \\in [-2.0, 2.0] \\ \\mathrm{mm}$。\n- 使用数值稳定的方法（例如，信赖域算法或Levenberg–Marquardt算法）来解决非线性最小二乘问题。\n\n您的程序必须：\n- 对于每种情况，使用给定的测量$2\\theta$值、$\\lambda$、$R$和指定的衍射组，通过最小化$S(a,z,h)$来精修$(a, z, h)$。\n- 使用初始猜测值$a_0 = 5.43 \\ \\mathrm{\\AA}$，$z_0 = 0.0 \\ \\mathrm{deg}$，$h_0 = 0.0 \\ \\mathrm{mm}$。\n- 生成一行输出，其中包含一个三元组列表，每个测试用例一个三元组，每个三元组的形式为$[a, z, h]$，每个值四舍五入到六位小数，并使用上述指定单位。\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含一个列表的列表形式的结果，例如：\n  - $[[a_A,z_A,h_A],[a_B,z_B,h_B],[a_C,z_C,h_C]]$\n- 每个$a$必须以埃为单位，每个$z$以度为单位，每个$h$以毫米为单位，均四舍五入到六位小数。", "solution": "所述问题具有科学依据，定义明确且完整。它提出了X射线晶体学中的一个标准任务：从粉末衍射数据中精修晶体学和仪器参数。我们将开始解答。\n\n目标是确定立方晶格参数$a$、仪器零点偏移误差$z$和样品位移误差参数$h$的最优值。这些参数（我们可以表示为一个向量$\\mathbf{p} = [a, z, h]$）必须通过精修来最小化测量的二维θ峰位$2\\theta_{\\mathrm{meas},i}$与物理模型计算出的峰位$2\\theta_{\\mathrm{calc},i}(\\mathbf{p})$之间的残差平方和$S(\\mathbf{p})$。目标函数是：\n$$S(a,z,h) = \\sum_{i=1}^{N} \\left[ 2\\theta_{\\mathrm{meas},i} - 2\\theta_{\\mathrm{calc},i}(a,z,h) \\right]^2$$\n其中$N$是观测到的衍射数量。这是一个经典的非线性最小二乘优化问题。解决方案需要构建模型函数$2\\theta_{\\mathrm{calc},i}(a,z,h)$并使用数值算法来找到$S$的最小值。\n\n模型函数$2\\theta_{\\mathrm{calc},i}(a,z,h)$由三个不同的物理部分组成：\n1. 立方晶体结构的理想布拉格峰位$2\\theta_{B,i}(a)$。这源于布拉格定律$n\\lambda = 2d_{hkl}\\sin\\theta$（衍射级数$n=1$），以及立方晶系中晶面间距$d_{hkl}$的公式。\n$$d_{hkl}(a) = \\frac{a}{\\sqrt{h^2+k^2+l^2}}$$\n其中$(h, k, l)$是该衍射的密勒指数。结合这些，理想布拉格角$\\theta_{hkl}$（以弧度为单位）是：\n$$\\theta_{hkl}(a) = \\arcsin\\left(\\frac{\\lambda}{2d_{hkl}(a)}\\right) = \\arcsin\\left(\\frac{\\lambda \\sqrt{h^2+k^2+l^2}}{2a}\\right)$$\n衍射图上的位置以度为单位给出，为$2\\theta_{B,i}(a) = 2 \\times \\theta_{hkl,i}(a) \\times \\frac{180}{\\pi}$。\n\n2. 仪器零点偏移$z$。这是一个恒定的角度偏移，以度为单位，由测角仪的微小未对准引起。它是一个加法项，因此通过将其包含为$2\\theta_{B,i}(a) + z$来改进模型。\n\n3. 样品位移误差$\\Delta(2\\theta)_{\\mathrm{disp,deg}}$。如果平坦样品表面从测角仪的旋转轴位移了距离$h$，就会出现这种系统误差。对于半径为$R$的Bragg-Brentano几何结构，此误差（以度为单位）是布拉格角$\\theta$本身的函数：\n$$\\Delta(2\\theta)_{\\mathrm{disp,deg},i}(a, h) = -\\frac{2h}{R} \\cos(\\theta_{hkl,i}(a)) \\times \\frac{180}{\\pi}$$\n这里使用参数$h$（单位$\\mathrm{mm}$）和$R$（单位$\\mathrm{mm}$），使得比率$h/R$是无量纲的。此误差在低角度时最为显著，因为此时$\\cos(\\theta) \\approx 1$。\n\n将这三个部分结合起来，得到计算峰位的完整模型（以度为单位）：\n$$2\\theta_{\\mathrm{calc},i}(a,z,h) = 2\\theta_{B,i}(a) + z + \\Delta(2\\theta)_{\\mathrm{disp,deg},i}(a, h)$$\n\n为了解决这个最小化问题，我们将实现一个函数，对于给定的参数集$(a, z, h)$，该函数计算所有观测衍射的残差向量$r_i = 2\\theta_{\\mathrm{meas},i} - 2\\theta_{\\mathrm{calc},i}(a,z,h)$。然后将此向量值函数传递给一个数值求解器。`scipy.optimize.least_squares`例程实现了信赖域反射算法，适用于此任务，因为它很稳健并且能处理指定的参数边界：$a \\in [3.0, 7.0] \\ \\mathrm{\\AA}$，$z \\in [-1.0, 1.0] \\ \\mathrm{deg}$，以及$h \\in [-2.0, 2.0] \\ \\mathrm{mm}$。\n\n步骤如下：对于每个测试用例，使用通用常数（$\\lambda = 1.5406 \\ \\mathrm{\\AA}$，$R = 240.0 \\ \\mathrm{mm}$）、密勒指数集、测量的$2\\theta$值、初始参数猜测值（$a_0 = 5.43 \\ \\mathrm{\\AA}$，$z_0 = 0.0 \\ \\mathrm{deg}$，$h_0 = 0.0 \\ \\mathrm{mm}$）以及参数边界来启动求解器。求解器迭代调整$(a, z, h)$，以找到最小化残差平方和的向量。然后报告每种情况的最终精修参数。", "answer": "```python\nimport numpy as np\nfrom scipy.optimize import least_squares\n\ndef solve():\n    \"\"\"\n    Solves for the lattice parameter 'a', zero shift 'z', and specimen\n    displacement 'h' for synthetic powder XRD data using non-linear least squares.\n    \"\"\"\n    # Common constants for all test cases\n    LAMBDA_A = 1.5406  # Wavelength in Angstroms\n    R_MM = 240.0      # Diffractometer radius in millimeters\n\n    # Miller indices for the reflections of silicon\n    HKL_VALUES = np.array([\n        [1, 1, 1], [2, 2, 0], [3, 1, 1], [4, 0, 0],\n        [3, 3, 1], [4, 2, 2], [3, 3, 3], [4, 4, 0]\n    ])\n\n    # Measured 2-theta values for each test case\n    test_cases_data = [\n        # Case A: typical small positive zero and small positive displacement\n        [28.4167, 47.2802, 56.0978, 69.1087, 76.3544, 88.0186, 94.9368, 106.9185],\n        # Case B: negative zero shift, no displacement\n        [28.4280, 47.2890, 56.1050, 69.1130, 76.3570, 88.0180, 94.9340, 106.9120],\n        # Case C: moderate positive zero, large positive displacement\n        [28.3080, 47.1785, 56.0013, 69.0208, 76.2717, 87.9457, 94.8702, 106.8632]\n    ]\n\n    def residuals(params, hkl, two_theta_meas_deg, R, lamb):\n        \"\"\"\n        Calculates the residuals between measured and calculated 2-theta values.\n        \n        Args:\n            params (list): [a, z, h]\n                - a: lattice parameter in Angstroms\n                - z: zero shift in degrees\n                - h: specimen displacement in mm\n            hkl (np.ndarray): Array of Miller indices (h, k, l) for each peak.\n            two_theta_meas_deg (np.ndarray): Array of measured 2-theta values in degrees.\n            R (float): Diffractometer radius in mm.\n            lamb (float): X-ray wavelength in Angstroms.\n            \n        Returns:\n            np.ndarray: Vector of residuals (measured - calculated).\n        \"\"\"\n        a, z, h = params\n        \n        # Calculate ideal Bragg peak positions (2*theta_B)\n        hkl_sq_sum = np.sum(hkl**2, axis=1)\n        \n        # Argument for arcsin: lambda / (2 * d_hkl)\n        # d_hkl = a / sqrt(h^2 + k^2 + l^2)\n        arg = (lamb * np.sqrt(hkl_sq_sum)) / (2 * a)\n\n        # Clip argument to [-1, 1] to prevent domain errors from floating point inaccuracies\n        arg = np.clip(arg, -1.0, 1.0)\n        \n        theta_rad = np.arcsin(arg)\n        two_theta_B_deg = 2 * np.rad2deg(theta_rad)\n        \n        # Calculate specimen displacement error\n        # Delta(2theta) = -(2*h/R)*cos(theta)\n        disp_error_deg = -(2 * h / R) * np.cos(theta_rad) * (180 / np.pi)\n        \n        # Calculate the full model for peak positions\n        two_theta_calc_deg = two_theta_B_deg + z + disp_error_deg\n        \n        return two_theta_meas_deg - two_theta_calc_deg\n\n    results = []\n    initial_guess = [5.43, 0.0, 0.0]  # a_0, z_0, h_0\n    bounds = ([3.0, -1.0, -2.0], [7.0, 1.0, 2.0])  # Lower and upper bounds for a, z, h\n\n    for case_data in test_cases_data:\n        two_theta_meas_np = np.array(case_data)\n        \n        # Perform non-linear least squares optimization\n        opt_result = least_squares(\n            residuals,\n            initial_guess,\n            bounds=bounds,\n            method='trf',  # Trust Region Reflective algorithm\n            args=(HKL_VALUES, two_theta_meas_np, R_MM, LAMBDA_A)\n        )\n        \n        # Extract refined parameters\n        a_refined, z_refined, h_refined = opt_result.x\n        \n        # Store rounded results\n        results.append([\n            round(a_refined, 6),\n            round(z_refined, 6),\n            round(h_refined, 6)\n        ])\n        \n    # Format and print the final output as specified\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2515523"}, {"introduction": "在完成模型精修之后，我们必须对其质量进行客观评估：这个模型究竟有多好？诸如 $R_p$、$R_{wp}$ 和 $\\chi^2$ 等统计指标，是晶体学界公认的用于评价Rietveld精修拟合优度的标准语言。本练习 ([@problem_id:2515463]) 提供了一个通过具体计算来掌握这些R因子的机会，您将从一个微型数据集中亲手计算这些数值，从而深刻理解它们的统计学意义，并学会如何判断一个结构模型是否在实验噪音的限度内充分地解释了衍射数据。", "problem": "对一个包含 $N=10$ 个数据点的窄数据窗口进行了一次粉末衍射图谱的Rietveld精修。假设观测计数服从独立的泊松计数统计，并使用标准的加权最小二乘法，其中权重为 $w_i = 1/\\sigma_i^2$ 且 $\\sigma_i^2 = y_i^{\\mathrm{obs}}$。此窗口中的模型实际上取决于 $P=4$ 个精修参数。这 $10$ 个点的观测计数和计算计数以数对 $\\left(y_i^{\\mathrm{obs}},\\,y_i^{\\mathrm{calc}}\\right)$ 的形式给出：\n- $i=1$: $\\left(120,\\,116\\right)$\n- $i=2$: $\\left(200,\\,210\\right)$\n- $i=3$: $\\left(350,\\,333\\right)$\n- $i=4$: $\\left(500,\\,521\\right)$\n- $i=5$: $\\left(800,\\,780\\right)$\n- $i=6$: $\\left(650,\\,630\\right)$\n- $i=7$: $\\left(400,\\,422\\right)$\n- $i=8$: $\\left(300,\\,289\\right)$\n- $i=9$: $\\left(180,\\,190\\right)$\n- $i=10$: $\\left(100,\\,96\\right)$\n\n仅从独立、正态分布误差（其方差由泊松计数统计给出）的基本最小二乘目标，以及最小化残差平方和相对于自由度的标准统计期望出发，推导非加权谱图残差 $R_p$、加权谱图残差 $R_{wp}$、期望残差 $R_{\\exp}$ 和拟合优度 $\\chi^2$ 的表达式。然后，计算上述数据的 $R_p$、$R_{wp}$、$R_{\\exp}$ 和 $\\chi^2$，并说明按照粉末衍射中使用的常规标准，该模型是否充分解释了此窗口中的实验噪声。\n\n将 $R_p$、$R_{wp}$ 和 $R_{\\exp}$ 报告为无量纲的小数（而非百分比），将 $\\chi^2$ 报告为无量纲数。将所有四个报告量四舍五入至四位有效数字。你的最终答案必须按 $\\left(R_p,\\,R_{wp},\\,R_{\\exp},\\,\\chi^2\\right)$ 的顺序列出这四个值。", "solution": "所述问题具有科学依据、提法明确、客观且自成体系。这是统计分析在Rietveld精修背景下的标准应用，而Rietveld精修是材料化学中的一项核心技术。所提供的数据对于推导和计算所要求的量是充分且一致的。因此，该问题是有效的，并将被解决。\n\n加权最小二乘精修的基本原理是最小化加权残差平方和 $S$。该量定义为：\n$$S = \\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2$$\n在此式中，$N$ 是数据点的数量，$y_i^{\\mathrm{obs}}$ 是在点 $i$ 的观测强度，$y_i^{\\mathrm{calc}}$ 是模型在点 $i$ 的计算强度，$w_i$ 是分配给该点的权重。问题陈述权重由 $w_i = 1/\\sigma_i^2$ 给出，其中 $\\sigma_i^2$ 是观测计数的方差。对于遵循泊松统计的计数实验，计数的方差等于其期望值。在实践中，观测计数 $y_i^{\\mathrm{obs}}$ 被用作其自身方差的最佳估计，因此我们设定 $\\sigma_i^2 = y_i^{\\mathrm{obs}}$。因此，权重为 $w_i = 1/y_i^{\\mathrm{obs}}$。将此代入 $S$ 的表达式中得到：\n$$S = \\sum_{i=1}^{N} \\frac{(y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2}{y_i^{\\mathrm{obs}}}$$\n\n所要求的四个量推导如下：\n\n1.  **非加权谱图残差 ($R_p$)**：这是一个衡量平均分数误差的非加权指标，定义为观测数据与计算数据之间绝对差值之和，再用观测数据之和进行归一化。\n    $$R_p = \\frac{\\sum_{i=1}^{N} |y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}}|}{\\sum_{i=1}^{N} y_i^{\\mathrm{obs}}}$$\n\n2.  **加权谱图残差 ($R_{wp}$)**：这是统计上最重要的残差，因为它与被最小化的量 $S$ 直接相关。其定义为：\n    $$R_{wp} = \\left[ \\frac{\\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2}{\\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}})^2} \\right]^{1/2}$$\n    代入 $w_i = 1/y_i^{\\mathrm{obs}}$，表达式变为：\n    $$R_{wp} = \\left[ \\frac{\\sum_{i=1}^{N} \\frac{(y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2}{y_i^{\\mathrm{obs}}}}{\\sum_{i=1}^{N} \\frac{(y_i^{\\mathrm{obs}})^2}{y_i^{\\mathrm{obs}}}} \\right]^{1/2} = \\left[ \\frac{S}{\\sum_{i=1}^{N} y_i^{\\mathrm{obs}}} \\right]^{1/2}$$\n\n3.  **期望残差 ($R_{\\exp}$)**：这代表了在模型完美且唯一差异仅源于计数统计的情况下，$R_{wp}$ 所能期望达到的理论最小值。最小化平方和的统计期望值是自由度，即观测数 $N$ 减去精修参数个数 $P$。\n    $$E[S] = E\\left[\\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2\\right] = N - P$$\n    将 $R_{wp}$ 公式中的分子替换为其期望值，得到 $R_{\\exp}$：\n    $$R_{\\exp} = \\left[ \\frac{N - P}{\\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}})^2} \\right]^{1/2} = \\left[ \\frac{N - P}{\\sum_{i=1}^{N} y_i^{\\mathrm{obs}}} \\right]^{1/2}$$\n\n4.  **拟合优度 ($\\chi^2$)**：拟合优度，或称卡方，是最小化平方和 $S$ 与其期望值 $N-P$ 的比值。它用作衡量模型对数据中统计噪声解释程度的指标。\n    $$\\chi^2 = \\frac{S}{N - P} = \\frac{\\sum_{i=1}^{N} w_i (y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2}{N - P} = \\left(\\frac{R_{wp}}{R_{\\exp}}\\right)^2$$\n    $\\chi^2$ 值约等于 $1$ 表明拟合在统计上是可靠的。\n\n现在，我们为给定数据计算这些值。已知 $N=10$ 且 $P=4$。\n首先，我们根据所提供的数据对 $(y_i^{\\mathrm{obs}},\\,y_i^{\\mathrm{calc}})$ 计算必要的总和：\n\n-   观测强度之和：\n    $$\\sum_{i=1}^{10} y_i^{\\mathrm{obs}} = 120 + 200 + 350 + 500 + 800 + 650 + 400 + 300 + 180 + 100 = 3600$$\n\n-   绝对差值之和：\n    $$\\sum_{i=1}^{10} |y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}}| = |120-116| + |200-210| + \\dots + |100-96|$$\n    $$= 4 + 10 + 17 + 21 + 20 + 20 + 22 + 11 + 10 + 4 = 139$$\n\n-   最小化加权残差平方和 $S$：\n    $$S = \\sum_{i=1}^{10} \\frac{(y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})^2}{y_i^{\\mathrm{obs}}} = \\frac{4^2}{120} + \\frac{(-10)^2}{200} + \\frac{17^2}{350} + \\frac{(-21)^2}{500} + \\frac{20^2}{800} + \\frac{20^2}{650} + \\frac{(-22)^2}{400} + \\frac{11^2}{300} + \\frac{(-10)^2}{180} + \\frac{4^2}{100}$$\n    $$S \\approx 0.133333 + 0.500000 + 0.825714 + 0.882000 + 0.500000 + 0.615385 + 1.210000 + 0.403333 + 0.555556 + 0.160000 \\approx 5.785321$$\n\n使用这些总和，我们计算这四个指标，并按要求将每个指标四舍五入至四位有效数字：\n\n-   $R_p = \\frac{139}{3600} \\approx 0.0386111 \\approx 0.03861$\n\n-   $R_{wp} = \\left[ \\frac{5.785321}{3600} \\right]^{1/2} = \\left[ 0.00160703 \\right]^{1/2} \\approx 0.0400878 \\approx 0.04009$\n\n-   $R_{\\exp} = \\left[ \\frac{10-4}{3600} \\right]^{1/2} = \\left[ \\frac{6}{3600} \\right]^{1/2} = \\left[ \\frac{1}{600} \\right]^{1/2} \\approx 0.0408248 \\approx 0.04082$\n\n-   $\\chi^2 = \\frac{5.785321}{10-4} = \\frac{5.785321}{6} \\approx 0.964220 \\approx 0.9642$\n\n最后，我们必须评估拟合的质量。成功精修的常规标准是，当拟合优度 $\\chi^2$ 接近于1时，模型能充分解释数据。我们计算出的值为 $\\chi^2 \\approx 0.9642$，确实非常接近 $1$。这表明残差 $(y_i^{\\mathrm{obs}} - y_i^{\\mathrm{calc}})$ 的大小与仅由随机泊松计数统计所预期的结果相符。因此，该模型被认为对此数据窗口中的实验噪声给出了充分的解释。", "answer": "$$\n\\boxed{\\begin{pmatrix} 0.03861  0.04009  0.04082  0.9642 \\end{pmatrix}}\n$$", "id": "2515463"}]}