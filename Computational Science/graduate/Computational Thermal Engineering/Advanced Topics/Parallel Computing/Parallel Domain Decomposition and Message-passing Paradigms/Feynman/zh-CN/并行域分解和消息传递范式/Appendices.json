{
    "hands_on_practices": [
        {
            "introduction": "当我们面对一个计算区域时，首要问题便是：如何将其有效地“切分”给多个处理器？本练习将引导你探索简单的一维分解与更复杂的二维、三维布局之间的优劣权衡。通过这个练习，你将理解区域划分的几何形态、其对应的通信需求，以及每个进程必须与之通信的邻居数量之间的深刻联系。",
            "id": "3977675",
            "problem": "您正在使用结构化网格、单元中心有限体积法以及扩散算子的二阶中心差分格式，对一个矩形固体中的瞬态热传导进行模拟。控制方程为能量守恒方程，\n$$\n\\rho c \\,\\frac{\\partial T}{\\partial t} \\;=\\; \\nabla \\cdot \\big(k \\nabla T\\big) \\;+\\; s,\n$$\n其中材料属性和源项为常数，并在大小为 $N_x \\times N_y \\times N_z$ 的均匀网格上进行离散。求解器通过消息传递接口（MPI）进行并行化，采用非重叠块状区域分解和单层光环层。在 $P$ 个进程上考虑三种分解策略：\n- 一维（$1$D）：$P_x = P$，$P_y = 1$，$P_z = 1$。\n- 二维（$2$D）：$P_x P_y = P$，$P_z = 1$，其中 $P_x > 1$ 且 $P_y > 1$。\n- 三维（$3$D）：$P_x P_y P_z = P$，其中 $P_x > 1$，$P_y > 1$，$P_z > 1$。\n\n假设全局计算域上为非周期性物理边界条件，并且每种情况下都存在内部子域。每个进程通过使用与离散模板一致的最近邻信息，计算其所有控制体表面上的扩散通量，从而推进其局部子域的计算。通信是通过与共享子域面的相邻进程进行光环层交换来实现的。\n\n仅使用基本守恒定律推断和有限体积离散的局部性，完成以下任务：\n- 从 $\\nabla \\cdot (k \\nabla T)$ 的面通量形式出发，解释为什么此模板只需要面相邻的进程间交换，而不需要联系边相邻或角相邻的进程。\n- 通过将每个进程的计算量与子域体积相关联，将每个进程的通信量与子域表面积相关联，定性地比较三种策略的负载均衡和通信模式。结果用 $N_x$、$N_y$、$N_z$、$P_x$、$P_y$ 和 $P_z$ 表示。\n- 推导一个通用表达式，用于表示一个内部进程必须与之交换光环层数据的不同相邻进程的最大数量。该表达式应以计算域被划分的坐标方向数 $d \\in \\{1,2,3\\}$ 来表示。\n\n最后，计算一维、二维和三维分解的最大邻居数量。以行矩阵的形式报告您的最终答案，其元素按 $\\big(1\\text{D},\\,2\\text{D},\\,3\\text{D}\\big)$ 的顺序排列。无需四舍五入。最终答案无需单位。",
            "solution": "出发点是控制体上能量守恒的积分形式。对于一个边界为 $\\partial \\mathcal{V}$、外法线向量为 $\\boldsymbol{n}$ 的控制体 $\\mathcal{V}$，\n$$\n\\rho c \\,\\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{\\mathcal{V}} T \\,\\mathrm{d}V \\;=\\; \\int_{\\partial \\mathcal{V}} k \\nabla T \\cdot \\boldsymbol{n} \\,\\mathrm{d}A \\;+\\; \\int_{\\mathcal{V}} s \\,\\mathrm{d}V.\n$$\n在具有均匀间距的结构化网格上，使用二阶中心差分的单元中心有限体积法时，穿过单元每个面的扩散通量仅使用与该面相邻的两个单元中心温度来近似计算。在笛卡尔坐标系中，这在三维空间中形成一个 $7$点模板，涉及中心单元及其在 $\\pm x$、$\\pm y$ 和 $\\pm z$ 方向上面相邻的邻居。对于这种离散格式，计算不依赖于边相邻或角相邻的单元，因为每个坐标方向上的离散梯度和散度是使用正交面的一维二阶差分独立计算的。\n\n因此，当计算域被划分为带有单层光环层的非重叠子域并分配给各个进程时，一个进程只需要从共享子域面的进程获取数据，而不需要从仅在边或角上相交的进程获取数据。这个结论直接源于 $\\nabla \\cdot (k \\nabla T)$ 的面通量形式和离散化的正交性。\n\n接下来，考虑负载均衡和通信模式。设全局网格为 $N_x \\times N_y \\times N_z$，分解为 $P_x \\times P_y \\times P_z$ 个子域，其中 $P_x P_y P_z = P$。假设 $N_x$、$N_y$ 和 $N_z$ 分别能被 $P_x$、$P_y$ 和 $P_z$ 整除，则每个子域的尺寸为\n$$\nn_x \\;=\\; \\frac{N_x}{P_x}, \\quad n_y \\;=\\; \\frac{N_y}{P_y}, \\quad n_z \\;=\\; \\frac{N_z}{P_z}.\n$$\n每个进程在每个时间步的计算工作量与所拥有的单元数量成正比，即与子域体积成正比，\n$$\nW_{\\text{comp}} \\;\\propto\\; n_x n_y n_z \\;=\\; \\frac{N_x N_y N_z}{P}.\n$$\n因此，对于大小相等的块划分，所有三种策略在单元数量上都实现了完美的负载均衡，即 $W_{\\text{comp}}$ 在所有进程间是相同的。\n\n每个进程在每个时间步的通信量与同其他进程共享的子域面的总面积成正比（因为光环层宽度为 $1$ 个单元）。对于每个分解方向，一个进程会跨越两个相对的面交换一层厚度为 $1$ 个单元的数据。使用指示变量 $\\chi_x, \\chi_y, \\chi_z \\in \\{0,1\\}$ 分别表示分解是否在 $x, y, z$ 方向上划分计算域，则每个进程每个时间步发送或接收的光环单元总数与以下表达式成正比\n$$\nW_{\\text{comm}} \\;\\propto\\; 2\\big(\\chi_x\\, n_y n_z \\;+\\; \\chi_y\\, n_x n_z \\;+\\; \\chi_z\\, n_x n_y\\big).\n$$\n对于一维（$1$D）策略，$(\\chi_x,\\chi_y,\\chi_z)=(1,0,0)$，所以 $W_{\\text{comm}} \\propto 2 n_y n_z$。对于二维（$2$D）策略，$(\\chi_x,\\chi_y,\\chi_z)=(1,1,0)$，得到 $W_{\\text{comm}} \\propto 2(n_y n_z + n_x n_z)$。对于三维（$3$D）策略，$(\\chi_x,\\chi_y,\\chi_z)=(1,1,1)$，得到 $W_{\\text{comm}} \\propto 2(n_y n_z + n_x n_z + n_x n_y)$。因此，增加分解方向的数量会增加通信面（和邻居）的数量，但会减小面的面积，因为随着 $P_x$、$P_y$ 和 $P_z$ 的增加，$n_x$、$n_y$ 和 $n_z$ 会减小。由此产生的通信计算比由子域的表面积与体积的缩放关系决定。\n\n我们现在推导每个进程的最大邻居数。令 $d \\in \\{1,2,3\\}$ 表示计算域在进程间被划分的坐标方向数，即 $(P_x, P_y, P_z)$ 中大于 $1$ 的索引数量。对于一个在 $d$ 个方向上进行划分的分解中的内部子域，沿着每个划分轴的正方向和负方向都恰好有一个邻居。沿着未划分的轴，没有相邻的进程，因为相邻的单元仍在同一进程内。因为模板和光环层只需要面相邻的交换，并且每个划分轴贡献两个共享面的邻居，所以一个内部进程必须与之交换数据的不同相邻进程的最大数量是\n$$\nN_{\\text{nbr,max}}(d) \\;=\\; 2 d.\n$$\n将此公式应用于三种策略：\n- 一维：$d=1 \\Rightarrow N_{\\text{nbr,max}} = 2$。\n- 二维：$d=2 \\Rightarrow N_{\\text{nbr,max}} = 4$。\n- 三维：$d=3 \\Rightarrow N_{\\text{nbr,max}} = 6$。\n\n这些是内部进程的最大邻居数；物理域上的边界进程由于非周期性边界条件而有较少的邻居，但只要 $P_x>1$、$P_y>1$、$P_z>1$（视具体策略而定）的条件满足，最大值仍然是 $2d$。",
            "answer": "$$\\boxed{\\begin{pmatrix} 2  4  6 \\end{pmatrix}}$$"
        },
        {
            "introduction": "在理解了不同分解方式会导致不同通信模式的基础上，本练习将带你解决一个真实的优化问题。你将学习如何将“最小化通信”这一目标形式化为一个数学优化函数，并在一系列实际约束下，找出最优的区域剖分策略。这个过程将具体展示并行计算中最小化子区域“表面积-体积比”这一关键原则。",
            "id": "3977764",
            "problem": "考虑一个尺寸为 $L_{x} = 0.96$ 米、$L_{y} = 0.64$ 米、$L_{z} = 0.32$ 米的矩形固体中的三维瞬态热传导，其导热系数是均匀且各向同性的。该区域被一个包含 $N_{x} = 192$、$N_{y} = 128$、$N_{z} = 64$ 个单元的均匀正交网格离散化，使得 $L_{x} = N_{x}\\,\\Delta x$，$L_{y} = N_{y}\\,\\Delta y$，$L_{z} = N_{z}\\,\\Delta z$，且 $\\Delta x = \\Delta y = \\Delta z$。一个标准的二阶、以单元为中心的有限体积法更新将每个内部单元与其六个面相邻的邻居耦合起来。并行化通过消息传递接口（MPI）执行，采用块结构化区域分解，沿 $x$、$y$ 和 $z$ 轴分别分解为 $a$、$b$ 和 $c$ 个分区，满足 $a\\,b\\,c = P$（其中 $P = 96$）以及整数网格划分约束 $a \\mid N_{x}$、$b \\mid N_{y}$ 和 $c \\mid N_{z}$。\n\n每个子域为邻居交换维护一个宽度为 $w = 1$ 个单元的晕环。在每个显式时间步，相邻子域之间的每个内部界面都需要发送和接收晕环数据，其数量与该界面上的面单元数成正比。假设每个时间步在每个方向的每个内部面上进行一次双向最近邻交换。\n\n从离散化守恒定律的基本原理和块分解的几何结构出发，推导一个表达式，用于表示所有进程在每个时间步总共通信的晕环单元数，该表达式是 $(a,b,c)$ 和 $(N_{x},N_{y},N_{z})$ 的函数。使用此表达式确定在所述约束下使总内部界面度量最小化的整数三元组 $(a,b,c)$。设基准情况为沿 $x$ 轴的一维板状分解，即 $(a,b,c) = (96,1,1)$。\n\n计算无量纲缩减因子 $R$，其定义为最优 $(a,b,c)$ 的总晕环单元数除以基准板状分解的总晕环单元数。将 $R$ 的最终值表示为单个分数。无需四舍五入。答案必须是无量纲的；不要包含单位。",
            "solution": "每个时间步通信的总晕环单元数与总内部界面面积 $S_{internal}$ 成正比。我们的目标是最小化该面积。该区域被 $a-1$ 个垂直于 $x$ 轴的界面平面、$b-1$ 个垂直于 $y$ 轴的平面和 $c-1$ 个垂直于 $z$ 轴的平面所分割。总内部界面面积是所有这些界面平面面积的总和：\n$$S_{internal}(a,b,c) = (a-1)N_y N_z + (b-1)N_x N_z + (c-1)N_x N_y$$\n最小化 $S_{internal}$ 等同于最小化函数 $g(a,b,c) = a N_y N_z + b N_x N_z + c N_x N_y$。\n代入 $N_x = 192$, $N_y = 128$, $N_z = 64$：\n$N_y N_z = 128 \\times 64 = 8192$。\n$N_x N_z = 192 \\times 64 = 12288$。\n$N_x N_y = 192 \\times 128 = 24576$。\n\n我们最小化 $g(a,b,c) = 8192a + 12288b + 24576c$。这等同于最小化辅助函数 $H(a,b,c)$，通过提出最大公约数 $4096$ 得到：\n$$H(a,b,c) = 2a + 3b + 6c$$\n最小化受以下约束条件限制：\n1.  $a, b, c \\in \\mathbb{Z}^+$。\n2.  $abc = 96$。\n3.  $a|192$, $b|128$, $c|64$。\n\n由于 $96=2^5 \\times 3$，而 $128=2^7$ 和 $64=2^6$，约束 $b \\mid 128$ 和 $c \\mid 64$ 意味着 $b$ 和 $c$ 必须是 $2$ 的幂。因此，因子 $3$ 必须属于 $a$。另外，任何 $96$ 的因子 $a$ 都自动满足 $a \\mid 192$（因为 $192 = 2 \\times 96$）。\n\n我们系统地测试 $a$ 的可能值（$96$ 的因子中是 $3$ 的倍数），并找到最小化 $H(a,b,c)$ 的组合 $(a,b,c)$。\n-   如果 $a=3$，则 $bc=32$。我们测试满足 $b|128, c|64$ 的数对 $(b,c)$：\n    - $(3,8,4): H = 2(3)+3(8)+6(4) = 6+24+24 = 54$。\n    - $(3,4,8): H = 2(3)+3(4)+6(8) = 6+12+48 = 66$。\n-   如果 $a=6$，则 $bc=16$：\n    - $(6,8,2): H = 2(6)+3(8)+6(2) = 12+24+12 = 48$。\n    - $(6,4,4): H = 2(6)+3(4)+6(4) = 12+12+24 = 48$。\n-   如果 $a=12$，则 $bc=8$：\n    - $(12,4,2): H = 2(12)+3(4)+6(2) = 24+12+12 = 48$。\n    - $(12,2,4): H = 2(12)+3(2)+6(4) = 24+6+24 = 54$。\n-   如果 $a=24$，则 $bc=4$：\n    - $(24,2,2): H = 2(24)+3(2)+6(2) = 48+6+12 = 66$。\n-   如果 $a=48$，则 $bc=2$：\n    - $(48,2,1): H = 2(48)+3(2)+6(1) = 96+6+6 = 108$。\n-   如果 $a=96$，则 $bc=1$：\n    - $(96,1,1): H = 2(96)+3(1)+6(1) = 192+3+6 = 201$。这是基准情况。\n\n$H(a,b,c)$ 的最小值为 $48$，由三元组 $(6,4,4)$、$(6,8,2)$ 和 $(12,4,2)$ 达成。这些中的任何一个都代表了最优分解。\n\n现在我们计算缩减因子 $R$。$R$ 是最优情况与基准情况的总晕环单元数的比值，这等同于 $S_{internal}$ 的比值。\n$$R = \\frac{S_{internal, optimal}}{S_{internal, baseline}}$$\n对于最优情况，例如 $(a,b,c) = (6,4,4)$：\n$$S_{opt} = (6-1)N_y N_z + (4-1)N_x N_z + (4-1)N_x N_y$$\n$$S_{opt} = 5(128 \\times 64) + 3(192 \\times 64) + 3(192 \\times 128)$$\n$$S_{opt} = 5(8192) + 3(12288) + 3(24576) = 40960 + 36864 + 73728 = 151552$$\n对于基准情况 $(a,b,c) = (96,1,1)$：\n$$S_{base} = (96-1)N_y N_z + (1-1)N_x N_z + (1-1)N_x N_y$$\n$$S_{base} = 95(128 \\times 64) = 95(8192) = 778240$$\n缩减因子是该比率：\n$$R = \\frac{151552}{778240}$$\n为简化分数，我们将 $S_{opt}$ 和 $S_{base}$ 表示为它们的因数形式：\n$S_{opt} = 5(2^{13}) + 3(3 \\times 2^{12}) + 3(3 \\times 2^{13}) = 10 \\cdot 2^{12} + 9 \\cdot 2^{12} + 18 \\cdot 2^{12} = (10+9+18) \\cdot 2^{12} = 37 \\cdot 2^{12}$。\n$S_{base} = 95 \\cdot 2^{13} = 190 \\cdot 2^{12}$。\n现在，我们计算比率 $R$：\n$$R = \\frac{37 \\cdot 2^{12}}{190 \\cdot 2^{12}} = \\frac{37}{190}$$\n由于 $37$ 是质数，且不能整除 $190 = 2 \\times 5 \\times 19$，因此该分数是最简分数。",
            "answer": "$$\\boxed{\\frac{37}{190}}$$"
        },
        {
            "introduction": "设计出最优的分解方案后，关键的一步是量化其实际的通信负载。本练习将带你从抽象的区域划分几何结构，深入到消息传递的具体细节。你需要精确计算出相邻进程间必须交换的数据包（即“光环”区域）的大小。这项技能对于预测和分析并行代码的性能至关重要。",
            "id": "3977761",
            "problem": "考虑一个瞬态热传导问题，由三维热方程 $\\frac{\\partial T}{\\partial t} = \\nabla \\cdot \\left(k \\nabla T \\right)$ 控制，其中 $T$ 是温度，$k$ 是热导率。该问题在结构化笛卡尔网格上使用空间上的二阶中心差分和单步显式时间积分进行离散。每个内部控制体的离散空间算子需要沿 $\\pm x$、$\\pm y$ 和 $\\pm z$ 方向的紧邻值来计算温度梯度并更新 $T$。计算域是一个在 $x$、$y$ 和 $z$ 方向上具有周期性边界的长方体，全局网格尺寸为 $N_x = 384$、$N_y = 256$ 和 $N_z = 192$ 个控制体。该网格通过一个笛卡尔进程网格划分为 $P_x = 8$、$P_y = 4$ 和 $P_z = 6$ 个进程，每个进程拥有一个大小相等的局部内部块。每个局部块在其 6 个面上各维护一个鬼单元层（晕环厚度 $h = 1$），以支持模板计算。温度场以双精度存储，每个标量值占用 8 字节。\n\n这些进程排列在一个周期性的笛卡尔拓扑中，该拓扑使用消息传递接口（MPI）构建，特别是使用了在所有三个维度上都启用周期性的消息传递接口（MPI）笛卡尔通信器。在每个时间积分阶段的一次晕环交换步骤中，每个进程必须与其 6 个周期性邻居（$-x$、$+x$、$-y$、$+y$、$-z$、$+z$）交换其与面齐平的晕环数据。假设使用派生数据类型或连续打包，使得每个面消息恰好包含厚度为 $h$ 的与面齐平的晕环薄层，且没有额外的填充。晕环交换使用非阻塞调度进行成对的邻居通信，并通过同步来完成，以确保在更新前数据可用。\n\n从域分解的基本原理和离散算子的要求出发，推导通信调度并计算单个晕环交换步骤中每个邻居的消息大小。使用以下基本事实：每个进程的局部内部尺寸为 $n_x = N_x / P_x$、$n_y = N_y / P_y$ 和 $n_z = N_z / P_z$，并且在方向 $d \\in \\{x, y, z\\}$ 上的一个与面齐平的晕环消息包含 $h$ 层相应的面，其横截面积等于另外两个局部维度的乘积。将每个消息的大小以字节表示，即该与面齐平的晕环中的标量值总数乘以 $8$。\n\n答案规格：\n- 按以下固定顺序提供消息大小：$\\left[-x,\\ +x,\\ -y,\\ +y,\\ -z,\\ +z\\right]$。\n- 以字节表示最终答案。\n- 无需四舍五入；计算精确的整数值。",
            "solution": "控制方程 $\\frac{\\partial T}{\\partial t} = \\nabla \\cdot \\left(k \\nabla T \\right)$ 使用二阶中心差分离散化后，在三维空间中产生一个七点模板，其中，给定控制体上 $T$ 的每次内部更新都依赖于其在 $\\pm x$、$\\pm y$ 和 $\\pm z$ 方向上紧邻邻居处的 $T$ 值。在一个分解为块的域上，每个进程必须在其局部内部区域周围维护一个鬼单元层（$h = 1$），以便为邻近进程边界的内部单元上的模板计算提供邻居值。由于所有三个方向都具有周期性边界，每个局部块的每个面都与另一个块相邻，因此所有六个面都需要进行晕环交换。\n\n我们如下构建并行分解和邻居关系。全局网格使用带有周期性边界条件的 MPI 笛卡尔拓扑被划分为 $P_x = 8$、$P_y = 4$ 和 $P_z = 6$ 个进程。建立此拓扑的消息传递接口（MPI）例程会生成一个通信器，其中每个等级（rank）通过 MPI 笛卡尔平移在 $\\pm x$、$\\pm y$ 和 $\\pm z$ 方向上都有明确定义的邻居。由于分解是均匀的，每个进程的局部内部尺寸为\n$$\nn_x = \\frac{N_x}{P_x} = \\frac{384}{8} = 48,\\quad\nn_y = \\frac{N_y}{P_y} = \\frac{256}{4} = 64,\\quad\nn_z = \\frac{N_z}{P_z} = \\frac{192}{6} = 32.\n$$\n给定晕环厚度 $h = 1$，在方向 $d \\in \\{x, y, z\\}$ 上的每个与面齐平的晕环消息由 $h$ 层相应的面组成，其横截面积等于另外两个局部维度的乘积。因此，每个面消息的标量值数量为：\n- 对于 $x$ 方向的面，横截面积为 $n_y \\times n_z$，晕环厚度贡献一个因子 $h$；因此值的数量为\n$$\nN_{\\text{vals},x} = h \\, n_y \\, n_z = 1 \\times 64 \\times 32 = 2048.\n$$\n- 对于 $y$ 方向的面，横截面积为 $n_x \\times n_z$，所以\n$$\nN_{\\text{vals},y} = h \\, n_x \\, n_z = 1 \\times 48 \\times 32 = 1536.\n$$\n- 对于 $z$ 方向的面，横截面积为 $n_x \\times n_y$，所以\n$$\nN_{\\text{vals},z} = h \\, n_x \\, n_y = 1 \\times 48 \\times 64 = 3072.\n$$\n每个标量值在双精度下占用 8 字节，因此相应的消息大小（以字节为单位）为：\n$$\nS_x = N_{\\text{vals},x} \\times 8 = 2048 \\times 8 = 16384,\n$$\n$$\nS_y = N_{\\text{vals},y} \\times 8 = 1536 \\times 8 = 12288,\n$$\n$$\nS_z = N_{\\text{vals},z} \\times 8 = 3072 \\times 8 = 24576.\n$$\n由于分解是均匀的，并且周期性拓扑保证了对称的邻居关系，所以 $-x$ 和 $+x$ 邻居的消息大小均为 $S_x$，类似地，$-y$ 和 $+y$ 的消息大小均为 $S_y$，$-z$ 和 $+z$ 的消息大小均为 $S_z$。\n\n一个正确的单次晕环交换步骤的非阻塞通信调度可以概述如下：\n1. 使用 MPI 笛卡尔通信器，通过调用 MPI 笛卡尔平移来获取每个方向上的邻居等级。对于每个等级，将其邻居标识为 $r_{-x}$、$r_{+x}$、$r_{-y}$、$r_{+y}$、$r_{-z}$ 和 $r_{+z}$。\n2. 使用 $\\text{MPI\\_Irecv}$ 为每个传入的面晕环发布非阻塞接收，并为局部块中的目标鬼单元层指定适当的缓冲区：从 $r_{-x}$、$r_{+x}$、$r_{-y}$、$r_{+y}$、$r_{-z}$ 和 $r_{+z}$ 各接收一个。\n3. 使用 $\\text{MPI\\_Isend}$ 为每个传出的面晕环发布非阻塞发送，并使用局部内部相应边界层中的源缓冲区：向 $r_{+x}$（将其 $+x$ 面提供给其 $-x$ 鬼单元层）、$r_{-x}$、$r_{+y}$、$r_{-y}$、$r_{+z}$ 和 $r_{-z}$ 各发送一个。在整个过程中，采用面薄层的连续打包或派生数据类型（例如 $\\text{MPI\\_Type\\_create\\_subarray}$）来描述无填充的与面齐平的晕环，以确保消息在方向 $d$ 上恰好包含 $N_{\\text{vals},d}$ 个条目。\n4. 对所有已发布的请求使用 $\\text{MPI\\_Waitall}$ 进行同步完成，以确保在计算下一次更新之前晕环数据可用。\n\n上述计算的大小直接源于为七点模板提供单层面晕环的需求以及均匀的块尺寸。按 $\\left[-x,\\ +x,\\ -y,\\ +y,\\ -z,\\ +z\\right]$ 顺序排列，消息大小（以字节为单位）为 $\\left[S_x,\\ S_x,\\ S_y,\\ S_y,\\ S_z,\\ S_z\\right] = \\left[16384,\\ 16384,\\ 12288,\\ 12288,\\ 24576,\\ 24576\\right]$。",
            "answer": "$$\\boxed{\\begin{pmatrix}16384  16384  12288  12288  24576  24576\\end{pmatrix}}$$"
        }
    ]
}