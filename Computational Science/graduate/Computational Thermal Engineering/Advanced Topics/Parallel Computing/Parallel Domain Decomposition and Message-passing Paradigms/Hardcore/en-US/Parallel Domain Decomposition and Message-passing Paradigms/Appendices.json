{
    "hands_on_practices": [
        {
            "introduction": "Choosing a domain decomposition strategy is a foundational step in parallelizing a simulation. This first practice invites you to compare one-, two-, and three-dimensional decompositions, building an intuition for how the shape of subdomains impacts communication requirements. By analyzing the number of neighbors each process must communicate with, you will explore the critical relationship between subdomain volume (computation) and surface area (communication) that governs parallel performance .",
            "id": "3977675",
            "problem": "You are simulating transient heat conduction in a rectangular solid using a structured grid and a cell-centered finite volume method with a second-order central difference discretization of the diffusion operator. The governing equation is the conservation of energy,\n$$\n\\rho c \\,\\frac{\\partial T}{\\partial t} \\;=\\; \\nabla \\cdot \\big(k \\nabla T\\big) \\;+\\; s,\n$$\nwith constant material properties and a source term, discretized on a uniform grid of size $N_x \\times N_y \\times N_z$. The solver is parallelized with the Message Passing Interface (MPI) via non-overlapping block domain decomposition and single-cell halo layers. Three decomposition strategies are considered on $P$ ranks:\n- One-dimensional ($1$D): $P_x = P$, $P_y = 1$, $P_z = 1$.\n- Two-dimensional ($2$D): $P_x P_y = P$, $P_z = 1$, with $P_x > 1$ and $P_y > 1$.\n- Three-dimensional ($3$D): $P_x P_y P_z = P$, with $P_x > 1$, $P_y > 1$, $P_z > 1$.\n\nAssume non-periodic physical boundary conditions on the global domain, and that interior subdomains exist in each case. Each rank advances its local subdomain by computing diffusive fluxes across all of its control volume faces using nearest-neighbor information consistent with the discretization stencil. Communication is implemented via halo exchanges with neighboring ranks that share a subdomain face.\n\nUsing only fundamental conservation-law reasoning and the locality of the finite volume discretization, carry out the following:\n- Explain, from the face-flux form of $\\nabla \\cdot (k \\nabla T)$, why only face-adjacent inter-rank exchanges are required for this stencil and why edge- or corner-adjacent ranks do not need to be contacted.\n- Compare qualitatively the load balance and the communication patterns across the three strategies by relating the per-rank computation to the subdomain volume and the per-rank communication to the subdomain surface area, expressed in terms of $N_x$, $N_y$, $N_z$, $P_x$, $P_y$, and $P_z$.\n- Derive a general expression for the maximum number of distinct neighboring ranks with which an interior rank must exchange halo data, in terms of the number $d \\in \\{1,2,3\\}$ of coordinate directions along which the domain is partitioned.\n\nFinally, compute the maximum neighbor count for the one-, two-, and three-dimensional decompositions. Report your final answer as a row matrix with entries ordered as $\\big(1\\text{D},\\,2\\text{D},\\,3\\text{D}\\big)$. No rounding is required. No units are required for the final answer.",
            "solution": "The starting point is the conservation of energy in integral form over a control volume. For a control volume $\\mathcal{V}$ with boundary $\\partial \\mathcal{V}$ and outward normal $\\boldsymbol{n}$,\n$$\n\\rho c \\,\\frac{\\mathrm{d}}{\\mathrm{d} t}\\int_{\\mathcal{V}} T \\,\\mathrm{d}V \\;=\\; \\int_{\\partial \\mathcal{V}} k \\nabla T \\cdot \\boldsymbol{n} \\,\\mathrm{d}A \\;+\\; \\int_{\\mathcal{V}} s \\,\\mathrm{d}V.\n$$\nOn a structured grid with uniform spacing and a cell-centered finite volume method using second-order central differences, the diffusive flux through each face of a cell is approximated using only the two cell-centered temperatures adjacent to that face. In Cartesian coordinates, this leads to a $7$-point stencil in three dimensions, involving the central cell and its face-adjacent neighbors in the $\\pm x$, $\\pm y$, and $\\pm z$ directions. There is no dependence on edge- or corner-adjacent cells for this discretization because the discrete gradient and divergence in each coordinate direction are computed independently using one-dimensional second-order differences on orthogonal faces.\n\nTherefore, when the domain is partitioned among ranks into non-overlapping subdomains with single-cell halos, a rank needs data only from ranks that share a subdomain face, not from ranks that meet only along an edge or a corner. This conclusion follows directly from the face-flux form of $\\nabla \\cdot (k \\nabla T)$ and the orthogonality of the discretization.\n\nNext, consider load balance and communication patterns. Let the global grid be $N_x \\times N_y \\times N_z$, decomposed into $P_x \\times P_y \\times P_z$ subdomains, with $P_x P_y P_z = P$. Assuming $N_x$, $N_y$, and $N_z$ are divisible by $P_x$, $P_y$, and $P_z$, respectively, each subdomain has dimensions\n$$\nn_x \\;=\\; \\frac{N_x}{P_x}, \\quad n_y \\;=\\; \\frac{N_y}{P_y}, \\quad n_z \\;=\\; \\frac{N_z}{P_z}.\n$$\nThe per-rank computational work per time step scales with the number of owned cells, proportional to the subdomain volume,\n$$\nW_{\\text{comp}} \\;\\propto\\; n_x n_y n_z \\;=\\; \\frac{N_x N_y N_z}{P}.\n$$\nHence, for equal-sized block partitions, all three strategies achieve perfect load balance in terms of cell counts, i.e., $W_{\\text{comp}}$ is identical across ranks.\n\nThe per-rank communication per time step scales with the total area of subdomain faces that are shared with other ranks (since the halo width is $1$ cell). For each decomposed direction, a rank exchanges a layer of thickness $1$ cell across two opposite faces. Using indicator variables $\\chi_x, \\chi_y, \\chi_z \\in \\{0,1\\}$ that denote whether the decomposition splits the domain in the $x$, $y$, $z$ directions, respectively, the total number of halo cells sent or received per rank per time step scales as\n$$\nW_{\\text{comm}} \\;\\propto\\; 2\\big(\\chi_x\\, n_y n_z \\;+\\; \\chi_y\\, n_x n_z \\;+\\; \\chi_z\\, n_x n_y\\big).\n$$\nFor the one-dimensional ($1$D) strategy, $(\\chi_x,\\chi_y,\\chi_z)=(1,0,0)$, so $W_{\\text{comm}} \\propto 2 n_y n_z$. For the two-dimensional ($2$D) strategy, $(\\chi_x,\\chi_y,\\chi_z)=(1,1,0)$, giving $W_{\\text{comm}} \\propto 2(n_y n_z + n_x n_z)$. For the three-dimensional ($3$D) strategy, $(\\chi_x,\\chi_y,\\chi_z)=(1,1,1)$, yielding $W_{\\text{comm}} \\propto 2(n_y n_z + n_x n_z + n_x n_y)$. Thus, increasing the number of decomposition directions increases the number of communicating faces (and neighbors), but reduces the face areas because $n_x$, $n_y$, and $n_z$ decrease as $P_x$, $P_y$, and $P_z$ increase. The resulting communication-to-computation ratio is governed by the surface-to-volume scaling of subdomains.\n\nWe now derive the maximum neighbor count per rank. Let $d \\in \\{1,2,3\\}$ denote the number of coordinate directions along which the domain is partitioned among ranks, i.e., the number of indices among $(P_x, P_y, P_z)$ that exceed $1$. For an interior subdomain in a decomposition that splits $d$ directions, there is exactly one neighbor in the positive and one in the negative direction along each split axis. Along an unsplit axis, there is no neighboring rank because the neighboring cells remain within the same rank. Because the stencil and halo only require face-adjacent exchanges, and each split axis contributes two face-sharing neighbors, the maximum number of distinct neighboring ranks that an interior rank must exchange with is\n$$\nN_{\\text{nbr,max}}(d) \\;=\\; 2 d.\n$$\nApplying this to the three strategies:\n- One-dimensional: $d=1 \\Rightarrow N_{\\text{nbr,max}} = 2$.\n- Two-dimensional: $d=2 \\Rightarrow N_{\\text{nbr,max}} = 4$.\n- Three-dimensional: $d=3 \\Rightarrow N_{\\text{nbr,max}} = 6$.\n\nThese are maximum counts for interior ranks; boundary ranks on the physical domain have fewer neighbors due to non-periodic boundary conditions, but the maximum remains $2 d$ provided $P_x>1$, $P_y>1$, $P_z>1$ as applicable to the strategy.",
            "answer": "$$\\boxed{\\begin{pmatrix} 2 & 4 & 6 \\end{pmatrix}}$$"
        },
        {
            "introduction": "Building on the concept of neighbor communication, this exercise makes the abstract idea of communication cost concrete. You will determine the exact size of the \"halo\" data that must be exchanged between processes in a specific 3D decomposition . This practice is essential for estimating communication overhead and understanding the practical implementation of a message-passing algorithm.",
            "id": "3977761",
            "problem": "Consider a transient heat conduction problem governed by the three-dimensional heat equation $\\frac{\\partial T}{\\partial t} = \\nabla \\cdot \\left(k \\nabla T \\right)$, where $T$ is temperature and $k$ is thermal conductivity, discretized on a structured Cartesian grid using second-order central differences in space and a single-stage explicit time integration. The discrete spatial operator for each interior control volume requires immediate neighbor values along the $\\pm x$, $\\pm y$, and $\\pm z$ directions to compute temperature gradients and update $T$. The computational domain is a rectangular prism with periodic boundaries along $x$, $y$, and $z$, and the global mesh dimensions are $N_x = 384$, $N_y = 256$, and $N_z = 192$ control volumes. The mesh is partitioned by a Cartesian process grid into $P_x = 8$, $P_y = 4$, and $P_z = 6$ processes, respectively, each owning a local interior block of equal size. Each local block maintains one ghost-cell layer (halo thickness $h = 1$) on each of its $6$ faces to support the stencil. The temperature field is stored in double precision, with each scalar value occupying $8$ bytes.\n\nThe processes are arranged in a periodic Cartesian topology constructed using the Message Passing Interface (MPI), specifically an MPI Cartesian communicator with periodicity enabled in all three dimensions. In one halo-exchange step per time integration stage, each process must exchange its face-aligned halo data with its $6$ periodic neighbors ($-x$, $+x$, $-y$, $+y$, $-z$, $+z$). Assume derived datatypes or contiguous packing such that each face message contains exactly the face-aligned halo slab of thickness $h$ and no additional padding. The halo exchange uses a nonblocking schedule with pairwise neighbor communication and completes with a synchronization to ensure data availability before the update.\n\nStarting from first principles of domain decomposition and the requirements of the discrete operator, derive the communication schedule and compute the message size per neighbor for a single halo-exchange step. Use the following base facts: the local interior dimensions per process are $n_x = N_x / P_x$, $n_y = N_y / P_y$, and $n_z = N_z / P_z$, and a face-aligned halo message in direction $d \\in \\{x, y, z\\}$ contains $h$ layers of the corresponding face with cross-sectional area equal to the product of the other two local dimensions. Express each message size in bytes as the total number of scalar values in that face-aligned halo multiplied by $8$.\n\nAnswer specification:\n- Provide the message sizes in the following fixed order: $\\left[-x,\\ +x,\\ -y,\\ +y,\\ -z,\\ +z\\right]$.\n- Express the final answer in bytes.\n- No rounding is necessary; compute exact integer values.",
            "solution": "The governing equation $\\frac{\\partial T}{\\partial t} = \\nabla \\cdot \\left(k \\nabla T \\right)$ discretized with second-order central differences yields a seven-point stencil in three dimensions, where each interior update of $T$ at a given control volume depends on $T$ at its immediate neighbors in the $\\pm x$, $\\pm y$, and $\\pm z$ directions. On a domain decomposed into blocks, each process must maintain one ghost-cell layer ($h = 1$) around its local interior to supply neighbor values for the stencil at interior cells adjacent to process boundaries. With periodic boundaries in all three directions, every face of each local block is adjacent to another block, and halo exchange is required for all six faces.\n\nWe construct the parallel decomposition and neighbor relations as follows. The global mesh is divided into $P_x = 8$, $P_y = 4$, and $P_z = 6$ processes using an MPI Cartesian topology with periodic boundary conditions. The MPI routine that establishes this topology produces a communicator in which each rank has well-defined neighbors in the $\\pm x$, $\\pm y$, and $\\pm z$ directions via MPI Cartesian shifts. Because the decomposition is uniform, the local interior dimensions per process are\n$$\nn_x = \\frac{N_x}{P_x} = \\frac{384}{8} = 48,\\quad\nn_y = \\frac{N_y}{P_y} = \\frac{256}{4} = 64,\\quad\nn_z = \\frac{N_z}{P_z} = \\frac{192}{6} = 32.\n$$\nGiven a halo thickness $h = 1$, each face-aligned halo message in direction $d \\in \\{x, y, z\\}$ consists of $h$ layers of the corresponding face, with cross-sectional area equal to the product of the other two local dimensions. The number of scalar values per face message is therefore:\n- For the $x$-direction faces, the cross-sectional area is $n_y \\times n_z$, and the halo thickness contributes a factor $h$; thus the number of values is\n$$\nN_{\\text{vals},x} = h \\, n_y \\, n_z = 1 \\times 64 \\times 32 = 2048.\n$$\n- For the $y$-direction faces, the cross-sectional area is $n_x \\times n_z$, so\n$$\nN_{\\text{vals},y} = h \\, n_x \\, n_z = 1 \\times 48 \\times 32 = 1536.\n$$\n- For the $z$-direction faces, the cross-sectional area is $n_x \\times n_y$, so\n$$\nN_{\\text{vals},z} = h \\, n_x \\, n_y = 1 \\times 48 \\times 64 = 3072.\n$$\nEach scalar value occupies $8$ bytes in double precision, so the corresponding message sizes in bytes are:\n$$\nS_x = N_{\\text{vals},x} \\times 8 = 2048 \\times 8 = 16384,\n$$\n$$\nS_y = N_{\\text{vals},y} \\times 8 = 1536 \\times 8 = 12288,\n$$\n$$\nS_z = N_{\\text{vals},z} \\times 8 = 3072 \\times 8 = 24576.\n$$\nBecause the decomposition is uniform and the periodic topology guarantees symmetric neighbor relationships, the sizes for the $-x$ and $+x$ neighbors are both $S_x$, similarly for $-y$ and $+y$ both $S_y$, and for $-z$ and $+z$ both $S_z$.\n\nA correct nonblocking communication schedule for one halo-exchange step can be outlined as follows:\n1. Use the MPI Cartesian communicator to obtain neighbor ranks in each direction using MPI Cartesian shift calls. For each rank, let the neighbors be identified as $r_{-x}$, $r_{+x}$, $r_{-y}$, $r_{+y}$, $r_{-z}$, and $r_{+z}$.\n2. Post nonblocking receives for each incoming face halo using $\\text{MPI\\_Irecv}$ with the appropriate buffer regions for the destination ghost layers in the local block: one receive from each of $r_{-x}$, $r_{+x}$, $r_{-y}$, $r_{+y}$, $r_{-z}$, and $r_{+z}$.\n3. Post nonblocking sends for each outgoing face halo using $\\text{MPI\\_Isend}$ with the source buffer regions in the corresponding boundary layers of the local interior: one send to each of $r_{+x}$ (providing the $+x$ face to its $-x$ ghost layer), $r_{-x}$, $r_{+y}$, $r_{-y}$, $r_{+z}$, and $r_{-z}$. Throughout, employ either contiguous packing of face slabs or derived datatypes (for example, $\\text{MPI\\_Type\\_create\\_subarray}$) to describe the face-aligned halo without padding so that the message contains exactly $N_{\\text{vals},d}$ entries in direction $d$.\n4. Synchronize completion with $\\text{MPI\\_Waitall}$ on all posted requests to ensure that the halo data is available before computing the next update.\n\nThe sizes computed above directly follow from the need to furnish one-layer face halos for a seven-point stencil and the uniform block dimensions. Ordered as $\\left[-x,\\ +x,\\ -y,\\ +y,\\ -z,\\ +z\\right]$, the message sizes in bytes are $\\left[S_x,\\ S_x,\\ S_y,\\ S_y,\\ S_z,\\ S_z\\right] = \\left[16384,\\ 16384,\\ 12288,\\ 12288,\\ 24576,\\ 24576\\right]$.",
            "answer": "$$\\boxed{\\begin{pmatrix}16384 & 16384 & 12288 & 12288 & 24576 & 24576\\end{pmatrix}}$$"
        },
        {
            "introduction": "With an understanding of how to quantify communication, the next logical step is to minimize it. This culminating practice challenges you to find the optimal decomposition for a given number of processors by treating the total communication volume as an objective function to be minimized . This exercise synthesizes the principles of the previous problems and introduces the practical skill of performance modeling to design an efficient parallel algorithm.",
            "id": "3977764",
            "problem": "Consider three-dimensional transient heat conduction in a rectangular solid of lengths $L_{x} = 0.96$ m, $L_{y} = 0.64$ m, and $L_{z} = 0.32$ m, with uniform and isotropic thermal conductivity. The domain is discretized with a uniform orthogonal mesh of $N_{x} = 192$, $N_{y} = 128$, $N_{z} = 64$ cells, such that $L_{x} = N_{x}\\,\\Delta x$, $L_{y} = N_{y}\\,\\Delta y$, and $L_{z} = N_{z}\\,\\Delta z$, with $\\Delta x = \\Delta y = \\Delta z$. A standard second-order, cell-centered finite volume update couples each interior cell to its six face-adjacent neighbors. Parallelization is performed with Message Passing Interface (MPI), using a block-structured domain decomposition into $a$ partitions along $x$, $b$ partitions along $y$, and $c$ partitions along $z$, satisfying $a\\,b\\,c = P$ with $P = 96$, and the integer grid-division constraints $a \\mid N_{x}$, $b \\mid N_{y}$, and $c \\mid N_{z}$.\n\nEach subdomain maintains a halo of width $w = 1$ cell for neighbor exchanges. At each explicit time step, every internal interface between neighboring subdomains necessitates sending and receiving halo data proportional to the number of face cells on that interface. Assume bidirectional nearest-neighbor exchanges, one per internal face in each direction per time step.\n\nStarting from first principles of the discretized conservation law and the geometry of the block decomposition, derive an expression for the total number of halo cells communicated per time step across all processes as a function of $(a,b,c)$ and $(N_{x},N_{y},N_{z})$. Use this expression to determine the integer triple $(a,b,c)$ that minimizes the total internal interface measure under the stated constraints. Let the baseline be a one-dimensional slab decomposition along $x$ with $(a,b,c) = (96,1,1)$.\n\nCompute the dimensionless reduction factor $R$, defined as the total halo-cell count for the optimal $(a,b,c)$ divided by that for the baseline slab decomposition. Express the final value of $R$ as a single fraction. No rounding is required. The answer must be dimensionless; do not include units.",
            "solution": "The total communication cost per time step is proportional to the total area of the internal interfaces created by the decomposition. For a decomposition into $a \\times b \\times c$ subdomains, there are $(a-1)$ internal interface planes in the $x$-direction, $(b-1)$ in the $y$-direction, and $(c-1)$ in the $z$-direction. The area of each interface plane is given by the product of the global cell counts in the other two dimensions.\n\nThe total number of halo cells communicated per time step, $C_{total}$, accounts for sending and receiving across each internal interface. Since the halo width is $w=1$, this is twice the total internal interface area, $S_{internal}$:\n$$C_{total}(a,b,c) = 2 \\cdot S_{internal}(a,b,c)$$\nwhere\n$$S_{internal}(a,b,c) = (a-1)N_y N_z + (b-1)N_x N_z + (c-1)N_x N_y$$\nTo minimize the communication cost, we need to find the integer triple $(a,b,c)$ that minimizes $S_{internal}(a,b,c)$ subject to the given constraints. The constraints are:\n1.  $a, b, c$ are positive integers.\n2.  $a \\cdot b \\cdot c = 96$.\n3.  $a \\mid 192$, $b \\mid 128$, and $c \\mid 64$.\n\nSubstituting the grid dimensions $N_x = 192$, $N_y = 128$, $N_z = 64$:\n$$S_{internal}(a,b,c) = (a-1)(128 \\times 64) + (b-1)(192 \\times 64) + (c-1)(192 \\times 128)$$\n$$S_{internal}(a,b,c) = 8192(a-1) + 12288(b-1) + 24576(c-1)$$\nMinimizing $S_{internal}$ is equivalent to minimizing the function $g(a,b,c) = 8192a + 12288b + 24576c$. We can simplify this by dividing by the greatest common divisor, 4096, to define an integer-valued helper function $H(a,b,c)$ to minimize:\n$$H(a,b,c) = 2a + 3b + 6c$$\nWe must now find the integer triple $(a,b,c)$ that minimizes $H(a,b,c)$ under the constraints. Since $96 = 2^5 \\times 3$, and the constraints $b \\mid 128 = 2^7$ and $c \\mid 64 = 2^6$ mean that $b$ and $c$ must be powers of 2, the factor of 3 must belong to $a$. We test valid factorizations of 96:\n-   If $a=3$, $bc=32$. Candidates for $(b,c)$ are $(8,4)$ or $(4,8)$:\n    -   $(3,8,4): H = 2(3)+3(8)+6(4) = 6+24+24 = 54$.\n-   If $a=6$, $bc=16$. Candidates for $(b,c)$ are $(8,2)$, $(4,4)$:\n    -   $(6,8,2): H = 2(6)+3(8)+6(2) = 12+24+12 = 48$.\n    -   $(6,4,4): H = 2(6)+3(4)+6(4) = 12+12+24 = 48$.\n-   If $a=12$, $bc=8$. Candidates for $(b,c)$ are $(4,2)$, $(2,4)$:\n    -   $(12,4,2): H = 2(12)+3(4)+6(2) = 24+12+12 = 48$.\n-   If $a=96$, $bc=1$. Candidate for $(b,c)$ is $(1,1)$:\n    -   $(96,1,1): H = 2(96)+3(1)+6(1) = 192+3+6 = 201$. (Baseline case)\nOther combinations yield higher values of $H$. The minimum value of $H(a,b,c)$ is 48, achieved by the triples $(6,8,2)$, $(6,4,4)$, and $(12,4,2)$. We choose $(6,4,4)$ as the representative optimal decomposition.\n\nNow, we compute the total halo-cell count for the optimal and baseline cases to find the reduction factor $R$.\nFor the optimal case, $(a_{opt},b_{opt},c_{opt}) = (6,4,4)$:\n$$S_{opt} = (6-1)N_y N_z + (4-1)N_x N_z + (4-1)N_x N_y$$\n$$S_{opt} = 5(8192) + 3(12288) + 3(24576) = 40960 + 36864 + 73728 = 151552$$\nFor the baseline slab decomposition, $(a_{base},b_{base},c_{base}) = (96,1,1)$:\n$$S_{base} = (96-1)N_y N_z + (1-1)N_x N_z + (1-1)N_x N_y$$\n$$S_{base} = 95(8192) = 778240$$\nThe dimensionless reduction factor $R$ is the ratio of the total internal interface areas:\n$$R = \\frac{S_{opt}}{S_{base}} = \\frac{151552}{778240} = \\frac{37 \\times 4096}{190 \\times 4096} = \\frac{37}{190}$$",
            "answer": "$$\\boxed{\\frac{37}{190}}$$"
        }
    ]
}