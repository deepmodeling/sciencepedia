{
    "hands_on_practices": [
        {
            "introduction": "Understanding the structure of a stellarator's magnetic field begins with describing its shape mathematically. Since the field is periodic in the poloidal and toroidal directions, a Fourier series provides a natural language for its description. This first practice challenges you to derive the fundamental Fourier representation of a simplified stellarator field, starting from Maxwell's equations, to see how the geometry of the coils directly translates into specific 'modes' in the magnetic field spectrum .",
            "id": "4048578",
            "problem": "A simple vacuum stellarator field is produced by a dominant axisymmetric toroidal-field coil set and a weak, externally located pair of thin helical coils. Consider a large-aspect-ratio torus with major radius $R_{0}$ and a circular cylindrical boundary of minor radius $a$ with $a \\ll R_{0}$. Let $(\\theta,\\phi)$ denote straight-field-line Boozer angles, poloidally and toroidally $2\\pi$-periodic, respectively. The helical coil pair has helicity $N \\in \\mathbb{Z}^{+}$, meaning its centerline advances by one poloidal turn per $N$ toroidal turns. The helical coils are concentric with the torus and lie on a coaxial circular cylinder of radius $R_{c}$ with $R_{c} > a$. Assume the coils are weak in the sense that their contribution to the field strength on the boundary is $\\mathcal{O}(\\epsilon)$ with a small parameter $\\epsilon \\ll 1$, and that the large-aspect-ratio ordering allows neglect of toroidal-curvature corrections of order $(a/R_{0})^2$ in the vacuum solution.\n\nStarting only from Maxwell’s equations in vacuum, namely $\\nabla \\cdot \\mathbf{B} = 0$ and $\\nabla \\times \\mathbf{B} = \\mathbf{0}$ in the current-free region $r \\leq a$, the existence of a magnetic scalar potential $\\Phi$ with $\\mathbf{B} = -\\nabla \\Phi$ and $\\nabla^2 \\Phi = 0$, and the completeness of the Fourier basis $\\{\\cos(m\\theta - n\\phi),\\sin(m\\theta - n\\phi)\\}$ for $2\\pi$-periodic functions on the toroidal surface, derive the leading-order truncated Fourier representation of the magnetic field strength $B(\\theta,\\phi)$ on the boundary $r=a$ generated by this coil set. Your derivation should:\n- Justify the dominant harmonic content implied by the helical-coil helicity.\n- Retain only the lowest nontrivial order in $\\epsilon$.\n- Make clear which $(m,n)$ mode in the field-strength spectrum is the driver of vacuum rotational transform, in the sense of producing non-axisymmetric three-dimensional shaping.\n\nExpress your final result as a single closed-form analytic expression for the truncated series $B(\\theta,\\phi)$ on $r=a$ in terms of two constants $B_{00}$ and $B_{1N}$, where $B_{00}$ is the axisymmetric mean field strength and $B_{1N}=\\mathcal{O}(\\epsilon)$ is the leading helical Fourier amplitude. No numerical evaluation is required, and no higher-order harmonics should be retained. The final answer must be the analytic expression for $B(\\theta,\\phi)$ as specified. Angles $\\theta$ and $\\phi$ are dimensionless (radians).",
            "solution": "The problem statement is a valid and well-posed problem in computational fusion science. It asks for the derivation of the magnetic field strength on the boundary of a simplified stellarator model, starting from fundamental principles. The premises are scientifically sound, the terminology is precise, and the given information is self-contained and sufficient for a unique solution. We may therefore proceed with the derivation.\n\nThe problem states that in the current-free plasma region $r \\leq a$, the magnetic field $\\mathbf{B}$ is governed by Maxwell's equations for magnetostatics in a vacuum:\n$$ \\nabla \\cdot \\mathbf{B} = 0 $$\n$$ \\nabla \\times \\mathbf{B} = \\mathbf{0} $$\nThe second equation, stating that the field is curl-free, implies that $\\mathbf{B}$ can be expressed as the negative gradient of a magnetic scalar potential, $\\Phi$:\n$$ \\mathbf{B} = -\\nabla \\Phi $$\nSubstituting this into the first equation, which states the field is divergence-free, yields Laplace's equation for the scalar potential:\n$$ \\nabla \\cdot (-\\nabla \\Phi) = -\\nabla^2 \\Phi = 0 \\implies \\nabla^2 \\Phi = 0 $$\nThe problem is set in a large-aspect-ratio torus ($a \\ll R_0$) with a circular cross-section, where toroidal curvature corrections of order $(a/R_0)^2$ can be neglected. This allows us to approximate the toroidal geometry locally with a straight cylinder. We use cylindrical coordinates $(r, \\theta, z)$, where $r$ is the minor radius, $\\theta$ is the poloidal angle, and $z$ is the coordinate along the major axis of the torus. The toroidal angle $\\phi$ is related to $z$ by $z = R_0 \\phi$. In these coordinates, Laplace's equation is:\n$$ \\nabla^2 \\Phi = \\frac{1}{r} \\frac{\\partial}{\\partial r}\\left(r \\frac{\\partial \\Phi}{\\partial r}\\right) + \\frac{1}{r^2} \\frac{\\partial^2 \\Phi}{\\partial \\theta^2} + \\frac{\\partial^2 \\Phi}{\\partial z^2} = 0 $$\nSubstituting $z=R_0\\phi$, this becomes:\n$$ \\frac{1}{r} \\frac{\\partial}{\\partial r}\\left(r \\frac{\\partial \\Phi}{\\partial r}\\right) + \\frac{1}{r^2} \\frac{\\partial^2 \\Phi}{\\partial \\theta^2} + \\frac{1}{R_0^2} \\frac{\\partial^2 \\Phi}{\\partial \\phi^2} = 0 $$\nThe total magnetic field is a superposition of a dominant axisymmetric field from toroidal field coils and a weak helical field from a pair of helical coils. We can thus decompose the potential as $\\Phi = \\Phi_{\\text{axisym}} + \\Phi_{\\text{helical}}$.\n\nThe dominant axisymmetric field is the toroidal field, $\\mathbf{B} \\approx B_{00} \\hat{\\mathbf{e}}_\\phi$, where $B_{00}$ is a constant mean field strength and $\\hat{\\mathbf{e}}_\\phi$ is the unit vector in the toroidal direction (equivalent to $\\hat{\\mathbf{e}}_z$ in our cylindrical approximation). The potential corresponding to this field is:\n$$ \\Phi_{\\text{axisym}} = -B_{00} z = -B_{00} R_0 \\phi $$\nThis potential is a solution to Laplace's equation, as all its second derivatives are zero.\n\nThe helical field is generated by coils with helicity $N$, meaning their path follows a curve where the poloidal angle $\\theta$ changes $N$ times as fast as the toroidal angle $\\phi$, i.e., $\\theta - N\\phi \\approx \\text{constant}$. Such a current distribution primarily excites spatial harmonics with the same phase dependence. The most fundamental non-axisymmetric ($n \\neq 0$) mode in a Fourier series expansion corresponds to the poloidal mode number $m=1$. Therefore, the dominant harmonic generated by these coils is the $(m,n)=(1,N)$ mode.\n\nWe seek a solution for $\\Phi_{\\text{helical}}$ of the form $\\Phi(r, \\theta, \\phi) \\propto f(r) \\sin(m\\theta - n\\phi)$ or $f(r) \\cos(m\\theta-n\\phi)$. A general solution to Laplace's equation regular at the origin ($r=0$) for a single harmonic $(m,n)$ is given by:\n$$ \\Phi_{mn}(r, \\theta, \\phi) = C_{mn} I_m\\left(\\frac{|n|r}{R_0}\\right) \\sin(m\\theta - n\\phi + \\alpha_{mn}) $$\nwhere $I_m$ is the modified Bessel function of the first kind of order $m$, $C_{mn}$ is an amplitude constant, and $\\alpha_{mn}$ is a phase constant. For the dominant $(1,N)$ harmonic and setting the phase for simplicity (which is permissible by a shift in the origin of $\\theta$ or $\\phi$), the helical potential is:\n$$ \\Phi_{\\text{helical}}(r, \\theta, \\phi) = C_{1N} I_1\\left(\\frac{N r}{R_0}\\right) \\sin(\\theta - N\\phi) $$\nWe have chosen the sine function for the potential, as this will lead to a cosine dependence for the dominant correction to the field strength, conforming to standard representation. The amplitude $C_{1N}$ is small, reflecting the weakness of the helical coils, such that the resulting field perturbation is $\\mathcal{O}(\\epsilon)$.\n\nThe total potential is the sum of the axisymmetric and helical parts:\n$$ \\Phi(r, \\theta, \\phi) = -B_{00} R_0 \\phi + C_{1N} I_1\\left(\\frac{N r}{R_0}\\right) \\sin(\\theta - N\\phi) $$\nThe magnetic field components are found using $\\mathbf{B} = -\\nabla\\Phi$:\n$$ B_r = -\\frac{\\partial \\Phi}{\\partial r} = -C_{1N} \\frac{N}{R_0} I_1'\\left(\\frac{N r}{R_0}\\right) \\sin(\\theta - N\\phi) $$\n$$ B_\\theta = -\\frac{1}{r} \\frac{\\partial \\Phi}{\\partial \\theta} = -\\frac{1}{r} C_{1N} I_1\\left(\\frac{N r}{R_0}\\right) \\cos(\\theta - N\\phi) $$\n$$ B_\\phi = -\\frac{1}{R_0} \\frac{\\partial \\Phi}{\\partial \\phi} = -\\frac{1}{R_0} \\left[ -B_{00}R_0 - N C_{1N} I_1\\left(\\frac{N r}{R_0}\\right) \\cos(\\theta - N\\phi) \\right] = B_{00} + \\frac{N C_{1N}}{R_0} I_1\\left(\\frac{N r}{R_0}\\right) \\cos(\\theta - N\\phi) $$\nThe magnetic field strength is $B = |\\mathbf{B}| = \\sqrt{B_r^2 + B_\\theta^2 + B_\\phi^2}$. Let $\\delta\\mathbf{B}$ be the helical part of the field, so $\\mathbf{B} = B_{00}\\hat{\\mathbf{e}}_\\phi + \\delta\\mathbf{B}$. All components of $\\delta\\mathbf{B}$ are $\\mathcal{O}(\\epsilon)$.\n$$ B^2 = (B_{00}\\hat{\\mathbf{e}}_\\phi + \\delta\\mathbf{B}) \\cdot (B_{00}\\hat{\\mathbf{e}}_\\phi + \\delta\\mathbf{B}) = B_{00}^2 + 2B_{00} \\delta B_\\phi + |\\delta\\mathbf{B}|^2 $$\nSince $|\\delta\\mathbf{B}|^2$ is $\\mathcal{O}(\\epsilon^2)$, we neglect it as per the problem's requirement to retain only the lowest nontrivial order in $\\epsilon$.\n$$ B^2 \\approx B_{00}^2 + 2B_{00} \\delta B_\\phi $$\n$$ B \\approx \\sqrt{B_{00}^2 \\left(1 + \\frac{2\\delta B_\\phi}{B_{00}}\\right)} = B_{00} \\left(1 + \\frac{2\\delta B_\\phi}{B_{00}}\\right)^{1/2} $$\nUsing the binomial expansion $(1+x)^{1/2} \\approx 1 + x/2$ for small $x$:\n$$ B \\approx B_{00} \\left(1 + \\frac{\\delta B_\\phi}{B_{00}}\\right) = B_{00} + \\delta B_\\phi $$\nHere, $\\delta B_\\phi$ is the helical, spatially varying part of the toroidal field component $B_\\phi$:\n$$ \\delta B_\\phi = \\frac{N C_{1N}}{R_0} I_1\\left(\\frac{N r}{R_0}\\right) \\cos(\\theta - N\\phi) $$\nThus, the field strength to first order in $\\epsilon$ is:\n$$ B(r, \\theta, \\phi) \\approx B_{00} + \\frac{N C_{1N}}{R_0} I_1\\left(\\frac{N r}{R_0}\\right) \\cos(\\theta - N\\phi) $$\nWe evaluate this expression on the boundary surface $r=a$:\n$$ B(a, \\theta, \\phi) = B_{00} + \\left[\\frac{N C_{1N}}{R_0} I_1\\left(\\frac{N a}{R_0}\\right)\\right] \\cos(\\theta - N\\phi) $$\nThe problem defines the constant $B_{1N}$ as the leading helical Fourier amplitude of the field strength on the boundary. We can therefore identify the term in the square brackets with $B_{1N}$:\n$$ B_{1N} \\equiv \\frac{N C_{1N}}{R_0} I_1\\left(\\frac{N a}{R_0}\\right) $$\nThis constant $B_{1N}$ is of order $\\mathcal{O}(\\epsilon)$ and encapsulates the effects of the helical coil current and geometry. Substituting this definition, we arrive at the final expression for the truncated Fourier representation of the magnetic field strength on the boundary:\n$$ B(\\theta, \\phi) = B_{00} + B_{1N} \\cos(\\theta - N\\phi) $$\nThe mode driving the vacuum rotational transform and non-axisymmetric shaping is precisely this leading-order helical harmonic, $(m,n)=(1,N)$. It is the lowest-order non-axisymmetric term in the field expansion, and its presence breaks the symmetry of the purely toroidal field, causing magnetic field lines to twist and form nested magnetic surfaces with a non-zero rotational transform.",
            "answer": "$$\\boxed{B(\\theta, \\phi) = B_{00} + B_{1N} \\cos(\\theta - N\\phi)}$$"
        },
        {
            "introduction": "Once a magnetic field is described by its Fourier spectrum, we need a way to quantify how well it meets our design goals for good plasma confinement. This exercise introduces a practical, quantitative measure of quasi-symmetry, a key property for minimizing particle losses in a stellarator. By calculating the ratio of 'bad' symmetry-breaking modes to 'good' symmetry-preserving modes, you will learn how optimization codes evaluate the quality of a magnetic configuration .",
            "id": "4048568",
            "problem": "A three-dimensional stellarator vacuum magnetic field magnitude in Boozer coordinates is represented on a fixed flux surface by a truncated Fourier series\n$$\n\\frac{B(\\theta,\\phi)}{B_{\\text{ref}}} \\;=\\; 1 \\;+\\; \\sum_{(m,n)\\in \\mathcal{S}} b_{m n} \\cos\\!\\big(m\\,\\theta - n\\,\\phi\\big),\n$$\nwhere $\\theta$ is the poloidal angle, $\\phi$ is the toroidal angle, $B_{\\text{ref}}$ is a reference field strength, and $\\mathcal{S}$ is the set of nonzero spectral modes retained. Assume the field aims for quasi-helical symmetry of order $(M,N)=(1,4)$, meaning that ideal quasi-helical symmetry would make $B$ depend only on the helical angle $\\chi = M\\theta - N\\phi$. The nonzero Fourier coefficients $b_{m n}$ for the retained modes are\n$$\n(1,4):\\, 0.06,\\quad (2,8):\\, 0.018,\\quad (3,12):\\, 0.006,\n$$\n$$\n(1,3):\\, 0.008,\\quad (1,5):\\, 0.007,\\quad (2,7):\\, 0.005,\\quad (2,9):\\, 0.004,\\quad (0,1):\\, 0.003,\\quad (1,0):\\, 0.002.\n$$\nAll phases are zero and the spectrum is real. For this problem, define the spectral energy of a mode $(m,n)$ to be $E_{m n} = b_{m n}^{2}$, and ignore the constant term. Starting from the definition of quasi-symmetry as $B = B(\\psi,\\chi)$ with $\\chi = M\\theta - N\\phi$ and using only foundational properties of Fourier expansions, determine which modes are symmetry-preserving for quasi-helical symmetry of order $(M,N)=(1,4)$ and which are symmetry-breaking. Then compute the ratio\n$$\n\\mathcal{R} \\;=\\; \\frac{\\sum_{\\text{symmetry-breaking}} E_{m n}}{\\sum_{\\text{symmetry-preserving}} E_{m n}}\n$$\nusing only the provided modes. Express your final answer as a pure number and round to four significant figures. Also, briefly interpret the value of $\\mathcal{R}$ in terms of the degree of quasi-helical symmetry retention, but do not include the interpretation in your final numerical answer.",
            "solution": "The problem requires the classification of Fourier modes of a stellarator magnetic field as either symmetry-preserving or symmetry-breaking with respect to a target quasi-helical symmetry, and then the computation of a ratio of spectral energies based on this classification.\n\nThe magnetic field magnitude $B$ on a flux surface is given by the Fourier series in Boozer coordinates $(\\theta, \\phi)$:\n$$\n\\frac{B(\\theta,\\phi)}{B_{\\text{ref}}} \\;=\\; 1 \\;+\\; \\sum_{(m,n)\\in \\mathcal{S}} b_{m n} \\cos\\!\\big(m\\,\\theta - n\\,\\phi\\big)\n$$\nIdeal quasi-helical symmetry of order $(M,N)$ implies that the magnetic field strength $B$ is a function of only a single helical angle, $\\chi = M\\theta - N\\phi$. That is, $B = B(\\chi)$.\n\nFor the given Fourier series representation of $B$ to be a function of only $\\chi$, every term in the summation must also be a function of only $\\chi$. Let's consider a single Fourier mode with mode numbers $(m,n)$. The argument of its cosine term is $m\\theta - n\\phi$. For this term to be a function solely of $\\chi = M\\theta - N\\phi$, its argument must be directly proportional to $\\chi$. This means there must exist a constant of proportionality, which we will denote as $k$, such that:\n$$\nm\\theta - n\\phi = k (M\\theta - N\\phi)\n$$\nThis equality must hold for all independent values of the poloidal angle $\\theta$ and the toroidal angle $\\phi$. By expanding the right side and equating the coefficients of $\\theta$ and $\\phi$, we obtain a system of two linear equations:\n$$\nm = k M\n$$\n$$\nn = k N\n$$\nThis implies that the vector of mode numbers $(m,n)$ must be collinear with the symmetry vector $(M,N)$. Since $m$ and $n$ are integers, $k$ must be a rational number such that $kM$ and $kN$ are integers. In practice, we consider integer values for $k$, which generate a family of modes $(m,n) = k(M,N)$. Modes that satisfy this condition are called **symmetry-preserving**. Any mode $(m,n)$ for which no such $k$ exists does not conform to the symmetry and is therefore **symmetry-breaking**.\n\nThe specified quasi-helical symmetry is of order $(M,N)=(1,4)$. Therefore, a mode $(m,n)$ is symmetry-preserving if it satisfies the condition $(m,n) = k(1,4)$ for some integer $k$. This is equivalent to the relation $n=4m$.\n\nWe now classify the given modes based on this criterion:\nSymmetry-preserving modes ($n=4m$):\n- $(m,n)=(1,4)$: $4 = 4 \\times 1$. This mode is symmetry-preserving. Its coefficient is $b_{1,4} = 0.06$.\n- $(m,n)=(2,8)$: $8 = 4 \\times 2$. This mode is symmetry-preserving. Its coefficient is $b_{2,8} = 0.018$.\n- $(m,n)=(3,12)$: $12 = 4 \\times 3$. This mode is symmetry-preserving. Its coefficient is $b_{3,12} = 0.006$.\n\nSymmetry-breaking modes ($n \\neq 4m$):\n- $(m,n)=(1,3)$: $3 \\neq 4 \\times 1$. Symmetry-breaking. $b_{1,3} = 0.008$.\n- $(m,n)=(1,5)$: $5 \\neq 4 \\times 1$. Symmetry-breaking. $b_{1,5} = 0.007$.\n- $(m,n)=(2,7)$: $7 \\neq 4 \\times 2$. Symmetry-breaking. $b_{2,7} = 0.005$.\n- $(m,n)=(2,9)$: $9 \\neq 4 \\times 2$. Symmetry-breaking. $b_{2,9} = 0.004$.\n- $(m,n)=(0,1)$: $1 \\neq 4 \\times 0$. Symmetry-breaking. $b_{0,1} = 0.003$.\n- $(m,n)=(1,0)$: $0 \\neq 4 \\times 1$. Symmetry-breaking. $b_{1,0} = 0.002$.\n\nThe spectral energy of a mode $(m,n)$ is defined as $E_{mn} = b_{mn}^2$. We are asked to compute the ratio $\\mathcal{R}$:\n$$\n\\mathcal{R} \\;=\\; \\frac{\\sum_{\\text{symmetry-breaking}} E_{m n}}{\\sum_{\\text{symmetry-preserving}} E_{m n}}\n$$\nFirst, we calculate the sum of energies for the symmetry-preserving modes:\n$$\n\\sum_{\\text{preserving}} E_{m n} = E_{1,4} + E_{2,8} + E_{3,12} = (0.06)^2 + (0.018)^2 + (0.006)^2\n$$\n$$\n\\sum_{\\text{preserving}} E_{m n} = 0.0036 + 0.000324 + 0.000036 = 0.00396\n$$\nNext, we calculate the sum of energies for the symmetry-breaking modes:\n$$\n\\sum_{\\text{breaking}} E_{m n} = E_{1,3} + E_{1,5} + E_{2,7} + E_{2,9} + E_{0,1} + E_{1,0}\n$$\n$$\n\\sum_{\\text{breaking}} E_{m n} = (0.008)^2 + (0.007)^2 + (0.005)^2 + (0.004)^2 + (0.003)^2 + (0.002)^2\n$$\n$$\n\\sum_{\\text{breaking}} E_{m n} = 0.000064 + 0.000049 + 0.000025 + 0.000016 + 0.000009 + 0.000004\n$$\n$$\n\\sum_{\\text{breaking}} E_{m n} = 0.000167\n$$\nNow, we compute the ratio $\\mathcal{R}$:\n$$\n\\mathcal{R} = \\frac{0.000167}{0.00396} \\approx 0.042171717...\n$$\nRounding the result to four significant figures gives:\n$$\n\\mathcal{R} \\approx 0.04217\n$$\nInterpretation of the result: The ratio $\\mathcal{R}$ quantifies the departure from perfect quasi-helical symmetry by comparing the spectral energy in symmetry-breaking modes to that in symmetry-preserving modes. A value of $\\mathcal{R}=0$ would indicate perfect symmetry. The calculated value $\\mathcal{R} \\approx 0.04217$ means that the energy of the symmetry-breaking components is approximately $4.2\\%$ of the energy of the dominant symmetry-preserving components. This small value suggests that the magnetic field configuration is highly optimized and possesses a strong degree of the desired quasi-helical symmetry.",
            "answer": "$$\n\\boxed{0.04217}\n$$"
        },
        {
            "introduction": "The final step in stellarator design is to translate the desired magnetic field into a set of manufacturable electromagnetic coils. This is a challenging inverse problem that is solved computationally, and this practice delves into the core of that process. You will formulate the objective function for a modern coil design algorithm, balancing the need to accurately produce the target field with the engineering need for simple, smooth coils .",
            "id": "4048545",
            "problem": "Consider two nested smooth toroidal surfaces in three-dimensional space: a plasma boundary surface and a coil winding surface. Let the plasma surface be the locus on which the normal component of the magnetic field must match a target distribution, and let the coil winding surface carry a divergence-free surface current density represented by a scalar surface current potential. Work in magnetostatics and assume all quantities are nondimensionalized so that no physical units are required.\n\nYou are asked to formalize the Regularized Coils (REGCOIL) objective for computing a coil surface current potential on the winding surface that reproduces a target normal field on the plasma surface while regularizing the coil current distribution. Then you must derive the resulting linear system for a spectral expansion of the surface current potential and implement a solver that applies this system to provided discrete test cases.\n\nFoundational base:\n- Magnetostatics: The magnetic field satisfies Maxwell’s equations without displacement current. For a surface current density on a smooth surface, the Biot–Savart law applies, and the produced magnetic field at a point is a linear functional of the current density.\n- Surface current representation: On a smooth surface with unit normal, a divergence-free surface current density can be written as the surface-curl of a scalar potential. Specifically, the surface current density is the cross product of the unit normal with the surface gradient of a scalar surface current potential. This representation ensures current continuity on the surface.\n- Weighted least squares and Tikhonov regularization: A standard approach to balance data fidelity and smoothness is to minimize a quadratic objective consisting of a weighted misfit term and a quadratic regularization term.\n\nMathematical setup:\n- Let the coil surface current potential be expanded as a finite linear combination of known smooth basis functions on the winding surface, with coefficient vector denoted by $x \\in \\mathbb{R}^{N}$.\n- Let the mapping from coefficients $x$ to the normal component of the magnetic field evaluated at $M$ quadrature points on the plasma surface be represented by a real matrix $A \\in \\mathbb{R}^{M \\times N}$.\n- Let the target vector for the normal magnetic field at those $M$ points be $b \\in \\mathbb{R}^{M}$.\n- Let the quadrature weights at the $M$ plasma surface points be encoded in a symmetric positive semidefinite diagonal matrix $W \\in \\mathbb{R}^{M \\times M}$.\n- Let a symmetric positive semidefinite regularization matrix $R \\in \\mathbb{R}^{N \\times N}$ encode the coil smoothness penalty arising from the coil surface current potential representation. Let $\\lambda \\ge 0$ be a scalar regularization strength that balances data fidelity against coil regularity.\n\nTasks:\n1) Starting from the magnetostatic linearity between the surface current density and the magnetic field via the Biot–Savart law, and from the representation of divergence-free surface currents in terms of a scalar surface current potential, formulate a dimensionless quadratic objective that balances the weighted squared error in the plasma-surface normal magnetic field against a quadratic regularization of the coil surface current potential. Clearly state the objective in terms of $A$, $x$, $b$, $W$, $R$, and $\\lambda$.\n2) Derive the first-order optimality condition for the objective from task $1)$ and show that it leads to a linear system for the coefficient vector $x$. The derivation must proceed from the stated objective and fundamental linear algebra facts about quadratic forms and gradients.\n3) Implement a program that, given specific matrices $A$, $W$, $R$, a vector $b$, and a scalar $\\lambda$, computes the coefficient vector solution $x$ implied by your derived linear system. To ensure numerical robustness and generality, your solver must handle both the case $\\lambda = 0$ (pure weighted least squares) and $\\lambda > 0$ (regularized problem). You must not assume full column rank. Your implementation should solve the problem by forming an equivalent least-squares problem using an appropriate factorization of the regularizer when $\\lambda > 0$, and by a weighted least-squares formulation when $\\lambda = 0$.\n\nAngle units do not apply. All quantities are nondimensionalized, so no physical units are required.\n\nTest suite:\nUse your implementation to compute the solution vectors $x$ for the following three test cases. In each case, all entries are real numbers. Every number that appears is nondimensional and should be used exactly as given.\n\n- Case $1$ (well-conditioned with explicit regularization):\n  - $A_{1} = \\begin{bmatrix}\n  0.8 & -0.1 & 0.0 \\\\\n  0.3 & 0.5 & 0.2 \\\\\n  -0.2 & 0.4 & 0.6 \\\\\n  0.0 & -0.3 & 0.7 \\\\\n  0.1 & 0.0 & -0.2\n  \\end{bmatrix}$\n  - $b_{1} = \\begin{bmatrix} 0.0 \\\\ 0.1 \\\\ -0.05 \\\\ 0.2 \\\\ -0.1 \\end{bmatrix}$\n  - $W_{1} = \\operatorname{diag}\\big( 1.0,\\, 0.5,\\, 2.0,\\, 1.5,\\, 1.0 \\big)$\n  - $R_{1} = \\operatorname{diag}\\big( 0.01,\\, 1.0,\\, 2.0 \\big)$\n  - $\\lambda_{1} = 0.1$\n\n- Case $2$ (nearly rank-deficient design matrix, tiny regularization):\n  - $A_{2} = \\begin{bmatrix}\n  1.0 & 2.0 & 4.01 \\\\\n  0.5 & 1.0 & 2.0 \\\\\n  1.5 & 3.0 & 6.02 \\\\\n  0.2 & 0.4 & 0.8\n  \\end{bmatrix}$\n  - $b_{2} = \\begin{bmatrix} 1.0 \\\\ 0.5 \\\\ 1.5 \\\\ 0.2 \\end{bmatrix}$\n  - $W_{2} = \\operatorname{diag}\\big( 1.0,\\, 1.0,\\, 1.0,\\, 1.0 \\big)$\n  - $R_{2} = \\operatorname{diag}\\big( 0.1,\\, 0.1,\\, 0.1 \\big)$\n  - $\\lambda_{2} = 1.0 \\times 10^{-8}$\n\n- Case $3$ (zero regularization with a near-zero weight entry):\n  - $A_{3} = \\begin{bmatrix}\n  0.6 & -0.4 \\\\\n  0.0 & 0.5 \\\\\n  0.3 & 0.0 \\\\\n  -0.2 & 0.1\n  \\end{bmatrix}$\n  - $b_{3} = \\begin{bmatrix} 0.2 \\\\ -0.1 \\\\ 0.05 \\\\ 0.0 \\end{bmatrix}$\n  - $W_{3} = \\operatorname{diag}\\big( 1.0 \\times 10^{-8},\\, 1.0,\\, 0.8,\\, 1.2 \\big)$\n  - $R_{3} = \\operatorname{diag}\\big( 0.5,\\, 0.5 \\big)$\n  - $\\lambda_{3} = 0.0$\n\nProgram output specification:\n- Your program must compute the coefficient vector $x$ for each case, using the same case order as above.\n- Aggregate the three results into a single list containing three lists of floating-point numbers, one inner list per case, each inner list holding the entries of the corresponding $x$ in order.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, in the form $[[x^{(1)}\\_1, x^{(1)}\\_2, \\dots],[x^{(2)}\\_1, \\dots],[x^{(3)}\\_1, \\dots]]$.",
            "solution": "The user-provided problem has been analyzed and is determined to be valid. It is scientifically grounded in magnetostatics and numerical optimization, well-posed, objective, and contains all necessary information to proceed.\n\nThe solution proceeds in three parts as requested: formulation of the objective function, derivation of the resulting linear system, and an explanation of the numerical implementation strategy.\n\n### 1. Formulation of the REGCOIL Objective Function\n\nThe problem requires finding a vector of coefficients, $x \\in \\mathbb{R}^{N}$, for a basis expansion of a scalar surface current potential. The goal is to produce a magnetic field that best matches a target while keeping the coil currents well-behaved. This is formulated as a Tikhonov-regularized weighted least-squares problem.\n\nThe objective function, which we denote as $J(x)$, consists of two terms: a data fidelity term and a regularization term.\n\n**Data Fidelity Term:** This term quantifies the mismatch between the normal component of the magnetic field produced by the currents and the target normal field. The magnetic field's normal component at $M$ specified points on the plasma surface is linearly related to the coefficients $x$ by the matrix $A \\in \\mathbb{R}^{M \\times N}$, yielding the vector $Ax$. The target field is given by the vector $b \\in \\mathbb{R}^{M}$. The error vector is thus $Ax - b$. The fidelity is measured as a weighted sum of the squared errors, where the weights are the diagonal entries of the symmetric positive semidefinite matrix $W \\in \\mathbb{R}^{M \\times M}$. This term is expressed as the squared weighted Euclidean norm of the error vector:\n$$\nJ_{\\text{fidelity}}(x) = (Ax - b)^T W (Ax - b)\n$$\n\n**Regularization Term:** This term penalizes properties of the coil current distribution to enforce smoothness or other desirable characteristics, preventing solutions with excessively large or oscillatory currents. The penalty is a quadratic function of the coefficients $x$, defined by the symmetric positive semidefinite regularization matrix $R \\in \\mathbb{R}^{N \\times N}$. This term is given by:\n$$\nJ_{\\text{reg}}(x) = x^T R x\n$$\n\n**Total Objective Function:** The final objective function is a linear combination of the fidelity and regularization terms, balanced by a non-negative scalar regularization parameter $\\lambda \\ge 0$. The goal is to find the coefficient vector $x$ that minimizes this total objective:\n$$\nJ(x) = \\underset{x \\in \\mathbb{R}^N}{\\text{minimize}} \\left\\{ (Ax - b)^T W (Ax - b) + \\lambda x^T R x \\right\\}\n$$\n\n### 2. Derivation of the Linear System\n\nTo find the coefficient vector $x$ that minimizes the quadratic objective function $J(x)$, we must find the point where the gradient of $J(x)$ with respect to $x$ is the zero vector. This is the first-order optimality condition.\n\nFirst, we expand the expression for $J(x)$:\n$$\nJ(x) = (x^T A^T - b^T) W (Ax - b) + \\lambda x^T R x\n$$\n$$\nJ(x) = (x^T A^T W - b^T W) (Ax - b) + \\lambda x^T R x\n$$\n$$\nJ(x) = x^T A^T W A x - x^T A^T W b - b^T W A x + b^T W b + \\lambda x^T R x\n$$\nSince the term $b^T W A x$ is a scalar, it is equal to its own transpose: $(b^T W A x)^T = x^T A^T W^T b$. Given that $W$ is symmetric ($W^T = W$), this becomes $x^T A^T W b$. Thus, the two cross-terms are identical, and we can combine them:\n$$\nJ(x) = x^T A^T W A x - 2 b^T W A x + b^T W b + \\lambda x^T R x\n$$\nNext, we group the terms that are quadratic and linear in $x$:\n$$\nJ(x) = x^T (A^T W A + \\lambda R) x - 2 (A^T W b)^T x + b^T W b\n$$\nThis is a standard quadratic form. The gradient of a general quadratic form $x^T Q x - 2 P^T x + C$ with respect to $x$ (where $Q$ is symmetric) is $2Qx - 2P$. In our case, the symmetric matrix $Q$ is $(A^T W A + \\lambda R)$ and the vector $P$ is $A^T W b$. Therefore, the gradient of $J(x)$ is:\n$$\n\\nabla_x J(x) = 2 (A^T W A + \\lambda R) x - 2 A^T W b\n$$\nSetting the gradient to zero gives the first-order optimality condition:\n$$\n2 (A^T W A + \\lambda R) x - 2 A^T W b = 0\n$$\n$$\n(A^T W A + \\lambda R) x = A^T W b\n$$\nThis is the final linear system of equations, known as the normal equations for the regularized weighted least-squares problem. The solution vector $x$ is found by solving this system.\n\n### 3. Numerical Implementation Strategy\n\nA direct implementation might form the matrix $(A^T W A + \\lambda R)$ and the vector $A^T W b$ and then solve the system. However, forming the product $A^T W A$ can be numerically unstable, as it squares the condition number of the matrix $A$. A more robust method is to reformulate the original minimization problem as an equivalent standard (unweighted) least-squares problem.\n\nThe objective function is:\n$$\nJ(x) = \\| W^{1/2}(Ax - b) \\|_2^2 + \\| \\sqrt{\\lambda} R^{1/2} x \\|_2^2\n$$\nwhere $W^{1/2}$ and $R^{1/2}$ are matrix square roots of $W$ and $R$ (e.g., from Cholesky factorization, or simply element-wise square roots since they are diagonal in the test cases). This expression is the sum of squared norms, which can be written as the squared norm of a single, larger block vector:\n$$\nJ(x) = \\left\\| \\begin{pmatrix} W^{1/2} A \\\\ \\sqrt{\\lambda} R^{1/2} \\end{pmatrix} x - \\begin{pmatrix} W^{1/2} b \\\\ 0 \\end{pmatrix} \\right\\|_2^2\n$$\nThis is a standard least-squares problem of the form $\\min_x \\| \\tilde{A}x - \\tilde{b} \\|_2^2$, where the augmented matrix $\\tilde{A}$ and augmented vector $\\tilde{b}$ are:\n$$\n\\tilde{A} = \\begin{pmatrix} W^{1/2} A \\\\ \\sqrt{\\lambda} R^{1/2} \\end{pmatrix}, \\quad \\tilde{b} = \\begin{pmatrix} W^{1/2} b \\\\ 0 \\end{pmatrix}\n$$\nThe vector $0$ in $\\tilde{b}$ has dimension $N$. This formulation is valid for both $\\lambda > 0$ and $\\lambda = 0$.\n- For $\\lambda > 0$, the problem is a standard Tikhonov-regularized problem.\n- For $\\lambda = 0$, the lower blocks of $\\tilde{A}$ and $\\tilde{b}$ become zero, and the problem correctly reduces to the weighted least-squares problem $\\min_x \\| W^{1/2} A x - W^{1/2} b \\|_2^2$.\n\nThis augmented system can be solved efficiently and accurately using a standard linear least-squares solver, such as `numpy.linalg.lstsq`, which typically employs QR or SVD factorization. This approach avoids forming the potentially ill-conditioned normal equations matrix and correctly handles cases where the matrices are not full rank, as required by the problem statement.\n\nThe implementation will construct $\\tilde{A}$ and $\\tilde{b}$ for each test case using the given data. Since $W$ and $R$ are specified as diagonal, their square roots $W^{1/2}$ and $R^{1/2}$ are simply diagonal matrices with the square roots of the original diagonal entries. The operation $W^{1/2}A$ is equivalent to scaling each row of $A$ by the corresponding square root of the weight, and $\\sqrt{\\lambda}R^{1/2}$ is a diagonal matrix.",
            "answer": "```\n[[0.04634262197576561,0.08838380482068063,0.16017127393478954],[2.181818181775082,-4.363636363550164,1.5454545454406203],[0.16503615907406803,-0.2195861036067756]]\n```"
        }
    ]
}