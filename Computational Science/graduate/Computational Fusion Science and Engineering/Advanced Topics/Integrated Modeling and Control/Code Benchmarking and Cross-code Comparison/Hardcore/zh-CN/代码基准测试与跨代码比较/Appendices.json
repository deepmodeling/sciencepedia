{
    "hands_on_practices": [
        {
            "introduction": "在比较不同代码的性能之前，我们必须首先验证它们是否正确地求解了底层的物理方程。本练习介绍了理查森外推法（Richardson extrapolation），这是一种强大的数值分析技术，它使我们能够利用不同网格分辨率下的计算结果来估计代码的收敛阶并推断出理想的连续介质解。掌握这种方法对于代码验证至关重要，而代码验证是任何严谨基准测试研究的第一步。",
            "id": "3956960",
            "problem": "在一项计算聚变科学与工程的跨代码基准测试练习中，考虑了二维周期性平板中的电阻磁流体动力学 (MHD) 的线性撕裂模。关注的物理量是无量纲的模增长率，记为 $\\gamma$，在固定归一化条件下，其单位为 $\\mathrm{s}^{-1}$。两个生产代码使用相同的物理模型参数（恒定电阻率、相同的边界条件、相同的平衡剖面和相同的归一化），实现了有限体积空间离散化和显式时间步进，但数值实现可能不同。为了对跨代码比较进行严格的网格加密研究，您将设计并使用以下流程：\n\n- 固定除均匀网格间距 $h$ 和时间步长 $\\Delta t$ 之外的所有物理和数值参数。\n- 以恒定比率 $r$ 加密网格，使得 $2h$ 和 $4h$ 是较粗的层级，而 $h$ 是最细的层级。在两个代码中都使用相同的加密比率 $r$。\n- 根据 Courant–Friedrichs–Lewy (CFL) 条件选择 $\\Delta t$，使得 $\\Delta t \\propto h$，并保持 CFL 数固定，以确保时间误差在不同加密层级间保持相称。\n- 对于每个网格层级，从饱和线性区提取一个关注的标量诊断值 $u_h$，这里 $u_h \\equiv \\gamma_h$。\n- 假设对于足够小的 $h$，离散解服从形式为 $u_h = u^\\star + C h^{p} + \\mathcal{O}(h^{p+1})$ 的渐近误差展开，其中 $u^\\star$ 是连续介质下的量，$C$ 是一个常数，$p$ 是关于 $h$ 的形式精度阶。\n\n从这个渐近展开和基本定义出发，推导一个使用两个比率为 $r$ 的网格层级和由 $p$ 表征的领头阶项的 $u^\\star$ 的形式估计量。然后，仅使用测得的离散解，从三个网格层级估计 $p$。最后，应用该估计量，使用两个最细的层级，得出增长率的连续介质估计值。\n\n对于代码 A，在三个网格层级上测得的增长率如下：\n$$\\gamma_{4h}^{(A)} = 0.1010\\ \\mathrm{s}^{-1},\\quad \\gamma_{2h}^{(A)} = 0.10025\\ \\mathrm{s}^{-1},\\quad \\gamma_{h}^{(A)} = 0.1000625\\ \\mathrm{s}^{-1},$$\n加密比率为 $r = 2$。使用这些数据：\n1. 仅用 $\\{u_h, u_{2h}, u_{4h}\\}$ 和 $r$ 推导 $p$ 的表达式。\n2. 使用两个比率为 $r$ 的网格层级和已知的 $p$，推导 $u^\\star$ 的 Richardson 外推估计量。\n3. 对代码 A，使用两个最细的层级计算该估计量的值，并以 $\\mathrm{s}^{-1}$ 为单位表示最终的增长率连续介质估计值。\n\n将您计算的连续介质增长率的最终数值答案四舍五入到四位有效数字。",
            "solution": "问题陈述已经过严格验证，并被认为是有效的。它在科学上基于数值分析和计算物理的原理，特别是用于代码验证的 Richardson 外推法。该问题是适定的、客观的，并提供了推导所要求的估计量和计算最终值所需的所有信息。\n\n任务是从给定的渐近误差展开中推导精度阶 $p$ 和连续解 $u^\\star$ 的估计量，然后将这些估计量应用于数值模拟的实验数据。\n\n假设网格间距为 $h$ 时的离散解 $u_h$ 的渐近误差展开由下式给出：\n$$u_h = u^\\star + C h^{p} + \\mathcal{O}(h^{p+1})$$\n其中 $u^\\star$ 是精确连续解，$C$ 是一个与 $h$ 无关的常数，$p$ 是形式精度阶。在本次分析中，我们将忽略高阶项 $\\mathcal{O}(h^{p+1})$，这在 $h$ 足够小时是标准做法。\n\n**1. 精度阶 $p$ 的推导**\n\n给定三个具有恒定加密比率 $r$ 的网格层级。设网格间距分别为 $h$ (最细)、$rh$ (中等) 和 $r^2h$ (最粗)。对应的离散解记为 $u_h$、$u_{rh}$ 和 $u_{r^2h}$。在问题数据的背景下，这些层级对应于 $h$、$2h$ 和 $4h$，其中 $r=2$。\n\n根据领头阶渐近展开，我们写出这三个层级的方程：\n$$u_h \\approx u^\\star + C h^{p} \\quad (1)$$\n$$u_{rh} \\approx u^\\star + C (rh)^{p} = u^\\star + C r^{p} h^{p} \\quad (2)$$\n$$u_{r^2h} \\approx u^\\star + C (r^2h)^{p} = u^\\star + C r^{2p} h^{p} \\quad (3)$$\n\n为了求出 $p$，我们必须消去未知数 $u^\\star$ 和 $C$。首先，我们通过对连续的方程作差来消去 $u^\\star$：\n方程 $(2)$ 减去方程 $(1)$：\n$$u_{rh} - u_h \\approx (u^\\star + C r^{p} h^{p}) - (u^\\star + C h^{p}) = C h^{p} (r^{p} - 1) \\quad (4)$$\n方程 $(3)$ 减去方程 $(2)$：\n$$u_{r^2h} - u_{rh} \\approx (u^\\star + C r^{2p} h^{p}) - (u^\\star + C r^{p} h^{p}) = C h^{p} (r^{2p} - r^{p}) = C h^{p} r^{p} (r^{p} - 1) \\quad (5)$$\n\n现在，我们将方程 $(5)$ 与方程 $(4)$ 相除，以消去 $C$ 和 $h$：\n$$\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h} \\approx \\frac{C h^{p} r^{p} (r^{p} - 1)}{C h^{p} (r^{p} - 1)} = r^p$$\n\n为了解出 $p$，我们对两边取自然对数：\n$$\\ln\\left(\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h}\\right) \\approx \\ln(r^p) = p \\ln(r)$$\n因此，精度阶 $p$ 的估计量为：\n$$p \\approx \\frac{\\ln\\left(\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h}\\right)}{\\ln(r)}$$\n对于题目要求的具有层级 $h$、$2h$ 和 $4h$ 的特定记法，这对应于 $r=2$，表达式为 $p \\approx \\frac{\\ln\\left(\\frac{u_{4h} - u_{2h}}{u_{2h} - u_h}\\right)}{\\ln(2)}$。\n\n**2. $u^\\star$ 的 Richardson 外推估计量的推导**\n\n我们使用两个网格层级 $h$ 和 $rh$，以及对应的解 $u_h$ 和 $u_{rh}$。方程如下：\n$$u_h \\approx u^\\star + C h^{p} \\quad (6)$$\n$$u_{rh} \\approx u^\\star + C r^{p} h^{p} \\quad (7)$$\n\n我们的目标是通过消去与 $C h^p$ 成正比的领头阶误差项来找到 $u^\\star$ 的估计值。我们可以通过构造方程 $(6)$ 和 $(7)$ 的线性组合来实现这一点。将方程 $(6)$ 乘以 $r^p$：\n$$r^{p} u_h \\approx r^{p} u^\\star + r^{p} C h^{p} \\quad (8)$$\n\n现在，从方程 $(8)$ 中减去方程 $(7)$：\n$$r^{p} u_h - u_{rh} \\approx (r^{p} u^\\star + r^{p} C h^{p}) - (u^\\star + C r^{p} h^{p})$$\n$$r^{p} u_h - u_{rh} \\approx r^{p} u^\\star - u^\\star = u^\\star(r^{p} - 1)$$\n\n解出 $u^\\star$，我们得到 Richardson 外推估计量：\n$$u^\\star \\approx \\frac{r^{p} u_h - u_{rh}}{r^{p} - 1}$$\n该公式通过消除领头阶误差项，提供了连续解的一个更高阶的估计。\n\n**3. 应用于代码 A 数据**\n\n给定代码 A 在加密比率 $r=2$ 下的增长率如下：\n$$\\gamma_{h}^{(A)} = u_h = 0.1000625\\ \\mathrm{s}^{-1}$$\n$$\\gamma_{2h}^{(A)} = u_{2h} = 0.10025\\ \\mathrm{s}^{-1}$$\n$$\\gamma_{4h}^{(A)} = u_{4h} = 0.1010\\ \\mathrm{s}^{-1}$$\n\n首先，我们使用推导出的公式和 $r=2$ 来计算观测到的精度阶 $p$：\n$$p = \\frac{\\ln\\left(\\frac{u_{4h} - u_{2h}}{u_{2h} - u_h}\\right)}{\\ln(2)} = \\frac{\\ln\\left(\\frac{0.1010 - 0.10025}{0.10025 - 0.1000625}\\right)}{\\ln(2)}$$\n$$p = \\frac{\\ln\\left(\\frac{0.00075}{0.0001875}\\right)}{\\ln(2)} = \\frac{\\ln(4)}{\\ln(2)} = \\frac{2\\ln(2)}{\\ln(2)} = 2$$\n观测到的精度阶恰好为 $p=2$，表明该数值方法是二阶精度的，并且已完全进入其渐近收敛区域。\n\n接下来，我们使用两个最细的层级（$h$ 和 $2h$）来计算连续介质增长率 $u^\\star$ 的估计量。当 $p=2$ 和 $r=2$ 时，Richardson 外推公式变为：\n$$u^\\star = \\frac{r^{p} u_h - u_{rh}}{r^{p} - 1} = \\frac{2^{2} u_h - u_{2h}}{2^{2} - 1} = \\frac{4 u_h - u_{2h}}{3}$$\n\n代入 $u_h$ 和 $u_{2h}$ 的值：\n$$u^\\star = \\frac{4(0.1000625) - 0.10025}{3} = \\frac{0.40025 - 0.10025}{3}$$\n$$u^\\star = \\frac{0.30000}{3} = 0.1$$\n\n问题要求最终答案四舍五入到四位有效数字。因此，增长率的连续介质估计值为 $0.1000\\ \\mathrm{s}^{-1}$。",
            "answer": "$$\\boxed{0.1000}$$"
        },
        {
            "introduction": "理解性能瓶颈是代码优化和跨代码比较的关键。本练习将引导您为一个典型的计算核心——稀疏矩阵向量乘法——构建一个“屋顶线”（Roofline）性能模型。通过计算其算术强度（即浮点运算次数与内存访问字节数的比值），您可以预测其性能是由处理器计算峰值限制还是由内存带宽限制。这项实践提供了一种基于第一性原理的性能预测方法，使您能够在给定的硬件架构上识别性能瓶颈并评估不同代码实现的效率。",
            "id": "3957002",
            "problem": "在计算聚变科学与工程领域，跨代码比较需要基于第一性原理的性能模型，这些模型需适用于不同的实现和架构。考虑一个用于漂移-动理学求解器中回旋动理学泊松算子的稀疏矩阵向量乘法核心。该算子以压缩稀疏行（CSR）格式存储，并以 $\\mathbf{y} \\leftarrow \\mathbf{A}\\mathbf{x}$ 的形式应用，其中 $\\mathbf{A}$ 是稀疏矩阵，$\\mathbf{x}$ 和 $\\mathbf{y}$ 是稠密向量，所有浮点量的算术运算均为双精度。\n\n两种代码实现对索引的处理方式不同：\n- 代码 $\\mathcal{A}$ 对CSR列索引使用 $64$ 位索引，对行指针使用 $64$ 位。\n- 代码 $\\mathcal{B}$ 对CSR列索引使用 $32$ 位索引，对行指针使用 $32$ 位。\n\n假设在一个代表非线性回旋动理学离散化的大型矩阵上，该核心具有以下科学上符合实际的属性：\n- 未知量数量为 $n = 10^{7}$，每行平均非零元数量为 $k = 32$，其不规则的稀疏性阻止了内存层次结构中 $\\mathbf{x}$ 元素在不同非零元间的重用。\n- 每个非零元贡献一次浮点乘法和一次浮点加法，总计每个非零元 $2$ 次浮点运算。\n- 对于每个非零元，从主存读/写的数据项如下：\n  - 矩阵值：$8$ 字节。\n  - CSR列索引：代码 $\\mathcal{A}$ 中为 $8$ 字节，代码 $\\mathcal{B}$ 中为 $4$ 字节。\n  - 输入向量值 $\\mathbf{x}[\\text{col}]$：$8$ 字节。\n  - $\\mathbf{y}[\\text{row}]$ 的输出累加可以建模为每行一次 $8$ 字节的读取和一次 $8$ 字节的写入，均匀摊销到该行的 $k$ 个非零元上，得出每个非零元的成本为 $16/k$ 字节。\n  - CSR行指针的访问，摊销后每个非零元的成本在代码 $\\mathcal{A}$ 中为 $8/k$ 字节，在代码 $\\mathcal{B}$ 中为 $4/k$ 字节。\n\n设目标硬件为配备第二代高带宽内存（HBM2）的图形处理单元（GPU），其持续流式内存带宽测量值为 $B = 1.6 \\times 10^{12}$ 字节/秒，供应商峰值双精度吞吐量为 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ 次浮点运算/秒。\n\n仅从算术强度和屋顶线边界的定义出发，\n- 算术强度：$I = \\frac{\\text{浮点运算次数}}{\\text{与主存之间传输的字节数}}$，\n- 屋顶线边界：$P \\le \\min\\!\\big(P_{\\text{peak}},\\, I B\\big)$,\n\n推导代码 $\\mathcal{A}$ 和代码 $\\mathcal{B}$ 的算术强度，确定每种代码在指定GPU上的屋顶线性能边界，然后计算代码 $\\mathcal{B}$ 相对于代码 $\\mathcal{A}$ 在此GPU上的预测加速比 $S$，定义为 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$。将最终加速比表示为一个四舍五入到四位有效数字的无量纲数。最终答案无需单位。",
            "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 问题验证\n\n**步骤1：提取已知条件**\n\n- **核心**：稀疏矩阵向量乘法，$\\mathbf{y} \\leftarrow \\mathbf{A}\\mathbf{x}$。\n- **矩阵表示**：压缩稀疏行（CSR）。\n- **精度**：双精度（每个浮点量 $8$ 字节）。\n- **代码 $\\mathcal{A}$ 的索引**：$64$ 位（$8$ 字节）列索引和行指针。\n- **代码 $\\mathcal{B}$ 的索引**：$32$ 位（$4$ 字节）列索引和行指针。\n- **矩阵属性**：未知量数量 $n = 10^{7}$，每行平均非零元数量 $k = 32$。稀疏性不规则，阻止 $\\mathbf{x}$ 的缓存重用。\n- **运算**：每个非零元 $2$ 次浮点运算（一次乘法，一次加法）。\n- **每个非零元的内存流量**：\n  - 矩阵值（$A_{ij}$）：$8$ 字节。\n  - CSR列索引：代码 $\\mathcal{A}$ 为 $8$ 字节，代码 $\\mathcal{B}$ 为 $4$ 字节。\n  - 输入向量值（$x_j$）：$8$ 字节。\n  - 输出向量值（$y_i$）：$16/k$ 字节（摊销的读/写）。\n  - CSR行指针：代码 $\\mathcal{A}$ 为 $8/k$ 字节，代码 $\\mathcal{B}$ 为 $4/k$ 字节（摊销的）。\n- **硬件规格**：\n  - 持续内存带宽 $B = 1.6 \\times 10^{12}$ 字节/秒。\n  - 峰值双精度吞吐量 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ FLOPS/秒。\n- **定义**：\n  - 算术强度：$I = \\frac{\\text{浮点运算次数}}{\\text{与主存之间传输的字节数}}$。\n  - 屋顶线边界：$P \\le \\min\\!\\big(P_{\\text{peak}},\\, I B\\big)$。\n- **目标**：计算加速比 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$，四舍五入到四位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n\n该问题具有科学依据、是适定的、且客观的。它描述了一个使用成熟的屋顶线模型的标准性能建模场景（GPU上的稀疏矩阵向量乘法）。所提供的关于矩阵大小、稀疏度、硬件带宽和峰值性能的参数对于当代计算科学中的高性能计算是符合实际的。$32$位和$64$位索引之间的区别是科学代码优化中一个常见且实际的考虑因素。该问题是自洽的，提供了所有必要的数据和定义。问题中没有矛盾、歧义或科学上不成立的前提。矩阵行数 $n=10^7$ 和总非零元数 $n \\times k = 3.2 \\times 10^8$ 均可使用 $32$ 位整数寻址（$32$ 位整数可表示的最大值为 $2^{32}-1 \\approx 4.29 \\times 10^9$），这使得代码 $\\mathcal{B}$ 的前提是有效的。\n\n**步骤3：结论与行动**\n\n问题有效。将提供完整解答。\n\n### 解答推导\n\n目标是计算预测加速比 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$。这需要确定每个代码实现的屋顶线性能边界。屋顶线模型给出了性能 $P$ 的一个上界，由下式给出：\n$$\nP \\le \\min(P_{\\text{peak}}, I B)\n$$\n其中 $P_{\\text{peak}}$ 是峰值浮点吞吐量，$B$ 是持续内存带宽，$I$ 是算术强度。算术强度定义为浮点运算次数与处理器和主存之间传输的数据字节数之比。我们首先计算代码 $\\mathcal{A}$ 和代码 $\\mathcal{B}$ 的算术强度。\n\n计算的基本单元是处理矩阵 $\\mathbf{A}$ 的一个非零元素。\n每个非零元的浮点运算次数给定为 $2$ 次（FLOPS）。\n\n每个非零元从/向主存传输的总字节数 $W$ 是所有被访问数据项大小的总和。\n\n对于代码 $\\mathcal{A}$（使用 $64$ 位索引）：\n每个非零元的内存流量 $W_{\\mathcal{A}}$ 是以下各项的总和：\n- 矩阵值：$8$ 字节\n- CSR列索引：$8$ 字节\n- 输入向量元素 $\\mathbf{x}[\\text{col}]$：$8$ 字节\n- 摊销的输出向量元素 $\\mathbf{y}[\\text{row}]$ 流量：$\\frac{16}{k}$ 字节\n- 摊销的CSR行指针流量：$\\frac{8}{k}$ 字节\n\n因此，代码 $\\mathcal{A}$ 每个非零元的总字节数为：\n$$\nW_{\\mathcal{A}} = 8 + 8 + 8 + \\frac{16}{k} + \\frac{8}{k} = 24 + \\frac{24}{k}\n$$\n给定每行平均非零元数为 $k = 32$：\n$$\nW_{\\mathcal{A}} = 24 + \\frac{24}{32} = 24 + 0.75 = 24.75 \\text{ 字节/非零元}\n$$\n代码 $\\mathcal{A}$ 的算术强度为：\n$$\nI_{\\mathcal{A}} = \\frac{\\text{每个非零元的FLOPS}}{W_{\\mathcal{A}}} = \\frac{2}{24.75} \\text{ FLOPS/字节}\n$$\n\n对于代码 $\\mathcal{B}$（使用 $32$ 位索引）：\n每个非零元的内存流量 $W_{\\mathcal{B}}$ 是以下各项的总和：\n- 矩阵值：$8$ 字节\n- CSR列索引：$4$ 字节\n- 输入向量元素 $\\mathbf{x}[\\text{col}]$：$8$ 字节\n- 摊销的输出向量元素 $\\mathbf{y}[\\text{row}]$ 流量：$\\frac{16}{k}$ 字节\n- 摊销的CSR行指针流量：$\\frac{4}{k}$ 字节\n\n因此，代码 $\\mathcal{B}$ 每个非零元的总字节数为：\n$$\nW_{\\mathcal{B}} = 8 + 4 + 8 + \\frac{16}{k} + \\frac{4}{k} = 20 + \\frac{20}{k}\n$$\n当 $k = 32$ 时：\n$$\nW_{\\mathcal{B}} = 20 + \\frac{20}{32} = 20 + 0.625 = 20.625 \\text{ 字节/非零元}\n$$\n代码 $\\mathcal{B}$ 的算术强度为：\n$$\nI_{\\mathcal{B}} = \\frac{\\text{每个非零元的FLOPS}}{W_{\\mathcal{B}}} = \\frac{2}{20.625} \\text{ FLOPS/字节}\n$$\n\n接下来，我们确定每个代码的性能边界。我们必须将受内存限制的性能 $I B$ 与峰值性能 $P_{\\text{peak}}$ 进行比较。\n给定 $B = 1.6 \\times 10^{12}$ 字节/秒 和 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ FLOPS/秒。\n\n对于代码 $\\mathcal{A}$：\n$$\nI_{\\mathcal{A}} B = \\frac{2}{24.75} \\times (1.6 \\times 10^{12}) \\approx 0.0808 \\times 1.6 \\times 10^{12} \\approx 0.129 \\times 10^{12} \\text{ FLOPS/s}\n$$\n由于 $I_{\\mathcal{A}} B \\approx 0.129 \\times 10^{12} \\text{ FLOPS/s} \\ll 9.7 \\times 10^{12} \\text{ FLOPS/s} = P_{\\text{peak}}$，性能受内存带宽限制。\n因此，代码 $\\mathcal{A}$ 的性能边界是 $P_{\\text{bound}, \\mathcal{A}} = I_{\\mathcal{A}} B$。\n\n对于代码 $\\mathcal{B}$：\n$$\nI_{\\mathcal{B}} B = \\frac{2}{20.625} \\times (1.6 \\times 10^{12}) \\approx 0.0969 \\times 1.6 \\times 10^{12} \\approx 0.155 \\times 10^{12} \\text{ FLOPS/s}\n$$\n同样地，$I_{\\mathcal{B}} B \\approx 0.155 \\times 10^{12} \\text{ FLOPS/s} \\ll 9.7 \\times 10^{12} \\text{ FLOPS/s} = P_{\\text{peak}}$，所以性能也受内存带宽限制。\n因此，代码 $\\mathcal{B}$ 的性能边界是 $P_{\\text{bound}, \\mathcal{B}} = I_{\\mathcal{B}} B$。\n\n代码 $\\mathcal{B}$ 相对于代码 $\\mathcal{A}$ 的预测加速比 $S$ 为：\n$$\nS = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}} = \\frac{I_{\\mathcal{B}} B}{I_{\\mathcal{A}} B} = \\frac{I_{\\mathcal{B}}}{I_{\\mathcal{A}}}\n$$\n代入 $I_{\\mathcal{A}}$ 和 $I_{\\mathcal{B}}$ 的表达式：\n$$\nS = \\frac{2/W_{\\mathcal{B}}}{2/W_{\\mathcal{A}}} = \\frac{W_{\\mathcal{A}}}{W_{\\mathcal{B}}}\n$$\n使用计算出的 $W_{\\mathcal{A}}$ 和 $W_{\\mathcal{B}}$ 的值：\n$$\nS = \\frac{24.75}{20.625}\n$$\n为精确计算该值：\n$$\nS = \\frac{24 + 3/4}{20 + 5/8} = \\frac{99/4}{165/8} = \\frac{99}{4} \\times \\frac{8}{165} = \\frac{99 \\times 2}{165} = \\frac{198}{165}\n$$\n将分子和分母同除以它们的最大公约数 $33$：\n$$\nS = \\frac{198 / 33}{165 / 33} = \\frac{6}{5} = 1.2\n$$\n问题要求答案四舍五入到四位有效数字。\n$$\nS = 1.200\n$$",
            "answer": "$$\\boxed{1.200}$$"
        },
        {
            "introduction": "对于大规模聚变模拟而言，一个关键的性能指标是代码在增加处理器数量时的扩展能力。本练习将指导您推导和分析“弱扩展”（weak scaling）效率，即在每个处理器工作负载固定的情况下，代码的性能表现。您将构建一个包含计算、最近邻通信和全局集合操作等开销的性能模型，以理解限制大规模并行应用效率的因素。这项实践有助于您设计出既能评估性能、又能保持物理问题相关分辨率的有意义的扩展性基准测试。",
            "id": "3956942",
            "problem": "一个与聚变相关的计算场景是比较计算聚变科学与工程中使用的两类模拟代码的弱标度行为：一个是回旋动理学粒子模拟 (PIC) 代码，另一个是伪谱磁流体动力学 (MHD) 代码。弱标度的定义是：在保持每个进程的工作负载固定的同时，增加进程总数 $N$。为了进行有物理意义的比较，随着 $N$ 的增加，基准测试必须保持与物理相关的分辨率约束，例如在回旋动理学中解析离子拉莫尔半径尺度的涨落，在 MHD 中解析阿尔芬级联。\n\n假设在并行计算机上，每个时间步的求解时间具有以下基本模型：\n- 对于计算，每个进程更新固定数量的单元格 $M$，其成本与单元格数量成正比，建模为 $T_{\\text{comp}} = c_f M$，其中 $c_f$ 是每个单元格每个时间步的计算时间。\n- 对于最近邻通信，每个进程在一个三维区域分解的笛卡尔网格（排列为 $p \\times p \\times p$，其中 $p = N^{1/3}$）上与 $6$ 个邻居交换晕圈数据，使用 Hockney 延迟-带宽模型进行点对点通信，即 $T_{\\text{msg}} = \\alpha + m/B$，其中 $\\alpha$ 是延迟， $m$ 是消息大小（单位：字节），$B$ 是渐进带宽（单位：字节/秒）。\n- 对于全局诊断，每个时间步执行 $c_{\\text{red}}$ 次有效载荷为 $r$ 字节的全局归约操作，其成本建模为 $T_{\\text{red}} = c_{\\text{red}} \\left[ \\alpha \\log_{2}(N) + \\frac{r}{B} \\log_{2}(N) \\right]$。\n\n随着 $N$ 的增加，基准测试定义必须保持与物理相关的分辨率：\n- 对于回旋动理学，要求垂直网格间距 $\\Delta x$ 能够解析区间 $[0.1, 1.0]$ 内的 $k_{\\perp} \\rho_i$，并保持每个单元格内有足够数量的粒子以解析分布函数矩。这里 $\\rho_i$ 是离子拉莫尔半径，$k_{\\perp}$ 是垂直波数。\n- 对于 MHD，要求最大可分辨波数 $k_{\\max}$ 在耗散尺度上满足 $k_{\\max} \\eta \\gtrsim 1$（其中 $\\eta$ 为电阻率），并保持每个进程的网格点数固定，以解析阿尔芬涨落和惯性区。在弱标度下，每个进程的网格间距和模式/单元格数量保持不变，而全局域大小随 $N$ 增长。\n\n考虑一个在数据移动和网格拓扑方面对两种代码都通用的单一基准配置，其参数如下：\n- 每个进程的单元格数量 $M = 128^{3}$，每个单元格的计算时间 $c_f = 2.0 \\times 10^{-9}$ 秒。\n- 晕圈宽度 $h = 2$ 个单元格，每个单元格有 $v = 10$ 个双精度变量，每个变量 $8$ 字节，因此每个单元格的字节数 $b = 8 v$。每个面的消息大小为 $m_{\\text{face}} = h \\, b \\, n_{\\text{face}}$，其中 $n_{\\text{face}} = 128^{2}$ 是一个面上的单元格数量。每个进程有 $6$ 个面。\n- 延迟 $\\alpha = 2.5 \\times 10^{-6}$ 秒，带宽 $B = 25 \\times 10^{9}$ 字节/秒。\n- 全局归约有效载荷 $r = 64$ 字节，每个时间步进行 $c_{\\text{red}} = 3$ 次归约。\n\n从上述基本模型和约束出发，推导弱标度效率的解析表达式，该效率定义为单进程运行时间与 N 进程运行时间（每个进程的工作负载固定）的比值，然后使用提供的参数计算 $N = 512$ 时的效率值。将最终数值结果四舍五入到四位有效数字。效率表示为一个纯数（无单位）。\n\n用文字解释，所述的基准测试定义如何随着 $N$ 的增加为两种代码保持与物理相关的分辨率，并论证为何所选的通信模型组件适合在弱标度下进行跨代码比较。不要使用任何未从所提供基础中得到证明的快捷公式；根据需要从第一性原理构建任何中间表达式。",
            "solution": "问题陈述已经过评估，被认为是有效的。它在计算等离子体物理和高性能计算方面有科学依据，定义了所有必要参数，问题是适定的，并且其表述是客观的。我们可以开始求解。\n\n目标是基于为聚变模拟代码提供的性能模型，推导弱标度效率 $\\epsilon_W(N)$ 的表达式，并计算其在 $N=512$ 时的值。弱标度的特点是每个进程的工作负载固定，而总问题规模随着进程数 $N$ 的增加而增长。\n\n首先，我们建立 $N$ 个进程每个时间步的总求解时间，记为 $T(N)$。这个时间是计算时间 $T_{\\text{comp}}$ 和通信时间 $T_{\\text{comm}}$ 的总和。\n$$T(N) = T_{\\text{comp}}(N) + T_{\\text{comm}}(N)$$\n在弱标度场景中，每个进程的计算量是恒定的。问题给出了每个进程的计算时间为 $T_{\\text{comp}} = c_f M$，其中 $M$ 是每个进程固定的单元格数量，$c_f$ 是每个单元格的计算时间。因此，计算时间与 $N$ 无关：\n$$T_{\\text{comp}}(N) = c_f M = \\text{constant}$$\n\n通信时间 $T_{\\text{comm}}(N)$ 由两部分组成：最近邻晕圈交换 $T_{\\text{halo}}(N)$ 和全局归约 $T_{\\text{red}}(N)$。\n$$T_{\\text{comm}}(N) = T_{\\text{halo}}(N) + T_{\\text{red}}(N)$$\n\n对于最近邻通信，每个进程在一个 $p \\times p \\times p$ 的笛卡尔网格上与其 $6$ 个邻居交换数据，其中 $p = N^{1/3}$。单个点对点消息的时间由 Hockney 模型给出，$T_{\\text{msg}} = \\alpha + m/B$。问题没有指明这 $6$ 次晕圈交换是否可以重叠。我们将采用一个标准且保守的假设，即总时间是每次消息时间的总和。由于在弱标度中每个进程的数据块是恒定的（$M=128^3$），所以面大小（$n_{\\text{face}}=128^2$）和晕圈深度（$h=2$）也是恒定的。这意味着一个面的消息大小 $m_{\\text{face}}$ 也是恒定的。\n一个面的消息大小为 $m_{\\text{face}} = h \\cdot b \\cdot n_{\\text{face}}$，其中 $b=8v$ 是每个单元格的字节数。由于 $m_{\\text{face}}$ 是恒定的，所以 $6$ 次消息传输中每次的时间都相同。\n$$T_{\\text{halo}}(N) = 6 \\times T_{\\text{msg}} = 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right)$$\n对于 $N=1$，没有邻居，所以 $T_{\\text{halo}}(1)=0$。因此，该项仅应在 $N  1$ 时包含。\n\n对于全局诊断，$c_{\\text{red}}$ 次全局归约操作的时间为：\n$$T_{\\text{red}}(N) = c_{\\text{red}} \\left[ \\alpha \\log_{2}(N) + \\frac{r}{B} \\log_{2}(N) \\right] = c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)$$\n该模型内在地得出 $T_{\\text{red}}(1) = 0$，因为 $\\log_{2}(1)=0$。\n\n结合这些分量，$N$ 个进程的总时间为：\n$$T(N) = c_f M + 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) \\cdot I(N1) + c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)$$\n其中 $I(N1)$ 是一个指示函数，当 $N  1$ 时为 $1$，当 $N=1$ 时为 $0$。\n\n单个进程的时间 $T(1)$ 仅为计算部分，因为通信开销为零：\n$$T(1) = c_f M$$\n\n弱标度效率 $\\epsilon_W(N)$ 定义为单进程运行时间与 $N$ 进程运行时间的比值。\n$$\\epsilon_W(N) = \\frac{T(1)}{T(N)}$$\n对于 $N1$，效率的解析表达式为：\n$$\\epsilon_W(N) = \\frac{c_f M}{c_f M + 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) + c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)}$$\n\n接下来，我们使用提供的参数计算 $N = 512$ 时此表达式的值。\n首先，我们计算中间值：\n- 每个进程的单元格数：$M = 128^3 = 2,097,152$。\n- 计算时间：$T_{\\text{comp}} = T(1) = c_f M = (2.0 \\times 10^{-9} \\text{ s}) \\times 128^3 = 4.194304 \\times 10^{-3} \\text{ s}$。\n- 每个单元格的字节数：$b = 8v = 8 \\times 10 = 80$ 字节。\n- 一个面上的单元格数：$n_{\\text{face}} = 128^2 = 16,384$。\n- 面消息大小：$m_{\\text{face}} = h \\cdot b \\cdot n_{\\text{face}} = 2 \\times 80 \\times 128^2 = 2,621,440$ 字节。\n- 给定参数：$\\alpha = 2.5 \\times 10^{-6}$ s, $B = 25 \\times 10^9$ 字节/秒, $c_{\\text{red}} = 3$, $r = 64$ 字节。\n- $N = 512$，所以 $\\log_{2}(N) = \\log_{2}(512) = 9$。\n\n现在我们计算 $N=512$ 时的通信时间分量：\n- 晕圈交换时间：\n$$T_{\\text{halo}}(512) = 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) = 6 \\left( 2.5 \\times 10^{-6} + \\frac{2,621,440}{25 \\times 10^9} \\right) \\text{ s}$$\n$$T_{\\text{halo}}(512) = 6 \\left( 2.5 \\times 10^{-6} + 1.048576 \\times 10^{-4} \\right) \\text{ s} = 6 (1.073576 \\times 10^{-4}) \\text{ s} = 6.441456 \\times 10^{-4} \\text{ s}$$\n- 全局归约时间：\n$$T_{\\text{red}}(512) = c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(512) = 3 \\left( 2.5 \\times 10^{-6} + \\frac{64}{25 \\times 10^9} \\right) \\times 9 \\text{ s}$$\n$$T_{\\text{red}}(512) = 27 \\left( 2.5 \\times 10^{-6} + 2.56 \\times 10^{-9} \\right) \\text{ s} = 27 (2.50256 \\times 10^{-6}) \\text{ s} = 6.756912 \\times 10^{-5} \\text{ s}$$\n\n$N=512$ 个进程的总时间是所有分量的总和：\n$$T(512) = T_{\\text{comp}} + T_{\\text{halo}}(512) + T_{\\text{red}}(512)$$\n$$T(512) = (4.194304 \\times 10^{-3} + 6.441456 \\times 10^{-4} + 6.756912 \\times 10^{-5}) \\text{ s}$$\n$$T(512) = (0.004194304 + 0.0006441456 + 0.00006756912) \\text{ s} = 0.00490601872 \\text{ s}$$\n\n最后，弱标度效率为：\n$$\\epsilon_W(512) = \\frac{T(1)}{T(512)} = \\frac{4.194304 \\times 10^{-3}}{0.00490601872} \\approx 0.8549285$$\n四舍五入到四位有效数字，效率为 $0.8549$。\n\n**关于物理分辨率和通信模型适用性的解释：**\n\n问题要求解释基准测试定义如何保持与物理相关的分辨率，并为所选的通信模型提供理由。\n\n1.  **保持与物理相关的分辨率：**\n    -   **回旋动理学 (GK)：** 回旋动理学模拟研究聚变等离子体中的微观不稳定性和湍流，其特征尺度长度是离子拉莫尔半径 $\\rho_i$。物理过程由垂直波数 $k_{\\perp}$ 处的相互作用决定，其中 $k_{\\perp}\\rho_i \\approx 1$。基准测试要求解析 $k_{\\perp} \\rho_i \\in [0.1, 1.0]$ 的范围，这确保了模拟的网格间距 $\\Delta x$ 足够精细，以捕捉驱动湍流的不稳定模式。在弱标度中，每个进程的单元格数量（$M$）是固定的。这意味着每个进程的网格间距 $\\Delta x$ 也是固定的。随着进程总数 $N$ 的增加，模拟的总物理体积随之增长（$L_{total} \\propto N^{1/3}$），但在所有地方都保持了对小的、物理上重要的尺度（量级为 $\\rho_i$）的分辨率。每个单元格中固定的粒子数也至关重要，因为它将 PIC 方法固有的统计噪声保持在相对于物理信号的恒定、受控水平。\n    -   **磁流体动力学 (MHD)：** MHD 模拟通常关注更大尺度的现象和湍流。在 MHD 湍流中，能量从大尺度级联到小尺度，并在小尺度上被电阻率 $\\eta$ 耗散。条件 $k_{\\max} \\eta \\gtrsim 1$ 确保了模拟的最大可分辨波数 $k_{\\max} \\sim \\pi/\\Delta x$ 足以捕捉耗散尺度上的物理过程。与 GK 情况一样，弱标度设置固定了每个进程的网格点数，从而固定了 $\\Delta x$ 和 $k_{\\max}$。随着 $N$ 的增加，模拟在更大的盒子中解析了同样精细的尺度。这允许了更大的惯性区（能量注入和耗散之间的尺度范围），这对于研究充分发展的湍流的特性至关重要。\n\n2.  **通信模型的合理性论证：**\n    -   **最近邻（Hockney 模型）：** 使用网格上的区域分解的科学代码，例如所述的 GK 和 MHD 代码，必须在相邻子域之间交换边界信息。这被称为晕圈或幽灵单元交换。此过程是经典的最近邻通信模式。Hockney 延迟-带宽模型 $T_{\\text{msg}} = \\alpha + m/B$ 是点对点消息传递的基本性能模型，它捕捉了两个主要成本：固定的启动成本（延迟，$\\alpha$）和与消息大小成正比的数据传输成本（带宽，$B$）。它是一个适合跨代码比较的模型，因为它代表了底层硬件和网络的基本性能特征，而不过于复杂。在三维弱标度中，每个进程的计算体积是固定的，这意味着用于晕圈交换的表面积也是固定的。该模型正确地反映了消息大小 $m_{\\text{face}}$ 以及每个进程的晕圈交换成本（不包括此处未建模的可能由网络争用引起的对数项）随着 $N$ 的增加基本保持不变。\n    -   **全局归约（对数模型）：** GK 和 MHD 模拟都需要定期的全局操作来进行诊断（例如，计算像能量这样的总守恒量）或确保数值稳定性（例如，找到全局最大值以确定时间步长）。这些操作通过像 `MPI_Allreduce` 这样的集体操作来实现。在大多数超级计算机互连上，高效并行归约算法的成本与 $\\log(N)$ 成正比。模型 $T_{\\text{red}} \\propto \\log_2(N)$ 正确地捕捉了这种标度行为。它包括一个与归约树中通信步数（$\\log_2(N)$）成比例的延迟项，以及一个用于在各个阶段传输数据有效载荷的带宽项。这使其成为一个现实且合适的模型，用于描述即使在弱标度背景下，随着机器规模 $N$ 的增加而不可避免增长的全局通信开销。",
            "answer": "$$\\boxed{0.8549}$$"
        }
    ]
}