{
    "hands_on_practices": [
        {
            "introduction": "在进行任何性能基准测试之前，首要任务是验证代码是否正确地求解了其设计的物理方程，即代码验证（code verification）。此练习将引导你运用理查森外推法（Richardson extrapolation），这是一种强大的数值分析技术，用于通过系统性的网格加密研究来评估数值解的收敛阶。通过这个实践，你不仅能够估计出离散化误差，还能得到一个比任何单次模拟结果都更精确的连续介质解的估计值，这是确保仿真结果可靠性的基石。",
            "id": "3956960",
            "problem": "一项计算聚变科学与工程领域的跨代码基准测试练习，考虑了二维周期性平板中电阻磁流体力学（MHD）的线性撕裂模。我们感兴趣的物理量是无量纲的模增长率，记为 $\\gamma$，在固定归一化条件下以 $\\mathrm{s}^{-1}$ 为单位进行测量。两个生产代码采用有限体积空间离散化和显式时间步进方法，具有相同的物理模型参数（恒定电阻率、相同的边界条件、相同的平衡剖面和相同的归一化），但可能具有不同的数值实现。为了对跨代码比较进行严格的网格加密研究，您将设计并使用以下程序：\n\n- 固定除均匀网格间距 $h$ 和时间步长 $\\Delta t$ 之外的所有物理和数值参数。\n- 以一个恒定的比率 $r$ 加密网格，使得 $2h$ 和 $4h$ 是较粗的层级，而 $h$ 是最细的层级。在两个代码中都使用相同的加密比率 $r$。\n- 根据 Courant–Friedrichs–Lewy (CFL) 条件选择 $\\Delta t$，使得 $\\Delta t \\propto h$，并固定 CFL 数，以确保时间误差在不同加密层级之间保持相称。\n- 对于每个网格层级，从饱和线性区提取一个我们感兴趣的标量诊断量 $u_h$，此处 $u_h \\equiv \\gamma_h$。\n- 假设对于足够小的 $h$，离散解遵循渐近误差展开式 $u_h = u^\\star + C h^{p} + \\mathcal{O}(h^{p+1})$，其中 $u^\\star$ 是连续介质下的物理量，$C$ 是一个常数，$p$ 是关于 $h$ 的形式精度阶。\n\n从这个渐近展开式和基本定义出发，推导一个使用两个比率为 $r$ 的网格层级和由 $p$ 表征的主阶项的 $u^\\star$ 的形式估计量。然后，仅使用测量的离散解，从三个网格层级估计 $p$。最后，应用该估计量，使用最精细的两个层级来产生增长率的连续介质估计值。\n\n对于代码 A，在三个网格层级上测得的增长率如下：\n$$\\gamma_{4h}^{(A)} = 0.1010\\ \\mathrm{s}^{-1},\\quad \\gamma_{2h}^{(A)} = 0.10025\\ \\mathrm{s}^{-1},\\quad \\gamma_{h}^{(A)} = 0.1000625\\ \\mathrm{s}^{-1},$$\n加密比率为 $r = 2$。使用这些数据：\n1. 推导一个仅用 $\\{u_h, u_{2h}, u_{4h}\\}$ 和 $r$ 表示的 $p$ 的表达式。\n2. 使用两个比率为 $r$ 的网格层级和已知的 $p$，推导 $u^\\star$ 的 Richardson 外推估计量。\n3. 使用最精细的两个层级对代码 A 的估计量进行求值，并以 $\\mathrm{s}^{-1}$ 为单位表示最终的增长率连续介质估计值。\n\n将您最终的连续介质增长率数值答案四舍五入到四位有效数字。",
            "solution": "问题陈述已经过严格验证，被认为是有效的。它在科学上基于数值分析和计算物理的原理，特别是用于代码验证的 Richardson 外推法。该问题是适定的、客观的，并提供了推导所需估计量和计算最终值的所有必要信息。\n\n任务是从给定的渐近误差展开式中推导精度阶 $p$ 和连续解 $u^\\star$ 的估计量，然后将它们应用于数值模拟的实验数据。\n\n假设在网格间距为 $h$ 时的离散解 $u_h$ 的渐近误差展开式为：\n$$u_h = u^\\star + C h^{p} + \\mathcal{O}(h^{p+1})$$\n其中 $u^\\star$ 是精确的连续解，$C$ 是一个与 $h$ 无关的常数，$p$ 是形式精度阶。在本次分析中，我们将忽略高阶项 $\\mathcal{O}(h^{p+1})$，这在 $h$ 足够小时是标准做法。\n\n**1. 精度阶 $p$ 的推导**\n\n给定三个具有恒定加密比率 $r$ 的网格层级。设网格间距为 $h$（最细）、$rh$（中等）和 $r^2h$（最粗）。相应的离散解记为 $u_h$、$u_{rh}$ 和 $u_{r^2h}$。在问题数据的背景下，这些层级对应于 $h$、$2h$ 和 $4h$，其中 $r=2$。\n\n根据主阶渐近展开式，我们为这三个层级写出方程：\n$$u_h \\approx u^\\star + C h^{p} \\quad (1)$$\n$$u_{rh} \\approx u^\\star + C (rh)^{p} = u^\\star + C r^{p} h^{p} \\quad (2)$$\n$$u_{r^2h} \\approx u^\\star + C (r^2h)^{p} = u^\\star + C r^{2p} h^{p} \\quad (3)$$\n\n为了求出 $p$，我们必须消去未知数 $u^\\star$ 和 $C$。首先，我们通过对连续方程作差来消去 $u^\\star$：\n方程 $(2)$ 减去方程 $(1)$：\n$$u_{rh} - u_h \\approx (u^\\star + C r^{p} h^{p}) - (u^\\star + C h^{p}) = C h^{p} (r^{p} - 1) \\quad (4)$$\n方程 $(3)$ 减去方程 $(2)$：\n$$u_{r^2h} - u_{rh} \\approx (u^\\star + C r^{2p} h^{p}) - (u^\\star + C r^{p} h^{p}) = C h^{p} r^{p} (r^{p} - 1) \\quad (5)$$\n\n现在，我们通过将方程 $(5)$ 与方程 $(4)$ 相除来消去 $C$ 和 $h$：\n$$\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h} \\approx \\frac{C h^{p} r^{p} (r^{p} - 1)}{C h^{p} (r^{p} - 1)} = r^p$$\n\n为了解出 $p$，我们对两边取自然对数：\n$$\\ln\\left(\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h}\\right) \\approx \\ln(r^p) = p \\ln(r)$$\n因此，精度阶 $p$ 的估计量为：\n$$p \\approx \\frac{\\ln\\left(\\frac{u_{r^2h} - u_{rh}}{u_{rh} - u_h}\\right)}{\\ln(r)}$$\n对于所要求的具有 $h$、$2h$ 和 $4h$ 层级的特定表示法，这对应于 $r=2$，表达式为 $p \\approx \\frac{\\ln\\left(\\frac{u_{4h} - u_{2h}}{u_{2h} - u_h}\\right)}{\\ln(2)}$。\n\n**2. $u^\\star$ 的 Richardson 外推估计量的推导**\n\n我们使用两个网格层级 $h$ 和 $rh$，以及对应的解 $u_h$ 和 $u_{rh}$。方程为：\n$$u_h \\approx u^\\star + C h^{p} \\quad (6)$$\n$$u_{rh} \\approx u^\\star + C r^{p} h^{p} \\quad (7)$$\n\n我们的目标是通过消除与 $C h^p$ 成正比的主阶误差项来找到 $u^\\star$ 的估计值。我们可以通过创建方程 $(6)$ 和 $(7)$ 的线性组合来实现这一点。将方程 $(6)$ 乘以 $r^p$：\n$$r^{p} u_h \\approx r^{p} u^\\star + r^{p} C h^{p} \\quad (8)$$\n\n现在，从方程 $(8)$ 中减去方程 $(7)$：\n$$r^{p} u_h - u_{rh} \\approx (r^{p} u^\\star + r^{p} C h^{p}) - (u^\\star + C r^{p} h^{p})$$\n$$r^{p} u_h - u_{rh} \\approx r^{p} u^\\star - u^\\star = u^\\star(r^{p} - 1)$$\n\n求解 $u^\\star$，我们得到 Richardson 外推估计量：\n$$u^\\star \\approx \\frac{r^{p} u_h - u_{rh}}{r^{p} - 1}$$\n该公式通过消去主阶误差项，提供了连续解的一个更高阶的估计。\n\n**3. 应用于代码 A 的数据**\n\n我们得到代码 A 在加密比率 $r=2$ 下的增长率如下：\n$$\\gamma_{h}^{(A)} = u_h = 0.1000625\\ \\mathrm{s}^{-1}$$\n$$\\gamma_{2h}^{(A)} = u_{2h} = 0.10025\\ \\mathrm{s}^{-1}$$\n$$\\gamma_{4h}^{(A)} = u_{4h} = 0.1010\\ \\mathrm{s}^{-1}$$\n\n首先，我们使用推导出的公式和 $r=2$ 计算观测到的精度阶 $p$：\n$$p = \\frac{\\ln\\left(\\frac{u_{4h} - u_{2h}}{u_{2h} - u_h}\\right)}{\\ln(2)} = \\frac{\\ln\\left(\\frac{0.1010 - 0.10025}{0.10025 - 0.1000625}\\right)}{\\ln(2)}$$\n$$p = \\frac{\\ln\\left(\\frac{0.00075}{0.0001875}\\right)}{\\ln(2)} = \\frac{\\ln(4)}{\\ln(2)} = \\frac{2\\ln(2)}{\\ln(2)} = 2$$\n观测到的精度阶恰好为 $p=2$，表明该数值方法是二阶精度的，并且已很好地进入其渐近收敛区域。\n\n接下来，我们使用最精细的两个层级（$h$ 和 $2h$）来评估连续增长率 $u^\\star$ 的估计量。当 $p=2$ 和 $r=2$ 时，Richardson 外推公式变为：\n$$u^\\star = \\frac{r^{p} u_h - u_{rh}}{r^{p} - 1} = \\frac{2^{2} u_h - u_{2h}}{2^{2} - 1} = \\frac{4 u_h - u_{2h}}{3}$$\n\n代入 $u_h$ 和 $u_{2h}$ 的值：\n$$u^\\star = \\frac{4(0.1000625) - 0.10025}{3} = \\frac{0.40025 - 0.10025}{3}$$\n$$u^\\star = \\frac{0.30000}{3} = 0.1$$\n\n问题要求将最终答案四舍五入到四位有效数字。因此，增长率的连续介质估计值为 $0.1000\\ \\mathrm{s}^{-1}$。",
            "answer": "$$\\boxed{0.1000}$$"
        },
        {
            "introduction": "一旦代码的正确性得到验证，下一步就是剖析其性能瓶颈。此练习将向你介绍“屋顶线模型”（Roofline model），这是一种前沿的性能分析工具，用于预测计算核心在特定硬件上的性能上限。你将通过计算“算术强度”（arithmetic intensity）——即每次内存访问所执行的浮点运算次数——来确定一个关键的计算核心（稀疏矩阵向量乘法）是受限于处理器的计算能力还是内存带宽。这个实践对于理解代码与硬件的交互以及指导优化策略至关重要。",
            "id": "3957002",
            "problem": "在计算聚变科学与工程中，跨代码比较需要基于第一性原理的性能模型，这些模型需适用于不同的实现和架构。考虑一个用于漂移动理学求解器中回旋动理学泊松算子的稀疏矩阵向量乘法核心。该算子以压缩稀疏行（CSR）格式存储，并以 $\\mathbf{y} \\leftarrow \\mathbf{A}\\mathbf{x}$ 的形式应用，其中 $\\mathbf{A}$ 是稀疏矩阵，$\\mathbf{x}$ 和 $\\mathbf{y}$ 是稠密向量，所有浮点量的算术运算均为双精度。\n\n两种代码实现对索引的处理方式不同：\n- 代码 $\\mathcal{A}$ 对CSR列索引使用 $64$ 位索引，对行指针使用 $64$ 位指针。\n- 代码 $\\mathcal{B}$ 对CSR列索引使用 $32$ 位索引，对行指针使用 $32$ 位指针。\n\n假设在一个代表非线性回旋动理学离散化的大型矩阵上，该核心具有以下科学上现实的属性：\n- 未知量数量为 $n = 10^{7}$，每行平均非零元数量为 $k = 32$。其稀疏性不规则，导致在内存层次结构中无法跨非零元重用 $\\mathbf{x}$ 的元素。\n- 每个非零元贡献一次浮点乘法和一次浮点加法，总计每个非零元有 $2$ 次浮点运算。\n- 对于每个非零元，读/写到主存的数据项如下：\n  - 矩阵值：$8$ 字节。\n  - CSR列索引：在代码 $\\mathcal{A}$ 中为 $8$ 字节，在代码 $\\mathcal{B}$ 中为 $4$ 字节。\n  - 输入向量值 $\\mathbf{x}[\\text{col}]$：$8$ 字节。\n  - 对 $\\mathbf{y}[\\text{row}]$ 的输出累加可以建模为每行一次 $8$ 字节的读取和一次 $8$ 字节的写入，均匀分摊到该行的 $k$ 个非零元上，得出每个非零元的成本为 $16/k$ 字节。\n  - CSR行指针访问，分摊到每个非零元上，在代码 $\\mathcal{A}$ 中为 $8/k$ 字节，在代码 $\\mathcal{B}$ 中为 $4/k$ 字节。\n\n设目标硬件为配备第二代高带宽内存（HBM2）的图形处理单元（GPU），其实测持续流式内存带宽为 $B = 1.6 \\times 10^{12}$ 字节/秒，供应商标称的峰值双精度吞吐量为 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ 浮点运算/秒。\n\n仅从算术强度和屋顶线边界的定义出发，\n- 算术强度：$I = \\frac{\\text{floating-point operations}}{\\text{bytes transferred to/from main memory}}$，\n- 屋顶线边界：$P \\le \\min\\!\\big(P_{\\textpeak}, I B\\big)$，\n\n推导代码 $\\mathcal{A}$ 和代码 $\\mathcal{B}$ 的算術強度，确定每种代码在指定GPU上的屋顶线性能边界，然后计算代码 $\\mathcal{B}$ 相对于代码 $\\mathcal{A}$ 在此GPU上的预测加速比 $S$，定义为 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$。将最终的加速比表示为一个无量纲数，并四舍五入到四位有效数字。最终答案不需要单位。",
            "solution": "首先根据所需标准对问题陈述进行验证。\n\n### 问题验证\n\n**第1步：提取已知条件**\n\n- **核心**：稀疏矩阵向量乘法，$\\mathbf{y} \\leftarrow \\mathbf{A}\\mathbf{x}$。\n- **矩阵表示**：压缩稀疏行（CSR）。\n- **精度**：双精度（每个浮点量 $8$ 字节）。\n- **代码 $\\mathcal{A}$ 索引**：64位（$8$字节）列索引和行指针。\n- **代码 $\\mathcal{B}$ 索引**：32位（$4$字节）列索引和行指针。\n- **矩阵属性**：未知量数量 $n = 10^{7}$，每行平均非零元数量 $k = 32$。稀疏性不规则，阻止了 $\\mathbf{x}$ 的缓存重用。\n- **运算**：每个非零元 $2$ 次浮点运算（一次乘法，一次加法）。\n- **每个非零元的内存流量**：\n  - 矩阵值 ($A_{ij}$)：$8$ 字节。\n  - CSR列索引：代码 $\\mathcal{A}$ 为 $8$ 字节，代码 $\\mathcal{B}$ 为 $4$ 字节。\n  - 输入向量值 ($x_j$)：$8$ 字节。\n  - 输出向量值 ($y_i$)：$16/k$ 字节（分攤的读/写）。\n  - CSR行指针：代码 $\\mathcal{A}$ 为 $8/k$ 字节，代码 $\\mathcal{B}$ 为 $4/k$ 字节（分摊的）。\n- **硬件规格**：\n  - 持续内存带宽 $B = 1.6 \\times 10^{12}$ 字节/秒。\n  - 峰值双精度吞吐量 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ FLOPS/秒。\n- **定义**：\n  - 算术强度：$I = \\frac{\\text{floating-point operations}}{\\text{bytes transferred to/from main memory}}$。\n  - 屋顶线边界：$P \\le \\min\\!\\big(P_{\\text{peak}},\\, I B\\big)$。\n- **目标**：计算加速比 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$，并四舍五入到四位有效数字。\n\n**第2步：使用提取的已知条件进行验证**\n\n该问题具有科学依据，是适定且客观的。它描述了一个标准的性能建模场景（GPU上的稀疏矩阵向量乘法），使用了成熟的屋顶线模型。所提供的关于矩阵大小、稀疏度、硬件带宽和峰值性能的参数对于当代计算科学中的高性能计算是现实的。32位和64位索引之间的区别是科学代码优化中一个常见且实际的考虑因素。问题是自洽的，提供了所有必要的数据和定义。没有矛盾、歧义或不科学的前提。矩阵行数 $n=10^7$ 和总非零元数 $n \\times k = 3.2 \\times 10^8$ 都可以用32位整数寻址（最多可表示 $2^{32}-1 \\approx 4.29 \\times 10^9$），这使得代码 $\\mathcal{B}$ 的前提是有效的。\n\n**第3步：结论与行动**\n\n问题是有效的。将提供完整的解决方案。\n\n### 解题推导\n\n目标是计算预测加速比 $S = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}}$。这需要确定每种代码实现的屋顶线性能边界。屋顶线模型给出了性能 $P$ 的一个上限：\n$$\nP \\le \\min(P_{\\text{peak}}, I B)\n$$\n其中 $P_{\\text{peak}}$ 是峰值浮点吞吐量，$B$ 是持续内存带宽，$I$ 是算术强度。算术强度定义为浮点运算次数与处理器和主存之间传输的数据字节数之比。我们将首先计算代码 $\\mathcal{A}$ 和代码 $\\mathcal{B}$ 的算術強度。\n\n计算单位是处理矩阵 $\\mathbf{A}$ 的一个非零元素。\n每个非零元的浮点运算次数给定为 $2$ FLOPS。\n\n每个非零元从主存传入/传出的总字节数 $W$ 是所有被访问数据项大小的总和。\n\n对于代码 $\\mathcal{A}$ (使用64位索引)：\n每个非零元的内存流量 $W_{\\mathcal{A}}$ 是以下各项的总和：\n- 矩阵值：$8$ 字节\n- CSR列索引：$8$ 字节\n- 输入向量元素 $\\mathbf{x}[\\text{col}]$：$8$ 字节\n- 分摊的输出向量元素 $\\mathbf{y}[\\text{row}]$ 流量：$\\frac{16}{k}$ 字节\n- 分摊的CSR行指针流量：$\\frac{8}{k}$ 字节\n\n所以，代码 $\\mathcal{A}$ 每个非零元的总字节数为：\n$$\nW_{\\mathcal{A}} = 8 + 8 + 8 + \\frac{16}{k} + \\frac{8}{k} = 24 + \\frac{24}{k}\n$$\n给定每行平均非零元数量 $k = 32$：\n$$\nW_{\\mathcal{A}} = 24 + \\frac{24}{32} = 24 + 0.75 = 24.75 \\text{ 字节/非零元}\n$$\n代码 $\\mathcal{A}$ 的算术强度为：\n$$\nI_{\\mathcal{A}} = \\frac{\\text{FLOPS per nonzero}}{W_{\\mathcal{A}}} = \\frac{2}{24.75} \\text{ FLOPS/byte}\n$$\n\n对于代码 $\\mathcal{B}$ (使用32位索引)：\n每个非零元的内存流量 $W_{\\mathcal{B}}$ 是以下各项的总和：\n- 矩阵值：$8$ 字节\n- CSR列索引：$4$ 字节\n- 输入向量元素 $\\mathbf{x}[\\text{col}]$：$8$ 字节\n- 分摊的输出向量元素 $\\mathbf{y}[\\text{row}]$ 流量：$\\frac{16}{k}$ 字节\n- 分攤的CSR行指针流量：$\\frac{4}{k}$ 字节\n\n所以，代码 $\\mathcal{B}$ 每个非零元的总字节数为：\n$$\nW_{\\mathcal{B}} = 8 + 4 + 8 + \\frac{16}{k} + \\frac{4}{k} = 20 + \\frac{20}{k}\n$$\n当 $k=32$ 时：\n$$\nW_{\\mathcal{B}} = 20 + \\frac{20}{32} = 20 + 0.625 = 20.625 \\text{ 字节/非零元}\n$$\n代码 $\\mathcal{B}$ 的算术强度为：\n$$\nI_{\\mathcal{B}} = \\frac{\\text{FLOPS per nonzero}}{W_{\\mathcal{B}}} = \\frac{2}{20.625} \\text{ FLOPS/byte}\n$$\n\n接下来，我们确定每种代码的性能边界。我们必须将内存限制的性能 $I B$ 与峰值性能 $P_{\\text{peak}}$ 进行比较。\n给定 $B = 1.6 \\times 10^{12}$ 字节/秒 和 $P_{\\text{peak}} = 9.7 \\times 10^{12}$ FLOPS/秒。\n\n对于代码 $\\mathcal{A}$：\n$$\nI_{\\mathcal{A}} B = \\frac{2}{24.75} \\times (1.6 \\times 10^{12}) \\approx 0.0808 \\times 1.6 \\times 10^{12} \\approx 0.129 \\times 10^{12} \\text{ FLOPS/s}\n$$\n由于 $I_{\\mathcal{A}} B \\approx 0.129 \\times 10^{12} \\text{ FLOPS/s} \\ll 9.7 \\times 10^{12} \\text{ FLOPS/s} = P_{\\text{peak}}$，性能受内存带宽限制。\n因此，代码 $\\mathcal{A}$ 的性能边界是 $P_{\\text{bound}, \\mathcal{A}} = I_{\\mathcal{A}} B$。\n\n对于代码 $\\mathcal{B}$：\n$$\nI_{\\mathcal{B}} B = \\frac{2}{20.625} \\times (1.6 \\times 10^{12}) \\approx 0.0969 \\times 1.6 \\times 10^{12} \\approx 0.155 \\times 10^{12} \\text{ FLOPS/s}\n$$\n同样地，$I_{\\mathcal{B}} B \\approx 0.155 \\times 10^{12} \\text{ FLOPS/s} \\ll 9.7 \\times 10^{12} \\text{ FLOPS/s} = P_{\\text{peak}}$，所以性能也受内存带宽约束。\n因此，代码 $\\mathcal{B}$ 的性能边界是 $P_{\\text{bound}, \\mathcal{B}} = I_{\\mathcal{B}} B$。\n\n代码 $\\mathcal{B}$ 相对于代码 $\\mathcal{A}$ 的预测加速比 $S$ 是：\n$$\nS = \\frac{P_{\\text{bound}, \\mathcal{B}}}{P_{\\text{bound}, \\mathcal{A}}} = \\frac{I_{\\mathcal{B}} B}{I_{\\mathcal{A}} B} = \\frac{I_{\\mathcal{B}}}{I_{\\mathcal{A}}}\n$$\n代入 $I_{\\mathcal{A}}$ 和 $I_{\\mathcal{B}}$ 的表达式：\n$$\nS = \\frac{2/W_{\\mathcal{B}}}{2/W_{\\mathcal{A}}} = \\frac{W_{\\mathcal{A}}}{W_{\\mathcal{B}}}\n$$\n使用计算出的 $W_{\\mathcal{A}}$ 和 $W_{\\mathcal{B}}$ 的值：\n$$\nS = \\frac{24.75}{20.625}\n$$\n为了精确计算这个值：\n$$\nS = \\frac{24 + 3/4}{20 + 5/8} = \\frac{99/4}{165/8} = \\frac{99}{4} \\times \\frac{8}{165} = \\frac{99 \\times 2}{165} = \\frac{198}{165}\n$$\n分子和分母同除以它们的最大公约数 $33$：\n$$\nS = \\frac{198 / 33}{165 / 33} = \\frac{6}{5} = 1.2\n$$\n问题要求答案四舍五入到四位有效数字。\n$$\nS = 1.200\n$$",
            "answer": "$$\\boxed{1.200}$$"
        },
        {
            "introduction": "在现代计算聚变科学中，模拟通常在数千个处理器上并行运行，因此理解代码的大规模可扩展性至关重要。此练习将重点关注“弱可扩展性”（weak scaling）分析，即在增加处理器数量的同时保持每个处理器的计算负载不变。你将构建一个包含计算、局部通信和全局通信开销的解析性能模型，以预测代码在大型并行计算机上的效率。通过这个实践，你将学会如何评估和解释并行效率，并理解在设计基准测试时维持物理相关分辨率的重要性。",
            "id": "3956942",
            "problem": "一个与聚变相关的计算情景是比较计算聚变科学与工程中使用的两类模拟的弱扩展行为：一个是回旋动理学胞中粒子(PIC)代码，另一个是伪谱磁流体动力学(MHD)代码。弱扩展定义为在保持每个进程的工作负载固定的同时，增加总进程数 $N$。为了进行有物理意义的比较，基准测试必须在 $N$ 增加时保持与物理相关的分辨率约束，例如在回旋动理学中解析离子拉莫尔半径尺度的涨落，在MHD中解析阿尔芬级联。\n\n假设在并行计算机上，每个时间步的求解时间具有以下基本模型：\n- 对于计算，每个进程更新固定数量的单元 $M$，其成本与单元数量成正比，模型为 $T_{\\text{comp}} = c_f M$，其中 $c_f$ 是每个单元每个时间步的计算时间。\n- 对于近邻通信，每个进程在一个以 $p \\times p \\times p$ 方式排列的三维区域分解笛卡尔网格（其中 $p = N^{1/3}$）上与 $6$ 个邻居交换光环数据，使用 Hockney 延迟-带宽模型进行点对点通信，即 $T_{\\text{msg}} = \\alpha + m/B$，其中 $\\alpha$ 是延迟， $m$ 是消息大小（单位为字节）， $B$ 是渐进带宽（单位为字节/秒）。\n- 对于全局诊断，每个时间步执行 $c_{\\text{red}}$ 次全归约操作，负载为 $r$ 字节，其成本模型为 $T_{\\text{red}} = c_{\\text{red}} \\left[ \\alpha \\log_{2}(N) + \\frac{r}{B} \\log_{2}(N) \\right]$。\n\n基准测试的定义必须在 $N$ 增加时保持与物理相关的分辨率：\n- 对于回旋动理学，要求垂直网格间距 $\\Delta x$ 能在区间 $[0.1, 1.0]$ 内解析 $k_{\\perp} \\rho_i$，并保持每个单元的粒子数固定，足以解析分布函数矩。此处 $\\rho_i$ 是离子拉莫尔半径， $k_{\\perp}$ 是垂直波数。\n- 对于MHD，要求在耗散尺度上，最大解析波数 $k_{\\max}$ 满足 $k_{\\max} \\eta \\gtrsim 1$（其中 $\\eta$ 为电阻率），并保持每个进程的网格点数固定，以解析阿尔芬涨落和惯性区。在弱扩展下，每个进程的网格间距和模式/单元数保持不变，而全局域大小随 $N$ 增长。\n\n考虑两种代码在数据移动和网格拓扑方面共有的单个基准配置，参数如下：\n- 每个进程的单元数 $M = 128^{3}$，每个单元的计算时间 $c_f = 2.0 \\times 10^{-9}$ 秒。\n- 光环宽度 $h = 2$ 个单元，每个单元有 $v = 10$ 个变量（双精度浮点数），每个变量 $8$ 字节，因此每个单元的字节数 $b = 8 v$。每个面的消息大小为 $m_{\\text{face}} = h \\, b \\, n_{\\text{face}}$，其中 $n_{\\text{face}} = 128^{2}$ 是一个面上的单元数。每个进程有 $6$ 个面。\n- 延迟 $\\alpha = 2.5 \\times 10^{-6}$ 秒，带宽 $B = 25 \\times 10^{9}$ 字节/秒。\n- 全归约负载 $r = 64$ 字节，每个时间步进行 $c_{\\text{red}} = 3$ 次归约。\n\n从上述基础和约束出发，推导弱扩展效率的解析表达式（定义为单进程运行时间与 $N$ 进程在每个进程工作负载固定的情况下的运行时间之比），然后使用所提供的参数计算当 $N = 512$ 时的效率值。将最终数值结果四舍五入至四位有效数字。将效率表示为一个纯数（无单位）。\n\n用文字解释所述的基准测试定义如何在这两种代码中随着 $N$ 的增加而保持与物理相关的分辨率，并论证所选的通信模型组件为何适合在弱扩展下进行跨代码比较。不要使用任何未从所提供基础中得到证明的快捷公式；根据需要从第一性原理构建任何中间表达式。",
            "solution": "问题陈述已经过评估，被认为是有效的。它在计算等离子体物理和高性能计算方面有科学依据，提法明确，所有必要参数均已定义，且其表述是客观的。我们可以开始求解。\n\n目标是推导弱扩展效率 $\\epsilon_W(N)$ 的表达式，并基于给定的聚变模拟代码性能模型，计算当 $N=512$ 时的值。弱扩展的特点是每个进程的工作负载固定，而总问题规模随进程数 $N$ 的增加而增长。\n\n首先，我们确定 $N$ 个进程每个时间步的总求解时间，记为 $T(N)$。该时间是计算时间 $T_{\\text{comp}}$ 和通信时间 $T_{\\text{comm}}$ 的总和。\n$$T(N) = T_{\\text{comp}}(N) + T_{\\text{comm}}(N)$$\n在弱扩展情景中，每个进程的计算量是恒定的。问题给出每个进程的计算时间为 $T_{\\text{comp}} = c_f M$，其中 $M$ 是每个进程固定的单元数， $c_f$ 是每个单元的计算时间。因此，计算时间与 $N$ 无关：\n$$T_{\\text{comp}}(N) = c_f M = \\text{constant}$$\n\n通信时间 $T_{\\text{comm}}(N)$ 包括两个部分：近邻光环交换 $T_{\\text{halo}}(N)$ 和全局归约 $T_{\\text{red}}(N)$。\n$$T_{\\text{comm}}(N) = T_{\\text{halo}}(N) + T_{\\text{red}}(N)$$\n\n对于近邻通信，每个进程在一个 $p \\times p \\times p$ 的笛卡尔网格（其中 $p=N^{1/3}$）上与其 $6$ 个邻居交换数据。单个点对点消息的时间由 Hockney 模型给出，$T_{\\text{msg}} = \\alpha + m/B$。问题没有指明这 $6$ 次光环交换是否可以重叠。我们将采纳一个标准且保守的假设，即总时间是每次消息时间的总和。由于在弱扩展中每个进程的数据块是恒定的（$M=128^3$），面的大小（$n_{\\text{face}}=128^2$）和光环深度（$h=2$）也是恒定的。这意味着一个面的消息大小 $m_{\\text{face}}$ 也是恒定的。\n一个面的消息大小为 $m_{\\text{face}} = h \\cdot b \\cdot n_{\\text{face}}$，其中 $b=8v$ 是每个单元的字节数。由于 $m_{\\text{face}}$ 是常数，所以 $6$ 次消息交换中每次的时间都相同。\n$$T_{\\text{halo}}(N) = 6 \\times T_{\\text{msg}} = 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right)$$\n当 $N=1$ 时，没有邻居，因此 $T_{\\text{halo}}(1)=0$。所以，这一项只应在 $N  1$ 时计入。\n\n对于全局诊断， $c_{\\text{red}}$ 次全归约操作的时间为：\n$$T_{\\text{red}}(N) = c_{\\text{red}} \\left[ \\alpha \\log_{2}(N) + \\frac{r}{B} \\log_{2}(N) \\right] = c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)$$\n该模型内在地得出 $T_{\\text{red}}(1) = 0$，因为 $\\log_{2}(1)=0$。\n\n综合这些部分， $N$ 个进程的总时间为：\n$$T(N) = c_f M + 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) \\cdot I(N1) + c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)$$\n其中 $I(N1)$ 是一个指示函数，当 $N  1$ 时为 $1$，当 $N=1$ 时为 $0$。\n\n单个进程的时间 $T(1)$ 仅为计算部分，因为通信开销为零：\n$$T(1) = c_f M$$\n\n弱扩展效率 $\\epsilon_W(N)$ 定义为单进程运行时间与 $N$ 进程运行时间之比。\n$$\\epsilon_W(N) = \\frac{T(1)}{T(N)}$$\n对于 $N1$，效率的解析表达式为：\n$$\\epsilon_W(N) = \\frac{c_f M}{c_f M + 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) + c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(N)}$$\n\n接下来，我们使用所提供的参数计算当 $N = 512$ 时的表达式值。\n首先，我们计算中间值：\n- 每个进程的单元数：$M = 128^3 = 2,097,152$。\n- 计算时间：$T_{\\text{comp}} = T(1) = c_f M = (2.0 \\times 10^{-9} \\text{ s}) \\times 128^3 = 4.194304 \\times 10^{-3} \\text{ s}$。\n- 每个单元的字节数：$b = 8v = 8 \\times 10 = 80$ 字节。\n- 一个面上的单元数：$n_{\\text{face}} = 128^2 = 16,384$。\n- 面的消息大小：$m_{\\text{face}} = h \\cdot b \\cdot n_{\\text{face}} = 2 \\times 80 \\times 128^2 = 2,621,440$ 字节。\n- 给定参数：$\\alpha = 2.5 \\times 10^{-6}$ s, $B = 25 \\times 10^9$ 字节/秒, $c_{\\text{red}} = 3$, $r = 64$ 字节。\n- $N = 512$，所以 $\\log_{2}(N) = \\log_{2}(512) = 9$。\n\n现在我们计算 $N=512$ 时的通信时间分量：\n- 光环交换时间：\n$$T_{\\text{halo}}(512) = 6 \\left( \\alpha + \\frac{m_{\\text{face}}}{B} \\right) = 6 \\left( 2.5 \\times 10^{-6} + \\frac{2,621,440}{25 \\times 10^9} \\right) \\text{ s}$$\n$$T_{\\text{halo}}(512) = 6 \\left( 2.5 \\times 10^{-6} + 1.048576 \\times 10^{-4} \\right) \\text{ s} = 6 (1.073576 \\times 10^{-4}) \\text{ s} = 6.441456 \\times 10^{-4} \\text{ s}$$\n- 全局归约时间：\n$$T_{\\text{red}}(512) = c_{\\text{red}} \\left( \\alpha + \\frac{r}{B} \\right) \\log_{2}(512) = 3 \\left( 2.5 \\times 10^{-6} + \\frac{64}{25 \\times 10^9} \\right) \\times 9 \\text{ s}$$\n$$T_{\\text{red}}(512) = 27 \\left( 2.5 \\times 10^{-6} + 2.56 \\times 10^{-9} \\right) \\text{ s} = 27 (2.50256 \\times 10^{-6}) \\text{ s} = 6.756912 \\times 10^{-5} \\text{ s}$$\n\n$N=512$ 个进程的总时间是所有分量的总和：\n$$T(512) = T_{\\text{comp}} + T_{\\text{halo}}(512) + T_{\\text{red}}(512)$$\n$$T(512) = (4.194304 \\times 10^{-3} + 6.441456 \\times 10^{-4} + 6.756912 \\times 10^{-5}) \\text{ s}$$\n$$T(512) = (0.004194304 + 0.0006441456 + 0.00006756912) \\text{ s} = 0.00490601872 \\text{ s}$$\n\n最后，弱扩展效率为：\n$$\\epsilon_W(512) = \\frac{T(1)}{T(512)} = \\frac{4.194304 \\times 10^{-3}}{0.00490601872} \\approx 0.8549285$$\n四舍五入到四位有效数字，效率为 $0.8549$。\n\n**对物理分辨率和通信模型适用性的解释：**\n\n问题要求解释基准测试定义如何保持与物理相关的分辨率，并论证所选通信模型的合理性。\n\n1.  **保持与物理相关的分辨率：**\n    -   **回旋动理学 (GK):** 回旋动理学模拟研究聚变等离子体中的微观不稳定性和湍流，其特征尺度长度是离子拉莫尔半径 $\\rho_i$。其物理过程由垂直波数 $k_{\\perp}$ 满足 $k_{\\perp}\\rho_i \\approx 1$ 的相互作用所主导。基准测试要求解析 $k_{\\perp} \\rho_i \\in [0.1, 1.0]$ 的范围，这确保了模拟的网格间距 $\\Delta x$ 足够小，能够捕捉驱动湍流的不稳定模式。在弱扩展中，每个进程的单元数 ($M$) 是固定的。这意味着每个进程的网格间距 $\\Delta x$ 也是固定的。随着总进程数 $N$ 的增加，模拟的总物理体积会增长（$L_{total} \\propto N^{1/3}$），但对重要的物理小尺度（$\\rho_i$ 量级）的分辨率在各处都得以保持。每个单元固定的粒子数也至关重要，因为它使PIC方法固有的统计噪声相对于物理信号保持在一个恒定且可控的水平。\n    -   **磁流体动力学 (MHD):** MHD模拟通常关注更大尺度的现象和湍流。在MHD湍流中，能量从大尺度级联到小尺度，并在小尺度上被电阻率 $\\eta$ 耗散。条件 $k_{\\max} \\eta \\gtrsim 1$ 确保了模拟的最大解析波数 $k_{\\max} \\sim \\pi/\\Delta x$ 足以捕捉耗散尺度上的物理过程。与GK情况一样，弱扩展设置固定了每个进程的网格点数，从而固定了 $\\Delta x$ 和 $k_{\\max}$。随着 $N$ 的增加，模拟在更大的空间中解析着同样精细的尺度。这使得惯性区（能量注入和耗散之间的尺度范围）更大，这对于研究完全发展的湍流的性质至关重要。\n\n2.  **通信模型的合理性论证：**\n    -   **近邻通信 (Hockney 模型):** 使用网格上的区域分解的科学代码，如所述的GK和MHD代码，必须在相邻子域之间交换边界信息。这被称为光环或鬼单元交换。此过程是经典的近邻通信模式。Hockney 延迟-带宽模型 $T_{\\text{msg}} = \\alpha + m/B$ 是一个基本的点对点消息传递性能模型，它捕捉了两个主要的成本：固定的启动成本（延迟 $\\alpha$）和与消息大小成正比的数据传输成本（带宽 $B$）。它是一个适合跨代码比较的模型，因为它代表了底层硬件和网络的基本性能特征，而又不过于复杂。在三维弱扩展中，每个进程的计算体积是固定的，这意味着用于光环交换的表面积也是固定的。该模型正确地反映出，随着 $N$ 的增加，消息大小 $m_{\\text{face}}$ 以及每个进程的光环交换成本（不包括此处未建模的可能由网络争用引起的对数项）基本保持不变。\n    -   **全局归约 (对数模型):** GK和MHD模拟都需要定期的全局操作来进行诊断（例如，计算总能量等守恒量）或保证数值稳定性（例如，寻找全局最大值以确定时间步长）。这些操作通过`MPI_Allreduce`等集体操作实现。在大多数超级计算机互连上，高效并行归约算法的成本与 $\\log(N)$ 成正比。模型 $T_{\\text{red}} \\propto \\log_2(N)$ 正确地捕捉了这种扩展行为。它包括一个与归约树中的通信步数（$\\log_2(N)$）成比例的延迟项，以及一个用于在各个阶段传输数据负载的带宽项。这使其成为一个现实且合适的模型，用于描述即使在弱扩展背景下，随着机器规模 $N$ 的增加而不可避免增长的全局通信开销。",
            "answer": "$$\\boxed{0.8549}$$"
        }
    ]
}