{
    "hands_on_practices": [
        {
            "introduction": "Moving from a local to a global perspective is a crucial step in understanding plasma turbulence. While local, or flux-tube, models are powerful for studying instabilities on a single magnetic flux surface, they neglect the radial variation of plasma parameters. This exercise demonstrates how global magnetic shear, $\\hat{s}(r)$, fundamentally alters the local picture of an instability by introducing a radially varying damping mechanism, modifying both the growth rate and the spatial structure of the turbulent mode. By implementing a simplified computational model, you will directly quantify how the peak of the instability shifts and how the radial width of the mode envelope changes in response to different magnetic shear profiles, providing a foundational understanding of how global geometry shapes microturbulence .",
            "id": "3985680",
            "problem": "You are given a simplified, yet physically consistent, computational model to quantify how global magnetic shear affects microturbulence growth and the radial mode structure in a toroidal plasma. Let the minor radius be normalized as $r \\in [0,1]$. The safety factor profile $q(r)$ defines the local magnetic shear as\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr}.\n$$\nConsider a dimensionless local linear growth rate driven by an Ion Temperature Gradient (ITG) mechanism, modeled as a Gaussian profile,\n$$\n\\gamma_{0}(r) = \\Gamma \\exp\\left(-\\frac{(r - r_{p})^{2}}{2 w_{p}^{2}}\\right),\n$$\nwhere $\\Gamma$, $r_{p}$, and $w_{p}$ are positive constants. Include a perpendicular wavenumber penalty with coefficient $\\nu$ and poloidal wavenumber $k_{y}$, so that the baseline local model (without global shear effects) is\n$$\n\\gamma_{\\mathrm{b}}(r) = \\gamma_{0}(r) - \\nu k_{y}^{2}.\n$$\nTo incorporate global magnetic shear effects, model the radial wavenumber as\n$$\nk_{x}(r) = k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}},\n$$\nwith $\\theta_{\\mathrm{rms}}$ the root-mean-square poloidal angle spread in radians. The global growth rate becomes\n$$\n\\gamma_{\\mathrm{g}}(r) = \\gamma_{0}(r) - \\nu \\left( k_{y}^{2} + \\left(k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}} \\right)^{2} \\right).\n$$\nDefine the peak locations $r_{\\mathrm{b}}$ and $r_{\\mathrm{g}}$ as the radii where $\\gamma_{\\mathrm{b}}(r)$ and $\\gamma_{\\mathrm{g}}(r)$ attain their maximum values, respectively, and the peak shift\n$$\n\\Delta r = r_{\\mathrm{g}} - r_{\\mathrm{b}}.\n$$\nAssuming a one-dimensional diffusion-growth balance for the slowly varying radial envelope $A(r)$,\n$$\nD_{r} \\frac{d^{2} A}{dr^{2}} + \\gamma(r) A = \\lambda A,\n$$\nwhere $D_{r}$ is a positive radial diffusion coefficient and $\\lambda$ is an eigenvalue, show that near the peak radius $r_{0}$ where $\\gamma(r)$ is maximal, the envelope width scales as\n$$\nw \\approx \\sqrt{\\frac{D_{r}}{\\kappa}}, \\quad \\text{with} \\quad \\kappa = -\\left.\\frac{d^{2}\\gamma}{dr^{2}}\\right|_{r=r_{0}}.\n$$\nIn this problem, you will compute $\\hat{s}(r)$, evaluate $\\Delta r$, and quantify the change in radial mode structures via the widths $w_{\\mathrm{b}}$ and $w_{\\mathrm{g}}$ of the baseline and global cases, respectively.\n\nAlgorithmic requirements:\n- Use a uniform grid with $N$ points over $r \\in [0,1]$, where $N = 4001$. Employ central differences to approximate $\\frac{dq}{dr}$ and the second derivative of $\\gamma(r)$ at the peak.\n- Find $r_{\\mathrm{b}}$ and $r_{\\mathrm{g}}$ as the grid points where $\\gamma_{\\mathrm{b}}(r)$ and $\\gamma_{\\mathrm{g}}(r)$ attain their maximal values.\n- Compute $\\kappa_{\\mathrm{b}} = -\\gamma_{\\mathrm{b}}''(r_{\\mathrm{b}})$ and $\\kappa_{\\mathrm{g}} = -\\gamma_{\\mathrm{g}}''(r_{\\mathrm{g}})$ via second-order central finite differences with grid spacing $h$; if the peak occurs at the boundary, treat it as a numerical edge case by reporting widths as $0.0$.\n- Compute $w_{\\mathrm{b}} = \\sqrt{D_{r}/\\kappa_{\\mathrm{b}}}$ and $w_{\\mathrm{g}} = \\sqrt{D_{r}/\\kappa_{\\mathrm{g}}}$; if $\\kappa \\le 0$ due to numerical noise, set the corresponding width to $0.0$.\n\nAll quantities are dimensionless; angles are in radians.\n\nTest suite:\nFor each test case below, $q(r)$ is a quadratic profile $q(r) = q_{0} + \\alpha r + \\beta r^{2}$. Use the same microturbulence model parameters across all cases.\n\n- Shared microturbulence parameters:\n  - $k_{y} = 0.30$\n  - $\\theta_{\\mathrm{rms}} = 0.70$\n  - $\\Gamma = 0.50$\n  - $r_{p} = 0.55$\n  - $w_{p} = 0.12$\n  - $\\nu = 0.80$\n  - $D_{r} = 0.0020$\n\n- Case $1$ (monotonic increasing $q(r)$ with moderate-to-strong shear):\n  - $q_{0} = 1.0$, $\\alpha = 1.2$, $\\beta = 0.8$\n\n- Case $2$ (weak shear, nearly flat $q(r)$):\n  - $q_{0} = 2.0$, $\\alpha = 0.05$, $\\beta = 0.0$\n\n- Case $3$ (reversed shear in the core, $dq/dr$ negative at small $r$ but positive at larger $r$):\n  - $q_{0} = 1.3$, $\\alpha = -0.8$, $\\beta = 1.2$\n\nYour program must:\n- Compute $\\hat{s}(r)$, $\\gamma_{\\mathrm{b}}(r)$, and $\\gamma_{\\mathrm{g}}(r)$ on the grid.\n- Determine $r_{\\mathrm{b}}$, $r_{\\mathrm{g}}$, and $\\Delta r$.\n- Compute $w_{\\mathrm{b}}$ and $w_{\\mathrm{g}}$ using the curvature-based formula.\n- For each test case, produce a result list containing exactly three floats in the order $[\\Delta r, w_{\\mathrm{b}}, w_{\\mathrm{g}}]$.\n\nFinal output format:\nYour program should produce a single line of output containing the results for all test cases as a comma-separated list of lists enclosed in square brackets, for example $[[x_{1},y_{1},z_{1}],[x_{2},y_{2},z_{2}],[x_{3},y_{3},z_{3}]]$, where each $x_{i}$, $y_{i}$, and $z_{i}$ are floats computed as specified.",
            "solution": "The problem statement has been critically validated and is deemed to be self-contained, scientifically sound, and well-posed. All provided equations, parameters, and definitions are consistent with established, albeit simplified, models used in computational plasma physics for studying the effects of magnetic confinement geometry on micro-instabilities. The computational task is clearly specified, including numerical methods and handling of edge cases, ensuring a unique and verifiable solution can be obtained.\n\nThe solution proceeds by implementing the specified model and numerical algorithms. We first establish a discrete radial grid and then, for each test case, compute the physical quantities of interest in a stepwise manner.\n\nFirst, a uniform radial grid for the normalized minor radius $r \\in [0,1]$ is defined with $N=4001$ points. The grid spacing is $h = 1/(N-1)$. All functions will be evaluated on this discrete grid.\n\nFor each test case, defined by the parameters $\\{q_0, \\alpha, \\beta\\}$, we perform the following calculations:\n\n1.  **Safety Factor and Magnetic Shear**: The quadratic safety factor profile $q(r) = q_{0} + \\alpha r + \\beta r^{2}$ is computed on the radial grid $r$. Its derivative, $\\frac{dq}{dr}$, is approximated using a second-order accurate numerical scheme. The `numpy.gradient` function is suitable, as it employs central differences for interior points and second-order one-sided differences at the boundaries, respecting the problem's requirement. The magnetic shear, $\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr}$, is then calculated. At $r=0$, the expression is evaluated in the limit, yielding $\\hat{s}(0) = 0$.\n\n2.  **Growth Rate Profiles**: The local ITG growth rate, $\\gamma_{0}(r) = \\Gamma \\exp\\left(-\\frac{(r - r_{p})^{2}}{2 w_{p}^{2}}\\right)$, is computed. This profile represents the driving term for the instability. Subsequently, the baseline growth rate, $\\gamma_{\\mathrm{b}}(r) = \\gamma_{0}(r) - \\nu k_{y}^{2}$, and the global growth rate, $\\gamma_{\\mathrm{g}}(r) = \\gamma_{0}(r) - \\nu \\left( k_{y}^{2} + \\left(k_{y} \\, \\hat{s}(r) \\, \\theta_{\\mathrm{rms}} \\right)^{2} \\right)$, are determined. The term proportional to $\\hat{s}(r)^2$ in $\\gamma_{\\mathrm{g}}(r)$ models the stabilizing effect of magnetic shear, which enhances radial wavenumber-related damping.\n\n3.  **Peak Location and Shift**: The locations of the maximum growth rates for the baseline and global models, $r_{\\mathrm{b}}$ and $r_{\\mathrm{g}}$, are found by identifying the grid indices corresponding to the maximum values of $\\gamma_{\\mathrm{b}}(r)$ and $\\gamma_{\\mathrm{g}}(r)$, respectively. The peak shift is then simply $\\Delta r = r_{\\mathrm{g}} - r_{\\mathrm{b}}$. The shear-damping term in $\\gamma_{\\mathrm{g}}(r)$ is generally a non-constant function of $r$, which causes $r_{\\mathrm{g}}$ to differ from $r_{\\mathrm{b}}$.\n\n4.  **Mode Width Calculation**: The radial widths of the eigenmode envelopes, $w_{\\mathrm{b}}$ and $w_{\\mathrm{g}}$, are estimated using the provided formula, $w \\approx \\sqrt{D_{r}/\\kappa}$. The quantity $\\kappa = -\\left.\\frac{d^{2}\\gamma}{dr^{2}}\\right|_{r=r_{0}}$ represents the curvature of the growth rate profile at its peak $r_0$. A larger positive curvature (more \"peaked\" profile) corresponds to a smaller width. We calculate $\\kappa_{\\mathrm{b}}$ and $\\kappa_{\\mathrm{g}}$ at the respective peak locations $r_{\\mathrm{b}}$ and $r_{\\mathrm{g}}$. The second derivative is approximated using the second-order central finite difference formula:\n$$\n\\gamma''(r_{i}) \\approx \\frac{\\gamma(r_{i+1}) - 2\\gamma(r_{i}) + \\gamma(r_{i-1})}{h^2}\n$$\nwhere $r_i$ is the peak location on the grid. In accordance with the problem's specifications, if a peak is found at a boundary point (index $0$ or $N-1$), the second derivative cannot be computed with this formula, and the corresponding width is set to $0.0$. Similarly, if numerical effects lead to a calculated $\\kappa \\le 0$ (which would imply the peak is not a local maximum or is located on a flat top), the width is also set to $0.0$, as the formula would be physically meaningless or yield a non-real result.\n\nThis procedure is systematically applied to the three test cases, each representing a different magnetic shear scenario: moderate-to-strong monotonic shear, weak shear, and reversed shear. The results $[\\Delta r, w_{\\mathrm{b}}, w_{\\mathrm{g}}]$ for each case are collected and formatted into the final output string.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the impact of global magnetic shear on microturbulence growth rates and mode structures\n    for different safety factor profiles in a toroidal plasma.\n    \"\"\"\n\n    # Shared microturbulence parameters\n    ky = 0.30\n    theta_rms = 0.70\n    Gamma = 0.50\n    rp = 0.55\n    wp = 0.12\n    nu = 0.80\n    Dr = 0.0020\n\n    # Numerical grid parameters\n    N = 4001\n    r = np.linspace(0.0, 1.0, N)\n    h = r[1] - r[0]\n\n    # Test cases for q(r) = q0 + alpha*r + beta*r^2\n    test_cases = [\n        # Case 1: Monotonic increasing q(r) with moderate-to-strong shear\n        {'q0': 1.0, 'alpha': 1.2, 'beta': 0.8},\n        # Case 2: Weak shear, nearly flat q(r)\n        {'q0': 2.0, 'alpha': 0.05, 'beta': 0.0},\n        # Case 3: Reversed shear in the core\n        {'q0': 1.3, 'alpha': -0.8, 'beta': 1.2}\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        q0 = case['q0']\n        alpha = case['alpha']\n        beta = case['beta']\n\n        # 1. Compute q-profile and magnetic shear s_hat\n        q = q0 + alpha * r + beta * r**2\n        dq_dr = np.gradient(q, h)\n        \n        # Guard against division by zero in r/q, though q is positive for all cases.\n        # At r=0, s_hat is 0. np.gradient handles r[0]=0 correctly.\n        with np.errstate(divide='ignore', invalid='ignore'):\n            s_hat = (r / q) * dq_dr\n        if q[0] != 0: # Ensure s_hat[0] = 0 as per limit.\n             s_hat[0] = 0.0\n\n\n        # 2. Compute growth rate profiles\n        gamma0 = Gamma * np.exp(-(r - rp)**2 / (2 * wp**2))\n        gamma_b = gamma0 - nu * ky**2\n        shear_damping_term = nu * (ky * s_hat * theta_rms)**2\n        gamma_g = gamma_b - shear_damping_term\n\n        # 3. Find peak locations and peak shift\n        idx_b = np.argmax(gamma_b)\n        r_b = r[idx_b]\n        idx_g = np.argmax(gamma_g)\n        r_g = r[idx_g]\n        delta_r = r_g - r_b\n\n        # 4. Compute mode widths wb and wg\n        \n        # Baseline width wb\n        if idx_b == 0 or idx_b == N - 1:\n            w_b = 0.0\n        else:\n            gamma_b_pp = (gamma_b[idx_b + 1] - 2 * gamma_b[idx_b] + gamma_b[idx_b - 1]) / h**2\n            kappa_b = -gamma_b_pp\n            if kappa_b = 0:\n                w_b = 0.0\n            else:\n                w_b = np.sqrt(Dr / kappa_b)\n        \n        # Global width wg\n        if idx_g == 0 or idx_g == N - 1:\n            w_g = 0.0\n        else:\n            gamma_g_pp = (gamma_g[idx_g + 1] - 2 * gamma_g[idx_g] + gamma_g[idx_g - 1]) / h**2\n            kappa_g = -gamma_g_pp\n            if kappa_g = 0:\n                w_g = 0.0\n            else:\n                w_g = np.sqrt(Dr / kappa_g)\n        \n        all_results.append([delta_r, w_b, w_g])\n\n    # Format the final output string\n    # e.g., [[-0.05,0.1,0.08],[-0.001,0.1,0.099]]\n    outer_parts = []\n    for inner_list in all_results:\n        inner_str = ','.join(map(str, inner_list))\n        outer_parts.append(f'[{inner_str}]')\n    final_output = f\"[{','.join(outer_parts)}]\"\n\n    print(final_output)\n\nsolve()\n\n```"
        },
        {
            "introduction": "One of the most significant consequences of global effects is the formation of transport barriers, which are regions of sharply reduced turbulence and transport that are essential for achieving high-performance fusion plasmas. These barriers are often sustained by strong, radially sheared flows, particularly the electric-cross-magnetic ($E \\times B$) flow. This practice explores the mechanism of shear suppression, where a sufficiently large $E \\times B$ shearing rate, $\\gamma_E$, can tear apart turbulent eddies and quench the underlying instability. You will apply the widely recognized criterion for turbulence suppression, $\\gamma_E > \\gamma_L$, where $\\gamma_L$ is the linear instability growth rate, to identify the locations of transport barriers from first-principle calculations based on given plasma profiles .",
            "id": "3985700",
            "problem": "You are given a set of one-dimensional, radially varying profiles for a tokamak-like device with minor radius $a$ and radius $r \\in [r_{\\min}, a]$. The goal is to compute the E×B shearing rate $\\gamma_E(r)$ from a prescribed radial electric field $E_r(r)$, estimate the local linear Ion Temperature Gradient (ITG) growth rate $\\gamma_L(r)$ from first principles using standard drift-wave scalings, and then identify transport barrier locations where $\\gamma_E(r) > \\gamma_L(r)$. The problem must be solved numerically using finite differences, and the final results must be presented as specified.\n\nFundamental base:\n- The E×B drift velocity magnitude is $v_E(r) = \\frac{|E_r(r)|}{B(r)}$, where $B(r)$ is the magnetic field magnitude.\n- The local E×B angular frequency is $\\omega_E(r) = \\frac{v_E(r)}{r} = \\frac{E_r(r)}{B(r)\\,r}$.\n- The E×B shearing rate is defined as\n$$\n\\gamma_E(r) = \\left| r\\,\\frac{d}{dr}\\left(\\omega_E(r)\\right) \\right| = \\left| r\\,\\frac{d}{dr}\\left( \\frac{E_r(r)}{B(r)\\,r} \\right) \\right|.\n$$\n- The ion diamagnetic drift frequency is\n$$\n\\omega_{\\ast i}(r) = \\frac{k_y(r)\\,T_i(r)}{e\\,B(r)\\,L_n(r)},\n$$\nwhere $e$ is the elementary charge, $T_i(r)$ is the ion temperature, $k_y(r)$ is the binormal wavenumber, and $L_n(r)$ is the density gradient scale length defined by $L_n(r) = -\\frac{n(r)}{dn/dr}$ with $n(r)$ the ion density.\n- The ITG drive strength depends on $\\eta_i(r) = \\frac{L_n(r)}{L_T(r)}$ with $L_T(r) = -\\frac{T_i(r)}{dT_i/dr}$ the ion temperature gradient scale length.\n- A widely used fluid-like scaling for the local linear ITG growth rate is\n$$\n\\gamma_L(r) = \\alpha\\,\\omega_{\\ast i}(r)\\,\\max\\left(0,\\eta_i(r) - \\eta_c\\right)\\,S(r),\n$$\nwhere $\\alpha$ is an order-unity coefficient, $\\eta_c$ is a threshold parameter, and $S(r)$ is a stabilization factor that captures global magnetic shear effects. Use the approximate magnetic shear stabilization\n$$\nS(r) = \\frac{1}{1 + \\hat{s}(r)^2}, \\quad \\hat{s}(r) = \\frac{r}{q(r)}\\frac{dq}{dr},\n$$\nwith safety factor profile $q(r)$ prescribed below.\n\nNumerical requirements:\n- Use central finite differences for interior points and one-sided differences at the boundaries for all radial derivatives. Ensure numerical stability by guarding against division by values too close to zero in $L_n(r)$ and $L_T(r)$.\n- All quantities must be handled in the International System of Units (SI). Specifically, express $r$ in $\\mathrm{m}$, $E_r$ in $\\mathrm{V/m}$, $B$ in $\\mathrm{T}$, $n$ in $\\mathrm{m^{-3}}$, and $T_i$ in joules (with given profiles specified in kiloelectronvolts but converted to joules within your computation). Angles are not directly used; the wavenumber $k_y(r)$ is in $\\mathrm{m^{-1}}$.\n\nDecision rule:\n- A transport barrier is deemed locally present where $\\gamma_E(r) > \\gamma_L(r)$. Identify contiguous radial intervals (connected sets of grid points) satisfying this inequality and report the center radius of each interval.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,result_3]$), where each $result_i$ is a list of the barrier center radii for the corresponding test case, rounded to three decimals in meters, expressed as floats. If no barrier is found in a test case, output an empty list $[]$ for that case.\n\nTest suite:\n- Use a uniform radial grid of $N = 200$ points over $[r_{\\min}, a]$ with $r_{\\min} = 0.05\\,\\mathrm{m}$ and $a = 0.50\\,\\mathrm{m}$.\n\n- Physical constants:\n  - Elementary charge $e = 1.602176634\\times 10^{-19}\\,\\mathrm{C}$.\n  - Deuterium ion mass $m_i = 3.343583719\\times 10^{-27}\\,\\mathrm{kg}$ (not directly required in the primary formulas but provided for completeness).\n\n- Global parameters used in all cases unless otherwise stated: $\\alpha = 0.3$, $\\eta_c = 1.0$, major radius $R_0 = 1.7\\,\\mathrm{m}$ (for context; not directly needed in formulas), and binormal wavenumber defined by $k_y(r) = \\frac{m}{r}$ with integer mode number $m$ specified per case. Let $B(r)$ be treated as the toroidal field magnitude $B_t$ specified per case.\n\n- Safety factor profile:\n$$\nq(r) = q_0 + q_1\\left(\\frac{r}{a}\\right)^2,\n$$\nwith $q_0$ and $q_1$ specified per case.\n\n- Case $1$ (\"edge-peaked $E_r$\"):\n  - $B_t = 2.0\\,\\mathrm{T}$, $m = 40$, $q_0 = 1.0$, $q_1 = 1.5$.\n  - Density: $n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$ with $n_0 = 1.0\\times 10^{20}\\,\\mathrm{m^{-3}}$, $L_{n0} = 0.25\\,\\mathrm{m}$.\n  - Ion temperature (in kiloelectronvolts, converted to joules internally): $T_i(r) = T_0\\left(1 - 0.8\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$, with $T_0 = 2.5\\,\\mathrm{keV}$ and $T_{\\mathrm{edge}} = 0.5\\,\\mathrm{keV}$.\n  - Radial electric field: $E_r(r) = E_0 \\exp\\left(-\\frac{(r - r_p)^2}{2\\sigma^2}\\right)$ with $E_0 = 15000\\,\\mathrm{V/m}$, $r_p = 0.45\\,\\mathrm{m}$, $\\sigma = 0.05\\,\\mathrm{m}$.\n\n- Case $2$ (\"weak $E_r$, strong gradients\"):\n  - $B_t = 2.0\\,\\mathrm{T}$, $m = 60$, $q_0 = 1.2$, $q_1 = 1.0$.\n  - Density: $n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$ with $n_0 = 1.1\\times 10^{20}\\,\\mathrm{m^{-3}}$, $L_{n0} = 0.20\\,\\mathrm{m}$.\n  - Ion temperature (in kiloelectronvolts, converted to joules internally): $T_i(r) = T_0\\left(1 - 0.9\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$, with $T_0 = 3.0\\,\\mathrm{keV}$ and $T_{\\mathrm{edge}} = 0.4\\,\\mathrm{keV}$.\n  - Radial electric field: $E_r(r) = E_0 \\exp\\left(-\\frac{(r - r_p)^2}{2\\sigma^2}\\right)$ with $E_0 = 2000\\,\\mathrm{V/m}$, $r_p = 0.40\\,\\mathrm{m}$, $\\sigma = 0.06\\,\\mathrm{m}$.\n\n- Case $3$ (\"dual-peaked $E_r$\"):\n  - $B_t = 1.8\\,\\mathrm{T}$, $m = 50$, $q_0 = 1.0$, $q_1 = 1.8$.\n  - Density: $n(r) = n_0 \\exp\\left(-\\frac{r}{L_{n0}}\\right)$ with $n_0 = 0.9\\times 10^{20}\\,\\mathrm{m^{-3}}$, $L_{n0} = 0.30\\,\\mathrm{m}$.\n  - Ion temperature (in kiloelectronvolts, converted to joules internally): $T_i(r) = T_0\\left(1 - 0.7\\left(\\frac{r}{a}\\right)^2\\right) + T_{\\mathrm{edge}}$, with $T_0 = 2.2\\,\\mathrm{keV}$ and $T_{\\mathrm{edge}} = 0.6\\,\\mathrm{keV}$.\n  - Radial electric field: a sum of two Gaussians\n$$\nE_r(r) = E_1 \\exp\\left(-\\frac{(r - r_{p1})^2}{2\\sigma_1^2}\\right) + E_2 \\exp\\left(-\\frac{(r - r_{p2})^2}{2\\sigma_2^2}\\right),\n$$\nwith $E_1 = 8000\\,\\mathrm{V/m}$, $r_{p1} = 0.20\\,\\mathrm{m}$, $\\sigma_1 = 0.03\\,\\mathrm{m}$, and $E_2 = 12000\\,\\mathrm{V/m}$, $r_{p2} = 0.42\\,\\mathrm{m}$, $\\sigma_2 = 0.04\\,\\mathrm{m}$.\n\nYour program must:\n- Construct the radial grid and profiles exactly as specified.\n- Compute $\\gamma_E(r)$ and $\\gamma_L(r)$ on the grid.\n- Determine contiguous barrier regions where $\\gamma_E(r) > \\gamma_L(r)$.\n- Output a single line: a list with three entries, each being a list of barrier center radii (in $\\mathrm{m}$), rounded to three decimals, for Cases $1$, $2$, and $3$, respectively. For example, an acceptable output format is $[[0.452],[],[0.205,0.421]]$; however, the exact numeric values depend on your computation.",
            "solution": "The problem is well-posed and scientifically grounded within the field of computational fusion plasma physics. It presents a standard, albeit simplified, model for identifying transport barriers in a tokamak plasma. We are tasked with comparing the turbulence suppression rate, represented by the E×B shearing rate $\\gamma_E$, with the turbulence drive, represented by an estimate of the Ion Temperature Gradient (ITG) mode linear growth rate $\\gamma_L$. A transport barrier is formed when suppression dominates drive, i.e., $\\gamma_E(r)  \\gamma_L(r)$.\n\nThe solution proceeds first by establishing a numerical framework, then calculating the physical quantities of interest on a discrete grid, and finally applying the decision rule to identify the transport barrier locations. All calculations are performed in SI units.\n\n**1. Numerical Framework**\n\nThe continuous radial domain $r \\in [r_{\\min}, a]$, where $r_{\\min} = 0.05\\,\\mathrm{m}$ and $a = 0.50\\,\\mathrm{m}$, is discretized into a uniform grid of $N=200$ points. Let the grid points be $r_j$ for $j = 0, 1, \\dots, N-1$, with a constant spacing $\\Delta r = (a - r_{\\min})/(N-1)$.\n\nThe given analytical profiles for ion density $n(r)$, ion temperature $T_i(r)$, safety factor $q(r)$, and radial electric field $E_r(r)$ are evaluated at each grid point $r_j$. Ion temperatures, provided in kiloelectronvolts ($\\mathrm{keV}$), are converted to joules ($J$) using the conversion $1\\,\\mathrm{keV} = 1000 \\times e$, where $e \\approx 1.602 \\times 10^{-19}\\,\\mathrm{C}$ is the elementary charge.\n\nThe problem requires the numerical calculation of several radial derivatives, such as $dn/dr$, $dT_i/dr$, $dq/dr$, and the derivative of the E×B angular frequency. These are computed using finite difference methods. For interior grid points $j=1, \\dots, N-2$, a second-order central difference scheme is used:\n$$\n\\left(\\frac{df}{dr}\\right)_{r_j} \\approx \\frac{f(r_{j+1}) - f(r_{j-1})}{2\\Delta r}\n$$\nFor the boundary points at $j=0$ and $j=N-1$, one-sided difference schemes (e.g., forward for $j=0$ and backward for $j=N-1$) must be employed to maintain numerical stability and correctness. A standard numerical library function, such as `numpy.gradient`, naturally handles this requirement.\n\n**2. Calculation of the ITG Growth Rate, $\\gamma_L(r)$**\n\nThe local linear ITG growth rate is given by the formula:\n$$\n\\gamma_L(r) = \\alpha\\,\\omega_{\\ast i}(r)\\,\\max\\left(0,\\eta_i(r) - \\eta_c\\right)\\,S(r)\n$$\nThe calculation of $\\gamma_L(r_j)$ at each grid point involves several intermediate steps:\n\n*   **Gradient Scale Lengths**: First, the density gradient scale length $L_n(r)$ and temperature gradient scale length $L_T(r)$ are computed. These require the numerical derivatives of the density and temperature profiles:\n    $$\n    L_n(r_j) = -\\frac{n(r_j)}{(dn/dr)_{r_j}}, \\quad L_T(r_j) = -\\frac{T_i(r_j)}{(dT_i/dr)_{r_j}}\n    $$\n*   **$\\eta_i$ Parameter**: The ratio of these scale lengths defines the ITG instability drive parameter $\\eta_i$:\n    $$\n    \\eta_i(r_j) = \\frac{L_n(r_j)}{L_T(r_j)}\n    $$\n*   **Magnetic Shear and Stabilization**: The magnetic shear $\\hat{s}(r)$ is calculated from the safety factor profile $q(r)$ and its numerical derivative $dq/dr$:\n    $$\n    \\hat{s}(r_j) = \\frac{r_j}{q(r_j)}\\left(\\frac{dq}{dr}\\right)_{r_j}\n    $$\n    This is then used to find the shear stabilization factor $S(r)$:\n    $$\n    S(r_j) = \\frac{1}{1 + \\hat{s}(r_j)^2}\n    $$\n*   **Ion Diamagnetic Frequency**: The ion diamagnetic drift frequency $\\omega_{\\ast i}(r)$ is calculated as:\n    $$\n    \\omega_{\\ast i}(r_j) = \\frac{k_y(r_j)\\,T_i(r_j)}{e\\,B(r_j)\\,L_n(r_j)}\n    $$\n    Here, the magnetic field $B(r_j)$ is the constant toroidal field $B_t$ for the given case, and the binormal wavenumber is $k_y(r_j) = m/r_j$, where $m$ is the mode number for the case.\n*   **Final Assembly**: With all components computed on the grid, $\\gamma_L(r_j)$ is assembled. The parameters $\\alpha=0.3$ and $\\eta_c=1.0$ are used as specified.\n\n**3. Calculation of the E×B Shearing Rate, $\\gamma_E(r)$**\n\nThe E×B shearing rate, which measures the radial shear in the plasma's E×B flow, is defined as:\n$$\n\\gamma_E(r) = \\left| r\\,\\frac{d}{dr}\\left( \\omega_E(r) \\right) \\right|\n$$\nwhere $\\omega_E(r) = E_r(r) / (B(r)r)$ is the E×B angular frequency. The calculation proceeds as follows:\n\n*   **E×B Angular Frequency**: First, the profile of $\\omega_E(r_j)$ is computed on the grid. Here, $B(r)$ is again the constant $B_t$.\n    $$\n    \\omega_E(r_j) = \\frac{E_r(r_j)}{B_t\\,r_j}\n    $$\n*   **Numerical Differentiation**: The radial derivative of the angular frequency, $(d\\omega_E/dr)_{r_j}$, is computed numerically using the same finite difference scheme as before.\n*   **Final Assembly**: The E×B shearing rate is then calculated at each grid point:\n    $$\n    \\gamma_E(r_j) = \\left| r_j \\left(\\frac{d\\omega_E}{dr}\\right)_{r_j} \\right|\n    $$\n\n**4. Identification of Transport Barriers**\n\nA transport barrier is defined as a region where the E×B shearing rate exceeds the ITG growth rate. This condition is checked at each grid point:\n$$\n\\gamma_E(r_j)  \\gamma_L(r_j)\n$$\nThis comparison yields a boolean array indicating the locations of potential barrier formation. To satisfy the problem's requirement, we must identify contiguous radial intervals (connected sets of grid points) where this condition holds.\n\nThe algorithm for this identification is as follows:\n1.  Generate a boolean array representing the condition $\\gamma_E(r_j)  \\gamma_L(r_j)$.\n2.  Identify the starting and ending indices of each contiguous block of `True` values in this array.\n3.  For each identified block, defined by a start index $j_{start}$ and an end index $j_{end}$, the corresponding radial interval is $[r_{j_{start}}, r_{j_{end}}]$.\n4.  The center radius of this interval is computed as $(r_{j_{start}} + r_{j_{end}})/2$.\n5.  All such center radii are collected for each test case and presented as the final result, rounded to three decimal places. If no such regions are found for a given case, an empty list is reported.\n\nBy executing this procedure for each of the three test cases, we can determine the locations of transport barriers based on the provided plasma profiles and physical models.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and identifies transport barrier locations in a tokamak-like device\n    by comparing the E×B shearing rate with the ITG growth rate.\n    \"\"\"\n\n    # Physical constants\n    E_CHARGE = 1.602176634e-19  # Elementary charge in Coulombs\n\n    # Global simulation parameters\n    N_POINTS = 200\n    R_MIN = 0.05  # m\n    A_RADIUS = 0.50  # m\n    ALPHA = 0.3\n    ETA_C = 1.0\n\n    # Radial grid\n    r_grid = np.linspace(R_MIN, A_RADIUS, N_POINTS)\n\n    # Test case definitions\n    test_cases = [\n        {\n            \"name\": \"Case 1: edge-peaked Er\",\n            \"Bt\": 2.0, \"m\": 40, \"q0\": 1.0, \"q1\": 1.5,\n            \"n0\": 1.0e20, \"Ln0\": 0.25,\n            \"T0_kev\": 2.5, \"T_edge_kev\": 0.5, \"Ti_factor\": 0.8,\n            \"E0\": 15000.0, \"rp\": 0.45, \"sigma\": 0.05\n        },\n        {\n            \"name\": \"Case 2: weak Er, strong gradients\",\n            \"Bt\": 2.0, \"m\": 60, \"q0\": 1.2, \"q1\": 1.0,\n            \"n0\": 1.1e20, \"Ln0\": 0.20,\n            \"T0_kev\": 3.0, \"T_edge_kev\": 0.4, \"Ti_factor\": 0.9,\n            \"E0\": 2000.0, \"rp\": 0.40, \"sigma\": 0.06\n        },\n        {\n            \"name\": \"Case 3: dual-peaked Er\",\n            \"Bt\": 1.8, \"m\": 50, \"q0\": 1.0, \"q1\": 1.8,\n            \"n0\": 0.9e20, \"Ln0\": 0.30,\n            \"T0_kev\": 2.2, \"T_edge_kev\": 0.6, \"Ti_factor\": 0.7,\n            \"E1\": 8000.0, \"rp1\": 0.20, \"sigma1\": 0.03,\n            \"E2\": 12000.0, \"rp2\": 0.42, \"sigma2\": 0.04,\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # --- 1. Evaluate profiles on the grid ---\n        \n        # Safety factor q(r)\n        q_profile = case[\"q0\"] + case[\"q1\"] * (r_grid / A_RADIUS)**2\n        \n        # Density n(r)\n        n_profile = case[\"n0\"] * np.exp(-r_grid / case[\"Ln0\"])\n        \n        # Ion Temperature Ti(r) in Joules\n        T0_J = case[\"T0_kev\"] * 1000 * E_CHARGE\n        T_edge_J = case[\"T_edge_kev\"] * 1000 * E_CHARGE\n        Ti_profile_J = T0_J * (1 - case[\"Ti_factor\"] * (r_grid / A_RADIUS)**2) + T_edge_J\n        \n        # Radial Electric Field Er(r)\n        if \"E0\" in case: # Single Gaussian\n            Er_profile = case[\"E0\"] * np.exp(-(r_grid - case[\"rp\"])**2 / (2 * case[\"sigma\"]**2))\n        else: # Dual Gaussian for Case 3\n            gauss1 = case[\"E1\"] * np.exp(-(r_grid - case[\"rp1\"])**2 / (2 * case[\"sigma1\"]**2))\n            gauss2 = case[\"E2\"] * np.exp(-(r_grid - case[\"rp2\"])**2 / (2 * case[\"sigma2\"]**2))\n            Er_profile = gauss1 + gauss2\n            \n        # --- 2. Compute ITG growth rate gamma_L ---\n        \n        # Numerical derivatives using second-order accurate differences\n        dn_dr = np.gradient(n_profile, r_grid)\n        dTi_dr = np.gradient(Ti_profile_J, r_grid)\n        dq_dr = np.gradient(q_profile, r_grid)\n        \n        # Gradient scale lengths. Add a small epsilon to denominator for safety, though not strictly needed here.\n        epsilon = 1e-12\n        Ln_profile = -n_profile / (dn_dr + epsilon)\n        LT_profile = -Ti_profile_J / (dTi_dr + epsilon)\n        \n        # eta_i parameter\n        eta_i_profile = Ln_profile / (LT_profile + epsilon)\n        \n        # Magnetic shear and stabilization factor\n        s_hat_profile = (r_grid / q_profile) * dq_dr\n        S_factor = 1.0 / (1.0 + s_hat_profile**2)\n        \n        # Ion diamagnetic frequency\n        ky_profile = case[\"m\"] / r_grid\n        omega_star_i = (ky_profile * Ti_profile_J) / (E_CHARGE * case[\"Bt\"] * Ln_profile)\n        \n        # ITG growth rate gamma_L\n        itg_drive = np.maximum(0, eta_i_profile - ETA_C)\n        gamma_L = ALPHA * omega_star_i * itg_drive * S_factor\n        \n        # --- 3. Compute ExB shearing rate gamma_E ---\n        \n        # ExB angular frequency\n        omega_E = Er_profile / (case[\"Bt\"] * r_grid)\n        \n        # Derivative of omega_E\n        d_omega_E_dr = np.gradient(omega_E, r_grid)\n        \n        # ExB shearing rate gamma_E\n        gamma_E = np.abs(r_grid * d_omega_E_dr)\n        \n        # --- 4. Identify transport barriers ---\n        \n        is_barrier = gamma_E  gamma_L\n        barrier_centers = []\n        \n        # Find contiguous blocks of 'True'\n        padded_condition = np.concatenate(([False], is_barrier, [False]))\n        diff = np.diff(padded_condition.astype(int))\n        starts = np.where(diff == 1)[0]\n        ends = np.where(diff == -1)[0] - 1\n        \n        if starts.size  0:\n            for start_idx, end_idx in zip(starts, ends):\n                # Check for valid block (start = end)\n                if start_idx = end_idx:\n                    center_radius = (r_grid[start_idx] + r_grid[end_idx]) / 2.0\n                    barrier_centers.append(round(center_radius, 3))\n\n        all_results.append(barrier_centers)\n\n    # --- 5. Format and print final output ---\n    \n    # Manually construct string to match format [[...], [...], ...] without extra spaces\n    result_strings = []\n    for res_list in all_results:\n        if not res_list:\n            result_strings.append(\"[]\")\n        else:\n            # Format numbers to 3 decimal places\n            formatted_numbers = [f\"{num:.3f}\" for num in res_list]\n            result_strings.append(f\"[{','.join(formatted_numbers)}]\")\n    \n    final_output = f\"[{','.join(result_strings)}]\"\n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "Global effects not only modify local instabilities but also give rise to inherently non-local phenomena that are entirely absent in flux-tube models. A prime example is turbulence spreading, where turbulent energy generated in a linearly unstable region of the plasma can propagate into adjacent, linearly stable regions, driving transport where it would otherwise be negligible. This exercise provides a concrete computational model for this phenomenon by representing the global heat flux as a convolution of the local flux-tube prediction with a spatial coupling kernel whose width is determined by plasma parameters. By comparing the resulting global heat flux profile to the local one, you will gain hands-on experience in quantifying the impact of non-local transport, a key process in determining global plasma performance .",
            "id": "3985706",
            "problem": "Consider an axisymmetric tokamak equilibrium with minor radius $a$ and major radius $R$. Let the radial coordinate be $r \\in [0,a]$. The safety factor (magnetic field line pitch) profile is $q(r)$, and the magnetic shear is defined as $\\hat{s}(r) \\equiv \\frac{r}{q(r)} \\frac{dq}{dr}$. The ion temperature profile is $T_i(r)$, and the ion temperature gradient scale length is $L_{T_i}(r) \\equiv -\\left(\\frac{d \\ln T_i}{dr}\\right)^{-1}$. In ion temperature gradient (ITG) driven turbulence, a local (flux-tube) quasilinear estimate of the ion heat diffusivity is given by $\\chi_i(r) \\equiv \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_\\perp(r)^2}$, where $\\gamma_{\\mathrm{lin}}(r)$ is the local linear growth rate and $k_\\perp(r)$ is the local perpendicular wavenumber. A standard parametric form grounded in linear ITG theory assumes $\\gamma_{\\mathrm{lin}}(r) \\equiv \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right)$ and $k_\\perp(r) \\equiv k_{y,0}$ constant in $r$. The local heat flux density is modeled as $Q_{\\mathrm{loc}}(r) \\equiv -\\chi_i(r) \\frac{d T_i}{dr}$ and is taken in normalized units such that density and temperature prefactors are unity, making $Q_{\\mathrm{loc}}(r)$ dimensionless.\n\nGlobal effects arise because eigenmodes have finite radial extent and coherently couple neighboring flux surfaces. To model this effect, define a normalized radial mode intensity kernel\n$$\nI(r_0,r) \\equiv \\frac{\\exp\\left( - \\frac{(r-r_0)^2}{2 w(r_0)^2} \\right)}{\\int_0^a \\exp\\left( - \\frac{(r'-r_0)^2}{2 w(r_0)^2} \\right) \\, dr'},\n$$\nwith a width\n$$\nw(r_0) \\equiv \\frac{w_0}{\\sqrt{|\\hat{s}(r_0)| + s_{\\min}}},\n$$\nwhere $w_0$ is a base width and $s_{\\min}$ is a small regularization constant to avoid divergence at vanishing shear. The global heat flux profile is then\n$$\nQ_{\\mathrm{glob}}(r_0) \\equiv \\int_0^a I(r_0,r)\\, Q_{\\mathrm{loc}}(r)\\, dr,\n$$\nwhere $Q_{\\mathrm{loc}}(r)$ is the flux-tube prediction. The comparison metric to quantify global effects is the domain-normalized root-mean-square (RMS) difference\n$$\n\\epsilon \\equiv \\frac{\\left(\\int_0^a \\left[Q_{\\mathrm{glob}}(r) - Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}}{\\left(\\int_0^a \\left[Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}},\n$$\nwhich is dimensionless.\n\nYour task is to write a complete, runnable program that:\n1. Constructs the radial grid using midpoints to avoid singularities at $r=0$ and $r=a$, with $N$ uniform cells of width $\\Delta r = a/N$, and grid points $r_i = \\left(i+\\frac{1}{2}\\right)\\Delta r$ for $i=0,1,\\dots,N-1$.\n2. For each test case below, computes $Q_{\\mathrm{loc}}(r)$ from $T_i(r)$, $\\gamma_{\\mathrm{lin}}(r)$, and $k_\\perp(r)$, then computes $Q_{\\mathrm{glob}}(r_0)$ by numerically evaluating the integral with the kernel $I(r_0,r)$ via discrete summation, ensuring the kernel is properly normalized for each $r_0$ over the truncated domain $[0,a]$. Finally, evaluates $\\epsilon$ using numerical quadrature via discrete summation consistent with the defined grid.\n3. Produces a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[x_1,x_2,x_3]$), where $x_j$ are the values of $\\epsilon$ for the respective test cases, each rounded to $6$ decimal places. The program must require no input and must use the specified parameters embedded in the code.\n\nUse the following scientifically consistent and self-contained equilibrium and parameterization for all test cases:\n- Safety factor profile: $q(r) = q_0 + q_1 \\left(\\frac{r}{a}\\right)^2$ so that $\\frac{dq}{dr} = \\frac{2 q_1 r}{a^2}$ and $\\hat{s}(r) = \\frac{r}{q(r)} \\frac{2 q_1 r}{a^2}$.\n- Temperature profile: $T_i(r) = T_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2\\right]$, so that $\\frac{dT_i}{dr} = -\\frac{2 T_0 r}{a^2}$ and $\\frac{d \\ln T_i}{dr} = \\frac{1}{T_i}\\frac{dT_i}{dr}$, with $\\frac{R}{L_{T_i}(r)} \\equiv -R \\frac{d \\ln T_i}{dr}$.\n- Perpendicular wavenumber: $k_\\perp(r) \\equiv k_{y,0}$.\n- Linear growth rate: $\\gamma_{\\mathrm{lin}}(r) \\equiv \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right)$.\n- Local heat flux: $Q_{\\mathrm{loc}}(r) \\equiv -\\chi_i(r)\\frac{dT_i}{dr}$ with $\\chi_i(r) \\equiv \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}$.\n\nAll quantities are treated as dimensionless by appropriate normalization, hence the output values must be dimensionless floats.\n\nImplement the following test suite, which probes typical conditions, near-marginal stability, and strong global coupling:\n- Test case $1$ (baseline):\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 3.0$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.08$, $s_{\\min} = 0.05$, $N = 512$.\n- Test case $2$ (near-marginal ITG):\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 4.5$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.08$, $s_{\\min} = 0.05$, $N = 512$.\n- Test case $3$ (broad global mode envelope):\n  - $a = 0.5$, $R = 1.7$, $q_0 = 1.0$, $q_1 = 1.0$, $T_0 = 1.0$, $\\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}} = 3.0$, $\\gamma_0 = 0.2$, $k_{y,0} = 4.0$, $w_0 = 0.25$, $s_{\\min} = 0.05$, $N = 512$.\n\nFinal output format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each floating-point value rounded to $6$ decimal places, for example $[0.123456,0.000001,0.987654]$.",
            "solution": "The problem requires the computation of a metric, $\\epsilon$, which quantifies the deviation of a \"global\" model of turbulent heat flux from a simpler \"local\" model in a tokamak plasma. The solution proceeds by first deriving the expressions for all necessary physical quantities as functions of the minor radius, $r$, then discretizing these quantities on a specified numerical grid, and finally performing the required numerical integrations via discrete summation to calculate the local flux $Q_{\\mathrm{loc}}(r)$, the global flux $Q_{\\mathrm{glob}}(r)$, and the metric $\\epsilon$.\n\nFirst, we establish the numerical grid. The radial domain is $r \\in [0, a]$. We use a uniform grid of $N$ cells, each with width $\\Delta r = a/N$. The grid points are located at the center of each cell:\n$$\nr_i = \\left(i + \\frac{1}{2}\\right) \\Delta r = \\left(i + \\frac{1}{2}\\right) \\frac{a}{N} \\quad \\text{for } i = 0, 1, \\dots, N-1.\n$$\nThis midpoint grid avoids the coordinate singularity at $r=0$ and the boundary at $r=a$ where some profile definitions might become ill-defined.\n\nNext, we evaluate the plasma profiles and their derivatives on this grid.\nThe ion temperature profile is given by $T_i(r) = T_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2\\right]$. Its radial derivative is:\n$$\n\\frac{dT_i}{dr} = \\frac{d}{dr} \\left( T_0 \\left[1 - \\frac{r^2}{a^2}\\right] \\right) = -\\frac{2 T_0 r}{a^2}.\n$$\nThe ion temperature gradient scale length, $L_{T_i}(r)$, is defined via $\\frac{1}{L_{T_i}(r)} \\equiv -\\frac{d \\ln T_i}{dr}$. The logarithmic derivative is:\n$$\n\\frac{d \\ln T_i}{dr} = \\frac{1}{T_i(r)} \\frac{dT_i}{dr} = \\frac{1}{T_0(1 - r^2/a^2)} \\left(-\\frac{2 T_0 r}{a^2}\\right) = -\\frac{2r/a^2}{1 - r^2/a^2} = -\\frac{2r}{a^2 - r^2}.\n$$\nThe key drive term for the turbulence is the normalized inverse scale length, $\\frac{R}{L_{T_i}(r)}$:\n$$\n\\frac{R}{L_{T_i}(r)} = -R \\frac{d \\ln T_i}{dr} = -R \\left(-\\frac{2r}{a^2 - r^2}\\right) = \\frac{2Rr}{a^2 - r^2}.\n$$\nThe safety factor profile is $q(r) = q_0 + q_1 \\left(\\frac{r}{a}\\right)^2$. Its derivative is $\\frac{dq}{dr} = \\frac{2 q_1 r}{a^2}$. The magnetic shear, $\\hat{s}(r)$, is then:\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr} = \\frac{r}{q_0 + q_1 (r/a)^2} \\left(\\frac{2 q_1 r}{a^2}\\right) = \\frac{2 q_1 (r/a)^2}{q_0 + q_1 (r/a)^2}.\n$$\nWith these analytical expressions, we can compute the value of each quantity at every grid point $r_i$.\n\nThe local (flux-tube) model for the ion heat flux density, $Q_{\\mathrm{loc}}(r)$, is constructed as follows. The local linear growth rate of the ITG instability is:\n$$\n\\gamma_{\\mathrm{lin}}(r) = \\gamma_0 \\max\\left(0, \\frac{R}{L_{T_i}(r)} - \\left(\\frac{R}{L_{T_i}}\\right)_{\\mathrm{crit}}\\right).\n$$\nThe quasilinear ion heat diffusivity is $\\chi_i(r) = \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_\\perp(r)^2}$, where the perpendicular wavenumber $k_\\perp(r)$ is given as a constant, $k_{y,0}$. Thus, $\\chi_i(r) = \\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}$. The local heat flux is then:\n$$\nQ_{\\mathrm{loc}}(r) = -\\chi_i(r) \\frac{d T_i}{dr} = -\\left(\\frac{\\gamma_{\\mathrm{lin}}(r)}{k_{y,0}^2}\\right) \\left(-\\frac{2 T_0 r}{a^2}\\right) = \\frac{2 T_0 r}{a^2 k_{y,0}^2} \\gamma_{\\mathrm{lin}}(r).\n$$\nThis expression allows for the direct computation of the vector of local heat flux values, $Q_{\\mathrm{loc},i} = Q_{\\mathrm{loc}}(r_i)$, for all $i=0, \\dots, N-1$.\n\nTo model global effects, the local flux is convolved with a radial mode intensity kernel $I(r_0,r)$ to obtain the global heat flux $Q_{\\mathrm{glob}}(r_0)$. The kernel's width, $w(r_0)$, depends on the local magnetic shear:\n$$\nw(r_0) = \\frac{w_0}{\\sqrt{|\\hat{s}(r_0)| + s_{\\min}}}.\n$$\nThe intensity kernel is a normalized Gaussian:\n$$\nI(r_0,r) = \\frac{\\exp\\left( - \\frac{(r-r_0)^2}{2 w(r_0)^2} \\right)}{C(r_0)}, \\quad \\text{where} \\quad C(r_0) = \\int_0^a \\exp\\left( - \\frac{(r'-r_0)^2}{2 w(r_0)^2} \\right) \\, dr'.\n$$\nThe global heat flux at a location $r_0$ is the integral:\n$$\nQ_{\\mathrm{glob}}(r_0) = \\int_0^a I(r_0,r) Q_{\\mathrm{loc}}(r) dr.\n$$\nWe discretize this calculation. For each grid point $r_{0,i} = r_i$, we compute $Q_{\\mathrm{glob}}(r_i)$. The normalization integral $C(r_i)$ and the convolution integral are approximated by discrete sums over the grid:\n$$\nC(r_i) \\approx \\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w(r_i)^2} \\right) \\Delta r.\n$$\n$$\nQ_{\\mathrm{glob}}(r_i) \\approx \\sum_{j=0}^{N-1} I(r_i,r_j) Q_{\\mathrm{loc}}(r_j) \\Delta r = \\sum_{j=0}^{N-1} \\frac{\\exp\\left( - \\frac{(r_j-r_i)^2}{2 w(r_i)^2} \\right)}{C(r_i)} Q_{\\mathrm{loc}}(r_j) \\Delta r.\n$$\nSubstituting the discrete form of $C(r_i)$, the $\\Delta r$ factor cancels, yielding a weighted average for the global flux at each grid point $r_i$:\n$$\nQ_{\\mathrm{glob}, i} = \\frac{\\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w_i^2} \\right) Q_{\\mathrm{loc},j}}{\\sum_{j=0}^{N-1} \\exp\\left( - \\frac{(r_j-r_i)^2}{2 w_i^2} \\right)},\n$$\nwhere $w_i = w(r_i)$, $Q_{\\mathrm{glob}, i} = Q_{\\mathrm{glob}}(r_i)$, and $Q_{\\mathrm{loc}, j} = Q_{\\mathrm{loc}}(r_j)$. This operation is performed for all $i=0, \\dots, N-1$ to obtain the full profile of $Q_{\\mathrm{glob}}(r)$.\n\nFinally, we compute the domain-normalized RMS difference, $\\epsilon$. The integrals in its definition are also replaced by discrete sums:\n$$\n\\epsilon = \\frac{\\left(\\int_0^a \\left[Q_{\\mathrm{glob}}(r) - Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}}{\\left(\\int_0^a \\left[Q_{\\mathrm{loc}}(r)\\right]^2 dr\\right)^{1/2}} \\approx \\frac{\\left(\\sum_i \\left(Q_{\\mathrm{glob},i} - Q_{\\mathrm{loc},i}\\right)^2 \\Delta r\\right)^{1/2}}{\\left(\\sum_i \\left(Q_{\\mathrm{loc},i}\\right)^2 \\Delta r\\right)^{1/2}}.\n$$\nThe cell width $\\Delta r$ again cancels from the numerator and denominator, leaving the standard formula for the normalized root-mean-square error between the two discrete vectors $Q_{\\mathrm{glob}}$ and $Q_{\\mathrm{loc}}$:\n$$\n\\epsilon \\approx \\sqrt{\\frac{\\sum_{i=0}^{N-1} \\left(Q_{\\mathrm{glob},i} - Q_{\\mathrm{loc},i}\\right)^2}{\\sum_{i=0}^{N-1} \\left(Q_{\\mathrm{loc},i}\\right)^2}}.\n$$\nA check is performed to ensure the denominator is non-zero, which is expected for the given parameters as the ITG drive term $\\frac{R}{L_{T_i}(r)}$ exceeds its critical value over a finite portion of the plasma radius. This procedure is applied to each test case to obtain the required values of $\\epsilon$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_epsilon(params: dict) - float:\n    \"\"\"\n    Computes local and global heat fluxes and the RMS difference metric epsilon.\n    \n    Args:\n        params: A dictionary containing all the necessary physical and numerical parameters.\n    \n    Returns:\n        The calculated dimensionless metric epsilon.\n    \"\"\"\n    # Unpack parameters\n    a = params[\"a\"]\n    R = params[\"R\"]\n    q0 = params[\"q0\"]\n    q1 = params[\"q1\"]\n    T0 = params[\"T0\"]\n    R_LTi_crit = params[\"R/LTi_crit\"]\n    gamma0 = params[\"gamma0\"]\n    ky0 = params[\"ky0\"]\n    w0 = params[\"w0\"]\n    s_min = params[\"s_min\"]\n    N = params[\"N\"]\n\n    # 1. Construct the radial grid\n    dr = a / N\n    r = (np.arange(N) + 0.5) * dr\n\n    # 2. Compute profiles\n    # Avoid division by zero at r=0 by using a small epsilon, though the grid avoids r=0.\n    r_safe = np.maximum(r, 1e-12)\n\n    # Safety factor and magnetic shear\n    r_over_a_sq = (r / a)**2\n    q = q0 + q1 * r_over_a_sq\n    s_hat = (2 * q1 * r_over_a_sq) / (q0 + q1 * r_over_a_sq)\n\n    # Temperature gradient and ITG drive term\n    # T_i(r) = T0 * (1 - (r/a)**2)\n    # dTi/dr = -2 * T0 * r / a**2\n    # R/L_Ti(r) = 2*R*r / (a**2 - r**2)\n    dTi_dr = -2 * T0 * r / a**2\n    # The grid points r are strictly less than a, so a**2 - r**2  0.\n    R_over_LTi = (2 * R * r) / (a**2 - r**2)\n\n    # 3. Compute local heat flux Q_loc\n    gamma_lin = gamma0 * np.maximum(0, R_over_LTi - R_LTi_crit)\n    chi_i = gamma_lin / ky0**2\n    Q_loc = -chi_i * dTi_dr\n    \n    # 4. Compute global heat flux Q_glob\n    # Mode width w(r_0)\n    w = w0 / np.sqrt(np.abs(s_hat) + s_min)\n    \n    Q_glob = np.zeros(N)\n    \n    # Convolution integral via discrete summation\n    for i in range(N):\n        r0_i = r[i]\n        w_i = w[i]\n        \n        # Gaussian kernel centered at r0_i with width w_i\n        kernel = np.exp(-(r - r0_i)**2 / (2 * w_i**2))\n        \n        # Weighted average of Q_loc\n        # This is the discrete equivalent of the convolution integral with a normalized kernel\n        kernel_sum = np.sum(kernel)\n        if kernel_sum  0:\n            Q_glob[i] = np.sum(kernel * Q_loc) / kernel_sum\n        else:\n            Q_glob[i] = 0.0\n\n    # 5. Compute the metric epsilon\n    # The dr factor in the integrals cancels out\n    sum_Q_loc_sq = np.sum(Q_loc**2)\n    \n    if sum_Q_loc_sq == 0:\n        # If there is no local flux, the global flux is also zero, and the difference is zero.\n        # This can happen in a fully stable case.\n        return 0.0\n\n    sum_diff_sq = np.sum((Q_glob - Q_loc)**2)\n    \n    epsilon = np.sqrt(sum_diff_sq / sum_Q_loc_sq)\n    \n    return epsilon\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test case 1 (baseline)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 3.0, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.08,\n            \"s_min\": 0.05, \"N\": 512\n        },\n        # Test case 2 (near-marginal ITG)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 4.5, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.08,\n            \"s_min\": 0.05, \"N\": 512\n        },\n        # Test case 3 (broad global mode envelope)\n        {\n            \"a\": 0.5, \"R\": 1.7, \"q0\": 1.0, \"q1\": 1.0, \"T0\": 1.0,\n            \"R/LTi_crit\": 3.0, \"gamma0\": 0.2, \"ky0\": 4.0, \"w0\": 0.25,\n            \"s_min\": 0.05, \"N\": 512\n        },\n    ]\n\n    results = []\n    for case_params in test_cases:\n        epsilon = calculate_epsilon(case_params)\n        results.append(f\"{epsilon:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}