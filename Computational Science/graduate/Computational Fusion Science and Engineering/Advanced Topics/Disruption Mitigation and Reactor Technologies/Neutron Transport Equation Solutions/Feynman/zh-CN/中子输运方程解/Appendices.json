{
    "hands_on_practices": [
        {
            "introduction": "在深入研究复杂数值解法之前，牢固掌握中子输运理论中的基本物理量至关重要。本练习将从第一性原理出发，回顾角通量、标量通量和宏观截面的定义。通过执行量纲分析并验证中子平衡方程的一致性，您将巩固对这些核心概念的理解，并了解它们如何与功率密度等实际工程参数相关联 。",
            "id": "4020714",
            "problem": "在一个氘氚（DT）聚变包层段的简化模型中，考虑一个无限、均匀、各向同性散射且无裂变、无泄漏的介质中的稳态单能中子场。单能角通量用 $\\psi(\\mathbf{r}, \\boldsymbol{\\Omega})$ 表示，其中 $\\mathbf{r}$ 是位置，$\\boldsymbol{\\Omega}$ 是飞行方向。标量通量为 $\\phi(\\mathbf{r}) \\equiv \\int_{4\\pi} \\psi(\\mathbf{r}, \\boldsymbol{\\Omega}) \\,\\mathrm{d}\\boldsymbol{\\Omega}$。宏观总截面和宏观散射截面分别为 $\\Sigma_{t}$ 和 $\\Sigma_{s}$，吸收截面定义为 $\\Sigma_{a} \\equiv \\Sigma_{t} - \\Sigma_{s}$。存在一个强度为 $Q$（每单位体积每单位时间产生的中子数）的各向同性外部体中子源。所有量均采用国际单位制（SI）表示，立体角的单位为球面度（sr）。使用的能量单位是兆电子伏特（MeV），其中 $1\\,\\mathrm{eV}$ 是电子伏特。\n\n任务：\n1) 从第一性原理和核心定义出发，使用量纲分析确定以下单能量的SI单位：角通量 $\\psi(\\mathbf{r}, \\boldsymbol{\\Omega})$、标量通量 $\\phi(\\mathbf{r})$、宏观总截面和散射截面 $\\Sigma_{t}$ 和 $\\Sigma_{s}$，以及出现在角积分稳态平衡中的体各向同性源 $Q$。通过参考其定义的速率或概率解释，明确证明每个单位的合理性。\n\n2) 从无限、均匀、无泄漏、无裂变的介质中的稳态、角积分中子平衡出发，证明所有项都具有一致的量纲，并用 $\\Sigma_{t}$、$\\Sigma_{s}$、$\\phi$ 和 $Q$ 写出平衡方程。\n\n3) 仅使用第2部分推导出的平衡方程，得到用 $Q$ 和 $\\Sigma_{a}$ 表示的标量通量 $\\phi$ 的表达式。然后用这些量写出吸收反应率密度 $R_{a}$，并通过量纲分析验证其单位。\n\n4) 对于参数集\n- $\\Sigma_{t} = 1.20\\,\\mathrm{m}^{-1}$，\n- $\\Sigma_{s} = 0.95\\,\\mathrm{m}^{-1}$，\n- $Q = 2.50 \\times 10^{18}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$，\n- 每次吸收沉积的能量 $E_{\\mathrm{dep}} = 14.1\\,\\mathrm{MeV}$，\n以及精确的SI转换关系 $1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-19}\\,\\mathrm{J}$，\n计算由 $p = R_{a} \\, E_{\\mathrm{dep}}$ 定义的体积功率密度 $p$。\n\n将 $p$ 的最终数值答案四舍五入到四位有效数字。以 $\\mathrm{W}\\,\\mathrm{m}^{-3}$ 为单位表示最终功率密度。最终答案必须是一个实数值。",
            "solution": "问题陈述已经过分析，并被确定为有效。这是一个中子输运理论领域中的适定问题，基于已建立的物理原理，并为获得唯一解提供了所有必要信息。解题过程将按顺序完成四个指定的任务。\n\n**任务1：量的量纲分析**\n\n指定量的SI单位由其基本定义确定。\n\n1.  **角通量, $\\psi(\\mathbf{r}, \\boldsymbol{\\Omega})$**: 角通量定义为每单位时间、每单位立体角，穿过垂直于运动方向的单位面积的中子数。设 $\\mathrm{d}N$ 为中子数，$\\mathrm{d}A$ 为单位面积，$\\mathrm{d}t$ 为单位时间，$\\mathrm{d}\\boldsymbol{\\Omega}$ 为单位立体角。其关系为 $\\mathrm{d}N = \\psi \\, \\mathrm{d}A \\, \\mathrm{d}t \\, \\mathrm{d}\\boldsymbol{\\Omega}$。因此，$\\psi$ 的单位，记作 $[\\psi]$，为：\n    $$[\\psi] = \\frac{[\\mathrm{d}N]}{[\\mathrm{d}A][\\mathrm{d}t][\\mathrm{d}\\boldsymbol{\\Omega}]} = \\frac{1}{(\\mathrm{m}^{2})(\\mathrm{s})(\\mathrm{sr})} = \\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}$$\n\n2.  **标量通量, $\\phi(\\mathbf{r})$**: 标量通量定义为角通量在所有 $4\\pi$ 球面度的立体角上的积分：$\\phi(\\mathbf{r}) \\equiv \\int_{4\\pi} \\psi(\\mathbf{r}, \\boldsymbol{\\Omega}) \\,\\mathrm{d}\\boldsymbol{\\Omega}$。因此，其单位是角通量的单位乘以立体角的单位：\n    $$[\\phi] = [\\psi] \\times [\\mathrm{d}\\boldsymbol{\\Omega}] = (\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1})(\\mathrm{sr}) = \\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$$\n\n3.  **宏观截面, $\\Sigma_t$ 和 $\\Sigma_s$**: 宏观截面 $\\Sigma$ 表示中子在单位路径长度上发生特定类型相互作用的概率。因此，其量纲是长度的倒数。\n    $$[\\Sigma_t] = [\\Sigma_s] = \\mathrm{m}^{-1}$$\n    这与乘积 $\\Sigma \\phi$ 产生反应率密度（每单位体积每单位时间的反应次数）的事实相符：$[\\Sigma][\\phi] = (\\mathrm{m}^{-1})(\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}) = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$。\n\n4.  **体源, $Q$**: 问题将 $Q$ 定义为每单位体积每单位时间产生的中子数。\n    $$[Q] = \\frac{[\\text{中子}]}{[\\text{体积}][\\text{时间}]} = \\frac{1}{\\mathrm{m}^{3}\\,\\mathrm{s}} = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$$\n\n**任务2：角积分中子平衡**\n\n稳态中子输运方程描述了中子的平衡。对于指定条件（稳态、无限、均匀介质），涉及通量空间梯度（$\\nabla \\psi$）的泄漏项为零。角积分平衡方程将每单位体积的总中子损失率与每单位体积的总中子增益率等同起来。\n\n*   每单位体积的中子损失率是总碰撞率密度：$\\Sigma_t \\phi$。\n*   每单位体积的中子增益率包括两部分：\n    1.  散射进入体积元的中子。对于各向同性散射，其率为 $\\Sigma_s \\phi$。\n    2.  来自外部源的中子，其率为 $Q$。\n\n将损失与增益相等，得到平衡方程：\n$$ \\Sigma_t \\phi = \\Sigma_s \\phi + Q $$\n为验证量纲一致性，我们使用任务1中推导的单位。每一项的单位都是率密度：\n$$ [\\Sigma_t \\phi] = (\\mathrm{m}^{-1})(\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}) = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1} $$\n$$ [\\Sigma_s \\phi] = (\\mathrm{m}^{-1})(\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}) = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1} $$\n$$ [Q] = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1} $$\n所有项都具有一致的单位（$\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$），这证实了平衡方程的有效性。\n\n**任务3：标量通量和吸收率**\n\n标量通量 $\\phi$ 的表达式可以通过重新整理任务2中的平衡方程得到：\n$$ \\Sigma_t \\phi - \\Sigma_s \\phi = Q $$\n$$ (\\Sigma_t - \\Sigma_s) \\phi = Q $$\n使用宏观吸收截面的定义 $\\Sigma_a \\equiv \\Sigma_t - \\Sigma_s$，我们得到：\n$$ \\Sigma_a \\phi = Q $$\n解出标量通量 $\\phi$ 可得：\n$$ \\phi = \\frac{Q}{\\Sigma_a} $$\n吸收反应率密度 $R_a$ 是每单位体积每单位时间的吸收反应次数。它被定义为宏观吸收截面与标量通量的乘积：\n$$ R_a = \\Sigma_a \\phi $$\n通过代入我们平衡方程的结果 $\\Sigma_a \\phi = Q$，我们发现：\n$$ R_a = Q $$\n这个结果在物理上是符合预期的：在一个没有泄漏或内部增殖（裂变）的稳态系统中，中子吸收的速率必须与外部源引入中子的速率完全平衡。$R_a$ 的单位是 $[\\Sigma_a][\\phi] = (\\mathrm{m}^{-1})(\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}) = \\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$，与 $Q$ 的单位相同，证实了一致性。\n\n**任务4：体积功率密度计算**\n\n体积功率密度 $p$ 是吸收率密度 $R_a$ 与每次吸收沉积的能量 $E_{\\mathrm{dep}}$ 的乘积：\n$$ p = R_a E_{\\mathrm{dep}} $$\n根据任务3，我们有 $R_a = Q$，所以：\n$$ p = Q E_{\\mathrm{dep}} $$\n给定的参数是：\n$Q = 2.50 \\times 10^{18}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$\n$E_{\\mathrm{dep}} = 14.1\\,\\mathrm{MeV}$\n$1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-19}\\,\\mathrm{J}$\n\n首先，我们将能量 $E_{\\mathrm{dep}}$ 转换为国际单位制中的焦耳（$\\mathrm{J}$）：\n$$ E_{\\mathrm{dep}} = 14.1\\,\\mathrm{MeV} = 14.1 \\times 10^{6}\\,\\mathrm{eV} $$\n$$ E_{\\mathrm{dep}} = (14.1 \\times 10^{6}\\,\\mathrm{eV}) \\times (1.602176634 \\times 10^{-19}\\,\\mathrm{J}/\\mathrm{eV}) $$\n$$ E_{\\mathrm{dep}} \\approx 2.259069 \\times 10^{-12}\\,\\mathrm{J} $$\n现在我们计算 $p$。$\\Sigma_t$ 和 $\\Sigma_s$ 的值对于此计算是无关的。\n$$ p = (2.50 \\times 10^{18}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}) \\times (14.1 \\times 1.602176634 \\times 10^{-19}\\,\\mathrm{J}) $$\n$$ p = (2.50 \\times 10^{18}) \\times (2.25906905394 \\times 10^{-12}) \\,\\mathrm{J}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1} $$\n$$ p = 5.64767263485 \\times 10^{6} \\,\\mathrm{J}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1} $$\n由于 $1\\,\\mathrm{W} = 1\\,\\mathrm{J}\\,\\mathrm{s}^{-1}$，功率密度的单位是 $\\mathrm{W}\\,\\mathrm{m}^{-3}$。\n$$ p = 5.64767263485 \\times 10^{6} \\,\\mathrm{W}\\,\\mathrm{m}^{-3} $$\n按要求四舍五入到四位有效数字：\n$$ p \\approx 5.648 \\times 10^{6} \\,\\mathrm{W}\\,\\mathrm{m}^{-3} $$\n这是体积功率密度的最终数值。",
            "answer": "$$\\boxed{5.648 \\times 10^{6}}$$"
        },
        {
            "introduction": "准确表示散射过程对于求解中子输运方程至关重要，尤其是在聚变系统中，因为其中的散射可能具有高度的各向异性。本练习专注于实现勒让德展开方法，这是离散纵标法 ($S_N$) 程序中用于处理散射截面和角通量角度依赖性的标准技术。通过编写程序计算勒让德矩并构建散射源，您将在将各向异性散射的理论框架转化为数值输运求解器核心组件方面获得实践经验 。",
            "id": "4020734",
            "problem": "考虑计算聚变科学与工程中的一维平板离散纵标法（$S_N$）中子输运问题，该问题具有方位角对称性。散射是各向异性的，目标是计算方位角对称的微分散射截面的勒让德矩，并构建多群散射源。基本依据包括以下经过充分检验的事实和定义：(i) 勒让德多项式 $P_l(\\mu)$ 在 $[-1,1]$ 上相对于权重函数 $1$ 构成一个完备正交基，任何方位角对称的角度依赖性都可以在此基上展开；(ii) 角通量 $\\psi_g(\\mu)$ 和散射截面 $\\sigma_s^{g' \\to g}(\\mu)$ 允许进行勒让德展开，其系数可通过正交性确定；(iii) $S_N$ 中的多群散射源是通过将角通量投影为矩，然后用散射截面的勒让德矩重新展开，以获得在每个离散方向上的贡献而产生的。\n\n你必须编写一个完整、可运行的程序，该程序能够：\n- 从一个在覆盖 $\\mu \\in [-1,1]$ 的 $N_\\mu$ 个点网格上指定的、表格化的方位角对称微分散射截面 $\\sigma_s^{g' \\to g}(\\mu)$ 数值计算勒让德矩 $\\Sigma_{s,l}^{g' \\to g}$。表格化的 $\\sigma_s^{g' \\to g}(\\mu)$ 单位为 $\\mathrm{cm}^{-1}\\,\\mathrm{sr}^{-1}$。\n- 根据给定的离散纵标方向 $\\mu_m$ 和权重 $w_m$ 以及给定的离散角通量值 $\\psi_{g'}(\\mu_m)$，数值计算角通量矩 $\\phi_l^{g'}$。\n- 使用在 $L_{\\max}$ 阶截断的勒让德展开，为指定的目标群 $g$ 在每个离散方向上构建多群散射源 $S_{s,g}(\\mu_m)$。\n\n报告的所有散射源值 $S_{s,g}(\\mu_m)$ 必须以 $\\mathrm{particles}\\,\\mathrm{cm}^{-3}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}$ 为单位表示（不要打印单位文本；数值必须是这些单位）。\n\n使用与所提供数据一致的方法（可使用梯形法则）在表格化的 $\\mu$ 网格上实现数值积分。对 $S_N$ 的方向和权重使用 Gauss–Legendre 求积组。所有角度均由方向余弦 $\\mu$ 表示，因此是无量纲的；不需要进行角度单位转换。\n\n测试套件与参数化：\n对于每个测试用例，构建表格化的 $\\mu$ 网格，定义散射对及其 $\\sigma_s^{g' \\to g}(\\mu)$ 函数，分配求积方向和权重，指定每个群在求积方向上的角通量值，并选择 $L_{\\max}$。为符合科学真实性，所选振幅应使最终的宏观勒让德矩具有合理的量级。形状仅为 $\\mu$ 的方位角对称函数。\n\n- 测试用例 1（正常路径，中等各向异性，多群）：\n  - $L_{\\max} = 3$。\n  - $N_\\mu = 101$ 个在 $[-1,1]$ 上均匀分布的点。\n  - 使用 $S_4$ Gauss–Legendre 求积：$M = 4$ 个方向 $\\{\\mu_m\\}_{m=1}^M$ 及相应的权重 $\\{w_m\\}_{m=1}^M$。\n  - 能量群数量 $G = 3$，索引为 $g \\in \\{0,1,2\\}$。\n  - 目标群 $g = 1$。\n  - 需构建到目标群中的散射对及其微分截面 $\\sigma_s^{g' \\to g}(\\mu)$（单位 $\\mathrm{cm}^{-1}\\,\\mathrm{sr}^{-1}$）：\n    - 从 $g' = 0$ 到 $g = 1$：$\\sigma_s^{0 \\to 1}(\\mu) = A_1 \\exp(\\beta_1 \\mu)$，其中 $A_1 = 0.02$ 且 $\\beta_1 = 3$。\n    - 从 $g' = 1$ 到 $g = 1$：$\\sigma_s^{1 \\to 1}(\\mu) = A_2 \\left(c_0 + c_1 \\mu + c_2 \\mu^2\\right)$，其中 $A_2 = 0.015$，$c_0 = 1$，$c_1 = 0.3$，$c_2 = 0.2$。\n  - 在求积方向上的角通量（单位 $\\mathrm{particles}\\,\\mathrm{cm}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}$）：\n    - 群 $g' = 0$：$\\psi_0(\\mu_m) = 1.0 + 0.4\\mu_m$。\n    - 群 $g' = 1$：$\\psi_1(\\mu_m) = 0.8 + 0.1\\mu_m$。\n\n- 测试用例 2（边界情况，各向同性散射，单群）：\n  - $L_{\\max} = 2$。\n  - $N_\\mu = 101$ 个在 $[-1,1]$ 上均匀分布的点。\n  - 使用 $S_8$ Gauss–Legendre 求积：$M = 8$ 个方向。\n  - 能量群数量 $G = 1$，索引为 $g = 0$。\n  - 目标群 $g = 0$。\n  - 散射对：\n    - 从 $g' = 0$ 到 $g = 0$：$\\sigma_s^{0 \\to 0}(\\mu) = A_3$，其中 $A_3 = 0.05$（在 $\\mu$ 上为常数）。\n  - 角通量：\n    - 群 $g' = 0$：$\\psi_0(\\mu_m) = 1.2$（常数）。\n\n- 测试用例 3（边界情况，强前向峰各向异性，粗略表格化，零耦合路径）：\n  - $L_{\\max} = 4$。\n  - $N_\\mu = 21$ 个在 $[-1,1]$ 上均匀分布的点。\n  - 使用 $S_4$ Gauss–Legendre 求积：$M = 4$ 个方向。\n  - 能量群数量 $G = 2$，索引为 $g \\in \\{0,1\\}$。\n  - 目标群 $g = 1$。\n  - 散射对：\n    - 从 $g' = 0$ 到 $g = 1$：$\\sigma_s^{0 \\to 1}(\\mu) = A_4 \\exp(\\beta_4 \\mu)$，其中 $A_4 = 0.00004$ 且 $\\beta_4 = 10$。\n    - 从 $g' = 1$ 到 $g = 1$：$\\sigma_s^{1 \\to 1}(\\mu) = 0$（对所有 $\\mu$ 恒为零）。\n  - 角通量：\n    - 群 $g' = 0$：$\\psi_0(\\mu_m) = 1 + \\mu_m$。\n    - 群 $g' = 1$：$\\psi_1(\\mu_m) = 0.3 + 0.7 \\mu_m^2$。\n\n必需的计算步骤：\n- 对于每个指定的散射对 $(g' \\to g)$，从表格化的 $\\sigma_s^{g' \\to g}(\\mu)$ 中数值计算 $l = 0,1,\\dots,L_{\\max}$ 的勒让德矩 $\\Sigma_{s,l}^{g' \\to g}$。\n- 对于每个源群 $g'$，使用 $S_N$ 求积方向和权重以及给定的 $\\psi_{g'}(\\mu_m)$，数值计算 $l = 0,1,\\dots,L_{\\max}$ 的角通量矩 $\\phi_l^{g'}$。\n- 在指定的目标群 $g$ 中，使用在 $L_{\\max}$ 处截断的勒让德矩和通量矩，为每个求积方向 $\\mu_m$ 构建散射源 $S_{s,g}(\\mu_m)$。\n\n最终输出格式：\n你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。顶层列表中的每个元素按顺序对应一个测试用例。每个元素本身必须是一个浮点值列表，给出指定目标群在每个求积方向 $\\mu_m$ 上的 $S_{s,g}(\\mu_m)$，顺序与求积组的顺序一致。例如，输出必须类似于 $[[v_{1,1},v_{1,2},\\dots],[v_{2,1},\\dots],[v_{3,1},\\dots]]$，所有数值的单位均为 $\\mathrm{particles}\\,\\mathrm{cm}^{-3}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}$。",
            "solution": "该问题要求为一维、方位角对称的离散纵标法（$S_N$）中子输运方程构建多群散射源项。这是计算反应堆物理和聚变中子学中的一项基本计算。\n\n稳态、一维平板几何中子输运方程由下式给出：\n$$\n\\mu \\frac{\\partial \\psi_g(z, \\mu)}{\\partial z} + \\Sigma_{t,g}(z) \\psi_g(z, \\mu) = Q_g(z, \\mu)\n$$\n其中 $\\psi_g(z, \\mu)$ 是能量群 $g$ 在空间位置 $z$ 和方向余弦 $\\mu$ 上的中子角通量，$\\Sigma_{t,g}$ 是宏观总截面，而 $Q_g(z, \\mu)$ 是中子总源。对该源的散射贡献 $S_{s,g}(z, \\mu)$ 是本问题的核心。它由对所有源能量群 $g'$ 和所有入射方向 $\\mathbf{\\Omega}'$ 的积分定义：\n$$\nS_{s,g}(z, \\mu) = \\sum_{g'} \\int_{4\\pi} \\Sigma_s^{g' \\to g}(\\mathbf{\\Omega}' \\cdot \\mathbf{\\Omega}) \\psi_{g'}(z, \\mathbf{\\Omega}') d\\mathbf{\\Omega}'\n$$\n这里，$\\Sigma_s^{g' \\to g}(\\mathbf{\\Omega}' \\cdot \\mathbf{\\Omega})$ 是从群 $g'$ 到群 $g$ 的宏观微分散射截面，它依赖于散射角余弦 $\\mu_0 = \\mathbf{\\Omega}' \\cdot \\mathbf{\\Omega}$。问题以 $\\mathrm{cm}^{-1}\\,\\mathrm{sr}^{-1}$ 为单位提供了此函数。\n\n对于具有方位角对称性的问题，角通量和微分散射截面都可以用勒让德多项式 $P_l(\\mu)$ 进行展开。截面的展开式为：\n$$\n\\Sigma_s^{g' \\to g}(\\mu_0) = \\sum_{l=0}^{\\infty} \\frac{2l+1}{4\\pi} \\Sigma_{s,l}^{g' \\to g} P_l(\\mu_0)\n$$\n其中 $\\Sigma_{s,l}^{g' \\to g}$ 是截面的勒让德矩。类似地，角通量展开为：\n$$\n\\psi_{g'}(z, \\mu) = \\sum_{l=0}^{\\infty} \\frac{2l+1}{2} \\phi_l^{g'}(z) P_l(\\mu)\n$$\n其中 $\\phi_l^{g'}(z)$ 是角通量的勒让德矩。\n\n将这些展开式代入散射积分，并在方位角对称性下应用勒让德多项式的加法定理，可得到角散射源的简化表达式：\n$$\nS_{s,g}(z, \\mu) = \\sum_{g'} \\sum_{l=0}^{\\infty} \\frac{2l+1}{2} \\Sigma_{s,l}^{g' \\to g} \\phi_l^{g'}(z) P_l(\\mu)\n$$\n在实践中，这个无穷级数在有限的勒让德阶 $L_{\\max}$ 处被截断。空间依赖性 $z$ 在问题中是隐含的，为清晰起见将省略。计算任务分为三个不同的步骤。\n\n**步骤 1：计算截面勒让德矩 $\\Sigma_{s,l}^{g' \\to g}$**\n宏观微分散射截面的勒让德矩（根据问题的符号表示，我们记作 $\\sigma_s(\\mu_0)$）是通过将该函数投影到勒让德基上获得的：\n$$\n\\Sigma_{s,l}^{g' \\to g} = 2\\pi \\int_{-1}^{1} \\sigma_s^{g' \\to g}(\\mu_0) P_l(\\mu_0) d\\mu_0\n$$\n问题在区间 $\\mu \\in [-1,1]$ 上的一个包含 $N_\\mu$ 个点的均匀网格上以表格形式提供了函数 $\\sigma_s^{g' \\to g}(\\mu)$。该积分使用梯形法则进行数值计算。对于一个在点 $\\{\\mu_i\\}$ 上制表的函数 $f(\\mu)$，其积分近似为：\n$$\n\\int_{-1}^{1} f(\\mu) d\\mu \\approx h \\left( \\frac{f(\\mu_0) + f(\\mu_{N_\\mu-1})}{2} + \\sum_{i=1}^{N_\\mu-2} f(\\mu_i) \\right)\n$$\n其中 $h = 2/(N_\\mu - 1)$ 是均匀步长。对于每个散射对 $(g' \\to g)$ 和从 $0$ 到 $L_{\\max}$ 的每个勒让德阶 $l$，我们将此规则应用于乘积 $\\sigma_s^{g' \\to g}(\\mu) P_l(\\mu)$。\n\n**步骤 2：计算角通量矩 $\\phi_l^{g'}}$**\n角通量的勒让德矩由以下积分定义：\n$$\n\\phi_l^{g'} = \\int_{-1}^{1} \\psi_{g'}(\\mu') P_l(\\mu') d\\mu'\n$$\n在离散纵标法中，此积分被替换为在一组包含 $M$ 个离散方向 $\\{\\mu_m\\}$ 及其相应权重 $\\{w_m\\}$ 的集合上的数值求积和：\n$$\n\\phi_l^{g'} \\approx \\sum_{m=1}^{M} \\psi_{g'}(\\mu_m) P_l(\\mu_m) w_m\n$$\n问题指定使用 Gauss-Legendre 求积组，其中方向 $\\mu_m$ 是勒让德多项式 $P_M(\\mu)$ 的根，权重 $w_m$ 为实现最佳精度而选择。对于每个源群 $g'$ 和从 $0$ 到 $L_{\\max}$ 的每个勒让德阶 $l$，使用给定的角通量值 $\\psi_{g'}(\\mu_m)$ 计算此和。\n\n**步骤 3：构建多群散射源 $S_{s,g}(\\mu_m)$**\n在计算出截面矩 $\\Sigma_{s,l}^{g' \\to g}$ 和通量矩 $\\phi_l^{g'}$ 后，通过对所有源群 $g'$ 的贡献求和，来构建目标群 $g$ 在每个离散方向 $\\mu_m$ 上的散射源。该求和在指定的最大勒让德阶 $L_{\\max}$ 处截断：\n$$\nS_{s,g}(\\mu_m) = \\sum_{g'} \\left( \\sum_{l=0}^{L_{\\max}} \\frac{2l+1}{2} \\Sigma_{s,l}^{g' \\to g} \\phi_l^{g'} P_l(\\mu_m) \\right)\n$$\n此计算针对求积组中的每个离散纵标方向 $\\mu_m$ 执行。最终结果是一个散射源值向量，其量纲与组成项的单位 $(\\mathrm{cm}^{-1}) \\times (\\text{particles } \\mathrm{cm}^{-2}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1})$ 推导出的 $\\mathrm{particles}\\,\\mathrm{cm}^{-3}\\,\\mathrm{s}^{-1}\\,\\mathrm{sr}^{-1}$ 一致。\n\n整体算法包括对问题陈述中定义的每个测试用例顺序执行这三个步骤。这涉及设置数值网格，实现为截面和通量提供的函数形式，并按上文所述执行计算。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import roots_legendre, eval_legendre\n\ndef solve():\n    \"\"\"\n    Main function to solve the neutron transport scattering source problem for all test cases.\n    \"\"\"\n\n    test_cases = [\n        # Test Case 1: happy path, moderate anisotropy, multigroup\n        {\n            \"L_max\": 3,\n            \"N_mu\": 101,\n            \"N_sn\": 4, # S4\n            \"target_g\": 1,\n            \"scattering_pairs\": [\n                {'g_prime': 0, 'g_target': 1, 'sigma_s_func': lambda mu: 0.02 * np.exp(3.0 * mu)},\n                {'g_prime': 1, 'g_target': 1, 'sigma_s_func': lambda mu: 0.015 * (1.0 + 0.3 * mu + 0.2 * mu**2)}\n            ],\n            \"flux_defs\": {\n                0: lambda mu: 1.0 + 0.4 * mu,\n                1: lambda mu: 0.8 + 0.1 * mu\n            }\n        },\n        # Test Case 2: edge case, isotropic scattering, single group\n        {\n            \"L_max\": 2,\n            \"N_mu\": 101,\n            \"N_sn\": 8, # S8\n            \"target_g\": 0,\n            \"scattering_pairs\": [\n                {'g_prime': 0, 'g_target': 0, 'sigma_s_func': lambda mu: 0.05}\n            ],\n            \"flux_defs\": {\n                0: lambda mu: 1.2\n            }\n        },\n        # Test Case 3: edge case, strongly forward-peaked, coarse tabulation, zero-coupling\n        {\n            \"L_max\": 4,\n            \"N_mu\": 21,\n            \"N_sn\": 4, # S4\n            \"target_g\": 1,\n            \"scattering_pairs\": [\n                {'g_prime': 0, 'g_target': 1, 'sigma_s_func': lambda mu: 0.00004 * np.exp(10.0 * mu)},\n                {'g_prime': 1, 'g_target': 1, 'sigma_s_func': lambda mu: 0.0}\n            ],\n            \"flux_defs\": {\n                0: lambda mu: 1.0 + mu,\n                1: lambda mu: 0.3 + 0.7 * mu**2\n            }\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_case(case)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef run_case(case_params):\n    \"\"\"\n    Computes the scattering source for a single test case.\n    \"\"\"\n    L_max = case_params[\"L_max\"]\n    N_mu = case_params[\"N_mu\"]\n    N_sn = case_params[\"N_sn\"]\n    target_g = case_params[\"target_g\"]\n    scattering_pairs = case_params[\"scattering_pairs\"]\n    flux_defs = case_params[\"flux_defs\"]\n\n    # 1. Setup grids and quadrature\n    mu_grid = np.linspace(-1.0, 1.0, N_mu)\n    mu_m, w_m = roots_legendre(N_sn)\n\n    total_source_at_mu_m = np.zeros(N_sn)\n\n    # 2. Get all unique source groups g'\n    source_groups = sorted(list(flux_defs.keys()))\n    \n    # 3. Pre-compute flux moments for all relevant groups\n    all_flux_moments = {} # Cache for {g': [phi_0, phi_1, ..., phi_Lmax]}\n    for g_prime in source_groups:\n        flux_function = flux_defs[g_prime]\n        # Allow vectorized and scalar evaluation of flux function\n        psi_at_mu_m = flux_function(mu_m) if hasattr(mu_m, '__len__') else np.array([flux_function(val) for val in mu_m])\n        \n        flux_moments_g_prime = []\n        for l in range(L_max + 1):\n            P_l_at_mu_m = eval_legendre(l, mu_m)\n            # phi_l = sum(psi * P_l * w)\n            phi_l = np.sum(psi_at_mu_m * P_l_at_mu_m * w_m)\n            flux_moments_g_prime.append(phi_l)\n        all_flux_moments[g_prime] = np.array(flux_moments_g_prime)\n\n    # 4. Iterate through scattering contributions to target_g\n    for pair in scattering_pairs:\n        if pair['g_target'] != target_g:\n            continue\n        \n        g_prime = pair['g_prime']\n        if g_prime not in all_flux_moments:\n            # Scattering from a group with no defined (implicitly zero) flux, so contribution is zero.\n            continue\n        \n        flux_moments = all_flux_moments[g_prime]\n        \n        # 4a. Compute cross-section moments\n        sigma_s_func = pair['sigma_s_func']\n        sigma_s_on_grid = sigma_s_func(mu_grid) if hasattr(mu_grid, '__len__') else np.full_like(mu_grid, sigma_s_func(0))\n\n        xs_moments = []\n        for l in range(L_max + 1):\n            P_l_on_grid = eval_legendre(l, mu_grid)\n            integrand = sigma_s_on_grid * P_l_on_grid\n            integral = np.trapz(integrand, mu_grid)\n            # Sigma_sl = 2*pi * integral(...)\n            Sigma_sl = 2.0 * np.pi * integral\n            xs_moments.append(Sigma_sl)\n        xs_moments = np.array(xs_moments)\n\n        # 4b. Assemble source contribution from this g'\n        source_contribution = np.zeros(N_sn)\n        for k in range(N_sn): # For each discrete direction mu_k\n            mu_k = mu_m[k]\n            s_k = 0.0\n            for l in range(L_max + 1):\n                P_l_at_mu_k = eval_legendre(l, mu_k)\n                s_k += (2.0 * l + 1.0) / 2.0 * xs_moments[l] * flux_moments[l] * P_l_at_mu_k\n            source_contribution[k] = s_k\n            \n        total_source_at_mu_m += source_contribution\n\n    return np.round(total_source_at_mu_m, 10).tolist()\n\nsolve()\n```"
        },
        {
            "introduction": "输运扫描是离散纵标法 ($S_N$) 求解器的核心，体现了信息沿粒子轨迹的传播过程。本练习将指导您实现一个完整的一维 $S_N$ 求解器，其中包含菱形差分空间离散格式和用于处理散射的源迭代方法。您将学习构建一个遵循因果性基本原则（上风格式）的算法，并直面非物理负通量等实际数值挑战，从而深入了解输运程序代码的结构与局限性 。",
            "id": "4020684",
            "problem": "考虑一个无量纲长度为 $L$ 的一维平板，它被离散化为 $N_x$ 个均匀的网格单元，其中 $x \\in [0,L]$。在一维平板几何中，对于角通量 $\\psi(x,\\mu)$（方向余弦为 $\\mu \\in [-1,1]$），其稳态中子输运方程由以下基本守恒定律给出：\n$$\n\\mu \\frac{\\partial \\psi(x,\\mu)}{\\partial x} + \\Sigma_t \\psi(x,\\mu) = q + \\frac{\\Sigma_s}{2}\\,\\phi(x),\n$$\n其中 $\\Sigma_t$ 是无量纲总截面，$\\Sigma_s$ 是无量纲散射截面，$q$ 是无量纲各向同性内部源，$\\phi(x)$ 是标量通量，定义为\n$$\n\\phi(x) = \\int_{-1}^{1} \\psi(x,\\mu)\\, d\\mu.\n$$\n使用离散纵标法（discrete ordinates, $S_N$），并采用高斯求积方向和权重 $\\{\\mu_m, w_m\\}_{m=1}^{N}$ 来近似标量通量中的角度积分。在每个网格单元内使用菱形差分格式对角输运方程进行空间离散化，并构建一个遵循因果性和迎风格式的输运扫描算法：对于每个 $\\mu_m > 0$ 的离散方向，从左到右扫描；对于每个 $\\mu_m  0$ 的方向，从右到左扫描。采用源迭代法处理各向同性散射，并在整个计算过程中使用一致的无量纲单位（不需要物理单位）。\n\n您的程序必须实现：\n- 使用 $N$ 个高斯求积方向的离散纵标近似。\n- 在结构化一维网格上的菱形差分空间离散化。\n- 正确的迎风边界条件：真空边界将入射角通量设置为零；入射边界为进入区域的方向设置一个给定的入射角通量。\n- 用于收敛标量通量 $\\phi(x)$ 的源迭代法。\n- 通过定性指标检查因果性和迎风格式：整个区域内角通量和网格中心通量的非负性，以及在边界驱动的吸收情况下标量通量分布的单调性。\n\n从上述基本守恒定律和 $\\phi(x)$ 的定义出发设计算法，确保数值因果性（信息沿特征线传播）和正确的迎风格式。不要在问题陈述中引入任何快捷公式；所有更新关系都必须基于所述的基本定律推导得出。\n\n测试套件：\n使用以下无量纲参数集来验证解的不同方面。\n\n- 测试 $1$（有散射和内部源，真空边界，一般情况）：\n  - $L = 5.0$, $N_x = 50$, $\\Sigma_t = 1.0$, $\\Sigma_s = 0.9$, $q = 0.2$,\n  - 左边界：真空，右边界：真空，\n  - 求积：$S_4$。\n\n- 测试 $2$（左侧入射束，纯吸收，强调单调性和因果性）：\n  - $L = 2.0$, $N_x = 40$, $\\Sigma_t = 1.0$, $\\Sigma_s = 0.0$, $q = 0.0$,\n  - 左边界：对于 $\\mu > 0$ 的方向，入射角通量幅值为 $1.0$，右边界：真空，\n  - 求积：$S_4$。\n\n- 测试 $3$（有内部源的纯吸收，真空边界，基准检查）：\n  - $L = 1.0$, $N_x = 20$, $\\Sigma_t = 2.0$, $\\Sigma_s = 0.0$, $q = 1.0$,\n  - 左边界：真空，右边界：真空，\n  - 求积：$S_2$。\n\n- 测试 $4$（左侧入射束，高度粗糙且光学厚的纯吸收体，以测试菱形差分的正性）：\n  - $L = 10.0$, $N_x = 10$, $\\Sigma_t = 5.0$, $\\Sigma_s = 0.0$, $q = 0.0$,\n  - 左边界：对于 $\\mu > 0$ 的方向，入射角通量幅值为 $1.0$，右边界：真空，\n  - 求积：$S_4$。\n\n对于每个测试用例，计算：\n- 中心网格单元索引 $\\lfloor N_x/2 \\rfloor$ 处的标量通量，结果为浮点数。\n- 一个布尔值，指示所有计算出的角通量和网格中心通量在整个区域内是否为非负（非负性标志）。\n- 一个布尔值，指示标量通量是否从左到右非递增（单调性标志），用作因果性/迎风格式的指标；这在边界驱动的吸收情况下最具物理意义。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果。每个测试用例的结果必须是包含三个条目 $[\\text{phi\\_center}, \\text{nonnegativity\\_flag}, \\text{monotonicity\\_flag}]$ 的列表。对于所有四个测试，请按上述顺序打印这些列表的列表，例如：\n$$\n[[\\text{t1\\_phi}, \\text{t1\\_nonneg}, \\text{t1\\_mono}], [\\text{t2\\_phi}, \\text{t2\\_nonneg}, \\text{t2\\_mono}], [\\text{t3\\_phi}, \\text{t3\\_nonneg}, \\text{t3\\_mono}], [\\text{t4\\_phi}, \\text{t4\\_nonneg}, \\text{t4\\_mono}]].\n$$\n所有数值结果均为无量纲的浮点数或布尔值。您的程序必须是完全自包含的，并且不需要用户输入。",
            "solution": "用户提供了一个在计算输运理论中定义明确的问题。任务是实现一个一维稳态离散纵标（$S_N$）求解器，采用菱形差分空间离散化和源迭代法。\n\n该问题是有效的，因为它在科学上基于中子输运原理，定义明确，有足够的数据和清晰的目标，并且没有歧义或矛盾。我们将进行完整的推导和求解。\n\n### 1. 离散化输运方程的推导\n\n起点是一维稳态角通量 $\\psi(x,\\mu)$ 输运方程：\n$$\n\\mu \\frac{\\partial \\psi(x,\\mu)}{\\partial x} + \\Sigma_t \\psi(x,\\mu) = q + \\frac{\\Sigma_s}{2}\\,\\phi(x)\n$$\n其中标量通量 $\\phi(x)$ 定义为：\n$$\n\\phi(x) = \\int_{-1}^{1} \\psi(x,\\mu)\\, d\\mu\n$$\n\n#### 1.1. 离散纵标（$S_N$）近似\n\n连续的角度变量 $\\mu$ 被一组 $N$ 个离散方向 $\\{\\mu_m\\}_{m=1}^N$ 及其对应的权重 $\\{w_m\\}_{m=1}^N$ 所取代，这些方向和权重由高斯-勒让德求积法则获得。标量通量的积分通过加权和来近似：\n$$\n\\phi(x) \\approx \\sum_{m=1}^{N} w_m \\psi(x, \\mu_m) = \\sum_{m=1}^{N} w_m \\psi_m(x)\n$$\n这将单个偏微分方程转换为一个包含 $N$ 个耦合常微分方程的系统，每个离散方向 $\\mu_m$ 对应一个方程：\n$$\n\\mu_m \\frac{d \\psi_m(x)}{d x} + \\Sigma_t \\psi_m(x) = Q_m(x)\n$$\n其中 $\\psi_m(x) \\equiv \\psi(x, \\mu_m)$，源项 $Q_m(x)$ 是各向同性的（与 $m$ 无关）：\n$$\nQ_m(x) = Q(x) = q + \\frac{\\Sigma_s}{2} \\phi(x) = q + \\frac{\\Sigma_s}{2} \\sum_{m'=1}^{N} w_{m'} \\psi_{m'}(x)\n$$\n方向之间的耦合通过散射项发生，该项依赖于标量通量 $\\phi(x)$。\n\n#### 1.2. 空间离散化与菱形差分关系\n\n空间域 $x \\in [0, L]$ 被离散化为 $N_x$ 个均匀网格单元。单元 $i$ 覆盖区间 $[x_{i-1/2}, x_{i+1/2}]$，宽度为 $\\Delta x = L/N_x$，中心为 $x_i$。将方向 $m$ 的常微分方程在单元 $i$ 上积分，得到：\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\left( \\mu_m \\frac{d \\psi_m(x)}{d x} + \\Sigma_t \\psi_m(x) \\right) dx = \\int_{x_{i-1/2}}^{x_{i+1/2}} Q(x) dx\n$$\n$$\n\\mu_m [\\psi_m(x_{i+1/2}) - \\psi_m(x_{i-1/2})] + \\Sigma_t \\int_{x_{i-1/2}}^{x_{i+1/2}} \\psi_m(x) dx = \\int_{x_{i-1/2}}^{x_{i+1/2}} Q(x) dx\n$$\n我们引入离散变量：$\\psi_{m, i\\pm 1/2} = \\psi_m(x_{i\\pm 1/2})$ 表示单元边界通量，$\\psi_{m,i}$ 表示单元平均通量。源项 $Q(x)$ 假定在单元内为常数，$Q_i = q + \\frac{1}{2}\\Sigma_s \\phi_i$。平衡方程变为：\n$$\n\\mu_m (\\psi_{m, i+1/2} - \\psi_{m, i-1/2}) + \\Sigma_t \\psi_{m,i} \\Delta x = Q_i \\Delta x\n$$\n菱形差分格式通过假设通量在单元内线性变化来提供一个封闭关系，这意味着单元中心通量是单元边界通量的算术平均值：\n$$\n\\psi_{m,i} = \\frac{\\psi_{m, i+1/2} + \\psi_{m, i-1/2}}{2} \\quad \\text{(菱形关系)}\n$$\n现在，对于每个单元 $i$ 和方向 $m$，我们有了一个由两个代数方程组成的系统。\n\n#### 1.3. 输运扫描算法\n\n求解过程通过沿中子行进方向扫描空间网格来进行，同时遵循因果性。这意味着迎风通量（中子进入单元的边界上的通量）是已知的，我们求解的是单元平均通量和顺风通量。\n\n**情况1：$\\mu_m > 0$（从左到右扫描）**\n入射通量位于左边界 $\\psi_{m,i-1/2}$。我们求解 $\\psi_{m,i}$ 和 $\\psi_{m,i+1/2}$。\n根据菱形关系，我们有 $\\psi_{m, i+1/2} = 2\\psi_{m,i} - \\psi_{m,i-1/2}$。将其代入平衡方程：\n$$\n\\mu_m ((2\\psi_{m,i} - \\psi_{m,i-1/2}) - \\psi_{m,i-1/2}) + \\Sigma_t \\psi_{m,i} \\Delta x = Q_i \\Delta x\n$$\n$$\n(2\\mu_m + \\Sigma_t \\Delta x) \\psi_{m,i} = 2\\mu_m \\psi_{m,i-1/2} + Q_i \\Delta x\n$$\n这给出了单元平均通量的更新公式：\n$$\n\\psi_{m,i} = \\frac{2\\mu_m \\psi_{m,i-1/2} + Q_i \\Delta x}{2\\mu_m + \\Sigma_t \\Delta x}\n$$\n然后通过菱形关系求得流出通量：\n$$\n\\psi_{m,i+1/2} = 2\\psi_{m,i} - \\psi_{m,i-1/2}\n$$\n\n**情况2：$\\mu_m  0$（从右到左扫描）**\n入射通量位于右边界 $\\psi_{m,i+1/2}$。我们求解 $\\psi_{m,i}$ 和 $\\psi_{m,i-1/2}$。\n根据菱形关系，$\\psi_{m, i-1/2} = 2\\psi_{m,i} - \\psi_{m,i+1/2}$。将其代入平衡方程：\n$$\n\\mu_m (\\psi_{m,i+1/2} - (2\\psi_{m,i} - \\psi_{m,i+1/2})) + \\Sigma_t \\psi_{m,i} \\Delta x = Q_i \\Delta x\n$$\n$$\n(2\\mu_m - \\Sigma_t \\Delta x) \\psi_{m,i} = 2\\mu_m \\psi_{m,i+1/2} - Q_i \\Delta x\n$$\n由于 $\\mu_m  0$，我们可以使用 $|\\mu_m| = -\\mu_m$ 重写此式：\n$$\n(-2|\\mu_m| - \\Sigma_t \\Delta x) \\psi_{m,i} = -2|\\mu_m| \\psi_{m,i+1/2} - Q_i \\Delta x\n$$\n$$\n(2|\\mu_m| + \\Sigma_t \\Delta x) \\psi_{m,i} = 2|\\mu_m| \\psi_{m,i+1/2} + Q_i \\Delta x\n$$\n这给出了单元平均通量的更新公式：\n$$\n\\psi_{m,i} = \\frac{2|\\mu_m| \\psi_{m,i+1/2} + Q_i \\Delta x}{2|\\mu_m| + \\Sigma_t \\Delta x} = \\frac{-2\\mu_m \\psi_{m,i+1/2} + Q_i \\Delta x}{-2\\mu_m + \\Sigma_t \\Delta x}\n$$\n然后通过菱形关系求得流出通量：\n$$\n\\psi_{m,i-1/2} = 2\\psi_{m,i} - \\psi_{m,i+1/2}\n$$\n\n### 2. 源迭代方案\n\n源项 $Q_i = q + \\frac{1}{2}\\Sigma_s \\phi_i$ 依赖于标量通量 $\\phi_i$，而标量通量又依赖于所有角通量 $\\psi_{m,i}$。这种相互依赖关系通过源迭代法解决。\n\n设 $k$ 为迭代指数。\n1.  **初始化**：对标量通量进行初始猜测，例如，对所有单元 $i$，令 $\\phi_i^{(0)} = 0$。\n2.  **迭代**：对于 $k=1, 2, \\dots$，直到收敛：\n    a.  **计算源项**：使用上一次迭代的标量通量 $\\phi^{(k-1)}$ 计算总源项：\n        $$ Q_i^{(k)} = q + \\frac{\\Sigma_s}{2} \\phi_i^{(k-1)} $$\n    b.  **输运扫描**：对每个离散方向 $\\mu_m$，使用适当的边界条件和上面推导的更新公式进行全空间扫描，以计算所有单元 $i$ 的角通量 $\\psi_{m,i}^{(k)}$。\n    c.  **更新标量通量**：计算新的标量通量：\n        $$ \\phi_i^{(k)} = \\sum_{m=1}^{N} w_m \\psi_{m,i}^{(k)} $$\n    d.  **检查收敛性**：当连续标量通量迭代值之间的相对差异低于指定的容差 $\\epsilon$ 时，过程终止：\n        $$ \\frac{\\|\\phi^{(k)} - \\phi^{(k-1)}\\|_2}{\\|\\phi^{(k)}\\|_2}  \\epsilon $$\n\n### 3. 边界条件\n\n边界条件应用于区域边界上的入射角通量。\n-   **真空边界**：入射角通量为零。\n    -   在 $x=0$ 处：对所有 $\\mu_m > 0$，有 $\\psi_{m, -1/2} = 0$。\n    -   在 $x=L$ 处：对所有 $\\mu_m  0$，有 $\\psi_{m, N_x-1/2} = 0$。（注意：我的实现使用索引 $0, ..., N_x$，因此右边界位于索引 $N_x$ 处）\n-   **入射边界**：入射角通量具有指定值。\n    -   在 $x=0$ 处：对所有 $\\mu_m > 0$，有 $\\psi_{m, -1/2} = \\text{幅值}$。\n\n### 4. 定性指标\n\n该问题要求检查两个定性指标：\n-   **非负性**：所有计算出的角通量（$\\psi_{m,i}$ 和 $\\psi_{m, i\\pm 1/2}$）必须为非负。众所周知，菱形差分格式对于光学厚单元（$\\Sigma_t \\Delta x \\gg 1$）无法满足此条件，会产生不符合物理的负通量。\n-   **单调性**：对于纯吸收、边界驱动的问题，标量通量 $\\phi(x)$ 应为 $x$ 的非增函数。通过验证对所有 $i$ 是否有 $\\phi_i \\geq \\phi_{i+1}$ 来检查这一点。\n\n接下来的实现将遵循此推导结构。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    # Test Suite:\n    # (L, Nx, sigma_t, sigma_s, q, left_bc_type, left_bc_val, right_bc_type, right_bc_val, N)\n    test_cases = [\n        # Test 1: Scattering with internal source, vacuum boundaries\n        {'L': 5.0, 'Nx': 50, 'sigma_t': 1.0, 'sigma_s': 0.9, 'q': 0.2, \n         'left_bc': ('vacuum', 0.0), 'right_bc': ('vacuum', 0.0), 'N_quad': 4},\n        \n        # Test 2: Left-incident beam, pure absorption\n        {'L': 2.0, 'Nx': 40, 'sigma_t': 1.0, 'sigma_s': 0.0, 'q': 0.0, \n         'left_bc': ('incident', 1.0), 'right_bc': ('vacuum', 0.0), 'N_quad': 4},\n\n        # Test 3: Pure absorption with internal source\n        {'L': 1.0, 'Nx': 20, 'sigma_t': 2.0, 'sigma_s': 0.0, 'q': 1.0, \n         'left_bc': ('vacuum', 0.0), 'right_bc': ('vacuum', 0.0), 'N_quad': 2},\n\n        # Test 4: Coarse, optically thick pure absorber to test diamond-difference\n        {'L': 10.0, 'Nx': 10, 'sigma_t': 5.0, 'sigma_s': 0.0, 'q': 0.0, \n         'left_bc': ('incident', 1.0), 'right_bc': ('vacuum', 0.0), 'N_quad': 4}\n    ]\n\n    results = []\n    for params in test_cases:\n        result = run_transport_solve(**params)\n        results.append(result)\n\n    # Format the final output string manually to avoid spaces and use correct boolean representation\n    output_strings = []\n    for res in results:\n        # res is a list like [phi_val, nonneg_flag, mono_flag]\n        s = f\"[{res[0]},{str(res[1]).lower()},{str(res[2]).lower()}]\"\n        output_strings.append(s)\n    \n    final_string = f\"[{','.join(output_strings)}]\"\n    print(final_string)\n\ndef run_transport_solve(L, Nx, sigma_t, sigma_s, q, left_bc, right_bc, N_quad):\n    \"\"\"\n    Solves the 1D steady-state neutron transport equation for a given set of parameters.\n    \"\"\"\n    # 1. Grid and Quadrature Setup\n    dx = L / Nx\n    mus, weights = np.polynomial.legendre.leggauss(N_quad)\n    \n    # Indices for positive and negative directions\n    pos_mu_indices = np.where(mus > 0)[0]\n    neg_mu_indices = np.where(mus  0)[0]\n\n    # 2. Initialization\n    phi = np.zeros(Nx)\n    psi_center = np.zeros((N_quad, Nx))\n    psi_edge = np.zeros((N_quad, Nx + 1))\n    \n    # Iteration parameters\n    TOLERANCE = 1e-8\n    MAX_ITERATIONS = 2000\n    \n    # 3. Source Iteration Loop\n    for k in range(MAX_ITERATIONS):\n        phi_old = np.copy(phi)\n        \n        # Calculate isotropic scattering source from previous iteration's flux\n        scattering_source = 0.5 * sigma_s * phi_old\n        total_source = q + scattering_source  # Array of size Nx\n\n        # 3a. Transport Sweeps for all discrete ordinates\n        # Positive mu (Left-to-Right Sweep)\n        for m in pos_mu_indices:\n            mu_m = mus[m]\n            \n            # Apply left boundary condition\n            if left_bc[0] == 'vacuum':\n                psi_edge[m, 0] = 0.0\n            elif left_bc[0] == 'incident':\n                psi_edge[m, 0] = left_bc[1]\n            \n            # Sweep through spatial cells\n            for i in range(Nx):\n                psi_incoming = psi_edge[m, i]\n                Q_i = total_source[i]\n                \n                # Diamond-difference update for cell-center flux\n                psi_center[m, i] = (2.0 * mu_m * psi_incoming + Q_i * dx) / (2.0 * mu_m + sigma_t * dx)\n                \n                # Diamond relation for outgoing edge flux\n                psi_edge[m, i + 1] = 2.0 * psi_center[m, i] - psi_incoming\n\n        # Negative mu (Right-to-Left Sweep)\n        for m in neg_mu_indices:\n            mu_m = mus[m]  # This value is negative\n            \n            # Apply right boundary condition\n            if right_bc[0] == 'vacuum':\n                psi_edge[m, Nx] = 0.0\n            elif right_bc[0] == 'incident':\n                psi_edge[m, Nx] = right_bc[1]\n            \n            # Sweep through spatial cells (in reverse)\n            for i in range(Nx - 1, -1, -1):\n                psi_incoming = psi_edge[m, i + 1]\n                Q_i = total_source[i]\n\n                # Diamond-difference update (using -mu_m makes the term positive)\n                psi_center[m, i] = (-2.0 * mu_m * psi_incoming + Q_i * dx) / (-2.0 * mu_m + sigma_t * dx)\n                \n                # Diamond relation for outgoing edge flux\n                psi_edge[m, i] = 2.0 * psi_center[m, i] - psi_incoming\n\n        # 3b. Update Scalar Flux\n        phi = np.dot(weights, psi_center)\n        \n        # 3c. Check for Convergence\n        phi_norm = np.linalg.norm(phi)\n        if phi_norm > 0:\n            error = np.linalg.norm(phi - phi_old) / phi_norm\n        else:\n            error = np.linalg.norm(phi - phi_old) # For pure vacuum problems\n        \n        if error  TOLERANCE:\n            break\n\n    # 4. Post-processing and Metric Calculation\n    center_idx = int(np.floor(Nx / 2))\n    phi_center_val = phi[center_idx]\n    \n    # Check non-negativity for all computed fluxes\n    nonnegativity_flag = bool(np.all(psi_center >= 0.0) and np.all(psi_edge >= 0.0))\n    \n    # Check monotonicity (non-increasing profile) of the scalar flux\n    # np.diff(phi)[i] = phi[i+1] - phi[i]. We need this to be = 0.\n    # Use a small tolerance for floating point comparisons.\n    monotonicity_flag = bool(np.all(np.diff(phi) = 1e-9))\n\n    return [phi_center_val, nonnegativity_flag, monotonicity_flag]\n\nsolve()\n```"
        }
    ]
}