{
    "hands_on_practices": [
        {
            "introduction": "A successful plasma simulation hinges on correctly resolving the underlying physical phenomena. This requires that the numerical grid is fine enough to capture the smallest important spatial scales, and the time step is short enough to follow the fastest relevant dynamics. This practice provides a first-principles guide to verifying the adequacy of a simulation setup, connecting fundamental plasma parameters like the gyroradius $\\rho_i$ and Debye length $\\lambda_{De}$ to the practical choices of grid spacing and time step for both gyrokinetic and Particle-In-Cell (PIC) delta-$f$ models .",
            "id": "3964506",
            "problem": "You are tasked with demonstrating, from first principles, that a specified numerical setup for a distribution function perturbation (delta-f) simulation resolves the relevant physical scales. The goal is to derive resolution requirements from core definitions and well-tested formulas and then, for several given parameter sets, compute whether the setup is adequate. The analysis must be grounded in collisionless kinetic plasma theory and standard sampling constraints.\n\nAll inputs are expressed in the International System of Units (SI). Temperatures are provided in electronvolts and must be converted to joules using $1\\,\\mathrm{eV} = e \\, \\mathrm{J}$, where $e$ is the elementary charge. Time is in seconds, distances in meters, magnetic field in tesla, and number density in $\\mathrm{m^{-3}}$. Angle units are not applicable. Your program must return a boolean per test case indicating adequacy.\n\nBegin from the collisionless Vlasov-Poisson-Maxwell system and the following core definitions:\n\n- Ion thermal speed: $v_{thi} = \\sqrt{\\dfrac{2 k_B T_i}{m_i}}$.\n- Electron thermal speed: $v_{the} = \\sqrt{\\dfrac{2 k_B T_e}{m_e}}$.\n- Ion cyclotron frequency: $\\Omega_{ci} = \\dfrac{|q_i| B}{m_i}$.\n- Electron cyclotron frequency: $\\Omega_{ce} = \\dfrac{|q_e| B}{m_e}$.\n- Electron plasma frequency: $\\omega_{pe} = \\sqrt{\\dfrac{n_e q_e^2}{\\epsilon_0 m_e}}$.\n- Electron Debye length: $\\lambda_{De} = \\sqrt{\\dfrac{\\epsilon_0 k_B T_e}{n_e q_e^2}}$.\n- Ion gyroradius: $\\rho_i = \\dfrac{v_{thi}}{\\Omega_{ci}}$.\n- Density gradient scale length: $L_n = \\left|\\dfrac{d \\ln n}{dr}\\right|^{-1}$; in this problem $L_n$ is an input parameter with units of meters.\n\nFor a uniform grid in each direction with domain length $L_x$ and $L_y$ and grid counts $N_x$ and $N_y$, the grid spacings are $dx = \\dfrac{L_x}{N_x}$ and $dy = \\dfrac{L_y}{N_y}$. To resolve a physical length scale $\\ell$, it is necessary to have a minimum number of grid points per scale, denoted $N_p$, such that $\\dfrac{\\ell}{dx} \\ge N_p$ and $\\dfrac{\\ell}{dy} \\ge N_p$, which is consistent with the Nyquist sampling theorem and the need for accurate representation of gradients.\n\nFor time resolution, let $dt$ be the time step. Adequacy requires $dt$ to be small compared to the inverse of the fastest relevant linear frequency. This is imposed via bounds of the form $dt \\,\\omega \\le \\beta$, where $\\omega$ is a characteristic frequency and $\\beta$ is a small dimensionless constant (e.g., $\\beta = 0.1$).\n\nTwo delta-f model regimes are considered:\n\n- Gyrokinetic delta-f (electrostatic, quasineutral ordering): The relevant spatial scale to resolve is the ion gyroradius $\\rho_i$. Quasineutrality requires $k_\\perp \\lambda_{De} \\ll 1$ for the dynamically relevant perpendicular wavenumbers $k_\\perp$. For modes with $k_\\perp \\sim 1/\\rho_i$, this reduces to $\\dfrac{\\lambda_{De}}{\\rho_i} \\ll 1$. A sufficient ordering check is $\\dfrac{\\lambda_{De}}{\\rho_i} \\le \\epsilon$ for a small input constant $\\epsilon$ (e.g., $\\epsilon = 0.1$). Time resolution requires $dt \\,\\Omega_{ci} \\le \\beta_{GK}$, with $\\beta_{GK}$ an input parameter (e.g., $\\beta_{GK} = 0.1$). The domain must contain the gradient scale, $L_x \\ge L_n$ and $L_y \\ge L_n$.\n\n- Particle-In-Cell delta-f (electrostatic, resolving shielding): The grid must resolve the electron Debye length, i.e., $\\dfrac{\\lambda_{De}}{dx} \\ge N_p$ and $\\dfrac{\\lambda_{De}}{dy} \\ge N_p$, and typically must also resolve $\\rho_i$ to capture finite Larmor radius effects when present, i.e., $\\dfrac{\\rho_i}{dx} \\ge N_p$ and $\\dfrac{\\rho_i}{dy} \\ge N_p$. Time resolution requires both $dt \\,\\omega_{pe} \\le \\beta_{pe}$ and $dt \\,\\Omega_{ce} \\le \\beta_{ce}$, where $\\beta_{pe}$ and $\\beta_{ce}$ are input parameters (e.g., $\\beta_{pe} = \\beta_{ce} = 0.1$). The domain must contain the gradient scale, $L_x \\ge L_n$ and $L_y \\ge L_n$.\n\nAdequacy must be demonstrated by computing the following for each test case:\n\n- Points per ion gyroradius in $x$ and $y$: $\\dfrac{\\rho_i}{dx}$ and $\\dfrac{\\rho_i}{dy}$.\n- Points per Debye length in $x$ and $y$: $\\dfrac{\\lambda_{De}}{dx}$ and $\\dfrac{\\lambda_{De}}{dy}$.\n- Time step products $dt \\,\\Omega_{ci}$, $dt \\,\\omega_{pe}$, and $dt \\,\\Omega_{ce}$.\n\nApply the appropriate criteria depending on the model type. A case is adequate if and only if all criteria for its model type are satisfied.\n\nTest suite (four cases):\n\n- Case $1$ (Gyrokinetic delta-f, adequate):\n  - Model: gyrokinetic.\n  - Magnetic field $B = 3.0\\,\\mathrm{T}$.\n  - Ion temperature $T_i = 1000\\,\\mathrm{eV}$.\n  - Electron temperature $T_e = 1000\\,\\mathrm{eV}$.\n  - Electron density $n_e = 1.0\\times 10^{19}\\,\\mathrm{m^{-3}}$.\n  - Domain $L_x = 0.5\\,\\mathrm{m}$, $L_y = 0.5\\,\\mathrm{m}$.\n  - Grid $N_x = 8192$, $N_y = 8192$.\n  - Gradient scale $L_n = 0.1\\,\\mathrm{m}$.\n  - Time step $dt = 5.0\\times 10^{-10}\\,\\mathrm{s}$.\n  - Points-per-scale requirement $N_p = 20$.\n  - Ordering tolerance $\\epsilon = 0.1$.\n  - Time-step tolerance $\\beta_{GK} = 0.1$.\n\n- Case $2$ (Gyrokinetic delta-f, inadequate due to spatial resolution):\n  - Model: gyrokinetic.\n  - Magnetic field $B = 3.0\\,\\mathrm{T}$.\n  - Ion temperature $T_i = 1000\\,\\mathrm{eV}$.\n  - Electron temperature $T_e = 1000\\,\\mathrm{eV}$.\n  - Electron density $n_e = 1.0\\times 10^{19}\\,\\mathrm{m^{-3}}$.\n  - Domain $L_x = 0.5\\,\\mathrm{m}$, $L_y = 0.5\\,\\mathrm{m}$.\n  - Grid $N_x = 256$, $N_y = 256$.\n  - Gradient scale $L_n = 0.1\\,\\mathrm{m}$.\n  - Time step $dt = 5.0\\times 10^{-10}\\,\\mathrm{s}$.\n  - Points-per-scale requirement $N_p = 10$.\n  - Ordering tolerance $\\epsilon = 0.1$.\n  - Time-step tolerance $\\beta_{GK} = 0.1$.\n\n- Case $3$ (Particle-In-Cell delta-f, adequate):\n  - Model: particle-in-cell.\n  - Magnetic field $B = 0.5\\,\\mathrm{T}$.\n  - Ion temperature $T_i = 1000\\,\\mathrm{eV}$.\n  - Electron temperature $T_e = 1000\\,\\mathrm{eV}$.\n  - Electron density $n_e = 1.0\\times 10^{18}\\,\\mathrm{m^{-3}}$.\n  - Domain $L_x = 0.3\\,\\mathrm{m}$, $L_y = 0.3\\,\\mathrm{m}$.\n  - Grid $N_x = 16384$, $N_y = 16384$.\n  - Gradient scale $L_n = 0.05\\,\\mathrm{m}$.\n  - Time step $dt = 1.0\\times 10^{-12}\\,\\mathrm{s}$.\n  - Points-per-scale requirement $N_p = 10$.\n  - Time-step tolerances $\\beta_{pe} = 0.1$, $\\beta_{ce} = 0.1$.\n\n- Case $4$ (Particle-In-Cell delta-f, inadequate due to time step):\n  - Model: particle-in-cell.\n  - Magnetic field $B = 0.5\\,\\mathrm{T}$.\n  - Ion temperature $T_i = 1000\\,\\mathrm{eV}$.\n  - Electron temperature $T_e = 1000\\,\\mathrm{eV}$.\n  - Electron density $n_e = 1.0\\times 10^{18}\\,\\mathrm{m^{-3}}$.\n  - Domain $L_x = 0.3\\,\\mathrm{m}$, $L_y = 0.3\\,\\mathrm{m}$.\n  - Grid $N_x = 16384$, $N_y = 16384$.\n  - Gradient scale $L_n = 0.05\\,\\mathrm{m}$.\n  - Time step $dt = 1.0\\times 10^{-10}\\,\\mathrm{s}$.\n  - Points-per-scale requirement $N_p = 10$.\n  - Time-step tolerances $\\beta_{pe} = 0.1$, $\\beta_{ce} = 0.1$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,result_3,result_4]$), where each $result_i$ is a boolean indicating adequacy for the corresponding case.",
            "solution": "The problem statement is evaluated as valid, self-contained, and scientifically grounded. It presents a well-posed task of verifying numerical resolution criteria for delta-f plasma simulations based on fundamental principles of kinetic theory and standard computational practices. All required parameters are provided for each test case. A single, standard assumption will be made: the ion species is Deuterium, which is typical for problems in magnetic confinement fusion. The notation for temperature, $T_i$ and $T_e$, given in electronvolts ($eV$), is interpreted as the thermal energy, such that the quantity $k_B T$ in the provided formulas is replaced by $T [\\mathrm{eV}] \\times e$, where $e$ is the elementary charge.\n\nThe solution proceeds by first defining the necessary physical constants and then deriving the required physical scales and frequencies from the provided formulas. Subsequently, the specific resolution criteria for both the gyrokinetic and particle-in-cell models are established. Finally, an algorithm is designed to apply these criteria to each test case to determine its adequacy.\n\nThe following physical constants in SI units will be used for the calculations:\n- Elementary charge, $e = 1.602176634 \\times 10^{-19} \\, \\mathrm{C}$\n- Vacuum permittivity, $\\epsilon_0 = 8.8541878128 \\times 10^{-12} \\, \\mathrm{F/m}$\n- Electron mass, $m_e = 9.1093837015 \\times 10^{-31} \\, \\mathrm{kg}$\n- Deuteron mass (assumed ion species), $m_i = 3.3444947 \\times 10^{-27} \\, \\mathrm{kg}$\n- Ion charge is $|q_i| = e$ and electron charge is $|q_e| = e$.\n\nFirst, we define the computational grid spacing in the $x$ and $y$ directions based on the domain length ($L_x, L_y$) and the number of grid points ($N_x, N_y$):\n$$\ndx = \\frac{L_x}{N_x}\n$$\n$$\ndy = \\frac{L_y}{N_y}\n$$\n\nNext, we calculate the fundamental physical scales and frequencies for a given set of plasma parameters. The temperatures $T_i$ and $T_e$ are converted from electronvolts to joules for use in the formulas,\n$E_i = T_i[\\mathrm{eV}] \\times e$ and $E_e = T_e[\\mathrm{eV}] \\times e$.\n\nThe ion and electron thermal speeds are:\n$$\nv_{thi} = \\sqrt{\\frac{2 E_i}{m_i}} = \\sqrt{\\frac{2 T_i[\\mathrm{eV}] e}{m_i}}\n$$\n$$\nv_{the} = \\sqrt{\\frac{2 E_e}{m_e}} = \\sqrt{\\frac{2 T_e[\\mathrm{eV}] e}{m_e}}\n$$\n\nThe cyclotron (or gyro-) frequencies for ions and electrons in a magnetic field $B$ are:\n$$\n\\Omega_{ci} = \\frac{e B}{m_i}\n$$\n$$\n\\Omega_{ce} = \\frac{e B}{m_e}\n$$\n\nThe electron plasma frequency, which characterizes collective electron oscillations, is:\n$$\n\\omega_{pe} = \\sqrt{\\frac{n_e e^2}{\\epsilon_0 m_e}}\n$$\n\nThe characteristic length scales—electron Debye length $\\lambda_{De}$ and ion gyroradius $\\rho_i$—are:\n$$\n\\lambda_{De} = \\sqrt{\\frac{\\epsilon_0 E_e}{n_e e^2}} = \\sqrt{\\frac{\\epsilon_0 T_e[\\mathrm{eV}]}{n_e e}}\n$$\n$$\n\\rho_i = \\frac{v_{thi}}{\\Omega_{ci}}\n$$\n\nWith these quantities, we can now state the full adequacy criteria for each simulation model.\n\n**Gyrokinetic (GK) Delta-f Model Adequacy Criteria:**\nThe gyrokinetic model is valid under an ordering that assumes slow temporal variations (compared to $\\Omega_{ci}$) and large spatial scales (compared to $\\rho_i$), while also enforcing quasineutrality. The numerical resolution must respect these assumptions.\n1.  **Ordering Condition:** Quasineutrality for modes with perpendicular wavenumber $k_\\perp \\sim 1/\\rho_i$ requires $\\lambda_{De} \\ll \\rho_i$. This is checked as:\n    $$\n    \\frac{\\lambda_{De}}{\\rho_i} \\le \\epsilon\n    $$\n2.  **Domain Size:** The simulation domain must be large enough to contain the equilibrium density gradient scale length, $L_n$:\n    $$\n    L_x \\ge L_n \\quad \\text{and} \\quad L_y \\ge L_n\n    $$\n3.  **Spatial Resolution:** The grid must resolve the ion gyroradius $\\rho_i$, which is the fundamental perpendicular scale length of the model. A minimum number of points, $N_p$, is required to resolve this scale:\n    $$\n    \\frac{\\rho_i}{dx} \\ge N_p \\quad \\text{and} \\quad \\frac{\\rho_i}{dy} \\ge N_p\n    $$\n4.  **Temporal Resolution:** The time step $dt$ must be small enough to resolve the characteristic frequency of the model, which is the ion cyclotron frequency $\\Omega_{ci}$:\n    $$\n    dt \\cdot \\Omega_{ci} \\le \\beta_{GK}\n    $$\nA gyrokinetic simulation setup is deemed adequate if and only if all four conditions are met.\n\n**Particle-In-Cell (PIC) Delta-f Model Adequacy Criteria:**\nThe PIC model resolves electron dynamics and charge separation effects. Therefore, it requires resolving much smaller spatial and temporal scales than the gyrokinetic model.\n1.  **Domain Size:** Similar to the GK model, the simulation domain must be large enough to accommodate the gradient scale driving the system:\n    $$\n    L_x \\ge L_n \\quad \\text{and} \\quad L_y \\ge L_n\n    $$\n2.  **Spatial Resolution:** The grid must resolve the electron Debye length $\\lambda_{De}$ to correctly capture electrostatic shielding. It must also typically resolve the ion gyroradius $\\rho_i$ to capture finite Larmor radius effects. Both must be resolved by at least $N_p$ grid points:\n    $$\n    \\frac{\\lambda_{De}}{dx} \\ge N_p \\quad \\text{and} \\quad \\frac{\\lambda_{De}}{dy} \\ge N_p\n    $$\n    $$\n    \\frac{\\rho_i}{dx} \\ge N_p \\quad \\text{and} \\quad \\frac{\\rho_i}{dy} \\ge N_p\n    $$\n3.  **Temporal Resolution:** The time step $dt$ must be small enough to resolve the fastest frequencies in the system, which are the electron plasma frequency $\\omega_{pe}$ and the electron cyclotron frequency $\\Omega_{ce}$:\n    $$\n    dt \\cdot \\omega_{pe} \\le \\beta_{pe}\n    $$\n    $$\n    dt \\cdot \\Omega_{ce} \\le \\beta_{ce}\n    $$\nA PIC simulation setup is deemed adequate if and only if all three conditions are met.\n\nThe algorithm implemented in the final answer will execute these checks for each case provided in the test suite and return a boolean value indicating overall adequacy.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Validates numerical setups for delta-f plasma simulations based on first principles.\n    The function processes a test suite of simulation parameters and determines\n    for each case whether the resolution criteria for the specified model (gyrokinetic\n    or particle-in-cell) are met.\n    \"\"\"\n\n    # Physical constants in SI units\n    CONSTANTS = {\n        'e': 1.602176634e-19,      # Elementary charge (C)\n        'epsilon_0': 8.8541878128e-12, # Vacuum permittivity (F/m)\n        'm_e': 9.1093837015e-31,      # Electron mass (kg)\n        'm_i': 3.3444947e-27,         # Ion mass (Deuterium) (kg)\n    }\n\n    test_cases = [\n        # Case 1 (Gyrokinetic delta-f, adequate)\n        {\n            \"model\": \"gyrokinetic\", \"B\": 3.0, \"T_i\": 1000.0, \"T_e\": 1000.0,\n            \"n_e\": 1.0e19, \"L_x\": 0.5, \"L_y\": 0.5, \"N_x\": 8192, \"N_y\": 8192,\n            \"L_n\": 0.1, \"dt\": 5.0e-10, \"N_p\": 20, \"epsilon\": 0.1, \"beta_GK\": 0.1\n        },\n        # Case 2 (Gyrokinetic delta-f, inadequate due to spatial resolution)\n        {\n            \"model\": \"gyrokinetic\", \"B\": 3.0, \"T_i\": 1000.0, \"T_e\": 1000.0,\n            \"n_e\": 1.0e19, \"L_x\": 0.5, \"L_y\": 0.5, \"N_x\": 256, \"N_y\": 256,\n            \"L_n\": 0.1, \"dt\": 5.0e-10, \"N_p\": 10, \"epsilon\": 0.1, \"beta_GK\": 0.1\n        },\n        # Case 3 (Particle-In-Cell delta-f, adequate)\n        {\n            \"model\": \"particle-in-cell\", \"B\": 0.5, \"T_i\": 1000.0, \"T_e\": 1000.0,\n            \"n_e\": 1.0e18, \"L_x\": 0.3, \"L_y\": 0.3, \"N_x\": 16384, \"N_y\": 16384,\n            \"L_n\": 0.05, \"dt\": 1.0e-12, \"N_p\": 10, \"beta_pe\": 0.1, \"beta_ce\": 0.1\n        },\n        # Case 4 (Particle-In-Cell delta-f, inadequate due to time step)\n        {\n            \"model\": \"particle-in-cell\", \"B\": 0.5, \"T_i\": 1000.0, \"T_e\": 1000.0,\n            \"n_e\": 1.0e18, \"L_x\": 0.3, \"L_y\": 0.3, \"N_x\": 16384, \"N_y\": 16384,\n            \"L_n\": 0.05, \"dt\": 1.0e-10, \"N_p\": 10, \"beta_pe\": 0.1, \"beta_ce\": 0.1\n        }\n    ]\n\n    results = []\n    for params in test_cases:\n        # Calculate grid spacings\n        dx = params[\"L_x\"] / params[\"N_x\"]\n        dy = params[\"L_y\"] / params[\"N_y\"]\n\n        # Convert temperatures from eV to Joules\n        E_i = params[\"T_i\"] * CONSTANTS['e']\n        E_e = params[\"T_e\"] * CONSTANTS['e']\n\n        # Calculate physical scales and frequencies\n        v_thi = np.sqrt(2 * E_i / CONSTANTS['m_i'])\n        Omega_ci = CONSTANTS['e'] * params[\"B\"] / CONSTANTS['m_i']\n        Omega_ce = CONSTANTS['e'] * params[\"B\"] / CONSTANTS['m_e']\n        omega_pe = np.sqrt(params[\"n_e\"] * CONSTANTS['e']**2 / (CONSTANTS['epsilon_0'] * CONSTANTS['m_e']))\n        rho_i = v_thi / Omega_ci\n        lambda_De = np.sqrt(CONSTANTS['epsilon_0'] * E_e / (params[\"n_e\"] * CONSTANTS['e']**2))\n\n        is_adequate = False\n        if params[\"model\"] == \"gyrokinetic\":\n            # 1. Ordering condition\n            cond1 = (lambda_De / rho_i) = params[\"epsilon\"]\n            # 2. Domain size\n            cond2 = (params[\"L_x\"] >= params[\"L_n\"]) and (params[\"L_y\"] >= params[\"L_n\"])\n            # 3. Spatial resolution\n            cond3_rho_i = (rho_i / dx >= params[\"N_p\"]) and (rho_i / dy >= params[\"N_p\"])\n            # 4. Temporal resolution\n            cond4 = (params[\"dt\"] * Omega_ci) = params[\"beta_GK\"]\n            \n            is_adequate = cond1 and cond2 and cond3_rho_i and cond4\n\n        elif params[\"model\"] == \"particle-in-cell\":\n            # 1. Domain size\n            cond1 = (params[\"L_x\"] >= params[\"L_n\"]) and (params[\"L_y\"] >= params[\"L_n\"])\n            # 2. Spatial resolution\n            cond2_lambda_De = (lambda_De / dx >= params[\"N_p\"]) and (lambda_De / dy >= params[\"N_p\"])\n            cond2_rho_i = (rho_i / dx >= params[\"N_p\"]) and (rho_i / dy >= params[\"N_p\"])\n            # 3. Temporal resolution\n            cond3_pe = (params[\"dt\"] * omega_pe) = params[\"beta_pe\"]\n            cond3_ce = (params[\"dt\"] * Omega_ce) = params[\"beta_ce\"]\n\n            is_adequate = cond1 and cond2_lambda_De and cond2_rho_i and cond3_pe and cond3_ce\n        \n        results.append(is_adequate)\n\n    # Format and print the final results\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Particle-based simulations, including the delta-$f$ method, inherently suffer from statistical noise due to the finite number of markers used to represent the distribution function. This noise can obscure the small physical perturbations, like $\\delta n$, that we aim to study. This exercise delves into the statistical foundations of this issue, guiding you to derive how the number of markers per cell directly impacts the accuracy of the estimated perturbation density for different initialization schemes .",
            "id": "3964422",
            "problem": "In a delta-perturbation particle method (delta-$f$) for computational fusion science and engineering, consider estimating the perturbation number density $\\delta n$ in a single configuration-space cell of volume $V$ using a top-hat deposit. The estimator is defined as $$\\hat{\\delta n} = \\frac{1}{V} \\sum_{i=1}^{N_c} w_i,$$ where $N_c$ is the number of markers in the cell and $w_i$ are the marker weights at the time of interest. Assume the weights $\\{w_i\\}$ are independent and identically distributed with mean $\\mu_w$ and variance $\\sigma_w^2$. Under a quiet start, the positions are stratified deterministically so that $N_c = N$ is fixed per cell; under a random start, markers are placed independently so that $N_c$ is a Poisson random variable with mean $\\bar{N}$, and positions are i.i.d. within the cell. The sign of $\\mu_w$ is irrelevant for the relative error specification.\n\nStarting from the estimator definition, the basic properties of variance for sums of independent random variables, and the variance laws for compound sums with Poisson-distributed counts, derive an expression for the number of markers per cell required to achieve a target relative root-mean-square error $$\\epsilon = \\frac{\\sqrt{\\mathrm{Var}(\\hat{\\delta n})}}{|\\delta n|}$$ in the estimate of $\\delta n$ for both initialization strategies: quiet start and random start. Then evaluate your expressions for the following parameters: $$\\mu_w = 2.0 \\times 10^{-3}, \\qquad \\sigma_w^2 = 3.0 \\times 10^{-6}, \\qquad \\epsilon = 1.00 \\times 10^{-2}.$$ Assume the top-hat deposit over the cell and take the true $\\delta n$ to be the mean of $\\hat{\\delta n}$ under the corresponding initialization strategy. Round each of your two answers to $3$ significant figures. Express your final results as the required number of markers per cell for quiet start and random start, respectively, in that order. No physical units are required for the count.",
            "solution": "The problem asks for the number of markers per cell required to achieve a target relative root-mean-square error, $\\epsilon$, for two different initialization strategies in a delta-$f$ simulation: quiet start and random start.\n\nThe estimator for the perturbation number density, $\\delta n$, in a configuration-space cell of volume $V$ is given by\n$$\n\\hat{\\delta n} = \\frac{1}{V} \\sum_{i=1}^{N_c} w_i\n$$\nwhere $N_c$ is the number of markers in the cell and $\\{w_i\\}$ are the marker weights. The weights are assumed to be independent and identically distributed (i.i.d.) random variables with mean $E[w_i] = \\mu_w$ and variance $\\mathrm{Var}(w_i) = \\sigma_w^2$.\n\nThe target relative error is defined as\n$$\n\\epsilon = \\frac{\\sqrt{\\mathrm{Var}(\\hat{\\delta n})}}{|\\delta n|}\n$$\nWe are instructed to assume that the true value of the perturbation density, $\\delta n$, is the statistical expectation of its estimator, $\\delta n = E[\\hat{\\delta n}]$, for each case. We will analyze the two initialization strategies separately.\n\nCase 1: Quiet Start\nIn a quiet start, the number of markers per cell is a fixed, deterministic constant, so $N_c = N$.\nFirst, we find the expectation of the estimator, which we equate to the true density $\\delta n$.\n$$\n\\delta n = E[\\hat{\\delta n}] = E\\left[\\frac{1}{V} \\sum_{i=1}^{N} w_i\\right] = \\frac{1}{V} \\sum_{i=1}^{N} E[w_i] = \\frac{1}{V} \\sum_{i=1}^{N} \\mu_w = \\frac{N \\mu_w}{V}\n$$\nNext, we determine the variance of the estimator. Since the weights $\\{w_i\\}$ are independent and $N$ is a constant, the variance of the sum is the sum of the variances.\n$$\n\\mathrm{Var}(\\hat{\\delta n}) = \\mathrm{Var}\\left(\\frac{1}{V} \\sum_{i=1}^{N} w_i\\right) = \\frac{1}{V^2} \\mathrm{Var}\\left(\\sum_{i=1}^{N} w_i\\right) = \\frac{1}{V^2} \\sum_{i=1}^{N} \\mathrm{Var}(w_i) = \\frac{1}{V^2} \\sum_{i=1}^{N} \\sigma_w^2 = \\frac{N \\sigma_w^2}{V^2}\n$$\nNow we can write the squared relative error, $\\epsilon^2$, by substituting the expressions for $\\delta n$ and $\\mathrm{Var}(\\hat{\\delta n})$. Note that the dependency on the sign of $\\mu_w$ vanishes because we use its square.\n$$\n\\epsilon^2 = \\frac{\\mathrm{Var}(\\hat{\\delta n})}{(\\delta n)^2} = \\frac{\\frac{N \\sigma_w^2}{V^2}}{\\left(\\frac{N \\mu_w}{V}\\right)^2} = \\frac{N \\sigma_w^2}{V^2} \\frac{V^2}{N^2 \\mu_w^2} = \\frac{\\sigma_w^2}{N \\mu_w^2}\n$$\nSolving for $N$, the required number of markers per cell for a quiet start, we get:\n$$\nN = \\frac{1}{\\epsilon^2} \\frac{\\sigma_w^2}{\\mu_w^2}\n$$\n\nCase 2: Random Start\nIn a random start, the number of markers in a cell, $N_c$, is a random variable following a Poisson distribution with mean $\\bar{N}$, i.e., $N_c \\sim \\mathrm{Poisson}(\\bar{N})$. The estimator $\\hat{\\delta n}$ is now a compound sum (or random sum), since the number of terms in the summation is itself a random variable.\nFirst, we find the expectation of the estimator using the law of total expectation.\n$$\n\\delta n = E[\\hat{\\delta n}] = E\\left[\\frac{1}{V} \\sum_{i=1}^{N_c} w_i\\right] = \\frac{1}{V} E\\left[\\sum_{i=1}^{N_c} w_i\\right]\n$$\nFor a random sum of i.i.d. variables, the expectation is $E[\\sum_{i=1}^{N_c} w_i] = E[N_c] E[w_i]$. For a Poisson distribution, $E[N_c] = \\bar{N}$.\n$$\n\\delta n = \\frac{1}{V} (\\bar{N} \\mu_w) = \\frac{\\bar{N} \\mu_w}{V}\n$$\nNext, we find the variance of the estimator. We use the law of total variance, which for a random sum (the Blackwell-Girshick equation) is $\\mathrm{Var}(\\sum_{i=1}^{N_c} w_i) = E[N_c]\\mathrm{Var}(w_i) + \\mathrm{Var}(N_c)(E[w_i])^2$. For a Poisson distribution, $\\mathrm{Var}(N_c) = E[N_c] = \\bar{N}$.\n$$\n\\mathrm{Var}\\left(\\sum_{i=1}^{N_c} w_i\\right) = \\bar{N} \\sigma_w^2 + \\bar{N} \\mu_w^2 = \\bar{N} (\\sigma_w^2 + \\mu_w^2)\n$$\nThe variance of the estimator is then:\n$$\n\\mathrm{Var}(\\hat{\\delta n}) = \\mathrm{Var}\\left(\\frac{1}{V} \\sum_{i=1}^{N_c} w_i\\right) = \\frac{1}{V^2} \\mathrm{Var}\\left(\\sum_{i=1}^{N_c} w_i\\right) = \\frac{\\bar{N} (\\sigma_w^2 + \\mu_w^2)}{V^2}\n$$\nNow, we construct the squared relative error $\\epsilon^2$:\n$$\n\\epsilon^2 = \\frac{\\mathrm{Var}(\\hat{\\delta n})}{(\\delta n)^2} = \\frac{\\frac{\\bar{N} (\\sigma_w^2 + \\mu_w^2)}{V^2}}{\\left(\\frac{\\bar{N} \\mu_w}{V}\\right)^2} = \\frac{\\bar{N} (\\sigma_w^2 + \\mu_w^2)}{V^2} \\frac{V^2}{\\bar{N}^2 \\mu_w^2} = \\frac{\\sigma_w^2 + \\mu_w^2}{\\bar{N} \\mu_w^2}\n$$\nSolving for $\\bar{N}$, the required mean number of markers per cell for a random start, we get:\n$$\n\\bar{N} = \\frac{1}{\\epsilon^2} \\frac{\\sigma_w^2 + \\mu_w^2}{\\mu_w^2} = \\frac{1}{\\epsilon^2} \\left(1 + \\frac{\\sigma_w^2}{\\mu_w^2}\\right)\n$$\nThe additional variance from the random number of particles in the cell (Poisson noise) leads to a higher requirement for the number of markers compared to the quiet start.\n\nNumerical Evaluation\nWe are given the parameters:\n$\\mu_w = 2.0 \\times 10^{-3}$\n$\\sigma_w^2 = 3.0 \\times 10^{-6}$\n$\\epsilon = 1.00 \\times 10^{-2}$\n\nFirst, we compute the necessary intermediate quantities:\n$\\mu_w^2 = (2.0 \\times 10^{-3})^2 = 4.0 \\times 10^{-6}$\n$\\frac{1}{\\epsilon^2} = \\frac{1}{(1.00 \\times 10^{-2})^2} = \\frac{1}{1.00 \\times 10^{-4}} = 1.00 \\times 10^4$\nThe ratio of variances is:\n$\\frac{\\sigma_w^2}{\\mu_w^2} = \\frac{3.0 \\times 10^{-6}}{4.0 \\times 10^{-6}} = 0.75$\n\nFor the quiet start, we calculate $N$:\n$N = \\frac{1}{\\epsilon^2} \\frac{\\sigma_w^2}{\\mu_w^2} = (1.00 \\times 10^4) \\times (0.75) = 7500$\nRounding to $3$ significant figures, $N = 7.50 \\times 10^3$.\n\nFor the random start, we calculate $\\bar{N}$:\n$\\bar{N} = \\frac{1}{\\epsilon^2} \\left(1 + \\frac{\\sigma_w^2}{\\mu_w^2}\\right) = (1.00 \\times 10^4) \\times (1 + 0.75) = (1.00 \\times 10^4) \\times (1.75) = 17500$\nRounding to $3$ significant figures, $\\bar{N} = 1.75 \\times 10^4$.\n\nThe required numbers of markers per cell are $7.50 \\times 10^3$ for the quiet start and $1.75 \\times 10^4$ for the random start.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n7.50 \\times 10^3  1.75 \\times 10^4\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "One of the most subtle but critical challenges in the delta-$f$ method is the so-called \"cancellation problem,\" which can lead to severe numerical instability. This instability arises in the evolution equation for the particle weight, $w$, especially in regions with strong gradients in the background distribution $f_{0}$. This practice will guide you through the derivation of this unstable equation and, more importantly, lead you to discover an elegant solution: a change of variables that yields a stable and robust algorithm .",
            "id": "3964533",
            "problem": "Consider a collisionless plasma described by the Vlasov equation in phase space, where phase-space coordinates are denoted by $\\boldsymbol{Z}$ and the characteristic flow by $\\dot{\\boldsymbol{Z}}(\\boldsymbol{Z},t)$. The collisionless Vlasov equation reads $D f / D t = 0$, where $D/Dt \\equiv \\partial/\\partial t + \\dot{\\boldsymbol{Z}} \\cdot \\nabla_{\\boldsymbol{Z}}$. In the $\\delta f$ (delta-f) Particle-In-Cell (PIC) method, the distribution function $f$ is decomposed into an equilibrium part $f_{0}(\\boldsymbol{Z},t)$ and a perturbation $\\delta f(\\boldsymbol{Z},t)$, with $f = f_{0} + \\delta f$. Define the particle weight $w$ as $w \\equiv \\delta f / f_{0}$, and assume markers are advanced along the characteristic flow $\\dot{\\boldsymbol{Z}}(\\boldsymbol{Z},t)$ while $f_{0}(\\boldsymbol{Z},t)$ may have large gradients in space and time.\n\nStarting from the collisionless Vlasov equation and the definition $\\delta f = w f_{0}$, derive the evolution equation for $w$ along marker characteristics in terms of the material derivative of $\\ln f_{0}$, and analyze the stability of this evolution under large values of $D \\ln f_{0} / D t$. In particular, show explicitly how multiplicative amplification of $w$ arises and under what conditions it can lead to numerical overflow when $|D \\ln f_{0} / D t|$ is large.\n\nThen, propose a normalization or rescaling $\\phi(w)$ of the weight variable such that the evolution equation for the rescaled variable is linear in $D \\ln f_{0}/Dt$ and does not include multiplicative dependence on $w$. Derive this $\\phi(w)$ by requiring that the rescaled variable’s evolution along characteristics is $D \\phi / D t = - D \\ln f_{0} / D t$ independent of $w$, and choose the integration constant so that $\\phi(0) = 0$. Express your final answer as a single closed-form analytic expression for $\\phi(w)$. No numerical rounding is required, and no physical units are needed for the final answer.",
            "solution": "The user has provided a problem statement to be validated and solved.\n\n### Step 1: Extract Givens\n-   The system is a collisionless plasma described by the Vlasov equation.\n-   Phase-space coordinates are denoted by $\\boldsymbol{Z}$.\n-   The characteristic flow is $\\dot{\\boldsymbol{Z}}(\\boldsymbol{Z}, t)$.\n-   The Vlasov equation is $\\frac{D f}{D t} = 0$.\n-   The material derivative along characteristics is $D/Dt \\equiv \\partial/\\partial t + \\dot{\\boldsymbol{Z}} \\cdot \\nabla_{\\boldsymbol{Z}}$.\n-   The distribution function $f$ is decomposed as $f = f_{0} + \\delta f$, where $f_0$ is the equilibrium part and $\\delta f$ is the perturbation.\n-   The particle weight $w$ is defined as $w \\equiv \\frac{\\delta f}{f_{0}}$.\n-   Markers (computational particles) are advanced along the characteristic flow $\\dot{\\boldsymbol{Z}}(\\boldsymbol{Z}, t)$.\n-   $f_{0}(\\boldsymbol{Z}, t)$ may have large gradients in space and time.\n-   **Task 1:** Derive the evolution equation for $w$ along marker characteristics in terms of $\\frac{D \\ln f_{0}}{D t}$.\n-   **Task 2:** Analyze the stability of this equation, showing how multiplicative amplification of $w$ arises, especially when $|\\frac{D \\ln f_{0}}{D t}|$ is large.\n-   **Task 3:** Propose a rescaling $\\phi(w)$ such that its evolution equation is $\\frac{D \\phi}{D t} = - \\frac{D \\ln f_{0}}{D t}$, independent of $w$.\n-   **Task 4:** Determine the specific form of $\\phi(w)$ using the integration constant condition $\\phi(0) = 0$.\n-   **Final Answer Requirement:** A single closed-form analytic expression for $\\phi(w)$.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientifically Grounded:** The problem is firmly rooted in the principles of plasma kinetic theory and computational physics. The Vlasov equation, the $\\delta f$ method, and the concept of particle weights are standard and fundamental in this field. The issue of numerical instability due to large background gradients (\"cancellation problem\") is a well-known and critical research topic in $\\delta f$ simulations. The problem is scientifically valid and realistic.\n-   **Well-Posed:** The problem is clearly structured with a sequence of derivations and an analysis. It provides all necessary definitions and a specific differential equation with a boundary condition to find the function $\\phi(w)$, ensuring a unique and meaningful solution exists.\n-   **Objective:** The problem is stated using precise, formal, and unbiased scientific language. There are no subjective or ambiguous terms.\n-   **Conclusion:** The problem does not violate any of the invalidity criteria. It is scientifically sound, well-posed, objective, complete, and poses a non-trivial question central to its specified field of computational fusion science.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full solution will be provided.\n\n### Solution Derivation\n\nThe analysis begins with the collisionless Vlasov equation, which states that the total distribution function $f$ is conserved along the characteristic trajectories in phase space:\n$$\n\\frac{D f}{D t} = 0\n$$\nThe distribution function $f$ is decomposed into a known, large background or equilibrium part $f_0$ and a small perturbation $\\delta f$:\n$$\nf(\\boldsymbol{Z}, t) = f_0(\\boldsymbol{Z}, t) + \\delta f(\\boldsymbol{Z}, t)\n$$\nSubstituting this decomposition into the Vlasov equation and using the linearity of the material derivative operator gives:\n$$\n\\frac{D}{D t} (f_0 + \\delta f) = \\frac{D f_0}{D t} + \\frac{D \\delta f}{D t} = 0\n$$\nThis yields the evolution equation for the perturbation $\\delta f$:\n$$\n\\frac{D \\delta f}{D t} = - \\frac{D f_0}{D t}\n$$\nThe particle weight $w$ is defined as the ratio of the perturbation to the background distribution, $w \\equiv \\frac{\\delta f}{f_0}$. This implies $\\delta f = w f_0$. We substitute this definition into the evolution equation for $\\delta f$:\n$$\n\\frac{D (w f_0)}{D t} = - \\frac{D f_0}{D t}\n$$\nApplying the product rule for the material derivative to the left-hand side, we obtain:\n$$\n\\left(\\frac{D w}{D t}\\right) f_0 + w \\left(\\frac{D f_0}{D t}\\right) = - \\frac{D f_0}{D t}\n$$\nTo solve for $\\frac{D w}{D t}$, we first rearrange the equation:\n$$\n\\left(\\frac{D w}{D t}\\right) f_0 = - \\frac{D f_0}{D t} - w \\left(\\frac{D f_0}{D t}\\right) = - (1 + w) \\left(\\frac{D f_0}{D t}\\right)\n$$\nAssuming $f_0 \\neq 0$, which must be true for it to represent a physical distribution, we can divide by $f_0$:\n$$\n\\frac{D w}{D t} = - (1 + w) \\left(\\frac{1}{f_0} \\frac{D f_0}{D t}\\right)\n$$\nUsing the chain rule for derivatives, we recognize that $\\frac{d(\\ln x)}{dt} = \\frac{1}{x} \\frac{dx}{dt}$. Applying this to the material derivative, we have $\\frac{D \\ln f_0}{Dt} = \\frac{1}{f_0} \\frac{D f_0}{Dt}$. Substituting this into the equation for $\\frac{D w}{D t}$, we arrive at the desired evolution equation for the weight $w$:\n$$\n\\frac{D w}{D t} = - (1 + w) \\frac{D \\ln f_0}{D t}\n$$\nThis completes the first part of the problem.\n\nFor the second part, we analyze the stability of this equation. Let us denote $G(t) = \\frac{D \\ln f_0}{D t}$ as evaluated along a marker's trajectory. The equation is $\\frac{D w}{D t} = - (1 + w) G(t)$. Expanding this gives:\n$$\n\\frac{D w}{D t} = -G(t) - w G(t)\n$$\nThe term $-w G(t)$ shows that the rate of change of the weight, $\\frac{D w}{D t}$, is itself dependent on the current value of the weight, $w$. This is a multiplicative relationship. If $|G(t)| = |\\frac{D \\ln f_0}{D t}|$ is large, this term can lead to numerical instability. Specifically, if $G(t)$ is large and negative, say $G(t) = -A$ where $A > 0$ is a large constant, the equation becomes $\\frac{D w}{D t} \\approx A w$. This is the canonical equation for exponential growth, $w(t) \\propto \\exp(At)$. The weight $w$ can grow exponentially fast, leading to very large values that can exceed the floating-point limits of a computer, causing a numerical overflow. This multiplicative amplification of a marker's weight is a significant numerical challenge in $\\delta f$ simulations, particularly in regions where the background distribution $f_0$ changes rapidly along particle paths (e.g., steep density or temperature gradients).\n\nTo address this instability, the third part of the problem asks for a change of variable from $w$ to a new variable $\\phi(w)$ such that its evolution is linear and free from this multiplicative term. The prescribed evolution equation for $\\phi$ is:\n$$\n\\frac{D \\phi}{D t} = - \\frac{D \\ln f_0}{D t}\n$$\nTo find the function $\\phi(w)$, we use the chain rule to relate the time derivative of $\\phi$ to the time derivative of $w$:\n$$\n\\frac{D \\phi}{D t} = \\frac{d \\phi}{d w} \\frac{D w}{D t}\n$$\nWe now substitute the expressions we have for $\\frac{D \\phi}{D t}$ and $\\frac{D w}{D t}$:\n$$\n- \\frac{D \\ln f_0}{D t} = \\frac{d \\phi}{d w} \\left[ - (1 + w) \\frac{D \\ln f_0}{D t} \\right]\n$$\nFor a non-trivial evolution where $\\frac{D \\ln f_0}{D t} \\neq 0$, we can cancel the term $-\\frac{D \\ln f_0}{D t}$ from both sides of the equation. This leaves us with a simple ordinary differential equation for $\\phi$ as a function of $w$:\n$$\n1 = \\frac{d \\phi}{d w} (1 + w)\n$$\nSolving for $\\frac{d \\phi}{d w}$ gives:\n$$\n\\frac{d \\phi}{d w} = \\frac{1}{1 + w}\n$$\nTo find $\\phi(w)$, we integrate this expression with respect to $w$:\n$$\n\\phi(w) = \\int \\frac{1}{1 + w} dw = \\ln|1 + w| + C\n$$\nwhere $C$ is the constant of integration. Since $f = f_0 + \\delta f = f_0(1+w)$ must be a non-negative distribution function and $f_0$ is typically a positive function (like a Maxwellian), it is required that $1+w \\geq 0$. We operate in the domain where $1+w > 0$, so we can drop the absolute value:\n$$\n\\phi(w) = \\ln(1 + w) + C\n$$\nThe problem specifies the condition $\\phi(0) = 0$ to determine the constant $C$. Applying this condition:\n$$\n\\phi(0) = \\ln(1 + 0) + C = \\ln(1) + C = 0 + C\n$$\nThus, we find $C = 0$. The final expression for the rescaled variable is:\n$$\n\\phi(w) = \\ln(1 + w)\n$$\nThis variable $\\phi$ evolves according to $\\frac{D \\phi}{D t} = - \\frac{D \\ln f_0}{D t}$, which is stable as the right-hand side is purely a source term, independent of $\\phi$ itself. The evolution of $\\phi$ is found by simply integrating the source term along the characteristics.",
            "answer": "$$\\boxed{\\ln(1+w)}$$"
        }
    ]
}