{
    "hands_on_practices": [
        {
            "introduction": "Before we can effectively use a digital filter, we must understand its impact on different frequency components of our data. This foundational exercise guides you through the analysis of a common binomial smoothing filter used in Particle-In-Cell codes. By deriving the exact magnitude response and group delay from the filter's definition , you will build the essential skill of characterizing a filter's behavior in the frequency domain.",
            "id": "3965593",
            "problem": "Consider a one-dimensional spatial smoothing used in Particle-In-Cell (PIC) plasma simulations to mitigate grid-scale noise on a uniform mesh. Let the grid index be $n \\in \\mathbb{Z}$ and the grid spacing be $\\Delta x$. A current density sequence $j[n]$ is smoothed by a linear time-invariant filter whose finite impulse response (FIR) kernel is the two-pass binomial kernel of length $5$ with coefficients\n$$\nh[0] = \\frac{1}{16}, \\quad h[1] = \\frac{4}{16}, \\quad h[2] = \\frac{6}{16}, \\quad h[3] = \\frac{4}{16}, \\quad h[4] = \\frac{1}{16}.\n$$\nThe smoothed sequence is defined by discrete convolution,\n$$\ny[n] = \\sum_{m=0}^{4} h[m]\\, j[n-m].\n$$\nLet the input be a single spatial Fourier mode $j[n] = \\exp\\!\\big(i k n \\Delta x\\big)$, where $k$ is the physical wavenumber. Define the discrete radian frequency $\\omega = k \\Delta x$. The Discrete Fourier Transform (DFT) frequency response $H(\\omega)$ of the kernel is given by the discrete-time Fourier transform\n$$\nH(\\omega) = \\sum_{m=0}^{4} h[m]\\, \\exp(-i \\omega m).\n$$\nStarting only from the definitions of discrete convolution and the discrete-time Fourier transform, derive the exact closed-form expressions for the magnitude response $|H(\\omega)|$ and the group delay $\\tau_{g}(\\omega)$ defined by\n$$\n\\tau_{g}(\\omega) = -\\frac{d}{d\\omega} \\,\\phi(\\omega),\n$$\nwhere $\\phi(\\omega)$ is the unwrapped phase of $H(\\omega)$. Express both $|H(\\omega)|$ and $\\tau_{g}(\\omega)$ as analytic functions of $\\omega$. No numerical rounding is required. Provide your final answer as a two-entry row matrix, with the first entry equal to the magnitude response $|H(\\omega)|$ and the second entry equal to the group delay $\\tau_{g}(\\omega)$. Do not include units in your final answer.",
            "solution": "The problem requires the derivation of the magnitude response $|H(\\omega)|$ and the group delay $\\tau_{g}(\\omega)$ for a given Finite Impulse Response (FIR) filter. The derivation shall proceed from the fundamental definitions provided.\n\nThe FIR filter is defined by its impulse response (kernel) $h[n]$. The given coefficients are:\n$h[0] = \\frac{1}{16}$, $h[1] = \\frac{4}{16}$, $h[2] = \\frac{6}{16}$, $h[3] = \\frac{4}{16}$, and $h[4] = \\frac{1}{16}$.\n\nThe frequency response $H(\\omega)$ is the Discrete-Time Fourier Transform (DTFT) of the kernel $h[n]$, given by the formula:\n$$\nH(\\omega) = \\sum_{m=0}^{4} h[m]\\, \\exp(-i \\omega m)\n$$\nSubstituting the given coefficients for $h[m]$:\n$$\nH(\\omega) = h[0] \\exp(-i \\omega \\cdot 0) + h[1] \\exp(-i \\omega \\cdot 1) + h[2] \\exp(-i \\omega \\cdot 2) + h[3] \\exp(-i \\omega \\cdot 3) + h[4] \\exp(-i \\omega \\cdot 4)\n$$\n$$\nH(\\omega) = \\frac{1}{16} + \\frac{4}{16} \\exp(-i\\omega) + \\frac{6}{16} \\exp(-i2\\omega) + \\frac{4}{16} \\exp(-i3\\omega) + \\frac{1}{16} \\exp(-i4\\omega)\n$$\nWe can factor out the common term $\\frac{1}{16}$:\n$$\nH(\\omega) = \\frac{1}{16} \\left( 1 + 4\\exp(-i\\omega) + 6\\exp(-i2\\omega) + 4\\exp(-i3\\omega) + \\exp(-i4\\omega) \\right)\n$$\nThe filter coefficients are symmetric, i.e., $h[m] = h[4-m]$. This indicates that the filter has a generalized linear phase. The center of symmetry for this filter of length $N=5$ (indices from $0$ to $4$) is at $m=2$. We can factor out the term corresponding to this center of symmetry, $\\exp(-i2\\omega)$, to simplify the expression.\n$$\nH(\\omega) = \\frac{1}{16} \\exp(-i2\\omega) \\left( \\exp(i2\\omega) + 4\\exp(i\\omega) + 6 + 4\\exp(-i\\omega) + \\exp(-i2\\omega) \\right)\n$$\nBy grouping terms and using Euler's identity, $\\exp(i\\theta) + \\exp(-i\\theta) = 2\\cos(\\theta)$, we can rewrite the expression in the parenthesis:\n$$\n\\left( \\exp(i2\\omega) + \\exp(-i2\\omega) \\right) + 4 \\left( \\exp(i\\omega) + \\exp(-i\\omega) \\right) + 6 = 2\\cos(2\\omega) + 4(2\\cos(\\omega)) + 6\n$$\nSo, the frequency response becomes:\n$$\nH(\\omega) = \\frac{1}{16} \\exp(-i2\\omega) \\left( 2\\cos(2\\omega) + 8\\cos(\\omega) + 6 \\right)\n$$\nTo simplify the real-valued amplitude part, we use the double-angle trigonometric identity $\\cos(2\\omega) = 2\\cos^2(\\omega) - 1$:\n$$\n2(2\\cos^2(\\omega) - 1) + 8\\cos(\\omega) + 6 = 4\\cos^2(\\omega) - 2 + 8\\cos(\\omega) + 6 = 4\\cos^2(\\omega) + 8\\cos(\\omega) + 4\n$$\nThis expression is a perfect square:\n$$\n4(\\cos^2(\\omega) + 2\\cos(\\omega) + 1) = 4(\\cos(\\omega) + 1)^2\n$$\nSubstituting this back into the expression for $H(\\omega)$:\n$$\nH(\\omega) = \\frac{1}{16} \\exp(-i2\\omega) \\left[ 4(\\cos(\\omega) + 1)^2 \\right] = \\frac{1}{4} \\exp(-i2\\omega) (\\cos(\\omega) + 1)^2\n$$\nNow, we use the half-angle identity $1 + \\cos(\\omega) = 2\\cos^2(\\frac{\\omega}{2})$:\n$$\nH(\\omega) = \\frac{1}{4} \\exp(-i2\\omega) \\left[ 2\\cos^2\\left(\\frac{\\omega}{2}\\right) \\right]^2 = \\frac{1}{4} \\exp(-i2\\omega) \\left[ 4\\cos^4\\left(\\frac{\\omega}{2}\\right) \\right]\n$$\nThis simplifies to a very compact form for the frequency response:\n$$\nH(\\omega) = \\cos^4\\left(\\frac{\\omega}{2}\\right) \\exp(-i2\\omega)\n$$\nThis expression is in the polar form $H(\\omega) = A(\\omega) \\exp(i\\phi(\\omega))$, where $A(\\omega) = \\cos^4\\left(\\frac{\\omega}{2}\\right)$ is the amplitude and $\\phi(\\omega) = -2\\omega$ is the phase.\n\nFirst, we find the magnitude response $|H(\\omega)|$. It is the absolute value of the complex function $H(\\omega)$.\n$$\n|H(\\omega)| = \\left| \\cos^4\\left(\\frac{\\omega}{2}\\right) \\exp(-i2\\omega) \\right| = \\left| \\cos^4\\left(\\frac{\\omega}{2}\\right) \\right| \\cdot |\\exp(-i2\\omega)|\n$$\nSince $|\\exp(-i2\\omega)| = \\sqrt{\\cos^2(-2\\omega) + \\sin^2(-2\\omega)} = 1$, and $\\cos^4(\\frac{\\omega}{2})$ is always non-negative for real $\\omega$, the magnitude response is simply the amplitude function itself:\n$$\n|H(\\omega)| = \\cos^4\\left(\\frac{\\omega}{2}\\right)\n$$\nSecond, we find the group delay $\\tau_g(\\omega)$. The group delay is defined as $\\tau_{g}(\\omega) = -\\frac{d}{d\\omega} \\phi(\\omega)$, where $\\phi(\\omega)$ is the unwrapped phase of $H(\\omega)$.\nFrom our expression $H(\\omega) = \\cos^4(\\frac{\\omega}{2}) \\exp(-i2\\omega)$, the amplitude term $\\cos^4(\\frac{\\omega}{2})$ is always non-negative. Therefore, there are no phase jumps of $\\pm\\pi$, and the phase of $H(\\omega)$ is given directly by the argument of the complex exponential term.\nThe phase $\\phi(\\omega)$ is:\n$$\n\\phi(\\omega) = -2\\omega\n$$\nSince this is a linear function of $\\omega$, it is already in its unwrapped form. We can now compute the derivative with respect to $\\omega$ to find the group delay:\n$$\n\\tau_g(\\omega) = -\\frac{d}{d\\omega} (-2\\omega) = -(-2) = 2\n$$\nThe group delay is a constant value of $2$. This is expected for a symmetric FIR filter, where the group delay is equal to the index of the center of symmetry of the kernel, which is $(N-1)/2 = (5-1)/2 = 2$.\n\nThe two requested quantities are the magnitude response $|H(\\omega)|$ and the group delay $\\tau_g(\\omega)$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\cos^4\\left(\\frac{\\omega}{2}\\right)  2 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "The total filtering effect in a PIC simulation arises from both explicit smoothing operations and the implicit smoothing inherent in the particle-to-grid deposition scheme. This practice explores this combined effect by analyzing the transfer function of a Triangular-Shaped Cloud (TSC) particle shape cascaded with a binomial smoother . Mastering this analysis is key to holistically managing numerical accuracy and noise suppression.",
            "id": "3965627",
            "problem": "In a one-dimensional Particle-In-Cell (PIC) simulation of a magnetized fusion plasma on a uniform grid of spacing $\\Delta x$, consider charge deposition using the Triangular-Shaped Cloud (TSC), which is the quadratic B-spline formed by convolving a top-hat of width $\\Delta x$ with itself $3$ times. To mitigate aliasing and high-frequency numerical noise, an explicit binomial smoothing filter with kernel $\\{1, 2, 1\\}/4$ is applied $2$ successive times to the grid charge density after deposition. Assume all operations are linear and spatially shift-invariant, and analyze everything in the continuous wavenumber domain.\n\nStarting from the definitions of convolution and the Fourier transform, and using only well-tested facts about Fourier-domain multiplication of transfer functions, derive the combined wavenumber transfer function $T(k)$ that maps an underlying physical charge mode of wavenumber $k$ to the filtered grid charge density. Then, analyze its low-wavenumber passband and its high-wavenumber stopband as follows:\n\n1. Define the passband flatness coefficient $a$ by the second-order Taylor expansion of the normalized transfer near $k=0$,\n$$\n\\frac{T(k)}{T(0)} = 1 - a\\,(k \\Delta x)^{2} + \\mathcal{O}\\!\\left((k \\Delta x)^{4}\\right).\n$$\nCompute $a$ exactly.\n\n2. Define the stopband depth $D$ as the exact value of $T(k)$ at the Nyquist wavenumber $k_{\\mathrm{N}} = \\pi/\\Delta x$. Compute $D$ exactly.\n\nExpress your final answer as a row matrix containing the pair $(a, D)$. No rounding is required, and no units should be included in the final reported values.",
            "solution": "The problem requires the derivation and analysis of the combined wavenumber transfer function for a sequence of operations in a Particle-In-Cell (PIC) simulation: charge deposition using the Triangular-Shaped Cloud (TSC) scheme, followed by two successive applications of a binomial smoothing filter. The analysis is to be performed in the continuous wavenumber domain, assuming all operations are linear and spatially shift-invariant.\n\nThe fundamental principle for analyzing a sequence of linear, shift-invariant operations is that the total transfer function in the Fourier (wavenumber) domain is the product of the individual transfer functions of each operation. Let the overall transfer function be $T(k)$, where $k$ is the wavenumber. The process consists of one TSC deposition step and two identical filtering steps. Therefore, we can write:\n$$\nT(k) = T_{\\mathrm{TSC}}(k) \\cdot \\left( T_{\\mathrm{filter}}(k) \\right)^2\n$$\nwhere $T_{\\mathrm{TSC}}(k)$ is the transfer function for the TSC deposition and $T_{\\mathrm{filter}}(k)$ is the transfer function for a single application of the binomial filter. We will now derive each of these components.\n\nFirst, let's derive the transfer function for the TSC deposition, $T_{\\mathrm{TSC}}(k)$. The problem states that TSC is the quadratic B-spline formed by convolving a top-hat function of width $\\Delta x$ with itself $3$ times. Let us define a normalized top-hat function, $S_1(x)$, such that its integral over all space is $1$:\n$$\nS_1(x) = \\begin{cases} \\frac{1}{\\Delta x}  |x| \\le \\frac{\\Delta x}{2} \\\\ 0  |x|  \\frac{\\Delta x}{2} \\end{cases}\n$$\nThe transfer function of this shape function is its Fourier transform, $\\hat{S}_1(k)$:\n$$\n\\hat{S}_1(k) = \\int_{-\\infty}^{\\infty} S_1(x) e^{-ikx} \\, dx = \\frac{1}{\\Delta x} \\int_{-\\Delta x/2}^{\\Delta x/2} e^{-ikx} \\, dx\n$$\n$$\n\\hat{S}_1(k) = \\frac{1}{-ik\\Delta x} \\left( e^{-ik\\Delta x/2} - e^{ik\\Delta x/2} \\right) = \\frac{2 \\sin(k\\Delta x/2)}{k\\Delta x}\n$$\nThis expression can be written as $\\frac{\\sin(k\\Delta x/2)}{k\\Delta x/2}$. The TSC shape function, $S_{\\mathrm{TSC}}(x)$, is the result of three such convolutions: $S_{\\mathrm{TSC}}(x) = S_1(x) * S_1(x) * S_1(x)$, where $*$ denotes convolution. By the convolution theorem, its Fourier transform, which is the deposition transfer function $T_{\\mathrm{TSC}}(k)$, is the cube of $\\hat{S}_1(k)$:\n$$\nT_{\\mathrm{TSC}}(k) = \\left( \\frac{\\sin(k\\Delta x/2)}{k\\Delta x/2} \\right)^3\n$$\n\nNext, we derive the transfer function for the binomial smoothing filter, $T_{\\mathrm{filter}}(k)$. The filter is applied to the discrete charge density on the grid, $\\rho_j = \\rho(j\\Delta x)$. The filter has a kernel of $\\{\\frac{1}{4}, \\frac{2}{4}, \\frac{1}{4}\\}$. The filtered value at grid point $j$, denoted $\\rho'_j$, is:\n$$\n\\rho'_j = \\frac{1}{4}\\rho_{j-1} + \\frac{2}{4}\\rho_j + \\frac{1}{4}\\rho_{j+1}\n$$\nTo find the transfer function, we analyze its effect on a single Fourier mode on the grid, $e^{ikx_j} = e^{ikj\\Delta x}$. Applying the filter to this mode yields:\n$$\n\\frac{1}{4}e^{ik(j-1)\\Delta x} + \\frac{2}{4}e^{ikj\\Delta x} + \\frac{1}{4}e^{ik(j+1)\\Delta x} = e^{ikj\\Delta x} \\left( \\frac{1}{4}e^{-ik\\Delta x} + \\frac{1}{2} + \\frac{1}{4}e^{ik\\Delta x} \\right)\n$$\nThe term in the parenthesis is the transfer function, $T_{\\mathrm{filter}}(k)$:\n$$\nT_{\\mathrm{filter}}(k) = \\frac{1}{2} + \\frac{1}{4}(e^{ik\\Delta x} + e^{-ik\\Delta x}) = \\frac{1}{2} + \\frac{1}{2}\\cos(k\\Delta x)\n$$\nUsing the half-angle identity $1 + \\cos(\\theta) = 2\\cos^2(\\theta/2)$, we can simplify this expression:\n$$\nT_{\\mathrm{filter}}(k) = \\frac{1}{2}(1 + \\cos(k\\Delta x)) = \\cos^2\\left(\\frac{k\\Delta x}{2}\\right)\n$$\n\nNow we can construct the total transfer function, $T(k)$. For notational simplicity, let $u = \\frac{k\\Delta x}{2}$.\n$$\nT_{\\mathrm{TSC}}(k) = \\left(\\frac{\\sin u}{u}\\right)^3\n$$\n$$\nT_{\\mathrm{filter}}(k) = \\cos^2(u)\n$$\nThe total transfer function is:\n$$\nT(k) = T_{\\mathrm{TSC}}(k) \\cdot \\left( T_{\\mathrm{filter}}(k) \\right)^2 = \\left(\\frac{\\sin u}{u}\\right)^3 \\cos^4(u)\n$$\n\nWith the total transfer function derived, we proceed to compute the two requested quantities.\n\n1. Passband flatness coefficient $a$:\nThis coefficient is defined by the Taylor series expansion around $k=0$:\n$$\n\\frac{T(k)}{T(0)} = 1 - a\\,(k \\Delta x)^{2} + \\mathcal{O}\\!\\left((k \\Delta x)^{4}\\right)\n$$\nFirst, we find $T(0)$. As $k \\to 0$, we have $u \\to 0$. In this limit, $\\frac{\\sin u}{u} \\to 1$ and $\\cos(u) \\to 1$. Thus, $T(0) = (1)^3 \\cdot (1)^4 = 1$. The normalized transfer function is just $T(k)$.\nWe must expand $T(k)$ in powers of $k\\Delta x$, or equivalently, in powers of $u$. Note that $(k\\Delta x)^2 = (2u)^2 = 4u^2$.\nWe use the Taylor series for $\\sin(u)$ and $\\cos(u)$ around $u=0$:\n$$\n\\sin(u) = u - \\frac{u^3}{6} + \\mathcal{O}(u^5) \\implies \\frac{\\sin u}{u} = 1 - \\frac{u^2}{6} + \\mathcal{O}(u^4)\n$$\n$$\n\\cos(u) = 1 - \\frac{u^2}{2} + \\mathcal{O}(u^4)\n$$\nNow we compute the powers required for $T(k)$, retaining terms up to $\\mathcal{O}(u^2)$:\n$$\n\\left(\\frac{\\sin u}{u}\\right)^3 = \\left(1 - \\frac{u^2}{6} + \\mathcal{O}(u^4)\\right)^3 = 1 - 3\\left(\\frac{u^2}{6}\\right) + \\mathcal{O}(u^4) = 1 - \\frac{u^2}{2} + \\mathcal{O}(u^4)\n$$\n$$\n\\cos^4(u) = \\left(1 - \\frac{u^2}{2} + \\mathcal{O}(u^4)\\right)^4 = 1 - 4\\left(\\frac{u^2}{2}\\right) + \\mathcal{O}(u^4) = 1 - 2u^2 + \\mathcal{O}(u^4)\n$$\nMultiplying these two expansions gives the expansion for $T(k)$:\n$$\nT(k) = \\left(1 - \\frac{u^2}{2}\\right)\\left(1 - 2u^2\\right) + \\mathcal{O}(u^4) = 1 - 2u^2 - \\frac{u^2}{2} + \\mathcal{O}(u^4) = 1 - \\frac{5}{2}u^2 + \\mathcal{O}(u^4)\n$$\nNow, substitute back $u = \\frac{k\\Delta x}{2}$:\n$$\nT(k) = 1 - \\frac{5}{2}\\left(\\frac{k\\Delta x}{2}\\right)^2 + \\mathcal{O}((k\\Delta x)^4) = 1 - \\frac{5}{8}(k\\Delta x)^2 + \\mathcal{O}((k\\Delta x)^4)\n$$\nBy comparing this with the definition $T(k) = 1 - a(k\\Delta x)^2 + \\mathcal{O}((k\\Delta x)^4)$, we identify the coefficient $a$:\n$$\na = \\frac{5}{8}\n$$\n\n2. Stopband depth $D$:\nThis is defined as the value of $T(k)$ at the Nyquist wavenumber, $k_{\\mathrm{N}} = \\frac{\\pi}{\\Delta x}$.\nAt $k=k_{\\mathrm{N}}$, the parameter $u$ becomes:\n$$\nu_{\\mathrm{N}} = \\frac{k_{\\mathrm{N}}\\Delta x}{2} = \\frac{(\\pi/\\Delta x)\\Delta x}{2} = \\frac{\\pi}{2}\n$$\nWe evaluate $T(k)$ at $u=\\frac{\\pi}{2}$:\n$$\nD = T(k_{\\mathrm{N}}) = \\left(\\frac{\\sin(\\pi/2)}{\\pi/2}\\right)^3 \\cos^4\\left(\\frac{\\pi}{2}\\right)\n$$\nWe know that $\\sin(\\frac{\\pi}{2}) = 1$ and $\\cos(\\frac{\\pi}{2}) = 0$.\n$$\nD = \\left(\\frac{1}{\\pi/2}\\right)^3 \\cdot (0)^4 = \\left(\\frac{2}{\\pi}\\right)^3 \\cdot 0 = 0\n$$\nThe stopband depth is exactly zero. This is a direct consequence of the binomial filter's transfer function, $\\cos^2(u)$, having a zero at $u=\\frac{\\pi}{2}$.\n\nThe final answer is the pair $(a, D)$. We found $a = \\frac{5}{8}$ and $D=0$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{5}{8}  0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Perhaps the most critical aspect of applying numerical techniques in physics simulations is ensuring they do not violate fundamental conservation laws. This exercise addresses the crucial interaction between digital filtering and charge conservation, a cornerstone of electromagnetism . By investigating the discrete continuity equation, you will learn why naively filtering the current can lead to unphysical results and how to apply filters in a way that preserves the simulation's physical integrity.",
            "id": "3965601",
            "problem": "Consider a one-dimensional, periodic Particle-In-Cell (PIC) discretization of a fusion plasma slice along a line of length $L$ with $N$ uniformly spaced cells of width $\\Delta x$ such that $L = N \\Delta x$. Use the Cloud-In-Cell (CIC) shape function for charge deposition. The line charge density at cell centers is denoted by $\\rho_i$ in $\\,\\mathrm{C/m}$, and the face-centered electric current at cell faces is denoted by $J_{i+1/2}$ in $\\,\\mathrm{C/s}$. Let the time step be $\\Delta t$ in $\\,\\mathrm{s}$. The discrete continuity equation, derived from the fundamental law $\\partial_t \\rho + \\nabla \\cdot \\mathbf{J} = 0$, is to be enforced in the form\n$$\n\\frac{\\rho_i^{n+1} - \\rho_i^{n}}{\\Delta t} + \\frac{J_{i+1/2}^{n+1/2} - J_{i-1/2}^{n+1/2}}{\\Delta x} = 0,\n$$\nfor all cell indices $i$, under periodic boundary conditions. The Esirkepov current is the face-centered current that exactly satisfies the above discrete continuity equation when charge is deposited with the same shape function.\n\nFor a given set of particles with charges $q_p$ and positions $x_p^n$ at time $t^n$ and $x_p^{n+1}$ at time $t^{n+1} = t^n + \\Delta t$, proceed as follows:\n- Deposit $\\rho_i^n$ and $\\rho_i^{n+1}$ to cell centers using the Cloud-In-Cell (CIC) shape function, normalizing by cell width $\\Delta x$ so that $\\sum_i \\rho_i \\Delta x = \\sum_p q_p$ holds.\n- Compute a face-centered current $J_{i+1/2}^{n+1/2}$ that obeys the discrete continuity equation exactly for the deposited $\\rho_i^n$ and $\\rho_i^{n+1}$.\n- Apply a separable binomial digital filter in space to $J_{i+1/2}^{n+1/2}$, with periodic convolution kernel $[1, 2, 1]/4$ in one dimension, for a specified number of passes. Optionally apply the same spatial binomial filter to $\\rho_i^n$ and $\\rho_i^{n+1}$.\n- Compute the discrete continuity residual per cell,\n$$\n\\varepsilon_i = \\frac{\\rho_i^{n+1} - \\rho_i^{n}}{\\Delta t} + \\frac{J_{i+1/2}^{n+1/2} - J_{i-1/2}^{n+1/2}}{\\Delta x},\n$$\nand report the maximum absolute residual $\\max_i |\\varepsilon_i|$ in units $\\,\\mathrm{C/(s \\cdot m)}$.\n\nYour program must implement periodic boundary conditions and the CIC deposition in one dimension. The separable binomial filter must be implemented as a periodic spatial convolution and applied the specified number of times. Verify charge conservation numerically by measuring the discrete continuity residual before and after filtering the Esirkepov current, and when filtering the charge consistently with the current.\n\nUse the following test suite of parameter values and particle motions. All positions are within the domain $[0, L)$ with $L = N \\Delta x$ and wrap periodically. Use $N = 64$, $\\Delta x = 10^{-3}\\,\\mathrm{m}$, $\\Delta t = 10^{-9}\\,\\mathrm{s}$, and electron charge magnitude $e = 1.602 \\times 10^{-19}\\,\\mathrm{C}$. Each particle has charge $q_p = -e$.\n\nDefine six test cases, each producing one float equal to $\\max_i |\\varepsilon_i|$ in $\\,\\mathrm{C/(s \\cdot m)}$:\n- Case $1$ (happy path, no filtering): two particles move without crossing cell boundaries. Particle $1$: $x_1^n = 1.0 \\times 10^{-2}\\,\\mathrm{m}$ to $x_1^{n+1} = 1.07 \\times 10^{-2}\\,\\mathrm{m}$. Particle $2$: $x_2^n = 3.0 \\times 10^{-2}\\,\\mathrm{m}$ to $x_2^{n+1} = 2.96 \\times 10^{-2}\\,\\mathrm{m}$. Do not filter $\\rho$ or $J$.\n- Case $2$ (filter current only): same particles and motions as Case $1$, apply one pass of the binomial filter to $J$ only.\n- Case $3$ (filter both consistently): same particles and motions as Case $1$, apply one pass of the binomial filter to both $\\rho$ (at times $t^n$ and $t^{n+1}$) and $J$.\n- Case $4$ (edge case, periodic crossing, no filtering): Particle $1$: $x_1^n = 6.35 \\times 10^{-2}\\,\\mathrm{m}$ to $x_1^{n+1} = 3.0 \\times 10^{-4}\\,\\mathrm{m}$ (wraps around). Particle $2$: $x_2^n = 1.0 \\times 10^{-3}\\,\\mathrm{m}$ to $x_2^{n+1} = 2.7 \\times 10^{-3}\\,\\mathrm{m}$. Do not filter $\\rho$ or $J$.\n- Case $5$ (edge case, periodic crossing, filter current only): same particles and motions as Case $4$, apply one pass of the binomial filter to $J$ only.\n- Case $6$ (zero motion): one particle with $x_1^n = 2.0 \\times 10^{-2}\\,\\mathrm{m}$ and $x_1^{n+1} = 2.0 \\times 10^{-2}\\,\\mathrm{m}$. Apply one pass of the binomial filter to $J$ only.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[$r_1, r_2, r_3, r_4, r_5, r_6$]\"), where each $r_k$ is the float value of $\\max_i |\\varepsilon_i|$ for Case $k$, in $\\,\\mathrm{C/(s \\cdot m)}$.",
            "solution": "The problem requires the calculation of the discrete charge continuity equation residual for a one-dimensional Particle-In-Cell (PIC) simulation under various digital filtering scenarios. The solution involves implementing the Cloud-In-Cell (CIC) charge deposition scheme, calculating the Esirkepov current that exactly satisfies the discrete continuity equation, applying a binomial filter, and finally computing the residual.\n\nThe physical system is a 1D periodic domain of length $L$ discretized into $N$ cells of width $\\Delta x$. The cell-centered charge density is $\\rho_i$ and the face-centered current is $J_{i+1/2}$. To simplify notation, we will denote the grid for cell centers by index $i$ (ranging from $0$ to $N-1$) and the grid for cell faces by index $i$ (corresponding to the left face of cell $i$). The continuity equation is then written as:\n$$\n\\frac{\\rho_i^{n+1} - \\rho_i^{n}}{\\Delta t} + \\frac{J_{i+1} - J_i}{\\Delta x} = 0\n$$\nwhere $J_i$ represents the current on the face at position $i \\Delta x$. All indices are subject to periodic boundary conditions, i.e., index $k$ is equivalent to $k \\pmod N$.\n\nThe overall algorithm for each test case proceeds as follows:\n1.  Deposit particle charges onto the grid to obtain densities $\\rho_i^n$ and $\\rho_i^{n+1}$.\n2.  If specified, apply a binomial filter to the charge densities.\n3.  Calculate the Esirkepov current $J_i$ that is consistent with the (possibly filtered) charge densities.\n4.  If specified, apply the binomial filter to the calculated current.\n5.  Compute the continuity residual $\\varepsilon_i$ using the final charge densities and currents.\n6.  Report the maximum absolute value of the residual, $\\max_i |\\varepsilon_i|$.\n\n**Step 1: Cloud-In-Cell (CIC) Charge Deposition**\nThe CIC scheme deposits the charge $q_p$ of a particle at position $x_p$ onto the two nearest grid locations. The grid for charge density consists of cell centers at positions $x_i = (i+0.5)\\Delta x$ for $i=0, ..., N-1$.\n\nFor a particle at position $x_p$, we first find its logical coordinate $u_p = x_p / \\Delta x$. The index of the cell center immediately to the left of the particle is $i = \\lfloor u_p - 0.5 \\rfloor$. The fractional distance of the particle from this cell center, normalized by $\\Delta x$, serves as the weight for the adjacent cell center:\n$$\nw_{i+1} = u_p - (i + 0.5)\n$$\nThe weight for the left cell center is complementary:\n$$\nw_{i} = 1 - w_{i+1}\n$$\nThe charge $q_p$ contributes to the line charge density $\\rho$ (in units of $\\,\\mathrm{C/m}$) at the corresponding cell centers $i$ and $i+1$ (with indices taken modulo $N$ for periodicity) as follows:\n$$\n\\delta \\rho_i = \\frac{q_p w_i}{\\Delta x}, \\quad \\delta \\rho_{i+1} = \\frac{q_p w_{i+1}}{\\Delta x}\n$$\nThe total charge density $\\rho_i$ is the sum of contributions from all particles. This procedure is performed for particle positions at time $t^n$ to get $\\rho_i^n$ and at $t^{n+1}$ to get $\\rho_i^{n+1}$.\n\n**Step 2: Esirkepov Current Calculation**\nThe Esirkepov current is defined as the current that exactly satisfies the discrete continuity equation for the given charge densities $\\rho_i^n$ and $\\rho_i^{n+1}$. Rearranging the continuity equation gives a recurrence relation for the current $J_i$:\n$$\nJ_{i+1} = J_i - \\frac{\\Delta x}{\\Delta t} (\\rho_i^{n+1} - \\rho_i^n)\n$$\nLet $\\Delta\\rho_i = \\rho_i^{n+1} - \\rho_i^n$. The relation is $J_{i+1} = J_i - \\frac{\\Delta x}{\\Delta t} \\Delta\\rho_i$. This can be solved by unrolling the recurrence:\n$$\nJ_i = J_0 - \\frac{\\Delta x}{\\Delta t} \\sum_{k=0}^{i-1} \\Delta\\rho_k\n$$\nThis defines the current up to a constant offset, $J_0$. For a periodic system with no net charge injection or external driving fields, the net current across the domain must be zero. We enforce this condition: $\\sum_{i=0}^{N-1} J_i = 0$.\n$$\n\\sum_{i=0}^{N-1} \\left( J_0 - \\frac{\\Delta x}{\\Delta t} \\sum_{k=0}^{i-1} \\Delta\\rho_k \\right) = N J_0 - \\frac{\\Delta x}{\\Delta t} \\sum_{i=0}^{N-1} \\sum_{k=0}^{i-1} \\Delta\\rho_k = 0\n$$\nFrom this, the constant offset $J_0$ can be determined, which uniquely defines the current array $J$. This method guarantees that the resulting current, when used with the original densities $\\rho^n$ and $\\rho^{n+1}$, yields a continuity residual of zero (to machine precision).\n\n**Step 3: Binomial Filtering**\nThe specified binomial filter uses the 1D convolution kernel $[1, 4], [2, 4], [1, 4]$, i.e., $[0.25, 0.5, 0.25]$. For a given 1D array $A_i$, the filtered array $A'_i$ is computed as:\n$$\nA'_i = \\frac{1}{4} A_{i-1} + \\frac{2}{4} A_i + \\frac{1}{4} A_{i+1}\n$$\nThe convolution is periodic, meaning indices are wrapped around the boundaries of the array (e.g., $A_{-1} = A_{N-1}$). This operation is applied for the specified number of passes (one in this problem) to the current $J_i$ and/or the densities $\\rho_i^n, \\rho_i^{n+1}$ as required by the test case.\n\n**Step 4: Residual Computation**\nThe discrete continuity residual is calculated for each cell $i$:\n$$\n\\varepsilon_i = \\frac{\\rho_i^{n+1} - \\rho_i^{n}}{\\Delta t} + \\frac{J_{i+1} - J_i}{\\Delta x}\n$$\nThe final charge densities and currents (after any filtering steps) are used in this formula. The term $\\frac{J_{i+1} - J_i}{\\Delta x}$ is the discrete divergence of the current. The final result for each test case is the maximum absolute value of this residual over all cells, $\\max_i |\\varepsilon_i|$.\n\n**Analysis of Test Cases:**\n- **Cases 1  4 (No Filtering):** Since the Esirkepov current is computed to exactly satisfy the continuity equation, the residual $\\varepsilon_i$ will be zero for all $i$. The reported value will be non-zero only due to floating-point arithmetic errors.\n- **Cases 2  5 (Filter Current Only):** The unfiltered densities $\\rho$ are used with the filtered current $J'$. The filtering operation modifies the current, so it no longer balances the charge density changes. This breaks the discrete charge conservation, resulting in a non-zero residual.\n- **Case 3 (Filter Both Consistently):** The filter is a linear operator. Applying it to the continuity equation gives:\n$$\nF\\left(\\frac{\\Delta\\rho_i}{\\Delta t} + \\frac{\\nabla \\cdot J_i}{\\Delta x}\\right) = \\frac{F(\\Delta\\rho_i)}{\\Delta t} + \\frac{F(\\nabla \\cdot J_i)}{\\Delta x} = F(0) = 0\n$$\nBecause convolution commutes with the finite difference operator (i.e., $F(\\nabla \\cdot J) = \\nabla \\cdot F(J)$), this becomes:\n$$\n\\frac{\\rho_i'^{n+1} - \\rho_i'^n}{\\Delta t} + \\frac{J'_{i+1} - J'_i}{\\Delta x} = 0\n$$\nwhere primed quantities are filtered. This means if we filter the densities and the current consistently, the continuity equation remains satisfied. The residual should be zero, up to machine precision.\n- **Case 6 (Zero Motion):** With no particle motion, $\\rho^n = \\rho^{n+1}$. This leads to $\\Delta\\rho_i = 0$ for all $i$, which in turn yields a zero Esirkepov current, $J_i = 0$. Filtering a zero current still results in a zero current. Thus, all terms in the residual equation are zero, and the result is zero.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases for the PIC continuity residual problem.\n    \"\"\"\n    #\n    # Global Parameters\n    #\n    N = 64  # Number of cells\n    dx = 1e-3  # Cell width in meters\n    dt = 1e-9  # Time step in seconds\n    e_charge = 1.602e-19  # Elementary charge in Coulombs\n    q_p = -e_charge  # Particle charge\n    L = N * dx # Domain length\n\n    #\n    # Helper Functions\n    #\n    def cic_deposit(positions, q, N_grid, dx_grid):\n        \"\"\"\n        Deposits particle charges onto a 1D grid using the Cloud-In-Cell (CIC) method.\n        Assumes cell-centered grid.\n        \n        Args:\n            positions (np.array): Particle positions.\n            q (float): Charge of each particle.\n            N_grid (int): Number of grid cells.\n            dx_grid (float): Grid cell width.\n        \n        Returns:\n            np.array: Line charge density (C/m) on the grid.\n        \"\"\"\n        rho = np.zeros(N_grid)\n        domain_length = N_grid * dx_grid\n        \n        for pos in positions:\n            # Ensure particle is within the periodic domain [0, L)\n            pos_wrapped = pos % domain_length\n\n            # Logical coordinate (normalized by cell width)\n            u_p = pos_wrapped / dx_grid\n            \n            # Index of the left-hand cell center and weights\n            i_left_center = np.floor(u_p - 0.5)\n            w_right = u_p - (i_left_center + 0.5)\n            w_left = 1.0 - w_right\n            \n            # Grid indices with periodic wrapping\n            idx0 = int(i_left_center) % N_grid\n            idx1 = (idx0 + 1) % N_grid\n            \n            # Deposit charge, converting point charge to line density\n            rho[idx0] += q * w_left / dx_grid\n            rho[idx1] += q * w_right / dx_grid\n            \n        return rho\n\n    def calculate_esirkepov_current(rho_n, rho_n_plus_1, N_grid, dx_grid, dt_step):\n        \"\"\"\n        Calculates the face-centered current that exactly satisfies the discrete\n        continuity equation for the given cell-centered charge densities.\n        \n        Args:\n            rho_n (np.array): Charge density at time t^n.\n            rho_n_plus_1 (np.array): Charge density at time t^{n+1}.\n            N_grid, dx_grid, dt_step: Grid and time parameters.\n\n        Returns:\n            np.array: Face-centered current (C/s or Amperes).\n        \"\"\"\n        # Change in charge density times volume element, divided by dt\n        delta = -(dx_grid / dt_step) * (rho_n_plus_1 - rho_n)\n        \n        # Recurrence relation: J_{i+1} = J_i + delta_i\n        # J_i = J_0 + sum_{k=0}^{i-1} delta_k\n        S = np.zeros_like(delta)\n        S[1:] = np.cumsum(delta[:-1])\n        \n        # Impose zero net current: sum(J_i) = 0 to find J_0\n        J0 = -np.mean(S)\n        \n        # Construct the full current array\n        J = J0 + S\n        return J\n\n    def apply_binomial_filter(A):\n        \"\"\"\n        Applies a single pass of the [1, 2, 1]/4 binomial filter with periodic\n        boundary conditions.\n        \n        Args:\n            A (np.array): The 1D array to filter.\n            \n        Returns:\n            np.array: The filtered array.\n        \"\"\"\n        return 0.25 * np.roll(A, 1) + 0.5 * A + 0.25 * np.roll(A, -1)\n\n    def calculate_residual(rho_n, rho_n_plus_1, J, N_grid, dx_grid, dt_step):\n        \"\"\"\n        Calculates the maximum absolute value of the continuity equation residual.\n        \"\"\"\n        d_rho_dt = (rho_n_plus_1 - rho_n) / dt_step\n        # Discrete divergence of J: (J_{i+1} - J_i) / dx\n        div_J = (np.roll(J, -1) - J) / dx_grid\n        \n        epsilon = d_rho_dt + div_J\n        return np.max(np.abs(epsilon))\n\n    #\n    # Test Cases Definition\n    #\n    test_cases_params = [\n        # Case 1: Happy path, no filtering\n        {\n            \"particles_n\": np.array([1.0e-2, 3.0e-2]),\n            \"particles_n1\": np.array([1.07e-2, 2.96e-2]),\n            \"num_particles\": 2, \"filter_rho\": False, \"filter_J\": False\n        },\n        # Case 2: Filter current only\n        {\n            \"particles_n\": np.array([1.0e-2, 3.0e-2]),\n            \"particles_n1\": np.array([1.07e-2, 2.96e-2]),\n            \"num_particles\": 2, \"filter_rho\": False, \"filter_J\": True\n        },\n        # Case 3: Filter both consistently\n        {\n            \"particles_n\": np.array([1.0e-2, 3.0e-2]),\n            \"particles_n1\": np.array([1.07e-2, 2.96e-2]),\n            \"num_particles\": 2, \"filter_rho\": True, \"filter_J\": True\n        },\n        # Case 4: Periodic crossing, no filtering\n        {\n            \"particles_n\": np.array([6.35e-2, 1.0e-3]),\n            \"particles_n1\": np.array([3.0e-4, 2.7e-3]),\n            \"num_particles\": 2, \"filter_rho\": False, \"filter_J\": False\n        },\n        # Case 5: Periodic crossing, filter current only\n        {\n            \"particles_n\": np.array([6.35e-2, 1.0e-3]),\n            \"particles_n1\": np.array([3.0e-4, 2.7e-3]),\n            \"num_particles\": 2, \"filter_rho\": False, \"filter_J\": True\n        },\n        # Case 6: Zero motion, filter current only\n        {\n            \"particles_n\": np.array([2.0e-2]),\n            \"particles_n1\": np.array([2.0e-2]),\n            \"num_particles\": 1, \"filter_rho\": False, \"filter_J\": True\n        },\n    ]\n\n    results = []\n\n    #\n    # Main Loop\n    #\n    for params in test_cases_params:\n        # 1. Charge Deposition\n        rho_n = cic_deposit(params[\"particles_n\"], q_p, N, dx)\n        rho_n1 = cic_deposit(params[\"particles_n1\"], q_p, N, dx)\n    \n        # 2. Consistent Filtering of Rho (if applicable)\n        if params[\"filter_rho\"]:\n            rho_n_final = apply_binomial_filter(rho_n)\n            rho_n1_final = apply_binomial_filter(rho_n1)\n        else:\n            rho_n_final = rho_n\n            rho_n1_final = rho_n1\n\n        # 3. Calculate Esirkepov Current\n        # Note: current is calculated from densities *after* rho-filtering\n        J = calculate_esirkepov_current(rho_n_final, rho_n1_final, N, dx, dt)\n\n        # 4. Filter Current (if applicable)\n        if params[\"filter_J\"]:\n            J_final = apply_binomial_filter(J)\n        else:\n            J_final = J\n        \n        # 5. Calculate Residual\n        # Note: The residual must be calculated with the same densities used to generate the\n        # base current, even if the current itself is later filtered.\n        # This is because filtering J alone breaks conservation relative to the original rho.\n        # If rho is also filtered (Case 3), the residual is calculated with filtered versions of both.\n        max_residual = calculate_residual(rho_n_final, rho_n1_final, J_final, N, dx, dt)\n        results.append(max_residual)\n\n    #\n    # Final Output\n    #\n    print(f\"[{','.join(f'{r:.6e}' for r in results)}]\")\n\nsolve()\n\n```"
        }
    ]
}