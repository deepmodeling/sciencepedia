{
    "hands_on_practices": [
        {
            "introduction": "The stability and confinement of a tokamak plasma are intrinsically linked to the topology of its nested magnetic flux surfaces. A key parameter describing this topology is the safety factor, $q$, which measures the pitch of the magnetic field lines. This exercise builds foundational skills by connecting the abstract vector calculus representation of the magnetic field, $\\boldsymbol{B}$, to the derivation of this critical and physically intuitive quantity, providing a direct link between mathematical formalism and plasma stability. ",
            "id": "3980015",
            "problem": "Consider an axisymmetric tokamak equilibrium with circular, concentric flux surfaces of minor radius $r$ and major radius $R_{0}$, described in cylindrical coordinates by $R(\\theta) = R_{0} + r \\cos\\theta$ and $Z(\\theta) = r \\sin\\theta$, where $\\theta$ is the poloidal angle and $\\zeta$ is the toroidal angle. Angles are to be treated in radians. Assume that the magnetic field $\\boldsymbol{B}$ is given in the standard axisymmetric form\n$$\n\\boldsymbol{B} = F(\\psi)\\,\\nabla \\zeta + \\nabla \\zeta \\times \\nabla \\psi,\n$$\nwhere $F(\\psi)$ is the toroidal field function and $\\psi$ is the poloidal magnetic flux label that depends only on $r$, i.e., $\\psi = \\psi(r)$ with $\\frac{d\\psi}{dr} > 0$. In the orthogonal toroidal coordinate system $(r,\\theta,\\zeta)$, the scale factors satisfy $|\\nabla r| = 1$, $|\\nabla \\theta| = \\frac{1}{r}$, and $|\\nabla \\zeta| = \\frac{1}{R}$ with $R(\\theta) = R_{0} + r \\cos\\theta$, and the coordinate system is orthogonal so that $\\nabla \\theta \\cdot \\nabla \\zeta = 0$.\n\nStarting from first principles—namely, the definition of a magnetic field line as the integral curve of $\\boldsymbol{B}$ given by the differential relations $d\\boldsymbol{x} \\times \\boldsymbol{B} = \\boldsymbol{0}$ and the field-line pitch relation $\\frac{d\\zeta}{d\\theta} = \\frac{\\boldsymbol{B}\\cdot \\nabla \\zeta}{\\boldsymbol{B}\\cdot \\nabla \\theta}$—derive an explicit closed-form expression for the safety factor $q(\\psi)$ defined by\n$$\nq(\\psi) = \\frac{1}{2\\pi}\\oint_{0}^{2\\pi} \\frac{d\\zeta}{d\\theta}\\, d\\theta,\n$$\nwhere the integral is taken over a full poloidal circuit at fixed $\\psi$ and $\\theta$ runs from $0$ to $2\\pi$ in radians.\n\nExpress your final answer as a closed-form analytic expression in terms of $F(\\psi)$, $R_{0}$, $r$, and $\\frac{d\\psi}{dr}$ evaluated on the flux surface labeled by $\\psi$. You may treat $r$ as the minor radius corresponding to the flux surface $\\psi = \\psi(r)$, and you may use any standard identities of vector calculus and orthogonal coordinates that follow from the given geometry. No numerical approximation is required; provide the exact expression. Finally, explain the physical meaning of $q(\\psi)$ as the field line winding number in this axisymmetric equilibrium.\n\nYour final answer must be a single closed-form expression. No units should be included in the final boxed answer.",
            "solution": "The user wants me to solve a problem.\n\n**1. Problem Validation**\n\nI will begin by validating the problem statement as per the required protocol.\n\n**Step 1: Extract Givens**\n\n- **Geometry**: Axisymmetric tokamak equilibrium with circular, concentric flux surfaces. Minor radius is $r$, major radius is $R_{0}$.\n- **Coordinate Transformation**: In cylindrical coordinates $(R, Z, \\phi)$, with $\\phi=\\zeta$, the flux surface is parameterized by $R(\\theta) = R_{0} + r \\cos\\theta$ and $Z(\\theta) = r \\sin\\theta$. Here, $\\theta$ is the poloidal angle and $\\zeta$ is the toroidal angle.\n- **Magnetic Field**: $\\boldsymbol{B} = F(\\psi)\\,\\nabla \\zeta + \\nabla \\zeta \\times \\nabla \\psi$, where $F(\\psi)$ is the toroidal field function and $\\psi$ is the poloidal magnetic flux.\n- **Flux Surface Label**: $\\psi = \\psi(r)$ with the condition $\\frac{d\\psi}{dr} > 0$.\n- **Coordinate System**: Orthogonal toroidal coordinates $(r, \\theta, \\zeta)$.\n- **Scale Factors / Metric Information**: $|\\nabla r| = 1$, $|\\nabla \\theta| = \\frac{1}{r}$, and $|\\nabla \\zeta| = \\frac{1}{R}$ where $R = R_0 + r \\cos\\theta$.\n- **Orthogonality Condition**: $\\nabla \\theta \\cdot \\nabla \\zeta = 0$.\n- **Field Line Definition**: The trajectory $\\boldsymbol{x}(s)$ of a magnetic field line is the integral curve of $\\boldsymbol{B}$, satisfying $d\\boldsymbol{x} \\times \\boldsymbol{B} = \\boldsymbol{0}$.\n- **Field Line Pitch**: The pitch is given by the relation $\\frac{d\\zeta}{d\\theta} = \\frac{\\boldsymbol{B}\\cdot \\nabla \\zeta}{\\boldsymbol{B}\\cdot \\nabla \\theta}$.\n- **Safety Factor Definition**: $q(\\psi) = \\frac{1}{2\\pi}\\oint_{0}^{2\\pi} \\frac{d\\zeta}{d\\theta}\\, d\\theta$, with the integral taken along a field line over one full poloidal circuit (fixed $\\psi$, $\\theta$ from $0$ to $2\\pi$).\n- **Objective**: Derive a closed-form expression for $q(\\psi)$ in terms of $F(\\psi)$, $R_0$, $r$, and $\\frac{d\\psi}{dr}$.\n- **Secondary Objective**: Explain the physical meaning of $q(\\psi)$.\n\n**Step 2: Validate Using Extracted Givens**\n\n- **Scientifically Grounded**: The problem is a standard exercise in plasma physics and magnetohydrodynamics (MHD). The representation of the magnetic field, the coordinate system, and the definition of the safety factor are all fundamental concepts in the study of tokamak equilibria. The problem is scientifically sound.\n- **Well-Posed**: The problem is well-posed. It provides all necessary definitions and starting points to derive the requested quantity, $q(\\psi)$. The relationships between the geometric and magnetic quantities are clearly specified, allowing for a unique solution.\n- **Objective**: The problem is stated using precise mathematical and physical language, free from subjectivity or ambiguity. The given coordinate system, while an idealization of a real tokamak, is a standard and self-consistent model.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. It is a well-defined problem in the field of computational fusion science. I will now proceed with the derivation.\n\n**2. Derivation of the Safety Factor $q(\\psi)$**\n\nThe safety factor $q(\\psi)$ is defined as\n$$\nq(\\psi) = \\frac{1}{2\\pi}\\oint_{0}^{2\\pi} \\frac{d\\zeta}{d\\theta}\\, d\\theta\n$$\nwhere the field line pitch is given by\n$$\n\\frac{d\\zeta}{d\\theta} = \\frac{\\boldsymbol{B}\\cdot \\nabla \\zeta}{\\boldsymbol{B}\\cdot \\nabla \\theta}\n$$\nThe derivation proceeds by separately calculating the numerator and the denominator of the pitch expression.\n\nFirst, we calculate the numerator, $\\boldsymbol{B}\\cdot \\nabla \\zeta$. The magnetic field is given by $\\boldsymbol{B} = F(\\psi)\\,\\nabla \\zeta + \\nabla \\zeta \\times \\nabla \\psi$. Taking the dot product with $\\nabla \\zeta$:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\zeta = \\left(F(\\psi)\\,\\nabla \\zeta + \\nabla \\zeta \\times \\nabla \\psi\\right) \\cdot \\nabla \\zeta = F(\\psi) (\\nabla \\zeta \\cdot \\nabla \\zeta) + (\\nabla \\zeta \\times \\nabla \\psi) \\cdot \\nabla \\zeta\n$$\nThe second term, $(\\nabla \\zeta \\times \\nabla \\psi) \\cdot \\nabla \\zeta$, is a scalar triple product with a repeated vector, which is identically zero. The first term involves $\\nabla \\zeta \\cdot \\nabla \\zeta = |\\nabla \\zeta|^2$. From the problem statement, we have $|\\nabla \\zeta| = \\frac{1}{R}$. Therefore, the numerator is:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\zeta = F(\\psi) |\\nabla \\zeta|^2 = \\frac{F(\\psi)}{R^2}\n$$\n\nNext, we calculate the denominator, $\\boldsymbol{B}\\cdot \\nabla \\theta$. Taking the dot product of $\\boldsymbol{B}$ with $\\nabla \\theta$:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\theta = \\left(F(\\psi)\\,\\nabla \\zeta + \\nabla \\zeta \\times \\nabla \\psi\\right) \\cdot \\nabla \\theta = F(\\psi) (\\nabla \\zeta \\cdot \\nabla \\theta) + (\\nabla \\zeta \\times \\nabla \\psi) \\cdot \\nabla \\theta\n$$\nThe problem states that the coordinate system is orthogonal, so the gradients of the coordinate functions are orthogonal. Specifically, $\\nabla \\zeta \\cdot \\nabla \\theta = 0$. This eliminates the first term. The denominator is then:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\theta = (\\nabla \\zeta \\times \\nabla \\psi) \\cdot \\nabla \\theta\n$$\nUsing the cyclic property of the scalar triple product, $(\\boldsymbol{A} \\times \\boldsymbol{B}) \\cdot \\boldsymbol{C} = (\\boldsymbol{C} \\times \\boldsymbol{A}) \\cdot \\boldsymbol{B}$, we can write:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\theta = (\\nabla \\theta \\times \\nabla \\zeta) \\cdot \\nabla \\psi\n$$\nThe coordinate system $(r, \\theta, \\zeta)$ is orthogonal. Let the right-handed orthonormal basis be $(\\hat{\\boldsymbol{e}}_r, \\hat{\\boldsymbol{e}}_\\theta, \\hat{\\boldsymbol{e}}_\\zeta)$. The gradient vectors are related to this basis and the scale factors $h_r=1$, $h_\\theta=r$, $h_\\zeta=R$ by $\\nabla r = \\hat{\\boldsymbol{e}}_r/h_r = \\hat{\\boldsymbol{e}}_r$, $\\nabla \\theta = \\hat{\\boldsymbol{e}}_\\theta/h_\\theta = \\hat{\\boldsymbol{e}}_\\theta/r$, and $\\nabla \\zeta = \\hat{\\boldsymbol{e}}_\\zeta/h_\\zeta = \\hat{\\boldsymbol{e}}_\\zeta/R$.\nThe cross product is:\n$$\n\\nabla \\theta \\times \\nabla \\zeta = \\frac{\\hat{\\boldsymbol{e}}_\\theta}{r} \\times \\frac{\\hat{\\boldsymbol{e}}_\\zeta}{R} = \\frac{1}{rR} (\\hat{\\boldsymbol{e}}_\\theta \\times \\hat{\\boldsymbol{e}}_\\zeta) = \\frac{1}{rR} \\hat{\\boldsymbol{e}}_r\n$$\nThe flux function $\\psi$ depends only on $r$, so its gradient is $\\nabla \\psi = \\frac{d\\psi}{dr} \\nabla r = \\frac{d\\psi}{dr} \\hat{\\boldsymbol{e}}_r$.\nSubstituting these into the expression for $\\boldsymbol{B}\\cdot \\nabla \\theta$:\n$$\n\\boldsymbol{B}\\cdot \\nabla \\theta = \\left( \\frac{1}{rR} \\hat{\\boldsymbol{e}}_r \\right) \\cdot \\left( \\frac{d\\psi}{dr} \\hat{\\boldsymbol{e}}_r \\right) = \\frac{1}{rR} \\frac{d\\psi}{dr} (\\hat{\\boldsymbol{e}}_r \\cdot \\hat{\\boldsymbol{e}}_r) = \\frac{1}{rR} \\frac{d\\psi}{dr}\n$$\n\nNow we assemble the expression for the pitch, $\\frac{d\\zeta}{d\\theta}$:\n$$\n\\frac{d\\zeta}{d\\theta} = \\frac{\\boldsymbol{B}\\cdot \\nabla \\zeta}{\\boldsymbol{B}\\cdot \\nabla \\theta} = \\frac{F(\\psi)/R^2}{(1/rR) (d\\psi/dr)} = \\frac{F(\\psi)}{R^2} \\frac{rR}{d\\psi/dr} = \\frac{r F(\\psi)}{R(d\\psi/dr)}\n$$\nThe integral for $q(\\psi)$ is performed at a fixed flux surface, meaning $\\psi$ is constant, and therefore $r$ is also constant. Consequently, $F(\\psi)$, $r$, and $\\frac{d\\psi}{dr}$ are constants with respect to the integration over $\\theta$. We can take them outside the integral:\n$$\nq(\\psi) = \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\frac{r F(\\psi)}{R(\\theta)(d\\psi/dr)} d\\theta = \\frac{r F(\\psi)}{2\\pi (d\\psi/dr)} \\int_{0}^{2\\pi} \\frac{1}{R(\\theta)} d\\theta\n$$\nSubstituting $R(\\theta) = R_0 + r \\cos\\theta$:\n$$\nq(\\psi) = \\frac{r F(\\psi)}{2\\pi (d\\psi/dr)} \\int_{0}^{2\\pi} \\frac{1}{R_0 + r \\cos\\theta} d\\theta\n$$\nThis is a standard definite integral. For $a > |b|$, the integral evaluates to $\\int_{0}^{2\\pi} \\frac{d\\theta}{a+b\\cos\\theta} = \\frac{2\\pi}{\\sqrt{a^2 - b^2}}$. In our case, $a = R_0$ and $b = r$. For a physical tokamak, the major radius $R_0$ must be greater than the minor radius $r$, so the condition $R_0 > r$ is met.\n$$\n\\int_{0}^{2\\pi} \\frac{d\\theta}{R_0 + r \\cos\\theta} = \\frac{2\\pi}{\\sqrt{R_0^2 - r^2}}\n$$\nSubstituting this result back into the expression for $q(\\psi)$:\n$$\nq(\\psi) = \\frac{r F(\\psi)}{2\\pi (d\\psi/dr)} \\left( \\frac{2\\pi}{\\sqrt{R_0^2 - r^2}} \\right) = \\frac{r F(\\psi)}{(d\\psi/dr) \\sqrt{R_0^2 - r^2}}\n$$\nThis is the final closed-form expression for the safety factor.\n\n**3. Physical Meaning of $q(\\psi)$**\n\nThe safety factor $q(\\psi)$ represents the winding number of a magnetic field line on a specific magnetic flux surface, labeled by $\\psi$. By definition, $q(\\psi) = \\frac{1}{2\\pi} \\Delta\\zeta_{2\\pi}$, where $\\Delta\\zeta_{2\\pi}$ is the total change in the toroidal angle $\\zeta$ after one complete poloidal transit (where the poloidal angle $\\theta$ changes by $2\\pi$).\n\nIn simpler terms, $q(\\psi)$ is the number of times a magnetic field line wraps around the torus toroidally (the long way) for every one time it wraps around poloidally (the short way). For instance, a $q$-value of $3$ on a given flux surface means that a field line on that surface must travel around the torus $3$ times in the toroidal direction to complete a single poloidal circuit.\n\nThe value of $q$ is a crucial parameter for the stability of the plasma. If $q(\\psi)$ is a rational number, i.e., $q = m/n$ for integers $m$ and $n$, the magnetic field line is closed—it returns to its exact starting point after $n$ poloidal transits and $m$ toroidal transits. These \"rational surfaces\" are particularly susceptible to magnetohydrodynamic (MHD) instabilities, such as tearing modes, which can degrade plasma confinement. Therefore, the profile of $q$ across the plasma radius is carefully controlled in tokamak operations to avoid accessible, low-order rational surfaces.",
            "answer": "$$\n\\boxed{\\frac{r F(\\psi)}{\\frac{d\\psi}{dr} \\sqrt{R_{0}^{2} - r^{2}}}}\n$$"
        },
        {
            "introduction": "Modern gyrokinetic simulations achieve high efficiency by employing local, field-aligned coordinate systems, or \"flux tubes,\" that follow a small bundle of magnetic field lines. In these systems, the presence of magnetic shear introduces a non-trivial geometric feature where the perpendicular basis vectors twist as one moves along the field line. This practice reveals the core mathematical consequence of this geometry: the \"shearing\" of a perturbation's perpendicular wavevector, where the radial component $k_x$ becomes a linear function of the parallel coordinate $z$. ",
            "id": "3980025",
            "problem": "In a local flux-tube gyrokinetic model for a magnetized plasma, consider a sheared-slab, straight-field-line coordinate system with orthonormal coordinates $(x,y,z)$, where $x$ is the radial coordinate, $y$ is the binormal coordinate, and $z$ is the field-aligned (parallel) coordinate. Assume uniform magnetic shear $\\hat{s}$ and adopt a Clebsch-like field-line label defined by the well-tested sheared-slab approximation $\\alpha = y + \\hat{s} x z$, which is constant along a magnetic field line. Consider a scalar perturbation with perpendicular Fourier structure represented at each $z$ as $\\varphi(x,y,z) = \\tilde{\\varphi}(z)\\exp\\!\\big(i[k_x(z) x + k_y y]\\big)$, where $k_y$ is independent of $z$. Using only these foundations and the fact that constancy of $\\alpha$ along field lines constrains the perpendicular phase to be writable as $k_y \\alpha + k_{x0} x$ with $k_{x0}$ independent of $z$, derive the $z$-dependence of $k_x(z)$ and hence compute the net change in the radial wave number across a parallel domain of length $L_z$, defined by $\\Delta k_x \\equiv k_x(+L_z/2) - k_x(-L_z/2)$. Your final result must be a single closed-form expression in terms of $\\hat{s}$, $k_y$, and $L_z$. Also briefly explain the physical origin of this shift in terms of the definition of $\\alpha$ and the evolution of $k_x$ with $z$. No numerical evaluation is required, and no units are to be included in the final expression.",
            "solution": "The problem requires the derivation of the change in the radial wave number, $\\Delta k_x$, across a parallel domain of length $L_z$ in a sheared-slab magnetic field geometry. The derivation is founded on two equivalent representations for the perpendicular phase of a scalar perturbation.\n\nThe first representation of the phase is given by the argument of the exponential in the definition of the perturbation, $\\varphi(x,y,z) = \\tilde{\\varphi}(z)\\exp\\!\\big(i[k_x(z) x + k_y y]\\big)$. Let us denote this phase as $\\Phi_1$:\n$$ \\Phi_1(x, y, z) = k_x(z) x + k_y y $$\nHere, $k_y$ is constant, while the radial wave number $k_x$ is a function of the parallel coordinate $z$.\n\nThe second representation is based on the field-line label $\\alpha = y + \\hat{s} x z$, which is constant along a magnetic field line. The problem states that the perpendicular phase can also be written in the form:\n$$ \\Phi_2(x, y, z) = k_y \\alpha + k_{x0} x $$\nwhere $k_{x0}$ is a constant reference radial wave number, independent of $z$. This form is constructed such that the phase corotates with the magnetic field lines.\n\nTo find the $z$-dependence of $k_x(z)$, we equate these two physically equivalent expressions for the phase, $\\Phi_1 = \\Phi_2$:\n$$ k_x(z) x + k_y y = k_y \\alpha + k_{x0} x $$\nNow, we substitute the definition of the field-line label $\\alpha = y + \\hat{s} x z$ into the right-hand side of the equation:\n$$ k_x(z) x + k_y y = k_y (y + \\hat{s} x z) + k_{x0} x $$\nDistributing $k_y$ on the right-hand side yields:\n$$ k_x(z) x + k_y y = k_y y + k_y \\hat{s} x z + k_{x0} x $$\nThe term $k_y y$ appears on both sides and can be cancelled:\n$$ k_x(z) x = k_y \\hat{s} x z + k_{x0} x $$\nThis equality must hold for all values of the radial coordinate $x$. Therefore, we can divide the entire equation by $x$ (assuming $x \\neq 0$, which is valid as this is an identity for the functional form), which isolates the expression for $k_x(z)$:\n$$ k_x(z) = k_{x0} + k_y \\hat{s} z $$\nThis equation explicitly gives the linear dependence of the radial wave number $k_x$ on the parallel coordinate $z$. The rate of change of $k_x$ with respect to $z$ is $\\frac{d k_x}{dz} = k_y \\hat{s}$.\n\nThe problem asks for the net change in the radial wave number, $\\Delta k_x$, across a parallel domain of length $L_z$. The domain is centered at $z=0$ and extends from $z = -L_z/2$ to $z = +L_z/2$. This change is defined as:\n$$ \\Delta k_x \\equiv k_x\\left(+\\frac{L_z}{2}\\right) - k_x\\left(-\\frac{L_z}{2}\\right) $$\nWe use the derived expression for $k_x(z)$ to evaluate it at the two endpoints of the domain.\nAt $z = +L_z/2$:\n$$ k_x\\left(+\\frac{L_z}{2}\\right) = k_{x0} + k_y \\hat{s} \\left(\\frac{L_z}{2}\\right) $$\nAt $z = -L_z/2$:\n$$ k_x\\left(-\\frac{L_z}{2}\\right) = k_{x0} + k_y \\hat{s} \\left(-\\frac{L_z}{2}\\right) = k_{x0} - k_y \\hat{s} \\frac{L_z}{2} $$\nNow, we compute the difference:\n$$ \\Delta k_x = \\left( k_{x0} + k_y \\hat{s} \\frac{L_z}{2} \\right) - \\left( k_{x0} - k_y \\hat{s} \\frac{L_z}{2} \\right) $$\n$$ \\Delta k_x = k_{x0} + \\frac{1}{2} k_y \\hat{s} L_z - k_{x0} + \\frac{1}{2} k_y \\hat{s} L_z $$\nThe constant term $k_{x0}$ cancels, leaving:\n$$ \\Delta k_x = k_y \\hat{s} L_z $$\nThis is the final expression for the net change in the radial wave number.\n\nThe physical origin of this shift lies in the geometry of the sheared magnetic field. The field-line label $\\alpha = y + \\hat{s} x z$ being constant along a field line implies that the field lines are not parallel to the $z$-axis but are sheared. A projection of a magnetic field line onto the $(x, y)$ plane has a slope that depends on $z$: for a constant $\\alpha$, $d\\alpha = 0 = dy + \\hat{s}z dx$, giving a local slope of $dy/dx = -\\hat{s}z$. A perturbation that is \"flute-like\" (i.e., elongated along the magnetic field) must have its perpendicular structure twist to follow the sheared field lines. A Fourier mode with a fixed binormal wave number $k_y$ must therefore continuously adjust its radial wave number $k_x$ as it propagates along the parallel coordinate $z$. The expression $k_x(z) = k_{x0} + k_y \\hat{s} z$ mathematically describes this \"shearing\" of the wavevector $\\vec{k}_\\perp(z) = (k_x(z), k_y)$. The rate of this shearing is directly proportional to the magnetic shear $\\hat{s}$ and the binormal wave number $k_y$. Over a parallel distance $L_z$, this continuous shifting of $k_x$ accumulates to a total change of $\\Delta k_x = k_y \\hat{s} L_z$.",
            "answer": "$$\\boxed{k_y \\hat{s} L_z}$$"
        },
        {
            "introduction": "Translating the continuous equations of plasma physics into a discrete numerical algorithm requires careful treatment of the underlying geometry. The non-orthogonality inherent in sheared field-aligned coordinates introduces complexities into the form of differential operators, such as the perpendicular Laplacian, $\\nabla_{\\perp}^{2}$, which acquires a mixed partial derivative term. This computational exercise offers hands-on practice in correctly discretizing this operator and uses the Method of Manufactured Solutions to quantify the significant numerical errors introduced by naively neglecting this geometric effect. ",
            "id": "3980026",
            "problem": "Consider a local, straight-field-line approximation of field-aligned coordinates used in Gyrokinetic (GK) theory in a toroidal magnetic confinement device. Let the physical plane perpendicular to the magnetic field be Euclidean, with Cartesian coordinates given by $(x,y)$. Define curvilinear field-aligned perpendicular coordinates $(u,v)$ by the linear shear mapping $x = u$ and $y = v + \\sigma u$, where $\\sigma$ is a constant, dimensionless shear parameter that models non-orthogonality induced by magnetic shear and flux-tube tilt. Under this mapping, the line element in $(u,v)$ is $ds^2 = dx^2 + dy^2$, which yields a constant metric tensor $g_{ij}$ with components $g_{uu} = 1 + \\sigma^2$, $g_{uv} = g_{vu} = \\sigma$, and $g_{vv} = 1$. The determinant of the metric is $\\det(g) = 1$, and its inverse $g^{ij}$ has components $g^{uu} = 1$, $g^{uv} = g^{vu} = -\\sigma$, and $g^{vv} = 1 + \\sigma^2$.\n\nStart from the fundamental definition of the Laplace operator in general curvilinear coordinates on a Riemannian manifold, which in the present two-dimensional, constant-metric case reduces to the Helmholtz-type operator with constant coefficients,\n$$\n\\nabla_\\perp^2 f = \\partial_i \\left( g^{ij} \\partial_j f \\right),\n$$\nwhere indices $i,j \\in \\{u,v\\}$ and the Einstein summation convention is implied. Using this, derive the explicit continuous operator in $(u,v)$ and construct a second-order accurate, finite-difference stencil on a uniform, periodic grid that includes the mixed derivative due to non-orthogonality. Use central differences with periodic boundary conditions on the rectangular domain $u \\in [0, 2\\pi)$ and $v \\in [0, 2\\pi)$, with $N_u$ and $N_v$ grid points in $u$ and $v$, respectively. Denote the spacings by $h_u = 2\\pi/N_u$ and $h_v = 2\\pi/N_v$.\n\nTo quantify anisotropy and non-orthogonality errors, employ the Method of Manufactured Solutions. For integers $n$ and $m$, define the manufactured solution\n$$\nf(u,v) = \\sin(n u + m v),\n$$\nfor which the continuous operator acting on $f$ gives\n$$\n\\nabla_\\perp^2 f = -\\lambda f, \\quad \\lambda = n^2 - 2\\sigma n m + (1 + \\sigma^2) m^2.\n$$\nConstruct two discrete operators:\n- The \"mixed\" operator $\\mathcal{L}_{\\text{mixed}}$ that uses central differences for $\\partial_{uu} f$, $\\partial_{vv} f$, and $\\partial_{uv} f$, combined with the derived coefficients of the continuous operator.\n- The \"naive\" operator $\\mathcal{L}_{\\text{naive}}$ that neglects the mixed derivative term and uses only $\\partial_{uu} f$ and $\\partial_{vv} f$ with appropriate coefficients.\n\nFor each case, compute the relative root-mean-square error between the discrete operator and the exact continuous operator,\n$$\nE_{\\text{mixed}} = \\frac{\\left\\| \\mathcal{L}_{\\text{mixed}} f + \\lambda f \\right\\|_2}{\\left\\| \\lambda f \\right\\|_2}, \\quad\nE_{\\text{naive}} = \\frac{\\left\\| \\mathcal{L}_{\\text{naive}} f + \\lambda f \\right\\|_2}{\\left\\| \\lambda f \\right\\|_2},\n$$\nwhere $\\|\\cdot\\|_2$ denotes the discrete $\\ell_2$ norm over the grid. Define the anisotropy error increment attributable to neglecting non-orthogonality as\n$$\n\\Delta E = E_{\\text{naive}} - E_{\\text{mixed}}.\n$$\nUse periodic boundary conditions in both directions and central-difference stencils given by the well-tested formulas:\n$$\n\\partial_{uu} f\\big|_{i,j} \\approx \\frac{f_{i+1,j} - 2 f_{i,j} + f_{i-1,j}}{h_u^2}\n$$\n$$\n\\partial_{vv} f\\big|_{i,j} \\approx \\frac{f_{i,j+1} - 2 f_{i,j} + f_{i,j-1}}{h_v^2}\n$$\n$$\n\\partial_{uv} f\\big|_{i,j} \\approx \\frac{f_{i+1,j+1} - f_{i+1,j-1} - f_{i-1,j+1} + f_{i-1,j-1}}{4 h_u h_v}\n$$\nYour program must implement these stencils to compute $\\mathcal{L}_{\\text{mixed}}$ and $\\mathcal{L}_{\\text{naive}}$ and evaluate $\\Delta E$ for each test case below. All quantities are dimensionless.\n\nTest suite (each case specified by $(\\sigma, n, m, N_u, N_v)$):\n- Case $1$: $(0.0, 4, 3, 128, 128)$, an orthogonal baseline where mixed terms vanish, serving as a boundary condition check.\n- Case $2$: $(0.3, 8, 0, 128, 128)$, a wave aligned along $u$ with moderate shear.\n- Case $3$: $(0.3, 7, 7, 128, 128)$, equal wavenumbers along $u$ and $v$ under moderate shear.\n- Case $4$: $(0.7, 9, 4, 128, 256)$, stronger shear with anisotropic grid spacing $h_u \\neq h_v$.\n- Case $5$: $(1.2, 12, 5, 192, 96)$, high shear with opposite anisotropic grid.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[r_1,r_2,r_3,r_4,r_5]$), where each $r_k$ is the single precision or double precision floating-point value of $\\Delta E$ for the corresponding case $k$, computed to full machine precision of the runtime environment.",
            "solution": "The problem requires the quantification of anisotropy error in a finite-difference discretization of the perpendicular Laplacian operator in a non-orthogonal, sheared coordinate system. The error, denoted $\\Delta E$, is defined as the difference in relative root-mean-square errors between a naive discretization that neglects the mixed-derivative term and a more complete discretization that includes it. The Method of Manufactured Solutions provides a framework for this verification exercise.\n\nFirst, we derive the explicit form of the continuous Laplacian operator, $\\nabla_\\perp^2 f$. The problem provides the fundamental definition in general curvilinear coordinates, $\\nabla_\\perp^2 f = \\partial_i (g^{ij} \\partial_j f)$, where summation over indices $i,j \\in \\{u,v\\}$ is implied. The components of the inverse metric tensor, $g^{ij}$, are given as constants: $g^{uu} = 1$, $g^{uv} = g^{vu} = -\\sigma$, and $g^{vv} = 1 + \\sigma^2$. Since the metric components are constant, the partial derivatives $\\partial_i$ can be moved past them:\n$$\n\\nabla_\\perp^2 f = g^{ij} \\partial_i \\partial_j f\n$$\nExpanding the sum and using the symmetry of second partial derivatives for a smooth function $f$ (i.e., $\\partial_u \\partial_v f = \\partial_v \\partial_u f$), we obtain:\n$$\n\\nabla_\\perp^2 f = g^{uu} \\frac{\\partial^2 f}{\\partial u^2} + (g^{uv} + g^{vu}) \\frac{\\partial^2 f}{\\partial u \\partial v} + g^{vv} \\frac{\\partial^2 f}{\\partial v^2}\n$$\n$$\n\\nabla_\\perp^2 f = g^{uu} \\partial_{uu} f + 2 g^{uv} \\partial_{uv} f + g^{vv} \\partial_{vv} f\n$$\nSubstituting the given values for the inverse metric components yields the explicit continuous operator:\n$$\n\\nabla_\\perp^2 f = (1) \\partial_{uu} f + 2(-\\sigma) \\partial_{uv} f + (1 + \\sigma^2) \\partial_{vv} f = \\partial_{uu} f - 2\\sigma \\partial_{uv} f + (1 + \\sigma^2) \\partial_{vv} f\n$$\nThis expression reveals that the non-orthogonality of the coordinate system, parameterized by the shear $\\sigma$, introduces a mixed partial derivative term $\\partial_{uv} f$.\n\nNext, we construct the discrete operators. The computational domain is a uniform grid with periodic boundary conditions. Let $f_{i,j} = f(u_i, v_j)$ be the function evaluated at grid point $(i,j)$. We use the provided second-order accurate central-difference stencils to approximate the partial derivatives. Let these discrete derivative operators be denoted $D_{uu}$, $D_{vv}$, and $D_{uv}$.\n\nThe \"mixed\" discrete operator, $\\mathcal{L}_{\\text{mixed}}$, is constructed by directly discretizing the full continuous operator:\n$$\n\\mathcal{L}_{\\text{mixed}} f_{i,j} = D_{uu}f_{i,j} - 2\\sigma D_{uv}f_{i,j} + (1 + \\sigma^2)D_{vv}f_{i,j}\n$$\nwhere\n$$\nD_{uu}f_{i,j} = \\frac{f_{i+1,j} - 2 f_{i,j} + f_{i-1,j}}{h_u^2}\n$$\n$$\nD_{vv}f_{i,j} = \\frac{f_{i,j+1} - 2 f_{i,j} + f_{i,j-1}}{h_v^2}\n$$\n$$\nD_{uv}f_{i,j} = \\frac{f_{i+1,j+1} - f_{i+1,j-1} - f_{i-1,j+1} + f_{i-1,j-1}}{4 h_u h_v}\n$$\n\nThe \"naive\" discrete operator, $\\mathcal{L}_{\\text{naive}}$, is defined as one that \"neglects the mixed derivative term and uses only $\\partial_{uu} f$ and $\\partial_{vv} f$ with appropriate coefficients.\" This corresponds to ignoring the $g^{uv}$ and $g^{vu}$ terms in the operator expansion. The appropriate coefficients for the remaining terms are the diagonal components of the inverse metric, $g^{uu}=1$ and $g^{vv}=1+\\sigma^2$. Thus, the naive operator is:\n$$\n\\mathcal{L}_{\\text{naive}} f_{i,j} = (1)D_{uu}f_{i,j} + (1 + \\sigma^2)D_{vv}f_{i,j}\n$$\n\nTo evaluate the accuracy of these discrete operators, we use the manufactured solution $f(u,v) = \\sin(n u + m v)$. As verified in the problem statement, the continuous operator acting on this function yields an eigenfunction relation $\\nabla_\\perp^2 f = -\\lambda f$, with the eigenvalue $\\lambda = n^2 - 2\\sigma n m + (1 + \\sigma^2) m^2$.\n\nThe error of a discrete operator $\\mathcal{L}$ is quantified by the relative root-mean-square norm of the residual, which is the difference between the action of the discrete operator on the grid function and the exact analytical result. The residual for an operator $\\mathcal{L}$ is $\\mathcal{L}f - \\nabla_\\perp^2 f = \\mathcal{L}f - (-\\lambda f) = \\mathcal{L}f + \\lambda f$. The relative errors are then:\n$$\nE_{\\text{mixed}} = \\frac{\\left\\| \\mathcal{L}_{\\text{mixed}} f + \\lambda f \\right\\|_2}{\\left\\| \\lambda f \\right\\|_2}, \\quad\nE_{\\text{naive}} = \\frac{\\left\\| \\mathcal{L}_{\\text{naive}} f + \\lambda f \\right\\|_2}{\\left\\| \\lambda f \\right\\|_2}\n$$\nwhere $\\|\\cdot\\|_2$ is the standard discrete $\\ell_2$ norm (Frobenius norm) over the entire grid. The final quantity to be computed is the anisotropy error increment, $\\Delta E = E_{\\text{naive}} - E_{\\text{mixed}}$.\n\nThe algorithm for each test case $(\\sigma, n, m, N_u, N_v)$ is as follows:\n1. Define grid parameters $h_u = 2\\pi/N_u$ and $h_v = 2\\pi/N_v$. Create the $2$D grid coordinates and evaluate the manufactured solution $f(u,v)$ at each grid point to obtain the grid function $f_{i,j}$.\n2. Calculate the analytical eigenvalue $\\lambda$.\n3. Compute the discrete partial derivatives $D_{uu}f$, $D_{vv}f$, and $D_{uv}f$ on the grid, using array operations that respect the periodic boundary conditions (e.g., `numpy.roll`).\n4. Assemble the discrete operators $\\mathcal{L}_{\\text{mixed}}f$ and $\\mathcal{L}_{\\text{naive}}f$ from the discrete derivatives.\n5. Compute the residuals $\\mathcal{L}_{\\text{mixed}}f + \\lambda f$ and $\\mathcal{L}_{\\text{naive}}f + \\lambda f$.\n6. Calculate the $\\ell_2$ norms of the residuals and the normalization term $\\|\\lambda f\\|_2$.\n7. Compute $E_{\\text{mixed}}$ and $E_{\\text{naive}}$.\n8. Calculate the final result $\\Delta E = E_{\\text{naive}} - E_{\\text{mixed}}$.\n\nFor Case $1$ ($\\sigma = 0.0$), the mixed derivative term in the continuous operator vanishes. Consequently, $\\mathcal{L}_{\\text{mixed}}$ and $\\mathcal{L}_{\\text{naive}}$ become identical, which implies $E_{\\text{mixed}} = E_{\\text{naive}}$ and $\\Delta E = 0.0$.\nFor Case $2$ ($m=0$), the manufactured solution $f(u,v) = \\sin(nu)$ depends only on $u$. The central-difference stencil for the mixed derivative, $D_{uv}$, will yield exactly zero when applied to such a function. Thus, the term $-2\\sigma D_{uv}f$ in $\\mathcal{L}_{\\text{mixed}}$ is zero, again making $\\mathcal{L}_{\\text{mixed}}$ identical to $\\mathcal{L}_{\\text{naive}}$ and resulting in $\\Delta E = 0.0$. These two cases serve as critical validation checks for the implementation.\nFor Cases $3$, $4$, and $5$, both $\\sigma \\neq 0$ and $m \\neq 0$, so we expect a non-zero, positive $\\Delta E$ that quantifies the error introduced by neglecting the non-orthogonal mixed-derivative term.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the anisotropy error increment for a finite-difference Laplacian\n    in sheared coordinates for a series of test cases.\n    \"\"\"\n    # Test suite: (sigma, n, m, Nu, Nv)\n    test_cases = [\n        (0.0, 4, 3, 128, 128),\n        (0.3, 8, 0, 128, 128),\n        (0.3, 7, 7, 128, 128),\n        (0.7, 9, 4, 128, 256),\n        (1.2, 12, 5, 192, 96),\n    ]\n\n    results = []\n    for case in test_cases:\n        sigma, n, m, Nu, Nv = case\n        \n        # 1. Setup Grid and Parameters\n        hu = 2.0 * np.pi / Nu\n        hv = 2.0 * np.pi / Nv\n        \n        u_vec = np.linspace(0.0, 2.0 * np.pi, Nu, endpoint=False)\n        v_vec = np.linspace(0.0, 2.0 * np.pi, Nv, endpoint=False)\n        \n        # U varies along axis 1 (columns), V varies along axis 0 (rows)\n        U, V = np.meshgrid(u_vec, v_vec)\n\n        # 2. Manufactured Solution and Analytical Result\n        # The manufactured solution grid function\n        F = np.sin(n * U + m * V)\n        \n        # The analytical eigenvalue of the continuous operator\n        lambda_val = n**2 - 2*sigma*n*m + (1 + sigma**2)*m**2\n        \n        # Analytical result of the operator acting on the function, used for normalization\n        analytical_op_F = -lambda_val * F\n        \n        # The norm of lambda*f, which is the denominator for relative error.\n        # Note that norm(-lambda*f) = norm(lambda*f).\n        norm_denom = np.linalg.norm(analytical_op_F)\n\n        # Handle cases where the denominator is zero, to prevent division by zero.\n        # This occurs if lambda=0 or f=0 everywhere. For the given test cases,\n        # lambda is non-zero. If the error numerator is also zero, the relative error is 0.\n        if norm_denom == 0.0:\n            results.append(0.0)\n            continue\n\n        # 3. Finite Difference Operators using periodic shifts (np.roll)\n        # D_uu: Second derivative with respect to u (axis 1)\n        F_up1 = np.roll(F, -1, axis=1)\n        F_um1 = np.roll(F, 1, axis=1)\n        Duu_F = (F_up1 - 2*F + F_um1) / (hu**2)\n\n        # D_vv: Second derivative with respect to v (axis 0)\n        F_vp1 = np.roll(F, -1, axis=0)\n        F_vm1 = np.roll(F, 1, axis=0)\n        Dvv_F = (F_vp1 - 2*F + F_vm1) / (hv**2)\n\n        # D_uv: Mixed derivative\n        F_up1_vp1 = np.roll(F_up1, -1, axis=0)\n        F_up1_vm1 = np.roll(F_up1, 1, axis=0)\n        F_um1_vp1 = np.roll(F_um1, -1, axis=0)\n        F_um1_vm1 = np.roll(F_um1, 1, axis=0)\n        Duv_F = (F_up1_vp1 - F_up1_vm1 - F_um1_vp1 + F_um1_vm1) / (4.0 * hu * hv)\n\n        # 4. Construct Discrete Laplacians\n        # Operator with mixed derivative term\n        L_mixed_F = Duu_F - 2.0*sigma*Duv_F + (1.0 + sigma**2)*Dvv_F\n        \n        # Naive operator neglecting the mixed derivative term\n        L_naive_F = Duu_F + (1.0 + sigma**2)*Dvv_F\n        \n        # 5. Calculate Errors\n        # The residual is the difference between the numerical operator and the analytical operator's result.\n        # residual = L_discrete(f) - nabla^2(f) = L_discrete(f) - (-lambda*f) = L_discrete(f) + lambda*f\n        residual_mixed = L_mixed_F + lambda_val * F\n        residual_naive = L_naive_F + lambda_val * F\n        \n        E_mixed = np.linalg.norm(residual_mixed) / norm_denom\n        E_naive = np.linalg.norm(residual_naive) / norm_denom\n        \n        # 6. Final Result for the case\n        delta_E = E_naive - E_mixed\n        results.append(delta_E)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.16f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}