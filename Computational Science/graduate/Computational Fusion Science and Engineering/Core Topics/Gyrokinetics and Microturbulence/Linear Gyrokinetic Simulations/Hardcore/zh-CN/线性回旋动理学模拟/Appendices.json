{
    "hands_on_practices": [
        {
            "introduction": "线性回旋动理学模拟的核心是求解沿磁力线运动的粒子，这一过程的准确性严重依赖于用于逼近并行流算子的数值方案。本练习通过分析不同离散化方案引入的数值色散，探讨了这一基本问题。理解和量化这种数值误差对于保证模拟结果的物理真实性至关重要。",
            "id": "4002409",
            "problem": "你需要通过将周期性网格上获得的离散特征值与解析连续关系进行比较，来评估线性回旋动理学漂移算子中平行平面波的数值色散。从沿磁力线的漂移动理学或回旋动理学方程中的线性漂移项开始，该项可写作 $\\partial_t g + v_{\\parallel} \\partial_l g = 0$，其中 $g$ 是一个标量场，$l$ 是沿磁力线的坐标，$v_{\\parallel}$ 是一个恒定的平行速度。对于平面波拟设 $g \\propto \\exp(i k_{\\parallel} l - i \\omega t)$，其解析色散关系为 $\\omega = k_{\\parallel} v_{\\parallel}$。在一个长度为 $L$、包含 $N$ 个点、间距为 $\\Delta = L/N$ 的均匀周期性空间网格上，空间导数通过一个依赖于所选格式的线性算子进行离散化。离散漂移算子是矩阵 $L_d = - v_{\\parallel} D$，其中 $D$ 是与所选格式和周期性边界相关的离散导数算子。由于 $D$ 是一个循环矩阵，其特征向量是离散傅里叶模式，其特征值可以用一个依赖于格式的修正波数来表示。然后，将 $L_d$ 的离散特征值与连续色散关系所蕴含的解析特征值进行比较。\n\n你的任务是：\n- 从基本原理出发，解释为什么对于连续漂移算子，色散关系是 $\\omega = k_{\\parallel} v_{\\parallel}$，以及为什么对于周期性均匀网格，离散导数算子是循环矩阵，且其特征向量是离散傅里叶模式。\n- 对于以下导数格式，通过在离散傅里叶模式上评估离散导数算子的特征值，构建漂移算子的离散特征值：\n  - 周期性网格上的二阶中心有限差分。\n  - 周期性网格上的四阶中心有限差分。\n  - 周期性网格上使用离散傅里叶变换（傅里叶配置）的光谱微分。\n- 对每种离散格式，从相应的离散漂移算子特征值定义数值频率 $\\omega_{\\text{num}}(k)$，并将其与解析频率 $\\omega_{\\text{exact}}(k) = v_{\\parallel} k$ 进行比较。将每个模式的相对色散误差定义为 $E(k) = |\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)| / |\\omega_{\\text{exact}}(k)|$。\n- 在一个有 $N$ 个点的网格上，离散傅里叶波数为 $k_m = 2\\pi m / L$，其中 $m \\in \\{0,1,\\dots,N-1\\}$，并使用标准离散傅里叶变换的排序方式映射为有符号整数。离散模式包括 $k=0$ 模式，以及当 $N$ 为偶数时，一个满足 $|k| \\Delta = \\pi$ 的奈奎斯特模式。为了计算相对误差，请排除 $k=0$ 模式（在相对误差中会导致除零错误）和奈奎斯特模式（在此模式下，某些中心差分格式会产生零导数，而傅里叶配置存在歧义）。所有三角函数求值均使用弧度作为角度单位。\n- 对下面的每个测试用例，计算并报告在所包含的离散模式集合上的最大相对色散误差，即 $\\max_{k \\neq 0,\\, |k|\\Delta \\neq \\pi} E(k)$。\n\n为以下参数集的测试套件实现一个程序，执行这些计算：\n- 用例 A：格式为二阶中心差分，$N = 64$，$L = 2\\pi$，$v_{\\parallel} = 1.0$。\n- 用例 B：格式为四阶中心差分，$N = 64$，$L = 2\\pi$，$v_{\\parallel} = 1.0$。\n- 用例 C：格式为谱方法（离散傅里叶变换配置），$N = 64$，$L = 2\\pi$，$v_{\\parallel} = 1.0$。\n- 用例 D：格式为二阶中心差分，$N = 16$，$L = 2\\pi$，$v_{\\parallel} = 3.0$。\n- 用例 E：格式为四阶中心差分，$N = 32$，$L = 10.0$，$v_{\\parallel} = 0.7$。\n\n你的程序必须：\n- 对每个用例，在长度为 $L$、间距为 $\\Delta = L/N$ 的域上，使用标准的离散傅里叶变换排序方式构建离散傅里叶波数数组 $k$。\n- 对每种格式，在模式 $k$ 处评估离散导数算子的特征值，以获得该格式的修正波数，从而得到离散漂移算子的特征值。然后计算 $\\omega_{\\text{num}}(k)$ 和相对误差 $E(k)$。\n- 从误差集合中排除 $k=0$ 以及任何满足 $|k|\\Delta = \\pi$ 的模式。\n- 计算剩余模式上的最大 $E(k)$。\n- 生成单行输出，其中包含用逗号分隔并用方括号括起来的结果列表，顺序为 $\\left[\\text{用例 A}, \\text{用例 B}, \\text{用例 C}, \\text{用例 D}, \\text{用例 E}\\right]$。将每个结果表示为四舍五入到 $10$ 位小数的十进制数，不带单位。\n\n所有数值量和计算都应以纯数字形式进行，最终输出中不含物理单位。单行输出格式必须严格为：$[\\text{result\\_A},\\text{result\\_B},\\text{result\\_C},\\text{result\\_D},\\text{result\\_E}]$。",
            "solution": "该问题要求分析离散化线性漂移算子 $\\partial_t g + v_{\\parallel} \\partial_l g = 0$ 所引入的数值色散。我们必须首先验证问题陈述的有效性，如果有效，则为几种常见的数值格式提供数值色散关系的详细推导，然后通过计算实现来量化特定测试用例的色散误差。\n\n该问题在科学上是有效的、适定的和自洽的。它基于偏微分方程及其数值解的基本原理，这是计算科学的核心课题。所提供的数据和条件是完整和一致的，可以得出一个唯一且有意义的解。因此，我们可以进行推导和求解。\n\n**1. 解析色散关系**\n\n连续线性漂移方程由下式给出：\n$$\n\\frac{\\partial g}{\\partial t} + v_{\\parallel} \\frac{\\partial g}{\\partial l} = 0\n$$\n其中 $g(l, t)$ 是一个标量场，$l$ 是沿磁力线的空间坐标，$t$ 是时间，$v_{\\parallel}$ 是一个恒定速度。\n\n为求出色散关系，我们假设一个形式如下的平面波解（拟设）：\n$$\ng(l, t) = g_0 \\exp(i(k_{\\parallel} l - \\omega t))\n$$\n其中 $g_0$ 是一个恒定的振幅，$k_{\\parallel}$ 是平行波数，$\\omega$ 是角频率。我们计算此拟设的偏导数：\n$$\n\\frac{\\partial g}{\\partial t} = -i\\omega \\, g_0 \\exp(i(k_{\\parallel} l - \\omega t)) = -i\\omega g\n$$\n$$\n\\frac{\\partial g}{\\partial l} = i k_{\\parallel} \\, g_0 \\exp(i(k_{\\parallel} l - \\omega t)) = i k_{\\parallel} g\n$$\n将这些表达式代入漂移方程得到：\n$$\n-i\\omega g + v_{\\parallel} (i k_{\\parallel} g) = 0\n$$\n$$\ni(k_{\\parallel} v_{\\parallel} - \\omega) g = 0\n$$\n对于非平凡解（$g \\neq 0$），括号中的项必须为零。这给出了解析色散关系：\n$$\n\\omega = k_{\\parallel} v_{\\parallel}\n$$\n这个关系，记为 $\\omega_{\\text{exact}}(k) = v_{\\parallel} k$（为简单起见，省略了下标 $\\parallel$），表明在连续系统中，所有波模式都以相同的相速度 $v_{\\phi} = \\omega/k = v_{\\parallel}$ 传播而不会失真。这是一个非色散系统。\n\n**2. 周期性网格上的离散化与循环矩阵**\n\n当长度为 $L$ 的空间域被离散化为 $N$ 个网格点 $l_j = j \\Delta$（其中 $j \\in \\{0, 1, \\ldots, N-1\\}$ 且 $\\Delta = L/N$ 是网格间距）时，空间导数算子 $\\partial_l$ 被一个离散矩阵算子 $D$ 所取代。由于周期性边界条件，应用于网格点 $j$ 并使用点 $j \\pm p$ 的中心有限差分格式将索引视为模 $N$。例如，二阶中心差分的格式为 $(Dg)_j = (g_{j+1} - g_{j-1})/(2\\Delta)$。对于每个网格点 $j$，该格式都是相同的，只是进行了平移。这个属性意味着得到的 $N \\times N$ 矩阵 $D$ 是一个循环矩阵。如果一个矩阵 $C$ 的元素满足 $C_{ij} = c_{(j-i) \\pmod N}$，即每一行都是前一行的循环移位，那么这个矩阵就是循环矩阵。\n\n线性代数的一个基本定理指出，所有 $N \\times N$ 的循环矩阵都共享同一组特征向量：离散傅里叶模式。一个离散傅里叶模式 $u^{(m)}$ 是一个分量如下的向量：\n$$\nu_j^{(m)} = \\exp\\left(i \\frac{2\\pi m j}{N}\\right)\n$$\n其中 $j \\in \\{0, 1, \\ldots, N-1\\}$ 且模式数 $m \\in \\{0, 1, \\ldots, N-1\\}$。将第一行为 $(c_0, c_1, \\ldots, c_{N-1})$ 的循环矩阵 $C$ 应用于此特征向量，得到：\n$$\n(C u^{(m)})_j = \\sum_{p=0}^{N-1} C_{jp} u_p^{(m)} = \\sum_{p=0}^{N-1} c_{(p-j)\\pmod N} \\exp\\left(i \\frac{2\\pi m p}{N}\\right)\n$$\n通过将求和变量更改为 $q = (p-j) \\pmod N$，我们有 $p=(q+j)\\pmod N$：\n$$\n(C u^{(m)})_j = \\sum_{q=0}^{N-1} c_q \\exp\\left(i \\frac{2\\pi m (q+j)}{N}\\right) = \\exp\\left(i \\frac{2\\pi m j}{N}\\right) \\sum_{q=0}^{N-1} c_q \\exp\\left(i \\frac{2\\pi m q}{N}\\right) = \\lambda_m u_j^{(m)}\n$$\n特征值 $\\lambda_m$ 是矩阵第一行 $(c_0, \\ldots, c_{N-1})$ 的离散傅里叶变换。\n\n**3. 数值格式的特征值分析**\n\n半离散化的漂移方程为 $\\frac{d\\mathbf{g}}{dt} = -v_{\\parallel} D \\mathbf{g}$，其中 $\\mathbf{g}$ 是网格点值的向量。对于对应于波数 $k_m = 2\\pi m/L$ 的一个本征模式 $u^{(m)}$，我们寻找形式为 $\\mathbf{g}(t) = u^{(m)} \\exp(-i\\omega_{\\text{num}} t)$ 的解。这导致 $-i\\omega_{\\text{num}} = -v_{\\parallel} \\lambda_D(k_m)$，其中 $\\lambda_D(k_m)$ 是离散导数算子 $D$ 对于模式 $k_m$ 的特征值。因此，数值色散关系为：\n$$\n\\omega_{\\text{num}}(k_m) = -i v_{\\parallel} \\lambda_D(k_m)\n$$\n我们通过将格式应用于平面波的网格表示 $g_j = \\exp(i k_m l_j) = \\exp(i k_m j \\Delta)$ 来为每种格式推导 $\\lambda_D(k_m)$。\n\n*   **二阶中心有限差分：**\n    格式为 $D g_j = \\frac{g_{j+1} - g_{j-1}}{2\\Delta}$。将其应用于 $g_j = \\exp(i k j \\Delta)$：\n    $$\n    D g_j = \\frac{\\exp(ik(j+1)\\Delta) - \\exp(ik(j-1)\\Delta)}{2\\Delta} = g_j \\frac{\\exp(ik\\Delta) - \\exp(-ik\\Delta)}{2\\Delta} = g_j \\frac{2i\\sin(k\\Delta)}{2\\Delta}\n    $$\n    特征值为 $\\lambda_D(k) = i \\frac{\\sin(k\\Delta)}{\\Delta}$。数值频率为：\n    $$\n    \\omega_{\\text{num}}(k) = v_{\\parallel} \\frac{\\sin(k\\Delta)}{\\Delta}\n    $$\n\n*   **四阶中心有限差分：**\n    格式为 $D g_j = \\frac{-g_{j+2} + 8g_{j+1} - 8g_{j-1} + g_{j-2}}{12\\Delta}$。将其应用于 $g_j = \\exp(i k j \\Delta)$：\n    $$\n    D g_j = g_j \\frac{-e^{i2k\\Delta} + 8e^{ik\\Delta} - 8e^{-ik\\Delta} + e^{-i2k\\Delta}}{12\\Delta} = g_j \\frac{-2i\\sin(2k\\Delta) + 16i\\sin(k\\Delta)}{12\\Delta}\n    $$\n    特征值为 $\\lambda_D(k) = i \\frac{8\\sin(k\\Delta) - \\sin(2k\\Delta)}{6\\Delta}$。数值频率为：\n    $$\n    \\omega_{\\text{num}}(k) = v_{\\parallel} \\frac{8\\sin(k\\Delta) - \\sin(2k\\Delta)}{6\\Delta}\n    $$\n\n*   **谱方法（傅里叶配置）：**\n    该方法基于在离散傅里叶模式基中表示函数 $g$。在此基中进行微分等效于将每个模式 $\\exp(ik_m l)$ 的系数乘以 $ik_m$。因此，理想谱微分算子在基模式上的作用是精确的。离散导数算子 $D$ 对于模式 $k_m$ 的特征值恰好是：\n    $$\n    \\lambda_D(k_m) = i k_m\n    $$\n    因此，数值频率为：\n    $$\n    \\omega_{\\text{num}}(k_m) = -i v_{\\parallel} (i k_m) = v_{\\parallel} k_m\n    $$\n    这与解析色散关系 $\\omega_{\\text{num}}(k) = \\omega_{\\text{exact}}(k)$ 完全相同。\n\n**4. 相对色散误差**\n\n对此问题，一个数值格式的质量由其数值频率 $\\omega_{\\text{num}}(k)$ 与精确频率 $\\omega_{\\text{exact}}(k) = v_{\\parallel} k$ 的匹配程度来衡量。每个模式的相对色散误差 $E(k)$ 定义为：\n$$\nE(k) = \\frac{|\\omega_{\\text{num}}(k) - \\omega_{\\text{exact}}(k)|}{|\\omega_{\\text{exact}}(k)|}\n$$\n此误差必须对网格上所有可表示的波数 $k$ 进行计算，但有两个指定的例外：\n1.  排除 $k=0$ 模式（零频率平均分量），因为它会在误差公式中导致除零错误。\n2.  排除奈奎斯特模式，对于偶数个网格点 $N$，该模式的波数 $|k|$ 满足 $|k|\\Delta=\\pi$。对于此模式，中心差分格式得出 $\\omega_{\\text{num}}=0$，而傅里叶方法在定义导数时存在歧义。\n\n我们的任务是计算在所包含的模式集合上的最大误差 $\\max_{k} E(k)$。对于谱方法，误差 $E(k)$ 对所有模式在解析上均为零，因此最大误差将为零（或在数值实现中为机器精度量级）。对于有限差分格式，误差非零，并随波数 $|k|$ 的大小而增加。最大误差将出现在奈奎斯特频率之前的最大波数处。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the maximum relative dispersion error for several numerical schemes\n    applied to the linear streaming equation.\n    \"\"\"\n    test_cases = [\n        {'scheme': '2-cen', 'N': 64, 'L': 2 * np.pi, 'v_parallel': 1.0},\n        {'scheme': '4-cen', 'N': 64, 'L': 2 * np.pi, 'v_parallel': 1.0},\n        {'scheme': 'spectral', 'N': 64, 'L': 2 * np.pi, 'v_parallel': 1.0},\n        {'scheme': '2-cen', 'N': 16, 'L': 2 * np.pi, 'v_parallel': 3.0},\n        {'scheme': '4-cen', 'N': 32, 'L': 10.0, 'v_parallel': 0.7},\n    ]\n\n    results = []\n    for case in test_cases:\n        N = case['N']\n        L = case['L']\n        v_parallel = case['v_parallel']\n        scheme = case['scheme']\n\n        # 1. Set up grid and wavenumbers\n        delta = L / N\n        # Wavenumbers k = 2 * pi * f, where f are the discrete frequencies\n        k = 2 * np.pi * np.fft.fftfreq(N, d=delta)\n\n        # 2. Calculate exact and numerical frequencies\n        w_exact = v_parallel * k\n        \n        k_delta = k * delta\n\n        if scheme == '2-cen':\n            # Second-order centered finite difference\n            # w_num = v_parallel * sin(k*delta) / delta\n            w_num = np.divide(v_parallel * np.sin(k_delta), delta, where=(k != 0), out=np.zeros_like(k))\n        \n        elif scheme == '4-cen':\n            # Fourth-order centered finite difference\n            # w_num = v_parallel * (8*sin(k*delta) - sin(2*k*delta)) / (6*delta)\n            numerator = v_parallel * (8 * np.sin(k_delta) - np.sin(2 * k_delta))\n            denominator = 6 * delta\n            w_num = np.divide(numerator, denominator, where=(k != 0), out=np.zeros_like(k))\n            \n        elif scheme == 'spectral':\n            # Spectral (Fourier collocation) method\n            # w_num = v_parallel * k\n            w_num = v_parallel * k\n        \n        else:\n            raise ValueError(f\"Unknown scheme: {scheme}\")\n\n        # 3. Define the mask to exclude k=0 and Nyquist mode\n        mask = np.ones(N, dtype=bool)\n        \n        # Exclude k=0 mode (DC component)\n        mask[0] = False\n        \n        # Exclude Nyquist mode if N is even. The Nyquist frequency\n        # corresponds to k where |k|*delta = pi. This is at index N//2 for even N.\n        if N % 2 == 0:\n            mask[N // 2] = False\n            \n        # 4. Calculate relative error on the masked modes\n        # We filter the arrays to avoid division by zero or any computation on excluded modes\n        w_exact_filtered = w_exact[mask]\n        w_num_filtered = w_num[mask]\n\n        # The problem is defined to exclude k=0, so w_exact_filtered will not contain zero.\n        rel_errors = np.abs(w_num_filtered - w_exact_filtered) / np.abs(w_exact_filtered)\n\n        # 5. Find the maximum relative error\n        max_error = 0.0\n        if rel_errors.size > 0:\n            max_error = np.max(rel_errors)\n        \n        results.append(max_error)\n\n    # Final print statement in the exact required format.\n    # Results are rounded to 10 decimal places.\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "复杂的等离子体不稳定性问题，有时可以简化为更直观的物理模型。本练习将一个回旋动理学问题简化为一个一维薛定谔型方程，通过求解其基态本征函数来确定不稳定性的空间（回旋角）结构。这个练习不仅连接了等离子体物理和量子力学中的相似概念，也提供了求解微分方程本征值问题的宝贵实践。",
            "id": "4002472",
            "problem": "要求您将磁化等离子体中微观不稳定性的线性回旋动理学（GK）描述与沿磁力线在一维气球模表示下的自伴随本征问题联系起来，然后计算可观测的模结构度量。从气球模表示中的静电涨落和准中性条件的线性 GK 方程出发，在标准漂移动理学和强气球模级数展开下，您应该论证静电势扰动 $\\delta\\phi(\\theta)$ 的沿场线结构满足一个关于无量纲气球模角 $\\theta$（单位为弧度）的二阶自伴随 Sturm–Liouville 型常微分本征值问题。结论是，在适当选择的归一化下，该控制方程为 Schrödinger 类型，\n$$\n-\\frac{d^2}{d\\theta^2}\\,\\delta\\phi(\\theta) + V(\\theta)\\,\\delta\\phi(\\theta) = \\lambda\\,\\delta\\phi(\\theta),\n$$\n其中 $V(\\theta)$ 是一个等效势，它包含了曲率驱动、磁剪切和有限拉莫尔半径效应，而 $\\lambda$ 是与此简化模型中涨落频率参数相关的实本征值。物理上的类束缚态模对应于当 $|\\theta|\\to\\infty$ 时 $\\delta\\phi(\\theta)\\to 0$ 的平方可积解。\n\n您的任务是实现一个数值求解器，用以在有限区间 $\\theta\\in[-\\theta_{\\max},\\theta_{\\max}]$ 上求解基态本征函数 $\\delta\\phi(\\theta)$。该求解器使用均匀网格和齐次 Dirichlet 边界条件 $\\delta\\phi(-\\theta_{\\max})=\\delta\\phi(\\theta_{\\max})=0$ 作为对无穷远处衰减的近似。对二阶导数算子使用二阶中心有限差分格式进行离散化。然后求解该本征问题以获得最小本征值及其本征函数。归一化离散本征函数，使得 $L^2$ 范数的离散近似等于 1：\n$$\n\\int_{-\\theta_{\\max}}^{\\theta_{\\max}} |\\delta\\phi(\\theta)|^2\\,d\\theta \\approx \\sum_{i} |\\delta\\phi_i|^2\\,\\Delta\\theta = 1,\n$$\n其中 $\\Delta\\theta$ 是网格间距，$\\delta\\phi_i=\\delta\\phi(\\theta_i)$ 是内部网格点上的值。\n\n对下面的每个测试用例，计算：\n- 模峰值位置 $\\theta_{\\text{peak}}$（单位为弧度），定义为 $|\\delta\\phi_i|$ 达到其最大值的网格点 $\\theta_i$。\n- 模宽度 $w$（单位为弧度），定义为与 $|\\delta\\phi(\\theta)|^2$ 成正比的概率密度的标准差：\n$$\n\\mu = \\frac{\\int \\theta\\,|\\delta\\phi(\\theta)|^2\\,d\\theta}{\\int |\\delta\\phi(\\theta)|^2\\,d\\theta},\\quad\nw = \\left(\\frac{\\int (\\theta-\\mu)^2\\,|\\delta\\phi(\\theta)|^2\\,d\\theta}{\\int |\\delta\\phi(\\theta)|^2\\,d\\theta}\\right)^{1/2}.\n$$\n在离散形式下，对内部点使用间距为 $\\Delta\\theta$ 的均匀网格上的黎曼和。报告 $\\theta_{\\text{peak}}$ 和 $w$ 的值，均以弧度为单位。\n\n为确保科学真实性和数学适定性，使用以下形式的约束势\n$$\nV(\\theta) = a_0 + a_2\\,\\theta^2 + a_4\\,\\theta^4 - V_g\\,\\exp\\!\\left(-\\frac{(\\theta-\\theta_c)^2}{2\\,\\sigma^2}\\right) + s\\,\\theta,\n$$\n其中 $a_4>0$ 确保当 $|\\theta|\\to\\infty$ 时 $V(\\theta)\\to+\\infty$。所有参数均为无量纲，$\\theta$ 是以弧度为单位的角度。\n\n实现一个程序，该程序针对每个测试用例，在内部网格上组装与算子 $-\\frac{d^2}{d\\theta^2}+V(\\theta)$ 的有限差分离散化对应的三对角矩阵，求解最小的本征对 $\\{\\lambda,\\delta\\phi\\}$，将 $\\delta\\phi$ 归一化为单位离散 $L^2$ 范数，并输出数对 $[w,\\theta_{\\text{peak}}]$。\n\n使用以下包含三个用例的测试套件，用以探究对称性、非对称性和近阈值展宽：\n\n- 用例 1（对称势阱，中度局域化）：\n  - 区域半宽 $\\theta_{\\max}=20$ （弧度），网格大小 $N=1201$ 个点，在 $[-\\theta_{\\max},\\theta_{\\max}]$ 上均匀分布。\n  - 参数： $a_0=0.2$, $a_2=0.01$, $a_4=10^{-4}$, $V_g=1.0$, $\\sigma=2.0$, $\\theta_c=0.0$, $s=0.0$。\n\n- 用例 2（非对称势阱，峰值偏移）：\n  - 区域半宽 $\\theta_{\\max}=20$ （弧度），网格大小 $N=1201$。\n  - 参数：$a_0=0.2$, $a_2=0.01$, $a_4=10^{-4}$, $V_g=1.0$, $\\sigma=2.0$, $\\theta_c=2.0$, $s=0.02$。\n\n- 用例 3（宽而浅的势阱）：\n  - 区域半宽 $\\theta_{\\max}=30$ （弧度），网格大小 $N=1501$。\n  - 参数：$a_0=0.1$, $a_2=0.002$, $a_4=5\\times10^{-5}$, $V_g=0.3$, $\\sigma=5.0$, $\\theta_c=0.0$, $s=0.0$。\n\n您的程序必须生成单行输出，其中包含三个用例的结果，形式为一个用方括号括起来的逗号分隔列表。每个用例的结果是一个双元素列表 $[w,\\theta_{\\text{peak}}]$，两个条目的单位均为弧度。例如，输出格式必须为\n\"[ [w_case1,theta_peak_case1], [w_case2,theta_peak_case2], [w_case3,theta_peak_case3] ]\"\n但没有空格，即：\n\"[[w1,tp1],[w2,tp2],[w3,tp3]]\"\n对所有报告的值使用浮点数。角度单位必须是弧度。不应打印任何其他文本。",
            "solution": "所提出的问题是一个有效且适定的边值问题，源于计算等离子体物理学，特别是在使用回旋动理学模型研究微观不稳定性方面。中心任务是求解一个一维、不含时的类 Schrödinger 方程，该方程描述了静电扰动在气球模表示中沿磁力线的结构。该方程为：\n$$\n-\\frac{d^2}{d\\theta^2}\\,\\delta\\phi(\\theta) + V(\\theta)\\,\\delta\\phi(\\theta) = \\lambda\\,\\delta\\phi(\\theta)\n$$\n这是一个典范的 Sturm-Liouville 本征值问题。在给定的边界条件下，算子 $\\mathcal{L} = -\\frac{d^2}{d\\theta^2} + V(\\theta)$ 在平方可积函数空间上是自伴随的。势 $V(\\theta)$ 的具体形式为：\n$$\nV(\\theta) = a_0 + a_2\\,\\theta^2 + a_4\\,\\theta^4 - V_g\\,\\exp\\!\\left(-\\frac{(\\theta-\\theta_c)^2}{2\\,\\sigma^2}\\right) + s\\,\\theta\n$$\n条件 $a_4>0$ 确保当 $|\\theta| \\to \\infty$ 时 $V(\\theta) \\to \\infty$，这保证了存在有下界的离散实本征值谱，以及与物理上相关的束缚态相对应的平方可积本征函数。该问题要求找到基态，即与最低本征值 $\\lambda$ 对应的本征函数 $\\delta\\phi(\\theta)$。无穷域 $\\theta \\in (-\\infty, \\infty)$ 被近似为有限域 $\\theta \\in [-\\theta_{\\max}, \\theta_{\\max}]$，并采用齐次 Dirichlet 边界条件 $\\delta\\phi(-\\theta_{\\max}) = \\delta\\phi(\\theta_{\\max}) = 0$。只要 $\\theta_{\\max}$ 足够大，这个近似对于低能、良局域化的态是有效的。\n\n求解过程首先通过使用二阶中心有限差分格式将连续微分方程离散化为矩阵本征值问题。在区域 $[-\\theta_{\\max}, \\theta_{\\max}]$ 上建立一个包含 $N$ 个点的均匀网格 $\\theta_j = -\\theta_{\\max} + j\\Delta\\theta$（$j=0, 1, \\dots, N-1$），其中网格间距为 $\\Delta\\theta = 2\\theta_{\\max}/(N-1)$。解在 $N_{int}=N-2$ 个内部网格点上求解，其索引为 $i=1, \\dots, N-2$。边界条件被施加为 $\\delta\\phi_0 = 0$ 和 $\\delta\\phi_{N-1} = 0$。\n\n在内部网格点 $\\theta_i$ 处，二阶导数近似为：\n$$\n\\frac{d^2\\delta\\phi}{d\\theta^2}\\bigg|_{\\theta_i} \\approx \\frac{\\delta\\phi_{i+1} - 2\\delta\\phi_i + \\delta\\phi_{i-1}}{(\\Delta\\theta)^2}\n$$\n将此近似代入 Schrödinger 方程，得到关于离散本征函数值向量 $\\vec{\\phi} = (\\delta\\phi_1, \\delta\\phi_2, \\dots, \\delta\\phi_{N-2})^T$ 的线性代数方程组：\n$$\n-\\frac{\\delta\\phi_{i+1} - 2\\delta\\phi_i + \\delta\\phi_{i-1}}{(\\Delta\\theta)^2} + V(\\theta_i)\\delta\\phi_i = \\lambda \\delta\\phi_i\n$$\n这可以写成矩阵本征值问题 $H\\vec{\\phi} = \\lambda\\vec{\\phi}$，其中 $H$ 是一个大小为 $(N-2) \\times (N-2)$ 的实对称三对角矩阵。$H$ 的元素为：\n$$\nH_{ij} = \\begin{cases}\n    \\frac{2}{(\\Delta\\theta)^2} + V(\\theta_i)  \\text{if } i=j \\\\\n    -\\frac{1}{(\\Delta\\theta)^2}  \\text{if } |i-j|=1 \\\\\n    0  \\text{otherwise}\n\\end{cases}\n$$\n这个矩阵本征值问题通过数值方法求解，以获得一组本征值和相应的本征向量。我们选择与最小本征值相关联的本征向量，它代表了基态。\n\n得到的本征向量（我们称之为 $\\vec{\\psi}$）通常被数值库归一化为单位欧几里得范数，即 $\\sum_i |\\psi_i|^2=1$。问题要求根据离散 $L^2$ 范数进行归一化：$\\int |\\delta\\phi|^2 d\\theta \\approx \\sum_i |\\delta\\phi_i|^2 \\Delta\\theta = 1$。为实现这一点，我们必须重新缩放本征向量。设正确归一化的本征函数为 $\\delta\\phi_i = C \\psi_i$。那么，\n$$\n\\sum_{i=1}^{N-2} |C \\psi_i|^2 \\Delta\\theta = C^2 \\Delta\\theta \\sum_{i=1}^{N-2} |\\psi_i|^2 = C^2 \\Delta\\theta \\cdot 1 = 1\n$$\n这意味着缩放因子是 $C = 1/\\sqrt{\\Delta\\theta}$。因此，归一化后的本征函数为 $\\delta\\phi_i = \\psi_i / \\sqrt{\\Delta\\theta}$。\n\n在内部网格上计算出归一化的基态本征函数 $\\delta\\phi_i$ 后，我们计算所需的可观测量。\n模峰值位置 $\\theta_{\\text{peak}}$ 是 $|\\delta\\phi_i|$ 取最大值时的网格点 $\\theta_i$。\n$$\n\\theta_{\\text{peak}} = \\theta_{i_{\\text{peak}}} \\quad \\text{where} \\quad i_{\\text{peak}} = \\underset{i \\in \\{1,\\dots,N-2\\}}{\\text{argmax}} |\\delta\\phi_i|\n$$\n模宽度 $w$ 是概率密度函数 $P(\\theta) \\propto |\\delta\\phi(\\theta)|^2$ 的标准差。在我们的归一化下，离散概率密度为 $p_i = |\\delta\\phi_i|^2 \\Delta\\theta$，且 $\\sum_i p_i = 1$。离散的均值 $\\mu$ 和宽度 $w$ 计算如下：\n$$\n\\mu = \\sum_{i=1}^{N-2} \\theta_i |\\delta\\phi_i|^2 \\Delta\\theta\n$$\n$$\nw = \\left( \\sum_{i=1}^{N-2} (\\theta_i - \\mu)^2 |\\delta\\phi_i|^2 \\Delta\\theta \\right)^{1/2}\n$$\n该实现将使用 `scipy.linalg.eigh_tridiagonal`，因为它在求解实对称三对角矩阵的特定本征值问题时效率很高。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import eigh_tridiagonal\n\ndef solve():\n    \"\"\"\n    Solves the 1D Schrödinger equation for three test cases from gyrokinetic theory\n    and computes mode structure metrics.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: symmetric well, moderate localization\n        {\n            \"theta_max\": 20.0, \"N\": 1201,\n            \"params\": {\"a0\": 0.2, \"a2\": 0.01, \"a4\": 1e-4, \"Vg\": 1.0, \"sigma\": 2.0, \"thetac\": 0.0, \"s\": 0.0}\n        },\n        # Case 2: asymmetric well, shifted peak\n        {\n            \"theta_max\": 20.0, \"N\": 1201,\n            \"params\": {\"a0\": 0.2, \"a2\": 0.01, \"a4\": 1e-4, \"Vg\": 1.0, \"sigma\": 2.0, \"thetac\": 2.0, \"s\": 0.02}\n        },\n        # Case 3: broad, shallow well\n        {\n            \"theta_max\": 30.0, \"N\": 1501,\n            \"params\": {\"a0\": 0.1, \"a2\": 0.002, \"a4\": 5e-5, \"Vg\": 0.3, \"sigma\": 5.0, \"thetac\": 0.0, \"s\": 0.0}\n        }\n    ]\n\n    results = []\n    \n    def potential_v(theta, p):\n        \"\"\"\n        Calculates the potential V(theta) for a given set of parameters.\n        \"\"\"\n        return p[\"a0\"] + p[\"a2\"] * theta**2 + p[\"a4\"] * theta**4 \\\n               - p[\"Vg\"] * np.exp(-(theta - p[\"thetac\"])**2 / (2 * p[\"sigma\"]**2)) \\\n               + p[\"s\"] * theta\n\n    for case in test_cases:\n        # Unpack case parameters\n        theta_max = case[\"theta_max\"]\n        N = case[\"N\"]\n        params = case[\"params\"]\n\n        # 1. Set up the grid\n        theta_full = np.linspace(-theta_max, theta_max, N)\n        delta_theta = theta_full[1] - theta_full[0]\n        \n        # We solve on the interior grid points\n        theta_interior = theta_full[1:-1]\n        N_interior = N - 2\n        \n        # 2. Construct the Hamiltonian matrix\n        V_values = potential_v(theta_interior, params)\n        \n        # Main diagonal of the Hamiltonian H\n        diag = 2.0 / (delta_theta**2) + V_values\n        \n        # Off-diagonal of H\n        off_diag = -1.0 / (delta_theta**2) * np.ones(N_interior - 1)\n        \n        # 3. Solve the eigenvalue problem\n        # eigh_tridiagonal returns eigenvalues in ascending order and corresponding eigenvectors\n        eigenvalues, eigenvectors = eigh_tridiagonal(diag, off_diag)\n        \n        # The ground state is the first eigenvector (corresponding to the smallest eigenvalue)\n        ground_state_psi = eigenvectors[:, 0]\n        \n        # 4. Normalize the eigenfunction\n        # The solver returns eigenvectors with L2 norm (sum of squares) = 1.\n        # We need to normalize to the continuous L2 norm integral approximation, sum(phi^2 * d_theta) = 1.\n        # phi = C * psi, sum((C*psi)^2 * d_theta) = 1 => C^2 * sum(psi^2) * d_theta = 1\n        # C^2 * 1 * d_theta = 1 => C = 1 / sqrt(d_theta)\n        normalization_factor = 1.0 / np.sqrt(delta_theta)\n        phi_norm = ground_state_psi * normalization_factor\n        \n        # Ensure the peak is positive for consistency (optional, as we use abs value)\n        if phi_norm[np.argmax(np.abs(phi_norm))]  0:\n            phi_norm *= -1.0\n\n        # 5. Compute observables\n        # Mode peak location\n        peak_index = np.argmax(np.abs(phi_norm))\n        theta_peak = theta_interior[peak_index]\n        \n        # Mode width (standard deviation)\n        prob_density = phi_norm**2\n        \n        # Mean (mu)\n        mu = np.sum(theta_interior * prob_density * delta_theta)\n        \n        # Variance (w^2)\n        variance = np.sum((theta_interior - mu)**2 * prob_density * delta_theta)\n        \n        # Width (w)\n        w = np.sqrt(variance)\n        \n        results.append([w, theta_peak])\n\n    # Final print statement in the exact required format.\n    # The str(results).replace(' ', '') trick produces the exact format.\n    print(str(results).replace(' ', ''))\n\nsolve()\n```"
        },
        {
            "introduction": "回旋动理学模拟的主要输出是扰动分布函数 $\\delta g$，它包含了丰富的动理学信息。为了将这些信息与实验可观测量联系起来，我们需要计算其速度空间矩，例如密度和电流扰动。本练习提供了一个从理论推导到数值实现的完整过程，教你如何从给定的 $\\delta g$ 中精确地提取宏观物理量。",
            "id": "4002473",
            "problem": "给定单个粒子种类非绝热回旋动理学微扰 $\\delta g(v_{\\parallel},\\mu)$ 的离散数组表示。在线性回旋动理学框架中，粒子种类 $s$ 的微扰密度 $\\delta n_s$ 和平行电流密度 $\\delta j_{\\parallel}$ 通过回旋中心相空间测度和回旋平均定义为\n$$\n\\delta n_s \\equiv \\int_{-\\infty}^{\\infty} d v_{\\parallel} \\int_{0}^{\\infty} d\\mu \\, \\frac{2\\pi B}{m_s} \\, J_0\\!\\left(k_{\\perp} \\rho_s(\\mu)\\right)\\, \\delta g(v_{\\parallel},\\mu),\n$$\n$$\n\\delta j_{\\parallel} \\equiv q_s \\int_{-\\infty}^{\\infty} d v_{\\parallel} \\int_{0}^{\\infty} d\\mu \\, \\frac{2\\pi B}{m_s} \\, v_{\\parallel}\\, J_0\\!\\left(k_{\\perp} \\rho_s(\\mu)\\right)\\, \\delta g(v_{\\parallel},\\mu),\n$$\n其中 $B$ 是背景磁场强度，$m_s$ 是粒子种类质量，$q_s$ 是粒子种类电荷，$k_{\\perp}$ 是垂直波数，$J_0$ 是零阶第一类贝塞尔函数，$\\rho_s(\\mu)$ 是拉莫尔半径，定义为\n$$\n\\rho_s(\\mu) \\equiv \\frac{v_{\\perp}}{\\Omega_s} = \\frac{\\sqrt{2 \\mu B / m_s}}{|q_s| B / m_s} = \\frac{\\sqrt{2 \\mu B m_s}}{|q_s| B},\n$$\n其中 $\\Omega_s$ 是回旋频率，$v_{\\perp}$ 是垂直速度。变量为 $v_{\\parallel}$（平行速度）和 $\\mu$（磁矩）。所有量均采用国际单位制 (SI)。\n\n从上述基本回旋动理学定义和标准回旋中心相空间测度出发，推导并实现一个数值求积方法，该方法使用 $v_{\\parallel}$ 和 $\\mu$ 的离散网格，并采用复合梯形法则来近似这两个积分。为了能够进行精度评估，考虑一个参数化的模型微扰\n$$\n\\delta g(v_{\\parallel},\\mu) = A_1 \\exp\\!\\left(-\\frac{v_{\\parallel}^2}{V^2}\\right)\\exp\\!\\left(-\\frac{\\mu}{\\mu_t}\\right) + A_2\\, v_{\\parallel}\\, \\exp\\!\\left(-\\frac{v_{\\parallel}^2}{V^2}\\right)\\exp\\!\\left(-\\frac{\\mu}{\\mu_t}\\right),\n$$\n其中 $A_1$ 和 $A_2$ 是常数振幅，$V$ 是特征平行速度，$\\mu_t$ 是特征磁矩尺度。为保证物理上的一致性，设 $V \\equiv \\sqrt{2 T_s/m_s}$ 和 $\\mu_t \\equiv T_s/B$，其中 $T_s$ 是以焦耳为单位的粒子种类温度。\n\n使用第一性原理，通过精确计算 $v_{\\parallel}$ 和 $\\mu$ 积分，得到 $\\delta n_s$ 和 $\\delta j_{\\parallel}$ 的闭式解析表达式。然后，实现一个程序，该程序：\n- 为 $v_{\\parallel} \\in [-L_v, L_v]$ 和 $\\mu \\in [0,L_{\\mu}]$ 构建均匀网格，其中 $L_v \\equiv 6 V$ 且 $L_{\\mu} \\equiv 10 \\mu_t$。\n- 使用二维复合梯形法则计算 $\\delta n_s$ 和 $\\delta j_{\\parallel}$ 的数值近似值。\n- 根据您推导的公式计算相应的解析值。\n- 报告 $\\delta n_s$ 和 $\\delta j_{\\parallel}$ 的相对误差，定义为 $|\\delta n_{\\text{num}} - \\delta n_{\\text{ana}}|/|\\delta n_{\\text{ana}}|$ 和 $|\\delta j_{\\text{num}} - \\delta j_{\\text{ana}}|/|\\delta j_{\\text{ana}}|$。\n\n将 $\\delta n_s$ 以 $\\text{m}^{-3}$ 为单位、$\\delta j_{\\parallel}$ 以 $\\text{A}\\,\\text{m}^{-2}$ 为单位表示，两者均为浮点数。此问题不涉及角度。贝塞尔函数的参数使用拉莫尔半径的模。\n\n测试套件：\n使用以下三组参数来评估您的实现。对于每组参数，按规定设置网格大小 $N_v$ 和 $N_{\\mu}$，并以 SI 单位定义所有物理量。\n\n- 情况 1（正常路径，离子种类）：\n  - 粒子种类质量 $m_s = 3.345 \\times 10^{-27}$，粒子种类电荷 $q_s = 1.602176634 \\times 10^{-19}$，磁场 $B = 3$，温度 $T_s = 3.204 \\times 10^{-16}$，垂直波数 $k_{\\perp} = 0.2$，振幅 $A_1 = 2.0 \\times 10^{-21}$，$A_2 = 5.0 \\times 10^{-28}$，网格大小 $N_v = 1201$，$N_{\\mu} = 1201$。\n- 情况 2（边界条件，电子种类，$k_{\\perp} = 0$）：\n  - 粒子种类质量 $m_s = 9.10938356 \\times 10^{-31}$，粒子种类电荷 $q_s = -1.602176634 \\times 10^{-19}$，磁场 $B = 2.5$，温度 $T_s = 1.602 \\times 10^{-16}$，垂直波数 $k_{\\perp} = 0$，振幅 $A_1 = 1.0 \\times 10^{-21}$，$A_2 = 3.0 \\times 10^{-28}$，网格大小 $N_v = 1001$，$N_{\\mu} = 1001$。\n- 情况 3（边缘情况，高 $k_{\\perp}$ 离子种类）：\n  - 粒子种类质量 $m_s = 3.345 \\times 10^{-27}$，粒子种类电荷 $q_s = 1.602176634 \\times 10^{-19}$，磁场 $B = 5$，温度 $T_s = 8.01 \\times 10^{-16}$，垂直波数 $k_{\\perp} = 40$，振幅 $A_1 = 1.0 \\times 10^{-21}$，$A_2 = 1.0 \\times 10^{-27}$，网格大小 $N_v = 801$，$N_{\\mu} = 801$。\n\n最终输出格式：\n您的程序应生成一行输出，其中包含三个情况的结果，形式为方括号内由逗号分隔的情况结果列表。每个情况结果本身必须是按顺序排列的四个浮点数列表 $\\left[\\delta n_s, \\delta j_{\\parallel}, \\text{rel\\_err\\_n}, \\text{rel\\_err\\_j}\\right]$。例如：\n$$\n[\\,[x_1,y_1,e_{n1},e_{j1}],\\,[x_2,y_2,e_{n2},e_{j2}],\\,[x_3,y_3,e_{n3},e_{j3}]\\,].\n$$",
            "solution": "该任务要求从非绝热分布 $\\delta g(v_{\\parallel},\\mu)$ 出发，利用回旋中心测度和回旋平均来计算微扰密度 $\\delta n_s$ 和平行电流密度 $\\delta j_{\\parallel}$。基础出发点是 $(v_{\\parallel},\\mu)$ 坐标系下回旋中心相空间测度的定义，即 $(2\\pi B/m_s)\\, d\\mu\\, d v_{\\parallel}$，以及通过对快回旋相位进行平均得到的线性回旋动理学回旋平均因子 $J_0(k_{\\perp}\\rho_s)$。拉莫尔半径定义为 $\\rho_s = v_{\\perp}/\\Omega_s$，其中 $v_{\\perp}^2 = 2\\mu B/m_s$ 且 $\\Omega_s = |q_s| B/m_s$，可得\n$$\n\\rho_s(\\mu) = \\frac{\\sqrt{2 \\mu B / m_s}}{|q_s| B/m_s} = \\frac{\\sqrt{2 \\mu B m_s}}{|q_s| B}.\n$$\n\n给定一个模型微扰\n$$\n\\delta g(v_{\\parallel},\\mu) = A_1 \\exp\\!\\left(-\\frac{v_{\\parallel}^2}{V^2}\\right)\\exp\\!\\left(-\\frac{\\mu}{\\mu_t}\\right) + A_2\\, v_{\\parallel}\\, \\exp\\!\\left(-\\frac{v_{\\parallel}^2}{V^2}\\right)\\exp\\!\\left(-\\frac{\\mu}{\\mu_t}\\right),\n$$\n其中 $V \\equiv \\sqrt{2 T_s/m_s}$ 且 $\\mu_t \\equiv T_s/B$。这一选择在物理上是合理的，因为它基于 $v_{\\parallel}$ 和 $\\mu$ 的麦克斯韦分解，其中平行速度分布是宽度为 $V$ 的高斯分布，而对 $\\mu$ 的依赖是尺度为 $T_s/B$ 的指数形式。\n\n解析计算通过分离 $v_{\\parallel}$ 和 $\\mu$ 的积分，并利用 $v_{\\parallel}$ 的奇偶性以及已知的高斯函数和贝塞尔函数的积分来进行。定义测度因子 $M \\equiv (2\\pi B/m_s)$ 和常数\n$$\nC \\equiv \\frac{\\sqrt{2 B m_s}}{|q_s| B} = \\frac{\\sqrt{2 m_s/B}}{|q_s|}.\n$$\n则 $J_0(k_{\\perp}\\rho_s(\\mu)) = J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right)$。\n\n首先，考虑微扰密度：\n$$\n\\delta n_s = M \\int_{-\\infty}^{\\infty} dv_{\\parallel}\\, \\int_{0}^{\\infty} d\\mu\\, J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right)\\, \\left[A_1 e^{-v_{\\parallel}^2/V^2} e^{-\\mu/\\mu_t} + A_2 v_{\\parallel} e^{-v_{\\parallel}^2/V^2} e^{-\\mu/\\mu_t}\\right].\n$$\n第二项关于 $v_{\\parallel}$ 是奇函数，在对称边界上的积分为零：\n$$\n\\int_{-\\infty}^{\\infty} v_{\\parallel} e^{-v_{\\parallel}^2/V^2} dv_{\\parallel} = 0.\n$$\n第一项可分解为：\n$$\n\\delta n_s = M A_1 \\left[\\int_{-\\infty}^{\\infty} e^{-v_{\\parallel}^2/V^2} dv_{\\parallel}\\right] \\left[\\int_{0}^{\\infty} e^{-\\mu/\\mu_t} J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right) d\\mu\\right].\n$$\n高斯积分为\n$$\n\\int_{-\\infty}^{\\infty} e^{-v_{\\parallel}^2/V^2} dv_{\\parallel} = V \\sqrt{\\pi}.\n$$\n对于 $\\mu$ 的积分，使用代换 $x = \\sqrt{\\mu}$，则 $\\mu = x^2$ 且 $d\\mu = 2x dx$，得到\n$$\n\\int_{0}^{\\infty} e^{-\\mu/\\mu_t} J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right) d\\mu = \\int_{0}^{\\infty} e^{-x^2/\\mu_t} J_0\\!\\left(k_{\\perp} C x\\right) 2x\\, dx.\n$$\n一个经过充分检验的贝塞尔加权高斯积分公式是\n$$\n\\int_{0}^{\\infty} x e^{-\\alpha x^2} J_0(\\beta x) dx = \\frac{1}{2\\alpha} \\exp\\!\\left(-\\frac{\\beta^2}{4\\alpha}\\right), \\quad \\alpha  0,\n$$\n令 $\\alpha = 1/\\mu_t$ 和 $\\beta = k_{\\perp} C$，可得\n$$\n\\int_{0}^{\\infty} e^{-x^2/\\mu_t} J_0\\!\\left(k_{\\perp} C x\\right) 2x\\, dx = \\frac{1}{\\alpha} \\exp\\!\\left(-\\frac{\\beta^2}{4\\alpha}\\right) = \\mu_t \\exp\\!\\left(-\\frac{(k_{\\perp} C)^2 \\mu_t}{4}\\right).\n$$\n因此，密度的解析表达式为\n$$\n\\delta n_s^{\\text{ana}} = M A_1\\, V \\sqrt{\\pi}\\, \\mu_t \\exp\\!\\left(-\\frac{(k_{\\perp} C)^2 \\mu_t}{4}\\right).\n$$\n\n接下来，考虑平行电流密度：\n$$\n\\delta j_{\\parallel} = q_s M \\int_{-\\infty}^{\\infty} dv_{\\parallel}\\, \\int_{0}^{\\infty} d\\mu\\, v_{\\parallel}\\, J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right)\\, \\left[A_1 e^{-v_{\\parallel}^2/V^2} e^{-\\mu/\\mu_t} + A_2 v_{\\parallel} e^{-v_{\\parallel}^2/V^2} e^{-\\mu/\\mu_t}\\right].\n$$\n由于奇偶性，$A_1$ 项的贡献为零：\n$$\n\\int_{-\\infty}^{\\infty} v_{\\parallel} e^{-v_{\\parallel}^2/V^2} dv_{\\parallel} = 0.\n$$\n$A_2$ 项给出\n$$\n\\delta j_{\\parallel} = q_s M A_2 \\left[\\int_{-\\infty}^{\\infty} v_{\\parallel}^2 e^{-v_{\\parallel}^2/V^2} dv_{\\parallel}\\right] \\left[\\int_{0}^{\\infty} e^{-\\mu/\\mu_t} J_0\\!\\left(k_{\\perp} C \\sqrt{\\mu}\\right) d\\mu\\right].\n$$\n高斯二阶矩为\n$$\n\\int_{-\\infty}^{\\infty} v_{\\parallel}^2 e^{-v_{\\parallel}^2/V^2} dv_{\\parallel} = V^3 \\frac{\\sqrt{\\pi}}{2}.\n$$\n$\\mu$ 的积分与之前相同。因此\n$$\n\\delta j_{\\parallel}^{\\text{ana}} = q_s M A_2\\, V^3 \\frac{\\sqrt{\\pi}}{2}\\, \\mu_t \\exp\\!\\left(-\\frac{(k_{\\perp} C)^2 \\mu_t}{4}\\right).\n$$\n\n数值算法设计：\n- 构建均匀网格，$v_{\\parallel}$ 跨越 $[-L_v,L_v]$，$\\mu$ 跨越 $[0,L_{\\mu}]$，其中 $L_v = 6 V$ 且 $L_{\\mu} = 10 \\mu_t$。这些区域捕获了高斯和指数因子的主要支撑域，因为 $e^{-36}$ 和 $e^{-10}$ 小到可以忽略不计，从而确保了较小的截断误差。\n- 在张量积网格上计算 $\\delta g$。回旋平均因子 $J_0(k_{\\perp} C \\sqrt{\\mu})$ 仅依赖于 $\\mu$，这可以通过沿 $v_{\\parallel}$ 维度广播来节省计算。\n- 计算 $\\delta n_s$ 和 $\\delta j_{\\parallel}$ 的被积函数，并通过连续的一维 $\\mu$ 和 $v_{\\parallel}$ 积分应用复合梯形法则。具体来说，先对 $v_{\\parallel}$ 积分得到一个关于 $\\mu$ 的函数，然后再对 $\\mu$ 积分。在适当的地方乘以测度因子 $M$ 和 $q_s$。\n- 使用推导出的闭式表达式计算解析值。最后，评估相对误差：\n$$\n\\text{rel\\_err\\_n} = \\frac{\\left|\\delta n_s^{\\text{num}} - \\delta n_s^{\\text{ana}}\\right|}{\\left|\\delta n_s^{\\text{ana}}\\right|}, \\quad \\text{rel\\_err\\_j} = \\frac{\\left|\\delta j_{\\parallel}^{\\text{num}} - \\delta j_{\\parallel}^{\\text{ana}}\\right|}{\\left|\\delta j_{\\parallel}^{\\text{ana}}\\right|}.\n$$\n\n数值精度原理：\n- 选择积分区域以使截断误差呈指数级小。\n- 梯形法则在光滑、快速衰减的被积函数上表现出关于网格间距的二阶收敛性。增加 $N_v$ 和 $N_{\\mu}$ 可控制离散化误差。\n- $k_{\\perp} = 0$ 的情况消除了贝塞尔因子，可作为边界检查。\n- 高 $k_{\\perp}$ 的情况通过 $\\exp\\!\\left(-\\frac{(k_{\\perp} C)^2 \\mu_t}{4}\\right)$ 因子产生强烈的回旋平均衰减，测试了对于振荡的贝塞尔输入的数值稳定性。\n- $\\delta j_{\\parallel}$ 的符号正确地跟随 $q_s$，测试了电荷符号处理。\n\n最终程序为指定的测试套件实现了这些步骤，生成一行输出，其中包含每个情况的 $\\delta n_s$（单位 $\\text{m}^{-3}$）、$\\delta j_{\\parallel}$（单位 $\\text{A}\\,\\text{m}^{-2}$）及其各自的相对误差（浮点数）。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import j0\n\ndef analytical_dn_dj(m_s, q_s, B, k_perp, T_s, A1, A2):\n    \"\"\"\n    Compute analytical delta n_s and delta j_parallel for the model delta g.\n    \"\"\"\n    # Characteristic parallel speed V and magnetic moment scale mu_t\n    V = np.sqrt(2.0 * T_s / m_s)\n    mu_t = T_s / B\n\n    # Measure factor\n    M = (2.0 * np.pi * B) / m_s\n\n    # C constant in rho_s(mu) = C * sqrt(mu)\n    C = np.sqrt(2.0 * B * m_s) / (abs(q_s) * B)  # equivalently sqrt(2*m_s/B)/|q_s|\n\n    # Common attenuation factor from the mu integral\n    atten = np.exp(- (k_perp**2) * (C**2) * mu_t / 4.0)\n\n    # Integrals in v\n    Iv0 = V * np.sqrt(np.pi)           # \\int e^{-v^2/V^2} dv\n    Iv2 = V**3 * np.sqrt(np.pi) / 2.0  # \\int v^2 e^{-v^2/V^2} dv\n\n    # Integral in mu\n    Im0 = mu_t * atten\n\n    # Analytical results\n    dn = M * A1 * Iv0 * Im0\n    dj = q_s * M * A2 * Iv2 * Im0\n\n    return dn, dj\n\ndef numerical_dn_dj(m_s, q_s, B, k_perp, T_s, A1, A2, Nv, Nmu):\n    \"\"\"\n    Compute numerical delta n_s and delta j_parallel using composite trapezoidal rule.\n    \"\"\"\n    # Characteristic parallel speed V and magnetic moment scale mu_t\n    V = np.sqrt(2.0 * T_s / m_s)\n    mu_t = T_s / B\n\n    # Integration domain limits\n    Lv = 6.0 * V\n    Lmu = 10.0 * mu_t\n\n    # Uniform grids\n    v_grid = np.linspace(-Lv, Lv, Nv)          # v_parallel\n    mu_grid = np.linspace(0.0, Lmu, Nmu)       # mu\n\n    # Broadcast to 2D grids: v on axis 0, mu on axis 1\n    v_mat = v_grid[:, None]                    # shape (Nv, 1)\n    mu_mat = mu_grid[None, :]                  # shape (1, Nmu)\n\n    # delta g(v, mu)\n    # exp(-v^2/V^2) * exp(-mu/mu_t) and with odd v term for A2 contribution\n    exp_v = np.exp(- (v_mat**2) / (V**2))\n    exp_mu = np.exp(- mu_mat / mu_t)\n    delta_g = A1 * exp_v * exp_mu + A2 * (v_mat) * exp_v * exp_mu  # shape (Nv, Nmu)\n\n    # Gyroaverage factor J0(k_perp * rho(mu)), rho(mu) = C * sqrt(mu)\n    C = np.sqrt(2.0 * B * m_s) / (abs(q_s) * B)\n    rho_arg = k_perp * C * np.sqrt(mu_grid)        # shape (Nmu,)\n    J0_mu = j0(rho_arg)[None, :]                    # broadcast to (1, Nmu)\n\n    # Measure factor\n    M = (2.0 * np.pi * B) / m_s\n\n    # Integrands\n    # For density: integrand_n = J0 * delta_g\n    integrand_n = J0_mu * delta_g                  # shape (Nv, Nmu)\n\n    # For current: integrand_j = v_parallel * J0 * delta_g\n    integrand_j = (v_mat) * J0_mu * delta_g        # shape (Nv, Nmu)\n\n    # Numerical integration via composite trapezoidal rule:\n    # First integrate over v (axis=0), then over mu (axis=1)\n    # Use numpy.trapz for accuracy and simplicity.\n    # Integrate over v:\n    integ_over_v_n = np.trapz(integrand_n, v_grid, axis=0)  # shape (Nmu,)\n    integ_over_v_j = np.trapz(integrand_j, v_grid, axis=0)  # shape (Nmu,)\n\n    # Integrate over mu:\n    num_n = M * np.trapz(integ_over_v_n, mu_grid)          # scalar\n    num_j = q_s * M * np.trapz(integ_over_v_j, mu_grid)    # scalar\n\n    return num_n, num_j\n\ndef format_case_result(values):\n    \"\"\"\n    Format a list of floats into a bracketed comma-separated string without spaces.\n    \"\"\"\n    return \"[\" + \",\".join(f\"{v:.12e}\" for v in values) + \"]\"\n\ndef solve():\n    # Physical constants for convenience (SI)\n    e_charge = 1.602176634e-19  # elementary charge (C)\n\n    # Define the test cases from the problem statement.\n    # Each case: (m_s, q_s, B, T_s, k_perp, A1, A2, N_v, N_mu)\n    test_cases = [\n        # Case 1: Ion species\n        (3.345e-27, +e_charge, 3.0, 3.204e-16, 0.2, 2.0e-21, 5.0e-28, 1201, 1201),\n        # Case 2: Electron species with k_perp = 0\n        (9.10938356e-31, -e_charge, 2.5, 1.602e-16, 0.0, 1.0e-21, 3.0e-28, 1001, 1001),\n        # Case 3: Ion species, high k_perp\n        (3.345e-27, +e_charge, 5.0, 8.01e-16, 40.0, 1.0e-21, 1.0e-27, 801, 801),\n    ]\n\n    results = []\n    for m_s, q_s, B, T_s, k_perp, A1, A2, Nv, Nmu in test_cases:\n        # Numerical computation\n        dn_num, dj_num = numerical_dn_dj(m_s, q_s, B, k_perp, T_s, A1, A2, Nv, Nmu)\n        # Analytical computation\n        dn_ana, dj_ana = analytical_dn_dj(m_s, q_s, B, k_perp, T_s, A1, A2)\n\n        # Relative errors (guard against zero analytical values)\n        rel_err_n = abs(dn_num - dn_ana) / (abs(dn_ana) if dn_ana != 0.0 else 1.0)\n        rel_err_j = abs(dj_num - dj_ana) / (abs(dj_ana) if dj_ana != 0.0 else 1.0)\n\n        results.append([dn_num, dj_num, rel_err_n, rel_err_j])\n\n    # Final print statement in the exact required format.\n    # Single line: [[dn1,dj1,errn1,errj1],[dn2,dj2,errn2,errj2],[dn3,dj3,errn3,errj3]]\n    formatted = \"[\" + \",\".join(format_case_result(r) for r in results) + \"]\"\n    print(formatted)\n\nsolve()\n```"
        }
    ]
}