{
    "hands_on_practices": [
        {
            "introduction": "在模拟由射频（RF）波驱动的复杂输运过程之前，我们首先必须确定能量从波传递到粒子的主要物理位置。本练习提供了一种在托卡马克中计算离子回旋共振层位置的具体方法，将基本的物理原理（回旋运动）与聚变实验中的关键参数联系起来。通过这个基础计算()，你将掌握确定射频加热效率和剖面控制中最重要的空间依赖性的方法。",
            "id": "4034062",
            "problem": "在磁化等离子体的射频 (RF) 驱动输运的准线性建模中，波与粒子之间的共振相互作用发生在粒子的回旋频率与外加射频角频率相匹配的位置。考虑一个大环径比托卡马克，其外侧中平面上的环向磁场由标准平衡标度关系 $B_{\\phi}(R) = B_{0}\\,R_{0}/R$ 给出，其中 $R$ 是大半径，$R_{0}$ 是磁轴的大半径，$B_{0}$ 是轴上环向磁场。假设为了确定回旋共振层的位置，可以忽略极向磁场，并且有限拉莫尔半径、相对论效应和多普勒频移效应也都可以忽略。\n\n从静磁场中带电粒子的洛伦兹力定律出发，推导电荷为 $Z_{m} e$、质量为 $m_{m}$ 的少子离子的回旋频率。然后，利用射频角频率等于局域回旋频率的基本离子回旋共振条件，确定共振层的大半径位置 $R_{\\text{res}}$，将其表示为 $Z_{m}$、$e$、$m_{m}$、$B_{0}$、$R_{0}$ 和射频角频率 $\\omega_{\\text{RF}}$ 的函数。\n\n最后，对于一个具有以下参数的离子回旋频率范围 (ICRF) 少子加热方案，数值计算 $R_{\\text{res}}$：\n- 磁轴大半径 $R_{0} = 3.0\\,\\text{m}$，\n- 轴上环向磁场 $B_{0} = 5.3\\,\\text{T}$，\n- 少子种类为氦-3，电荷态为 $Z_{m} = 2$，质量为 $m_{m} = 3\\,m_{p}$，\n- 质子质量 $m_{p} = 1.67262192369 \\times 10^{-27}\\,\\text{kg}$，\n- 元电荷 $e = 1.602176634 \\times 10^{-19}\\,\\text{C}$，\n- 射频频率 $f = 80.0\\,\\text{MHz}$，且 $\\omega_{\\text{RF}} = 2\\pi f$。\n\n将 $R_{\\text{res}}$ 的最终数值答案以米为单位表示，并四舍五入到四位有效数字。",
            "solution": "该问题被验证为具有科学依据、适定且客观。它展示了等离子体物理领域中关于托卡马克内离子回旋频率范围 (ICRF) 加热的一个标准计算。所提供的参数对于大型聚变实验而言是物理上现实的。\n\n第一步是推导静磁场中带电粒子的回旋频率 $\\omega_{c}$。一个电荷为 $q$、质量为 $m$ 的粒子在磁场 $\\vec{B}$ 中的运动由洛伦兹力定律 $\\vec{F} = q(\\vec{v} \\times \\vec{B})$ 决定。将其与牛顿力 $\\vec{F} = m\\vec{a}$ 相等，我们得到运动方程：\n$$m \\frac{d\\vec{v}}{dt} = q(\\vec{v} \\times \\vec{B})$$\n该方程描述了一个螺旋轨迹，其中粒子在垂直于磁场的平面内进行匀速圆周运动，并叠加了一个平行于磁场的恒定速度。磁场力为圆周运动提供了必要的向心力。对于垂直于磁场的速度分量 $v_{\\perp}$，力的大小为 $|F| = |q|v_{\\perp}B$。半径为 $r_{L}$（拉莫尔半径）的圆周运动的向心加速度为 $a_c = v_{\\perp}^{2}/r_{L}$。在垂直平面上应用牛顿第二定律：\n$$|q|v_{\\perp}B = m \\frac{v_{\\perp}^{2}}{r_{L}}$$\n这种回旋运动的角频率，即回旋频率 $\\omega_{c}$，定义为 $\\omega_{c} = v_{\\perp}/r_{L}$。从力平衡方程中，我们可以解出 $\\omega_{c}$：\n$$\\omega_{c} = \\frac{|q|B}{m}$$\n对于指定的少子离子种类，电荷为 $q = Z_{m}e$，质量为 $m = m_{m}$。由于 $Z_{m}$ 是电荷态数，而 $e$ 是元电荷，两者都定义为正值，所以我们有 $|q| = Z_{m}e$。托卡马克中的磁场主要是环向的，并随大半径 $R$ 变化，即 $B(R) = B_{\\phi}(R) = B_{0}R_{0}/R$。将这些代入回旋频率公式，得到作为大半径函数的局域回旋频率：\n$$\\omega_{c,m}(R) = \\frac{Z_{m}e B(R)}{m_{m}} = \\frac{Z_{m}e}{m_{m}} \\frac{B_{0}R_{0}}{R}$$\n第二步是找到基本回旋共振的位置 $R_{\\text{res}}$。当外加射频波的角频率 $\\omega_{\\text{RF}}$ 与离子种类的局域回旋频率 $\\omega_{c,m}(R)$ 相匹配时，就会发生这种共振。共振条件是：\n$$\\omega_{\\text{RF}} = \\omega_{c,m}(R_{\\text{res}})$$\n代入 $\\omega_{c,m}(R)$ 的表达式：\n$$\\omega_{\\text{RF}} = \\frac{Z_{m}e B_{0}R_{0}}{m_{m}R_{\\text{res}}}$$\n求解共振大半径 $R_{\\text{res}}$，我们得到符号表达式：\n$$R_{\\text{res}} = \\frac{Z_{m}e B_{0}R_{0}}{m_{m}\\omega_{\\text{RF}}}$$\n最后一步是使用提供的参数数值计算 $R_{\\text{res}}$：\n磁轴大半径: $R_{0} = 3.0\\,\\text{m}$\n轴上环向磁场: $B_{0} = 5.3\\,\\text{T}$\n少子种类电荷态: $Z_{m} = 2$\n少子种类质量: $m_{m} = 3\\,m_{p}$\n质子质量: $m_{p} = 1.67262192369 \\times 10^{-27}\\,\\text{kg}$\n元电荷: $e = 1.602176634 \\times 10^{-19}\\,\\text{C}$\n射频频率: $f = 80.0\\,\\text{MHz} = 80.0 \\times 10^{6}\\,\\text{Hz}$\n\n射频角频率为 $\\omega_{\\text{RF}} = 2\\pi f$。将其代入 $R_{\\text{res}}$ 的表达式：\n$$R_{\\text{res}} = \\frac{Z_{m}e B_{0}R_{0}}{m_{m}(2\\pi f)}$$\n现在我们代入数值：\n$$m_{m} = 3 \\times (1.67262192369 \\times 10^{-27}\\,\\text{kg}) = 5.01786577107 \\times 10^{-27}\\,\\text{kg}$$\n将所有值代入 $R_{\\text{res}}$ 的方程：\n$$R_{\\text{res}} = \\frac{(2)(1.602176634 \\times 10^{-19}\\,\\text{C})(5.3\\,\\text{T})(3.0\\,\\text{m})}{(3 \\times 1.67262192369 \\times 10^{-27}\\,\\text{kg})(2\\pi \\times 80.0 \\times 10^{6}\\,\\text{s}^{-1})}$$\n$$R_{\\text{res}} = \\frac{5.09483301764 \\times 10^{-18}\\,\\text{C}\\cdot\\text{T}\\cdot\\text{m}}{2.5222045500 \\times 10^{-18}\\,\\text{kg}\\cdot\\text{s}^{-1}}$$\n单位可以正确地简化为米，如量纲分析所示：\n$$ \\frac{\\text{C}\\cdot\\text{T}\\cdot\\text{m}}{\\text{kg}\\cdot\\text{s}^{-1}} = \\frac{(\\text{A}\\cdot\\text{s})\\cdot(\\text{kg}\\cdot\\text{s}^{-2}\\cdot\\text{A}^{-1})\\cdot\\text{m}}{\\text{kg}\\cdot\\text{s}^{-1}} = \\frac{\\text{kg}\\cdot\\text{m}\\cdot\\text{s}^{-1}}{\\text{kg}\\cdot\\text{s}^{-1}} = \\text{m} $$\n进行计算：\n$$R_{\\text{res}} \\approx 2.02000522... \\,\\text{m}$$\n按要求将结果四舍五入到四位有效数字：\n$$R_{\\text{res}} \\approx 2.020\\,\\text{m}$$\n这个结果表明共振层位于托卡马克的高场侧，因为 $R_{\\text{res}}  R_{0}$。",
            "answer": "$$\\boxed{2.020}$$"
        },
        {
            "introduction": "一旦我们确定了波-粒相互作用发生的位置，下一步就是使用Fokker–Planck方程来模拟这种相互作用对等离子体粒子速度分布的长期影响。本练习()聚焦于数值求解该方程时的一个关键实际挑战：确保模拟的稳定性。通过对一个常用数值格式进行稳定性分析，你将学会如何根据物理参数（如扩散系数）来选择合适的计算时间步长，这是计算等离子体物理学中的一项基本技能。",
            "id": "4034053",
            "problem": "考虑一个描述磁化等离子体中电子在射频 (RF) 波作用下的一维速度空间 Fokker–Planck 方程，其中速度空间中的准线性 (QL) 扩散建模为\n$$\n\\frac{\\partial f(v,t)}{\\partial t} \\;=\\; \\frac{\\partial}{\\partial v}\\!\\left( D_{vv}(v)\\,\\frac{\\partial f(v,t)}{\\partial v} \\right).\n$$\n您在速度空间上使用间距为 $\\Delta v$ 的均匀网格进行离散化，并使用守恒中心格式来近似散度形式，其中节点值为 $f_{j}^{n} \\approx f(v_{j},t^{n})$，面心扩散为 $D_{j+\\frac{1}{2}} \\approx D_{vv}\\!\\left(v_{j+\\frac{1}{2}}\\right)$。显式前向欧拉更新为\n$$\nf_{j}^{n+1} \\;=\\; f_{j}^{n} \\;+\\; \\frac{\\Delta t}{\\Delta v}\\left[\\,J^{n}_{j+\\frac{1}{2}} \\;-\\; J^{n}_{j-\\frac{1}{2}}\\,\\right], \n\\quad\\text{其中}\\quad \nJ^{n}_{j+\\frac{1}{2}} \\;=\\; -\\,D_{j+\\frac{1}{2}}^{n}\\,\\frac{f_{j+1}^{n} - f_{j}^{n}}{\\Delta v}.\n$$\n假设采用周期性边界条件，这样当 $D_{vv}$ 用其最大值近似时，傅里叶模态稳定性分析是适用的。设扩散以高斯分布的形式局域在共振速度周围\n$$\nD_{vv}(v) \\;=\\; D_{0}\\,\\exp\\!\\left(-\\frac{(v - v_{\\mathrm{res}})^{2}}{2\\,\\sigma^{2}}\\right),\n$$\n其幅值为 $D_{0}$，共振速度为 $v_{\\mathrm{res}}$，宽度为 $\\sigma$。扩散算子稳定性的 Courant–Friedrichs–Lewy (CFL) 条件通常写成以下形式\n$$\n\\Delta t \\;\\le\\; C\\,\\frac{\\Delta v^{2}}{\\max_{v} D_{vv}(v)},\n$$\n其中 $C$ 是一个与格式相关的常数。从上面定义的离散算子出发，对常系数情况使用 von Neumann 分析来确定显式前向欧拉格式的常数 $C$，并为变系数情况论证使用 $\\max_{v} D_{vv}(v)$ 替换的合理性。简要对比半隐式 Crank–Nicolson 格式和全隐式后向欧拉格式对同一算子的稳定性性质。\n\n取以下物理上一致的参数：\n- 网格间距 $\\Delta v = 1.0 \\times 10^{5}$ m/s。\n- 幅值 $D_{0} = 4.0 \\times 10^{11}$ m$^{2}$/s$^{3}$。\n- 共振速度 $v_{\\mathrm{res}} = 2.5 \\times 10^{6}$ m/s。\n- 宽度 $\\sigma = 3.0 \\times 10^{5}$ m/s。\n\n假设 $D_{vv}(v)$ 在 $v = v_{\\mathrm{res}}$ 处达到其最大值。根据您推导的 $C$ 和给定参数，计算显式格式的最大稳定时间步长。用秒表示最终时间步长，并将您的答案四舍五入到四位有效数字。最终报告的答案必须仅为此时间步长。",
            "solution": "基本出发点是具有准线性扩散的一维 Fokker–Planck 方程，\n$$\n\\frac{\\partial f(v,t)}{\\partial t} \\;=\\; \\frac{\\partial}{\\partial v}\\!\\left( D_{vv}(v)\\,\\frac{\\partial f(v,t)}{\\partial v} \\right),\n$$\n它表示由射频波驱动的速度空间中的守恒扩散。在间距为 $\\Delta v$ 的均匀网格上，扩散通量的一个相容的二阶守恒离散化是\n$$\nJ_{j+\\frac{1}{2}} \\;=\\; -\\,D_{j+\\frac{1}{2}}\\;\\frac{f_{j+1}-f_{j}}{\\Delta v},\n$$\n并且散度近似为\n$$\n\\left.\\frac{\\partial J}{\\partial v}\\right|_{v_j} \\;\\approx\\; \\frac{J_{j+\\frac{1}{2}} - J_{j-\\frac{1}{2}}}{\\Delta v}.\n$$\n在时间上使用显式前向欧拉法，全离散更新为\n$$\nf^{n+1}_{j} \\;=\\; f^{n}_{j} \\;+\\; \\frac{\\Delta t}{\\Delta v}\\left[\\,J^{n}_{j+\\frac{1}{2}} - J^{n}_{j-\\frac{1}{2}}\\,\\right].\n$$\n\n为了分析稳定性，我们首先考虑具有周期性边界条件的常系数情况 $D_{vv}(v) \\equiv D$。在这种情况下，离散算子简化为 $D$ 乘以标准二阶差分（离散拉普拉斯算子）。确实，\n$$\n\\frac{J_{j+\\frac{1}{2}} - J_{j-\\frac{1}{2}}}{\\Delta v}\n\\;=\\;\n-\\,\\frac{D}{\\Delta v}\\left[\\frac{f_{j+1}-f_{j}}{\\Delta v} - \\frac{f_{j}-f_{j-1}}{\\Delta v}\\right]\n\\;=\\;\nD\\,\\frac{f_{j+1} - 2 f_{j} + f_{j-1}}{\\Delta v^{2}}.\n$$\n因此，半离散系统为\n$$\n\\frac{d f_{j}}{dt} \\;=\\; D\\,\\frac{f_{j+1} - 2 f_{j} + f_{j-1}}{\\Delta v^{2}},\n$$\n并且前向欧拉更新变为\n$$\nf^{n+1}_{j} \\;=\\; f^{n}_{j} \\;+\\; \\Delta t\\,D\\,\\frac{f^{n}_{j+1} - 2 f^{n}_{j} + f^{n}_{j-1}}{\\Delta v^{2}}.\n$$\n对于 von Neumann 分析，考虑一个傅里叶模 $f^{n}_{j} = \\hat{f}^{n}\\,\\exp(i k v_{j})$，其中 $v_{j} = j\\,\\Delta v$，波数为 $k$。代入更新式得到放大因子 $g(k)$：\n$$\ng(k) \\;=\\; 1 + \\Delta t\\,D\\,\\frac{\\exp(i k \\Delta v) - 2 + \\exp(-i k \\Delta v)}{\\Delta v^{2}}\n\\;=\\; 1 - \\Delta t\\,D\\,\\frac{4 \\sin^{2}\\!\\left(\\frac{k \\Delta v}{2}\\right)}{\\Delta v^{2}}.\n$$\n对于实负系数，前向欧拉法的稳定性要求对所有 $k$ 都有 $|g(k)| \\le 1$。由于 $g(k)$ 是实数并且随 $\\sin^{2}(k \\Delta v/2)$ 减小，最严格的条件出现在最高可分辨波数处，此时 $\\sin^{2}(k \\Delta v/2) = 1$。因此，\n$$\ng_{\\min} \\;=\\; 1 \\;-\\; \\Delta t\\,D\\,\\frac{4}{\\Delta v^{2}}.\n$$\n当 $\\lambda \\le 0$ 时，前向欧拉法在负实轴上的稳定区间是 $-2 \\le \\Delta t\\,D\\,\\lambda \\le 0$。转换为此离散算子可得\n$$\n-2 \\;\\le\\; -\\,\\Delta t\\,D\\,\\frac{4}{\\Delta v^{2}} \\;\\le\\; 0\n\\quad\\Rightarrow\\quad\n\\Delta t \\;\\le\\; \\frac{\\Delta v^{2}}{2 D}.\n$$\n因此，对于采用二阶中心差分的显式前向欧拉格式，其与格式相关的常数为\n$$\nC \\;=\\; \\frac{1}{2}.\n$$\n\n对于变系数 $D_{vv}(v)$，守恒形式的离散算子仍然是对称半负定的。通过使用最大局部扩散率来界定谱半径，可以得到显式格式的一个充分稳定性条件。这得到\n$$\n\\Delta t \\;\\le\\; \\frac{\\Delta v^{2}}{2\\,\\max_{v} D_{vv}(v)},\n$$\n这就是扩散 Courant–Friedrichs–Lewy (CFL) 条件，其中 $C = 1/2$ 且用 $\\max_{v} D_{vv}(v)$ 替换了 $D$。\n\n我们现在与半隐式和全隐式格式进行对比：\n\n1. 针对扩散的 Crank–Nicolson (半隐式) 格式由线性算子的梯形时间积分定义，其放大因子为\n$$\ng_{\\mathrm{CN}}(k) \\;=\\; \\frac{1 - \\frac{\\Delta t}{2}\\,D\\,\\frac{4 \\sin^{2}(k \\Delta v/2)}{\\Delta v^{2}}}{1 + \\frac{\\Delta t}{2}\\,D\\,\\frac{4 \\sin^{2}(k \\Delta v/2)}{\\Delta v^{2}}}.\n$$\n对于 $D \\ge 0$，对任何 $\\Delta t > 0$ 都有 $|g_{\\mathrm{CN}}(k)| \\le 1$，因此对于此线性扩散算子，Crank–Nicolson 格式是无条件稳定的 (A-稳定)。\n\n2. 后向欧拉 (全隐式) 格式的放大因子为\n$$\ng_{\\mathrm{BE}}(k) \\;=\\; \\frac{1}{1 + \\Delta t\\,D\\,\\frac{4 \\sin^{2}(k \\Delta v/2)}{\\Delta v^{2}}},\n$$\n对所有 $\\Delta t > 0$，该因子满足 $0  |g_{\\mathrm{BE}}(k)| \\le 1$。因此，后向欧拉格式也是无条件稳定的。\n\n最后，我们计算给定参数下显式格式的最大稳定时间步长。高斯分布在共振点达到其最大值，所以\n$$\n\\max_{v} D_{vv}(v) \\;=\\; D_{vv}(v_{\\mathrm{res}}) \\;=\\; D_{0}.\n$$\n当 $\\Delta v = 1.0 \\times 10^{5}$ 且 $D_{0} = 4.0 \\times 10^{11}$ 时，我们有\n$$\n\\Delta v^{2} \\;=\\; (1.0 \\times 10^{5})^{2} \\;=\\; 1.0 \\times 10^{10},\n$$\n显式格式的 CFL 限制为\n$$\n\\Delta t_{\\max} \\;=\\; \\frac{\\Delta v^{2}}{2\\,D_{0}}\n\\;=\\; \\frac{1.0 \\times 10^{10}}{2 \\times 4.0 \\times 10^{11}}\n\\;=\\; \\frac{1.0 \\times 10^{10}}{8.0 \\times 10^{11}}\n\\;=\\; 1.25 \\times 10^{-2}.\n$$\n以秒表示并四舍五入到四位有效数字，最大稳定时间步长为 $1.250 \\times 10^{-2}$。",
            "answer": "$$\\boxed{1.250 \\times 10^{-2}}$$"
        },
        {
            "introduction": "本练习是一项高级实践，旨在弥合简化模型与更真实的模拟之间的差距。在托卡马克中，由于磁场的不均匀性，粒子遵循复杂的捕获或通行轨道，它们所经历的射频相互作用强度也沿着其路径不断变化。这个练习()将引导你完成对准线性扩散系数进行“弹跳平均”的计算过程，这是一种在真实磁约束几何中准确建模射频驱动输运的标准且至关重要的技术。",
            "id": "4034073",
            "problem": "实现一个完整的、可运行的程序，该程序为一个简化的、大环径比的托卡马克模型计算弹跳平均准线性扩散耦合，适用于模拟射频 (RF) 驱动的输运。任务是沿着导心轨道对一个模型扩散张量进行积分，并得出弹跳平均值。所有量都应被视为无量纲量，角度必须以弧度为单位。\n\n算法的推导应基于以下基本原理：\n- 导心不变量：总速率 $v$ 和磁矩 $\\mu$。\n- 在圆形截面、大环径比的托卡马克中，磁场的变化为 $B(\\theta) = B_0 (1 + \\epsilon \\cos \\theta)$，其中 $B_0$ 归一化为 $1$ 且 $0  \\epsilon  1$。\n- 螺距参数 $\\lambda = \\mu B_0 / (m v^2/2)$，用于将轨道分为捕获轨道或通行轨道。\n- 假设 $v$ 和 $\\mu$ 恒定，沿磁力线的平行速度由 $v_\\parallel(\\theta) = v \\sqrt{1 - \\lambda \\, B(\\theta)/B_0}$ 给出。\n- 根据导心方程，沿磁力线的时间元为：$dt = (q R_0 / |v_\\parallel(\\theta)|) \\, d\\theta$，其中 $q$ 是安全因子，$R_0$ 是大半径。\n\n沿捕获轨道的量 $D(\\theta)$ 的弹跳平均定义为\n$$\n\\langle D \\rangle_{\\text{bounce}} = \\frac{1}{T_b} \\, \\oint D(\\theta) \\, dt,\n$$\n其中弹跳周期为\n$$\nT_b = \\oint dt.\n$$\n对于通行轨道，将弹跳平均替换为一个角向周期 $0 \\le \\theta \\le 2\\pi$ 上的渡越平均，\n$$\n\\langle D \\rangle_{\\text{transit}} = \\frac{1}{T_t} \\int_0^{2\\pi} D(\\theta) \\, dt, \\quad T_t = \\int_0^{2\\pi} dt.\n$$\n\n您必须实现一个准线性扩散张量 $D_{ij}(\\mathbf{r},\\mathbf{v})$ 的模型，该模型以简化但科学上合理的形式捕捉共振 RF 耦合。对于此任务，请使用以下两个标量分量，其参数由 $D_0$、共振速度 $v_{\\text{res}}$、谱宽 $\\sigma_v$、RF 角向不对称性振幅 $a_{\\text{rf}}$、RF 相位 $\\theta_{\\text{rf}}$ 和场标度指数 $\\alpha$ 决定：\n- 平行扩散分量\n$$\nD_{\\parallel\\parallel}(\\theta) = D_0 \\, \\exp\\!\\left(-\\frac{(v_\\parallel(\\theta) - v_{\\text{res}})^2}{2 \\sigma_v^2}\\right) \\, \\left[ 1 + a_{\\text{rf}} \\cos\\!\\left(\\theta - \\theta_{\\text{rf}}\\right) \\right],\n$$\n- 垂直扩散分量\n$$\nD_{\\perp\\perp}(\\theta) = D_0 \\, \\left( \\frac{B(\\theta)}{B_0} \\right)^{\\alpha} \\, \\exp\\!\\left(-\\frac{(v_\\parallel(\\theta) - v_{\\text{res}})^2}{2 \\sigma_v^2}\\right).\n$$\n\n您必须为每种轨道类型计算相应的平均值：\n- 如果轨道是通行轨道，通过 $1 - \\lambda (1 + \\epsilon) \\ge 0$ 检测，并计算在 $0 \\le \\theta \\le 2\\pi$ 上的渡越平均。\n- 如果轨道是捕获轨道，通过 $1 - \\lambda (1 + \\epsilon)  0$ 检测，计算满足 $v_\\parallel(\\theta_b)=0$ 的转折点角度 $\\pm \\theta_b$，并计算在捕获域 $-\\theta_b \\le \\theta \\le \\theta_b$ 上的弹跳平均。\n\n您必须实现并比较三种数值积分方法的选择，用于计算时间加权积分：\n1. 均匀网格梯形法则。\n2. 具有固定节点数的高斯-勒让德求积法。\n3. 带误差控制的自适应求积法。\n\n在捕获粒子转折点附近，时间加权被积函数的行为类似于 $1/\\sqrt{\\text{到转折点的距离}}$。为确保数值稳定性，您必须选择一种变量代换来消除方法 (1) 和 (2) 的端点奇点，并对方法 (3) 使用自适应积分器。一个有效的代换是 $\\theta = \\theta_b \\sin \\phi$，其中 $\\phi \\in [-\\pi/2, \\pi/2]$，因此 $d\\theta = \\theta_b \\cos \\phi \\, d\\phi$，且被积函数在端点处保持有限。\n\n您的程序必须为每个测试用例实现以下步骤：\n- 使用 $1 - \\lambda (1 + \\epsilon)$ 判断轨道是通行轨道还是捕获轨道。\n- 使用三种积分方法中的每一种，为 $D_{\\parallel\\parallel}(\\theta)$ 和 $D_{\\perp\\perp}(\\theta)$ 计算适当的平均值。\n- 对于每个测试用例，按以下顺序返回一个包含六个浮点数的列表\n$$\n[\\langle D_{\\parallel\\parallel} \\rangle_{\\text{trap}}, \\langle D_{\\parallel\\parallel} \\rangle_{\\text{gauss}}, \\langle D_{\\parallel\\parallel} \\rangle_{\\text{adaptive}}, \\langle D_{\\perp\\perp} \\rangle_{\\text{trap}}, \\langle D_{\\perp\\perp} \\rangle_{\\text{gauss}}, \\langle D_{\\perp\\perp} \\rangle_{\\text{adaptive}}].\n$$\n如果轨道是通行轨道，则将 $\\langle \\cdot \\rangle_{\\text{trap}}$ 解释为使用相应积分选择计算的渡越平均值。\n\n测试套件和参数（均为无量纲）：\n- 案例 1（通行，近共振）：\n  - $\\epsilon = 0.3$, $\\lambda = 0.5$, $v = 1.0$, $q = 1.7$, $R_0 = 3.0$, $D_0 = 0.01$, $v_{\\text{res}} = 0.7$, $\\sigma_v = 0.15$, $a_{\\text{rf}} = 0.2$, $\\theta_{\\text{rf}} = 0.0$, $\\alpha = 0.5$。\n- 案例 2（临界捕获，端点敏感）：\n  - $\\epsilon = 0.3$, $\\lambda = 0.78$, $v = 1.0$, $q = 1.7$, $R_0 = 3.0$, $D_0 = 0.01$, $v_{\\text{res}} = 0.7$, $\\sigma_v = 0.15$, $a_{\\text{rf}} = 0.2$, $\\theta_{\\text{rf}} = 0.0$, $\\alpha = 0.5$。\n- 案例 3（深度捕获，强端点行为）：\n  - $\\epsilon = 0.3$, $\\lambda = 0.95$, $v = 1.0$, $q = 1.7$, $R_0 = 3.0$, $D_0 = 0.01$, $v_{\\text{res}} = 0.7$, $\\sigma_v = 0.15$, $a_{\\text{rf}} = 0.2$, $\\theta_{\\text{rf}} = 0.0$, $\\alpha = 0.5$。\n- 案例 4（通行，离共振）：\n  - $\\epsilon = 0.3$, $\\lambda = 0.5$, $v = 1.0$, $q = 1.7$, $R_0 = 3.0$, $D_0 = 0.01$, $v_{\\text{res}} = 2.0$, $\\sigma_v = 0.15$, $a_{\\text{rf}} = 0.2$, $\\theta_{\\text{rf}} = 0.0$, $\\alpha = 0.5$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含结果，形式为逗号分隔的列表的列表，每个内部列表对应一个测试用例，并按指定顺序排列。例如：\n$[$$[r_{1,1},r_{1,2},r_{1,3},r_{1,4},r_{1,5},r_{1,6}]$$,$$[r_{2,1},\\dots,r_{2,6}]$$,$$\\dots$$]$。",
            "solution": "该问题要求为一个在简化的大环径比托卡马克磁场中的粒子，计算其弹跳平均或渡越平均的准线性扩散系数。解决方案需要仔细实现数值积分技术，包括处理在捕获粒子轨道情况下出现的可积奇点。\n\n首先，我们建立所提供的物理和数学框架。该系统由一组无量纲参数和函数描述。沿磁力线的磁场强度由 $B(\\theta) = B_0 (1 + \\epsilon \\cos \\theta)$ 给出，其中 $\\theta$ 是角向角。给定 $B_0=1$。粒子的状态由其总速率 $v$ 和磁矩 $\\mu$ 表征，它们是运动不变量。螺距参数 $\\lambda = \\mu B_0 / (m v^2/2)$ 是一个方便的无量纲量，结合了这些不变量。粒子沿磁力线的平行速度由能量守恒导出，为 $v_\\parallel(\\theta) = v \\sqrt{1 - \\lambda B(\\theta)/B_0}$。\n\n问题的核心是计算一个量 $D(\\theta)$ 在粒子轨道上的平均值。平均的类型取决于粒子的轨道分类，这由 $v_\\parallel^2$ 在整个角向域 $\\theta \\in [0, 2\\pi]$ 上的符号决定。\n粒子为通行粒子的条件是其平行速度永不为零，即对于所有 $\\theta$，都有 $1 - \\lambda B(\\theta)/B_0 \\ge 0$。由于 $B(\\theta)$ 在 $\\theta=0$ 处达到最大值，此条件简化为 $1 - \\lambda (1+\\epsilon) \\ge 0$。\n粒子为捕获粒子的条件是其平行速度在某些点上变为零，即 $1 - \\lambda (1+\\epsilon)  0$。这些点是轨道的转折点或“香蕉尖端”。转折点 $\\pm\\theta_b$ 通过求解 $v_\\parallel(\\pm\\theta_b) = 0$ 找到，这得出 $1 - \\lambda(1 + \\epsilon \\cos\\theta_b) = 0$，或 $\\theta_b = \\arccos\\left(\\frac{1/\\lambda - 1}{\\epsilon}\\right)$。捕获粒子被限制在区域 $-\\theta_b \\le \\theta \\le \\theta_b$ 内。\n\n沿导心轨道积分的时间元是 $dt = (q R_0 / |v_\\parallel(\\theta)|) d\\theta$。量 $D(\\theta)$ 的弹跳/渡越平均值定义为 $\\langle D \\rangle = \\frac{\\oint D(\\theta) dt}{\\oint dt}$。常数因子 $q R_0$ 同时出现在分子和分母中，因此可以消去。得到的表达式为：\n对于通行轨道（渡越平均）：\n$$\n\\langle D \\rangle_{\\text{transit}} = \\frac{\\int_0^{2\\pi} D(\\theta)/|v_\\parallel(\\theta)| \\, d\\theta}{\\int_0^{2\\pi} 1/|v_\\parallel(\\theta)| \\, d\\theta}\n$$\n对于捕获轨道（弹跳平均）：\n$$\n\\langle D \\rangle_{\\text{bounce}} = \\frac{\\oint D(\\theta)/|v_\\parallel(\\theta)| \\, d\\theta}{\\oint 1/|v_\\parallel(\\theta)| \\, d\\theta} = \\frac{2 \\int_{-\\theta_b}^{\\theta_b} D(\\theta)/|v_\\parallel(\\theta)| \\, d\\theta}{2 \\int_{-\\theta_b}^{\\theta_b} 1/|v_\\parallel(\\theta)| \\, d\\theta}\n$$\n鉴于两个扩散系数模型 $D_{\\parallel\\parallel}(\\theta)$ 和 $D_{\\perp\\perp}(\\theta)$ 都是 $\\theta$ 的偶函数（因为所有测试用例中 $\\theta_{\\text{rf}} = 0$），积分可以简化为：\n$$\n\\langle D \\rangle_{\\text{bounce}} = \\frac{\\int_0^{\\theta_b} D(\\theta)/|v_\\parallel(\\theta)| \\, d\\theta}{\\int_0^{\\theta_b} 1/|v_\\parallel(\\theta)| \\, d\\theta}\n$$\n\n需要进行平均的扩散系数是平行分量：\n$$\nD_{\\parallel\\parallel}(\\theta) = D_0 \\, \\exp\\!\\left(-\\frac{(v_\\parallel(\\theta) - v_{\\text{res}})^2}{2 \\sigma_v^2}\\right) \\, \\left[ 1 + a_{\\text{rf}} \\cos\\!\\left(\\theta - \\theta_{\\text{rf}}\\right) \\right]\n$$\n和垂直分量：\n$$\nD_{\\perp\\perp}(\\theta) = D_0 \\, \\left( \\frac{B(\\theta)}{B_0} \\right)^{\\alpha} \\, \\exp\\!\\left(-\\frac{(v_\\parallel(\\theta) - v_{\\text{res}})^2}{2 \\sigma_v^2}\\right)\n$$\n其中 $D_0, v_{\\text{res}}, \\sigma_v, a_{\\text{rf}}, \\theta_{\\text{rf}}, \\alpha$ 是给定参数。\n\n数值实现必须处理三种不同的积分方法。\n对于通行轨道，被积函数在区间 $[0, 2\\pi]$ 上是连续且行为良好的，因此可以直接应用标准积分方案。\n对于捕获轨道，项 $1/|v_\\parallel(\\theta)|$ 在转折点 $\\theta = \\theta_b$ 处引入了一个可积奇点，因为当 $\\theta \\approx \\theta_b$ 时，$v_\\parallel(\\theta) \\propto \\sqrt{\\cos\\theta - \\cos\\theta_b} \\approx \\sqrt{(\\theta_b-\\theta)\\sin\\theta_b}$。被积函数在上界附近的行为类似于 $1/\\sqrt{\\theta_b - \\theta}$。\n\n三种指定的数值积分方法实现如下：\n1. **均匀网格梯形法则**：对于捕获轨道，为了处理奇点，我们采用指定的变量代换：$\\theta = \\theta_b \\sin\\phi$。这将积分域 $\\theta \\in [0, \\theta_b]$ 映射到 $\\phi \\in [0, \\pi/2]$。微分元变为 $d\\theta = \\theta_b \\cos\\phi \\, d\\phi$。被积函数 $f(\\theta)/|v_\\parallel(\\theta)|$ 变换为 $\\phi$ 的一个新函数 $g(\\phi) = \\frac{f(\\theta_b \\sin\\phi)}{|v_\\parallel(\\theta_b \\sin\\phi)|} \\theta_b \\cos\\phi$。在 $\\theta=\\theta_b$（对应于 $\\phi=\\pi/2$）的奇点附近， $|v_\\parallel|$ 的行为与 $\\sqrt{\\cos\\phi}$ 成正比，而分子中有一个 $\\cos\\phi$ 项。因此，当 $\\phi \\to \\pi/2$ 时，变换后的被积函数收敛到一个有限值，从而消除了奇点。然后将梯形法则应用于 $\\phi$ 上的均匀网格。对于通行轨道，梯形法则直接应用于 $\\theta \\in [0, 2\\pi]$ 的均匀网格上。\n\n2. **高斯-勒让德求积**：这种方法对光滑函数非常高效。对于捕获轨道，它需要与梯形法则相同的奇点消除变换 $\\theta = \\theta_b \\sin\\phi$。然后使用固定数量的节点在 $\\phi \\in [0, \\pi/2]$ 上执行积分。对于通行轨道，该方法直接应用于 $\\theta \\in [0, 2\\pi]$。\n\n3. **自适应求积**：我们使用 SciPy 库中的一个强大例程 `scipy.integrate.quad`。该积分器使用自适应算法，自动细化积分的子区间，特别是在奇点等困难区域周围，以达到指定的误差容限。它能够直接处理捕获粒子情况下的可积平方根奇点，无需任何变量代换。因此，对于通行和捕获两种情况，我们都可以将此方法应用于它们各自域 $[0, 2\\pi]$ 或 $[0, \\theta_b]$ 上的原始被积函数。\n\n算法的执行流程是首先根据参数 $\\epsilon$ 和 $\\lambda$ 对轨道进行分类。然后，对于两个扩散分量 $D_{\\parallel\\parallel}$ 和 $D_{\\perp\\perp}$ 中的每一个，使用三种积分方法分别计算分子（例如 $\\int D_{\\parallel\\parallel}/|v_\\parallel| d\\theta$）和分母（$\\int 1/|v_\\parallel| d\\theta$）所需的积分。最后，取这些积分的比值来求得平均值，并为每个测试用例汇编六个结果值。",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import quad, fixed_quad\n\ndef solve():\n    \"\"\"\n    Main function to solve the bounce-averaged quasi-linear diffusion problem\n    for the specified test cases.\n    \"\"\"\n\n    # Test cases as provided in the problem statement.\n    test_cases = [\n        # Case 1 (passing, near resonance)\n        {'epsilon': 0.3, 'lam': 0.5, 'v': 1.0, 'q': 1.7, 'R0': 3.0, 'D0': 0.01,\n         'v_res': 0.7, 'sigma_v': 0.15, 'a_rf': 0.2, 'theta_rf': 0.0, 'alpha': 0.5},\n        # Case 2 (marginally trapped, sensitive endpoints)\n        {'epsilon': 0.3, 'lam': 0.78, 'v': 1.0, 'q': 1.7, 'R0': 3.0, 'D0': 0.01,\n         'v_res': 0.7, 'sigma_v': 0.15, 'a_rf': 0.2, 'theta_rf': 0.0, 'alpha': 0.5},\n        # Case 3 (deeply trapped, strong endpoint behavior)\n        {'epsilon': 0.3, 'lam': 0.95, 'v': 1.0, 'q': 1.7, 'R0': 3.0, 'D0': 0.01,\n         'v_res': 0.7, 'sigma_v': 0.15, 'a_rf': 0.2, 'theta_rf': 0.0, 'alpha': 0.5},\n        # Case 4 (passing, off-resonance)\n        {'epsilon': 0.3, 'lam': 0.5, 'v': 1.0, 'q': 1.7, 'R0': 3.0, 'D0': 0.01,\n         'v_res': 2.0, 'sigma_v': 0.15, 'a_rf': 0.2, 'theta_rf': 0.0, 'alpha': 0.5},\n    ]\n\n    # Parameters for numerical integration methods\n    N_TRAPZ_POINTS = 4001 # Number of points for trapezoidal rule\n    N_GAUSS_POINTS = 200   # Number of nodes for Gauss-Legendre quadrature\n\n    results = []\n    for params in test_cases:\n        results.append(compute_averages_for_case(params, N_TRAPZ_POINTS, N_GAUSS_POINTS))\n\n    # Format the final output as a string representing a list of lists.\n    output_str = \"[\" + \",\".join([f\"[{','.join(map(str, r))}]\" for r in results]) + \"]\"\n    print(output_str)\n\ndef compute_averages_for_case(params, n_trapz_points, n_gauss_points):\n    \"\"\"\n    Computes quake-linear averages for a single set of physical parameters.\n    \"\"\"\n    # Unpack parameters\n    eps = params['epsilon']\n    lam = params['lam']\n    v = params['v']\n    D0 = params['D0']\n    v_res = params['v_res']\n    sigma_v = params['sigma_v']\n    a_rf = params['a_rf']\n    theta_rf = params['theta_rf']\n    alpha = params['alpha']\n    \n    # B0 is normalized to 1\n    B0 = 1.0\n\n    # Define physical functions\n    def B_field(theta):\n        return B0 * (1.0 + eps * np.cos(theta))\n\n    def v_parallel(theta):\n        # Use np.maximum to avoid sqrt of small negative numbers due to precision\n        radicand = 1.0 - lam * B_field(theta) / B0\n        return v * np.sqrt(np.maximum(0.0, radicand))\n\n    def resonance_factor(theta):\n        vp = v_parallel(theta)\n        return np.exp(-(vp - v_res)**2 / (2 * sigma_v**2))\n\n    def D_parallel(theta):\n        res_factor = resonance_factor(theta)\n        return D0 * res_factor * (1.0 + a_rf * np.cos(theta - theta_rf))\n\n    def D_perpendicular(theta):\n        res_factor = resonance_factor(theta)\n        return D0 * (B_field(theta) / B0)**alpha * res_factor\n\n    # Determine orbit type\n    is_passing = (1.0 - lam * (1.0 + eps)) = -1e-12 # Tolerance for float comparison\n\n    # --- Integrands for averaging ---\n    # The integrands are of the form X(theta) / |v_parallel(theta)|\n    # A small epsilon is added to the denominator to prevent division by zero at exact\n    # turning points, which can occur with discrete evaluation.\n    # The adaptive method handles this naturally, but fixed-grid methods need care.\n    den_eps = 1e-15\n    \n    def integrand_den(theta):\n        return 1.0 / (np.abs(v_parallel(theta)) + den_eps)\n    \n    def integrand_num_par(theta):\n        return D_parallel(theta) / (np.abs(v_parallel(theta)) + den_eps)\n        \n    def integrand_num_perp(theta):\n        return D_perpendicular(theta) / (np.abs(v_parallel(theta)) + den_eps)\n\n    case_results = []\n    \n    if is_passing:\n        # --- PASSING ORBIT ---\n        # Integration over [0, 2*pi]\n        a, b = 0.0, 2.0 * np.pi\n\n        # Method 1: Trapezoidal rule\n        theta_grid = np.linspace(a, b, n_trapz_points)\n        integral_den_trap = np.trapz(integrand_den(theta_grid), theta_grid)\n        integral_num_par_trap = np.trapz(integrand_num_par(theta_grid), theta_grid)\n        integral_num_perp_trap = np.trapz(integrand_num_perp(theta_grid), theta_grid)\n\n        # Method 2: Gauss-Legendre quadrature\n        integral_den_gauss = fixed_quad(integrand_den, a, b, n=n_gauss_points)[0]\n        integral_num_par_gauss = fixed_quad(integrand_num_par, a, b, n=n_gauss_points)[0]\n        integral_num_perp_gauss = fixed_quad(integrand_num_perp, a, b, n=n_gauss_points)[0]\n\n        # Method 3: Adaptive quadrature\n        integral_den_quad = quad(integrand_den, a, b)[0]\n        integral_num_par_quad = quad(integrand_num_par, a, b)[0]\n        integral_num_perp_quad = quad(integrand_num_perp, a, b)[0]\n\n    else:\n        # --- TRAPPED ORBIT ---\n        # Calculate turning point theta_b\n        cos_theta_b_arg = (1.0 / lam - 1.0) / eps\n        # Clamp argument to arccos to handle potential floating point errors\n        theta_b = np.arccos(np.clip(cos_theta_b_arg, -1.0, 1.0))\n        \n        # Integration over [0, theta_b]\n        a, b = 0.0, theta_b\n        \n        # --- Methods 1  2: Use variable substitution theta = theta_b * sin(phi) ---\n        a_phi, b_phi = 0.0, np.pi / 2.0\n\n        def create_transformed_integrand(integrand_func):\n            def transformed_integrand(phi):\n                theta = theta_b * np.sin(phi)\n                # The d_theta term from the substitution\n                d_theta_d_phi = theta_b * np.cos(phi)\n                return integrand_func(theta) * d_theta_d_phi\n            return transformed_integrand\n\n        integrand_den_phi = create_transformed_integrand(integrand_den)\n        integrand_num_par_phi = create_transformed_integrand(integrand_num_par)\n        integrand_num_perp_phi = create_transformed_integrand(integrand_num_perp)\n\n        # Method 1: Trapezoidal rule on transformed integrand\n        phi_grid = np.linspace(a_phi, b_phi, n_trapz_points)\n        integral_den_trap = np.trapz(integrand_den_phi(phi_grid), phi_grid)\n        integral_num_par_trap = np.trapz(integrand_num_par_phi(phi_grid), phi_grid)\n        integral_num_perp_trap = np.trapz(integrand_num_perp_phi(phi_grid), phi_grid)\n\n        # Method 2: Gauss-Legendre on transformed integrand\n        integral_den_gauss = fixed_quad(integrand_den_phi, a_phi, b_phi, n=n_gauss_points)[0]\n        integral_num_par_gauss = fixed_quad(integrand_num_par_phi, a_phi, b_phi, n=n_gauss_points)[0]\n        integral_num_perp_gauss = fixed_quad(integrand_num_perp_phi, a_phi, b_phi, n=n_gauss_points)[0]\n\n        # --- Method 3: Adaptive quadrature on original singular integrand ---\n        integral_den_quad = quad(integrand_den, a, b)[0]\n        integral_num_par_quad = quad(integrand_num_par, a, b)[0]\n        integral_num_perp_quad = quad(integrand_num_perp, a, b)[0]\n\n    # Calculate averages. Handle potential division by zero.\n    avg_par_trap = integral_num_par_trap / integral_den_trap if integral_den_trap != 0 else 0.0\n    avg_par_gauss = integral_num_par_gauss / integral_den_gauss if integral_den_gauss != 0 else 0.0\n    avg_par_quad = integral_num_par_quad / integral_den_quad if integral_den_quad != 0 else 0.0\n    \n    avg_perp_trap = integral_num_perp_trap / integral_den_trap if integral_den_trap != 0 else 0.0\n    avg_perp_gauss = integral_num_perp_gauss / integral_den_gauss if integral_den_gauss != 0 else 0.0\n    avg_perp_quad = integral_num_perp_quad / integral_den_quad if integral_den_quad != 0 else 0.0\n\n    return [avg_par_trap, avg_par_gauss, avg_par_quad,\n            avg_perp_trap, avg_perp_gauss, avg_perp_quad]\n\n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}