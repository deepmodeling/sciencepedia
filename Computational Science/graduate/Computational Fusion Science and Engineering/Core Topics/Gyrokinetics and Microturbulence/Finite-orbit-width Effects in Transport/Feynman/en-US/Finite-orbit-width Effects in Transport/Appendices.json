{
    "hands_on_practices": [
        {
            "introduction": "Before diving into complex transport models, we can gain immense physical insight from fundamental conservation laws. In an axisymmetric tokamak, the conservation of canonical toroidal angular momentum, $P_{\\phi}$, provides a powerful and exact constraint on how far a particle's orbit can deviate from a magnetic flux surface. This exercise demonstrates how this principle is used to determine a threshold energy for particle loss, a critical issue for the confinement of fusion products and fast ions from auxiliary heating .",
            "id": "3980626",
            "problem": "Consider a large-aspect-ratio diverted tokamak with axisymmetric magnetic geometry. Let the toroidal coordinate be $\\phi$, the major radius be $R$, and the magnetic field be decomposed into toroidal and poloidal components with magnitudes $B_{\\phi}$ and $B_{p}$, respectively, so that the total field magnitude is $B = \\sqrt{B_{\\phi}^{2} + B_{p}^{2}}$. Near the X-point, assume $B_{p} \\rightarrow 0$ such that $B \\approx B_{\\phi}$. The guiding-center Lagrangian in the absence of non-axisymmetric perturbations implies that the canonical toroidal angular momentum $P_{\\phi}$ is an exact invariant. In standard toroidal coordinates and in the International System of Units, the toroidal component of the vector potential $A_{\\phi}(R,Z)$ defines the poloidal magnetic flux per radian $\\psi(R,Z)$ through $R A_{\\phi} = \\psi$ (so that $\\psi$ has units of Weber), and the canonical toroidal angular momentum is $P_{\\phi} = m R v_{\\phi} + q \\psi$, where $m$ and $q$ are the particle mass and charge, and $v_{\\phi}$ is the toroidal component of the particle velocity.\n\nA suprathermal ion born at a flux surface labeled by $\\psi_{0}$ undergoes guiding-center motion. Finite-orbit-width excursions can lead to orbit loss if the guiding center crosses the separatrix at $\\psi_{\\text{sep}}$. Using only (i) invariance of $P_{\\phi}$ under axisymmetry, (ii) conservation of kinetic energy, and (iii) the leading-order guiding-center kinematic relation $v_{\\phi} \\approx (B_{\\phi}/B)\\, v_{\\parallel}$ between toroidal and parallel velocities, derive the condition under which canonical momentum conservation restricts crossing of the separatrix, and from it obtain the threshold kinetic energy $E_{\\text{thr}}$ required for a deuterium ion to reach $\\psi_{\\text{sep}}$ from $\\psi_{0}$.\n\nThen, estimate $E_{\\text{thr}}$ numerically for a fully ionized deuterium ion with $q = +e$ and $m = 3.344 \\times 10^{-27}\\ \\text{kg}$, where $e = 1.602176634 \\times 10^{-19}\\ \\text{C}$. Use $R_{\\text{sep}} = 1.65\\ \\text{m}$, $B_{\\phi} = 2.20\\ \\text{T}$, $B = 2.25\\ \\text{T}$, and $|\\psi_{\\text{sep}} - \\psi_{0}| = \\Delta \\psi = 0.050\\ \\text{Wb}$. Express the final energy in $\\text{keV}$ and round your answer to three significant figures.",
            "solution": "The user wants me to solve a plasma physics problem.\n\n### Step 1: Extract Givens\n-   System: Large-aspect-ratio diverted tokamak, axisymmetric magnetic geometry.\n-   Coordinates: Toroidal $\\phi$, major radius $R$.\n-   Magnetic field: $B = \\sqrt{B_{\\phi}^{2} + B_{p}^{2}}$.\n-   Approximation near X-point: $B_{p} \\rightarrow 0$ so $B \\approx B_{\\phi}$.\n-   Invariant: Canonical toroidal angular momentum $P_{\\phi}$.\n-   Poloidal flux: $\\psi(R,Z)$ defined by $R A_{\\phi} = \\psi$, where $A_{\\phi}$ is the toroidal component of the vector potential. Units of $\\psi$ are Weber.\n-   Canonical toroidal angular momentum formula: $P_{\\phi} = m R v_{\\phi} + q \\psi$.\n-   Particle: Suprathermal ion with mass $m$ and charge $q$.\n-   Initial condition: Particle is born at flux surface $\\psi_{0}$.\n-   Loss condition: Guiding center crosses separatrix at $\\psi_{\\text{sep}}$.\n-   Principles to use for derivation:\n    1.  Invariance of $P_{\\phi}$.\n    2.  Conservation of kinetic energy.\n    3.  Guiding-center kinematic relation: $v_{\\phi} \\approx (B_{\\phi}/B)\\, v_{\\parallel}$.\n-   Numerical estimation parameters:\n    -   Particle: Fully ionized deuterium ion.\n    -   Charge: $q = +e = 1.602176634 \\times 10^{-19}\\ \\text{C}$.\n    -   Mass: $m = 3.344 \\times 10^{-27}\\ \\text{kg}$.\n    -   Separatrix major radius: $R_{\\text{sep}} = 1.65\\ \\text{m}$.\n    -   Toroidal magnetic field at $R_{\\text{sep}}$: $B_{\\phi} = 2.20\\ \\text{T}$.\n    -   Total magnetic field at $R_{\\text{sep}}$: $B = 2.25\\ \\text{T}$.\n    -   Flux difference: $|\\psi_{\\text{sep}} - \\psi_{0}| = \\Delta \\psi = 0.050\\ \\text{Wb}$.\n-   Required output: Threshold kinetic energy $E_{\\text{thr}}$ in units of keV, rounded to three significant figures.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, well-posed, and objective. It is a standard problem in tokamak plasma physics, dealing with Guiding Center orbit theory and finite-orbit-width effects, which is a core topic in fusion science. The physical principles (conservation of canonical momentum in axisymmetry, conservation of energy) are fundamental. The definitions and formulas provided are standard. The numerical values are realistic for a mid-sized tokamak. The problem does not contain any scientific falsehoods, contradictions, or ambiguities. The phrase \"Near the X-point, assume $B_p \\rightarrow 0$\" serves as physical motivation for why orbit-loss is important in that region, but the derivation itself correctly relies on the general relation $v_{\\phi} \\approx (B_{\\phi}/B)\\, v_{\\parallel}$ and the provided distinct values for $B$ and $B_{\\phi}$, which implies $B_p \\neq 0$ at the point of calculation. This poses no contradiction. The problem is thus deemed valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. I will proceed with the solution.\n\n### Derivation of the Threshold Energy\n\nThe problem requires the derivation of the threshold kinetic energy $E_{\\text{thr}}$ for a suprathermal ion to travel from its birth flux surface $\\psi_{0}$ to the separatrix $\\psi_{\\text{sep}}$. This derivation will be based on the three principles provided: conservation of canonical toroidal angular momentum $P_{\\phi}$, conservation of kinetic energy $E$, and the guiding-center kinematic relation between toroidal and parallel velocities.\n\n1.  **Conservation of Canonical Toroidal Angular Momentum ($P_{\\phi}$)**:\n    In an axisymmetric system, $P_{\\phi}$ is an exact invariant of the guiding-center motion. The formula is given as $P_{\\phi} = m R v_{\\phi} + q \\psi$.\n    The term \"born at a flux surface\" implies an initial condition. A standard and physically meaningful interpretation for calculating threshold orbits (e.g., \"fattest\" banana orbits) is to consider a particle created with kinetic energy $E$ but from a state of zero velocity. At the moment of birth at a location $(R_{0}, Z_{0})$ on the flux surface $\\psi_0$, its velocity is zero ($v_{\\phi,0} = 0$), so its canonical momentum is determined solely by its position and charge:\n    $$P_{\\phi} = m R_{0} (0) + q \\psi(R_{0}, Z_{0}) = q \\psi_0$$\n    Since $P_{\\phi}$ is conserved, its value remains $q \\psi_0$ throughout the particle's trajectory.\n\n2.  **Determining Toroidal Velocity ($v_{\\phi}$)**:\n    At any other point $(R, Z)$ on the particle's orbit, described by the flux value $\\psi(R,Z)$, the conserved momentum is still given by $P_{\\phi} = m R v_{\\phi} + q \\psi$. Equating this to the initial value:\n    $$m R v_{\\phi} + q \\psi = q \\psi_0$$\n    We can solve for the toroidal velocity component $v_{\\phi}$ at any point on the orbit:\n    $$v_{\\phi} = \\frac{q(\\psi_0 - \\psi)}{m R}$$\n\n3.  **Applying the Kinematic Relation**:\n    The problem provides the guiding-center relation $v_{\\phi} \\approx (B_{\\phi}/B) v_{\\parallel}$. We can use this to find the parallel velocity $v_{\\parallel}$:\n    $$v_{\\parallel} \\approx \\frac{B}{B_{\\phi}} v_{\\phi} = \\frac{B}{B_{\\phi}} \\frac{q(\\psi_0 - \\psi)}{m R}$$\n\n4.  **Conservation of Kinetic Energy ($E$)**:\n    The kinetic energy of the particle, $E = \\frac{1}{2} m v^2$, is conserved. The total velocity squared can be decomposed into components parallel and perpendicular to the magnetic field: $v^2 = v_{\\parallel}^2 + v_{\\perp}^2$.\n    $$E = \\frac{1}{2} m (v_{\\parallel}^2 + v_{\\perp}^2)$$\n    For a particle to physically exist at a point in space, its speed and all its velocity components must be real. This implies that the perpendicular velocity squared, $v_{\\perp}^2$, must be non-negative:\n    $$v_{\\perp}^2 = v^2 - v_{\\parallel}^2 = \\frac{2E}{m} - v_{\\parallel}^2 \\ge 0$$\n    This inequality provides the fundamental constraint on the particle's motion: the square of its parallel velocity cannot exceed the square of its total speed.\n    $$v_{\\parallel}^2 \\le \\frac{2E}{m}$$\n    This can be rearranged to give a condition on the minimum kinetic energy required for a particle to have a specific parallel velocity $v_{\\parallel}$:\n    $$E \\ge \\frac{1}{2} m v_{\\parallel}^2$$\n\n5.  **Deriving the Threshold Energy ($E_{\\text{thr}}$)**:\n    Combining the results, a particle can reach a point $(R, \\psi)$ only if its kinetic energy $E$ is sufficient to support the parallel velocity required by $P_{\\phi}$ conservation at that point.\n    $$E \\ge \\frac{1}{2} m \\left( \\frac{B}{B_{\\phi}} \\frac{q(\\psi_0 - \\psi)}{m R} \\right)^2$$\n    $$E \\ge \\frac{q^2 (\\psi_0 - \\psi)^2}{2 m R^2} \\left( \\frac{B}{B_{\\phi}} \\right)^2$$\n    The ion is lost if it can reach the separatrix, $\\psi = \\psi_{\\text{sep}}$. The threshold energy $E_{\\text{thr}}$ is the minimum energy required to reach any point on the separatrix. The problem asks for an estimate using a single set of parameters ($R_{\\text{sep}}, B, B_{\\phi}$) for a point on the separatrix. We therefore evaluate the minimum required energy at this specific point.\n    $$E_{\\text{thr}} = \\frac{q^2 (\\psi_0 - \\psi_{\\text{sep}})^2}{2 m R_{\\text{sep}}^2} \\left( \\frac{B}{B_{\\phi}} \\right)^2$$\n    Using the notation $\\Delta\\psi = |\\psi_{\\text{sep}} - \\psi_0|$, the expression becomes:\n    $$E_{\\text{thr}} = \\frac{q^2 (\\Delta\\psi)^2}{2 m R_{\\text{sep}}^2} \\left( \\frac{B}{B_{\\phi}} \\right)^2$$\n    This is the derived condition for the threshold kinetic energy.\n\n### Numerical Estimation\n\nWe now substitute the given values to estimate $E_{\\text{thr}}$.\n-   $q = e = 1.602176634 \\times 10^{-19}\\ \\text{C}$\n-   $m = 3.344 \\times 10^{-27}\\ \\text{kg}$\n-   $\\Delta\\psi = 0.050\\ \\text{Wb}$\n-   $R_{\\text{sep}} = 1.65\\ \\text{m}$\n-   $B_{\\phi} = 2.20\\ \\text{T}$\n-   $B = 2.25\\ \\text{T}$\n\nFirst, calculate the energy in SI units (Joules):\n$$E_{\\text{thr}} = \\frac{(1.602176634 \\times 10^{-19}\\ \\text{C})^2 (0.050\\ \\text{Wb})^2}{2 (3.344 \\times 10^{-27}\\ \\text{kg}) (1.65\\ \\text{m})^2} \\left( \\frac{2.25\\ \\text{T}}{2.20\\ \\text{T}} \\right)^2$$\n$$E_{\\text{thr}} = \\frac{(2.56697 \\times 10^{-38}) (2.5 \\times 10^{-3})}{(6.688 \\times 10^{-27}) (2.7225)} \\left( 1.022727... \\right)^2$$\n$$E_{\\text{thr}} = \\frac{6.4174 \\times 10^{-41}}{1.82088 \\times 10^{-26}} (1.04601...)$$\n$$E_{\\text{thr}} = (3.5243 \\times 10^{-15}) (1.04601...)$$\n$$E_{\\text{thr}} \\approx 3.6865 \\times 10^{-15}\\ \\text{J}$$\n\nNext, convert this energy to kiloelectron-volts (keV). The conversion factor is $1\\ \\text{keV} = 1.602176634 \\times 10^{-16}\\ \\text{J}$.\n$$E_{\\text{thr}} \\text{ (in keV)} = \\frac{E_{\\text{thr}} \\text{ (in J)}}{1.602176634 \\times 10^{-16}\\ \\text{J/keV}}$$\n$$E_{\\text{thr}} \\text{ (in keV)} = \\frac{3.6865 \\times 10^{-15}}{1.602176634 \\times 10^{-16}}$$\n$$E_{\\text{thr}} \\approx 22.997\\ \\text{keV}$$\n\nFinally, rounding the result to three significant figures as requested:\n$$E_{\\text{thr}} \\approx 23.0\\ \\text{keV}$$",
            "answer": "$$\n\\boxed{23.0}\n$$"
        },
        {
            "introduction": "Building on the idea that particles have finite orbit widths, the next step is to understand how this microscopic feature affects the macroscopic transport equations. This practice bridges the gap between scales by starting with a nonlocal convolution model for the particle flux and performing a Taylor expansion. This fundamental technique reveals the first-order corrections that finite-orbit-width effects introduce to the standard Fick's law of diffusion .",
            "id": "3980559",
            "problem": "Consider axisymmetric magnetically confined plasma in a large-aspect-ratio tokamak, and let $r$ denote a minor-radius-like flux coordinate. Assume that, under the local approximation derived from the drift-kinetic equation (DKE), the flux-surface-averaged radial particle flux is modeled as $\\,\\Gamma_{\\mathrm{loc}}(r)=-D_{0}(r)\\,\\partial n/\\partial r\\,$, where $D_{0}(r)$ is a smooth local diffusivity and $n(r)$ is the density profile. Now account for finite-orbit-width (FOW) nonlocality by modeling the actual flux as an orbit-sampling convolution of the local closure,\n$$\n\\Gamma(r) \\equiv -\\int_{-\\infty}^{\\infty} K_{\\Delta}(r-r')\\,D_{0}(r')\\,\\frac{\\partial n}{\\partial r'}(r')\\,\\mathrm{d}r' ,\n$$\nwhere $K_{\\Delta}(x)$ is a smooth kernel that encodes the distribution of guiding-center radial displacements, and $\\Delta$ is a characteristic orbit width. Suppose:\n- The kernel is normalized, $\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,\\mathrm{d}x=1$.\n- The first and second raw moments exist and scale as $\\int_{-\\infty}^{\\infty} x\\,K_{\\Delta}(x)\\,\\mathrm{d}x = m_{1}=\\alpha\\,\\Delta$ and $\\int_{-\\infty}^{\\infty} x^{2}\\,K_{\\Delta}(x)\\,\\mathrm{d}x = m_{2}=\\beta\\,\\Delta^{2}$, where $\\alpha$ and $\\beta$ are dimensionless constants of order unity determined by the orbit geometry and mean radial electric field.\n- The small parameter is $\\,\\Delta/L \\ll 1\\,$, where $L$ is the minimum of the radial variation scales of $D_{0}(r)$ and $n(r)$, and $\\Delta$ and the moments vary only on scales $\\gg \\Delta$.\n\nDefine the effective diffusivity $D_{\\mathrm{eff}}(r)$ by the relation $\\,\\Gamma(r)\\equiv- D_{\\mathrm{eff}}(r)\\,\\partial n/\\partial r\\,$, valid order-by-order in a regular expansion in $\\Delta/L$. Assume that, locally, $n(r)$ is well approximated by an exponential profile so that $\\,\\partial^{2}n/\\partial r^{2}=-(1/L_{n})\\,\\partial n/\\partial r\\,$ with $\\,L_{n}(r)\\equiv-\\left[\\partial \\ln n/\\partial r\\right]^{-1}\\,$ approximately constant over scales $\\ll L$. Also define the local scale length of the diffusivity $\\,L_{D}(r)\\equiv\\left[\\partial \\ln D_{0}/\\partial r\\right]^{-1}\\,$.\n\nStarting only from the convolution model above, the normalization and moment assumptions for $K_{\\Delta}$, and the Taylor-expansion of smooth functions, compute the first-order (in $\\Delta/L$) relative correction $\\,\\delta D^{(1)}/D_{0}\\,$ to the local diffusivity, where $\\,\\delta D^{(1)}\\equiv D_{\\mathrm{eff}}-D_{0}\\,$. Then, using the second moment $m_{2}$, assess the range of validity of the first-order approximation by deriving a bound on $\\Delta/L$ such that the neglected second-order term is smaller than a prescribed tolerance $\\,\\varepsilon \\ll 1\\,$ in the flux, expressed using the characteristic scale lengths and $\\beta$.\n\nProvide your final answer as a single closed-form analytic expression for the first-order relative correction $\\,\\delta D^{(1)}/D_{0}\\,$ in terms of $\\,\\alpha\\,$, $\\,\\Delta\\,$, $\\,L_{D}\\,$, and $\\,L_{n}\\,$. No numerical evaluation or units are required in the final answer. In your derivation, ensure all steps are justified from the stated assumptions and definitions, and clearly state the condition you obtain for the range of validity in terms of $\\,\\varepsilon\\,$, $\\,\\Delta/L\\,$, and $\\,\\beta\\,$.",
            "solution": "The problem requires the derivation of the first-order finite-orbit-width (FOW) correction to the local particle diffusivity in a tokamak plasma and an assessment of the validity of this first-order approximation. The starting point is the nonlocal convolution model for the radial particle flux $\\Gamma(r)$.\n\nThe flux is given by the integral:\n$$\n\\Gamma(r) = -\\int_{-\\infty}^{\\infty} K_{\\Delta}(r-r')\\,D_{0}(r')\\,\\frac{\\partial n}{\\partial r'}(r')\\,\\mathrm{d}r'\n$$\nLet us introduce a new integration variable $x \\equiv r - r'$, which represents the radial displacement from the flux surface at $r$. Consequently, $r' = r - x$ and $\\mathrm{d}r' = -\\mathrm{d}x$. The limits of integration transform as $r' \\to \\pm\\infty$ corresponds to $x \\to \\mp\\infty$. Substituting these into the integral for $\\Gamma(r)$ yields:\n$$\n\\Gamma(r) = -\\int_{\\infty}^{-\\infty} K_{\\Delta}(x)\\,D_{0}(r-x)\\,\\frac{\\partial n}{\\partial r}(r-x)\\,(-\\mathrm{d}x)\n$$\nReversing the integration limits cancels the negative sign from the differential, giving:\n$$\n\\Gamma(r) = -\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,\\left[ D_{0}(r-x)\\,\\frac{\\partial n}{\\partial r}(r-x) \\right]\\,\\mathrm{d}x\n$$\nLet us define the local flux function as $F(r') \\equiv D_{0}(r')\\,\\frac{\\partial n}{\\partial r}(r')$. The expression for the flux becomes:\n$$\n\\Gamma(r) = -\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,F(r-x)\\,\\mathrm{d}x\n$$\nThe problem states that the characteristic orbit width $\\Delta$ is small compared to the radial scale lengths $L$ of $D_{0}(r)$ and $n(r)$. The kernel $K_{\\Delta}(x)$ is localized around $x=0$ with a width of order $\\Delta$. This justifies a Taylor series expansion of the smooth function $F(r-x)$ in the variable $x$ around $x=0$:\n$$\nF(r-x) = F(r) - x F'(r) + \\frac{x^{2}}{2!} F''(r) - \\frac{x^{3}}{3!} F'''(r) + \\dots\n$$\nwhere $F'(r) = \\frac{\\mathrm{d}F}{\\mathrm{d}r}(r)$, $F''(r) = \\frac{\\mathrm{d}^{2}F}{\\mathrm{d}r^{2}}(r)$, and so on. Substituting this expansion into the integral for $\\Gamma(r)$:\n$$\n\\Gamma(r) = -\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,\\left( F(r) - x F'(r) + \\frac{x^{2}}{2} F''(r) - \\dots \\right)\\,\\mathrm{d}x\n$$\nBy linearity of the integral, we can integrate term by term:\n$$\n\\Gamma(r) = - \\left( F(r)\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,\\mathrm{d}x - F'(r)\\int_{-\\infty}^{\\infty} x\\,K_{\\Delta}(x)\\,\\mathrm{d}x + \\frac{F''(r)}{2}\\int_{-\\infty}^{\\infty} x^{2}\\,K_{\\Delta}(x)\\,\\mathrm{d}x - \\dots \\right)\n$$\nUsing the provided definitions for the moments of the kernel $K_{\\Delta}(x)$:\n\\begin{itemize}\n    \\item Normalization: $\\int_{-\\infty}^{\\infty} K_{\\Delta}(x)\\,\\mathrm{d}x = 1$\n    \\item First moment: $m_{1} = \\int_{-\\infty}^{\\infty} x\\,K_{\\Delta}(x)\\,\\mathrm{d}x = \\alpha\\,\\Delta$\n    \\item Second moment: $m_{2} = \\int_{-\\infty}^{\\infty} x^{2}\\,K_{\\Delta}(x)\\,\\mathrm{d}x = \\beta\\,\\Delta^{2}$\n\\end{itemize}\nThe flux can be expressed as an expansion in powers of $\\Delta$:\n$$\n\\Gamma(r) = - \\left( F(r) - m_{1} F'(r) + \\frac{m_{2}}{2} F''(r) - \\dots \\right)\n$$\nThe problem asks for a first-order correction, so we will truncate the series after the term linear in $\\Delta$. The term with $m_{1}$ is of order $\\Delta$, and the term with $m_{2}$ is of order $\\Delta^{2}$.\n$$\n\\Gamma(r) \\approx - \\left( F(r) - m_{1} F'(r) \\right)\n$$\nWe now need to compute $F'(r)$. Substituting $F(r) = D_{0}(r)\\,\\frac{\\partial n}{\\partial r}(r)$:\n$$\nF'(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left( D_{0}\\frac{\\partial n}{\\partial r} \\right) = \\frac{\\partial D_{0}}{\\partial r} \\frac{\\partial n}{\\partial r} + D_{0} \\frac{\\partial^{2} n}{\\partial r^{2}}\n$$\nUsing the provided definitions for the scale lengths $L_{D}(r) \\equiv \\left[\\frac{\\partial \\ln D_{0}}{\\partial r}\\right]^{-1} = D_{0}/\\frac{\\partial D_{0}}{\\partial r}$ and $L_{n}(r) \\equiv -\\left[\\frac{\\partial \\ln n}{\\partial r}\\right]^{-1}$, and the local approximation $\\frac{\\partial^{2}n}{\\partial r^{2}} = -\\frac{1}{L_{n}} \\frac{\\partial n}{\\partial r}$, we can express the derivatives:\n$$\n\\frac{\\partial D_{0}}{\\partial r} = \\frac{D_{0}}{L_{D}}\n$$\nSubstituting these into the expression for $F'(r)$:\n$$\nF'(r) = \\left(\\frac{D_{0}}{L_{D}}\\right)\\frac{\\partial n}{\\partial r} + D_{0}\\left(-\\frac{1}{L_{n}}\\frac{\\partial n}{\\partial r}\\right) = D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial n}{\\partial r}\n$$\nNow, substitute the expressions for $F(r)$ and $F'(r)$ back into the expansion for $\\Gamma(r)$:\n$$\n\\Gamma(r) \\approx - \\left[ D_{0}\\frac{\\partial n}{\\partial r} - (\\alpha\\Delta) \\, D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial n}{\\partial r} \\right]\n$$\nFactoring out $D_{0}$ and $\\frac{\\partial n}{\\partial r}$:\n$$\n\\Gamma(r) \\approx - D_{0}\\left[ 1 - \\alpha\\Delta\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right) \\right] \\frac{\\partial n}{\\partial r}\n$$\nThe problem defines the effective diffusivity $D_{\\mathrm{eff}}(r)$ through the relation $\\Gamma(r) \\equiv -D_{\\mathrm{eff}}(r)\\,\\frac{\\partial n}{\\partial r}$. By comparing this definition with our result, we can identify $D_{\\mathrm{eff}}(r)$ up to first order in $\\Delta$:\n$$\nD_{\\mathrm{eff}}(r) \\approx D_{0}(r)\\left[ 1 - \\alpha\\Delta\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right) \\right] = D_{0}(r) + D_{0}(r)\\,\\alpha\\Delta\\left(\\frac{1}{L_{n}} - \\frac{1}{L_{D}}\\right)\n$$\nThe first-order correction to the diffusivity is $\\delta D^{(1)} \\equiv D_{\\mathrm{eff}} - D_{0}$. From our expansion, this is:\n$$\n\\delta D^{(1)} = D_{0}(r)\\,\\alpha\\Delta\\left(\\frac{1}{L_{n}} - \\frac{1}{L_{D}}\\right)\n$$\nThe problem asks for the relative correction, $\\delta D^{(1)}/D_{0}$:\n$$\n\\frac{\\delta D^{(1)}}{D_{0}} = \\alpha\\Delta\\left(\\frac{1}{L_{n}} - \\frac{1}{L_{D}}\\right)\n$$\nThis is the first required result.\n\nNext, we assess the range of validity of this approximation. This requires evaluating the next term in the expansion, which is the second-order term, and comparing its magnitude to the leading-order term. The second-order correction to the flux, let us call it $\\Gamma^{(2)}$, is:\n$$\n\\Gamma^{(2)}(r) = -\\frac{m_{2}}{2} F''(r) = -\\frac{\\beta\\Delta^{2}}{2} F''(r)\n$$\nWe need to compute $F''(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}F'(r)$. Using our expression for $F'(r)$:\n$$\nF''(r) = \\frac{\\mathrm{d}}{\\mathrm{d}r}\\left[ D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial n}{\\partial r} \\right]\n$$\nThe problem states that $L_{n}$ and $L_{D}$ are defined from profiles whose variation scale is $L \\gg \\Delta$. This supports treating $L_{n}$ and $L_{D}$ as locally constant for differentiation purposes in the context of this expansion. Thus:\n$$\nF''(r) \\approx D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial^{2} n}{\\partial r^{2}} + \\frac{\\partial D_{0}}{\\partial r}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial n}{\\partial r}\n$$\nUsing $\\frac{\\partial D_{0}}{\\partial r} = \\frac{D_{0}}{L_{D}}$ and $\\frac{\\partial^{2} n}{\\partial r^{2}} = -\\frac{1}{L_{n}} \\frac{\\partial n}{\\partial r}$:\n$$\nF''(r) \\approx D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\left(-\\frac{1}{L_{n}}\\frac{\\partial n}{\\partial r}\\right) + \\frac{D_{0}}{L_{D}}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)\\frac{\\partial n}{\\partial r}\n$$\n$$\nF''(r) \\approx D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right) \\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right) \\frac{\\partial n}{\\partial r} = D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}\\frac{\\partial n}{\\partial r}\n$$\nThe second-order correction to the flux is therefore:\n$$\n\\Gamma^{(2)}(r) = -\\frac{\\beta\\Delta^{2}}{2} D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}\\frac{\\partial n}{\\partial r}\n$$\nThe leading-order (zeroth-order) flux is the local flux, $\\Gamma^{(0)}(r) = -F(r) = -D_{0}\\frac{\\partial n}{\\partial r}$.\nThe validity of the first-order approximation requires that the magnitude of the second-order correction to the flux be small compared to the leading-order flux. Let $\\varepsilon \\ll 1$ be a small tolerance. The condition is $|\\Gamma^{(2)}/\\Gamma^{(0)}|  \\varepsilon$.\n$$\n\\left| \\frac{-\\frac{\\beta\\Delta^{2}}{2} D_{0}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}\\frac{\\partial n}{\\partial r}}{-D_{0}\\frac{\\partial n}{\\partial r}} \\right|  \\varepsilon\n$$\n$$\n\\frac{\\beta\\Delta^{2}}{2}\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}  \\varepsilon\n$$\nThe problem specifies $\\Delta/L \\ll 1$ where $L$ is a characteristic background scale length. The term $\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}$ has units of inverse length squared and is of order $1/L^{2}$. Let us rearrange the inequality to obtain a bound on $\\Delta$.\n$$\n\\Delta^{2}  \\frac{2\\varepsilon}{\\beta\\left(\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right)^{2}}\n$$\nTaking the square root gives the condition on $\\Delta$:\n$$\n\\Delta \\left|\\frac{1}{L_{D}} - \\frac{1}{L_{n}}\\right|  \\sqrt{\\frac{2\\varepsilon}{\\beta}}\n$$\nThis is the condition on the problem's parameters for the second-order term in the flux to be smaller than a fraction $\\varepsilon$ of the zeroth-order term. This provides a quantitative assessment of the range of validity for the first-order approximation. For example, if we define an effective gradient scale length $L_{eff}^{-1} = |L_{D}^{-1} - L_{n}^{-1}|$, the condition is $\\Delta/L_{eff}  \\sqrt{2\\varepsilon/\\beta}$.",
            "answer": "$$\\boxed{\\alpha\\Delta\\left(\\frac{1}{L_{n}} - \\frac{1}{L_{D}}\\right)}$$"
        },
        {
            "introduction": "Analytical models, while insightful, often rely on simplifying assumptions about the plasma geometry, such as large aspect ratio or circular cross-sections. To accurately study finite-orbit-width effects in modern, shaped tokamaks, we must turn to numerical methods. This comprehensive coding exercise guides you through building a guiding-center orbit integrator from first principles, allowing for the direct computation of banana orbits in a realistic magnetic equilibrium and a quantitative analysis of how their size depends on shaping parameters like elongation $\\kappa$ and triangularity $\\delta$ .",
            "id": "3980597",
            "problem": "You are tasked with building a complete numerical guiding-center orbit integrator in an axisymmetric Miller equilibrium and using it to compute banana half-widths for a distribution of trapped ion guiding centers. The core objective is to analyze how the banana half-width depends on elongation and triangularity of the flux surface shape. The program must compute the mean banana half-width (over a specified distribution of trapped particles) for each case in a provided test suite and output the results in a single line as a comma-separated list enclosed in square brackets. All reported lengths must be in meters.\n\nStart from the fundamental laws and core definitions:\n- The Lorentz force law for a charged particle of mass $m$ and charge $q$ in a magnetic field $\\mathbf{B}$ implies conservation of magnetic moment $\\mu$ and total energy $E$ under the guiding-center approximation, with the guiding-center equations of motion\n$$\n\\frac{d\\mathbf{x}}{dt} = v_{\\parallel} \\,\\mathbf{b} + \\mathbf{v}_{d}, \\quad \n\\frac{dv_{\\parallel}}{dt} = -\\frac{\\mu}{m}\\,\\mathbf{b}\\cdot\\nabla B,\n$$\nwhere $v_{\\parallel}$ is the parallel velocity, $\\mathbf{b}=\\mathbf{B}/B$ is the magnetic field unit vector, and the magnetic drift velocity is given by\n$$\n\\mathbf{v}_{d} = \\frac{m}{q}\\,\\frac{v_{\\parallel}^{2} + v_{\\perp}^{2}/2}{B^{3}}\\left(\\mathbf{B} \\times \\nabla B\\right),\n$$\nwith $v_{\\perp}^{2} = 2\\mu B/m$. The total speed $v$ satisfies $v^{2} = v_{\\parallel}^{2} + v_{\\perp}^{2}$ with $E = \\tfrac{1}{2} m v^{2}$ constant.\n\n- In an axisymmetric toroidal system, adopt the Miller equilibrium parameterization for a single flux surface with minor radius $r$, poloidal angle $\\theta$ and toroidal angle $\\zeta$, characterized by major radius $R_{0}$, minor radius $r$, elongation $\\kappa$, and triangularity $\\delta$. The position vector in cylindrical embedding with coordinates $\\left(R,\\phi,Z\\right)$ and Cartesian coordinates $\\left(X,Y,Z\\right)$ is\n$$\nR(r,\\theta) = R_{0} + r \\cos\\!\\left(\\theta + \\delta \\sin\\theta\\right), \\quad Z(r,\\theta) = \\kappa\\, r \\sin\\theta,\n$$\n$$\nX = R(r,\\theta)\\cos\\zeta,\\quad Y = R(r,\\theta)\\sin\\zeta.\n$$\nConstruct the tangent vectors on the surface as\n$$\n\\mathbf{t}_{r} = \\frac{\\partial \\mathbf{X}}{\\partial r},\\quad\n\\mathbf{t}_{\\theta} = \\frac{\\partial \\mathbf{X}}{\\partial \\theta},\\quad\n\\mathbf{t}_{\\zeta} = \\frac{\\partial \\mathbf{X}}{\\partial \\zeta}.\n$$\nAssume a large aspect ratio, low-beta, axisymmetric magnetic field whose magnitude depends only on $R$ via\n$$\nB(r,\\theta) = B_{0}\\,\\frac{R_{0}}{R(r,\\theta)},\n$$\nwith $B_{0}$ the magnetic field at $R_{0}$. Take the field-line direction as the unit vector in the span of $\\mathbf{t}_{\\theta}$ and $\\mathbf{t}_{\\zeta}$, with constant safety factor $q_{\\mathrm{s}}$ specifying the pitch, and construct $\\mathbf{b}$ as the normalized combination of the unit tangent vectors along poloidal and toroidal directions. The spatial gradient $\\nabla B$ is recovered by enforcing its directional derivatives along the tangent directions $\\mathbf{t}_{r}$, $\\mathbf{t}_{\\theta}$, and $\\mathbf{t}_{\\zeta}$:\n$$\n\\mathbf{t}_{r}\\cdot\\nabla B = \\frac{\\partial B}{\\partial r},\\quad\n\\mathbf{t}_{\\theta}\\cdot\\nabla B = \\frac{\\partial B}{\\partial \\theta},\\quad\n\\mathbf{t}_{\\zeta}\\cdot\\nabla B = 0,\n$$\nwith $\\partial B/\\partial r$ and $\\partial B/\\partial \\theta$ obtained from the chain rule using the known dependence $B(R(r,\\theta))$.\n\n- The guiding-center dynamics are integrated in the variables $\\left(r,\\theta,\\zeta,v_{\\parallel}\\right)$ using a fixed-step fourth-order Rungeâ€“Kutta method. Parallel motion produces advances in $\\theta$ and $\\zeta$ consistent with\n$$\n\\frac{d\\mathbf{X}}{dt}\\Big|_{\\parallel} = v_{\\parallel}\\,\\mathbf{b} = \\mathbf{t}_{\\theta}\\,\\frac{d\\theta}{dt} + \\mathbf{t}_{\\zeta}\\,\\frac{d\\zeta}{dt}.\n$$\nSolve for $\\tfrac{d\\theta}{dt}$ and $\\tfrac{d\\zeta}{dt}$ by least squares at each step using $\\mathbf{t}_{\\theta}$ and $\\mathbf{t}_{\\zeta}$, and obtain the radial drift component as\n$$\n\\frac{dr}{dt} = \\frac{\\mathbf{v}_{d}\\cdot \\mathbf{t}_{r}}{\\left\\Vert \\mathbf{t}_{r}\\right\\Vert^{2}}.\n$$\n\nDefine the banana half-width for a trapped guiding center as one half of the peak-to-peak variation of the minor radius $r$ observed between two successive parallel turning points during a single bounce interval. A parallel turning point is detected when $v_{\\parallel}$ changes sign. Initialize trapped guiding centers at the outboard midplane $\\theta = 0$ with specified energy and pitch parameter determining $\\mu$. For each case, construct a distribution of trapped particles by sampling the normalized pitch parameter $\\lambda_{\\mathrm{n}} = \\mu B_{\\min}/E$ uniformly between the trapping threshold and a high value less than unity, where $B_{\\min}$ and $B_{\\max}$ are the minimum and maximum magnetic field on the given flux surface obtained by scanning $-\\pi \\le \\theta \\le \\pi$.\n\nYour program must:\n- Implement the above guiding-center integrator and geometry.\n- For each test case, compute $B_{\\min}$ and $B_{\\max}$, define a distribution of $N$ trapped particles via $\\lambda_{\\mathrm{n}}$ samples in the interval $\\left[\\lambda_{\\mathrm{th}}+\\Delta, \\lambda_{\\mathrm{max}}\\right]$ where $\\lambda_{\\mathrm{th}} = B_{\\min}/B_{\\max}$, $\\Delta$ is a small margin, and $\\lambda_{\\mathrm{max}}$ is less than $1$.\n- For each particle, integrate until two parallel turning points are detected or a maximum integration time is reached. Compute its banana half-width as a length in $\\mathrm{m}$. Aggregate the $N$ half-widths by averaging to a single float per case.\n- Output a single line containing the list of mean banana half-widths for all test cases as a comma-separated list enclosed in square brackets, in meters.\n\nUse the following test suite, with all angles in radians and units as specified:\n- Case $1$ (baseline circular): $R_{0} = 3\\,\\mathrm{m}$, $r = 0.3\\,\\mathrm{m}$, $B_{0} = 5\\,\\mathrm{T}$, $\\kappa = 1$, $\\delta = 0$, $q_{\\mathrm{s}} = 2$, ion mass $m = 3.343\\times 10^{-27}\\,\\mathrm{kg}$, ion charge $q = 1.602\\times 10^{-19}\\,\\mathrm{C}$, speed $v = 1.5\\times 10^{6}\\,\\mathrm{m/s}$, time step $\\Delta t = 2\\times 10^{-8}\\,\\mathrm{s}$, maximum time $T_{\\max} = 3\\times 10^{-5}\\,\\mathrm{s}$, samples $N = 5$.\n- Case $2$ (elongated): $R_{0} = 3\\,\\mathrm{m}$, $r = 0.3\\,\\mathrm{m}$, $B_{0} = 5\\,\\mathrm{T}$, $\\kappa = 1.7$, $\\delta = 0$, $q_{\\mathrm{s}} = 2$, $m = 3.343\\times 10^{-27}\\,\\mathrm{kg}$, $q = 1.602\\times 10^{-19}\\,\\mathrm{C}$, $v = 1.5\\times 10^{6}\\,\\mathrm{m/s}$, $\\Delta t = 2\\times 10^{-8}\\,\\mathrm{s}$, $T_{\\max} = 3\\times 10^{-5}\\,\\mathrm{s}$, $N = 5$.\n- Case $3$ (positive triangularity): $R_{0} = 3\\,\\mathrm{m}$, $r = 0.3\\,\\mathrm{m}$, $B_{0} = 5\\,\\mathrm{T}$, $\\kappa = 1.0$, $\\delta = 0.3$, $q_{\\mathrm{s}} = 2$, $m = 3.343\\times 10^{-27}\\,\\mathrm{kg}$, $q = 1.602\\times 10^{-19}\\,\\mathrm{C}$, $v = 1.5\\times 10^{6}\\,\\mathrm{m/s}$, $\\Delta t = 2\\times 10^{-8}\\,\\mathrm{s}$, $T_{\\max} = 3\\times 10^{-5}\\,\\mathrm{s}$, $N = 5$.\n- Case $4$ (elongated and triangular): $R_{0} = 3\\,\\mathrm{m}$, $r = 0.3\\,\\mathrm{m}$, $B_{0} = 5\\,\\mathrm{T}$, $\\kappa = 1.7$, $\\delta = 0.3$, $q_{\\mathrm{s}} = 2$, $m = 3.343\\times 10^{-27}\\,\\mathrm{kg}$, $q = 1.602\\times 10^{-19}\\,\\mathrm{C}$, $v = 1.5\\times 10^{6}\\,\\mathrm{m/s}$, $\\Delta t = 2\\times 10^{-8}\\,\\mathrm{s}$, $T_{\\max} = 3\\times 10^{-5}\\,\\mathrm{s}$, $N = 5$.\n- Case $5$ (negative triangularity): $R_{0} = 3\\,\\mathrm{m}$, $r = 0.3\\,\\mathrm{m}$, $B_{0} = 5\\,\\mathrm{T}$, $\\kappa = 1.5$, $\\delta = -0.3$, $q_{\\mathrm{s}} = 2$, $m = 3.343\\times 10^{-27}\\,\\mathrm{kg}$, $q = 1.602\\times 10^{-19}\\,\\mathrm{C}$, $v = 1.5\\times 10^{6}\\,\\mathrm{m/s}$, $\\Delta t = 2\\times 10^{-8}\\,\\mathrm{s}$, $T_{\\max} = 3\\times 10^{-5}\\,\\mathrm{s}$, $N = 5$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $\\left[\\text{result}_{1},\\text{result}_{2},\\text{result}_{3},\\text{result}_{4},\\text{result}_{5}\\right]$, where each $\\text{result}_{i}$ is the mean banana half-width in $\\mathrm{m}$ for the corresponding case.",
            "solution": "The present problem requires the numerical integration of guiding-center orbits for ions in an axisymmetric tokamak plasma. The plasma geometry is described by the Miller equilibrium model, and the objective is to compute the average banana half-width for a distribution of trapped particles, analyzing its dependence on the flux surface shape parameters of elongation $\\kappa$ and triangularity $\\delta$. The solution proceeds by first establishing the complete mathematical and physical model as prescribed, then detailing the numerical algorithm, and finally implementing it to solve the specified test cases.\n\n### 1. Theoretical Framework\n\n#### 1.1. Miller Equilibrium Geometry\nThe position of a point on a given flux surface is parameterized by a minor radius $r$, poloidal angle $\\theta$, and toroidal angle $\\zeta$. In a cylindrical coordinate system $(R, \\phi, Z)$ with the Z-axis as the axis of symmetry, the position is given by:\n$$\nR(r, \\theta) = R_0 + r \\cos(\\theta + \\delta \\sin\\theta)\n$$\n$$\nZ(r, \\theta) = \\kappa r \\sin\\theta\n$$\n$$\n\\phi = \\zeta\n$$\nwhere $R_0$ is the major radius, $\\kappa$ is the elongation, and $\\delta$ is the triangularity.\nThe corresponding Cartesian coordinates $(X, Y, Z)$ are:\n$$\nX = R(r, \\theta) \\cos\\zeta, \\quad Y = R(r, \\theta) \\sin\\zeta, \\quad Z = Z(r, \\theta)\n$$\nThe local tangent vectors, which form a basis for the coordinate system, are found by differentiation:\n$\\mathbf{t}_r = \\frac{\\partial \\mathbf{X}}{\\partial r}$, $\\mathbf{t}_\\theta = \\frac{\\partial \\mathbf{X}}{\\partial \\theta}$, $\\mathbf{t}_\\zeta = \\frac{\\partial \\mathbf{X}}{\\partial \\zeta}$.\nLet $u(\\theta) = \\theta + \\delta\\sin\\theta$. The components of the tangent vectors are:\n$$\n\\mathbf{t}_r = \\begin{pmatrix} \\cos u \\cos\\zeta \\\\ \\cos u \\sin\\zeta \\\\ \\kappa \\sin\\theta \\end{pmatrix}, \\quad\n\\mathbf{t}_\\theta = \\begin{pmatrix} -r \\sin u (1+\\delta\\cos\\theta) \\cos\\zeta \\\\ -r \\sin u (1+\\delta\\cos\\theta) \\sin\\zeta \\\\ \\kappa r \\cos\\theta \\end{pmatrix}, \\quad\n\\mathbf{t}_\\zeta = \\begin{pmatrix} -R \\sin\\zeta \\\\ R \\cos\\zeta \\\\ 0 \\end{pmatrix}\n$$\nIt can be shown that $\\mathbf{t}_r \\cdot \\mathbf{t}_\\zeta = 0$ and $\\mathbf{t}_\\theta \\cdot \\mathbf{t}_\\zeta = 0$, but $\\mathbf{t}_r \\cdot \\mathbf{t}_\\theta \\neq 0$ in general. Thus, this coordinate system is not fully orthogonal.\n\n#### 1.2. Magnetic Field\nThe magnetic field magnitude is given by the simplified model $B(r, \\theta) = B_0 \\frac{R_0}{R(r, \\theta)}$, which captures the $1/R$ dependence characteristic of a toroidal field. The direction of the field $\\mathbf{b} = \\mathbf{B}/B$ is constructed as a combination of the poloidal ($\\hat{\\mathbf{e}}_\\theta$) and toroidal ($\\hat{\\mathbf{e}}_\\zeta$) unit tangent vectors, with the pitch determined by the safety factor $q_s$.\n$$\n\\mathbf{B} = B_p \\hat{\\mathbf{e}}_\\theta + B_\\zeta \\hat{\\mathbf{e}}_\\zeta = B_p \\frac{\\mathbf{t}_\\theta}{\\|\\mathbf{t}_\\theta\\|} + B_\\zeta \\frac{\\mathbf{t}_\\zeta}{\\|\\mathbf{t}_\\zeta\\|}\n$$\nUsing the large-aspect-ratio approximation for the safety factor, $q_s \\approx \\frac{r B_\\zeta}{R_0 B_p}$, and the condition that $\\|\\mathbf{B}\\|^2 = B^2 = B_p^2 + B_\\zeta^2$ (since $\\mathbf{t}_\\theta \\perp \\mathbf{t}_\\zeta$), we can solve for the components:\n$$\nB_\\zeta = \\frac{B}{\\sqrt{1 + (r/[R_0 q_s])^2}}, \\quad B_p = \\frac{r B_\\zeta}{R_0 q_s}\n$$\nThe gradient of the magnetic field magnitude, $\\nabla B$, is determined by its projections onto the tangent vectors:\n$$\n\\mathbf{t}_r \\cdot \\nabla B = \\frac{\\partial B}{\\partial r}, \\quad \\mathbf{t}_\\theta \\cdot \\nabla B = \\frac{\\partial B}{\\partial \\theta}, \\quad \\mathbf{t}_\\zeta \\cdot \\nabla B = \\frac{\\partial B}{\\partial \\zeta} = 0\n$$\nThe partial derivatives are computed via the chain rule:\n$$\n\\frac{\\partial B}{\\partial r} = \\frac{dB}{dR}\\frac{\\partial R}{\\partial r} = -\\frac{B_0 R_0}{R^2} \\cos u, \\quad \\frac{\\partial B}{\\partial \\theta} = \\frac{dB}{dR}\\frac{\\partial R}{\\partial \\theta} = \\frac{B_0 R_0}{R^2} r \\sin u (1+\\delta\\cos\\theta)\n$$\nThe vector $\\nabla B$ can then be found by solving the linear system $\\begin{pmatrix} \\mathbf{t}_r^T \\\\ \\mathbf{t}_\\theta^T \\\\ \\mathbf{t}_\\zeta^T \\end{pmatrix} \\nabla B = \\begin{pmatrix} \\partial B/\\partial r \\\\ \\partial B/\\partial \\theta \\\\ 0 \\end{pmatrix}$.\n\n#### 1.3. Guiding-Center Equations of Motion\nThe motion of the guiding center is evolved in the coordinate system $(r, \\theta, \\zeta, v_\\parallel)$. The problem specifies a particular separation of effects for determining the time derivatives:\n1.  **Radial Motion**: The change in minor radius $r$ is attributed solely to the magnetic drift velocity $\\mathbf{v}_d$. The problem statement provides a specific formula which approximates the projection of $\\mathbf{v}_d$ onto the radial direction:\n    $$\n    \\frac{dr}{dt} = \\frac{\\mathbf{v}_d \\cdot \\mathbf{t}_r}{\\|\\mathbf{t}_r\\|^2}\n    $$\n    Here, $\\mathbf{v}_d = \\frac{m}{q} \\frac{v_\\parallel^2 + v_\\perp^2/2}{B^3} (\\mathbf{B} \\times \\nabla B)$, with $v_\\perp^2 = 2\\mu B/m$. Note that this formulation for $dr/dt$ relies on the non-orthogonal tangent vector $\\mathbf{t}_r$ rather than the contravariant basis vector $\\nabla r$. This is an instruction we must follow.\n\n2.  **Parallel Motion**: The changes in the angles $\\theta$ and $\\zeta$ are determined by the parallel velocity $v_\\parallel \\mathbf{b}$.\n    $$\n    v_\\parallel \\mathbf{b} = \\frac{d\\theta}{dt} \\mathbf{t}_\\theta + \\frac{d\\zeta}{dt} \\mathbf{t}_\\zeta\n    $$\n    Solving this vector equation for the rates of change using a least-squares approach, which simplifies due to $\\mathbf{t}_\\theta \\cdot \\mathbf{t}_\\zeta=0$, yields:\n    $$\n    \\frac{d\\theta}{dt} = v_\\parallel \\frac{\\mathbf{b} \\cdot \\mathbf{t}_\\theta}{\\|\\mathbf{t}_\\theta\\|^2}, \\quad \\frac{d\\zeta}{dt} = v_\\parallel \\frac{\\mathbf{b} \\cdot \\mathbf{t}_\\zeta}{\\|\\mathbf{t}_\\zeta\\|^2}\n    $$\n\n3.  **Parallel Acceleration**: The change in parallel velocity is driven by the mirror force.\n    $$\n    \\frac{dv_\\parallel}{dt} = -\\frac{\\mu}{m} \\mathbf{b} \\cdot \\nabla B\n    $$\nThe particle's total energy $E = \\frac{1}{2}m(v_\\parallel^2 + v_\\perp^2) = \\frac{1}{2}m v^2$ and magnetic moment $\\mu = \\frac{m v_\\perp^2}{2B}$ are conserved.\n\n### 2. Numerical Implementation\n\nThe solution is implemented as a Python program utilizing the `numpy` library for vector and matrix operations.\n\n#### 2.1. Algorithm Outline\nFor each test case:\n1.  Define the geometric and physical parameters ($R_0, r, \\kappa, \\delta, B_0, q_s$, etc.).\n2.  Determine the minimum ($B_{\\min}$) and maximum ($B_{\\max}$) magnetic field strengths on the initial flux surface $r_0$ by evaluating $B(r_0, \\theta)$ over $\\theta \\in [-\\pi, \\pi]$.\n3.  Generate $N$ trapped particles by sampling the normalized pitch parameter $\\lambda_n = \\mu B_{\\min}/E$. The sampling is uniform in the range $[\\lambda_{th}+\\Delta, 1-\\Delta]$, where $\\lambda_{th} = B_{\\min}/B_{\\max}$ is the trapping threshold and $\\Delta$ is a small margin (chosen as $10^{-4}$) to avoid purely passing or marginally trapped particles.\n4.  For each particle:\n    a.  Initialize the state vector $\\mathbf{y} = [r, \\theta, \\zeta, v_\\parallel]$. The particle starts at the outboard midplane $(\\theta_0=0, \\zeta_0=0)$ on the specified flux surface $r_0$. The initial parallel velocity $v_{\\parallel,0}$ is calculated from the conserved quantities $E = \\frac{1}{2}mv^2$ and $\\mu$, given the initial magnetic field $B(r_0, \\theta_0)$.\n    b.  Integrate the system of ODEs $\\frac{d\\mathbf{y}}{dt} = \\mathbf{f}(t, \\mathbf{y})$ using the fourth-order Runge-Kutta (RK4) method with a fixed time step $\\Delta t$.\n    c.  The function $\\mathbf{f}(t, \\mathbf{y})$ encapsulates the calculation of the derivatives as detailed in Section 1.3. At each evaluation, it computes all necessary geometric quantities, the magnetic field vector $\\mathbf{B}$ and its gradient $\\nabla B$, and finally the velocity components.\n    d.  During the integration, monitor $v_\\parallel(t)$ to detect sign changes, which indicate a turning point. Also, record the values of $r(t)$.\n    e.  Stop the integration after two turning points are detected or if the maximum integration time $T_{\\max}$ is reached.\n    f.  Calculate the banana half-width for this particle as $\\Delta r_b = \\frac{1}{2}(\\max(r) - \\min(r))$ using the recorded trajectory between the two turning points.\n5.  Compute the mean of the $N$ banana half-widths.\n6.  Collect the mean half-widths for all test cases and format the output as specified.\n\n#### 2.2. Banana Half-Width\nA trapped particle, following a magnetic field line, moves between two mirror points where its parallel velocity reverses. Due to the magnetic drift, it does not return to its starting radial position, tracing a \"banana\" shape in the poloidal cross-section. The banana half-width, $\\Delta r_b$, measures half the radial extent of this orbit and is a key parameter in neoclassical transport theory. By computing this quantity for different flux surface shapes (i.e., different $\\kappa$ and $\\delta$), we can study how geometry affects this fundamental transport process.\n\nThe following code implements this entire procedure. It is structured into a class `GuidingCenterOrbit` that handles the physics and geometry for a given set of parameters, and a main `solve` function that iterates through the test cases, runs the simulations, and prints the results.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import fminbound\n\nclass GuidingCenterOrbit:\n    \"\"\"\n    Computes guiding-center orbits in a Miller equilibrium.\n    \"\"\"\n    def __init__(self, R0, r, B0, kappa, delta, qs, m, q, v, dt, T_max):\n        self.R0 = float(R0)\n        self.r = float(r)\n        self.B0 = float(B0)\n        self.kappa = float(kappa)\n        self.delta = float(delta)\n        self.qs = float(qs)\n        self.m = float(m)\n        self.q = float(q)\n        self.v = float(v)\n        self.E = 0.5 * self.m * self.v**2\n        self.dt = float(dt)\n        self.T_max = float(T_max)\n\n        self.mu = 0.0\n\n    def R_coord(self, r, theta):\n        return self.R0 + r * np.cos(theta + self.delta * np.sin(theta))\n\n    def Z_coord(self, r, theta):\n        return self.kappa * r * np.sin(theta)\n\n    def B_mag(self, r, theta):\n        R = self.R_coord(r, theta)\n        # Prevent division by zero if R is ever 0, though unlikely in a tokamak.\n        if R == 0: return np.inf\n        return self.B0 * self.R0 / R\n\n    def get_tangent_vectors(self, r, theta, zeta):\n        u = theta + self.delta * np.sin(theta)\n        cos_u, sin_u = np.cos(u), np.sin(u)\n        cos_theta, sin_theta = np.cos(theta), np.sin(theta)\n        cos_zeta, sin_zeta = np.cos(zeta), np.sin(zeta)\n        R = self.R_coord(r, theta)\n\n        t_r = np.array([cos_u * cos_zeta, cos_u * sin_zeta, self.kappa * sin_theta])\n        \n        dR_dtheta = -r * sin_u * (1 + self.delta * cos_theta)\n        dZ_dtheta = self.kappa * r * cos_theta\n        t_theta = np.array([dR_dtheta * cos_zeta, dR_dtheta * sin_zeta, dZ_dtheta])\n\n        t_zeta = np.array([-R * sin_zeta, R * cos_zeta, 0.0])\n        \n        return t_r, t_theta, t_zeta\n\n    def get_derivatives(self, y):\n        r, theta, zeta, v_parallel = y\n\n        # 1. Geometric and Magnetic field quantities\n        t_r, t_theta, t_zeta = self.get_tangent_vectors(r, theta, zeta)\n        \n        norm_t_theta_sq = np.dot(t_theta, t_theta)\n        norm_t_theta = np.sqrt(norm_t_theta_sq)\n        norm_t_zeta_sq = np.dot(t_zeta, t_zeta)\n        \n        B = self.B_mag(r, theta)\n        \n        # B vector construction\n        # Correction term for B_zeta and B_p\n        corr = np.sqrt(1 + (r / (self.R0 * self.qs))**2)\n        B_zeta_mag = B / corr\n        B_p_mag = (r * B_zeta_mag) / (self.R0 * self.qs)\n        \n        B_vec = B_p_mag * (t_theta / norm_t_theta) + B_zeta_mag * (t_zeta / np.sqrt(norm_t_zeta_sq))\n        b_hat = B_vec / B\n\n        # Gradient of B\n        u = theta + self.delta * np.sin(theta)\n        R = self.R_coord(r, theta)\n        \n        dB_dR = -self.B0 * self.R0 / R**2\n        dR_dr = np.cos(u)\n        dR_dtheta = -r * np.sin(u) * (1 + self.delta * np.cos(theta))\n        \n        dB_dr = dB_dR * dR_dr\n        dB_dtheta = dB_dR * dR_dtheta\n\n        # Solve for grad_B: M * grad_B = V\n        M = np.vstack([t_r, t_theta, t_zeta])\n        V = np.array([dB_dr, dB_dtheta, 0.0])\n        try:\n            grad_B = np.linalg.solve(M, V)\n        except np.linalg.LinAlgError:\n            grad_B = np.linalg.pinv(M) @ V\n\n        # 2. ODE right-hand-sides\n        # dv_parallel/dt\n        dv_parallel_dt = -(self.mu / self.m) * np.dot(b_hat, grad_B)\n\n        # dr/dt (from drifts)\n        v_perp_sq = 2 * self.mu * B / self.m\n        drift_factor = (self.m / self.q) * (v_parallel**2 + v_perp_sq / 2) / (B**3)\n        v_d = drift_factor * np.cross(B_vec, grad_B)\n        dr_dt = np.dot(v_d, t_r) / np.dot(t_r, t_r)\n\n        # d_theta/dt, d_zeta/dt (from parallel motion)\n        # Based on least squares solution which simplifies due to t_theta . t_zeta = 0\n        dtheta_dt = v_parallel * np.dot(b_hat, t_theta) / norm_t_theta_sq\n        dzeta_dt = v_parallel * np.dot(b_hat, t_zeta) / norm_t_zeta_sq\n        \n        return np.array([dr_dt, dtheta_dt, dzeta_dt, dv_parallel_dt])\n\n    def rk4_step(self, y):\n        k1 = self.get_derivatives(y)\n        k2 = self.get_derivatives(y + 0.5 * self.dt * k1)\n        k3 = self.get_derivatives(y + 0.5 * self.dt * k2)\n        k4 = self.get_derivatives(y + self.dt * k3)\n        return y + (self.dt / 6.0) * (k1 + 2*k2 + 2*k3 + k4)\n\n    def run_particle(self, lambda_n):\n        B_min_func = lambda theta: -self.B_mag(self.r, theta) # Negate for minimization\n        res = fminbound(B_min_func, -np.pi, np.pi)\n        B_min = -B_min_func(res)\n        self.mu = lambda_n * self.E / B_min\n\n        # Initial state\n        r_init, theta_init, zeta_init = self.r, 0.0, 0.0\n        B_init = self.B_mag(r_init, theta_init)\n        v_perp_sq_init = 2 * self.mu * B_init / self.m\n        \n        if self.v**2  v_perp_sq_init: # Should not happen with valid lambda_n\n            return 0.0\n            \n        v_parallel_init = np.sqrt(self.v**2 - v_perp_sq_init)\n        y = np.array([r_init, theta_init, zeta_init, v_parallel_init])\n\n        r_history = [r_init]\n        v_parallel_history = [v_parallel_init]\n        t = 0.0\n        turning_points = 0\n        \n        while t  self.T_max and turning_points  2:\n            y_new = self.rk4_step(y)\n            y = y_new\n            \n            # Normalize theta\n            y[1] = (y[1] + np.pi) % (2 * np.pi) - np.pi\n            \n            r_history.append(y[0])\n            \n            if np.sign(y[3]) != np.sign(v_parallel_history[-1]):\n                turning_points += 1\n                if turning_points == 1: # reset history after first turning point\n                    r_history = [y[0]]\n\n            v_parallel_history.append(y[3])\n            t += self.dt\n\n        if not r_history or len(r_history)  2:\n            return 0.0\n\n        return 0.5 * (np.max(r_history) - np.min(r_history))\n\n    def compute_mean_banana_half_width(self, N_samples):\n        B_min_func = lambda theta: -self.B_mag(self.r, theta) # Negate for minimization\n        res_min = fminbound(B_min_func, -np.pi, np.pi)\n        B_min = -B_min_func(res_min)\n\n        B_max_func = lambda theta: self.B_mag(self.r, theta)\n        res_max = fminbound(lambda th: -B_max_func(th), -np.pi, np.pi)\n        B_max = B_max_func(res_max)\n\n        lambda_th = B_min / B_max\n        delta_lambda = 1e-4\n        lambda_min_sample = lambda_th + delta_lambda\n        lambda_max_sample = 1.0 - delta_lambda\n\n        if lambda_min_sample >= lambda_max_sample:\n            return 0.0 # No trapped particles to sample\n        \n        lambdas_n = np.linspace(lambda_min_sample, lambda_max_sample, N_samples)\n        \n        half_widths = []\n        for lambda_n in lambdas_n:\n            width = self.run_particle(lambda_n)\n            if width > 0:\n                half_widths.append(width)\n        \n        if not half_widths:\n            return 0.0\n        \n        return np.mean(half_widths)\n\ndef solve():\n    test_cases = [\n        # R0, r, B0, kappa, delta, qs\n        {'R0': 3.0, 'r': 0.3, 'B0': 5.0, 'kappa': 1.0, 'delta': 0.0, 'qs': 2.0},\n        {'R0': 3.0, 'r': 0.3, 'B0': 5.0, 'kappa': 1.7, 'delta': 0.0, 'qs': 2.0},\n        {'R0': 3.0, 'r': 0.3, 'B0': 5.0, 'kappa': 1.0, 'delta': 0.3, 'qs': 2.0},\n        {'R0': 3.0, 'r': 0.3, 'B0': 5.0, 'kappa': 1.7, 'delta': 0.3, 'qs': 2.0},\n        {'R0': 3.0, 'r': 0.3, 'B0': 5.0, 'kappa': 1.5, 'delta': -0.3, 'qs': 2.0},\n    ]\n\n    common_params = {\n        'm': 3.343e-27,     # Deuterium mass in kg\n        'q': 1.602e-19,     # Elementary charge in C\n        'v': 1.5e6,         # Ion speed in m/s\n        'dt': 2e-8,         # Time step in s\n        'T_max': 3e-5,      # Max integration time in s\n        'N_samples': 5\n    }\n\n    results = []\n    for case_params in test_cases:\n        params = {**case_params, **common_params}\n        orbit_solver = GuidingCenterOrbit(\n            R0=params['R0'], r=params['r'], B0=params['B0'], kappa=params['kappa'],\n            delta=params['delta'], qs=params['qs'], m=params['m'], q=params['q'],\n            v=params['v'], dt=params['dt'], T_max=params['T_max']\n        )\n        mean_width = orbit_solver.compute_mean_banana_half_width(params['N_samples'])\n        results.append(f\"{mean_width:.8f}\")\n\n    print(f\"[{','.join(results)}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}