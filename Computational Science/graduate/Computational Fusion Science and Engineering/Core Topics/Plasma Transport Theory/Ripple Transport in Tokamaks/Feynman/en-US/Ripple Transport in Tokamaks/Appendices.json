{
    "hands_on_practices": [
        {
            "introduction": "The first step in studying any transport mechanism is to develop a quantitative model for its underlying cause. This practice guides you through deriving a standard model for the toroidal field ripple amplitude from first principles of magnetostatics and implementing it in code. By benchmarking your model against representative data from real-world tokamaks, you will gain hands-on experience in the crucial scientific cycle of model derivation, implementation, and validation .",
            "id": "4041617",
            "problem": "You are tasked with constructing, from first principles, a computational model for the toroidal-field ripple amplitude profile in tokamaks and benchmarking it against representative measured profiles for two devices: the Joint European Torus (JET) and the Japan Tokamak-60 Upgrade (JT-60U). The ripple amplitude is the relative variation of the toroidal magnetic field due to the discrete number of toroidal field coils, and it is observed to increase towards the plasma edge. The comparison must be performed as a function of the normalized minor radius $r/a$, where $r$ is the minor radius and $a$ is the minor radius at the plasma boundary.\n\nStart from magnetostatics in vacuum, invoking Maxwell's equations in the absence of currents inside the analyzed region, namely $\\nabla \\times \\mathbf{B} = \\mathbf{0}$ and $\\nabla \\cdot \\mathbf{B} = \\mathbf{0}$, which allow one to introduce a magnetic scalar potential $\\Phi$ satisfying the Laplace equation $\\nabla^2 \\Phi = 0$. Model the toroidal device as a locally cylindrical domain of radius $a$ and approximate the toroidal periodicity imposed by a discrete number of toroidal field coils $N_{\\mathrm{TF}}$ as a harmonic boundary condition in the toroidal direction characterized by an effective axial wavenumber, recognizing that the solution for the radial dependence in such a cylindrical approximation arises from separation of variables and involves modified Bessel functions. Use this framework to derive a dimensionless model for the ripple amplitude profile $\\delta(r/a)$ that depends on $N_{\\mathrm{TF}}$, the major radius $R_0$, and the minor radius $a$, and that recovers the given edge ripple amplitude at $r/a = 1$.\n\nYou are provided with measured ripple amplitude data as functions of $r/a$ for two devices (JET and JT-60U). Treat these measured values as representative digitizations of published behavior and use them to quantitatively assess your model. You must:\n\n1. Derive the model expression for the ripple amplitude $\\delta(r/a)$ under the cylindrical vacuum approximation described above.\n2. Implement the derived expression in code to compute the predicted ripple amplitude profile for each device at the given $r/a$ points.\n3. Compute the root-mean-square error (RMSE) and the maximum absolute error between your model predictions and the measured values for each device.\n4. Determine whether the model \"passes\" for each device by checking if the RMSE is below a device-specific tolerance.\n\nAll lengths must be expressed in meters. Ripple amplitude is dimensionless. Angles do not appear directly in the computation and therefore no angle unit specification is required. The normalized radius $r/a$ is dimensionless.\n\nUse the following test suite of device parameters and measured data:\n\n- Device $1$ (JET):\n    - $N_{\\mathrm{TF}} = 32$, $R_0 = 2.96\\,\\mathrm{m}$, $a = 1.25\\,\\mathrm{m}$.\n    - Edge ripple amplitude parameter $\\delta_a = 0.0065$ (dimensionless).\n    - $r/a$ points: $[0.0, 0.2, 0.4, 0.6, 0.8, 0.95]$.\n    - Measured $\\delta$ at these points: $[0.00005, 0.00030, 0.00090, 0.00210, 0.00460, 0.00580]$.\n    - RMSE tolerance: $0.0015$.\n- Device $2$ (JT-60U):\n    - $N_{\\mathrm{TF}} = 18$, $R_0 = 3.00\\,\\mathrm{m}$, $a = 1.00\\,\\mathrm{m}$.\n    - Edge ripple amplitude parameter $\\delta_a = 0.0160$ (dimensionless).\n    - $r/a$ points: $[0.0, 0.2, 0.4, 0.6, 0.8, 0.95]$.\n    - Measured $\\delta$ at these points: $[0.00020, 0.00080, 0.00250, 0.00650, 0.01200, 0.01450]$.\n    - RMSE tolerance: $0.0030$.\n- Device $3$ (SymmTok, synthetic idealized symmetric reference):\n    - $N_{\\mathrm{TF}} = 360$, $R_0 = 3.00\\,\\mathrm{m}$, $a = 1.00\\,\\mathrm{m}$.\n    - Edge ripple amplitude parameter $\\delta_a = 0.0000$ (dimensionless).\n    - $r/a$ points: $[0.0, 0.25, 0.50, 0.75, 1.00]$.\n    - Measured $\\delta$ at these points: $[0.0, 0.0, 0.0, 0.0, 0.0]$.\n    - RMSE tolerance: $1\\times 10^{-12}$.\n\nYour program must compute, for each device, the RMSE and maximum absolute error, and then evaluate a boolean pass/fail using the specified tolerance. The final program output must be a single line containing a comma-separated list enclosed in square brackets with the following nine entries in this order:\n[RMSE for JET, RMSE for JT-60U, RMSE for SymmTok, max error for JET, max error for JT-60U, max error for SymmTok, pass for JET, pass for JT-60U, pass for SymmTok].\n\nAll numerical outputs must be raw floats and booleans. No additional text should be printed.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., [result1, result2, result3]).",
            "solution": "The problem is assessed as valid as it is scientifically grounded in magnetostatics, well-posed with sufficient and consistent data, and objectively formulated. The solution proceeds by first deriving the theoretical model for the toroidal field ripple amplitude and then implementing it computationally to analyze the provided data.\n\n### 1. Derivation of the Ripple Amplitude Model\n\nThe derivation begins from the fundamental principles of magnetostatics in a source-free region as specified. Inside the plasma volume, we assume a vacuum field with no currents, so Maxwell's equations simplify to $\\nabla \\times \\mathbf{B} = \\mathbf{0}$ and $\\nabla \\cdot \\mathbf{B} = \\mathbf{0}$. The curl-free condition on the magnetic field $\\mathbf{B}$ allows us to define a magnetic scalar potential $\\Phi$ such that $\\mathbf{B} = -\\nabla \\Phi$. Substituting this into the divergence-free condition yields Laplace's equation for the potential:\n$$ \\nabla^2 \\Phi = 0 $$\nThe problem instructs us to model the toroidal plasma as a locally cylindrical domain. We use cylindrical coordinates $(r, \\theta, z)$, where $r$ is the minor radius, $\\theta$ is the poloidal angle, and $z$ represents the toroidal direction. The ripple is a perturbation that varies with the minor radius $r$ and the toroidal coordinate $z$, but can be assumed to be independent of the poloidal angle $\\theta$ for this simplified model (i.e., $\\partial/\\partial\\theta = 0$). The Laplacian operator in these coordinates simplifies to:\n$$ \\nabla^2 \\Phi = \\frac{1}{r} \\frac{\\partial}{\\partial r} \\left( r \\frac{\\partial \\Phi}{\\partial r} \\right) + \\frac{\\partial^2 \\Phi}{\\partial z^2} = 0 $$\nWe seek a solution for the ripple potential $\\Phi(r, z)$ using the method of separation of variables, assuming a solution of the form $\\Phi(r, z) = R(r)Z(z)$. Substituting this into the equation and separating the variables yields:\n$$ \\frac{1}{r R(r)} \\frac{d}{dr} \\left( r \\frac{dR}{dr} \\right) = -\\frac{1}{Z(z)} \\frac{d^2 Z}{dz^2} = k^2 $$\nwhere $k^2$ is the separation constant.\n\nThe axial equation is:\n$$ \\frac{d^2 Z}{dz^2} + k^2 Z = 0 $$\nThe ripple is caused by the $N_{\\mathrm{TF}}$ discrete toroidal field coils distributed over a toroidal circumference of approximately $2\\pi R_0$. This imposes a periodicity on the field. The fundamental wavelength of this periodic structure in the toroidal direction is $\\lambda_z = 2\\pi R_0 / N_{\\mathrm{TF}}$. The corresponding wavenumber is $k = 2\\pi/\\lambda_z = N_{\\mathrm{TF}}/R_0$. The solution for $Z(z)$ is a harmonic function, which we can write as $Z(z) \\propto \\cos(kz)$.\n\nThe radial equation is:\n$$ \\frac{1}{r} \\frac{d}{dr} \\left( r \\frac{dR}{dr} \\right) - k^2 R(r) = 0 $$\nMultiplying by $r^2$ gives the standard form of the modified Bessel equation of order zero:\n$$ r^2 \\frac{d^2 R}{dr^2} + r \\frac{dR}{dr} - (kr)^2 R = 0 $$\nThe general solution is a linear combination of the modified Bessel functions of the first kind ($I_0$) and second kind ($K_0$):\n$$ R(r) = C_1 I_0(kr) + C_2 K_0(kr) $$\nFor the solution to be physically valid within the plasma column ($0 \\le r \\le a$), it must remain finite at the axis ($r=0$). The function $K_0(x)$ diverges as $x \\to 0$, while $I_0(x)$ is finite ($I_0(0)=1$). Therefore, we must set $C_2=0$, and the radial solution is $R(r) \\propto I_0(kr)$.\n\nCombining the radial and axial solutions, the ripple potential has the form:\n$$ \\Phi(r, z) = C \\cdot I_0(kr) \\cos(kz) $$\nwhere $C$ is a constant. The ripple is the variation in the toroidal magnetic field, which in this coordinate system is the $z$-component, $B_z$. The ripple field $\\tilde{B}_z$ is the part that varies with $z$:\n$$ \\tilde{B}_z = -\\frac{\\partial \\Phi}{\\partial z} = C k I_0(kr) \\sin(kz) $$\nThe total toroidal field is $B_z(r, z) = B_{z,\\text{avg}}(r) + \\tilde{B}_z(r, z)$. The ripple amplitude $\\delta$ is defined as the relative variation:\n$$ \\delta(r) = \\frac{B_{z,\\max}(r) - B_{z,\\min}(r)}{B_{z,\\max}(r) + B_{z,\\min}(r)} $$\nThe maximum and minimum fields at a given radius $r$ occur when $\\sin(kz) = \\pm 1$. Thus, $B_{z,\\max/min} = B_{z,\\text{avg}} \\pm C k I_0(kr)$. Substituting these into the definition of $\\delta$ gives:\n$$ \\delta(r) = \\frac{(B_{z,\\text{avg}} + C k I_0(kr)) - (B_{z,\\text{avg}} - C k I_0(kr))}{(B_{z,\\text{avg}} + C k I_0(kr)) + (B_{z,\\text{avg}} - C k I_0(kr))} = \\frac{2 C k I_0(kr)}{2 B_{z,\\text{avg}}} \\propto I_0(kr) $$\nThe ripple amplitude at a minor radius $r$ is directly proportional to $I_0(kr)$. Let's write this as $\\delta(r) = C' I_0(kr)$.\nThe constant of proportionality $C'$ is determined by the boundary condition provided: at the plasma edge ($r=a$), the ripple is $\\delta(a) = \\delta_a$.\n$$ \\delta_a = C' I_0(ka) \\implies C' = \\frac{\\delta_a}{I_0(ka)} $$\nSubstituting $C'$ back gives the final model for the ripple profile:\n$$ \\delta(r) = \\delta_a \\frac{I_0(kr)}{I_0(ka)} $$\nFinally, we express this in terms of the given parameters and the normalized minor radius $\\rho = r/a$. With $k = N_{\\mathrm{TF}}/R_0$ and $r = \\rho a$, the argument of the Bessel function becomes $kr = (\\frac{N_{\\mathrm{TF}}}{R_0})(\\rho a) = \\rho \\frac{N_{\\mathrm{TF}}a}{R_0}$.\nThe derived model to be implemented is:\n$$ \\delta(\\rho) = \\delta_a \\frac{I_0(\\rho \\cdot N_{\\mathrm{TF}}a/R_0)}{I_0(N_{\\mathrm{TF}}a/R_0)} $$\n\n### 2. Computational Implementation and Error Analysis\n\nThe derived formula is implemented in a Python script. For each device, we perform the following steps:\n1.  Define the device parameters: number of coils $N_{\\mathrm{TF}}$, major radius $R_0$, minor radius $a$, and edge ripple $\\delta_a$.\n2.  Calculate the constant dimensionless argument for the Bessel function at the edge, $\\alpha = N_{\\mathrm{TF}}a/R_0$.\n3.  For each given normalized radius point $\\rho_i = (r/a)_i$, compute the predicted ripple amplitude $\\delta_{\\text{pred},i}$ using the model: $\\delta_{\\text{pred},i} = \\delta_a \\cdot I_0(\\rho_i \\alpha) / I_0(\\alpha)$. The function `scipy.special.i0` is used for the modified Bessel function $I_0(x)$.\n4.  The special case of SymmTok with $\\delta_a=0$ is handled directly, yielding a predicted ripple of $0$ everywhere, as expected.\n5.  With the array of predicted values $\\delta_{\\text{pred}}$ and the array of measured values $\\delta_{\\text{meas}}$, the errors are calculated.\n6.  The root-mean-square error (RMSE) is computed as $\\text{RMSE} = \\sqrt{\\frac{1}{N} \\sum_{i=1}^{N} (\\delta_{\\text{pred},i} - \\delta_{\\text{meas},i})^2}$, where $N$ is the number of data points.\n7.  The maximum absolute error is computed as $\\max_i |\\delta_{\\text{pred},i} - \\delta_{\\text{meas},i}|$.\n8.  A boolean pass/fail status is determined by comparing the calculated RMSE against the specified device-specific tolerance: `pass = RMSE < tolerance`.\nThe results for all three devices are collected and formatted into a single output line as requested.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import i0\n\ndef solve():\n    \"\"\"\n    Computes ripple amplitude profiles for tokamaks based on a cylindrical model,\n    and benchmarks them against measured data.\n    \"\"\"\n    test_cases = [\n        {\n            \"name\": \"JET\",\n            \"N_TF\": 32,\n            \"R0\": 2.96,\n            \"a\": 1.25,\n            \"delta_a\": 0.0065,\n            \"rho_points\": np.array([0.0, 0.2, 0.4, 0.6, 0.8, 0.95]),\n            \"delta_measured\": np.array([0.00005, 0.00030, 0.00090, 0.00210, 0.00460, 0.00580]),\n            \"rmse_tolerance\": 0.0015\n        },\n        {\n            \"name\": \"JT-60U\",\n            \"N_TF\": 18,\n            \"R0\": 3.00,\n            \"a\": 1.00,\n            \"delta_a\": 0.0160,\n            \"rho_points\": np.array([0.0, 0.2, 0.4, 0.6, 0.8, 0.95]),\n            \"delta_measured\": np.array([0.00020, 0.00080, 0.00250, 0.00650, 0.01200, 0.01450]),\n            \"rmse_tolerance\": 0.0030\n        },\n        {\n            \"name\": \"SymmTok\",\n            \"N_TF\": 360,\n            \"R0\": 3.00,\n            \"a\": 1.00,\n            \"delta_a\": 0.0,\n            \"rho_points\": np.array([0.0, 0.25, 0.50, 0.75, 1.00]),\n            \"delta_measured\": np.array([0.0, 0.0, 0.0, 0.0, 0.0]),\n            \"rmse_tolerance\": 1e-12\n        }\n    ]\n\n    results_rmse = []\n    results_max_err = []\n    results_pass_fail = []\n\n    for case in test_cases:\n        # Unpack data for the current device\n        N_TF = case[\"N_TF\"]\n        R0 = case[\"R0\"]\n        a = case[\"a\"]\n        delta_a = case[\"delta_a\"]\n        rho_points = case[\"rho_points\"]\n        delta_measured = case[\"delta_measured\"]\n        rmse_tolerance = case[\"rmse_tolerance\"]\n\n        # The derived model is delta(rho) = delta_a * I_0(rho * alpha) / I_0(alpha)\n        # where alpha = N_TF * a / R0\n        \n        # Handle the trivial case where edge ripple is zero to avoid division by zero\n        # if I_0(alpha) becomes huge and delta_a is zero.\n        if delta_a == 0.0:\n            delta_predicted = np.zeros_like(rho_points)\n        else:\n            # Dimensionless argument for the Bessel function\n            alpha = (N_TF * a) / R0\n            \n            # The value of I_0 at the edge (r=a, so rho=1)\n            I0_at_a = i0(alpha)\n            \n            # Arguments for I_0 at each evaluation point\n            bessel_args = rho_points * alpha\n            \n            # Values of I_0 at each evaluation point\n            I0_at_r = i0(bessel_args)\n            \n            # Calculate the predicted ripple profile\n            delta_predicted = delta_a * I0_at_r / I0_at_a\n\n        # Calculate errors\n        errors = delta_predicted - delta_measured\n        \n        # Calculate Root-Mean-Square Error (RMSE)\n        rmse = np.sqrt(np.mean(np.square(errors)))\n        \n        # Calculate Maximum Absolute Error\n        max_abs_error = np.max(np.abs(errors))\n        \n        # Determine if the model passes based on the RMSE tolerance\n        is_pass = rmse  rmse_tolerance\n\n        # Store results\n        results_rmse.append(rmse)\n        results_max_err.append(max_abs_error)\n        results_pass_fail.append(is_pass)\n    \n    # Combine all results into a single list as per the problem specification\n    final_results = results_rmse + results_max_err + results_pass_fail\n    \n    # Format the final output string exactly as required\n    output_string = f\"[{','.join(map(str, final_results))}]\"\n\n    print(output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "Once the structure of the rippled magnetic field is understood, we can analyze its direct impact on particle motion. This exercise focuses on the grad-B drift, a primary driver of ripple transport, by guiding you through an analytical derivation in Boozer coordinates. This practice will strengthen your ability to connect the geometry of the magnetic field to the concrete dynamics of particle transport, a fundamental skill in fusion plasma theory .",
            "id": "4041646",
            "problem": "Consider a large-aspect-ratio, circular-cross-section tokamak with major radius $R_0$ and minor radius $r$, embedded in cylindrical coordinates $(R,\\phi,Z)$ with the standard mapping $R = R_0 + r \\cos\\theta$ and $Z = r \\sin\\theta$, where $\\theta$ is the geometric poloidal angle. Work in Boozer coordinates $(\\psi,\\theta,\\phi_B)$, where the Boozer toroidal angle $\\phi_B$ is aligned with the geometric toroidal angle $\\phi$ to leading order in $r/R_0$, and the poloidal flux label $\\psi$ is related to the minor radius by $\\psi = \\frac{1}{2} B_0 R_0 r^2$, with $B_0$ the on-axis toroidal magnetic field. Assume the safety factor $q_s$ is constant on flux surfaces. The magnetic field strength is modeled by a dominant toroidal field with poloidal variation due to toroidal curvature and a small toroidal-field ripple due to a finite number $N$ of Toroidal Field (TF) coils:\n$$\nB(R,\\theta,\\phi_B) \\approx \\frac{B_0 R_0}{R}\\left(1 + \\delta \\cos(N\\phi_B)\\right),\n$$\nwhere $0  \\delta \\ll 1$ and angles are in radians. Work consistently to leading order in the small parameters $\\delta$ and $r/R_0$, neglecting all products of small parameters.\n\nTasks:\n1. Using the above geometric mapping and the flux-radius relation for $\\psi$, compute the metric coefficients $g_{ij}$ in Boozer coordinates $(\\psi,\\theta,\\phi_B)$ to leading order in $r/R_0$. Explicitly state the nonzero components.\n2. From first principles of differential geometry in orthogonal curvilinear coordinates, construct the gradient $\\nabla B$ in the orthonormal basis aligned with $(\\psi,\\theta,\\phi_B)$ at leading order, identifying the components that arise from poloidal variation and toroidal ripple.\n3. Using the guiding-center theory for the grad-$B$ drift, where the grad-$B$ drift velocity is\n$$\n\\mathbf{v}_{\\nabla B} = \\frac{\\mu}{q_p B^2}\\,\\mathbf{B}\\times\\nabla B,\n$$\nwith magnetic moment $\\mu$ and particle charge $q_p$, determine the radial component $v_{\\nabla B,r} = \\mathbf{v}_{\\nabla B}\\cdot \\hat{\\mathbf{e}}_r$ at the outboard midplane ($\\theta=0$) and at the toroidal location of maximal ripple-induced gradient ($N\\phi_B = \\frac{\\pi}{2}$). Model the magnetic field vector to leading order as $\\mathbf{B} \\approx B_\\phi \\,\\hat{\\mathbf{e}}_\\phi + B_\\theta \\,\\hat{\\mathbf{e}}_\\theta$ with $B_\\phi \\approx B_0$ and $B_\\theta \\approx \\frac{B_0 r}{q_s R_0}$, and use $R \\approx R_0$ and $B \\approx B_0$ at the evaluation point. Express the final radial drift velocity in meters per second.\nYour final answer must be a single closed-form analytic expression. No numerical evaluation is required.",
            "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n### Step 1: Extract Givens\n- Tokamak geometry: Large-aspect-ratio, circular-cross-section.\n- Major radius: $R_0$.\n- Minor radius: $r$.\n- Coordinate mapping: $R = R_0 + r \\cos\\theta$, $Z = r \\sin\\theta$ relate cylindrical coordinates $(R,\\phi,Z)$ to geometric poloidal angle $\\theta$.\n- Boozer coordinates: $(\\psi, \\theta, \\phi_B)$.\n- Toroidal angle alignment: $\\phi_B \\approx \\phi$ to leading order in $r/R_0$.\n- Poloidal angle alignment: The Boozer poloidal angle $\\theta$ is identified with the geometric poloidal angle $\\theta$.\n- Flux-radius relation: $\\psi = \\frac{1}{2} B_0 R_0 r^2$.\n- On-axis toroidal field: $B_0$.\n- Safety factor: $q_s$, constant on flux surfaces.\n- Magnetic field strength model: $B(R, \\theta, \\phi_B) \\approx \\frac{B_0 R_0}{R}\\left(1 + \\delta \\cos(N\\phi_B)\\right)$.\n- Ripple parameters: $0  \\delta \\ll 1$, $N$ is the number of TF coils.\n- Approximation: Work to leading order in $\\delta$ and $r/R_0$, neglecting products of small parameters.\n- Task 1: Compute metric coefficients $g_{ij}$ in Boozer coordinates $(\\psi, \\theta, \\phi_B)$ to leading order in $r/R_0$.\n- Task 2: Construct $\\nabla B$ in the orthonormal basis aligned with $(\\psi, \\theta, \\phi_B)$ at leading order.\n- Task 3: Determine the radial grad-$B$ drift velocity $v_{\\nabla B,r} = \\mathbf{v}_{\\nabla B}\\cdot \\hat{\\mathbf{e}}_r$ at the outboard midplane ($\\theta=0$) and at $N\\phi_B = \\frac{\\pi}{2}$.\n- Grad-$B$ drift velocity: $\\mathbf{v}_{\\nabla B} = \\frac{\\mu}{q_p B^2}\\,\\mathbf{B}\\times\\nabla B$.\n- Magnetic moment: $\\mu$.\n- Particle charge: $q_p$.\n- Magnetic field vector model for Task 3: $\\mathbf{B} \\approx B_\\phi \\,\\hat{\\mathbf{e}}_\\phi + B_\\theta \\,\\hat{\\mathbf{e}}_\\theta$ with $B_\\phi \\approx B_0$ and $B_\\theta \\approx \\frac{B_0 r}{q_s R_0}$.\n- Approximations for Task 3 evaluation: $R \\approx R_0$ and $B \\approx B_0$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded in the established theory of plasma physics in tokamaks, specifically guiding-center motion and neoclassical transport. The geometric and magnetic field models are standard approximations for large-aspect-ratio, circular tokamaks. The problem is well-posed, providing sufficient information and clear objectives for each task. The language is objective and uses standard terminology. The approximations are clearly stated, defining a path to a unique solution within this framework. No scientific flaws, contradictions, or ambiguities are present.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\n\n**Task 1: Metric Coefficients**\n\nThe position vector $\\mathbf{x}$ in Cartesian coordinates $(x,y,z)$ is given by:\n$$\n\\mathbf{x} = (R \\cos\\phi, R \\sin\\phi, Z)\n$$\nUsing the provided mappings $R=R_0+r\\cos\\theta$, $Z=r\\sin\\theta$, and $\\phi_B \\approx \\phi$, we express $\\mathbf{x}$ in terms of $(\\psi, \\theta, \\phi_B)$:\n$$\n\\mathbf{x}(\\psi, \\theta, \\phi_B) = \\left( (R_0 + r(\\psi)\\cos\\theta)\\cos\\phi_B, (R_0 + r(\\psi)\\cos\\theta)\\sin\\phi_B, r(\\psi)\\sin\\theta \\right)\n$$\nwhere $r(\\psi) = \\sqrt{\\frac{2\\psi}{B_0 R_0}}$ from the flux-radius relation.\n\nThe covariant basis vectors $\\mathbf{e}_i = \\frac{\\partial \\mathbf{x}}{\\partial u^i}$ for coordinates $u^i = (\\psi, \\theta, \\phi_B)$ are:\n$$\n\\mathbf{e}_\\psi = \\frac{\\partial \\mathbf{x}}{\\partial r}\\frac{\\partial r}{\\partial \\psi} \\quad, \\quad \\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{x}}{\\partial \\theta} \\quad, \\quad \\mathbf{e}_{\\phi_B} = \\frac{\\partial \\mathbf{x}}{\\partial \\phi_B}\n$$\nFirst, we find $\\frac{\\partial r}{\\partial \\psi} = \\frac{d}{d\\psi}\\left(\\sqrt{\\frac{2\\psi}{B_0 R_0}}\\right) = \\frac{1}{2\\sqrt{\\frac{2\\psi}{B_0 R_0}}} \\frac{2}{B_0 R_0} = \\frac{1}{r B_0 R_0}$.\nThe partial derivatives of $\\mathbf{x}$ are:\n$$\n\\frac{\\partial \\mathbf{x}}{\\partial r} = (\\cos\\theta\\cos\\phi_B, \\cos\\theta\\sin\\phi_B, \\sin\\theta)\n$$\n$$\n\\frac{\\partial \\mathbf{x}}{\\partial \\theta} = (-r\\sin\\theta\\cos\\phi_B, -r\\sin\\theta\\sin\\phi_B, r\\cos\\theta)\n$$\n$$\n\\frac{\\partial \\mathbf{x}}{\\partial \\phi_B} = (-(R_0+r\\cos\\theta)\\sin\\phi_B, (R_0+r\\cos\\theta)\\cos\\phi_B, 0)\n$$\nThus, the basis vectors are:\n$$\n\\mathbf{e}_\\psi = \\frac{1}{r B_0 R_0}(\\cos\\theta\\cos\\phi_B, \\cos\\theta\\sin\\phi_B, \\sin\\theta)\n$$\n$$\n\\mathbf{e}_\\theta = (-r\\sin\\theta\\cos\\phi_B, -r\\sin\\theta\\sin\\phi_B, r\\cos\\theta)\n$$\n$$\n\\mathbf{e}_{\\phi_B} = (-R\\sin\\phi_B, R\\cos\\phi_B, 0) \\quad \\text{where } R=R_0+r\\cos\\theta\n$$\nThe metric coefficients are $g_{ij} = \\mathbf{e}_i \\cdot \\mathbf{e}_j$. The coordinate system is orthogonal, so $g_{ij}=0$ for $i \\neq j$. We compute the diagonal components:\n$$\ng_{\\psi\\psi} = \\mathbf{e}_\\psi \\cdot \\mathbf{e}_\\psi = \\left(\\frac{1}{r B_0 R_0}\\right)^2 (\\cos^2\\theta(\\cos^2\\phi_B+\\sin^2\\phi_B) + \\sin^2\\theta) = \\frac{1}{r^2 B_0^2 R_0^2}\n$$\n$$\ng_{\\theta\\theta} = \\mathbf{e}_\\theta \\cdot \\mathbf{e}_\\theta = r^2\\sin^2\\theta(\\cos^2\\phi_B+\\sin^2\\phi_B) + r^2\\cos^2\\theta = r^2\n$$\n$$\ng_{\\phi_B\\phi_B} = \\mathbf{e}_{\\phi_B} \\cdot \\mathbf{e}_{\\phi_B} = R^2\\sin^2\\phi_B + R^2\\cos^2\\phi_B = R^2 = (R_0+r\\cos\\theta)^2\n$$\nTo leading order in $r/R_0$, we keep the dominant terms. For $g_{\\phi_B\\phi_B}$, we retain the first-order correction as it is physically significant: $g_{\\phi_B\\phi_B} \\approx R_0^2(1+2\\frac{r}{R_0}\\cos\\theta)$. However, for subsequent calculations, often only the zeroth-order term $R_0^2$ is needed for consistency. Let's list the leading-order terms:\n$g_{\\psi\\psi} = \\frac{1}{r^2 B_0^2 R_0^2}$, $g_{\\theta\\theta} = r^2$, and $g_{\\phi_B\\phi_B} \\approx R_0^2$.\nThe non-zero metric coefficients are $g_{\\psi\\psi}$, $g_{\\theta\\theta}$, and $g_{\\phi_B\\phi_B}$.\n\n**Task 2: Gradient of Magnetic Field Strength**\n\nIn an orthogonal coordinate system $(\\psi, \\theta, \\phi_B)$, the gradient of a scalar $B$ is:\n$$\n\\nabla B = \\frac{1}{h_\\psi}\\frac{\\partial B}{\\partial \\psi}\\hat{\\mathbf{e}}_\\psi + \\frac{1}{h_\\theta}\\frac{\\partial B}{\\partial \\theta}\\hat{\\mathbf{e}}_\\theta + \\frac{1}{h_{\\phi_B}}\\frac{\\partial B}{\\partial \\phi_B}\\hat{\\mathbf{e}}_{\\phi_B}\n$$\nwhere $h_i = \\sqrt{g_{ii}}$ are the scale factors and $\\hat{\\mathbf{e}}_i$ form the orthonormal basis.\n$$\nh_\\psi = \\sqrt{g_{\\psi\\psi}} = \\frac{1}{r B_0 R_0} \\quad, \\quad h_\\theta = \\sqrt{g_{\\theta\\theta}} = r \\quad, \\quad h_{\\phi_B} = \\sqrt{g_{\\phi_B\\phi_B}} = R_0+r\\cos\\theta \\approx R_0\n$$\nThe magnetic field strength is $B \\approx \\frac{B_0 R_0}{R}(1 + \\delta \\cos(N\\phi_B))$. We expand $1/R$ for $r/R_0 \\ll 1$:\n$$\n\\frac{1}{R} = \\frac{1}{R_0+r\\cos\\theta} = \\frac{1}{R_0(1+\\frac{r}{R_0}\\cos\\theta)} \\approx \\frac{1}{R_0}\\left(1-\\frac{r}{R_0}\\cos\\theta\\right)\n$$\nSubstituting this into the expression for $B$:\n$$\nB \\approx \\frac{B_0 R_0}{R_0}\\left(1-\\frac{r}{R_0}\\cos\\theta\\right)(1 + \\delta \\cos(N\\phi_B)) \\approx B_0\\left(1 - \\frac{r}{R_0}\\cos\\theta + \\delta\\cos(N\\phi_B)\\right)\n$$\nWe have neglected the product of small parameters $\\delta \\cdot (r/R_0)$.\nNow, we compute the partial derivatives of $B$ with respect to the coordinates, noting $r=r(\\psi)$:\n$$\n\\frac{\\partial B}{\\partial \\psi} = \\frac{\\partial B}{\\partial r}\\frac{\\partial r}{\\partial \\psi} \\approx \\left(-\\frac{B_0}{R_0}\\cos\\theta\\right)\\left(\\frac{1}{r B_0 R_0}\\right) = -\\frac{\\cos\\theta}{r R_0^2}\n$$\n$$\n\\frac{\\partial B}{\\partial \\theta} \\approx B_0 \\frac{\\partial}{\\partial \\theta}\\left(-\\frac{r}{R_0}\\cos\\theta\\right) = \\frac{B_0 r}{R_0}\\sin\\theta\n$$\n$$\n\\frac{\\partial B}{\\partial \\phi_B} \\approx B_0 \\frac{\\partial}{\\partial \\phi_B}(\\delta\\cos(N\\phi_B)) = -B_0 N \\delta \\sin(N\\phi_B)\n$$\nThe components of the gradient in the orthonormal basis $(\\hat{\\mathbf{e}}_\\psi, \\hat{\\mathbf{e}}_\\theta, \\hat{\\mathbf{e}}_{\\phi_B})$ are:\n$$\n(\\nabla B)_\\psi = \\frac{1}{h_\\psi}\\frac{\\partial B}{\\partial \\psi} = (r B_0 R_0)\\left(-\\frac{\\cos\\theta}{r R_0^2}\\right) = -\\frac{B_0}{R_0}\\cos\\theta\n$$\n$$\n(\\nabla B)_\\theta = \\frac{1}{h_\\theta}\\frac{\\partial B}{\\partial \\theta} = \\frac{1}{r}\\left(\\frac{B_0 r}{R_0}\\sin\\theta\\right) = \\frac{B_0}{R_0}\\sin\\theta\n$$\n$$\n(\\nabla B)_{\\phi_B} = \\frac{1}{h_{\\phi_B}}\\frac{\\partial B}{\\partial \\phi_B} \\approx \\frac{1}{R_0}(-B_0 N \\delta \\sin(N\\phi_B)) = -\\frac{B_0 N \\delta}{R_0}\\sin(N\\phi_B)\n$$\nThe gradient vector is:\n$$\n\\nabla B \\approx \\left(-\\frac{B_0}{R_0}\\cos\\theta\\right)\\hat{\\mathbf{e}}_\\psi + \\left(\\frac{B_0}{R_0}\\sin\\theta\\right)\\hat{\\mathbf{e}}_\\theta - \\left(\\frac{B_0 N \\delta}{R_0}\\sin(N\\phi_B)\\right)\\hat{\\mathbf{e}}_{\\phi_B}\n$$\nThe first two components arise from poloidal variation due to toroidal curvature, and the third component arises from the toroidal field ripple.\n\n**Task 3: Radial Grad-$B$ Drift Velocity**\n\nThe grad-$B$ drift velocity is $\\mathbf{v}_{\\nabla B} = \\frac{\\mu}{q_p B^2}\\,\\mathbf{B}\\times\\nabla B$. We seek the radial component, $v_{\\nabla B,r} = \\mathbf{v}_{\\nabla B} \\cdot \\hat{\\mathbf{e}}_r$. The radial direction corresponds to the $\\psi$ direction, so $\\hat{\\mathbf{e}}_r = \\hat{\\mathbf{e}}_\\psi$.\n$$\nv_{\\nabla B,r} = \\frac{\\mu}{q_p B^2}\\,(\\mathbf{B}\\times\\nabla B) \\cdot \\hat{\\mathbf{e}}_\\psi\n$$\nUsing the scalar triple product identity $(\\mathbf{A}\\times\\mathbf{B})\\cdot\\mathbf{C} = \\mathbf{A}\\cdot(\\mathbf{B}\\times\\mathbf{C})$, this can be written as:\n$$\nv_{\\nabla B,r} = \\frac{\\mu}{q_p B^2}\\,\\mathbf{B}\\cdot(\\nabla B \\times \\hat{\\mathbf{e}}_\\psi)\n$$\nThe magnetic field vector is given as $\\mathbf{B} \\approx B_\\theta \\hat{\\mathbf{e}}_\\theta + B_\\phi \\hat{\\mathbf{e}}_{\\phi_B}$, where $B_\\phi$ is identified with $B_{\\phi_B}$.\nThe cross product $\\nabla B \\times \\hat{\\mathbf{e}}_\\psi$ in the right-handed orthonormal basis $(\\hat{\\mathbf{e}}_\\psi, \\hat{\\mathbf{e}}_\\theta, \\hat{\\mathbf{e}}_{\\phi_B})$ is:\n$$\n\\nabla B \\times \\hat{\\mathbf{e}}_\\psi = ((\\nabla B)_\\psi \\hat{\\mathbf{e}}_\\psi + (\\nabla B)_\\theta \\hat{\\mathbf{e}}_\\theta + (\\nabla B)_{\\phi_B} \\hat{\\mathbf{e}}_{\\phi_B}) \\times \\hat{\\mathbf{e}}_\\psi = (\\nabla B)_\\theta (\\hat{\\mathbf{e}}_\\theta \\times \\hat{\\mathbf{e}}_\\psi) + (\\nabla B)_{\\phi_B} (\\hat{\\mathbf{e}}_{\\phi_B} \\times \\hat{\\mathbf{e}}_\\psi)\n$$\n$$\n= (\\nabla B)_\\theta (-\\hat{\\mathbf{e}}_{\\phi_B}) + (\\nabla B)_{\\phi_B} (\\hat{\\mathbf{e}}_\\theta) = (\\nabla B)_{\\phi_B} \\hat{\\mathbf{e}}_\\theta - (\\nabla B)_\\theta \\hat{\\mathbf{e}}_{\\phi_B}\n$$\nNow, we compute the dot product with $\\mathbf{B}$:\n$$\n\\mathbf{B} \\cdot (\\nabla B \\times \\hat{\\mathbf{e}}_\\psi) = (B_\\theta \\hat{\\mathbf{e}}_\\theta + B_{\\phi_B} \\hat{\\mathbf{e}}_{\\phi_B}) \\cdot ((\\nabla B)_{\\phi_B} \\hat{\\mathbf{e}}_\\theta - (\\nabla B)_\\theta \\hat{\\mathbf{e}}_{\\phi_B}) = B_\\theta (\\nabla B)_{\\phi_B} - B_{\\phi_B} (\\nabla B)_\\theta\n$$\nSo the radial drift is:\n$$\nv_{\\nabla B,r} = \\frac{\\mu}{q_p B^2}\\left[B_\\theta (\\nabla B)_{\\phi_B} - B_{\\phi_B} (\\nabla B)_\\theta\\right]\n$$\nWe evaluate this expression at the specified location: outboard midplane ($\\theta=0$) and maximal ripple gradient ($N\\phi_B = \\frac{\\pi}{2}$).\nAt this location, we use the given approximations: $B_\\phi \\approx B_{\\phi_B} \\approx B_0$, $B_\\theta \\approx \\frac{B_0 r}{q_s R_0}$, and $B \\approx B_0$.\nThe gradient components from Task 2 become:\n$$\n(\\nabla B)_\\theta = \\frac{B_0}{R_0}\\sin(0) = 0\n$$\n$$\n(\\nabla B)_{\\phi_B} = -\\frac{B_0 N \\delta}{R_0}\\sin\\left(\\frac{\\pi}{2}\\right) = -\\frac{B_0 N \\delta}{R_0}\n$$\nSubstituting these values into the expression for $v_{\\nabla B,r}$:\n$$\nv_{\\nabla B,r} = \\frac{\\mu}{q_p B_0^2}\\left[ \\left(\\frac{B_0 r}{q_s R_0}\\right) \\left(-\\frac{B_0 N \\delta}{R_0}\\right) - (B_0)(0) \\right]\n$$\n$$\nv_{\\nabla B,r} = \\frac{\\mu}{q_p B_0^2}\\left[ -\\frac{B_0^2 N \\delta r}{q_s R_0^2} \\right]\n$$\n$$\nv_{\\nabla B,r} = -\\frac{\\mu N \\delta r}{q_p q_s R_0^2}\n$$\nThis is the final expression for the radial grad-$B$ drift velocity at the specified point, driven by the toroidal field ripple. The negative sign indicates an inward drift for a typical configuration (e.g., positive ion with $q_p0$, $\\mu0$). The units of this expression are velocity, as requested.",
            "answer": "$$\n\\boxed{-\\frac{\\mu N \\delta r}{q_{p} q_{s} R_{0}^{2}}}\n$$"
        },
        {
            "introduction": "Understanding single-particle drifts is necessary but not sufficient; the ultimate goal is to quantify macroscopic transport. This final practice bridges this gap by demonstrating how to calculate the net particle flux from an entire population of particles interacting with the ripple field. You will employ key concepts from quasilinear theory, such as the narrow-resonance approximation, to evaluate the transport integral and see how microscopic resonant interactions lead to a macroscopic particle loss rate .",
            "id": "4041639",
            "problem": "A large-aspect-ratio tokamak with a weak toroidal magnetic field ripple has ripple amplitude $\\delta \\ll 1$ and toroidal periodicity parameter $N$. Consider near-resonant radial transport of guiding-center particles caused by the static non-axisymmetric ripple. Let the particle energy be $E = m v^{2}/2$, and define the pitch parameter $\\lambda \\in [0,1]$ by $\\lambda = v_{\\perp}^{2}/v^{2}$. Assume the background distribution is Maxwellian in velocity space with number density $n$ and temperature $T$, so that the distribution function is $f(\\mathbf{v}) = n \\left(\\frac{m}{2\\pi T}\\right)^{3/2} \\exp\\!\\left(-\\frac{m v^{2}}{2 T}\\right)$. The near-resonant contribution to the quasilinear radial particle flux density, denoted $\\Gamma_{\\mathrm{res}}$, is modeled as proportional to an integral over pitch $\\lambda$ and energy $E$ of the product of three factors:\n1. A weighting $W(\\lambda,E)$ that accounts for the bounce-averaged radial step size of a guiding center,\n2. A resonance function $R(\\lambda,E)$ that is sharply peaked near the resonance in $(\\lambda,E)$-space,\n3. The Maxwellian energy density per unit energy derived from $f(\\mathbf{v})$.\n\nSpecifically, take\n$$W(\\lambda,E) = w_{0}\\,E\\,\\lambda(1-\\lambda),$$\n$$\\omega_{d}(\\lambda,E) = a\\,E\\,(\\lambda-\\lambda_{0}),$$\n$$R(\\lambda,E) = \\frac{\\Delta^{2}}{\\omega_{d}(\\lambda,E)^{2} + \\Delta^{2}},$$\nwhere $\\lambda_{0} \\in (0,1)$ is the resonant pitch, $a0$ is a constant characterizing the local slope of the bounce-averaged toroidal precession frequency $\\omega_{d}$ with respect to $\\lambda$ at fixed $E$, $\\Delta0$ is an effective decorrelation rate (collisional broadening of the resonance), and $w_{0}0$ is a constant setting the scale of the radial step size. Let the near-resonant flux density be\n$$\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\int_{0}^{\\infty} dE\\,P(E)\\int_{0}^{1} d\\lambda\\, W(\\lambda,E)\\,R(\\lambda,E),$$\nwhere $A0$ is a dimensionless geometric factor and $P(E)$ is the Maxwellian energy density per unit energy obtained by integrating $f(\\mathbf{v})$ over all velocity directions at fixed $E$.\n\nStarting from the Maxwellian distribution function and the definitions above, and under the narrow-resonance assumption that for the energies contributing most to $P(E)$ one has $\\Delta/(a E) \\ll 1$, evaluate the integral exactly to leading order in the small parameter $\\Delta/(a E)$ and obtain a closed-form analytic expression for $\\Gamma_{\\mathrm{res}}$ in terms of $A$, $w_{0}$, $n$, $T$, $a$, $\\Delta$, $\\lambda_{0}$, and $\\delta$. Your derivation must start from first principles by constructing $P(E)$ from $f(\\mathbf{v})$ and then performing the $\\lambda$-integral and the $E$-integral without invoking any undocumented shortcut formulas.\n\nExpress the final flux density in particles per meter squared per second. No numerical evaluation is required. Provide your final answer as a single closed-form expression. Do not include units in the boxed answer.",
            "solution": "The user has provided a problem to calculate the near-resonant radial particle flux density in a tokamak. I will first validate the problem statement.\n\n### Step 1: Extract Givens\n- Tokamak aspect ratio: large\n- Toroidal magnetic field ripple amplitude: $\\delta \\ll 1$\n- Toroidal periodicity parameter: $N$\n- Particle energy: $E = m v^{2}/2$\n- Pitch parameter: $\\lambda = v_{\\perp}^{2}/v^{2}$, with $\\lambda \\in [0,1]$\n- Background distribution function: $f(\\mathbf{v}) = n \\left(\\frac{m}{2\\pi T}\\right)^{3/2} \\exp\\!\\left(-\\frac{m v^{2}}{2 T}\\right)$, where $n$ is number density and $T$ is temperature.\n- Weighting function: $W(\\lambda,E) = w_{0}\\,E\\,\\lambda(1-\\lambda)$, where $w_{0}0$ is a constant.\n- Bounce-averaged toroidal precession frequency model: $\\omega_{d}(\\lambda,E) = a\\,E\\,(\\lambda-\\lambda_{0})$, where $a0$ is a constant and $\\lambda_{0} \\in (0,1)$ is the resonant pitch.\n- Resonance function: $R(\\lambda,E) = \\frac{\\Delta^{2}}{\\omega_{d}(\\lambda,E)^{2} + \\Delta^{2}}$, where $\\Delta0$ is an effective decorrelation rate.\n- Near-resonant flux density expression: $\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\int_{0}^{\\infty} dE\\,P(E)\\int_{0}^{1} d\\lambda\\, W(\\lambda,E)\\,R(\\lambda,E)$, where $A0$ is a dimensionless geometric factor.\n- $P(E)$ is the Maxwellian energy density per unit energy, obtained from $f(\\mathbf{v})$.\n- Narrow-resonance assumption: For energies where $P(E)$ is significant, $\\Delta/(a E) \\ll 1$.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded**: The problem employs standard concepts from plasma physics and fusion science, such as guiding-center motion, toroidal precession, magnetic field ripple, and quasilinear transport theory. The forms of the distribution function, flux integral, and resonance function are canonical or plausible simplifications used in theoretical modeling of ripple transport. The problem is scientifically sound.\n2.  **Well-Posed**: The problem provides all necessary functions, constants, and integration limits. The \"narrow-resonance\" assumption is crucial and provides a clear mathematical path to simplify the integral. The request for a closed-form analytic expression to leading order is a well-defined mathematical task.\n3.  **Objective**: The problem is stated in precise, technical language, free of any subjectivity or ambiguity.\n4.  **Completeness and Consistency**: All required components are defined. The task is to connect them through a calculation, starting with the derivation of $P(E)$. There are no contradictions.\n5.  **Other Flaws**: The problem does not exhibit any other signs of invalidity such as being ill-posed, unrealistic, or trivial. The cancellation that occurs is a result of the specific, but physically plausible, energy dependencies chosen for the model, rather than an artificial oversimplification.\n\n### Step 3: Verdict and Action\nThe problem is valid. I will proceed with the solution.\n\n###\nThe calculation of the near-resonant radial particle flux density $\\Gamma_{\\mathrm{res}}$ proceeds in three stages: first, the derivation of the Maxwellian energy distribution $P(E)$; second, the evaluation of the integral over the pitch parameter $\\lambda$; and third, the evaluation of the integral over energy $E$.\n\nFirst, we derive the energy probability density function $P(E)$ from the given Maxwellian velocity distribution function $f(\\mathbf{v})$. To find the distribution in energy $E = \\frac{1}{2} m v^2$, we integrate $f(\\mathbf{v})$ over all velocity directions at a fixed speed $v$. In spherical coordinates in velocity space, the volume element is $d^3v = 4\\pi v^2 dv$. The number of particles per unit volume with speeds between $v$ and $v+dv$ is\n$$dn_v = f(v) 4\\pi v^2 dv = n \\left(\\frac{m}{2\\pi T}\\right)^{3/2} \\exp\\!\\left(-\\frac{m v^{2}}{2 T}\\right) 4\\pi v^2 dv$$\nWe convert from the speed variable $v$ to the energy variable $E$. We have $v = \\sqrt{2E/m}$, so $v^2 = 2E/m$. Differentiating gives $dv = \\frac{1}{\\sqrt{2mE}} dE$. Substituting these into the expression for $dn_v$ gives the number of particles per unit volume with energies between $E$ and $E+dE$, which we denote $dn_E$:\n$$dn_E = n \\left(\\frac{m}{2\\pi T}\\right)^{3/2} \\exp\\!\\left(-\\frac{E}{T}\\right) 4\\pi \\left(\\frac{2E}{m}\\right) \\frac{dE}{\\sqrt{2mE}}$$\nSimplifying the terms:\n$$dn_E = n \\frac{m^{3/2}}{2^{3/2}\\pi^{3/2}T^{3/2}} \\exp\\!\\left(-\\frac{E}{T}\\right) \\frac{4\\pi \\sqrt{2} E^{1/2}}{m^{3/2}} dE = n \\frac{2}{\\sqrt{\\pi}T^{3/2}} E^{1/2} \\exp\\!\\left(-\\frac{E}{T}\\right) dE$$\nThe problem defines $\\Gamma_{\\mathrm{res}}$ with a factor of $n$ outside the integral, which implies that $P(E)$ is a normalized probability density function, i.e., $\\int_0^\\infty P(E) dE = 1$. From $dn_E = n P(E) dE$, we identify:\n$$P(E) = \\frac{2}{\\sqrt{\\pi} T^{3/2}} E^{1/2} \\exp\\!\\left(-\\frac{E}{T}\\right)$$\nThis is the correctly normalized Maxwell-Boltzmann energy distribution.\n\nNext, we evaluate the integral over $\\lambda$ for a fixed energy $E$:\n$$I_{\\lambda}(E) = \\int_{0}^{1} d\\lambda\\, W(\\lambda,E)\\,R(\\lambda,E)$$\nSubstituting the given forms of $W$ and $R$:\n$$I_{\\lambda}(E) = \\int_{0}^{1} d\\lambda\\, \\left(w_{0}\\,E\\,\\lambda(1-\\lambda)\\right) \\left(\\frac{\\Delta^{2}}{(a\\,E\\,(\\lambda-\\lambda_{0}))^{2} + \\Delta^{2}}\\right)$$\nWe can rearrange the resonance function:\n$$R(\\lambda,E) = \\frac{1}{\\left(\\frac{aE(\\lambda-\\lambda_0)}{\\Delta}\\right)^2 + 1}$$\nThe narrow-resonance assumption $\\Delta/(aE) \\ll 1$ implies that the function $R(\\lambda,E)$ is very sharply peaked around $\\lambda = \\lambda_0$. The width of the peak in $\\lambda$ is of order $\\Delta/(aE)$. Since the weighting function $g(\\lambda) = w_0 E \\lambda(1-\\lambda)$ is a slowly varying function compared to this narrow peak, we can approximate the integral by evaluating $g(\\lambda)$ at the center of the resonance, $\\lambda = \\lambda_0$, and pulling it outside the integral.\n$$I_{\\lambda}(E) \\approx w_{0}\\,E\\,\\lambda_{0}(1-\\lambda_{0}) \\int_{0}^{1} d\\lambda\\, \\frac{\\Delta^{2}}{(aE(\\lambda-\\lambda_0))^{2} + \\Delta^{2}}$$\nLet's perform a change of variables: $u = \\frac{aE}{\\Delta}(\\lambda-\\lambda_{0})$. Then $d\\lambda = \\frac{\\Delta}{aE}du$. Since $\\lambda_{0} \\in (0,1)$ and $\\Delta/(aE) \\ll 1$, the integration limits for $u$, which are $-\\frac{aE}{\\Delta}\\lambda_0$ and $\\frac{aE}{\\Delta}(1-\\lambda_0)$, can be extended to $-\\infty$ and $+\\infty$ to leading order.\n$$\\int_{0}^{1} d\\lambda\\, \\frac{\\Delta^{2}}{(aE(\\lambda-\\lambda_0))^{2} + \\Delta^{2}} \\approx \\int_{-\\infty}^{\\infty} \\frac{\\Delta}{aE}du\\, \\frac{\\Delta^{2}}{(\\Delta u)^2 + \\Delta^2} = \\frac{\\Delta}{aE} \\int_{-\\infty}^{\\infty} \\frac{du}{u^2+1}$$\nThe integral is a standard one: $\\int_{-\\infty}^{\\infty} \\frac{du}{u^2+1} = [\\arctan(u)]_{-\\infty}^{\\infty} = \\frac{\\pi}{2} - (-\\frac{\\pi}{2}) = \\pi$.\nSo, the integral of the resonance function becomes $\\frac{\\pi\\Delta}{aE}$.\nSubstituting this back into the expression for $I_{\\lambda}(E)$:\n$$I_{\\lambda}(E) \\approx \\left(w_{0}\\,E\\,\\lambda_{0}(1-\\lambda_{0})\\right) \\left(\\frac{\\pi\\Delta}{aE}\\right) = \\frac{\\pi w_{0} \\Delta}{a} \\lambda_{0}(1-\\lambda_{0})$$\nThis result for the $\\lambda$-integral is, remarkably, independent of energy $E$.\n\nFinally, we perform the integral over energy $E$ to find the flux $\\Gamma_{\\mathrm{res}}$:\n$$\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\int_{0}^{\\infty} dE\\,P(E)\\,I_{\\lambda}(E)$$\nSubstituting our leading-order result for $I_{\\lambda}(E)$:\n$$\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\int_{0}^{\\infty} dE\\,P(E)\\,\\left( \\frac{\\pi w_{0} \\Delta}{a} \\lambda_{0}(1-\\lambda_{0}) \\right)$$\nSince the term in the parenthesis is constant with respect to $E$, we can pull it out of the integral:\n$$\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\left( \\frac{\\pi w_{0} \\Delta}{a} \\lambda_{0}(1-\\lambda_{0}) \\right) \\int_{0}^{\\infty} P(E) dE$$\nBy definition, the integral of the probability density function $P(E)$ over its entire domain is unity: $\\int_{0}^{\\infty} P(E) dE = 1$.\nTherefore, the final expression for the particle flux density is:\n$$\\Gamma_{\\mathrm{res}} = A\\,\\delta^{2}\\,n \\frac{\\pi w_{0} \\Delta}{a} \\lambda_{0}(1-\\lambda_{0})$$\nReordering the terms gives the final result.",
            "answer": "$$\\boxed{\\frac{A \\pi \\delta^{2} n w_{0} \\Delta \\lambda_{0} (1-\\lambda_{0})}{a}}$$"
        }
    ]
}