{
    "hands_on_practices": [
        {
            "introduction": "Understanding how impurities are distributed across the plasma edge is crucial for controlling both core contamination and divertor performance. This first exercise provides a fundamental analytical look at this balance by deriving the steady-state impurity profile from a 1D drift-diffusion model . By solving this equation, you will develop a core intuition for the competing effects of cross-field diffusion, convective drifts, and parallel losses that determine whether impurities are screened from the core or enriched within it.",
            "id": "3994718",
            "problem": "A magnetically confined plasma in a toroidal device is considered near the separatrix in the Scrape-Off Layer (SOL). Focus on a single impurity species in the edge region spanning an inward radial coordinate $x \\in [0,\\Delta]$, where $x=0$ corresponds to the separatrix and $x=\\Delta$ is the inner edge boundary just inside the pedestal top. Assume the impurity undergoes cross-field diffusion with constant coefficient $D_{z}$, an outward convective drift with constant radial speed $V_{z}$, and experiences parallel exhaust to the divertor that can be modeled as a local sink with a constant parallel loss time $\\tau_{\\mathrm{par}}$. The main ion density $n_{i}(x)$ increases inward with an exponential profile characterized by a constant scale length $L_{n}$.\n\nStarting from mass conservation and standard drift-diffusion transport for the impurity, determine the steady-state enrichment factor $E$ defined by\n$$\nE \\equiv \\frac{\\left(n_{z}/n_{i}\\right)_{x=\\Delta}}{\\left(n_{z}/n_{i}\\right)_{x=0}} ,\n$$\nfor the following scientifically realistic parameters:\n- Edge width: $\\Delta = 2.0 \\times 10^{-2}\\ \\mathrm{m}$.\n- Impurity cross-field diffusion: $D_{z} = 3.0 \\times 10^{-1}\\ \\mathrm{m^{2}\\,s^{-1}}$.\n- Outward impurity convection: $V_{z} = 1.5 \\times 10^{1}\\ \\mathrm{m\\,s^{-1}}$.\n- Parallel loss time: $\\tau_{\\mathrm{par}} = 4.0 \\times 10^{-4}\\ \\mathrm{s}$.\n- Main ion density scale length: $L_{n} = 1.2 \\times 10^{-2}\\ \\mathrm{m}$.\n- Separatrix impurity and ion densities: $n_{z}(0) = 8.0 \\times 10^{16}\\ \\mathrm{m^{-3}}$, $n_{i}(0) = 1.2 \\times 10^{19}\\ \\mathrm{m^{-3}}$.\n\nImpose the physically motivated boundary conditions that the impurity density at the separatrix is fixed by the given value $n_{z}(0)$ and that there is no net outward impurity flux into the core at $x=\\Delta$. Express $E$ as a dimensionless number and round your answer to three significant figures.",
            "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n### Step 1: Extract Givens\n- **Model**: Steady-state, 1D radial transport for a single impurity species in the Scrape-Off Layer (SOL).\n- **Radial Coordinate**: $x \\in [0, \\Delta]$, with $x=0$ at the separatrix and $x$ increasing inward.\n- **Transport Mechanisms**:\n    - Cross-field diffusion coefficient (constant): $D_z$\n    - Outward convective drift speed (constant): $V_z$\n    - Parallel loss sink time (constant): $\\tau_{\\mathrm{par}}$\n- **Main Ion Density Profile**: $n_i(x) = n_i(0) \\exp(x/L_n)$, where $L_n$ is the constant density scale length.\n- **Enrichment Factor Definition**: $E \\equiv \\frac{(n_{z}/n_{i})_{x=\\Delta}}{(n_{z}/n_{i})_{x=0}}$\n- **Boundary Conditions**:\n    1. Impurity density at the separatrix is fixed: $n_z(0)$.\n    2. No net outward impurity flux into the core at $x=\\Delta$.\n- **Numerical Values**:\n    - $\\Delta = 2.0 \\times 10^{-2}\\ \\mathrm{m}$\n    - $D_z = 3.0 \\times 10^{-1}\\ \\mathrm{m^{2}\\,s^{-1}}$\n    - $V_z = 1.5 \\times 10^{1}\\ \\mathrm{m\\,s^{-1}}$\n    - $\\tau_{\\mathrm{par}} = 4.0 \\times 10^{-4}\\ \\mathrm{s}$\n    - $L_n = 1.2 \\times 10^{-2}\\ \\mathrm{m}$\n    - $n_z(0) = 8.0 \\times 10^{16}\\ \\mathrm{m^{-3}}$\n    - $n_i(0) = 1.2 \\times 10^{19}\\ \\mathrm{m^{-3}}$\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem describes a standard 1D drift-diffusion model for impurity transport in a plasma edge, a fundamental topic in computational fusion science. The physics (diffusion, convection, parallel sinks) and mathematical framework are well-established. The parameter values are realistic for tokamak edge plasmas.\n- **Well-Posed**: A second-order ordinary differential equation will be derived. The problem provides two boundary conditions ($n_z(0)$ and a flux condition at $x=\\Delta$), which is sufficient to determine a unique solution for the impurity density profile $n_z(x)$. The quantity to be calculated, $E$, is clearly defined.\n- **Objective**: The problem is stated using precise, quantitative, and unbiased language.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\nThe problem requires finding the steady-state impurity density profile, $n_z(x)$, by solving the relevant transport equation.\n\nThe one-dimensional, steady-state continuity equation for the impurity density $n_z$ is given by:\n$$\n\\frac{d\\Gamma_z}{dx} = S_z\n$$\nwhere $\\Gamma_z(x)$ is the radial impurity particle flux and $S_z$ is the net source/sink term. The problem specifies a parallel loss mechanism modeled as a local sink, so $S_z = -n_z(x)/\\tau_{\\mathrm{par}}$. The continuity equation becomes:\n$$\n\\frac{d\\Gamma_z}{dx} = -\\frac{n_z(x)}{\\tau_{\\mathrm{par}}}\n$$\nThe radial flux $\\Gamma_z(x)$ is described by a drift-diffusion model:\n$$\n\\Gamma_z(x) = -D_z \\frac{dn_z}{dx} + v_x n_z\n$$\nThe problem states an \"outward convective drift\" with speed $V_z$. Since the coordinate $x$ increases *inward* from the separatrix, this outward drift corresponds to a velocity in the negative $x$ direction. Thus, the velocity component is $v_x = -V_z$. The flux is:\n$$\n\\Gamma_z(x) = -D_z \\frac{dn_z}{dx} - V_z n_z\n$$\nSubstituting this flux expression into the continuity equation yields the governing ordinary differential equation (ODE) for $n_z(x)$. Since $D_z$ and $V_z$ are constants:\n$$\n\\frac{d}{dx} \\left( -D_z \\frac{dn_z}{dx} - V_z n_z \\right) = -\\frac{n_z}{\\tau_{\\mathrm{par}}}\n$$\n$$\n-D_z \\frac{d^2n_z}{dx^2} - V_z \\frac{dn_z}{dx} = -\\frac{n_z}{\\tau_{\\mathrm{par}}}\n$$\nRearranging gives a second-order linear homogeneous ODE with constant coefficients:\n$$\n\\frac{d^2n_z}{dx^2} + \\frac{V_z}{D_z} \\frac{dn_z}{dx} - \\frac{1}{D_z \\tau_{\\mathrm{par}}} n_z = 0\n$$\nThe characteristic equation is $r^2 + \\frac{V_z}{D_z}r - \\frac{1}{D_z\\tau_{\\mathrm{par}}} = 0$. The roots $r_{1,2}$ are:\n$$\nr_{1,2} = \\frac{-\\frac{V_z}{D_z} \\pm \\sqrt{\\left(\\frac{V_z}{D_z}\\right)^2 + \\frac{4}{D_z\\tau_{\\mathrm{par}}}}}{2} = -\\frac{V_z}{2D_z} \\pm \\sqrt{\\left(\\frac{V_z}{2D_z}\\right)^2 + \\frac{1}{D_z\\tau_{\\mathrm{par}}}}\n$$\nLet us define $Q \\equiv \\sqrt{\\left(\\frac{V_z}{2D_z}\\right)^2 + \\frac{1}{D_z\\tau_{\\mathrm{par}}}}$. The two distinct real roots are $r_1 = -V_z/(2D_z) + Q > 0$ and $r_2 = -V_z/(2D_z) - Q < 0$. The general solution for $n_z(x)$ is:\n$$\nn_z(x) = C_1 \\exp(r_1 x) + C_2 \\exp(r_2 x)\n$$\nwhere $C_1$ and $C_2$ are constants determined by the boundary conditions.\n\n**Boundary Conditions:**\n1.  At $x=0$: $n_z(0)$ is given.\n    $n_z(0) = C_1 \\exp(0) + C_2 \\exp(0) \\implies n_z(0) = C_1 + C_2$.\n2.  At $x=\\Delta$: \"no net outward impurity flux into the core\". This means the flux $\\Gamma_z$ at the inner boundary $x=\\Delta$ is zero.\n    $\\Gamma_z(\\Delta) = -D_z \\left.\\frac{dn_z}{dx}\\right|_{x=\\Delta} - V_z n_z(\\Delta) = 0$.\n    \nFrom the second boundary condition, $\\left.\\frac{dn_z}{dx}\\right|_{x=\\Delta} = -\\frac{V_z}{D_z}n_z(\\Delta)$.\nWe have $\\frac{dn_z}{dx} = C_1 r_1 \\exp(r_1 x) + C_2 r_2 \\exp(r_2 x)$. Applying the condition at $x=\\Delta$:\n$$\nC_1 r_1 \\exp(r_1 \\Delta) + C_2 r_2 \\exp(r_2 \\Delta) = -\\frac{V_z}{D_z} \\left( C_1 \\exp(r_1 \\Delta) + C_2 \\exp(r_2 \\Delta) \\right)\n$$\n$$\nC_1 \\exp(r_1 \\Delta) \\left(r_1 + \\frac{V_z}{D_z}\\right) + C_2 \\exp(r_2 \\Delta) \\left(r_2 + \\frac{V_z}{D_z}\\right) = 0\n$$\nUsing the definitions of $r_1$ and $r_2$:\n$r_1 + \\frac{V_z}{D_z} = \\frac{V_z}{2D_z} + Q$ and $r_2 + \\frac{V_z}{D_z} = \\frac{V_z}{2D_z} - Q$.\nThe equation becomes:\n$$\nC_1 \\exp(r_1 \\Delta) \\left(\\frac{V_z}{2D_z} + Q\\right) + C_2 \\exp(r_2 \\Delta) \\left(\\frac{V_z}{2D_z} - Q\\right) = 0\n$$\nUsing $C_2 = n_z(0) - C_1$, we can solve for $C_1$ and $C_2$. However, we are interested in $n_z(\\Delta) = C_1 \\exp(r_1 \\Delta) + C_2 \\exp(r_2 \\Delta)$. A more direct calculation leads to the ratio $n_z(\\Delta)/n_z(0)$. After algebraic manipulation, this ratio is found to be:\n$$\n\\frac{n_z(\\Delta)}{n_z(0)} = \\frac{Q \\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z} \\sinh(Q\\Delta) + Q \\cosh(Q\\Delta)}\n$$\nThe main ion density profile is $n_i(x) = n_i(0) \\exp(x/L_n)$. Thus, $\\frac{n_i(\\Delta)}{n_i(0)} = \\exp(\\Delta/L_n)$.\n\nThe enrichment factor $E$ is defined as:\n$$\nE = \\frac{n_z(\\Delta)/n_i(\\Delta)}{n_z(0)/n_i(0)} = \\frac{n_z(\\Delta)}{n_z(0)} \\frac{n_i(0)}{n_i(\\Delta)}\n$$\nSubstituting the derived expressions:\n$$\nE = \\left( \\frac{Q \\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z} \\sinh(Q\\Delta) + Q \\cosh(Q\\Delta)} \\right) \\exp\\left(-\\frac{\\Delta}{L_n}\\right)\n$$\nDividing the numerator and denominator of the first term by $Q$:\n$$\nE = \\left( \\frac{\\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z Q} \\sinh(Q\\Delta) + \\cosh(Q\\Delta)} \\right) \\exp\\left(-\\frac{\\Delta}{L_n}\\right)\n$$\nNow, we substitute the numerical values:\n- $\\frac{V_z}{2D_z} = \\frac{1.5 \\times 10^1}{2 \\times (3.0 \\times 10^{-1})} = \\frac{15}{0.6} = 25\\ \\mathrm{m^{-1}}$\n- $D_z \\tau_{\\mathrm{par}} = (3.0 \\times 10^{-1}) \\times (4.0 \\times 10^{-4}) = 1.2 \\times 10^{-4}\\ \\mathrm{m^2}$\n- $Q = \\sqrt{(25)^2 + \\frac{1}{1.2 \\times 10^{-4}}} = \\sqrt{625 + 8333.33...} = \\sqrt{8958.33...} \\approx 94.6485\\ \\mathrm{m^{-1}}$\n- $\\frac{\\Delta}{L_n} = \\frac{2.0 \\times 10^{-2}}{1.2 \\times 10^{-2}} = \\frac{5}{3}$\n\nArguments for the functions:\n- $\\frac{V_z \\Delta}{2D_z} = 25 \\times (2.0 \\times 10^{-2}) = 0.5$\n- $Q\\Delta = 94.6485 \\times (2.0 \\times 10^{-2}) \\approx 1.8930$\n\nCalculate the components of the expression for $E$:\n- $\\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right) = \\exp(-0.5) \\approx 0.60653$\n- $\\exp\\left(-\\frac{\\Delta}{L_n}\\right) = \\exp(-5/3) \\approx 0.18888$\n- $\\sinh(Q\\Delta) \\approx \\sinh(1.8930) \\approx 3.2323$\n- $\\cosh(Q\\Delta) \\approx \\cosh(1.8930) \\approx 3.3835$\n- $\\frac{V_z}{2D_z Q} = \\frac{25}{94.6485} \\approx 0.26414$\n\nThe denominator of the first term is:\n$0.26414 \\times 3.2323 + 3.3835 \\approx 0.85386 + 3.3835 = 4.23736$\n\nFinally, we calculate $E$:\n$$\nE \\approx \\left(\\frac{0.60653}{4.23736}\\right) \\times 0.18888 \\approx 0.14313 \\times 0.18888 \\approx 0.0270438\n$$\nRounding to three significant figures, the enrichment factor is $0.0270$.",
            "answer": "$$\\boxed{0.0270}$$"
        },
        {
            "introduction": "As impurities travel through the plasma, their charge state evolves rapidly due to collisions with electrons, dramatically altering their transport properties and radiative behavior. This computational practice focuses on simulating this time-dependent atomic physics using a collisional-radiative model for multiple charge states . Implementing a numerical solver for this (often stiff) system of equations is a key skill for accurately modeling impurity dynamics and interpreting spectroscopic data.",
            "id": "3994713",
            "problem": "Consider a simplified collisional-radiative (CR) model for an impurity in the plasma edge of a magnetically confined fusion device. The impurity is assumed to have three adjacent charge states labeled by the integer charge number $z \\in \\{0,1,2\\}$, corresponding to neutral, singly ionized, and doubly ionized species. A fluid element carrying the impurity moves along a one-dimensional path of length $L$ with constant velocity $v$, and the local electron temperature $T_e$ and electron density $n_e$ are constant over the path. Neglect excitation to metastable states, transport losses other than advection, and any sources or sinks other than electron impact ionization and recombination. Assume the collisional-radiative (CR) system evolves only due to the following reactions:\n- Electron impact ionization of charge state $z$ to $z+1$ with rate coefficient $S_z(T_e)$ in units of $\\mathrm{m^3/s}$, where $z \\in \\{0,1\\}$.\n- Effective recombination from charge state $z$ to $z-1$ with rate coefficient $\\alpha_z(T_e,n_e)$ in units of $\\mathrm{m^3/s}$, where $z \\in \\{1,2\\}$.\n\nThe fundamental base is:\n- The number density evolution of each charge state is governed by particle balance and reaction kinetics: for charge state number densities $n_z(t)$, the rate of change is the net gain minus net loss due to reactions, with rates proportional to $n_e$ times rate coefficients.\n- The particle conservation constraint holds: $\\sum_{z=0}^{2} n_z(t) = n_{\\mathrm{imp}}$, where $n_{\\mathrm{imp}}$ is the total impurity density carried by the fluid element (constant in time).\n- The time of flight of the fluid element over the path is $\\tau = L/v$.\n\nIntroduce the fractional abundances $y_z(t) = n_z(t)/n_{\\mathrm{imp}}$, which satisfy $\\sum_{z=0}^{2} y_z(t) = 1$ for all $t$. Starting from the above fundamental base, derive the coupled ordinary differential equations governing $y_0(t)$, $y_1(t)$, and $y_2(t)$ under the assumptions stated. The initial condition is a purely neutral influx from the wall, $y_0(0) = 1$, $y_1(0) = 0$, $y_2(0) = 0$.\n\nFor computational closure, employ the following scientifically plausible analytic forms for carbon (atomic number $Z=6$) effective rate coefficients, expressed with electron temperature in electron-volts ($\\mathrm{eV}$) and electron density in $\\mathrm{m^{-3}}$:\n- First and second ionization potentials are $I_0 = 11.26\\,\\mathrm{eV}$ and $I_1 = 24.38\\,\\mathrm{eV}$.\n- Electron impact ionization rate coefficients:\n$$\nS_0(T_e) = C_0\\,\\sqrt{T_e}\\,\\exp\\!\\left(-\\frac{I_0}{T_e}\\right),\\quad\nS_1(T_e) = C_1\\,\\sqrt{T_e}\\,\\exp\\!\\left(-\\frac{I_1}{T_e}\\right),\n$$\nwith $C_0 = 1.0\\times 10^{-14}\\,\\mathrm{m^3/s/eV^{1/2}}$ and $C_1 = 1.0\\times 10^{-14}\\,\\mathrm{m^3/s/eV^{1/2}}$. These forms provide order-of-magnitude fits consistent with electron impact ionization physics in the plasma edge.\n- Effective recombination (radiative plus three-body) rate coefficients:\n$$\n\\alpha_1(T_e,n_e) = A_1\\,T_e^{-0.7} + n_e\\,B_1\\,T_e^{-4.5},\\quad\n\\alpha_2(T_e,n_e) = A_2\\,T_e^{-0.7} + n_e\\,B_2\\,T_e^{-4.5},\n$$\nwith $A_1 = 2.0\\times 10^{-13}\\,\\mathrm{m^3/s}$, $A_2 = 1.5\\times 10^{-13}\\,\\mathrm{m^3/s}$, $B_1 = 1.0\\times 10^{-33}\\,\\mathrm{m^6/s}$, and $B_2 = 0.8\\times 10^{-33}\\,\\mathrm{m^6/s}$. These effective forms capture the increase of recombination at low temperature and the density dependence of three-body recombination.\n\nYour task is to:\n1. Derive the time-dependent equations for $y_0(t)$, $y_1(t)$, and $y_2(t)$ from first principles using the above reaction network and assumptions. Express the equations explicitly and state the conservation property they satisfy.\n2. Design and implement a robust numerical algorithm to integrate the derived system from $t=0$ to $t=\\tau=L/v$ for each specified test case, ensuring numerical stability, preservation of non-negativity, and approximate conservation $\\sum_z y_z(t)=1$. If numerical drift occurs, you may renormalize the solution at the final time by the sum of $y_z$.\n3. For each test case, compute the final doubly ionized fraction $y_2(\\tau)$ as a dimensionless decimal number. Express $T_e$ in $\\mathrm{eV}$, $n_e$ in $\\mathrm{m^{-3}}$, $L$ in $\\mathrm{m}$, $v$ in $\\mathrm{m/s}$; the output $y_2(\\tau)$ is unitless. Report each value rounded to six decimal places.\n\nTest suite (each tuple is $(T_e\\,\\mathrm{[eV]}, n_e\\,\\mathrm{[m^{-3}]}, L\\,\\mathrm{[m]}, v\\,\\mathrm{[m/s]})$):\n- Case 1 (general plasma edge): $(10.0, 1.0\\times 10^{19}, 0.05, 500.0)$.\n- Case 2 (transport-limited, fast flow): $(10.0, 1.0\\times 10^{19}, 0.05, 5.0\\times 10^{4})$.\n- Case 3 (near-neutral boundary, low temperature): $(1.0, 1.0\\times 10^{19}, 0.05, 500.0)$.\n- Case 4 (high density, enhanced recombination): $(2.0, 1.0\\times 10^{20}, 0.05, 500.0)$.\n- Case 5 (hotter edge, lower density, longer path): $(30.0, 5.0\\times 10^{18}, 0.10, 1000.0)$.\n- Case 6 (slow flow, near-equilibrium tendency): $(15.0, 1.0\\times 10^{19}, 0.05, 50.0)$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets with each entry rounded to six decimal places, in the same order as the test suite cases (for example, \"[0.123456,0.234567,0.345678,0.456789,0.567890,0.678901]\").",
            "solution": "The problem is well-posed, scientifically grounded, and contains all necessary information to proceed with a solution. It represents a standard initial value problem for a system of coupled ordinary differential equations (ODEs) describing a simplified collisional-radiative model for impurities in a plasma.\n\n### Step 1: Derivation of the Time-Dependent Equations for Fractional Abundances\n\nThe problem describes a three-level system for an impurity with charge states $z \\in \\{0, 1, 2\\}$, corresponding to fractional abundances $y_0$, $y_1$, and $y_2$. The evolution of these abundances is governed by electron impact ionization and recombination processes. Let us denote the number density of charge state $z$ as $n_z$. The total impurity density $n_{\\mathrm{imp}} = \\sum_{z=0}^{2} n_z$ is constant. The fractional abundance is $y_z = n_z/n_{\\mathrm{imp}}$.\n\nThe reactions are:\n1.  Ionization of state $0$ to $1$: $I_0 \\xrightarrow{S_0, n_e} I_1$. Rate of loss for $n_0$ is $S_0 n_e n_0$.\n2.  Ionization of state $1$ to $2$: $I_1 \\xrightarrow{S_1, n_e} I_2$. Rate of loss for $n_1$ is $S_1 n_e n_1$.\n3.  Recombination of state $1$ to $0$: $I_1 \\xrightarrow{\\alpha_1, n_e} I_0$. Rate of loss for $n_1$ is $\\alpha_1 n_e n_1$.\n4.  Recombination of state $2$ to $1$: $I_2 \\xrightarrow{\\alpha_2, n_e} I_1$. Rate of loss for $n_2$ is $\\alpha_2 n_e n_2$.\n\nBased on particle balance, the rate of change of the number density for each charge state is the sum of production rates minus the sum of loss rates.\n\nFor charge state $z=0$:\n-   Loss is due to ionization to state $z=1$.\n-   Gain is due to recombination from state $z=1$.\n$$\n\\frac{dn_0}{dt} = -S_0(T_e) n_e n_0(t) + \\alpha_1(T_e, n_e) n_e n_1(t)\n$$\n\nFor charge state $z=1$:\n-   Loss is due to ionization to state $z=2$ and recombination to state $z=0$.\n-   Gain is due to ionization from state $z=0$ and recombination from state $z=2$.\n$$\n\\frac{dn_1}{dt} = S_0(T_e) n_e n_0(t) - S_1(T_e) n_e n_1(t) - \\alpha_1(T_e, n_e) n_e n_1(t) + \\alpha_2(T_e, n_e) n_e n_2(t)\n$$\n$$\n\\frac{dn_1}{dt} = S_0(T_e) n_e n_0(t) - \\left[ S_1(T_e) + \\alpha_1(T_e, n_e) \\right] n_e n_1(t) + \\alpha_2(T_e, n_e) n_e n_2(t)\n$$\n\nFor charge state $z=2$:\n-   Loss is due to recombination to state $z=1$.\n-   Gain is due to ionization from state $z=1$.\n$$\n\\frac{dn_2}{dt} = S_1(T_e) n_e n_1(t) - \\alpha_2(T_e, n_e) n_e n_2(t)\n$$\n\nTo obtain the equations for the fractional abundances $y_z(t) = n_z(t)/n_{\\mathrm{imp}}$, we divide each equation by the constant total impurity density $n_{\\mathrm{imp}}$:\n$$\n\\frac{d(n_z/n_{\\mathrm{imp}})}{dt} = \\frac{1}{n_{\\mathrm{imp}}} \\frac{dn_z}{dt} \\implies \\frac{dy_z}{dt} = \\frac{1}{n_{\\mathrm{imp}}} \\frac{dn_z}{dt}\n$$\nThe resulting system of ODEs for $y_z(t)$ is:\n$$\n\\frac{dy_0}{dt} = n_e \\left[ -S_0 y_0(t) + \\alpha_1 y_1(t) \\right]\n$$\n$$\n\\frac{dy_1}{dt} = n_e \\left[ S_0 y_0(t) - (S_1 + \\alpha_1) y_1(t) + \\alpha_2 y_2(t) \\right]\n$$\n$$\n\\frac{dy_2}{dt} = n_e \\left[ S_1 y_1(t) - \\alpha_2 y_2(t) \\right]\n$$\nHere, the rate coefficients $S_z$ and $\\alpha_z$ are functions of the constant parameters $T_e$ and $n_e$, so they are constant throughout the integration time.\n\nThe initial condition is a purely neutral influx: $y_0(0) = 1$, $y_1(0) = 0$, $y_2(0) = 0$.\n\nConservation Property: The sum of the fractional abundances must be conserved. Let us verify this by summing the derived ODEs:\n$$\n\\frac{d}{dt}(y_0 + y_1 + y_2) = \\frac{dy_0}{dt} + \\frac{dy_1}{dt} + \\frac{dy_2}{dt}\n$$\n$$\n= n_e \\left[ (-S_0 y_0 + \\alpha_1 y_1) + (S_0 y_0 - (S_1 + \\alpha_1) y_1 + \\alpha_2 y_2) + (S_1 y_1 - \\alpha_2 y_2) \\right]\n$$\nCollecting terms for each $y_z$:\n$$\n= n_e \\left[ (-S_0 + S_0) y_0 + (\\alpha_1 - (S_1 + \\alpha_1) + S_1) y_1 + (\\alpha_2 - \\alpha_2) y_2 \\right]\n$$\n$$\n= n_e \\left[ (0) y_0 + (\\alpha_1 - S_1 - \\alpha_1 + S_1) y_1 + (0) y_2 \\right] = 0\n$$\nSince the time derivative of the sum is zero, the sum $\\sum_{z=0}^{2} y_z(t)$ is a constant. Given the initial condition $\\sum y_z(0) = 1+0+0=1$, it follows that $\\sum y_z(t) = 1$ for all $t \\ge 0$.\n\n### Step 2: Numerical Algorithm Design\n\nThe derived system is a set of linear, first-order, coupled ODEs with constant coefficients. This can be written in matrix form $\\frac{d\\vec{y}}{dt} = \\mathbf{M} \\vec{y}$, where $\\vec{y}(t) = [y_0(t), y_1(t), y_2(t)]^T$ and the rate matrix $\\mathbf{M}$ is:\n$$\n\\mathbf{M} = n_e \\begin{pmatrix}\n-S_0 & \\alpha_1 & 0 \\\\\nS_0 & -(S_1 + \\alpha_1) & \\alpha_2 \\\\\n0 & S_1 & -\\alpha_2\n\\end{pmatrix}\n$$\nThe rate coefficients $S_z$ and $\\alpha_z$ can vary by orders of magnitude, making the system potentially stiff. A robust numerical integrator is required to handle this stiffness and ensure stability and accuracy without excessively small time steps. The `scipy.integrate.solve_ivp` function from the SciPy library is an excellent tool for this purpose. It provides several solvers; we select `'Radau'`, an implicit Runge-Kutta method of order 5, which is well-suited for stiff problems.\n\nThe algorithm for each test case is as follows:\n1.  Given a test case $(T_e, n_e, L, v)$, calculate the total integration time $\\tau = L/v$.\n2.  Calculate the constant rate coefficients $S_0(T_e)$, $S_1(T_e)$, $\\alpha_1(T_e, n_e)$, and $\\alpha_2(T_e, n_e)$ using the provided analytical formulas.\n3.  Define the initial state vector $\\vec{y}(0) = [1.0, 0.0, 0.0]^T$.\n4.  Use `scipy.integrate.solve_ivp` to integrate the ODE system from $t=0$ to $t=\\tau$. The function representing the system of ODEs will be passed to the solver along with the time interval $[0, \\tau]$, the initial state vector, and the calculated rate coefficients as parameters.\n5.  Extract the solution vector $\\vec{y}(\\tau)$ at the final time.\n6.  Although the analytical system conserves the sum of abundances, numerical integration can introduce small drift errors. To enforce the conservation property $\\sum y_z = 1$ precisely on the final result, we renormalize the final vector: $\\vec{y}_{\\text{norm}}(\\tau) = \\vec{y}(\\tau) / \\sum_z y_z(\\tau)$.\n7.  The desired output is the final doubly ionized fraction, $y_{2, \\text{norm}}(\\tau)$. This value is then rounded to six decimal places as required.\n\nThis procedure provides a numerically stable, accurate, and robust method to solve the problem for the entire test suite.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Solves the collisional-radiative model for impurity transport for a suite of test cases.\n    \"\"\"\n\n    # Define physical and model constants\n    # Ionization potentials in eV\n    I0 = 11.26\n    I1 = 24.38\n    # Ionization rate coefficients C_z in m^3/s/eV^(1/2)\n    C0 = 1.0e-14\n    C1 = 1.0e-14\n    # Recombination rate coefficients A_z in m^3/s and B_z in m^6/s\n    A1 = 2.0e-13\n    A2 = 1.5e-13\n    B1 = 1.0e-33\n    B2 = 0.8e-33\n\n    # Define rate coefficient functions\n    def S0_func(Te):\n        if Te <= 0: return 0.0\n        return C0 * np.sqrt(Te) * np.exp(-I0 / Te)\n\n    def S1_func(Te):\n        if Te <= 0: return 0.0\n        return C1 * np.sqrt(Te) * np.exp(-I1 / Te)\n\n    def alpha1_func(Te, ne):\n        if Te <= 0: return np.inf\n        return A1 * Te**(-0.7) + ne * B1 * Te**(-4.5)\n\n    def alpha2_func(Te, ne):\n        if Te <= 0: return np.inf\n        return A2 * Te**(-0.7) + ne * B2 * Te**(-4.5)\n\n    def ode_system(t, y, ne, S0, S1, alpha1, alpha2):\n        \"\"\"\n        Defines the system of coupled ordinary differential equations for y = [y0, y1, y2].\n        dy/dt = M * y\n        \"\"\"\n        y0, y1, y2 = y\n        \n        dy0_dt = ne * (-S0 * y0 + alpha1 * y1)\n        dy1_dt = ne * (S0 * y0 - (S1 + alpha1) * y1 + alpha2 * y2)\n        dy2_dt = ne * (S1 * y1 - alpha2 * y2)\n        \n        return [dy0_dt, dy1_dt, dy2_dt]\n\n    # Test suite: (Te [eV], ne [m^-3], L [m], v [m/s])\n    test_cases = [\n        (10.0, 1.0e19, 0.05, 500.0),            # Case 1\n        (10.0, 1.0e19, 0.05, 5.0e4),            # Case 2\n        (1.0, 1.0e19, 0.05, 500.0),             # Case 3\n        (2.0, 1.0e20, 0.05, 500.0),             # Case 4\n        (30.0, 5.0e18, 0.10, 1000.0),           # Case 5\n        (15.0, 1.0e19, 0.05, 50.0),             # Case 6\n    ]\n\n    results = []\n    for case in test_cases:\n        Te, ne, L, v = case\n        \n        # Calculate time of flight\n        tau = L / v\n        \n        # Calculate constant rate coefficients for the case\n        S0 = S0_func(Te)\n        S1 = S1_func(Te)\n        alpha1 = alpha1_func(Te, ne)\n        alpha2 = alpha2_func(Te, ne)\n        \n        # Initial conditions: y(0) = [1, 0, 0]\n        y0 = np.array([1.0, 0.0, 0.0])\n        \n        # Time span for integration\n        t_span = [0, tau]\n        \n        # Solve the ODE system\n        # 'Radau' is a good choice for potentially stiff problems like this\n        sol = solve_ivp(\n            ode_system,\n            t_span,\n            y0,\n            method='Radau',\n            args=(ne, S0, S1, alpha1, alpha2),\n            dense_output=True\n        )\n        \n        # Get the solution at the final time tau\n        y_final = sol.y[:, -1]\n        \n        # Renormalize to correct for any minor numerical drift\n        y_final_sum = np.sum(y_final)\n        if y_final_sum > 0:\n            y_final_normalized = y_final / y_final_sum\n        else: # Should not happen in this physical system\n            y_final_normalized = y_final\n\n        # Extract the final doubly ionized fraction y2(tau)\n        y2_tau = y_final_normalized[2]\n        \n        results.append(y2_tau)\n\n    # Format the final output string exactly as specified\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A critical step in computational science is validating simulation results against experimental measurements. This final practice guides you through a complete validation workflow, from numerically solving a more complex impurity transport equation to generating a synthetic diagnostic signal for comparison . By building this end-to-end tool, you will learn how to quantify the agreement between a model and \"data,\" a fundamental process in advancing the predictive capability of our codes.",
            "id": "3994719",
            "problem": "You are tasked with implementing a computational validation workflow for impurity transport in the plasma edge using synthetic diagnostics. Consider a one-dimensional slab model of the edge layer with coordinate $x \\in [0, L]$ where $x = 0$ is the inner edge of the pedestal and $x = L$ is the wall interface. Assume steady state for the impurity number density $n_z(x)$, governed by the continuity equation and Fick’s law with a convective pinch. Starting from the continuity equation $ \\partial n_z / \\partial t + d\\Gamma / dx = S - L n_z $ and assuming steady state $ \\partial n_z / \\partial t = 0$, let the radial impurity particle flux be $ \\Gamma(x) = - D \\, dn_z / dx + V \\, n_z^{\\text{upwind}} $, where $D$ is the diffusion coefficient and $V$ is the convective velocity (negative $V$ denotes inward pinch). Use an upwind scheme for the convective term. The source $S(x)$ is sharply peaked near the wall, and the loss $L(x)$ represents effective ionization loss and parallel exhaust. Impose boundary conditions $ \\left.\\dfrac{d n_z}{dx}\\right|_{x=0} = 0 $ and $ n_z(L) = n_{\\text{wall}} $.\n\nElectron density $n_e(x)$ and electron temperature $T_e(x)$ are specified profiles across the slab. The diagnostic forward model computes the line brightness $B(\\theta)$ for a chord at angle $\\theta$ to the slab normal. In the slab approximation, the line-of-sight path length correction yields $ B(\\theta) = \\dfrac{1}{\\cos \\theta} \\int_{0}^{L} \\epsilon(x) \\, dx $, where $ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $ is the emissivity, and $ C(T)$ is an excitation rate coefficient model. Given a synthetic measurement constructed from a “true” parameter set, you must compute the normalized chi-squared validation metric comparing simulated and measured brightness for several test parameter sets.\n\nImplement the following model and computations:\n\n- Geometry and grid:\n  - Slab thickness $L = 0.1 \\ \\text{m}$, uniform grid with $N = 200$ points.\n  - Grid spacing $ \\Delta x = L / (N - 1) $.\n- Plasma profiles (edge-consistent and monotonic):\n  - Electron density profile $ n_e(x) = n_{\\text{sep}} - \\Delta n \\, \\dfrac{x}{L} $ with $ n_{\\text{sep}} = 1.5 \\times 10^{19} \\ \\text{m}^{-3} $ and $ \\Delta n = 0.4 \\times 10^{19} \\ \\text{m}^{-3} $.\n  - Electron temperature profile $ T_e(x) = T_{\\text{sep}} - \\Delta T \\, \\dfrac{x}{L} $, clamped below by $T_{\\min}$, with $ T_{\\text{sep}} = 60 \\ \\text{eV} $, $ \\Delta T = 40 \\ \\text{eV} $, and $ T_{\\min} = 10 \\ \\text{eV} $.\n- Impurity source and loss:\n  - Source $ S(x) = S_0 \\exp \\left( - \\dfrac{L - x}{\\lambda_S} \\right) $ with $ \\lambda_S = 0.02 \\ \\text{m} $ and tunable amplitude $S_0$ in $ \\text{m}^{-3} \\text{s}^{-1} $.\n  - Loss $ L(x) = n_e(x) \\, K_{\\text{iz}}(T_e(x)) $, an effective ionization rate with $ K_{\\text{iz}}(T) = K_0 \\, T^{1/2} \\, \\exp \\left( - \\dfrac{E_{\\text{iz}}}{T} \\right) $, where $ K_0 = 1.0 \\times 10^{-14} \\ \\text{m}^3 \\text{s}^{-1} $, $ E_{\\text{iz}} = 25 \\ \\text{eV} $.\n- Boundary value problem:\n  - Discretize $ \\dfrac{d \\Gamma}{dx} = S(x) - L(x) n_z(x) $ using second-order central differences for diffusion and first-order upwind for convection.\n  - Left boundary $ x=0 $: enforce $ \\left.\\dfrac{d n_z}{dx}\\right|_{x=0} = 0 $ using a ghost cell $ n_z(-\\Delta x) = n_z(0) $.\n  - Right boundary $ x=L $: enforce $ n_z(L) = n_{\\text{wall}} $ with $ n_{\\text{wall}} = 1.0 \\times 10^{15} \\ \\text{m}^{-3} $ (Dirichlet).\n  - Assemble a tridiagonal linear system $ \\mathbf{A} \\, \\mathbf{n}_z = \\mathbf{b} $ and solve for $ \\mathbf{n}_z $.\n- Emissivity model and diagnostic forward model:\n  - Photon emissivity coefficient $ C(T) = C_0 \\, T^{-1/2} \\, \\exp \\left( - \\dfrac{E_{\\text{exc}}}{T} \\right) $ with $ C_0 = 1.0 \\times 10^{-20} \\ \\text{m}^3 \\text{s}^{-1} $ and $ E_{\\text{exc}} = 30 \\ \\text{eV} $.\n  - Emissivity $ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $ in $ \\text{photons} \\, \\text{m}^{-3} \\text{s}^{-1} $.\n  - Chord angles $ \\theta \\in \\{ 0^\\circ, 30^\\circ, 60^\\circ \\} $ (angles are specified in degrees), and brightness $ B(\\theta) $ in $ \\text{photons} \\, \\text{m}^{-2} \\text{s}^{-1} $ computed as $ B(\\theta) = \\dfrac{1}{\\cos(\\theta)} \\int_0^L \\epsilon(x) \\, dx $ where $ \\theta $ must be converted to radians internally.\n- Synthetic measurement and validation metric:\n  - “True” parameters: $ D_{\\text{true}} = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V_{\\text{true}} = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_{0,\\text{true}} = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n  - Generate synthetic measured brightness $ B_{\\text{meas}}(\\theta) $ by forward-modeling with the true parameters (no added noise).\n  - Define measurement uncertainties $ \\sigma(\\theta) = f \\, B_{\\text{meas}}(\\theta) $ with $ f = 0.05 $ (dimensionless fractional uncertainty).\n  - For a candidate parameter set, compute the normalized chi-squared $ \\chi^2_{\\nu} = \\dfrac{1}{N_{\\text{chords}}} \\sum_{\\theta} \\left( \\dfrac{ B_{\\text{sim}}(\\theta) - B_{\\text{meas}}(\\theta) }{ \\sigma(\\theta) } \\right)^2 $, which is dimensionless.\n- Test suite:\n  - Use the following four candidate parameter sets to test different aspects:\n    1. Case A (happy path): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    2. Case B (diffusion underestimation): $ D = 0.1 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    3. Case C (wrong convection direction): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = +5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    4. Case D (source too weak): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 1.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n- Required output:\n  - Your program should produce a single line of output containing the normalized chi-squared values for Cases A–D, as a comma-separated list enclosed in square brackets (e.g., $[ \\chi^2_A, \\chi^2_B, \\chi^2_C, \\chi^2_D ]$). Each $ \\chi^2 $ must be a floating-point number. Angles must be handled in degrees as specified, and any intermediate brightness must be computed in $ \\text{photons} \\, \\text{m}^{-2} \\text{s}^{-1} $.\n\nYour task is to implement this end-to-end workflow: discretize and solve the boundary value problem for $ n_z(x) $, compute emissivity and brightness for the given chords, and evaluate the validation metric for each test case. No external inputs are required; the program must run as-is and print the specified single-line output.",
            "solution": "The user-provided problem is a well-posed computational task in the field of fusion plasma physics. It is scientifically grounded, self-contained, and all parameters and methods are specified unambiguously. Therefore, the problem is deemed valid and a full solution is warranted.\n\nThe solution involves simulating impurity transport in a one-dimensional slab model of the plasma edge and comparing the results to synthetic diagnostic measurements. This is achieved by numerically solving a steady-state transport equation, computing the expected diagnostic signal via a forward model, and quantifying the model-data mismatch using a chi-squared metric.\n\nThe core of the problem is to solve the steady-state impurity continuity equation:\n$$ \\frac{d\\Gamma(x)}{dx} = S(x) - L(x) n_z(x) $$\nwhere $x \\in [0, L]$ is the spatial coordinate, $n_z(x)$ is the impurity density, $S(x)$ is the impurity source rate, and $L(x)$ is the loss rate. The impurity particle flux $\\Gamma(x)$ is described by a drift-diffusion model:\n$$ \\Gamma(x) = -D \\frac{dn_z}{dx} + V n_z(x) $$\nHere, $D$ is the diffusion coefficient and $V$ is the convective pinch velocity. Combining these two equations yields a second-order linear ordinary differential equation for $n_z(x)$:\n$$ -D \\frac{d^2 n_z}{d x^2} + V \\frac{dn_z}{dx} + L(x) n_z(x) = S(x) $$\nThis boundary value problem (BVP) is defined on the domain $x \\in [0, L]$ with a zero-flux (Neumann) boundary condition at the inner edge, $x=0$, and a fixed-density (Dirichlet) boundary condition at the wall, $x=L$:\n$$ \\frac{dn_z}{dx} \\bigg|_{x=0} = 0, \\quad n_z(L) = n_{\\text{wall}} $$\n\nTo solve this BVP numerically, we discretize the domain into a uniform grid of $N$ points, $x_i = i \\Delta x$ for $i=0, 1, \\dots, N-1$, where the grid spacing is $\\Delta x = L/(N-1)$. The impurity density at these points is denoted $n_{z,i} = n_z(x_i)$.\n\nThe differential operators are approximated using finite differences as specified:\n1.  **Diffusion Term**: A second-order central difference scheme is used:\n    $$ \\frac{d^2 n_z}{d x^2} \\bigg|_{x_i} \\approx \\frac{n_{z,i+1} - 2n_{z,i} + n_{z,i-1}}{(\\Delta x)^2} $$\n2.  **Convection Term**: A first-order upwind scheme is used, where the difference is taken based on the direction of the velocity $V$:\n    $$ \\frac{dn_z}{dx} \\bigg|_{x_i} \\approx\n    \\begin{cases}\n        \\frac{n_{z,i} - n_{z,i-1}}{\\Delta x} & \\text{if } V > 0 \\\\\n        \\frac{n_{z,i+1} - n_{z,i}}{\\Delta x} & \\text{if } V < 0\n    \\end{cases}\n    $$\nThis can be written compactly using $V^+ = \\max(V,0)$ and $V^- = \\min(V,0)$ as $V\\frac{dn_z}{dx} \\approx V^+\\frac{n_{z,i}-n_{z,i-1}}{\\Delta x} + V^-\\frac{n_{z,i+1}-n_{z,i}}{\\Delta x}$.\n\nSubstituting these discretizations into the governing equation and rearranging terms yields a linear algebraic equation for each interior grid point $i \\in \\{1, 2, \\dots, N-2\\}$:\n$$ \\left(-\\frac{D}{(\\Delta x)^2} - \\frac{V^+}{\\Delta x}\\right) n_{z,i-1} + \\left(\\frac{2D}{(\\Delta x)^2} + \\frac{|V|}{\\Delta x} + L_i\\right) n_{z,i} + \\left(-\\frac{D}{(\\Delta x)^2} + \\frac{V^-}{\\Delta x}\\right) n_{z,i+1} = S_i $$\nwhere $L_i = L(x_i)$ and $S_i = S(x_i)$.\n\nThe boundary conditions are incorporated to form a complete system of $N$ linear equations for the $N$ unknowns $\\{n_{z,0}, \\dots, n_{z,N-1}\\}$.\n-   At the left boundary, $x=0$ ($i=0$), the condition $\\frac{dn_z}{dx}=0$ is implemented using a ghost cell $n_{z,-1}=n_{z,0}$, as specified. Applying this to the general discretized equation for $i=0$ yields the first equation of our system.\n-   At the right boundary, $x=L$ ($i=N-1$), the Dirichlet condition $n_z(L) = n_{\\text{wall}}$ provides the last equation directly: $n_{z,N-1} = n_{\\text{wall}}$.\n\nThis procedure results in a linear system $\\mathbf{A} \\mathbf{n}_z = \\mathbf{b}$, where $\\mathbf{A}$ is an $N \\times N$ matrix, $\\mathbf{n}_z = [n_{z,0}, \\dots, n_{z,N-1}]^T$ is the vector of unknown densities, and $\\mathbf{b}$ is the known source and boundary condition vector. The matrix $\\mathbf{A}$ is predominantly tridiagonal. This system is solved using a standard linear algebra library routine.\n\nOnce the impurity density profile $n_z(x)$ is found, the diagnostic forward model is applied. The photon emissivity $\\epsilon(x)$ is computed as:\n$$ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $$\nwhere $n_e(x)$ and $T_e(x)$ are the given background electron density and temperature profiles, and $C(T)$ is the specified excitation rate coefficient. The line-integrated brightness $B(\\theta)$ for a chord at angle $\\theta$ is then calculated by numerically integrating the emissivity along the line of sight:\n$$ B(\\theta) = \\frac{1}{\\cos(\\theta)} \\int_0^L \\epsilon(x) \\, dx $$\nThe integral is computed using the trapezoidal rule over the discrete grid.\n\nThe validation workflow proceeds as follows:\n1.  A \"true\" set of transport parameters ($D_{\\text{true}}$, $V_{\\text{true}}$, $S_{0,\\text{true}}$) is used to run the simulation and generate a set of synthetic measurements, $B_{\\text{meas}}(\\theta)$, for the specified chord angles $\\theta \\in \\{0^\\circ, 30^\\circ, 60^\\circ\\}$.\n2.  Measurement uncertainties are defined as a fraction of the measurement: $\\sigma(\\theta) = f \\cdot B_{\\text{meas}}(\\theta)$, with $f=0.05$.\n3.  For each of the four candidate parameter sets, the simulation is run to obtain a simulated brightness $B_{\\text{sim}}(\\theta)$.\n4.  The goodness-of-fit for each candidate set is quantified by the normalized chi-squared metric:\n    $$ \\chi^2_{\\nu} = \\frac{1}{N_{\\text{chords}}} \\sum_{\\theta} \\left( \\frac{ B_{\\text{sim}}(\\theta) - B_{\\text{meas}}(\\theta) }{ \\sigma(\\theta) } \\right)^2 $$\nwhere $N_{\\text{chords}}=3$. This metric provides a quantitative measure of how well the simulated data from a given model reproduces the \"measurements\". A value close to $0$ indicates a perfect match.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve\n\ndef solve_workflow():\n    \"\"\"\n    Implements the end-to-end workflow for impurity transport validation.\n    \"\"\"\n\n    # --- 1. Define Constants and Grid ---\n    L = 0.1  # Slab thickness in m\n    N = 200  # Number of grid points\n    x = np.linspace(0, L, N)\n    dx = L / (N - 1)\n\n    # Plasma profiles\n    n_sep = 1.5e19  # m^-3\n    delta_n = 0.4e19  # m^-3\n    T_sep = 60.0  # eV\n    delta_T = 40.0  # eV\n    T_min = 10.0  # eV\n\n    # Impurity source and loss\n    lambda_S = 0.02  # m\n    K0 = 1.0e-14  # m^3 s^-1\n    E_iz = 25.0  # eV\n\n    # Boundary condition\n    n_wall = 1.0e15  # m^-3\n\n    # Emissivity model\n    C0 = 1.0e-20  # m^3 s^-1\n    E_exc = 30.0  # eV\n\n    # Diagnostic\n    angles_deg = np.array([0., 30., 60.])\n    angles_rad = np.deg2rad(angles_deg)\n    n_chords = len(angles_deg)\n\n    # Validation\n    f_unc = 0.05\n\n    # --- Helper functions for physical models ---\n    def get_ne_profile(x_coords):\n        return n_sep - delta_n * (x_coords / L)\n\n    def get_Te_profile(x_coords):\n        T_unclamped = T_sep - delta_T * (x_coords / L)\n        return np.maximum(T_unclamped, T_min)\n\n    def get_Kiz(Te):\n        # Avoid division by zero or log of zero if T is very small\n        Te_safe = np.maximum(Te, 1e-6)\n        return K0 * np.sqrt(Te_safe) * np.exp(-E_iz / Te_safe)\n\n    def get_C(Te):\n        Te_safe = np.maximum(Te, 1e-6)\n        return C0 * (Te_safe**-0.5) * np.exp(-E_exc / Te_safe)\n\n    # --- Pre-calculate static profiles ---\n    ne_profile = get_ne_profile(x)\n    Te_profile = get_Te_profile(x)\n    L_profile = ne_profile * get_Kiz(Te_profile)\n\n    # --- 2. Core Simulation Function ---\n    def run_simulation(D, V, S0):\n        \"\"\"Solves the BVP and computes brightness for given parameters.\"\"\"\n        \n        # Calculate source profile\n        S_profile = S0 * np.exp(-(L - x) / lambda_S)\n\n        # Assemble the linear system A * n_z = b\n        A = np.zeros((N, N))\n        b = np.zeros(N)\n\n        V_plus = max(V, 0)\n        V_minus = min(V, 0)\n        abs_V = abs(V)\n\n        # Interior points (i = 1 to N-2)\n        for i in range(1, N - 1):\n            sub_diag_coeff = -D / dx**2 - V_plus / dx\n            main_diag_coeff = 2 * D / dx**2 + abs_V / dx + L_profile[i]\n            sup_diag_coeff = -D / dx**2 + V_minus / dx\n            \n            A[i, i-1] = sub_diag_coeff\n            A[i, i]   = main_diag_coeff\n            A[i, i+1] = sup_diag_coeff\n            b[i]      = S_profile[i]\n\n        # Left boundary (i=0), Neumann BC: dn_z/dx=0\n        # Implemented via ghost cell n_z(-dx) = n_z(0)\n        # General stencil: a*n_{z,-1} + b*n_{z,0} + c*n_{z,1} = d\n        # Becomes: (a+b)*n_{z,0} + c*n_{z,1} = d\n        a0 = -D / dx**2 - V_plus / dx\n        b0 = 2 * D / dx**2 + abs_V / dx + L_profile[0]\n        c0 = -D / dx**2 + V_minus / dx\n        d0 = S_profile[0]\n\n        A[0, 0] = a0 + b0\n        A[0, 1] = c0\n        b[0] = d0\n\n        # Right boundary (i=N-1), Dirichlet BC: n_z(L) = n_wall\n        A[N-1, N-1] = 1.0\n        b[N-1] = n_wall\n        \n        # Solve for impurity density\n        n_z = solve(A, b)\n\n        # Forward model: calculate brightness\n        emissivity = ne_profile * n_z * get_C(Te_profile)\n        integral_emissivity = np.trapz(emissivity, x)\n        \n        brightness = integral_emissivity / np.cos(angles_rad)\n        return brightness\n\n    # --- 3. Validation Workflow ---\n    \n    # \"True\" parameters and synthetic measurement\n    D_true = 0.2\n    V_true = -5.0\n    S0_true = 3.0e20\n    \n    B_meas = run_simulation(D_true, V_true, S0_true)\n    sigma = f_unc * B_meas\n\n    # Test cases from the problem statement\n    test_cases = [\n        # Case A (happy path)\n        (0.2, -5.0, 3.0e20),\n        # Case B (diffusion underestimation)\n        (0.1, -5.0, 3.0e20),\n        # Case C (wrong convection direction)\n        (0.2, +5.0, 3.0e20),\n        # Case D (source too weak)\n        (0.2, -5.0, 1.0e20),\n    ]\n\n    chi_sq_results = []\n    for D_test, V_test, S0_test in test_cases:\n        B_sim = run_simulation(D_test, V_test, S0_test)\n        \n        # Handle potential division by zero in sigma\n        # For Case A, B_sim-B_meas is 0, so chi-sq is 0 even if sigma is 0\n        safe_sigma = np.where(sigma == 0, 1, sigma)\n        \n        chi_sq_nu = (1 / n_chords) * np.sum(((B_sim - B_meas) / safe_sigma)**2)\n        chi_sq_results.append(chi_sq_nu)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, chi_sq_results))}]\")\n\nsolve_workflow()\n```"
        }
    ]
}