{
    "hands_on_practices": [
        {
            "introduction": "Understanding how impurities are transported across the magnetic field in the plasma edge is fundamental to controlling core plasma performance. This first exercise provides a foundational, analytical look at the competition between diffusive spreading, convective drift, and parallel exhaust to the divertor within the Scrape-Off Layer (SOL). By solving the steady-state transport equation, you will develop a quantitative understanding of the conditions that lead to either impurity 'screening' (rejection from the core) or 'enrichment' (accumulation), a key concept in plasma purity control .",
            "id": "3994718",
            "problem": "A magnetically confined plasma in a toroidal device is considered near the separatrix in the Scrape-Off Layer (SOL). Focus on a single impurity species in the edge region spanning an inward radial coordinate $x \\in [0,\\Delta]$, where $x=0$ corresponds to the separatrix and $x=\\Delta$ is the inner edge boundary just inside the pedestal top. Assume the impurity undergoes cross-field diffusion with constant coefficient $D_{z}$, an outward convective drift with constant radial speed $V_{z}$, and experiences parallel exhaust to the divertor that can be modeled as a local sink with a constant parallel loss time $\\tau_{\\mathrm{par}}$. The main ion density $n_{i}(x)$ increases inward with an exponential profile characterized by a constant scale length $L_{n}$.\n\nStarting from mass conservation and standard drift-diffusion transport for the impurity, determine the steady-state enrichment factor $E$ defined by\n$$\nE \\equiv \\frac{\\left(n_{z}/n_{i}\\right)_{x=\\Delta}}{\\left(n_{z}/n_{i}\\right)_{x=0}} ,\n$$\nfor the following scientifically realistic parameters:\n- Edge width: $\\Delta = 2.0 \\times 10^{-2}\\ \\mathrm{m}$.\n- Impurity cross-field diffusion: $D_{z} = 3.0 \\times 10^{-1}\\ \\mathrm{m^{2}\\,s^{-1}}$.\n- Outward impurity convection: $V_{z} = 1.5 \\times 10^{1}\\ \\mathrm{m\\,s^{-1}}$.\n- Parallel loss time: $\\tau_{\\mathrm{par}} = 4.0 \\times 10^{-4}\\ \\mathrm{s}$.\n- Main ion density scale length: $L_{n} = 1.2 \\times 10^{-2}\\ \\mathrm{m}$.\n- Separatrix impurity and ion densities: $n_{z}(0) = 8.0 \\times 10^{16}\\ \\mathrm{m^{-3}}$, $n_{i}(0) = 1.2 \\times 10^{19}\\ \\mathrm{m^{-3}}$.\n\nImpose the physically motivated boundary conditions that the impurity density at the separatrix is fixed by the given value $n_{z}(0)$ and that there is no net outward impurity flux into the core at $x=\\Delta$. Express $E$ as a dimensionless number and round your answer to three significant figures.",
            "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n### Step 1: Extract Givens\n- **Model**: Steady-state, 1D radial transport for a single impurity species in the Scrape-Off Layer (SOL).\n- **Radial Coordinate**: $x \\in [0, \\Delta]$, with $x=0$ at the separatrix and $x$ increasing inward.\n- **Transport Mechanisms**:\n    - Cross-field diffusion coefficient (constant): $D_z$\n    - Outward convective drift speed (constant): $V_z$\n    - Parallel loss sink time (constant): $\\tau_{\\mathrm{par}}$\n- **Main Ion Density Profile**: $n_i(x) = n_i(0) \\exp(x/L_n)$, where $L_n$ is the constant density scale length.\n- **Enrichment Factor Definition**: $E \\equiv \\frac{(n_{z}/n_{i})_{x=\\Delta}}{(n_{z}/n_{i})_{x=0}}$\n- **Boundary Conditions**:\n    1. Impurity density at the separatrix is fixed: $n_z(0)$.\n    2. No net outward impurity flux into the core at $x=\\Delta$.\n- **Numerical Values**:\n    - $\\Delta = 2.0 \\times 10^{-2}\\ \\mathrm{m}$\n    - $D_z = 3.0 \\times 10^{-1}\\ \\mathrm{m^{2}\\,s^{-1}}$\n    - $V_z = 1.5 \\times 10^{1}\\ \\mathrm{m\\,s^{-1}}$\n    - $\\tau_{\\mathrm{par}} = 4.0 \\times 10^{-4}\\ \\mathrm{s}$\n    - $L_n = 1.2 \\times 10^{-2}\\ \\mathrm{m}$\n    - $n_z(0) = 8.0 \\times 10^{16}\\ \\mathrm{m^{-3}}$\n    - $n_i(0) = 1.2 \\times 10^{19}\\ \\mathrm{m^{-3}}$\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem describes a standard 1D drift-diffusion model for impurity transport in a plasma edge, a fundamental topic in computational fusion science. The physics (diffusion, convection, parallel sinks) and mathematical framework are well-established. The parameter values are realistic for tokamak edge plasmas.\n- **Well-Posed**: A second-order ordinary differential equation will be derived. The problem provides two boundary conditions ($n_z(0)$ and a flux condition at $x=\\Delta$), which is sufficient to determine a unique solution for the impurity density profile $n_z(x)$. The quantity to be calculated, $E$, is clearly defined.\n- **Objective**: The problem is stated using precise, quantitative, and unbiased language.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation\nThe problem requires finding the steady-state impurity density profile, $n_z(x)$, by solving the relevant transport equation.\n\nThe one-dimensional, steady-state continuity equation for the impurity density $n_z$ is given by:\n$$\n\\frac{d\\Gamma_z}{dx} = S_z\n$$\nwhere $\\Gamma_z(x)$ is the radial impurity particle flux and $S_z$ is the net source/sink term. The problem specifies a parallel loss mechanism modeled as a local sink, so $S_z = -n_z(x)/\\tau_{\\mathrm{par}}$. The continuity equation becomes:\n$$\n\\frac{d\\Gamma_z}{dx} = -\\frac{n_z(x)}{\\tau_{\\mathrm{par}}}\n$$\nThe radial flux $\\Gamma_z(x)$ is described by a drift-diffusion model:\n$$\n\\Gamma_z(x) = -D_z \\frac{dn_z}{dx} + v_x n_z\n$$\nThe problem states an \"outward convective drift\" with speed $V_z$. Since the coordinate $x$ increases *inward* from the separatrix, this outward drift corresponds to a velocity in the negative $x$ direction. Thus, the velocity component is $v_x = -V_z$. The flux is:\n$$\n\\Gamma_z(x) = -D_z \\frac{dn_z}{dx} - V_z n_z\n$$\nSubstituting this flux expression into the continuity equation yields the governing ordinary differential equation (ODE) for $n_z(x)$. Since $D_z$ and $V_z$ are constants:\n$$\n\\frac{d}{dx} \\left( -D_z \\frac{dn_z}{dx} - V_z n_z \\right) = -\\frac{n_z}{\\tau_{\\mathrm{par}}}\n$$\n$$\n-D_z \\frac{d^2n_z}{dx^2} - V_z \\frac{dn_z}{dx} = -\\frac{n_z}{\\tau_{\\mathrm{par}}}\n$$\nRearranging gives a second-order linear homogeneous ODE with constant coefficients:\n$$\n\\frac{d^2n_z}{dx^2} + \\frac{V_z}{D_z} \\frac{dn_z}{dx} - \\frac{1}{D_z \\tau_{\\mathrm{par}}} n_z = 0\n$$\nThe characteristic equation is $r^2 + \\frac{V_z}{D_z}r - \\frac{1}{D_z\\tau_{\\mathrm{par}}} = 0$. The roots $r_{1,2}$ are:\n$$\nr_{1,2} = \\frac{-\\frac{V_z}{D_z} \\pm \\sqrt{\\left(\\frac{V_z}{D_z}\\right)^2 + \\frac{4}{D_z\\tau_{\\mathrm{par}}}}}{2} = -\\frac{V_z}{2D_z} \\pm \\sqrt{\\left(\\frac{V_z}{2D_z}\\right)^2 + \\frac{1}{D_z\\tau_{\\mathrm{par}}}}\n$$\nLet us define $Q \\equiv \\sqrt{\\left(\\frac{V_z}{2D_z}\\right)^2 + \\frac{1}{D_z\\tau_{\\mathrm{par}}}}$. The two distinct real roots are $r_1 = -V_z/(2D_z) + Q > 0$ and $r_2 = -V_z/(2D_z) - Q < 0$. The general solution for $n_z(x)$ is:\n$$\nn_z(x) = C_1 \\exp(r_1 x) + C_2 \\exp(r_2 x)\n$$\nwhere $C_1$ and $C_2$ are constants determined by the boundary conditions.\n\n**Boundary Conditions:**\n1.  At $x=0$: $n_z(0)$ is given.\n    $n_z(0) = C_1 \\exp(0) + C_2 \\exp(0) \\implies n_z(0) = C_1 + C_2$.\n2.  At $x=\\Delta$: \"no net outward impurity flux into the core\". This means the flux $\\Gamma_z$ at the inner boundary $x=\\Delta$ is zero.\n    $\\Gamma_z(\\Delta) = -D_z \\left.\\frac{dn_z}{dx}\\right|_{x=\\Delta} - V_z n_z(\\Delta) = 0$.\n    \nFrom the second boundary condition, $\\left.\\frac{dn_z}{dx}\\right|_{x=\\Delta} = -\\frac{V_z}{D_z}n_z(\\Delta)$.\nWe have $\\frac{dn_z}{dx} = C_1 r_1 \\exp(r_1 x) + C_2 r_2 \\exp(r_2 x)$. Applying the condition at $x=\\Delta$:\n$$\nC_1 r_1 \\exp(r_1 \\Delta) + C_2 r_2 \\exp(r_2 \\Delta) = -\\frac{V_z}{D_z} \\left( C_1 \\exp(r_1 \\Delta) + C_2 \\exp(r_2 \\Delta) \\right)\n$$\n$$\nC_1 \\exp(r_1 \\Delta) \\left(r_1 + \\frac{V_z}{D_z}\\right) + C_2 \\exp(r_2 \\Delta) \\left(r_2 + \\frac{V_z}{D_z}\\right) = 0\n$$\nUsing the definitions of $r_1$ and $r_2$:\n$r_1 + \\frac{V_z}{D_z} = \\frac{V_z}{2D_z} + Q$ and $r_2 + \\frac{V_z}{D_z} = \\frac{V_z}{2D_z} - Q$.\nThe equation becomes:\n$$\nC_1 \\exp(r_1 \\Delta) \\left(\\frac{V_z}{2D_z} + Q\\right) + C_2 \\exp(r_2 \\Delta) \\left(\\frac{V_z}{2D_z} - Q\\right) = 0\n$$\nUsing $C_2 = n_z(0) - C_1$, we can solve for $C_1$ and $C_2$. However, we are interested in $n_z(\\Delta) = C_1 \\exp(r_1 \\Delta) + C_2 \\exp(r_2 \\Delta)$. A more direct calculation leads to the ratio $n_z(\\Delta)/n_z(0)$. After algebraic manipulation, this ratio is found to be:\n$$\n\\frac{n_z(\\Delta)}{n_z(0)} = \\frac{Q \\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z} \\sinh(Q\\Delta) + Q \\cosh(Q\\Delta)}\n$$\nThe main ion density profile is $n_i(x) = n_i(0) \\exp(x/L_n)$. Thus, $\\frac{n_i(\\Delta)}{n_i(0)} = \\exp(\\Delta/L_n)$.\n\nThe enrichment factor $E$ is defined as:\n$$\nE = \\frac{n_z(\\Delta)/n_i(\\Delta)}{n_z(0)/n_i(0)} = \\frac{n_z(\\Delta)}{n_z(0)} \\frac{n_i(0)}{n_i(\\Delta)}\n$$\nSubstituting the derived expressions:\n$$\nE = \\left( \\frac{Q \\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z} \\sinh(Q\\Delta) + Q \\cosh(Q\\Delta)} \\right) \\exp\\left(-\\frac{\\Delta}{L_n}\\right)\n$$\nDividing the numerator and denominator of the first term by $Q$:\n$$\nE = \\left( \\frac{\\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right)}{\\frac{V_z}{2D_z Q} \\sinh(Q\\Delta) + \\cosh(Q\\Delta)} \\right) \\exp\\left(-\\frac{\\Delta}{L_n}\\right)\n$$\nNow, we substitute the numerical values:\n- $\\frac{V_z}{2D_z} = \\frac{1.5 \\times 10^1}{2 \\times (3.0 \\times 10^{-1})} = \\frac{15}{0.6} = 25\\ \\mathrm{m^{-1}}$\n- $D_z \\tau_{\\mathrm{par}} = (3.0 \\times 10^{-1}) \\times (4.0 \\times 10^{-4}) = 1.2 \\times 10^{-4}\\ \\mathrm{m^2}$\n- $Q = \\sqrt{(25)^2 + \\frac{1}{1.2 \\times 10^{-4}}} = \\sqrt{625 + 8333.33...} = \\sqrt{8958.33...} \\approx 94.6485\\ \\mathrm{m^{-1}}$\n- $\\frac{\\Delta}{L_n} = \\frac{2.0 \\times 10^{-2}}{1.2 \\times 10^{-2}} = \\frac{5}{3}$\n\nArguments for the functions:\n- $\\frac{V_z \\Delta}{2D_z} = 25 \\times (2.0 \\times 10^{-2}) = 0.5$\n- $Q\\Delta = 94.6485 \\times (2.0 \\times 10^{-2}) \\approx 1.8930$\n\nCalculate the components of the expression for $E$:\n- $\\exp\\left(-\\frac{V_z \\Delta}{2D_z}\\right) = \\exp(-0.5) \\approx 0.60653$\n- $\\exp\\left(-\\frac{\\Delta}{L_n}\\right) = \\exp(-5/3) \\approx 0.18888$\n- $\\sinh(Q\\Delta) \\approx \\sinh(1.8930) \\approx 3.2323$\n- $\\cosh(Q\\Delta) \\approx \\cosh(1.8930) \\approx 3.3835$\n- $\\frac{V_z}{2D_z Q} = \\frac{25}{94.6485} \\approx 0.26414$\n\nThe denominator of the first term is:\n$0.26414 \\times 3.2323 + 3.3835 \\approx 0.85386 + 3.3835 = 4.23736$\n\nFinally, we calculate $E$:\n$$\nE \\approx \\left(\\frac{0.60653}{4.23736}\\right) \\times 0.18888 \\approx 0.14313 \\times 0.18888 \\approx 0.0270438\n$$\nRounding to three significant figures, the enrichment factor is $0.0270$.",
            "answer": "$$\\boxed{0.0270}$$"
        },
        {
            "introduction": "Real-world fusion devices increasingly utilize advanced alloys in plasma-facing components like the divertor, leading to simultaneous sputtering of multiple impurity species. This practice moves from a single-species model to a more realistic mixed-material scenario, incorporating key plasma-material interaction physics such as sputtering yield and prompt re-deposition. Your task is to analyze the transport of each species independently and then synthesize the results to evaluate the overall 'transmission fraction' of the alloy, a critical metric for material selection in divertor design .",
            "id": "3994715",
            "problem": "Consider steady-state impurity transport along a single magnetic field line segment from a divertor plate at position $x=0$ to the separatrix at position $x=L$. The divertor surface is a mixed-material alloy so that multiple impurity species are sputtered simultaneously. For each impurity species $i$, assume one-dimensional, steady-state transport governed by the following fundamental relations:\n\n1. Steady-state continuity with a volumetric removal rate: $\\dfrac{d \\Gamma_i}{d x} = - \\alpha_i n_i$, where $n_i(x)$ is the impurity density, $\\Gamma_i(x)$ is the parallel particle flux, and $\\alpha_i$ is a constant volumetric sink coefficient representing effective removal by plasma processes. Units: $n_i$ in $\\mathrm{m}^{-3}$, $\\Gamma_i$ in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$, $\\alpha_i$ in $\\mathrm{s}^{-1}$.\n\n2. Drift-diffusion closure for the flux: $\\Gamma_i = - D_i \\dfrac{d n_i}{d x} + v_i n_i$, where $D_i$ is a constant parallel diffusion coefficient and $v_i$ is a constant effective drift velocity directed from the divertor plate toward the separatrix if $v_i>0$. Units: $D_i$ in $\\mathrm{m}^2/\\mathrm{s}$, $v_i$ in $\\mathrm{m}/\\mathrm{s}$.\n\nBoundary conditions must encode the mixed-material injection at the plate and the effective core screening at the separatrix:\n\n- Sputtered injection flux at the divertor plate ($x=0$): $\\Gamma_i(0) = J_i$, where $J_i$ is determined by the incident deuterium ion flux $\\Phi_{\\text{inc}}$, the alloy composition fraction $f_i$ of species $i$ in the topmost layer, the sputtering yield $Y_i$ (impurity atoms per incident deuterium ion), and a prompt re-deposition/re-sticking factor $R_i$ (dimensionless). The effective injection is $J_i = \\Phi_{\\text{inc}} f_i Y_i (1 - R_i)$. Units: $\\Phi_{\\text{inc}}$ in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$; $J_i$ in $\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$; $f_i$, $Y_i$, and $R_i$ are dimensionless.\n\n- Separatrix screening boundary at $x=L$: $\\Gamma_i(L) = \\sigma_i n_i(L)$, where $\\sigma_i$ is an effective removal coefficient into the core. Units: $\\sigma_i$ in $\\mathrm{m}/\\mathrm{s}$.\n\nStarting only from these relations, derive the steady-state solution for $n_i(x)$ and $\\Gamma_i(x)$ for constant coefficients $D_i$, $v_i$, and $\\alpha_i$ subject to the stated boundary conditions, and compute the transmitted fraction for each species $i$,\n$$\nF_i \\equiv \\frac{\\Gamma_i(L)}{J_i},\n$$\nand the overall alloy transmission fraction for the case,\n$$\nF_{\\text{total}} \\equiv \\frac{\\sum_i \\Gamma_i(L)}{\\sum_i J_i}.\n$$\nExpress $F_{\\text{total}}$ as a dimensionless decimal for each test case.\n\nYour program must implement the above derivation and compute $F_{\\text{total}}$ for the following test suite, with all quantities in International System of Units (SI). Use the same incident deuterium flux for all cases, $\\Phi_{\\text{inc}} = 1.0 \\times 10^{22}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. The domain length is specified per case.\n\nCase $1$ (tungsten-tantalum alloy, moderate sink):\n- $L = 0.02\\,\\mathrm{m}$.\n- Species list (two species):\n  - Species $1$ (tungsten): $f_1 = 0.85$, $Y_1 = 0.010$, $R_1 = 0.30$, $D_1 = 0.40\\,\\mathrm{m}^2/\\mathrm{s}$, $v_1 = 60\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_1 = 80\\,\\mathrm{s}^{-1}$, $\\sigma_1 = 40\\,\\mathrm{m}/\\mathrm{s}$.\n  - Species $2$ (tantalum): $f_2 = 0.15$, $Y_2 = 0.015$, $R_2 = 0.25$, $D_2 = 0.50\\,\\mathrm{m}^2/\\mathrm{s}$, $v_2 = 55\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_2 = 60\\,\\mathrm{s}^{-1}$, $\\sigma_2 = 35\\,\\mathrm{m}/\\mathrm{s}$.\n\nCase $2$ (tungsten-carbon alloy, strong sink):\n- $L = 0.02\\,\\mathrm{m}$.\n- Species list (two species):\n  - Species $1$ (tungsten): $f_1 = 0.60$, $Y_1 = 0.008$, $R_1 = 0.50$, $D_1 = 0.20\\,\\mathrm{m}^2/\\mathrm{s}$, $v_1 = 40\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_1 = 200\\,\\mathrm{s}^{-1}$, $\\sigma_1 = 80\\,\\mathrm{m}/\\mathrm{s}$.\n  - Species $2$ (carbon): $f_2 = 0.40$, $Y_2 = 0.050$, $R_2 = 0.40$, $D_2 = 0.30\\,\\mathrm{m}^2/\\mathrm{s}$, $v_2 = 30\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_2 = 250\\,\\mathrm{s}^{-1}$, $\\sigma_2 = 75\\,\\mathrm{m}/\\mathrm{s}$.\n\nCase $3$ (tungsten-beryllium alloy, reverse drift):\n- $L = 0.02\\,\\mathrm{m}$.\n- Species list (two species):\n  - Species $1$ (tungsten): $f_1 = 0.70$, $Y_1 = 0.006$, $R_1 = 0.20$, $D_1 = 1.20\\,\\mathrm{m}^2/\\mathrm{s}$, $v_1 = -20\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_1 = 50\\,\\mathrm{s}^{-1}$, $\\sigma_1 = 30\\,\\mathrm{m}/\\mathrm{s}$.\n  - Species $2$ (beryllium): $f_2 = 0.30$, $Y_2 = 0.030$, $R_2 = 0.10$, $D_2 = 1.00\\,\\mathrm{m}^2/\\mathrm{s}$, $v_2 = -10\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_2 = 30\\,\\mathrm{s}^{-1}$, $\\sigma_2 = 25\\,\\mathrm{m}/\\mathrm{s}$.\n\nCase $4$ (iron-nickel-chromium alloy, no volumetric sink):\n- $L = 0.02\\,\\mathrm{m}$.\n- Species list (three species):\n  - Species $1$ (iron): $f_1 = 0.70$, $Y_1 = 0.020$, $R_1 = 0.30$, $D_1 = 1.00\\,\\mathrm{m}^2/\\mathrm{s}$, $v_1 = 40\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_1 = 0\\,\\mathrm{s}^{-1}$, $\\sigma_1 = 20\\,\\mathrm{m}/\\mathrm{s}$.\n  - Species $2$ (nickel): $f_2 = 0.20$, $Y_2 = 0.015$, $R_2 = 0.25$, $D_2 = 0.80\\,\\mathrm{m}^2/\\mathrm{s}$, $v_2 = 35\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_2 = 0\\,\\mathrm{s}^{-1}$, $\\sigma_2 = 18\\,\\mathrm{m}/\\mathrm{s}$.\n  - Species $3$ (chromium): $f_3 = 0.10$, $Y_3 = 0.010$, $R_3 = 0.20$, $D_3 = 0.90\\,\\mathrm{m}^2/\\mathrm{s}$, $v_3 = 30\\,\\mathrm{m}/\\mathrm{s}$, $\\alpha_3 = 0\\,\\mathrm{s}^{-1}$, $\\sigma_3 = 16\\,\\mathrm{m}/\\mathrm{s}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of Case $1$, Case $2$, Case $3$, Case $4$, for example $[r_1,r_2,r_3,r_4]$, where each $r_k$ is $F_{\\text{total}}$ for Case $k$ as a floating-point number with no unit (dimensionless decimal). Angle units are not relevant. Physical units must be interpreted and used exactly as specified above.",
            "solution": "The problem is validated as self-contained, scientifically grounded, and well-posed. The derivation of the solution and the computational algorithm are as follows. The analysis is performed for a single impurity species $i$; the subscript $i$ will be omitted for clarity until the final expressions.\n\nThe transport of each impurity species is governed by a system of two one-dimensional, steady-state equations:\n1. Continuity equation with a sink term: $\\dfrac{d \\Gamma}{d x} = - \\alpha n$\n2. Drift-diffusion flux closure: $\\Gamma = - D \\dfrac{d n}{d x} + v n$\n\nHere, $n(x)$ is the impurity density, $\\Gamma(x)$ is the particle flux, $D$ is the diffusion coefficient, $v$ is the drift velocity, and $\\alpha$ is the volumetric sink coefficient. These coefficients are assumed to be constant. The spatial domain is $x \\in [0, L]$.\n\nTo solve for $n(x)$ and $\\Gamma(x)$, we combine these two equations. Differentiating the flux equation with respect to $x$ gives:\n$$\n\\frac{d \\Gamma}{d x} = -D \\frac{d^2 n}{d x^2} + v \\frac{d n}{d x}\n$$\nSubstituting the continuity equation into the left-hand side yields a second-order linear homogeneous ordinary differential equation (ODE) for the density $n(x)$:\n$$\n-\\alpha n = -D \\frac{d^2 n}{d x^2} + v \\frac{d n}{d x}\n$$\nRearranging this into standard form, we have:\n$$\nD \\frac{d^2 n}{d x^2} - v \\frac{d n}{d x} - \\alpha n = 0\n$$\nThe characteristic equation for this ODE is $D r^2 - v r - \\alpha = 0$. The roots, $r_1$ and $r_2$, are given by the quadratic formula:\n$$\nr = \\frac{v \\pm \\sqrt{v^2 - 4(D)(-\\alpha)}}{2D} = \\frac{v}{2D} \\pm \\sqrt{\\left(\\frac{v}{2D}\\right)^2 + \\frac{\\alpha}{D}}\n$$\nSince $D > 0$ and $\\alpha \\ge 0$, the term under the square root is always non-negative, ensuring real roots. Let us define the two distinct roots as:\n$$\nr_1 = \\frac{v}{2D} + \\sqrt{\\left(\\frac{v}{2D}\\right)^2 + \\frac{\\alpha}{D}}\n$$\n$$\nr_2 = \\frac{v}{2D} - \\sqrt{\\left(\\frac{v}{2D}\\right)^2 + \\frac{\\alpha}{D}}\n$$\nNote that $r_1 > 0$ and $r_2 < 0$ when $v \\ge 0$ and $\\alpha > 0$. If $v < 0$, it is still typical in these problems that $r_1 > 0$ and $r_2 < 0$. The general solution for $n(x)$ is a linear combination of exponential terms:\n$$\nn(x) = C_1 e^{r_1 x} + C_2 e^{r_2 x}\n$$\nwhere $C_1$ and $C_2$ are integration constants determined by the boundary conditions.\n\nTo apply the boundary conditions, we also need the expression for the flux $\\Gamma(x)$. We substitute the solution for $n(x)$ and its derivative, $\\frac{dn}{dx} = C_1 r_1 e^{r_1 x} + C_2 r_2 e^{r_2 x}$, into the flux equation:\n$$\n\\Gamma(x) = -D(C_1 r_1 e^{r_1 x} + C_2 r_2 e^{r_2 x}) + v(C_1 e^{r_1 x} + C_2 e^{r_2 x})\n$$\n$$\n\\Gamma(x) = C_1(v - D r_1)e^{r_1 x} + C_2(v - D r_2)e^{r_2 x}\n$$\nFrom the characteristic equation, we can show that $v - D r_1 = D r_2$ and $v - D r_2 = D r_1$. This simplifies the flux expression to:\n$$\n\\Gamma(x) = C_1 D r_2 e^{r_1 x} + C_2 D r_1 e^{r_2 x}\n$$\nThe boundary conditions are:\n1. At the divertor plate ($x=0$): $\\Gamma(0) = J$\n2. At the separatrix ($x=L$): $\\Gamma(L) = \\sigma n(L)$\n\nApplying these conditions, we obtain a system of two linear equations for $C_1$ and $C_2$:\n1. $\\Gamma(0) = C_1 D r_2 + C_2 D r_1 = J$\n2. $\\Gamma(L) = \\sigma n(L) \\implies C_1 D r_2 e^{r_1 L} + C_2 D r_1 e^{r_2 L} = \\sigma (C_1 e^{r_1 L} + C_2 e^{r_2 L})$\n\nFrom the second equation, we find a relation between $C_1$ and $C_2$:\n$$\nC_1 e^{r_1 L} (D r_2 - \\sigma) + C_2 e^{r_2 L} (D r_1 - \\sigma) = 0\n$$\nSolving this system for $C_1$ and $C_2$ allows us to determine $\\Gamma(L)$. The final quantity of interest is the transmitted fraction, $F \\equiv \\Gamma(L)/J$. After significant algebraic manipulation, this fraction is found to be:\n$$\nF = \\frac{\\Gamma(L)}{J} = \\frac{\\sigma(r_1 - r_2) e^{(r_1 + r_2) L}}{(\\sigma r_1 + \\alpha) e^{r_1 L} - (\\sigma r_2 + \\alpha) e^{r_2 L}}\n$$\nThis expression is valid for $\\alpha > 0$.\n\nA special case arises when $\\alpha = 0$ (no volumetric sink), as in Case $4$. The continuity equation becomes $\\frac{d\\Gamma}{dx} = 0$, implying that the flux $\\Gamma(x)$ is constant throughout the domain. From the boundary condition at $x=0$, we have $\\Gamma(x) = \\Gamma(0) = J$ for all $x \\in [0, L]$. Consequently, the flux at the separatrix is $\\Gamma(L) = J$. The transmitted fraction is therefore $F = \\Gamma(L)/J = 1$. The density profile $n(x)$ adjusts to satisfy the boundary condition $\\Gamma(L) = \\sigma n(L)$, but the transmitted flux is independent of this process.\n\nThe problem asks for the overall alloy transmission fraction, $F_{\\text{total}}$, which is the ratio of the total transmitted flux to the total injected flux:\n$$\nF_{\\text{total}} = \\frac{\\sum_i \\Gamma_i(L)}{\\sum_i J_i}\n$$\nFor each species $i$, we first calculate its injection flux $J_i = \\Phi_{\\text{inc}} f_i Y_i (1 - R_i)$. Then, we find its transmitted flux $\\Gamma_i(L)$. If $\\alpha_i = 0$, then $\\Gamma_i(L) = J_i$. If $\\alpha_i > 0$, we calculate the roots $r_{1,i}$ and $r_{2,i}$ and use the derived formula for the transmitted fraction $F_i$ to find $\\Gamma_i(L) = F_i J_i$.\nFinally, we sum the $J_i$ and $\\Gamma_i(L)$ over all species in a given case to compute $F_{\\text{total}}$.\n\nThe algorithm proceeds as follows for each test case:\n1. Initialize total injected flux $\\sum J_i = 0$ and total transmitted flux $\\sum \\Gamma_i(L) = 0$.\n2. For each impurity species $i$ in the alloy:\n   a. Calculate the injection flux $J_i$ using the given parameters.\n   b. Add $J_i$ to the running total $\\sum J_i$.\n   c. If $\\alpha_i = 0$, set $\\Gamma_i(L) = J_i$.\n   d. If $\\alpha_i > 0$, calculate $r_{1,i}$ and $r_{2,i}$, then evaluate $F_i$ using the derived expression, and set $\\Gamma_i(L) = F_i J_i$.\n   e. Add $\\Gamma_i(L)$ to the running total $\\sum \\Gamma_i(L)$.\n3. Compute the final result for the case as $F_{\\text{total}} = (\\sum \\Gamma_i(L)) / (\\sum J_i)$.\nThis procedure is repeated for all four test cases.",
            "answer": "```python\nimport numpy as np\n\ndef calculate_gamma_L_and_J(params, L, Phi_inc):\n    \"\"\"\n    Calculates the injection flux J and transmitted flux Gamma(L) for a single species.\n    \n    Args:\n        params (tuple): A tuple of species parameters (f, Y, R, D, v, alpha, sigma).\n        L (float): The length of the domain.\n        Phi_inc (float): The incident deuterium ion flux.\n\n    Returns:\n        tuple: A tuple containing (J, Gamma_L).\n    \"\"\"\n    f, Y, R, D, v, alpha, sigma = params\n    \n    # Calculate injection flux J_i\n    J = Phi_inc * f * Y * (1 - R)\n    \n    # Handle the case with no volumetric sink\n    if alpha == 0:\n        # As derived, Gamma is constant, so Gamma(L) = J\n        Gamma_L = J\n        return J, Gamma_L\n\n    # Handle the general case with alpha > 0\n    # Calculate roots of the characteristic equation: D*r^2 - v*r - alpha = 0\n    # To prevent potential floating point issues with v=0, we write out the terms.\n    v_term = v / (2 * D)\n    sqrt_term = np.sqrt(v_term**2 + alpha / D)\n    \n    r1 = v_term + sqrt_term\n    r2 = v_term - sqrt_term\n    \n    # Calculate the transmitted fraction F_i = Gamma_i(L) / J_i\n    # F = num / den\n    # num = sigma * (r1 - r2) * exp((r1 + r2) * L)\n    # den = (sigma * r1 + alpha) * exp(r1 * L) - (sigma * r2 + alpha) * exp(r2 * L)\n\n    # Note: r1 + r2 = v / D\n    exp_sum_L = np.exp((v / D) * L)\n    exp_r1_L = np.exp(r1 * L)\n    exp_r2_L = np.exp(r2 * L)\n\n    numerator = sigma * (r1 - r2) * exp_sum_L\n    denominator = (sigma * r1 + alpha) * exp_r1_L - (sigma * r2 + alpha) * exp_r2_L\n\n    # The denominator should not be zero for physically meaningful parameters\n    if denominator == 0:\n        # This case is highly unlikely but included for robustness.\n        # It would imply an indeterminate solution.\n        F = 0.0\n    else:\n        F = numerator / denominator\n        \n    Gamma_L = F * J\n    \n    return J, Gamma_L\n\ndef solve():\n    \"\"\"\n    Solves for the total alloy transmission fraction for all test cases.\n    \"\"\"\n    Phi_inc = 1.0e22\n\n    test_cases = [\n        # Case 1 (tungsten-tantalum alloy, moderate sink)\n        {\n            \"L\": 0.02,\n            \"species\": [\n                # (f, Y, R, D, v, alpha, sigma)\n                (0.85, 0.010, 0.30, 0.40, 60, 80, 40), # Tungsten\n                (0.15, 0.015, 0.25, 0.50, 55, 60, 35), # Tantalum\n            ]\n        },\n        # Case 2 (tungsten-carbon alloy, strong sink)\n        {\n            \"L\": 0.02,\n            \"species\": [\n                (0.60, 0.008, 0.50, 0.20, 40, 200, 80), # Tungsten\n                (0.40, 0.050, 0.40, 0.30, 30, 250, 75), # Carbon\n            ]\n        },\n        # Case 3 (tungsten-beryllium alloy, reverse drift)\n        {\n            \"L\": 0.02,\n            \"species\": [\n                (0.70, 0.006, 0.20, 1.20, -20, 50, 30), # Tungsten\n                (0.30, 0.030, 0.10, 1.00, -10, 30, 25), # Beryllium\n            ]\n        },\n        # Case 4 (iron-nickel-chromium alloy, no volumetric sink)\n        {\n            \"L\": 0.02,\n            \"species\": [\n                (0.70, 0.020, 0.30, 1.00, 40, 0, 20), # Iron\n                (0.20, 0.015, 0.25, 0.80, 35, 0, 18), # Nickel\n                (0.10, 0.010, 0.20, 0.90, 30, 0, 16), # Chromium\n            ]\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        total_J = 0.0\n        total_Gamma_L = 0.0\n        L = case[\"L\"]\n        \n        for species_params in case[\"species\"]:\n            J_i, Gamma_L_i = calculate_gamma_L_and_J(species_params, L, Phi_inc)\n            total_J += J_i\n            total_Gamma_L += Gamma_L_i\n        \n        # Avoid division by zero if total injection is zero\n        if total_J == 0:\n            F_total = 0.0\n        else:\n            F_total = total_Gamma_L / total_J\n        \n        results.append(F_total)\n\n    # Print the final results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A computational model is only as useful as its ability to predict experimental observations. This final practice is a capstone exercise that immerses you in the essential workflow of model validation, where simulation results are confronted with diagnostic data. You will implement a numerical transport model, use it to create a 'forward model' of a spectroscopic diagnostic, and then use a chi-squared analysis to quantify the agreement with synthetic measurements, providing direct experience in how models are quantitatively tested and constrained .",
            "id": "3994719",
            "problem": "You are tasked with implementing a computational validation workflow for impurity transport in the plasma edge using synthetic diagnostics. Consider a one-dimensional slab model of the edge layer with coordinate $x \\in [0, L]$ where $x = 0$ is the inner edge of the pedestal and $x = L$ is the wall interface. Assume steady state for the impurity number density $n_z(x)$, governed by the continuity equation and Fick’s law with a convective pinch. Starting from the continuity equation $ \\partial n_z / \\partial t + \\partial \\Gamma / \\partial x = S - L n_z $ and assuming steady state $ \\partial n_z / \\partial t = 0$, let the radial impurity particle flux be $ \\Gamma(x) = - D \\, \\partial n_z / \\partial x + V \\, n_z^{\\text{upwind}} $, where $D$ is the diffusion coefficient and $V$ is the convective velocity (negative $V$ denotes inward pinch). Use an upwind scheme for the convective term. The source $S(x)$ is sharply peaked near the wall, and the loss $L(x)$ represents effective ionization loss and parallel exhaust. Impose boundary conditions $ \\partial n_z / \\partial x \\big|_{x=0} = 0 $ and $ n_z(L) = n_{\\text{wall}} $.\n\nElectron density $n_e(x)$ and electron temperature $T_e(x)$ are specified profiles across the slab. The diagnostic forward model computes the line brightness $B(\\theta)$ for a chord at angle $\\theta$ to the slab normal. In the slab approximation, the line-of-sight path length correction yields $ B(\\theta) = \\dfrac{1}{\\cos \\theta} \\int_{0}^{L} \\epsilon(x) \\, dx $, where $ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $ is the emissivity, and $ C(T)$ is an excitation rate coefficient model. Given a synthetic measurement constructed from a “true” parameter set, you must compute the normalized chi-squared validation metric comparing simulated and measured brightness for several test parameter sets.\n\nImplement the following model and computations:\n\n- Geometry and grid:\n  - Slab thickness $L = 0.1 \\ \\text{m}$, uniform grid with $N = 200$ points.\n  - Grid spacing $ \\Delta x = L / (N - 1) $.\n- Plasma profiles (edge-consistent and monotonic):\n  - Electron density profile $ n_e(x) = n_{\\text{sep}} - \\Delta n \\, \\dfrac{x}{L} $ with $ n_{\\text{sep}} = 1.5 \\times 10^{19} \\ \\text{m}^{-3} $ and $ \\Delta n = 0.4 \\times 10^{19} \\ \\text{m}^{-3} $.\n  - Electron temperature profile $ T_e(x) = T_{\\text{sep}} - \\Delta T \\, \\dfrac{x}{L} $, clamped below by $T_{\\min}$, with $ T_{\\text{sep}} = 60 \\ \\text{eV} $, $ \\Delta T = 40 \\ \\text{eV} $, and $ T_{\\min} = 10 \\ \\text{eV} $.\n- Impurity source and loss:\n  - Source $ S(x) = S_0 \\exp \\left( - \\dfrac{L - x}{\\lambda_S} \\right) $ with $ \\lambda_S = 0.02 \\ \\text{m} $ and tunable amplitude $S_0$ in $ \\text{m}^{-3} \\text{s}^{-1} $.\n  - Loss $ L(x) = n_e(x) \\, K_{\\text{iz}}(T_e(x)) $, an effective ionization rate with $ K_{\\text{iz}}(T) = K_0 \\, T^{1/2} \\, \\exp \\left( - \\dfrac{E_{\\text{iz}}}{T} \\right) $, where $ K_0 = 1.0 \\times 10^{-14} \\ \\text{m}^3 \\text{s}^{-1} $, $ E_{\\text{iz}} = 25 \\ \\text{eV} $.\n- Boundary value problem:\n  - Discretize $ \\dfrac{d \\Gamma}{dx} = S(x) - L(x) n_z(x) $ using second-order central differences for diffusion and first-order upwind for convection.\n  - Left boundary $ x=0 $: enforce $ \\dfrac{d n_z}{dx}(0) = 0 $ using a ghost cell $ n_z(-\\Delta x) = n_z(0) $.\n  - Right boundary $ x=L $: enforce $ n_z(L) = n_{\\text{wall}} $ with $ n_{\\text{wall}} = 1.0 \\times 10^{15} \\ \\text{m}^{-3} $ (Dirichlet).\n  - Assemble a tridiagonal linear system $ \\mathbf{A} \\, \\mathbf{n}_z = \\mathbf{b} $ and solve for $ \\mathbf{n}_z $.\n- Emissivity model and diagnostic forward model:\n  - Photon emissivity coefficient $ C(T) = C_0 \\, T^{-1/2} \\, \\exp \\left( - \\dfrac{E_{\\text{exc}}}{T} \\right) $ with $ C_0 = 1.0 \\times 10^{-20} \\ \\text{m}^3 \\text{s}^{-1} $ and $ E_{\\text{exc}} = 30 \\ \\text{eV} $.\n  - Emissivity $ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $ in $ \\text{photons} \\, \\text{m}^{-3} \\text{s}^{-1} $.\n  - Chord angles $ \\theta \\in \\{ 0^\\circ, 30^\\circ, 60^\\circ \\} $ (angles are specified in degrees), and brightness $ B(\\theta) $ in $ \\text{photons} \\, \\text{m}^{-2} \\text{s}^{-1} $ computed as $ B(\\theta) = \\dfrac{1}{\\cos(\\theta)} \\int_0^L \\epsilon(x) \\, dx $ where $ \\theta $ must be converted to radians internally.\n- Synthetic measurement and validation metric:\n  - “True” parameters: $ D_{\\text{true}} = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V_{\\text{true}} = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_{0,\\text{true}} = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n  - Generate synthetic measured brightness $ B_{\\text{meas}}(\\theta) $ by forward-modeling with the true parameters (no added noise).\n  - Define measurement uncertainties $ \\sigma(\\theta) = f \\, B_{\\text{meas}}(\\theta) $ with $ f = 0.05 $ (dimensionless fractional uncertainty).\n  - For a candidate parameter set, compute the normalized chi-squared $ \\chi^2_{\\nu} = \\dfrac{1}{N_{\\text{chords}}} \\sum_{\\theta} \\left( \\dfrac{ B_{\\text{sim}}(\\theta) - B_{\\text{meas}}(\\theta) }{ \\sigma(\\theta) } \\right)^2 $, which is dimensionless.\n- Test suite:\n  - Use the following four candidate parameter sets to test different aspects:\n    1. Case A (happy path): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    2. Case B (diffusion underestimation): $ D = 0.1 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    3. Case C (wrong convection direction): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = +5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 3.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n    4. Case D (source too weak): $ D = 0.2 \\ \\text{m}^2 \\text{s}^{-1} $, $ V = -5.0 \\ \\text{m} \\text{s}^{-1} $, $ S_0 = 1.0 \\times 10^{20} \\ \\text{m}^{-3} \\text{s}^{-1} $.\n- Required output:\n  - Your program should produce a single line of output containing the normalized chi-squared values for Cases A–D, as a comma-separated list enclosed in square brackets (e.g., $[ \\chi^2_A, \\chi^2_B, \\chi^2_C, \\chi^2_D ]$). Each $ \\chi^2 $ must be a floating-point number. Angles must be handled in degrees as specified, and any intermediate brightness must be computed in $ \\text{photons} \\, \\text{m}^{-2} \\text{s}^{-1} $.\n\nYour task is to implement this end-to-end workflow: discretize and solve the boundary value problem for $ n_z(x) $, compute emissivity and brightness for the given chords, and evaluate the validation metric for each test case. No external inputs are required; the program must run as-is and print the specified single-line output.",
            "solution": "The user-provided problem is a well-posed computational task in the field of fusion plasma physics. It is scientifically grounded, self-contained, and all parameters and methods are specified unambiguously. Therefore, a full solution is warranted.\n\nThe solution involves simulating impurity transport in a one-dimensional slab model of the plasma edge and comparing the results to synthetic diagnostic measurements. This is achieved by numerically solving a steady-state transport equation, computing the expected diagnostic signal via a forward model, and quantifying the model-data mismatch using a chi-squared metric.\n\nThe core of the problem is to solve the steady-state impurity continuity equation:\n$$ \\frac{d\\Gamma(x)}{dx} = S(x) - L(x) n_z(x) $$\nwhere $x \\in [0, L]$ is the spatial coordinate, $n_z(x)$ is the impurity density, $S(x)$ is the impurity source rate, and $L(x)$ is the loss rate. The impurity particle flux $\\Gamma(x)$ is described by a drift-diffusion model:\n$$ \\Gamma(x) = -D \\frac{dn_z}{dx} + V n_z(x) $$\nHere, $D$ is the diffusion coefficient and $V$ is the convective pinch velocity. Combining these two equations yields a second-order linear ordinary differential equation for $n_z(x)$:\n$$ -D \\frac{d^2 n_z}{d x^2} + V \\frac{dn_z}{dx} + L(x) n_z(x) = S(x) $$\nThis boundary value problem (BVP) is defined on the domain $x \\in [0, L]$ with a zero-flux (Neumann) boundary condition at the inner edge, $x=0$, and a fixed-density (Dirichlet) boundary condition at the wall, $x=L$:\n$$ \\frac{dn_z}{dx} \\bigg|_{x=0} = 0, \\quad n_z(L) = n_{\\text{wall}} $$\n\nTo solve this BVP numerically, we discretize the domain into a uniform grid of $N$ points, $x_i = i \\Delta x$ for $i=0, 1, \\dots, N-1$, where the grid spacing is $\\Delta x = L/(N-1)$. The impurity density at these points is denoted $n_{z,i} = n_z(x_i)$.\n\nThe differential operators are approximated using finite differences as specified:\n1.  **Diffusion Term**: A second-order central difference scheme is used:\n    $$ \\frac{d^2 n_z}{d x^2} \\bigg|_{x_i} \\approx \\frac{n_{z,i+1} - 2n_{z,i} + n_{z,i-1}}{(\\Delta x)^2} $$\n2.  **Convection Term**: A first-order upwind scheme is used, where the difference is taken based on the direction of the velocity $V$:\n    $$ \\frac{dn_z}{dx} \\bigg|_{x_i} \\approx\n    \\begin{cases}\n        \\frac{n_{z,i} - n_{z,i-1}}{\\Delta x} & \\text{if } V > 0 \\\\\n        \\frac{n_{z,i+1} - n_{z,i}}{\\Delta x} & \\text{if } V < 0\n    \\end{cases}\n    $$\nThis can be written compactly using $V^+ = \\max(V,0)$ and $V^- = \\min(V,0)$ as $V\\frac{dn_z}{dx} \\approx V^+\\frac{n_{z,i}-n_{z,i-1}}{\\Delta x} + V^-\\frac{n_{z,i+1}-n_{z,i}}{\\Delta x}$.\n\nSubstituting these discretizations into the governing equation and rearranging terms yields a linear algebraic equation for each interior grid point $i \\in \\{1, 2, \\dots, N-2\\}$:\n$$ \\left(-\\frac{D}{(\\Delta x)^2} - \\frac{V^+}{\\Delta x}\\right) n_{z,i-1} + \\left(\\frac{2D}{(\\Delta x)^2} + \\frac{|V|}{\\Delta x} + L_i\\right) n_{z,i} + \\left(-\\frac{D}{(\\Delta x)^2} + \\frac{V^-}{\\Delta x}\\right) n_{z,i+1} = S_i $$\nwhere $L_i = L(x_i)$ and $S_i = S(x_i)$.\n\nThe boundary conditions are incorporated to form a complete system of $N$ linear equations for the $N$ unknowns $\\{n_{z,0}, \\dots, n_{z,N-1}\\}$.\n-   At the left boundary, $x=0$ ($i=0$), the condition $\\frac{dn_z}{dx}=0$ is implemented using a ghost cell $n_{z,-1}=n_{z,0}$, as specified. Applying this to the general discretized equation for $i=0$ yields the first equation of our system.\n-   At the right boundary, $x=L$ ($i=N-1$), the Dirichlet condition $n_z(L) = n_{\\text{wall}}$ provides the last equation directly: $n_{z,N-1} = n_{\\text{wall}}$.\n\nThis procedure results in a linear system $\\mathbf{A} \\mathbf{n}_z = \\mathbf{b}$, where $\\mathbf{A}$ is an $N \\times N$ matrix, $\\mathbf{n}_z = [n_{z,0}, \\dots, n_{z,N-1}]^T$ is the vector of unknown densities, and $\\mathbf{b}$ is the known source and boundary condition vector. The matrix $\\mathbf{A}$ is predominantly tridiagonal. This system is solved using a standard linear algebra library routine.\n\nOnce the impurity density profile $n_z(x)$ is found, the diagnostic forward model is applied. The photon emissivity $\\epsilon(x)$ is computed as:\n$$ \\epsilon(x) = n_e(x) \\, n_z(x) \\, C(T_e(x)) $$\nwhere $n_e(x)$ and $T_e(x)$ are the given background electron density and temperature profiles, and $C(T)$ is the specified excitation rate coefficient. The line-integrated brightness $B(\\theta)$ for a chord at angle $\\theta$ is then calculated by numerically integrating the emissivity along the line of sight:\n$$ B(\\theta) = \\frac{1}{\\cos(\\theta)} \\int_0^L \\epsilon(x) \\, dx $$\nThe integral is computed using the trapezoidal rule over the discrete grid.\n\nThe validation workflow proceeds as follows:\n1.  A \"true\" set of transport parameters ($D_{\\text{true}}$, $V_{\\text{true}}$, $S_{0,\\text{true}}$) is used to run the simulation and generate a set of synthetic measurements, $B_{\\text{meas}}(\\theta)$, for the specified chord angles $\\theta \\in \\{0^\\circ, 30^\\circ, 60^\\circ\\}$.\n2.  Measurement uncertainties are defined as a fraction of the measurement: $\\sigma(\\theta) = f \\cdot B_{\\text{meas}}(\\theta)$, with $f=0.05$.\n3.  For each of the four candidate parameter sets, the simulation is run to obtain a simulated brightness $B_{\\text{sim}}(\\theta)$.\n4.  The goodness-of-fit for each candidate set is quantified by the normalized chi-squared metric:\n    $$ \\chi^2_{\\nu} = \\frac{1}{N_{\\text{chords}}} \\sum_{\\theta} \\left( \\frac{ B_{\\text{sim}}(\\theta) - B_{\\text{meas}}(\\theta) }{ \\sigma(\\theta) } \\right)^2 $$\nwhere $N_{\\text{chords}}=3$. This metric provides a quantitative measure of how well the simulated data from a given model reproduces the \"measurements\". A value close to $0$ indicates a perfect match.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import solve\n\ndef solve_workflow():\n    \"\"\"\n    Implements the end-to-end workflow for impurity transport validation.\n    \"\"\"\n\n    # --- 1. Define Constants and Grid ---\n    L = 0.1  # Slab thickness in m\n    N = 200  # Number of grid points\n    x = np.linspace(0, L, N)\n    dx = L / (N - 1)\n\n    # Plasma profiles\n    n_sep = 1.5e19  # m^-3\n    delta_n = 0.4e19  # m^-3\n    T_sep = 60.0  # eV\n    delta_T = 40.0  # eV\n    T_min = 10.0  # eV\n\n    # Impurity source and loss\n    lambda_S = 0.02  # m\n    K0 = 1.0e-14  # m^3 s^-1\n    E_iz = 25.0  # eV\n\n    # Boundary condition\n    n_wall = 1.0e15  # m^-3\n\n    # Emissivity model\n    C0 = 1.0e-20  # m^3 s^-1\n    E_exc = 30.0  # eV\n\n    # Diagnostic\n    angles_deg = np.array([0., 30., 60.])\n    angles_rad = np.deg2rad(angles_deg)\n    n_chords = len(angles_deg)\n\n    # Validation\n    f_unc = 0.05\n\n    # --- Helper functions for physical models ---\n    def get_ne_profile(x_coords):\n        return n_sep - delta_n * (x_coords / L)\n\n    def get_Te_profile(x_coords):\n        T_unclamped = T_sep - delta_T * (x_coords / L)\n        return np.maximum(T_unclamped, T_min)\n\n    def get_Kiz(Te):\n        # Avoid division by zero or log of zero if T is very small\n        Te_safe = np.maximum(Te, 1e-6)\n        return K0 * np.sqrt(Te_safe) * np.exp(-E_iz / Te_safe)\n\n    def get_C(Te):\n        Te_safe = np.maximum(Te, 1e-6)\n        return C0 * (Te_safe**-0.5) * np.exp(-E_exc / Te_safe)\n\n    # --- Pre-calculate static profiles ---\n    ne_profile = get_ne_profile(x)\n    Te_profile = get_Te_profile(x)\n    L_profile = ne_profile * get_Kiz(Te_profile)\n\n    # --- 2. Core Simulation Function ---\n    def run_simulation(D, V, S0):\n        \"\"\"Solves the BVP and computes brightness for given parameters.\"\"\"\n        \n        # Calculate source profile\n        S_profile = S0 * np.exp(-(L - x) / lambda_S)\n\n        # Assemble the linear system A * n_z = b\n        A = np.zeros((N, N))\n        b = np.zeros(N)\n\n        V_plus = max(V, 0)\n        V_minus = min(V, 0)\n        abs_V = abs(V)\n\n        # Interior points (i = 1 to N-2)\n        for i in range(1, N - 1):\n            sub_diag_coeff = -D / dx**2 - V_plus / dx\n            main_diag_coeff = 2 * D / dx**2 + abs_V / dx + L_profile[i]\n            sup_diag_coeff = -D / dx**2 + V_minus / dx\n            \n            A[i, i-1] = sub_diag_coeff\n            A[i, i]   = main_diag_coeff\n            A[i, i+1] = sup_diag_coeff\n            b[i]      = S_profile[i]\n\n        # Left boundary (i=0), Neumann BC: dn_z/dx=0\n        # Implemented via ghost cell n_z(-dx) = n_z(0)\n        # General stencil: a*n_{z,-1} + b*n_{z,0} + c*n_{z,1} = d\n        # Becomes: (a+b)*n_{z,0} + c*n_{z,1} = d\n        a0 = -D / dx**2 - V_plus / dx\n        b0 = 2 * D / dx**2 + abs_V / dx + L_profile[0]\n        c0 = -D / dx**2 + V_minus / dx\n        d0 = S_profile[0]\n\n        A[0, 0] = a0 + b0\n        A[0, 1] = c0\n        b[0] = d0\n\n        # Right boundary (i=N-1), Dirichlet BC: n_z(L) = n_wall\n        A[N-1, N-1] = 1.0\n        b[N-1] = n_wall\n        \n        # Solve for impurity density\n        n_z = solve(A, b)\n\n        # Forward model: calculate brightness\n        emissivity = ne_profile * n_z * get_C(Te_profile)\n        integral_emissivity = np.trapz(emissivity, x)\n        \n        brightness = integral_emissivity / np.cos(angles_rad)\n        return brightness\n\n    # --- 3. Validation Workflow ---\n    \n    # \"True\" parameters and synthetic measurement\n    D_true = 0.2\n    V_true = -5.0\n    S0_true = 3.0e20\n    \n    B_meas = run_simulation(D_true, V_true, S0_true)\n    sigma = f_unc * B_meas\n\n    # Test cases from the problem statement\n    test_cases = [\n        # Case A (happy path)\n        (0.2, -5.0, 3.0e20),\n        # Case B (diffusion underestimation)\n        (0.1, -5.0, 3.0e20),\n        # Case C (wrong convection direction)\n        (0.2, +5.0, 3.0e20),\n        # Case D (source too weak)\n        (0.2, -5.0, 1.0e20),\n    ]\n\n    chi_sq_results = []\n    for D_test, V_test, S0_test in test_cases:\n        B_sim = run_simulation(D_test, V_test, S0_test)\n        \n        # Handle potential division by zero in sigma\n        # For Case A, B_sim-B_meas is 0, so chi-sq is 0 even if sigma is 0\n        safe_sigma = np.where(sigma == 0, 1, sigma)\n        \n        chi_sq_nu = (1 / n_chords) * np.sum(((B_sim - B_meas) / safe_sigma)**2)\n        chi_sq_results.append(chi_sq_nu)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, chi_sq_results))}]\")\n\nsolve_workflow()\n```"
        }
    ]
}