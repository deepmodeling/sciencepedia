{
    "hands_on_practices": [
        {
            "introduction": "开发可靠的模拟代码的第一步是验证其离散算子是否具有预期的精度阶数。“人造解方法”（Method of Manufactured Solutions, MMS）是实现这一目标的强大技术。本练习将指导您将MMS应用于理想磁流体动力学（MHD）的约束输运（Constrained Transport, CT）格式，以验证其空间二阶精度，这是保证数值解收敛性的基础。",
            "id": "4048122",
            "problem": "考虑在具有笛卡尔坐标的二维周期性单位正方形域上，源自麦克斯韦-法拉第定律和理想欧姆定律的磁流体力学 (MHD) 的理想感应方程。控制定律和定义如下：\n- 麦克斯韦-法拉第定律：$$\\frac{\\partial \\mathbf{B}}{\\partial t} = - \\nabla \\times \\mathbf{E}.$$\n- 理想欧姆定律：$$\\mathbf{E} = - \\mathbf{v} \\times \\mathbf{B}.$$\n- 对于不可压缩的均匀速度场 $$\\mathbf{v} = (V_x, V_y)$$（满足 $$\\nabla \\cdot \\mathbf{v} = 0$$）和无散磁场 $$\\nabla \\cdot \\mathbf{B} = 0,$$ 感应方程简化为磁场的纯平流：\n$$\\frac{\\partial \\mathbf{B}}{\\partial t} = - (\\mathbf{v} \\cdot \\nabla)\\mathbf{B}.$$\n\n我们采用二维的约束输运 (CT) 交错网格格式，特化为 Yee 型布局以保持离散无散演化：\n- 域为 $$[0,1] \\times [0,1]$$，具有周期性边界条件。\n- 均匀网格有 $$N \\times N$$ 个单元，网格间距为 $$\\Delta x = \\Delta y = 1/N$$。\n- 面心磁场分量 $$B_x$$ 和 $$B_y$$ 存储在：\n  - $$B_x$$ 位于 $$x_{i+\\frac{1}{2}} = (i+\\frac{1}{2}) \\Delta x, \\; y_j = j \\Delta y$$，对于整数 $$i,j$$。\n  - $$B_y$$ 位于 $$x_i = i \\Delta x, \\; y_{j+\\frac{1}{2}} = (j+\\frac{1}{2}) \\Delta y$$。\n- 边心面外电动势 (EMF) 分量 $$E_z$$ 位于 $$x_{i+\\frac{1}{2}}, y_{j+\\frac{1}{2}}$$ 处，并根据理想欧姆定律计算得出\n  $$E_z = - (V_x B_y^{\\text{edge}} - V_y B_x^{\\text{edge}}),$$\n  其中 $$B_x^{\\text{edge}}$$ 和 $$B_y^{\\text{edge}}$$ 是到边上的二阶插值：\n  $$B_x^{\\text{edge}}(i+\\tfrac{1}{2},j+\\tfrac{1}{2}) = \\frac{1}{2}\\left( B_x(i+\\tfrac{1}{2},j) + B_x(i+\\tfrac{1}{2},j+1) \\right),$$\n  $$B_y^{\\text{edge}}(i+\\tfrac{1}{2},j+\\tfrac{1}{2}) = \\frac{1}{2}\\left( B_y(i,j+\\tfrac{1}{2}) + B_y(i+1,j+\\tfrac{1}{2}) \\right).$$\n- 一个显式时间步 $$\\Delta t$$ 的 CT 更新为\n  $$B_x^{n+1}\\big(i+\\tfrac{1}{2}, j\\big) = B_x^{n}\\big(i+\\tfrac{1}{2}, j\\big) - \\frac{\\Delta t}{\\Delta y} \\left[ E_z\\big(i+\\tfrac{1}{2}, j+\\tfrac{1}{2}\\big) - E_z\\big(i+\\tfrac{1}{2}, j-\\tfrac{1}{2}\\big) \\right],$$\n  $$B_y^{n+1}\\big(i, j+\\tfrac{1}{2}\\big) = B_y^{n}\\big(i, j+\\tfrac{1}{2}\\big) + \\frac{\\Delta t}{\\Delta x} \\left[ E_z\\big(i+\\tfrac{1}{2}, j+\\tfrac{1}{2}\\big) - E_z\\big(i-\\tfrac{1}{2}, j+\\tfrac{1}{2}\\big) \\right].$$\n\n为了构建一个人造解，通过矢量势 $$A_z(x,y) = \\sin(2\\pi x)\\sin(2\\pi y)$$ 定义在时间 $$t=0$$ 时的解析、无散磁场：\n$$B_x(x,y,0) = \\frac{\\partial A_z}{\\partial y} = 2\\pi \\cos(2\\pi y)\\sin(2\\pi x),$$\n$$B_y(x,y,0) = -\\frac{\\partial A_z}{\\partial x} = -2\\pi \\cos(2\\pi x)\\sin(2\\pi y).$$\n在 $$\\mathbf{v}=(V_x,V_y)$$ 的匀速平流作用下，时间 $$t$$ 时的精确解是平流场：\n$$B_x(x,y,t) = 2\\pi \\cos\\big(2\\pi (y - V_y t)\\big) \\sin\\big(2\\pi (x - V_x t)\\big),$$\n$$B_y(x,y,t) = -2\\pi \\cos\\big(2\\pi (x - V_x t)\\big) \\sin\\big(2\\pi (y - V_y t)\\big),$$\n该解对于所有 $$t$$ 都保持无散。\n\n三角函数中的角度参数以弧度为单位。所有量都是无量纲的。单元中心的离散散度定义为\n$$\\left(\\nabla \\cdot \\mathbf{B}\\right)_{i,j} = \\frac{ B_x(i+\\tfrac{1}{2},j) - B_x(i-\\tfrac{1}{2},j) }{\\Delta x} + \\frac{ B_y(i,j+\\tfrac{1}{2}) - B_y(i,j-\\tfrac{1}{2}) }{\\Delta y}.$$\n\n您的任务：\n1. 实现上述 CT 离散化，以执行从 $$t=0$$ 到 $$t=\\Delta t$$ 的一个时间步。\n2. 使用人造解析解计算在 $$t=\\Delta t$$ 时的精确磁场，用于误差评估。\n3. 通过网格加密计算误差范数和经验空间精度阶，选择 $$\\Delta t = c\\, \\Delta x^2$$（其中 $$c$$ 为常数），以便对于这单个显式步骤，时间误差不会主导空间行为。\n\n定义以下参数值测试套件以探究该方法：\n- 测试 1 (精度阶，一般情况): $$N_1 = 16, \\; N_2 = 32, \\; V_x = 0.3, \\; V_y = -0.2, \\; c = 0.02.$$\n  输出为 $$B_x$$ 和 $$B_y$$ 计算的两个经验精度阶\n  $$p_{B_x} = \\frac{\\log\\left(\\frac{\\|e_{B_x}(N_1)\\|_2}{\\|e_{B_x}(N_2)\\|_2}\\right)}{\\log 2}, \\quad\n    p_{B_y} = \\frac{\\log\\left(\\frac{\\|e_{B_y}(N_1)\\|_2}{\\|e_{B_y}(N_2)\\|_2}\\right)}{\\log 2},$$\n  其中 $$\\|e\\|_2$$ 是一个步骤后的均方根误差范数。\n- 测试 2 (散度保持): $$N = 32, \\; V_x = 0.3, \\; V_y = -0.2, \\; c = 0.02.$$\n  输出 CT 更新后离散散度的最大绝对值。\n- 测试 3 (零速度边界情况): $$N = 16, \\; V_x = 0.0, \\; V_y = 0.0, \\; c = 0.02.$$\n  输出组合均方根误差\n  $$\\sqrt{\\frac{1}{M} \\sum_{i,j} \\left( e_{B_x}(i,j)^2 + e_{B_y}(i,j)^2 \\right)},$$\n  其中 $$M$$ 是两个分量上所有面自由度的总数。\n- 测试 4 (精度阶，各向异性平流): $$N_1 = 24, \\; N_2 = 48, \\; V_x = 1.0, \\; V_y = 0.0, \\; c = 0.02.$$\n  如测试 1 中那样，输出两个经验精度阶 $$p_{B_x}, p_{B_y}$$。\n\n您的程序应生成单行输出，包含一个由方括号括起来的逗号分隔列表，按以下顺序排列结果：\n$$[p_{B_x}^{(1)}, p_{B_y}^{(1)}, \\max|\\nabla \\cdot \\mathbf{B}|^{(2)}, \\text{RMS}^{(3)}, p_{B_x}^{(4)}, p_{B_y}^{(4)}],$$\n其中上标表示对应的测试。所有输出均为无量纲浮点数。",
            "solution": "该问题是有效的，因为它代表了计算物理学中一个标准且适定的数值验证任务。它在科学上是合理的、自洽的且客观的。为约束输运 (CT) 方法、人造解方法 (MMS) 以及误差分析提供的方程和定义在该领域是正确和标准的。\n\n解决方案涉及实现指定的二维交错网格约束输运格式，以将磁场推进单个时间步。CT 方法的核心原理是在离散层面上保持无散条件 $\\nabla \\cdot \\mathbf{B} = 0$。这是通过变量和差分算子的特定几何排列实现的。\n\n首先，我们建立交错网格，一个 Yee 型晶格，其中磁场的法向分量 $B_x$ 和 $B_y$ 位于单元面的中心。电场的面外分量 $E_z$ 位于单元的角点（或节点）。这种布局至关重要。\n\n时间更新由法拉第定律的离散形式 $\\partial \\mathbf{B} / \\partial t = -\\nabla \\times \\mathbf{E}$ 控制。对于 $B_x$ 分量，这涉及 $E_z$ 在 $y$ 方向的有限差分；对于 $B_y$ 分量，则涉及 $E_z$ 在 $x$ 方向的有限差分。差分模板的构造方式使其形成一个离散旋度算子。该格式的关键特性是，当离散散度算子应用于更新方程时，会得到一个恒等于零的表达式，这反映了矢量恒等式 $\\nabla \\cdot (\\nabla \\times \\mathbf{E}) = 0$。因此，如果初始离散磁场具有某个离散散度值，该值将在整个时间演化过程中保持到机器精度。\n\n电场 $E_z$ 是从理想欧姆定律 $\\mathbf{E} = -\\mathbf{v} \\times \\mathbf{B}$ 计算的。由于 $E_z$ 需要在单元角点处，而 $B_x$ 和 $B_y$ 位于单元面上，我们必须将 $B_x$ 和 $B_y$ 插值到角点位置。指定的对两个最近的面心值进行二阶精度平均是这种插值的标准方法。\n\n为了验证实现方案的正确性和准确性，我们使用人造解方法。一个解析的、随时间变化的控制平流方程的解被“制造”出来。我们在 $t=0$ 时通过在交错网格上采样这个精确解来初始化数值模拟。然后，我们执行单个数值时间步以获得在 $t=\\Delta t$ 时的解。误差是这个数值解与在相同网格点上计算的 $t=\\Delta t$ 时的精确解析解之间的差异。\n\n通过在不同分辨率（$N_1$ 和 $N_2$）的网格上执行此过程，我们可以计算经验精度阶 $p$。对于一个二阶精度的空间格式，随着网格的加密，误差应减小一个因子 $(N_2/N_1)^p \\approx (N_2/N_1)^2$。选择 $\\Delta t = c \\Delta x^2$ 确保了一阶时间误差与二阶空间误差的尺度相同，使得该特定测试的整体格式为二阶。\n\n实现将进行模块化。一个主函数将为一组给定的参数 $(N, V_x, V_y, c)$ 执行一个模拟步骤，处理网格生成、初始化、CT 更新以及精确解和结果误差的计算。然后，主脚本将为每个测试用例调用此函数，计算所需的度量（精度阶、最大散度和均方根误差），并按规定格式化输出。使用 NumPy 的矢量化操作，特别是用于坐标生成的 `np.meshgrid` 和用于实现周期性有限差分和平均的 `np.roll`，对于高效简洁的实现至关重要。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_simulation(N, Vx, Vy, c):\n    \"\"\"\n    Performs one time step of the 2D Constrained Transport (CT) advection problem.\n\n    Args:\n        N (int): Number of grid cells in each dimension.\n        Vx (float): Advection velocity in the x-direction.\n        Vy (float): Advection velocity in the y-direction.\n        c (float): Constant for determining the time step (dt = c * dx^2).\n\n    Returns:\n        dict: A dictionary containing the results of the simulation, including\n              error arrays and the final divergence field.\n    \"\"\"\n    # Grid and time step parameters\n    dx = 1.0 / N\n    dy = 1.0 / N\n    dt = c * dx**2\n\n    # Create coordinate grids for staggered field components\n    # Bx is located at face centers (i+1/2, j)\n    # By is located at face centers (i, j+1/2)\n    _i = np.arange(N)\n    _j = np.arange(N)\n    ix_grid, jx_grid = np.meshgrid(_i, _j, indexing='ij')\n    \n    # Coordinates for Bx components\n    x_bx_coords = (ix_grid + 0.5) * dx\n    y_bx_coords = jx_grid * dy\n    \n    # Coordinates for By components\n    x_by_coords = ix_grid* dx\n    y_by_coords = (jx_grid + 0.5) * dy\n\n    # Initial analytic magnetic field at t=0\n    # Bx(x,y,0) = 2*pi*cos(2*pi*y)*sin(2*pi*x)\n    # By(x,y,0) = -2*pi*cos(2*pi*x)*sin(2*pi*y)\n    Bx0 = (2.0 * np.pi * np.cos(2.0 * np.pi * y_bx_coords) * \n           np.sin(2.0 * np.pi * x_bx_coords))\n    By0 = (-2.0 * np.pi * np.cos(2.0 * np.pi * x_by_coords) * \n           np.sin(2.0 * np.pi * y_by_coords))\n\n    # --- Constrained Transport (CT) Step ---\n    \n    # 1. Interpolate B fields to cell corners (i+1/2, j+1/2) to compute Ez\n    # Bx_edge(i+1/2,j+1/2) = 0.5 * (Bx(i+1/2, j) + Bx(i+1/2, j+1))\n    Bx_edge = 0.5 * (Bx0 + np.roll(Bx0, -1, axis=1))\n    # By_edge(i+1/2,j+1/2) = 0.5 * (By(i, j+1/2) + By(i+1, j+1/2))\n    By_edge = 0.5 * (By0 + np.roll(By0, -1, axis=0))\n\n    # 2. Compute out-of-plane electromotive force (EMF) Ez from Ideal Ohm's Law\n    # Ez = -(Vx * By_edge - Vy * Bx_edge)\n    Ez = -(Vx * By_edge - Vy * Bx_edge)\n\n    # 3. Update B fields using discrete Faraday's Law (CT update)\n    # dBx/dt = -dEz/dy  ->  Bx_n+1 = Bx_n - dt/dy * (Ez(j+1/2) - Ez(j-1/2))\n    # The term Ez(j+1/2) - Ez(j-1/2) corresponds to Ez - np.roll(Ez, 1, axis=1)\n    Bx1 = Bx0 - (dt / dy) * (Ez - np.roll(Ez, 1, axis=1))\n    \n    # dBy/dt = +dEz/dx  ->  By_n+1 = By_n + dt/dx * (Ez(i+1/2) - Ez(i-1/2))\n    # The term Ez(i+1/2) - Ez(i-1/2) corresponds to Ez - np.roll(Ez, 1, axis=0)\n    By1 = By0 + (dt / dx) * (Ez - np.roll(Ez, 1, axis=0))\n\n    # --- Error Analysis ---\n\n    # Exact analytic solution at t=dt\n    t = dt\n    Bx_exact = (2.0 * np.pi * np.cos(2.0 * np.pi * (y_bx_coords - Vy * t)) *\n                np.sin(2.0 * np.pi * (x_bx_coords - Vx * t)))\n    By_exact = (-2.0 * np.pi * np.cos(2.0 * np.pi * (x_by_coords - Vx * t)) *\n                np.sin(2.0 * np.pi * (y_by_coords - Vy * t)))\n\n    # Compute error fields\n    err_Bx = Bx1 - Bx_exact\n    err_By = By1 - By_exact\n\n    # Compute discrete divergence of the updated field at cell centers (i,j)\n    # divB = (Bx(i+1/2,j) - Bx(i-1/2,j))/dx + (By(i,j+1/2) - By(i,j-1/2))/dy\n    div_term_x = (Bx1 - np.roll(Bx1, 1, axis=0)) / dx\n    div_term_y = (By1 - np.roll(By1, 1, axis=1)) / dy\n    divB = div_term_x + div_term_y\n    \n    return {\n        \"rms_err_Bx\": np.sqrt(np.mean(err_Bx**2)),\n        \"rms_err_By\": np.sqrt(np.mean(err_By**2)),\n        \"err_Bx_arr\": err_Bx,\n        \"err_By_arr\": err_By,\n        \"divB_arr\": divB,\n    }\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final results.\n    \"\"\"\n    results = []\n\n    # Test 1: Order of accuracy, general case\n    N1_1, N2_1 = 16, 32\n    Vx1, Vy1, c1 = 0.3, -0.2, 0.02\n    res1_N1 = run_simulation(N1_1, Vx1, Vy1, c1)\n    res1_N2 = run_simulation(N2_1, Vx1, Vy1, c1)\n    \n    p_Bx_1 = np.log(res1_N1[\"rms_err_Bx\"] / res1_N2[\"rms_err_Bx\"]) / np.log(2)\n    p_By_1 = np.log(res1_N1[\"rms_err_By\"] / res1_N2[\"rms_err_By\"]) / np.log(2)\n    results.extend([p_Bx_1, p_By_1])\n    \n    # Test 2: Divergence preservation\n    # Reuses the N=32 result from Test 1\n    max_div_B_2 = np.max(np.abs(res1_N2[\"divB_arr\"]))\n    results.append(max_div_B_2)\n    \n    # Test 3: Zero velocity edge case\n    N3, Vx3, Vy3, c3 = 16, 0.0, 0.0, 0.02\n    res3 = run_simulation(N3, Vx3, Vy3, c3)\n    \n    err_Bx_3 = res3[\"err_Bx_arr\"]\n    err_By_3 = res3[\"err_By_arr\"]\n    M3 = 2 * N3**2\n    total_err_sq_3 = np.sum(err_Bx_3**2) + np.sum(err_By_3**2)\n    rms_3 = np.sqrt(total_err_sq_3 / M3)\n    results.append(rms_3)\n    \n    # Test 4: Order of accuracy, anisotropic advection\n    N1_4, N2_4 = 24, 48\n    Vx4, Vy4, c4 = 1.0, 0.0, 0.02\n    res4_N1 = run_simulation(N1_4, Vx4, Vy4, c4)\n    res4_N2 = run_simulation(N2_4, Vx4, Vy4, c4)\n\n    p_Bx_4 = np.log(res4_N1[\"rms_err_Bx\"] / res4_N2[\"rms_err_Bx\"]) / np.log(2)\n    p_By_4 = np.log(res4_N1[\"rms_err_By\"] / res4_N2[\"rms_err_By\"]) / np.log(2)\n    results.extend([p_Bx_4, p_By_4])\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "一个优秀的数值格式不仅要精确，还必须遵守其所模拟的物理定律，例如能量守恒。本练习将深入探讨一个精妙但至关重要的话题：如何在线性FDTD（时域有限差分）格式中确保离散能量守恒。通过推导，您将发现不恰当的插值方法如何导致非物理的能量增长，并学会如何构建一个能够精确保持能量守恒的一致性坡印廷（Poynting）通量。",
            "id": "4048168",
            "problem": "考虑在一维空间中的电磁波传播，其电场分量 $E_{y}(x,t)$ 和磁场分量 $H_{z}(x,t)$ 在介电常数为 $\\varepsilon$、磁导率为 $\\mu$ 的均匀无源介质中满足麦克斯韦方程组。连续能量密度为 $u = \\frac{\\varepsilon}{2} |E_{y}|^{2} + \\frac{\\mu}{2} |H_{z}|^{2}$，坡印亭矢量为 $\\mathbf{S} = \\mathbf{E} \\times \\mathbf{H}$，其 $x$ 分量为 $S_{x} = E_{y} H_{z}$。对于周期性域，连续能量平衡表明，总能量的时间变化率等于穿过区域边界的 $S_{x}$ 净通量的负值，而该净通量为零。\n\n现在，将长度为 $L$ 的空间域用 $N$ 个间距为 $\\Delta x = L/N$ 的均匀单元进行离散化，并采用周期性边界条件。使用经典的交错Yee网格：将 $E_{y}$ 存储在由 $i \\in \\{0,1,\\dots,N-1\\}$ 索引的单元中心处，时间为整数时间步 $t^{n} = n \\Delta t$；将 $H_{z}$ 存储在由 $i+\\frac{1}{2}$ 索引的单元面处，时间为半整数时间步 $t^{n+\\frac{1}{2}} = \\left(n+\\frac{1}{2}\\right) \\Delta t$。假设采用标准的蛙跳时域有限差分(FDTD)格式（Yee更新），该格式与麦克斯韦方程组及上述交错方式一致。\n\n任务：\n\n1. 使用上述交错场点位置和单元体积 $\\Delta x$，定义在时间 $t^{n}$ 的离散总电磁能量 $W^{n}$。然后，从Yee格式和麦克斯韦方程组所蕴含的离散更新方程出发，通过将每个更新方程乘以相应场的适当的时空平均值并在网格上求和，推导出一个关于 $W^{n+1}-W^{n}$ 的全离散能量平衡。将得到的离散能量变化表示为一个面心、时间中心的坡印亭通量 $S_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2})$ 的离散散度。\n\n2. 证明如果换一种方式，通过先将 $H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2})$ 通过算术平均插值到单元中心，然后与时间中心的 $E_{y}$ 相乘来计算一个单元中心、时间中心的坡印亭矢量 $\\tilde{S}_{x}^{n+\\frac{1}{2}}(i)$，即\n$$\n\\tilde{S}_{x}^{n+\\frac{1}{2}}(i) = \\left( \\frac{E_{y}^{n+1}(i) + E_{y}^{n}(i)}{2} \\right) \\left( \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) + H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{2} \\right),\n$$\n离散能量变化 $W^{n+1}-W^{n}$ 将包含一个无法抵消的残余“混叠”项，并且对于某些离散模式，该项可以为正。推导这个一维残余项的闭式表达式，并简要解释为什么它可能是非物理的（即，在无源周期性域中导致 $W^{n+1} > W^{n}$）。\n\n3. 为面心、时间中心的坡印亭通量\n$$\nS_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) = E_{y}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\, H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}),\n$$\n提出一个一致的平均格式，该格式将 $E_{y}$ 在时间 $t^{n+\\frac{1}{2}}$ 时空平均到面 $i+\\frac{1}{2}$ 上，同时保持 $H_{z}$ 在其原生的交错时空位置。你的格式必须是显式的、二阶精度的，并且仅由Yee交错格式所蕴含的最近邻值构造。证明使用此格式，离散能量平衡可简化为穿过各个面的通量的纯粹伸缩求和，因此在无源周期性域中能精确地实现能量守恒。\n\n最后，在你于任务3中提出的一致的面心和时间中心平均格式以及指定的周期性边界条件下，计算离散能量增长率\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t}\n$$\n并用焦耳/秒作单位表示你的答案。你不需要对答案进行四舍五入。",
            "solution": "我们从均匀无源介质中的麦克斯韦方程组开始：\n$$\n\\frac{\\partial \\mathbf{D}}{\\partial t} = \\nabla \\times \\mathbf{H}, \\quad \\frac{\\partial \\mathbf{B}}{\\partial t} = - \\nabla \\times \\mathbf{E}, \\quad \\mathbf{D} = \\varepsilon \\mathbf{E}, \\quad \\mathbf{B} = \\mu \\mathbf{H}.\n$$\n在一维空间中，对于横向场 $E_{y}(x,t)$ 和 $H_{z}(x,t)$，这些方程简化为\n$$\n\\varepsilon \\frac{\\partial E_{y}}{\\partial t} = \\frac{\\partial H_{z}}{\\partial x}, \\quad \\mu \\frac{\\partial H_{z}}{\\partial t} = \\frac{\\partial E_{y}}{\\partial x}.\n$$\n连续能量密度为 $u = \\frac{\\varepsilon}{2} |E_{y}|^{2} + \\frac{\\mu}{2} |H_{z}|^{2}$，$x$ 方向的坡印亭通量为 $S_{x} = E_{y} H_{z}$。连续能量平衡为\n$$\n\\frac{d}{dt} \\int_{0}^{L} \\left( \\frac{\\varepsilon}{2} |E_{y}|^{2} + \\frac{\\mu}{2} |H_{z}|^{2} \\right) \\, dx = - \\left[ E_{y} H_{z} \\right]_{x=0}^{x=L}.\n$$\n对于周期性边界条件，右侧项为零，总能量守恒。\n\n我们现在使用Yee网格和蛙跳时域有限差分(FDTD)方法进行离散化。令 $E_{y}^{n}(i)$ 表示在单元中心 $x_{i} = i \\Delta x$ 和时间 $t^{n} = n \\Delta t$ 处的 $E_{y}$，令 $H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2})$ 表示在面 $x_{i+\\frac{1}{2}} = \\left(i+\\frac{1}{2}\\right)\\Delta x$ 和时间 $t^{n+\\frac{1}{2}} = \\left(n+\\frac{1}{2}\\right)\\Delta t$ 处的 $H_{z}$。一维横电磁波模式的标准Yee更新方程为\n$$\n\\varepsilon \\frac{E_{y}^{n+1}(i) - E_{y}^{n}(i)}{\\Delta t} = \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{\\Delta x},\n$$\n$$\n\\mu \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2})}{\\Delta t} = \\frac{E_{y}^{n}(i+1) - E_{y}^{n}(i)}{\\Delta x}.\n$$\n\n任务1：定义离散总能量 $W^{n}$ 并推导离散能量平衡。我们定义\n$$\nW^{n} = \\sum_{i=0}^{N-1} \\left[ \\frac{\\varepsilon}{2} \\left| E_{y}^{n}(i) \\right|^{2} + \\frac{\\mu}{2} \\left| H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2}) \\right|^{2} \\right] \\Delta x,\n$$\n这是在时间 $t^{n}$ 与蛙跳交错格式一致的自然能量定义。为了推导 $W^{n+1} - W^{n}$，将离散的安培更新方程乘以同一单元中心处的时间中心电场，\n$$\nE_{y}^{n+\\frac{1}{2}}(i) \\equiv \\frac{E_{y}^{n+1}(i) + E_{y}^{n}(i)}{2},\n$$\n并将离散的法拉第更新方程乘以同一面处的时间中心磁场，\n$$\nH_{z}^{n}(i+\\frac{1}{2}) \\equiv \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) + H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2})}{2}.\n$$\n我们得到\n$$\n\\varepsilon \\frac{E_{y}^{n+1}(i) - E_{y}^{n}(i)}{\\Delta t} \\, E_{y}^{n+\\frac{1}{2}}(i) = \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{\\Delta x} \\, E_{y}^{n+\\frac{1}{2}}(i),\n$$\n$$\n\\mu \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2})}{\\Delta t} \\, H_{z}^{n}(i+\\frac{1}{2}) = \\frac{E_{y}^{n}(i+1) - E_{y}^{n}(i)}{\\Delta x} \\, H_{z}^{n}(i+\\frac{1}{2}).\n$$\n对 $i$ 求和并乘以 $\\Delta x$，左侧项变为能量分量的离散时间差：\n$$\n\\sum_{i} \\varepsilon \\frac{E_{y}^{n+1}(i) - E_{y}^{n}(i)}{\\Delta t} \\, E_{y}^{n+\\frac{1}{2}}(i) \\, \\Delta x = \\frac{1}{\\Delta t} \\sum_{i} \\frac{\\varepsilon}{2} \\left( \\left| E_{y}^{n+1}(i) \\right|^{2} - \\left| E_{y}^{n}(i) \\right|^{2} \\right) \\Delta x,\n$$\n$$\n\\sum_{i} \\mu \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2})}{\\Delta t} \\, H_{z}^{n}(i+\\frac{1}{2}) \\, \\Delta x = \\frac{1}{\\Delta t} \\sum_{i} \\frac{\\mu}{2} \\left( \\left| H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\right|^{2} - \\left| H_{z}^{n-\\frac{1}{2}}(i+\\frac{1}{2}) \\right|^{2} \\right) \\Delta x.\n$$\n因此\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} = \\sum_{i} \\left[ \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{\\Delta x} \\, E_{y}^{n+\\frac{1}{2}}(i) + \\frac{E_{y}^{n}(i+1) - E_{y}^{n}(i)}{\\Delta x} \\, H_{z}^{n}(i+\\frac{1}{2}) \\right] \\Delta x.\n$$\n我们现在通过使用离散分部求和恒等式，将右侧项转换为一个面心、时间中心的坡印亭通量的离散散度。首先，将对单元的求和重写为对面的求和，以揭示伸缩结构。对于第一项，\n$$\n\\sum_{i} \\left[ H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2}) \\right] E_{y}^{n+\\frac{1}{2}}(i) = \\sum_{i} H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\left[ E_{y}^{n+\\frac{1}{2}}(i) - E_{y}^{n+\\frac{1}{2}}(i+1) \\right],\n$$\n在第二个和式上使用索引平移。对于第二项，\n$$\n\\sum_{i} \\left[ E_{y}^{n}(i+1) - E_{y}^{n}(i) \\right] H_{z}^{n}(i+\\frac{1}{2}) = - \\sum_{i} H_{z}^{n}(i+\\frac{1}{2}) \\left[ E_{y}^{n}(i+1) - E_{y}^{n}(i) \\right],\n$$\n它已经是面心形式。合并并除以 $\\Delta x$，我们得到\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} = - \\sum_{i} \\frac{1}{\\Delta x} \\left[ E_{y}^{n+\\frac{1}{2}}(i+1) - E_{y}^{n+\\frac{1}{2}}(i) \\right] H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\, \\Delta x,\n$$\n前提是我们通过将 $H_{z}^{n}(i+\\frac{1}{2})$ 替换为 $H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2})$ 外加一个 $\\mathcal{O}(\\Delta t^{2})$ 阶的截断误差，来一致地将第二项时间中心化到 $t^{n+\\frac{1}{2}}$，这对于二阶精度是合适的。剩下的一个微妙之处是在面位置上 $E_{y}^{n+\\frac{1}{2}}$ 的取值。为确保与Yee旋度位置一致的时间和空间中心化，定义\n$$\nE_{y}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\equiv \\frac{1}{2} \\left( \\frac{E_{y}^{n+1}(i+1) + E_{y}^{n+1}(i)}{2} + \\frac{E_{y}^{n}(i+1) + E_{y}^{n}(i)}{2} \\right),\n$$\n这是在时间 $t^{n}$ 和 $t^{n+1}$ 时，面上最近邻 $E_{y}$ 的算术平均值。那么离散梯度满足\n$$\nE_{y}^{n+\\frac{1}{2}}(i+1) - E_{y}^{n+\\frac{1}{2}}(i) = \\frac{E_{y}^{n+1}(i+1) - E_{y}^{n+1}(i)}{2} + \\frac{E_{y}^{n}(i+1) - E_{y}^{n}(i)}{2},\n$$\n离散能量平衡变为\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} = - \\sum_{i} \\frac{S_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - S_{x}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{\\Delta x} \\, \\Delta x,\n$$\n其中一致的面心、时间中心坡印亭通量为\n$$\nS_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\equiv E_{y}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\, H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}).\n$$\n这是坡印亭定理的离散模拟。右侧的和式伸缩为边界贡献项，在周期性域中这些项为零，从而在全离散层面上确立了能量守恒。\n\n任务2：证明不正确的插值会产生一个非物理的残余项。考虑朴素的单元中心、时间中心的坡印亭矢量\n$$\n\\tilde{S}_{x}^{n+\\frac{1}{2}}(i) = E_{y}^{n+\\frac{1}{2}}(i) \\, \\tilde{H}_{z}^{n+\\frac{1}{2}}(i),\n$$\n其中\n$$\nE_{y}^{n+\\frac{1}{2}}(i) \\equiv \\frac{E_{y}^{n+1}(i) + E_{y}^{n}(i)}{2}, \\quad \\tilde{H}_{z}^{n+\\frac{1}{2}}(i) \\equiv \\frac{H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) + H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{2}.\n$$\n如果试图写出\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} \\stackrel{?}{=} - \\sum_{i} \\frac{\\tilde{S}_{x}^{n+\\frac{1}{2}}(i+1) - \\tilde{S}_{x}^{n+\\frac{1}{2}}(i)}{\\Delta x} \\, \\Delta x,\n$$\n并使用离散更新方程将右侧项处理成单元中心表达式，就会出现不匹配，因为 $\\tilde{H}_{z}^{n+\\frac{1}{2}}(i)$ 不在旋度自然定义的面位置上，这破坏了离散分部求和的配对。污染能量平衡的精确残余混叠项是\n$$\n\\mathcal{R}^{n+\\frac{1}{2}} \\equiv \\sum_{i=0}^{N-1} \\frac{1}{4} \\left[ E_{y}^{n+1}(i) - E_{y}^{n}(i) \\right] \\left[ H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2}) \\right].\n$$\n该项产生于展开 $\\tilde{S}_{x}^{n+\\frac{1}{2}}(i)$ 和试图平移求和时产生的交叉乘积。它不能简化为一个纯粹的伸缩面通量，并且对于某些离散傅里叶模式，它可以是正的。例如，取\n$$\nE_{y}^{n+1}(i) - E_{y}^{n}(i) = \\alpha \\cos(k x_{i}), \\quad H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - H_{z}^{n+\\frac{1}{2}}(i-\\frac{1}{2}) = \\beta \\cos(k x_{i}),\n$$\n其中 $k \\Delta x$ 很小且 $\\alpha, \\beta$ 同相；那么 $\\mathcal{R}^{n+\\frac{1}{2}}$ 正比于 $\\sum_{i} \\cos^{2}(k x_{i})$，这是严格为正的。在无源周期性域中，这种正值对应于仅由不一致的插值引起的虚假能量增长 $W^{n+1} > W^{n}$，这是非物理的。\n\n任务3：提出一个一致的平均格式并证明其守恒性。该格式为：\n- 保持 $H_{z}$ 在其原生的面心、时间中心位置 $H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2})$。\n- 将面上的时空平均电场定义为\n$$\nE_{y}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) = \\frac{1}{4} \\left( E_{y}^{n+1}(i+1) + E_{y}^{n+1}(i) + E_{y}^{n}(i+1) + E_{y}^{n}(i) \\right).\n$$\n- 构造面心、时间中心的坡印亭通量\n$$\nS_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) = E_{y}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) \\, H_{z}^{n+\\frac{1}{2}}(i+\\frac{1}{2}).\n$$\n通过这种构造，离散能量平衡变为\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} = - \\sum_{i=0}^{N-1} \\frac{S_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - S_{x}^{n+\\frac{1}{2}}(i-\\frac{1}{2})}{\\Delta x} \\, \\Delta x,\n$$\n这是一个对面上的伸缩求和。对于周期性边界，差分的和精确地为零：\n$$\n\\sum_{i=0}^{N-1} \\left[ S_{x}^{n+\\frac{1}{2}}(i+\\frac{1}{2}) - S_{x}^{n+\\frac{1}{2}}(i-\\frac{1}{2}) \\right] = 0,\n$$\n因此，在无源周期性域中，\n$$\n\\frac{W^{n+1} - W^{n}}{\\Delta t} = 0.\n$$\n\n最终计算：在一致的面心和时间中心平均格式下，对于周期性边界和无源情况，离散能量增长率精确为零。以焦耳/秒表示，该速率为零。无需四舍五入。",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "在将电磁场与电流、电荷等源项（例如在MHD或PIC模拟中）耦合时，维持高斯定律至关重要，这通常要求离散的电荷连续性方程得到满足。本项高级练习将介绍一个常见问题——非一致性的电流分配，并指导您实现一种强大的校正技术。该技术通过求解一个泊松方程来强制执行电荷守恒，从而保证电场散度约束的正确性。",
            "id": "4048223",
            "problem": "考虑一个用于计算聚变科学与工程中时域有限差分电磁计算的二维、均匀、周期性 Yee 型交错网格。在此类网格中，电荷密度存储在单元中心，电流密度分量存储在单元面上：电流密度的 $x$ 分量 $J_x$ 存储在垂直于 $x$ 方向的面上（右侧面），而 $y$ 分量 $J_y$ 存储在垂直于 $y$ 方向的面上（顶面）。磁流体力学（MHD）系统将等离子体流体与电磁场耦合起来，在电荷守恒格式中，必须满足离散连续性方程以保持高斯定律。在一个时间步长内，离散连续性方程要求电荷更新和沉积在面上的电流满足以下以单元为中心的关系式\n$$\n\\frac{\\rho^{n+1}_{i,j}-\\rho^{n}_{i,j}}{\\Delta t} + \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j} = 0,\n$$\n其中 $\\rho$ 是电荷密度，$\\Delta t$ 是时间步长，$\\nabla_h\\cdot \\mathbf{J}$ 是由面中心的 $J_x$ 和 $J_y$ 构建的离散散度。在实际的粒子模拟（particle-in-cell）风格的沉积或磁流体力学闭合中，不一致的电流沉积会违反此方程，并引入离散高斯定律误差。\n\n你需要推导、实现并测试一种修正算法，该算法通过将电流局部地重新分布到相邻面来恢复离散连续性，并量化修正前后的相关高斯定律误差。在归一化单位下工作，其中真空介电常数 $\\epsilon_0 = 1$，网格间距 $\\Delta x = 1$ 和 $\\Delta y = 1$，并将所有输出表示为无物理单位符号的无量纲浮点数或布尔值。\n\n从麦克斯韦方程组和连续介质连续性方程出发，推导一个离散关系，将每个单元的高斯定律误差增量与一个时间步长内离散连续性方程的残差联系起来。设计一个基于投影的电流修正方法，该方法计算一个单元中心的标量势，并从沉积的电流中减去其面中心的离散梯度，以强制满足离散连续性约束。使用周期性边界条件和基于傅里叶的方法求解离散泊松方程。显式定义与交错布局一致的离散算子：对于索引为 $(i,j)$ 的单元，将面中心电流的离散散度定义为\n$$\n\\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j} = \\frac{1}{\\Delta x}\\left(J_x\\big|_{\\text{right face of }(i,j)} - J_x\\big|_{\\text{right face of }(i-1,j)}\\right) + \\frac{1}{\\Delta y}\\left(J_y\\big|_{\\text{top face of }(i,j)} - J_y\\big|_{\\text{top face of }(i,j-1)}\\right),\n$$\n其中索引对网格大小取模以强制周期性。将单元中心标量场 $\\phi_{i,j}$ 的离散面中心梯度定义为\n$$\n\\left(\\nabla_h \\phi\\right)_x\\big|_{\\text{right face of }(i,j)} = \\frac{\\phi_{i+1,j} - \\phi_{i,j}}{\\Delta x}, \\quad\n\\left(\\nabla_h \\phi\\right)_y\\big|_{\\text{top face of }(i,j)} = \\frac{\\phi_{i,j+1} - \\phi_{i,j}}{\\Delta y}.\n$$\n这些定义确保 $\\nabla_h\\cdot \\nabla_h \\phi$ 是作用于单元中心的标准周期性离散拉普拉斯算子。\n\n设每个单元的连续性残差定义为\n$$\nr_{i,j} = \\frac{\\rho^{n+1}_{i,j}-\\rho^{n}_{i,j}}{\\Delta t} + \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j}.\n$$\n你必须\n- 假设 $\\epsilon_0 = 1$ 且初始状态满足离散高斯定律，推导高斯定律误差增量与 $r_{i,j}$ 之间的离散关系，\n- 构建一个修正方案，通过求解离散泊松方程来找到 $\\phi$\n$$\n\\nabla_h\\cdot \\nabla_h \\phi = r,\n$$\n其中周期性 $k=\\left(0,0\\right)$ 模式被设定以使 $\\phi$ 具有零均值，然后通过以下方式定义修正后的电流\n$$\nJ_x^{\\mathrm{corr}}\\big|_{\\text{right face of }(i,j)} = J_x\\big|_{\\text{right face of }(i,j)} - \\left(\\nabla_h \\phi\\right)_x\\big|_{\\text{right face of }(i,j)}, \\quad\nJ_y^{\\mathrm{corr}}\\big|_{\\text{top face of }(i,j)} = J_y\\big|_{\\text{top face of }(i,j)} - \\left(\\nabla_h \\phi\\right)_y\\big|_{\\text{top face of }(i,j)}.\n$$\n这种电流的重新分布是局部的，仅限于相邻的面，因为每个面的修正仅取决于相邻单元中心势的差值。\n\n将每个时间步的高斯定律误差大小定义为一个步长后高斯定律违背值的绝对值在所有单元中的最大值，并使用你推导的离散关系直接从 $r_{i,j}$ 计算此量，而无需显式地推进电场。在 $\\epsilon_0 = 1$ 的归一化单位中，该大小为\n$$\nE_{\\mathrm{Gauss}} = \\Delta t \\cdot \\max_{i,j} \\left| r_{i,j} \\right|.\n$$\n修正后，使用修正后的电流重新计算残差，并重新计算 $E_{\\mathrm{Gauss}}$。\n\n在指定的运行时环境中，将上述内容实现在一个单一的、自包含的程序中，该程序构建以下确定性测试套件。对于每种情况，你必须使用指定的公式构建 $\\rho^n$、$J_x$、$J_y$ 和 $\\rho^{n+1}$。使用具有周期性的索引 $i\\in\\{0,\\ldots,N_x-1\\}$ 和 $j\\in\\{0,\\ldots,N_y-1\\}$，并定义无量纲相位变量 $x_c = \\frac{2\\pi (i+0.5)}{N_x}$ 和 $y_c = \\frac{2\\pi (j+0.5)}{N_y}$ 来引用单元中心，对于面中心电流，在指定公式中重用这些相位。\n\n测试套件：\n- 情况 1（一般非零的零均值残差，理想路径）：\n  - 网格大小 $N_x = 8$, $N_y = 8$，时间步长 $\\Delta t = 0.2$。\n  - 构建 $\\rho^n_{i,j} = 0.5 \\,\\sin(x_c)\\,\\cos(y_c)$。\n  - 构建 $J_x\\big|_{\\text{right face of }(i,j)} = 0.4 \\,\\sin(x_c)\\,\\sin(y_c)$ 和 $J_y\\big|_{\\text{top face of }(i,j)} = -0.3 \\,\\cos(x_c)\\,\\sin(y_c)$。\n  - 定义一个零均值不一致性（微调）$f_{i,j} = 0.01 \\,\\sin(x_c)\\,\\sin(y_c)$ 并设置 $\\rho^{n+1}_{i,j} = \\rho^n_{i,j} - \\Delta t \\cdot \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j} + f_{i,j}$。\n- 情况 2（非零均值残差，全局模式在周期性域上不可修正）：\n  - 网格大小 $N_x = 8$, $N_y = 8$，时间步长 $\\Delta t = 0.2$。\n  - 使用与情况 1 中相同的 $\\rho^n$、$J_x$ 和 $J_y$。\n  - 定义一个常数不一致性 $f_{i,j} = 0.02$ 并设置 $\\rho^{n+1}_{i,j} = \\rho^n_{i,j} - \\Delta t \\cdot \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j} + f_{i,j}$。\n- 情况 3（精确一致的沉积，边界条件检查）：\n  - 网格大小 $N_x = 8$, $N_y = 8$，时间步长 $\\Delta t = 0.2$。\n  - 使用与情况 1 中相同的 $\\rho^n$、$J_x$ 和 $J_y$。\n  - 定义 $f_{i,j} = 0$ 并设置 $\\rho^{n+1}_{i,j} = \\rho^n_{i,j} - \\Delta t \\cdot \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j}$。\n- 情况 4（具有零均值的局部不一致性，边界情况结构）：\n  - 网格大小 $N_x = 6$, $N_y = 6$，时间步长 $\\Delta t = 0.15$。\n  - 构建 $\\rho^n_{i,j} = 0.3 \\,\\sin(x_c)\\,\\cos(y_c)$。\n  - 构建 $J_x\\big|_{\\text{right face of }(i,j)} = 0.25 \\,\\sin(x_c)\\,\\sin(y_c)$ 和 $J_y\\big|_{\\text{top face of }(i,j)} = 0.1 \\,\\cos(x_c)\\,\\sin(y_c)$。\n  - 定义 $f_{i,j}$ 在除 $f_{2,1} = 0.05$ 和 $f_{4,3} = -0.05$ 之外的所有地方均为零，并设置 $\\rho^{n+1}_{i,j} = \\rho^n_{i,j} - \\Delta t \\cdot \\left(\\nabla_h\\cdot \\mathbf{J}\\right)_{i,j} + f_{i,j}$。\n\n对于每种情况，从 $\\rho^n$、$\\rho^{n+1}$、$J_x$ 和 $J_y$ 计算初始连续性残差 $r$；计算初始高斯定律误差大小 $E_{\\mathrm{Gauss}}$；通过在傅里叶空间中求解离散泊松方程（周期性边界条件，将 $k=\\left(0,0\\right)$ 模式置零）来计算修正势；通过减去势的离散面中心梯度来修正电流；重新计算残差和修正后的 $E_{\\mathrm{Gauss}}$。对于每种情况，还要确定一个布尔标志，指示修正后的误差是否小于或等于初始误差。\n\n最终输出格式：你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个元素是一个三元列表 $[$初始误差大小, 修正后误差大小, 减小布尔值$]$，每个测试情况一个，按情况 1、情况 2、情况 3、情况 4 的顺序排列。例如，输出必须类似于 $[[e_{1,\\mathrm{init}},e_{1,\\mathrm{corr}},b_1],[e_{2,\\mathrm{init}},e_{2,\\mathrm{corr}},b_2],[e_{3,\\mathrm{init}},e_{3,\\mathrm{corr}},b_3],[e_{4,\\mathrm{init}},e_{4,\\mathrm{corr}},b_4]]$，只包含浮点数和布尔值。",
            "solution": "该问题要求推导并实现一种电流修正算法，用于在二维、周期性、交错的 Yee 网格上强制执行离散电荷连续性方程。我们将首先推导必要的理论关系，然后概述数值算法，最后提供实现。\n\n### 高斯定律误差演化的推导\n\n麦克斯韦-法拉第方程和安培-麦克斯韦方程，连同电场和磁场的高斯定律，构成一个完整的系统。电荷守恒是该系统的一个内在推论。连续介质连续性方程为\n$$\n\\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot \\mathbf{J} = 0\n$$\n其中 $\\rho$ 是电荷密度，$\\mathbf{J}$ 是电流密度。电场高斯定律指出\n$$\n\\nabla \\cdot \\mathbf{E} = \\frac{\\rho}{\\epsilon_0}\n$$\n对高斯定律取时间导数可得\n$$\n\\frac{\\partial}{\\partial t} \\left( \\nabla \\cdot \\mathbf{E} - \\frac{\\rho}{\\epsilon_0} \\right) = \\nabla \\cdot \\frac{\\partial \\mathbf{E}}{\\partial t} - \\frac{1}{\\epsilon_0}\\frac{\\partial \\rho}{\\partial t} = 0\n$$\n根据安培-麦克斯韦定律，$\\frac{\\partial \\mathbf{E}}{\\partial t} = \\frac{1}{\\epsilon_0} \\left( \\frac{1}{\\mu_0}\\nabla\\times\\mathbf{B} - \\mathbf{J} \\right)$。将此代入前一个方程，并使用矢量恒等式 $\\nabla \\cdot (\\nabla \\times \\mathbf{B}) = 0$，我们发现\n$$\n\\nabla \\cdot \\left( -\\frac{1}{\\epsilon_0} \\mathbf{J} \\right) - \\frac{1}{\\epsilon_0}\\frac{\\partial \\rho}{\\partial t} = 0 \\implies \\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot \\mathbf{J} = 0\n$$\n这表明如果高斯定律成立，则连续性方程得到满足。反之，如果连续性方程被违反，高斯定律将随时间被违反。设 $G = \\nabla \\cdot \\mathbf{E} - \\rho/\\epsilon_0$ 为高斯定律的违背量。其时间演化由以下方程决定\n$$\n\\frac{\\partial G}{\\partial t} = \\frac{1}{\\epsilon_0} \\left( \\frac{\\partial \\rho}{\\partial t} + \\nabla \\cdot \\mathbf{J} \\right)\n$$\n在数值格式中，我们处理的是离散的对应物。设 $G_{i,j}^n = (\\nabla_h \\cdot \\mathbf{E}^n)_{i,j} - \\rho_{i,j}^n/\\epsilon_0$ 为在单元 $(i,j)$ 和时间步 $n$ 处的离散高斯定律违背量。对演化方程进行一阶时间离散化得到\n$$\n\\frac{G_{i,j}^{n+1} - G_{i,j}^{n}}{\\Delta t} = \\frac{1}{\\epsilon_0} \\left( \\frac{\\rho_{i,j}^{n+1} - \\rho_{i,j}^{n}}{\\Delta t} + (\\nabla_h \\cdot \\mathbf{J})_{i,j} \\right)\n$$\n括号中的项是问题中定义的离散连续性方程残差 $r_{i,j}$。\n$$\nr_{i,j} = \\frac{\\rho_{i,j}^{n+1} - \\rho_{i,j}^{n}}{\\Delta t} + (\\nabla_h \\cdot \\mathbf{J})_{i,j}\n$$\n因此，一个时间步长内高斯定律违背量的变化是\n$$\nG_{i,j}^{n+1} - G_{i,j}^{n} = \\frac{\\Delta t}{\\epsilon_0} r_{i,j}\n$$\n问题陈述初始状态满足离散高斯定律，因此 $G_{i,j}^n = 0$。在归一化单位 $\\epsilon_0 = 1$ 下，下一个时间步的违背量是\n$$\nG_{i,j}^{n+1} = \\Delta t \\cdot r_{i,j}\n$$\n高斯定律误差大小 $E_{\\mathrm{Gauss}}$ 被定义为整个网格上绝对违背量的最大值。这直接导出了问题给出的公式：\n$$\nE_{\\mathrm{Gauss}} = \\max_{i,j} |G_{i,j}^{n+1}| = \\Delta t \\cdot \\max_{i,j} |r_{i,j}|\n$$\n此推导验证了我们被要求使用的关系。\n\n### 通过投影法进行电流修正\n\n目标是找到一个修正后的电流 $\\mathbf{J}^{\\mathrm{corr}}$，使得离散连续性方程被精确满足。这意味着修正后的残差 $r^{\\mathrm{corr}}$ 必须为零。\n$$\n\\frac{\\rho^{n+1}_{i,j}-\\rho^{n}_{i,j}}{\\Delta t} + (\\nabla_h\\cdot \\mathbf{J}^{\\mathrm{corr}})_{i,j} = 0\n$$\n从某种意义上说，修正是最小的。一种基于亥姆霍兹-霍奇分解的标准方法是假设修正是标量势 $\\phi$ 的梯度。这确保了修正量的旋度为零，这是可取的，因为它不会引入虚假的磁场。我们将修正后的电流 $\\mathbf{J}^{\\mathrm{corr}}$ 定义为\n$$\n\\mathbf{J}^{\\mathrm{corr}} = \\mathbf{J} - \\nabla_h \\phi\n$$\n其中 $\\mathbf{J}$ 是原始的不一致电流。将此代入目标连续性方程：\n$$\n\\frac{\\rho^{n+1}_{i,j}-\\rho^{n}_{i,j}}{\\Delta t} + (\\nabla_h\\cdot (\\mathbf{J} - \\nabla_h \\phi))_{i,j} = 0\n$$\n利用散度算子的线性性质，我们得到\n$$\n\\left( \\frac{\\rho^{n+1}_{i,j}-\\rho^{n}_{i,j}}{\\Delta t} + (\\nabla_h\\cdot \\mathbf{J})_{i,j} \\right) - (\\nabla_h\\cdot \\nabla_h \\phi)_{i,j} = 0\n$$\n括号中的项是原始残差 $r_{i,j}$。这导出了关于修正势 $\\phi$ 的离散泊松方程：\n$$\n\\nabla_h \\cdot \\nabla_h \\phi = r\n$$\n算子 $\\nabla_h \\cdot \\nabla_h$ 是离散拉普拉斯算子。给定交错网格上散度和梯度的定义，并且 $\\Delta x = \\Delta y = 1$，它就是作用于单元中心场 $\\phi$ 的标准 5 点模板：\n$$\n(\\nabla_h^2 \\phi)_{i,j} = (\\phi_{i+1,j} - 2\\phi_{i,j} + \\phi_{i-1,j}) + (\\phi_{i,j+1} - 2\\phi_{i,j} + \\phi_{i,j-1})\n$$\n\n### 基于傅里叶的泊松求解器\n\n对于周期性边界条件，离散泊松方程可以在傅里叶空间中高效求解。设 $\\hat{\\phi}$ 和 $\\hat{r}$ 分别是 $\\phi$ 和 $r$ 的二维离散傅里叶变换（DFT）。DFT 将离散卷积（拉普拉斯算子是一种卷积）转换成逐元素相乘。泊松方程的傅里叶空间表示为\n$$\n\\hat{L}(k_x, k_y) \\cdot \\hat{\\phi}(k_x, k_y) = \\hat{r}(k_x, k_y)\n$$\n其中 $\\hat{L}(k_x, k_y)$ 是离散拉普拉斯算子的傅里叶符号。对于 $\\Delta x = \\Delta y = 1$ 的 5 点模板，它等于\n$$\n\\hat{L}(k_x, k_y) = (e^{ik_x} - 2 + e^{-ik_x}) + (e^{ik_y} - 2 + e^{-ik_y}) = 2(\\cos(k_x) - 1) + 2(\\cos(k_y) - 1)\n$$\n其中 $k_x = 2\\pi m / N_x$ 和 $k_y = 2\\pi n / N_y$ 是模式 $(m, n)$ 的离散波数。\n\n势 $\\hat{\\phi}$ 可以通过除法求得：$\\hat{\\phi} = \\hat{r} / \\hat{L}$。然而，对于 $k=(0,0)$ 模式（即 $m=n=0$），存在一个奇异点，此时 $k_x=k_y=0$ 且 $\\hat{L}(0,0) = 0$。这对应于一个事实：周期域上的泊松方程只有在源项均值为零时才可解。$(0,0)$ 傅里叶模式 $\\hat{r}(0,0)$ 与网格上 $r_{i,j}$ 的总和（均值）成正比。如果 $\\hat{r}(0,0) \\neq 0$，则不存在解。\n问题通过要求 $\\phi$ 的均值为零来指定唯一解，这对应于设置 $\\hat{\\phi}(0,0) = 0$。整个过程是：\n1. 计算残差场 $r$。\n2. 计算其 DFT，$\\hat{r}$。\n3. 构建拉普拉斯算子符号 $\\hat{L}$。为避免除以零，我们可以将 $\\hat{L}(0,0)$ 正则化为一个非零值，例如 1。\n4. 计算 $\\hat{\\phi} = \\hat{r} / \\hat{L}$。\n5. 通过设置 $\\hat{\\phi}(0,0) = 0$ 来强制势具有零均值条件。此步骤有效地将残差 $r$ 投影到零均值场的空间上，丢弃任何非零均值分量。残差的不可修正部分将是其均值。\n6. 计算 $\\hat{\\phi}$ 的逆 DFT 以获得实空间中的势 $\\phi$。\n\n### 计算步骤摘要\n对于每个测试情况，算法按以下步骤进行：\n1. 根据情况说明构建网格和初始场 $\\rho^n$、$J_x$、$J_y$ 以及不一致项 $f_{i,j}$。\n2. 使用周期性移位计算离散散度 $(\\nabla_h \\cdot \\mathbf{J})_{i,j}$。\n3. 计算 $\\rho^{n+1}_{i,j} = \\rho^n_{i,j} - \\Delta t \\cdot (\\nabla_h\\cdot \\mathbf{J})_{i,j} + f_{i,j}$。\n4. 计算初始残差 $r_{i,j} = (\\rho^{n+1}_{i,j} - \\rho^n_{i,j}) / \\Delta t + (\\nabla_h \\cdot \\mathbf{J})_{i,j}$。根据推导，这可以简化为 $r_{i,j} = f_{i,j}/\\Delta t$。\n5. 计算初始高斯定律误差大小 $E_{\\mathrm{Gauss, init}} = \\Delta t \\cdot \\max_{i,j}|r_{i,j}| = \\max_{i,j}|f_{i,j}|$。\n6. 使用上述傅里叶方法求解离散泊松方程 $\\nabla_h^2\\phi = r$ 以找到 $\\phi$。\n7. 计算 $\\phi$ 的离散梯度以找到电流的修正量：$(\\nabla_h\\phi)_x$ 和 $(\\nabla_h\\phi)_y$。\n8. 计算修正后的电流：$J_x^{\\mathrm{corr}} = J_x - (\\nabla_h\\phi)_x$ 和 $J_y^{\\mathrm{corr}} = J_y - (\\nabla_h\\phi)_y$。\n9. 使用修正后的电流 $J_x^{\\mathrm{corr}}, J_y^{\\mathrm{corr}}$ 重新计算残差 $r^{\\mathrm{corr}}$。\n10. 计算修正后的高斯定律误差大小 $E_{\\mathrm{Gauss, corr}} = \\Delta t \\cdot \\max_{i,j}|r^{\\mathrm{corr}}_{i,j}|$。\n11. 确定一个布尔标志，指示 $E_{\\mathrm{Gauss, corr}} \\le E_{\\mathrm{Gauss, init}}$ 是否成立。\n此过程将应用于每个测试情况以生成最终结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_poisson_fourier(r_field, dx, dy):\n    \"\"\"\n    Solves the 2D discrete Poisson equation Nabla^2(phi) = r_field\n    on a periodic domain using Fourier methods.\n    \"\"\"\n    Nx, Ny = r_field.shape\n    \n    # 1. Compute the 2D DFT of the source term r_field.\n    r_hat = np.fft.fftn(r_field)\n\n    # 2. Construct the Fourier symbol of the discrete Laplacian.\n    kx = 2 * np.pi * np.fft.fftfreq(Nx, d=dx)\n    ky = 2 * np.pi * np.fft.fftfreq(Ny, d=dy)\n    kxx, kyy = np.meshgrid(kx, ky, indexing='ij')\n    \n    lap_hat = 2 * (np.cos(kxx) - 1) / (dx**2) + 2 * (np.cos(kyy) - 1) / (dy**2)\n    \n    # 3. Regularize the k=(0,0) mode to avoid division by zero.\n    lap_hat[0, 0] = 1.0\n    \n    # 4. Solve for phi_hat in Fourier space.\n    phi_hat = r_hat / lap_hat\n    \n    # 5. Enforce zero mean for phi by setting the k=(0,0) mode to zero.\n    phi_hat[0, 0] = 0.0\n    \n    # 6. Inverse transform to get the potential phi in real space.\n    # The result should be real since the input r_field is real.\n    phi = np.fft.ifftn(phi_hat).real\n    \n    return phi\n\ndef run_case(case_params):\n    \"\"\"\n    Runs a single test case for the current correction algorithm.\n    \"\"\"\n    Nx, Ny, dt, rho_n_func, Jx_func, Jy_func, f_func = case_params\n    dx, dy = 1.0, 1.0\n\n    # Setup grid and phases\n    i = np.arange(Nx)\n    j = np.arange(Ny)\n    ii, jj = np.meshgrid(i, j, indexing='ij')\n    xc = 2 * np.pi * (ii + 0.5) / Nx\n    yc = 2 * np.pi * (jj + 0.5) / Ny\n\n    # Build initial fields\n    rho_n = rho_n_func(xc, yc)\n    Jx = Jx_func(xc, yc)\n    Jy = Jy_func(xc, yc)\n    f = f_func(xc, yc, Nx, Ny)\n\n    # Compute discrete divergence of J\n    # Jx_i-1,j is at the left face of cell (i,j)\n    Jx_left = np.roll(Jx, 1, axis=0) \n    # Jy_i,j-1 is at the bottom face of cell (i,j)\n    Jy_bottom = np.roll(Jy, 1, axis=1) \n    \n    div_J = (Jx - Jx_left) / dx + (Jy - Jy_bottom) / dy\n\n    # Define rho^{n+1} as per problem statement\n    rho_np1 = rho_n - dt * div_J + f\n\n    # --- Initial Error Calculation ---\n    # Compute initial continuity residual, r = (rho_np1 - rho_n)/dt + div_J\n    # Analytically, this simplifies to r = f / dt\n    r_init = (rho_np1 - rho_n) / dt + div_J\n    \n    # Compute initial Gauss's law error magnitude\n    E_gauss_init = dt * np.max(np.abs(r_init))\n\n    # --- Correction ---\n    # 1. Solve Poisson's equation for the correction potential phi\n    phi = solve_poisson_fourier(r_init, dx, dy)\n\n    # 2. Compute the gradient of phi\n    grad_phi_x = (np.roll(phi, -1, axis=0) - phi) / dx\n    grad_phi_y = (np.roll(phi, -1, axis=1) - phi) / dy\n\n    # 3. Correct the currents\n    Jx_corr = Jx - grad_phi_x\n    Jy_corr = Jy - grad_phi_y\n\n    # --- Corrected Error Calculation ---\n    # Recompute the divergence with corrected currents\n    Jx_corr_left = np.roll(Jx_corr, 1, axis=0)\n    Jy_corr_bottom = np.roll(Jy_corr, 1, axis=1)\n    div_J_corr = (Jx_corr - Jx_corr_left) / dx + (Jy_corr - Jy_corr_bottom) / dy\n    \n    # Recompute the residual with corrected currents\n    r_corr = (rho_np1 - rho_n) / dt + div_J_corr\n    \n    # Compute corrected Gauss's law error magnitude\n    E_gauss_corr = dt * np.max(np.abs(r_corr))\n\n    # Determine if error was reduced\n    reduction_bool = E_gauss_corr = E_gauss_init\n\n    return [E_gauss_init, E_gauss_corr, reduction_bool]\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1\n        (8, 8, 0.2, \n         lambda xc, yc: 0.5 * np.sin(xc) * np.cos(yc),\n         lambda xc, yc: 0.4 * np.sin(xc) * np.sin(yc),\n         lambda xc, yc: -0.3 * np.cos(xc) * np.sin(yc),\n         lambda xc, yc, Nx, Ny: 0.01 * np.sin(xc) * np.sin(yc)),\n        # Case 2\n        (8, 8, 0.2, \n         lambda xc, yc: 0.5 * np.sin(xc) * np.cos(yc),\n         lambda xc, yc: 0.4 * np.sin(xc) * np.sin(yc),\n         lambda xc, yc: -0.3 * np.cos(xc) * np.sin(yc),\n         lambda xc, yc, Nx, Ny: 0.02 * np.ones((Nx, Ny))),\n        # Case 3\n        (8, 8, 0.2,\n         lambda xc, yc: 0.5 * np.sin(xc) * np.cos(yc),\n         lambda xc, yc: 0.4 * np.sin(xc) * np.sin(yc),\n         lambda xc, yc: -0.3 * np.cos(xc) * np.sin(yc),\n         lambda xc, yc, Nx, Ny: np.zeros((Nx, Ny))),\n        # Case 4\n        (6, 6, 0.15,\n         lambda xc, yc: 0.3 * np.sin(xc) * np.cos(yc),\n         lambda xc, yc: 0.25 * np.sin(xc) * np.sin(yc),\n         lambda xc, yc: 0.1 * np.cos(xc) * np.sin(yc),\n         lambda xc, yc, Nx, Ny: (\n             (f_arr := np.zeros((Nx, Ny)), \n              f_arr.__setitem__((2, 1), 0.05),\n              f_arr.__setitem__((4, 3), -0.05),\n              f_arr)[-1]\n         )),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_case(case)\n        results.append(result)\n    \n    # Custom string formatting to match Python's default representation\n    # which seems to be the intended format.\n    results_str = []\n    for res in results:\n        # Format boolean as TitleCase as per Python's str(bool)\n        # Format floats with reasonable precision for clean output\n        formatted_res = f\"[{res[0]:.17g}, {res[1]:.17g}, {str(res[2])}]\"\n        results_str.append(formatted_res)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results_str)}]\")\n\nsolve()\n```"
        }
    ]
}