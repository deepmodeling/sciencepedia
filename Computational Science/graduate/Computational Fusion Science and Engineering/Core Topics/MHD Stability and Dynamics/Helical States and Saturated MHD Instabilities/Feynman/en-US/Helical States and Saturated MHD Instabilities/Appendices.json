{
    "hands_on_practices": [
        {
            "introduction": "Helical instabilities in magnetically confined plasmas, such as tokamaks, are not ubiquitous; they are rooted at specific locations within the plasma. This exercise explores the fundamental condition that determines where these instabilities can form. The resonance condition, $q(r_s) = m/n$, arises from the requirement that the helical phase of a perturbation remains constant along an equilibrium magnetic field line, allowing the perturbation to effectively \"couple\" to the field. Mastering this calculation  is the essential first step in analyzing any helical magnetohydrodynamic (MHD) mode, connecting the equilibrium magnetic structure ($q(r)$) to the spatial location of potential instabilities.",
            "id": "3990708",
            "problem": "Consider a large-aspect-ratio tokamak with circular concentric magnetic flux surfaces of minor radius $a$ and major radius $R$, supporting an equilibrium magnetic field $\\mathbf{B}(r)$ that is axisymmetric. Let the field lines lie on nested flux surfaces and define the safety factor $q(r)$ as the ratio of toroidal turns to poloidal turns a field line makes, which in a large-aspect-ratio tokamak can be written as $q(r) = \\frac{r B_{\\phi}(r)}{R B_{\\theta}(r)}$, where $B_{\\phi}(r)$ and $B_{\\theta}(r)$ are the toroidal and poloidal components of the magnetic field, respectively. In Magnetohydrodynamics (MHD), a single-helicity perturbation with poloidal mode number $m$ and toroidal mode number $n$ has spatial dependence $\\exp\\!\\left[i (m \\theta - n \\phi)\\right]$. A resonant (rational) surface for such a perturbation is defined by the condition that the perturbation phase is stationary along equilibrium magnetic field lines, which is equivalent to vanishing parallel wave number for the helical mode.\n\nStarting from the parallel wave number definition for a helical perturbation and the field-line relation for equilibrium magnetic fields, derive the resonance condition in terms of the safety factor $q(r)$ and the integers $m$ and $n$, and then use it to determine the resonance radius $r_{s}$ for the $(m,n)=(2,1)$ mode in a plasma whose safety factor profile is given by $q(r) = 1 + \\left(\\frac{r}{a}\\right)^{2}$ for $0 \\le r \\le a$.\n\nExpress the resonance radius in meters in terms of $a$. The final answer must be a single closed-form symbolic expression.",
            "solution": "The problem is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n**Step 1: Extract Givens**\n-   Tokamak geometry: large-aspect-ratio, circular concentric flux surfaces, minor radius $a$, major radius $R$.\n-   Equilibrium magnetic field: $\\mathbf{B}(r)$, axisymmetric.\n-   Safety factor definition: $q(r) = \\frac{r B_{\\phi}(r)}{R B_{\\theta}(r)}$.\n-   Single-helicity perturbation: spatial dependence $\\exp\\!\\left[i (m \\theta - n \\phi)\\right]$, with poloidal mode number $m$ and toroidal mode number $n$.\n-   Resonance condition: The perturbation phase is stationary along equilibrium magnetic field lines, which is equivalent to a vanishing parallel wave number ($k_{||}=0$).\n-   Specific mode numbers: $(m,n)=(2,1)$.\n-   Specific safety factor profile: $q(r) = 1 + \\left(\\frac{r}{a}\\right)^{2}$ for $0 \\le r \\le a$.\n-   Objective: Derive the resonance condition in terms of $q(r)$, $m$, and $n$, and then determine the resonance radius $r_{s}$ for the given mode and profile.\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded**: The problem statement is based on fundamental principles of Magnetohydrodynamics (MHD) as applied to tokamak plasmas. The definitions of the safety factor $q$, helical perturbations, and the resonance condition are standard in fusion plasma physics. The given parabolic-like $q$-profile is a common and physically reasonable model. The problem is scientifically valid.\n-   **Well-Posed**: The problem is clearly defined and provides all necessary information and constraints to arrive at a unique solution. The given functions and parameters are sufficient for the required derivation and calculation.\n-   **Objective**: The language is precise, technical, and free of any subjective or ambiguous terminology.\n-   **Conclusion**: The problem is valid as it is self-contained, consistent, and scientifically sound.\n\n**Step 3: Verdict and Action**\n-   The problem is valid. A complete solution will be provided.\n\n**Derivation of the Resonance Condition**\n\nThe resonance condition for a helical perturbation occurs where the perturbation has a constant phase along an equilibrium magnetic field line. This is equivalent to the condition that the component of the perturbation's wave vector parallel to the equilibrium magnetic field, denoted $k_{||}$, is zero.\n\nThe phase of the perturbation is given by $\\alpha(r, \\theta, \\phi) = m \\theta - n \\phi$. The wave vector $\\mathbf{k}$ is the gradient of this phase, $\\mathbf{k} = \\nabla \\alpha$. In a large-aspect-ratio tokamak approximation with coordinates $(r, \\theta, \\phi)$, the gradient operator is $\\nabla = \\mathbf{e}_r \\frac{\\partial}{\\partial r} + \\mathbf{e}_{\\theta} \\frac{1}{r} \\frac{\\partial}{\\partial \\theta} + \\mathbf{e}_{\\phi} \\frac{1}{R} \\frac{\\partial}{\\partial \\phi}$.\nTherefore, the wave vector of the perturbation is:\n$$ \\mathbf{k} = \\nabla(m \\theta - n \\phi) = \\frac{m}{r} \\mathbf{e}_{\\theta} - \\frac{n}{R} \\mathbf{e}_{\\phi} $$\nThe equilibrium magnetic field $\\mathbf{B}(r)$ in an axisymmetric tokamak with nested circular flux surfaces has components only in the poloidal ($\\theta$) and toroidal ($\\phi$) directions:\n$$ \\mathbf{B}(r) = B_{\\theta}(r) \\mathbf{e}_{\\theta} + B_{\\phi}(r) \\mathbf{e}_{\\phi} $$\nThe parallel wave number is defined as $k_{||} = \\frac{\\mathbf{k} \\cdot \\mathbf{B}}{|\\mathbf{B}|}$. The resonance condition $k_{||}=0$ implies that the numerator must be zero:\n$$ \\mathbf{k} \\cdot \\mathbf{B} = 0 $$\nLet's evaluate the dot product at a given radius $r$:\n$$ \\mathbf{k} \\cdot \\mathbf{B} = \\left(\\frac{m}{r} \\mathbf{e}_{\\theta} - \\frac{n}{R} \\mathbf{e}_{\\phi}\\right) \\cdot \\left(B_{\\theta}(r) \\mathbf{e}_{\\theta} + B_{\\phi}(r) \\mathbf{e}_{\\phi}\\right) $$\nUsing the orthogonality of the unit vectors ($\\mathbf{e}_{\\theta} \\cdot \\mathbf{e}_{\\theta} = 1$, $\\mathbf{e}_{\\phi} \\cdot \\mathbf{e}_{\\phi} = 1$, $\\mathbf{e}_{\\theta} \\cdot \\mathbf{e}_{\\phi} = 0$), the expression simplifies to:\n$$ \\mathbf{k} \\cdot \\mathbf{B} = \\frac{m}{r} B_{\\theta}(r) - \\frac{n}{R} B_{\\phi}(r) $$\nThe resonance occurs at a specific radius $r_s$, known as the rational surface radius, where this expression is zero:\n$$ \\frac{m}{r_s} B_{\\theta}(r_s) - \\frac{n}{R} B_{\\phi}(r_s) = 0 $$\nRearranging this equation gives:\n$$ \\frac{m}{r_s} B_{\\theta}(r_s) = \\frac{n}{R} B_{\\phi}(r_s) $$\nTo relate this to the safety factor $q(r)$, we can isolate the ratio of the magnetic field components:\n$$ \\frac{m}{n} = \\frac{r_s B_{\\phi}(r_s)}{R B_{\\theta}(r_s)} $$\nThe right-hand side of this equation is, by definition, the safety factor $q(r)$ evaluated at the radius $r = r_s$. Thus, the general resonance condition for a helical mode with poloidal and toroidal mode numbers $m$ and $n$ is:\n$$ q(r_s) = \\frac{m}{n} $$\n\n**Calculation of the Resonance Radius**\n\nWe are asked to find the resonance radius $r_s$ for the $(m, n)=(2, 1)$ mode in a plasma with the safety factor profile:\n$$ q(r) = 1 + \\left(\\frac{r}{a}\\right)^{2} \\quad \\text{for } 0 \\le r \\le a $$\nApplying the resonance condition for the $(m,n)=(2,1)$ mode:\n$$ q(r_s) = \\frac{m}{n} = \\frac{2}{1} = 2 $$\nWe set the expression for the safety factor profile equal to $2$ and solve for $r_s$:\n$$ 1 + \\left(\\frac{r_s}{a}\\right)^{2} = 2 $$\nSubtracting $1$ from both sides of the equation yields:\n$$ \\left(\\frac{r_s}{a}\\right)^{2} = 1 $$\nTaking the square root of both sides gives:\n$$ \\frac{r_s}{a} = \\pm 1 $$\nSince the radius $r_s$ must be a non-negative physical quantity, we select the positive solution:\n$$ \\frac{r_s}{a} = 1 $$\nTherefore, the resonance radius $r_s$ is equal to the minor radius $a$:\n$$ r_s = a $$\nThis result is physically valid as it falls within the domain $0 \\le r \\le a$ where the $q$-profile is defined. It signifies that the resonant surface for the $(2,1)$ mode is located at the plasma edge.",
            "answer": "$$\\boxed{a}$$"
        },
        {
            "introduction": "The existence of a resonant surface is a necessary, but not sufficient, condition for a resistive tearing instability to grow. This practice introduces the tearing stability index, $\\Delta'$, a crucial parameter that determines whether a mode is stable or unstable. $\\Delta'$ quantifies the magnetic free energy available to drive reconnection, calculated from the jump in the logarithmic derivative of the perturbed magnetic flux across the resonant surface. By deriving $\\Delta'$ for a canonical cylindrical model , you will gain a deep, practical understanding of how the global magnetic field geometry, communicated through the \"outer\" ideal solution, dictates the stability of a mode at a specific resonant layer.",
            "id": "3990748",
            "problem": "Consider a large–aspect-ratio cylindrical tokamak of minor radius $a$ and major radius $R_0 \\gg a$, with an axisymmetric equilibrium magnetic field $\\mathbf{B}_0 = B_z \\,\\hat{\\mathbf{z}} + B_{\\theta}(r)\\,\\hat{\\boldsymbol{\\theta}}$, where $B_z$ is approximately constant and $B_{\\theta}(r)$ is determined by the safety factor profile. Assume the safety factor is approximately linear across the minor radius,\n$$\nq(r) = q_0 + \\hat{s}\\,\\frac{r}{a},\n$$\nwith $q_0  0$ and constant shear $\\hat{s}  0$, and that pressure effects are negligible (low-$\\beta$ limit). Consider a single-helicity perturbation with poloidal and toroidal mode numbers $(m,n)$, whose helical dependence is $\\exp\\!\\left[i\\left(m\\theta - \\frac{n}{R_0}z\\right)\\right]$, and define the resonant radius $r_s$ by the condition $q(r_s) = m/n$. A perfectly conducting cylindrical wall of radius $r_w \\ge a$ surrounds the plasma, with a vacuum region in $a  r  r_w$.\n\nIn the outer (ideal) region of the resistive tearing mode, the perturbed helical flux function $\\psi(r)$ satisfies the ideal Magnetohydrodynamics (MHD) matching conditions across $r=r_s$ and the appropriate regularity and boundary conditions at $r=0$, $r=a$, and $r=r_w$. The tearing stability index $\\Delta'$ is defined by\n$$\n\\Delta' \\equiv \\frac{\\psi'(r_s^{+}) - \\psi'(r_s^{-})}{\\psi(r_s)},\n$$\nwhere prime denotes differentiation with respect to $r$, and the superscripts $\\pm$ denote limits from above and below the resonant surface.\n\nStarting from fundamental ideal MHD principles in cylindrical geometry and using the physically consistent outer-region equation for $\\psi(r)$ together with the vacuum matching and wall boundary condition at $r=r_w$, derive and compute a closed-form analytic expression for $\\Delta'$ in terms of $m$, $n$, $a$, $q_0$, $\\hat{s}$, and $r_w$. You may assume $q_0  m/n  q_0 + \\hat{s}$ so that $0  r_s  a$, and that the outer-region solution is valid away from the narrow resistive layer about $r=r_s$. Express your final result as a single analytic expression. No numerical evaluation is required.",
            "solution": "The problem is subjected to validation against the specified criteria.\n\n### Step 1: Extract Givens\n- **System:** Large–aspect-ratio cylindrical tokamak.\n- **Radii:** Minor radius $a$, major radius $R_0 \\gg a$, conducting wall at $r_w \\ge a$.\n- **Equilibrium Magnetic Field:** $\\mathbf{B}_0 = B_z \\,\\hat{\\mathbf{z}} + B_{\\theta}(r)\\,\\hat{\\boldsymbol{\\theta}}$, with $B_z$ constant.\n- **Safety Factor:** $q(r) = q_0 + \\hat{s}\\,\\frac{r}{a}$, with $q_0  0$, $\\hat{s}  0$.\n- **Plasma Properties:** Pressure effects are negligible (low-$\\beta$ limit).\n- **Perturbation:** Single-helicity mode $(m,n)$ with dependence $\\exp\\!\\left[i\\left(m\\theta - \\frac{n}{R_0}z\\right)\\right]$.\n- **Resonant Surface:** Located at $r_s$ defined by $q(r_s) = m/n$. It is given that $0  r_s  a$.\n- **Regions:** Plasma for $0 \\le r \\le a$, vacuum for $a  r  r_w$.\n- **Object of Interest:** Tearing stability index $\\Delta' \\equiv \\frac{\\psi'(r_s^{+}) - \\psi'(r_s^{-})}{\\psi(r_s)}$, where $\\psi(r)$ is the perturbed helical flux function.\n- **Task:** Derive a closed-form analytic expression for $\\Delta'$ in terms of $m$, $n$, $a$, $q_0$, $\\hat{s}$, and $r_w$.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded:** The problem is a standard, canonical exercise in resistive magnetohydrodynamics (MHD) stability theory, specifically for tearing modes in a simplified cylindrical tokamak model. All concepts (safety factor, helical perturbations, tearing index $\\Delta'$) are fundamental to this field. The model is well-established. The problem is scientifically sound.\n2.  **Well-Posed:** The problem provides a well-defined differential equation (implicitly, as is standard), domain, and boundary conditions (regularity at the origin, conducting wall at infinity). The goal is to compute a specific, well-defined quantity, $\\Delta'$. The given condition $q_0  m/n  q_0 + \\hat{s}$ ensures a unique resonant surface $r_s$ exists within the plasma ($0  r_s  a$), making the problem well-posed.\n3.  **Objective:** The problem is stated using precise, objective, and standard terminology of plasma physics. There are no subjective or ambiguous statements.\n4.  **No other flaws detected:** The problem is self-contained, consistent, and requires a non-trivial derivation based on fundamental principles.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A solution will be derived.\n\n### Solution Derivation\nThe derivation of the tearing stability index $\\Delta'$ requires solving for the perturbed helical flux function $\\psi(r)$ in the \"outer region,\" which comprises all regions away from the thin resistive layer at the resonant surface $r=r_s$. In the low-$\\beta$, large-aspect-ratio cylindrical approximation, for modes with poloidal mode number $m \\ge 2$, the ideal MHD equations reduce to a simplified equation for $\\psi(r)$ in the outer region. This simplification involves neglecting the equilibrium plasma current gradient, which is a standard procedure for this canonical problem. The resulting equation for $\\psi(r)$ is the same in the outer plasma region ($r_s  r  a$) and in the vacuum region ($a  r  r_w$), as both are effectively current-free from the perspective of the perturbation. The equation is:\n$$\n\\frac{1}{r}\\frac{d}{dr}\\left(r\\frac{d\\psi}{dr}\\right) - \\frac{m^2}{r^2}\\psi = 0\n$$\nThis is a Cauchy-Euler equation, with the general solution:\n$$\n\\psi(r) = C_1 r^m + C_2 r^{-m}\n$$\nwhere $C_1$ and $C_2$ are constants to be determined by boundary and matching conditions. We must solve for $\\psi(r)$ in two distinct ideal regions: the inner region ($0 \\le r  r_s$) and the outer region ($r_s  r  r_w$).\n\n**1. Inner Region ($0 \\le r  r_s$)**\nLet the solution be $\\psi_I(r)$. The general solution is $\\psi_I(r) = A_I r^m + B_I r^{-m}$. Physical regularity at the magnetic axis ($r=0$) requires the solution to be finite. As $r \\to 0$, the $r^{-m}$ term diverges (for $m0$). Thus, we must set $B_I=0$. The solution is of the form:\n$$\n\\psi_I(r) = A_I r^m\n$$\nFor convenience, we normalize the solution such that $\\psi_I(r_s) = \\psi(r_s)$. This gives $A_I r_s^m = \\psi(r_s)$, so $A_I = \\psi(r_s)r_s^{-m}$. The inner solution is:\n$$\n\\psi_I(r) = \\psi(r_s) \\left(\\frac{r}{r_s}\\right)^m\n$$\n\n**2. Outer Region ($r_s  r  r_w$)**\nLet the solution be $\\psi_{II}(r)$. The general solution is $\\psi_{II}(r) = A_{II} r^m + B_{II} r^{-m}$. This region extends from just outside the resonant surface to the perfectly conducting wall. The boundary condition at the conducting wall at $r=r_w$ is that the radial magnetic field must vanish. The perturbed radial field is related to $\\psi$ by $B_{1r} \\propto \\psi/r$. Therefore, the boundary condition is $\\psi(r_w)=0$.\nApplying this condition to the outer solution:\n$$\n\\psi_{II}(r_w) = A_{II} r_w^m + B_{II} r_w^{-m} = 0\n$$\nThis allows us to relate the two coefficients: $A_{II} = -B_{II} r_w^{-2m}$. Substituting this back into the solution for $\\psi_{II}(r)$:\n$$\n\\psi_{II}(r) = -B_{II} r_w^{-2m} r^m + B_{II} r^{-m} = B_{II} \\left(r^{-m} - r^m r_w^{-2m}\\right)\n$$\nAt the resonant surface, the flux function must be continuous: $\\psi_{II}(r_s) = \\psi_I(r_s) = \\psi(r_s)$. Applying this condition:\n$$\n\\psi(r_s) = B_{II} \\left(r_s^{-m} - r_s^m r_w^{-2m}\\right)\n$$\nThis determines the constant $B_{II}$ in terms of $\\psi(r_s)$:\n$$\nB_{II} = \\frac{\\psi(r_s)}{r_s^{-m} - r_s^m r_w^{-2m}}\n$$\nSo the outer solution is:\n$$\n\\psi_{II}(r) = \\psi(r_s) \\frac{r^{-m} - r^m r_w^{-2m}}{r_s^{-m} - r_s^m r_w^{-2m}}\n$$\n\n**3. Calculation of $\\Delta'$**\nThe tearing stability index is defined as $\\Delta' = (\\psi'(r_s^+) - \\psi'(r_s^-)) / \\psi(r_s)$. We need to calculate the derivatives of $\\psi_I$ and $\\psi_{II}$ and evaluate them at $r=r_s$.\n\nFirst, for the inner solution approaching from below ($r \\to r_s^-$):\n$$\n\\psi_I'(r) = \\frac{d}{dr} \\left[ \\psi(r_s) \\left(\\frac{r}{r_s}\\right)^m \\right] = \\psi(r_s) \\frac{m r^{m-1}}{r_s^m}\n$$\nEvaluating at $r=r_s$:\n$$\n\\psi'(r_s^-) = \\psi(r_s) \\frac{m r_s^{m-1}}{r_s^m} = \\frac{m}{r_s} \\psi(r_s)\n$$\n\nNext, for the outer solution approaching from above ($r \\to r_s^+$):\n$$\n\\psi_{II}'(r) = \\frac{d}{dr} \\left[ \\psi(r_s) \\frac{r^{-m} - r^m r_w^{-2m}}{r_s^{-m} - r_s^m r_w^{-2m}} \\right] = \\frac{\\psi(r_s)}{r_s^{-m} - r_s^m r_w^{-2m}} \\left(-m r^{-m-1} - m r^{m-1} r_w^{-2m}\\right)\n$$\nEvaluating at $r=r_s$:\n$$\n\\psi'(r_s^+) = \\frac{\\psi(r_s)}{r_s^{-m} - r_s^m r_w^{-2m}} \\left(-m r_s^{-m-1} - m r_s^{m-1} r_w^{-2m}\\right)\n$$\nFactor out $-m r_s^{-m-1}$ from the numerator and $r_s^{-m}$ from the denominator:\n$$\n\\psi'(r_s^+) = \\psi(r_s) \\frac{-m r_s^{-m-1} \\left(1 + r_s^{2m} r_w^{-2m}\\right)}{r_s^{-m} \\left(1 - r_s^{2m} r_w^{-2m}\\right)} = -\\frac{m}{r_s} \\psi(r_s) \\frac{1 + (r_s/r_w)^{2m}}{1 - (r_s/r_w)^{2m}}\n$$\nNow, we compute $\\Delta'$:\n$$\n\\Delta' = \\frac{\\psi'(r_s^+) - \\psi'(r_s^-)}{\\psi(r_s)} = \\left(-\\frac{m}{r_s} \\frac{1 + (r_s/r_w)^{2m}}{1 - (r_s/r_w)^{2m}}\\right) - \\left(\\frac{m}{r_s}\\right)\n$$\n$$\n\\Delta' = -\\frac{m}{r_s} \\left[ \\frac{1 + (r_s/r_w)^{2m}}{1 - (r_s/r_w)^{2m}} + 1 \\right]\n$$\n$$\n\\Delta' = -\\frac{m}{r_s} \\left[ \\frac{1 + (r_s/r_w)^{2m} + 1 - (r_s/r_w)^{2m}}{1 - (r_s/r_w)^{2m}} \\right]\n$$\n$$\n\\Delta' = -\\frac{m}{r_s} \\left[ \\frac{2}{1 - (r_s/r_w)^{2m}} \\right] = -\\frac{2m}{r_s \\left(1 - (r_s/r_w)^{2m}\\right)}\n$$\n\n**4. Final Expression**\nThe final step is to express $r_s$ in terms of the given parameters from the safety factor profile $q(r) = q_0 + \\hat{s} \\frac{r}{a}$. The resonant surface is at $q(r_s) = m/n$:\n$$\nq_0 + \\hat{s} \\frac{r_s}{a} = \\frac{m}{n} \\implies \\frac{r_s}{a} = \\frac{m/n - q_0}{\\hat{s}} \\implies r_s = a \\frac{m/n - q_0}{\\hat{s}}\n$$\nSubstituting this expression for $r_s$ into our result for $\\Delta'$:\n$$\n\\Delta' = -\\frac{2m}{a \\frac{m/n - q_0}{\\hat{s}} \\left(1 - \\left(\\frac{a \\frac{m/n - q_0}{\\hat{s}}}{r_w}\\right)^{2m}\\right)}\n$$\nThis can be rewritten as:\n$$\n\\Delta' = -\\frac{2m\\hat{s}}{a(m/n - q_0)} \\left[ 1 - \\left( \\frac{a(m/n - q_0)}{\\hat{s}r_w} \\right)^{2m} \\right]^{-1}\n$$\nThis is the final closed-form analytic expression for $\\Delta'$.",
            "answer": "$$\n\\boxed{-\\frac{2m\\hat{s}}{a\\left(\\frac{m}{n} - q_0\\right)} \\left[ 1 - \\left( \\frac{a\\left(\\frac{m}{n} - q_0\\right)}{\\hat{s}r_w} \\right)^{2m} \\right]^{-1}}\n$$"
        },
        {
            "introduction": "When a tearing mode grows, it nonlinearly modifies the magnetic topology, breaking and reconnecting field lines to form a stable, saturated structure known as a magnetic island. The complex three-dimensional field line flow within this region can be elegantly described using the mathematics of Hamiltonian systems. This powerful analogy allows us to map the field line trajectories onto a two-dimensional phase space, revealing the island's separatrix and the distinct populations of \"trapped\" and \"circulating\" field lines. This computational exercise  provides hands-on experience with the nonlinear saturated state, using a symplectic integrator to construct a Poincaré map and visualize the intricate structure that emerges from an MHD instability.",
            "id": "3990755",
            "problem": "Consider a saturated single-helicity magnetohydrodynamic (MHD) magnetic island near a rational surface in a toroidal device, where the safety factor satisfies $q = m/n$ and the dominant helical perturbation has the phase $\\chi = m \\theta - n \\phi$. In the vicinity of the resonance, model the field-line dynamics on a poloidal cross-section using the canonical coordinates $(\\chi,\\Delta)$ and the integrable, normalized pendulum Hamiltonian\n$$\nH'(\\Delta,\\chi) = \\frac{1}{2}\\Delta^2 + 2 W \\sin^2\\!\\left(\\frac{\\chi}{2}\\right),\n$$\nwhere $W \\ge 0$ is the island strength parameter and all angles are in radians. The associated canonical equations are\n$$\n\\frac{d\\chi}{d\\zeta} = \\Delta, \\qquad \\frac{d\\Delta}{d\\zeta} = - W \\sin\\chi,\n$$\nwith $\\zeta$ a dimensionless field-line arclength parameter. A Poincaré map is obtained by stroboscopically sampling the $(\\chi,\\Delta)$ trajectory at fixed increments of $\\zeta$.\n\nYour tasks are:\n- Construct the stroboscopic Poincaré map by numerically integrating the canonical equations and sampling the resulting $(\\chi,\\Delta)$ points every fixed step in $\\zeta$. Use a symplectic scheme to ensure scientific realism in the preservation of area and near-constancy of the Hamiltonian for this integrable system.\n- Derive, from first principles of Hamiltonian dynamics, the invariant curves and their classification into trapped (inside the island), separatrix, and circulating (outside the island) based on the value of $H'(\\Delta,\\chi)$ relative to the separatrix energy.\n- Compute the island half-width and the separatrix lobe area in $(\\chi,\\Delta)$ phase space.\n- For trapped invariant curves with energy $h = H'(\\Delta,\\chi)$ such that $0 \\le h \\le 2W$ and $W  0$, compute the area enclosed by the invariant curve using complete elliptic integrals and report it. For circulating or separatrix initial conditions, report $0$ for this quantity.\n\nImplement a program that:\n1. Uses the symplectic leapfrog method to generate the stroboscopic Poincaré map for a specified number of steps $N$ and step size $\\Delta \\zeta = s$.\n2. Classifies each provided initial condition $(\\Delta_0,\\chi_0)$ by computing $h_0 = H'(\\Delta_0,\\chi_0)$ and comparing it to the separatrix energy $h_{\\mathrm{sep}} = 2W$.\n3. Computes the island half-width $w = 2\\sqrt{W}$ (dimensionless) and the separatrix lobe area $A_{\\mathrm{lobe}} = 8\\sqrt{W}$ (in the canonical phase-space units).\n4. For trapped initial conditions ($h_0  2W$), computes the area enclosed by the corresponding invariant curve\n$$\nA(h_0,W) = 8\\sqrt{W}\\left[ E(m) - \\big(1 - m\\big) K(m) \\right],\n$$\nwhere $m = \\frac{h_0}{2W}$, and $K(m)$ and $E(m)$ are the complete elliptic integrals of the first and second kinds, respectively. For circulating or separatrix initial conditions, report $A(h_0,W) = 0$.\n5. Verifies numerically the invariance of $H'$ along the symplectically integrated trajectory by checking that the maximum deviation of $H'$ from its initial value does not exceed a small tolerance. Report a single boolean per test case indicating whether all provided initial conditions preserve $H'$ within tolerance over the entire stroboscopic integration.\n\nAll angles must be in radians. No physical units are required for any quantity in this problem.\n\nUse the following test suite, which spans a general case, boundary conditions, and edge cases:\n- Test case $1$: $W = 0$, $N = 64$, $s = 1$, initial conditions $(\\Delta_0,\\chi_0)$:\n  - $(0.5,\\frac{\\pi}{2})$,\n  - $(0,0)$,\n  - $(0.1,\\pi)$.\n- Test case $2$: $W = \\frac{1}{16}$, $N = 128$, $s = 1$, initial conditions:\n  - $(0,\\pi)$,\n  - $(0,0)$,\n  - $(1,\\pi)$.\n- Test case $3$: $W = 10^{-6}$, $N = 64$, $s = 1$, initial conditions:\n  - $(0,\\pi)$,\n  - $(0,0)$,\n  - $(0.002,\\frac{\\pi}{2})$.\n- Test case $4$: $W = 1$, $N = 128$, $s = 1$, initial conditions:\n  - $(0,\\pi)$,\n  - $(0,0)$,\n  - $(3,\\frac{\\pi}{3})$.\n\nFor classification, use the following integer encoding: trapped $= 1$, separatrix $= 0$, circulating $= 2$. For the Hamiltonian invariance check, use a tolerance of $10^{-6}$ on the absolute deviation of $H'$ over all stroboscopic steps and initial conditions within a test case.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case must produce a list of the form\n$$\n[w,\\;A_{\\mathrm{lobe}},\\;\\text{areas},\\;\\text{classes},\\;\\text{invariance}],\n$$\nwhere $w$ and $A_{\\mathrm{lobe}}$ are floats, $\\text{areas}$ is a list of floats (one per initial condition), $\\text{classes}$ is a list of integers (one per initial condition), and $\\text{invariance}$ is a boolean. Aggregate the four test case lists into a single top-level list and print it exactly in one line, for example\n$$\n[[w_1,A_{\\mathrm{lobe},1},\\text{areas}_1,\\text{classes}_1,\\text{invariance}_1],\\ldots,[w_4,A_{\\mathrm{lobe},4},\\text{areas}_4,\\text{classes}_4,\\text{invariance}_4]].\n$$",
            "solution": "The problem requires an analysis of the dynamics of a saturated single-helicity magnetohydrodynamic (MHD) magnetic island, modeled by a canonical pendulum Hamiltonian. The solution involves deriving key physical parameters, classifying particle trajectories, implementing a symplectic numerical integration scheme, and applying special functions to compute geometric properties of the phase space.\n\n### 1. Theoretical Framework: The Pendulum Hamiltonian\n\nThe field-line dynamics near a rational surface in a toroidally confined plasma are described by the normalized Hamiltonian:\n$$\nH'(\\Delta,\\chi) = \\frac{1}{2}\\Delta^2 + 2 W \\sin^2\\!\\left(\\frac{\\chi}{2}\\right)\n$$\nHere, $(\\chi, \\Delta)$ are canonical coordinates representing the helical angle and a normalized radial coordinate, respectively. $W \\ge 0$ is the island strength parameter, proportional to the squared amplitude of the magnetic perturbation. Using the identity $2\\sin^2(x) = 1 - \\cos(2x)$, the Hamiltonian can be written in the standard pendulum form:\n$$\nH'(\\Delta,\\chi) = \\frac{1}{2}\\Delta^2 + W(1 - \\cos\\chi)\n$$\nThis represents a particle of unit mass with momentum $\\Delta$ in a potential $V(\\chi) = W(1 - \\cos\\chi)$. The corresponding canonical equations of motion are:\n$$\n\\frac{d\\chi}{d\\zeta} = \\frac{\\partial H'}{\\partial \\Delta} = \\Delta\n$$\n$$\n\\frac{d\\Delta}{d\\zeta} = -\\frac{\\partial H'}{\\partial \\chi} = -W \\sin\\chi\n$$\nwhere $\\zeta$ is a dimensionless parameter along the field line.\n\n### 2. Invariant Curves and Trajectory Classification\n\nThe Hamiltonian $H'$ is an integral of motion, meaning its value is constant along any given trajectory (field line). These constant-energy contours, $H'(\\Delta,\\chi) = h$, are the invariant curves of the system. The topology of these curves depends on the energy level $h$ relative to the energy of the separatrix.\n\nThe potential energy $V(\\chi)$ has stable fixed points at $\\chi = 2k\\pi$ (where $V=0$) and unstable fixed points at $\\chi = (2k+1)\\pi$ (where $V=2W$), for integer $k$. The trajectory passing through the unstable fixed point $(\\Delta, \\chi) = (0, \\pi)$ is the separatrix. Its energy is:\n$$\nh_{\\mathrm{sep}} = H'(0, \\pi) = \\frac{1}{2}(0)^2 + 2 W \\sin^2\\left(\\frac{\\pi}{2}\\right) = 2W\n$$\n\nThe trajectories are classified based on their energy $h_0 = H'(\\Delta_0, \\chi_0)$:\n- **Trapped (inside island)**: $0 \\le h_0  2W$. These trajectories are confined in the potential well, oscillating around the stable fixed point $(\\Delta, \\chi) = (0, 0)$. In phase space, they form closed loops centered at the origin.\n- **Separatrix**: $h_0 = 2W$. This special trajectory separates the trapped and circulating regions. It defines the boundary of the magnetic island.\n- **Circulating (outside island)**: $h_0  2W$. These trajectories are not confined in the potential well; the angle $\\chi$ increases or decreases without bound.\n\n### 3. Island Half-Width and Separatrix Area\n\nThe **island half-width**, denoted $w$, is the maximum extent of the separatrix in the $\\Delta$ coordinate. This occurs at $\\chi = 0$, where the potential energy is minimum. On the separatrix, $H'=2W$:\n$$\n\\frac{1}{2}\\Delta_{\\mathrm{max}}^2 + 2W\\sin^2(0) = 2W \\implies \\frac{1}{2}\\Delta_{\\mathrm{max}}^2 = 2W \\implies \\Delta_{\\mathrm{max}} = \\pm 2\\sqrt{W}\n$$\nThus, the half-width is $w = 2\\sqrt{W}$.\n\nThe **separatrix lobe area**, $A_{\\mathrm{lobe}}$, is the area enclosed by one of the two lobes of the separatrix (e.g., for $\\Delta  0$). It is calculated by the phase space integral $\\oint \\Delta \\,d\\chi$.\n$$\n\\Delta(\\chi) = \\sqrt{2(h_{\\mathrm{sep}} - V(\\chi))} = \\sqrt{2(2W - W(1-\\cos\\chi))} = \\sqrt{2W(1+\\cos\\chi)} = 2\\sqrt{W}|\\cos(\\chi/2)|\n$$\nIntegrating over one full period of the island from $\\chi=-\\pi$ to $\\chi=\\pi$:\n$$\nA_{\\mathrm{lobe}} = \\int_{-\\pi}^{\\pi} 2\\sqrt{W}\\cos(\\chi/2) \\, d\\chi = 2\\sqrt{W} \\left[2\\sin(\\chi/2)\\right]_{-\\pi}^{\\pi} = 4\\sqrt{W}(1 - (-1)) = 8\\sqrt{W}\n$$\n\n### 4. Area Enclosed by Trapped Trajectories\n\nFor a trapped trajectory with energy $h_0  2W$, the enclosed area $A(h_0, W)$ is also given by the action integral $\\oint \\Delta \\,d\\chi$. This integral can be evaluated in terms of the complete elliptic integrals of the first kind, $K(m)$, and second kind, $E(m)$. The result, provided in the problem, is a standard one from classical mechanics for pendulum-like motion:\n$$\nA(h_0,W) = 8\\sqrt{W}\\left[ E(m) - \\big(1 - m\\big) K(m) \\right]\n$$\nwhere $m = h_0 / (2W) = h_0 / h_{\\mathrm{sep}}$ is the normalized energy, satisfying $0 \\le m  1$. For circulating or separatrix trajectories ($m \\ge 1$), the concept of a finite enclosed area is not applicable in the same way, and the area is reported as $0$. The case $W=0$ results in $h_{\\mathrm{sep}}=0$; since $H' \\ge 0$, no trajectories are trapped ($h_0  0$), so the area is always $0$.\n\n### 5. Algorithmic Design: Symplectic Integration\n\nTo generate the Poincaré map, the canonical equations must be integrated numerically. Since this is a Hamiltonian system, a symplectic integrator is required to preserve the phase space volume and ensure the numerical trajectory stays close to the true constant-energy surface over long times. The leapfrog (or Störmer-Verlet) method is a simple and effective second-order symplectic scheme. For the given first-order system, it can be implemented as follows, with step size $s = \\Delta\\zeta$:\n\n1.  **Kick (half-step)**: Update momentum $\\Delta$ using the force at the current position $\\chi_n$.\n    $$ \\Delta_{n+1/2} = \\Delta_n + \\frac{s}{2} F(\\chi_n) = \\Delta_n - \\frac{s}{2}W\\sin\\chi_n $$\n2.  **Drift (full-step)**: Update position $\\chi$ using the new momentum $\\Delta_{n+1/2}$.\n    $$ \\chi_{n+1} = \\chi_n + s \\cdot \\Delta_{n+1/2} $$\n3.  **Kick (half-step)**: Update momentum $\\Delta$ again using the force at the new position $\\chi_{n+1}$.\n    $$ \\Delta_{n+1} = \\Delta_{n+1/2} + \\frac{s}{2} F(\\chi_{n+1}) = \\Delta_{n+1/2} - \\frac{s}{2}W\\sin\\chi_{n+1} $$\n\nThis method guarantees near-perfect conservation of the Hamiltonian $H'$ over many steps, which is numerically verified by checking that the maximum deviation $|H'(\\Delta_k, \\chi_k) - H'(\\Delta_0, \\chi_0)|$ remains below a small tolerance of $10^{-6}$.\n\n### 6. Implementation Summary\n\nThe solution is implemented as a Python program that processes each test case in sequence.\n1.  For a given $W$, the island half-width $w$ and separatrix lobe area $A_{\\mathrm{lobe}}$ are computed using the derived formulas.\n2.  For each initial condition $(\\Delta_0, \\chi_0)$:\n    a. The initial energy $h_0 = H'(\\Delta_0, \\chi_0)$ is calculated.\n    b. The trajectory is classified as trapped (1), separatrix (0), or circulating (2) by comparing $h_0$ to $h_{\\mathrm{sep}} = 2W$. A small numerical tolerance is used for the separatrix equality check.\n    c. If the trajectory is trapped and $W0$, the enclosed area $A(h_0,W)$ is computed using the elliptic integral formula, relying on `scipy.special.ellipk` and `scipy.special.ellipe`. Otherwise, the area is $0$.\n3.  The Hamiltonian invariance is checked by running the leapfrog integrator for $N$ steps for all initial conditions in a test case and tracking the maximum absolute deviation of $H'$ from its initial value.\n4.  The results for each test case—$[w, A_{\\mathrm{lobe}}, \\text{areas}, \\text{classes}, \\text{invariance}]$—are collected and formatted into a single-line string as specified.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import ellipk, ellipe\n\ndef solve():\n    \"\"\"\n    Solves the MHD magnetic island problem for a suite of test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"W\": 0.0, \"N\": 64, \"s\": 1.0,\n            \"ics\": [(0.5, np.pi/2), (0.0, 0.0), (0.1, np.pi)]\n        },\n        {\n            \"W\": 1.0/16.0, \"N\": 128, \"s\": 1.0,\n            \"ics\": [(0.0, np.pi), (0.0, 0.0), (1.0, np.pi)]\n        },\n        {\n            \"W\": 1e-6, \"N\": 64, \"s\": 1.0,\n            \"ics\": [(0.0, np.pi), (0.0, 0.0), (0.002, np.pi/2)]\n        },\n        {\n            \"W\": 1.0, \"N\": 128, \"s\": 1.0,\n            \"ics\": [(0.0, np.pi), (0.0, 0.0), (3.0, np.pi/3)]\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        result = process_test_case(case[\"W\"], case[\"N\"], case[\"s\"], case[\"ics\"])\n        all_results.append(result)\n\n    # Format the final output string according to the problem specification\n    # (a list of lists, printed on a single line, with no extra spaces).\n    outer_list_str = []\n    for res in all_results:\n        w, A_lobe, areas, classes, invariance = res\n        \n        # Format lists of numbers with controlled precision and no spaces\n        areas_str = f\"[{','.join(f'{a:.8g}' for a in areas)}]\"\n        classes_str = f\"[{','.join(map(str, classes))}]\"\n        \n        # Format boolean as lowercase 'true' or 'false'\n        invariance_str = str(invariance).lower()\n        \n        inner_list_str = f\"[{w:.8g},{A_lobe:.8g},{areas_str},{classes_str},{invariance_str}]\"\n        outer_list_str.append(inner_list_str)\n\n    final_output = f\"[{','.join(outer_list_str)}]\"\n    print(final_output)\n\ndef hamiltonian(delta, chi, W):\n    \"\"\"Computes the normalized pendulum Hamiltonian.\"\"\"\n    return 0.5 * delta**2 + 2.0 * W * np.sin(chi / 2.0)**2\n\ndef leapfrog_step(delta, chi, W, s):\n    \"\"\"Performs a single step of the symplectic leapfrog integrator.\"\"\"\n    # Kick (half-step for momentum)\n    delta_half = delta - (s / 2.0) * W * np.sin(chi)\n    # Drift (full-step for position)\n    chi_next = chi + s * delta_half\n    # Kick (half-step for momentum)\n    delta_next = delta_half - (s / 2.0) * W * np.sin(chi_next)\n    return delta_next, chi_next\n\ndef process_test_case(W, N, s, initial_conditions):\n    \"\"\"\n    Processes a single test case, calculating all required quantities.\n    \"\"\"\n    # Calculate island half-width and separatrix lobe area\n    if W == 0.0:\n        w = 0.0\n        A_lobe = 0.0\n    else:\n        w = 2.0 * np.sqrt(W)\n        A_lobe = 8.0 * np.sqrt(W)\n        \n    h_sep = 2.0 * W\n    \n    areas = []\n    classes = []\n    max_total_h_deviation = 0.0\n    \n    for delta_0, chi_0 in initial_conditions:\n        # 1. Calculate initial energy and classify trajectory\n        h_0 = hamiltonian(delta_0, chi_0, W)\n        \n        if np.isclose(h_0, h_sep, atol=1e-12, rtol=0):\n            cls = 0  # separatrix\n        elif h_0  h_sep:\n            cls = 1  # trapped\n        else:  # h_0  h_sep\n            cls = 2  # circulating\n        classes.append(cls)\n        \n        # 2. Calculate enclosed area for trapped particles\n        area = 0.0\n        if cls == 1 and W  0:\n            m = h_0 / h_sep\n            # Ensure m is strictly less than 1 for ellipk\n            m = min(m, 1.0 - 1e-15) \n            K_m = ellipk(m)\n            E_m = ellipe(m)\n            area = 8.0 * np.sqrt(W) * (E_m - (1.0 - m) * K_m)\n        areas.append(area)\n\n        # 3. Perform numerical integration to check Hamiltonian invariance\n        delta, chi = delta_0, chi_0\n        max_h_dev_for_ic = 0.0\n        for _ in range(N):\n            delta, chi = leapfrog_step(delta, chi, W, s)\n            h_current = hamiltonian(delta, chi, W)\n            max_h_dev_for_ic = max(max_h_dev_for_ic, abs(h_current - h_0))\n            \n        max_total_h_deviation = max(max_total_h_deviation, max_h_dev_for_ic)\n\n    invariance_tolerance = 1e-6\n    invariance = max_total_h_deviation = invariance_tolerance\n    \n    return [w, A_lobe, areas, classes, invariance]\n\nsolve()\n```"
        }
    ]
}