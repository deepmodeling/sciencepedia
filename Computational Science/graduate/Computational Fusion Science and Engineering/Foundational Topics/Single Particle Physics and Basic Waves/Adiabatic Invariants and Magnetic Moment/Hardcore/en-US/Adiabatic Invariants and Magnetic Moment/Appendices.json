{
    "hands_on_practices": [
        {
            "introduction": "Understanding the behavior of charged particles in spatially varying magnetic fields is fundamental to plasma confinement. This exercise explores a classic scenario where a particle moves into a region of stronger magnetic field, a setup analogous to a magnetic mirror. By combining the principle of magnetic moment conservation with the work-energy theorem in the presence of a parallel electric field, you will derive how the particle's energy is partitioned between motion parallel and perpendicular to the field, a key process in fusion devices and astrophysical plasmas. ",
            "id": "3947084",
            "problem": "A single charged particle of mass $m$ and charge $q$ moves as a guiding center along a magnetic field line in a collisionless plasma relevant to computational fusion science and engineering. The magnetic field magnitude varies only along the field-line coordinate $s$, increasing monotonically from $B(0)=B_{0}$ at $s=0$ to $B(L)=B_{1}$ at $s=L$, with $L$ much larger than the particle’s instantaneous gyroradius. A spatially uniform, time-independent electric field component $E_{\\parallel}$ is directed strictly parallel to the magnetic field everywhere. Neglect radiation and any perpendicular electric field components. The particle starts at $s=0$ with perpendicular speed $v_{\\perp 0}$ and parallel speed $v_{\\parallel 0}$.\n\nAssume the hierarchy of scales required for the first adiabatic invariant (magnetic moment) to remain conserved holds throughout the transit from $s=0$ to $s=L$, and that no magnetic mirroring occurs before reaching $s=L$. Using only fundamental laws and core definitions, derive an analytic expression for the particle’s final parallel kinetic energy at $s=L$, denoted $K_{\\parallel}(L)$, in terms of $m$, $q$, $v_{\\perp 0}$, $v_{\\parallel 0}$, $B_{0}$, $B_{1}$, $E_{\\parallel}$, and $L$. Express your final answer in Joules. No numerical evaluation is required.",
            "solution": "The particle’s motion can be described at the single-particle level by the Lorentz force, which is a fundamental law of electrodynamics:\n$$\nm\\,\\frac{d\\boldsymbol{v}}{dt} \\;=\\; q\\left(\\boldsymbol{E} \\;+\\; \\boldsymbol{v}\\times\\boldsymbol{B}\\right).\n$$\nThe instantaneous rate of change of the kinetic energy $K=\\tfrac{1}{2}m v^{2}$ is obtained by taking the scalar product of the velocity $\\boldsymbol{v}$ with the Lorentz force:\n$$\n\\frac{d}{dt}\\left(\\tfrac{1}{2}m v^{2}\\right) \\;=\\; m\\,\\boldsymbol{v}\\cdot\\frac{d\\boldsymbol{v}}{dt} \\;=\\; q\\,\\boldsymbol{v}\\cdot\\boldsymbol{E} \\;+\\; q\\,\\boldsymbol{v}\\cdot\\left(\\boldsymbol{v}\\times\\boldsymbol{B}\\right).\n$$\nThe magnetic part does no work because $\\boldsymbol{v}\\cdot\\left(\\boldsymbol{v}\\times\\boldsymbol{B}\\right)=0$, so the change in kinetic energy is entirely due to the electric field:\n$$\n\\frac{dK}{dt} \\;=\\; q\\,\\boldsymbol{v}\\cdot\\boldsymbol{E}.\n$$\nBy hypothesis, the electric field is strictly parallel to the magnetic field, i.e., $\\boldsymbol{E}=E_{\\parallel}\\,\\hat{\\boldsymbol{b}}$, where $\\hat{\\boldsymbol{b}}=\\boldsymbol{B}/B$ is the unit vector along the magnetic field. Therefore, $\\boldsymbol{v}\\cdot\\boldsymbol{E} = v_{\\parallel} E_{\\parallel}$, where $v_{\\parallel}$ is the component of velocity along $\\boldsymbol{B}$. Introducing the field-line arc length $s$ with $ds/dt=v_{\\parallel}$, we obtain\n$$\n\\frac{dK}{dt} \\;=\\; q\\,E_{\\parallel}\\,v_{\\parallel} \\;\\;\\Rightarrow\\;\\; \\frac{dK}{ds} \\;=\\; q\\,E_{\\parallel}.\n$$\nIntegrating along the path from $s=0$ to $s=L$ gives the total change in kinetic energy,\n$$\nK(L) - K(0) \\;=\\; \\int_{0}^{L} q\\,E_{\\parallel}\\,ds \\;=\\; q\\,E_{\\parallel}\\,L,\n$$\nwhere $K(0)=\\tfrac{1}{2}m v_{\\perp 0}^{2}+\\tfrac{1}{2}m v_{\\parallel 0}^{2}$ is the initial kinetic energy and $K(L)$ is the final kinetic energy at $s=L$.\n\nNext, we use the conservation of the first adiabatic invariant (magnetic moment), which is valid under the stated scale hierarchy (gyrofrequency large compared to field variation rate and gyroradius small compared to field gradient scale). The first adiabatic invariant (magnetic moment) is defined as\n$$\n\\mu \\;=\\; \\frac{m\\,v_{\\perp}^{2}}{2\\,B},\n$$\nand is conserved provided the field varies slowly compared to the gyro-motion and there is no significant perpendicular electric field. Conservation of $\\mu$ implies\n$$\n\\mu(0) \\;=\\; \\mu(L) \\;\\;\\Rightarrow\\;\\; \\frac{m\\,v_{\\perp 0}^{2}}{2\\,B_{0}} \\;=\\; \\frac{m\\,v_{\\perp}(L)^{2}}{2\\,B_{1}}.\n$$\nThus, the final perpendicular speed satisfies\n$$\nv_{\\perp}(L)^{2} \\;=\\; v_{\\perp 0}^{2}\\,\\frac{B_{1}}{B_{0}},\n$$\nand the perpendicular kinetic energy at $s=L$ is\n$$\nK_{\\perp}(L) \\;=\\; \\frac{1}{2}m\\,v_{\\perp}(L)^{2} \\;=\\; \\frac{1}{2}m\\,v_{\\perp 0}^{2}\\,\\frac{B_{1}}{B_{0}}.\n$$\nThe final total kinetic energy $K(L)$ is the sum of final perpendicular and final parallel kinetic energies:\n$$\nK(L) \\;=\\; K_{\\perp}(L) \\;+\\; K_{\\parallel}(L).\n$$\nWe also have from the work-energy relation derived earlier\n$$\nK(L) \\;=\\; K(0) \\;+\\; q\\,E_{\\parallel}\\,L \\;=\\; \\left[\\frac{1}{2}m\\,v_{\\perp 0}^{2} \\;+\\; \\frac{1}{2}m\\,v_{\\parallel 0}^{2}\\right] \\;+\\; q\\,E_{\\parallel}\\,L.\n$$\nCombining these expressions,\n$$\nK_{\\parallel}(L) \\;=\\; K(L) - K_{\\perp}(L) \\;=\\; \\left[\\frac{1}{2}m\\,v_{\\perp 0}^{2} \\;+\\; \\frac{1}{2}m\\,v_{\\parallel 0}^{2}\\right] \\;+\\; q\\,E_{\\parallel}\\,L \\;-\\; \\frac{1}{2}m\\,v_{\\perp 0}^{2}\\,\\frac{B_{1}}{B_{0}}.\n$$\nRearranging terms to make the dependence on initial parallel and perpendicular energies explicit,\n$$\nK_{\\parallel}(L) \\;=\\; \\frac{1}{2}m\\,v_{\\parallel 0}^{2} \\;+\\; q\\,E_{\\parallel}\\,L \\;+\\; \\frac{1}{2}m\\,v_{\\perp 0}^{2}\\left(1 - \\frac{B_{1}}{B_{0}}\\right).\n$$\nThis analytic expression shows how the conservation of the first adiabatic invariant (magnetic moment) redistributes energy between perpendicular and parallel components in the presence of a parallel electric field while honoring the total work done by the electric field. The result is expressed in Joules because each term is an energy.",
            "answer": "$$\\boxed{\\frac{1}{2}m\\,v_{\\parallel 0}^{2}\\;+\\;q\\,E_{\\parallel}\\,L\\;+\\;\\frac{1}{2}m\\,v_{\\perp 0}^{2}\\left(1-\\frac{B_{1}}{B_{0}}\\right)}$$"
        },
        {
            "introduction": "Translating physical laws into reliable computer simulations requires careful consideration of the numerical methods used. While the magnetic moment $\\mu$ is conserved in the continuous physical system under adiabatic conditions, this property is not automatically inherited by its discrete numerical counterpart. This practice problem exposes the pitfalls of a naive approach by analyzing the explicit forward-Euler method, demonstrating how it systematically fails to conserve energy and $\\mu$, leading to unphysical heating. Deriving the accuracy criterion for this scheme provides a crucial lesson in numerical analysis and underscores the need for integrators that respect the physics they aim to model. ",
            "id": "3947088",
            "problem": "Consider a single charged particle with charge $q$ and mass $m$ moving in a uniform, static magnetic field $\\mathbf{B} = B \\hat{\\mathbf{z}}$, with no electric field present. The equation of motion is the Newton–Lorentz force law $m\\,d\\mathbf{v}/dt = q\\,\\mathbf{v}\\times \\mathbf{B}$. Define the gyrofrequency $\\Omega \\equiv |q| B / m$, the cyclotron period $T \\equiv 2\\pi / \\Omega$, the perpendicular speed $v_{\\perp} \\equiv \\sqrt{v_x^2 + v_y^2}$, and the first adiabatic invariant (magnetic moment) $\\mu \\equiv m v_{\\perp}^2/(2 B)$. \n\nSuppose one advances the velocity using the explicit forward-Euler particle pusher with timestep $\\Delta t$ according to\n$$\n\\mathbf{v}^{n+1} = \\mathbf{v}^n + \\Delta t\\,\\frac{q}{m}\\,\\mathbf{v}^n \\times \\mathbf{B},\n$$\nstarting from an initial perpendicular velocity $\\mathbf{v}^0$ lying in the plane perpendicular to $\\mathbf{B}$, i.e., $v_z^0 = 0$. Let $N \\equiv T/\\Delta t = 2\\pi/(\\Omega \\Delta t)$ denote the number of timesteps used to cover one physical cyclotron period.\n\nWorking from the fundamental laws and definitions above (and without introducing any unphysical assumptions), analyze how this discretization affects the numerical conservation of the magnetic moment $\\mu$ in time. Quantify the relative error in $\\mu$ accumulated after one cyclotron period under the forward-Euler pusher, and then derive a closed-form sufficient upper bound on the timestep $\\Delta t$ that guarantees the relative error in $\\mu$ after one cyclotron period does not exceed a prescribed dimensionless tolerance $\\tau \\in (0,1)$.\n\nYour final answer must be the explicit formula for this sufficient upper bound $\\Delta t_{\\max}$ as a function of $\\Omega$ and $\\tau$, expressed in seconds. No approximations other than those rigorously justified during the derivation are permitted in the final expression. The final expression must be a single closed-form analytic expression. No rounding is required.",
            "solution": "The problem is first validated against the required criteria.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Charge of particle: $q$\n-   Mass of particle: $m$\n-   Magnetic field: $\\mathbf{B} = B \\hat{\\mathbf{z}}$ (uniform and static)\n-   Equation of motion: $m\\,d\\mathbf{v}/dt = q\\,\\mathbf{v}\\times \\mathbf{B}$\n-   Gyrofrequency: $\\Omega \\equiv |q| B / m$\n-   Cyclotron period: $T \\equiv 2\\pi / \\Omega$\n-   Perpendicular speed: $v_{\\perp} \\equiv \\sqrt{v_x^2 + v_y^2}$\n-   Magnetic moment (first adiabatic invariant): $\\mu \\equiv m v_{\\perp}^2/(2 B)$\n-   Forward-Euler velocity update rule: $\\mathbf{v}^{n+1} = \\mathbf{v}^n + \\Delta t\\,\\frac{q}{m}\\,\\mathbf{v}^n \\times \\mathbf{B}$\n-   Timestep: $\\Delta t$\n-   Initial condition: $v_z^0 = 0$\n-   Number of timesteps per period: $N \\equiv T/\\Delta t = 2\\pi/(\\Omega \\Delta t)$\n-   Error tolerance: $\\tau \\in (0,1)$\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded:** The problem is based on fundamental principles of classical electromagnetism (Lorentz force) and numerical analysis (forward-Euler method). The concept of the magnetic moment as an adiabatic invariant is central to plasma physics and fusion science. The problem is scientifically sound.\n-   **Well-Posed:** The problem statement is precise, providing all necessary definitions and equations. It asks for a quantitative analysis of numerical error and the derivation of a stability or accuracy constraint, which is a standard and well-posed problem in computational science. A unique, meaningful solution is expected to exist.\n-   **Objective:** The problem is stated using objective, formal language, free of ambiguity or subjective claims.\n\n**Step 3: Verdict and Action**\nThe problem is deemed valid. A complete solution will be developed.\n\n### Solution Derivation\n\nThe analysis begins with the discretization of the particle's equation of motion using the forward-Euler method. The velocity at timestep $n+1$ is given by:\n$$\n\\mathbf{v}^{n+1} = \\mathbf{v}^n + \\Delta t\\,\\frac{q}{m}\\,\\mathbf{v}^n \\times \\mathbf{B}\n$$\nWith the magnetic field $\\mathbf{B} = B \\hat{\\mathbf{z}}$, the cross product is $\\mathbf{v}^n \\times \\mathbf{B} = (v_x^n, v_y^n, v_z^n) \\times (0, 0, B) = (v_y^n B, -v_x^n B, 0)$. The component-wise update rules for the velocity are:\n$$\nv_x^{n+1} = v_x^n + \\Delta t\\,\\frac{qB}{m}v_y^n\n$$\n$$\nv_y^{n+1} = v_y^n - \\Delta t\\,\\frac{qB}{m}v_x^n\n$$\n$$\nv_z^{n+1} = v_z^n\n$$\nGiven the initial condition $v_z^0 = 0$, the parallel velocity component remains zero for all time, $v_z^n = 0$ for all $n \\ge 0$. The particle motion is confined to the plane perpendicular to $\\mathbf{B}$.\n\nWe use the definition of the gyrofrequency $\\Omega = |q|B/m$. Note that $qB/m = \\text{sgn}(q) |q|B/m = \\text{sgn}(q)\\Omega$. Let $\\theta \\equiv \\text{sgn}(q)\\Omega\\Delta t$. The update for the perpendicular velocity components $(v_x, v_y)$ becomes:\n$$\nv_x^{n+1} = v_x^n + \\theta v_y^n\n$$\n$$\nv_y^{n+1} = v_y^n - \\theta v_x^n\n$$\nThe problem concerns the magnetic moment $\\mu \\equiv m v_{\\perp}^2 / (2B)$, where $v_{\\perp}^2 = v_x^2 + v_y^2$. We analyze how $v_{\\perp}^2$ evolves under the numerical scheme.\n$$\n(v_{\\perp}^{n+1})^2 = (v_x^{n+1})^2 + (v_y^{n+1})^2 = (v_x^n + \\theta v_y^n)^2 + (v_y^n - \\theta v_x^n)^2\n$$\nExpanding the squares:\n$$\n(v_{\\perp}^{n+1})^2 = ((v_x^n)^2 + 2\\theta v_x^n v_y^n + \\theta^2(v_y^n)^2) + ((v_y^n)^2 - 2\\theta v_y^n v_x^n + \\theta^2(v_x^n)^2)\n$$\nThe cross-terms cancel, yielding:\n$$\n(v_{\\perp}^{n+1})^2 = (v_x^n)^2 + (v_y^n)^2 + \\theta^2((v_x^n)^2 + (v_y^n)^2) = (1+\\theta^2)((v_x^n)^2+(v_y^n)^2)\n$$\nSubstituting $\\theta^2 = (\\text{sgn}(q)\\Omega\\Delta t)^2 = (\\Omega\\Delta t)^2$, we have:\n$$\n(v_{\\perp}^{n+1})^2 = (1 + (\\Omega\\Delta t)^2)(v_{\\perp}^n)^2\n$$\nThis shows that the squared perpendicular speed, and thus the kinetic energy, is not conserved by the forward-Euler method, but instead grows geometrically at each step. The magnetic moment $\\mu^n = m(v_{\\perp}^n)^2/(2B)$ follows the same recurrence relation:\n$$\n\\mu^{n+1} = (1 + (\\Omega\\Delta t)^2)\\mu^n\n$$\nAfter $N$ timesteps, the magnetic moment $\\mu^N$ is related to the initial value $\\mu^0$ by:\n$$\n\\mu^N = (1 + (\\Omega\\Delta t)^2)^N \\mu^0\n$$\nThe relative error in $\\mu$ after one cyclotron period ($N=T/\\Delta t$ steps) is:\n$$\nE_{rel} = \\frac{\\mu^N - \\mu_{\\text{exact}}}{\\mu_{\\text{exact}}} = \\frac{\\mu^N - \\mu^0}{\\mu^0}\n$$\nIn the exact physical system, $\\mu$ is an invariant, so $\\mu_{\\text{exact}} = \\mu^0$.\n$$\nE_{rel} = \\frac{(1 + (\\Omega\\Delta t)^2)^N \\mu^0 - \\mu^0}{\\mu^0} = (1 + (\\Omega\\Delta t)^2)^N - 1\n$$\nThe problem requires this relative error to not exceed a tolerance $\\tau$:\n$$\n(1 + (\\Omega\\Delta t)^2)^N - 1 \\le \\tau\n$$\nWe are given $N = T/\\Delta t = (2\\pi/\\Omega)/\\Delta t = 2\\pi/(\\Omega\\Delta t)$. Substituting this into the inequality gives:\n$$\n\\left(1 + (\\Omega\\Delta t)^2\\right)^{2\\pi/(\\Omega\\Delta t)} - 1 \\le \\tau\n$$\nTo find a sufficient upper bound for $\\Delta t$, we use the fundamental inequality $(1+x) \\le e^x$, which is valid for all real $x$. Let $x=(\\Omega\\Delta t)^2$. Then we have:\n$$\n1 + (\\Omega\\Delta t)^2 \\le \\exp\\left((\\Omega\\Delta t)^2\\right)\n$$\nRaising both sides to the power of $N = 2\\pi/(\\Omega\\Delta t)$ (which is positive), we get:\n$$\n\\left(1 + (\\Omega\\Delta t)^2\\right)^N \\le \\left(\\exp\\left((\\Omega\\Delta t)^2\\right)\\right)^N = \\exp\\left(N(\\Omega\\Delta t)^2\\right)\n$$\nThe exponent is $N(\\Omega\\Delta t)^2 = \\left(\\frac{2\\pi}{\\Omega\\Delta t}\\right)(\\Omega\\Delta t)^2 = 2\\pi\\Omega\\Delta t$. Therefore, we have an upper bound on the amplification factor:\n$$\n\\left(1 + (\\Omega\\Delta t)^2\\right)^N \\le \\exp(2\\pi\\Omega\\Delta t)\n$$\nThis provides an upper bound for the relative error:\n$$\nE_{rel} = (1 + (\\Omega\\Delta t)^2)^N - 1 \\le \\exp(2\\pi\\Omega\\Delta t) - 1\n$$\nTo guarantee that $E_{rel} \\le \\tau$, it is sufficient to impose the stricter condition that our upper bound for the error does not exceed $\\tau$:\n$$\n\\exp(2\\pi\\Omega\\Delta t) - 1 \\le \\tau\n$$\nThis inequality can be solved directly for $\\Delta t$:\n$$\n\\exp(2\\pi\\Omega\\Delta t) \\le 1 + \\tau\n$$\nTaking the natural logarithm of both sides:\n$$\n2\\pi\\Omega\\Delta t \\le \\ln(1 + \\tau)\n$$\nFinally, isolating $\\Delta t$:\n$$\n\\Delta t \\le \\frac{\\ln(1 + \\tau)}{2\\pi\\Omega}\n$$\nThis expression provides a sufficient condition on the timestep $\\Delta t$ to ensure the relative error in the magnetic moment after one cyclotron period remains below the tolerance $\\tau$. The maximum timestep $\\Delta t_{\\max}$ that satisfies this sufficient condition is:\n$$\n\\Delta t_{\\max} = \\frac{\\ln(1 + \\tau)}{2\\pi\\Omega}\n$$\nThe units of $\\Omega$ are radians per second (or $s^{-1}$), and $\\tau$ is dimensionless. Therefore, the expression for $\\Delta t_{\\max}$ correctly yields a result in seconds.",
            "answer": "$$\\boxed{\\frac{\\ln(1 + \\tau)}{2\\pi\\Omega}}$$"
        },
        {
            "introduction": "Having seen how a simple integrator can fail, we now turn to a hands-on implementation of a method designed for long-term fidelity: the geometric splitting integrator, also known as the Boris algorithm. This exercise challenges you to code and compare this structure-preserving method against a standard, non-symplectic solver like the fourth-order Runge-Kutta method. By simulating particle motion in a non-uniform field and measuring the conservation of $\\mu$, you will gain practical experience with a cornerstone algorithm in computational plasma physics and see firsthand the superior performance of methods that preserve the geometric structure of the underlying dynamics. ",
            "id": "3947113",
            "problem": "Implement and compare two numerical time integrators for the motion of a single charged particle in a static but spatially nonuniform magnetic field in three dimensions, and demonstrate numerically that one of them preserves the first adiabatic invariant (the magnetic moment) better than the other. The motion is governed by the Newton–Lorentz equations\n$$\nm\\,\\frac{d\\boldsymbol{v}}{dt} = q\\,\\boldsymbol{v}\\times \\boldsymbol{B}(\\boldsymbol{x}),\\qquad \\frac{d\\boldsymbol{x}}{dt}=\\boldsymbol{v},\n$$\nwhere $m$ is the particle mass, $q$ is the particle charge, $\\boldsymbol{x}$ is position, $\\boldsymbol{v}$ is velocity, and $\\boldsymbol{B}(\\boldsymbol{x})$ is the magnetic field. Consider a nonuniform magnetic field directed along the $z$-axis with a weak linear gradient in $x$,\n$$\n\\boldsymbol{B}(\\boldsymbol{x}) = \\bigl(0,\\,0,\\,B_0\\,[1+\\epsilon\\,x/L]\\bigr),\n$$\nwith $B_0>0$ the reference magnetic field strength, $\\epsilon$ a dimensionless gradient amplitude, and $L$ a spatial scale. The magnetic moment is defined as\n$$\n\\mu(t) \\equiv \\frac{m\\,v_\\perp^2(t)}{2\\,|\\boldsymbol{B}(\\boldsymbol{x}(t))|},\n$$\nwhere $v_\\perp^2(t) \\equiv \\|\\boldsymbol{v}(t)\\|^2 - \\bigl(\\boldsymbol{v}(t)\\cdot \\hat{\\boldsymbol{b}}(\\boldsymbol{x}(t))\\bigr)^2$ and $\\hat{\\boldsymbol{b}}(\\boldsymbol{x})\\equiv \\boldsymbol{B}(\\boldsymbol{x})/|\\boldsymbol{B}(\\boldsymbol{x})|$. For sufficiently slow spatial variation, $\\mu$ is an adiabatic invariant; numerically, this manifests as small drift in $\\mu$ over many gyroperiods.\n\nYou must implement the following two integrators:\n\n- A geometric splitting integrator that separates the fast gyromotion and the slow drift via a second-order Strang splitting of two exactly solvable flows: a free-streaming flow and a pure-rotation flow. The free-streaming flow is given by $d\\boldsymbol{x}/dt=\\boldsymbol{v}$ and $d\\boldsymbol{v}/dt=\\boldsymbol{0}$; the pure-rotation flow is given by $d\\boldsymbol{x}/dt=\\boldsymbol{0}$ and $d\\boldsymbol{v}/dt=(q/m)\\,\\boldsymbol{v}\\times \\boldsymbol{B}(\\boldsymbol{x})$ with $\\boldsymbol{x}$ frozen during the substep. Compose these subflows in a symmetric sequence (half free-stream, full rotation, half free-stream) with the rotation computed using the exact rotation of $\\boldsymbol{v}$ around $\\hat{\\boldsymbol{b}}$ by angle $\\theta = \\Omega\\,\\Delta t$ with $\\Omega(\\boldsymbol{x}) \\equiv q\\,|\\boldsymbol{B}(\\boldsymbol{x})|/m$ and with $\\boldsymbol{B}$ evaluated at the position after the first half free-stream. This is equivalent, for zero electric field, to the classical Boris rotation step and should be implemented in that form to ensure numerical stability.\n\n- A naive explicit scheme based on the classical fourth-order Runge–Kutta method (single-step, explicit, non-symplectic) applied directly to the full system $d\\boldsymbol{x}/dt=\\boldsymbol{v}$, $d\\boldsymbol{v}/dt=(q/m)\\,\\boldsymbol{v}\\times \\boldsymbol{B}(\\boldsymbol{x})$.\n\nBoth schemes must be implemented in dimensionally consistent International System of Units (SI). Use the following physical constants and initial conditions:\n- Particle mass $m = 1.672\\,621\\,923\\,69\\times 10^{-27}\\,\\mathrm{kg}$, particle charge $q = 1.602\\,176\\,634\\times 10^{-19}\\,\\mathrm{C}$ (proton).\n- Reference magnetic field $B_0 = 1.0\\,\\mathrm{T}$, scale $L=1.0\\,\\mathrm{m}$.\n- Initial position $\\boldsymbol{x}(0)= (0,0,0)\\,\\mathrm{m}$.\n- Initial velocity composed of a perpendicular component $v_\\perp = 1.0\\times 10^{5}\\,\\mathrm{m/s}$ along $+\\hat{\\boldsymbol{x}}$ and a parallel component $v_\\parallel = 2.0\\times 10^{5}\\,\\mathrm{m/s}$ along $+\\hat{\\boldsymbol{z}}$, so that $\\boldsymbol{v}(0)=(v_\\perp,\\,0,\\,v_\\parallel)$.\n- Gyrofrequency at $B_0$: $\\Omega_0 \\equiv q B_0/m$, gyroperiod $T_0 \\equiv 2\\pi/\\Omega_0$.\n\nFor each simulation, integrate for a total time $T_{\\text{tot}}=100\\,T_0$, and use a uniform time step $\\Delta t = \\alpha\\,T_0$ with the specified $\\alpha$. For each method and each simulation, compute the relative deviation of the magnetic moment as\n$$\n\\mathcal{E} \\equiv \\max_{0\\le n \\le N}\\left|\\frac{\\mu_n - \\mu_0}{\\mu_0}\\right|,\n$$\nwhere $\\mu_n$ is the magnetic moment at time step $n$, $\\mu_0$ is the initial magnetic moment, and $N=T_{\\text{tot}}/\\Delta t$ is the total number of steps. For each test case, report the ratio\n$$\nR \\equiv \\frac{\\mathcal{E}_{\\text{split}}}{\\mathcal{E}_{\\text{RK4}}},\n$$\nwhich is dimensionless. Values $R<1$ indicate better preservation of $\\mu$ by the splitting scheme.\n\nYour program must run the following test suite (each tuple $(\\epsilon,\\alpha)$ specifies the magnetic field gradient amplitude and the time step in units of the gyroperiod):\n- Test $1$: $(\\epsilon,\\alpha) = (0.0,\\,0.05)$.\n- Test $2$: $(\\epsilon,\\alpha) = (0.1,\\,0.05)$.\n- Test $3$: $(\\epsilon,\\alpha) = (0.3,\\,0.05)$.\n- Test $4$: $(\\epsilon,\\alpha) = (0.1,\\,0.02)$.\n\nAll quantities must be computed in SI units. Angles used internally should be in radians. The final output must be a single line containing a Python-style list of four floating-point numbers $[R_1,R_2,R_3,R_4]$ corresponding to the above tests in order. Each $R_i$ must be printed as a decimal number. No additional text should be printed. The output is dimensionless; do not print any units with the numbers.",
            "solution": "The problem is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. It describes a standard, non-trivial task in computational plasma physics: the comparison of a geometric (symplectic) integrator with a general-purpose explicit integrator for simulating charged particle motion. The physical principles, governing equations, and numerical methods are all standard and correctly described. Therefore, the problem is valid, and a solution will be provided.\n\nThe core of the problem is to solve the system of ordinary differential equations for a proton's position $\\boldsymbol{x}(t)$ and velocity $\\boldsymbol{v}(t)$ in SI units:\n$$\n\\frac{d\\boldsymbol{x}}{dt} = \\boldsymbol{v}, \\qquad m\\,\\frac{d\\boldsymbol{v}}{dt} = q\\,\\boldsymbol{v}\\times \\boldsymbol{B}(\\boldsymbol{x})\n$$\nwhere $m$ is the proton mass, $q$ is its charge, and $\\boldsymbol{B}(\\boldsymbol{x})$ is a static, spatially non-uniform magnetic field given by\n$$\n\\boldsymbol{B}(\\boldsymbol{x}) = \\bigl(0,\\,0,\\,B_0\\,[1+\\epsilon\\,x/L]\\bigr).\n$$\nThis system describes the Lorentz force acting on the particle, which causes it to gyrate around magnetic field lines. For the given field, which is directed purely along the $\\hat{\\boldsymbol{z}}$ axis, the magnetic field lines are straight but the field strength $|\\boldsymbol{B}| = B_0\\,(1+\\epsilon\\,x/L)$ varies in the $\\hat{\\boldsymbol{x}}$ direction (assuming $1+\\epsilon\\,x/L > 0$).\n\nThe problem requires us to monitor the first adiabatic invariant, the magnetic moment $\\mu$, defined as:\n$$\n\\mu(t) = \\frac{m\\,v_\\perp^2(t)}{2\\,|\\boldsymbol{B}(\\boldsymbol{x}(t))|}\n$$\nHere, $v_\\perp$ is the component of the particle's velocity perpendicular to the local magnetic field direction $\\hat{\\boldsymbol{b}} = \\boldsymbol{B}/|\\boldsymbol{B}|$. The quantity $\\mu$ is approximately conserved if the magnetic field changes slowly and smoothly along the particle's trajectory. We will compare two numerical methods on their ability to preserve this near-conservation. The state of the system can be represented by a $6$-dimensional vector $\\boldsymbol{z}(t) = (\\boldsymbol{x}(t), \\boldsymbol{v}(t))$.\n\nFirst, we establish the physical parameters for the simulation. The particle is a proton, with mass $m = 1.672\\,621\\,923\\,69\\times 10^{-27}\\,\\mathrm{kg}$ and charge $q = 1.602\\,176\\,634\\times 10^{-19}\\,\\mathrm{C}$. The reference magnetic field is $B_0 = 1.0\\,\\mathrm{T}$. This defines a characteristic gyrofrequency $\\Omega_0 = q B_0 / m$ and gyroperiod $T_0 = 2\\pi / \\Omega_0$. The total simulation time is $T_{\\text{tot}} = 100\\,T_0$, with a time step $\\Delta t = \\alpha\\,T_0$.\n\nThe initial conditions are $\\boldsymbol{x}(0)=(0,0,0)\\,\\mathrm{m}$ and $\\boldsymbol{v}(0)=(1.0\\times 10^5, 0, 2.0\\times 10^5)\\,\\mathrm{m/s}$. At $t=0$, $\\boldsymbol{B}(\\boldsymbol{x}(0)) = (0,0,B_0)$, so the initial magnetic moment is $\\mu_0 = \\frac{m v_\\perp^2}{2 B_0}$, where $v_\\perp=1.0\\times 10^5\\,\\mathrm{m/s}$. We measure the performance of each integrator by the maximum relative deviation $\\mathcal{E} = \\max_n |(\\mu_n - \\mu_0)/\\mu_0|$.\n\n**Integrator 1: Classical Fourth-Order Runge–Kutta (RK4)**\n\nThe RK4 method is a standard, explicit, single-step solver for ODEs of the form $d\\boldsymbol{z}/dt = \\boldsymbol{f}(t, \\boldsymbol{z})$. For our autonomous system, $\\boldsymbol{f}(\\boldsymbol{z}) = (\\boldsymbol{v}, (q/m)\\boldsymbol{v}\\times\\boldsymbol{B}(\\boldsymbol{x}))$. To advance the state from $\\boldsymbol{z}_n$ at time $t_n$ to $\\boldsymbol{z}_{n+1}$ at time $t_{n+1} = t_n + \\Delta t$, we compute:\n$$ \\boldsymbol{k}_1 = \\Delta t \\, \\boldsymbol{f}(\\boldsymbol{z}_n) $$\n$$ \\boldsymbol{k}_2 = \\Delta t \\, \\boldsymbol{f}(\\boldsymbol{z}_n + \\frac{1}{2}\\boldsymbol{k}_1) $$\n$$ \\boldsymbol{k}_3 = \\Delta t \\, \\boldsymbol{f}(\\boldsymbol{z}_n + \\frac{1}{2}\\boldsymbol{k}_2) $$\n$$ \\boldsymbol{k}_4 = \\Delta t \\, \\boldsymbol{f}(\\boldsymbol{z}_n + \\boldsymbol{k}_3) $$\n$$ \\boldsymbol{z}_{n+1} = \\boldsymbol{z}_n + \\frac{1}{6}(\\boldsymbol{k}_1 + 2\\boldsymbol{k}_2 + 2\\boldsymbol{k}_3 + \\boldsymbol{k}_4) $$\nwhere each $\\boldsymbol{k}_i$ is a $6$-dimensional vector. This method is fourth-order accurate in $\\Delta t$. However, it is not symplectic, meaning it does not preserve the geometric structure of Hamiltonian phase space. For a pure magnetic field, the particle's kinetic energy $E_k = \\frac{1}{2}m|\\boldsymbol{v}|^2$ is an exact conserved quantity. RK4 does not exactly conserve this energy and typically introduces a secular numerical drift, which in turn leads to a secular drift in the computed value of $\\mu$.\n\n**Integrator 2: Geometric Splitting Integrator (Boris Method)**\n\nThis method is based on splitting the dynamics into simpler, exactly solvable parts. The system's evolution operator is split into a free-streaming part (operator $\\mathcal{A}$) and a pure-rotation part (operator $\\mathcal{B}$).\n$$ \\mathcal{A}: \\frac{d\\boldsymbol{x}}{dt} = \\boldsymbol{v}, \\quad \\frac{d\\boldsymbol{v}}{dt} = \\boldsymbol{0} \\qquad \\implies \\qquad \\boldsymbol{x}(t) = \\boldsymbol{x}_0 + \\boldsymbol{v}_0t, \\quad \\boldsymbol{v}(t) = \\boldsymbol{v}_0 $$\n$$ \\mathcal{B}: \\frac{d\\boldsymbol{x}}{dt} = \\boldsymbol{0}, \\quad \\frac{d\\boldsymbol{v}}{dt} = \\frac{q}{m}\\boldsymbol{v}\\times\\boldsymbol{B}(\\boldsymbol{x}) \\qquad \\implies \\qquad \\boldsymbol{x}(t) = \\boldsymbol{x}_0, \\quad \\boldsymbol{v}(t) \\text{ rotates around } \\boldsymbol{B}(\\boldsymbol{x}_0) $$\nA second-order accurate symmetric Strang splitting composes these operations as follows to advance from time $t_n$ to $t_n+\\Delta t$:\n\n1.  **First Half-Stream:** Advance position using the current velocity for a half time step, $\\Delta t/2$.\n    $$ \\boldsymbol{x}_{n+1/2} = \\boldsymbol{x}_n + \\boldsymbol{v}_n \\frac{\\Delta t}{2} $$\n    The velocity $\\boldsymbol{v}_n$ is unchanged in this substep.\n\n2.  **Full Rotation:** Evaluate the magnetic field at the midpoint position, $\\boldsymbol{B}_{\\text{mid}} = \\boldsymbol{B}(\\boldsymbol{x}_{n+1/2})$. Then, rotate the velocity vector $\\boldsymbol{v}_n$ for a full time step $\\Delta t$ under the influence of this constant field. The problem specifies this should be implemented as the classical Boris algorithm. For a velocity $\\boldsymbol{v}^-$ before the rotation, the velocity $\\boldsymbol{v}^+$ after the rotation is computed via:\n    $$ \\boldsymbol{t} = \\frac{q \\boldsymbol{B}_{\\text{mid}}}{m} \\frac{\\Delta t}{2} $$\n    $$ \\boldsymbol{s} = \\frac{2\\boldsymbol{t}}{1 + |\\boldsymbol{t}|^2} $$\n    $$ \\boldsymbol{v}' = \\boldsymbol{v}^- + \\boldsymbol{v}^- \\times \\boldsymbol{t} $$\n    $$ \\boldsymbol{v}^+ = \\boldsymbol{v}^- + \\boldsymbol{v}' \\times \\boldsymbol{s} $$\n    Let $\\boldsymbol{v}_{n, \\text{rot}} = \\boldsymbol{v}^+$ with $\\boldsymbol{v}^- = \\boldsymbol{v}_n$. This algorithm is numerically stable and exactly preserves the kinetic energy ($|\\boldsymbol{v}^+| = |\\boldsymbol{v}^-|$), a crucial property that RK4 lacks. While the problem statement mentions a rotation angle $\\theta = \\Omega \\Delta t$, the Boris algorithm performs a rotation by $2 \\arctan(\\Omega \\Delta t / 2)$, which is a more stable formulation for a numerical scheme. We follow the directive to use the Boris implementation.\n\n3.  **Second Half-Stream:** Advance the midpoint position using the new rotated velocity for another half time step.\n    $$ \\boldsymbol{x}_{n+1} = \\boldsymbol{x}_{n+1/2} + \\boldsymbol{v}_{n, \\text{rot}} \\frac{\\Delta t}{2} $$\n    The final state is $(\\boldsymbol{x}_{n+1}, \\boldsymbol{v}_{n+1} = \\boldsymbol{v}_{n, \\text{rot}})$.\n\nThis splitting scheme, often called a leapfrog or Boris-Buneman integrator, is symplectic for this Hamiltonian system. It will not exhibit secular drift in energy. Any error in energy (and thus $\\mu$) will be oscillatory and bounded. This superior long-term fidelity, especially for many gyroperiods, is what we expect to demonstrate. The ratio $R = \\mathcal{E}_{\\text{split}}/\\mathcal{E}_{\\text{RK4}}$ is expected to be significantly less than $1$.\n\nThe simulation procedure for each of the four test cases is as follows:\n1.  Set parameters $\\epsilon$ and $\\alpha$.\n2.  Calculate key time scales $T_0$, $T_{\\text{tot}}$, and $\\Delta t$.\n3.  Initialize the state $(\\boldsymbol{x}(0), \\boldsymbol{v}(0))$ and compute $\\mu_0$.\n4.  Run a simulation for $N = T_{\\text{tot}}/\\Delta t$ steps using the RK4 integrator, calculating $\\mu_n$ at each step and finding the maximum relative error $\\mathcal{E}_{\\text{RK4}}$.\n5.  Repeat step 4 using the Boris splitting integrator to find $\\mathcal{E}_{\\text{split}}$.\n6.  Compute and store the ratio $R = \\mathcal{E}_{\\text{split}} / \\mathcal{E}_{\\text{RK4}}$.\nAfter all four cases are processed, the list of $R$ values is reported.",
            "answer": "```python\nimport numpy as np\nfrom scipy import constants\n\ndef solve():\n    \"\"\"\n    Implements and compares RK4 and a geometric splitting (Boris) integrator\n    for charged particle motion in a non-uniform magnetic field, measuring\n    the preservation of the magnetic moment.\n    \"\"\"\n\n    # Physical constants (proton)\n    m = constants.m_p\n    q = constants.e\n\n    # Simulation parameters from the problem\n    B0 = 1.0  # Reference magnetic field strength in T\n    L = 1.0  # Spatial scale in m\n    v_perp_0 = 1.0e5  # Initial perpendicular velocity in m/s\n    v_para_0 = 2.0e5  # Initial parallel velocity in m/s\n\n    # Derived physical quantities\n    Omega0 = q * B0 / m  # Gyrofrequency at B0\n    T0 = 2.0 * np.pi / Omega0  # Gyroperiod at B0\n    T_tot_factor = 100.0 # Total simulation time is 100 * T0\n\n    # Initial conditions\n    x0 = np.array([0.0, 0.0, 0.0])\n    v0 = np.array([v_perp_0, 0.0, v_para_0])\n    z0 = np.concatenate((x0, v0))\n    \n    # Magnetic field function\n    def B_field(x, epsilon):\n        # B(x) = (0, 0, B0 * (1 + epsilon * x[0] / L))\n        return np.array([0.0, 0.0, B0 * (1.0 + epsilon * x[0] / L)])\n\n    # Rate function for ODE system `dz/dt = f(z)`\n    def f_ode(z, epsilon):\n        x, v = z[:3], z[3:]\n        B = B_field(x, epsilon)\n        dvdt = (q / m) * np.cross(v, B)\n        return np.concatenate((v, dvdt))\n\n    # --- Integrator Implementations ---\n\n    def rk4_step(z, dt, epsilon):\n        k1 = dt * f_ode(z, epsilon)\n        k2 = dt * f_ode(z + 0.5 * k1, epsilon)\n        k3 = dt * f_ode(z + 0.5 * k2, epsilon)\n        k4 = dt * f_ode(z + k3, epsilon)\n        return z + (k1 + 2.0 * k2 + 2.0 * k3 + k4) / 6.0\n\n    def boris_step(z, dt, epsilon):\n        x_n, v_n = z[:3], z[3:]\n        \n        # 1. First half-stream for position\n        x_half = x_n + v_n * (dt / 2.0)\n        \n        # 2. Full rotation for velocity\n        B = B_field(x_half, epsilon)\n        t = (q / m) * B * (dt / 2.0)\n        t_mag_sq = np.dot(t, t)\n        s = (2.0 * t) / (1.0 + t_mag_sq)\n        \n        v_minus = v_n\n        v_prime = v_minus + np.cross(v_minus, t)\n        v_plus = v_minus + np.cross(v_prime, s)\n        v_n_rot = v_plus\n        \n        # 3. Second half-stream for position\n        x_np1 = x_half + v_n_rot * (dt / 2.0)\n        \n        return np.concatenate((x_np1, v_n_rot))\n\n    # --- Simulation Runner ---\n    \n    def run_simulation(integrator_step, z0, dt, num_steps, epsilon):\n        # Magnetic moment calculation\n        def get_mu(z, epsilon):\n            x, v = z[:3], z[3:]\n            B_vec = B_field(x, epsilon)\n            B_mag = np.linalg.norm(B_vec)\n            if B_mag == 0: return 0.0\n            b_hat = B_vec / B_mag\n            v_parallel_mag = np.dot(v, b_hat)\n            v_perp_sq = np.dot(v, v) - v_parallel_mag**2\n            return (m * v_perp_sq) / (2.0 * B_mag)\n\n        mu0 = get_mu(z0, epsilon)\n        if mu0 == 0: return 0.0 # Avoid division by zero\n        \n        z = z0.copy()\n        max_rel_dev = 0.0\n        \n        for _ in range(num_steps):\n            z = integrator_step(z, dt, epsilon)\n            mu_n = get_mu(z, epsilon)\n            rel_dev = np.abs((mu_n - mu0) / mu0)\n            if rel_dev > max_rel_dev:\n                max_rel_dev = rel_dev\n                \n        return max_rel_dev\n        \n    # Test cases from the problem statement\n    test_cases = [\n        (0.0, 0.05),  # Test 1\n        (0.1, 0.05),  # Test 2\n        (0.3, 0.05),  # Test 3\n        (0.1, 0.02),  # Test 4\n    ]\n\n    results = []\n    \n    for epsilon, alpha in test_cases:\n        T_tot = T_tot_factor * T0\n        dt = alpha * T0\n        num_steps = int(round(T_tot / dt))\n\n        # Run with Boris integrator\n        E_split = run_simulation(boris_step, z0, dt, num_steps, epsilon)\n        \n        # Run with RK4 integrator\n        E_rk4 = run_simulation(rk4_step, z0, dt, num_steps, epsilon)\n        \n        # Calculate and store the ratio\n        if E_rk4 == 0:\n             # This can happen in the ideal case epsilon=0 if RK4 is very accurate\n             # or if both errors are numerically zero.\n             # Given the nature of the methods, if E_rk4 is 0, E_split should be too.\n            ratio = 1.0 if E_split == 0 else float('inf')\n        else:\n            ratio = E_split / E_rk4\n        \n        results.append(ratio)\n        \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}