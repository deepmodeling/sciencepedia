{
    "hands_on_practices": [
        {
            "introduction": "Understanding the geometry of a toroidal system begins with calculating its metric tensor and Jacobian. This exercise  provides fundamental practice by starting with a direct geometric description of flux surfaces, including the physically significant Shafranov shift. By deriving the metric components and Jacobian from first principles, you will solidify your understanding of how the spatial embedding of a coordinate system dictates the essential quantities for all subsequent physical calculations.",
            "id": "3959669",
            "problem": "Consider an axisymmetric toroidal plasma with circular cross-section of minor radius coordinate $r$, poloidal angle $\\theta$, and toroidal angle $\\phi$ (angles in radians). The major radius is $R_0$, and the magnetic axis is radially shifted by the Shafranov shift $\\Delta(r)$, which is a smooth function of $r$. A geometrical embedding of the flux surface labeled by $(r,\\theta,\\phi)$ into three-dimensional Euclidean space is specified in cylindrical coordinates $(R,\\phi,Z)$ by\n$$\nR(r,\\theta) \\;=\\; R_0 \\;+\\; \\Delta(r) \\;+\\; r \\cos\\theta, \n\\qquad\nZ(r,\\theta) \\;=\\; r \\sin\\theta,\n$$\nwith the usual Cartesian representation $(x,y,z)=(R\\cos\\phi,\\,R\\sin\\phi,\\,Z)$. Using only first principles of curvilinear coordinates in Euclidean space (definitions of covariant basis vectors, metric tensor, and coordinate Jacobian), derive the covariant metric component $g_{\\phi\\phi}$ and the coordinate Jacobian $J$ for the chart $(r,\\theta,\\phi)$, retaining all dependence on the Shafranov shift derivative $\\Delta'(r)$. Assume the chart is right-handed and take the Jacobian as positive. Express your final answer as a single row matrix $\\big(g_{\\phi\\phi},\\,J\\big)$ in terms of $R_0$, $\\Delta(r)$, $\\Delta'(r)$, $r$, and $\\theta$.",
            "solution": "The problem requires the derivation of the covariant metric tensor component $g_{\\phi\\phi}$ and the coordinate Jacobian $J$ for a given toroidal coordinate system $(r, \\theta, \\phi)$. The derivation must proceed from first principles.\n\nFirst, we establish the position vector $\\mathbf{x}$ of a point in Euclidean space, described by the curvilinear coordinates $(r, \\theta, \\phi)$. The problem provides the transformation to cylindrical coordinates $(R, \\phi, Z)$ and then to Cartesian coordinates $(x, y, z)$. Let the Cartesian basis vectors be $(\\hat{\\mathbf{i}}, \\hat{\\mathbf{j}}, \\hat{\\mathbf{k}})$.\n\nThe given relations are:\n$$R(r,\\theta) = R_0 + \\Delta(r) + r \\cos\\theta$$\n$$Z(r,\\theta) = r \\sin\\theta$$\nThe Cartesian coordinates are expressed as:\n$$x(r,\\theta,\\phi) = R(r,\\theta) \\cos\\phi$$\n$$y(r,\\theta,\\phi) = R(r,\\theta) \\sin\\phi$$\n$$z(r,\\theta) = Z(r,\\theta) = r \\sin\\theta$$\nThe position vector $\\mathbf{x}(r, \\theta, \\phi)$ is therefore:\n$$\\mathbf{x}(r, \\theta, \\phi) = R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{j}} + r \\sin\\theta \\, \\hat{\\mathbf{k}}$$\n\nThe covariant basis vectors, $\\mathbf{e}_i$, are defined as the partial derivatives of the position vector with respect to the curvilinear coordinates $q^i$. In our case, the coordinates are $(q^1, q^2, q^3) = (r, \\theta, \\phi)$.\n$$\\mathbf{e}_r = \\frac{\\partial \\mathbf{x}}{\\partial r}, \\quad \\mathbf{e}_\\theta = \\frac{\\partial \\mathbf{x}}{\\partial \\theta}, \\quad \\mathbf{e}_\\phi = \\frac{\\partial \\mathbf{x}}{\\partial \\phi}$$\n\nThe components of the covariant metric tensor, $g_{ij}$, are given by the dot product of the basis vectors:\n$$g_{ij} = \\mathbf{e}_i \\cdot \\mathbf{e}_j$$\n\nWe are asked to find $g_{\\phi\\phi}$. We first compute the basis vector $\\mathbf{e}_\\phi$:\n$$\\mathbf{e}_\\phi = \\frac{\\partial}{\\partial \\phi} \\left( R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{j}} + r \\sin\\theta \\, \\hat{\\mathbf{k}} \\right)$$\n$$\\mathbf{e}_\\phi = -R(r,\\theta) \\sin\\phi \\, \\hat{\\mathbf{i}} + R(r,\\theta) \\cos\\phi \\, \\hat{\\mathbf{j}}$$\nNow we compute $g_{\\phi\\phi}$ as the scalar product of $\\mathbf{e}_\\phi$ with itself:\n$$g_{\\phi\\phi} = \\mathbf{e}_\\phi \\cdot \\mathbf{e}_\\phi = (-R(r,\\theta) \\sin\\phi)^2 + (R(r,\\theta) \\cos\\phi)^2$$\n$$g_{\\phi\\phi} = R(r,\\theta)^2 \\sin^2\\phi + R(r,\\theta)^2 \\cos^2\\phi = R(r,\\theta)^2 (\\sin^2\\phi + \\cos^2\\phi)$$\n$$g_{\\phi\\phi} = R(r,\\theta)^2$$\nSubstituting the given expression for $R(r, \\theta)$:\n$$g_{\\phi\\phi} = (R_0 + \\Delta(r) + r \\cos\\theta)^2$$\n\nNext, we derive the coordinate Jacobian, $J$. The Jacobian is the volume element of the transformation and is given by the magnitude of the scalar triple product of the basis vectors, $J = |\\mathbf{e}_r \\cdot (\\mathbf{e}_\\theta \\times \\mathbf{e}_\\phi)|$. This is equivalent to the absolute value of the determinant of the Jacobian matrix of the transformation from $(r, \\theta, \\phi)$ to $(x, y, z)$.\n$$J = \\left| \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}\\right) \\right|$$\nThe problem specifies to take the Jacobian as positive, which is consistent with this definition. A convenient way to compute this determinant is to use the chain rule for Jacobians, by introducing the cylindrical coordinates $(R, \\phi, Z)$ as an intermediate set.\n$$ \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}\\right) = \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(R,\\phi,Z)}\\right) \\det\\left(\\frac{\\partial(R,\\phi,Z)}{\\partial(r,\\theta,\\phi)}\\right) $$\nFirst, we find the Jacobian of the transformation from cylindrical to Cartesian coordinates. The coordinates are ordered $(R, \\phi, Z)$ to correspond to a right-handed system.\n$$ \\det\\left(\\frac{\\partial(x,y,z)}{\\partial(R,\\phi,Z)}\\right) = \\det \\begin{pmatrix} \\cos\\phi & -R\\sin\\phi & 0 \\\\ \\sin\\phi & R\\cos\\phi & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} = R(\\cos^2\\phi + \\sin^2\\phi) = R $$\nSecond, we find the Jacobian of the transformation from our toroidal coordinates $(r,\\theta,\\phi)$ to the intermediate cylindrical coordinates $(R,Z,\\phi)$. Note the reordering to $(R,Z,\\phi)$ to match the matrix calculation.\n$$R = R(r,\\theta), \\quad Z = Z(r,\\theta), \\quad \\phi=\\phi$$\n$$ \\det\\left(\\frac{\\partial(R,Z,\\phi)}{\\partial(r,\\theta,\\phi)}\\right) = \\det \\begin{pmatrix} \\frac{\\partial R}{\\partial r} & \\frac{\\partial R}{\\partial \\theta} & \\frac{\\partial R}{\\partial \\phi} \\\\ \\frac{\\partial Z}{\\partial r} & \\frac{\\partial Z}{\\partial \\theta} & \\frac{\\partial Z}{\\partial \\phi} \\\\ \\frac{\\partial \\phi}{\\partial r} & \\frac{\\partial \\phi}{\\partial \\theta} & \\frac{\\partial \\phi}{\\partial \\phi} \\end{pmatrix} = \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta & 0 \\\\ \\sin\\theta & r\\cos\\theta & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} $$\nThe determinant is given by the top-left $2 \\times 2$ sub-determinant:\n$$ (\\Delta'(r)+\\cos\\theta)(r\\cos\\theta) - (-r\\sin\\theta)(\\sin\\theta) = r\\Delta'(r)\\cos\\theta + r\\cos^2\\theta + r\\sin^2\\theta $$\n$$ = r\\Delta'(r)\\cos\\theta + r(\\cos^2\\theta + \\sin^2\\theta) = r(1 + \\Delta'(r)\\cos\\theta) $$\nIt is crucial to note a subtlety with handedness. The transformation as defined, with the coordinate order $(r, \\theta, \\phi)$, naturally produces a left-handed system, for which the Jacobian determinant would be negative. A different ordering of coordinates in the intermediate step, such as $(R, \\phi, Z)$ vs $(r, \\theta, \\phi)$, can introduce a sign change. Let's verify the full Jacobian determinant sign by swapping columns to match $(r,\\theta,\\phi)$ mapping to $(R,\\phi,Z)$.\n$$ \\det\\left(\\frac{\\partial(R,\\phi,Z)}{\\partial(r,\\theta,\\phi)}\\right) = \\det \\begin{pmatrix} \\frac{\\partial R}{\\partial r} & \\frac{\\partial R}{\\partial \\theta} & \\frac{\\partial R}{\\partial \\phi} \\\\ \\frac{\\partial \\phi}{\\partial r} & \\frac{\\partial \\phi}{\\partial \\theta} & \\frac{\\partial \\phi}{\\partial \\phi} \\\\ \\frac{\\partial Z}{\\partial r} & \\frac{\\partial Z}{\\partial \\theta} & \\frac{\\partial Z}{\\partial \\phi} \\end{pmatrix} = \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta & 0 \\\\ 0 & 0 & 1 \\\\ \\sin\\theta & r\\cos\\theta & 0 \\end{pmatrix} $$\nExpanding along the second row:\n$$ -1 \\times \\det \\begin{pmatrix} \\Delta'(r)+\\cos\\theta & -r\\sin\\theta \\\\ \\sin\\theta & r\\cos\\theta \\end{pmatrix} = -r(1 + \\Delta'(r)\\cos\\theta) $$\nThe full determinant of the transformation $\\frac{\\partial(x,y,z)}{\\partial(r,\\theta,\\phi)}$ is the product of the two determinants:\n$$ \\det = R \\times [-r(1 + \\Delta'(r)\\cos\\theta)] = -rR(1 + \\Delta'(r)\\cos\\theta) $$\nThe Jacobian $J$ is the volume element, which must be positive. As instructed, we take the positive value, which corresponds to choosing an ordering of the coordinates that forms a right-handed system.\n$$ J = | -rR(1 + \\Delta'(r)\\cos\\theta) | $$\nFor a physically relevant toroidal plasma, $r>0$, $R>0$, and the Shafranov shift derivative $\\Delta'(r)$ is small enough that $1+\\Delta'(r)\\cos\\theta > 0$. Therefore:\n$$ J = rR(1 + \\Delta'(r)\\cos\\theta) $$\nSubstituting the expression for $R(r, \\theta)$:\n$$ J = r(R_0 + \\Delta(r) + r\\cos\\theta)(1 + \\Delta'(r)\\cos\\theta) $$\n\nThe final answer requires a row matrix $(g_{\\phi\\phi}, J)$.\n$g_{\\phi\\phi} = (R_0 + \\Delta(r) + r \\cos\\theta)^2$\n$J = r(R_0 + \\Delta(r) + r \\cos\\theta)(1 + \\Delta'(r)\\cos\\theta)$",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n(R_0 + \\Delta(r) + r \\cos\\theta)^2 & r(R_0 + \\Delta(r) + r \\cos\\theta)(1 + \\Delta'(r)\\cos\\theta)\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "While direct geometric construction is fundamental, specialized coordinate systems are often chosen to simplify the physics. This problem  delves into the celebrated Boozer coordinates, where the magnetic field has a particularly simple form. Your task is to derive how a poloidal variation in the magnetic field strength imposes a corresponding variation on the coordinate Jacobian, revealing the intimate link between plasma physics and the underlying coordinate geometry.",
            "id": "3959767",
            "problem": "Consider straight-field-line flux coordinates in a toroidal plasma, denoted by $(\\psi,\\theta,\\phi)$, where $\\psi$ is a nested flux surface label (proportional to toroidal flux), $\\theta$ is a poloidal angle, and $\\phi$ is a toroidal angle. The coordinate Jacobian $J$ is defined by $J^{-1} = (\\nabla \\psi \\times \\nabla \\theta) \\cdot \\nabla \\phi$. Assume the magnetic field $\\boldsymbol{B}$ is divergence-free and admits a Clebsch representation $\\boldsymbol{B} = \\nabla \\psi \\times \\nabla \\alpha$, where field lines are straight in $(\\theta,\\phi)$ so that $\\alpha = \\theta - \\iota(\\psi)\\,\\phi$, with $\\iota(\\psi)$ the rotational transform. In Boozer coordinates, the covariant components of $\\boldsymbol{B}$ are flux functions: $\\boldsymbol{B} = I(\\psi)\\,\\nabla \\phi + G(\\psi)\\,\\nabla \\theta$, where $I(\\psi)$ and $G(\\psi)$ are the toroidal and poloidal covariant coefficients, respectively.\n\nNear the magnetic axis, suppose the magnitude of the magnetic field varies poloidally on a given flux surface as $B(\\theta) \\approx B_0 \\left(1 - \\epsilon \\cos \\theta\\right)$, with $0<\\epsilon \\ll 1$ and $B_0$ the on-axis reference field strength. Working to leading order in $\\epsilon$, and treating $I(\\psi)$, $G(\\psi)$, and $\\iota(\\psi)$ as constants on the chosen flux surface, derive the first-order angular dependence of the Boozer coordinate Jacobian $J(\\theta)$ implied by the above definitions. Your derivation must begin from the stated coordinate and magnetic field definitions, and use only standard vector-calculus identities and properties of flux coordinates.\n\nExpress your final answer as a single closed-form analytic expression $J(\\theta)$ in terms of $I$, $G$, $\\iota$, $B_0$, $\\epsilon$, and $\\theta$, retaining terms up to order $\\epsilon$. Specify the angle $\\theta$ in radians. No numerical evaluation is required.",
            "solution": "The derivation proceeds by relating the various definitions provided for the magnetic field $\\boldsymbol{B}$ and the coordinate Jacobian $J$. The setting is a system of straight-field-line flux coordinates $(\\psi, \\theta, \\phi)$.\n\nWe are given two representations for the magnetic field $\\boldsymbol{B}$. The first is the Clebsch form for straight field lines:\n$$\n\\boldsymbol{B} = \\nabla\\psi \\times \\nabla\\alpha = \\nabla\\psi \\times \\nabla(\\theta - \\iota(\\psi)\\phi)\n$$\nOn a single flux surface, $\\psi$ is constant and $\\iota(\\psi)$ is treated as a constant, $\\iota$. Expanding the gradient of $\\alpha$ gives $\\nabla\\alpha = \\nabla\\theta - \\iota\\nabla\\phi$. Thus, the magnetic field is:\n$$\n\\boldsymbol{B} = \\nabla\\psi \\times (\\nabla\\theta - \\iota\\nabla\\phi) = \\nabla\\psi \\times \\nabla\\theta - \\iota(\\nabla\\psi \\times \\nabla\\phi)\n$$\nThe contravariant components of the magnetic field, $B^i = \\boldsymbol{B} \\cdot \\nabla q^i$, can be computed from this form. The poloidal contravariant component, $B^\\theta$, is:\n$$\nB^\\theta = \\boldsymbol{B} \\cdot \\nabla\\theta = (\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\theta - \\iota(\\nabla\\psi \\times \\nabla\\phi) \\cdot \\nabla\\theta = 0 - \\iota(\\nabla\\psi \\times \\nabla\\phi) \\cdot \\nabla\\theta\n$$\nUsing the cyclic property of the scalar triple product, $(A \\times B) \\cdot C = A \\cdot (B \\times C)$, we get:\n$$\nB^\\theta = \\iota \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi)\n$$\nBy definition, the coordinate Jacobian $J$ is given by $J^{-1} = (\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\phi = \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi)$. Therefore, we find:\n$$\nB^\\theta = \\iota J^{-1}\n$$\nSimilarly, for the toroidal contravariant component, $B^\\phi$:\n$$\nB^\\phi = \\boldsymbol{B} \\cdot \\nabla\\phi = (\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\phi - \\iota(\\nabla\\psi \\times \\nabla\\phi) \\cdot \\nabla\\phi = (\\nabla\\psi \\times \\nabla\\theta) \\cdot \\nabla\\phi - 0\n$$\n$$\nB^\\phi = \\nabla\\psi \\cdot (\\nabla\\theta \\times \\nabla\\phi) = J^{-1}\n$$\nSo, the contravariant representation of the field has components $B^\\psi=0$, $B^\\theta=\\iota/J$, and $B^\\phi=1/J$.\n\nThe second representation provided is the covariant form for Boozer coordinates:\n$$\n\\boldsymbol{B} = G(\\psi)\\nabla\\theta + I(\\psi)\\nabla\\phi\n$$\nOn the chosen flux surface, $G(\\psi)$ and $I(\\psi)$ are treated as constants, $G$ and $I$. Here, $B_\\theta = G$ and $B_\\phi = I$ are the covariant components.\n\nTo find the relationship between these quantities, we compute the magnitude squared of the magnetic field, $B^2 = \\boldsymbol{B} \\cdot \\boldsymbol{B}$, by combining the covariant and contravariant forms:\n$$\nB^2 = \\boldsymbol{B} \\cdot \\boldsymbol{B} = (G\\nabla\\theta + I\\nabla\\phi) \\cdot \\boldsymbol{B} = G(\\boldsymbol{B} \\cdot \\nabla\\theta) + I(\\boldsymbol{B} \\cdot \\nabla\\phi)\n$$\nSubstituting the expressions for the contravariant components $B^\\theta$ and $B^\\phi$:\n$$\nB^2 = G B^\\theta + I B^\\phi = G(\\iota J^{-1}) + I(J^{-1}) = \\frac{G\\iota + I}{J}\n$$\nThis fundamental relation for Boozer coordinates can be rearranged to express the Jacobian $J$ in terms of the magnetic field strength $B$:\n$$\nJ = \\frac{G\\iota + I}{B^2}\n$$\nThe problem supplies the poloidal variation of the magnetic field magnitude on the flux surface:\n$$\nB(\\theta) \\approx B_0 (1 - \\epsilon \\cos\\theta)\n$$\nWe need to work to first order in $\\epsilon$. We first compute $B^2(\\theta)$:\n$$\nB^2(\\theta) \\approx \\left[B_0(1 - \\epsilon \\cos\\theta)\\right]^2 = B_0^2 (1 - 2\\epsilon \\cos\\theta + \\epsilon^2 \\cos^2\\theta)\n$$\nKeeping terms only up to order $\\epsilon$, we have:\n$$\nB^2(\\theta) \\approx B_0^2 (1 - 2\\epsilon \\cos\\theta)\n$$\nNow, substitute this into the expression for $J$:\n$$\nJ(\\theta) \\approx \\frac{G\\iota + I}{B_0^2(1 - 2\\epsilon \\cos\\theta)} = \\frac{G\\iota + I}{B_0^2} (1 - 2\\epsilon \\cos\\theta)^{-1}\n$$\nTo obtain the final expression to first order in $\\epsilon$, we apply the binomial approximation $(1+x)^n \\approx 1+nx$ for small $|x|$. Here, $x = -2\\epsilon \\cos\\theta$ and $n=-1$:\n$$\n(1 - 2\\epsilon \\cos\\theta)^{-1} \\approx 1 + (-1)(-2\\epsilon \\cos\\theta) = 1 + 2\\epsilon \\cos\\theta\n$$\nSubstituting this back, we arrive at the final expression for the Jacobian's angular dependence:\n$$\nJ(\\theta) \\approx \\frac{G\\iota + I}{B_0^2} (1 + 2\\epsilon \\cos\\theta)\n$$",
            "answer": "$$\n\\boxed{\\frac{G\\iota + I}{B_0^2} \\left(1 + 2\\epsilon \\cos\\theta\\right)}\n$$"
        },
        {
            "introduction": "Analytical tools are powerful, but modern fusion science relies on computation to handle complex, three-dimensional geometries. This hands-on exercise  challenges you to bridge the gap between theory and practice by developing a numerical algorithm to compute metric properties on a discrete grid. By implementing and validating your code against various test cases, you will gain practical experience in the foundational tasks of setting up a computational model for a toroidal plasma.",
            "id": "3959709",
            "problem": "A Three-Dimensional (3D) toroidal flux surface embedded in Euclidean space can be represented in cylindrical coordinates by a discrete map $(\\theta,\\phi) \\mapsto (R(\\theta,\\phi),Z(\\theta,\\phi))$, with Cartesian coordinates defined by $x(\\theta,\\phi) = R(\\theta,\\phi)\\cos\\phi$, $y(\\theta,\\phi) = R(\\theta,\\phi)\\sin\\phi$, and $z(\\theta,\\phi) = Z(\\theta,\\phi)$. Angles must be treated in radians. Consider a fixed flux surface labeled by a scalar flux coordinate $\\psi$ (not varied in this problem). The goal is to compute the on-surface coordinate metric components $g_{ij}$ for $i,j \\in \\{\\theta,\\phi\\}$, the surface area Jacobian $J$ associated with the parameterization $(\\theta,\\phi)$, and tangential approximations to the gradients $\\nabla\\theta$ and $\\nabla\\phi$ using a discrete representation of $R(\\theta,\\phi)$ and $Z(\\theta,\\phi)$ on a periodic grid.\n\nStarting from the Euclidean line element written in Cartesian coordinates and using the chain rule for coordinate transformations, derive expressions that relate the covariant tangent basis vectors to the metric components and the Jacobian. Use the definition of reciprocal bases on the tangent plane to obtain expressions for the tangential gradients $\\nabla\\theta$ and $\\nabla\\phi$ in terms of the inverse metric and the covariant basis. Your derivation must begin from the following fundamental bases:\n- The Euclidean inner product in Cartesian space and the definition of the differential displacement $\\mathrm{d}\\mathbf{r}$.\n- The covariant basis vectors defined by partial derivatives of the embedding $\\mathbf{r}(\\theta,\\phi)$.\n- The relation between reciprocal bases and the inverse of the metric tensor on the surface tangent plane.\n\nDesign an algorithm to compute all required quantities on a discrete, uniform, periodic grid:\n- Let the discrete grids be $\\theta_k = k\\Delta\\theta$ for $k \\in \\{0,1,\\ldots,N_\\theta-1\\}$ and $\\phi_\\ell = \\ell\\Delta\\phi$ for $\\ell \\in \\{0,1,\\ldots,N_\\phi-1\\}$ with $\\Delta\\theta = 2\\pi/N_\\theta$ and $\\Delta\\phi = 2\\pi/N_\\phi$ (angles in radians).\n- Approximate partial derivatives $\\partial_\\theta$ and $\\partial_\\phi$ of $R(\\theta,\\phi)$ and $Z(\\theta,\\phi)$ using second-order accurate central finite differences with periodic wrap-around.\n- Construct Cartesian components of the covariant basis vectors from the discrete derivatives and the cylindrical-to-Cartesian relations.\n- From the covariant basis, compute the metric components $g_{\\theta\\theta}$, $g_{\\theta\\phi}$, and $g_{\\phi\\phi}$ on the grid, the surface Jacobian $J$ associated with the $(\\theta,\\phi)$ parameterization, and the reciprocal basis vectors restricted to the surface tangent plane that serve as tangential approximations to $\\nabla\\theta$ and $\\nabla\\phi$.\n\nImplement the algorithm in a single program that evaluates the following test suite. All angles must be in radians, all lengths in meters, and gradients in inverse meters. Each test case defines $(R(\\theta,\\phi),Z(\\theta,\\phi))$ and grid sizes $(N_\\theta,N_\\phi)$:\n\n- Test case $1$ (axisymmetric circular torus, happy path): $R(\\theta,\\phi) = R_0 + a\\cos\\theta$, $Z(\\theta,\\phi) = a\\sin\\theta$, with $R_0 = 3\\,\\mathrm{m}$, $a = 0.5\\,\\mathrm{m}$, $N_\\theta = 64$, $N_\\phi = 128$.\n- Test case $2$ (axisymmetric shaping with ellipticity and triangularity): $R(\\theta,\\phi) = R_0 + a\\cos(\\theta + \\delta\\sin\\theta)$, $Z(\\theta,\\phi) = \\kappa a\\sin\\theta$, with $R_0 = 3\\,\\mathrm{m}$, $a = 0.4\\,\\mathrm{m}$, $\\kappa = 1.7$, $\\delta = 0.3$, $N_\\theta = 96$, $N_\\phi = 96$.\n- Test case $3$ (weak three-dimensional ripple): $R(\\theta,\\phi) = R_0 + a\\cos\\theta + \\epsilon a\\cos(n\\phi)$, $Z(\\theta,\\phi) = a\\sin\\theta + \\epsilon_z a\\sin(n\\phi)\\sin\\theta$, with $R_0 = 3\\,\\mathrm{m}$, $a = 0.5\\,\\mathrm{m}$, $n = 3$, $\\epsilon = 0.05$, $\\epsilon_z = 0.03$, $N_\\theta = 64$, $N_\\phi = 96$.\n- Test case $4$ (coarse-grid axisymmetric edge case): $R(\\theta,\\phi) = R_0 + a\\cos\\theta$, $Z(\\theta,\\phi) = a\\sin\\theta$, with $R_0 = 2.5\\,\\mathrm{m}$, $a = 0.7\\,\\mathrm{m}$, $N_\\theta = 8$, $N_\\phi = 8$.\n\nFor each test case, compute and report the following quantities:\n- The mean surface Jacobian $\\overline{J}$ over the grid, in $\\mathrm{m}^2$.\n- The maximum absolute reciprocity residual $e_{\\mathrm{rec}}$ defined as the maximum over the grid of the set $\\{|\\nabla\\theta\\cdot\\mathbf{r}_\\theta - 1|,\\;|\\nabla\\theta\\cdot\\mathbf{r}_\\phi|,\\;|\\nabla\\phi\\cdot\\mathbf{r}_\\theta|,\\;|\\nabla\\phi\\cdot\\mathbf{r}_\\phi - 1|\\}$, dimensionless.\n- The maximum absolute relative deviation $e_{\\mathrm{det}}$ between $J$ and the square root of the determinant of the metric, evaluated over the grid as $e_{\\mathrm{det}} = \\max\\left|\\dfrac{J - \\sqrt{g_{\\theta\\theta}g_{\\phi\\phi} - g_{\\theta\\phi}^2}}{J}\\right|$, dimensionless.\n- The mean norm of the tangential gradient $\\overline{\\|\\nabla\\theta\\|}$ over the grid, in $\\mathrm{m}^{-1}$.\n- The mean norm of the tangential gradient $\\overline{\\|\\nabla\\phi\\|}$ over the grid, in $\\mathrm{m}^{-1}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain, in order, for test cases $1$ through $4$: $[\\overline{J}, e_{\\mathrm{rec}}, e_{\\mathrm{det}}, \\overline{\\|\\nabla\\theta\\|}, \\overline{\\|\\nabla\\phi\\|}]$ for each case appended sequentially into one flat list. For example, the output format must be like $[\\text{case1\\_}\\overline{J},\\text{case1\\_}e_{\\mathrm{rec}},\\ldots,\\text{case4\\_}\\overline{J},\\text{case4\\_}e_{\\mathrm{rec}},\\ldots]$.",
            "solution": "The problem requires the computation of key geometric quantities for a toroidal surface parameterized by angles $(\\theta, \\phi)$. The foundation of this analysis rests in differential geometry. We will first derive the continuous analytical expressions for the required quantities and then detail the numerical algorithm for their computation on a discrete grid.\n\nA point on the toroidal surface is specified by the position vector $\\mathbf{r}$ in a $3$-dimensional Cartesian coordinate system $(x,y,z)$. The parameterization is given in terms of cylindrical coordinates $(R, \\phi, Z)$, where $R$ and $Z$ are functions of the surface coordinates $(\\theta, \\phi)$.\n$$\n\\mathbf{r}(\\theta, \\phi) = x(\\theta, \\phi)\\hat{\\mathbf{i}} + y(\\theta, \\phi)\\hat{\\mathbf{j}} + z(\\theta, \\phi)\\hat{\\mathbf{k}}\n$$\nUsing the transformation from cylindrical to Cartesian coordinates, we have:\n$$\n\\mathbf{r}(\\theta, \\phi) = \\begin{pmatrix} R(\\theta, \\phi) \\cos\\phi \\\\ R(\\theta, \\phi) \\sin\\phi \\\\ Z(\\theta, \\phi) \\end{pmatrix}\n$$\n\nThe local geometry of the surface is described by the covariant basis vectors, which are tangent to the coordinate curves on the surface. They are defined as the partial derivatives of the position vector with respect to the surface coordinates:\n$$\n\\mathbf{r}_\\theta = \\frac{\\partial \\mathbf{r}}{\\partial \\theta} \\quad \\text{and} \\quad \\mathbf{r}_\\phi = \\frac{\\partial \\mathbf{r}}{\\partial \\phi}\n$$\nApplying the chain rule to the expression for $\\mathbf{r}(\\theta, \\phi)$:\n$$\n\\mathbf{r}_\\theta = \\begin{pmatrix} \\frac{\\partial R}{\\partial \\theta} \\cos\\phi \\\\ \\frac{\\partial R}{\\partial \\theta} \\sin\\phi \\\\ \\frac{\\partial Z}{\\partial \\theta} \\end{pmatrix}\n\\quad \\text{and} \\quad\n\\mathbf{r}_\\phi = \\begin{pmatrix} \\frac{\\partial R}{\\partial \\phi} \\cos\\phi - R \\sin\\phi \\\\ \\frac{\\partial R}{\\partial \\phi} \\sin\\phi + R \\cos\\phi \\\\ \\frac{\\partial Z}{\\partial \\phi} \\end{pmatrix}\n$$\nThese two vectors, $\\mathbf{r}_\\theta$ and $\\mathbf{r}_\\phi$, form a basis for the tangent plane at each point on the surface.\n\nThe first fundamental form, or metric tensor, describes the intrinsic geometry of the surface, including lengths and angles. The components of the covariant metric tensor, $g_{ij}$, are defined by the inner products of the covariant basis vectors. For the coordinate system $(\\theta, \\phi)$, which we can denote as $(u^1, u^2)$, the metric components are:\n$$\ng_{ij} = \\mathbf{r}_{u^i} \\cdot \\mathbf{r}_{u^j}\n$$\nSpecifically, for our coordinates:\n$$\ng_{\\theta\\theta} = \\mathbf{r}_\\theta \\cdot \\mathbf{r}_\\theta = \\left(\\frac{\\partial R}{\\partial \\theta}\\right)^2 + \\left(\\frac{\\partial Z}{\\partial \\theta}\\right)^2\n$$\n$$\ng_{\\phi\\phi} = \\mathbf{r}_\\phi \\cdot \\mathbf{r}_\\phi = \\left(\\frac{\\partial R}{\\partial \\phi}\\right)^2 + R^2 + \\left(\\frac{\\partial Z}{\\partial \\phi}\\right)^2\n$$\n$$\ng_{\\theta\\phi} = \\mathbf{r}_\\theta \\cdot \\mathbf{r}_\\phi = \\frac{\\partial R}{\\partial \\theta} \\frac{\\partial R}{\\partial \\phi} + \\frac{\\partial Z}{\\partial \\theta} \\frac{\\partial Z}{\\partial \\phi}\n$$\n\nThe surface area element $\\mathrm{d}S$ is related to the coordinate differentials $\\mathrm{d}\\theta$ and $\\mathrm{d}\\phi$ by the surface area Jacobian, $J$. The area of the parallelogram spanned by the vectors $\\mathbf{r}_\\theta \\mathrm{d}\\theta$ and $\\mathbf{r}_\\phi \\mathrm{d}\\phi$ is $\\|\\mathbf{r}_\\theta \\times \\mathbf{r}_\\phi\\| \\mathrm{d}\\theta \\mathrm{d}\\phi$. Thus, the Jacobian is:\n$$\nJ = \\|\\mathbf{r}_\\theta \\times \\mathbf{r}_\\phi\\|\n$$\nA fundamental identity of differential geometry, Lagrange's identity, relates the cross product magnitude to inner products: $\\|\\mathbf{a} \\times \\mathbf{b}\\|^2 = \\|\\mathbf{a}\\|^2 \\|\\mathbf{b}\\|^2 - (\\mathbf{a} \\cdot \\mathbf{b})^2$. Applying this to our basis vectors, we find:\n$$\nJ^2 = (\\mathbf{r}_\\theta \\cdot \\mathbf{r}_\\theta)(\\mathbf{r}_\\phi \\cdot \\mathbf{r}_\\phi) - (\\mathbf{r}_\\theta \\cdot \\mathbf{r}_\\phi)^2 = g_{\\theta\\theta}g_{\\phi\\phi} - g_{\\theta\\phi}^2 = \\det(g)\n$$\nThis gives $J = \\sqrt{\\det(g)}$, which serves as a crucial consistency check for our numerical implementation.\n\nThe gradients of the scalar coordinate functions, $\\nabla\\theta$ and $\\nabla\\phi$, are vector fields that are perpendicular to the level sets of $\\theta$ and $\\phi$, respectively. These vectors form the reciprocal, or contravariant, basis, denoted $\\mathbf{r}^\\theta$ and $\\mathbf{r}^\\phi$. They are defined by the duality relation with the covariant basis:\n$$\n\\mathbf{r}^i \\cdot \\mathbf{r}_j = \\delta^i_j \\quad \\text{for } i,j \\in \\{\\theta, \\phi\\}\n$$\nwhere $\\delta^i_j$ is the Kronecker delta. This definition leads to a system of linear equations for the components of $\\mathbf{r}^\\theta$ and $\\mathbf{r}^\\phi$. The solution is found using the inverse of the metric tensor, $g^{ij}$. The contravariant basis vectors are given by:\n$$\n\\mathbf{r}^i = \\sum_j g^{ij} \\mathbf{r}_j\n$$\nThe components of the inverse metric tensor are:\n$$\ng^{\\theta\\theta} = \\frac{g_{\\phi\\phi}}{\\det(g)} = \\frac{g_{\\phi\\phi}}{J^2}\n$$\n$$\ng^{\\phi\\phi} = \\frac{g_{\\theta\\theta}}{\\det(g)} = \\frac{g_{\\theta\\theta}}{J^2}\n$$\n$$\ng^{\\theta\\phi} = g^{\\phi\\theta} = -\\frac{g_{\\theta\\phi}}{\\det(g)} = -\\frac{g_{\\theta\\phi}}{J^2}\n$$\nSubstituting these into the expression for the contravariant basis vectors, we obtain the tangential gradients:\n$$\n\\nabla\\theta = \\mathbf{r}^\\theta = g^{\\theta\\theta}\\mathbf{r}_\\theta + g^{\\theta\\phi}\\mathbf{r}_\\phi = \\frac{1}{J^2} (g_{\\phi\\phi}\\mathbf{r}_\\theta - g_{\\theta\\phi}\\mathbf{r}_\\phi)\n$$\n$$\n\\nabla\\phi = \\mathbf{r}^\\phi = g^{\\phi\\theta}\\mathbf{r}_\\theta + g^{\\phi\\phi}\\mathbf{r}_\\phi = \\frac{1}{J^2} (-g_{\\theta\\phi}\\mathbf{r}_\\theta + g_{\\theta\\theta}\\mathbf{r}_\\phi)\n$$\nThese vectors lie in the tangent plane spanned by $\\{\\mathbf{r}_\\theta, \\mathbf{r}_\\phi\\}$.\n\nThe numerical algorithm proceeds as follows:\n$1$. **Grid Generation**: For grid sizes $N_\\theta$ and $N_\\phi$, define uniform, periodic grids for $\\theta$ and $\\phi$.\n    $$ \\theta_k = k \\Delta\\theta \\quad \\text{for } k \\in \\{0, 1, \\dots, N_\\theta-1\\}, \\text{ with } \\Delta\\theta = 2\\pi/N_\\theta $$\n    $$ \\phi_\\ell = \\ell \\Delta\\phi \\quad \\text{for } \\ell \\in \\{0, 1, \\dots, N_\\phi-1\\}, \\text{ with } \\Delta\\phi = 2\\pi/N_\\phi $$\n    Evaluate the functions $R(\\theta, \\phi)$ and $Z(\\theta, \\phi)$ for the specific test case on this 2D grid.\n\n$2$. **Numerical Differentiation**: Approximate the partial derivatives $\\partial_\\theta R$, $\\partial_\\phi R$, $\\partial_\\theta Z$, and $\\partial_\\phi Z$ using a second-order accurate central finite difference scheme with periodic boundary conditions. For a function $f$ on the grid, the derivative with respect to $\\theta$ at index $(k, \\ell)$ is:\n    $$ \\left(\\frac{\\partial f}{\\partial \\theta}\\right)_{k,\\ell} \\approx \\frac{f_{k+1,\\ell} - f_{k-1,\\ell}}{2\\Delta\\theta} $$\n    A similar expression applies for $\\partial_\\phi$. Indices are handled with periodic wrap-around.\n\n$3$. **Basis Vector Construction**: Using the computed discrete derivatives and grid values of $R$, construct the Cartesian components of the covariant basis vectors $\\mathbf{r}_\\theta$ and $\\mathbf{r}_\\phi$ at each grid point.\n\n$4$. **Metric and Jacobian Calculation**:\n    - Compute the metric tensor components $g_{\\theta\\theta}$, $g_{\\theta\\phi}$, and $g_{\\phi\\phi}$ by taking the dot products of the discrete basis vectors at each grid point.\n    - Compute the surface Jacobian $J$ by finding the magnitude of the cross product $\\mathbf{r}_\\theta \\times \\mathbf{r}_\\phi$ at each grid point.\n\n$5$. **Reciprocal Basis Calculation**: Using the previously computed metric components, Jacobian, and covariant basis vectors, calculate the Cartesian components of the tangential gradients $\\nabla\\theta$ and $\\nabla\\phi$ at each grid point using the derived formulas.\n\n$6$. **Evaluation of Test Metrics**:\n    - **Mean Jacobian $\\overline{J}$**: Compute the arithmetic mean of the Jacobian $J$ over all grid points.\n    - **Reciprocity Residual $e_{\\mathrm{rec}}$**: Compute the dot products $\\nabla\\theta \\cdot \\mathbf{r}_\\theta$, $\\nabla\\theta \\cdot \\mathbf{r}_\\phi$, etc., at each grid point. Find the maximum absolute deviation from the expected Kronecker delta values across the entire grid.\n    - **Determinant Residual $e_{\\mathrm{det}}$**: At each grid point, calculate $J_{\\mathrm{check}} = \\sqrt{g_{\\theta\\theta}g_{\\phi\\phi} - g_{\\theta\\phi}^2}$ and find the maximum absolute relative error $|(J - J_{\\mathrm{check}})/J|$ over the grid.\n    - **Mean Gradient Norms**: Compute the Euclidean norm of the vectors $\\nabla\\theta$ and $\\nabla\\phi$ at each point, then find their respective arithmetic means over the grid.\n\nThis procedure is applied to each test case defined in the problem statement. The results are then aggregated into a single flat list for the final output.",
            "answer": "```python\nimport numpy as np\n\ndef compute_geometric_quantities(surface_params):\n    \"\"\"\n    Computes geometric quantities for a toroidal surface.\n    \n    Args:\n        surface_params (dict): A dictionary containing the parameters for the surface.\n        It must include 'type', grid sizes 'Nt', 'Np', and shape parameters.\n\n    Returns:\n        tuple: A tuple containing the five required output metrics:\n               (J_bar, e_rec, e_det, mean_norm_grad_theta, mean_norm_grad_phi).\n    \"\"\"\n\n    # 1. Grid Generation\n    N_theta, N_phi = surface_params['Nt'], surface_params['Np']\n    delta_theta = 2.0 * np.pi / N_theta\n    delta_phi = 2.0 * np.pi / N_phi\n    \n    theta_1d = np.linspace(0, 2 * np.pi, N_theta, endpoint=False)\n    phi_1d = np.linspace(0, 2 * np.pi, N_phi, endpoint=False)\n    \n    THETA, PHI = np.meshgrid(theta_1d, phi_1d, indexing='ij')\n\n    # Evaluate R and Z on the grid based on the test case type\n    stype = surface_params['type']\n    if stype == 'circular':\n        R0, a = surface_params['R0'], surface_params['a']\n        R = R0 + a * np.cos(THETA)\n        Z = a * np.sin(THETA)\n    elif stype == 'shaped':\n        R0, a, kappa, delta = surface_params['R0'], surface_params['a'], surface_params['kappa'], surface_params['delta']\n        R = R0 + a * np.cos(THETA + delta * np.sin(THETA))\n        Z = kappa * a * np.sin(THETA)\n    elif stype == 'ripple':\n        R0, a, n, eps, eps_z = surface_params['R0'], surface_params['a'], surface_params['n'], surface_params['eps'], surface_params['eps_z']\n        R = R0 + a * np.cos(THETA) + eps * a * np.cos(n * PHI)\n        Z = a * np.sin(THETA) + eps_z * a * np.sin(n * PHI) * np.sin(THETA)\n    else:\n        raise ValueError(\"Unknown surface type\")\n\n    # 2. Numerical Differentiation (2nd order central difference with periodicity)\n    def central_diff(f, delta, axis):\n        return (np.roll(f, -1, axis=axis) - np.roll(f, 1, axis=axis)) / (2.0 * delta)\n\n    dR_dtheta = central_diff(R, delta_theta, axis=0)\n    dR_dphi = central_diff(R, delta_phi, axis=1)\n    dZ_dtheta = central_diff(Z, delta_theta, axis=0)\n    dZ_dphi = central_diff(Z, delta_phi, axis=1)\n\n    # 3. Covariant Basis Vector Construction\n    cos_phi = np.cos(PHI)\n    sin_phi = np.sin(PHI)\n    \n    r_theta = np.stack([\n        dR_dtheta * cos_phi,\n        dR_dtheta * sin_phi,\n        dZ_dtheta\n    ], axis=-1)\n\n    r_phi = np.stack([\n        dR_dphi * cos_phi - R * sin_phi,\n        dR_dphi * sin_phi + R * cos_phi,\n        dZ_dphi\n    ], axis=-1)\n\n    # 4. Metric and Jacobian Calculation\n    g_tt = np.sum(r_theta * r_theta, axis=-1)\n    g_tp = np.sum(r_theta * r_phi, axis=-1)\n    g_pp = np.sum(r_phi * r_phi, axis=-1)\n\n    j_vec = np.cross(r_theta, r_phi, axis=-1)\n    J_grid = np.linalg.norm(j_vec, axis=-1)\n\n    # 5. Reciprocal Basis Calculation\n    J2_inv = 1.0 / (J_grid**2)\n    \n    # Broadcasting for vector operations\n    g_pp_b = g_pp[..., np.newaxis]\n    g_tp_b = g_tp[..., np.newaxis]\n    g_tt_b = g_tt[..., np.newaxis]\n    J2_inv_b = J2_inv[..., np.newaxis]\n    \n    grad_theta = J2_inv_b * (g_pp_b * r_theta - g_tp_b * r_phi)\n    grad_phi = J2_inv_b * (-g_tp_b * r_theta + g_tt_b * r_phi)\n    \n    # 6. Evaluation of Test Metrics\n    # Mean Jacobian\n    J_bar = np.mean(J_grid)\n\n    # Reciprocity Residual\n    dot_tt = np.sum(grad_theta * r_theta, axis=-1)\n    dot_tp = np.sum(grad_theta * r_phi, axis=-1)\n    dot_pt = np.sum(grad_phi * r_theta, axis=-1)\n    dot_pp = np.sum(grad_phi * r_phi, axis=-1)\n    e_rec = np.max([\n        np.max(np.abs(dot_tt - 1.0)),\n        np.max(np.abs(dot_tp)),\n        np.max(np.abs(dot_pt)),\n        np.max(np.abs(dot_pp - 1.0)),\n    ])\n\n    # Determinant Residual\n    det_g = g_tt * g_pp - g_tp**2\n    sqrt_det_g = np.sqrt(det_g)\n    e_det = np.max(np.abs((J_grid - sqrt_det_g) / J_grid))\n\n    # Mean Gradient Norms\n    mean_norm_grad_theta = np.mean(np.linalg.norm(grad_theta, axis=-1))\n    mean_norm_grad_phi = np.mean(np.linalg.norm(grad_phi, axis=-1))\n    \n    return J_bar, e_rec, e_det, mean_norm_grad_theta, mean_norm_grad_phi\n\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'type': 'circular', 'R0': 3.0, 'a': 0.5, 'Nt': 64, 'Np': 128},\n        {'type': 'shaped', 'R0': 3.0, 'a': 0.4, 'kappa': 1.7, 'delta': 0.3, 'Nt': 96, 'Np': 96},\n        {'type': 'ripple', 'R0': 3.0, 'a': 0.5, 'n': 3, 'eps': 0.05, 'eps_z': 0.03, 'Nt': 64, 'Np': 96},\n        {'type': 'circular', 'R0': 2.5, 'a': 0.7, 'Nt': 8, 'Np': 8},\n    ]\n\n    results = []\n    for case in test_cases:\n        case_results = compute_geometric_quantities(case)\n        results.extend(case_results)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}