{
    "hands_on_practices": [
        {
            "introduction": "The value of the safety factor at the very center of the plasma, the magnetic axis, is a critical parameter that dictates core plasma stability. This on-axis safety factor, denoted as $q_0$, plays a pivotal role in determining the onset of certain magnetohydrodynamic (MHD) instabilities. This first practice guides you through a fundamental derivation to reveal the direct and sensitive relationship between $q_0$ and the on-axis toroidal current density, $j_{\\phi}(0)$, providing a clear link between the plasma current and the magnetic topology at its heart .",
            "id": "4042281",
            "problem": "Consider an axisymmetric, large-aspect-ratio tokamak plasma with major radius $R_{0}$ and minor radial coordinate $r$ measured from the magnetic axis. The toroidal magnetic field $B_{\\phi}(r)$ is approximately constant near the axis and equal to its on-axis value $B_{\\phi 0}$. The poloidal magnetic field $B_{\\theta}(r)$ is generated by the toroidal plasma current density $j_{\\phi}(r)$ and obeys magnetostatic Maxwell–Ampère’s law, relating the enclosed current $I_{\\mathrm{enc}}(r)$ to the field circulation around a circle of radius $r$. The safety factor $q(r)$ is defined geometrically as the ratio of toroidal to poloidal field-line pitch for nested flux surfaces in the large-aspect-ratio limit. \n\nStarting from fundamental definitions and laws (Maxwell–Ampère’s law and the geometric definition of the safety factor), derive the leading-order asymptotic form of $q(r)$ as $r \\to 0$, and explicitly show that the central safety factor $q_{0} \\equiv \\lim_{r \\to 0} q(r)$ depends sensitively on the on-axis current density $j_{\\phi}(0)$. Your derivation must be based on a Taylor expansion of $j_{\\phi}(r)$ about $r=0$ consistent with axisymmetry.\n\nThen, for the specific current-density profile\n$$\nj_{\\phi}(r) = j_{0}\\,\\exp\\!\\left(-\\frac{r^{2}}{\\lambda^{2}}\\right),\n$$\nwith parameters $j_{0} = 1.10 \\times 10^{6}\\,\\mathrm{A/m^{2}}$, $\\lambda = 0.40\\,\\mathrm{m}$, major radius $R_{0} = 2.80\\,\\mathrm{m}$, and on-axis toroidal field $B_{\\phi 0} = 3.20\\,\\mathrm{T}$, compute the numerical value of $q_{0}$ using the permeability of free space $\\mu_{0} = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$. \n\nRound your final numerical result to four significant figures. Report $q_{0}$ as a dimensionless quantity (no units).",
            "solution": "The problem statement has been validated and is deemed sound. It is scientifically grounded, well-posed, objective, and contains all necessary information for a unique solution. We may therefore proceed with the derivation and calculation.\n\nThe task is to first derive the general form of the central safety factor $q_0$ and then to compute its value for a specific current profile.\n\nThe safety factor $q(r)$ in an axisymmetric, large-aspect-ratio tokamak with circular, nested magnetic flux surfaces is defined geometrically as the pitch of the magnetic field lines. It represents the number of toroidal transits a field line makes for each poloidal transit. In the limit of large aspect ratio ($R_0 \\gg r$), this definition simplifies to:\n$$\nq(r) \\approx \\frac{r B_{\\phi}(r)}{R_0 B_{\\theta}(r)}\n$$\nwhere $r$ is the minor radius, $R_0$ is the major radius, $B_{\\phi}(r)$ is the toroidal magnetic field, and $B_{\\theta}(r)$ is the poloidal magnetic field. The problem specifies that near the magnetic axis ($r \\to 0$), the toroidal field is approximately constant, $B_{\\phi}(r) \\approx B_{\\phi 0}$. Thus, the expression becomes:\n$$\nq(r) \\approx \\frac{r B_{\\phi 0}}{R_0 B_{\\theta}(r)}\n$$\n\nThe poloidal magnetic field $B_{\\theta}(r)$ is generated by the toroidal plasma current density $j_{\\phi}(r)$. Their relationship is given by the integral form of Maxwell–Ampère’s law, $\\oint \\vec{B} \\cdot d\\vec{l} = \\mu_0 I_{\\mathrm{enc}}$. Applying this law to a circular loop of radius $r$ centered on the magnetic axis, we have:\n$$\nB_{\\theta}(r) \\cdot (2\\pi r) = \\mu_0 I_{\\mathrm{enc}}(r)\n$$\nwhere $I_{\\mathrm{enc}}(r)$ is the total toroidal current enclosed within the radius $r$. This gives:\n$$\nB_{\\theta}(r) = \\frac{\\mu_0 I_{\\mathrm{enc}}(r)}{2\\pi r}\n$$\nThe enclosed current is obtained by integrating the current density $j_{\\phi}(r')$ over the circular cross-section of radius $r$:\n$$\nI_{\\mathrm{enc}}(r) = \\int_{0}^{r} j_{\\phi}(r') (2\\pi r') dr'\n$$\n\nTo determine the behavior as $r \\to 0$, we perform a Taylor expansion of the current density $j_{\\phi}(r)$ around the magnetic axis at $r=0$. Due to axisymmetry, any physical scalar quantity like $j_{\\phi}$ must be an even function of $r$ for it to be smooth across the axis (i.e., its first derivative must vanish at $r=0$). Therefore, the Taylor series expansion of $j_{\\phi}(r)$ about $r=0$ contains only even powers of $r$:\n$$\nj_{\\phi}(r) = j_{\\phi}(0) + \\frac{1}{2!} \\frac{d^2 j_{\\phi}}{dr^2}\\bigg|_{r=0} r^2 + \\mathcal{O}(r^4)\n$$\nFor small $r$, the leading-order term is sufficient. Let $j_{\\phi 0} \\equiv j_{\\phi}(0)$ be the on-axis current density. Then, $j_{\\phi}(r) \\approx j_{\\phi 0}$.\n\nWe now calculate the enclosed current $I_{\\mathrm{enc}}(r)$ for small $r$ using this approximation:\n$$\nI_{\\mathrm{enc}}(r) = \\int_{0}^{r} (j_{\\phi 0} + \\mathcal{O}(r'^2)) (2\\pi r') dr' = 2\\pi j_{\\phi 0} \\int_{0}^{r} r' dr' + \\mathcal{O}(r^4)\n$$\n$$\nI_{\\mathrm{enc}}(r) = 2\\pi j_{\\phi 0} \\left[\\frac{r'^2}{2}\\right]_{0}^{r} + \\mathcal{O}(r^4) = \\pi j_{\\phi 0} r^2 + \\mathcal{O}(r^4)\n$$\nSubstituting this result into the expression for the poloidal field $B_{\\theta}(r)$:\n$$\nB_{\\theta}(r) = \\frac{\\mu_0 (\\pi j_{\\phi 0} r^2 + \\mathcal{O}(r^4))}{2\\pi r} = \\frac{\\mu_0 j_{\\phi 0}}{2} r + \\mathcal{O}(r^3)\n$$\nThis shows that for small $r$, the poloidal magnetic field grows linearly from zero on the axis.\n\nNow we can determine the asymptotic form of $q(r)$ as $r \\to 0$:\n$$\nq(r) \\approx \\frac{r B_{\\phi 0}}{R_0 \\left(\\frac{\\mu_0 j_{\\phi 0}}{2} r + \\mathcal{O}(r^3)\\right)} = \\frac{B_{\\phi 0}}{R_0 \\left(\\frac{\\mu_0 j_{\\phi 0}}{2} + \\mathcal{O}(r^2)\\right)}\n$$\nThe central safety factor, $q_0$, is the limit of $q(r)$ as $r \\to 0$:\n$$\nq_0 \\equiv \\lim_{r \\to 0} q(r) = \\frac{B_{\\phi 0}}{R_0 \\left(\\frac{\\mu_0 j_{\\phi 0}}{2}\\right)} = \\frac{2 B_{\\phi 0}}{R_0 \\mu_0 j_{\\phi 0}}\n$$\nThis derived expression explicitly shows that the central safety factor $q_0$ is inversely proportional to, and thus depends sensitively on, the on-axis current density $j_{\\phi}(0) \\equiv j_{\\phi 0}$.\n\nNext, we compute the numerical value of $q_0$ for the specific current-density profile:\n$$\nj_{\\phi}(r) = j_{0}\\,\\exp\\!\\left(-\\frac{r^{2}}{\\lambda^{2}}\\right)\n$$\nThe on-axis current density $j_{\\phi 0}$ is found by evaluating $j_{\\phi}(r)$ at $r=0$:\n$$\nj_{\\phi 0} = j_{\\phi}(0) = j_{0}\\,\\exp(0) = j_{0}\n$$\nThe given parameters are:\n$j_{0} = 1.10 \\times 10^{6}\\,\\mathrm{A/m^{2}}$\n$R_{0} = 2.80\\,\\mathrm{m}$\n$B_{\\phi 0} = 3.20\\,\\mathrm{T}$\n$\\mu_{0} = 4\\pi \\times 10^{-7}\\,\\mathrm{H/m}$\n\nSubstituting these values into the derived formula for $q_0$:\n$$\nq_0 = \\frac{2 B_{\\phi 0}}{R_0 \\mu_0 j_{0}} = \\frac{2 \\times (3.20)}{(2.80) \\times (4\\pi \\times 10^{-7}) \\times (1.10 \\times 10^{6})}\n$$\n$$\nq_0 = \\frac{6.40}{2.80 \\times 1.10 \\times 4\\pi \\times 10^{-1}} = \\frac{64.0}{3.08 \\times 4\\pi} = \\frac{16}{3.08 \\pi}\n$$\n$$\nq_0 \\approx \\frac{16}{3.08 \\times 3.14159265...} \\approx \\frac{16}{9.676105...} \\approx 1.653560...\n$$\nRounding the result to four significant figures, as requested, we obtain:\n$$\nq_0 \\approx 1.654\n$$\nIt is worth noting that the parameter $\\lambda$ defines the width of the current profile but does not influence the central safety factor $q_0$, which depends only on the local, on-axis value of the current density.",
            "answer": "$$\n\\boxed{1.654}\n$$"
        },
        {
            "introduction": "While the on-axis safety factor is a crucial starting point, the stability and confinement properties of a tokamak are governed by the full radial profile of the safety factor, $q(r)$, and its spatial derivative, the magnetic shear, $\\hat{s}(r)$. This exercise builds upon the core concepts by tasking you with deriving the complete analytical expressions for both $q(r)$ and $\\hat{s}(r)$ from a prescribed, physically realistic plasma current distribution . Completing this derivation will solidify your understanding of how the distribution of current throughout the plasma volume sculpts the entire magnetic field structure.",
            "id": "4042289",
            "problem": "Consider a large–aspect–ratio, axisymmetric tokamak with circular, concentric flux surfaces of minor radius $r \\in [0,a]$ and major radius $R_{0}$. Use cylindrical coordinates $(R,\\phi,Z)$ and the standard poloidal angle $\\theta$ on each circular cross section. Let the magnetic configuration be described by a scalar poloidal flux function $\\psi(r)$ that labels flux surfaces and a toroidal field function $F(\\psi)$, and adopt the axisymmetric representation in which the covariant toroidal and poloidal components satisfy $B_{\\phi} = F(\\psi)/R$ and $B_{\\theta} = \\frac{1}{R}\\frac{\\partial \\psi}{\\partial r}$ in circular geometry. Assume the large–aspect–ratio approximation so that $R$ can be taken as $R_{0}$ to leading order on each flux surface. The toroidal field function is taken to be $F(\\psi) = B_{0} R_{0}$, where $B_{0}$ is the reference toroidal magnetic field at $R=R_{0}$.\n\nSuppose the toroidal plasma current density (flowing in the $\\phi$-direction) has the profile $j_{\\phi}(r) = j_{0}\\left(1 - \\frac{r^{2}}{a^{2}}\\right)$ for $0 \\le r \\le a$, with $j_{0}  0$ constant. Treating the plasma column locally as a straight cylinder in the large–aspect–ratio limit, use the Magnetostatic Ampère’s law $\\oint \\mathbf{B}\\cdot d\\boldsymbol{\\ell} = \\mu_{0} I_{\\mathrm{enc}}$ to relate the poloidal field $B_{\\theta}(r)$ to the enclosed toroidal current $I_{\\mathrm{enc}}(r) = 2\\pi \\int_{0}^{r} j_{\\phi}(r')\\, r'\\, dr'$.\n\nStarting from the fundamental definitions of the safety factor $q$ as the ratio of toroidal to poloidal field-line advance,\n$$\nq(\\psi) = \\frac{1}{2\\pi} \\oint \\frac{\\mathbf{B}\\cdot \\nabla \\phi}{\\mathbf{B}\\cdot \\nabla \\theta}\\, d\\theta,\n$$\nand the normalized magnetic shear $\\hat{s}(r) = \\frac{r}{q(r)}\\frac{dq}{dr}$, carry out the derivation to obtain closed-form analytic expressions for $q(r)$ and $\\hat{s}(r)$ for $0 \\le r \\le a$, expressed in terms of $B_{0}$, $R_{0}$, $\\mu_{0}$, $j_{0}$, $a$, and $r$.\n\nYour final answer must be given as analytic expressions. No numerical evaluation is required. Do not include any physical units in your final expressions. Angles, if they appear, must be in radians.",
            "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in the principles of magnetohydrostatics as applied to tokamak physics, is well-posed with sufficient information for a unique solution, and is expressed in objective, formal language. The model described is a standard large–aspect–ratio, circular tokamak, which is a common and appropriate idealization in plasma physics. The task is a standard derivation of fundamental plasma equilibrium quantities.\n\nThe derivation proceeds in three main parts: first, determining the poloidal magnetic field from the given current density profile using Ampère's law; second, calculating the safety factor $q(r)$; and third, calculating the normalized magnetic shear $\\hat{s}(r)$.\n\nFirst, we find the poloidal magnetic field $B_{\\theta}(r)$. We use the integral form of Ampère's law, $\\oint \\mathbf{B}\\cdot d\\boldsymbol{\\ell} = \\mu_{0} I_{\\mathrm{enc}}$, treating the plasma locally as a straight cylinder. The Amperian loop is a circle of radius $r$ in the poloidal cross-section. The magnetic field component tangent to this loop is the poloidal field, $B_{\\theta}(r)$. Due to axisymmetry, $B_{\\theta}$ is constant on this loop. The left-hand side of Ampère's law is then:\n$$\n\\oint \\mathbf{B}\\cdot d\\boldsymbol{\\ell} = B_{\\theta}(r) \\oint dl = B_{\\theta}(r) (2\\pi r)\n$$\nThe right-hand side requires computing the total toroidal current $I_{\\mathrm{enc}}(r)$ enclosed by the loop. The current density is given as $j_{\\phi}(r) = j_{0}\\left(1 - \\frac{r^{2}}{a^{2}}\\right)$. The enclosed current is found by integrating this density over the circular area of radius $r$:\n$$\nI_{\\mathrm{enc}}(r) = \\int_{0}^{r} j_{\\phi}(r') (2\\pi r' dr') = 2\\pi j_{0} \\int_{0}^{r} \\left(1 - \\frac{r'^{2}}{a^{2}}\\right) r' dr'\n$$\nPerforming the integration:\n$$\nI_{\\mathrm{enc}}(r) = 2\\pi j_{0} \\left[ \\frac{r'^{2}}{2} - \\frac{r'^{4}}{4a^{2}} \\right]_{0}^{r} = 2\\pi j_{0} \\left( \\frac{r^{2}}{2} - \\frac{r^{4}}{4a^{2}} \\right) = \\pi j_{0} r^{2} \\left( 1 - \\frac{r^{2}}{2a^{2}} \\right)\n$$\nEquating the two sides of Ampère's law, $B_{\\theta}(r) (2\\pi r) = \\mu_{0} I_{\\mathrm{enc}}(r)$:\n$$\nB_{\\theta}(r) (2\\pi r) = \\mu_{0} \\left[ \\pi j_{0} r^{2} \\left( 1 - \\frac{r^{2}}{2a^{2}} \\right) \\right]\n$$\nSolving for $B_{\\theta}(r)$ for $r \\in [0,a]$:\n$$\nB_{\\theta}(r) = \\frac{\\mu_{0} j_{0} r}{2} \\left( 1 - \\frac{r^{2}}{2a^{2}} \\right)\n$$\nNext, we derive the safety factor $q(r)$. The definition is $q(\\psi) = \\frac{1}{2\\pi} \\oint \\frac{\\mathbf{B}\\cdot \\nabla \\phi}{\\mathbf{B}\\cdot \\nabla \\theta}\\, d\\theta$. In the specified geometry, the relevant gradients are $\\nabla\\phi = \\frac{1}{R}\\hat{\\boldsymbol{\\phi}}$ and $\\nabla\\theta = \\frac{1}{r}\\hat{\\boldsymbol{\\theta}}$. The magnetic field is $\\mathbf{B} = B_{\\phi}\\hat{\\boldsymbol{\\phi}} + B_{\\theta}\\hat{\\boldsymbol{\\theta}}$. The dot products are $\\mathbf{B}\\cdot \\nabla \\phi = \\frac{B_{\\phi}}{R}$ and $\\mathbf{B}\\cdot \\nabla \\theta = \\frac{B_{\\theta}}{r}$.\nSubstituting these into the definition of $q$:\n$$\nq(r) = \\frac{1}{2\\pi} \\oint \\frac{B_{\\phi}/R}{B_{\\theta}/r} d\\theta = \\frac{1}{2\\pi} \\oint \\frac{r B_{\\phi}}{R B_{\\theta}} d\\theta\n$$\nWe now apply the large–aspect–ratio approximation, where $R \\approx R_{0}$ and the fields $B_{\\phi}$ and $B_{\\theta}$ are treated as functions of $r$ only. The toroidal field is given by $F(\\psi) = B_{0}R_{0}$, so $B_{\\phi} = F/R \\approx F/R_{0} = (B_{0}R_{0})/R_{0} = B_{0}$. The integrand becomes constant with respect to $\\theta$:\n$$\nq(r) \\approx \\frac{1}{2\\pi} \\left( \\frac{r B_{0}}{R_{0} B_{\\theta}(r)} \\right) \\oint d\\theta = \\frac{r B_{0}}{R_{0} B_{\\theta}(r)}\n$$\nNow, substitute the expression for $B_{\\theta}(r)$ we derived:\n$$\nq(r) = \\frac{r B_{0}}{R_{0} \\left[ \\frac{\\mu_{0} j_{0} r}{2} \\left( 1 - \\frac{r^{2}}{2a^{2}} \\right) \\right]} = \\frac{2 B_{0}}{\\mu_{0} j_{0} R_{0}} \\frac{1}{1 - \\frac{r^{2}}{2a^{2}}}\n$$\nThis expression can be algebraically simplified to:\n$$\nq(r) = \\frac{2 B_{0}}{\\mu_{0} j_{0} R_{0}} \\frac{2a^{2}}{2a^{2} - r^{2}} = \\frac{4 a^{2} B_{0}}{\\mu_{0} j_{0} R_{0} (2a^{2} - r^{2})}\n$$\nFinally, we calculate the normalized magnetic shear, $\\hat{s}(r) = \\frac{r}{q(r)}\\frac{dq}{dr}$. We first compute the derivative $\\frac{dq}{dr}$:\nLet $C = \\frac{4 a^{2} B_{0}}{\\mu_{0} j_{0} R_{0}}$. Then $q(r) = C (2a^{2} - r^{2})^{-1}$.\n$$\n\\frac{dq}{dr} = C \\frac{d}{dr}(2a^{2} - r^{2})^{-1} = C \\left[ -1 \\cdot (2a^{2} - r^{2})^{-2} \\cdot (-2r) \\right] = \\frac{2Cr}{(2a^{2} - r^{2})^{2}}\n$$\nNow we construct $\\hat{s}(r)$:\n$$\n\\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr} = \\frac{r}{C (2a^{2} - r^{2})^{-1}} \\frac{2Cr}{(2a^{2} - r^{2})^{2}}\n$$\nThe constant $C$ cancels out:\n$$\n\\hat{s}(r) = r(2a^{2} - r^{2}) \\frac{2r}{(2a^{2} - r^{2})^{2}} = \\frac{2r^{2}}{2a^{2} - r^{2}}\n$$\nThus, we have the closed-form analytic expressions for both the safety factor $q(r)$ and the normalized magnetic shear $\\hat{s}(r)$.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{4 a^{2} B_{0}}{\\mu_{0} j_{0} R_{0} (2a^{2} - r^{2})}  \\frac{2r^{2}}{2a^{2} - r^{2}}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "In modern, high-performance fusion experiments, the plasma current is not solely driven by external means; a significant fraction can be self-generated by the plasma's own pressure gradient, a phenomenon known as the bootstrap current. This practice moves from analytical derivations to a more realistic computational model, exploring this crucial coupling between plasma kinetics and magnetic equilibrium . By implementing a program to study how different pressure profiles alter the safety factor and magnetic shear, you will gain hands-on experience with the feedback mechanisms that are essential for designing and controlling advanced tokamak scenarios.",
            "id": "4042232",
            "problem": "Consider an axisymmetric, large-aspect-ratio tokamak with circular cross-section, major radius $R_0$, minor radius $a$, and a uniform toroidal magnetic field $B_\\phi$. Use the magnetohydrodynamics (MHD) equilibrium assumption and axisymmetry to construct a computational model for the safety factor $q(r)$ and magnetic shear $\\hat{s}(r)$ profiles under different pressure profiles $p(r)$, while holding the total toroidal plasma current $I_p$ fixed.\n\nStart from the following base definitions and laws:\n- The safety factor is defined as $q(r) = \\dfrac{r B_\\phi}{R_0 B_\\theta(r)}$ in the large-aspect-ratio limit, where $B_\\theta(r)$ is the poloidal magnetic field magnitude.\n- Magnetostatics (Ampère's law) for axisymmetry implies $B_\\theta(r) = \\dfrac{\\mu_0 I_{\\mathrm{enc}}(r)}{2\\pi r}$, where $I_{\\mathrm{enc}}(r) = \\int_0^{r} j_\\phi(r') 2\\pi r' \\, dr'$ is the toroidal current enclosed within radius $r$, and $j_\\phi(r)$ is the toroidal current density.\n- The magnetic shear is defined as $\\hat{s}(r) = \\dfrac{r}{q(r)} \\dfrac{dq}{dr}$.\n- To model the neoclassical bootstrap current in a simplified but physically plausible manner, assume $j_{\\mathrm{bs}}(r) = - \\kappa_{\\mathrm{bs}} \\dfrac{R_0}{B_\\phi} \\dfrac{dp}{dr}(r)$, where $\\kappa_{\\mathrm{bs}}$ is a constant coefficient that captures collisionality and geometric factors. This linear relation is a standard approximation for low-collisionality regimes and provides a well-tested qualitative sensitivity of $q(r)$ to pressure gradients.\n\nDefine the total toroidal current density $j_\\phi(r)$ as the sum of an ohmic component and the bootstrap component,\n$$\nj_\\phi(r) = j_{\\mathrm{ohm}}(r) + j_{\\mathrm{bs}}(r),\n$$\nwhere the ohmic shape function is prescribed as $j_{\\mathrm{ohm}}(r) = J_0 \\left[1 - \\left(\\dfrac{r}{a}\\right)^2 \\right]^\\gamma$ with fixed shape exponent $\\gamma  0$, and the amplitude $J_0$ is chosen to hold the total current fixed,\n$$\nI_p = \\int_0^a j_\\phi(r) 2\\pi r \\, dr.\n$$\nThe amplitude $J_0$ must be solved from the above constraint for each pressure profile.\n\nYou must implement a program that:\n1. Constructs $j_\\phi(r)$ from $j_{\\mathrm{ohm}}(r)$ and $j_{\\mathrm{bs}}(r)$ for each test case, solving for $J_0$ to enforce the fixed $I_p$.\n2. Computes $I_{\\mathrm{enc}}(r)$, $B_\\theta(r)$, $q(r)$, and $\\hat{s}(r)$ on a uniform radial grid from $r=0$ to $r=a$.\n3. Evaluates the sensitivity of $q(r)$ to pressure peaking by comparing $q(r)$ for peaked versus flat $p(r)$ profiles. Use the flat case as a reference and quantify the sensitivity as the root-mean-square relative deviation over selected radii.\n4. Reports the change in magnetic shear at a specified radius between peaked and flat pressure profiles.\n\nPhysical and numerical parameters to use:\n- Permeability of free space: $\\mu_0 = 4\\pi \\times 10^{-7} \\, \\mathrm{H/m}$.\n- Major radius: $R_0 = 3.0 \\, \\mathrm{m}$.\n- Minor radius: $a = 0.5 \\, \\mathrm{m}$.\n- Toroidal magnetic field: $B_\\phi = 5.0 \\, \\mathrm{T}$.\n- Fixed total plasma current: $I_p = 1.5 \\times 10^6 \\, \\mathrm{A}$.\n- Ohmic shape exponent: $\\gamma = 1$.\n- Bootstrap coefficient: $\\kappa_{\\mathrm{bs}} = 0.1 \\, \\mathrm{A \\cdot m^{-2} \\cdot T \\cdot Pa^{-1}}$.\n- Pressure scale: $p_0 = 5.0 \\times 10^4 \\, \\mathrm{Pa}$.\n\nPressure profile family and test suite:\n- Use $p(r) = p_0 \\left(1 - \\left(\\dfrac{r}{a}\\right)^2 \\right)^m$, with derivative\n$$\n\\dfrac{dp}{dr}(r) = - \\dfrac{2 p_0 m}{a^2} \\, r \\left(1 - \\left(\\dfrac{r}{a}\\right)^2 \\right)^{m-1}.\n$$\n- Test suite exponents: $m \\in \\{0, 2, 4\\}$, where $m=0$ is the flat case (then $\\dfrac{dp}{dr} = 0$ identically), $m=2$ is moderately peaked, and $m=4$ is strongly peaked.\n\nSensitivity metrics to compute:\n- Let the reference safety factor for the flat case be $q_{\\mathrm{flat}}(r)$.\n- For the peaked cases $m=2$ and $m=4$, compute the root-mean-square relative deviation over the sample radii $r_s \\in \\{0.3 a, 0.6 a, 0.9 a\\}$:\n$$\nS(m) = \\sqrt{\\dfrac{1}{3} \\sum_{r_s} \\left( \\dfrac{q_m(r_s) - q_{\\mathrm{flat}}(r_s)}{q_{\\mathrm{flat}}(r_s)} \\right)^2 }.\n$$\n- Compute the change in magnetic shear at $r = 0.6 a$,\n$$\n\\Delta \\hat{s}(m) = \\hat{s}_m(0.6 a) - \\hat{s}_{\\mathrm{flat}}(0.6 a).\n$$\n\nUnits and output requirements:\n- Use the specified physical units throughout. The safety factor $q(r)$ and magnetic shear $\\hat{s}(r)$ are dimensionless.\n- Angles do not appear; no angle units are required.\n- Express sensitivity metrics as decimal floats (not percentages).\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[S(2), S(4), \\Delta \\hat{s}(2), \\Delta \\hat{s}(4)]$.\n\nDesign constraints:\n- Derive all computation steps from the base laws and definitions stated above without using any shortcut formulas for the target quantities.\n- Ensure scientific realism of parameter magnitudes.\n- Implement numerical integration and differentiation in a stable manner on a sufficiently fine radial grid, avoiding division by zero at $r=0$ by evaluating only at $r0$ sample points.",
            "solution": "The problem statement has been validated and is deemed a well-posed, scientifically sound, and complete exercise in computational plasma physics. It is grounded in the standard magnetohydrodynamic (MHD) equilibrium model for a large-aspect-ratio, circular tokamak and uses physically realistic parameters and functional forms. The task is to construct a computational model to solve for the safety factor $q(r)$ and magnetic shear $\\hat{s}(r)$ profiles and to quantify their sensitivity to the plasma pressure profile $p(r)$.\n\nThe solution proceeds by first establishing the analytical framework for determining the plasma current density profile, followed by a description of the numerical algorithm to compute the desired quantities.\n\nThe total toroidal current density $j_\\phi(r)$ is the sum of an ohmic component $j_{\\mathrm{ohm}}(r)$ and a neoclassical bootstrap component $j_{\\mathrm{bs}}(r)$:\n$$\nj_\\phi(r) = j_{\\mathrm{ohm}}(r) + j_{\\mathrm{bs}}(r)\n$$\nThe ohmic component is given a prescribed shape $j_{\\mathrm{ohm}}(r) = J_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2 \\right]^\\gamma$, where the amplitude $J_0$ is unknown. The bootstrap component is determined by the pressure gradient: $j_{\\mathrm{bs}}(r) = - \\kappa_{\\mathrm{bs}} \\frac{R_0}{B_\\phi} \\frac{dp}{dr}(r)$. The pressure profile is given by $p(r) = p_0 (1 - (r/a)^2)^m$ for different exponents $m \\in \\{0, 2, 4\\}$.\n\nA key constraint is that the total plasma current $I_p$ is held fixed at a specified value. This constraint allows us to determine the unknown amplitude $J_0$. The total current is the integral of the current density over the plasma cross-section:\n$$\nI_p = \\int_0^a j_\\phi(r) \\, 2\\pi r \\, dr = \\int_0^a \\left(j_{\\mathrm{ohm}}(r) + j_{\\mathrm{bs}}(r)\\right) 2\\pi r \\, dr\n$$\nThis can be separated into the total ohmic current, $I_{\\mathrm{ohm}}$, and the total bootstrap current, $I_{\\mathrm{bs}}$:\n$$\nI_p = I_{\\mathrm{ohm}} + I_{\\mathrm{bs}}\n$$\nThe total ohmic current can be computed analytically. For the given shape function with exponent $\\gamma$:\n$$\nI_{\\mathrm{ohm}} = \\int_0^a J_0 \\left[1 - \\left(\\frac{r}{a}\\right)^2 \\right]^\\gamma 2\\pi r \\, dr = J_0 \\frac{\\pi a^2}{\\gamma+1}\n$$\nFor the specified value $\\gamma=1$, this simplifies to $I_{\\mathrm{ohm}} = J_0 \\frac{\\pi a^2}{2}$. The total bootstrap current, $I_{\\mathrm{bs}} = \\int_0^a j_{\\mathrm{bs}}(r) \\, 2\\pi r \\, dr$, depends on the pressure profile (via $m$) and will be computed numerically for each case.\n\nWith $I_{\\mathrm{bs}}$ known for a given $m$, we can solve for $J_0$:\n$$\nJ_0 \\frac{\\pi a^2}{\\gamma+1} = I_p - I_{\\mathrm{bs}} \\implies J_0 = \\frac{\\gamma+1}{\\pi a^2} (I_p - I_{\\mathrm{bs}})\n$$\nFor $\\gamma=1$, $J_0 = \\frac{2}{\\pi a^2} (I_p - I_{\\mathrm{bs}})$. This procedure uniquely determines the total current density profile $j_\\phi(r)$ for each pressure exponent $m$.\n\nOnce $j_\\phi(r)$ is known, the remaining quantities are computed sequentially based on the provided definitions:\n\n1.  **Enclosed Current $I_{\\mathrm{enc}}(r)$**: This is the integral of the current density from the magnetic axis out to radius $r$.\n    $$\n    I_{\\mathrm{enc}}(r) = \\int_0^r j_\\phi(r') \\, 2\\pi r' \\, dr'\n    $$\n    This will be computed numerically using a cumulative integration method.\n\n2.  **Poloidal Magnetic Field $B_\\theta(r)$**: From Ampère's law for an axisymmetric system.\n    $$\n    B_\\theta(r) = \\frac{\\mu_0 I_{\\mathrm{enc}}(r)}{2\\pi r}\n    $$\n    At $r=0$, $I_{\\mathrm{enc}}(r) \\approx j_\\phi(0) \\pi r^2$, leading to $B_\\theta(r) \\approx \\frac{\\mu_0 j_\\phi(0)}{2} r$, so $B_\\theta(0)=0$.\n\n3.  **Safety Factor $q(r)$**: Defined for a large-aspect-ratio circular tokamak as:\n    $$\n    q(r) = \\frac{r B_\\phi}{R_0 B_\\theta(r)}\n    $$\n    The limit at $r=0$ is well-defined and can be found by substituting the limiting forms of $B_\\theta(r)$ and $r$:\n    $$\n    q(0) = \\lim_{r\\to 0} \\frac{r B_\\phi}{R_0 \\left(\\frac{\\mu_0 j_\\phi(0)}{2} r\\right)} = \\frac{2 B_\\phi}{R_0 \\mu_0 j_\\phi(0)}\n    $$\n    Since $j_{\\mathrm{bs}}(0)=0$ for all $m \\ge 1$, we have $j_\\phi(0) = J_0$.\n\n4.  **Magnetic Shear $\\hat{s}(r)$**: This is the normalized logarithmic derivative of the safety factor.\n    $$\n    \\hat{s}(r) = \\frac{r}{q(r)} \\frac{dq}{dr}\n    $$\n    The derivative $\\frac{dq}{dr}$ will be computed numerically from the calculated $q(r)$ profile. By symmetry, we must have $\\frac{dq}{dr}|_{r=0} = 0$, which implies $\\hat{s}(0)=0$.\n\nThe overall computational procedure is as follows:\n-   A fine, uniform radial grid is established from $r=0$ to $r=a$.\n-   For each pressure exponent $m \\in \\{0, 2, 4\\}$:\n    a. The pressure gradient $\\frac{dp}{dr}(r)$ is calculated, which determines the bootstrap current density profile $j_{\\mathrm{bs}}(r)$.\n    b. The total bootstrap current $I_{\\mathrm{bs}}$ is found by numerical integration.\n    c. The ohmic current amplitude $J_0$ is calculated to enforce the fixed total current $I_p$.\n    d. The full current density profile $j_\\phi(r)$ is constructed.\n    e. The profiles for $I_{\\mathrm{enc}}(r)$, $B_\\theta(r)$, $q(r)$, and $\\hat{s}(r)$ are computed sequentially, taking care to correctly handle the $r=0$ point using the analytical limits.\n-   The reference profiles for the flat pressure case ($m=0$) are stored as $q_{\\mathrm{flat}}(r)$ and $\\hat{s}_{\\mathrm{flat}}(r)$.\n-   For the peaked cases ($m=2, 4$), the sensitivity metrics $S(m)$ and $\\Delta\\hat{s}(m)$ are calculated. This requires evaluating the $q$ and $\\hat{s}$ profiles at specific radii, which is achieved through linear interpolation of the discrete profile data.\n-   Finally, the results are formatted and printed as required. The increasing pressure peaking (larger $m$) is expected to increase the bootstrap current fraction, which raises the on-axis safety factor $q(0)$ and can modify the shear profile, potentially creating a region of shear reversal ($\\hat{s}0$). The implemented code below follows this logic precisely.",
            "answer": "```python\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Computes safety factor and magnetic shear sensitivity in a tokamak.\n    \"\"\"\n    # Physical and numerical parameters\n    MU0 = 4.0 * np.pi * 1e-7  # Permeability of free space (H/m)\n    R0 = 3.0                   # Major radius (m)\n    A = 0.5                    # Minor radius (m)\n    B_PHI = 5.0                # Toroidal magnetic field (T)\n    IP = 1.5e6                 # Total plasma current (A)\n    GAMMA = 1.0                # Ohmic shape exponent\n    KAPPA_BS = 0.1             # Bootstrap coefficient (A m^-2 T Pa^-1)\n    P0 = 5.0e4                 # Pressure scale (Pa)\n    N_POINTS = 2001            # Number of points in the radial grid\n\n    # Radial grid from r=0 to r=a\n    r_grid = np.linspace(0, A, N_POINTS)\n\n    def calculate_profiles(m):\n        \"\"\"\n        Calculates j_phi, q, and s_hat profiles for a given pressure exponent m.\n        \"\"\"\n        # 1. Calculate the bootstrap current density j_bs(r)\n        if m == 0:\n            dp_dr = np.zeros_like(r_grid)\n        else:\n            # Normalized radius squared, with a small epsilon to avoid 0^negative power warning\n            # Although for m=2,4 this is not an issue, it's good practice.\n            r_over_a_sq = (r_grid / A)**2\n            base = np.maximum(0.0, 1.0 - r_over_a_sq)\n            dp_dr = - (2.0 * P0 * m / A**2) * r_grid * base**(m - 1.0)\n        \n        j_bs = -KAPPA_BS * (R0 / B_PHI) * dp_dr\n\n        # 2. Calculate J0 by enforcing the total current constraint\n        # Total bootstrap current I_bs\n        integrand_I_bs = j_bs * 2.0 * np.pi * r_grid\n        I_bs = np.trapz(integrand_I_bs, r_grid)\n\n        # The integral part of the Ohmic current is analytic\n        I_ohm_norm = (np.pi * A**2) / (GAMMA + 1.0)\n        J0 = (IP - I_bs) / I_ohm_norm\n\n        # 3. Construct total current density j_phi(r)\n        j_ohm = J0 * (1.0 - (r_grid / A)**2)**GAMMA\n        j_phi = j_ohm + j_bs\n\n        # 4. Calculate enclosed current I_enc(r)\n        integrand_I_enc = j_phi * 2.0 * np.pi * r_grid\n        I_enc = cumulative_trapezoid(integrand_I_enc, r_grid, initial=0.0)\n\n        # 5. Calculate poloidal magnetic field B_theta(r)\n        B_theta = np.zeros_like(r_grid)\n        # Avoid division by zero at r=0\n        nonzero_r_indices = r_grid > 1e-9\n        B_theta[nonzero_r_indices] = (MU0 * I_enc[nonzero_r_indices]) / (2.0 * np.pi * r_grid[nonzero_r_indices])\n\n        # 6. Calculate safety factor q(r)\n        q = np.zeros_like(r_grid)\n        # On-axis value using analytical limit\n        # For all relevant m, j_bs(0) = 0, so j_phi(0) = j_ohm(0) = J0\n        if J0 > 0:\n             q[0] = (2.0 * B_PHI) / (R0 * MU0 * J0)\n        else:\n             q[0] = np.inf # Handle case of very large bootstrap current\n        \n        q[nonzero_r_indices] = (r_grid[nonzero_r_indices] * B_PHI) / (R0 * B_theta[nonzero_r_indices])\n\n        # 7. Calculate magnetic shear s_hat(r)\n        dq_dr = np.gradient(q, r_grid)\n        s_hat = np.zeros_like(r_grid)\n        # Avoid division by zero at r=0\n        s_hat[nonzero_r_indices] = (r_grid[nonzero_r_indices] / q[nonzero_r_indices]) * dq_dr[nonzero_r_indices]\n\n        return q, s_hat\n\n    # Calculate profiles for all test cases\n    m_cases = [0, 2, 4]\n    profiles = {m: calculate_profiles(m) for m in m_cases}\n\n    q_flat, s_hat_flat = profiles[0]\n    q_2, s_hat_2 = profiles[2]\n    q_4, s_hat_4 = profiles[4]\n\n    # --- Compute Sensitivity Metrics ---\n\n    # A. Root-mean-square relative deviation S(m)\n    r_samples_s = np.array([0.3 * A, 0.6 * A, 0.9 * A])\n    \n    q_flat_samples = np.interp(r_samples_s, r_grid, q_flat)\n    q_2_samples = np.interp(r_samples_s, r_grid, q_2)\n    q_4_samples = np.interp(r_samples_s, r_grid, q_4)\n\n    rel_dev_2 = (q_2_samples - q_flat_samples) / q_flat_samples\n    S2 = np.sqrt(np.mean(rel_dev_2**2))\n\n    rel_dev_4 = (q_4_samples - q_flat_samples) / q_flat_samples\n    S4 = np.sqrt(np.mean(rel_dev_4**2))\n\n    # B. Change in magnetic shear Delta_s_hat(m)\n    r_shear_eval = 0.6 * A\n\n    s_hat_flat_val = np.interp(r_shear_eval, r_grid, s_hat_flat)\n    s_hat_2_val = np.interp(r_shear_eval, r_grid, s_hat_2)\n    s_hat_4_val = np.interp(r_shear_eval, r_grid, s_hat_4)\n\n    delta_s_hat_2 = s_hat_2_val - s_hat_flat_val\n    delta_s_hat_4 = s_hat_4_val - s_hat_flat_val\n    \n    results = [S2, S4, delta_s_hat_2, delta_s_hat_4]\n\n    # Format and print the final output\n    print(f\"[{','.join(f'{x:.8f}' for x in results)}]\")\n\nsolve()\n```"
        }
    ]
}