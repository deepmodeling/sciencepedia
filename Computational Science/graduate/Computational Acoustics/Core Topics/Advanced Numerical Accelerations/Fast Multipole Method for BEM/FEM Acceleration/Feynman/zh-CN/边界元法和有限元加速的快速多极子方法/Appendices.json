{
    "hands_on_practices": [
        {
            "introduction": "掌握快速多极子方法（FMM）的第一步是理解其效率的来源。本练习旨在通过一个理想化的八叉树模型，引导您动手分析算法的计算成本。通过推导多极到多极（M2M）、局部到局部（L2L）和多极到局部（M2L）变换的总操作数，您将亲身体验并证明FMM如何将其计算复杂度从 $O(N^2)$ 降低到 $O(N)$，从而深刻理解其加速原理 。",
            "id": "4123790",
            "problem": "考虑一个由波数为 $k$ 的亥姆霍兹方程控制的三维外部声散射问题，该问题通过边界元法 (BEM) 进行离散化，并使用快速多极子方法 (FMM) 进行加速。FMM 构建在一个覆盖立方体计算域的均匀八叉树上，树的深度为 $L \\geq 1$。假设在每一层 $l = 1, 2, \\dots, L$，该八叉树都有 $8^{l}$ 个内部的非空盒子。FMM 使用在角阶数 $p \\geq 1$ 处截断的经典球谐函数多极展开和局部展开。\n\n假设以下物理上和算法上标准的条件：\n- 亥姆霍兹格林函数为 $G(\\mathbf{x}, \\mathbf{y}) = \\dfrac{\\exp(\\mathrm{i} k |\\mathbf{x} - \\mathbf{y}|)}{4 \\pi |\\mathbf{x} - \\mathbf{y}|}$。\n- 多极展开和局部展开在阶数 $p$ 处截断的球谐函数基中表示。\n- 对于第 $l$ 层的每个内部盒子，其良好分离的相互作用列表（同一层级中不相邻但其父节点的邻居的子节点）的基数是一个固定常数，等于 $189$。\n- 每次多极到多极 (M2M) 向上转换在每个子-父关系中发生一次，每次局部到局部 (L2L) 向下转换在每个父-子关系中发生一次。\n- 采用一个成本模型，其中任何转换（M2M、M2L、L2L）的运算次数都与所涉及的复球谐系数的数量成正比，并将每个系数的一次复数乘加运算计为一个运算单位。\n\n从这些假设和亥姆霍兹核的球谐展开的基本性质出发，完成以下任务：\n1. 推导每次展开保留的球谐系数的数量，作为 $p$ 的函数。\n2. 估算所有层级 $l = 1, \\dots, L$ 上的多极到局部 (M2L) 相互作用的总数。\n3. 估算所有层级上的多极到多极 (M2M) 转换总数和所有层级上的局部到局部 (L2L) 转换总数。\n4. 使用上述计数和成本模型，预测整个树上的总运算次数的渐近主导项，并以一个关于 $p$ 和 $L$ 的单一闭式表达式表示。\n\n将您的最终答案表示为一个单一的符号表达式，代表以运算单位计的主导运算次数。无需四舍五入，最终表达式中也不应报告任何物理单位。",
            "solution": "在尝试提供解决方案之前，将首先根据指定标准验证用户提供的问题。\n\n### 问题验证\n\n**步骤 1：提取已知条件**\n从问题陈述中逐字提取的已知条件如下：\n-   **问题域：** 三维外部声散射。\n-   **控制方程：** 波数为 $k$ 的亥姆霍兹方程。\n-   **数值方法：** 由快速多极子方法 (FMM) 加速的边界元法 (BEM)。\n-   **FMM 树结构：** 覆盖立方体计算域的均匀八叉树，深度为 $L \\geq 1$。\n-   **盒子数量：** 在每一层 $l = 1, 2, \\dots, L$，八叉树有 $8^{l}$ 个内部的非空盒子。\n-   **展开：** 在角阶数 $p \\geq 1$ 处截断的经典球谐函数多极展开和局部展开。\n-   **格林函数：** 亥姆霍兹格林函数为 $G(\\mathbf{x}, \\mathbf{y}) = \\dfrac{\\exp(\\mathrm{i} k |\\mathbf{x} - \\mathbf{y}|)}{4 \\pi |\\mathbf{x} - \\mathbf{y}|}$。\n-   **基：** 在阶数 $p$ 处截断的球谐函数基。\n-   **相互作用列表：** 对于第 $l$ 层的每个内部盒子，其良好分离的相互作用列表的基数是一个固定常数，等于 $189$。\n-   **转换规则：**\n    -   多极到多极 (M2M) 向上转换在每个子-父关系中发生一次。\n    -   局部到局部 (L2L) 向下转换在每个父-子关系中发生一次。\n-   **成本模型：** 任何转换（M2M、M2L、L2L）的运算次数与复球谐系数的数量成正比，每个系数的一次复数乘加运算计为一个运算单位。\n\n**步骤 2：使用提取的已知条件进行验证**\n-   **科学依据：** 该问题牢固地植根于计算声学和快速多极子方法的理论。亥姆霍兹方程、其格林函数、球谐展开、八叉树数据结构以及 M2M、M2L 和 L2L 转换的概念都是该领域的标准和基本要素。相互作用列表大小的常数 $189$ 是一个已知的特定值，用于某些针对均匀网格的 FMM 实现中，代表其父节点为邻居的非相邻盒子的数量。\n-   **良态性：** 该问题是良态的。它提供了一套清晰的假设，并要求推导运算次数，这会得出一个唯一的解析表达式。\n-   **客观性：** 问题以精确、客观和技术性的语言陈述，没有歧义或主观论断。\n-   **完整性和一致性：** 问题是自洽的。它提供了进行分析所需的所有必要参数（$L$、$p$）和常数（相互作用列表大小为 $189$，盒子数量按 $8^l$ 比例缩放）。诸如均匀树且无空盒子之类的假设是简化的，但为了算法分析的目的，这些假设被明确陈述且是一致的。\n-   **现实性：** 虽然一个完全均匀且完全填充的八叉树的假设是一种理想化，但它是教科书和研究论文中用于对 FMM 算法进行“最佳情况”或“平均情况”复杂度分析的标准模型。\n\n**步骤 3：结论和行动**\n问题有效。这是一个关于快速多极子方法算法分析的标准练习，尽管有所简化。将按要求提供解决方案。\n\n### 解题推导\n\n问题要求分步推导在一个 FMM 加速的 BEM 代码中，远场计算的主导运算次数。\n\n**1. 球谐系数的数量**\n一个在阶数（最大次数）$p$ 处截断的球谐展开，包含所有次数为 $n = 0, 1, \\dots, p$ 的球谐函数 $Y_{n}^{m}$。对于每个次数 $n$，阶数 $m$ 取从 $-n$ 到 $n$ 的 $2n+1$ 个整数值。\n复系数的总数 $N_{\\text{coef}}$，是直到次数 $p$ 的每个次数的谐函数数量之和：\n$$N_{\\text{coef}}(p) = \\sum_{n=0}^{p} (2n+1)$$\n这是一个等差数列的和。我们可以如下计算它：\n$$N_{\\text{coef}}(p) = 2 \\sum_{n=0}^{p} n + \\sum_{n=0}^{p} 1 = 2 \\frac{p(p+1)}{2} + (p+1)$$\n$$N_{\\text{coef}}(p) = p(p+1) + (p+1) = (p+1)(p+1) = (p+1)^{2}$$\n因此，每个多极展开或局部展开都由 $(p+1)^2$ 个复系数表示。\n\n**2. 多极到局部 (M2L) 相互作用的总数**\nM2L 转换是针对给定层级的每个盒子与其相互作用列表中的所有盒子进行的。\n在任何层级 $l$（其中 $l \\in \\{1, 2, \\dots, L\\}$），有 $N_{\\text{box}}(l) = 8^l$ 个非空盒子。\n对于这 $8^l$ 个盒子中的每一个，相互作用列表的大小是一个给定的常数 $N_{\\text{int}} = 189$。\n第 $l$ 层的 M2L 转换操作次数为 $N_{\\text{M2L}}(l) = N_{\\text{box}}(l) \\times N_{\\text{int}} = 8^l \\times 189$。\nM2L 相互作用的总数 $C_{\\text{M2L}}$ 是从层级 $l=1$ 到 $L$ 的总和：\n$$C_{\\text{M2L}} = \\sum_{l=1}^{L} N_{\\text{M2L}}(l) = \\sum_{l=1}^{L} 189 \\cdot 8^l = 189 \\sum_{l=1}^{L} 8^l$$\n这是一个等比级数的和：$\\sum_{i=1}^{n} r^i = r \\frac{r^n - 1}{r-1}$。当 $r=8$ 和 $n=L$ 时：\n$$C_{\\text{M2L}} = 189 \\left( 8 \\frac{8^L - 1}{8-1} \\right) = 189 \\left( \\frac{8}{7} (8^L - 1) \\right)$$\n因为 $189 = 27 \\times 7$，我们可以简化前置因子：\n$$C_{\\text{M2L}} = 27 \\times 7 \\times \\frac{8}{7} (8^L - 1) = 27 \\times 8 (8^L - 1) = 216(8^L - 1)$$\n\n**3. M2M 和 L2L 转换的总数**\n-   **多极到多极 (M2M) 转换：** 这些转换发生在 FMM 算法的向上传递过程中。每次 M2M 转换针对每个子-父对发生。子节点是层级为 $l=1, \\dots, L$ 的所有盒子。M2M 转换的总数 $C_{\\text{M2M}}$ 是树中子盒子的总数（不包括第 $0$ 层的根节点）。\n    $$C_{\\text{M2M}} = \\sum_{l=1}^{L} N_{\\text{box}}(l) = \\sum_{l=1}^{L} 8^l$$\n    使用相同的等比级数公式：\n    $$C_{\\text{M2M}} = \\frac{8}{7}(8^L - 1)$$\n-   **局部到局部 (L2L) 转换：** 这些转换发生在向下传递过程中。每次 L2L 转换针对每个父-子对发生。其逻辑与 M2M 的情况相同；转换次数是接收转换后展开的子节点总数。\n    $$C_{\\text{L2L}} = \\sum_{l=1}^{L} N_{\\text{box}}(l) = \\sum_{l=1}^{L} 8^l = \\frac{8}{7}(8^L - 1)$$\n\n**4. 总运算次数的渐近主导项**\n成本模型指出，任何单个转换的运算次数等于系数的数量，即 $N_{\\text{coef}} = (p+1)^2$。\n远场部分的总运算次数 $O$ 是所有 M2M、L2L 和 M2L 转换成本的总和。\n\n-   **M2M 成本：** $O_{\\text{M2M}} = C_{\\text{M2M}} \\times N_{\\text{coef}} = \\frac{8}{7}(8^L - 1)(p+1)^2$。\n-   **L2L 成本：** $O_{\\text{L2L}} = C_{\\text{L2L}} \\times N_{\\text{coef}} = \\frac{8}{7}(8^L - 1)(p+1)^2$。\n-   **M2L 成本：** $O_{\\text{M2L}} = C_{\\text{M2L}} \\times N_{\\text{coef}} = 216(8^L - 1)(p+1)^2$。\n\n总运算次数为 $O_{\\text{total}} = O_{\\text{M2M}} + O_{\\text{L2L}} + O_{\\text{M2L}}$。\n$$O_{\\text{total}} = \\left( \\frac{8}{7} + \\frac{8}{7} + 216 \\right) (8^L - 1)(p+1)^2$$\n$$O_{\\text{total}} = \\left( \\frac{16}{7} + \\frac{1512}{7} \\right) (8^L - 1)(p+1)^2 = \\frac{1528}{7} (8^L - 1)(p+1)^2$$\n问题要求的是“渐近主导项”。成本的三个分量 $O_{\\text{M2M}}$、$O_{\\text{L2L}}$ 和 $O_{\\text{M2L}}$ 都对 $L$ 和 $p$ 有相同的依赖关系，即 $\\propto (8^L - 1)(p+1)^2$。因此，主导项是具有最大常数前置因子的那一项。\n-   M2M 的前置因子：$\\frac{8}{7} \\approx 1.14$\n-   L2L 的前置因子：$\\frac{8}{7} \\approx 1.14$\n-   M2L 的前置因子：$216$\n显然，$216$ 远大于 $\\frac{8}{7}$。对总运算次数的主导贡献来自 M2L 转换。这是 FMM 复杂度分析中的一个标准结果。\n这个主导项的表达式是：\n$$O_{\\text{dominant}} = O_{\\text{M2L}} = 216(8^L - 1)(p+1)^2$$\n这是一个闭式表达式，表示在给定假设下运算成本的主导部分。",
            "answer": "$$\n\\boxed{216(8^{L} - 1)(p+1)^{2}}\n$$"
        },
        {
            "introduction": "理论上的 $O(N)$ 复杂度并不意味着FMM在所有情况下都比直接方法快，因为其算法开销不容忽视。本练习将理论联系实际，要求您基于一个具体的硬件和算法成本模型，计算FMM加速的边界元方法（BEM）相对于传统稠密矩阵法的性能“盈亏平衡点” 。通过这个计算，您将学会如何量化和评估在特定问题规模和计算环境下采用FMM的实际效益，这是在工程和科研中做出明智算法选择的关键技能。",
            "id": "4123862",
            "problem": "考虑一个与亥姆霍兹方程相关的三维声学边界元法 (BEM) 矩阵向量乘积，其核函数为自由空间格林函数 $G(\\mathbf{r}) = \\exp(i k r) / (4 \\pi r)$，其中 $r = \\|\\mathbf{r}\\|$。您希望在基于球谐函数的多极展开框架内，使用快速多极子方法 (FMM) 来加速此矩阵向量乘法。目标是确定边界单元的盈亏平衡数量 $N^{\\star}$，当单元数量达到此值时，FMM 加速的矩阵向量乘积比稠密的直接矩阵向量乘积更快。\n\n假设以下科学上真实且内部一致的设定：\n\n- 物理和离散化：\n  - 波数为 $k = 20 \\ \\mathrm{m}^{-1}$。\n  - 散射体近似为球形，半径 $a = 0.5 \\ \\mathrm{m}$，因此 $k a = 10$。\n  - BEM 采用一个包含 $N$ 个边界单元的网格。\n  - FMM 的目标相对精度为 $10^{-3}$。\n  - 多极展开阶数由亥姆霍兹核的一个保守经验法则设定：$p = \\lceil k a + p_{0} \\rceil$，其中 $p_{0} = 4$。\n\n- 算法成本模型 (浮点运算)：\n  - 对于稠密直接矩阵向量乘积，每对相互作用需要 $c_{\\mathrm{pair}} = 60$ 次浮点运算 (flops)，包括距离计算、$1/r$、复指数、复数缩放和累加。因此，总浮点运算次数为 $f_{\\mathrm{dense}}(N) = c_{\\mathrm{pair}} N^{2}$。\n  - 对于快速多极子方法 (FMM)，使用一个标准的低频亥姆霍兹球谐展开模型，其成本如下：\n    - 每个多极或局部展开包含 $(p+1)^{2}$ 个系数。\n    - 质点到多极 (P2M) 和局部到质点 (L2P) 的成本分别为每个质点 $8 (p+1)^{2}$ 次浮点运算。\n    - 多极到局部 (M2L) 转换成本采用经旋转/分解优化的实现，每次良好分离的盒子相互作用需要 $6 (p+1)^{3}$ 次浮点运算。\n    - 向上聚合 (M2M) 和向下传播 (L2L) 的成本均为每次子贡献 $2 (p+1)^{3}$ 次浮点运算，每个父节点有 $8$ 个子节点，导致每个盒子的 M2M 成本为 $16 (p+1)^{3}$ 次浮点运算，L2L 成本也相同。\n    - 每个叶子盒子包含 $n_{0} = 64$ 个边界单元。\n    - 每个盒子的良好分离相互作用列表大小为 $L = 189$。\n    - 每个质点的平均近场相互作用（FMM 不处理的直接计算）为 $q = 40$ 对，每对的成本为稠密计算的每对成本 $c_{\\mathrm{pair}}$。\n\n  在这些假设下，总的 FMM 浮点运算次数模型为\n  $$f_{\\mathrm{FMM}}(N, p) = N \\big( 8 (p+1)^{2} + 8 (p+1)^{2} + q \\, c_{\\mathrm{pair}} \\big) + \\frac{N}{n_{0}} \\big( L \\cdot 6 (p+1)^{3} + 16 (p+1)^{3} + 16 (p+1)^{3} \\big)。$$\n\n- 硬件模型和运算强度：\n  - 处理器的峰值双精度性能为 $R = 2.5 \\times 10^{12}$ flops/s，持续内存带宽为 $B = 2.5 \\times 10^{11}$ bytes/s，因此 $R/B = 10$ flops/byte。\n  - 经验上，在此 BEM 设置中，稠密核函数计算的运算强度为 $I_{\\mathrm{dense}} \\approx 15$ flops/byte，FMM 核心转换的运算强度为 $I_{\\mathrm{FMM}} \\approx 20$ flops/byte。因为 $I_{\\mathrm{dense}} > R/B$ 且 $I_{\\mathrm{FMM}} > R/B$，所以这两种方法在该硬件上都是计算受限的，因此它们的执行时间主要由浮点运算次数决定：$T_{\\mathrm{dense}} \\approx f_{\\mathrm{dense}}(N) / R$ 和 $T_{\\mathrm{FMM}} \\approx f_{\\mathrm{FMM}}(N, p) / R$。\n\n任务：\n1. 使用以上数据，计算盈亏平衡点 $N^{\\star}$，使得 $T_{\\mathrm{FMM}}(N^{\\star}) = T_{\\mathrm{dense}}(N^{\\star})$。\n2. 将最终答案表示为无单位的边界单元数量，并四舍五入到三位有效数字。",
            "solution": "该问题要求计算边界单元的盈亏平衡数量 $N^{\\star}$，在该数量下，直接矩阵向量乘积的计算时间 $T_{\\mathrm{dense}}$ 等于快速多极子方法 (FMM) 加速的矩阵向量乘积的计算时间 $T_{\\mathrm{FMM}}$。因此，盈亏平衡条件为 $T_{\\mathrm{dense}}(N^{\\star}) = T_{\\mathrm{FMM}}(N^{\\star})$。\n\n题目提供了一个硬件模型，其中稠密计算和 FMM 计算都是计算受限的。这是因为它们各自的运算强度，$I_{\\mathrm{dense}} \\approx 15$ flops/byte 和 $I_{\\mathrm{FMM}} \\approx 20$ flops/byte，都大于机器的平衡值 $R/B = (2.5 \\times 10^{12}) / (2.5 \\times 10^{11}) = 10$ flops/byte。在这种情况下，执行时间 $T$ 由总浮点运算次数 (flops) $f$ 和处理器峰值性能 $R$ 决定，即 $T \\approx f/R$。\n\n因此，盈亏平衡条件 $T_{\\mathrm{dense}}(N^{\\star}) = T_{\\mathrm{FMM}}(N^{\\star})$ 可以通过代入基于浮点运算的时间模型来简化：\n$$ \\frac{f_{\\mathrm{dense}}(N^{\\star})}{R} = \\frac{f_{\\mathrm{FMM}}(N^{\\star})}{R} $$\n处理器性能 $R$ 被消去，将问题简化为求解使总浮点运算次数相等的 $N^{\\star}$：\n$$ f_{\\mathrm{dense}}(N^{\\star}) = f_{\\mathrm{FMM}}(N^{\\star}) $$\n\n首先，我们必须确定多极展开阶数 $p$。题目提供了经验法则 $p = \\lceil k a + p_{0} \\rceil$。使用给定的值 $k = 20 \\ \\mathrm{m}^{-1}$，$a = 0.5 \\ \\mathrm{m}$ 和 $p_{0} = 4$：\n$$ k a = 20 \\times 0.5 = 10 $$\n$$ p = \\lceil 10 + 4 \\rceil = \\lceil 14 \\rceil = 14 $$\n\n接下来，我们将给定的总浮点运算次数的成本模型代入我们的盈亏平衡方程。\n稠密矩阵向量乘积的成本由下式给出：\n$$ f_{\\mathrm{dense}}(N) = c_{\\mathrm{pair}} N^{2} $$\n其中 $c_{\\mathrm{pair}} = 60$。\n\nFMM 加速的乘积成本由下式给出：\n$$ f_{\\mathrm{FMM}}(N, p) = N \\big( 8 (p+1)^{2} + 8 (p+1)^{2} + q \\, c_{\\mathrm{pair}} \\big) + \\frac{N}{n_{0}} \\big( L \\cdot 6 (p+1)^{3} + 16 (p+1)^{3} + 16 (p+1)^{3} \\big) $$\n这个表达式可以简化并写成 $f_{\\mathrm{FMM}}(N, p) = C_{\\mathrm{FMM}} N$，其中 $C_{\\mathrm{FMM}}$ 是一个常数，代表 FMM 中每个单元的有效计算量：\n$$ C_{\\mathrm{FMM}} = 16 (p+1)^{2} + q \\, c_{\\mathrm{pair}} + \\frac{1}{n_{0}} \\left( 6L + 32 \\right) (p+1)^{3} $$\n\n盈亏平衡方程变为：\n$$ c_{\\mathrm{pair}} (N^{\\star})^{2} = C_{\\mathrm{FMM}} N^{\\star} $$\n对于 $N^{\\star} > 0$ 的非平凡解，我们可以两边同除以 $N^{\\star}$：\n$$ c_{\\mathrm{pair}} N^{\\star} = C_{\\mathrm{FMM}} $$\n$$ N^{\\star} = \\frac{C_{\\mathrm{FMM}}}{c_{\\mathrm{pair}}} $$\n\n现在，我们代入给定的数值来计算 $C_{\\mathrm{FMM}}$：\n$p = 14$，所以 $p+1 = 15$。\n$c_{\\mathrm{pair}} = 60$。\n$q = 40$。\n$n_{0} = 64$。\n$L = 189$。\n\n我们来计算 $C_{\\mathrm{FMM}}$ 的各个分量：\n每个质点的直接和近场相互作用成本为：\n$$ 16 (p+1)^{2} + q \\, c_{\\mathrm{pair}} = 16 (15)^{2} + 40 \\times 60 = 16 \\times 225 + 2400 = 3600 + 2400 = 6000 \\ \\text{flops} $$\n\n每个质点的远场 (FMM 转换) 成本为：\n$$ \\frac{1}{n_{0}} \\left( 6L + 32 \\right) (p+1)^{3} = \\frac{1}{64} \\left( 6 \\times 189 + 32 \\right) (15)^{3} $$\n$$ = \\frac{1}{64} \\left( 1134 + 32 \\right) (3375) $$\n$$ = \\frac{1}{64} \\left( 1166 \\right) (3375) $$\n$$ = \\frac{3935250}{64} = 61488.28125 \\ \\text{flops} $$\n\n每个质点的总有效 FMM 成本是这些分量的总和：\n$$ C_{\\mathrm{FMM}} = 6000 + 61488.28125 = 67488.28125 $$\n\n最后，我们计算盈亏平衡的单元数量 $N^{\\star}$：\n$$ N^{\\star} = \\frac{C_{\\mathrm{FMM}}}{c_{\\mathrm{pair}}} = \\frac{67488.28125}{60} = 1124.8046875 $$\n\n题目要求答案四舍五入到三位有效数字。数字 $1124.8046875$ 用科学记数法表示为 $1.1248046875 \\times 10^{3}$。将尾数四舍五入到两位小数得到 $1.12$。因此，盈亏平衡的单元数量为：\n$$ N^{\\star} \\approx 1.12 \\times 10^{3} $$\n这对应于 $1120$ 个边界单元。",
            "answer": "$$\\boxed{1.12 \\times 10^3}$$"
        }
    ]
}