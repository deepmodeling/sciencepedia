{
    "hands_on_practices": [
        {
            "introduction": "The success of any umbrella sampling study hinges on ensuring sufficient overlap between the distributions sampled in adjacent windows. This fundamental practice guides you through the statistical mechanics connecting the stiffness of the harmonic bias, $k_i$, to the width of the sampled distribution. By completing this exercise , you will derive a practical formula to select force constants that achieve a target degree of overlap, a crucial first step in designing a robust simulation protocol.",
            "id": "3838304",
            "problem": "In umbrella sampling for reconstructing a one-dimensional potential of mean force by the Weighted Histogram Analysis Method (WHAM), each window applies a harmonic bias potential to a reaction coordinate $z$. Consider one such window $i$ with bias potential $U_i(z)$ centered at $z_i$, with stiffness $k_i$, defined by $U_i(z) = \\frac{1}{2} k_i (z - z_i)^{2}$. Assume canonical equilibrium at temperature $T$, and that the biased coordinate $z$ is sampled according to the Boltzmann distribution. Starting from the canonical ensemble definition and the fact that the Boltzmann weight is proportional to $\\exp(-\\beta U_i(z))$ with $\\beta = 1/(k_B T)$, derive the normalized form of the biased probability density $p_i(z)$, and thereby obtain the relation between the stiffness $k_i$ and the width $\\sigma_i$ (the standard deviation) of the sampled distribution around $z_i$. Do not assume any specific result about harmonic oscillators other than the Boltzmann form.\n\nTo ensure accurate WHAM reconstruction across adjacent umbrella windows, suppose we adopt the following operational overlap criterion: for two adjacent windows $i$ and $i+1$ with center separation $\\Delta = |z_{i+1} - z_i|$, require that the ratio of the probability density at the neighbor’s center to the probability density at its own center in window $i$ equals a target value $r \\in (0,1)$, namely $r = p_i(z_{i+1})/p_i(z_i)$. Using your derived biased distribution, obtain an explicit expression for $k_i$ in terms of $r$, $\\Delta$, $T$, and $k_B$.\n\nFinally, for a biomolecular system at $T = 300\\,\\mathrm{K}$ with adjacent umbrella centers spaced by $\\Delta = 0.10\\,\\mathrm{nm}$, and a target overlap ratio $r = 0.30$, compute the numerical value of $k_i$. Express your final stiffness in $\\mathrm{kJ\\,mol^{-1}\\,nm^{-2}}$. Use the molar gas constant $R = 8.314462618 \\times 10^{-3}\\,\\mathrm{kJ\\,mol^{-1}\\,K^{-1}}$ in place of $k_B$ to keep energy units per mole. Round your answer to four significant figures.",
            "solution": "The problem is divided into three parts: first, the derivation of the normalized biased probability distribution $p_i(z)$ and the relationship between the harmonic stiffness $k_i$ and the distribution width $\\sigma_i$; second, the derivation of an expression for $k_i$ based on a specified overlap criterion; and third, a numerical calculation of $k_i$.\n\n**Part 1: Biased Probability Distribution and Stiffness-Width Relation**\n\nIn an umbrella sampling window $i$, the system is subject to a total potential energy that includes the intrinsic potential of mean force (PMF), $W(z)$, and the applied bias potential, $U_i(z)$. According to the principles of the canonical ensemble, the probability density of finding the system at a reaction coordinate value $z$ is proportional to the Boltzmann factor of the total energy: $p_i(z) \\propto \\exp(-\\beta [W(z) + U_i(z)])$, where $\\beta = 1/(k_B T)$ is the inverse temperature.\n\nFor a sufficiently stiff harmonic bias, the sampling is localized to a narrow region around the bias center $z_i$. In this region, it is a standard and reasonable approximation to assume that the intrinsic PMF $W(z)$ is nearly constant, i.e., $W(z) \\approx W(z_i)$. This constant energy offset can be absorbed into the normalization constant. The probability density is then determined primarily by the bias potential, $U_i(z)$:\n$$p_i(z) \\propto \\exp(-\\beta U_i(z))$$\nGiven the harmonic form of the bias potential, $U_i(z) = \\frac{1}{2} k_i (z - z_i)^2$, the unnormalized probability density is:\n$$\\tilde{p}_i(z) = C_0 \\exp\\left(-\\frac{\\beta k_i}{2} (z - z_i)^2\\right)$$\nwhere $C_0$ is an arbitrary constant. To obtain the normalized probability density $p_i(z)$, we must enforce the condition $\\int_{-\\infty}^{\\infty} p_i(z) dz = 1$. Let the normalized form be $p_i(z) = C \\exp\\left(-\\frac{\\beta k_i}{2} (z - z_i)^2\\right)$. The normalization constant $C$ is then given by the inverse of the integral:\n$$C^{-1} = \\int_{-\\infty}^{\\infty} \\exp\\left(-\\frac{\\beta k_i}{2} (z - z_i)^2\\right) dz$$\nThis is a standard Gaussian integral. Using the general formula $\\int_{-\\infty}^{\\infty} \\exp(-ax^2) dx = \\sqrt{\\pi/a}$, with $x = z - z_i$ and $a = \\beta k_i / 2$, we find:\n$$C^{-1} = \\sqrt{\\frac{\\pi}{\\beta k_i / 2}} = \\sqrt{\\frac{2\\pi}{\\beta k_i}}$$\nThus, the normalization constant is $C = \\sqrt{\\frac{\\beta k_i}{2\\pi}}$. The normalized biased probability density is:\n$$p_i(z) = \\sqrt{\\frac{\\beta k_i}{2\\pi}} \\exp\\left(-\\frac{\\beta k_i}{2} (z - z_i)^2\\right)$$\nThis is a normal (Gaussian) distribution with mean $\\mu = z_i$. The standard form of a normal distribution is $f(x; \\mu, \\sigma^2) = \\frac{1}{\\sigma \\sqrt{2\\pi}} \\exp\\left(-\\frac{(x - \\mu)^2}{2\\sigma^2}\\right)$. By comparing the exponent of our derived $p_i(z)$ with the standard form, we have:\n$$\\frac{(z-z_i)^2}{2\\sigma_i^2} = \\frac{\\beta k_i (z - z_i)^2}{2}$$\nThis implies that the variance $\\sigma_i^2$ is related to the stiffness $k_i$ by $\\frac{1}{\\sigma_i^2} = \\beta k_i$. Rearranging gives the relationship between the stiffness and the distribution width (standard deviation) $\\sigma_i$:\n$$\\sigma_i^2 = \\frac{1}{\\beta k_i} = \\frac{k_B T}{k_i}$$\nThis can be written as $k_i = \\frac{k_B T}{\\sigma_i^2}$.\n\n**Part 2: Expression for Stiffness from Overlap Criterion**\n\nWe are given the overlap criterion for two adjacent windows, $i$ and $i+1$, as $r = p_i(z_{i+1})/p_i(z_i)$. Using our derived expression for $p_i(z)$:\nThe probability density at the center of window $i$, $z=z_i$, is the maximum value of the distribution:\n$$p_i(z_i) = \\sqrt{\\frac{\\beta k_i}{2\\pi}} \\exp(0) = \\sqrt{\\frac{\\beta k_i}{2\\pi}}$$\nThe probability density at the center of the adjacent window, $z=z_{i+1}$, is:\n$$p_i(z_{i+1}) = \\sqrt{\\frac{\\beta k_i}{2\\pi}} \\exp\\left(-\\frac{\\beta k_i}{2} (z_{i+1} - z_i)^2\\right)$$\nThe ratio is therefore:\n$$r = \\frac{p_i(z_{i+1})}{p_i(z_i)} = \\frac{\\sqrt{\\frac{\\beta k_i}{2\\pi}} \\exp\\left(-\\frac{\\beta k_i}{2} (z_{i+1} - z_i)^2\\right)}{\\sqrt{\\frac{\\beta k_i}{2\\pi}}} = \\exp\\left(-\\frac{\\beta k_i}{2} (z_{i+1} - z_i)^2\\right)$$\nGiven the center separation $\\Delta = |z_{i+1} - z_i|$, we have $\\Delta^2 = (z_{i+1} - z_i)^2$. The equation becomes:\n$$r = \\exp\\left(-\\frac{\\beta k_i \\Delta^2}{2}\\right)$$\nTo find an expression for $k_i$, we take the natural logarithm of both sides:\n$$\\ln(r) = -\\frac{\\beta k_i \\Delta^2}{2}$$\nSolving for $k_i$:\n$$k_i = -\\frac{2 \\ln(r)}{\\beta \\Delta^2}$$\nSubstituting $\\beta = 1/(k_B T)$, we obtain the final explicit expression for $k_i$:\n$$k_i = -\\frac{2 k_B T \\ln(r)}{\\Delta^2}$$\nSince $r \\in (0,1)$, $\\ln(r)$ is negative, which ensures that the stiffness $k_i$ is a positive quantity.\n\n**Part 3: Numerical Calculation**\n\nWe are asked to compute the numerical value for $k_i$ using the given parameters: $T = 300\\,\\mathrm{K}$, $\\Delta = 0.10\\,\\mathrm{nm}$, and $r = 0.30$. The problem specifies using the molar gas constant $R = 8.314462618 \\times 10^{-3}\\,\\mathrm{kJ\\,mol^{-1}\\,K^{-1}}$ in place of the Boltzmann constant $k_B$. This substitution correctly adapts the energy units from per-molecule to per-mole, yielding a stiffness in $\\mathrm{kJ\\,mol^{-1}\\,nm^{-2}}$.\nThe formula becomes:\n$$k_i = -\\frac{2 R T \\ln(r)}{\\Delta^2}$$\nSubstituting the values:\n$$k_i = -\\frac{2 \\times (8.314462618 \\times 10^{-3}\\,\\mathrm{kJ\\,mol^{-1}\\,K^{-1}}) \\times (300\\,\\mathrm{K}) \\times \\ln(0.30)}{(0.10\\,\\mathrm{nm})^2}$$\nFirst, we compute the product $RT$:\n$$RT = (8.314462618 \\times 10^{-3}\\,\\mathrm{kJ\\,mol^{-1}\\,K^{-1}}) \\times (300\\,\\mathrm{K}) \\approx 2.4943\\,\\mathrm{kJ\\,mol^{-1}}$$\nNext, the natural logarithm of $r$:\n$$\\ln(0.30) \\approx -1.2040$$\nNow, we calculate $k_i$:\n$$k_i = -\\frac{2 \\times (2.4943387854\\,\\mathrm{kJ\\,mol^{-1}}) \\times (-1.2039728043)}{0.0100\\,\\mathrm{nm}^2}$$\n$$k_i = \\frac{6.00626301\\,\\mathrm{kJ\\,mol^{-1}}}{0.0100\\,\\mathrm{nm}^2} \\approx 600.6263\\,\\mathrm{kJ\\,mol^{-1}\\,nm^{-2}}$$\nRounding the result to four significant figures as requested gives:\n$$k_i \\approx 600.6\\,\\mathrm{kJ\\,mol^{-1}\\,nm^{-2}}$$",
            "answer": "$$\\boxed{600.6}$$"
        },
        {
            "introduction": "This comprehensive practice challenges you to build a complete pipeline for calculating a ligand-receptor binding PMF, a central task in computational drug discovery. Starting from synthetic data generation, you will implement the WHAM algorithm, correctly handle the geometric Jacobian factor for a radial coordinate, and calculate the standard-state binding free energy. This exercise  provides an end-to-end look at applying WHAM to a realistic and scientifically important problem.",
            "id": "3838259",
            "problem": "You are asked to design a computational protocol to estimate a ligand–receptor binding potential of mean force (PMF) along a scalar radial separation coordinate using umbrella sampling combined with the Weighted Histogram Analysis Method (WHAM). The ligand–receptor separation is a scalar coordinate $r$ measured in nanometers. The radial measure in three-dimensional space introduces a Jacobian factor $4\\pi r^2$ that must be explicitly accounted for in the PMF. The ultimate goal is to compute the standard-state binding free energy.\n\nStart from the following fundamental bases:\n\n- The canonical ensemble Boltzmann distribution for a coordinate $x$ with energy $U(x)$ states that the probability density is proportional to $\\exp(-\\beta U(x))$, where $\\beta = 1/(k_\\mathrm{B} T)$, $k_\\mathrm{B}$ is the Boltzmann constant, and $T$ is the temperature.\n- The probability density for a three-dimensional radial coordinate $r$ (with no angular bias) has a measure factor $4\\pi r^2$, so the probability density with respect to the scalar $r$ is proportional to $4\\pi r^2 \\exp(-\\beta G(r))$ when $G(r)$ is the PMF excluding the geometric entropic term.\n- Umbrella sampling applies a harmonic bias in window $i$: $U_i^\\mathrm{bias}(r) = \\tfrac{1}{2} k_i (r - r_i)^2$ with force constant $k_i$ and center $r_i$.\n- The Weighted Histogram Analysis Method (WHAM) combines biased histograms from multiple windows into a single unbiased distribution by enforcing self-consistency between the global distribution and window normalizations.\n\nYour program must:\n\n1. Construct synthetic umbrella sampling histograms for each window by sampling from a known underlying PMF $G_\\mathrm{true}(r)$ (to make the problem self-contained and testable). The synthetic PMF to be used for data generation in all test cases is a Morse-type function\n   $$G_\\mathrm{true}(r) = D\\left(\\exp\\big(-2 a (r - r_0)\\big) - 2 \\exp\\big(-a (r - r_0)\\big)\\right),$$\n   where $D$ is the depth parameter in $\\mathrm{kJ/mol}$, $a$ is the range parameter in $\\mathrm{nm}^{-1}$, and $r_0$ is the minimum location in $\\mathrm{nm}$. The temperature must be $T = 300$ $\\mathrm{K}$, and the Boltzmann constant must be $k_\\mathrm{B} = 0.008314462618$ $\\mathrm{kJ/(mol\\cdot K)}$, so that $\\beta$ is in units of $(\\mathrm{kJ/mol})^{-1}$. The grid for $r$ must be uniform, with $r_\\mathrm{min} = 0.05$ $\\mathrm{nm}$, $r_\\mathrm{max} = 1.50$ $\\mathrm{nm}$, and bin width $\\Delta r = 0.01$ $\\mathrm{nm}$.\n\n2. For each window $i$ and each bin centered at $r_j$, construct the expected biased histogram counts using the biased radial probability density proportional to $4\\pi r_j^2 \\exp\\big(-\\beta\\big(G_\\mathrm{true}(r_j) + U_i^\\mathrm{bias}(r_j)\\big)\\big)$, normalized over the grid so that the total counts in window $i$ equal the specified per-window sample size $N_i$.\n\n3. Implement the Weighted Histogram Analysis Method (WHAM) to iteratively recover the global unbiased probability density $\\hat{p}(r)$ over the grid from the set of window histograms and their harmonic biases. Do not use any shortcut formulas. Derive the update rules from the principles above:\n   - The unbiased distribution must be consistent with the sum of window histograms weighted by the inverse of the bias-induced reweighting factors and window normalizations.\n   - The per-window normalization constants must be updated so that the global distribution reweights back to each window’s biased ensemble normalization.\n\n   Iterate until convergence of the window free energies to a tight tolerance such that the maximum change in all window normalizations between iterations is less than $10^{-10}$ in energy units.\n\n4. Convert the unbiased scalar probability density $\\hat{p}(r)$ into the PMF $G(r)$ that excludes the Jacobian by incorporating the $4\\pi r^2$ factor explicitly. The PMF must be shifted so that it approaches zero in the bulk region, defined here as the high-$r$ tail. Use a bulk range of $r \\in [1.30, 1.50]$ $\\mathrm{nm}$ and enforce that the mean of $G(r)$ over this range is zero.\n\n5. Compute the standard-state binding free energy $\\Delta G_\\mathrm{bind}^\\circ$ by integrating the association constant over a bound region $[0, r_c]$:\n   - Compute the radial association constant $K = \\int_0^{r_c} \\exp\\big(-\\beta G(r)\\big)\\,4\\pi r^2\\,dr$ in $\\mathrm{nm}^3$.\n   - Convert to a dimensionless standard-state equilibrium constant using the standard-state volume $V^\\circ = 1.66053906660$ $\\mathrm{nm}^3$ at $1$ $\\mathrm{M}$: $K^\\circ = K / V^\\circ$.\n   - Report the binding free energy $\\Delta G_\\mathrm{bind}^\\circ = -\\beta^{-1} \\ln K^\\circ$ in $\\mathrm{kJ/mol}$.\n\nYour program must implement the above steps and produce results for the following test suite. For each case, use the specified window set, underlying PMF parameters, per-window counts, and bound-region cutoff $r_c$. Umbrella windows have centers $r_i$ uniformly spaced as specified and identical force constants $k_i$ within each case:\n\n- Test Case $1$ (general case):\n  - Window centers: $r_i \\in \\{0.20, 0.30, 0.40, \\dots, 1.20\\}$ $\\mathrm{nm}$ with step $0.10$ $\\mathrm{nm}$.\n  - Force constant: $k_i = 1200$ $\\mathrm{kJ/(mol\\cdot nm^2)}$.\n  - Per-window counts: $N_i = 50000$.\n  - Underlying PMF parameters: $D = 10$ $\\mathrm{kJ/mol}$, $a = 15$ $\\mathrm{nm}^{-1}$, $r_0 = 0.30$ $\\mathrm{nm}$.\n  - Bound-region cutoff: $r_c = 0.45$ $\\mathrm{nm}$.\n\n- Test Case $2$ (weak binding edge case):\n  - Window centers: $r_i \\in \\{0.20, 0.30, 0.40, \\dots, 1.20\\}$ $\\mathrm{nm}$ with step $0.10$ $\\mathrm{nm}$.\n  - Force constant: $k_i = 900$ $\\mathrm{kJ/(mol\\cdot nm^2)}$.\n  - Per-window counts: $N_i = 30000$.\n  - Underlying PMF parameters: $D = 4$ $\\mathrm{kJ/mol}$, $a = 12$ $\\mathrm{nm}^{-1}$, $r_0 = 0.32$ $\\mathrm{nm}$.\n  - Bound-region cutoff: $r_c = 0.45$ $\\mathrm{nm}$.\n\n- Test Case $3$ (strong binding, broader coverage):\n  - Window centers: $r_i \\in \\{0.15, 0.25, 0.35, \\dots, 1.35\\}$ $\\mathrm{nm}$ with step $0.10$ $\\mathrm{nm}$.\n  - Force constant: $k_i = 1500$ $\\mathrm{kJ/(mol\\cdot nm^2)}$.\n  - Per-window counts: $N_i = 60000$.\n  - Underlying PMF parameters: $D = 20$ $\\mathrm{kJ/mol}$, $a = 22$ $\\mathrm{nm}^{-1}$, $r_0 = 0.28$ $\\mathrm{nm}$.\n  - Bound-region cutoff: $r_c = 0.40$ $\\mathrm{nm}$.\n\nAngle units are not applicable here. Express all energies in $\\mathrm{kJ/mol}$ and all lengths in $\\mathrm{nm}$. Your program must produce a single line of output containing the three binding free energies for the test suite as a comma-separated list enclosed in square brackets, with each value rounded to three decimal places (e.g., $\\left[\\text{result}_1,\\text{result}_2,\\text{result}_3\\right]$).",
            "solution": "The objective is to compute the potential of mean force (PMF) from synthetic umbrella sampling data using the Weighted Histogram Analysis Method (WHAM), and subsequently calculate the standard-state binding free energy. This process involves several steps: generating synthetic biased histograms, applying the WHAM algorithm to recover the unbiased probability distribution, converting this distribution into a PMF, and finally integrating the PMF to obtain the binding free energy.\n\nFirst, we establish the theoretical framework. The PMF, denoted as $G(r)$, along a one-dimensional reaction coordinate $r$ is related to the equilibrium probability density $P(r)$ by the Boltzmann relation. For a radial coordinate in three-dimensional space, the volume element is $4\\pi r^2 dr$, which introduces a Jacobian factor into the probability density. The probability $P(r)dr$ of finding the system with a separation between $r$ and $r+dr$ is given by:\n$$P(r) \\propto 4\\pi r^2 \\exp(-\\beta G(r))$$\nwhere $\\beta = 1/(k_\\mathrm{B} T)$, $k_\\mathrm{B}$ is the Boltzmann constant, and $T$ is the absolute temperature. The PMF $G(r)$ as defined here represents the free energy profile excluding the geometric entropic contribution that is captured by the $4\\pi r^2$ term.\n\nUmbrella sampling enhances sampling of high-energy regions by adding a biasing potential, typically harmonic, in each simulation window $i$. The bias potential is given by $U_i^\\mathrm{bias}(r) = \\frac{1}{2} k_i (r - r_i)^2$, where $k_i$ is the force constant and $r_i$ is the center of the potential for window $i$. In a biased simulation, the observed probability density, $P_i^\\mathrm{bias}(r)$, is modulated by this potential:\n$$P_i^\\mathrm{bias}(r) \\propto 4\\pi r^2 \\exp(-\\beta [G(r) + U_i^\\mathrm{bias}(r)])$$\n\nThe Weighted Histogram Analysis Method (WHAM) is a robust statistical technique for combining data from multiple biased simulations (windows) to compute the unbiased probability distribution along the reaction coordinate. It determines the optimal combination by solving a set of self-consistent equations. Let $N_{ij}$ be the number of samples observed in coordinate bin $j$ from window $i$, and $N_i = \\sum_j N_{ij}$ be the total number of samples in window $i$. The WHAM equations relate the unbiased probability $P_j$ of being in bin $j$ to the window-specific free energy offsets $f_i$:\n$$\n\\begin{cases}\nP_j = \\left( \\sum_{k=1}^{M} N_{kj} \\right) \\left/ \\left( \\sum_{k=1}^{M} N_k \\exp(\\beta f_k) \\exp(-\\beta U_{kj}) \\right) \\right. \\\\\n\\exp(-\\beta f_i) = \\sum_{j=1}^{N_\\mathrm{bins}} P_j \\exp(-\\beta U_{ij})\n\\end{cases}\n$$\nHere, $M$ is the number of windows, $N_\\mathrm{bins}$ is the number of coordinate bins, and $U_{ij} = U_i^\\mathrm{bias}(r_j)$ is the bias potential of window $i$ evaluated at the center of bin $j$. The probabilities $P_j$ are defined up to a global normalization constant, and are typically normalized such that $\\sum_j P_j = 1$. The free energies $f_i$ are defined only relative to each other, so one is typically set to zero (e.g., $f_1=0$) for a unique solution. These equations are solved iteratively until the values of $f_i$ converge.\n\nThe algorithmic procedure is as follows:\n1.  **System Setup and Data Generation**:\n    - Define physical constants $\\beta = 1/(k_\\mathrm{B}T)$ and a discrete grid of $r$ values, $r_j$, from $r_\\mathrm{min}$ to $r_\\mathrm{max}$ with bin width $\\Delta r$.\n    - For each test case, the true underlying PMF, $G_\\mathrm{true}(r)$, is defined by a Morse potential: $G_\\mathrm{true}(r) = D(e^{-2a(r-r_0)} - 2e^{-a(r-r_0)})$.\n    - For each window $i$, a synthetic histogram $N_{ij}$ is generated. The expected number of counts in bin $j$ is proportional to the biased probability density: $N_{ij} \\propto N_i \\cdot 4\\pi r_j^2 \\exp(-\\beta[G_\\mathrm{true}(r_j) + U_i^\\mathrm{bias}(r_j)])$. The counts are normalized such that $\\sum_j N_{ij} = N_i$.\n\n2.  **WHAM Iteration**:\n    - Initialize the window free energies, e.g., $f_i = 0$ for all $i$.\n    - Iterate until the maximum change in any $f_i$ is below a tolerance ($10^{-10}$):\n      a. Calculate the unbiased probabilities $P_j$ for all bins using the current $f_i$ values. This requires computing the denominator term for each bin $j$, $D_j = \\sum_{k=1}^M N_k \\exp(\\beta f_k - \\beta U_{kj})$, and the total counts per bin, $C_j = \\sum_{k=1}^M N_{kj}$. The unnormalized probability is then $\\tilde{P}_j = C_j / D_j$. Finally, normalize so that $\\sum_j P_j = 1$.\n      b. Calculate a new set of free energies, $f_i^\\mathrm{new}$, using the updated probabilities $P_j$: $f_i^\\mathrm{new} = -\\beta^{-1} \\ln\\left(\\sum_j P_j \\exp(-\\beta U_{ij})\\right)$.\n      c. To prevent numerical drift, shift the new free energies, e.g., by subtracting the value of the first one: $f_i^\\mathrm{new} \\leftarrow f_i^\\mathrm{new} - f_i^\\mathrm{new}[0]$.\n      d. Update $f_i \\leftarrow f_i^\\mathrm{new}$ and check for convergence.\n\n3.  **PMF Reconstruction**:\n    - Once the converged unbiased probabilities $P_j$ are obtained, the PMF $G(r_j)$ is calculated. From $P_j \\propto 4\\pi r_j^2 \\exp(-\\beta G(r_j))$, we can write $G(r_j) = -\\beta^{-1} \\ln(P_j/r_j^2) + \\text{constant}$. For bins with $P_j=0$, $G(r_j)$ is infinite.\n    - The PMF is shifted by an additive constant such that its average value over a bulk region (defined as $r \\in [1.30, 1.50]$ nm) is zero. This sets the reference state to be the unbound state.\n\n4.  **Binding Free Energy Calculation**:\n    - The standard-state binding free energy $\\Delta G_\\mathrm{bind}^\\circ$ is determined from the association constant $K$. The radial association constant is integrated over a defined bound volume:\n      $$K = \\int_0^{r_c} 4\\pi r^2 \\exp(-\\beta G(r)) dr$$\n      This integral is numerically approximated by a sum over the grid bins up to the cutoff $r_c$: $K \\approx \\sum_{j: r_j \\le r_c} 4\\pi r_j^2 \\exp(-\\beta G(r_j)) \\Delta r$.\n    - The standard-state equilibrium constant $K^\\circ$ is obtained by dividing by the standard-state volume, $V^\\circ = 1.66053906660$ $\\mathrm{nm}^3$ (equivalent to a $1$ M standard concentration): $K^\\circ = K/V^\\circ$.\n    - Finally, the binding free energy is computed as:\n      $$\\Delta G_\\mathrm{bind}^\\circ = -k_\\mathrm{B} T \\ln(K^\\circ) = -\\beta^{-1} \\ln(K^\\circ)$$\n\nThis entire protocol is implemented for each of the three test cases provided.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for the standard-state binding free energy for three test cases using WHAM.\n    \"\"\"\n\n    # --- Global Parameters and Constants ---\n    T = 300.0  # Temperature in K\n    K_B = 0.008314462618  # Boltzmann constant in kJ/(mol*K)\n    BETA = 1.0 / (K_B * T)  # In (kJ/mol)^-1\n    V_STANDARD = 1.66053906660  # Standard state volume in nm^3 (for 1 M)\n\n    # --- Grid setup ---\n    R_MIN = 0.05  # nm\n    R_MAX = 1.50  # nm\n    DR = 0.01  # nm\n    r_grid = np.arange(R_MIN, R_MAX + DR / 2.0, DR)\n    num_bins = len(r_grid)\n\n    # --- Bulk region definition for PMF shifting ---\n    BULK_MIN = 1.30\n    BULK_MAX = 1.50\n\n    # --- WHAM convergence criterion ---\n    WHAM_TOLERANCE = 1e-10\n\n    test_cases = [\n        # Test Case 1\n        {\n            \"window_centers\": np.arange(0.20, 1.20 + 0.05, 0.10),\n            \"k\": 1200.0,\n            \"N_i\": 50000,\n            \"D\": 10.0,\n            \"a\": 15.0,\n            \"r0\": 0.30,\n            \"rc\": 0.45,\n        },\n        # Test Case 2\n        {\n            \"window_centers\": np.arange(0.20, 1.20 + 0.05, 0.10),\n            \"k\": 900.0,\n            \"N_i\": 30000,\n            \"D\": 4.0,\n            \"a\": 12.0,\n            \"r0\": 0.32,\n            \"rc\": 0.45,\n        },\n        # Test Case 3\n        {\n            \"window_centers\": np.arange(0.15, 1.35 + 0.05, 0.10),\n            \"k\": 1500.0,\n            \"N_i\": 60000,\n            \"D\": 20.0,\n            \"a\": 22.0,\n            \"r0\": 0.28,\n            \"rc\": 0.40,\n        },\n    ]\n\n    results = []\n\n    for case in test_cases:\n        window_centers = case[\"window_centers\"]\n        k = case[\"k\"]\n        N_i_val = case[\"N_i\"]\n        D = case[\"D\"]\n        a = case[\"a\"]\n        r0 = case[\"r0\"]\n        rc = case[\"rc\"]\n\n        num_windows = len(window_centers)\n        \n        # --- 1. Construct Synthetic Histograms ---\n        \n        # True PMF (Morse potential)\n        g_true = D * (np.exp(-2 * a * (r_grid - r0)) - 2 * np.exp(-a * (r_grid - r0)))\n        \n        histograms = np.zeros((num_windows, num_bins))\n        biases_matrix = np.zeros((num_windows, num_bins))\n        N_i_array = np.full(num_windows, N_i_val, dtype=float)\n\n        for i in range(num_windows):\n            r_center = window_centers[i]\n            # Harmonic bias potential for window i\n            u_bias = 0.5 * k * (r_grid - r_center)**2\n            biases_matrix[i, :] = u_bias\n            \n            # Biased energy\n            biased_energy = g_true + u_bias\n            \n            # Biased probability distribution including Jacobian\n            # Prop to 4*pi*r^2 * exp(-beta * E_biased)\n            unnorm_prob = (4 * np.pi * r_grid**2) * np.exp(-BETA * biased_energy)\n            \n            # Normalize probability for this window\n            norm_factor = np.sum(unnorm_prob)\n            if norm_factor == 0:\n                # This case shouldn't happen with the given parameters\n                # but good practice to handle.\n                norm_prob = np.zeros_like(unnorm_prob)\n            else:\n                norm_prob = unnorm_prob / norm_factor\n\n            # Generate histogram counts\n            histograms[i, :] = N_i_val * norm_prob\n            \n        # --- 3. Implement WHAM ---\n        f_i = np.zeros(num_windows)  # Initialize window free energies\n        \n        # Pre-compute terms that don't change in the loop\n        total_counts_per_bin = np.sum(histograms, axis=0) # Numerator of P_j\n        exp_minus_beta_U = np.exp(-BETA * biases_matrix) # exp(-beta*U_ij)\n        \n        for iteration in range(10000): # Max iterations to prevent infinite loop\n            f_old = f_i.copy()\n            \n            # Denominator of P_j\n            exp_beta_f = np.exp(BETA * f_i)\n            weighted_N = N_i_array * exp_beta_f\n            \n            # Sum over windows k for each bin j\n            den_P = weighted_N @ exp_minus_beta_U\n            \n            with np.errstate(divide='ignore', invalid='ignore'):\n                P_unnormalized = total_counts_per_bin / den_P\n            \n            P_unnormalized[np.isnan(P_unnormalized)] = 0.0\n\n            # Normalize probabilities\n            P = P_unnormalized / np.sum(P_unnormalized)\n            \n            # Update free energies f_i\n            with np.errstate(divide='ignore'):\n              log_arg = P @ exp_minus_beta_U.T\n            \n            f_new = -1.0 / BETA * np.log(log_arg)\n            f_new[np.isinf(f_new)] = f_i[np.isinf(f_new)] # Keep old if log_arg is 0\n\n            # Shift to prevent drift\n            f_new -= f_new[0]\n            f_i = f_new\n\n            # Check for convergence\n            max_change = np.max(np.abs(f_i - f_old))\n            if max_change < WHAM_TOLERANCE:\n                break\n        \n        # --- 4. Convert Probability to PMF and Shift ---\n        with np.errstate(divide='ignore'):\n             # G = -k_B*T * (ln(P) - ln(4*pi*r^2*dr))\n             # The constant term ln(4*pi*dr) will be absorbed into the shifting constant\n             G = -1.0 / BETA * (np.log(P) - 2.0 * np.log(r_grid))\n\n        G[np.isneginf(G)] = np.inf # Bins with P=0 have infinite free energy\n        \n        # Shift PMF so bulk region (high r) is zero\n        bulk_mask = (r_grid >= BULK_MIN) & (r_grid <= BULK_MAX)\n        G_bulk = G[bulk_mask]\n        \n        finite_G_bulk = G_bulk[np.isfinite(G_bulk)]\n        if len(finite_G_bulk) > 0:\n            shift = np.mean(finite_G_bulk)\n            G -= shift\n        \n        # --- 5. Compute Standard-State Binding Free Energy ---\n        bound_mask = r_grid <= rc\n        \n        # Integrand for association constant K\n        integrand = np.exp(-BETA * G) * (4 * np.pi * r_grid**2)\n        \n        # Numerical integration (sum over bins)\n        K = np.sum(integrand[bound_mask]) * DR\n\n        # Standard-state equilibrium constant and free energy\n        if K > 0 and V_STANDARD > 0:\n            K_standard = K / V_STANDARD\n            delta_G_bind = -1.0 / BETA * np.log(K_standard)\n        else:\n            delta_G_bind = np.inf # Should not happen\n\n        results.append(round(delta_G_bind, 3))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Many key molecular motions, such as the rotation around chemical bonds, are described by periodic coordinates like dihedral angles. This practice addresses the unique challenges of applying WHAM to such circular coordinates, where naive application of standard methods can lead to artifacts at the boundaries. You will learn to implement WHAM using circular statistics , ensuring the resulting PMF is continuous and correctly represents the underlying periodic free energy landscape.",
            "id": "3838305",
            "problem": "You must write a complete, runnable program that reconstructs the potential of mean force (PMF) for a periodic coordinate using the Weighted Histogram Analysis Method (WHAM) derived from first principles and implemented with circular statistics to enforce continuity across the boundary. Treat the reaction coordinate as an angle $z$ on the circle, with domain $[0,2\\pi)$, and use angles in radians. All energies must be expressed in units of $k_\\mathrm{B}T$, and all reported numerical answers must be dimensionless floats.\n\nStart from the following foundational base in statistical mechanics and probability:\n- The Boltzmann distribution for a state with free energy $F(z)$ has probability density $P(z)$ proportional to $\\exp\\!\\left(-F(z)/(k_\\mathrm{B}T)\\right)$.\n- When harmonic umbrella biases are applied, each biased distribution is proportional to the unbiased probability density multiplied by the Boltzmann factor of the bias.\n- The PMF is related to the normalized probability density by $F(z) = -k_\\mathrm{B}T \\ln P(z) + C$, where $C$ is an additive constant that does not affect physical predictions.\n\nDerive and implement WHAM from these principles, without using any shortcut formulas given here, to optimally combine multiple biased histograms into an estimate of the unbiased $P(z)$ over a discretized set of bins that span the circle. Ensure that:\n- The coordinate $z$ is periodic with period $2\\pi$, and your discretization uses $B$ bins with centers uniformly spaced on $[0,2\\pi)$.\n- Distances on the circle are computed as the wrapped angular difference in $[-\\pi,\\pi)$.\n- Continuity across the boundary is enforced by treating bin indices modulo $B$ when performing any neighborhood, smoothing, or convolution operations.\n- Circular statistics are applied to avoid artificial discontinuities at $z=0$ and $z=2\\pi$ by smoothing the estimated $P(z)$ using a Von Mises circular kernel with concentration parameter $\\kappa$, implemented as a circular convolution and normalized to preserve total probability.\n\nConstruct synthetic umbrella sampling histograms deterministically (no randomness) by:\n1. Defining a physically plausible underlying true PMF $F_{\\mathrm{true}}(z)$ and the corresponding normalized unbiased density $P_{\\mathrm{true}}(z)$.\n2. For each umbrella window with center $c_i$, harmonic stiffness $k_i$ (in units of $k_\\mathrm{B}T$/rad$^2$), and sample size $N_i$, defining the bias potential $U_i(z) = \\tfrac{1}{2} k_i\\,\\Delta(z,c_i)^2$ where $\\Delta(z,c_i)$ is the wrapped angular difference.\n3. Computing each window’s biased probability density proportional to $\\exp\\!\\left(-\\left[F_{\\mathrm{true}}(z) + U_i(z)\\right]/(k_\\mathrm{B}T)\\right)$ and normalizing over the circle, then assigning histogram counts per bin deterministically as $n_i(b) = N_i$ times the normalized biased probability mass in bin $b$.\n\nImplement WHAM to recover the unbiased $P(z)$ from $\\{n_i(b)\\}$ and $\\{U_i(z_b)\\}$, ensuring proper normalization over the circle. After convergence, compute the PMF $F(z) = -k_\\mathrm{B}T \\ln P(z) + C$ and set the additive constant $C$ so that $\\min_z F(z) = 0$. Apply a Von Mises circular smoothing to $P(z)$ before converting to $F(z)$ to avoid artificial discontinuities.\n\nYour program must compute the following metrics for the specified test suite and output them as a single line containing a Python-style list of floats:\n- For each of the first two test cases, compute the boundary continuity metric $\\delta_F$ defined as the absolute difference between the smoothed PMF at the first and last bin: $\\delta_F = \\left|F(z_0) - F(z_{B-1})\\right|$, reported in units of $k_\\mathrm{B}T$.\n- For the third test case, compute the rotation invariance error $E_{\\mathrm{rot}}$, defined as the maximum absolute difference between the smoothed PMF from the rotated windows (aligned back to the original coordinate frame by an exact circular shift of the bins) and the smoothed PMF from the unrotated windows, reported in units of $k_\\mathrm{B}T$.\n\nAngle unit specification: All angles must be in radians. Energy unit specification: All energies and outputs must be expressed in units of $k_\\mathrm{B}T$.\n\nDiscretization and synthetic model:\n- Use $B = 420$ bins on $[0,2\\pi)$ with bin centers $z_b = \\frac{2\\pi}{B} \\left(b + \\tfrac{1}{2}\\right)$ for $b = 0,1,\\dots,B-1$.\n- Define the true PMF as $F_{\\mathrm{true}}(z) = A \\cos(2z) - B_0 \\cos(z)$ with $A = 1.5$ and $B_0 = 0.5$, both in units of $k_\\mathrm{B}T$. Define $P_{\\mathrm{true}}(z) \\propto \\exp\\!\\left(-F_{\\mathrm{true}}(z)/(k_\\mathrm{B}T)\\right)$ and normalize over the circle.\n- Use a Von Mises kernel with concentration parameter $\\kappa = 20$ for circular smoothing of $P(z)$, implemented as a circular convolution over the $B$ bins. Normalize the kernel so the smoothed density remains normalized.\n\nTest suite:\n1. Happy path coverage:\n   - Number of windows $M = 8$ with centers $c_i$ evenly spaced: $c_i = \\frac{2\\pi i}{M}$ for $i = 0,1,\\dots,7$.\n   - Stiffnesses $k_i = 20$ for all $i$.\n   - Sample sizes $N_i = 50{,}000$ for all $i$.\n2. Sparse boundary coverage:\n   - Number of windows $M = 3$ with centers $c = \\left[\\tfrac{\\pi}{2}, \\pi, \\tfrac{3\\pi}{2}\\right]$.\n   - Stiffnesses $k_i = 25$ for all $i$.\n   - Sample sizes $N_i = 10{,}000$ for all $i$.\n3. Rotation invariance:\n   - Use the same configuration as Test 1 but rotate all centers by $\\delta = \\tfrac{2\\pi}{7}$, i.e., $c_i^\\prime = c_i + \\delta$ (mod $2\\pi$).\n   - Compute the smoothed PMF for the rotated case and align by an exact circular shift of $s = \\delta/\\Delta z$ bins, where $\\Delta z = \\tfrac{2\\pi}{B}$, so $s = 60$.\n   - Report the maximum absolute difference $E_{\\mathrm{rot}}$ between the aligned rotated PMF and the original PMF from Test 1.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for the three test cases in order: $\\left[\\delta_F^{(1)}, \\delta_F^{(2)}, E_{\\mathrm{rot}}^{(3)}\\right]$.",
            "solution": "The user has provided a well-posed and scientifically grounded problem in the domain of computational chemical biology. The task is to implement the Weighted Histogram Analysis Method (WHAM) for a periodic reaction coordinate, derive the method from first principles, and apply it to a set of specified test cases. The implementation must correctly handle the circular nature of the coordinate using appropriate statistical and numerical techniques.\n\n### Derivation of the WHAM Equations\n\nThe goal of WHAM is to find the optimal estimate for the unbiased probability distribution, $P(z)$, from a collection of samples obtained from multiple biased simulations. We discretize the reaction coordinate $z \\in [0, 2\\pi)$ into $B$ bins. Let $P_j$ be the unknown probability mass of the system being in bin $j$ in the unbiased state. By definition, $\\sum_{j=1}^{B} P_j = 1$.\n\nWe have a set of $M$ simulations, or \"windows\". For each simulation $i \\in \\{1, \\dots, M\\}$, we have a bias potential $U_i(z)$ and a total of $N_i$ collected samples. The observed data are the histograms $\\{n_{ij}\\}$, where $n_{ij}$ is the number of samples from simulation $i$ that fall into bin $j$. The total number of samples in bin $j$ across all simulations is $n_j = \\sum_{i=1}^{M} n_{ij}$. All energies, including the bias potentials $U_{ij} \\equiv U_i(z_j)$, are expressed in units of $k_\\mathrm{B}T$.\n\nAccording to statistical mechanics, the probability density of a state in a biased simulation is the product of the unbiased probability density and the Boltzmann factor of the bias potential. For our discretized system, the probability of observing a sample in bin $j$ given that it came from simulation $i$ is:\n$$\nP(j|i) = \\frac{P_j \\exp(-U_{ij})}{\\sum_{k=1}^{B} P_k \\exp(-U_{ik})}\n$$\nThe denominator is the partition function for the $i$-th biased simulation. We can express it in terms of a dimensionless free energy offset, $f_i$, for each window:\n$$\n\\exp(-f_i) = \\sum_{k=1}^{B} P_k \\exp(-U_{ik})\n$$\nThis gives us the first core WHAM equation, which relates the set of unknown probabilities $\\{P_k\\}$ to the set of unknown window free energies $\\{f_i\\}$:\n$$\nf_i = -\\ln \\left( \\sum_{k=1}^{B} P_k \\exp(-U_{ik}) \\right)\n\\quad \\quad \\text{(Equation 1)}\n$$\nTo find the best estimate for $\\{P_j\\}$, we maximize the total log-likelihood of observing the set of all histograms $\\{n_{ij}\\}$. The likelihood function is a product of multinomial probabilities for each simulation. The log-likelihood $\\ln \\mathcal{L}$ is given by:\n$$\n\\ln \\mathcal{L}(\\{P_j\\} | \\{n_{ij}\\}) = \\sum_{i=1}^{M} \\sum_{j=1}^{B} n_{ij} \\ln P(j|i) + \\text{constant}\n$$\nSubstituting $P(j|i) = P_j \\exp(-U_{ij}) \\exp(f_i)$ and using the definition of $f_i$:\n$$\n\\ln \\mathcal{L} = \\sum_{i,j} n_{ij} (\\ln P_j - U_{ij} + f_i) = \\sum_{i,j} n_{ij} \\ln P_j - \\sum_{i,j} n_{ij} U_{ij} + \\sum_i N_i f_i\n$$\nSubstituting Equation 1 for $f_i$:\n$$\n\\ln \\mathcal{L} = \\sum_{j=1}^{B} \\left(\\sum_{i=1}^{M} n_{ij}\\right) \\ln P_j - \\sum_{i=1}^{M} N_i \\ln \\left( \\sum_{k=1}^{B} P_k \\exp(-U_{ik}) \\right) + \\text{constant}\n$$\nWe maximize this function with respect to each $P_j$, subject to the normalization constraint $\\sum_j P_j = 1$, using the method of Lagrange multipliers. Differentiating with respect to $P_j$ and setting the result to zero yields:\n$$\n\\frac{\\partial}{\\partial P_j} \\left[ \\ln \\mathcal{L} - \\lambda \\left(\\sum_k P_k - 1\\right) \\right] = \\frac{\\sum_i n_{ij}}{P_j} - \\sum_{i=1}^{M} N_i \\frac{\\exp(-U_{ij})}{\\sum_k P_k \\exp(-U_{ik})} - \\lambda = 0\n$$\nUsing the definition of $f_i$, this simplifies to:\n$$\n\\frac{\\sum_i n_{ij}}{P_j} = \\sum_{i=1}^{M} N_i \\exp(f_i - U_{ij}) + \\lambda\n$$\nThe Lagrange multiplier $\\lambda$ can be absorbed into the definition of the free energies $f_i$, which are only defined up to an additive constant. Following the standard WHAM derivation, we set $\\lambda=0$ and solve for $P_j$:\n$$\nP_j = \\frac{\\sum_{i=1}^{M} n_{ij}}{\\sum_{k=1}^{M} N_k \\exp(f_k - U_{kj})}\n\\quad \\quad \\text{(Equation 2)}\n$$\nEquations 1 and 2 form a set of self-consistent equations for $\\{P_j\\}$ and $\\{f_i\\}$. They are solved iteratively:\n1.  Initialize the free energies $\\{f_i\\}$, for instance, $f_i = 0$ for all $i$.\n2.  Compute the probability distribution $\\{P_j\\}$ using Equation 2.\n3.  Normalize $\\{P_j\\}$ such that $\\sum_j P_j = 1$.\n4.  Compute new free energies $\\{f_i\\}$ using Equation 1.\n5.  Shift the $\\{f_i\\}$ vector by an additive constant (e.g., set $f_1=0$) to prevent numerical drift.\n6.  Repeat steps 2-5 until the values of $\\{f_i\\}$ converge.\n\n### Implementation for a Periodic Coordinate\n\nFor a circular reaction coordinate $z$, special considerations are necessary to enforce periodicity and continuity.\n- **Angular Distance**: The distance $\\Delta(z,c_i)$ used in the harmonic bias potential $U_i(z) = \\frac{1}{2} k_i \\Delta(z,c_i)^2$ must be the shortest arc distance on the circle. This is calculated as the wrapped angular difference, with values in $[-\\pi, \\pi)$.\n- **Circular Smoothing**: The raw probability distribution $P_j$ obtained from WHAM can be noisy. To obtain a smooth and physically meaningful PMF, $P_j$ is smoothed. For a periodic variable, this is correctly achieved via circular convolution with a periodic kernel. The problem specifies a Von Mises kernel, which is a circular analogue of the normal distribution. For a discretized coordinate with $B$ bins, the kernel centered at bin $0$ has the form $K_b \\propto \\exp(\\kappa \\cos(2\\pi b/B))$ for $b=0,...,B-1$. The convolution of the probability vector $P$ with the kernel vector $K$ is most efficiently calculated using the convolution theorem with Fast Fourier Transforms (FFT): $P_{\\text{smooth}} = \\text{IFFT}(\\text{FFT}(P) \\cdot \\text{FFT}(K))$. The inherent periodicity of the discrete Fourier transform correctly handles the circular boundary conditions.\n\n### From Probability to PMF\n\nThe potential of mean force (PMF), $F(z)$, is related to the probability density $p(z)$ by $F(z) = -k_\\mathrm{B}T \\ln p(z) + C$. In our discretized system, the probability density at bin center $z_j$ is $p(z_j) = P_j / \\Delta z$, where $P_j$ is the probability mass in the bin and $\\Delta z = 2\\pi/B$ is the bin width. Therefore,\n$$\nF(z_j) = -k_\\mathrm{B}T \\ln\\left(\\frac{P_j^{\\text{smooth}}}{\\Delta z}\\right) = -k_\\mathrm{B}T \\ln P_j^{\\text{smooth}} + k_\\mathrm{B}T \\ln(\\Delta z)\n$$\nSince all energies are in units of $k_\\mathrm{B}T$, we set $k_\\mathrm{B}T=1$. The term $\\ln(\\Delta z)$ is a constant that is absorbed into the arbitrary additive constant $C$. The final PMF is calculated as $F_j = -\\ln(P_j^{\\text{smooth}})$ and then shifted by subtracting its minimum value, such that $\\min_j F_j = 0$.\n\n### Synthetic Data and Test Cases\n\nThe program first generates synthetic, deterministic histogram data based on a known true PMF, $F_{\\mathrm{true}}(z) = 1.5 \\cos(2z) - 0.5 \\cos(z)$. For each simulation window $i$, the biased probability distribution is calculated and used to populate the histogram counts $n_{ij} = N_i \\times P(j|i)$. The WHAM algorithm is then applied to this synthetic data to recover the PMF. The specified metrics, boundary continuity $\\delta_F$ and rotation invariance error $E_{\\mathrm{rot}}$, are calculated to validate the correctness and robustness of the implementation, particularly its handling of periodicity.",
            "answer": "```python\nimport numpy as np\nfrom scipy.fft import fft, ifft\n\ndef solve():\n    \"\"\"\n    Main function to run the WHAM analysis for the specified test cases.\n    \"\"\"\n    # Define problem constants\n    BINS = 420\n    TRUE_PMF_A = 1.5\n    TRUE_PMF_B0 = 0.5\n    VON_MISES_KAPPA = 20.0\n    KBT = 1.0  # All energies are in units of k_B*T\n\n    def wrapped_dist(z1, z2):\n        \"\"\"Computes the wrapped angular distance z1 - z2, mapping to [-pi, pi).\"\"\"\n        dist = z1 - z2\n        return (dist + np.pi) % (2 * np.pi) - np.pi\n\n    def generate_synthetic_data(num_bins, centers, stiffnesses, sample_sizes):\n        \"\"\"Generates synthetic deterministic histogram data for umbrella sampling.\"\"\"\n        z_b = (2 * np.pi / num_bins) * (np.arange(num_bins) + 0.5)\n\n        # 1. Define true PMF and corresponding probability mass distribution\n        F_true = TRUE_PMF_A * np.cos(2 * z_b) - TRUE_PMF_B0 * np.cos(z_b)\n        P_true_unnorm = np.exp(-F_true / KBT)\n        P_true_mass = P_true_unnorm / np.sum(P_true_unnorm)\n\n        num_windows = len(centers)\n        n_ij = np.zeros((num_windows, num_bins))\n        U_ij = np.zeros((num_windows, num_bins))\n\n        for i in range(num_windows):\n            # 2. Define bias potential for the window\n            U_ij[i, :] = 0.5 * stiffnesses[i] * wrapped_dist(z_b, centers[i])**2\n\n            # 3. Compute the biased probability distribution\n            P_biased_unnorm = P_true_mass * np.exp(-U_ij[i, :] / KBT)\n            P_biased_mass = P_biased_unnorm / np.sum(P_biased_unnorm)\n\n            # 4. Deterministically assign histogram counts for the window\n            n_ij[i, :] = sample_sizes[i] * P_biased_mass\n\n        return n_ij, U_ij\n\n    def solve_wham(n_ij, U_ij):\n        \"\"\"Solves the self-consistent WHAM equations.\"\"\"\n        num_windows, num_bins = n_ij.shape\n        N_i = n_ij.sum(axis=1)\n        \n        # Initial guess for window free energies\n        f_i = np.zeros(num_windows)\n        \n        max_iter = 10000\n        tolerance = 1e-12\n        \n        for _ in range(max_iter):\n            f_i_old = np.copy(f_i)\n            \n            # Equation 2: Update probability distribution P_j\n            sum_n_j = np.sum(n_ij, axis=0)\n            denominator_P = np.sum(N_i[:, np.newaxis] * np.exp((f_i[:, np.newaxis] - U_ij) / KBT), axis=0)\n            P_j = sum_n_j / denominator_P\n            P_j /= np.sum(P_j)  # Normalize probability mass\n\n            # Equation 1: Update free energies f_i\n            sum_term = np.sum(P_j[np.newaxis, :] * np.exp(-U_ij / KBT), axis=1)\n            # Add a small epsilon to prevent log(0) in case of no overlap, though unlikely here.\n            f_i = -KBT * np.log(sum_term + 1e-100)\n            \n            # Shift free energies to prevent numerical drift (f_0 = 0)\n            f_i -= f_i[0]\n            \n            # Check for convergence\n            diff = np.max(np.abs(f_i - f_i_old))\n            if diff < tolerance:\n                break\n        \n        return P_j\n\n    def smooth_and_get_pmf(P_j, num_bins, kappa):\n        \"\"\"Smooths probability distribution with a Von Mises kernel and computes the PMF.\"\"\"\n        \n        # 1. Define Von Mises kernel for circular convolution\n        b_indices = np.arange(num_bins)\n        kernel = np.exp(kappa * np.cos(2 * np.pi * b_indices / num_bins))\n        kernel /= np.sum(kernel) # Normalize kernel\n\n        # 2. Perform circular convolution using FFT\n        P_fft = fft(P_j)\n        kernel_fft = fft(kernel)\n        P_smooth_fft = P_fft * kernel_fft\n        P_smooth_j = np.real(ifft(P_smooth_fft))\n        P_smooth_j /= np.sum(P_smooth_j) # Re-normalize after FFT\n\n        # 3. Calculate PMF from smoothed probability mass\n        # The conversion from mass to density adds a constant log(delta_z)\n        # which is absorbed when shifting the minimum to zero.\n        pmf = -KBT * np.log(P_smooth_j + 1e-100) # Add epsilon to avoid log(0)\n        pmf -= np.min(pmf) # Shift PMF so that min is 0\n        \n        return pmf\n\n    def run_case(centers, stiffnesses, samples, kappa, num_bins):\n        \"\"\"Helper func to run one full WHAM calculation.\"\"\"\n        n_ij, U_ij = generate_synthetic_data(num_bins, centers, stiffnesses, samples)\n        P_j = solve_wham(n_ij, U_ij)\n        pmf = smooth_and_get_pmf(P_j, num_bins, kappa)\n        return pmf\n\n    results = []\n\n    # Test Case 1: Happy path coverage\n    M1 = 8\n    centers1 = (2 * np.pi / M1) * np.arange(M1)\n    stiffnesses1 = np.full(M1, 20.0)\n    samples1 = np.full(M1, 50000)\n    pmf_1 = run_case(centers1, stiffnesses1, samples1, VON_MISES_KAPPA, BINS)\n    delta_F_1 = np.abs(pmf_1[-1] - pmf_1[0])\n    results.append(delta_F_1)\n\n    # Test Case 2: Sparse boundary coverage\n    M2 = 3\n    centers2 = np.array([np.pi/2.0, np.pi, 3.0*np.pi/2.0])\n    stiffnesses2 = np.full(M2, 25.0)\n    samples2 = np.full(M2, 10000)\n    pmf_2 = run_case(centers2, stiffnesses2, samples2, VON_MISES_KAPPA, BINS)\n    delta_F_2 = np.abs(pmf_2[-1] - pmf_2[0])\n    results.append(delta_F_2)\n\n    # Test Case 3: Rotation invariance\n    # The original PMF is pmf_1 from test case 1.\n    delta_rot = 2 * np.pi / 7\n    centers3 = (centers1 + delta_rot) % (2 * np.pi)\n    s_shift = 60 # Shift in bins corresponding to delta_rot (420/7)\n    \n    # Run WHAM on rotated configuration\n    pmf_3_rot = run_case(centers3, stiffnesses1, samples1, VON_MISES_KAPPA, BINS)\n    \n    # Align the rotated PMF back to the original frame by a circular shift\n    # A positive rotation of centers moves features to higher indices.\n    # To align back, we need to shift the PMF data to lower indices (negative roll).\n    pmf_3_aligned = np.roll(pmf_3_rot, -s_shift)\n    \n    # Calculate the max absolute error between original and aligned-rotated PMF\n    E_rot = np.max(np.abs(pmf_3_aligned - pmf_1))\n    results.append(E_rot)\n\n    print(f\"[{','.join(f'{r:.12f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}