{
    "hands_on_practices": [
        {
            "introduction": "加速探索之后，我们必须校正引入的偏差以恢复准确的热力学性质。本练习将指导您完成使用形式为 $w_i = \\exp(\\beta \\Delta V_i)$ 的重要性权重对数据进行重加权的核心过程 。更关键的是，您还将实现一种专门的自举法 (bootstrap) 来估计重加权平均值的不确定性，这是从增强采样中评估结果统计质量的一项至关重要的技能。",
            "id": "3834984",
            "problem": "您正在研究加速分子动力学 (Accelerated Molecular Dynamics, aMD)，该方法通过修改势能面来增强对稀有事件的采样。aMD 中的采样分布与真实的正则分布不同，因此需要进行重加权以恢复无偏的系综平均值。请从分子动力学 (MD) 中的正则系综出发，其中概率密度与真实势能的玻尔兹曼因子成正比，利用第一性原理推导在 aMD 的修正势下采样时为何必须进行重加权，以及重要性权重是如何产生的。然后，给定采样的提升势移和可观测量值，实现一个算法来计算重加权平均值，并使用一种自举法 (bootstrap) 来估计其不确定度，该方法通过重采样权重来解决重尾重要性权重问题。\n\n使用以下背景和要求：\n\n- 从平衡统计力学的正则系综开始。真实势能记为 $U(\\mathbf{r})$，加速分子动力学下的修正势记为 $U^{\\ast}(\\mathbf{r})$，提升势为 $\\Delta V(\\mathbf{r})$，使得 $U^{\\ast}(\\mathbf{r}) = U(\\mathbf{r}) + \\Delta V(\\mathbf{r})$。\n- 绝对温度为 $T$ 的正则系综的概率密度与 $\\exp\\left(-\\beta U(\\mathbf{r})\\right)$ 成正比，其中逆热能为 $\\beta = 1/(k_{\\mathrm{B}} T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数。\n- 根据上述正则系综的事实和修正势的定义，推导出将从修正分布计算出的期望值重加权回真实分布所需的重要性采样权重。\n\n程序要求：\n\n- 输入参数在您的程序中硬编码。没有用户输入。\n- 物理单位：$\\Delta V$ 使用千卡/摩尔 (kcal/mol)，温度使用开尔文 (K)，并设置 $k_{\\mathrm{B}} = 0.0019872041$，单位为千卡/摩尔/开尔文 (kcal/mol/K)。计算 $\\beta = 1/(k_{\\mathrm{B}} T)$，单位为 1/(千卡/摩尔)。\n- 对于每个测试用例，您将获得：\n  - 一个以开尔文为单位的温度 $T$。\n  - 一个采样的提升势值列表 $\\{\\Delta V_i\\}$，单位为千卡/摩尔。\n  - 一个可观测量值列表 $\\{A_i\\}$（无量纲）。\n- 使用从第一性原理推导出的权重，计算可观测量的重加权平均值，记为 $\\hat{A}$。为处理重尾权重，请实现数值稳定的计算。然后，通过对权重进行乘法重采样（使用独立的正常数因子）来估计不确定度，即自举标准差，以捕捉由重尾重要性权重引起的可变性。使用 $5000$ 次自举复制和固定的随机种子以保证确定性。\n- 您的算法必须能稳健地处理边界和边缘情况，包括所有 $\\Delta V_i$ 相等的情况和只有一个样本的情况。\n- 每个测试用例的最终输出是两个实数：重加权平均值 $\\hat{A}$ 和自举不确定度 $\\sigma_{\\hat{A}}$。两者都表示为十进制浮点数。\n- 测试套件：\n  1. $T = 300$, $\\Delta V = [-0.4, 0.1, 0.0, 1.2, -0.8, 0.5, 0.3]$, $A = [1.25, 0.72, 0.95, 1.85, 1.05, 1.42, 0.88]$。\n  2. $T = 310$, $\\Delta V = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]$, $A = [1.10, 0.90, 1.00, 1.20, 0.80, 1.05]$。\n  3. $T = 300$, $\\Delta V = [0.0, 8.0, -2.0, 6.0, 0.5, -0.3, 4.0]$, $A = [0.90, 2.50, 0.70, 1.80, 1.20, 1.00, 2.00]$。\n  4. $T = 298$, $\\Delta V = [0.7]$, $A = [1.33]$。\n- 最终输出格式：您的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表。该列表必须按 $[\\hat{A}_1, \\sigma_{\\hat{A},1}, \\hat{A}_2, \\sigma_{\\hat{A},2}, \\hat{A}_3, \\sigma_{\\hat{A},3}, \\hat{A}_4, \\sigma_{\\hat{A},4}]$ 的顺序扁平化，其中下标表示测试用例索引。将每个浮点数四舍五入到 $6$ 位小数。\n\n您的实现必须是一个完整、可运行的程序，能够为提供的测试套件计算所需的输出，并以指定的精确格式打印它们。",
            "solution": "该问题要求从第一性原理推导加速分子动力学 (aMD) 中使用的重加权方案，并实现一个算法来计算重加权的可观测量及其不确定度。\n\n### 原理与推导\n\n该问题的基础在于平衡统计力学和重要性采样理论。在一个与恒定体积 $V$ 和温度 $T$ 的热浴处于热平衡的经典系统中，发现系统处于具有构型 $\\mathbf{r}$ 和势能 $U(\\mathbf{r})$ 的特定微观状态的概率由正则系综的玻尔兹曼分布给出。\n\n概率密度函数 $p_U(\\mathbf{r})$ 与玻尔兹曼因子成正比：\n$$ p_U(\\mathbf{r}) = \\frac{e^{-\\beta U(\\mathbf{r})}}{Z_U} $$\n其中 $\\beta = 1/(k_{\\mathrm{B}} T)$ 是逆热能，$k_{\\mathrm{B}}$ 是玻尔兹曼常数，$Z_U$ 是正则配分函数，它作为归一化常数：\n$$ Z_U = \\int e^{-\\beta U(\\mathbf{r})} \\, d\\mathbf{r} $$\n该积分遍及所有可能的构型 $\\mathbf{r}$。\n\n物理可观测量 $A(\\mathbf{r})$ 的系综平均是其在此概率分布上的期望值：\n$$ \\langle A \\rangle_U = \\int A(\\mathbf{r}) p_U(\\mathbf{r}) \\, d\\mathbf{r} = \\frac{\\int A(\\mathbf{r}) e^{-\\beta U(\\mathbf{r})} \\, d\\mathbf{r}}{\\int e^{-\\beta U(\\mathbf{r})} \\, d\\mathbf{r}} $$\n\n在加速分子动力学 (aMD) 中，当原始势低于某个阈值时，通过添加一个非负的提升势 $\\Delta V(\\mathbf{r})$ 来修改势能面 $U(\\mathbf{r})$，否则提升势为零。为了一般性，我们将修正势表示为 $U^{\\ast}(\\mathbf{r}) = U(\\mathbf{r}) + \\Delta V(\\mathbf{r})$。在此外修正势下运行的模拟会从一个不同的概率分布 $p_{U^{\\ast}}(\\mathbf{r})$ 中采样构型：\n$$ p_{U^{\\ast}}(\\mathbf{r}) = \\frac{e^{-\\beta U^{\\ast}(\\mathbf{r})}}{Z_{U^{\\ast}}} $$\n其中 $Z_{U^{\\ast}} = \\int e^{-\\beta U^{\\ast}(\\mathbf{r})} \\, d\\mathbf{r}$。\n\n直接对 aMD 轨迹上的可观测量 $A$ 进行平均会得到一个不正确的、有偏的估计 $\\langle A \\rangle_{U^{\\ast}}$。为了恢复正确的正则平均 $\\langle A \\rangle_U$，我们必须对样本进行重加权。这是重要性采样的一个应用。\n\n我们可以通过用修正系综来重写积分，从而表达 $\\langle A \\rangle_U$。我们在 $\\langle A \\rangle_U$ 的表达式中，将被积函数同时乘以和除以 $e^{-\\beta U^{\\ast}(\\mathbf{r})}$：\n$$ \\langle A \\rangle_U = \\frac{\\int A(\\mathbf{r}) \\frac{e^{-\\beta U(\\mathbf{r})}}{e^{-\\beta U^{\\ast}(\\mathbf{r})}} e^{-\\beta U^{\\ast}(\\mathbf{r})} \\, d\\mathbf{r}}{\\int \\frac{e^{-\\beta U(\\mathbf{r})}}{e^{-\\beta U^{\\ast}(\\mathbf{r})}} e^{-\\beta U^{\\ast}(\\mathbf{r})} \\, d\\mathbf{r}} $$\n积分内的比率充当重加权因子，或称为重要性权重。我们定义这个权重为 $w(\\mathbf{r})$：\n$$ w(\\mathbf{r}) = \\frac{e^{-\\beta U(\\mathbf{r})}}{e^{-\\beta U^{\\ast}(\\mathbf{r})}} = \\frac{e^{-\\beta U(\\mathbf{r})}}{e^{-\\beta (U(\\mathbf{r}) + \\Delta V(\\mathbf{r}))}} = \\frac{e^{-\\beta U(\\mathbf{r})}}{e^{-\\beta U(\\mathbf{r})} e^{-\\beta \\Delta V(\\mathbf{r})}} = e^{\\beta \\Delta V(\\mathbf{r})} $$\n每个构型的权重是该构型上施加的提升势乘以 $\\beta$ 后的指数。\n\n将 $w(\\mathbf{r})$ 代回 $\\langle A \\rangle_U$ 的表达式中：\n$$ \\langle A \\rangle_U = \\frac{\\int A(\\mathbf{r}) w(\\mathbf{r}) e^{-\\beta U^{\\ast}(\\mathbf{r})} \\, d\\mathbf{r}}{\\int w(\\mathbf{r}) e^{-\\beta U^{\\ast}(\\mathbf{r})} \\, d\\mathbf{r}} $$\n通过将分子和分母除以修正配分函数 $Z_{U^{\\ast}}$，我们可以将其表示为在修正 ($U^{\\ast}$) 系综中计算的期望值：\n$$ \\langle A \\rangle_U = \\frac{\\langle A \\cdot w \\rangle_{U^{\\ast}}}{\\langle w \\rangle_{U^{\\ast}}} $$\n这就是基本的重加权方程。\n\n在模拟中，我们从 $p_{U^{\\ast}}$ 生成一个包含 $N$ 个快照的离散轨迹 $\\{\\mathbf{r}_1, \\mathbf{r}_2, \\dots, \\mathbf{r}_N\\}$。系综平均通过对这些快照的算术平均来估计。真实正则平均的估计量，记为 $\\hat{A}$，是：\n$$ \\hat{A} = \\frac{\\frac{1}{N} \\sum_{i=1}^{N} A(\\mathbf{r}_i) w(\\mathbf{r}_i)}{\\frac{1}{N} \\sum_{i=1}^{N} w(\\mathbf{r}_i)} = \\frac{\\sum_{i=1}^{N} A_i w_i}{\\sum_{i=1}^{N} w_i} $$\n其中 $A_i = A(\\mathbf{r}_i)$ 且 $w_i = e^{\\beta \\Delta V_i}$，而 $\\Delta V_i = \\Delta V(\\mathbf{r}_i)$。\n\n### 算法设计\n\n**1. 重加权平均计算：**\n给定一组采样的提升势 $\\{\\Delta V_i\\}$ 和相应的可观测量 $\\{A_i\\}$，计算过程如下。\n首先，计算 $\\beta = 1/(k_{\\mathrm{B}} T)$。\n然后，计算权重 $w_i = e^{\\beta \\Delta V_i}$。$\\beta \\Delta V_i$ 的值可能很大，导致数值溢出。为确保稳定性，我们使用标准的 'log-sum-exp' 技巧。令 $c = \\max_i(\\beta \\Delta V_i)$。我们计算缩放后的权重 $w'_i = e^{\\beta \\Delta V_i - c}$。重加权平均则为：\n$$ \\hat{A} = \\frac{\\sum_{i=1}^{N} A_i e^{\\beta \\Delta V_i}}{\\sum_{i=1}^{N} e^{\\beta \\Delta V_i}} = \\frac{\\sum_{i=1}^{N} A_i e^{\\beta \\Delta V_i - c}}{\\sum_{i=1}^{N} e^{\\beta \\Delta V_i - c}} = \\frac{\\sum_{i=1}^{N} A_i w'_i}{\\sum_{i=1}^{N} w'_i} $$\n这种形式在数值上是鲁棒的，因为最大的指数现在是 $0$。\n\n**2. 不确定度估计：**\n权重 $w_i$ 通常具有重尾分布，这意味着少数几个快照可能会主导总和。标准误差公式在这种情况下不可靠。问题指定了一种适用于这种情况的自举法程序。它涉及用独立的正常数因子对权重进行乘法重采样。这是贝叶斯自举法的一个变体，其中新权重是通过将原始权重乘以从均值为 $1$ 的指数分布中抽取的随机数来生成的。\n\n算法如下：\n1.  为保证可复现性，设置一个固定的随机种子。\n2.  对于固定数量的自举复制，$B = 5000$：\n    a. 对于 $N$ 个原始样本中的每一个，从指数分布中抽取一个随机数 $g_i$，即 $g_i \\sim \\text{Exponential}(1)$。\n    b. 为复制 $b$ 创建一组新的自举权重：$w''_{i,b} = w'_i \\cdot g_i$。\n    c. 计算平均值的自举估计：$\\hat{A}_b = \\frac{\\sum_{i=1}^{N} A_i w''_{i,b}}{\\sum_{i=1}^{N} w''_{i,b}}$。\n3.  集合 $\\{\\hat{A}_1, \\hat{A}_2, \\dots, \\hat{A}_B\\}$ 构成了均值的自举分布。\n4.  不确定度 $\\sigma_{\\hat{A}}$ 被估计为该自举分布的样本标准差：\n$$ \\sigma_{\\hat{A}} = \\sqrt{\\frac{1}{B-1} \\sum_{b=1}^{B} (\\hat{A}_b - \\bar{A}_{\\text{boot}})^2} $$\n其中 $\\bar{A}_{\\text{boot}}$ 是自举估计的均值。\n\n**处理边缘情况：**\n- 如果所有的 $\\Delta V_i$ 都相同，则所有的权重 $w_i$ 都相等。$\\hat{A}$ 的公式正确地简化为 $\\{A_i\\}$ 的简单算术平均。\n- 如果只给出一个样本 ($N=1$)，重加权平均就是它自身的值，$\\hat{A} = A_1$。自举法程序将对所有复制都产生 $\\hat{A}_b = A_1$，导致不确定度 $\\sigma_{\\hat{A}} = 0$，这对于单一样本估计来说是一个逻辑上合理的结果。\n\n这种基于原理的方法既提供了正则平均的鲁棒估计，也提供了其统计不确定度的可靠度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef compute_reweighted_stats(T, dV, A, k_B, n_bootstrap, rng):\n    \"\"\"\n    Computes the reweighted average and its uncertainty for aMD data.\n\n    Args:\n        T (float): Temperature in Kelvin.\n        dV (list or np.ndarray): List of sampled boost potential values in kcal/mol.\n        A (list or np.ndarray): List of corresponding observable values.\n        k_B (float): Boltzmann constant in kcal/mol/K.\n        n_bootstrap (int): Number of bootstrap replicates.\n        rng (np.random.Generator): NumPy random number generator for reproducibility.\n\n    Returns:\n        tuple: A tuple containing the reweighted mean and its bootstrap uncertainty.\n    \"\"\"\n    dV = np.asarray(dV, dtype=np.float64)\n    A = np.asarray(A, dtype=np.float64)\n    N = len(A)\n\n    # Handle edge case: no samples\n    if N == 0:\n        return np.nan, np.nan\n\n    # Handle edge case: single sample\n    if N == 1:\n        return A[0], 0.0\n\n    # Calculate inverse thermal energy\n    beta = 1.0 / (k_B * T)\n\n    # Calculate log-weights for numerical stability\n    beta_dV = beta * dV\n    # The max subtraction ensures the largest weight is exp(0)=1, preventing overflow.\n    log_weights = beta_dV - np.max(beta_dV)\n    weights = np.exp(log_weights)\n\n    # Calculate the reweighted average\n    sum_weights = np.sum(weights)\n    if sum_weights > 0:\n        reweighted_mean = np.sum(A * weights) / sum_weights\n    else:\n        # This case is highly unlikely with the stable weight calculation unless N=0\n        reweighted_mean = np.mean(A)\n\n    # Estimate uncertainty using a multiplicative (Bayesian-like) bootstrap\n    bootstrap_means = np.empty(n_bootstrap)\n    for i in range(n_bootstrap):\n        # Generate positive random factors from an Exponential(1) distribution\n        g = rng.exponential(scale=1.0, size=N)\n        \n        # Create bootstrap weights by re-scaling original weights\n        bootstrap_weights = weights * g\n        \n        sum_bootstrap_weights = np.sum(bootstrap_weights)\n        if sum_bootstrap_weights > 0:\n            bootstrap_means[i] = np.sum(A * bootstrap_weights) / sum_bootstrap_weights\n        else:\n            # This case is also extremely unlikely\n            bootstrap_means[i] = np.nan\n\n    # Compute bootstrap standard deviation (ddof=1 for sample standard deviation)\n    uncertainty = np.nanstd(bootstrap_means, ddof=1)\n    \n    return reweighted_mean, uncertainty\n\ndef solve():\n    \"\"\"\n    Main function to run the test cases and print the final results.\n    \"\"\"\n    # Define physical constants and algorithm parameters\n    k_B = 0.0019872041  # Boltzmann constant in kcal/mol/K\n    N_BOOTSTRAP = 5000\n    SEED = 42  # Fixed seed for deterministic results\n\n    # Initialize a random number generator\n    rng = np.random.default_rng(SEED)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'T': 300, 'dV': [-0.4, 0.1, 0.0, 1.2, -0.8, 0.5, 0.3], 'A': [1.25, 0.72, 0.95, 1.85, 1.05, 1.42, 0.88]},\n        {'T': 310, 'dV': [0.0, 0.0, 0.0, 0.0, 0.0, 0.0], 'A': [1.10, 0.90, 1.00, 1.20, 0.80, 1.05]},\n        {'T': 300, 'dV': [0.0, 8.0, -2.0, 6.0, 0.5, -0.3, 4.0], 'A': [0.90, 2.50, 0.70, 1.80, 1.20, 1.00, 2.00]},\n        {'T': 298, 'dV': [0.7], 'A': [1.33]}\n    ]\n\n    results = []\n    for case in test_cases:\n        mean, uncertainty = compute_reweighted_stats(\n            case['T'], case['dV'], case['A'], k_B, N_BOOTSTRAP, rng\n        )\n        results.extend([mean, uncertainty])\n\n    # Final print statement in the exact required format.\n    # Each value is formatted to 6 decimal places.\n    formatted_results = [f'{x:.6f}' for x in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "尽管重加权可以校正偏差，但这通常以牺牲统计效率为代价，特别是当少数几个快照的权重占主导地位时。最后一个练习将介绍有效样本量 (Effective Sample Size, ESS)，这是一个量化这种效率损失的关键指标 。通过实现 ESS 的计算，您将学会如何诊断增强采样数据的质量，并评估所计算平均值的可靠性。",
            "id": "3834993",
            "problem": "您正在研究加速分子动力学 (aMD)，该方法通过在偏置势下抽样轨迹以改善探索，然后将可观测量重加权回到正则系综。设 $w_i$ 表示在 aMD 偏置引起的抽样分布下抽取的 $N$ 个样本所对应的非负重要性权重，其中 $i \\in \\{1,\\dots,N\\}$，并设归一化权重为 $\\tilde{w}_i = w_i \\big/ \\sum_{j=1}^{N} w_j$。从统计力学和计算化学生物学中的重要性抽样原理出发，推导有效样本量 $N_{\\mathrm{eff}}$ 仅用未归一化权重 $w_i$ 表示的通用表达式。您的推导必须从以下基本基础开始：\n- 正则系综的概率密度为 $\\pi(x) \\propto \\exp(-\\beta U(x))$，其中 $x$ 为构型，其势能为 $U(x)$，逆温度为 $\\beta = 1/(k_{\\mathrm{B}} T)$，$k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是绝对温度。\n- 在加速分子动力学 (aMD) 中，模拟在修改后的势 $U'(x) = U(x) + \\Delta U(x)$ 下进行，并使用重要性权重 $w(x) \\propto \\pi(x)/q(x)$ 重加权到 $\\pi(x)$，其中抽样密度为 $q(x) \\propto \\exp(-\\beta U'(x))$。因此，$w(x)$ 是非负的，并且可以归一化为 $\\tilde{w}_i$，使得 $\\sum_{i=1}^{N} \\tilde{w}_i = 1$。\n- 自归一化重要性抽样估计量的方差取决于归一化权重 $\\tilde{w}_i$ 的离散程度。在权重相等的情况下，有效独立样本数等于总数 $N$。\n\n基于此，推导出一个 $N_{\\mathrm{eff}}$ 的表达式，该表达式在所有权重相等时恢复为 $N$，并随着权重分布变得更加异构而减小。然后，实现一个程序，为下列每个权重测试用例计算此 $N_{\\mathrm{eff}}$。所有权重都是无量纲的。每个测试用例所需的输出是小数点后保留六位的小数。\n\n测试套件：\n- 用例 1：$[1,1,1,1,1]$。\n- 用例 2：$[10,0,0,0,0]$。\n- 用例 3：$[0.1,0.2,0.3,0.4]$。\n- 用例 4：$[100,200,300,400]$。\n- 用例 5：$[0.5,0.5,0.5,0.5,0.5,0.5]$。\n- 用例 6：$[2,1,1,1,1]$。\n- 用例 7：$[10^{-100}, 1, 10^{-50}, 10^{-25}]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表内无空格，结果按上述用例的顺序排列（例如，$[r_1,r_2,\\dots,r_7]$）。每个 $r_i$ 必须是对应案例计算出的 $N_{\\mathrm{eff}}$，四舍五入到小数点后六位。",
            "solution": "所述问题是有效的。它在科学上基于应用于计算化学生物学，特别是加速分子动力学 (aMD) 的统计力学和重要性抽样原理。该问题表述清晰、客观，并包含足够的信息来推导有效样本量 $N_{\\mathrm{eff}}$ 所需的表达式。其前提条件一致且符合事实。因此，我们可以进行正式推导。\n\n目标是为一个通过偏置模拟获得的包含 $N$ 个样本的集合，推导有效样本量 $N_{\\mathrm{eff}}$ 的通用表达式，该表达式仅用它们的未归一化重要性权重 $w_i \\ge 0$ 表示。推导必须满足两个关键性质：($1$) 当所有权重相等时，$N_{\\mathrm{eff}} = N$；($2$) 随着权重异构性的增加，$N_{\\mathrm{eff}}$ 减小。\n\n我们的出发点是可观测量 $A(x)$ 的正则期望值（记为 $\\langle A \\rangle_{\\pi}$）的自归一化重要性抽样估计量。给定从偏置概率密度 $q(x)$ 中抽取的 $N$ 个构型 $\\{x_i\\}$，该估计量为：\n$$\n\\hat{A}_N = \\frac{\\sum_{i=1}^{N} A(x_i) w_i}{\\sum_{j=1}^{N} w_j} = \\sum_{i=1}^{N} A(x_i) \\tilde{w}_i\n$$\n这里，$w_i = \\pi(x_i)/q(x_i)$ 是未归一化的重要性权重，$\\tilde{w}_i = w_i / \\sum_{j=1}^{N} w_j$ 是相应的归一化权重，满足 $\\sum_{i=1}^{N} \\tilde{w}_i = 1$。在 aMD 的背景下，$w_i = \\exp(\\beta \\Delta U(x_i))$，其中 $\\Delta U(x_i)$ 是施加于构型 $x_i$ 的偏置势。\n\n有效样本量 $N_{\\mathrm{eff}}$ 的概念为重要性样本的质量提供了一个直观的度量。它的定义是通过将重要性抽样估计量的方差与从目标分布 $\\pi(x)$ 直接抽取的 $N_{\\mathrm{eff}}$ 个独立样本获得的理想估计量的方差相关联。\n\n来自 $\\pi(x)$ 的 $N_{\\mathrm{ideal}}$ 个独立样本的估计量的方差为 $\\mathrm{Var}_{\\pi}(A) / N_{\\mathrm{ideal}}$。我们旨在找到一个值 $N_{\\mathrm{eff}}$，使其在我们的重要性抽样估计量中扮演 $N_{\\mathrm{ideal}}$ 的角色。\n\n重要性抽样理论中的一个标准结果将自归一化估计量 $\\hat{A}_N$ 的方差近似为与归一化权重平方和成正比：\n$$\n\\mathrm{Var}(\\hat{A}_N) \\approx \\mathrm{Var}_{\\pi}(A) \\left( \\sum_{i=1}^{N} \\tilde{w}_i^2 \\right)\n$$\n这个近似抓住了关键事实，即估计的方差因权重的不均匀性而增大。当一个或少数几个权重占主导地位时，总和 $\\sum \\tilde{w}_i^2$ 趋近于 $1$，导致高方差。相反，当所有权重都相等时（$\\tilde{w}_i = 1/N$），该总和在 $N(1/N)^2 = 1/N$ 处达到最小值，从而为大小为 $N$ 的样本带来可能的最低方差。\n\n通过将我们的估计量的方差与大小为 $N_{\\mathrm{eff}}$ 的理想估计量的方差相等，我们得到：\n$$\n\\frac{\\mathrm{Var}_{\\pi}(A)}{N_{\\mathrm{eff}}} \\approx \\mathrm{Var}_{\\pi}(A) \\left( \\sum_{i=1}^{N} \\tilde{w}_i^2 \\right)\n$$\n消去公因子 $\\mathrm{Var}_{\\pi}(A)$，我们得到用归一化权重表示的 $N_{\\mathrm{eff}}$ 定义：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^{N} \\tilde{w}_i^2}\n$$\n问题要求用未归一化权重 $w_i$ 来表示这个表达式。我们代入 $\\tilde{w}_i$ 的定义：\n$$\nN_{\\mathrm{eff}} = \\frac{1}{\\sum_{i=1}^{N} \\left( \\frac{w_i}{\\sum_{j=1}^{N} w_j} \\right)^2} = \\frac{1}{\\frac{\\sum_{i=1}^{N} w_i^2}{\\left(\\sum_{j=1}^{N} w_j\\right)^2}}\n$$\n这简化为最终所需表达式：\n$$\nN_{\\mathrm{eff}} = \\frac{\\left(\\sum_{i=1}^{N} w_i\\right)^2}{\\sum_{i=1}^{N} w_i^2}\n$$\n该公式仅依赖于未归一化权重 $w_i$，符合要求。\n\n我们现在根据指定条件验证此结果。\n\n1.  **权重相等：** 设对于所有 $i \\in \\{1, \\dots, N\\}$，$w_i = c$，其中 $c  0$ 是一个常数。\n    和为 $\\sum_{i=1}^{N} w_i = Nc$。\n    平方和为 $\\sum_{i=1}^{N} w_i^2 = Nc^2$。\n    $$\n    N_{\\mathrm{eff}} = \\frac{(Nc)^2}{Nc^2} = \\frac{N^2 c^2}{N c^2} = N\n    $$\n    条件满足。\n\n2.  **异构权重：** 该表达式可以根据权重的变异系数 $CV_w = \\sigma_w / \\bar{w}$ 重写，其中 $\\bar{w}$ 是权重的平均值，$\\sigma_w$ 是权重的标准差。该公式等价于 $N_{\\mathrm{eff}} = N / (1 + CV_w^2)$。随着权重异构性的增加，$CV_w$ 增加，因此，$N_{\\mathrm{eff}}$ 从其最大值 $N$（当 $CV_w = 0$ 时）向其最小值 $1$（在一个权重远超其他所有权重的极限情况下）减小。条件满足。\n\n推导至此结束。所推导的公式是稳健、通用的，并符合问题陈述中概述的基本原理。我们现在将此公式应用于所提供的测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the effective sample size for a series of weight sets\n    and prints the results in the specified format.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        [1.0, 1.0, 1.0, 1.0, 1.0],\n        [10.0, 0.0, 0.0, 0.0, 0.0],\n        [0.1, 0.2, 0.3, 0.4],\n        [100.0, 200.0, 300.0, 400.0],\n        [0.5, 0.5, 0.5, 0.5, 0.5, 0.5],\n        [2.0, 1.0, 1.0, 1.0, 1.0],\n        [1.0e-100, 1.0, 1.0e-50, 1.0e-25]\n    ]\n\n    results = []\n    for case in test_cases:\n        # Main logic to calculate the result for one case goes here.\n        # Convert the list of weights to a NumPy array for efficient computation.\n        # Using float64 for standard double-precision floating-point arithmetic.\n        weights = np.array(case, dtype=np.float64)\n        \n        # Calculate the sum of the squares of the weights.\n        sum_of_squares = np.sum(weights**2)\n        \n        # The formula for effective sample size is (sum(w))^2 / sum(w^2).\n        # We must handle the edge case where all weights are zero to avoid division by zero.\n        if sum_of_squares == 0.0:\n            result = 0.0\n        else:\n            # Calculate the sum of the weights.\n            sum_of_weights = np.sum(weights)\n            # Apply the derived formula.\n            result = sum_of_weights**2 / sum_of_squares\n            \n        # Format the result to six decimal places and add to the list.\n        results.append(f\"{result:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "加速分子动力学通过改变控制粒子运动的力来增强采样。第一个练习将直接展示这一机制，通过计算力缩放因子 。通过推导并应用该因子的公式，您将定量地理解模拟参数 $E$ 和 $\\alpha$ 如何在势能面的不同区域调节“加速”的程度。",
            "id": "3835021",
            "problem": "在加速分子动力学 (aMD) 中，通过引入一个提升势来修改分子模拟中的物理力，从而在保持可重加权性的同时加速势垒穿越。考虑一个系统，其原始势能函数为 $V(\\mathbf{r})$，根据牛顿第二定律，其对应的力为 $-\\nabla V(\\mathbf{r})$。在 aMD 中，修改后的势能定义为 $V^{\\ast}(\\mathbf{r}) = V(\\mathbf{r}) + \\Delta V(V(\\mathbf{r}))$，其中提升势 $\\Delta V$ 仅在瞬时势能低于阈值能量 $E$ 时施加，并由以下成熟的 aMD 形式给出\n$$\n\\Delta V(V) =\n\\begin{cases}\n\\dfrac{(E - V)^{2}}{\\alpha + (E - V)},  V  E, \\\\\n0,  V \\ge E,\n\\end{cases}\n$$\n其中 $\\alpha > 0$ 是一个调节参数，用于设定提升势的强度和平滑度。由于 $\\Delta V$ 仅是 $V$ 的函数，修改后的力可以使用链式法则写为 $-\\nabla V^{\\ast}(\\mathbf{r}) = -\\left(1 + \\dfrac{d\\Delta V}{dV}\\right)\\nabla V(\\mathbf{r})$。乘法因子 $s(V) \\equiv 1 + \\dfrac{d\\Delta V}{dV}$ 量化了相对于原始动力学，力的量值的局域调制。\n\n使用以上信息，为下列参数和势能值计算力标度因子 $s_i = s(V_i)$，所有势能值均满足 $V_i  E$：\n- 阈值能量 $E = 120$ kJ mol$^{-1}$，\n- 加速参数 $\\alpha = 30$ kJ mol$^{-1}$，\n- 势能 $\\{V_i\\} = \\{110,\\ 100,\\ 80,\\ 40,\\ 0\\}$ kJ mol$^{-1}$。\n\n以单个行向量的形式，并按照给定 $\\{V_i\\}$ 的顺序报告标度因子。将最终的标度因子表示为无量纲的小数，并四舍五入到四位有效数字。最终答案中不要包含单位。",
            "solution": "首先验证问题以确保其具有科学依据、提法恰当，并包含所有必要信息。\n\n**1. 提取已知条件：**\n- 加速分子动力学 (aMD) 中的修改势能：$V^{\\ast}(\\mathbf{r}) = V(\\mathbf{r}) + \\Delta V(V(\\mathbf{r}))$。\n- 当 $V  E$ 时的提升势：$\\Delta V(V) = \\dfrac{(E - V)^{2}}{\\alpha + (E - V)}$。\n- 当 $V \\ge E$ 时的提升势：$\\Delta V(V) = 0$。\n- 修改后的力表达式：$-\\nabla V^{\\ast}(\\mathbf{r}) = -s(V)\\nabla V(\\mathbf{r})$，其中 $s(V)$ 是力标度因子。\n- 力标度因子的定义：$s(V) \\equiv 1 + \\dfrac{d\\Delta V}{dV}$。\n- 阈值能量：$E = 120$ kJ mol$^{-1}$。\n- 加速参数：$\\alpha = 30$ kJ mol$^{-1}$。\n- 一组势能值：$\\{V_i\\} = \\{110,\\ 100,\\ 80,\\ 40,\\ 0\\}$ kJ mol$^{-1}$。\n- 已指明所有给定的 $V_i$ 均满足条件 $V_i  E$。\n\n**2. 验证：**\n该问题在科学上是合理的，因为它使用了双重提升 aMD 的标准公式，这是一种在计算化学中广泛使用的增强采样技术。所有定义都是标准的，所提供的参数（$E$, $\\alpha$, $V_i$）在物理上是现实的，并且在量纲上是一致的。该问题提法恰当、完整且客观，为获得唯一解提供了所有必要信息。因此，该问题被认为是有效的。\n\n**3. 求解推导：**\n任务是为给定的势能值计算力标度因子 $s_i = s(V_i)$。标度因子定义为 $s(V) = 1 + \\dfrac{d\\Delta V}{dV}$。\n\n首先，我们必须求出在 $V  E$ 的情况下，提升势 $\\Delta V(V)$ 相对于 $V$ 的导数。提升势由下式给出：\n$$\n\\Delta V(V) = \\dfrac{(E - V)^{2}}{\\alpha + (E - V)}\n$$\n为了求导数 $\\dfrac{d\\Delta V}{dV}$，我们应用微分学的商法则，即对于 $f(V)/g(V)$，其导数为 $\\dfrac{f'(V)g(V) - f(V)g'(V)}{[g(V)]^2}$。\n令 $f(V) = (E - V)^2$ 和 $g(V) = \\alpha + (E - V)$。它们相对于 $V$ 的导数是：\n$$\nf'(V) = \\frac{d}{dV}(E - V)^2 = 2(E - V) \\cdot (-1) = -2(E - V)\n$$\n$$\ng'(V) = \\frac{d}{dV}(\\alpha + E - V) = -1\n$$\n应用商法则：\n$$\n\\frac{d\\Delta V}{dV} = \\frac{[-2(E - V)][\\alpha + (E - V)] - [(E - V)^2][-1]}{[\\alpha + (E - V)]^2}\n$$\n$$\n\\frac{d\\Delta V}{dV} = \\frac{-2\\alpha(E - V) - 2(E - V)^2 + (E - V)^2}{[\\alpha + (E - V)]^2}\n$$\n$$\n\\frac{d\\Delta V}{dV} = \\frac{-2\\alpha(E - V) - (E - V)^2}{[\\alpha + (E - V)]^2}\n$$\n现在，将此导数代入标度因子 $s(V)$ 的表达式中：\n$$\ns(V) = 1 + \\frac{d\\Delta V}{dV} = 1 - \\frac{2\\alpha(E - V) + (E - V)^2}{[\\alpha + (E - V)]^2}\n$$\n为了简化，我们找到一个共同的分母：\n$$\ns(V) = \\frac{[\\alpha + (E - V)]^2}{[\\alpha + (E - V)]^2} - \\frac{2\\alpha(E - V) + (E - V)^2}{[\\alpha + (E - V)]^2}\n$$\n$$\ns(V) = \\frac{\\alpha^2 + 2\\alpha(E - V) + (E - V)^2 - [2\\alpha(E - V) + (E - V)^2]}{[\\alpha + (E - V)]^2}\n$$\n分子中的 $2\\alpha(E - V)$ 和 $(E - V)^2$ 项相互抵消：\n$$\ns(V) = \\frac{\\alpha^2}{[\\alpha + (E - V)]^2}\n$$\n这可以更紧凑地写为：\n$$\ns(V) = \\left(\\frac{\\alpha}{\\alpha + E - V}\\right)^2\n$$\n这个简化表达式将用于数值计算。\n\n**4. 数值计算：**\n给定 $E = 120$ kJ mol$^{-1}$ 和 $\\alpha = 30$ kJ mol$^{-1}$。我们为集合 $\\{110, 100, 80, 40, 0\\}$ 中的每个 $V_i$ 计算 $s_i = s(V_i)$。单位 (kJ mol$^{-1}$) 相互抵消，使得 $s(V)$ 如预期一样成为一个无量纲量。结果四舍五入到四位有效数字。\n\n对于 $V_1 = 110$：\n$$\ns_1 = \\left(\\frac{30}{30 + 120 - 110}\\right)^2 = \\left(\\frac{30}{40}\\right)^2 = \\left(\\frac{3}{4}\\right)^2 = 0.5625\n$$\n\n对于 $V_2 = 100$：\n$$\ns_2 = \\left(\\frac{30}{30 + 120 - 100}\\right)^2 = \\left(\\frac{30}{50}\\right)^2 = \\left(\\frac{3}{5}\\right)^2 = 0.36\n$$\n四舍五入到四位有效数字，结果是 $0.3600$。\n\n对于 $V_3 = 80$：\n$$\ns_3 = \\left(\\frac{30}{30 + 120 - 80}\\right)^2 = \\left(\\frac{30}{70}\\right)^2 = \\left(\\frac{3}{7}\\right)^2 = \\frac{9}{49} \\approx 0.183673...\n$$\n四舍五入到四位有效数字，结果是 $0.1837$。\n\n对于 $V_4 = 40$：\n$$\ns_4 = \\left(\\frac{30}{30 + 120 - 40}\\right)^2 = \\left(\\frac{30}{110}\\right)^2 = \\left(\\frac{3}{11}\\right)^2 = \\frac{9}{121} \\approx 0.074380...\n$$\n四舍五入到四位有效数字，结果是 $0.07438$。\n\n对于 $V_5 = 0$：\n$$\ns_5 = \\left(\\frac{30}{30 + 120 - 0}\\right)^2 = \\left(\\frac{30}{150}\\right)^2 = \\left(\\frac{1}{5}\\right)^2 = 0.04\n$$\n四舍五入到四位有效数字，结果是 $0.04000$。\n\n得到的标度因子集合 $\\{s_i\\}$ 为 $\\{0.5625, 0.3600, 0.1837, 0.07438, 0.04000\\}$。这些结果以单个行向量的形式报告。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.5625  0.3600  0.1837  0.07438  0.04000 \\end{pmatrix}}\n$$"
        }
    ]
}