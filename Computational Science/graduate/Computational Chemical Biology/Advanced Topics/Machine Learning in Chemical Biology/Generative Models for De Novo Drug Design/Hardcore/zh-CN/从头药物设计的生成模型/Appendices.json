{
    "hands_on_practices": [
        {
            "introduction": "许多生成模型将分子设计概念化为一项语言任务，即顺序生成SMILES字符串的字符。本练习深入探讨了此过程的核心：控制令牌选择的温度缩放softmax函数。通过从最大熵原理出发推导这一机制，您将对“温度”参数 $τ$ 如何让我们在分子生成过程中平衡探索（创造性）和利用（合理性）有一个基本的理解。",
            "id": "3847976",
            "problem": "考虑一个基于简化分子线性输入规范 (SMILES) 的生成式语言模型，该模型从一个有限词汇表 $\\mathcal{V}$ 中生成一个符号序列，以构建分子字符串。在生成步骤 $t \\in \\{1, 2, \\dots, L\\}$，模型为词汇表中的符号分配实值分数 (logits) $\\{z_{i}^{(t)}\\}_{i \\in \\mathcal{V}}$，这些分数通过最大熵原理，在固定期望分数和归一化约束下，决定了采样分布。最大熵解引入了一个标量温度参数 $\\tau > 0$，该参数控制了符号分布的离散程度。\n\n假设一个简化的 SMILES 构建有效性准则，其中对于每一步 $t$，都存在一个上下文相关的符号子集 $S_{t} \\subseteq \\mathcal{V}$，该子集中的符号能使部分字符串在局部约束（例如，分支括号平衡或当前状态允许的闭环符号）下保持有效。在以模型分布为条件、各步骤有效性独立的近似下，步骤 $t$ 独立采样的符号能产生有效部分字符串的概率，是模型的温度控制分布分配给 $S_{t}$ 的总概率质量。一个长度为 $L$ 的符号序列的整体有效性即为这些逐​​步有效性的乘积。\n\n从香农熵的定义以及归一化和固定期望分数的约束出发，推导每一步中符号上的温度控制分布。然后，将独立生成的长度为 $L$ 的 SMILES 的期望有效率 $R(\\tau)$ 表示为 $\\tau$、logits $\\{z_{i}^{(t)}\\}$ 和有效集 $\\{S_{t}\\}$ 的闭式解析函数。你的最终答案必须是 $R(\\tau)$ 的一个单一闭式表达式，仅依赖于 $\\tau$、$\\{z_{i}^{(t)}\\}$ 和 $\\{S_{t}\\}$。不需要进行数值计算。",
            "solution": "该问题要求基于最大熵原理推导温度控制的采样分布，并随后使用该分布为生成序列的期望有效率找到一个闭式表达式。整个过程分为两个主要部分：首先，推导概率分布；其次，计算有效率。\n\n第 1 部分：温度控制分布的推导\n\n问题陈述，在每个生成步骤 $t \\in \\{1, 2, \\dots, L\\}$，词汇表 $\\mathcal{V}$ 上的采样分布是通过在特定约束下最大化香农熵来确定的。设 $p_i^{(t)}$ 为在步骤 $t$ 采样符号 $i \\in \\mathcal{V}$ 的概率。为清晰起见，在推导过程中我们将省略上标 $(t)$，因为每一步的逻辑都是相同的。香农熵由下式给出：\n$$H = -\\sum_{i \\in \\mathcal{V}} p_i \\ln(p_i)$$\n\n此最大化过程受两个约束条件限制：\n1.  归一化：词汇表中所有符号的概率总和必须为 $1$。\n    $$\\sum_{i \\in \\mathcal{V}} p_i = 1$$\n2.  固定的期望分数：logits $\\{z_i\\}_{i \\in \\mathcal{V}}$ 的期望值必须等于一个固定的、但未指明的常数 $E$。\n    $$\\sum_{i \\in \\mathcal{V}} p_i z_i = E$$\n\n我们采用拉格朗日乘数法来解决这个约束优化问题。拉格朗日函数 $\\mathcal{L}$ 构建如下：\n$$\\mathcal{L}(p_i, \\lambda_0, \\lambda_1) = H - \\lambda_0 \\left(\\sum_{i \\in \\mathcal{V}} p_i - 1\\right) - \\lambda_1 \\left(\\sum_{i \\in \\mathcal{V}} p_i z_i - E\\right)$$\n代入 $H$ 的表达式：\n$$\\mathcal{L}(p_i, \\lambda_0, \\lambda_1) = -\\sum_{i \\in \\mathcal{V}} p_i \\ln(p_i) - \\lambda_0 \\sum_{i \\in \\mathcal{V}} p_i + \\lambda_0 - \\lambda_1 \\sum_{i \\in \\mathcal{V}} p_i z_i + \\lambda_1 E$$\n\n为了找到使 $\\mathcal{L}$ 最大化的概率 $p_k$，我们对每个 $p_k$ 求偏导数并令其为 0：\n$$\\frac{\\partial \\mathcal{L}}{\\partial p_k} = \\frac{\\partial}{\\partial p_k} \\left( -p_k \\ln(p_k) - \\lambda_0 p_k - \\lambda_1 p_k z_k \\right) = 0$$\n使用乘积法则求导，$\\frac{d}{dx}(x\\ln x) = \\ln x + 1$：\n$$-(\\ln(p_k) + 1) - \\lambda_0 - \\lambda_1 z_k = 0$$\n$$\\ln(p_k) = -1 - \\lambda_0 - \\lambda_1 z_k$$\n解出 $p_k$：\n$$p_k = \\exp(-1 - \\lambda_0 - \\lambda_1 z_k) = \\exp(-1 - \\lambda_0) \\exp(-\\lambda_1 z_k)$$\n\n现在，我们使用归一化约束来确定包含 $\\lambda_0$ 的项。\n$$\\sum_{k \\in \\mathcal{V}} p_k = \\sum_{k \\in \\mathcal{V}} \\exp(-1 - \\lambda_0) \\exp(-\\lambda_1 z_k) = 1$$\n$$\\exp(-1 - \\lambda_0) \\sum_{k \\in \\mathcal{V}} \\exp(-\\lambda_1 z_k) = 1$$\n$$\\exp(-1 - \\lambda_0) = \\frac{1}{\\sum_{j \\in \\mathcal{V}} \\exp(-\\lambda_1 z_j)}$$\n\n将此代回 $p_k$ 的表达式中：\n$$p_k = \\frac{\\exp(-\\lambda_1 z_k)}{\\sum_{j \\in \\mathcal{V}} \\exp(-\\lambda_1 z_j)}$$\n\n问题引入了温度参数 $\\tau > 0$。在统计力学和机器学习中，与类能量约束相关的拉格朗日乘数与逆温度有关。logits 的常规温度缩放形式涉及将 logits 除以 $\\tau$。为了与此惯例匹配，我们将拉格朗日乘数 $\\lambda_1$ 与温度 $\\tau$ 之间的关系定义为 $\\lambda_1 = -1/\\tau$。这个选择给出了所需的形式。\n\n将 $\\lambda_1 = -1/\\tau$ 代入概率表达式，并重新引入步骤索引 $(t)$，我们得到温度控制的分布，即 softmax 函数：\n$$p_i^{(t)}(\\tau) = \\frac{\\exp(z_i^{(t)}/\\tau)}{\\sum_{j \\in \\mathcal{V}} \\exp(z_j^{(t)}/\\tau)}$$\n\n第 2 部分：期望有效率 $R(\\tau)$ 的推导\n\n问题定义了一个简化的有效性准则，其中在每一步 $t$，一个符号子集 $S_t \\subseteq \\mathcal{V}$ 维持部分序列的有效性。在步骤 $t$ 独立采样的符号是有效的概率，我们记为 $V_t(\\tau)$，是这个有效集 $S_t$ 中符号概率的总和。\n$$V_t(\\tau) = \\sum_{i \\in S_t} p_i^{(t)}(\\tau)$$\n\n代入推导出的 $p_i^{(t)}(\\tau)$ 表达式：\n$$V_t(\\tau) = \\sum_{i \\in S_t} \\frac{\\exp(z_i^{(t)}/\\tau)}{\\sum_{j \\in \\mathcal{V}} \\exp(z_j^{(t)}/\\tau)} = \\frac{\\sum_{i \\in S_t} \\exp(z_i^{(t)}/\\tau)}{\\sum_{j \\in \\mathcal{V}} \\exp(z_j^{(t)}/\\tau)}$$\n\n问题陈述，由于独立性近似，一个长度为 $L$ 的符号序列的整体有效性是这些逐​​步有效性概率的乘积。期望有效率 $R(\\tau)$ 就是这个整体有效性概率。\n$$R(\\tau) = \\prod_{t=1}^{L} V_t(\\tau)$$\n\n通过代入 $V_t(\\tau)$ 的表达式，我们得到了期望有效率 $R(\\tau)$ 作为温度 $\\tau$、logits $\\{z_i^{(t)}\\}$ 和有效集 $\\{S_t\\}$ 函数的最终闭式表达式。\n$$R(\\tau) = \\prod_{t=1}^{L} \\left( \\frac{\\sum_{i \\in S_t} \\exp(z_i^{(t)}/\\tau)}{\\sum_{j \\in \\mathcal{V}} \\exp(z_j^{(t)}/\\tau)} \\right)$$\n这个表达式就是所要求的闭式解析函数。",
            "answer": "$$ \\boxed{ \\prod_{t=1}^{L} \\left( \\frac{\\sum_{i \\in S_t} \\exp(z_i^{(t)}/\\tau)}{\\sum_{j \\in \\mathcal{V}} \\exp(z_j^{(t)}/\\tau)} \\right) } $$"
        },
        {
            "introduction": "虽然SMILES字符串代表了分子的拓扑结构，但许多应用需要生成精确的三维原子坐标。一项关键任务是评估生成的构象异构体与参考结构相比的质量，这种比较必须与旋转和平移无关。本练习要求您通过经典的Kabsch算法实现均方根偏差（RMSD）度量，从而亲手展示为何 $E(3)$ 等变模型架构在三维生成任务中具有根本性的优势。",
            "id": "3847969",
            "problem": "您正在评估用于从头药物设计的坐标生成模型，其中每个模型输出一个小分子单个构象异构体的三维原子坐标。一个稳健的比较需要一个在生成的构象异构体和参考构象异构体之间的、具有排列不变性的误差度量。规范的度量是均方根偏差（RMSD），它在保留手性的最佳刚性排列后计算得出。在欧几里得变换的背景下，对三维欧几里得群（E(3)）的等变性意味着，如果输入被旋转或平移，模型的输出也会相应地进行相同的旋转和平移，而不会改变分子形状。\n\n您的任务是，从第一性原理出发，实现一个程序，该程序使用最小化在行列式约束为 $+\\!1$（无反射）的刚性变换下的均方误差的最佳旋转，来计算预测构象异构体与固定参考构象异构体之间的排列不变均方根偏差（RMSD），并分析欧几里得群等变架构相对于普通架构所实现的RMSD降低量。\n\n使用的基本原理：\n- 三维欧几里得距离：对于点 $p,q \\in \\mathbb{R}^3$，平方距离为 $\\lVert p - q \\rVert_2^2$。\n- 正交矩阵的性质：一个矩阵 $R \\in \\mathbb{R}^{3 \\times 3}$ 是一个旋转矩阵，如果 $R^\\top R = I$ 且 $\\det(R) = 1$。\n- 奇异值分解（SVD）：对于任意矩阵 $H \\in \\mathbb{R}^{3 \\times 3}$，存在正交矩阵 $U,V \\in \\mathbb{R}^{3 \\times 3}$ 和一个具有非负元素的对角矩阵 $\\Sigma$，使得 $H = U \\Sigma V^\\top$。\n- 最佳Procrustes/Kabsch排列：最小化中心化点集之间平方距离总和的最佳旋转，是通过对协方差矩阵进行SVD分解并进行行列式校正以强制$\\det(R)=1$来获得的。\n\n需要实现的数学定义：\n- 对于 $N$ 个原子，令参考构象异构体为 $X \\in \\mathbb{R}^{N \\times 3}$，其行为 $x_i \\in \\mathbb{R}^3$，预测为 $Y \\in \\mathbb{R}^{N \\times 3}$，其行为 $y_i \\in \\mathbb{R}^3$。定义质心 $c_X = \\frac{1}{N}\\sum_{i=1}^N x_i$ 和 $c_Y = \\frac{1}{N}\\sum_{i=1}^N y_i$。令 $\\tilde{X} = X - \\mathbf{1} c_X^\\top$ 和 $\\tilde{Y} = Y - \\mathbf{1} c_Y^\\top$。构建协方差 $H = \\tilde{Y}^\\top \\tilde{X}$。计算奇异值分解 $H = U \\Sigma V^\\top$。定义 $R^\\star = V U^\\top$，如果 $\\det(R^\\star)  0$，则翻转 $V$ 的最后一列的符号并重新计算 $R^\\star = V U^\\top$ 以强制 $\\det(R^\\star)=1$。最佳平移为 $t^\\star = c_X - R^\\star c_Y$。排列后的预测为 $Y_{\\text{aligned}} = \\tilde{Y} R^\\star$（等价于 $Y R^\\star + \\mathbf{1} t^{\\star\\top}$）。\n- 排列不变的均方根偏差为 $\\mathrm{RMSD}(Y,X) = \\sqrt{\\frac{1}{N}\\sum_{i=1}^N \\lVert (y_i - c_Y) R^\\star - (x_i - c_X) \\rVert_2^2}$。\n- 将测试用例 $k$ 的改进度量定义为 $\\Delta_k = \\mathrm{RMSD}_{\\text{vanilla},k} - \\mathrm{RMSD}_{\\text{equivariant},k}$。\n\n单位：\n- 所有坐标和平移都以埃（Angstrom）为单位。所有涉及距离的请求输出都必须以埃为单位表示为实数值（浮点数）。\n- 所有旋转角度均以弧度为单位。\n\n参考构象异构体：\n令 $N = 7$，固定的参考构象异构体坐标 $X \\in \\mathbb{R}^{7 \\times 3}$（单位为埃）为以下七个点（行），代表一个带有一个平面外取代基的平面六边形：\n- $x_0 = (1.400, 0.000, 0.000)$\n- $x_1 = (0.700, 1.212435, 0.000)$\n- $x_2 = (-0.700, 1.212435, 0.000)$\n- $x_3 = (-1.400, 0.000, 0.000)$\n- $x_4 = (-0.700, -1.212435, 0.000)$\n- $x_5 = (0.700, -1.212435, 0.000)$\n- $x_6 = (0.000, 0.000, 1.100)$\n\n确定性噪声模型：\n对于原子索引 $i \\in \\{0,1,2,3,4,5,6\\}$ 和振幅 $\\epsilon \\ge 0$，定义确定性噪声向量\n$n_i(\\epsilon) = \\epsilon \\cdot \\big(\\sin(i), \\cos(2i), \\sin(3i)\\big)$，\n其中所有三角函数的参数均以弧度为单位。\n\n旋转参数化：\n使用关于坐标轴的内旋，顺序为 z 轴、y 轴、x 轴。给定角度 $(\\alpha,\\beta,\\gamma)$（以弧度为单位），定义 $R(\\alpha,\\beta,\\gamma) = R_z(\\gamma) R_y(\\beta) R_x(\\alpha)$，其中\n$R_x(\\alpha) = \\begin{bmatrix}1  0  0\\\\ 0  \\cos\\alpha  -\\sin\\alpha\\\\ 0  \\sin\\alpha  \\cos\\alpha\\end{bmatrix}$，\n$R_y(\\beta) = \\begin{bmatrix}\\cos\\beta  0  \\sin\\beta\\\\ 0  1  0\\\\ -\\sin\\beta  0  \\cos\\beta\\end{bmatrix}$，\n$R_z(\\gamma) = \\begin{bmatrix}\\cos\\gamma  -\\sin\\gamma  0\\\\ \\sin\\gamma  \\cos\\gamma  0\\\\ 0  0  1\\end{bmatrix}$。\n\n测试套件：\n构建四个测试用例。对于每个用例，按如下方式构建两个预测 $Y_{\\text{eq}}$（类等变）和 $Y_{\\text{van}}$（类普通）：\n- 给定一个基础线性变换 $A \\in \\mathbb{R}^{3 \\times 3}$ 和平移 $t \\in \\mathbb{R}^3$，定义变换后的坐标 $Z = X A^\\top + \\mathbf{1} t^\\top$。然后逐行添加确定性噪声：第 $i$ 行为 $z_i + n_i(\\epsilon)$，其中 $\\epsilon$ 为指定值。\n\n用例1（理想情况：各向异性缩放损害普通模型）：\n- 类等变：$A_{\\text{eq}} = R(0.5, -0.2, 0.3)$，$t_{\\text{eq}} = (1.2, -0.7, 0.4)$，$\\epsilon_{\\text{eq}} = 0.05$。\n- 类普通：$A_{\\text{van}} = S R(0.5, -0.2, 0.3)$，其中 $S = \\mathrm{diag}(1.03, 0.97, 1.02)$，$t_{\\text{van}} = (1.2, -0.7, 0.4)$，$\\epsilon_{\\text{van}} = 0.20$。\n\n用例2（边界情况：反射无法通过正常旋转消除）：\n- 类等变：$A_{\\text{eq}} = R(1.0, 0.2, -0.7)$，$t_{\\text{eq}} = (0.0, 0.0, 0.0)$，$\\epsilon_{\\text{eq}} = 0.00$。\n- 类普通：$A_{\\text{van}} = M R(1.0, 0.2, -0.7)$，其中 $M = \\mathrm{diag}(1.0, 1.0, -1.0)$（一个行列式为 $\\det(M) = -1$ 的反射），$t_{\\text{van}} = (0.0, 0.0, 0.0)$，$\\epsilon_{\\text{van}} = 0.00$。\n\n用例3（边缘情况：剪切和更高噪声损害普通模型）：\n- 类等变：$A_{\\text{eq}} = R(0.3, 0.4, 0.2)$，$t_{\\text{eq}} = (-0.5, 0.8, -0.3)$，$\\epsilon_{\\text{eq}} = 0.10$。\n- 类普通：$A_{\\text{van}} = B R(0.3, 0.4, 0.2)$，其中 $B = \\begin{bmatrix}1.00  0.04  0.02\\\\ 0.01  1.00  0.03\\\\ -0.02  0.00  1.02\\end{bmatrix}$，$t_{\\text{van}} = (-0.5, 0.8, -0.3)$，$\\epsilon_{\\text{van}} = 0.30$。\n\n用例4（边界情况：单位变换，无噪声）：\n- 类等变：$A_{\\text{eq}} = I_{3}$，$t_{\\text{eq}} = (0.0, 0.0, 0.0)$，$\\epsilon_{\\text{eq}} = 0.00$。\n- 类普通：$A_{\\text{van}} = I_{3}$，$t_{\\text{van}} = (0.0, 0.0, 0.0)$，$\\epsilon_{\\text{van}} = 0.00$。\n\n计算要求：\n- 按照描述实现行列式约束为 $+\\!1$ 的最佳刚性排列，在每个用例中为 $Y_{\\text{eq}}$ 和 $Y_{\\text{van}}$ 计算 $\\mathrm{RMSD}(Y,X)$，然后计算 $k \\in \\{1,2,3,4\\}$ 的改进值 $\\Delta_k = \\mathrm{RMSD}_{\\text{vanilla},k} - \\mathrm{RMSD}_{\\text{equivariant},k}$。\n- 所有RMSD值和改进值都必须以埃为单位计算并报告为实数。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含四个改进值 $\\Delta_1,\\Delta_2,\\Delta_3,\\Delta_4$，格式为用方括号括起来的逗号分隔列表，例如 $[\\Delta_1,\\Delta_2,\\Delta_3,\\Delta_4]$。请使用从1到4的精确用例顺序。\n\n注意：不要使用任何随机性；请完全按照规定使用确定性噪声 $n_i(\\epsilon)$。角度以弧度为单位，距离以埃为单位。",
            "solution": "任务是实现一个函数，用于计算两个分子构象异构体之间的排列不变均方根偏差（RMSD），并使用该函数评估等变生成模型和非等变生成模型之间的性能差异。该问题在科学上是合理的且定义明确，其基础是计算生物学中结构排列的既定原则，特别是用于最佳刚性叠加的Kabsch算法。\n\n在继续之前，有必要澄清问题陈述中轻微的符号不一致问题，以确保正确实现。问题将坐标定义为矩阵 $X, Y \\in \\mathbb{R}^{N \\times 3}$ 中的行向量。假定使用符合此约定的标准矩阵运算。\n1.  中心化坐标：表达式 $\\tilde{X} = X - \\mathbf{1} c_X^\\top$ 在符号表示上存在问题。假设 $c_X$ 是一个 $1 \\times 3$ 的行向量（$X$ 各行的均值），而 $\\mathbf{1}$ 是一个 $N \\times 1$ 的全一列向量，则该操作应为 $\\tilde{X} = X - \\mathbf{1} c_X$。在实践中，这是通过从坐标矩阵的每一行中减去均值向量来实现的，这一操作在数值计算库中通过广播（broadcasting）机制得到了很好的支持。\n2.  最佳平移：最佳平移向量的表达式 $t^\\star = c_X - R^\\star c_Y$ 涉及一个无效的矩阵-向量乘积 $R^\\star c_Y$，因为 $R^\\star$ 是一个 $3 \\times 3$ 矩阵，而 $c_Y$ 是一个 $1 \\times 3$ 的行向量。对于行向量，正确的表达式是 $t^\\star = c_X - c_Y R^\\star$。然而，指定的RMSD公式 $\\mathrm{RMSD}(Y,X) = \\sqrt{\\frac{1}{N}\\sum_{i=1}^N \\lVert (y_i - c_Y) R^\\star - (x_i - c_X) \\rVert_2^2}$ 正确地仅依赖于中心化的坐标。这意味着平移分量已通过中心化步骤隐式处理，计算RMSD时不需要显式计算 $t^\\star$。\n\n在澄清了这些问题后，解决方案将通过实现Kabsch算法并将其应用于指定的测试用例来继续进行。\n\n首先，我们定义一个计算RMSD的函数。令参考坐标为 $X \\in \\mathbb{R}^{N \\times 3}$，预测坐标为 $Y \\in \\mathbb{R}^{N \\times 3}$。\n\n步骤1：中心化坐标集\n刚性排列的第一步是通过将每个构象异构体的质心移动到原点来移除平移分量。质心计算如下：\n$$ c_X = \\frac{1}{N} \\sum_{i=1}^N x_i $$\n$$ c_Y = \\frac{1}{N} \\sum_{i=1}^N y_i $$\n然后通过从每个坐标向量中减去各自的质心来获得中心化坐标矩阵 $\\tilde{X}$ 和 $\\tilde{Y}$：\n$$ \\tilde{X} = X - \\mathbf{1}c_X $$\n$$ \\tilde{Y} = Y - \\mathbf{1}c_Y $$\n这里，$x_i$ 和 $y_i$ 是 $X$ 和 $Y$ 的第 $i$ 行，$\\mathbf{1}$ 是一个 $N \\times 1$ 的全一列向量。\n\n步骤2：计算协方差矩阵\n最佳旋转是通过最大化两个中心化点集之间的重叠来找到的。这是通过找到最小化 $\\sum_{i=1}^N \\|(y_i - c_Y)R - (x_i - c_X)\\|^2$ 的旋转 $R$ 来实现的。该解决方案涉及两个中心化集合之间的协方差矩阵 $H$：\n$$ H = \\tilde{Y}^\\top \\tilde{X} \\in \\mathbb{R}^{3 \\times 3} $$\n\n步骤3：奇异值分解（SVD）\n协方差矩阵 $H$ 使用SVD进行分解：\n$$ H = U \\Sigma V^\\top $$\n其中 $U$ 和 $V$ 是 $3 \\times 3$ 的正交矩阵，$\\Sigma$ 是一个包含非负奇异值的 $3 \\times 3$ 对角矩阵。\n\n步骤4：计算最佳旋转矩阵\n最大化重叠的最佳旋转矩阵 $R^\\star$ 由下式给出：\n$$ R^\\star = V U^\\top $$\n然而，这个矩阵 $R^\\star$ 可能代表一个旋转（$\\det(R^\\star) = +1$）或一个反射-旋转（$\\det(R^\\star) = -1$）。为了确保我们找到一个保留手性的纯旋转，我们必须强制执行约束 $\\det(R^\\star) = +1$。这是通过检查行列式的符号来完成的。如果 $\\det(R^\\star) = -1$，则表示最佳变换是不正常的。为了找到最佳的*正常*旋转，我们反转对应于最小奇异值的变换分量。按照规定，如果 $\\det(V U^\\top) = -1$，我们让 $V' = V \\begin{pmatrix} 1  0  0 \\\\ 0  1  0 \\\\ 0  0  -1 \\end{pmatrix}$，然后 $R^\\star = V' U^\\top$。\n此过程保证了 $\\det(R^\\star)=1$。\n\n步骤5：计算RMSD\n利用最佳正常旋转 $R^\\star$，RMSD被计算为排列后的预测坐标与参考坐标之间平方欧几里得距离均值的平方根：\n$$ \\mathrm{RMSD}(Y,X) = \\sqrt{\\frac{1}{N}\\sum_{i=1}^N \\lVert (y_i - c_Y) R^\\star - (x_i - c_X) \\rVert_2^2} $$\n这等效于计算排列后的中心化矩阵与参考中心化矩阵之差的Frobenius范数：\n$$ \\mathrm{RMSD}(Y,X) = \\sqrt{\\frac{1}{N} \\lVert \\tilde{Y} R^\\star - \\tilde{X} \\rVert_F^2} $$\n\n接下来，我们以编程方式构建测试用例。创建一个辅助函数来生成旋转矩阵 $R(\\alpha, \\beta, \\gamma) = R_z(\\gamma) R_y(\\beta) R_x(\\alpha)$（给定欧拉角）。另一个函数生成确定性噪声向量 $n_i(\\epsilon)$。\n\n对于四个测试用例中的每一个，我们生成“类等变”坐标 $Y_{\\text{eq}}$ 和“类普通”坐标 $Y_{\\text{van}}$。对于给定的仿射变换 $(A, t)$ 和噪声水平 $\\epsilon$，通过对参考坐标 $X$ 应用线性变换和平移，然后添加噪声来生成预测坐标 $Y$：\n$$ Y_i = X_i A^\\top + t + n_i(\\epsilon) \\quad \\text{对于每个原子 } i=0, \\dots, 6 $$\n\n最后，对于每个用例 $k \\in \\{1,2,3,4\\}$，我们计算 $\\mathrm{RMSD}_{\\text{equivariant},k} = \\mathrm{RMSD}(Y_{\\text{eq},k}, X)$ 和 $\\mathrm{RMSD}_{\\text{vanilla},k} = \\mathrm{RMSD}(Y_{\\text{van},k}, X)$。然后将改进度量计算为 $\\Delta_k = \\mathrm{RMSD}_{\\text{vanilla},k} - \\mathrm{RMSD}_{\\text{equivariant},k}$。预期的结果是：\n-   用例1：$\\Delta_1 > 0$。普通模型的输出被各向异性缩放所扭曲，而刚性排列无法纠正这种扭曲。\n-   用例2：$\\Delta_2 > 0$。普通模型的输出是真实结构的反射。排列必须找到一个正常旋转，从而留下较大的残余RMSD。等变模型，当$\\epsilon=0$时，应有$\\mathrm{RMSD}=0$。\n-   用例3：$\\Delta_3 > 0$。应用于普通模型的剪切变换导致非刚性扭曲，从而产生更高的RMSD。\n-   用例4：$\\Delta_4 = 0$。两个模型都产生精确的参考结构，导致两者的RMSD均为零，因此改进也为零。这可作为一个健全性检查。\n\n实现将遵循这些步骤来计算四个 $\\Delta_k$ 值。",
            "answer": "[0.150175811797828,1.114758999849504,0.1691350868843916,0.0]"
        },
        {
            "introduction": "从头设计的最终目标不仅仅是创造有效的分子，而是生成具有最佳治疗特性的候选药物。这通常涉及一个多目标优化问题：在遵守关键的药物化学约束（如Lipinski规则）的同时，最大化结合亲和力。本练习阐释了如何使用惩罚性评分函数将此约束问题转化为无约束问题，这是引导生成模型产生有效且具有类药性的化合物的核心技术。",
            "id": "5247455",
            "problem": "一个从头分子生成器正在被训练，以提出能够优化归一化结合目标 $A \\in [0,1]$ 的候选配体，同时满足药物化学规则，如 Lipinski 五规则、泛分析干扰化合物（PAINS）筛选和合成可及性约束。设 $V \\in \\{0,1,2,\\dots\\}$ 表示给定分子在此规则集下观察到的违规次数，并假设设计目标是约束优化问题，即在满足 $V=0$ 的条件下最大化 $A$。在实践中，约束优化通常通过拉格朗日乘子法进行松弛，即构建一个无约束的代理目标，该目标包含了对违反约束的惩罚。假设惩罚在各项违规之间是可加的，并且在一阶上与违规次数呈线性关系，带有一个非负标量惩罚权重 $\\lambda \\geq 0$，该权重反映了 $A$ 和规则依从性之间的权衡。从这个约束公式和拉格朗日松弛的原理出发，推导无约束代理目标 $S(A,V;\\lambda)$，然后对一个 $A=0.8$，$V=3$ 且 $\\lambda=0.1$ 的候选分子进行评估。分数 $S$ 是无量纲的。以小数形式提供精确值。此外，简要讨论在固定的 $A$ 和 $V$ 下，$S$ 对 $\\lambda$ 变化的敏感性，并结合为药物规则依从性调整生成器的背景来解释这种敏感性。不要对数值分数进行四舍五入。",
            "solution": "将通过首先提取给定信息，然后评估其科学和逻辑合理性来验证问题陈述。\n\n### 步骤1：提取给定信息\n-   **目标函数**：一个归一化的结合目标 $A \\in [0,1]$。目标是最大化 $A$。\n-   **约束函数**：规则违规次数 $V \\in \\{0, 1, 2, \\dots\\}$。\n-   **约束条件**：优化受制于条件 $V=0$。\n-   **方法**：使用拉格朗日松弛来创建一个无约束的代理目标 $S$。\n-   **惩罚项**：违反约束的惩罚是可加的，与违规次数 $V$ 呈线性关系，并由一个非负标量惩罚权重 $\\lambda \\geq 0$ 加权。\n-   **代理目标**：$S(A,V;\\lambda)$ 是待推导的函数。\n-   **评估点**：用于评估的值为 $A=0.8$，$V=3$ 和 $\\lambda=0.1$。\n-   **附加任务**：讨论 $S$ 对 $\\lambda$ 变化的敏感性并解释这种敏感性。\n\n### 步骤2：使用提取的给定信息进行验证\n根据验证标准评估问题：\n-   **科学依据**：该问题在药物化学和计算优化领域有充分的依据。像 Lipinski 规则、PAINS 过滤器、合成可及性和结合目标等概念是药物设计中的标准。使用源自拉格朗日松弛原理的惩罚评分函数，是处理生成模型和优化算法中约束的一种常用且有效技术。\n-   **适定性**：该问题是适定的。它指定了一个明确的优化目标（在 $V=0$ 的约束下最大化 $A$）和一种标准方法（带有线性惩罚的拉格朗日松弛）将其转化为无约束问题。这个设定提供了足够的信息来唯一地推导出代理目标 $S$ 的形式。\n-   **客观性**：语言精确、技术性强，没有主观或含糊的陈述。\n-   **完整性和一致性**：该问题是自洽的，其各组成部分是一致的。它提供了推导代理目标、对其进行评估并分析其敏感性所需的所有必要信息。\n-   **现实性**：在分子设计评分函数的背景下，所提供的数值（$A=0.8$, $V=3$, $\\lambda=0.1$）是合理的。\n\n### 步骤3：结论与行动\n该问题被认为是有效的，因为它科学合理、适定、客观且完整。将提供完整的解答。\n\n### 代理目标的推导\n原始的约束优化问题表述为：\n$$\n\\text{最大化 } A \\quad \\text{约束条件为 } V = 0\n$$\n采用拉格朗日乘子法将其转化为一个无约束问题。对于一个在约束 $g(x)=c$ 下最大化函数 $f(x)$ 的问题，拉格朗日函数 $\\mathcal{L}$ 通常写为 $\\mathcal{L}(x, \\mu) = f(x) - \\mu(g(x)-c)$，其中 $\\mu$ 是拉格朗日乘子。\n\n在此背景下，要最大化的函数是结合目标 $A$，约束是 $V=0$。因此，我们可以识别出 $f \\rightarrow A$，$g \\rightarrow V$，以及约束值 $c \\rightarrow 0$。惩罚权重 $\\lambda$ 扮演了拉格朗日乘子 $\\mu$ 的角色。\n\n因此，拉格朗日函数为：\n$$\n\\mathcal{L}(A, V; \\lambda) = A - \\lambda(V - 0) = A - \\lambda V\n$$\n这个拉格朗日函数作为无约束的代理目标 $S(A, V; \\lambda)$，从头生成器旨在将其最大化。更高的 $S$ 值对应于更理想的候选分子。这种形式正确地反映了问题的要求：它是一个无约束的目标，包含一个可加的惩罚项，该惩罚项与违规次数 $V$ 呈线性关系，并带有权重 $\\lambda$。\n$$\nS(A, V; \\lambda) = A - \\lambda V\n$$\n\n### 代理目标的评估\n我们被要求为一个 $A=0.8$，$V=3$ 且惩罚权重 $\\lambda=0.1$ 的候选分子评估 $S(A, V; \\lambda)$。\n将这些值代入推导出的 $S$ 的表达式中：\n$$\nS(0.8, 3; 0.1) = 0.8 - (0.1)(3)\n$$\n$$\nS = 0.8 - 0.3\n$$\n$$\nS = 0.5\n$$\n该候选分子的分数为 $0.5$。\n\n### 敏感性分析与解释\n分数 $S$ 对惩罚权重 $\\lambda$ 变化的敏感性由 $S$ 对 $\\lambda$ 的偏导数给出，其中 $A$ 和 $V$ 保持不变。\n$$\n\\frac{\\partial S}{\\partial \\lambda} = \\frac{\\partial}{\\partial \\lambda} (A - \\lambda V)\n$$\n由于 $A$ 和 $V$ 是给定分子的属性，因此在此微分中它们被视为常数。\n$$\n\\frac{\\partial S}{\\partial \\lambda} = -V\n$$\n**解释：**\n分数 $S$ 相对于惩罚权重 $\\lambda$ 的敏感性等于规则违规次数的负值，即 $-V$。在调整分子生成器的背景下，这个结果有明确而重要的解释：\n\n1.  **对违规的依赖性**：改变 $\\lambda$ 对分子分数的影响与其违规次数成正比。\n    -   对于一个完全合规的分子（$V=0$），敏感性为 $\\frac{\\partial S}{\\partial \\lambda} = 0$。其分数为 $S=A$，与惩罚权重 $\\lambda$ 无关。这是合乎逻辑的，因为没有需要加权的惩罚。\n    -   对于一个不合规的分子（$V0$），敏感性为负。这意味着增加惩罚权重 $\\lambda$ 将会降低该分子的总分。\n\n2.  **调整参数**：参数 $\\lambda$ 充当药物设计者的“调节旋钮”，用以控制生成模型的行为。\n    -   通过增加 $\\lambda$，设计者更加重视规则的依从性。具有大量违规（大的 $V$）的分子将受到更重的惩罚，因此不太可能被生成器作为“最优”候选提出。这将引导生成器产生更多满足指定药物化学规则的“类药性”候选物。\n    -   相反，如果生成器变得过于保守，只产生符合规则但结合目标（$A$）次优的分子，设计者可以减小 $\\lambda$。这会降低对违规的惩罚，允许生成器探索更广阔的化学空间，其中可能包含具有更高结合潜力但存在一些规则违规的分子。\n\n总之，敏感性 $\\frac{\\partial S}{\\partial \\lambda} = -V$ 量化了在最大化主要目标（$A$）和满足约束（$V=0$）之间的权衡。它提供了一种机制，随着基于规则的过滤器（$\\lambda$）的严格性增加，具有更多违规的分子会受到更强烈的排斥。",
            "answer": "$$\n\\boxed{0.5}\n$$"
        }
    ]
}