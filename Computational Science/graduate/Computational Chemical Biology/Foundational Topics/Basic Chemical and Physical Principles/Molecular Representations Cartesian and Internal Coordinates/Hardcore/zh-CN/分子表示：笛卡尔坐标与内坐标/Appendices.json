{
    "hands_on_practices": [
        {
            "introduction": "掌握任何一种新表述方式的第一步都是学习如何进行基本转换。本练习将指导您完成一个核心任务：从计算机天然使用的笛卡尔坐标（Cartesian coordinates）转换为化学家直观理解的内坐标（internal coordinates）。我们将以水分子为例，通过应用基本的向量代数原理，亲手计算其键长和键角，从而为理解更复杂的分子结构奠定坚实的基础。",
            "id": "3426932",
            "problem": "考虑一个非线性三原子水分子，其原子标记为 $O$、$H_1$ 和 $H_2$。其笛卡尔坐标（单位为埃）由下式给出\n$$\n\\mathbf{r}_O = (0.00000000,\\; 0.00000000,\\; 0.00000000),\\quad\n\\mathbf{r}_{H_1} = (0.95720000,\\; 0.00000000,\\; 0.00000000),\\quad\n\\mathbf{r}_{H_2} = (-0.23998720,\\; 0.92662721,\\; 0.00000000).\n$$\n从欧几里得几何的第一性原理和分子动力学（MD）中使用的内坐标描述出发，完成以下任务：\n- 通过从总的笛卡尔自由度中移除刚体运动，论证非线性三原子分子的独立内坐标数量。\n- 针对此原子标记和排序，明确构建一个 $Z$ 矩阵（内坐标表示），确定键长、键角，并评论在三原子分子背景下的二面角。\n- 根据输入的笛卡尔坐标计算内坐标的数值。\n\n使用以下基于定义的约定：\n- 键长 $r_{AB}$ 是原子 $A$ 和 $B$ 之间的欧几里得距离。\n- 键角 $\\theta_{ABC}$ 是在 B 点，由从 B 到 A 和从 B 到 C 的向量所形成的夹角。\n- 二面角 $\\phi_{ABCD}$ 是平面 $(A,B,C)$ 和 $(B,C,D)$ 之间的扭转角；讨论其对三原子分子的适用性。\n\n按顺序 $(r_{OH_1},\\; r_{OH_2},\\; \\theta_{H_1OH_2})$ 报告该水分子的三个内坐标。键长以埃为单位，键角以弧度为单位。将答案四舍五入至四位有效数字。",
            "solution": "首先对问题进行验证。\n\n### 步骤1：提取已知信息\n- **分子**：一个非线性三原子水分子，原子标记为 $O$、$H_1$ 和 $H_2$。\n- **笛卡尔坐标**：\n$$\n\\mathbf{r}_O = (0.00000000,\\; 0.00000000,\\; 0.00000000)\n$$\n$$\n\\mathbf{r}_{H_1} = (0.95720000,\\; 0.00000000,\\; 0.00000000)\n$$\n$$\n\\mathbf{r}_{H_2} = (-0.23998720,\\; 0.92662721,\\; 0.00000000)\n$$\n- **定义**：\n  - 键长 $r_{AB}$ 是原子 $A$ 和 $B$ 之间的欧几里得距离。\n  - 键角 $\\theta_{ABC}$ 是在 B 点，由从 B 到 A 和从 B 到 C 的向量所形成的夹角。\n  - 二面角 $\\phi_{ABCD}$ 是平面 $(A,B,C)$ 和 $(B,C,D)$ 之间的扭转角。\n- **任务**：\n  1. 论证非线性三原子分子的独立内坐标数量。\n  2. 为给定的原子顺序构建一个 Z 矩阵并评论坐标。\n  3. 计算内坐标 $(r_{OH_1},\\; r_{OH_2},\\; \\theta_{H_1OH_2})$ 的数值。\n- **输出要求**：\n  - 按顺序 $(r_{OH_1},\\; r_{OH_2},\\; \\theta_{H_1OH_2})$ 报告三个内坐标。\n  - 键长以埃为单位，键角以弧度为单位。\n  - 将最终数值答案四舍五入至四位有效数字。\n\n### 步骤2：使用提取的已知信息进行验证\n- **科学依据**：该问题基于分子力学和化学物理的基本原理，特别是笛卡尔坐标系和内坐标系之间的关系。所提供的键长、键角和二面角的定义是该领域的标准。所提供的水分子坐标在物理上是现实的。该问题在科学上是合理的。\n- **良态问题**：该问题要求从一套完整的输入数据中计算出具体的、可计算的量。从笛卡尔坐标到内坐标的转换是一个明确定义的数学过程。解是唯一且稳定的。\n- **客观性**：问题陈述使用了精确、无偏见的语言，并提供了客观的数值数据。没有主观因素。\n- **完整性与一致性**：所有必要的信息（原子位置、定义、期望输出）都已提供。数据或要求中没有矛盾。所提供的坐标如陈述所述，描述了一个非线性分子，因为这三个原子不共线。\n- **不存在其他缺陷。** 该问题不是琐碎、不切实际或无法验证的。它是计算化学中一个标准的、结构良好的问题。\n\n### 步骤3：结论与行动\n该问题有效。将提供完整的解决方案。\n\n### 解题过程\n解题过程按照问题陈述中要求的三个任务进行组织。\n\n**1. 论证内坐标的数量**\n\n一个包含 $N$ 个原子的三维空间体系共有 $3N$ 个自由度，对应于每个原子的 $x$、$y$ 和 $z$ 坐标。对于三原子水分子，$N=3$，因此总共有 $3 \\times 3 = 9$ 个自由度。\n\n这些自由度可以划分为分子作为一个整体的运动（平动和转动）和改变分子内部几何构型的运动（振动）。根据定义，内坐标只描述后者。因此，为了求出内部自由度的数量，我们必须减去对应于刚体平动和转动的自由度。\n\n- **平动**：整个分子可以作为一个单一刚体，沿着三个独立的笛卡尔轴（$x$、$y$、$z$）进行平动。这占据了 3 个平动自由度。\n- **转动**：刚体也可以转动。对于非线性分子（如水），存在三个独立的转动轴，因此有 3 个转动自由度。（对于线性分子，围绕分子轴的转动不被视为一个自由度，因为它不改变原子位置，所以只有 2 个转动自由度）。\n\n内部自由度的数量，即指定分子几何构型所需的独立内坐标的数量，是总自由度减去平动和转动自由度。\n\n对于非线性分子：\n$$\n\\text{内坐标数量} = (\\text{总自由度}) - (\\text{平动自由度}) - (\\text{转动自由度}) = 3N - 3 - 3 = 3N - 6\n$$\n对于水分子（$N=3$）：\n$$\n\\text{内坐标数量} = 3(3) - 6 = 9 - 6 = 3\n$$\n因此，一个非线性三原子分子由 3 个独立的内坐标完全描述。\n\n**2. Z 矩阵构建与坐标描述**\n\nZ 矩阵依次定义每个原子的位置，其位置是相对于先前已定义的原子而言的。对于指定的顺序 $O, H_1, H_2$：\n\n- **原子 1 (O)**：放置在原点。它不需要几何参数。\n  `O`\n- **原子 2 (H1)**：其位置由它与原子 1 (O) 的距离（键长 $r_{OH_1}$）定义。\n  `H1 1 r_OH1`\n- **原子 3 (H2)**：其位置由它与原子 1 (O) 的距离（键长 $r_{OH_2}$）、它与原子 2 ($H_1$) 和原子 1 (O) 形成的角（键角 $\\theta_{H_1OH_2}$）以及相对于第四个参考原子的二面角定义。\n  `H2 1 r_OH2 2 theta_H1OH2`\n\n完整的 Z 矩阵表示为：\n```\nO\nH1  1  r_OH1\nH2  1  r_OH2  2  theta_H1OH2\n```\n从这个 Z 矩阵派生出的三个内坐标是：\n- 一个键长，$r_{OH_1}$。\n- 一个键长，$r_{OH_2}$。\n- 一个键角，$\\theta_{H_1OH_2}$。\n\n**关于二面角的评论**：一个二面角 $\\phi_{ABCD}$ 由四个原子定义。它描述了围绕中心键 $B-C$ 的扭转。由于三原子分子只有三个原子，分子内不存在第四个原子来定义二面角。因此，二面角的概念不适用于描述任何三原子分子的内部几何构型。其几何构型由两个键长和一个键角完全指定。\n\n**3. 内坐标的计算**\n\n内坐标的数值是根据给定的笛卡尔坐标，使用其几何定义计算出来的。坐标向量为：\n$\\mathbf{r}_O = (0, 0, 0)$，$\\mathbf{r}_{H_1} = (0.9572, 0, 0)$，以及 $\\mathbf{r}_{H_2} = (-0.2399872, 0.92662721, 0)$。\n\n- **键长 $r_{OH_1}$**：\n从 $O$ 到 $H_1$ 的向量是 $\\mathbf{v}_{OH_1} = \\mathbf{r}_{H_1} - \\mathbf{r}_O = (0.9572, 0, 0)$。\n键长是这个向量的模：\n$$\nr_{OH_1} = ||\\mathbf{v}_{OH_1}|| = \\sqrt{(0.9572)^2 + (0)^2 + (0)^2} = 0.9572 \\text{ 埃}\n$$\n\n- **键长 $r_{OH_2}$**：\n从 $O$ 到 $H_2$ 的向量是 $\\mathbf{v}_{OH_2} = \\mathbf{r}_{H_2} - \\mathbf{r}_O = (-0.2399872, 0.92662721, 0)$。\n键长是这个向量的模：\n$$\nr_{OH_2} = ||\\mathbf{v}_{OH_2}|| = \\sqrt{(-0.2399872)^2 + (0.92662721)^2 + (0)^2}\n$$\n$$\nr_{OH_2} = \\sqrt{0.057593856... + 0.85863923...} = \\sqrt{0.916233086...} = 0.95720065... \\text{ 埃}\n$$\n\n- **键角 $\\theta_{H_1OH_2}$**：\n该角在原子 $O$ 处，由向量 $\\mathbf{v}_{OH_1}$ 和 $\\mathbf{v}_{OH_2}$ 形成。我们使用点积公式：$\\mathbf{a} \\cdot \\mathbf{b} = ||\\mathbf{a}|| \\cdot ||\\mathbf{b}|| \\cos(\\theta)$。\n$$\n\\cos(\\theta_{H_1OH_2}) = \\frac{\\mathbf{v}_{OH_1} \\cdot \\mathbf{v}_{OH_2}}{r_{OH_1} r_{OH_2}}\n$$\n点积是：\n$$\n\\mathbf{v}_{OH_1} \\cdot \\mathbf{v}_{OH_2} = (0.9572)(-0.2399872) + (0)(0.92662721) + (0)(0) = -0.22971575...\n$$\n模的乘积是：\n$$\nr_{OH_1} r_{OH_2} = (0.9572)(0.95720065...) = 0.91623369...\n$$\n因此：\n$$\n\\cos(\\theta_{H_1OH_2}) = \\frac{-0.22971575...}{0.91623369...} = -0.2507201...\n$$\n以弧度为单位的角度是该值的反余弦：\n$$\n\\theta_{H_1OH_2} = \\arccos(-0.2507201...) = 1.82422... \\text{ 弧度}\n$$\n\n最后，我们按要求将计算值四舍五入至四位有效数字。\n- $r_{OH_1} = 0.9572$\n- $r_{OH_2} = 0.95720065... \\approx 0.9572$\n- $\\theta_{H_1OH_2} = 1.82422... \\approx 1.824$\n\n三个内坐标是 $(0.9572, 0.9572, 1.824)$。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.9572 & 0.9572 & 1.824 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在学会了如何解析分子结构之后，我们将挑战逆向过程：根据一组内坐标参数从头构建分子的三维结构。这个过程不仅仅是简单的逆向计算，更是一个强大的构建工具，对于生成如蛋白质和聚合物等复杂大分子的初始模型至关重要。在本练习中，您将采用一种源于机器人学的强大技术——齐次变换矩阵（homogeneous transformation matrices），通过链接局部坐标系来逐步构建整个分子的全局坐标。",
            "id": "3855207",
            "problem": "你的任务是设计并实现一个数值程序，该程序为聚合物的连续残基附加右手局部坐标系，并使用坐标系链式方法从内部坐标参数计算笛卡尔坐标。该程序必须仅基于以下基本原理：(i) 刚体变换的定义，即一次旋转后跟随一次平移；(ii) 矩阵乘法的结合律；以及 (iii) 围绕三维空间中主轴旋转的标准旋转矩阵。所有角度必须以弧度表示，且所有计算必须在三维欧几里得空间中进行。\n\n聚合物被建模为一个由 $N$ 个残基组成的有序序列，索引为 $i \\in \\{1,\\ldots,N\\}$。每个残基 $i$ 带有三个内部坐标参数：\n- 键长 $l_i \\in \\mathbb{R}_{\\ge 0}$，\n- 键角 $\\theta_i \\in [0,\\pi]$，\n- 扭转角（二面角）$\\phi_i \\in [-\\pi,\\pi]$。\n\n你必须为每个残基附加一个局部右手正交坐标系，并使用以下约定定义连续坐标系之间的刚体变换。从坐标系 $i-1$ 开始，通过以下步骤构建到坐标系 $i$ 的变换：\n- 首先，围绕坐标系 $i-1$ 的局部 $z$ 轴应用一个角度为 $\\phi_i$ 的扭转旋转；\n- 然后，围绕变换后的局部 $x$ 轴应用一个角度为 $\\theta_i$ 的弯曲旋转；\n- 最后，沿变换后的局部 $z$ 轴应用一个距离为 $l_i$ 的平移。\n\n使用一个 $4 \\times 4$ 的齐次变换矩阵来表示每个刚体变换，其中左上角的 $3 \\times 3$ 块是旋转矩阵，右上角的 $3 \\times 1$ 块是平移向量，底行固定为 $[0,0,0,1]$。初始坐标系（锚点）是位于原点的 $H_0 = I_4$，其中 $I_4$ 是 $4 \\times 4$ 的单位矩阵。残基 $i$ 的笛卡尔坐标定义为坐标系 $i$ 的原点在全局坐标系中的表示，即 $H_i$ 的平移分量，其中 $H_i = H_{i-1} T_i$ 且 $T_i$ 是残基 $i$ 的变换。因此，残基 $i$ 的全局位置必须通过累积乘积 $H_i = H_0 T_1 T_2 \\cdots T_i$ 来计算。\n\n所有旋转矩阵都必须从第一性原理构建。具体来说，使用标准事实，即围绕 $z$ 轴旋转角度 $\\alpha$ 的旋转由以下矩阵表示：\n$$\nR_z(\\alpha) = \\begin{bmatrix}\n\\cos \\alpha  -\\sin \\alpha  0 \\\\\n\\sin \\alpha  \\cos \\alpha  0 \\\\\n0  0  1\n\\end{bmatrix},\n$$\n以及围绕 $x$ 轴旋转角度 $\\beta$ 的旋转由以下矩阵表示：\n$$\nR_x(\\beta) = \\begin{bmatrix}\n1  0  0 \\\\\n0  \\cos \\beta  -\\sin \\beta \\\\\n0  \\sin \\beta  \\cos \\beta\n\\end{bmatrix}.\n$$\n沿局部 $z$ 轴平移距离 $d$ 在齐次坐标中由嵌入右上块的平移向量 $[0,0,d]^\\top$ 表示。角度必须是弧度。\n\n你的程序必须实现坐标系链式程序，为每个测试用例计算所有残基的笛卡尔坐标，并为每个测试用例输出一个展平的坐标列表 $[x_1,y_1,z_1,\\ldots,x_N,y_N,z_N]$，其中每个浮点值四舍五入到 $6$ 位小数。\n\n测试套件：\n- 用例 1 (正常路径直线链)：\n  - $N = 3$\n  - $l = [1,1,1]$\n  - $\\theta = [0,0,0]$\n  - $\\phi = [0,0,0]$\n- 用例 2 (单次弯曲)：\n  - $N = 3$\n  - $l = [1,1,1]$\n  - $\\theta = [\\frac{\\pi}{2},0,0]$\n  - $\\phi = [0,0,0]$\n- 用例 3 (复合弯曲与扭转)：\n  - $N = 4$\n  - $l = [1,1,1,1]$\n  - $\\theta = [\\frac{\\pi}{2},\\frac{\\pi}{2},\\frac{\\pi}{2},\\frac{\\pi}{2}]$\n  - $\\phi = [0,\\frac{\\pi}{2},\\frac{\\pi}{2},\\frac{\\pi}{2}]$\n- 用例 4 (边界情况：零连接长度和非平凡扭转)：\n  - $N = 3$\n  - $l = [1,0.5,0]$\n  - $\\theta = [\\frac{\\pi}{3},\\frac{\\pi}{3},0]$\n  - $\\phi = [\\frac{\\pi}{2},-\\frac{\\pi}{2},\\pi]$\n\n角度单位：弧度。位置没有需要报告的物理单位。你的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表形式的结果（例如，$[result_1,result_2,result_3,result_4]$），其中每个 $result_i$ 本身是对应案例的 $3N$ 个浮点值列表，按 $[x_1,y_1,z_1,\\ldots,x_N,y_N,z_N]$ 的顺序四舍五入到 $6$ 位小数。",
            "solution": "该问题要求实现一个程序，从一组内部坐标计算聚合物链的笛卡尔坐标。这是计算结构生物学和机器人学中的一个基本任务，通常被称为正向运动学问题。该解决方案基于使用齐次变换矩阵的坐标系链式原理。\n\n三维欧几里得空间中的刚体变换，由一次旋转和一次平移组成，可以用一个 $4 \\times 4$ 的齐次变换矩阵来表示。这个矩阵作用于齐次坐标（一个三维向量增加第四个分量，通常为 $1$）。一个通用的齐次变换矩阵 $H$ 具有以下结构：\n$$\nH = \\begin{bmatrix}\nR & \\mathbf{t} \\\\\n\\mathbf{0}^\\top & 1\n\\end{bmatrix}\n$$\n其中 $R$ 是一个 $3 \\times 3$ 的旋转矩阵，$\\mathbf{t}$ 是一个 $3 \\times 1$ 的平移向量，$\\mathbf{0}^\\top$ 是一个 $1 \\times 3$ 的零行向量。这种表示方法的强大之处在于，两个刚体变换的复合对应于它们各自齐次矩阵的矩阵乘法。\n\n问题将聚合物定义为 $N$ 个残基的序列。我们可以为每个残基关联一个局部坐标系。残基 $i$ 的全局位置和方向（位姿）可以用一个变换矩阵 $H_i$ 来描述，该矩阵将坐标从残基 $i$ 的局部坐标系映射到一个固定的全局坐标系。给定初始坐标系为单位矩阵，$H_0 = I_4$。\n\n从残基 $i-1$ 的坐标系到残基 $i$ 的坐标系的变换由一个局部变换矩阵 $T_i$ 描述。残基 $i$ 的全局位姿则通过链接这些变换获得：\n$$\nH_i = H_{i-1} T_i\n$$\n通过递归地应用这个规则，残基 $i$ 的位姿是所有先前局部变换的累积乘积：\n$$\nH_i = H_0 T_1 T_2 \\cdots T_i = I_4 T_1 T_2 \\cdots T_i = \\prod_{k=1}^{i} T_k\n$$\n残基 $i$ 在全局坐标系中的笛卡尔坐标是坐标系 $i$ 的原点位置。坐标系 $i$ 的原点在其自身的齐次坐标中是 $(0,0,0,1)^\\top$。将变换 $H_i$ 应用于此点，可得到其全局坐标：\n$$\n\\mathbf{p}_i^{\\text{hom}} = H_i \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} R_i & \\mathbf{t}_i \\\\ \\mathbf{0}^\\top & 1 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} \\mathbf{t}_i \\\\ 1 \\end{pmatrix}\n$$\n因此，笛卡尔坐标 $\\mathbf{p}_i$ 就是全局变换矩阵 $H_i$ 右上角 $3 \\times 1$ 块中的平移向量 $\\mathbf{t}_i$。\n\n问题的核心是为每个残基 $i$ 构建局部变换矩阵 $T_i$，这基于其内部坐标参数：键长 $l_i$、键角 $\\theta_i$ 和扭转角 $\\phi_i$。问题指定了从坐标系 $i-1$ 到坐标系 $i$ 构建变换的精确操作序列，这些操作都是在移动坐标系中定义的：\n1. 围绕局部 $z$ 轴进行角度为 $\\phi_i$ 的扭转旋转。\n2. 围绕变换后的局部 $x$ 轴进行角度为 $\\theta_i$ 的弯曲旋转。\n3. 沿变换后的局部 $z$ 轴进行距离为 $l_i$ 的平移。\n\n由于这些变换是相对于连续移动的坐标系执行的，因此总的局部变换矩阵 $T_i$ 是通过右乘基本变换矩阵得到的。然而，更直接的构建方法是分别计算总的旋转部分和平移部分。\n总的旋转矩阵 $R_i$ 是两个旋转的复合：$R_i = R_z(\\phi_i)R_x(\\theta_i)$。\n平移是在经过两次旋转后的新坐标系的局部 $z$ 轴上进行的。该新 $z$ 轴的方向由旋转矩阵 $R_i$ 的第三列给出。因此，平移向量 $\\mathbf{t}_i$ 是 $l_i$ 乘以 $R_i$ 的第三列。\n将这两部分组合成齐次变换矩阵 $T_i$：\n\n$$\nR_i = R_z(\\phi_i)R_x(\\theta_i) = \\begin{bmatrix}\n\\cos\\phi_i & -\\sin\\phi_i\\cos\\theta_i & \\sin\\phi_i\\sin\\theta_i \\\\\n\\sin\\phi_i & \\cos\\phi_i\\cos\\theta_i & -\\cos\\phi_i\\sin\\theta_i \\\\\n0 & \\sin\\theta_i & \\cos\\theta_i\n\\end{bmatrix}\n$$\n$$\n\\mathbf{t}_i = l_i \\cdot (\\text{第三列 } R_i) = \\begin{bmatrix} l_i\\sin\\phi_i\\sin\\theta_i \\\\ -l_i\\cos\\phi_i\\sin\\theta_i \\\\ l_i\\cos\\theta_i \\end{bmatrix}\n$$\n因此，完整的局部变换矩阵 $T_i$ 为：\n$$\nT_i = \\begin{pmatrix}\n\\cos\\phi_i  & -\\sin\\phi_i\\cos\\theta_i  & \\sin\\phi_i\\sin\\theta_i  & l_i\\sin\\phi_i\\sin\\theta_i \\\\\n\\sin\\phi_i  & \\cos\\phi_i\\cos\\theta_i  & -\\cos\\phi_i\\sin\\theta_i & -l_i\\cos\\phi_i\\sin\\theta_i \\\\\n0  & \\sin\\theta_i  & \\cos\\theta_i  & l_i\\cos\\theta_i \\\\\n0  & 0  & 0  & 1\n\\end{pmatrix}\n$$\n算法流程如下：\n1. 初始化全局变换矩阵 $H_{\\text{global}} = H_0 = I_4$。\n2. 对于从 $1$ 到 $N$ 的每个残基 $i$：\n   a. 获取参数 $l_i$、$\\theta_i$ 和 $\\phi_i$。\n   b. 使用上述公式构建局部变换矩阵 $T_i$。\n   c. 更新全局变换矩阵：$H_{\\text{global}} \\leftarrow H_{\\text{global}} \\cdot T_i$。\n   d. 从新的 $H_{\\text{global}}$ 的最后一列的前三个元素中提取笛卡尔坐标 $\\mathbf{p}_i$。\n3. 收集所有位置 $\\mathbf{p}_1, \\ldots, \\mathbf{p}_N$，将它们展平为单个列表，四舍五入到指定的精度，并格式化输出。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the polymer coordinate generation problem for all test cases.\n    \"\"\"\n\n    # Test suite as defined in the problem description.\n    # Note: np.pi is used for pi.\n    test_cases = [\n        {\n            \"N\": 3,\n            \"l\": [1.0, 1.0, 1.0],\n            \"theta\": [0.0, 0.0, 0.0],\n            \"phi\": [0.0, 0.0, 0.0]\n        },\n        {\n            \"N\": 3,\n            \"l\": [1.0, 1.0, 1.0],\n            \"theta\": [np.pi / 2, 0.0, 0.0],\n            \"phi\": [0.0, 0.0, 0.0]\n        },\n        {\n            \"N\": 4,\n            \"l\": [1.0, 1.0, 1.0, 1.0],\n            \"theta\": [np.pi / 2, np.pi / 2, np.pi / 2, np.pi / 2],\n            \"phi\": [0.0, np.pi / 2, np.pi / 2, np.pi / 2]\n        },\n        {\n            \"N\": 3,\n            \"l\": [1.0, 0.5, 0.0],\n            \"theta\": [np.pi / 3, np.pi / 3, 0.0],\n            \"phi\": [np.pi / 2, -np.pi / 2, np.pi]\n        }\n    ]\n\n    # A helper function to perform the calculation for a single case.\n    def get_cartesian_coordinates(N, l_vals, theta_vals, phi_vals):\n        \"\"\"\n        Calculates Cartesian coordinates from internal coordinates for a single polymer.\n\n        Args:\n            N (int): Number of residues.\n            l_vals (list): List of bond lengths.\n            theta_vals (list): List of bond angles in radians.\n            phi_vals (list): List of torsion angles in radians.\n\n        Returns:\n            list: A flattened list of Cartesian coordinates [x1, y1, z1, ...].\n        \"\"\"\n        # Initialize the global transformation matrix to the 4x4 identity matrix.\n        H_global = np.identity(4)\n        \n        positions = []\n\n        for i in range(N):\n            l = l_vals[i]\n            theta = theta_vals[i]\n            phi = phi_vals[i]\n\n            c_theta, s_theta = np.cos(theta), np.sin(theta)\n            c_phi, s_phi = np.cos(phi), np.sin(phi)\n\n            # Construct the local transformation matrix T_i based on the derived formula.\n            # T_i transforms coordinates from frame i to frame i-1.\n            T_i = np.array([\n                [c_phi, -s_phi * c_theta,  s_phi * s_theta, l * s_phi * s_theta],\n                [s_phi,  c_phi * c_theta, -c_phi * s_theta, -l * c_phi * s_theta],\n                [0,      s_theta,          c_theta,         l * c_theta],\n                [0,      0,                0,               1]\n            ])\n            \n            # Update the global transformation matrix by post-multiplying with T_i.\n            # This chains the transformation: H_i = H_{i-1} * T_i.\n            H_global = H_global @ T_i\n\n            # The position of residue i is the translation component of H_i.\n            # This is the first 3 elements of the 4th column of H_global.\n            position = H_global[:3, 3]\n            positions.append(position)\n            \n        # Flatten the list of position vectors into a single list of coordinates.\n        if not positions:\n            return []\n            \n        flat_coordinates = np.array(positions).flatten()\n        \n        # Round each coordinate to 6 decimal places.\n        rounded_coordinates = [round(coord, 6) for coord in flat_coordinates]\n        \n        return rounded_coordinates\n\n    # Process all test cases\n    all_results = []\n    for case in test_cases:\n        N = case[\"N\"]\n        l_vals = case[\"l\"]\n        theta_vals = case[\"theta\"]\n        phi_vals = case[\"phi\"]\n        \n        result = get_cartesian_coordinates(N, l_vals, theta_vals, phi_vals)\n        all_results.append(result)\n\n    # Format the final output string as a list of lists.\n    # Each inner list is converted to its string representation.\n    # These string representations are joined by a comma.\n    results_str = [str(res) for res in all_results]\n    final_output = f\"[{','.join(results_str)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "坐标系之间的转换看似直接，但在数值上是否总是稳定的？这项高级练习将深入探讨坐标变换的数学核心，特别是在接近几何奇点（如线性键角）时所面临的挑战。通过计算雅可比矩阵（Jacobian matrix）的条件数（condition number），您将能够量化变换的敏感性，并从根本上理解为什么在分子的特定构象下（例如近线性排列），几何优化或动力学模拟会变得不稳定或难以收敛。",
            "id": "3855225",
            "problem": "考虑嵌入在三维空间中的一个四原子链 $A$–$B$–$C$–$D$。固定原子 $A$、$B$ 和 $C$，在原子 $C$ 处定义一个局域右手正交坐标系，方法如下：令 $\\hat{\\mathbf{w}}$ 为沿 $\\mathbf{C}\\mathbf{B}$ 方向的单位向量，令 $\\hat{\\mathbf{u}}$ 为平面 $A$–$B$–$C$ 的单位法向量（选择使其满足 $\\hat{\\mathbf{u}} \\perp \\hat{\\mathbf{w}}$），并令 $\\hat{\\mathbf{v}} = \\hat{\\mathbf{w}} \\times \\hat{\\mathbf{u}}$。用笛卡尔坐标 $(u, v, w)$ 表示原子 $D$ 相对于原子 $C$ 在此局域坐标系中的位置，使得 $\\mathbf{CD} = u \\,\\hat{\\mathbf{u}} + v \\,\\hat{\\mathbf{v}} + w \\,\\hat{\\mathbf{w}}$。定义与原子 $D$ 相关的内坐标为：键长 $r = d_{CD}$，在 $C$ 点的键角 $\\theta = \\angle B C D \\in (0,\\pi)$，以及二面角 $\\tau = \\angle A B C D \\in (-\\pi,\\pi]$，其常规方向由坐标系 $(\\hat{\\mathbf{u}}, \\hat{\\mathbf{v}}, \\hat{\\mathbf{w}})$ 诱导。\n\n仅使用基本定义，考虑在此局域坐标系中从笛卡尔坐标到内坐标映射的雅可比矩阵 $J = \\partial(r, \\theta, \\tau)/\\partial(u, v, w)$。$J$ 的 $2$-范数条件数 $\\kappa_{2}(J)$ 定义为其最大奇异值与最小奇异值之比。对于原子 $C$ 处一个物理上合理的近线性几何构型，取 $r = 1.50$ 埃（angstrom），以及 $\\theta = \\pi - \\varepsilon$，其中 $\\varepsilon = 0.0100$ 弧度（radian）。计算此几何构型的 $\\kappa_{2}(J)$。将您的最终答案表示为无量纲量，并将结果四舍五入到四位有效数字。此外，基于第一性原理，简要解释此条件数对于接近线性构型时逆映射（从内坐标到笛卡尔坐标）的稳定性意味着什么。",
            "solution": "用户希望计算一个四原子链中，从局域笛卡尔坐标到内坐标变换的雅可比矩阵的 $2$-范数条件数。\n\n### 第 1 步：建立坐标变换\n问题在原子 $C$ 处定义了一个局域右手正交坐标系 $(\\hat{\\mathbf{u}}, \\hat{\\mathbf{v}}, \\hat{\\mathbf{w}})$。\n- $\\hat{\\mathbf{w}}$ 是沿 $\\mathbf{CB}$ 方向的单位向量。\n- $\\hat{\\mathbf{u}}$ 是平面 $A$–$B$–$C$ 的单位法向量。\n- $\\hat{\\mathbf{v}} = \\hat{\\mathbf{w}} \\times \\hat{\\mathbf{u}}$。\n\n原子 $D$ 相对于 $C$ 的位置在此坐标系中由向量 $\\mathbf{r}_{CD} = u\\,\\hat{\\mathbf{u}} + v\\,\\hat{\\mathbf{v}} + w\\,\\hat{\\mathbf{w}}$ 给出。问题在于将局域笛卡尔坐标 $(u, v, w)$ 与内坐标 $(r, \\theta, \\tau)$ 关联起来。\n\n内坐标定义如下：\n- **键长 $r$**：$r = d_{CD} = \\|\\mathbf{r}_{CD}\\|$。\n- **键角 $\\theta$**：$\\theta = \\angle BCD \\in (0, \\pi)$，即 $\\mathbf{r}_{CB}$ 和 $\\mathbf{r}_{CD}$ 之间的夹角。\n- **二面角 $\\tau$**：$\\tau = \\angle ABCD \\in (-\\pi, \\pi]$，它测量围绕 $B-C$ 键的扭转。\n\n让我们用笛卡尔坐标来表示内坐标。\n1.  **键长 $r$**：\n    $$r = \\sqrt{u^2 + v^2 + w^2}$$\n2.  **键角 $\\theta$**：\n    向量 $\\mathbf{r}_{CB}$ 沿着 $-\\hat{\\mathbf{w}}$ 方向。根据角度的点积定义可得：\n    $$\\cos\\theta = \\frac{\\mathbf{r}_{CB} \\cdot \\mathbf{r}_{CD}}{\\|\\mathbf{r}_{CB}\\| \\|\\mathbf{r}_{CD}\\|} = \\frac{(-d_{BC}\\hat{\\mathbf{w}}) \\cdot (u\\,\\hat{\\mathbf{u}} + v\\,\\hat{\\mathbf{v}} + w\\,\\hat{\\mathbf{w}})}{d_{BC} \\cdot r}$$\n    利用基向量的正交性（$\\hat{\\mathbf{w}} \\cdot \\hat{\\mathbf{u}} = 0$, $\\hat{\\mathbf{w}} \\cdot \\hat{\\mathbf{v}} = 0$, $\\hat{\\mathbf{w}} \\cdot \\hat{\\mathbf{w}} = 1$），上式可简化为：\n    $$\\cos\\theta = \\frac{-w}{r}$$\n    由于 $\\theta \\in (0, \\pi)$，这唯一定义了 $\\theta = \\arccos(-w/r)$。\n\n3.  **二面角 $\\tau$**：\n    二面角 $\\tau$ 是围绕 $B-C$ 轴（$\\hat{\\mathbf{w}}$ 方向）的旋转角。参考平面是 $A-B-C$，其法向量是 $\\hat{\\mathbf{u}}$。平面 $B-C-D$ 由向量 $\\mathbf{r}_{CB}$ 和 $\\mathbf{r}_{CD}$ 定义。$\\mathbf{r}_{CD}$ 在垂直于 $B-C$ 轴的平面（即 $\\hat{\\mathbf{u}}-\\hat{\\mathbf{v}}$ 平面）上的投影是 $u\\,\\hat{\\mathbf{u}} + v\\,\\hat{\\mathbf{v}}$。二面角 $\\tau$ 是这个投影向量与参考方向 $\\hat{\\mathbf{u}}$ 所成的夹角。\n    因此，我们可以确定：\n    $$u = (r\\sin\\theta)\\cos\\tau$$\n    $$v = (r\\sin\\theta)\\sin\\tau$$\n    这导出 $\\tau = \\operatorname{atan2}(v, u)$。\n\n这些关系定义了从 $(u,v,w)$到 $(r,\\theta,\\tau)$ 的映射。问题要求雅可比矩阵 $J = \\partial(r, \\theta, \\tau)/\\partial(u, v, w)$。直接计算这个矩阵很繁琐。更直接的方法是计算逆变换的雅可比矩阵 $J_{inv} = \\partial(u, v, w)/\\partial(r, \\theta, \\tau)$，然后利用 $J$ 的奇异值是 $J_{inv}$ 奇异值的倒数这一性质，这意味着它们的条件数相等：$\\kappa_2(J) = \\kappa_2(J_{inv})$。\n\n### 第 2 步：计算逆变换的雅可比矩阵\n逆变换由以下公式给出：\n$$u(r, \\theta, \\tau) = r\\sin\\theta\\cos\\tau$$\n$$v(r, \\theta, \\tau) = r\\sin\\theta\\sin\\tau$$\n$$w(r, \\theta, \\tau) = -r\\cos\\theta$$\n\n雅可比矩阵 $J_{inv}$ 是：\n$$J_{inv} = \\begin{pmatrix}\n\\frac{\\partial u}{\\partial r} & \\frac{\\partial u}{\\partial \\theta} & \\frac{\\partial u}{\\partial \\tau} \\\\\n\\frac{\\partial v}{\\partial r} & \\frac{\\partial v}{\\partial \\theta} & \\frac{\\partial v}{\\partial \\tau} \\\\\n\\frac{\\partial w}{\\partial r} & \\frac{\\partial w}{\\partial \\theta} & \\frac{\\partial w}{\\partial \\tau}\n\\end{pmatrix}$$\n\n计算偏导数：\n$$J_{inv} = \\begin{pmatrix}\n\\sin\\theta\\cos\\tau & r\\cos\\theta\\cos\\tau & -r\\sin\\theta\\sin\\tau \\\\\n\\sin\\theta\\sin\\tau & r\\cos\\theta\\sin\\tau & r\\sin\\theta\\cos\\tau \\\\\n-\\cos\\theta & r\\sin\\theta & 0\n\\end{pmatrix}$$\n\n### 第 3 步：计算奇异值\n$J_{inv}$ 的奇异值是矩阵 $G = (J_{inv})^T J_{inv}$ 的特征值的平方根。这个矩阵 $G$ 也称为坐标系 $(r,\\theta,\\tau)$ 的度量张量。\n$G$ 的元素是 $G_{ij} = \\sum_k \\frac{\\partial x_k}{\\partial q_i} \\frac{\\partial x_k}{\\partial q_j}$，其中 $x_k \\in \\{u,v,w\\}$ 且 $q_i \\in \\{r,\\theta,\\tau\\}$。\n\n$G_{rr} = (\\frac{\\partial u}{\\partial r})^2 + (\\frac{\\partial v}{\\partial r})^2 + (\\frac{\\partial w}{\\partial r})^2 = (\\sin\\theta\\cos\\tau)^2 + (\\sin\\theta\\sin\\tau)^2 + (-\\cos\\theta)^2 = \\sin^2\\theta(\\cos^2\\tau+\\sin^2\\tau)+\\cos^2\\theta=1$。\n\n$G_{\\theta\\theta} = (\\frac{\\partial u}{\\partial \\theta})^2 + (\\frac{\\partial v}{\\partial \\theta})^2 + (\\frac{\\partial w}{\\partial \\theta})^2 = (r\\cos\\theta\\cos\\tau)^2 + (r\\cos\\theta\\sin\\tau)^2 + (r\\sin\\theta)^2 = r^2\\cos^2\\theta(\\cos^2\\tau+\\sin^2\\tau)+r^2\\sin^2\\theta = r^2$。\n\n$G_{\\tau\\tau} = (\\frac{\\partial u}{\\partial \\tau})^2 + (\\frac{\\partial v}{\\partial \\tau})^2 + (\\frac{\\partial w}{\\partial \\tau})^2 = (-r\\sin\\theta\\sin\\tau)^2 + (r\\sin\\theta\\cos\\tau)^2 + 0^2 = r^2\\sin^2\\theta(\\sin^2\\tau+\\cos^2\\tau) = r^2\\sin^2\\theta$。\n\n非对角元素为零，这是正交坐标系的一个关键性质。例如：\n$G_{r\\theta} = \\frac{\\partial u}{\\partial r}\\frac{\\partial u}{\\partial \\theta} + \\frac{\\partial v}{\\partial r}\\frac{\\partial v}{\\partial \\theta} + \\frac{\\partial w}{\\partial r}\\frac{\\partial w}{\\partial \\theta} = (\\sin\\theta\\cos\\tau)(r\\cos\\theta\\cos\\tau) + (\\sin\\theta\\sin\\tau)(r\\cos\\theta\\sin\\tau) + (-\\cos\\theta)(r\\sin\\theta) = r\\sin\\theta\\cos\\theta - r\\sin\\theta\\cos\\theta = 0$。\n类似地，$G_{r\\tau}=0$ 且 $G_{\\theta\\tau}=0$。\n\n因此，矩阵 $G$ 是对角矩阵：\n$$G = (J_{inv})^T J_{inv} = \\begin{pmatrix}\n1 & 0 & 0 \\\\\n0 & r^2 & 0 \\\\\n0 & 0 & r^2\\sin^2\\theta\n\\end{pmatrix}$$\n\n这个对角矩阵的特征值是其对角线元素：$\\lambda_1 = 1$, $\\lambda_2 = r^2$, $\\lambda_3 = r^2\\sin^2\\theta$。\n$J_{inv}$ 的奇异值是这些特征值的平方根：\n$\\sigma_1(J_{inv}) = \\sqrt{1} = 1$\n$\\sigma_2(J_{inv}) = \\sqrt{r^2} = r$ （因为 $r > 0$）\n$\\sigma_3(J_{inv}) = \\sqrt{r^2\\sin^2\\theta} = r|\\sin\\theta| = r\\sin\\theta$ （因为 $\\theta \\in (0, \\pi)$ 意味着 $\\sin\\theta > 0$）。\n\n原始雅可比矩阵 $J$ 的奇异值是 $J_{inv}$ 奇异值的倒数：\n$\\sigma_1(J) = 1$, $\\sigma_2(J) = 1/r$, $\\sigma_3(J) = 1/(r\\sin\\theta)$。\n\n### 第 4 步：计算条件数\n$2$-范数条件数 $\\kappa_2(J)$ 是 $J$ 的最大奇异值与最小奇异值之比。\n$$\\kappa_2(J) = \\frac{\\sigma_{max}}{\\sigma_{min}}$$\n问题指定 $r = 1.50$ 和 $\\theta = \\pi - \\varepsilon$，其中 $\\varepsilon = 0.0100$。\n因为 $r=1.50 > 1$，我们有 $1/r  1$。\n角度 $\\theta$ 接近 $\\pi$，所以 $\\sin\\theta = \\sin(\\pi - \\varepsilon) = \\sin\\varepsilon$ 是一个很小的正数。具体来说，$\\sin(0.0100) \\approx 0.0100$。\n因此，$r\\sin\\theta \\approx 1.50 \\times 0.0100 = 0.0150$，这远小于 $1$。这意味着 $1/(r\\sin\\theta)$ 远大于 $1$。\n奇异值的集合是 $\\{1, 1/1.50, 1/(1.50\\sin(\\pi - 0.0100))\\}$。\n最大奇异值是 $\\sigma_{max} = 1/(r\\sin\\theta)$。\n由于 $r=1.5 > 1$, 最小奇异值是 $\\sigma_{min} = 1/r$。\n\n所以，条件数是：\n$$\\kappa_2(J) = \\frac{1/(r\\sin\\theta)}{1/r} = \\frac{1}{\\sin\\theta}$$\n这个简洁的结果表明，条件数仅取决于键角 $\\theta$，并且当 $\\theta$ 趋近于 $0$ 或 $\\pi$ 时，条件数趋于无穷大。\n\n现在我们代入给定的值：\n$$\\kappa_2(J) = \\frac{1}{\\sin(\\pi - 0.0100)} = \\frac{1}{\\sin(0.0100)}$$\n使用计算器计算 $\\sin(0.0100)$（以弧度为单位）：\n$$\\sin(0.0100) \\approx 0.0099998333$$\n$$\\kappa_2(J) \\approx \\frac{1}{0.0099998333} \\approx 100.0016667$$\n将结果四舍五入到四位有效数字，得到 $100.0$。\n\n### 第 5 步：解释\n条件数 $\\kappa_2(J) \\approx 100.0$ 是对近线性几何构型下，从笛卡尔坐标到内坐标变换（以及其逆变换）敏感性的一个定量度量。大的条件数表示该问题是病态的 (ill-conditioned)。在此背景下，它意味着内坐标 $(r, \\theta, \\tau)$ 中的微小扰动或误差，在通过逆变换映射到局域笛卡尔坐标 $(u, v, w)$ 时，可能会被放大为巨大的变化。奇点发生在 $\\theta=\\pi$（以及 $\\theta=0$）处，此时由于原子 $B, C, D$ 共线，二面角 $\\tau$ 变得无定义（ill-defined）。条件数为 $100.0$ 表明，内坐标中的相对误差在转换后的笛卡尔坐标中最多可被放大 $100.0$ 倍。当使用内坐标对含有近线性片段的分子进行几何优化和分子动力学模拟等分子建模任务时，这种数值不稳定性会使问题变得复杂。",
            "answer": "$$\\boxed{100.0}$$"
        }
    ]
}