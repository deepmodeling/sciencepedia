{
    "hands_on_practices": [
        {
            "introduction": "This first exercise delves into the core mechanism of the Metropolis Monte Carlo algorithm: the decision to accept or reject a proposed conformational change. We will calculate the acceptance probability for a simple, yet fundamental, move involving the rotation of a single dihedral angle in a flexible molecule. Mastering this core calculation is the foundational step toward understanding how MC simulations navigate the vast energy landscapes of complex biomolecules. ",
            "id": "3840331",
            "problem": "A single dihedral angle $\\phi$ in a flexible ligand is modeled by the torsional potential\n$$\nE_{\\text{dihedral}}(\\phi) \\;=\\; \\sum_{n=1}^{3} \\frac{V_n}{2}\\,\\big[1 + \\cos(n\\phi - \\gamma_n)\\big],\n$$\nwhere all angles are in radians and energies are in $\\text{kJ}\\,\\text{mol}^{-1}$. Consider a canonical-ensemble Monte Carlo (MC) move that proposes changing the torsion from an initial value $\\phi$ to a new value $\\phi'$, using a symmetric proposal distribution over $\\phi$. Assume this torsional term captures the relevant energetic change for the move (i.e., neglect couplings to other degrees of freedom for this step).\n\nParameters for this torsion are: $V_1 = 2.5\\,\\text{kJ}\\,\\text{mol}^{-1}$ with $\\gamma_1 = 0$, $V_2 = 1.2\\,\\text{kJ}\\,\\text{mol}^{-1}$ with $\\gamma_2 = \\pi/3$, and $V_3 = 0.8\\,\\text{kJ}\\,\\text{mol}^{-1}$ with $\\gamma_3 = \\pi$. The initial angle is $\\phi = 2.1$ and the proposed angle is $\\phi' = \\phi + \\Delta\\phi$ with $\\Delta\\phi = -0.7$ (hence $\\phi' = 1.4$). The temperature is $T = 300\\,\\text{K}$.\n\nStarting from the canonical ensemble and detailed balance principles appropriate for a symmetric proposal in Markov chain Monte Carlo (MCMC), compute the energy change $\\Delta E = E_{\\text{dihedral}}(\\phi') - E_{\\text{dihedral}}(\\phi)$ and then evaluate the acceptance probability for this move at temperature $T$.\n\nExpress the final answer as the acceptance probability, in decimal form, rounded to four significant figures. Do not include units with the final number.",
            "solution": "The problem requires the calculation of the acceptance probability for a Monte Carlo move in the canonical ensemble. The standard method for this is the Metropolis-Hastings algorithm. The acceptance probability $P_{\\text{acc}}$ for a move from a state with configuration $\\phi$ to a new configuration $\\phi'$ is given by:\n$$P_{\\text{acc}}(\\phi \\to \\phi') = \\min\\left(1, \\frac{\\pi(\\phi')}{\\pi(\\phi)} \\frac{g(\\phi|\\phi')}{g(\\phi'|\\phi)}\\right)$$\nwhere $\\pi(x)$ is the probability of state $x$ in the target distribution, and $g(y|x)$ is the conditional probability of proposing state $y$ given state $x$.\n\nIn the canonical ensemble, the probability of a state is proportional to its Boltzmann factor, $\\pi(\\phi) \\propto \\exp(-E(\\phi)/(k_B T))$, where $E(\\phi)$ is the energy of the state, $k_B$ is the Boltzmann constant, and $T$ is the absolute temperature. The problem states that the proposal distribution is symmetric, which means $g(\\phi|\\phi') = g(\\phi'|\\phi)$. Under these conditions, the acceptance probability simplifies to the Metropolis criterion:\n$$P_{\\text{acc}}(\\phi \\to \\phi') = \\min\\left(1, \\frac{\\exp(-E(\\phi')/(k_B T))}{\\exp(-E(\\phi)/(k_B T))}\\right) = \\min\\left(1, \\exp\\left(-\\frac{E(\\phi') - E(\\phi)}{k_B T}\\right)\\right)$$\nLet $\\Delta E = E(\\phi') - E(\\phi)$ be the change in energy. The acceptance probability is:\n$$P_{\\text{acc}} = \\min(1, \\exp(-\\Delta E / (k_B T)))$$\nSince the given energies are in units of $\\text{kJ}\\,\\text{mol}^{-1}$, we must use the molar gas constant $R$ instead of the Boltzmann constant $k_B$. The thermal energy is $RT$.\n\nThe first step is to calculate the energy change $\\Delta E = E_{\\text{dihedral}}(\\phi') - E_{\\text{dihedral}}(\\phi)$. Using the provided potential energy function:\n$$\n\\Delta E = \\sum_{n=1}^{3} \\frac{V_n}{2}\\,\\big[1 + \\cos(n\\phi' - \\gamma_n)\\big] - \\sum_{n=1}^{3} \\frac{V_n}{2}\\,\\big[1 + \\cos(n\\phi - \\gamma_n)\\big]\n$$\nThe constant $1$ within the brackets cancels out upon subtraction, yielding:\n$$\n\\Delta E = \\sum_{n=1}^{3} \\frac{V_n}{2}\\,\\big[\\cos(n\\phi' - \\gamma_n) - \\cos(n\\phi - \\gamma_n)\\big]\n$$\nWe are given the initial angle $\\phi = 2.1\\,\\text{rad}$ and the proposed angle $\\phi' = 1.4\\,\\text{rad}$. We now calculate the contribution to $\\Delta E$ for each term $n=1, 2, 3$.\n\nFor $n=1$: $V_1 = 2.5\\,\\text{kJ}\\,\\text{mol}^{-1}$, $\\gamma_1 = 0$.\n$$\n\\Delta E_1 = \\frac{2.5}{2} \\big[\\cos(1 \\cdot 1.4 - 0) - \\cos(1 \\cdot 2.1 - 0)\\big] = 1.25 \\big[\\cos(1.4) - \\cos(2.1)\\big]\n$$\nUsing a calculator in radian mode:\n$$\n\\cos(1.4) \\approx 0.169967 \\quad \\text{and} \\quad \\cos(2.1) \\approx -0.504846\n$$\n$$\n\\Delta E_1 \\approx 1.25 \\big[0.169967 - (-0.504846)\\big] = 1.25 \\big[0.674813\\big] \\approx 0.843516\\,\\text{kJ}\\,\\text{mol}^{-1}\n$$\n\nFor $n=2$: $V_2 = 1.2\\,\\text{kJ}\\,\\text{mol}^{-1}$, $\\gamma_2 = \\pi/3$.\n$$\n\\Delta E_2 = \\frac{1.2}{2} \\big[\\cos(2 \\cdot 1.4 - \\pi/3) - \\cos(2 \\cdot 2.1 - \\pi/3)\\big] = 0.6 \\big[\\cos(2.8 - \\pi/3) - \\cos(4.2 - \\pi/3)\\big]\n$$\nUsing $\\pi \\approx 3.141593$:\n$$\n\\cos(2.8 - \\pi/3) \\approx \\cos(2.8 - 1.047198) = \\cos(1.752802) \\approx -0.180425\n$$\n$$\n\\cos(4.2 - \\pi/3) \\approx \\cos(4.2 - 1.047198) = \\cos(3.152802) \\approx -0.999818\n$$\n$$\n\\Delta E_2 \\approx 0.6 \\big[-0.180425 - (-0.999818)\\big] = 0.6 \\big[0.819393\\big] \\approx 0.491636\\,\\text{kJ}\\,\\text{mol}^{-1}\n$$\n\nFor $n=3$: $V_3 = 0.8\\,\\text{kJ}\\,\\text{mol}^{-1}$, $\\gamma_3 = \\pi$.\n$$\n\\Delta E_3 = \\frac{0.8}{2} \\big[\\cos(3 \\cdot 1.4 - \\pi) - \\cos(3 \\cdot 2.1 - \\pi)\\big] = 0.4 \\big[\\cos(4.2 - \\pi) - \\cos(6.3 - \\pi)\\big]\n$$\n$$\n\\cos(4.2 - \\pi) \\approx \\cos(4.2 - 3.141593) = \\cos(1.058407) \\approx 0.490056\n$$\n$$\n\\cos(6.3 - \\pi) \\approx \\cos(6.3 - 3.141593) = \\cos(3.158407) \\approx -0.999718\n$$\n$$\n\\Delta E_3 \\approx 0.4 \\big[0.490056 - (-0.999718)\\big] = 0.4 \\big[1.489774\\big] \\approx 0.595910\\,\\text{kJ}\\,\\text{mol}^{-1}\n$$\n\nThe total energy change is the sum of these contributions:\n$$\n\\Delta E = \\Delta E_1 + \\Delta E_2 + \\Delta E_3 \\approx 0.843516 + 0.491636 + 0.595910 = 1.931062\\,\\text{kJ}\\,\\text{mol}^{-1}\n$$\nSince $\\Delta E  0$, the move is energetically unfavorable, and the acceptance probability will be less than $1$.\n\nNext, we calculate the thermal energy $RT$.\n$$\nR \\approx 8.31446 \\times 10^{-3}\\,\\text{kJ}\\,\\text{mol}^{-1}\\,\\text{K}^{-1} \\quad \\text{and} \\quad T = 300\\,\\text{K}\n$$\n$$\nRT \\approx (8.31446 \\times 10^{-3}) \\cdot 300 = 2.494338\\,\\text{kJ}\\,\\text{mol}^{-1}\n$$\nNow we compute the exponent in the acceptance probability formula:\n$$\n-\\frac{\\Delta E}{RT} \\approx -\\frac{1.931062}{2.494338} \\approx -0.774180\n$$\nFinally, we calculate the acceptance probability:\n$$\nP_{\\text{acc}} = \\exp\\left(-\\frac{\\Delta E}{RT}\\right) \\approx \\exp(-0.774180) \\approx 0.461064\n$$\nThe problem asks for the result rounded to four significant figures.\n$$\nP_{\\text{acc}} \\approx 0.4611\n$$",
            "answer": "$$\n\\boxed{0.4611}\n$$"
        },
        {
            "introduction": "Building on the basic Metropolis rule, this practice addresses a more general and powerful scenario common in biomolecular modeling. We will evaluate a move between discrete conformational states, such as a protein sidechain flipping between its preferred rotamers. This exercise introduces the full Metropolis-Hastings acceptance criterion, which correctly handles the common situation where the probability of proposing a move is not symmetric, a crucial concept for implementing many advanced and efficient sampling algorithms. ",
            "id": "3840278",
            "problem": "A single-residue sidechain in a protein is explored by a conformational search using a Markov chain Monte Carlo algorithm in the canonical ensemble. The sidechain is represented by a discrete rotamer library. At any instant, a proposal consists of choosing a different rotamer from a state-dependent, sterically filtered set of allowed rotamers for that instant, uniformly among those that are not equal to the current rotamer. The instantaneous set of allowed rotamers can change after a move because steric clashes with the environment depend on the current sidechain orientation.\n\nConsider a proposed move from the current rotamer $i$ to a new rotamer $j$ at temperature $T = 300\\ \\mathrm{K}$. The potential energy is a sum of a torsional term and a nonbonded term, so that the change in potential energy upon the move is $\\Delta U = \\Delta U_{\\mathrm{tor}} + \\Delta U_{\\mathrm{nb}}$. For this particular move, the torsional energy change is $\\Delta U_{\\mathrm{tor}} = +2.3\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}$ and the nonbonded energy change is $\\Delta U_{\\mathrm{nb}} = -0.5\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}$. The molar gas constant is $R = 8.314462618\\times 10^{-3}\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}$.\n\nBecause of the steric filter, when the system is in rotamer $i$ there are $K_{i} = 3$ allowed rotamers (including $i$ itself), and the proposal mechanism draws uniformly from the $K_{i}-1$ alternatives that differ from $i$. After the move, when the system would be in rotamer $j$, there are $K_{j} = 6$ allowed rotamers (including $j$ itself), and from $j$ the proposal mechanism would draw uniformly from the $K_{j}-1$ alternatives that differ from $j$.\n\nStarting from the canonical Boltzmann distribution and the requirement of detailed balance for the Markov chain, derive the correct acceptance probability for the move $i \\to j$ that accounts for the possible asymmetry of the discrete proposal mechanism induced by the state-dependent allowed-rotamer sets. Then evaluate this acceptance probability numerically for the data above. Express your final answer as a dimensionless number rounded to four significant figures.\n\nIn one or two sentences, briefly indicate how the acceptance expression should be modified if, instead of a uniform choice among the allowed alternatives, the proposal from any state uses state-dependent bias weights over the allowed alternatives.",
            "solution": "The foundation of a Markov chain Monte Carlo (MCMC) simulation that samples from a target probability distribution is the detailed balance condition. This condition ensures that the stationary distribution of the Markov chain is the desired target distribution. For a system in the canonical ensemble, the target distribution is the Boltzmann distribution, where the probability $P(x)$ of a state $x$ with potential energy $U(x)$ at temperature $T$ is given by:\n$$ P(x) \\propto \\exp\\left(-\\frac{U(x)}{RT}\\right) $$\nwhere $R$ is the molar gas constant.\n\nThe detailed balance condition for any two states, say $i$ and $j$, is:\n$$ P(i) \\cdot T(i \\to j) = P(j) \\cdot T(j \\to i) $$\nwhere $T(i \\to j)$ is the total transition probability from state $i$ to state $j$.\n\nIn the Metropolis-Hastings algorithm, the transition probability is a product of the proposal probability $g(i \\to j)$ and the acceptance probability $A(i \\to j)$:\n$$ T(i \\to j) = g(i \\to j) \\cdot A(i \\to j) \\quad (\\text{for } i \\neq j) $$\nSubstituting this into the detailed balance equation gives:\n$$ P(i) \\cdot g(i \\to j) \\cdot A(i \\to j) = P(j) \\cdot g(j \\to i) \\cdot A(j \\to i) $$\nThe general form for the acceptance probability that satisfies this condition is given by:\n$$ A(i \\to j) = \\min\\left(1, \\frac{P(j) \\cdot g(j \\to i)}{P(i) \\cdot g(i \\to j)}\\right) $$\n\nWe must first determine the ratio of the Boltzmann probabilities and the ratio of the proposal probabilities. The ratio of the Boltzmann probabilities is:\n$$ \\frac{P(j)}{P(i)} = \\frac{\\exp(-U(j)/(RT))}{\\exp(-U(i)/(RT))} = \\exp\\left(-\\frac{U(j) - U(i)}{RT}\\right) = \\exp\\left(-\\frac{\\Delta U}{RT}\\right) $$\nwhere $\\Delta U = U(j) - U(i)$ is the change in potential energy for the move $i \\to j$.\n\nThe proposal probability $g(i \\to j)$ is the probability of proposing a move to state $j$ given that the system is currently in state $i$. The problem states that from state $i$, there are $K_i$ sterically allowed rotamers (including $i$ itself). A new rotamer is chosen uniformly from the $K_i - 1$ alternatives. Therefore, the probability of proposing a move to a specific rotamer $j$ is:\n$$ g(i \\to j) = \\frac{1}{K_i - 1} $$\nSimilarly, the proposal probability for the reverse move, from $j$ to $i$, depends on the $K_j$ allowed rotamers from state $j$. The probability of picking $i$ from the $K_j - 1$ alternatives to $j$ is:\n$$ g(j \\to i) = \\frac{1}{K_j - 1} $$\nThe proposal mechanism is asymmetric because $K_i \\neq K_j$.\n\nSubstituting these expressions into the acceptance probability formula yields the Metropolis-Hastings acceptance rule:\n$$ A(i \\to j) = \\min\\left(1, \\exp\\left(-\\frac{\\Delta U}{RT}\\right) \\cdot \\frac{g(j \\to i)}{g(i \\to j)}\\right) $$\n$$ A(i \\to j) = \\min\\left(1, \\exp\\left(-\\frac{\\Delta U}{RT}\\right) \\cdot \\frac{1/(K_j - 1)}{1/(K_i - 1)}\\right) $$\n$$ A(i \\to j) = \\min\\left(1, \\frac{K_i - 1}{K_j - 1} \\exp\\left(-\\frac{\\Delta U}{RT}\\right)\\right) $$\nThis is the required expression for the acceptance probability.\n\nNow, we evaluate this expression numerically using the provided data.\nThe change in potential energy is:\n$$ \\Delta U = \\Delta U_{\\mathrm{tor}} + \\Delta U_{\\mathrm{nb}} = +2.3\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1} + (-0.5\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}) = 1.8\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1} $$\nThe thermal energy is:\n$$ RT = (8.314462618 \\times 10^{-3}\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}) \\cdot (300\\ \\mathrm{K}) \\approx 2.4943388\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1} $$\nThe argument of the exponential function is:\n$$ -\\frac{\\Delta U}{RT} = -\\frac{1.8\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}}{2.4943388\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}} \\approx -0.72164 $$\nThe exponential term is:\n$$ \\exp\\left(-\\frac{\\Delta U}{RT}\\right) \\approx \\exp(-0.72164) \\approx 0.48596 $$\nThe proposal probability ratio is:\n$$ \\frac{K_i - 1}{K_j - 1} = \\frac{3 - 1}{6 - 1} = \\frac{2}{5} = 0.4 $$\nCombining these terms, the argument of the $\\min$ function is:\n$$ \\frac{K_i - 1}{K_j - 1} \\exp\\left(-\\frac{\\Delta U}{RT}\\right) \\approx 0.4 \\times 0.48596 = 0.194384 $$\nFinally, the acceptance probability is:\n$$ A(i \\to j) = \\min(1, 0.194384) = 0.194384 $$\nRounding to four significant figures, the acceptance probability is $0.1944$.\n\nRegarding the modification for state-dependent bias weights: if the proposal from any state used state-dependent bias weights $w_{ik}$ instead of a uniform choice, the specific proposal probabilities $g(i \\to j)$ and $g(j \\to i)$ would be calculated from these weights. Consequently, the simple ratio of counts $\\frac{K_i - 1}{K_j - 1}$ in the acceptance formula would be replaced by the more general ratio of proposal probabilities $\\frac{g(j \\to i)}{g(i \\to j)}$.",
            "answer": "$$\\boxed{0.1944}$$"
        },
        {
            "introduction": "This capstone practice integrates the principles of Monte Carlo sampling into a complete simulation project, from initial setup to final analysis. You are tasked with implementing a simulation to study the stability of a polypeptide's alpha-helical structure using a coarse-grained model. The exercise requires generating coordinates, implementing a sophisticated \"concerted rotation\" move that preserves local geometry, and running a full simulation, giving you practical experience in the entire workflow of a computational experiment. ",
            "id": "3840266",
            "problem": "You are tasked with implementing a concerted backbone move for a coarse-grained polypeptide and evaluating its effect on local secondary structure stability using Monte Carlo conformational search. The model consists of a chain of alpha-carbon atoms, denoted by $C_\\alpha$, with fixed bond lengths and fixed bond angles. All rotations are performed as rigid-body transformations to preserve intra-window bond geometry. The evaluation of secondary structure stability is quantified by a distance-based helical order metric.\n\nFundamental base and definitions:\n- The chain comprises $N$ backbone sites (alpha-carbons $C_\\alpha$) connected linearly with fixed bond length $b$ and fixed bond angle $\\theta_0$. The internal coordinates of the chain are given by a Z-matrix specification using bond length $b$ in Angstroms (Å), bond angle $\\theta_0$ in radians, and dihedral angles $\\tau_i$ for $i \\in \\{2,3,\\dots,N-1\\}$ in radians. The initial dihedrals are set to a constant helical value $\\tau^\\mathrm{helix}$.\n- A local secondary structure energy function $E_\\mathrm{sec}$ is defined as a sum of squared deviations of specific $C_\\alpha$ pair distances from their target alpha-helical values, namely the pairs separated by $k = 3$ and $k = 4$ along the sequence. For a given chain conformation, let $d_{i,i+k}$ denote the Euclidean distance between $C_\\alpha$ atoms at positions $i$ and $i+k$. The energy is\n$$\nE_\\mathrm{sec} = \\sum_{i=1}^{N-4} \\left( w_3 \\left(d_{i,i+3} - d_3^\\ast\\right)^2 + w_4 \\left(d_{i,i+4} - d_4^\\ast\\right)^2 \\right),\n$$\nwhere $d_3^\\ast$ and $d_4^\\ast$ are target distances (in Å), and $w_3$ and $w_4$ are positive weights (unitless).\n- The Monte Carlo acceptance uses the Metropolis criterion derived from the Boltzmann distribution. With the Boltzmann constant set to $k_\\mathrm{B} = 1$ in reduced units, the acceptance probability for a proposed change in energy $\\Delta E$ at temperature $T$ is\n$$\np_\\mathrm{acc} = \\min\\left(1, \\exp\\left(-\\frac{\\Delta E}{T}\\right)\\right),\n$$\nwith the special case that for $T = 0$ the rule reduces to deterministic acceptance of downhill moves $\\Delta E \\le 0$ and rejection otherwise.\n\nGeometry and algorithmic constraints:\n- Bond length between consecutive $C_\\alpha$ atoms is fixed at $b = 3.8$ Å.\n- Bond angle at each internal $C_\\alpha$ is fixed at $\\theta_0 = 1.57$ radians.\n- Initial dihedrals are uniform and set to $\\tau^\\mathrm{helix} = 1.00$ radians.\n- The concerted backbone move is a windowed rigid-body rotation defined as follows. Pick a contiguous window of indices $[s, t]$ with window size $w = t - s + 1$. Define the rotation axis as the line through the endpoints of the window, i.e., the axis passing through $C_\\alpha(s)$ and $C_\\alpha(t)$. Apply a rigid-body rotation by angle $\\Delta$ (in radians) to all $C_\\alpha$ atoms strictly inside the window, i.e., indices $s+1, s+2, \\dots, t-1$, about this axis. The endpoints $C_\\alpha(s)$ and $C_\\alpha(t)$ remain fixed. Because this is a rigid-body rotation, all intra-window distances and bond angles are preserved, and the boundary bond lengths to the window endpoints are preserved by construction.\n- Use a uniform proposal distribution for the rotation angle $\\Delta \\sim \\mathcal{U}(-\\Delta_\\max, \\Delta_\\max)$.\n- After a specified number of Monte Carlo steps, compute a helical order fraction $H$, defined as the fraction of indices $i \\in \\{1,2,\\dots,N-4\\}$ for which both $|d_{i,i+3} - d_3^\\ast| \\le \\delta_3$ and $|d_{i,i+4} - d_4^\\ast| \\le \\delta_4$ hold, where $\\delta_3$ and $\\delta_4$ are positive tolerances (in Å).\n\nAngle units and physical units:\n- All angles (bond angle $\\theta_0$, dihedral angles $\\tau_i$, and rotation angles $\\Delta$) must be treated in radians.\n- All distances must be in Ångstroms (Å).\n- Energies are in arbitrary reduced units, consistent with $k_\\mathrm{B} = 1$.\n\nProgram requirements:\n- Build initial $C_\\alpha$ coordinates from internal coordinates $b$, $\\theta_0$, and $\\tau^\\mathrm{helix}$ using a Z-matrix placement recursion in three-dimensional space.\n- Implement the windowed concerted rotation move as a rigid-body rotation around the axis defined by the window endpoints using the Rodrigues rotation formula.\n- Implement Metropolis Monte Carlo (MMC) with the specified acceptance rule to explore conformations by repeatedly proposing windowed rotations.\n- Compute the final helical fraction $H$ after the specified number of Monte Carlo steps.\n- Use the following fixed parameters for the energy function: $d_3^\\ast = 5.2$ Å, $d_4^\\ast = 6.0$ Å, $w_3 = 1.0$, $w_4 = 1.0$, $\\delta_3 = 0.6$ Å, and $\\delta_4 = 0.6$ Å.\n\nTest suite:\nImplement the program to run the following four test cases. Each test case specifies chain length $N$, number of Monte Carlo steps $M$, temperature $T$, maximum rotation magnitude $\\Delta_\\max$, window size $w$, and random seed $s$ for reproducibility.\n1. Case A (happy path): $N = 15$, $M = 2000$, $T = 0.35$, $\\Delta_\\max = 0.60$, $w = 6$, $s = 3$.\n2. Case B (high-angle high-temperature): $N = 15$, $M = 2000$, $T = 1.50$, $\\Delta_\\max = 2.50$, $w = 6$, $s = 3$.\n3. Case C (minimal window size): $N = 15$, $M = 2000$, $T = 0.35$, $\\Delta_\\max = 2.50$, $w = 3$, $s = 42$.\n4. Case D (zero moves boundary): $N = 15$, $M = 0$, $T = 0.35$, $\\Delta_\\max = 2.50$, $w = 6$, $s = 3$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the helical fractions for the four test cases as a comma-separated list enclosed in square brackets (e.g., $[h_A,h_B,h_C,h_D]$), where each $h_\\cdot$ is a decimal number. No other text must be printed.",
            "solution": "The problem requires the implementation of a Monte Carlo conformational search for a coarse-grained polypeptide chain. This task involves several distinct components: building the initial molecular geometry, defining and calculating a potential energy function, implementing a specific conformational move (a concerted rotation), running a Metropolis Monte Carlo simulation, and finally, analyzing the resulting conformation using a defined order parameter.\n\n### 1. Initial Conformation Generation using Z-Matrix\n\nThe initial three-dimensional coordinates of the $N$ alpha-carbon ($C_\\alpha$) atoms are constructed from a set of internal coordinates (bond lengths, bond angles, and dihedral angles) using a standard Z-matrix or \"Natural Extension of a Reference Frame\" (NERF) procedure. The problem specifies a fixed bond length $b = 3.8$ Å, a fixed bond angle $\\theta_0 = 1.57$ radians, and a uniform initial dihedral angle $\\tau^\\mathrm{helix} = 1.00$ radian.\n\nThe construction proceeds sequentially:\n1.  The first atom, $\\mathbf{r}_0$ (using 0-based indexing for an $N$-atom chain where indices run from $0$ to $N-1$), is placed at the origin:\n    $$ \\mathbf{r}_0 = [0, 0, 0] $$\n2.  The second atom, $\\mathbf{r}_1$, is placed along the x-axis at a distance $b$ from the first:\n    $$ \\mathbf{r}_1 = [b, 0, 0] $$\n3.  The third atom, $\\mathbf{r}_2$, is placed in the xy-plane, maintaining the bond length $b$ with $\\mathbf{r}_1$ and the bond angle $\\theta_0$ with the triplet $\\mathbf{r}_0-\\mathbf{r}_1-\\mathbf{r}_2$:\n    $$ \\mathbf{r}_2 = [b - b\\cos\\theta_0, b\\sin\\theta_0, 0] $$\n4.  For each subsequent atom $\\mathbf{r}_i$ (where $i \\ge 3$), its position is determined by its three predecessors ($\\mathbf{r}_{i-1}, \\mathbf{r}_{i-2}, \\mathbf{r}_{i-3}$) and the internal coordinates: the bond length $b$ to $\\mathbf{r}_{i-1}$, the bond angle $\\theta_0$ with respect to the vector $\\mathbf{r}_{i-2}-\\mathbf{r}_{i-1}$, and the dihedral angle $\\tau_{i-1} = \\tau^\\mathrm{helix}$ defined by the plane of atoms $(\\mathbf{r}_{i-3}, \\mathbf{r}_{i-2}, \\mathbf{r}_{i-1})$ and the plane of atoms $(\\mathbf{r}_{i-2}, \\mathbf{r}_{i-1}, \\mathbf{r}_i)$. A robust vector-based formula is used to place $\\mathbf{r}_i$:\n    Let $\\mathbf{a} = \\mathbf{r}_{i-1} - \\mathbf{r}_{i-2}$ and $\\mathbf{b} = \\mathbf{r}_{i-2} - \\mathbf{r}_{i-3}$. The normal to the plane defined by the first three atoms is $\\mathbf{n} = \\mathbf{a} \\times \\mathbf{b}$. A vector in that plane orthogonal to $\\mathbf{a}$ is $\\mathbf{p} = (\\mathbf{a} \\times \\mathbf{b}) \\times \\mathbf{a} = \\mathbf{n} \\times \\mathbf{a}$.\n    By normalizing these vectors, we can construct an orthonormal basis. The position of $\\mathbf{r}_i$ is then given by:\n    $$ \\mathbf{r}_i = \\mathbf{r}_{i-1} + b\\left(-\\cos\\theta_0 \\frac{\\mathbf{a}}{|\\mathbf{a}|} + \\sin\\theta_0 \\cos\\tau^\\mathrm{helix} \\frac{\\mathbf{p}}{|\\mathbf{p}|} + \\sin\\theta_0 \\sin\\tau^\\mathrm{helix} \\frac{\\mathbf{n}}{|\\mathbf{n}|} \\right) $$\n\n### 2. Secondary Structure Energy Function\n\nThe stability of the local secondary structure is quantified by the potential energy function $E_\\mathrm{sec}$. This function penalizes deviations of specific inter-atomic distances from their ideal alpha-helical values. The distances of interest are between atom $i$ and atoms $i+3$ and $i+4$. The function is:\n$$ E_\\mathrm{sec} = \\sum_{i=0}^{N-5} \\left( w_3 \\left(d_{i,i+3} - d_3^\\ast\\right)^2 + w_4 \\left(d_{i,i+4} - d_4^\\ast\\right)^2 \\right) $$\nHere, $d_{i, j} = \\|\\mathbf{r}_j - \\mathbf{r}_i\\|$ is the Euclidean distance between atoms $i$ and $j$. The parameters are provided: $w_3 = w_4 = 1.0$, $d_3^\\ast = 5.2$ Å, and $d_4^\\ast = 6.0$ Å. The summation is over 0-based indices from $0$ to $N-5$, which is equivalent to $1$ to $N-4$ in 1-based indexing.\n\n### 3. Concerted Backbone Rotation Move\n\nConformational changes are introduced by a concerted rotation move within a selected window of the polypeptide chain. This move is designed to preserve the fixed bond lengths and bond angles within the rotated segment.\nThe procedure for a single move is as follows:\n1.  A contiguous window of atoms of size $w$ is chosen. A random starting index $s$ is selected uniformly from the range $\\{0, 1, \\dots, N-w\\}$, defining the window of indices $[s, s+w-1]$.\n2.  The axis of rotation, $\\mathbf{k}$, is defined as the unit vector along the line connecting the window's endpoints, $\\mathbf{r}_s$ and $\\mathbf{r}_{s+w-1}$:\n    $$ \\mathbf{k} = \\frac{\\mathbf{r}_{s+w-1} - \\mathbf{r}_s}{\\|\\mathbf{r}_{s+w-1} - \\mathbf{r}_s\\|} $$\n3.  A random rotation angle $\\Delta$ is drawn from a uniform distribution $\\mathcal{U}(-\\Delta_\\max, \\Delta_\\max)$.\n4.  All atoms strictly within the window, i.e., at indices $j \\in \\{s+1, \\dots, s+w-2\\}$, are rotated rigidly around this axis. The rotation is performed using Rodrigues' rotation formula. For each point $\\mathbf{p}_j$ to be rotated, we first define its position relative to a point on the axis, e.g., $\\mathbf{v} = \\mathbf{p}_j - \\mathbf{r}_s$. The rotated vector $\\mathbf{v}'$ is:\n    $$ \\mathbf{v}' = \\mathbf{v}\\cos\\Delta + (\\mathbf{k} \\times \\mathbf{v})\\sin\\Delta + \\mathbf{k}(\\mathbf{k} \\cdot \\mathbf{v})(1-\\cos\\Delta) $$\n    The new position of the atom is then $\\mathbf{p}_j' = \\mathbf{r}_s + \\mathbf{v}'$.\n\n### 4. Metropolis Monte Carlo Simulation\n\nThe simulation explores the conformational space by iteratively proposing moves and accepting or rejecting them based on the Metropolis criterion, which ensures that the system samples conformations according to the Boltzmann distribution.\nThe simulation proceeds for $M$ steps:\n1.  Start with the initial conformation $\\mathbf{X}_0$ and its energy $E_0 = E_\\mathrm{sec}(\\mathbf{X}_0)$.\n2.  For step $k = 1, \\dots, M$:\n    a. Propose a new conformation $\\mathbf{X}_\\text{new}$ by applying one concerted rotation move to the current conformation $\\mathbf{X}_\\text{current}$.\n    b. Calculate the energy of the new conformation, $E_\\text{new} = E_\\mathrm{sec}(\\mathbf{X}_\\text{new})$.\n    c. The change in energy is $\\Delta E = E_\\text{new} - E_\\text{current}$.\n    d. The move is accepted with probability $p_\\mathrm{acc} = \\min\\left(1, \\exp\\left(-\\frac{\\Delta E}{T}\\right)\\right)$, where $T$ is the temperature and the Boltzmann constant $k_\\mathrm{B}$ is set to $1$. To implement this, a uniform random number $u \\in [0, 1)$ is generated. If $u  p_\\mathrm{acc}$, the new conformation is accepted ($\\mathbf{X}_\\text{current} \\leftarrow \\mathbf{X}_\\text{new}$, $E_\\text{current} \\leftarrow E_\\text{new}$). Otherwise, the move is rejected, and the conformation remains unchanged for the next step.\n\nReproducibility for each test case is ensured by seeding the pseudo-random number generator with the specified seed $s$. This controls the sequence of window selections and rotation angles.\n\n### 5. Helical Order Fraction\n\nAfter completing $M$ Monte Carlo steps, the final conformation is analyzed to quantify its helical character. The helical order fraction, $H$, is the fraction of segments that satisfy a geometric criterion for an alpha-helix. An index $i$ (from $0$ to $N-5$) is considered \"helical\" if the distances $d_{i,i+3}$ and $d_{i,i+4}$ are close to their ideal values:\n$$ |d_{i,i+3} - d_3^\\ast| \\le \\delta_3 \\quad \\text{and} \\quad |d_{i,i+4} - d_4^\\ast| \\le \\delta_4 $$\nThe tolerances are given as $\\delta_3 = \\delta_4 = 0.6$ Å.\nThe total fraction is calculated as:\n$$ H = \\frac{\\text{Number of helical indices}}{\\text{Total number of possible indices}} = \\frac{1}{N-4} \\sum_{i=0}^{N-5} \\mathbb{I}(\\text{condition for } i \\text{ is met}) $$\nwhere $\\mathbb{I}(\\cdot)$ is the indicator function. The test case with $M=0$ steps effectively calculates $H$ for the initial, ideal helical conformation.",
            "answer": "```python\nimport numpy as np\n\ndef build_initial_coords(N, b, theta_0, tau_helix):\n    \"\"\"\n    Builds the initial C_alpha coordinates from a Z-matrix specification.\n    Indices are 0-based.\n    \"\"\"\n    coords = np.zeros((N, 3))\n    \n    if N  0:\n        coords[0] = np.array([0.0, 0.0, 0.0])\n    if N  1:\n        coords[1] = np.array([b, 0.0, 0.0])\n    if N  2:\n        # Place atom 2 (0-indexed) based on atoms 1 and 0.\n        # Bond angle at atom 1 (index 1) is theta_0 between vector 1-0 and 1-2.\n        # Vector 1-0 is [-b, 0, 0]. Vector 1-2 should have length b.\n        # v_1_0 dot v_1_2 = |v_1_0| |v_1_2| cos(theta_0)\n        # Place in xy-plane:\n        x2 = b - b * np.cos(theta_0)\n        y2 = b * np.sin(theta_0)\n        coords[2] = np.array([x2, y2, 0.0])\n\n    if N  3:\n        for i in range(3, N):\n            r_im1, r_im2, r_im3 = coords[i-1], coords[i-2], coords[i-3]\n            \n            a_vec = r_im1 - r_im2\n            b_vec = r_im2 - r_im3\n\n            # Check for collinearity\n            a_norm = np.linalg.norm(a_vec)\n            if a_norm  1e-9: continue\n            \n            a_hat = a_vec / a_norm\n            \n            n_vec = np.cross(a_vec, b_vec)\n            n_norm = np.linalg.norm(n_vec)\n            \n            if n_norm  1e-9: # Handle case when a, b are collinear\n                # Create arbitrary normal\n                dummy = np.array([0.0,0.0,1.0]) if np.abs(a_hat[2])  0.9 else np.array([1.0,0.0,0.0])\n                n_vec = np.cross(a_hat, dummy)\n                n_norm = np.linalg.norm(n_vec)\n\n            n_hat = n_vec / n_norm\n            \n            p_vec = np.cross(n_hat, a_hat)\n            \n            # Using the formula derived from vector geometry\n            # r_i = r_{i-1} + b * ( -cos(theta_0)*a_hat + sin(theta_0)*cos(tau)*p_hat + sin(theta_0)*sin(tau)*n_hat)\n            # p_hat is already normalized as it's cross product of two unit vectors\n            \n            disp = -np.cos(theta_0) * a_hat + \\\n                    np.sin(theta_0) * np.cos(tau_helix) * p_vec + \\\n                    np.sin(theta_0) * np.sin(tau_helix) * n_hat\n            coords[i] = r_im1 + b * disp\n            \n    return coords\n\ndef calculate_energy(coords, d3_star, d4_star, w3, w4):\n    \"\"\"Calculates the secondary structure energy E_sec.\"\"\"\n    N = len(coords)\n    energy = 0.0\n    if N  5:\n        return 0.0\n        \n    for i in range(N - 4):\n        d_i_i3 = np.linalg.norm(coords[i+3] - coords[i])\n        d_i_i4 = np.linalg.norm(coords[i+4] - coords[i])\n        energy += w3 * (d_i_i3 - d3_star)**2 + w4 * (d_i_i4 - d4_star)**2\n    return energy\n\ndef apply_concerted_rotation(coords, s, t, delta):\n    \"\"\"Applies a concerted rotation to a window of the chain.\"\"\"\n    new_coords = np.copy(coords)\n    \n    r_s = coords[s]\n    r_t = coords[t]\n    \n    axis_vec = r_t - r_s\n    axis_norm = np.linalg.norm(axis_vec)\n    if axis_norm  1e-9:\n        return new_coords # No rotation if endpoints are coincident\n    \n    k = axis_vec / axis_norm\n    \n    cos_d = np.cos(delta)\n    sin_d = np.sin(delta)\n    \n    # Rodrigues' rotation formula\n    for j in range(s + 1, t):\n        p_j = coords[j]\n        v = p_j - r_s\n        \n        v_rot = v * cos_d + np.cross(k, v) * sin_d + k * np.dot(k, v) * (1 - cos_d)\n        \n        new_coords[j] = r_s + v_rot\n        \n    return new_coords\n\ndef calculate_helical_fraction(coords, d3_star, d4_star, delta3, delta4):\n    \"\"\"Calculates the final helical order fraction H.\"\"\"\n    N = len(coords)\n    if N  5:\n        return 0.0\n    \n    helical_count = 0\n    num_segments = N - 4\n    for i in range(num_segments):\n        d_i_i3 = np.linalg.norm(coords[i+3] - coords[i])\n        d_i_i4 = np.linalg.norm(coords[i+4] - coords[i])\n        \n        if abs(d_i_i3 - d3_star) = delta3 and abs(d_i_i4 - d4_star) = delta4:\n            helical_count += 1\n            \n    return helical_count / num_segments\n\ndef run_simulation(N, M, T, delta_max, w, seed):\n    \"\"\"Runs a full Monte Carlo simulation for one test case.\"\"\"\n    np.random.seed(seed)\n    \n    # Fixed parameters\n    b = 3.8\n    theta_0 = 1.57\n    tau_helix = 1.00\n    d3_star, d4_star = 5.2, 6.0\n    w3, w4 = 1.0, 1.0\n    delta3, delta4 = 0.6, 0.6\n    \n    # 1. Initial conformation\n    current_coords = build_initial_coords(N, b, theta_0, tau_helix)\n    \n    # Handle M=0 case\n    if M == 0:\n        return calculate_helical_fraction(current_coords, d3_star, d4_star, delta3, delta4)\n\n    # 2. Initial energy\n    current_energy = calculate_energy(current_coords, d3_star, d4_star, w3, w4)\n\n    # 3. MC loop\n    for _ in range(M):\n        # Propose a move\n        s = np.random.randint(0, N - w + 1)\n        t = s + w - 1\n        delta = np.random.uniform(-delta_max, delta_max)\n        \n        new_coords = apply_concerted_rotation(current_coords, s, t, delta)\n        new_energy = calculate_energy(new_coords, d3_star, d4_star, w3, w4)\n        \n        # Metropolis criterion\n        delta_E = new_energy - current_energy\n        if delta_E = 0:\n            current_coords = new_coords\n            current_energy = new_energy\n        else:\n            if T  0:\n                prob_acc = np.exp(-delta_E / T)\n                if np.random.rand()  prob_acc:\n                    current_coords = new_coords\n                    current_energy = new_energy\n\n    # 4. Final analysis\n    final_h_fraction = calculate_helical_fraction(current_coords, d3_star, d4_star, delta3, delta4)\n    return final_h_fraction\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and format the output.\n    \"\"\"\n    test_cases = [\n        # (N, M, T, delta_max, w, seed)\n        (15, 2000, 0.35, 0.60, 6, 3),   # Case A\n        (15, 2000, 1.50, 2.50, 6, 3),   # Case B\n        (15, 2000, 0.35, 2.50, 3, 42),  # Case C\n        (15, 0, 0.35, 2.50, 6, 3),      # Case D\n    ]\n\n    results = []\n    for case in test_cases:\n        N, M, T, delta_max, w, seed = case\n        result = run_simulation(N, M, T, delta_max, w, seed)\n        results.append(result)\n\n    # Format output to match problem specification\n    print(f\"[{','.join(f'{r:.8f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}