## 引言
在分子科学领域，尤其是药物发现和[材料设计](@entry_id:160450)中，如何根据化学结构理性地预测并优化分子的功能是一个核心挑战。[定量构效关系](@entry_id:1130377)（Quantitative Structure-Activity Relationships, QSAR）作为一种强大的计算方法，通过建立结构与活性之间的数学桥梁，为这一挑战提供了数据驱动的解决方案。它旨在回答一个根本性问题：我们能否仅从分子的二维或三维结构出发，就预测其生物活性、理化性质或毒性，从而指导我们更高效地设计新分子？

本文将系统地引导读者深入QSAR的世界。在“原理与机制”一章中，我们将奠定理论基础，探讨如何将抽象的分子结构转化为数字化的描述符，如何量化生物活性，以及如何构建和严格验证一个可靠的预测模型。接着，在“应用与交叉学科联系”一章中，我们将展示QSAR在药物发现（从靶点亲和力到ADMET性质预测）、[环境科学](@entry_id:187998)和材料科学等领域的广泛实际应用，彰显其跨学科的价值。最后，“动手实践”部分将提供具体的计算练习，帮助读者将理论知识转化为实践技能。

## 原理与机制

[定量构效关系](@entry_id:1130377)（Quantitative Structure-Activity Relationships, QSAR）的研究建立在一个核心假设之上：分子的生物活性或理化性质由其化学结构决定。因此，通过对[分子结构](@entry_id:140109)进行数学化描述，并运用统计学方法，我们可以构建一个模型来预测甚至解释分子的活性。本章将深入探讨支持[QSAR建模](@entry_id:924561)的基本原理与核心机制，从其基本定义、统计学基础，到分子结构的描述、生物活性的量化，再到模型的构建与严格验证。

### QSAR的基本定义与统计学框架

从根本上说，QSAR旨在建立一个从[分子结构](@entry_id:140109)到生物活性的映射函数。理解QSAR的第一步是将其与一个密切相关的概念——定量[构性关系](@entry_id:195492)（Quantitative Structure-Property Relationship, QSPR）——区分开来。这两者的核心区别在于它们所预测的因变量（$Y$）的性质。

在**QSAR**中，因变量$Y$是衡量分子与生物系统相互作用的**生物活性**。这包括在特定生物测定中测得的各种终点，例如，衡量[酶抑制](@entry_id:136530)能力的半数抑制浓度（$IC_{50}$）或其对数形式$pIC_{50}$，衡量与[受体结合亲和力](@entry_id:907507)的解离常数（$K_i$）或其对数形式$pK_i$，以及细胞水平上的生长抑制率等。这些活性值本质上是复杂生物过程的结果，其解释需要考虑生物系统的具体环境。

相比之下，在**QSPR**中，因变量$Y$是分子在特定物理条件下固有的**理化性质**。这些性质包括水溶性（$\log S$）、油水分配系数（$\log P$）、[沸点](@entry_id:139893)、或在标准体外模型（如Caco-2细胞模型）中测得的表观[渗透系数](@entry_id:152559)（$P_{\mathrm{app}}$）。虽然$P_{\mathrm{app}}$的测量涉及生物系统，但它通常被视为一种与转运相关的理化性质。

无论是在QSAR还是QSPR中，自变量（$X$）都是从分子结构中计算得出的**[分子描述符](@entry_id:164109)**。这些描述符必须在观测到任何终点$Y$之前从化学结构中计算得出，以避免信息泄露。描述符的选择范围极广，并无特定规则限制某一类描述符专用于QSAR或QSPR。从机理层面看，[QSAR模型](@entry_id:1130354)是对结构-生物反应映射的关联性总结，其表观机理可能受系统层面因素（如细胞通透性、[代谢稳定性](@entry_id:907463)）的干扰，因此任何因果解释都需要正交实验证据的支持。而QSPR模型通常可以用物理化学原理（如[溶剂化热力学](@entry_id:155501)、相平衡）来合理解释，但其本质仍然是关联性的 。

在统计学上，[QSAR建模](@entry_id:924561)过程可以被形式化为一个标准的[监督学习](@entry_id:161081)问题。我们假设存在一个未知的函数$f$，它将[分子描述符](@entry_id:164109)向量$X$映射到生物活性$Y$，但我们的观测值会受到实验噪声和模型失配的影响。因此，观测到的活性$Y_i$与描述符$X_i$之间的关系可以表示为：

$Y_i = f^{\star}(X_i) + \varepsilon_i$

在这里，$f^{\star}(X_i) = \mathbb{E}[Y \mid X=X_i]$ 是给定描述符$X_i$时期望的真实活性，而$\varepsilon_i$是一个[随机误差](@entry_id:144890)项，通常假设其[条件期望](@entry_id:159140)为零（$\mathbb{E}[\varepsilon_i \mid X_i] = 0$）且方差有限。我们的目标是通过一个有限的训练数据集$\{(X_i, Y_i)\}_{i=1}^n$来学习一个函数$f$，使其能够很好地逼近$f^{\star}$。

为了确保我们构建的模型具有有效的推断能力——即能够对来自同一来源的新分子进行准确预测并提供校准过的[不确定性估计](@entry_id:191096)——必须依赖于一些基本的统计学假设 。其中最核心的两个是：

1.  **[独立同分布](@entry_id:169067)（i.i.d.）假设**：我们假定[训练集](@entry_id:636396)中的每一个数据点$(X_i, Y_i)$都是从一个固定的[联合概率分布](@entry_id:171550)$\mathbb{P}_{X,Y}$中独立抽取的。这个假设是使用[经验风险](@entry_id:633993)（在训练集上的误差）来近似[期望风险](@entry_id:634700)（在整个数据分布上的期望误差）的理论基础。

2.  **[平稳性](@entry_id:143776)（Stationarity）假设**：我们假定产生数据的[联合分布](@entry_id:263960)$\mathbb{P}_{X,Y}$在训练和部署阶段保持不变。这意味着我们未来要预测的新分子与用于训练模型的分子遵循相同的分布。如果这个假设不成立（即发生了[分布漂移](@entry_id:191402)），那么在训练集上表现良好的模型在实际应用中可能会失效。

这些假设构成了[QSAR模型](@entry_id:1130354)泛化能力的理论基石，任何对模型预测能力的评估都应在这一框架下进行。

### 结构（Structure）的量化：[分子描述符](@entry_id:164109)

QSAR的核心在于“S”——结构。为了建立数学模型，必须将分子的化学结构转化为一组数值，即**[分子描述符](@entry_id:164109)**（$X$）。这些描述符是连接分子拓扑、几何或电子属性与生物活性的桥梁。根据其编码的信息，描述符可以分为几个主要类别 。

*   **宪法描述符（Constitutional Descriptors）**：这类描述符只与分子的化学组成有关，例如分子量、[原子数](@entry_id:746561)、[化学键](@entry_id:145092)数、[环数](@entry_id:267135)等。它们从[分子式](@entry_id:136926)或分子连接图（一个由原子为顶点、[化学键](@entry_id:145092)为边的图$G$）中派生，完全不依赖于分子的三维坐标。因此，它们在[旋转和平移](@entry_id:175994)下保持不变，但无法区分[立体异构体](@entry_id:139490)。

*   **拓扑描述符（Topological Descriptors）**：这类描述符基于分子连接图$G$的图论性质。它们量化了分子的拓扑特征，如大小、分支度、环状性等，例如Wiener指数（所有原子对之间[最短路径](@entry_id:157568)的总和）。与宪法描述符一样，它们也独立于三维坐标，因此在旋转、平移以及不改变[化学键](@entry_id:145092)连接的构象变化下保持不变。

*   **几何描述符（Geometric Descriptors）**：这类描述符依赖于分子的三维原子坐标$\{\mathbf{r}_i\}$。它们描述分子的三维尺寸和形状，例如分子体积、表面积、[回转半径](@entry_id:154974)等。如果这些描述符被定义为内部坐标（如原子间距离$d_{ij}$）的标量函数，那么它们在全局[旋转和平移](@entry_id:175994)下是不变的，但对[分子构象](@entry_id:163456)敏感。

*   **电子描述符（Electronic Descriptors）**：这类描述符源于分子的[电子结构](@entry_id:145158)，通常通过量子[化学计算](@entry_id:155220)得到，例如原子局部电荷$q_i$、偶极矩$\boldsymbol{\mu}$、最高占据分子轨道（HOMO）和最低未占据分子轨道（LUMO）的能量等。标量电子描述符（如[HOMO-LUMO能隙](@entry_id:139325)）在[旋转和平移](@entry_id:175994)下是不变的，而矢量描述符（如偶极矩$\boldsymbol{\mu}$）会随坐标系旋转而旋转。

*   **理化性质描述符（Physicochemical Descriptors）**：这类描述符通常是实验测得的或根据经验模型计算出的宏观性质，如油水[分配系数](@entry_id:177413)$\log P$、酸度系数$pK_a$等。作为分子的[内禀性质](@entry_id:273674)，它们是标量，不依赖于坐标系的选择。

在现代QSAR中，一类特别强大且广泛应用的描述符是**[分子指纹](@entry_id:1128105)（Molecular Fingerprints）**。其中，**扩展连接性指纹（Extended-Connectivity Fingerprints, ECFP）**是一种典型的**圆形指纹**。ECFP通过迭代地聚合每个原子周围的局部化学环境信息来生成描述符 。其生成过程如下：

1.  **初始化**：为每个原子分配一个初始整数标识符。这个标识符是通过哈希（hashing）一组**原子不变量**（如元素类型、[形式电荷](@entry_id:140002)、杂化状态、是否在环内等）得到的。
2.  **迭代更新**：在每一次迭代中，通过聚合一个原子及其邻近原子的前一轮标识符，来为该原子生成一个新的标识符。
3.  **特征生成**：迭代$r$次后，每个原子在每一轮生成的所有唯一标识符都被视为一个局部子结构特征。参数$r$被称为**半径**，它控制了所捕获子结构的大小。半径为$r$的ECFP可以捕获直径最大为$2r$的子结构。
4.  **折叠**：将所有生成的子结构标识符哈希到一个固定长度的向量中（例如，长度为$1024$或$2048$）。

最终得到的指纹向量可以是**二元向量**（记录每个子结构是否存在，即$0$或$1$）或**计数向量**（记录每个子结构出现的次数）。半径$r$和初始原子不变量的选择共同决定了指纹所能捕获的结构信息的范围和粒度，从而直接影响最终[QSAR模型](@entry_id:1130354)的性能。

### 活性（Activity）的量化：[对数标度](@entry_id:268353)与自由能

QSAR中的“A”——活性——的量化同样至关重要。生物活性数据，尤其是来自高通量筛选的效价数据（如$IC_{50}$），通常呈现出一些对统计建模不友好的特性。因此，在建模前对活性数据进行适当的变换是必要的。

在[酶抑制](@entry_id:136530)或[受体结合](@entry_id:190271)研究中，我们通常得到半数抑制浓度（$IC_{50}$）或解离常数（$K_i$）。这两个值虽然都反映了分子的效价，但$IC_{50}$是一个依赖于实验条件的参数，而$K_i$是一个更接近分子内禀亲和力的[热力学](@entry_id:172368)常数。它们之间的关系可以通过**Cheng-Prusoff方程**来描述 。例如，对于一个可逆的竞争性[酶抑制剂](@entry_id:185970)，其关系为：

$IC_{50} = K_i \left(1 + \frac{[S]}{K_m}\right)$

其中$[S]$是[底物浓度](@entry_id:143093)，$K_m$是[米氏常数](@entry_id:265734)。对于竞争性放射性[配体结合](@entry_id:147077)实验，其关系为：

$K_i = \frac{IC_{50}}{1 + \frac{[L]}{K_d}}$

其中$[L]$是放射性配体浓度，$K_d$是放射性配体的解离常数。这些关系表明，直接使用不同实验条件下测得的$IC_{50}$值进行建模可能会引入系统偏差。理想情况下，应先将$IC_{50}$转换为$K_i$。

更重要的是，效价数据（如$IC_{50}$和$K_i$）通常跨越数个数量级，其测量误差往往是乘性的，导致数据分布呈对数正态分布（log-normal distribution），即数据高度右偏且方差随均值增大而增大（[异方差性](@entry_id:895761)）。为了解决这些统计问题，我们通常对活性数据进行[对数变换](@entry_id:267035)，例如定义$pIC_{50} = -\log_{10}(IC_{50})$。

这种对数变换至少有两个关键的理论依据 ：

1.  **统计学理由**：对数变换可以将乘性误差转化为加性误差，从而**稳定方差**并使数据分布更接近对称的正态分布。例如，如果测量的$IC_{50}$值$Y$可以模型化为$Y = \mu \cdot \varepsilon$（其中$\mu$是[真值](@entry_id:636547)，$\varepsilon$是[乘性](@entry_id:187940)误差），那么$\log(Y) = \log(\mu) + \log(\varepsilon)$。如果$\log(\varepsilon)$的方差是恒定的，那么$\log(Y)$的方差也将是恒定的，从而满足了许多线性回归模型的基本假设。

2.  **物理化学理由**：分子的[结合亲和力](@entry_id:261722)本质上是一个[热力学过程](@entry_id:141636)，其强度由[吉布斯自由能变](@entry_id:138324)（$\Delta G_{\text{bind}}$）决定。$\Delta G_{\text{bind}}$与[解离常数](@entry_id:265737)$K_d$（或近似的$K_i$）之间的关系为：

    $\Delta G_{\text{bind}} = RT \ln K_d = 2.303 RT \log_{10} K_d$

    由于$pK_d = -\log_{10} K_d$，我们得到$\Delta G_{\text{bind}} \propto -pK_d$。这意味着，对数尺度的活性（如$pK_d$或$pIC_{50}$）与[结合自由能](@entry_id:166006)成正比。这个正比关系是**[线性自由能关系](@entry_id:1127280)（Linear Free-Energy Relationships, LFERs）**的基础，它假设[分子结构](@entry_id:140109)的微小改变（如引入一个[取代基](@entry_id:183115)）对总[结合自由能](@entry_id:166006)的贡献是加和的。因此，在对数活性尺度上构建线性模型具有坚实的物理化学基础。

### 连接结构与活性：Hansch分析与[分子识别](@entry_id:151970)原理

建立了结构和活性的量化表示后，下一步就是构建连接它们的数学模型。经典的**Hansch分析**为我们提供了一个完美的范例，它将[分子识别](@entry_id:151970)的物理化学原理与线性模型相结合 。

Hansch模型基于[线性自由能关系](@entry_id:1127280)的假设，将分子活性的对数（通常表示为$\log(1/C)$，其中$C$是产生某一固定效应所需的浓度）分解为几个可加和的物理化学贡献，主要包括疏水性、[电子效应](@entry_id:150858)和立体效应。其经典形式为：

$\log(1/C) = a\pi + b\pi^2 + c\sigma + dE_s + e$

其中：
*   $\pi$是[取代基](@entry_id:183115)的**疏水常数**，衡量[取代基](@entry_id:183115)对分子整体[疏水性](@entry_id:185618)的贡献。
*   $\sigma$是Hammett**电子常数**，衡量[取代基](@entry_id:183115)的给电子或吸电子能力。
*   $E_s$是Taft**立体常数**，衡量[取代基](@entry_id:183115)的体积大小。
*   $a, b, c, d, e$是待回归拟合的系数。

这个方程的每一项都有其[物理化学](@entry_id:145220)意义。$a\pi$项代表[疏水相互作用](@entry_id:167884)对结合的有利贡献（通常$a > 0$）。$c\sigma$和$dE_s$项分别代表电子和立体效应对结合的贡献。

特别值得注意的是模型中包含的$\pi^2$项。这一项的引入反映了一个重要的生物学现实：分子的疏水性并非越高越好。虽然适度的疏水性有利于分子从水相转移到疏水性的蛋白结合口袋中（这是结合的驱动力之一），但过高的[疏水性](@entry_id:185618)会导致分子在水相中的溶解度过低，或被非特异性地吸附在[脂质膜](@entry_id:194007)上，从而无法有效到达靶点。因此，生物活性与疏水性之间存在一个**最佳值**。Hansch模型通过一个负的二次项（即$b  0$）来描述这种**抛物线关系**。在自由[能层](@entry_id:160747)面，这意味着总过程的自由能包含一个与$\pi$成正比的有利项（结合过程）和一个与$\pi^2$成正比的不利项（转运/[溶解度](@entry_id:147610)惩罚）。

Hansch分析的原理可以推广到更广泛的[QSAR建模](@entry_id:924561)中。其核心思想是，选择的描述符应作为[分子识别](@entry_id:151970)过程中关键[物理化学](@entry_id:145220)相互作用的**代理（proxy）** 。例如：
*   **[疏水相互作用](@entry_id:167884)**：由$\log P$描述。如果结合口袋是[疏水性](@entry_id:185618)的，我们预期$\log P$的系数为正（在预测$pIC_{50}$时）或负（在预测$\ln K_i$时），因为更高的[疏水性](@entry_id:185618)有利于结合。
*   **静电相互作用**：由原子局部电荷$q$描述。如果结合口袋中有一个带正电的氨基酸残基，而配体通过一个带负电的基团与之作用，那么该基团负电荷的绝对值$|q|$越大，结合越强。
*   **去[溶剂化效应](@entry_id:202902)**：由拓扑[极性表面](@entry_id:753555)积（T[PSA](@entry_id:912720)）描述。将一个[极性分子](@entry_id:144673)从水中转移到非极性结合口袋需要克服其与水分子之间的有利相互作用，这会产生能量惩罚。因此，T[PSA](@entry_id:912720)越大，结合通常越不利。
*   **立体匹配**：由分子体积$V$描述。结合口袋通常有特定的大小和形状。一个理想的配体应该恰好填充这个口袋以最大化有利的范德华接触。体积过小或过大都会导致亲和力下降。这种关系通常是[非线性](@entry_id:637147)的，可以用一个以最佳体积$V_{\text{cav}}$为中心的惩罚项，如$(V - V_{\text{cav}})^2$，来建模。

通过分析一个假想的靶点和一组配体数据，我们可以验证这些原理。例如，在****中，数据显示亲和力在配体体积$V=360 \ \text{Å}^3$时达到最高，与口袋体积$V_{\text{cav}}$相符，而在体积更小或更大时亲和力均下降，这有力地支持了使用二次惩罚项来描述立体效应。同样，数据也证实了$\log P$和局部电荷$|q|$对亲和力的正向贡献，以及T[PSA](@entry_id:912720)的负向贡献，这与基于靶点性质的化学直觉完全一致。

### 模型的构建与验证：确保预测的可靠性

构建一个在数学上成立的[QSAR模型](@entry_id:1130354)相对容易，但要确保其具有真实的预测能力则要困难得多。在描述符维度$d$远大于样本量$n$（即$d \gg n$问题）的现代QSAR研究中，**[过拟合](@entry_id:139093)（overfitting）**是一个普遍且严峻的挑战。

过拟合指的是模型过度学习了训练数据中的噪声和随机波动，而不是潜在的真实[构效关系](@entry_id:178339)。这样的模型在[训练集](@entry_id:636396)上会表现出极低的误差（高$R^2$），但在预测新分子时表现极差。在高维[线性模型](@entry_id:178302)中，[过拟合](@entry_id:139093)的数学根源在于[设计矩阵](@entry_id:165826)$\mathbf{X}$的列之间存在[共线性](@entry_id:270224)，导致矩阵$\mathbf{X}^{\top}\mathbf{X}$变得奇异或病态（ill-conditioned），其逆矩阵的元素值会非常大。这使得模型系数的方差急剧膨胀，对训练数据的微小扰动极为敏感 。

为了应对[过拟合](@entry_id:139093)，研究者采用了多种策略来降低模型方差，其中最主要的是**正则化（regularization）**和**[特征选择](@entry_id:177971)（feature selection）**。[正则化方法](@entry_id:150559)，如[岭回归](@entry_id:140984)（Ridge Regression, $\ell_2$正则化）和LASSO（$\ell_1$正则化），通过在损失函数中加入对模型系数大小的惩罚项，来约束模型的复杂度。[特征选择](@entry_id:177971)则直接减少描述符的数量，从而降低模型的[有效维度](@entry_id:146824)。

然而，无论采用何种建模策略，**严格的[外部验证](@entry_id:925044)**都是评估[QSAR模型](@entry_id:1130354)预测能力的唯一标准。

#### [内部验证与外部验证](@entry_id:913457)

一个常见的误区是使用**复[相关系数](@entry_id:147037)（$R^2$）**来衡量模型的性能。$R^2$是在整个训练集上拟合和评估得到的，它衡量的是模型对训练数据的“拟合优度”，而非“预测能力”。一个[过拟合](@entry_id:139093)的模型可以轻易达到很高的$R^2$值。

一个更可靠的性能指标是**[交叉验证](@entry_id:164650)（cross-validation）**。在交叉验证中，数据集被分成多个子集，模型在部分数据上训练，然后在剩余的“留出”数据上进行测试。这个过程重复进行，直到每个数据点都被用作[测试集](@entry_id:637546)一次。**[留一法交叉验证](@entry_id:637718)（Leave-One-Out Cross-Validation, [LOOCV](@entry_id:637718)）**是其一个极端形式，每次只留出一个样本进行测试。基于交叉验证的预测误差，我们可以计算一个更稳健的性能指标——**交叉验证[决定系数](@entry_id:900023)（$Q^2$）** 。

$Q^2$的定义与$R^2$类似，但它用[交叉验证](@entry_id:164650)得到的**预测[误差[平方](@entry_id:149299)和](@entry_id:161049)（PRESS）**代替了拟合[误差平方和](@entry_id:149299)（RSS）：

$Q^2 = 1 - \frac{\text{PRESS}}{\text{TSS}} = 1 - \frac{\sum_{i=1}^{n}(y_i - \hat{y}_{-i})^2}{\sum_{i=1}^{n}(y_i - \bar{y})^2}$

其中，$\hat{y}_{-i}$是在不包含样本$i$的训练集上训练的模型对样本$i$的预测值，TSS是总[平方和](@entry_id:161049)。由于$\hat{y}_{-i}$对于模型来说是“外部”预测，因此$Q^2$能更真实地反映模型的泛化能力。一个高$R^2$而低$Q^2$的模型几乎可以肯定是[过拟合](@entry_id:139093)的。

#### [随机性检验](@entry_id:137894)：Y-随机化

即使一个模型具有良好的$Q^2$值，也可能存在一个更微妙的问题：这个良好的性能是否仅仅是由于偶然的机遇？特别是在$d \gg n$的情况下，即使活性数据与描述符之间完全没有真实关系，也可能通过机会关联找到一个看似不错的模型。

为了排除这种可能性，**Y-[随机化](@entry_id:198186)（Y-randomization）**或称**[置换检验](@entry_id:175392)（permutation test）**是一种至关重要的验证手段 。其基本思想是检验在“无[构效关系](@entry_id:178339)”这一**[零假设](@entry_id:265441)（$H_0$）**下，我们观察到的模型性能（如$Q^2$）是否是一个极端事件。

该过程如下：
1.  保持描述符矩阵$X$不变，将活性向量$y$的顺序随机打乱，得到一个置换后的活性向量$y^{\pi}$。这个操作破坏了任何真实的[构效关系](@entry_id:178339)。
2.  使用与原始模型完全相同的流程（包括[特征选择](@entry_id:177971)、[交叉验证](@entry_id:164650)和[超参数调优](@entry_id:143653)）在$(X, y^{\pi})$上重新建立一个[QSAR模型](@entry_id:1130354)，并计算其$Q^2_{\pi}$。
3.  重复这个过程$B$次（例如，$B=1000$），得到一个由随机模型性能组成的[零分布](@entry_id:195412)$\{Q^2_{\pi_b}\}_{b=1}^B$。
4.  计算我们原始模型的$Q^2$值在这个[零分布](@entry_id:195412)中有多么极端。经验$p$-值可以计算为 $p = (m+1)/(B+1)$，其中$m$是随机模型的$Q^2_{\pi_b}$值大于或等于我们原始模型$Q^2$的次数。

一个很小的$p$-值（例如，$p  0.05$）表明，我们观察到的模型性能在[零假设](@entry_id:265441)下是极不可能发生的，因此我们有理由相信模型所捕获的是一个真实的、非偶然的[构效关系](@entry_id:178339)。

#### [适用域](@entry_id:172549)（Applicability Domain）

最后，必须认识到，任何[QSAR模型](@entry_id:1130354)都只在其被训练的数据所覆盖的[化学空间](@entry_id:1122354)内可靠。将模型应用于与[训练集](@entry_id:636396)分子差异很大的新分子，属于**外推（extrapolation）**，其预测结果是不可信的。定义和评估模型的**[适用域](@entry_id:172549)（Applicability Domain, AD）**是确保模型可靠应用的关键。

一个常用的定义AD的方法是基于**[杠杆值](@entry_id:172567)（leverage）** 。在[线性回归](@entry_id:142318)中，预测值$\hat{y}$可以通过一个称为“[帽子矩阵](@entry_id:174084)”$H$的[投影矩阵](@entry_id:154479)作用于观测值$y$得到：$\hat{y} = H y$，其中$H = X(X^{\top}X)^{-1}X^{\top}$。[帽子矩阵](@entry_id:174084)的对角[线元](@entry_id:196833)素$h_{ii}$即为样本$i$的[杠杆值](@entry_id:172567)。

[杠杆值](@entry_id:172567)$h_{ii}$衡量了样本$i$的描述符向量$x_i$在描述符空间中的“离群”程度。它只依赖于$X$矩阵，而与$y$值无关。[杠杆值](@entry_id:172567)越大，说明该样本在描述符空间中越孤立，对模型拟合的影响也越大。所有[杠杆值](@entry_id:172567)的总和等于模型中的参数数量$p$（包括截距），因此平均[杠杆值](@entry_id:172567)为$p/n$。

一个常用的启发式规则是将警告阈值$h_*$设为平均[杠杆值](@entry_id:172567)的3倍，即$h_* = 3p/n$。对于[训练集](@entry_id:636396)中的一个样本，如果其$h_{ii} > h_*$，则它被认为是[高杠杆点](@entry_id:167038)，可能对模型有过度影响。对于一个待预测的新分子，我们可以计算其[杠杆值](@entry_id:172567)$h_{\text{new}} = x_{\text{new}}^{\top}(X^{\top}X)^{-1}x_{\text{new}}$。如果$h_{\text{new}} > h_*$，则该分子被认为超出了模型的[适用域](@entry_id:172549)，其预测结果不可靠。例如，对于一个包含$n=50$个分子、$p=6$个参数（$5$个描述符加$1$个截距）的模型，阈值$h_* = 3 \times 6 / 50 = 0.36$。任何[杠杆值](@entry_id:172567)超过$0.36$的新分子都应被标记为外推。值得注意的是，由于[杠杆值](@entry_id:172567)是在由$(X^{\top}X)^{-1}$定义的[度量空间](@entry_id:138860)中计算的距离，它对于描述符的任何[可逆线性变换](@entry_id:149915)（如[主成分分析](@entry_id:145395)）都是不变的，这使得它成为一个稳健的AD度量  。

综上所述，一个严谨的QSAR研究不仅需要构建一个模型，更需要通过一系列严格的统计验证程序来证明其预测能力的真实性和可靠性，并明确其预测的边界。