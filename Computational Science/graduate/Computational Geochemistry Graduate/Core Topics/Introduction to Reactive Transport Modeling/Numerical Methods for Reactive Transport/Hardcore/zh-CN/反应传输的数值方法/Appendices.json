{
    "hands_on_practices": [
        {
            "introduction": "在计算科学中，“代码验证”旨在回答一个基本问题：“我是否正确地求解了方程？”。本实践将介绍一种强大而通用的验证技术——“制造解方法”（Method of Manufactured Solutions, MMS）。通过精心设计一个具有已知精确解的测试问题，我们可以严格地检验数值模拟代码的实现，并验证其误差收敛速度是否与理论预期相符，这是确保代码可靠性的关键一步。",
            "id": "4094101",
            "problem": "一维空间中，溶解水相物质浓度 $c(x,t)$ 的平流-弥散-反应 (Advection–Dispersion–Reaction, ADR) 输运方程由平流、弥散、一级反应的平衡以及一个体积源项给出：\n$$\n\\frac{\\partial c}{\\partial t} + v \\,\\frac{\\partial c}{\\partial x} = D \\,\\frac{\\partial^2 c}{\\partial x^2} - k \\, c + q(x,t),\n$$\n定义在区域 $x \\in [0,1]$ 和 $t \\in [0,T]$ 上，其中 $v$ 是平流速度，$D$ 是弥散系数，$k$ 是一级反应速率常数，$q(x,t)$ 是一个已知的源项。假设数值离散在具有空间步长 $\\Delta x$ 和时间步长 $\\Delta t$ 的均匀网格上，时间上使用后向欧拉法，平流通量使用一阶迎风格式，弥散通量使用二阶中心差分格式。这些选择的理论局部截断误差在时间上为 $\\mathcal{O}(\\Delta t)$，平流为 $\\mathcal{O}(\\Delta x)$，弥散为 $\\mathcal{O}(\\Delta x^2)$，因此当平流存在且不可忽略时，全离散解在空间上的预期主导阶全局收敛为一阶。\n\n要求您使用“制造解方法”(Method of Manufactured Solutions, MMS) 定义“网格收敛性测试”(Grid Convergence Testing, GCT)，并概述一个科学合理、可验证的程序，以确认观测到的误差率与上述 ADR 离散化的理论阶数相匹配。您的回答应基于第一性原理：控制方程平衡、边界和初始数据的一致性，以及对于网格尺寸 $h$ 和阶数 $p$ 的渐近误差行为 $E(h) = C \\, h^p$。具体而言，请说明如何设计制造解 $c_{\\text{exact}}(x,t)$ 和相应的源项 $q(x,t)$，如何设置边界和初始条件，如何选择 $\\Delta x$ 和 $\\Delta t$ 的加密比以分离空间收敛和时间收敛，以及如何使用合适的范数和网格序列计算观测到的收敛率。考虑科学上真实的参数，例如 $v = 10^{-4} \\,\\mathrm{m/s}$，$D = 10^{-6} \\,\\mathrm{m^2/s}$，$k = 10^{-5} \\,\\mathrm{s^{-1}}$ 和 $T = 1.0 \\,\\mathrm{s}$，但除了证明程序的合理性外，不要依赖任何特殊的数值。\n\n哪个选项正确地定义了使用 MMS 的 GCT，并为所述的 ADR 离散化概述了适当的验证程序？\n\nA. 在 $x \\in [0,1]$，$t \\in [0,T]$ 上选择一个光滑的制造解 $c_{\\text{exact}}(x,t)$，通过将 $c_{\\text{exact}}$ 代入连续的 ADR 方程来推导 $q(x,t)$，并施加与 $c_{\\text{exact}}$ 完全一致的边界和初始条件。为验证空间阶数，固定一个网格序列，其网格间距为 $\\Delta x$, $\\Delta x/2$, $\\Delta x/4$，并选择足够小的 $\\Delta t$ 使时间误差相对于空间误差可以忽略不计，例如 $\\Delta t \\propto \\Delta x^2$。对每个网格，求解全离散系统，并通过将 $c_h$ 与限制在网格上的 $c_{\\text{exact}}$ 进行比较，在选定的范数（例如，最终时刻的离散 $L_2$ 范数）下计算误差 $E_h$。使用至少三个连续加密的网格，估计观测阶数 $p_{\\text{obs}} = \\frac{\\log(E_h/E_{h/2})}{\\log(2)}$，并检查在平流主导的情况下，当前格式的 $p_{\\text{obs}} \\approx 1$。为验证时间阶数，固定一个足够精细的空间网格以抑制空间误差，并加密 $\\Delta t$（例如，$\\Delta t$, $\\Delta t/2$, $\\Delta t/4$）以确认时间上的 $p_{\\text{obs}} \\approx 1$。如果 $p_{\\text{obs}}$ 在加密过程中趋于稳定，则得出结论：观测到的收敛率与理论阶数相符。\n\nB. 使用满足齐次边界条件的 $c_{\\text{exact}}(x,t)$，设置 $q(x,t) = 0$ 以避免复杂的项，并在网格 $\\Delta x$, $\\Delta x/2$, $\\Delta x/4$ 上运行离散化，同时保持恒定的 Courant–Friedrichs–Lewy (CFL) 数，即 $\\Delta t \\propto \\Delta x$。在最终时刻计算 $L_\\infty$ 范数下的误差 $E_h$，并使用 $p_{\\text{obs}} = \\frac{\\log_{10}(E_h/E_{h/2})}{\\log_{10}(2)}$。期望二阶空间收敛，因为弥散项是二阶的，并且在精细网格上主导平流。两个网格级别足以确认阶数。\n\nC. 定义 $c_{\\text{exact}}(x,t)$，并通过在每个网格上将全离散 ADR 算子应用于 $c_{\\text{exact}}$ 来计算离散源项 $q_h$，从而使离散残差恒为零。然后，对于任何 $\\Delta x$ 和 $\\Delta t$，数值解都等于 $c_{\\text{exact}}$，误差为零，这证实了无限阶收敛。这演示了 MMS，无需分析边界条件或范数。不需要网格加密。\n\nD. 任意选择 $c_{\\text{exact}}(x,t)$，强制施加独立于 $c_{\\text{exact}}$ 的简单常数边界条件，并从 ADR 方程推导 $q(x,t)$，但省略反应项 $k c$ 以降低刚度。使用三个网格，其间距为 $\\Delta x$, $\\Delta x/3$, $\\Delta x/9$，并使用一个固定的时间步长 $\\Delta t$，其值等于粗网格的 $\\Delta x$，以保持运行时间的可管理性。通过在最终时刻将细网格解插值到粗网格上来测量误差，并仅从这两个级别计算 $p_{\\text{obs}}$。由于弥散是二阶的，声称即使使用迎风平流，整个方法在空间上也是二阶的。",
            "solution": "问题陈述是验证偏微分方程数值方法的一个有效练习。我将继续进行分析。\n\n任务是使用“制造解方法”(Method of Manufactured Solutions, MMS) 为“网格收敛性测试”(Grid Convergence Testing, GCT) 定义一个科学合理的程序，以验证给定的一种平流-弥散-反应 (ADR) 方程数值离散化的理论收敛阶数。\n\n控制偏微分方程是：\n$$\n\\frac{\\partial c}{\\partial t} + v \\,\\frac{\\partial c}{\\partial x} = D \\,\\frac{\\partial^2 c}{\\partial x^2} - k \\, c + q(x,t)\n$$\n这可以使用微分算子 $\\mathcal{L}$ 写成 $\\mathcal{L}(c) = q(x,t)$，其中 $\\mathcal{L}(c) \\equiv \\frac{\\partial c}{\\partial t} + v \\,\\frac{\\partial c}{\\partial x} - D \\,\\frac{\\partial^2 c}{\\partial x^2} + k \\, c$。\n\n数值格式使用：\n1.  时间离散化：后向欧拉法，其理论局部截断误差 (LTE) 为 $\\mathcal{O}(\\Delta t)$。\n2.  平流通量离散化：一阶迎风格式，其 LTE 为 $\\mathcal{O}(\\Delta x)$。\n3.  弥散通量离散化：二阶中心差分，其 LTE 为 $\\mathcal{O}(\\Delta x^2)$。\n\n一个稳定且相容的数值方法的全局误差预期与其局部截断误差 (LTE) 的阶数相同。对于空间离散化，总阶数由最低阶项决定。在这种情况下，平流的一阶迎风格式决定了总的空间收敛将是一阶的，即 $\\mathcal{O}(\\Delta x)$ 阶，前提是平流项不可忽略。问题陈述中说明了平流存在且不可忽略。时间收敛是一阶的，$\\mathcal{O}(\\Delta t)$。\n\n验证程序的核心如下：\n\n**1. 制造解方法 (MMS)**\nMMS 的目的是创建一个先验地知道精确解析解的测试问题。这是通过以下方式实现的：\n-   选择一个制造解 $c_{\\text{exact}}(x,t)$，它必须足够光滑（即，拥有直到 PDE 中出现的最高阶的连续导数）且非平凡（即，它应该能激发算子 $\\mathcal{L}$ 中的所有项）。一个包含三角函数或多项式项的函数是常见的选择，例如 $c_{\\text{exact}}(x,t) = A \\sin(n\\pi x/L) \\cos(\\omega t) + C_0$。\n-   将这个选定的 $c_{\\text{exact}}(x,t)$ 代入连续微分算子 $\\mathcal{L}$ 中，以生成相应的源项 $q(x,t)$：\n    $$\n    q(x,t) = \\mathcal{L}(c_{\\text{exact}}) = \\frac{\\partial c_{\\text{exact}}}{\\partial t} + v \\,\\frac{\\partial c_{\\text{exact}}}{\\partial x} - D \\,\\frac{\\partial^2 c_{\\text{exact}}}{\\partial x^2} + k \\, c_{\\text{exact}}\n    $$\n-   将数值问题的初始条件和边界条件设置得与制造解完全一致：\n    -   初始条件：对于 $x \\in [0,1]$，$c(x,0) = c_{\\text{exact}}(x,0)$。\n    -   边界条件：对于 $t \\in [0,T]$，$c(0,t) = c_{\\text{exact}}(0,t)$ 且 $c(1,t) = c_{\\text{exact}}(1,t)$。\n通过这种方式构建问题，根据定义，函数 $c_{\\text{exact}}(x,t)$ 就是该制造的 PDE 问题（具有其特定的源项和边界/初始条件）的精确解。\n\n**2. 网格收敛性测试 (GCT)**\nGCT 涉及在一系列系统性加密的网格上求解制造的问题，以证明数值误差以理论预测的速率减小。\n-   **误差计算**：在一个特征间距为 $h$ 的网格上（其中 $h$ 可以代表 $\\Delta x$ 或 $\\Delta t$），计算数值解 $c_h$。误差 $E_h$ 是数值解与精确解之间的差值，用合适的范数来度量。例如，在最终时刻 $T$ 的离散 $L_2$ 范数是：\n    $$\n    E_h = \\left( \\frac{1}{N} \\sum_{i=1}^{N} [c_h(x_i, T) - c_{\\text{exact}}(x_i, T)]^2 \\right)^{1/2}\n    $$\n    其中 $N$ 是网格点的数量。\n-   **观测到的收敛阶数**：对于一个收敛阶数为 $p$ 的方法，当 $h$ 足够小时，误差预期表现为 $E_h \\approx C h^p$。使用两个连续加密的网格，一个间距为 $h_1$，另一个为 $h_2 = h_1/r$（其中 $r$ 是加密因子），可以计算出观测阶数 $p_{\\text{obs}}$：\n    $$\n    \\frac{E_{h_1}}{E_{h_2}} \\approx \\frac{C h_1^p}{C (h_1/r)^p} = r^p \\implies p_{\\text{obs}} \\approx \\frac{\\log(E_{h_1}/E_{h_2})}{\\log(r)}\n    $$\n    使用至少三个网格（例如 $h$, $h/2$, $h/4$，此时 $r=2$）可以检查 $p_{\\text{obs}}$ 是否稳定，这表明模拟处于渐近收敛区域。\n\n**3. 分离空间和时间收敛**\n总误差是空间和时间贡献的总和：$E \\approx C_x \\Delta x^p + C_t \\Delta t^q$。为了独立地验证 $p$ 和 $q$，必须使其中一个相对于另一个可以忽略不计。\n-   **验证空间阶数 $p$**：使用一个空间网格序列，例如，间距为 $\\Delta x$, $\\Delta x/2$, $\\Delta x/4$。为了确保时间误差 $C_t \\Delta t^q$ 不会干扰空间误差 $C_x \\Delta x^p$ 的测量，时间步长 $\\Delta t$ 必须比 $\\Delta x$ 加密得更剧烈。在我们的案例中，$p=1$ 且 $q=1$。一个常见的策略是设置 $\\Delta t \\propto \\Delta x^2$。这使得时间误差项 $\\mathcal{O}(\\Delta t) = \\mathcal{O}(\\Delta x^2)$ 比空间误差项 $\\mathcal{O}(\\Delta x)$ 消失得更快，从而分离出空间收敛。然后应该观察到 $p_{\\text{obs}} \\approx 1$。\n-   **验证时间阶数 $q$**：选择一个足够精细的单一空间网格，以使空间误差 $C_x \\Delta x^p$ 可以忽略不计。然后，使用一个时间步长序列，例如 $\\Delta t$, $\\Delta t/2$, $\\Delta t/4$，同时保持 $\\Delta x$ 固定。然后应该观察到时间收敛的 $p_{\\text{obs}} \\approx 1$。\n\n现在，我将基于这些原则评估每个选项。\n\n**选项 A：** 该选项正确地概述了整个过程。它准确地描述了：\n-   MMS 设置：选择 $c_{\\text{exact}}$，从连续 PDE 推导 $q(x,t)$，并从 $c_{\\text{exact}}$ 设置边界/初始条件。\n-   用于空间阶数的 GCT：使用一系列加密的网格（$\\Delta x, \\Delta x/2, \\Delta x/4$），使用合适的误差范数（$L_2$），并计算观测阶数 $p_{\\text{obs}} = \\frac{\\log(E_h/E_{h/2})}{\\log(2)}$。它正确地指出了需要三个网格来检查渐近行为。\n-   空间误差的分离：它建议设置 $\\Delta t \\propto \\Delta x^2$ 以使时间误差相对于一阶空间误差可以忽略不计，这是一种合理且标准的技术。\n-   预期的结果：它正确地预测，由于在平流主导区域使用了一阶迎风格式，空间阶数的 $p_{\\text{obs}} \\approx 1$。\n-   时间阶数的验证：它正确地描述了固定一个精细的空间网格并加密 $\\Delta t$ 以观察 $p_{\\text{obs}} \\approx 1$。\n-   最终结论：它正确地指出，目标是看 $p_{\\text{obs}}$ 是否稳定并与理论速率匹配。\n**结论：正确。**\n\n**选项 B：** 该选项包含几个基本错误。\n-   它错误地建议设置 $q(x,t) = 0$ 并使用满足齐次边界条件的 $c_{\\text{exact}}$。这不是 MMS。MMS 的核心是从选定的 $c_{\\text{exact}}$ 推导 $q(x,t)$；设置 $q(x,t)=0$ 意味着正在求解齐次问题，其解通常是未知的。\n-   它建议保持一个恒定的 CFL 数，$\\Delta t \\propto \\Delta x$。此过程同时加密了时间和空间，并没有分离出空间收敛阶数。\n-   它错误地期望二阶收敛。总阶数受限于最低阶项，即平流的一阶迎风格式。\n-   它错误地声称两个网格级别就足够了，这是一种不良实践。\n**结论：不正确。**\n\n**选项 C：** 该选项描述了一个完全不同的过程，它不是一个收敛性测试。\n-   它建议通过将*离散*算子应用于 $c_{\\text{exact}}$ 来定义源项 $q_h$。这创建了一个问题，其中数值解根据构造与网格节点上的精确解相同（在浮点误差范围内）。由此产生的误差为零，对于该方法针对原始*连续* PDE 的收敛阶数，不提供任何信息。\n-   “无限阶收敛”的结论是这种有缺陷的设置所产生的无意义的人为结果。此过程不验证代码对连续模型的实现。\n**结论：不正确。**\n\n**选项 D：** 该选项充满了方法论上的缺陷。\n-   它建议使用独立于 $c_{\\text{exact}}$ 的边界条件。这将引入边界误差，这些误差会污染解，并妨碍对真实内部收敛率的测量。\n-   它建议省略反应项。这意味着测试正在验证一个针对不同 PDE 的代码，而不是指定的那个。\n-   它建议在加密 $\\Delta x$ 的同时使用固定的时间步长 $\\Delta t$。当 $\\Delta x \\to 0$ 时，固定的时间误差最终将主导缩小的空间误差，导致观测到的收敛率衰减到零，从而破坏测试。\n-   它建议通过比较不同网格上的解来测量误差，而不是与已知的精确解进行比较。这是一种在精确解未知时估计误差的方法，而 MMS 的情况并非如此。\n-   它错误地声称该方法是二阶的。\n**结论：不正确。**\n\n总之，选项 A 是唯一一个描述了使用制造解方法和网格收敛性测试进行验证的科学严谨且标准的程序。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在验证了代码的正确性之后，我们可以利用它来研究数值方法的内在属性。许多数值格式，尤其是为保证稳定性而设计的一阶迎风格式，会引入非物理性的“数值扩散”效应，它可能会掩盖或夸大真实的物理弥散过程。本练习将通过一个动手编码实践，指导你如何通过计算溶质脉冲的二阶中心矩（方差）来量化这种数值扩散，并将其与物理弥散区分开来，这对于准确解释模拟结果至关重要。",
            "id": "4094145",
            "problem": "考虑在均质饱和多孔介质中，受质量守恒和菲克弥散控制的一维溶质运移。其基本原理是基于连续性方程和菲克定律推导出的、针对保守溶质的一维平流-弥散方程：$$\\frac{\\partial c}{\\partial t} + u \\frac{\\partial c}{\\partial x} = D \\frac{\\partial^2 c}{\\partial x^2},$$ 其中，$c(x,t)$ 是浓度，$u$ 是恒定的孔隙水流速（假定为正值），$D$ 是物理弥散系数。假设存在线性关系 $D = \\alpha u$，其中 $\\alpha$ 是物理弥散度。计算域为区间 $x \\in [0,L]$，在两个边界上均满足零弥散通量条件，平流方向为从左到右。初始条件为以 $x_0$ 为中心、标准差为 $\\sigma_0$ 的高斯脉冲，$$c(x,0) = \\frac{1}{\\sqrt{2 \\pi \\sigma_0^2}} \\exp\\left( -\\frac{(x-x_0)^2}{2 \\sigma_0^2} \\right).$$\n\n您必须在均匀网格上实现一个时间上采用全隐式格式（后向欧拉法）的有限差分方案，其中对流项采用一阶迎风格式，弥散项采用中心差分格式，网格间距为 $\\Delta x$。设 $\\Delta t$ 表示时间步长，$c_i^n$ 表示节点 $i$ 在时间层 $n$ 的离散浓度。对于正值 $u$，内部节点 $i$ 的离散隐式格式定义为\n$$\\frac{c_i^{n+1} - c_i^n}{\\Delta t} + u \\frac{c_i^{n+1} - c_{i-1}^{n+1}}{\\Delta x} = D \\frac{c_{i+1}^{n+1} - 2 c_i^{n+1} + c_{i-1}^{n+1}}{\\Delta x^2}.$$\n通过镜像虚拟值 $c_{-1}^{n+1} = c_{1}^{n+1}$ 和 $c_{N}^{n+1} = c_{N-2}^{n+1}$ 在 $x=0$ 和 $x=L$ 处施加零弥散通量条件，其中 $N$ 是网格点数，并与迎风模板一致地处理左边界的对流导数。每个时间步的隐式系统都应通过上述离散化所产生的三对角系统精确求解 $c^{n+1}$。\n\n通过离散解的二阶中心矩来定义时间 $t$ 的表观弥散度，对于有限体积近似，该值由离散质量 $m(t) = \\sum_i c_i(t) \\Delta x$、质心 $x_\\mathrm{cm}(t) = \\frac{1}{m(t)} \\sum_i x_i c_i(t) \\Delta x$ 和方差 $\\mathrm{Var}(t) = \\frac{1}{m(t)} \\sum_i (x_i - x_\\mathrm{cm}(t))^2 c_i(t) \\Delta x$ 计算得出。表观弥散系数估计为 $$D_{\\mathrm{app}} = \\frac{\\mathrm{Var}(t) - \\mathrm{Var}(0)}{2 t},$$ 表观弥散度为 $$\\alpha_{\\mathrm{app}} = \\frac{D_{\\mathrm{app}}}{|u|}.$$ 以米为单位表示 $\\alpha_{\\mathrm{app}}$。\n\n您的程序必须为每个测试案例运行两种网格分辨率，即一个粗网格和一个细网格，并计算在指定的最终时间 $t_{\\mathrm{final}}$ 下两种网格的 $\\alpha_{\\mathrm{app}}$。通过比较不同网格分辨率下的 $\\alpha_{\\mathrm{app}}$，程序能够区分物理弥散和数值弥散：如果存在数值弥散，粗网格上的 $\\alpha_{\\mathrm{app}}$ 会更大，并且随着网格的细化，该值会减小并趋近于已知的物理弥散度。\n\n使用以下测试套件。对于每个案例，使用 $N_t = 200$ 个时间步，因此 $\\Delta t = t_{\\mathrm{final}} / N_t$。除非另有说明，高斯初始条件参数均相同。对于所有案例，初始条件参数为 $x_0 = 1.0\\,\\mathrm{m}$ 和 $\\sigma_0 = 0.02\\,\\mathrm{m}$。所有案例中的域长度均为 $L = 10.0\\,\\mathrm{m}$。所有案例中的流速均为 $u = 1.0 \\times 10^{-4}\\,\\mathrm{m/s}$。\n\n- 案例 1（中等物理弥散）：$\\alpha = 0.01\\,\\mathrm{m}$，$D = \\alpha u$，$t_{\\mathrm{final}} = 5.0 \\times 10^{4}\\,\\mathrm{s}$，粗网格 $\\Delta x = 0.5\\,\\mathrm{m}$，细网格 $\\Delta x = 0.01\\,\\mathrm{m}$。\n- 案例 2（强物理弥散）：$\\alpha = 0.5\\,\\mathrm{m}$，$D = \\alpha u$，$t_{\\mathrm{final}} = 2.0 \\times 10^{4}\\,\\mathrm{s}$，粗网格 $\\Delta x = 0.5\\,\\mathrm{m}$，细网格 $\\Delta x = 0.01\\,\\mathrm{m}$。\n- 案例 3（无物理弥散）：$\\alpha = 0.0\\,\\mathrm{m}$，$D = \\alpha u = 0.0\\,\\mathrm{m^2/s}$，$t_{\\mathrm{final}} = 5.0 \\times 10^{4}\\,\\mathrm{s}$，粗网格 $\\Delta x = 0.5\\,\\mathrm{m}$，细网格 $\\Delta x = 0.01\\,\\mathrm{m}$。\n\n对于每个案例，计算两种网格在 $t_{\\mathrm{final}}$ 时的 $\\alpha_{\\mathrm{app}}$，并按以下最终输出格式汇总结果。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，顺序必须完全一致：\n$$[\\alpha_{\\mathrm{app}}^{(1,\\mathrm{coarse})}, \\alpha_{\\mathrm{app}}^{(1,\\mathrm{fine})}, \\alpha_{\\mathrm{app}}^{(2,\\mathrm{coarse})}, \\alpha_{\\mathrm{app}}^{(2,\\mathrm{fine})}, \\alpha_{\\mathrm{app}}^{(3,\\mathrm{coarse})}, \\alpha_{\\mathrm{app}}^{(3,\\mathrm{fine})}],$$\n其中每个条目都是以米为单位的浮点数。",
            "solution": "用户提供的问题已经过严格验证，被确定为计算地球化学领域一个有效、适定且科学合理地练习。它提出了一个标准的的一维平流-弥散问题，需用特定的有限差分方法求解。其目标是通过比较不同网格分辨率下的表观弥散度来量化数值弥散的影响。该问题是完整的，没有矛盾，并使用了标准的、可验证的原理。\n\n求解过程如下。首先，将指定的完全隐式有限差分格式表述为每个时间步的线性方程组。其次，将边界条件并入该系统，形成三对角矩阵结构。第三，设计一个时间步进算法来求解最终时间的浓度分布。最后，根据初始和最终浓度分布的二阶中心矩，按规定计算表观弥散度。\n\n控制性的平流-弥散方程（ADE）由下式给出：\n$$\n\\frac{\\partial c}{\\partial t} + u \\frac{\\partial c}{\\partial x} = D \\frac{\\partial^2 c}{\\partial x^2}\n$$\n其中 $c(x,t)$ 是溶质浓度，$u$ 是恒定的正孔隙水流速，$D$ 是弥散系数。域为 $x \\in [0, L]$。\n\n我们在空间步长为 $\\Delta x$、时间步长为 $\\Delta t$ 的均匀网格上对此方程进行离散化。令 $c_i^n \\approx c(i\\Delta x, n\\Delta t)$。问题指定了一个全隐式格式（时间上为后向欧拉法），对流项采用一阶迎风差分，弥散项采用二阶中心差分。对于内部网格节点 $i$，可得：\n$$\n\\frac{c_i^{n+1} - c_i^n}{\\Delta t} + u \\frac{c_i^{n+1} - c_{i-1}^{n+1}}{\\Delta x} = D \\frac{c_{i+1}^{n+1} - 2c_i^{n+1} + c_{i-1}^{n+1}}{\\Delta x^2}\n$$\n该方程可以重新排列，将时间层 $n+1$ 的未知项组合在左侧（LHS），将时间层 $n$ 的已知项放在右侧（RHS）：\n$$\n- \\left(\\frac{u \\Delta t}{\\Delta x} + \\frac{D \\Delta t}{\\Delta x^2}\\right) c_{i-1}^{n+1} + \\left(1 + \\frac{u \\Delta t}{\\Delta x} + \\frac{2 D \\Delta t}{\\Delta x^2}\\right) c_i^{n+1} - \\left(\\frac{D \\Delta t}{\\Delta x^2}\\right) c_{i+1}^{n+1} = c_i^n\n$$\n定义库朗数 $C_r = \\frac{u \\Delta t}{\\Delta x}$ 和数值扩散数（与佩克莱数相关）$P_e = \\frac{D \\Delta t}{\\Delta x^2}$，内部节点的方程变为：\n$$\n-(C_r + P_e) c_{i-1}^{n+1} + (1 + C_r + 2P_e) c_i^{n+1} - P_e c_{i+1}^{n+1} = c_i^n\n$$\n这构成了一个线性方程组 $A \\mathbf{c}^{n+1} = \\mathbf{c}^n$，其中 $\\mathbf{c}^n$ 是时间层 $n$ 的浓度向量。\n\n零弥散通量的边界条件通过虚拟节点施加。网格由 $N$ 个点组成，索引为 $i=0, 1, \\dots, N-1$。\n在左边界（$x=0$，节点 $i=0$），使用条件 $c_{-1}^{n+1} = c_{1}^{n+1}$。将其代入 $i=0$ 的通用离散方程中，并与迎风模板结合，我们得到：\n$$\n(1 + C_r + 2P_e) c_0^{n+1} - (C_r + 2P_e) c_1^{n+1} = c_0^n\n$$\n在右边界（$x=L$，节点 $i=N-1$），条件为 $c_{N}^{n+1} = c_{N-2}^{n+1}$。将其代入 $i=N-1$ 的通用方程中：\n$$\n-(C_r + 2P_e) c_{N-2}^{n+1} + (1 + C_r + 2P_e) c_{N-1}^{n+1} = c_{N-1}^n\n$$\n得到的 $N \\times N$ 矩阵 $A$ 是三对角矩阵，可以在每个时间步高效求解。主对角线元素均为 $(1 + C_r + 2P_e)$。下对角线元素为 $-(C_r + P_e)$，但最后一个元素为 $-(C_r + 2P_e)$。上对角线元素为 $-P_e$，但第一个元素为 $-(C_r + 2P_e)$。\n\n模拟从 $t=0$ 时的高斯初始条件开始：\n$$\nc(x,0) = \\frac{1}{\\sqrt{2 \\pi \\sigma_0^2}} \\exp\\left( -\\frac{(x-x_0)^2}{2 \\sigma_0^2} \\right)\n$$\n根据这个初始剖面，使用提供的离散矩公式计算 $t=0$ 时的方差值 $\\mathrm{Var}(0)$。然后，模拟进行 $N_t$ 个时间步，从 $t=0$ 到 $t=t_{\\mathrm{final}}$，通过重复求解三对角系统。在最后一步之后，根据得到的浓度剖面 $c(x, t_{\\mathrm{final}})$ 计算方差 $\\mathrm{Var}(t_{\\mathrm{final}})$。\n\n最后，计算表观弥散系数 $D_{\\mathrm{app}}$ 和表观弥散度 $\\alpha_{\\mathrm{app}}$：\n$$\nD_{\\mathrm{app}} = \\frac{\\mathrm{Var}(t_{\\mathrm{final}}) - \\mathrm{Var}(0)}{2 t_{\\mathrm{final}}}, \\quad \\alpha_{\\mathrm{app}} = \\frac{D_{\\mathrm{app}}}{|u|}\n$$\n对问题陈述中指定的每种物理参数和网格分辨率组合执行此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef run_simulation(L, u, alpha, x0, sigma0, t_final, Nt, dx):\n    \"\"\"\n    Runs a single 1D advection-dispersion simulation and computes apparent dispersivity.\n\n    Args:\n        L (float): Domain length [m].\n        u (float): Pore water velocity [m/s].\n        alpha (float): Physical dispersivity [m].\n        x0 (float): Initial pulse center [m].\n        sigma0 (float): Initial pulse standard deviation [m].\n        t_final (float): Final simulation time [s].\n        Nt (int): Number of time steps.\n        dx (float): Spatial grid spacing [m].\n\n    Returns:\n        float: The computed apparent dispersivity alpha_app [m].\n    \"\"\"\n    # 1. Setup grid and parameters\n    # The grid has N points, from x=0 to x=L inclusive.\n    N = int(round(L / dx)) + 1\n    x = np.linspace(0, L, N)\n    \n    actual_dx = x[1] - x[0]\n\n    dt = t_final / Nt\n    D = alpha * u\n    \n    C = u * dt / actual_dx  # Courant number\n    P = D * dt / actual_dx**2 # Diffusion number\n\n    # 2. Initial condition and its moments\n    c_initial = (1.0 / np.sqrt(2 * np.pi * sigma0**2)) * np.exp(-(x - x0)**2 / (2 * sigma0**2))\n    \n    m0 = np.sum(c_initial) * actual_dx\n    x_cm0 = (1.0 / m0) * np.sum(x * c_initial) * actual_dx\n    var0 = (1.0 / m0) * np.sum((x - x_cm0)**2 * c_initial) * actual_dx\n\n    # 3. Assemble the tridiagonal system matrix A in banded form\n    ab = np.zeros((3, N))\n    \n    # Main diagonal\n    ab[1, :] = 1.0 + C + 2.0 * P\n    \n    # Lower diagonal (sub-diagonal)\n    if N > 1:\n        ab[2, 0:N-1] = -(C + P)\n        ab[2, N-2] = -(C + 2*P) # Boundary condition at x=L\n    \n    # Upper diagonal (super-diagonal)\n    if N > 1:\n        ab[0, 1:] = -P\n        ab[0, 1] = -(C + 2*P) # Boundary condition at x=0\n\n    c_current = c_initial.copy()\n    for _ in range(Nt):\n        c_next = solve_banded((1, 1), ab, c_current, check_finite=False)\n        c_current = c_next\n    \n    # 5. Calculate final moments and apparent dispersivity\n    c_final = c_current\n    m_final = np.sum(c_final) * actual_dx\n    if m_final  1e-15: \n        return np.nan\n        \n    x_cm_final = (1.0 / m_final) * np.sum(x * c_final) * actual_dx\n    var_final = (1.0 / m_final) * np.sum((x - x_cm_final)**2 * c_final) * actual_dx\n    \n    D_app = (var_final - var0) / (2.0 * t_final)\n    alpha_app = D_app / np.abs(u)\n\n    return alpha_app\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    test_cases = [\n        (0.01, 5.0e4, 0.5, 0.01),  # Case 1\n        (0.5, 2.0e4, 0.5, 0.01),   # Case 2\n        (0.0, 5.0e4, 0.5, 0.01),   # Case 3\n    ]\n\n    L = 10.0\n    u = 1.0e-4\n    x0 = 1.0\n    sigma0 = 0.02\n    Nt = 200\n\n    results = []\n    for alpha, t_final, dx_coarse, dx_fine in test_cases:\n        alpha_app_coarse = run_simulation(L, u, alpha, x0, sigma0, t_final, Nt, dx_coarse)\n        results.append(alpha_app_coarse)\n\n        alpha_app_fine = run_simulation(L, u, alpha, x0, sigma0, t_final, Nt, dx_fine)\n        results.append(alpha_app_fine)\n\n    print(f\"[{','.join([f'{r:.6f}' for r in results])}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "反应输运模型的核心挑战在于处理输运和化学反应之间的耦合，尤其是在两者的时间尺度差异巨大（即“刚性”问题）时。本实践将对比两种主流的求解策略：将所有过程同时求解的“全局隐式法”（Globally Implicit Method），以及将输运和反应分步计算的“算子分裂法”（Operator Splitting）。通过实现这两种方法并量化它们之间的“分裂误差”，你将对不同耦合求解策略的准确性和效率权衡有更深刻的理解。",
            "id": "4094096",
            "problem": "考虑浓度为 $C(x,t)$ 的单一水相物质的一维反应输运，该过程受质量守恒、恒定线性平流、菲克弥散和线性一级反应控制。其控制偏微分方程为\n$$\n\\frac{\\partial C}{\\partial t} + v \\frac{\\partial C}{\\partial x} = D \\frac{\\partial^2 C}{\\partial x^2} - k C,\n$$\n在空间域 $x \\in [0,L]$ 上，具有周期性边界条件和以 $x_0$ 为中心的高斯初始条件，\n$$\nC(x,0) = \\frac{M_0}{\\sqrt{2\\pi}\\,\\sigma_0} \\exp\\left(-\\frac{(x-x_0)^2}{2\\sigma_0^2}\\right).\n$$\n其中，$v$ 是以 $\\mathrm{m/s}$ 为单位的恒定孔隙水流速，$D$ 是以 $\\mathrm{m^2/s}$ 为单位的恒定流体动力学弥散系数，$k$ 是以 $\\mathrm{s^{-1}}$ 为单位的一级反应速率。质量参数 $M_0$ 的单位为 $\\mathrm{mol/m^2}$，因此 $C$ 的单位为 $\\mathrm{mol/m^3}$。高斯宽度 $\\sigma_0$ 的单位为 $\\mathrm{m}$。\n\n您的任务是在相同的均匀空间网格和时间步长上实现并比较两种数值方案：\n- 顺序非迭代法（SNIA）：通过求解不含反应的输运子问题来推进一个时间步，然后应用反应子问题，两者均在时间上隐式求解（后向欧拉法）。\n- 全局隐式方案：通过隐式求解完全耦合的输运-反应系统来推进一个时间步（后向欧拉法）。\n\n使用包含 $N$ 个单元的均匀网格，间距为 $\\Delta x = L/N$。使用一阶迎风差分对平流项进行离散化，使用二阶中心差分对弥散项进行离散化。在空间离散化中强制执行周期性边界条件。使用时间步长为 $\\Delta t$ 的后向欧拉法进行时间步进；使用 $N_t = T/\\Delta t$ 个步长积分到最终时间 $T$（假设 $T/\\Delta t$ 为整数）。在所有情况下，设置 $x_0=L/2$。\n\n您必须计算在最终时间 $T$ 时的以下两个定量诊断指标：\n- 数值弥散度量：计算最终浓度场的质量加权二阶中心矩（方差），记为 $\\sigma_\\mathrm{num}^2(T)$，并减去具有恒定系数和平流-弥散以及高斯初始条件下的物理预期方差 $\\sigma_\\mathrm{phys}^2(T)$。在时间 $T$ 内由弥散引起的物理方差增量由 $2 D T$ 给出，平流保留方差，而反应则统一地重新缩放 $C$ 而不改变其形状。因此，\n$$\n\\sigma_\\mathrm{phys}^2(T) = \\sigma_0^2 + 2 D T,\n$$\n您的数值弥散度量必须作为浮点数报告\n$$\nE_\\mathrm{diff} = \\sigma_\\mathrm{num}^2(T) - \\sigma_\\mathrm{phys}^2(T),\n$$\n单位为 $\\mathrm{m^2}$。\n- 分裂误差度量：计算在时间 $T$ 时全局隐式解与 SNIA 解之间单位长度的均方根差，\n$$\nE_\\mathrm{split} = \\left(\\frac{1}{L} \\int_0^L \\left(C_\\mathrm{GI}(x,T) - C_\\mathrm{SNIA}(x,T)\\right)^2 \\, dx \\right)^{1/2},\n$$\n并以 $\\mathrm{mol/m^3}$ 为单位将其作为浮点数报告。\n\n离散化实现细节：\n- 对于 $v \\ge 0$，节点 $i$ 的一阶迎风离散导数为 $\\left(\\frac{C_i - C_{i-1}}{\\Delta x}\\right)$；对于 $v  0$，使用 $\\left(\\frac{C_{i+1} - C_i}{\\Delta x}\\right)$。对 $i=0$ 和 $i=N-1$ 应用周期性索引。\n- 离散拉普拉斯算子使用中心二阶差分：$\\left(\\frac{C_{i+1} - 2C_i + C_{i-1}}{\\Delta x^2}\\right)$，并采用周期性索引。\n- 用于输运子问题的后向欧拉法求解 $\\left(I - \\Delta t\\,(-v D_x + D L)\\right) C^\\ast = C^n$，隐式反应更新执行 $C^{n+1} = \\frac{C^\\ast}{1 + k \\Delta t}$，其中 $D_x$ 和 $L$ 分别表示离散平流和拉普拉斯算子。\n- 用于完全耦合方案的后向欧拉法求解 $\\left(I - \\Delta t\\,(-v D_x + D L - k I)\\right) C^{n+1} = C^n$。\n\n在间距为 $\\Delta x$ 的节点 $x_i$ 上，离散场 $C$ 的质量加权平均值和方差定义为\n$$\nM = \\sum_{i=0}^{N-1} C_i\\,\\Delta x,\\quad \\mu = \\frac{1}{M} \\sum_{i=0}^{N-1} x_i\\, C_i\\,\\Delta x,\\quad \\sigma_\\mathrm{num}^2 = \\frac{1}{M} \\sum_{i=0}^{N-1} (x_i - \\mu)^2\\, C_i\\,\\Delta x.\n$$\n\n测试套件：\n使用以下四个参数集，每个参数集指定 $(L,N,\\sigma_0,M_0,\\Delta t,T,v,D,k)$：\n- 案例 1（基准）：$(L=\\;10\\ \\mathrm{m},\\, N=\\;200,\\, \\sigma_0=\\;0.20\\ \\mathrm{m},\\, M_0=\\;1.0\\ \\mathrm{mol/m^2},\\, \\Delta t=\\;0.01\\ \\mathrm{s},\\, T=\\;1.00\\ \\mathrm{s},\\, v=\\;0.50\\ \\mathrm{m/s},\\, D=\\;0.010\\ \\mathrm{m^2/s},\\, k=\\;0.10\\ \\mathrm{s^{-1}})$。\n- 案例 2（高佩克莱特数 (Péclet number)，$D=0$）：$(L=\\;10\\ \\mathrm{m},\\, N=\\;200,\\, \\sigma_0=\\;0.20\\ \\mathrm{m},\\, M_0=\\;1.0\\ \\mathrm{mol/m^2},\\, \\Delta t=\\;0.01\\ \\mathrm{s},\\, T=\\;1.00\\ \\mathrm{s},\\, v=\\;1.00\\ \\mathrm{m/s},\\, D=\\;0.000\\ \\mathrm{m^2/s},\\, k=\\;0.05\\ \\mathrm{s^{-1}})$。\n- 案例 3（逆流）：$(L=\\;10\\ \\mathrm{m},\\, N=\\;200,\\, \\sigma_0=\\;0.20\\ \\mathrm{m},\\, M_0=\\;1.0\\ \\mathrm{mol/m^2},\\, \\Delta t=\\;0.01\\ \\mathrm{s},\\, T=\\;1.00\\ \\mathrm{s},\\, v=\\;-0.50\\ \\mathrm{m/s},\\, D=\\;0.020\\ \\mathrm{m^2/s},\\, k=\\;0.10\\ \\mathrm{s^{-1}})$。\n- 案例 4（刚性反应）：$(L=\\;10\\ \\mathrm{m},\\, N=\\;200,\\, \\sigma_0=\\;0.20\\ \\mathrm{m},\\, M_0=\\;1.0\\ \\mathrm{mol/m^2},\\, \\Delta t=\\;0.005\\ \\mathrm{s},\\, T=\\;1.00\\ \\mathrm{s},\\, v=\\;0.50\\ \\mathrm{m/s},\\, D=\\;0.010\\ \\mathrm{m^2/s},\\, k=\\;5.00\\ \\mathrm{s^{-1}})$。\n\n您的程序必须：\n- 对每种情况，在相同的网格和时间步长上实现两种方案。\n- 将两种方案都推进到时间 $T$。\n- 对每种情况，计算并返回序对 $[E_\\mathrm{diff}, E_\\mathrm{split}]$，其中 $E_\\mathrm{diff}$ 的单位是 $\\mathrm{m^2}$，$E_\\mathrm{split}$ 的单位是 $\\mathrm{mol/m^3}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。每个案例对应一个子列表，其中包含按上述顺序排列的两个浮点数，例如 $[[e_{1,d},e_{1,s}],[e_{2,d},e_{2,s}],\\dots]$。",
            "solution": "用户指定了一个计算地球化学中的有效问题，要求实现并比较两种用于一维反应输运方程的数值方案。该问题具有科学依据，是适定的，并提供了一套完整且一致的参数、离散化规则和评估指标。我将继续提供详细的解决方案。\n\n### 基于原理的数值解设计\n\n该问题涉及求解一维平流-弥散-反应方程（ADRE）：\n$$\n\\frac{\\partial C}{\\partial t} + v \\frac{\\partial C}{\\partial x} = D \\frac{\\partial^2 C}{\\partial x^2} - k C\n$$\n该方程可写为 $\\frac{\\partial C}{\\partial t} = \\mathcal{L}(C)$ 的形式，其中 $\\mathcal{L}$ 是空间算子 $\\mathcal{L}(C) = -v \\frac{\\partial C}{\\partial x} + D \\frac{\\partial^2 C}{\\partial x^2} - k C$。我们将使用有限差分法，在具有 $N$ 个点 $x_i = i \\Delta x$（其中 $i=0, \\dots, N-1$ 且 $\\Delta x = L/N$）的均匀网格上对该方程进行空间离散化。浓度场由向量 $\\mathbf{C}(t) = [C_0(t), C_1(t), \\dots, C_{N-1}(t)]^T$ 表示。\n\n空间离散化将偏微分方程转换为常微分方程组（ODEs）：\n$$\n\\frac{d\\mathbf{C}}{dt} = \\mathbf{A}\\mathbf{C}\n$$\n其中 $\\mathbf{A}$ 是一个 $N \\times N$ 矩阵，表示离散空间算子 $\\mathcal{L}$。矩阵 $\\mathbf{A}$ 是各物理过程对应矩阵的总和：\n$$\n\\mathbf{A} = -v \\mathbf{D}_x + D \\mathbf{L} - k \\mathbf{I}\n$$\n这里，$\\mathbf{D}_x$ 是一阶平流导数的矩阵，$\\mathbf{L}$ 是二阶拉普拉斯算子的矩阵，$\\mathbf{I}$ 是单位矩阵。\n\n#### 空间离散化矩阵\n\n由于周期性边界条件，矩阵 $\\mathbf{D}_x$ 和 $\\mathbf{L}$ 是循环矩阵。\n\n1.  **平流算子 $\\mathbf{D}_x$**：使用一阶迎风格式。\n    - 如果速度 $v \\ge 0$，则使用前向差分 $(\\frac{\\partial C}{\\partial x})_i \\approx \\frac{C_i - C_{i-1}}{\\Delta x}$。对应的矩阵 $\\mathbf{D}_x$ 的主对角线元素为 $1/\\Delta x$，次对角线元素为 $-1/\\Delta x$，并且由于周期性，在右上角位置 $\\mathbf{D}_x[0, N-1]$ 有一个 $-1/\\Delta x$。\n    - 如果速度 $v  0$，则使用后向差分 $(\\frac{\\partial C}{\\partial x})_i \\approx \\frac{C_{i+1} - C_i}{\\Delta x}$。矩阵 $\\mathbf{D}_x$ 的主对角线元素为 $-1/\\Delta x$，超对角线元素为 $1/\\Delta x$，并在左下角位置 $\\mathbf{D}_x[N-1, 0]$ 有一个 $1/\\Delta x$。\n\n2.  **弥散算子 $\\mathbf{L}$**：对拉普拉斯算子使用二阶中心差分，$(\\frac{\\partial^2 C}{\\partial x^2})_i \\approx \\frac{C_{i+1} - 2C_i + C_{i-1}}{\\Delta x^2}$。矩阵 $\\mathbf{L}$ 的主对角线元素为 $-2/\\Delta x^2$，次对角线和超对角线元素为 $1/\\Delta x^2$，并在角点 $\\mathbf{L}[0, N-1]$ 和 $\\mathbf{L}[N-1, 0]$ 处为 $1/\\Delta x^2$ 以强制执行周期性。\n\n#### 时间积分方案\n\n该常微分方程组使用恒定时间步长 $\\Delta t$ 从 $t=0$ 推进到 $t=T$。我们使用后向欧拉法，这是一种隐式方案。对于常微分方程组 $\\frac{d\\mathbf{C}}{dt} = \\mathbf{A}\\mathbf{C}$，从时间 $t_n$ 到 $t_{n+1}$ 的后向欧拉更新为：\n$$\n\\frac{\\mathbf{C}^{n+1} - \\mathbf{C}^n}{\\Delta t} = \\mathbf{A}\\mathbf{C}^{n+1} \\implies (\\mathbf{I} - \\Delta t \\mathbf{A})\\mathbf{C}^{n+1} = \\mathbf{C}^n\n$$\n在每个时间步，这需要求解一个线性方程组。\n\n1.  **全局隐式（GI）方案**：此方案同时且隐式地处理所有物理过程（平流、弥散、反应）。矩阵 $\\mathbf{A}$ 包含所有项：$\\mathbf{A}_{\\text{GI}} = -v \\mathbf{D}_x + D \\mathbf{L} - k \\mathbf{I}$。每步需求解的线性系统为：\n    $$\n    (\\mathbf{I} - \\Delta t \\mathbf{A}_{\\text{GI}})\\mathbf{C}^{n+1} = \\mathbf{C}^n\n    $$\n    $$\n    (\\mathbf{I} - \\Delta t(-v \\mathbf{D}_x + D \\mathbf{L} - k \\mathbf{I}))\\mathbf{C}^{n+1} = \\mathbf{C}^n\n    $$\n    矩阵 $\\mathbf{M}_{\\text{GI}} = (1+k\\Delta t)\\mathbf{I} + v\\Delta t\\mathbf{D}_x - D\\Delta t\\mathbf{L}$ 不随时间变化，如果进行一次分解，可以提高计算效率。\n\n2.  **顺序非迭代法（SNIA）**：这是一种算子分裂方案。整个演化过程被分为一个输运步骤和一个反应步骤。\n    - **步骤 1：输运**：求解 $\\frac{\\partial C}{\\partial t} = -v \\frac{\\partial C}{\\partial x} + D \\frac{\\partial^2 C}{\\partial x^2}$ 一个时间步长 $\\Delta t$。算子为 $\\mathbf{A}_{\\text{T}} = -v\\mathbf{D}_x + D \\mathbf{L}$。使用后向欧拉法，我们得到一个中间解 $\\mathbf{C}^*$：\n      $$\n      (\\mathbf{I} - \\Delta t \\mathbf{A}_{\\text{T}})\\mathbf{C}^* = \\mathbf{C}^n\n      $$\n      矩阵 $\\mathbf{M}_{\\text{SNIA}} = \\mathbf{I} + v\\Delta t\\mathbf{D}_x - D\\Delta t\\mathbf{L}$ 是恒定的。\n    - **步骤 2：反应**：以 $\\mathbf{C}^*$ 为初始条件，求解 $\\frac{\\partial C}{\\partial t} = -kC$ 一个时间步长。后向欧拉离散化为 $\\frac{C_i^{n+1}-C_i^*}{\\Delta t} = -kC_i^{n+1}$。这是对每个网格点 $i$ 的标量方程，可得到显式更新公式：\n      $$\n      C_i^{n+1} = \\frac{C_i^*}{1+k\\Delta t}\n      $$\n\n#### 初始条件和诊断指标\n\n- **初始条件**：在 $t=0$ 时，在网格上初始化一个高斯分布：\n  $$\n  C_i(0) = \\frac{M_0}{\\sqrt{2\\pi}\\,\\sigma_0} \\exp\\left(-\\frac{(x_i-x_0)^2}{2\\sigma_0^2}\\right) \\quad \\text{with } x_0=L/2.\n  $$\n\n- **数值弥散度量 ($E_\\mathrm{diff}$)**：该度量用于量化数值方案引入的人为弥散。它是浓度分布的数值计算方差与纯平流-弥散问题的解析方差之间的差值。方差是根据最终时间 $T$ 的全局隐式解计算得出的。\n  $$\n  E_\\mathrm{diff} = \\sigma_\\mathrm{num}^2(T) - \\sigma_\\mathrm{phys}^2(T)\n  $$\n  其中 $\\sigma_\\mathrm{phys}^2(T) = \\sigma_0^2 + 2 D T$。数值方差 $\\sigma_\\mathrm{num}^2$ 根据其定义，通过数值积分（对网格点求和）计算得出：\n  $$\n  M = \\sum_{i=0}^{N-1} C_i\\,\\Delta x, \\quad \\mu = \\frac{1}{M} \\sum_{i=0}^{N-1} x_i\\, C_i\\,\\Delta x, \\quad \\sigma_\\mathrm{num}^2 = \\frac{1}{M} \\sum_{i=0}^{N-1} (x_i - \\mu)^2\\, C_i\\,\\Delta x\n  $$\n  我们遵循问题中给出的这些矩的显式公式。\n\n- **分裂误差度量 ($E_\\mathrm{split}$)**：该度量衡量 GI 解与 SNIA 解之间的差异，该差异源于 SNIA 中的算子分裂。它被计算为两个最终浓度分布之间的均方根差（RMSD）。\n  $$\n  E_\\mathrm{split} = \\left(\\frac{1}{L} \\int_0^L \\left(C_\\mathrm{GI}(x,T) - C_\\mathrm{SNIA}(x,T)\\right)^2 \\, dx \\right)^{1/2}\n  $$\n  该积分通过在网格上求和来近似：\n  $$\n  E_\\mathrm{split} = \\left(\\frac{\\Delta x}{L} \\sum_{i=0}^{N-1} (C_{\\mathrm{GI},i}(T) - C_{\\mathrm{SNIA},i}(T))^2 \\right)^{1/2}\n  $$\n\n实现过程将包括构造必要的矩阵，为 GI 和 SNIA 方案建立线性系统，通过时间步进行迭代，最后为每个测试案例计算指定的诊断指标。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef build_advection_matrix(N, dx, v):\n    \"\"\"Builds the first-order upwind advection matrix with periodic BCs.\"\"\"\n    mat = np.zeros((N, N))\n    if v >= 0:\n        # Standard upwind (backward difference for positive v)\n        for i in range(N):\n            mat[i, i] = 1.0 / dx\n            mat[i, (i - 1 + N) % N] = -1.0 / dx\n    else:\n        # Upwind for negative v (forward difference)\n        for i in range(N):\n            mat[i, i] = -1.0 / dx\n            mat[i, (i + 1) % N] = 1.0 / dx\n    return mat\n\ndef build_laplacian_matrix(N, dx):\n    \"\"\"Builds the second-order centered difference Laplacian matrix with periodic BCs.\"\"\"\n    mat = np.zeros((N, N))\n    for i in range(N):\n        mat[i, i] = -2.0 / dx**2\n        mat[i, (i - 1 + N) % N] = 1.0 / dx**2\n        mat[i, (i + 1) % N] = 1.0 / dx**2\n    return mat\n\ndef solve_case(params):\n    \"\"\"\n    Solves the reactive transport problem for a single parameter case.\n    \"\"\"\n    L, N, sigma0, M0, dt, T, v, D, k = params\n    \n    dx = L / N\n    x = np.linspace(0, L - dx, N)\n    x0 = L / 2\n    \n    A = M0 / (np.sqrt(2 * np.pi) * sigma0)\n    C0 = A * np.exp(-(x - x0)**2 / (2 * sigma0**2))\n\n    Nt = int(round(T / dt))\n\n    D_x = build_advection_matrix(N, dx, v)\n    L_mat = build_laplacian_matrix(N, dx)\n    I = np.identity(N)\n\n    # --- Globally Implicit (GI) Scheme ---\n    A_gi = -v * D_x + D * L_mat - k * I\n    M_gi = I - dt * A_gi\n    \n    C_gi = np.copy(C0)\n    for _ in range(Nt):\n        C_gi = linalg.solve(M_gi, C_gi, assume_a='gen')\n\n    # --- Sequential Non-Iterative Approach (SNIA) ---\n    A_t = -v * D_x + D * L_mat\n    M_snia_t = I - dt * A_t\n    \n    C_snia = np.copy(C0)\n    for _ in range(Nt):\n        C_star = linalg.solve(M_snia_t, C_snia, assume_a='gen')\n        C_snia = C_star / (1.0 + k * dt)\n    \n    # --- Compute Diagnostics ---\n    # 1. Numerical diffusion metric (E_diff)\n    sigma_phys_sq = sigma0**2 + 2 * D * T\n    \n    final_mass_gi = np.sum(C_gi) * dx\n    \n    if final_mass_gi  1e-15:\n        sigma_num_sq = 0.0\n    else:\n        # Handle periodic mean for variance calculation\n        # The simple formula works as long as the pulse is not split by the boundary\n        mean_num = (1.0 / final_mass_gi) * np.sum(x * C_gi) * dx\n        # Correctly handle periodic domain for mean when pulse crosses boundary\n        if np.abs(x[-1] - mean_num)  np.abs(x[0] - mean_num):\n             mean_num = L\n        \n        # We must follow the problem statement's non-periodic variance formula\n        sigma_num_sq = (1.0 / final_mass_gi) * np.sum((x - mean_num)**2 * C_gi) * dx\n        \n    E_diff = sigma_num_sq - sigma_phys_sq\n    \n    # 2. Splitting error metric (E_split)\n    mse = np.sum((C_gi - C_snia)**2)\n    E_split = np.sqrt(mse * dx / L)\n\n    return [E_diff, E_split]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    \n    test_cases = [\n        (10.0, 200, 0.20, 1.0, 0.01, 1.00, 0.50, 0.010, 0.10),\n        (10.0, 200, 0.20, 1.0, 0.01, 1.00, 1.00, 0.000, 0.05),\n        (10.0, 200, 0.20, 1.0, 0.01, 1.00, -0.50, 0.020, 0.10),\n        (10.0, 200, 0.20, 1.0, 0.005, 1.00, 0.50, 0.010, 5.00),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        results = solve_case(case)\n        all_results.append(f\"[{results[0]:.6g},{results[1]:.6g}]\")\n\n    print(f\"[{','.join(all_results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}