{
    "hands_on_practices": [
        {
            "introduction": "Berendsen 控温器通过直接重置速度标度，为温度控制提供了一种直观的方法。本练习将温度的一阶连续弛豫模型与模拟时间步长中使用的离散速度标度因子联系起来。掌握这一推导是理解控温器如何在分子动力学模拟中被构建和实现的关键第一步。",
            "id": "5274833",
            "problem": "考虑一个具有 $N_f$ 个经典自由度的恒定粒子数、恒定体积的生物分子系统分子动力学 (MD) 模拟，其中温度由 Berendsen 类型的速度重标度弱耦合恒温器控制。瞬时动能温度 $T_{\\mathrm{inst}}$ 通过能量均分定理定义为 $T_{\\mathrm{inst}} = \\frac{2K}{N_f k_B}$，其中 $K$ 是总动能，$k_B$ 是玻尔兹曼常数 ($k_B$)。在每个 MD 时间步长，所有速度都乘以一个共同因子 $\\alpha$ 进行标度，位置则根据牛顿运动方程进行推进。\n\n假设目标温度为 $T_0$，且恒温器对动能温度施加一阶弛豫，该过程由常微分方程 $\\frac{dT}{dt} = \\frac{1}{\\tau_T}\\left(T_0 - T\\right)$ 控制，其中 $\\tau_T$ 是恒温器的时间常数。在一个持续时间为 $\\Delta t$ 的 MD 时间步长内，确保离散速度重标度 $v_i \\mapsto \\alpha v_i$ 与温度 $T$ 的弛豫方程的一阶前向欧拉积分之间的一致性。\n\n从基于能量均分定理的 $T_{\\mathrm{inst}}$ 定义以及速度重标度对动能的影响出发，推导 $\\alpha$ 的表达式，以确保 $T_{\\mathrm{inst}}$ 的单步离散更新与弛豫方程的前向欧拉离散化相匹配。然后，对于一个重标度步骤，给定 $\\tau_T = 0.1\\,\\mathrm{ps}$、$\\Delta t = 2\\,\\mathrm{fs}$、初始 $T_{\\mathrm{inst}} = 320\\,\\mathrm{K}$ 和目标 $T_0 = 300\\,\\mathrm{K}$，计算 $\\alpha$ 并预测重标度后瞬间的新瞬时温度。\n\n将您的数值结果四舍五入到四位有效数字。以 $\\mathrm{K}$ 为单位表示最终温度。将您的最终答案表示为一个行矩阵，其中包含 $\\alpha$ 和一步更新后的 $T_{\\mathrm{inst}}$。",
            "solution": "### 第 1 部分：标度因子 $\\alpha$ 的推导\n\n我们的任务是关联在一个 MD 时间步长 $\\Delta t$ 内，对温度变化的两种不同看法。\n\n首先，考虑速度重标度对瞬时温度的影响。设 $T$ 为时间步长开始时的瞬时温度。根据定义，$T = \\frac{2K}{N_f k_B}$，其中 $K$ 是系统的总动能。动能由 $K = \\sum_i \\frac{1}{2} m_i v_i^2$ 给出。\n\n速度被一个因子 $\\alpha$ 重标度，因此新速度为 $v_i' = \\alpha v_i$。新的动能 $K'$ 为：\n$$K' = \\sum_i \\frac{1}{2} m_i (v_i')^2 = \\sum_i \\frac{1}{2} m_i (\\alpha v_i)^2 = \\alpha^2 \\left( \\sum_i \\frac{1}{2} m_i v_i^2 \\right) = \\alpha^2 K$$\n新的瞬时温度 $T'$ 与新的动能 $K'$ 相关：\n$$T' = \\frac{2K'}{N_f k_B} = \\frac{2(\\alpha^2 K)}{N_f k_B} = \\alpha^2 \\left( \\frac{2K}{N_f k_B} \\right)$$\n因此，由速度重标度引起的温度变化是：\n$$T' = \\alpha^2 T$$\n\n其次，考虑由弛豫方程 $\\frac{dT}{dt} = \\frac{1}{\\tau_T}(T_0 - T)$ 决定的温度变化。我们使用一阶前向欧拉格式在时间间隔 $\\Delta t$ 上对该 ODE 进行离散化。导数 $\\frac{dT}{dt}$ 近似为 $\\frac{T' - T}{\\Delta t}$，其中 $T'$ 是时间步长结束时的温度。\n$$\\frac{T' - T}{\\Delta t} \\approx \\frac{1}{\\tau_T}(T_0 - T)$$\n解出新温度 $T'$ 得：\n$$T' \\approx T + \\frac{\\Delta t}{\\tau_T}(T_0 - T)$$\n\n为确保一致性，我们将新温度 $T'$ 的两个表达式相等：\n$$\\alpha^2 T = T + \\frac{\\Delta t}{\\tau_T}(T_0 - T)$$\n为了解出 $\\alpha$，我们两边除以 $T$（假设 $T \\neq 0$，这对于有限温度下的系统是一个有效的物理假设）：\n$$\\alpha^2 = 1 + \\frac{\\Delta t}{\\tau_T}\\left(\\frac{T_0 - T}{T}\\right) = 1 + \\frac{\\Delta t}{\\tau_T}\\left(\\frac{T_0}{T} - 1\\right)$$\n取正平方根（因为 $\\alpha$ 是一个标度因子，通常为正以保持速度方向）得到 $\\alpha$ 的最终表达式：\n$$\\alpha = \\sqrt{1 + \\frac{\\Delta t}{\\tau_T}\\left(\\frac{T_0}{T} - 1\\right)}$$\n推导到此完成。\n\n### 第 2 部分：数值计算\n\n我们已知以下数值：\n- $\\tau_T = 0.1\\,\\mathrm{ps} = 0.1 \\times 10^{-12}\\,\\mathrm{s}$\n- $\\Delta t = 2\\,\\mathrm{fs} = 2 \\times 10^{-15}\\,\\mathrm{s}$\n- 初始温度，$T = T_{\\mathrm{inst}} = 320\\,\\mathrm{K}$\n- 目标温度，$T_0 = 300\\,\\mathrm{K}$\n\n首先，我们计算无量纲比率 $\\frac{\\Delta t}{\\tau_T}$：\n$$\\frac{\\Delta t}{\\tau_T} = \\frac{2 \\times 10^{-15}\\,\\mathrm{s}}{0.1 \\times 10^{-12}\\,\\mathrm{s}} = \\frac{2 \\times 10^{-15}\\,\\mathrm{s}}{1 \\times 10^{-13}\\,\\mathrm{s}} = 2 \\times 10^{-2} = 0.02$$\n现在，将这个比率和温度代入 $\\alpha^2$ 的表达式中：\n$$\\alpha^2 = 1 + 0.02 \\left(\\frac{300\\,\\mathrm{K}}{320\\,\\mathrm{K}} - 1\\right)$$\n$$\\alpha^2 = 1 + 0.02 \\left(0.9375 - 1\\right)$$\n$$\\alpha^2 = 1 + 0.02(-0.0625)$$\n$$\\alpha^2 = 1 - 0.00125$$\n$$\\alpha^2 = 0.99875$$\n现在我们通过取平方根来计算 $\\alpha$：\n$$\\alpha = \\sqrt{0.99875} \\approx 0.999374811...$$\n四舍五入到四位有效数字，我们得到：\n$$\\alpha \\approx 0.9994$$\n\n接下来，我们预测重标度后瞬间的新瞬时温度 $T'$。我们可以使用前向欧拉表达式进行此计算，以避免传播由我们计算出的 $\\alpha$ 带来的舍入误差。\n$$T' = T + \\frac{\\Delta t}{\\tau_T}(T_0 - T)$$\n$$T' = 320\\,\\mathrm{K} + 0.02(300\\,\\mathrm{K} - 320\\,\\mathrm{K})$$\n$$T' = 320\\,\\mathrm{K} + 0.02(-20\\,\\mathrm{K})$$\n$$T' = 320\\,\\mathrm{K} - 0.4\\,\\mathrm{K}$$\n$$T' = 319.6\\,\\mathrm{K}$$\n这个结果已经有四位有效数字。\n\n要求的两个值是标度因子 $\\alpha$ 和新的瞬时温度 $T'$。\n$\\alpha \\approx 0.9994$\n$T' = 319.6\\,\\mathrm{K}$\n\n我们按照要求将这些结果表示为一个行矩阵。",
            "answer": "$$\\boxed{\\begin{pmatrix} 0.9994  319.6 \\end{pmatrix}}$$"
        },
        {
            "introduction": "对控温器的理论理解必须与在数值积分器中实现它们的实践知识相结合。本练习要求您将两种不同的控温方案——简单的 Berendsen 标度法和更复杂的 Nosé–Hoover 动力学——整合到广泛使用的速度 Verlet 算法中。通过对比这两种方法的实现，您将获得分子动力学模拟算法结构的实践经验，并理解简洁性与理论严谨性之间的权衡。",
            "id": "2466061",
            "problem": "给定一个质量为 $m$ 的单粒子，在劲度系数为 $k$ 的谐振子势中沿一维空间 $x$ 运动。势能为 $U(x) = \\tfrac{1}{2} k x^2$，力为 $F(x) = -\\tfrac{\\partial U}{\\partial x} = -k x$。该粒子将在约化单位（无量纲）下进行传播，其中 $m = 1$，$k = 1$，玻尔兹曼常数 $k_{\\mathrm{B}} = 1$。单粒子的二次自由度数为 $g = 1$。瞬时动能为 $K = \\tfrac{1}{2} m v^2$，瞬时动理学温度由能量均分关系 $K = \\tfrac{g}{2} k_{\\mathrm{B}} T$ 定义，在这些约化单位中，可得 $T = \\tfrac{2 K}{g}$。\n\n需要比较两种温控方案：\n\n1. Berendsen 弱耦合控温器：动理学温度 $T(t)$ 根据一阶弛豫方程 $\\dfrac{\\mathrm{d}T}{\\mathrm{d}t} = \\dfrac{T_0 - T}{\\tau_{\\mathrm{B}}}$ 向目标温度 $T_0$ 弛豫，其中耦合时间 $\\tau_{\\mathrm{B}} > 0$。在每个大小为 $\\Delta t$ 的离散时间步中，通过对粒子速度进行单次重标定，以实现在时间间隔 $\\Delta t$ 内由该连续方程所隐含的 $T$ 的离散弛豫。每次时间步必须精确地应用一次重标定，并且必须在完成完整的位置更新以及两次基于力的半步速度更新之后进行。\n\n2. Nosé–Hoover 控温器：引入一个控温器摩擦变量 $\\xi$，其控温器质量参数为 $Q > 0$。耦合常微分方程组为\n$$\n\\frac{\\mathrm{d}x}{\\mathrm{d}t} = v,\\quad\n\\frac{\\mathrm{d}v}{\\mathrm{d}t} = \\frac{F(x)}{m} - \\xi\\, v,\\quad\n\\frac{\\mathrm{d}\\xi}{\\mathrm{d}t} = \\frac{2K - g k_{\\mathrm{B}} T_0}{Q}.\n$$\n使用一种对称、二阶、时间可逆的分裂方法对这些方程进行积分，当移除控温器耦合时，该方法应退化为速度 Verlet 算法。在每个大小为 $\\Delta t$ 的时间步内，其布置必须使控温器变量 $\\xi$ 在每步的开始和结束时各推进半步，且与 $\\xi$ 相关的乘法速度标度在基于力的半步速度更新和位置更新的两侧对称地分半步作用。具体来说，在每个步内：执行 $\\xi$ 的半步控温器更新，然后通过 $\\exp(-\\xi \\Delta t/2)$ 进行半步乘法速度标度，接着是标准的 $v$ 的半步力更新，然后是 $x$ 的漂移，再是 $v$ 的第二次半步力更新，然后是通过 $\\exp(-\\xi \\Delta t/2)$ 进行的第二次半步乘法速度标度，最后是 $\\xi$ 的第二次半步控温器更新。在 $\\xi$ 的控温器更新中使用的动能 $K$ 必须根据每次控温器半步更新时刻的瞬时速度 $v$ 计算。\n\n初始条件固定为 $x(0) = x_0 = 1.0$，$v(0) = v_0 = 2.0$。对于 Nosé–Hoover 控温器，初始摩擦变量为 $\\xi(0) = 0.0$。目标温度在约化温度单位（无量纲）下为 $T_0 = 1.0$。\n\n您的任务是实现一个程序，该程序对动力学进行指定时间步数的积分，然后报告下面测试套件中每种情况下最终的瞬时动理学温度 $T$。所有温度必须以约化温度单位（无量纲）表示。\n\n测试套件（每项指定控温器类型、时间步 $\\Delta t$、步数 $N$ 和控温器参数）：\n\n- 测试 1 (Berendsen, 快速耦合): $\\Delta t = 0.01$, $N = 5000$, $\\tau_{\\mathrm{B}} = 0.05$。\n- 测试 2 (Berendsen, 弱耦合): $\\Delta t = 0.01$, $N = 5000$, $\\tau_{\\mathrm{B}} = 5.0$。\n- 测试 3 (Nosé–Hoover, 中等耦合): $\\Delta t = 0.002$, $N = 20000$, $Q = 1.0$。\n- 测试 4 (Nosé–Hoover, 近微正则极限): $\\Delta t = 0.002$, $N = 20000$, $Q = 10^6$。\n- 测试 5 (无控温器，使用速度 Verlet 的微正则参考): $\\Delta t = 0.01$, $N = 5000$。\n\n对于测试 1 和 2，您必须通过每步单次速度重标定来实现 Berendsen 温控，该重标定产生由 $\\dfrac{\\mathrm{d}T}{\\mathrm{d}t} = \\dfrac{T_0 - T}{\\tau_{\\mathrm{B}}}$ 所隐含的在 $\\Delta t$ 上的离散时间 $T$ 弛豫，并严格在完成标准速度 Verlet 步骤（$v$ 的半步力更新，$x$ 的完整漂移，$v$ 的第二次半步力更新）之后应用。对于测试 3 和 4，您必须使用上面指定的对称顺序实现 Nosé–Hoover 控温器。对于测试 5，您必须使用无控温器的标准速度 Verlet 积分器。\n\n您的程序应生成单行输出，其中包含测试 1 到 5 的最终瞬时动理学温度，格式为方括号内以逗号分隔的列表，例如，“[t1,t2,t3,t4,t5]”。每个 $t_i$ 必须是约化温度单位（无量纲）的浮点数。",
            "solution": "该问题要求对一个在一维谐振子势中运动的单粒子，在不同温控算法下，对其运动方程进行数值积分。该问题定义明确，科学上合理，并提供了所有必要的参数和初始条件。在实施这些数值方案之前，我们将着手推导和描述所需的数值方案。\n\n该系统由以下约化单位下的参数定义：粒子质量 $m=1$，谐振子势劲度系数 $k=1$，以及玻尔兹曼常数 $k_{\\mathrm{B}}=1$。势能为 $U(x) = \\frac{1}{2} k x^2 = \\frac{1}{2} x^2$，相应的力为 $F(x) = -k x = -x$。该系统有 $g=1$ 个二次自由度。\n\n瞬时动能为 $K = \\frac{1}{2} m v^2 = \\frac{1}{2} v^2$。瞬时动理学温度 $T$ 通过能量均分定理 $K = \\frac{g}{2} k_{\\mathrm{B}} T$ 定义。在指定的约化单位中，这简化为 $\\frac{1}{2} v^2 = \\frac{1}{2} (1) (1) T$，从而得到 $T = v^2$。\n\n初始条件为 $x(0) = 1.0$ 和 $v(0) = 2.0$。控温器的目标温度是 $T_0 = 1.0$。\n\n我们现在将详细说明五个指定测试用例的数值积分算法。\n\n**测试 5：使用速度 Verlet 的微正则系综 (NVE)**\n\n该测试作为没有任何控温器的基准。总能量 $E = K + U$ 应该守恒。积分使用标准的速度 Verlet 算法执行，这是一种对称的二阶辛积分器。对于一个时间步 $\\Delta t$，从时间 $t$ 到 $t+\\Delta t$ 的更新过程如下：\n1.  计算时间步中点的速度：$v(t + \\Delta t/2) = v(t) + \\frac{F(x(t))}{m} \\frac{\\Delta t}{2}$。\n2.  使用此中点速度更新位置：$x(t + \\Delta t) = x(t) + v(t + \\Delta t/2) \\Delta t$。\n3.  计算新位置处的力：$F(x(t+\\Delta t))$。\n4.  完成到时间步结束的速度更新：$v(t + \\Delta t) = v(t + \\Delta t/2) + \\frac{F(x(t+\\Delta t))}{m} \\frac{\\Delta t}{2}$。\n在我们的约化单位中，这变为：\n1.  $v_{mid} = v_{old} - x_{old} \\frac{\\Delta t}{2}$。\n2.  $x_{new} = x_{old} + v_{mid} \\Delta t$。\n3.  $v_{new} = v_{mid} - x_{new} \\frac{\\Delta t}{2}$。\n\n\n**测试 1 和 2：Berendsen 控温器**\n\nBerendsen 控温器将系统与外部热库弱耦合，迫使动理学温度 $T$ 根据一阶微分方程向目标温度 $T_0$ 弛豫：\n$$\n\\frac{\\mathrm{d}T}{\\mathrm{d}t} = \\frac{T_0 - T}{\\tau_{\\mathrm{B}}}\n$$\n其中 $\\tau_{\\mathrm{B}}$ 是耦合时间常数。为了在数值上实现这一点，我们首先执行如上所述的完整速度 Verlet 步骤。设 Verlet 步骤之后的速度为 $v_{Verlet}$，对应的温度为 $T_{Verlet} = v_{Verlet}^2$。然后我们重标定速度以获得一个新温度 $T_{new}$，该温度近似于弛豫方程在时间步 $\\Delta t$ 上的解。\n\n一阶有限差分近似给出下一步的目标温度：\n$$\nT_{new} = T_{Verlet} + \\frac{\\Delta t}{\\tau_{\\mathrm{B}}} (T_0 - T_{Verlet})\n$$\n速度通过一个因子 $\\lambda$ 进行重标定，使得 $v_{new} = \\lambda v_{Verlet}$。那么新温度为 $T_{new} = v_{new}^2 = \\lambda^2 v_{Verlet}^2 = \\lambda^2 T_{Verlet}$。将两个 $T_{new}$ 的表达式相等，可得：\n$$\n\\lambda^2 T_{Verlet} = T_{Verlet} + \\frac{\\Delta t}{\\tau_{\\mathrm{B}}} (T_0 - T_{Verlet})\n$$\n求解标度因子 $\\lambda$，我们得到：\n$$\n\\lambda = \\sqrt{1 + \\frac{\\Delta t}{\\tau_{\\mathrm{B}}} \\left( \\frac{T_0}{T_{Verlet}} - 1 \\right)}\n$$\n每个时间步的流程是：\n1.  执行一个完整的速度 Verlet 步骤以获得 $x_{new}$ 和 $v_{Verlet}$。\n2.  计算温度 $T_{Verlet} = v_{Verlet}^2$。\n3.  使用上述公式计算标度因子 $\\lambda$。平方根的参数必须为非负，对于给定的问题参数这是可以保证的。\n4.  将标度应用于速度：$v_{new} = \\lambda v_{Verlet}$。\n该步骤的最终状态是 $(x_{new}, v_{new})$。\n\n**测试 3 和 4：Nosé–Hoover 控温器**\n\nNosé–Hoover 控温器通过引入一个扩展的相空间变量 $\\xi$ 来生成正则 (NVT) 系综，该变量充当热库。运动方程如下：\n$$\n\\frac{\\mathrm{d}x}{\\mathrm{d}t} = v\n$$\n$$\n\\frac{\\mathrm{d}v}{\\mathrm{d}t} = \\frac{F(x)}{m} - \\xi v\n$$\n$$\n\\frac{\\mathrm{d}\\xi}{\\mathrm{d}t} = \\frac{2K - g k_{\\mathrm{B}} T_0}{Q} = \\frac{v^2 - T_0}{Q}\n$$\n该问题指定了一种对称、二阶、时间可逆的分裂算法来积分这些方程。设一步开始时的状态为 $(x_n, v_n, \\xi_n)$。该步结束时的状态 $(x_{n+1}, v_{n+1}, \\xi_{n+1})$ 通过以下序列获得：\n\n1.  **控温器变量的第一次半步更新**：计算动能 $K_n = \\frac{1}{2} m v_n^2$。将 $\\xi$ 更新半个时间步：\n    $$ \\xi_{n+1/2} = \\xi_n + \\frac{\\Delta t}{2} \\left( \\frac{2K_n - g k_{\\mathrm{B}} T_0}{Q} \\right) $$\n2.  **速度的第一次半步更新（控温器部分）**：标度速度：\n    $$ v'_{n} = v_n \\exp\\left( -\\xi_{n+1/2} \\frac{\\Delta t}{2} \\right) $$\n3.  **速度的第一次半步更新（力部分）**：\n    $$ v_{n+1/2} = v'_{n} + \\frac{\\Delta t}{2} \\frac{F(x_n)}{m} $$\n4.  **位置的完整更新**：\n    $$ x_{n+1} = x_n + v_{n+1/2} \\Delta t $$\n5.  **速度的第二次半步更新（力部分）**：计算新位置处的力 $F(x_{n+1})$：\n    $$ v'_{n+1} = v_{n+1/2} + \\frac{\\Delta t}{2} \\frac{F(x_{n+1})}{m} $$\n6.  **速度的第二次半步更新（控温器部分）**：使用相同的中点 $\\xi_{n+1/2}$ 再次标度速度：\n    $$ v_{n+1} = v'_{n+1} \\exp\\left( -\\xi_{n+1/2} \\frac{\\Delta t}{2} \\right) $$\n7.  **控温器变量的第二次半步更新**：计算最终动能 $K_{n+1} = \\frac{1}{2} m v_{n+1}^2$。完成 $\\xi$ 的更新：\n    $$ \\xi_{n+1} = \\xi_{n+1/2} + \\frac{\\Delta t}{2} \\left( \\frac{2K_{n+1} - g k_{\\mathrm{B}} T_0}{Q} \\right) $$\n\n在测试 3 和 4 的所有步骤中都遵循此方案。对于测试 4，控温器质量 $Q=10^6$ 的巨大数值将导致 $\\xi$ 的演化非常缓慢，使动力学近似于微正则系综，因为在模拟时间内控温器的影响极小。\n\n每个测试的最终输出将是在指定积分步数后的瞬时动理学温度 $T = v^2$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of simulating a 1D harmonic oscillator with different thermostats.\n    \"\"\"\n    \n    # Reduced unit constants from the problem statement\n    m = 1.0\n    k = 1.0\n    kb = 1.0\n    g = 1.0\n\n    # Initial conditions\n    x0 = 1.0\n    v0 = 2.0\n    xi0 = 0.0\n    \n    # Target temperature\n    T0 = 1.0\n    \n    # Test cases from the problem statement\n    test_cases = [\n        {'type': 'berendsen', 'dt': 0.01, 'N': 5000, 'params': {'tau_b': 0.05}},\n        {'type': 'berendsen', 'dt': 0.01, 'N': 5000, 'params': {'tau_b': 5.0}},\n        {'type': 'nose-hoover', 'dt': 0.002, 'N': 20000, 'params': {'Q': 1.0}},\n        {'type': 'nose-hoover', 'dt': 0.002, 'N': 20000, 'params': {'Q': 1e6}},\n        {'type': 'verlet', 'dt': 0.01, 'N': 5000, 'params': {}},\n    ]\n\n    results = []\n\n    # --- Integrator Implementations ---\n    \n    def force(x_val):\n        \"\"\"Calculates the force for the harmonic potential.\"\"\"\n        return -k * x_val\n    \n    def run_simulation(case):\n        \"\"\"\n        Runs a simulation for a given test case and returns the final temperature.\n        \"\"\"\n        sim_type = case['type']\n        dt = case['dt']\n        N = case['N']\n        params = case['params']\n        \n        x = x0\n        v = v0\n        \n        if sim_type == 'berendsen':\n            tau_b = params['tau_b']\n            for _ in range(N):\n                # Standard Velocity-Verlet step\n                v_mid = v + (force(x) / m) * (dt / 2.0)\n                x = x + v_mid * dt\n                v_verlet = v_mid + (force(x) / m) * (dt / 2.0)\n                \n                # Berendsen thermostat velocity scaling\n                T = m * v_verlet**2 / (g * kb)\n                \n                # Protect against T=0 and negative sqrt argument\n                if T == 0:\n                    lambda_val = 1.0\n                else:\n                    lambda_sq = 1.0 + (dt / tau_b) * (T0 / T - 1.0)\n                    if lambda_sq  0:\n                        lambda_sq = 0.0\n                    lambda_val = np.sqrt(lambda_sq)\n                \n                v = v_verlet * lambda_val\n\n        elif sim_type == 'nose-hoover':\n            Q = params['Q']\n            xi = xi0\n            for _ in range(N):\n                # 1. First half-update of thermostat variable xi\n                K_n = 0.5 * m * v**2\n                xi = xi + (dt / 2.0) * (2.0 * K_n - g * kb * T0) / Q\n                \n                # 2. First velocity scaling\n                scale_factor = np.exp(-xi * dt / 2.0)\n                v = v * scale_factor\n                \n                # 3. First half-update of velocity (force)\n                v = v + (dt / 2.0) * (force(x) / m)\n                v_mid = v\n\n                # 4. Full position update\n                x = x + v_mid * dt\n                \n                # 5. Second half-update of velocity (force)\n                v_prime_end = v_mid + (dt / 2.0) * (force(x) / m)\n                \n                # 6. Second velocity scaling\n                v = v_prime_end * scale_factor\n                \n                # 7. Second half-update of thermostat variable xi\n                K_n1 = 0.5 * m * v**2\n                xi = xi + (dt / 2.0) * (2.0 * K_n1 - g * kb * T0) / Q\n\n        elif sim_type == 'verlet':\n            for _ in range(N):\n                # Standard Velocity-Verlet step\n                v_mid = v + (force(x) / m) * (dt / 2.0)\n                x = x + v_mid * dt\n                v = v_mid + (force(x) / m) * (dt / 2.0)\n\n        # Calculate final instantaneous kinetic temperature\n        final_T = m * v**2 / (g * kb)\n        return final_T\n\n    # --- Main Execution Loop ---\n    \n    for case in test_cases:\n        final_temp = run_simulation(case)\n        results.append(final_temp)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "分子模拟中的一个常见误区是，认为一个能正确维持平均温度的控温器也能生成正确的统计系综。本练习将引导您通过推导 Berendsen 控温器产生的动能分布，并将其与真实的正则（伽马）分布进行比较，从而从数学上证明事实并非如此。完成此分析有助于深刻、定量地理解为什么 Berendsen 控温器被认为是“非严谨的”，并突显了选择能够保持目标系综统计特性的控温器的重要性。",
            "id": "3823467",
            "problem": "一个质量为 $m$、角频率为 $\\omega$ 的一维谐振子与一个 Berendsen 恒温器耦合，该恒温器的弛豫时间为 $\\tau$，通过重标速度将瞬时温度驱动至目标温度 $T_{0}$。在强耦合极限下，恒温器的作用时间尺度远快于振子动力学的时间尺度，假设总能量 $E$ 被恒温器有效固定，使得长时间平均动能等于 $\\frac{1}{2} k_{B} T_{0}$，其中 $k_{B}$ 是玻尔兹曼常数。由于时间尺度的分离，在稳态下可以认为振子相位在一个周期内均匀分布。因此，瞬时动能可以表示为 $K(t) = E \\sin^{2}(\\omega t + \\phi)$，其中相位 $\\phi$ 在 $[0, 2\\pi)$ 上均匀分布。\n\n从振子相位的均匀时间采样和平衡态下的麦克斯韦-玻尔兹曼速度分布出发，并取 $E = k_{B} T_{0}$ 以确保恒温器固定和正则采样下的平均动能相等，请执行以下操作：\n\n- 推导在上述强耦合极限下，Berendsen 恒温器作用下动能 $K$ 的稳态概率密度 $p_{B}(K)$。\n- 推导在温度 $T_{0}$ 下，单个速度自由度的动能 $K$ 的正则概率密度 $p_{C}(K)$。\n- 使用 Kullback–Leibler 散度 (KLD) 的定义 $D_{\\mathrm{KL}}(p \\| q) = \\int p(K) \\ln\\!\\big(p(K)/q(K)\\big)\\, \\mathrm{d}K$，计算 $D_{\\mathrm{KL}}\\!\\big(p_{B} \\| p_{C}\\big)$ 的闭合形式。\n\n将最终答案表示为单个精确的解析表达式。最终答案无需四舍五入，也无需单位，因为 Kullback–Leibler 散度是无量纲的。",
            "solution": "该问题的求解分为三个步骤：首先，推导在强耦合 Berendsen 恒温器作用下谐振子的动能概率密度 $p_B(K)$；其次，推导在正则系综中同一系统的动能概率密度 $p_C(K)$；最后，计算这两个分布之间的 Kullback-Leibler (KL) 散度。为简洁起见，令 $\\beta_{T} = k_{B} T_{0}$。\n\n### 第一步：推导 Berendsen 恒温器下的动能概率密度 $p_{B}(K)$\n\n根据问题描述，在强耦合极限下，动能由 $K = E \\sin^{2}(\\theta)$ 给出，其中总能量固定为 $E=\\beta_T$，相位 $\\theta$ 在 $[0, 2\\pi)$ 上均匀分布，其概率密度为 $p_{\\Theta}(\\theta) = \\frac{1}{2\\pi}$。动能 $K$ 的取值范围是 $[0, \\beta_{T}]$。\n\n我们通过变量变换方法来求 $K$ 的概率密度函数 (PDF)。首先计算其累积分布函数 (CDF)，$F_{K}(k) = P(K \\le k)$：\n$$P(K \\le k) = P(\\beta_{T} \\sin^{2}(\\theta) \\le k) = P\\left(|\\sin(\\theta)| \\le \\sqrt{\\frac{k}{\\beta_{T}}}\\right)$$\n对于 $\\theta \\in [0, 2\\pi)$，不等式 $|\\sin(\\theta)| \\le y$（其中 $y = \\sqrt{k/\\beta_{T}}$）成立的区间总长度为 $4\\arcsin(y)$。由于 $\\theta$ 是均匀分布的，其概率为总长度除以 $2\\pi$：\n$$F_{K}(k) = \\frac{4\\arcsin(\\sqrt{k/\\beta_{T}})}{2\\pi} = \\frac{2}{\\pi}\\arcsin\\left(\\sqrt{\\frac{k}{\\beta_{T}}}\\right)$$\n\n对 CDF 求关于 $K$ 的导数，即可得到 PDF $p_{B}(K)$：\n$$p_{B}(K) = \\frac{\\mathrm{d}F_{K}(K)}{\\mathrm{d}K} = \\frac{2}{\\pi} \\frac{\\mathrm{d}}{\\mathrm{d}K} \\arcsin\\left(\\sqrt{\\frac{K}{\\beta_{T}}}\\right)$$\n运用链式法则：\n$$p_{B}(K) = \\frac{2}{\\pi} \\frac{1}{\\sqrt{1 - (K/\\beta_{T})}} \\cdot \\frac{1}{2\\sqrt{\\beta_{T}K}} = \\frac{1}{\\pi\\sqrt{K(\\beta_{T}-K)}}$$\n该分布在 $K \\in (0, \\beta_T)$ 区间内有定义。\n\n### 第二步：推导正则系综下的动能概率密度 $p_{C}(K)$\n\n对于正则系综中温度为 $T_0$ 的单个一维自由度，速度 $v$ 遵循麦克斯韦-玻尔兹曼分布：\n$$p_{V}(v) = \\sqrt{\\frac{m}{2\\pi \\beta_T}} \\exp\\left(-\\frac{mv^2}{2\\beta_T}\\right)$$\n动能与速度的关系为 $K = \\frac{1}{2}mv^2$。由于 $v = \\pm\\sqrt{2K/m}$，我们可以通过变量变换得到 $K$ 的 PDF。考虑到 $v$ 的正负值，我们有 $p_{C}(K)|\\mathrm{d}K| = 2p_{V}(v)|\\mathrm{d}v|$。\n从 $K = \\frac{1}{2}mv^2$ 可得 $|\\mathrm{d}v| = \\frac{\\mathrm{d}K}{\\sqrt{2mK}}$。代入可得：\n$$p_{C}(K) = 2 \\left(\\sqrt{\\frac{m}{2\\pi \\beta_T}} \\exp\\left(-\\frac{K}{\\beta_T}\\right)\\right) \\frac{1}{\\sqrt{2mK}}$$\n$$p_{C}(K) = \\frac{1}{\\sqrt{\\pi \\beta_T K}} \\exp\\left(-\\frac{K}{\\beta_T}\\right) = \\frac{1}{\\sqrt{\\pi\\beta_T}} K^{-1/2} \\exp\\left(-\\frac{K}{\\beta_T}\\right)$$\n这是一个形状参数为 $1/2$、尺度参数为 $\\beta_T$ 的伽马分布。\n\n### 第三步：计算 Kullback-Leibler 散度\n\nKL 散度的定义为 $D_{\\mathrm{KL}}(p_{B} \\| p_{C}) = \\int_{0}^{\\beta_{T}} p_{B}(K) \\ln\\left(\\frac{p_{B}(K)}{p_{C}(K)}\\right) \\mathrm{d}K$。\n首先计算对数比：\n$$\\ln\\left(\\frac{p_{B}(K)}{p_{C}(K)}\\right) = \\ln(p_{B}(K)) - \\ln(p_{C}(K))$$\n$$\\ln(p_{B}(K)) = -\\ln(\\pi) - \\frac{1}{2}\\ln(K) - \\frac{1}{2}\\ln(\\beta_{T}-K)$$\n$$\\ln(p_{C}(K)) = -\\frac{1}{2}\\ln(\\pi\\beta_{T}) - \\frac{1}{2}\\ln(K) - \\frac{K}{\\beta_{T}}$$\n相减得到：\n$$\\ln\\left(\\frac{p_{B}(K)}{p_{C}(K)}\\right) = -\\frac{1}{2}\\ln(\\pi) + \\frac{1}{2}\\ln(\\beta_{T}) - \\frac{1}{2}\\ln(\\beta_{T}-K) + \\frac{K}{\\beta_{T}}$$\n\n将此表达式代入 KL 散度的积分中，并分项计算：\n$$D_{\\mathrm{KL}}(p_{B} \\| p_{C}) = \\int_{0}^{\\beta_{T}} p_{B}(K) \\left[-\\frac{1}{2}\\ln(\\pi) + \\frac{1}{2}\\ln(\\beta_{T}) - \\frac{1}{2}\\ln(\\beta_{T}-K) + \\frac{K}{\\beta_{T}}\\right] \\mathrm{d}K$$\n1. $\\int p_B(K) (-\\frac{1}{2}\\ln(\\pi)) \\mathrm{d}K = -\\frac{1}{2}\\ln(\\pi)$\n2. $\\int p_B(K) (\\frac{1}{2}\\ln(\\beta_{T})) \\mathrm{d}K = \\frac{1}{2}\\ln(\\beta_{T})$\n3. $\\int p_B(K) \\frac{K}{\\beta_{T}} \\mathrm{d}K = \\frac{\\langle K \\rangle_B}{\\beta_T} = \\frac{\\beta_T/2}{\\beta_T} = \\frac{1}{2}$\n4. $\\int p_B(K) (-\\frac{1}{2}\\ln(\\beta_{T}-K)) \\mathrm{d}K = -\\frac{1}{2\\pi} \\int_{0}^{\\beta_T} \\frac{\\ln(\\beta_T-K)}{\\sqrt{K(\\beta_T-K)}} \\mathrm{d}K$\n\n对于第四项积分，使用换元法 $K = \\beta_T \\sin^2(u)$，$\\mathrm{d}K = 2\\beta_T \\sin(u)\\cos(u)\\,\\mathrm{d}u$。\n$$-\\frac{1}{2\\pi} \\int_{0}^{\\pi/2} \\frac{\\ln(\\beta_T\\cos^2 u)}{\\beta_T\\sin u \\cos u} (2\\beta_T\\sin u\\cos u)\\,\\mathrm{d}u = -\\frac{1}{\\pi} \\int_{0}^{\\pi/2} (\\ln(\\beta_T) + 2\\ln(\\cos u))\\,\\mathrm{d}u$$\n利用 $\\int_0^{\\pi/2}\\ln(\\cos u)\\,\\mathrm{d}u = -\\frac{\\pi}{2}\\ln 2$，该项积分结果为：\n$$-\\frac{1}{\\pi} \\left( \\frac{\\pi}{2}\\ln(\\beta_T) - \\pi\\ln 2 \\right) = -\\frac{1}{2}\\ln(\\beta_T) + \\ln 2$$\n\n将四项结果相加：\n$$D_{\\mathrm{KL}}(p_{B} \\| p_{C}) = \\left(-\\frac{1}{2}\\ln \\pi\\right) + \\left(\\frac{1}{2}\\ln \\beta_T\\right) + \\left(\\frac{1}{2}\\right) + \\left(-\\frac{1}{2}\\ln \\beta_T + \\ln 2\\right)$$\n$$D_{\\mathrm{KL}}(p_{B} \\| p_{C}) = \\frac{1}{2} + \\ln 2 - \\frac{1}{2}\\ln \\pi = \\frac{1 + 2\\ln 2 - \\ln \\pi}{2} = \\frac{1 + \\ln(4/\\pi)}{2}$$\n最终表达式与系统参数和温度无关。",
            "answer": "$$\\boxed{\\frac{1 + \\ln\\left(\\frac{4}{\\pi}\\right)}{2}}$$"
        }
    ]
}