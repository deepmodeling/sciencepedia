{
    "hands_on_practices": [
        {
            "introduction": "隐式溶剂模型的核心在于用连续介质静电学来描述溶剂的宏观屏蔽效应，其数学基础是泊松方程。这个实践  引导您从零开始构建一个有限元方法（FEM）求解器，用于计算溶质周围的静电势。通过亲手推导并实现这一过程，您将深刻理解隐式模型是如何将静电理论转化为可行的计算方案的，并掌握评估数值精度的基本方法。",
            "id": "3899789",
            "problem": "考虑一个二维空间中液-固界面处溶剂化带电溶质的隐式溶剂连续介电模型。在域 $\\Omega \\subset \\mathbb{R}^2$ 内的静电势场 $\\phi(\\mathbf{r})$ 满足从麦克斯韦方程组推导出的泊松方程，即 $-\\nabla \\cdot \\left( \\epsilon(\\mathbf{r}) \\nabla \\phi(\\mathbf{r}) \\right) = \\rho(\\mathbf{r})$ 在 $\\Omega$ 中成立，其中 $\\epsilon(\\mathbf{r})$ 是空间变化的介电常数，$\\rho(\\mathbf{r})$ 是自由电荷密度。溶质与溶剂之间的界面由一个在溶质边界处有急剧跳变的逐段常数介电函数 $\\epsilon(\\mathbf{r})$ 表示。溶质被建模为以原点为中心、半径为 $a$ 的圆盘，其上带有预设的电荷分布 $\\rho(\\mathbf{r})$。外部的溶剂被视为一个介电连续体。模拟盒子外边界上的边界条件是 $\\phi(\\mathbf{r}) = 0$ (狄利克雷)，表示一个离溶质足够远的接地边界。所有量都已无量纲化；以无量纲单位报告结果。\n\n您的任务是推导、实现和计算具有空间变化 $\\epsilon(\\mathbf{r})$ 的泊松方程弱形式的线性有限元方法 (FEM) 解，并评估网格细化对可观测量量的影响。从物质中的静电学基本定律，特别是 $\\nabla \\cdot \\mathbf{D} = \\rho$（其中 $\\mathbf{D} = \\epsilon(\\mathbf{r}) \\mathbf{E}$ 和 $\\mathbf{E} = -\\nabla \\phi$）出发，推导在协调三角形网格上使用分段线性基函数的弱形式。不要假定任何预先推导好的刚度矩阵公式；需从弱形式和基函数的定义出发进行推导。使用一个一致的求积方案，该方案能为具有分段常数系数的分段线性单元保持精度阶。强加狄利克雷边界条件。\n\n域和材料模型：\n- 计算域为正方形 $\\Omega = [-L,L] \\times [-L,L]$，其中 $L = 2.0$。\n- 溶质区域为圆盘 $\\{ \\mathbf{r} : \\|\\mathbf{r}\\|  a \\}$，其中 $a = 0.5$，介电常数为 $\\epsilon_{\\text{in}} = 2.0$。\n- 溶剂区域为外部 $\\{ \\mathbf{r} : \\|\\mathbf{r}\\| \\ge a \\}$，介电常数为 $\\epsilon_{\\text{out}} = 80.0$。\n- 自由电荷密度为高斯分布，总电荷 $q = 1.0$，宽度参数 $\\sigma = 0.1$，\n  $$\\rho(\\mathbf{r}) = \\frac{q}{2\\pi \\sigma^2} \\exp\\left( - \\frac{\\|\\mathbf{r}\\|^2}{2\\sigma^2} \\right)。$$\n- 介电常数为逐段常数：\n  $$\\epsilon(\\mathbf{r}) = \\begin{cases}\n  \\epsilon_{\\text{in}},  \\|\\mathbf{r}\\|  a,\\\\\n  \\epsilon_{\\text{out}},  \\|\\mathbf{r}\\| \\ge a.\n  \\end{cases}$$\n\n离散化和数值要求：\n- 在 $\\Omega$ 上使用一个 $N \\times N$ 的均匀结构化正方形网格，并将每个正方形细分为2个三角形，以形成一个每个单元上带有线性形函数的协调三角形网格。\n- 使用标准的伽辽金方法。对于一个面积为 $A_K$、局部线性基为 $\\{N_i\\}_{i=1}^3$ 的单元 $K$，单元刚度项为 $K_{ij}^{(K)} = \\int_{K} \\epsilon(\\mathbf{r}) \\nabla N_i \\cdot \\nabla N_j \\, d\\mathbf{r}$，单元载荷项为 $f_i^{(K)} = \\int_{K} \\rho(\\mathbf{r}) N_i(\\mathbf{r}) \\, d\\mathbf{r}$。\n- 通过在单元形心处计算 $\\epsilon(\\mathbf{r})$ 和 $\\rho(\\mathbf{r})$ 来近似空间变化的系数，并使用一个一致的求积法，对于线性 $N_i$ 产生 $f_i^{(K)} \\approx \\rho(\\mathbf{r}_c) A_K / 3$，其中 $\\mathbf{r}_c$ 是 $K$ 的形心。\n- 在 $\\partial \\Omega$ 上施加边界条件 $\\phi = 0$。\n\n需要报告的可观测量：\n- 在观测点 $\\mathbf{r}_{\\text{obs}} = (0.3, 0.0)$ 处的静电势，通过选择离 $\\mathbf{r}_{\\text{obs}}$ 最近的网格节点处的值获得。\n- 静电能量泛函值\n  $$U = \\frac{1}{2} \\int_{\\Omega} \\rho(\\mathbf{r}) \\, \\phi(\\mathbf{r}) \\, d\\mathbf{r}，$$\n  通过在每个单元上对 $\\phi$ 进行线性插值的单元形心求积法来近似。\n\n测试套件：\n- 使用三种网格分辨率 $N \\in \\{16, 32, 64\\}$，所有其他参数按上述规定固定。它们分别代表粗糙、中等和精细网格。此测试套件旨在探究以下方面：\n  - $N = 16$：粗糙网格，用于测试稳定性和基本正确性。\n  - $N = 32$：中等网格，用于评估收敛趋势。\n  - $N = 64$：精细网格，用于评估渐近行为。\n  \n答案规格和输出格式：\n- 对于每个 $N \\in \\{16, 32, 64\\}$，按顺序计算在 $\\mathbf{r}_{\\text{obs}}$ 处的电势和能量 $U$。将这些结果收集到一个单一的扁平列表中，顺序为 $[\\phi_{16}, U_{16}, \\phi_{32}, U_{32}, \\phi_{64}, U_{64}]$。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如 $[\\phi_{16},U_{16},\\phi_{32},U_{32},\\phi_{64},U_{64}]$，每个浮点数四舍五入到 $6$ 位小数。",
            "solution": "用户提供的问题已经过分析和验证。\n\n### 第一步：提取已知条件\n- **控制方程**：$-\\nabla \\cdot \\left( \\epsilon(\\mathbf{r}) \\nabla \\phi(\\mathbf{r}) \\right) = \\rho(\\mathbf{r})$，在域 $\\Omega \\subset \\mathbb{R}^2$ 中。\n- **基本关系**：$\\nabla \\cdot \\mathbf{D} = \\rho$，$\\mathbf{D} = \\epsilon(\\mathbf{r}) \\mathbf{E}$，$\\mathbf{E} = -\\nabla \\phi$。\n- **计算域**：$\\Omega = [-L,L] \\times [-L,L]$，其中 $L = 2.0$。\n- **边界条件**：在 $\\partial \\Omega$ 上为狄利克雷边界条件 $\\phi(\\mathbf{r}) = 0$。\n- **介电常数函数**：一个逐段常数函数\n  $$\\epsilon(\\mathbf{r}) = \\begin{cases}\n  \\epsilon_{\\text{in}} = 2.0,  \\|\\mathbf{r}\\|  a = 0.5 \\text{ (溶质)}\\\\\n  \\epsilon_{\\text{out}} = 80.0,  \\|\\mathbf{r}\\| \\ge a = 0.5 \\text{ (溶剂)}\n  \\end{cases}$$\n- **自由电荷密度**：一个以原点为中心的高斯分布\n  $$\\rho(\\mathbf{r}) = \\frac{q}{2\\pi \\sigma^2} \\exp\\left( - \\frac{\\|\\mathbf{r}\\|^2}{2\\sigma^2} \\right)$$\n  总电荷 $q = 1.0$，宽度参数 $\\sigma = 0.1$。\n- **离散化**：在协调三角形网格上使用线性有限元方法 (FEM)。网格由一个均匀的 $N \\times N$ 正方形网格构成，每个正方形再细分为2个三角形。\n- **公式化**：标准伽辽金方法。\n- **单元矩阵近似**：对于面积为 $A_K$、形心为 $\\mathbf{r}_c$ 的单元 $K$：\n  - 单元刚度：$K_{ij}^{(K)} = \\int_{K} \\epsilon(\\mathbf{r}) \\nabla N_i \\cdot \\nabla N_j \\, d\\mathbf{r}$，通过在 $\\mathbf{r}_c$ 处计算 $\\epsilon(\\mathbf{r})$ 来近似。\n  - 单元载荷：$f_i^{(K)} = \\int_{K} \\rho(\\mathbf{r}) N_i(\\mathbf{r}) \\, d\\mathbf{r}$，近似为 $\\rho(\\mathbf{r}_c) A_K / 3$。\n- **边界条件实现**：强施加。\n- **可观测量**：\n  1. 观测点 $\\mathbf{r}_{\\text{obs}} = (0.3, 0.0)$ 处的静电势 $\\phi(\\mathbf{r}_{\\text{obs}})$，使用最近网格节点处的值。\n  2. 静电能量 $U = \\frac{1}{2} \\int_{\\Omega} \\rho(\\mathbf{r}) \\, \\phi(\\mathbf{r}) \\, d\\mathbf{r}$，通过单元形心求积法近似。\n- **测试套件**：网格分辨率 $N \\in \\{16, 32, 64\\}$。\n\n### 第二步：使用提取的已知条件进行验证\n该问题根据验证标准进行评估：\n- **科学依据**：该问题基于泊松方程，这是静电学的基本定律，应用于标准的连续隐式溶剂模型。这在计算化学和物理学中是一种成熟且科学上合理的方法。所有参数和模型都具有物理现实性。\n- **适定性**：有界域上带有狄利克雷边界条件的泊松方程是适定椭圆型偏微分方程的经典例子，保证了唯一且稳定的解。\n- **客观性**：问题是用精确的数学和物理术语定义的，没有任何主观或模棱两可的陈述。\n- **完整性和一致性**：所有必要的数据、方程、边界条件和数值程序都得到了明确且一致的定义。指定的积分近似为数值实现提供了清晰的指令。\n\n### 第三步：结论与行动\n该问题是**有效的**。它是一个定义明确、科学合理的计算物理学任务。将制定一个完整、合理的解决方案。\n\n### 基于原理的解决方案\n\n**1. 弱形式的推导**\n\n静电势 $\\phi(\\mathbf{r})$ 的控制偏微分方程 (PDE) 是具有空间变化介电常数 $\\epsilon(\\mathbf{r})$ 的泊松方程：\n$$-\\nabla \\cdot (\\epsilon(\\mathbf{r}) \\nabla \\phi(\\mathbf{r})) = \\rho(\\mathbf{r}) \\quad \\text{for } \\mathbf{r} \\in \\Omega$$\n为了推导弱（或变分）形式，我们将 PDE 乘以一个任意的检验函数 $v(\\mathbf{r})$，并在域 $\\Omega$ 上积分：\n$$-\\int_{\\Omega} v \\, \\nabla \\cdot (\\epsilon \\nabla \\phi) \\, d\\mathbf{r} = \\int_{\\Omega} v \\rho \\, d\\mathbf{r}$$\n我们对左侧应用格林第一恒等式（一种分部积分形式）：\n$$\\int_{\\Omega} \\nabla v \\cdot (\\epsilon \\nabla \\phi) \\, d\\mathbf{r} - \\int_{\\partial\\Omega} v (\\epsilon \\nabla \\phi) \\cdot \\mathbf{n} \\, dS = \\int_{\\Omega} v \\rho \\, d\\mathbf{r}$$\n其中 $\\partial\\Omega$ 是域的边界，$\\mathbf{n}$ 是向外的单位法向量。\n问题指定了狄利克雷边界条件 $\\phi(\\mathbf{r}) = 0$ 对于 $\\mathbf{r} \\in \\partial\\Omega$。在伽辽金有限元方法中，检验函数的空间被选择为使得检验函数在指定狄利克雷条件的边界部分为零。因此，我们在 $\\partial\\Omega$ 上选择 $v=0$，这使得边界积分项消失。\n得到的弱形式是：找到一个满足狄利克雷边界条件的函数 $\\phi$，对于所有在 $\\partial\\Omega$ 上为零的合适检验函数 $v$，该函数满足\n$$ \\int_{\\Omega} \\epsilon(\\mathbf{r}) \\nabla v \\cdot \\nabla \\phi \\, d\\mathbf{r} = \\int_{\\Omega} v \\rho(\\mathbf{r}) \\, d\\mathbf{r} $$\n\n**2. 有限元离散化**\n\n将域 $\\Omega$ 离散化为不重叠的三角形单元网格。在每个单元内，未知势场 $\\phi(\\mathbf{r})$ 由基函数 $N_j(\\mathbf{r})$ 的线性组合近似：\n$$ \\phi(\\mathbf{r}) \\approx \\phi_h(\\mathbf{r}) = \\sum_{j=1}^{N_{\\text{nodes}}} \\phi_j N_j(\\mathbf{r}) $$\n其中 $N_{\\text{nodes}}$ 是网格中节点的总数，$\\phi_j$ 是节点处的未知势值，而 $N_j(\\mathbf{r})$ 是分段线性的“帽”基函数。基函数 $N_j$ 在节点 $j$ 处的值为1，在所有其他节点处为0。\n根据伽辽金方法，我们使用基函数 $N_i$ 作为检验函数，即 $v = N_i$。将此和近似 $\\phi_h$ 代入弱形式，得到一个线性代数方程组：\n$$ \\sum_{j=1}^{N_{\\text{nodes}}} \\left( \\int_{\\Omega} \\epsilon(\\mathbf{r}) \\nabla N_i \\cdot \\nabla N_j \\, d\\mathbf{r} \\right) \\phi_j = \\int_{\\Omega} N_i \\rho(\\mathbf{r}) \\, d\\mathbf{r} \\quad \\text{for } i = 1, \\dots, N_{\\text{nodes}} $$\n这可以写成矩阵形式 $K\\Phi = F$，其中：\n- $\\Phi$ 是未知节点势的列向量 $[\\phi_1, \\phi_2, \\dots]^T$。\n- $K$ 是全局刚度矩阵，其项为 $K_{ij} = \\int_{\\Omega} \\epsilon(\\mathbf{r}) \\nabla N_i \\cdot \\nabla N_j \\, d\\mathbf{r}$。\n- $F$ 是全局载荷向量，其项为 $F_i = \\int_{\\Omega} N_i \\rho(\\mathbf{r}) \\, d\\mathbf{r}$。\n\n**3. 单元矩阵和向量的推导**\n\n全局矩阵和向量由网格中每个单元 $K$ 的贡献组装而成。\n对于一个具有顶点 $(\\mathbf{r}_1, \\mathbf{r}_2, \\mathbf{r}_3)$ 的线性三角形单元，局部基函数 $N_i(\\mathbf{r})$ 是线性的，它们的梯度 $\\nabla N_i$ 在单元上是常数。设顶点 $k$ 的坐标为 $(x_k, y_k)$。梯度分量可以计算为：\n$$ \\nabla N_1 = \\frac{1}{2A_K} \\begin{pmatrix} y_2 - y_3 \\\\ x_3 - x_2 \\end{pmatrix}, \\quad \\nabla N_2 = \\frac{1}{2A_K} \\begin{pmatrix} y_3 - y_1 \\\\ x_1 - x_3 \\end{pmatrix}, \\quad \\nabla N_3 = \\frac{1}{2A_K} \\begin{pmatrix} y_1 - y_2 \\\\ x_2 - x_1 \\end{pmatrix} $$\n其中 $A_K$ 是单元的面积。令 $\\nabla N_i = [b_i, c_i]^T$。\n\n**单元刚度矩阵**\n单元 $K$ 对刚度矩阵的贡献是 $K_{ij}^{(K)} = \\int_{K} \\epsilon(\\mathbf{r}) \\nabla N_i \\cdot \\nabla N_j \\, d\\mathbf{r}$。根据问题规范，我们用其在单元形心处的值 $\\epsilon_c = \\epsilon(\\mathbf{r}_c)$ 来近似 $\\epsilon(\\mathbf{r})$。由于 $\\nabla N_i$ 在单元上是常数，我们有：\n$$ K_{ij}^{(K)} \\approx \\epsilon_c (\\nabla N_i \\cdot \\nabla N_j) \\int_{K} d\\mathbf{r} = \\epsilon_c A_K (\\nabla N_i \\cdot \\nabla N_j) = \\epsilon_c A_K (b_i b_j + c_i c_j) $$\n\n**单元载荷向量**\n单元 $K$ 对载荷向量的贡献是 $f_i^{(K)} = \\int_{K} \\rho(\\mathbf{r}) N_i(\\mathbf{r}) \\, d\\mathbf{r}$。问题指定使用 $\\rho$ 的形心值 $\\rho_c = \\rho(\\mathbf{r}_c)$ 和一个求积规则，得到：\n$$ f_i^{(K)} \\approx \\rho_c \\int_{K} N_i(\\mathbf{r}) \\, d\\mathbf{r} $$\n已知线性基函数在其三角形上的积分为 $\\frac{A_K}{3}$。因此，\n$$ f_i^{(K)} \\approx \\rho_c \\frac{A_K}{3} $$\n\n**4. 算法实现**\n\n1.  **网格生成**：对于给定的分辨率 $N$，在域 $\\Omega = [-2,2] \\times [-2,2]$ 上生成一个 $(N+1) \\times (N+1)$ 节点的网格。这会创建 $N^2$ 个方形单元。每个单元被划分为两个三角形，总共形成 $2N^2$ 个三角形单元。建立从二维网格索引到一维全局节点索引的映射。\n2.  **组装**：初始化一个稀疏全局刚度矩阵 $K$ 和一个稠密全局载荷向量 $F$ 为零。遍历每个三角形单元：\n    a. 识别其三个全局节点索引和顶点坐标。\n    b. 计算单元的面积 $A_K$ 和形心 $\\mathbf{r}_c$。\n    c. 计算 $\\epsilon_c = \\epsilon(\\mathbf{r}_c)$ 和 $\\rho_c = \\rho(\\mathbf{r}_c)$。\n    d. 使用推导出的公式计算 $3 \\times 3$ 的单元刚度矩阵 $K^{(K)}$ 和 $3 \\times 1$ 的单元载荷向量 $f^{(K)}$。\n    e. 将 $K^{(K)}$ 和 $f^{(K)}$ 的项加到全局 $K$ 和 $F$ 中的相应位置。\n3.  **边界条件**：强施加狄利克雷条件 $\\phi=0$。识别边界 $\\partial\\Omega$ 上的所有节点。对于每个边界节点索引 $k$：\n    a. 修改 $K$ 的第 $k$ 行和第 $k$ 列为零，但对角线项 $K_{kk}$ 设置为1。\n    b. 将载荷向量中的相应项 $F_k$ 设置为0。\n4.  **求解**：将组装好的稀疏矩阵 $K$ 转换为适合快速求解的格式（例如，压缩稀疏行格式）。求解线性系统 $K\\Phi = F$ 以获得节点势向量 $\\Phi$。\n5.  **后处理**：\n    a. **电势**：找到最接近 $\\mathbf{r}_{\\text{obs}} = (0.3, 0.0)$ 的网格节点，并从解向量 $\\Phi$ 中提取其计算出的电势。\n    b. **能量**：将能量积分 $U = \\frac{1}{2} \\int_{\\Omega} \\rho(\\mathbf{r}) \\phi(\\mathbf{r}) \\, d\\mathbf{r}$ 近似为所有单元上的总和。对于每个单元 $K$，其贡献为 $U_K = \\frac{1}{2} \\int_K \\rho \\phi \\, d\\mathbf{r} \\approx \\frac{1}{2} \\rho(\\mathbf{r}_c) \\phi(\\mathbf{r}_c) A_K$。形心处的电势 $\\phi(\\mathbf{r}_c)$ 从节点解中插值得到：$\\phi(\\mathbf{r}_c) = \\frac{1}{3}(\\phi_1+\\phi_2+\\phi_3)$。将所有单元的 $U_K$ 相加得到总能量 $U$。\n\n对每个指定的网格分辨率 $N \\in \\{16, 32, 64\\}$ 重复此过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.sparse import lil_matrix, csr_matrix\nfrom scipy.sparse.linalg import spsolve\n\ndef solve_fem_poisson(N, L, a, eps_in, eps_out, q, sigma, r_obs):\n    \"\"\"\n    Solves the 2D Poisson equation with spatially-varying permittivity using FEM.\n\n    Args:\n        N (int): Number of grid divisions along one axis.\n        L (float): Half-width of the square domain [-L, L] x [-L, L].\n        a (float): Radius of the inner solute disk.\n        eps_in (float): Permittivity inside the solute.\n        eps_out (float): Permittivity outside the solute.\n        q (float): Total charge of the Gaussian distribution.\n        sigma (float): Width of the Gaussian charge distribution.\n        r_obs (tuple): Coordinates (x, y) of the observation point.\n\n    Returns:\n        tuple: A tuple containing:\n            - potential_at_obs (float): The calculated potential at the nearest node to r_obs.\n            - U (float): The total electrostatic energy.\n    \"\"\"\n    # 1. Mesh Generation\n    n_pts_axis = N + 1\n    h = 2.0 * L / N\n    nodes = np.array([[-L + i * h, -L + j * h] for j in range(n_pts_axis) for i in range(n_pts_axis)])\n    num_nodes = n_pts_axis * n_pts_axis\n\n    triangles = []\n    for j in range(N):\n        for i in range(N):\n            p00 = j * n_pts_axis + i\n            p10 = j * n_pts_axis + (i + 1)\n            p01 = (j + 1) * n_pts_axis + i\n            p11 = (j + 1) * n_pts_axis + (i + 1)\n            triangles.append((p00, p10, p11))\n            triangles.append((p00, p11, p01))\n\n    # 2. Assembly\n    K = lil_matrix((num_nodes, num_nodes))\n    F = np.zeros(num_nodes)\n    \n    def epsilon(r):\n        return eps_in if np.linalg.norm(r)  a else eps_out\n\n    def rho(r):\n        norm_sq = r[0]**2 + r[1]**2\n        return (q / (2.0 * np.pi * sigma**2)) * np.exp(-norm_sq / (2.0 * sigma**2))\n\n    for tri_nodes_indices in triangles:\n        p1_idx, p2_idx, p3_idx = tri_nodes_indices\n        p1, p2, p3 = nodes[p1_idx], nodes[p2_idx], nodes[p3_idx]\n        \n        area = 0.5 * abs(p1[0]*(p2[1]-p3[1]) + p2[0]*(p3[1]-p1[1]) + p3[0]*(p1[1]-p2[1]))\n        if area  1e-15: continue\n\n        centroid = (p1 + p2 + p3) / 3.0\n        eps_c = epsilon(centroid)\n        rho_c = rho(centroid)\n\n        b = np.array([p2[1] - p3[1], p3[1] - p1[1], p1[1] - p2[1]]) / (2.0 * area)\n        c = np.array([p3[0] - p2[0], p1[0] - p3[0], p2[0] - p1[0]]) / (2.0 * area)\n\n        K_elem = np.zeros((3, 3))\n        for i in range(3):\n            for j in range(3):\n                K_elem[i, j] = eps_c * (b[i] * b[j] + c[i] * c[j]) * area\n        \n        F_elem = np.full(3, rho_c * area / 3.0)\n\n        indices = [p1_idx, p2_idx, p3_idx]\n        for i in range(3):\n            F[indices[i]] += F_elem[i]\n            for j in range(3):\n                K[indices[i], indices[j]] += K_elem[i, j]\n\n    # 3. Boundary Conditions (Strong Enforcement for phi=0)\n    boundary_nodes = set()\n    for j in range(n_pts_axis):\n        for i in range(n_pts_axis):\n            if i == 0 or i == N or j == 0 or j == N:\n                boundary_nodes.add(j * n_pts_axis + i)\n\n    for idx in boundary_nodes:\n        K[idx, :] = 0.0\n        K[:, idx] = 0.0\n        K[idx, idx] = 1.0\n        F[idx] = 0.0\n    \n    # 4. Solve\n    K_csr = K.tocsr()\n    phi_sol = spsolve(K_csr, F)\n\n    # 5. Post-processing\n    # Potential at r_obs\n    i_obs = int(round((r_obs[0] + L) / h))\n    j_obs = int(round((r_obs[1] + L) / h))\n    idx_obs = j_obs * n_pts_axis + i_obs\n    potential_at_obs = phi_sol[idx_obs]\n\n    # Electrostatic energy U\n    U = 0.0\n    for tri_nodes_indices in triangles:\n        p1_idx, p2_idx, p3_idx = tri_nodes_indices\n        p1, p2, p3 = nodes[p1_idx], nodes[p2_idx], nodes[p3_idx]\n        \n        area = 0.5 * abs(p1[0]*(p2[1]-p3[1]) + p2[0]*(p3[1]-p1[1]) + p3[0]*(p1[1]-p2[1]))\n        if area  1e-15: continue\n        \n        centroid = (p1 + p2 + p3) / 3.0\n        rho_c = rho(centroid)\n        \n        phi_1, phi_2, phi_3 = phi_sol[p1_idx], phi_sol[p2_idx], phi_sol[p3_idx]\n        phi_c = (phi_1 + phi_2 + phi_3) / 3.0\n        \n        U += 0.5 * rho_c * phi_c * area\n    \n    return potential_at_obs, U\n\ndef solve():\n    \"\"\"\n    Main function to run the FEM simulation for the specified test cases.\n    \"\"\"\n    # Define the problem parameters\n    L = 2.0\n    a = 0.5\n    eps_in = 2.0\n    eps_out = 80.0\n    q = 1.0\n    sigma = 0.1\n    r_obs = (0.3, 0.0)\n\n    # Define the test cases from the problem statement.\n    test_cases = [16, 32, 64]\n\n    raw_results = []\n    for N in test_cases:\n        potential, energy = solve_fem_poisson(N, L, a, eps_in, eps_out, q, sigma, r_obs)\n        raw_results.append(potential)\n        raw_results.append(energy)\n\n    # Final print statement in the exact required format.\n    formatted_results = [f\"{x:.6f}\" for x in raw_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "总溶剂化自由能不仅包含静电相互作用，还包括非极性贡献，如范德华力（特别是色散力）和溶剂空腔的形成。这个练习  聚焦于非极性部分，要求您实现并比较两种主流模型：一种是基于物理的色散积分模型，另一种是经验性的溶剂可及表面积（SASA）模型。通过分析它们在处理不同粗糙度表面时的表现，您将洞察不同模型的物理假设及其适用范围，这是精确模拟界面的关键。",
            "id": "3899810",
            "problem": "要求您设计并实现一个程序，该程序从适用于计算催化和化学工程的第一性原理出发，比较两种在液-固界面处针对波纹状溶质表面的隐式溶剂非极性自由能模型。该比较侧重于溶质粗糙度（波纹振幅和波长）如何影响预测的非极性贡献。这两种模型是：一种仅考虑色散的、对成对吸引力进行的连续介质积分模型，以及一种基于溶剂可及表面积（SASA）的线性表面张力模型。连续介质液体是一个占据所有 $z  0$ 位置的半无限半空间，溶质由 $z=0$ 平面上方的一个高度场 $z(x,y)$ 定义的粗糙表面片表示。所有长度必须以纳米（nm）为单位，所有能量必须以千焦每摩尔（kJ/mol）为单位。\n\n使用的基本原理和定义：\n- 溶质位点和溶剂位点之间的成对伦敦色散势为 $u(r) = -C_6 r^{-6}$，其中 $C_6  0$，$r$ 为中心到中心的距离。\n- 溶剂被隐式地表示为一个数密度为 $\\rho$（单位体积内的溶剂位点数）的均匀连续介质。\n- 溶质表面带有一个均匀的位点密度 $\\sigma_s$（单位面积内的溶质位点数）。\n- 基于溶剂可及表面积（SASA）的非极性自由能由 $G_\\mathrm{np}^{\\mathrm{SASA}} = \\gamma A$ 建模，其中 $\\gamma$ 是一个类似表面张力的系数，$A$ 是溶剂可及的表面积。\n- 对于溶质几何形状，使用一个在矩形域 $[0,L_x] \\times [0,L_y]$ 上定义的波纹，其高度场为 $z(x,y) = h + A \\cos(k_x x)\\cos(k_y y)$，其中 $h$ 是平均高度（与液体平面的平均距离），$A$ 是波纹振幅，$k_x = 2\\pi/\\lambda_x$ 和 $k_y = 2\\pi/\\lambda_y$ 是由波纹波长 $\\lambda_x$ 和 $\\lambda_y$ 设定的波数。\n- 为保持物理真实性并避免色散积分在近接触时发散，施加一个下限截断距离 $d_\\mathrm{cut}$，并在计算局部距离 $d(x,y) = z(x,y)$ 时，将其替换为 $d_\\mathrm{eff}(x,y) = \\max(d(x,y), d_\\mathrm{cut})$。\n\n您的任务：\n1. 从 $u(r) = -C_6 r^{-6}$ 和溶剂半空间的连续介质表示出发，为一个位点密度为 $\\sigma_s$ 的延展溶质表面推导仅考虑色散的非极性贡献。您必须先对溶剂半空间进行积分，然后对溶质表面片进行积分。推导过程不得假定任何预设的目标公式；必须从基本对势开始，推导出一个可用于数值实现的积分表达式。\n2. 从 $G_\\mathrm{np}^{\\mathrm{SASA}} = \\gamma A$ 及 $A = \\int \\sqrt{1 + |\\nabla z|^2}\\,\\mathrm{d}x\\,\\mathrm{d}y$ 出发，为给定的 $z(x,y)$ 构建一个计算 $A$ 的数值方法。\n3. 通过将域离散化为一个 $N_x \\times N_y$ 点的均匀网格，对两种模型进行数值实现。使用面积元 $\\mathrm{d}A = \\sqrt{1 + |\\nabla z|^2}\\,\\mathrm{d}x\\,\\mathrm{d}y$，其中 $\\nabla z = (\\partial z/\\partial x, \\partial z/\\partial y)$。\n4. 对下面的每个测试用例，计算三个输出：仅考虑色散的非极性能量 $G_\\mathrm{np}^{\\mathrm{disp}}$（单位 kJ/mol），基于SASA的非极性能量 $G_\\mathrm{np}^{\\mathrm{SASA}}$（单位 kJ/mol），以及比率 $r = |G_\\mathrm{np}^{\\mathrm{disp}}| / G_\\mathrm{np}^{\\mathrm{SASA}}$（浮点数形式）。所有能量以 kJ/mol 为单位表示，四舍五入到六位小数，比率以浮点数形式表示，四舍五入到六位小数。\n\n所有测试用例中使用的物理和数值常数：\n- 溶剂数密度：$\\rho = 33.3$ nm$^{-3}$。\n- 溶质位点密度：$\\sigma_s = 38.2$ nm$^{-2}$。\n- 使用 Lorentz-Berthelot 混合规则组合溶质碳（C）和溶剂氧（O）的 Lennard-Jones (LJ) 参数：\n  - 碳：$\\epsilon_\\mathrm{C} = 0.276$ kJ/mol, $\\sigma_\\mathrm{C} = 0.340$ nm。\n  - 氧：$\\epsilon_\\mathrm{O} = 0.650$ kJ/mol, $\\sigma_\\mathrm{O} = 0.316$ nm。\n  - 混合：$\\epsilon = \\sqrt{\\epsilon_\\mathrm{C} \\epsilon_\\mathrm{O}}$, $\\sigma = (\\sigma_\\mathrm{C} + \\sigma_\\mathrm{O})/2$。\n  - 吸引系数：$C_6 = 4 \\epsilon \\sigma^6$。\n- SASA 系数：$\\gamma = 2.30$ kJ/mol/nm$^{2}$。\n- 下限截断距离：$d_\\mathrm{cut} = 0.28$ nm。\n- 域大小：$L_x = 5.0$ nm, $L_y = 5.0$ nm。\n- 网格分辨率：$N_x = 400$, $N_y = 400$。\n\n测试套件（每个用例为 $(h, A, \\lambda_x, \\lambda_y)$，所有长度单位为 nm）：\n- 用例 1（正常路径）：$h = 0.50$, $A = 0.05$, $\\lambda_x = 1.00$, $\\lambda_y = 1.00$。\n- 用例 2（平坦边界条件）：$h = 0.50$, $A = 0.00$, $\\lambda_x = 1.00$, $\\lambda_y = 1.00$。\n- 用例 3（接近截断距离的大振幅）：$h = 0.50$, $A = 0.20$, $\\lambda_x = 1.00$, $\\lambda_y = 1.00$。\n- 用例 4（远距离边缘情况）：$h = 1.50$, $A = 0.05$, $\\lambda_x = 1.00$, $\\lambda_y = 1.00$。\n- 用例 5（高频粗糙度）：$h = 0.50$, $A = 0.05$, $\\lambda_x = 0.50$, $\\lambda_y = 0.25$。\n\n输出规范：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的、逗号分隔的结果列表，每个用例的结果是一个三元素列表 $[G_\\mathrm{np}^{\\mathrm{disp}}, G_\\mathrm{np}^{\\mathrm{SASA}}, r]$，每个浮点数四舍五入到六位小数，并按照用例 1 到 5 的顺序排列。例如，打印的字符串必须类似于 $[[x_1,y_1,z_1],[x_2,y_2,z_2],\\dots]$，不含任何额外文本。",
            "solution": "该问题是有效的，因为它具有科学依据、提法明确且客观。它提供了一套完整且一致的定义、常数和任务，适合在计算化学工程领域内进行正式求解。我们将进行推导和数值实现。\n\n目标是比较在液-固界面处的两种非极性溶剂化自由能模型。这两种模型分别是仅考虑色散的连续介质积分模型和基于溶剂可及表面積（SASA）的模型。该比较是针对具有特定波纹的溶质表面进行的。\n\n首先，我们根据所提供的参数计算必要的物理常数。溶质-溶剂相互作用使用 Lennard-Jones 参数的 Lorentz-Berthelot 混合规则进行建模。\n给定溶质碳（C）参数 $\\epsilon_\\mathrm{C} = 0.276$ kJ/mol 和 $\\sigma_\\mathrm{C} = 0.340$ nm，以及溶剂氧（O）参数 $\\epsilon_\\mathrm{O} = 0.650$ kJ/mol 和 $\\sigma_\\mathrm{O} = 0.316$ nm，混合参数为：\n$$ \\epsilon = \\sqrt{\\epsilon_\\mathrm{C} \\epsilon_\\mathrm{O}} = \\sqrt{(0.276)(0.650)} \\approx 0.423556 \\text{ kJ/mol} $$\n$$ \\sigma = \\frac{\\sigma_\\mathrm{C} + \\sigma_\\mathrm{O}}{2} = \\frac{0.340 + 0.316}{2} = 0.328 \\text{ nm} $$\n吸引色散系数 $C_6$ 源自 Lennard-Jones 势 $U_{LJ}(r) = 4\\epsilon[(\\sigma/r)^{12} - (\\sigma/r)^6]$，其中吸引项为 $-4\\epsilon\\sigma^6 r^{-6}$。因此，$C_6 = 4\\epsilon\\sigma^6$。\n$$ C_6 = 4 \\epsilon \\sigma^6 = 4 (0.423556) (0.328)^6 \\approx 0.00211116 \\text{ kJ/mol} \\cdot \\text{nm}^6 $$\n\n**1. 仅考虑色散的能量（$G_\\mathrm{np}^{\\mathrm{disp}}$）的推导**\n\n此推导分两步进行：首先，计算单个溶质位点与整个溶剂连续介质的相互作用能；其次，将该位点-连续介质能量在整个溶质表面上积分。\n\n**步骤 1.1：单个溶质位点与溶剂半空间的相互作用**\n设单个溶质位点位于位置 $\\mathbf{r}_s = (x_s, y_s, z_s)$，其中 $z_s  0$。溶剂是占据半空间 $z'  0$、数密度均匀为 $\\rho$ 的连续介质。溶质位点与位于位置 $\\mathbf{r}'$ 的溶剂微元体积 $\\mathrm{d}V'$ 之间的相互作用势由成对伦敦色散势 $u(r) = -C_6 r^{-6}$ 给出，其中 $r = |\\mathbf{r}_s - \\mathbf{r}'|$。\n\n溶质位点与整个溶剂半空间的总相互作用能 $U_\\text{site}$，通过对所有溶剂体积元的贡献进行积分得到：\n$$ U_\\text{site}(z_s) = \\int_{\\text{solvent}} \\rho \\, u(|\\mathbf{r}_s - \\mathbf{r}'|) \\, \\mathrm{d}V' = \\int_{-\\infty}^{0} \\int_{-\\infty}^{\\infty} \\int_{-\\infty}^{\\infty} \\rho (-C_6) \\left((x_s-x')^2 + (y_s-y')^2 + (z_s-z')^2\\right)^{-3} \\mathrm{d}x' \\mathrm{d}y' \\mathrm{d}z' $$\n我们转换为以 $(x_s, y_s, z')$ 为中心的柱坐标 $(\\tilde{r}, \\theta, z')$ 来对 $x'y'$ 平面进行积分。令 $\\tilde{r}^2 = (x_s-x')^2 + (y_s-y')^2$。体积元变为 $\\mathrm{d}x' \\mathrm{d}y' = \\tilde{r} \\, \\mathrm{d}\\tilde{r} \\, \\mathrm{d}\\theta$。\n$$ U_\\text{site}(z_s) = - \\rho C_6 \\int_{-\\infty}^{0} \\left( \\int_{0}^{2\\pi} \\mathrm{d}\\theta \\int_{0}^{\\infty} \\frac{\\tilde{r}}{(\\tilde{r}^2 + (z_s-z')^2)^3} \\, \\mathrm{d}\\tilde{r} \\right) \\mathrm{d}z' $$\n对 $\\theta$ 的积分得到 $2\\pi$。对 $\\tilde{r}$ 的积分为：\n$$ \\int_{0}^{\\infty} \\frac{\\tilde{r}}{(\\tilde{r}^2 + (z_s-z')^2)^3} \\, \\mathrm{d}\\tilde{r} = \\frac{1}{2} \\int_{(z_s-z')^2}^{\\infty} w^{-3} \\, \\mathrm{d}w = \\frac{1}{2} \\left[ -\\frac{1}{2} w^{-2} \\right]_{(z_s-z')^2}^{\\infty} = \\frac{1}{4(z_s-z')^4} $$\n将其代回，我们得到：\n$$ U_\\text{site}(z_s) = - \\rho C_6 (2\\pi) \\int_{-\\infty}^{0} \\frac{1}{4(z_s-z')^4} \\, \\mathrm{d}z' = -\\frac{\\pi \\rho C_6}{2} \\int_{-\\infty}^{0} (z_s-z')^{-4} \\, \\mathrm{d}z' $$\n最后关于 $z'$ 的积分计算结果为：\n$$ \\int_{-\\infty}^{0} (z_s-z')^{-4} \\, \\mathrm{d}z' = \\left[ \\frac{1}{3} (z_s-z')^{-3} \\right]_{-\\infty}^{0} = \\frac{1}{3} z_s^{-3} $$\n因此，位于溶剂平面上方高度 $z_s$ 处的单个溶质位点的相互作用能为：\n$$ U_\\text{site}(z_s) = -\\frac{\\pi \\rho C_6}{6 z_s^3} $$\n\n**步骤 1.2：在波纹状溶质表面上积分**\n溶质是一个位点密度均匀为 $\\sigma_s$ 的表面片。在微分表面积元 $\\mathrm{d}S$ 中的位点数为 $\\sigma_s \\mathrm{d}S$。总色散能 $G_\\mathrm{np}^{\\mathrm{disp}}$ 是表面上所有位点能量的总和。表面的高度由 $z(x,y) = h + A \\cos(k_x x)\\cos(k_y y)$ 给出。\n$$ G_\\mathrm{np}^{\\mathrm{disp}} = \\int_{\\text{surface}} \\sigma_s U_\\text{site}(z(x,y)) \\, \\mathrm{d}S $$\n表面积元 $\\mathrm{d}S$ 与投影面积元 $\\mathrm{d}x \\mathrm{d}y$ 的关系为 $\\mathrm{d}S = \\sqrt{1 + |\\nabla z|^2} \\, \\mathrm{d}x \\mathrm{d}y$。为避免在小距离处发散，局部距离 $z(x,y)$ 被替换为有效距离 $d_\\mathrm{eff}(x,y) = \\max(z(x,y), d_\\mathrm{cut})$。\n代入 $U_\\text{site}$ 和 $\\mathrm{d}S$ 的表达式，我们得到在域 $[0, L_x] \\times [0, L_y]$ 上的总能量积分为：\n$$ G_\\mathrm{np}^{\\mathrm{disp}} = \\int_{0}^{L_y} \\int_{0}^{L_x} \\left( \\sigma_s \\left( -\\frac{\\pi \\rho C_6}{6 [\\max(z(x,y), d_\\mathrm{cut})]^3} \\right) \\right) \\sqrt{1 + |\\nabla z|^2} \\, \\mathrm{d}x \\mathrm{d}y $$\n我们定义一个常数前置因子 $E_0 = -\\frac{\\pi \\rho \\sigma_s C_6}{6}$。最终表达式为：\n$$ G_\\mathrm{np}^{\\mathrm{disp}} = E_0 \\int_{0}^{L_y} \\int_{0}^{L_x} \\frac{\\sqrt{1 + |\\nabla z(x,y)|^2}}{[\\max(z(x,y), d_\\mathrm{cut})]^3} \\, \\mathrm{d}x \\mathrm{d}y $$\n其中 $|\\nabla z|^2 = (\\partial z/\\partial x)^2 + (\\partial z/\\partial y)^2$。对于 $z(x,y) = h + A \\cos(k_x x)\\cos(k_y y)$：\n$$ \\frac{\\partial z}{\\partial x} = -A k_x \\sin(k_x x)\\cos(k_y y) \\quad \\text{和} \\quad \\frac{\\partial z}{\\partial y} = -A k_y \\cos(k_x x)\\sin(k_y y) $$\n该二重积分通过离散网格求和进行数值计算。\n\n**2. 基于 SASA 的能量（$G_\\mathrm{np}^{\\mathrm{SASA}}$）的构建**\n\n该模型更简单，由公式 $G_\\mathrm{np}^{\\mathrm{SASA}} = \\gamma A$ 定义，其中 $\\gamma$ 是表面张力系数，$A$ 是溶剂可及表面积。问题指定 $A$ 应计算为溶质表面的几何面积：\n$$ A = \\int_{0}^{L_y} \\int_{0}^{L_x} \\mathrm{d}S = \\int_{0}^{L_y} \\int_{0}^{L_x} \\sqrt{1 + |\\nabla z(x,y)|^2} \\, \\mathrm{d}x \\mathrm{d}y $$\n该积分也在与色散计算相同的网格上进行数值评估。\n\n**3. 数值实现**\n\n$G_\\mathrm{np}^{\\mathrm{disp}}$ 和 $A$ 的积分通过在 $N_x \\times N_y$ 个点的均匀网格上求和来近似。设 $\\Delta x = L_x / N_x$ 和 $\\Delta y = L_y / N_y$。网格点为 $(x_i, y_j)$，其中 $x_i = (i+0.5)\\Delta x$ (对于 $i \\in [0, N_x-1]$) 且 $y_j = (j+0.5)\\Delta y$ (对于 $j \\in [0, N_y-1]$)。\n\n表面积 $A$ 近似为：\n$$ A \\approx \\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} \\sqrt{1 + |\\nabla z(x_i, y_j)|^2} \\, \\Delta x \\Delta y $$\n那么基于 SASA 的能量为 $G_\\mathrm{np}^{\\mathrm{SASA}} = \\gamma A$。\n\n色散能近似为：\n$$ G_\\mathrm{np}^{\\mathrm{disp}} \\approx E_0 \\sum_{j=0}^{N_y-1} \\sum_{i=0}^{N_x-1} \\frac{\\sqrt{1 + |\\nabla z(x_i, y_j)|^2}}{[\\max(z(x_i, y_j), d_\\mathrm{cut})]^3} \\, \\Delta x \\Delta y $$\n\n最后，比率 $r$ 计算为 $r = |G_\\mathrm{np}^{\\mathrm{disp}}| / G_\\mathrm{np}^{\\mathrm{SASA}}$。Python 中的数值实现将对每个指定的测试用例遵循此过程。对于振幅 $A=0$ 的特殊情况，表面是平坦的，$|\\nabla z|^2 = 0$，积分简化为解析表达式，这提供了一个有用的检验。在这种情况下，$A = L_x L_y$ 且 $G_\\mathrm{np}^{\\mathrm{disp}} = E_0 L_x L_y / [\\max(h, d_\\mathrm{cut})]^3$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes and compares two nonpolar solvation free energy models\n    at a liquid-solid interface for a corrugated solute surface.\n    \"\"\"\n\n    # Physical and numerical constants\n    RHO = 33.3  # Solvent number density (nm^-3)\n    SIGMA_S = 38.2  # Solute site density (nm^-2)\n    \n    # Lennard-Jones parameters\n    EPS_C = 0.276  # kJ/mol\n    SIGMA_C = 0.340  # nm\n    EPS_O = 0.650  # kJ/mol\n    SIGMA_O = 0.316  # nm\n\n    # Lorentz-Berthelot mixing rules\n    epsilon = np.sqrt(EPS_C * EPS_O)\n    sigma = (SIGMA_C + SIGMA_O) / 2.0\n    \n    # Attractive coefficient C6\n    c6 = 4.0 * epsilon * sigma**6  # kJ/mol * nm^6\n\n    # Prefactor for dispersion energy calculation\n    E0 = - (np.pi * RHO * SIGMA_S * c6) / 6.0  # kJ/mol\n\n    # SASA model coefficient\n    GAMMA = 2.30  # kJ/mol/nm^2\n\n    # Physical cutoff distance\n    D_CUT = 0.28  # nm\n\n    # Domain size and grid resolution\n    LX, LY = 5.0, 5.0  # nm\n    NX, NY = 400, 400\n\n    # Grid spacing\n    dx = LX / NX\n    dy = LY / NY\n    da = dx * dy  # Area element\n\n    # Test suite: (h, A, lambda_x, lambda_y) in nm\n    test_cases = [\n        (0.50, 0.05, 1.00, 1.00),  # Case 1\n        (0.50, 0.00, 1.00, 1.00),  # Case 2\n        (0.50, 0.20, 1.00, 1.00),  # Case 3\n        (1.50, 0.05, 1.00, 1.00),  # Case 4\n        (0.50, 0.05, 0.50, 0.25),  # Case 5\n    ]\n\n    results = []\n    \n    # Create grid coordinates (midpoint rule for better accuracy)\n    x_vals = (np.arange(NX) + 0.5) * dx\n    y_vals = (np.arange(NY) + 0.5) * dy\n    xx, yy = np.meshgrid(x_vals, y_vals)\n\n    for h, A, lambda_x, lambda_y in test_cases:\n        \n        # Handle the flat surface (A=0) case analytically\n        if A == 0.0:\n            area = LX * LY\n            g_sasa = GAMMA * area\n            d_eff = np.maximum(h, D_CUT)\n            g_disp = E0 * area / (d_eff**3)\n            ratio = np.abs(g_disp) / g_sasa\n            results.append([round(g_disp, 6), round(g_sasa, 6), round(ratio, 6)])\n            continue\n\n        # Wavenumbers\n        kx = 2.0 * np.pi / lambda_x\n        ky = 2.0 * np.pi / lambda_y\n\n        # Surface height field z(x,y)\n        z = h + A * np.cos(kx * xx) * np.cos(ky * yy)\n        \n        # Gradients dz/dx and dz/dy\n        dz_dx = -A * kx * np.sin(kx * xx) * np.cos(ky * yy)\n        dz_dy = -A * ky * np.cos(kx * xx) * np.sin(ky * yy)\n        \n        # Surface area element factor\n        area_factor = np.sqrt(1.0 + dz_dx**2 + dz_dy**2)\n        \n        # Total surface area A\n        area = np.sum(area_factor) * da\n        \n        # SASA-based energy\n        g_sasa = GAMMA * area\n        \n        # Effective distance with cutoff\n        d_eff = np.maximum(z, D_CUT)\n        \n        # Integrand for dispersion energy\n        integrand_disp = area_factor / (d_eff**3)\n        \n        # Dispersion energy\n        g_disp = E0 * np.sum(integrand_disp) * da\n        \n        # Ratio\n        ratio = np.abs(g_disp) / g_sasa\n        \n        results.append([round(g_disp, 6), round(g_sasa, 6), round(ratio, 6)])\n\n    # Format the final output string\n    output_str = \"[\" + \",\".join([f\"[{d:.6f},{s:.6f},{r:.6f}]\" for d, s, r in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```"
        },
        {
            "introduction": "计算总溶剂化自由能的现代方法通常依赖于“炼金术”路径，即在一个模拟过程中逐步“开启”或“关闭”溶质与溶剂之间的相互作用。本实践  让您亲身体验热力学积分（TI）这一强大的自由能计算技术。您将通过对给定的能量导数函数进行数值积分，模拟一个包含库仑和范德华等多步骤的炼金术过程，并学习如何评估计算的可靠性，例如分析路径的迟滞效应和循环闭合差。",
            "id": "3899799",
            "problem": "要求您使用热力学积分 (TI) 和软核库仑耦合参数计算离子的溶剂化自由能，然后评估三步炼金路径中的滞后和循环闭合。科学基础必须与 TI 的基本框架一致。该计算是在理想化但科学上合理的模型和常数下构建的，允许在单个程序中进行确定性的数值积分。\n\n从以下基础出发：\n\n1. 热力学积分 (TI) 定义：沿着耦合参数路径的自由能变化由以下积分给出\n$$\n\\Delta G = \\int_{0}^{1} \\left\\langle \\frac{\\partial U(\\lambda)}{\\partial \\lambda} \\right\\rangle_{\\lambda} \\, d\\lambda,\n$$\n其中 $U(\\lambda)$ 是依赖于耦合参数 $\\lambda$ 的势能，而 $\\langle \\cdot \\rangle_{\\lambda}$ 表示在固定 $\\lambda$ 下的系综平均。反向路径的反向积分遵循\n$$\n\\Delta G_{\\text{backward}} = -\\int_{0}^{1} \\left\\langle \\frac{\\partial U_{\\text{back}}(\\lambda)}{\\partial \\lambda} \\right\\rangle_{\\lambda} \\, d\\lambda,\n$$\n因此，在没有采样误差的情况下，正向和反向路径之和为零。\n\n2. 对于价态为 $z$、半径为 $r$、溶剂介电常数为 $\\varepsilon_{r}$ 的离子的库仑贡献，其 Born 溶剂化模型由 Born 自由能给出\n$$\n\\Delta G_{\\text{Born}} = -\\frac{N_{\\mathrm{A}}}{8\\pi \\varepsilon_{0}} \\frac{(z e)^{2}}{r}\\left(1 - \\frac{1}{\\varepsilon_{r}}\\right),\n$$\n单位为焦耳/摩尔，其中 $N_{\\mathrm{A}}$ 是阿伏伽德罗常数，$\\varepsilon_{0}$ 是真空介电常数，$e$ 是元电荷。在您的计算中，此值将被转换为千焦/摩尔 ($\\mathrm{kJ/mol}$)。为模拟软核库仑耦合，库仑步骤的系综平均导数将建模为\n$$\n\\left\\langle \\frac{\\partial U_{\\text{coul}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = A \\frac{\\lambda}{\\sqrt{1 + \\alpha_{\\text{c}}(1 - \\lambda)^{2}}},\n$$\n其中 $A = 2\\,\\Delta G_{\\text{Born}}$，以便在极限 $\\alpha_{\\text{c}} = 0$ 时，该积分重现 $\\Delta G_{\\text{Born}}$。\n\n3. 范德华（色散）步骤由一个系综平均导数函数建模\n$$\n\\left\\langle \\frac{\\partial U_{\\text{vdW}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = B \\frac{3\\lambda^{2}}{1 + \\alpha_{\\text{LJ}}(1 - \\lambda)^{2}},\n$$\n其中 $B$ 是一个以 $\\mathrm{kJ/mol}$ 为单位的指定振幅，当 $\\alpha_{\\text{LJ}} = 0$ 时，它等于色散贡献，而 $\\alpha_{\\text{LJ}} \\ge 0$ 是一个 Lennard-Jones 类型的软核参数。\n\n4. 约束或空腔校正步骤建模为一个常数导数\n$$\n\\left\\langle \\frac{\\partial U_{\\text{rest}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = C,\n$$\n其中 $C$ 的单位为 $\\mathrm{kJ/mol}$。\n\n为评估滞后，反向路径的系综平均导数定义为正向导数加上一个依赖于 $\\lambda$ 的偏置，旨在反映采样误差。具体来说，对于步骤 $i \\in \\{\\text{coul}, \\text{vdW}, \\text{rest}\\}$，\n$$\n\\left\\langle \\frac{\\partial U_{i,\\text{back}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = \\left\\langle \\frac{\\partial U_{i,\\text{fwd}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} + \\delta_{i}\\,\\sin(\\pi \\lambda),\n$$\n其中 $\\delta_{i}$ 是以 $\\mathrm{kJ/mol}$ 为单位的指定滞后振幅，并且根据 TI 基础，反向自由能的积分符号是反转的。\n\n必须使用复合辛普森法则在具有奇数个点 $N$ 的均匀间隔网格上对 $\\lambda \\in [0,1]$ 进行数值积分，以确保该法则的正确应用，\n$$\n\\int_{0}^{1} f(\\lambda)\\,d\\lambda \\approx \\frac{h}{3}\\left[f_{0} + f_{N-1} + 4\\sum_{j=1,3,\\ldots,N-2} f_{j} + 2\\sum_{j=2,4,\\ldots,N-3} f_{j}\\right],\n$$\n其中 $h = \\frac{1}{N-1}$ 且 $f_{j} = f(\\lambda_{j})$。\n\n您的任务：\n\n- 对于下面提供的每个测试用例，计算三个步骤的正向自由能贡献，并将它们相加以获得总的正向溶剂化自由能，\n$$\n\\Delta G_{\\text{total,fwd}} = \\Delta G_{\\text{coul,fwd}} + \\Delta G_{\\text{vdW,fwd}} + \\Delta G_{\\text{rest,fwd}}.\n$$\n- 使用带偏置的反向导数和反转的积分定义计算反向贡献，以获得\n$$\n\\Delta G_{\\text{total,back}} = \\Delta G_{\\text{coul,back}} + \\Delta G_{\\text{vdW,back}} + \\Delta G_{\\text{rest,back}}.\n$$\n- 对每个步骤，按如下方式计算滞后\n$$\nH_{i} = \\Delta G_{i,\\text{fwd}} + \\Delta G_{i,\\text{back}},\n$$\n并报告最大绝对步骤滞后\n$$\nH_{\\max} = \\max\\left(|H_{\\text{coul}}|, |H_{\\text{vdW}}|, |H_{\\text{rest}}|\\right).\n$$\n- 按如下方式计算三步路径的循环闭合度量\n$$\n\\Xi = \\Delta G_{\\text{total,fwd}} + \\Delta G_{\\text{total,back}},\n$$\n在没有采样误差的理想可逆极限下，该值将为 $0$。\n\n所有自由能必须以千焦/摩尔 ($\\mathrm{kJ/mol}$) 表示。使用以下物理常数：阿伏伽德罗常数 $N_{\\mathrm{A}} = 6.02214076\\times 10^{23}\\,\\mathrm{mol^{-1}}$，真空介电常数 $\\varepsilon_{0} = 8.8541878128\\times 10^{-12}\\,\\mathrm{F/m}$，元电荷 $e = 1.602176634\\times 10^{-19}\\,\\mathrm{C}$，以及库仑常数 $k_{\\mathrm{e}} = \\frac{1}{4\\pi \\varepsilon_{0}}$。离子半径以埃为单位给出，必须转换为米，其中 $1\\,\\text{\\AA} = 10^{-10}\\,\\mathrm{m}$。\n\n测试套件参数集：\n\n- 案例 1 (正常路径):\n  - 离子价态 $z = +1$，离子半径 $r = 1.9\\,\\text{\\AA}$，溶剂介电常数 $\\varepsilon_{r} = 78.3$。\n  - 库仑软核参数 $\\alpha_{\\text{c}} = 0.5$。\n  - 范德华振幅 $B = 8.0\\,\\mathrm{kJ/mol}$ 和 $\\alpha_{\\text{LJ}} = 0.2$。\n  - 约束振幅 $C = 1.5\\,\\mathrm{kJ/mol}$。\n  - 滞后振幅 $\\delta_{\\text{coul}} = 0.5\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{vdW}} = 0.2\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{rest}} = 0.05\\,\\mathrm{kJ/mol}$。\n  - 网格点数 $N = 101$。\n\n- 案例 2 (无软核和无滞后的边界情况):\n  - 离子价态 $z = -1$，离子半径 $r = 2.05\\,\\text{\\AA}$，溶剂介电常数 $\\varepsilon_{r} = 78.3$。\n  - 库仑软核参数 $\\alpha_{\\text{c}} = 0$。\n  - 范德华振幅 $B = 6.0\\,\\mathrm{kJ/mol}$ 和 $\\alpha_{\\text{LJ}} = 0$。\n  - 约束振幅 $C = 1.0\\,\\mathrm{kJ/mol}$。\n  - 滞后振幅 $\\delta_{\\text{coul}} = 0.0\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{vdW}} = 0.0\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{rest}} = 0.0\\,\\mathrm{kJ/mol}$。\n  - 网格点数 $N = 101$。\n\n- 案例 3 (强软核和显著滞后的边缘情况):\n  - 离子价态 $z = +2$，离子半径 $r = 0.72\\,\\text{\\AA}$，溶剂介电常数 $\\varepsilon_{r} = 78.3$。\n  - 库仑软核参数 $\\alpha_{\\text{c}} = 3.0$。\n  - 范德华振幅 $B = 12.0\\,\\mathrm{kJ/mol}$ 和 $\\alpha_{\\text{LJ}} = 0.5$。\n  - 约束振幅 $C = 2.0\\,\\mathrm{kJ/mol}$。\n  - 滞后振幅 $\\delta_{\\text{coul}} = 3.0\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{vdW}} = 1.0\\,\\mathrm{kJ/mol}$，$\\delta_{\\text{rest}} = 0.2\\,\\mathrm{kJ/mol}$。\n  - 网格点数 $N = 101$。\n\n最终输出要求：\n\n- 您的程序应生成单行输出，其中包含所有测试用例的结果，格式为一个逗号分隔的列表，并用方括号括起来，每个用例贡献一个包含四个浮点数的列表，顺序如下：\n  - $\\Delta G_{\\text{total,fwd}}$，单位为 $\\mathrm{kJ/mol}$，\n  - $\\Delta G_{\\text{total,back}}$，单位为 $\\mathrm{kJ/mol}$，\n  - $H_{\\max}$，单位为 $\\mathrm{kJ/mol}$，\n  - $\\Xi$，单位为 $\\mathrm{kJ/mol}$。\n- 格式必须严格遵循\n$$\n\\left[ [g_{1,\\text{fwd}}, g_{1,\\text{back}}, h_{1,\\max}, \\xi_{1}], [g_{2,\\text{fwd}}, g_{2,\\text{back}}, h_{2,\\max}, \\xi_{2}], [g_{3,\\text{fwd}}, g_{3,\\text{back}}, h_{3,\\max}, \\xi_{3}] \\right],\n$$\n无任何附加文本，其中下标 $1,2,3$ 表示各自的测试用例。\n\n所有计算出的自由能必须以 $\\mathrm{kJ/mol}$ 表示，三角函数中的角度以弧度为单位。",
            "solution": "问题陈述已经过严格验证，并被确定为有效。它在科学上基于统计力学和计算化学的原理，特别是热力学积分 (TI) 框架。该问题是适定的，所有必要的参数、常数和函数形式都已明确定义，确保可以获得唯一且有意义的数值解。语言客观且无歧义。所使用的模型虽然是理想化的，但对于炼金转化中的步骤是合理的表示，并且整个任务构成了一个标准但全面的自由能计算练习。\n\n解决方案通过实现指定的数学模型和数值方法来推进。核心任务是计算三个不同炼金步骤（库仑、范德华和约束）在正向和反向路径上的自由能变化 $\\Delta G$。\n\n首先，我们定义必要的物理常数，计算时必须使用国际单位制 (SI units)。\n- 阿伏伽德罗常数：$N_{\\mathrm{A}} = 6.02214076\\times 10^{23}\\,\\mathrm{mol^{-1}}$\n- 真空介电常数：$\\varepsilon_{0} = 8.8541878128\\times 10^{-12}\\,\\mathrm{F/m}$\n- 元电荷：$e = 1.602176634\\times 10^{-19}\\,\\mathrm{C}$\n- 埃到米的转换是 $1\\,\\text{\\AA} = 10^{-10}\\,\\mathrm{m}$。\n\n库仑步骤需要预先计算价态为 $z$、半径为 $r$ 的离子在介电常数为 $\\varepsilon_{r}$ 的溶剂中的 Born 自由能 $\\Delta G_{\\text{Born}}$。提供的公式是\n$$\n\\Delta G_{\\text{Born}} = -\\frac{N_{\\mathrm{A}}}{8\\pi \\varepsilon_{0}} \\frac{(z e)^{2}}{r}\\left(1 - \\frac{1}{\\varepsilon_{r}}\\right)\n$$\n该表达式产生的结果单位为焦耳/摩尔 ($\\mathrm{J/mol}$)。为符合问题的单位要求，此值通过除以 $1000$ 转换为千焦/摩尔 ($\\mathrm{kJ/mol}$)。然后将库仑被积函数的参数 $A$ 定义为 $A = 2\\,\\Delta G_{\\text{Born}}$。\n\n每个步骤 $i \\in \\{\\text{coul}, \\text{vdW}, \\text{rest}\\}$ 的自由能变化计算都基于 TI 公式，该公式需要对势能相对于耦合参数 $\\lambda$ 的系综平均导数进行积分：\n$$\n\\Delta G_{i, \\text{fwd}} = \\int_{0}^{1} \\left\\langle \\frac{\\partial U_{i,\\text{fwd}}(\\lambda)}{\\partial \\lambda} \\right\\rangle_{\\lambda} \\, d\\lambda\n$$\n问题定义了这些被积函数的具体函数形式：\n- 库仑：$\\left\\langle \\frac{\\partial U_{\\text{coul}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = A \\frac{\\lambda}{\\sqrt{1 + \\alpha_{\\text{c}}(1 - \\lambda)^{2}}}$\n- 范德华：$\\left\\langle \\frac{\\partial U_{\\text{vdW}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = B \\frac{3\\lambda^{2}}{1 + \\alpha_{\\text{LJ}}(1 - \\lambda)^{2}}$\n- 约束：$\\left\\langle \\frac{\\partial U_{\\text{rest}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = C$\n\n积分是使用复合辛普森法则在一个包含 $N$ 个点的从 $0$ 到 $1$ 的离散 $\\lambda$ 值网格上进行数值计算的。网格间距为 $h = 1 / (N-1)$。由于 $N=101$，这是辛普森法则的一个有效配置。\n\n对于反向路径，导数被加上偏置以模拟滞后：\n$$\n\\left\\langle \\frac{\\partial U_{i,\\text{back}}}{\\partial \\lambda} \\right\\rangle_{\\lambda} = \\left\\langle \\frac{\\partial U_{i,\\text{fwd}}(\\lambda)}{\\partial \\lambda} \\right\\rangle_{\\lambda} + \\delta_{i}\\,\\sin(\\pi \\lambda)\n$$\n然后，根据问题的定义，反向自由能变化计算如下：\n$$\n\\Delta G_{i,\\text{back}} = -\\int_{0}^{1} \\left\\langle \\frac{\\partial U_{i,\\text{back}}(\\lambda)}{\\partial \\lambda} \\right\\rangle_{\\lambda} \\, d\\lambda\n$$\n负号是所提供定义的一个关键部分。\n\n一旦计算出三个步骤中每个步骤的正向和反向自由能贡献，就可以确定最终的量：\n1.  总正向自由能：$\\Delta G_{\\text{total,fwd}} = \\Delta G_{\\text{coul,fwd}} + \\Delta G_{\\text{vdW,fwd}} + \\Delta G_{\\text{rest,fwd}}$。\n2.  总反向自由能：$\\Delta G_{\\text{total,back}} = \\Delta G_{\\text{coul,back}} + \\Delta G_{\\text{vdW,back}} + \\Delta G_{\\text{rest,back}}$。\n3.  分步滞后：$H_{i} = \\Delta G_{i,\\text{fwd}} + \\Delta G_{i,\\text{back}}$。\n4.  最大绝对滞后：$H_{\\max} = \\max\\left(|H_{\\text{coul}}|, |H_{\\text{vdW}}|, |H_{\\text{rest}}|\\right)$。\n5.  循环闭合：$\\Xi = \\Delta G_{\\text{total,fwd}} + \\Delta G_{\\text{total,back}}$。\n\n将此完整过程系统地应用于所提供的三个测试用例中的每一个。数值积分是使用 `scipy.integrate` 库中的 `simpson` 函数执行的，该函数为指定的法则提供了稳健而准确的实现。所有最终的能量值单位均为 $\\mathrm{kJ/mol}$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import simpson\n\ndef solve():\n    \"\"\"\n    Computes solvation free energy, hysteresis, and cycle closure for a \n    three-step alchemical path using Thermodynamic Integration.\n    \"\"\"\n\n    # Physical Constants\n    NA = 6.02214076e23  # Avogadro number (mol^-1)\n    EPS0 = 8.8541878128e-12  # Vacuum permittivity (F/m)\n    E = 1.602176634e-19  # Elementary charge (C)\n\n    # Test cases as defined in the problem statement\n    test_cases = [\n        {\n            \"z\": 1.0, \"r\": 1.9, \"eps_r\": 78.3,\n            \"alpha_c\": 0.5, \"B\": 8.0, \"alpha_LJ\": 0.2, \"C\": 1.5,\n            \"delta_coul\": 0.5, \"delta_vdW\": 0.2, \"delta_rest\": 0.05,\n            \"N\": 101,\n        },\n        {\n            \"z\": -1.0, \"r\": 2.05, \"eps_r\": 78.3,\n            \"alpha_c\": 0.0, \"B\": 6.0, \"alpha_LJ\": 0.0, \"C\": 1.0,\n            \"delta_coul\": 0.0, \"delta_vdW\": 0.0, \"delta_rest\": 0.0,\n            \"N\": 101,\n        },\n        {\n            \"z\": 2.0, \"r\": 0.72, \"eps_r\": 78.3,\n            \"alpha_c\": 3.0, \"B\": 12.0, \"alpha_LJ\": 0.5, \"C\": 2.0,\n            \"delta_coul\": 3.0, \"delta_vdW\": 1.0, \"delta_rest\": 0.2,\n            \"N\": 101,\n        },\n    ]\n\n    results = []\n\n    for params in test_cases:\n        # Unpack parameters for the current case\n        z, r_angstrom, eps_r = params[\"z\"], params[\"r\"], params[\"eps_r\"]\n        alpha_c, B, alpha_LJ, C = params[\"alpha_c\"], params[\"B\"], params[\"alpha_LJ\"], params[\"C\"]\n        d_c, d_v, d_r = params[\"delta_coul\"], params[\"delta_vdW\"], params[\"delta_rest\"]\n        N = params[\"N\"]\n\n        # Create the lambda grid for integration\n        lamb_grid = np.linspace(0.0, 1.0, N)\n\n        # 1. Coulombic Contribution Calculation\n        # Convert radius from Angstrom to meters\n        r_m = r_angstrom * 1e-10\n        # Calculate Born free energy in J/mol\n        # The term (e^2 / (8*pi*eps0)) is a constant prefactor\n        dg_born_J_per_mol = - (NA * E**2) / (8 * np.pi * EPS0) * (z**2 / r_m) * (1 - 1 / eps_r)\n        # Convert to kJ/mol\n        dg_born_kJ_per_mol = dg_born_J_per_mol / 1000.0\n        # Define the amplitude A for the integrand\n        A = 2.0 * dg_born_kJ_per_mol\n\n        # Define the forward and backward integrands for the Coulombic step\n        dudl_coul_fwd = A * lamb_grid / np.sqrt(1 + alpha_c * (1 - lamb_grid)**2)\n        dudl_coul_back = dudl_coul_fwd + d_c * np.sin(np.pi * lamb_grid)\n\n        # Integrate using Simpson's rule\n        dg_coul_fwd = simpson(dudl_coul_fwd, lamb_grid)\n        dg_coul_back = -simpson(dudl_coul_back, lamb_grid)\n\n        # 2. Van der Waals Contribution Calculation\n        # Define the forward and backward integrands for the vdW step\n        dudl_vdw_fwd = B * 3 * lamb_grid**2 / (1 + alpha_LJ * (1 - lamb_grid)**2)\n        dudl_vdw_back = dudl_vdw_fwd + d_v * np.sin(np.pi * lamb_grid)\n\n        # Integrate\n        dg_vdw_fwd = simpson(dudl_vdw_fwd, lamb_grid)\n        dg_vdw_back = -simpson(dudl_vdw_back, lamb_grid)\n        \n        # 3. Restraint Contribution Calculation\n        # Define the forward and backward integrands for the restraint step\n        dudl_rest_fwd = np.full_like(lamb_grid, C)\n        dudl_rest_back = dudl_rest_fwd + d_r * np.sin(np.pi * lamb_grid)\n\n        # Integrate\n        dg_rest_fwd = simpson(dudl_rest_fwd, lamb_grid)\n        dg_rest_back = -simpson(dudl_rest_back, lamb_grid)\n\n        # 4. Calculate Total Energies, Hysteresis, and Cycle Closure\n        # Total forward and backward free energies\n        dg_total_fwd = dg_coul_fwd + dg_vdw_fwd + dg_rest_fwd\n        dg_total_back = dg_coul_back + dg_vdw_back + dg_rest_back\n\n        # Step-wise hysteresis\n        h_coul = dg_coul_fwd + dg_coul_back\n        h_vdw = dg_vdw_fwd + dg_vdw_back\n        h_rest = dg_rest_fwd + dg_rest_back\n        \n        # Maximum absolute hysteresis\n        h_max = max(abs(h_coul), abs(h_vdw), abs(h_rest))\n        \n        # Cycle closure\n        xi = dg_total_fwd + dg_total_back\n        \n        # Collect results for this case\n        results.append([dg_total_fwd, dg_total_back, h_max, xi])\n\n    # Format the final output string as specified\n    case_strings = []\n    for res_list in results:\n        # Format each number to a string and join with commas\n        case_strings.append(\"[\" + \",\".join([f\"{x:.6f}\" for x in res_list]) + \"]\")\n    \n    # Join all cases and wrap in brackets\n    final_output_string = \"[\" + \",\".join(case_strings) + \"]\"\n\n    print(final_output_string)\n\nsolve()\n```"
        }
    ]
}