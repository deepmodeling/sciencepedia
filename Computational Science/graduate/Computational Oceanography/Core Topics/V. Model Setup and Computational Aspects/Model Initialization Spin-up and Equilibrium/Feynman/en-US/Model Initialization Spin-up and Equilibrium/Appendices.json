{
    "hands_on_practices": [
        {
            "introduction": "Before a numerical model simulation can begin, one of the most fundamental parameters to set is the time step, $\\Delta t$. This choice is not arbitrary; for explicit time-stepping schemes, it is constrained by the Courant-Friedrichs-Lewy (CFL) condition, which ensures numerical stability by preventing information from propagating further than one grid cell per time step. This practice provides a concrete exercise in applying this principle, requiring you to derive the maximum velocity from a given initial flow field and calculate the largest permissible time step to ensure a stable simulation from the very first moment .",
            "id": "3799525",
            "problem": "Consider the spin-up of a barotropic, nondivergent flow in a rectangular basin on a constant Coriolis parameter plane (commonly called an $f$-plane). The basin dimensions are $L \\times L$ with $L=1.0\\times 10^{6}$ meters, and the horizontal discretization is uniform with $\\Delta x=\\Delta y=5.0\\times 10^{3}$ meters on an Arakawa C-grid. The initial velocity field at model startup is generated from a prescribed streamfunction $\\psi(x,y)$ according to geostrophic kinematics, namely $u(x,y)=-\\partial \\psi/\\partial y$ and $v(x,y)=\\partial \\psi/\\partial x$, with\n$$\n\\psi(x,y)=U_{0}\\,\\lambda\\,\\tanh\\!\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\!\\left(\\frac{\\pi x}{L}\\right).\n$$\nHere $U_{0}=1.0$ meters per second and $\\lambda=1.0\\times 10^{5}$ meters are fixed parameters. The scalar advection operator in the numerical model is advanced using an explicit, donor-cell (first-order upwind) scheme with Strang directional splitting. For such a directionally split explicit advection update, stability requires that the Courant–Friedrichs–Lewy (CFL) numbers in each coordinate direction, defined as nondimensional ratios between the distance advected during one time step and the corresponding grid spacing, remain strictly less than one at all grid points.\n\nStarting from the continuous two-dimensional advection equation and the given initialization, derive the expressions for the maximum Courant numbers in the $x$ and $y$ directions over the domain and use them to determine the largest permissible time step that satisfies the directional stability requirement everywhere during the initial spin-up. Express your final answer as the largest permissible time step $\\Delta t_{\\mathrm{max}}$ in seconds, and round your answer to four significant figures. Do not include any units in your final boxed answer.",
            "solution": "The stability of the explicit, directionally split numerical scheme requires that the Courant number in each direction remains strictly less than one throughout the computational domain. This can be expressed as two conditions on the time step $\\Delta t$:\n$$\n\\frac{|u(x,y)| \\Delta t}{\\Delta x}  1 \\quad \\text{for all } (x,y)\n$$\n$$\n\\frac{|v(x,y)| \\Delta t}{\\Delta y}  1 \\quad \\text{for all } (x,y)\n$$\nTo ensure these conditions hold everywhere, $\\Delta t$ must satisfy:\n$$\n\\Delta t  \\frac{\\Delta x}{\\max|u(x,y)|} \\quad \\text{and} \\quad \\Delta t  \\frac{\\Delta y}{\\max|v(x,y)|}\n$$\nThe largest permissible time step, $\\Delta t_{\\mathrm{max}}$, is therefore the minimum of these two upper bounds:\n$$\n\\Delta t_{\\mathrm{max}} = \\min \\left( \\frac{\\Delta x}{\\max|u|}, \\frac{\\Delta y}{\\max|v|} \\right)\n$$\nwhere $\\max|u|$ and $\\max|v|$ are the maximum absolute values of the velocity components over the entire basin.\n\nFirst, we must derive the velocity components $u(x,y)$ and $v(x,y)$ from the given streamfunction $\\psi(x,y)$.\nThe streamfunction is:\n$$\n\\psi(x,y) = U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\n$$\nThe zonal velocity component, $u$, is found by differentiating $\\psi$ with respect to $y$:\n$$\nu(x,y) = -\\frac{\\partial \\psi}{\\partial y} = -\\frac{\\partial}{\\partial y} \\left[ U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) \\right]\n$$\nUsing the chain rule, $\\frac{d}{dz}\\tanh(z) = \\text{sech}^2(z)$, we get:\n$$\nu(x,y) = -U_{0}\\,\\lambda\\,\\left( \\text{sech}^2\\left(\\frac{y}{\\lambda}\\right) \\cdot \\frac{1}{\\lambda} \\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) = -U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\n$$\nThe meridional velocity component, $v$, is found by differentiating $\\psi$ with respect to $x$:\n$$\nv(x,y) = \\frac{\\partial \\psi}{\\partial x} = \\frac{\\partial}{\\partial x} \\left[ U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right) \\right]\n$$\nThis gives:\n$$\nv(x,y) = U_{0}\\,\\lambda\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\left( \\cos\\left(\\frac{\\pi x}{L}\\right) \\cdot \\frac{\\pi}{L} \\right) = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\cos\\left(\\frac{\\pi x}{L}\\right)\n$$\nNext, we find the maximum absolute values of $u$ and $v$ over the domain, which we take to be $x \\in [0, L]$ and $y \\in [0, L]$.\n\nFor the zonal velocity $u(x,y)$:\n$$\n|u(x,y)| = \\left|-U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\sin\\left(\\frac{\\pi x}{L}\\right)\\right| = U_{0}\\,\\text{sech}^2\\left(\\frac{y}{\\lambda}\\right)\\,\\left|\\sin\\left(\\frac{\\pi x}{L}\\right)\\right|\n$$\nThe maximum value of the function $\\text{sech}^2(z)$ is $1$, which occurs at $z=0$. In our case, this corresponds to $y=0$. The maximum value of $|\\sin(\\theta)|$ is $1$. For $x \\in [0, L]$, the term $|\\sin(\\pi x/L)|$ reaches its maximum of $1$ at $x = L/2$. Therefore, the maximum value of $|u|$ is:\n$$\n\\max|u| = U_{0} \\cdot (1) \\cdot (1) = U_{0}\n$$\nGiven $U_{0} = 1.0$ m/s, we have $\\max|u| = 1.0$ m/s.\n\nFor the meridional velocity $v(x,y)$:\n$$\n|v(x,y)| = \\left|\\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{y}{\\lambda}\\right)\\,\\cos\\left(\\frac{\\pi x}{L}\\right)\\right| = \\frac{\\pi U_{0} \\lambda}{L}\\,\\left|\\tanh\\left(\\frac{y}{\\lambda}\\right)\\right|\\,\\left|\\cos\\left(\\frac{\\pi x}{L}\\right)\\right|\n$$\nThe maximum value of $|\\cos(\\theta)|$ is $1$. For $x \\in [0, L]$, the term $|\\cos(\\pi x/L)|$ reaches its maximum of $1$ at $x=0$ and $x=L$. The function $|\\tanh(z)|$ is monotonically increasing for $z \\ge 0$. For $y \\in [0, L]$, the term $|\\tanh(y/\\lambda)|$ is maximized at the largest possible value of $y$, which is $y=L$. Therefore, the maximum value of $|v|$ is:\n$$\n\\max|v| = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{L}{\\lambda}\\right) \\cdot (1) = \\frac{\\pi U_{0} \\lambda}{L}\\,\\tanh\\left(\\frac{L}{\\lambda}\\right)\n$$\nWe now substitute the given parameter values: $U_{0} = 1.0$ m/s, $L=1.0\\times 10^{6}$ m, and $\\lambda=1.0\\times 10^{5}$ m.\nThe argument of the hyperbolic tangent is $L/\\lambda = (1.0\\times 10^{6}) / (1.0\\times 10^{5}) = 10$.\n$$\n\\max|v| = \\frac{\\pi \\cdot (1.0) \\cdot (1.0\\times 10^{5})}{1.0\\times 10^{6}}\\,\\tanh(10) = 0.1\\,\\pi\\,\\tanh(10) \\text{ m/s}\n$$\nThe value of $\\tanh(10)$ is very close to $1$. Specifically, $\\tanh(10) \\approx 0.99999999587$. Thus, $\\max|v|$ is slightly less than $0.1\\pi$.\n$\\max|v| \\approx 0.1 \\times 3.14159 \\approx 0.31416$ m/s.\n\nNow we can compute the two time step constraints. We are given $\\Delta x = \\Delta y = 5.0 \\times 10^{3}$ m.\nThe constraint from the zonal velocity is:\n$$\n\\Delta t_x = \\frac{\\Delta x}{\\max|u|} = \\frac{5.0 \\times 10^{3} \\text{ m}}{U_{0}} = \\frac{5.0 \\times 10^{3}}{1.0} \\text{ s} = 5000 \\text{ s}\n$$\nThe constraint from the meridional velocity is:\n$$\n\\Delta t_y = \\frac{\\Delta y}{\\max|v|} = \\frac{5.0 \\times 10^{3} \\text{ m}}{0.1\\,\\pi\\,\\tanh(10) \\text{ m/s}} \\approx \\frac{5000}{0.314159} \\text{ s} \\approx 15915.5 \\text{ s}\n$$\nThe largest permissible time step $\\Delta t_{\\mathrm{max}}$ must satisfy both conditions simultaneously, so it is the minimum of the two values:\n$$\n\\Delta t_{\\mathrm{max}} = \\min(\\Delta t_x, \\Delta t_y) = \\min(5000 \\text{ s}, 15915.5 \\text{ s}) = 5000 \\text{ s}\n$$\nThe problem requires the answer to be rounded to four significant figures. The value $5000$ can be written as $5.000 \\times 10^{3}$, which has four significant figures. Thus, the value $5000$ is already at the required precision.\nThe largest permissible time step is $5000$ seconds.",
            "answer": "$$\n\\boxed{5000}\n$$"
        },
        {
            "introduction": "A numerically stable model is not necessarily a physically correct one. It is crucial to verify that the simulation respects fundamental physical laws, such as the conservation of mass, heat, and salt. This practice moves from the challenge of numerical stability to that of physical fidelity, focusing on how to construct a robust verification test for tracer conservation . You will learn to implement a global budget analysis, a critical skill for identifying unphysical model drift and building confidence in simulation results.",
            "id": "3799434",
            "problem": "Consider a three-dimensional ocean domain with a moving fluid that carries a salt tracer initialized at time $t=0$. Let the mass fraction salinity be $S(\\mathbf{x},t)$ (dimensionless), the in situ density be $\\rho(\\mathbf{x},t)$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, and the velocity field be $\\mathbf{u}(\\mathbf{x},t)$ in $\\mathrm{m}\\,\\mathrm{s}^{-1}$. Let the diffusive salt flux be $\\mathbf{J}_s(\\mathbf{x},t)$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. Assume that salt obeys a local conservation law based on fundamental continuum mechanics: the conservation equation for the salt mass density $q(\\mathbf{x},t) \\equiv \\rho(\\mathbf{x},t) S(\\mathbf{x},t)$ is given by a balance of advection and diffusion, with possible external sources on the boundary. The domain is bounded by a closed surface with outward unit normal $\\mathbf{n}$.\n\nTask 1 (derivation): Starting from the local conservation law for $q(\\mathbf{x},t)$ and using the Reynolds transport theorem and the divergence theorem, derive a global integral relation that connects the time rate of change of the total salt mass in the domain to a boundary integral of the normal salt flux through the boundary. Clearly state the assumptions on boundary conditions (for example, zero normal velocity and zero diffusive flux for a closed basin without external sources) under which the global tendency of the total salt mass must be zero.\n\nTask 2 (initialization checks): Propose a set of initialization checks that a computational oceanography model should satisfy to ensure zero drift of total salt mass in a closed basin without external sources during spin-up toward equilibrium. Your checks should be principle-based and testable from discrete model fields. At minimum, include:\n- A check that the net external salt flux integrated over the boundary and time is negligibly small in a closed basin.\n- A check that the change in global salt mass equals the time-integrated net external salt flux, within a specified tolerance.\n- A check for field sanity (finite values and physically reasonable bounds for $S$ and $\\rho$).\nDefine a relative tolerance $\\epsilon$ for these checks and explain how it should be applied.\n\nTask 3 (computational verification): Implement the initialization checks in a program that evaluates several discrete test cases. For each test case, you are given:\n- A set of volumetric cells with volumes $V_i$ in $\\mathrm{m}^3$, densities $\\rho_i$ in $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, and salinities $S_i$ (dimensionless mass fraction).\n- A set of boundary faces with areas $A_j$ in $\\mathrm{m}^2$.\n- A time step $\\Delta t$ in $\\mathrm{s}$ and a sequence of salt mass fluxes per unit area $F_{S,j}^{(n)}$ in $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$ for discrete times $n=0,\\dots,N-1$ on each boundary face $j$, where positive $F_{S,j}^{(n)}$ denotes salt entering the domain.\n- A reported final total salt mass $M_{\\mathrm{model}}$ in $\\mathrm{kg}$ after spin-up.\n\nThe program must compute the initial total salt mass $M_0 = \\sum_i \\rho_i S_i V_i$, the time-integrated external salt mass input $\\Delta M_{\\mathrm{ext}} = \\sum_{n=0}^{N-1} \\Delta t \\sum_j F_{S,j}^{(n)} A_j$, and the budget residual $R = M_{\\mathrm{model}} - M_0 - \\Delta M_{\\mathrm{ext}}$ in $\\mathrm{kg}$. For a closed basin without external sources, require $\\Delta M_{\\mathrm{ext}}$ to be negligibly small. Use a relative tolerance $\\epsilon = 10^{-9}$ (dimensionless) and declare the test to pass if both $\\lvert R \\rvert \\le \\epsilon \\max(M_0,1)$ and, for closed basins, $\\lvert \\Delta M_{\\mathrm{ext}} \\rvert \\le \\epsilon \\max(M_0,1)$, and if all fields are finite with $0 \\le S_i \\le 1$ and $\\rho_i  0$. Express all mass quantities in $\\mathrm{kg}$ and time in $\\mathrm{s}$.\n\nTest suite:\n- Case $1$ (happy path, closed basin): $V = [10^8,\\,1.2\\times 10^8,\\,0.8\\times 10^8]$ $\\mathrm{m}^3$, $\\rho = [1025,\\,1025,\\,1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $S = [0.035,\\,0.035,\\,0.035]$, boundary areas $A = [2\\times 10^6,\\,3\\times 10^6]$ $\\mathrm{m}^2$, time step $\\Delta t = 3600$ $\\mathrm{s}$, $N=24$, fluxes $F_{S,j}^{(n)}=0$ for all $j,n$, closed basin flag true, and $M_{\\mathrm{model}}=M_0$.\n- Case $2$ (variable fields, closed basin): $V = [2.0\\times 10^8,\\,1.5\\times 10^8]$ $\\mathrm{m}^3$, $\\rho = [1020,\\,1030]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $S = [0.034,\\,0.036]$, boundary areas $A = [1\\times 10^6]$ $\\mathrm{m}^2$, $\\Delta t = 1800$ $\\mathrm{s}$, $N=10$, fluxes $F_{S,j}^{(n)}=0$, closed basin flag true, and $M_{\\mathrm{model}}=M_0$.\n- Case $3$ (erroneous external source in closed basin): $V = [10^7]$ $\\mathrm{m}^3$, $\\rho = [1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $S = [0.035]$, boundary areas $A = [10^5]$ $\\mathrm{m}^2$, $\\Delta t = 100$ $\\mathrm{s}$, $N=1000$, fluxes $F_{S,j}^{(n)} = [10^{-5}]$ $\\mathrm{kg}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$ for all $n$, closed basin flag true, and $M_{\\mathrm{model}}=M_0$.\n- Case $4$ (boundary tolerance edge, closed basin): $V = [10^9]$ $\\mathrm{m}^3$, $\\rho = [1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $S = [0.035]$, boundary areas $A = [10^5]$ $\\mathrm{m}^2$, $\\Delta t = 3600$ $\\mathrm{s}$, $N=1$, fluxes $F_{S,j}^{(n)}=0$, closed basin flag true, and $M_{\\mathrm{model}}$ equal to $M_0(1+\\epsilon)$, where $M_0$ is computed by your program from the provided fields.\n- Case $5$ (invalid initialization, closed basin): $V = [5\\times 10^8,\\,5\\times 10^8]$ $\\mathrm{m}^3$, $\\rho = [1025,\\,1025]$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$, $S = [0.035, \\text{NaN}]$, boundary areas $A = [10^6]$ $\\mathrm{m}^2$, $\\Delta t = 3600$ $\\mathrm{s}$, $N=5$, fluxes $F_{S,j}^{(n)}=0$, closed basin flag true, and any $M_{\\mathrm{model}}$ (the case should fail due to invalid $S$).\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4,result5]\"), where each result is a boolean indicating whether the corresponding test case passes all initialization checks.",
            "solution": "**Task 1: Derivation of the Global Salt Conservation Law**\n\nThe conservation of a tracer such as salt within a fluid volume is governed by a local conservation law that balances the local rate of change of the tracer's mass density with the divergence of its flux. Let the salt mass density be $q(\\mathbf{x},t) = \\rho(\\mathbf{x},t) S(\\mathbf{x},t)$, where $\\rho$ is the in situ fluid density and $S$ is the dimensionless mass fraction of salt. The total flux of salt mass, $\\mathbf{F}_q(\\mathbf{x},t)$, is the sum of the advective flux, which represents salt carried by the bulk motion of the fluid, and the diffusive flux, which represents transport due to molecular or turbulent mixing. The advective flux is given by $q\\mathbf{u} = \\rho S \\mathbf{u}$, where $\\mathbf{u}(\\mathbf{x},t)$ is the fluid velocity. The diffusive flux is given as $\\mathbf{J}_s(\\mathbf{x},t)$. Thus, the total salt flux is $\\mathbf{F}_q = \\rho S \\mathbf{u} + \\mathbf{J}_s$.\n\nThe local conservation law, or continuity equation for salt mass, is expressed in differential form as:\n$$\n\\frac{\\partial q}{\\partial t} + \\nabla \\cdot \\mathbf{F}_q = 0\n$$\nSubstituting the expressions for $q$ and $\\mathbf{F}_q$, we have:\n$$\n\\frac{\\partial (\\rho S)}{\\partial t} + \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) = 0\n$$\nTo obtain a global conservation relation for the entire ocean domain, represented by a volume $\\Omega$, we integrate this local conservation law over $\\Omega$:\n$$\n\\int_\\Omega \\frac{\\partial (\\rho S)}{\\partial t} \\,dV + \\int_\\Omega \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\,dV = 0\n$$\nWe analyze each term separately. The total mass of salt in the domain is given by the volume integral $M_s(t) = \\int_\\Omega \\rho S \\,dV$. For a fixed (Eulerian) control volume $\\Omega$, the time derivative can be moved outside the integral (an application of the Reynolds transport theorem for a stationary domain, also known as the Leibniz integral rule):\n$$\n\\frac{d M_s}{dt} = \\frac{d}{dt} \\int_\\Omega \\rho S \\,dV = \\int_\\Omega \\frac{\\partial (\\rho S)}{\\partial t} \\,dV\n$$\nThe second term in the integrated conservation law can be transformed into a boundary integral using the divergence theorem, which states that $\\int_\\Omega \\nabla \\cdot \\mathbf{F} \\,dV = \\oint_{\\partial\\Omega} \\mathbf{F} \\cdot \\mathbf{n} \\,dA$, where $\\partial\\Omega$ is the closed boundary surface of the domain and $\\mathbf{n}$ is the outward-pointing unit normal vector. Applying this yields:\n$$\n\\int_\\Omega \\nabla \\cdot (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\,dV = \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA\n$$\nThis boundary integral represents the net rate of salt mass transport, or flux, out of the domain.\n\nSubstituting these two results back into the integrated conservation equation gives the global integral relation:\n$$\n\\frac{d M_s}{dt} + \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA = 0\n$$\nThis equation states that the time rate of change of the total salt mass within the domain is equal to the negative of the net salt flux across its boundary. Rearranging, we can state that the rate of mass increase is equal to the net flux into the domain:\n$$\n\\frac{d M_s}{dt} = - \\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA\n$$\nFor the global tendency of the total salt mass to be zero, i.e., $\\frac{d M_s}{dt} = 0$, the total salt mass $M_s$ must be conserved. This requires the net boundary flux to be zero:\n$$\n\\oint_{\\partial\\Omega} (\\rho S \\mathbf{u} + \\mathbf{J}_s) \\cdot \\mathbf{n} \\,dA = 0\n$$\nThis condition is physically realized in a \"closed basin without external sources.\" Such a system is isolated from its surroundings with respect to salt transport. The standard boundary conditions that ensure this are:\n1.  **Impermeable boundaries**: The fluid cannot cross the boundary, implying the normal component of velocity is zero everywhere on the boundary: $\\mathbf{u} \\cdot \\mathbf{n} = 0$ on $\\partial\\Omega$.\n2.  **Zero diffusive flux**: There is no diffusive exchange of salt across the boundary, which implies the normal component of the diffusive flux is zero: $\\mathbf{J}_s \\cdot \\mathbf{n} = 0$ on $\\partial\\Omega$.\n\nUnder these two assumptions, both terms in the boundary integral vanish, leading to $\\frac{d M_s}{dt} = 0$ and the conservation of total salt mass.\n\n**Task 2: Principle-Based Initialization Checks**\n\nThe principles derived above must be respected by any valid numerical ocean model. During model spin-up, which is the process of adjusting from an initial state toward a dynamically-consistent equilibrium, verifying mass conservation is critical. We propose three testable, principle-based checks for a discretized model.\n\n1.  **Field Sanity and Physical Realism Check:** The initial state of the model must be physically plausible. This is a fundamental prerequisite before any conservation checks are performed. For each discrete cell $i$:\n    -   All provided data fields ($V_i, \\rho_i, S_i$, etc.) must be finite numerical values (not `NaN` or `infinity`).\n    -   Salinity $S_i$, as a mass fraction, must lie within the physically valid range $0 \\le S_i \\le 1$.\n    -   Density $\\rho_i$ must be positive, $\\rho_i  0$. Similarly, cell volumes $V_i$, boundary face areas $A_j$, and the time step $\\Delta t$ must be positive.\n\n2.  **Closed Basin Flux Check:** This check verifies that a model designated as a \"closed basin\" is correctly configured with zero net boundary flux. The total external salt mass added to the domain over the simulation time $N\\Delta t$ is computed by discretizing the flux integral in time and space:\n    $$ \\Delta M_{\\mathrm{ext}} = \\sum_{n=0}^{N-1} \\Delta t \\sum_j F_{S,j}^{(n)} A_j $$\n    where $F_{S,j}^{(n)}$ is the specified salt mass flux per unit area into the domain through boundary face $j$ at time step $n$. For a true closed basin, $\\Delta M_{\\mathrm{ext}}$ should be exactly zero. In a numerical context, we require it to be negligibly small relative to the total salt mass. The check is formulated using a relative tolerance $\\epsilon$:\n    $$ |\\Delta M_{\\mathrm{ext}}| \\le \\epsilon \\cdot \\max(|M_0|, 1) $$\n    where $M_0 = \\sum_i \\rho_i S_i V_i$ is the initial total salt mass. The term $\\max(|M_0|, 1)$ provides a robust reference scale, preventing issues if $M_0$ is zero or very small.\n\n3.  **Global Salt Mass Budget Closure Check:** This check directly verifies the discrete global conservation law derived in Task 1. The change in total salt mass from the initial state to the final state must equal the total mass that has entered through the boundaries.\n    -   The initial total salt mass is $M_0 = \\sum_i \\rho_i S_i V_i$.\n    -   The final total salt mass reported by the model is $M_{\\mathrm{model}}$.\n    -   The total mass added via external fluxes is $\\Delta M_{\\mathrm{ext}}$ as defined above.\n    -   The expected final mass, assuming perfect conservation and correct external forcing, is $M_0 + \\Delta M_{\\mathrm{ext}}$.\n    -   The budget residual, $R = M_{\\mathrm{model}} - (M_0 + \\Delta M_{\\mathrm{ext}})$, represents the total salt mass that was artificially created or destroyed within the domain by the numerical schemes (e.g., due to the advection algorithm). This residual is often called numerical drift.\n    -   For a numerically conservative model, this residual must be negligibly small. The check is:\n    $$ |R| \\le \\epsilon \\cdot \\max(|M_0|, 1) $$\n    Passing this test confirms that the model's internal dynamics conserve the tracer to the specified tolerance $\\epsilon$. A failure indicates a flaw in the model's numerical implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_check(V, rho, S, A, dt, N, F_S, is_closed_basin, M_model_val):\n    \"\"\"\n    Performs initialization checks for a single test case.\n\n    Args:\n        V (np.ndarray): Array of cell volumes [m^3].\n        rho (np.ndarray): Array of cell densities [kg m^-3].\n        S (np.ndarray): Array of cell salinities (dimensionless).\n        A (np.ndarray): Array of boundary face areas [m^2].\n        dt (float): Time step [s].\n        N (int): Number of time steps.\n        F_S (np.ndarray): Array of boundary salt fluxes [kg m^-2 s^-1]\n                        of shape (N, num_faces). Positive is into domain.\n        is_closed_basin (bool): Flag indicating if it's a closed basin.\n        M_model_val (float or str): Reported final total salt mass [kg].\n                                    Can be a special string for case 4.\n\n    Returns:\n        bool: True if all checks pass, False otherwise.\n    \"\"\"\n    epsilon = 1e-9\n\n    # --- 1. Field Sanity and Physical Realism Check ---\n    all_fields = [V, rho, S, A, dt, N, F_S]\n    # Check for NaN or Inf in all numerical inputs\n    if any(np.any(np.isinf(field)) or np.any(np.isnan(field)) for field in all_fields):\n        return False\n    # Check positivity and bounds for relevant fields\n    if not (np.all(V  0) and np.all(rho  0) and np.all(A  0) and dt  0 and N = 0):\n        return False\n    if not (np.all(S = 0) and np.all(S = 1)):\n        return False\n\n    # --- 2. Calculations for Budget and Flux Checks ---\n\n    # Compute initial total salt mass M_0\n    M_0 = np.sum(rho * S * V)\n    \n    # Handle dynamic M_model for case 4\n    if isinstance(M_model_val, str) and M_model_val == 'M0*(1+epsilon)':\n      M_model = M_0 * (1 + epsilon)\n    else:\n      M_model = M_model_val\n      \n    # Check for NaN/Inf in M_model as well\n    if np.isinf(M_model) or np.isnan(M_model):\n        return False\n    \n    # Compute time-integrated external salt mass input Delta_M_ext\n    # Sum fluxes over all boundary faces for each time step\n    total_flux_per_timestep = np.sum(F_S * A, axis=1)\n    # Sum over all time steps and multiply by dt\n    delta_M_ext = dt * np.sum(total_flux_per_timestep)\n\n    # Compute budget residual R\n    R = M_model - M_0 - delta_M_ext\n\n    # --- 3. Tolerance Checks ---\n\n    # Establish the reference mass scale for relative tolerance\n    mass_scale = max(abs(M_0), 1.0)\n    \n    # Check 3a: Budget Closure Check\n    # The budget residual must be within tolerance.\n    is_budget_ok = abs(R) = epsilon * mass_scale\n    if not is_budget_ok:\n        return False\n\n    # Check 3b: Closed Basin Flux Check\n    # If it's a closed basin, external fluxes must be negligible.\n    if is_closed_basin:\n        is_flux_ok = abs(delta_M_ext) = epsilon * mass_scale\n        if not is_flux_ok:\n            return False\n            \n    # If all checks passed\n    return True\n\ndef solve():\n    \"\"\"\n    Main function to define test cases and run the checks.\n    \"\"\"\n    \n    # Define test cases based on the problem description\n    test_cases = [\n        # Case 1: Happy path, closed basin\n        {'V': np.array([1e8, 1.2e8, 0.8e8]),\n         'rho': np.array([1025.0, 1025.0, 1025.0]),\n         'S': np.array([0.035, 0.035, 0.035]),\n         'A': np.array([2e6, 3e6]),\n         'dt': 3600.0, 'N': 24,\n         'F_S': np.zeros((24, 2)),\n         'is_closed_basin': True,\n         'M_model_val': 1.07625e10\n        },\n        # Case 2: Variable fields, closed basin\n        {'V': np.array([2.0e8, 1.5e8]),\n         'rho': np.array([1020.0, 1030.0]),\n         'S': np.array([0.034, 0.036]),\n         'A': np.array([1e6]),\n         'dt': 1800.0, 'N': 10,\n         'F_S': np.zeros((10, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 1.2498e10\n        },\n        # Case 3: Erroneous external source in closed basin\n        {'V': np.array([1e7]),\n         'rho': np.array([1025.0]),\n         'S': np.array([0.035]),\n         'A': np.array([1e5]),\n         'dt': 100.0, 'N': 1000,\n         'F_S': np.full((1000, 1), 1e-5),\n         'is_closed_basin': True,\n         'M_model_val': 3.5875e8 # M_model = M_0 in this case\n        }, \n        # Case 4: Boundary tolerance edge, closed basin\n        # M_model is dynamically calculated based on M_0 for this case.\n        {'V': np.array([1e9]),\n         'rho': np.array([1025.0]),\n         'S': np.array([0.035]),\n         'A': np.array([1e5]),\n         'dt': 3600.0, 'N': 1,\n         'F_S': np.zeros((1, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 'M0*(1+epsilon)' \n        },\n        # Case 5: Invalid initialization (NaN in S)\n        {'V': np.array([5e8, 5e8]),\n         'rho': np.array([1025.0, 1025.0]),\n         'S': np.array([0.035, np.nan]),\n         'A': np.array([1e6]),\n         'dt': 3600.0, 'N': 5,\n         'F_S': np.zeros((5, 1)),\n         'is_closed_basin': True,\n         'M_model_val': 1.0 # Arbitrary value, should fail before this is used\n        }\n    ]\n    \n    # Adjust M_model for case 1 to be exactly M0 without pre-calculating it by hand\n    case1 = test_cases[0]\n    case1['M_model_val'] = np.sum(case1['rho'] * case1['S'] * case1['V'])\n    \n    # Adjust M_model for case 2 to be exactly M0 without pre-calculating it by hand\n    case2 = test_cases[1]\n    case2['M_model_val'] = np.sum(case2['rho'] * case2['S'] * case2['V'])\n\n    # Adjust M_model for case 3 to be exactly M0\n    case3 = test_cases[2]\n    case3['M_model_val'] = np.sum(case3['rho'] * case3['S'] * case3['V'])\n\n    results = []\n    for case in test_cases:\n        result = run_check(\n            case['V'], case['rho'], case['S'], case['A'], \n            case['dt'], case['N'], case['F_S'], \n            case['is_closed_basin'], case['M_model_val']\n        )\n        results.append(result)\n\n    # Print the final results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Every ocean model simulation starts with an initial 'spin-up' period as the system adjusts from an artificial starting state to a statistically-stationary equilibrium. A critical challenge is determining when this transient phase is over and the model is ready for scientific analysis. This final practice introduces a sophisticated, physically-grounded method that goes beyond simple time-series analysis . By examining the kinetic energy spectrum, you will learn to implement a criterion that diagnoses equilibrium based on the stabilization of energy across all spatial scales, a powerful technique used in modern ocean modeling.",
            "id": "3799427",
            "problem": "You are tasked with designing and implementing a spectral equilibration criterion for a two-dimensional ocean model velocity field time series to diagnose when the model has spun up and reached equilibrium. The criterion must be grounded in the stabilization of the kinetic energy spectrum across spatial scales and the plateauing of mesoscale variance. Your program must generate synthetic velocity fields with controlled spectral characteristics for several test scenarios and then apply the criterion to each scenario to return a boolean indicating whether equilibrium is achieved.\n\nUse the following fundamental base to construct the criterion and its algorithmic implementation.\n\n1. Kinetic energy per unit mass in two-dimensional flow is defined by the velocity components $u(x,y,t)$ and $v(x,y,t)$ as $K(t) = \\frac{1}{2} \\langle u(x,y,t)^2 + v(x,y,t)^2 \\rangle$, where $\\langle \\cdot \\rangle$ denotes the spatial average over the domain.\n\n2. For a periodic domain of size $L_x$ by $L_y$ discretized on a uniform grid of $N_x \\times N_y$ points with grid spacing $d_x$ and $d_y$ (in meters), the discrete Fourier transform produces wavenumbers $k_x = 2\\pi m / L_x$ and $k_y = 2\\pi n / L_y$, where $m$ and $n$ are integers given by the frequency grid. The discrete Parseval relation ensures that the spatial average of $u^2$ equals the sum of squared Fourier amplitudes scaled by the appropriate normalization factor.\n\n3. The isotropic one-dimensional kinetic energy spectrum $E(k,t)$ is obtained by binning the two-dimensional spectral kinetic energy density by wavenumber magnitude $k = \\sqrt{k_x^2 + k_y^2}$ and summing over annuli. The total kinetic energy per unit mass satisfies $\\int_0^{k_{\\max}} E(k,t)\\,dk \\approx \\frac{1}{2}\\langle u^2 + v^2 \\rangle$, up to discrete binning approximations.\n\n4. The mesoscale band is defined by length scales between $L_{\\min}$ and $L_{\\max}$, mapped to wavenumbers $k_{\\min}^{\\text{meso}} = \\frac{2\\pi}{L_{\\max}}$ and $k_{\\max}^{\\text{meso}} = \\frac{2\\pi}{L_{\\min}}$. The mesoscale variance at time $t$ is the band-integrated kinetic energy $V_{\\text{meso}}(t) = \\sum_{k \\in [k_{\\min}^{\\text{meso}}, k_{\\max}^{\\text{meso}}]} E(k,t)$ computed over discrete bins.\n\nConstruct the following spectral equilibration criterion.\n\n- Spectral stabilization across scales: Compute two time-averaged spectra, $\\overline{E}_1(k)$ over an earlier time window and $\\overline{E}_2(k)$ over a later time window of equal length $W$ time steps. Define the relative spectral change metric\n$$\nD_{\\text{spec}} = \\frac{\\sqrt{\\sum_{k} \\left(\\overline{E}_2(k) - \\overline{E}_1(k)\\right)^2}}{\\sqrt{\\sum_{k} \\overline{E}_2(k)^2}}.\n$$\nSpectral stabilization is signaled if $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$, where $\\varepsilon_{\\text{spec}}$ is a prescribed tolerance given as a decimal.\n\n- Mesoscale plateau: Over the same later window, evaluate the coefficient of variation of the mesoscale variance\n$$\n\\mathrm{CV}_{\\text{meso}} = \\frac{\\mathrm{std}\\left(V_{\\text{meso}}(t)\\right)}{\\mathrm{mean}\\left(V_{\\text{meso}}(t)\\right)},\n$$\nwith the standard deviation and mean taken over the last $W$ time steps. A plateau is signaled if $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$, where $\\varepsilon_{\\text{cv}}$ is a prescribed tolerance given as a decimal.\n\nDeclare the model equilibrated if and only if both conditions hold.\n\nSynthetic velocity field generation for testing must be constructed as follows.\n\n- At each time $t$, generate random real-valued fields $u_0(x,y,t)$ and $v_0(x,y,t)$ with zero mean in the physical domain, transform them to Fourier space, multiply by a nonnegative, radially symmetric spectral filter $F(k,t)$, and inverse transform to obtain $u(x,y,t)$ and $v(x,y,t)$. This preserves reality and imposes a controlled kinetic energy spectrum.\n\n- The spectral filter must be a superposition that isolates mesoscale energy and includes physically plausible background components:\n$$\nF(k,t) = a_{\\text{meso}}(t)\\, \\exp\\left(-\\frac{(k - k_0)^2}{2\\sigma_k^2}\\right) + a_{\\text{bg}}\\,\\exp\\left(-\\left(\\frac{k}{k_{\\text{bg}}}\\right)^2\\right) + a_{\\text{small}},\n$$\nwhere $k_0$ is the mesoscale band center, $\\sigma_k$ is the band width, $a_{\\text{bg}}$ controls large-scale background, $k_{\\text{bg}}$ is a large-scale cutoff, and $a_{\\text{small}}$ is a small-scale component. The time dependence $a_{\\text{meso}}(t)$ distinguishes the scenarios and must be chosen to create equilibrium and non-equilibrium cases.\n\nUnits and discretization requirements.\n\n- Velocities $u$ and $v$ must be treated in meters per second. Lengths must be in meters. Time must be in seconds. Wavenumbers $k$ are in radians per meter. Isotropic spectra $E(k)$ and mesoscale variance $V_{\\text{meso}}(t)$ must have units of $\\mathrm{m}^2/\\mathrm{s}^2$.\n\nAlgorithmic tasks.\n\n- Implement discrete Fourier transforms with correct normalization so that the Parseval relation connects spatial and spectral energy consistently.\n- Construct isotropic spectra by binning the two-dimensional spectral kinetic energy density in $k$-annuli with bin width equal to the minimum wavenumber increment.\n- Compute the spectral stabilization metric $D_{\\text{spec}}$ and the mesoscale plateau metric $\\mathrm{CV}_{\\text{meso}}$.\n- Return a boolean for each test case indicating whether both conditions hold.\n\nTest suite and parameters.\n\nYou must implement exactly the following three test cases. In all cases, set $N_x = N_y = 128$, $d_x = d_y = 5\\times 10^3$ (meters), $L_x = L_y = N_x d_x$, $k_0 = \\frac{2\\pi}{5\\times 10^4}$, $\\sigma_k = 4\\times 10^{-5}$, $a_{\\text{bg}} = 0.3$, $k_{\\text{bg}} = \\frac{2\\pi}{2\\times 10^5}$, $a_{\\text{small}} = 0.08$, $L_{\\min} = 1\\times 10^4$ (meters), and $L_{\\max} = 1\\times 10^5$ (meters). For all cases, the time step is $d_t = 3.6\\times 10^3$ (seconds). All thresholds must be decimals: $\\varepsilon_{\\text{spec}} = 0.1$ and $\\varepsilon_{\\text{cv}} = 0.05$.\n\n- Case A (equilibrated): $T = 40$, window length $W = 12$, and $a_{\\text{meso}}(t) = a_{\\max} \\left(1 - e^{-t/\\tau}\\right)$ with $a_{\\max} = 3.0$ and $\\tau = 10$. This produces spin-up followed by saturation.\n\n- Case B (borderline but equilibrated): $T = 40$, $W = 12$, and $a_{\\text{meso}}(t) = a_{\\max} \\left(1 - e^{-t/\\tau}\\right)\\left(1 + \\delta \\sin\\left(\\frac{2\\pi t}{T_{\\text{osc}}}\\right)\\right)$ with $a_{\\max} = 2.5$, $\\tau = 10$, $\\delta = 0.03$, and $T_{\\text{osc}} = 12$. This adds small quasi-periodic variability around a saturated state.\n\n- Case C (non-equilibrium): $T = 40$, $W = 12$, and $a_{\\text{meso}}(t) = a_0 + r t$ with $a_0 = 0.05$ and $r = 0.05$. This produces persistent growth without saturation.\n\nFinal output format.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the above test cases. For example, if the results are true, false, and true, the output must be exactly \"[True,False,True]\".",
            "solution": "### 1. Fundamental Principles\nThe core of the problem lies in diagnosing the statistical equilibrium of a turbulent velocity field, a state often referred to as \"spin-up\" in ocean modeling. This state is not static but statistically stationary, meaning its statistical properties, such as the mean kinetic energy and its distribution across different spatial scales, no longer exhibit a secular trend. The provided methodology is grounded in the principles of Fourier analysis and statistical mechanics as applied to fluid dynamics.\n\n- **Kinetic Energy and Parseval's Theorem**: The total kinetic energy per unit mass in a 2D domain is given by $K(t) = \\frac{1}{2} \\langle u(x,y,t)^2 + v(x,y,t)^2 \\rangle$, where $\\langle \\cdot \\rangle$ denotes a spatial average. For a discrete grid of size $N_x \\times N_y$, this is $K(t) = \\frac{1}{2 N_x N_y} \\sum_{i,j} (u_{ij}^2 + v_{ij}^2)$. Parseval's theorem provides an equivalent representation in Fourier space. Let $\\hat{u}$ and $\\hat{v}$ be the discrete Fourier transforms of $u$ and $v$. The theorem, adapted for the normalization used by libraries like NumPy, states $\\sum_{i,j} |f_{ij}|^2 = \\frac{1}{N_x N_y} \\sum_{m,n} |\\hat{f}_{mn}|^2$. Applying this, the kinetic energy is:\n$$\nK(t) = \\frac{1}{2(N_x N_y)^2} \\sum_{m,n} (|\\hat{u}_{mn}(t)|^2 + |\\hat{v}_{mn}(t)|^2)\n$$\nThis equation establishes the fundamental link between physical space energy and its spectral distribution. The term $E_{mn} = \\frac{1}{2(N_x N_y)^2} (|\\hat{u}_{mn}(t)|^2 + |\\hat{v}_{mn}(t)|^2)$ can be interpreted as the kinetic energy associated with the single Fourier mode $(m,n)$.\n\n- **Isotropic Kinetic Energy Spectrum $E(k,t)$**: In many turbulent systems, energy distribution is assumed to be isotropic, depending only on the magnitude of the wavenumber vector, $k = \\sqrt{k_x^2 + k_y^2}$. The one-dimensional spectrum $E(k,t)$ is constructed by aggregating the energy from all 2D modes $(k_x, k_y)$ that fall within a specific range of magnitudes. We partition the $k$-axis into bins and sum the energy $E_{mn}$ for all modes whose wavenumber magnitude $k$ falls into each bin. According to the problem's specification, the resulting binned spectrum $E(k_i, t)$ for bin $i$ has units of energy, $\\mathrm{m}^2/\\mathrm{s}^2$, and the total kinetic energy is approximately the sum over all bins, $K(t) \\approx \\sum_i E(k_i, t)$.\n\n### 2. Algorithmic Design\n\n**Step 2.1: Domain and Wavenumber Grid Setup**\nThe physical domain is of size $L_x \\times L_y$ with $N_x \\times N_y$ grid points, where $L_x = N_x d_x$ and $L_y = N_y d_y$. The corresponding wavenumbers are $k_x = 2\\pi m / L_x$ for $m \\in \\{-N_x/2, \\dots, N_x/2-1\\}$ and $k_y = 2\\pi n / L_y$ for $n \\in \\{-N_y/2, \\dots, N_y/2-1\\}$. These are readily generated using functions like `numpy.fft.fftfreq`. From these, we compute the 2D grid of wavenumber magnitudes $k_{mn} = \\sqrt{k_x^2(m) + k_y^2(n)}$.\n\n**Step 2.2: Synthetic Velocity Field Generation**\nFor each time step $t$, we generate velocity fields with a prescribed spectral shape.\n1. Create two random real-valued fields, $u_0(x,y,t)$ and $v_0(x,y,t)$, using a standard normal distribution. We enforce a zero mean by subtracting the spatial average from each.\n2. Compute their 2D Fourier transforms, $\\hat{u}_0(k_x,k_y,t)$ and $\\hat{v}_0(k_x,k_y,t)$.\n3. Define the time- and scale-dependent spectral filter $F(k,t)$:\n$$\nF(k,t) = a_{\\text{meso}}(t)\\, \\exp\\left(-\\frac{(k - k_0)^2}{2\\sigma_k^2}\\right) + a_{\\text{bg}}\\,\\exp\\left(-\\left(\\frac{k}{k_{\\text{bg}}}\\right)^2\\right) + a_{\\text{small}}\n$$\n   This filter shapes the spectrum with a mesoscale energy peak (first term), a large-scale background contribution (second term), and a white noise floor for small scales (third term). The time evolution is controlled by $a_{\\text{meso}}(t)$, which varies between test cases to simulate equilibrium, borderline, and non-equilibrium scenarios.\n4. Apply the filter to the Fourier-transformed random fields: $\\hat{u} = \\hat{u}_0 F(k,t)$ and $\\hat{v} = \\hat{v}_0 F(k,t)$.\n5. The final velocity fields $u(x,y,t)$ and $v(x,y,t)$ are obtained by applying the inverse 2D Fourier transform to $\\hat{u}$ and $\\hat{v}$. The reality of the output is guaranteed as the filter $F(k,t)$ is real and symmetric with respect to $k$, preserving the Hermitian symmetry of the Fourier-transformed real fields.\n\n**Step 2.3: Isotropic Spectrum Calculation**\nFor each time step $t$:\n1. Calculate the 2D kinetic energy spectral density matrix: $E_{2D}(k_x, k_y, t) = \\frac{1}{2(N_x N_y)^2} (|\\hat{u}(k_x,k_y,t)|^2 + |\\hat{v}(k_x,k_y,t)|^2)$.\n2. Define bins for the 1D spectrum. The bin width is set to the minimum wavenumber increment, $\\Delta k = 2\\pi/L_x$. The bins cover the range from $k=0$ to the maximum wavenumber on the grid.\n3. Sum the values in $E_{2D}$ over all modes $(k_x, k_y)$ whose magnitude $k$ falls within each bin. This operation yields the isotropic binned spectrum, $E(k_i, t)$. This can be efficiently implemented using `scipy.stats.binned_statistic`.\n\n**Step 2.4: Evaluation of Equilibration Criteria**\nAfter generating time series of spectra $E(k_i, t)$ for $t \\in [0, T-1]$:\n1. **Spectral Stabilization ($D_{\\text{spec}})$**:\n   - Define the earlier and later time windows. With a total of $T=40$ steps and a window length of $W=12$, the later window spans time steps $[28, 39]$ and the earlier window spans $[16, 27]$.\n   - Compute the time-averaged spectra over these two windows:\n     $\\overline{E}_1(k) = \\frac{1}{W}\\sum_{t=T-2W}^{T-W-1} E(k,t)$\n     $\\overline{E}_2(k) = \\frac{1}{W}\\sum_{t=T-W}^{T-1} E(k,t)$\n   - Calculate the relative spectral change metric:\n     $$\n     D_{\\text{spec}} = \\frac{\\sqrt{\\sum_{k} \\left(\\overline{E}_2(k) - \\overline{E}_1(k)\\right)^2}}{\\sqrt{\\sum_{k} \\overline{E}_2(k)^2}}\n     $$\n   - The condition for spectral stabilization is $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$, where $\\varepsilon_{\\text{spec}} = 0.1$.\n\n2. **Mesoscale Plateau ($\\mathrm{CV}_{\\text{meso}})$**:\n   - First, identify the wavenumber bins corresponding to the mesoscale band $[k_{\\min}^{\\text{meso}}, k_{\\max}^{\\text{meso}}]$, where $k_{\\min}^{\\text{meso}} = 2\\pi/L_{\\max}$ and $k_{\\max}^{\\text{meso}} = 2\\pi/L_{\\min}$.\n   - For each time step $t$, compute the mesoscale variance by summing the spectral energy over these bins: $V_{\\text{meso}}(t) = \\sum_{k_i \\in \\text{mesoscale}} E(k_i, t)$.\n   - Using the time series of $V_{\\text{meso}}(t)$ from the later window ($t \\in [T-W, T-1]$), compute its mean and standard deviation.\n   - The coefficient of variation is then:\n     $$\n     \\mathrm{CV}_{\\text{meso}} = \\frac{\\mathrm{std}\\left(V_{\\text{meso}}(t)\\right)}{\\mathrm{mean}\\left(V_{\\text{meso}}(t)\\right)}\n     $$\n   - The condition for a plateau is $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$, where $\\varepsilon_{\\text{cv}} = 0.05$.\n\nFinally, the model is declared to be in equilibrium if and only if both conditions, $D_{\\text{spec}} \\leq \\varepsilon_{\\text{spec}}$ and $\\mathrm{CV}_{\\text{meso}} \\leq \\varepsilon_{\\text{cv}}$, are met. This procedure is repeated for each of the three test cases (A, B, C), which are distinguished by the functional form of $a_{\\text{meso}}(t)$, designed to test equilibrated, borderline, and non-equilibrated scenarios, respectively.",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import binned_statistic\n\ndef solve():\n    \"\"\"\n    Designs and implements a spectral equilibration criterion for a 2D ocean model.\n    Generates synthetic velocity fields and applies the criterion to test scenarios.\n    \"\"\"\n\n    # For reproducibility of the random velocity fields\n    np.random.seed(42)\n\n    # Universal parameters\n    N_x, N_y = 128, 128\n    d_x = d_y = 5.0e3  # meters\n    L_x, L_y = N_x * d_x, N_y * d_y\n    \n    k0 = 2 * np.pi / 5.0e4\n    sigma_k = 4.0e-5\n    a_bg = 0.3\n    k_bg = 2 * np.pi / 2.0e5\n    a_small = 0.08\n    \n    L_min, L_max = 1.0e4, 1.0e5 # meters\n    k_meso_min = 2 * np.pi / L_max\n    k_meso_max = 2 * np.pi / L_min\n    \n    dt = 3.6e3  # seconds\n    T = 40  # Total number of time steps\n    W = 12  # Window length for averaging\n\n    eps_spec = 0.1\n    eps_cv = 0.05\n\n    # Define test cases\n    test_cases = [\n        {\n            \"name\": \"Case A (equilibrated)\",\n            \"a_meso_func\": lambda t: 3.0 * (1 - np.exp(-t / 10.0))\n        },\n        {\n            \"name\": \"Case B (borderline but equilibrated)\",\n            \"a_meso_func\": lambda t: 2.5 * (1 - np.exp(-t / 10.0)) * (1 + 0.03 * np.sin(2 * np.pi * t / 12.0))\n        },\n        {\n            \"name\": \"Case C (non-equilibrium)\",\n            \"a_meso_func\": lambda t: 0.05 + 0.05 * t\n        }\n    ]\n\n    results = []\n\n    # Pre-compute wavenumber grid\n    kx_1d = 2 * np.pi * np.fft.fftfreq(N_x, d=d_x)\n    ky_1d = 2 * np.pi * np.fft.fftfreq(N_y, d=d_y)\n    kx, ky = np.meshgrid(kx_1d, ky_1d, indexing='ij')\n    k_magnitude = np.sqrt(kx**2 + ky**2)\n    \n    # Define wavenumber bins for 1D spectrum\n    dk_min = 2 * np.pi / L_x\n    k_max_grid = np.max(k_magnitude)\n    k_bins = np.arange(0, k_max_grid + dk_min, dk_min)\n    k_bin_centers = (k_bins[:-1] + k_bins[1:]) / 2\n    num_k_bins = len(k_bin_centers)\n\n    for case in test_cases:\n        a_meso_func = case[\"a_meso_func\"]\n        \n        # Store time series of spectra and mesoscale variance\n        E_k_t = np.zeros((T, num_k_bins))\n        V_meso_t = np.zeros(T)\n\n        for t in range(T):\n            # 1. Generate synthetic velocity fields\n            u0 = np.random.randn(N_x, N_y)\n            v0 = np.random.randn(N_x, N_y)\n            u0 -= u0.mean()\n            v0 -= v0.mean()\n\n            u0_hat = np.fft.fft2(u0)\n            v0_hat = np.fft.fft2(v0)\n            \n            # 2. Construct and apply spectral filter\n            a_meso = a_meso_func(t)\n            F_k_t = (a_meso * np.exp(-(k_magnitude - k0)**2 / (2 * sigma_k**2)) +\n                     a_bg * np.exp(-(k_magnitude / k_bg)**2) +\n                     a_small)\n            \n            u_hat = u0_hat * F_k_t\n            v_hat = v0_hat * F_k_t\n            \n            # 3. Calculate 2D KE spectrum\n            # Factor of 0.5 for KE, (Nx*Ny)^-2 for Parseval's on FFT^2\n            E_2D = 0.5 / (N_x * N_y)**2 * (np.abs(u_hat)**2 + np.abs(v_hat)**2) \n            \n            # 4. Bin to create 1D isotropic spectrum E(k,t)\n            # The sum statistic ensures that E_k_t has units of energy (m^2/s^2)\n            E_k_t[t, :], _, _ = binned_statistic(\n                k_magnitude.flatten(), E_2D.flatten(), statistic='sum', bins=k_bins\n            )\n            \n            # 5. Calculate mesoscale variance V_meso(t)\n            meso_mask = (k_bin_centers = k_meso_min)  (k_bin_centers = k_meso_max)\n            V_meso_t[t] = np.sum(E_k_t[t, meso_mask])\n\n        # 6. Evaluate equilibration criteria\n        \n        # Spectral stabilization metric D_spec\n        E1_bar = np.mean(E_k_t[T - 2*W : T - W, :], axis=0)\n        E2_bar = np.mean(E_k_t[T - W : T, :], axis=0)\n        \n        # Handle potential division by zero if E2_bar is all zeros\n        norm_E2 = np.sqrt(np.sum(E2_bar**2))\n        if norm_E2  0:\n            D_spec = np.sqrt(np.sum((E2_bar - E1_bar)**2)) / norm_E2\n        else:\n            D_spec = np.inf if np.any(E1_bar  0) else 0.0\n\n        # Mesoscale plateau metric CV_meso\n        V_meso_later_window = V_meso_t[T - W : T]\n        mean_V_meso = np.mean(V_meso_later_window)\n        std_V_meso = np.std(V_meso_later_window)\n        \n        # Handle potential division by zero if mean is zero\n        CV_meso = std_V_meso / mean_V_meso if mean_V_meso  0 else np.inf\n        \n        # Final decision\n        is_equilibrated = (D_spec = eps_spec) and (CV_meso = eps_cv)\n        results.append(is_equilibrated)\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}