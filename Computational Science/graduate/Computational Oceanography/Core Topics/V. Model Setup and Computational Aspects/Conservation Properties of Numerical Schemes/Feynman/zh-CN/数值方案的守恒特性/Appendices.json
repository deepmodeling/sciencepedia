{
    "hands_on_practices": [
        {
            "introduction": "本节的第一个实践是一项基础的理论推导。在编写任何代码之前，理解一个数值格式为什么能够（或不能够）守恒一个量是至关重要的。这项练习将通过分析一个二维通量形式的离散格式，揭示离散守恒的核心数学原理——内部通量的对消。",
            "id": "3788105",
            "problem": "考虑二维空间中的标量示踪剂输运方程，其通量形式写作守恒律 $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$，该方程在一个均匀的笛卡尔网格上进行离散化，该网格在 $x$ 方向上有 $N$ 个单元，在 $y$ 方向上有 $M$ 个单元，网格间距分别为 $\\Delta x$ 和 $\\Delta y$。设单元中心的索引为 $(i,j)$，其中 $i \\in \\{1,\\dots,N\\}$ 且 $j \\in \\{1,\\dots,M\\}$。面法向速度定义在单元面上，东-西向面上的速度为 $u_{i+1/2,j}$，南-北向面上的速度为 $v_{i,j+1/2}$。定义时间层 $n$ 上的中心面通量为\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2},\n$$\n对于所有内部面，并令 $F_{1/2,j}$、$F_{N+1/2,j}$、$G_{i,1/2}$ 和 $G_{i,M+1/2}$ 表示区域边界面上相应的通量（由边界条件确定）。考虑显式欧拉更新\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\n对于所有内部单元 $(i,j)$，其中 $\\Delta t$ 是时间步长。\n\n定义时间层 $n$ 上的离散全局总量为\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}.\n$$\n以闭合形式精确计算单步变化量 $\\Delta S \\equiv S^{n+1} - S^{n}$，该表达式仅用 $\\Delta t$、$\\Delta x$、$\\Delta y$ 以及边界通量 $F_{1/2,j}$、$F_{N+1/2,j}$、$G_{i,1/2}$ 和 $G_{i,M+1/2}$ 来表示。然后，根据您的推导，说明在该格式能达到机器精度下精确守恒（即 $\\Delta S = 0$）时，所需要满足的边界条件和离散算子条件。\n\n您的最终答案必须是所要求的 $\\Delta S$ 的单一闭合形式表达式。不需要进行数值计算，也不需要四舍五入。不要包含任何单位。",
            "solution": "出发点是离散的通量形式更新，它在一个均匀网格上近似了连续守恒律 $\\partial_{t} q + \\nabla \\cdot (\\boldsymbol{u} q) = 0$。在每个内部单元 $(i,j)$ 上的显式欧拉更新为\n$$\nq^{n+1}_{i,j} \\;=\\; q^{n}_{i,j} \\;-\\; \\Delta t \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right],\n$$\n其中 $F_{i+1/2,j}$ 和 $G_{i,j+1/2}$ 是位于两个相邻单元之间或区域边界上的面上的单值通量。这些通量是通过使用相邻单元中心的 $q$ 的中心平均值以及相同面上的面法向速度来构建的：\n$$\nF_{i+1/2,j} \\equiv u_{i+1/2,j} \\,\\frac{q^{n}_{i+1,j} + q^{n}_{i,j}}{2}, \\qquad\nG_{i,j+1/2} \\equiv v_{i,j+1/2} \\,\\frac{q^{n}_{i,j+1} + q^{n}_{i,j}}{2}.\n$$\n定义离散全局总量\n$$\nS^{n} \\equiv \\sum_{i=1}^{N} \\sum_{j=1}^{M} q^{n}_{i,j}, \\qquad \\Delta S \\equiv S^{n+1} - S^{n}.\n$$\n对所有内部单元的更新进行求和，得到\n\\begin{align*}\n\\Delta S \\;=\\; \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( q^{n+1}_{i,j} - q^{n}_{i,j} \\right) \\\\\n=\\; - \\Delta t \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left[ \\frac{F_{i+1/2,j} - F_{i-1/2,j}}{\\Delta x} \\;+\\; \\frac{G_{i,j+1/2} - G_{i,j-1/2}}{\\Delta y} \\right].\n\\end{align*}\n由于 $\\Delta x$ 和 $\\Delta y$ 是常数，我们重新组织求和：\n\\begin{align*}\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right).\n\\end{align*}\n每个内部求和都是一个离散的伸缩求和。对于固定的 $j$，关于 $x$ 方向通量的求和为，\n$$\n\\sum_{i=1}^{N} \\left( F_{i+1/2,j} - F_{i-1/2,j} \\right) \\;=\\; F_{N+1/2,j} - F_{1/2,j}.\n$$\n类似地，对于固定的 $i$，关于 $y$ 方向通量的求和为，\n$$\n\\sum_{j=1}^{M} \\left( G_{i,j+1/2} - G_{i,j-1/2} \\right) \\;=\\; G_{i,M+1/2} - G_{i,1/2}.\n$$\n因此，离散全局总量的单步变化量精确地为\n$$\n\\Delta S \\;=\\; - \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) \\;-\\; \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right).\n$$\n该表达式仅依赖于边界面的通量。由此可知，在以下条件下，该格式在离散全局总量上是精确守恒的，即 $\\Delta S = 0$ 达到机器精度：\n- 在 $x$ 方向和/或 $y$ 方向上采用周期性边界条件，这意味着 $F_{N+1/2,j} = F_{1/2,j}$ 和/或 $G_{i,M+1/2} = G_{i,1/2}$，从而使相应的求和为零。\n- 不可穿透（无法向流）边界条件，这要求 $u_{1/2,j} = u_{N+1/2,j} = 0$ 和 $v_{i,1/2} = v_{i,M+1/2} = 0$，因此 $F_{1/2,j} = F_{N+1/2,j} = 0$ 和 $G_{i,1/2} = G_{i,M+1/2} = 0$。\n- 更一般地，任何强制边界净通量为零的边界条件，即 $\\frac{1}{\\Delta x}\\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) + \\frac{1}{\\Delta y}\\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right) = 0$。\n\n守恒性质的产生是因为离散更新采用通量形式，相邻单元共享单值面通量，因此在全局求和时，内部贡献项会完全抵消，只留下边界贡献项。显式欧拉时间积分不改变这种抵消，因为它将离散散度项统一乘以 $\\Delta t$，而没有混合不同空间位置的项。",
            "answer": "$$\\boxed{- \\frac{\\Delta t}{\\Delta x} \\sum_{j=1}^{M} \\left( F_{N+1/2,j} - F_{1/2,j} \\right) - \\frac{\\Delta t}{\\Delta y} \\sum_{i=1}^{N} \\left( G_{i,M+1/2} - G_{i,1/2} \\right)}$$"
        },
        {
            "introduction": "在从理论上理解了守恒格式的结构之后，下一步是在计算实践中验证这一特性。本练习要求您为一个在非结构化网格上运行的有限体积平流格式编写代码，并验证一个闭合子域的质量收支平衡。这个过程不仅能加深您对局部守恒如何确保更大尺度守恒的理解，还为您提供了一个在开发和验证复杂海洋模型时进行“健全性检查”的模板。",
            "id": "3788063",
            "problem": "考虑一个示踪剂在非结构化网格上于不可压缩的海洋流中被平流输运。每个控制体的示踪剂质量定义为 $m_i = \\rho V_i q_i$，其中 $\\rho$ 是恒定的流体密度，$V_i$ 是单元 $i$ 的体积，$q_i$ 是单元 $i$ 中无量纲的示踪剂质量分数。其基本控制原理是控制体内无源标量的积分守恒定律，该定律源于质量守恒和速度场的无散特性：控制体内质量的时间变化率等于通过其边界的净平流通量。在一个采用显式时间步进和迎风格式面状态的有限体积（FV）守恒离散化方法中，跨每个共享面的质量交换只计算一次，然后以相反的符号加到相邻单元中，以确保局部守恒。\n\n给定一个二维空间中的小型非结构化网格。单元的索引从 $0$ 到 $4$，体积单位为 $\\mathrm{m}^3$；面是相邻单元对，具有相关的面面积（单位为 $\\mathrm{m}^2$）和一个从左侧单元指向右侧单元的向外单位法向量。速度的法向分量决定了迎风侧。对于连接单元 $L$ 和 $R$ 的面，若其法向量 $\\boldsymbol{n}_f$ 从 $L$ 指向 $R$，则通过该面的标量通量由迎风面值 $q_{\\text{up}}$ 决定，该值选自其速度在 $\\boldsymbol{n}_f$ 上投影为正的单元；如果 $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f = 0$，则该面的质量通量为零。通过面 $f$ 的质量通量为 $F_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u}\\cdot\\boldsymbol{n}_f) \\, A_f$，单位为 $\\mathrm{kg}\\,\\mathrm{s}^{-1}$，其中 $A_f$ 是面面积。一个大小为 $\\Delta t$ 的单次显式时间步通过累积带符号的面通量贡献来更新单元质量。\n\n定义一个封闭子域 $\\mathcal{S}$ 为索引集合 $\\{1,2,3\\}$。$\\mathcal{S}$ 的边界由连接 $\\mathcal{S}$ 内单元与 $\\mathcal{S}$ 外单元的面组成。子域边界的向外方向定义为：如果面法向量 $\\boldsymbol{n}_f$ 从 $\\mathcal{S}$ 内的单元指向 $\\mathcal{S}$ 外的单元，则计为正；否则计为负。经过一个时间步后，$\\mathcal{S}$ 的质量收支应满足封闭子域守恒属性：当使用与单元更新相同的面通量进行一致性评估时，$\\mathcal{S}$ 的总质量变化等于净向外边界通量乘以时间步长的负值。\n\n您的任务是实现一个程序，对下面的每个测试用例，在给定的网格上使用迎风通量执行一次显式有限体积平流更新，计算 $\\mathcal{S}$ 中的总质量变化，使用相同的面通量计算 $\\mathcal{S}$ 的净向外边界通量，并通过评估残差来验证闭合性\n$$\nR = \\left(\\sum_{i\\in \\mathcal{S}} m_i^{n+1} - \\sum_{i\\in \\mathcal{S}} m_i^{n}\\right) + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f,\n$$\n其中，如果 $\\boldsymbol{n}_f$ 从 $\\mathcal{S}$ 指向其外部，则 $s_f$ 为 $+1$，否则为 $-1$。残差 $R$ 必须以 $\\mathrm{kg}$ 为单位进行评估。对于每个测试用例，返回一个布尔值，指示 $|R|$ 是否小于指定的绝对容差 $10^{-8}$ $\\mathrm{kg}$。\n\n网格规格：\n- 单元 $[0,1,2,3,4]$ 的体积 $V = [10^6,\\,10^6,\\,10^6,\\,10^6,\\,10^6]$，单位为 $\\mathrm{m}^3$。\n- 面 $f_0=(0,1)$、$f_1=(1,2)$、$f_2=(2,3)$、$f_3=(3,4)$。\n- 面面积 $A_{f_0}=10^4$、$A_{f_1}=10^4$、$A_{f_2}=10^4$、$A_{f_3}=10^4$，单位为 $\\mathrm{m}^2$。\n- 每个面 $f_k$ 的法向量为 $\\boldsymbol{n}_{f_k}=(1,0)$，方向从索引较低的单元指向索引较高的单元。\n- 密度 $\\rho = 1025$，单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n- 初始示踪剂质量分数 $q = [0.035,\\,0.032,\\,0.030,\\,0.028,\\,0.027]$（无量纲）。\n- 子域 $\\mathcal{S} = \\{1,2,3\\}$。\n\n测试套件：\n- 案例 1（正常路径）：$\\boldsymbol{u}=(0.5,\\,0.1)$，单位为 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 600$，单位为 $\\mathrm{s}$。\n- 案例 2（零流速）：$\\boldsymbol{u}=(0,\\,0)$，单位为 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 600$，单位为 $\\mathrm{s}$。\n- 案例 3（与面相切）：$\\boldsymbol{u}=(0,\\,1.0)$，单位为 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 1000$，单位为 $\\mathrm{s}$。\n- 案例 4（大时间步）：$\\boldsymbol{u}=(2.0,\\,0)$，单位为 $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 5000$，单位为 $\\mathrm{s}$。\n\n本问题不使用角度量。所有物理量必须以上述指定单位处理，残差必须以 $\\mathrm{kg}$ 为单位进行评估。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如 $[result_1,result_2,result_3,result_4]$，其中每个 $result_k$ 是一个布尔值，表示封闭子域的质量收支是否在指定的绝对容差内得到满足。不应打印其他任何文本。",
            "solution": "此问题经过了严格的验证过程。\n\n### 第 1 步：提取已知条件\n- **控制原理**：控制体内质量的时间变化率等于通过其边界的净平流质量通量。\n- **离散化**：有限体积（FV）法，显式时间步进，迎风格式面状态。\n- **示踪剂质量**：$m_i = \\rho V_i q_i$，其中 $\\rho$ 是恒定密度，$V_i$ 是单元 $i$ 的体积，$q_i$ 是无量纲的示踪剂质量分数。\n- **质量通量**：面通量为 $F_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u}\\cdot\\boldsymbol{n}_f) \\, A_f$，其中 $A_f$ 是面面积，$\\boldsymbol{n}_f$ 是面法向量，$q_{\\text{up}}$ 是迎风质量分数。对于法向量从单元 $L$ 指向 $R$ 的面，如果 $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f > 0$，则 $q_{\\text{up}}=q_L$；如果 $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f  0$，则 $q_{\\text{up}}=q_R$。如果 $\\boldsymbol{u}\\cdot\\boldsymbol{n}_f=0$，则通量为 $0$。\n- **质量更新**：质量交换是守恒的；通量计算一次后以相反符号应用于相邻单元。\n- **子域**：$\\mathcal{S} = \\{1,2,3\\}$。\n- **子域边界**：连接 $\\mathcal{S}$ 内单元与 $\\mathcal{S}$ 外单元的面。\n- **边界符号约定**：如果 $\\boldsymbol{n}_f$ 从 $\\mathcal{S}$ 指向其外部，则 $s_f = +1$；否则为 $-1$。\n- **残差定义**：$R = \\left(\\sum_{i\\in \\mathcal{S}} m_i^{n+1} - \\sum_{i\\in \\mathcal{S}} m_i^{n}\\right) + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f$。\n- **验证任务**：对每个测试用例，判断是否 $|R|  10^{-8}$ kg。\n- **网格数据**：\n    - 单元索引：$0, 1, 2, 3, 4$。\n    - 单元体积：$V = [10^6,\\,10^6,\\,10^6,\\,10^6,\\,10^6]$ $\\mathrm{m}^3$。\n    - 面：$f_0=(0,1)$、$f_1=(1,2)$、$f_2=(2,3)$、$f_3=(3,4)$。\n    - 面面积：所有 $k$ 的 $A_{f_k}=10^4$ $\\mathrm{m}^2$。\n    - 面法向量：所有 $k$ 的 $\\boldsymbol{n}_{f_k}=(1,0)$，方向从索引较低的单元指向索引较高的单元。\n- **物理常数和初始条件**：\n    - 密度：$\\rho = 1025$ $\\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n    - 初始质量分数：$q = [0.035,\\,0.032,\\,0.030,\\,0.028,\\,0.027]$。\n- **测试套件**：\n    - 案例 1：$\\boldsymbol{u}=(0.5,\\,0.1)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 600$ $\\mathrm{s}$。\n    - 案例 2：$\\boldsymbol{u}=(0,\\,0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 600$ $\\mathrm{s}$。\n    - 案例 3：$\\boldsymbol{u}=(0,\\,1.0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 1000$ $\\mathrm{s}$。\n    - 案例 4：$\\boldsymbol{u}=(2.0,\\,0)$ $\\mathrm{m}\\,\\mathrm{s}^{-1}$，$\\Delta t = 5000$ $\\mathrm{s}$。\n- **容差**：$10^{-8}$ $\\mathrm{kg}$。\n\n### 第 2 步：使用提取的已知条件进行验证\n该问题在科学上基于连续介质力学原理（质量守恒）和偏微分方程的数值方法（有限体积法）。其表述客观、自洽且数学上一致。所定义的任务是对数值格式固有的守恒属性进行直接验证，这是计算流体动力学代码验证中的一个标准程序。所提供的数据完整且物理上合理。对于验证任务而言，该问题是适定的。未发现任何缺陷。\n\n### 第 3 步：结论与行动\n该问题被判定为**有效**。将提供完整解答。\n\n### 基于原理的求解\n本问题的基本原理是质量守恒，具体表现为数值有限体积（FV）格式。守恒 FV 格式的一个关键属性是，在一组控制体内的守恒量（此处为示踪剂质量 $m$）的变化，完全由穿过该组控制体边界的净通量来解释。本问题要求对子域 $\\mathcal{S}$ 直接验证此属性。\n\n在初始时刻 $t^n$，单元 $i$ 中的总质量为 $m_i^n = \\rho V_i q_i^n$。在一个时间步 $\\Delta t$ 内的质量更新是通过对连接到该单元的所有面的贡献求和来完成的。对于连接“左”单元 $L$ 和“右”单元 $R$ 的一个通用面 $f$，其法向量 $\\boldsymbol{n}_f$ 从 $L$ 指向 $R$，质量通量 $F_f$ 定义为：\n$$\nF_f = \\rho \\, q_{\\text{up}} \\, (\\boldsymbol{u} \\cdot \\boldsymbol{n}_f) \\, A_f\n$$\n一个正的通量 $F_f$ 表示质量从单元 $L$ 到单元 $R$ 的净转移。单元中的质量根据以下公式更新：\n$$\nm_L^{n+1} = m_L^n - \\Delta t F_f\n$$\n$$\nm_R^{n+1} = m_R^n + \\Delta t F_f\n$$\n这种公式确保了单元 $L$ 损失的质量由单元 $R$ 获得，这一特性被称为局部守恒。\n\n一个时间步后，子域 $\\mathcal{S} = \\{1, 2, 3\\}$ 内的总质量变化是其组成单元质量变化的总和：\n$$\n\\Delta M_{\\mathcal{S}} = \\sum_{i \\in \\mathcal{S}} (m_i^{n+1} - m_i^n) = (m_1^{n+1} - m_1^n) + (m_2^{n+1} - m_2^n) + (m_3^{n+1} - m_3^n)\n$$\n$\\mathcal{S}$ 中的单元通过内部面（$f_1$、$f_2$）和边界面（$f_0$、$f_3$）相连。\n- 单元 $1$ 通过面 $f_0=(0,1)$ 和 $f_1=(1,2)$ 与单元 $0$ 和 $2$ 相连。其质量变化为 $\\Delta m_1 = \\Delta t (F_{f_0} - F_{f_1})$。\n- 单元 $2$ 通过面 $f_1=(1,2)$ 和 $f_2=(2,3)$ 与单元 $1$ 和 $3$ 相连。其质量变化为 $\\Delta m_2 = \\Delta t (F_{f_1} - F_{f_2})$。\n- 单元 $3$ 通过面 $f_2=(2,3)$ 和 $f_3=(3,4)$ 与单元 $2$ 和 $4$ 相连。其质量变化为 $\\Delta m_3 = \\Delta t (F_{f_2} - F_{f_3})$。\n\n将这些变化相加，可得到内部通量的伸缩级数：\n$$\n\\Delta M_{\\mathcal{S}} = \\Delta t [ (F_{f_0} - F_{f_1}) + (F_{f_1} - F_{f_2}) + (F_{f_2} - F_{f_3}) ] = \\Delta t (F_{f_0} - F_{f_3})\n$$\n子域中的总质量变化仅由其边界 $\\partial\\mathcal{S} = \\{f_0, f_3\\}$ 上的通量决定。\n\n问题定义了一个残差 $R$ 来验证这种闭合性：\n$$\nR = \\Delta M_{\\mathcal{S}} + \\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f\n$$\n我们必须确定符号 $s_f$。\n- 对于面 $f_0=(0,1)$，法向量 $\\boldsymbol{n}_{f_0}$ 从 $\\mathcal{S}$ 外部（单元 $0$）指向 $\\mathcal{S}$ 内部（单元 $1$）。根据符号约定，这是一个向内的法向量，因此 $s_{f_0} = -1$。\n- 对于面 $f_3=(3,4)$，法向量 $\\boldsymbol{n}_{f_3}$ 从 $\\mathcal{S}$ 内部（单元 $3$）指向 $\\mathcal{S}$ 外部（单元 $4$）。这是一个向外的法向量，因此 $s_{f_3} = +1$。\n\n因此，边界通量项为 $\\Delta t \\sum_{f\\in \\partial\\mathcal{S}} s_f F_f = \\Delta t (-F_{f_0} + F_{f_3})$。\n将此式和 $\\Delta M_{\\mathcal{S}}$ 的表达式代入残差方程：\n$$\nR = \\Delta t(F_{f_0} - F_{f_3}) + \\Delta t(-F_{f_0} + F_{f_3}) = 0\n$$\n理论上，残差必须精确为零。编程任务是为每个测试用例实现计算，并验证计算出的残差在指定的浮点容差 $10^{-8}$ 内为零。此属性与具体的速度 $\\boldsymbol{u}$ 或时间步 $\\Delta t$ 无关，因为它是该格式守恒结构的代数结果。\n\n每个测试用例的实现将按以下步骤进行：\n1.  定义所有网格、初始条件和物理常数的数据结构。\n2.  计算所有单元 $i=0, ..., 4$ 的初始质量 $m_i^n = \\rho V_i q_i$。\n3.  计算子域中的初始总质量 $M_{\\mathcal{S}}^n = \\sum_{i \\in \\mathcal{S}} m_i^n$。\n4.  对于每个面 $f_k=(L,R)$，计算面法向速度 $\\boldsymbol{u} \\cdot \\boldsymbol{n}_{f_k}$，确定迎风质量分数 $q_{\\text{up}}$，并计算质量通量 $F_{f_k}$。存储这些通量。\n5.  使用存储的通量更新所有单元的质量，以求得 $m_i^{n+1}$。\n6.  计算子域中的最终总质量 $M_{\\mathcal{S}}^{n+1} = \\sum_{i \\in \\mathcal{S}} m_i^{n+1}$。\n7.  子域中的质量变化为 $\\Delta M_{\\mathcal{S}} = M_{\\mathcal{S}}^{n+1} - M_{\\mathcal{S}}^n$。\n8.  计算残差的边界通量分量 $B = \\Delta t (-F_{f_0} + F_{f_3})$。\n9.  计算最终残差 $R = \\Delta M_{\\mathcal{S}} + B$。\n10. 检查是否 $|R|  10^{-8}$ 并记录布尔结果。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and verifies the closed-subdomain conservation property for a\n    Finite Volume advection scheme on a simple unstructured mesh.\n    \"\"\"\n    # --- Define Static Problem Parameters ---\n\n    # Physical constant\n    rho = 1025.0  # kg/m^3\n\n    # Mesh geometry and initial conditions\n    V = np.array([1e6, 1e6, 1e6, 1e6, 1e6])  # Cell volumes in m^3\n    q_initial = np.array([0.035, 0.032, 0.030, 0.028, 0.027])  # Dimensionless tracer mass fraction\n\n    # Face definitions: {Left cell, Right cell, Area, Normal vector}\n    faces = [\n        {'L': 0, 'R': 1, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 1, 'R': 2, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 2, 'R': 3, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n        {'L': 3, 'R': 4, 'A': 1e4, 'n': np.array([1.0, 0.0])},\n    ]\n\n    # Subdomain S and its boundary face information\n    subdomain_S_indices = [1, 2, 3]\n    \n    # Boundary faces are those connecting S to its exterior.\n    # The sign s_f is +1 if the normal points out of S, -1 otherwise.\n    # Face 0 (0-1): normal points into S - s_f = -1\n    # Face 3 (3-4): normal points out of S - s_f = +1\n    boundary_faces_info = {\n        0: -1.0,  # Face index and its sign s_f\n        3: 1.0\n    }\n\n    # Test suite\n    test_cases = [\n        {'u': np.array([0.5, 0.1]), 'dt': 600.0},\n        {'u': np.array([0.0, 0.0]), 'dt': 600.0},\n        {'u': np.array([0.0, 1.0]), 'dt': 1000.0},\n        {'u': np.array([2.0, 0.0]), 'dt': 5000.0},\n    ]\n\n    tolerance = 1e-8\n    results = []\n\n    # --- Iterate Through Test Cases ---\n    for case in test_cases:\n        u_vel = case['u']\n        dt = case['dt']\n        \n        # Calculate initial masses for all cells\n        m_n = rho * V * q_initial\n        \n        # Calculate initial total mass in subdomain S\n        m_S_n = np.sum(m_n[subdomain_S_indices])\n        \n        # Initialize new masses and array to store fluxes\n        m_np1 = m_n.copy()\n        face_fluxes = np.zeros(len(faces))\n\n        # --- Perform one explicit time step ---\n\n        # 1. Compute all face fluxes and update cell masses consistently\n        for i, face in enumerate(faces):\n            L, R = face['L'], face['R']\n            A, n_f = face['A'], face['n']\n            \n            # Project velocity onto the face normal\n            v_n = np.dot(u_vel, n_f)\n            \n            # Determine upwind tracer value based on flow direction\n            if v_n > 0:  # Flow from L to R, upwind is L\n                q_up = q_initial[L]\n            elif v_n  0:  # Flow from R to L, upwind is R\n                q_up = q_initial[R]\n            else:  # Zero normal flow\n                q_up = 0.0  # Flux will be zero\n\n            # Calculate mass flux F_f through the face (kg/s)\n            F_f = rho * q_up * v_n * A\n            face_fluxes[i] = F_f\n            \n            # Apply flux to update masses of adjacent cells (local conservation)\n            m_np1[L] -= dt * F_f\n            m_np1[R] += dt * F_f\n            \n        # --- Verify Subdomain Conservation ---\n        \n        # 2. Calculate the total mass change in subdomain S\n        m_S_np1 = np.sum(m_np1[subdomain_S_indices])\n        mass_change_in_S = m_S_np1 - m_S_n\n        \n        # 3. Calculate the net outward boundary flux term for S\n        boundary_flux_sum = 0.0\n        for face_idx, s_f in boundary_faces_info.items():\n            boundary_flux_sum += s_f * face_fluxes[face_idx]\n        \n        # 4. Compute the residual R as defined in the problem\n        # R = (change in total mass) + dt * (net outward signed boundary flux)\n        residual = mass_change_in_S + dt * boundary_flux_sum\n        \n        # 5. Check if the absolute residual is within the specified tolerance\n        is_conserved = abs(residual)  tolerance\n        results.append(is_conserved)\n\n    # Print the final results in the required format\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "虽然许多格式被设计为精确守恒，但另一些出于稳定性或效率考虑而广泛使用的格式（如半拉格朗日法）本身并不守恒。本练习将探讨这种情况下的一个实际问题：如何诊断和修复非守恒格式产生的质量误差。您将通过计算一个全局质量修正项来恢复守恒，这是确保长期模拟物理真实性的常用且关键的技术。",
            "id": "3788093",
            "problem": "考虑一种由平流方程控制且无源汇的海洋示踪剂，因此在一个封闭的海洋域中，瞬时全球示踪剂质量由体积分 $M(t) = \\int_{\\Omega} q(\\mathbf{x}, t)\\, \\mathrm{d}V$ 给出，其中 $q$ 是示踪剂浓度，单位为 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$，$\\Omega$ 是海洋域。在精确的连续动力学中，对于纯平流、无辐散的流动，$M(t)$ 是随时间守恒的。然而，由于插值和重映误差，半拉格朗日 (SL) 数值平流步骤可能无法保持全球质量守恒。\n\n给定一个水平海洋域，它被离散化为 $N=4$ 个湿网格单元，其体积为 $\\{V_{i}\\}_{i=1}^{4}$，在上一时间层 $t^{n}$ 的示踪剂浓度记为 $\\{q_{i}^{n}\\}_{i=1}^{4}$。经过一个到达新时间层 $t^{n+1}$ 的 SL 示踪剂步骤后，你将获得更新后的浓度 $\\{q_{i}^{*}\\}_{i=1}^{4}$，这些浓度通常不满足全球质量守恒。你需要计算全球质量误差，然后应用一个全球质量修正器，该修正器为所有湿网格单元增加一个均匀的浓度增量 $\\delta$，使得校正后的浓度 $\\{q_{i}^{c}\\}_{i=1}^{4}$ (其中 $q_{i}^{c} = q_{i}^{*} + \\delta$) 能精确地恢复在 $t^{n}$ 时的初始全球质量。\n\n使用以下数据，这些数据对于大型海洋网格单元是科学上合理的：\n- 单元体积 (单位：$\\mathrm{m}^{3}$): $V_{1} = 1.20 \\times 10^{12}$, $V_{2} = 8.00 \\times 10^{11}$, $V_{3} = 1.50 \\times 10^{12}$, $V_{4} = 1.00 \\times 10^{12}$。\n- 在 $t^{n}$ 时的初始浓度 (单位：$\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $q_{1}^{n} = 2.000 \\times 10^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3}$。\n- 在 $t^{n+1}$ 时，修正前的 SL 步骤后浓度 (单位：$\\mathrm{kg}\\,\\mathrm{m}^{-3}$): $q_{1}^{*} = 1.990 \\times 10^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3}$。\n\n从纯平流的全球积分质量应不随时间变化这一基本陈述出发，从第一性原理推导出 SL 步骤后的全球质量误差表达式，以及当应用于所有湿网格单元时恢复守恒性的相应均匀校正量 $\\delta$。然后使用所提供的数据计算 $\\delta$ 的值。\n\n将 $\\delta$ 的最终数值结果四舍五入到四位有效数字。以 $\\mathrm{kg}\\,\\mathrm{m}^{-3}$ 为单位表示最终答案。",
            "solution": "该问题要求推导并计算一个均匀的浓度校正量 $\\delta$，以便在一个非守恒的平流步骤之后，恢复离散化海洋模型中的全球质量守恒。核心原理是，在没有源或汇的情况下，示踪剂的总质量应保持不变。\n\n设海洋域被离散化为 $N=4$ 个网格单元，其体积为 $\\{V_i\\}_{i=1}^{4}$。设 $\\{q_i^n\\}_{i=1}^{4}$ 为时间层 $t^n$ 时的示踪剂浓度，$\\{q_i^*\\}_{i=1}^{4}$ 为经过半拉格朗日 (SL) 平流步骤后在时间层 $t^{n+1}$ 时的浓度。\n\n在时间 $t^n$ 时，离散系统中的示踪剂总质量由每个单元中质量的总和给出：\n$$M^n = \\sum_{i=1}^{N} q_i^n V_i$$\n使用所提供的数据：\n- 单元体积：$V_{1} = 1.20 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{2} = 8.00 \\times 10^{11} \\, \\mathrm{m}^{3} = 0.80 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{3} = 1.50 \\times 10^{12} \\, \\mathrm{m}^{3}$, $V_{4} = 1.00 \\times 10^{12} \\, \\mathrm{m}^{3}$。\n- 初始浓度：$q_{1}^{n} = 2.000 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{n} = 1.800 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{n} = 2.200 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{n} = 1.900 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n\n我们计算初始质量 $M^n$：\n$$M^n = (2.000 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.800 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.200 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.900 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^n = (2.400 \\times 10^{9}) + (1.440 \\times 10^{9}) + (3.300 \\times 10^{9}) + (1.900 \\times 10^{9})$$\n$$M^n = 9.040 \\times 10^{9} \\, \\mathrm{kg}$$\n\n类似地，SL 步骤后的总质量 $M^*$ 使用 SL 步骤后的浓度 $\\{q_i^*\\}_{i=1}^{4}$ 计算：\n- SL 步骤后的浓度：$q_{1}^{*} = 1.990 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{2}^{*} = 1.810 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{3}^{*} = 2.190 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$, $q_{4}^{*} = 1.880 \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$。\n\n$$M^* = \\sum_{i=1}^{N} q_i^* V_i$$\n$$M^* = (1.990 \\times 10^{-3})(1.20 \\times 10^{12}) + (1.810 \\times 10^{-3})(0.80 \\times 10^{12}) + (2.190 \\times 10^{-3})(1.50 \\times 10^{12}) + (1.880 \\times 10^{-3})(1.00 \\times 10^{12})$$\n$$M^* = (2.388 \\times 10^{9}) + (1.448 \\times 10^{9}) + (3.285 \\times 10^{9}) + (1.880 \\times 10^{9})$$\n$$M^* = 9.001 \\times 10^{9} \\, \\mathrm{kg}$$\n\nSL 步骤后的全球质量误差是步骤后质量与初始质量之差：\n$$\\Delta M = M^* - M^n = 9.001 \\times 10^{9} \\, \\mathrm{kg} - 9.040 \\times 10^{9} \\, \\mathrm{kg} = -0.039 \\times 10^{9} \\, \\mathrm{kg} = -3.9 \\times 10^{7} \\, \\mathrm{kg}$$\n负号表示数值上的质量损失。\n\n为了恢复质量守恒，将一个均匀的浓度校正量 $\\delta$ 添加到每个单元的浓度中，得到校正后的浓度 $q_i^c = q_i^* + \\delta$。校正后的总质量 $M^c$ 必须等于初始总质量 $M^n$。这是此问题的“第一性原理”。\n$$M^c = M^n$$\n代入 $M^c$ 的表达式：\n$$\\sum_{i=1}^{N} q_i^c V_i = M^n$$\n代入 $q_i^c = q_i^* + \\delta$：\n$$\\sum_{i=1}^{N} (q_i^* + \\delta) V_i = M^n$$\n我们可以将求和展开：\n$$\\sum_{i=1}^{N} q_i^* V_i + \\sum_{i=1}^{N} \\delta V_i = M^n$$\n第一项是 $M^*$。第二项可以通过提出常数 $\\delta$ 来简化：\n$$M^* + \\delta \\sum_{i=1}^{N} V_i = M^n$$\n设 $V_{total} = \\sum_{i=1}^{N} V_i$ 为海洋域的总 体积。方程变为：\n$$M^* + \\delta V_{total} = M^n$$\n现在我们求解校正量 $\\delta$：\n$$\\delta V_{total} = M^n - M^*$$\n这就得到了 $\\delta$ 的推导表达式：\n$$\\delta = \\frac{M^n - M^*}{V_{total}} = \\frac{\\sum_{i=1}^{N} q_i^n V_i - \\sum_{i=1}^{N} q_i^* V_i}{\\sum_{i=1}^{N} V_i}$$\n该表达式表示总质量亏损 $-(M^* - M^n)$ 被均匀地分布在总体积上。\n\n现在，我们计算 $\\delta$ 的数值。首先，我们计算总体积 $V_{total}$：\n$$V_{total} = V_1 + V_2 + V_3 + V_4 = (1.20 + 0.80 + 1.50 + 1.00) \\times 10^{12} \\, \\mathrm{m}^{3}$$\n$$V_{total} = 4.50 \\times 10^{12} \\, \\mathrm{m}^{3}$$\n使用先前计算的质量：\n$$M^n - M^* = 9.040 \\times 10^{9} \\, \\mathrm{kg} - 9.001 \\times 10^{9} \\, \\mathrm{kg} = 0.039 \\times 10^{9} \\, \\mathrm{kg}$$\n现在，我们计算 $\\delta$：\n$$\\delta = \\frac{0.039 \\times 10^{9} \\, \\mathrm{kg}}{4.50 \\times 10^{12} \\, \\mathrm{m}^{3}}$$\n$$\\delta = \\frac{3.9 \\times 10^{7}}{4.50 \\times 10^{12}} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = \\frac{3.9}{4.50} \\times 10^{-5} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\n$$\\delta = 0.008666... \\times 10^{-3} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3} = 8.666... \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\n按要求将结果四舍五入到四位有效数字：\n$$\\delta \\approx 8.667 \\times 10^{-6} \\, \\mathrm{kg}\\,\\mathrm{m}^{-3}$$\n将这个正值的 $\\delta$ 加到每个单元的浓度中，以补偿在平流步骤中损失的质量。",
            "answer": "$$\\boxed{8.667 \\times 10^{-6}}$$"
        }
    ]
}