{
    "hands_on_practices": [
        {
            "introduction": "在评估诸如极端浪高等特定事件的预报时，简单的准确率指标可能会产生误导。例如，一个从不预报罕见事件的模型，其准确率可能很高，但对预警毫无价值。因此，我们需要能够衡量预报相对于基准（如随机预报）改进程度的“技巧评分”。公平威胁评分（Equitable Threat Score, ETS）正是为此设计的关键工具，它能够剔除随机命中，衡量模型真正的预报能力。通过这个练习，您将亲自推导ETS的构成，从而深刻理解它如何量化超越随机性的预报技巧。",
            "id": "3799780",
            "problem": "一个数值波浪模型通过浮标观测数据进行验证，检验其对有效波高超过 $6 \\ \\mathrm{m}$ 固定阈值的预报能力。验证数据集包含 $N = 5000$ 个独立的预报-观测并置样本。每个并置样本根据以下规则分类到一个 $2 \\times 2$ 列联表中：如果预报和观测值都超过阈值，则为命中 ($H$)；如果观测值超过阈值但预报值没有，则为漏报 ($M$)；如果预报值超过阈值但观测值没有，则为空报 ($F$)；否则为正确拒绝 ($C$)。在此验证实验中，计数分别为 $H = 150$，$M = 90$，$F = 150$，而 $C$ 由 $C = N - H - M - F$ 隐含。\n\n任务：\n1. 从联合概率和边际概率的定义出发，并假设在无技巧（随机）预报条件下，预报与观测之间统计独立，推导出随机命中预期数 $H_{r}$ 关于 $H$、$M$、$F$ 和 $N$ 的表达式。然后用此表达式推导出公平威胁评分 (ETS)，该评分对威胁评分中的随机命中进行了修正。\n2. 在阈值超限检测的背景下，用 $H$、$M$、$F$ 和 $C$ 定义命中率和空报率，并明确说明每种率是以哪个事件基数为条件的。\n3. 使用上述计数，计算公平威胁评分 (ETS)。将最终的 ETS 表示为小数，并将答案四舍五入到四位有效数字。最终答案中不要包含百分号或任何单位。",
            "solution": "问题陈述已经过验证，被认为是科学上合理的、提法恰当的、客观的和完整的。我们可以着手解决。该问题按要求分三部分解答。\n\n用于二分类（是/否）预报检验的列联表由以下计数定义：\n- $H$：命中 (预报 = 是, 观测 = 是)\n- $M$：漏报 (预报 = 否, 观测 = 是)\n- $F$：空报 (预报 = 是, 观测 = 否)\n- $C$：正确拒绝 (预报 = 否, 观测 = 否)\n总样本数为 $N = H + M + F + C$。\n\n**1. 随机命中 ($H_r$) 和公平威胁评分 (ETS) 的推导**\n\n令 $O$ 为观测值超过阈值的事件，令 $F_c$ 为预报值超过阈值的事件。根据 $N$ 个样本，我们可以估计这些事件发生的边际概率。观测到超限的经验概率是观测到超限的总次数 $H+M$ 除以总样本量 $N$：\n$$P(O) = \\frac{H + M}{N}$$\n类似地，预报超限的经验概率（预报的气候学频率或偏差）是预报超限的总次数 $H+F$ 除以 $N$：\n$$P(F_c) = \\frac{H + F}{N}$$\n“无技巧”或纯随机预报是指预报事件与观测事件统计独立的预报。在此独立性假设下，命中（事件既被预报又被观测到）的联合概率是边际概率的乘积：\n$$P(\\text{random hit}) = P(O \\cap F_c) = P(O) \\times P(F_c)$$\n在大小为 $N$ 的样本中，随机命中的预期数 $H_r$ 是 $N$ 乘以这个联合概率：\n$$H_r = N \\times P(\\text{random hit}) = N \\times \\left(\\frac{H + M}{N}\\right) \\times \\left(\\frac{H + F}{N}\\right)$$\n$$H_r = \\frac{(H + M)(H + F)}{N}$$\n这是在给定观测和预报事件频率的情况下，由随机机会导致的命中预期数的表达式。\n\n威胁评分 (TS)，也称为临界成功指数 (CSI)，衡量的是相对于事件被预报或被观测到的情况集合，预报的准确性。其定义为：\n$$TS = \\frac{H}{H + M + F}$$\n公平威胁评分 (ETS)，也称为 Gilbert 技巧评分 (GSS)，通过修正纯粹由机会预期会发生的命中，对 TS 进行了改进。技巧评分衡量的是预报相对于一个参考预报（在此情况下为随机预报）的改进程度。技巧评分的一般公式是：\n$$\\text{Skill Score} = \\frac{\\text{Score}_{\\text{forecast}} - \\text{Score}_{\\text{random}}}{\\text{Score}_{\\text{perfect}} - \\text{Score}_{\\text{random}}}$$\n在命中的背景下，“得分”就是命中的次数。\n- 预报的命中次数为 $H$。\n- 随机预报的预期命中次数为 $H_r$。\n- 对于完美预报，所有事件都将是命中，没有漏报 ($M=0$) 或空报 ($F=0$)。事件总数为 $H+M+F$。因此，一个完美的预报会将所有这些事件都实现为命中。TS 的分母是观测事件和预报事件的并集。所以完美得分的潜在命中数是 $H+M+F$。\n可归因于预报技巧的命中数是实际命中数减去机会预期的命中数：$H - H_r$。这构成了 ETS 的分子。\n分母代表了可以展示技巧的事件总数。这是预报或观测到的事件总集 $H+M+F$ 减去机会预期的命中数 $H_r$。通过从分母中移除 $H_r$，我们是在评估那些不能用随机机会解释的事件集合上的技巧。\n因此，公平威胁评分的表达式为：\n$$ETS = \\frac{H - H_r}{H + M + F - H_r}$$\n\n**2. 命中率和空报率的定义**\n\n命中率 (HR)，也称为探测概率 (POD) 或召回率，是被正确预报的观测事件所占的比例。它定义为命中次数除以观测事件总数。\n$$HR = \\frac{H}{H+M}$$\n命中率的条件事件基数是所有观测值超过阈值的情况的集合。\n\n空报率 (FARate)，也称为虚警概率 (POFD)，是被错误预报为事件的未观测到事件所占的比例。它定义为空报次数除以事件未被观测到的总情况数。\n$$FARate = \\frac{F}{F+C}$$\n空报率的条件事件基数是所有观测值未超过阈值的情况的集合。它不应与空报*比*（False Alarm *Ratio*）混淆，后者为 $F/(H+F)$，是以事件被预报为条件的。\n\n**3. 公平威胁评分 (ETS) 的计算**\n\n我们从验证实验中得知以下计数：\n- $H = 150$\n- $M = 90$\n- $F = 150$\n- $N = 5000$\n\n首先，我们计算正确拒绝的次数 $C$：\n$$C = N - H - M - F = 5000 - 150 - 90 - 150 = 5000 - 390 = 4610$$\n接下来，我们使用第1部分推导的公式计算随机命中的预期数 $H_r$。我们需要边际总数：\n- 观测事件总数：$H + M = 150 + 90 = 240$\n- 预报事件总数：$H + F = 150 + 150 = 300$\n现在，我们计算 $H_r$：\n$$H_r = \\frac{(H + M)(H + F)}{N} = \\frac{240 \\times 300}{5000} = \\frac{72000}{5000} = 14.4$$\n最后，我们使用推导出的公式计算 ETS：\n$$ETS = \\frac{H - H_r}{H + M + F - H_r}$$\n事件总数（预报或观测到的）是 $H + M + F = 150 + 90 + 150 = 390$。\n将数值代入 ETS 公式：\n$$ETS = \\frac{150 - 14.4}{390 - 14.4} = \\frac{135.6}{375.6}$$\n进行除法运算并将结果四舍五入到四位有效数字：\n$$ETS \\approx 0.36102236...$$\n$$ETS \\approx 0.3610$$",
            "answer": "$$\\boxed{0.3610}$$"
        },
        {
            "introduction": "现代预报系统已从提供单一确定性预测值，转向提供描述结果不确定性的完整概率分布。评估这类概率预报需要更先进的度量。连续分级概率评分（Continuous Ranked Probability Score, CRPS）是评估概率预报的黄金标准，它可被视为平均绝对误差向概率领域的自然推广。本练习将要求您为一个高斯预报分布推导其CRPS表达式，这能让您切身体会CRPS是如何综合评估预报的准确性（均值误差）和可靠性（方差误差）的。",
            "id": "3799781",
            "problem": "一个区域海洋预报系统提供在固定位置和时间的概率性海面温度（SST），其预测分布假定为均值为 $\\mu$、方差为 $\\sigma^{2}$ 的高斯分布。为了概率性地评估预报技巧，考虑连续分级概率评分（CRPS），它为一个预测累积分布函数（CDF）$F(x)$ 和一个实现的观测值 $o$ 定义如下：\n$$\n\\mathrm{CRPS}(F,o) \\equiv \\int_{-\\infty}^{\\infty} \\left(F(x) - H(x-o)\\right)^{2} \\,\\mathrm{d}x,\n$$\n其中 $H(x)$ 是亥维赛阶跃函数，当 $x < 0$ 时 $H(x)=0$，当 $x\\ge 0$ 时 $H(x)=1$。假设 $F$ 具有有限一阶矩，并且 $F$ 是均值为 $\\mu$、标准差为 $\\sigma>0$ 的正态分布的CDF。令 $\\phi(\\cdot)$ 和 $\\Phi(\\cdot)$ 分别表示标准正态概率密度函数（PDF）和CDF。\n\n从上述定义以及期望和高斯积分的基本性质出发，推导一个 $\\mathrm{CRPS}(N(\\mu,\\sigma^{2}),o)$ 的闭式表达式，该表达式仅依赖于 $\\mu$、$\\sigma$ 和 $o$，并用 $\\phi$ 和 $\\Phi$ 表示。然后，对于一个网格点上的SST预报，其预测分布为 $N(\\mu,\\sigma^{2})$，其中 $\\mu = 299.7$ K，$\\sigma = 0.6$ K，验证观测值为 $o = 300.3$ K，请数值计算CRPS。\n\n以开尔文为单位表示最终答案，并将答案四舍五入到四位有效数字。最终答案必须是一个实数。",
            "solution": "问题陈述已经过验证，被认为是具有科学依据、提法恰当且客观的。所有必要信息均已提供，问题没有矛盾或含糊之处。因此，我们可以开始解答。\n\n本题要求推导高斯预测分布下的连续分级概率评分（CRPS）的闭式表达式，并进行数值计算。\n\nCRPS为一个预测累积分布函数（CDF）$F(x)$ 和一个标量观测值 $o$ 定义如下：\n$$\n\\mathrm{CRPS}(F,o) = \\int_{-\\infty}^{\\infty} \\left(F(x) - H(x-o)\\right)^{2} \\,\\mathrm{d}x\n$$\n其中 $H(x-o)$ 是亥维赛阶跃函数，当 $x  o$ 时为 $0$，当 $x \\ge o$ 时为 $1$。\n\nCRPS 的一个可从其定义推导出的基本性质，是用期望来表示它。这种替代表示对于特定分布的解析计算特别有用。该恒等式为：\n$$\n\\mathrm{CRPS}(F,o) = E_F[|X - o|] - \\frac{1}{2} E_F[|X - X'|]\n$$\n其中 $X$ 和 $X'$ 是从CDF为 $F$ 的分布中抽取的独立随机变量，$E_F[\\cdot]$ 表示关于该分布的期望。我们将使用这个恒等式，因为它依赖于问题描述中提到的“期望的基本性质”。\n\n预测分布为高斯分布，$X \\sim N(\\mu, \\sigma^2)$，均值为 $\\mu$，方差为 $\\sigma^2$。其CDF为 $F(x) = \\Phi\\left(\\frac{x-\\mu}{\\sigma}\\right)$，其中 $\\Phi(\\cdot)$ 是标准正态分布 $N(0,1)$ 的CDF。\n\n我们的推导分两部分进行：计算基于期望的CRPS公式中的每一项。\n\n**第1部分：计算 $E_F[|X - X'|]$**\n\n设 $X$ 和 $X'$ 是两个来自 $N(\\mu, \\sigma^2)$ 的独立同分布随机变量。它们的差 $Y = X - X'$ 也服从正态分布。差的均值为 $E[Y] = E[X] - E[X'] = \\mu - \\mu = 0$。由于独立性，差的方差为 $\\mathrm{Var}(Y) = \\mathrm{Var}(X) + \\mathrm{Var}(X') = \\sigma^2 + \\sigma^2 = 2\\sigma^2$。因此，$Y \\sim N(0, 2\\sigma^2)$。\n\n我们需要计算 $E[|Y|]$。对于任何零均值正态变量 $Y \\sim N(0, \\tau^2)$，其绝对值的期望由下式给出：\n$$\nE[|Y|] = \\int_{-\\infty}^{\\infty} |y| \\frac{1}{\\sqrt{2\\pi}\\tau} \\exp\\left(-\\frac{y^2}{2\\tau^2}\\right) \\,\\mathrm{d}y = 2 \\int_{0}^{\\infty} y \\frac{1}{\\sqrt{2\\pi}\\tau} \\exp\\left(-\\frac{y^2}{2\\tau^2}\\right) \\,\\mathrm{d}y\n$$\n使用换元法 $u = y^2/(2\\tau^2)$，得到 $\\mathrm{d}u = y/\\tau^2 \\,\\mathrm{d}y$，积分变为：\n$$\nE[|Y|] = \\frac{2}{\\sqrt{2\\pi}\\tau} \\int_0^\\infty \\tau^2 \\exp(-u) \\,\\mathrm{d}u = \\frac{2\\tau}{\\sqrt{2\\pi}} [-\\exp(-u)]_0^\\infty = \\frac{2\\tau}{\\sqrt{2\\pi}} = \\tau \\sqrt{\\frac{2}{\\pi}}\n$$\n在我们的例子中，$\\tau^2 = \\mathrm{Var}(Y) = 2\\sigma^2$，所以 $\\tau = \\sigma\\sqrt{2}$。将此代入结果中：\n$$\nE[|X - X'|] = (\\sigma\\sqrt{2}) \\sqrt{\\frac{2}{\\pi}} = \\frac{2\\sigma}{\\sqrt{\\pi}}\n$$\n因此，CRPS公式中的第二项是：\n$$\n\\frac{1}{2} E_F[|X - X'|] = \\frac{1}{2} \\left(\\frac{2\\sigma}{\\sqrt{\\pi}}\\right) = \\frac{\\sigma}{\\sqrt{\\pi}}\n$$\n\n**第2部分：计算 $E_F[|X - o|]$**\n\n我们现在计算第一项 $E[|X-o|]$，其中 $X \\sim N(\\mu, \\sigma^2)$。对变量进行标准化是有利的。令 $Z = (X-\\mu)/\\sigma$，则 $Z \\sim N(0,1)$。令 $\\omega = (o-\\mu)/\\sigma$ 为标准化的观测值。\n$$\nE[|X-o|] = E[|\\mu + \\sigma Z - o|] = E[|\\sigma Z - (o-\\mu)|] = \\sigma E[|Z - \\omega|]\n$$\n期望 $E[|Z-\\omega|]$ 通过对标准正态PDF $\\phi(z)$ 积分来计算：\n$$\nE[|Z - \\omega|] = \\int_{-\\infty}^{\\infty} |z-\\omega| \\phi(z) \\,\\mathrm{d}z = \\int_{-\\infty}^{\\omega} (\\omega-z)\\phi(z)\\,\\mathrm{d}z + \\int_{\\omega}^{\\infty} (z-\\omega)\\phi(z)\\,\\mathrm{d}z\n$$\n我们计算这两个积分。\n对于第一个积分：$\\int (\\omega-z)\\phi(z)\\,\\mathrm{d}z = \\omega \\int \\phi(z)\\,\\mathrm{d}z - \\int z\\phi(z)\\,\\mathrm{d}z$。\n我们知道 $\\int\\phi(z)\\,\\mathrm{d}z = \\Phi(z)$ 并且 $\\int z\\phi(z)\\,\\mathrm{d}z = \\int z \\frac{1}{\\sqrt{2\\pi}} \\exp(-z^2/2)\\,\\mathrm{d}z = -\\frac{1}{\\sqrt{2\\pi}} \\exp(-z^2/2) = -\\phi(z)$。\n因此，$\\int (\\omega-z)\\phi(z)\\,\\mathrm{d}z = \\omega\\Phi(z) + \\phi(z)$。\n$$\n\\int_{-\\infty}^{\\omega} (\\omega-z)\\phi(z)\\,\\mathrm{d}z = [\\omega\\Phi(z) + \\phi(z)]_{-\\infty}^{\\omega} = (\\omega\\Phi(\\omega) + \\phi(\\omega)) - (0+0) = \\omega\\Phi(\\omega) + \\phi(\\omega)\n$$\n对于第二个积分：\n$$\n\\int_{\\omega}^{\\infty} (z-\\omega)\\phi(z)\\,\\mathrm{d}z = \\int_{\\omega}^{\\infty} z\\phi(z)\\,\\mathrm{d}z - \\omega\\int_{\\omega}^{\\infty} \\phi(z)\\,\\mathrm{d}z = [-\\phi(z)]_{\\omega}^{\\infty} - \\omega(1-\\Phi(\\omega))\n$$\n$$\n= (0 - (-\\phi(\\omega))) - \\omega(1-\\Phi(\\omega)) = \\phi(\\omega) - \\omega + \\omega\\Phi(\\omega)\n$$\n将这两个积分的结果相加，得到 $E[|Z-\\omega|]$：\n$$\nE[|Z-\\omega|] = (\\omega\\Phi(\\omega) + \\phi(\\omega)) + (\\phi(\\omega) - \\omega + \\omega\\Phi(\\omega)) = 2\\phi(\\omega) + 2\\omega\\Phi(\\omega) - \\omega = \\omega(2\\Phi(\\omega) - 1) + 2\\phi(\\omega)\n$$\n因此，CRPS的第一项是：\n$$\nE_F[|X-o|] = \\sigma \\left[ \\omega(2\\Phi(\\omega) - 1) + 2\\phi(\\omega) \\right]\n$$\n\n**第3部分：CRPS的最终闭式表达式**\n\n结合这两项的表达式，我们得到高斯预报的CRPS的闭式表达式：\n$$\n\\mathrm{CRPS}(N(\\mu,\\sigma^{2}),o) = \\sigma \\left[ \\omega(2\\Phi(\\omega) - 1) + 2\\phi(\\omega) \\right] - \\frac{\\sigma}{\\sqrt{\\pi}}\n$$\n$$\n\\mathrm{CRPS}(N(\\mu,\\sigma^{2}),o) = \\sigma \\left[ \\omega\\left(2\\Phi(\\omega)-1\\right) + 2\\phi(\\omega) - \\frac{1}{\\sqrt{\\pi}} \\right]\n$$\n其中 $\\omega = \\frac{o-\\mu}{\\sigma}$。这就是所求的表达式。\n\n**第4部分：数值计算**\n\n我们已知以下数值：\n预报均值：$\\mu = 299.7$ K\n预报标准差：$\\sigma = 0.6$ K\n观测值：$o = 300.3$ K\n\n首先，我们计算标准化的观测值 $\\omega$：\n$$\n\\omega = \\frac{o-\\mu}{\\sigma} = \\frac{300.3 - 299.7}{0.6} = \\frac{0.6}{0.6} = 1\n$$\n现在，我们计算 $\\omega=1$ 时的CRPS公式：\n$$\n\\mathrm{CRPS} = (0.6) \\left[ 1 \\cdot (2\\Phi(1)-1) + 2\\phi(1) - \\frac{1}{\\sqrt{\\pi}} \\right]\n$$\n我们使用函数的标准数值：\n$z=1$ 处的标准正态PDF：$\\phi(1) = \\frac{1}{\\sqrt{2\\pi}} \\exp(-1/2) \\approx 0.2419707$。\n$z=1$ 处的标准正态CDF：$\\Phi(1) \\approx 0.8413447$。\n并且 $1/\\sqrt{\\pi} \\approx 0.5641896$。\n\n将这些值代入表达式中：\n第1项：$\\omega(2\\Phi(\\omega)-1) = 1 \\cdot (2 \\times 0.8413447 - 1) = 1.6826894 - 1 = 0.6826894$。\n第2项：$2\\phi(\\omega) = 2 \\times 0.2419707 = 0.4839414$。\n第3项：$1/\\sqrt{\\pi} \\approx 0.5641896$。\n\n括号内的值是：\n$$\n0.6826894 + 0.4839414 - 0.5641896 = 0.6024412\n$$\n最后，我们乘以 $\\sigma$：\n$$\n\\mathrm{CRPS} = 0.6 \\times 0.6024412 \\approx 0.36146472 \\, \\text{K}\n$$\n将结果四舍五入到四位有效数字，我们得到 $0.3615$ K。",
            "answer": "$$\n\\boxed{0.3615}\n$$"
        },
        {
            "introduction": "诸如ETS或平均CRPS之类的总体性评分对于快速评估模型性能至关重要，但它们可能会掩盖模型在特定条件下的严重缺陷。例如，一个模型的全局平均偏差可能很小，但它可能在冷水区系统性地高估温度，而在暖水区又系统性地低估。要揭示这类复杂的误差模式，我们必须进行条件偏差分析，即考察模型误差如何随观测状态的变化而变化。这项编程实践将指导您利用分位数分箱和回归分析等方法，诊断模型误差中隐藏的非线性和状态依赖结构，从而深入理解模型行为。",
            "id": "3799836",
            "problem": "给定成对的模型输出和海面温度（SST）观测序列，分别表示为 $M_i$ 和 $O_i$，其中 $i=1,\\dots,N$。时间索引为 $i$ 时的误差定义为 $e_i = M_i - O_i$，单位为摄氏度（Celsius）。目标是通过计算全局偏差和作为观测状态函数的条件偏差来验证模型，并诊断那些仅考虑全局偏差时会被掩盖的非线性偏差结构。\n\n从条件期望的基本定义出发，条件偏差函数 $b(o)$ 定义为 $b(o) = \\mathbb{E}[e \\mid O = o]$。由于在有限样本下直接评估 $\\mathbb{E}[e \\mid O = o]$ 不切实际，您必须使用观测状态 $O$ 上的分箱来估计 $b(o)$。为此，请执行以下操作：\n- 将观测值 $\\{O_i\\}$ 划分为 $K$ 个分位数区间（等频率区间），其中 $K=6$。设这些区间的边界为 $q_0  q_1  \\dots  q_6$，其中 $q_j$ 是 $\\{O_i\\}$ 的 $j/6$ 阶经验分位数。对于每个区间 $j$，计算条件偏差估计值 $b_j$，即 $\\{e_i: O_i \\in [q_{j-1}, q_j)\\}$ 的样本均值，并将最后一个区间视为 $[q_5, q_6]$ 以包含最大值。设条件偏差范围为 $R = \\max_j b_j - \\min_j b_j$，单位为摄氏度（Celsius）。\n- 计算全局偏差 $B = \\frac{1}{N}\\sum_{i=1}^N e_i$，单位同样为摄氏度（Celsius）。\n\n为了诊断非线性偏差结构，将误差建模为观测状态的多项式函数，\n$$\ne_i = a_0 + a_1 O_i + a_2 O_i^2 + \\varepsilon_i,\n$$\n并通过最小二乘法估计系数 $\\hat{a}_0, \\hat{a}_1, \\hat{a}_2$。使用经典的嵌套模型 $F$ 检验，将该二次模型与嵌套的线性模型\n$$\ne_i = c_0 + c_1 O_i + \\eta_i\n$$\n进行比较。设 $\\mathrm{SSE}_1$ 和 $\\mathrm{SSE}_2$ 分别为线性和二次模型的残差平方和，线性模型有 $p_1=2$ 个参数，二次模型有 $p_2=3$ 个参数。对于 $N$ 个样本，计算检验统计量\n$$\nF = \\frac{\\left(\\mathrm{SSE}_1 - \\mathrm{SSE}_2\\right)/(p_2 - p_1)}{\\mathrm{SSE}_2/(N - p_2)},\n$$\n及其在自由度为 $(p_2 - p_1, N - p_2)$ 的 Fisher-Snedecor 分布（F分布）下的 $p$ 值。一个小的 $p$ 值表明包含二次项能显著改善拟合，从而诊断出非线性偏差。报告 $\\hat{a}_2$ 的单位为摄氏度每平方摄氏度（Celsius per Celsius$^2$），并将 $p$ 值报告为 $[0,1]$ 内的小数。\n\n您的程序必须实现上述过程，并将其应用于以下测试套件。在每个测试案例中，观测值和模型输出应根据指定的规则综合生成。所有SST值均以摄氏度（Celsius）为单位，噪声为零均值高斯噪声。\n\n测试套件（四个案例）：\n1. 具有近零全局偏差的非线性偏差：\n   - 样本量 $N = 2000$。\n   - 观测值 $O_i$ 独立地从 $[10, 30]$ 上的均匀分布中抽取。\n   - 确定性偏差项 $d(O_i) = 0.02\\,(O_i - 20)^2 - c$，其中 $c$ 是 $0.02\\,(O - 20)^2$ 在 $O \\sim \\mathrm{Uniform}(10, 30)$ 下的解析均值，即 $c = 0.02 \\times \\mathrm{Var}(O) = 0.02 \\times \\frac{(30-10)^2}{12}$。\n   - 噪声标准差 $\\sigma = 0.1$。模型输出 $M_i = O_i + d(O_i) + \\epsilon_i$，其中 $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma^2)$。\n\n2. 纯线性偏差：\n   - 样本量 $N = 2000$。\n   - 观测值 $O_i \\sim \\mathrm{Uniform}(5, 30)$。\n   - 确定性偏差项 $d(O_i) = 0.5 + 0.03\\,(O_i - 17.5)$。\n   - 噪声标准差 $\\sigma = 0.15$。模型输出 $M_i = O_i + d(O_i) + \\epsilon_i$。\n\n3. 带随机噪声的无偏差模型：\n   - 样本量 $N = 2000$。\n   - 观测值 $O_i \\sim \\mathrm{Uniform}(5, 30)$。\n   - 确定性偏差项 $d(O_i) = 0$。\n   - 噪声标准差 $\\sigma = 0.2$。模型输出 $M_i = O_i + \\epsilon_i$。\n\n4. 异方差噪声和以零均值为中心的细微二次偏差：\n   - 样本量 $N = 80$。\n   - 首先通过从 $\\mathrm{Beta}(\\alpha=2,\\beta=5)$ 分布中抽样 $X_i$ 来生成观测值 $O_i$，然后设置 $O_i = 5 + 25 X_i$ 将其映射到 $[5, 30]$。\n   - 确定性偏差项 $d(O_i) = 0.015\\,(O_i - 15)^2 - c$，其中 $c$ 在此案例中数值上选择为 $0.015\\,(O_i - 15)^2$ 在实现的 $\\{O_i\\}$ 上的样本均值，以使确定性偏差的全局均值接近于零。\n   - 噪声标准差依赖于 $O_i$，为 $\\sigma_i = 0.05 + 0.01\\,(O_i - 5)$。\n   - 模型输出 $M_i = O_i + d(O_i) + \\epsilon_i$，其中 $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_i^2)$。\n\n对于每个测试案例，计算：\n- 全局偏差 $B$，单位为摄氏度（Celsius）。\n- 条件偏差范围 $R$，单位为摄氏度（Celsius）。\n- 估计的二次系数 $\\hat{a}_2$，单位为摄氏度每平方摄氏度（Celsius per Celsius$^2$）。\n- 嵌套模型 $F$ 检验的 $p$ 值，以小数形式表示。\n\n角度单位不适用于此问题。所有物理量必须以指定单位处理。您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表，格式如下：\n- 对每个测试案例，输出列表 $[B, R, \\hat{a}_2, p]$。\n- 将四个测试案例的结果汇总到一个列表中，产生类似 $[[B_1,R_1,\\hat{a}_{2,1},p_1],[B_2,R_2,\\hat{a}_{2,2},p_2],[B_3,R_3,\\hat{a}_{2,3},p_3],[B_4,R_4,\\hat{a}_{2,4},p_4]]$ 的输出。",
            "solution": "问题陈述已经过分析，并被确定为有效。它在科学上基于用于模型验证的标准统计和数值方法，问题本身是适定的，指令清晰明确，并以客观、正式的语言表述。所有必要的数据、参数和程序都已提供，以构建一个唯一且可验证的解决方案。\n\n该问题要求实施一个统计验证程序，用以对比海面温度（SST）模型与观测数据。该过程涉及量化模型误差（或称偏差）的不同方面，误差定义为 $e_i = M_i - O_i$，其中 $M_i$ 是模型输出，$O_i$ 是观测值。对每个测试案例的分析包括三个主要部分：计算全局偏差，估计条件偏差，以及基于回归的非线性偏差结构诊断。\n\n首先，我们根据指定的随机模型为四个测试案例中的每一个生成合成数据序列 $\\{O_i\\}_{i=1}^N$ 和 $\\{M_i\\}_{i=1}^N$。然后，通过计算它们的差值得到误差序列 $\\{e_i\\}_{i=1}^N$。\n\n全局偏差 $B$ 是最简单的模型性能度量，定义为所有误差的平均值：\n$$\nB = \\frac{1}{N}\\sum_{i=1}^N e_i\n$$\n接近于零的 $B$ 值表明，平均而言，模型没有系统性地高估或低估观测值。然而，零全局偏差可能会掩盖显著的、依赖于状态的误差。\n\n为了揭示此类结构，我们估计条件偏差 $b(o) = \\mathbb{E}[e \\mid O = o]$，即在给定特定观测值 $o$ 时的期望误差。由于在有限数据下精确计算条件期望是不可行的，我们通过对数据进行分箱来近似它。观测SST值的范围被划分为 $K=6$ 个等频率（分位数）区间。区间的边界由观测序列 $\\{O_i\\}$ 的经验分位数确定。设基于分位数的边界为 $q_0, q_1, \\dots, q_K$，其中 $q_j$ 是 $j/K$ 阶的经验分位数。第 $j$ 个区间（$j=1, \\dots, K$）的条件偏差估计为相应观测值落入该区间的误差的样本均值：\n$$\nb_j = \\text{mean}\\{e_i \\mid O_i \\in [q_{j-1}, q_j') \\}\n$$\n其中，当 $j  K$ 时，区间为 $[q_{j-1}, q_j)$；当 $j=K$ 时，区间为 $[q_{K-1}, q_K]$，以确保包含最大观测值。条件偏差范围 $R = \\max_j b_j - \\min_j b_j$ 量化了偏差在系统不同状态下的变化幅度。相对于全局偏差 $B$ 而言，较大的 $R$ 值表明存在显著的依赖于状态的偏差结构。\n\n最后，为了正式诊断和量化非线性偏差，我们将误差 $e_i$ 建模为观测值 $O_i$ 的多项式函数。我们通过普通最小二乘法（OLS）拟合一个二次模型：\n$$\ne_i = a_0 + a_1 O_i + a_2 O_i^2 + \\varepsilon_i\n$$\n估计的系数 $\\hat{a}_2$ 直接度量了偏差的凹凸性。一个非零的 $\\hat{a}_2$ 表明模型误差随观测SST呈二次变化。为评估该二次项的统计显著性，我们执行一个嵌套模型 $F$ 检验，将完整的二次模型（含 $p_2=3$ 个参数：$a_0, a_1, a_2$）与一个更简单的嵌套线性模型（含 $p_1=2$ 个参数：$c_0, c_1$）进行比较：\n$$\ne_i = c_0 + c_1 O_i + \\eta_i\n$$\n$F$ 统计量根据线性模型（$\\mathrm{SSE}_1$）和二次模型（$\\mathrm{SSE}_2$）的残差平方和（SSE）计算得出：\n$$\nF = \\frac{(\\mathrm{SSE}_1 - \\mathrm{SSE}_2)/(p_2 - p_1)}{\\mathrm{SSE}_2/(N - p_2)}\n$$\n在原假设（$H_0: a_2 = 0$）即二次项为零的情况下，该统计量服从自由度为 $(p_2 - p_1, N - p_2)$ 的 $F$ 分布。与此 $F$ 统计量相关联的 $p$ 值表示，如果真实关系是线性的，偶然观察到拟合度有如此（从线性到二次）改进的概率。一个小的 $p$ 值（例如  0.05）提供了反对原假设的有力证据，证实了显著的非线性偏差结构的存在。\n\n将此完整过程应用于四个指定的测试案例中的每一个。计算并汇总所需的输出——全局偏差 $B$、条件偏差范围 $R$、二次系数 $\\hat{a}_2$ 和 $F$ 检验的 $p$ 值。需要注意的是，对于案例4，OLS的同方差性假设（$\\sigma_i$ 依赖于 $O_i$）被设计所违反。虽然OLS系数估计值仍然是无偏的，但从标准 $F$ 检验得出的 $p$ 值应谨慎解释。然而，计算仍按规定执行。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import f as f_dist\n\ndef solve():\n    \"\"\"\n    Main function to run the validation procedure for all test cases.\n    \"\"\"\n\n    # Using a fixed seed for reproducibility of the random process.\n    rng = np.random.default_rng(seed=42)\n\n    test_cases = [\n        # Case 1: Nonlinear bias with near-zero global bias\n        {\n            \"N\": 2000,\n            \"O_dist\": lambda n: rng.uniform(10, 30, size=n),\n            \"d_func\": lambda O: 0.02 * (O - 20)**2 - (0.02 * (30 - 10)**2 / 12),\n            \"sigma\": 0.1,\n            \"heteroscedastic\": False\n        },\n        # Case 2: Pure linear bias\n        {\n            \"N\": 2000,\n            \"O_dist\": lambda n: rng.uniform(5, 30, size=n),\n            \"d_func\": lambda O: 0.5 + 0.03 * (O - 17.5),\n            \"sigma\": 0.15,\n            \"heteroscedastic\": False\n        },\n        # Case 3: Unbiased model with random noise\n        {\n            \"N\": 2000,\n            \"O_dist\": lambda n: rng.uniform(5, 30, size=n),\n            \"d_func\": lambda O: 0.0,\n            \"sigma\": 0.2,\n            \"heteroscedastic\": False\n        },\n        # Case 4: Heteroscedastic noise and subtle quadratic bias\n        {\n            \"N\": 80,\n            \"O_dist\": lambda n: 5 + 25 * rng.beta(2, 5, size=n),\n            \"d_func\": \"special\", # Handle this case inside the loop\n            \"sigma_func\": lambda O: 0.05 + 0.01 * (O - 5),\n            \"heteroscedastic\": True\n        }\n    ]\n\n    results = []\n\n    for case in test_cases:\n        N = case[\"N\"]\n        K = 6\n\n        # 1. Generate synthetic data\n        O = case[\"O_dist\"](N)\n        \n        if case[\"heteroscedastic\"]:\n            if case[\"d_func\"] == \"special\":\n                # As per problem, c is sample mean for this case\n                T = 0.015 * (O - 15)**2\n                c = np.mean(T)\n                d = T - c\n            sigma_i = case[\"sigma_func\"](O)\n            epsilon = rng.normal(0, sigma_i, size=N)\n        else:\n            d = case[\"d_func\"](O)\n            sigma = case[\"sigma\"]\n            epsilon = rng.normal(0, sigma, size=N)\n        \n        # Error is the deterministic bias plus random noise\n        e = d + epsilon\n\n        # 2. Calculate global bias B\n        B = np.mean(e)\n\n        # 3. Calculate conditional bias range R\n        q_edges = np.quantile(O, np.linspace(0, 1, K + 1))\n        \n        b_means = []\n        for j in range(1, K + 1):\n            if j  K:\n                # Interval [q_{j-1}, q_j)\n                indices = (O >= q_edges[j-1])  (O  q_edges[j])\n            else:\n                # Last bin [q_{K-1}, q_K] inclusive\n                indices = (O >= q_edges[j-1])  (O = q_edges[j])\n            \n            # Handle potentially empty bins if quantiles are not unique\n            if np.any(indices):\n                b_means.append(np.mean(e[indices]))\n            else:\n                # Append nan for empty bin, will be ignored by max/min\n                b_means.append(np.nan)\n        \n        b_means = np.array(b_means)\n        R = np.nanmax(b_means) - np.nanmin(b_means)\n        \n        # 4. Polynomial regression and F-test\n        p1, p2 = 2, 3\n\n        # Linear model: e = c0 + c1*O\n        X1 = np.vstack([O, np.ones(N)]).T\n        _, sse1_list, _, _ = np.linalg.lstsq(X1, e, rcond=None)\n        sse1 = sse1_list[0] if len(sse1_list) > 0 else 0.0\n\n        # Quadratic model: e = a0 + a1*O + a2*O^2\n        X2 = np.vstack([O**2, O, np.ones(N)]).T\n        coeffs2, sse2_list, _, _ = np.linalg.lstsq(X2, e, rcond=None)\n        a2_hat = coeffs2[0]\n        sse2 = sse2_list[0] if len(sse2_list) > 0 else 0.0\n        \n        # F-test\n        df1 = p2 - p1\n        df2 = N - p2\n        \n        if df2 > 0 and sse2 > 1e-12: # Check forvalid degrees of freedom and non-zero denominator\n            f_stat = ((sse1 - sse2) / df1) / (sse2 / df2)\n            p_value = f_dist.sf(f_stat, df1, df2)\n        else: # Handle degenerate cases\n            f_stat = np.nan\n            p_value = np.nan\n\n        results.append([B, R, a2_hat, p_value])\n    \n    # Format the final output precisely as requested\n    formatted_results = ','.join([str(res) for res in results])\n    print(f\"[{formatted_results}]\")\n\nsolve()\n```"
        }
    ]
}