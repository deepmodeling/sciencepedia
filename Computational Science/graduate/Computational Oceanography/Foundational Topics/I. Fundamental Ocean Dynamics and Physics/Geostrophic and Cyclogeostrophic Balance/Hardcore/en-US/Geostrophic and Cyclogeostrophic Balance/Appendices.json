{
    "hands_on_practices": [
        {
            "introduction": "Understanding the balance of forces in a fluid system often begins with nondimensionalization. This powerful technique distills complex equations into a form that reveals the key dimensionless parameters governing the flow's behavior. In this exercise (), you will apply this method to the horizontal momentum equations to derive the Rossby number, which quantifies the ratio of inertial to Coriolis forces, and use its magnitude to assess whether a flow is primarily geostrophic.",
            "id": "3794155",
            "problem": "An oceanic mesoscale current at mid-latitude can be modeled as a horizontally homogeneous, incompressible, Boussinesq, hydrostatic flow on an $f$-plane. Consider the horizontal momentum equations in a frame rotating with the Earth, neglecting explicit friction and body forces other than the Coriolis force and pressure-gradient force. Starting from Newton’s second law applied to a fluid parcel, write the inviscid horizontal momentum equations and perform a nondimensionalization using the characteristic horizontal velocity scale $U$, horizontal length scale $L$, and time scale $L/U$. Choose the pressure scale so that the Coriolis and pressure-gradient terms are of the same order in the nondimensional equations. \n\n- Identify the nondimensional parameter that multiplies the local plus advective acceleration in the horizontal momentum equations.\n- Using the parameter values $U=0.5\\,\\mathrm{m\\,s^{-1}}$, $L=50\\,\\mathrm{km}$, and $f=10^{-4}\\,\\mathrm{s^{-1}}$, compute the numerical value of this parameter. Based on its magnitude, provide a brief assessment of whether geostrophic or cyclogeostrophic balance is more appropriate to leading order for this flow.\n\nReport only the numerical value of the identified nondimensional parameter as your final answer, expressed with no units. Round your answer to three significant figures.",
            "solution": "The problem requires the derivation and nondimensionalization of the horizontal momentum equations for an oceanic flow to identify a key dynamical parameter and assess the dominant force balance.\n\nFirst, the validation of the problem statement is performed.\n\n### Step 1: Extract Givens\n- Flow model: horizontally homogeneous, incompressible, Boussinesq, hydrostatic flow on an $f$-plane.\n- Flow type: oceanic mesoscale current at mid-latitude.\n- Dynamics: inviscid horizontal momentum equations. Forces considered are the Coriolis force and the pressure-gradient force.\n- Task: Start from Newton’s second law, write the horizontal momentum equations, and perform a nondimensionalization.\n- Characteristic scales:\n    - Horizontal velocity: $U$\n    - Horizontal length: $L$\n    - Time: $L/U$\n- Pressure scale condition: Choose the pressure scale such that the Coriolis and pressure-gradient terms are of the same order in the nondimensional equations.\n- Identification task: Identify the nondimensional parameter multiplying the acceleration terms.\n- Calculation task: Compute the numerical value of this parameter given:\n    - $U = 0.5\\,\\mathrm{m\\,s^{-1}}$\n    - $L = 50\\,\\mathrm{km}$\n    - $f = 10^{-4}\\,\\mathrm{s^{-1}}$\n- Assessment task: Based on the parameter's magnitude, assess whether geostrophic or cyclogeostrophic balance is more appropriate to leading order.\n- Reporting requirement: Report only the numerical value of the parameter, rounded to three significant figures.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, drawing on fundamental principles of geophysical fluid dynamics, specifically the derivation of simplified momentum balances from the Navier-Stokes equations in a rotating frame. The assumptions (hydrostatic, Boussinesq, $f$-plane) are standard and appropriate for modeling mesoscale oceanic phenomena. The problem is well-posed, providing a clear sequence of instructions and sufficient data ($U$, $L$, $f$) to arrive at a unique numerical answer. The language is objective and precise. The provided numerical values are physically realistic for mid-latitude ocean eddies. The problem does not violate any of the invalidity criteria.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full solution will be provided.\n\n### Solution Derivation\n\nThe horizontal momentum equations for an inviscid fluid on a rotating planet (the $f$-plane approximation) are derived from Newton's second law. The law states that the mass times acceleration of a fluid parcel is equal to the sum of forces acting on it. In a frame rotating with the Earth, this is expressed as:\n$$ \\frac{D\\mathbf{u}}{Dt} + 2\\boldsymbol{\\Omega} \\times \\mathbf{u} = -\\frac{1}{\\rho}\\nabla p + \\mathbf{g} $$\nHere, $\\mathbf{u}$ is the velocity vector in the rotating frame, $\\frac{D}{Dt} = \\frac{\\partial}{\\partial t} + \\mathbf{u} \\cdot \\nabla$ is the material derivative, $\\boldsymbol{\\Omega}$ is the Earth's angular velocity vector, $\\rho$ is the fluid density, $p$ is pressure, and $\\mathbf{g}$ is the acceleration due to gravity.\n\nFor a horizontal flow with velocity $\\mathbf{u}_h = u\\mathbf{i} + v\\mathbf{j}$, the horizontal components of the momentum equation, neglecting friction, are:\n$$ \\frac{Du}{Dt} = fv - \\frac{1}{\\rho}\\frac{\\partial p}{\\partial x} $$\n$$ \\frac{Dv}{Dt} = -fu - \\frac{1}{\\rho}\\frac{\\partial p}{\\partial y} $$\nwhere $f$ is the Coriolis parameter, and the material derivative for horizontal motion is $\\frac{D}{Dt} = \\frac{\\partial}{\\partial t} + u\\frac{\\partial}{\\partial x} + v\\frac{\\partial}{\\partial y}$. We assume a Boussinesq fluid, so density $\\rho$ is treated as a constant reference density $\\rho_0$ in the momentum equations. The full equations are:\n$$ \\frac{\\partial u}{\\partial t} + u\\frac{\\partial u}{\\partial x} + v\\frac{\\partial u}{\\partial y} = fv - \\frac{1}{\\rho_0}\\frac{\\partial p}{\\partial x} $$\n$$ \\frac{\\partial v}{\\partial t} + u\\frac{\\partial v}{\\partial x} + v\\frac{\\partial v}{\\partial y} = -fu - \\frac{1}{\\rho_0}\\frac{\\partial p}{\\partial y} $$\n\nNext, we nondimensionalize these equations using the given characteristic scales. Let primed variables denote nondimensional quantities:\n$u = Uu'$, $v = Uv'$, $x = Lx'$, $y = Ly'$, $t = (L/U)t'$.\nWe also introduce a characteristic scale for the dynamic pressure variations, $P_0$, such that $p = P_0 p'$.\n\nThe derivatives transform as:\n$\\frac{\\partial}{\\partial t} = \\frac{U}{L}\\frac{\\partial}{\\partial t'}$, $\\frac{\\partial}{\\partial x} = \\frac{1}{L}\\frac{\\partial}{\\partial x'}$, and $\\frac{\\partial}{\\partial y} = \\frac{1}{L}\\frac{\\partial}{\\partial y'}$.\n\nSubstituting these into the $x$-momentum equation:\n$$ \\frac{U}{L}\\frac{\\partial (Uu')}{\\partial t'} + (Uu')\\frac{1}{L}\\frac{\\partial (Uu')}{\\partial x'} + (Uv')\\frac{1}{L}\\frac{\\partial (Uu')}{\\partial y'} = f(Uv') - \\frac{1}{\\rho_0 L}\\frac{\\partial (P_0 p')}{\\partial x'} $$\nFactoring out the characteristic scales from each term:\n$$ \\left(\\frac{U^2}{L}\\right)\\left(\\frac{\\partial u'}{\\partial t'} + u'\\frac{\\partial u'}{\\partial x'} + v'\\frac{\\partial u'}{\\partial y'}\\right) = (fU)v' - \\left(\\frac{P_0}{\\rho_0 L}\\right)\\frac{\\partial p'}{\\partial x'} $$\nThe problem specifies that the pressure scale $P_0$ should be chosen to make the Coriolis and pressure-gradient terms of the same order of magnitude. The characteristic magnitude of the Coriolis term is $fU$, and that of the pressure-gradient term is $P_0/(\\rho_0 L)$. Equating them gives:\n$$ fU = \\frac{P_0}{\\rho_0 L} \\implies P_0 = \\rho_0 f L U $$\nThis choice defines the geostrophic scaling for pressure.\n\nTo obtain the final nondimensional equation, we divide by the characteristic magnitude of the Coriolis force per unit mass, which is $fU$:\n$$ \\frac{U^2/L}{fU}\\left(\\frac{\\partial u'}{\\partial t'} + u'\\frac{\\partial u'}{\\partial x'} + v'\\frac{\\partial u'}{\\partial y'}\\right) = \\frac{fU}{fU}v' - \\frac{P_0/(\\rho_0 L)}{fU}\\frac{\\partial p'}{\\partial x'} $$\nSimplifying the coefficients:\n$$ \\left(\\frac{U}{fL}\\right)\\left(\\frac{D u'}{D t'}\\right) = v' - \\frac{\\rho_0 f L U / (\\rho_0 L)}{fU}\\frac{\\partial p'}{\\partial x'} $$\n$$ \\left(\\frac{U}{fL}\\right)\\frac{D u'}{D t'} = v' - \\frac{\\partial p'}{\\partial x'} $$\nSimilarly, the $y$-momentum equation becomes:\n$$ \\left(\\frac{U}{fL}\\right)\\frac{D v'}{D t'} = -u' - \\frac{\\partial p'}{\\partial y'} $$\n\nThe nondimensional parameter multiplying the acceleration term $\\frac{D\\mathbf{u}'_h}{Dt'}$ is identified as $\\frac{U}{fL}$. This parameter is known as the Rossby number, denoted by $Ro$.\n$$ Ro = \\frac{U}{fL} $$\nThe Rossby number represents the ratio of the inertial forces (acceleration) to the Coriolis force.\n\nWe now compute the numerical value of the Rossby number using the provided data:\n$U = 0.5\\,\\mathrm{m\\,s^{-1}}$\n$L = 50\\,\\mathrm{km} = 50 \\times 10^3\\,\\mathrm{m} = 5 \\times 10^4\\,\\mathrm{m}$\n$f = 10^{-4}\\,\\mathrm{s^{-1}}$\n\n$$ Ro = \\frac{0.5\\,\\mathrm{m\\,s^{-1}}}{(10^{-4}\\,\\mathrm{s^{-1}}) \\times (5 \\times 10^4\\,\\mathrm{m})} = \\frac{0.5}{10^{-4} \\times 5 \\times 10^4} = \\frac{0.5}{5} = 0.1 $$\nRounding to three significant figures, the value is $0.100$.\n\nFinally, we assess the appropriate force balance. The nondimensional momentum equations are:\n$$ Ro\\frac{D u'}{D t'} = v' - \\frac{\\partial p'}{\\partial x'} $$\n$$ Ro\\frac{D v'}{D t'} = -u' - \\frac{\\partial p'}{\\partial y'} $$\nOur calculated Rossby number is $Ro = 0.1$. Since $Ro \\ll 1$, the acceleration terms, which are of order $Ro$, are an order of magnitude smaller than the Coriolis and pressure gradient terms, which are of order $1$. To leading order, we can neglect the terms multiplied by $Ro$. This results in the geostrophic balance:\n$$ 0 \\approx v' - \\frac{\\partial p'}{\\partial x'} $$\n$$ 0 \\approx -u' - \\frac{\\partial p'}{\\partial y'} $$\nCyclogeostrophic balance includes the advective part of the acceleration term, which is physically important in flows with strong curvature (e.g., eddies). This balance is $Ro(u'\\frac{\\partial u'}{\\partial x'} + v'\\frac{\\partial u'}{\\partial y'}) = v' - \\frac{\\partial p'}{\\partial x'}$ (in the radial direction for a circular flow). Since the advective acceleration is part of the $\\mathcal{O}(Ro)$ term, cyclogeostrophic balance represents a first-order correction to the geostrophic balance. Therefore, for $Ro=0.1$, the most appropriate balance *to leading order* is geostrophic balance.\n\nThe final answer required is the numerical value of the identified nondimensional parameter.",
            "answer": "$$\\boxed{0.100}$$"
        },
        {
            "introduction": "One of the most powerful diagnostic relationships in geophysical fluid dynamics is the thermal wind balance, which connects the vertical shear of the geostrophic current to horizontal density gradients. This practice () bridges theory with the practical realities of oceanographic measurement. You will first derive this fundamental relation and then tackle a common challenge: quantifying how uncertainty from discrete instrumental data propagates into the final calculation of geostrophic shear.",
            "id": "3794172",
            "problem": "A Boussinesq ocean with constant reference density $\\rho_{0}$ is observed at latitude where the Coriolis parameter is $f$. Consider the horizontal momentum equations on a rotating Earth and hydrostatic balance as the starting point. Let $\\mathbf{u}_{g}(x,y,z)$ denote the horizontal geostrophic velocity and $\\rho(x,y,z)$ the in situ density. Assume the Rossby number is small enough that cyclogeostrophic corrections are negligible for the derivation sought here.\n\nYou deploy four Conductivity–Temperature–Depth (CTD) profiles arranged in a cross centered on a target location, with one station at $(x+\\Delta x,y)$, one at $(x-\\Delta x,y)$, one at $(x,y+\\Delta y)$, and one at $(x,y-\\Delta y)$, each sampling density at the same depth $z$. Denote the measured densities at these four stations by $\\rho_{E}$, $\\rho_{W}$, $\\rho_{N}$, and $\\rho_{S}$, respectively. Each CTD density measurement is unbiased with independent Gaussian error of standard deviation $\\sigma_{\\rho}$, which is spatially and vertically uniform. You will estimate the horizontal density gradients at the center using the standard second-order central differences:\n$$\n\\left.\\frac{\\partial \\rho}{\\partial x}\\right|_{(x,y,z)} \\approx \\frac{\\rho_{E}-\\rho_{W}}{2\\,\\Delta x}, \\qquad \\left.\\frac{\\partial \\rho}{\\partial y}\\right|_{(x,y,z)} \\approx \\frac{\\rho_{N}-\\rho_{S}}{2\\,\\Delta y}.\n$$\n\nStarting from the rotating-frame momentum equations and hydrostatic balance, first derive the relation connecting the vertical shear of the geostrophic velocity $\\partial \\mathbf{u}_{g}/\\partial z$ to the horizontal gradients of density. Then, using linear uncertainty propagation and the measurement model described above, derive an analytic closed-form expression for the root-mean-square magnitude of the uncertainty in the estimated vertical geostrophic shear vector due solely to density measurement errors, that is,\n$$\n\\left[ \\mathbb{E}\\left( \\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2} \\right) \\right]^{1/2},\n$$\nexpressed in terms of $g$, $f$, $\\rho_{0}$, $\\sigma_{\\rho}$, $\\Delta x$, and $\\Delta y$.\n\nFinally, evaluate this expression numerically for\n$$\ng = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}, \\quad f = 1.0\\times 10^{-4}\\,\\mathrm{s}^{-1}, \\quad \\rho_{0} = 1025\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}, \\quad \\sigma_{\\rho} = 1.0\\times 10^{-2}\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}, \\quad \\Delta x = 2.0\\times 10^{4}\\,\\mathrm{m}, \\quad \\Delta y = 3.0\\times 10^{4}\\,\\mathrm{m}.\n$$\n\nRound your final numerical answer to four significant figures and express it in $\\mathrm{s}^{-1}$.",
            "solution": "The user has provided a problem that requires the derivation of the thermal wind equations, the derivation of an uncertainty propagation formula for the geostrophic shear, and a numerical calculation.\n\n### Step 1: Extract Givens\n- **Ocean Model**: Boussinesq ocean with constant reference density $\\rho_{0}$.\n- **Coriolis Parameter**: $f$ at a given latitude.\n- **Velocity and Density**: Horizontal geostrophic velocity $\\mathbf{u}_{g}(x,y,z)$, in situ density $\\rho(x,y,z)$.\n- **Approximations**: Started from horizontal momentum equations on a rotating Earth and hydrostatic balance. Rossby number is small, so cyclogeostrophic corrections are negligible.\n- **Measurement Scheme**: Four CTD profiles at $(x+\\Delta x,y)$, $(x-\\Delta x,y)$, $(x,y+\\Delta y)$, and $(x,y-\\Delta y)$, measuring densities $\\rho_{E}$, $\\rho_{W}$, $\\rho_{N}$, and $\\rho_{S}$ respectively, at the same depth $z$.\n- **Density Gradient Estimators**:\n  $$\n  \\left.\\frac{\\partial \\rho}{\\partial x}\\right|_{(x,y,z)} \\approx \\frac{\\rho_{E}-\\rho_{W}}{2\\,\\Delta x}, \\qquad \\left.\\frac{\\partial \\rho}{\\partial y}\\right|_{(x,y,z)} \\approx \\frac{\\rho_{N}-\\rho_{S}}{2\\,\\Delta y}.\n  $$\n- **Error Model**: Each density measurement is unbiased with independent Gaussian error of standard deviation $\\sigma_{\\rho}$, which is spatially and vertically uniform.\n- **First Task**: Derive the relation connecting the vertical shear of the geostrophic velocity $\\partial \\mathbf{u}_{g}/\\partial z$ to the horizontal gradients of density.\n- **Second Task**: Derive an analytic closed-form expression for the root-mean-square magnitude of the uncertainty in the estimated vertical geostrophic shear vector, $\\left[ \\mathbb{E}\\left( \\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2} \\right) \\right]^{1/2}$.\n- **Third Task**: Evaluate this expression numerically for the given constants and round to four significant figures.\n- **Constants**:\n  - $g = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$\n  - $f = 1.0\\times 10^{-4}\\,\\mathrm{s}^{-1}$\n  - $\\rho_{0} = 1025\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$\n  - $\\sigma_{\\rho} = 1.0\\times 10^{-2}\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$\n  - $\\Delta x = 2.0\\times 10^{4}\\,\\mathrm{m}$\n  - $\\Delta y = 3.0\\times 10^{4}\\,\\mathrm{m}$\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is based on fundamental principles of geophysical fluid dynamics, including geostrophic balance, hydrostatic balance, and the Boussinesq approximation. The thermal wind relation is a direct consequence of these principles. The use of linear uncertainty propagation is a standard statistical method. The problem is scientifically sound.\n- **Well-Posed**: All necessary information, including the physical framework, measurement model, error characteristics, and numerical constants, is provided. The tasks are clearly defined, leading to a unique and meaningful solution.\n- **Objective**: The problem is stated using precise, objective scientific terminology. There is no subjective or ambiguous language.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution will be provided.\n\n### Part 1: Derivation of the Thermal Wind Relation\n\nThe horizontal momentum equations for a steady, inviscid flow in a rotating frame, under the Boussinesq approximation, represent geostrophic balance. The geostrophic velocity components $(u_g, v_g)$ are related to the pressure field $p$ by:\n$$\n-f v_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial x}\n$$\n$$\nf u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}\n$$\nwhere $f$ is the Coriolis parameter and $\\rho_0$ is the constant reference density.\n\nThe vertical momentum equation reduces to hydrostatic balance:\n$$\n\\frac{\\partial p}{\\partial z} = -\\rho g\n$$\nwhere $\\rho$ is the in situ density and $g$ is the acceleration due to gravity.\n\nTo find the vertical shear of the geostrophic velocity, we differentiate the geostrophic balance equations with respect to the vertical coordinate $z$:\n$$\n-f \\frac{\\partial v_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial p}{\\partial x}\\right)\n$$\n$$\nf \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial p}{\\partial y}\\right)\n$$\nAssuming the pressure field is sufficiently smooth, we can interchange the order of differentiation (Clairaut's theorem):\n$$\n-f \\frac{\\partial v_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial x}\\left(\\frac{\\partial p}{\\partial z}\\right)\n$$\n$$\nf \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial p}{\\partial z}\\right)\n$$\nNow, substitute the hydrostatic balance relation $\\frac{\\partial p}{\\partial z} = -\\rho g$ into these equations:\n$$\n-f \\frac{\\partial v_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial x}(-\\rho g) = \\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial x}\n$$\n$$\nf \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}(-\\rho g) = \\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial y}\n$$\nSolving for the shear components gives the thermal wind equations:\n$$\n\\frac{\\partial u_g}{\\partial z} = \\frac{g}{\\rho_0 f} \\frac{\\partial \\rho}{\\partial y}\n$$\n$$\n\\frac{\\partial v_g}{\\partial z} = -\\frac{g}{\\rho_0 f} \\frac{\\partial \\rho}{\\partial x}\n$$\nIn vector form, the vertical shear of the geostrophic velocity $\\frac{\\partial \\mathbf{u}_g}{\\partial z} = \\left(\\frac{\\partial u_g}{\\partial z}, \\frac{\\partial v_g}{\\partial z}\\right)$ is related to the horizontal density gradient $\\nabla_h \\rho = \\left(\\frac{\\partial \\rho}{\\partial x}, \\frac{\\partial \\rho}{\\partial y}\\right)$ by:\n$$\n\\frac{\\partial \\mathbf{u}_g}{\\partial z} = \\frac{g}{\\rho_0 f} \\hat{\\mathbf{k}} \\times \\nabla_h \\rho\n$$\nwhere $\\hat{\\mathbf{k}}$ is the unit vector in the vertical direction. This is the required relation.\n\n### Part 2: Derivation of the Uncertainty Expression\n\nWe estimate the horizontal density gradients using the provided central difference formulas. Let the estimated quantities be denoted with a hat.\n$$\n\\widehat{\\frac{\\partial \\rho}{\\partial x}} = \\frac{\\rho_E - \\rho_W}{2\\Delta x}, \\qquad \\widehat{\\frac{\\partial \\rho}{\\partial y}} = \\frac{\\rho_N - \\rho_S}{2\\Delta y}\n$$\nThe measurements $\\rho_i$ ($i \\in \\{E, W, N, S\\}$) have independent random errors $\\epsilon_i$ with mean $\\mathbb{E}(\\epsilon_i) = 0$ and variance $\\mathbb{E}(\\epsilon_i^2) = \\sigma_\\rho^2$. The error in the estimate of the $x$-gradient is $\\delta(\\widehat{\\frac{\\partial \\rho}{\\partial x}}) = \\frac{\\epsilon_E - \\epsilon_W}{2\\Delta x}$. The variance of this error is:\n$$\n\\text{Var}\\left(\\delta\\left(\\widehat{\\frac{\\partial \\rho}{\\partial x}}\\right)\\right) = \\mathbb{E}\\left[\\left(\\frac{\\epsilon_E - \\epsilon_W}{2\\Delta x}\\right)^2\\right] = \\frac{1}{(2\\Delta x)^2} \\mathbb{E}[\\epsilon_E^2 - 2\\epsilon_E\\epsilon_W + \\epsilon_W^2]\n$$\nSince the errors are independent, $\\mathbb{E}[\\epsilon_E\\epsilon_W] = \\mathbb{E}[\\epsilon_E]\\mathbb{E}[\\epsilon_W] = 0$. Thus,\n$$\n\\sigma^2_{\\partial\\rho/\\partial x} = \\frac{\\mathbb{E}[\\epsilon_E^2] + \\mathbb{E}[\\epsilon_W^2]}{(2\\Delta x)^2} = \\frac{\\sigma_\\rho^2 + \\sigma_\\rho^2}{4(\\Delta x)^2} = \\frac{\\sigma_\\rho^2}{2(\\Delta x)^2}\n$$\nSimilarly, the variance of the error in the $y$-gradient estimate is:\n$$\n\\sigma^2_{\\partial\\rho/\\partial y} = \\frac{\\sigma_\\rho^2}{2(\\Delta y)^2}\n$$\nUsing the thermal wind relations, the estimated geostrophic shear components are:\n$$\n\\widehat{\\frac{\\partial u_g}{\\partial z}} = \\frac{g}{\\rho_0 f} \\widehat{\\frac{\\partial \\rho}{\\partial y}}, \\qquad \\widehat{\\frac{\\partial v_g}{\\partial z}} = -\\frac{g}{\\rho_0 f} \\widehat{\\frac{\\partial \\rho}{\\partial x}}\n$$\nThe errors in these estimates are $\\delta\\left(\\widehat{\\frac{\\partial u_g}{\\partial z}}\\right) = \\frac{g}{\\rho_0 f} \\delta\\left(\\widehat{\\frac{\\partial \\rho}{\\partial y}}\\right)$ and $\\delta\\left(\\widehat{\\frac{\\partial v_g}{\\partial z}}\\right) = -\\frac{g}{\\rho_0 f} \\delta\\left(\\widehat{\\frac{\\partial \\rho}{\\partial x}}\\right)$. The variances of the shear component errors are:\n$$\n\\sigma^2_{\\partial u_g/\\partial z} = \\text{Var}\\left(\\delta\\left(\\widehat{\\frac{\\partial u_g}{\\partial z}}\\right)\\right) = \\left(\\frac{g}{\\rho_0 f}\\right)^2 \\sigma^2_{\\partial\\rho/\\partial y} = \\left(\\frac{g}{\\rho_0 f}\\right)^2 \\frac{\\sigma_\\rho^2}{2(\\Delta y)^2}\n$$\n$$\n\\sigma^2_{\\partial v_g/\\partial z} = \\text{Var}\\left(\\delta\\left(\\widehat{\\frac{\\partial v_g}{\\partial z}}\\right)\\right) = \\left(-\\frac{g}{\\rho_0 f}\\right)^2 \\sigma^2_{\\partial\\rho/\\partial x} = \\left(\\frac{g}{\\rho_0 f}\\right)^2 \\frac{\\sigma_\\rho^2}{2(\\Delta x)^2}\n$$\nWe need to find the root-mean-square magnitude of the uncertainty in the shear vector, which is $\\left[ \\mathbb{E}\\left( \\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2} \\right) \\right]^{1/2}$. The squared magnitude of the error vector is:\n$$\n\\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2} = \\left(\\delta\\left(\\widehat{\\frac{\\partial u_g}{\\partial z}}\\right)\\right)^2 + \\left(\\delta\\left(\\widehat{\\frac{\\partial v_g}{\\partial z}}\\right)\\right)^2\n$$\nTaking the expectation:\n$$\n\\mathbb{E}\\left[\\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2}\\right] = \\mathbb{E}\\left[\\left(\\delta\\left(\\widehat{\\frac{\\partial u_g}{\\partial z}}\\right)\\right)^2\\right] + \\mathbb{E}\\left[\\left(\\delta\\left(\\widehat{\\frac{\\partial v_g}{\\partial z}}\\right)\\right)^2\\right] = \\sigma^2_{\\partial u_g/\\partial z} + \\sigma^2_{\\partial v_g/\\partial z}\n$$\nThe errors in the two gradient components are uncorrelated because all density measurement errors $\\epsilon_i$ are independent. Substituting the variances:\n$$\n\\mathbb{E}\\left[\\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2}\\right] = \\left(\\frac{g}{\\rho_0 f}\\right)^2 \\frac{\\sigma_\\rho^2}{2(\\Delta y)^2} + \\left(\\frac{g}{\\rho_0 f}\\right)^2 \\frac{\\sigma_\\rho^2}{2(\\Delta x)^2}\n$$\nFactoring out common terms:\n$$\n\\mathbb{E}\\left[\\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2}\\right] = \\frac{1}{2}\\left(\\frac{g \\sigma_\\rho}{\\rho_0 f}\\right)^2 \\left(\\frac{1}{(\\Delta x)^2} + \\frac{1}{(\\Delta y)^2}\\right)\n$$\nTaking the square root gives the desired expression for the RMS uncertainty magnitude:\n$$\n\\left[ \\mathbb{E}\\left( \\left| \\delta\\left(\\frac{\\partial \\mathbf{u}_{g}}{\\partial z}\\right)\\right|^{2} \\right) \\right]^{1/2} = \\sqrt{\\frac{1}{2}\\left(\\frac{g \\sigma_\\rho}{\\rho_0 f}\\right)^2 \\left(\\frac{1}{(\\Delta x)^2} + \\frac{1}{(\\Delta y)^2}\\right)} = \\frac{g \\sigma_\\rho}{\\sqrt{2} |\\rho_0 f|} \\sqrt{\\frac{1}{(\\Delta x)^2} + \\frac{1}{(\\Delta y)^2}}\n$$\nSince all provided constants are positive, we can drop the absolute value on $f$.\n\n### Part 3: Numerical Evaluation\n\nWe are given the following values:\n$g = 9.81\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$\n$f = 1.0\\times 10^{-4}\\,\\mathrm{s}^{-1}$\n$\\rho_{0} = 1025\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$\n$\\sigma_{\\rho} = 1.0\\times 10^{-2}\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$\n$\\Delta x = 2.0\\times 10^{4}\\,\\mathrm{m}$\n$\\Delta y = 3.0\\times 10^{4}\\,\\mathrm{m}$\n\nLet $U$ be the uncertainty we want to calculate.\n$$\nU = \\frac{9.81 \\times (1.0 \\times 10^{-2})}{\\sqrt{2} \\times 1025 \\times (1.0 \\times 10^{-4})} \\sqrt{\\frac{1}{(2.0 \\times 10^{4})^2} + \\frac{1}{(3.0 \\times 10^{4})^2}}\n$$\n$$\nU = \\frac{0.0981}{\\sqrt{2} \\times 0.1025} \\sqrt{\\frac{1}{4.0 \\times 10^8} + \\frac{1}{9.0 \\times 10^8}}\n$$\n$$\nU = \\frac{0.0981}{0.144956...} \\sqrt{\\frac{1}{10^8}\\left(\\frac{1}{4} + \\frac{1}{9}\\right)}\n$$\n$$\nU \\approx 0.67675 \\times \\frac{1}{10^4} \\sqrt{\\frac{9+4}{36}}\n$$\n$$\nU \\approx 0.67675 \\times 10^{-4} \\times \\sqrt{\\frac{13}{36}} = 0.67675 \\times 10^{-4} \\times \\frac{\\sqrt{13}}{6}\n$$\n$$\nU \\approx 0.67675 \\times 10^{-4} \\times \\frac{3.60555}{6} \\approx 0.67675 \\times 10^{-4} \\times 0.600925\n$$\n$$\nU \\approx 4.0667 \\times 10^{-5}\\,\\mathrm{s}^{-1}\n$$\nRounding to four significant figures, the result is $4.067 \\times 10^{-5}\\,\\mathrm{s}^{-1}$.",
            "answer": "$$\n\\boxed{4.067 \\times 10^{-5}}\n$$"
        },
        {
            "introduction": "While geostrophic balance allows us to diagnose currents from pressure, we often face the inverse problem: estimating the pressure field from velocity data. This is a central task in creating dynamically consistent maps of the ocean state from observations or model output. This advanced computational exercise () guides you through building a Tikhonov-regularized inversion to compute a pressure field that best fits a given velocity field in a least-squares sense, introducing a robust technique for handling ill-posed problems.",
            "id": "3794121",
            "problem": "You are tasked with building a complete, runnable program in the Python programming language that performs a Tikhonov-regularized least-squares inversion to estimate the pressure field $p$ on a two-dimensional ocean grid by enforcing the geostrophic balance $f\\hat{k}\\times\\mathbf{u}\\approx-(1/\\rho_{0})\\nabla p$. The derivation must begin from the rotating-frame momentum equations and proceed to a computational formulation suitable for numerical implementation. The program must compute and report quantitative sensitivity of the solution to the penalty weight.\n\nStart from the rotating-frame momentum equation for an incompressible ocean,\n$$\n\\rho_{0}\\frac{D\\mathbf{u}}{Dt}+2\\rho_{0}\\boldsymbol{\\Omega}\\times\\mathbf{u}=-\\nabla p+\\text{friction}+\\text{other forces},\n$$\nand consider the quasi-steady, horizontally non-divergent, hydrostatic regime in which advective acceleration and friction are neglected to leading order, reducing to the geostrophic balance\n$$\nf\\hat{k}\\times\\mathbf{u}\\approx-\\frac{1}{\\rho_{0}}\\nabla p,\n$$\nwhere $f$ is the Coriolis parameter, $\\hat{k}$ is the vertical unit vector, $\\mathbf{u}=(u_{x},u_{y})$ is the horizontal velocity, $\\rho_{0}$ is the reference density, and $p$ is the dynamic pressure. In strongly curved flows, the cyclogeostrophic correction introduces a centrifugal term $(\\mathbf{u}\\cdot\\nabla)\\mathbf{u}$, but in this task you will enforce only the geostrophic relation in the inversion and examine sensitivity to the penalty weight.\n\nDefine the unknown pressure field $p$ on a uniform, two-dimensional, square grid with $N_{x}\\times N_{y}$ nodes covering a domain of side length $L$ in meters. Let $(x,y)$ be Cartesian coordinates centered at the domain center. The observed velocity field is a synthetic axisymmetric vortex, specified in polar coordinates by the azimuthal speed\n$$\nu_{\\theta}(r)=V_{0}\\exp\\left[-\\left(\\frac{r}{R}\\right)^{2}\\right],\n$$\nwith $r=\\sqrt{x^{2}+y^{2}}$, peak speed $V_{0}$ in meters per second, and vortex scale $R$ in meters. Convert to Cartesian components via\n$$\nu_{x}(x,y)=-u_{\\theta}(r)\\frac{y}{r},\\quad u_{y}(x,y)=u_{\\theta}(r)\\frac{x}{r},\n$$\nwith the convention $u_{x}=u_{y}=0$ at $r=0$.\n\nLet $D$ denote the discrete gradient operator mapping the grid node values of $p$ to the stacked field $(\\partial p/\\partial x,\\partial p/\\partial y)$ at nodes. Use second-order centered differences in the interior and consistent one-sided differences on the boundaries. Define the target gradient field implied by geostrophy,\n$$\n\\mathbf{g}(x,y)=\\nabla p_{\\text{geo}}(x,y)=-\\rho_{0}f\\,\\hat{k}\\times\\mathbf{u}(x,y),\n$$\nso that $g_{x}(x,y)=\\rho_{0}f\\,u_{y}(x,y)$ and $g_{y}(x,y)=-\\rho_{0}f\\,u_{x}(x,y)$.\n\nFormulate the Tikhonov-regularized least-squares problem for $p$ by minimizing\n$$\nJ(p)=\\left\\|Dp-\\mathbf{g}\\right\\|_{2}^{2}+\\alpha\\left\\|p\\right\\|_{2}^{2},\n$$\nwhere $\\alpha$ is the penalty weight with units of inverse square meters ($\\text{m}^{-2}$) ensuring dimensional consistency between the two terms. Derive and implement the corresponding normal equations, noting that for $\\alpha0$ the system is symmetric positive definite.\n\nNumerical specification:\n- Use $N_{x}=N_{y}=41$, $L=160{,}000$ meters, and uniform grid spacing $d_{x}=d_{y}=L/(N_{x}-1)$.\n- Use $R=40{,}000$ meters, $f=10^{-4}$ per second, and $\\rho_{0}=1025$ kilograms per cubic meter.\n- Construct $D$ to act on node-centered $p$, producing node-centered discrete gradients with the finite-difference scheme described above.\n- Solve the linear system for $p$ using a numerically stable method appropriate for symmetric positive definite matrices.\n\nEvaluation metrics:\n- Compute the geostrophic residual field\n$$\n\\mathbf{r}(x,y)=f\\hat{k}\\times\\mathbf{u}(x,y)+\\frac{1}{\\rho_{0}}\\nabla p(x,y),\n$$\nand report the Root Mean Square (RMS) of its magnitude over all grid nodes in meters per second squared, rounded to six decimal places.\n- Compute the RMS magnitude of the inverted pressure gradient $\\nabla p$ over all grid nodes in pascals per meter, rounded to six decimal places.\n\nTest suite:\nEvaluate the inversion for the following six parameter pairs $(V_{0},\\alpha)$:\n1. $V_{0}=0.1$ meters per second, $\\alpha=10^{-8}$ per square meter.\n2. $V_{0}=0.1$ meters per second, $\\alpha=10^{-7}$ per square meter.\n3. $V_{0}=0.1$ meters per second, $\\alpha=10^{-6}$ per square meter.\n4. $V_{0}=1.0$ meters per second, $\\alpha=10^{-8}$ per square meter.\n5. $V_{0}=1.0$ meters per second, $\\alpha=10^{-7}$ per square meter.\n6. $V_{0}=1.0$ meters per second, $\\alpha=10^{-6}$ per square meter.\n\nFinal output format:\nYour program should produce a single line of output containing the twelve results in the following order: for each test case, append the geostrophic residual RMS (in meters per second squared) followed by the pressure-gradient RMS (in pascals per meter). The final output must be a comma-separated list enclosed in square brackets, for example, \"[rms1,grad1,rms2,grad2,...]\". All values must be rounded to six decimal places in their respective units as specified.",
            "solution": "The problem requires the estimation of a two-dimensional pressure field $p$ from a given velocity field $\\mathbf{u}$ by inverting the geostrophic balance relationship. This is a classic inverse problem in geophysical fluid dynamics. The solution will be formulated using a Tikhonov-regularized least-squares approach to ensure the problem is well-posed and to control the sensitivity of the solution.\n\nThe starting point is the geostrophic balance equation, a leading-order approximation of the momentum equations in a rotating frame for large-scale, slow-moving flows:\n$$\nf\\hat{k}\\times\\mathbf{u} = -\\frac{1}{\\rho_{0}}\\nabla p\n$$\nHere, $f$ is the Coriolis parameter, $\\hat{k}$ is the upward vertical unit vector, $\\mathbf{u}=(u_x, u_y)$ is the horizontal velocity vector, $\\rho_{0}$ is a constant reference density, and $\\nabla p$ is the horizontal pressure gradient.\n\nThis equation can be rearranged to define a target pressure gradient, $\\mathbf{g}$, that is directly computable from the observed velocity field:\n$$\n\\mathbf{g} \\equiv \\nabla p_{\\text{geo}} = -\\rho_{0}f\\hat{k}\\times\\mathbf{u}\n$$\nIn component form, since $\\hat{k}\\times\\mathbf{u} = (0,0,1)\\times(u_x, u_y, 0) = (-u_y, u_x, 0)$, the components of the target gradient are:\n$$\ng_x = \\rho_{0} f u_y \\quad \\text{and} \\quad g_y = -\\rho_{0} f u_x\n$$\nThe problem is now to find a scalar pressure field $p(x,y)$ whose gradient, $\\nabla p$, is as close as possible to the target gradient $\\mathbf{g}(x,y)$. This is an inverse problem because we are determining a field ($p$) from its derivatives ($\\nabla p$). Such problems are often ill-posed; in this case, the pressure $p$ is only determined up to an arbitrary constant, since the gradient of a constant is zero.\n\nTo formalize this as a solvable numerical problem, we first discretize the domain. The pressure $p$ is represented by its values at the nodes of a uniform $N_x \\times N_y$ grid. These $N_p = N_x N_y$ values are flattened into a single-column vector $\\mathbf{p}$ of size $N_p$.\n\nThe continuous gradient operator $\\nabla$ is replaced by a discrete finite-difference operator, represented by a matrix $D$. This matrix maps the pressure vector $\\mathbf{p}$ to a vector of its discrete gradients. The gradient vector has $2N_p$ components, concatenating the $N_p$ values of $\\partial p/\\partial x$ and the $N_p$ values of $\\partial p/\\partial y$. Thus, $D$ is a $2N_p \\times N_p$ matrix. We construct $D$ as a stack of two matrices, $D_x$ and $D_y$, which compute the partial derivatives in the $x$ and $y$ directions, respectively:\n$$\nD = \\begin{pmatrix} D_x \\\\ D_y \\end{pmatrix}\n$$\nFollowing the problem specification, we use second-order centered differences for interior grid points and first-order one-sided (forward/backward) differences at the boundaries. For a grid spacing of $d_x$, the $x$-derivatives are computed as:\n$$\n\\left(\\frac{\\partial p}{\\partial x}\\right)_{i,j} \\approx \\begin{cases} (p_{1,j} - p_{0,j}) / d_x  \\text{if } i=0 \\\\ (p_{i+1,j} - p_{i-1,j}) / (2d_x)  \\text{if } 0  i  N_x-1 \\\\ (p_{N_x-1,j} - p_{N_x-2,j}) / d_x  \\text{if } i=N_x-1 \\end{cases}\n$$\nA similar scheme is used for the $y$-derivatives with spacing $d_y$.\n\nThe target gradient field $\\mathbf{g}$ is also evaluated at each of the $N_p$ grid points and flattened into a vector of length $2N_p$, compatible with the output of the discrete operator $D$.\n\nThe inversion seeks to find a pressure vector $\\mathbf{p}$ that minimizes the squared Euclidean norm of the difference between the computed gradient $D\\mathbf{p}$ and the target gradient $\\mathbf{g}$. To address the ill-posedness and regularize the solution, a penalty term is added, which penalizes large-magnitude pressure solutions. This leads to the Tikhonov-regularized least-squares cost function $J(\\mathbf{p})$:\n$$\nJ(\\mathbf{p}) = \\| D\\mathbf{p} - \\mathbf{g} \\|_{2}^{2} + \\alpha \\| \\mathbf{p} \\|_{2}^{2}\n$$\nHere, $\\alpha  0$ is the regularization parameter, or penalty weight. The term $\\| \\mathbf{p} \\|_{2}^{2}$ is the squared $L_2$ norm of the pressure vector, and its inclusion ensures that the problem has a unique, stable solution. The units of $\\alpha$ must be inverse length squared, e.g., $\\text{m}^{-2}$, to ensure dimensional consistency between the two terms of the cost function, as both $D\\mathbf{p}$ and $\\mathbf{g}$ have units of pressure per length ($\\text{Pa/m}$).\n\nTo find the vector $\\mathbf{p}$ that minimizes $J(\\mathbf{p})$, we compute the gradient of $J$ with respect to $\\mathbf{p}$ and set it to zero.\n$$\nJ(\\mathbf{p}) = (\\mathbf{p}^T D^T - \\mathbf{g}^T)(D\\mathbf{p} - \\mathbf{g}) + \\alpha \\mathbf{p}^T \\mathbf{p} = \\mathbf{p}^T D^T D \\mathbf{p} - 2\\mathbf{g}^T D \\mathbf{p} + \\mathbf{g}^T\\mathbf{g} + \\alpha \\mathbf{p}^T I \\mathbf{p}\n$$\nTaking the derivative with respect to $\\mathbf{p}$ gives:\n$$\n\\frac{\\partial J}{\\partial \\mathbf{p}} = 2(D^T D)\\mathbf{p} - 2 D^T \\mathbf{g} + 2\\alpha I \\mathbf{p}\n$$\nSetting $\\partial J / \\partial \\mathbf{p} = 0$ yields the normal equations:\n$$\n(D^T D + \\alpha I) \\mathbf{p} = D^T \\mathbf{g}\n$$\nThis is a linear system of the form $A\\mathbf{x} = \\mathbf{b}$, where $A = D^T D + \\alpha I$ is an $N_p \\times N_p$ matrix, the unknown vector is $\\mathbf{x} = \\mathbf{p}$, and the right-hand side is the vector $\\mathbf{b} = D^T \\mathbf{g}$. For $\\alpha  0$, the matrix $A$ is symmetric and positive definite, which guarantees a unique solution and allows for efficient and stable numerical solvers, such as Cholesky factorization.\n\nOnce the system is solved for $\\mathbf{p}$, the evaluation metrics can be computed.\nThe Root Mean Square (RMS) magnitude of the inverted pressure gradient is calculated as:\n$$\n\\text{RMS}(\\|\\nabla p\\|) = \\sqrt{\\frac{1}{N_p} \\sum_{k=1}^{N_p} \\left( \\left(\\frac{\\partial p}{\\partial x}\\right)_k^2 + \\left(\\frac{\\partial p}{\\partial y}\\right)_k^2 \\right)} = \\sqrt{\\frac{1}{N_p} \\|D\\mathbf{p}\\|_2^2}\n$$\nThe geostrophic residual field is defined as $\\mathbf{r} = f\\hat{k}\\times\\mathbf{u} + \\frac{1}{\\rho_0}\\nabla p$. Using the definition of $\\mathbf{g}$, we can write $\\mathbf{r} = -\\frac{1}{\\rho_0}\\mathbf{g} + \\frac{1}{\\rho_0}D\\mathbf{p} = \\frac{1}{\\rho_0}(D\\mathbf{p}-\\mathbf{g})$. The RMS of its magnitude is:\n$$\n\\text{RMS}(\\|\\mathbf{r}\\|) = \\sqrt{\\frac{1}{N_p} \\sum_{k=1}^{N_p} \\left( r_{x,k}^2 + r_{y,k}^2 \\right)} = \\frac{1}{\\rho_0} \\sqrt{\\frac{1}{N_p} \\|D\\mathbf{p}-\\mathbf{g}\\|_2^2}\n$$\nThe program will implement this entire procedure for each pair of $(V_0, \\alpha)$ provided in the test suite, reporting the two specified RMS metrics.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main function to run the Tikhonov-regularized inversion for all test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (V0 [m/s], alpha [m^-2])\n        (0.1, 1e-8),\n        (0.1, 1e-7),\n        (0.1, 1e-6),\n        (1.0, 1e-8),\n        (1.0, 1e-7),\n        (1.0, 1e-6),\n    ]\n\n    # Physical and grid constants\n    NX = 41\n    NY = 41\n    L = 160000.0  # meters\n    R = 40000.0   # meters\n    F = 1e-4      # s^-1\n    RHO0 = 1025.0 # kg/m^3\n\n    results = []\n    for v0, alpha in test_cases:\n        rms_res, rms_grad = compute_inversion(v0, alpha, NX, NY, L, R, F, RHO0)\n        results.append(f\"{rms_res:.6f}\")\n        results.append(f\"{rms_grad:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\ndef compute_inversion(v0, alpha, nx, ny, L, R, f, rho0):\n    \"\"\"\n    Performs the inversion for a single set of parameters.\n\n    Args:\n        v0 (float): Peak vortex speed [m/s].\n        alpha (float): Tikhonov regularization parameter [m^-2].\n        nx (int): Number of grid points in x.\n        ny (int): Number of grid points in y.\n        L (float): Domain side length [m].\n        R (float): Vortex scale radius [m].\n        f (float): Coriolis parameter [s^-1].\n        rho0 (float): Reference density [kg/m^3].\n\n    Returns:\n        tuple[float, float]: A tuple containing:\n            - rms_residual (float): RMS of geostrophic residual [m/s^2].\n            - rms_grad_p (float): RMS of pressure gradient magnitude [Pa/m].\n    \"\"\"\n    \n    # 1. Grid setup\n    np_total = nx * ny\n    dx = L / (nx - 1)\n    dy = L / (ny - 1)\n    x_coords = np.linspace(-L / 2.0, L / 2.0, nx)\n    y_coords = np.linspace(-L / 2.0, L / 2.0, ny)\n    xx, yy = np.meshgrid(x_coords, y_coords, indexing='ij')\n\n    # 2. Construct velocity field and target gradient vector 'g'\n    r = np.sqrt(xx**2 + yy**2)\n    u_theta = v0 * np.exp(-(r/R)**2)\n    \n    ux = np.zeros_like(r)\n    uy = np.zeros_like(r)\n    \n    # Avoid division by zero at the center r=0\n    mask = r > 0\n    ux[mask] = -u_theta[mask] * yy[mask] / r[mask]\n    uy[mask] = u_theta[mask] * xx[mask] / r[mask]\n    \n    gx = rho0 * f * uy\n    gy = -rho0 * f * ux\n    \n    g_vec = np.concatenate([gx.ravel(), gy.ravel()])\n\n    # 3. Construct discrete gradient operator 'D'\n    Dx = np.zeros((np_total, np_total))\n    Dy = np.zeros((np_total, np_total))\n\n    for i in range(nx):\n        for j in range(ny):\n            k = i * ny + j # Flattened index, row-major style ('C') is default for ravel. Our i,j corresponds to this.\n            \n            # X-derivative\n            if i == 0:  # Forward difference on left boundary\n                k_fwd = (i + 1) * ny + j\n                Dx[k, k] = -1.0 / dx\n                Dx[k, k_fwd] = 1.0 / dx\n            elif i == nx - 1:  # Backward difference on right boundary\n                k_bwd = (i - 1) * ny + j\n                Dx[k, k] = 1.0 / dx\n                Dx[k, k_bwd] = -1.0 / dx\n            else:  # Centered difference in interior\n                k_fwd = (i + 1) * ny + j\n                k_bwd = (i - 1) * ny + j\n                Dx[k, k_fwd] = 1.0 / (2.0 * dx)\n                Dx[k, k_bwd] = -1.0 / (2.0 * dx)\n\n            # Y-derivative\n            if j == 0:  # Forward difference on bottom boundary\n                k_fwd = i * ny + (j + 1)\n                Dy[k, k] = -1.0 / dy\n                Dy[k, k_fwd] = 1.0 / dy\n            elif j == ny - 1:  # Backward difference on top boundary\n                k_bwd = i * ny + (j - 1)\n                Dy[k, k] = 1.0 / dy\n                Dy[k, k_bwd] = -1.0 / dy\n            else:  # Centered difference in interior\n                k_fwd = i * ny + (j + 1)\n                k_bwd = i * ny + (j - 1)\n                Dy[k, k_fwd] = 1.0 / (2.0 * dy)\n                Dy[k, k_bwd] = -1.0 / (2.0 * dy)\n    \n    D = np.vstack([Dx, Dy])\n\n    # 4. Solve the normal equations\n    A = D.T @ D + alpha * np.identity(np_total)\n    b = D.T @ g_vec\n    \n    # Use a solver optimized for symmetric positive-definite matrices\n    p_vec = linalg.solve(A, b, assume_a='pos')\n\n    # 5. Calculate evaluation metrics\n    grad_p_vec = D @ p_vec\n    \n    # RMS of |grad(p)|\n    grad_p_x_flat = grad_p_vec[:np_total]\n    grad_p_y_flat = grad_p_vec[np_total:]\n    grad_p_mag_sq = grad_p_x_flat**2 + grad_p_y_flat**2\n    rms_grad_p = np.sqrt(np.mean(grad_p_mag_sq))\n\n    # RMS of geostrophic residual\n    # residual r = (1/rho0) * (Dp - g)\n    residual_vec = grad_p_vec - g_vec\n    r_vec = (1.0 / rho0) * residual_vec\n    r_x_flat = r_vec[:np_total]\n    r_y_flat = r_vec[np_total:]\n    r_mag_sq = r_x_flat**2 + r_y_flat**2\n    rms_residual = np.sqrt(np.mean(r_mag_sq))\n    \n    return rms_residual, rms_grad_p\n\nsolve()\n```"
        }
    ]
}