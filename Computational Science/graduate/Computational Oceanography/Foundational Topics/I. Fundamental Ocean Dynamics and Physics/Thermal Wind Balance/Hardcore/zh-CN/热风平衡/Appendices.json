{
    "hands_on_practices": [
        {
            "introduction": "理论学习之后，最好的巩固方式就是亲手实践。本节的第一个练习将引导我们从最基本的动力学平衡出发，推导出热成风关系，并利用海洋中典型的参数值来估算地转流的垂直切变大小 。这个练习旨在加深我们对热成风平衡物理内涵的理解，并对海洋中地转流切变的实际量级建立直观认识。",
            "id": "3816946",
            "problem": "假设一个在$f$平面上的稳定分层的Boussinesq海洋，处于大尺度的、稳定的、无粘性的流动中，该流动满足水平地转平衡和垂直静力平衡。仅从这些基本平衡关系和Brunt–Väisälä频率的定义出发，推导连接地转速度沿$x$分量的垂直导数与经向密度梯度的关系式。然后利用该关系式，根据以下参数，估算垂直地转切变的量级，以及由此推算出的在$500\\ \\text{m}$垂直距离上沿$x$方向的地转速度差的量级：\n- 科里奥利参数 $f = 10^{-4}\\ \\text{s}^{-1}$，\n- 重力加速度 $g = 9.81\\ \\text{m s}^{-2}$，\n- Brunt–Väisälä频率 $N = 10^{-3}\\ \\text{s}^{-1}$，\n- 经向密度梯度 $\\partial \\rho/\\partial y = 10^{-4}\\ \\text{kg m}^{-4}$，\n- 参考密度 $\\rho_0 = 1025\\ \\text{kg m}^{-3}$。\n\n将 $f$、$g$ 和 $\\rho_0$ 视为不随深度变化的常数。清楚地说明任何符号约定并计算其量级。\n\n将最终答案表示为$500\\ \\text{m}$垂直距离上的地转速度差的量级，单位为米/秒，并四舍五入到三位有效数字。最终的方框答案中不要包含单位。",
            "solution": "该问题要求推导热成风关系，并应用它来估算地转速度差。我们首先建立物理框架和坐标系。我们采用标准的笛卡尔坐标系，其中$x$指向纬向（东向），$y$指向经向（北向），$z$垂直向上。科里奥利参数$f$是一个正常数，$f = 10^{-4}\\ \\text{s}^{-1}$，适用于北半球。\n\n假设流动是在Boussinesq流体中的大尺度、稳定的、无粘性的地转和静力平衡状态。描述此状态的控制方程是：\n\n1.  **水平地转平衡**：压力梯度力与科里奥利力相平衡。对于速度的纬向分量$u_g$，这表示为：\n    $$f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}$$\n    其中$p$是压力，$\\rho_0$是恒定的参考密度。\n\n2.  **垂直静力平衡**：垂直压力梯度与重力相平衡：\n    $$\\frac{\\partial p}{\\partial z} = -\\rho g$$\n    其中$\\rho$是总密度，$g$是重力加速度。\n\n主要任务是推导热成风关系，它将地转速度的垂直切变（$\\partial u_g/\\partial z$）与水平密度梯度（$\\partial \\rho/\\partial y$）联系起来。我们从纬向地转平衡方程开始：\n$$f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}$$\n然后，我们对该方程求关于垂直坐标$z$的偏导数。根据题目要求，将$f$和$\\rho_0$视为常数，我们得到：\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial p}{\\partial y}\\right)$$\n假设压力场$p(y, z)$是二阶连续可微的，我们可以交换偏微分的顺序（根据Clairaut关于混合偏导数相等的定理）：\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial p}{\\partial z}\\right)$$\n接下来，我们将静力平衡关系 $\\frac{\\partial p}{\\partial z} = -\\rho g$ 代入方程的右边：\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}(-\\rho g)$$\n由于重力加速度$g$被假定为常数，我们可以将其移到导数符号外面：\n$$f \\frac{\\partial u_g}{\\partial z} = \\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial y}$$\n最后，我们求解垂直地转切变 $\\frac{\\partial u_g}{\\partial z}$：\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial y}$$\n这就是地转速度纬向分量的热成风关系。它直接源于地转平衡和静力平衡。尽管问题陈述中提到从Brunt–Väisälä频率$N$的定义出发，但在该关系的标准推导中并未出现这个量。所提供的$N$值是层结的度量，它是该物理机制的必要条件，但对于所要求的具体计算而言并非必需。\n\n现在我们可以使用给定的参数计算垂直地转切变的量级：\n- $g = 9.81\\ \\text{m s}^{-2}$\n- $f = 10^{-4}\\ \\text{s}^{-1}$\n- $\\rho_0 = 1025\\ \\text{kg m}^{-3}$\n- $\\frac{\\partial \\rho}{\\partial y} = 10^{-4}\\ \\text{kg m}^{-4}$\n\n将这些值代入热成风关系：\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{(9.81\\ \\text{m s}^{-2})}{(10^{-4}\\ \\text{s}^{-1}) (1025\\ \\text{kg m}^{-3})} (10^{-4}\\ \\text{kg m}^{-4})$$\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{9.81 \\cdot 10^{-4}}{1025 \\cdot 10^{-4}}\\ \\text{s}^{-1} = \\frac{9.81}{1025}\\ \\text{s}^{-1} \\approx 0.0095707\\ \\text{s}^{-1}$$\n垂直地转切变的量级约为 $9.57 \\times 10^{-3}\\ \\text{s}^{-1}$。\n\n最后一步是估算在$\\Delta z = 500\\ \\text{m}$的垂直距离上，沿$x$方向的地转速度差 $\\Delta u_g$ 的量级。假设切变 $\\frac{\\partial u_g}{\\partial z}$ 在此深度范围内是恒定的，我们可以将速度差近似为：\n$$\\Delta u_g \\approx \\frac{\\partial u_g}{\\partial z} \\Delta z$$\n由于我们关心的是量级，且所有量都为正：\n$$|\\Delta u_g| \\approx \\left| \\frac{9.81}{1025}\\ \\text{s}^{-1} \\right| \\times 500\\ \\text{m}$$\n$$|\\Delta u_g| \\approx (0.0095707\\ \\text{s}^{-1}) \\times 500\\ \\text{m} \\approx 4.785365\\ \\text{m s}^{-1}$$\n按照要求将结果四舍五入到三位有效数字，我们得到速度差的量级。\n$$|\\Delta u_g| \\approx 4.79\\ \\text{m s}^{-1}$$",
            "answer": "$$\\boxed{4.79}$$"
        },
        {
            "introduction": "在掌握了热成风的基本计算后，我们将挑战一个更贴近实际科研工作任务的计算实践。现代海洋学研究高度依赖于网格化的温盐观测或模型数据，本练习要求我们设计一个计算流程，将三维的温度和盐度场转化为地转流的垂直切变场 。这个过程不仅涉及到热成风关系的应用，还包括了如何正确使用海水状态方程（TEOS-10）的线性化形式以及数值方法（如有限差分）来处理数据，这是计算海洋学中的一项核心技能。",
            "id": "3816979",
            "problem": "给定在恒定纬度 $\\phi$（单位为$\\mathrm{degrees}$）的均匀直线网格上，水平变化的三维绝对盐度场 $S_A(x,y,z)$（单位为$\\mathrm{g}\\,\\mathrm{kg}^{-1}$）和保守温度场 $\\Theta(x,y,z)$（单位为$\\mathrm{^\\circ C}$）。从一个有效的物理基础出发，设计并实现一个计算流程，该流程计算物理上一致的海水密度场 $\\rho(x,y,z)$，然后评估由旋转、分层和静水压力之间的平衡所隐含的垂直地转切变。您的流程必须明确且一致地使用海水热力学方程 (TEOS-10) 的导数结构，而不是对可能含噪声的 $\\rho(x,y,z)$ 场进行数值微分。推导必须从旋转坐标系下的动量方程和静水近似开始，并逻辑地推导出垂直切变和水平密度梯度之间的热成风关系。您的算法必须以国际单位制 (SI) 表示所有量，并明确说明所做的假设和近似。\n\n使用以下科学上合理且被广泛接受的基础：\n- 在稳定、无粘、大尺度海洋条件下，旋转坐标系下的动量方程承认水平地转平衡，垂直动量承认静水平衡。\n- Boussinesq 近似适用于大尺度海洋流动。\n- 保守和绝对热力学变量遵循 TEOS-10，其导数结构可以在参考条件附近进行线性化。\n\n您必须在以下条件和参数下实现该流程：\n- 设网格为均匀的，有 $N_x=32$、$N_y=32$、$N_z=40$ 个点，间距为 $d_x=d_y=10^4\\,\\mathrm{m}$ 和 $d_z=50\\,\\mathrm{m}$，其中 $x$ 指向东，$y$ 指向北，$z$ 向下为正。\n- 使用参考密度 $\\rho_0=1027\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$，重力加速度 $g=9.80665\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$，地球自转速率 $\\Omega=7.292115\\times 10^{-5}\\,\\mathrm{s}^{-1}$。科里奥利参数为 $f=2\\Omega\\sin(\\phi_\\mathrm{rad})$，其中 $\\phi_\\mathrm{rad}$ 是以$\\mathrm{radians}$为单位的纬度。\n- 压力通过静水近似为 $p(z)=\\rho_0 g z$（单位为$\\mathrm{Pa}$），并假设自由表面平坦（$\\nabla_h p=0$）。\n- 在参考条件 $(S_{\\mathrm{ref}},\\Theta_{\\mathrm{ref}},p_{\\mathrm{ref}})$ 下，使用常数系数对 TEOS-10 状态方程的导数进行线性化：热膨胀系数 $\\alpha=2.0\\times 10^{-4}\\,\\mathrm{K}^{-1}$，盐缩系数 $\\beta=7.6\\times 10^{-4}\\,(\\mathrm{g}\\,\\mathrm{kg}^{-1})^{-1}$，以及一个代表性的绝热压缩率 $\\gamma=4.5\\times 10^{-10}\\,\\mathrm{Pa}^{-1}$。使用 $(S_{\\mathrm{ref}},\\Theta_{\\mathrm{ref}},p_{\\mathrm{ref}})=(35\\,\\mathrm{g}\\,\\mathrm{kg}^{-1},10\\,\\mathrm{^\\circ C},0\\,\\mathrm{Pa})$。\n- 密度计算公式为 $\\rho(x,y,z)=\\rho_0\\left[1-\\alpha\\left(\\Theta(x,y,z)-\\Theta_{\\mathrm{ref}}\\right)+\\beta\\left(S_A(x,y,z)-S_{\\mathrm{ref}}\\right)+\\gamma\\left(p(z)-p_{\\mathrm{ref}}\\right)\\right]$，并且水平密度梯度通过 TEOS-10 的导数（链式法则）计算，而不是通过对 $\\rho$ 进行直接差分：$\\nabla_h \\rho=\\rho_0\\left[\\beta\\,\\nabla_h S_A-\\alpha\\,\\nabla_h \\Theta\\right]$，因为根据假设 $\\nabla_h p=0$。\n- 使用您推导的关系式来评估大尺度平衡所隐含的垂直地转切变。\n\n您的程序内部必须实现二阶精度中心有限差分来计算水平梯度，正确处理向量值切变，并按如下规定从三维数组中汇总一个标量度量。角度在内部必须以$\\mathrm{radians}$为单位处理。\n\n设计一个测试套件，涵盖一般情况、近赤道小$f$情况、零水平梯度情况和强盐锋情况。对于每种情况，使用归一化坐标 $\\xi=x/L_x$、$\\eta=y/L_y$ 和 $\\zeta=z/L_z$（其中 $L_x=N_x d_x$、$L_y=N_y d_y$ 和 $L_z=N_z d_z$），从解析的、网格分辨的模式构建 $S_A(x,y,z)$ 和 $\\Theta(x,y,z)$，确保物理真实性和自洽性：\n\n- 情况 A（中纬度分层，同时存在盐度和温度梯度）：纬度 $\\phi=45\\,\\mathrm{degrees}$，$S_A(x,y,z)=S_{\\mathrm{ref}}+0.008\\,\\xi+0.012\\,\\eta+0.002\\,\\zeta$，$\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.15\\,\\xi+0.05\\,\\eta-1.5\\,\\zeta$。\n- 情况 B（近赤道小$f$）：纬度 $\\phi=1\\,\\mathrm{degree}$，$S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.010\\,\\eta+0.002\\,\\zeta$，$\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.20\\,\\xi+0.000\\,\\eta-0.5\\,\\zeta$。\n- 情况 C（无水平梯度）：纬度 $\\phi=30\\,\\mathrm{degrees}$，$S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.000\\,\\eta+0.002\\,\\zeta$，$\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.000\\,\\xi+0.000\\,\\eta-0.5\\,\\zeta$。\n- 情况 D（强盐锋，混合温度梯度）：纬度 $\\phi=60\\,\\mathrm{degrees}$，$S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.030\\,\\eta+0.001\\,\\zeta$，$\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.050\\,\\xi+0.050\\,\\eta-0.2\\,\\zeta$。\n\n对于每种情况，计算每个网格点上垂直地转切变向量的模，定义为 $\\left\\|\\partial \\mathbf{u}_g / \\partial z\\right\\|=\\sqrt{\\left(\\partial u_g/\\partial z\\right)^2+\\left(\\partial v_g/\\partial z\\right)^2}$，并为每种情况返回一个等于整个三维网格上算术平均值的标量。将返回的标量以$\\mathrm{s}^{-1}$为单位，表示为四舍五入到$6$位小数的十进制浮点数。\n\n您的程序应产生单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$\\left[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3,\\mathrm{result}_4\\right]$）。",
            "solution": "该问题要求设计并实现一个计算流程，用于从三维绝对盐度场 $S_A(x,y,z)$ 和保守温度场 $\\Theta(x,y,z)$ 计算垂直地转切变。该解决方案基于地球物理流体动力学原理，特别是热成风平衡，该平衡源于分层旋转流体中的地转均衡和静水均衡。\n\n### 步骤 1：热成风方程的理论推导\n\n推导始于旋转参考系中稳定、无粘、Boussinesq 水平动量方程，其中地转平衡成立。坐标系定义为 $x$ 指向东（纬向），$y$ 指向北（经向），$z$ 向下为正。地转流分量 $u_g$（纬向）和 $v_g$（经向）与压力 $p$ 的关系如下：\n$$ -f v_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial x} \\quad (1) $$\n$$ f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y} \\quad (2) $$\n这里，$f=2\\Omega\\sin(\\phi)$ 是纬度 $\\phi$ 处的科里奥利参数（$\\Omega$ 是地球自转速率），$\\rho_0$ 是一个恒定的参考密度。\n\n垂直动量平衡由静水近似给出：\n$$ \\frac{\\partial p}{\\partial z} = \\rho g \\quad (3) $$\n其中 $g$ 是重力加速度，$\\rho(x,y,z)$ 是现场海水密度。\n\n热成风关系描述了地转流的垂直切变。它是通过对地转方程 ($1$) 和 ($2$) 取垂直导数（$\\partial/\\partial z$）并将其与静水方程 ($3$) 结合而得出的。假设 $f$ 随深度不变（传统近似，在所考虑的垂直尺度上有效），我们继续推导。\n\n对式 ($2$) 取 $\\partial/\\partial z$：\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial^2 p}{\\partial z \\partial y} $$\n假设压力场足够光滑，我们可以交换微分顺序（Clairaut 定理）：\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y} \\left( \\frac{\\partial p}{\\partial z} \\right) $$\n代入静水平衡（式 $3$）：\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial (\\rho g)}{\\partial y} = -\\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial y} $$\n这得到了热成风切变的纬向分量：\n$$ \\frac{\\partial u_g}{\\partial z} = -\\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial y} \\quad (4) $$\n\n类似地，对式 ($1$) 取 $\\partial/\\partial z$：\n$$ -f \\frac{\\partial v_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial^2 p}{\\partial z \\partial x} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial x} \\left( \\frac{\\partial p}{\\partial z} \\right) $$\n代入静水平衡：\n$$ -f \\frac{\\partial v_g}{\\partial z} = -\\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial x} $$\n这得到了热成风切变的经向分量：\n$$ \\frac{\\partial v_g}{\\partial z} = \\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial x} \\quad (5) $$\n方程 ($4$) 和 ($5$) 是热成风方程。它们将水平地转流的垂直切变与密度场的水平梯度联系起来。\n\n### 步骤 2：结合线性化状态方程\n\n问题指定使用在参考条件 ($S_{\\mathrm{ref}}$, $\\Theta_{\\mathrm{ref}}$, $p_{\\mathrm{ref}}$) 附近线性化的 TEOS-10 状态方程的导数结构。水平密度梯度 $\\nabla_h \\rho = (\\partial\\rho/\\partial x, \\partial\\rho/\\partial y)$ 是通过将链式法则应用于线性化状态方程 $\\rho = \\rho(S_A, \\Theta, p)$ 得到的。\n$$ \\nabla_h \\rho = \\frac{\\partial \\rho}{\\partial S_A} \\nabla_h S_A + \\frac{\\partial \\rho}{\\partial \\Theta} \\nabla_h \\Theta + \\frac{\\partial \\rho}{\\partial p} \\nabla_h p $$\n问题提供了恒定的线性化系数：$\\partial\\rho/\\partial S_A \\approx \\rho_0 \\beta$ 和 $\\partial\\rho/\\partial\\Theta \\approx -\\rho_0 \\alpha$，其中 $\\alpha$ 是热膨胀系数，$\\beta$ 是盐缩系数。它还指定了一个简化的压力模型，其中水平压力梯度本身对密度计算没有贡献，即在状态方程中 $\\nabla_h p \\approx 0$。这是与 Boussinesq 近似一致的常见简化。因此，水平密度梯度为：\n$$ \\nabla_h \\rho = \\rho_0 \\left( \\beta \\nabla_h S_A - \\alpha \\nabla_h \\Theta \\right) $$\n分量形式为：\n$$ \\frac{\\partial \\rho}{\\partial x} = \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\quad (6) $$\n$$ \\frac{\\partial \\rho}{\\partial y} = \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\quad (7) $$\n这种表述遵循了不直接对计算出的 $\\rho(x,y,z)$ 场进行微分的要求。\n\n将方程 ($6$) 和 ($7$) 代入热成风方程 ($4$) 和 ($5$)，消除了中间的密度计算并约掉了参考密度 $\\rho_0$：\n$$ \\frac{\\partial u_g}{\\partial z} = -\\frac{g}{f \\rho_0} \\left[ \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\right] = -\\frac{g}{f} \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\quad (8) $$\n$$ \\frac{\\partial v_g}{\\partial z} = \\frac{g}{f \\rho_0} \\left[ \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\right] = \\frac{g}{f} \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\quad (9) $$\n这些是垂直地转切变分量的最终可计算形式。\n\n### 步骤 3：计算流程设计\n\n该算法为四个指定的测试用例计算平均地转切变模。\n\n1.  **常数和网格设置**：定义所有物理常数（$g, \\rho_0, \\Omega, \\alpha, \\beta, S_{\\mathrm{ref}}, \\Theta_{\\mathrm{ref}}$）和网格参数（$N_x, N_y, N_z, d_x, d_y, d_z$）。所有单位都转换为国际单位制（SI）。\n\n2.  **遍历测试用例**：对于每个用例：\n    a. **科里奥利参数**：计算 $f = 2\\Omega\\sin(\\phi_{\\mathrm{rad}})$，其中用例纬度 $\\phi$ 从度转换为弧度。注意，对于 $\\phi=1^\\circ$，$f$ 很小但非零，使得计算有效。对于 $\\phi=0$，$f=0$ 且热成风平衡失效；此情况未被测试。\n    b. **生成输入场**：构建绝对盐度 $S_A(x,y,z)$ 和保守温度 $\\Theta(x,y,z)$ 的三维场。这首先通过在网格上创建归一化坐标数组 $\\xi, \\eta, \\zeta$ 来完成，其中 $\\xi_i = i/N_x$，$\\eta_j = j/N_y$，$\\zeta_k = k/N_z$。然后，在这些归一化网格上评估为每个用例提供的解析函数。\n    c. **计算水平梯度**：数值计算 $S_A$ 和 $\\Theta$ 的水平梯度（$\\partial S_A/\\partial x, \\partial S_A/\\partial y, \\partial \\Theta/\\partial x, \\partial \\Theta/\\partial y$）。根据问题规范，使用二阶精度中心有限差分方案。`numpy.gradient` 函数为此提供了一个稳健的实现，对内部点使用中心差分，在边界使用一阶单边差分。这被应用于 $x$（轴 $0$）和 $y$（轴 $1$）方向，并使用各自的网格间距 $d_x$ 和 $d_y$。\n    d. **计算切变分量**：使用计算出的梯度和推导出的方程 ($8$) 和 ($9$)，在每个网格点计算切变分量 $\\partial u_g/\\partial z$ 和 $\\partial v_g/\\partial z$ 的三维场。\n    e. **计算切变模**：在每个网格点使用欧几里得范数计算垂直地转切变向量的模：\n    $$ \\left\\|\\frac{\\partial \\mathbf{u}_g}{\\partial z}\\right\\| = \\sqrt{\\left(\\frac{\\partial u_g}{\\partial z}\\right)^2 + \\left(\\frac{\\partial v_g}{\\partial z}\\right)^2} $$\n    f. **汇总并存储结果**：在整个三维网格上计算切变模的算术平均值。将得到的标量值四舍五入到 $6$ 位小数并存储。对于情况 C，其中水平梯度为零，切变被正确计算为 $0$。\n\n3.  **最终输出**：将所有用例存储的平均切变模列表格式化为指定的字符串格式：`[result_A,result_B,result_C,result_D]`。\n\n该流程系统地将热成风平衡的基本物理原理转化为具体的数值算法，严格遵守问题的约束和科学最佳实践。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the mean vertical geostrophic shear magnitude for several test cases\n    based on the thermal wind balance in a stratified, rotating ocean.\n    \"\"\"\n\n    # Physical and reference constants in SI units\n    RHO_0 = 1027.0  # Reference density [kg m^-3]\n    G = 9.80665  # Gravitational acceleration [m s^-2]\n    OMEGA = 7.292115e-5  # Earth's rotation rate [s^-1]\n    \n    # Linearized TEOS-10 coefficients\n    ALPHA = 2.0e-4  # Thermal expansion coefficient [K^-1 or (degC)^-1]\n    BETA = 7.6e-4   # Haline contraction coefficient [(g/kg)^-1]\n\n    # Reference state for linearization\n    S_REF = 35.0    # Reference salinity [g/kg]\n    THETA_REF = 10.0  # Reference temperature [deg C]\n    \n    # Grid parameters\n    NX, NY, NZ = 32, 32, 40\n    DX, DY, DZ = 1e4, 1e4, 50.0  # Grid spacing in [m]\n\n    # Test case definitions: (latitude_deg, s_coeffs, theta_coeffs)\n    # coeffs are (cx, cy, cz) for the analytic functions\n    test_cases = [\n        # Case A: Midlatitude stratified case\n        (45.0, (0.008, 0.012, 0.002), (0.15, 0.05, -1.5)),\n        # Case B: Near-equatorial small-f case\n        (1.0, (0.0, 0.010, 0.002), (0.20, 0.0, -0.5)),\n        # Case C: No horizontal gradients case\n        (30.0, (0.0, 0.0, 0.002), (0.0, 0.0, -0.5)),\n        # Case D: Strong haline front case\n        (60.0, (0.0, 0.030, 0.001), (0.050, 0.050, -0.2)),\n    ]\n\n    results = []\n\n    # Create normalized coordinate vectors for building fields\n    xi_vec = np.arange(NX) / NX\n    eta_vec = np.arange(NY) / NY\n    zeta_vec = np.arange(NZ) / NZ\n\n    # Reshape for broadcasting to a 3D grid\n    xi = xi_vec[:, np.newaxis, np.newaxis]\n    eta = eta_vec[np.newaxis, :, np.newaxis]\n    zeta = zeta_vec[np.newaxis, np.newaxis, :]\n\n    for lat_deg, s_coeffs, theta_coeffs in test_cases:\n        # 1. Calculate Coriolis parameter f\n        lat_rad = np.deg2rad(lat_deg)\n        f_coriolis = 2 * OMEGA * np.sin(lat_rad)\n        \n        # 2. Generate 3D salinity and temperature fields\n        csx, csy, csz = s_coeffs\n        ct_x, cty, ctz = theta_coeffs\n        \n        S_A = S_REF + csx * xi + csy * eta + csz * zeta\n        Theta = THETA_REF + ct_x * xi + cty * eta + ctz * zeta\n\n        # 3. Compute horizontal gradients using 2nd-order centered differences\n        # np.gradient handles boundaries with 1st-order differences.\n        # axis=0 corresponds to x, axis=1 corresponds to y\n        grad_S_A_x = np.gradient(S_A, DX, axis=0)\n        grad_S_A_y = np.gradient(S_A, DY, axis=1)\n        \n        grad_Theta_x = np.gradient(Theta, DX, axis=0)\n        grad_Theta_y = np.gradient(Theta, DY, axis=1)\n\n        # 4. Calculate vertical geostrophic shear components\n        # Thermal wind equations:\n        # du_g/dz = -(g/f) * (beta * dS/dy - alpha * dT/dy)\n        # dv_g/dz =  (g/f) * (beta * dS/dx - alpha * dT/dx)\n        \n        # Check for f=0 (at equator) to avoid division by zero, although not in test cases\n        if f_coriolis == 0:\n            # If horizontal density gradients exist, shear is infinite (balance fails)\n            # If no horizontal gradients, shear is indeterminate but physically zero.\n            # Case C has zero gradients, so the result is 0.\n            if np.all(grad_S_A_x == 0) and np.all(grad_S_A_y == 0) and \\\n               np.all(grad_Theta_x == 0) and np.all(grad_Theta_y == 0):\n                du_g_dz = np.zeros_like(S_A)\n                dv_g_dz = np.zeros_like(S_A)\n            else:\n                # In a real scenario, this would indicate the model is invalid at the equator.\n                # For the purpose of this problem, we can represents this as NaN.\n                du_g_dz = np.full_like(S_A, np.nan)\n                dv_g_dz = np.full_like(S_A, np.nan)\n        else:\n            term_g_over_f = G / f_coriolis\n            \n            # Density gradient terms from TEOS-10 derivative structure\n            d_rho_dx_term = BETA * grad_S_A_x - ALPHA * grad_Theta_x\n            d_rho_dy_term = BETA * grad_S_A_y - ALPHA * grad_Theta_y\n            \n            du_g_dz = -term_g_over_f * d_rho_dy_term\n            dv_g_dz = term_g_over_f * d_rho_dx_term\n\n        # 5. Compute the magnitude of the shear vector at each grid point\n        shear_magnitude = np.sqrt(du_g_dz**2 + dv_g_dz**2)\n\n        # 6. Aggregate result: compute arithmetic mean over the entire 3D grid\n        mean_shear_magnitude = np.mean(shear_magnitude)\n\n        # Round to 6 decimal places as required\n        results.append(round(mean_shear_magnitude, 6))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "热成风关系本身存在一个关键的局限性：它只能确定地转流的垂直切变，即“斜压”部分，而无法给出深度无关的“正压”参考速度，因此无法得到绝对速度。本节的最后一个练习旨在解决这个经典的“参考层速度”问题 。通过结合一个独立的速度观测剖面（例如声学多普勒流速剖面仪ADCP的数据），我们将学习如何运用最小二乘法来估计未知的正压参考速度，从而将理论计算与实际观测数据融合，最终确定出完整的绝对地转流剖面。",
            "id": "3816929",
            "problem": "给定一个一维垂直剖面背景，其中地转流分量 $u_g(z)$ 已知，但相差一个未知的、不随深度变化的参考速度。其基本原理是在$f$平面上的地转水平动量方程和静力平衡，这两者共同蕴含了地转流的垂直切变受到水平密度梯度的约束，这种关系通过热成风关系表达。具体来说，假设垂直切变剖面 $\\partial u_g/\\partial z$ 已通过水文资料计算得出，同时还有一个独立的、来自声学多普勒流速剖面仪（ADCP）的观测水平速度剖面 $u_{\\text{ADCP}}(z)$ 可用。目标是通过估算未知的正压参考速度来协调这些数据集，使得积分后与热成风关系一致的剖面以最小二乘的方式最佳拟合ADCP剖面。\n\n假设以下从第一性原理推导出的建模框架。地转流剖面 $u_g(z)$ 可以表示为一个垂直均匀的正压参考速度 $c$ 与一个通过垂直积分切变得到的斜压贡献之和：\n$$\nu_g(z) = c + u_{\\text{rel}}(z),\n$$\n其中\n$$\nu_{\\text{rel}}(z) = \\int_{z_0}^{z} \\frac{\\partial u_g}{\\partial z'}(z')\\,\\mathrm{d}z',\n$$\n$z_0$ 是积分起始的最浅深度层。ADCP 在一组离散的深度上提供 $u_{\\text{ADCP}}(z)$，并可选地提供非负置信权重 $w(z)$。缺失的 ADCP 值表示为非数值（not-a-number），不应对拟合产生贡献。\n\n您的任务是设计并实现一个针对标量 $c$ 的最小二乘估计器，该估计器在可用深度上最小化建模的地转剖面 $c + u_{\\text{rel}}(z)$ 与观测的 ADCP 剖面 $u_{\\text{ADCP}}(z)$ 之间的加权平方失配。垂直积分应在给定的离散深度网格上使用梯形法则进行数值计算，并遵循惯例 $u_{\\text{rel}}(z_0) = 0$。将等于零的权重视为将相应数据从拟合中排除。所有深度单位为米（向下为正），速度单位为米/秒，切变单位为每秒。\n\n实现一个程序，针对下方的每个测试用例，计算并返回 $c$ 的最小二乘估计值（单位为米/秒），四舍五入到六位小数。不涉及角度。您的程序必须将所有测试用例的结果输出为单行，格式为包含在方括号中的逗号分隔列表。\n\n测试套件（每个案例提供深度 $z$、切变 $\\partial u_g/\\partial z$、ADCP 速度 $u_{\\text{ADCP}}$ 以及可选权重 $w$ 的数组；如果省略权重，则使用统一权重 1）：\n\n- 案例 1（理想情况，恒定切变，完整数据）：\n  - $z = [0, 50, 100, 150, 200]$ 米\n  - $\\partial u_g/\\partial z = [0.001, 0.001, 0.001, 0.001, 0.001]$ 每秒\n  - $u_{\\text{ADCP}} = [0.152, 0.199, 0.25, 0.3015, 0.3475]$ 米/秒\n  - 省略 $w$\n\n- 案例 2（边界情况，零切变，完整数据）：\n  - $z = [0, 100, 200, 300]$ 米\n  - $\\partial u_g/\\partial z = [0.0, 0.0, 0.0, 0.0]$ 每秒\n  - $u_{\\text{ADCP}} = [-0.049, -0.052, -0.0495, -0.0485]$ 米/秒\n  - 省略 $w$\n\n- 案例 3（不规则间距，变化切变，完整数据）：\n  - $z = [0, 30, 80, 140, 230, 350]$ 米\n  - $\\partial u_g/\\partial z = [0.0005, 0.0008, 0.0012, 0.0011, 0.0009, 0.0006]$ 每秒\n  - $u_{\\text{ADCP}} = [0.019, 0.04, 0.0875, 0.1595, 0.2485, 0.337]$ 米/秒\n  - 省略 $w$\n\n- 案例 4（具有缺失值和非均匀权重的稀疏ADCP数据）：\n  - $z = [10, 60, 120, 180, 260]$ 米\n  - $\\partial u_g/\\partial z = [0.0007, 0.0007, 0.0004, 0.0, -0.0002]$ 每秒\n  - $u_{\\text{ADCP}} = [0.101, \\mathrm{NaN}, 0.166, \\mathrm{NaN}, 0.172]$ 米/秒\n  - $w = [1.0, 0.0, 0.5, 0.0, 2.0]$\n\n最终输出格式要求：\n- 您的程序应生成单行输出，其中包含结果，格式为包含在方括号中的逗号分隔列表，每个元素是估计的正压参考速度 $c$（单位为米/秒），四舍五入到六位小数（例如，\"[0.123456,-0.010000,0.000000,0.050000]\"）。",
            "solution": "### 解法推导与算法设计\n\n问题的核心是找到正压参考速度 $c$，以最小化建模的地转速度 $u_g(z)$ 与观测的 ADCP 速度 $u_{\\text{ADCP}}(z)$ 之间的加权平方差之和。数据在一组离散深度 $\\{z_i\\}$ 上提供。\n\n需要最小化的代价函数（cost function）是：\n$$\nJ(c) = \\sum_{i} w_i \\left[ u_g(z_i) - u_{\\text{ADCP}}(z_i) \\right]^2\n$$\n其中，总和是针对所有离散深度层级 $i$，$w_i = w(z_i)$ 是相应的权重。根据题目要求，只有当 $u_{\\text{ADCP}}(z_i)$ 是一个有效数字且 $w_i  0$ 时，该数据点才对求和有贡献。\n\n地转速度的模型由 $u_g(z_i) = c + u_{\\text{rel}}(z_i)$ 给出。将其代入代价函数，得到：\n$$\nJ(c) = \\sum_{i} w_i \\left[ (c + u_{\\text{rel}}(z_i)) - u_{\\text{ADCP}}(z_i) \\right]^2\n$$\n\n为了找到最小化 $J(c)$ 的 $c$ 值，我们对 $J(c)$ 关于 $c$ 求导，并令其等于零。\n$$\n\\frac{dJ}{dc} = \\frac{d}{dc} \\sum_{i} w_i \\left[ c + (u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i)) \\right]^2 = 0\n$$\n应用链式法则进行微分：\n$$\n\\sum_{i} w_i \\cdot 2 \\left[ c + u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i) \\right]^1 \\cdot \\frac{d}{dc}(c) = 0\n$$\n$$\n2 \\sum_{i} w_i \\left[ c + u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i) \\right] = 0\n$$\n我们可以将求和内的项分开：\n$$\n\\sum_i w_i c + \\sum_i w_i u_{\\text{rel}}(z_i) - \\sum_i w_i u_{\\text{ADCP}}(z_i) = 0\n$$\n由于 $c$ 是常数，可以从第一个求和中提出：\n$$\nc \\left( \\sum_i w_i \\right) = \\sum_i w_i u_{\\text{ADCP}}(z_i) - \\sum_i w_i u_{\\text{rel}}(z_i)\n$$\n解出 $c$，我们得到最小二乘估计的解析解：\n$$\nc = \\frac{\\sum_i w_i \\left( u_{\\text{ADCP}}(z_i) - u_{\\text{rel}}(z_i) \\right)}{\\sum_i w_i}\n$$\n该表达式揭示了 $c$ 是观测速度与相对地转速度之差的加权平均值。\n\n为每个测试用例计算 $c$ 的算法分三步进行：\n\n1.  **计算相对速度剖面 $u_{\\text{rel}}(z_i)$**：通过对给定的切变剖面 $\\partial u_g/\\partial z$ 从最浅深度 $z_0$ 向下进行数值积分，得到斜压分量 $u_{\\text{rel}}(z)$。问题指定使用梯形法则。对于一组离散点 $(z_i, S_i)$，其中 $S_i = (\\partial u_g/\\partial z)(z_i)$，计算累积积分。在初始条件 $u_{\\text{rel}}(z_0) = 0$下，迭代地构建剖面：\n    $$\n    u_{\\text{rel}}(z_i) = u_{\\text{rel}}(z_{i-1}) + (z_i - z_{i-1}) \\frac{S_{i-1} + S_i}{2} \\quad \\text{对于 } i \\ge 1\n    $$\n    这可以使用累积梯形积分函数（如 `scipy.integrate.cumulative_trapezoid`）高效实现。\n\n2.  **筛选数据**：在计算 $c$ 之前，必须筛选数据集，仅包含有效点。当且仅当满足两个条件时，深度 $z_i$ 处的数据点被认为是有效的：对应的 ADCP 速度 $u_{\\text{ADCP}}(z_i)$ 不是“非数值”（NaN），且其权重 $w_i$ 严格为正。所有数组（$u_{\\text{ADCP}}$、$u_{\\text{rel}}$ 和 $w$）都经过筛选，只保留与这些有效点对应的元素。\n\n3.  **计算估计量 $c$**：使用筛选后的数组，通过实现推导出的解析公式来计算 $c$ 的值。分子是筛选后的权重与筛选后的速度差（$u_{\\text{ADCP}} - u_{\\text{rel}}$）的乘积之和。分母是筛选后的权重之和。最终结果按要求四舍五入到六位小数。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Solves for the barotropic reference velocity c for a suite of test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (z, shear, u_adcp, optional_w).\n    # np.nan is used for missing ADCP values.\n    test_cases = [\n        (\n            [0, 50, 100, 150, 200],  # z\n            [0.001, 0.001, 0.001, 0.001, 0.001],  # shear\n            [0.152, 0.199, 0.25, 0.3015, 0.3475]  # u_adcp\n        ),\n        (\n            [0, 100, 200, 300],\n            [0.0, 0.0, 0.0, 0.0],\n            [-0.049, -0.052, -0.0495, -0.0485]\n        ),\n        (\n            [0, 30, 80, 140, 230, 350],\n            [0.0005, 0.0008, 0.0012, 0.0011, 0.0009, 0.0006],\n            [0.019, 0.04, 0.0875, 0.1595, 0.2485, 0.337]\n        ),\n        (\n            [10, 60, 120, 180, 260],\n            [0.0007, 0.0007, 0.0004, 0.0, -0.0002],\n            [0.101, np.nan, 0.166, np.nan, 0.172],\n            [1.0, 0.0, 0.5, 0.0, 2.0]  # weights\n        )\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack the case data\n        if len(case) == 4:\n            z, shear, u_adcp, w = case\n        else:\n            z, shear, u_adcp = case\n            w = None # No weights provided\n\n        # Ensure inputs are numpy arrays for vector operations\n        z = np.array(z, dtype=float)\n        shear = np.array(shear, dtype=float)\n        u_adcp = np.array(u_adcp, dtype=float)\n        \n        # If weights are not provided, assign a uniform weight of 1.0\n        if w is None:\n            w = np.ones_like(z)\n        else:\n            w = np.array(w, dtype=float)\n\n        # Step 1: Compute the relative geostrophic velocity profile u_rel(z)\n        # The integral is computed from the shallowest depth z[0] where u_rel is zero.\n        # `cumulative_trapezoid` computes this cumulative integral.\n        u_rel = cumulative_trapezoid(y=shear, x=z, initial=0.0)\n\n        # Step 2: Identify valid data points for the least-squares fit.\n        # A point is valid if its ADCP value is not NaN and its weight is positive.\n        valid_mask = ~np.isnan(u_adcp)  (w > 0)\n\n        # Step 3: Filter data using the mask to get only valid points.\n        w_filt = w[valid_mask]\n        u_adcp_filt = u_adcp[valid_mask]\n        u_rel_filt = u_rel[valid_mask]\n        \n        # Calculate the barotropic reference velocity c\n        # The formula is c = sum(w_i * (u_adcp_i - u_rel_i)) / sum(w_i)\n        # This is the weighted average of the velocity difference.\n        \n        # Check if there are any valid data points to avoid division by zero.\n        if w_filt.size > 0:\n            numerator = np.sum(w_filt * (u_adcp_filt - u_rel_filt))\n            denominator = np.sum(w_filt)\n            c = numerator / denominator\n        else:\n            # If no valid data, c is undefined. This case is not expected\n            # based on the problem description, but as a safeguard, we set to 0.0.\n            c = 0.0\n\n        # Append the formatted result to the list\n        results.append(f\"{c:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}