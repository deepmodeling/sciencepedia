{
    "hands_on_practices": [
        {
            "introduction": "Understanding a physical principle begins with its derivation and an appreciation for its scale. This exercise guides you through deriving the thermal wind relation from the fundamental geostrophic and hydrostatic balances that govern large-scale ocean circulation . By applying the resulting equation with typical mid-latitude ocean parameters, you will gain a concrete intuition for the magnitude of vertical shear and the significant velocity differences it can produce over the vertical.",
            "id": "3816946",
            "problem": "Assume a stably stratified, Boussinesq ocean on an $f$-plane in large-scale, steady, inviscid flow that satisfies horizontal geostrophic balance and vertical hydrostatic balance. Starting only from these fundamental balances and the definition of the Brunt–Väisälä frequency, derive the relation that connects the vertical derivative of the along-$x$ component of the geostrophic velocity to the meridional density gradient. Then use it to estimate the magnitude of the vertical geostrophic shear and the implied magnitude of the along-$x$ geostrophic velocity difference over a vertical separation of $500\\ \\text{m}$, given the following parameters:\n- Coriolis parameter $f = 10^{-4}\\ \\text{s}^{-1}$,\n- Gravitational acceleration $g = 9.81\\ \\text{m s}^{-2}$,\n- Brunt–Väisälä frequency $N = 10^{-3}\\ \\text{s}^{-1}$,\n- Meridional density gradient $\\partial \\rho/\\partial y = 10^{-4}\\ \\text{kg m}^{-4}$,\n- Reference density $\\rho_0 = 1025\\ \\text{kg m}^{-3}$.\n\nTreat $f$, $g$, and $\\rho_0$ as constants with respect to depth. Clearly state any sign conventions and compute the magnitudes.\n\nExpress your final answer as the magnitude of the geostrophic velocity difference over $500\\ \\text{m}$ in meters per second, rounded to three significant figures. Do not include units in your final boxed answer.",
            "solution": "The problem requires the derivation of the thermal wind relation and its application to estimate a geostrophic velocity difference. We begin by establishing the physical framework and coordinate system. We adopt a standard Cartesian coordinate system where $x$ is directed zonally (eastward), $y$ is directed meridionally (northward), and $z$ is directed vertically upward. The Coriolis parameter, $f$, is given as a positive constant, $f = 10^{-4}\\ \\text{s}^{-1}$, which is appropriate for the Northern Hemisphere.\n\nThe flow is assumed to be in large-scale, steady, inviscid, geostrophic and hydrostatic balance within a Boussinesq fluid. The governing equations for this state are:\n\n1.  **Horizontal Geostrophic Balance**: The pressure gradient force is balanced by the Coriolis force. For the zonal component of velocity, $u_g$, this is expressed as:\n    $$f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}$$\n    where $p$ is the pressure and $\\rho_0$ is the constant reference density.\n\n2.  **Vertical Hydrostatic Balance**: The vertical pressure gradient is balanced by gravity:\n    $$\\frac{\\partial p}{\\partial z} = -\\rho g$$\n    where $\\rho$ is the full density and $g$ is the acceleration due to gravity.\n\nThe primary task is to derive the thermal wind relation, which connects the vertical shear of the geostrophic velocity ($\\partial u_g/\\partial z$) to the horizontal density gradient ($\\partial \\rho/\\partial y$). We start with the zonal geostrophic balance equation:\n$$f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y}$$\nWe then take the partial derivative of this equation with respect to the vertical coordinate $z$. Treating $f$ and $\\rho_0$ as constants as specified, we get:\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial z}\\left(\\frac{\\partial p}{\\partial y}\\right)$$\nAssuming that the pressure field $p(y, z)$ is twice continuously differentiable, we can interchange the order of partial differentiation (by Clairaut's theorem on equality of mixed partials):\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial p}{\\partial z}\\right)$$\nNext, we substitute the hydrostatic balance relation, $\\frac{\\partial p}{\\partial z} = -\\rho g$, into the right-hand side of the equation:\n$$f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y}(-\\rho g)$$\nAs gravitational acceleration $g$ is assumed to be constant, we can move it outside the derivative:\n$$f \\frac{\\partial u_g}{\\partial z} = \\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial y}$$\nFinally, we solve for the vertical geostrophic shear, $\\frac{\\partial u_g}{\\partial z}$:\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial y}$$\nThis is the thermal wind relation for the zonal component of geostrophic velocity. It stems directly from geostrophic and hydrostatic balances. Although the problem statement mentions starting from the definition of the Brunt–Väisälä frequency, $N$, this quantity does not appear in the standard derivation of this relation. The value of $N$ provided is a measure of the stratification, which is a necessary condition for the physical regime, but it is not required for the specific calculation requested.\n\nWe can now calculate the magnitude of the vertical geostrophic shear using the provided parameters:\n- $g = 9.81\\ \\text{m s}^{-2}$\n- $f = 10^{-4}\\ \\text{s}^{-1}$\n- $\\rho_0 = 1025\\ \\text{kg m}^{-3}$\n- $\\frac{\\partial \\rho}{\\partial y} = 10^{-4}\\ \\text{kg m}^{-4}$\n\nSubstituting these values into the thermal wind relation:\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{(9.81\\ \\text{m s}^{-2})}{(10^{-4}\\ \\text{s}^{-1}) (1025\\ \\text{kg m}^{-3})} (10^{-4}\\ \\text{kg m}^{-4})$$\n$$\\frac{\\partial u_g}{\\partial z} = \\frac{9.81 \\cdot 10^{-4}}{1025 \\cdot 10^{-4}}\\ \\text{s}^{-1} = \\frac{9.81}{1025}\\ \\text{s}^{-1} \\approx 0.0095707\\ \\text{s}^{-1}$$\nThe magnitude of the vertical geostrophic shear is approximately $9.57 \\times 10^{-3}\\ \\text{s}^{-1}$.\n\nThe final step is to estimate the magnitude of the along-$x$ geostrophic velocity difference, $\\Delta u_g$, over a vertical separation of $\\Delta z = 500\\ \\text{m}$. Assuming the shear $\\frac{\\partial u_g}{\\partial z}$ is constant over this depth, we can approximate the velocity difference as:\n$$\\Delta u_g \\approx \\frac{\\partial u_g}{\\partial z} \\Delta z$$\nSince we are interested in the magnitude, and all quantities are positive:\n$$|\\Delta u_g| \\approx \\left| \\frac{9.81}{1025}\\ \\text{s}^{-1} \\right| \\times 500\\ \\text{m}$$\n$$|\\Delta u_g| \\approx (0.0095707\\ \\text{s}^{-1}) \\times 500\\ \\text{m} \\approx 4.785365\\ \\text{m s}^{-1}$$\nRounding the result to three significant figures as requested, we obtain the magnitude of the velocity difference.\n$$|\\Delta u_g| \\approx 4.79\\ \\text{m s}^{-1}$$",
            "answer": "$$\\boxed{4.79}$$"
        },
        {
            "introduction": "While the thermal wind relation provides the theoretical link between density and velocity shear, its practical application requires robust computational methods. This practice challenges you to build a computational pipeline to calculate geostrophic shear from gridded temperature and salinity fields, a common task when working with observational data or model output . You will learn the importance of numerical consistency by applying the derivative structure of the TEOS-10 equation of state, a best practice that avoids errors from differentiating noisy density fields.",
            "id": "3816979",
            "problem": "You are given horizontally varying three-dimensional fields of Absolute Salinity $S_A(x,y,z)$ in $\\mathrm{g}\\,\\mathrm{kg}^{-1}$ and Conservative Temperature $\\Theta(x,y,z)$ in $\\mathrm{^\\circ C}$ on a uniform rectilinear grid at a constant latitude $\\phi$ in $\\mathrm{degrees}$. Starting from a valid physical base, design and implement a computational pipeline that computes a physically consistent seawater density field $\\rho(x,y,z)$ and then evaluates the vertical geostrophic shear implied by the balance between rotation, stratification, and hydrostatic pressure. Your pipeline must explicitly and consistently use the derivative structure of the Thermodynamic Equation Of Seawater (TEOS-10) rather than numerically differentiating a possibly noisy $\\rho(x,y,z)$ field. The derivation must begin from the rotating-frame momentum equations and the hydrostatic approximation and proceed logically to the thermal wind relation between vertical shear and horizontal density gradients. Your algorithm must express all quantities in the International System of Units (SI) and clearly state assumptions and approximations.\n\nUse the following scientifically sound and widely accepted base:\n- The rotating-frame momentum equations under steady, inviscid, large-scale conditions in the ocean admit horizontal geostrophic balance, and vertical momentum admits hydrostatic balance.\n- The Boussinesq approximation is appropriate for large-scale oceanic flows.\n- The conservative and absolute thermodynamic variables follow TEOS-10, whose derivative structure may be linearized around reference conditions.\n\nYou must implement the pipeline under these conditions and parameters:\n- Let the grid be uniform with $N_x=32$, $N_y=32$, $N_z=40$ points, spacings $d_x=d_y=10^4\\,\\mathrm{m}$ and $d_z=50\\,\\mathrm{m}$, with $x$ pointing east, $y$ pointing north, and $z$ positive downward.\n- Use the reference density $\\rho_0=1027\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$, gravitational acceleration $g=9.80665\\,\\mathrm{m}\\,\\mathrm{s}^{-2}$, and Earth's rotation rate $\\Omega=7.292115\\times 10^{-5}\\,\\mathrm{s}^{-1}$. The Coriolis parameter is $f=2\\Omega\\sin(\\phi_\\mathrm{rad})$ where $\\phi_\\mathrm{rad}$ is the latitude in $\\mathrm{radians}$.\n- Pressure is approximated hydrostatically as $p(z)=\\rho_0 g z$ in $\\mathrm{Pa}$ with a flat free surface ($\\nabla_h p=0$).\n- Linearize the TEOS-10 equation of state derivatives at reference conditions $(S_{\\mathrm{ref}},\\Theta_{\\mathrm{ref}},p_{\\mathrm{ref}})$ using constant coefficients: thermal expansion coefficient $\\alpha=2.0\\times 10^{-4}\\,\\mathrm{K}^{-1}$, haline contraction coefficient $\\beta=7.6\\times 10^{-4}\\,(\\mathrm{g}\\,\\mathrm{kg}^{-1})^{-1}$, and a representative adiabatic compressibility $\\gamma=4.5\\times 10^{-10}\\,\\mathrm{Pa}^{-1}$. Use $(S_{\\mathrm{ref}},\\Theta_{\\mathrm{ref}},p_{\\mathrm{ref}})=(35\\,\\mathrm{g}\\,\\mathrm{kg}^{-1},10\\,\\mathrm{^\\circ C},0\\,\\mathrm{Pa})$.\n- Compute density as $\\rho(x,y,z)=\\rho_0\\left[1-\\alpha\\left(\\Theta(x,y,z)-\\Theta_{\\mathrm{ref}}\\right)+\\beta\\left(S_A(x,y,z)-S_{\\mathrm{ref}}\\right)+\\gamma\\left(p(z)-p_{\\mathrm{ref}}\\right)\\right]$, and compute horizontal density gradients via TEOS-10 derivatives (chain rule) rather than by direct differencing of $\\rho$: $\\nabla_h \\rho=\\rho_0\\left[\\beta\\,\\nabla_h S_A-\\alpha\\,\\nabla_h \\Theta\\right]$ since $\\nabla_h p=0$ by assumption.\n- Evaluate the vertical geostrophic shear implied by large-scale balance using your derived relation.\n\nYour program must implement second-order accurate centered finite differences for horizontal gradients internally, handle the vector-valued shear correctly, and aggregate a scalar measure from three-dimensional arrays as specified below. Angles must be treated in $\\mathrm{radians}$ internally.\n\nDesign a test suite that spans a general case, a near-equatorial small-$f$ case, a zero-horizontal-gradient case, and a strong haline front case. For each case, construct $S_A(x,y,z)$ and $\\Theta(x,y,z)$ from analytic, grid-resolved patterns using normalized coordinates $\\xi=x/L_x$, $\\eta=y/L_y$, and $\\zeta=z/L_z$ with $L_x=N_x d_x$, $L_y=N_y d_y$, and $L_z=N_z d_z$, ensuring physical realism and self-consistency:\n\n- Case A (midlatitude stratified with both salinity and temperature gradients): latitude $\\phi=45\\,\\mathrm{degrees}$, $S_A(x,y,z)=S_{\\mathrm{ref}}+0.008\\,\\xi+0.012\\,\\eta+0.002\\,\\zeta$, $\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.15\\,\\xi+0.05\\,\\eta-1.5\\,\\zeta$.\n- Case B (near-equatorial small-$f$): latitude $\\phi=1\\,\\mathrm{degree}$, $S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.010\\,\\eta+0.002\\,\\zeta$, $\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.20\\,\\xi+0.000\\,\\eta-0.5\\,\\zeta$.\n- Case C (no horizontal gradients): latitude $\\phi=30\\,\\mathrm{degrees}$, $S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.000\\,\\eta+0.002\\,\\zeta$, $\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.000\\,\\xi+0.000\\,\\eta-0.5\\,\\zeta$.\n- Case D (strong haline front with mixed temperature gradients): latitude $\\phi=60\\,\\mathrm{degrees}$, $S_A(x,y,z)=S_{\\mathrm{ref}}+0.000\\,\\xi+0.030\\,\\eta+0.001\\,\\zeta$, $\\Theta(x,y,z)=\\Theta_{\\mathrm{ref}}+0.050\\,\\xi+0.050\\,\\eta-0.2\\,\\zeta$.\n\nFor each case, compute the magnitude of the vertical geostrophic shear vector at every grid point, defined as $\\left\\|\\partial \\mathbf{u}_g / \\partial z\\right\\|=\\sqrt{\\left(\\partial u_g/\\partial z\\right)^2+\\left(\\partial v_g/\\partial z\\right)^2}$, and return a single scalar per case equal to the arithmetic mean over the entire three-dimensional grid. Express the returned scalars in $\\mathrm{s}^{-1}$ as decimal floating-point numbers rounded to $6$ decimal places.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $\\left[\\mathrm{result}_1,\\mathrm{result}_2,\\mathrm{result}_3,\\mathrm{result}_4\\right]$).",
            "solution": "The problem requires the design and implementation of a computational pipeline to calculate the vertical geostrophic shear from three-dimensional fields of Absolute Salinity, $S_A(x,y,z)$, and Conservative Temperature, $\\Theta(x,y,z)$. The solution is founded on the principles of geophysical fluid dynamics, specifically the thermal wind balance, which arises from geostrophic and hydrostatic equilibrium in a stratified, rotating fluid.\n\n### Step 1: Theoretical Derivation of the Thermal Wind Equations\n\nThe derivation begins with the steady, inviscid, Boussinesq horizontal momentum equations in a rotating reference frame where geostrophic balance holds. The coordinate system is defined with $x$ pointing east (zonal), $y$ pointing north (meridional), and $z$ positive downward. The geostrophic velocity components, $u_g$ (zonal) and $v_g$ (meridional), are related to the pressure, $p$, by:\n$$ -f v_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial x} \\quad (1) $$\n$$ f u_g = -\\frac{1}{\\rho_0} \\frac{\\partial p}{\\partial y} \\quad (2) $$\nHere, $f=2\\Omega\\sin(\\phi)$ is the Coriolis parameter at latitude $\\phi$ ($\\Omega$ is Earth's rotation rate), and $\\rho_0$ is a constant reference density.\n\nThe vertical momentum balance is given by the hydrostatic approximation:\n$$ \\frac{\\partial p}{\\partial z} = \\rho g \\quad (3) $$\nwhere $g$ is the acceleration due to gravity and $\\rho(x,y,z)$ is the in-situ seawater density.\n\nThe thermal wind relation describes the vertical shear of the geostrophic flow. It is derived by taking the vertical derivative ($\\partial/\\partial z$) of the geostrophic equations ($1$) and ($2$) and combining them with the hydrostatic equation ($3$). Assuming $f$ is constant with depth (the traditional approximation, valid on the vertical scales considered), we proceed.\n\nTaking $\\partial/\\partial z$ of equation ($2$):\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial^2 p}{\\partial z \\partial y} $$\nAssuming the pressure field is sufficiently smooth, we can switch the order of differentiation (Clairaut's theorem):\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial y} \\left( \\frac{\\partial p}{\\partial z} \\right) $$\nSubstituting the hydrostatic balance (equation $3$):\n$$ f \\frac{\\partial u_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial (\\rho g)}{\\partial y} = -\\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial y} $$\nThis yields the zonal component of the thermal wind shear:\n$$ \\frac{\\partial u_g}{\\partial z} = -\\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial y} \\quad (4) $$\n\nSimilarly, taking $\\partial/\\partial z$ of equation ($1$):\n$$ -f \\frac{\\partial v_g}{\\partial z} = -\\frac{1}{\\rho_0} \\frac{\\partial^2 p}{\\partial z \\partial x} = -\\frac{1}{\\rho_0} \\frac{\\partial}{\\partial x} \\left( \\frac{\\partial p}{\\partial z} \\right) $$\nSubstituting the hydrostatic balance:\n$$ -f \\frac{\\partial v_g}{\\partial z} = -\\frac{g}{\\rho_0} \\frac{\\partial \\rho}{\\partial x} $$\nThis yields the meridional component of the thermal wind shear:\n$$ \\frac{\\partial v_g}{\\partial z} = \\frac{g}{f \\rho_0} \\frac{\\partial \\rho}{\\partial x} \\quad (5) $$\nEquations ($4$) and ($5$) are the thermal wind equations. They link the vertical shear of the horizontal geostrophic flow to the horizontal gradients of the density field.\n\n### Step 2: Incorporating the Linearized Equation of State\n\nThe problem specifies using the derivative structure of the TEOS-10 equation of state, linearized around reference conditions ($S_{\\mathrm{ref}}$, $\\Theta_{\\mathrm{ref}}$, $p_{\\mathrm{ref}}$). The horizontal density gradient, $\\nabla_h \\rho = (\\partial\\rho/\\partial x, \\partial\\rho/\\partial y)$, is given by applying the chain rule to the linearized equation of state, $\\rho = \\rho(S_A, \\Theta, p)$.\n$$ \\nabla_h \\rho = \\frac{\\partial \\rho}{\\partial S_A} \\nabla_h S_A + \\frac{\\partial \\rho}{\\partial \\Theta} \\nabla_h \\Theta + \\frac{\\partial \\rho}{\\partial p} \\nabla_h p $$\nThe problem provides the constant, linearized coefficients: $\\partial\\rho/\\partial S_A \\approx \\rho_0 \\beta$ and $\\partial\\rho/\\partial\\Theta \\approx -\\rho_0 \\alpha$, where $\\alpha$ is the thermal expansion coefficient and $\\beta$ is the haline contraction coefficient. It also specifies a simplified pressure model where horizontal pressure gradients do not contribute to the density calculation itself, i.e., $\\nabla_h p \\approx 0$ in the equation of state. This is a common simplification consistent with the Boussinesq approximation. Thus, the horizontal density gradient is:\n$$ \\nabla_h \\rho = \\rho_0 \\left( \\beta \\nabla_h S_A - \\alpha \\nabla_h \\Theta \\right) $$\nIn component form:\n$$ \\frac{\\partial \\rho}{\\partial x} = \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\quad (6) $$\n$$ \\frac{\\partial \\rho}{\\partial y} = \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\quad (7) $$\nThis formulation adheres to the requirement not to differentiate a computed $\\rho(x,y,z)$ field directly.\n\nSubstituting equations ($6$) and ($7$) into the thermal wind equations ($4$) and ($5$) eliminates the intermediate density calculation and cancels the reference density $\\rho_0$:\n$$ \\frac{\\partial u_g}{\\partial z} = -\\frac{g}{f \\rho_0} \\left[ \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\right] = -\\frac{g}{f} \\left( \\beta \\frac{\\partial S_A}{\\partial y} - \\alpha \\frac{\\partial \\Theta}{\\partial y} \\right) \\quad (8) $$\n$$ \\frac{\\partial v_g}{\\partial z} = \\frac{g}{f \\rho_0} \\left[ \\rho_0 \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\right] = \\frac{g}{f} \\left( \\beta \\frac{\\partial S_A}{\\partial x} - \\alpha \\frac{\\partial \\Theta}{\\partial x} \\right) \\quad (9) $$\nThese are the final, computable forms of the vertical geostrophic shear components.\n\n### Step 3: Computational Pipeline Design\n\nThe algorithm computes the mean geostrophic shear magnitude for each of the four specified test cases.\n\n1.  **Constants and Grid Setup**: Define all physical constants ($g, \\rho_0, \\Omega, \\alpha, \\beta, S_{\\mathrm{ref}}, \\Theta_{\\mathrm{ref}}$) and grid parameters ($N_x, N_y, N_z, d_x, d_y, d_z$). All units are converted to SI.\n\n2.  **Iterate Through Test Cases**: For each case:\n    a. **Coriolis Parameter**: Calculate $f = 2\\Omega\\sin(\\phi_{\\mathrm{rad}})$, where the case latitude $\\phi$ is converted from degrees to radians. Note that for $\\phi=1^\\circ$, $f$ is small but non-zero, making the calculation valid. For $\\phi=0$, $f=0$ and the thermal wind balance breaks down; this case is not tested.\n    b. **Generate Input Fields**: Construct the $3$D fields for Absolute Salinity $S_A(x,y,z)$ and Conservative Temperature $\\Theta(x,y,z)$. This is done by first creating normalized coordinate arrays $\\xi, \\eta, \\zeta$ over the grid, where $\\xi_i = i/N_x$, $\\eta_j = j/N_y$, and $\\zeta_k = k/N_z$. The analytic functions provided for each case are then evaluated on these normalized grids.\n    c. **Compute Horizontal Gradients**: The horizontal gradients of $S_A$ and $\\Theta$ ($\\partial S_A/\\partial x, \\partial S_A/\\partial y, \\partial \\Theta/\\partial x, \\partial \\Theta/\\partial y$) are computed numerically. Following the problem specification, a second-order accurate centered finite difference scheme is used. The `numpy.gradient` function provides a robust implementation of this, using centered differences for interior points and first-order one-sided differences at the boundaries. This is applied along the $x$ (axis $0$) and $y$ (axis $1$) directions with the respective grid spacings $d_x$ and $d_y$.\n    d. **Calculate Shear Components**: Using the computed gradients and the derived equations ($8$) and ($9$), the $3$D fields for the shear components $\\partial u_g/\\partial z$ and $\\partial v_g/\\partial z$ are calculated at every grid point.\n    e. **Calculate Shear Magnitude**: The magnitude of the vertical geostrophic shear vector is computed at each grid point using the Euclidean norm:\n    $$ \\left\\|\\frac{\\partial \\mathbf{u}_g}{\\partial z}\\right\\| = \\sqrt{\\left(\\frac{\\partial u_g}{\\partial z}\\right)^2 + \\left(\\frac{\\partial v_g}{\\partial z}\\right)^2} $$\n    f. **Aggregate and Store Result**: The arithmetic mean of the shear magnitude is computed over the entire $3$D grid. The resulting scalar value is rounded to $6$ decimal places and stored. For Case C, where horizontal gradients are zero, the shear is correctly computed as $0$.\n\n3.  **Final Output**: The list of stored mean shear magnitudes for all cases is formatted into the specified string format: `[result_A,result_B,result_C,result_D]`.\n\nThis pipeline systematically translates the fundamental physics of thermal wind balance into a concrete numerical algorithm, adhering strictly to the problem's constraints and scientific best practices.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the mean vertical geostrophic shear magnitude for several test cases\n    based on the thermal wind balance in a stratified, rotating ocean.\n    \"\"\"\n\n    # Physical and reference constants in SI units\n    RHO_0 = 1027.0  # Reference density [kg m^-3]\n    G = 9.80665  # Gravitational acceleration [m s^-2]\n    OMEGA = 7.292115e-5  # Earth's rotation rate [s^-1]\n    \n    # Linearized TEOS-10 coefficients\n    ALPHA = 2.0e-4  # Thermal expansion coefficient [K^-1 or (degC)^-1]\n    BETA = 7.6e-4   # Haline contraction coefficient [(g/kg)^-1]\n\n    # Reference state for linearization\n    S_REF = 35.0    # Reference salinity [g/kg]\n    THETA_REF = 10.0  # Reference temperature [deg C]\n    \n    # Grid parameters\n    NX, NY, NZ = 32, 32, 40\n    DX, DY, DZ = 1e4, 1e4, 50.0  # Grid spacing in [m]\n\n    # Test case definitions: (latitude_deg, s_coeffs, theta_coeffs)\n    # coeffs are (cx, cy, cz) for the analytic functions\n    test_cases = [\n        # Case A: Midlatitude stratified case\n        (45.0, (0.008, 0.012, 0.002), (0.15, 0.05, -1.5)),\n        # Case B: Near-equatorial small-f case\n        (1.0, (0.0, 0.010, 0.002), (0.20, 0.0, -0.5)),\n        # Case C: No horizontal gradients case\n        (30.0, (0.0, 0.0, 0.002), (0.0, 0.0, -0.5)),\n        # Case D: Strong haline front case\n        (60.0, (0.0, 0.030, 0.001), (0.050, 0.050, -0.2)),\n    ]\n\n    results = []\n\n    # Create normalized coordinate vectors for building fields\n    xi_vec = np.arange(NX) / NX\n    eta_vec = np.arange(NY) / NY\n    zeta_vec = np.arange(NZ) / NZ\n\n    # Reshape for broadcasting to a 3D grid\n    xi = xi_vec[:, np.newaxis, np.newaxis]\n    eta = eta_vec[np.newaxis, :, np.newaxis]\n    zeta = zeta_vec[np.newaxis, np.newaxis, :]\n\n    for lat_deg, s_coeffs, theta_coeffs in test_cases:\n        # 1. Calculate Coriolis parameter f\n        lat_rad = np.deg2rad(lat_deg)\n        f_coriolis = 2 * OMEGA * np.sin(lat_rad)\n        \n        # 2. Generate 3D salinity and temperature fields\n        csx, csy, csz = s_coeffs\n        ct_x, cty, ctz = theta_coeffs\n        \n        S_A = S_REF + csx * xi + csy * eta + csz * zeta\n        Theta = THETA_REF + ct_x * xi + cty * eta + ctz * zeta\n\n        # 3. Compute horizontal gradients using 2nd-order centered differences\n        # np.gradient handles boundaries with 1st-order differences.\n        # axis=0 corresponds to x, axis=1 corresponds to y\n        grad_S_A_x = np.gradient(S_A, DX, axis=0)\n        grad_S_A_y = np.gradient(S_A, DY, axis=1)\n        \n        grad_Theta_x = np.gradient(Theta, DX, axis=0)\n        grad_Theta_y = np.gradient(Theta, DY, axis=1)\n\n        # 4. Calculate vertical geostrophic shear components\n        # Thermal wind equations:\n        # du_g/dz = -(g/f) * (beta * dS/dy - alpha * dT/dy)\n        # dv_g/dz =  (g/f) * (beta * dS/dx - alpha * dT/dx)\n        \n        # Check for f=0 (at equator) to avoid division by zero, although not in test cases\n        if f_coriolis == 0:\n            # If horizontal density gradients exist, shear is infinite (balance fails)\n            # If no horizontal gradients, shear is indeterminate but physically zero.\n            # Case C has zero gradients, so the result is 0.\n            if np.all(grad_S_A_x == 0) and np.all(grad_S_A_y == 0) and \\\n               np.all(grad_Theta_x == 0) and np.all(grad_Theta_y == 0):\n                du_g_dz = np.zeros_like(S_A)\n                dv_g_dz = np.zeros_like(S_A)\n            else:\n                # In a real scenario, this would indicate the model is invalid at the equator.\n                # For the purpose of this problem, we can represents this as NaN.\n                du_g_dz = np.full_like(S_A, np.nan)\n                dv_g_dz = np.full_like(S_A, np.nan)\n        else:\n            term_g_over_f = G / f_coriolis\n            \n            # Density gradient terms from TEOS-10 derivative structure\n            d_rho_dx_term = BETA * grad_S_A_x - ALPHA * grad_Theta_x\n            d_rho_dy_term = BETA * grad_S_A_y - ALPHA * grad_Theta_y\n            \n            du_g_dz = -term_g_over_f * d_rho_dy_term\n            dv_g_dz = term_g_over_f * d_rho_dx_term\n\n        # 5. Compute the magnitude of the shear vector at each grid point\n        shear_magnitude = np.sqrt(du_g_dz**2 + dv_g_dz**2)\n\n        # 6. Aggregate result: compute arithmetic mean over the entire 3D grid\n        mean_shear_magnitude = np.mean(shear_magnitude)\n\n        # Round to 6 decimal places as required\n        results.append(round(mean_shear_magnitude, 6))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        },
        {
            "introduction": "The thermal wind relation reveals the baroclinic component of the geostrophic flow but leaves an unknown, depth-independent barotropic velocity. To determine the absolute velocity, we must integrate additional information. This exercise demonstrates a powerful technique to reconcile the calculated geostrophic shear with an independent velocity profile from an instrument like an ADCP . Through a least-squares estimation, you will solve for the barotropic reference velocity, a crucial step in moving from theoretical shear to a complete and observationally-constrained velocity profile.",
            "id": "3816929",
            "problem": "You are given a one-dimensional vertical profile context in which a geostrophic current component $u_g(z)$ is known up to an unknown depth-independent barotropic reference velocity. The fundamental base consists of the geostrophic horizontal momentum equations on an $f$-plane and the hydrostatic balance, which together imply that the vertical shear of the geostrophic current is constrained by the horizontal density gradient through the thermal wind relation. Specifically, the vertical shear profile $\\partial u_g/\\partial z$ is assumed to have been computed from hydrography, while an independent profile of observed horizontal velocity $u_{\\text{ADCP}}(z)$ from an Acoustic Doppler Current Profiler (ADCP) is available. The goal is to reconcile these datasets by estimating the unknown barotropic reference velocity that makes the integrated thermal-wind-consistent profile best fit the ADCP profile in a least-squares sense.\n\nAssume the following modeling framework derived from first principles. The geostrophic current profile $u_g(z)$ can be represented as the sum of a vertically uniform barotropic reference velocity $c$ and a baroclinic contribution obtained by vertically integrating the shear:\n$$\nu_g(z) = c + u_{\\text{rel}}(z),\n$$\nwhere\n$$\nu_{\\text{rel}}(z) = \\int_{z_0}^{z} \\frac{\\partial u_g}{\\partial z'}(z')\\,\\mathrm{d}z',\n$$\nand $z_0$ is the shallowest depth level at which the integration is initiated. The ADCP provides $u_{\\text{ADCP}}(z)$ at a set of discrete depths, with optional nonnegative confidence weights $w(z)$. Missing ADCP values are denoted as not-a-number and should not contribute to the fit.\n\nYour task is to design and implement a least-squares estimator for the scalar $c$ that minimizes the weighted squared misfit between the modeled geostrophic profile $c + u_{\\text{rel}}(z)$ and the observed ADCP profile $u_{\\text{ADCP}}(z)$ over the available depths. The vertical integral should be performed numerically using the trapezoidal rule on the provided discrete depth grid, with the convention $u_{\\text{rel}}(z_0) = 0$. Treat weights equal to zero as excluding the corresponding data from the fit. All depths are given in meters (positive downward), velocities in meters per second, and shear in per second.\n\nImplement a program that, for each test case below, computes and returns the least-squares estimate of $c$ in meters per second, rounded to six decimal places. Angles are not involved. Your program must output the list of results for all test cases as a single line, formatted as a comma-separated list enclosed in square brackets.\n\nTest suite (each case provides arrays of depths $z$, shear $\\partial u_g/\\partial z$, ADCP velocities $u_{\\text{ADCP}}$, and optional weights $w$; if weights are omitted, use uniform weights of one):\n\n- Case 1 (happy path, constant shear, full data):\n  - $z = [0, 50, 100, 150, 200]$ meters\n  - $\\partial u_g/\\partial z = [0.001, 0.001, 0.001, 0.001, 0.001]$ per second\n  - $u_{\\text{ADCP}} = [0.152, 0.199, 0.25, 0.3015, 0.3475]$ meters per second\n  - $w$ omitted\n\n- Case 2 (boundary case, zero shear, full data):\n  - $z = [0, 100, 200, 300]$ meters\n  - $\\partial u_g/\\partial z = [0.0, 0.0, 0.0, 0.0]$ per second\n  - $u_{\\text{ADCP}} = [-0.049, -0.052, -0.0495, -0.0485]$ meters per second\n  - $w$ omitted\n\n- Case 3 (irregular spacing, varying shear, full data):\n  - $z = [0, 30, 80, 140, 230, 350]$ meters\n  - $\\partial u_g/\\partial z = [0.0005, 0.0008, 0.0012, 0.0011, 0.0009, 0.0006]$ per second\n  - $u_{\\text{ADCP}} = [0.019, 0.04, 0.0875, 0.1595, 0.2485, 0.337]$ meters per second\n  - $w$ omitted\n\n- Case 4 (sparse ADCP with missing values and nonuniform weights):\n  - $z = [10, 60, 120, 180, 260]$ meters\n  - $\\partial u_g/\\partial z = [0.0007, 0.0007, 0.0004, 0.0, -0.0002]$ per second\n  - $u_{\\text{ADCP}} = [0.101, \\mathrm{NaN}, 0.166, \\mathrm{NaN}, 0.172]$ meters per second\n  - $w = [1.0, 0.0, 0.5, 0.0, 2.0]$\n\nFinal output format requirement:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each element being the estimated barotropic reference velocity $c$ in meters per second, rounded to six decimal places (for example, \"[0.123456,-0.010000,0.000000,0.050000]\").",
            "solution": "The user wants me to act as a meticulous STEM professor. I need to validate the problem and then solve it.\n\n### **Problem Validation**\n\n**Step 1: Extract Givens**\n\n*   **Model for geostrophic current:** $u_g(z) = c + u_{\\text{rel}}(z)$, where $c$ is a depth-independent barotropic reference velocity.\n*   **Definition of baroclinic velocity:** $u_{\\text{rel}}(z) = \\int_{z_0}^{z} \\frac{\\partial u_g}{\\partial z'}(z')\\,\\mathrm{d}z'$, where $z_0$ is the shallowest depth.\n*   **Initial condition for integration:** $u_{\\text{rel}}(z_0) = 0$.\n*   **Numerical integration method:** Trapezoidal rule.\n*   **Objective:** Find the scalar $c$ that minimizes the weighted squared misfit between the modeled geostrophic profile $c + u_{\\text{rel}}(z)$ and the observed ADCP profile $u_{\\text{ADCP}}(z)$.\n*   **Data handling:**\n    *   ADCP data $u_{\\text{ADCP}}(z)$ is provided at discrete depths.\n    *   Nonnegative confidence weights $w(z)$ are optionally provided. If omitted, they are assumed to be uniform weights of one.\n    *   Missing ADCP values are denoted as not-a-number (NaN) and must not contribute to the fit.\n    *   Weights of zero exclude the corresponding data from the fit.\n*   **Units:** Depths in meters (m), velocities in meters per second (m/s), shear in per second (s⁻¹).\n*   **Output format:** A comma-separated list of values for $c$ for each test case, enclosed in square brackets, with each value rounded to six decimal places.\n*   **Test Cases:**\n    *   **Case 1:** $z = [0, 50, 100, 150, 200]$, $\\partial u_g/\\partial z = [0.001, 0.001, 0.001, 0.001, 0.001]$, $u_{\\text{ADCP}} = [0.152, 0.199, 0.25, 0.3015, 0.3475]$, $w$ omitted.\n    *   **Case 2:** $z = [0, 100, 200, 300]$, $\\partial u_g/\\partial z = [0.0, 0.0, 0.0, 0.0]$, $u_{\\text{ADCP}} = [-0.049, -0.052, -0.0495, -0.0485]$, $w$ omitted.\n    *   **Case 3:** $z = [0, 30, 80, 140, 230, 350]$, $\\partial u_g/\\partial z = [0.0005, 0.0008, 0.0012, 0.0011, 0.0009, 0.0006]$, $u_{\\text{ADCP}} = [0.019, 0.04, 0.0875, 0.1595, 0.2485, 0.337]$, $w$ omitted.\n    *   **Case 4:** $z = [10, 60, 120, 180, 260]$, $\\partial u_g/\\partial z = [0.0007, 0.0007, 0.0004, 0.0, -0.0002]$, $u_{\\text{ADCP}} = [0.101, \\mathrm{NaN}, 0.166, \\mathrm{NaN}, 0.172]$, $w = [1.0, 0.0, 0.5, 0.0, 2.0]$.\n\n**Step 2: Validate Using Extracted Givens**\n\nThe problem is assessed against the validation criteria:\n\n1.  **Scientifically Grounded:** The problem is firmly rooted in the principles of physical oceanography. The thermal wind relation, the decomposition of geostrophic velocity into barotropic and baroclinic components, and the use of ADCP data to reference the geostrophic shear are standard, well-established methods in the field. The setup is scientifically sound.\n2.  **Well-Posed:** The task is to find a single parameter, $c$, that minimizes a sum-of-squares cost function. This is a classic linear least-squares problem. For a set of data points with at least one valid observation (non-NaN $u_{\\text{ADCP}}$ and positive weight $w(z)$), a unique and stable solution for $c$ exists. The problem specification ensures this by defining how to handle invalid data.\n3.  **Objective:** The problem is stated in precise, quantitative, and unbiased technical language.\n4.  **Complete and Consistent:** All necessary information is provided: the physical model, the mathematical objective, the numerical method for integration, and the data for all test cases. The handling of missing data and weights is clearly specified. There are no contradictions.\n5.  **Realistic:** The provided numerical values for depths, shears, and velocities are physically plausible for oceanic conditions.\n\n**Step 3: Verdict and Action**\n\nThe problem is scientifically valid, well-posed, objective, and self-contained. Therefore, a solution will be derived and implemented.\n\n### **Solution Derivation and Algorithmic Design**\n\nThe core of the problem is to find the barotropic reference velocity $c$ that minimizes the weighted sum of squared differences between the modeled geostrophic velocity $u_g(z)$ and the observed ADCP velocity $u_{\\text{ADCP}}(z)$. The data are provided at a set of discrete depths $\\{z_i\\}$.\n\nThe cost function to be minimized is:\n$$\nJ(c) = \\sum_{i} w_i \\left[ u_g(z_i) - u_{\\text{ADCP}}(z_i) \\right]^2\n$$\nwhere the sum is over the set of discrete depth levels, and $w_i = w(z_i)$ are the corresponding weights. The problem mandates that only points where $u_{\\text{ADCP}}(z_i)$ is a valid number and $w_i > 0$ contribute to the sum.\n\nThe model for the geostrophic velocity is given by $u_g(z_i) = c + u_{\\text{rel}}(z_i)$. Substituting this into the cost function yields:\n$$\nJ(c) = \\sum_{i} w_i \\left[ (c + u_{\\text{rel}}(z_i)) - u_{\\text{ADCP}}(z_i) \\right]^2\n$$\n\nTo find the value of $c$ that minimizes $J(c)$, we take the derivative of $J(c)$ with respect to $c$ and set it to zero.\n$$\n\\frac{dJ}{dc} = \\frac{d}{dc} \\sum_{i} w_i \\left[ c + (u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i)) \\right]^2 = 0\n$$\nApplying the chain rule for differentiation:\n$$\n\\sum_{i} w_i \\cdot 2 \\left[ c + u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i) \\right]^1 \\cdot \\frac{d}{dc}(c) = 0\n$$\n$$\n2 \\sum_{i} w_i \\left[ c + u_{\\text{rel}}(z_i) - u_{\\text{ADCP}}(z_i) \\right] = 0\n$$\nWe can separate the terms inside the summation:\n$$\n\\sum_i w_i c + \\sum_i w_i u_{\\text{rel}}(z_i) - \\sum_i w_i u_{\\text{ADCP}}(z_i) = 0\n$$\nSince $c$ is a constant, it can be factored out of the first summation:\n$$\nc \\left( \\sum_i w_i \\right) = \\sum_i w_i u_{\\text{ADCP}}(z_i) - \\sum_i w_i u_{\\text{rel}}(z_i)\n$$\nSolving for $c$, we obtain the analytical solution for the least-squares estimate:\n$$\nc = \\frac{\\sum_i w_i \\left( u_{\\text{ADCP}}(z_i) - u_{\\text{rel}}(z_i) \\right)}{\\sum_i w_i}\n$$\nThis expression reveals that $c$ is the weighted average of the difference between the observed velocity and the relative geostrophic velocity.\n\nThe algorithm to compute $c$ for each test case proceeds in three steps:\n\n1.  **Compute the Relative Velocity Profile, $u_{\\text{rel}}(z_i)$**: The baroclinic component $u_{\\text{rel}}(z)$ is obtained by numerically integrating the given shear profile $\\partial u_g/\\partial z$ from the shallowest depth $z_0$ downwards. The problem specifies the trapezoidal rule. For a set of discrete points $(z_i, S_i)$, where $S_i = (\\partial u_g/\\partial z)(z_i)$, the cumulative integral is computed. With the initial condition $u_{\\text{rel}}(z_0) = 0$, the profile is built iteratively:\n    $$\n    u_{\\text{rel}}(z_i) = u_{\\text{rel}}(z_{i-1}) + (z_i - z_{i-1}) \\frac{S_{i-1} + S_i}{2} \\quad \\text{for } i \\ge 1\n    $$\n    This is efficiently implemented using a cumulative trapezoidal integration function, such as `scipy.integrate.cumulative_trapezoid`.\n\n2.  **Filter the Data**: Before computing $c$, the datasets must be filtered to include only valid points. A data point at depth $z_i$ is considered valid if and only if two conditions are met: the corresponding ADCP velocity $u_{\\text{ADCP}}(z_i)$ is not a \"not-a-number\" (NaN) value, and its weight $w_i$ is strictly positive. All arrays ($u_{\\text{ADCP}}$, $u_{\\text{rel}}$, and $w$) are filtered to retain only the elements corresponding to these valid points.\n\n3.  **Calculate the Estimator $c$**: Using the filtered arrays, the value of $c$ is computed by implementing the derived analytical formula. The numerator is the sum of the products of the filtered weights and the filtered velocity differences ($u_{\\text{ADCP}} - u_{\\text{rel}}$). The denominator is the sum of the filtered weights. The final result is rounded to six decimal places as required.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Solves for the barotropic reference velocity c for a suite of test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (z, shear, u_adcp, optional_w).\n    # np.nan is used for missing ADCP values.\n    test_cases = [\n        (\n            [0, 50, 100, 150, 200],  # z\n            [0.001, 0.001, 0.001, 0.001, 0.001],  # shear\n            [0.152, 0.199, 0.25, 0.3015, 0.3475]  # u_adcp\n        ),\n        (\n            [0, 100, 200, 300],\n            [0.0, 0.0, 0.0, 0.0],\n            [-0.049, -0.052, -0.0495, -0.0485]\n        ),\n        (\n            [0, 30, 80, 140, 230, 350],\n            [0.0005, 0.0008, 0.0012, 0.0011, 0.0009, 0.0006],\n            [0.019, 0.04, 0.0875, 0.1595, 0.2485, 0.337]\n        ),\n        (\n            [10, 60, 120, 180, 260],\n            [0.0007, 0.0007, 0.0004, 0.0, -0.0002],\n            [0.101, np.nan, 0.166, np.nan, 0.172],\n            [1.0, 0.0, 0.5, 0.0, 2.0]  # weights\n        )\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack the case data\n        if len(case) == 4:\n            z, shear, u_adcp, w = case\n        else:\n            z, shear, u_adcp = case\n            w = None # No weights provided\n\n        # Ensure inputs are numpy arrays for vector operations\n        z = np.array(z, dtype=float)\n        shear = np.array(shear, dtype=float)\n        u_adcp = np.array(u_adcp, dtype=float)\n        \n        # If weights are not provided, assign a uniform weight of 1.0\n        if w is None:\n            w = np.ones_like(z)\n        else:\n            w = np.array(w, dtype=float)\n\n        # Step 1: Compute the relative geostrophic velocity profile u_rel(z)\n        # The integral is computed from the shallowest depth z[0] where u_rel is zero.\n        # `cumulative_trapezoid` computes this cumulative integral.\n        u_rel = cumulative_trapezoid(y=shear, x=z, initial=0.0)\n\n        # Step 2: Identify valid data points for the least-squares fit.\n        # A point is valid if its ADCP value is not NaN and its weight is positive.\n        valid_mask = ~np.isnan(u_adcp)  (w > 0)\n\n        # Step 3: Filter data using the mask to get only valid points.\n        w_filt = w[valid_mask]\n        u_adcp_filt = u_adcp[valid_mask]\n        u_rel_filt = u_rel[valid_mask]\n        \n        # Calculate the barotropic reference velocity c\n        # The formula is c = sum(w_i * (u_adcp_i - u_rel_i)) / sum(w_i)\n        # This is the weighted average of the velocity difference.\n        \n        # Check if there are any valid data points to avoid division by zero.\n        if w_filt.size > 0:\n            numerator = np.sum(w_filt * (u_adcp_filt - u_rel_filt))\n            denominator = np.sum(w_filt)\n            c = numerator / denominator\n        else:\n            # If no valid data, c is undefined. This case is not expected\n            # based on the problem description, but as a safeguard, we set to 0.0.\n            c = 0.0\n\n        # Append the formatted result to the list\n        results.append(f\"{c:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}