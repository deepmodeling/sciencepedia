{
    "hands_on_practices": [
        {
            "introduction": "The foundation of any robust computational model lies in the rigorous application of conservation principles. This first practice challenges you to return to this bedrock by constructing a simple box-model budget for Dissolved Inorganic Carbon ($DIC$). Through this exercise , you will demonstrate quantitatively how seemingly minor inconsistencies in units and sign conventions can lead to fundamentally incorrect scientific conclusions about air-sea carbon exchange, reinforcing the critical importance of careful model formulation.",
            "id": "3801549",
            "problem": "You are asked to implement a program that estimates the air–sea carbon dioxide flux using a box-budget for Dissolved Inorganic Carbon (DIC). The objective is to demonstrate, by computation, that mismatched units and sign conventions can lead to erroneous sink estimates. The scenario is a horizontally uniform mixed-layer box of seawater with horizontal area $A$ and thickness $H$, where DIC concentration $C$ is approximately uniform over the box. The foundational base is the conservation of mass for a scalar quantity: the rate of change of the volume-integrated concentration equals the net inflow across the boundary plus any interior sources minus sinks. In words: the time rate of change of the integral over the control volume is balanced by boundary fluxes and volumetric sources and sinks. You must work from this base to derive a computable expression for the unknown air–sea flux and implement it in code.\n\nDefinitions and conventions to adopt for the correct calculation:\n- Dissolved Inorganic Carbon (DIC) concentration $C$ is uniform in the mixed layer.\n- The volume–integrated DIC tendency is represented by $V \\,\\frac{dC}{dt}$, with $V = A\\,H$.\n- The air–sea carbon dioxide flux density $F_{\\mathrm{as}}$ is defined with the sign convention \"positive into the ocean\" (downward), expressed in $\\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$.\n- The total boundary-integrated air–sea contribution is $A\\,F_{\\mathrm{as}}$.\n- Volumetric source and sink terms are provided as integrated rates over the box in $\\mathrm{mol}\\,\\mathrm{s}^{-1}$:\n  - Riverine input $R$ (positive adds DIC to the box).\n  - Advective–mixing tendency $M$ (by default, positive adds DIC to the box; an alternative sign convention is allowed in the test suite and must be handled explicitly).\n  - Net biological transformation $B$ (positive adds DIC to the box, negative removes DIC from the DIC pool).\n\nYour program must:\n- Use the conservation-of-mass base to derive an expression for $F_{\\mathrm{as}}$ in terms of $A$, $H$, $\\frac{dC}{dt}$, $R$, $M$, and $B$.\n- Implement two computations for each test case:\n  1. A correct estimate $F_{\\mathrm{as}}^{\\mathrm{correct}}$ that applies consistent units and proper sign conventions.\n  2. An erroneous estimate $F_{\\mathrm{as}}^{\\mathrm{erroneous}}$ that intentionally applies specified mismatches:\n     - Area unit mismatch: interpret input area labeled as $\\mathrm{km}^{2}$ numerically as if it were $\\mathrm{m}^{2}$ (no conversion).\n     - Time unit mismatch: interpret input $\\frac{dC}{dt}$ labeled as per day numerically as if it were per second (no conversion).\n     - Advective–mixing sign mismatch: interpret an input $M$ labeled with the convention \"positive equals export from the box\" as if it followed the \"positive adds to the box\" convention (no sign inversion).\n\nPhysical units for inputs and outputs:\n- The program must output the air–sea flux in $\\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$ for both the correct and erroneous calculations for each test case.\n- Angles are not involved.\n- Express any ratio or fraction values in decimal form.\n\nTest suite (each case provides $A$, $H$, $\\frac{dC}{dt}$ with unit, $R$, $M$ with sign convention where applicable, $B$, and which mismatches to apply in the erroneous calculation):\n- Case 1 (happy path, fully consistent):\n  - $A = 1.0 \\times 10^{10}\\ \\mathrm{m}^{2}$, $H = 50\\ \\mathrm{m}$, $\\frac{dC}{dt} = 6.0 \\times 10^{-10}\\ \\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$, $R = 20\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$, $M = -50\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$ with convention \"positive adds to box\", $B = -180\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$. Apply no mismatches in the erroneous calculation.\n- Case 2 (area unit mismatch):\n  - $A = 1.0 \\times 10^{4}\\ \\mathrm{km}^{2}$, $H = 50\\ \\mathrm{m}$, $\\frac{dC}{dt} = 6.0 \\times 10^{-10}\\ \\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$, $R = 20\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$, $M = -50\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$ with convention \"positive adds to box\", $B = -180\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$. In the erroneous calculation, treat $\\mathrm{km}^{2}$ numerically as if $\\mathrm{m}^{2}$.\n- Case 3 (advective–mixing sign mismatch):\n  - $A = 2.5 \\times 10^{9}\\ \\mathrm{m}^{2}$, $H = 30\\ \\mathrm{m}$, $\\frac{dC}{dt} = 4.0 \\times 10^{-10}\\ \\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$, $R = 10\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$, $M = +75\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$ with convention \"positive equals export from the box\", $B = -20\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$. In the erroneous calculation, interpret $M$ as if \"positive adds to box\".\n- Case 4 (time unit mismatch):\n  - $A = 3.0 \\times 10^{9}\\ \\mathrm{m}^{2}$, $H = 100\\ \\mathrm{m}$, $\\frac{dC}{dt} = 1.0 \\times 10^{-5}\\ \\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{day}^{-1}$, $R = 0\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$, $M = 0\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$ with convention \"positive adds to box\", $B = 0\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$. In the erroneous calculation, interpret per day numerically as per second.\n\nYour program must produce a single line of output containing the results for all test cases as a comma-separated Python-style list of lists, where each inner list has two floats: $[F_{\\mathrm{as}}^{\\mathrm{correct}}, F_{\\mathrm{as}}^{\\mathrm{erroneous}}]$ in $\\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. For example, the output format must be like: \"[[x1,y1],[x2,y2],[x3,y3],[x4,y4]]\".",
            "solution": "The problem is valid as it is scientifically grounded in the principle of mass conservation, is well-posed with all necessary information provided, and is expressed in objective, formal language. We can proceed with the derivation and implementation.\n\n### Principle-Based Derivation\n\nThe foundation of the model is the conservation of Dissolved Inorganic Carbon (DIC) within a defined control volume, which is a mixed-layer box of horizontal area $A$ and constant thickness $H$. The principle states that the time rate of change of the total mass of a scalar within the volume must equal the net sum of all fluxes across its boundaries and all sources and sinks within its interior.\n\nLet $C$ be the concentration of DIC in $\\mathrm{mol}\\,\\mathrm{m}^{-3}$, assumed uniform throughout the box. The total amount of DIC in the box is the product of concentration and volume $V = A H$. The time rate of change of the total DIC inventory is therefore:\n$$\n\\frac{d(C V)}{dt} = V \\frac{dC}{dt} = A H \\frac{dC}{dt}\n$$\nThis rate of change, with units of $\\mathrm{mol}\\,\\mathrm{s}^{-1}$, is balanced by the sum of all source and sink terms. The problem defines the following terms, all expressed in units of $\\mathrm{mol}\\,\\mathrm{s}^{-1}$:\n\n1.  **Air-sea flux**: The flux density $F_{\\mathrm{as}}$ (in $\\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$) is defined as positive for CO$_2$ entering the ocean. The total flux into the box across the sea surface is the flux density multiplied by the area $A$, resulting in a term $A F_{\\mathrm{as}}$. This is treated as a source term.\n2.  **Riverine input**: $R$, defined as positive when adding DIC to the box. This is a source term.\n3.  **Advective–mixing tendency**: $M$, with the default sign convention being positive when adding DIC to the box. This is a source term.\n4.  **Net biological transformation**: $B$, defined as positive when adding DIC to the DIC pool (e.g., through remineralization). A negative value represents a sink (e.g., primary production). This is treated as a source term.\n\nEquating the rate of change of DIC inventory with the sum of all source terms gives the conservation equation:\n$$\nA H \\frac{dC}{dt} = A F_{\\mathrm{as}} + R + M + B\n$$\nOur objective is to determine the air-sea flux density $F_{\\mathrm{as}}$. We can rearrange the equation to solve for $F_{\\mathrm{as}}$:\n$$\nA F_{\\mathrm{as}} = A H \\frac{dC}{dt} - R - M - B\n$$\nDividing by the area $A$ yields the final expression for $F_{\\mathrm{as}}$:\n$$\nF_{\\mathrm{as}} = H \\frac{dC}{dt} - \\frac{R + M + B}{A}\n$$\nA dimensional analysis confirms the correctness of this formula. The term $H \\frac{dC}{dt}$ has units of $\\mathrm{m} \\cdot (\\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}) = \\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. The term $\\frac{R+M+B}{A}$ has units of $(\\mathrm{mol}\\,\\mathrm{s}^{-1}) / \\mathrm{m}^{2} = \\mathrm{mol}\\,\\mathrm{m}^{-2}\\,\\mathrm{s}^{-1}$. The result is correctly in units of flux density.\n\n### Algorithmic Design and Implementation\n\nThe program must compute two values for each test case: a correct estimate $F_{\\mathrm{as}}^{\\mathrm{correct}}$ and an erroneous estimate $F_{\\mathrm{as}}^{\\mathrm{erroneous}}$. This requires a dual-path calculation logic.\n\n**1. Correct Calculation ($F_{\\mathrm{as}}^{\\mathrm{correct}}$)**\n\nThis path requires rigorous adherence to unit and sign consistency.\n-   **Unit Conversion**: All input parameters must be converted to a consistent SI base unit system before being used in the formula.\n    -   Area $A$: If given in $\\mathrm{km}^{2}$, it must be converted to $\\mathrm{m}^{2}$ by multiplying by $(10^3)^2 = 10^6$.\n    -   DIC tendency $\\frac{dC}{dt}$: If given in $\\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{day}^{-1}$, it must be converted to $\\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$ by dividing by the number of seconds in a day, which is $24 \\times 60 \\times 60 = 86400$.\n-   **Sign Convention**: The advective-mixing term $M$ requires special handling. Our derived formula assumes $M  0$ is a source. If an input for $M$ uses the convention \"positive equals export from the box\", its sign must be inverted to align with our formula's convention.\n\n**2. Erroneous Calculation ($F_{\\mathrm{as}}^{\\mathrm{erroneous}}$)**\n\nThis path intentionally introduces specific errors as defined in each test case.\n-   **Area Unit Mismatch**: If this error is specified for a case with area in $\\mathrm{km}^{2}$, the numerical value of $A$ is used directly as if it were in $\\mathrm{m}^{2}$, skipping the conversion factor of $10^6$.\n-   **Time Unit Mismatch**: If this error is specified for a case with $\\frac{dC}{dt}$ in units per day, the numerical value is used directly as if it were in units per second, skipping the division by $86400$.\n-   **Advective-Mixing Sign Mismatch**: If this error is specified for a case where $M$ is given with an \"export is positive\" convention, the value of $M$ is used directly without the necessary sign inversion.\n\nA single computational function can be designed to handle both paths, using conditional logic based on which calculation (correct or erroneous) is being performed and the mismatch flags specific to the test case.\n\nFor example, let's analyze Case 3:\n-   **Given**: $A = 2.5 \\times 10^{9}\\ \\mathrm{m}^{2}$, $H = 30\\ \\mathrm{m}$, $\\frac{dC}{dt} = 4.0 \\times 10^{-10}\\ \\mathrm{mol}\\,\\mathrm{m}^{-3}\\,\\mathrm{s}^{-1}$, $R = 10\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$, $M = +75\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$ (\"positive equals export\"), $B = -20\\ \\mathrm{mol}\\,\\mathrm{s}^{-1}$. Mismatch: advective-mixing sign.\n\n-   **Correct Calculation**: The value of $M$ must be inverted to fit the formula's convention ($M_{\\mathrm{correct}} = -75$).\n    $$F_{\\mathrm{as}}^{\\mathrm{correct}} = (30)(4.0 \\times 10^{-10}) - \\frac{10 + (-75) + (-20)}{2.5 \\times 10^9} = 1.2 \\times 10^{-8} - \\frac{-85}{2.5 \\times 10^9} = 4.6 \\times 10^{-8}$$\n-   **Erroneous Calculation**: The value of $M$ is used as is ($M_{\\mathrm{erroneous}} = +75$).\n    $$F_{\\mathrm{as}}^{\\mathrm{erroneous}} = (30)(4.0 \\times 10^{-10}) - \\frac{10 + 75 + (-20)}{2.5 \\times 10^9} = 1.2 \\times 10^{-8} - \\frac{65}{2.5 \\times 10^9} = -1.4 \\times 10^{-8}$$\nThe sign error in $M$ flips the calculated air-sea flux from a sink ($F_{\\mathrm{as}}  0$) to a source ($F_{\\mathrm{as}}  0$), demonstrating the critical importance of convention handling. The code will systematically apply this logic to all test cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and computes the air-sea CO2 flux from a DIC box budget.\n    This program demonstrates the impact of unit and sign convention errors.\n    \"\"\"\n    # Test cases defined as a list of dictionaries.\n    # Each dictionary holds parameters and specifications for a single case.\n    test_cases = [\n        {\n            \"A\": 1.0e10, \"A_units\": \"m^2\", \"H\": 50,\n            \"dCdt\": 6.0e-10, \"dCdt_units\": \"s^-1\",\n            \"R\": 20, \"M\": -50, \"M_conv\": \"adds\", \"B\": -180,\n            \"mismatches\": [] # Case 1: Happy path\n        },\n        {\n            \"A\": 1.0e4, \"A_units\": \"km^2\", \"H\": 50,\n            \"dCdt\": 6.0e-10, \"dCdt_units\": \"s^-1\",\n            \"R\": 20, \"M\": -50, \"M_conv\": \"adds\", \"B\": -180,\n            \"mismatches\": [\"area\"] # Case 2: Area unit mismatch\n        },\n        {\n            \"A\": 2.5e9, \"A_units\": \"m^2\", \"H\": 30,\n            \"dCdt\": 4.0e-10, \"dCdt_units\": \"s^-1\",\n            \"R\": 10, \"M\": 75, \"M_conv\": \"export\", \"B\": -20,\n            \"mismatches\": [\"advection_sign\"] # Case 3: Advection sign mismatch\n        },\n        {\n            \"A\": 3.0e9, \"A_units\": \"m^2\", \"H\": 100,\n            \"dCdt\": 1.0e-5, \"dCdt_units\": \"day^-1\",\n            \"R\": 0, \"M\": 0, \"M_conv\": \"adds\", \"B\": 0,\n            \"mismatches\": [\"time\"] # Case 4: Time unit mismatch\n        }\n    ]\n\n    results = [calculate_flux_pair(case) for case in test_cases]\n\n    # Format the output string as a Python-style list of lists with no spaces.\n    inner_parts = [f\"[{r[0]},{r[1]}]\" for r in results]\n    final_output = f\"[{','.join(inner_parts)}]\"\n    print(final_output)\n\ndef calculate_flux_pair(case):\n    \"\"\"\n    Calculates both the correct and erroneous flux for a given test case.\n    \"\"\"\n    F_as_correct = calculate_flux(case, is_erroneous=False)\n    F_as_erroneous = calculate_flux(case, is_erroneous=True)\n    return [F_as_correct, F_as_erroneous]\n\ndef calculate_flux(case, is_erroneous):\n    \"\"\"\n    Generic function to calculate F_as, handling correct and erroneous logic.\n\n    Args:\n        case (dict): Dictionary of parameters for the calculation.\n        is_erroneous (bool): If True, applies specified mismatches.\n\n    Returns:\n        float: The calculated air-sea flux F_as in mol m^-2 s^-1.\n    \"\"\"\n    # 1. Process Area (A)\n    A_val = case[\"A\"]\n    if case[\"A_units\"] == \"km^2\":\n        # Apply conversion unless it's an erroneous run with an area mismatch\n        apply_conversion = not (is_erroneous and \"area\" in case[\"mismatches\"])\n        if apply_conversion:\n            A_val *= 1e6  # 1 km^2 = 1e6 m^2\n\n    # 2. Process DIC tendency (dC/dt)\n    dCdt_val = case[\"dCdt\"]\n    if case[\"dCdt_units\"] == \"day^-1\":\n        # Apply conversion unless it's an erroneous run with a time mismatch\n        apply_conversion = not (is_erroneous and \"time\" in case[\"mismatches\"])\n        if apply_conversion:\n            dCdt_val /= 86400  # seconds in a day\n\n    # 3. Process Advective-mixing term (M)\n    M_val = case[\"M\"]\n    if case[\"M_conv\"] == \"export\":\n        # Apply sign inversion unless it's an erroneous run with a sign mismatch\n        apply_inversion = not (is_erroneous and \"advection_sign\" in case[\"mismatches\"])\n        if apply_inversion:\n            M_val *= -1\n\n    # Get other parameters\n    H_val = case[\"H\"]\n    R_val = case[\"R\"]\n    B_val = case[\"B\"]\n\n    # 4. Calculate F_as using the derived formula\n    # F_as = H * dC/dt - (R + M + B) / A\n    term1 = H_val * dCdt_val\n    term2 = (R_val + M_val + B_val) / A_val\n    F_as = term1 - term2\n\n    return F_as\n\nsolve()\n```"
        },
        {
            "introduction": "Building upon the concept of a mass budget, we now extend our focus to a spatially resolved, one-dimensional model of the ocean water column. This practice  immerses you in the core mechanics of modeling the biological carbon pump by implementing a classic particle remineralization profile, known as the Martin curve. You will derive the particulate carbon flux from first principles and then implement a finite-volume numerical scheme to see how this biological source interacts with vertical advection and diffusion to shape the $DIC$ profile.",
            "id": "3801569",
            "problem": "You are tasked with implementing a vertically varying remineralization profile for carbon in the ocean interior and translating it into a source term for Dissolved Inorganic Carbon (DIC) in a one-dimensional column model. The remineralization follows a power-law depth dependence consistent with the Martin curve. Starting from conservation principles, consider the following:\n\n- The volumetric remineralization rate is given by $R(z)=R_0\\,(z/z_0)^{-b}$ for $z\\in(0,H]$, where $R_0$ has units of mol C m$^{-3}$ s$^{-1}$, $z$ and $z_0$ are in meters, $b$ is dimensionless, and $H$ is the domain depth in meters. The surface at $z=0$ is not included to avoid singularity.\n- The downward export flux of particulate organic carbon (POC), denoted $F(z)$ with units mol C m$^{-2}$ s$^{-1}$, is determined by vertical integration of $R(z)$ from depth $z$ to the bottom boundary at $z=H$, using the boundary condition $F(H)=0$. This reflects that there is no further remineralization below the bottom of the domain. You must derive and implement $F(z)$ from this definition.\n- The DIC budget in one dimension obeys the conservation equation $\\partial C/\\partial t = -\\partial (w\\,C)/\\partial z - \\partial(-K\\,\\partial C/\\partial z)/\\partial z + R(z)$, where $C(z)$ is the DIC concentration in mol C m$^{-3}$, $w$ is the constant vertical velocity in m s$^{-1}$ (positive downward), and $K$ is the constant vertical diffusivity in m$^2$ s$^{-1}$.\n- Treat advection and diffusion as fluxes across control-volume interfaces and discretize the tendency using a finite-volume approach on a uniform grid of $N$ cells spanning $[0,H]$ with cell centers at $z_i=(i+1/2)\\,\\Delta z$, where $\\Delta z = H/N$. Use an upwind scheme for the advective flux $F_{\\text{adv}}=w\\,C$ at interfaces, and a centered difference for the diffusive flux $F_{\\text{diff}}=-K\\,\\partial C/\\partial z$. Impose impenetrable boundaries for the scalar fluxes at the top and bottom: set both advective and diffusive fluxes to zero at $z=0$ and $z=H$. The volumetric source $R(z)$ acts at cell centers.\n- The discrete tendency at cell $i$ should be computed as $(\\partial C/\\partial t)_i = -\\left(F_{i+1/2}-F_{i-1/2}\\right)/\\Delta z + R(z_i)$.\n\nImplement the following, starting only from these definitions and laws:\n\n1. Derive the closed-form expression for the export flux $F(z)$ as the vertical integral of $R(z)$ from $z$ to $H$ for general $b$ and the special case $b=1$.\n2. Implement $R(z)$, the derived $F(z)$, and the discrete DIC tendency using the specified numerical scheme.\n3. For each test case below, compute:\n   - The export flux at a target depth $z_{\\text{target}}$, denoted $E_{\\text{target}}=F(z_{\\text{target}})$ in mol C m$^{-2}$ s$^{-1}$.\n   - The instantaneous DIC tendency at the grid cell whose center is closest to $z_{\\text{target}}$, denoted $T_{\\text{target}}$ in mol C m$^{-3}$ s$^{-1}$.\n\nUse the following test suite with scientifically plausible parameters. In each case, the DIC profile is $C(z) = C_0 + \\alpha z$ with $C_0$ and $\\alpha$ given.\n\n- Case 1 (general, downward advection):\n  - $H=4000$ m, $N=40$, $\\Delta z=100$ m, $z_0=100$ m, $b=1.4$, $R_0=6\\times 10^{-8}$ mol C m$^{-3}$ s$^{-1}$, $K=5\\times 10^{-5}$ m$^2$ s$^{-1}$, $w=1\\times 10^{-5}$ m s$^{-1}$, $C_0=2.2$ mol C m$^{-3}$, $\\alpha=1\\times 10^{-4}$ mol C m$^{-4}$, $z_{\\text{target}}=1000$ m.\n- Case 2 (logarithmic export, no advection):\n  - $H=5000$ m, $N=50$, $\\Delta z=100$ m, $z_0=150$ m, $b=1.0$, $R_0=5\\times 10^{-8}$ mol C m$^{-3}$ s$^{-1}$, $K=1\\times 10^{-4}$ m$^2$ s$^{-1}$, $w=0$ m s$^{-1}$, $C_0=2.0$ mol C m$^{-3}$, $\\alpha=2\\times 10^{-4}$ mol C m$^{-4}$, $z_{\\text{target}}=500$ m.\n- Case 3 (sublinear exponent, upward advection):\n  - $H=1000$ m, $N=20$, $\\Delta z=50$ m, $z_0=75$ m, $b=0.8$, $R_0=1\\times 10^{-7}$ mol C m$^{-3}$ s$^{-1}$, $K=2\\times 10^{-5}$ m$^2$ s$^{-1}$, $w=-5\\times 10^{-6}$ m s$^{-1}$, $C_0=2.0$ mol C m$^{-3}$, $\\alpha=5\\times 10^{-4}$ mol C m$^{-4}$, $z_{\\text{target}}=50$ m.\n- Case 4 (steep decay, stronger downward advection):\n  - $H=6000$ m, $N=30$, $\\Delta z=200$ m, $z_0=200$ m, $b=2.0$, $R_0=2\\times 10^{-8}$ mol C m$^{-3}$ s$^{-1}$, $K=1\\times 10^{-5}$ m$^2$ s$^{-1}$, $w=3\\times 10^{-5}$ m s$^{-1}$, $C_0=2.5$ mol C m$^{-3}$, $\\alpha=5\\times 10^{-5}$ mol C m$^{-4}$, $z_{\\text{target}}=3000$ m.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[E_1,T_1,E_2,T_2,E_3,T_3,E_4,T_4]$, where $E_k$ is the export flux and $T_k$ is the DIC tendency for the $k$-th case. Express $E_k$ in mol C m$^{-2}$ s$^{-1}$ and $T_k$ in mol C m$^{-3}$ s$^{-1}$. Angles are not involved; no angle units are required. Do not use percentages.",
            "solution": "The user has provided a well-posed problem in computational oceanography. The solution requires two main components: an analytical derivation of the particulate organic carbon (POC) flux, and the numerical implementation of a one-dimensional advection-diffusion-reaction equation for Dissolved Inorganic Carbon (DIC).\n\n### 1. Derivation of the POC Export Flux $F(z)$\n\nThe POC export flux, $F(z)$, represents the downward transport of particulate carbon at depth $z$. It is defined as the vertical integral of the volumetric remineralization rate, $R(z')$, from depth $z$ to the bottom of the domain, $H$. The remineralization rate is given by the power-law function $R(z) = R_0 (z/z_0)^{-b}$. This relationship stems from the principle of mass conservation: the change in flux over a depth interval must equal the amount of carbon remineralized within that interval.\n\nThe mathematical definition is:\n$$\nF(z) = \\int_{z' = z}^{z' = H} R(z') \\, dz'\n$$\nwith the boundary condition $F(H) = 0$, indicating no flux out of the bottom of the domain.\n\nSubstituting the expression for $R(z')$:\n$$\nF(z) = \\int_{z}^{H} R_0 \\left(\\frac{z'}{z_0}\\right)^{-b} \\, dz' = R_0 z_0^b \\int_{z}^{H} (z')^{-b} \\, dz'\n$$\n\nWe must consider two cases for the exponent $b$.\n\n**Case 1: General case ($b \\neq 1$)**\n\nThe integral of a power-law function $(z')^{-b}$ is $\\frac{(z')^{-b+1}}{-b+1}$. Evaluating this definite integral yields:\n$$\nF(z) = R_0 z_0^b \\left[ \\frac{(z')^{1-b}}{1-b} \\right]_{z}^{H}\n= \\frac{R_0 z_0^b}{1-b} \\left( H^{1-b} - z^{1-b} \\right)\n$$\nThis expression satisfies the boundary condition, as $F(H) = \\frac{R_0 z_0^b}{1-b} (H^{1-b} - H^{1-b}) = 0$.\n\n**Case 2: Special case ($b = 1$)**\n\nWhen $b=1$, the integrand becomes $(z')^{-1}$, whose integral is the natural logarithm.\n$$\nF(z) = R_0 z_0^1 \\int_{z}^{H} (z')^{-1} \\, dz' = R_0 z_0 \\left[ \\ln(z') \\right]_{z}^{H}\n$$\n$$\nF(z) = R_0 z_0 \\left( \\ln(H) - \\ln(z) \\right) = R_0 z_0 \\ln\\left(\\frac{H}{z}\\right)\n$$\nThis expression also satisfies the boundary condition, as $F(H) = R_0 z_0 \\ln(H/H) = R_0 z_0 \\ln(1) = 0$.\n\n### 2. Discretization of the DIC Tendency\n\nThe conservation equation for DIC concentration, $C$, is given by:\n$$\n\\frac{\\partial C}{\\partial t} = -\\frac{\\partial}{\\partial z} \\underbrace{(wC - K \\frac{\\partial C}{\\partial z})}_{\\text{Total Flux } \\mathcal{F}} + R(z)\n$$\nWe discretize this equation using a finite-volume approach on a uniform grid with $N$ cells. The grid cells are indexed by $i=0, 1, \\ldots, N-1$. Each cell $i$ has a width $\\Delta z = H/N$ and is centered at $z_i = (i+1/2)\\Delta z$. The interface between cell $i$ and cell $i+1$ is located at $(i+1)\\Delta z$.\n\nThe discrete tendency for cell $i$, $(\\partial C/\\partial t)_i$, is:\n$$\n\\left(\\frac{\\partial C}{\\partial t}\\right)_i = -\\frac{\\mathcal{F}_{i+1/2} - \\mathcal{F}_{i-1/2}}{\\Delta z} + R(z_i)\n$$\nwhere $\\mathcal{F}_{i+1/2}$ is the total flux at the interface between cell $i$ and $i+1$, and $R(z_i)$ is the source term evaluated at the cell center. The problem specifies impenetrable boundaries, meaning the fluxes at the top ($z=0$) and bottom ($z=H$) of the domain are zero. For our indexing, this means $\\mathcal{F}_{-1/2} = 0$ and $\\mathcal{F}_{N-1/2} = 0$.\n\nThe total flux $\\mathcal{F}$ is the sum of advective ($F_{\\text{adv}}$) and diffusive ($F_{\\text{diff}}$) fluxes.\n\n**Diffusive Flux**: A centered difference scheme is used for the diffusive flux at interface $i+1/2$:\n$$\nF_{\\text{diff}, i+1/2} = -K \\left(\\frac{\\partial C}{\\partial z}\\right)_{i+1/2} \\approx -K \\frac{C_{i+1} - C_i}{\\Delta z}\n$$\nwhere $C_i$ and $C_{i+1}$ are the concentrations at the centers of cells $i$ and $i+1$, respectively.\n\n**Advective Flux**: An upwind scheme is used for the advective flux $F_{\\text{adv}} = wC$. The concentration at the interface is taken from the upwind cell.\n- If $w  0$ (downward advection), the flow is from cell $i$ to cell $i+1$. The upwind concentration is $C_i$.\n  $$F_{\\text{adv}, i+1/2} = w C_i$$\n- If $w  0$ (upward advection), the flow is from cell $i+1$ to cell $i$. The upwind concentration is $C_{i+1}$.\n  $$F_{\\text{adv}, i+1/2} = w C_{i+1}$$\n- If $w = 0$, there is no advective flux: $F_{\\text{adv}, i+1/2} = 0$.\n\nThis can be expressed compactly as $F_{\\text{adv}, i+1/2} = \\max(w, 0) C_i + \\min(w, 0) C_{i+1}$.\n\n### 3. Algorithm for Calculation\n\nFor each test case, we compute two quantities: the export flux $E_{\\text{target}} = F(z_{\\text{target}})$ and the DIC tendency $T_{\\text{target}} = (\\partial C/\\partial t)_{i_{\\text{target}}}$.\n\n**1. Compute Export Flux ($E_{\\text{target}}$):**\n   - The value is calculated directly using the derived analytical formulas for $F(z)$:\n     - If $b=1$, use $F(z_{\\text{target}}) = R_0 z_0 \\ln(H/z_{\\text{target}})$.\n     - If $b \\neq 1$, use $F(z_{\\text{target}}) = \\frac{R_0 z_0^b}{1-b} (H^{1-b} - z_{\\text{target}}^{1-b})$.\n\n**2. Compute DIC Tendency ($T_{\\text{target}}$):**\n   - **Grid Setup**: Define the grid centers $z_i = (i+1/2)\\Delta z$ for $i=0, \\ldots, N-1$.\n   - **Target Cell**: Identify the index $i_{\\text{target}}$ of the cell whose center $z_{i_{\\text{target}}}$ is closest to the given $z_{\\text{target}}$. This is found by minimizing $|z_i - z_{\\text{target}}|$ over all $i$.\n   - **Concentration Profile**: Evaluate the DIC concentration at all cell centers using the given linear profile $C(z) = C_0 + \\alpha z$, yielding a vector $C_i = C(z_i)$.\n   - **Flux Calculation**:\n     - Create an array to store fluxes at the $N+1$ interfaces, indexed from $0$ to $N$.\n     - Set boundary fluxes to zero: $\\mathcal{F}_0 = 0$ and $\\mathcal{F}_N = 0$.\n     - For each interior interface $j = 1, \\ldots, N-1$, calculate the total flux $\\mathcal{F}_j$ separating cell $j-1$ and cell $j$.\n       $$\n       \\mathcal{F}_j = \\overbrace{\\left(\\max(w, 0) C_{j-1} + \\min(w, 0) C_j\\right)}^{\\text{Advective Flux}} + \\overbrace{\\left(-K \\frac{C_j - C_{j-1}}{\\Delta z}\\right)}^{\\text{Diffusive Flux}}\n       $$\n   - **Tendency Calculation**:\n     - The tendency for the target cell $i_{\\text{target}}$ is computed using the fluxes at its boundaries, $\\mathcal{F}_{i_{\\text{target}}}$ and $\\mathcal{F}_{i_{\\text{target}}+1}$, and the local source term $R(z_{i_{\\text{target}}})$.\n     $$\n     T_{\\text{target}} = -\\frac{\\mathcal{F}_{i_{\\text{target}}+1} - \\mathcal{F}_{i_{\\text{target}}}}{\\Delta z} + R_0\\left(\\frac{z_{i_{\\text{target}}}}{z_0}\\right)^{-b}\n     $$\nThis procedure is applied to each of the four test cases specified in the problem.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the ocean carbon cycle problem for a suite of test cases.\n    \"\"\"\n    \n    test_cases = [\n        # Case 1 (general, downward advection)\n        {'H': 4000, 'N': 40, 'z_0': 100, 'b': 1.4, 'R_0': 6e-8, 'K': 5e-5, 'w': 1e-5, 'C_0': 2.2, 'alpha': 1e-4, 'z_target': 1000},\n        # Case 2 (logarithmic export, no advection)\n        {'H': 5000, 'N': 50, 'z_0': 150, 'b': 1.0, 'R_0': 5e-8, 'K': 1e-4, 'w': 0, 'C_0': 2.0, 'alpha': 2e-4, 'z_target': 500},\n        # Case 3 (sublinear exponent, upward advection)\n        {'H': 1000, 'N': 20, 'z_0': 75, 'b': 0.8, 'R_0': 1e-7, 'K': 2e-5, 'w': -5e-6, 'C_0': 2.0, 'alpha': 5e-4, 'z_target': 50},\n        # Case 4 (steep decay, stronger downward advection)\n        {'H': 6000, 'N': 30, 'z_0': 200, 'b': 2.0, 'R_0': 2e-8, 'K': 1e-5, 'w': 3e-5, 'C_0': 2.5, 'alpha': 5e-5, 'z_target': 3000},\n    ]\n\n    results = []\n    for params in test_cases:\n        E_target, T_target = calculate_outputs(params)\n        results.extend([E_target, T_target])\n\n    # Format the final output string\n    output_str = \"[\" + \",\".join(f\"{res:.6e}\" for res in results) + \"]\"\n    print(output_str)\n\ndef calculate_outputs(params):\n    \"\"\"\n    Calculates the export flux and DIC tendency for a single test case.\n    \"\"\"\n    # Unpack parameters for clarity\n    H = params['H']\n    N = params['N']\n    z_0 = params['z_0']\n    b = params['b']\n    R_0 = params['R_0']\n    K = params['K']\n    w = params['w']\n    C_0 = params['C_0']\n    alpha = params['alpha']\n    z_target = params['z_target']\n\n    # Grid spacing\n    dz = H / N\n\n    # --- 1. Calculate Export Flux E_target = F(z_target) ---\n    if b == 1.0:\n        # Special case b=1\n        if z_target > 0:\n            E_target = R_0 * z_0 * np.log(H / z_target)\n        else:\n            E_target = np.inf\n    else:\n        # General case b != 1\n        term1 = R_0 * (z_0**b) / (1 - b)\n        term2 = H**(1 - b) - z_target**(1 - b)\n        E_target = term1 * term2\n\n    # --- 2. Calculate DIC Tendency T_target ---\n    # Setup grid\n    cell_indices = np.arange(N)\n    z_centers = (cell_indices + 0.5) * dz\n    \n    # Find the index of the cell closest to z_target\n    i_target = np.argmin(np.abs(z_centers - z_target))\n    z_i_target = z_centers[i_target]\n\n    # Evaluate DIC concentration on the grid\n    C_grid = C_0 + alpha * z_centers\n\n    # Calculate fluxes at cell interfaces\n    fluxes = np.zeros(N + 1)  # N+1 interfaces from z=0 to z=H\n    \n    # Interior fluxes (j=1 to N-1, corresponding to z=dz to z=(N-1)dz)\n    for j in range(1, N):\n        C_left = C_grid[j - 1]\n        C_right = C_grid[j]\n\n        # Diffusive flux (centered difference)\n        F_diff = -K * (C_right - C_left) / dz\n\n        # Advective flux (upwind scheme)\n        if w > 0:\n            F_adv = w * C_left\n        elif w  0:\n            F_adv = w * C_right\n        else:\n            F_adv = 0.0\n            \n        fluxes[j] = F_adv + F_diff\n\n    # Boundary fluxes are zero (impenetrable)\n    fluxes[0] = 0.0\n    fluxes[N] = 0.0\n\n    # Remineralization source term at the target cell center\n    # z_i_target is always > 0, so no singularity\n    R_i_target = R_0 * (z_i_target / z_0)**(-b)\n\n    # Calculate the tendency at the target cell\n    # Fluxes are at indices i_target (top) and i_target+1 (bottom)\n    flux_divergence = (fluxes[i_target + 1] - fluxes[i_target]) / dz\n    T_target = -flux_divergence + R_i_target\n    \n    return E_target, T_target\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "Accurate simulation of the ocean carbon cycle hinges on correctly solving the marine carbonate system, a set of non-linear chemical equilibria. This advanced practice  addresses a subtle but crucial detail: the need for consistency between the chosen $pH$ scale and the corresponding equilibrium constants. You will develop a diagnostic test to detect such mismatches, a vital skill for validating and debugging the biogeochemical cores of Earth system models.",
            "id": "3801518",
            "problem": "You are asked to design and implement a consistency check for a carbonate chemistry solver used in modeling the ocean carbon cycle. The goal is to justify from first principles why the pairing of the acidity measure (the $pH$ scale) and the equilibrium constants must be consistent, and to construct a diagnostic test that detects mismatches in that pairing using only model diagnostics (computed species and re-computed total alkalinity). Your program must solve for the hydrogen ion concentration on a specified $pH$ scale to satisfy a given Total Alkalinity (TA) and Dissolved Inorganic Carbon (DIC), then compute a cross-scale inconsistency index. The final output will be one number per test case.\n\nStart from the following fundamental base of acid-base equilibrium and charge-balance definitions:\n- Dissolved Inorganic Carbon (DIC) is defined by $$\\mathrm{DIC} = [\\mathrm{CO}_2^\\ast] + [\\mathrm{HCO}_3^-] + [\\mathrm{CO}_3^{2-}],$$ where $[\\mathrm{CO}_2^\\ast]$ denotes the total hydrated carbon dioxide (carbonic acid plus dissolved carbon dioxide).\n- The carbonate speciation under stoichiometric equilibrium is determined by the mass-action laws $$K_1 = \\frac{[\\mathrm{H}^+][\\mathrm{HCO}_3^-]}{[\\mathrm{CO}_2^\\ast]},\\quad K_2 = \\frac{[\\mathrm{H}^+][\\mathrm{CO}_3^{2-}]}{[\\mathrm{HCO}_3^-]},$$ which, for a given $[\\mathrm{H}^+]$, imply $$[\\mathrm{CO}_2^\\ast] = \\frac{\\mathrm{DIC}}{1 + \\frac{K_1}{[\\mathrm{H}^+]} + \\frac{K_1 K_2}{[\\mathrm{H}^+]^2}},\\quad [\\mathrm{HCO}_3^-] = \\frac{\\mathrm{DIC}\\,\\frac{K_1}{[\\mathrm{H}^+]}}{1 + \\frac{K_1}{[\\mathrm{H}^+]} + \\frac{K_1 K_2}{[\\mathrm{H}^+]^2}},\\quad [\\mathrm{CO}_3^{2-}] = \\frac{\\mathrm{DIC}\\,\\frac{K_1 K_2}{[\\mathrm{H}^+]^2}}{1 + \\frac{K_1}{[\\mathrm{H}^+]} + \\frac{K_1 K_2}{[\\mathrm{H}^+]^2}}.$$\n- The boric acid system obeys $$K_B = \\frac{[\\mathrm{H}^+][\\mathrm{B(OH)}_4^-]}{[\\mathrm{B(OH)}_3]},\\quad B_T = [\\mathrm{B(OH)}_3] + [\\mathrm{B(OH)}_4^-],$$ which implies $$[\\mathrm{B(OH)}_4^-] = B_T \\frac{K_B}{K_B + [\\mathrm{H}^+]}.$$\n- Water autoionization yields $$K_W = [\\mathrm{H}^+][\\mathrm{OH}^-],\\quad [\\mathrm{OH}^-] = \\frac{K_W}{[\\mathrm{H}^+]}.$$\n- Total Alkalinity (TA) is defined by the conservative charge-balance proxy that excludes sulfate and fluoride contributions and includes borate and water, $$\\mathrm{TA} = [\\mathrm{HCO}_3^-] + 2[\\mathrm{CO}_3^{2-}] + [\\mathrm{B(OH)}_4^-] + [\\mathrm{OH}^-] - [\\mathrm{H}^+].$$\n\nJustification of scale consistency. The acidity variable $[\\mathrm{H}^+]$ is not unique in seawater; different $pH$ scales count different proton donors:\n- On the free scale, $[\\mathrm{H}^+]_{\\mathrm{F}}$ denotes only free hydrogen ions.\n- On the total scale, $[\\mathrm{H}^+]_{\\mathrm{T}}$ includes the effect of the hydrogen sulfate association through the stoichiometric bisulfate equilibrium; approximately $$[\\mathrm{H}^+]_{\\mathrm{T}} \\approx [\\mathrm{H}^+]_{\\mathrm{F}} \\left(1 + \\frac{T_{\\mathrm{SO4}}}{K_{\\mathrm{HSO4}}}\\right),$$ where $T_{\\mathrm{SO4}}$ is total sulfate and $K_{\\mathrm{HSO4}}$ is the stoichiometric dissociation constant for bisulfate.\n- On the seawater scale, $[\\mathrm{H}^+]_{\\mathrm{S}}$ includes both sulfate and fluoride associations; approximately $$[\\mathrm{H}^+]_{\\mathrm{S}} \\approx [\\mathrm{H}^+]_{\\mathrm{F}} \\left(1 + \\frac{T_{\\mathrm{SO4}}}{K_{\\mathrm{HSO4}}} + \\frac{T_{\\mathrm{F}}}{K_{\\mathrm{HF}}}\\right),$$ with $T_{\\mathrm{F}}$ the total fluoride and $K_{\\mathrm{HF}}$ the stoichiometric association constant for hydrogen fluoride. Therefore, the $pH$ scales differ by multiplicative conversion factors on $[\\mathrm{H}^+]$. Because the equilibrium constants $K_1$, $K_2$, $K_B$, and $K_W$ are defined with a particular $[\\mathrm{H}^+]$ in their mass-action expressions, the algebraic mapping from $\\mathrm{DIC}$ and $\\mathrm{TA}$ to $[\\mathrm{H}^+]$ and species depends on the chosen scale. A consistent solver must evaluate the equilibrium expressions using a $[\\mathrm{H}^+]$ that corresponds to the same scale as the constants. Otherwise, the computed speciation will satisfy a numerically adjusted equality but violate scale-invariant diagnostics when transformed across scales.\n\nConstruct the detection test. After solving for $[\\mathrm{H}^+]$ on a chosen $pH$ scale with a given set of constants, compute the Total Alkalinity on each of the three scales by converting the solved $[\\mathrm{H}^+]$ across scales using the above multiplicative factors and re-evaluating the equilibrium expressions consistently with that target scale. Define the cross-scale inconsistency index $$I = \\max_{s \\in \\{\\mathrm{F},\\mathrm{T},\\mathrm{S}\\}} \\left|\\mathrm{TA}_s - \\mathrm{TA}_{\\mathrm{input}}\\right|,$$ where $\\mathrm{TA}_s$ is the recomputed Total Alkalinity using $[\\mathrm{H}^+]$ on the target scale $s$ and the same stoichiometric constants. A correct, consistent pairing will yield $I$ below a small numerical tolerance, while a mismatched pairing will produce an $I$ that is orders of magnitude larger due to the incorrect dependence of species on the effective $[\\mathrm{H}^+]$ in the mass-action formulas.\n\nImplementation constraints:\n- Use a Newton-based root finder for the hydrogen ion concentration $[\\mathrm{H}^+]$ on the chosen variable scale to solve the Total Alkalinity equation. Carefully derive and implement the derivative $\\mathrm{dTA}/\\mathrm{d}[\\mathrm{H}^+]$ required for Newton's method, accounting for the chain rule if the variable scale differs from the constants scale via a multiplicative factor. Ensure robust convergence by bounding updates.\n- Approximate total boron as $$B_T = \\beta S,$$ where $S$ is salinity and $\\beta = 1.1885714\\times 10^{-5}\\ \\mathrm{mol}\\,\\mathrm{kg}^{-1}$ per unit salinity, providing $B_T \\approx 4.16\\times 10^{-4}\\ \\mathrm{mol}\\,\\mathrm{kg}^{-1}$ at $S=35$.\n- Approximate total sulfate and total fluoride as $$T_{\\mathrm{SO4}} = 0.02824 \\frac{S}{35},\\quad T_{\\mathrm{F}} = 7.0\\times 10^{-5} \\frac{S}{35}$$ in $\\mathrm{mol}\\,\\mathrm{kg}^{-1}$, and use constant $K_{\\mathrm{HSO4}} = 0.10$ and $K_{\\mathrm{HF}} = 0.001$ to define the conversion factors between scales.\n- Use the following representative stoichiometric constants at $25^\\circ\\mathrm{C}$ for the carbonate and borate systems: $$K_1 = 10^{-6.00},\\quad K_2 = 10^{-9.13},\\quad K_B = 10^{-9.24},\\quad K_W = 10^{-13.60}.$$\n- Units: express $\\mathrm{DIC}$, $\\mathrm{TA}$, concentrations, and the inconsistency index $I$ in $\\mathrm{mol}\\,\\mathrm{kg}^{-1}$. Temperature should be provided in degrees Celsius, but all constants are fixed at $25^\\circ\\mathrm{C}$ within this problem.\n- Angles are not used in this problem.\n- Your program must produce a single line of output containing the inconsistency indices $I$ for all test cases as a comma-separated list enclosed in square brackets (e.g., \"[$0.0,0.0,0.0$]\").\n\nTest suite. Use the following four parameter sets that cover a general case, a clear mismatch, a low-salinity edge case, and a lower-alkalinity case. Each tuple is $(\\mathrm{DIC},\\ \\mathrm{TA},\\ S,\\ T,\\ \\text{variable scale},\\ \\text{consistency flag})$, where the consistency flag indicates whether the solver correctly applies the conversion factor between the variable $pH$ scale and the constants scale:\n- Case 1 (happy path, consistent at typical open-ocean conditions): $(2.05\\times 10^{-3},\\ 2.30\\times 10^{-3},\\ 35,\\ 25,\\ \\text{\"total\"},\\ \\text{True})$.\n- Case 2 (mismatched scales at typical conditions): $(2.05\\times 10^{-3},\\ 2.30\\times 10^{-3},\\ 35,\\ 25,\\ \\text{\"free\"},\\ \\text{False})$.\n- Case 3 (mismatched scales at low salinity): $(2.15\\times 10^{-3},\\ 2.25\\times 10^{-3},\\ 5,\\ 25,\\ \\text{\"free\"},\\ \\text{False})$.\n- Case 4 (consistent pairing at lower alkalinity): $(1.80\\times 10^{-3},\\ 2.00\\times 10^{-3},\\ 35,\\ 25,\\ \\text{\"free\"},\\ \\text{True})$.\n\nFinal output specification:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the same order as the test suite cases, where each result is the inconsistency index $I$ in $\\mathrm{mol}\\,\\mathrm{kg}^{-1}$ rounded by the default string representation of floating-point numbers.",
            "solution": "The problem requires the design of a diagnostic test to verify the consistency between the chosen $pH$ scale for the hydrogen ion concentration, $[\\mathrm{H}^+]$, and the scale upon which the stoichiometric equilibrium constants ($K_i$) are defined. This is a critical issue in computational oceanography, as a mismatch leads to physically incorrect speciation and violates fundamental charge-balance constraints. We will first establish the mathematical framework for the carbonate system, then derive the numerical solver, and finally construct the inconsistency index.\n\nThe fundamental principle is that while physical concentrations of chemical species are unique, the numerical values of $[\\mathrm{H}^+]$ and the equilibrium constants are interdependent and scale-dependent. The three relevant scales are the free ($F$), total ($T$), and seawater ($S$) scales, related by multiplicative factors derived from sulfate and fluoride equilibria:\n$$[\\mathrm{H}^+]_\\mathrm{T} = \\gamma_\\mathrm{T} [\\mathrm{H}^+]_\\mathrm{F} \\quad \\text{where} \\quad \\gamma_\\mathrm{T} = 1 + \\frac{T_{\\mathrm{SO4}}}{K_{\\mathrm{HSO4}}}$$\n$$[\\mathrm{H}^+]_\\mathrm{S} = \\gamma_\\mathrm{S} [\\mathrm{H}^+]_\\mathrm{F} \\quad \\text{where} \\quad \\gamma_\\mathrm{S} = 1 + \\frac{T_{\\mathrm{SO4}}}{K_{\\mathrm{HSO4}}} + \\frac{T_{\\mathrm{F}}}{K_{\\mathrm{HF}}}$$\nThe stoichiometric equilibrium constants provided ($K_1, K_2, K_B, K_W$) are assumed to be on the **Total scale**, a common convention. Therefore, any equilibrium expression must utilize $[\\mathrm{H}^+]$ on this same scale, i.e., $[\\mathrm{H}^+]_\\mathrm{T}$.\n\nThe core of the problem is to solve for the hydrogen ion concentration given Dissolved Inorganic Carbon ($\\mathrm{DIC}$) and Total Alkalinity ($\\mathrm{TA}$). The equation to be solved is derived from the definition of $\\mathrm{TA}$:\n$$\\mathrm{TA} = [\\mathrm{HCO}_3^-] + 2[\\mathrm{CO}_3^{2-}] + [\\mathrm{B(OH)}_4^-] + [\\mathrm{OH}^-] - [\\mathrm{H}^+]_\\mathrm{T}$$\nHere, the subtracted hydrogen ion term is explicitly on the Total scale, consistent with the definition of TA and the scale of the constants. Let us denote the sum of the species contributions to alkalinity as $A([\\mathrm{H}^+])$. Since the constants are on the Total scale, these species must be computed as functions of $[\\mathrm{H}^+]_\\mathrm{T}$:\n$$A([\\mathrm{H}^+]_\\mathrm{T}) = \\mathrm{DIC} \\frac{K_1 [\\mathrm{H}^+]_\\mathrm{T} + 2 K_1 K_2}{([\\mathrm{H}^+]_\\mathrm{T})^2 + K_1 [\\mathrm{H}^+]_\\mathrm{T} + K_1 K_2} + B_T \\frac{K_B}{K_B + [\\mathrm{H}^+]_\\mathrm{T}} + \\frac{K_W}{[\\mathrm{H}^+]_\\mathrm{T}}$$\nThe problem is to find the root of the residual function, $f([\\mathrm{H}^+]) = A([\\mathrm{H}^+]_\\mathrm{T}) - [\\mathrm{H}^+]_\\mathrm{T} - \\mathrm{TA}_{\\mathrm{input}} = 0$.\n\nThe solver, however, operates on a `variable scale`, denoted $V$, solving for $[\\mathrm{H}^+]_V$. A conversion factor, $C_{V \\to T}$, relates this variable to the Total scale: $[\\mathrm{H}^+]_\\mathrm{T} = C_{V \\to T} [\\mathrm{H}^+]_V$.\n- If $V$ is 'free', $C_{F \\to T} = \\gamma_\\mathrm{T}$.\n- If $V$ is 'total', $C_{T \\to T} = 1$.\n- If $V$ is 'seawater', $C_{S \\to T} = \\gamma_\\mathrm{T} / \\gamma_\\mathrm{S}$.\n\nA **consistent** solver correctly converts its working variable $[\\mathrm{H}^+]_V$ to the constants' scale, using $[\\mathrm{H}^+]_\\mathrm{T} = C_{V \\to T}[\\mathrm{H}^+]_V$ in the speciation calculations. An **inconsistent** solver erroneously uses $[\\mathrm{H}^+]_V$ directly, as if $C_{V \\to T}=1$. We model this with a factor $\\alpha$:\n- For a consistent solver (`True` flag): $\\alpha = C_{V \\to T}$.\n- For an inconsistent solver (`False` flag): $\\alpha = 1$.\n\nThe hydrogen concentration used in the equilibrium expressions is thus $H_{eq} = \\alpha [\\mathrm{H}^+]_V$. The residual function for the Newton-Raphson solver becomes:\n$$f([\\mathrm{H}^+]_V) = A(\\alpha [\\mathrm{H}^+]_V) - C_{V \\to T}[\\mathrm{H}^+]_V - \\mathrm{TA}_{\\mathrm{input}} = 0$$\nTo implement Newton's method, $x_{n+1} = x_n - f(x_n)/f'(x_n)$, we require the derivative with respect to the solver variable $[\\mathrm{H}^+]_V$. Using the chain rule:\n$$f'([\\mathrm{H}^+]_V) = \\frac{d}{d[\\mathrm{H}^+]_V} \\left( A(\\alpha [\\mathrm{H}^+]_V) - C_{V \\to T}[\\mathrm{H}^+]_V \\right) = \\alpha \\frac{dA}{dH}\\bigg|_{H=H_{eq}} - C_{V \\to T}$$\nThe derivative of the species alkalinity function, $A(H)$, is:\n$$\\frac{dA}{dH} = \\frac{d}{dH}(\\mathrm{CA} + \\mathrm{BA} + \\mathrm{WA}) = \\frac{d\\mathrm{CA}}{dH} + \\frac{d\\mathrm{BA}}{dH} + \\frac{d\\mathrm{WA}}{dH}$$\nwhere CA, BA, WA are the carbonate, borate, and water alkalinity components. The derivatives are:\n$$\\frac{d\\mathrm{WA}}{dH} = \\frac{d}{dH}\\left(\\frac{K_W}{H}\\right) = -\\frac{K_W}{H^2}$$\n$$\\frac{d\\mathrm{BA}}{dH} = \\frac{d}{dH}\\left(B_T \\frac{K_B}{K_B + H}\\right) = -B_T \\frac{K_B}{(K_B + H)^2}$$\n$$\\frac{d\\mathrm{CA}}{dH} = \\frac{d}{dH}\\left(\\mathrm{DIC} \\frac{K_1 H + 2 K_1 K_2}{H^2 + K_1 H + K_1 K_2}\\right) = -\\mathrm{DIC} \\frac{K_1(H^2 + 4K_2 H + K_1 K_2)}{(H^2 + K_1 H + K_1 K_2)^2}$$\nThe solver iteratively finds the root $[\\mathrm{H}^+]_V^*$ that satisfies $f([\\mathrm{H}^+]_V^*) = 0$.\n\nThe final step is to compute the cross-scale inconsistency index, $I$. The premise of the test is that a physically correct state of the system must satisfy the charge balance equation regardless of the chosen descriptive scale, provided the calculation is performed consistently. A consistent calculation of TA, given the Total scale constants, must use $[\\mathrm{H}^+]_\\mathrm{T}$ for both speciation and the final subtracted proton term. Let the solved variable be $[\\mathrm{H}^+]_V^*$. From this, we determine the corresponding concentration on the Total scale: $[\\mathrm{H}^+]_\\mathrm{T}^* = C_{V \\to T}[\\mathrm{H}^+]_V^*$.\nThe scale-invariant, consistently calculated TA value is then:\n$$\\mathrm{TA}_{\\text{check}} = A([\\mathrm{H}^+]_\\mathrm{T}^*) - [\\mathrm{H}^+]_\\mathrm{T}^*$$\nThe problem defines the index as $I = \\max_{s \\in \\{\\mathrm{F},\\mathrm{T},\\mathrm{S}\\}} \\left|\\mathrm{TA}_s - \\mathrm{TA}_{\\mathrm{input}}\\right|$, where $\\mathrm{TA}_s$ is recomputed on each scale. A consistent re-computation for any scale $s$ must map its $[\\mathrm{H}^+]_s^*$ back to the Total scale to use the given constants, which results in the same $\\mathrm{TA}_{\\text{check}}$ value. Thus, the index simplifies to:\n$$I = |\\mathrm{TA}_{\\text{check}} - \\mathrm{TA}_{\\mathrm{input}}|$$\n- If the original solver was **consistent**, then it solved for $A(C_{V \\to T}[\\mathrm{H}^+]_V^*) - C_{V \\to T}[\\mathrm{H}^+]_V^* = \\mathrm{TA}_{\\mathrm{input}}$. This is identical to $A([\\mathrm{H}^+]_\\mathrm{T}^*) - [\\mathrm{H}^+]_\\mathrm{T}^* = \\mathrm{TA}_{\\mathrm{input}}$. Therefore, $\\mathrm{TA}_{\\text{check}} \\approx \\mathrm{TA}_{\\mathrm{input}}$ and the index $I$ will be near zero (limited by solver tolerance).\n- If the original solver was **inconsistent**, it solved for $A([\\mathrm{H}^+]_V^*) - C_{V \\to T}[\\mathrm{H}^+]_V^* = \\mathrm{TA}_{\\mathrm{input}}$. The diagnostic test computes $A(C_{V \\to T}[\\mathrm{H}^+]_V^*) - C_{V \\to T}[\\mathrm{H}^+]_V^*$. Since $A$ is a nonlinear function and for a mismatch $C_{V \\to T} \\neq 1$, this value will not equal $\\mathrm{TA}_{\\mathrm{input}}$. The index $I$ will be significantly greater than zero, successfully detecting the mismatch.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for hydrogen ion concentration and computes a cross-scale\n    inconsistency index for oceanic carbonate chemistry.\n    \"\"\"\n    \n    # Stoichiometric constants at 25 degC, assumed on the Total pH scale\n    K1 = 10**(-6.00)\n    K2 = 10**(-9.13)\n    KB = 10**(-9.24)\n    KW = 10**(-13.60)\n    \n    # Constants for scale conversions and boron concentration\n    K_HSO4 = 0.10\n    K_HF = 0.001\n    BETA_BORON = 1.1885714e-5\n\n    test_cases = [\n        # (DIC, TA, S, T, variable_scale, consistency_flag)\n        (2.05e-3, 2.30e-3, 35.0, 25.0, \"total\", True),\n        (2.05e-3, 2.30e-3, 35.0, 25.0, \"free\", False),\n        (2.15e-3, 2.25e-3, 5.0, 25.0, \"free\", False),\n        (1.80e-3, 2.00e-3, 35.0, 25.0, \"free\", True),\n    ]\n\n    results = []\n\n    for dic, ta_input, s, t, var_scale, is_consistent in test_cases:\n        # Step 1: Set up scale conversion factors and case-specific parameters\n        t_so4 = 0.02824 * s / 35.0\n        t_f = 7.0e-5 * s / 35.0\n        bt = BETA_BORON * s\n\n        gamma_t = 1.0 + t_so4 / K_HSO4\n        gamma_s = 1.0 + t_so4 / K_HSO4 + t_f / K_HF\n\n        if var_scale == \"free\":\n            C_v_to_t = gamma_t\n        elif var_scale == \"total\":\n            C_v_to_t = 1.0\n        elif var_scale == \"seawater\":\n            C_v_to_t = gamma_t / gamma_s\n        else:\n            raise ValueError(f\"Unknown variable scale: {var_scale}\")\n            \n        if is_consistent:\n            alpha = C_v_to_t\n        else:\n            alpha = 1.0\n\n        # Step 2: Implement the Newton-Raphson solver for [H+]_V\n        \n        def calculate_residual_and_derivative(h_v):\n            h_eq = alpha * h_v\n\n            # Denominator for carbonate species calculations\n            denom_c = h_eq**2 + K1 * h_eq + K1 * K2\n            \n            # Alkalinity from carbonate, borate, and water species\n            ca = dic * (K1 * h_eq + 2.0 * K1 * K2) / denom_c\n            ba = bt * KB / (KB + h_eq)\n            wa = KW / h_eq\n            \n            alk_species = ca + ba + wa\n\n            # Residual function f([H+]_V) as per derivation\n            residual = alk_species - C_v_to_t * h_v - ta_input\n            \n            # Derivative of the residual function d(f)/d([H+]_V)\n            d_ca_d_h = -dic * K1 * (h_eq**2 + 4.0*K2*h_eq + K1*K2) / (denom_c**2)\n            d_ba_d_h = -bt * KB / (KB + h_eq)**2\n            d_wa_d_h = -KW / h_eq**2\n            d_alk_species_d_h = d_ca_d_h + d_ba_d_h + d_wa_d_h\n            \n            derivative = alpha * d_alk_species_d_h - C_v_to_t\n            \n            return residual, derivative\n\n        h_v = 1e-8  # Initial guess for [H+] on the variable scale\n        max_iter = 50\n        tolerance = 1e-15 # Use a tight tolerance for precision\n\n        for _ in range(max_iter):\n            residual, derivative = calculate_residual_and_derivative(h_v)\n            if abs(residual)  tolerance:\n                break\n            \n            delta_h = -residual / derivative\n            # Bound update step to 50% of current value to ensure robust convergence\n            h_v += np.clip(delta_h, -0.5 * h_v, 0.5 * h_v)\n\n        # Step 3: Compute the cross-scale inconsistency index\n        h_v_star = h_v\n        \n        # Convert the solved [H+] to the Total scale for the diagnostic check\n        h_t_star = C_v_to_t * h_v_star\n        \n        # Consistently re-calculate TA using [H+] on the total scale ([H+]_T)\n        denom_c_check = h_t_star**2 + K1 * h_t_star + K1 * K2\n        ca_check = dic * (K1 * h_t_star + 2.0 * K1 * K2) / denom_c_check\n        ba_check = bt * KB / (KB + h_t_star)\n        wa_check = KW / h_t_star\n        \n        ta_check = ca_check + ba_check + wa_check - h_t_star\n        \n        inconsistency_index = abs(ta_check - ta_input)\n        results.append(inconsistency_index)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}