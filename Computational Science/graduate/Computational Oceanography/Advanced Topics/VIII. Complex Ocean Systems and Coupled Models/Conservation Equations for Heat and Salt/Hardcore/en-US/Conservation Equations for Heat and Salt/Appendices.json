{
    "hands_on_practices": [
        {
            "introduction": "Before writing code, it is crucial to understand the principles that ensure a numerical model correctly conserves physical quantities like heat and salt. This exercise challenges you to analyze a common, but flawed, numerical implementation of the tracer transport equation. By applying fundamental principles, you will identify several ways in which seemingly correct discretizations can introduce artificial sources or sinks, violating the global conservation of the tracer .",
            "id": "3787795",
            "problem": "In a $3$-dimensional Boussinesq ocean model, consider a passive tracer $C$ representing potential temperature or salinity. The continuous non-conservative equation is written as $D_t C = \\kappa \\nabla^2 C$, where $D_t = \\partial_t + \\boldsymbol{u}\\cdot\\nabla$, $\\boldsymbol{u}$ is the velocity, and $\\kappa$ is a (possibly space- and time-dependent) diffusivity. The computational domain has impermeable boundaries (no normal flow) and homogeneous Neumann boundary conditions for diffusion (no diffusive flux). The model is discretized on a uniform Cartesian grid using a collocated scalar at cell centers and a staggered velocity (Arakawa C-grid), with second-order centered differences for advection in the non-conservative form $\\boldsymbol{u}\\cdot\\nabla C$, and a direct Laplacian $\\kappa \\nabla^2 C$ for diffusion. The free surface evolves in time, so the layer thickness $h(i,j,k,t)$ can change; however, the implementer does not multiply the equation by $h$ prior to discretization. The velocity field satisfies $\\nabla\\cdot\\boldsymbol{u} = 0$ in the continuous equations, but the discrete solver yields a small, nonzero discrete divergence. The diffusivity $\\kappa$ may be spatially varying, for example due to K-Profile Parameterization (KPP).\n\nUsing only fundamental transport principles such as the Reynolds transport theorem and the divergence theorem, reason about the discrete global conservation of $C$ under the described non-conservative discretization. Which of the following statements correctly identify consequences and sources of non-conservation errors? Select all that apply.\n\nA. If the discrete velocity field has nonzero discrete divergence, the centered non-conservative advection $\\boldsymbol{u}\\cdot\\nabla C$ introduces a domain-integrated source proportional to the discrete sum of $C$ times the discrete divergence, so the global sum of $C$ is not conserved even with impermeable and no-flux boundaries.\n\nB. Writing and discretizing the equation in flux form, $\\partial_t C + \\nabla\\cdot(\\boldsymbol{u} C) = \\nabla\\cdot(\\kappa \\nabla C)$, with a finite-volume method that computes a single face flux per face and applies impermeable and no-flux boundary conditions, guarantees exact conservation of the cell-volume-weighted sum of $C$ to machine precision, independent of the discrete divergence of $\\boldsymbol{u}$.\n\nC. Using $\\kappa \\nabla^2 C$ with spatially varying $\\kappa$ is equivalent to $\\nabla\\cdot(\\kappa \\nabla C)$, so it cannot introduce non-conservative source terms in the domain-integrated tracer.\n\nD. In layers of time-varying thickness $h(i,j,k,t)$, discretizing $D_t C$ without first multiplying by $h$ introduces spurious sources or sinks of the volume-integrated tracer proportional to $\\partial_t h$, even if $\\nabla\\cdot\\boldsymbol{u} = 0$ in the continuous sense and boundary fluxes vanish.\n\nE. Upwind advection discretized in flux form can change the global integral of $C$ under impermeable and no-flux boundary conditions because its numerical diffusion acts as an internal source or sink of $C$.\n\nF. If $\\kappa$ varies in space, discretizing diffusion as $\\kappa \\nabla^2 C$ rather than as the divergence of the diffusive flux $\\nabla\\cdot(\\kappa \\nabla C)$ produces an internal source term proportional to $\\nabla \\kappa \\cdot \\nabla C$, which alters the global sum of $C$ even with no-flux boundaries.",
            "solution": "The problem statement is critically validated before proceeding to a solution.\n\n### Step 1: Extract Givens\n- **Model and Physics**: $3$-dimensional Boussinesq ocean model.\n- **Tracer**: Passive tracer $C$ (potential temperature or salinity).\n- **Governing Equation (Continuous)**: $D_t C = \\kappa \\nabla^2 C$, where the material derivative is $D_t = \\partial_t + \\boldsymbol{u}\\cdot\\nabla$.\n- **Variables and Parameters**: $\\boldsymbol{u}$ is the velocity vector. $\\kappa$ is the diffusivity, which may be dependent on space and time.\n- **Domain and Boundary Conditions**: The computational domain has impermeable boundaries, meaning no normal flow ($\\boldsymbol{u} \\cdot \\boldsymbol{n} = 0$ at the boundary). For diffusion, homogeneous Neumann boundary conditions are applied, meaning no diffusive flux across the boundary ($(\\kappa \\nabla C) \\cdot \\boldsymbol{n} = 0$).\n- **Discretization Details**:\n    - **Grid**: Uniform Cartesian grid with a collocated scalar $C$ at cell centers and a staggered velocity $\\boldsymbol{u}$ (Arakawa C-grid).\n    - **Advection Term**: The non-conservative form $\\boldsymbol{u}\\cdot\\nabla C$ is discretized using second-order centered differences.\n    - **Diffusion Term**: Discretized as a direct Laplacian, $\\kappa \\nabla^2 C$.\n- **Additional Conditions**:\n    - The free surface evolves, causing layer thicknesses $h(i,j,k,t)$ to change. The governing equation is not multiplied by $h$ before discretization.\n    - The continuous velocity field is divergence-free, $\\nabla\\cdot\\boldsymbol{u} = 0$.\n    - The discrete velocity field from the solver has a small, non-zero discrete divergence.\n    - The diffusivity $\\kappa$ can be spatially varying.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: Yes. The problem statement is firmly rooted in the principles of computational fluid dynamics and oceanography. It describes common, standard numerical methods (Arakawa C-grid, centered differences), physical approximations (Boussinesq), and well-known challenges (discretely non-divergence-free flow, conservation on time-varying grids, choice of conservative vs. non-conservative forms).\n- **Well-Posed**: Yes. The question asks for an analysis of the conservation properties of a specifically described numerical scheme. The details provided are sufficient to perform this analysis based on fundamental principles.\n- **Objective**: Yes. The language is technical, precise, and devoid of subjective or ambiguous terminology.\n- **Flaw Checklist**: The problem statement does not violate any of the invalidity criteria. It is scientifically sound, formalizable, complete, realistic, and well-posed. The distinction between continuous properties (e.g., $\\nabla\\cdot\\boldsymbol{u} = 0$) and their discrete counterparts is a key feature of the problem, not a contradiction.\n\n### Step 3: Verdict and Action\nThe problem statement is **valid**. A solution will be derived.\n\n### Principle-Based Derivation\n\nThe global conservation of a tracer $C$ refers to the time rate of change of the total amount of the tracer in the entire domain volume $V$. The total amount is $\\int_V C \\, dV$. Its conservation is governed by the Reynolds transport theorem, which states that for a fixed domain $V$ with boundary $S$:\n$$ \\frac{d}{dt} \\int_V C \\, dV = \\int_V \\frac{\\partial C}{\\partial t} \\, dV $$\nSubstituting the given continuous equation, $\\partial_t C = -\\boldsymbol{u}\\cdot\\nabla C + \\kappa \\nabla^2 C$, we get:\n$$ \\frac{d}{dt} \\int_V C \\, dV = \\int_V (-\\boldsymbol{u}\\cdot\\nabla C + \\kappa \\nabla^2 C) \\, dV $$\nFor the total amount of $C$ to be conserved, the right-hand side integral must equal the net flux through the boundaries. If boundary fluxes are zero, this integral must be zero. We analyze the discrete counterpart of each term.\n\nThe analysis of each option is as follows:\n\n**A. If the discrete velocity field has nonzero discrete divergence, the centered non-conservative advection $\\boldsymbol{u}\\cdot\\nabla C$ introduces a domain-integrated source proportional to the discrete sum of $C$ times the discrete divergence, so the global sum of $C$ is not conserved even with impermeable and no-flux boundaries.**\n\nLet's analyze the volume integral of the advection term, $\\int_V \\boldsymbol{u}\\cdot\\nabla C \\, dV$. Using the vector identity $\\nabla \\cdot (C\\boldsymbol{u}) = (\\nabla \\cdot \\boldsymbol{u})C + \\boldsymbol{u} \\cdot \\nabla C$, we can rewrite the term as:\n$$ \\boldsymbol{u}\\cdot\\nabla C = \\nabla \\cdot (C\\boldsymbol{u}) - C(\\nabla \\cdot \\boldsymbol{u}) $$\nIntegrating over the domain volume $V$:\n$$ \\int_V \\boldsymbol{u}\\cdot\\nabla C \\, dV = \\int_V \\nabla \\cdot (C\\boldsymbol{u}) \\, dV - \\int_V C(\\nabla \\cdot \\boldsymbol{u}) \\, dV $$\nBy the divergence theorem, the first term on the right becomes a boundary flux: $\\int_V \\nabla \\cdot (C\\boldsymbol{u}) \\, dV = \\oint_S C(\\boldsymbol{u} \\cdot \\boldsymbol{n}) \\, dS$. With impermeable boundaries, $\\boldsymbol{u} \\cdot \\boldsymbol{n} = 0$, so this surface integral is zero. Thus, the volume integral of the advection term becomes:\n$$ \\int_V \\boldsymbol{u}\\cdot\\nabla C \\, dV = - \\int_V C(\\nabla \\cdot \\boldsymbol{u}) \\, dV $$\nIn the continuous case, the problem states $\\nabla \\cdot \\boldsymbol{u} = 0$, so this term is zero. However, the problem states that the *discrete* velocity field has a non-zero discrete divergence, let's call it $(\\nabla_d \\cdot \\boldsymbol{u})$. When the non-conservative advection term is discretized and summed over all grid cells (the discrete analog of integration), the discrete version of the summation-by-parts identity holds. The sum of the discretized advection term over the domain volume becomes:\n$$ \\sum_{i,j,k} (\\boldsymbol{u}\\cdot\\nabla C)_{d} V_{cell} = - \\sum_{i,j,k} C (\\nabla_d \\cdot \\boldsymbol{u}) V_{cell} $$\nSince $(\\nabla_d \\cdot \\boldsymbol{u})$ is non-zero, this term acts as a spurious source or sink proportional to $C$ times the discrete divergence. Therefore, the global sum of $C$ is not conserved.\n\n**Verdict: Correct.**\n\n**B. Writing and discretizing the equation in flux form, $\\partial_t C + \\nabla\\cdot(\\boldsymbol{u} C) = \\nabla\\cdot(\\kappa \\nabla C)$, with a finite-volume method that computes a single face flux per face and applies impermeable and no-flux boundary conditions, guarantees exact conservation of the cell-volume-weighted sum of $C$ to machine precision, independent of the discrete divergence of $\\boldsymbol{u}$.**\n\nIn flux form (or conservative form), the equation is $\\partial_t C = -\\nabla \\cdot \\boldsymbol{F}$, where the total flux is $\\boldsymbol{F} = \\boldsymbol{u}C - \\kappa\\nabla C$. A finite-volume discretization of this for a cell $i$ is:\n$$ \\frac{d(C_i V_i)}{dt} = -\\sum_{f \\in \\text{faces}(i)} \\boldsymbol{F}_f \\cdot \\boldsymbol{A}_f $$\nwhere $V_i$ is the cell volume, $\\boldsymbol{F}_f$ is the flux at face $f$, and $\\boldsymbol{A}_f$ is the area vector of face $f$. When we sum this equation over all cells $i$ in the domain:\n$$ \\frac{d}{dt} \\sum_i C_i V_i = -\\sum_i \\sum_{f \\in \\text{faces}(i)} \\boldsymbol{F}_f \\cdot \\boldsymbol A_f $$\nFor any interior face shared between cell $i$ and cell $j$, the flux leaving $i$ is the flux entering $j$. Since the method computes a single, unique flux for each face, the contributions from all interior faces cancel out in the global sum. The sum reduces to only the fluxes through the external boundary faces. The problem specifies impermeable and no-flux boundary conditions, which means these boundary fluxes are zero. Therefore, $\\frac{d}{dt} \\sum_i C_i V_i = 0$. This property holds regardless of how $\\boldsymbol{F}$ is constructed, so it is independent of the discrete divergence of $\\boldsymbol{u}$. This statement correctly describes the property of a flux-form finite-volume discretization.\n\n**Verdict: Correct.**\n\n**C. Using $\\kappa \\nabla^2 C$ with spatially varying $\\kappa$ is equivalent to $\\nabla\\cdot(\\kappa \\nabla C)$, so it cannot introduce non-conservative source terms in the domain-integrated tracer.**\n\nThis statement is based on a false premise. The diffusive flux is $\\boldsymbol{F}_{diff} = -\\kappa \\nabla C$. The divergence of this flux, which represents the physically conservative form of diffusion, is $\\nabla \\cdot (\\kappa \\nabla C)$. Using the product rule for divergence, this expands to:\n$$ \\nabla \\cdot (\\kappa \\nabla C) = (\\nabla \\kappa) \\cdot (\\nabla C) + \\kappa (\\nabla \\cdot \\nabla C) = \\nabla \\kappa \\cdot \\nabla C + \\kappa \\nabla^2 C $$\nClearly, $\\kappa \\nabla^2 C$ is not equivalent to $\\nabla \\cdot (\\kappa \\nabla C)$ when $\\kappa$ is spatially varying (i.e., $\\nabla \\kappa \\neq 0$). Their difference is $\\nabla \\kappa \\cdot \\nabla C$. Since the premise is false, the conclusion is unfounded. As shown in the analysis for option F, using $\\kappa \\nabla^2 C$ does introduce a non-conservative source term.\n\n**Verdict: Incorrect.**\n\n**D. In layers of time-varying thickness $h(i,j,k,t)$, discretizing $D_t C$ without first multiplying by $h$ introduces spurious sources or sinks of the volume-integrated tracer proportional to $\\partial_t h$, even if $\\nabla\\cdot\\boldsymbol{u} = 0$ in the continuous sense and boundary fluxes vanish.**\n\nThe conserved quantity in a grid cell is not the concentration $C$ itself, but the total amount, which is $C V_{cell}$. In a grid where horizontal dimensions $\\Delta x$ and $\\Delta y$ are fixed, the cell volume is $V_{cell} = h \\Delta x \\Delta y$, where $h$ is the layer thickness. The conserved quantity is thus proportional to $hC$. The time-rate-of-change of this quantity is:\n$$ \\frac{\\partial (hC)}{\\partial t} = h \\frac{\\partial C}{\\partial t} + C \\frac{\\partial h}{\\partial t} $$\nThe model discretizes an equation for $\\partial_t C$ (or $D_t C$), not for $\\partial_t(hC)$. When the model updates $C$ based on its calculated tendency, it is implicitly solving for $h (\\partial_t C)$. The total change in the conserved quantity, however, must account for the $C(\\partial_t h)$ term. By discretizing the equation for $C$ directly, the scheme fails to account for the change in the total tracer amount due to the volume of the cell changing. This missing term, $C(\\partial_t h)$, acts as a spurious source or sink of the globally integrated tracer.\n\n**Verdict: Correct.**\n\n**E. Upwind advection discretized in flux form can change the global integral of $C$ under impermeable and no-flux boundary conditions because its numerical diffusion acts as an internal source or sink of $C$.**\n\nThis statement is incorrect. As established in the analysis of option B, any advection scheme, including upwind, that is written in flux form (i.e., as the divergence of a flux, with a single flux computed per face) will conserve the global integral of the tracer to machine precision, provided the boundary fluxes are zero. The cancellation of internal fluxes is a structural property of the finite-volume method in flux form. While upwind schemes do introduce numerical diffusion, this diffusion redistributes the tracer within the domain, it does not create or destroy the tracer globally. A source or sink of the global integral is not a property of numerical diffusion in a properly formulated conservative scheme.\n\n**Verdict: Incorrect.**\n\n**F. If $\\kappa$ varies in space, discretizing diffusion as $\\kappa \\nabla^2 C$ rather than as the divergence of the diffusive flux $\\nabla\\cdot(\\kappa \\nabla C)$ produces an internal source term proportional to $\\nabla \\kappa \\cdot \\nabla C$, which alters the global sum of $C$ even with no-flux boundaries.**\n\nAs shown in the analysis for option C, the physically conservative diffusion term is $\\nabla\\cdot(\\kappa \\nabla C)$. The discretized term is $\\kappa \\nabla^2 C$. The difference is:\n$$ \\kappa \\nabla^2 C - \\nabla \\cdot (\\kappa \\nabla C) = - \\nabla \\kappa \\cdot \\nabla C $$\nThe equation being solved is effectively $\\partial_t C + \\dots = \\text{conservative diffusion} - \\nabla \\kappa \\cdot \\nabla C$. Integrating over the domain volume:\n$$ \\frac{d}{dt} \\int_V C \\, dV = \\dots + \\int_V \\nabla \\cdot (\\kappa \\nabla C) \\, dV - \\int_V (\\nabla \\kappa \\cdot \\nabla C) \\, dV $$\nThe term $\\int_V \\nabla \\cdot (\\kappa \\nabla C) \\, dV = \\oint_S (\\kappa \\nabla C) \\cdot \\boldsymbol{n} \\, dS$, which is the net diffusive flux across the boundary. The no-flux boundary condition sets this to zero. However, the term $-\\int_V (\\nabla \\kappa \\cdot \\nabla C) \\, dV$ remains. This is an artificial, internal source/sink term that is not guaranteed to be zero. This term is proportional to $\\nabla \\kappa \\cdot \\nabla C$ and directly alters the global sum of $C$.\n\n**Verdict: Correct.**",
            "answer": "$$\\boxed{ABDF}$$"
        },
        {
            "introduction": "Having explored the pitfalls of non-conservative schemes, this practice guides you through the process of building a model that is conservative by construction. You will derive a one-dimensional finite volume method from the integral form of the conservation law and implement it in code. This hands-on exercise demonstrates how the careful treatment of fluxes at cell boundaries leads to a scheme that exactly conserves the total amount of a tracer in a closed system, a cornerstone of reliable ocean modeling .",
            "id": "3787752",
            "problem": "You are tasked with designing and implementing a one-dimensional finite volume method (Finite Volume Method (FVM)) for the tracer conservation equation used in computational oceanography to evolve both heat and salt as passive tracers with advection and diffusion, in the absence of sources and sinks. Your design must guarantee discrete conservation of domain-integrated tracer content for each tracer separately when layer thickness, density, and material properties are spatially uniform and boundary conditions are periodic. You must start from fundamental conservation principles and derive a control-volume update that is conservative by construction, and then implement it in code.\n\nBegin from the fundamental conservation law for a generic tracer concentration field, expressed in flux form over a control volume. Consider a one-dimensional, periodic domain of length $L$ partitioned into $N$ uniform control volumes (cells) of width $\\Delta x = L/N$, with cell-averaged tracer values $C_i(t)$ located at cell centers $x_i$. Assume spatially uniform and constant layer thickness and density so that conservation of the cell-integrated tracer is equivalent to conservation of heat and salt content up to a constant factor. Assume no sources and no sinks. Let the advective velocity $u$ be constant in space and time and the molecular or subgrid diffusivity $K$ be constant in space and time. Let the advective flux be $u C$ and the diffusive flux be $-K \\partial C / \\partial x$.\n\nYour tasks are:\n\n1) Derive, from first principles and by integrating the flux-form conservation law over a single control volume bounded by $x_{i-1/2}$ and $x_{i+1/2}$, a discrete-in-time and discrete-in-space update for $C_i$ in terms of the net flux difference across its faces, with an explicit time step $\\Delta t$. Your derivation must clearly identify how the face fluxes contribute to the cell update and why this telescoping form guarantees discrete conservation of the domain-integrated tracer for periodic boundaries, in the absence of sources and sinks. You must derive the finite volume update without invoking any pre-packaged discretization formulas.\n\n2) Specify consistent, local-in-space definitions of the face fluxes that, when used in the finite volume update, guarantee conservation. For advection, choose an upwind flux that depends on the sign of $u$. For diffusion, choose a centered difference approximation for the face gradient. State any necessary stability conditions on $\\Delta t$ in terms of the Courant–Friedrichs–Lewy condition for the advective term and the explicit diffusion limit, as functions of $u$, $K$, and $\\Delta x$.\n\n3) Implement your discretization to evolve two tracers simultaneously: temperature $T$ (heat proxy) and salinity $S$ (salt), with distinct initial conditions. Use periodic boundary conditions. For each test case below, evolve from $t=0$ to $t=T_{\\text{end}}$ using an explicit forward Euler method with constant time step $\\Delta t$. For each tracer independently, compute the initial domain-integrated content $M_0 = \\sum_{i=0}^{N-1} C_i(0)\\,\\Delta x$ and the final content $M_1 = \\sum_{i=0}^{N-1} C_i(T_{\\text{end}})\\,\\Delta x$, and then compute the absolute relative change $E = \\lvert M_1 - M_0 \\rvert / \\lvert M_0 \\rvert$. For each test case, report the maximum of the absolute relative changes across the two tracers, i.e., $E_{\\max} = \\max\\{E_T,E_S\\}$.\n\nInitial conditions, grid, and parameters must be set as follows:\n- Spatial grid: $x_i = (i+0.5)\\Delta x$, with $i \\in \\{0,1,\\dots,N-1\\}$ and $\\Delta x = L/N$.\n- Temperature initial condition: $T(x) = 10 + \\cos\\left(2\\pi x/L\\right)$, where $10$ and $\\pi$ are the standard constants; temperature is in degrees Celsius, but since only relative conservation is tested, the reported metrics are dimensionless.\n- Salinity initial condition: $S(x) = 35 + 0.2 \\sin\\left(2\\pi x/L\\right) + 0.1 \\exp\\left(-\\frac{(x-0.3 L)^2}{2\\sigma^2}\\right)$ with $\\sigma = 0.05 L$. Salinity is taken as Practical Salinity Unit (dimensionless), and the reported metrics are dimensionless.\n\nNumerical units and reporting:\n- Length must be in meters, time in seconds, velocity in meters per second, and diffusivity in square meters per second.\n- The reported final answers for the test cases must be dimensionless decimal numbers representing $E_{\\max}$ for each case.\n\nTest suite:\nProvide results for the following parameter sets, each expressed in the units above.\n- Case $1$ (advection only): $N=200$, $L=1000$, $u=0.5$, $K=0$, $\\Delta t=4.0$, $T_{\\text{end}}=1000.0$.\n- Case $2$ (diffusion only): $N=200$, $L=1000$, $u=0.0$, $K=10^{-2}$, $\\Delta t=1000.0$, $T_{\\text{end}}=10000.0$.\n- Case $3$ (advection–diffusion): $N=400$, $L=2000$, $u=0.2$, $K=2\\times 10^{-3}$, $\\Delta t=8.0$, $T_{\\text{end}}=1600.0$.\n- Case $4$ (no transport): $N=128$, $L=500$, $u=0.0$, $K=0.0$, $\\Delta t=1.0$, $T_{\\text{end}}=100.0$.\n- Case $5$ (near-Courant limit): $N=100$, $L=100$, $u=1.0$, $K=10^{-5}$, $\\Delta t=0.9$, $T_{\\text{end}}=90.0$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the cases above. Each entry must be the decimal value of $E_{\\max}$ for that case (dimensionless). For example: \"[e1,e2,e3,e4,e5]\".",
            "solution": "The user has provided a valid, well-posed problem that is scientifically grounded in computational fluid dynamics. The task is to derive and implement a conservative one-dimensional finite volume method for the advection-diffusion of passive tracers. The problem is self-contained and all parameters are clearly specified. The validation checks pass, and a solution will be provided.\n\n### 1. Derivation of the Conservative Finite Volume Method\n\nThe fundamental principle is the conservation of a tracer quantity $C(x,t)$ within a given volume. In one dimension and in the absence of sources or sinks, the conservation law is expressed in differential flux form as:\n$$\n\\frac{\\partial C}{\\partial t} + \\frac{\\partial F}{\\partial x} = 0\n$$\nwhere $F(x,t)$ is the total flux of the tracer. For a passive tracer subject to advection with velocity $u$ and Fickian diffusion with diffusivity $K$, the flux is given by:\n$$\nF = uC - K \\frac{\\partial C}{\\partial x}\n$$\nHere, $u$ and $K$ are assumed to be constant in space and time.\n\nTo derive a numerical scheme that is conservative by construction, we use the Finite Volume Method (FVM). We partition the one-dimensional domain of length $L$ into $N$ uniform control volumes (cells), indexed by $i \\in \\{0, 1, \\dots, N-1\\}$. Each cell $i$ has a width of $\\Delta x = L/N$ and extends over the spatial interval $[x_{i-1/2}, x_{i+1/2}]$, with its center at $x_i = (i+0.5)\\Delta x$.\n\nWe integrate the conservation law over the $i$-th control volume:\n$$\n\\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial C}{\\partial t} \\,dx + \\int_{x_{i-1/2}}^{x_{i+1/2}} \\frac{\\partial F}{\\partial x} \\,dx = 0\n$$\nAssuming the necessary smoothness to interchange the order of operations, and applying the Fundamental Theorem of Calculus to the flux term, we get:\n$$\n\\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} C(x,t) \\,dx + \\left[ F(x,t) \\right]_{x_{i-1/2}}^{x_{i+1/2}} = 0\n$$\n$$\n\\frac{d}{dt} \\int_{x_{i-1/2}}^{x_{i+1/2}} C(x,t) \\,dx + F(x_{i+1/2}, t) - F(x_{i-1/2}, t) = 0\n$$\nThis equation is an exact statement: the rate of change of the total amount of tracer within the control volume is precisely balanced by the difference between the flux entering and the flux exiting the volume.\n\nWe now introduce the cell-averaged concentration, $C_i(t)$, defined as:\n$$\nC_i(t) = \\frac{1}{\\Delta x} \\int_{x_{i-1/2}}^{x_{i+1/2}} C(x,t) \\,dx\n$$\nSince $\\Delta x$ is constant, the integral form becomes an ordinary differential equation for the cell average:\n$$\n\\Delta x \\frac{dC_i}{dt} = F_{i-1/2} - F_{i+1/2}\n$$\nwhere $F_{i \\pm 1/2}$ denotes the flux evaluated at the respective cell face.\n\nTo obtain a fully discrete scheme, we discretize time using an explicit forward Euler method with time step $\\Delta t$. Letting $C_i^n$ be the approximation of $C_i(t)$ at time $t = n\\Delta t$, the time derivative is approximated as $(C_i^{n+1} - C_i^n)/\\Delta t$. This yields the update rule:\n$$\n\\frac{C_i^{n+1} - C_i^n}{\\Delta t} = \\frac{1}{\\Delta x} (F_{i-1/2}^n - F_{i+1/2}^n)\n$$\n$$\nC_i^{n+1} = C_i^n + \\frac{\\Delta t}{\\Delta x} (F_{i-1/2}^n - F_{i+1/2}^n)\n$$\nThe fluxes $F^n$ are computed using values from time level $n$.\n\nThis formulation inherently guarantees discrete conservation of the total tracer content over the domain for periodic boundary conditions. To prove this, we sum the total content, $M^{n+1} = \\sum_{i=0}^{N-1} C_i^{n+1} \\Delta x$, over all cells:\n$$\nM^{n+1} = \\sum_{i=0}^{N-1} \\left(C_i^n \\Delta x + \\Delta t (F_{i-1/2}^n - F_{i+1/2}^n)\\right) = \\left(\\sum_{i=0}^{N-1} C_i^n \\Delta x\\right) + \\Delta t \\sum_{i=0}^{N-1} (F_{i-1/2}^n - F_{i+1/2}^n)\n$$\nThe sum of flux differences forms a telescoping series:\n$$\n\\sum_{i=0}^{N-1} (F_{i-1/2}^n - F_{i+1/2}^n) = (F_{-1/2}^n - F_{1/2}^n) + (F_{1/2}^n - F_{3/2}^n) + \\dots + (F_{N-3/2}^n - F_{N-1/2}^n) = F_{-1/2}^n - F_{N-1/2}^n\n$$\nIn a periodic domain, the left boundary of cell $0$ is contiguous with the right boundary of cell $N-1$. Thus, $x_{-1/2}$ is equivalent to $x_{N-1/2}$, and the fluxes must be equal: $F_{-1/2}^n = F_{N-1/2}^n$. This makes the net flux across the domain boundaries zero. Therefore:\n$$\nM^{n+1} = M^n + \\Delta t \\cdot 0 \\implies M^{n+1} = M^n\n$$\nThe total tracer content is exactly conserved at each time step, limited only by machine floating-point precision in an actual computation.\n\n### 2. Numerical Flux Definitions and Stability Conditions\n\nThe scheme is completed by specifying the numerical approximations for the advective and diffusive fluxes at the cell faces.\n\n**Advective Flux ($F_a$):** A first-order upwind scheme is chosen for its stability. The tracer concentration at a face is taken from the \"upwind\" cell, determined by the sign of the velocity $u$. At face $x_{i+1/2}$ between cells $i$ and $i+1$:\n- If $u  0$ (flow is from left to right), the upwind cell is $i$: $F_{a, i+1/2}^n = u C_i^n$.\n- If $u  0$ (flow is from right to left), the upwind cell is $i+1$: $F_{a, i+1/2}^n = u C_{i+1}^n$.\nThis can be concisely written as:\n$$\nF_{a, i+1/2}^n = \\max(u, 0) C_i^n + \\min(u, 0) C_{i+1}^n\n$$\n\n**Diffusive Flux ($F_d$):** A second-order centered difference is used to approximate the gradient at the face $x_{i+1/2}$:\n$$\n\\left. \\frac{\\partial C}{\\partial x} \\right|_{i+1/2}^n \\approx \\frac{C_{i+1}^n - C_i^n}{\\Delta x}\n$$\nThe diffusive flux is then:\n$$\nF_{d, i+1/2}^n = -K \\frac{C_{i+1}^n - C_i^n}{\\Delta x}\n$$\n\nThe total numerical flux at face $i+1/2$ is the sum $F_{i+1/2}^n = F_{a, i+1/2}^n + F_{d, i+1/2}^n$.\n\n**Stability Conditions:** The use of an explicit forward Euler time-stepping scheme imposes stability constraints on the time step $\\Delta t$:\n1.  **Courant–Friedrichs–Lewy (CFL) Condition for Advection:** The Courant number $c$ must be no greater than $1$.\n    $$\n    c = \\frac{|u| \\Delta t}{\\Delta x} \\le 1\n    $$\n2.  **Stability Condition for Diffusion:** The diffusion number $d$ must be no greater than $1$.\n    $$\n    d = \\frac{2K \\Delta t}{(\\Delta x)^2} \\le 1\n    $$\nFor the simulation to be stable, $\\Delta t$ must be chosen to satisfy both conditions simultaneously. The parameters for all specified test cases have been chosen to meet these criteria.\n\n### 3. Implementation and Analysis\n\nThe derived scheme is implemented to evolve two tracer fields, temperature $T$ and salinity $S$, simultaneously but independently. For each test case, the model is initialized with the specified conditions and run until $t=T_{\\text{end}}$. The initial domain-integrated content $M_0 = \\sum_{i=0}^{N-1} C_i(0)\\Delta x$ and final content $M_1 = \\sum_{i=0}^{N-1} C_i(T_{\\text{end}})\\Delta x$ are computed for both $T$ and $S$. The absolute relative change, $E = |M_1 - M_0|/|M_0|$, is calculated for each tracer. The final result for each case is the maximum of these two values, $E_{\\max} = \\max\\{E_T, E_S\\}$, which quantifies the numerical conservation error due to floating-point arithmetic.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_simulation(N, L, u, K, dt, T_end):\n    \"\"\"\n    Solves the 1D advection-diffusion equation for two tracers (T, S)\n    using a conservative finite volume method.\n\n    Args:\n        N (int): Number of grid cells.\n        L (float): Domain length (m).\n        u (float): Advection velocity (m/s).\n        K (float): Diffusivity (m^2/s).\n        dt (float): Time step (s).\n        T_end (float): Total simulation time (s).\n\n    Returns:\n        float: The maximum absolute relative change in total tracer content.\n    \"\"\"\n    # 1. Grid and parameter setup\n    dx = L / N\n    x = (np.arange(N) + 0.5) * dx\n    n_steps = int(round(T_end / dt))\n\n    # 2. Initial Conditions\n    # Temperature\n    T = 10.0 + np.cos(2.0 * np.pi * x / L)\n    \n    # Salinity\n    sigma = 0.05 * L\n    S = 35.0 + 0.2 * np.sin(2.0 * np.pi * x / L) + \\\n        0.1 * np.exp(-((x - 0.3 * L)**2) / (2.0 * sigma**2))\n\n    # 3. Calculate initial total content for each tracer\n    # The total content is sum(C_i) * dx. dx is a constant factor that\n    # cancels in the relative error calculation, so we can use sum(C_i).\n    M0_T = np.sum(T)\n    M0_S = np.sum(S)\n\n    # Pre-calculate factors for efficiency\n    u_pos = max(u, 0)\n    u_neg = min(u, 0)\n    adv_diff_factor = dt / dx\n    diff_factor = K / dx\n\n    # 4. Time-stepping loop\n    for _ in range(n_steps):\n        # --- Update Temperature (T) ---\n        # Get values from neighboring cells using periodic boundaries\n        T_right = np.roll(T, -1)  # T_{i+1}\n        \n        # Calculate advective flux at the right face of each cell (i+1/2)\n        flux_adv_T = u_pos * T + u_neg * T_right\n        \n        # Calculate diffusive flux at the right face of each cell (i+1/2)\n        flux_diff_T = -diff_factor * (T_right - T)\n        \n        # Total flux at the right face (i+1/2)\n        flux_total_T = flux_adv_T + flux_diff_T\n        \n        # Flux at the left face (i-1/2), which is the right face of cell i-1\n        flux_in_T = np.roll(flux_total_T, 1) # flux_{i-1/2}\n\n        # Update cell average using the conservative FVM formula\n        T += adv_diff_factor * (flux_in_T - flux_total_T)\n\n        # --- Update Salinity (S) ---\n        # Get values from neighboring cells\n        S_right = np.roll(S, -1) # S_{i+1}\n        \n        # Calculate advective and diffusive fluxes\n        flux_adv_S = u_pos * S + u_neg * S_right\n        flux_diff_S = -diff_factor * (S_right - S)\n        \n        # Total flux at the right face (i+1/2)\n        flux_total_S = flux_adv_S + flux_diff_S\n        \n        # Flux at the left face (i-1/2)\n        flux_in_S = np.roll(flux_total_S, 1) # flux_{i-1/2}\n        \n        # Update cell average\n        S += adv_diff_factor * (flux_in_S - flux_total_S)\n\n    # 5. Calculate final total content and relative change\n    M1_T = np.sum(T)\n    M1_S = np.sum(S)\n\n    # Avoid division by zero, though ICs make M0 non-zero here.\n    E_T = np.abs((M1_T - M0_T) / M0_T) if M0_T != 0 else 0.0\n    E_S = np.abs((M1_S - M0_S) / M0_S) if M0_S != 0 else 0.0\n\n    return max(E_T, E_S)\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Each tuple is (N, L, u, K, dt, T_end)\n    test_cases = [\n        (200, 1000.0, 0.5, 0.0, 4.0, 1000.0),            # Case 1\n        (200, 1000.0, 0.0, 1e-2, 1000.0, 10000.0),       # Case 2\n        (400, 2000.0, 0.2, 2e-3, 8.0, 1600.0),           # Case 3\n        (128, 500.0, 0.0, 0.0, 1.0, 100.0),             # Case 4\n        (100, 100.0, 1.0, 1e-5, 0.9, 90.0),              # Case 5\n    ]\n\n    results = []\n    for params in test_cases:\n        E_max = run_simulation(*params)\n        results.append(E_max)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Accurate conservation is not just about the numerical scheme, but also about using the correct physical variables. Within the modern Thermodynamic Equation of Seawater (TEOS-10), Conservative Temperature ($\\Theta$) is the variable directly related to enthalpy, not the historically used Potential Temperature ($\\theta$). This exercise asks you to quantify the error in a large-scale heat transport calculation that arises from using $\\theta$ as a proxy for heat content, highlighting the practical importance of a rigorous thermodynamic framework .",
            "id": "3787789",
            "problem": "In a zonally reentrant, mid-latitude basin, consider a steady, two-layer meridional overturning circulation crossing a fixed section at $32^{\\circ}\\,\\mathrm{N}$. The upper layer ($0$ to $1000\\,\\mathrm{m}$) transports volume northward with transport $V_{1}$, and the lower layer ($1000\\,\\mathrm{m}$ to the bottom) transports volume southward with transport $V_{2}$. Assume the section-integrated volume transport is zero, consistent with steady salt and mass budgets. The seawater has constant in-situ density $\\rho$ and obeys the Thermodynamic Equation Of Seawater (TEOS-10), for which the specific enthalpy $h$ is linearly proportional to Conservative Temperature $\\Theta$ with a constant reference isobaric heat capacity $c_{p}^{0}$. Potential temperature $\\theta$ is not strictly a measure of enthalpy in the ocean due to compressibility and nonlinearity of the equation of state. Large-scale meridional heat transport across the section computed with $\\Theta$ is\n$$\nQ_{\\Theta}=\\int_{A}\\rho\\,h\\,v\\,\\mathrm{d}A,\n$$\nwhere $v$ is the meridional velocity and $A$ is the section area. A common but imperfect practice is to compute $Q_{\\theta}$ by replacing $\\Theta$ with $\\theta$ in the enthalpy proxy. Starting from the local conservation equations for heat and salt and the definition of enthalpy flux, derive a closed-form expression for the transport error $\\Delta Q \\equiv Q_{\\theta}-Q_{\\Theta}$ in terms of layer-integrated quantities. Then evaluate $\\Delta Q$ for the following scientifically plausible, self-consistent parameters:\n\n- Northward upper-layer transport $V_{1}=18\\times10^{6}\\,\\mathrm{m}^{3}\\,\\mathrm{s}^{-1}$.\n- Southward lower-layer transport $V_{2}=-18\\times10^{6}\\,\\mathrm{m}^{3}\\,\\mathrm{s}^{-1}$.\n- In-situ density $\\rho=1027\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$.\n- TEOS-10 reference isobaric heat capacity $c_{p}^{0}=3991.867\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$.\n- Within each layer, $\\theta$ and $\\Theta$ are horizontally uniform, and the measured layer-average differences are $\\delta_{1}=\\theta_{1}-\\Theta_{1}=0.000\\,\\mathrm{K}$ in the upper layer and $\\delta_{2}=\\theta_{2}-\\Theta_{2}=-0.035\\,\\mathrm{K}$ in the lower layer.\n\nTake northward transport as positive. Express the final heat transport error $\\Delta Q$ in petawatts and round your answer to three significant figures. Use $1\\,\\mathrm{PW}=10^{15}\\,\\mathrm{W}$. Provide only the single final value as your answer.",
            "solution": "The problem requires the derivation of an expression for the error in meridional heat transport, $\\Delta Q$, which arises from using potential temperature, $\\theta$, as a proxy for enthalpy instead of the thermodynamically more appropriate Conservative Temperature, $\\Theta$.\n\nThe formal definition of meridional heat transport across a section with area $A$ is given by the integral of the advected specific enthalpy, $h$:\n$$Q = \\int_{A} \\rho \\, h \\, v \\, \\mathrm{d}A$$\nwhere $\\rho$ is the in-situ density and $v$ is the meridional velocity component normal to the section. The problem specifies that the seawater obeys the TEOS-10 standard, where the specific enthalpy $h$ is best represented as being proportional to the Conservative Temperature $\\Theta$, with the reference isobaric heat capacity $c_p^0$ as the constant of proportionality. Thus, the correct heat transport is:\n$$Q_{\\Theta} = \\int_{A} \\rho c_p^0 \\Theta v \\, \\mathrm{d}A$$\n\nA common but less accurate practice is to use potential temperature $\\theta$ as the proxy for heat content. The heat transport computed this way is:\n$$Q_{\\theta} = \\int_{A} \\rho c_p^0 \\theta v \\, \\mathrm{d}A$$\n\nThe error, $\\Delta Q$, is the difference between the approximate and the correct heat transport expressions:\n$$\\Delta Q = Q_{\\theta} - Q_{\\Theta} = \\int_{A} \\rho c_p^0 \\theta v \\, \\mathrm{d}A - \\int_{A} \\rho c_p^0 \\Theta v \\, \\mathrm{d}A$$\nUsing the linearity of the integral operator, we can combine the two terms:\n$$\\Delta Q = \\int_{A} \\rho c_p^0 (\\theta - \\Theta) v \\, \\mathrm{d}A$$\n\nThe circulation is described as a two-layer system. The total cross-sectional area $A$ comprises the area of the upper layer, $A_1$, and the lower layer, $A_2$. We can therefore split the integral into two parts corresponding to each layer:\n$$\\Delta Q = \\int_{A_1} \\rho c_p^0 (\\theta - \\Theta) v \\, \\mathrm{d}A + \\int_{A_2} \\rho c_p^0 (\\theta - \\Theta) v \\, \\mathrm{d}A$$\n\nThe problem states that within each layer, relevant properties are uniform. The density $\\rho$ and heat capacity $c_p^0$ are constant throughout. The difference between potential and Conservative Temperature is constant within each layer: $\\delta_1 = \\theta_1 - \\Theta_1$ in the upper layer and $\\delta_2 = \\theta_2 - \\Theta_2$ in the lower layer. We can therefore move these constant quantities outside their respective integrals:\n$$\\Delta Q = \\rho c_p^0 \\delta_1 \\int_{A_1} v \\, \\mathrm{d}A + \\rho c_p^0 \\delta_2 \\int_{A_2} v \\, \\mathrm{d}A$$\n\nThe volume transport in each layer is defined as the integral of the velocity over the layer's area: $V_1 = \\int_{A_1} v \\, \\mathrm{d}A$ and $V_2 = \\int_{A_2} v \\, \\mathrm{d}A$. Substituting these definitions provides the final closed-form expression for the transport error in terms of layer-integrated quantities:\n$$\\Delta Q = \\rho c_p^0 (\\delta_1 V_1 + \\delta_2 V_2)$$\n\nWe are given the following parameters to evaluate this expression:\n- $\\rho = 1027\\,\\mathrm{kg}\\,\\mathrm{m}^{-3}$\n- $c_p^0 = 3991.867\\,\\mathrm{J}\\,\\mathrm{kg}^{-1}\\,\\mathrm{K}^{-1}$\n- $V_1 = 18 \\times 10^6\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n- $V_2 = -18 \\times 10^6\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$\n- $\\delta_1 = 0.000\\,\\mathrm{K}$\n- $\\delta_2 = -0.035\\,\\mathrm{K}$\n\nSubstituting these values into the derived expression:\n$$\\Delta Q = (1027) \\times (3991.867) \\times [ (0.000) \\times (18 \\times 10^6) + (-0.035) \\times (-18 \\times 10^6) ]$$\nThe units of the term in brackets are $\\mathrm{K}\\,\\mathrm{m}^3\\,\\mathrm{s}^{-1}$, and the product $\\rho c_p^0$ has units of $\\mathrm{J}\\,\\mathrm{m}^{-3}\\,\\mathrm{K}^{-1}$. The resulting unit for $\\Delta Q$ is $\\mathrm{J}\\,\\mathrm{s}^{-1}$, which is Watts ($\\mathrm{W}$), as expected for a heat transport (power).\n\nFirst, calculate the term inside the brackets:\n$$[ (0.000) \\times (18 \\times 10^6) + (-0.035) \\times (-18 \\times 10^6) ] = 0 + (0.035 \\times 18 \\times 10^6) = 0.63 \\times 10^6 = 6.3 \\times 10^5$$\nNow, substitute this back into the equation for $\\Delta Q$:\n$$\\Delta Q = (1027) \\times (3991.867) \\times (6.3 \\times 10^5)\\,\\mathrm{W}$$\n$$\\Delta Q = (4099657.409) \\times (6.3 \\times 10^5)\\,\\mathrm{W}$$\n$$\\Delta Q \\approx 2.582784 \\times 10^{12}\\,\\mathrm{W}$$\n\nThe question asks for the answer in petawatts ($\\mathrm{PW}$), where $1\\,\\mathrm{PW} = 10^{15}\\,\\mathrm{W}$. To convert, we divide by $10^{15}$:\n$$\\Delta Q = \\frac{2.582784 \\times 10^{12}}{10^{15}}\\,\\mathrm{PW} = 2.582784 \\times 10^{-3}\\,\\mathrm{PW}$$\n\nFinally, rounding the result to three significant figures, we get:\n$$\\Delta Q \\approx 2.58 \\times 10^{-3}\\,\\mathrm{PW}$$",
            "answer": "$$\\boxed{2.58 \\times 10^{-3}}$$"
        }
    ]
}