{
    "hands_on_practices": [
        {
            "introduction": "任何经典密度泛函理论（CDFT）计算的准确性都关键取决于其自由能泛函的质量，特别是用于描述粒子间排斥体积效应的硬球项。本练习将引导您体验一个高级过程：如何基于一个已知的高度精确的物态方程（Carnahan-Starling方程），在强大的基本度量理论（FMT）框架内“逆向工程”出一个高性能的泛函。这项实践不仅能加深您对现代密度泛函构造与优化的理解，还能锻炼您处理复杂理论推导的能力。",
            "id": "4238121",
            "problem": "考虑一个单组分电解质，在经典密度泛函理论 (CDFT) 框架下，其排斥体积相互作用通过半径为 $R$ 的硬球进行建模。其过剩亥姆霍兹自由能泛函以基本度量理论 (FMT) 的形式写成局域自由能密度 $\\Phi(\\{n_{\\alpha}\\})$ 的空间积分，其中加权密度 $\\{n_{\\alpha}\\}$ 是数密度场 $\\rho(\\mathbf{r})$ 与球体基本几何权重函数的卷积。具体来说，使用标量权重 $w^{(3)}(\\mathbf{r}) = \\Theta(R - |\\mathbf{r}|)$、$w^{(2)}(\\mathbf{r}) = \\delta(R - |\\mathbf{r}|)$、$w^{(1)}(\\mathbf{r}) = w^{(2)}(\\mathbf{r})/(4\\pi R)$、$w^{(0)}(\\mathbf{r}) = w^{(2)}(\\mathbf{r})/(4\\pi R^{2})$，以及矢量权重 $\\mathbf{w}^{(2)}(\\mathbf{r}) = \\delta(R - |\\mathbf{r}|)\\,\\hat{\\mathbf{r}}$、$\\mathbf{w}^{(1)}(\\mathbf{r}) = \\mathbf{w}^{(2)}(\\mathbf{r})/(4\\pi R)$。相应的加权密度为 $n_{3}(\\mathbf{r}) = \\rho * w^{(3)}$、$n_{2}(\\mathbf{r}) = \\rho * w^{(2)}$、$n_{1}(\\mathbf{r}) = \\rho * w^{(1)}$、$n_{0}(\\mathbf{r}) = \\rho * w^{(0)}$，以及 $\\mathbf{n}_{2}(\\mathbf{r}) = \\rho * \\mathbf{w}^{(2)}$、$\\mathbf{n}_{1}(\\mathbf{r}) = \\rho * \\mathbf{w}^{(1)}$，其中 $*$ 表示空间卷积，$\\Theta$ 是亥维赛德函数，$\\delta$ 是狄拉克δ函数。\n\n从FMT构造和关联均匀自由能密度、化学势与压强的标准热力学恒等式出发，写出硬球自由能密度 $\\Phi_{\\mathrm{WB}}(\\{n_{\\alpha}\\})$ 的White Bear版本。该版本通过一个关于 $n_3$ 的标量函数来修正三阶项。然后，确定该标量乘子的唯一泛函形式，以确保均匀体相状态方程等于Carnahan–Starling状态方程。考虑单分散流体的均匀极限，在此极限下 $\\rho(\\mathbf{r}) = \\rho$ 是常数，矢量加权密度为零，标量加权密度简化为常数：$n_{0} = \\rho$、$n_{1} = R \\rho$、$n_{2} = 4\\pi R^{2} \\rho$、$n_{3} = \\eta$，其中 $\\eta = \\frac{4\\pi}{3} R^{3} \\rho$ 是堆积分数。对于均匀单组分流体，使用压强 $p$ 的精确热力学恒等式 $p = -f + \\mu \\rho$，其中 $f$ 是亥姆霍兹自由能密度，$\\mu$ 是化学势；并使用压缩因子 $Z(\\eta) = p/(\\rho k_B T)$ 作为在均匀极限下要匹配的无量纲量度。不要引入除上述标量和矢量集之外的任何张量加权密度。\n\n您的任务：\n- 写出通用的White Bear自由能密度 $\\Phi_{\\mathrm{WB}}(\\{n_{\\alpha}\\})$，用标量和矢量加权密度以及一个乘以三阶不变量的、关于 $n_3$ 的单一标量函数来表示。\n- 在均匀极限下，计算过剩自由能密度、过剩化学势和过剩压强，并通过在均匀极限下强制满足Carnahan–Starling压缩因子，推导出一个关于标量乘子（作为 $n_3$ 的函数）的一阶常微分方程。\n- 施加低密度一致性条件，即修改后的泛函能够再现精确的第二维里系数。\n- 求解标量乘子，并将其表示为关于 $n_3$ 的闭式解析表达式。\n\n请用标准数学函数将最终答案表示为标量乘子函数关于 $n_3$ 的闭式解析表达式。无需数值取整。最终答案中不包含单位。如果出现角度，请使用弧度。将最终答案呈现为单个表达式。",
            "solution": "该问题要求在硬球的基本度量理论 (FMT) 框架内推导一个标量乘子函数，使得最终的状态方程与Carnahan-Starling方程相匹配。这包括验证问题、建立自由能泛函、在均匀极限下应用热力学关系，以及求解得到的微分方程。\n\n### 步骤 1：问题验证\n\n**1. 提取已知条件：**\n- **系统：** 单组分电解质，硬球相互作用，半径 $R$。\n- **理论：** 经典密度泛函理论 (CDFT)，基本度量理论 (FMT)。\n- **过剩自由能泛函：** $F_{\\mathrm{ex}}[\\rho] = \\int \\Phi(\\{n_{\\alpha}(\\mathbf{r})\\}) d\\mathbf{r}$。\n- **权重函数：**\n  - 标量：$w^{(3)}(\\mathbf{r}) = \\Theta(R - |\\mathbf{r}|)$，$w^{(2)}(\\mathbf{r}) = \\delta(R - |\\mathbf{r}|)$，$w^{(1)}(\\mathbf{r}) = \\frac{w^{(2)}(\\mathbf{r})}{4\\pi R}$，$w^{(0)}(\\mathbf{r}) = \\frac{w^{(2)}(\\mathbf{r})}{4\\pi R^2}$。\n  - 矢量：$\\mathbf{w}^{(2)}(\\mathbf{r}) = \\delta(R - |\\mathbf{r}|)\\,\\hat{\\mathbf{r}}$，$\\mathbf{w}^{(1)}(\\mathbf{r}) = \\frac{\\mathbf{w}^{(2)}(\\mathbf{r})}{4\\pi R}$。\n- **加权密度：** $n_{\\alpha} = \\rho * w^{(\\alpha)}$，$\\mathbf{n}_{\\alpha} = \\rho * \\mathbf{w}^{(\\alpha)}$，其中 $*$ 是卷积。\n- **均匀极限：**\n  - $\\rho(\\mathbf{r}) \\to \\rho$ (常数)。\n  - 矢量密度 $\\mathbf{n}_{\\alpha} \\to \\mathbf{0}$。\n  - 标量密度：$n_0 \\to \\rho$，$n_1 \\to R\\rho$，$n_2 \\to 4\\pi R^2\\rho$，$n_3 \\to \\eta = \\frac{4\\pi}{3} R^3 \\rho$。\n- **热力学恒等式：** $p = -f + \\mu \\rho$，其中 $p$ 为压强，$f$ 为亥姆霍兹自由能密度，$\\mu$ 为化学势，$\\rho$ 为数密度。\n- **目标状态方程：** Carnahan-Starling (CS) 压缩因子 $Z(\\eta) = \\frac{p}{\\rho k_B T} = \\frac{1 + \\eta + \\eta^2 - \\eta^3}{(1-\\eta)^3}$。\n- **任务：** 在FMT泛函的White Bear修正中，找到能导出CS状态方程的、$n_3$的标量乘子函数。\n\n**2. 使用提取的已知条件进行验证：**\n该问题具有科学依据，完全属于液态理论和统计力学这一成熟领域。FMT和Carnahan-Starling方程是经典课题。问题是适定的，提供了明确的目标和一组足以推导出唯一解的约束和定义。语言客观而精确。所提供的数据和定义是自洽的，并且是文献中的标准。例如，加权密度的均匀极限是其定义的正确推论。该问题与计算电化学领域相关，因为硬球模型是模拟离子溶液的基础。它并非无足轻重，需要涉及微积分和热力学的多步推导。\n\n**3. 结论与行动：**\n问题有效。将提供完整解答。\n\n### 步骤 2：标量乘子的推导\n\n**通用的 White Bear 自由能密度**\nFMT的过剩亥姆霍兹自由能密度 $\\Phi$ 是加权密度 $\\{n_{\\alpha}\\}$ 的函数。原始的Rosenfeld泛函可以导出Percus-Yevick (PY) 压缩性状态方程，它由一系列项相加而成。如题目所述，White Bear修正通过一个作为标量加权密度 $n_3$ 函数的标量乘子来改变三阶项。我们采用该修正的标准形式。令 $\\beta = 1/(k_B T)$，则过剩自由能密度（单位体积，单位 $k_B T$）为：\n$$\n\\beta \\Phi_{\\mathrm{WB}}(\\{n_{\\alpha}\\}) = -n_0 \\ln(1-n_3) + \\frac{n_1 n_2 - \\mathbf{n}_1 \\cdot \\mathbf{n}_2}{1-n_3} + \\psi(n_3) \\frac{n_2^3 - 3n_2(\\mathbf{n}_2 \\cdot \\mathbf{n}_2)}{24\\pi(1-n_3)^2}\n$$\n此处，$\\psi(n_3)$ 是未知的标量乘子函数。对于原始的Rosenfeld泛函，$\\psi(n_3) = 1$。我们的任务是确定 $\\psi(n_3)$ 的形式，以得到Carnahan-Starling状态方程。\n\n**均匀极限**\n在均匀流体中，$\\rho(\\mathbf{r}) = \\rho$，加权密度变为常数：$\\mathbf{n}_{\\alpha} = \\mathbf{0}$，$n_0 = \\rho$，$n_1 = R\\rho$，$n_2 = 4\\pi R^2\\rho$，$n_3 = \\eta = \\frac{4\\pi}{3} R^3 \\rho$。单位体积的过剩自由能 $f_{\\mathrm{ex}}$ 变为在这些密度下取值的 $\\Phi_{\\mathrm{WB}}$。\n在此极限下，我们可以建立标量加权密度之间的关系：\n$n_1 n_2 = (R\\rho)(4\\pi R^2\\rho) = 4\\pi R^3 \\rho^2 = 3 (\\frac{4\\pi}{3}R^3\\rho) \\rho = 3n_3 n_0$。\n$n_2^3 = (4\\pi R^2\\rho)^3 = 64\\pi^3 R^6 \\rho^3$。\n并且，$n_3^2 = (\\frac{4\\pi}{3} R^3 \\rho)^2 = \\frac{16\\pi^2}{9} R^6 \\rho^2$。\n所以，$\\frac{n_2^3}{24\\pi} = \\frac{64\\pi^3 R^6 \\rho^3}{24\\pi} = \\frac{8\\pi^2}{3} R^6 \\rho^3 = \\frac{3}{2} (\\frac{16\\pi^2}{9} R^6 \\rho^2) \\rho = \\frac{3}{2}n_3^2 n_0$。\n\n将这些代入 $\\beta\\Phi_{\\mathrm{WB}}$ 的表达式，得到均匀过剩自由能密度 $\\beta f_{\\mathrm{ex}}$：\n$$\n\\beta f_{\\mathrm{ex}} = -n_0 \\ln(1-n_3) + \\frac{3n_3 n_0}{1-n_3} + \\psi(n_3) \\frac{\\frac{3}{2}n_3^2 n_0}{(1-n_3)^2}\n$$\n由于 $n_0 = \\rho$ 和 $n_3 = \\eta$，我们可以将单位粒子的过剩自由能写为：\n$$\n\\frac{\\beta f_{\\mathrm{ex}}}{\\rho} \\equiv \\phi(\\eta) = -\\ln(1-\\eta) + \\frac{3\\eta}{1-\\eta} + \\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta)\n$$\n\n**热力学关系与常微分方程 (ODE)**\n压强 $p$ 与自由能密度相关。压缩因子 $Z = \\beta p/\\rho$ 可以通过通用热力学关系 $Z = 1 + \\eta \\frac{d\\phi}{d\\eta}$ 从 $\\phi(\\eta)$ 中获得。我们强制要求它等于Carnahan-Starling压缩因子 $Z_{\\mathrm{CS}}(\\eta)$：\n$$\n1 + \\eta \\frac{d\\phi}{d\\eta} = Z_{\\mathrm{CS}}(\\eta) = \\frac{1+\\eta+\\eta^2-\\eta^3}{(1-\\eta)^3}\n$$\n这给出了 $\\phi(\\eta)$ 所需的导数：\n$$\n\\frac{d\\phi}{d\\eta} = \\frac{1}{\\eta} \\left( \\frac{1+\\eta+\\eta^2-\\eta^3}{(1-\\eta)^3} - 1 \\right) = \\frac{1}{\\eta} \\left( \\frac{1+\\eta+\\eta^2-\\eta^3 - (1-3\\eta+3\\eta^2-\\eta^3)}{(1-\\eta)^3} \\right) = \\frac{4\\eta-2\\eta^2}{\\eta(1-\\eta)^3} = \\frac{4-2\\eta}{(1-\\eta)^3}\n$$\n现在，我们对我们得到的 $\\phi(\\eta)$ 表达式进行微分：\n$$\n\\frac{d\\phi}{d\\eta} = \\frac{d}{d\\eta} \\left( -\\ln(1-\\eta) + \\frac{3\\eta}{1-\\eta} \\right) + \\frac{d}{d\\eta} \\left( \\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta) \\right)\n$$\n第一部分对应于PY压缩性路径：\n$$\n\\frac{d}{d\\eta} \\left( -\\ln(1-\\eta) + \\frac{3\\eta}{1-\\eta} \\right) = \\frac{1}{1-\\eta} + \\frac{3(1-\\eta)-3\\eta(-1)}{(1-\\eta)^2} = \\frac{1-\\eta+3}{(1-\\eta)^2} = \\frac{4-\\eta}{(1-\\eta)^2}\n$$\n令 $\\frac{d\\phi}{d\\eta}$ 的两个表达式相等：\n$$\n\\frac{4-\\eta}{(1-\\eta)^2} + \\frac{d}{d\\eta} \\left( \\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta) \\right) = \\frac{4-2\\eta}{(1-\\eta)^3}\n$$\n这得出了一个包含 $\\psi(\\eta)$ 项的微分方程：\n$$\n\\frac{d}{d\\eta} \\left( \\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta) \\right) = \\frac{4-2\\eta}{(1-\\eta)^3} - \\frac{4-\\eta}{(1-\\eta)^2} = \\frac{4-2\\eta - (4-\\eta)(1-\\eta)}{(1-\\eta)^3} = \\frac{4-2\\eta - (4-5\\eta+\\eta^2)}{(1-\\eta)^3} = \\frac{3\\eta-\\eta^2}{(1-\\eta)^3}\n$$\n\n**求解常微分方程 (ODE)**\n我们将此方程从 $0$ 积分到 $\\eta$。积分下限是基于低密度极限选择的，在该极限下，过剩自由能及其组分必须适当地趋于零。\n$$\n\\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta) - \\lim_{x\\to 0} \\left( \\frac{3x^2}{2(1-x)^2} \\psi(x) \\right) = \\int_0^{\\eta} \\frac{3x-x^2}{(1-x)^3} dx\n$$\n问题陈述泛函必须能再现精确的第二维里系数。这已由泛函的PY部分保证，为保持一致性，我们要求 $\\psi(0)$ 是有限的。具体来说，匹配CS方程的第三维里系数需要 $\\psi(0)=1$。这确保了当 $\\eta \\to 0$ 时，左边的项为零。\n我们必须计算积分 $I(\\eta) = \\int_0^{\\eta} \\frac{3x-x^2}{(1-x)^3} dx$。令 $u = 1-x$，则 $x=1-u$ 且 $dx=-du$。被积函数变为 $\\frac{3(1-u)-(1-u)^2}{u^3} = \\frac{(3-3u)-(1-2u+u^2)}{u^3} = \\frac{2-u-u^2}{u^3}$。\n$$\nI(\\eta) = \\int_1^{1-\\eta} \\frac{2-u-u^2}{u^3} (-du) = \\int_{1-\\eta}^1 (2u^{-3} - u^{-2} - u^{-1}) du = \\left[ -u^{-2} + u^{-1} - \\ln(u) \\right]_{1-\\eta}^1\n$$\n$$\nI(\\eta) = (-1+1-\\ln(1)) - \\left( -\\frac{1}{(1-\\eta)^2} + \\frac{1}{1-\\eta} - \\ln(1-\\eta) \\right) = \\frac{1}{(1-\\eta)^2} - \\frac{1}{1-\\eta} + \\ln(1-\\eta)\n$$\n$$\nI(\\eta) = \\frac{1-(1-\\eta)}{(1-\\eta)^2} + \\ln(1-\\eta) = \\frac{\\eta}{(1-\\eta)^2} + \\ln(1-\\eta)\n$$\n现在，我们将积分项设为等于此结果：\n$$\n\\frac{3\\eta^2}{2(1-\\eta)^2} \\psi(\\eta) = \\frac{\\eta}{(1-\\eta)^2} + \\ln(1-\\eta)\n$$\n最后，我们求解 $\\psi(\\eta)$：\n$$\n\\psi(\\eta) = \\frac{2(1-\\eta)^2}{3\\eta^2} \\left( \\frac{\\eta}{(1-\\eta)^2} + \\ln(1-\\eta) \\right) = \\frac{2}{3\\eta} + \\frac{2(1-\\eta)^2}{3\\eta^2} \\ln(1-\\eta)\n$$\n将堆积分数 $\\eta$ 替换为加权密度 $n_3$，即可得到标量乘子的最终表达式。",
            "answer": "$$\\boxed{\\frac{2}{3n_3} + \\frac{2(1-n_3)^2}{3n_3^2} \\ln(1-n_3)}$$"
        },
        {
            "introduction": "从连续的理论过渡到数值实践时，我们必须将求解域离散化，这给物理守恒律的施加带来了新的挑战。例如，电解质体系的全局电中性约束必须在离散的网格上得到严格满足。本练习将演示如何运用拉格朗日乘子法，在离散的变分框架下稳健地处理此类约束，这是开发稳定且精确的CDFT求解器所必备的一项关键技能。",
            "id": "4238072",
            "problem": "考虑一个在经典密度泛函理论 (CDFT) 框架内建模的双组分对称电解质。计算域被离散为 $M$ 个求积节点，索引为 $i \\in \\{1,\\dots,M\\}$，权重为正值 $w_i  0$。离子种类由 $\\alpha \\in \\{+,-\\}$ 标记，其价态为 $z_{+} = +1$ 和 $z_{-} = -1$，热德布罗意波长为 $\\Lambda_{+}$ 和 $\\Lambda_{-}$，体化学势为 $\\mu_{+}$ 和 $\\mu_{-}$，在节点 $i$ 处的外部单粒子势为 $V_{+ i}$ 和 $V_{- i}$。温度为 $T$，且 $\\beta = 1/(k_B T)$，其中 $k_B$ 是玻尔兹曼常数。\n\n对每种物质的亥姆霍兹自由能密度采用理想气体近似，并考虑离散的巨势泛函\n$$\n\\Omega[\\{\\rho_{\\alpha i}\\}] = \\sum_{\\alpha \\in \\{+,-\\}} \\sum_{i=1}^{M} w_i \\, k_B T \\left( \\rho_{\\alpha i} \\left[\\ln\\!\\left(\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3}\\right) - 1 \\right] \\right) + \\sum_{\\alpha \\in \\{+,-\\}} \\sum_{i=1}^{M} w_i \\, V_{\\alpha i} \\, \\rho_{\\alpha i} - \\sum_{\\alpha \\in \\{+,-\\}} \\mu_{\\alpha} \\sum_{i=1}^{M} w_i \\, \\rho_{\\alpha i}.\n$$\n通过以下约束施加全局电中性\n$$\n\\sum_{i=1}^{M} w_i \\sum_{\\alpha \\in \\{+,-\\}} z_{\\alpha} \\rho_{\\alpha i} = 0,\n$$\n并使用单个拉格朗日乘子 $\\lambda$ 来强制执行。目标是计算与离散泛函的变分结构一致、遵守约束条件且保持体化学势固定的稳态离散密度。\n\n任务：\n- 从约束变分原理出发，推导 $\\rho_{\\alpha i}$ 的离散欧拉-拉格朗日平稳性条件，并消去 $\\rho_{\\alpha i}$，以获得一个用 $\\{w_i\\}$, $\\{\\Lambda_{\\alpha}\\}$, $\\{\\mu_{\\alpha}\\}$, $\\{V_{\\alpha i}\\}$ 和 $\\beta$ 表示的、强制全局电中性的拉格朗日乘子 $\\lambda$ 的闭合形式表达式。\n- 写出相应的密度 $\\rho_{\\alpha i}$ 的保正离散更新规则，该规则与离散变分结构一致，并使用固定的体化学势，其中拉格朗日乘子作为强制约束的对偶变量被包括在内。\n\n将您的最终答案表示为 $\\lambda$ 作为给定量的函数的单个闭合形式解析表达式。不需要进行数值计算。",
            "solution": "该问题要求在经典密度泛函理论 (CDFT) 框架内，使用理想气体近似来处理内禀亥姆霍兹自由能，推导强制双组分电解质全局电中性的拉格朗日乘子 $\\lambda$。\n\n首先，我们建立目标函数和约束条件。巨势泛函 $\\Omega[\\{\\rho_{\\alpha i}\\}]$ 由下式给出：\n$$\n\\Omega[\\{\\rho_{\\alpha i}\\}] = \\sum_{\\alpha \\in \\{+,-\\}} \\sum_{i=1}^{M} w_i \\, k_B T \\left( \\rho_{\\alpha i} \\left[\\ln\\!\\left(\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3}\\right) - 1 \\right] \\right) + \\sum_{\\alpha \\in \\{+,-\\}} \\sum_{i=1}^{M} w_i \\, V_{\\alpha i} \\, \\rho_{\\alpha i} - \\sum_{\\alpha \\in \\{+,-\\}} \\mu_{\\alpha} \\sum_{i=1}^{M} w_i \\, \\rho_{\\alpha i}\n$$\n系统必须满足全局电中性约束：\n$$\n\\sum_{i=1}^{M} w_i \\sum_{\\alpha \\in \\{+,-\\}} z_{\\alpha} \\rho_{\\alpha i} = 0\n$$\n为了找到在满足此约束条件下使 $\\Omega$ 最小化的稳态密度 $\\{\\rho_{\\alpha i}\\}$，我们使用拉格朗日乘子法。我们通过将约束条件乘以一个拉格朗日乘子 $\\lambda$ 来构造拉格朗日泛函 $\\mathcal{L}$：\n$$\n\\mathcal{L}[\\{\\rho_{\\alpha i}\\}, \\lambda] = \\Omega[\\{\\rho_{\\alpha i}\\}] + \\lambda \\left(\\sum_{i=1}^{M} w_i \\sum_{\\alpha \\in \\{+,-\\}} z_{\\alpha} \\rho_{\\alpha i}\\right)\n$$\n代入 $\\Omega$ 的完整表达式，我们得到：\n$$\n\\mathcal{L} = \\sum_{\\alpha, i} w_i \\, k_B T \\left( \\rho_{\\alpha i} \\left[\\ln\\!\\left(\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3}\\right) - 1 \\right] \\right) + \\sum_{\\alpha, i} w_i \\, V_{\\alpha i} \\, \\rho_{\\alpha i} - \\sum_{\\alpha, i} w_i \\, \\mu_{\\alpha} \\, \\rho_{\\alpha i} + \\lambda \\sum_{\\alpha, i} w_i z_{\\alpha} \\rho_{\\alpha i}\n$$\n其中对 $\\alpha$ 和 $i$ 的求和是隐含的。变分原理要求 $\\mathcal{L}$ 对每个密度 $\\rho_{\\alpha i}$ 的泛函导数在驻点处为零。我们计算 $\\mathcal{L}$ 相对于节点 $j \\in \\{1, \\dots, M\\}$ 处特定物质 $\\gamma \\in \\{+,-\\}$ 的密度 $\\rho_{\\gamma j}$ 的偏导数：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\rho_{\\gamma j}} = 0\n$$\n为了计算这个导数，我们注意到 $\\frac{\\partial \\rho_{\\alpha i}}{\\partial \\rho_{\\gamma j}} = \\delta_{\\alpha\\gamma}\\delta_{ij}$，其中 $\\delta$ 是克罗内克 δ。让我们逐项微分。理想气体自由能项的导数是：\n$$\n\\frac{\\partial}{\\partial \\rho_{\\gamma j}} \\left( w_j k_B T \\left( \\rho_{\\gamma j} \\left[\\ln\\!\\left(\\rho_{\\gamma j} \\Lambda_{\\gamma}^{3}\\right) - 1 \\right] \\right) \\right) = w_j k_B T \\left( 1 \\cdot \\left[\\ln\\!\\left(\\rho_{\\gamma j} \\Lambda_{\\gamma}^{3}\\right) - 1 \\right] + \\rho_{\\gamma j} \\cdot \\frac{1}{\\rho_{\\gamma j}} \\right) = w_j k_B T \\ln\\!\\left(\\rho_{\\gamma j} \\Lambda_{\\gamma}^{3}\\right)\n$$\n其他项的导数是直接的：\n$$\n\\frac{\\partial}{\\partial \\rho_{\\gamma j}} \\left(w_j V_{\\gamma j} \\rho_{\\gamma j}\\right) = w_j V_{\\gamma j}\n$$\n$$\n\\frac{\\partial}{\\partial \\rho_{\\gamma j}} \\left(- w_j \\mu_{\\gamma} \\rho_{\\gamma j}\\right) = -w_j \\mu_{\\gamma}\n$$\n$$\n\\frac{\\partial}{\\partial \\rho_{\\gamma j}} \\left(\\lambda w_j z_{\\gamma} \\rho_{\\gamma j}\\right) = \\lambda w_j z_{\\gamma}\n$$\n将这些结果结合起来，得到每个 $\\rho_{\\gamma j}$ 的离散欧拉-拉格朗日平稳性条件：\n$$\nw_j k_B T \\ln\\!\\left(\\rho_{\\gamma j} \\Lambda_{\\gamma}^{3}\\right) + w_j V_{\\gamma j} - w_j \\mu_{\\gamma} + \\lambda w_j z_{\\gamma} = 0\n$$\n由于权重 $w_j$ 是正的 ($w_j > 0$)，我们可以将整个方程除以 $w_j$。推广回任意节点 $i$ 的任意物质 $\\alpha$：\n$$\nk_B T \\ln\\!\\left(\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3}\\right) + V_{\\alpha i} - \\mu_{\\alpha} + \\lambda z_{\\alpha} = 0\n$$\n现在，我们求解这个方程以得到密度 $\\rho_{\\alpha i}$。使用 $\\beta = 1/(k_B T)$：\n$$\n\\ln\\!\\left(\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3}\\right) = -\\beta(V_{\\alpha i} - \\mu_{\\alpha} + \\lambda z_{\\alpha}) = \\beta(\\mu_{\\alpha} - V_{\\alpha i} - \\lambda z_{\\alpha})\n$$\n对两边取指数得到：\n$$\n\\rho_{\\alpha i} \\Lambda_{\\alpha}^{3} = \\exp\\left(\\beta(\\mu_{\\alpha} - V_{\\alpha i} - \\lambda z_{\\alpha})\\right)\n$$\n$$\n\\rho_{\\alpha i} = \\frac{1}{\\Lambda_{\\alpha}^{3}} \\exp\\left(\\beta\\mu_{\\alpha}\\right) \\exp\\left(-\\beta(V_{\\alpha i} + \\lambda z_{\\alpha})\\right)\n$$\n这是密度的保正离散更新规则，因为指数函数保证了 $\\rho_{\\alpha i} > 0$。\n\n接下来，我们使用 $\\rho_{\\alpha i}$ 的这个表达式来找到拉格朗日乘子 $\\lambda$ 的闭合形式表达式。我们将密度表达式代入电中性约束中：\n$$\n\\sum_{i=1}^{M} w_i \\sum_{\\alpha \\in \\{+,-\\}} z_{\\alpha} \\rho_{\\alpha i} = 0\n$$\n让我们写出这两种物质的和，使用它们的价态 $z_{+} = +1$ 和 $z_{-} = -1$：\n$$\n\\sum_{i=1}^{M} w_i \\left( (+1)\\rho_{+i} + (-1)\\rho_{-i} \\right) = \\sum_{i=1}^{M} w_i (\\rho_{+i} - \\rho_{-i}) = 0\n$$\n现在，代入推导出的 $\\rho_{+i}$ 和 $\\rho_{-i}$ 的表达式：\n$$\n\\rho_{+i} = \\frac{1}{\\Lambda_{+}^{3}} \\exp(\\beta\\mu_{+}) \\exp(-\\beta(V_{+i} + \\lambda z_{+})) = \\frac{\\exp(\\beta\\mu_{+})}{\\Lambda_{+}^{3}} \\exp(-\\beta V_{+i}) \\exp(-\\beta\\lambda)\n$$\n$$\n\\rho_{-i} = \\frac{1}{\\Lambda_{-}^{3}} \\exp(\\beta\\mu_{-}) \\exp(-\\beta(V_{-i} + \\lambda z_{-})) = \\frac{\\exp(\\beta\\mu_{-})}{\\Lambda_{-}^{3}} \\exp(-\\beta V_{-i}) \\exp(+\\beta\\lambda)\n$$\n将这些代入约束方程得到：\n$$\n\\sum_{i=1}^{M} w_i \\left( \\frac{\\exp(\\beta\\mu_{+})}{\\Lambda_{+}^{3}} \\exp(-\\beta V_{+i}) \\exp(-\\beta\\lambda) - \\frac{\\exp(\\beta\\mu_{-})}{\\Lambda_{-}^{3}} \\exp(-\\beta V_{-i}) \\exp(\\beta\\lambda) \\right) = 0\n$$\n我们可以分离包含 $\\exp(-\\beta\\lambda)$ 和 $\\exp(\\beta\\lambda)$ 的项：\n$$\n\\exp(-\\beta\\lambda) \\sum_{i=1}^{M} w_i \\frac{\\exp(\\beta\\mu_{+})}{\\Lambda_{+}^{3}} \\exp(-\\beta V_{+i}) = \\exp(\\beta\\lambda) \\sum_{i=1}^{M} w_i \\frac{\\exp(\\beta\\mu_{-})}{\\Lambda_{-}^{3}} \\exp(-\\beta V_{-i})\n$$\n为了求解 $\\lambda$，我们重新排列方程以分离出涉及 $\\lambda$ 的指数项：\n$$\n\\frac{\\exp(\\beta\\lambda)}{\\exp(-\\beta\\lambda)} = \\frac{\\sum_{i=1}^{M} w_i \\Lambda_{+}^{-3} \\exp(\\beta\\mu_{+}) \\exp(-\\beta V_{+i})}{\\sum_{i=1}^{M} w_i \\Lambda_{-}^{-3} \\exp(\\beta\\mu_{-}) \\exp(-\\beta V_{-i})}\n$$\n左侧简化为 $\\exp(2\\beta\\lambda)$。对两边取自然对数：\n$$\n2\\beta\\lambda = \\ln\\left( \\frac{\\sum_{i=1}^{M} w_i \\Lambda_{+}^{-3} \\exp(\\beta\\mu_{+}) \\exp(-\\beta V_{+i})}{\\sum_{i=1}^{M} w_i \\Lambda_{-}^{-3} \\exp(\\beta\\mu_{-}) \\exp(-\\beta V_{-i})} \\right)\n$$\n最后，求解 $\\lambda$：\n$$\n\\lambda = \\frac{1}{2\\beta} \\ln\\left( \\frac{\\sum_{i=1}^{M} w_i \\Lambda_{+}^{-3} \\exp(\\beta\\mu_{+}) \\exp(-\\beta V_{+i})}{\\sum_{i=1}^{M} w_i \\Lambda_{-}^{-3} \\exp(\\beta\\mu_{-}) \\exp(-\\beta V_{-i})} \\right)\n$$\n这就是所要求的拉格朗日乘子 $\\lambda$ 的闭合形式表达式。",
            "answer": "$$\n\\boxed{\\frac{1}{2\\beta} \\ln\\left( \\frac{\\sum_{i=1}^{M} w_i \\Lambda_{+}^{-3} \\exp(\\beta\\mu_{+}) \\exp(-\\beta V_{+i})}{\\sum_{i=1}^{M} w_i \\Lambda_{-}^{-3} \\exp(\\beta\\mu_{-}) \\exp(-\\beta V_{-i})} \\right)}\n$$"
        },
        {
            "introduction": "最后，我们通过一个完整的计算项目来综合应用所学原理。本练习要求您为一个经典的电化学系统——亥姆霍兹双电层——实现一个数值求解器。具体而言，您将求解CDFT在平均场近似下的极限形式，即泊松-玻尔兹曼（Poisson-Boltzmann）方程，并计算其微分电容。通过执行网格收敛性分析并将数值结果与精确解析解进行比较，您将体验计算建模从实现到验证的完整工作流程，并对数值精度有更深刻的认识。",
            "id": "4238115",
            "problem": "您的任务是在经典电解质密度泛函理论的框架内，对一个计算平面双电层微分电容的数值格式进行网格加密和离散化误差分析。该平面几何结构包含一个位于 $x=0$ 位置的、均匀带电的理想极化电极，它与占据半空间 $x \\in [0,L]$ 的对称单价电解质接触，其中 $L$ 是模拟盒子的长度。对于自由能的熵贡献部分，电解质在理想气体水平上处理；对于静电贡献部分，则在平均场水平上处理。\n\n从经典密度泛函理论的自由能泛函出发，该泛函是离子数密度分布 $n_{+}(x)$ 和 $n_{-}(x)$ 以及静电势 $\\psi(x)$ 的函数，\n$$\n\\mathcal{F}[n_{+},n_{-},\\psi] = \\int_{0}^{L} \\left( k_B T \\sum_{\\alpha=\\pm} n_{\\alpha}(x) \\left( \\ln\\frac{n_{\\alpha}(x)}{c_{0}} - 1\\right) + \\frac{\\varepsilon}{2} \\left( \\frac{d\\psi}{dx} \\right)^{2} - e \\psi(x)\\left(n_{+}(x) - n_{-}(x)\\right) \\right) dx,\n$$\n其中 $k_B$ 是玻尔兹曼常数，$T$ 是绝对温度，$e$ 是元电荷，$\\varepsilon$ 是介质的介电常数，$c_{0}$ 是体相摩尔浓度。通过在体相浓度固定的约束下，对 $\\mathcal{F}$ 关于 $n_{+}$ 和 $n_{-}$ 进行最小化，并将得到的玻尔兹曼分布代入静电方程，可以得到对称1:1型电解质的一维泊松-玻尔兹曼边值问题（BVP），\n$$\n\\frac{d^{2}\\psi}{dx^{2}} = \\frac{2 e c_{0} N_{\\mathrm{A}}}{\\varepsilon} \\sinh\\!\\left( \\beta e \\psi(x) \\right), \\quad \\beta = \\frac{1}{k_B T},\n$$\n其服从狄利克雷边界条件\n$$\n\\psi(0) = \\Delta \\phi, \\qquad \\psi(L) = 0,\n$$\n其中 $N_{\\mathrm{A}}$ 是阿伏伽德罗常数，$\\Delta \\phi$ 是施加在电极与体相之间的电势差。表面电荷密度由静电边界关系给出\n$$\n\\sigma = -\\varepsilon \\left. \\frac{d\\psi}{dx} \\right|_{x=0}.\n$$\n微分电容定义为\n$$\nC_{\\mathrm{diff}}(\\Delta \\phi) = \\frac{d\\sigma}{d(\\Delta \\phi)}.\n$$\n\n在一个包含 $N$ 个点（包括边界）的均匀网格上，实现非线性BVP的有限差分离散化，网格间距为 $h = L/(N-1)$，并使用牛顿迭代法求解内部节点的离散非线性系统。使用二阶单边差分公式来近似 $\\left. d\\psi/dx \\right|_{x=0}$，\n$$\n\\left. \\frac{d\\psi}{dx} \\right|_{x=0} \\approx \\frac{-3 \\psi_{0} + 4 \\psi_{1} - \\psi_{2}}{2 h},\n$$\n其中 $\\psi_{i}$ 表示网格索引 $i$ 处的电势。使用一个小的电压增量 $\\delta V$ 和中心差分法来数值计算 $C_{\\mathrm{diff}}(\\Delta \\phi)$，\n$$\nC_{\\mathrm{diff}}^{\\mathrm{num}}(\\Delta \\phi; h) = \\frac{\\sigma(\\Delta \\phi + \\delta V; h) - \\sigma(\\Delta \\phi - \\delta V; h)}{2 \\delta V}.\n$$\n\n为了进行验证和误差量化，使用经典的Grahame关系式给出的半无限平面1:1型电解质的精确微分电容，\n$$\n\\sigma_{\\mathrm{exact}}(\\Delta \\phi) = \\sqrt{8 \\varepsilon k_B T c_{0} N_{\\mathrm{A}}} \\, \\sinh\\!\\left( \\frac{\\beta e \\Delta \\phi}{2} \\right),\n$$\n和\n$$\nC_{\\mathrm{diff}}^{\\mathrm{exact}}(\\Delta \\phi) = \\sqrt{8 \\varepsilon k_B T c_{0} N_{\\mathrm{A}}} \\, \\frac{e}{2 k_B T} \\, \\cosh\\!\\left( \\frac{\\beta e \\Delta \\phi}{2} \\right).\n$$\n\n将每个网格的离散化误差定义为\n$$\nE(h) = \\left| C_{\\mathrm{diff}}^{\\mathrm{num}}(\\Delta \\phi; h) - C_{\\mathrm{diff}}^{\\mathrm{exact}}(\\Delta \\phi) \\right|.\n$$\n使用三个分别具有 $N_{1}$、$N_{2}$ 和 $N_{3}$ 个点的网格进行网格加密研究，使得 $h_{3}  h_{2}  h_{1}$ 且近似满足 $h_{i+1} \\approx h_{i}/2$。通过以下公式来估计数值格式的观测收敛速率\n$$\np_{23} = \\frac{\\ln\\!\\left( E(h_{3}) / E(h_{2}) \\right)}{\\ln\\!\\left( h_{3} / h_{2} \\right)}.\n$$\n如果该格式处于网格收敛区，这个 $p_{23}$ 值应反映其渐近精度阶。\n\n使用以下物理常数和单位：$e = 1.602176634 \\times 10^{-19}$ C，$k_B = 1.380649 \\times 10^{-23}$ J/K，$N_{\\mathrm{A}} = 6.02214076 \\times 10^{23}$ mol$^{-1}$，$\\varepsilon_{0} = 8.8541878128 \\times 10^{-12}$ F/m，水的相对介电常数 $\\varepsilon_{r} = 78.4$，绝对温度 $T = 298$ K，因此 $\\varepsilon = \\varepsilon_{0} \\varepsilon_{r}$。所有电势单位必须是伏特（V），长度单位为米（m），浓度单位为摩尔/立方米（mol/m$^{3}$）。微分电容必须以法拉/平方米（F/m$^{2}$）为单位计算。对于数值微分，使用一个以伏特为单位的固定电压增量 $\\delta V$。\n\n您的程序必须实现上述方案，并为以下参数集测试套件生成所要求的收敛速率估计值：\n\n- 测试用例1（理想情况，半无限近似有效）：$L = 100 \\times 10^{-9}$ m, $c_{0} = 100$ mol/m$^{3}$, $\\Delta \\phi = 0.05$ V, $\\delta V = 0.001$ V, 网格 $N \\in \\{65, 129, 257\\}$。\n- 测试用例2（边缘情况，有限域截断，可能出现非渐近行为）：$L = 10 \\times 10^{-9}$ m, $c_{0} = 0.1$ mol/m$^{3}$, $\\Delta \\phi = 0.05$ V, $\\delta V = 0.001$ V, 网格 $N \\in \\{65, 129, 257\\}$。\n- 测试用例3（较高电势下的强非线性）：$L = 50 \\times 10^{-9}$ m, $c_{0} = 10$ mol/m$^{3}$, $\\Delta \\phi = 0.20$ V, $\\delta V = 0.001$ V, 网格 $N \\in \\{65, 129, 257\\}$。\n\n您的程序应生成单行输出，其中包含三个测试用例的观测收敛速率 $p_{23}$，四舍五入到三位小数，并以方括号括起来的逗号分隔列表形式表示（例如，“[$p_{1}$,$p_{2}$,$p_{3}$]”），其中每个 $p_{i}$ 都是无量纲的。",
            "solution": "用户提出了一个关于平面双电层微分电容的数值计算和验证的问题。该问题植根于经典统计力学和计算物理学，具体应用了泊松-玻尔兹曼（PB）理论，该理论是经典密度泛函理论的一种平均场极限。任务要求实现一个有限差分格式来求解非线性的PB边值问题（BVP），计算微分电容，并进行网格加密研究以估计数值方法的收敛阶。\n\n### 1. 问题验证\n所提供的问题陈述已经过严格验证，并被认为是合理的。\n\n**1.1. 已知条件提取：**\n- **控制方程（泊松-玻尔兹曼）：** $\\frac{d^{2}\\psi}{dx^{2}} = \\frac{2 e c_{0} N_{\\mathrm{A}}}{\\varepsilon} \\sinh\\!\\left( \\beta e \\psi(x) \\right)$, 其中 $\\beta = (k_B T)^{-1}$。\n- **边界条件：** $\\psi(0) = \\Delta \\phi$, $\\psi(L) = 0$。\n- **表面电荷密度：** $\\sigma = -\\varepsilon \\left. \\frac{d\\psi}{dx} \\right|_{x=0}$。\n- **微分电容：** $C_{\\mathrm{diff}} = d\\sigma/d(\\Delta \\phi)$。\n- **数值离散化：** 在具有 $N$ 个点、间距为 $h = L/(N-1)$ 的均匀网格上使用有限差分法。\n- **用于 $\\sigma$ 的数值导数：** 二阶单边公式 $\\left. \\frac{d\\psi}{dx} \\right|_{x=0} \\approx \\frac{-3 \\psi_{0} + 4 \\psi_{1} - \\psi_{2}}{2 h}$。\n- **用于 $C_{\\mathrm{diff}}$ 的数值导数：** 二阶中心差分 $C_{\\mathrm{diff}}^{\\mathrm{num}} = \\frac{\\sigma(\\Delta \\phi + \\delta V) - \\sigma(\\Delta \\phi - \\delta V)}{2 \\delta V}$。\n- **非线性求解器：** 牛顿法。\n- **解析基准（Grahame关系式）：** $C_{\\mathrm{diff}}^{\\mathrm{exact}} = \\sqrt{8 \\varepsilon k_B T c_{0} N_{\\mathrm{A}}} \\frac{e}{2 k_B T} \\cosh\\!\\left( \\frac{\\beta e \\Delta \\phi}{2} \\right)$。\n- **误差度量：** $E(h) = |C_{\\mathrm{diff}}^{\\mathrm{num}}(h) - C_{\\mathrm{diff}}^{\\mathrm{exact}}|$。\n- **收敛速率估计：** $p_{23} = \\ln(E(h_3) / E(h_2)) / \\ln(h_3 / h_2)$。\n- **常数和参数：** 所有物理常数、系统参数（$L$、$c_0$、$\\Delta \\phi$）、数值参数（$\\delta V$）以及三个测试用例的网格分辨率（$N_1, N_2, N_3$）都已明确提供。\n\n**1.2. 验证结论：**\n该问题是**有效的**。它在科学上基于已建立的物理理论（泊松-玻尔兹曼理论），在数学上是适定的（一个可解的非线性BVP），并且是客观的。所有必要的信息都已提供，且设置是内部一致的。该问题构成了计算科学中的一个标准的、非平凡的练习，要求实现并分析一种用于求解基于物理学的偏微分方程的数值方法。测试用例设计精良，不仅可以探测数值精度，还可以探测其潜在的物理近似（有限域与半无限域）。\n\n### 2. 方法论与求解设计\n\n问题的核心是求解静电势分布 $\\psi(x)$ 的一维泊松-玻尔兹曼BVP。该方程是非线性的，因此需要采用迭代数值方法。\n\n**2.1. 泊松-玻尔兹曼方程的离散化**\n空间域 $x \\in [0, L]$ 被离散化为一个均匀网格，包含 $N$ 个点，索引为 $i = 0, 1, \\dots, N-1$。网格点位于 $x_i = i h$，其中 $h = L/(N-1)$ 是网格间距。这些点上的电势表示为 $\\psi_i = \\psi(x_i)$。PB方程中的二阶导数在每个内部网格点（$i=1, \\dots, N-2$）处使用二阶中心差分公式近似：\n$$\n\\left. \\frac{d^2\\psi}{dx^2} \\right|_{x=x_i} \\approx \\frac{\\psi_{i+1} - 2\\psi_i + \\psi_{i-1}}{h^2}\n$$\n将此代入PB方程，我们得到一个关于 $N-2$ 个未知内部电势 $\\psi_1, \\dots, \\psi_{N-2}$ 的 $N-2$ 个非线性代数方程组：\n$$\nF_i(\\vec{\\psi}) = \\frac{\\psi_{i+1} - 2\\psi_i + \\psi_{i-1}}{h^2} - K \\sinh(\\beta e \\psi_i) = 0, \\quad \\text{for } i = 1, \\dots, N-2\n$$\n此处，$\\vec{\\psi}$ 表示内部电势向量 $(\\psi_1, \\dots, \\psi_{N-2})$，$K = \\frac{2 e c_{0} N_{\\mathrm{A}}}{\\varepsilon}$ 是一个常数。边界值由狄利克雷条件固定：$\\psi_0 = \\Delta \\phi$ 和 $\\psi_{N-1} = 0$。这些值被并入 $F_1$ 和 $F_{N-2}$ 的方程中。\n\n**2.2. 求解非线性系统的牛顿法**\n为了求解方程组 $\\vec{F}(\\vec{\\psi}) = 0$，我们采用牛顿法。从一个初始猜测 $\\vec{\\psi}^{(0)}$ 开始，通过以下更新规则迭代地改进解：\n$$\n\\vec{\\psi}^{(k+1)} = \\vec{\\psi}^{(k)} - \\left( J(\\vec{\\psi}^{(k)}) \\right)^{-1} \\vec{F}(\\vec{\\psi}^{(k)})\n$$\n其中 $J$ 是 $\\vec{F}$ 的雅可比矩阵，其元素为 $J_{ij} = \\partial F_i / \\partial \\psi_j$。在每次迭代中，求解线性系统 $J \\delta\\vec{\\psi} = -\\vec{F}$ 以获得更新向量 $\\delta\\vec{\\psi} = \\vec{\\psi}^{(k+1)} - \\vec{\\psi}^{(k)}$。该系统的雅可比矩阵是三对角的：\n- **对角线元素：** $J_{i,i} = \\frac{\\partial F_i}{\\partial \\psi_i} = -\\frac{2}{h^2} - K \\beta e \\cosh(\\beta e \\psi_i)$\n- **非对角线元素：** $J_{i, i-1} = \\frac{1}{h^2}$ 和 $J_{i, i+1} = \\frac{1}{h^2}$\n这种三对角结构使得线性系统可以在 $O(N)$ 时间内高效求解，为此我们使用 `scipy.linalg.solve_banded` 函数。迭代持续进行，直到更新向量的范数 $||\\delta\\vec{\\psi}||$ 小于指定的容差。线性分布 $\\psi_i^{(0)} = \\Delta \\phi (1 - x_i/L)$ 可作为一个合适的初始猜测。\n\n**2.3. 可观测量计算**\n一旦确定了给定外加电势 $\\Delta \\phi$ 下的电势分布 $\\psi_i$，就可以计算表面电荷密度 $\\sigma$。问题指定了一个用于计算电极表面（$x=0$）导数的二阶精度单边有限差分公式：\n$$\n\\sigma(\\Delta\\phi; h) = -\\varepsilon \\left. \\frac{d\\psi}{dx} \\right|_{x=0} \\approx -\\varepsilon \\left( \\frac{-3\\psi_0 + 4\\psi_1 - \\psi_2}{2h} \\right)\n$$\n然后，使用一个小的电压步长 $\\delta V$ 和二阶中心差分来数值近似微分电容 $C_{\\mathrm{diff}} = d\\sigma/d(\\Delta \\phi)$：\n$$\nC_{\\mathrm{diff}}^{\\mathrm{num}}(\\Delta \\phi; h, \\delta V) = \\frac{\\sigma(\\Delta \\phi + \\delta V; h) - \\sigma(\\Delta \\phi - \\delta V; h)}{2 \\delta V}\n$$\n这需要求解PB方程两次：一次是当外加电势为 $\\Delta \\phi + \\delta V$ 时，另一次是当外加电势为 $\\Delta \\phi - \\delta V$ 时。\n\n**2.4. 网格收敛性分析**\n任务的最后一部分是分析该格式的离散化误差。误差定义为数值结果与半无限系统的精确解析解（Grahame关系式）之间的绝对差值，$E(h) = |C_{\\mathrm{diff}}^{\\mathrm{num}}(h) - C_{\\mathrm{diff}}^{\\mathrm{exact}}|$。对于一个误差项满足 $E(h) \\approx C h^p$（其中 $p$ 是收敛阶）的数值格式，可以根据两个网格间距为 $h_a$ 和 $h_b$ 的结果来估计收敛速率 $p$：\n$$\np = \\frac{\\ln(E(h_a)/E(h_b))}{\\ln(h_a/h_b)}\n$$\n问题指定使用三个网格分辨率（$N_1, N_2, N_3$）进行此分析，对应的间距为 $h_1 > h_2 > h_3$，其中 $h_{i+1} \\approx h_i/2$。我们使用两个最密的网格计算速率 $p_{23}$。由于BVP和表面导数的有限差分格式都是二阶精度的，预期的收敛速率为 $p \\approx 2$。这在离散化误差是主要误差来源时成立。然而，如果存在显著的模型误差（例如，在计算域不够大时，将有限域模拟与半无限解析模型进行比较，如测试用例2所示），总误差 $E(h)$ 可能不会随 $h$ 减小，观测到的速率 $p$ 将偏离理论值，当误差饱和于由模型不匹配决定的常数值时，速率会趋近于0。\n\n下面的Python代码实现了这整个过程。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the grid refinement analysis for the given test cases.\n    \"\"\"\n\n    # --- Physical Constants ---\n    E_CHARGE = 1.602176634e-19  # Elementary charge (C)\n    K_B = 1.380649e-23          # Boltzmann constant (J/K)\n    N_A = 6.02214076e+23        # Avogadro's number (mol^-1)\n    EPSILON_0 = 8.8541878128e-12 # Vacuum permittivity (F/m)\n    EPSILON_R = 78.4            # Relative permittivity of water\n    TEMP = 298.0                # Absolute temperature (K)\n    \n    # Derived constants\n    EPSILON = EPSILON_0 * EPSILON_R\n    BETA = 1.0 / (K_B * TEMP)\n\n    def solve_pb_bvp(delta_phi, L, c0, N, tol=1e-12, max_iter=100):\n        \"\"\"\n        Solves the 1D Poisson-Boltzmann BVP using a finite-difference scheme\n        and Newton's method with a tridiagonal solver.\n        \"\"\"\n        h = L / (N - 1)\n        x = np.linspace(0, L, N)\n        num_interior = N - 2\n        \n        K = (2 * E_CHARGE * c0 * N_A) / EPSILON\n        \n        # Initial guess for interior psi: linear profile\n        psi_interior = delta_phi * (1 - x[1:-1] / L)\n\n        for _ in range(max_iter):\n            psi_full = np.concatenate(([delta_phi], psi_interior, [0.0]))\n            \n            # --- Assemble residual vector F ---\n            laplacian_term = (psi_full[2:] - 2 * psi_full[1:-1] + psi_full[:-2]) / (h * h)\n            sinh_term = K * np.sinh(BETA * E_CHARGE * psi_full[1:-1])\n            F = laplacian_term - sinh_term\n            \n            # --- Assemble Jacobian matrix J as a banded matrix ---\n            # For solve_banded, the matrix 'ab' has rows:\n            # Row 0: Super-diagonal (u)\n            # Row 1: Main diagonal (d)\n            # Row 2: Sub-diagonal (l)\n            ab = np.zeros((3, num_interior))\n            \n            # Main diagonal\n            ab[1, :] = -2.0 / (h * h) - K * BETA * E_CHARGE * np.cosh(BETA * E_CHARGE * psi_full[1:-1])\n            # Off-diagonals\n            off_diag_val = 1.0 / (h * h)\n            ab[0, 1:] = off_diag_val\n            ab[2, :-1] = off_diag_val\n            \n            # Solve the linear system J * delta_psi = -F\n            delta_psi = solve_banded((1, 1), ab, -F)\n            \n            psi_interior += delta_psi\n            \n            if np.linalg.norm(delta_psi)  tol:\n                break\n        \n        return np.concatenate(([delta_phi], psi_interior, [0.0]))\n\n    def calculate_sigma_num(psi_profile, h):\n        \"\"\"\n        Calculates surface charge density using a 2nd-order one-sided difference formula.\n        \"\"\"\n        psi0, psi1, psi2 = psi_profile[0], psi_profile[1], psi_profile[2]\n        dpsi_dx_at_0 = (-3.0 * psi0 + 4.0 * psi1 - psi2) / (2.0 * h)\n        return -EPSILON * dpsi_dx_at_0\n\n    def calculate_C_diff_num(delta_phi, delta_V, L, c0, N):\n        \"\"\"\n        Calculates numerical differential capacitance using a central difference.\n        \"\"\"\n        h = L / (N - 1)\n        \n        psi_plus = solve_pb_bvp(delta_phi + delta_V, L, c0, N)\n        sigma_plus = calculate_sigma_num(psi_plus, h)\n        \n        psi_minus = solve_pb_bvp(delta_phi - delta_V, L, c0, N)\n        sigma_minus = calculate_sigma_num(psi_minus, h)\n        \n        return (sigma_plus - sigma_minus) / (2.0 * delta_V)\n\n    def calculate_C_diff_exact(delta_phi, c0):\n        \"\"\"\n        Calculates the exact differential capacitance from the Grahame relation.\n        \"\"\"\n        prefactor = np.sqrt(8 * EPSILON * K_B * TEMP * c0 * N_A)\n        term1 = E_CHARGE / (2 * K_B * TEMP)\n        term2 = np.cosh(BETA * E_CHARGE * delta_phi / 2.0)\n        return prefactor * term1 * term2\n\n    # --- Test Cases ---\n    test_cases = [\n        {'L': 100e-9, 'c0': 100.0, 'delta_phi': 0.05, 'delta_V': 0.001, 'Ns': [65, 129, 257]},\n        {'L': 10e-9,  'c0': 0.1,   'delta_phi': 0.05, 'delta_V': 0.001, 'Ns': [65, 129, 257]},\n        {'L': 50e-9,  'c0': 10.0,  'delta_phi': 0.20, 'delta_V': 0.001, 'Ns': [65, 129, 257]},\n    ]\n\n    p23_results = []\n\n    for case in test_cases:\n        L, c0, delta_phi, delta_V, Ns = case.values()\n        \n        errors = []\n        hs = []\n        \n        c_exact = calculate_C_diff_exact(delta_phi, c0)\n        \n        for N in Ns:\n            h = L / (N - 1)\n            c_num = calculate_C_diff_num(delta_phi, delta_V, L, c0, N)\n            error = np.abs(c_num - c_exact)\n            errors.append(error)\n            hs.append(h)\n        \n        # Estimate convergence rate p_23 from the two finest grids\n        E3, E2 = errors[2], errors[1]\n        h3, h2 = hs[2], hs[1]\n        \n        # Handle the case where error is zero to avoid log(0)\n        if E2 == 0 or E3 == 0:\n            # If error becomes zero, means we've converged perfectly (unlikely)\n            # or something is wrong. A high rate indicates fast convergence.\n            p23 = np.inf \n        else:\n            p23 = np.log(E3 / E2) / np.log(h3 / h2)\n        \n        p23_results.append(p23)\n\n    # Format the final output as specified\n    print(f\"[{','.join([f'{r:.3f}' for r in p23_results])}]\")\n\nsolve()\n```"
        }
    ]
}