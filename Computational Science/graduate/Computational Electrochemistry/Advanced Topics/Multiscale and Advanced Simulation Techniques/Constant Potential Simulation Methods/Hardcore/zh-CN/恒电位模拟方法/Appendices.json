{
    "hands_on_practices": [
        {
            "introduction": "在深入研究复杂的恒电位模拟算法之前，通过一个经典的静电学问题来建立物理直觉至关重要。本练习利用镜像法，这是一个强大的解析工具，来求解一个点电荷在恒定电位导体表面附近的电势分布。通过完成此练习，您将亲手推导出导体表面如何通过感应出表面电荷来响应外部电场，从而精确地维持其整个表面的恒定电位。",
            "id": "4239505",
            "problem": "一个电荷量为 $q$ 的点电荷位于位置 $\\mathbf{r}_{q} = (0,0,a)$（其中 $a0$），该点电荷处于介电常数为 $\\varepsilon$ 的均匀介质中。半空间 $z \\le 0$ 被一个理想金属电极占据，该电极保持在恒定的静电势 $V_{0}$（狄利克雷条件），这与计算电化学中常用的恒定电势边界条件类似。在区域 $z0$ 内，除了该点电荷外，没有其他自由电荷。\n\n仅使用基本静电学关系，即泊松方程 $\\nabla^{2}\\Phi(\\mathbf{r}) = -\\rho(\\mathbf{r})/\\varepsilon$（其中 $\\rho(\\mathbf{r}) = q\\,\\delta(\\mathbf{r}-\\mathbf{r}_{q})$）以及理想导体在固定电势下的标准边界条件，按以下步骤进行：\n- 使用镜像法和静电学唯一性定理，构建在半空间 $z0$ 内满足 $\\Phi(x,y,0)=V_{0}$ 且当 $|\\mathbf{r}|\\to \\infty$ 时 $\\Phi(\\mathbf{r}) \\to V_{0}$ 的唯一静电势 $\\Phi(\\mathbf{r})$。\n- 根据你得到的 $\\Phi(\\mathbf{r})$，计算在 $z=0$ 处电极上的感应表面电荷密度 $\\sigma(\\rho)$，其中 $\\rho=\\sqrt{x^{2}+y^{2}}$ 是从电荷正下方的点 $(0,0,0)$ 算起的径向距离。使用边界关系 $\\sigma=\\varepsilon\\,\\mathbf{E}\\cdot\\hat{\\mathbf{n}}$，其中 $\\mathbf{E}=-\\nabla \\Phi$，$\\hat{\\mathbf{n}}$ 是从导体指向电解质区域（即 $+\\hat{\\mathbf{z}}$ 方向）的单位法向量。\n- 最后，将 $\\sigma(\\rho)$ 在整个 $z=0$ 平面上积分，得到电极上的总感应电荷 $Q_{\\mathrm{ind}}$。\n\n将你关于 $Q_{\\mathrm{ind}}$ 的最终答案表示为仅包含 $q$ 的单个闭合形式解析表达式。以库仑为单位报告总感应电荷。不要将中间表达式作为最终答案。",
            "solution": "对问题陈述进行分析后，认定其是有效的。这是一个静电学中的适定问题，它基于基本原理（泊松方程、镜像法），具有完备且一致的条件集。该问题在科学上是合理的，其术语是客观且定义精确的。\n\n该问题要求计算一个位于距离板 $a$ 处的点电荷 $q$ 在电势为 $V_{0}$ 的无限大导电板上感应出的总电荷。我们将使用镜像法来解决这个问题。\n\n首先，我们为半空间 $z0$ 构建静电势 $\\Phi(\\mathbf{r})$。该电势必须满足泊松方程 $\\nabla^{2}\\Phi = -q\\,\\delta(\\mathbf{r}-\\mathbf{r}_{q})/\\varepsilon$ 和边界条件 $\\Phi(x,y,0)=V_{0}$ 及当 $|\\mathbf{r}|\\to\\infty$ 时 $\\Phi(\\mathbf{r}) \\to V_{0}$。\n\n根据叠加原理，我们可以将电势 $\\Phi(\\mathbf{r})$ 表示为两个电势之和：$\\Phi(\\mathbf{r}) = \\Phi_{\\text{image}}(\\mathbf{r}) + \\Phi_{\\text{offset}}(\\mathbf{r})$。\n\n$1$. $\\Phi_{\\text{image}}(\\mathbf{r})$ 是解决接地金属板问题（即边界条件为 $\\Phi(x,y,0)=0$）的电势。对于位于 $\\mathbf{r}_{q} = (0,0,a)$ 的点电荷 $q$，我们在 $\\mathbf{r}_{q'} = (0,0,-a)$ 处放置一个镜像电荷 $q'=-q$。在 $z0$ 区域，电势是这两个电荷在介电常数为 $\\varepsilon$ 的均匀介质中产生的电势的叠加：\n$$\n\\Phi_{\\text{image}}(x,y,z) = \\frac{1}{4\\pi\\varepsilon} \\left( \\frac{q}{|\\mathbf{r} - \\mathbf{r}_{q}|} + \\frac{-q}{|\\mathbf{r} - \\mathbf{r}_{q'}|} \\right) = \\frac{q}{4\\pi\\varepsilon} \\left( \\frac{1}{\\sqrt{x^{2}+y^{2}+(z-a)^{2}}} - \\frac{1}{\\sqrt{x^{2}+y^{2}+(z+a)^{2}}} \\right)\n$$\n该电势在 $z0$ 区域满足 $\\nabla^{2}\\Phi_{\\text{image}} = -q\\,\\delta(\\mathbf{r}-\\mathbf{r}_{q})/\\varepsilon$，并且在 $z=0$ 平面上，有 $\\Phi_{\\text{image}}(x,y,0)=0$。\n\n$2$. $\\Phi_{\\text{offset}}(\\mathbf{r})$ 是一个在 $z0$ 区域满足拉普拉斯方程 $\\nabla^{2}\\Phi_{\\text{offset}}=0$ 并用于调整边界条件的电势。我们需要总电势在 $z=0$ 处为 $V_{0}$。我们选择 $\\Phi_{\\text{offset}}(\\mathbf{r}) = V_{0}$。这是一个常数电势，因此满足 $\\nabla^{2}V_{0}=0$，并提供了必要的偏移量。\n\n因此，$z0$ 区域的总电势为：\n$$\n\\Phi(x,y,z) = \\frac{q}{4\\pi\\varepsilon} \\left( \\frac{1}{\\sqrt{x^{2}+y^{2}+(z-a)^{2}}} - \\frac{1}{\\sqrt{x^{2}+y^{2}+(z+a)^{2}}} \\right) + V_{0}\n$$\n该电势满足问题的所有条件：在 $z=0$ 处，它简化为 $V_{0}$；当 $|\\mathbf{r}|\\to\\infty$ 时，它趋近于 $V_{0}$；并且在 $z0$ 区域，它满足针对单个电荷 $q$ 的泊松方程。根据唯一性定理，这是该电势的正确且唯一的解。\n\n接下来，我们计算在 $z=0$ 处电极上的感应表面电荷密度 $\\sigma$。其关系式为 $\\sigma = \\varepsilon\\,\\mathbf{E}\\cdot\\hat{\\mathbf{n}}$，其中 $\\mathbf{E} = -\\nabla\\Phi$，法向量 $\\hat{\\mathbf{n}}$ 从导体指向 $z0$ 区域，因此 $\\hat{\\mathbf{n}} = \\hat{\\mathbf{z}}$。于是，$\\sigma = \\varepsilon E_{z}|_{z=0}$。\n\n电场为 $\\mathbf{E} = -\\nabla\\Phi = -\\nabla(\\Phi_{\\text{image}} + V_{0}) = -\\nabla\\Phi_{\\text{image}}$，因为常数的梯度为零。常数电势 $V_{0}$ 对电场或感应电荷密度没有贡献。\n电场的z分量是：\n$$\nE_{z} = -\\frac{\\partial\\Phi}{\\partial z} = -\\frac{\\partial\\Phi_{\\text{image}}}{\\partial z} = -\\frac{q}{4\\pi\\varepsilon} \\frac{\\partial}{\\partial z} \\left( (x^{2}+y^{2}+(z-a)^{2})^{-1/2} - (x^{2}+y^{2}+(z+a)^{2})^{-1/2} \\right)\n$$\n进行微分运算：\n$$\nE_{z} = -\\frac{q}{4\\pi\\varepsilon} \\left( -\\frac{z-a}{(x^{2}+y^{2}+(z-a)^{2})^{3/2}} + \\frac{z+a}{(x^{2}+y^{2}+(z+a)^{2})^{3/2}} \\right)\n$$\n我们在导体表面 $z=0$ 处计算 $E_{z}$ 的值：\n$$\nE_{z}(x,y,0) = -\\frac{q}{4\\pi\\varepsilon} \\left( \\frac{a}{(x^{2}+y^{2}+a^{2})^{3/2}} + \\frac{a}{(x^{2}+y^{2}+a^{2})^{3/2}} \\right) = -\\frac{2aq}{4\\pi\\varepsilon(x^{2}+y^{2}+a^{2})^{3/2}}\n$$\n$$\nE_{z}(x,y,0) = -\\frac{aq}{2\\pi\\varepsilon(x^{2}+y^{2}+a^{2})^{3/2}}\n$$\n于是，表面电荷密度 $\\sigma$ 为：\n$$\n\\sigma(x,y) = \\varepsilon E_{z}(x,y,0) = \\varepsilon \\left( -\\frac{aq}{2\\pi\\varepsilon(x^{2}+y^{2}+a^{2})^{3/2}} \\right) = -\\frac{aq}{2\\pi(x^{2}+y^{2}+a^{2})^{3/2}}\n$$\n用平面上的径向距离 $\\rho = \\sqrt{x^{2}+y^{2}}$ 表示，电荷密度为：\n$$\n\\sigma(\\rho) = -\\frac{aq}{2\\pi(\\rho^{2}+a^{2})^{3/2}}\n$$\n最后，我们将 $\\sigma(\\rho)$ 在整个 $z=0$ 平面上积分，以求得总感应电荷 $Q_{\\mathrm{ind}}$。我们使用极坐标 $(\\rho, \\phi)$，其中面积微元为 $dA = \\rho\\,d\\rho\\,d\\phi$。\n$$\nQ_{\\mathrm{ind}} = \\iint_{\\text{plane}} \\sigma(\\rho) \\, dA = \\int_{0}^{2\\pi} \\int_{0}^{\\infty} \\left( -\\frac{aq}{2\\pi(\\rho^{2}+a^{2})^{3/2}} \\right) \\rho\\,d\\rho\\,d\\phi\n$$\n对 $\\phi$ 从 $0$ 到 $2\\pi$ 的积分得到一个因子 $2\\pi$：\n$$\nQ_{\\mathrm{ind}} = 2\\pi \\int_{0}^{\\infty} -\\frac{aq}{2\\pi(\\rho^{2}+a^{2})^{3/2}} \\rho\\,d\\rho = -aq \\int_{0}^{\\infty} \\frac{\\rho}{(\\rho^{2}+a^{2})^{3/2}} d\\rho\n$$\n为求解剩余的积分，我们使用换元法，令 $u = \\rho^{2}+a^{2}$，则 $du = 2\\rho\\,d\\rho$，这意味着 $\\rho\\,d\\rho = \\frac{1}{2}du$。$u$ 的积分限从 $a^{2}$（当 $\\rho=0$ 时）到 $\\infty$（当 $\\rho\\to\\infty$ 时）。\n$$\n\\int_{0}^{\\infty} \\frac{\\rho}{(\\rho^{2}+a^{2})^{3/2}} d\\rho = \\int_{a^{2}}^{\\infty} \\frac{1}{u^{3/2}} \\frac{1}{2}du = \\frac{1}{2} \\left[ \\frac{u^{-1/2}}{-1/2} \\right]_{a^{2}}^{\\infty} = -[u^{-1/2}]_{a^{2}}^{\\infty}\n$$\n$$\n= -\\left( \\lim_{u\\to\\infty} \\frac{1}{\\sqrt{u}} - \\frac{1}{\\sqrt{a^{2}}} \\right) = -(0 - \\frac{1}{a}) = \\frac{1}{a}\n$$\n将此结果代回 $Q_{\\mathrm{ind}}$ 的表达式中：\n$$\nQ_{\\mathrm{ind}} = -aq \\left(\\frac{1}{a}\\right) = -q\n$$\n电极上的总感应电荷为 $-q$。正如预期的那样，这个结果与距离 $a$、介质的介电常数 $\\varepsilon$ 以及恒定电势 $V_{0}$ 无关。",
            "answer": "$$\\boxed{-q}$$"
        },
        {
            "introduction": "恒电位模拟的必要性植根于热力学。大多数标准计算方法在固定电荷（正则系综）下进行，而电化学实验通常在固定电位（巨正则系综）下进行。本练习将指导您完成一个关键的理论推导，通过勒让德变换，将固定电荷系综下的自由能与恒电位系综下的自由能联系起来。理解这个修正项是正确解释和比较模拟与实验结果的基础。",
            "id": "4239531",
            "problem": "一个处于恒定温度 $T$ 和体积 $V$ 下的等温电化学体系，包含一个净电荷为 $Q$、静电势（相对于外部参考）为 $\\Psi$ 的电极。该体系的亥姆霍兹自由能为 $F(T,V,\\{N_i\\},Q)$，其中 $\\{N_i\\}$ 表示在所研究的反应过程中保持不变的电解质中所有化学物种的粒子数集合。一个反应在相同的 $T$、$V$ 和 $\\{N_i\\}$ 条件下，将体系从初始态 $1$ 转变为最终态 $2$，但电极电荷发生变化，变化量为 $\\Delta Q = Q_2 - Q_1 \\neq 0$。在定电荷模拟中，反应自由能计算为 $\\Delta F_Q = F(T,V,\\{N_i\\},Q_2) - F(T,V,\\{N_i\\},Q_1)$，其中初始态和最终态分别保持指定的电荷 $Q_1$ 和 $Q_2$。\n\n在恒电势模拟方法中，合适的热力学势以静电势 $\\Psi$ 为其自然变量，这是通过对共轭对 $(Q,\\Psi)$ 进行勒让德变换得到的。仅从包含该体系电功项的基本热力学微分式出发，推导为获得恒定电势 $\\Psi$ 下的反应自由能（记为 $\\Delta G_{\\Psi}$）而必须加到定电荷反应自由能 $\\Delta F_Q$ 上的修正项的解析表达式。将最终答案表示为仅含 $\\Psi$ 和 $\\Delta Q$ 的单个闭合形式表达式。不要引入任何数值。最终答案仅提供修正项（即必须加到 $\\Delta F_Q$ 上的量）。",
            "solution": "首先对问题进行验证，以确保其具有科学依据、是良定的且客观的。\n\n### 第 1 步：提取已知条件\n- **体系：**一个处于恒定温度 $T$ 和体积 $V$ 下的等温电化学体系。\n- **状态变量：**电极净电荷 $Q$，电极静电势 $\\Psi$。\n- **热力学势：**亥姆霍兹自由能 $F(T,V,\\{N_i\\},Q)$，其中 $\\{N_i\\}$ 是固定的粒子数。\n- **过程：**一个从初始态 1 到最终态 2 的反应。\n- **过程约束：**反应在恒定的 $T$、$V$ 和 $\\{N_i\\}$ 条件下发生。\n- **电荷变化：**电极上的电荷变化量为 $\\Delta Q = Q_2 - Q_1 \\neq 0$。\n- **定电荷自由能：**定电荷系综中的反应自由能由 $\\Delta F_Q = F(T,V,\\{N_i\\},Q_2) - F(T,V,\\{N_i\\},Q_1)$ 给出。\n- **恒电势下的势：**通过对 $F$ 关于共轭对 $(Q,\\Psi)$ 进行勒让德变换，得到一个新的热力学势，该势与恒电势模拟相关。我们将其记为 $G_{\\Psi}$。\n- **目标：**推导为获得恒定电势 $\\Psi$ 下的反应自由能（记为 $\\Delta G_{\\Psi}$）而必须加到 $\\Delta F_Q$ 上的修正项的解析表达式。修正项的最终答案应以 $\\Psi$ 和 $\\Delta Q$ 表示。\n\n### 第 2 步：使用提取的已知条件进行验证\n- **科学依据：**该问题基于化学热力学和静电学的基本原理。使用勒让德变换在热力学系综之间切换（从定电荷到恒电势）是统计力学中的一个标准且严谨的程序。这些概念在物理上和数学上都是合理的。\n- **良定性：**问题定义清晰。它要求基于一个明确的起点（基本热力学微分式）和一个指定的数学操作（勒让德变换），推导一个特定的量（$\\Delta G_{\\Psi} - \\Delta F_Q$）。预期会有一个唯一的解析解。\n- **客观性：**语言正式、精确且无歧义。所有术语如“亥姆霍兹自由能”、“勒让德变换”和“共轭对”在物理学和化学中都有标准的、客观的含义。\n\n### 第 3 步：结论与行动\n问题被判定为**有效**。这是计算电化学中的一个标准推导。现在开始推导解答。\n\n出发点是开放电化学体系内能 $U$ 的基本方程，该方程包含了改变电极电荷所需的可逆电功项 $\\Psi dQ$。对于一个可逆过程，热力学第一定律为：\n$$dU = TdS - PdV + \\sum_i \\mu_i dN_i + \\Psi dQ$$\n其中 $T$ 是温度，$S$ 是熵，$P$ 是压力，$V$ 是体积，$\\mu_i$ 是化学势，$N_i$ 是粒子数。\n\n亥姆霍兹自由能 $F$ 定义为 $F = U - TS$。其全微分为：\n$$dF = dU - d(TS) = dU - TdS - SdT$$\n代入 $dU$ 的表达式：\n$$dF = (TdS - PdV + \\sum_i \\mu_i dN_i + \\Psi dQ) - TdS - SdT$$\n$$dF = -SdT - PdV + \\Psi dQ + \\sum_i \\mu_i dN_i$$\n这是亥姆霍兹自由能 $F(T,V,Q,\\{N_i\\})$ 作为其自然变量函数的基本微分式。从此表达式中，我们可以确定电极电势 $\\Psi$ 是 $F$ 在恒定 $T$、$V$ 和 $\\{N_i\\}$ 条件下对电荷 $Q$ 的偏导数：\n$$\\Psi = \\left(\\frac{\\partial F}{\\partial Q}\\right)_{T,V,\\{N_i\\}}$$\n这证实了 $Q$ 和 $\\Psi$ 构成一对热力学共轭变量。\n\n问题要求转换到一个以电势 $\\Psi$ 而非电荷 $Q$ 为自变量的系综。这通过勒让德变换来实现。我们定义一个新的热力学势，记为 $G_{\\Psi}$，其表达式为：\n$$G_{\\Psi} = F - \\Psi Q$$\n这个新势的全微分为：\n$$dG_{\\Psi} = dF - d(\\Psi Q) = dF - \\Psi dQ - Q d\\Psi$$\n代入推导出的 $dF$ 表达式：\n$$dG_{\\Psi} = (-SdT - PdV + \\Psi dQ + \\sum_i \\mu_i dN_i) - \\Psi dQ - Q d\\Psi$$\n包含 $\\Psi dQ$ 的项相互抵消，得到：\n$$dG_{\\Psi} = -SdT - PdV - Q d\\Psi + \\sum_i \\mu_i dN_i$$\n这证实了 $G_{\\Psi}$ 的自然变量是 $T$、$V$、$\\Psi$ 和 $\\{N_i\\}$。因此，$G_{\\Psi}$ 是适用于恒定温度、体积和电极电势体系的合适热力学势。\n\n恒电势下的反应自由能 $\\Delta G_{\\Psi}$ 是反应从状态 1 到状态 2 过程中 $G_{\\Psi}$ 的变化量。该反应在恒定的 $T$、$V$、$\\{N_i\\}$ 和一个固定的电势 $\\Psi$ 下发生。因此，我们可以将 $G_{\\Psi}$ 的变化量写为：\n$$\\Delta G_{\\Psi} = G_{\\Psi,2} - G_{\\Psi,1}$$\n使用定义 $G_{\\Psi} = F - \\Psi Q$，我们可以用初始态和最终态的亥姆霍兹自由能 $F$ 和电荷 $Q$ 来表示这个差值：\n$$\\Delta G_{\\Psi} = (F_2 - \\Psi Q_2) - (F_1 - \\Psi Q_1)$$\n由于在整个过程中电势 $\\Psi$ 保持恒定，我们可以重新组合这些项：\n$$\\Delta G_{\\Psi} = (F_2 - F_1) - \\Psi(Q_2 - Q_1)$$\n我们识别出问题陈述中给出的项：\n- 定电荷反应自由能：$\\Delta F_Q = F_2 - F_1$\n- 电极电荷的变化量：$\\Delta Q = Q_2 - Q_1$\n\n将这些定义代入 $\\Delta G_{\\Psi}$ 的方程中：\n$$\\Delta G_{\\Psi} = \\Delta F_Q - \\Psi \\Delta Q$$\n问题要求的是为获得 $\\Delta G_{\\Psi}$ 而必须加到 $\\Delta F_Q$ 上的修正项。如果我们将此修正项记为 $C$，我们就是在寻找以下方程中 $C$ 的值：\n$$\\Delta G_{\\Psi} = \\Delta F_Q + C$$\n通过将其与推导出的关系式进行比较，我们可以直接确定修正项：\n$$C = -\\Psi \\Delta Q$$\n这是修正项的解析表达式，用恒定电势 $\\Psi$ 和电荷变化量 $\\Delta Q$ 表示。",
            "answer": "$$\\boxed{-\\Psi \\Delta Q}$$"
        },
        {
            "introduction": "将理论付诸实践是计算科学的核心。本最终练习要求您从头开始，实现一个在混合实空间/傅里叶空间中求解泊松方程的数值求解器，并应用专门为平板几何结构设计的Martyna–Tuckerman边界条件。这个实践项目不仅仅是一个编程任务，它综合了前面练习中的物理和热力学概念，让您能够构建一个真正能够模拟电化学界面上恒电位控制的计算工具。",
            "id": "4239452",
            "problem": "实现一个自包含程序，使用 Martyna–Tuckerman 边界条件求解板层几何中的静电势，并演示在金属边界上的恒定电势控制。其物理和算法设置如下。\n\n考虑一个三维域，该域在平面内方向上是周期性的，在表面法线方向上是有限的。设平面内坐标为 $x$ 和 $y$，表面法线坐标为 $z$。该域在 $x$、$y$ 和 $z$ 方向上的长度分别为 $L_x$、$L_y$ 和 $L_z$，并在一个具有 $N_x$、$N_y$ 和 $N_z$ 个点的均匀网格上进行离散化。平面内方向 $x$ 和 $y$ 是周期性的。金属表面位于 $z=0$ 处，真空朝 $z=L_z$ 方向延伸。\n\n静电势 $\\phi(x,y,z)$ 满足从线性电介质中的高斯定律推导出的泊松方程：\n$$\n\\nabla \\cdot \\mathbf{E} = \\frac{\\rho(x,y,z)}{\\varepsilon_0}, \\quad \\mathbf{E} = -\\nabla \\phi(x,y,z),\n$$\n即\n$$\n\\nabla^2 \\phi(x,y,z) = -\\frac{\\rho(x,y,z)}{\\varepsilon_0},\n$$\n其中 $\\rho(x,y,z)$ 是自由电荷密度，$\\varepsilon_0$ 是真空介电常数。对于在恒定电势控制下位于 $z=0$ 处的理想金属边界，边界条件强制施加一个空间均匀的电势，其值等于预设值 $V_0$，即：\n$$\n\\phi(x,y,0) = V_0,\n$$\n并且出现在金属上的表面电荷密度 $\\sigma(x,y)$ 与法向电场的关系如下：\n$$\n\\sigma(x,y) = -\\varepsilon_0 \\left.\\frac{\\partial \\phi}{\\partial z}\\right|_{z=0^+}.\n$$\n对于一个嵌入在 $zL_z$ 的真空中的板层体系，使用 Martyna–Tuckerman 边界条件来防止非周期性方向上周期性镜像之间的伪相互作用。在混合空间中，通过在平面内坐标上使用二维傅里叶变换，每个具有波矢 $\\mathbf{k}=(k_x,k_y)$ 和模长 $|\\mathbf{k}|$ 的平面内傅里叶分量都满足一个沿 $z$ 方向的一维方程：\n$$\n\\frac{d^2 \\phi_{\\mathbf{k}}(z)}{dz^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z) = -\\frac{\\rho_{\\mathbf{k}}(z)}{\\varepsilon_0},\n$$\n其边界条件为\n$$\n\\phi_{\\mathbf{k}}(z=0) = \\begin{cases}\nV_0  \\text{if } |\\mathbf{k}|=0,\\\\\n0  \\text{if } |\\mathbf{k}|0,\n\\end{cases}\n\\qquad\n\\left.\\frac{d \\phi_{\\mathbf{k}}}{dz}\\right|_{z=L_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(L_z) = 0.\n$$\n左边界条件强制施加一个与 $x$ 和 $y$ 无关的恒定金属电势。右边界条件是一个罗宾条件，确保当 $|\\mathbf{k}|0$ 时电势在真空中呈指数衰减；对于零模式 $|\\mathbf{k}|=0$，它简化为零法向导数条件。\n\n您的任务是实现一个求解器，在给定 $\\rho(x,y,z)$ 的情况下，使用 $x$ 和 $y$ 方向的二维离散傅里叶变换以及 $z$ 方向的二阶有限差分格式来求解上述关于 $\\phi(x,y,z)$ 的边值问题，然后演示在 $z=0$ 处的电势控制以及金属边界上正确的感应表面电荷。\n\n算法要求：\n- 对平面内方向 $x$ 和 $y$ 使用二维离散傅里叶变换，以获得由周期性晶胞给出的所有离散波矢 $\\mathbf{k}$ 对应的 $\\rho_{\\mathbf{k}}(z)$。设 $k_x$ 和 $k_y$ 是与网格相关的离散波矢（单位：弧度/米）。\n- 对于每个模长为 $|\\mathbf{k}|$ 的平面内模式，使用针对内部点的二阶中心有限差分格式并恰当结合边界条件，求解沿 $z$ 方向的一维问题。$z$ 方向的网格间距为 $h_z = L_z/(N_z-1)$。对于索引为 $i\\in\\{1,2,\\dots,N_z-2\\}$ 的内部点 $z_i$，微分方程的有限差分近似为：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{i-1}) - 2\\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1})}{h_z^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z_i) = -\\frac{\\rho_{\\mathbf{k}}(z_i)}{\\varepsilon_0}.\n$$\n应用如上所述的左边界狄利克雷条件 $\\phi_{\\mathbf{k}}(z_0)$。在右边界 $z_{N_z-1}=L_z$ 处，通过一阶前向差分公式施加罗宾条件：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{N_z-1}) - \\phi_{\\mathbf{k}}(z_{N_z-2})}{h_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(z_{N_z-1}) = 0.\n$$\n- 为每个 $\\mathbf{k}$ 组装并求解所得的三对角线性系统以获得 $\\phi_{\\mathbf{k}}(z)$，然后通过二维傅里叶逆变换重构 $\\phi(x,y,z)$。\n\n验证指标：\n- 金属边界处的恒定电势控制：重构 $\\phi(x,y,z)$ 后，测量边界电势与设定值的最大绝对偏差，定义为：\n$$\n\\Delta V = \\max_{x,y} \\left| \\phi(x,y,0) - V_0 \\right|.\n$$\n以伏特为单位报告此量。\n- 金属边界处的电荷平衡：通过对 $z=0^+$ 处的法向电场进行积分来计算金属上的感应表面电荷，\n$$\nQ_{\\text{ind}} = \\iint \\sigma(x,y) \\, dx\\,dy = -\\epsilon_0 \\iint \\left.\\frac{\\partial \\phi}{\\partial z}\\right|_{z=0^+} \\, dx\\,dy,\n$$\n其中导数在边界处使用一阶前向差分 $(\\phi(x,y,h_z)-\\phi(x,y,0))/h_z$ 进行近似。计算域内的总自由电荷，\n$$\nQ_{\\text{free}} = \\iiint \\rho(x,y,z) \\, dx\\,dy\\,dz.\n$$\n定义电荷平衡误差\n$$\n\\Delta Q = \\left| Q_{\\text{ind}} + Q_{\\text{free}} \\right|.\n$$\n以库仑为单位报告此量。\n\n物理单位：\n- 使用国际单位制（SI）：长度单位为米，电荷密度单位为库仑/立方米，电势单位为伏特，真空介电常数 $\\varepsilon_0$ 单位为法拉/米。\n\n测试套件：\n为以下四个测试用例实现求解器，以检验正常路径、电中性、零电荷和电荷靠近真空边界的情况。对于所有测试用例，使用 $L_x=L_y=L_z=4.0\\times 10^{-9}\\,\\text{m}$，$N_x=N_y=32$，以及 $N_z=64$。\n\n1. 正常路径：一个总电荷为 $Q=1.0\\times 10^{-18}\\,\\text{C}$ 的三维高斯自由电荷分布，中心位于 $(x_c,y_c,z_c)=(L_x/2,L_y/2,1.0\\times 10^{-9}\\,\\text{m})$，宽度为 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.1\\,\\text{V}$。对高斯函数进行归一化，使其在离散域上的积分恰好等于 $Q$。\n2. 电中性偶极子：两个大小相等、符号相反的高斯电荷，$Q_1=+5.0\\times 10^{-19}\\,\\text{C}$ 位于 $(L_x/2,L_y/2,1.0\\times 10^{-9}\\,\\text{m})$，$Q_2=-5.0\\times 10^{-19}\\,\\text{C}$ 位于 $(L_x/2,L_y/2,1.4\\times 10^{-9}\\,\\text{m})$，宽度为 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.0\\,\\text{V}$。将每个高斯函数归一化至其指定的总电荷。\n3. 零电荷：无自由电荷，$\\rho(x,y,z)=0$，且 $V_0=-0.2\\,\\text{V}$。\n4. 靠近真空的电荷：一个总电荷为 $Q=1.0\\times 10^{-18}\\,\\text{C}$ 的高斯电荷，中心位于 $(L_x/2,L_y/2,3.5\\times 10^{-9}\\,\\text{m})$，宽度为 $\\sigma_x=\\sigma_y=\\sigma_z=0.3\\times 10^{-9}\\,\\text{m}$，且 $V_0=0.05\\,\\text{V}$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个逗号分隔的列表，列表内容为每个测试用例的结果。每个结果本身也是一个逗号分隔的列表，包含两个浮点数，顺序为 $[\\Delta V,\\Delta Q]$，即：\n$$\n\\text{Output: } \\left[ [\\Delta V_1,\\Delta Q_1], [\\Delta V_2,\\Delta Q_2], [\\Delta V_3,\\Delta Q_3], [\\Delta V_4,\\Delta Q_4] \\right].\n$$\n所有 $\\Delta V$ 值必须以伏特为单位报告，所有 $\\Delta Q$ 值必须以库仑为单位报告。程序必须是自包含的，不接受任何输入，并使用指定的库。",
            "solution": "用户要求实现一个用于板层几何的恒定电势泊松求解器，该求解器使用 Martyna–Tuckerman 边界条件。该问题在科学上是适定的，并为数值求解提供了所有必要信息。所采用的方法是一种混合方法：在周期性的平面内方向上使用二维傅里叶变换，在受限的法线方向上使用有限差分法。\n\n### 1. 问题表述与策略\n\n该物理系统由泊松方程 $\\nabla^2 \\phi = -\\rho/\\varepsilon_0$ 控制，作用于一个在 $x$ 和 $y$ 方向上周期性、在 $z$ 方向上有限（范围从 $z=0$到 $z=L_z$）的域中。位于 $z=0$ 的金属电极保持在恒定电势 $\\phi(x,y,0) = V_0$。在另一个边界 $z=L_z$ 处，假设静电场衰减至真空中，这通过 Martyna–Tuckerman 边界条件进行建模。\n\n解决这个边值问题的策略是利用 $x-y$ 平面内的周期性。通过应用二维傅里叶变换，\n$$\n\\phi_{\\mathbf{k}}(z) = \\frac{1}{L_x L_y} \\iint \\phi(x,y,z) e^{-i(k_x x + k_y y)} \\,dx\\,dy,\n$$\n这个三维偏微分方程（PDE）被转换为一组针对每个平面内波矢 $\\mathbf{k}=(k_x, k_y)$ 的独立一维常微分方程（ODE）：\n$$\n\\frac{d^2 \\phi_{\\mathbf{k}}(z)}{dz^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z) = -\\frac{\\rho_{\\mathbf{k}}(z)}{\\varepsilon_0}.\n$$\n边界条件同样也被变换。$z=0$ 处的恒定电势条件只影响零频模式（$|\\mathbf{k}|=0$）：\n$$\n\\phi_{\\mathbf{k}}(z=0) = \\begin{cases} V_0  \\text{if } |\\mathbf{k}|=0, \\\\ 0  \\text{if } |\\mathbf{k}|0. \\end{cases}\n$$\n$z=L_z$ 处的 Martyna–Tuckerman 条件在每个傅里叶分量上变为一个罗宾型边界条件：\n$$\n\\left.\\frac{d \\phi_{\\mathbf{k}}}{dz}\\right|_{z=L_z} + |\\mathbf{k}| \\, \\phi_{\\mathbf{k}}(L_z) = 0.\n$$\n\n### 2. 数值离散化与求解\n\n算法的核心是为计算网格所支持的每个离散波矢 $\\mathbf{k}$ 求解一维边值问题。在 $z$ 方向上一个包含 $N_z$ 个点、间距为 $h_z = L_z/(N_z-1)$ 的均匀网格上，采用二阶有限差分格式。\n\n对于内部网格点 $z_i$（其中 $i \\in \\{1, 2, \\dots, N_z-2\\}$），该常微分方程近似为：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{i-1}) - 2\\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1})}{h_z^2} - |\\mathbf{k}|^2 \\phi_{\\mathbf{k}}(z_i) = -\\frac{\\rho_{\\mathbf{k}}(z_i)}{\\varepsilon_0}.\n$$\n整理各项，我们为每个内部点得到一个线性方程：\n$$\n\\phi_{\\mathbf{k}}(z_{i-1}) + \\left(-2 - |\\mathbf{k}|^2 h_z^2\\right) \\phi_{\\mathbf{k}}(z_i) + \\phi_{\\mathbf{k}}(z_{i+1}) = -\\frac{h_z^2}{\\varepsilon_0}\\rho_{\\mathbf{k}}(z_i).\n$$\n左边界的电势 $\\phi_{\\mathbf{k}}(z_0)$ 由狄利克雷条件给出，是已知的。在 $i=1$ 的方程中，该项被移到等号右侧。\n\n位于 $z=L_z=z_{N_z-1}$ 的罗宾边界条件使用一阶后向差分对导数进行离散化，正如问题陈述中的公式所指定（尽管其名称为“前向差分”）：\n$$\n\\frac{\\phi_{\\mathbf{k}}(z_{N_z-1}) - \\phi_{\\mathbf{k}}(z_{N_z-2})}{h_z} + |\\mathbf{k}| \\phi_{\\mathbf{k}}(z_{N_z-1}) = 0,\n$$\n这给出了一个用 $\\phi_{\\mathbf{k}}(z_{N_z-2})$ 表示 $\\phi_{\\mathbf{k}}(z_{N_z-1})$ 的表达式：\n$$\n\\phi_{\\mathbf{k}}(z_{N_z-1}) = \\frac{\\phi_{\\mathbf{k}}(z_{N_z-2})}{1 + |\\mathbf{k}| h_z}.\n$$\n将此关系代入最后一个内部点 $i=N_z-2$ 的有限差分方程中。这次代入消除了作为未知数的 $\\phi_{\\mathbf{k}}(z_{N_z-1})$，并方便地保持了关于未知数 $\\phi_{\\mathbf{k}}(z_1), \\dots, \\phi_{\\mathbf{k}}(z_{N_z-2})$ 的线性系统的三对角结构。所得系统具有一个对角占优的三对角矩阵，可以被高效且准确地求解。\n\n在解出 $i=1, \\dots, N_z-2$ 的 $\\phi_{\\mathbf{k}}(z_i)$ 后，右边界的值 $\\phi_{\\mathbf{k}}(z_{N_z-1})$ 由上述关系确定。对每个离散波矢 $\\mathbf{k}$ 重复此过程。\n\n### 3. 重构与验证\n\n一旦计算出所有 $\\mathbf{k}$ 对应的电势 $\\phi_{\\mathbf{k}}(z)$，就可以通过对平面内波矢进行二维离散傅里叶逆变换来重构完整的三维电势 $\\phi(x,y,z)$。\n\n解通过两个指标进行验证：\n1.  **恒定电势控制 ($\\Delta V$)**：计算 $z=0$ 平面上计算出的电势与目标电势 $V_0$ 的最大偏差。一个理想的求解器将产生接近机器精度的 $\\Delta V$。\n    $$\n    \\Delta V = \\max_{x,y} \\left| \\phi(x,y,0) - V_0 \\right|.\n    $$\n2.  **电荷平衡 ($\\Delta Q$)**：此指标验证整个系统的高斯定律。金属表面上感应的总电荷 $Q_{\\text{ind}}$ 必须与模拟单元中的总自由电荷 $Q_{\\text{free}}$ 相平衡。感应电荷通过对表面法向电场分量进行积分来计算：\n    $$\n    Q_{\\text{ind}} = -\\varepsilon_0 \\iint_{z=0} \\frac{\\partial \\phi}{\\partial z} \\,dx\\,dy \\approx -\\varepsilon_0 A_{xy} \\sum_{i,j} \\frac{\\phi(x_i,y_j,h_z) - \\phi(x_i,y_j,0)}{h_z},\n    $$\n    总自由电荷 $Q_{\\text{free}}$ 是通过沿 $z$ 轴使用梯形法则对电荷密度 $\\rho(x,y,z)$ 在整个域体积上积分来计算的。于是，电荷平衡误差为：\n    $$\n    \\Delta Q = \\left| Q_{\\text{ind}} + Q_{\\text{free}} \\right|.\n    $$\n对于电中性系统，如果 $Q_{\\text{free}}$ 为零，则 $Q_{\\text{ind}}$ 应为零。对于具有净电荷的系统，金属表面充当镜像电荷平面，$Q_{\\text{ind}}$ 应与 $Q_{\\text{free}}$ 完全平衡。\n\n实现过程首先为每个测试用例定义网格和电荷分布。对于高斯分布，在离散网格上执行仔细的归一化，以确保总电荷与指定值匹配。然后，求解器的核心部分执行如上所述的傅里叶空间分解、一维求解和实空间重构。",
            "answer": "```python\nimport numpy as np\nfrom scipy.linalg import solve_banded\n\n# Physical Constants\nEPSILON_0 = 8.854187817e-12  # Vacuum permittivity in F/m\n\ndef generate_gaussian(grid_coords, center, sigma, Q, dV, Ls):\n    \"\"\"\n    Generates a 3D Gaussian charge density on a grid, normalized to a total charge Q.\n    \"\"\"\n    x, y, z = grid_coords\n    xc, yc, zc = center\n    sx, sy, sz = sigma\n    Lx, Ly = Ls\n    \n    # Handle periodic boundaries for in-plane-directions\n    dx = np.abs(x - xc)\n    dy = np.abs(y - yc)\n    \n    if Lx > 0:\n        dx = np.minimum(dx, Lx - dx)\n    if Ly > 0:\n        dy = np.minimum(dy, Ly - dy)\n\n    gauss = np.exp(-0.5 * ((dx / sx)**2 + (dy / sy)**2 + ((z - zc) / sz)**2))\n    \n    # Normalize on the discrete grid\n    current_q = np.sum(gauss) * dV\n    if np.abs(current_q) > 1e-30:\n        rho = (Q / current_q) * gauss\n    else: # Avoid division by zero if total charge is zero anyway\n        rho = np.zeros_like(gauss)\n        \n    return rho\n\ndef solve_1d_bvp(rho_k, k_mag, v0_k, hz, epsilon0, Nz):\n    \"\"\"\n    Solves the 1D BVP for a single k-vector.\n    d^2(phi)/dz^2 - k^2 * phi = -rho/epsilon0\n    \"\"\"\n    if Nz  3:\n        # Trivial cases not applicable for this problem's parameters\n        phi_k = np.zeros_like(rho_k)\n        if Nz > 0:\n            phi_k[0] = v0_k\n        return phi_k\n\n    k_hz = k_mag * hz\n    \n    # System size is Nz-2 for unknowns phi_1, ..., phi_{Nz-2}\n    M = Nz - 2\n    \n    # Tridiagonal matrix in banded format (l=1, u=1)\n    # ab[0,:] = super-diagonal (u)\n    # ab[1,:] = main-diagonal\n    # ab[2,:] = sub-diagonal (l)\n    ab = np.zeros((3, M))\n    \n    # Diagonals\n    d = -2.0 - k_hz**2\n    ab[0, 1:] = 1.0\n    ab[1, :] = d\n    ab[2, :-1] = 1.0\n    \n    # Modify last diagonal element due to Robin BC at z=Lz\n    # phi_{N-1} = phi_{N-2} / (1 + |k|*hz)\n    # Eq for N-2: phi_{N-3} + d*phi_{N-2} + phi_{N-1} = rhs\n    # -> phi_{N-3} + (d + 1/(1+|k|hz))*phi_{N-2} = rhs\n    if (1.0 + k_hz) > 1e-12:\n        ab[1, -1] += 1.0 / (1.0 + k_hz)\n    else: # k=0 case\n        ab[1, -1] += 1.0\n\n    # Right-hand side vector\n    b = -hz**2 * rho_k[1:-1] / epsilon0\n    b[0] -= v0_k  # Dirichlet BC at z=0\n\n    # Solve the tridiagonal system\n    phi_1_to_Nm2 = solve_banded((1, 1), ab, b)\n    \n    # Reconstruct the full phi_k vector\n    phi_Nm1 = 0.0\n    if (1.0 + k_hz) > 1e-12:\n        phi_Nm1 = phi_1_to_Nm2[-1] / (1.0 + k_hz)\n    else: # k=0 case\n        phi_Nm1 = phi_1_to_Nm2[-1]\n\n    phi_k = np.concatenate(([v0_k], phi_1_to_Nm2, [phi_Nm1]))\n    \n    return phi_k\n\ndef solve():\n    \"\"\"\n    Main solver function to run all test cases.\n    \"\"\"\n    test_cases = [\n        # Case 1: Happy path\n        {'charges': [{'Q': 1.0e-18, 'center': (2.0e-9, 2.0e-9, 1.0e-9)}],\n         'V0': 0.1, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 2: Neutral dipole\n        {'charges': [{'Q': 5.0e-19, 'center': (2.0e-9, 2.0e-9, 1.0e-9)},\n                     {'Q': -5.0e-19, 'center': (2.0e-9, 2.0e-9, 1.4e-9)}],\n         'V0': 0.0, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 3: Zero charge\n        {'charges': [], 'V0': -0.2, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)},\n        # Case 4: Charge near vacuum\n        {'charges': [{'Q': 1.0e-18, 'center': (2.0e-9, 2.0e-9, 3.5e-9)}],\n         'V0': 0.05, 'sigma': (0.3e-9, 0.3e-9, 0.3e-9)}\n    ]\n\n    results = []\n    \n    Lx, Ly, Lz = 4.0e-9, 4.0e-9, 4.0e-9\n    Nx, Ny, Nz = 32, 32, 64\n\n    # Grid setup\n    hx, hy = Lx / Nx, Ly / Ny\n    hz = Lz / (Nz - 1)\n    \n    x_1d = np.linspace(0, Lx, Nx, endpoint=False)\n    y_1d = np.linspace(0, Ly, Ny, endpoint=False)\n    z_1d = np.linspace(0, Lz, Nz, endpoint=True)\n\n    x, y, z = np.meshgrid(x_1d, y_1d, z_1d, indexing='ij')\n    grid_coords = (x, y, z)\n    dV = hx * hy * hz\n    \n    # Wavevectors\n    kx = 2 * np.pi * np.fft.fftfreq(Nx, d=hx)\n    ky = 2 * np.pi * np.fft.fftfreq(Ny, d=hy)\n    kx_grid, ky_grid = np.meshgrid(kx, ky, indexing='ij')\n    k_mag_grid = np.sqrt(kx_grid**2 + ky_grid**2)\n\n    for case in test_cases:\n        # 1. Generate charge density\n        rho_xyz = np.zeros((Nx, Ny, Nz))\n        for charge in case['charges']:\n            rho_xyz += generate_gaussian(grid_coords, charge['center'], case['sigma'], charge['Q'], dV, (Lx, Ly))\n\n        # 2. Compute total free charge using trapezoidal rule for Z\n        # sum over x,y, then trapz over z\n        q_free_z = np.sum(rho_xyz, axis=(0,1)) * hx * hy\n        Q_free = np.trapz(q_free_z, dx=hz)\n\n        # 3. 2D FFT of charge density\n        rho_k_z = np.fft.fftn(rho_xyz, axes=(0, 1))\n        \n        # 4. Solve 1D BVP for each k-mode\n        phi_k_z = np.zeros_like(rho_k_z, dtype=complex)\n        V0 = case['V0']\n        \n        for i in range(Nx):\n            for j in range(Ny):\n                k_mag = k_mag_grid[i, j]\n                rho_k = rho_k_z[i, j, :]\n                \n                # Set V0 for k=0 mode, 0 otherwise\n                v0_k = V0 if k_mag  1e-9 else 0.0\n                \n                phi_k = solve_1d_bvp(rho_k, k_mag, v0_k, hz, EPSILON_0, Nz)\n                phi_k_z[i, j, :] = phi_k\n\n        # 5. Inverse 2D FFT to get real-space potential\n        phi_xyz = np.real(np.fft.ifftn(phi_k_z, axes=(0, 1)))\n\n        # 6. Verification metrics\n        # Delta V: Constant potential control\n        phi_at_z0 = phi_xyz[:, :, 0]\n        delta_V = np.max(np.abs(phi_at_z0 - V0))\n\n        # Delta Q: Charge balance\n        # Induced charge Q_ind\n        dphi_dz_at_z0 = (phi_xyz[:, :, 1] - phi_xyz[:, :, 0]) / hz\n        sigma_xy = -EPSILON_0 * dphi_dz_at_z0\n        Q_ind = np.sum(sigma_xy) * hx * hy\n        \n        delta_Q = np.abs(Q_ind + Q_free)\n        \n        results.append([delta_V, delta_Q])\n\n    # Final printing\n    print(f\"[{','.join([f'[{v},{q}]' for v, q in results])}]\")\n\nsolve()\n```"
        }
    ]
}