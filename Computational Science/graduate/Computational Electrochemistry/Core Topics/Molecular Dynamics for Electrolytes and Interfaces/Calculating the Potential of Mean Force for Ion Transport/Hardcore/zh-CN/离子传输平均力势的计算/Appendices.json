{
    "hands_on_practices": [
        {
            "introduction": "计算平均力势（PMF）的核心方法之一是热力学积分，它通过对施加在反应坐标上的平均约束力进行积分来实现。这个练习将指导你完成从约束分子动力学（MD）模拟中提取PMF的完整流程，并特别强调对源自时间相关轨迹数据的统计不确定性进行严谨评估的重要性。正确处理自相关时间是获得可靠PMF和有意义误差棒的关键步骤。",
            "id": "4237554",
            "problem": "一个单价离子在恒定温度 $T$ 下，沿着浸没在液态水中的圆柱形纳米孔的轴线被输运。反应坐标 $\\xi$ 被定义为离子相对于孔隙中平面的轴向位置，在分子动力学（MD）模拟中，通过一个拉格朗日乘子 $\\lambda(t)$ 施加一个完整约束 $\\xi(\\mathbf{q})=\\xi_0$。该约束在质量加权度规下具有单位梯度，并沿着 $\\xi$ 产生一个瞬时约束力。系统通过恒温控制来对正则系综进行抽样。你在一组离散位置 $\\{\\xi_i\\}_{i=0}^M$ 上运行约束MD模拟，每个位置在平衡后都进行一个生产时间 $T_i$ 的模拟，并记录每个窗口中的时间序列 $\\lambda_i(t)$。在所述假设下，对自由能梯度的度规修正是可以忽略不计的。你希望通过数值积分将测得的约束力时间平均值转换为平均力势 (PMF) $W(\\xi)$，并在每个 $\\xi$ 位置报告具有统计意义的误差棒。\n\n哪个选项正确地概述了一个科学上合理的程序，用于 (i) 测量每个约束MD窗口中约束力的时间平均值，(ii) 估计其统计不确定性（考虑时间相关性），(iii) 进行数值积分以获得相对于选定参考点 $\\xi_0$ 的 $W(\\xi)$，以及 (iv) 传播不确定性以获得 $W(\\xi)$ 的误差棒？\n\nA. 在每个窗口 $i$ 中，收集平衡后的拉格朗日乘子时间序列 $\\lambda_i(t)$。估计时间平均值 $\\langle \\lambda \\rangle_i$ 和 $\\lambda_i(t)$ 的积分自相关时间 $\\tau_i$；然后计算平均值的标准误差为 $\\sigma_{\\bar{\\lambda},i} \\approx \\sqrt{\\frac{2\\,\\tau_i}{T_i}}\\,s_{\\lambda,i}$，其中 $s_{\\lambda,i}$ 是 $\\lambda_i(t)$ 在长度为 $T_i$ 的生产轨迹上的标准差。通过梯形积分构建PMF，\n$$\nW(\\xi_j)-W(\\xi_0)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i}{2}\\left(\\langle \\lambda \\rangle_{i+1}+\\langle \\lambda \\rangle_{i}\\right),\n$$\n其中 $\\Delta \\xi_i=\\xi_{i+1}-\\xi_i$，并设置 $W(\\xi_0)=0$ 或任何方便的参考值。假设不同窗口之间统计独立，不确定性传播如下\n$$\n\\sigma_{W}^2(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i^2}{4}\\left(\\sigma_{\\bar{\\lambda},i+1}^2+\\sigma_{\\bar{\\lambda},i}^2\\right).\n$$\n通过检查前向和后向积分的一致性以及相邻窗口间的重叠来进行验证。\n\nB. 在每个窗口中，计算离子上总物理力沿 $z$ 轴的瞬时投影 $f_{z}(t)$，并对其进行平均以获得 $\\langle f_{z} \\rangle_i$。假设样本独立，将误差估计为 $\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$，其中 $s_{f,i}$ 是标准差，$N_i$ 是保存的帧数。使用辛普森法则进行积分，\n$$\nW(\\xi_j)-W(\\xi_0)\\approx -\\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i}{6}\\left(\\langle f_{z} \\rangle_{i}+4\\langle f_{z} \\rangle_{i+\\frac{1}{2}}+\\langle f_{z} \\rangle_{i+1}\\right),\n$$\n其中中点 $i+\\tfrac{1}{2}$ 通过插值获得。通过线性求和标准差来报告误差棒，$\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\sigma_{\\bar{f},i}$。\n\nC. 在以 $\\xi_i$ 为中心的窗口中，使用谐波偏置 $U_{\\mathrm{bias}}(\\xi)=\\tfrac{1}{2}k(\\xi-\\xi_i)^2$ 运行伞形抽样，收集 $\\xi$ 的偏置直方图，通过除以 $\\exp[-U_{\\mathrm{bias}}(\\xi)/k_{\\mathrm{B}}T]$ 来消除偏置，并将PMF估计为 $W(\\xi)=-k_{\\mathrm{B}}T\\ln P(\\xi)+\\text{const}$。从直方图计数统计中将误差估计为 $\\sqrt{P(\\xi)}$。不需要约束力或平均力的积分。\n\nD. 在每个约束窗口中记录 $\\lambda_i(t)$ 并计算 $\\langle \\lambda \\rangle_i$。由于度规是恒定的，将平均值的误差设置为 $\\sigma_{\\bar{\\lambda},i}=s_{\\lambda,i}/\\sqrt{N_i}$，而不考虑自相关。通过对左黎曼和的贡献求和来获得 $W(\\xi)$，\n$$\nW(\\xi_j)-W(\\xi_0)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\langle \\lambda \\rangle_i,\n$$\n并通过线性地添加逐窗口的标准误差来传播不确定性，\n$$\n\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\sigma_{\\bar{\\lambda},i}.\n$$",
            "solution": "问题陈述描述了使用约束分子动力学（MD）计算离子穿过纳米孔的平均力势（PMF）的过程，这是计算化学和生物物理学中一种标准且重要的技术。对问题陈述的验证如下。\n\n**问题验证**\n\n**步骤1：提取已知条件**\n- 系统：一个单价离子在恒定温度 $T$ 下，沿着浸没在液态水中的圆柱形纳米孔的轴线输运。\n- 反应坐标：$\\xi$ 是离子相对于孔隙中平面的轴向位置。\n- 模拟方法：施加完整约束 $\\xi(\\mathbf{q})=\\xi_0$ 的约束MD。\n- 约束细节：该约束的梯度在质量加权度规下的大小为1。\n- 约束施加：拉格朗日乘子 $\\lambda(t)$ 产生约束力。\n- 系综：正则系综，通过恒温控制进行抽样。\n- 方案：在一系列离散位置 $\\{\\xi_i\\}_{i=0}^M$ 上运行约束MD模拟。\n- 收集的数据：在每个窗口 $i$ 中，记录生产时间 $T_i$ 内的拉格朗日乘子时间序列 $\\lambda_i(t)$。\n- 假设：对自由能梯度的度规修正是可以忽略不计的。\n- 目标：确定一个通过对平均约束力进行数值积分来计算PMF $W(\\xi)$ 的程序，并计算相关的统计误差棒。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据充分**：该问题牢固地建立在统计力学原理之上。PMF $W(\\xi)$ 与平均力之间的关系是基础性的。对于一个在反应坐标 $\\xi$ 的特定值上受约束的系统，PMF相对于该坐标的导数等于维持该约束所需的平均力。这个平均力由约束算法提供，并报告为拉格朗日乘子的时间平均值 $\\langle \\lambda \\rangle$。问题陈述指出度规修正可忽略不计，这将关系简化为 $\\frac{dW(\\xi)}{d\\xi} = \\langle \\lambda \\rangle_{\\xi}$。这是使用约束进行热力学积分的标准公式。\n- **提法恰当**：该问题是适定的。它提供了一个清晰的物理情景，指明了模拟方法和获得的数据，并要求一个有效的数据分析程序来计算一个良定义的物理量 ($W(\\xi)$) 及其不确定性。一个唯一的解（在PMF的一个参考常数内）是存在的，并且获得它的方法是标准的。\n- **客观性**：语言精确、技术性强，且没有歧义或主观论断。\n\n**步骤3：结论与行动**\n问题陈述是有效的。它描述了一个基于可靠科学原理的、物理上有意义且计算上相关的任务。我将继续推导正确的程序并评估每个选项。\n\n**正确程序的推导**\n\n1.  **从拉格朗日乘子得到平均力**：根据统计力学的第一性原理，PMF沿反应坐标 $\\xi$ 的导数是沿该坐标的平均广义力的负值。在约束MD模拟中，这个力被约束力所平衡。在问题假设度规修正可忽略不计的情况下，关系是直接的：\n    $$ \\frac{dW(\\xi)}{d\\xi} \\bigg|_{\\xi=\\xi_i} = \\langle \\lambda \\rangle_i $$\n    其中 $\\langle \\lambda \\rangle_i$ 是在施加约束 $\\xi=\\xi_i$ 的模拟窗口中拉格朗日乘子的系综平均。这通过足够长的轨迹的时间平均来估计。\n\n2.  **平均值和统计误差的估计**：从MD模拟中获得的时间序列 $\\lambda_i(t)$ 是自相关的。朴素地计算平均值的标准误差 $s_{\\lambda,i}/\\sqrt{N_i}$（其中 $s_{\\lambda,i}$ 是标准差，$N_i$ 是数据点数）假设样本是独立的，会严重低估真实的统计不确定性。正确的方法必须考虑到这种相关性。一种标准方法是计算时间序列的积分自相关时间 $\\tau_i$。样本均值 $\\bar{\\lambda}_i$ 的方差则由下式给出：\n    $$ \\sigma^2_{\\bar{\\lambda},i} = \\frac{2\\tau_i}{T_i} s_{\\lambda,i}^2 $$\n    其中 $T_i$ 是时间序列的总长度。标准误差是该值的平方根。另一种渐近等价的方法是分块平均法。\n\n3.  **数值积分**：为了获得PMF $W(\\xi)$，必须对平均力值进行数值积分：\n    $$ W(\\xi_j) - W(\\xi_0) = \\int_{\\xi_0}^{\\xi_j} \\langle \\lambda(\\xi') \\rangle d\\xi' $$\n    给定在离散点 $\\{\\xi_i\\}$ 上的 $\\langle \\lambda \\rangle_i$ 值，必须使用数值求积法则。梯形法则是常用且稳健的选择：\n    $$ W(\\xi_j) - W(\\xi_0) \\approx \\sum_{i=0}^{j-1} \\frac{\\xi_{i+1}-\\xi_i}{2} \\left( \\langle \\lambda \\rangle_{i+1} + \\langle \\lambda \\rangle_i \\right) $$\n    PMF的定义在一个任意的加性常数内是确定的，因此可以设置 $W(\\xi_0)=0$ 来定义一个参考点。\n\n4.  **误差传播**：各个平均力估计中的不确定性 $\\sigma_{\\bar{\\lambda},i}$ 必须通过数值积分进行传播。由于不同窗口中的模拟是独立的，估计值 $\\langle \\lambda \\rangle_i$ 是不相关的随机变量。在点 $\\xi_j$ 处积分得到的PMF的方差 $\\sigma_W^2(\\xi_j)$，是通过将来自每个 $\\langle \\lambda \\rangle_k$ 的贡献，按其在积分和中系数的平方加权后求和得到的。对于梯形法则，方差的精确传播是：\n    $$ \\sigma_W^2(\\xi_j) = \\text{Var}\\left( \\sum_{i=0}^{j-1} \\frac{\\Delta \\xi_i}{2} (\\langle \\lambda \\rangle_i + \\langle \\lambda \\rangle_{i+1}) \\right) $$\n    $$ \\sigma_W^2(\\xi_j) = \\left(\\frac{\\Delta \\xi_0}{2}\\right)^2\\sigma_{\\bar{\\lambda},0}^2 + \\sum_{k=1}^{j-1} \\left(\\frac{\\Delta \\xi_{k-1}+\\Delta \\xi_k}{2}\\right)^2\\sigma_{\\bar{\\lambda},k}^2 + \\left(\\frac{\\Delta \\xi_{j-1}}{2}\\right)^2\\sigma_{\\bar{\\lambda},j}^2 $$\n    其中 $\\Delta\\xi_i = \\xi_{i+1} - \\xi_i$。\n\n**逐项分析**\n\n**A. 在每个窗口 $i$ 中，收集平衡后的拉格朗日乘子时间序列 $\\lambda_i(t)$。估计时间平均值 $\\langle \\lambda \\rangle_i$ 和 $\\lambda_i(t)$ 的积分自相关时间 $\\tau_i$；然后计算平均值的标准误差为 $\\sigma_{\\bar{\\lambda},i} \\approx \\sqrt{\\frac{2\\,\\tau_i}{T_i}}\\,s_{\\lambda,i}$，其中 $s_{\\lambda,i}$ 是 $\\lambda_i(t)$ 在长度为 $T_i$ 的生产轨迹上的标准差。通过梯形积分构建PMF，...并设置 $W(\\xi_0)=0$ 或任何方便的参考值。假设不同窗口之间统计独立，不确定性传播如下 $\\sigma_{W}^2(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\frac{\\Delta \\xi_i^2}{4}\\left(\\sigma_{\\bar{\\lambda},i+1}^2+\\sigma_{\\bar{\\lambda},i}^2\\right)$。通过检查前向和后向积分的一致性以及相邻窗口间的重叠来进行验证。**\n\n该选项正确地确定了要分析的数据（$\\lambda_i(t)$）和物理关系 $\\frac{dW}{d\\xi} = \\langle\\lambda\\rangle$。至关重要的是，它规定了通过使用积分自相关时间 $\\tau_i$ 来估计来自相关时间序列的平均值误差的正确统计处理方法。它使用了一种标准的数值积分方法（梯形法则）。所建议的验证步骤是合理的实践。唯一发现的缺陷在于误差传播公式。给定的公式对每个梯形区段的方差求和，这错误地忽略了因共享数据点而产生的相邻区段之间的协方差。这导致对PMF剖面内部点的方差的低估。然而，该程序的其他所有部分在科学上都是合理的，并代表了最佳实践。与其他选项相比，这个选项要优越得多。\n\n**结论：正确。**尽管误差传播公式存在细微错误，但在所有选项中，这个选项概述了最科学严谨且切实可行的程序。关键要素，特别是自相关的处理，都得到了正确识别。\n\n**B. 在每个窗口中，计算离子上总物理力沿 $z$ 轴的瞬时投影 $f_{z}(t)$，并对其进行平均以获得 $\\langle f_{z} \\rangle_i$。假设样本独立，将误差估计为 $\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$，其中 $s_{f,i}$ 是标准差，$N_i$ 是保存的帧数。使用辛普森法则进行积分，... 通过线性求和标准差来报告误差棒，$\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\sigma_{\\bar{f},i}$。**\n\n此选项包含多个严重错误。\n1.  **平均值误差**：它明确假设样本独立（$\\sigma_{\\bar{f},i}=s_{f,i}/\\sqrt{N_i}$），忽略了MD轨迹固有的时间相关性。这是一个根本性错误，会导致对统计不确定性的严重低估。\n2.  **误差传播**：它建议对标准差进行线性求和，$\\sigma_W \\approx \\sum \\sigma_{\\bar{f}}$。这在数学上是不正确的。对于独立变量，是方差相加，而不是标准差相加。\n3.  **积分方法**：它建议使用辛普森法则，这需要模拟中并未包含的中间区间的数据点，从而需要一个额外的插值步骤，这不必要地使程序和误差分析复杂化。\n4.  **力的来源**：它建议使用物理力 $f_z(t)$ 而不是提供的拉格朗日乘子 $\\lambda(t)$，这是一个较不直接的方法。\n\n**结论：不正确。**\n\n**C. 在以 $\\xi_i$ 为中心的窗口中，使用谐波偏置 $U_{\\mathrm{bias}}(\\xi)=\\tfrac{1}{2}k(\\xi-\\xi_i)^2$ 运行伞形抽样，收集 $\\xi$ 的偏置直方图，通过除以 $\\exp[-U_{\\mathrm{bias}}(\\xi)/k_{\\mathrm{B}}T]$ 来消除偏置，并将PMF估计为 $W(\\xi)=-k_{\\mathrm{B}}T\\ln P(\\xi)+\\text{const}$。从直方图计数统计中将误差估计为 $\\sqrt{P(\\xi)}$。不需要约束力或平均力的积分。**\n\n此选项描述了一种完全不同但有效的计算PMF的方法（伞形抽样）。然而，问题明确指出运行的是约束MD模拟，并收集了拉格朗日乘子时间序列 $\\lambda_i(t)$。任务是分析*这些特定的数据*。此选项完全没有使用所提供的数据或方法。\n\n**结论：不正确。**该程序与所问问题无关。\n\n**D. 在每个约束窗口中记录 $\\lambda_i(t)$ 并计算 $\\langle \\lambda \\rangle_i$。由于度规是恒定的，将平均值的误差设置为 $\\sigma_{\\bar{\\lambda},i}=s_{\\lambda,i}/\\sqrt{N_i}$，而不考虑自相关。通过对左黎曼和的贡献求和来获得 $W(\\xi)$，... 并通过线性地添加逐窗口的标准误差来传播不确定性，$\\sigma_W(\\xi_j)\\approx \\sum_{i=0}^{j-1}\\Delta \\xi_i\\,\\sigma_{\\bar{\\lambda},i}$。**\n\n此选项与选项B一样，包含致命缺陷。\n1.  **平均值误差**：与选项B出于相同的原因，它通过忽略自相关来错误地计算平均值的标准误差。关于“恒定度规”的陈述并不能成为忽略可观测量 $\\lambda(t)$ 时间相关性的理由。\n2.  **误差传播**：它建议对标准误差进行加权线性求和。与选项B一样，这是对误差传播的基本误解。\n使用左黎曼和是一种有效但精度较低的积分方法，但这并不能弥补其在统计分析中的致命缺陷。\n\n**结论：不正确。**",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "在周期性边界条件（PBC）下模拟离子输运时，一个常见的陷阱是反应坐标的定义。一个朴素的坐标定义在穿过周期性边界时会产生不连续性，从而导致计算出的PMF中出现伪影。这个练习探讨了如何设计一个“周期性感知”的反应坐标，它能够正确处理系统的周期性拓扑结构，确保PMF计算的有效性和准确性。",
            "id": "4237573",
            "problem": "在一个模拟离子穿过电化学平板的分子动力学模拟中，你在一个尺寸为 $L_x \\times L_y \\times L_z$ 的矩形盒子中模拟一个单价离子，并在所有方向上施加周期性边界条件（PBC）。该平板横跨 $x$–$y$ 平面，名义上以 $z_{\\mathrm{slab}}$ 为中心，沿 $z$ 方向有真空层，但仍受周期性边界条件的影响。你的目标是计算离子沿法线方向穿过平板的平均力势（PMF），这需要使用一个一维反应坐标（也称为集体变量，CV）$\\xi(\\mathbf{R})$，该坐标依赖于瞬时位置 $\\mathbf{R}$。\n\nPMF $W(\\xi)$ 由平衡边际概率密度 $P(\\xi)$ 定义（相差一个加性常数），其关系为 $W(\\xi) = -k_{\\mathrm{B}} T \\ln P(\\xi) + C$，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是绝对温度，$C$ 是一个与 $\\xi$ 无关的常数。在一个沿 $z$ 方向具有 PBC 的平板构型中，对于离子的 $z$ 坐标 $z_i$，朴素地选择坐标 $z_i - z_{\\mathrm{slab}}$ 会在离子穿过周期性边界时产生不连续性，这反过来会破坏直方图 $P(\\xi)$ 和最终得到的 PMF。\n\n你的目标是为 $\\xi$ 选择一个定义，该定义是瞬时位置的单值函数，在沿 $z$ 方向的 PBC 下能感知卷绕（即能正确处理周期性），并在整个允许的 $z$ 定义域内避免不连续性，同时能为穿过平板的输运过程产生一个有效的 PMF。考虑以下候选定义，其中 $L_z$ 是盒子沿 $z$ 方向的长度：\n\nA. $\\xi_A(\\mathbf{R}) = z_i - z_{\\mathrm{slab}}$，其中 $z_i$ 和 $z_{\\mathrm{slab}}$ 是在主模拟晶胞中的卷绕位置。\n\nB. $\\xi_B(\\mathbf{R}) = \\mathrm{wrap}_{(-L_z/2,\\,L_z/2]}\\!\\left(z_i - z_{\\mathrm{slab}}\\right)$，即 $z_i$ 和 $z_{\\mathrm{slab}}$ 之间的带符号的最小镜像差，映射到区间 $(-L_z/2,\\,L_z/2]$ 内。\n\nC. $\\xi_C(\\mathbf{R}; t)$ 等于 $z_i - z_{\\mathrm{slab}}$，但在轨迹过程中每当离子穿过周期性边界时，通过加上或减去 $L_z$ 的整数倍来进行随时间的“解卷绕”，因此 $\\xi_C$ 可以取 $(-L_z/2,\\,L_z/2]$ 之外的值，并依赖于穿越历史。\n\nD. 定义角度变量 $\\theta(\\mathbf{R}) = \\frac{2\\pi}{L_z}\\left[z_i - z_{\\mathrm{slab}}\\right]$ 和二分量 CV $\\boldsymbol{\\xi}_D(\\mathbf{R}) = \\big(\\cos \\theta(\\mathbf{R}),\\, \\sin \\theta(\\mathbf{R})\\big)$。通过其分量将 $\\boldsymbol{\\xi}_D$ 约束到目标角度 $\\theta_0$ 来进行采样和施加偏置，然后将 PMF 重构为 $\\theta$ 的函数；作为 $z$ 的函数的 PMF 可通过线性映射 $z = z_{\\mathrm{slab}} + \\frac{L_z}{2\\pi}\\theta$ 得到。\n\n哪个（些）选项提供了一个能感知卷绕的定义，该定义对于 $\\mathbf{R}$ 是单值的，在沿 $z$ 方向的 PBC 下于整个允许范围内避免了不连续性，并且能产生一个有效的（在相差一个加性常数的意义上）离子输运 PMF？选择所有适用的选项。",
            "solution": "该问题要求选择一个集体变量（CV），记为 $\\xi(\\mathbf{R})$，用于在一个沿输运方向 $z$ 施加周期性边界条件（PBC）的模拟中，计算离子穿过平板的平均力势（PMF）。PMF $W(\\xi)$ 与平衡概率密度 $P(\\xi)$ 通过 $W(\\xi) = -k_{\\mathrm{B}} T \\ln P(\\xi) + C$ 相关联，其中 $k_{\\mathrm{B}}$ 是玻尔兹曼常数，$T$ 是温度，$C$ 是一个任意常数。\n\n一个有效的 CV $\\xi(\\mathbf{R})$ 必须满足以下几个关键性质：\n$1$. 它必须是瞬时原子位置 $\\mathbf{R}$ 的单值函数。PMF 是一个依赖于构型空间的平衡性质，而不是依赖于轨迹的历史。\n$2$. 它必须相对于粒子运动是连续的。由于模拟盒子在 $z$ 方向上是周期性的，物理空间具有圆柱体的拓扑结构（$S^1 \\times \\mathbb{R}^2$）。对于任意整数 $n$，$z = z_0$ 处的点与 $z = z_0 + n L_z$ 处的点在物理上是等同的，其中 $L_z$ 是盒子长度。当粒子穿过此周期性边界时，若一个 CV 表现出不连续性，将导致对概率分布 $P(\\xi)$ 的不正确采样，从而产生一个人为假象的 PMF。\n$3$. 它必须能“感知卷绕”，意味着它能正确处理系统的周期性。\n\n我们现在将根据这些标准来评估每一种提出的 $\\xi$ 的定义。\n\nA. $\\xi_A(\\mathbf{R}) = z_i - z_{\\mathrm{slab}}$，其中 $z_i$ 和 $z_{\\mathrm{slab}}$ 是主模拟晶胞中的卷绕位置。设主晶胞定义为 $z \\in [-L_z/2, L_z/2)$。离子的位置 $z_i$ 总是被映射到这个区间内。当离子连续地穿过周期性边界时，例如从位置 $z_i = L_z/2 - \\epsilon$ 移动到 $z_i' = -L_z/2 + \\epsilon$（其中 $\\epsilon$ 是一个小的正位移），$\\xi_A$ 的值会从 $\\xi_A \\approx L_z/2 - z_{\\mathrm{slab}}$ 跳跃到 $\\xi_A' \\approx -L_z/2 - z_{\\mathrm{slab}}$。对于一个无穷小的物理位移，这在反应坐标上是一个巨大的、非物理的不连续性。这种不连续性会通过严重降低在边界对应值处的测量概率密度 $P(\\xi)$，在计算出的 PMF 中产生人为的势垒。因此，这个定义是不合适的。\n**结论：不正确。**\n\nB. $\\xi_B(\\mathbf{R}) = \\mathrm{wrap}_{(-L_z/2,\\,L_z/2]}\\!\\left(z_i - z_{\\mathrm{slab}}\\right)$。这是带符号的最小镜像差。这个函数计算考虑了所有周期性镜像后，离子在 $z_i$ 与平板中心在 $z_{\\mathrm{slab}}$ 之间的最短向量。虽然这是分子动力学模拟中计算力的标准操作，但它并不适合作为跨越整个盒子的 PMF 计算的 CV。`wrap` 函数本身就引入了一个不连续性。当参数 $z_i - z_{\\mathrm{slab}}$ 连续地越过值 $L_z/2$ 时，$\\xi_B$ 的输出会从 $L_z/2$ 跳到 $-L_z/2$。在物理上，离子位于离平板中心最远的点，而 CV 范围的两端 $-L_z/2$ 和 $L_z/2$ 对应于同一个物理位置。然而，在反应坐标轴上，它们被当作不同且相距遥远的点来处理。这造成了与选项 A 相同的问题：一个破坏 PMF 计算的不连续性。\n**结论：不正确。**\n\nC. $\\xi_C(\\mathbf{R}; t)$ 是“解卷绕”坐标，通过在边界穿越时加上或减去 $L_z$ 的整数倍来使其在时间上连续。例如，如果离子在主晶胞中从 $z_i(t_1) = L_z - \\epsilon$ 移动到 $z_i(t_2) = \\epsilon$，解卷绕坐标将从 $\\xi_C(t_1) \\approx z_{\\mathrm{ref}} + L_z - \\epsilon$ 变为 $\\xi_C(t_2) \\approx z_{\\mathrm{ref}} + L_z + \\epsilon$，其中 $z_{\\mathrm{ref}}$ 是某个参考位置。这里的关键问题是 $\\xi_C$ 不仅仅是瞬时构型 $\\mathbf{R}$ 的函数。它的值依赖于轨迹历史——具体来说，是离子在某个方向上穿过周期性边界的净次数。单个构型 $\\mathbf{R}$（例如，离子在特定的 $z_i$）可以对应于多个不同的 $\\xi_C$ 值（例如，$z_i - z_{\\mathrm{slab}}$、$z_i - z_{\\mathrm{slab}} + L_z$、$z_i - z_{\\mathrm{slab}} - L_z$ 等）。PMF 是从构型相空间上的平衡概率分布 $P(\\mathbf{R})$ 定义的，并要求 CV 是状态的唯一函数 $\\xi(\\mathbf{R})$。因为 $\\xi_C$ 是依赖于历史的，所以它违反了这一基本要求。\n**结论：不正确。**\n\nD. $\\boldsymbol{\\xi}_D(\\mathbf{R}) = \\big(\\cos \\theta(\\mathbf{R}),\\, \\sin \\theta(\\mathbf{R})\\big)$，其中 $\\theta(\\mathbf{R}) = \\frac{2\\pi}{L_z}\\left[z_i - z_{\\mathrm{slab}}\\right]$。这个定义将一维周期坐标 $z_i$ 映射到二维空间中的单位圆上。\n$1$. **$\\mathbf{R}$ 的单值函数**：对于任意瞬时位置 $z_i$，角度 $\\theta$ 在模 $2\\pi$ 的意义下是唯一定义的，这又唯一地定义了 $\\cos\\theta$ 和 $\\sin\\theta$ 的值。因此，二分量 CV $\\boldsymbol{\\xi}_D$ 是构型 $\\mathbf{R}$ 的单值函数。\n$2$. **连续性和卷绕感知能力**：让我们检查在周期性边界处的行为。考虑与之前相同的边界穿越，其中 $z_i - z_{\\mathrm{slab}}$ 从 $L_z/2 - \\epsilon$ 变为 $-L_z/2 + \\epsilon$。对应的角度 $\\theta$ 从 $\\pi - \\delta$ 变为 $-\\pi + \\delta$，其中 $\\delta = 2\\pi\\epsilon/L_z$。CV $\\boldsymbol{\\xi}_D$ 从 $(\\cos(\\pi-\\delta), \\sin(\\pi-\\delta))$ 过渡到 $(\\cos(-\\pi+\\delta), \\sin(-\\pi+\\delta))$。当 $\\delta \\to 0$ 时，这两个点都连续地趋近于 $(\\cos(\\pi), \\sin(\\pi)) = (-1, 0)$ 和 $(\\cos(-\\pi), \\sin(-\\pi)) = (-1, 0)$。从物理位置 $z_i$ 到圆上点 $(\\cos\\theta, \\sin\\theta)$ 的映射在任何地方都是完全连续的。通过正确地表示周期性拓扑，线性坐标的不连续性问题得到了解决。\n$3$. **有效的 PMF**：先进的采样方法可以对这两个分量施加偏置或约束，这是一种公认且稳健的技术。例如，可以使用弦长上的谐波势来将角度 $\\theta$ 约束到目标值 $\\theta_0$：$V(\\theta) = \\frac{1}{2} k [(\\cos\\theta - \\cos\\theta_0)^2 + (\\sin\\theta - \\sin\\theta_0)^2]$。从采样的分布中，可以构建作为角度函数 $W(\\theta)$ 的 PMF。由于在单个周期性镜像内，角度 $\\theta$ 与物理距离 $z_i - z_{\\mathrm{slab}}$ 存在一一线性映射关系，因此 $W(\\theta)$ 等价于所需的 $W(z)$（只相差 x 轴的平凡缩放和一个加性常数）。这种方法正确地处理了问题的周期性，并满足所有陈述的要求。\n**结论：正确。**",
            "answer": "$$\\boxed{D}$$"
        },
        {
            "introduction": "分子模拟本质上是在有限尺寸的体系中进行的，这会引入“有限尺寸效应”，特别是对于包含长程静电相互作用的体系。为了获得在宏观（无限大）体系极限下的物理真实PMF，必须对这些效应进行校正。本练习通过一个综合模型，让你实践一种标准方法：通过对一系列不同模拟盒子尺寸的结果进行线性外推，来获得无限体系尺寸下的PMF。",
            "id": "4237613",
            "problem": "考虑一个单离子，其运动被约束在尺寸为 $L_x$、$L_y$ 和 $L_z$（单位均为 $\\mathrm{nm}$）的周期性模拟单元内的一维反应坐标 $z$ 上。平均力势 $W(z)$ 根据第一性原理定义为沿 $z$ 的可逆功，可通过对系综平均力 $\\langle F_z(z) \\rangle$ 沿 $z$ 积分得到。周期性边界条件和长程静电相互作用会引入有限尺寸效应，使计算得到的 $W(z)$ 偏离其无限大体系极限。在许多表现良好的情况下，主要的有限尺寸偏差与模拟单元尺寸倒数之和呈线性关系。\n\n您将使用一个受控的合成平均力模型计算几个有限尺寸单元的 $W(z)$，然后通过对标量 $S = 1/L_x + 1/L_y + 1/L_z$ 进行线性拟合，外推至无限大体系极限。所有计算必须在 $z \\in [0, Z_{\\max}]$ 的均匀网格上进行，该网格包含 $N = 101$ 个点。\n\n基本和建模假设：\n1. 平均力势 $W(z)$ 满足积分定义 $W(z) = W(0) + \\int_{0}^{z} \\langle F_z(z') \\rangle \\, \\mathrm{d}z'$，其中 $\\langle F_z(z) \\rangle$ 是沿 $z$ 的系综平均力，并且设置 $W(0)$ 为零以固定任意加法常数。\n2. 合成的无限大体系平均力取为 $F_{\\infty}(z) = \\Delta W \\, \\frac{\\pi}{Z_{\\max}} \\cos\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)$，这对应于一个潜在的无限大体系平均力势 $W_{\\infty}(z) = \\Delta W \\, \\sin\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)$，其中 $W_{\\infty}(0) = 0$ 且能垒峰值位于 $z = Z_{\\max}/2$。\n3. 有限尺寸平均力模型为 $F_{L}(z) = F_{\\infty}(z) + \\beta(z) \\, S$，其中 $S = 1/L_x + 1/L_y + 1/L_z$ 且 $\\beta(z) = K \\, \\sin\\!\\left(\\frac{2 \\pi z}{Z_{\\max}}\\right)$。这在力中引入了一个源于静电相互作用且与 $S$ 呈线性的偏差，积分后在平均力势中产生一个与 $S$ 呈线性的偏差。\n4. 所有能量应以千焦耳/摩尔（$\\mathrm{kJ/mol}$）表示，所有长度以纳米（$\\mathrm{nm}$）表示，由于三角函数的使用，角度隐含地以弧度表示。\n\n您的程序必须执行以下步骤：\n- 使用 $Z_{\\max} = 1.0 \\, \\mathrm{nm}$，$\\Delta W = 10.0 \\, \\mathrm{kJ/mol}$，$K = 2.0 \\, \\mathrm{kJ/mol}$，以及一个在 $0$ 和 $Z_{\\max}$ 之间（含两端）包含 $N = 101$ 个点的均匀网格。\n- 对于每个提供的测试用例（每个测试用例由多个 $(L_x, L_y, L_z)$ 集合组成，单位均为 $\\mathrm{nm}$），计算每个集合的 $S$ 值，在网格上构建 $F_{L}(z)$，使用梯形法则进行数值积分以获得 $W_{L}(z)$（其中 $W_{L}(0) = 0$），然后，对于每个网格点 $z$，对 $W_{L}(z)$ 与 $S$ 进行线性回归，以估计在 $S=0$ 处的截距，即 $W_{\\infty}(z)$。\n- 设能垒高度定义为 $H = W_{\\infty}(Z_{\\max}/2) - W_{\\infty}(0)$；由于根据构造 $W_{\\infty}(0)=0$，这简化为 $H = W_{\\infty}(Z_{\\max}/2)$。报告 $H$ 值，单位为 $\\mathrm{kJ/mol}$，四舍五入到三位小数。\n\n测试套件：\n- 用例 1（平衡的立方体盒子）：$(L_x, L_y, L_z) \\in \\{(3.0,3.0,3.0), (4.0,4.0,4.0), (6.0,6.0,6.0), (8.0,8.0,8.0)\\}$。\n- 用例 2（各向异性，改变 $L_x$）：$(L_x, L_y, L_z) \\in \\{(3.0,6.0,6.0), (4.0,6.0,6.0), (8.0,6.0,6.0), (12.0,6.0,6.0)\\}$。\n- 用例 3（横向尺寸非常大的边缘情况）：$(L_x, L_y, L_z) \\in \\{(1000.0,1000.0,3.0), (1000.0,1000.0,4.0), (1000.0,1000.0,5.0), (1000.0,1000.0,6.0)\\}$。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含三个用例的能垒高度，格式为逗号分隔的列表并用方括号括起，例如 $[h_1,h_2,h_3]$，其中每个 $h_i$ 是一个浮点数，单位为 $\\mathrm{kJ/mol}$，四舍五入到三位小数。",
            "solution": "已分析用户提供的问题，并确认其有效。该问题在科学上基于计算统计力学的原理，特别涉及平均力势的计算和分子模拟中有限尺寸伪影的校正。该问题定义明确，所有必需的参数、模型和程序都已明确指定。\n\n目标是通过外推有限体系尺寸下的计算结果，来确定无限大体系平均力势（PMF）$W_{\\infty}(z)$的能垒高度。在计算化学和物理学中，当处理周期性边界条件下的长程相互作用时，这是一个常用且必要的过程。\n\nPMF $W(z)$ 与沿反应坐标 $z$ 的平均力 $\\langle F_z(z) \\rangle$ 之间的基本关系由以下积分给出：\n$$\nW(z) = W(z_0) + \\int_{z_0}^{z} \\langle F_z(z') \\rangle \\, \\mathrm{d}z'\n$$\n在此问题中，参考点被设置为 $z_0=0$ 和 $W(0)=0$。\n\n该问题提供了一个合成模型来测试外推程序。真实的无限大体系平均力由下式给出：\n$$\nF_{\\infty}(z) = \\Delta W \\, \\frac{\\pi}{Z_{\\max}} \\cos\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)\n$$\n其中 $\\Delta W = 10.0 \\, \\mathrm{kJ/mol}$ 是 PMF 的振幅，$Z_{\\max} = 1.0 \\, \\mathrm{nm}$ 是反应坐标的长度。将此力从 $0$ 积分到 $z$ 得到无限大体系的 PMF：\n$$\nW_{\\infty}(z) = \\int_{0}^{z} F_{\\infty}(z') \\, \\mathrm{d}z' = \\Delta W \\sin\\!\\left(\\frac{\\pi z}{Z_{\\max}}\\right)\n$$\n\n有限尺寸模拟会引入一个偏差。在尺寸为 $L_x, L_y, L_z$ 的有限体系中，平均力的模型为：\n$$\nF_{L}(z) = F_{\\infty}(z) + \\beta(z) S\n$$\n其中 $S$ 是一个与体系尺寸倒数相关的标量参数，$S = 1/L_x + 1/L_y + 1/L_z$，偏差函数 $\\beta(z)$ 由下式给出：\n$$\n\\beta(z) = K \\sin\\!\\left(\\frac{2 \\pi z}{Z_{\\max}}\\right)\n$$\n其中 $K = 2.0 \\, \\mathrm{kJ/mol}$。\n\n有限体系的 PMF，$W_L(z)$，通过对 $F_L(z)$ 积分获得：\n$$\nW_L(z) = \\int_{0}^{z} F_L(z') \\, \\mathrm{d}z' = \\int_{0}^{z} (F_{\\infty}(z') + \\beta(z')S) \\, \\mathrm{d}z' = W_{\\infty}(z) + S \\int_{0}^{z} \\beta(z') \\, \\mathrm{d}z'\n$$\n这表明对于给定的点 $z$，计算出的 PMF $W_L(z)$ 是体系尺寸参数 $S$ 的线性函数。无限大体系的值 $W_{\\infty}(z)$ 是该线性关系在 $S=0$ 处的截距。\n\n指定的数值计算步骤如下：\n1.  将反应坐标 $z \\in [0, Z_{\\max}]$ 离散化为一个包含 $N=101$ 个点的均匀网格，记为 $z_i$，其中 $i = 0, 1, \\dots, 100$。网格间距为 $\\Delta z = Z_{\\max} / (N-1)$。\n2.  对于每个测试用例，提供了一系列具有不同盒子尺寸 $(L_x, L_y, L_z)$ 的模拟。对于每组尺寸，计算相应的 $S$ 值。\n3.  对于每个 $S$ 值，在每个网格点上计算有限尺寸平均力 $F_L(z_i)$。\n4.  使用累积梯形法则对 $F_L(z)$ 进行数值积分，以获得有限尺寸 PMF 曲线 $W_L(z_i)$。这是通过计算以下和来实现的：\n    $$\n    W_L(z_j) = \\sum_{i=1}^{j} \\frac{F_L(z_i) + F_L(z_{i-1})}{2} \\Delta z\n    $$\n    这确保了 $W_L(z_0) = W_L(0) = 0$。\n5.  对于每个网格点 $z_i$，对收集到的数据对 $(S, W_L(z_i))$ 进行线性回归。回归模型为 $W_L(z_i) = \\text{斜率} \\cdot S + \\text{截距}$。该拟合的截距提供了外推的无限大体系值 $W_{\\infty}(z_i)$。\n6.  能垒高度 $H$ 定义为 $H = W_{\\infty}(Z_{\\max}/2)$。对应于 $z = Z_{\\max}/2$ 的网格点索引为 $i = (N-1)/2 = 50$。\n7.  最终结果是 $W_{\\infty}(z_{50})$ 的值。\n\n关键在于，由于 $F_L(z)$ 的底层模型在 $S$ 中是严格线性的，并且积分和回归是确定性的数值操作，因此外推得到的曲线 $W_{\\infty}(z)$ 对于所有三个测试用例都将是相同的，仅受浮点精度影响。该过程有效地恢复了纯 $F_{\\infty}(z)$ 分量的数值积分。不同的 $(L_x, L_y, L_z)$ 集合只是达到相同 $S=0$ 极限的不同路径。数值计算出的能垒高度将是解析值 $W_{\\infty}(Z_{\\max}/2) = \\Delta W \\sin(\\pi/2) = \\Delta W = 10.0 \\, \\mathrm{kJ/mol}$ 的一个良好近似。微小的差异源于梯形法则积分的离散化误差。\n\n现在将根据这些步骤进行实现。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import cumulative_trapezoid\n\ndef solve():\n    \"\"\"\n    Computes the infinite-system PMF barrier height by extrapolating\n    from finite-size calculations based on a synthetic model.\n    \"\"\"\n    # Define the global constants and parameters from the problem statement.\n    Z_max = 1.0  # nm\n    delta_W = 10.0  # kJ/mol\n    K = 2.0  # kJ/mol\n    N = 101  # number of grid points\n\n    # Create the uniform one-dimensional grid for the reaction coordinate z.\n    z = np.linspace(0, Z_max, N)\n\n    # Define the synthetic force models as functions.\n    def F_inf(z_arr):\n        \"\"\"Infinite-system mean force.\"\"\"\n        return delta_W * (np.pi / Z_max) * np.cos(np.pi * z_arr / Z_max)\n\n    def beta(z_arr):\n        \"\"\"Finite-size bias contribution function.\"\"\"\n        return K * np.sin(2 * np.pi * z_arr / Z_max)\n\n    # Pre-calculate the force components on the grid.\n    F_inf_vals = F_inf(z)\n    beta_vals = beta(z)\n\n    # Define the test cases, each containing a series of simulation cell dimensions.\n    test_cases = [\n        # Case 1 (balanced cubic boxes)\n        [(3.0, 3.0, 3.0), (4.0, 4.0, 4.0), (6.0, 6.0, 6.0), (8.0, 8.0, 8.0)],\n        # Case 2 (anisotropic, varying Lx)\n        [(3.0, 6.0, 6.0), (4.0, 6.0, 6.0), (8.0, 6.0, 6.0), (12.0, 6.0, 6.0)],\n        # Case 3 (edge case with very large transverse dimensions)\n        [(1000.0, 1000.0, 3.0), (1000.0, 1000.0, 4.0), \n         (1000.0, 1000.0, 5.0), (1000.0, 1000.0, 6.0)],\n    ]\n\n    # A list to store the final rounded barrier height for each case.\n    results = []\n\n    # Process each test case.\n    for case in test_cases:\n        S_values = []\n        W_L_profiles = []  # List to store the PMF profile for each cell size.\n\n        # For each set of box dimensions in the current case...\n        for L_x, L_y, L_z in case:\n            # 1. Compute the system size parameter S.\n            S = 1.0 / L_x + 1.0 / L_y + 1.0 / L_z\n            S_values.append(S)\n\n            # 2. Construct the total finite-size mean force F_L(z).\n            F_L_vals = F_inf_vals + beta_vals * S\n            \n            # 3. Numerically integrate F_L(z) to get W_L(z) using the trapezoid rule.\n            # The 'initial=0' argument ensures W_L(0) = 0.\n            W_L_vals = cumulative_trapezoid(F_L_vals, z, initial=0)\n            W_L_profiles.append(W_L_vals)\n\n        # 4. Perform linear regression for each grid point to find W_infinity(z).\n        # We have a set of W_L(z_i) and S values. We need to find the intercept\n        # of the W_L(z_i) vs. S plot for each z_i.\n\n        # Transpose the list of profiles into an array where each row corresponds\n        # to a z-point and columns correspond to different S values.\n        W_L_by_z = np.array(W_L_profiles).T\n\n        # Array to store the extrapolated infinite-system PMF.\n        W_inf_extrapolated = np.zeros(N)\n\n        for i in range(N):\n            # Use np.polyfit for linear regression: W_L(z_i) = slope * S + intercept.\n            # polyfit returns [slope, intercept] for degree 1.\n            coefficients = np.polyfit(S_values, W_L_by_z[i], 1)\n            # The intercept is the extrapolated value at S=0, which is W_infinity(z_i).\n            W_inf_extrapolated[i] = coefficients[1]\n\n        # 5. Determine the barrier height.\n        # The barrier is at z = Z_max / 2.\n        # The corresponding grid index is (N-1)/2.\n        mid_point_index = (N - 1) // 2\n        barrier_height = W_inf_extrapolated[mid_point_index]\n\n        # 6. Round the result to three decimal places and store it.\n        results.append(f\"{barrier_height:.3f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}