{
    "hands_on_practices": [
        {
            "introduction": "在数值求解偏微分方程时，选择合适的时间积分方案对求解的准确性、稳定性和计算效率至关重要。本练习将通过一个电化学中常见的电解质耗散问题，让您亲手实现并比较三种经典的隐式时间步进方法：隐式欧拉法、Crank-Nicolson法和二阶向后差分格式（BDF2）。通过完成这个练习 ，您将学会如何评估不同数值方法在精度、稳定性以及保持物理解（如浓度非负性）等方面的优劣，从而为解决更复杂的模型打下坚实的基础。",
            "id": "3933711",
            "problem": "考虑一个由质量守恒和菲克扩散控制的一维电解质域。令 $c(x,t)$ 表示电解质中的盐浓度，单位为 $\\mathrm{mol/m^3}$，其定义在空间区间 $x \\in [0,L]$ 和时间 $t \\in [0,T]$ 上。在充电脉冲下，$c(x,t)$ 的演化由以下抛物型偏微分方程（PDE）建模\n$$\n\\frac{\\partial c}{\\partial t}(x,t) \\;=\\; D \\,\\frac{\\partial^2 c}{\\partial x^2}(x,t) \\;-\\; s(t),\n$$\n其中 $D$ 是扩散系数，单位为 $\\mathrm{m^2/s}$；$s(t)$ 是一个均匀的体积汇项，单位为 $\\mathrm{mol/(m^3\\cdot s)}$，代表充电脉冲期间的净盐消耗。边界条件为零通量（诺伊曼）条件，\n$$\n\\frac{\\partial c}{\\partial x}(0,t) \\;=\\; 0, \\qquad \\frac{\\partial c}{\\partial x}(L,t) \\;=\\; 0,\n$$\n初始条件为均匀分布，\n$$\nc(x,0) \\;=\\; c_0.\n$$\n充电脉冲由一个分段常数汇项表示，\n$$\ns(t) \\;=\\; \n\\begin{cases}\ns_0, & t_{\\mathrm{on}} \\le t  t_{\\mathrm{off}},\\\\\n0,  \\text{其它情况}.\n\\end{cases}\n$$\n从上述物理定律和定义出发，使用强制执行零通量边界条件的二阶中心差分对空间域进行离散化，并为以下三种隐式方法推导全离散时间步进更新式：\n- 隐式欧拉法，\n- Crank–Nicolson 方法，\n- 二阶向后差分公式（BDF2，定义为使用可产生二阶精度的多项式系数的向后差分公式（BDF））。\n\n使用这些更新式来实现一个数值程序，该程序针对每种方法和每个测试用例，推进离散浓度场，检测电解质耗尽，并计算精度和稳定性指标。\n\n定义和指标：\n- 电解质耗尽阈值 $c_{\\min,*}$ 是一个指定的浓度，单位为 $\\mathrm{mol/m^3}$。使用离散时间网格，将耗尽时间 $\\tau_{\\mathrm{dep}}$ 定义为离散浓度的空间最小值首次低于 $c_{\\min,*}$ 的最早时间。如果在 $[0,T]$ 内未发生耗尽，则设 $\\tau_{\\mathrm{dep}}=T$。\n- 方法 $M$ 的最终时刻相对 $L^2$ 误差为\n$$\n\\mathcal{E}_{L^2}(M) \\;=\\; \\frac{\\left\\|c_M(\\cdot,T) \\;-\\; c_{\\mathrm{ref}}(\\cdot,T)\\right\\|_2}{\\left\\|c_{\\mathrm{ref}}(\\cdot,T)\\right\\|_2},\n$$\n其中 $c_{\\mathrm{ref}}(\\cdot,T)$ 是通过隐式欧拉法以时间步长 $\\Delta t_{\\mathrm{ref}} = 10^{-3}\\,\\mathrm{s}$ 计算得到的高保真度参考解。\n- 方法 $M$ 的耗尽时间绝对误差为\n$$\n\\left|\\tau_{\\mathrm{dep}}(M) \\;-\\; \\tau_{\\mathrm{dep}}(\\mathrm{ref})\\right| \\quad \\text{单位} \\quad \\mathrm{s}.\n$$\n- 正性违反标志是一个整数，如果所有节点和所有时间步的 $c(x,t)\\ge 0$，则定义为 $0$；如果任何节点在任何时间步变为负值，则定义为 $1$。\n- 脉冲期间的单调性违反计数是指在区间 $[t_{\\mathrm{on}}, t_{\\mathrm{off}})$ 内，离散浓度的空间最小值相比于前一个时间步有所增加的离散时间步的数量。\n\n科学和数值要求：\n- 以指定单位表示所有物理量：$c$ 的单位为 $\\mathrm{mol/m^3}$，$D$ 的单位为 $\\mathrm{m^2/s}$，$L$ 的单位为 $\\mathrm{m}$，$t$ 的单位为 $\\mathrm{s}$，$s(t)$ 的单位为 $\\mathrm{mol/(m^3\\cdot s)}$。\n- 从偏微分方程和边界条件推导离散算子和更新式，不使用简化公式。空间算子必须与零通量边界下的二阶导数一致。\n- 时间步进的实现对于扩散算子必须是完全隐式的。源项的处理应与每种方法的时间离散化方式保持一致。\n\n测试套件：\n为以下三个测试用例实现程序，每个用例由元组 $(D, L, N, T, \\Delta t, s_0, t_{\\mathrm{on}}, t_{\\mathrm{off}}, c_0, c_{\\min,*})$ 定义：\n- 用例 A：$(2.0\\times 10^{-10},\\, 1.0\\times 10^{-4},\\, 50,\\, 2.0,\\, 0.02,\\, 50.0,\\, 0.5,\\, 1.5,\\, 1000.0,\\, 800.0)$\n- 用例 B：$(1.0\\times 10^{-10},\\, 1.0\\times 10^{-4},\\, 60,\\, 2.0,\\, 0.2,\\, 300.0,\\, 0.4,\\, 1.8,\\, 1000.0,\\, 700.0)$\n- 用例 C：$(5.0\\times 10^{-11},\\, 1.5\\times 10^{-4},\\, 40,\\, 1.5,\\, 0.05,\\, 600.0,\\, 0.2,\\, 0.8,\\, 1200.0,\\, 900.0)$\n\n对于每个测试用例，使用隐式欧拉法和时间步长 $\\Delta t_{\\mathrm{ref}} = 10^{-3}$ 计算高保真度参考解，然后使用该用例指定的 $\\Delta t$ 运行这三种方法。对于每种方法和每个用例，计算：\n- 耗尽时间绝对误差，单位为 $\\mathrm{s}$，\n- 最终时刻相对 $L^2$ 误差（无量纲），\n- 正性违反标志（整数 0 或 1），\n- 脉冲期间的单调性违反计数（整数）。\n\n最终输出规范：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。该列表必须按测试用例（A，然后是 B，然后是 C）排序。在每个测试用例中，按方法排序：隐式欧拉法、Crank–Nicolson、BDF2。在每种方法中，按上面列出的顺序排列指标。具体来说，输出应为\n$$\n[\\text{A-IE-dep\\_err},\\text{A-IE-relL2},\\text{A-IE-neg},\\text{A-IE-mono},\\text{A-CN-dep\\_err},\\text{A-CN-relL2},\\text{A-CN-neg},\\text{A-CN-mono},\\text{A-BDF2-dep\\_err},\\text{A-BDF2-relL2},\\text{A-BDF2-neg},\\text{A-BDF2-mono},\\text{B-IE-dep\\_err},\\ldots,\\text{C-BDF2-mono}]\n$$\n其中耗尽时间误差的单位为 s，相对 $L^2$ 误差是无量纲浮点数，标志和计数是整数。不应打印任何额外文本。",
            "solution": "用户希望使用三种不同的隐式时间步进格式求解一维反应扩散偏微分方程，并基于若干指标评估其性能。\n\n### 第 1 步：问题验证\n\n**1.1. 提取给定信息**\n\n- **偏微分方程**：$\\frac{\\partial c}{\\partial t}(x,t) = D \\,\\frac{\\partial^2 c}{\\partial x^2}(x,t) - s(t)$\n- **域**：$x \\in [0,L]$，$t \\in [0,T]$\n- **变量**：$c(x,t)$ 是盐浓度 ($\\mathrm{mol/m^3}$)，$D$ 是扩散系数 ($\\mathrm{m^2/s}$)，$s(t)$ 是一个汇项 ($\\mathrm{mol/(m^3\\cdot s)}$)。\n- **边界条件 (BCs)**：零通量（诺伊曼），$\\frac{\\partial c}{\\partial x}(0,t) = 0$ 和 $\\frac{\\partial c}{\\partial x}(L,t) = 0$。\n- **初始条件 (IC)**：均匀分布，$c(x,0) = c_0$。\n- **汇项**：分段常数，$s(t) = s_0$ 当 $t_{\\mathrm{on}} \\le t  t_{\\mathrm{off}}$ 时，其它情况为 $0$。\n- **离散化方法**：空间采用二阶中心差分。时间采用隐式欧拉法、Crank–Nicolson 和 BDF2。\n- **指标**：\n    - **耗尽时间 $\\tau_{\\mathrm{dep}}$**：$\\min_x c(x,t)  c_{\\min,*}$ 的最早时间 $t$。若未发生耗尽，则 $\\tau_{\\mathrm{dep}} = T$。\n    - **耗尽时间绝对误差**：$|\\tau_{\\mathrm{dep}}(M) - \\tau_{\\mathrm{dep}}(\\mathrm{ref})|$。\n    - **最终时刻相对 $L^2$ 误差**：$\\mathcal{E}_{L^2}(M) = \\frac{\\left\\|c_M(\\cdot,T) - c_{\\mathrm{ref}}(\\cdot,T)\\right\\|_2}{\\left\\|c_{\\mathrm{ref}}(\\cdot,T)\\right\\|_2}$。\n    - **正性违反标志**：若在任何点 $c(x,t)  0$，则为 $1$，否则为 $0$。\n    - **单调性违反计数**：在 $[t_{\\mathrm{on}}, t_{\\mathrm{off}})$ 区间内，满足 $\\min_x c(x, t_{k+1})  \\min_x c(x, t_k)$ 的时间步数。\n- **参考解**：使用隐式欧拉法和 $\\Delta t_{\\mathrm{ref}} = 10^{-3}\\,\\mathrm{s}$ 计算。\n- **测试用例**：\n    - A: $(D=2.0\\times 10^{-10}, L=1.0\\times 10^{-4}, N=50, T=2.0, \\Delta t=0.02, s_0=50.0, t_{\\mathrm{on}}=0.5, t_{\\mathrm{off}}=1.5, c_0=1000.0, c_{\\min,*}=800.0)$\n    - B: $(D=1.0\\times 10^{-10}, L=1.0\\times 10^{-4}, N=60, T=2.0, \\Delta t=0.2, s_0=300.0, t_{\\mathrm{on}}=0.4, t_{\\mathrm{off}}=1.8, c_0=1000.0, c_{\\min,*}=700.0)$\n    - C: $(D=5.0\\times 10^{-11}, L=1.5\\times 10^{-4}, N=40, T=1.5, \\Delta t=0.05, s_0=600.0, t_{\\mathrm{on}}=0.2, t_{\\mathrm{off}}=0.8, c_0=1200.0, c_{\\min,*}=900.0)$\n\n**1.2. 使用提取的给定信息进行验证**\n\n- **具有科学依据**：该问题描述了带汇项的菲克扩散，这是输运现象和电化学中的一个基本模型。它在科学上是有效的。\n- **适定的**：该问题是一个具有确定初始和边界条件的适定抛物型偏微分方程。数值任务是标准的。\n- **客观的**：问题使用精确的数学和物理术语陈述。指标定义客观。\n- **完整性**：提供了解决问题所需的所有必要参数、条件和定义。\n- **一致性**：所有给定信息内部一致。\n\n**1.3. 结论与行动**\n\n问题有效。我们继续进行求解。\n\n### 第 2 步：推导与求解\n\n**2.1. 空间离散化**\n\n我们将空间域 $x \\in [0,L]$ 离散化为 $N$ 个等距节点 $x_i = i\\Delta x$，其中 $i=0, 1, \\dots, N-1$，网格间距为 $\\Delta x = L/(N-1)$。令 $c_i(t)$ 为 $c(x_i, t)$ 的数值近似。\n\n在内部节点 $x_i$ ($1 \\le i \\le N-2$)，二阶空间导数 $\\frac{\\partial^2 c}{\\partial x^2}$ 使用二阶中心差分近似：\n$$ \\frac{\\partial^2 c}{\\partial x^2}(x_i,t) \\approx \\frac{c_{i+1}(t) - 2c_i(t) + c_{i-1}(t)}{\\Delta x^2} $$\n\n为强制执行零通量边界条件，我们引入虚拟节点 $c_{-1}(t)$ 和 $c_{N}(t)$。\n在左边界（$x=0$, $i=0$）：\n$$ \\frac{\\partial c}{\\partial x}(0,t) \\approx \\frac{c_1(t) - c_{-1}(t)}{2\\Delta x} = 0 \\implies c_{-1}(t) = c_1(t) $$\n因此，在 $i=0$ 处的偏微分方程离散为：\n$$ \\frac{d c_0}{d t} = D \\frac{c_1(t) - 2c_0(t) + c_{-1}(t)}{\\Delta x^2} - s(t) = D \\frac{2c_1(t) - 2c_0(t)}{\\Delta x^2} - s(t) $$\n在右边界（$x=L$, $i=N-1$）：\n$$ \\frac{\\partial c}{\\partial x}(L,t) \\approx \\frac{c_{N}(t) - c_{N-2}(t)}{2\\Delta x} = 0 \\implies c_{N}(t) = c_{N-2}(t) $$\n因此，在 $i=N-1$ 处的偏微分方程离散为：\n$$ \\frac{d c_{N-1}}{d t} = D \\frac{c_{N}(t) - 2c_{N-1}(t) + c_{N-2}(t)}{\\Delta x^2} - s(t) = D \\frac{2c_{N-2}(t) - 2c_{N-1}(t)}{\\Delta x^2} - s(t) $$\n\n这种线法（MOL）产生了一个包含 $N$ 个常微分方程（ODEs）的系统，可以写成矩阵形式：\n$$ \\frac{d\\mathbf{c}}{dt} = \\mathbf{A}\\mathbf{c}(t) - s(t)\\mathbf{1} $$\n其中 $\\mathbf{c}(t) = [c_0(t), c_1(t), \\dots, c_{N-1}(t)]^T$ 是浓度向量，$\\mathbf{1}$ 是全 1 向量，$\\mathbf{A}$ 是 $N \\times N$ 的空间离散化矩阵。令 $\\alpha = D / \\Delta x^2$，矩阵 $\\mathbf{A}$ 为：\n$$\n\\mathbf{A} = \\alpha\n\\begin{pmatrix}\n-2  2  0  \\dots   0 \\\\\n1  -2  1  0  \\dots  0 \\\\\n0  1  -2  1  \\ddots  \\vdots \\\\\n\\vdots  \\ddots  \\ddots  \\ddots    0 \\\\\n0  \\dots  0  1  -2  1 \\\\\n0   \\dots  0  2  -2\n\\end{pmatrix}\n$$\n\n**2.2. 时间离散化**\n\n令 $\\mathbf{c}^k$ 表示在时间 $t_k = k\\Delta t$ 的数值解向量，令 $\\mathbf{s}^k = s(t_k)\\mathbf{1}$。我们为所要求的三种隐式方法推导更新规则。\n\n**2.2.1. 隐式欧拉法 (IE)**\n这种一阶方法在 $t_{k+1}$ 处近似时间导数：\n$$ \\frac{\\mathbf{c}^{k+1} - \\mathbf{c}^k}{\\Delta t} = \\mathbf{A}\\mathbf{c}^{k+1} - \\mathbf{s}^{k+1} $$\n整理以求解未知量 $\\mathbf{c}^{k+1}$，我们得到线性系统：\n$$ (\\mathbf{I} - \\Delta t \\mathbf{A})\\mathbf{c}^{k+1} = \\mathbf{c}^k - \\Delta t \\mathbf{s}^{k+1} $$\n其中 $\\mathbf{I}$ 是单位矩阵。\n\n**2.2.2. Crank–Nicolson (CN)**\n这种二阶方法基于梯形法则，对 $t_k$ 和 $t_{k+1}$ 处的右侧项取平均：\n$$ \\frac{\\mathbf{c}^{k+1} - \\mathbf{c}^k}{\\Delta t} = \\frac{1}{2} \\left( (\\mathbf{A}\\mathbf{c}^{k} - \\mathbf{s}^{k}) + (\\mathbf{A}\\mathbf{c}^{k+1} - \\mathbf{s}^{k+1}) \\right) $$\n将含 $\\mathbf{c}^{k+1}$ 的项归到左侧，得到线性系统：\n$$ \\left(\\mathbf{I} - \\frac{\\Delta t}{2}\\mathbf{A}\\right)\\mathbf{c}^{k+1} = \\left(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{A}\\right)\\mathbf{c}^k - \\frac{\\Delta t}{2}(\\mathbf{s}^k + \\mathbf{s}^{k+1}) $$\n\n**2.2.3. 二阶向后差分公式 (BDF2)**\nBDF2 是一个二阶、两步法。其公式为：\n$$ \\frac{3\\mathbf{c}^{k+1} - 4\\mathbf{c}^k + \\mathbf{c}^{k-1}}{2\\Delta t} = \\mathbf{A}\\mathbf{c}^{k+1} - \\mathbf{s}^{k+1} $$\n这对于 $k \\ge 1$ 有效。对于第一步（$k=0$），需要一个单步法来生成 $\\mathbf{c}^1$。我们将为此启动步使用隐式欧拉法。对于 $k \\ge 1$，我们整理 BDF2 公式以求解 $\\mathbf{c}^{k+1}$：\n$$ (3\\mathbf{I} - 2\\Delta t\\mathbf{A})\\mathbf{c}^{k+1} = 4\\mathbf{c}^k - \\mathbf{c}^{k-1} - 2\\Delta t \\mathbf{s}^{k+1} $$\n这可以重写为：\n$$ \\left(\\mathbf{I} - \\frac{2}{3}\\Delta t\\mathbf{A}\\right)\\mathbf{c}^{k+1} = \\frac{4}{3}\\mathbf{c}^k - \\frac{1}{3}\\mathbf{c}^{k-1} - \\frac{2}{3}\\Delta t \\mathbf{s}^{k+1} $$\n\n**2.3. 算法实现**\n\n对于每个测试用例：\n1.  **参考解**：使用隐式欧拉法和一个非常小的时间步长 $\\Delta t_{\\mathrm{ref}} = 10^{-3}\\,\\mathrm{s}$，在时间区间 $[0, T]$ 上计算一个高保真度参考解。在此模拟过程中，记录参考耗尽时间 $\\tau_{\\mathrm{dep}}(\\mathrm{ref})$。存储最终的浓度分布 $\\mathbf{c}_{\\mathrm{ref}}(T)$。\n2.  **方法评估**：对于三种方法（IE, CN, BDF2）中的每一种，使用测试用例中指定的步长 $\\Delta t$ 运行模拟。\n3.  **时间步进循环**：对于每次模拟，创建一个初始浓度向量 $\\mathbf{c}^0 = c_0 \\mathbf{1}$。模拟在一个从 $t=0$到 $t=T$ 的时间循环中进行。在每一步中，构建并求解上面推导的相应线性系统，以获得 $\\mathbf{c}^{k+1}$。\n4.  **指标计算**：\n    - 在方法 $M$ 的模拟循环中，我们跟踪 $\\min(\\mathbf{c}^k)  c_{\\min,*}$ 发生的最早时间 $t_k$，以找到 $\\tau_{\\mathrm{dep}}(M)$。\n    - 我们维护一个正性违反标志，如果 $\\mathbf{c}^k$ 的任何分量变为负值，则将其设置为 1。\n    - 我们通过检查在脉冲区间 $[t_{\\mathrm{on}}, t_{\\mathrm{off}})$ 内是否有 $\\min(\\mathbf{c}^{k+1})  \\min(\\mathbf{c}^k)$ 来计算单调性违反次数。\n    - 循环完成后，获得最终浓度 $\\mathbf{c}_M(T)$。通过将 $\\mathbf{c}_M(T)$ 与 $\\mathbf{c}_{\\mathrm{ref}}(T)$ 使用离散向量 2-范数进行比较，计算相对 $L^2$ 误差 $\\mathcal{E}_{L^2}(M)$。耗尽时间绝对误差计算为 $|\\tau_{\\mathrm{dep}}(M) - \\tau_{\\mathrm{dep}}(\\mathrm{ref})|$。\n5.  **输出聚合**：收集每种方法和每个测试用例的四个计算指标，并按规定格式化为单个逗号分隔的列表。\n\n为测试用例提供的数值参数确保时间步进循环以整数步数运行。所涉及的线性系统中的矩阵是三对角的（或近似三对角），这允许高效求解，尽管考虑到 $N$ 的值较小，使用通用稠密求解器也足够了。",
            "answer": "```python\nimport numpy as np\n\ndef run_simulation(method, D, L, N, T, dt, s0, t_on, t_off, c0, c_min_star):\n    \"\"\"\n    Solves the 1D diffusion-reaction PDE for a given numerical method.\n\n    Returns:\n        tuple: (final concentration profile, depletion time, positivity violation flag, monotonicity violation count)\n    \"\"\"\n    dx = L / (N - 1)\n    \n    # Build the spatial discretization matrix A\n    A = np.diag(np.full(N, -2.0)) + np.diag(np.ones(N - 1), 1) + np.diag(np.ones(N - 1), -1)\n    A[0, 1] = 2.0\n    A[N - 1, N - 2] = 2.0\n    A *= D / (dx**2)\n\n    # Time integration setup\n    num_steps = int(round(T / dt))\n    time_points = np.linspace(0, T, num_steps + 1)\n\n    # Initial condition\n    c_current = np.full(N, c0, dtype=float)\n\n    # Sink term function\n    def s(t):\n        return s0 if t_on = t  t_off else 0.0\n\n    # Initialize metrics\n    depletion_time = T\n    positivity_violation = 0\n    monotonicity_violation_count = 0\n    \n    # Pre-compute matrices for linear solves\n    M_IE, M_CN_L, M_CN_R, M_BDF2 = None, None, None, None\n    if method == \"IE\" or (method == \"BDF2\"): # BDF2 uses IE for startup\n        M_IE = np.identity(N) - dt * A\n    if method == \"CN\":\n        M_CN_L = np.identity(N) - (dt / 2.0) * A\n        M_CN_R = np.identity(N) + (dt / 2.0) * A\n    if method == \"BDF2\":\n        M_BDF2 = np.identity(N) - (2.0 * dt / 3.0) * A\n    \n    c_prev = None  # For BDF2\n\n    # Time-stepping loop\n    for k in range(num_steps):\n        t_current = time_points[k]\n        t_next = time_points[k+1]\n        \n        s_current_val = s(t_current)\n        s_next_val = s(t_next)\n\n        min_c_before_step = np.min(c_current)\n\n        if method == \"IE\":\n            rhs = c_current - dt * s_next_val\n            c_next = np.linalg.solve(M_IE, rhs)\n        \n        elif method == \"CN\":\n            s_avg = (s_current_val + s_next_val) / 2.0\n            rhs = M_CN_R @ c_current - dt * s_avg\n            c_next = np.linalg.solve(M_CN_L, rhs)\n\n        elif method == \"BDF2\":\n            if k == 0:\n                # First step with Implicit Euler\n                rhs_ie = c_current - dt * s_next_val\n                c_next = np.linalg.solve(M_IE, rhs_ie)\n            else:\n                # Subsequent steps with BDF2\n                rhs = (4.0/3.0) * c_current - (1.0/3.0) * c_prev - (2.0 * dt / 3.0) * s_next_val\n                c_next = np.linalg.solve(M_BDF2, rhs)\n            c_prev = c_current.copy()\n        else: # Should not happen\n            c_next = c_current\n\n        # Update state\n        c_current = c_next\n\n        # Check metrics\n        if np.min(c_current)  c_min_star and depletion_time == T:\n            depletion_time = t_next\n        if np.any(c_current  0):\n            positivity_violation = 1\n        \n        if t_on = t_current  t_off:\n            if np.min(c_current) > min_c_before_step:\n                monotonicity_violation_count += 1\n\n    return c_current, depletion_time, positivity_violation, monotonicity_violation_count\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # (D, L, N, T, dt, s0, t_on, t_off, c0, c_min_star)\n        (2.0e-10, 1.0e-4, 50, 2.0, 0.02, 50.0, 0.5, 1.5, 1000.0, 800.0), # Case A\n        (1.0e-10, 1.0e-4, 60, 2.0, 0.2, 300.0, 0.4, 1.8, 1000.0, 700.0), # Case B\n        (5.0e-11, 1.5e-4, 40, 1.5, 0.05, 600.0, 0.2, 0.8, 1200.0, 900.0), # Case C\n    ]\n\n    all_results = []\n    \n    for case_params in test_cases:\n        D, L, N, T, dt, s0, t_on, t_off, c0, c_min_star = case_params\n        N = int(N)\n\n        # 1. Compute reference solution\n        dt_ref = 1e-3\n        c_ref_T, tau_dep_ref, _, _ = run_simulation(\n            \"IE\", D, L, N, T, dt_ref, s0, t_on, t_off, c0, c_min_star\n        )\n        norm_c_ref_T = np.linalg.norm(c_ref_T)\n        \n        methods = [\"IE\", \"CN\", \"BDF2\"]\n        for method in methods:\n            # 2. Run simulation for the current method\n            c_M_T, tau_dep_M, pos_viol_M, mono_count_M = run_simulation(\n                method, D, L, N, T, dt, s0, t_on, t_off, c0, c_min_star\n            )\n            \n            # 3. Compute metrics\n            dep_err = abs(tau_dep_M - tau_dep_ref)\n            \n            if norm_c_ref_T > 1e-12:\n                rel_L2_err = np.linalg.norm(c_M_T - c_ref_T) / norm_c_ref_T\n            elif np.linalg.norm(c_M_T - c_ref_T)  1e-12:\n                rel_L2_err = 0.0\n            else: # Should not happen in this problem\n                rel_L2_err = np.linalg.norm(c_M_T - c_ref_T)\n\n            # Append results for this method\n            all_results.extend([dep_err, rel_L2_err, pos_viol_M, mono_count_M])\n\n    # Final print statement\n    formatted_results = [f'{x:.6f}' if isinstance(x, float) else str(x) for x in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "真实的电池模型，如多孔电极模型，通常由一组高度耦合的非线性偏微分方程组构成。求解这类问题最强大的工具之一是牛顿法，而牛顿法的核心在于精确计算系统的雅可比矩阵。本练习  旨在训练一项关键的解析能力：针对电化学模型中的核心非线性项，如Butler-Volmer动力学和离子迁移项，推导其雅可比矩阵元素的精确解析表达式。掌握这项技能不仅能加深对模型内在耦合关系的理解，更能显著提升数值求解器的稳定性和收敛效率。",
            "id": "3933656",
            "problem": "考虑一个在等温条件下的锂离子电池的多孔电极和二元电解质模型，该模型为通过自动化电池设计循环中的 Newton–Krylov 方法进行数值求解而建立。活性材料-电解质界面的动力学遵循 Butler–Volmer 关系，其交换电流密度通过关于局部固相锂浓度和局部电解质盐浓度的幂律来建模。电解质中的离子迁移由 Nernst–Planck 通量和 Einstein 关系共同描述。假设以下经过充分检验的本构关系和定义。\n\n设界面反应电流密度由 $j(\\eta,c_{s},c_{e})$ 给出，其中\n$$\nj(\\eta,c_{s},c_{e}) = i_{0}(c_{s},c_{e})\\left[\\exp\\!\\left(\\frac{\\alpha_{a} F \\eta}{R T}\\right) - \\exp\\!\\left(-\\frac{\\alpha_{c} F \\eta}{R T}\\right)\\right],\n$$\n其中交换电流密度为\n$$\ni_{0}(c_{s},c_{e}) = k\\, c_{s}^{m}\\, c_{e}^{n},\n$$\n且过电位为\n$$\n\\eta = \\phi_{s} - \\phi_{e} - U(c_{s}).\n$$\n此处，$k0$ 是一个动力学指前因子，$m$ 和 $n$ 是实数指数，$\\alpha_{a}\\in(0,1)$ 和 $\\alpha_{c}\\in(0,1)$ 分别是阳极和阴极电荷转移系数，$F$ 是法拉第常数，$R$ 是理想气体常数，$T$ 是绝对温度，$\\phi_{s}$ 是固相电位，$\\phi_{e}$ 是电解质电位，$U(c_{s})$ 是开路电位，并假设其可微，导数为 $U'(c_{s})$。\n\n设价态为 $z$（假设为正）的二元盐的电解质迁移通量通过 Nernst–Planck 关系和 Einstein 关系建模为\n$$\nJ_{\\mathrm{mig}} = -\\frac{z F D}{R T}\\, c\\, \\nabla \\phi_{e},\n$$\n其中 $D0$ 是有效盐扩散系数，$c$ 是盐浓度，$\\nabla \\phi_{e}$ 是电解质电位的梯度。考虑一个一维均匀有限体积离散化，网格间距为 $\\Delta x0$，网格中心未知量为 $c_{j}$ 和 $\\phi_{e,j}$，网格面中心算术平均值为 $c_{j+\\frac{1}{2}} = \\frac{c_{j+1}+c_{j}}{2}$ 和 $c_{j-\\frac{1}{2}} = \\frac{c_{j}+c_{j-1}}{2}$。定义内部节点 $j$ 处的离散迁移残差为\n$$\nR^{\\mathrm{mig}}_{j} = \\frac{1}{\\Delta x}\\left[J^{\\mathrm{mig}}_{j+\\frac{1}{2}} - J^{\\mathrm{mig}}_{j-\\frac{1}{2}}\\right]\n= -\\frac{z F D}{R T\\, \\Delta x^{2}}\\left[c_{j+\\frac{1}{2}}(\\phi_{e,j+1}-\\phi_{e,j}) - c_{j-\\frac{1}{2}}(\\phi_{e,j}-\\phi_{e,j-1})\\right].\n$$\n\n你的任务是推导以下雅可比矩阵项的精确解析表达式，这些表达式将用于 Newton 线性化，而无需借助有限差分近似：\n\n- 在 $T$、$k$、$m$、$n$、$\\alpha_{a}$、$\\alpha_{c}$、$F$、$R$ 固定，且 $U(c_{s})$ 可微的情况下，$j(\\eta,c_{s},c_{e})$ 关于 $\\phi_{s}$、$\\phi_{e}$、$c_{e}$ 和 $c_{s}$ 的偏导数。\n- 将 $c_{j\\pm \\frac{1}{2}}$ 视为指定的算术平均值，并保持 $D$、$z$、$F$、$R$、$T$ 和 $\\Delta x$ 恒定的情况下，$R^{\\mathrm{mig}}_{j}$ 关于 $c_{j}$ 和 $\\phi_{e,j}$ 的偏导数。\n\n将你的最终结果按以下顺序表示为一个单行矩阵：\n$$\n\\left(\\frac{\\partial j}{\\partial \\phi_{s}}\\,,\\,\\frac{\\partial j}{\\partial \\phi_{e}}\\,,\\,\\frac{\\partial j}{\\partial c_{e}}\\,,\\,\\frac{\\partial j}{\\partial c_{s}}\\,,\\,\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}}\\,,\\,\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}}\\right).\n$$\n\n提供闭式解析表达式。无需进行数值计算。不要在最终的方框答案中包含物理单位。",
            "solution": "用户提供了一个问题，要求推导一个模拟锂离子电池的方程组的特定雅可比矩阵项。该过程从对问题陈述的形式化验证开始。\n\n### 步骤 1：提取已知条件\n问题提供了以下定义和关系：\n- 界面反应电流密度: $j(\\eta,c_{s},c_{e}) = i_{0}(c_{s},c_{e})\\left[\\exp\\!\\left(\\frac{\\alpha_{a} F \\eta}{R T}\\right) - \\exp\\!\\left(-\\frac{\\alpha_{c} F \\eta}{R T}\\right)\\right]$\n- 交换电流密度: $i_{0}(c_{s},c_{e}) = k\\, c_{s}^{m}\\, c_{e}^{n}$\n- 过电位: $\\eta = \\phi_{s} - \\phi_{e} - U(c_{s})$\n- 动力学的常数和参数: $k0$, $m$, $n$, $\\alpha_{a}\\in(0,1)$, $\\alpha_{c}\\in(0,1)$, $F$, $R$, $T$。$U(c_s)$ 是一个可微函数，其导数为 $U'(c_s)$。\n- 电解质迁移通量: $J_{\\mathrm{mig}} = -\\frac{z F D}{R T}\\, c\\, \\nabla \\phi_{e}$\n- 内部节点 j 处的离散迁移残差: $R^{\\mathrm{mig}}_{j} = -\\frac{z F D}{R T\\, \\Delta x^{2}}\\left[c_{j+\\frac{1}{2}}(\\phi_{e,j+1}-\\phi_{e,j}) - c_{j-\\frac{1}{2}}(\\phi_{e,j}-\\phi_{e,j-1})\\right]$\n- 离散网格面中心平均值: $c_{j+\\frac{1}{2}} = \\frac{c_{j+1}+c_{j}}{2}$ 和 $c_{j-\\frac{1}{2}} = \\frac{c_{j}+c_{j-1}}{2}$\n- 迁移的常数: $D0$, $z0$, $\\Delta x0$。\n- 任务是计算偏导数：$\\frac{\\partial j}{\\partial \\phi_{s}}$, $\\frac{\\partial j}{\\partial \\phi_{e}}$, $\\frac{\\partial j}{\\partial c_{e}}$, $\\frac{\\partial j}{\\partial c_{s}}$, $\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}}$, 和 $\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}}$。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据：** 该问题牢固地定位于电化学工程这一成熟领域，特别是电池中多孔电极的建模（一个简化的“Newman 模型”）。用于反应动力学的 Butler-Volmer 方程、用于离子输运的 Nernst–Planck 通量，以及用于离散化的有限体积法，都是标准的、科学上合理的概念。\n- **适定性：** 任务是计算一组解析定义的函数的偏导数。这些函数由基本函数（指数函数、幂律函数）和一个一般的可微函数 $U(c_s)$ 组成。计算过程是多元微积分法则（链式法则、乘法法则）的直接应用，会得出一个唯一的、明确定义的解析结果。\n- **客观性：** 该问题以精确的数学语言陈述。所有变量、常数和函数都被清晰定义，没有歧义或主观措辞。\n\n该问题陈述没有违反任何无效标准。它是科学上合理的、适定的、客观的、完整的，并且要求一个对于电池模型的数值解至关重要的、非平凡但可行的计算。\n\n### 步骤 3：结论与行动\n该问题是有效的。将推导解答。\n\n### 雅可比矩阵项的推导\n\n雅可比矩阵项通过应用偏微分法则计算得出。\n\n**第 1 部分：反应电流密度 $j$ 的偏导数。**\n\n函数 $j$ 是 $\\phi_s$、$\\phi_e$、$c_s$ 和 $c_e$ 的复合函数，这是通过 $i_0(c_s, c_e)$ 和 $\\eta(\\phi_s, \\phi_e, c_s)$ 的依赖关系实现的。$j$ 的表达式为：\n$$j = k c_s^m c_e^n \\left[ \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n其中 $\\eta = \\phi_s - \\phi_e - U(c_s)$。\n\n1.  **关于 $\\phi_s$ 的导数**：\n    我们使用链式法则：$\\frac{\\partial j}{\\partial \\phi_s} = \\frac{\\partial j}{\\partial \\eta} \\frac{\\partial \\eta}{\\partial \\phi_s}$。\n    过电位关于 $\\phi_s$ 的导数是 $\\frac{\\partial \\eta}{\\partial \\phi_s} = \\frac{\\partial}{\\partial \\phi_s}(\\phi_s - \\phi_e - U(c_s)) = 1$。\n    $j$ 关于 $\\eta$ 的导数是：\n    $$\\frac{\\partial j}{\\partial \\eta} = k c_s^m c_e^n \\left[ \\frac{\\alpha_a F}{RT} \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\left(-\\frac{\\alpha_c F}{RT}\\right) \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n    $$\\frac{\\partial j}{\\partial \\eta} = \\frac{k c_s^m c_e^n F}{RT} \\left[ \\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n    因此，$\\frac{\\partial j}{\\partial \\phi_s} = \\frac{\\partial j}{\\partial \\eta} \\cdot 1$：\n    $$\\frac{\\partial j}{\\partial \\phi_s} = \\frac{k c_s^m c_e^n F}{RT} \\left[ \\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n\n2.  **关于 $\\phi_e$ 的导数**：\n    再次使用链式法则：$\\frac{\\partial j}{\\partial \\phi_e} = \\frac{\\partial j}{\\partial \\eta} \\frac{\\partial \\eta}{\\partial \\phi_e}$。\n    过电位关于 $\\phi_e$ 的导数是 $\\frac{\\partial \\eta}{\\partial \\phi_e} = \\frac{\\partial}{\\partial \\phi_e}(\\phi_s - \\phi_e - U(c_s)) = -1$。\n    因此，$\\frac{\\partial j}{\\partial \\phi_e} = \\frac{\\partial j}{\\partial \\eta} \\cdot (-1) = -\\frac{\\partial j}{\\partial \\phi_s}$：\n    $$\\frac{\\partial j}{\\partial \\phi_e} = - \\frac{k c_s^m c_e^n F}{RT} \\left[ \\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n\n3.  **关于 $c_e$ 的导数**：\n    过电位 $\\eta$ 不依赖于 $c_e$。依赖关系仅通过指前因子 $i_0 = k c_s^m c_e^n$ 体现。\n    $$\\frac{\\partial j}{\\partial c_e} = k c_s^m (n c_e^{n-1}) \\left[ \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n    这可以通过注意到 $\\frac{\\partial i_0}{\\partial c_e} = \\frac{n}{c_e} i_0$ 来简化，从而得到 $\\frac{\\partial j}{\\partial c_e} = \\frac{n}{c_e} j$。完整表达式为：\n    $$\\frac{\\partial j}{\\partial c_e} = n k c_s^m c_e^{n-1} \\left[ \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$$\n\n4.  **关于 $c_s$ 的导数**：\n    $i_0$ 和 $\\eta$ 都依赖于 $c_s$。我们应用乘法法则和链式法则：$\\frac{\\partial j}{\\partial c_s} = \\frac{\\partial (i_0 \\cdot f(\\eta))}{\\partial c_s} = \\frac{\\partial i_0}{\\partial c_s} f(\\eta) + i_0 \\frac{\\partial f(\\eta)}{\\partial c_s}$。\n    项 $f(\\eta) = \\left[ \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right]$。\n    - $\\frac{\\partial i_0}{\\partial c_s} = \\frac{\\partial}{\\partial c_s}(k c_s^m c_e^n) = m k c_s^{m-1} c_e^n$。\n    - $\\frac{\\partial f(\\eta)}{\\partial c_s} = \\frac{\\partial f(\\eta)}{\\partial \\eta} \\frac{\\partial \\eta}{\\partial c_s}$。我们已经有 $\\frac{\\partial f(\\eta)}{\\partial \\eta} = \\frac{1}{i_0}\\frac{\\partial j}{\\partial \\eta}$。且 $\\frac{\\partial \\eta}{\\partial c_s} = \\frac{\\partial}{\\partial c_s}(\\phi_s - \\phi_e - U(c_s)) = -U'(c_s)$。\n    综合这些：\n    $$\\frac{\\partial j}{\\partial c_s} = (m k c_s^{m-1} c_e^n) f(\\eta) + i_0 \\left( \\frac{1}{i_0}\\frac{\\partial j}{\\partial \\eta} \\right) (-U'(c_s))$$\n    $$\\frac{\\partial j}{\\partial c_s} = m k c_s^{m-1} c_e^n \\left[ \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right] - U'(c_s) \\frac{\\partial j}{\\partial \\eta}$$\n    代入 $\\frac{\\partial j}{\\partial \\eta}$ 的表达式：\n    $$\\frac{\\partial j}{\\partial c_s} = m k c_s^{m-1} c_e^n \\left[ \\exp(\\dots) - \\exp(\\dots) \\right] - U'(c_s) \\frac{k c_s^m c_e^n F}{RT} \\left[ \\alpha_a \\exp(\\dots) + \\alpha_c \\exp(\\dots) \\right]$$\n    提出公因式：\n    $$\\frac{\\partial j}{\\partial c_s} = k c_s^{m-1} c_e^n \\left( m\\left[\\exp\\!\\left(\\frac{\\alpha_{a} F \\eta}{R T}\\right) - \\exp\\!\\left(-\\frac{\\alpha_{c} F \\eta}{R T}\\right)\\right] - \\frac{c_s F U'(c_s)}{RT}\\left[\\alpha_{a}\\exp\\!\\left(\\frac{\\alpha_{a} F \\eta}{R T}\\right) + \\alpha_{c}\\exp\\!\\left(-\\frac{\\alpha_{c} F \\eta}{R T}\\right)\\right] \\right)$$\n\n**第 2 部分：迁移残差 $R^{\\mathrm{mig}}_{j}$ 的偏导数。**\n\n残差由下式给出：\n$$R^{\\mathrm{mig}}_{j} = -\\frac{z F D}{R T\\, \\Delta x^{2}}\\left[ \\left(\\frac{c_{j+1}+c_{j}}{2}\\right)(\\phi_{e,j+1}-\\phi_{e,j}) - \\left(\\frac{c_{j}+c_{j-1}}{2}\\right)(\\phi_{e,j}-\\phi_{e,j-1}) \\right]$$\n让我们定义常数 $K = -\\frac{z F D}{R T\\, \\Delta x^{2}}$。\n\n5.  **关于 $c_j$ 的导数**：\n    变量 $c_j$ 出现在两个网格面平均浓度 $c_{j+\\frac{1}{2}}$ 和 $c_{j-\\frac{1}{2}}$ 中。\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}} = K \\frac{\\partial}{\\partial c_j} \\left[ \\left(\\frac{c_{j+1}+c_{j}}{2}\\right)(\\phi_{e,j+1}-\\phi_{e,j}) - \\left(\\frac{c_{j}+c_{j-1}}{2}\\right)(\\phi_{e,j}-\\phi_{e,j-1}) \\right]$$\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}} = K \\left[ \\frac{1}{2}(\\phi_{e,j+1}-\\phi_{e,j}) - \\frac{1}{2}(\\phi_{e,j}-\\phi_{e,j-1}) \\right]$$\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}} = \\frac{K}{2} (\\phi_{e,j+1} - 2\\phi_{e,j} + \\phi_{e,j-1})$$\n    代入 $K$ 的表达式：\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial c_{j}} = -\\frac{z F D}{2 R T \\Delta x^2}(\\phi_{e,j+1} - 2\\phi_{e,j} + \\phi_{e,j-1})$$\n\n6.  **关于 $\\phi_{e,j}$ 的导数**：\n    变量 $\\phi_{e,j}$ 出现在两个电位差项中。\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}} = K \\frac{\\partial}{\\partial \\phi_{e,j}} \\left[ c_{j+\\frac{1}{2}}(\\phi_{e,j+1}-\\phi_{e,j}) - c_{j-\\frac{1}{2}}(\\phi_{e,j}-\\phi_{e,j-1}) \\right]$$\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}} = K \\left[ c_{j+\\frac{1}{2}}(-1) - c_{j-\\frac{1}{2}}(1) \\right] = -K (c_{j+\\frac{1}{2}} + c_{j-\\frac{1}{2}})$$\n    代入网格面浓度的定义：\n    $$c_{j+\\frac{1}{2}} + c_{j-\\frac{1}{2}} = \\frac{c_{j+1}+c_{j}}{2} + \\frac{c_{j}+c_{j-1}}{2} = \\frac{c_{j-1}+2c_j+c_{j+1}}{2}$$\n    因此：\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}} = -K \\left( \\frac{c_{j-1}+2c_j+c_{j+1}}{2} \\right)$$\n    代入 $K$ 的表达式：\n    $$\\frac{\\partial R^{\\mathrm{mig}}_{j}}{\\partial \\phi_{e,j}} = \\frac{z F D}{2 R T \\Delta x^2} (c_{j-1}+2c_j+c_{j+1})$$\n\n这六个表达式构成了所需的雅可比矩阵项。现将它们编译成最终答案的格式。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{k c_s^m c_e^n F}{RT} \\left( \\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right)  - \\frac{k c_s^m c_e^n F}{RT} \\left( \\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right)  n k c_s^m c_e^{n-1} \\left( \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right) \\right)  k c_s^{m-1} c_e^n \\left( m\\left(\\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) - \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right)\\right) - \\frac{c_s F U'(c_s)}{RT}\\left(\\alpha_a \\exp\\left(\\frac{\\alpha_a F \\eta}{RT}\\right) + \\alpha_c \\exp\\left(-\\frac{\\alpha_c F \\eta}{RT}\\right)\\right) \\right)  -\\frac{z F D}{2 R T \\Delta x^{2}} \\left( \\phi_{e,j+1} - 2\\phi_{e,j} + \\phi_{e,j-1} \\right)  \\frac{z F D}{2 R T \\Delta x^{2}} \\left( c_{j-1} + 2c_{j} + c_{j+1} \\right) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "除了常见的有限差分或有限体积法，谱方法为求解特定类型的偏微分方程（尤其是带周期性边界条件的方程）提供了一种精度极高的选择。本练习  引导您探索一种优雅且高效的数值技术：将空间上的傅里叶谱方法与时间上的指数积分器相结合。这种组合能够（在不考虑浮点误差的情况下）精确求解线性常系数偏微分方程，让您直观地感受谱方法无与伦比的精度优势，并将其应用于一个包含扩散、迁移和反应过程的电解质输运问题中。",
            "id": "4254584",
            "problem": "考虑一个一维稀电解质，其中单一离子种类的浓度 $c(x,t)$ 在长度为 $L$ 的周期性微通道中，在扩散、恒定电泳漂移和均匀一级消耗反应的作用下演化。从粒子守恒定律和稀溶液的 Nernst-Planck 通量出发。粒子守恒定律为 $\\partial c / \\partial t + \\partial J / \\partial x = R(c)$，其中 $J$ 是粒子通量，$R(c)$ 是体积反应速率。对于具有恒定扩散系数 $D$ 的稀疏物质，在均匀电场作用下，一维 Nernst-Planck 通量对应于 $J = - D \\, \\partial c/\\partial x + v \\, c$，其中 $v$ 是一个恒定的漂移速度（用迁移率 $\\mu$、化合价 $z$、法拉第常数 $F$ 和均匀电场 $E$ 表示为 $v = \\mu z F E$）。假设一个均匀一级消耗反应 $R(c) = - \\kappa \\, c$。将这些结合起来，得到关于 $c(x,t)$ 在 $x \\in [0,L)$ 上具有周期性边界条件的线性偏微分方程。\n\n您将使用以下方法数值求解此初值问题：\n- 在空间上（周期域）使用傅里叶谱方法来表示空间导数，以及\n- 在时间上使用指数积分法，利用半离散系统的线性常系数结构。\n\n您的任务：\n1. 从所述定律出发，推导 $c(x,t)$ 的控制线性偏微分方程，形式为 $\\partial c / \\partial t = \\mathcal{L} c$，识别线性算子 $\\mathcal{L}$，并为每个波数为 $k$ 的傅里叶模式表达其傅里叶符号 $\\lambda_k$。\n2. 解释为什么傅里叶谱离散化能够对角化 $\\mathcal{L}$，并将半离散系统转化为傅里叶空间中形式为 $\\frac{\\mathrm{d}\\widehat{c}_k}{\\mathrm{d}t} = \\lambda_k \\, \\widehat{c}_k$ 的独立线性常微分方程，其中 $\\widehat{c}_k$ 表示模式 $k$ 的复傅里叶系数。\n3. 解释为什么对于任意时间步长 $\\Delta t$，指数时间积分法都能将每个傅里叶模式精确地推进为 $\\widehat{c}_k(t+\\Delta t) = \\exp(\\lambda_k \\, \\Delta t)\\,\\widehat{c}_k(t)$，并因此解释为什么在时间 $T$ 的完整解由 $\\widehat{c}_k(T) = \\exp(\\lambda_k \\, T) \\, \\widehat{c}_k(0)$ 给出。\n4. 实现一个程序，该程序：\n   - 在 $[0,L)$ 上用 $N$ 个等距点构建空间网格，组合适用于离散傅里叶变换的傅里叶波数 $k$，并计算初始条件\n     $$c(x,0) = \\bar{c} + a_1 \\cos\\!\\left(\\frac{2\\pi n_1 x}{L}\\right) + a_2 \\sin\\!\\left(\\frac{2\\pi n_2 x}{L}\\right)。$$\n   - 通过将 $c(x,0)$ 变换到傅里叶空间，将每个傅里叶系数乘以 $\\exp(\\lambda_k T)$，然后变换回物理空间，来计算指定最终时间 $T$ 的参考解 $c_{\\text{exact}}(x,T)$。\n   - 通过在傅里叶空间中以给定的时间步长 $\\Delta t$ 重复应用指数时间积分法，将解从 $t=0$ 数值地演化到 $t=T$，然后变换回去得到 $c_{\\text{num}}(x,T)$。\n   - 报告相对离散 $\\ell^2$ 误差\n     $$\\varepsilon = \\frac{\\left\\| c_{\\text{num}}(\\cdot,T) - c_{\\text{exact}}(\\cdot,T) \\right\\|_2}{\\left\\| c_{\\text{exact}}(\\cdot,T) \\right\\|_2},$$\n     其中离散 $\\ell^2$ 范数是在空间网格上计算的。\n5. 使用快速傅里叶变换 (FFT) 高效地实现傅里叶变换。使用等距网格和由离散傅里叶变换产生的离散波数的标准排序，波数大小为 $k = 2\\pi m / L$，其中 $m$ 是整数模式索引。\n6. 物理单位：$D$ 的单位为 $\\mathrm{m^2/s}$，$v$ 的单位为 $\\mathrm{m/s}$，$\\kappa$ 的单位为 $\\mathrm{s^{-1}}$，$L$ 的单位为 $\\mathrm{m}$，$T$ 和 $\\Delta t$ 的单位为 $\\mathrm{s}$。报告的误差 $\\varepsilon$ 是无量纲的。\n7. 测试套件和要求输出：对以下四个参数集运行您的程序。对于每种情况，计算并输出相对 $\\ell^2$ 误差 $\\varepsilon$，格式为具有 $12$ 位有效数字的科学记数法浮点数。\n   - 情况A（一般漂移-扩散-反应，顺利路径）：\n     - $D = 1.0\\times 10^{-9}$, $v = 1.0\\times 10^{-4}$, $\\kappa = 5.0\\times 10^{-1}$,\n     - $L = 1.0\\times 10^{-3}$, $N = 256$, $T = 1.0\\times 10^{-2}$, $\\Delta t = 1.0\\times 10^{-3}$,\n     - $\\bar{c} = 1.0$, $a_1 = 1.0\\times 10^{-1}$, $a_2 = 5.0\\times 10^{-2}$, $n_1 = 1$, $n_2 = 2$。\n   - 情况B（纯扩散-反应，无漂移，$v$的边界条件）：\n     - $D = 1.0\\times 10^{-9}$, $v = 0.0$, $\\kappa = 5.0\\times 10^{-1}$,\n     - $L = 1.0\\times 10^{-3}$, $N = 256$, $T = 1.0\\times 10^{-2}$, $\\Delta t = 1.0\\times 10^{-3}$,\n     - $\\bar{c} = 1.0$, $a_1 = 1.0\\times 10^{-1}$, $a_2 = 5.0\\times 10^{-2}$, $n_1 = 1$, $n_2 = 2$。\n   - 情况C（平流-扩散，无反应，$\\kappa=0$的边缘情况和更高空间频率）：\n     - $D = 1.0\\times 10^{-9}$, $v = 1.0\\times 10^{-4}$, $\\kappa = 0.0$,\n     - $L = 1.0\\times 10^{-3}$, $N = 256$, $T = 1.0\\times 10^{-2}$, $\\Delta t = 1.25\\times 10^{-3}$,\n     - $\\bar{c} = 1.0$, $a_1 = 1.0\\times 10^{-1}$, $a_2 = 0.0$, $n_1 = 32$, $n_2 = 0$。\n   - 情况D（更粗糙的空间和时间分辨率，混合模式）：\n     - $D = 1.0\\times 10^{-9}$, $v = 2.0\\times 10^{-4}$, $\\kappa = 1.0$,\n     - $L = 1.0\\times 10^{-3}$, $N = 64$, $T = 2.0\\times 10^{-2}$, $\\Delta t = 4.0\\times 10^{-3}$,\n     - $\\bar{c} = 1.0$, $a_1 = 2.0\\times 10^{-1}$, $a_2 = 1.5\\times 10^{-1}$, $n_1 = 7$, $n_2 = 11$。\n8. 最终输出格式要求：您的程序应生成单行输出，其中包含四个相对误差，以逗号分隔的列表形式用方括号括起来，每个浮点数采用具有12位有效数字的科学记数法，顺序为：情况 A、情况 B、情况 C、情况 D。例如，打印的行必须如下所示：\n   $$[\\varepsilon_A,\\varepsilon_B,\\varepsilon_C,\\varepsilon_D],$$\n   其中每个 $\\varepsilon$ 均按指定格式表示。\n\n您的实现必须是一个完整的、可运行的程序，它在内部执行所有计算，无需用户输入或外部文件，并遵守指定的执行环境。",
            "solution": "我们从粒子守恒定律 $\\partial c/\\partial t + \\partial J/\\partial x = R(c)$ 出发。对于在均匀电场中具有恒定扩散系数 $D$ 的稀电解质物质，一维的 Nernst-Planck 通量表达式简化为 $J = - D \\,\\partial c/\\partial x + v \\, c$，其中 $v$ 汇集了由迁移引起的恒定漂移速度，$v = \\mu z F E$。均匀一级消耗反应为 $R(c) = - \\kappa \\, c$。将这些代入守恒定律可得\n$$\n\\frac{\\partial c}{\\partial t} + \\frac{\\partial}{\\partial x}\\left(- D \\frac{\\partial c}{\\partial x} + v \\, c \\right) = - \\kappa \\, c.\n$$\n展开导数可得\n$$\n\\frac{\\partial c}{\\partial t} = D \\frac{\\partial^2 c}{\\partial x^2} - v \\frac{\\partial c}{\\partial x} - \\kappa \\, c.\n$$\n这具有 $\\partial c / \\partial t = \\mathcal{L} c$ 的形式，其中线性微分算子为\n$$\n\\mathcal{L} = D \\frac{\\partial^2}{\\partial x^2} - v \\frac{\\partial}{\\partial x} - \\kappa \\, I,\n$$\n$I$ 表示单位算子。在周期域 $x \\in [0,L)$ 上，很自然地使用傅里叶级数表示。设傅里叶变换对为\n$$\nc(x,t) = \\sum_{m=-\\infty}^{\\infty} \\widehat{c}_m(t) \\, e^{\\mathrm{i} k_m x}, \\quad k_m = \\frac{2\\pi m}{L}.\n$$\n将 $\\mathcal{L}$ 应用于傅里叶模式 $e^{\\mathrm{i} k x}$ 可得\n$$\n\\mathcal{L}\\left[e^{\\mathrm{i} k x}\\right] = \\left(-D k^2 + \\mathrm{i} v k - \\kappa\\right) e^{\\mathrm{i} k x}.\n$$\n因此，傅里叶符号（算子 $\\mathcal{L}$ 对模式 $k$ 的特征值）是\n$$\n\\lambda_k = - D k^2 + \\mathrm{i} v k - \\kappa.\n$$\n由于傅里叶模式是周期域上常系数线性微分算子的特征函数，傅里叶谱离散化可将 $\\mathcal{L}$ 对角化。在使用 $N$ 个等距点离散化 $x$ 并使用快速傅里叶变换 (FFT) 后，傅里叶空间中的半离散系统解耦为 $N$ 个独立的线性常微分方程\n$$\n\\frac{\\mathrm{d}\\widehat{c}_k}{\\mathrm{d}t} = \\lambda_k \\, \\widehat{c}_k,\n$$\n每个方程对应于离散谱中的一个离散波数 $k \\in \\left\\{2\\pi m / L : m \\in \\mathbb{Z}, -\\frac{N}{2} \\le m \\le \\frac{N}{2}-1\\right\\}$。\n\n这些常微分方程中的每一个都是具有常系数 $\\lambda_k$ 的线性标量方程，其精确解由矩阵指数（此处为标量指数）给出。对于任何时间步长 $\\Delta t$，指数时间差分 (ETD) 更新都是精确的：\n$$\n\\widehat{c}_k(t+\\Delta t) = \\exp(\\lambda_k \\, \\Delta t) \\, \\widehat{c}_k(t).\n$$\n因此，从 $t=0$ 到 $t=T$，傅里叶空间中的精确演化为\n$$\n\\widehat{c}_k(T) = \\exp(\\lambda_k \\, T) \\, \\widehat{c}_k(0).\n$$\n通过逆 FFT 变换回物理空间，可得到离散化表示的精确解 $c(x,T)$。因此，在傅里叶空间中，将 $[0,T]$ 划分为任意均匀步长并重复应用 ETD 更新的数值格式，与在 $T$ 上直接一次性应用指数的数值格式，两者结果必须在舍入误差范围内一致。这提供了一个自然的内部一致性检查：我们通过将 $\\exp(\\lambda_k T)$ 直接应用于初始傅里叶系数来计算参考解，并通过组合 $n$ 步 $\\exp(\\lambda_k \\Delta t)$（其中 $n \\Delta t = T$）来计算数值解。相对离散 $\\ell^2$ 误差，\n$$\n\\varepsilon = \\frac{\\left(\\sum_{j=0}^{N-1} \\left|c_{\\text{num}}(x_j,T) - c_{\\text{exact}}(x_j,T)\\right|^2\\right)^{1/2}}{\\left(\\sum_{j=0}^{N-1} \\left|c_{\\text{exact}}(x_j,T)\\right|^2\\right)^{1/2}},\n$$\n量化了由有限精度算术和 FFT 舍入误差引起的累积数值差异。由于两种算法对于线性系统都是精确的，只要初始条件可以在离散傅里叶网格上表示，$\\varepsilon$ 预计会接近机器精度。\n\n算法设计：\n- 构建等距网格 $x_j = j \\, \\Delta x$，$ \\Delta x = L/N$，其中 $j = 0,1,\\dots,N-1$。\n- 使用标准的离散傅里叶变换频率，将其缩放为角波数，来组合离散波数：$k = 2\\pi \\,\\mathrm{fftfreq}(N,\\Delta x)$。\n- 使用给定的 $\\bar{c}$, $a_1$, $a_2$, $n_1$ 和 $n_2$ 构建初始条件 $c(x,0)$。\n- 计算离散傅里叶变换 $\\widehat{c}(0) = \\mathrm{FFT}[c(x,0)]$。\n- 形成 $\\lambda_k = - D k^2 + \\mathrm{i} v k - \\kappa$。\n- 在傅里叶空间中计算参考解为 $\\widehat{c}_{\\text{exact}}(T) = \\exp(\\lambda_k T) \\odot \\widehat{c}(0)$（其中 $\\odot$ 表示逐元素相乘），然后通过逆 FFT 得到 $c_{\\text{exact}}(x,T)$。\n- 通过迭代 $\\widehat{c} \\leftarrow \\exp(\\lambda_k \\Delta t) \\odot \\widehat{c}$ 共 $n = T/\\Delta t$ 步（其中 $n$ 选为整数）来进行数值演化，然后进行逆变换得到 $c_{\\text{num}}(x,T)$。\n- 计算相对离散 $\\ell^2$ 误差 $\\varepsilon$。\n- 对所有四个测试用例重复操作。\n\n测试套件覆盖范围的基本原理：\n- 情况 A 运用了完整的算子，具有非零的扩散、漂移和反应，以及中等分辨率和中等时间步长。\n- 情况 B 设置 $v=0$ 来测试无漂移的边界情况。\n- 情况 C 设置 $\\kappa=0$ 并使用更高空间频率的模式，以在没有衰减的情况下检查较高波数附近的行为。\n- 情况 D 减少了 $N$ 并使用更大的 $\\Delta t$ 和多个模式，以在更粗糙的网格上探究稳定性和准确性。\n\n输出规格：\n- 按要求返回一行，包含四个数字 $[\\varepsilon_A,\\varepsilon_B,\\varepsilon_C,\\varepsilon_D]$，采用具有 12 位有效数字的科学记数法。\n\n因为该算法在线性常系数系统上使用傅里叶谱表示和指数时间差分法，所以数值解和参考解在浮点舍入和 FFT 实现细节方面是一致的，对于所提供的情况，产生的误差通常在 $10^{-14}$–$10^{-12}$ 的量级。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef fourier_wavenumbers(N, L):\n    dx = L / N\n    # Angular wavenumbers k = 2*pi * freq, where freq from fftfreq in cycles per unit length\n    k = 2.0 * np.pi * np.fft.fftfreq(N, d=dx)\n    return k\n\ndef initial_condition(x, L, cbar, a1, a2, n1, n2):\n    # Periodic IC with specified modes\n    return (\n        cbar\n        + a1 * np.cos(2.0 * np.pi * n1 * x / L)\n        + a2 * np.sin(2.0 * np.pi * n2 * x / L)\n    )\n\ndef solve_case(D, v, kappa, L, N, T, dt, cbar, a1, a2, n1, n2):\n    # Grid\n    x = np.linspace(0.0, L, N, endpoint=False)\n    # Wavenumbers\n    k = fourier_wavenumbers(N, L)\n    # Linear operator symbol\n    lam = -D * (k ** 2) + 1j * v * k - kappa\n\n    # Initial condition\n    c0 = initial_condition(x, L, cbar, a1, a2, n1, n2)\n    chat0 = np.fft.fft(c0)\n\n    # Reference exact solution via single exponential over T\n    chat_exact_T = np.exp(lam * T) * chat0\n    c_exact_T = np.fft.ifft(chat_exact_T).real\n\n    # Numerical ETD stepping with dt; ensure integer number of steps\n    steps = int(round(T / dt))\n    if steps == 0:\n        steps = 1\n    dt_adj = T / steps  # adjust dt to hit T exactly\n    E = np.exp(lam * dt_adj)\n    chat_num = chat0.copy()\n    for _ in range(steps):\n        chat_num *= E\n    c_num_T = np.fft.ifft(chat_num).real\n\n    # Relative L2 error\n    diff = c_num_T - c_exact_T\n    num = np.linalg.norm(diff)\n    denom = np.linalg.norm(c_exact_T)\n    # Handle degenerate case of zero exact norm (should not occur with provided ICs)\n    rel_err = num / denom if denom != 0.0 else (0.0 if num == 0.0 else np.inf)\n    return rel_err\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (D, v, kappa, L, N, T, dt, cbar, a1, a2, n1, n2)\n    test_cases = [\n        # Case A\n        (1.0e-9, 1.0e-4, 5.0e-1, 1.0e-3, 256, 1.0e-2, 1.0e-3, 1.0, 1.0e-1, 5.0e-2, 1, 2),\n        # Case B\n        (1.0e-9, 0.0,     5.0e-1, 1.0e-3, 256, 1.0e-2, 1.0e-3, 1.0, 1.0e-1, 5.0e-2, 1, 2),\n        # Case C\n        (1.0e-9, 1.0e-4, 0.0,     1.0e-3, 256, 1.0e-2, 1.25e-3,1.0, 1.0e-1, 0.0,     32, 0),\n        # Case D\n        (1.0e-9, 2.0e-4, 1.0,     1.0e-3, 64,  2.0e-2, 4.0e-3, 1.0, 2.0e-1, 1.5e-1, 7, 11),\n    ]\n\n    results = []\n    for case in test_cases:\n        D, v, kappa, L, N, T, dt, cbar, a1, a2, n1, n2 = case\n        err = solve_case(D, v, kappa, L, N, T, dt, cbar, a1, a2, n1, n2)\n        results.append(err)\n\n    # Final print statement in the exact required format: scientific notation with 12 significant digits.\n    formatted = \",\".join(f\"{r:.12e}\" for r in results)\n    print(f\"[{formatted}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}