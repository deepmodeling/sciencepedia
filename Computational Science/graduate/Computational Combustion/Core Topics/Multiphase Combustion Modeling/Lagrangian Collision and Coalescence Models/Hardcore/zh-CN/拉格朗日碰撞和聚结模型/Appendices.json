{
    "hands_on_practices": [
        {
            "introduction": "在拉格朗日框架中对液滴碰撞进行建模，核心在于如何计算在给定时间步内任意两个粒子包裹发生碰撞的概率。本练习从泊松过程的基本假设出发，引导你推导“无时间计数器”(NTC)方法的碰撞概率表达式，这是许多模拟中使用的简化模型。通过分析其局限性并推导出一个更精确的、在物理上更一致的概率形式，你将深入理解随机碰撞模型背后的数学原理及其在实际应用中的关键考量因素。",
            "id": "4034271",
            "problem": "在用于计算燃烧的拉格朗日喷雾模型中，考虑位于同一体积为 $V_{c}$ 的欧拉计算网格内的两个液滴包裹 $i$ 和 $j$。包裹 $i$ 代表 $N_{i}$ 个直径为 $d_{i}$ 的相同球形液滴，包裹 $j$ 代表 $N_{j}$ 个直径为 $d_{j}$ 的相同球形液滴。在持续时间为 $\\Delta t$ 的一个时间步内，这些包裹具有统计上稳定的相对速度大小 $|u_{ij}|$，并且考虑到流体动力学相互作用，碰撞的收集效率为 $E_{c} \\in (0,1]$。假设单个液滴之间的碰撞可以建模为稀疏、无记忆的 Poisson 过程，并且碰撞后会发生并合。\n\n每对液滴的几何碰撞核由经过充分检验的、用于直线趋近的 Smoluchowski 形式定义，\n$$\nk_{ij} \\equiv E_{c} \\, \\pi \\left(d_{i} + d_{j}\\right)^{2} \\, |u_{ij}|,\n$$\n其单位是体积/时间。令包裹对事件率系数为\n$$\n\\beta_{ij} \\equiv N_{i} N_{j} \\, k_{ij}.\n$$\n从数密度、相对通量以及碰撞事件的 Poisson 假设等基本定义出发，推导在时间步内包裹 $i$ 和 $j$ 之间发生至少一次碰撞的概率的无时间计数器 (No-Time-Counter, NTC) 表达式，\n$$\nP_{ij} = \\frac{\\beta_{ij} \\, \\Delta t}{V_{c}},\n$$\n作为其主阶近似。明确指出导致这种时间线性形式的建模假设。\n\n然后，分析在随机抽样中为保证概率一致性而必须满足的约束条件 $P_{ij} \\leq 1$。讨论在实践中违反此约束的条件（例如，大的 $\\Delta t$、小的 $V_{c}$、大的 $N_{i}$、$N_{j}$ 或大的 $|u_{ij}|$），并概述能够保持质量和数量守恒且避免并合率产生偏差的物理上一致的修正方法。您的讨论应至少涵盖一种使用子步长的方法和一种使用与 Poisson 过程一致的精确事件概率的方法。\n\n最后，为修正后的碰撞概率 $\\widetilde{P}_{ij}$ 提供一个单一的闭式解析表达式，该表达式：\n- 对任意 $\\Delta t$ 均有效，\n- 自动强制 $\\widetilde{P}_{ij} \\leq 1$，\n- 并在 $\\beta_{ij} \\, \\Delta t / V_{c} \\ll 1$ 的极限情况下简化为 NTC 表达式 $P_{ij} = \\beta_{ij} \\, \\Delta t / V_{c}$。\n\n将最终修正后的概率表示为单个解析公式。无需进行数值计算，最终方框内的表达式不应包含任何单位。",
            "solution": "该问题要求对计算燃烧模拟中使用的碰撞模型进行三部分分析：首先，推导近似的无时间计数器 (NTC) 碰撞概率；其次，分析其局限性和潜在的修正方法；第三，推导一个修正后的、物理上一致的碰撞概率。对问题陈述的验证确认了其具有科学依据、问题设定合理，并基于多相流建模的既定原则。因此，我们可以着手求解。\n\n首先，我们推导碰撞概率 $P_{ij}$ 的 NTC 表达式。基本前提是，计算网格体积 $V_c$ 内的液滴碰撞构成一个 Poisson 过程。必须确定此过程的速率 $\\lambda_{ij}$。\n\n考虑一个来自包裹 $i$ 的单个液滴和一个来自包裹 $j$ 的单个液滴。问题定义了每对液滴的碰撞核 $k_{ij}$，其单位为体积/时间。该核代表一个液滴相对于另一个液滴在单位时间内扫过的体积，并已根据收集效率进行修正。假设液滴均匀分布在整个网格体积 $V_c$ 中，这两个特定液滴发生碰撞的单位时间概率是扫过体积速率与总体积之比，即 $\\frac{k_{ij}}{V_c}$。该量的单位为 T$^{-1}$，代表一个频率或速率。\n\n该模型考虑包裹 $i$ 中有 $N_i$ 个液滴，包裹 $j$ 中有 $N_j$ 个液滴。两个包裹之间不同相互作用对的总数为 $N_i N_j$。由于该过程被假设为稀疏的，不同对之间的碰撞被视为独立事件。因此，来自包裹 $i$ 的任何液滴与来自包裹 $j$ 的任何液滴之间的总碰撞事件速率是每对的速率乘以总对数：\n$$\n\\lambda_{ij} = N_i N_j \\left( \\frac{k_{ij}}{V_c} \\right)\n$$\n使用问题中对包裹对事件率系数的定义 $\\beta_{ij} \\equiv N_i N_j k_{ij}$，总碰撞速率可以写为：\n$$\n\\lambda_{ij} = \\frac{\\beta_{ij}}{V_c}\n$$\n对于一个平均速率恒为 $\\lambda_{ij}$ 的 Poisson 过程，在时间间隔 $\\Delta t$ 内观测到恰好 $k$ 次事件的概率由下式给出：\n$$\nP(k; \\lambda_{ij}, \\Delta t) = \\frac{(\\lambda_{ij} \\Delta t)^k \\exp(-\\lambda_{ij} \\Delta t)}{k!}\n$$\n至少发生一次碰撞的概率是 $P(k \\ge 1) = 1 - P(k=0)$。发生零次碰撞的概率是：\n$$\nP(k=0) = \\frac{(\\lambda_{ij} \\Delta t)^0 \\exp(-\\lambda_{ij} \\Delta t)}{0!} = \\exp(-\\lambda_{ij} \\Delta t)\n$$\n因此，在 $\\Delta t$ 期间至少发生一次碰撞的精确概率是：\n$$\nP_{ij, \\text{exact}} = 1 - \\exp(-\\lambda_{ij} \\Delta t) = 1 - \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_c}\\right)\n$$\nNTC 表达式是此精确概率的主阶近似，在预期事件数很小的极限情况下有效。令 $x = \\frac{\\beta_{ij} \\Delta t}{V_c}$。对于 $x \\ll 1$，我们可以使用指数函数的泰勒级数展开 $e^{-x} \\approx 1 - x$。将此代入精确概率表达式可得近似值：\n$$\nP_{ij} \\approx 1 - \\left(1 - \\frac{\\beta_{ij} \\Delta t}{V_c}\\right) = \\frac{\\beta_{ij} \\Delta t}{V_c}\n$$\n这就是所求的 NTC 表达式。导致这种时间线性形式的关键建模假设是：\n1.  碰撞被建模为无记忆的 Poisson 过程，这意味着事件是独立和随机的，这适用于稀疏喷雾。\n2.  两个包裹的液滴均匀分布在整个网格体积 $V_c$ 中，这为使用宏观数密度提供了依据。\n3.  碰撞速率 $\\lambda_{ij}$ 在时间步 $\\Delta t$ 内是恒定的。问题陈述中“统计上稳定的相对速度大小 $|u_{ij}|$”的条件支持了这一点，并意味着 $N_i$ 和 $N_j$ 在该时间步内不会因碰撞而发生显著变化。\n4.  在时间步内预期的碰撞事件数远小于一，即 $\\lambda_{ij} \\Delta t = \\frac{\\beta_{ij} \\Delta t}{V_c} \\ll 1$。这是验证指数函数线性化的关键数学假设。\n\n接下来，我们分析概率一致性约束 $P_{ij} \\le 1$。NTC 表达式 $P_{ij} = \\frac{\\beta_{ij} \\Delta t}{V_c}$ 是其参数的线性函数且无界。它可以超过 $1$，这违反了概率的定义。当假设 $\\lambda_{ij} \\Delta t \\ll 1$ 不再成立时，在实践中就会发生这种违规。这发生在以下条件下：\n-   大的时间步长 $\\Delta t$。\n-   小的计算网格体积 $V_c$。\n-   包裹中大量的液滴数 $N_i$ 和 $N_j$。\n-   大的碰撞核 $k_{ij}$，这可能由大的液滴直径 ($d_i, d_j$) 或高的相对速度 ($|u_{ij}|$) 引起。\n这些条件在喷雾密集区域、喷嘴附近或计算网格高度加密的区域很常见。\n\n必须采用物理上一致的修正方法来处理 $P_{ij} > 1$ 的情况。这些修正方法应确保碰撞统计数据得到正确处理，而不会引入偏差，并保证质量和数量守恒。\n1.  **子步长法 (Substepping)：** 强制执行条件 $\\lambda_{ij} \\Delta t \\ll 1$ 最直接的方法是减小 $\\Delta t$。如果整体的流体动力学时间步 $\\Delta t$ 太大，可以将其分成 $M$ 个持续时间为 $\\Delta t_s = \\Delta t / M$ 的更小的碰撞子步长。选择子步长的数量 $M$ 以确保在一个子步长内的碰撞概率 $P_{ij,s} = \\frac{\\beta_{ij} \\Delta t_s}{V_c}$ 远小于 $1$。在每个子步长之后，如果发生碰撞并合事件，则更新包裹的布居数 ($N_i, N_j$)。这种方法在整个时间步 $\\Delta t$ 内正确地模拟了反应物（碰撞液滴）布居数的减少。然而，它会显著增加计算成本。\n2.  **使用精确事件概率：** 一种计算效率更高的修正方法是放弃线性的 NTC 近似，转而使用更精确的概率表达式。$P_{ij} > 1$ 的问题在于它意味着在时间步内平均发生超过一次碰撞事件。与其简单地将概率上限设为 $1$（这会使碰撞率向下偏离），不如使用一种内在有界的公式。至少发生一次事件的精确 Poisson 概率 $P_{ij, \\text{exact}} = 1 - \\exp(-\\lambda_{ij} \\Delta t)$ 是一个自然的选择。该表达式的值始终在 $[0, 1)$ 范围内，并正确地表示了一次或多次碰撞的概率。如果使用此概率抽样到一次碰撞，通常假定发生了一次单一的并合事件。这仍然是一个近似，因为它没有考虑在 $\\Delta t$ 内发生多次不同碰撞事件的可能性，但相比 NTC 方法，这是一个显著的改进，并且避免了非物理的 $P_{ij} > 1$ 问题，同时没有子步长法的成本。\n\n最后，我们被要求为一个修正后的碰撞概率 $\\widetilde{P}_{ij}$ 提供一个单一的闭式解析表达式，该表达式需满足三个条件：对任意 $\\Delta t$ 有效，自动强制 $\\widetilde{P}_{ij} \\le 1$，并在适当的极限下简化为 NTC 形式。\n\n如上文推导和讨论的，Poisson 过程中至少发生一次事件的精确概率满足所有这些标准。我们将修正后的概率 $\\widetilde{P}_{ij}$ 定义为这个精确概率：\n$$\n\\widetilde{P}_{ij} = 1 - \\exp(-\\lambda_{ij} \\Delta t) = 1 - \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_c}\\right)\n$$\n我们来验证这些条件：\n1.  **对任意 $\\Delta t$ 的有效性**：指数函数对所有实数参数都有定义。由于 $\\Delta t \\ge 0$，指数的参数始终为非正数，因此函数是良态的。\n2.  **强制 $\\widetilde{P}_{ij} \\le 1$**：由于所有物理量（$\\beta_{ij}$, $\\Delta t$, $V_c$）都是非负的，指数的参数 $-\\frac{\\beta_{ij} \\Delta t}{V_c}$ 始终小于或等于 $0$。因此，$0 < \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_c}\\right) \\le 1$。由此得出 $0 \\le 1 - \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_c}\\right) < 1$。因此，条件 $\\widetilde{P}_{ij} \\le 1$ 总是满足的。\n3.  **简化为 NTC 表达式**：在 $\\frac{\\beta_{ij} \\Delta t}{V_c} \\ll 1$ 的极限情况下，我们对小的 $x$ 使用泰勒展开 $\\exp(-x) \\approx 1-x$。\n    $$\n    \\widetilde{P}_{ij} = 1 - \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_c}\\right) \\approx 1 - \\left(1 - \\frac{\\beta_{ij} \\Delta t}{V_c}\\right) = \\frac{\\beta_{ij} \\Delta t}{V_c}\n    $$\n    这正是 NTC 表达式。\n\n因此，修正后的碰撞概率就是至少发生一次事件的精确 Poisson 概率。",
            "answer": "$$\n\\boxed{1 - \\exp\\left(-\\frac{\\beta_{ij} \\Delta t}{V_{c}}\\right)}\n$$"
        },
        {
            "introduction": "将理论模型转化为可靠的计算机代码是计算科学的核心挑战之一，尤其是在处理周期性边界条件(PBC)这类复杂几何约束时。本练习要求你通过编程实践，解决在环形域中正确计算粒子对碰撞预期值的问题。你将通过对比“朴素”算法和使用“最小镜像约定”(MIC)的修正算法，亲身体会到正确的边界处理和无偏采样对于获得物理上准确的模拟结果是何等重要。",
            "id": "4034236",
            "problem": "考虑一个三维环形域，其在每个笛卡尔方向上的边长为 $L$，并具有周期性边界条件 (PBC)。域中填充有有限数量的被视为刚性球体的拉格朗日液滴。每个液滴 $i$ 的位置向量为 $\\mathbf{x}_i$（单位：米），速度向量为 $\\mathbf{v}_i$（单位：米/秒），半径为 $r_i$（单位：米）。设域体积为 $V = L^3$（单位：立方米），并考虑一个固定的时间步长 $\\Delta t$（单位：秒）。假设在时间步长内速度恒定（无外力，无阻力变化），因此每个液滴的轨迹为 $\\mathbf{x}_i(t) = \\mathbf{x}_i(0) + \\mathbf{v}_i t$，其中 $t \\in [0,\\Delta t]$。\n\n我们关注的是用于碰撞-合并采样的算法性对计数。该物理模型使用适用于刚性球形液滴的弹道碰撞核：如果两个液滴 $i$ 和 $j$ 以相对速率 $|\\mathbf{u}_{ij}| = \\|\\mathbf{v}_j - \\mathbf{v}_i\\|$ 相互移动，则每对的碰撞率与几何横截面积 $\\pi (r_i + r_j)^2$ 乘以相对速率成正比。在均匀体积近似中，无序对 $(i,j)$ 在时间步长 $\\Delta t$ 内贡献的期望碰撞次数为\n$$\np_{ij} = \\min\\left(1, \\frac{\\pi (r_i + r_j)^2 \\, |\\mathbf{u}_{ij}| \\, \\Delta t}{V}\\right),\n$$\n这是无量纲的。为避免计数物理上不可能的碰撞，需执行以下源自匀速运动的运动学可行性检查：定义 $t=0$ 时的相对位置为 $\\mathbf{r}_{ij}(0) = \\mathbf{x}_j(0) - \\mathbf{x}_i(0)$，相对速度为 $\\mathbf{u}_{ij} = \\mathbf{v}_j - \\mathbf{v}_i$。在 $t \\in [0,\\Delta t]$ 期间，间距演变为 $\\mathbf{r}_{ij}(t) = \\mathbf{r}_{ij}(0) + \\mathbf{u}_{ij} t$。令 $t^\\star = \\operatorname{clamp}\\left(-\\frac{\\mathbf{r}_{ij}(0)\\cdot \\mathbf{u}_{ij}}{\\|\\mathbf{u}_{ij}\\|^2}, 0, \\Delta t\\right)$ 为该时间间隔内的最小间距时间，且 $d_{\\min} = \\|\\mathbf{r}_{ij}(t^\\star)\\|$。当且仅当 $d_{\\min} \\le r_i + r_j$ 时，一次碰撞在该时间步长内是运动学上可行的。\n\n在环形域中，位移 $\\mathbf{r}_{ij}(0)$ 必须使用最小镜像约定来计算，以使每个分量都位于区间 $[-L/2, L/2)$ 内。对于每个笛卡尔分量 $k \\in \\{x,y,z\\}$，\n$$\nr_{ij,k}^{\\text{MI}} = \\left(x_{j,k} - x_{i,k}\\right) - L \\cdot \\operatorname{round}\\left(\\frac{x_{j,k} - x_{i,k}}{L}\\right).\n$$\n使用最小镜像位移可确保对几何间距跨越周期性边界条件的液滴对进行无偏处理。无偏碰撞采样还要求对无序对仅计数一次；在远离边界的区域，重复计数有序对 $(i,j)$ 和 $(j,i)$ 会使估计量产生两倍的偏差。\n\n您的任务是编写一个完整的程序，针对每个给定的测试用例，计算两个量：\n- 每个时间步长的朴素期望碰撞计数：通过对所有有序对 $i \\ne j$ 求和 $p_{ij}$ 计算得出，其中在运动学可行性检查中使用未经包裹的位移 $\\mathbf{x}_j - \\mathbf{x}_i$（无最小镜像校正）。\n- 每个时间步长的校正后期望碰撞计数：通过对所有无序对 $i < j$ 求和 $p_{ij}$ 计算得出，其中在运动学可行性检查中使用最小镜像位移。\n\n对于这两种计数，当且仅当满足运动学可行性准则 $d_{\\min} \\le r_i + r_j$ 时，才包含一对液滴的贡献 $p_{ij}$。由于周期性边界条件，所有位置必须解释为模 $L$（即，每个分量的输入可以位于 $[0,L)$ 内的任何位置）。使用国际单位制 (SI)：位置单位为米，速度单位为米/秒，半径单位为米，$L$ 单位为米，$\\Delta t$ 单位为秒。期望碰撞计数是无量纲的，必须以十进制浮点数输出。\n\n测试套件：\n1. 案例 A（跨边界接近，边长 $L=0.01$ 米的 $3$-环面）：两个液滴，\n   - 液滴 $1$：$\\mathbf{x}_1 = [0.0005, 0.0, 0.0]$ m，$\\mathbf{v}_1 = [-0.5, 0.0, 0.0]$ m/s，$r_1 = 2\\times 10^{-4}$ m。\n   - 液滴 $2$：$\\mathbf{x}_2 = [0.0095, 0.0, 0.0]$ m，$\\mathbf{v}_2 = [0.5, 0.0, 0.0]$ m/s，$r_2 = 2\\times 10^{-4}$ m。\n   - $\\Delta t = 0.002$ s。\n2. 案例 B（内部接近，重复计数检查，边长 $L=0.01$ 米的 $3$-环面）：两个液滴，\n   - 液滴 $1$：$\\mathbf{x}_1 = [0.004, 0.0, 0.0]$ m，$\\mathbf{v}_1 = [0.5, 0.0, 0.0]$ m/s，$r_1 = 2\\times 10^{-4}$ m。\n   - 液滴 $2$：$\\mathbf{x}_2 = [0.006, 0.0, 0.0]$ m，$\\mathbf{v}_2 = [-0.5, 0.0, 0.0]$ m/s，$r_2 = 2\\times 10^{-4}$ m。\n   - $\\Delta t = 0.003$ s。\n3. 案例 C（混合三液滴配置，其中包含一次跨边界接近，边长 $L=0.02$ 米的 $3$-环面）：三个液滴，\n   - 液滴 $1$：$\\mathbf{x}_1 = [0.0198, 0.001, 0.0]$ m，$\\mathbf{v}_1 = [0.2, 0.0, 0.0]$ m/s，$r_1 = 2\\times 10^{-4}$ m。\n   - 液滴 $2$：$\\mathbf{x}_2 = [0.0005, 0.001, 0.0]$ m，$\\mathbf{v}_2 = [-0.2, 0.0, 0.0]$ m/s，$r_2 = 2\\times 10^{-4}$ m。\n   - 液滴 $3$：$\\mathbf{x}_3 = [0.010, 0.010, 0.0]$ m，$\\mathbf{v}_3 = [0.0, 0.0, 0.0]$ m/s，$r_3 = 1\\times 10^{-4}$ m。\n   - $\\Delta t = 0.005$ s。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的列表，内含六个十进制浮点数，顺序如下\n$$\n[\\text{naive\\_A}, \\text{corrected\\_A}, \\text{naive\\_B}, \\text{corrected\\_B}, \\text{naive\\_C}, \\text{corrected\\_C}],\n$$\n其中每个条目是指定案例和方法的期望碰撞计数。输出格式必须严格为 Python 列表字符串的形式，例如 $[\\text{float1},\\text{float2},\\ldots]$。",
            "solution": "问题陈述已经过验证，被认为是科学基础扎实、提法恰当且客观的。它基于拉格朗日粒子追踪和周期性域中碰撞模型的既定原则，提出了一个清晰的计算任务。所有必要的参数、定义和方程均已提供，从而可以得到唯一且可验证的解。\n\n该问题要求计算在一个时间步长 $\\Delta t$ 内，一组位于三维环形域中的球形液滴的期望碰撞次数。解决方案涉及实现两种不同的算法方法：一种是“朴素”方法，另一种是“校正”方法，二者的区别在于它们处理周期性边界条件和对计数的方式。\n\n计算的核心依赖于三个概念：碰撞概率、碰撞的运动学可行性以及周期性的处理。\n\n1.  **碰撞概率 ($p_{ij}$)**：液滴对 $(i,j)$ 的碰撞概率由下式给出\n    $$p_{ij} = \\min\\left(1, \\frac{\\pi (r_i + r_j)^2 \\, |\\mathbf{u}_{ij}| \\, \\Delta t}{V}\\right)$$\n    该表达式表示液滴 $j$ 相对于液滴 $i$（反之亦然）扫过的体积，并由总域体积 $V = L^3$ 进行归一化。项 $\\pi (r_i + r_j)^2$ 是两个半径分别为 $r_i$ 和 $r_j$ 的球体的碰撞截面。项 $|\\mathbf{u}_{ij}| \\Delta t$ 是在时间步长 $\\Delta t$ 内液滴相互移动的相对距离，其中 $\\mathbf{u}_{ij} = \\mathbf{v}_j - \\mathbf{v}_i$ 是相对速度。它们的乘积构成了一个“碰撞体积”。$\\min(1, \\cdot)$ 函数确保结果保持为有效的概率值。\n\n2.  **运动学可行性**：只有当液滴的轨迹实际相交时，碰撞概率 $p_{ij}$ 才具有物理意义。假设速度恒定，相对位置向量随时间演变为 $\\mathbf{r}_{ij}(t) = \\mathbf{r}_{ij}(0) + \\mathbf{u}_{ij} t$。间距的平方是时间的二次函数：$d(t)^2 = \\|\\mathbf{r}_{ij}(t)\\|^2 = \\|\\mathbf{r}_{ij}(0) + \\mathbf{u}_{ij} t\\|^2$。此函数在区间 $t \\in [0, \\Delta t]$ 内的最小值出现在时间 $t^\\star$，该值通过令导数 $\\frac{d}{dt}d(t)^2 = 0$ 求得。这给出了一个无约束的最小值点 $t = -\\frac{\\mathbf{r}_{ij}(0)\\cdot \\mathbf{u}_{ij}}{\\|\\mathbf{u}_{ij}\\|^2}$。问题将 $t^\\star$ 定义为此值被限制在区间 $[0, \\Delta t]$ 内的结果：\n    $$t^\\star = \\operatorname{clamp}\\left(-\\frac{\\mathbf{r}_{ij}(0)\\cdot \\mathbf{u}_{ij}}{\\|\\mathbf{u}_{ij}\\|^2}, 0, \\Delta t\\right)$$\n    如果 $\\|\\mathbf{u}_{ij}\\| = 0$，液滴之间没有相对运动，因此 $d_{\\min} = \\|\\mathbf{r}_{ij}(0)\\|$，且 $p_{ij}$ 的表达式为零。最小间距即为 $d_{\\min} = \\|\\mathbf{r}_{ij}(t^\\star)\\|$。当且仅当这个最小距离小于或等于半径之和，$d_{\\min} \\le r_i + r_j$，碰撞才可能发生。必须满足此准则，才能将 $p_{ij}$ 计入总数。\n\n3.  **周期性边界条件 (PBC) 与求和方法**：\n    环形域意味着从一个面出去的液滴会从对面重新进入。两个液滴之间的“真实”距离是考虑所有可能的周期性镜像后的最短距离。这通过使用最小镜像约定 (MIC) 计算：对于每个笛卡尔分量 $k$，相对位移 $r_{ij,k}$ 被包裹到区间 $[-L/2, L/2)$ 内。\n    $$r_{ij,k}^{\\text{MI}} = \\left(x_{j,k} - x_{i,k}\\right) - L \\cdot \\operatorname{round}\\left(\\frac{x_{j,k} - x_{i,k}}{L}\\right)$$\n    “朴素”方法错误地使用未经包裹的位移 $\\mathbf{r}_{ij}(0) = \\mathbf{x}_j - \\mathbf{x}_i$ 进行运动学检查，并对所有有序对 ($i \\ne j$) 求和，这导致了因忽略周期性和重复计数而产生的错误。\n    “校正”方法正确地使用最小镜像位移 $\\mathbf{r}_{ij}^{\\text{MI}}(0)$ 进行运动学检查，并对唯一的无序对（通常为 $i<j$）求和，以避免重复计数。\n\n基于以上分析，我们将编写一个 Python 程序来实现这两种算法，并处理给定的测试用例。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to orchestrate the computation for all test cases.\n    \"\"\"\n    \n    # Define test cases as per the problem statement\n    test_cases = [\n        # Case A\n        {\n            \"L\": 0.01, \"dt\": 0.002, \"droplets\": [\n                {\"x\": np.array([0.0005, 0.0, 0.0]), \"v\": np.array([-0.5, 0.0, 0.0]), \"r\": 2e-4},\n                {\"x\": np.array([0.0095, 0.0, 0.0]), \"v\": np.array([0.5, 0.0, 0.0]), \"r\": 2e-4}\n            ]\n        },\n        # Case B\n        {\n            \"L\": 0.01, \"dt\": 0.003, \"droplets\": [\n                {\"x\": np.array([0.004, 0.0, 0.0]), \"v\": np.array([0.5, 0.0, 0.0]), \"r\": 2e-4},\n                {\"x\": np.array([0.006, 0.0, 0.0]), \"v\": np.array([-0.5, 0.0, 0.0]), \"r\": 2e-4}\n            ]\n        },\n        # Case C\n        {\n            \"L\": 0.02, \"dt\": 0.005, \"droplets\": [\n                {\"x\": np.array([0.0198, 0.001, 0.0]), \"v\": np.array([0.2, 0.0, 0.0]), \"r\": 2e-4},\n                {\"x\": np.array([0.0005, 0.001, 0.0]), \"v\": np.array([-0.2, 0.0, 0.0]), \"r\": 2e-4},\n                {\"x\": np.array([0.010, 0.010, 0.0]), \"v\": np.array([0.0, 0.0, 0.0]), \"r\": 1e-4}\n            ]\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        naive_count, corrected_count = compute_collision_counts(\n            case[\"L\"], case[\"dt\"], case[\"droplets\"]\n        )\n        all_results.extend([naive_count, corrected_count])\n        \n    # Format the final output as a Python list string\n    print(f\"[{','.join(f'{r:.17f}' for r in all_results)}]\")\n\ndef minimum_image_displacement(dr, L):\n    \"\"\"\n    Computes the displacement vector according to the minimum-image convention.\n    dr: The unwrapped displacement vector (x_j - x_i).\n    L: The side length of the cubic domain.\n    \"\"\"\n    return dr - L * np.round(dr / L)\n\ndef is_kinematically_feasible(r0, u, dt, r_sum):\n    \"\"\"\n    Checks if a collision is kinematically feasible within the time step.\n    r0: Initial relative position vector.\n    u: Relative velocity vector.\n    dt: Time step.\n    r_sum: Sum of the radii of the two droplets (r_i + r_j).\n    \"\"\"\n    u_norm_sq = np.dot(u, u)\n    \n    # Handle case of zero relative velocity\n    if u_norm_sq == 0.0:\n        d_min = np.linalg.norm(r0)\n    else:\n        # Time of closest approach (unconstrained)\n        t_unclamped = -np.dot(r0, u) / u_norm_sq\n        \n        # Clamp t to the interval [0, dt]\n        t_star = np.clip(t_unclamped, 0.0, dt)\n        \n        # Minimum separation distance within the interval\n        r_at_t_star = r0 + u * t_star\n        d_min = np.linalg.norm(r_at_t_star)\n\n    return d_min = r_sum\n\ndef compute_collision_counts(L, dt, droplets):\n    \"\"\"\n    Computes naive and corrected expected collision counts for a given case.\n    \"\"\"\n    V = L**3\n    num_droplets = len(droplets)\n    \n    naive_total_p = 0.0\n    corrected_total_p = 0.0\n    \n    # --- Naive Calculation (ordered pairs i != j, no MIC) ---\n    for i in range(num_droplets):\n        for j in range(num_droplets):\n            if i == j:\n                continue\n            \n            p_i = droplets[i]\n            p_j = droplets[j]\n            \n            # Unwrapped relative position and velocity\n            r_ij_0_unwrapped = p_j[\"x\"] - p_i[\"x\"]\n            u_ij = p_j[\"v\"] - p_i[\"v\"]\n            r_sum = p_i[\"r\"] + p_j[\"r\"]\n            \n            if is_kinematically_feasible(r_ij_0_unwrapped, u_ij, dt, r_sum):\n                u_norm = np.linalg.norm(u_ij)\n                p = (np.pi * r_sum**2 * u_norm * dt) / V\n                naive_total_p += min(1.0, p)\n                \n    # --- Corrected Calculation (unordered pairs i  j, with MIC) ---\n    for i in range(num_droplets):\n        for j in range(i + 1, num_droplets):\n            p_i = droplets[i]\n            p_j = droplets[j]\n            \n            # Unwrapped relative position (for MIC)\n            r_ij_0_unwrapped = p_j[\"x\"] - p_i[\"x\"]\n            # Corrected relative position using MIC\n            r_ij_0_mic = minimum_image_displacement(r_ij_0_unwrapped, L)\n            \n            u_ij = p_j[\"v\"] - p_i[\"v\"]\n            r_sum = p_i[\"r\"] + p_j[\"r\"]\n\n            if is_kinematically_feasible(r_ij_0_mic, u_ij, dt, r_sum):\n                u_norm = np.linalg.norm(u_ij)\n                p = (np.pi * r_sum**2 * u_norm * dt) / V\n                corrected_total_p += min(1.0, p)\n\n    return naive_total_p, corrected_total_p\n\nif __name__ == \"__main__\":\n    solve()\n```"
        },
        {
            "introduction": "随机模拟（如直接模拟蒙特卡洛方法）的输出本身是随机的，因此，对结果进行严谨的统计分析与模型构建和实现同等重要。本练习将指导你如何应用中心极限定理(CLT)来量化从模拟中获得的碰撞率估计值的不确定性。你将学习如何计算置信区间，并根据期望的精度目标来确定所需的模拟时长，这些都是验证和解释随机模拟结果时不可或缺的技能。",
            "id": "4034281",
            "problem": "一个拉格朗日直接模拟蒙特卡洛 (DSMC) 算法被用于模拟燃烧室内统计平稳反应喷雾中液态燃料油滴包裹之间的碰撞-聚并过程。设 $C_k$ 表示在时间步长 $k$ 内，在被追踪的包裹中记录到的碰撞-聚并事件的数量，其中每个步长的持续时间固定为 $\\Delta t$。假设 $\\{C_k\\}_{k=1}^{M}$ 是独立同分布的，具有有限均值 $\\mu_C$ 和有限方差 $\\sigma_C^2$，并且中心极限定理 (CLT) 适用于样本均值。单位时间的碰撞率定义为 $r = \\mu_C / \\Delta t$，其自然估计量为 $\\hat{r} = \\bar{C} / \\Delta t$，其中 $\\bar{C} = \\frac{1}{M}\\sum_{k=1}^{M} C_k$。\n\n一次包含 $M_0 = 8000$ 个步长且 $\\Delta t = 2.0 \\times 10^{-5}\\ \\text{s}$ 的初步模拟，得到了每个步长计数的样本均值 $\\bar{C} = 3.7$ 和样本方差 $s_C^2 = 5.5$。\n\n仅使用给定的假设和中心极限定理：\n1) 从第一性原理推导速率 $r$ 的一个近似 $(1-\\alpha)$ 置信区间，用 $\\bar{C}$、$s_C^2$、$M$、$\\Delta t$ 和标准正态分位数 $z_{1-\\alpha/2}$ 表示。然后，对于初步运行，在置信水平 $1-\\alpha = 0.95$ 下，使用 $z_{0.975}$ 数值计算此区间，并报告 $r$ 的下界和上界。速率以 $\\text{s}^{-1}$ 为单位表示，并将您的答案四舍五入到四位有效数字。\n\n2) 将置信区间的相对半宽定义为半宽与真实速率 $r$ 的比值。利用中心极限定理的标度关系和变异系数的概念，推导所需的总步数 $M$，使得在置信水平 $1-\\alpha = 0.95$ 下，相对半宽至多为一个目标值 $\\delta$。然后，使用初步模拟的统计数据作为置入估计，并取 $\\delta = 0.03$，计算所需的 $M$。向上取整到下一个整数以保证达到目标，并报告最终的 $M$ 值，保留四位有效数字。\n\n提供两个置信区间界限和所需 $M$ 的最终数值结果。速率使用 $\\text{s}^{-1}$ 为单位，并将所有要求的数值量四舍五入到四位有效数字。",
            "solution": "在尝试求解之前，对问题进行验证。\n\n**第1步：提取已知条件**\n- **过程：** 用于液态燃料油滴包裹碰撞-聚并的拉格朗日直接模拟蒙特卡洛 (DSMC) 过程。\n- **系统：** 统计平稳反应喷雾。\n- **随机变量：** $C_k$，时间步长 $k$ 内的碰撞-聚并事件数。\n- **时间步长：** $\\Delta t$。\n- **观测值：** $\\{C_k\\}_{k=1}^{M}$ 是独立同分布的 (i.i.d.)。\n- **总体参数：** 均值 $E[C_k] = \\mu_C$ (有限)，方差 $Var(C_k) = \\sigma_C^2$ (有限)。\n- **核心假设：** 中心极限定理 (CLT) 适用于样本均值 $\\bar{C} = \\frac{1}{M}\\sum_{k=1}^{M} C_k$。\n- **定义：** 单位时间碰撞率 $r = \\mu_C / \\Delta t$；速率的估计量 $\\hat{r} = \\bar{C} / \\Delta t$。\n- **初步模拟数据 ($M_0$)：** 步数 $M_0 = 8000$，时间步长 $\\Delta t = 2.0 \\times 10^{-5}\\ \\text{s}$，样本均值 $\\bar{C} = 3.7$，样本方差 $s_C^2 = 5.5$。\n- **第1部分任务：** 推导 $r$ 的近似 $(1-\\alpha)$ 置信区间。使用初步模拟数据和 $z_{0.975}$ 对 $1-\\alpha = 0.95$ 的情况进行评估。报告 $r$ 的下界和上界，单位为 $\\text{s}^{-1}$，并四舍五入到四位有效数字。\n- **第2部分任务：** 推导所需的步数 $M$，使得 $0.95$ 置信区间的相对半宽最多为 $\\delta = 0.03$。使用初步模拟的统计数据作为置入估计。将 $M$ 向上取整到下一个整数，并报告至四位有效数字。\n\n**第2步：使用提取的已知条件进行验证**\n问题具有科学依据，因为它将标准的统计方法（CLT、置信区间）应用于一个成熟的模拟技术（DSMC）和一个现实的工程背景（喷雾燃烧）。问题是适定的，为获得唯一解提供了所有必要的数据和假设。语言客观而精确。问题是自洽、一致的，且不违反任何基本原理。数值是物理上合理的。假设 $z_{1-\\alpha/2}$ 是一个已知的标准分位数并不会使问题不完整。\n\n**第3步：结论与行动**\n问题有效。现在开始求解过程。\n\n**第1部分：速率 $r$ 的置信区间**\n\n中心极限定理 (CLT) 假设适用于样本均值 $\\bar{C} = \\frac{1}{M}\\sum_{k=1}^{M} C_k$。对于大量的步数 $M$，$\\bar{C}$ 的分布近似为均值为 $\\mu_C$、方差为 $\\sigma_C^2/M$ 的正态分布。我们可以写成：\n$$ \\bar{C} \\approx N\\left(\\mu_C, \\frac{\\sigma_C^2}{M}\\right) $$\n将随机变量 $\\bar{C}$ 标准化，我们得到一个标准正态变量 $Z$：\n$$ Z = \\frac{\\bar{C} - \\mu_C}{\\sigma_C / \\sqrt{M}} \\approx N(0, 1) $$\n由于真实的总体方差 $\\sigma_C^2$ 是未知的，我们使用它的无偏估计量，即样本方差 $s_C^2$。对于大样本容量（初步运行中的 $M=8000$ 足够大），我们可以用 $s_C$ 来近似 $\\sigma_C$。因此，置信区间的枢轴量为：\n$$ Z \\approx \\frac{\\bar{C} - \\mu_C}{s_C / \\sqrt{M}} $$\n对于 $(1-\\alpha)$ 的置信水平，以下关于标准正态变量 $Z$ 的概率陈述成立：\n$$ P(-z_{1-\\alpha/2} \\le Z \\le z_{1-\\alpha/2}) = 1-\\alpha $$\n其中 $z_{1-\\alpha/2}$ 是标准正态分布的分位数，使得 $P(Z \\le z_{1-\\alpha/2}) = 1-\\alpha/2$。代入 $Z$ 的表达式，我们得到：\n$$ P\\left(-z_{1-\\alpha/2} \\le \\frac{\\bar{C} - \\mu_C}{s_C / \\sqrt{M}} \\le z_{1-\\alpha/2}\\right) \\approx 1-\\alpha $$\n为了求出真实均值 $\\mu_C$ 的置信区间，我们整理不等式：\n$$ \\bar{C} - z_{1-\\alpha/2} \\frac{s_C}{\\sqrt{M}} \\le \\mu_C \\le \\bar{C} + z_{1-\\alpha/2} \\frac{s_C}{\\sqrt{M}} $$\n碰撞率定义为 $r = \\mu_C / \\Delta t$。由于 $\\Delta t$ 是一个正常数，我们可以将整个不等式除以 $\\Delta t$ 而不改变不等号的方向，从而得到 $r$ 的置信区间：\n$$ \\frac{\\bar{C}}{\\Delta t} - z_{1-\\alpha/2} \\frac{s_C}{\\Delta t \\sqrt{M}} \\le \\frac{\\mu_C}{\\Delta t} \\le \\frac{\\bar{C}}{\\Delta t} + z_{1-\\alpha/2} \\frac{s_C}{\\Delta t \\sqrt{M}} $$\n识别出估计量 $\\hat{r} = \\bar{C} / \\Delta t$，真实速率 $r$ 的近似 $(1-\\alpha)$ 置信区间为：\n$$ \\hat{r} \\pm z_{1-\\alpha/2} \\frac{s_C}{\\Delta t \\sqrt{M}} $$\n我们现在为初步运行计算这个区间。置信水平是 $1-\\alpha = 0.95$，所以 $\\alpha = 0.05$ 且 $\\alpha/2 = 0.025$。所需的分位数是 $z_{1-0.025} = z_{0.975}$。我们使用的标准值是 $z_{0.975} \\approx 1.960$。\n给定的初步模拟数据是：$M = 8000$，$\\Delta t = 2.0 \\times 10^{-5}\\ \\text{s}$，$\\bar{C} = 3.7$，以及 $s_C^2 = 5.5$。因此，$s_C = \\sqrt{5.5}$。\n首先，我们计算速率的点估计值 $\\hat{r}$：\n$$ \\hat{r} = \\frac{\\bar{C}}{\\Delta t} = \\frac{3.7}{2.0 \\times 10^{-5}\\ \\text{s}} = 185000\\ \\text{s}^{-1} = 1.85 \\times 10^5\\ \\text{s}^{-1} $$\n接下来，我们计算置信区间的半宽，也称为误差范围 $E$：\n$$ E = z_{0.975} \\frac{s_C}{\\Delta t \\sqrt{M}} = 1.960 \\times \\frac{\\sqrt{5.5}}{(2.0 \\times 10^{-5}) \\sqrt{8000}} \\approx 2569.56\\ \\text{s}^{-1} $$\n$r$ 的置信区间的下界和上界是 $r_{lower} = \\hat{r} - E$ 和 $r_{upper} = \\hat{r} + E$。\n$$ r_{lower} = 185000 - 2569.56 = 182430.44\\ \\text{s}^{-1} $$\n$$ r_{upper} = 185000 + 2569.56 = 187569.56\\ \\text{s}^{-1} $$\n将这些结果四舍五入到四位有效数字：\n$$ r_{lower} \\approx 1.824 \\times 10^5\\ \\text{s}^{-1} $$\n$$ r_{upper} \\approx 1.876 \\times 10^5\\ \\text{s}^{-1} $$\n\n**第2部分：所需的步数 $M$**\n\n置信区间的相对半宽定义为半宽 $E$ 与真实速率 $r$ 的比值。速率 $r$ 的半宽是 $E = z_{1-\\alpha/2} \\frac{\\sigma_C}{\\Delta t \\sqrt{M}}$，真实速率是 $r = \\mu_C / \\Delta t$。\n因此，相对半宽为：\n$$ \\frac{E}{r} = \\frac{z_{1-\\alpha/2} \\frac{\\sigma_C}{\\Delta t \\sqrt{M}}}{\\frac{\\mu_C}{\\Delta t}} = z_{1-\\alpha/2} \\frac{\\sigma_C}{\\mu_C \\sqrt{M}} $$\n项 $\\sigma_C / \\mu_C$ 是计数的变异系数，记为 $CV_C$。表达式简化为：\n$$ \\frac{E}{r} = z_{1-\\alpha/2} \\frac{CV_C}{\\sqrt{M}} $$\n我们要求这个相对半宽最多为目标值 $\\delta$：\n$$ z_{1-\\alpha/2} \\frac{CV_C}{\\sqrt{M}} \\le \\delta $$\n解这个关于 $M$ 的不等式：\n$$ \\sqrt{M} \\ge z_{1-\\alpha/2} \\frac{CV_C}{\\delta} $$\n$$ M \\ge \\left( \\frac{z_{1-\\alpha/2} CV_C}{\\delta} \\right)^2 $$\n为了计算所需的 $M$，我们使用初步模拟的统计数据作为未知总体参数的置入估计。变异系数 $CV_C$ 通过 $\\widehat{CV}_C = s_C / \\bar{C}$ 来估计。\n给定的值为 $\\delta = 0.03$ 和 $1-\\alpha = 0.95$，这意味着 $z_{1-\\alpha/2} = z_{0.975} \\approx 1.960$。\n变异系数的置入估计为：\n$$ \\widehat{CV}_C = \\frac{s_C}{\\bar{C}} = \\frac{\\sqrt{5.5}}{3.7} \\approx 0.63384 $$\n将这些值代入关于 $M$ 的不等式中：\n$$ M \\ge \\left( \\frac{1.960 \\times (\\sqrt{5.5} / 3.7)}{0.03} \\right)^2 $$\n$$ M \\ge \\left( \\frac{1.960 \\times 0.63384}{0.03} \\right)^2 \\approx (41.4109)^2 \\approx 1714.86 $$\n由于步数 $M$ 必须是整数，我们必须向上取整到下一个整数以保证条件得到满足。\n$$ M_{req} = 1715 $$\n这个值 $1715$，按要求以四位有效数字呈现。\n\n最终的数值结果是速率 $r$ 的置信区间的下界和上界，以及所需的步数 $M$。\n$r_{lower} \\approx 1.824 \\times 10^5\\ \\text{s}^{-1}$\n$r_{upper} \\approx 1.876 \\times 10^5\\ \\text{s}^{-1}$\n$M = 1715$",
            "answer": "$$\\boxed{\\begin{pmatrix} 1.824 \\times 10^5  1.876 \\times 10^5  1715 \\end{pmatrix}}$$"
        }
    ]
}