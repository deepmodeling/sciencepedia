{
    "hands_on_practices": [
        {
            "introduction": "Simulating reacting flows presents a fundamental challenge due to the wide range of length and time scales involved. Convective transport is governed by the flow velocity, while chemical reactions can be orders of magnitude faster. This exercise  guides you through a first-principles analysis to quantify this disparity using the Courant–Friedrichs–Lewy (CFL) and Damköhler numbers, helping you understand why a single-resolution grid is often impractical and how to determine the necessary level of adaptive refinement.",
            "id": "4006193",
            "problem": "A one-dimensional advection–reaction model for a single reactive species with mass fraction $Y(x,t)$ is considered in a premixed, advection-dominated reacting flow. The governing equation is the conservation law\n$$\n\\frac{\\partial Y}{\\partial t} + u \\frac{\\partial Y}{\\partial x} = \\omega(Y,T),\n$$\nwhere $u$ is the flow speed and $\\omega(Y,T)$ is the chemical source term. Assume a global first-order kinetics model with Arrhenius rate,\n$$\n\\omega(Y,T) = -k(T)\\,Y, \\quad k(T) = A \\exp\\!\\left(-\\frac{E_{a}}{R T}\\right),\n$$\nwhere $A$ is the pre-exponential factor, $E_{a}$ is the activation energy, $R$ is the universal gas constant, and $T$ is temperature. Consider Adaptive Mesh Refinement (AMR) with uniform refinement ratio $2$ between levels. Let the base (coarsest) level have uniform grid spacing $\\Delta x_{0}$ and time step $\\Delta t_{0}$. On level $\\ell$, let $\\Delta x_{\\ell} = \\Delta x_{0}/2^{\\ell}$ and suppose that the time step is subcycled as $\\Delta t_{\\ell} = \\Delta t_{0}/2^{\\ell}$. The maximum flow speed is $u_{\\max}$.\n\nUsing only fundamental definitions based on time scales, do the following:\n\n1. Starting from the convective time scale across one cell and the discrete time step, derive the expression for the convective Courant–Friedrichs–Lewy (CFL) number on a given level and evaluate it on the base level using the data below.\n2. Starting from the Arrhenius expression for the chemical rate and the definition of a chemical time scale, derive and evaluate a Damköhler number at the base level based on the ratio of the convective cell-crossing time to the chemical time.\n3. Using your results and first principles, deduce constraints that AMR must satisfy to simultaneously maintain convective accuracy (CFL stability/accuracy) and reactive accuracy (spatial resolution of the reaction zone). Assume that convective accuracy is enforced by requiring the Courant number on every level to not exceed $0.5$ under the stated time-step subcycling, and that reactive spatial accuracy is enforced by requiring at least $N$ cells across the reaction zone of characteristic length $\\ell_{r}$. For an advection-dominated regime with negligible diffusion, take $\\ell_{r} = u_{\\max} \\,\\tau_{\\mathrm{chem}}$, where $\\tau_{\\mathrm{chem}}$ is the chemical time scale.\n4. Determine the minimum integer AMR level $\\ell_{\\min}$ such that both the convective and reactive accuracy constraints are satisfied.\n\nUse the following physically consistent parameters:\n- $u_{\\max} = 25~\\mathrm{m}\\,\\mathrm{s}^{-1}$,\n- $\\Delta x_{0} = 1.6 \\times 10^{-3}~\\mathrm{m}$,\n- $\\Delta t_{0} = 3.0 \\times 10^{-5}~\\mathrm{s}$,\n- $A = 2.0 \\times 10^{6}~\\mathrm{s}^{-1}$,\n- $E_{a} = 8.0 \\times 10^{4}~\\mathrm{J}\\,\\mathrm{mol}^{-1}$,\n- $R = 8.314~\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$,\n- $T = 1500~\\mathrm{K}$,\n- $N = 12$.\n\nAnswer specification:\n- Your computations in items 1–3 should be shown in your solution. \n- Report only the final value of the minimum AMR level $\\ell_{\\min}$ as your final answer. Do not include units in the final answer. \n- No rounding instruction is required for the final answer since it is an integer.",
            "solution": "The problem is first validated to ensure it is scientifically grounded, well-posed, and complete.\n\n### Step 1: Extract Givens\nThe governing partial differential equation for the mass fraction $Y(x,t)$ is:\n$$\n\\frac{\\partial Y}{\\partial t} + u \\frac{\\partial Y}{\\partial x} = \\omega(Y,T)\n$$\nThe chemical source term and Arrhenius rate constant are:\n$$\n\\omega(Y,T) = -k(T)\\,Y, \\quad k(T) = A \\exp\\!\\left(-\\frac{E_{a}}{R T}\\right)\n$$\nAdaptive Mesh Refinement (AMR) parameters:\n- Uniform refinement ratio: $2$\n- Grid spacing on level $\\ell$: $\\Delta x_{\\ell} = \\Delta x_{0}/2^{\\ell}$\n- Time step on level $\\ell$: $\\Delta t_{\\ell} = \\Delta t_{0}/2^{\\ell}$\n\nPhysical and numerical parameters:\n- Maximum flow speed: $u_{\\max} = 25~\\mathrm{m}\\,\\mathrm{s}^{-1}$\n- Base level grid spacing: $\\Delta x_{0} = 1.6 \\times 10^{-3}~\\mathrm{m}$\n- Base level time step: $\\Delta t_{0} = 3.0 \\times 10^{-5}~\\mathrm{s}$\n- Pre-exponential factor: $A = 2.0 \\times 10^{6}~\\mathrm{s}^{-1}$\n- Activation energy: $E_{a} = 8.0 \\times 10^{4}~\\mathrm{J}\\,\\mathrm{mol}^{-1}$\n- Universal gas constant: $R = 8.314~\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1}$\n- Temperature: $T = 1500~\\mathrm{K}$\n- Required cells in reaction zone: $N = 12$\n\nConstraints and definitions:\n- Convective accuracy: Courant number $C_{\\ell} \\le 0.5$ on every level $\\ell$.\n- Reaction zone characteristic length: $\\ell_{r} = u_{\\max} \\,\\tau_{\\mathrm{chem}}$, where $\\tau_{\\mathrm{chem}}$ is the chemical time scale.\n- Reactive accuracy: At least $N$ cells must resolve the length $\\ell_{r}$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically sound, describing a canonical one-dimensional advection-reaction system, which is a fundamental model in computational combustion. The use of Arrhenius kinetics, Courant-Friedrichs-Lewy (CFL) number, Damköhler number, and Adaptive Mesh Refinement (AMR) are all standard and well-established concepts in the field. The provided parameters are physically consistent for a premixed gas-phase combustion problem. The problem statement is complete, objective, and well-posed, providing all necessary data and clear, unambiguous definitions to deduce a unique integer solution.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution is warranted.\n\n### Solution Derivation\n\n**1. Convective Courant–Friedrichs–Lewy (CFL) Number**\n\nThe convective time scale, $\\tau_{\\text{conv},\\ell}$, is the time it takes for a fluid element to traverse a single grid cell of width $\\Delta x_{\\ell}$ at the maximum flow speed $u_{\\max}$.\n$$\n\\tau_{\\text{conv},\\ell} = \\frac{\\Delta x_{\\ell}}{u_{\\max}}\n$$\nThe Courant–Friedrichs–Lewy (CFL) number, $C_{\\ell}$, is defined as the ratio of the discrete time step, $\\Delta t_{\\ell}$, to this convective time scale.\n$$\nC_{\\ell} = \\frac{\\Delta t_{\\ell}}{\\tau_{\\text{conv},\\ell}} = \\frac{\\Delta t_{\\ell}}{(\\Delta x_{\\ell} / u_{\\max})} = \\frac{u_{\\max} \\Delta t_{\\ell}}{\\Delta x_{\\ell}}\n$$\nTo evaluate this on the base level ($\\ell=0$), we use the provided data:\n$$\nC_{0} = \\frac{u_{\\max} \\Delta t_{0}}{\\Delta x_{0}} = \\frac{(25~\\mathrm{m}\\,\\mathrm{s}^{-1}) (3.0 \\times 10^{-5}~\\mathrm{s})}{1.6 \\times 10^{-3}~\\mathrm{m}} = \\frac{7.5 \\times 10^{-4}}{1.6 \\times 10^{-3}} = \\frac{7.5}{16} = 0.46875\n$$\n\n**2. Damköhler Number**\n\nThe chemical reaction follows first-order kinetics, $\\frac{dY}{dt} = -k(T)Y$. The characteristic chemical time scale, $\\tau_{\\mathrm{chem}}$, is the inverse of the rate constant $k(T)$.\n$$\n\\tau_{\\mathrm{chem}} = \\frac{1}{k(T)} = \\frac{1}{A \\exp(-E_{a}/(RT))}\n$$\nFirst, we compute the argument of the exponential:\n$$\n\\frac{E_{a}}{RT} = \\frac{8.0 \\times 10^{4}~\\mathrm{J}\\,\\mathrm{mol}^{-1}}{(8.314~\\mathrm{J}\\,\\mathrm{mol}^{-1}\\,\\mathrm{K}^{-1})(1500~\\mathrm{K})} = \\frac{8.0 \\times 10^{4}}{12471} \\approx 6.41532\n$$\nNow, we calculate the rate constant $k(T)$ and the chemical time scale $\\tau_{\\mathrm{chem}}$:\n$$\nk(1500~\\mathrm{K}) = (2.0 \\times 10^{6}~\\mathrm{s}^{-1}) \\exp(-6.41532) \\approx (2.0 \\times 10^{6})(1.636 \\times 10^{-3})~\\mathrm{s}^{-1} \\approx 3272.36~\\mathrm{s}^{-1}\n$$\n$$\n\\tau_{\\mathrm{chem}} = \\frac{1}{k(1500~\\mathrm{K})} \\approx \\frac{1}{3272.36~\\mathrm{s}^{-1}} \\approx 3.05589 \\times 10^{-4}~\\mathrm{s}\n$$\nThe problem specifies the Damköhler number on the base level, $Da_{0}$, as the ratio of the convective cell-crossing time, $\\tau_{\\text{conv},0}$, to the chemical time, $\\tau_{\\mathrm{chem}}$.\n$$\n\\tau_{\\text{conv},0} = \\frac{\\Delta x_{0}}{u_{\\max}} = \\frac{1.6 \\times 10^{-3}~\\mathrm{m}}{25~\\mathrm{m}\\,\\mathrm{s}^{-1}} = 6.4 \\times 10^{-5}~\\mathrm{s}\n$$\n$$\nDa_{0} = \\frac{\\tau_{\\text{conv},0}}{\\tau_{\\mathrm{chem}}} \\approx \\frac{6.4 \\times 10^{-5}~\\mathrm{s}}{3.05589 \\times 10^{-4}~\\mathrm{s}} \\approx 0.2094\n$$\n\n**3. AMR Constraints**\n\n*   **Convective Accuracy Constraint:** The CFL number on any level $\\ell$ must satisfy $C_{\\ell} \\le 0.5$. Using the AMR scaling relations $\\Delta x_{\\ell} = \\Delta x_0/2^\\ell$ and $\\Delta t_\\ell = \\Delta t_0/2^\\ell$:\n    $$\n    C_{\\ell} = \\frac{u_{\\max} \\Delta t_{\\ell}}{\\Delta x_{\\ell}} = \\frac{u_{\\max} (\\Delta t_{0}/2^{\\ell})}{(\\Delta x_{0}/2^{\\ell})} = \\frac{u_{\\max} \\Delta t_{0}}{\\Delta x_{0}} = C_{0}\n    $$\n    This demonstrates that for the prescribed subcycling scheme, the CFL number is constant across all AMR levels. The constraint becomes $C_{0} \\le 0.5$. From part 1, we calculated $C_{0} = 0.46875$. Since $0.46875 \\le 0.5$, the convective constraint is satisfied on all levels $\\ell \\ge 0$. This constraint does not impose a minimum required AMR level.\n\n*   **Reactive Accuracy Constraint:** The reaction zone must be resolved by at least $N=12$ cells on the appropriate AMR level $\\ell$. The length of the reaction zone is $\\ell_{r} = u_{\\max} \\tau_{\\mathrm{chem}}$. The number of grid cells of size $\\Delta x_{\\ell}$ spanning this length is $\\ell_{r} / \\Delta x_{\\ell}$. The constraint is:\n    $$\n    \\frac{\\ell_{r}}{\\Delta x_{\\ell}} \\ge N \\implies \\frac{u_{\\max} \\tau_{\\mathrm{chem}}}{\\Delta x_{\\ell}} \\ge N\n    $$\n    This imposes an upper bound on the grid spacing required for reactive accuracy:\n    $$\n    \\Delta x_{\\ell} \\le \\frac{u_{\\max} \\tau_{\\mathrm{chem}}}{N}\n    $$\n    The required mesh must be at least this fine.\n\n**4. Minimum AMR Level $\\ell_{\\min}$**\n\nWe need to find the smallest integer AMR level $\\ell = \\ell_{\\min}$ that satisfies the reactive accuracy constraint, as the convective one is already satisfied for all levels. We substitute the expression for $\\Delta x_{\\ell}$ into the reactive constraint inequality:\n$$\n\\frac{\\Delta x_{0}}{2^{\\ell}} \\le \\frac{u_{\\max} \\tau_{\\mathrm{chem}}}{N}\n$$\nTo find the minimum $\\ell$, we solve for $2^{\\ell}$:\n$$\n2^{\\ell} \\ge \\frac{N \\Delta x_{0}}{u_{\\max} \\tau_{\\mathrm{chem}}}\n$$\nNow, we substitute the known values into the right-hand side of the inequality:\n$$\n\\frac{N \\Delta x_{0}}{u_{\\max} \\tau_{\\mathrm{chem}}} \\approx \\frac{(12)(1.6 \\times 10^{-3}~\\mathrm{m})}{(25~\\mathrm{m}\\,\\mathrm{s}^{-1})(3.05589 \\times 10^{-4}~\\mathrm{s})} = \\frac{1.92 \\times 10^{-2}}{7.6397 \\times 10^{-3}} \\approx 2.5132\n$$\nThe inequality to solve for the minimal integer $\\ell$ is:\n$$\n2^{\\ell} \\ge 2.5132\n$$\nWe test integer values for $\\ell$:\n- For $\\ell=0$: $2^{0} = 1$, which is not $\\ge 2.5132$.\n- For $\\ell=1$: $2^{1} = 2$, which is not $\\ge 2.5132$.\n- For $\\ell=2$: $2^{2} = 4$, which is $\\ge 2.5132$.\n\nAlternatively, taking the natural logarithm of both sides:\n$$\n\\ell \\ln(2) \\ge \\ln(2.5132) \\implies \\ell \\ge \\frac{\\ln(2.5132)}{\\ln(2)} \\approx \\frac{0.9215}{0.6931} \\approx 1.3295\n$$\nSince the AMR level $\\ell$ must be an integer, the smallest integer satisfying this condition is $\\ell_{\\min}=2$.\n\nTherefore, a minimum AMR level of $\\ell_{\\min}=2$ is required to satisfy both the convective and reactive accuracy constraints. At this level, the grid spacing will be $\\Delta x_2 = \\Delta x_0/4 = 4.0 \\times 10^{-4}~\\mathrm{m}$, which is fine enough to resolve the reaction zone.",
            "answer": "$$\\boxed{2}$$"
        },
        {
            "introduction": "A cornerstone of Adaptive Mesh Refinement (AMR) for conservation laws is ensuring that quantities like mass, momentum, and energy are conserved across interfaces between coarse and fine grids. A naive coupling can lead to artificial sources or sinks, violating the underlying physics. This practice  provides a concrete, step-by-step calculation of the flux-refluxing algorithm, allowing you to see exactly how the flux mismatch between grid levels is computed and corrected to maintain perfect conservation.",
            "id": "4006196",
            "problem": "Consider a one-dimensional advection–diffusion substep for a single species mass fraction $Y$ in a reacting flow, formulated within the Adaptive Mesh Refinement (AMR) framework, where reaction is handled by operator splitting and is inactive during this substep (i.e., the reaction source is zero). The governing conservation law for the species during this substep is\n$$\n\\frac{\\partial (\\rho Y)}{\\partial t} + \\frac{\\partial F}{\\partial x} = 0,\n$$\nwith the total species flux\n$$\nF = \\rho u Y - \\rho D \\frac{\\partial Y}{\\partial x},\n$$\nwhere $\\rho$ is the mass density, $u$ is the advection velocity, and $D$ is the molecular diffusivity. Assume a constant density $\\rho$ and a uniform cross-sectional area of $1$ so that cell volumes are lengths.\n\nA coarse grid consists of two coarse cells `C0` and `C1` covering $x \\in [0, 2\\Delta x_c]$ with coarse cell width $\\Delta x_c$. A fine grid with refinement ratio $r = 2$ covers the entire spatial extent of coarse cell `C1`, consisting of two fine cells `F1` and `F2` of width $\\Delta x_f = \\Delta x_c/2$. The interface between `C0` and the fine grid is at $x = \\Delta x_c$. The face at $x = \\Delta x_c$ is shared between coarse cell `C0` and fine cell `F1`. The left boundary at $x = 0$ is an inflow with a fixed Dirichlet mass fraction.\n\nThe parameters and initial data are:\n- Density $\\rho = 1.0 \\ \\mathrm{kg/m^3}$,\n- Advection velocity $u = 0.8 \\ \\mathrm{m/s}$ (positive $x$ direction),\n- Diffusivity $D = 1.0 \\times 10^{-4} \\ \\mathrm{m^2/s}$,\n- Coarse width $\\Delta x_c = 2.0 \\times 10^{-3} \\ \\mathrm{m}$,\n- Fine width $\\Delta x_f = 1.0 \\times 10^{-3} \\ \\mathrm{m}$,\n- Time step $\\Delta t = 5.0 \\times 10^{-4} \\ \\mathrm{s}$,\n- Inflow mass fraction at $x=0$: $Y_{\\text{in}} = 0.20$,\n- Initial mass fractions: $Y_{C0}^n = 0.06$, $Y_{F1}^n = 0.12$, $Y_{F2}^n = 0.08$.\n\nOn the coarse level, the covered coarse neighbor `C1` is defined by conservative restriction of the fine data, so its coarse mass fraction is the average $Y_{C1}^n = (Y_{F1}^n + Y_{F2}^n)/2$.\n\nUse the following physically standard discretization principles derived from the conservation law and constitutive flux:\n- Upwind selection for the advective face state $Y$ based on the sign of $u$,\n- Centered difference for the diffusive flux using the distance between adjacent cell centers; for a face between two cells of widths $\\Delta x_L$ and $\\Delta x_R$, the center-to-center distance is $\\Delta x_L/2 + \\Delta x_R/2$.\n\nTasks:\n1. Compute the coarse-level advective–diffusive flux at the right face of `C0` (located at $x = \\Delta x_c$) using $Y_{C0}^n$ and the coarse neighbor $Y_{C1}^n$, with center-to-center distance $\\Delta x_c$. Also compute the face flux at the left boundary of `C0` (located at $x=0$) using $Y_{\\text{in}}$ and $Y_{C0}^n$, with center-to-center distance $\\Delta x_c/2$.\n2. Update $Y_{C0}$ over the time step $\\Delta t$ using the coarse-level fluxes at the left and right faces via the finite-volume update implied by the conservation law.\n3. Compute the fine-level flux at the interface face $x = \\Delta x_c$ between `C0` and `F1` using the upwind state from `C0` and the fine state from `F1`, and the center-to-center distance $\\Delta x_c/2 + \\Delta x_f/2$.\n4. Populate a flux register with the fine-level interface flux and apply the reflux correction to the coarse cell `C0` so that its final updated state is consistent with the fine-level interface flux through $x = \\Delta x_c$.\n5. From the corrected $Y_{C0}^{n+1}$, compute the final species mass in `C0` per unit cross-sectional area, defined as $m_{C0}^{n+1} = \\rho \\, Y_{C0}^{n+1} \\, \\Delta x_c$, and express it in $\\mathrm{kg/m^2}$.\n\nRound your final answer to four significant figures and express the final mass in $\\mathrm{kg/m^2}$.",
            "solution": "The problem is first validated against the established criteria.\n\n### Step 1: Extract Givens\n- **Governing Equation**: $\\frac{\\partial (\\rho Y)}{\\partial t} + \\frac{\\partial F}{\\partial x} = 0$\n- **Total Species Flux**: $F = \\rho u Y - \\rho D \\frac{\\partial Y}{\\partial x}$\n- **Grid Structure**:\n    - Coarse cell $C0$ on $x \\in [0, \\Delta x_c]$.\n    - Coarse cell $C1$ on $x \\in [\\Delta x_c, 2\\Delta x_c]$, covered by a fine grid.\n    - Fine cells $F1$ on $x \\in [\\Delta x_c, \\Delta x_c + \\Delta x_f]$ and $F2$ on $x \\in [\\Delta x_c + \\Delta x_f, 2\\Delta x_c]$.\n    - Refinement ratio: $r = 2$.\n    - Coarse cell width: $\\Delta x_c = 2.0 \\times 10^{-3} \\ \\mathrm{m}$.\n    - Fine cell width: $\\Delta x_f = \\Delta x_c / r = 1.0 \\times 10^{-3} \\ \\mathrm{m}$.\n    - Interface between $C0$ and fine grid at $x = \\Delta x_c$.\n- **Parameters**:\n    - Density: $\\rho = 1.0 \\ \\mathrm{kg/m^3}$ (constant).\n    - Advection velocity: $u = 0.8 \\ \\mathrm{m/s}$.\n    - Diffusivity: $D = 1.0 \\times 10^{-4} \\ \\mathrm{m^2/s}$.\n    - Time step: $\\Delta t = 5.0 \\times 10^{-4} \\ \\mathrm{s}$.\n- **Boundary and Initial Conditions**:\n    - Inflow mass fraction at $x=0$: $Y_{\\text{in}} = 0.20$.\n    - Initial mass fraction in $C0$: $Y_{C0}^n = 0.06$.\n    - Initial mass fraction in $F1$: $Y_{F1}^n = 0.12$.\n    - Initial mass fraction in $F2$: $Y_{F2}^n = 0.08$.\n- **Discretization Rules**:\n    - Upwind advection: face state for $Y$ is taken from the upwind cell based on the sign of $u$. Since $u > 0$, the left cell state is used.\n    - Centered difference for diffusion: gradient is $\\frac{\\Delta Y}{\\Delta x_{\\text{centers}}}$.\n    - For the coarse-coarse interface ($C0$ and $C1$), center-to-center distance is $\\Delta x_c$.\n    - For the boundary-coarse interface (at $x=0$), center-to-center distance is $\\Delta x_c/2$.\n    - For the coarse-fine interface (at $x=\\Delta x_c$), center-to-center distance is $\\Delta x_c/2 + \\Delta x_f/2$.\n    - Coarse state for covered cell $C1$ is $Y_{C1}^n = (Y_{F1}^n + Y_{F2}^n)/2$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is a well-defined numerical exercise in computational fluid dynamics, specifically focusing on the finite volume method with Adaptive Mesh Refinement (AMR).\n- **Scientifically Grounded**: The problem is based on the standard advection-diffusion equation, a fundamental model in transport phenomena. The AMR concepts, such as flux refluxing, are standard techniques in advanced numerical schemes. All parameters have realistic physical units and plausible magnitudes.\n- **Well-Posed**: The problem provides a complete set of parameters, initial conditions, boundary conditions, and explicit discretization rules. It requests a series of specific calculations leading to a unique numerical answer. The structure is logical and free of contradictions.\n- **Objective**: The problem is stated in precise, quantitative terms. The tasks are specified algorithmically, leaving no room for subjective interpretation.\n\nThe problem does not violate any of the invalidity criteria. It is scientifically sound, well-posed, complete, and objective.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A detailed solution will be provided.\n\n### Solution Derivation\nThe finite volume discretization of the governing equation for a generic cell $i$ with constant density $\\rho$ and volume $\\Delta x_i$ (per unit area) is:\n$$ Y_i^{n+1} = Y_i^n - \\frac{\\Delta t}{\\rho \\Delta x_i} (F_{i+1/2} - F_{i-1/2}) $$\nThe flux $F$ at a face between a left cell $L$ and a right cell $R$ is discretized as the sum of an advective flux and a diffusive flux. Given $u > 0$, the advective part uses the state from the left cell, $Y_L$. The diffusive flux is a centered difference.\n$$ F_{face} = (\\rho u Y_L) - (\\rho D) \\frac{Y_R - Y_L}{d_{centers}} $$\nwhere $d_{centers}$ is the distance between the cell centers.\n\nFirst, we determine the state of the coarse neighbor $C1$. It is the volume-weighted average (restriction) of the fine cells covering it.\n$$ Y_{C1}^n = \\frac{Y_{F1}^n \\Delta x_f + Y_{F2}^n \\Delta x_f}{\\Delta x_c} = \\frac{Y_{F1}^n + Y_{F2}^n}{r} $$\nWith $r=2$, this is a simple average:\n$$ Y_{C1}^n = \\frac{0.12 + 0.08}{2} = 0.10 $$\n\n**Task 1: Compute Coarse-Level Fluxes for $C0$**\n\nThe cell $C0$ has a left face at $x=0$ and a right face at $x=\\Delta x_c$.\n\n- **Flux at the left face of $C0$ ($F_{C0,left}$ at $x=0$):**\nThe left \"cell\" is the boundary condition $Y_{\\text{in}}$, and the right cell is $C0$. The center-to-center distance is given as $d_{centers} = \\Delta x_c / 2$.\nAdvection uses the upstream state $Y_{\\text{in}}$.\n$$ F_{C0,left} = \\rho u Y_{\\text{in}} - \\rho D \\frac{Y_{C0}^n - Y_{\\text{in}}}{\\Delta x_c / 2} $$\n$$ F_{C0,left} = (1.0)(0.8)(0.20) - (1.0)(1.0 \\times 10^{-4}) \\frac{0.06 - 0.20}{2.0 \\times 10^{-3} / 2} $$\n$$ F_{C0,left} = 0.16 - (1.0 \\times 10^{-4}) \\frac{-0.14}{1.0 \\times 10^{-3}} = 0.16 - (1.0 \\times 10^{-4})(-140) = 0.16 + 0.014 = 0.174 $$\n\n- **Flux at the right face of $C0$ ($F_{C0,right}^c$ at $x=\\Delta x_c$), coarse-level:**\nThe left cell is $C0$, and the right cell is $C1$. The center-to-center distance is given as $d_{centers} = \\Delta x_c$.\nAdvection uses the left state $Y_{C0}^n$.\n$$ F_{C0,right}^c = \\rho u Y_{C0}^n - \\rho D \\frac{Y_{C1}^n - Y_{C0}^n}{\\Delta x_c} $$\n$$ F_{C0,right}^c = (1.0)(0.8)(0.06) - (1.0)(1.0 \\times 10^{-4}) \\frac{0.10 - 0.06}{2.0 \\times 10^{-3}} $$\n$$ F_{C0,right}^c = 0.048 - (1.0 \\times 10^{-4}) \\frac{0.04}{2.0 \\times 10^{-3}} = 0.048 - (1.0 \\times 10^{-4})(20) = 0.048 - 0.002 = 0.046 $$\n\n**Task 2: Update $Y_{C0}$ using coarse fluxes**\n\nThis is a provisional update for $C0$ using only coarse-level information.\n$$ Y_{C0}^{n+1, \\text{coarse}} = Y_{C0}^n - \\frac{\\Delta t}{\\rho \\Delta x_c} (F_{C0,right}^c - F_{C0,left}) $$\n$$ Y_{C0}^{n+1, \\text{coarse}} = 0.06 - \\frac{5.0 \\times 10^{-4}}{(1.0)(2.0 \\times 10^{-3})} (0.046 - 0.174) $$\n$$ Y_{C0}^{n+1, \\text{coarse}} = 0.06 - (0.25) (-0.128) = 0.06 + 0.032 = 0.092 $$\n\n**Task 3: Compute Fine-Level Interface Flux**\n\nThis is the more accurate flux at the coarse-fine interface $x=\\Delta x_c$. The left cell is $C0$ and the right cell is the fine cell $F1$. The center-to-center distance is $d_{centers} = \\Delta x_c/2 + \\Delta x_f/2$.\n$$ d_{centers} = \\frac{2.0 \\times 10^{-3}}{2} + \\frac{1.0 \\times 10^{-3}}{2} = 1.0 \\times 10^{-3} + 0.5 \\times 10^{-3} = 1.5 \\times 10^{-3} \\ \\mathrm{m} $$\nThe fine-level flux $F_{C0,right}^f$ is:\n$$ F_{C0,right}^f = \\rho u Y_{C0}^n - \\rho D \\frac{Y_{F1}^n - Y_{C0}^n}{\\Delta x_c/2 + \\Delta x_f/2} $$\n$$ F_{C0,right}^f = (1.0)(0.8)(0.06) - (1.0)(1.0 \\times 10^{-4}) \\frac{0.12 - 0.06}{1.5 \\times 10^{-3}} $$\n$$ F_{C0,right}^f = 0.048 - (1.0 \\times 10^{-4}) \\frac{0.06}{1.5 \\times 10^{-3}} = 0.048 - (1.0 \\times 10^{-4})(40) = 0.048 - 0.004 = 0.044 $$\n\n**Task 4: Apply Reflux Correction**\n\nThe flux refluxing procedure corrects the coarse cell state to ensure conservation at the coarse-fine interface. The update to $Y_{C0}^{n+1, \\text{coarse}}$ is based on the difference between the coarse-level flux and the fine-level flux at the interface.\nThe change in species mass in $C0$ due to the flux discrepancy is $\\Delta m = (F_{C0,right}^c - F_{C0,right}^f) \\Delta t A$. Since area $A=1$, the correction to the state variable $Y_{C0}$ is:\n$$ \\Delta Y_{C0}^{\\text{reflux}} = \\frac{(F_{C0,right}^c - F_{C0,right}^f) \\Delta t}{\\rho \\Delta x_c} $$\n$$ \\Delta Y_{C0}^{\\text{reflux}} = \\frac{(0.046 - 0.044) (5.0 \\times 10^{-4})}{(1.0) (2.0 \\times 10^{-3})} = \\frac{(0.002) (5.0 \\times 10^{-4})}{2.0 \\times 10^{-3}} = \\frac{1.0 \\times 10^{-6}}{2.0 \\times 10^{-3}} = 0.0005 $$\nThe final, corrected state for $C0$ is:\n$$ Y_{C0}^{n+1} = Y_{C0}^{n+1, \\text{coarse}} + \\Delta Y_{C0}^{\\text{reflux}} $$\n$$ Y_{C0}^{n+1} = 0.092 + 0.0005 = 0.0925 $$\n\n**Task 5: Compute Final Species Mass in $C0$**\n\nThe final species mass in cell $C0$ per unit cross-sectional area is:\n$$ m_{C0}^{n+1} = \\rho \\, Y_{C0}^{n+1} \\, \\Delta x_c $$\n$$ m_{C0}^{n+1} = (1.0 \\ \\mathrm{kg/m^3}) \\times (0.0925) \\times (2.0 \\times 10^{-3} \\ \\mathrm{m}) $$\n$$ m_{C0}^{n+1} = 0.185 \\times 10^{-3} \\ \\mathrm{kg/m^2} = 1.85 \\times 10^{-4} \\ \\mathrm{kg/m^2} $$\nThe problem requires the answer to be rounded to four significant figures.\n$$ m_{C0}^{n+1} = 1.850 \\times 10^{-4} \\ \\mathrm{kg/m^2} $$",
            "answer": "$$\\boxed{1.850 \\times 10^{-4}}$$"
        },
        {
            "introduction": "The power of AMR lies in its ability to dynamically adapt the mesh to evolving features in the flow. However, the logic that governs this adaptation—the refinement criteria—must be designed carefully to be both efficient and robust. This hands-on coding exercise  explores this challenge by asking you to compare a simple gradient-based coarsening policy with a more sophisticated hysteresis-based policy, demonstrating how \"memory\" can prevent the grid from prematurely removing resolution and missing critical events like flame reignition.",
            "id": "4006195",
            "problem": "Consider one-dimensional reacting flow in which a previously burning premixed flame has been quenched and may later reignite. Let the volumetric heat-release rate field be denoted by $\\dot{q}(x,t)$ with units $\\mathrm{W/m^3}$, and define a gradient-based adaptive mesh refinement (AMR) coarsening indicator based on the magnitude of the spatial gradient $G(x,t) = \\left|\\partial \\dot{q}(x,t)/\\partial x\\right|$ with units $\\mathrm{W/m^4}$. The goal is to compute, over a given domain and time horizon, a coarsening mask for each time step that indicates which cells would be coarsened by a gradient thresholding policy, and to quantify premature coarsening events that would miss imminent reignition. Then, demonstrate how hysteresis thresholds with memory avoid such premature coarsening.\n\nStart from the conservation of energy in reacting flows, which motivates monitoring $\\dot{q}(x,t)$ as a proxy for reaction-zone activity. For algorithmic testing, model a quenched flame whose heat-release field is localized in space as a Gaussian centered at position $x_0$ with standard deviation $\\sigma_x$, multiplied by a time-dependent amplitude composed of an exponentially decaying baseline and optionally one or multiple Gaussian-in-time pulses representing reignition events. Specifically, on the spatial domain $x \\in [0, L]$ and time interval $t \\in [0, T_{\\text{end}}]$, define\n$$\n\\dot{q}(x,t) = \\left( A_0 e^{-t/\\tau_d} + \\sum_{k=1}^{N_p} B_k \\exp\\!\\left[-\\frac{(t - t_k)^2}{2\\sigma_{t,k}^2}\\right] \\right) \\exp\\!\\left[-\\frac{(x - x_0)^2}{2\\sigma_x^2}\\right],\n$$\nwhere $A_0$ is the initial baseline amplitude in $\\mathrm{W/m^3}$, $\\tau_d$ is the decay time constant in $\\mathrm{s}$, each $B_k$ is a pulse amplitude in $\\mathrm{W/m^3}$ at time $t_k$ with temporal width $\\sigma_{t,k}$ in $\\mathrm{s}$, and $N_p$ is the number of pulses. The spatial grid is uniform with spacing $\\Delta x$ and the time grid is uniform with spacing $\\Delta t$.\n\nDefine two coarsening policies:\n\n1. A naive single-threshold policy with coarsening threshold $\\theta_c$ in $\\mathrm{W/m^4}$: at time $t_j$, coarsen cell $i$ if $G(x_i,t_j) \\le \\theta_c$; otherwise, keep it refined.\n\n2. A hysteresis two-threshold policy with refine threshold $\\theta_r$ in $\\mathrm{W/m^4}$, coarsen threshold $\\theta_c$ in $\\mathrm{W/m^4}$, and a memory time $\\tau_{\\mathrm{mem}}$ in $\\mathrm{s}$: maintain a per-cell memory of the most recent time $t^{\\mathrm{last}}_{\\mathrm{high}}(i)$ when $G(x_i,t) \\ge \\theta_r$. At time $t_j$, for each cell $i$, set $t^{\\mathrm{last}}_{\\mathrm{high}}(i) \\leftarrow t_j$ if $G(x_i,t_j) \\ge \\theta_r$. Then, coarsen cell $i$ if both $G(x_i,t_j) \\le \\theta_c$ and $t_j - t^{\\mathrm{last}}_{\\mathrm{high}}(i) \\ge \\tau_{\\mathrm{mem}}$; otherwise, keep it refined. Initialize $t^{\\mathrm{last}}_{\\mathrm{high}}(i)$ to $-\\infty$ for all $i$.\n\nTo quantify premature coarsening that would miss reignition, define at each time $t_j$ a lookahead horizon $T_{\\mathrm{future}}$ in $\\mathrm{s}$. For any cell that is coarsened at $t_j$, declare it a premature coarsen if there exists any time $t \\in (t_j, t_j + T_{\\mathrm{future}}]$ at which $G(x_i,t) \\ge \\theta_r$. Let $E_{\\mathrm{naive}}$ be the total count of such premature coarsening across all cells and time steps under the naive policy, and $E_{\\mathrm{hyst}}$ be the analogous count under the hysteresis policy. Define the improvement fraction as\n$$\n\\Phi = \\frac{E_{\\mathrm{naive}} - E_{\\mathrm{hyst}}}{\\max(1, E_{\\mathrm{naive}})},\n$$\nwhich is a unitless decimal.\n\nImplement a program that:\n- Constructs $\\dot{q}(x,t)$ on the specified grids.\n- Computes $G(x,t)$ using a second-order accurate finite difference approximation in space.\n- Applies both coarsening policies over time to count $E_{\\mathrm{naive}}$ and $E_{\\mathrm{hyst}}$ using the lookahead criterion.\n- Outputs, for each test case, the triple $(E_{\\mathrm{naive}}, E_{\\mathrm{hyst}}, \\Phi)$.\n\nExpress all parameter values in International System of Units (SI). The output counts are integers and the improvement fraction is a decimal number.\n\nYou must implement and evaluate the following test suite, which spans distinct scenarios:\n\n- Test Case 1 (quenched flame with a single reignition pulse):\n    - $L = 0.02$ $\\mathrm{m}$, $x_0 = 0.01$ $\\mathrm{m}$, $\\sigma_x = 0.001$ $\\mathrm{m}$, $\\Delta x = 0.0001$ $\\mathrm{m}$.\n    - $T_{\\text{end}} = 0.20$ $\\mathrm{s}$, $\\Delta t = 0.002$ $\\mathrm{s}$.\n    - $A_0 = 8.0 \\times 10^7$ $\\mathrm{W/m^3}$, $\\tau_d = 0.05$ $\\mathrm{s}$.\n    - Single pulse: $N_p = 1$ with $B_1 = 1.2 \\times 10^8$ $\\mathrm{W/m^3}$, $t_1 = 0.12$ $\\mathrm{s}$, $\\sigma_{t,1} = 0.01$ $\\mathrm{s}$.\n    - Thresholds and memory: $\\theta_r = 2.5 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\theta_c = 1.2 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\tau_{\\mathrm{mem}} = 0.02$ $\\mathrm{s}$.\n    - Lookahead: $T_{\\mathrm{future}} = 0.02$ $\\mathrm{s}$.\n\n- Test Case 2 (monotonic decay, no reignition):\n    - Same spatial and temporal grid parameters as Test Case 1.\n    - $A_0 = 8.0 \\times 10^7$ $\\mathrm{W/m^3}$, $\\tau_d = 0.05$ $\\mathrm{s}$.\n    - No pulses: $N_p = 0$.\n    - Thresholds and memory: $\\theta_r = 2.5 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\theta_c = 1.2 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\tau_{\\mathrm{mem}} = 0.02$ $\\mathrm{s}$.\n    - Lookahead: $T_{\\mathrm{future}} = 0.02$ $\\mathrm{s}$.\n\n- Test Case 3 (intermittent pulses causing potential thrashing):\n    - $L = 0.02$ $\\mathrm{m}$, $x_0 = 0.01$ $\\mathrm{m}$, $\\sigma_x = 0.001$ $\\mathrm{m}$, $\\Delta x = 0.0001$ $\\mathrm{m}$.\n    - $T_{\\text{end}} = 0.20$ $\\mathrm{s}$, $\\Delta t = 0.002$ $\\mathrm{s}$.\n    - $A_0 = 5.0 \\times 10^7$ $\\mathrm{W/m^3}$, $\\tau_d = 0.10$ $\\mathrm{s}$.\n    - Three pulses: $N_p = 3$ with $(B_1, t_1, \\sigma_{t,1}) = (9.0 \\times 10^7, 0.05, 0.005)$, $(B_2, t_2, \\sigma_{t,2}) = (9.0 \\times 10^7, 0.07, 0.005)$, $(B_3, t_3, \\sigma_{t,3}) = (9.0 \\times 10^7, 0.09, 0.005)$; units are $\\mathrm{W/m^3}$ for $B_k$ and $\\mathrm{s}$ for $t_k$ and $\\sigma_{t,k}$.\n    - Thresholds and memory: $\\theta_r = 2.0 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\theta_c = 1.0 \\times 10^{10}$ $\\mathrm{W/m^4}$, $\\tau_{\\mathrm{mem}} = 0.03$ $\\mathrm{s}$.\n    - Lookahead: $T_{\\mathrm{future}} = 0.02$ $\\mathrm{s}$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered as [$E_{\\mathrm{naive,1}}, E_{\\mathrm{hyst,1}}, \\Phi_1, E_{\\mathrm{naive,2}}, E_{\\mathrm{hyst,2}}, \\Phi_2, E_{\\mathrm{naive,3}}, E_{\\mathrm{hyst,3}}, \\Phi_3$], where the subscript denotes the test case index. The counts $E_{\\mathrm{naive}}$ and $E_{\\mathrm{hyst}}$ must be integers, and the improvement fractions $\\Phi$ must be decimal numbers.",
            "solution": "The user-provided problem is assessed as valid. It is scientifically grounded in the principles of computational combustion and adaptive mesh refinement, well-posed with a clear and deterministic set of instructions, and uses objective, formal language. All necessary parameters and definitions are provided, and the problem constitutes a non-trivial algorithmic design and evaluation task.\n\nThe solution is implemented by following a systematic, principle-based approach. The core of the problem is to simulate and compare two different coarsening strategies for a simplified one-dimensional reacting flow model. The solution is structured as follows:\n\n1.  **Problem Formulation and Discretization**:\n    The heat-release rate field, $\\dot{q}(x,t)$, is defined over a continuous spatial domain $x \\in [0, L]$ and time interval $t \\in [0, T_{\\text{end}}]$. For a numerical solution, these continuous domains must be discretized. The spatial domain is divided into a uniform grid of points $x_i = i \\cdot \\Delta x$ for $i = 0, 1, \\dots, N_x-1$, where the number of points is $N_x = \\text{round}(L/\\Delta x) + 1$. Similarly, the time interval is discretized into points $t_j = j \\cdot \\Delta t$ for $j = 0, 1, \\dots, N_t-1$, where $N_t = \\text{round}(T_{\\text{end}}/\\Delta t) + 1$.\n    The provided analytical model for $\\dot{q}(x,t)$ is then evaluated on this discrete grid to produce a matrix $\\mathbf{Q}$ of size $N_t \\times N_x$, where $\\mathbf{Q}_{ji} = \\dot{q}(x_i, t_j)$.\n    The expression for $\\dot{q}(x,t)$ is given by:\n    $$\n    \\dot{q}(x,t) = A(t) \\cdot S(x)\n    $$\n    where the time-dependent amplitude is\n    $$\n    A(t) = A_0 e^{-t/\\tau_d} + \\sum_{k=1}^{N_p} B_k \\exp\\!\\left[-\\frac{(t - t_k)^2}{2\\sigma_{t,k}^2}\\right]\n    $$\n    and the spatial profile is\n    $$\n    S(x) = \\exp\\!\\left[-\\frac{(x - x_0)^2}{2\\sigma_x^2}\\right]\n    $$\n\n2.  **Gradient Field Computation**:\n    The coarsening indicator is based on the magnitude of the spatial gradient of the heat-release rate, $G(x,t) = |\\partial \\dot{q}(x,t) / \\partial x|$. To compute this on the discrete grid, a second-order accurate finite difference approximation is required. For an interior point $x_i$, a central difference scheme is used:\n    $$\n    \\frac{\\partial \\dot{q}}{\\partial x}\\bigg|_{x_i, t_j} \\approx \\frac{\\dot{q}(x_{i+1}, t_j) - \\dot{q}(x_{i-1}, t_j)}{2\\Delta x}\n    $$\n    To maintain second-order accuracy at the boundaries of the domain ($i=0$ and $i=N_x-1$), second-order accurate one-sided (forward and backward) difference schemes are employed. This entire operation is efficiently performed for all points $(x_i, t_j)$ to generate the gradient matrix $\\mathbf{G}$, where $\\mathbf{G}_{ji} = G(x_i, t_j)$.\n\n3.  **Coarsening Policy Simulation**:\n    The core of the simulation involves iterating over every cell (indexed by $i$) and every time step (indexed by $j$) to apply the two coarsening policies.\n\n    *   **Naive Single-Threshold Policy**: A cell $i$ is flagged for coarsening at time $t_j$ if its corresponding gradient value is below the coarsening threshold $\\theta_c$.\n        Condition to coarsen cell $i$ at time $t_j$:\n        $$\n        G(x_i, t_j) \\le \\theta_c\n        $$\n\n    *   **Hysteresis Two-Threshold Policy**: This policy introduces memory into the decision process. It uses two thresholds, a refine threshold $\\theta_r$ and a coarsen threshold $\\theta_c$ (where $\\theta_c \\le \\theta_r$), and a memory time $\\tau_{\\mathrm{mem}}$. For each cell $i$, a variable $t^{\\mathrm{last}}_{\\mathrm{high}}(i)$ stores the most recent time the gradient was high.\n        At each time $t_j$, the memory is updated: if $G(x_i, t_j) \\ge \\theta_r$, then $t^{\\mathrm{last}}_{\\mathrm{high}}(i)$ is set to $t_j$.\n        The condition to coarsen cell $i$ at time $t_j$ requires two criteria to be met simultaneously: the gradient must be low, and a sufficient amount of time must have passed since the gradient was last high.\n        Condition to coarsen cell $i$ at time $t_j$:\n        $$\n        G(x_i, t_j) \\le \\theta_c \\quad \\text{and} \\quad t_j - t^{\\mathrm{last}}_{\\mathrm{high}}(i) \\ge \\tau_{\\mathrm{mem}}\n        $$\n    The initial value for all $t^{\\mathrm{last}}_{\\mathrm{high}}(i)$ is set to $-\\infty$ to ensure that the memory condition is not trivially met at early times before any high-gradient events occur.\n\n4.  **Quantification of Premature Coarsening**:\n    To evaluate the quality of the coarsening decisions, a lookahead mechanism is defined. A coarsening decision for cell $i$ at time $t_j$ is deemed \"premature\" if the gradient in that same cell is destined to rise above the refinement threshold $\\theta_r$ within a future time window of duration $T_{\\mathrm{future}}$.\n    Specifically, if a policy decides to coarsen cell $i$ at time $t_j$, we check if there exists any future time $t$ in the interval $(t_j, t_j + T_{\\mathrm{future}}]$ such that $G(x_i, t) \\ge \\theta_r$. In the discretized simulation, this corresponds to checking if $\\mathbf{G}_{ki} \\ge \\theta_r$ for any time index $k$ such that $j < k \\le j + \\text{round}(T_{\\mathrm{future}}/\\Delta t)$. If this condition is met, a premature coarsening event is counted for that policy. The total counts over all cells and time steps are accumulated into $E_{\\mathrm{naive}}$ and $E_{\\mathrm{hyst}}$.\n\n5.  **Performance Improvement Metric**:\n    The effectiveness of the hysteresis policy compared to the naive one is quantified by the improvement fraction, $\\Phi$:\n    $$\n    \\Phi = \\frac{E_{\\mathrm{naive}} - E_{\\mathrm{hyst}}}{\\max(1, E_{\\mathrm{naive}})}\n    $$\n    This metric measures the fractional reduction in premature coarsening events achieved by using the hysteresis policy. The denominator $\\max(1, E_{\\mathrmnaive})$ prevents division by zero and provides a meaningful value of $\\Phi=0$ if $E_{\\mathrm{naive}} = E_{\\mathrm{hyst}} = 0$.\n\nThe overall algorithm proceeds by first pre-computing the entire $\\dot{q}(x,t)$ and $G(x,t)$ fields. Then, it iterates through all grid points $(x_i, t_j)$ to apply both policies, check the lookahead condition for any coarsening decision, and increment the respective error counters $E_{\\mathrm{naive}}$ and $E_{\\mathrm{hyst}}$. Finally, $\\Phi$ is computed for each test case. This approach is implemented for the three specified test cases to produce the final results.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation for all test cases and print results.\n    \"\"\"\n\n    test_cases = [\n        # Test Case 1: Quenched flame with a single reignition pulse\n        {\n            \"L\": 0.02, \"x0\": 0.01, \"sigma_x\": 0.001, \"dx\": 0.0001,\n            \"T_end\": 0.20, \"dt\": 0.002,\n            \"A0\": 8.0e7, \"tau_d\": 0.05,\n            \"pulses\": [(1.2e8, 0.12, 0.01)],  # (B, t_k, sigma_t_k)\n            \"theta_r\": 2.5e10, \"theta_c\": 1.2e10, \"tau_mem\": 0.02,\n            \"T_future\": 0.02\n        },\n        # Test Case 2: Monotonic decay, no reignition\n        {\n            \"L\": 0.02, \"x0\": 0.01, \"sigma_x\": 0.001, \"dx\": 0.0001,\n            \"T_end\": 0.20, \"dt\": 0.002,\n            \"A0\": 8.0e7, \"tau_d\": 0.05,\n            \"pulses\": [],\n            \"theta_r\": 2.5e10, \"theta_c\": 1.2e10, \"tau_mem\": 0.02,\n            \"T_future\": 0.02\n        },\n        # Test Case 3: Intermittent pulses causing potential thrashing\n        {\n            \"L\": 0.02, \"x0\": 0.01, \"sigma_x\": 0.001, \"dx\": 0.0001,\n            \"T_end\": 0.20, \"dt\": 0.002,\n            \"A0\": 5.0e7, \"tau_d\": 0.10,\n            \"pulses\": [(9.0e7, 0.05, 0.005), (9.0e7, 0.07, 0.005), (9.0e7, 0.09, 0.005)],\n            \"theta_r\": 2.0e10, \"theta_c\": 1.0e10, \"tau_mem\": 0.03,\n            \"T_future\": 0.02\n        }\n    ]\n\n    all_results = []\n    for params in test_cases:\n        result = run_simulation(params)\n        all_results.extend(result)\n\n    # Format the final output string\n    formatted_results = []\n    for i in range(0, len(all_results), 3):\n        e_naive, e_hyst, phi = all_results[i], all_results[i+1], all_results[i+2]\n        formatted_results.append(f\"{e_naive},{e_hyst},{phi}\")\n    \n    # This ensures trailing decimals are represented correctly (e.g., 0.0 -> 0.0)\n    # The requirement is for integers and decimals. str() handles this correctly.\n    final_string = \",\".join(map(str, all_results))\n        \n    print(f\"[{final_string}]\")\n\ndef run_simulation(params):\n    \"\"\"\n    Runs the simulation for a single test case.\n    \"\"\"\n    # Unpack parameters\n    L, x0, sigma_x, dx = params[\"L\"], params[\"x0\"], params[\"sigma_x\"], params[\"dx\"]\n    T_end, dt = params[\"T_end\"], params[\"dt\"]\n    A0, tau_d = params[\"A0\"], params[\"tau_d\"]\n    pulses = params[\"pulses\"]\n    theta_r, theta_c = params[\"theta_r\"], params[\"theta_c\"]\n    tau_mem, T_future = params[\"tau_mem\"], params[\"T_future\"]\n\n    # 1. Discretize domain\n    # Use np.round to avoid float precision issues in determining grid size\n    Nx = int(np.round(L / dx)) + 1\n    Nt = int(np.round(T_end / dt)) + 1\n    x_grid = np.linspace(0, L, Nx)\n    t_grid = np.linspace(0, T_end, Nt)\n\n    # 2. Construct heat-release rate field q(x,t)\n    # Spatial component S(x), shape (Nx,)\n    S_x = np.exp(-((x_grid - x0)**2) / (2 * sigma_x**2))\n\n    # Temporal component A(t), shape (Nt,)\n    A_t = A0 * np.exp(-t_grid / tau_d)\n    for B, t_k, sigma_t_k in pulses:\n        A_t += B * np.exp(-((t_grid - t_k)**2) / (2 * sigma_t_k**2))\n    \n    # Combine using broadcasting to get q_matrix (Nt, Nx)\n    q_matrix = A_t[:, np.newaxis] * S_x[np.newaxis, :]\n\n    # 3. Compute gradient field G(x,t)\n    # Use second-order accurate differences at edges to match problem description\n    G_matrix = np.abs(np.gradient(q_matrix, dx, axis=1, edge_order=2))\n\n    # 4. Apply policies and count premature coarsening\n    E_naive = 0\n    E_hyst = 0\n    t_last_high = np.full(Nx, -np.inf)\n    \n    lookahead_steps = int(np.round(T_future / dt))\n\n    for j in range(Nt):\n        for i in range(Nx):\n            G_ij = G_matrix[j, i]\n            \n            # Check for future spike for premature coarsen evaluation\n            j_start_lookahead = j + 1\n            j_end_lookahead = min(Nt, j + 1 + lookahead_steps)\n            has_future_spike = False\n            if j_start_lookahead < j_end_lookahead:\n                future_gradients = G_matrix[j_start_lookahead:j_end_lookahead, i]\n                if np.any(future_gradients >= theta_r):\n                    has_future_spike = True\n\n            # Naive policy\n            if G_ij <= theta_c:\n                if has_future_spike:\n                    E_naive += 1\n\n            # Hysteresis policy\n            # Update memory\n            if G_ij >= theta_r:\n                t_last_high[i] = t_grid[j]\n            \n            # Check coarsening condition\n            if G_ij <= theta_c and (t_grid[j] - t_last_high[i] >= tau_mem):\n                if has_future_spike:\n                    E_hyst += 1\n\n    # 5. Calculate improvement fraction\n    if E_naive > 0:\n        phi = (E_naive - E_hyst) / E_naive\n    else: # Handles E_naive = 0 case, per problem spec max(1, E_naive)\n        phi = (E_naive - E_hyst) / 1.0\n    \n    return E_naive, E_hyst, phi\n\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}