{"hands_on_practices": [{"introduction": "The Incidence Function Model, pioneered by Ilkka Hanski, is a cornerstone of the patch dynamics paradigm, providing a powerful framework for understanding how colonization-extinction dynamics determine species persistence in fragmented landscapes. This exercise [@problem_id:2507834] challenges you to derive the non-trivial equilibrium occupancy for a metacommunity from the model's core equations, offering a foundational look at the mathematical basis of metapopulation viability. By working through the simplifying assumptions, you will gain insight into the key parameters that govern whether a species can persist across a network of patches.", "problem": "A single-species occupancy metacommunity is represented by an array of habitat patches indexed by $i \\in \\{1,2,\\dots,N\\}$. Let $p_i(t)$ denote the probability that patch $i$ is occupied at time $t$. Hanski’s incidence function model posits that occupancy dynamics are governed by the colonization–extinction balance\n$$\n\\frac{d p_i}{d t} \\;=\\; c_i \\,\\bigl(1 - p_i\\bigr) \\;-\\; e_i \\, p_i,\n$$\nwhere $c_i$ is the colonization rate into patch $i$ and $e_i$ is the local extinction rate in patch $i$. Assume that dispersal from occupied patches drives colonization according to\n$$\nc_i \\;=\\; m \\sum_{j=1}^{N} p_j \\, K_{ij},\n$$\nwhere $m$ is a per-connection colonization parameter and $K_{ij}$ is a nonnegative connectivity kernel with $K_{ii}=0$ indicating no self-colonization. Assume further that extinction declines with patch area as\n$$\ne_i \\;=\\; e_0 \\, A_i^{-\\gamma},\n$$\nwhere $e_0 \\!\\! 0$ and $\\gamma \\!\\! 0$ are constants and $A_i$ is the area of patch $i$.\n\nUnder the simplifying assumptions that:\n- all patches have identical area $A_i \\equiv A$,\n- the metacommunity is exchangeable at equilibrium so that $p_i \\equiv p$ for all $i$,\n- connectivity is spatially homogeneous with $K_{ij} \\equiv K$ for $i \\neq j$ and $K_{ii}=0$,\n\nderive from first principles the nontrivial steady-state occupancy $p^{\\ast}$ implied by the model. Then, using the parameter values $N = 50$, $m = 0.5 \\text{ yr}^{-1}$, $K = 0.1$ (dimensionless), $e_0 = 0.3 \\text{ yr}^{-1}$, $\\gamma = 0.25$, and $A = 100 \\text{ ha}$, compute the numerical value of $p^{\\ast}$. Express the final result as a unitless decimal and round your answer to four significant figures.", "solution": "The problem statement must first be rigorously validated.\n\n**Step 1: Extract Givens**\nThe provided information is as follows:\n- Metacommunity dynamics equation: $\\frac{d p_i}{d t} = c_i (1 - p_i) - e_i p_i$, where $p_i(t)$ is the occupancy probability of patch $i$ at time $t$.\n- Colonization rate: $c_i = m \\sum_{j=1}^{N} p_j K_{ij}$, where $m$ is a constant, $N$ is the number of patches, and $K_{ij}$ is the connectivity kernel.\n- Extinction rate: $e_i = e_0 A_i^{-\\gamma}$, where $e_0$ and $\\gamma$ are positive constants and $A_i$ is patch area.\n- Connectivity kernel property: $K_{ii}=0$.\n- Simplifying assumptions for deriving the steady-state occupancy:\n    1. Identical patch area: $A_i \\equiv A$ for all $i \\in \\{1, \\dots, N\\}$.\n    2. Exchangeable equilibrium: At steady state, $p_i \\equiv p$ for all $i$.\n    3. Homogeneous connectivity: $K_{ij} \\equiv K$ for $i \\neq j$.\n- Parameter values for numerical calculation:\n    - $N = 50$\n    - $m = 0.5 \\text{ yr}^{-1}$\n    - $K = 0.1$ (dimensionless)\n    - $e_0 = 0.3 \\text{ yr}^{-1}$\n    - $\\gamma = 0.25$\n    - $A = 100 \\text{ ha}$\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is subjected to validation against established criteria.\n- **Scientific Grounding:** The model is the well-known incidence function model developed by Ilkka Hanski, a foundational concept in metacommunity ecology. The functional forms for colonization and extinction are standard in the field. The problem is scientifically sound.\n- **Well-Posedness and Completeness:** The problem is well-posed. It provides a complete set of equations, simplifying assumptions, and parameter values required to derive a unique, nontrivial steady-state solution and then compute its numerical value. No essential information is missing, and there are no contradictions.\n- **Objectivity:** The problem is stated using precise mathematical language and is free of subjective or ambiguous terminology.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid**. It is a standard, tractable exercise in theoretical ecology. A solution will now be derived.\n\nWe begin with the governing differential equation for the occupancy probability of a single patch $i$:\n$$\n\\frac{d p_i}{d t} = c_i (1 - p_i) - e_i p_i\n$$\nThe problem requires finding the nontrivial steady-state occupancy, which we denote as $p^{\\ast}$. At steady state, $\\frac{d p_i}{d t} = 0$. Furthermore, the simplifying assumptions greatly reduce the complexity of the system.\n\nFirst, we simplify the extinction rate $e_i$. Given that all patches have identical area $A_i \\equiv A$, the extinction rate becomes uniform across all patches:\n$$\ne_i = e_0 A_i^{-\\gamma} \\equiv e_0 A^{-\\gamma} = e\n$$\n\nNext, we simplify the colonization rate $c_i$. The assumption of exchangeable equilibrium implies that at steady state, $p_i(t) \\equiv p$ for all patches $i$. The colonization rate for any patch $i$ is then:\n$$\nc_i = m \\sum_{j=1}^{N} p_j K_{ij}\n$$\nSubstituting $p_j = p$ for all $j$:\n$$\nc_i = m p \\sum_{j=1}^{N} K_{ij}\n$$\nThe sum is over the connectivity kernel elements. We are given that $K_{ij} = K$ for $i \\neq j$ and $K_{ii} = 0$. Therefore, the sum for any given patch $i$ consists of $N-1$ terms equal to $K$ and one term equal to $0$:\n$$\n\\sum_{j=1}^{N} K_{ij} = \\sum_{j \\neq i, j=1}^{N} K + K_{ii} = (N-1)K + 0 = (N-1)K\n$$\nThus, the colonization rate is also uniform across all patches, and it depends on the overall occupancy level $p$:\n$$\nc_i \\equiv c = m p (N-1)K\n$$\nNow we can write the steady-state equation for any patch by setting $\\frac{dp}{dt} = 0$ and dropping the subscript $i$:\n$$\n0 = c(1-p) - ep\n$$\nSubstituting the expressions for $c$ and $e$:\n$$\n0 = \\left[ m p (N-1)K \\right](1-p) - \\left[ e_0 A^{-\\gamma} \\right]p\n$$\nThis equation must be solved for the steady-state occupancy $p$. We can factor out a term $p$:\n$$\n0 = p \\left[ m(N-1)K(1-p) - e_0 A^{-\\gamma} \\right]\n$$\nThis equation yields two possible solutions for $p$.\n1. $p=0$: This is the trivial steady state, corresponding to the extinction of the species from the entire metacommunity.\n2. The term in the brackets is zero: This gives the nontrivial steady-state occupancy, $p^{\\ast}$.\n$$\nm(N-1)K(1-p^{\\ast}) - e_0 A^{-\\gamma} = 0\n$$\nWe solve this equation for $p^{\\ast}$:\n$$\nm(N-1)K(1-p^{\\ast}) = e_0 A^{-\\gamma}\n$$\n$$\n1-p^{\\ast} = \\frac{e_0 A^{-\\gamma}}{m(N-1)K}\n$$\n$$\np^{\\ast} = 1 - \\frac{e_0 A^{-\\gamma}}{m(N-1)K}\n$$\nThis is the analytical expression for the nontrivial steady-state occupancy. A biologically meaningful solution requires $0  p^{\\ast} \\le 1$, which imposes a condition on the parameters: $m(N-1)K  e_0 A^{-\\gamma}$.\n\nFinally, we compute the numerical value of $p^{\\ast}$ using the given parameter values:\n- $N = 50$\n- $m = 0.5$\n- $K = 0.1$\n- $e_0 = 0.3$\n- $\\gamma = 0.25$\n- $A = 100$\n\nFirst, calculate the denominator of the fraction:\n$$\nm(N-1)K = (0.5)(50-1)(0.1) = (0.5)(49)(0.1) = 2.45\n$$\nNext, calculate the numerator:\n$$\ne_0 A^{-\\gamma} = (0.3)(100)^{-0.25} = (0.3)(100)^{-1/4}\n$$\nSince $100 = 10^2$, we have $(10^2)^{-1/4} = 10^{-2/4} = 10^{-1/2} = \\frac{1}{\\sqrt{10}}$.\nSo, the numerator is $\\frac{0.3}{\\sqrt{10}}$.\n\nNow, substitute these back into the expression for $p^{\\ast}$:\n$$\np^{\\ast} = 1 - \\frac{0.3/\\sqrt{10}}{2.45} = 1 - \\frac{0.3}{2.45\\sqrt{10}}\n$$\nNumerically evaluating this expression:\n$$\np^{\\ast} \\approx 1 - \\frac{0.3}{2.45 \\times 3.16227766} \\approx 1 - \\frac{0.3}{7.747579...}\n$$\n$$\np^{\\ast} \\approx 1 - 0.0387217... \\approx 0.961278...\n$$\nRounding the result to four significant figures, as requested, gives $0.9613$.", "answer": "$$\\boxed{0.9613}$$", "id": "2507834"}, {"introduction": "The synchrony of population fluctuations across a landscape is a critical emergent property of metacommunities, with implications for regional extinction risk. Understanding the interplay between dispersal, which couples local dynamics, and correlated environmental forcing (the Moran effect) is key to explaining these patterns. This practice [@problem_id:2507918] delves into the mechanics of synchrony using a linearized two-patch model, allowing you to analytically prove how dispersal enhances synchrony and how this effect is modulated by the spatial correlation of environmental noise.", "problem": "In a metacommunity consisting of two habitat patches, let $X_{1}(t)$ and $X_{2}(t)$ denote small deviations of a focal species’ biomass from a stable equilibrium in each patch. Assume the dynamics are obtained by linearizing density regulation and symmetric dispersal about the equilibrium, and that each patch experiences environmental forcing modeled as zero-mean Gaussian white noise. The resulting linear stochastic system is\n$$\n\\frac{d}{dt}\\begin{pmatrix}X_{1}\\\\ X_{2}\\end{pmatrix}\n=\n\\begin{pmatrix}\n-(\\alpha+m)  m\\\\\nm  -(\\alpha+m)\n\\end{pmatrix}\n\\begin{pmatrix}X_{1}\\\\ X_{2}\\end{pmatrix}\n+\n\\begin{pmatrix}\\xi_{1}(t)\\\\ \\xi_{2}(t)\\end{pmatrix},\n$$\nwhere $\\alpha0$ is the local negative feedback (return rate) and $m\\ge 0$ is the symmetric dispersal rate. The environmental noise $\\xi_{i}(t)$ has covariance\n$$\n\\mathbb{E}[\\xi_{i}(t)\\,\\xi_{j}(t')]\n=\n2\\sigma^{2}\\,M_{ij}\\,\\delta(t-t'),\n\\quad\nM=\n\\begin{pmatrix}\n1  \\rho\\\\\n\\rho  1\n\\end{pmatrix},\n$$\nwith $-1\\le \\rho \\le 1$ encoding spatial correlation in environmental fluctuations and $\\sigma0$ a noise intensity.\n\nDefine synchrony as the lag-zero Pearson correlation between $X_{1}$ and $X_{2}$ at stationarity. Starting from core principles of linearization near a stable equilibrium and properties of multivariate Ornstein–Uhlenbeck processes, derive the stationary Pearson correlation between $X_{1}$ and $X_{2}$ as a function of $\\alpha$, $m$, $\\sigma$, and $\\rho$. Then, using your expression, justify analytically why increasing dispersal $m$ increases synchrony when $-1\\rho1$, and why decreasing $\\rho$ (more asynchronous environmental noise) counteracts synchrony.\n\nExpress the final Pearson correlation as a single simplified analytical expression. No rounding is required, and no physical units should be included in the final expression.", "solution": "The problem as stated is valid. It is a scientifically grounded, well-posed, and objective problem in theoretical ecology that is free from inconsistencies, ambiguities, or logical flaws. The system describes a multivariate Ornstein-Uhlenbeck process, a standard model for stochastic dynamics around a stable equilibrium. We will proceed with a full derivation.\n\nThe system is described by the linear stochastic differential equation:\n$$\nd\\mathbf{X} = A\\mathbf{X}dt + d\\mathbf{W}\n$$\nwhere the state vector is $\\mathbf{X}(t) = \\begin{pmatrix} X_{1}(t) \\\\ X_{2}(t) \\end{pmatrix}$, the drift matrix is\n$$\nA = \\begin{pmatrix} -(\\alpha+m)  m \\\\ m  -(\\alpha+m) \\end{pmatrix}\n$$\nand $d\\mathbf{W}$ represents the increments of a Wiener process related to the environmental noise $\\boldsymbol{\\xi}(t) = \\begin{pmatrix} \\xi_{1}(t) \\\\ \\xi_{2}(t) \\end{pmatrix}$. The covariance of the noise is given as $\\mathbb{E}[\\boldsymbol{\\xi}(t)\\boldsymbol{\\xi}(t')^T] = 2D\\delta(t-t')$, where $\\delta(t-t')$ is the Dirac delta function and $D$ is the diffusion matrix. From the problem statement, we have:\n$$\n2D = 2\\sigma^2 M = 2\\sigma^2 \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}\n$$\nThus, the diffusion matrix is $D = \\sigma^2 \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}$.\n\nThe system is stable because the eigenvalues of $A$ are $\\lambda_1 = -\\alpha$ and $\\lambda_2 = -(\\alpha+2m)$. Given $\\alpha  0$ and $m \\ge 0$, these eigenvalues are strictly negative, ensuring that the system returns to the equilibrium at $\\mathbf{X}=0$ and possesses a stationary probability distribution.\n\nThe stationary covariance matrix, $C = \\mathbb{E}[\\mathbf{X}\\mathbf{X}^T]$, is determined by the continuous-time algebraic Lyapunov equation:\n$$\nAC + CA^T + 2D = 0\n$$\nThe drift matrix $A$ is symmetric, i.e., $A=A^T$. The Lyapunov equation simplifies to $AC + CA + 2D = 0$. Furthermore, the matrix $A$ can be written as $A = -(\\alpha+m)I + mJ$ and the matrix $D$ as $D = \\sigma^2(I+\\rho J)$, where $I$ is the $2 \\times 2$ identity matrix and $J = \\begin{pmatrix} 0  1 \\\\ 1  0 \\end{pmatrix}$. Since $A$ and $D$ are both polynomials in the matrix $J$, they commute, i.e., $AD=DA$. This implies that $A$ and $C$ also commute, because $C$ is a function of $A$ and $D$. Therefore, $AC=CA$, and the Lyapunov equation reduces to:\n$$\n2AC + 2D = 0 \\implies AC = -D\n$$\nTo find $C$, we must compute the inverse of $A$. The determinant of $A$ is:\n$$\n\\det(A) = (-(\\alpha+m))^2 - m^2 = (\\alpha+m)^2 - m^2 = \\alpha^2 + 2\\alpha m = \\alpha(\\alpha+2m)\n$$\nSince $\\alpha0$ and $m \\ge 0$, $\\det(A)0$, so $A$ is invertible.\n$$\nA^{-1} = \\frac{1}{\\alpha(\\alpha+2m)} \\begin{pmatrix} -(\\alpha+m)  -m \\\\ -m  -(\\alpha+m) \\end{pmatrix}\n$$\nNow we can solve for the covariance matrix $C$:\n$$\nC = -A^{-1}D = -\\frac{1}{\\alpha(\\alpha+2m)} \\begin{pmatrix} -(\\alpha+m)  -m \\\\ -m  -(\\alpha+m) \\end{pmatrix} \\left(\\sigma^2 \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}\\right)\n$$\n$$\nC = \\frac{\\sigma^2}{\\alpha(\\alpha+2m)} \\begin{pmatrix} \\alpha+m  m \\\\ m  \\alpha+m \\end{pmatrix} \\begin{pmatrix} 1  \\rho \\\\ \\rho  1 \\end{pmatrix}\n$$\n$$\nC = \\frac{\\sigma^2}{\\alpha(\\alpha+2m)} \\begin{pmatrix} (\\alpha+m) + m\\rho  \\rho(\\alpha+m) + m \\\\ m + \\rho(\\alpha+m)  m\\rho + (\\alpha+m) \\end{pmatrix} = \\begin{pmatrix} C_{11}  C_{12} \\\\ C_{21}  C_{22} \\end{pmatrix}\n$$\nThe components of the covariance matrix are the stationary variances and covariance:\n$C_{11} = C_{22} = \\mathbb{E}[X_1^2] = \\mathbb{E}[X_2^2] = \\frac{\\sigma^2(\\alpha+m+m\\rho)}{\\alpha(\\alpha+2m)}$\n$C_{12} = C_{21} = \\mathbb{E}[X_1 X_2] = \\frac{\\sigma^2(m+m\\rho+\\alpha\\rho)}{\\alpha(\\alpha+2m)}$\n\nThe synchrony is defined as the Pearson correlation coefficient between $X_1$ and $X_2$ at stationarity, which we denote by $\\mathcal{S}$:\n$$\n\\mathcal{S} = \\frac{\\mathbb{E}[X_1 X_2]}{\\sqrt{\\mathbb{E}[X_1^2]\\mathbb{E}[X_2^2]}} = \\frac{C_{12}}{C_{11}}\n$$\nSubstituting the expressions for $C_{11}$ and $C_{12}$:\n$$\n\\mathcal{S} = \\frac{\\frac{\\sigma^2(m(1+\\rho)+\\alpha\\rho)}{\\alpha(\\alpha+2m)}}{\\frac{\\sigma^2(\\alpha+m(1+\\rho))}{\\alpha(\\alpha+2m)}} = \\frac{m(1+\\rho)+\\alpha\\rho}{\\alpha+m(1+\\rho)}\n$$\nThis is the required analytical expression for synchrony.\n\nNow, we must justify why increasing dispersal $m$ increases synchrony for $-1  \\rho  1$. We analyze the derivative of $\\mathcal{S}$ with respect to $m$:\n$$\n\\frac{\\partial \\mathcal{S}}{\\partial m} = \\frac{\\partial}{\\partial m} \\left( \\frac{m(1+\\rho)+\\alpha\\rho}{\\alpha+m(1+\\rho)} \\right)\n$$\nUsing the quotient rule for derivatives, $\\frac{d}{dx}(\\frac{u}{v}) = \\frac{u'v-uv'}{v^2}$:\n$$\n\\frac{\\partial \\mathcal{S}}{\\partial m} = \\frac{(1+\\rho)(\\alpha+m(1+\\rho)) - (m(1+\\rho)+\\alpha\\rho)(1+\\rho)}{(\\alpha+m(1+\\rho))^2}\n$$\n$$\n\\frac{\\partial \\mathcal{S}}{\\partial m} = \\frac{(1+\\rho)[\\alpha+m(1+\\rho) - m(1+\\rho) - \\alpha\\rho]}{(\\alpha+m(1+\\rho))^2} = \\frac{(1+\\rho)(\\alpha-\\alpha\\rho)}{(\\alpha+m(1+\\rho))^2} = \\frac{\\alpha(1-\\rho^2)}{(\\alpha+m(1+\\rho))^2}\n$$\nThe denominator $(\\alpha+m(1+\\rho))^2$ is strictly positive since $\\alpha  0$, $m \\ge 0$, and $\\rho \\ge -1$. The parameter $\\alpha$ is given as positive. For the specified range $-1  \\rho  1$, the term $1-\\rho^2$ is strictly positive. Therefore, $\\frac{\\partial \\mathcal{S}}{\\partial m}  0$ for $-1  \\rho  1$, which proves that increasing dispersal $m$ increases synchrony.\n\nFinally, we must justify why decreasing $\\rho$ counteracts synchrony. This is equivalent to showing that synchrony $\\mathcal{S}$ is an increasing function of $\\rho$. We analyze the derivative of $\\mathcal{S}$ with respect to $\\rho$:\n$$\n\\mathcal{S} = \\frac{m+\\rho(m+\\alpha)}{\\alpha+m+m\\rho}\n$$\n$$\n\\frac{\\partial \\mathcal{S}}{\\partial \\rho} = \\frac{(m+\\alpha)(\\alpha+m+m\\rho) - (m+\\rho(m+\\alpha))(m)}{(\\alpha+m+m\\rho)^2}\n$$\nExpanding the numerator:\nNumerator $= (m+\\alpha)(\\alpha+m) + m\\rho(m+\\alpha) - m^2 - m\\rho(m+\\alpha)$\n$= (m+\\alpha)^2 - m^2 = m^2+2m\\alpha+\\alpha^2 - m^2 = 2m\\alpha+\\alpha^2 = \\alpha(\\alpha+2m)$\nSo the derivative is:\n$$\n\\frac{\\partial \\mathcal{S}}{\\partial \\rho} = \\frac{\\alpha(\\alpha+2m)}{(\\alpha+m(1+\\rho))^2}\n$$\nGiven the constraints $\\alpha  0$ and $m \\ge 0$, the numerator $\\alpha(\\alpha+2m)$ is strictly positive. The denominator $(\\alpha+m(1+\\rho))^2$ is also strictly positive. Thus, $\\frac{\\partial \\mathcal{S}}{\\partial \\rho}  0$ for all valid parameter values. This means synchrony $\\mathcal{S}$ is a strictly increasing function of the environmental correlation $\\rho$. Consequently, decreasing $\\rho$ leads to a decrease in synchrony, thereby counteracting it.", "answer": "$$\n\\boxed{\\frac{m(1+\\rho) + \\alpha\\rho}{\\alpha + m(1+\\rho)}}\n$$", "id": "2507918"}, {"introduction": "A central challenge in community ecology is to disentangle the multiple processes—such as environmental filtering (species sorting), dispersal limitation, and biotic interactions—that jointly shape species co-occurrence patterns. Modern statistical methods, like Joint Species Distribution Models (JSDMs), provide a pathway to infer these processes from observational data. In this applied exercise [@problem_id:2507906], you will implement a computational workflow that mimics the logic of a JSDM, gaining hands-on experience in the critical task of inferring putative species interactions from complex ecological datasets by parsing the effects of environment, space, and residual correlations.", "problem": "You are given metacommunity presence–absence data across spatially referenced sites together with environmental covariates. From first principles of joint modeling in community ecology, assume conditional independence of species occurrences given environmental covariates and a spatial trend, and use a generalized linear model basis with a logit link to estimate environmental responses per species. After removing environmental effects, perform a spatial correction via polynomial detrending of coordinates, and then infer putative biotic interaction pairs as significant positive or negative residual correlations after this spatial correction. Your task is to implement this workflow in a program that applies to the provided test suite and returns, for each case, the list of species index pairs that are significant after multiple-testing correction.\n\nBase principles and definitions to use:\n- Species occurrence at site $i$ for species $s$ is a Bernoulli outcome with probability $p_{i,s}$ conditional on observed environmental covariates $x_i$.\n- For each species $s$, model $p_{i,s}$ via a generalized linear model with logit link using an intercept and the observed covariates: the linear predictor is $\\eta_{i,s} = \\beta_{0,s} + \\sum_{k} \\beta_{k,s} x_{i,k}$ and $p_{i,s} = \\mathrm{logit}^{-1}(\\eta_{i,s})$.\n- Fit each species model by maximizing the penalized log-likelihood with ridge (L2) penalty $\\lambda$ applied to non-intercept coefficients, using any correct iterative method that converges to the maximum (for example, Iteratively Reweighted Least Squares).\n- After fitting, compute Pearson residuals per species at each site, detrend these residuals by regressing them on a spatial polynomial basis consisting of coordinate terms up to total degree $2$, and subtracting the fitted spatial component. Then, compute the Pearson correlation across sites between every pair of species from these spatially filtered residuals. For each correlation, compute a two-sided $p$-value under the null of zero correlation using the Student $t$ distribution with the appropriate degrees of freedom given the number of sites.\n- Control the False Discovery Rate using the Benjamini–Hochberg procedure at a specified level $\\alpha$ across all pairwise tests within a case, and return the set of pairs called significant by this procedure.\n\nImplementation requirements to ensure universal applicability:\n- Use a penalization weight $\\lambda = 1$ on non-intercept coefficients only.\n- For the spatial correction, use predictors $[1, u, v, u^2, v^2, uv]$, where $(u,v)$ are the planar coordinates of each site, fit by ordinary least squares to the per-species residual vector, and subtract the fitted values to obtain spatially filtered residuals.\n- Use a two-sided test for Pearson correlation: compute the test statistic $t = r \\sqrt{\\frac{n-2}{1-r^2}}$ for correlation coefficient $r$ with $n$ sites, and obtain the $p$-value from the Student $t$ distribution with $n-2$ degrees of freedom. Handle degenerate cases by returning a $p$-value of $1$ if either residual vector is constant across sites.\n- Apply the Benjamini–Hochberg False Discovery Rate control at level $\\alpha = 0.05$ across all pairwise tests (both positive and negative correlations considered).\n- Index species from $0$ to $S-1$ in the output, and only report pairs with $ij$.\n\nTest suite:\n- Case $1$ (grid of $n=12$ sites, $S=4$ species):\n  - Coordinates (ordered by rows of a $4 \\times 3$ grid with $x$ increasing across columns and $y$ increasing across rows): $[(0,0),(1,0),(2,0),(3,0),(0,1),(1,1),(2,1),(3,1),(0,2),(1,2),(2,2),(3,2)]$.\n  - Environmental covariates per site: two covariates $x_1 = x/3$ and $x_2 = y/2$, where $(x,y)$ are the above coordinates. Thus the design vector at site $i$ is $[1, x_i/3, y_i/2]$.\n  - Species presence–absence matrix $Y$ (rows in the same order as coordinates; columns are species $0,1,2,3$):\n    - Row $1$ $(0,0)$: $[0,0,0,0]$.\n    - Row $2$ $(1,0)$: $[0,1,0,1]$.\n    - Row $3$ $(2,0)$: $[1,1,0,0]$.\n    - Row $4$ $(3,0)$: $[1,1,1,1]$.\n    - Row $5$ $(0,1)$: $[1,1,0,0]$.\n    - Row $6$ $(1,1)$: $[1,1,1,0]$.\n    - Row $7$ $(2,1)$: $[1,1,1,1]$.\n    - Row $8$ $(3,1)$: $[1,1,1,0]$.\n    - Row $9$ $(0,2)$: $[0,1,1,1]$.\n    - Row $10$ $(1,2)$: $[1,1,1,0]$.\n    - Row $11$ $(2,2)$: $[1,1,1,1]$.\n    - Row $12$ $(3,2)$: $[1,1,1,0]$.\n- Case $2$ (same $n=12$ and coordinates, $S=4$ species, designed to be approximately conditionally independent given environment):\n  - Same coordinates as Case $1$.\n  - Same environmental covariates as Case $1$.\n  - Species presence–absence matrix $Y$:\n    - Row $1$ $(0,0)$: $[0,0,0,0]$.\n    - Row $2$ $(1,0)$: $[0,0,0,0]$.\n    - Row $3$ $(2,0)$: $[0,0,0,1]$.\n    - Row $4$ $(3,0)$: $[1,0,0,0]$.\n    - Row $5$ $(0,1)$: $[0,1,0,1]$.\n    - Row $6$ $(1,1)$: $[1,1,1,0]$.\n    - Row $7$ $(2,1)$: $[1,1,1,0]$.\n    - Row $8$ $(3,1)$: $[1,1,1,1]$.\n    - Row $9$ $(0,2)$: $[0,1,1,0]$.\n    - Row $10$ $(1,2)$: $[0,1,1,1]$.\n    - Row $11$ $(2,2)$: $[1,1,1,1]$.\n    - Row $12$ $(3,2)$: $[1,1,1,1]$.\n- Case $3$ (linear transect with $n=6$ sites, $S=3$ species):\n  - Coordinates: $[(0,0),(1,0),(2,0),(3,0),(4,0),(5,0)]$.\n  - Environmental covariates: $x_1 = x/5$, $x_2 = 0$ for all sites. Thus the design vector at site $i$ is $[1, x_i/5, 0]$.\n  - Species presence–absence matrix $Y$:\n    - Row $1$ $(0,0)$: $[0,0,0]$.\n    - Row $2$ $(1,0)$: $[0,1,0]$.\n    - Row $3$ $(2,0)$: $[1,0,0]$.\n    - Row $4$ $(3,0)$: $[1,1,0]$.\n    - Row $5$ $(4,0)$: $[1,0,1]$.\n    - Row $6$ $(5,0)$: $[1,1,1]$.\n\nProgram input and output:\n- There is no external input. Hard-code the above test suite inside your program.\n- For each case, fit the per-species penalized logistic regression using the specified design, compute Pearson residuals, spatially detrend them using the polynomial basis in coordinates, compute all pairwise Pearson correlations across species, test for significance using the two-sided Student $t$ distribution with $n-2$ degrees of freedom, apply the Benjamini–Hochberg procedure with $\\alpha = 0.05$ within the case, and record all species index pairs $(i,j)$ with $ij$ that are called significant.\n- Final output format: your program should produce a single line containing a JSON-like representation of a list of lists, where each inner list corresponds to one case in order and contains the significant species index pairs as tuples. For example, a possible output with results for three cases would be \"[(0,1)]\" per case and the complete line would be \"[[(0,1)],[(0,1)],[(0,1)]]\". Your program must print exactly one such line with no extra text.\n\nAngle units are not involved. No physical units are involved. All numeric outcomes (e.g., correlation coefficients or $p$-values) are internal and not printed directly; the printed output consists only of species index pairs as tuples.", "solution": "The problem statement is evaluated as scientifically grounded, well-posed, and objective. It provides a complete and consistent set of instructions for a standard, albeit simplified, procedure in computational community ecology. The outlined workflow, from fitting per-species generalized linear models to identifying significant residual correlations after spatial detrending, represents a valid approach to inferring putative species interactions from co-occurrence data. All required parameters, data, and mathematical definitions are provided, and no contradictions or ambiguities are present. Therefore, the problem is deemed valid, and a solution is provided forthwith.\n\nThe task is to implement a multi-step statistical workflow to identify significant pairwise species associations from presence-absence data, after accounting for environmental and spatial factors. This is a common objective in community ecology, often approached with Joint Species Distribution Models (JSDMs). The prescribed method is a simplified, two-stage approximation of such a model.\n\n**Step 1: Environmental Response Modeling via Penalized Logistic Regression**\n\nFor each species $s \\in \\{0, \\dots, S-1\\}$, its occurrence $y_{i,s} \\in \\{0, 1\\}$ at site $i \\in \\{1, \\dots, n\\}$ is modeled as a Bernoulli random variable. The probability of presence, $p_{i,s}$, is linked to a set of environmental covariates $x_{i,k}$ through a logistic regression model. The linear predictor is $\\eta_{i,s} = \\beta_{0,s} + \\sum_{k=1}^{K} \\beta_{k,s} x_{i,k}$, which can be written in vector form as $\\eta_s = X\\beta_s$, where $X$ is the design matrix including an intercept column. The link function is the logit, so $p_{i,s} = \\text{logit}^{-1}(\\eta_{i,s}) = \\frac{1}{1 + e^{-\\eta_{i,s}}}$.\n\nThe species-specific regression coefficients $\\beta_s$ are estimated by maximizing the L2-penalized log-likelihood. The log-likelihood for species $s$ is:\n$$ \\mathcal{L}(\\beta_s | y_s, X) = \\sum_{i=1}^{n} \\left( y_{i,s} \\eta_{i,s} - \\log(1 + e^{\\eta_{i,s}}) \\right) $$\nThe penalized objective function to be maximized is:\n$$ \\mathcal{J}(\\beta_s) = \\mathcal{L}(\\beta_s) - \\frac{\\lambda}{2} \\sum_{k=1}^{K} \\beta_{k,s}^2 $$\nNote that the intercept coefficient $\\beta_{0,s}$ is not penalized, as specified. The regularization parameter is given as $\\lambda = 1$. This optimization problem is convex and can be solved using various iterative methods. We will use Iteratively Reweighted Least Squares (IRLS), which is a standard and robust technique.\n\nIn each iteration of IRLS, we update the estimate for $\\beta_s$ by solving a penalized weighted least squares problem. Given the estimate $\\beta_s^{(t)}$ at iteration $t$, we compute the current fitted probabilities $p^{(t)}$, a diagonal weight matrix $W^{(t)}$ with entries $W_{ii}^{(t)} = p_i^{(t)}(1 - p_i^{(t)})$, and a working response vector $z^{(t)} = \\eta^{(t)} + (y_s - p^{(t)}) / W_{ii}^{(t)}$. The new estimate is then:\n$$ \\beta_s^{(t+1)} = (X^T W^{(t)} X + \\lambda \\mathbf{P})^{-1} X^T W^{(t)} z^{(t)} $$\nwhere $\\mathbf{P}$ is a diagonal matrix with a $0$ for the intercept and $1$ for all other coefficients. Iterations continue until the change in $\\beta_s$ is below a small tolerance.\n\n**Step 2: Pearson Residual Calculation**\n\nAfter fitting the model for each species, we compute residuals to represent the variation not explained by the environmental covariates. The Pearson residual for species $s$ at site $i$ is defined as:\n$$ r_{P, i,s} = \\frac{y_{i,s} - \\hat{p}_{i,s}}{\\sqrt{\\hat{p}_{i,s}(1 - \\hat{p}_{i,s})}} $$\nwhere $\\hat{p}_{i,s}$ is the estimated probability of presence from the fitted logistic model.\n\n**Step 3: Spatial Detrending of Residuals**\n\nTo account for spatial autocorrelation in the data that is not captured by the environmental model, we detrend the Pearson residuals. For each species $s$, the vector of residuals $r_{P,s}$ is regressed against a polynomial basis of the site coordinates $(u_i, v_i)$. The specified basis is $[1, u, v, u^2, v^2, uv]$. Let this spatial design matrix be $X_{spat}$. We fit a standard ordinary least squares (OLS) model:\n$$ r_{P,s} = X_{spat} \\gamma_s + \\epsilon_s $$\nThe coefficients are estimated as $\\hat{\\gamma}_s = (X_{spat}^T X_{spat})^{-1} X_{spat}^T r_{P,s}$. The spatially filtered residuals, $r'_s$, are the residuals from this spatial regression:\n$$ r'_{s} = r_{P,s} - X_{spat} \\hat{\\gamma}_s $$\nThese filtered residuals represent variation unexplained by either the measured environment or broad-scale spatial patterns.\n\n**Step 4 and 5: Inference of Interactions via Correlation Testing**\n\nThe central hypothesis is that any remaining statistically significant correlation between the filtered residuals of two species indicates a putative biotic interaction. For every pair of species $(j, k)$ with $j  k$, we compute the Pearson correlation coefficient, $r_{jk}$, between their spatially filtered residual vectors $r'_j$ and $r'_k$.\n\nTo test the significance of each correlation, we test the null hypothesis $H_0: \\rho_{jk} = 0$ against the two-sided alternative $H_1: \\rho_{jk} \\neq 0$. The test statistic is:\n$$ t_{jk} = r_{jk} \\sqrt{\\frac{n-2}{1-r_{jk}^2}} $$\nUnder the null hypothesis, this statistic follows a Student's $t$-distribution with $n-2$ degrees of freedom, where $n$ is the number of sites. The $p$-value is calculated as $2 \\times P(T_{n-2}  |t_{jk}|)$. If the residual vector for any species is constant (zero variance), its correlation with any other vector is undefined. In this degenerate case, the $p$-value is set to $1$, as specified.\n\nThe Benjamini-Hochberg (BH) procedure is applied to control the False Discovery Rate (FDR) at a level of $\\alpha = 0.05$.\n\nThe BH procedure is as follows:\n1. Collect all $m = S(S-1)/2$ p-values from the correlation tests.\n2. Sort the p-values in ascending order: $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(m)}$.\n3. Find the largest integer $k$ such that $p_{(k)} \\le \\frac{k}{m} \\alpha$.\n4. If such a $k$ exists, reject the null hypotheses for all tests corresponding to the p-values $p_{(1)}, \\dots, p_{(k)}$. Otherwise, reject no hypotheses.\n\nThe pairs of species corresponding to the rejected hypotheses are the final output, representing significant putative interactions.", "answer": "```python\nimport numpy as np\nfrom scipy.special import expit\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Main function to execute the full analysis pipeline for all test cases.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"coords\": np.array([(0,0),(1,0),(2,0),(3,0),(0,1),(1,1),(2,1),(3,1),(0,2),(1,2),(2,2),(3,2)]),\n            \"Y\": np.array([\n                [0,0,0,0], [0,1,0,1], [1,1,0,0], [1,1,1,1],\n                [1,1,0,0], [1,1,1,0], [1,1,1,1], [1,1,1,0],\n                [0,1,1,1], [1,1,1,0], [1,1,1,1], [1,1,1,0]\n            ]),\n            \"env_func\": lambda x, y: (x/3, y/2),\n        },\n        {\n            \"coords\": np.array([(0,0),(1,0),(2,0),(3,0),(0,1),(1,1),(2,1),(3,1),(0,2),(1,2),(2,2),(3,2)]),\n            \"Y\": np.array([\n                [0,0,0,0], [0,0,0,0], [0,0,0,1], [1,0,0,0],\n                [0,1,0,1], [1,1,1,0], [1,1,1,0], [1,1,1,1],\n                [0,1,1,0], [0,1,1,1], [1,1,1,1], [1,1,1,1]\n            ]),\n            \"env_func\": lambda x, y: (x/3, y/2),\n        },\n        {\n            \"coords\": np.array([(0,0),(1,0),(2,0),(3,0),(4,0),(5,0)]),\n            \"Y\": np.array([\n                [0,0,0], [0,1,0], [1,0,0], [1,1,0], [1,0,1], [1,1,1]\n            ]),\n            \"env_func\": lambda x, y: (x/5, 0.0),\n        }\n    ]\n\n    lambda_val = 1.0\n    alpha = 0.05\n    all_results = []\n\n    for case in test_cases:\n        coords = case[\"coords\"]\n        Y = case[\"Y\"]\n        env_func = case[\"env_func\"]\n        \n        n_sites, n_species = Y.shape\n\n        # 1. Prepare environmental design matrix X_env\n        env_cov = np.array([env_func(x, y) for x, y in coords])\n        X_env = np.c_[np.ones(n_sites), env_cov]\n\n        # 2. Fit GLMs and compute Pearson residuals\n        pearson_residuals = np.zeros_like(Y, dtype=float)\n        for s in range(n_species):\n            y_s = Y[:, s]\n            \n            # Fit penalized logistic regression using IRLS\n            beta = fit_penalized_glm(y_s, X_env, lambda_val)\n            \n            # Compute estimated probabilities and residuals\n            eta = X_env @ beta\n            p_hat = expit(eta)\n            \n            # Clamp p_hat to avoid division by zero in residuals\n            p_hat_clamped = np.clip(p_hat, 1e-8, 1 - 1e-8)\n            \n            pearson_residuals[:, s] = (y_s - p_hat) / np.sqrt(p_hat_clamped * (1 - p_hat_clamped))\n\n        # 3. Spatially detrend residuals\n        u, v = coords[:, 0], coords[:, 1]\n        X_spat = np.c_[np.ones(n_sites), u, v, u**2, v**2, u*v]\n        \n        filtered_residuals = np.zeros_like(pearson_residuals)\n        for s in range(n_species):\n            res_s = pearson_residuals[:, s]\n            # OLS for spatial trend\n            gamma, _, _, _ = np.linalg.lstsq(X_spat, res_s, rcond=None)\n            spatial_fit = X_spat @ gamma\n            filtered_residuals[:, s] = res_s - spatial_fit\n            \n        # 4 and 5. Test correlations and apply Benjamini-Hochberg\n        significant_pairs = test_correlations_bh(filtered_residuals, n_sites, n_species, alpha)\n        all_results.append(significant_pairs)\n\n    # Format and print the final output\n    case_strings = []\n    for case_result in all_results:\n        pair_strings = [f\"({i},{j})\" for i, j in sorted(case_result)]\n        case_strings.append(f\"[{','.join(pair_strings)}]\")\n    final_output = f\"[{','.join(case_strings)}]\"\n    print(final_output)\n\ndef fit_penalized_glm(y, X, lambda_val, max_iter=100, tol=1e-6):\n    \"\"\"\n    Fits a penalized logistic regression model using IRLS.\n    \"\"\"\n    n_sites, n_cov = X.shape\n    beta = np.zeros(n_cov)\n    \n    # Penalty matrix (0 for intercept, lambda for others)\n    P = np.diag([0] + [lambda_val] * (n_cov - 1))\n\n    for _ in range(max_iter):\n        eta = X @ beta\n        p = expit(eta)\n        \n        # Clamp probabilities to avoid numerical instability\n        p_clamped = np.clip(p, 1e-8, 1 - 1e-8)\n        \n        W_diag = p_clamped * (1 - p_clamped)\n        z = eta + (y - p) / p_clamped\n        \n        X_T_W = X.T * W_diag\n        \n        A = X_T_W @ X + P\n        b = X_T_W @ z\n        \n        try:\n            beta_new = np.linalg.solve(A, b)\n        except np.linalg.LinAlgError:\n            # Fallback to pseudo-inverse if solve fails\n            beta_new = np.linalg.pinv(A) @ b\n\n        if np.linalg.norm(beta_new - beta)  tol:\n            beta = beta_new\n            break\n        beta = beta_new\n        \n    return beta\n\ndef test_correlations_bh(residuals, n_sites, n_species, alpha):\n    \"\"\"\n    Computes pairwise correlations, p-values, and applies BH correction.\n    \"\"\"\n    pairs = []\n    p_values = []\n    \n    for j in range(n_species):\n        for k in range(j + 1, n_species):\n            res_j = residuals[:, j]\n            res_k = residuals[:, k]\n            \n            # Handle degenerate cases (constant residuals)\n            if np.std(res_j)  1e-9 or np.std(res_k)  1e-9:\n                p_val = 1.0\n            else:\n                r = np.corrcoef(res_j, res_k)[0, 1]\n                \n                # Handle perfect correlation (r = +/- 1)\n                if abs(abs(r) - 1.0)  1e-9:\n                    t_stat = np.inf\n                else:\n                    t_stat = r * np.sqrt((n_sites - 2) / (1 - r**2))\n                \n                p_val = 2 * t.sf(np.abs(t_stat), df=n_sites - 2)\n            \n            pairs.append((j, k))\n            p_values.append(p_val)\n            \n    if not p_values:\n        return []\n\n    # Benjamini-Hochberg procedure\n    m = len(p_values)\n    p_values = np.array(p_values)\n    \n    sorted_indices = np.argsort(p_values)\n    sorted_p_values = p_values[sorted_indices]\n    \n    ranks = np.arange(1, m + 1)\n    bh_critical_values = (ranks / m) * alpha\n    \n    significant_mask = sorted_p_values = bh_critical_values\n    \n    if not np.any(significant_mask):\n        return []\n        \n    k = np.where(significant_mask)[0][-1]\n    \n    significant_indices = sorted_indices[:k+1]\n    \n    return [pairs[i] for i in significant_indices]\n\nif __name__ == '__main__':\n    solve()\n```", "id": "2507906"}]}