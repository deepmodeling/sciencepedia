{"hands_on_practices": [{"introduction": "A central question in hematopoiesis is determining the frequency of rare hematopoietic stem cells (HSCs) within a larger population of bone marrow cells. The limiting dilution assay (LDA) is a foundational experimental design to address this. This practice will guide you through the statistical machinery behind LDA, using the Poisson model for rare events and the principle of maximum likelihood estimation to derive the HSC frequency and its confidence interval from hypothetical experimental data, building a core competency in quantitative biological analysis. [@problem_id:2852659]", "problem": "A hematopoietic stem cell transplantation laboratory performs a limiting dilution experiment to estimate the frequency of Long-Term Hematopoietic Stem Cells (LT-HSCs). Under the single-hit model, a recipient engrafts if and only if it receives at least one LT-HSC. Assume that LT-HSCs are rare and independently distributed among donor cells so that the number of LT-HSCs in an inoculum of size $c$ follows a Poisson distribution with mean $\\lambda c$, where $\\lambda$ is the LT-HSC frequency in units of $\\text{cells}^{-1}$. Hence, for a given dose $c$, the probability of no engraftment in a recipient is $\\exp(-\\lambda c)$.\n\nIn one experiment, recipients were transplanted at four distinct donor cell doses with $n_i = 10$ mice per dose. The doses and the corresponding numbers of non-engrafted recipients ($x_i$) were:\n- $c_1 = 2.231435513 \\times 10^{4}$ with $x_1 = 8$,\n- $c_2 = 5.108256238 \\times 10^{4}$ with $x_2 = 6$,\n- $c_3 = 9.162907319 \\times 10^{4}$ with $x_3 = 4$,\n- $c_4 = 1.609437912 \\times 10^{5}$ with $x_4 = 2$.\n\nStarting from the independence assumption and the Poisson law for rare events, and treating each dose group as independent Bernoulli trials with dose-specific probability of no engraftment $\\exp(-\\lambda c_i)$, derive the maximum likelihood estimate for $\\lambda$ by writing and maximizing the joint log-likelihood across doses. Then, using the observed Fisher information (the negative second derivative of the log-likelihood evaluated at the maximum likelihood estimate), construct an approximate $95\\%$ confidence interval for $\\lambda$ via a Wald approximation.\n\nReport the final results as three quantities in the order: the point estimate $\\hat{\\lambda}$, the lower confidence bound, and the upper confidence bound. Express all three answers in units of $\\text{cells}^{-1}$ and round each to four significant figures. Provide no intermediate values in the final answer.", "solution": "The problem requires the estimation of the hematopoietic stem cell frequency, $\\lambda$, using a maximum likelihood approach, and the construction of a confidence interval for this estimate.\n\nFirst, the likelihood function for the observed data must be constructed. For each dose group $i$, where $i \\in \\{1, 2, 3, 4\\}$, we have $n_i$ recipients. Each recipient represents an independent Bernoulli trial. The outcome is binary: either engraftment occurs or it does not. We are given that the number of non-engrafted recipients is $x_i$ out of $n_i$. The probability of no engraftment for a given dose $c_i$ is given by the single-hit Poisson model as $p_i = \\exp(-\\lambda c_i)$. Consequently, the probability of engraftment is $1 - p_i = 1 - \\exp(-\\lambda c_i)$.\n\nThe number of non-engrafted mice $x_i$ in a group of $n_i$ mice follows a binomial distribution with probability mass function:\n$$ L_i(\\lambda) = \\binom{n_i}{x_i} p_i^{x_i} (1-p_i)^{n_i-x_i} = \\binom{n_i}{x_i} [\\exp(-\\lambda c_i)]^{x_i} [1 - \\exp(-\\lambda c_i)]^{n_i-x_i} $$\nSince the four dose groups are independent, the total likelihood function $L(\\lambda)$ is the product of the individual likelihoods:\n$$ L(\\lambda) = \\prod_{i=1}^{4} L_i(\\lambda) = \\prod_{i=1}^{4} \\binom{n_i}{x_i} \\exp(-\\lambda c_i x_i) [1 - \\exp(-\\lambda c_i)]^{n_i-x_i} $$\nTo find the maximum likelihood estimate (MLE) of $\\lambda$, it is more convenient to maximize the log-likelihood function, $\\ell(\\lambda) = \\ln(L(\\lambda))$:\n$$ \\ell(\\lambda) = \\sum_{i=1}^{4} \\left[ \\ln\\binom{n_i}{x_i} - \\lambda c_i x_i + (n_i - x_i) \\ln(1 - \\exp(-\\lambda c_i)) \\right] $$\nThe MLE, $\\hat{\\lambda}$, is found by setting the first derivative of the log-likelihood with respect to $\\lambda$ (the score function) to zero.\n$$ \\frac{d\\ell}{d\\lambda} = \\sum_{i=1}^{4} \\left[ -c_i x_i + (n_i - x_i) \\frac{d}{d\\lambda}\\ln(1 - \\exp(-\\lambda c_i)) \\right] $$\n$$ \\frac{d\\ell}{d\\lambda} = \\sum_{i=1}^{4} \\left[ -c_i x_i + (n_i - x_i) \\frac{c_i \\exp(-\\lambda c_i)}{1 - \\exp(-\\lambda c_i)} \\right] $$\nSetting $\\frac{d\\ell}{d\\lambda} = 0$:\n$$ \\sum_{i=1}^{4} c_i \\left[ -x_i + \\frac{(n_i - x_i) \\exp(-\\lambda c_i)}{1 - \\exp(-\\lambda c_i)} \\right] = 0 $$\nThis equation can be rearranged to:\n$$ \\sum_{i=1}^{4} c_i \\frac{-x_i(1 - \\exp(-\\lambda c_i)) + (n_i - x_i) \\exp(-\\lambda c_i)}{1 - \\exp(-\\lambda c_i)} = \\sum_{i=1}^{4} c_i \\frac{n_i \\exp(-\\lambda c_i) - x_i}{1 - \\exp(-\\lambda c_i)} = 0 $$\nWhile this equation would typically be solved numerically, the provided data reveals a specific structure. The observed proportions of non-engrafted mice are $x_1/n_1 = 8/10 = 0.8$, $x_2/n_2 = 6/10 = 0.6$, $x_3/n_3 = 4/10 = 0.4$, and $x_4/n_4 = 2/10 = 0.2$. Let us test if an estimate $\\hat{\\lambda}$ exists such that the model probabilities $\\exp(-\\hat{\\lambda} c_i)$ match these observed proportions. This holds if $\\hat{\\lambda} = 1 \\times 10^{-5} \\, \\text{cells}^{-1}$, since:\n- $\\hat{\\lambda} c_1 = (10^{-5}) (2.231435513 \\times 10^4) = 0.2231435513 = \\ln(1.25)$, so $\\exp(-\\hat{\\lambda} c_1) = 1/1.25 = 0.8$.\n- $\\hat{\\lambda} c_2 = (10^{-5}) (5.108256238 \\times 10^4) = 0.5108256238 = \\ln(5/3)$, so $\\exp(-\\hat{\\lambda} c_2) = 3/5 = 0.6$.\n- $\\hat{\\lambda} c_3 = (10^{-5}) (9.162907319 \\times 10^4) = 0.9162907319 = \\ln(2.5)$, so $\\exp(-\\hat{\\lambda} c_3) = 1/2.5 = 0.4$.\n- $\\hat{\\lambda} c_4 = (10^{-5}) (1.609437912 \\times 10^5) = 1.609437912 = \\ln(5)$, so $\\exp(-\\hat{\\lambda} c_4) = 1/5 = 0.2$.\nFor this value of $\\lambda$, the term $n_i \\exp(-\\lambda c_i) - x_i$ becomes $n_i(x_i/n_i) - x_i = x_i - x_i = 0$ for all $i$. Thus, each term in the sum of the score equation is zero, and the equation is satisfied. The MLE is therefore $\\hat{\\lambda} = 1 \\times 10^{-5} \\, \\text{cells}^{-1}$.\n\nNext, we construct a $95\\%$ confidence interval using the Wald approximation: $\\hat{\\lambda} \\pm z_{0.025} \\sqrt{\\widehat{\\text{Var}}(\\hat{\\lambda})}$. The variance of the MLE is approximated by the inverse of the observed Fisher information, $J(\\hat{\\lambda})$, which is the negative of the second derivative of the log-likelihood evaluated at $\\hat{\\lambda}$.\n$$ J(\\lambda) = -\\frac{d^2\\ell}{d\\lambda^2} $$\nLet's compute the second derivative:\n$$ \\frac{d^2\\ell}{d\\lambda^2} = \\frac{d}{d\\lambda} \\sum_{i=1}^{4} (n_i-x_i) c_i \\frac{\\exp(-\\lambda c_i)}{1 - \\exp(-\\lambda c_i)} $$\nLet $u_i = \\exp(-\\lambda c_i)$. The derivative of $\\frac{u_i}{1-u_i}$ with respect to $\\lambda$ is $\\frac{d}{d\\lambda} \\left(\\frac{u_i}{1-u_i}\\right) = \\frac{-c_i u_i}{(1-u_i)^2} = \\frac{-c_i \\exp(-\\lambda c_i)}{(1 - \\exp(-\\lambda c_i))^2}$.\n$$ \\frac{d^2\\ell}{d\\lambda^2} = - \\sum_{i=1}^{4} \\frac{(n_i - x_i) c_i^2 \\exp(-\\lambda c_i)}{(1 - \\exp(-\\lambda c_i))^2} $$\nThe observed Fisher information is:\n$$ J(\\lambda) = \\sum_{i=1}^{4} \\frac{(n_i - x_i) c_i^2 \\exp(-\\lambda c_i)}{(1 - \\exp(-\\lambda c_i))^2} $$\nWe evaluate this at $\\hat{\\lambda} = 10^{-5}$. At this value, $x_i = n_i \\exp(-\\hat{\\lambda} c_i)$, so $n_i - x_i = n_i(1 - \\exp(-\\hat{\\lambda} c_i))$. Substituting this into the expression for $J(\\hat{\\lambda})$ gives:\n$$ J(\\hat{\\lambda}) = \\sum_{i=1}^{4} \\frac{n_i(1 - \\exp(-\\hat{\\lambda} c_i)) c_i^2 \\exp(-\\hat{\\lambda} c_i)}{(1 - \\exp(-\\hat{\\lambda} c_i))^2} = \\sum_{i=1}^{4} \\frac{n_i c_i^2 \\exp(-\\hat{\\lambda} c_i)}{1 - \\exp(-\\hat{\\lambda} c_i)} $$\nPlugging in the numerical values for each dose group yields a total observed Fisher information of:\n$$ J(\\hat{\\lambda}) \\approx 1.7978836 \\times 10^{11} $$\nThe estimated variance of $\\hat{\\lambda}$ is $\\widehat{\\text{Var}}(\\hat{\\lambda}) = J(\\hat{\\lambda})^{-1} = (1.7978836 \\times 10^{11})^{-1} \\approx 5.56209 \\times 10^{-12}$.\nThe standard error is $\\text{SE}(\\hat{\\lambda}) = \\sqrt{\\widehat{\\text{Var}}(\\hat{\\lambda})} \\approx \\sqrt{5.56209 \\times 10^{-12}} \\approx 2.358408 \\times 10^{-6}$.\nFor a $95\\%$ confidence interval, $z_{0.025} \\approx 1.959964$. The margin of error is $ME = z_{0.025} \\times \\text{SE}(\\hat{\\lambda}) \\approx 1.959964 \\times 2.358408 \\times 10^{-6} \\approx 4.62237 \\times 10^{-6}$.\nThe confidence interval is $\\hat{\\lambda} \\pm ME$:\nLower bound: $1 \\times 10^{-5} - 4.62237 \\times 10^{-6} = 10 \\times 10^{-6} - 4.62237 \\times 10^{-6} = 5.37763 \\times 10^{-6}$.\nUpper bound: $1 \\times 10^{-5} + 4.62237 \\times 10^{-6} = 10 \\times 10^{-6} + 4.62237 \\times 10^{-6} = 14.62237 \\times 10^{-6} = 1.462237 \\times 10^{-5}$.\n\nRounding the results to four significant figures:\n- Point estimate $\\hat{\\lambda} = 1.000 \\times 10^{-5}$.\n- Lower confidence bound = $5.378 \\times 10^{-6}$.\n- Upper confidence bound = $1.462 \\times 10^{-5}$.", "answer": "$$ \\boxed{ \\begin{pmatrix} 1.000 \\times 10^{-5} & 5.378 \\times 10^{-6} & 1.462 \\times 10^{-5} \\end{pmatrix} } $$", "id": "2852659"}, {"introduction": "Beyond quantifying static cell frequencies, understanding the dynamic maintenance of immune populations is crucial. This practice explores how to model the homeostasis of naive B-cells using Kappa-deleting Recombination Excision Circles (KRECs), which act as a natural 'molecular clock' diluted by cell division. You will derive a mathematical model from first principles to estimate the daily production rate of B-cells from the bone marrow, a critical parameter for studying immune system maintenance and the effects of aging. [@problem_id:2852642]", "problem": "You are analyzing Kappa-deleting Recombination Excision Circles (KREC), which are episomal DNA by-products generated during immunoglobulin light chain receptor editing in developing B cells. KREC are not replicated during cell division and are assumed to be stably maintained without degradation in the time frame considered. In a well-mixed naive B-cell compartment at steady state, newly produced naive B cells from bone marrow enter the compartment at a constant rate, and cells within the compartment may divide and be lost (by death or egress). Let $N(t)$ be the total number of naive B cells, and let $K(t)$ be the total number of KREC within that compartment. Assume:\n- Each newly produced naive B cell carries, on average, $k_0$ KREC upon entry (for example, if a fraction $f$ of entrants carry exactly one KREC, then $k_0 = f$).\n- KREC do not replicate during cell division and are partitioned on average between daughters such that total $K(t)$ is conserved by division.\n- Division occurs at a per capita rate $r$ (units $\\text{day}^{-1}$), and loss occurs at a per capita rate $d$ (units $\\text{day}^{-1}$).\n- The compartment is at steady state.\n\nDefine the steady-state average KREC content per naive B cell as $C = K/N$. Using only these assumptions and conservation laws, derive from first principles an expression for the bone marrow output (the steady-state production rate of naive B cells), denoted $S$ (units cells per day), in terms of $r$, $N$, $k_0$, and $C$.\n\nYou are provided with measured values for two cohorts:\n\nYoung cohort:\n- Total naive B-cell pool size: $N_{\\text{y}} = 2.0 \\times 10^{9}$ cells.\n- Per capita division rate: $r_{\\text{y}} = 0.004 \\ \\text{day}^{-1}$.\n- Average KREC per cell: $C_{\\text{y}} = 0.12$ circles per cell.\n\nAged cohort:\n- Total naive B-cell pool size: $N_{\\text{a}} = 1.2 \\times 10^{9}$ cells.\n- Per capita division rate: $r_{\\text{a}} = 0.002 \\ \\text{day}^{-1}$.\n- Average KREC per cell: $C_{\\text{a}} = 0.05$ circles per cell.\n\nAssume the average KREC content per newly produced naive B cell is cohort-invariant and equal to $k_0 = 0.40$ circles per newly produced naive B cell. Using your derived expression, compute the ratio of bone marrow outputs between the young and aged cohorts, $S_{\\text{y}} / S_{\\text{a}}$. Provide an exact value (no rounding). The final answer should be a pure number without units.", "solution": "The problem is subjected to rigorous validation and is deemed valid as it is scientifically grounded, well-posed, objective, and internally consistent. We shall proceed with the derivation and solution.\n\nThe problem requires the derivation of an expression for the steady-state production rate of naive B cells, $S$, and the subsequent calculation of the ratio of these rates for two cohorts. We begin by establishing the conservation equations for the total number of naive B cells, $N(t)$, and the total number of Kappa-deleting Recombination Excision Circles (KREC), $K(t)$, within the compartment.\n\nLet $N(t)$ be the total number of naive B cells and $K(t)$ be the total number of KRECs at time $t$. The dynamics of the system are governed by the following processes:\n$1$. Source: New naive B cells enter the compartment from the bone marrow at a constant rate $S$. Each new cell introduces an average of $k_0$ KRECs.\n$2$. Division: Cells divide at a per capita rate $r$. This increases the cell number but conserves the total number of KRECs, as they are not replicated.\n$3$. Loss: Cells are lost from the compartment (due to death or egress) at a per capita rate $d$. This removes both cells and the KRECs they contain.\n\nThe rate of change of the total number of naive B cells, $\\frac{dN}{dt}$, is given by the balance of production, division, and loss:\n$$\n\\frac{dN}{dt} = S + rN - dN\n$$\nThe first term, $S$, is the influx from the bone marrow. The second term, $rN$, is the rate of cell generation through division. The third term, $-dN$, is the rate of cell loss.\n\nThe rate of change of the total number of KRECs, $\\frac{dK}{dt}$, is described by:\n$$\n\\frac{dK}{dt} = S k_0 - dK\n$$\nThe first term, $S k_0$, represents the influx of KRECs carried by the new cells from the bone marrow. The second term, $-dK$, represents the loss of KRECs from the compartment. The loss rate of cells is $dN$. The average number of KRECs per cell is $C = K/N$. Therefore, the rate of KREC loss is $d \\cdot N \\cdot (K/N) = dK$. As stated in the problem, cell division conserves the total number of KRECs, so it does not contribute a term to this equation.\n\nThe problem specifies that the system is at steady state. This implies that the net rates of change for both $N$ and $K$ are zero:\n$$\n\\frac{dN}{dt} = 0 \\quad \\text{and} \\quad \\frac{dK}{dt} = 0\n$$\nApplying this condition to our system of equations yields two algebraic equations:\n$$\nS + rN - dN = 0 \\quad \\implies \\quad S = (d - r)N \\quad (1)\n$$\n$$\nS k_0 - dK = 0 \\quad \\implies \\quad S k_0 = dK \\quad (2)\n$$\nHere, $N$ and $K$ represent their steady-state values. Our goal is to find an expression for $S$ in terms of $r$, $N$, $k_0$, and the steady-state average KREC content, $C = K/N$. To achieve this, we must eliminate the unknown loss rate $d$.\n\nFrom equation $(2)$, we can express $d$ as:\n$$\nd = \\frac{S k_0}{K}\n$$\nThe problem defines the average KREC content per cell as $C = K/N$. We can therefore write $K = CN$. Substituting this into the expression for $d$:\n$$\nd = \\frac{S k_0}{CN}\n$$\nNow, substitute this expression for $d$ into equation $(1)$:\n$$\nS = \\left(\\frac{S k_0}{CN} - r\\right)N\n$$\nWe proceed to solve this equation for $S$. Distributing $N$ on the right-hand side gives:\n$$\nS = \\frac{S k_0 N}{CN} - rN\n$$\n$$\nS = S \\frac{k_0}{C} - rN\n$$\nTo isolate $S$, we gather all terms containing $S$ on one side of the equation:\n$$\nrN = S \\frac{k_0}{C} - S\n$$\nFactoring out $S$:\n$$\nrN = S \\left(\\frac{k_0}{C} - 1\\right)\n$$\n$$\nrN = S \\left(\\frac{k_0 - C}{C}\\right)\n$$\nFinally, solving for $S$ yields the desired expression for the bone marrow output:\n$$\nS = rN \\frac{C}{k_0 - C}\n$$\nThis formula expresses the steady-state production rate $S$ in terms of the measurable quantities $r$, $N$, $C$, and the given parameter $k_0$. For a physically meaningful positive production rate $S > 0$, and given that $r, N, C$ are all positive, it is required that $k_0 - C > 0$, or $k_0 > C$. This condition is satisfied for both cohorts described in the problem ($k_0 = 0.40$ is greater than both $C_{\\text{y}} = 0.12$ and $C_{\\text{a}} = 0.05$).\n\nWe are tasked with computing the ratio of bone marrow outputs between the young and aged cohorts, $S_{\\text{y}} / S_{\\text{a}}$. Using the derived formula for each cohort:\n$$\nS_{\\text{y}} = r_{\\text{y}} N_{\\text{y}} \\frac{C_{\\text{y}}}{k_0 - C_{\\text{y}}}\n$$\n$$\nS_{\\text{a}} = r_{\\text{a}} N_{\\text{a}} \\frac{C_{\\text{a}}}{k_0 - C_{\\text{a}}}\n$$\nThe ratio is therefore:\n$$\n\\frac{S_{\\text{y}}}{S_{\\text{a}}} = \\frac{r_{\\text{y}} N_{\\text{y}} \\frac{C_{\\text{y}}}{k_0 - C_{\\text{y}}}}{r_{\\text{a}} N_{\\text{a}} \\frac{C_{\\text{a}}}{k_0 - C_{\\text{a}}}} = \\left(\\frac{r_{\\text{y}} N_{\\text{y}}}{r_{\\text{a}} N_{\\text{a}}}\\right) \\left(\\frac{C_{\\text{y}}}{C_{\\text{a}}}\\right) \\left(\\frac{k_0 - C_{\\text{a}}}{k_0 - C_{\\text{y}}}\\right)\n$$\nWe now substitute the provided numerical values:\nFor the young cohort: $N_{\\text{y}} = 2.0 \\times 10^{9}$, $r_{\\text{y}} = 0.004 \\ \\text{day}^{-1}$, $C_{\\text{y}} = 0.12$.\nFor the aged cohort: $N_{\\text{a}} = 1.2 \\times 10^{9}$, $r_{\\text{a}} = 0.002 \\ \\text{day}^{-1}$, $C_{\\text{a}} = 0.05$.\nThe invariant parameter is $k_0 = 0.40$.\n\nLet's compute each component of the ratio:\n$$\n\\frac{r_{\\text{y}} N_{\\text{y}}}{r_{\\text{a}} N_{\\text{a}}} = \\frac{(0.004) \\cdot (2.0 \\times 10^{9})}{(0.002) \\cdot (1.2 \\times 10^{9})} = \\frac{0.008}{0.0024} = \\frac{80}{24} = \\frac{10}{3}\n$$\n$$\n\\frac{C_{\\text{y}}}{C_{\\text{a}}} = \\frac{0.12}{0.05} = \\frac{12}{5}\n$$\n$$\n\\frac{k_0 - C_{\\text{a}}}{k_0 - C_{\\text{y}}} = \\frac{0.40 - 0.05}{0.40 - 0.12} = \\frac{0.35}{0.28} = \\frac{35}{28} = \\frac{5}{4}\n$$\nMultiplying these components together gives the final ratio:\n$$\n\\frac{S_{\\text{y}}}{S_{\\text{a}}} = \\left(\\frac{10}{3}\\right) \\left(\\frac{12}{5}\\right) \\left(\\frac{5}{4}\\right)\n$$\nThe terms can be simplified:\n$$\n\\frac{S_{\\text{y}}}{S_{\\text{a}}} = \\frac{10 \\cdot 12 \\cdot 5}{3 \\cdot 5 \\cdot 4} = \\frac{10 \\cdot (3 \\cdot 4) \\cdot 5}{3 \\cdot 5 \\cdot 4}\n$$\nCanceling the common factors of $3$, $4$, and $5$ from the numerator and denominator, we are left with:\n$$\n\\frac{S_{\\text{y}}}{S_{\\text{a}}} = 10\n$$\nThe ratio of the bone marrow outputs between the young and aged cohorts is exactly $10$.", "answer": "$$\n\\boxed{10}\n$$", "id": "2852642"}, {"introduction": "We now shift from population-level models to the high-resolution world of single-cell genomics, where we can observe differentiation in action. This practice introduces RNA velocity, a powerful computational approach that predicts the future transcriptional state of individual cells by comparing levels of spliced and unspliced messenger RNA. You will implement a velocity-based algorithm to construct a probabilistic map of the hematopoietic trajectory and validate it using simulated lineage tracing data, providing direct, hands-on experience with a cornerstone technique in modern computational immunology. [@problem_id:2852618]", "problem": "You are given a conceptualized single-cell ribonucleic acid sequencing (scRNA-seq) setting focusing on hematopoiesis, in which the state of each cell is embedded in a low-dimensional space and an RNA velocity vector approximates the instantaneous time derivative of the cell’s state. The biological context is the canonical myeloid trajectory from Hematopoietic Stem Cell (HSC) to Granulocyte–Macrophage Progenitor (GMP) via intermediate progenitors. Your task is to formalize and implement an algorithm to infer the directional flow from HSC to GMP using velocity-aligned transitions between clusters, and to validate the inferred transitions with independent lineage barcoding trajectories.\n\nFundamental base (definitions and facts to be used):\n- A hematopoietic hierarchy contains progenitor classes that can be represented as clusters; canonical myeloid progression proceeds through HSC to downstream progenitors before reaching GMP.\n- RNA velocity approximates the instantaneous time derivative in gene expression state and can be modeled as a vector field in a continuous embedding; a vector projection quantifies alignment between a velocity vector and a displacement vector.\n- For vectors $\\mathbf{a}$ and $\\mathbf{b}$, the cosine similarity is $\\cos(\\theta) = \\dfrac{\\mathbf{a} \\cdot \\mathbf{b}}{\\|\\mathbf{a}\\|\\,\\|\\mathbf{b}\\|}$, where $\\cdot$ is the dot product and $\\|\\cdot\\|$ is the Euclidean norm.\n- A row-stochastic Markov transition matrix has nonnegative entries in each row that sum to $1$, and multi-step transition probabilities are obtained by integer powers of the matrix.\n\nProblem requirements:\n1) You will treat clusters as $\\{\\mathrm{HSC}, \\mathrm{MPP}, \\mathrm{CMP}, \\mathrm{GMP}\\}$ in that fixed order. For each test case, you will be given:\n   - A set of $2$-dimensional coordinates for individual cells in each cluster.\n   - A corresponding set of $2$-dimensional RNA velocity vectors for those cells.\n   - An independent lineage barcoding transition matrix between the same clusters, row-stochastic and ordered as above.\n2) Let $\\mathbf{c}_k$ denote the centroid of cluster $k$ computed as the arithmetic mean of its cell coordinates. For a cell $i$ in source cluster $s$ with position $\\mathbf{x}_i$ and velocity $\\mathbf{v}_i$, define the displacement to cluster $t$ as $\\mathbf{d}_{i,t} = \\mathbf{c}_t - \\mathbf{x}_i$. Define the alignment score $a_{i,t}$ as follows:\n   - If $\\|\\mathbf{v}_i\\| = 0$ or $\\|\\mathbf{d}_{i,t}\\| = 0$, set $a_{i,t} = 0$.\n   - Otherwise, set $a_{i,t} = \\max\\{0, \\cos(\\theta_{i,t})\\}$ where $\\cos(\\theta_{i,t}) = \\dfrac{\\mathbf{v}_i \\cdot \\mathbf{d}_{i,t}}{\\|\\mathbf{v}_i\\|\\,\\|\\mathbf{d}_{i,t}\\|}$.\n   For each cell $i$, define the per-cell transition probabilities $p_{i,t}$ over all targets $t \\in \\{\\mathrm{HSC}, \\mathrm{MPP}, \\mathrm{CMP}, \\mathrm{GMP}\\}$ by:\n   - If $\\sum_t a_{i,t} > 0$, then $p_{i,t} = \\dfrac{a_{i,t}}{\\sum_{u} a_{i,u}}$.\n   - Otherwise (complete lack of positive alignment), use a distance-based fallback with temperature $\\sigma$: $p_{i,t} \\propto \\exp\\left(-\\dfrac{\\|\\mathbf{d}_{i,t}\\|}{\\sigma}\\right)$ and normalize so that $\\sum_t p_{i,t} = 1$. Use $\\sigma = 1.0$.\n3) The cluster-level transition probabilities $P_{s,t}$ are defined as the arithmetic mean of $p_{i,t}$ over all cells $i$ in source cluster $s$. Normalize each row to enforce $\\sum_t P_{s,t} = 1$. Denote by $\\mathbf{P}$ the resulting $4 \\times 4$ row-stochastic matrix.\n4) Define the $k$-step transition probability from HSC to GMP as the $(\\mathrm{HSC}, \\mathrm{GMP})$ entry of $\\mathbf{P}^k$. Use $k = 3$ to represent the canonical number of steps from HSC to GMP through intermediates.\n5) Define “directional support” for the HSC-to-GMP flow as the boolean predicate that the $3$-step probability to reach GMP from HSC is strictly greater than the corresponding $3$-step probabilities to reach HSC, MPP, or CMP from HSC.\n6) Validation with lineage barcoding: Let $\\mathbf{B}$ be the given barcoding transition matrix. Compute the Jensen–Shannon divergence (JSD) between the HSC row of $\\mathbf{P}$ and the HSC row of $\\mathbf{B}$:\n   - For two discrete distributions $\\mathbf{p}$ and $\\mathbf{q}$ over the same support that sum to $1$ and have nonnegative entries, define $\\mathbf{m} = \\dfrac{\\mathbf{p} + \\mathbf{q}}{2}$ and the Kullback–Leibler divergence with natural logarithm as $\\mathrm{KL}(\\mathbf{p}\\|\\mathbf{m}) = \\sum_j p_j \\log\\left(\\dfrac{p_j}{m_j}\\right)$ with the convention that $0 \\log(0/r) = 0$. Then $\\mathrm{JSD}(\\mathbf{p}, \\mathbf{q}) = \\dfrac{1}{2}\\mathrm{KL}(\\mathbf{p}\\|\\mathbf{m}) + \\dfrac{1}{2}\\mathrm{KL}(\\mathbf{q}\\|\\mathbf{m})$.\n   - A validation pass is declared if $\\mathrm{JSD} \\le \\tau$ with threshold $\\tau = 0.25$.\n7) Numerical outputs:\n   - For each test case, your program must output a four-element list: [directional_support_boolean, three_step_probability_to_GMP_from_HSC, JSD_HSC_row, validation_boolean].\n   - The three-step probability and the Jensen–Shannon divergence must be real numbers. Round both to $6$ decimal places.\n8) Final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is the four-element list described above. For example: \"[[true,0.123456,0.234567,false],[...],...]\".\n\nTest suite (three cases):\n- Global constants: $\\sigma = 1.0$, $k = 3$, $\\tau = 0.25$.\n- Cluster order is fixed as [$\\mathrm{HSC}$, $\\mathrm{MPP}$, $\\mathrm{CMP}$, $\\mathrm{GMP}$].\n\nCase $1$:\n- Cell coordinates and velocities:\n  - HSC coords: $[(0.00, 0.00), (-0.10, 0.00), (0.05, 0.02)]$; HSC velocities: $[(0.80, 0.00), (0.70, 0.05), (0.60, -0.02)]$.\n  - MPP coords: $[(1.00, 0.00), (1.02, 0.01)]$; MPP velocities: $[(0.70, 0.00), (0.65, 0.01)]$.\n  - CMP coords: $[(2.00, 0.00), (2.05, -0.01)]$; CMP velocities: $[(0.60, 0.00), (0.55, 0.00)]$.\n  - GMP coords: $[(3.00, 0.00)]$; GMP velocities: $[(0.00, 0.00)]$.\n- Lineage barcoding matrix $\\mathbf{B}$ (rows in cluster order, each row sums to $1$):\n  - HSC row: $[0.00, 0.85, 0.10, 0.05]$.\n  - MPP row: $[0.10, 0.00, 0.70, 0.20]$.\n  - CMP row: $[0.00, 0.20, 0.00, 0.80]$.\n  - GMP row: $[0.00, 0.00, 0.00, 1.00]$.\n\nCase $2$:\n- Cell coordinates and velocities:\n  - HSC coords: $[(0.00, 0.00), (-0.10, 0.00), (0.05, 0.02)]$; HSC velocities: $[(0.30, 0.00), (-0.10, 0.20), (0.00, 0.00)]$.\n  - MPP coords: $[(1.00, 0.00), (1.02, 0.01)]$; MPP velocities: $[(0.60, 0.02), (0.55, 0.00)]$.\n  - CMP coords: $[(2.00, 0.00), (2.05, -0.01)]$; CMP velocities: $[(0.50, 0.00), (0.45, 0.00)]$.\n  - GMP coords: $[(3.00, 0.00)]$; GMP velocities: $[(0.00, 0.00)]$.\n- Lineage barcoding matrix $\\mathbf{B}$:\n  - HSC row: $[0.00, 0.60, 0.25, 0.15]$.\n  - MPP row: $[0.05, 0.10, 0.65, 0.20]$.\n  - CMP row: $[0.00, 0.15, 0.05, 0.80]$.\n  - GMP row: $[0.00, 0.00, 0.00, 1.00]$.\n\nCase $3$:\n- Cell coordinates and velocities:\n  - HSC coords: $[(0.00, 0.00), (-0.10, 0.00), (0.05, 0.02)]$; HSC velocities: $[(0.00, 0.00), (0.00, 0.00), (0.00, 0.00)]$.\n  - MPP coords: $[(1.00, 0.00), (1.02, 0.01)]$; MPP velocities: $[(0.00, 0.00), (0.00, 0.00)]$.\n  - CMP coords: $[(2.00, 0.00), (2.05, -0.01)]$; CMP velocities: $[(0.00, 0.00), (0.00, 0.00)]$.\n  - GMP coords: $[(3.00, 0.00)]$; GMP velocities: $[(0.00, 0.00)]$.\n- Lineage barcoding matrix $\\mathbf{B}$:\n  - HSC row: $[0.40, 0.30, 0.20, 0.10]$.\n  - MPP row: $[0.20, 0.30, 0.30, 0.20]$.\n  - CMP row: $[0.10, 0.20, 0.30, 0.40]$.\n  - GMP row: $[0.00, 0.00, 0.00, 1.00]$.\n\nYour program must:\n- Implement the procedure above to compute $\\mathbf{P}$, the $3$-step probability from HSC to GMP, the directional support boolean, the Jensen–Shannon divergence between the HSC rows of $\\mathbf{P}$ and $\\mathbf{B}$, and the validation boolean with threshold $\\tau = 0.25$.\n- Produce a single line of output containing a comma-separated list of the per-test-case four-element lists, enclosed in square brackets. Round the real numbers to $6$ decimal places. Use boolean literals in lowercase as in many programming languages (true/false) if your language uses such representation; in Python, booleans render as True/False and are acceptable.", "solution": "The problem is valid. It presents a well-defined computational task grounded in the principles of single-cell data analysis, specifically RNA velocity modeling for inferring cell fate trajectories in hematopoiesis. All necessary data, mathematical definitions, and parameters are provided, rendering the problem self-contained, objective, and scientifically sound. I will proceed with a solution.\n\nThe task is to construct a Markov model of cell state transitions based on RNA velocity vectors and to validate this model against independent lineage barcoding data. The system comprises four cell clusters representing a hematopoietic differentiation path: Hematopoietic Stem Cell (HSC), Multipotent Progenitor (MPP), Common Myeloid Progenitor (CMP), and Granulocyte-Macrophage Progenitor (GMP). The clusters are indexed from $0$ to $3$ in this order.\n\nFirst, we establish a reference point for each cluster $k$ by computing its centroid, $\\mathbf{c}_k$, as the arithmetic mean of the coordinates of all cells within that cluster.\n$$\n\\mathbf{c}_k = \\frac{1}{N_k} \\sum_{i \\in \\text{cluster } k} \\mathbf{x}_i\n$$\nwhere $N_k$ is the number of cells in cluster $k$ and $\\mathbf{x}_i$ is the coordinate vector of cell $i$.\n\nNext, we compute the transition probability from each cell to all possible target clusters. For a cell $i$ in a source cluster $s$ with position $\\mathbf{x}_i$ and velocity $\\mathbf{v}_i$, its transition tendency towards a target cluster $t$ is quantified by the alignment of its velocity vector with the displacement vector pointing to the target cluster's centroid. The displacement vector is $\\mathbf{d}_{i,t} = \\mathbf{c}_t - \\mathbf{x}_i$. The alignment is measured by the cosine similarity between $\\mathbf{v}_i$ and $\\mathbf{d}_{i,t}$. We define an alignment score $a_{i,t}$ as the non-negative part of this cosine similarity:\n$$\na_{i,t} = \\max\\left\\{0, \\frac{\\mathbf{v}_i \\cdot \\mathbf{d}_{i,t}}{\\|\\mathbf{v}_i\\|_2 \\|\\mathbf{d}_{i,t}\\|_2}\\right\\}\n$$\nwhere $\\|\\cdot\\|_2$ is the Euclidean norm. If either $\\mathbf{v}_i$ or $\\mathbf{d}_{i,t}$ is a zero vector, its norm is $0$, and we define $a_{i,t} = 0$. These scores are then normalized to yield per-cell transition probabilities $p_{i,t}$:\n$$\np_{i,t} = \\frac{a_{i,t}}{\\sum_{u=0}^{3} a_{i,u}}\n$$\nThis normalization is performed only if $\\sum_{u} a_{i,u} > 0$. If a cell's velocity vector shows no positive alignment to any cluster centroid (i.e., $\\sum_{u} a_{i,u} = 0$), we employ a fallback mechanism. The probabilities are then based on the inverse exponential of the Euclidean distance to cluster centroids, governed by a temperature parameter $\\sigma = 1.0$:\n$$\np_{i,t} \\propto \\exp\\left(-\\frac{\\|\\mathbf{d}_{i,t}\\|_2}{\\sigma}\\right)\n$$\nThese values are subsequently normalized to sum to $1$.\n\nThe cluster-to-cluster transition probability, $P_{s,t}$, from a source cluster $s$ to a target cluster $t$, is computed by averaging the per-cell probabilities $p_{i,t}$ for all cells $i$ belonging to cluster $s$. Each row of the resulting matrix $\\mathbf{P}$ is then re-normalized to ensure it is row-stochastic.\n$$\nP_{s,t} = \\frac{1}{N_s} \\sum_{i \\in \\text{cluster } s} p_{i,t} \\quad \\text{followed by row-normalization}\n$$\n\nTo model multi-step differentiation processes, we compute the $k$-step transition matrix by taking the $k$-th power of $\\mathbf{P}$, denoted $\\mathbf{P}^k$. The problem specifies $k=3$ to represent the canonical steps from HSC to GMP. The entry $(\\mathbf{P}^3)_{0,3}$ thus represents the $3$-step transition probability from HSC (index $0$) to GMP (index $3$).\n\nWe then assess the \"directional support\" for the HSC-to-GMP trajectory. This is a boolean condition which is true if and only if the $3$-step probability of transitioning from HSC to GMP is strictly greater than the $3$-step probabilities of transitioning from HSC to any of the other clusters (including itself). Let $\\mathbf{P}^{(3)} = \\mathbf{P}^3$. The condition is:\n$$\n\\mathbf{P}^{(3)}_{0,3} > \\mathbf{P}^{(3)}_{0,0} \\quad \\land \\quad \\mathbf{P}^{(3)}_{0,3} > \\mathbf{P}^{(3)}_{0,1} \\quad \\land \\quad \\mathbf{P}^{(3)}_{0,3} > \\mathbf{P}^{(3)}_{0,2}\n$$\n\nFinally, we validate the velocity-inferred one-step transition probabilities against an independent experimental modality, lineage barcoding, represented by a given transition matrix $\\mathbf{B}$. The comparison is performed for the HSC source cluster (the first row of matrices $\\mathbf{P}$ and $\\mathbf{B}$) using the Jensen-Shannon Divergence (JSD). For two probability distributions $\\mathbf{p}$ and $\\mathbf{q}$, JSD is defined as:\n$$\n\\mathrm{JSD}(\\mathbf{p}, \\mathbf{q}) = \\frac{1}{2} D_{KL}(\\mathbf{p} \\| \\mathbf{m}) + \\frac{1}{2} D_{KL}(\\mathbf{q} \\| \\mathbf{m})\n$$\nwhere $\\mathbf{m} = \\frac{1}{2}(\\mathbf{p} + \\mathbf{q})$ is the mixture distribution, and $D_{KL}(\\mathbf{p} \\| \\mathbf{m}) = \\sum_j p_j \\ln\\left(\\frac{p_j}{m_j}\\right)$ is the Kullback-Leibler divergence. The convention $0 \\ln(0/x) = 0$ is applied. A validation is considered successful if the computed JSD is less than or equal to a threshold $\\tau = 0.25$.\n\nFor each test case, we will compute four values: the directional support boolean, the $3$-step HSC-to-GMP probability, the JSD between HSC rows of $\\mathbf{P}$ and $\\mathbf{B}$, and the validation pass boolean. The floating-point numbers will be rounded to $6$ decimal places.", "answer": "```python\nimport numpy as np\nfrom scipy.special import entr\n\ndef solve():\n    \"\"\"\n    Solves the problem for all test cases specified.\n    \"\"\"\n    \n    # Global constants as per problem statement\n    SIGMA = 1.0\n    K_STEPS = 3\n    TAU = 0.25\n    CLUSTER_NAMES = [\"HSC\", \"MPP\", \"CMP\", \"GMP\"]\n    \n    # Test cases data\n    test_cases = [\n        {\n            \"coords\": {\n                \"HSC\": np.array([[0.00, 0.00], [-0.10, 0.00], [0.05, 0.02]]),\n                \"MPP\": np.array([[1.00, 0.00], [1.02, 0.01]]),\n                \"CMP\": np.array([[2.00, 0.00], [2.05, -0.01]]),\n                \"GMP\": np.array([[3.00, 0.00]]),\n            },\n            \"velocities\": {\n                \"HSC\": np.array([[0.80, 0.00], [0.70, 0.05], [0.60, -0.02]]),\n                \"MPP\": np.array([[0.70, 0.00], [0.65, 0.01]]),\n                \"CMP\": np.array([[0.60, 0.00], [0.55, 0.00]]),\n                \"GMP\": np.array([[0.00, 0.00]]),\n            },\n            \"B_matrix\": np.array([\n                [0.00, 0.85, 0.10, 0.05],\n                [0.10, 0.00, 0.70, 0.20],\n                [0.00, 0.20, 0.00, 0.80],\n                [0.00, 0.00, 0.00, 1.00],\n            ]),\n        },\n        {\n            \"coords\": {\n                \"HSC\": np.array([[0.00, 0.00], [-0.10, 0.00], [0.05, 0.02]]),\n                \"MPP\": np.array([[1.00, 0.00], [1.02, 0.01]]),\n                \"CMP\": np.array([[2.00, 0.00], [2.05, -0.01]]),\n                \"GMP\": np.array([[3.00, 0.00]]),\n            },\n            \"velocities\": {\n                \"HSC\": np.array([[0.30, 0.00], [-0.10, 0.20], [0.00, 0.00]]),\n                \"MPP\": np.array([[0.60, 0.02], [0.55, 0.00]]),\n                \"CMP\": np.array([[0.50, 0.00], [0.45, 0.00]]),\n                \"GMP\": np.array([[0.00, 0.00]]),\n            },\n            \"B_matrix\": np.array([\n                [0.00, 0.60, 0.25, 0.15],\n                [0.05, 0.10, 0.65, 0.20],\n                [0.00, 0.15, 0.05, 0.80],\n                [0.00, 0.00, 0.00, 1.00],\n            ]),\n        },\n        {\n            \"coords\": {\n                \"HSC\": np.array([[0.00, 0.00], [-0.10, 0.00], [0.05, 0.02]]),\n                \"MPP\": np.array([[1.00, 0.00], [1.02, 0.01]]),\n                \"CMP\": np.array([[2.00, 0.00], [2.05, -0.01]]),\n                \"GMP\": np.array([[3.00, 0.00]]),\n            },\n            \"velocities\": {\n                \"HSC\": np.array([[0.00, 0.00], [0.00, 0.00], [0.00, 0.00]]),\n                \"MPP\": np.array([[0.00, 0.00], [0.00, 0.00]]),\n                \"CMP\": np.array([[0.00, 0.00], [0.00, 0.00]]),\n                \"GMP\": np.array([[0.00, 0.00]]),\n            },\n            \"B_matrix\": np.array([\n                [0.40, 0.30, 0.20, 0.10],\n                [0.20, 0.30, 0.30, 0.20],\n                [0.10, 0.20, 0.30, 0.40],\n                [0.00, 0.00, 0.00, 1.00],\n            ]),\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        result = process_case(case, CLUSTER_NAMES, SIGMA, K_STEPS, TAU)\n        results.append(result)\n\n    # Format the final output string exactly as requested\n    output_parts = []\n    for r in results:\n        # str(bool).lower() ensures 'true'/'false'\n        part = f'[{str(r[0]).lower()},{r[1]:.6f},{r[2]:.6f},{str(r[3]).lower()}]'\n        output_parts.append(part)\n    final_output = f\"[{','.join(output_parts)}]\"\n    print(final_output)\n\ndef jensen_shannon_divergence(p, q):\n    \"\"\"\n    Computes the Jensen-Shannon divergence between two probability distributions.\n    \"\"\"\n    p = np.asarray(p)\n    q = np.asarray(q)\n    # Handle potential floating point inaccuracies for sum\n    p /= p.sum()\n    q /= q.sum()\n    m = 0.5 * (p + q)\n    \n    # scipy.special.entr(x) calculates -x * log(x)\n    # The KL divergence D(P||Q) is sum(p * log(p/q)) = sum(p*log(p) - p*log(q))\n    # which is sum(-entr(p) - p*log(q))\n    # scipy's entropy(pk, qk) = sum(pk * log(pk/qk))\n    # It correctly handles 0*log(0) cases.\n    kl_p_m = np.sum(p * np.log(p / m, where=(p != 0) & (m != 0)), where=(p != 0) & (m != 0))\n    kl_q_m = np.sum(q * np.log(q / m, where=(q != 0) & (m != 0)), where=(q != 0) & (m != 0))\n    \n    return 0.5 * (kl_p_m + kl_q_m)\n\ndef process_case(case_data, cluster_names, sigma, k_steps, tau):\n    \"\"\"\n    Processes a single test case according to the problem description.\n    \"\"\"\n    num_clusters = len(cluster_names)\n    coords = case_data[\"coords\"]\n    velocities = case_data[\"velocities\"]\n    B_matrix = case_data[\"B_matrix\"]\n\n    # 1. Compute cluster centroids\n    centroids = np.array([coords[name].mean(axis=0) for name in cluster_names])\n\n    P_matrix = np.zeros((num_clusters, num_clusters))\n\n    # 2 & 3. Compute cluster-level transition matrix P\n    for s_idx, s_name in enumerate(cluster_names):\n        source_cells_coords = coords[s_name]\n        source_cells_vels = velocities[s_name]\n        \n        per_cell_probs = []\n        for i in range(source_cells_coords.shape[0]):\n            x_i = source_cells_coords[i]\n            v_i = source_cells_vels[i]\n            norm_v_i = np.linalg.norm(v_i)\n            \n            alignment_scores = np.zeros(num_clusters)\n            displacements = centroids - x_i\n            \n            if norm_v_i > 0:\n                for t_idx in range(num_clusters):\n                    d_it = displacements[t_idx]\n                    norm_d_it = np.linalg.norm(d_it)\n                    if norm_d_it > 0:\n                        cosine_sim = np.dot(v_i, d_it) / (norm_v_i * norm_d_it)\n                        alignment_scores[t_idx] = max(0, cosine_sim)\n            \n            sum_align_scores = np.sum(alignment_scores)\n            \n            if sum_align_scores > 0:\n                p_i = alignment_scores / sum_align_scores\n            else: # Fallback mechanism\n                distances = np.linalg.norm(displacements, axis=1)\n                unnormalized_probs = np.exp(-distances / sigma)\n                sum_unnormalized = np.sum(unnormalized_probs)\n                if sum_unnormalized > 0:\n                    p_i = unnormalized_probs / sum_unnormalized\n                else: # All distances infinite or exp underflows to 0\n                    p_i = np.full(num_clusters, 1.0 / num_clusters)\n            per_cell_probs.append(p_i)\n            \n        # Average per-cell probabilities for the source cluster\n        if per_cell_probs:\n            cluster_level_probs = np.mean(per_cell_probs, axis=0)\n            # Normalize row to sum to 1\n            P_matrix[s_idx, :] = cluster_level_probs / np.sum(cluster_level_probs)\n        else: # No cells in cluster\n             P_matrix[s_idx, s_idx] = 1.0\n             \n    # 4. Compute k-step transition matrix\n    P_k = np.linalg.matrix_power(P_matrix, k_steps)\n    \n    # 5. Determine directional support\n    hsc_3step_probs = P_k[0, :]\n    prob_hsc_to_gmp = hsc_3step_probs[3]\n    \n    directional_support = (\n        prob_hsc_to_gmp > hsc_3step_probs[0] and\n        prob_hsc_to_gmp > hsc_3step_probs[1] and\n        prob_hsc_to_gmp > hsc_3step_probs[2]\n    )\n    \n    # 6. Compute JSD for validation\n    p_hsc_row = P_matrix[0, :]\n    b_hsc_row = B_matrix[0, :]\n    jsd_hsc = jensen_shannon_divergence(p_hsc_row, b_hsc_row)\n    \n    # 7. Determine validation pass\n    validation_pass = jsd_hsc <= tau\n    \n    return [directional_support, prob_hsc_to_gmp, jsd_hsc, validation_pass]\n\nif __name__ == \"__main__\":\n    solve()\n\n```", "id": "2852618"}]}