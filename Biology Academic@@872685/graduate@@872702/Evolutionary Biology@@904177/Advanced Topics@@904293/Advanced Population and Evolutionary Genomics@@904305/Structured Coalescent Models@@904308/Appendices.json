{"hands_on_practices": [{"introduction": "The structured coalescent model is fundamentally a race between competing events: lineage coalescence within demes and lineage migration between them. To master this framework, you must first understand how to calculate the probability of any single event occurring next. This foundational exercise challenges you to derive this probability from first principles, providing a clear view of the model's essential mechanics.", "problem": "Consider a standard structured coalescent model with $D$ demes, where deme $j$ has constant effective population size $N_{j}$ and backward-in-time migration rates $m_{j\\ell}$ for a lineage to move from deme $j$ to deme $\\ell$ with $j \\ne \\ell$. Let $M_{j} = \\sum_{\\ell \\ne j} m_{j\\ell}$ denote the total backward migration rate out of deme $j$ for a single lineage. At some time point, the configuration of sampled ancestral lineages is $(k_{1},\\dots,k_{D})$, where $k_{j}$ is the number of ancestral lineages currently in deme $j$. Assume $k_{d} \\ge 2$ so that there exists at least one unordered pair of lineages in deme $d$.\n\nUnder the standard continuous-time coalescent scaling for a diploid Wright–Fisher population, the instantaneous coalescence rate for any unordered pair of lineages that reside in the same deme $j$ is $1/(2N_{j})$, and each lineage in deme $j$ migrates out of deme $j$ at instantaneous rate $M_{j}$. The next event backward in time is either a within-deme coalescence or a migration of a single lineage, and the waiting time to the next event is exponentially distributed with rate equal to the sum of all instantaneous event rates implied by the current configuration.\n\nDerive, from first principles of competing exponential hazards, a closed-form expression for the probability that a particular specified unordered pair of lineages in deme $d$ is the next event and that this next event is their coalescence, conditioned on the current configuration $(k_{1},\\dots,k_{D})$, the sizes $(N_{1},\\dots,N_{D})$, and the migration rates through $(M_{1},\\dots,M_{D})$ only. Your expression must be fully simplified in terms of $D$, $(k_{1},\\dots,k_{D})$, $(N_{1},\\dots,N_{D})$, and $(M_{1},\\dots,M_{D})$ only. In addition, briefly state the structural conditions on the model under which lineages within a deme are exchangeable so that all unordered pairs within that deme have equal instantaneous coalescent hazard. Express your final probability as a single closed-form analytic expression. Do not include any units. Do not approximate.", "solution": "The problem statement is scientifically grounded, well-posed, unambiguous, and internally consistent. It describes a standard scenario in theoretical population genetics based on the structured coalescent model. It provides all necessary parameters and definitions to derive the requested probability from first principles. Therefore, the problem is valid, and a solution will be provided.\n\nThe foundation for this derivation is the theory of competing exponential processes. The time to the next event in a structured coalescent model is exponentially distributed. When multiple independent events can occur, the total rate of any event occurring is the sum of the individual event rates. The probability that a specific event is the first to occur is the ratio of its rate to the total rate of all possible events.\n\nLet $\\Lambda$ be the total instantaneous rate of any event occurring across all $D$ demes. The possible events are either a coalescence of two lineages within a deme or the migration of a single lineage from one deme to another. We must sum the rates of all such possible events.\n\nFirst, consider the coalescence events. In any deme $j$, containing $k_{j}$ ancestral lineages, there are $\\binom{k_{j}}{2} = \\frac{k_{j}(k_{j}-1)}{2}$ distinct unordered pairs of lineages. The problem states that the instantaneous rate of coalescence for any such specific pair is $\\frac{1}{2N_{j}}$, which is consistent with the continuous-time approximation of a diploid Wright–Fisher model where time is measured in generations. Therefore, the total rate of coalescence within deme $j$, which we denote $\\Lambda_{\\text{coal}, j}$, is the sum of the rates for all possible pairs:\n$$\n\\Lambda_{\\text{coal}, j} = \\binom{k_{j}}{2} \\times \\frac{1}{2N_{j}} = \\frac{k_{j}(k_{j}-1)}{2} \\times \\frac{1}{2N_{j}} = \\frac{k_{j}(k_{j}-1)}{4N_{j}}\n$$\nThis applies for any deme $j$ where $k_{j} \\ge 2$. If $k_{j} < 2$, this rate is $0$, which the formula correctly yields.\n\nSecond, consider the migration events. In any deme $j$, there are $k_{j}$ lineages. Each lineage migrates out of deme $j$ at an instantaneous rate $M_{j}$. Since the migration events for each lineage are independent, the total rate of migration out of deme $j$, denoted $\\Lambda_{\\text{mig}, j}$, is the sum of the rates for all lineages present:\n$$\n\\Lambda_{\\text{mig}, j} = k_{j} \\times M_{j}\n$$\n\nThe total rate of any event, $\\Lambda$, is the sum of all coalescence and migration rates across all $D$ demes:\n$$\n\\Lambda = \\sum_{j=1}^{D} (\\Lambda_{\\text{coal}, j} + \\Lambda_{\\text{mig}, j}) = \\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)\n$$\n\nThe problem asks for the probability that the next event is the coalescence of a *particular specified* unordered pair of lineages in deme $d$. Let this event be $E_{d}^{*}$. The rate of this specific event, $\\lambda_{E_{d}^{*}}$, is given directly in the problem statement as the rate for any single pair in deme $d$:\n$$\n\\lambda_{E_{d}^{*}} = \\frac{1}{2N_{d}}\n$$\nThis is valid because the problem specifies $k_{d} \\ge 2$, ensuring at least one such pair exists.\n\nThe probability $P(E_{d}^{*})$ that this specific coalescence is the next event to occur is the ratio of its specific rate to the total rate of all events:\n$$\nP(E_{d}^{*}) = \\frac{\\lambda_{E_{d}^{*}}}{\\Lambda} = \\frac{\\frac{1}{2N_{d}}}{\\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)}\n$$\nThis expression is in terms of the specified parameters and is in its most direct and interpretable form.\n\nFinally, the problem asks for the structural conditions under which lineages within a deme are exchangeable, meaning all unordered pairs within that deme have an equal instantaneous coalescent hazard. This property of exchangeability within a deme is a foundational assumption of the standard Wright-Fisher model applied at the deme level. The specific conditions are:\n1. **Panmixia**: All individuals within the deme mate randomly, so any lineage is equally likely to trace its ancestry to any individual in the parent generation.\n2. **Non-overlapping Generations and Neutrality**: All individuals in a generation are replaced simultaneously, and there is no selection acting on the genetic locus under study, ensuring that all lineages have equal fitness and thus symmetric ancestry probabilities.\nThese conditions ensure that there is no further population subdivision, selective heterogeneity, or variation in reproductive success that would differentiate the ancestral process for different lineages within the same deme. The problem statement's reference to a \"standard structured coalescent model\" implicitly assumes these conditions hold for each deme.", "answer": "$$\\boxed{\\frac{\\frac{1}{2N_{d}}}{\\sum_{j=1}^{D} \\left( \\frac{k_{j}(k_{j}-1)}{4N_{j}} + k_{j}M_{j} \\right)}}$$", "id": "2753786"}, {"introduction": "Building on the foundation of event rates, we can analyze their long-term consequences, such as the expected time until two lineages find a common ancestor. This practice delves into the critical issue of model misspecification, demonstrating how an overly simplified demographic model can lead to biased estimates of key parameters like migration rates. By comparing expected coalescent times between a true and a simplified model, you will quantify this inferential error directly.", "problem": "Consider a symmetric Wright–Fisher island model with the structured coalescent limit. There are $D$ demes, each with constant diploid size $N$, and symmetric migration among demes at per-generation probability $m$ per lineage. Let time be measured in units of $2N$ generations, and define the scaled migration rate $M = 2 N m$. In the structured coalescent, when two ancestral lineages are in the same deme, they coalesce at rate $1$ and each lineage migrates at rate $M$; when they are in different demes, no coalescence occurs and each lineage migrates at rate $M$ to a uniformly chosen other deme.\n\nSuppose the true model has $D=3$ demes and you observe two lineages sampled from two different demes. An analyst, however, fits a misspecified model that collapses the demography to $D=2$ demes, assumes the same per-deme size $N$, and estimates the migration parameter by equating the expected pairwise coalescent time for two lineages sampled from different demes under the $D=2$ model to the true expected value under the $D=3$ model. Assume $M>0$.\n\nStarting only from the structured coalescent transition rates described above and first-step analysis, do the following:\n\n- Derive an expression for the estimator $\\hat{m}$ returned by this misspecified $D=2$ analysis as a function of the true $m$ and $N$.\n\n- Using that $\\hat{m}$, determine the signed error in the expected coalescent time prediction for two lineages sampled from the same deme when using the $D=2$ model relative to the true $D=3$ model. Express the time difference in units of $2N$ generations.\n\nYour final answer must be a single analytic expression. If you return multiple quantities, write them as a row vector. Do not include units in your final boxed answer.", "solution": "The problem statement is scientifically valid, self-contained, and well-posed. It describes a standard scenario of model misspecification within the established framework of the structured coalescent. We may proceed directly to the solution.\n\nThe core of the problem requires the calculation of expected coalescence times. Let $T_S$ be the expected coalescence time for two ancestral lineages sampled from the same deme, and $T_D$ be the expected time for two lineages from different demes. All time is measured in units of $2N$ generations. The scaled migration rate for a model with $D$ demes is $M = 2Nm$.\n\nWe will derive general expressions for $T_S$ and $T_D$ for a symmetric island model with $D$ demes using first-step analysis, based on the provided transition rates.\n\nThe state of the two-lineage system is either 'Same' (S) or 'Different' (D).\nIn state S, the lineages are in the same deme. They can either coalesce, at rate $1$, or one of them can migrate to another deme. Since there are two lineages, each migrating at rate $M$, the total rate of migration out of the deme is $2M$. The total rate of any event from state S is $\\lambda_S = 1 + 2M$.\nIn state D, the lineages are in different demes. Coalescence cannot occur. Each lineage migrates at rate $M$ to one of the $D-1$ other demes. A transition to state S occurs if one lineage migrates to the specific deme where the other lineage resides. The rate of this for a single lineage is $M \\times \\frac{1}{D-1}$. As either lineage can make this transition, the total rate of transition from D to S is $\\frac{2M}{D-1}$.\n\nWe can set up a system of linear equations for $T_S$ and $T_D$ by considering the expected time until the first event and the state of the system after that event. An equivalent and robust method is to use the standard formulae derived from integrating the backward Kolmogorov equations for the system:\n$$1 = (1+2M)T_S - 2M T_D$$\n$$1 = \\frac{2M}{D-1}(T_D - T_S)$$\nThe first equation arises from considering state S, and the second from considering state D. From the second equation, we isolate the difference $T_D - T_S$:\n$$T_D - T_S = \\frac{D-1}{2M}$$\nThis allows us to express $T_D$ in terms of $T_S$:\n$$T_D = T_S + \\frac{D-1}{2M}$$\nNow, we substitute this expression for $T_D$ into the first equation:\n$$1 = (1+2M)T_S - 2M \\left( T_S + \\frac{D-1}{2M} \\right)$$\n$$1 = T_S + 2M T_S - 2M T_S - 2M \\left( \\frac{D-1}{2M} \\right)$$\n$$1 = T_S - (D-1)$$\n$$T_S = 1 + (D-1) = D$$\nThus, for a symmetric island model with $D$ demes, the expected coalescence time for two lineages sampled from the same deme is exactly $D$ (in units of $2N$ generations), provided $M > 0$.\nThe expected coalescence time for lineages from different demes is:\n$$T_D = T_S + \\frac{D-1}{2M} = D + \\frac{D-1}{2M}$$\nNow we apply these general results to the problem.\n\nFor the true model, we have $D = 3$ and parameters $m$, $N$, and $M = 2Nm$. The true expected times are:\n$$T_{S, D=3}(M) = 3$$\n$$T_{D, D=3}(M) = 3 + \\frac{3-1}{2M} = 3 + \\frac{1}{M}$$\nFor the misspecified model, we have $D = 2$ and estimated migration parameter $\\hat{m}$, with scaled rate $\\hat{M} = 2N\\hat{m}$. The predicted expected times under this model are:\n$$T_{S, D=2}(\\hat{M}) = 2$$\n$$T_{D, D=2}(\\hat{M}) = 2 + \\frac{2-1}{2\\hat{M}} = 2 + \\frac{1}{2\\hat{M}}$$\nThe analyst estimates the migration parameter by equating the expected coalescence time for lineages sampled from different demes:\n$$T_{D, D=2}(\\hat{M}) = T_{D, D=3}(M)$$\n$$2 + \\frac{1}{2\\hat{M}} = 3 + \\frac{1}{M}$$\nSolving for $\\hat{M}$:\n$$\\frac{1}{2\\hat{M}} = (3-2) + \\frac{1}{M} = 1 + \\frac{1}{M} = \\frac{M+1}{M}$$\n$$2\\hat{M} = \\frac{M}{M+1} \\implies \\hat{M} = \\frac{M}{2(M+1)}$$\nThe problem asks for the estimator $\\hat{m}$ as a function of $m$ and $N$. We substitute $\\hat{M}=2N\\hat{m}$ and $M=2Nm$:\n$$2N\\hat{m} = \\frac{2Nm}{2(2Nm+1)}$$\n$$\\hat{m} = \\frac{m}{2(2Nm+1)}$$\nThis is the first required result.\n\nThe second task is to find the signed error in the predicted expected coalescence time for two lineages sampled from the *same* deme. The error is the predicted value from the misspecified model minus the true value.\n$$\\text{Error} = T_{S, D=2}(\\hat{M}) - T_{S, D=3}(M)$$\nUsing our derived results, where $T_{S,D}=D$:\n$$\\text{Error} = 2 - 3 = -1$$\nThis error is given in units of $2N$ generations, as required. The misspecified $D=2$ model underestimates the true expected coalescence time for lineages from the same deme by one unit of $2N$ generations.\n\nThe final answer requires both quantities, which we present as a row vector.", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{m}{2(2Nm+1)} & -1 \\end{pmatrix}}$$", "id": "2753757"}, {"introduction": "While expected values provide valuable insights, simulating full genealogies allows us to explore the entire distribution of possible evolutionary histories. This advanced practice moves into the realm of computational biology, tasking you with designing an algorithm to simulate the structured coalescent process under dynamic scenarios where population sizes and migration rates change over time. You will use the thinning method for inhomogeneous Poisson processes, a core technique in modern phylogenetic software.", "problem": "Consider a structured coalescent with $K$ demes evolving backward in time. Let $n_{d}(t)$ denote the number of ancestral lineages in deme $d \\in \\{1,\\dots,K\\}$ at time $t \\geq 0$, and let $\\mathbf{n}(t) = \\big(n_{1}(t),\\dots,n_{K}(t)\\big)$. Parameters are piecewise-constant across a known set of epoch breakpoints $0 = \\tau_{0} < \\tau_{1} < \\cdots < \\tau_{E}$. In epoch $e \\in \\{1,\\dots,E\\}$, for $t \\in [\\tau_{e-1}, \\tau_{e})$, the effective population size in deme $d$ is $N_{d}^{(e)}$ and the backward-time migration rate from deme $d$ to deme $d'$ is $m_{d \\to d'}^{(e)}$. Assume the structured Kingman coalescent with the following foundational facts:\n- The instantaneous coalescence rate in deme $d$ given $n_{d}(t)$ lineages is $\\binom{n_{d}(t)}{2} / \\big(2 N_{d}^{(e)}\\big)$ in epoch $e$.\n- The instantaneous migration rate of a single lineage from deme $d$ to $d'$ in epoch $e$ is $m_{d \\to d'}^{(e)}$, so the total migration rate out of deme $d$ is $n_{d}(t) \\sum_{d' \\neq d} m_{d \\to d'}^{(e)}$.\n- The total instantaneous event hazard (sum of coalescence and migration hazards) at time $t$ is the sum over all demes and directed migration edges.\n\nYou wish to simulate the genealogy backward in time until the Most Recent Common Ancestor (MRCA) using thinning for inhomogeneous Poisson processes, while correctly handling parameter changes at epoch boundaries. Within each epoch $e$, suppose you employ a dominating homogeneous proposal process with a constant rate $M^{(e)}$ that satisfies $M^{(e)} \\geq \\lambda^{(e)}(t)$ for all $t \\in [\\tau_{e-1}, \\tau_{e})$ prior to the first accepted event in that epoch, where $\\lambda^{(e)}(t)$ denotes the true total event hazard at time $t$ under the structured coalescent.\n\nTasks:\n- Starting from first principles about continuous-time Markov chains (CTMCs) and Poisson processes, formulate an explicit algorithm that uses thinning to simulate the next event time and type, correctly handling the possibility that a proposed event time crosses an epoch boundary where parameters change. Your algorithm must make clear how to:\n  - Propose candidate waiting times from the dominating process within epoch $e$,\n  - Decide whether to accept or reject a proposed event time based on the true total hazard,\n  - Handle crossing an epoch boundary, including recomputing any quantities that change at $\\tau_{e}$,\n  - On acceptance, select the event type (which deme coalesces or which migration occurs) and update $\\mathbf{n}(t)$.\n- Then, fix an epoch $e$ and suppose that at the start of the epoch, time $\\tau_{e-1}$, the state is $\\mathbf{n}^{(e)} = \\big(n_{1}^{(e)},\\dots,n_{K}^{(e)}\\big)$. Assume that until the first accepted event in epoch $e$ occurs, the state $\\mathbf{n}(t)$ remains equal to $\\mathbf{n}^{(e)}$, and parameters are constant. Using only the foundational definitions above and properties of thinned Poisson processes, derive a closed-form analytic expression for the expected acceptance rate of the thinning procedure for candidate event times generated within epoch $e$ before the first accepted event occurs. Express your final answer as a single expression in terms of $K$, $\\big\\{n_{d}^{(e)}\\big\\}_{d=1}^{K}$, $\\big\\{N_{d}^{(e)}\\big\\}_{d=1}^{K}$, $\\big\\{m_{d \\to d'}^{(e)}\\big\\}_{d \\neq d'}$, and $M^{(e)}$.\n\nYour final answer must be a single closed-form analytic expression. Do not include any units or inequalities. If you choose to simplify combinatorial terms, do so explicitly. No rounding is required.", "solution": "The problem presented is scientifically grounded, well-posed, and contains sufficient information for a rigorous solution. It describes a standard structured coalescent model and poses two tasks: first, to formulate a simulation algorithm based on the thinning method for inhomogeneous Poisson processes, and second, to derive an analytical expression for the expected acceptance rate under specific conditions. The problem is valid and will be solved as follows.\n\nThe core of the problem lies in simulating the stochastic process of lineage coalescence and migration, which is a continuous-time Markov chain (CTMC) with rates that are piecewise constant. The changes in parameters occur at fixed epoch boundaries $\\tau_e$. Within each epoch, the event rates are functions of the state vector $\\mathbf{n}(t)$, the number of lineages in each deme. The total instantaneous event hazard in epoch $e$ for $t \\in [\\tau_{e-1}, \\tau_e)$, given state $\\mathbf{n}(t)$, is the sum of all individual event hazards:\n$$\n\\lambda^{(e)}(\\mathbf{n}(t)) = \\sum_{d=1}^{K} \\lambda_{C,d}^{(e)}(\\mathbf{n}(t)) + \\sum_{d=1}^{K} \\sum_{d'=1, d' \\neq d}^{K} \\lambda_{M,d \\to d'}^{(e)}(\\mathbf{n}(t))\n$$\nwhere the coalescence hazard in deme $d$ is $\\lambda_{C,d}^{(e)}(\\mathbf{n}(t)) = \\binom{n_d(t)}{2} / (2 N_d^{(e)})$ and the migration hazard for a specific lineage to move from deme $d$ to $d'$ is not explicitly used but the total rate for any of the $n_d(t)$ lineages to migrate from $d$ to $d'$ is $\\lambda_{M,d \\to d'}^{(e)}(\\mathbf{n}(t)) = n_d(t) m_{d \\to d'}^{(e)}$.\nThe simulation employs thinning, where a simpler, dominating homogeneous Poisson process with rate $M^{(e)}$ generates proposals, which are then accepted or rejected to recover the correct non-homogeneous process.\n\nFirst, an explicit algorithm for simulating the genealogy back in time until the Most Recent Common Ancestor (MRCA) is formulated.\n\n**Algorithm for Simulation via Thinning**\n\nLet the current simulation time be $t_{curr}$ and the current state be $\\mathbf{n}_{curr} = (n_{1,curr}, \\dots, n_{K,curr})$.\n\n1.  **Initialization**:\n    -   Set current time $t_{curr} \\leftarrow 0$.\n    -   Set initial state $\\mathbf{n}_{curr}$ based on the sampling configuration at the present time ($t=0$).\n    -   Set the current epoch index $e \\leftarrow 1$.\n    -   The total number of lineages is $N_{total} = \\sum_{d=1}^K n_{d,curr}$.\n\n2.  **Main Simulation Loop**: While $N_{total} > 1$:\n\n    a. **Epoch Setup**:\n       -   Let the current epoch be $e$, with time interval $[\\tau_{e-1}, \\tau_e)$ and parameters $\\big\\{N_{d}^{(e)}\\big\\}$, $\\big\\{m_{d \\to d'}^{(e)}\\big\\}$.\n       -   Compute the true total hazard rate based on the current state: $\\lambda_{curr} \\leftarrow \\lambda^{(e)}(\\mathbf{n}_{curr})$.\n       -   A crucial property of this model is that the total hazard rate $\\lambda^{(e)}(\\mathbf{n})$ is a non-decreasing function of the number of lineages in each deme. As coalescence events reduce the number of lineages, the hazard rate will not increase within an epoch. Thus, we can set the constant dominating rate for the entire epoch $e$ to be the hazard rate calculated at the start of the epoch:\n         $M^{(e)} \\leftarrow \\lambda^{(e)}(\\mathbf{n}(\\tau_{e-1}))$. This satisfies the condition $M^{(e)} \\geq \\lambda^{(e)}(\\mathbf{n}(t))$ for all $t$ within the epoch. For the first step within the epoch, $\\lambda_{curr}$ is equal to this $M^{(e)}$.\n\n    b. **Time-to-Next-Proposal Loop**:\n       i.  Generate a proposed waiting time $\\Delta t$ from the dominating homogeneous Poisson process: $\\Delta t \\sim \\text{Exponential}(M^{(e)})$.\n       ii. Calculate the proposed event time: $t_{prop} \\leftarrow t_{curr} + \\Delta t$.\n\n    c. **Boundary and Acceptance Check**:\n       i.  **Epoch Boundary Crossing**: If $t_{prop} \\geq \\tau_e$:\n           -   No event occurs in the interval $[t_{curr}, \\tau_e)$.\n           -   Advance time to the epoch boundary: $t_{curr} \\leftarrow \\tau_e$.\n           -   Advance to the next epoch: $e \\leftarrow e + 1$.\n           -   If $e > E$, the process becomes homogeneous. Set $\\tau_e \\to \\infty$.\n           -   Return to step 2a to set up for the new epoch.\n\n       ii. **Within-Epoch Proposal**: If $t_{prop} < \\tau_e$:\n           -   This is a candidate event. The acceptance probability is the ratio of the true rate to the dominating rate.\n           -   Generate a random number $U \\sim \\text{Uniform}(0, 1)$.\n           -   If $U < \\lambda_{curr} / M^{(e)}$:\n               -   **Accept Event**: The proposed event is accepted. Advance time: $t_{curr} \\leftarrow t_{prop}$. Proceed to step 2d to determine the event type and update the state. After the state update, return to step 2a.\n           -   Else ($U \\geq \\lambda_{curr} / M^{(e)}$):\n               -   **Reject Event (Thinning)**: The proposal is a \"null\" event. The state $\\mathbf{n}_{curr}$ does not change.\n               -   Advance time: $t_{curr} \\leftarrow t_{prop}$.\n               -   Return to step 2b to generate the next proposal from this new time, using the same rates $\\lambda_{curr}$ and $M^{(e)}$, as the state has not changed.\n\n    d. **Event Type Selection and State Update** (only if an event is accepted):\n       i.  An event has occurred at time $t_{curr}$. We must select its type. The probability of any specific event is its rate divided by the total rate $\\lambda_{curr}$.\n       ii. Construct a list of all possible events and their rates:\n           -   Coalescence in deme $d$ (for each $d$ with $n_{d,curr} \\geq 2$): rate is $\\binom{n_{d,curr}}{2} / (2 N_d^{(e)})$.\n           -   Migration from deme $d$ to $d'$ (for each pair $d, d'$ with $d \\neq d'$ and $n_{d,curr} \\geq 1$): rate is $n_{d,curr} m_{d \\to d'}^{(e)}$.\n       iii. Select one event from this list, with probability proportional to its rate. This can be done by drawing a random number $V \\sim \\text{Uniform}(0, \\lambda_{curr})$ and identifying which event's cumulative rate interval contains $V$.\n       iv. Update the state vector $\\mathbf{n}_{curr}$ according to the selected event:\n           -   If coalescence in deme $d$: $n_{d,curr} \\leftarrow n_{d,curr} - 1$.\n           -   If migration from $d$ to $d'$: $n_{d,curr} \\leftarrow n_{d,curr} - 1$ and $n_{d',curr} \\leftarrow n_{d',curr} + 1$.\n       v.  Update the total number of lineages $N_{total}$.\n       vi. Return to the beginning of the main loop (step 2) to simulate the next event.\n\n3.  **Termination**: The loop in step 2 terminates when $N_{total} = 1$. The simulation is complete, and the time $t_{curr}$ is the time to the MRCA.\n\nNext, the derivation for the expected acceptance rate is presented.\n\n**Derivation of the Expected Acceptance Rate**\n\nWe are asked for the expected acceptance rate of the thinning procedure within a single epoch $e$, before the first accepted event occurs.\nLet the epoch begin at time $\\tau_{e-1}$ with a fixed state $\\mathbf{n}^{(e)} = (n_1^{(e)}, \\dots, n_K^{(e)})$.\nThe problem specifies that until the first accepted event, the state remains $\\mathbf{n}^{(e)}$. Consequently, the true total hazard rate is constant over this period. Let this constant rate be denoted by $\\lambda$. It is the sum of all possible event rates for the state $\\mathbf{n}^{(e)}$ and parameters of epoch $e$:\n$$\n\\lambda = \\sum_{d=1}^{K} \\frac{\\binom{n_{d}^{(e)}}{2}}{2 N_{d}^{(e)}} + \\sum_{d=1}^{K} n_{d}^{(e)} \\sum_{d'=1, d' \\neq d}^{K} m_{d \\to d'}^{(e)}\n$$\nThe simulation uses a dominating homogeneous Poisson process for proposals with a constant rate $M^{(e)}$ satisfying $M^{(e)} \\geq \\lambda$. The thinning procedure accepts each proposal independently with a probability $p_{accept}$:\n$$\np_{accept} = \\frac{\\lambda}{M^{(e)}}\n$$\nThe \"expected acceptance rate\" refers to the expected number of accepted events per unit of time. This is the intensity (rate) of the thinned Poisson process of accepted events. From the first principles of Poisson processes, we can derive this rate.\n\nConsider a small time interval $(t, t+dt]$. The probability of a proposal from the dominating process occurring in this interval is approximately $M^{(e)} dt$. The probability of more than one proposal is of order $o(dt)$ and can be ignored.\n$$\nP(\\text{proposal in } (t, t+dt]) = M^{(e)} dt + o(dt)\n$$\nGiven that a proposal occurs, it is accepted with probability $p_{accept} = \\lambda / M^{(e)}$. Since the acceptance is independent of the timing of the proposal, we have:\n$$\nP(\\text{accepted event in } (t, t+dt]) = P(\\text{proposal in } (t, t+dt]) \\times p_{accept}\n$$\n$$\nP(\\text{accepted event in } (t, t+dt]) = (M^{(e)} dt) \\times \\left(\\frac{\\lambda}{M^{(e)}}\\right) + o(dt) = \\lambda dt + o(dt)\n$$\nThis result shows that the accepted events form a Poisson process with a constant rate $\\lambda$. The rate of a Poisson process is precisely the expected number of events per unit time. Therefore, the expected acceptance rate is $\\lambda$. It is notable that this rate is independent of the choice of the dominating rate $M^{(e)}$, which is a fundamental property of the thinning algorithm: it correctly recovers the true underlying process rate.\n\nThe final expression is the formula for $\\lambda$. The combinatorial term $\\binom{n_{d}^{(e)}}{2}$ is expanded as $\\frac{n_{d}^{(e)}(n_{d}^{(e)}-1)}{2}$. Substituting this into the expression for $\\lambda$:\n$$\n\\lambda = \\sum_{d=1}^{K} \\frac{\\frac{n_{d}^{(e)}(n_{d}^{(e)}-1)}{2}}{2 N_{d}^{(e)}} + \\sum_{d=1}^{K} n_{d}^{(e)} \\sum_{d'=1, d' \\neq d}^{K} m_{d \\to d'}^{(e)}\n$$\n$$\n\\lambda = \\sum_{d=1}^{K} \\left( \\frac{n_{d}^{(e)}(n_{d}^{(e)}-1)}{4 N_{d}^{(e)}} + n_{d}^{(e)} \\sum_{d'=1, d' \\neq d}^{K} m_{d \\to d'}^{(e)} \\right)\n$$\nThis is the closed-form analytic expression for the expected acceptance rate.", "answer": "$$\\boxed{\\sum_{d=1}^{K} \\left( \\frac{n_{d}^{(e)}(n_{d}^{(e)}-1)}{4 N_{d}^{(e)}} + n_{d}^{(e)} \\sum_{d'=1, d' \\neq d}^{K} m_{d \\to d'}^{(e)} \\right)}$$", "id": "2753776"}]}