{"hands_on_practices": [{"introduction": "To model how a species' geographic range evolves through time, we must first build the mathematical \"engine\" that drives these changes. In historical biogeography, this engine is the instantaneous rate matrix, denoted as $Q$, which forms the core of a continuous-time Markov chain (CTMC). This exercise will guide you through the fundamental process of constructing a $Q$ matrix from first principles, translating biological rules about dispersal ($d$) and local extinction ($e$) into the precise transition rates that govern how a lineage's range expands and contracts over evolutionary time [@problem_id:2762387].", "problem": "In the Dispersal–Extinction–Cladogenesis (DEC) model of historical biogeography, consider only anagenetic changes (within-lineage changes) on a landscape with areas $\\{A, B\\}$. Let the state space be the set of possible ranges $\\{\\varnothing, A, B, AB\\}$, where $\\varnothing$ denotes no occupied areas, $A$ and $B$ denote occupancy of a single area, and $AB$ denotes occupancy of both areas. Assume that anagenetic dispersal adds a single missing area at an instantaneous rate $d$ per missing area, and anagenetic local extinction removes a single occupied area at an instantaneous rate $e$ per occupied area. Assume that simultaneous changes are not allowed (i.e., only one area can be gained or lost at a time), that there is no transition out of the empty range $\\varnothing$ (i.e., $\\varnothing$ is absorbing with respect to anagenetic changes), and that dispersal is symmetric between areas.\n\nUsing the continuous-time Markov chain (CTMC) framework, where the instantaneous rate matrix $Q$ has off-diagonal entries given by instantaneous transition rates and diagonal entries set so that each row sums to $0$, derive the instantaneous rate matrix $Q$ for this DEC anagenetic process with the row and column order $(\\varnothing, A, B, AB)$. Explicitly list all nonzero off-diagonal entries.\n\nFinally, using your derived $Q$, compute the trace of $Q$ as a closed-form analytic expression in terms of $d$ and $e$. Report only this final expression; no numerical evaluation or rounding is required.", "solution": "The problem statement is submitted for validation.\n\nStep 1: Extract Givens.\n- Model: Dispersal–Extinction–Cladogenesis (DEC) model, considering only anagenetic (within-lineage) changes.\n- Landscape: Set of areas $\\{A, B\\}$.\n- State Space: The set of possible ranges is $\\{\\varnothing, A, B, AB\\}$, where $\\varnothing$ is no occupancy, $A$ is occupancy of area $A$, $B$ is occupancy of area $B$, and $AB$ is occupancy of both areas.\n- Dispersal Rate: Anagenetic dispersal adds a single missing area at an instantaneous rate $d$ per missing area.\n- Extinction Rate: Anagenetic local extinction removes a single occupied area at an instantaneous rate $e$ per occupied area.\n- Constraints:\n    1. Only single area changes (gain or loss) are allowed at a time; simultaneous changes are not.\n    2. The empty range $\\varnothing$ is an absorbing state with respect to anagenetic changes.\n    3. Dispersal is symmetric between areas.\n- Framework: Continuous-time Markov chain (CTMC).\n- Instantaneous Rate Matrix $Q$: Off-diagonal entries $Q_{ij}$ ($i \\neq j$) are the instantaneous transition rates from state $i$ to state $j$. Diagonal entries $Q_{ii}$ are set such that each row sums to $0$.\n- Matrix Order: The rows and columns of $Q$ are ordered as $(\\varnothing, A, B, AB)$.\n- Task 1: Derive the instantaneous rate matrix $Q$.\n- Task 2: Explicitly list all nonzero off-diagonal entries of $Q$.\n- Task 3: Compute the trace of $Q$, $\\text{tr}(Q)$, as a closed-form analytic expression.\n\nStep 2: Validate Using Extracted Givens.\n- Scientific Grounding: The problem is grounded in established theory. The DEC model and its representation as a continuous-time Markov chain are standard, fundamental tools in the field of historical biogeography and computational phylogenetics. The model setup is a simplified but valid representation of range evolution processes.\n- Well-Posedness: The problem is well-posed. The rules for constructing the transition rates are explicit and sufficient to uniquely determine all entries of the rate matrix $Q$. The calculation of the trace is a well-defined mathematical operation on the resulting matrix.\n- Objectivity: The problem is stated in precise, objective, and quantitative terms. No subjective or opinion-based claims are present.\n\nStep 3: Verdict and Action.\nThe problem is valid. It is a standard exercise in applying the principles of CTMCs to a biological model. Proceeding to solution.\n\nThe problem requires the construction of the $4 \\times 4$ instantaneous rate matrix $Q$ for a CTMC describing anagenetic range evolution. The states are ordered as $S_1 = \\varnothing$, $S_2 = A$, $S_3 = B$, and $S_4 = AB$. The entry $Q_{ij}$ for $i \\neq j$ represents the instantaneous rate of transition from state $i$ to state $j$. The diagonal entry $Q_{ii}$ is the negative sum of all rates leaving state $i$.\n\nWe construct the matrix row by row.\n\nRow 1: Transitions from state $S_1 = \\varnothing$.\nThe problem states that $\\varnothing$ is an absorbing state. This means no lineages can arise from nothing (no transitions out of $\\varnothing$).\nTherefore, all off-diagonal rates are zero:\n$Q_{12} = 0$, $Q_{13} = 0$, $Q_{14} = 0$.\nThe diagonal element is $Q_{11} = -(Q_{12} + Q_{13} + Q_{14}) = 0$.\n\nRow 2: Transitions from state $S_2 = A$.\n- To $S_1 = \\varnothing$: This is an extinction event. State $A$ has $1$ occupied area. The rate is $e$ per occupied area. Thus, the rate of losing this single area is $1 \\times e = e$. So, $Q_{21} = e$.\n- To $S_3 = B$: This transition would require losing area $A$ and gaining area $B$ simultaneously. The problem forbids simultaneous changes. So, $Q_{23} = 0$.\n- To $S_4 = AB$: This is a dispersal event. State $A$ is missing $1$ area ($B$). The rate is $d$ per missing area. Thus, the rate of gaining area $B$ is $1 \\times d = d$. So, $Q_{24} = d$.\nThe diagonal element is $Q_{22} = -(Q_{21} + Q_{23} + Q_{24}) = -(e + 0 + d) = -(d+e)$.\n\nRow 3: Transitions from state $S_3 = B$.\n- To $S_1 = \\varnothing$: This is an extinction event. State $B$ has $1$ occupied area. The rate is $e$ per occupied area. Thus, the rate of losing this area is $1 \\times e = e$. So, $Q_{31} = e$.\n- To $S_2 = A$: As with $A \\to B$, this transition requires a simultaneous loss and gain, which is not allowed. So, $Q_{32} = 0$.\n- To $S_4 = AB$: This is a dispersal event. State $B$ is missing $1$ area ($A$). The rate is $d$ per missing area. Thus, the rate of gaining area $A$ is $1 \\times d = d$. So, $Q_{34} = d$.\nThe diagonal element is $Q_{33} = -(Q_{31} + Q_{32} + Q_{34}) = -(e + 0 + d) = -(d+e)$.\n\nRow 4: Transitions from state $S_4 = AB$.\n- To $S_1 = \\varnothing$: This requires losing $2$ areas simultaneously, which is not allowed. So, $Q_{41} = 0$.\n- To $S_2 = A$: This is an extinction event, where area $B$ is lost. State $AB$ has $2$ occupied areas. The rate of extinction is $e$ per area. The rate for the specific event of losing area $B$ is $e$. So, $Q_{42} = e$.\n- To $S_3 = B$: This is an extinction event, where area $A$ is lost. The rate for the specific event of losing area $A$ is $e$. So, $Q_{43} = e$.\n- The total rate of leaving state $AB$ is the sum of rates of all possible single-change events. Dispersal is impossible as no areas are missing. Extinction can occur by losing $A$ (rate $e$) or losing $B$ (rate $e$). The total rate out is thus $e+e=2e$.\nThe diagonal element is $Q_{44} = -(Q_{41} + Q_{42} + Q_{43}) = -(0 + e + e) = -2e$.\n\nAssembling these elements gives the complete instantaneous rate matrix $Q$:\n$$\nQ = \\begin{pmatrix}\n0  0  0  0 \\\\\ne  -(d+e)  0  d \\\\\ne  0  -(d+e)  d \\\\\n0  e  e  -2e\n\\end{pmatrix}\n$$\n\nThe problem requires a list of all nonzero off-diagonal entries. These are:\n- $Q_{21} = e$ (extinction from $A$)\n- $Q_{24} = d$ (dispersal from $A$)\n- $Q_{31} = e$ (extinction from $B$)\n- $Q_{34} = d$ (dispersal from $B$)\n- $Q_{42} = e$ (extinction from $AB$ to $A$)\n- $Q_{43} = e$ (extinction from $AB$ to $B$)\n\nFinally, we must compute the trace of $Q$, denoted $\\text{tr}(Q)$. The trace is the sum of the diagonal elements of the matrix.\n$$\n\\text{tr}(Q) = Q_{11} + Q_{22} + Q_{33} + Q_{44}\n$$\nSubstituting the derived values:\n$$\n\\text{tr}(Q) = 0 + \\left(-(d+e)\\right) + \\left(-(d+e)\\right) + \\left(-2e\\right)\n$$\n$$\n\\text{tr}(Q) = -d - e - d - e - 2e\n$$\n$$\n\\text{tr}(Q) = -2d - 4e\n$$\nThis is the required closed-form analytic expression for the trace of the matrix $Q$.", "answer": "$$\n\\boxed{-2d - 4e}\n$$", "id": "2762387"}, {"introduction": "Biogeographic models are most powerful when they are grounded in the physical reality of our planet's history. A naive model that ignores geology can produce inferences that are nonsensical, such as a species inhabiting an island millions of years before it existed. This practice presents a common scenario where a model's conclusion clashes with geological fact, challenging you to diagnose the error and apply the correct solution using time-stratification [@problem_id:2762446]. This exercise hones your critical thinking skills, demonstrating how to integrate external data to ensure your evolutionary reconstructions are both statistically sound and historically plausible.", "problem": "A researcher is fitting a time-inhomogeneous continuous-time Markov chain (CTMC) model of geographic range evolution to a clade distributed across two areas: a continental mainland $M$ and an oceanic island $I$. In the model, transitions between ranges are driven by a time-dependent dispersal rate $d(t)$ and a time-dependent adjacency matrix $\\mathbf{A}(t)$ that encodes whether two areas are geographically connected or reachable at time $t$ (time measured in millions of years before present, in Ma). The researcher initially fits an unstratified model that assumes a constant dispersal rate $d(t)=d$ and time-invariant full adjacency $\\mathbf{A}(t)=\\mathbf{1}$, while keeping extinction rate $e$ constant across time.\n\nKnown geology of the system is as follows: the oceanic island $I$ is volcanic and first emerged above sea level at $3$ Ma, while the mainland $M$ has been continuously present. A well-calibrated molecular phylogeny shows that the crown divergence of two sister lineages in this clade occurred at $8$ Ma; today, one lineage is endemic to $I$ and the other is endemic to $M$.\n\nUnder the unstratified fit, the maximum-likelihood ancestral range at the $8$ Ma node is inferred to be $M+I$ (simultaneous occupancy of both areas). This inference contradicts the geological record.\n\nWhich option correctly identifies the contradiction and describes the appropriate correction once $d(t)$ is constrained by adjacency changes imposed by geology?\n\nA. The contradiction is that vicariance at $8$ Ma requires a preexisting land bridge that never existed. The correction is to increase the extinction rate $e$ for $t3$ Ma so that $I$ is lost rapidly after emergence; no constraints on $d(t)$ or $\\mathbf{A}(t)$ are needed.\n\nB. The contradiction is that the inference places $I$ in the ancestral range at $8$ Ma even though $I$ did not exist until $3$ Ma. The correction is to time-stratify by setting dispersal multipliers $m_{MI}(t)=0$ in $\\mathbf{A}(t)$ for $t3$ Ma (i.e., before $I$ emerged), which forces $d_{MI}(t)=d\\cdot m_{MI}(t)=0$ then; this prohibits occupancy or dispersal into $I$ prior to $3$ Ma, yielding an ancestral range of $M$ at $8$ Ma and a subsequent post-$3$ Ma dispersal into $I$ along the island lineage.\n\nC. The contradiction is that the model allows extinction on $M$ before $3$ Ma. The correction is to set $e(t)=0$ for $t3$ Ma so that lineages cannot go extinct on $M$ before the island appears; $d(t)$ should instead be increased for $t3$ Ma to encourage early colonization of $I$.\n\nD. The contradiction is that the model fails to allow founder-event speciation at $8$ Ma. The correction is to force a vicariant split at $8$ Ma with $M$ and $I$ as daughter ranges by setting $d(t)$ very high for $t8$ Ma, because high $d(t)$ makes all splits effectively vicariant irrespective of adjacency.", "solution": "The problem will first be subject to rigorous validation.\n\n**Step 1: Extract Givens**\n-   Model type: Time-inhomogeneous continuous-time Markov chain (CTMC).\n-   Geographic areas: Mainland $M$ and oceanic island $I$.\n-   Model parameters: Time-dependent dispersal rate $d(t)$, time-dependent adjacency matrix $\\mathbf{A}(t)$, and a constant extinction rate $e$.\n-   Time scale: $t$ is measured in millions of years before present (Ma).\n-   Unstratified model assumptions: $d(t) = d$ (constant), $\\mathbf{A}(t) = \\mathbf{1}$ (full adjacency, where $\\mathbf{1}$ is a matrix of ones), and $e$ is constant.\n-   Geological data: Island $I$ emerged at $3$ Ma. Mainland $M$ has been continuously present.\n-   Phylogenetic data: A crown divergence of two sister lineages occurs at $8$ Ma. One lineage is endemic to $I$, the other to $M$.\n-   Result from unstratified model: The maximum-likelihood ancestral range at the $8$ Ma node is inferred to be $M+I$.\n-   Premise: The inference of range $M+I$ at $8$ Ma contradicts the geological record.\n-   Objective: Identify the correct statement of the contradiction and the appropriate correction to the model by constraining $d(t)$ via geological information about adjacency.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem statement is scientifically grounded, well-posed, and objective.\n-   **Scientific Grounding**: The problem uses standard concepts and models from historical biogeography and phylogenetics. CTMC models, such as the Dispersal-Extinction-Cladogenesis (DEC) model and its extensions, are a primary tool for ancestral range estimation. The scenario presented—a conflict between a naive model's inference and external geological data—is a common and realistic problem in scientific modeling that necessitates model refinement.\n-   **Well-Posedness**: The problem is clearly structured. It provides a set of initial conditions, a model, an observation (the phylogenetic pattern), a conflicting result from a simple model, and verifiable external data (geology). It asks for a logical resolution within the established framework, which is a well-defined task. The question leads to a unique, conceptually sound answer.\n-   **Objectivity and Clarity**: The terminology is precise and standard within the field (e.g., CTMC, ancestral range, time-stratification, adjacency matrix). There are no ambiguities or subjective statements.\n-   **Consistency and Completeness**: All necessary information is provided. The contradiction arises from the application of a model, not from an internal inconsistency in the problem's premises. The premises (phylogeny, geology, model result) are coherent for the purpose of the question being asked.\n\n**Step 3: Verdict and Action**\nThe problem statement is valid. I will proceed to derive the solution.\n\nThe core of the problem lies in the conflict between the biogeographic model's output and established geological fact. The unstratified model, by assuming a constant dispersal rate $d$ and time-invariant full adjacency $\\mathbf{A}(t) = \\mathbf{1}$, operates in ignorance of geological history. This model \"believes\" that area $I$ has always existed and has always been reachable from area $M$.\n\nThe specific contradiction is a direct violation of physical reality. The model infers the ancestral range at $8$ Ma to be $M+I$. This implies that the ancestral lineage occupied the oceanic island $I$ at a time $8$ million years ago. However, the geological data state that island $I$ did not exist at that time; it only emerged from the sea at $3$ Ma. It is a physical impossibility for a terrestrial or freshwater organism to occupy a landmass that does not exist. The inference is therefore factually incorrect and absurd.\n\nThe correction must involve incorporating the geological information into the CTMC model to prevent such impossible inferences. In this modeling framework, the rate of dispersal between two areas (e.g., from $M$ to $I$) is modulated by the adjacency matrix $\\mathbf{A}(t)$. The effective dispersal rate is typically calculated as the product of a base rate and a multiplier from the adjacency matrix. Let $d_{MI}(t)$ be the rate of dispersal from $M$ to $I$ at time $t$. This is given by $d_{MI}(t) = d(t) \\cdot m_{MI}(t)$, where $m_{MI}(t)$ is the corresponding element in $\\mathbf{A}(t)$.\n\nTo model the geological reality, one must use a time-stratified approach. The geological history is divided into epochs or time bins. For any time $t$ before the island's emergence (i.e., for $t > 3$ Ma), island $I$ is inaccessible. This is enforced in the model by setting the dispersal multiplier for any route leading to $I$ to zero. Consequently, for all $t > 3$ Ma, the multiplier $m_{MI}(t)$ must be set to $0$. This forces the effective dispersal rate into $I$ to be $d_{MI}(t) = d(t) \\cdot 0 = 0$.\n\nBy correctly parameterizing the adjacency matrix $\\mathbf{A}(t)$ to reflect geological history, the model is constrained so that the probability of any range that includes $I$ is zero for any time $t > 3$ Ma. The likelihood of the $M+I$ ancestral range at $8$ Ma becomes $0$. The model will then correctly infer that the ancestral range at $8$ Ma must have been a range that existed at that time, which, given the descendant distributions, is most parsimoniously $M$. The current distribution is then explained by a subsequent dispersal event from mainland $M$ to island $I$ by a member of the relevant lineage at some time $t  3$ Ma, after the island had formed.\n\nNow, I will evaluate each option.\n\nA. The contradiction is that vicariance at $8$ Ma requires a preexisting land bridge that never existed. The correction is to increase the extinction rate $e$ for $t3$ Ma so that $I$ is lost rapidly after emergence; no constraints on $d(t)$ or $\\mathbf{A}(t)$ are needed.\nThis option is incorrect. The primary contradiction is not about a land bridge, but about the very existence of area $I$. A range of $M+I$ is impossible at $8$ Ma regardless of connectivity. The proposed correction is nonsensical. An increased extinction rate *on* the island would make colonization more difficult, not explain its current occupation. The timeframe $t  3$ Ma is *before* emergence, and the phrase \"after emergence\" corresponds to $t  3$ Ma. The entire statement is confused in its logic and timing. **Incorrect**.\n\nB. The contradiction is that the inference places $I$ in the ancestral range at $8$ Ma even though $I$ did not exist until $3$ Ma. The correction is to time-stratify by setting dispersal multipliers $m_{MI}(t)=0$ in $\\mathbf{A}(t)$ for $t3$ Ma (i.e., before $I$ emerged), which forces $d_{MI}(t)=d\\cdot m_{MI}(t)=0$ then; this prohibits occupancy or dispersal into $I$ prior to $3$ Ma, yielding an ancestral range of $M$ at $8$ Ma and a subsequent post-$3$ Ma dispersal into $I$ along the island lineage.\nThis option is entirely correct. It accurately states the fundamental contradiction: inferring occupation of a non-existent location. The proposed correction is precisely the standard and correct methodology for incorporating such geological constraints into a CTMC biogeographic model. By setting the dispersal multiplier to $0$ for the time period before the island existed ($t > 3$ Ma), it makes it impossible for the model to infer presence on the island during that time. This forces a more plausible scenario: an ancestor in range $M$ at $8$ Ma, followed by a later dispersal to $I$ after its formation. **Correct**.\n\nC. The contradiction is that the model allows extinction on $M$ before $3$ Ma. The correction is to set $e(t)=0$ for $t3$ Ma so that lineages cannot go extinct on $M$ before the island appears; $d(t)$ should instead be increased for $t3$ Ma to encourage early colonization of $I$.\nThis option is incorrect. There is no contradiction in allowing extinction on the mainland $M$; this is a natural process. The proposed correction is arbitrary and biologically unjustified. Setting $e(t)=0$ is a severe constraint with no basis in the problem description. Increasing $d(t)$ for $t3$ Ma is futile for colonizing island $I$, as the island does not exist during that time period. This option misidentifies the problem and proposes an illogical solution. **Incorrect**.\n\nD. The contradiction is that the model fails to allow founder-event speciation at $8$ Ma. The correction is to force a vicariant split at $8$ Ma with $M$ and $I$ as daughter ranges by setting $d(t)$ very high for $t8$ Ma, because high $d(t)$ makes all splits effectively vicariant irrespective of adjacency.\nThis option is incorrect. First, the contradiction is not that the model \"fails to allow\" a certain speciation mode, but that its inference is factually impossible. Second, the proposed correction is the opposite of what is required; it attempts to \"force\" the very scenario ($M+I$ range at $8$ Ma leading to a split) that is geologically impossible. Third, the theoretical justification provided is false: high dispersal rates $d(t)$ work *against* range fragmentation and vicariance by increasing sympatry and gene flow, they do not cause vicariance. This statement reveals a fundamental misunderstanding of biogeographic processes and models. **Incorrect**.", "answer": "$$\\boxed{B}$$", "id": "2762446"}, {"introduction": "Observing a biogeographic pattern—for instance, that many sister species are found in separate, disjunct areas—is only the first step of a scientific inquiry. The critical next step is to ask whether this pattern is statistically significant or if it could have arisen simply by chance. This coding exercise walks you through the implementation of a null model using a permutation test, a cornerstone of statistical hypothesis testing in evolution [@problem_id:2762450]. By completing this practice, you will learn how to move from a qualitative observation to a quantitative conclusion, armed with a $p$-value to formally assess your hypothesis.", "problem": "You are given a fixed rooted bifurcating phylogeny with a labeled tip set and an observed presence–absence assignment of biogeographic areas to each tip. Let the tip set be $\\{0,1,\\dots,n-1\\}$, and let the finite set of areas be $\\mathcal{A}=\\{0,1,\\dots,m-1\\}$. For each tip $i\\in\\{0,\\dots,n-1\\}$, the observed range is a subset $S_i\\subseteq \\mathcal{A}$, and its range size is $r_i=|S_i|$. A pair of tips $(a,b)$ is a sister pair if and only if their most recent common ancestor has exactly these two tips as its direct children. In a strictly bifurcating tree, sister pairs are exactly the cherries, i.e., internal nodes with two tip children.\n\nDefine the statistic $D$ as the number of sister pairs with disjoint ranges:\n$$\nD=\\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}\\big(S_a\\cap S_b=\\varnothing\\big),\n$$\nwhere $\\mathrm{Cherries}(T)$ is the set of sister pairs in the fixed tree $T$ and $\\mathbf{1}(\\cdot)$ is the indicator function.\n\nYou must implement a null model that randomizes tip area labels across the fixed phylogeny while preserving the exact range size at each tip. Formally, under the null, for each tip $i$, draw a new range $S_i'$ uniformly at random from the set of all subsets of $\\mathcal{A}$ of cardinality $r_i$, independently across tips. This preserves $r_i$ for all $i$ while removing any phylogenetic signal in the identity of areas. For each randomization $k\\in\\{1,\\dots,N_{\\mathrm{sim}}\\}$, compute\n$$\nD^{(k)}=\\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}\\big(S_a^{\\prime(k)}\\cap S_b^{\\prime(k)}=\\varnothing\\big).\n$$\n\nGiven the observed $D_{\\mathrm{obs}}$ from the data and the simulated values $\\{D^{(k)}\\}_{k=1}^{N_{\\mathrm{sim}}}$, compute one-sided Monte Carlo $p$-values using the plus-one correction:\n$$\np_{\\mathrm{upper}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\ge D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1},\\qquad\np_{\\mathrm{lower}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\le D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1}.\n$$\nHere $p_{\\mathrm{upper}}$ tests for an excess of sister pairs in different areas compared to the null, and $p_{\\mathrm{lower}}$ tests for a deficit.\n\nYour task is to write a complete program that, for the following test suite, computes $\\big(p_{\\mathrm{upper}},p_{\\mathrm{lower}}\\big)$ for each case. Use the exact random seed $1729$ for the first test case and increment by $1$ for each subsequent test case (i.e., seeds $1729,1730,1731,1732$). For each test case, use $N_{\\mathrm{sim}}=10000$ null randomizations.\n\nRepresent each tree by its set of directed parent-to-children relations $(u\\to v,w)$, where $u$ is an internal node and $(v,w)$ are its two children. Tips are always indexed from $0$ to $n-1$, and internal nodes have indices $n,n+1,\\dots$. The cherries are exactly those $(v,w)$ pairs that appear as children of some internal node $u$ where both $v$ and $w$ are tips in $\\{0,\\dots,n-1\\}$.\n\nTest suite:\n\n- Test case $1$:\n  - Areas: $m=3$ so $\\mathcal{A}=\\{0,1,2\\}$.\n  - Tree edges: $(4\\to 0,1)$, $(5\\to 2,3)$, $(6\\to 4,5)$.\n  - Tip ranges: $S_0=\\{0\\}$, $S_1=\\{0\\}$, $S_2=\\{1\\}$, $S_3=\\{2\\}$.\n  - Simulations: $N_{\\mathrm{sim}}=10000$.\n  - Seed: $1729$.\n\n- Test case $2$:\n  - Areas: $m=4$ so $\\mathcal{A}=\\{0,1,2,3\\}$.\n  - Tree edges: $(6\\to 0,1)$, $(7\\to 2,3)$, $(8\\to 4,5)$, $(9\\to 6,7)$, $(10\\to 8,9)$.\n  - Tip ranges: $S_0=\\{0,1\\}$, $S_1=\\{1,2\\}$, $S_2=\\{0\\}$, $S_3=\\{1\\}$, $S_4=\\{1,2,3\\}$, $S_5=\\{0\\}$.\n  - Simulations: $N_{\\mathrm{sim}}=10000$.\n  - Seed: $1730$.\n\n- Test case $3$:\n  - Areas: $m=2$ so $\\mathcal{A}=\\{0,1\\}$.\n  - Tree edges: $(4\\to 0,1)$, $(5\\to 2,3)$, $(6\\to 4,5)$.\n  - Tip ranges: $S_0=\\{0\\}$, $S_1=\\{0,1\\}$, $S_2=\\{1\\}$, $S_3=\\{1\\}$.\n  - Simulations: $N_{\\mathrm{sim}}=10000$.\n  - Seed: $1731$.\n\n- Test case $4$:\n  - Areas: $m=3$ so $\\mathcal{A}=\\{0,1,2\\}$.\n  - Tree edges: $(4\\to 0,1)$, $(5\\to 2,3)$, $(6\\to 4,5)$.\n  - Tip ranges: $S_0=\\{0\\}$, $S_1=\\{1\\}$, $S_2=\\{1\\}$, $S_3=\\{2\\}$.\n  - Simulations: $N_{\\mathrm{sim}}=10000$.\n  - Seed: $1732$.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case contributes a two-element list $[p_{\\mathrm{upper}},p_{\\mathrm{lower}}]$ with both numbers rounded to $6$ decimal places. For example, the output should have the form\n  $$\n  \\big[[p_{\\mathrm{upper},1},p_{\\mathrm{lower},1}],[p_{\\mathrm{upper},2},p_{\\mathrm{lower},2}],[p_{\\mathrm{upper},3},p_{\\mathrm{lower},3}],[p_{\\mathrm{upper},4},p_{\\mathrm{lower},4}]\\big].\n  $$\nNo physical units or angles are involved in this problem. All numerical answers must be printed as decimal fractions (not percentages).", "solution": "The user has submitted a problem for validation and solution. The problem is assessed to be valid.\n\n### Problem Validation\n\nA thorough validation of the problem statement is conducted as per protocol.\n\n#### Step 1: Extract Givens\n\nThe following data and definitions are explicitly provided:\n-   A fixed rooted bifurcating phylogeny $T$ with a tip set $\\{0,1,\\dots,n-1\\}$.\n-   A finite set of biogeographic areas $\\mathcal{A}=\\{0,1,\\dots,m-1\\}$.\n-   For each tip $i$, an observed range $S_i\\subseteq \\mathcal{A}$ with size $r_i=|S_i|$.\n-   A sister pair $(a,b)$ is defined as the two tip children of a common internal node (a cherry).\n-   The statistic of interest is $D$, the number of sister pairs with disjoint ranges:\n    $$\n    D=\\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}\\big(S_a\\cap S_b=\\varnothing\\big)\n    $$\n-   A null model is specified: for each tip $i$, a new range $S_i'$ is drawn uniformly at random from all subsets of $\\mathcal{A}$ of cardinality $r_i$, independently across all tips.\n-   The simulated statistic for randomization $k$ is:\n    $$\n    D^{(k)}=\\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}\\big(S_a^{\\prime(k)}\\cap S_b^{\\prime(k)}=\\varnothing\\big)\n    $$\n-   The number of simulations is $N_{\\mathrm{sim}}$.\n-   One-sided Monte Carlo $p$-values are to be computed with a plus-one correction:\n    $$\n    p_{\\mathrm{upper}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\ge D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1},\\qquad\n    p_{\\mathrm{lower}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\le D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1}\n    $$\n-   The tree is represented by parent-to-children relations $(u\\to v,w)$. Tips are indexed $\\{0,\\dots,n-1\\}$.\n-   A test suite of four cases is provided, each specifying the number of areas $m$, tree edges, tip ranges, $N_{\\mathrm{sim}}=10000$, and a specific random seed for reproducibility.\n-   A specific output format for the results is mandated.\n\n#### Step 2: Validate Using Extracted Givens\n\nThe problem statement is evaluated against the validation criteria:\n\n-   **Scientific Groundedness**: The problem is scientifically sound. It describes a permutation test, a standard statistical method in computational biology, applied to a classic question in phylogeography concerning the spatial distribution of sister species. The null model is a well-established method for testing hypotheses about phylogenetic trait evolution. The problem is free of pseudoscience and factual errors.\n-   **Well-Posedness**: The problem is well-posed. All required parameters, data, and definitions are provided for each test case. The objective is clearly stated, and the computational procedure is algorithmically specified, guaranteeing that a unique solution exists for each test case (given the fixed random seed).\n-   **Objectivity**: The problem is formulated in precise, objective, and mathematical language, devoid of any subjective or ambiguous statements.\n\nThe problem does not exhibit any of the invalidity flags. It is a complete, consistent, and scientifically relevant computational task.\n\n#### Step 3: Verdict and Action\n\n**Verdict**: The problem is valid.\n**Action**: Proceed to develop a complete and reasoned solution.\n\n### Solution Design\n\nThe problem requires the implementation of a Monte Carlo permutation test to calculate the statistical significance of an observed biogeographic pattern on a phylogeny. The overall procedure for each test case is as follows.\n\n1.  **Parse Input Data**: For each test case, we must parse the number of areas $m$, the tree structure, and the observed tip ranges. The number of tips, $n$, is derived from the length of the tip range list. Tree edges are given as tuples $(u, v, w)$, representing $u \\to v, w$. The tip ranges $S_i$ are given as lists and should be converted to sets for efficient intersection operations.\n\n2.  **Identify Sister Pairs (Cherries)**: A sister pair, or cherry, is an internal node whose two children are both tips. Tips are indexed from $0$ to $n-1$. We iterate through the provided tree edges $(u, v, w)$. If both children $v$ and $w$ are less than $n$, the pair $(v,w)$ constitutes a cherry. These pairs are collected into a list, $\\mathrm{Cherries}(T)$.\n\n3.  **Calculate the Observed Statistic ($D_{\\mathrm{obs}}$)**: The observed statistic, $D_{\\mathrm{obs}}$, is the number of sister pairs with disjoint geographic ranges. We iterate through the identified list of cherries. For each pair $(a,b) \\in \\mathrm{Cherries}(T)$, we check if their observed ranges $S_a$ and $S_b$ have an empty intersection, i.e., $S_a \\cap S_b = \\varnothing$. The total count of such pairs is $D_{\\mathrm{obs}}$.\n    $$\n    D_{\\mathrm{obs}} = \\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}(S_a \\cap S_b = \\varnothing)\n    $$\n\n4.  **Perform Monte Carlo Simulations**: This is the core of the null model analysis. We perform $N_{\\mathrm{sim}}$ independent simulations. For each simulation $k \\in \\{1, \\dots, N_{\\mathrm{sim}}\\}$:\n    a.  **Generate Randomized Ranges**: For each tip $i \\in \\{0, \\dots, n-1\\}$, we must generate a new, randomized range $S_i^{\\prime(k)}$. This is done by drawing a sample of size $r_i = |S_i|$ without replacement from the set of all available areas $\\mathcal{A} = \\{0, \\dots, m-1\\}$. This process is repeated independently for every tip, creating a full set of randomized ranges for the phylogeny. A seeded pseudorandom number generator is used to ensure reproducibility.\n    b.  **Calculate Simulated Statistic ($D^{(k)}$)**: Using the randomized ranges $\\{S_i^{\\prime(k)}\\}_{i=0}^{n-1}$, we calculate the statistic $D^{(k)}$ in the same way as $D_{\\mathrm{obs}}$:\n        $$\n        D^{(k)} = \\sum_{(a,b)\\in \\mathrm{Cherries}(T)} \\mathbf{1}(S_a^{\\prime(k)} \\cap S_b^{\\prime(k)} = \\varnothing)\n        $$\n    c.  **Store Result**: The value $D^{(k)}$ is stored, contributing to the null distribution of the statistic.\n\n5.  **Compute $p$-values**: After all $N_{\\mathrm{sim}}$ simulations are complete, we have a null distribution $\\{D^{(k)}\\}_{k=1}^{N_{\\mathrm{sim}}}$. We compare our observed statistic $D_{\\mathrm{obs}}$ to this distribution. The one-sided $p$-values are calculated using the provided formulas which include a \"plus-one\" correction to avoid $p$-values of $0$ and handle the case where $D_{\\mathrm{obs}}$ is more extreme than any simulated value.\n    -   The upper-tailed $p$-value, testing for an excess of disjoint sister pairs, is:\n        $$\n        p_{\\mathrm{upper}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\ge D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1}\n        $$\n    -   The lower-tailed $p$-value, testing for a deficit of disjoint sister pairs (i.e., an excess of overlapping sister pairs), is:\n        $$\n        p_{\\mathrm{lower}}=\\frac{1+\\sum_{k=1}^{N_{\\mathrm{sim}}}\\mathbf{1}(D^{(k)}\\le D_{\\mathrm{obs}})}{N_{\\mathrm{sim}}+1}\n        $$\n\nThis procedure is applied to each test case in the provided suite, using the specified parameters, to generate the final results. The implementation will use the `numpy` library for efficient random sampling.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef run_permutation_test(m, tree_edges, tip_ranges, N_sim, seed):\n    \"\"\"\n    Performs a permutation test for a single test case.\n\n    Args:\n        m (int): The total number of areas.\n        tree_edges (list of tuples): Parent-to-children relations (u, v, w).\n        tip_ranges (list of lists): Observed ranges for each tip.\n        N_sim (int): Number of simulations.\n        seed (int): Random seed for reproducibility.\n\n    Returns:\n        tuple: A tuple containing (p_upper, p_lower).\n    \"\"\"\n    num_tips = len(tip_ranges)\n    observed_ranges_sets = [set(r) for r in tip_ranges]\n    range_sizes = [len(r) for r in observed_ranges_sets]\n    all_areas = np.arange(m)\n\n    # 1. Identify sister pairs (cherries)\n    cherries = []\n    for _, child1, child2 in tree_edges:\n        if child1  num_tips and child2  num_tips:\n            cherries.append((child1, child2))\n\n    # 2. Calculate the observed statistic D_obs\n    d_obs = 0\n    for tip_a, tip_b in cherries:\n        if not observed_ranges_sets[tip_a].intersection(observed_ranges_sets[tip_b]):\n            d_obs += 1\n\n    # 3. Perform Monte Carlo simulations\n    rng = np.random.default_rng(seed)\n    d_sims = np.zeros(N_sim, dtype=int)\n\n    for k in range(N_sim):\n        # Generate randomized ranges for all tips for this simulation\n        random_ranges = []\n        for i in range(num_tips):\n            size = range_sizes[i]\n            if size > m: # Should not happen in a valid problem\n                random_subset = set()\n            else:\n                random_subset = set(rng.choice(all_areas, size=size, replace=False))\n            random_ranges.append(random_subset)\n\n        # Calculate D for this simulation\n        d_k = 0\n        for tip_a, tip_b in cherries:\n            if not random_ranges[tip_a].intersection(random_ranges[tip_b]):\n                d_k += 1\n        d_sims[k] = d_k\n\n    # 4. Compute p-values\n    # p_upper tests for D_obs being significantly large\n    count_ge = np.sum(d_sims >= d_obs)\n    p_upper = (1 + count_ge) / (N_sim + 1)\n    \n    # p_lower tests for D_obs being significantly small\n    count_le = np.sum(d_sims = d_obs)\n    p_lower = (1 + count_le) / (N_sim + 1)\n\n    return round(p_upper, 6), round(p_lower, 6)\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"m\": 3,\n            \"tree_edges\": [(4, 0, 1), (5, 2, 3), (6, 4, 5)],\n            \"tip_ranges\": [[0], [0], [1], [2]],\n            \"seed\": 1729,\n        },\n        {\n            \"m\": 4,\n            \"tree_edges\": [(6, 0, 1), (7, 2, 3), (8, 4, 5), (9, 6, 7), (10, 8, 9)],\n            \"tip_ranges\": [[0, 1], [1, 2], [0], [1], [1, 2, 3], [0]],\n            \"seed\": 1730,\n        },\n        {\n            \"m\": 2,\n            \"tree_edges\": [(4, 0, 1), (5, 2, 3), (6, 4, 5)],\n            \"tip_ranges\": [[0], [0, 1], [1], [1]],\n            \"seed\": 1731,\n        },\n        {\n            \"m\": 3,\n            \"tree_edges\": [(4, 0, 1), (5, 2, 3), (6, 4, 5)],\n            \"tip_ranges\": [[0], [1], [1], [2]],\n            \"seed\": 1732,\n        },\n    ]\n\n    N_sim = 10000\n    results = []\n\n    for case in test_cases:\n        p_upper, p_lower = run_permutation_test(\n            case[\"m\"],\n            case[\"tree_edges\"],\n            case[\"tip_ranges\"],\n            N_sim,\n            case[\"seed\"]\n        )\n        results.append([p_upper, p_lower])\n\n    # Final print statement in the exact required format.\n    # The repr() function gives a string representation of the list,\n    -    # and we remove spaces to match the compact format.\n    print(repr(results).replace(\" \", \"\"))\n\nsolve()\n```", "id": "2762450"}]}