{"hands_on_practices": [{"introduction": "A fundamental question in urban evolutionary ecology is whether a species can maintain a self-sustaining population in a novel city environment. This practice introduces demographic modeling as a powerful tool to integrate the complex effects of the urban mosaic on survival and reproduction. By calculating the net reproductive rate, $R_0$, from empirically-derived life-history parameters [@problem_id:2761598], you will gain hands-on experience in assessing population viability and diagnosing the key factors that drive population growth or decline.", "problem": "A city-dwelling passerine bird exhibits a two-stage annual life cycle: juveniles and adults. In this urban mosaic, juvenile survival is strongly affected by proximity to major roads, while adult fecundity is elevated when breeding in parks. Assume a discrete-time, stage-structured demography with the following empirically estimated quantities:\n\n- The probability that a juvenile encounters road-dominated areas during its first year is $q = 0.70$, in which case its annual survival is $s_{R} = 0.25$. If a juvenile remains in park interiors, its annual survival is $s_{P} = 0.65$. Treat first-year survival as a mixture, $s_{J} = q s_{R} + (1 - q) s_{P}$.\n- Adults survive annually with probability $s_{A} = 0.55$.\n- Adults breed once per year. If breeding in parks, the mean number of daughters produced per adult female per year is $b_{P} = 2.8$; if breeding in the built matrix outside parks, it is $b_{U} = 0.90$. Each adult breeds in parks with probability $p = 0.60$ and otherwise in the built matrix. Treat annual fecundity per adult female as a mixture, $f = p b_{P} + (1 - p) b_{U}$.\n- Juveniles are nonreproductive and mature to the adult stage after one year if they survive. Assume the environment is stationary, vital rates are constant in time, the sex ratio is already incorporated into $b_{P}$ and $b_{U}$, and density dependence is negligible.\n\nUsing first principles for a two-stage, discrete-time life cycle in which juveniles do not reproduce and adults reproduce once per year, derive the net reproductive rate (expected lifetime number of daughters per newborn female), denoted as $R_{0}$, in terms of $s_{J}$, $s_{A}$, and $f$, and then compute its numerical value for the parameter values above. Round your answer to three significant figures. Express your final answer as a pure number (dimensionless).\n\nAfter computing $R_{0}$, briefly justify, based on the structure of your expression and the given values, whether the urban population growth is primarily driven by elevated adult fecundity in parks or depressed juvenile survival near roads. Your final numerical answer should be the value of $R_{0}$ only.", "solution": "The problem statement is subjected to validation.\n\n**Step 1: Extract Givens**\n- Probability of juvenile encountering road-dominated areas: $q = 0.70$\n- Juvenile annual survival probability in road-dominated areas: $s_{R} = 0.25$\n- Juvenile annual survival probability in park interiors: $s_{P} = 0.65$\n- Composite first-year juvenile survival: $s_{J} = q s_{R} + (1 - q) s_{P}$\n- Adult annual survival probability: $s_{A} = 0.55$\n- Mean daughters per adult female in parks: $b_{P} = 2.8$\n- Mean daughters per adult female in built matrix: $b_{U} = 0.90$\n- Probability of an adult breeding in parks: $p = 0.60$\n- Composite annual fecundity per adult female: $f = p b_{P} + (1 - p) b_{U}$\n- Life cycle: Discrete-time, two-stage (juvenile, adult). Juveniles are non-reproductive and mature to adults in one year. Adults reproduce once per year.\n- Assumptions: Stationary environment, constant vital rates, sex ratio included in fecundity, negligible density dependence.\n- Objective: Derive the net reproductive rate, $R_{0}$, in terms of $s_{J}$, $s_{A}$, and $f$; compute its numerical value; and provide a justification for the primary driver of population growth.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, well-posed, and objective. It describes a standard stage-structured demographic model, a fundamental tool in population ecology. The parameters provided are plausible for a passerine bird. The problem is self-contained, with all necessary data provided for a unique and meaningful solution. There are no violations of scientific principles, logical contradictions, or ambiguities.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A solution will be furnished.\n\nThe net reproductive rate, $R_{0}$, is defined as the expected number of female offspring produced by a newborn female throughout her entire lifespan. This can be calculated by summing the expected fecundity at each age, weighted by the probability of surviving to that age. Let $l_x$ be the probability of surviving from birth to the start of age class $x$, and let $b_x$ be the mean number of female offspring produced by an individual of age $x$. Then, $R_{0} = \\sum_{x=0}^{\\infty} l_x b_x$.\n\nThe life cycle is structured as follows:\n- Age $x=0$: A newborn is a juvenile. Its survival to age $1$ is not yet realized. $l_0 = 1$. Juveniles are non-reproductive, so $b_0 = 0$. The contribution to $R_{0}$ is $l_0 b_0 = 0$.\n- Age $x=1$: An individual that has survived its first year becomes an adult. The probability of survival to age $1$ is $l_1 = s_J$. At this age, the individual reproduces for the first time, with expected fecundity $b_1 = f$. The contribution to $R_{0}$ is $l_1 b_1 = s_J f$.\n- Age $x=2$: To reach age $2$, an individual must survive its juvenile year (with probability $s_J$) and its first adult year (with probability $s_A$). Thus, the probability of survival to age $2$ is $l_2 = s_J s_A$. The fecundity at this age is $b_2 = f$. The contribution to $R_{0}$ is $l_2 b_2 = s_J s_A f$.\n- Age $x$ (for $x \\geq 1$): In general, to reach age $x$, an individual must survive the juvenile year and $x-1$ adult years. The survival probability is $l_x = s_J s_A^{x-1}$. The fecundity is $b_x = f$. The contribution is $l_x b_x = s_J s_A^{x-1} f$.\n\nSumming the contributions over all reproductive ages ($x \\geq 1$):\n$$R_{0} = \\sum_{x=1}^{\\infty} l_x b_x = \\sum_{x=1}^{\\infty} (s_J s_A^{x-1} f)$$\nWe can factor out the constant terms $s_J$ and $f$:\n$$R_{0} = s_J f \\sum_{x=1}^{\\infty} s_A^{x-1}$$\nLet $k = x-1$. The summation becomes:\n$$R_{0} = s_J f \\sum_{k=0}^{\\infty} s_A^{k}$$\nThe summation is a standard geometric series. Since $s_A$ is a survival probability, its value is between $0$ and $1$. Therefore, the series converges to $\\frac{1}{1 - s_A}$.\nThe final expression for the net reproductive rate is:\n$$R_{0} = \\frac{s_J f}{1 - s_A}$$\nThis expression is intuitive: it is the product of the probability of surviving to maturity ($s_J$) and the expected total lifetime reproduction of an adult ($f / (1 - s_A)$).\n\nNext, we compute the numerical value. First, we calculate the composite parameters $s_J$ and $f$.\nThe composite juvenile survival is:\n$$s_{J} = q s_{R} + (1 - q) s_{P} = (0.70)(0.25) + (1 - 0.70)(0.65) = 0.175 + (0.30)(0.65) = 0.175 + 0.195 = 0.370$$\nThe composite adult fecundity is:\n$$f = p b_{P} + (1 - p) b_{U} = (0.60)(2.8) + (1 - 0.60)(0.90) = 1.68 + (0.40)(0.90) = 1.68 + 0.36 = 2.04$$\nNow, substitute these values along with $s_A = 0.55$ into the expression for $R_{0}$:\n$$R_{0} = \\frac{s_J f}{1 - s_A} = \\frac{(0.370)(2.04)}{1 - 0.55} = \\frac{0.7548}{0.45} \\approx 1.67733...$$\nRounding to three significant figures, the net reproductive rate is $R_{0} = 1.68$.\n\nFinally, we must justify whether population growth is primarily driven by elevated fecundity in parks or depressed by juvenile survival near roads. Population growth occurs if $R_{0}  1$. Here, $R_0 \\approx 1.68$, so the population is growing.\nThe structure of the equation $R_{0} = \\frac{s_{J} f}{1 - s_{A}}$ shows that $R_0$ is directly proportional to both juvenile survival $s_{J}$ and adult fecundity $f$. To determine the primary driver of growth (i.e., the factor enabling $R_{0}  1$), we perform a counterfactual analysis.\n\n1.  Consider a scenario without the elevated fecundity in parks. Assume all adults breed in the built matrix, so fecundity is uniformly low, $f = b_{U} = 0.90$. All other parameters remain the same.\n    $$R_{0}' = \\frac{s_J b_U}{1 - s_A} = \\frac{(0.370)(0.90)}{1 - 0.55} = \\frac{0.333}{0.45} \\approx 0.74$$\n    In this case, $R_{0}'  1$, and the population would decline towards extinction. This demonstrates that the elevated fecundity from breeding in parks is essential for the population to achieve growth.\n\n2.  Consider a scenario without the depressed juvenile survival near roads. Assume all juveniles experience the higher survival rate of park interiors, $s_J = s_P = 0.65$.\n    $$R_{0}'' = \\frac{s_P f}{1 - s_A} = \\frac{(0.65)(2.04)}{1 - 0.55} = \\frac{1.326}{0.45} \\approx 2.95$$\n    In this case, $R_{0}'' \\gg 1$, indicating much more rapid growth. This shows that depressed juvenile survival is a strong limiting factor, but the population grows *in spite of* it, not because of it.\n\nThe growth condition ($R_{0}  1$) is achieved only because the high fecundity provided by park habitats is sufficient to overcome the strong negative pressure from low juvenile survival in road-dominated areas. Therefore, the population's growth is primarily driven by the elevated adult fecundity in parks.", "answer": "$$\\boxed{1.68}$$", "id": "2761598"}, {"introduction": "Once we establish that selection is operating in an urban population, the next step is to identify which specific traits are the targets of that selection. However, since traits are often genetically or functionally correlated, it can be challenging to distinguish between direct selection on a trait and indirect selection that occurs because it is correlated with another favored trait. This exercise [@problem_id:2761337] applies the classic Lande-Arnold framework of multivariate selection, allowing you to practice dissecting total selection into its direct and indirect components and gain a clearer, more mechanistic understanding of adaptive evolution.", "problem": "In an urban songbird population, researchers examine how traits related to coping with anthropogenic disturbance predict realized reproductive success in the city. They focus on two continuous traits: minimum song frequency (trait $z_1$) and boldness (trait $z_2$). To estimate directional selection, they follow the Lande–Arnold approach and regress individual relative fitness on the traits. Each trait is standardized to have sample mean $0$ and sample variance $1$ prior to analysis, and relative fitness $w$ is defined as an individual’s number of fledglings divided by the sample mean number of fledglings for that breeding season, so that $\\bar{w}=1$. The linear model is\n$$\nw = \\alpha + \\beta_1 z_1 + \\beta_2 z_2 + \\varepsilon,\n$$\nwhere $\\beta_1$ and $\\beta_2$ are the directional selection gradients.\n\nFrom a sample of $n=200$ territorial males, the following sample moments are obtained:\n- $\\operatorname{Var}(z_1)=1$, $\\operatorname{Var}(z_2)=1$, and $\\operatorname{Cov}(z_1,z_2)=0.5$,\n- $\\operatorname{Cov}(z_1,w)=0.08$ and $\\operatorname{Cov}(z_2,w)=0.02$.\n\nAssume the usual regularity conditions for ordinary least squares are met, and ignore nonlinear (quadratic) selection for this question. Using only fundamental definitions of relative fitness, variance–covariance, and ordinary least squares, derive the estimates $\\hat{\\beta}_1$ and $\\hat{\\beta}_2$ implied by these sample moments, and interpret them in terms of direct selection on the two traits in the urban environment. Which option below correctly reports the numerical estimates and provides a valid interpretation?\n\n- A. $\\hat{\\beta}_1 \\approx 0.093$, $\\hat{\\beta}_2 \\approx -0.027$. Interpretation: after accounting for the correlation between traits, there is positive direct selection on higher song frequency and slight negative direct selection on boldness; coefficients are per standard deviation of the trait in units of relative fitness.\n- B. $\\hat{\\beta}_1 = 0.08$, $\\hat{\\beta}_2 = 0.02$. Interpretation: these are the directional selection gradients because they equal the covariances of each trait with relative fitness.\n- C. $\\hat{\\beta}_1 \\approx 0.120$, $\\hat{\\beta}_2 \\approx 0.080$. Interpretation: both traits experience positive direct selection of similar magnitude because they are positively correlated.\n- D. The gradients are not estimable because centering traits at mean $0$ and scaling to variance $1$ eliminates information about selection in the mean-centered regression.", "solution": "The problem statement is subjected to validation.\n\n**Step 1: Extract Givens**\n- The model for relative fitness ($w$) is a linear regression on two traits ($z_1$, $z_2$): $w = \\alpha + \\beta_1 z_1 + \\beta_2 z_2 + \\varepsilon$.\n- The traits ($z_1$, $z_2$) are standardized such that their sample means are $0$ and sample variances are $1$.\n- Relative fitness ($w$) is defined such that its sample mean is $\\bar{w}=1$.\n- The coefficients $\\beta_1$ and $\\beta_2$ are the directional selection gradients.\n- Sample size $n=200$.\n- Sample moments for the traits: $\\operatorname{Var}(z_1)=1$, $\\operatorname{Var}(z_2)=1$, $\\operatorname{Cov}(z_1,z_2)=0.5$.\n- Sample covariances between traits and relative fitness: $\\operatorname{Cov}(z_1,w)=0.08$, $\\operatorname{Cov}(z_2,w)=0.02$.\n- The analysis assumes ordinary least squares (OLS) regularity conditions are met and ignores nonlinear selection.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is well-posed and scientifically grounded. It presents a standard application of the Lande-Arnold (1983) multivariate selection analysis, a foundational method in quantitative evolutionary genetics. The data provided are self-contained and consistent. The traits are standardized to have a mean of $0$ and variance of $1$, which is a common and recommended procedure in this type of analysis. The provided covariance matrix for the traits is positive definite ($\\operatorname{det} = 1 - 0.5^2 = 0.75  0$), ensuring a unique solution exists. The values for covariances are plausible. The question is objective and requires a direct application of statistical principles to a biological problem. No flaws are identified.\n\n**Step 3: Verdict and Action**\nThe problem is valid. The solution will proceed.\n\n**Derivation of Selection Gradients**\nThe problem asks for the Ordinary Least Squares (OLS) estimates of the partial regression coefficients, $\\beta_1$ and $\\beta_2$, which in this context are the directional selection gradients. The general matrix form for the OLS estimator of the coefficient vector $\\boldsymbol{\\beta}$ is $\\hat{\\boldsymbol{\\beta}} = (\\mathbf{Z}'\\mathbf{Z})^{-1}\\mathbf{Z}'\\mathbf{w}$. When working with sample moments, this is equivalent to the equation:\n$$\n\\hat{\\boldsymbol{\\beta}} = \\mathbf{P}^{-1}\\mathbf{s}\n$$\nwhere $\\hat{\\boldsymbol{\\beta}}$ is the vector of estimated selection gradients, $\\mathbf{P}$ is the phenotypic variance-covariance matrix of the traits, and $\\mathbf{s}$ is the vector of selection differentials (the covariances of the traits with relative fitness).\n\nFrom the problem statement, we define the vector of selection gradients and the vector of selection differentials:\n$$\n\\hat{\\boldsymbol{\\beta}} = \\begin{pmatrix} \\hat{\\beta}_1 \\\\ \\hat{\\beta}_2 \\end{pmatrix}, \\quad \\mathbf{s} = \\begin{pmatrix} \\operatorname{Cov}(z_1, w) \\\\ \\operatorname{Cov}(z_2, w) \\end{pmatrix} = \\begin{pmatrix} 0.08 \\\\ 0.02 \\end{pmatrix}\n$$\nThe phenotypic variance-covariance matrix $\\mathbf{P}$ is:\n$$\n\\mathbf{P} = \\begin{pmatrix} \\operatorname{Var}(z_1)  \\operatorname{Cov}(z_1, z_2) \\\\ \\operatorname{Cov}(z_2, z_1)  \\operatorname{Var}(z_2) \\end{pmatrix} = \\begin{pmatrix} 1  0.5 \\\\ 0.5  1 \\end{pmatrix}\n$$\nTo solve for $\\hat{\\boldsymbol{\\beta}}$, we first compute the inverse of $\\mathbf{P}$, denoted $\\mathbf{P}^{-1}$. For a general $2 \\times 2$ matrix $\\begin{pmatrix} a  b \\\\ c  d \\end{pmatrix}$, the inverse is $\\frac{1}{ad-bc}\\begin{pmatrix} d  -b \\\\ -c  a \\end{pmatrix}$.\nThe determinant of $\\mathbf{P}$ is $\\det(\\mathbf{P}) = (1)(1) - (0.5)(0.5) = 1 - 0.25 = 0.75$.\nThe inverse matrix is therefore:\n$$\n\\mathbf{P}^{-1} = \\frac{1}{0.75} \\begin{pmatrix} 1  -0.5 \\\\ -0.5  1 \\end{pmatrix} = \\frac{4}{3} \\begin{pmatrix} 1  -0.5 \\\\ -0.5  1 \\end{pmatrix} = \\begin{pmatrix} 4/3  -2/3 \\\\ -2/3  4/3 \\end{pmatrix}\n$$\nNow, we compute the vector of selection gradients by multiplying $\\mathbf{P}^{-1}$ by $\\mathbf{s}$:\n$$\n\\hat{\\boldsymbol{\\beta}} = \\mathbf{P}^{-1}\\mathbf{s} = \\begin{pmatrix} 4/3  -2/3 \\\\ -2/3  4/3 \\end{pmatrix} \\begin{pmatrix} 0.08 \\\\ 0.02 \\end{pmatrix}\n$$\nThe individual elements are:\n$$\n\\hat{\\beta}_1 = \\left(\\frac{4}{3}\\right)(0.08) + \\left(-\\frac{2}{3}\\right)(0.02) = \\frac{4 \\times 0.08 - 2 \\times 0.02}{3} = \\frac{0.32 - 0.04}{3} = \\frac{0.28}{3} \\approx 0.09333...\n$$\n$$\n\\hat{\\beta}_2 = \\left(-\\frac{2}{3}\\right)(0.08) + \\left(\\frac{4}{3}\\right)(0.02) = \\frac{-2 \\times 0.08 + 4 \\times 0.02}{3} = \\frac{-0.16 + 0.08}{3} = \\frac{-0.08}{3} \\approx -0.02666...\n$$\nSo, the estimated directional selection gradients are $\\hat{\\beta}_1 \\approx 0.093$ and $\\hat{\\beta}_2 \\approx -0.027$.\n\n**Interpretation**\nThe selection gradients $\\beta_1$ and $\\beta_2$ measure the direct causal effect of each trait on relative fitness, statistically holding the other trait constant.\n- $\\hat{\\beta}_1 \\approx 0.093  0$: This indicates positive direct selection on trait $z_1$ (minimum song frequency). An increase of one standard deviation in song frequency is associated with an increase of approximately $0.093$ units of relative fitness, after accounting for boldness.\n- $\\hat{\\beta}_2 \\approx -0.027  0$: This indicates negative direct selection on trait $z_2$ (boldness). An increase of one standard deviation in boldness is associated with a decrease of approximately $0.027$ units of relative fitness, after accounting for song frequency.\nIt is important to note that the total selection on boldness, given by the selection differential $\\operatorname{Cov}(z_2,w)=0.02$, is positive. The discrepancy arises because of the positive correlation between the traits ($\\operatorname{Cov}(z_1,z_2)=0.5$). Boldness appears to be favored only because it is correlated with a strongly favored trait (high song frequency). When this indirect effect is removed, the direct effect of boldness on fitness is revealed to be negative.\n\n**Option-by-Option Analysis**\n- **A. $\\hat{\\beta}_1 \\approx 0.093$, $\\hat{\\beta}_2 \\approx -0.027$. Interpretation: after accounting for the correlation between traits, there is positive direct selection on higher song frequency and slight negative direct selection on boldness; coefficients are per standard deviation of the trait in units of relative fitness.**\n  The calculated numerical values for $\\hat{\\beta}_1$ and $\\hat{\\beta}_2$ match this option. The interpretation is entirely correct. A partial regression coefficient measures the effect of one predictor \"after accounting for\" the other predictors. The signs of the coefficients correspond to positive direct selection on song frequency and negative direct selection on boldness. Because the traits were standardized to have unit variance, the gradients represent the change in relative fitness per standard deviation change in the trait.\n  Verdict: **Correct**.\n\n- **B. $\\hat{\\beta}_1 = 0.08$, $\\hat{\\beta}_2 = 0.02$. Interpretation: these are the directional selection gradients because they equal the covariances of each trait with relative fitness.**\n  This is incorrect. The values $0.08$ and $0.02$ are the selection differentials ($s_1$ and $s_2$), not the selection gradients ($\\beta_1$ and $\\beta_2$). The equality $\\boldsymbol{\\beta} = \\mathbf{s}$ holds only if the predictor traits are uncorrelated, i.e., if $\\mathbf{P}$ is an identity matrix. Here, $\\operatorname{Cov}(z_1,z_2)=0.5 \\neq 0$, so this is false. This option confuses total selection with direct selection.\n  Verdict: **Incorrect**.\n\n- **C. $\\hat{\\beta}_1 \\approx 0.120$, $\\hat{\\beta}_2 \\approx 0.080$. Interpretation: both traits experience positive direct selection of similar magnitude because they are positively correlated.**\n  The numerical values are incorrect. The interpretation is also flawed; our calculation shows that $\\hat{\\beta}_2$ is negative, indicating negative direct selection, not positive. Furthermore, a positive correlation between traits does not necessitate that both experience positive direct selection.\n  Verdict: **Incorrect**.\n\n- **D. The gradients are not estimable because centering traits at mean $0$ and scaling to variance $1$ eliminates information about selection in the mean-centered regression.**\n  This statement is fundamentally false. Standardization of predictor variables is a standard and often recommended procedure in multiple regression and specifically in the Lande-Arnold framework. It does not prevent estimation; it facilitates it by placing traits on a common scale for comparison. The gradients are perfectly estimable, as demonstrated in the derivation above.\n  Verdict: **Incorrect**.", "answer": "$$\\boxed{A}$$", "id": "2761337"}, {"introduction": "After identifying traits under selection, the ultimate goal for many evolutionary biologists is to uncover the genetic basis of adaptation. Modern genomics provides powerful tools to scan entire genomes for loci that show signs of being targeted by selection. This hands-on computational practice [@problem_id:2761622] guides you through implementing a realistic genome scan that combines two common approaches: identifying loci with unusually high differentiation between urban and rural populations ($F_{ST}$) and finding loci whose allele frequencies are strongly correlated with an environmental variable, such as pollution. This exercise provides critical skills for discovering candidate genes underlying urban adaptation.", "problem": "You are tasked with implementing a program that, given allele count data for multiple Single Nucleotide Polymorphism (SNP) loci across replicate urban and rural populations and a continuous pollution measurement per population, performs two complementary scans for signals of urban adaptation: a fixation index outlier scan and an environmental association analysis. The biological foundation is that loci under divergent selection between environments tend to exhibit elevated among-population differentiation and that alleles involved in adaptation to urban pollution exhibit systematic association of allele frequency with a pollution gradient. Your task is to formalize these ideas from first principles and implement them in a reproducible computational pipeline.\n\nStart from the following fundamental bases:\n- Wright’s fixation index (fixation index) quantifies the proportion of total genetic variance among populations. For a biallelic locus with population allele frequencies $p_i$ across $K$ populations and overall mean allele frequency $\\bar{p}$, the among-population component of variance is proportional to $\\mathrm{Var}(p_i)$, and the total binomial variance at Hardy–Weinberg equilibrium is $\\bar{p}(1-\\bar{p})$. A variance-ratio estimator of the fixation index takes the form of the among-population variance divided by the total variance baseline.\n- A rank-based association between an environmental variable and allele frequency is captured by Spearman’s rank correlation coefficient, defined as the Pearson correlation of the ranks of the two variables. Under the null hypothesis of no association, the absolute value of Spearman’s coefficient is expected to be small and its $p$-value can be computed for a two-sided test.\n- The Benjamini–Hochberg (BH) procedure controls the False Discovery Rate (FDR) at a user-specified level by ordering $p$-values and declaring discoveries up to a data-dependent threshold.\n\nRequirements to derive and implement:\n1. Given integer allele counts $x_{i\\ell}$ (reference allele counts) and sample sizes $n_{i\\ell}$ for population $i \\in \\{0,\\dots,K-1\\}$ at locus $\\ell \\in \\{0,\\dots,L-1\\}$, compute allele frequency estimates $p_{i\\ell} = x_{i\\ell} / n_{i\\ell}$.\n2. For each locus $\\ell$, compute an estimator of the fixation index across the $K$ populations using\n   - the unbiased sample variance of $p_{i\\ell}$ across populations,\n   - and the Hardy–Weinberg total variance baseline,\n   to obtain a ratio estimator of among-population differentiation. Handle boundary cases where $\\bar{p}_{\\ell} \\in \\{0,1\\}$ or the denominator is zero by setting the fixation index to $0$ for that locus.\n3. For each locus $\\ell$, compute Spearman’s rank correlation between the vector $\\{p_{i\\ell}\\}_{i=0}^{K-1}$ and the pollution vector $\\{z_i\\}_{i=0}^{K-1}$, and obtain a two-sided $p$-value. If the pollution vector is constant or the rank correlation is undefined, set the $p$-value to $1$ for that locus.\n4. Perform an outlier scan by thresholding the empirical distribution of the fixation index across loci at a user-specified upper quantile $q_{\\mathrm{FST}} \\in (0,1)$: a locus is an outlier if its fixation index is greater than or equal to the empirical $q_{\\mathrm{FST}}$-quantile.\n5. Perform an environmental association discovery step by controlling the False Discovery Rate (FDR) at a user-specified level $q_{\\mathrm{BH}} \\in (0,1)$ using the Benjamini–Hochberg procedure applied to the two-sided $p$-values from Spearman’s correlation across all loci for the given test case.\n6. Report as candidate loci those loci that simultaneously satisfy both criteria: they are fixation index outliers and they are discoveries under the Benjamini–Hochberg procedure. Both positive and negative associations are allowed for candidacy.\n\nYour program must implement the above without external input and must run deterministically. Use $0$-based indexing for loci. For each test case defined below, you must output the sorted list of candidate locus indices as a list of integers.\n\nTest suite:\n- Test case A (happy path with mixed signals):\n  - Populations $K = 4$ corresponding to two urban and two rural replicates.\n  - Loci $L = 8$.\n  - Pollution vector (arbitrary units): $[\\,7.0,\\,6.5,\\,1.0,\\,1.2\\,]$ corresponding to populations $[\\,\\mathrm{U1},\\,\\mathrm{U2},\\,\\mathrm{R1},\\,\\mathrm{R2}\\,]$.\n  - Allele counts $x_{i\\ell}$ and sample sizes $n_{i\\ell}$ for each population $i$ and locus $\\ell$:\n    - For all loci in this test, $n_{i\\ell} = 50$ for all $i,\\ell$.\n    - Locus $0$: counts $[\\,45,\\,42,\\,5,\\,10\\,]$.\n    - Locus $1$: counts $[\\,25,\\,26,\\,24,\\,25\\,]$.\n    - Locus $2$: counts $[\\,45,\\,5,\\,45,\\,5\\,]$.\n    - Locus $3$: counts $[\\,30,\\,31,\\,31,\\,30\\,]$.\n    - Locus $4$: counts $[\\,5,\\,10,\\,40,\\,35\\,]$.\n    - Locus $5$: counts $[\\,0,\\,0,\\,0,\\,0\\,]$.\n    - Locus $6$: counts $[\\,28,\\,30,\\,25,\\,24\\,]$.\n    - Locus $7$: counts $[\\,47,\\,45,\\,3,\\,5\\,]$.\n  - Quantile for fixation index outliers $q_{\\mathrm{FST}} = 0.75$.\n  - Benjamini–Hochberg FDR level $q_{\\mathrm{BH}} = 0.10$.\n- Test case B (boundary: monomorphic loci):\n  - Populations $K = 4$.\n  - Loci $L = 3$.\n  - Pollution vector: $[\\,2.0,\\,3.0,\\,1.0,\\,4.0\\,]$.\n  - For all loci, $n_{i\\ell} = 40$ and $x_{i\\ell} = 0$ for all $i,\\ell$.\n  - Quantile $q_{\\mathrm{FST}} = 0.80$.\n  - FDR level $q_{\\mathrm{BH}} = 0.10$.\n- Test case C (edge: negative association with high fixation index):\n  - Populations $K = 3$.\n  - Loci $L = 6$.\n  - Pollution vector: $[\\,0.5,\\,2.0,\\,5.0\\,]$.\n  - For all loci, $n_{i\\ell} = 40$.\n  - Locus $0$: counts $[\\,36,\\,24,\\,8\\,]$.\n  - Locus $1$: counts $[\\,20,\\,20,\\,20\\,]$.\n  - Locus $2$: counts $[\\,8,\\,32,\\,8\\,]$.\n  - Locus $3$: counts $[\\,18,\\,20,\\,22\\,]$.\n  - Locus $4$: counts $[\\,32,\\,16,\\,4\\,]$.\n  - Locus $5$: counts $[\\,4,\\,12,\\,8\\,]$.\n  - Quantile $q_{\\mathrm{FST}} = 0.66$.\n  - FDR level $q_{\\mathrm{BH}} = 0.10$.\n- Test case D (boundary: constant environment):\n  - Populations $K = 3$.\n  - Loci $L = 4$.\n  - Pollution vector: $[\\,2.0,\\,2.0,\\,2.0\\,]$.\n  - For all loci, $n_{i\\ell} = 30$.\n  - Locus $0$: counts $[\\,15,\\,15,\\,15\\,]$.\n  - Locus $1$: counts $[\\,25,\\,5,\\,15\\,]$.\n  - Locus $2$: counts $[\\,10,\\,20,\\,15\\,]$.\n  - Locus $3$: counts $[\\,0,\\,0,\\,0\\,]$.\n  - Quantile $q_{\\mathrm{FST}} = 0.75$.\n  - FDR level $q_{\\mathrm{BH}} = 0.10$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results for the four test cases as a comma-separated list enclosed in square brackets, where each element is the list of candidate locus indices (sorted in ascending order) for the corresponding test case. For example, an output with lists $L_A$, $L_B$, $L_C$, and $L_D$ must be printed exactly as\n  - $[\\,[\\dots],\\,[\\dots],\\,[\\dots],\\,[\\dots]\\,]$\nwith no spaces required beyond those in the list syntax.\n\nAll computations are unitless. Angles are not involved. Express all reported numerical results as plain integers within the lists of indices. No percentage signs are to be used; specify all proportions and probabilities internally as decimals as already defined in the test suite.", "solution": "The problem presented is a well-posed and scientifically grounded exercise in computational population genetics. It requires the implementation of a pipeline to detect loci under selection in urban environments by combining two standard methods: a fixation index ($F_{ST}$) outlier scan and an environmental association analysis. The problem provides all necessary data, parameters, and explicit definitions for the required computations, including handling of boundary cases. It is free from ambiguity, contradiction, and factual error. Therefore, we may proceed directly to the formal derivation and implementation of the solution.\n\nThe core task is to identify genomic loci that exhibit both unusually high genetic differentiation among populations and a statistically significant association between allele frequency and a pollution gradient. This is a common strategy to find candidate genes for local adaptation.\n\nWe will systematically implement the required steps for each test case. Let $K$ be the number of populations, $L$ be the number of loci, $\\{x_{i\\ell}\\}$ and $\\{n_{i\\ell}\\}$ be the reference allele counts and sample sizes for population $i$ and locus $\\ell$, and $\\{z_i\\}$ be the pollution levels for each population.\n\n**Step 1: Allele Frequency Calculation**\n\nFor each locus $\\ell \\in \\{0, \\dots, L-1\\}$ in each population $i \\in \\{0, \\dots, K-1\\}$, the allele frequency $p_{i\\ell}$ is estimated as the ratio of the reference allele count to the total number of alleles sampled:\n$$p_{i\\ell} = \\frac{x_{i\\ell}}{n_{i\\ell}}$$\nThis calculation forms the basis for all subsequent analyses.\n\n**Step 2: Fixation Index ($F_{ST}$) Estimation**\n\nThe fixation index, $F_{ST}$, quantifies the proportion of genetic variation that is due to allele frequency differences among populations. Following the problem's definition, we use a variance-based estimator for each locus $\\ell$.\n\nFirst, we calculate the mean allele frequency across all $K$ populations for locus $\\ell$:\n$$\\bar{p}_{\\ell} = \\frac{1}{K} \\sum_{i=0}^{K-1} p_{i\\ell}$$\n\nNext, we compute the unbiased sample variance of these allele frequencies, which represents the among-population variance component:\n$$s^2_{p_\\ell} = \\frac{1}{K-1} \\sum_{i=0}^{K-1} (p_{i\\ell} - \\bar{p}_{\\ell})^2$$\nFor this computation, we use a degrees-of-freedom correction of $1$ (i.e., dividing by $K-1$).\n\nThe total expected variance at Hardy-Weinberg equilibrium for the mean allele frequency is the denominator:\n$$V_{\\text{total}, \\ell} = \\bar{p}_{\\ell}(1 - \\bar{p}_{\\ell})$$\n\nThe estimator for the fixation index is the ratio of these two quantities:\n$$F_{ST, \\ell} = \\frac{s^2_{p_\\ell}}{V_{\\text{total}, \\ell}}$$\n\nAs per the problem's rule for boundary cases, if the denominator $V_{\\text{total}, \\ell}$ is zero (which occurs when $\\bar{p}_{\\ell}=0$ or $\\bar{p}_{\\ell}=1$, i.e., the locus is monomorphic across all sampled populations), we set $F_{ST, \\ell} = 0$.\n\n**Step 3: Environmental Association Analysis (Spearman's Rank Correlation)**\n\nTo test for an association between allele frequency and the environmental variable (pollution), we use Spearman's rank correlation coefficient, $\\rho_S$. For each locus $\\ell$, we calculate $\\rho_S$ between the vector of allele frequencies $\\{p_{i\\ell}\\}_{i=0}^{K-1}$ and the vector of pollution measurements $\\{z_i\\}_{i=0}^{K-1}$. This is equivalent to calculating the Pearson correlation coefficient on the ranked data.\n\nA two-sided $p$-value is then computed under the null hypothesis of no correlation. This $p$-value indicates the probability of observing a correlation as strong as or stronger than the one detected, assuming no true association exists.\n\nAs specified, if the pollution vector $\\{z_i\\}$ is constant or if the allele frequency vector $\\{p_{i\\ell}\\}$ is constant for a given locus, the rank correlation is undefined. In such cases, we follow the directive to set the resulting $p$-value to $1$. This is a conservative choice, implying no evidence for association.\n\n**Step 4: Fixation Index Outlier Identification**\n\nAn outlier scan identifies loci with exceptionally high $F_{ST}$ values, which are candidates for being under divergent selection. We first compute the $F_{ST, \\ell}$ values for all $L$ loci. Then, we determine the empirical $q_{\\mathrm{FST}}$-quantile of this distribution of $F_{ST}$ values. A locus $\\ell$ is classified as an $F_{ST}$ outlier if its fixation index is greater than or equal to this quantile threshold:\n$$F_{ST, \\ell} \\ge \\text{Quantile}(\\{F_{ST, k}\\}_{k=0}^{L-1}, q_{\\mathrm{FST}})$$\n\n**Step 5: False Discovery Rate (FDR) Control with Benjamini-Hochberg (BH)**\n\nTo correct for multiple testing across $L$ loci in the environmental association analysis, we control the False Discovery Rate (FDR) using the Benjamini-Hochberg (BH) procedure. The FDR is the expected proportion of false positives among all discoveries.\n\nThe procedure is as follows:\n1.  Collect the $L$ Spearman's correlation $p$-values, $\\{p_{\\ell}\\}_{\\ell=0}^{L-1}$.\n2.  Sort these $p$-values in ascending order: $p_{(1)} \\le p_{(2)} \\le \\dots \\le p_{(L)}$.\n3.  Given the FDR level $q_{\\mathrm{BH}}$, find the largest integer $k$ such that:\n    $$p_{(k)} \\le \\frac{k}{L} q_{\\mathrm{BH}}$$\n4.  If such a $k$ exists, reject the null hypothesis (i.e., declare a discovery) for all tests corresponding to the $p$-values $p_{(1)}, \\dots, p_{(k)}$. If no such $k$ exists, no discoveries are made.\n\n**Step 6: Identification of Final Candidate Loci**\n\nThe final set of candidate loci for urban adaptation consists of those loci that satisfy both criteria simultaneously: they must be identified as $F_{ST}$ outliers in Step 4 AND as significant discoveries in the BH-corrected environmental association analysis in Step 5. The indices of these loci, sorted in ascending order, form the result for each test case.", "answer": "```python\nimport numpy as np\nfrom scipy import stats\n\ndef solve():\n    \"\"\"\n    Main solver function to process all test cases for urban adaptation analysis.\n    \"\"\"\n    test_cases = [\n        {\n            \"K\": 4, \"L\": 8,\n            \"pollution\": [7.0, 6.5, 1.0, 1.2],\n            \"n\": np.full((4, 8), 50),\n            \"x\": np.array([\n                [45, 25, 45, 30, 5, 0, 28, 47],    # Pop U1\n                [42, 26, 5, 31, 10, 0, 30, 45],   # Pop U2\n                [5, 24, 45, 31, 40, 0, 25, 3],     # Pop R1\n                [10, 25, 5, 30, 35, 0, 24, 5]     # Pop R2\n            ]).T, # Transpose to get L x K shape\n            \"q_fst\": 0.75, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 4, \"L\": 3,\n            \"pollution\": [2.0, 3.0, 1.0, 4.0],\n            \"n\": np.full((4, 3), 40),\n            \"x\": np.array([\n                [0, 0, 0], # Pop 1\n                [0, 0, 0], # Pop 2\n                [0, 0, 0], # Pop 3\n                [0, 0, 0]  # Pop 4\n            ]).T,\n            \"q_fst\": 0.80, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 3, \"L\": 6,\n            \"pollution\": [0.5, 2.0, 5.0],\n            \"n\": np.full((3, 6), 40),\n            \"x\": np.array([\n                [36, 20, 8, 18, 32, 4],    # Pop 1\n                [24, 20, 32, 20, 16, 12],  # Pop 2\n                [8, 20, 8, 22, 4, 8]      # Pop 3\n            ]).T,\n            \"q_fst\": 0.66, \"q_bh\": 0.10\n        },\n        {\n            \"K\": 3, \"L\": 4,\n            \"pollution\": [2.0, 2.0, 2.0],\n            \"n\": np.full((3, 4), 30),\n            \"x\": np.array([\n                [15, 25, 10, 0], # Pop 1\n                [15, 5, 20, 0],  # Pop 2\n                [15, 15, 15, 0]  # Pop 3\n            ]).T,\n            \"q_fst\": 0.75, \"q_bh\": 0.10\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        K, L = case[\"K\"], case[\"L\"]\n        pollution = case[\"pollution\"]\n        x = case[\"x\"] # Shape L x K\n        n = case[\"n\"] # Shape K x L, needs transpose\n        q_fst_thresh = case[\"q_fst\"]\n        q_bh = case[\"q_bh\"]\n\n        # Step 1: Allele Frequencies\n        # Use np.divide to handle 0/0, resulting in np.nan, which we then convert to 0.\n        p = np.divide(x, n.T, out=np.zeros_like(x, dtype=float), where=n.T!=0)\n\n        # Step 2: Fixation Index (FST)\n        fst_values = np.zeros(L)\n        for l in range(L):\n            p_locus = p[l, :]\n            p_mean = np.mean(p_locus)\n            \n            # Denominator V_total = p_mean * (1 - p_mean)\n            v_total = p_mean * (1.0 - p_mean)\n\n            if v_total == 0.0:\n                fst_values[l] = 0.0\n            else:\n                # Numerator is unbiased sample variance\n                var_p = np.var(p_locus, ddof=1)\n                fst_values[l] = var_p / v_total\n\n        # Step 3: Spearman's Rank Correlation\n        p_values = np.ones(L)\n        is_pollution_constant = len(set(pollution)) = 1\n        for l in range(L):\n            p_locus = p[l, :]\n            is_p_constant = len(set(p_locus)) = 1\n            if is_pollution_constant or is_p_constant:\n                p_values[l] = 1.0\n            else:\n                try:\n                    # scipy.stats.spearmanr handles NaN correctly for p-value if corr is undefined.\n                    # We will ensure this is handled by our explicit constant checks.\n                    res = stats.spearmanr(p_locus, pollution)\n                    p_values[l] = res.pvalue if not np.isnan(res.pvalue) else 1.0\n                except Exception:\n                    p_values[l] = 1.0\n\n        # Step 4: FST Outlier Scan\n        if L > 0:\n            fst_quantile_val = np.quantile(fst_values, q_fst_thresh)\n            is_fst_outlier = fst_values >= fst_quantile_val\n        else:\n            is_fst_outlier = np.array([], dtype=bool)\n\n        # Step 5: Benjamini-Hochberg Procedure\n        is_bh_discovery = np.zeros(L, dtype=bool)\n        if L > 0:\n            sorted_indices = np.argsort(p_values)\n            sorted_p_values = p_values[sorted_indices]\n            \n            # (k/L) * q_bh threshold line\n            bh_thresholds = (np.arange(1, L + 1) / L) * q_bh\n            \n            # Find where sorted p-values are under the threshold line\n            is_under_threshold = sorted_p_values = bh_thresholds\n            \n            # Find the largest k for which this is true\n            significant_indices = np.where(is_under_threshold)[0]\n            if len(significant_indices) > 0:\n                max_k_idx = significant_indices.max()\n                # All loci up to that k are discoveries\n                significant_original_indices = sorted_indices[:max_k_idx + 1]\n                is_bh_discovery[significant_original_indices] = True\n\n        # Step 6: Identify Candidate Loci\n        candidate_loci_mask = np.logical_and(is_fst_outlier, is_bh_discovery)\n        candidate_indices = np.where(candidate_loci_mask)[0]\n        \n        all_results.append(sorted(candidate_indices.tolist()))\n\n    print(str(all_results).replace(' ', ''))\n\nsolve()\n```", "id": "2761622"}]}