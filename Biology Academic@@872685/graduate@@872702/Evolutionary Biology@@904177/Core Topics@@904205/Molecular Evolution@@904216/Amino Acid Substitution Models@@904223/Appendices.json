{"hands_on_practices": [{"introduction": "Understanding the relationship between the instantaneous rates of substitution defined in a $Q$ matrix and the observable outcomes over evolutionary time is a cornerstone of molecular evolution. This first exercise provides a foundational workout in manipulating continuous-time Markov chain models. By deriving the formula that connects evolutionary time $t$ to expected sequence identity, you will gain direct experience with the matrix exponential and see how a simple, yet powerful, amino acid substitution model can be calibrated to match empirical data [@problem_id:2691268].", "problem": "Consider a continuous-time, time-homogeneous Markov chain on the standard amino acid alphabet of size $20$ with an empirically observed stationary distribution $\\boldsymbol{\\pi} = (\\pi_{1},\\ldots,\\pi_{20})$, where each $\\pi_{i} \\ge 0$ and $\\sum_{i=1}^{20} \\pi_{i} = 1$. Let the instantaneous rate matrix $Q$ be of the equal-input form, where for $i \\ne j$ one has $Q_{ij} = \\rho \\,\\pi_{j}$ and $Q_{ii} = -\\rho \\,(1 - \\pi_{i})$ for a positive rate scalar $\\rho$. The equal-input form captures the empirically observed equilibrium through $\\boldsymbol{\\pi}$ while allowing a single free scaling parameter $\\rho$ that controls the overall rate.\n\nStarting only from the foundational definition of a continuous-time Markov chain specified by $Q$, the matrix exponential transition law, and the definition of expected identity as the stationary-average probability of no change, derive an analytic expression for the evolutionary time $t$ that solves the calibration equation\n$$\n\\sum_{i=1}^{20} \\pi_{i} \\, P_{ii}(t) \\;=\\; s^{\\star},\n$$\nwhere $P(t)$ is the matrix of transition probabilities at time $t$ determined by $Q$, and $s^{\\star} \\in (0,1)$ is a given target expected fraction identity (expressed as a decimal, not a percentage). Your derivation must explicitly show the steps from the generator $Q$ to the transition matrix $P(t)$ and then to the expected identity function of $t$, before solving for $t$ in closed form. Provide your final answer as a single closed-form analytic expression for $t$ in terms of $s^{\\star}$, $\\rho$, and $\\boldsymbol{\\pi}$. No numerical evaluation is required, and no rounding is needed.", "solution": "The problem as stated is well-defined, scientifically grounded in the theory of molecular evolution, and internally consistent. We shall proceed with the derivation.\n\nThe instantaneous rate matrix $Q$ for the continuous-time Markov chain is specified for states $i, j \\in \\{1, \\ldots, 20\\}$. For $i \\neq j$, the rate of substitution from amino acid $i$ to $j$ is $Q_{ij} = \\rho \\pi_{j}$. The diagonal elements are defined by the requirement that the rows of $Q$ must sum to $0$, which gives $Q_{ii} = -\\sum_{j \\neq i} Q_{ij} = -\\sum_{j \\neq i} \\rho \\pi_{j} = -\\rho \\sum_{j \\neq i} \\pi_{j}$. Given the stationary distribution property $\\sum_{j=1}^{20} \\pi_{j} = 1$, we have $\\sum_{j \\neq i} \\pi_{j} = 1 - \\pi_{i}$. Therefore, $Q_{ii} = -\\rho(1 - \\pi_{i})$.\n\nThis structure allows us to express the matrix $Q$ in a more convenient form. Let $I$ be the $20 \\times 20$ identity matrix and let $\\mathbf{1}$ be a $20 \\times 1$ column vector of ones. Let $\\boldsymbol{\\pi}^{T}$ be the $1 \\times 20$ row vector of stationary probabilities, $\\boldsymbol{\\pi}^{T} = (\\pi_{1}, \\ldots, \\pi_{20})$. We can define a matrix $M = \\mathbf{1}\\boldsymbol{\\pi}^{T}$, whose elements are $M_{ij} = \\pi_{j}$ for all $i, j$.\nWith this definition, the rate matrix $Q$ can be written as:\n$$\nQ = \\rho (M - I)\n$$\nTo verify this, for $i \\ne j$, the element $(i,j)$ is $\\rho (M_{ij} - I_{ij}) = \\rho(\\pi_{j} - 0) = \\rho\\pi_{j}$. For $i=j$, the element $(i,i)$ is $\\rho (M_{ii} - I_{ii}) = \\rho(\\pi_{i} - 1) = -\\rho(1 - \\pi_{i})$. This confirms the compact representation.\n\nThe transition probability matrix $P(t)$ is given by the matrix exponential $P(t) = \\exp(Qt)$. Substituting the expression for $Q$:\n$$\nP(t) = \\exp(\\rho t (M - I))\n$$\nSince the identity matrix $I$ commutes with any matrix, we can separate the exponential:\n$$\nP(t) = \\exp(-\\rho t I) \\exp(\\rho t M) = \\exp(-\\rho t) \\exp(\\rho t M)\n$$\nTo evaluate $\\exp(\\rho t M)$, we first examine the properties of matrix $M$. Let us compute $M^{2}$:\n$$\nM^{2} = (\\mathbf{1}\\boldsymbol{\\pi}^{T})(\\mathbf{1}\\boldsymbol{\\pi}^{T}) = \\mathbf{1}(\\boldsymbol{\\pi}^{T}\\mathbf{1})\\boldsymbol{\\pi}^{T}\n$$\nThe term $\\boldsymbol{\\pi}^{T}\\mathbf{1}$ is the scalar product $\\sum_{i=1}^{20} \\pi_{i} = 1$. Thus, $M^{2} = \\mathbf{1}(1)\\boldsymbol{\\pi}^{T} = M$. The matrix $M$ is idempotent. This property simplifies the powers of $M$: $M^{k} = M$ for any integer $k \\ge 1$.\n\nNow we use the Taylor series expansion for the matrix exponential:\n$$\n\\exp(\\rho t M) = I + \\sum_{k=1}^{\\infty} \\frac{(\\rho t)^{k} M^{k}}{k!}\n$$\nSince $M^{k} = M$ for $k \\ge 1$:\n$$\n\\exp(\\rho t M) = I + M \\sum_{k=1}^{\\infty} \\frac{(\\rho t)^{k}}{k!}\n$$\nThe summation is the Taylor series for $\\exp(\\rho t) - 1$. So,\n$$\n\\exp(\\rho t M) = I + M(\\exp(\\rho t) - 1)\n$$\nSubstituting this back into the expression for $P(t)$:\n$$\nP(t) = \\exp(-\\rho t) \\left[ I + M(\\exp(\\rho t) - 1) \\right] = \\exp(-\\rho t)I + M(\\exp(-\\rho t)\\exp(\\rho t) - \\exp(-\\rho t))\n$$\n$$\nP(t) = \\exp(-\\rho t)I + (1 - \\exp(-\\rho t))M\n$$\nWriting this in terms of elements, using $M_{ij} = \\pi_j$ and $I_{ij} = \\delta_{ij}$ (the Kronecker delta):\n$$\nP_{ij}(t) = \\delta_{ij}\\exp(-\\rho t) + (1 - \\exp(-\\rho t))\\pi_{j}\n$$\nThe problem requires the diagonal elements $P_{ii}(t)$, for which $\\delta_{ii} = 1$:\n$$\nP_{ii}(t) = \\exp(-\\rho t) + (1 - \\exp(-\\rho t))\\pi_{i}\n$$\nThe calibration equation involves the expected fraction identity, defined as $\\sum_{i=1}^{20} \\pi_{i} P_{ii}(t)$. We substitute our expression for $P_{ii}(t)$ into this sum:\n$$\n\\sum_{i=1}^{20} \\pi_{i} P_{ii}(t) = \\sum_{i=1}^{20} \\pi_{i} \\left[ \\exp(-\\rho t) + (1 - \\exp(-\\rho t))\\pi_{i} \\right]\n$$\nWe can distribute the summation:\n$$\n= \\sum_{i=1}^{20} \\pi_{i} \\exp(-\\rho t) + \\sum_{i=1}^{20} \\pi_{i} (1 - \\exp(-\\rho t))\\pi_{i}\n$$\nFactoring out terms that do not depend on the summation index $i$:\n$$\n= \\exp(-\\rho t) \\sum_{i=1}^{20} \\pi_{i} + (1 - \\exp(-\\rho t)) \\sum_{i=1}^{20} \\pi_{i}^{2}\n$$\nUsing the given fact that $\\sum_{i=1}^{20} \\pi_{i} = 1$, the expression simplifies to:\n$$\n\\sum_{i=1}^{20} \\pi_{i} P_{ii}(t) = \\exp(-\\rho t) + (1 - \\exp(-\\rho t)) \\sum_{i=1}^{20} \\pi_{i}^{2}\n$$\nWe set this equal to the target expected identity $s^{\\star}$:\n$$\ns^{\\star} = \\exp(-\\rho t) + (1 - \\exp(-\\rho t)) \\sum_{i=1}^{20} \\pi_{i}^{2}\n$$\nTo solve for $t$, we must isolate the term $\\exp(-\\rho t)$. Let us denote the sum of squared frequencies as $H = \\sum_{i=1}^{20} \\pi_{i}^{2}$ for brevity.\n$$\ns^{\\star} = \\exp(-\\rho t) + H - H\\exp(-\\rho t)\n$$\n$$\ns^{\\star} - H = \\exp(-\\rho t) (1 - H)\n$$\nProvided that $H \\neq 1$, which is true for any non-trivial distribution $\\boldsymbol{\\pi}$, we can write:\n$$\n\\exp(-\\rho t) = \\frac{s^{\\star} - H}{1 - H}\n$$\nTo find $t$, we take the natural logarithm of both sides:\n$$\n-\\rho t = \\ln\\left(\\frac{s^{\\star} - H}{1 - H}\\right)\n$$\nSolving for $t$ yields:\n$$\nt = -\\frac{1}{\\rho} \\ln\\left(\\frac{s^{\\star} - H}{1 - H}\\right) = \\frac{1}{\\rho} \\ln\\left(\\left(\\frac{s^{\\star} - H}{1 - H}\\right)^{-1}\\right) = \\frac{1}{\\rho} \\ln\\left(\\frac{1 - H}{s^{\\star} - H}\\right)\n$$\nFinally, substituting back the definition of $H$:\n$$\nt = \\frac{1}{\\rho} \\ln\\left(\\frac{1 - \\sum_{i=1}^{20} \\pi_{i}^{2}}{s^{\\star} - \\sum_{i=1}^{20} \\pi_{i}^{2}}\\right)\n$$\nThis is the closed-form analytic expression for the evolutionary time $t$.", "answer": "$$\n\\boxed{\\frac{1}{\\rho} \\ln\\left(\\frac{1 - \\sum_{i=1}^{20} \\pi_{i}^{2}}{s^{\\star} - \\sum_{i=1}^{20} \\pi_{i}^{2}}\\right)}\n$$", "id": "2691268"}, {"introduction": "Evolutionary models can be formulated at different levels of biological detail, from individual nucleotides to codons to amino acids. A critical theoretical question is under what conditions a complex model can be rigorously simplified, or 'lumped,' into a simpler one without losing its fundamental mathematical properties. This practice challenges you to derive the formal condition for strong lumpability, which ensures that an aggregated process remains a valid Markov chain, and then apply it to a concrete example involving the genetic code [@problem_id:2691216]. Successfully completing this task deepens your understanding of the theoretical links between different classes of substitution models.", "problem": "A continuous-time Markov chain (CTMC) on codons with generator (rate matrix) $Q^{\\mathrm{codon}}$ evolves on the set of sense codons and respects the standard genetic-code mapping $g$ from codons to amino acids, where each amino acid corresponds to a block of codons. You aggregate (lump) codon states into amino acid states by summing probabilities within each amino-acid block.\n\nTask 1. Starting from the Kolmogorov forward equations for a CTMC and the definition of a block-aggregated process obtained by summing probabilities over each amino-acid block, derive necessary and sufficient conditions under which the aggregated process is itself a CTMC on amino acids (that is, when $Q^{\\mathrm{codon}}$ is strongly lumpable with respect to the partition induced by the genetic code). Your derivation must produce an explicit characterization of the condition in terms of codon-level rates between blocks and a constructive expression for the amino acid–level off-diagonal rate $\\widehat{q}_{ab}$ in terms of entries of $Q^{\\mathrm{codon}}$ when the condition holds.\n\nTask 2. Consider a scientifically plausible toy subsystem with four codons connected by single-nucleotide substitutions at the third codon position only: the two lysine codons $\\{\\text{AAA}, \\text{AAG}\\}$ and the two asparagine codons $\\{\\text{AAC}, \\text{AAU}\\}$. Assume that for any allowed third-position change from nucleotide $x$ to nucleotide $y$, the instantaneous codon substitution rate equals the underlying nucleotide rate $r_{x\\to y}$ at that position, and all other changes among these four codons are disallowed. The nonzero instantaneous rates (in $\\mathrm{s}^{-1}$) are specified by the following nucleotide rates:\n- $r_{A\\to C} = 3.0 \\times 10^{-1}$, $r_{A\\to U} = 6.0 \\times 10^{-1}$, $r_{A\\to G} = 2.0 \\times 10^{-1}$,\n- $r_{G\\to C} = 4.0 \\times 10^{-1}$, $r_{G\\to U} = 1.0 \\times 10^{-1}$, $r_{G\\to A} = 5.0 \\times 10^{-1}$,\n- $r_{C\\to U} = 7.0 \\times 10^{-1}$, $r_{U\\to C} = 8.0 \\times 10^{-1}$.\nHere, for example, the rate from $\\text{AAA}$ to $\\text{AAC}$ equals $r_{A\\to C}$, and the rate from $\\text{AAG}$ to $\\text{AAU}$ equals $r_{G\\to U}$, with diagonals set to make each row of $Q^{\\mathrm{codon}}$ sum to $0$.\n\nUsing your result from Task 1, determine whether the aggregation of this four-codon CTMC into a two-state amino acid CTMC on $\\{\\text{Lys}, \\text{Asn}\\}$ is strongly lumpable. Then, keeping all rates fixed except $r_{G\\to U}$, compute the minimal additive adjustment $\\Delta$ to $r_{G\\to U}$ that restores strong lumpability of the aggregation with respect to these two amino acids (i.e., the smallest real number $\\Delta$ such that replacing $r_{G\\to U}$ by $r_{G\\to U} + \\Delta$ makes the aggregation lumpable for the pair $\\{\\text{Lys}, \\text{Asn}\\}$). Round your final numerical answer to four significant figures. Express the final value in $\\mathrm{s}^{-1}$.", "solution": "The problem presented is valid. It is scientifically grounded in the theory of continuous-time Markov chains and its application to molecular evolution, is well-posed with sufficient information for a unique solution, and is expressed in objective, formal language. We will proceed with the solution.\n\nThe problem is divided into two tasks. The first is a theoretical derivation of the strong lumpability condition for a continuous-time Markov chain. The second is an application of this condition to a specific codon substitution model.\n\n**Task 1: Derivation of the Strong Lumpability Condition**\n\nLet the codon states be indexed by a finite set $S$. The evolution of substitution probabilities is governed by a continuous-time Markov chain with a generator matrix $Q^{\\mathrm{codon}} = (q_{ij})$, where $q_{ij}$ for $i \\neq j$ is the instantaneous rate of substitution from codon $i$ to codon $j$, and the diagonal elements are defined by $q_{ii} = -\\sum_{j \\neq i} q_{ij}$. Let $p_i(t)$ be the probability of observing codon $i$ at time $t$. The dynamics of the probability vector $\\mathbf{p}(t) = (p_i(t))_{i \\in S}$ are described by the Kolmogorov forward equations:\n$$\n\\frac{d p_j(t)}{dt} = \\sum_{i \\in S} p_i(t) q_{ij}\n$$\nThe genetic code induces a partition of the codon state space $S$ into disjoint blocks $\\mathcal{A} = \\{A_a, A_b, \\ldots\\}$, where each block $A_a$ consists of all codons that code for amino acid $a$. The probability of being in an aggregated amino acid state $b$ at time $t$ is the sum of the probabilities of being in any of the constituent codon states:\n$$\n\\widehat{p}_b(t) = \\sum_{j \\in A_b} p_j(t)\n$$\nThe aggregated process on the amino acid states is itself a continuous-time Markov chain if and only if its dynamics can be described by a set of forward equations involving only the aggregated probabilities:\n$$\n\\frac{d \\widehat{p}_b(t)}{dt} = \\sum_a \\widehat{p}_a(t) \\widehat{q}_{ab}\n$$\nfor some time-independent amino acid substitution rates $\\widehat{q}_{ab}$ and for any initial probability distribution over the codon states. This property is known as strong lumpability.\n\nTo derive the condition, we differentiate the expression for $\\widehat{p}_b(t)$ with respect to time $t$:\n$$\n\\frac{d \\widehat{p}_b(t)}{dt} = \\frac{d}{dt} \\left( \\sum_{j \\in A_b} p_j(t) \\right) = \\sum_{j \\in A_b} \\frac{d p_j(t)}{dt}\n$$\nSubstituting the codon-level Kolmogorov forward equation:\n$$\n\\frac{d \\widehat{p}_b(t)}{dt} = \\sum_{j \\in A_b} \\left( \\sum_{i \\in S} p_i(t) q_{ij} \\right)\n$$\nWe can interchange the order of summation and group the states $i \\in S$ according to the amino acid partition $\\mathcal{A}$:\n$$\n\\frac{d \\widehat{p}_b(t)}{dt} = \\sum_{i \\in S} p_i(t) \\left( \\sum_{j \\in A_b} q_{ij} \\right) = \\sum_a \\sum_{i \\in A_a} p_i(t) \\left( \\sum_{j \\in A_b} q_{ij} \\right)\n$$\nFor the aggregated process to be Markovian, the time derivative $\\frac{d \\widehat{p}_b(t)}{dt}$ must be a linear function of the aggregated probabilities $\\widehat{p}_a(t) = \\sum_{k \\in A_a} p_k(t)$. Looking at the derived expression, this requires that the term multiplying $p_i(t)$, which is the total rate from codon $i$ to the block of codons $A_b$, must be the same for all codons $i$ within a given block $A_a$. If this were not true, the evolution of $\\widehat{p}_b(t)$ would depend on the specific distribution of probabilities $p_i(t)$ within each block $A_a$, not just their sum, violating the Markov property for the aggregated process.\n\nThus, the necessary and sufficient condition for strong lumpability is: for any two amino acid blocks $A_a$ and $A_b$ (with $a \\neq b$), the sum of rates from an individual codon $i \\in A_a$ to all codons in block $A_b$ must be a constant value that depends only on the blocks $A_a$ and $A_b$, not on the specific choice of codon $i$. Formally:\n$$\n\\sum_{j \\in A_b} q_{ij} = C_{ab} \\quad \\text{for all } i \\in A_a\n$$\nWhen this condition holds, this constant $C_{ab}$ is precisely the aggregated off-diagonal rate $\\widehat{q}_{ab}$. We can then write:\n$$\n\\frac{d \\widehat{p}_b(t)}{dt} = \\sum_a \\sum_{i \\in A_a} p_i(t) \\widehat{q}_{ab} = \\sum_a \\widehat{q}_{ab} \\left(\\sum_{i \\in A_a} p_i(t)\\right) = \\sum_a \\widehat{p}_a(t) \\widehat{q}_{ab}\n$$\nThis is the forward equation for the aggregated CTMC. The constructive expression for the amino acid-level off-diagonal rate $\\widehat{q}_{ab}$ is therefore:\n$$\n\\widehat{q}_{ab} = \\sum_{j \\in A_b} q_{ij} \\quad \\text{for any } i \\in A_a, \\text{ where } a \\neq b\n$$\n\n**Task 2: Analysis of the Toy Subsystem**\n\nWe apply the condition derived above to the specified $4$-codon subsystem.\nThe amino acid blocks are:\n- Lysine (Lys): $A_{\\text{Lys}} = \\{\\text{AAA}, \\text{AAG}\\}$\n- Asparagine (Asn): $A_{\\text{Asn}} = \\{\\text{AAC}, \\text{AAU}\\}$\n\nThe nonzero codon substitution rates $q_{i \\to j}$ are given by the underlying nucleotide rates $r_{x \\to y}$ at the third position. From the problem statement, the relevant rates (in units of $\\mathrm{s}^{-1}$) are:\n- From codon $\\text{AAA} \\in A_{\\text{Lys}}$ to block $A_{\\text{Asn}}$:\n  $q_{\\text{AAA} \\to \\text{AAC}} = r_{A\\to C} = 3.0 \\times 10^{-1}$\n  $q_{\\text{AAA} \\to \\text{AAU}} = r_{A\\to U} = 6.0 \\times 10^{-1}$\n- From codon $\\text{AAG} \\in A_{\\text{Lys}}$ to block $A_{\\text{Asn}}$:\n  $q_{\\text{AAG} \\to \\text{AAC}} = r_{G\\to C} = 4.0 \\times 10^{-1}$\n  $q_{\\text{AAG} \\to \\text{AAU}} = r_{G\\to U} = 1.0 \\times 10^{-1}$\n\nFirst, we determine if the aggregation is strongly lumpable. We check if the total rate from each codon in $A_{\\text{Lys}}$ to the block $A_{\\text{Asn}}$ is constant.\n- For codon $\\text{AAA} \\in A_{\\text{Lys}}$:\n$$\n\\sum_{j \\in A_{\\text{Asn}}} q_{\\text{AAA} \\to j} = q_{\\text{AAA} \\to \\text{AAC}} + q_{\\text{AAA} \\to \\text{AAU}} = (3.0 \\times 10^{-1}) + (6.0 \\times 10^{-1}) = 9.0 \\times 10^{-1} \\, \\mathrm{s}^{-1}\n$$\n- For codon $\\text{AAG} \\in A_{\\text{Lys}}$:\n$$\n\\sum_{j \\in A_{\\text{Asn}}} q_{\\text{AAG} \\to j} = q_{\\text{AAG} \\to \\text{AAC}} + q_{\\text{AAG} \\to \\text{AAU}} = (4.0 \\times 10^{-1}) + (1.0 \\times 10^{-1}) = 5.0 \\times 10^{-1} \\, \\mathrm{s}^{-1}\n$$\nSince $9.0 \\times 10^{-1} \\neq 5.0 \\times 10^{-1}$, the lumpability condition is violated for transitions from the Lysine block to the Asparagine block. Therefore, the aggregation of this $4$-codon CTMC is not strongly lumpable.\n\nNext, we calculate the minimal additive adjustment $\\Delta$ to the rate $r_{G\\to U}$ that restores strong lumpability. The rate $r_{G\\to U}$ corresponds to the codon substitution rate $q_{\\text{AAG} \\to \\text{AAU}}$. Let the new rate be $r'_{G\\to U} = r_{G\\to U} + \\Delta$, which makes the new codon rate $q'_{\\text{AAG} \\to \\text{AAU}} = (1.0 \\times 10^{-1}) + \\Delta$. All other rates remain fixed.\n\nThe lumpability condition for transitions from $A_{\\text{Lys}}$ to $A_{\\text{Asn}}$ requires the total exit rates to be equal:\n$$\n\\sum_{j \\in A_{\\text{Asn}}} q_{\\text{AAA} \\to j} = \\sum_{j \\in A_{\\text{Asn}}} q'_{\\text{AAG} \\to j}\n$$\n$$\nq_{\\text{AAA} \\to \\text{AAC}} + q_{\\text{AAA} \\to \\text{AAU}} = q_{\\text{AAG} \\to \\text{AAC}} + q'_{\\text{AAG} \\to \\text{AAU}}\n$$\nSubstituting the numerical values and the expression for the adjusted rate:\n$$\n(3.0 \\times 10^{-1}) + (6.0 \\times 10^{-1}) = (4.0 \\times 10^{-1}) + \\left((1.0 \\times 10^{-1}) + \\Delta\\right)\n$$\n$$\n9.0 \\times 10^{-1} = 5.0 \\times 10^{-1} + \\Delta\n$$\nSolving for $\\Delta$:\n$$\n\\Delta = (9.0 \\times 10^{-1}) - (5.0 \\times 10^{-1}) = 4.0 \\times 10^{-1} \\, \\mathrm{s}^{-1}\n$$\nThe problem specifies the minimal such $\\Delta$. Since varying only $r_{G\\to U}$ leads to a single linear equation for $\\Delta$, the solution $\\Delta = 4.0 \\times 10^{-1}$ is unique and therefore minimal. The condition must also be checked for transitions from $A_{\\text{Asn}}$ to $A_{\\text{Lys}}$. The rates from codons $\\text{AAC}$ and $\\text{AAU}$ to the block $A_{\\text{Lys}}$ are all zero based on the provided list of nonzero nucleotide rates, so the sum of rates is $0$ from either codon. This part of the condition is satisfied and is unaffected by the change to $\\Delta$.\n\nThe required adjustment is $\\Delta = 4.0 \\times 10^{-1}$. The problem requires the answer to be rounded to four significant figures. Thus, $\\Delta = 0.4000 = 4.000 \\times 10^{-1}$.", "answer": "$$\n\\boxed{4.000 \\times 10^{-1}}\n$$", "id": "2691216"}, {"introduction": "While theoretical derivations provide essential insight, simulating the evolutionary process is a powerful tool for building intuition, testing hypotheses, and validating analytical methods. This final hands-on practice transitions from analytical solutions to computational implementation [@problem_id:2691283]. You will design and specify an algorithm to simulate sequence evolution on a phylogeny under a sophisticated model that accounts for rate variation across sites using a Gamma-plus-invariant ($\\Gamma+I$) distribution, a standard in modern phylogenetics. This exercise not only reinforces your understanding of the model's components but also provides practical experience with stochastic simulation techniques.", "problem": "Design and implement a complete, runnable program that simulates amino acid sequence evolution along a fixed rooted tree under a Continuous-Time Markov Chain (CTMC) with a Gamma-plus-invariant ($\\Gamma+I$) model of rate variation across sites, and then validates the site-rate mixture by comparing the empirical site-rate distribution to the target distribution. The simulation and validation must be specified purely in mathematical and algorithmic terms as follows.\n\n- Model foundation and definitions:\n  - Use a CTMC on $20$ amino acid states with generator matrix $Q=\\{q_{ij}\\}_{i,j=1}^{20}$ given by the Poisson amino acid model: for $i\\neq j$, set $q_{ij}=\\frac{1}{19}$ and $q_{ii}=-1$. This $Q$ has stationary distribution $\\pi_i=\\frac{1}{20}$ for all $i$ and mean substitution rate $-\\sum_{i=1}^{20}\\pi_i q_{ii}=1$.\n  - Rate heterogeneity across sites is modeled by independent and identically distributed site-specific relative rate multipliers $\\{r_s\\}_{s=1}^L$ with the Gamma-plus-invariant mixture: with probability $p_I$, $r_s=0$ (invariant), and with probability $(1-p_I)$, $r_s\\sim \\mathrm{Gamma}(\\alpha,\\theta)$ where the shape is $\\alpha$ and the scale is $\\theta=\\frac{1}{\\alpha}$, so that $\\mathbb{E}[r_s]=1$.\n  - Simulation along a branch of length $t$ at a site with rate $r_s$ follows the Gillespie algorithm for CTMCs: the waiting time to the next substitution event is exponentially distributed with rate $\\lambda_s=r_s(-q_{ii})=r_s$ when the current state is $i$, and at each event the new state is chosen uniformly among the $19$ states different from the current state. Equivalently (by the memoryless property of the exponential distribution and the thinning property of Poisson processes), the number of events on a branch of length $t$ at that site is $\\mathrm{Poisson}(r_s t)$; given $k$ events, apply $k$ successive instantaneous transitions where, at each transition, the new state is selected uniformly from the $19$ states not equal to the current one.\n  - The root sequence of length $L$ is drawn independently at each site from the stationary distribution ($\\pi_i=\\frac{1}{20}$ for all $i$).\n\n- Fixed rooted tree:\n  - Use a rooted, bifurcating tree with leaves labeled $A$, $B$, $C$, and $D$, and internal nodes $R$ (root), $X$, and $Y$. Branch lengths (in expected substitutions per site under mean rate $1$) are:\n    - $R\\to X$: $0.2$; $X\\to A$: $0.1$; $X\\to B$: $0.1$,\n    - $R\\to Y$: $0.15$; $Y\\to C$: $0.15$; $Y\\to D$: $0.15$.\n  - The CTMC is time-homogeneous with generator $Q$ scaled as above; the site-specific multiplier $r_s$ multiplies time along each branch (equivalently, multiplies the event rate).\n\n- Validation targets:\n  - For each simulation, let $\\widehat{p}_I$ be the empirical proportion of invariant sites, i.e., $\\widehat{p}_I=\\frac{1}{L}\\sum_{s=1}^L \\mathbf{1}\\{r_s=0\\}$, and report the absolute deviation $|\\widehat{p}_I-p_I|$.\n  - For the non-invariant sites (those with $r_s0$), compute the Kolmogorov–Smirnov (KS) statistic between the empirical cumulative distribution function $\\widehat{F}_L(x)$ of the sampled $\\{r_s:r_s0\\}$ and the target Gamma cumulative distribution function $F_{\\alpha,\\theta}(x)$ with $\\alpha$ as specified above and $\\theta=\\frac{1}{\\alpha}$; the KS statistic is $\\sup_{x\\ge 0}|\\widehat{F}_L(x)-F_{\\alpha,\\theta}(x)|$. Report this KS statistic.\n\n- Computational requirements:\n  - Represent amino acid states as integers in $\\{0,1,\\dots,19\\}$.\n  - Use the event-driven simulation (Gillespie) per site per branch as described; you may use the Poisson number-of-events representation implied by the model to implement the Gillespie dynamics efficiently.\n  - Sequences must be simulated at all leaves $A$, $B$, $C$, and $D$ by propagating the root sequence down the tree along each branch independently at each site using the site’s $r_s$.\n\n- Test suite:\n  - For each parameter set below, simulate a sequence of length $L$ on the fixed tree, and compute the two validation quantities $|\\widehat{p}_I-p_I|$ and the KS statistic on the non-invariant rates.\n  - Use the following parameter sets, each with its own independent pseudo-random seed to ensure reproducibility:\n    1. $(\\alpha,p_I,L,\\text{seed})=(0.5,\\,0.2,\\,5000,\\,12345)$,\n    2. $(\\alpha,p_I,L,\\text{seed})=(5.0,\\,0.0,\\,4000,\\,54321)$,\n    3. $(\\alpha,p_I,L,\\text{seed})=(0.2,\\,0.5,\\,6000,\\,424242)$.\n  - For each case, the program must:\n    - Sample the site-rate multipliers $\\{r_s\\}_{s=1}^L$ according to the $\\Gamma+I$ mixture with the specified $(\\alpha,p_I)$ and $\\theta=\\frac{1}{\\alpha}$,\n    - Simulate the evolution of the sequence along the tree under the specified CTMC using the Gillespie procedure,\n    - Compute and record the two validation metrics.\n\n- Final output format:\n  - Your program must produce a single line of output containing the results for the three test cases as a comma-separated list enclosed in square brackets.\n  - Each element must be a two-element list $[|\\widehat{p}_I-p_I|,\\ \\text{KS}]$ corresponding to the parameter sets in the order listed above.\n  - Each floating-point number in the output must be rounded to $10^{-6}$ precision (six digits after the decimal point).\n  - For example, a valid output format would look like $[[0.001234,0.017890],[0.000000,0.012345],[0.000500,0.045600]]$.\n  - The program must be self-contained, require no user input, and use only the specified libraries.\n\nNo physical units are involved beyond the conventional CTMC time scale; all branch lengths are in expected substitutions per site under mean rate $1$.", "solution": "The problem statement has been rigorously validated and is found to be scientifically sound, well-posed, and objective. It describes a standard simulation task in computational molecular evolution, free of contradictions or ambiguities. All necessary parameters and definitions for a complete and reproducible solution are provided. We proceed with the solution.\n\nThe task is to simulate amino acid sequence evolution on a fixed phylogenetic tree under a specified Continuous-Time Markov Chain (CTMC) model with site-rate heterogeneity, and then to validate the simulated distribution of site rates. The overall procedure involves two primary stages: first, generating site-specific evolutionary rates from a Gamma-plus-invariant ($\\Gamma+I$) mixture distribution and validating these rates; second, simulating sequence evolution along the tree branches according to these rates.\n\n**1. Site-Rate Generation and Validation**\n\nThe model for rate variation across sites is a mixture model, where each site $s \\in \\{1, \\dots, L\\}$ is assigned a relative rate multiplier $r_s$.\n-   With a given probability $p_I$, a site is invariant, meaning its rate is $r_s = 0$.\n-   With probability $1 - p_I$, a site is variable, and its rate $r_s$ is drawn from a Gamma distribution, $r_s \\sim \\mathrm{Gamma}(\\alpha, \\theta)$. The shape parameter is $\\alpha$, and the scale parameter is set to $\\theta = 1/\\alpha$ to ensure the mean of the variable rates is $\\mathbb{E}[r_s | r_s0] = \\alpha \\theta = 1$.\n\nThe algorithm for generating the $L$ site rates is as follows:\n1.  For each site $s$, draw a random number $u_s$ from a uniform distribution $\\mathrm{Uniform}(0, 1)$.\n2.  If $u_s  p_I$, set the site rate $r_s = 0$.\n3.  If $u_s \\ge p_I$, draw the site rate $r_s$ from the $\\mathrm{Gamma}(\\alpha, 1/\\alpha)$ distribution.\n\nAfter generating the vector of rates $\\{r_s\\}_{s=1}^L$, two validation metrics are computed:\n-   **Invariant Proportion Deviation**: The empirical proportion of invariant sites, $\\widehat{p}_I$, is calculated as the fraction of sites for which $r_s = 0$. The absolute deviation from the theoretical probability is then $|\\widehat{p}_I - p_I|$.\n-   **Kolmogorov-Smirnov (KS) Statistic**: For the subset of sites that are not invariant (i.e., $\\{r_s : r_s  0\\}$), we compare their empirical cumulative distribution function (CDF), $\\widehat{F}_L(x)$, against the theoretical CDF of the $\\mathrm{Gamma}(\\alpha, 1/\\alpha)$ distribution, $F_{\\alpha, 1/\\alpha}(x)$. The KS statistic is the maximum absolute difference between these two CDFs over all $x$:\n    $$ D_n = \\sup_x |\\widehat{F}_L(x) - F_{\\alpha, 1/\\alpha}(x)| $$\n    This statistic quantifies the \"goodness of fit\" of the sampled variable rates to the target Gamma distribution.\n\n**2. Sequence Evolution Simulation**\n\nThe evolution of an amino acid sequence is modeled as a CTMC on a set of $K=20$ states. The specified generator matrix is the Poisson model: $Q = \\{q_{ij}\\}$, where $q_{ij} = 1/(K-1) = 1/19$ for $i \\neq j$, and the diagonal elements are $q_{ii} = - \\sum_{j \\neq i} q_{ij} = -1$. This model has a uniform stationary distribution $\\pi_i = 1/K = 1/20$ for all states $i$.\n\nThe simulation proceeds from the root of the specified tree downwards to the leaves.\n-   **Root Sequence**: A sequence of length $L$ is initialized at the root node $R$. Each site's state is drawn independently from the stationary distribution, which is a uniform random choice from the $20$ amino acid states, represented as integers $\\{0, 1, \\dots, 19\\}$.\n-   **Evolution along a Branch**: The evolution along a branch of length $t$ is simulated independently for each site. For a site $s$ with rate $r_s$, the total branch length is scaled to $t' = r_s t$. The number of substitution events, $k$, that occur on this branch is a random variable drawn from a Poisson distribution with mean $\\lambda = t'$, i.e., $k \\sim \\mathrm{Poisson}(r_s t)$.\n    - If $k=0$, the state at the descendant node is the same as at the parent node.\n    - If $k0$, we must determine the final state after $k$ substitutions. Each substitution changes the current state to a new state chosen uniformly from the $19$ other states. Instead of simulating each jump sequentially, we can derive the transition probability after $k$ jumps. Let $P(\\text{state}_k = i | \\text{state}_0 = j)$ be the probability of being in state $i$ after $k$ jumps, starting from state $j$. Due to the model's symmetry, there are only two cases: staying in the same state ($i=j$) or moving to a specific different state ($i \\neq j$).\n      Let $p_k = P(\\text{state}_k = j | \\text{state}_0 = j)$. The probability of being at the initial state after $k+1$ steps is conditional on not being at the initial state after $k$ steps: $p_{k+1} = P(\\text{state}_{k+1}=j | \\text{state}_k \\neq j) P(\\text{state}_k \\neq j | \\text{state}_0=j) = \\frac{1}{19}(1 - p_k)$. With $p_0=1$, this recurrence relation solves to:\n      $$ p_k = \\frac{1}{20} + \\frac{19}{20} \\left(-\\frac{1}{19}\\right)^k $$\n      The probability of ending in any single other state $i \\neq j$ is $(1-p_k)/19$.\n      This analytical result allows for an efficient vectorized implementation. For each site with $k  0$ events, we draw a uniform random number $u \\in [0, 1)$. If $u  p_k$, the state remains unchanged. Otherwise, it transitions to a new state chosen uniformly from the other $19$ states.\n\nThe simulation traverses the tree structure ($R \\to X \\to \\{A, B\\}$ and $R \\to Y \\to \\{C, D\\}$), applying this process for each of the six branches using their specified lengths. This generates the final sequences at the leaves $A, B, C$, and $D$.\n\n**3. Implementation**\n\nThe implementation uses the `numpy` library for efficient array-based computations, particularly for generating random numbers and performing vectorized operations on the sequence and rate arrays. The `scipy.stats` module is used for calculating the theoretical CDF of the Gamma distribution needed for the Kolmogorov-Smirnov test (`kstest`). The simulation logic is encapsulated in a function that processes all test cases, setting the random seed for each to ensure reproducibility. Final results are formatted to the required precision.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import stats\n\ndef solve():\n    \"\"\"\n    Main function to run the simulation and validation for all test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (Parameter set 1): (alpha, p_I, L, seed)\n        (0.5, 0.2, 5000, 12345),\n        # (Parameter set 2)\n        (5.0, 0.0, 4000, 54321),\n        # (Parameter set 3)\n        (0.2, 0.5, 6000, 424242),\n    ]\n\n    NUM_STATES = 20\n    \n    # Fixed tree branch lengths\n    branch_lengths = {\n        'RX': 0.2, 'XA': 0.1, 'XB': 0.1,\n        'RY': 0.15, 'YC': 0.15, 'YD': 0.15\n    }\n\n    results = []\n\n    def simulate_branch(parent_seq, branch_length, site_rates, rng):\n        \"\"\"\n        Simulates sequence evolution along a single branch.\n        \"\"\"\n        L = len(parent_seq)\n        \n        # Calculate Poisson mean for number of events at each site\n        lambdas = site_rates * branch_length\n        num_events = rng.poisson(lam=lambdas)\n        \n        child_seq = parent_seq.copy()\n        \n        # Identify sites where at least one substitution event occurred\n        sites_with_events = np.where(num_events  0)[0]\n        if sites_with_events.size == 0:\n            return child_seq\n\n        k = num_events[sites_with_events]\n        \n        # Probability of returning to the original state after k substitutions\n        prob_stay = 1/NUM_STATES + ((NUM_STATES-1)/NUM_STATES) * (-1/(NUM_STATES-1))**k\n        \n        # Decide which sites will change state based on prob_stay\n        u = rng.random(size=sites_with_events.size)\n        change_mask = u = prob_stay\n        \n        indices_to_change = sites_with_events[change_mask]\n        if indices_to_change.size == 0:\n            return child_seq\n\n        initial_states_to_change = parent_seq[indices_to_change]\n        \n        # For sites that change, pick a new state uniformly from the other N-1 states\n        num_to_change = indices_to_change.size\n        # Sample an integer in {0, ..., N-2}\n        new_state_draws = rng.integers(0, NUM_STATES - 1, size=num_to_change)\n        \n        # Map {0, ..., N-2} to {0, ..., N-1} \\ {current_state}\n        child_seq[indices_to_change] = new_state_draws + (new_state_draws = initial_states_to_change)\n        \n        return child_seq\n\n    for alpha, p_I, L, seed in test_cases:\n        rng = np.random.default_rng(seed)\n\n        # 1. Generate site rates from Gamma+I mixture model\n        rates = np.zeros(L, dtype=np.float64)\n        invariant_mask = rng.random(size=L)  p_I\n        \n        num_invariant = np.sum(invariant_mask)\n        num_variant = L - num_invariant\n        \n        if num_variant  0:\n            variant_rates = rng.gamma(shape=alpha, scale=1.0/alpha, size=num_variant)\n            rates[~invariant_mask] = variant_rates\n        else:\n            variant_rates = np.array([])\n        \n        # 2. Validate the site rates distribution\n        # Metric 1: Absolute deviation of p_I\n        p_I_hat = num_invariant / L\n        p_I_dev = abs(p_I_hat - p_I)\n        \n        # Metric 2: KS statistic for non-invariant rates\n        if num_variant  0:\n            # The CDF for the kstest is the Gamma distribution\n            gamma_cdf_func = lambda x: stats.gamma.cdf(x, a=alpha, scale=1.0/alpha)\n            ks_stat, _ = stats.kstest(variant_rates, gamma_cdf_func)\n        else:\n            ks_stat = 0.0\n\n        # 3. Simulate sequence evolution on the tree (as required by the prompt)\n        # Root sequence drawn from stationary distribution (uniform)\n        root_seq = rng.integers(0, NUM_STATES, size=L)\n        \n        # Evolve down the tree from root to leaves\n        seq_X = simulate_branch(root_seq, branch_lengths['RX'], rates, rng)\n        seq_A = simulate_branch(seq_X, branch_lengths['XA'], rates, rng)\n        seq_B = simulate_branch(seq_X, branch_lengths['XB'], rates, rng)\n        \n        seq_Y = simulate_branch(root_seq, branch_lengths['RY'], rates, rng)\n        seq_C = simulate_branch(seq_Y, branch_lengths['YC'], rates, rng)\n        seq_D = simulate_branch(seq_Y, branch_lengths['YD'], rates, rng)\n        # Final leaf sequences are seq_A, seq_B, seq_C, seq_D.\n        \n        results.append([p_I_dev, ks_stat])\n\n    # Final print statement in the exact required format.\n    output_str = \"[\" + \",\".join([f\"[{r[0]:.6f},{r[1]:.6f}]\" for r in results]) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "2691283"}]}