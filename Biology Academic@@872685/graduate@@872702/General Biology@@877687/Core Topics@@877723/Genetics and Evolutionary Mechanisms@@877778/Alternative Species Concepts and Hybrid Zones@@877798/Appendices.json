{"hands_on_practices": [{"introduction": "Understanding speciation requires quantifying the barriers that prevent gene flow between diverging lineages. This exercise provides a hands-on approach to modeling the collective strength of multiple 'barrier loci' acting across a hybrid zone [@problem_id:2775018]. By deriving the cumulative barrier strength from first principles, you will explore the critical interplay between selection ($s$) and recombination ($r$) in determining the effective rate of migration for a neutral genetic marker.", "problem": "Two partially isolated taxa meet in a narrow hybrid zone and exchange migrants between two demes at a baseline per-generation migration rate $m$. Consider a focal neutral marker carried initially on an immigrant haplotype that also bears $k$ barrier loci, each of which experiences viability selection against the immigrant allele in the recipient deme. Assume the following:\n- Selection acts independently at each barrier locus $i \\in \\{1,\\dots,k\\}$, removing the immigrant haplotype at a per-generation rate characterized by a selection coefficient $s_i$.\n- The neutral marker recombines away from barrier locus $i$ at recombination fraction $r_i$ per generation; once recombined away, selection at that barrier locus no longer removes the neutral marker through that locus.\n- Across loci, recombination and selection hazards act independently and additively over short time scales (weak per-generation hazards), and Linkage Disequilibrium (LD) is initially generated only by the immigrant background.\n- Following classic definitions of barrier strength in hybrid zone theory, define the cumulative barrier strength $B$ at the neutral marker by the relationship $m_{\\text{eff}} = \\frac{m}{1 + B}$, where $m_{\\text{eff}}$ is the effective migration rate of the neutral marker after accounting for selection at the barrier loci.\n\nStarting from these assumptions and first principles of competition between alternative hazards (recombination versus selective removal), derive an expression for $B$ as a function of $\\{s_i\\}$ and $\\{r_i\\}$, and then compute the numerical value of $B$ for the parameter set below:\n- $k = 4$\n- $(s_1, s_2, s_3, s_4) = (0.02, 0.03, 0.02, 0.01)$\n- $(r_1, r_2, r_3, r_4) = (0.02, 0.03, 0.01, 0.02)$\n\nExpress your final numerical answer for $B$ as a dimensionless decimal rounded to four significant figures.", "solution": "The problem requires the derivation of an expression for the cumulative barrier strength, $B$, and its subsequent numerical calculation. The validation of the problem statement must precede any attempt at a solution.\n\nStep 1: Extract Givens.\n- Baseline per-generation migration rate: $m$.\n- Number of barrier loci: $k$.\n- A neutral marker is initially linked to $k$ barrier loci on an immigrant haplotype.\n- Selection acts independently at each barrier locus $i$, with a selection coefficient $s_i$.\n- The neutral marker recombines from barrier locus $i$ with a recombination fraction $r_i$.\n- Hazards from recombination and selection are independent and additive over short time scales.\n- The cumulative barrier strength $B$ is defined by the relation $m_{\\text{eff}} = \\frac{m}{1 + B}$, where $m_{\\text{eff}}$ is the effective migration rate of the neutral marker.\n- Numerical parameters:\n  - $k = 4$\n  - Selection coefficients: $(s_1, s_2, s_3, s_4) = (0.02, 0.03, 0.02, 0.01)$\n  - Recombination fractions: $(r_1, r_2, r_3, r_4) = (0.02, 0.03, 0.01, 0.02)$\n\nStep 2: Validate Using Extracted Givens.\nThe problem is scientifically grounded, rooted in established models of population genetics, specifically hybrid zone theory and the concept of linked selection (e.g., Barton  Bengtsson, 1986). The parameters are specified, the definitions are clear, and the assumptions (independence of loci, weak hazards) are explicitly stated, rendering the problem well-posed and objective. The provided numerical values for selection coefficients and recombination rates are biologically plausible. There are no contradictions, ambiguities, or violations of fundamental principles. The problem is valid.\n\nStep 3: Derivation and Solution.\nThe task is to find the effective migration rate, $m_{\\text{eff}}$, of a neutral marker that is initially in complete linkage disequilibrium with $k$ deleterious alleles. The effective migration rate is the baseline migration rate, $m$, multiplied by the probability that the neutral marker successfully introgresses, i.e., that it survives the indirect selection acting upon it through its linkage to the barrier loci.\n\nConsider a single barrier locus, $i$. The immigrant haplotype carrying the neutral marker is subject to two competing processes:\n1. Selective removal of the haplotype at a rate $s_i$ per generation.\n2. Disruption of the linkage between the neutral marker and the deleterious allele at locus $i$ via recombination, which occurs at a rate $r_i$ per generation.\n\nAssuming these are weak, continuous-time hazards, this is a classic competing risks problem. The total rate at which the linkage association between the marker and the deleterious allele at locus $i$ is resolved (either by removal of the haplotype or by recombination) is the sum of the individual rates, $s_i + r_i$. The probability that this resolution occurs via recombination—the event that allows the marker to \"escape\" selection from this locus—is the ratio of the recombination rate to the total rate of events.\n\nLet $P_{\\text{escape}, i}$ be the probability of escape from the selective drag of locus $i$.\n$$P_{\\text{escape}, i} = \\frac{r_i}{r_i + s_i}$$\nThis expression gives the probability that the neutral marker lineage recombines away from the deleterious allele before it is purged from the population by selection acting at locus $i$.\n\nThe problem states that selection and recombination act independently across the $k$ barrier loci. For the neutral marker to successfully introgress, it must escape the selective drag from all $k$ loci. The total probability of survival for the marker, $P_{\\text{survival}}$, is therefore the product of the individual escape probabilities for each locus.\n$$P_{\\text{survival}} = \\prod_{i=1}^{k} P_{\\text{escape}, i} = \\prod_{i=1}^{k} \\frac{r_i}{r_i + s_i}$$\n\nThe effective migration rate, $m_{\\text{eff}}$, is the product of the baseline migration rate, $m$, and the probability of survival.\n$$m_{\\text{eff}} = m \\cdot P_{\\text{survival}} = m \\prod_{i=1}^{k} \\frac{r_i}{r_i + s_i}$$\n\nWe are given the definition of the cumulative barrier strength, $B$, as $m_{\\text{eff}} = \\frac{m}{1 + B}$. We can now equate the two expressions for $m_{\\text{eff}}$ to solve for $B$.\n$$\\frac{m}{1 + B} = m \\prod_{i=1}^{k} \\frac{r_i}{r_i + s_i}$$\nDividing both sides by $m$ (assuming $m \\neq 0$) gives:\n$$\\frac{1}{1 + B} = \\prod_{i=1}^{k} \\frac{r_i}{r_i + s_i}$$\nInverting both sides yields:\n$$1 + B = \\frac{1}{\\prod_{i=1}^{k} \\frac{r_i}{r_i + s_i}} = \\prod_{i=1}^{k} \\frac{r_i + s_i}{r_i}$$\nThis simplifies to:\n$$1 + B = \\prod_{i=1}^{k} \\left(1 + \\frac{s_i}{r_i}\\right)$$\nFinally, the expression for the cumulative barrier strength $B$ is:\n$$B = \\left[ \\prod_{i=1}^{k} \\left(1 + \\frac{s_i}{r_i}\\right) \\right] - 1$$\nThis is the derived expression for $B$ from first principles.\n\nNow, we compute the numerical value of $B$ using the provided parameters for $k=4$.\nThe ratios $\\frac{s_i}{r_i}$ for each of the $4$ loci are:\n- For locus $i=1$: $\\frac{s_1}{r_1} = \\frac{0.02}{0.02} = 1$\n- For locus $i=2$: $\\frac{s_2}{r_2} = \\frac{0.03}{0.03} = 1$\n- For locus $i=3$: $\\frac{s_3}{r_3} = \\frac{0.02}{0.01} = 2$\n- For locus $i=4$: $\\frac{s_4}{r_4} = \\frac{0.01}{0.02} = 0.5$\n\nNext, we calculate the terms $\\left(1 + \\frac{s_i}{r_i}\\right)$:\n- Locus $1$: $1 + 1 = 2$\n- Locus $2$: $1 + 1 = 2$\n- Locus $3$: $1 + 2 = 3$\n- Locus $4$: $1 + 0.5 = 1.5$\n\nWe then compute the product:\n$$\\prod_{i=1}^{4} \\left(1 + \\frac{s_i}{r_i}\\right) = 2 \\times 2 \\times 3 \\times 1.5 = 4 \\times 4.5 = 18$$\nThis product is equal to $1 + B$:\n$$1 + B = 18$$\nSolving for $B$:\n$$B = 18 - 1 = 17$$\nThe problem requires the answer as a decimal rounded to four significant figures.\n$$B = 17.00$$\nThis final result represents the cumulative strength of the barrier to introgression for the neutral marker, which reduces the effective migration rate by a factor of $1 + B = 18$.", "answer": "$$\\boxed{17.00}$$", "id": "2775018"}, {"introduction": "The processes of divergence and gene flow leave distinct footprints across the genome, often visible as 'islands' of high differentiation. This computational practice challenges you to analyze genomic data to distinguish between different evolutionary scenarios [@problem_id:2774991]. You will implement the calculation of standard population genetic statistics, $F_{ST}$ and $d_{XY}$, and use their relationship with recombination rates to infer whether genomic patterns are shaped by selection against ongoing gene flow or by other processes like linked selection in allopatry.", "problem": "You are provided with a computational task grounded in population genetics to evaluate alternative species concepts in the context of hybrid zones using genome-wide summary statistics. Starting from fundamental definitions, implement windowed estimates of Wright’s fixation index and absolute divergence, and infer whether the observed patterns across a genome are more consistent with selection against gene flow or with linked selection alone. All computations are to be performed from first principles and must adhere to the following definitions, rules, and decision criteria.\n\nFundamental base and definitions:\n- Consider two populations sampled across a genome divided into non-overlapping windows. For each window, you are given site-wise allele frequencies in population $1$, denoted by $p_{1,i}$, and in population $2$, denoted by $p_{2,i}$, for sites $i = 1, \\dots, S$, where $S$ is the number of sites in the window.\n- Within-population expected heterozygosity at site $i$ in population $k \\in \\{1,2\\}$ is defined as $H_{k,i} = 2 \\, p_{k,i} \\, \\left(1 - p_{k,i}\\right)$.\n- The within-subpopulation heterozygosity at site $i$ averaged across the two populations is $H_{S,i} = \\dfrac{H_{1,i} + H_{2,i}}{2}$.\n- The total heterozygosity at site $i$ is defined as $H_{T,i} = 2 \\, \\bar{p}_i \\, \\left(1 - \\bar{p}_i\\right)$, where $\\bar{p}_i = \\dfrac{p_{1,i} + p_{2,i}}{2}$.\n- The window-averaged within-subpopulation heterozygosity is $H_S^{(w)} = \\dfrac{1}{S} \\sum_{i=1}^{S} H_{S,i}$ and the window-averaged total heterozygosity is $H_T^{(w)} = \\dfrac{1}{S} \\sum_{i=1}^{S} H_{T,i}$.\n- Define the windowed fixation index as $F_{ST}^{(w)} = 1 - \\dfrac{H_S^{(w)}}{H_T^{(w)}}$ for windows with $H_T^{(w)} > 0$. If $H_T^{(w)} = 0$, then $F_{ST}^{(w)}$ is undefined for that window and must be excluded from any correlation that involves $F_{ST}^{(w)}$.\n- The absolute divergence at site $i$ is $d_{XY,i} = p_{1,i}\\left(1 - p_{2,i}\\right) + p_{2,i}\\left(1 - p_{1,i}\\right) = p_{1,i} + p_{2,i} - 2 p_{1,i} p_{2,i}$. The window-averaged absolute divergence is $d_{XY}^{(w)} = \\dfrac{1}{S} \\sum_{i=1}^{S} d_{XY,i}$.\n\nInference logic to distinguish scenarios:\n- Let $r^{(w)}$ denote the recombination rate proxy for window $w$ (dimensionless for this problem).\n- Compute the Spearman rank correlation coefficient between $d_{XY}^{(w)}$ and $r^{(w)}$ across all windows, denoted $\\rho\\left(d_{XY}, r\\right)$. If the $d_{XY}^{(w)}$ values are constant across windows (zero variance), define $\\rho\\left(d_{XY}, r\\right) = 0$ by convention for this problem.\n- Compute the Spearman rank correlation coefficient between $F_{ST}^{(w)}$ and $d_{XY}^{(w)}$ across windows where $F_{ST}^{(w)}$ is defined, denoted $\\rho\\left(F_{ST}, d_{XY}\\right)$. If the $F_{ST}^{(w)}$ values included are constant (zero variance), define $\\rho\\left(F_{ST}, d_{XY}\\right) = 0$ by convention for this problem.\n- Decision rule (heuristic consistent with well-established expectations in hybrid zone genomics):\n  - Infer “selection against gene flow” if and only if $\\rho\\left(d_{XY}, r\\right) \\le -0.3$ and $\\rho\\left(F_{ST}, d_{XY}\\right) \\ge 0.3$.\n  - Otherwise, infer “linked selection alone.”\n- Your program must output, for each dataset, an integer classification: output $1$ for “selection against gene flow” and $0$ for “linked selection alone.”\n\nTest suite (datasets):\nEach dataset is a list of windows. Each window contains:\n- A recombination rate value $r^{(w)}$.\n- A list of allele frequencies $[p_{1,1}, \\dots, p_{1,S}]$ and $[p_{2,1}, \\dots, p_{2,S}]$ for the two populations, with $S = 6$ sites per window.\n\nDataset A (expected to be consistent with selection against gene flow; negative association of $d_{XY}^{(w)}$ with recombination and positive association of $F_{ST}^{(w)}$ with $d_{XY}^{(w)}$):\n- Recombination rates: $[0.4, 0.8, 1.2, 1.6, 2.0]$.\n- Windows (each line shows $[p_{1,1},\\dots,p_{1,6}]$ and $[p_{2,1},\\dots,p_{2,6}]$):\n  1. $p_1 = [0.95, 0.90, 0.85, 0.10, 0.20, 0.15]$, $p_2 = [0.05, 0.10, 0.15, 0.90, 0.80, 0.85]$.\n  2. $p_1 = [0.75, 0.70, 0.65, 0.35, 0.30, 0.25]$, $p_2 = [0.25, 0.30, 0.35, 0.65, 0.70, 0.75]$.\n  3. $p_1 = [0.60, 0.55, 0.52, 0.48, 0.45, 0.40]$, $p_2 = [0.40, 0.45, 0.48, 0.52, 0.55, 0.60]$.\n  4. $p_1 = [0.55, 0.50, 0.52, 0.49, 0.51, 0.50]$, $p_2 = [0.45, 0.50, 0.48, 0.51, 0.49, 0.50]$.\n  5. $p_1 = [0.50, 0.50, 0.50, 0.50, 0.50, 0.50]$, $p_2 = [0.50, 0.50, 0.50, 0.50, 0.50, 0.50]$.\n\nDataset B (expected to be consistent with linked selection alone; $d_{XY}^{(w)}$ approximately constant across recombination while $F_{ST}^{(w)}$ decreases with recombination):\n- Recombination rates: $[0.4, 0.8, 1.2, 1.6, 2.0]$.\n- For all windows, target per-site absolute divergence is fixed at $0.4$, i.e., each site satisfies $p_{1,i} + p_{2,i} - 2 p_{1,i} p_{2,i} = 0.4$. The following values meet that condition:\n  1. $p_1 = [0.10, 0.15, 0.10, 0.20, 0.12, 0.18]$, $p_2 = [0.3750000, 0.3571429, 0.3750000, 0.3333333, 0.3684211, 0.3437500]$.\n  2. $p_1 = [0.18, 0.22, 0.16, 0.24, 0.20, 0.26]$, $p_2 = [0.3437500, 0.3214286, 0.3529412, 0.3076923, 0.3333333, 0.2916667]$.\n  3. $p_1 = [0.22, 0.24, 0.26, 0.28, 0.23, 0.27]$, $p_2 = [0.3214286, 0.3076923, 0.2916667, 0.2727273, 0.3142857, 0.2857143]$.\n  4. $p_1 = [0.26, 0.27, 0.28, 0.29, 0.30, 0.31]$, $p_2 = [0.2916667, 0.2826087, 0.2727273, 0.2631579, 0.2500000, 0.2368421]$.\n  5. $p_1 = [0.30, 0.28, 0.32, 0.27, 0.33, 0.31]$, $p_2 = [0.2500000, 0.2727273, 0.2222222, 0.2826087, 0.2058824, 0.2368421]$.\n\nDataset C (edge case including a window with undefined $F_{ST}^{(w)}$ due to zero total heterozygosity; expected to be consistent with linked selection alone):\n- Recombination rates: $[0.5, 1.0, 1.5, 2.0]$.\n- Windows:\n  1. $p_1 = [0.0, 0.0, 0.0, 1.0, 1.0, 1.0]$, $p_2 = [0.0, 0.0, 0.0, 1.0, 1.0, 1.0]$.\n  2. $p_1 = [0.40, 0.45, 0.50, 0.55, 0.60, 0.65]$, $p_2 = [0.35, 0.40, 0.45, 0.50, 0.55, 0.60]$.\n  3. $p_1 = [0.50, 0.55, 0.60, 0.65, 0.70, 0.75]$, $p_2 = [0.45, 0.50, 0.55, 0.60, 0.65, 0.70]$.\n  4. $p_1 = [0.55, 0.60, 0.65, 0.70, 0.75, 0.80]$, $p_2 = [0.50, 0.55, 0.60, 0.65, 0.70, 0.75]$.\n\nRequired computations and final output:\n1. For each dataset, compute $F_{ST}^{(w)}$ and $d_{XY}^{(w)}$ for every window using the definitions above.\n2. Compute $\\rho\\left(d_{XY}, r\\right)$ across all windows in the dataset.\n3. Compute $\\rho\\left(F_{ST}, d_{XY}\\right)$ across windows with defined $F_{ST}^{(w)}$ in the dataset.\n4. Apply the decision rule with thresholds $-0.3$ and $0.3$ exactly as specified to output an integer label per dataset: output $1$ for “selection against gene flow” and $0$ for “linked selection alone.”\n5. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for the datasets in the order A, B, C. For example, output like $[1,0,0]$ (this is only an example format; the actual values must come from your computation).\n\nAngle units are not applicable. No physical units are involved. All outputs must be integers.", "solution": "The problem presented is a computational exercise in population genetics, requiring the implementation of a defined workflow to distinguish between two evolutionary scenarios in a hybrid zone: \"selection against gene flow\" and \"linked selection alone\". This task is grounded in established principles and employs standard summary statistics. The problem is well-posed, scientifically sound, and provides all necessary definitions and data for a unique solution. I will proceed with a systematic derivation and implementation.\n\nThe analysis is based on two key statistics calculated for non-overlapping genomic windows: the absolute divergence, $d_{XY}^{(w)}$, and Wright's fixation index, $F_{ST}^{(w)}$. These statistics quantify different aspects of genetic differentiation between two populations.\n\nFirst, we must define the site-wise quantities from which the windowed statistics are derived. For a given genetic site $i$ with allele frequencies $p_{1,i}$ and $p_{2,i}$ in two populations, the fundamental quantities are:\n\n1.  **Within-Population Heterozygosity**: The expected heterozygosity at site $i$ for population $k \\in \\{1, 2\\}$ is given by:\n    $$H_{k,i} = 2 \\, p_{k,i} \\, (1 - p_{k,i})$$\n    This measures the probability that two randomly chosen alleles from population $k$ at site $i$ are different.\n\n2.  **Average Within-Subpopulation Heterozygosity**: At site $i$, this is the arithmetic mean of the heterozygosities of the two populations:\n    $$H_{S,i} = \\frac{H_{1,i} + H_{2,i}}{2}$$\n\n3.  **Total Heterozygosity**: This is the expected heterozygosity at site $i$ in a hypothetical total population formed by pooling the two subpopulations. It is calculated using the average allele frequency, $\\bar{p}_i = \\frac{p_{1,i} + p_{2,i}}{2}$:\n    $$H_{T,i} = 2 \\, \\bar{p}_i \\, (1 - \\bar{p}_i)$$\n\n4.  **Absolute Divergence**: The absolute divergence, $d_{XY,i}$, at site $i$ represents the probability that an allele from population $1$ and an allele from population $2$ are different. It is defined as:\n    $$d_{XY,i} = p_{1,i}(1 - p_{2,i}) + p_{2,i}(1 - p_{1,i}) = p_{1,i} + p_{2,i} - 2 p_{1,i} p_{2,i}$$\n\nNext, we average these site-wise values over all $S$ sites within a genomic window $w$ to obtain the windowed statistics:\n\n1.  **Windowed Average Within-Subpopulation Heterozygosity**:\n    $$H_S^{(w)} = \\frac{1}{S} \\sum_{i=1}^{S} H_{S,i}$$\n\n2.  **Windowed Average Total Heterozygosity**:\n    $$H_T^{(w)} = \\frac{1}{S} \\sum_{i=1}^{S} H_{T,i}$$\n\n3.  **Windowed Fixation Index ($F_{ST}^{(w)}$)**: This statistic measures the reduction in heterozygosity in subpopulations compared to the total population due to allele frequency differences. It is defined as:\n    $$F_{ST}^{(w)} = 1 - \\frac{H_S^{(w)}}{H_T^{(w)}}$$\n    This quantity is defined only when $H_T^{(w)} > 0$. If $H_T^{(w)} = 0$, it implies all sites in the window are fixed for the same allele in both populations combined, making the concept of differentiation meaningless. Such windows must be excluded from any correlation analysis involving $F_{ST}^{(w)}$.\n\n4.  **Windowed Absolute Divergence ($d_{XY}^{(w)}$)**:\n    $$d_{XY}^{(w)} = \\frac{1}{S} \\sum_{i=1}^{S} d_{XY,i}$$\n\nWith these windowed statistics calculated for each window in a dataset, the next step is to perform an inference using Spearman's rank correlation coefficient, $\\rho$. This non-parametric statistic assesses the strength and direction of a monotonic relationship between two variables.\n\nTwo specific correlations are computed:\n\n1.  $\\rho(d_{XY}, r)$: The correlation between windowed absolute divergence $d_{XY}^{(w)}$ and a proxy for the local recombination rate $r^{(w)}$. A strong negative correlation is expected under selection against gene flow, as barriers to gene flow are more effective at maintaining divergence in regions of low recombination.\n\n2.  $\\rho(F_{ST}, d_{XY})$: The correlation between the windowed fixation index $F_{ST}^{(w)}$ and absolute divergence $d_{XY}^{(w)}$. A strong positive correlation is expected when divergence is driven by barriers to gene flow, as both measures of differentiation should increase in concert in \"islands of divergence\".\n\nThe problem specifies handling of special cases: if a series of values ($d_{XY}^{(w)}$ or the valid $F_{ST}^{(w)}$ values) is constant (has zero variance), its correlation is defined as $0$.\n\nFinally, a decision rule is applied to classify each dataset:\n- The scenario is inferred as **\"selection against gene flow\"** (output $1$) if and only if both conditions are met:\n  $$\\rho(d_{XY}, r) \\le -0.3 \\quad \\text{and} \\quad \\rho(F_{ST}, d_{XY}) \\ge 0.3$$\n- Otherwise, the scenario is inferred as **\"linked selection alone\"** (output $0$).\n\nThe implementation will systematically apply these calculations to each provided dataset. The allele frequency data will be processed using `numpy` for efficient vectorized computation. The Spearman correlation will be calculated using `scipy.stats.spearmanr`, with manual checks for constant series and for undefined $F_{ST}^{(w)}$ values as per the problem's strict directives.", "answer": "```python\nimport numpy as np\nfrom scipy.stats import spearmanr\n\ndef solve():\n    \"\"\"\n    Solves the computational biology problem by calculating windowed population genetic\n    statistics and applying a decision rule based on Spearman rank correlations.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"name\": \"A\",\n            \"recombs\": [0.4, 0.8, 1.2, 1.6, 2.0],\n            \"windows_p1\": [\n                [0.95, 0.90, 0.85, 0.10, 0.20, 0.15],\n                [0.75, 0.70, 0.65, 0.35, 0.30, 0.25],\n                [0.60, 0.55, 0.52, 0.48, 0.45, 0.40],\n                [0.55, 0.50, 0.52, 0.49, 0.51, 0.50],\n                [0.50, 0.50, 0.50, 0.50, 0.50, 0.50],\n            ],\n            \"windows_p2\": [\n                [0.05, 0.10, 0.15, 0.90, 0.80, 0.85],\n                [0.25, 0.30, 0.35, 0.65, 0.70, 0.75],\n                [0.40, 0.45, 0.48, 0.52, 0.55, 0.60],\n                [0.45, 0.50, 0.48, 0.51, 0.49, 0.50],\n                [0.50, 0.50, 0.50, 0.50, 0.50, 0.50],\n            ],\n        },\n        {\n            \"name\": \"B\",\n            \"recombs\": [0.4, 0.8, 1.2, 1.6, 2.0],\n            \"windows_p1\": [\n                [0.10, 0.15, 0.10, 0.20, 0.12, 0.18],\n                [0.18, 0.22, 0.16, 0.24, 0.20, 0.26],\n                [0.22, 0.24, 0.26, 0.28, 0.23, 0.27],\n                [0.26, 0.27, 0.28, 0.29, 0.30, 0.31],\n                [0.30, 0.28, 0.32, 0.27, 0.33, 0.31],\n            ],\n            \"windows_p2\": [\n                [0.3750000, 0.3571429, 0.3750000, 0.3333333, 0.3684211, 0.3437500],\n                [0.3437500, 0.3214286, 0.3529412, 0.3076923, 0.3333333, 0.2916667],\n                [0.3214286, 0.3076923, 0.2916667, 0.2727273, 0.3142857, 0.2857143],\n                [0.2916667, 0.2826087, 0.2727273, 0.2631579, 0.2500000, 0.2368421],\n                [0.2500000, 0.2727273, 0.2222222, 0.2826087, 0.2058824, 0.2368421],\n            ],\n        },\n        {\n            \"name\": \"C\",\n            \"recombs\": [0.5, 1.0, 1.5, 2.0],\n            \"windows_p1\": [\n                [0.0, 0.0, 0.0, 1.0, 1.0, 1.0],\n                [0.40, 0.45, 0.50, 0.55, 0.60, 0.65],\n                [0.50, 0.55, 0.60, 0.65, 0.70, 0.75],\n                [0.55, 0.60, 0.65, 0.70, 0.75, 0.80],\n            ],\n            \"windows_p2\": [\n                [0.0, 0.0, 0.0, 1.0, 1.0, 1.0],\n                [0.35, 0.40, 0.45, 0.50, 0.55, 0.60],\n                [0.45, 0.50, 0.55, 0.60, 0.65, 0.70],\n                [0.50, 0.55, 0.60, 0.65, 0.70, 0.75],\n            ],\n        },\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        window_fsts = []\n        window_dxys = []\n        \n        num_windows = len(case[\"recombs\"])\n        for i in range(num_windows):\n            p1 = np.array(case[\"windows_p1\"][i])\n            p2 = np.array(case[\"windows_p2\"][i])\n            \n            # Within-population heterozygosities\n            h1 = 2 * p1 * (1 - p1)\n            h2 = 2 * p2 * (1 - p2)\n            \n            # Within-subpopulation heterozygosity\n            hs_site = (h1 + h2) / 2\n            hs_window = np.mean(hs_site)\n            \n            # Total heterozygosity\n            p_bar = (p1 + p2) / 2\n            ht_site = 2 * p_bar * (1 - p_bar)\n            ht_window = np.mean(ht_site)\n\n            # Absolute divergence\n            dxy_site = p1 + p2 - 2 * p1 * p2\n            dxy_window = np.mean(dxy_site)\n            window_dxys.append(dxy_window)\n            \n            # Fixation index (Fst)\n            if ht_window > 0:\n                fst_window = 1 - hs_window / ht_window\n                window_fsts.append(fst_window)\n            else:\n                window_fsts.append(np.nan)\n\n        # Compute Spearman correlations\n        \n        # rho(d_XY, r)\n        dxy_array = np.array(window_dxys)\n        recomb_array = np.array(case[\"recombs\"])\n        \n        if np.var(dxy_array, ddof=0) == 0:\n            rho_dxy_r = 0.0\n        else:\n            rho_dxy_r, _ = spearmanr(dxy_array, recomb_array)\n\n        # rho(F_ST, d_XY)\n        fst_array = np.array(window_fsts)\n        \n        # Filter out windows where Fst is undefined (nan)\n        valid_indices = ~np.isnan(fst_array)\n        filtered_fsts = fst_array[valid_indices]\n        filtered_dxys = dxy_array[valid_indices]\n        \n        if len(filtered_fsts)  2 or np.var(filtered_fsts, ddof=0) == 0:\n            rho_fst_dxy = 0.0\n        else:\n            rho_fst_dxy, _ = spearmanr(filtered_fsts, filtered_dxys)\n            \n        # Apply the decision rule\n        if rho_dxy_r = -0.3 and rho_fst_dxy >= 0.3:\n            classification = 1\n        else:\n            classification = 0\n        \n        results.append(classification)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "2774991"}, {"introduction": "A key question in hybrid zone analysis is whether gene flow has occurred post-divergence, a process known as introgression. The ABBA-BABA test, or $D$-statistic, is a powerful tool for detecting introgression by distinguishing it from the background noise of incomplete lineage sorting (ILS) [@problem_id:2775031]. This exercise will guide you through both the theoretical derivation of the test's null expectation and the practical estimation of its statistical significance using a block jackknife procedure on genomic data.", "problem": "In a clade of closely related lineages forming a contact zone, three ingroup populations are arranged on the rooted species tree $((H_{1},H_{2}),H_{3})$ with an outgroup $O$ that polarizes ancestral versus derived alleles. Assume the infinite-sites model, neutrality, no recurrent mutation, and that the outgroup state is the true ancestral state at all analyzed sites. Let $\\mathrm{ABBA}$ denote sites where the derived allele is present in $H_{2}$ and $H_{3}$ but not $H_{1}$, and let $\\mathrm{BABA}$ denote sites where the derived allele is present in $H_{1}$ and $H_{3}$ but not $H_{2}$. Consider the D-statistic\n$$\nD \\equiv \\frac{\\mathrm{ABBA}-\\mathrm{BABA}}{\\mathrm{ABBA}+\\mathrm{BABA}}.\n$$\nYou will test the null hypothesis of no post-divergence gene flow among the ingroup lineages (allowing incomplete lineage sorting) and then estimate the sampling variance of the genome-wide estimator $\\hat{D}$ by a block jackknife.\n\nTasks:\n1. Using the coalescent framework and the infinite-sites model as fundamental bases, derive the expected value $\\mathbb{E}[D]$ under the null hypothesis of no gene flow among the ingroup lineages while allowing incomplete lineage sorting. Your derivation should begin from the definitions of site patterns arising from discordant gene trees and the symmetry of lineage coalescence leading to $\\mathrm{ABBA}$ and $\\mathrm{BABA}$ site patterns.\n2. Now, suppose the genome is partitioned into $B=6$ non-overlapping, approximately linkage-equilibrium blocks (assume blocks are large enough that blocks are effectively independent for the purpose of a block jackknife). For block $b\\in\\{1,2,3,4,5,6\\}$, you observe counts $(\\mathrm{ABBA}_{b},\\mathrm{BABA}_{b})$ given by:\n$$\n( \\mathrm{ABBA}_{1},\\mathrm{BABA}_{1} )=(120,100),\\quad\n( \\mathrm{ABBA}_{2},\\mathrm{BABA}_{2} )=(80,90),\\quad\n( \\mathrm{ABBA}_{3},\\mathrm{BABA}_{3} )=(150,140),\n$$\n$$\n( \\mathrm{ABBA}_{4},\\mathrm{BABA}_{4} )=(60,70),\\quad\n( \\mathrm{ABBA}_{5},\\mathrm{BABA}_{5} )=(110,100),\\quad\n( \\mathrm{ABBA}_{6},\\mathrm{BABA}_{6} )=(90,95).\n$$\nDefine per-block contrasts $x_{b}\\equiv \\mathrm{ABBA}_{b}-\\mathrm{BABA}_{b}$ and per-block denominators $y_{b}\\equiv \\mathrm{ABBA}_{b}+\\mathrm{BABA}_{b}$. Let the genome-wide estimator be $\\hat{D}=\\left(\\sum_{b=1}^{6} x_{b}\\right)\\Big/\\left(\\sum_{b=1}^{6} y_{b}\\right)$. Perform a delete-one-block jackknife to estimate the sampling variance of $\\hat{D}$ across these $6$ blocks, treating the blocks as the jackknife units. Compute the numerical value of the jackknife variance estimator for $\\hat{D}$.\n\nReport only the numerical value of the estimated variance, rounded to four significant figures. No units are required.", "solution": "This problem consists of two parts. The first requires a theoretical derivation of the expected value of the D-statistic under the null hypothesis of no introgression. The second requires the numerical estimation of the sampling variance of the D-statistic using the block jackknife method.\n\nPart 1: Derivation of $\\mathbb{E}[D]$ under the Null Hypothesis\n\nThe problem defines a rooted species tree with the topology $((H_{1},H_{2}),H_{3})$ and an outgroup $O$. The D-statistic is defined as $D \\equiv \\frac{\\mathrm{ABBA}-\\mathrm{BABA}}{\\mathrm{ABBA}+\\mathrm{BABA}}$, where $\\mathrm{ABBA}$ and $\\mathrm{BABA}$ refer to the counts of specific biallelic site patterns. The outgroup $O$ is assumed to carry the ancestral allele, which we denote as 'A'. The derived allele is 'B'.\nA site exhibits the ABBA pattern if the allelic state across $(H_1, H_2, H_3, O)$ is (A, B, B, A). Given the outgroup $O$ is ancestral, the correct pattern is $(H_1, H_2, H_3)$ being $(\\text{A}, \\text{B}, \\text{B})$. This pattern arises when a unique mutation occurs on the branch of the gene tree that unites the lineages from $H_2$ and $H_3$ to the exclusion of the lineage from $H_1$. This requires the gene tree for these three taxa to have the topology $(H_1, (H_2, H_3))$.\n\nA site exhibits the BABA pattern if the allelic state across $(H_1, H_2, H_3)$ is $(\\text{B}, \\text{A}, \\text{B})$. This pattern arises when a unique mutation occurs on the branch of the gene tree that unites the lineages from $H_1$ and $H_3$ to the exclusion of the lineage from $H_2$. This requires the gene tree to have the topology $(H_2, (H_1, H_3))$.\n\nThe species tree topology is $((H_1, H_2), H_3)$. Under the null hypothesis of no post-divergence gene flow (introgression), the only mechanism that can generate gene trees discordant with the species tree is incomplete lineage sorting (ILS). ILS occurs when lineages fail to coalesce in their immediate ancestral population and instead coalesce further back in time in a more ancient common ancestor.\n\nLet us trace the lineages $h_1$, $h_2$, and $h_3$ from populations $H_1$, $H_2$, and $H_3$ back in time. According to the species tree, $h_1$ and $h_2$ lineages enter their common ancestral population $P_{12}$. If they coalesce within $P_{12}$, the resulting gene tree will be concordant with the species tree, $((H_1, H_2), H_3)$. This topology cannot produce either ABBA or BABA patterns.\n\nFor ABBA or BABA patterns to arise, $h_1$ and $h_2$ must fail to coalesce in $P_{12}$. Consequently, three distinct lineages—$h_1$, $h_2$, and the ancestral lineage of $H_3$, which is $h_3$—enter the ancestral population $P_{123}$. Under the neutral coalescent model, any pair of these three lineages is equally likely to coalesce first. There are three possible pairs: $(h_1, h_2)$, $(h_2, h_3)$, and $(h_1, h_3)$. The probability for each of these coalescent events is $1/3$.\n\n1.  Coalescence of $h_1$ and $h_2$: This occurs with probability $1/3$. The resulting gene tree is $((H_1,H_2),H_3)$, concordant with the species tree. No ABBA or BABA patterns are generated.\n2.  Coalescence of $h_2$ and $h_3$: This occurs with probability $1/3$. The resulting gene tree is $(H_1,(H_2,H_3))$. A mutation on the internal branch leading to the $(H_2, H_3)$ clade produces an ABBA site pattern.\n3.  Coalescence of $h_1$ and $h_3$: This occurs with probability $1/3$. The resulting gene tree is $(H_2,(H_1,H_3))$. A mutation on the internal branch leading to the $(H_1, H_3)$ clade produces a BABA site pattern.\n\nThe expected number of sites of a given pattern is proportional to the probability of the corresponding gene tree topology multiplied by the expected length of the internal branch on which the mutation must arise. Let $T_{23}$ be the length of the internal branch in the $(H_1, (H_2, H_3))$ gene tree, and $T_{13}$ be the length of the internal branch in the $(H_2, (H_1, H_3))$ gene tree. The number of ABBA sites, denoted $N_{\\mathrm{ABBA}}$, is proportional to $P((H_1, (H_2, H_3))) \\times \\mathbb{E}[T_{23}]$, and the number of BABA sites, $N_{\\mathrm{BABA}}$, is proportional to $P((H_2, (H_1, H_3))) \\times \\mathbb{E}[T_{13}]$.\n\nDue to the fundamental symmetry of the coalescent process within the ancestral population $P_{123}$ under the null hypothesis, the two discordant topologies are generated with equal probability: $P(h_2,h_3 \\text{ coalesce first}) = P(h_1,h_3 \\text{ coalesce first}) = 1/3$. Furthermore, the distribution of the waiting time until the final coalescence event (and thus the distribution of the internal branch lengths $T_{23}$ and $T_{13}$) is identical for both cases. Therefore, $\\mathbb{E}[T_{23}] = \\mathbb{E}[T_{13}]$.\n\nAs a result, under the null hypothesis of no gene flow, the expected number of ABBA sites is equal to the expected number of BABA sites:\n$$ \\mathbb{E}[N_{\\mathrm{ABBA}}] = \\mathbb{E}[N_{\\mathrm{BABA}}] $$\nThe expected value of the numerator of the D-statistic is:\n$$ \\mathbb{E}[N_{\\mathrm{ABBA}} - N_{\\mathrm{BABA}}] = \\mathbb{E}[N_{\\mathrm{ABBA}}] - \\mathbb{E}[N_{\\mathrm{BABA}}] = 0 $$\nWhile the D-statistic is a ratio of random variables, its expectation is typically approximated as the ratio of expectations, especially when the denominator is large.\n$$ \\mathbb{E}[D] \\approx \\frac{\\mathbb{E}[N_{\\mathrm{ABBA}} - N_{\\mathrm{BABA}}]}{\\mathbb{E}[N_{\\mathrm{ABBA}} + N_{\\mathrm{BABA}}]} = \\frac{0}{\\mathbb{E}[N_{\\mathrm{ABBA}} + N_{\\mathrm{BABA}}]} = 0 $$\nThus, under the null hypothesis of only incomplete lineage sorting and no introgression, the expected value of the D-statistic is $0$.\n\nPart 2: Jackknife Variance Estimation\n\nWe are given site counts for $B=6$ genomic blocks. The task is to compute the jackknife estimate of the variance of $\\hat{D}$.\nThe estimator is $\\hat{D} = \\frac{\\sum_{b=1}^{B} x_b}{\\sum_{b=1}^{B} y_b}$, where $x_b = \\mathrm{ABBA}_b - \\mathrm{BABA}_b$ and $y_b = \\mathrm{ABBA}_b + \\mathrm{BABA}_b$.\n\nFirst, we compute $x_b$ and $y_b$ for each block $b \\in \\{1, \\dots, 6\\}$:\n- Block 1: $(\\mathrm{ABBA}_1, \\mathrm{BABA}_1) = (120, 100) \\implies x_1 = 120 - 100 = 20, y_1 = 120 + 100 = 220$\n- Block 2: $(\\mathrm{ABBA}_2, \\mathrm{BABA}_2) = (80, 90) \\implies x_2 = 80 - 90 = -10, y_2 = 80 + 90 = 170$\n- Block 3: $(\\mathrm{ABBA}_3, \\mathrm{BABA}_3) = (150, 140) \\implies x_3 = 150 - 140 = 10, y_3 = 150 + 140 = 290$\n- Block 4: $(\\mathrm{ABBA}_4, \\mathrm{BABA}_4) = (60, 70) \\implies x_4 = 60 - 70 = -10, y_4 = 60 + 70 = 130$\n- Block 5: $(\\mathrm{ABBA}_5, \\mathrm{BABA}_5) = (110, 100) \\implies x_5 = 110 - 100 = 10, y_5 = 110 + 100 = 210$\n- Block 6: $(\\mathrm{ABBA}_6, \\mathrm{BABA}_6) = (90, 95) \\implies x_6 = 90 - 95 = -5, y_6 = 90 + 95 = 185$\n\nNext, we calculate the total sums:\n$$ S_x = \\sum_{b=1}^{6} x_b = 20 - 10 + 10 - 10 + 10 - 5 = 15 $$\n$$ S_y = \\sum_{b=1}^{6} y_b = 220 + 170 + 290 + 130 + 210 + 185 = 1205 $$\n\nThe jackknife procedure requires calculating the estimate $\\hat{D}_{(i)}$ by removing one block at a time. The formula is $\\hat{D}_{(i)} = (S_x - x_i) / (S_y - y_i)$.\n- $\\hat{D}_{(1)} = \\frac{15 - 20}{1205 - 220} = \\frac{-5}{985} \\approx -0.00507614$\n- $\\hat{D}_{(2)} = \\frac{15 - (-10)}{1205 - 170} = \\frac{25}{1035} \\approx 0.02415459$\n- $\\hat{D}_{(3)} = \\frac{15 - 10}{1205 - 290} = \\frac{5}{915} \\approx 0.00546448$\n- $\\hat{D}_{(4)} = \\frac{15 - (-10)}{1205 - 130} = \\frac{25}{1075} \\approx 0.02325581$\n- $\\hat{D}_{(5)} = \\frac{15 - 10}{1205 - 210} = \\frac{5}{995} \\approx 0.00502513$\n- $\\hat{D}_{(6)} = \\frac{15 - (-5)}{1205 - 185} = \\frac{20}{1020} \\approx 0.01960784$\n\nNow, we compute the mean of the jackknife replicates, $\\bar{D}_{\\mathrm{jack}}$:\n$$ \\bar{D}_{\\mathrm{jack}} = \\frac{1}{B} \\sum_{i=1}^{B} \\hat{D}_{(i)} = \\frac{1}{6}(-0.00507614 + 0.02415459 + 0.00546448 + 0.02325581 + 0.00502513 + 0.01960784) $$\n$$ \\bar{D}_{\\mathrm{jack}} = \\frac{1}{6}(0.07243171) \\approx 0.01207195 $$\n\nThe jackknife estimate of the variance is given by the formula:\n$$ \\mathrm{var}_{\\mathrm{jack}}(\\hat{D}) = \\frac{B-1}{B} \\sum_{i=1}^{B} (\\hat{D}_{(i)} - \\bar{D}_{\\mathrm{jack}})^2 $$\nWe compute the squared differences:\n- $(\\hat{D}_{(1)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (-0.00507614 - 0.01207195)^2 = (-0.01714809)^2 \\approx 0.0002940576$\n- $(\\hat{D}_{(2)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (0.02415459 - 0.01207195)^2 = (0.01208264)^2 \\approx 0.0001459902$\n- $(\\hat{D}_{(3)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (0.00546448 - 0.01207195)^2 = (-0.00660747)^2 \\approx 0.0000436587$\n- $(\\hat{D}_{(4)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (0.02325581 - 0.01207195)^2 = (0.01118386)^2 \\approx 0.0001250800$\n- $(\\hat{D}_{(5)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (0.00502513 - 0.01207195)^2 = (-0.00704682)^2 \\approx 0.0000496578$\n- $(\\hat{D}_{(6)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx (0.01960784 - 0.01207195)^2 = (0.00753589)^2 \\approx 0.0000567897$\n\nThe sum of squared differences is:\n$$ \\sum_{i=1}^{6} (\\hat{D}_{(i)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx 0.0002940576 + 0.0001459902 + 0.0000436587 + 0.0001250800 + 0.0000496578 + 0.0000567897 $$\n$$ \\sum_{i=1}^{6} (\\hat{D}_{(i)} - \\bar{D}_{\\mathrm{jack}})^2 \\approx 0.000715234 $$\n\nFinally, we calculate the variance with the pre-factor $\\frac{B-1}{B} = \\frac{5}{6}$:\n$$ \\mathrm{var}_{\\mathrm{jack}}(\\hat{D}) = \\frac{5}{6} \\times 0.000715234 \\approx 0.000596028 $$\nRounding to four significant figures gives $0.0005960$.", "answer": "$$\n\\boxed{0.0005960}\n$$", "id": "2775031"}]}