{
    "hands_on_practices": [
        {
            "introduction": "This first practice exercise establishes the foundation of the entire normal form theory. By explicitly calculating the action variables $I_j$ for a system of uncoupled harmonic oscillators, you will verify the crucial relationship between the Hamiltonian $H_2$ and these new coordinates. This exercise  solidifies the concept that in action-angle variables, the dynamics of the unperturbed system simplify to trivial rotations, setting the stage for analyzing perturbations.",
            "id": "3730953",
            "problem": "Consider a Hamiltonian system on a $2n$-dimensional phase space with canonical coordinates $(q,p) \\in \\mathbb{R}^{n} \\times \\mathbb{R}^{n}$ and the standard symplectic form. Suppose the origin is an elliptic equilibrium and that the quadratic part of the Hamiltonian near the origin, which coincides with the second-order Birkhoff normal form (BNF), is\n$$\nH_{2}(q,p) \\;=\\; \\frac{1}{2}\\sum_{j=1}^{n}\\Big(p_{j}^{2} \\,+\\, \\omega_{j}^{2} q_{j}^{2}\\Big),\n$$\nwith all $\\omega_{j} > 0$ pairwise nonresonant real frequencies. For each degree of freedom $j$, define the action variable by the standard phase-space area integral\n$$\nI_{j} \\;=\\; \\frac{1}{2\\pi}\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j},\n$$\nwhere $\\gamma_{j}(E_{j})$ is the closed orbit of the $j$-th decoupled harmonic oscillator with energy $E_{j}$, holding all other coordinates fixed at the equilibrium values. Starting from Hamiltonâ€™s equations and the definition of the action as a contour integral of the canonical one-form, derive a closed-form expression for $I_{j}$ as a function of $(q_{j},p_{j})$ and $\\omega_{j}$, and then express $H_{2}$ purely in terms of the action variables $I_{j}$. Report, as your final answer, the resulting expression for $H_{2}$ written solely in terms of the actions $I_{j}$. Do not provide intermediate equalities in your final answer. No numerical approximation is required, and no units are needed. Angles, where they appear implicitly in the derivation, are in radians.",
            "solution": "The user has provided a problem statement that must first be validated.\n\n### Step 1: Extract Givens\n- **System**: Hamiltonian system on a $2n$-dimensional phase space.\n- **Coordinates**: Canonical coordinates $(q,p) \\in \\mathbb{R}^{n} \\times \\mathbb{R}^{n}$.\n- **Symplectic Form**: Standard, $\\sum_{j} \\mathrm{d}p_j \\wedge \\mathrm{d}q_j$.\n- **Equilibrium**: The origin $(q,p) = (0,0)$ is an elliptic equilibrium.\n- **Hamiltonian**: The quadratic part of the Hamiltonian, which is also the second-order Birkhoff normal form (BNF), is given by:\n$$H_{2}(q,p) = \\frac{1}{2}\\sum_{j=1}^{n}\\Big(p_{j}^{2} + \\omega_{j}^{2} q_{j}^{2}\\Big)$$\n- **Frequencies**: $\\omega_{j} > 0$ are pairwise nonresonant real frequencies.\n- **Action Variable Definition**: For each degree of freedom $j$, the action $I_j$ is defined by the integral:\n$$I_{j} = \\frac{1}{2\\pi}\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j}$$\n- **Contour of Integration**: $\\gamma_{j}(E_{j})$ is the closed orbit of the $j$-th decoupled harmonic oscillator with energy $E_{j}$, holding all other coordinates fixed at their equilibrium values ($q_k=0, p_k=0$ for $k \\neq j$).\n\n### Step 2: Validate Using Extracted Givens\nThe problem statement is analyzed against the validation criteria.\n- **Scientifically Grounded**: The problem is set in the context of classical Hamiltonian mechanics, specifically concerning the analysis of motion near an elliptic equilibrium. The Hamiltonian provided is the standard form for a system of uncoupled harmonic oscillators. The definition of the action variable as a phase-space integral is a fundamental concept in the theory of action-angle variables. The non-resonance condition is a standard assumption in the context of Birkhoff normal forms, although it is only critical for higher-order terms not considered here. The problem is a standard, foundational exercise in theoretical mechanics and is scientifically sound.\n- **Well-Posed**: The problem asks for a specific derivation and a final expression. The provided information is sufficient and consistent, ensuring that a unique and meaningful solution can be obtained through standard methods.\n- **Objective**: The problem is stated using precise mathematical language, free from any subjectivity or ambiguity.\n\nThe problem does not exhibit any of the flaws listed in the validation checklist. It is scientifically valid, well-posed, and objective.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full, reasoned solution will be provided.\n\n### Solution Derivation\nThe total Hamiltonian $H_2$ is a sum of Hamiltonians for $n$ independent (decoupled) one-dimensional harmonic oscillators. For each degree of freedom $j \\in \\{1, \\dots, n\\}$, the Hamiltonian is:\n$$H_{2,j}(q_j, p_j) = \\frac{1}{2}\\left(p_{j}^{2} + \\omega_{j}^{2} q_{j}^{2}\\right)$$\nThe total Hamiltonian is $H_2 = \\sum_{j=1}^{n} H_{2,j}$. For a given oscillator $j$, the value of its Hamiltonian is constant along any trajectory and corresponds to its energy, $E_j$.\n$$E_j = \\frac{1}{2}\\left(p_{j}^{2} + \\omega_{j}^{2} q_{j}^{2}\\right)$$\nThe problem requires us to start from Hamilton's equations for the $j$-th oscillator, which are:\n$$\n\\dot{q}_{j} = \\frac{\\partial H_{2,j}}{\\partial p_{j}} = p_{j}\n$$\n$$\n\\dot{p}_{j} = -\\frac{\\partial H_{2,j}}{\\partial q_{j}} = -\\omega_{j}^{2}q_{j}\n$$\nDifferentiating the first equation with respect to time $t$ and substituting the second equation gives the standard equation of motion for a simple harmonic oscillator:\n$$\n\\ddot{q}_{j} = \\dot{p}_{j} = -\\omega_{j}^{2}q_{j} \\quad\\implies\\quad \\ddot{q}_{j} + \\omega_{j}^{2}q_{j} = 0\n$$\nThe general solution for $q_j(t)$ is $q_j(t) = A_j \\cos(\\omega_j t + \\phi_j)$, where $A_j$ and $\\phi_j$ are constants of integration (amplitude and phase). From this, we find $p_j(t) = \\dot{q}_j(t) = -A_j \\omega_j \\sin(\\omega_j t + \\phi_j)$.\n\nThese parametric equations describe the closed orbit $\\gamma_j(E_j)$ in the $(q_j, p_j)$ phase plane. We can relate the amplitude $A_j$ to the energy $E_j$ by substituting the solutions for $q_j(t)$ and $p_j(t)$ back into the expression for $E_j$:\n$$\nE_j = \\frac{1}{2}\\left( (-A_j \\omega_j \\sin(\\omega_j t + \\phi_j))^2 + \\omega_j^2 (A_j \\cos(\\omega_j t + \\phi_j))^2 \\right)\n$$\n$$\nE_j = \\frac{1}{2}\\left( A_j^2 \\omega_j^2 \\sin^2(\\omega_j t + \\phi_j) + A_j^2 \\omega_j^2 \\cos^2(\\omega_j t + \\phi_j) \\right) = \\frac{1}{2} A_j^2 \\omega_j^2\n$$\nThis gives the amplitude in terms of energy: $A_j = \\frac{\\sqrt{2E_j}}{\\omega_j}$.\n\nThe action variable $I_j$ is defined by the contour integral $I_{j} = \\frac{1}{2\\pi}\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j}$. We can evaluate this integral by parameterizing it over one full period of motion, $T_j = 2\\pi/\\omega_j$:\n$$\n\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j} = \\int_{0}^{T_j} p_j(t) \\frac{\\mathrm{d}q_j}{\\mathrm{d}t} \\mathrm{d}t = \\int_{0}^{2\\pi/\\omega_j} p_j(t) \\dot{q}_j(t) \\mathrm{d}t\n$$\nSince $\\dot{q}_j = p_j$, the integral becomes:\n$$\n\\int_{0}^{2\\pi/\\omega_j} p_j(t)^2 \\mathrm{d}t = \\int_{0}^{2\\pi/\\omega_j} (-A_j \\omega_j \\sin(\\omega_j t + \\phi_j))^2 \\mathrm{d}t = A_j^2 \\omega_j^2 \\int_{0}^{2\\pi/\\omega_j} \\sin^2(\\omega_j t + \\phi_j) \\mathrm{d}t\n$$\nThe integral of $\\sin^2(\\theta)$ over one period ($2\\pi$) is $\\pi$. Letting $\\theta = \\omega_j t + \\phi_j$ and $\\mathrm{d}\\theta = \\omega_j \\mathrm{d}t$, the integral becomes:\n$$\n\\int_{0}^{2\\pi/\\omega_j} \\sin^2(\\omega_j t + \\phi_j) \\mathrm{d}t = \\frac{1}{\\omega_j} \\int_{\\phi_j}^{2\\pi+\\phi_j} \\sin^2(\\theta) \\mathrm{d}\\theta = \\frac{1}{\\omega_j} \\pi = \\frac{\\pi}{\\omega_j}\n$$\nSubstituting this result back, we find the value of the contour integral:\n$$\n\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j} = A_j^2 \\omega_j^2 \\left(\\frac{\\pi}{\\omega_j}\\right) = A_j^2 \\omega_j \\pi\n$$\nNow, using the relation $E_j = \\frac{1}{2} A_j^2 \\omega_j^2$, we substitute $A_j^2 = \\frac{2E_j}{\\omega_j^2}$:\n$$\n\\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j} = \\left(\\frac{2E_j}{\\omega_j^2}\\right) \\omega_j \\pi = \\frac{2\\pi E_j}{\\omega_j}\n$$\nFinally, we compute the action variable $I_j$:\n$$\nI_j = \\frac{1}{2\\pi} \\oint_{\\gamma_{j}(E_{j})} p_{j}\\,\\mathrm{d}q_{j} = \\frac{1}{2\\pi} \\left(\\frac{2\\pi E_j}{\\omega_j}\\right) = \\frac{E_j}{\\omega_j}\n$$\nThis gives the important relationship $E_j = \\omega_j I_j$.\nThe problem requests an expression for $I_j$ as a function of coordinates $(q_j, p_j)$ and $\\omega_j$. We achieve this by substituting the expression for $E_j = H_{2,j}$:\n$$\nI_j(q_j, p_j) = \\frac{E_j}{\\omega_j} = \\frac{1}{2\\omega_j}\\left(p_{j}^{2} + \\omega_{j}^{2} q_{j}^{2}\\right)\n$$\nThe final step is to express the total Hamiltonian $H_2$ purely in terms of the action variables $I_j$. We start with the definition of $H_2$ and substitute the relation $E_j = \\omega_j I_j$:\n$$\nH_{2} = \\sum_{j=1}^{n} H_{2,j} = \\sum_{j=1}^{n} E_{j}\n$$\n$$\nH_{2}(I_1, \\dots, I_n) = \\sum_{j=1}^{n} \\omega_{j} I_{j}\n$$\nThis is the expression for the second-order Birkhoff normal form written in terms of the action variables. This form is central to perturbation theory, as it makes the dynamics trivial: $\\dot{I}_j = -\\partial H_2/\\partial \\theta_j = 0$ (since $H_2$ is independent of the angle variables $\\theta_j$), and $\\dot{\\theta}_j = \\partial H_2/\\partial I_j = \\omega_j$, corresponding to simple rotations in each phase plane.",
            "answer": "$$\n\\boxed{\\sum_{j=1}^{n}\\omega_{j}I_{j}}\n$$"
        },
        {
            "introduction": "Moving from theory to computation provides a powerful way to understand the mechanics of canonical transformations. This exercise requires you to implement the Lie series expansion, which is the engine of the Birkhoff normal form procedure. By coding the Poisson bracket and tracking the degree of polynomials, you will programmatically verify the fundamental property that a near-identity transformation generated by a polynomial of degree $k$ leaves all lower-degree terms of the Hamiltonian unchanged .",
            "id": "3730965",
            "problem": "Consider a one-degree-of-freedom Hamiltonian system in canonical coordinates with variables $q$ and $p$, equipped with the canonical Poisson bracket defined by $\\{F,G\\} = \\frac{\\partial F}{\\partial q} \\frac{\\partial G}{\\partial p} - \\frac{\\partial F}{\\partial p} \\frac{\\partial G}{\\partial q}$. Near an equilibrium at the origin, the Hamiltonian is expanded as a formal power series $H(q,p) = \\sum_{j \\ge 0} H_j(q,p)$, where $H_j$ is homogeneous of total degree $j$ in $q$ and $p$, with the assumption $H_1 = 0$ at equilibrium (no linear term). For a generator $\\chi_k(q,p)$ homogeneous of total degree $k$, the Lie transform of the Hamiltonian is formally $H' = \\exp(\\operatorname{ad}_{\\chi_k}) H$, where the operator $\\operatorname{ad}_{\\chi_k}(G) = \\{\\chi_k, G\\}$ is iterated in the exponential series. In Birkhoff normal form (BNF), one systematically chooses $\\chi_k$ to eliminate non-resonant terms in $H_k$ while preserving terms of degree less than $k$. This preservation property relies on degree bookkeeping under Poisson brackets: for homogeneous polynomials $F$ and $G$, the total degree satisfies $\\deg(\\{F,G\\}) = \\deg(F) + \\deg(G) - 2$.\n\nYour task is to write a program that:\n- Represents polynomial Hamiltonians as finite sums of monomials $q^a p^b$ with real coefficients.\n- Computes the canonical Poisson bracket of two such polynomials.\n- Computes the Lie-transformed Hamiltonian $H' = \\sum_{m=0}^{\\infty} \\frac{1}{m!} \\operatorname{ad}_{\\chi_k}^m (H)$, truncated by a degree bound $D_{\\text{max}}$ (discard all monomials of total degree greater than $D_{\\text{max}}$ at each step).\n- Implements degree bookkeeping to ensure that a generator $\\chi_k$ of degree $k$ only affects terms of degree greater than or equal to $k$ in the transformed Hamiltonian $H'$.\n- Verifies this property in two ways for each test case:\n    1. Direct comparison: project $H$ and $H'$ to degrees strictly less than $k$ and check they are equal term-by-term.\n    2. Poisson bracket degree tracking: restrict $H$ to degrees strictly less than $k$, then compute $\\operatorname{ad}_{\\chi_k}^m$ of this restriction iteratively for $m \\ge 1$, truncated at degree $D_{\\text{max}}$, and confirm that no generated terms have total degree strictly less than $k$.\n\nRepresentation details:\n- A polynomial $P(q,p)$ is represented as a mapping from exponent pairs $(a,b)$, where $a$ and $b$ are nonnegative integers denoting the exponents of $q$ and $p$, respectively, to a real coefficient $c$, meaning the monomial $c \\, q^a p^b$.\n- The total degree of a monomial $q^a p^b$ is $a+b$.\n- The canonical Poisson bracket is computed using polynomial differentiation and multiplication consistent with the definition $\\{F,G\\}$ and is exact for polynomial inputs with real coefficients.\n\nTruncation details:\n- For a fixed bound $D_{\\text{max}}$, any monomial of total degree greater than $D_{\\text{max}}$ must be discarded immediately after it is produced.\n- The Lie series $\\sum_{m=0}^{\\infty} \\frac{1}{m!} \\operatorname{ad}_{\\chi_k}^m (H)$ is computed iteratively and truncated in degree; the iteration terminates once a newly computed term is identically zero under truncation.\n\nVerification outputs:\n- For each test case, compute a boolean that is true if and only if both verification checks succeed: the projection below degree $k$ is unchanged, and the Poisson bracket iterations on the sub-$k$ part generate no terms below degree $k$ under truncation.\n\nTest suite and parameters:\n- Use the following three test cases. In all cases, variables are $(q,p)$, and all numbers are real scalars.\n    1. Happy path with cubic generator:\n        - Hamiltonian $H(q,p) = \\frac{1}{2} p^2 + \\frac{1}{2} q^2 + 1 \\cdot q^3 + \\frac{1}{2} q^4$; coefficients are $0.5$ for $p^2$ and $q^2$, $1.0$ for $q^3$, and $0.5$ for $q^4$.\n        - Generator $\\chi_3(q,p) = 0.2 \\cdot q^2 p$ of degree $k = 3$.\n        - Degree truncation bound $D_{\\text{max}} = 6$.\n    2. Boundary case with quadratic generator:\n        - Hamiltonian $H(q,p) = 1.0 + \\frac{1}{2} p^2 + 1.0 \\cdot q^2 + 0.3 \\cdot q p^2$; coefficients are $1.0$ for the constant, $0.5$ for $p^2$, $1.0$ for $q^2$, and $0.3$ for $q p^2$.\n        - Generator $\\chi_2(q,p) = 0.3 \\cdot q p$ of degree $k = 2$.\n        - Degree truncation bound $D_{\\text{max}} = 5$.\n    3. Edge case with high-degree generator:\n        - Hamiltonian $H(q,p) = 1.0 \\cdot q^5 + 1.0 \\cdot p^5 + 1.0 \\cdot q^3 p^2$; all coefficients are $1.0$.\n        - Generator $\\chi_5(q,p) = 0.1 \\cdot q^4 p$ of degree $k = 5$.\n        - Degree truncation bound $D_{\\text{max}} = 9$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, for example, $[result1,result2,result3]$, where each entry is a boolean corresponding to one test case in the order listed above.\n- No physical units or angle units are involved in this problem.",
            "solution": "The problem statement is assessed to be **valid**. It is scientifically grounded in the principles of Hamiltonian mechanics, specifically concerning the theory of Birkhoff normal forms. The problem is well-posed, objective, and provides all necessary information for a unique and meaningful computational verification. It represents a standard exercise in symbolic computation applied to theoretical physics.\n\nThe task is to verify a fundamental property of the Lie transform, $H' = \\exp(\\operatorname{ad}_{\\chi_k}) H$, which is central to the construction of Birkhoff normal forms. The property states that a generator $\\chi_k(q,p)$, a homogeneous polynomial of degree $k$, does not alter the terms of the Hamiltonian $H(q,p)$ with a total degree strictly less than $k$, assuming the equilibrium condition $H_1=0$.\n\nWe will first establish the necessary computational framework for polynomial algebra and then proceed to the verification logic.\n\n**1. Polynomial Representation and Operations**\n\nA polynomial $P(q,p)$ with canonical coordinates $q$ and $p$ is represented as a finite sum of monomials, $P(q,p) = \\sum_{a,b \\in \\mathbb{N}_0} c_{ab} q^a p^b$, where $c_{ab}$ are real coefficients. Computationally, this is implemented as a map from an exponent tuple $(a,b)$ to its corresponding coefficient $c_{ab}$. The total degree of a monomial $c_{ab} q^a p^b$ is defined as $\\deg(q^a p^b) = a+b$.\n\nThe required operations on these polynomials are defined as follows:\n- **Differentiation**: The partial derivative of a monomial $c_{ab} q^a p^b$ with respect to $q$ is $a \\cdot c_{ab} q^{a-1} p^b$ (if $a>0$, else $0$), and with respect to $p$ is $b \\cdot c_{ab} q^a p^{b-1}$ (if $b>0$, else $0$). The derivative of a polynomial is the sum of the derivatives of its monomial terms.\n- **Multiplication**: The product of two polynomials $F = \\sum_{i} c_i q^{a_i} p^{b_i}$ and $G = \\sum_{j} d_j q^{\\alpha_j} p^{\\beta_j}$ is given by the sum of all pairwise monomial products:\n$$ F(q,p) \\cdot G(q,p) = \\sum_{i,j} (c_i d_j) q^{a_i+\\alpha_j} p^{b_i+\\beta_j} $$\n- **Poisson Bracket**: The canonical Poisson bracket $\\{F,G\\}$ is defined as:\n$$ \\{F,G\\} = \\frac{\\partial F}{\\partial q} \\frac{\\partial G}{\\partial p} - \\frac{\\partial F}{\\partial p} \\frac{\\partial G}{\\partial q} $$\nThis operation is implemented by applying the differentiation and multiplication rules defined above. A key property for homogeneous polynomials $F$ and $G$ is that the degree of their Poisson bracket is $\\deg(\\{F,G\\}) = \\deg(F) + \\deg(G) - 2$.\n\n**2. Lie Series Transformation**\n\nThe Lie transform of a Hamiltonian $H$ generated by a polynomial $\\chi_k$ is given by the exponential of the adjoint operator $\\operatorname{ad}_{\\chi_k}(G) = \\{\\chi_k, G\\}$:\n$$ H' = \\exp(\\operatorname{ad}_{\\chi_k}) H = \\sum_{m=0}^{\\infty} \\frac{1}{m!} \\operatorname{ad}_{\\chi_k}^m (H) $$\nwhere $\\operatorname{ad}_{\\chi_k}^0(H) = H$ and the higher-order terms are computed recursively: $\\operatorname{ad}_{\\chi_k}^m(H) = \\{\\chi_k, \\operatorname{ad}_{\\chi_k}^{m-1}(H)\\}$ for $m \\ge 1$.\n\nComputationally, this infinite series is approximated by iterative summation and truncation. Let $T_m = \\operatorname{ad}_{\\chi_k}^m(H)$. The series is calculated as:\n$H' = H + T_1 + \\frac{1}{2!}T_2 + \\frac{1}{3!}T_3 + \\dots$\nThe process involves looping to compute successive terms $T_m = \\{\\chi_k, T_{m-1}\\}$ (with $T_0 = H$), truncating each $T_m$ by discarding monomials of degree greater than $D_{\\text{max}}$, and adding the scaled term $\\frac{1}{m!}T_m$ to the total sum, which is also truncated at each step. The iteration halts when a computed term $T_m$ becomes identically zero after truncation.\n\n**3. Verification of the Degree Preservation Property**\n\nThe core of the task is to verify that for a generator $\\chi_k$ of homogeneous degree $k$, the resulting transformed Hamiltonian $H'$ has the same terms of degree less than $k$ as the original Hamiltonian $H$. This property relies on the degree-altering nature of the Poisson bracket and the condition that $H$ has no linear part ($H_1=0$) at the equilibrium.\n\nLet $H_{<k}$ be the part of $H$ containing all terms of degree strictly less than $k$. Then $H = H_{<k} + H_{\\ge k}$. The Lie transform is linear, so $H' = \\exp(\\operatorname{ad}_{\\chi_k})(H_{<k}) + \\exp(\\operatorname{ad}_{\\chi_k})(H_{\\ge k})$. The property we are verifying is equivalent to showing that $\\exp(\\operatorname{ad}_{\\chi_k})(H_{<k})$ generates no new terms of degree less than $k$.\n\nLet's examine the first bracket term, $\\{\\chi_k, H_{<k}\\} = \\sum_{j=0}^{k-1} \\{\\chi_k, H_j\\}$, where $H_j$ is the homogeneous part of $H$ of degree $j$. The degree of $\\{\\chi_k, H_j\\}$ is $k+j-2$.\n- For $j=0$ (constant term $H_0$), $\\{\\chi_k, H_0\\} = 0$.\n- For $j=1$ (linear term $H_1$), the degree is $k+1-2=k-1$. However, the problem states the standard equilibrium condition $H_1=0$, so this term is also zero.\n- For $j \\ge 2$, the degree is $k+j-2 \\ge k+2-2=k$.\nThus, the first application of $\\operatorname{ad}_{\\chi_k}$ to $H_{<k}$ produces only terms of degree $k$ or higher. Subsequent applications, e.g., $\\{\\chi_k, \\{\\chi_k, H_{<k}\\}\\}$, will produce terms of even higher degree. Consequently, no terms of degree less than $k$ are generated.\n\nThe program will implement two verification procedures based on this principle:\n\n1.  **Direct Comparison**: Compute the full transformed Hamiltonian $H'$ up to degree $D_{\\text{max}}$. Then, extract the parts of both the original $H$ and the transformed $H'$ with degrees strictly less than $k$. These two polynomials should be identical. We denote this operation as $\\operatorname{project}(P, d)$, which filters a polynomial $P$ for terms of degree less than $d$. The check is: $\\operatorname{project}(H, k) \\stackrel{?}{=} \\operatorname{project}(H', k)$.\n\n2.  **Poisson Bracket Degree Tracking**: Isolate $H_{<k} = \\operatorname{project}(H, k)$. Iteratively compute the sequence $T_m = \\operatorname{ad}_{\\chi_k}^m(H_{<k})$ for $m=1, 2, \\dots$. For each resulting polynomial $T_m$, verify that it contains no terms of degree less than $k$. That is, for all $m \\ge 1$, we must have $\\operatorname{project}(T_m, k) = 0$. The iteration stops when $T_m$ becomes zero after truncation at degree $D_{\\text{max}}$.\n\nIf both verification checks pass for a given test case, the property is confirmed. The provided implementation will perform these checks for each specified test case.",
            "answer": "```python\nimport numpy as np\nimport math\n\n# A global tolerance for floating-point comparisons to zero.\nTOLERANCE = 1e-9\n\nclass Polynomial:\n    \"\"\"\n    Represents a polynomial in q and p as a dictionary from exponent tuples\n    (q_exp, p_exp) to their coefficients.\n    \"\"\"\n\n    def __init__(self, terms=None):\n        \"\"\"\n        Initializes a polynomial.\n        `terms` is a dictionary like {(a, b): c} for the monomial c * q^a * p^b.\n        Terms with coefficients close to zero are filtered out on creation.\n        \"\"\"\n        if terms:\n            self.terms = {k: v for k, v in terms.items() if abs(v) > TOLERANCE}\n        else:\n            self.terms = {}\n\n    def __repr__(self):\n        \"\"\"String representation for debugging.\"\"\"\n        if not self.terms:\n            return \"0\"\n        return \" + \".join(f\"{v:.4f}*q^{k[0]}*p^{k[1]}\" for k, v in sorted(self.terms.items()))\n\n    def copy(self):\n        \"\"\"Returns a deep copy of the polynomial.\"\"\"\n        return Polynomial(self.terms.copy())\n\n    def scale(self, factor):\n        \"\"\"Multiplies the polynomial by a scalar factor.\"\"\"\n        if abs(factor) < TOLERANCE:\n            return Polynomial()\n        new_terms = {k: v * factor for k, v in self.terms.items()}\n        return Polynomial(new_terms)\n\n    def truncate(self, max_deg):\n        \"\"\"Returns a new polynomial with terms of total degree > max_deg removed.\"\"\"\n        new_terms = {k: v for k, v in self.terms.items() if (k[0] + k[1]) <= max_deg}\n        return Polynomial(new_terms)\n\n    def project(self, degree_bound):\n        \"\"\"Returns a new polynomial with only terms of total degree < degree_bound.\"\"\"\n        new_terms = {k: v for k, v in self.terms.items() if (k[0] + k[1]) < degree_bound}\n        return Polynomial(new_terms)\n\n    def is_zero(self):\n        \"\"\"Checks if the polynomial is identically zero within the tolerance.\"\"\"\n        return not self.terms\n\n    def __add__(self, other):\n        \"\"\"Adds two polynomials.\"\"\"\n        new_terms = self.terms.copy()\n        for k, v in other.terms.items():\n            new_val = new_terms.get(k, 0) + v\n            new_terms[k] = new_val\n        return Polynomial(new_terms)\n\n    def __sub__(self, other):\n        \"\"\"Subtracts another polynomial.\"\"\"\n        new_terms = self.terms.copy()\n        for k, v in other.terms.items():\n            new_val = new_terms.get(k, 0) - v\n            new_terms[k] = new_val\n        return Polynomial(new_terms)\n\n    def __mul__(self, other):\n        \"\"\"Multiplies two polynomials.\"\"\"\n        new_terms = {}\n        for (a1, b1), c1 in self.terms.items():\n            for (a2, b2), c2 in other.terms.items():\n                new_a, new_b = a1 + a2, b1 + b2\n                new_c = c1 * c2\n                new_terms[(new_a, new_b)] = new_terms.get((new_a, new_b), 0) + new_c\n        return Polynomial(new_terms)\n\n    def differentiate(self, var):\n        \"\"\"Differentiates the polynomial with respect to 'q' or 'p'.\"\"\"\n        new_terms = {}\n        if var == 'q':\n            for (a, b), c in self.terms.items():\n                if a > 0:\n                    new_terms[(a - 1, b)] = c * a\n        elif var == 'p':\n            for (a, b), c in self.terms.items():\n                if b > 0:\n                    new_terms[(a, b - 1)] = c * b\n        else:\n            raise ValueError(\"Variable for differentiation must be 'q' or 'p'\")\n        return Polynomial(new_terms)\n\n    def __eq__(self, other):\n        \"\"\"Checks for equality of two polynomials within tolerance.\"\"\"\n        diff = self - other\n        return diff.is_zero()\n\ndef poisson_bracket(f, g):\n    \"\"\"Computes the canonical Poisson bracket {f, g}.\"\"\"\n    df_dq = f.differentiate('q')\n    dg_dp = g.differentiate('p')\n    df_dp = f.differentiate('p')\n    dg_dq = g.differentiate('q')\n    term1 = df_dq * dg_dp\n    term2 = df_dp * dg_dq\n    return term1 - term2\n\ndef compute_lie_transform(H, chi, D_max):\n    \"\"\"\n    Computes H' = exp(ad_chi) H, truncated at degree D_max.\n    The process is iterative, with truncation at each step as specified.\n    \"\"\"\n    H_prime = H.copy()\n    ad_H_term = H.copy()  # This will hold ad_chi^m(H) in each iteration.\n    \n    for m in range(1, D_max * 2): # A reasonable upper bound for iterations.\n        # Compute ad_chi(ad_chi^{m-1}(H)) and truncate it.\n        ad_H_term = poisson_bracket(chi, ad_H_term).truncate(D_max)\n\n        if ad_H_term.is_zero():\n            break\n\n        # Add the scaled term to the sum and truncate the sum.\n        term_to_add = ad_H_term.scale(1.0 / math.factorial(m))\n        H_prime = (H_prime + term_to_add).truncate(D_max)\n\n    return H_prime\n\ndef run_verification(H_terms, chi_terms, k, D_max):\n    \"\"\"\n    Runs the two verification checks for a given test case.\n    \"\"\"\n    H = Polynomial(H_terms)\n    chi = Polynomial(chi_terms)\n\n    # Compute the transformed Hamiltonian H'\n    H_prime = compute_lie_transform(H, chi, D_max)\n\n    # --- Verification 1: Direct comparison ---\n    # The projection of H and H' to degrees < k should be identical.\n    H_low_deg = H.project(k)\n    H_prime_low_deg = H_prime.project(k)\n    check1 = (H_low_deg == H_prime_low_deg)\n\n    # --- Verification 2: Poisson bracket degree tracking ---\n    # The Lie series of H projected to degrees < k must not generate any new terms < k.\n    check2 = True\n    H_low_deg_only = H.project(k)\n    ad_term = H_low_deg_only.copy() # This will hold ad_chi^m(H_{<k})\n\n    for m in range(1, D_max * 2):\n        # Compute ad_chi applied to the previous term, then truncate.\n        ad_term = poisson_bracket(chi, ad_term).truncate(D_max)\n        \n        if ad_term.is_zero():\n            break # All subsequent terms will be zero.\n        \n        # Check if the newly computed term has any components with degree < k.\n        if not ad_term.project(k).is_zero():\n            check2 = False\n            break\n            \n    return check1 and check2\n\ndef solve():\n    \"\"\"\n    Defines test cases, runs the verifications, and prints the results.\n    \"\"\"\n    test_cases = [\n        {\n            # Case 1: Happy path with cubic generator\n            \"H_terms\": {(2, 0): 0.5, (0, 2): 0.5, (3, 0): 1.0, (4, 0): 0.5},\n            \"chi_terms\": {(2, 1): 0.2},\n            \"k\": 3,\n            \"D_max\": 6\n        },\n        {\n            # Case 2: Boundary case with quadratic generator\n            \"H_terms\": {(0, 0): 1.0, (2, 0): 1.0, (0, 2): 0.5, (1, 2): 0.3},\n            \"chi_terms\": {(1, 1): 0.3},\n            \"k\": 2,\n            \"D_max\": 5\n        },\n        {\n            # Case 3: Edge case with high-degree generator\n            \"H_terms\": {(5, 0): 1.0, (0, 5): 1.0, (3, 2): 1.0},\n            \"chi_terms\": {(4, 1): 0.1},\n            \"k\": 5,\n            \"D_max\": 9\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = run_verification(case[\"H_terms\"], case[\"chi_terms\"], case[\"k\"], case[\"D_max\"])\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Now we apply the full power of the Birkhoff normal form method to a physically significant problem: the Duffing oscillator. This system is a quintessential example of how nonlinearities alter dynamics. This exercise  will guide you through the perturbative calculations needed to find the normal form and extract the nonlinear frequency correction, demonstrating how this technique reveals the amplitude-dependent frequency shift, a key feature of many real-world oscillators.",
            "id": "3730981",
            "problem": "Consider the one-degree-of-freedom Hamiltonian system with Hamiltonian $H(q,p)=\\frac{1}{2} p^{2}+\\frac{1}{2} \\omega^{2} q^{2}+\\beta q^{4}$, where $\\omega>0$ and $\\beta$ is a real parameter with $|\\beta|$ sufficiently small so that a perturbative construction is valid near the elliptic equilibrium at $(q,p)=(0,0)$. Using only the foundational structure of Hamiltonian mechanics and symplectic geometry (canonical transformations and action-angle variables for the harmonic oscillator), construct the Birkhoff normal form (BNF) of $H$ near the origin up to and including terms of total degree $6$ in $(q,p)$. Work in action-angle variables $(I,\\theta)$ for the quadratic part and use a near-identity symplectic transformation generated order by order to remove the angle dependence to the required order. From your normal form $H_{\\mathrm{BNF}}(I)$, compute the corresponding nonlinear frequency map $\\Omega(I)=\\frac{d}{dI}H_{\\mathrm{BNF}}(I)$ up to and including terms of order $I^{2}$.\n\nYour final answer must be a single closed-form analytic expression for $\\Omega(I)$ in terms of $\\omega$, $\\beta$, and $I$, truncated at order $I^{2}$. Do not include any units. Do not provide intermediate expressions. Provide no numerical approximations.",
            "solution": "We begin with the Hamiltonian $H(q,p)=\\frac{1}{2} p^{2}+\\frac{1}{2} \\omega^{2} q^{2}+\\beta q^{4}$. The quadratic part $H_{2}(q,p)=\\frac{1}{2} p^{2}+\\frac{1}{2} \\omega^{2} q^{2}$ defines a harmonic oscillator with frequency $\\omega$. Introduce canonical action-angle variables $(I,\\theta)$ for $H_{2}$ given by\n$$\nI=\\frac{p^{2}+\\omega^{2} q^{2}}{2\\omega},\\qquad q=\\sqrt{\\frac{2I}{\\omega}}\\cos\\theta,\\qquad p=-\\sqrt{2I\\omega}\\sin\\theta,\n$$\nfor which $H_{2}=\\omega I$ and the Poisson bracket with $H_{2}$ acts as $\\{H_{2},f(I,\\theta)\\}=\\omega\\,\\partial_{\\theta} f$.\n\nWrite $H=H_{2}+H_{4}$ with $H_{4}=\\beta q^{4}$. In $(I,\\theta)$, the quartic term is\n$$\nH_{4}(I,\\theta)=\\beta\\left(\\frac{2I}{\\omega}\\right)^{2}\\cos^{4}\\theta=\\frac{\\beta I^{2}}{\\omega^{2}}\\left(\\frac{3}{2}+2\\cos 2\\theta+\\frac{1}{2}\\cos 4\\theta\\right).\n$$\nIts angle average is\n$$\n\\langle H_{4}\\rangle(I)=\\frac{3\\beta}{2\\omega^{2}}\\,I^{2},\n$$\nand the oscillatory part is \n$$\nH_{4}^{\\mathrm{osc}}=H_{4}-\\langle H_{4}\\rangle=\\frac{\\beta I^{2}}{\\omega^{2}}\\left(2\\cos 2\\theta+\\frac{1}{2}\\cos 4\\theta\\right).\n$$\n\nTo construct the Birkhoff normal form (BNF) up to total degree $6$ in $(q,p)$, we apply a near-identity canonical transformation generated by a function $g_{4}(I,\\theta)$ of order $4$ in $(q,p)$ (order $I^{2}$ in action). The homological equation to remove $H_{4}^{\\mathrm{osc}}$ at first order is\n$$\n\\{H_{2},g_{4}\\}+H_{4}^{\\mathrm{osc}}=0,\\qquad \\text{that is}\\quad \\omega\\,\\partial_{\\theta} g_{4}=-H_{4}^{\\mathrm{osc}}.\n$$\nIntegrating in $\\theta$ yields\n$$\ng_{4}(I,\\theta)=-\\frac{1}{\\omega}\\int H_{4}^{\\mathrm{osc}}(I,\\theta)\\,d\\theta=-\\frac{\\beta I^{2}}{\\omega^{3}}\\left(\\sin 2\\theta+\\frac{1}{8}\\sin 4\\theta\\right).\n$$\n\nUnder the Lie transform generated by $g_{4}$, the transformed Hamiltonian through total degree $6$ is\n$$\nH' = H_{2}+\\langle H_{4}\\rangle + \\frac{1}{2}\\left\\langle \\{g_{4},H_{4}^{\\mathrm{osc}}\\}\\right\\rangle + \\text{(angle-dependent terms of degree }6\\text{)} + \\text{higher order}.\n$$\nThe angle-dependent terms of degree $6$ can be removed by a second transformation, leaving as the BNF the angle-averaged part above. Therefore, the BNF up to degree $6$ is determined by computing $\\frac{1}{2}\\langle \\{g_{4},H_{4}^{\\mathrm{osc}}\\}\\rangle$.\n\nIntroduce the abbreviations\n$A=-\\frac{\\beta}{\\omega^{3}}$, $B=\\frac{\\beta}{\\omega^{2}}$, $S(\\theta)=\\sin 2\\theta+\\frac{1}{8}\\sin 4\\theta$, and $C(\\theta)=2\\cos 2\\theta+\\frac{1}{2}\\cos 4\\theta$,\nso that $g_{4}=A I^{2} S$ and $H_{4}^{\\mathrm{osc}}=B I^{2} C$. The derivatives needed for the Poisson bracket are\n$\\partial_{\\theta} g_{4}=A I^{2} S' = A I^{2} C$, $\\partial_{I} g_{4}=2A I S$, $\\partial_{I} H_{4}^{\\mathrm{osc}}=2B I C$, and $\\partial_{\\theta} H_{4}^{\\mathrm{osc}}=B I^{2} C'$,\nwhere $C'(\\theta)=-4\\sin 2\\theta-2\\sin 4\\theta$ and indeed $S'(\\theta)=C(\\theta)$. The Poisson bracket in $(I,\\theta)$ is $\\{f,g\\}=\\partial_{\\theta} f\\,\\partial_{I} g-\\partial_{I} f\\,\\partial_{\\theta} g$, hence\n$$\n\\{g_{4},H_{4}^{\\mathrm{osc}}\\} = (A I^{2} C)(2B I C) - (2A I S)(B I^{2} C') = 2AB\\,I^{3}\\left(C^{2}-S C'\\right).\n$$\nWe now compute the angle average of $C^{2}-SC'$. Using trigonometric identities,\n$$\nC^{2}=4\\cos^{2} 2\\theta+2\\cos 2\\theta\\cos 4\\theta+\\frac{1}{4}\\cos^{2} 4\\theta,\n$$\n$$\nS C'=\\left(\\sin 2\\theta+\\frac{1}{8}\\sin 4\\theta\\right)\\left(-4\\sin 2\\theta-2\\sin 4\\theta\\right)=-4\\sin^{2} 2\\theta-\\frac{5}{2}\\sin 2\\theta\\sin 4\\theta-\\frac{1}{4}\\sin^{2} 4\\theta.\n$$\nTherefore,\n$$\nC^{2}-SC' = 4\\left(\\cos^{2} 2\\theta+\\sin^{2} 2\\theta\\right)+2\\cos 2\\theta\\cos 4\\theta+\\frac{5}{2}\\sin 2\\theta\\sin 4\\theta+\\frac{1}{4}\\left(\\cos^{2} 4\\theta+\\sin^{2} 4\\theta\\right).\n$$\nThe trigonometric products give $2\\cos 2\\theta\\cos 4\\theta+\\frac{5}{2}\\sin 2\\theta\\sin 4\\theta=\\frac{9}{4}\\cos 2\\theta-\\frac{1}{4}\\cos 6\\theta$, whose average over $\\theta$ vanishes. Hence\n$$\n\\left\\langle C^{2}-SC'\\right\\rangle = 4+\\frac{1}{4} = \\frac{17}{4}.\n$$\nIt follows that\n$$\n\\left\\langle \\{g_{4},H_{4}^{\\mathrm{osc}}\\}\\right\\rangle = 2AB\\,I^{3}\\cdot\\frac{17}{4}=\\frac{17}{2}AB\\,I^{3},\n$$\nand thus the degree-$6$ BNF contribution is\n$$\n\\frac{1}{2}\\left\\langle \\{g_{4},H_{4}^{\\mathrm{osc}}\\}\\right\\rangle = \\frac{17}{4}AB\\,I^{3}.\n$$\nSince $AB=-\\beta^{2}/\\omega^{5}$, the Birkhoff normal form up to degree $6$ is\n$$\nH_{\\mathrm{BNF}}(I)=\\omega I+\\frac{3\\beta}{2\\omega^{2}}\\,I^{2}-\\frac{17\\beta^{2}}{4\\omega^{5}}\\,I^{3}.\n$$\n\nThe nonlinear frequency map is the derivative with respect to the action,\n$$\n\\Omega(I)=\\frac{d}{dI}H_{\\mathrm{BNF}}(I)=\\omega+\\frac{3\\beta}{\\omega^{2}}\\,I-\\frac{51\\beta^{2}}{4\\omega^{5}}\\,I^{2}.\n$$\nThis is the requested frequency correction as a function of the action, truncated at order $I^{2}$.",
            "answer": "$$\\boxed{\\omega+\\frac{3\\beta}{\\omega^{2}}\\,I-\\frac{51\\beta^{2}}{4\\omega^{5}}\\,I^{2}}$$"
        }
    ]
}