{
    "hands_on_practices": [
        {
            "introduction": "The first step in understanding structure-preserving integrators for constrained systems is to master the position projection. This exercise introduces the core concept of the SHAKE algorithm, which follows a \"predict-correct\" strategy. By working through the case of a simple planar pendulum, you will derive from first principles how to project a predicted, off-manifold state back onto the constraint surface, a fundamental technique in molecular dynamics and constrained mechanical simulation. ",
            "id": "3767134",
            "problem": "Consider a single rigid planar pendulum of mass $m$ constrained to move on the circle of radius $\\ell$ centered at the origin, with Cartesian configuration $q=(x,y)$ and holonomic constraint $g(q)=x^{2}+y^{2}-\\ell^{2}=0$. The dynamics follow from the Lagrangian $L(q,\\dot{q})=\\tfrac{1}{2}m\\,\\dot{q}^{\\mathsf{T}}\\dot{q}-V(q)$ and the constraint force enters via a Lagrange multiplier $\\lambda(t)$ so that $m\\,\\ddot{q}=-\\nabla V(q)+\\lambda(t)\\,\\nabla g(q)$ with $g(q)=0$. Let $h0$ be a fixed time step and denote $q_{k}=(x_{k},y_{k})$ and $v_{k}=(\\dot{x}_{k},\\dot{y}_{k})$ at time $t_{k}$. Define the unconstrained Störmer-Verlet predictor (also called velocity-Verlet position prediction) \n$$\ns \\equiv q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k}),\n$$\nwhere $a(q)=\\frac{1}{m}\\big(-\\nabla V(q)\\big)$ is the physical acceleration field. In the first position-correction stage of the SHAKE method (a projection method for holonomic constraints), one seeks a correction $\\Delta q_{k+1}$ such that $q_{k+1}=s+\\Delta q_{k+1}$ lies exactly on the constraint manifold, i.e., $g(q_{k+1})=0$, and the correction is along the mass-weighted constraint gradient direction. For the given isotropic mass matrix and circular constraint, this implies the correction is collinear with the predicted position $s$.\n\nDerive from first principles the closed-form analytic expression for the SHAKE position correction $\\Delta q_{k+1}$ that ensures $g(q_{k+1})=0$ exactly, expressed directly in terms of $q_{k}$, $v_{k}$, $h$, $a(q_{k})$, and $\\ell$. Your final answer must be the explicit two-component expression for $\\Delta q_{k+1}=\\big(\\Delta x_{k+1},\\Delta y_{k+1}\\big)$ as a single row matrix. No numerical evaluation is required, and no rounding is needed. Express your answer using only symbolic quantities as defined above, with no units.",
            "solution": "The problem is first validated against the specified criteria.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n- **System**: A single rigid planar pendulum.\n- **Mass**: $m$.\n- **Configuration**: $q=(x,y)$.\n- **Lagrangian**: $L(q,\\dot{q})=\\tfrac{1}{2}m\\,\\dot{q}^{\\mathsf{T}}\\dot{q}-V(q)$.\n- **Holonomic Constraint**: The mass is constrained to move on a circle of radius $\\ell$ centered at the origin. The constraint function is $g(q)=x^{2}+y^{2}-\\ell^{2}=0$.\n- **Equation of Motion**: $m\\,\\ddot{q}=-\\nabla V(q)+\\lambda(t)\\,\\nabla g(q)$, where $\\lambda(t)$ is a Lagrange multiplier.\n- **Discretization**: Time step $h0$. State at time $t_k$ is given by position $q_{k}=(x_{k},y_{k})$ and velocity $v_{k}=(\\dot{x}_{k},\\dot{y}_{k})$.\n- **Acceleration Field**: The physical acceleration is $a(q)=\\frac{1}{m}\\big(-\\nabla V(q)\\big)$.\n- **Predictor Step**: The unconstrained predicted position is $s \\equiv q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k})$.\n- **Correction Step**: The corrected position is $q_{k+1}=s+\\Delta q_{k+1}$.\n- **Correction Conditions**:\n    1. The corrected position must satisfy the constraint: $g(q_{k+1})=0$.\n    2. The correction vector $\\Delta q_{k+1}$ is collinear with the predicted position vector $s$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded**: The problem is set in the context of geometric mechanics and numerical analysis, specifically concerning structure-preserving integrators for constrained systems (SHAKE algorithm). All concepts, equations, and definitions are standard and well-established in computational physics and mathematics.\n- **Well-Posed**: The problem provides a clear objective (derive the expression for $\\Delta q_{k+1}$) and a complete set of conditions to uniquely determine the solution. The a priori assumption that the correction is collinear with the predicted position $s$ is an explicit part of the problem statement, corresponding to a specific variant of the SHAKE algorithm.\n- **Objective**: The problem is formulated using precise mathematical language, free from ambiguity or subjective content.\n\n**Step 3: Verdict and Action**\nThe problem is deemed **valid** as it is scientifically grounded, well-posed, objective, and self-contained. Therefore, a full solution will be derived.\n\n### Solution Derivation\n\nThe goal is to find the closed-form expression for the position correction vector $\\Delta q_{k+1}$ used in the SHAKE algorithm, based on the provided conditions.\n\nThe predicted position at time $t_{k+1}$, without considering the constraint, is given by the Störmer-Verlet predictor:\n$$\ns = q_{k} + h\\,v_{k} + \\frac{h^{2}}{2}\\,a(q_{k})\n$$\nThe corrected position $q_{k+1}$ is obtained by adding a correction term $\\Delta q_{k+1}$ to the predictor $s$:\n$$\nq_{k+1} = s + \\Delta q_{k+1}\n$$\nThe problem states two conditions that must be met.\nFirst, the correction vector $\\Delta q_{k+1}$ is collinear with the predicted position vector $s$. This can be expressed mathematically as:\n$$\n\\Delta q_{k+1} = \\mu s\n$$\nfor some scalar parameter $\\mu$ that needs to be determined.\n\nSubstituting this form of the correction into the equation for $q_{k+1}$ yields:\n$$\nq_{k+1} = s + \\mu s = (1+\\mu)s\n$$\nThis relationship shows that the corrected position vector $q_{k+1}$ is simply a scaled version of the predicted position vector $s$.\n\nSecond, the corrected position $q_{k+1}$ must lie on the constraint manifold, which is the circle of radius $\\ell$. This is expressed by the constraint equation $g(q_{k+1}) = 0$. For the given circular constraint, this means the squared norm of the position vector must be equal to $\\ell^2$:\n$$\n\\|q_{k+1}\\|^2 = \\ell^2\n$$\nSubstituting the expression for $q_{k+1}$ in terms of $s$ into the constraint equation:\n$$\n\\|(1+\\mu)s\\|^2 = \\ell^2\n$$\nUsing the property of the norm $\\|c\\mathbf{v}\\| = |c|\\|\\mathbf{v}\\|$ for a scalar $c$ and vector $\\mathbf{v}$:\n$$\n(1+\\mu)^2 \\|s\\|^2 = \\ell^2\n$$\nSolving for $(1+\\mu)$:\n$$\n(1+\\mu)^2 = \\frac{\\ell^2}{\\|s\\|^2} \\implies 1+\\mu = \\pm \\frac{\\ell}{\\|s\\|}\n$$\nThe SHAKE correction is intended to be a small adjustment. For a small time step $h$, the predicted position $s$ should be close to the constraint manifold, meaning its norm $\\|s\\|$ should be close to $\\ell$. The corrected position $q_{k+1}$ should therefore be near $s$. This implies that the scaling factor $(1+\\mu)$ should be close to $1$ and positive. Thus, we choose the positive root:\n$$\n1+\\mu = \\frac{\\ell}{\\|s\\|}\n$$\nFrom this, we can solve for the scalar parameter $\\mu$:\n$$\n\\mu = \\frac{\\ell}{\\|s\\|} - 1\n$$\nNow we can write the final expression for the correction vector $\\Delta q_{k+1}$:\n$$\n\\Delta q_{k+1} = \\mu s = \\left( \\frac{\\ell}{\\|s\\|} - 1 \\right) s\n$$\nThe problem requires the explicit two-component expression for $\\Delta q_{k+1} = (\\Delta x_{k+1}, \\Delta y_{k+1})$ in terms of the initial state $(q_k, v_k)$, time step $h$, acceleration $a(q_k)$, and radius $\\ell$. Let us define the components of the vectors: $q_k = (x_k, y_k)$, $v_k = (\\dot{x}_k, \\dot{y}_k)$, and $a(q_k)=(a_x(q_k), a_y(q_k))$. The components of the predictor vector $s=(s_x,s_y)$ are:\n$$\ns_x = x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\n$$\n$$\ns_y = y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\n$$\nThe norm of $s$ is $\\|s\\| = \\sqrt{s_x^2 + s_y^2}$. The components of the correction vector $\\Delta q_{k+1}$ are therefore:\n$$\n\\Delta x_{k+1} = \\left( \\frac{\\ell}{\\sqrt{s_x^2 + s_y^2}} - 1 \\right) s_x\n$$\n$$\n\\Delta y_{k+1} = \\left( \\frac{\\ell}{\\sqrt{s_x^2 + s_y^2}} - 1 \\right) s_y\n$$\nSubstituting the expressions for $s_x$ and $s_y$, we obtain the final analytical expressions for the components of the correction vector.\nThe first component is:\n$$\n\\Delta x_{k+1} = \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)\n$$\nThe second component is:\n$$\n\\Delta y_{k+1} = \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)\n$$\nThese are the explicit two-component expressions for the SHAKE position correction.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)  \\left( \\frac{\\ell}{\\sqrt{\\left(x_k + h \\dot{x}_k + \\frac{h^2}{2} a_x(q_k)\\right)^2 + \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)^2}} - 1 \\right) \\left(y_k + h \\dot{y}_k + \\frac{h^2}{2} a_y(q_k)\\right)\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Building upon the position projection, the RATTLE algorithm extends the framework to also enforce the velocity-level (or hidden) constraints inherent in a mechanical system. RATTLE is a fully time-reversible, symplectic integrator that ensures both the positions and velocities remain on their respective constraint manifolds. This practice guides you through one complete step of the RATTLE algorithm for a rigid dimer, providing a concrete understanding of how the position and momentum updates are coordinated to preserve the complete geometric structure of the dynamics. ",
            "id": "3767145",
            "problem": "Consider a rigid dimer modeled as two point masses with positions $r_1 \\in \\mathbb{R}^2$ and $r_2 \\in \\mathbb{R}^2$, and momenta $p_1 \\in \\mathbb{R}^2$ and $p_2 \\in \\mathbb{R}^2$. The Hamiltonian is separable, $H(q,p) = T(p) + V(q)$, with kinetic energy $T(p) = \\frac{1}{2 m} \\left( |p_1|^2 + |p_2|^2 \\right)$, zero potential energy $V(q) = 0$, and equal masses $m = 1$. The dimer is subject to a single holonomic constraint\n$$\ng(q) = |r_2 - r_1|^2 - L^2 = 0,\n$$\nwith fixed bond length $L = 1$. Let the time step be $h = \\frac{1}{2}$, and use the Reversible Integrator with Constraints (RATTLE algorithm, a constraint-preserving variant of velocity Verlet) to advance the state by one full step from time $t_k$ to $t_{k+1} = t_k + h$, enforcing both the position constraint $g(q_{k+1}) = 0$ and the velocity (hidden) constraint $\\dot{g}(q_{k+1},p_{k+1}) = 0$.\n\nWork in dimensionless units where $m$, $L$, and $h$ are as specified above so that positions and momenta are expressed without physical units. The initial state at time $t_k$ is\n$$\nr_1^k = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}, \\quad r_2^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}, \\quad p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}, \\quad p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}.\n$$\n\nStarting from Hamilton’s equations and the holonomic constraint definition, derive the one-step RATTLE update for this free rigid dimer. Specifically:\n- Perform the unconstrained half-step momentum update and the unconstrained position update.\n- Apply the position correction (SHAKE stage) by solving for the scalar correction that enforces $g(q_{k+1}) = 0$ while preserving the center-of-mass position for equal masses.\n- Enforce the velocity constraint at $t_{k+1}$ by computing and applying the momentum correction (impulse) along the constraint direction so that $(r_2^{k+1} - r_1^{k+1}) \\cdot \\left( \\frac{p_2^{k+1}}{m} - \\frac{p_1^{k+1}}{m} \\right) = 0$.\n\nCompute the exact components of $r_1^{k+1}$, $r_2^{k+1}$, $p_1^{k+1}$, and $p_2^{k+1}$ and present your final answer as a single row matrix containing the eight entries\n$$\nx_1^{k+1}, \\ y_1^{k+1}, \\ x_2^{k+1}, \\ y_2^{k+1}, \\ p_{1x}^{k+1}, \\ p_{1y}^{k+1}, \\ p_{2x}^{k+1}, \\ p_{2y}^{k+1}.\n$$\nDo not round; provide exact analytic values in the specified units.",
            "solution": "The user wants to find the state of a rigid dimer after one time step using the RATTLE algorithm.\n\n### Step 1: Extract Givens\n-   **System**: A rigid dimer of two point masses.\n-   **Positions**: $r_1 \\in \\mathbb{R}^2$, $r_2 \\in \\mathbb{R}^2$. Let $q=(r_1, r_2)$.\n-   **Momenta**: $p_1 \\in \\mathbb{R}^2$, $p_2 \\in \\mathbb{R}^2$. Let $p=(p_1, p_2)$.\n-   **Masses**: $m_1 = m_2 = m = 1$.\n-   **Hamiltonian**: $H(q,p) = T(p) + V(q)$.\n-   **Kinetic Energy**: $T(p) = \\frac{1}{2 m} \\left( |p_1|^2 + |p_2|^2 \\right)$.\n-   **Potential Energy**: $V(q) = 0$.\n-   **Holonomic Constraint**: $g(q) = |r_2 - r_1|^2 - L^2 = 0$.\n-   **Bond Length**: $L = 1$.\n-   **Time Step**: $h = \\frac{1}{2}$.\n-   **Initial State at time $t_k$**:\n    -   $r_1^k = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}$\n    -   $r_2^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}$\n    -   $p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$\n    -   $p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$\n-   **Task**: Compute the state $(r_1^{k+1}, r_2^{k+1}, p_1^{k+1}, p_2^{k+1})$ at time $t_{k+1}=t_k+h$.\n-   **Algorithm**: RATTLE (Reversible Integrator with Constraints).\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientific Grounding**: The problem is a standard application of the RATTLE algorithm, a well-established structure-preserving numerical integrator in the field of geometric mechanics and molecular dynamics. The use of a Hamiltonian framework and holonomic constraints is fundamental to classical mechanics. The setup is scientifically sound.\n2.  **Well-Posed**: The problem provides a complete set of initial conditions for a deterministic algorithm. The algorithm's steps are well-defined. A unique, stable, and meaningful solution for the state at the next time step is expected.\n3.  **Objective**: The problem is formulated in precise mathematical language, free from any subjective or ambiguous terms.\n4.  **Completeness**: All necessary parameters ($m, L, h$) and initial conditions are provided. The potential energy being zero is a valid simplification for a free dimer. We can verify that the initial state satisfies the constraints:\n    -   Position constraint: $g(q_k) = |r_2^k - r_1^k|^2 - L^2 = |\\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} - \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}|^2 - 1^2 = 1 - 1 = 0$. Satisfied.\n    -   Velocity (hidden) constraint: $\\dot{g}(q,p) = \\frac{d}{dt}g(q) = \\nabla_q g(q) \\cdot \\dot{q} = \\nabla_q g(q) \\cdot (M^{-1} p) = 0$. The gradient of the constraint is $\\nabla_q g(q) = (\\nabla_{r_1} g, \\nabla_{r_2} g) = (-2(r_2-r_1), 2(r_2-r_1))$. At $t_k$, $r_2^k - r_1^k = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}$. So $\\nabla_q g(q_k) = ( \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix}, \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix})$. The velocity constraint at $t_k$ is $\\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} \\cdot \\frac{p_1^k}{m} + \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix} \\cdot \\frac{p_2^k}{m} = \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 2 \\\\ 0 \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = 0 + 0 = 0$. Satisfied.\n5.  **Conclusion**: The problem is valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. We proceed with the solution.\n\n### Solution\n\nThe RATTLE algorithm is a variant of the velocity Verlet algorithm adapted for holonomic constraints. For a system with Hamiltonian $H = T(p) + V(q)$ and constraint $g(q)=0$, one step from $t_k$ to $t_{k+1}$ proceeds as follows:\n\n1.  **First momentum half-step**:\n    $p_{k+1/2} = p_k - \\frac{h}{2} \\nabla_q V(q_k)$\n    Since the potential energy $V(q) = 0$, its gradient $\\nabla_q V(q_k)$ is zero.\n    $p_{k+1/2} = p_k$.\n    Thus, $p_{1, k+1/2} = p_1^k = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$ and $p_{2, k+1/2} = p_2^k = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$.\n\n2.  **Unconstrained position full-step**:\n    We compute the positions $q_{k+1}^* = (r_{1,k+1}^*, r_{2,k+1}^*)$ that would be reached without constraint forces.\n    $r_{1, k+1}^* = r_1^k + h \\frac{p_{1, k+1/2}}{m} = \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix} + \\frac{1}{2} \\cdot \\frac{1}{1} \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix}$.\n    $r_{2, k+1}^* = r_2^k + h \\frac{p_{2, k+1/2}}{m} = \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} + \\frac{1}{2} \\cdot \\frac{1}{1} \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix}$.\n\n3.  **Position constraint correction (SHAKE)**:\n    We correct the positions to satisfy $g(q_{k+1}) = 0$. Since the update must preserve the center of mass (for equal masses), we can work with the relative coordinate $\\Delta r = r_2 - r_1$. The unconstrained relative position is:\n    $\\Delta r_{k+1}^* = r_{2, k+1}^* - r_{1, k+1}^* = \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix} - \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix}$.\n    The length of this vector is $|\\Delta r_{k+1}^*| = \\sqrt{1^2 + (-1)^2} = \\sqrt{2}$.\n    The corrected relative position vector $\\Delta r_{k+1}$ must have length $L=1$ and should be the vector on the constraint manifold closest to $\\Delta r_{k+1}^*$. This is achieved by scaling:\n    $\\Delta r_{k+1} = \\frac{L}{|\\Delta r_{k+1}^*|} \\Delta r_{k+1}^* = \\frac{1}{\\sqrt{2}} \\begin{pmatrix} 1 \\\\ -1 \\end{pmatrix} = \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix}$.\n    The center of mass must be preserved. The unconstrained center of mass is:\n    $R_{CM}^* = \\frac{m_1 r_{1,k+1}^* + m_2 r_{2,k+1}^*}{m_1+m_2} = \\frac{1}{2}\\left( \\begin{pmatrix} 0 \\\\ 1/2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ -1/2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix}$.\n    The final positions are found by distributing the relative vector $\\Delta r_{k+1}$ around the center of mass $R_{CM}^*$:\n    $r_{1, k+1} = R_{CM}^* - \\frac{1}{2}\\Delta r_{k+1} = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix} - \\frac{1}{2}\\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4} \\\\ \\frac{\\sqrt{2}}{4} \\end{pmatrix}$.\n    $r_{2, k+1} = R_{CM}^* + \\frac{1}{2}\\Delta r_{k+1} = \\begin{pmatrix} 1/2 \\\\ 0 \\end{pmatrix} + \\frac{1}{2}\\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\frac{1}{2} + \\frac{\\sqrt{2}}{4} \\\\ -\\frac{\\sqrt{2}}{4} \\end{pmatrix}$.\n\n4.  **Momentum update and velocity constraint**:\n    The second half-step for momentum is $p_{k+1}^* = p_{k+1/2} - \\frac{h}{2}\\nabla_q V(q_{k+1})$. Again, as $V=0$, we have $p_{k+1}^* = p_{k+1/2} = p_k$.\n    So, $p_{1,k+1}^* = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$ and $p_{2,k+1}^* = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$.\n    Next, we apply an impulse to enforce the velocity constraint $\\dot{g}(q_{k+1}, p_{k+1}) = 0$. The final momenta are given by $p_{k+1} = p_{k+1}^* - \\mu \\nabla_q g(q_{k+1})$ for some Lagrange multiplier $\\mu$. The velocity constraint is $\\nabla_q g(q_{k+1}) \\cdot (M^{-1} p_{k+1}) = 0$.\n    Substituting the expression for $p_{k+1}$, we solve for $\\mu$:\n    $\\mu = \\frac{\\nabla_q g(q_{k+1}) \\cdot (M^{-1} p_{k+1}^*)}{\\nabla_q g(q_{k+1}) \\cdot (M^{-1} \\nabla_q g(q_{k+1}))}$.\n    Let's compute the terms:\n    _Gradient_: $\\nabla_q g(q_{k+1}) = (-2\\Delta r_{k+1}, 2\\Delta r_{k+1})$.\n    $\\Delta r_{k+1} = \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix}$.\n    $\\nabla_{r_1} g = -2 \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix}$.\n    $\\nabla_{r_2} g = 2 \\begin{pmatrix} \\frac{\\sqrt{2}}{2} \\\\ -\\frac{\\sqrt{2}}{2} \\end{pmatrix} = \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix}$.\n    _Numerator_: $\\nabla_q g \\cdot (M^{-1} p^*) = \\frac{1}{m}(\\nabla_{r_1} g \\cdot p_{1,k+1}^* + \\nabla_{r_2} g \\cdot p_{2,k+1}^*)$. With $m=1$:\n    $\\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix} \\cdot \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} = \\sqrt{2} + \\sqrt{2} = 2\\sqrt{2}$.\n    _Denominator_: $\\nabla_q g \\cdot (M^{-1} \\nabla_q g) = \\frac{1}{m}(|\\nabla_{r_1} g|^2 + |\\nabla_{r_2} g|^2)$. With $m=1$:\n    $|\\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix}|^2 + |\\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix}|^2 = (2+2) + (2+2) = 8$.\n    _Multiplier_: $\\mu = \\frac{2\\sqrt{2}}{8} = \\frac{\\sqrt{2}}{4}$.\n    Now we find the final momenta:\n    $p_{1, k+1} = p_{1, k+1}^* - \\mu \\nabla_{r_1} g = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\frac{\\sqrt{2}}{4} \\begin{pmatrix} -\\sqrt{2} \\\\ \\sqrt{2} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\begin{pmatrix} -2/4 \\\\ 2/4 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} - \\begin{pmatrix} -1/2 \\\\ 1/2 \\end{pmatrix} = \\begin{pmatrix} 1/2 \\\\ 1/2 \\end{pmatrix}$.\n    $p_{2, k+1} = p_{2, k+1}^* - \\mu \\nabla_{r_2} g = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\frac{\\sqrt{2}}{4} \\begin{pmatrix} \\sqrt{2} \\\\ -\\sqrt{2} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\begin{pmatrix} 2/4 \\\\ -2/4 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix} - \\begin{pmatrix} 1/2 \\\\ -1/2 \\end{pmatrix} = \\begin{pmatrix} -1/2 \\\\ -1/2 \\end{pmatrix}$.\n\n### Final State\nThe state at time $t_{k+1}$ is:\n$r_1^{k+1} = \\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4} \\\\ \\frac{\\sqrt{2}}{4} \\end{pmatrix}$\n$r_2^{k+1} = \\begin{pmatrix} \\frac{1}{2} + \\frac{\\sqrt{2}}{4} \\\\ -\\frac{\\sqrt{2}}{4} \\end{pmatrix}$\n$p_1^{k+1} = \\begin{pmatrix} 1/2 \\\\ 1/2 \\end{pmatrix}$\n$p_2^{k+1} = \\begin{pmatrix} -1/2 \\\\ -1/2 \\end{pmatrix}$\n\nThe components for the final answer are:\n$x_1^{k+1} = \\frac{1}{2} - \\frac{\\sqrt{2}}{4}$\n$y_1^{k+1} = \\frac{\\sqrt{2}}{4}$\n$x_2^{k+1} = \\frac{1}{2} + \\frac{\\sqrt{2}}{4}$\n$y_2^{k+1} = -\\frac{\\sqrt{2}}{4}$\n$p_{1x}^{k+1} = \\frac{1}{2}$\n$p_{1y}^{k+1} = \\frac{1}{2}$\n$p_{2x}^{k+1} = -\\frac{1}{2}$\n$p_{2y}^{k+1} = -\\frac{1}{2}$",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{2} - \\frac{\\sqrt{2}}{4}  \\frac{\\sqrt{2}}{4}  \\frac{1}{2} + \\frac{\\sqrt{2}}{4}  -\\frac{\\sqrt{2}}{4}  \\frac{1}{2}  \\frac{1}{2}  -\\frac{1}{2}  -\\frac{1}{2} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "The careful and somewhat complex structure of algorithms like RATTLE raises a crucial question: why not use a more intuitive approach, such as applying a standard integrator and simply projecting the results back to the constraint manifold? This exercise provides the answer by investigating the geometric properties of such a \"naive\" projection method. By deriving the Jacobian of the numerical map and computing its determinant, you will prove that this simple approach is not symplectic, meaning it fails to preserve the phase space volume, a critical feature of Hamiltonian systems. This result underscores the fundamental reason for developing specialized geometric integrators. ",
            "id": "3767126",
            "problem": "Consider a single particle of unit mass constrained to move on the unit circle in $\\mathbb{R}^{2}$. Let the configuration be $q \\in \\mathbb{R}^{2}$, the momentum be $p \\in \\mathbb{R}^{2}$, and the Hamiltonian be $H(q,p) = \\frac{1}{2} |p|^{2}$. The holonomic constraint is $g(q) = |q|^{2} - 1 = 0$, and the hidden velocity constraint is $q \\cdot p = 0$. The continuous constrained dynamics is Hamiltonian on the cotangent bundle of the unit circle with the canonical symplectic form. \n\nDefine a naive two-step explicit integrator with time step $h  0$ as follows:\n1. Perform an explicit Euler step for the unconstrained system:\n$$\nq^{\\ast} = q + h p, \\qquad p^{\\ast} = p.\n$$\n2. Orthogonally project back to the constraint manifold and its tangent space:\n$$\n\\hat{q} = \\frac{q^{\\ast}}{|q^{\\ast}|}, \\qquad \\hat{p} = p^{\\ast} - (\\hat{q} \\cdot p^{\\ast}) \\hat{q}.\n$$\nThis defines a one-step map $\\Phi_{h} : (q,p) \\mapsto (\\hat{q}, \\hat{p})$.\n\nParametrize the constrained phase space by angle-momentum coordinates $(\\theta,\\pi)$ via\n$$\nq = \\begin{pmatrix} \\cos \\theta \\\\ \\sin \\theta \\end{pmatrix}, \\qquad p = \\pi \\begin{pmatrix} -\\sin \\theta \\\\ \\cos \\theta \\end{pmatrix}.\n$$\nUsing only the above definitions and the structure of the map $\\Phi_{h}$, derive the induced one-step map $(\\theta,\\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$ in these coordinates. Then compute the Jacobian matrix $D\\Phi_{h}(\\theta,\\pi)$ of this induced map and its determinant $\\det(D\\Phi_{h}(\\theta,\\pi))$.\n\nProvide a single closed-form analytic expression for $\\det(D\\Phi_{h}(\\theta,\\pi))$ in terms of $h$ and $\\pi$ only as your final answer. No rounding is required, and no units are to be included in the final answer.",
            "solution": "The user wants to analyze a specific numerical integrator for a constrained Hamiltonian system.\n\n### Step 1: Problem Validation\n\nThe problem is stated with mathematical rigor and concerns a standard topic in geometric numerical integration: the analysis of projection methods for constrained mechanical systems.\n\n-   **Givens:**\n    -   Particle mass: $m=1$.\n    -   Configuration: $q \\in \\mathbb{R}^2$, Momentum: $p \\in \\mathbb{R}^2$.\n    -   Hamiltonian: $H(q,p) = \\frac{1}{2}|p|^2$.\n    -   Constraints: $g(q) = |q|^2 - 1 = 0$ and $q \\cdot p = 0$.\n    -   Integrator map $\\Phi_h: (q,p) \\mapsto (\\hat{q}, \\hat{p})$:\n        1.  $q^{\\ast} = q + h p$, $p^{\\ast} = p$.\n        2.  $\\hat{q} = \\frac{q^{\\ast}}{|q^{\\ast}|}$, $\\hat{p} = p^{\\ast} - (\\hat{q} \\cdot p^{\\ast}) \\hat{q}$.\n    -   Coordinate parametrization:\n        $q = (\\cos\\theta, \\sin\\theta)^T$, $p = \\pi(-\\sin\\theta, \\cos\\theta)^T$.\n\n-   **Validation:**\n    -   **Scientific Soundness:** The problem is a well-defined exercise in computational mechanics and differential geometry. It is scientifically and mathematically sound.\n    -   **Well-Posedness:** The definitions are clear and the objectives are specific and achievable through direct computation. A unique solution exists.\n    -   **Completeness and Consistency:** All necessary information is provided. The parametrization is consistent with the constraints: $|q|^2 = \\cos^2\\theta + \\sin^2\\theta = 1$ and $q \\cdot p = \\pi(-\\cos\\theta\\sin\\theta + \\sin\\theta\\cos\\theta) = 0$. The Hamiltonian becomes $H = \\frac{1}{2}|p|^2 = \\frac{1}{2}\\pi^2$.\n\n-   **Verdict:** The problem is valid.\n\n### Step 2: Solution\n\nThe goal is to find the determinant of the Jacobian of the map $\\Phi_h$ in $(\\theta, \\pi)$ coordinates. First, we derive the map $(\\theta, \\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$.\n\n**1. Express the integrator dynamics in $(\\theta, \\pi)$ coordinates.**\n\nWe start with an initial state defined by $(\\theta, \\pi)$:\n$q = \\begin{pmatrix} \\cos\\theta \\\\ \\sin\\theta \\end{pmatrix}$, $p = \\pi \\begin{pmatrix} -\\sin\\theta \\\\ \\cos\\theta \\end{pmatrix}$.\n\n**Step 1: Unconstrained explicit Euler step.**\nThe intermediate state $(q^*, p^*)$ is computed as:\n$p^* = p$.\n$q^* = q + hp = \\begin{pmatrix} \\cos\\theta \\\\ \\sin\\theta \\end{pmatrix} + h\\pi \\begin{pmatrix} -\\sin\\theta \\\\ \\cos\\theta \\end{pmatrix} = \\begin{pmatrix} \\cos\\theta - h\\pi\\sin\\theta \\\\ \\sin\\theta + h\\pi\\cos\\theta \\end{pmatrix}$.\n\n**Step 2: Orthogonal projection.**\nFirst, we find the magnitude of $q^*$:\n$|q^*|^2 = (\\cos\\theta - h\\pi\\sin\\theta)^2 + (\\sin\\theta + h\\pi\\cos\\theta)^2$\n$= (\\cos^2\\theta - 2h\\pi\\cos\\theta\\sin\\theta + h^2\\pi^2\\sin^2\\theta) + (\\sin^2\\theta + 2h\\pi\\sin\\theta\\cos\\theta + h^2\\pi^2\\cos^2\\theta)$\n$= (\\cos^2\\theta + \\sin^2\\theta) + h^2\\pi^2(\\sin^2\\theta + \\cos^2\\theta) = 1 + h^2\\pi^2$.\nThus, $|q^*| = \\sqrt{1 + h^2\\pi^2}$. Notice this is independent of $\\theta$.\n\nThe new position $\\hat{q}$ is found by normalizing $q^*$:\n$\\hat{q} = \\frac{q^*}{|q^*|} = \\frac{1}{\\sqrt{1+h^2\\pi^2}} \\begin{pmatrix} \\cos\\theta - h\\pi\\sin\\theta \\\\ \\sin\\theta + h\\pi\\cos\\theta \\end{pmatrix}$.\n\nThis updated position $\\hat{q}$ must correspond to a new angle $\\hat{\\theta}$ such that $\\hat{q} = (\\cos\\hat{\\theta}, \\sin\\hat{\\theta})^T$. The vector $q^*$ can be interpreted as a point in the plane with coordinates $(1, h\\pi)$ in the orthonormal basis $\\{q, p/|p|\\}$. The angle of this vector relative to the first basis vector $q$ is $\\Delta\\theta = \\arctan(h\\pi)$. Thus, the new angle $\\hat{\\theta}$ is the old angle $\\theta$ plus this increment:\n$\\hat{\\theta} = \\theta + \\arctan(h\\pi)$.\n\nNext, we find the new momentum $\\hat{p}$:\n$\\hat{p} = p^* - (\\hat{q} \\cdot p^*) \\hat{q}$.\nWe compute the dot product $\\hat{q} \\cdot p^*$:\n$\\hat{q} \\cdot p^* = \\frac{q^*}{|q^*|} \\cdot p = \\frac{(q+hp)\\cdot p}{\\sqrt{1+h^2\\pi^2}} = \\frac{q \\cdot p + h(p \\cdot p)}{\\sqrt{1+h^2\\pi^2}}$.\nUsing $q \\cdot p = 0$ and $p \\cdot p = |p|^2 = \\pi^2$, we get:\n$\\hat{q} \\cdot p^* = \\frac{h\\pi^2}{\\sqrt{1+h^2\\pi^2}}$.\n\nSubstituting this into the expression for $\\hat{p}$:\n$\\hat{p} = p - \\left(\\frac{h\\pi^2}{\\sqrt{1+h^2\\pi^2}}\\right) \\hat{q} = p - \\frac{h\\pi^2}{1+h^2\\pi^2} q^*$.\n$\\hat{p} = p - \\frac{h\\pi^2}{1+h^2\\pi^2}(q+hp) = \\left(1 - \\frac{h^2\\pi^2}{1+h^2\\pi^2}\\right)p - \\frac{h\\pi^2}{1+h^2\\pi^2}q$.\n$\\hat{p} = \\frac{1}{1+h^2\\pi^2}p - \\frac{h\\pi^2}{1+h^2\\pi^2}q$.\n\nThe new momentum $\\hat{p}$ must correspond to a new momentum coordinate $\\hat{\\pi}$ such that $\\hat{p} = \\hat{\\pi}(-\\sin\\hat{\\theta}, \\cos\\hat{\\theta})^T$. The magnitude is $|\\hat{p}| = |\\hat{\\pi}|$. Let's compute the squared magnitude of $\\hat{p}$:\n$|\\hat{p}|^2 = \\left|\\frac{1}{1+h^2\\pi^2}p - \\frac{h\\pi^2}{1+h^2\\pi^2}q\\right|^2$.\nSince $p$ and $q$ are orthogonal, this simplifies:\n$|\\hat{p}|^2 = \\left(\\frac{1}{1+h^2\\pi^2}\\right)^2|p|^2 + \\left(\\frac{h\\pi^2}{1+h^2\\pi^2}\\right)^2|q|^2$\n$|\\hat{p}|^2 = \\frac{\\pi^2}{(1+h^2\\pi^2)^2} + \\frac{h^2\\pi^4}{(1+h^2\\pi^2)^2} = \\frac{\\pi^2(1+h^2\\pi^2)}{(1+h^2\\pi^2)^2} = \\frac{\\pi^2}{1+h^2\\pi^2}$.\nSo, $|\\hat{\\pi}| = |\\hat{p}| = \\frac{|\\pi|}{\\sqrt{1+h^2\\pi^2}}$.\nThe calculation confirms that $\\hat{p}$ is correctly tangent to the circle at $\\hat{q}$, and a sign analysis confirms that $\\hat{\\pi}$ has the same sign as $\\pi$. Thus:\n$\\hat{\\pi} = \\frac{\\pi}{\\sqrt{1+h^2\\pi^2}}$.\n\nThe induced map $\\Phi_h: (\\theta, \\pi) \\mapsto (\\hat{\\theta}, \\hat{\\pi})$ is:\n$\\hat{\\theta}(\\theta, \\pi) = \\theta + \\arctan(h\\pi)$\n$\\hat{\\pi}(\\theta, \\pi) = \\pi(1+h^2\\pi^2)^{-1/2}$\n\n**2. Compute the Jacobian matrix $D\\Phi_h(\\theta, \\pi)$.**\n\nThe Jacobian matrix is $D\\Phi_h = \\begin{pmatrix} \\frac{\\partial \\hat{\\theta}}{\\partial \\theta}  \\frac{\\partial \\hat{\\theta}}{\\partial \\pi} \\\\ \\frac{\\partial \\hat{\\pi}}{\\partial \\theta}  \\frac{\\partial \\hat{\\pi}}{\\partial \\pi} \\end{pmatrix}$. We compute the partial derivatives:\n$\\frac{\\partial \\hat{\\theta}}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(\\theta + \\arctan(h\\pi)) = 1$.\n$\\frac{\\partial \\hat{\\theta}}{\\partial \\pi} = \\frac{\\partial}{\\partial \\pi}(\\arctan(h\\pi)) = \\frac{1}{1+(h\\pi)^2} \\cdot h = \\frac{h}{1+h^2\\pi^2}$.\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\theta} = \\frac{\\partial}{\\partial \\theta}(\\pi(1+h^2\\pi^2)^{-1/2}) = 0$.\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\pi} = \\frac{d}{d\\pi} \\left( \\pi(1+h^2\\pi^2)^{-1/2} \\right)$. Using the product rule:\n$\\frac{\\partial \\hat{\\pi}}{\\partial \\pi} = 1 \\cdot (1+h^2\\pi^2)^{-1/2} + \\pi \\cdot \\left(-\\frac{1}{2}(1+h^2\\pi^2)^{-3/2} \\cdot 2h^2\\pi\\right)$\n$= (1+h^2\\pi^2)^{-1/2} - h^2\\pi^2(1+h^2\\pi^2)^{-3/2}$\n$= \\frac{1+h^2\\pi^2}{(1+h^2\\pi^2)^{3/2}} - \\frac{h^2\\pi^2}{(1+h^2\\pi^2)^{3/2}} = \\frac{1}{(1+h^2\\pi^2)^{3/2}}$.\n\nSo, the Jacobian matrix is:\n$D\\Phi_h(\\theta, \\pi) = \\begin{pmatrix} 1  \\frac{h}{1+h^2\\pi^2} \\\\ 0  \\frac{1}{(1+h^2\\pi^2)^{3/2}} \\end{pmatrix}$.\n\n**3. Compute the determinant.**\n\nThe matrix is upper triangular, so its determinant is the product of its diagonal entries:\n$\\det(D\\Phi_h(\\theta, \\pi)) = 1 \\cdot \\frac{1}{(1+h^2\\pi^2)^{3/2}} = \\frac{1}{(1+h^2\\pi^2)^{3/2}}$.\n\nThis expression depends only on $h$ and $\\pi$ as required. It shows that the map is not symplectic (determinant is not $1$) and contracts phase space volume, a characteristic of this type of dissipative projection method.",
            "answer": "$$\n\\boxed{\\frac{1}{(1+h^2\\pi^2)^{\\frac{3}{2}}}}\n$$"
        }
    ]
}