{
    "hands_on_practices": [
        {
            "introduction": "理解变分积分器最直接的方法就是亲手构建一个。本练习将指导你从离散拉格朗日量出发，为简谐振子这一基本物理系统推导出著名的隐式中点积分器。通过这个过程，你将清晰地看到，源于变分结构的辛性这一抽象概念是如何变得具体和明确的。",
            "id": "3770937",
            "problem": "设一个单自由度力学系统由拉格朗日量 $L(q,\\dot{q})=\\tfrac{1}{2} m \\dot{q}^{2}-\\tfrac{1}{2} k q^{2}$ 定义，其中 $m>0$，$k>0$。考虑一个固定的时间步长 $h>0$。使用离散变分原理，其中离散拉格朗日量通过中点求积法来近似一个时间步长上的作用量积分，即 $L_{d}^{\\text{mid}}(q_{k},q_{k+1};h) \\approx \\int_{t_{k}}^{t_{k+1}} L(q,\\dot{q})\\,\\mathrm{d}t$，此方法即中点法则。\n\n任务：\n- 从连续作用量和中点求积出发，计算中点离散拉格朗日量 $L_{d}^{\\text{mid}}(q_{k},q_{k+1};h)$ 关于 $q_{k}$、$q_{k+1}$、$h$、$m$ 和 $k$ 的显式解析表达式。\n- 从离散欧拉-拉格朗日方程和离散勒让德变换出发，推导 $(q_{k+1},p_{k+1})$ 关于 $(q_{k},p_{k})$ 的隐式单步更新方程，其中 $p=\\partial L/\\partial \\dot{q}=m \\dot{q}$ 是正则动量。\n- 通过离散变分构造进行推理（不借助外部结论），证明所得到的更新映射在正则坐标 $(q,p)$ 下是辛的。\n- 最后，令 $\\omega=\\sqrt{k/m}$。将单步映射表示为线性形式，并在辛标度化变量中确定诱导的旋转角 $\\Omega h$。给出 $\\cos(\\Omega h)$ 关于无量纲时间步长 $\\omega h$ 的闭式表达式。\n\n你的最终方框答案必须是 $\\cos(\\Omega h)$ 作为 $\\omega h$ 的函数的解析表达式。最终的方框答案中不要包含单位。",
            "solution": "该问题陈述经核实具有科学依据、是适定且客观的。这是几何数值积分领域的一个标准问题，并包含了获得唯一解所需的所有信息。\n\n单自由度谐振子的连续拉格朗日量由下式给出\n$$L(q, \\dot{q}) = \\frac{1}{2}m\\dot{q}^2 - \\frac{1}{2}kq^2$$\n其中 $q$ 是广义坐标，$\\dot{q}$ 是其时间导数，$m, k > 0$ 分别是质量和弹簧常数。\n\n### 任务1：计算中点离散拉格朗日量\n\n离散拉格朗日量 $L_d(q_k, q_{k+1}; h)$ 是通过使用中点求积法则来近似一个时间步长 $h$ 上的作用量积分来定义的。\n$$L_d(q_k, q_{k+1}; h) = \\int_{t_k}^{t_{k+1}} L(q(t), \\dot{q}(t)) \\mathrm{d}t \\approx h L\\left(q\\left(t_k + \\frac{h}{2}\\right), \\dot{q}\\left(t_k + \\frac{h}{2}\\right)\\right)$$\n为了计算在时间中点的拉格朗日量，我们用一条直线来近似 $q_k = q(t_k)$ 和 $q_{k+1} = q(t_{k+1})$ 之间的路径。\n中点位置是端点的平均值：\n$$q\\left(t_k + \\frac{h}{2}\\right) \\approx \\frac{q_k + q_{k+1}}{2}$$\n沿此线性路径的速度是恒定的，并由有限差分近似：\n$$\\dot{q}\\left(t_k + \\frac{h}{2}\\right) \\approx \\frac{q_{k+1} - q_k}{h}$$\n将这些近似值代入离散拉格朗日量的表达式中，得到：\n$$L_d^{\\text{mid}}(q_k, q_{k+1}; h) = h \\left[ \\frac{1}{2}m\\left(\\frac{q_{k+1} - q_k}{h}\\right)^2 - \\frac{1}{2}k\\left(\\frac{q_k + q_{k+1}}{2}\\right)^2 \\right]$$\n展开此表达式可得到显式解析形式：\n$$L_d^{\\text{mid}}(q_k, q_{k+1}; h) = \\frac{m}{2h}(q_{k+1} - q_k)^2 - \\frac{kh}{8}(q_k + q_{k+1})^2$$\n\n### 任务2：推导单步更新方程\n\n离散作用量是求和 $S_d = \\sum_k L_d(q_k, q_{k+1}; h)$。对于一个内点 $q_k$，离散变分原理 $\\delta S_d = 0$ 导出离散欧拉-拉格朗日（DEL）方程：\n$$D_1 L_d(q_k, q_{k+1}; h) + D_2 L_d(q_{k-1}, q_k; h) = 0$$\n其中 $D_1$ 和 $D_2$ 分别表示对 $L_d$ 的第一个和第二个自变量的偏导数。\n\n离散勒让德变换定义了区间 $[t_k, t_{k+1}]$ 起点和终点的动量：\n$$p_k = -D_1 L_d(q_k, q_{k+1}; h)$$\n$$p_{k+1} = D_2 L_d(q_k, q_{k+1}; h)$$\n让我们从离散拉格朗日量计算这些导数：\n$$D_1 L_d = \\frac{\\partial}{\\partial q_k} \\left(\\frac{m}{2h}(q_{k+1}-q_k)^2 - \\frac{kh}{8}(q_k+q_{k+1})^2\\right) = -\\frac{m}{h}(q_{k+1}-q_k) - \\frac{kh}{4}(q_k+q_{k+1})$$\n$$D_2 L_d = \\frac{\\partial}{\\partial q_{k+1}} \\left(\\frac{m}{2h}(q_{k+1}-q_k)^2 - \\frac{kh}{8}(q_k+q_{k+1})^2\\right) = \\frac{m}{h}(q_{k+1}-q_k) - \\frac{kh}{4}(q_k+q_{k+1})$$\n使用勒让德变换，我们得到定义映射 $(q_k, p_k) \\mapsto (q_{k+1}, p_{k+1})$ 的隐式单步更新方程：\n$$p_k = -D_1 L_d = \\frac{m}{h}(q_{k+1}-q_k) + \\frac{kh}{4}(q_k+q_{k+1})$$\n$$p_{k+1} = D_2 L_d = \\frac{m}{h}(q_{k+1}-q_k) - \\frac{kh}{4}(q_k+q_{k+1})$$\n\n### 任务3：证明映射是辛的\n\n如果一个映射 $(q, p) \\mapsto (Q, P)$ 保持正则辛2-形式 $\\omega = dq \\wedge dp$ 不变，即 $dQ \\wedge dP = dq \\wedge dp$，则该映射是辛的。\n离散勒让德变换定义了 $(q_k, q_{k+1})$ 与 $(q_k, p_k; q_{k+1}, p_{k+1})$ 之间的关系。考虑离散拉格朗日量 $L_d(q_k, q_{k+1}; h)$ 的全微分：\n$$dL_d = D_1 L_d \\,dq_k + D_2 L_d \\,dq_{k+1}$$\n代入动量的定义 $p_k = -D_1 L_d$ 和 $p_{k+1} = D_2 L_d$：\n$$dL_d = -p_k \\,dq_k + p_{k+1} \\,dq_{k+1}$$\n这个方程关联了变量的微分。$L_d$ 是 $q_k$ 和 $q_{k+1}$ 的函数，因此 $p_k$ 和 $p_{k+1}$ 是 $(q_k, q_{k+1})$ 的函数。该方程是在坐标为 $(q_k, q_{k+1})$ 的空间上关联1-形式的恒等式。\n对该方程取外微分，并利用恰当形式的外微分恒为零的性质，$d(dL_d)=0$，我们得到：\n$$d(-p_k \\,dq_k + p_{k+1} \\,dq_{k+1}) = 0$$\n利用 $d$ 的线性性质和恒等式 $d(f dg) = df \\wedge dg$：\n$$-d(p_k \\,dq_k) + d(p_{k+1} \\,dq_{k+1}) = 0$$\n$$-dp_k \\wedge dq_k + dp_{k+1} \\wedge dq_{k+1} = 0$$\n利用楔积的反交换性质 $dq \\wedge dp = -dp \\wedge dq$：\n$$dq_k \\wedge dp_k = dq_{k+1} \\wedge dp_{k+1}$$\n这表明从 $(q_k, p_k)$ 到 $(q_{k+1}, p_{k+1})$ 的更新映射保持正则辛2-形式 $dq \\wedge dp$ 不变。因此，该单步映射是辛的。此证明是按要求直接从离散变分原理推导出来的。\n\n### 任务4：将映射表示为线性形式并求 $\\cos(\\Omega h)$\n\n我们必须求解关于 $(q_k, p_k)$ 的隐式更新方程以得到 $(q_{k+1}, p_{k+1})$。将两个动量方程相加和相减可得：\n$$p_k + p_{k+1} = 2 \\frac{m}{h}(q_{k+1} - q_k) \\quad \\implies \\quad q_{k+1} - q_k = \\frac{h}{2m}(p_k + p_{k+1})$$\n$$p_k - p_{k+1} = 2 \\frac{kh}{4}(q_k + q_{k+1}) \\quad \\implies \\quad p_k - p_{k+1} = \\frac{kh}{2}(q_k + q_{k+1})$$\n这些是隐式中点法则的方程。我们来显式求解 $(q_{k+1}, p_{k+1})$。从第二个方程：$p_{k+1} = p_k - \\frac{kh}{2}(q_k + q_{k+1})$。从第一个方程代入 $q_{k+1}$：$p_{k+1} = p_k - \\frac{kh}{2}\\left(q_k + q_k + \\frac{h}{2m}(p_k+p_{k+1})\\right)$。\n$$p_{k+1} = p_k - khq_k - \\frac{kh^2}{4m}(p_k+p_{k+1})$$\n令 $\\omega = \\sqrt{k/m}$。则 $k=\\omega^2 m$。\n$$p_{k+1}\\left(1 + \\frac{\\omega^2 h^2}{4}\\right) = p_k\\left(1 - \\frac{\\omega^2 h^2}{4}\\right) - kh q_k$$\n$$p_{k+1} = \\frac{1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2} p_k - \\frac{kh}{1 + \\frac{1}{4}\\omega^2 h^2} q_k$$\n现在我们从 $q_{k+1} = q_k + \\frac{h}{2m}(p_k+p_{k+1})$ 求 $q_{k+1}$。\n$$q_{k+1} = q_k + \\frac{h}{2m}p_k + \\frac{h}{2m} \\left( \\frac{1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2} p_k - \\frac{kh}{1 + \\frac{1}{4}\\omega^2 h^2} q_k \\right)$$\n$$q_{k+1} = \\left(1 - \\frac{kh^2/2m}{1 + \\frac{1}{4}\\omega^2 h^2}\\right) q_k + \\left(\\frac{h}{2m} + \\frac{h/2m(1 - \\frac{1}{4}\\omega^2 h^2)}{1 + \\frac{1}{4}\\omega^2 h^2}\\right) p_k$$\n化简 $q_k$ 的系数：\n$$1 - \\frac{\\omega^2 h^2/2}{1 + \\frac{1}{4}\\omega^2 h^2} = \\frac{1 + \\frac{1}{4}\\omega^2 h^2 - \\frac{2}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2} = \\frac{1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2}$$\n化简 $p_k$ 的系数：\n$$\\frac{h}{2m} \\left( 1 + \\frac{1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2} \\right) = \\frac{h}{2m} \\frac{1 + \\frac{1}{4}\\omega^2 h^2 + 1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2} = \\frac{h}{m} \\frac{1}{1 + \\frac{1}{4}\\omega^2 h^2}$$\n线性单步映射为 $\\begin{pmatrix} q_{k+1} \\\\ p_{k+1} \\end{pmatrix} = A \\begin{pmatrix} q_k \\\\ p_k \\end{pmatrix}$，其中矩阵 $A$ 是：\n$$A = \\frac{1}{1+\\frac{1}{4}\\omega^2 h^2} \\begin{pmatrix} 1 - \\frac{1}{4}\\omega^2 h^2  h/m \\\\ -kh  1 - \\frac{1}{4}\\omega^2 h^2 \\end{pmatrix}$$\n为了确定旋转，我们使用辛标度化变量，这些变量使能量轨道变为圆形。一个合适的选择是 $Q = \\sqrt{m\\omega}q$ 和 $P = p/\\sqrt{m\\omega}$，它满足 $dQ \\wedge dP = dq \\wedge dp$。其逆关系为 $q = Q/\\sqrt{m\\omega}$ 和 $p=P\\sqrt{m\\omega}$。\n在新变量 $(Q,P)$ 中的映射由一个矩阵 $B$ 给出，使得 $\\begin{pmatrix} Q_{k+1} \\\\ P_{k+1} \\end{pmatrix} = B \\begin{pmatrix} Q_k \\\\ P_k \\end{pmatrix}$。\n$$Q_{k+1} = A_{11} Q_k + (m\\omega) A_{12} P_k$$\n$$P_{k+1} = \\frac{1}{m\\omega} A_{21} Q_k + A_{22} P_k$$\n新矩阵 $B$ 是：\n$$B_{11} = B_{22} = A_{11} = \\frac{1 - \\frac{1}{4}\\omega^2 h^2}{1 + \\frac{1}{4}\\omega^2 h^2}$$\n$$B_{12} = (m\\omega)A_{12} = \\frac{m\\omega(h/m)}{1+\\frac{1}{4}\\omega^2 h^2} = \\frac{\\omega h}{1+\\frac{1}{4}\\omega^2 h^2}$$\n$$B_{21} = \\frac{1}{m\\omega}A_{21} = \\frac{-kh}{m\\omega(1+\\frac{1}{4}\\omega^2 h^2)} = \\frac{-m\\omega^2 h}{m\\omega(1+\\frac{1}{4}\\omega^2 h^2)} = \\frac{-\\omega h}{1+\\frac{1}{4}\\omega^2 h^2}$$\n所以矩阵 $B$ 是一个旋转矩阵：\n$$B = \\begin{pmatrix} \\cos(\\Omega h)  \\sin(\\Omega h) \\\\ -\\sin(\\Omega h)  \\cos(\\Omega h) \\end{pmatrix} = \\frac{1}{1+\\frac{1}{4}\\omega^2 h^2} \\begin{pmatrix} 1 - \\frac{1}{4}\\omega^2 h^2  \\omega h \\\\ -\\omega h  1 - \\frac{1}{4}\\omega^2 h^2 \\end{pmatrix}$$\n通过比较元素，我们确定了诱导旋转角 $\\Omega h$ 的余弦值：\n$$\\cos(\\Omega h) = \\frac{1 - \\frac{1}{4}(\\omega h)^2}{1 + \\frac{1}{4}(\\omega h)^2}$$\n将分子和分母同乘以 $4$ 可得到一个更简洁的表达式：\n$$\\cos(\\Omega h) = \\frac{4 - (\\omega h)^2}{4 + (\\omega h)^2}$$",
            "answer": "$$\\boxed{\\frac{4 - (\\omega h)^2}{4 + (\\omega h)^2}}$$"
        },
        {
            "introduction": "在构建了一个正确的辛积分器之后，理解为什么其他常见的数值方法（如显式欧拉法）无法保持这种几何结构至关重要。本练习提供了一个直接的对比，揭示了非辛性的根本原因：它无法从一个离散作用量原理中推导出来。这个练习将加深你对变分积分器特定结构的理解。",
            "id": "3770976",
            "problem": "考虑一个机械系统，其位形空间为 $\\mathbb{R}$，拉格朗日量为 $L(q,\\dot{q})=\\tfrac{1}{2} m \\dot{q}^{2}-V(q)$，其中 $m0$ 且 $V:\\mathbb{R}\\to\\mathbb{R}$ 是光滑函数。在时间区间 $[0,T]$ 上的连续作用量为 $S[q]=\\int_{0}^{T} L(q(t),\\dot{q}(t))\\,\\mathrm{d}t$。通过步长为 $h=T/N$ 的左端点求积，可以构造一个朴素离散作用量，\n$$\nS_{d}^{\\mathrm{left}}(q_{0},\\dots,q_{N})=\\sum_{k=0}^{N-1} h\\,L\\!\\left(q_{k},\\frac{q_{k+1}-q_{k}}{h}\\right).\n$$\n然而，假设我们不将离散变分原理应用于 $S_{d}^{\\mathrm{left}}$，而是通过一个显式前向欧拉步直接离散化相应的哈密顿量 $H(q,p)=\\tfrac{1}{2m}p^{2}+V(q)$ 的哈密顿方程，以获得一个时间-$h$ 映射 $(q_{k},p_{k})\\mapsto(q_{k+1},p_{k+1})$：\n$$\nq_{k+1}=q_{k}+h\\,\\frac{\\partial H}{\\partial p}(q_{k},p_{k}),\\qquad p_{k+1}=p_{k}-h\\,\\frac{\\partial H}{\\partial q}(q_{k},p_{k}).\n$$\n具体到谐振子的情况，$V(q)=\\tfrac{1}{2}k q^{2}$，其中 $k0$，因此 $H(q,p)=\\tfrac{1}{2m}p^{2}+\\tfrac{1}{2}k q^{2}$。\n\n任务：\n- 给出该谐振子的显式前向欧拉更新，并从离散变分力学的基本原理出发，精确解释通过这种朴素离散化生成此映射时，违背了哪个结构性要求，从而导致了一个非辛积分器。\n- 然后，为了通过直接计算来验证其非辛性，计算单步映射 $(q_{k},p_{k})\\mapsto(q_{k+1},p_{k+1})$ 的雅可比矩阵的行列式，将其表示为 $h$、$m$ 和 $k$ 的函数。\n\n将您的最终答案表示为关于 $h$、$m$ 和 $k$ 的单个简化符号表达式。不需要进行数值计算，最终方框内的表达式也不需要单位。如果引入任何角度，请以弧度表示。最终答案不要包含不等式或方程；只提供所要求的表达式。",
            "solution": "该问题是有效的，因为它在科学上基于经典力学和几何力学的原理，是适定的，具有唯一且有意义的解，并且使用客观、无歧义的语言表述。\n\n该问题要求完成关于谐振子哈密顿方程的显式前向欧拉离散化的两个主要任务。首先，从离散变分力学的原理出发，解释为什么该方法是非辛的。其次，通过直接计算映射的雅可比行列式来验证其非辛性。\n\n设系统由位形坐标 $q \\in \\mathbb{R}$ 及其共轭动量 $p \\in \\mathbb{R}$ 描述。谐振子的哈密顿量为 $H(q,p)=\\frac{1}{2m}p^{2}+\\frac{1}{2}k q^{2}$，其中 $m  0$ 且 $k  0$。\n\n哈密顿方程为：\n$$\n\\dot{q} = \\frac{\\partial H}{\\partial p} = \\frac{p}{m}\n$$\n$$\n\\dot{p} = -\\frac{\\partial H}{\\partial q} = -kq\n$$\n\n显式前向欧拉方法使用时间步长 $h$ 将这些常微分方程离散化如下：\n$$\nq_{k+1} = q_{k} + h \\dot{q}_{k} = q_{k} + h \\frac{\\partial H}{\\partial p}(q_{k}, p_{k})\n$$\n$$\np_{k+1} = p_{k} + h \\dot{p}_{k} = p_{k} - h \\frac{\\partial H}{\\partial q}(q_{k}, p_{k})\n$$\n代入特定谐振子哈密顿量的偏导数，我们得到显式单步映射 $(q_{k},p_{k}) \\mapsto (q_{k+1},p_{k+1})$：\n$$\nq_{k+1} = q_{k} + \\frac{h}{m} p_{k}\n$$\n$$\np_{k+1} = p_{k} - h k q_{k}\n$$\n\n现在，我们来解决第一个任务：从离散变分力学的基本原理进行解释。一个数值积分器是变分积分器，当且仅当它可以从一个离散拉格朗日量 $L_d(q_k, q_{k+1})$ 导出，该离散拉格朗日量近似了单个时间步上的作用量积分 $\\int_{t_k}^{t_{k+1}} L(q, \\dot{q}) \\, \\mathrm{d}t$。映射 $(q_k, p_k) \\mapsto (q_{k+1}, p_{k+1})$ 随后由离散勒让德变换隐式定义：\n$$\np_k = -\\frac{\\partial L_d}{\\partial q_k}(q_k, q_{k+1})\n$$\n$$\np_{k+1} = \\frac{\\partial L_d}{\\partial q_{k+1}}(q_k, q_{k+1})\n$$\n这种结构是离散变分原理的直接结果，它保证了所得到的映射是辛的。前向欧拉方法所违背的结构性要求，恰恰是它不能由任何这样的离散拉格朗日量 $L_d$ 生成。\n\n为了证明这种违背，我们可以尝试寻找一个能够生成前向欧拉映射的 $L_d$。根据前向欧拉映射的第一个方程 $q_{k+1} = q_{k} + \\frac{h}{m} p_{k}$，我们可以用位置来表示动量 $p_k$：\n$$\np_{k} = \\frac{m}{h}(q_{k+1} - q_{k})\n$$\n将其与第一个离散勒让德变换方程相等，我们得到：\n$$\n-\\frac{\\partial L_d}{\\partial q_k} = \\frac{m}{h}(q_{k+1} - q_{k})\n$$\n将此式对 $q_k$ 积分，得到 $L_d$ 的一个候选形式：\n$$\nL_d(q_k, q_{k+1}) = - \\frac{m}{h} \\left( q_{k+1}q_k - \\frac{1}{2}q_k^2 \\right) + C(q_{k+1})\n$$\n其中 $C(q_{k+1})$ 是 $q_{k+1}$ 的一个任意函数。\n\n现在我们使用前向欧拉映射的第二个方程 $p_{k+1} = p_{k} - h k q_{k}$。代入我们得到的 $p_k$ 的表达式：\n$$\np_{k+1} = \\frac{m}{h}(q_{k+1} - q_{k}) - h k q_{k}\n$$\n这个 $p_{k+1}$ 的表达式必须与第二个离散勒让德变换 $p_{k+1} = \\frac{\\partial L_d}{\\partial q_{k+1}}$ 一致。将我们的候选 $L_d$ 对 $q_{k+1}$ 求导：\n$$\n\\frac{\\partial L_d}{\\partial q_{k+1}} = -\\frac{m}{h} q_k + C'(q_{k+1})\n$$\n将 $p_{k+1}$ 的两个表达式相等，我们必须有：\n$$\n\\frac{m}{h}(q_{k+1} - q_{k}) - h k q_{k} = -\\frac{m}{h} q_k + C'(q_{k+1})\n$$\n化简该方程得到：\n$$\n\\frac{m}{h} q_{k+1} - h k q_{k} = C'(q_{k+1})\n$$\n这个方程存在一个矛盾。等式左侧同时依赖于 $q_k$ 和 $q_{k+1}$，而右侧 $C'(q_{k+1})$ 只能依赖于 $q_{k+1}$。这个等式要成立，当且仅当依赖于 $q_k$ 的项为零，即要求 $h k = 0$。然而，已知 $h$ 和 $k$ 均为正数。因此，不存在能够生成前向欧拉映射的函数 $L_d(q_k, q_{k+1})$。这种无法从离散作用量原理导出的失败，是前向欧拉积分器非辛的根本结构性原因。问题指出，朴素离散作用量 $S_{d}^{\\mathrm{left}}$ 并未被用来推导该映射；如果使用了它，将会生成一个辛积分器（具体来说是辛欧拉 B 方法），而这与前向欧拉方法是不同的。\n\n对于第二个任务，我们通过计算单步映射的雅可比矩阵的行列式来直接验证其非辛性。设映射为 $\\Phi_h: (q_k, p_k) \\mapsto (q_{k+1}, p_{k+1})$，定义如下：\n$$\nq_{k+1} = f(q_k, p_k) = q_k + \\frac{h}{m} p_k\n$$\n$$\np_{k+1} = g(q_k, p_k) = -h k q_k + p_k\n$$\n该映射的雅可比矩阵 $J$ 为：\n$$\nJ = \\begin{pmatrix} \\frac{\\partial f}{\\partial q_k}  \\frac{\\partial f}{\\partial p_k} \\\\ \\frac{\\partial g}{\\partial q_k}  \\frac{\\partial g}{\\partial p_k} \\end{pmatrix}\n$$\n我们计算这四个偏导数：\n$$\n\\frac{\\partial f}{\\partial q_k} = \\frac{\\partial}{\\partial q_k} \\left(q_k + \\frac{h}{m} p_k\\right) = 1\n$$\n$$\n\\frac{\\partial f}{\\partial p_k} = \\frac{\\partial}{\\partial p_k} \\left(q_k + \\frac{h}{m} p_k\\right) = \\frac{h}{m}\n$$\n$$\n\\frac{\\partial g}{\\partial q_k} = \\frac{\\partial}{\\partial q_k} \\left(-h k q_k + p_k\\right) = -hk\n$$\n$$\n\\frac{\\partial g}{\\partial p_k} = \\frac{\\partial}{\\partial p_k} \\left(-h k q_k + p_k\\right) = 1\n$$\n将这些代入雅可比矩阵：\n$$\nJ = \\begin{pmatrix} 1  \\frac{h}{m} \\\\ -hk  1 \\end{pmatrix}\n$$\n雅可比行列式为：\n$$\n\\det(J) = (1)(1) - \\left(\\frac{h}{m}\\right)(-hk) = 1 + \\frac{h^2 k}{m}\n$$\n一个映射是辛映射，当且仅当其雅可比矩阵是辛矩阵。一个矩阵是辛矩阵的必要条件是其行列式必须等于 $1$。由于 $h0$、$k0$ 和 $m0$，项 $\\frac{h^2 k}{m}$ 严格为正。因此，$\\det(J) = 1 + \\frac{h^2 k}{m}  1$。由于行列式不等于 $1$，前向欧拉映射不是辛映射。这意味着该映射不保持相空间体积元 $\\mathrm{d}q \\wedge \\mathrm{d}p$，并且在这种情况下，它在每一步都会使其扩大。这个计算为从变分力学原理得出的结论提供了直接验证。",
            "answer": "$$\\boxed{1 + \\frac{h^2 k}{m}}$$"
        },
        {
            "introduction": "变分积分器的真正威力体现在复杂的长期模拟中，在这些场景下，传统方法会累积显著的误差。这个编程练习将我们学到的原理应用于著名的开普勒问题。通过实现一个变分积分器，你将亲眼见证它在长时间尺度上精确守恒角动量和近似守恒能量等方面的卓越性能。",
            "id": "3770966",
            "problem": "您的任务是实现一个独立的程序，为平面开普勒问题构建一个变分积分器，并对几个测试案例的角动量长期保持性和能量近似守恒性进行定量评估。数学和算法的推导必须从驻定作用量原理和离散变分原理出发，不得依赖任何预先封装的公式或隐藏的捷径。\n\n考虑一个单位质量的质点在具有引力参数 $\\mu  0$ 的平方反比中心势场中于平面内运动。设其位形为 $q(t) \\in \\mathbb{R}^2 \\setminus \\{0\\}$，速度为 $\\dot{q}(t)$，欧几里得范数为 $\\| \\cdot \\|$。连续拉格朗日量为 $L(q,\\dot{q}) = T(\\dot{q}) - U(q)$，其中动能 $T(\\dot{q}) = \\frac{1}{2} \\|\\dot{q}\\|^2$，势能 $U(q) = - \\frac{\\mu}{\\|q\\|}$。对于单位质量 $m=1$，连续欧拉-拉格朗日方程可推得 $m \\ddot{q} = - \\nabla U(q)$。\n\n变分积分器是通过离散化作用量积分得到的。在一个均匀时间网格 $t_k = k h$（时间步长 $h  0$）上，通过使用一个相容的、旋转不变的求积方法来近似区间 $[t_k,t_{k+1}]$ 上的积分 $\\int_{t_k}^{t_{k+1}} L(q,\\dot{q}) \\, \\mathrm{d}t$，从而定义离散拉格朗日量 $L_d(q_k, q_{k+1}; h)$。对于可分的 $L(q,\\dot{q})$，对势能项使用梯形法则，并将区间内的速度视为常数，从而得到一个仅依赖于 $q_k$、$q_{k+1}$ 和 $h$ 的离散拉格朗日量。离散欧拉-拉格朗日方程是通过要求离散作用量总和 $\\sum_k L_d(q_k,q_{k+1};h)$ 相对于 $q_k$ 的变分为驻定值而得到的，这会导出一个关于位置的二阶更新规则。由于离散拉格朗日量在旋转下是不变的，根据诺特定理的离散版本，与特殊正交群（SO(2)）的旋转对称性相关的离散动量映射是精确守恒的。\n\n您的任务：\n\n1. 从第一性原理出发，推导由上述定义的离散拉格朗日量所蕴含的显式位置更新规则。然后，在您的程序中实现由此产生的变分积分器。仅使用当前和先前时间步可用的量；除了 $L(q,\\dot{q})$、$T(\\dot{q})$ 和 $U(q)$ 的定义外，不得假定任何连续时间公式。\n\n2. 为验证角动量的精确守恒，在每个节点 $q_k$ 处计算离散动量 $p_k$。对于 Störmer-Verlet 积分器，一个自然且与能量计算一致的选择是使用中心差分来近似动量（$m=1$ 时等于速度）：$p_k = \\frac{q_{k+1} - q_{k-1}}{2h}$。使用此定义和平面动量映射 $J(q,p) = q_x p_y - q_y p_x$ 来构建仿真过程中的离散角动量序列 $\\{J_k\\}$。通过计算在所有仿真步长上的最大绝对偏差 $\\max_k |J_k - J_0|$ 来衡量长期保持性（其中 $J_0$ 由初始条件 $q_0, \\dot{q}_0$ 直接计算）。\n\n3. 为评估能量的近似守恒性，定义连续机械能 $E(q,\\dot{q}) = \\frac{1}{2}\\|\\dot{q}\\|^2 + U(q)$，并使用与角动量计算中相同的中心差分 $\\frac{q_{k+1} - q_{k-1}}{2h}$ 来近似节点处的 $\\dot{q}(t_k)$。计算仿真过程中的序列 $\\{E_k\\}$，并报告最大绝对偏差 $\\max_k |E_k - E_0|$ 以及平均每步漂移 $(E_N - E_0)/N$，其中 $N$ 是总步数。\n\n4. 为每个测试案例初始化积分器，需在 $t_0$ 时刻指定 $q_0$ 和 $\\dot{q}_0$，然后通过与您在任务1中推导的变分更新一致的单步计算获得 $q_1$。\n\n5. 实现以下测试套件。所有量均为无量纲。对于每个测试案例，以步长 $h$ 仿真 $N$ 步，并按顺序为每个案例输出三个指标：最大绝对角动量偏差、最大绝对能量偏差和平均每步能量漂移（一个可能为负的浮点数）。在所有案例中均使用引力参数 $\\mu = 1$。\n   - 测试案例1（理想圆形轨道）：半径 $r_0 = 1$，初始位置 $q_0 = (r_0, 0)$，初始速度 $\\dot{q}_0 = (0, \\sqrt{\\mu/r_0})$，步长 $h = 0.01$，步数 $N = 20000$。\n   - 测试案例2（中等偏心率椭圆）：半长轴 $a = 1$，偏心率 $e = 0.6$，近心点半径 $r_p = a(1-e)$，初始位置 $q_0 = (r_p, 0)$，近心点速度 $\\dot{q}_0 = (0, \\sqrt{\\mu(1+e)/(a(1-e))})$，步长 $h = 0.02$，步数 $N = 20000$。\n   - 测试案例3（高偏心率椭圆，更小步长）：半长轴 $a = 1$，偏心率 $e = 0.9$，近心点半径 $r_p = a(1-e)$，初始位置 $q_0 = (r_p, 0)$，近心点速度 $\\dot{q}_0 = (0, \\sqrt{\\mu(1+e)/(a(1-e))})$，步长 $h = 0.005$，步数 $N = 20000$。\n\n6. 最终输出格式：您的程序应生成单行输出，其中包含一个以逗号分隔的列表的列表形式的结果，每个子列表对应一个测试案例，并按上述顺序包含三个浮点数。例如，形如 $\\texttt{[[ang\\_err1,energy\\_err1,drift1],[ang\\_err2,energy\\_err2,drift2],[ang\\_err3,energy\\_err3,drift3]]}$ 的行。\n\n该实现必须完全独立，无需用户输入即可运行。不允许使用外部数据文件或网络访问。如果在您的内部计算中出现任何角度，必须以弧度为单位。不需要物理单位；将所有量视为无量纲。程序必须遵守指定的执行环境和库约束。",
            "solution": "构建平面开普勒问题的变分积分器并评估其守恒特性的问题是有效且适定的。它基于拉格朗日力学、几何积分和数值分析的既定原理。所有必要的常数、初始条件和评估指标都已明确指定，构成一个自足且可解的问题。\n\n求解过程首先从指定的离散拉格朗日量推导离散运动方程，然后实现所得算法，最后在给定的测试案例上评估其性能。\n\n### 第一步：变分积分器的推导\n\n问题始于一个单位质量质点（$m=1$）在中心势 $U(q) = -\\frac{\\mu}{\\|q\\|}$ 中的连续拉格朗日量：\n$$\nL(q, \\dot{q}) = T(\\dot{q}) - U(q) = \\frac{1}{2}\\|\\dot{q}\\|^2 + \\frac{\\mu}{\\|q\\|}\n$$\n变分积分器通过离散化作用量积分 $S = \\int L(q, \\dot{q}) \\, \\mathrm{d}t$ 来构建。离散作用量是一个总和 $S_d = \\sum_k L_d(q_k, q_{k+1}; h)$，其中 $L_d$ 是近似单个时间步长 $h$ 内作用量的离散拉格朗日量。\n\n离散拉格朗日量 $L_d(q_k, q_{k+1}; h)$ 是通过近似积分 $\\int_{t_k}^{t_{k+1}} L(q(t), \\dot{q}(t)) \\, \\mathrm{d}t$ 来定义的。我们使用指定的求积规则：\n1.  动能项通过假设在区间 $[t_k, t_{k+1}]$ 上的速度为常数 $\\dot{q}(t) \\approx \\frac{q_{k+1} - q_k}{h}$ 来近似。\n    $$\n    \\int_{t_k}^{t_{k+1}} T(\\dot{q}) \\, \\mathrm{d}t \\approx \\int_{t_k}^{t_{k+1}} \\frac{1}{2} \\left\\| \\frac{q_{k+1} - q_k}{h} \\right\\|^2 \\, \\mathrm{d}t = h \\cdot \\frac{1}{2h^2} \\|q_{k+1} - q_k\\|^2 = \\frac{1}{2h} \\|q_{k+1} - q_k\\|^2\n    $$\n2.  势能项通过对 $-U(q)$ 应用梯形法则来近似。\n    $$\n    \\int_{t_k}^{t_{k+1}} (-U(q(t))) \\, \\mathrm{d}t \\approx \\frac{h}{2} (-U(q_k) - U(q_{k+1})) = \\frac{h \\mu}{2} \\left( \\frac{1}{\\|q_k\\|} + \\frac{1}{\\|q_{k+1}\\|} \\right)\n    $$\n将这两项结合起来得到离散拉格朗日量：\n$$\nL_d(q_k, q_{k+1}; h) = \\frac{\\|q_{k+1} - q_k\\|^2}{2h} + \\frac{h \\mu}{2} \\left( \\frac{1}{\\|q_k\\|} + \\frac{1}{\\|q_{k+1}\\|} \\right)\n$$\n离散欧拉-拉格朗日（DEL）方程由驻定作用量原理 $\\delta S_d = 0$ 推导得出。对于一个内部点 $q_k$，这得到：\n$$\nD_2 L_d(q_{k-1}, q_k; h) + D_1 L_d(q_k, q_{k+1}; h) = 0\n$$\n其中 $D_1$ 和 $D_2$ 表示对 $L_d$ 的第一个和第二个向量参数的偏导数（梯度）。我们来计算这些导数。\n$$\nD_1 L_d(q_k, q_{k+1}; h) = \\frac{q_k - q_{k+1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\n$$\nD_2 L_d(q_{k-1}, q_k; h) = \\frac{q_k - q_{k-1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\n将这些代入DEL方程：\n$$\n\\left( \\frac{q_k - q_{k-1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3} \\right) + \\left( \\frac{q_k - q_{k+1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3} \\right) = 0\n$$\n$$\n\\frac{2q_k - q_{k-1} - q_{k+1}}{h} - h \\frac{\\mu q_k}{\\|q_k\\|^3} = 0\n$$\n求解 $q_{k+1}$ 得到显式的位置更新规则，即 Störmer-Verlet 方法：\n$$\nq_{k+1} = 2q_k - q_{k-1} - h^2 \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\n这个更新规则需要两个先前的位置，$q_k$ 和 $q_{k-1}$。对于初始化，我们给定 $q_0$ 和 $\\dot{q}_0$。我们必须以与积分器一致的方式找到 $q_1$。这可以通过二阶泰勒展开实现：\n$$\nq_1 = q_0 + h\\dot{q}_0 + \\frac{h^2}{2}\\ddot{q}_0\n$$\n从连续运动方程可知，$\\ddot{q}_0 = -\\nabla U(q_0) = -\\frac{\\mu q_0}{\\|q_0\\|^3}$。因此，第一步是：\n$$\nq_1 = q_0 + h\\dot{q}_0 - \\frac{h^2 \\mu}{2} \\frac{q_0}{\\|q_0\\|^3}\n$$\n有了 $q_0$ 和 $q_1$，就可以使用主更新规则对所有后续步骤进行仿真。\n\n### 第二步：角动量守恒\n\n由于离散拉格朗日量具有旋转对称性，离散诺特定理保证了存在一个精确守恒的离散角动量。对于 Störmer-Verlet 方法，这个守恒量可以方便地使用中心差分速度来计算。问题要求使用这个定义：\n$$\np_k = \\frac{q_{k+1} - q_{k-1}}{2h}\n$$\n角动量在第 $k$ 步由 $J_k = (q_k)_x (p_k)_y - (q_k)_y (p_k)_x$ 给出。\n初始角动量 $J_0$ 直接由初始条件计算：$J_0 = (q_0)_x (\\dot{q}_0)_y - (q_0)_y (\\dot{q}_0)_x$。\n然后计算序列 $\\{J_k\\}$，其中 $k=1, \\dots, N$。偏差通过 $\\max_{k \\ge 1} |J_k - J_0|$ 来衡量。由于积分器的几何特性，这个偏差预计在机器精度的量级。\n\n### 第三步：能量的近似守恒\n\n该积分器不精确守恒连续能量。我们通过在每个节点计算能量的近似值来评估其近似守恒性。连续能量为 $E(q,\\dot{q}) = \\frac{1}{2}\\|\\dot{q}\\|^2 - \\frac{\\mu}{\\|q\\|}$。\n速度 $\\dot{q}_k$ 使用与角动量计算中相同的二阶中心差分来近似：\n$$\n\\dot{q}_k \\approx \\frac{q_{k+1} - q_{k-1}}{2h}\n$$\n这使我们能够计算能量序列 $\\{E_k\\}$，其中 $k=1, \\dots, N$。参考能量 $E_0$ 使用给定的初始条件计算：\n$$\nE_0 = E(q_0, \\dot{q}_0) = \\frac{1}{2}\\|\\dot{q}_0\\|^2 - \\frac{\\mu}{\\|q_0\\|}\n$$\n对于 $k=1, \\dots, N$，能量为：\n$$\nE_k = \\frac{1}{2} \\left\\| \\frac{q_{k+1} - q_{k-1}}{2h} \\right\\|^2 - \\frac{\\mu}{\\|q_k\\|}\n$$\n注意，计算 $E_N$ 和 $J_N$ 需要 $q_{N+1}$，因此仿真必须多运行一步。能量的度量指标是最大绝对偏差 $\\max_k |E_k - E_0|$ 和平均每步漂移 $(E_N - E_0)/N$。对于像 Verlet 这样的对称积分器，能量误差预计是有界的（振荡的），而不是线性增长，因此长时间内的平均漂移非常小。\n\n### 第四步：算法实现\n\n程序将为一系列测试案例实现推导出的公式。对于每个案例：\n1.  初始化参数（$\\mu=1$, $q_0$, $\\dot{q}_0$, $h$, $N$）。\n2.  分配一个数组来存储位置 $q_0, \\dots, q_{N+1}$。\n3.  使用特殊的初始化公式计算 $q_1$。\n4.  从 $k=1$ 到 $N$ 迭代，使用 Störmer-Verlet 更新规则计算 $q_{k+1}$。\n5.  计算离散角动量序列 $J_1, \\dots, J_{N}$，并找到与 $J_0$ 的最大绝对偏差。\n6.  计算近似能量序列 $E_0, \\dots, E_N$，并找到最大绝对偏差和平均漂移。\n7.  存储并格式化这三个结果指标。\n\n这个植根于第一性原理的系统化过程，确保了实现的正确性和稳健性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Constructs and evaluates a variational integrator for the planar Kepler problem.\n    \"\"\"\n    \n    # Gravitational parameter\n    mu = 1.0\n\n    # Define the test cases from the problem statement.\n    # Each case: (initial position q0, initial velocity q0_dot, time step h, number of steps N)\n    a_2, e_2 = 1.0, 0.6\n    rp_2 = a_2 * (1.0 - e_2)\n    vp_2 = np.sqrt(mu * (1.0 + e_2) / (a_2 * (1.0 - e_2)))\n    \n    a_3, e_3 = 1.0, 0.9\n    rp_3 = a_3 * (1.0 - e_3)\n    vp_3 = np.sqrt(mu * (1.0 + e_3) / (a_3 * (1.0 - e_3)))\n\n    test_cases = [\n        (np.array([1.0, 0.0]), np.array([0.0, np.sqrt(mu/1.0)]), 0.01, 20000),\n        (np.array([rp_2, 0.0]), np.array([0.0, vp_2]), 0.02, 20000),\n        (np.array([rp_3, 0.0]), np.array([0.0, vp_3]), 0.005, 20000),\n    ]\n\n    all_results = []\n    \n    for q0, q0_dot, h, N in test_cases:\n        \n        # --- Simulation ---\n        # We need N+2 points (q_0, ..., q_{N+1}) to compute energy/momentum at E_N/J_N.\n        q_history = np.zeros((N + 2, 2))\n        q_history[0] = q0\n        \n        # Task 1/4: Initialization of q1\n        # q1 = q0 + h*q0_dot + (h^2/2)*ddot(q0)\n        # ddot(q0) = -mu * q0 / ||q0||^3\n        norm_q0 = np.linalg.norm(q0)\n        q0_ddot = -mu * q0 / (norm_q0**3)\n        q1 = q0 + h * q0_dot + 0.5 * h**2 * q0_ddot\n        q_history[1] = q1\n        \n        # Main integration loop (Störmer-Verlet)\n        # q_{k+1} = 2*q_k - q_{k-1} - h^2 * mu * q_k / ||q_k||^3\n        for k in range(1, N + 1):\n            q_k = q_history[k]\n            q_k_minus_1 = q_history[k-1]\n            norm_qk = np.linalg.norm(q_k)\n            force_term = -h**2 * mu * q_k / (norm_qk**3)\n            q_k_plus_1 = 2 * q_k - q_k_minus_1 + force_term\n            q_history[k+1] = q_k_plus_1\n            \n        # --- Analysis ---\n        \n        # Initial values for conservation checks\n        j0 = q0[0] * q0_dot[1] - q0[1] * q0_dot[0]\n        e0 = 0.5 * np.dot(q0_dot, q0_dot) - mu / norm_q0\n        \n        # Allocate history arrays for computed values\n        j_history = np.zeros(N)\n        e_history = np.zeros(N + 1)\n        e_history[0] = e0\n        \n        # Loop for analysis (k from 1 to N)\n        for k in range(1, N + 1):\n            q_k = q_history[k]\n            q_k_plus_1 = q_history[k+1]\n            q_k_minus_1 = q_history[k-1]\n            \n            # Task 2: Angular Momentum Preservation\n            # p_k = (q_{k+1} - q_{k-1}) / (2h)\n            p_k_approx = (q_k_plus_1 - q_k_minus_1) / (2.0 * h)\n            j_k = q_k[0] * p_k_approx[1] - q_k[1] * p_k_approx[0]\n            j_history[k-1] = j_k # Store J_1..J_N in j_history[0..N-1]\n            \n            # Task 3: Energy Near-Conservation\n            # Use same velocity approximation\n            q_k_dot_approx = p_k_approx\n            kinetic_energy = 0.5 * np.dot(q_k_dot_approx, q_k_dot_approx)\n            potential_energy = -mu / np.linalg.norm(q_k)\n            e_k = kinetic_energy + potential_energy\n            e_history[k] = e_k\n            \n        max_ang_mom_dev = np.max(np.abs(j_history - j0))\n        \n        e_n = e_history[N]\n        max_energy_dev = np.max(np.abs(e_history - e0))\n        avg_energy_drift = (e_n - e0) / N\n        \n        all_results.append([max_ang_mom_dev, max_energy_dev, avg_energy_drift])\n\n    # Final print statement in the exact required format.\n    case_strings = []\n    for case_result in all_results:\n        case_strings.append(f\"[{case_result[0]},{case_result[1]},{case_result[2]}]\")\n    print(f\"[{','.join(case_strings)}]\")\n\nsolve()\n```"
        }
    ]
}