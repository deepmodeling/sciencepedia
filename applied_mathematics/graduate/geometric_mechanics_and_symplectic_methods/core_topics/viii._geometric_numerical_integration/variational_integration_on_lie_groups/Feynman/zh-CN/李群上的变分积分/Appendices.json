{
    "hands_on_practices": [
        {
            "introduction": "在构造李群积分器时，凯莱变换 (Cayley transform) 是指数映射 (exponential map) 的一种计算成本更低的替代方案。为了有效地使用它，我们不仅需要理解其正向应用，还必须掌握其逆变换以及两者在数值上的稳定性，尤其是在其奇点附近 。本练习将引导你亲手推导其逆映射的表达式，并分析其条件数，这对于稳健的算法实现至关重要。",
            "id": "3783913",
            "problem": "考虑特殊正交群 (SO)，记为 $\\mathrm{SO}(n)$，及其由斜对称矩阵构成的李代数，记为 $\\mathfrak{so}(n)$。在李群变分积分器中，一个常见的从 $\\mathfrak{so}(n)$ 到 $\\mathrm{SO}(n)$ 的收缩是凯莱变换，其定义为\n$$\n\\mathrm{cay}(\\hat{\\eta}) \\;=\\; \\left(I - \\tfrac{1}{2}\\hat{\\eta}\\right)^{-1}\\!\\left(I + \\tfrac{1}{2}\\hat{\\eta}\\right),\n$$\n其中 $I$ 表示单位矩阵，$\\hat{\\eta} \\in \\mathfrak{so}(n)$ 是一个斜对称矩阵。此映射用于根据离散变分原理中产生的代数元素来更新 $\\mathrm{SO}(n)$ 上的位形。\n\n从上述定义出发，仅使用正交矩阵和斜对称矩阵的性质，推导逆凯莱变换的闭式表达式，该变换将一个没有特征值为 $-1$ 的旋转矩阵 $R \\in \\mathrm{SO}(n)$ 映射回一个仅用 $R$ 表示的元素 $\\hat{\\eta} \\in \\mathfrak{so}(n)$。明确指出您的逆变换有效的定义域。然后，利用斜对称矩阵的正规性和旋转矩阵的正交性，通过基于特征值的推理来分析正向和逆向映射的数值稳定性，并回答以下问题：\n\n- 对于正向映射，当 $\\hat{\\eta}$ 为实斜对称矩阵时，描述以 $\\left(I - \\tfrac{1}{2}\\hat{\\eta}\\right)$ 为系数矩阵的线性求解的条件数如何随 $\\hat{\\eta}$ 的谱半径变化。讨论在这种情况下 $\\left(I - \\tfrac{1}{2}\\hat{\\eta}\\right)$ 是否可能出现真正的奇异性。\n- 对于逆向映射，根据 $R$ 的特征角来描述矩阵 $\\left(R + I\\right)$ 求逆的条件特性，并确定该求逆过程在何种情况下会变得病态。\n\n您的最终答案必须是逆凯莱变换 $\\mathrm{cay}^{-1}(R)$ 的一个仅用 $R$ 表示的单一闭式矩阵表达式。不需要进行数值计算，也不涉及任何单位。将最终答案表示为一个包含精确常数的解析表达式。",
            "solution": "该问题被评估为有效。它在科学上基于成熟的李群理论和几何力学，数学上是适定的，有足够的信息得到唯一解，并且陈述客观。所要求的推导和分析并非无足轻重，且是该主题的核心。因此，我们可以进行完整的解答。\n\n我们的目标是推导凯莱变换的逆变换，分析正向和逆向映射的数值稳定性，并为逆向映射提供一个闭式表达式。\n\n凯莱变换将一个元素 $\\hat{\\eta}$ 从李代数 $\\mathfrak{so}(n)$ 映射到李群 $\\mathrm{SO}(n)$ 中的一个元素 $R$。其定义为：\n$$\nR = \\mathrm{cay}(\\hat{\\eta}) = \\left(I - \\frac{1}{2}\\hat{\\eta}\\right)^{-1}\\left(I + \\frac{1}{2}\\hat{\\eta}\\right)\n$$\n其中 $\\hat{\\eta} \\in \\mathfrak{so}(n)$ 是一个 $n \\times n$ 的实斜对称矩阵（即 $\\hat{\\eta}^T = -\\hat{\\eta}$），$I$ 是 $n \\times n$ 的单位矩阵。\n\n首先，我们推导逆映射 $\\mathrm{cay}^{-1}(R)$，它将 $\\hat{\\eta}$ 表示为 $R$ 的函数。我们从对 $R$ 的定义进行代数重排开始。\n用 $\\left(I - \\frac{1}{2}\\hat{\\eta}\\right)$ 左乘，我们得到：\n$$\n\\left(I - \\frac{1}{2}\\hat{\\eta}\\right)R = \\left(I + \\frac{1}{2}\\hat{\\eta}\\right)\n$$\n将 $R$ 分配到左侧，得到：\n$$\nR - \\frac{1}{2}\\hat{\\eta}R = I + \\frac{1}{2}\\hat{\\eta}\n$$\n为了解出 $\\hat{\\eta}$，我们将所有含 $\\hat{\\eta}$ 的项移到一边，其余项移到另一边：\n$$\nR - I = \\frac{1}{2}\\hat{\\eta}R + \\frac{1}{2}\\hat{\\eta}\n$$\n在右侧提出公因子 $\\hat{\\eta}$，得到：\n$$\nR - I = \\frac{1}{2}\\hat{\\eta}(R+I)\n$$\n两边乘以 $2$：\n$$\n2(R - I) = \\hat{\\eta}(R+I)\n$$\n为了分离出 $\\hat{\\eta}$，我们必须右乘 $(R+I)$ 的逆矩阵。这个逆矩阵 $(R+I)^{-1}$ 存在的充要条件是矩阵 $(R+I)$ 非奇异，这等价于说 $(R+I)$ 没有零特征值。$(R+I)$ 的特征值形式为 $\\lambda + 1$，其中 $\\lambda$ 是 $R$ 的一个特征值。因此，$(R+I)$ 可逆的充要条件是 $R$ 没有等于 $-1$ 的特征值。这正是问题陈述中给出的条件。\n\n因此，逆凯莱变换有效的定义域是所有不具有特征值 $-1$ 的旋转矩阵 $R \\in \\mathrm{SO}(n)$ 的集合。在物理上，对于 $\\mathrm{SO}(3)$，这排除了旋转角度为 $\\pi$ 弧度（$180^\\circ$）的旋转。\n\n在此条件下，我们可以写出 $\\hat{\\eta}$ 的表达式：\n$$\n\\hat{\\eta} = 2(R - I)(R + I)^{-1}\n$$\n我们必须验证这个 $\\hat{\\eta}$ 的表达式确实产生一个斜对称矩阵，即 $\\hat{\\eta}^T = -\\hat{\\eta}$。我们使用以下性质：$R \\in \\mathrm{SO}(n)$ 意味着 $R^T=R^{-1}$，以及对于任何可逆矩阵 $A$，有 $(A^{-1})^T = (A^T)^{-1}$。\n$$\n\\hat{\\eta}^T = \\left[ 2(R - I)(R + I)^{-1} \\right]^T = 2 \\left[ (R + I)^{-1} \\right]^T (R-I)^T = 2 ( (R+I)^T )^{-1} (R^T - I^T)\n$$\n代入 $R^T = R^{-1}$ 和 $I^T = I$：\n$$\n\\hat{\\eta}^T = 2 (R^{-1} + I)^{-1} (R^{-1} - I)\n$$\n为了简化括号中的项，我们提出公因子 $R^{-1}$：\n$R^{-1} + I = R^{-1}(I+R)$\n$R^{-1} - I = R^{-1}(I-R)$\n将这些代入 $\\hat{\\eta}^T$ 的表达式中：\n$$\n\\hat{\\eta}^T = 2 \\left( R^{-1}(I+R) \\right)^{-1} \\left( R^{-1}(I-R) \\right)\n$$\n使用恒等式 $(AB)^{-1} = B^{-1}A^{-1}$：\n$$\n\\hat{\\eta}^T = 2 (I+R)^{-1} (R^{-1})^{-1} R^{-1} (I-R) = 2 (I+R)^{-1} R R^{-1} (I-R)\n$$\n$$\n\\hat{\\eta}^T = 2 (I+R)^{-1} (I-R)\n$$\n可以证明 $(R-I)$ 和 $(R+I)$ 是可交换的，这意味着 $(R-I)$ 和 $(R+I)^{-1}$ 也是可交换的。因此，我们可以写成 $\\hat{\\eta} = 2(R+I)^{-1}(R-I)$。$\\hat{\\eta}^T$ 的表达式可以重写为：\n$$\n\\hat{\\eta}^T = 2(I+R)^{-1}(-1)(R-I) = -2(R+I)^{-1}(R-I) = -\\hat{\\eta}\n$$\n验证完成。推导出的表达式确实是斜对称的，因此是 $\\mathfrak{so}(n)$ 中的一个有效元素。\n\n接下来，我们分析正向和逆向映射的数值稳定性。\n\n**正向映射稳定性：** 我们分析涉及矩阵 $M = (I - \\frac{1}{2}\\hat{\\eta})$ 的线性系统的条件特性。关于矩阵 $2$-范数的条件数是 $\\kappa_2(M) = \\sigma_{\\max}(M) / \\sigma_{\\min}(M)$，其中 $\\sigma$ 是 $M$ 的奇异值。\n矩阵 $M$ 是正规的，因为 $M^T M = (I + \\frac{1}{2}\\hat{\\eta})(I - \\frac{1}{2}\\hat{\\eta}) = I - \\frac{1}{4}\\hat{\\eta}^2$ 且 $M M^T = (I - \\frac{1}{2}\\hat{\\eta})(I + \\frac{1}{2}\\hat{\\eta}) = I - \\frac{1}{4}\\hat{\\eta}^2$。对于正规矩阵，奇异值是其特征值的绝对值。\n由于 $\\hat{\\eta}$ 是一个实斜对称矩阵，其特征值是纯虚数，并以共轭对 $i\\omega_j$（其中 $\\omega_j \\in \\mathbb{R}$）的形式出现，或者为零。因此 $M$ 的特征值为 $\\lambda_j(M) = 1 - \\frac{1}{2}\\lambda_j(\\hat{\\eta}) = 1 - \\frac{1}{2}i\\omega_j$。\n$M$ 的奇异值为：\n$$\n\\sigma_j(M) = |\\lambda_j(M)| = \\left|1 - \\frac{1}{2}i\\omega_j\\right| = \\sqrt{1^2 + \\left(-\\frac{\\omega_j}{2}\\right)^2} = \\sqrt{1 + \\frac{\\omega_j^2}{4}}\n$$\n特征值 $i\\omega_j$ 与 $\\hat{\\eta}$ 的谱半径 $\\rho(\\hat{\\eta}) = \\max_j |\\omega_j|$ 相关。\n$M$ 的最大和最小奇异值为：\n$$\n\\sigma_{\\max}(M) = \\sqrt{1 + \\frac{(\\max_j |\\omega_j|)^2}{4}} = \\sqrt{1 + \\frac{\\rho(\\hat{\\eta})^2}{4}}\n$$\n$$\n\\sigma_{\\min}(M) = \\sqrt{1 + \\frac{(\\min_j |\\omega_j|)^2}{4}}\n$$\n条件数为 $\\kappa_2(M) = \\sigma_{\\max}(M) / \\sigma_{\\min}(M)$。如果 $\\hat{\\eta}$ 有一个零特征值（即是奇异的），那么 $\\min_j |\\omega_j| = 0$ 且 $\\sigma_{\\min}(M) = 1$。在这种情况下，$\\kappa_2(M) = \\sqrt{1 + \\rho(\\hat{\\eta})^2/4}$。对于大的谱半径，$\\rho(\\hat{\\eta}) \\gg 1$，条件数的变化趋势为 $\\kappa_2(M) \\approx \\frac{1}{2}\\rho(\\hat{\\eta})$。因此，随着代数元素 $\\hat{\\eta}$ 的“大小”增加，正向映射会变得越来越病态。\n关于奇异性，$M$ 如果有任何特征值为零，它就是奇异的。这将要求 $1 - \\frac{1}{2}i\\omega_j=0$，意味着 $i\\omega_j=2$。这是不可能的，因为 $\\omega_j$ 必须是实数。因此，对于任何 $\\hat{\\eta} \\in \\mathfrak{so}(n)$，矩阵 $(I - \\frac{1}{2}\\hat{\\eta})$ 永远不会是奇异的。\n\n**逆向映射稳定性：** 我们分析矩阵 $N = (R+I)$ 求逆的条件特性。与正向映射类似，我们考察条件数 $\\kappa_2(N) = \\sigma_{\\max}(N) / \\sigma_{\\min}(N)$。当 $\\sigma_{\\min}(N)$ 接近零时，会出现病态问题。\n矩阵 $R \\in \\mathrm{SO}(n)$ 是正交的，因此是正规的。由此可知 $N = R+I$ 也是一个正规矩阵，因为 $N^T N = (R^T+I)(R+I) = R^T R + R^T + R + I = 2I + R^{-1} + R$，且 $N N^T = (R+I)(R^T+I) = R R^T + R + R^T + I = 2I + R + R^{-1}$，所以 $N^T N = N N^T$。\n$N$ 的奇异值是其特征值的模。$R$ 的特征值位于复平面的单位圆上，可以写成 $e^{i\\theta_j}$，其中 $\\theta_j$ 是旋转的特征角。$N=R+I$ 的特征值为 $\\lambda_j(N) = e^{i\\theta_j} + 1$。\n$N$ 的奇异值为：\n$$\n\\sigma_j(N) = |\\lambda_j(N)| = |1 + e^{i\\theta_j}| = |1 + \\cos\\theta_j + i\\sin\\theta_j|\n$$\n其模的平方为：\n$$\n\\sigma_j(N)^2 = (1+\\cos\\theta_j)^2 + \\sin^2\\theta_j = 1 + 2\\cos\\theta_j + \\cos^2\\theta_j + \\sin^2\\theta_j = 2 + 2\\cos\\theta_j = 2(1+\\cos\\theta_j)\n$$\n使用半角三角恒等式 $1+\\cos\\theta = 2\\cos^2(\\theta/2)$：\n$$\n\\sigma_j(N)^2 = 4\\cos^2(\\theta_j/2)\n$$\n因此，奇异值为 $\\sigma_j(N) = |2\\cos(\\theta_j/2)|$。由于特征角 $\\theta_j$ 可以在 $[-\\pi, \\pi]$ 内选择，所以 $\\theta_j/2 \\in [-\\pi/2, \\pi/2]$，这保证了 $\\cos(\\theta_j/2) \\ge 0$。所以，$\\sigma_j(N)=2\\cos(\\theta_j/2)$。\n当 $\\sigma_{\\min}(N)$ 接近零时，$N=R+I$ 的求逆会变得病态。这发生在 $\\min_j (2\\cos(\\theta_j/2))$ 接近零时。如果某个特征角 $\\theta_j$ 接近 $\\pm\\pi$，就会发生这种情况。$\\pm\\pi$ 的特征角对应于特征值 $e^{\\pm i\\pi} = -1$。\n因此，当旋转矩阵 $R$ 有一个特征值接近 $-1$ 时，$(R+I)$ 的求逆会变得病态。这就是旋转角度接近 $180^\\circ$ 的情况。\n\n最终答案要求给出逆凯莱变换的闭式表达式。\n$$\n\\hat{\\eta} = \\mathrm{cay}^{-1}(R) = 2(R-I)(R+I)^{-1}\n$$",
            "answer": "$$\\boxed{2(R-I)(R+I)^{-1}}$$"
        },
        {
            "introduction": "变分积分器卓越的长期性能，根植于其离散拉格朗日量对连续作用量积分的逼近精度。本练习旨在阐明这一联系，要求你为由常见求积法则构造的离散拉格朗日量计算其主阶误差项 。通过分析一个简谐振子的这些误差常数，你将更深刻地理解求积法则的选择如何影响积分器的阶数及其能量守恒特性。",
            "id": "3783900",
            "problem": "考虑加法运算下的阿贝尔李群 $\\mathbb{R}$，将其作为一个单自由度力学系统的位形李群，该系统的二次拉格朗日量为 $L(q,\\dot{q}) = \\tfrac{1}{2} m \\dot{q}^{2} - \\tfrac{1}{2} k q^{2}$，其中 $m>0$ 且 $k>0$。令 $\\omega = \\sqrt{k/m}$ 表示自然频率。对于固定的初始条件 $q(0) = q_{0}$ 和 $\\dot{q}(0) = v_{0}$，令 $q(t)$ 为欧拉-拉格朗日方程 $\\ddot{q} + \\omega^{2} q = 0$ 的精确解。将长度为 $h>0$ 的单步上的精确离散拉格朗日量（精确离散作用量）定义为\n$$\nL_{d}^{E}(q_{0},v_{0};h) = \\int_{0}^{h} L\\big(q(t),\\dot{q}(t)\\big)\\, dt.\n$$\n通过将标准求积法则应用于同一精确轨道 $t \\mapsto (q(t),\\dot{q}(t))$，定义两个近似离散拉格朗日量：\n- 梯形（二阶）：\n$$\nL_{d}^{\\mathrm{trap}}(q_{0},v_{0};h) = \\frac{h}{2}\\Big(L\\big(q(0),\\dot{q}(0)\\big) + L\\big(q(h),\\dot{q}(h)\\big)\\Big).\n$$\n- Simpson（四阶）：\n$$\nL_{d}^{\\mathrm{simp}}(q_{0},v_{0};h) = \\frac{h}{6}\\Big(L\\big(q(0),\\dot{q}(0)\\big)+4L\\big(q(\\tfrac{h}{2}),\\dot{q}(\\tfrac{h}{2})\\big)+L\\big(q(h),\\dot{q}(h)\\big)\\Big).\n$$\n定义求积局部作用量误差为 $E_{\\mathrm{trap}}(h) = L_{d}^{\\mathrm{trap}} - L_{d}^{E}$ 和 $E_{\\mathrm{simp}}(h) = L_{d}^{\\mathrm{simp}} - L_{d}^{E}$。对于小的 $h$，假设以下渐近展开式成立：\n$$\nE_{\\mathrm{trap}}(h) = C_{\\mathrm{trap}} h^{3} + \\mathcal{O}(h^{4}), \n\\qquad\nE_{\\mathrm{simp}}(h) = C_{\\mathrm{simp}} h^{5} + \\mathcal{O}(h^{6}),\n$$\n其中 $C_{\\mathrm{trap}}$ 和 $C_{\\mathrm{simp}}$ 是依赖于 $(m,k,q_{0},v_{0})$ 但不依赖于 $h$ 的主局部误差常数。仅使用欧拉-拉格朗日方程的精确解和三角函数的初等泰勒展开，计算 $C_{\\mathrm{trap}}$ 和 $C_{\\mathrm{simp}}$，并确定比率 $C_{\\mathrm{trap}}/C_{\\mathrm{simp}}$ 的仅用 $\\omega$ 表示的简化闭式表达式。\n\n简要解释这些常数的阶数和大小差异如何预测相应变分积分器在长时间模拟中的相对能量行为，利用变分积分器精确守恒一个修正能量的原理，该修正能量与真实能量的偏差与离散拉格朗日量误差的阶数同阶。\n\n你的最终答案必须是仅用 $\\omega$ 表示的 $C_{\\mathrm{trap}}/C_{\\mathrm{simp}}$ 的单一简化表达式（无需数值近似）。",
            "solution": "在尝试求解之前，对问题陈述进行验证。\n\n### 步骤1：提取已知条件\n- **李群**：加法运算下的阿贝尔李群 $\\mathbb{R}$。\n- **拉格朗日量**：$L(q,\\dot{q}) = \\tfrac{1}{2} m \\dot{q}^{2} - \\tfrac{1}{2} k q^{2}$，其中质量 $m>0$，弹簧常数 $k>0$。\n- **自然频率**：$\\omega = \\sqrt{k/m}$。\n- **初始条件**：$q(0) = q_{0}$，$\\dot{q}(0) = v_{0}$。\n- **精确解**：$q(t)$ 是欧拉-拉格朗日方程 $\\ddot{q} + \\omega^{2} q = 0$ 的解。\n- **精确离散拉格朗日量**：$L_{d}^{E}(q_{0},v_{0};h) = \\int_{0}^{h} L\\big(q(t),\\dot{q}(t)\\big)\\, dt$。\n- **梯形离散拉格朗日量**：$L_{d}^{\\mathrm{trap}}(q_{0},v_{0};h) = \\frac{h}{2}\\Big(L\\big(q(0),\\dot{q}(0)\\big) + L\\big(q(h),\\dot{q}(h)\\big)\\Big)$。\n- **Simpson 离散拉格朗日量**：$L_{d}^{\\mathrm{simp}}(q_{0},v_{0};h) = \\frac{h}{6}\\Big(L\\big(q(0),\\dot{q}(0)\\big)+4L\\big(q(\\tfrac{h}{2}),\\dot{q}(\\tfrac{h}{2})\\big)+L\\big(q(h),\\dot{q}(h)\\big)\\Big)$。\n- **求积误差**：$E_{\\mathrm{trap}}(h) = L_{d}^{\\mathrm{trap}} - L_{d}^{E}$ 和 $E_{\\mathrm{simp}}(h) = L_{d}^{\\mathrm{simp}} - L_{d}^{E}$。\n- **渐近展开式**：$E_{\\mathrm{trap}}(h) = C_{\\mathrm{trap}} h^{3} + \\mathcal{O}(h^{4})$ 和 $E_{\\mathrm{simp}}(h) = C_{\\mathrm{simp}} h^{5} + \\mathcal{O}(h^{6})$。\n- **目标**：计算 $C_{\\mathrm{trap}}$、$C_{\\mathrm{simp}}$ 和比率 $C_{\\mathrm{trap}}/C_{\\mathrm{simp}}$。解释其对变分积分器中能量行为的影响。\n\n### 步骤2：使用提取的已知条件进行验证\n该问题具有科学依据，是适定的、客观的。\n1.  **科学或事实不合理性**：该问题描述了一个简谐振子，这是物理学中的一个基本模型。离散拉格朗日量、求积误差和局部误差分析等概念是几何数值积分中的标准课题，在数学和物理上都是合理的。李群的使用在李群上的变分积分领域中是符合语境的，其中 $\\mathbb{R}$ 是最简单的非平凡例子。没有违反任何科学原理。\n2.  **不可形式化或不相关**：该问题在数学上是严谨的，并直接关系到变分积分这一主题。\n3.  **不完整或矛盾的设置**：提供了所有必要的定义和数据。设置是自洽和一致的。\n4.  **不切实际或不可行**：该问题是基于一个标准物理模型的理论计算。它是完全可行的。\n5.  **不适定或结构不良**：该问题是适定的。所要求的量由给定条件唯一确定。语言精确无歧义。\n6.  **故作高深、琐碎或同义反复**：该问题需要一个涉及微积分和级数展开的非平凡、多步骤计算，考验了该学科领域的核心技能。它既不琐碎，也非故作高深。\n7.  **超出科学可验证性范围**：计算和结果在数学上是可验证的。\n\n### 步骤3：结论与行动\n该问题是有效的。将提供完整解答。\n\n### 解答\n\n对于拉格朗日量 $L(q,\\dot{q}) = \\frac{1}{2}m\\dot{q}^2 - \\frac{1}{2}kq^2$，其欧拉-拉格朗日方程为 $m\\ddot{q} + kq = 0$，或 $\\ddot{q} + \\omega^2 q = 0$，其中 $\\omega = \\sqrt{k/m}$。具有初始条件 $q(0)=q_0$ 和 $\\dot{q}(0)=v_0$ 的精确解是\n$$q(t) = q_0 \\cos(\\omega t) + \\frac{v_0}{\\omega} \\sin(\\omega t)$$\n$$ \\dot{q}(t) = -q_0 \\omega \\sin(\\omega t) + v_0 \\cos(\\omega t) $$\n沿此精确轨道计算的拉格朗日量 $L(t) = L(q(t), \\dot{q}(t))$ 为\n$$ L(t) = \\frac{1}{2}m(-q_0 \\omega \\sin(\\omega t) + v_0 \\cos(\\omega t))^2 - \\frac{1}{2}k(q_0 \\cos(\\omega t) + \\frac{v_0}{\\omega} \\sin(\\omega t))^2 $$\n展开并使用 $k=m\\omega^2$，我们发现 $L(t)$ 简化为以下形式：\n$$ L(t) = \\left(\\frac{1}{2}m v_0^2 - \\frac{1}{2}k q_0^2\\right)\\cos(2\\omega t) - \\sqrt{mk} q_0 v_0 \\sin(2\\omega t) $$\n使用 $k=m\\omega^2$，我们可以写出 $\\sqrt{mk} = \\sqrt{m^2\\omega^2} = m\\omega$ 和 $k/\\omega^2=m$。所以，\n$$ L(t) = \\left(\\frac{1}{2}mv_0^2 - \\frac{1}{2}m\\omega^2 q_0^2\\right)\\cos(2\\omega t) - m\\omega q_0 v_0 \\sin(2\\omega t) $$\n让我们定义不依赖于时间，仅依赖于初始条件的常数 $A$ 和 $B$：\n$$ A = \\frac{1}{2}m(v_0^2 - \\omega^2 q_0^2), \\quad B = -m\\omega q_0 v_0 $$\n因此，沿轨道的拉格朗日量为 $L(t) = A\\cos(2\\omega t) + B\\sin(2\\omega t)$。\n\n首先，我们通过对 $L(t)$ 从 $0$ 到 $h$ 积分来计算精确离散拉格朗日量 $L_d^E$：\n$$ L_d^E(h) = \\int_0^h (A\\cos(2\\omega t) + B\\sin(2\\omega t)) \\,dt = \\left[\\frac{A}{2\\omega}\\sin(2\\omega t) - \\frac{B}{2\\omega}\\cos(2\\omega t)\\right]_0^h $$\n$$ L_d^E(h) = \\frac{A}{2\\omega}\\sin(2\\omega h) - \\frac{B}{2\\omega}\\cos(2\\omega h) + \\frac{B}{2\\omega} = \\frac{A}{2\\omega}\\sin(2\\omega h) + \\frac{B}{2\\omega}(1-\\cos(2\\omega h)) $$\n为求主误差项，我们将 $L_d^E(h)$ 在 $h=0$ 附近展开为泰勒级数：\n$$ L_d^E(h) = \\frac{A}{2\\omega}\\left(2\\omega h - \\frac{(2\\omega h)^3}{6} + \\frac{(2\\omega h)^5}{120} - \\dots\\right) + \\frac{B}{2\\omega}\\left(\\frac{(2\\omega h)^2}{2} - \\frac{(2\\omega h)^4}{24} + \\dots\\right) $$\n$$ L_d^E(h) = A\\left(h - \\frac{2\\omega^2 h^3}{3} + \\frac{2\\omega^4 h^5}{15} - \\dots\\right) + B\\left(\\omega h^2 - \\frac{\\omega^3 h^4}{3} + \\dots\\right) $$\n$$ L_d^E(h) = Ah + B\\omega h^2 - \\frac{2A\\omega^2}{3}h^3 - \\frac{B\\omega^3}{3}h^4 + \\frac{2A\\omega^4}{15}h^5 + \\mathcal{O}(h^6) $$\n\n接下来，我们计算梯形近似 $L_d^{\\mathrm{trap}}(h)$：\n$$ L_d^{\\mathrm{trap}}(h) = \\frac{h}{2}(L(0) + L(h)) = \\frac{h}{2}(A + A\\cos(2\\omega h) + B\\sin(2\\omega h)) $$\n按 $h$ 展开：\n$$ L_d^{\\mathrm{trap}}(h) = \\frac{h}{2}\\left(A + A\\left(1 - \\frac{(2\\omega h)^2}{2} + \\dots\\right) + B\\left(2\\omega h - \\frac{(2\\omega h)^3}{6} + \\dots\\right)\\right) $$\n$$ L_d^{\\mathrm{trap}}(h) = \\frac{h}{2}\\left(2A + 2B\\omega h - 2A\\omega^2 h^2 - \\frac{4B\\omega^3}{3}h^3 + \\dots\\right) $$\n$$ L_d^{\\mathrm{trap}}(h) = Ah + B\\omega h^2 - A\\omega^2 h^3 + \\mathcal{O}(h^4) $$\n梯形误差为 $E_{\\mathrm{trap}}(h) = L_d^{\\mathrm{trap}}(h) - L_d^E(h)$。比较级数展开式：\n$$ E_{\\mathrm{trap}}(h) = (Ah + B\\omega h^2 - A\\omega^2 h^3) - (Ah + B\\omega h^2 - \\frac{2A\\omega^2}{3}h^3) + \\mathcal{O}(h^4) $$\n$$ E_{\\mathrm{trap}}(h) = \\left(-A\\omega^2 + \\frac{2A\\omega^2}{3}\\right)h^3 + \\mathcal{O}(h^4) = -\\frac{A\\omega^2}{3}h^3 + \\mathcal{O}(h^4) $$\n因此，梯形法则的主误差常数为 $C_{\\mathrm{trap}} = -\\frac{A\\omega^2}{3}$。\n\n现在，我们计算 Simpson 近似 $L_d^{\\mathrm{simp}}(h)$：\n$$ L_d^{\\mathrm{simp}}(h) = \\frac{h}{6}(L(0) + 4L(h/2) + L(h)) $$\n$$ L_d^{\\mathrm{simp}}(h) = \\frac{h}{6}\\Big(A + 4(A\\cos(\\omega h) + B\\sin(\\omega h)) + (A\\cos(2\\omega h) + B\\sin(2\\omega h))\\Big) $$\n将三角函数展开为 $h$ 的幂级数：\n$\\cos(\\omega h) = 1 - \\frac{\\omega^2h^2}{2} + \\frac{\\omega^4h^4}{24} - \\dots$\n$\\sin(\\omega h) = \\omega h - \\frac{\\omega^3h^3}{6} + \\frac{\\omega^5h^5}{120} - \\dots$\n$\\cos(2\\omega h) = 1 - 2\\omega^2h^2 + \\frac{2\\omega^4h^4}{3} - \\dots$\n$\\sin(2\\omega h) = 2\\omega h - \\frac{4\\omega^3h^3}{3} + \\frac{4\\omega^5h^5}{15} - \\dots$\n将这些代入 $L_d^{\\mathrm{simp}}(h)$ 的表达式中，并按 $h$ 的幂次收集项：\n$$ L_d^{\\mathrm{simp}}(h) = \\frac{h}{6}\\Big[A(1 + 4(1 - \\frac{\\omega^2h^2}{2} + \\frac{\\omega^4h^4}{24}) + (1 - 2\\omega^2h^2 + \\frac{2\\omega^4h^4}{3})) + B(4(\\omega h - \\frac{\\omega^3h^3}{6}) + (2\\omega h - \\frac{4\\omega^3h^3}{3})) + \\mathcal{O}(h^5)\\Big] $$\n$$ L_d^{\\mathrm{simp}}(h) = \\frac{h}{6}\\Big[A(6 - 4\\omega^2h^2 + \\frac{5\\omega^4h^4}{6}) + B(6\\omega h - 2\\omega^3h^3) + \\mathcal{O}(h^5)\\Big] $$\n$$ L_d^{\\mathrm{simp}}(h) = Ah - \\frac{2A\\omega^2}{3}h^3 + \\frac{5A\\omega^4}{36}h^5 + B\\omega h^2 - \\frac{B\\omega^3}{3}h^4 + \\mathcal{O}(h^6) $$\n$$ L_d^{\\mathrm{simp}}(h) = Ah + B\\omega h^2 - \\frac{2A\\omega^2}{3}h^3 - \\frac{B\\omega^3}{3}h^4 + \\frac{5A\\omega^4}{36}h^5 + \\mathcal{O}(h^6) $$\nSimpson 误差为 $E_{\\mathrm{simp}}(h) = L_d^{\\mathrm{simp}}(h) - L_d^E(h)$。直到 $\\mathcal{O}(h^4)$ 的项都相互抵消了。\n$$ E_{\\mathrm{simp}}(h) = \\left(\\frac{5A\\omega^4}{36} - \\frac{2A\\omega^4}{15}\\right)h^5 + \\mathcal{O}(h^6) $$\n$$ E_{\\mathrm{simp}}(h) = A\\omega^4\\left(\\frac{5 \\times 5 - 2 \\times 12}{180}\\right)h^5 + \\mathcal{O}(h^6) = A\\omega^4\\left(\\frac{25-24}{180}\\right)h^5 + \\mathcal{O}(h^6) = \\frac{A\\omega^4}{180}h^5 + \\mathcal{O}(h^6) $$\n因此，Simpson 法则的主误差常数为 $C_{\\mathrm{simp}} = \\frac{A\\omega^4}{180}$。\n\n最后，我们计算比率 $C_{\\mathrm{trap}}/C_{\\mathrm{simp}}$，假设在 $A \\neq 0$ 的一般情况下：\n$$ \\frac{C_{\\mathrm{trap}}}{C_{\\mathrm{simp}}} = \\frac{-A\\omega^2/3}{A\\omega^4/180} = -\\frac{A\\omega^2}{3} \\cdot \\frac{180}{A\\omega^4} = -\\frac{180}{3\\omega^2} = -\\frac{60}{\\omega^2} $$\n\n**关于能量行为的简要解释：**\n由离散拉格朗日量 $L_d$ 构建的变分积分器具有一个显著的几何性质：它们精确地守恒一个修正能量（或“影子哈密顿量”）$H_{\\text{mod}}$，该能量是真实能量 $H$ 的一个微扰。$H_{\\text{mod}}$ 和 $H$ 之间的差是一个关于步长 $h$ 的渐近级数。离散拉格朗日量的精度阶数决定了能量误差的阶数。具体来说，如果离散拉格朗日量以 $p+1$ 阶逼近精确作用量，即 $L_d - L_d^E = \\mathcal{O}(h^{p+1})$，那么所得的变分积分器是 $p$ 阶的，数值能量误差也是 $p$ 阶的，即 $|H_{\\text{numerical}} - H_{\\text{true}}| \\approx |H_{\\text{mod}} - H| = \\mathcal{O}(h^p)$。\n\n- 对于梯形格式，局部作用量误差为 $E_{\\mathrm{trap}} = \\mathcal{O}(h^3)$。这意味着 $p+1=3$，所以该积分器是二阶的（$p=2$）。能量误差有界，并以 $\\mathcal{O}(h^2)$ 阶的振幅振荡。\n- 对于 Simpson 格式，局部作用量误差为 $E_{\\mathrm{simp}} = \\mathcal{O}(h^5)$。这意味着 $p+1=5$，所以该积分器是四阶的（$p=4$）。能量误差有界，并以 $\\mathcal{O}(h^4)$ 阶的振幅振荡。\n\n这种阶数上的差异（$h^2$ 对比 $h^4$）意味着对于小步长 $h$，基于 Simpson 的积分器将比基于梯形的积分器以高得多的精度守恒真实能量。计算出的比率 $|C_{\\mathrm{trap}}/C_{\\mathrm{simp}}| = 60/\\omega^2$ 量化了主误差系数的相对大小，但性能上的主导因素是 $h$ 的幂次差异。高阶方法提供了好得多的长时间能量守恒性，防止了在非辛方法中出现的非物理能量漂移。",
            "answer": "$$ \\boxed{-\\frac{60}{\\omega^2}} $$"
        },
        {
            "introduction": "理论通过实践得以升华。这最后一个练习将挑战你为 $SO(3)$ 上的自由对称刚体构建一个完整的一阶李群变分积分器 。通过将离散变分原理转化为代码，并将你的模拟结果与精确解进行比较，你将直接观察到几何积分的标志性特性，例如离散动量映射的精确守恒。",
            "id": "3783893",
            "problem": "考虑一个自由刚体，其位形流形为特殊正交群 $SO(3)$，惯性张量为对称的（一个对称陀螺），其中主转动惯量满足 $I_1 = I_2 \\neq I_3$。在时间 $t$ 的位形是一个旋转矩阵 $R(t) \\in SO(3)$，体角速度为 $\\omega(t) \\in \\mathbb{R}^3$，体角动量为 $M(t) = J \\omega(t)$，其中 $J = \\operatorname{diag}(I_1,I_2,I_3)$ 是惯性矩阵，单位为千克·米²。连续拉格朗日量是动能 $L(R,\\omega) = \\tfrac{1}{2}\\,\\omega^\\top J\\, \\omega$（单位为焦耳）。李群 $SO(3)$ 上的连续运动方程可以从切丛 $TSO(3)$ 上的 Hamilton 原理推导得出，或者等价地从李代数 $\\mathfrak{so}(3)$ 上的约化（Euler-Poincaré）形式推导得出，并且在无力矩情况下，它们意味着空间角动量 $L^\\text{space}(t) = R(t)\\,M(t)$ 守恒。\n\n李群变分积分器 (LGVI) 通过对一个离散作用量取极值来推进求解，该离散作用量由一个离散拉格朗日量 $L_d(R_k,R_{k+1})$ 构建，该拉格朗日量在一个时间步长内近似 $L$ 的时间积分。使用左平凡化和每步单级求积法则可得到一个一阶方法，其更新形式为 $R_{k+1} = R_k F_k$，其中 $F_k \\in SO(3)$，并对体角动量进行相容的更新。您的任务是为自由对称陀螺设计并实现这样一个一阶 LGVI，它需要：\n- 在大小为 $h$ 的一个步长内，将 $(R_k,M_k)$ 推进到 $(R_{k+1},M_{k+1})$，仅使用 $SO(3)$ 的内蕴运算（旋转矩阵乘法、从 $\\mathfrak{so}(3)$ 到 $SO(3)$ 的指数映射以及协伴随作用）。\n- 确保自由刚体的离散空间角动量 $R_{k}\\,M_k$ 守恒。\n\n对于对称陀螺（$I_1 = I_2$），精确的体角速度解具有闭合形式：当 $I_1 = I_2$ 且初始角速度分量为 $\\omega(0) = (\\omega_1(0),\\omega_2(0),\\omega_3(0))$ 时，分量 $\\omega_3(t)$ 是恒定的，而 $(\\omega_1(t),\\omega_2(t))$ 对以恒定频率 $\\Omega = \\frac{I_3 - I_1}{I_1}\\,\\omega_3(0)$ 旋转，即\n$$\n\\omega_1(t) = \\omega_1(0)\\cos(\\Omega t) - \\omega_2(0)\\sin(\\Omega t),\\quad\n\\omega_2(t) = \\omega_1(0)\\sin(\\Omega t) + \\omega_2(0)\\cos(\\Omega t),\\quad\n\\omega_3(t) = \\omega_3(0).\n$$\n对于球形陀螺（$I_1 = I_2 = I_3$），精确的方位是 $R(t) = R(0)\\,\\exp\\!\\big(t\\,\\widehat{\\omega}(0)\\big)$，其中 $\\widehat{\\omega}$ 表示与 $\\omega$ 的叉积相对应的反对称矩阵（“帽”映射）。\n\n从上述基本原理和 $SO(3)$ 上的离散变分构造出发，推导并实现自由刚体的一步 LGVI 更新。然后，针对三个测试用例，模拟几个周期内的动力学过程，并将数值解与精确运动进行比较。角度使用弧度，时间使用秒，转动惯量使用千克·米²，角速度使用弧度/秒。能量计算单位为焦耳。空间角动量计算单位为千克·米²/秒。\n\n定义误差度量如下：\n- 最终时刻的相对能量误差：$\\left|\\frac{E_\\text{final} - E_\\text{initial}}{E_\\text{initial}}\\right|$，其中 $E = \\tfrac{1}{2}\\,\\omega^\\top J\\,\\omega$。\n- 最终时刻的空间角动量守恒误差：$\\|L^\\text{space}_\\text{final} - L^\\text{space}_\\text{initial}\\|_2$。\n- 最终时刻的状态误差：\n  - 对于对称（但非球形）陀螺：数值体角速度与精确体角速度之差的欧几里得范数，即 $\\|\\omega_\\text{num}(t_f) - \\omega_\\text{exact}(t_f)\\|_2$，单位为弧度/秒。\n  - 对于球形陀螺：方位误差角，单位为弧度，计算为 $\\mathfrak{so}(3)$ 中旋转向量 $\\operatorname{Log}\\!\\big(R_\\text{exact}(t_f)^\\top R_\\text{num}(t_f)\\big)$ 的欧几里得范数。\n\n实现以下测试套件：\n- 测试用例 A（对称陀螺，理想情况）：$I_1 = I_2 = 1.0$，$I_3 = 2.0$，$\\omega(0) = (0.3,\\,0.1,\\,5.0)$，$R(0) = I_{3\\times3}$。横向旋转的周期为 $T = \\frac{2\\pi}{|\\Omega|}$，其中 $\\Omega = \\frac{I_3 - I_1}{I_1}\\,\\omega_3(0)$。模拟 $K = 10$ 个周期，每周期 $m = 100$ 步（$h = T/m$）。\n- 测试用例 B（球形陀螺，具有精确方位的边界情况）：$I_1 = I_2 = I_3 = 1.0$，$\\omega(0) = (1.2,\\,-0.7,\\,2.1)$，$R(0) = I_{3\\times3}$。旋转周期为 $T = \\frac{2\\pi}{\\|\\omega(0)\\|}$。模拟 $K = 8$ 个周期，每周期 $m = 200$ 步（$h = T/m$）。\n- 测试用例 C（对称陀螺，粗略步长的边缘情况）：$I_1 = I_2 = 1.0$，$I_3 = 3.0$，$\\omega(0) = (2.0,\\,-1.0,\\,1.0)$，$R(0) = I_{3\\times3}$。周期为 $T = \\frac{2\\pi}{|\\Omega|}$，其中 $\\Omega = \\frac{I_3 - I_1}{I_1}\\,\\omega_3(0)$。模拟 $K = 5$ 个周期，每周期 $m = 10$ 步（$h = T/m$）。\n\n您的程序必须：\n- 实现从离散变分原理推导出的自由刚体在 $SO(3)$ 上的一步 LGVI。\n- 使用上述精确公式计算对称陀螺的精确体角速度和球形陀螺的精确方位。\n- 对于每个测试用例，输出一个包含三个浮点数的列表：$[\\text{energy\\_relative\\_error},\\,\\text{spatial\\_momentum\\_error\\_norm},\\,\\text{state\\_error}]$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含三个测试用例的结果，格式为用方括号括起来的逗号分隔列表，其中每个条目本身是对应测试用例的列表。例如：“[[resultA1,resultA2,resultA3],[resultB1,resultB2,resultB3],[resultC1,resultC2,resultC3]]”。不应打印任何其他文本。",
            "solution": "问题要求设计、实现并测试一个用于自由刚体动力学的一阶李群变分积分器 (LGVI)。该积分器必须在位形流形 $SO(3)$ 上运行，并保持空间角动量守恒。\n\n在离散时间 $t_k$，系统的状态由对偶 $(R_k, M_k)$ 给出，其中 $R_k \\in SO(3)$ 是方位矩阵，$M_k \\in \\mathbb{R}^3$ 是体固坐标系中的角动量。刚体的惯性由张量 $J = \\operatorname{diag}(I_1, I_2, I_3)$ 描述。体角速度 $\\omega_k$ 通过 $M_k = J \\omega_k$（或 $\\omega_k = J^{-1} M_k$）与动量相关联。\n\n一阶 LGVI 使用增量旋转 $F_k \\in SO(3)$ 构建从步长 $k$ 到 $k+1$ 的更新，使得新位形为 $R_{k+1} = R_k F_k$。问题要求积分器精确地保持离散空间角动量 $L^\\text{space}_k = R_k M_k$ 守恒。为满足此基本要求，我们分析空间动量的更新：\n$$\nL^\\text{space}_{k+1} = R_{k+1} M_{k+1} = (R_k F_k) M_{k+1}\n$$\n为了守恒，必须有 $L^\\text{space}_{k+1} = L^\\text{space}_k = R_k M_k$。这意味着：\n$$\n(R_k F_k) M_{k+1} = R_k M_k \\implies F_k M_{k+1} = M_k \\implies M_{k+1} = F_k^{-1} M_k\n$$\n由于 $F_k \\in SO(3)$，其逆是其转置，即 $F_k^{-1} = F_k^\\top$。因此，动量更新规则由守恒律确定：\n$$\nM_{k+1} = F_k^\\top M_k\n$$\n此更新对应于群元素 $F_k^{-1}$ 对动量 $M_k$ 的协伴随作用，这是李群上几何力学的基石。\n\n剩下的任务是确定增量旋转 $F_k$。对于一阶积分器，一个自然的选择是将时间步长 $h$ 内的运动近似为等速旋转。步长开始时的速度为 $\\omega_k = J^{-1} M_k$。我们可以使用这个速度通过指数映射 $\\exp: \\mathfrak{so}(3) \\to SO(3)$ 来生成增量旋转。\n旋转增量由旋转向量 $\\xi_k = h \\omega_k = h J^{-1} M_k$ 定义。相应的李代数元素是 $\\hat{\\xi}_k$。则增量旋转矩阵为：\n$$\nF_k = \\exp(\\hat{\\xi}_k) = \\exp(h \\widehat{J^{-1} M_k})\n$$\n这个算法被称为李-泊松积分器。它可以从 $SO(3)$ 上的离散变分原理推导出来，并且根据其构造，它是李群结构的内蕴算法，并能保持空间角动量守恒。\n\n完整的一步 LGVI 算法如下：\n给定 $(R_k, M_k)$ 和时间步长 $h$：\n1.  计算体角速度：$\\omega_k = J^{-1} M_k$。\n2.  计算增量旋转向量：$\\xi_k = h \\omega_k$。\n3.  使用指数映射计算增量旋转矩阵：$F_k = \\exp(\\hat{\\xi}_k)$。\n4.  更新方位：$R_{k+1} = R_k F_k$。\n5.  更新体角动量：$M_{k+1} = F_k^\\top M_k$。\n\n该算法将被实现和测试。从旋转向量 $\\xi \\in \\mathbb{R}^3$ 到 $SO(3)$ 中矩阵的指数映射可以使用 Rodrigues 旋转公式进行稳健计算。同样，球形陀螺的方位误差度量所需的对数映射（用于找到给定旋转矩阵对应的旋转向量）也可以可靠地实现。在此实现中，我们将利用 `scipy.spatial.transform.Rotation` 类的功能，该类提供了旋转向量和旋转矩阵之间数值稳定的转换。\n\n对于球形陀螺的情况，其中 $J=I_1 \\cdot I$，惯性张量是单位矩阵的标量倍。算法显著简化。速度为 $\\omega_k = J^{-1} M_k = (1/I_1) M_k$，它与 $M_k$ 平行。旋转 $F_k = \\exp(h \\hat{\\omega}_k)$ 是围绕轴 $\\omega_k$ 的旋转。任何平行于旋转轴的向量在该旋转下都是不变的。因此，$M_{k+1} = F_k^\\top M_k = M_k$。体角动量和角速度在所有时间内都保持恒定。方位的数值解变为 $R_N = R_0 \\exp(N h \\hat{\\omega}_0) = R_0 \\exp(t_N \\hat{\\omega}_0)$，这与精确的连续解完全相同。因此，对于球形陀螺，状态误差（方位）、能量误差和空间角动量误差预计都将在机器精度范围内为零。这为所实现的算法提供了有力的验证。对于对称陀螺，能量预计不会被精确保持守恒，从而导致一个小的非零误差。\n\n模拟将针对三个指定的测试用例进行。对于每个用例，我们初始化 $(R_0, M_0)$，计算初始能量 $E_0 = \\frac{1}{2} M_0^\\top J^{-1} M_0$ 和初始空间角动量 $L^\\text{space}_0 = R_0 M_0$。然后，我们在指定的时间内迭代 LGVI 步骤。最后，我们计算最终状态 $(R_f, M_f)$、最终能量 $E_f$、最终空间角动量 $L^\\text{space}_f$，以及问题陈述中定义的三种误差度量。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.spatial.transform import Rotation\n\ndef solve():\n    \"\"\"\n    Derives, implements, and tests a first-order Lie Group Variational Integrator\n    for the free rigid body problem on SO(3).\n    \"\"\"\n\n    test_cases = [\n        # Case A: Symmetric top\n        {\n            \"name\": \"Symmetric A\",\n            \"I\": np.array([1.0, 1.0, 2.0]),\n            \"omega0\": np.array([0.3, 0.1, 5.0]),\n            \"R0\": np.identity(3),\n            \"K\": 10,\n            \"m\": 100,\n            \"type\": \"symmetric\"\n        },\n        # Case B: Spherical top\n        {\n            \"name\": \"Spherical B\",\n            \"I\": np.array([1.0, 1.0, 1.0]),\n            \"omega0\": np.array([1.2, -0.7, 2.1]),\n            \"R0\": np.identity(3),\n            \"K\": 8,\n            \"m\": 200,\n            \"type\": \"spherical\"\n        },\n        # Case C: Symmetric top (coarse)\n        {\n            \"name\": \"Symmetric C\",\n            \"I\": np.array([1.0, 1.0, 3.0]),\n            \"omega0\": np.array([2.0, -1.0, 1.0]),\n            \"R0\": np.identity(3),\n            \"K\": 5,\n            \"m\": 10,\n            \"type\": \"symmetric\"\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        I_diag = case[\"I\"]\n        J = np.diag(I_diag)\n        J_inv = np.diag(1.0 / I_diag)\n        \n        omega0 = case[\"omega0\"]\n        R0 = case[\"R0\"]\n        M0 = J @ omega0\n\n        K = case[\"K\"]\n        m = case[\"m\"]\n        case_type = case[\"type\"]\n\n        if case_type == \"symmetric\":\n            if np.abs(I_diag[0]) > 1e-12:\n                Omega = (I_diag[2] - I_diag[0]) / I_diag[0] * omega0[2]\n            else: # Should not happen based on test cases\n                Omega = 0.0\n            \n            if np.abs(Omega) > 1e-12:\n                T = 2 * np.pi / np.abs(Omega)\n            else: # Pure rotation around axis 3\n                T = 2 * np.pi / np.linalg.norm(omega0) if np.linalg.norm(omega0) > 1e-12 else 1.0\n\n        elif case_type == \"spherical\":\n            norm_omega0 = np.linalg.norm(omega0)\n            T = 2 * np.pi / norm_omega0 if norm_omega0 > 1e-12 else 1.0\n            \n        h = T / m\n        num_steps = K * m\n        tf = num_steps * h\n\n        # Initial values\n        R_curr = R0.copy()\n        M_curr = M0.copy()\n        \n        E0 = 0.5 * M0.T @ J_inv @ M0\n        L_space0 = R0 @ M0\n\n        # Simulation loop\n        for _ in range(num_steps):\n            # 1. Calculate angular velocity\n            omega_curr = J_inv @ M_curr\n            \n            # 2. Compute incremental rotation vector\n            xi = h * omega_curr\n            \n            # 3. Calculate incremental rotation matrix\n            if np.linalg.norm(xi) > 1e-15:\n                F = Rotation.from_rotvec(xi).as_matrix()\n            else:\n                F = np.identity(3)\n                \n            # 4. Update orientation\n            R_next = R_curr @ F\n            \n            # 5. Update body momentum\n            M_next = F.T @ M_curr\n            \n            R_curr, M_curr = R_next, M_next\n\n        # Final state\n        R_final = R_curr\n        M_final = M_curr\n        omega_final_num = J_inv @ M_final\n\n        # Calculate error metrics\n        # 1. Relative energy error\n        E_final = 0.5 * M_final.T @ J_inv @ M_final\n        if np.abs(E0) > 1e-15:\n            energy_error = np.abs((E_final - E0) / E0)\n        else:\n            energy_error = np.abs(E_final - E0)\n\n        # 2. Spatial momentum conservation error\n        L_space_final = R_final @ M_final\n        momentum_error = np.linalg.norm(L_space_final - L_space0)\n\n        # 3. State error\n        if case_type == \"symmetric\":\n            cos_Omega_t = np.cos(Omega * tf)\n            sin_Omega_t = np.sin(Omega * tf)\n            omega_exact_final = np.array([\n                omega0[0] * cos_Omega_t - omega0[1] * sin_Omega_t,\n                omega0[0] * sin_Omega_t + omega0[1] * cos_Omega_t,\n                omega0[2]\n            ])\n            state_error = np.linalg.norm(omega_final_num - omega_exact_final)\n\n        elif case_type == \"spherical\":\n            # For spherical top, R_exact(tf) = R0 @ exp(tf * hat(omega0))\n            # Since tf = K * T = K * 2*pi/||omega0||, the rotation angle is an integer multiple of 2*pi.\n            # So exp(tf * hat(omega0)) = I. R_exact(tf) = R0.\n            R_exact_final = R0\n            \n            R_error_mat = R_exact_final.T @ R_final\n            \n            if np.linalg.norm(R_error_mat - np.identity(3)) > 1e-12:\n                # Use scipy to handle log map robustly\n                error_rot_vec = Rotation.from_matrix(R_error_mat).as_rotvec()\n                state_error = np.linalg.norm(error_rot_vec)\n            else:\n                # Avoid numerical issues near identity\n                state_error = 0.0\n\n        all_results.append([energy_error, momentum_error, state_error])\n\n    # Final print statement in the exact required format.\n    inner_strings = [f\"[{','.join(map(str, res))}]\" for res in all_results]\n    print(f\"[{','.join(inner_strings)}]\")\n\nsolve()\n```"
        }
    ]
}