{
    "hands_on_practices": [
        {
            "introduction": "The first essential skill in applying the momentum map is knowing how to derive it directly from a system's Lagrangian. This exercise provides a systematic framework for this calculation in the common case of a system with Abelian symmetries, modeled by the torus $\\mathbb{T}^k$. By working through this problem , you will not only derive the momentum map in matrix form but also uncover the crucial non-degeneracy condition required for its components to be independent, a cornerstone for performing Routh reduction.",
            "id": "3765205",
            "problem": "Consider a mechanical system with configuration manifold $Q = X \\times \\mathbb{T}^k$ where $X$ is a smooth $n$-dimensional manifold and $\\mathbb{T}^k$ is the $k$-torus acting by translations on the angular coordinates $\\theta^{i}$, $i \\in \\{1,\\dots,k\\}$. Let local coordinates be denoted by $(x^{a}, \\theta^{i})$ with $a \\in \\{1,\\dots,n\\}$. Assume the system is described by a Lagrangian $L(x,\\theta,\\dot{x},\\dot{\\theta})$ that is invariant under the action of $G=\\mathbb{T}^k$ in the sense that $L$ is independent of $\\theta$. Suppose the Lagrangian has the following general form consistent with invariance and smoothness:\n$$\nL(x,\\theta,\\dot{x},\\dot{\\theta}) \\;=\\; \\tfrac{1}{2}\n\\begin{pmatrix}\n\\dot{x} \\\\[4pt] \\dot{\\theta}\n\\end{pmatrix}^{\\!\\!\\top}\n\\begin{pmatrix}\nM_{xx}(x) & M_{x\\theta}(x) \\\\[4pt]\nM_{\\theta x}(x) & M_{\\theta\\theta}(x)\n\\end{pmatrix}\n\\begin{pmatrix}\n\\dot{x} \\\\[4pt] \\dot{\\theta}\n\\end{pmatrix}\n\\;+\\;\nb(x)^{\\top}\\dot{x}\n\\;+\\;\nc(x)^{\\top}\\dot{\\theta}\n\\;-\\;\nV(x).\n$$\nHere $M_{xx}(x) \\in \\mathbb{R}^{n \\times n}$, $M_{x\\theta}(x) \\in \\mathbb{R}^{n \\times k}$, $M_{\\theta x}(x) \\in \\mathbb{R}^{k \\times n}$, and $M_{\\theta\\theta}(x) \\in \\mathbb{R}^{k \\times k}$, with the symmetry condition $M_{\\theta x}(x) = M_{x\\theta}(x)^{\\top}$, and $b(x) \\in \\mathbb{R}^{n}$, $c(x) \\in \\mathbb{R}^{k}$, $V(x) \\in \\mathbb{R}$ are smooth functions of $x$ alone. The block matrix is assumed smooth in $x$ and pointwise symmetric.\n\nStarting from first principles of geometric mechanics, including the definition of the momentum map for a Lagrangian system with Abelian symmetry and the fiber derivative with respect to velocities, derive the explicit $k$-vector matrix form of the momentum map components associated with the $\\mathbb{T}^k$-action. Then, using the structure of the fiber derivative and the regularity of the Lagrangian, identify and justify a necessary and sufficient condition under which the $k$ components of the momentum map are functionally independent on an open subset of the tangent bundle $TQ$.\n\nExpress your final answer as a single closed-form matrix expression for the momentum map $J(x,\\dot{x},\\dot{\\theta})$ in terms of the given block data. No numerical approximation is required and no units need be specified. The condition for independence must be discussed in your derivation, but the final answer must be the single matrix expression for $J(x,\\dot{x},\\dot{\\theta})$ alone.",
            "solution": "The configuration manifold $Q = X \\times \\mathbb{T}^k$ admits a free and proper action of the Abelian group $G = \\mathbb{T}^k$ by translations on the angle coordinates $\\theta^{i}$. The invariance hypothesis states that the Lagrangian $L(x,\\theta,\\dot{x},\\dot{\\theta})$ depends on $(x,\\dot{x},\\dot{\\theta})$ but not on $\\theta$.\n\nIn Lagrangian geometric mechanics, for a symmetry group $G$ acting on $Q$, the momentum map $J: TQ \\to \\mathfrak{g}^{*}$ is defined via the fiber derivative with respect to velocities along the infinitesimal generators of the group action. For an Abelian group $G = \\mathbb{T}^k$ with Lie algebra $\\mathfrak{g} \\cong \\mathbb{R}^{k}$, the infinitesimal generators correspond to the coordinate vector fields $\\partial/\\partial \\theta^{i}$, and the associated conserved quantities by Noether’s theorem are the conjugate momenta to the cyclic coordinates. Concretely, for each $i \\in \\{1,\\dots,k\\}$,\n$$\nJ_{i}(x,\\dot{x},\\dot{\\theta}) \\;=\\; \\frac{\\partial L}{\\partial \\dot{\\theta}^{i}}(x,\\dot{x},\\dot{\\theta}).\n$$\nCollecting these into a $k$-vector $J(x,\\dot{x},\\dot{\\theta}) \\in \\mathbb{R}^{k}$ yields the momentum map components for the $\\mathbb{T}^{k}$-action.\n\nWe now compute $\\frac{\\partial L}{\\partial \\dot{\\theta}}$ in matrix form using the given structure of $L$. Write\n$$\n\\dot{q} \\;=\\;\n\\begin{pmatrix}\n\\dot{x} \\\\[4pt]\n\\dot{\\theta}\n\\end{pmatrix},\n\\qquad\nM(x) \\;=\\;\n\\begin{pmatrix}\nM_{xx}(x) & M_{x\\theta}(x) \\\\[4pt]\nM_{\\theta x}(x) & M_{\\theta\\theta}(x)\n\\end{pmatrix},\n$$\nwith $M_{\\theta x}(x) = M_{x\\theta}(x)^{\\top}$. The quadratic kinetic term is $\\tfrac{1}{2}\\dot{q}^{\\top}M(x)\\dot{q}$, and the linear-in-velocity terms are $b(x)^{\\top}\\dot{x} + c(x)^{\\top}\\dot{\\theta}$. Differentiating $L$ with respect to $\\dot{\\theta}$ while keeping $(x,\\dot{x})$ fixed gives\n$$\n\\frac{\\partial}{\\partial \\dot{\\theta}}\n\\left(\n\\tfrac{1}{2}\n\\begin{pmatrix}\n\\dot{x} \\\\ \\dot{\\theta}\n\\end{pmatrix}^{\\!\\!\\top}\n\\begin{pmatrix}\nM_{xx} & M_{x\\theta} \\\\\nM_{\\theta x} & M_{\\theta\\theta}\n\\end{pmatrix}\n\\begin{pmatrix}\n\\dot{x} \\\\ \\dot{\\theta}\n\\end{pmatrix}\n\\right)\n\\;=\\;\nM_{\\theta x}(x)\\,\\dot{x} \\;+\\; M_{\\theta\\theta}(x)\\,\\dot{\\theta},\n$$\nsince the derivative of a symmetric quadratic form in $\\dot{\\theta}$ yields the corresponding block multiplying $\\dot{\\theta}$ plus the cross-term block multiplying $\\dot{x}$. The derivative of the linear term $c(x)^{\\top}\\dot{\\theta}$ contributes $c(x)$, while the potential $V(x)$ is independent of velocities and contributes nothing. Therefore\n$$\nJ(x,\\dot{x},\\dot{\\theta}) \\;=\\; \\frac{\\partial L}{\\partial \\dot{\\theta}}(x,\\dot{x},\\dot{\\theta})\n\\;=\\; M_{\\theta x}(x)\\,\\dot{x} \\;+\\; M_{\\theta\\theta}(x)\\,\\dot{\\theta} \\;+\\; c(x).\n$$\n\nWe next discuss the functional independence of the components of $J$. A set of $k$ functions $J_{1},\\dots,J_{k}$ is functionally independent on an open subset of $TQ$ if their differentials are linearly independent there. Consider the Jacobian of $J$ with respect to $\\dot{\\theta}$:\n$$\n\\frac{\\partial J}{\\partial \\dot{\\theta}}(x,\\dot{x},\\dot{\\theta}) \\;=\\; M_{\\theta\\theta}(x).\n$$\nSince $c(x)$ and $M_{\\theta x}(x)\\dot{x}$ do not depend on $\\dot{\\theta}$, the dependence of $J$ on $\\dot{\\theta}$ is entirely controlled by the block $M_{\\theta\\theta}(x)$. Therefore, a necessary and sufficient condition for the momentum components to be functionally independent with respect to the $\\dot{\\theta}$-variables (and hence, generically, as functions on $TQ$) is that $M_{\\theta\\theta}(x)$ be invertible, i.e.,\n$$\n\\det\\!\\big(M_{\\theta\\theta}(x)\\big) \\;\\neq\\; 0\n$$\non the region of interest in $X$. This is precisely the regularity condition of the fiber derivative along the vertical directions associated with the group action and is the standard nondegeneracy hypothesis ensuring that the Legendre transform restricted to the $\\theta$-velocities is a local diffeomorphism. In particular, if the kinetic energy metric defined by $M(x)$ is positive-definite, then $M_{\\theta\\theta}(x)$ is positive-definite and hence invertible, guaranteeing functional independence of the $k$ components $J_{i}$.\n\nThis independence condition is crucial in Routh reduction: when $M_{\\theta\\theta}(x)$ is invertible, one can solve the implicit relation\n$$\nJ(x,\\dot{x},\\dot{\\theta}) \\;=\\; \\mu \\in \\mathbb{R}^{k}\n$$\nfor $\\dot{\\theta}$ in terms of $(x,\\dot{x},\\mu)$, thereby eliminating the cyclic velocities and constructing the reduced Routhian on $TX$ parametrized by the fixed momentum $\\mu$.\n\nThe requested matrix expression for the momentum map is thus the $k$-vector\n$$\nJ(x,\\dot{x},\\dot{\\theta}) \\;=\\; M_{\\theta x}(x)\\,\\dot{x} \\;+\\; M_{\\theta\\theta}(x)\\,\\dot{\\theta} \\;+\\; c(x).\n$$",
            "answer": "$$\\boxed{J(x,\\dot{x},\\dot{\\theta}) \\;=\\; M_{\\theta x}(x)\\,\\dot{x} \\;+\\; M_{\\theta\\theta}(x)\\,\\dot{\\theta} \\;+\\; c(x)}$$"
        },
        {
            "introduction": "Building on the fundamentals, we now tackle a more sophisticated scenario involving non-Abelian symmetries, which are ubiquitous in physics and engineering. This practice explores the dynamics of the heavy top, a classic and rich example in geometric mechanics, through the lens of semidirect product reduction . You will compute the conserved quantity corresponding to the system's rotational symmetry, discovering the elegant connection between the body-fixed angular momentum $\\Pi = \\mathbb{I}\\Omega$ and the body-fixed representation of the vertical axis $\\Gamma$.",
            "id": "3765899",
            "problem": "Consider the heavy top with configuration described by the Special Orthogonal Group $\\mathrm{SO}(3)$, orientation $R \\in \\mathrm{SO}(3)$, body angular velocity $\\Omega \\in \\mathbb{R}^{3}$ defined by $\\widehat{\\Omega} = R^{-1} \\dot{R}$, and advected parameter $\\Gamma \\in \\mathbb{R}^{3}$ given by $\\Gamma = R^{\\top} e_{3}$, where $e_{3} \\in \\mathbb{R}^{3}$ is the unit vector along the vertical (space-fixed) axis. The map $\\,\\widehat{\\cdot}\\, : \\mathbb{R}^{3} \\to \\mathfrak{so}(3)$ is the canonical isomorphism satisfying $\\widehat{u} v = u \\times v$ for all $u, v \\in \\mathbb{R}^{3}$. The reduced heavy top Lagrangian is\n$$\n\\ell(\\Omega, \\Gamma) = \\tfrac{1}{2}\\, \\Omega \\cdot \\mathbb{I} \\Omega \\;-\\; m g\\, \\chi \\cdot \\Gamma,\n$$\nwhere $\\mathbb{I}$ is the inertia tensor (a symmetric, positive-definite linear map on $\\mathbb{R}^{3}$), $m$ is the mass, $g$ is the gravitational acceleration, and $\\chi \\in \\mathbb{R}^{3}$ is the vector from the fixed point to the center of mass expressed in body coordinates. The kinematic constraint for the advected parameter is $\\dot{\\Gamma} = -\\,\\Omega \\times \\Gamma$.\n\nThe symmetry group acting on the configuration is the subgroup $\\mathrm{SO}(2) \\subset \\mathrm{SO}(3)$ of rotations about the space-fixed vertical axis $e_{3}$. This subgroup acts by left multiplication on $R$, namely $h \\cdot R = h R$ for $h \\in \\mathrm{SO}(2)$, and leaves $\\Gamma$ invariant, i.e., $h \\cdot \\Gamma = \\Gamma$. The action lifts to the tangent bundle by $h \\cdot (R, \\dot{R}) = (h R, h \\dot{R})$.\n\nStarting from these definitions and the heavy top Lagrangian above, and using the standard principles of Noether’s theorem for systems with symmetry and semidirect product reduction, do the following:\n\n1. Compute the infinitesimal generator (fundamental vector field) on $(R, \\Gamma)$ associated with the one-parameter subgroup $h(s) = \\exp\\!\\big(s\\,\\widehat{e_{3}}\\big)$ of $\\mathrm{SO}(2)$.\n2. Compute the corresponding conserved quantity (momentum map value) associated with this $\\mathrm{SO}(2)$ symmetry, expressed purely in terms of $\\Omega$, $\\Gamma$, and $\\mathbb{I}$.\n\nYour final answer must contain both the infinitesimal generator and the conserved quantity. Express the final answer as a row matrix in the order: first entry equals the infinitesimal generator on $(R, \\Gamma)$, second entry equals the conserved quantity. No numerical evaluation is required, and no rounding is needed. No physical units should appear in the final answer. Use radians for any angular descriptions.",
            "solution": "The problem statement is valid. It is a well-posed problem in geometric mechanics, grounded in the standard theory of the heavy top and semidirect product reduction. The definitions, constraints, and requested computations are scientifically sound, complete, and consistently formulated. We will proceed with the solution.\n\nThe problem asks for two quantities: the infinitesimal generator of the specified $\\mathrm{SO}(2)$ symmetry action and the corresponding conserved quantity derived from Noether's theorem.\n\n**1. Infinitesimal Generator**\n\nThe configuration of the system is described by the pair $(R, \\Gamma) \\in \\mathrm{SO}(3) \\times \\mathbb{R}^3$. The symmetry group is $G = \\mathrm{SO}(2)$, identified as the subgroup of rotations in $\\mathrm{SO}(3)$ about the space-fixed vertical axis $e_3$. The one-parameter subgroup corresponding to this symmetry is given by $h(s) = \\exp(s\\,\\widehat{e_3})$, where $\\widehat{e_3}$ is the element of the Lie algebra $\\mathfrak{so}(3)$ corresponding to $e_3 \\in \\mathbb{R}^3$.\n\nThe action of an element $h \\in \\mathrm{SO}(2)$ on a point $(R, \\Gamma)$ is defined as:\n- Action on $R$: $h \\cdot R = hR$ (left multiplication).\n- Action on $\\Gamma$: $h \\cdot \\Gamma = \\Gamma$ (the identity action).\n\nThe infinitesimal generator of the action, associated with the Lie algebra element $\\xi = \\widehat{e_3} \\in \\mathfrak{so}(3)$, is a vector field on the manifold $\\mathrm{SO}(3) \\times \\mathbb{R}^3$. This vector field at a point $(R, \\Gamma)$ is found by differentiating the action of the one-parameter subgroup $h(s) = \\exp(s\\xi)$ at $s=0$.\n\nThe component of the generator on $\\mathrm{SO}(3)$ at the point $R$ is:\n$$ \\xi_{\\mathrm{SO}(3)}(R) = \\left. \\frac{d}{ds} \\right|_{s=0} (h(s) \\cdot R) = \\left. \\frac{d}{ds} \\right|_{s=0} (\\exp(s\\widehat{e_3}) R) $$\nUsing the product rule for differentiation, we get:\n$$ \\xi_{\\mathrm{SO}(3)}(R) = \\left( \\left. \\frac{d}{ds} \\right|_{s=0} \\exp(s\\widehat{e_3}) \\right) R = \\widehat{e_3} R $$\nThis is a tangent vector in $T_R\\mathrm{SO}(3)$, the tangent space to $\\mathrm{SO}(3)$ at $R$.\n\nThe component of the generator on $\\mathbb{R}^3$ at the point $\\Gamma$ is:\n$$ \\xi_{\\mathbb{R}^3}(\\Gamma) = \\left. \\frac{d}{ds} \\right|_{s=0} (h(s) \\cdot \\Gamma) = \\left. \\frac{d}{ds} \\right|_{s=0} (\\Gamma) = 0 $$\nThe generator is the zero vector field on $\\mathbb{R}^3$ because the action on $\\Gamma$ is trivial.\n\nCombining these, the infinitesimal generator on the product space $\\mathrm{SO}(3) \\times \\mathbb{R}^3$ at the point $(R, \\Gamma)$ is the pair $(\\widehat{e_3} R, 0)$.\n\n**2. Conserved Quantity (Momentum Map)**\n\nThe invariance of the heavy top Lagrangian under the left action of $\\mathrm{SO}(2)$ on $\\mathrm{SO}(3)$ guarantees the existence of a conserved quantity by Noether's theorem. This quantity is the value of the momentum map associated with the symmetry.\n\nThe Lagrangian on the full tangent bundle $T\\mathrm{SO}(3)$ is given by $L(R, \\dot{R}) = \\ell(\\Omega, \\Gamma)$, where $\\Omega$ and $\\Gamma$ are functions of $(R, \\dot{R})$:\n$$ L(R, \\dot{R}) = \\frac{1}{2} (\\text{unhat}(R^{-1}\\dot{R})) \\cdot \\mathbb{I} (\\text{unhat}(R^{-1}\\dot{R})) - m g\\, \\chi \\cdot (R^{\\top} e_3) $$\nThe conserved quantity associated with a Lie algebra element $\\xi$ is given by the pairing of the conjugate momentum with the infinitesimal generator of the action on the configuration space: $J_{\\xi} = \\langle \\frac{\\partial L}{\\partial \\dot{R}}, \\xi_{\\mathrm{SO}(3)}(R) \\rangle$.\n\nIt is often more convenient to work with body-fixed quantities. The momentum map for a left-invariant system on a Lie group can be expressed as the pairing of the momentum in the body frame, $\\Pi = \\frac{\\partial \\ell}{\\partial \\Omega}$, with the body representation of the symmetry generator.\n\nFirst, we compute the body momentum $\\Pi \\in \\mathbb{R}^3$ from the reduced Lagrangian $\\ell(\\Omega, \\Gamma) = \\frac{1}{2} \\Omega \\cdot \\mathbb{I} \\Omega - m g\\, \\chi \\cdot \\Gamma$. The conjugate momentum to the body angular velocity $\\Omega$ is:\n$$ \\Pi = \\frac{\\partial \\ell}{\\partial \\Omega} = \\mathbb{I} \\Omega $$\nThis is the angular momentum vector expressed in the body-fixed frame.\n\nNext, we find the representation of the symmetry generator in the body frame. The symmetry corresponds to rotations about the space-fixed axis $e_3$. The vector $e_3$ is represented in the body frame by the transformation $R^{-1}e_3$. Since $R \\in \\mathrm{SO}(3)$, its inverse is its transpose, $R^{-1} = R^{\\top}$. So, the body representation of the symmetry axis is $R^{\\top}e_3$.\nFrom the problem statement, we are given the advected parameter $\\Gamma = R^{\\top}e_3$. Thus, $\\Gamma$ is precisely the representation of the space-fixed vertical axis in the body frame.\n\nThe conserved quantity is the dot product of the body angular momentum $\\Pi$ and the body representation of the symmetry axis $\\Gamma$:\n$$ p_3 = \\Pi \\cdot \\Gamma = (\\mathbb{I}\\Omega) \\cdot \\Gamma $$\n\nThis result can be confirmed by considering the spatial angular momentum. The spatial angular momentum vector is $\\pi = R\\Pi = R\\mathbb{I}\\Omega$. The symmetry is with respect to rotations about the fixed spatial axis $e_3$. The conserved quantity is the component of the spatial angular momentum along this axis:\n$$ \\pi \\cdot e_3 = (R\\mathbb{I}\\Omega) \\cdot e_3 $$\nUsing the property of the dot product under orthogonal transformations, $\\langle u, v \\rangle = \\langle R^{\\top}u, R^{\\top}v \\rangle$, we can write this as:\n$$ (R\\mathbb{I}\\Omega) \\cdot e_3 = \\langle R\\mathbb{I}\\Omega, e_3 \\rangle = \\langle \\mathbb{I}\\Omega, R^{\\top}e_3 \\rangle = (\\mathbb{I}\\Omega) \\cdot (R^{\\top}e_3) $$\nSubstituting $\\Gamma = R^{\\top}e_3$, we recover the same result:\n$$ p_3 = (\\mathbb{I}\\Omega) \\cdot \\Gamma $$\nThis quantity represents the conserved vertical component of the total angular momentum.\n\nThe two requested quantities are the infinitesimal generator $(\\widehat{e_3} R, 0)$ and the conserved quantity $(\\mathbb{I}\\Omega) \\cdot \\Gamma$.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} (\\widehat{e_3} R, 0) & (\\mathbb{I}\\Omega) \\cdot \\Gamma \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "This final practice bridges the gap between continuous theory and computational science, a crucial skill in modern research. The principles of symmetry and momentum map conservation are not just theoretical constructs; they are the foundation for designing `variational integrators`, which are powerful numerical methods that preserve the geometric structure of a system. In this hands-on coding exercise , you will implement an integrator for the Kepler problem and empirically verify the remarkable property that the discrete analogue of the momentum map is exactly conserved, providing a tangible demonstration of the power of geometric mechanics.",
            "id": "3770966",
            "problem": "You are to implement a self-contained program that constructs a variational integrator for the planar Kepler problem, and then quantitatively evaluates long-time preservation of angular momentum and near-conservation of energy for several test cases. The mathematical and algorithmic development must start from the principle of stationary action and the discrete variational principle, without relying on any pre-packaged formulas or hidden shortcuts.\n\nConsider a unit-mass particle moving in the plane under an inverse-square central potential with gravitational parameter $\\mu > 0$. Let the configuration be $q(t) \\in \\mathbb{R}^2 \\setminus \\{0\\}$, velocity $\\dot{q}(t)$, and Euclidean norm $\\| \\cdot \\|$. The continuous Lagrangian is $L(q,\\dot{q}) = T(\\dot{q}) - U(q)$ with kinetic energy $T(\\dot{q}) = \\frac{1}{2} \\|\\dot{q}\\|^2$ and potential energy $U(q) = - \\frac{\\mu}{\\|q\\|}$. The continuous Euler–Lagrange equations imply $m \\ddot{q} = - \\nabla U(q)$ for unit mass $m=1$.\n\nA variational integrator is obtained by discretizing the action integral. On a uniform time grid $t_k = k h$ with time step $h > 0$, define the discrete Lagrangian $L_d(q_k, q_{k+1}; h)$ by approximating the integral $\\int_{t_k}^{t_{k+1}} L(q,\\dot{q}) \\, dt$ over the interval $[t_k,t_{k+1}]$ using a consistent, rotation-invariant quadrature. For separable $L(q,\\dot{q})$, use the trapezoidal rule in the potential and treat the velocity over the interval as constant, yielding a discrete Lagrangian that depends only on $q_k$, $q_{k+1}$, and $h$. The discrete Euler–Lagrange equations are obtained by requiring stationarity of the discrete action sum $\\sum_k L_d(q_k,q_{k+1};h)$ with respect to variations of $q_k$, leading to a second-order update for the positions. Because the discrete Lagrangian is invariant under rotations, by the discrete version of Noether’s theorem the discrete momentum map associated to the rotational symmetry of the Special Orthogonal group ($\\mathrm{SO}(2)$) is exactly preserved.\n\nYour tasks:\n\n1. Derive from first principles the explicit position update rule implied by the discrete Euler–Lagrange equations for the discrete Lagrangian defined above. Then, implement the resulting variational integrator in your program. Use only quantities available at the current and previous time steps; no continuous-time formulas may be assumed beyond the definitions of $L(q,\\dot{q})$, $T(\\dot{q})$, and $U(q)$.\n\n2. The Störmer-Verlet integrator is known to exactly conserve a discrete analogue of angular momentum for central force problems. Implement the computation of this quantity's sequence $\\{J_k\\}_{k \\ge 1}$ defined by $J_k = (q_k)_x (v_{k-1/2})_y - (q_k)_y (v_{k-1/2})_x$, where $v_{k-1/2} = (q_k - q_{k-1})/h$ is the velocity at the half-step. Measure long-time preservation by computing the maximum absolute deviation $\\max_k |J_k - J_{cont}|$, where $J_{cont} = (q_0)_x (\\dot{q}_0)_y - (q_0)_y (\\dot{q}_0)_x$ is the exact continuous angular momentum of the initial state.\n\n3. To assess near-conservation of energy, define the continuous mechanical energy $E(q,\\dot{q}) = \\frac{1}{2}\\|\\dot{q}\\|^2 + U(q)$ and approximate $\\dot{q}(t_k)$ at nodes by the centered difference $\\frac{q_{k+1} - q_{k-1}}{2h}$. Compute the sequence $\\{E_k\\}$ over the simulation and report the maximum absolute deviation $\\max_k |E_k - E_0|$ as well as the average per-step drift $(E_N - E_0)/N$, where $N$ is the total number of steps.\n\n4. Initialize the integrator for each test case by specifying $q_0$ and $\\dot{q}_0$ at $t_0$, then obtain $q_1$ via a single step consistent with your variational update derived in Task 1.\n\n5. Implement the following test suite. All quantities are dimensionless. For each test case, simulate for $N$ steps of size $h$ and output three metrics per case, in the order: maximum absolute angular momentum deviation, maximum absolute energy deviation, and average energy drift per step (a float that may be negative). Use the gravitational parameter $\\mu = 1$ in all cases.\n   - Test Case 1 (happy path circular orbit): radius $r_0 = 1$, initial position $q_0 = (r_0, 0)$, initial velocity $\\dot{q}_0 = (0, \\sqrt{\\mu/r_0})$, step size $h = 0.01$, number of steps $N = 20000$.\n   - Test Case 2 (moderate eccentric ellipse): semi-major axis $a = 1$, eccentricity $e = 0.6$, pericenter radius $r_p = a(1-e)$, initial position $q_0 = (r_p, 0)$, pericenter speed $\\dot{q}_0 = (0, \\sqrt{\\mu(1+e)/(a(1-e))})$, step size $h = 0.02$, number of steps $N = 20000$.\n   - Test Case 3 (high eccentric ellipse, smaller step): semi-major axis $a = 1$, eccentricity $e = 0.9$, pericenter radius $r_p = a(1-e)$, initial position $q_0 = (r_p, 0)$, pericenter speed $\\dot{q}_0 = (0, \\sqrt{\\mu(1+e)/(a(1-e))})$, step size $h = 0.005$, number of steps $N = 20000$.\n\n6. Final output format: Your program should produce a single line of output containing the results as a comma-separated list of lists, one per test case, each list containing three floats in the order specified above. For example, a line of the form $\\texttt{[[ang\\_err1,energy\\_err1,drift1],[ang\\_err2,energy\\_err2,drift2],[ang\\_err3,energy\\_err3,drift3]]}$.\n\nThe implementation must be entirely self-contained and runnable without user input. No external data files or network access are permitted. Angles, if any arise in your internal computations, must be in radians. No physical units are required; treat all quantities as non-dimensional. The program must adhere to the specified execution environment and library constraints.",
            "solution": "The problem of constructing a variational integrator for the planar Kepler problem and evaluating its conservation properties is valid and well-posed. It is grounded in the established principles of Lagrangian mechanics, geometric integration, and numerical analysis. All necessary constants, initial conditions, and evaluation metrics are specified, forming a self-contained and solvable problem.\n\nThe solution proceeds by first deriving the discrete equations of motion from the specified discrete Lagrangian, then implementing the resulting algorithm, and finally evaluating its performance on the provided test cases.\n\n### Step 1: Derivation of the Variational Integrator\n\nThe problem begins with the continuous Lagrangian for a unit-mass particle ($m=1$) in a central potential $U(q) = -\\frac{\\mu}{\\|q\\|}$:\n$$\nL(q, \\dot{q}) = T(\\dot{q}) - U(q) = \\frac{1}{2}\\|\\dot{q}\\|^2 + \\frac{\\mu}{\\|q\\|}\n$$\nA variational integrator is constructed by discretizing the action integral $S = \\int L(q, \\dot{q}) \\, dt$. The discrete action is a sum $S_d = \\sum_k L_d(q_k, q_{k+1}; h)$, where $L_d$ is the discrete Lagrangian approximating the action over a single time step $h$.\n\nThe discrete Lagrangian $L_d(q_k, q_{k+1}; h)$ is defined by approximating the integral $\\int_{t_k}^{t_{k+1}} L(q(t), \\dot{q}(t)) \\, dt$. We use the specified quadrature rules:\n1.  The kinetic energy term is approximated by assuming a constant velocity $\\dot{q}(t) \\approx \\frac{q_{k+1} - q_k}{h}$ over the interval $[t_k, t_{k+1}]$.\n    $$\n    \\int_{t_k}^{t_{k+1}} T(\\dot{q}) \\, dt \\approx \\int_{t_k}^{t_{k+1}} \\frac{1}{2} \\left\\| \\frac{q_{k+1} - q_k}{h} \\right\\|^2 \\, dt = h \\cdot \\frac{1}{2h^2} \\|q_{k+1} - q_k\\|^2 = \\frac{1}{2h} \\|q_{k+1} - q_k\\|^2\n    $$\n2.  The potential energy term is approximated by applying the trapezoidal rule to $-U(q)$.\n    $$\n    \\int_{t_k}^{t_{k+1}} (-U(q(t))) \\, dt \\approx \\frac{h}{2} (-U(q_k) - U(q_{k+1})) = \\frac{h \\mu}{2} \\left( \\frac{1}{\\|q_k\\|} + \\frac{1}{\\|q_{k+1}\\|} \\right)\n    $$\nCombining these gives the discrete Lagrangian:\n$$\nL_d(q_k, q_{k+1}; h) = \\frac{\\|q_{k+1} - q_k\\|^2}{2h} + \\frac{h \\mu}{2} \\left( \\frac{1}{\\|q_k\\|} + \\frac{1}{\\|q_{k+1}\\|} \\right)\n$$\nThe discrete Euler-Lagrange (DEL) equations are derived from the principle of stationary action, $\\delta S_d = 0$. For an interior point $q_k$, this yields:\n$$\nD_2 L_d(q_{k-1}, q_k; h) + D_1 L_d(q_k, q_{k+1}; h) = 0\n$$\nwhere $D_1$ and $D_2$ denote the partial derivatives (gradients) with respect to the first and second vector arguments of $L_d$. We compute these derivatives. We use the fact that $\\nabla_q \\frac{1}{\\|q\\|} = -\\frac{q}{\\|q\\|^3}$, so $\\nabla_q U(q) = \\nabla_q(-\\frac{\\mu}{\\|q\\|}) = \\frac{\\mu q}{\\|q\\|^3}$.\n$$\nD_1 L_d(q_k, q_{k+1}; h) = \\frac{\\partial L_d}{\\partial q_k} = \\frac{-(q_{k+1} - q_k)}{h} + \\frac{h \\mu}{2} \\left(-\\frac{q_k}{\\|q_k\\|^3}\\right) = \\frac{q_k - q_{k+1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\n$$\nD_2 L_d(q_{k-1}, q_k; h) = \\frac{\\partial L_d}{\\partial q_k} = \\frac{q_k - q_{k-1}}{h} + \\frac{h \\mu}{2} \\left(-\\frac{q_k}{\\|q_k\\|^3}\\right) = \\frac{q_k - q_{k-1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\nSubstituting these into the DEL equation:\n$$\n\\left( \\frac{q_k - q_{k-1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3} \\right) + \\left( \\frac{q_k - q_{k+1}}{h} - \\frac{h}{2} \\frac{\\mu q_k}{\\|q_k\\|^3} \\right) = 0\n$$\n$$\n\\frac{2q_k - q_{k-1} - q_{k+1}}{h} - h \\frac{\\mu q_k}{\\|q_k\\|^3} = 0\n$$\nSolving for $q_{k+1}$ gives the explicit position update rule, which is the Störmer-Verlet method:\n$$\nq_{k+1} = 2q_k - q_{k-1} - h^2 \\frac{\\mu q_k}{\\|q_k\\|^3}\n$$\nThis update rule requires two previous positions, $q_k$ and $q_{k-1}$. For initialization, we are given $q_0$ and $\\dot{q}_0$. We must find $q_1$ in a manner consistent with the integrator. This is achieved by a \"half-step kick, full-step drift\" scheme, equivalent to a second-order Taylor expansion:\n$$\nq_1 = q_0 + h\\dot{q}_0 + \\frac{h^2}{2}\\ddot{q}_0\n$$\nFrom the continuous equation of motion, $\\ddot{q}_0 = -\\nabla U(q_0) = -\\frac{\\mu q_0}{\\|q_0\\|^3}$. Thus, the first step is:\n$$\nq_1 = q_0 + h\\dot{q}_0 - \\frac{h^2 \\mu}{2} \\frac{q_0}{\\|q_0\\|^3}\n$$\nWith $q_0$ and $q_1$, the simulation can proceed for all subsequent steps using the main update rule.\n\n### Step 2: Angular Momentum Conservation\n\nThe rotational invariance of the discrete Lagrangian guarantees the existence of a conserved discrete momentum map via the discrete Noether's theorem. For the Störmer-Verlet method applied to a central force $F(q_k) = f(\\|q_k\\|)q_k$, this conserved quantity is the angular momentum defined by $J_k = q_k \\times v_{k-1/2}$, where $v_{k-1/2} = (q_k - q_{k-1})/h$.\n\nWe can prove this conservation directly from the update rule.\n$$\nJ_{k+1} - J_k = q_{k+1} \\times v_{k+1/2} - q_k \\times v_{k-1/2}\n$$\nUsing the definitions $v_{k+1/2} = (q_{k+1}-q_k)/h$ and $v_{k-1/2} = (q_k - q_{k-1})/h$, we can write $q_{k+1} = q_k + h v_{k+1/2}$. Substituting this into the first term:\n$$\nJ_{k+1} = (q_k + h v_{k+1/2}) \\times v_{k+1/2} = q_k \\times v_{k+1/2} + h(v_{k+1/2} \\times v_{k+1/2}) = q_k \\times v_{k+1/2}\n$$\nTherefore, the change in angular momentum is:\n$$\nJ_{k+1} - J_k = q_k \\times v_{k+1/2} - q_k \\times v_{k-1/2} = q_k \\times (v_{k+1/2} - v_{k-1/2})\n$$\nThe Verlet update rule is equivalent to $v_{k+1/2} - v_{k-1/2} = h F(q_k)$, where $F(q_k) = -\\frac{\\mu q_k}{\\|q_k\\|^3}$.\n$$\nJ_{k+1} - J_k = q_k \\times (h F(q_k)) = h (q_k \\times (-\\frac{\\mu q_k}{\\|q_k\\|^3})) = 0\n$$\nSince $q_k$ is parallel to itself, the cross product is zero. This proves that $J_k$ is exactly conserved for all $k \\ge 1$. We will compute the sequence $\\{J_k\\}_{k=1}^N$ and compare it to the continuous value $J_{cont} = q_0 \\times \\dot{q}_0$. The deviation is expected to be on the order of machine epsilon.\n\n### Step 3: Near-Conservation of Energy\n\nThe integrator does not exactly conserve the continuous energy. We assess its near-conservation by calculating an approximation to the energy at each node. The continuous energy is $E(q,\\dot{q}) = \\frac{1}{2}\\|\\dot{q}\\|^2 - \\frac{\\mu}{\\|q\\|}$.\nThe velocity $\\dot{q}_k$ is approximated using a second-order centered difference:\n$$\n\\dot{q}_k \\approx \\frac{q_{k+1} - q_{k-1}}{2h}\n$$\nThis allows us to compute an energy sequence $\\{E_k\\}$ for $k=1, \\dots, N$. The reference energy $E_0$ is computed using the given initial conditions:\n$$\nE_0 = E(q_0, \\dot{q}_0) = \\frac{1}{2}\\|\\dot{q}_0\\|^2 - \\frac{\\mu}{\\|q_0\\|}\n$$\nFor $k=1, \\dots, N$, the energy is:\n$$\nE_k = \\frac{1}{2} \\left\\| \\frac{q_{k+1} - q_{k-1}}{2h} \\right\\|^2 - \\frac{\\mu}{\\|q_k\\|}\n$$\nNote that computing $E_N$ requires $q_{N+1}$, so the simulation must be run for one extra step. The metrics for energy are the maximum absolute deviation $\\max_k |E_k - E_0|$ and the average drift per step $(E_N - E_0)/N$. For a symmetric integrator like Verlet, the energy error is expected to be bounded (oscillatory) rather than growing linearly, resulting in a very small average drift over long times.\n\n### Step 4: Algorithm Implementation\n\nThe program will implement the derived formulas for a series of test cases. For each case:\n1.  Initialize parameters ($\\mu=1$, $q_0$, $\\dot{q}_0$, $h$, $N$).\n2.  Allocate an array to store positions $q_0, \\dots, q_{N+1}$.\n3.  Compute $q_1$ using the special initialization formula.\n4.  Iterate from $k=1$ to $N$ to compute $q_{k+1}$ using the Störmer-Verlet update rule.\n5.  Compute the discrete angular momentum sequence $J_1, \\dots, J_{N+1}$ and find the maximum absolute deviation from the continuous initial value $J_{cont}$.\n6.  Compute the approximate energy sequence $E_0, \\dots, E_N$ and find the maximum absolute deviation and average drift.\n7.  Store and format the three resulting metrics.\n\nThis systematic procedure, rooted in first principles, ensures a correct and robust implementation.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Constructs and evaluates a variational integrator for the planar Kepler problem.\n    \"\"\"\n    \n    # Gravitational parameter\n    mu = 1.0\n\n    # Define the test cases from the problem statement.\n    # Each case: (initial position q0, initial velocity q0_dot, time step h, number of steps N)\n    a_2, e_2 = 1.0, 0.6\n    rp_2 = a_2 * (1.0 - e_2)\n    vp_2 = np.sqrt(mu * (1.0 + e_2) / (a_2 * (1.0 - e_2)))\n    \n    a_3, e_3 = 1.0, 0.9\n    rp_3 = a_3 * (1.0 - e_3)\n    vp_3 = np.sqrt(mu * (1.0 + e_3) / (a_3 * (1.0 - e_3)))\n\n    test_cases = [\n        (np.array([1.0, 0.0]), np.array([0.0, np.sqrt(mu/1.0)]), 0.01, 20000),\n        (np.array([rp_2, 0.0]), np.array([0.0, vp_2]), 0.02, 20000),\n        (np.array([rp_3, 0.0]), np.array([0.0, vp_3]), 0.005, 20000),\n    ]\n\n    all_results = []\n    \n    for q0, q0_dot, h, N in test_cases:\n        \n        # --- Simulation ---\n        # We need N+2 points (q_0, ..., q_{N+1}) to compute energy at E_N.\n        q_history = np.zeros((N + 2, 2))\n        q_history[0] = q0\n        \n        # Task 1/4: Initialization of q1\n        # q1 = q0 + h*q0_dot + (h^2/2)*ddot(q0)\n        # ddot(q0) = -mu * q0 / ||q0||^3\n        norm_q0 = np.linalg.norm(q0)\n        q0_ddot = -mu * q0 / (norm_q0**3)\n        q1 = q0 + h * q0_dot + 0.5 * h**2 * q0_ddot\n        q_history[1] = q1\n        \n        # Main integration loop (Störmer-Verlet)\n        # q_{k+1} = 2*q_k - q_{k-1} - h^2 * mu * q_k / ||q_k||^3\n        for k in range(1, N + 1):\n            q_k = q_history[k]\n            q_k_minus_1 = q_history[k-1]\n            norm_qk = np.linalg.norm(q_k)\n            force_term = -h**2 * mu * q_k / (norm_qk**3)\n            q_k_plus_1 = 2 * q_k - q_k_minus_1 + force_term\n            q_history[k+1] = q_k_plus_1\n            \n        # --- Analysis ---\n        \n        # Task 2: Angular Momentum Preservation\n        # J_k = q_k_x * v_{k-1/2}_y - q_k_y * v_{k-1/2}_x\n        # v_{k-1/2} = (q_k - q_{k-1})/h\n        # Sequence is J_1, ..., J_{N+1}\n        # Reference continuous angular momentum\n        j_cont = q0[0] * q0_dot[1] - q0[1] * q0_dot[0]\n        \n        # We compute J_k for k from 1 to N+1\n        j_history = np.zeros(N + 1)\n        for k in range(1, N + 2):\n            q_k = q_history[k]\n            q_k_minus_1 = q_history[k-1]\n            \n            v_k_half = (q_k - q_k_minus_1) / h\n            \n            j_k = q_k[0] * v_k_half[1] - q_k[1] * v_k_half[0]\n            j_history[k-1] = j_k # Store in array of size N+1\n        \n        max_ang_mom_dev = np.max(np.abs(j_history - j_cont))\n        \n        # Task 3: Energy Near-Conservation\n        # E_k = 0.5 * ||(q_{k+1}-q_{k-1})/(2h)||^2 - mu/||q_k||\n        # E_0 is computed from initial conditions\n        e_history = np.zeros(N + 1)\n        \n        # E_0 from exact initial velocity\n        e0 = 0.5 * np.dot(q0_dot, q0_dot) - mu / np.linalg.norm(q0)\n        e_history[0] = e0\n        \n        # E_k for k=1..N using centered difference for velocity\n        for k in range(1, N + 1):\n            q_k_plus_1 = q_history[k+1]\n            q_k_minus_1 = q_history[k-1]\n            q_k = q_history[k]\n            \n            q_k_dot_approx = (q_k_plus_1 - q_k_minus_1) / (2.0 * h)\n            \n            kinetic_energy = 0.5 * np.dot(q_k_dot_approx, q_k_dot_approx)\n            potential_energy = -mu / np.linalg.norm(q_k)\n            e_k = kinetic_energy + potential_energy\n            e_history[k] = e_k\n            \n        e_n = e_history[N]\n        max_energy_dev = np.max(np.abs(e_history - e0))\n        avg_energy_drift = (e_n - e0) / N\n        \n        all_results.append([max_ang_mom_dev, max_energy_dev, avg_energy_drift])\n\n    # Final print statement in the exact required format.\n    case_strings = []\n    for case_result in all_results:\n        case_strings.append(f\"[{case_result[0]},{case_result[1]},{case_result[2]}]\")\n    print(f\"[{','.join(case_strings)}]\")\n\nsolve()\n```"
        }
    ]
}