{
    "hands_on_practices": [
        {
            "introduction": "This first exercise grounds the abstract theory of the Camassa-Holm equation in a concrete calculation. By substituting a single-peakon ansatz into the Euler-Poincaré form of the equation, you will use distributional calculus to derive its equations of motion. This practice reveals the celebrated result that a peakon's speed is equal to its amplitude, a foundational property of these remarkable non-smooth solutions .",
            "id": "3773822",
            "problem": "Consider the Camassa–Holm equation for a scalar velocity field $u(x,t)$ on the real line, with linear dispersion parameter $\\kappa \\in \\mathbb{R}$,\n$$\nu_t - u_{xxt} + \\kappa\\,u_x + 3\\,u\\,u_x \\;=\\; 2\\,u_x\\,u_{xx} + u\\,u_{xxx}.\n$$\nIntroduce the Helmholtz momentum $m(x,t)$ by the definition $m = u - u_{xx}$, so that $u = K * m$, where $K(x)$ is the Green's function for the Helmholtz operator $1 - \\partial_x^2$, namely $K(x) = \\tfrac{1}{2}\\,e^{-|x|}$. In the geometric mechanics formulation, the Camassa–Holm equation is the Euler–Poincaré (EP) equation\n$$\nm_t + u\\,m_x + 2\\,u_x\\,m = -\\,\\kappa\\,u_x,\n$$\nwith $m = u - u_{xx}$ and $u = K * m$ as above. Consider a single-peakon ansatz in the momentum variable given by a moving Dirac delta distribution: $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$, with time-dependent amplitude $p(t)$ and position $q(t)$. Using only the stated base, namely the momentum definition $m = u - u_{xx}$, the convolution $u = K * m$, and the Euler–Poincaré form of the Camassa–Holm equation, perform the following reasoning:\n\n- Derive the ordinary differential equations for $p(t)$ and $q(t)$ that arise from substituting the single-peakon ansatz into the Euler–Poincaré equation in the sense of distributions, for the case $\\kappa = 0$.\n- Explain, from this derivation, why the peakon travels at a speed equal to its amplitude when $\\kappa = 0$.\n- Verify this relation by direct substitution into the governing equation, in the sense of distributions, for the velocity field $u(x,t) = p(t)\\,e^{-\\big|x - q(t)\\big|}$ corresponding to the Green's function convolution $u = K * m$.\n\nWhich one of the following statements is correct?\n\nA. For $\\kappa = 0$, substituting $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$ into $m_t + u\\,m_x + 2\\,u_x\\,m = 0$ and using $u = K * m$ with $K(x) = \\tfrac{1}{2}\\,e^{-|x|}$ yields the distributional identities $q'(t) = p(t)$ and $p'(t) = 0$. Consequently, the peakon speed equals its amplitude, and direct substitution of $u(x,t) = p(t)\\,e^{-\\big|x - q(t)\\big|}$, with $q'(t) = p(t)$ and $p'(t) = 0$, satisfies the equation in the sense of distributions.\n\nB. For $\\kappa = 0$, the factor $2$ in $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$ implies that the speed is twice the amplitude, so the correct relation is $q'(t) = 2\\,p(t)$ and $p'(t) = 0$. Direct substitution confirms this stronger speed-amplitude proportionality.\n\nC. For $\\kappa = 0$, nonlinearity induces amplitude decay according to $p'(t) = -3\\,p(t)^2$, while the speed initially equals the amplitude, $q'(0) = p(0)$, but deviates over time. Direct substitution reveals a secular drift invalidating constant speed-amplitude equality.\n\nD. For $\\kappa = 0$, the peakon ansatz fails because $u$ is non-differentiable at $x = q(t)$, so neither the momentum equation nor the velocity formulation can be satisfied in the sense of distributions. Hence, speed cannot equal amplitude, and direct substitution produces contradictions.\n\nSelect the single best answer.",
            "solution": "The problem statement is subjected to validation prior to any attempt at a solution.\n\n### Step 1: Extract Givens\n-   The Camassa–Holm (CH) equation for a scalar velocity field $u(x,t)$ is given as:\n    $$u_t - u_{xxt} + \\kappa\\,u_x + 3\\,u\\,u_x \\;=\\; 2\\,u_x\\,u_{xx} + u\\,u_{xxx}$$\n-   The linear dispersion parameter is $\\kappa \\in \\mathbb{R}$.\n-   The Helmholtz momentum is defined as $m(x,t) = u - u_{xx}$.\n-   The velocity $u$ is obtained from the momentum $m$ via convolution with a Green's function $K(x)$: $u = K * m$.\n-   The Green's function for the Helmholtz operator $1 - \\partial_x^2$ is $K(x) = \\tfrac{1}{2}\\,e^{-|x|}$.\n-   The Euler–Poincaré (EP) form of the CH equation is:\n    $$m_t + u\\,m_x + 2\\,u_x\\,m = -\\,\\kappa\\,u_x$$\n-   A single-peakon ansatz for the momentum is given by $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$, where $p(t)$ is the amplitude and $q(t)$ is the position.\n-   The problem specifies the analysis is for the case $\\kappa = 0$.\n-   The tasks are: (1) Derive ODEs for $p(t)$ and $q(t)$ from the EP equation for $\\kappa=0$. (2) Explain why speed equals amplitude. (3) Verify this by direct substitution into the velocity form of the equation.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded**: The problem is grounded in the well-established theory of the Camassa–Holm equation, which is a fundamental model in the study of shallow water waves and has deep connections to geometric mechanics. The provided forms of the equation (both the original and the Euler-Poincaré version), the momentum definition, and the Green's function are all standard and correct.\n2.  **Well-Posed**: The problem is well-posed. It asks for the derivation and verification of a specific type of solution (a peakon), which is a standard procedure in the analysis of integrable systems. The instructions are clear and lead to a definite result.\n3.  **Objective**: The language is entirely mathematical and objective.\n4.  **Complete and Consistent**: All necessary information is provided. The relationship between $u$ and $m$ is clearly defined. The EP equation is a known, valid reformulation of the original CH equation. For $\\kappa=0$, the CH equation $u_t - u_{xxt} + 3uu_x = 2u_x u_{xx} + u u_{xxx}$ is indeed equivalent to the EP form $m_t + u m_x + 2u_x m = 0$, as $m_t + (um)_x + u_x m = m_t + u_x m + u m_x + u_x m = m_t + u m_x + 2u_x m$, and $(um)_x + u_x m = (u(u-u_{xx}))_x + u_x(u-u_{xx}) = (u^2-uu_{xx})_x + u_x u - u_x u_{xx} = 2uu_x - (uu_{xx})_x + u_x u - u_x u_{xx} = 3uu_x - u_x u_{xx} - u u_{xxx} - u_x u_{xx} = 3uu_x - 2u_x u_{xx} - u u_{xxx}$. Thus $m_t + 3uu_x - 2u_x u_{xx} - u u_{xxx} = 0$, which is the original CH equation for $\\kappa=0$. The setup is consistent.\n5.  **No other flaws detected**: The problem does not contain any of the listed invalidating flaws. The use of distributions and non-differentiable functions is a key feature of peakon solutions, and handling them \"in the sense of distributions\" is the correct mathematical approach.\n\n### Step 3: Verdict and Action\nThe problem statement is **valid**. A full solution will be derived.\n\n### Derivation and Solution\n\nThe problem requires a three-part analysis for the case $\\kappa = 0$.\n\n**Part 1: Derive ODEs for $p(t)$ and $q(t)$**\n\nFor $\\kappa=0$, the Euler-Poincaré equation is $m_t + u\\,m_x + 2\\,u_x\\,m = 0$.\nWe first find the velocity field $u(x,t)$ corresponding to the momentum ansatz $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$.\n$$ u(x,t) = (K * m)(x,t) = \\int_{-\\infty}^{\\infty} K(x-y)\\,m(y,t)\\,dy $$\n$$ u(x,t) = \\int_{-\\infty}^{\\infty} \\frac{1}{2}e^{-|x-y|} \\left( 2\\,p(t)\\,\\delta\\big(y - q(t)\\big) \\right) dy = p(t) \\int_{-\\infty}^{\\infty} e^{-|x-y|} \\delta\\big(y - q(t)\\big) dy $$\nUsing the sifting property of the Dirac delta, we find:\n$$ u(x,t) = p(t)\\,e^{-|x - q(t)|} $$\nThis is the velocity field of a single peakon. The peakon's amplitude is $p(t)$, and its position is $q(t)$.\n\nTo find the ODEs for $p(t)$ and $q(t)$, we substitute the ansatz for $m$ and the derived $u$ into the EP equation. Since $m$ is a distribution and $u$ is not smooth, the equation must be interpreted in the weak sense. Let $\\phi(x)$ be an arbitrary smooth test function with compact support. The weak form of the equation is $\\langle m_t + u\\,m_x + 2\\,u_x\\,m, \\phi \\rangle = 0$.\n\nLet's evaluate each term:\n1.  $\\langle m_t, \\phi \\rangle = \\frac{d}{dt}\\langle m, \\phi \\rangle = \\frac{d}{dt} \\int 2p(t)\\delta(x-q(t))\\phi(x)dx = \\frac{d}{dt} [2p(t)\\phi(q(t))]$\n    $= 2p'(t)\\phi(q(t)) + 2p(t)\\phi'(q(t))q'(t)$.\n\n2.  The remaining terms $u m_x + 2 u_x m$ can be rewritten as $(u m)_x + u_x m$. Let's handle them distributionally.\n    $\\langle u m_x + 2 u_x m, \\phi \\rangle = \\langle m, u_x \\phi - u \\phi_x \\rangle = \\int 2p(t)\\delta(x-q(t)) [u_x(x,t)\\phi(x) - u(x,t)\\phi'(x)] dx $\n    $= 2p(t) [u_x(q(t),t)\\phi(q(t)) - u(q(t),t)\\phi'(q(t))]$.\n\nTo evaluate this, we need $u(q,t)$ and $u_x(q,t)$.\n-   $u(q(t),t) = p(t)e^{-|q(t)-q(t)|} = p(t)$.\n-   The derivative of $u$ is $u_x(x,t) = -p(t)\\,\\text{sgn}(x-q(t))\\,e^{-|x-q(t)|}$. This derivative has a jump discontinuity at $x=q(t)$, from $p(t)$ for $x  q(t)$ to $-p(t)$ for $x > q(t)$. In the context of weak solutions for the CH equation, the value at the discontinuity is taken as the average of the limits from left and right:\n    $u_x(q(t),t) := \\frac{1}{2} \\left[ u_x(q^-,t) + u_x(q^+,t) \\right] = \\frac{1}{2} [p(t) + (-p(t))] = 0$.\n\nSubstituting these values:\n$\\langle u m_x + 2 u_x m, \\phi \\rangle = 2p(t)[(0)\\phi(q(t)) - p(t)\\phi'(q(t))] = -2p(t)^2\\phi'(q(t))$.\n\nCombining all terms, the weak form of the EP equation is:\n$2p'(t)\\phi(q(t)) + 2p(t)q'(t)\\phi'(q(t)) - 2p(t)^2\\phi'(q(t)) = 0$.\n$[2p'(t)]\\phi(q(t)) + [2p(t)q'(t) - 2p(t)^2]\\phi'(q(t)) = 0$.\n\nSince this identity must hold for any test function $\\phi$, the coefficients of $\\phi(q(t))$ and $\\phi'(q(t))$ must vanish independently.\n-   From the coefficient of $\\phi(q(t))$: $2p'(t) = 0 \\implies p'(t) = 0$. This means the amplitude $p$ is constant.\n-   From the coefficient of $\\phi'(q(t))$: $2p(t)q'(t) - 2p(t)^2 = 0 \\implies 2p(t)(q'(t) - p(t)) = 0$.\nFor a non-trivial peakon, $p(t) \\neq 0$, so we must have $q'(t) - p(t) = 0 \\implies q'(t) = p(t)$.\n\nThe derived ODEs are $p'(t)=0$ and $q'(t)=p(t)$.\n\n**Part 2: Explain speed-amplitude relation**\n\nThe speed of the peakon is the rate of change of its position, which is $q'(t)$. The amplitude of the velocity profile $u(x,t)$ is $p(t)$. The derived relation $q'(t) = p(t)$ directly states that the speed of the peakon is equal to its amplitude.\n\n**Part 3: Verify by direct substitution**\n\nWe must verify that $u(x,t) = p_0 e^{-|x-q(t)|}$, with $p'(t)=0$ (so $p(t)=p_0$, a constant) and $q'(t) = p_0$, is a solution to the CH equation for $\\kappa=0$, which is $u_t - u_{xxt} + 3uu_x = 2u_x u_{xx} + u u_{xxx}$. This is equivalent to $m_t + 3uu_x = 2u_x u_{xx} + u u_{xxx}$.\n\nLet's compute the terms as distributions. Let $q(t) = p_0 t + q_0$.\n-   $u(x,t) = p_0 e^{-|x-q(t)|}$.\n-   $u_x = -p_0 \\text{sgn}(x-q) e^{-|x-q|}$.\n-   $u_t = \\frac{\\partial}{\\partial t} (p_0 e^{-|x-q(t)|}) = p_0 e^{-|x-q|} (-\\text{sgn}(x-q))(-q'(t)) = p_0 q'(t) \\text{sgn}(x-q) e^{-|x-q|} = -q'(t) u_x = -p_0 u_x$.\n-   $u_{xx} = \\frac{\\partial}{\\partial x} (-p_0 \\text{sgn}(x-q)e^{-|x-q|}) = p_0 \\text{sgn}^2(x-q)e^{-|x-q|} - p_0 (2\\delta(x-q))e^{-|x-q|} = p_0 e^{-|x-q|} - 2p_0 \\delta(x-q) = u - 2p_0 \\delta(x-q)$.\n-   $u_{xxx} = u_x - 2p_0 \\delta'(x-q) = -p_0 \\text{sgn}(x-q)e^{-|x-q|} - 2p_0 \\delta'(x-q)$.\n-   $m = u - u_{xx} = u - (u - 2p_0 \\delta(x-q)) = 2p_0 \\delta(x-q)$.\n-   $m_t = \\frac{\\partial}{\\partial t} (2p_0 \\delta(x-q(t))) = 2p_0 (-q'(t))\\delta'(x-q(t)) = -2p_0^2 \\delta'(x-q)$.\n\nNow we assemble the two sides of the CH equation $m_t + 3uu_x = 2u_x u_{xx} + u u_{xxx}$.\nLeft Hand Side (LHS):\n$LHS = m_t + 3uu_x = -2p_0^2 \\delta'(x-q) + 3(p_0 e^{-|x-q|})(-p_0 \\text{sgn}(x-q)e^{-|x-q|})$\n$LHS = -2p_0^2 \\delta'(x-q) - 3p_0^2 \\text{sgn}(x-q)e^{-2|x-q|}$.\n\nRight Hand Side (RHS): $2u_x u_{xx} + u u_{xxx}$. This involves products of distributions, which must be handled carefully.\n$RHS = 2u_x(u-2p_0\\delta(x-q)) + u(u_x - 2p_0\\delta'(x-q))$\n$RHS = 2uu_x - 4p_0 u_x \\delta(x-q) + uu_x - 2p_0 u \\delta'(x-q)$\n$RHS = 3uu_x - 4p_0 u_x \\delta(x-q) - 2p_0 u \\delta'(x-q)$\nWe use standard rules for products of smooth functions and distributions:\n-   $f(x)\\delta(x-a) = f(a)\\delta(x-a)$. Here, $u_x \\delta(x-q) = u_x(q)\\delta(x-q) = 0 \\cdot \\delta(x-q) = 0$.\n-   $f(x)\\delta'(x-a) = f(a)\\delta'(x-a) - f'(a)\\delta(x-a)$. Here, $u \\delta'(x-q) = u(q)\\delta'(x-q) - u_x(q)\\delta(x-q) = p_0\\delta'(x-q) - 0\\cdot\\delta(x-q) = p_0\\delta'(x-q)$.\n\nSubstitute these into the RHS expression:\n$RHS = 3uu_x - 4p_0(0) - 2p_0(p_0\\delta'(x-q)) = 3uu_x - 2p_0^2\\delta'(x-q)$\n$RHS = 3(p_0 e^{-|x-q|})(-p_0 \\text{sgn}(x-q)e^{-|x-q|}) - 2p_0^2\\delta'(x-q)$\n$RHS = -3p_0^2 \\text{sgn}(x-q)e^{-2|x-q|} - 2p_0^2\\delta'(x-q)$.\n\nComparing LHS and RHS:\n$LHS = -2p_0^2 \\delta'(x-q) - 3p_0^2 \\text{sgn}(x-q)e^{-2|x-q|}$\n$RHS = -2p_0^2 \\delta'(x-q) - 3p_0^2 \\text{sgn}(x-q)e^{-2|x-q|}$\nThe LHS and RHS are identical. The verification is successful.\n\n### Evaluation of Options\n\nA. **For $\\kappa = 0$, substituting $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$ into $m_t + u\\,m_x + 2\\,u_x\\,m = 0$ and using $u = K * m$ with $K(x) = \\tfrac{1}{2}\\,e^{-|x|}$ yields the distributional identities $q'(t) = p(t)$ and $p'(t) = 0$. Consequently, the peakon speed equals its amplitude, and direct substitution of $u(x,t) = p(t)\\,e^{-\\big|x - q(t)\\big|}$, with $q'(t) = p(t)$ and $p'(t) = 0$, satisfies the equation in the sense of distributions.**\nThis statement is fully supported by our derivation and verification. The derived ODEs are $p'(t)=0$ and $q'(t)=p(t)$. This means speed equals amplitude. The direct substitution confirms the validity of this solution.\n**Verdict: Correct.**\n\nB. **For $\\kappa = 0$, the factor $2$ in $m(x,t) = 2\\,p(t)\\,\\delta\\big(x - q(t)\\big)$ implies that the speed is twice the amplitude, so the correct relation is $q'(t) = 2\\,p(t)$ and $p'(t) = 0$. Direct substitution confirms this stronger speed-amplitude proportionality.**\nThis is incorrect. Our derivation shows $q'(t)=p(t)$, not $2p(t)$. The factor of $2$ arises from the relation $m=u-u_{xx}$, not from a speed-doubling mechanism. The amplitude of the momentum $m$ is $2p$, while the amplitude of the velocity $u$ is $p$. The speed $q'$ is equal to the velocity amplitude $p$.\n**Verdict: Incorrect.**\n\nC. **For $\\kappa = 0$, nonlinearity induces amplitude decay according to $p'(t) = -3\\,p(t)^2$, while the speed initially equals the amplitude, $q'(0) = p(0)$, but deviates over time. Direct substitution reveals a secular drift invalidating constant speed-amplitude equality.**\nThis is incorrect. Our derivation showed $p'(t)=0$, meaning the amplitude is constant. A single peakon is a solitary wave that propagates without change in shape or amplitude. Decay or speed deviation does not occur for this exact solution.\n**Verdict: Incorrect.**\n\nD. **For $\\kappa = 0$, the peakon ansatz fails because $u$ is non-differentiable at $x = q(t)$, so neither the momentum equation nor the velocity formulation can be satisfied in the sense of distributions. Hence, speed cannot equal amplitude, and direct substitution produces contradictions.**\nThis is incorrect. The non-differentiability of $u$ is a key feature of a peakon, but it does not cause the ansatz to fail. The entire theory of weak solutions and distributional derivatives is designed to handle such cases. As our verification shows, both forms of the equation are perfectly satisfied in the sense of distributions, and direct substitution yields an identity, not a contradiction.\n**Verdict: Incorrect.**\n\nThe only correct statement is A.",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "Having explored a single peakon, we now examine how multiple peakons interact, which is governed by an elegant Hamiltonian structure. This practice requires you to compute the interaction forces by differentiating the N-peakon Hamiltonian with respect to the peakon positions. Completing this exercise will provide a direct look at the equations governing momentum exchange during peakon collisions, a key aspect of the system's integrable nature .",
            "id": "3773868",
            "problem": "Consider the Camassa-Holm equation (CH) in one spatial dimension reduced to the finite-dimensional $N$-peakon manifold. The dynamics are governed by Hamilton's equations with canonical coordinates $(q_i(t),p_i(t))$. The corresponding reduced Hamiltonian is\n$$\nH(q,p) = \\frac{1}{2}\\sum_{j=1}^{N}\\sum_{k=1}^{N} p_j p_k \\exp\\big(-|q_j - q_k|\\big),\n$$\nand Hamilton’s equations are\n$$\n\\dot{q}_i = \\frac{\\partial H}{\\partial p_i}, \\qquad \\dot{p}_i = -\\,\\frac{\\partial H}{\\partial q_i}.\n$$\nUsing the fact that the derivative of $|x|$ is $\\operatorname{sgn}(x)$ (with the convention $\\operatorname{sgn}(0)=0$), compute the explicit formula for $\\frac{\\partial H}{\\partial q_i}$. Then use Hamilton’s equation for $\\dot{p}_i$ to deduce its explicit form. Report your final answer as the closed-form analytic expression for $\\dot{p}_i$ as a function of $\\{q_j,p_j\\}_{j=1}^{N}$.",
            "solution": "The problem requires the derivation of the explicit formula for the time derivative of the peakon momentum, $\\dot{p}_i$, within the Hamiltonian framework for $N$-peakon solutions of the Camassa-Holm equation.\n\nThe governing dynamical equations are Hamilton's equations:\n$$\n\\dot{q}_i = \\frac{\\partial H}{\\partial p_i}, \\qquad \\dot{p}_i = -\\frac{\\partial H}{\\partial q_i}\n$$\nThe Hamiltonian $H$ is given by:\n$$\nH(q,p) = \\frac{1}{2}\\sum_{j=1}^{N}\\sum_{k=1}^{N} p_j p_k \\exp\\big(-|q_j - q_k|\\big)\n$$\nOur objective is to compute $\\dot{p}_i$, which necessitates the calculation of the partial derivative $\\frac{\\partial H}{\\partial q_i}$.\n\nWe differentiate $H$ with respect to a specific coordinate $q_i$. The derivative of the exponential term is non-zero only if its argument depends on $q_i$, which occurs when $j=i$ or $k=i$.\n$$\n\\frac{\\partial H}{\\partial q_i} = \\frac{1}{2} \\sum_{j=1}^{N}\\sum_{k=1}^{N} p_j p_k \\frac{\\partial}{\\partial q_i} \\exp\\big(-|q_j - q_k|\\big)\n$$\nUsing the chain rule, $\\frac{\\partial}{\\partial q_i} \\exp\\big(-|q_j - q_k|\\big) = \\exp\\big(-|q_j - q_k|\\big) \\cdot \\big(-\\frac{\\partial |q_j - q_k|}{\\partial q_i}\\big)$.\nThe derivative of the absolute value is $\\frac{\\partial |x|}{\\partial x_i} = \\operatorname{sgn}(x) \\frac{\\partial x}{\\partial x_i}$. Here $x=q_j-q_k$.\nSo, $\\frac{\\partial |q_j-q_k|}{\\partial q_i} = \\operatorname{sgn}(q_j-q_k) (\\delta_{ji} - \\delta_{ki})$, where $\\delta_{ab}$ is the Kronecker delta.\n\nSubstituting this back into the sum:\n$$\n\\frac{\\partial H}{\\partial q_i} = -\\frac{1}{2} \\sum_{j,k} p_j p_k \\exp\\big(-|q_j - q_k|\\big) \\operatorname{sgn}(q_j - q_k) (\\delta_{ji} - \\delta_{ki})\n$$\nWe can split the sum into two parts based on the Kronecker deltas:\n$$\n\\frac{\\partial H}{\\partial q_i} = -\\frac{1}{2} \\left[ \\sum_{k=1}^N p_i p_k \\exp(-|q_i-q_k|) \\operatorname{sgn}(q_i-q_k) - \\sum_{j=1}^N p_j p_i \\exp(-|q_j-q_i|) \\operatorname{sgn}(q_j-q_i) \\right]\n$$\nUsing the fact that $\\operatorname{sgn}(x)$ is an odd function, $\\operatorname{sgn}(q_j-q_i) = -\\operatorname{sgn}(q_i-q_j)$, we can rewrite the second sum:\n$$\n-\\sum_{j=1}^N p_j p_i \\exp(-|q_j-q_i|) (-\\operatorname{sgn}(q_i-q_j)) = \\sum_{j=1}^N p_j p_i \\exp(-|q_i-q_j|) \\operatorname{sgn}(q_i-q_j)\n$$\nThe second sum is identical to the first (after relabeling the summation index $j$ to $k$). Therefore, the two parts combine:\n$$\n\\frac{\\partial H}{\\partial q_i} = -\\frac{1}{2} \\left[ 2 \\sum_{k=1}^N p_i p_k \\exp(-|q_i-q_k|) \\operatorname{sgn}(q_i-q_k) \\right]\n$$\n$$\n\\frac{\\partial H}{\\partial q_i} = - \\sum_{k=1}^N p_i p_k \\exp(-|q_i-q_k|) \\operatorname{sgn}(q_i-q_k)\n$$\nNote that for $k=i$, the term is zero because $\\operatorname{sgn}(0)=0$.\nNow, we use Hamilton's equation for $\\dot{p}_i$:\n$$\n\\dot{p}_i = -\\frac{\\partial H}{\\partial q_i} = \\sum_{k=1}^N p_i p_k \\exp(-|q_i-q_k|) \\operatorname{sgn}(q_i-q_k)\n$$\nSince $p_i$ is a common factor in every term of the sum, we can factor it out to obtain the final closed-form expression:\n$$\n\\dot{p}_i = p_i \\sum_{k=1}^{N} p_k \\operatorname{sgn}(q_i - q_k) \\exp\\big(-|q_i - q_k|\\big)\n$$\nThis expression clearly reveals that the rate of change of a peakon's momentum, $\\dot{p}_i$, is proportional to its own momentum $p_i$ and a sum of influences from all other peakons, where each influence depends on the other peakon's momentum $p_k$ and their relative position $q_i-q_k$.",
            "answer": "$$\\boxed{p_i \\sum_{j=1}^{N} p_j \\operatorname{sgn}(q_i - q_j) \\exp(-|q_i - q_j|)}$$"
        },
        {
            "introduction": "This final practice bridges theory and computation by tasking you with building a structure-preserving numerical method for peakon dynamics. You will derive a discrete Lagrangian and implement the corresponding variational integrator, which belongs to the class of symplectic methods that are essential for long-term, stable simulations of Hamiltonian systems. This advanced exercise offers a hands-on experience in the principles of geometric integration, a cornerstone of modern computational mechanics .",
            "id": "3773813",
            "problem": "You are tasked with designing and implementing a structure-preserving (variational) time integrator for the peakon dynamics associated with the Camassa-Holm equation. The Camassa-Holm equation is known to be a geodesic flow on the diffeomorphism group with respect to the Sobolev order one metric, whose kinetic energy is given by the integral $$\\int (u^2 + u_x^2)\\,dx,$$ where $u$ is the velocity field and $u_x$ is its spatial derivative. Consider the $N$-peakon ansatz $$u(x,t) = \\sum_{i=1}^N p_i(t) \\exp\\!\\big(-|x-q_i(t)|\\big),$$ where $q_i(t)$ are peak positions and $p_i(t)$ are peak amplitudes (momenta). Under this ansatz, the velocity at the peak positions satisfies $$\\dot{q}_i(t) = \\sum_{j=1}^N p_j(t)\\,\\exp\\!\\big(-|q_i(t)-q_j(t)|\\big),$$ and the amplitude evolution is governed by a Hamiltonian system derived from a discrete Lagrangian approximating the kinetic energy functional.\n\nStarting from fundamental principles of geometric mechanics and the variational formulation, perform the following steps:\n\n1. Derive the finite-dimensional Lagrangian for the peakon positions $q=(q_1,\\dots,q_N)$ and velocities $\\dot{q}=(\\dot{q}_1,\\dots,\\dot{q}_N)$, using the identification of the kinetic energy with the integral $$\\int (u^2 + u_x^2)\\,dx.$$ Show that the Lagrangian can be written as $$L(q,\\dot{q}) = \\tfrac{1}{2}\\,\\dot{q}^\\top K(q)^{-1}\\dot{q},$$ where the interaction matrix $K(q)\\in\\mathbb{R}^{N\\times N}$ has entries $$K_{ij}(q) = \\exp\\!\\big(-|q_i-q_j|\\big).$$ Also show that under the Legendre transform, the Hamiltonian in canonical variables $(q,p)$ is $$H(q,p) = \\tfrac{1}{2}\\,p^\\top K(q)\\,p.$$\n\n2. Define a discrete Lagrangian for a time step of size $h0$ by the midpoint rule $$L_d(q_k,q_{k+1};h) = h\\,L\\!\\left(\\tfrac{q_k+q_{k+1}}{2},\\,\\tfrac{q_{k+1}-q_k}{h}\\right) = \\tfrac{h}{2}\\,v^\\top K\\!\\left(\\tfrac{q_k+q_{k+1}}{2}\\right)^{-1}v,$$ where $v=(q_{k+1}-q_k)/h$. Write down the discrete Euler–Lagrange equations $$D_2 L_d(q_{k-1},q_k;h) + D_1 L_d(q_k,q_{k+1};h) = 0,$$ and explain how these equations, under the discrete Legendre transform, are equivalent to the implicit midpoint method applied to the canonical Hamiltonian system with Hamiltonian $H(q,p)$.\n\n3. Implement a solver for the implicit midpoint update for the peakon Hamiltonian system $$\\dot{q} = \\frac{\\partial H}{\\partial p}(q,p),\\quad \\dot{p} = -\\frac{\\partial H}{\\partial q}(q,p),$$ where\n   - $$\\frac{\\partial H}{\\partial p}(q,p) = K(q)\\,p,$$\n   - $$\\frac{\\partial H}{\\partial q_i}(q,p) = -\\sum_{j=1}^N p_i p_j\\,\\operatorname{sgn}(q_i-q_j)\\,\\exp\\!\\big(-|q_i-q_j|\\big),$$ with the convention $\\operatorname{sgn}(0)=0$.\n   Your solver must handle the implicit midpoint equations for one time step\n   $$q_{k+1} = q_k + h\\,\\frac{\\partial H}{\\partial p}\\!\\left(\\tfrac{q_k+q_{k+1}}{2},\\,\\tfrac{p_k+p_{k+1}}{2}\\right),\\quad p_{k+1} = p_k - h\\,\\frac{\\partial H}{\\partial q}\\!\\left(\\tfrac{q_k+q_{k+1}}{2},\\,\\tfrac{p_k+p_{k+1}}{2}\\right),$$\n   using a Newton iteration with numerically approximated Jacobian (finite differences are acceptable and expected).\n\n4. Design tests against exact peakon trajectories as follows:\n   - For a single peakon ($N=1$), the exact solution is $$q(t) = q_0 + p_0\\,t,\\quad p(t) = p_0,$$ which must be used as the reference trajectory.\n   - For multi-peakon cases ($N\\ge 2$), obtain a high-accuracy reference by numerically solving the canonical Hamiltonian system with a classical fourth-order Runge–Kutta method with a very small time step, and use the final state at time $T$ as the reference trajectory.\n\n5. Your program must compute the Euclidean norm of the final-state error vector between the variational integrator and the reference trajectory at time $T$ for each test case, where the error vector is the concatenation of the position and momentum differences (no physical units are involved in the answer).\n\n6. Use the following test suite (ensure all numeric values are treated exactly as stated):\n   - Test case $1$ (happy path): $N=1$, $q_0=-2$, $p_0=1.5$, $T=3$, $N_{\\text{steps}}=300$.\n   - Test case $2$ (boundary condition): $N=1$, $q_0=0.5$, $p_0=0$, $T=1$, $N_{\\text{steps}}=50$.\n   - Test case $3$ (interaction, well-separated peaks): $N=2$, $q_0=(-10,10)$, $p_0=(2,0.5)$, $T=0.5$, $N_{\\text{steps}}=200$, with reference integration using $N_{\\text{ref}}=50000$ steps.\n   - Test case $4$ (edge case, coincident peaks): $N=2$, $q_0=(0,0)$, $p_0=(1,1)$, $T=0.1$, $N_{\\text{steps}}=50$, with reference integration using $N_{\\text{ref}}=50000$ steps.\n\n7. Final output format: Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[result1,result2,result3,result4]\"). Each result must be a floating-point number (in standard decimal notation), representing the Euclidean norm of the final-state error for the corresponding test case.\n\nNo external input is allowed. The implementation must be deterministic. Use the numerical libraries specified for the final program. All angles, if any occur, must be understood in radians, but this problem does not involve angles explicitly.",
            "solution": "The problem is subjected to validation against the specified criteria.\n\n**Verdict**: The problem is **valid**.\n\n**Justification**:\n1.  **Scientifically Grounded**: The problem is firmly rooted in the well-established field of geometric mechanics and the theory of integrable systems. The Camassa-Holm equation, its peakon solutions, and its formulation as a geodesic flow are standard topics of research. The provided equations for the Lagrangian, Hamiltonian, and derivatives are correct and can be found in the relevant scientific literature.\n2.  **Well-Posed**: All necessary information, including the governing equations, numerical method, initial conditions, and test parameters, is provided. The task is to implement a specific algorithm and compute a deterministic output, which constitutes a well-posed problem in computational science.\n3.  **Objective**: The problem is stated using precise mathematical language, free from any subjective or ambiguous terminology.\n\nThe problem is a rigorous and standard exercise in computational geometric mechanics, requiring both theoretical derivation and numerical implementation. It satisfies all criteria for a valid scientific problem. We may now proceed to the solution.\n\nThe solution is developed in three parts as requested: derivation of the continuous and discrete mechanical frameworks, description of the numerical implementation, and specification of the testing procedure.\n\n### 1. Lagrangian and Hamiltonian Formulation for Peakon Dynamics\n\nThe problem begins with the kinetic energy of the Camassa-Holm equation, which corresponds to the squared Sobolev $H^1$ norm of the velocity field $u(x,t)$. We identify the Lagrangian with this kinetic energy, as there is no potential energy. For a conservative mechanical system, the Lagrangian is $L = T - V$. Here, $V=0$, and the kinetic energy is given by $T = \\frac{1}{2} \\int_{-\\infty}^{\\infty} (u^2 + u_x^2) \\, dx$.\n\nThe $N$-peakon ansatz is given by\n$$u(x,t) = \\sum_{i=1}^N p_i(t) \\exp\\!\\big(-|x-q_i(t)|\\big).$$\nA key property of this ansatz is that it represents a distributional solution to the equation $(1-\\partial_x^2) u = 2 \\sum_{i=1}^N p_i \\delta(x-q_i)$, where $\\delta(\\cdot)$ is the Dirac delta function. Using this property, the kinetic energy can be calculated efficiently. The integral represents the $H^1$ inner product, $\\langle u, u \\rangle_{H^1} = \\int (u \\cdot u + u_x \\cdot u_x) \\, dx$. Through integration by parts, this is equivalent to $\\int u (1-\\partial_x^2)u \\, dx$.\n\nSubstituting the distributional identity, we get:\n$$\n\\begin{aligned}\n2T = \\int_{-\\infty}^{\\infty} u(x,t) (1-\\partial_x^2)u(x,t) \\, dx \\\\\n= \\int_{-\\infty}^{\\infty} \\left( \\sum_{j=1}^N p_j e^{-|x-q_j|} \\right) \\left( 2 \\sum_{i=1}^N p_i \\delta(x-q_i) \\right) \\, dx \\\\\n= 2 \\sum_{i,j=1}^N p_i p_j \\int_{-\\infty}^{\\infty} e^{-|x-q_j|} \\delta(x-q_i) \\, dx.\n\\end{aligned}\n$$\nBy the sifting property of the delta function, $\\int f(x)\\delta(x-a)dx = f(a)$, the integral evaluates to $\\exp(-|q_i-q_j|)$. Thus,\n$$2T = 2 \\sum_{i,j=1}^N p_i p_j \\exp(-|q_i-q_j|).$$\nIn matrix notation, this is $2T = p^\\top K(q) p$, where $p = (p_1, \\dots, p_N)^\\top$ and $K(q)$ is the symmetric interaction matrix with entries $K_{ij}(q) = \\exp(-|q_i-q_j|)$.\n\nThe Hamiltonian $H(q,p)$ of the system is equal to its total energy, which is just the kinetic energy. Therefore,\n$$H(q,p) = T = \\tfrac{1}{2}\\,p^\\top K(q)\\,p.$$\nThis confirms the first part of the problem statement.\n\nTo find the Lagrangian $L(q, \\dot{q})$, we must perform a Legendre transform from the phase space $(q,p)$ to the configuration space $(q, \\dot{q})$. We need the relationship between the momentum $p$ and the velocity $\\dot{q}$. The first of Hamilton's equations gives this:\n$$\\dot{q} = \\frac{\\partial H}{\\partial p} = \\frac{\\partial}{\\partial p} \\left( \\tfrac{1}{2}\\,p^\\top K(q)\\,p \\right) = K(q)p.$$\nAssuming the positions $q_i$ are all distinct, the matrix $K(q)$ is positive definite and thus invertible. We can express the momenta in terms of velocities:\n$$p = K(q)^{-1}\\dot{q}.$$\nThe Lagrangian is defined by the Legendre transform $L(q, \\dot{q}) = p^\\top \\dot{q} - H(q,p(q,\\dot{q}))$. Substituting the expressions for $p$ and $H$:\n$$\n\\begin{aligned}\nL(q, \\dot{q}) = \\big(K(q)^{-1}\\dot{q}\\big)^\\top \\dot{q} - \\tfrac{1}{2}\\,\\big(K(q)^{-1}\\dot{q}\\big)^\\top K(q) \\big(K(q)^{-1}\\dot{q}\\big) \\\\\n= \\dot{q}^\\top (K(q)^{-1})^\\top \\dot{q} - \\tfrac{1}{2}\\,\\dot{q}^\\top (K(q)^{-1})^\\top K(q) K(q)^{-1} \\dot{q}.\n\\end{aligned}\n$$\nSince $K(q)$ is symmetric, its inverse $K(q)^{-1}$ is also symmetric, so $(K(q)^{-1})^\\top = K(q)^{-1}$. This simplifies the expression to:\n$$L(q, \\dot{q}) = \\dot{q}^\\top K(q)^{-1} \\dot{q} - \\tfrac{1}{2}\\,\\dot{q}^\\top K(q)^{-1} \\dot{q} = \\tfrac{1}{2}\\,\\dot{q}^\\top K(q)^{-1}\\dot{q}.$$\nThis confirms the expression for the Lagrangian given in the problem statement.\n\n### 2. The Variational Integrator and its Hamiltonian Counterpart\n\nVariational integrators are derived by discretizing Hamilton's principle of stationary action, $\\delta \\int L(q, \\dot{q}) \\, dt = 0$. We approximate the action integral over a time interval $[t_k, t_{k+1}]$ of duration $h = t_{k+1}-t_k$ using a quadrature rule. The problem specifies a discrete Lagrangian based on the midpoint rule:\n$$L_d(q_k,q_{k+1};h) = h\\,L\\!\\left(\\tfrac{q_k+q_{k+1}}{2},\\,\\tfrac{q_{k+1}-q_k}{h}\\right).$$\nSubstituting our expression for $L(q, \\dot{q})$ and defining $q_{mid} = \\frac{q_k+q_{k+1}}{2}$ and $v = \\frac{q_{k+1}-q_k}{h}$:\n$$L_d(q_k,q_{k+1};h) = \\tfrac{h}{2}\\,v^\\top K(q_{mid})^{-1}v = \\tfrac{1}{2h}(q_{k+1}-q_k)^\\top K\\!\\left(\\tfrac{q_k+q_{k+1}}{2}\\right)^{-1}(q_{k+1}-q_k).$$\nThe discrete action is the sum $S_d = \\sum_k L_d(q_k, q_{k+1})$. The discrete principle of stationary action, $\\delta S_d = 0$, requires that the variation with respect to an internal path point $q_k$ is zero. This yields the discrete Euler-Lagrange (DEL) equations:\n$$\\frac{\\partial}{\\partial q_k} \\Big( L_d(q_{k-1},q_k;h) + L_d(q_k,q_{k+1};h) \\Big) = D_2 L_d(q_{k-1},q_k;h) + D_1 L_d(q_k,q_{k+1};h) = 0,$$\nwhere $D_1$ and $D_2$ denote the partial derivatives with respect to the first and second arguments, respectively.\n\nThis discrete variational formulation is known to be equivalent to a specific symplectic integrator on the Hamiltonian side. We define the discrete momenta at the ends of the interval $[t_k, t_{k+1}]$ via the discrete Legendre transforms:\n$$p_k = -D_1 L_d(q_k, q_{k+1}) \\quad \\text{and} \\quad p_{k+1} = D_2 L_d(q_k, q_{k+1}).$$\nLet's analyze these definitions for our specific $L_d$:\n$$p_{k+1} = \\frac{\\partial L_d}{\\partial q_{k+1}} = \\frac{h}{2}\\frac{\\partial}{\\partial q_{k+1}} \\left( L(q_{mid}, v) \\right) = \\frac{h}{2} \\left( \\frac{\\partial L}{\\partial q_{mid}} \\frac{\\partial q_{mid}}{\\partial q_{k+1}} + \\frac{\\partial L}{\\partial v} \\frac{\\partial v}{\\partial q_{k+1}} \\right) = \\frac{h}{2} \\left( \\frac{1}{2}\\frac{\\partial L}{\\partial q} + \\frac{1}{h}\\frac{\\partial L}{\\partial \\dot{q}} \\right),$$\nwhere the derivatives of $L$ are evaluated at $(q_{mid}, v)$. Similarly,\n$$p_k = -\\frac{\\partial L_d}{\\partial q_{k}} = -\\frac{h}{2}\\frac{\\partial}{\\partial q_{k}} \\left( L(q_{mid}, v) \\right) = -\\frac{h}{2} \\left( \\frac{1}{2}\\frac{\\partial L}{\\partial q} - \\frac{1}{h}\\frac{\\partial L}{\\partial \\dot{q}} \\right).$$\nSumming and subtracting these two equations gives:\n$$p_{k+1} + p_k = \\frac{\\partial L}{\\partial \\dot{q}}(q_{mid}, v) + \\frac{\\partial L}{\\partial \\dot{q}}(q_{mid}, v) = 2 \\frac{\\partial L}{\\partial \\dot{q}}(q_{mid}, v) = 2 p_{mid},$$\n$$p_{k+1} - p_k = \\frac{h}{2}\\frac{\\partial L}{\\partial q}(q_{mid}, v) + \\frac{h}{2}\\frac{\\partial L}{\\partial q}(q_{mid}, v) = h \\frac{\\partial L}{\\partial q}(q_{mid}, v).$$\nUsing the identity $\\frac{\\partial L}{\\partial q} = -\\frac{\\partial H}{\\partial q}$ and the definition $p = \\frac{\\partial L}{\\partial \\dot{q}}$, and rearranging, we get:\n$$p_{mid} = \\frac{p_k+p_{k+1}}{2} = p(q_{mid}, v) = K(q_{mid})^{-1}v = K(\\tfrac{q_k+q_{k+1}}{2})^{-1} (\\tfrac{q_{k+1}-q_k}{h}),$$\n$$\\frac{p_{k+1}-p_k}{h} = \\frac{\\partial L}{\\partial q}(q_{mid}, v) = -\\frac{\\partial H}{\\partial q}(q_{mid}, p_{mid}).$$\nFrom the first equation, we can write $v = K(q_{mid})p_{mid}$. Recalling that $\\dot{q} = \\nabla_p H(q,p) = K(q)p$, we have $\\nabla_p H(q_{mid}, p_{mid}) = K(q_{mid})p_{mid} = v$. Substituting $v = (q_{k+1}-q_k)/h$, we obtain the full set of equations:\n$$ \\frac{q_{k+1}-q_k}{h} = \\frac{\\partial H}{\\partial p}(\\tfrac{q_k+q_{k+1}}{2}, \\tfrac{p_k+p_{k+1}}{2}), $$\n$$ \\frac{p_{k+1}-p_k}{h} = -\\frac{\\partial H}{\\partial q}(\\tfrac{q_k+q_{k+1}}{2}, \\tfrac{p_k+p_{k+1}}{2}). $$\nThese are precisely the equations for the implicit midpoint method applied to the Hamiltonian system. This demonstrates that the variational integrator derived from the midpoint discrete Lagrangian is equivalent to the implicit midpoint method, which is a one-stage symplectic Runge-Kutta method.\n\n### 3. Numerical Implementation\n\nTo advance the system from a state $(q_k, p_k)$ to $(q_{k+1}, p_{k+1})$ over a time step $h$, we must solve the implicit system of $2N$ nonlinear equations defined above. Let the state vector be $y = (q,p) \\in \\mathbb{R}^{2N}$. The update is given by $y_{k+1} = y_k + h f(\\frac{y_k+y_{k+1}}{2})$, where $f(y) = (\\nabla_p H, -\\nabla_q H)$ is the Hamiltonian vector field.\n\nWe define a residual function $F(y_{k+1})$ whose root gives the solution for the next time step:\n$$ F(y_{k+1}) = y_{k+1} - y_k - h f\\left(\\frac{y_k+y_{k+1}}{2}\\right) = 0. $$\nThis system is solved using Newton's method. Starting with an initial guess $y_{k+1}^{(0)}$, we iteratively refine the guess using the update rule:\n$$ y_{k+1}^{(m+1)} = y_{k+1}^{(m)} - [J_F(y_{k+1}^{(m)})]^{-1} F(y_{k+1}^{(m)}), $$\nwhere $J_F$ is the Jacobian matrix of $F$ with respect to $y_{k+1}$. The Jacobian is given by $J_F(y) = I - \\frac{h}{2} J_f(\\frac{y_k+y}{2})$, where $J_f$ is the Jacobian of the vector field $f$. The problem permits approximating $J_F$ using finite differences, which avoids the need for its analytical derivation. For each column $j$ of the Jacobian, we compute $J_{F,j} \\approx \\frac{F(y+\\epsilon e_j) - F(y)}{\\epsilon}$ for a small perturbation $\\epsilon$, where $e_j$ is the $j$-th standard basis vector. The linear system $J_F \\Delta y = -F$ is solved for the correction $\\Delta y = y_{k+1}^{(m+1)} - y_{k+1}^{(m)}$ at each iteration. A good initial guess $y_{k+1}^{(0)}$ can be obtained from an explicit Euler step: $y_{k+1}^{(0)} = y_k + hf(y_k)$.\n\n### 4. Reference Trajectories and Error Evaluation\n\nTo assess the accuracy of the variational integrator, its results are compared against reference solutions.\n-   **For $N=1$ peakon:** The Hamiltonian is $H(q,p) = \\frac{1}{2}p^2$. Hamilton's equations are $\\dot{q} = \\partial H/\\partial p = p$ and $\\dot{p} = -\\partial H/\\partial q = 0$. For initial conditions $(q_0, p_0)$, the exact solution is $p(t) = p_0$ and $q(t) = q_0 + p_0 t$. This analytical solution serves as the exact reference.\n-   **For $N \\ge 2$ peakons:** The system is generally not integrable in a simple form. A high-accuracy numerical reference is generated by solving the same Hamiltonian ODEs using a classical fourth-order Runge-Kutta (RK4) method with a very small time step $h_{ref} = T/N_{ref}$, where $N_{ref}$ is much larger than $N_{steps}$ used for the variational integrator.\n\nThe error is quantified at the final time $T$. Let the final state from the variational integrator be $y_f = (q_f, p_f)$ and the reference final state be $y_{ref} = (q_{ref}, p_{ref})$. The error vector is defined as $e = y_f - y_{ref}$. The final reported value for each test case is the Euclidean norm of this error vector, $\\|e\\|_2 = \\sqrt{(q_f - q_{ref})^\\top(q_f - q_{ref}) + (p_f - p_{ref})^\\top(p_f - p_{ref})}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef _build_K_matrix(q):\n    \"\"\"Constructs the interaction matrix K(q).\"\"\"\n    q = np.asarray(q)\n    N = len(q)\n    q_col = q.reshape(N, 1)\n    q_row = q.reshape(1, N)\n    return np.exp(-np.abs(q_col - q_row))\n\ndef _grad_q_H(q, p):\n    \"\"\"Computes the partial derivative of the Hamiltonian H with respect to q.\"\"\"\n    q, p = np.asarray(q), np.asarray(p)\n    N = len(q)\n    \n    q_col = q.reshape(N, 1)\n    q_row = q.reshape(1, N)\n    \n    dist_matrix = q_col - q_row\n    # Problem specifies sgn(0) = 0. np.sign(0) is 0.\n    sign_matrix = np.sign(dist_matrix)\n    \n    exp_matrix = np.exp(-np.abs(dist_matrix))\n    \n    p_col = p.reshape(N, 1)\n    p_row = p.reshape(1, N)\n    \n    # Element-wise product of matrices\n    term_matrix = p_col * p_row * sign_matrix * exp_matrix\n    \n    # Sum over each row (sum over j for each i)\n    grad = -np.sum(term_matrix, axis=1)\n    return grad\n\ndef hamiltonian_rhs(y):\n    \"\"\"\n    Computes the Hamiltonian vector field F = (dH/dp, -dH/dq).\n    y is a concatenated state vector [q, p].\n    \"\"\"\n    N = len(y) // 2\n    q, p = y[:N], y[N:]\n    \n    K = _build_K_matrix(q)\n    dq_dt = K @ p\n    dp_dt = -_grad_q_H(q, p)\n    \n    return np.concatenate([dq_dt, dp_dt])\n\ndef implicit_midpoint_step(y_k, h, tol=1e-12, max_iter=20):\n    \"\"\"\n    Performs one step of the implicit midpoint integrator using a Newton solver.\n    \"\"\"\n    dim = len(y_k)\n\n    # Initial guess using explicit Euler\n    y_next_guess = y_k + h * hamiltonian_rhs(y_k)\n\n    def F(y_next):\n        return y_next - y_k - h * hamiltonian_rhs(0.5 * (y_k + y_next))\n\n    # Newton iteration\n    for _ in range(max_iter):\n        # Calculate residual\n        res = F(y_next_guess)\n        \n        # Check for convergence\n        if np.linalg.norm(res)  tol:\n            return y_next_guess\n\n        # Approximate Jacobian J_F using finite differences\n        jac = np.zeros((dim, dim))\n        eps = 1e-8\n        for j in range(dim):\n            y_pert = y_next_guess.copy()\n            y_pert[j] += eps\n            res_pert = F(y_pert)\n            jac[:, j] = (res_pert - res) / eps\n        \n        # Solve the linear system for the update\n        try:\n            delta_y = np.linalg.solve(jac, -res)\n        except np.linalg.LinAlgError:\n            # If Jacobian is singular, use pseudo-inverse.\n            # This can happen in symmetric cases like test 4.\n            delta_y = np.linalg.pinv(jac) @ -res\n\n        # Update guess\n        y_next_guess += delta_y\n    \n    # If convergence is not reached, we still return the last guess.\n    # For this problem, it is expected to converge.\n    return y_next_guess\n\ndef rk4_step(y, h):\n    \"\"\"Performs one step of the classical 4th-order Runge-Kutta method.\"\"\"\n    k1 = hamiltonian_rhs(y)\n    k2 = hamiltonian_rhs(y + 0.5 * h * k1)\n    k3 = hamiltonian_rhs(y + 0.5 * h * k2)\n    k4 = hamiltonian_rhs(y + h * k3)\n    return y + (h / 6.0) * (k1 + 2 * k2 + 2 * k3 + k4)\n\ndef solve():\n    test_cases = [\n        # (N, q0, p0, T, N_steps, N_ref)\n        (1, np.array([-2.0]), np.array([1.5]), 3.0, 300, None),\n        (1, np.array([0.5]), np.array([0.0]), 1.0, 50, None),\n        (2, np.array([-10.0, 10.0]), np.array([2.0, 0.5]), 0.5, 200, 50000),\n        (2, np.array([0.0, 0.0]), np.array([1.0, 1.0]), 0.1, 50, 50000),\n    ]\n\n    results = []\n    for N, q0, p0, T, N_steps, N_ref in test_cases:\n        y0 = np.concatenate([q0, p0])\n        h = T / N_steps\n\n        # Variational integrator simulation\n        y_sim = y0.copy()\n        for _ in range(N_steps):\n            y_sim = implicit_midpoint_step(y_sim, h)\n        \n        # Reference trajectory calculation\n        if N == 1:\n            q_ref = q0 + p0 * T\n            p_ref = p0\n            y_ref = np.concatenate([q_ref, p_ref])\n        else:\n            y_ref = y0.copy()\n            h_ref = T / N_ref\n            for _ in range(N_ref):\n                y_ref = rk4_step(y_ref, h_ref)\n\n        # Error calculation\n        error = np.linalg.norm(y_sim - y_ref)\n        results.append(error)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}