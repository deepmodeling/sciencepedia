{
    "hands_on_practices": [
        {
            "introduction": "汪-兰道模拟的收敛性是由修正因子 $f$ 控制的。理解这个因子如何随时间减小，是掌握该算法效率和终止条件的关键。本练习提供了一个具体计算，要求学生算出达到期望精度所需的阶段数，从而将抽象的更新方案与模拟时长的实际衡量联系起来。",
            "id": "3832255",
            "problem": "在用于估计多尺度模型中态密度的王-朗道（WL）抽样中，修正因子 $f$ 控制对态密度估计的乘性更新，并在各个阶段中被减小以驱动收敛。考虑一个WL过程，其中修正因子初始化为 $f_{0} = \\exp(1)$，并在每个精化阶段完成时通过平方根方案进行减小，即在阶段 $k$，因子 $f_{k}$ 被替换为 $f_{k+1} = \\sqrt{f_{k}}$。终止准则是因子的自然对数满足 $\\ln f \\leq 10^{-8}$。从平方根方案的定义和对数律 $\\ln(a^{b}) = b \\ln(a)$ 出发，推导经过 $n$ 个精化阶段后 $\\ln f_{n}$ 的闭式表达式，并确定从 $f_{0} = \\exp(1)$ 开始，满足终止准则所需的最小整数精化阶段数。将阶段的整数计数作为最终答案报告。由于答案是整数，因此不需要取整说明。",
            "solution": "首先对问题陈述进行严格的验证过程。\n\n### 第1步：提取已知条件\n- **算法**：王-朗道（WL）抽样。\n- **初始修正因子**：$f_{0} = \\exp(1)$。\n- **减小方案**：对于阶段 $k$ 的修正因子，$f_{k+1} = \\sqrt{f_{k}}$。\n- **终止准则**：$\\ln f \\leq 10^{-8}$。\n- **给出的恒等式**：$\\ln(a^{b}) = b \\ln(a)$。\n- **目标1**：推导经过 $n$ 个精化阶段后 $\\ln f_{n}$ 的闭式表达式。\n- **目标2**：确定满足终止准则所需的最小整数精化阶段数 $n$。\n\n### 第2步：使用提取的已知条件进行验证\n- **科学依据**：该问题在计算统计物理学中有充分的科学依据。王-朗道抽样是一种标准且广泛使用的算法。修正因子 $f$、其更新方案以及收敛准则都是该方法的标准组成部分。初始值 $f_0=\\exp(1)$ 和平方根方案是常见的选择。\n- **良构性**：该问题是良构的。它提供了一个初始条件 ($f_0$)、一个清晰的递推关系 ($f_{k+1} = \\sqrt{f_k}$) 和一个精确的终止条件 ($\\ln f_n \\le 10^{-8}$)。目标是找到一个特定的整数，对此存在唯一解。\n- **客观性**：该问题使用客观的数学语言陈述，没有歧义或主观论断。\n- **完整性与一致性**：该问题是自洽的。推导解答所需的所有必要信息都已提供。没有内部矛盾。\n- **真实性**：参数和背景对于王-朗道算法的典型实现是真实的。\n\n### 第3步：结论与行动\n该问题被认为是**有效的**，因为它有科学依据、良构、客观且完整。我现在将继续进行求解。\n\n该问题要求两件事：$\\ln f_n$ 的闭式表达式，以及满足收敛准则所需的最小阶段数 $n$。\n\n首先，我们推导 $f_n$ 的闭式表达式。更新规则由下式给出：\n$$f_{k+1} = \\sqrt{f_k} = f_k^{1/2}$$\n我们可以通过重复应用此规则，用初始因子 $f_0$ 来表示 $f_n$。\n对于 $n=1$：\n$$f_1 = f_0^{1/2}$$\n对于 $n=2$：\n$$f_2 = f_1^{1/2} = \\left(f_0^{1/2}\\right)^{1/2} = f_0^{(1/2) \\cdot (1/2)} = f_0^{(1/2)^2}$$\n对于 $n=3$：\n$$f_3 = f_2^{1/2} = \\left(f_0^{(1/2)^2}\\right)^{1/2} = f_0^{(1/2)^2 \\cdot (1/2)} = f_0^{(1/2)^3}$$\n通过归纳法，我们可以建立 $n$ 个阶段后 $f_n$ 的通用公式：\n$$f_n = f_0^{(1/2)^n}$$\n现在，我们推导 $\\ln f_n$ 的表达式。我们对 $f_n$ 表达式的两边取自然对数：\n$$\\ln(f_n) = \\ln\\left(f_0^{(1/2)^n}\\right)$$\n使用给定的对数恒等式 $\\ln(a^b) = b\\ln(a)$，我们得到：\n$$\\ln(f_n) = \\left(\\frac{1}{2}\\right)^n \\ln(f_0)$$\n这就是 $\\ln f_n$ 的闭式表达式。\n\n接下来，我们使用问题中给出的特定初始条件 $f_0 = \\exp(1)$。\n$$\\ln(f_0) = \\ln(\\exp(1)) = 1$$\n将此代入我们关于 $\\ln f_n$ 的表达式中：\n$$\\ln(f_n) = \\left(\\frac{1}{2}\\right)^n \\cdot 1 = \\left(\\frac{1}{2}\\right)^n = 2^{-n}$$\n终止准则是因子的自然对数必须小于或等于 $10^{-8}$。我们将此应用于 $\\ln f_n$：\n$$\\ln(f_n) \\leq 10^{-8}$$\n代入我们关于 $\\ln f_n$ 的表达式：\n$$2^{-n} \\leq 10^{-8}$$\n为了解出 $n$，我们对不等式两边取自然对数。由于自然对数是单调递增函数，不等号的方向保持不变。\n$$\\ln(2^{-n}) \\leq \\ln(10^{-8})$$\n再次使用对数幂次法则：\n$$-n \\ln(2) \\leq -8 \\ln(10)$$\n为了分离出 $n$，我们将两边同时除以 $-\\ln(2)$。由于 $\\ln(2) > 0$，项 $-\\ln(2)$ 是负数。不等式两边同除以一个负数会反转不等号的方向。\n$$n \\geq \\frac{-8 \\ln(10)}{-\\ln(2)}$$\n$$n \\geq 8 \\frac{\\ln(10)}{\\ln(2)}$$\n根据换底公式，表达式 $\\frac{\\ln(10)}{\\ln(2)}$ 等价于以 2 为底 10 的对数，即 $\\log_2(10)$。\n$$n \\geq 8 \\log_2(10)$$\n我们需要计算出右侧的数值来确定最小整数 $n$。\n我们知道 $2^3 = 8$ 且 $2^4 = 16$，所以 $3  \\log_2(10)  4$。使用对数的数值，$\\ln(10) \\approx 2.302585$ 和 $\\ln(2) \\approx 0.693147$。\n$$\\log_2(10) \\approx \\frac{2.302585}{0.693147} \\approx 3.321928$$\n现在，我们计算 $n$ 的下界：\n$$n \\geq 8 \\times 3.321928 \\approx 26.575424$$\n由于精化阶段数 $n$ 必须是整数，满足此条件的最小整数值是大于或等于 $26.575424$ 的最小整数。这可以通过对该值取上整得到。\n$$n = \\lceil 26.575424 \\rceil = 27$$\n因此，至少需要 $27$ 个精化阶段才能满足终止准则。",
            "answer": "$$\\boxed{27}$$"
        },
        {
            "introduction": "汪-兰道抽样能够高精度地估算出*相对*态密度 $\\ln g(E)$，但无法确定其绝对值。为了计算像自由能这样的绝对热力学量，必须对这个估算结果进行恰当的归一化。本练习展示了一个标准且至关重要的操作流程：如何利用一个已知的物理量（例如基态简并度）来校准计算出的对数态密度，从而确保最终结果具有物理意义。",
            "id": "3832190",
            "problem": "考虑一个用于多尺度建模的有限离散能量系统，其中必须计算精确的绝对热力学势，以耦合微观和介观描述。微正则态密度 $g(E)$ 定义为能量为 $E$ 的微观态的精确数量。汪-兰道采样 (Wang-Landau sampling, WLS) 在能量空间中构建随机行走，并迭代地优化 $\\ln g(E)$ 的估计值，以使访问能量的直方图变得平坦。在一个有限系统中，已知汪-兰道采样的输出在 $g(E)$ 上精确到一个全局乘法常数（等价于在 $\\ln g(E)$ 上精确到一个加法常数）。\n\n给定一个有限系统的三个能级 $E_0  E_1  E_2$ 的汪-兰道采样估计值 $\\ln \\tilde{g}(E)$。已知基态的多重度（简并度）为 $g(E_0) = d_0$，这是通过对称性独立确定的。假设玻尔兹曼常数 $k_{\\mathrm{B}}$ 设为 $1$，且能量以一致的单位报告。提供的数据如下：\n- 基态的已知简并度：在 $E_0$ 处 $d_0 = 2$。\n- 汪-兰道采样输出：$\\ln \\tilde{g}(E_0) = \\ln 5$，$\\ln \\tilde{g}(E_1) = \\ln 25$，$\\ln \\tilde{g}(E_2) = \\ln 50$。\n- 能量：$E_0 = -6$, $E_1 = -2$, $E_2 = 0$。\n- 考虑逆温 $\\beta = 1$ 下的正则系综。\n\n仅使用第一性原理以及微正则态密度和正则配分函数的核心定义，解释如何利用参考能量 $E_0$ 处的已知简并度，从汪-兰道采样估计值中获得 $g(E)$ 的绝对归一化。然后，在给定数据上演示该归一化过程，并计算在 $\\beta = 1$ 时对应的正则配分函数 $Z(\\beta)$。\n\n哪个选项正确地描述了归一化原理，并为给定数据提供了正确的归一化 $g(E)$ 值和正则配分函数？\n\nA. 通过对所有能量上的 $\\tilde{g}(E)$ 进行单一的全局重缩放，强制归一化的 $g(E)$ 与 $E_0$ 处的已知简并度匹配。这得到 $g(E) = c\\,\\tilde{g}(E)$，其中选择 $c$ 以满足 $g(E_0) = d_0$。对于给定数据，$c = \\dfrac{2}{5}$，所以 $g(E_0) = 2$，$g(E_1) = 10$，$g(E_2) = 20$，在 $\\beta = 1$ 时的正则配分函数为 $Z(1) = 2\\,e^{6} + 10\\,e^{2} + 20$。\n\nB. 通过给 $g(E)$ 加上一个常数来修正汪-兰道采样估计，使得 $g(E_0)$ 等于已知简并度，即 $g(E) = \\tilde{g}(E) + \\left(d_0 - \\tilde{g}(E_0)\\right)$。对于给定数据，这得到 $g(E_0) = 2$，$g(E_1) = 22$，$g(E_2) = 47$，且 $Z(1) = 2\\,e^{6} + 22\\,e^{2} + 47$。\n\nC. 通过减去 $\\left(\\ln d_0 - \\ln \\tilde{g}(E_0)\\right)$ 来归一化 $\\ln \\tilde{g}(E)$，以得到 $\\ln g(E) = \\ln \\tilde{g}(E) - \\left(\\ln d_0 - \\ln \\tilde{g}(E_0)\\right)$。对于给定数据，这产生 $g(E_0) = \\dfrac{25}{2}$，$g(E_1) = \\dfrac{125}{2}$，$g(E_2) = \\dfrac{250}{2}$，且 $Z(1) = \\dfrac{25}{2}\\,e^{6} + \\dfrac{125}{2}\\,e^{2} + \\dfrac{250}{2}$。\n\nD. 通过将 $\\tilde{g}(E)$ 转换为概率 $g_{\\mathrm{prob}}(E) = \\dfrac{\\tilde{g}(E)}{\\sum_{E'} \\tilde{g}(E')}$ 来进行归一化，并用这些概率来定义配分函数为 $Z(\\beta) = \\sum_{E} g_{\\mathrm{prob}}(E)\\,e^{-\\beta E}$。对于给定数据，$\\sum_{E'} \\tilde{g}(E') = 80$，所以 $g_{\\mathrm{prob}}(E_0) = \\dfrac{5}{80}$，$g_{\\mathrm{prob}}(E_1) = \\dfrac{25}{80}$，$g_{\\mathrm{prob}}(E_2) = \\dfrac{50}{80}$，且 $Z(1) = \\dfrac{5}{80}\\,e^{6} + \\dfrac{25}{80}\\,e^{2} + \\dfrac{50}{80}$。",
            "solution": "从微正则态密度 $g(E)$ 的定义开始，它是在能量 $E$ 下的微观态的精确计数。在一个有限系统中，对于离散能级 $E$，$g(E)$ 是一个整数值函数。汪-兰道采样 (WLS) 在能量空间中进行随机行走，并更新态密度对数的估计量，以使能量直方图平坦化。WLS 估计量的标准特性是它能恢复相对态密度但不能恢复其绝对尺度，即它确定 $\\ln g(E)$ 的值，但会相差一个加法常数。因此，估计值 $\\tilde{g}(E)$ 与真实的 $g(E)$ 成正比，比例系数为一个未知的乘法常数，因此存在一个常数 $c > 0$ 使得\n$$\ng(E) = c\\,\\tilde{g}(E), \\quad \\text{等价于} \\quad \\ln g(E) = \\ln \\tilde{g}(E) + \\ln c.\n$$\n\n为了确定绝对尺度，我们使用一个在参考能量 $E_{\\mathrm{ref}}$（这里是基态 $E_0$）处的已知简并度，这在有限系统中通常可以从对称性或精确计数中获得。施加 $g(E_{\\mathrm{ref}}) = d_{\\mathrm{ref}}$ 的条件可以确定该常数：\n$$\nc = \\frac{d_{\\mathrm{ref}}}{\\tilde{g}(E_{\\mathrm{ref}})}, \\quad \\text{或} \\quad \\ln c = \\ln d_{\\mathrm{ref}} - \\ln \\tilde{g}(E_{\\mathrm{ref}}).\n$$\n这确保了 $g(E)$ 在所有能量上的一致全局归一化。值得注意的是，在正则系综中，概率\n$$\np(E) = \\frac{g(E) \\, e^{-\\beta E}}{Z(\\beta)}, \\quad Z(\\beta) = \\sum_{E} g(E) \\, e^{-\\beta E},\n$$\n在全局重缩放 $g(E) \\to c\\,g(E)$ 下是不变的，因为分子和分母都按比例 $c$ 缩放。然而，像自由能 $F(\\beta) = -\\beta^{-1} \\ln Z(\\beta)$ 这样的绝对量取决于绝对归一化，这在组合来自不同子系统或尺度的贡献时，是多尺度耦合所必需的。\n\n将归一化应用于给定数据。汪-兰道采样的输出是\n$$\n\\ln \\tilde{g}(E_0) = \\ln 5, \\quad \\ln \\tilde{g}(E_1) = \\ln 25, \\quad \\ln \\tilde{g}(E_2) = \\ln 50,\n$$\n所以\n$$\n\\tilde{g}(E_0) = 5, \\quad \\tilde{g}(E_1) = 25, \\quad \\tilde{g}(E_2) = 50.\n$$\n在 $E_0$ 处已知 $d_0 = 2$，我们设置\n$$\nc = \\frac{d_0}{\\tilde{g}(E_0)} = \\frac{2}{5}.\n$$\n因此，归一化的态密度是\n$$\ng(E_0) = c\\,\\tilde{g}(E_0) = \\frac{2}{5}\\cdot 5 = 2, \\quad\ng(E_1) = c\\,\\tilde{g}(E_1) = \\frac{2}{5}\\cdot 25 = 10, \\quad\ng(E_2) = c\\,\\tilde{g}(E_2) = \\frac{2}{5}\\cdot 50 = 20.\n$$\n在逆温 $\\beta = 1$ 时，正则配分函数是\n$$\nZ(1) = \\sum_{i=0}^{2} g(E_i)\\, e^{- E_i} = g(E_0)\\, e^{-(-6)} + g(E_1)\\, e^{-(-2)} + g(E_2)\\, e^{-0} = 2\\,e^{6} + 10\\,e^{2} + 20.\n$$\n这个过程将汪-兰道采样的估计值与已知的基态多重度对齐，从而得到一个适用于计算自由能和进行多尺度耦合的绝对归一化。\n\n逐个选项分析：\n\n- 选项A：它正确地陈述了原理，即汪-兰道采样估计值通过一个单一的全局乘法常数进行归一化，该常数被选择来匹配参考能量下的已知简并度。它计算出 $c = 2/5$，得到 $g(E_0) = 2$，$g(E_1) = 10$，$g(E_2) = 20$，以及正确的配分函数 $Z(1) = 2\\,e^{6} + 10\\,e^{2} + 20$。结论 — 正确。\n\n- 选项B：它错误地对 $g(E)$ 应用了加法校正，而不是乘法缩放。量 $g(E)$ 是态的计数，而汪-兰道采样的误差表现为一个全局乘法因子，而不是一个加法偏移。因此，所提出的 $g(E)$ 值和配分函数是不正确的。结论 — 错误。\n\n- 选项C：它建议通过减去 $\\left(\\ln d_0 - \\ln \\tilde{g}(E_0)\\right)$ 来调整 $\\ln \\tilde{g}(E)$，即 $\\ln g(E) = \\ln \\tilde{g}(E) - \\left(\\ln d_0 - \\ln \\tilde{g}(E_0)\\right) = \\ln \\tilde{g}(E) - \\ln(2/5)$，这意味着 $g(E) = \\tilde{g}(E)\\cdot (5/2)$。这个符号是错的；正确的移位是 $\\ln g(E) = \\ln \\tilde{g}(E) + \\left(\\ln d_0 - \\ln \\tilde{g}(E_0)\\right)$，对应于 $g(E) = \\tilde{g}(E)\\cdot (2/5)$。按照选项C的写法，它得到 $g(E_0) = 25/2 \\neq 2$，所以它不满足归一化要求。结论 — 错误。\n\n- 选项D：它通过除以其总和将 $\\tilde{g}(E)$ 转换为概率，然后在配分函数中用这些概率代替态密度。这将微正则密度与一个归一化的概率测度混为一谈，并产生一个不符合物理的 $Z(\\beta)$，它依赖于概率的任意归一化，而不是绝对简并度。正则配分函数必须从绝对的 $g(E)$ 计算，而不是从能级的归一化概率计算。结论 — 错误。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "计算态密度 $g(E,M)$ 的真正威力在于，它能够通过单次模拟解锁系统在广阔温度范围内的热力学性质。这通过一种称为正则系综重加权的技术来实现。通过为一个小型系统实现精确枚举，这个动手编程练习将指导你构建联合态密度，并利用它在任意给定温度下计算物理可观测量，例如磁化强度分布。",
            "id": "3832210",
            "problem": "考虑一个在 $L \\times L$ 晶格上的二维方形伊辛模型，具有周期性边界条件，自旋 $s_{i} \\in \\{-1,+1\\}$，最近邻耦合设为1，因此所有量均为无量纲。设构型的能量由标准的最近邻伊辛哈密顿量给出：$E(\\mathbf{s}) = -\\sum_{\\langle i,j\\rangle} s_{i} s_{j}$，其中求和项对每个无序的最近邻键恰好计算一次；磁化强度为 $M(\\mathbf{s}) = \\sum_{i=1}^{L^2} s_{i}$。联合态密度 $g(E,M)$ 计算能量为 $E$ 且磁化强度为 $M$ 的构型数量。\n\n您的任务是本着 Wang-Landau (WL) 抽样的精神，为 $g(E,M)$ 的联合抽样构建一个公式，为离散宏观态 $(E,M)$ 指定一个适当的分箱方案，然后使用这个联合态密度进行重加权，以获得在逆温度 $\\beta$ 下的正则磁化分布 $P_{\\beta}(M)$。您必须实现一个程序，该程序使用与联合 WL 模拟中相同的 $(E,M)$ 分箱方法，通过对小的 $L$ 进行精确枚举来构建 $g(E,M)$，然后通过对 $g(E,M)$ 进行正则重加权来计算 $P_{\\beta}(M)$。\n\n仅从基本定义和已充分验证的事实出发；不要使用任何跳过接受准则或重加权推导的快捷公式。具体而言，您必须：\n- 陈述在宏观态 $(E,M)$ 上进行联合 WL 抽样的目标平稳分布，该分布应在 $(E,M)$ 空间中产生平坦的直方图，并由此推导出一个在构型空间中对称的单自旋翻转提议的 Metropolis-Hastings 接受准则。\n- 为此离散伊辛系统论证一个合适的 $(E,M)$ 分箱方案，用于联合 WL 抽样，并在精确枚举中实现相同的分箱方案，以将 $g(E,M)$ 构建为对各箱的整数计数。\n- 仅使用正则系综定义，解释如何通过重加权从 $g(E,M)$ 获得 $P_{\\beta}(M)$，包括正确的归一化。\n\n然后实现一个独立完整的程序，该程序：\n- 枚举给定 $L$ 的所有自旋构型，并使用上述模型定义下观察到的每个不同能量一个箱和每个不同磁化强度一个箱的方法，构建精确的联合态密度 $g(E,M)$。\n- 对于给定的逆温度 $\\beta$，仅使用正则权重从 $g(E,M)$ 进行重加权，并进行适当归一化，以计算正则磁化分布 $P_{\\beta}(M)$。\n- 从 $P_{\\beta}(M)$ 计算一个小测试集所要求的标量统计量。\n\n使用以下参数值的测试集来检验不同的机制和边界情况：\n- 测试 $1$（边界情况，无穷大温度）：$L=2$，$\\beta=0$。计算 $P_{\\beta}(M)$ 并返回 $M=0$ 处的值。\n- 测试 $2$（中等温度）：$L=2$，$\\beta=1$。计算每个自旋的平均绝对磁化强度，即 $\\langle |m| \\rangle$，其中 $m = M/L^2$。\n- 测试 $3$（二维伊辛模型的临界区附近）：$L=3$，$\\beta=0.44068679350977147$。计算 $P_{\\beta}(M)$ 并返回 $M=0$ 处的值。\n\n根据给定的定义，所有能量、磁化强度和逆温度都是无量纲的，因此不需要进行物理单位转换。不涉及角度。每个请求的答案必须是实数。您的程序应生成单行输出，其中包含测试 $1$–$3$ 的结果，形式为逗号分隔的列表并用方括号括起，每个浮点数四舍五入到六位小数，顺序如上所述，即 $[r_1,r_2,r_3]$，其中 $r_1$ 对应测试 $1$，$r_2$ 对应测试 $2$，$r_3$ 对应测试 $3$。",
            "solution": "该问题要求对一个二维伊辛模型进行理论阐述和计算实现。分析内容包括推导联合 Wang-Landau 抽样的关键方面，指定宏观态的分箱方案，解释正则重加权过程，最后通过对小晶格进行精确枚举来实现特定物理量的计算。\n\n系统定义在一个带有周期性边界条件的 $L \\times L$ 方形晶格上。每个格点 $i$ 上的自旋为 $s_i \\in \\{-1, +1\\}$。总自旋数为 $N=L^2$。一个构型 $\\mathbf{s} = (s_1, \\dots, s_N)$ 的能量由最近邻伊辛哈密顿量给出：$E(\\mathbf{s}) = -\\sum_{\\langle i,j\\rangle} s_{i} s_{j}$，其中耦合常数设为1，求和项遍历所有唯一的最近邻对。磁化强度为 $M(\\mathbf{s}) = \\sum_{i=1}^{N} s_{i}$。\n\n该问题是有效的，因为它在科学上基于统计力学的原理，提法清晰且提供了所有必要信息，并且其表述是客观的。\n\n### 1. 联合 Wang-Landau 抽样与接受准则\n\nWang-Landau (WL) 抽样的目标是获得态密度 (DOS) 的估计值，在本例中为联合态密度 $g(E,M)$，它计算每个宏观态 $(E,M)$ 对应的微观构型数。WL 算法在宏观态空间中进行随机行走，旨在在所有访问过的态 $(E,M)$ 上产生一个平坦的直方图。这是通过以与态密度成反比的概率抽样微观态来实现的。\n\n因此，一个微观态 $\\mathbf{s}$ 的目标平稳分布为 $\\pi(\\mathbf{s}) \\propto 1/g(E(\\mathbf{s}), M(\\mathbf{s}))$。随机行走通过从一个构型 $\\mathbf{s}$ 提议移动到一个新构型 $\\mathbf{s}'$ 来进行。问题指定了单自旋翻转的提议机制。翻转单个自旋是一个对称操作：通过翻转特定自旋从 $\\mathbf{s}$ 提议移动到 $\\mathbf{s}'$ 的概率与通过翻转相同自旋从 $\\mathbf{s}'$ 提议反向移动到 $\\mathbf{s}$ 的概率相同。因此，提议概率分布是对称的，$p(\\mathbf{s} \\to \\mathbf{s}') = p(\\mathbf{s}' \\to \\mathbf{s})$。\n\n在对称提议下，Metropolis-Hastings 接受概率 $A(\\mathbf{s} \\to \\mathbf{s}')$ 简化为 Metropolis 准则：\n$$A(\\mathbf{s} \\to \\mathbf{s}') = \\min\\left(1, \\frac{\\pi(\\mathbf{s}')}{\\pi(\\mathbf{s})}\\right)$$\n设 $\\mathbf{s}$ 的宏观态为 $(E,M)$，$\\mathbf{s}'$ 的宏观态为 $(E',M')$。代入我们的目标分布，得到：\n$$A((E,M) \\to (E',M')) = \\min\\left(1, \\frac{1/g(E',M')}{1/g(E,M)}\\right) = \\min\\left(1, \\frac{g(E,M)}{g(E',M')}\\right)$$\n在实践中，WL 算法迭代地构建 $g(E,M)$ 的估计值，通常通过处理其对数 $\\ln g(E,M)$。接受概率则计算为：\n$$A((E,M) \\to (E',M')) = \\min\\left(1, \\exp[\\ln g(E,M) - \\ln g(E',M')]\\right)$$\n每当访问一个宏观态时，其对应的 $\\ln g$ 值会通过加上一个修正因子来更新，该修正因子会逐渐减小以精化态密度的估计。\n\n### 2. 宏观变量 $(E,M)$ 的分箱方案\n\n对于指定的伊辛模型，能量 $E$ 和磁化强度 $M$ 都是离散量。\n\n**磁化强度 ($M$)**：总磁化强度为 $M = \\sum_{i=1}^{L^2} s_i$。设值为 $+1$ 的自旋数量为 $N_{up}$，值为 $-1$ 的自旋数量为 $N_{down}$。则 $N_{up} + N_{down} = L^2$ 且 $M = N_{up} - N_{down}$。代入 $N_{down} = L^2 - N_{up}$，我们发现 $M = 2N_{up} - L^2$。由于 $N_{up}$ 可以是 $0$ 到 $L^2$ 之间的任意整数，所以 $M$ 的可能值为 $-L^2, -L^2+2, \\dots, L^2-2, L^2$。磁化强度值为整数，步长为 $\\Delta M = 2$。\n\n**能量 ($E$)**：能量为 $E = -\\sum_{\\langle i,j \\rangle} s_i s_j$。在一个具有周期性边界条件的 $L \\times L$ 晶格上，有 $2L^2$ 个最近邻键。每一项 $s_i s_j$ 要么是 $+1$ 要么是 $-1$。因此能量是一个整数。可以证明，对于单自旋翻转，能量的变化 $\\Delta E$ 始终是 $4$ 的倍数。因此，对于给定的晶格，所有可及的能级都以 $4$ 的整数倍分隔。\n\n鉴于 $E$ 和 $M$ 都取离散且分隔良好的值，最自然且最精确的分箱方案是为系统可以实现的每个不同对 $(E,M)$ 使用一个箱。这种离散分箱避免了使用更宽的箱可能导致的信息损失。对于精确枚举任务，这对应于创建一个映射或字典，其中每个键是观察到的唯一 $(E,M)$ 元组。\n\n### 3. 从 $g(E,M)$ 到 $P_{\\beta}(M)$ 的正则重加权\n\n包含在态密度 $g(E,M)$ 中的微正则信息与在逆温度 $\\beta = 1/(k_B T)$ 下的正则系综性质之间的联系是通过配分函数 $Z$ 建立的。\n\n在正则系综中，一个微观态 $\\mathbf{s}$ 的概率由 $P(\\mathbf{s}) = \\frac{e^{-\\beta E(\\mathbf{s})}}{Z}$ 给出。配分函数 $Z$ 是对所有微观态的求和：\n$$Z = \\sum_{\\mathbf{s}} e^{-\\beta E(\\mathbf{s})}$$\n我们可以通过首先将所有共享相同宏观态 $(E,M)$ 的微观态分组来重构这个求和。这些态的数量恰好是联合态密度 $g(E,M)$。\n$$Z = \\sum_{E,M} \\sum_{\\substack{\\mathbf{s} \\text{ s.t.} \\\\ E(\\mathbf{s})=E, M(\\mathbf{s})=M}} e^{-\\beta E} = \\sum_{E,M} g(E,M) e^{-\\beta E}$$\n观察到特定宏观态 $(E,M)$ 的概率是属于它的所有微观态概率的总和：\n$$P_{\\beta}(E,M) = \\frac{g(E,M) e^{-\\beta E}}{Z}$$\n为了获得正则磁化分布 $P_{\\beta}(M)$，我们将此联合概率分布对所有可能的能量值 $E$ 进行边缘化：\n$$P_{\\beta}(M) = \\sum_{E} P_{\\beta}(E,M) = \\sum_{E} \\frac{g(E,M) e^{-\\beta E}}{Z}$$\n因此，从已知的 $g(E,M)$ 计算 $P_{\\beta}(M)$ 的步骤如下：\n1.  计算配分函数 $Z(\\beta) = \\sum_{E,M} g(E,M) e^{-\\beta E}$。求和遍历所有 $g(E,M)>0$ 的 $(E,M)$ 对。\n2.  对于每个可能的磁化强度值 $M_k$，计算未归一化的概率 $\\tilde{P}_{\\beta}(M_k) = \\sum_{E} g(E,M_k) e^{-\\beta E}$，其中求和遍历所有与 $M_k$ 相关联的能量 $E$。\n3.  归一化概率为 $P_{\\beta}(M_k) = \\frac{\\tilde{P}_{\\beta}(M_k)}{Z(\\beta)}$。\n\n### 4. 通过精确枚举的实现\n\n对于小的晶格尺寸，如 $L=2$ 和 $L=3$，精确枚举所有 $2^{L^2}$ 种可能的自旋构型是可行的。实现过程如下：\n1.  初始化一个空字典 `g_EM`，用于存储联合态密度 $g(E,M)$。\n2.  遍历从 $0$到 $2^{L^2}-1$ 的所有整数。每个整数的二进制表示映射到一个唯一的自旋构型（例如，比特 $0 \\to s=-1$，比特 $1 \\to s=+1$）。\n3.  对于每个构型，计算其总能量 $E$ 和总磁化强度 $M$。在周期性边界条件下，能量计算可以通过将每个自旋与其“右侧”和“下方”邻居的乘积求和来高效实现，这恰好计算了每个键一次：$E = -\\sum_{i=0}^{L-1}\\sum_{j=0}^{L-1} s_{i,j}(s_{(i+1)\\%L, j} + s_{i,(j+1)\\%L})$。\n4.  将计算出的 $(E,M)$ 对作为 `g_EM` 字典中的键，并增加其值（计数）。\n5.  处理完所有 $2^{L^2}$ 个构型后，`g_EM` 就包含了精确的联合态密度。\n6.  使用 `g_EM` 字典和第3部分的重加权公式，为任何给定的 $\\beta$ 计算配分函数 $Z$ 和概率分布 $P_{\\beta}(M)$。\n7.  最后，从得到的 $P_{\\beta}(M)$ 分布中计算所要求的统计量，如点概率 $P_{\\beta}(M=M_0)$ 或期望值，例如 $\\langle |m| \\rangle = \\sum_M |M/L^2| P_{\\beta}(M)$。\n\n此过程为给定的有限系统提供了精确解，可作为 Wang-Landau 抽样等随机方法的基准。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by enumerating states for small Ising models,\n    calculating the joint density of states g(E,M), and then using\n    canonical reweighting to find properties at given temperatures.\n    \"\"\"\n    test_cases = [\n        # (L, beta, statistic_type)\n        (2, 0.0, \"P(M=0)\"),\n        (2, 1.0, \"|m|>\"),\n        (3, 0.44068679350977147, \"P(M=0)\")\n    ]\n\n    results = []\n\n    for L, beta, stat_type in test_cases:\n        N = L * L\n        \n        # 1. Enumerate configurations to get the exact joint DOS g(E,M)\n        # g_em is a dictionary mapping (E, M) tuples to their counts.\n        g_em = {}\n        num_configs = 1  N # This is 2**N\n\n        for i in range(num_configs):\n            # Generate spin configuration from integer i\n            # bit 0 -> spin -1, bit 1 -> spin +1\n            spins_1d = np.array([1 if (i >> k)  1 else -1 for k in range(N)])\n            spins_2d = spins_1d.reshape((L, L))\n            \n            # Calculate Magnetization M\n            M = np.sum(spins_1d)\n            \n            # Calculate Energy E with periodic boundary conditions.\n            # Summing interaction of each spin with its 'right' and 'down'\n            # neighbor counts each bond exactly once.\n            # np.roll(..., -1, ...) shifts elements to the left/up, so\n            # s_grid[i,j] is multiplied by s_grid[i+1,j] and s_grid[i,j+1]\n            E = -np.sum(spins_2d * (np.roll(spins_2d, -1, axis=0) + \n                                   np.roll(spins_2d, -1, axis=1)))\n\n            # Store in g(E,M) dictionary, using integer keys\n            key = (int(E), int(M))\n            g_em[key] = g_em.get(key, 0) + 1\n\n        # 2. Reweight from g(E,M) to get the canonical distribution P_beta(M)\n        # Find the set of all unique magnetization values\n        M_values = sorted(list(set(m for e, m in g_em.keys())))\n        \n        # Calculate unnormalized probabilities and the partition function Z\n        P_M_unnormalized = {m: 0.0 for m in M_values}\n        Z = 0.0\n\n        for (E, M), count in g_em.items():\n            # Use np.longdouble for precision with large exponentials\n            boltzmann_factor = np.exp(np.longdouble(-beta * E))\n            term = count * boltzmann_factor\n            P_M_unnormalized[M] += term\n            Z += term\n\n        # Normalize to get P_beta(M)\n        if Z == 0.0:\n            # This case should not be reached for finite beta\n            P_M = {m: 0.0 for m in M_values}\n        else:\n            P_M = {m: p / Z for m, p in P_M_unnormalized.items()}\n\n        # 3. Compute the requested statistic\n        if stat_type == \"P(M=0)\":\n            # P_beta(M=0)\n            result = P_M.get(0, 0.0)\n        elif stat_type == \"|m|>\":\n            # |m|> = |M/L^2|>\n            mean_abs_M = sum(abs(m) * p for m, p in P_M.items())\n            result = mean_abs_M / N\n        else:\n            raise ValueError(\"Unknown statistic type\")\n\n        results.append(result)\n\n    # Final print statement in the exact required format\n    final_results_str = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(final_results_str)}]\")\n\nsolve()\n\n```"
        }
    ]
}