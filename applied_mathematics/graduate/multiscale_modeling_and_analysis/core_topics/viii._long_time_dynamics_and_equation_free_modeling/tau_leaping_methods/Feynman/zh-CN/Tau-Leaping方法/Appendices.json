{
    "hands_on_practices": [
        {
            "introduction": "任何随机模拟的第一步都是建立其数学基础。这项练习将引导你如何将一组化学反应转化为 tau-leaping 算法所需的核心组件：化学计量矩阵 $S$ 和倾向性向量 $a(x,y)$。掌握这一步对于在计算模型中正确表示生物或化学系统至关重要 。",
            "id": "3812855",
            "problem": "考虑一个包含两种分子 $X$ 和 $Y$ 的随机反应网络。该网络包含反应 $X \\xrightarrow{k_1} X+Y$ 和 $Y \\xrightarrow{k_2} \\emptyset$，其中 $k_1$ 和 $k_2$ 是正常数反应速率常数。令 $(x,y)$ 分别表示分子种类 $X$ 和 $Y$ 的整数值分子数量。使用化学主方程 (CME) 框架和标准的质量作用动力学，推导每个反应的化学计量变化向量，并将这些变化向量作为列组装成一个化学计量矩阵 $S$。然后，推导质量作用倾向函数，并将它们汇集成一个倾向向量 $a(x,y)$。最后，在 $\\tau$-跳跃近似下，假设在长度为 $\\tau$ 的小时间间隔内，反应 $i$ 的反应计数 $K_i$ 是参数为 $a_i(x,y)\\,\\tau$ 的独立泊松随机变量，并以 $x \\mapsto x + \\sum_{i} \\nu_i K_i$ 的形式定义布居向量的状态更新（其中 $x$ 表示状态向量，$\\nu_i$ 表示化学计量变化向量）。将更新表示为分量形式的映射和矩阵形式 $x \\mapsto x + S K$，其中 $K$ 是反应计数的向量。\n\n以单一解析表达式的形式提供最终答案，该表达式同时给出该网络的化学计量矩阵 $S$、倾向向量 $a(x,y)$ 以及状态更新映射 $x \\mapsto x + S K$。不需要进行数值计算，也不需要四舍五入。",
            "solution": "首先验证问题，以确保其自洽、科学上合理且良定。\n\n### 步骤1：提取已知条件\n- **分子种类**：$X$, $Y$。\n- **状态向量**：分子数量由数对 $(x,y)$ 表示。问题还指定使用符号 $x$ 表示状态向量。为避免推导过程中的歧义，状态向量将表示为 $\\mathbf{x} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$。\n- **反应**：\n    - $R_1: X \\xrightarrow{k_1} X+Y$\n    - $R_2: Y \\xrightarrow{k_2} \\emptyset$\n- **速率常数**：$k_1 > 0$ 且 $k_2 > 0$。\n- **动力学**：标准质量作用动力学。\n- **框架**：化学主方程（CME）和 $\\tau$-跳跃近似。\n- **$\\tau$-跳跃假设**：对于一个时间步长 $\\tau$，反应 $j$ 发生的次数（记为 $K_j$）是从泊松分布中抽取的随机变量：$K_j \\sim \\text{Poisson}(a_j(\\mathbf{x})\\tau)$，其中 $a_j(\\mathbf{x})$ 是反应 $j$ 的倾向函数。\n- **状态更新规则**：状态向量 $\\mathbf{x}$ 根据规则 $\\mathbf{x} \\mapsto \\mathbf{x} + \\sum_{j} \\nu_j K_j$ 进行更新，该规则可以写成矩阵形式 $\\mathbf{x} \\mapsto \\mathbf{x} + S K$，其中 $\\nu_j$ 是化学计量变化向量，$S$ 是化学计量矩阵，$K$ 是反应计数向量。\n\n### 步骤2：使用提取的已知条件进行验证\n根据验证标准对问题陈述进行评估。\n- **科学依据**：该问题基于标准的、成熟的随机化学动力学理论，特别是 Gillespie 随机模拟算法及其 $\\tau$-跳跃近似。这些反应代表了催化生成和一级降解，这是系统生物学中的基本模体。\n- **良定性**：问题要求从一个完全指定的反应网络中推导特定的数学构造（$S$、$a(x,y)$ 和更新规则）。定义和要求的输出是清晰的，并能导出一个唯一的解。\n- **客观性**：问题以精确、正式的语言陈述，没有任何主观性或歧义。\n\n该问题没有表现出任何科学上不合理、不完整、矛盾或病态等缺陷。使用 $x$ 同时表示状态向量的一个分量和状态向量本身是文献中常见的约定，尽管可能会引起混淆。我们将按照指示遵循这一约定继续进行。\n\n### 步骤3：结论与行动\n问题是**有效的**。将提供一个完整的、有理有据的解答。\n\n### 解答推导\n通过基于所提供的反应网络系统地构建 $\\tau$-跳跃方法所需的组件来推导解答。\n\n**1. 化学计量变化向量和化学计量矩阵 ($S$)**\n\n系统的状态由分子布居向量 $\\mathbf{x} = \\begin{pmatrix} x \\\\ y \\end{pmatrix}$ 描述。一个化学反应 $R_j$ 会通过一个特定的整数值向量，即化学计量变化向量 $\\nu_j$，引起状态向量的变化。\n\n- **反应 $R_1: X \\xrightarrow{k_1} X+Y$**：\n  在此反应中，$X$ 的布居数变化为 $1 - 1 = 0$，$Y$ 的布居数变化为 $1 - 0 = 1$。\n  变化向量为 $\\nu_1 = \\begin{pmatrix} \\Delta x \\\\ \\Delta y \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$。\n\n- **反应 $R_2: Y \\xrightarrow{k_2} \\emptyset$**：\n  在此反应中，$X$ 的布居数不变，因此 $\\Delta x = 0$。$Y$ 的布居数减少 1，因此 $\\Delta y = -1$。\n  变化向量为 $\\nu_2 = \\begin{pmatrix} \\Delta x \\\\ \\Delta y \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -1 \\end{pmatrix}$。\n\n化学计量矩阵 $S$ 是由化学计量变化向量作为其列构成的。对于一个有 $M$ 个物种和 $N$ 个反应的系统，$S$ 是一个 $M \\times N$ 的矩阵。在这里，我们有 2 个物种和 2 个反应。\n$$\nS = \\begin{pmatrix} \\nu_1  \\nu_2 \\end{pmatrix} = \\begin{pmatrix} 0  0 \\\\ 1  -1 \\end{pmatrix}\n$$\n\n**2. 倾向函数和倾向向量 ($a(x,y)$)**\n\n反应 $R_j$ 的倾向函数 $a_j(\\mathbf{x})$ 给出了在给定状态 $\\mathbf{x}$ 的情况下，单位时间内反应 $R_j$ 发生的概率。对于质量作用动力学，倾向是随机速率常数 $k_j$ 与反应物分子的不同组合数的乘积。\n\n- **对于反应 $R_1: X \\xrightarrow{k_1} X+Y$**：\n  反应物是单个 $X$ 分子。其分子数量为 $x$。\n  倾向函数为 $a_1(x,y) = k_1 x$。\n\n- **对于反应 $R_2: Y \\xrightarrow{k_2} \\emptyset$**：\n  反应物是单个 $Y$ 分子。其分子数量为 $y$。\n  倾向函数为 $a_2(x,y) = k_2 y$。\n\n倾向向量 $a(x,y)$ 汇集了这些单独的倾向函数。\n$$\na(x,y) = \\begin{pmatrix} a_1(x,y) \\\\ a_2(x,y) \\end{pmatrix} = \\begin{pmatrix} k_1 x \\\\ k_2 y \\end{pmatrix}\n$$\n\n**3. $\\tau$-跳跃状态更新规则**\n\n$\\tau$-跳跃方法通过假设在一个小的时间间隔 $\\tau$ 内，倾向函数大致保持不变来近似系统的演化。在 $[t, t+\\tau)$ 内每个反应 $j$ 发生的次数 $K_j$ 被建模为参数为 $a_j(\\mathbf{x}(t))\\tau$ 的独立泊松随机变量。\n\n根据问题指定的符号，令 $x$ 表示在时间 $t$ 的状态向量 $\\begin{pmatrix} x \\\\ y \\end{pmatrix}$。反应计数向量为 $K = \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix}$，其中：\n- $K_1 \\sim \\text{Poisson}(a_1(x,y)\\tau) = \\text{Poisson}(k_1 x \\tau)$\n- $K_2 \\sim \\text{Poisson}(a_2(x,y)\\tau) = \\text{Poisson}(k_2 y \\tau)$\n\n在时间 $t+\\tau$ 的状态向量，记为 $x'$，由更新规则的矩阵形式给出：\n$$\nx' = x + S K\n$$\n代入推导出的 $S$ 和向量 $K$：\n$$\n\\begin{pmatrix} x' \\\\ y' \\end{pmatrix} = \\begin{pmatrix} x \\\\ y \\end{pmatrix} + \\begin{pmatrix} 0  0 \\\\ 1  -1 \\end{pmatrix} \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix} = \\begin{pmatrix} x + 0 \\cdot K_1 + 0 \\cdot K_2 \\\\ y + 1 \\cdot K_1 - 1 \\cdot K_2 \\end{pmatrix} = \\begin{pmatrix} x \\\\ y + K_1 - K_2 \\end{pmatrix}\n$$\n该更新可以表示为映射 $x \\mapsto x + SK$。其分量形式的映射为：\n- $x \\mapsto x$\n- $y \\mapsto y + K_1 - K_2$\n这证实了分子种类 $X$ 的布居数不受影响（它充当催化剂），而分子种类 $Y$ 的布居数在时间间隔 $\\tau$ 内因 $R_1$ 事件的发生次数而增加，因 $R_2$ 事件的发生次数而减少。\n\n问题要求给出 $S$、$a(x,y)$ 和状态更新映射 $x \\mapsto x + S K$。这三个组件构成了该系统一个 $\\tau$-跳跃步骤的完整说明。",
            "answer": "$$\n\\boxed{\n\\begin{align*} S = \\begin{pmatrix} 0  0 \\\\ 1  -1 \\end{pmatrix} \\\\[1.5em] a(x,y) = \\begin{pmatrix} k_1 x \\\\ k_2 y \\end{pmatrix} \\\\[1.5em] x \\mapsto x + S K, \\quad \\text{其中 } x = \\begin{pmatrix} x \\\\ y \\end{pmatrix}, K = \\begin{pmatrix} K_1 \\\\ K_2 \\end{pmatrix}, \\text{且 } K_j \\sim \\text{Poisson}(a_j(x,y)\\tau) \\end{align*}\n}\n$$"
        },
        {
            "introduction": "从理论到实践，这项练习将指导你编写一个显式 tau-leaping 步骤。除了更新系统状态，你还将计算条件漂移和扩散项。这项实践通过将离散的模拟步骤与其所近似的连续时间随机过程联系起来，揭示了系统演化的基本矩，从而加深了你的理解 。",
            "id": "3812859",
            "problem": "考虑一个由化学主方程 (CME) 控制的充分混合的随机反应网络，其中系统状态是 $d$ 个化学物种和 $m$ 个反应通道的整数值布居数向量 $X(t) \\in \\mathbb{Z}_{\\ge 0}^d$。设化学计量矩阵为 $S \\in \\mathbb{Z}^{d \\times m}$，其中每一列 $S_{\\cdot j}$ 给出反应 $j$ 单次触发所产生的物种计数的净变化。在质量作用动力学下，每个反应 $j$ 都有一个反应倾向 $a_j(x)$，该倾向取决于当前状态 $x$ 和一个速率常数 $c_j$，并编码了反应触发的瞬时风险。\n\n你的任务是为一个指定的三反应网络实现一个显式 $\\tau$-跨步，并从第一性原理出发，推导和计算在当前状态 $X^n$ 下的条件漂移项和扩散项。在长度为 $\\tau$ 的短时间间隔上的 $\\tau$-跨步近似假设反应倾向在其于 $X^n$ 处的值附近保持近似恒定，并且该时间间隔内每个反应的触发次数由与 CME 一致的独立计数统计描述。\n\n从 CME 和质量作用动力学的基础定义出发，推导以下所需表达式：\n- 从 $X^n$ 开始的单次显式 $\\tau$-跨步产生的更新 $X^{n+1}$。\n- 在 $X^n$ 处计算的条件漂移向量。\n- 在 $X^n$ 处计算的条件扩散矩阵。\n\n对于以下网络，所有物种和反应均已标记，并应完全按照规定使用质量作用倾向：\n- 物种：$A$ 和 $B$。\n- 反应 ($m = 3$)：\n    - $R_1$: $A + B \\to 2B$，化学计量变化为 $(-1, +1)$，质量作用倾向为 $a_1(x) = c_1 \\, x_A \\, x_B$。\n    - $R_2$: $B \\to \\varnothing$，化学计量变化为 $(0, -1)$，质量作用倾向为 $a_2(x) = c_2 \\, x_B$。\n    - $R_3$: $\\varnothing \\to A$，化学计量变化为 $(+1, 0)$，质量作用倾向为 $a_3(x) = c_3$。\n- 化学计量矩阵（列对应于 $R_1$, $R_2$, $R_3$）：\n$$\nS = \\begin{bmatrix}\n-1  0  +1 \\\\\n+1  -1  0\n\\end{bmatrix}.\n$$\n\n按如下方式实现显式 $\\tau$-跨步：\n- 给定 $X^n$、一个速率常数向量 $c = (c_1,c_2,c_3)$ 和一个时间步长 $\\tau > 0$，根据质量作用动力学计算倾向 $a_j(X^n)$，其中 $j \\in \\{1,2,3\\}$。\n- 为保证可复现性，使用固定的随机数生成器种子，在 $\\tau$-跨步近似的标准独立性假设下，对长度为 $\\tau$ 的时间间隔内的反应计数进行采样。\n- 根据化学计量矩阵和采样的反应计数更新 $X^{n+1}$。\n- 计算由该近似和反应触发的独立性所隐含的在 $X^n$ 处的条件漂移向量和在 $X^n$ 处的条件扩散矩阵。报告这些值时需按单位时间计算（即不乘以 $\\tau$）。\n\n你的程序必须评估以下测试套件。每个测试用例由 $(X^n, c, \\tau)$ 给出：\n- 用例 1 （正常路径）：$X^n = (50, 10)$, $c = (10^{-3}, 2 \\times 10^{-1}, 5)$, $\\tau = 10^{-1}$。\n- 用例 2 （中等活动）：$X^n = (100, 200)$, $c = (5 \\times 10^{-4}, 5 \\times 10^{-2}, 1)$, $\\tau = 2$。\n- 用例 3 （零倾向边界）：$X^n = (0, 0)$, $c = (10^{-3}, 2 \\times 10^{-1}, 0)$, $\\tau = 1$。\n\n对于每个测试用例，你的程序必须计算并返回一个包含以下内容的列表：\n- 更新后的状态 $X^{n+1}$，形式为整数列表。\n- 在 $X^n$ 处的条件漂移向量，形式为浮点数列表（按单位时间）。\n- 在 $X^n$ 处的条件扩散矩阵，形式为对应于按行主序展开的矩阵的浮点数列表（按单位时间）。\n\n最终输出格式要求：\n- 你的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表形式的结果。顶层列表的每个元素对应一个测试用例，并且其本身必须是一个包含上述三项的、由方括号括起来的逗号分隔列表。例如，输出格式为 $[r_1,r_2,r_3]$，其中对于用例 $k$，$r_k = [X^{n+1}, \\text{drift}, \\text{diff\\_flat}]$。\n\n不涉及物理单位；所有量均为无量纲的计数和速率。对所有随机抽样使用固定的随机种子 $123456789$，以确保可复现性。",
            "solution": "该问题要求对给定随机反应网络的显式 τ-跨步算法的单步进行实现和理论论证。这涉及从化学主方程 (CME) 及其近似的第一性原理出发，推导状态更新规则、条件漂移向量和条件扩散矩阵。\n\n### 1. 理论基础\n\n一个充分混合的随机化学系统的演化由化学主方程 (CME) 控制。CME 描述了系统处于状态 $X(t)=x$ 的概率 $P(x, t)$ 的时间演化，其中 $x \\in \\mathbb{Z}_{\\ge 0}^d$ 是物种布居数向量。对于一个有 $m$ 个反应通道的系统，CME 为：\n$$\n\\frac{dP(x, t)}{dt} = \\sum_{j=1}^{m} \\left[ a_j(x - S_{\\cdot j}) P(x - S_{\\cdot j}, t) - a_j(x) P(x, t) \\right]\n$$\n这里，$a_j(x)$ 是反应 $j$ 的倾向函数，表示在状态为 $x$ 时单位时间内发生反应 $j$ 的概率。$S_{\\cdot j}$ 是化学计量矩阵 $S$ 的第 $j$ 列，表示反应 $j$ 单次发生引起的物种数量变化。\n\n显式 τ-跨步方法是一种将系统状态推进一个时间步长 $\\tau$ 的近似方案。它依赖于“跨步条件”：$\\tau$ 必须足够小，以至于倾向函数 $a_j(x)$ 在时间区间 $[t, t+\\tau]$ 内不发生显著变化。因此，对于 $t' \\in [t, t+\\tau]$，我们可以近似认为 $a_j(X(t')) \\approx a_j(X(t))$。\n\n在此假设下，在该时间间隔内，每个反应 $j$ 的触发成为一个速率恒为 $a_j(X(t))$ 的泊松过程。反应 $j$ 触发的次数 $K_j(\\tau)$ 是从泊松分布中抽样的随机变量。关键在于，假设各个反应通道是相互独立的。\n$$\nK_j(\\tau) \\sim \\text{Poisson}(\\lambda_j) \\quad \\text{其中速率为 } \\lambda_j = a_j(X(t)) \\tau\n$$\n\n### 2. 状态更新规则\n\n设 $X^n$ 是在时间 $t_n$ 的状态。在时间 $t_{n+1} = t_n + \\tau$ 的状态，记为 $X^{n+1}$，是通过将该时间间隔内所有反应触发引起的变化相加得到的。\n$$\nX^{n+1} = X^n + \\sum_{j=1}^{m} K_j S_{\\cdot j} = X^n + S K\n$$\n其中 $K = [K_1, K_2, \\dots, K_m]^T$ 是采样的反应计数的向量。\n\n对于指定的网络：\n- 物种：$A$, $B$。状态向量：$X = [x_A, x_B]^T$。\n- 化学计量矩阵：$S = \\begin{bmatrix} -1  0  1 \\\\ 1  -1  0 \\end{bmatrix}$。\n- 倾向 (质量作用)：$a_1(X) = c_1 x_A x_B$, $a_2(X) = c_2 x_B$, $a_3(X) = c_3$。\n\n逐步更新过程如下：\n1. 给定 $X^n = [x_A^n, x_B^n]^T$，常数 $c=[c_1, c_2, c_3]^T$，以及时间步长 $\\tau$。\n2. 计算在 $X^n$ 处的倾向：\n   - $a_1(X^n) = c_1 x_A^n x_B^n$\n   - $a_2(X^n) = c_2 x_B^n$\n   - $a_3(X^n) = c_3$\n3. 从独立的泊松分布中抽样反应触发次数 $K_j$：\n   - $K_1 \\sim \\text{Poisson}(a_1(X^n)\\tau)$\n   - $K_2 \\sim \\text{Poisson}(a_2(X^n)\\tau)$\n   - $K_3 \\sim \\text{Poisson}(a_3(X^n)\\tau)$\n4. 计算新状态 $X^{n+1}$：\n   $$\n   X^{n+1} = \\begin{bmatrix} x_A^n \\\\ x_B^n \\end{bmatrix} + \\begin{bmatrix} -1  0  1 \\\\ 1  -1  0 \\end{bmatrix} \\begin{bmatrix} K_1 \\\\ K_2 \\\\ K_3 \\end{bmatrix} = \\begin{bmatrix} x_A^n - K_1 + K_3 \\\\ x_B^n + K_1 - K_2 \\end{bmatrix}\n   $$\n\n### 3. 条件漂移与扩散\n\n条件漂移向量 $\\mu(x)$ 和扩散矩阵 $D(x)$ 表征了状态变化 $\\Delta X = X(t+\\tau) - X(t)$ 在给定 $X(t)=x$ 条件下的无穷小矩。它们被定义为 $\\tau \\to 0$ 时的极限，并按单位时间报告。\n\n**漂移向量：** 漂移是状态的期望变化率。\n$$\n\\mu(x) = \\lim_{\\tau \\to 0} \\frac{1}{\\tau} \\mathbb{E}[\\Delta X | X(t)=x]\n$$\n在 $\\tau$-跨步框架内，$\\Delta X = S K$。利用期望的线性性质以及泊松变量的性质 $\\mathbb{E}[K_j] = a_j(x)\\tau$：\n$$\n\\mathbb{E}[\\Delta X | X(t)=x] = \\mathbb{E}[S K] = S \\mathbb{E}[K] = S (a(x)\\tau) = (S a(x)) \\tau\n$$\n其中 $a(x) = [a_1(x), a_2(x), a_3(x)]^T$。\n除以 $\\tau$ 得到单位时间内的漂移向量：\n$$\n\\mu(x) = S a(x) = \\begin{bmatrix} -1  0  1 \\\\ 1  -1  0 \\end{bmatrix} \\begin{bmatrix} a_1(x) \\\\ a_2(x) \\\\ a_3(x) \\end{bmatrix} = \\begin{bmatrix} -a_1(x) + a_3(x) \\\\ a_1(x) - a_2(x) \\end{bmatrix}\n$$\n\n**扩散矩阵：** 扩散矩阵与状态变化的二阶矩有关。\n$$\nD(x) = \\lim_{\\tau \\to 0} \\frac{1}{\\tau} \\mathbb{E}[\\Delta X \\Delta X^T | X(t)=x]\n$$\n我们计算 $\\Delta X \\Delta X^T = (SK)(SK)^T = S K K^T S^T$ 的期望：\n$$\n\\mathbb{E}[\\Delta X \\Delta X^T] = S \\mathbb{E}[K K^T] S^T\n$$\n矩阵 $\\mathbb{E}[K K^T]$ 的元素是 $\\mathbb{E}[K_i K_j]$。对于独立的泊松变量，我们有：\n- 对于 $i \\neq j$：$\\mathbb{E}[K_i K_j] = \\mathbb{E}[K_i]\\mathbb{E}[K_j] = (a_i(x)\\tau)(a_j(x)\\tau) = a_i(x)a_j(x)\\tau^2$。\n- 对于 $i = j$：$\\mathbb{E}[K_j^2] = \\text{Var}(K_j) + (\\mathbb{E}[K_j])^2 = a_j(x)\\tau + (a_j(x)\\tau)^2$。\n这可以紧凑地写为 $\\mathbb{E}[K_i K_j] = a_i(x)a_j(x)\\tau^2 + \\delta_{ij} a_j(x)\\tau$，其中 $\\delta_{ij}$ 是克罗内克 delta。\n矩阵 $\\mathbb{E}[K K^T]$ 是 $\\tau^2 a(x) a(x)^T + \\tau \\, \\text{diag}(a(x))$。\n将其代回：\n$$\n\\mathbb{E}[\\Delta X \\Delta X^T] = S (\\tau^2 a(x) a(x)^T + \\tau \\, \\text{diag}(a(x))) S^T = \\tau^2 (S a(x))(S a(x))^T + \\tau S \\, \\text{diag}(a(x)) S^T\n$$\n除以 $\\tau$ 并取极限 $\\tau \\to 0$，$\\tau^2$ 项消失：\n$$\nD(x) = \\lim_{\\tau \\to 0} \\left( \\tau (S a(x))(S a(x))^T + S \\, \\text{diag}(a(x)) S^T \\right) = S \\, \\text{diag}(a(x)) S^T\n$$\n这可以计算为 $\\sum_{j=1}^m a_j(x) S_{\\cdot j} S_{\\cdot j}^T$。对于我们的系统：\n$$\nD(x) = a_1(x) \\begin{bmatrix} 1  -1 \\\\ -1  1 \\end{bmatrix} + a_2(x) \\begin{bmatrix} 0  0 \\\\ 0  1 \\end{bmatrix} + a_3(x) \\begin{bmatrix} 1  0 \\\\ 0  0 \\end{bmatrix} = \\begin{bmatrix} a_1(x) + a_3(x)  -a_1(x) \\\\ -a_1(x)  a_1(x) + a_2(x) \\end{bmatrix}\n$$\n这些推导出的 $\\mu(x)$ 和 $D(x)$ 的公式在 $X^n$ 处进行求值，以找到所需的条件项。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements one explicit tau-leaping step for a 3-reaction network and\n    computes the conditional drift and diffusion terms.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: (Xn, c, tau)\n        (np.array([50, 10]), np.array([1e-3, 2e-1, 5.0]), 1e-1),\n        # Case 2: (Xn, c, tau)\n        (np.array([100, 200]), np.array([5e-4, 5e-2, 1.0]), 2.0),\n        # Case 3: (Xn, c, tau)\n        (np.array([0, 0]), np.array([1e-3, 2e-1, 0.0]), 1.0),\n    ]\n\n    # Use a fixed random seed for reproducibility as requested.\n    # The generator is created once and used for all subsequent sampling.\n    rng = np.random.default_rng(123456789)\n\n    # Stoichiometry matrix S\n    # Columns correspond to R1, R2, R3\n    # Rows correspond to species A, B\n    S = np.array([\n        [-1, 0, 1],\n        [1, -1, 0]\n    ])\n\n    results = []\n    for Xn, c, tau in test_cases:\n        # Unpack species counts and rate constants\n        x_A, x_B = Xn\n        c1, c2, c3 = c\n\n        # 1. Compute propensities a_j(X^n)\n        a1 = c1 * x_A * x_B\n        a2 = c2 * x_B\n        a3 = c3\n        propensities = np.array([a1, a2, a3])\n\n        # 2. Sample reaction counts K_j\n        # The number of firings of each reaction j in interval tau is\n        # drawn from a Poisson distribution with mean a_j * tau.\n        poisson_means = propensities * tau\n        K = rng.poisson(poisson_means)\n        \n        # 3. Update state to X^{n+1}\n        # X^{n+1} = X^n + S * K\n        delta_X = S @ K\n        Xn1 = Xn + delta_X\n        \n        # 4. Compute conditional drift vector (per unit time)\n        # mu = S * a(X^n)\n        drift_vector = S @ propensities\n        \n        # 5. Compute conditional diffusion matrix (per unit time)\n        # D = S * diag(a(X^n)) * S^T\n        # which is equivalent to sum(a_j * S_j * S_j^T for j in reactions)\n        # For this specific system, the matrix is:\n        # [ a1+a3  -a1   ]\n        # [ -a1    a1+a2 ]\n        D = np.array([\n            [a1 + a3, -a1],\n            [-a1, a1 + a2]\n        ])\n        diff_flat = D.flatten()\n\n        # Append the list of results for this case\n        # Ensure data types match the requirements (int for state, float for others)\n        case_result = [\n            Xn1.tolist(),\n            drift_vector.tolist(),\n            diff_flat.tolist()\n        ]\n        results.append(case_result)\n\n    # Format the final output string as a list of lists.\n    # str() on a list automatically includes spaces, which is a standard representation.\n    # The format requirement '[r1,r2,r3]' is achieved by joining string\n    # representations of each result list.\n    output_str = f\"[{','.join(map(str, results))}]\"\n    \n    # The final print statement in the exact required format.\n    # The `replace` calls are to remove spaces for a more compact representation,\n    # matching a common interpretation of such formatting requirements.\n    print(output_str.replace(\" \", \"\"))\n\nsolve()\n```"
        },
        {
            "introduction": "显式 tau-leaping 方法的一个关键挑战是泊松采样可能导致非物理性的负种群数量。这项练习直面这个关键问题。你将为一个简单的衰变过程分析此类事件发生的概率，并设计一种“跳跃后检查与回滚”策略，这是确保模拟的稳健性和物理有效性的一项基本技术 。",
            "id": "3812871",
            "problem": "给定一个在充分混合极限下，由化学主方程（CME）控制的单物种随机反应网络，该网络包含一个单一的线性衰变反应 $X \\xrightarrow{c} \\varnothing$，其中 $c$ 是一个单位为（$\\text{s}^{-1}$）的正速率常数。在跳跃条件下，tau-跳跃方法通过假设倾向函数在 $[t,t+\\tau)$ 区间内恒定，并在此区间内抽取一个随机的反应发生次数，从而将系统推进一个固定的时间增量 $\\tau$（单位为秒）。考虑标准的跳跃后检查机制，当一个尝试性步骤会导致任何物种数量变为负值时，该机制会拒绝此步骤，随后回滚到前一个状态，并减小时间增量 $\\tau$，直到步骤被接受为止。\n\n任务 A (推导)：使用 CME 的基本定律和核心定义以及 tau-跳跃方法的基本假设，从线性衰变网络的倾向函数定义、在恒定风险率下区间内事件计数由泊松过程描述这一经过充分检验的事实以及分子数的离散性质出发。从第一性原理推导，不引入简化公式，得到在状态 $x$（一个非负整数分子数）和时间增量 $\\tau$（单位为秒）下，一个 tau-跳跃尝试性步骤被拒绝的概率的精确表达式。如果尝试性更新将产生负数计数，则发生拒绝。\n\n任务 B (算法设计)：设计一个跳跃后检查与回滚策略，其操作如下。给定当前状态 $x$、速率 $c$ 和初始 $\\tau$，通过在 $[t,t+\\tau)$ 区间内抽取反应发生次数并计算尝试性的下一状态，来执行一次尝试性 tau-跳跃。如果任何物种数量将变为负值，则拒绝该尝试性步骤，回滚到前一个状态，将 $\\tau$ 乘以一个严格介于 $0$ 和 $1$ 之间的乘法因子（例如，将 $\\tau$ 减半），然后重试。提供清晰的描述，解释为什么对于线性衰变网络，该策略几乎必然会以一个被接受的步骤终止，以及其行为如何依赖于参数。\n\n任务 C (程序要求)：实现一个程序，为下述每个测试用例计算上述线性衰变网络中第一个尝试性 tau-跳跃步骤被拒绝的解析概率。使用科学上符合实际的单位：$c$ 的单位为（$\\text{s}^{-1}$），$\\tau$ 的单位为（$\\text{s}$），而 $x$ 为分子数（无量纲整数）。每个测试用例所需的输出是等于任务 A 中推导出的拒绝概率的单个无单位十进制数。您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表。每个概率必须四舍五入到十二位小数。\n\n测试套件：\n- 案例 1 （理想路径）：$c=0.1\\,\\text{s}^{-1}$，$x=50$，$\\tau=0.2\\,\\text{s}$。\n- 案例 2 （中度拒绝）：$c=1.0\\,\\text{s}^{-1}$，$x=3$，$\\tau=2.0\\,\\text{s}$。\n- 案例 3 （边界条件）：$c=0.2\\,\\text{s}^{-1}$，$x=0$，$\\tau=1.0\\,\\text{s}$。\n- 案例 4 （大时间边缘情况）：$c=0.5\\,\\text{s}^{-1}$，$x=10$，$\\tau=10.0\\,\\text{s}$。\n- 案例 5 （小时间边缘情况）：$c=0.05\\,\\text{s}^{-1}$，$x=1$，$\\tau=0.5\\,\\text{s}$。\n\n最终输出格式规范：您的程序应生成单行输出，其中包含一个格式完全为 `[r1,r2,r3,r4,r5]` 的列表，其中每个 $r_i$ 是案例 $i$ 的拒绝概率，四舍五入到十二位小数。",
            "solution": "问题陈述已经过严格验证，被认为是具有科学依据、适定且客观的。它提出了多尺度建模与分析领域中的一个标准的、非平凡的问题，具体涉及用于随机模拟的 tau-跳跃方法。所有必要的数据和定义均已提供，不存在矛盾或歧义。该问题是有效的。\n\n### 任务 A：拒绝概率的推导\n\n我们的任务是从第一性原理推导单物种线性衰变网络的尝试性 tau-跳跃步骤被拒绝的概率。\n\n1.  **系统定义**：该系统由单一化学物种 $X$ 组成，经历线性衰变反应：\n    $$ X \\xrightarrow{c} \\varnothing $$\n    系统在时间 $t$ 的状态由 $X$ 的分子数给出，记为非负整数 $x(t)$。速率常数为 $c$，单位为 $\\text{s}^{-1}$。\n\n2.  **倾向函数**：倾向函数 $a(x)$ 给定系统处于状态 $x$ 时，反应发生的瞬时概率速率。对于充分混合体积中的一级反应，该速率与反应物分子数成正比：\n    $$ a(x) = c \\cdot x $$\n\n3.  **Tau-跳跃近似**：显式 tau-跳跃方法通过假设倾向函数在时间区间 $[t, t+\\tau)$ 内保持不变来近似系统的演化。这个恒定的倾向函数值取自区间开始的时刻，即 $a(x(t))$。\n\n4.  **泊松过程**：具有恒定事件率（风险率）的过程是泊松过程。因此，在 tau-跳跃假设下，区间 $[t, t+\\tau)$ 内发生的反应事件数 $K$ 是一个从泊松分布中抽取的随机变量。\n\n5.  **泊松参数 $\\lambda$**：泊松分布的参数 $\\lambda$ 是该区间内事件的期望数。它被计算为恒定速率（倾向）与区间持续时间的乘积：\n    $$ \\lambda = a(x(t)) \\cdot \\tau = (c \\cdot x(t)) \\cdot \\tau $$\n    令 $x$ 代表当前状态 $x(t)$，则参数为 $\\lambda = cx\\tau$。观测到恰好 $k$ 次反应事件的概率由泊松概率质量函数（PMF）给出：\n    $$ P(K=k) = \\frac{\\lambda^k e^{-\\lambda}}{k!} = \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    其中 $k$ 是一个非负整数。\n\n6.  **状态更新与拒绝条件**：每次反应事件消耗一个物种 $X$ 的分子。如果发生 $k$ 次反应，在时间 $t+\\tau$ 的尝试性状态（记为 $x'$）是：\n    $$ x' = x - k $$\n    如果任何物种数量变为负数，跳跃后检查会拒绝此尝试性步骤。在这个单物种系统中，拒绝的条件是：\n    $$ x'  0 \\implies x - k  0 \\implies k > x $$\n    因此，如果随机抽取的反应事件数 $k$ 严格大于区间开始时存在的分子数 $x$，则发生拒绝。\n\n7.  **拒绝概率**：拒绝概率 $P_{\\text{reject}}$ 是随机变量 $K$ 取值大于 $x$ 的概率。\n    $$ P_{\\text{reject}}(x, c, \\tau) = P(K > x) $$\n    这可以表示为所有可拒绝结果概率的无穷级数：\n    $$ P_{\\text{reject}} = \\sum_{k=x+1}^{\\infty} P(K=k) = \\sum_{k=x+1}^{\\infty} \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    为计算方便，使用补集法则和泊松分布的累积分布函数（CDF）$F_K(x) = P(K \\le x)$ 来表示此概率更为便捷：\n    $$ P_{\\text{reject}} = 1 - P(K \\le x) = 1 - \\sum_{k=0}^{x} P(K=k) = 1 - \\sum_{k=0}^{x} \\frac{(cx\\tau)^k e^{-cx\\tau}}{k!} $$\n    该表达式是从第一性原理推导出的第一个尝试性步骤被拒绝的精确解析概率。\n\n8.  **边界情况 $x=0$**：如果系统起始时有 $x=0$ 个分子，则倾向函数为 $a(0) = c \\cdot 0 = 0$。泊松参数为 $\\lambda = 0 \\cdot c \\tau = 0$。$\\lambda=0$ 的泊松分布是位于 $k=0$ 的一个点质量，意味着 $P(K=0)=1$ 且 $P(K0)=0$。拒绝条件是 $k  0$。因此，拒绝概率为 $P(K0) = 0$。这与化学现实相符：如果没有分子存在，反应就不会发生。我们推导的公式也是一致的，因为 $P_{\\text{reject}} = P(K  0) = 1 - P(K \\le 0) = 1 - P(K=0) = 1 - \\frac{0^0 e^{-0}}{0!} = 1 - 1 = 0$，这里我们使用标准约定 $0^0=1$。\n\n### 任务 B：跳跃后检查、回滚策略与终止性\n\n跳跃后检查与回滚策略是确保 tau-跳跃中非负粒子数这一物理约束的关键组成部分。\n\n1.  **算法设计**：给定初始状态 $x$、速率常数 $c$ 和初始时间步长 $\\tau_{\\text{init}}$：\n    a. 初始化当前尝试的时间步长：$\\tau \\leftarrow \\tau_{\\text{init}}$。\n    b. **开始回滚循环**：\n        i. 计算泊松参数 $\\lambda = cx\\tau$。\n        ii. 从泊松分布中抽取一个随机的反应发生次数 $k$：$k \\sim \\text{Poisson}(\\lambda)$。\n        iii. **检查有效性**：如果发生次数小于或等于当前粒子数，即 $k \\le x$，则该步骤有效。接受该步骤，更新状态 $x \\leftarrow x-k$，并退出循环。\n        iv. **处理拒绝**：如果 $k > x$，则该步骤无效。拒绝该步骤，保持状态为 $x$。将时间步长乘以一个因子 $f$（其中 $0  f  1$）来减小它：$\\tau \\leftarrow f \\cdot \\tau$。返回循环开始处（步骤 1b），以更小的 $\\tau$ 重试。\n\n2.  **终止性论证**：该策略保证以概率 1（几乎必然）终止于一个被接受的步骤。其推理如下：\n    *   每次步骤被拒绝时，时间增量 $\\tau$ 都会严格减小。经过 $n$ 次拒绝后，时间步长变为 $\\tau_n = \\tau_{\\text{init}} \\cdot f^n$。\n    *   由于 $0  f  1$，随着重试次数 $n \\to \\infty$，时间步长 $\\tau_n \\to 0$。\n    *   泊松参数 $\\lambda_n = cx\\tau_n$ 也趋近于 $0$。\n    *   接受概率为 $P_{\\text{accept}} = P(K \\le x)$，其中 $K \\sim \\text{Poisson}(\\lambda_n)$。由于粒子数 $x$ 是一个非负整数，接受条件始终包含 $K=0$ 这一事件。\n    *   因此，接受概率的下界是零次反应的概率：$P_{\\text{accept}} \\ge P(K=0)$。\n    *   对于泊松分布，$P(K=0) = e^{-\\lambda_n}$。当 $\\tau_n \\to 0$ 时，我们有 $\\lambda_n \\to 0$，因此 $P(K=0) = e^{-\\lambda_n} \\to e^{-0} = 1$。\n    *   由于接受概率随着重试次数的增加而趋近于 1，无限次连续拒绝的概率为 0。因此，循环必须终止。\n\n3.  **参数依赖性**：\n    *   **$c$ 和初始 $\\tau$**：拒绝概率与乘积 $c\\tau$ 成比例。较大的 $c$ 值或初始 $\\tau$ 值会导致较大的初始 $\\lambda$，从而增加了泊松分布的离散程度，使其更有可能抽取到一个大的 $k > x$。这导致了更高的初始拒绝概率和更多的预期回滚迭代次数。\n    *   **$x$**：$x$ 的影响是双重的。它增加了泊松分布的均值（$\\lambda = cx\\tau$），但同时也提高了拒绝的阈值（$k>x$）。对于大的均值 $\\lambda$，泊松分布近似于正态分布 $N(\\lambda, \\lambda)$。如果均值 $\\lambda=cx\\tau$ 显著大于阈值 $x$（当 $c\\tau > 1$ 时发生），则拒绝概率 $P(Kx)$ 会很高。反之，如果 $c\\tau  1$，则该概率较低。\n    *   **缩减因子 $f$**：一个小的 $f$（例如 0.1）会导致 $\\tau$ 迅速缩小，确保回滚循环快速终止，但可能产生一个效率低下的过小最终时间步长。一个大的 $f$（例如 0.9）会使 $\\tau$ 缓慢减小，可能需要更多迭代，但能找到一个更大的最终被接受的步长，这对于整个模拟进程更有效率。通常选择 $f=0.5$ 是为了平衡这些考虑。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import poisson\n\ndef solve():\n    \"\"\"\n    Computes the analytical probability of rejection for the first tentative\n    tau-leap step in a single-species linear decay network for a suite of test cases.\n    \"\"\"\n    # Test cases from the problem statement.\n    # Each case is a tuple (c, x, tau) where:\n    # c: rate constant in s^-1\n    # x: molecule count (dimensionless integer)\n    # tau: time increment in s\n    test_cases = [\n        (0.1, 50, 0.2),   # Case 1\n        (1.0, 3, 2.0),   # Case 2\n        (0.2, 0, 1.0),   # Case 3\n        (0.5, 10, 10.0),  # Case 4\n        (0.05, 1, 0.5),    # Case 5\n    ]\n\n    results = []\n    for c, x, tau in test_cases:\n        # The species count x must be an integer for the Poisson distribution functions.\n        # The problem statement guarantees x is an integer, so we cast to ensure type correctness.\n        x_int = int(x)\n\n        # The core of the tau-leaping method assumes the number of reaction events K\n        # in the interval tau follows a Poisson distribution. The parameter lambda\n        # is the expected number of events, given by propensity * tau.\n        # Propensity for X - 0 is a(x) = c * x.\n        lambda_param = c * x * tau\n\n        # Rejection occurs if the number of events k is greater than the current\n        # population x, as this would lead to a negative count (x - k  0).\n        # The rejection probability is therefore P(K  x), where K ~ Poisson(lambda).\n        # This is calculated using the survival function (sf) of the Poisson distribution,\n        # which is defined as sf(k, mu) = P(X  k) for a random variable X ~ Poisson(mu).\n        # Using sf is numerically more stable than calculating 1 - cdf(k, mu),\n        # especially for values in the tail of the distribution.\n        rejection_prob = poisson.sf(x_int, lambda_param)\n\n        # The result must be formatted as a string rounded to twelve decimal places.\n        results.append(f\"{rejection_prob:.12f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}