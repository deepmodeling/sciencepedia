{
    "hands_on_practices": [
        {
            "introduction": "任何数值积分方案的有效性都取决于其稳定性，这对于耦合了快慢尺度不同积分方法的时间桥接方案而言尤为关键。本练习通过推导一种常见的隐式-显式（IMEX）方案的放大因子和稳定性区域，来探索其稳定性。掌握这种分析方法 ，你将能够确定允许的最大宏观时间步长，这是确保多尺度模拟兼具稳定性和效率的关键参数。",
            "id": "3813574",
            "problem": "考虑一个由 $\\dot{u}(t) = A_{f} u(t) + A_{s} u(t)$ 给出的连续时间可加分裂线性系统，其中 $A_{f} \\in \\mathbb{R}^{n \\times n}$ 模拟快、刚性动力学，而 $A_{s} \\in \\mathbb{R}^{n \\times n}$ 模拟慢动力学，且 $\\|A_{f}\\| \\gg \\|A_{s}\\|$。假设 $A_{f}$ 的所有特征值都具有严格为负的实部，并且 $A_{s}$ 可对角化，其实特征值位于区间 $(-\\infty, 0]$ 内。考虑以下隐式-显式（IMEX）类型的时间桥接格式，该格式在一个大小为 $\\Delta t$ 的宏观步长内，对快算子进行隐式处理，对慢算子进行显式处理：\n$$(I - \\Delta t\\, A_{f})\\, u^{n+1} \\;=\\; \\big(I + \\Delta t\\, A_{s}\\big)\\, u^{n}。$$\n设标量线性测试问题为 $\\dot{y}(t) = \\lambda_{f} y(t) + \\lambda_{s} y(t)$，其中 $\\lambda_{f} \\in \\mathbb{C}$ 满足 $\\operatorname{Re}(\\lambda_{f}) \\leq 0$，$\\lambda_{s} \\in \\mathbb{R}$ 满足 $\\lambda_{s} \\leq 0$。定义无量纲参数 $z_{f} = \\Delta t\\, \\lambda_{f}$ 和 $z_{s} = \\Delta t\\, \\lambda_{s}$。\n\n从 Dahlquist 测试方程的数值方法的基本线性稳定性分析出发，推导上述 IMEX 格式的标量放大因子，并计算其在 $(z_{f}, z_{s})$ 平面上的绝对稳定区域。然后，在快部对所有 $\\operatorname{Re}(z_{f}) \\leq 0$ 都稳定的假设下，推导出允许的宏观步长 $\\Delta t$ 关于慢特征值最大模值的封闭形式表达式。令 $\\alpha > 0$ 表示量\n$$\\alpha \\;=\\; \\max_{1 \\leq j \\leq n} |\\lambda_{s,j}|,$$\n其中 $\\{\\lambda_{s,j}\\}_{j=1}^{n}$ 是 $A_{s}$ 的特征值，全部位于非正实轴上。以秒为单位表示最终的 $\\Delta t$。最终答案必须是最大允许宏观步长 $\\Delta t$ 关于 $\\alpha$ 的单个封闭形式解析表达式；无需四舍五入。",
            "solution": "问题要求对于给定的隐式-显式（IMEX）时间桥接格式，求出保证稳定性的最大允许宏观步长 $\\Delta t$。推导过程必须从第一性原理的线性稳定性分析出发。\n\n首先，我们验证问题陈述的有效性。\n问题提供了一个线性常微分方程组 $\\dot{u}(t) = A_{f} u(t) + A_{s} u(t)$，其中矩阵算子被可加地分裂为一个刚性部分 $A_f$ 和一个非刚性部分 $A_s$。$A_f$ 和 $A_s$ 特征值的性质被明确指定，并与其作用一致。问题提出了一个 IMEX 格式，这是处理此类系统的标准技术。分析将在标量 Dahlquist 测试方程 $\\dot{y}(t) = \\lambda_{f} y(t) + \\lambda_{s} y(t)$ 上进行，这是线性稳定性分析的标准程序。所有术语和目标都定义明确，在数学上和科学上都是合理的。问题是自洽、一致且适定的。因此，我们认为该问题是有效的，可以着手求解。\n\nIMEX 格式由下式给出：\n$$(I - \\Delta t\\, A_{f})\\, u^{n+1} \\;=\\; \\big(I + \\Delta t\\, A_{s}\\big)\\, u^{n}$$\n为了分析该格式的稳定性，我们将其应用于标量线性测试问题 $\\dot{y}(t) = \\lambda_{f} y(t) + \\lambda_{s} y(t)$，其中 $\\lambda_f$ 和 $\\lambda_s$ 是分别代表快、慢算子特征值的标量。该格式变为：\n$$(1 - \\Delta t\\, \\lambda_{f})\\, y^{n+1} \\;=\\; (1 + \\Delta t\\, \\lambda_{s})\\, y^{n}$$\n标量放大因子 $G$ 由关系式 $y^{n+1} = G y^{n}$ 定义。从该格式中，我们可以解出 $G$：\n$$G \\;=\\; \\frac{1 + \\Delta t\\, \\lambda_{s}}{1 - \\Delta t\\, \\lambda_{f}}$$\n使用无量纲参数 $z_{f} = \\Delta t\\, \\lambda_{f}$ 和 $z_{s} = \\Delta t\\, \\lambda_{s}$，放大因子可以写为：\n$$G(z_f, z_s) \\;=\\; \\frac{1 + z_{s}}{1 - z_{f}}$$\n为使数值格式绝对稳定，放大因子的模必须不超过 1，即 $|G(z_f, z_s)| \\leq 1$。\n$$ \\left| \\frac{1 + z_{s}}{1 - z_{f}} \\right| \\leq 1 $$\n这个不等式可以重写为 $|1 + z_{s}| \\leq |1 - z_{f}|$。\n\n问题指明了特征值的域：$\\lambda_{f} \\in \\mathbb{C}$ 且 $\\operatorname{Re}(\\lambda_{f}) \\leq 0$，以及 $\\lambda_{s} \\in \\mathbb{R}$ 且 $\\lambda_{s} \\leq 0$。因此，对于任何 $\\Delta t > 0$，我们有 $z_{f} \\in \\mathbb{C}$ 且 $\\operatorname{Re}(z_{f}) \\leq 0$（复平面的左半部分，包括虚轴），以及 $z_{s} \\in \\mathbb{R}$ 且 $z_{s} \\leq 0$（非正实轴）。\n\n问题陈述的一个关键部分是假设该格式必须对所有可能的快动力学都稳定，即对所有满足 $\\operatorname{Re}(z_f) \\leq 0$ 的 $z_f$ 都稳定。这要求对于给定的 $z_s$，稳定性条件 $|1 + z_{s}| \\leq |1 - z_{f}|$ 必须对左半平面中的每一个 $z_f$ 都成立。为确保这一点，我们必须满足“最坏情况”下 $z_f$ 的条件，即最小化右侧项 $|1 - z_{f}|$ 的 $z_f$。\n\n设 $z_f = x + iy$，其中 $x = \\operatorname{Re}(z_f) \\leq 0$ 且 $y = \\operatorname{Im}(z_f) \\in \\mathbb{R}$。项 $|1 - z_f|$ 变为：\n$$|1 - z_{f}| \\;=\\; |1 - (x + iy)| \\;=\\; |(1-x) - iy| \\;=\\; \\sqrt{(1-x)^2 + y^2}$$\n因为 $x \\le 0$，所以 $1-x \\ge 1$。因此，$(1-x)^2 \\ge 1$。项 $y^2$ 总是非负的。这意味着：\n$$|1 - z_{f}|^2 \\;=\\; (1-x)^2 + y^2 \\;\\geq\\; 1^2 + 0^2 \\;=\\; 1$$\n对于 $\\operatorname{Re}(z_f) \\leq 0$，$|1 - z_{f}|$ 的最小值为 $1$，在 $z_f = 0$ 时取到。\n\n为了使稳定性不等式 $|1 + z_{s}| \\leq |1 - z_{f}|$ 对所有有效的 $z_f$ 成立，我们必须要求：\n$$|1 + z_{s}| \\leq \\min_{\\operatorname{Re}(z_f) \\leq 0} |1 - z_{f}| = 1$$\n这得到了对该格式慢部分的简化稳定性约束：\n$$|1 + z_{s}| \\leq 1$$\n鉴于 $z_s$ 是一个非正实数 ($z_s \\leq 0$)，项 $1+z_s$ 最多为 $1$。绝对值不等式等价于双边不等式：\n$$-1 \\leq 1 + z_{s} \\leq 1$$\n右侧 $1 + z_{s} \\leq 1$ 意味着 $z_s \\leq 0$，这已是已知条件。左侧 $-1 \\leq 1 + z_s$ 意味着：\n$$z_{s} \\geq -2$$\n结合这些，在给定假设下，格式的稳定性仅取决于条件 $-2 \\leq z_s \\leq 0$。这是前向欧拉法的稳定区间，而前向欧拉法恰好是此 IMEX 格式的显式部分。\n\n这个条件必须对慢算子 $A_s$ 的所有特征值都成立。也就是说，对于 $A_s$ 的每一个特征值 $\\lambda_{s,j}$，相应的值 $z_{s,j} = \\Delta t \\, \\lambda_{s,j}$ 必须位于稳定区间 $[-2, 0]$ 内。\n因为所有的 $\\lambda_{s,j} \\leq 0$，对于 $\\Delta t > 0$，我们有 $\\Delta t \\, \\lambda_{s,j} \\leq 0$，所以我们只需要满足：\n$$\\Delta t \\, \\lambda_{s,j} \\geq -2$$\n如果 $\\lambda_{s,j} = 0$，不等式 $0 \\ge -2$ 平凡成立，对 $\\Delta t$没有施加任何约束。如果 $\\lambda_{s,j}  0$，我们可以用它来除，这会反转不等号：\n$$\\Delta t \\leq \\frac{-2}{\\lambda_{s,j}} = \\frac{2}{|\\lambda_{s,j}|}$$\n这必须对所有对应非零特征值的 $j$ 成立。为确保它对所有这些特征值同时成立，$\\Delta t$ 必须小于或等于这些上界的最小值：\n$$\\Delta t \\leq \\min_{j: \\lambda_{s,j} \\neq 0} \\left( \\frac{2}{|\\lambda_{s,j}|} \\right)$$\n集合 $\\{ \\frac{2}{|\\lambda_{s,j}|} \\}$ 的最小值由 $|\\lambda_{s,j}|$ 的最大值决定。问题将此量定义为 $\\alpha = \\max_{1 \\leq j \\leq n} |\\lambda_{s,j}|$。因此，对宏观步长的约束变为：\n$$\\Delta t \\leq \\frac{2}{\\alpha}$$\n因此，最大允许宏观步长是此不等式的上界。如果特征值 $\\lambda_{s,j}$ 的单位是 $s^{-1}$，那么 $\\alpha$ 的单位也是 $s^{-1}$，并且最终 $\\Delta t$ 的表达式将按要求以秒为单位。\n\n最终答案是这个最大步长的解析表达式。",
            "answer": "$$\n\\boxed{\\frac{2}{\\alpha}}\n$$"
        },
        {
            "introduction": "一个优秀的时间桥接方案不仅要稳定，还必须具备计算效率。这需要在通过长时间微观模拟获得的精度与通过大步长宏观步进节约的成本之间进行精妙的权衡。本练习  将指导你构建并求解一个约束优化问题，以找到这种理想的平衡点，从而学会在实践中如何设计出最高效的桥接方案。",
            "id": "3813575",
            "problem": "考虑一个多尺度建模中的时间桥接方案，其中宏观积分器通过使用短时长的微观模拟来估计粗略漂移，从而在固定的时间域 $T$ 上推进粗略变量。假设以下具有科学依据的事实：\n\n- 宏观积分器的阶数为 $p \\geq 1$，因此其产生的全局离散化误差贡献与 $a\\,\\Delta t^{p}$ 成比例，其中 $a0$ 为某个常数，$\\Delta t$ 是宏观时间步长。\n- 通过对持续时间为 $\\tau$ 的微观模拟中的遍历快速过程进行平均，得到的粗略漂移的微观估计误差与 $b\\,\\tau^{-1/2}$ 成比例，其中 $b0$ 为某个常数。这与中心极限定理一致，并假设微观模拟的时长大于混合时间，因此偏差可以忽略不计。\n- 单次微观模拟的计算成本与其持续时间成线性关系，即 $C_{\\text{micro}}(\\tau)=\\alpha\\,\\tau$，其中 $\\alpha0$ 是单位微观时间的成本。假设与微观模拟的成本相比，宏观步进的开销可以忽略不计。\n- 在时间域 $T$ 内的宏观步数为 $N=T/\\Delta t$，我们将 $N$ 视为连续变量并忽略取整效应。\n\n将时间域上的总成本定义为 $C_{\\text{tot}}(\\tau,\\Delta t)=N\\,C_{\\text{micro}}(\\tau)$，总误差定义为 $E_{\\text{tot}}(\\tau,\\Delta t)=a\\,\\Delta t^{p}+b\\,\\tau^{-1/2}$。对于给定的误差容限 $\\varepsilon0$，构建一个约束优化问题，在满足 $E_{\\text{tot}}(\\tau,\\Delta t)\\leq \\varepsilon$ 的条件下最小化 $C_{\\text{tot}}(\\tau,\\Delta t)$。推导出最优微观模拟时长 $\\tau^{\\star}$ 和最优宏观时间步长 $\\Delta t^{\\star}$ 关于 $a$、$b$、$p$ 和 $\\varepsilon$ 的显式解析表达式。\n\n将 $\\tau^{\\star}$ 和 $\\Delta t^{\\star}$ 的最终答案表示为关于 $a$、$b$、$p$ 和 $\\varepsilon$ 的封闭形式表达式。无需进行数值计算。最终表达式中无需包含单位。",
            "solution": "问题在于找到最优的微观模拟时长 $\\tau^{\\star}$ 和宏观时间步长 $\\Delta t^{\\star}$，使得在总误差受约束的情况下，总计算成本最小化。这是一个约束优化问题。\n\n给定的量如下：\n总成本函数：$C_{\\text{tot}}(\\tau, \\Delta t) = N\\,C_{\\text{micro}}(\\tau)$，其中 $N = T/\\Delta t$ 且 $C_{\\text{micro}}(\\tau) = \\alpha\\,\\tau$。代入这些关系可得 $C_{\\text{tot}}(\\tau, \\Delta t) = T\\alpha\\frac{\\tau}{\\Delta t}$。\n总误差函数：$E_{\\text{tot}}(\\tau, \\Delta t) = a\\,\\Delta t^{p} + b\\,\\tau^{-1/2}$。\n约束条件是总误差不得超过给定的容限 $\\varepsilon  0$，因此有 $E_{\\text{tot}}(\\tau, \\Delta t) \\leq \\varepsilon$。\n参数 $a, b, \\alpha, T$ 均为正常数，宏观积分器的阶数 $p \\geq 1$。优化变量为 $\\tau  0$ 和 $\\Delta t  0$。\n\n该优化问题可正式表述为：\n最小化 $C_{\\text{tot}}(\\tau, \\Delta t) = T\\alpha\\frac{\\tau}{\\Delta t}$\n约束条件为 $a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} \\leq \\varepsilon$。\n\n成本函数 $C_{\\text{tot}}$ 是关于 $\\tau$ 的严格增函数，关于 $\\Delta t$ 的严格减函数。为最小化成本，我们应寻求尽可能小的 $\\tau$ 和尽可能大的 $\\Delta t$。约束条件 $a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} \\leq \\varepsilon$ 限制了 $\\Delta t$ 能取多大以及 $\\tau$ 能取多小。如果该不等式是严格的，即 $a\\,\\Delta t^{p} + b\\,\\tau^{-1/2}  \\varepsilon$，那么总可以通过增大 $\\Delta t$ 或减小 $\\tau$（或同时进行）来进一步降低成本，同时仍然满足约束。因此，最小成本必然在约束被激活时达到，即等式成立：\n$a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} = \\varepsilon$。\n\n我们使用拉格朗日乘数法来求解此约束优化问题。拉格朗日函数 $\\mathcal{L}$ 定义为：\n$$\n\\mathcal{L}(\\tau, \\Delta t, \\lambda) = C_{\\text{tot}}(\\tau, \\Delta t) + \\lambda (E_{\\text{tot}}(\\tau, \\Delta t) - \\varepsilon)\n$$\n代入函数的具体形式，我们得到：\n$$\n\\mathcal{L}(\\tau, \\Delta t, \\lambda) = T\\alpha\\frac{\\tau}{\\Delta t} + \\lambda(a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} - \\varepsilon)\n$$\n最优解 $(\\tau^{\\star}, \\Delta t^{\\star})$ 必须满足将拉格朗日函数对 $\\tau$、$\\Delta t$ 和 $\\lambda$ 的偏导数设为零所得到的方程组。\n\n1.  对 $\\tau$ 的偏导数：\n    $$\n    \\frac{\\partial\\mathcal{L}}{\\partial \\tau} = \\frac{T\\alpha}{\\Delta t} + \\lambda b \\left(-\\frac{1}{2}\\tau^{-3/2}\\right) = 0 \\implies \\frac{T\\alpha}{\\Delta t} = \\frac{\\lambda b}{2}\\tau^{-3/2}\n    $$\n2.  对 $\\Delta t$ 的偏导数：\n    $$\n    \\frac{\\partial\\mathcal{L}}{\\partial \\Delta t} = T\\alpha\\tau \\left(-\\frac{1}{\\Delta t^2}\\right) + \\lambda a p \\Delta t^{p-1} = 0 \\implies \\frac{T\\alpha\\tau}{\\Delta t^2} = \\lambda a p \\Delta t^{p-1}\n    $$\n3.  对 $\\lambda$ 的偏导数：\n    $$\n    \\frac{\\partial\\mathcal{L}}{\\partial \\lambda} = a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} - \\varepsilon = 0\n    $$\n\n从前两个方程中，我们可以解出拉格朗日乘数 $\\lambda$：\n由方程 (1) 得：\n$$\n\\lambda = \\frac{2T\\alpha\\tau^{3/2}}{b\\Delta t}\n$$\n由方程 (2) 得：\n$$\n\\lambda = \\frac{T\\alpha\\tau}{ap\\Delta t^{p+1}}\n$$\n\n令这两个关于 $\\lambda$ 的表达式相等，可以得到最优状态下 $\\tau$ 和 $\\Delta t$ 之间的关系：\n$$\n\\frac{2T\\alpha\\tau^{3/2}}{b\\Delta t} = \\frac{T\\alpha\\tau}{ap\\Delta t^{p+1}}\n$$\n由于 $T0$, $\\alpha0$, $\\tau0$ 且 $\\Delta t0$，我们可以在等式两边同除以 $T\\alpha\\tau/\\Delta t$：\n$$\n\\frac{2\\tau^{1/2}}{b} = \\frac{1}{ap\\Delta t^p}\n$$\n整理后得到最优性条件：\n$$\n2ap\\Delta t^p = b\\tau^{-1/2}\n$$\n该条件代表了两种误差源之间的最优平衡。宏观误差 $a\\Delta t^p$ 应该是微观误差 $b\\tau^{-1/2}$ 的 $1/(2p)$ 倍。\n\n现在我们可以利用这个条件来求解最优值。将 $b\\tau^{-1/2} = 2ap\\Delta t^p$ 代入约束方程 $a\\,\\Delta t^{p} + b\\,\\tau^{-1/2} = \\varepsilon$：\n$$\na\\,\\Delta t^{p} + 2ap\\Delta t^p = \\varepsilon\n$$\n$$\na\\Delta t^p (1 + 2p) = \\varepsilon\n$$\n求解 $\\Delta t^p$：\n$$\n(\\Delta t^{\\star})^p = \\frac{\\varepsilon}{a(1+2p)}\n$$\n因此，最优宏观时间步长为：\n$$\n\\Delta t^{\\star} = \\left(\\frac{\\varepsilon}{a(1+2p)}\\right)^{1/p}\n$$\n接下来，为了求出最优的 $\\tau$，我们将 $a\\Delta t^p = \\frac{b\\tau^{-1/2}}{2p}$ 代入约束方程：\n$$\n\\frac{b\\tau^{-1/2}}{2p} + b\\tau^{-1/2} = \\varepsilon\n$$\n$$\nb\\tau^{-1/2}\\left(\\frac{1}{2p} + 1\\right) = \\varepsilon\n$$\n$$\nb\\tau^{-1/2}\\left(\\frac{1+2p}{2p}\\right) = \\varepsilon\n$$\n求解 $\\tau^{-1/2}$：\n$$\n(\\tau^{\\star})^{-1/2} = \\frac{2p\\varepsilon}{b(1+2p)}\n$$\n两边平方再取倒数，即可得到最优微观模拟时长：\n$$\n\\tau^{\\star} = \\left(\\frac{b(1+2p)}{2p\\varepsilon}\\right)^2\n$$\n这些关于 $\\tau^{\\star}$ 和 $\\Delta t^{\\star}$ 的表达式为在给定误差容限 $\\varepsilon$ 的情况下最小化总计算成本提供了最优参数选择。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\left( \\frac{b(1+2p)}{2p \\varepsilon} \\right)^2 \\\\ \\left( \\frac{\\varepsilon}{a(1+2p)} \\right)^{1/p} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "许多复杂系统表现出记忆效应，即系统的未来状态依赖于其整个历史。为这种记忆建模是时间桥接方案可以解决的一个核心挑战。本实践编码练习  将向你展示如何使用Prony方法从原始的微观尺度模拟数据中构建这种记忆的数学表示（即记忆核），并学习如何使用信息准则来选择合适的模型复杂度，从而将微观数据与宏观描述联系起来。",
            "id": "3813605",
            "problem": "给定一个微观尺度的离散时间序列，该序列采样了多尺度建模中用于时间桥接方案的记忆核。在许多粗粒化描述中，一个具有记忆效应的可观测量遵循一种积分-微分演化形式 $$\\frac{d q(t)}{d t} = F\\big(q(t)\\big) + \\int_{0}^{t} K(t-s)\\, G\\big(q(s)\\big)\\, ds,$$ 其中未知的记忆核 $$K(t)$$ 通常可以近似为衰减指数函数的和，这使得跨尺度的高效时间桥接成为可能。假设微观时间序列在等间隔时间点 $$t_n = n\\,\\Delta t$$（对于 $$n = 0,1,\\dots,N-1$$）上提供样本 $$s_n \\approx K(n\\,\\Delta t)$$，并且 $$K(t)$$ 具有 $$K(t) \\approx \\sum_{j=1}^{p} a_j e^{-b_j t}$$ 的表示形式，其中振幅 $$a_j$$ 和衰减率 $$b_j  0$$ 是未知的。等价地，在离散时间下，模型为 $$s_n \\approx \\sum_{j=1}^{p} a_j r_j^n$$，其中 $$r_j = e^{-b_j \\Delta t}$$ 满足 $0  r_j  1$（对于正衰减率）。\n\n从该表示和离散时间线性预测（Prony 方法）的定义出发，将模型阶数选择问题构建为一个在高斯测量噪声下的信息论问题。假设测量误差是独立同分布的高斯随机变量，方差为 $$\\sigma^2$$，并且使用最大似然估计来拟合参数，那么赤池信息准则 (Akaike Information Criterion, AIC) 和贝叶斯信息准则 (Bayesian Information Criterion, BIC) 可以用残差平方和 $$\\mathrm{RSS} = \\sum_{n=0}^{N-1} \\left(s_n - \\hat{s}_n\\right)^2$$ 和自由参数数量 $$k$$ 来表示。对于一个离散时间下的 $$p$$ 指数模型，将 $$k$$ 视为 $$2p$$（每个指数项有一个振幅参数 $$a_j$$ 和一个衰减因子参数 $$r_j$$）。\n\n您的任务是根据第一性原理实现以下内容：\n- 一个 Prony 方法估计器：对于每个候选阶数 $$p$$，通过最小二乘法计算线性预测系数，从相关的特征多项式的根中提取离散衰减因子 $$r_j$$，并使用对范德蒙系统的最小二乘拟合来估计振幅 $$a_j$$。\n- 一个信息准则评估器：对于每个 $$p$$，计算 $$\\mathrm{RSS}$$，然后计算 $$\\mathrm{AIC}(p) = N \\ln\\left(\\mathrm{RSS}/N\\right) + 2k$$ 和 $$\\mathrm{BIC}(p) = N \\ln\\left(\\mathrm{RSS}/N\\right) + k \\ln(N)$$。\n- 一个模型阶数选择器：选择使 $$\\mathrm{BIC}(p)$$ 最小化的 $$p$$ 作为 $$p^\\ast$$，若存在多个相同的最小值，则选择最小的 $$p$$。\n\n此问题中的微观时间序列是为可测试性而人工生成的，使用了已知的真实参数和加性高斯噪声。对于每个测试用例，通过 $$s_n = \\sum_{j=1}^{p_{\\text{true}}} a_j e^{-b_j n \\Delta t} + \\varepsilon_n$$ 生成 $$s_n$$，其中 $$\\varepsilon_n \\sim \\mathcal{N}(0,\\sigma^2)$$ 在 $n$ 上是独立的，然后执行上述模型选择。\n\n实现您的程序，以解决以下测试套件：\n- 测试用例 $$1$$ (正常路径)：$$\\Delta t = 0.05$$，$$N = 64$$，$$p_{\\text{true}} = 2$$，振幅 $$a = [1.0, 0.3]$$，衰减率 $$b = [1.8, 0.6]$$，噪声标准差 $$\\sigma = 0.002$$，需要考虑的最大模型阶数 $$p_{\\max} = 4$$。\n- 测试用例 $$2$$ (近最小长度和低噪声的边界条件)：$$\\Delta t = 0.1$$，$$N = 20$$，$$p_{\\text{true}} = 1$$，振幅 $$a = [0.8]$$，衰减率 $$b = [1.2]$$，噪声标准差 $$\\sigma = 0.0005$$，需要考虑的最大模型阶数 $$p_{\\max} = 4$$。\n- 测试用例 $$3$$ (三个指数和中等噪声的边缘情况)：$$\\Delta t = 0.02$$，$$N = 120$$，$$p_{\\text{true}} = 3$$，振幅 $$a = [0.4, 0.6, 0.2]$$，衰减率 $$b = [2.5, 1.0, 0.15]$$，噪声标准差 $$\\sigma = 0.003$$，需要考虑的最大模型阶数 $$p_{\\max} = 5$$。\n\n信息准则的缩写必须在首次使用时定义：赤池信息准则 (Akaike Information Criterion, AIC) 和贝叶斯信息准则 (Bayesian Information Criterion, BIC)。\n\n您的程序应生成单行输出，其中包含三个测试用例各自选择的阶数 $$p^\\ast$$，按顺序排列，形式为用方括号括起来的逗号分隔列表（例如 $$[p_1,p_2,p_3]$$）。输出为整数。不涉及物理单位；所有量均为无量纲。通过使用固定的随机种子生成噪声来确保可复现性。您的实现必须是自包含的，无需任何用户输入即可运行，并且必须遵循为最终答案指定的执行环境约束。",
            "solution": "该问题要求为一个表示为衰减指数和的信号选择最优模型阶数。此任务的背景是多尺度建模，其中此类指数和用于近似粗粒化动力学方程中的记忆核。该方法论包括两个主要部分：使用 Prony 方法对给定模型阶数进行参数估计，以及使用贝叶斯信息准则 (Bayesian Information Criterion, BIC) 进行模型选择。\n\n在时间间隔 $$\\Delta t$$ 采样的离散时间序列 $$s_n$$ 的基础模型由下式给出：\n$$s_n = \\sum_{j=1}^{p} a_j r_j^n + \\varepsilon_n, \\quad n=0, 1, \\dots, N-1$$\n其中 $$a_j$$ 是振幅，$$r_j = e^{-b_j \\Delta t}$$ 是与连续时间衰减率 $$b_j  0$$ 对应的离散衰减因子，$$p$$ 是模型阶数，$$\\varepsilon_n$$ 是均值为 $$0$$、方差为 $$\\sigma^2$$ 的独立同分布高斯噪声。目标是从数据中确定最合理的阶数 $$p$$。\n\n### 1. 通过 Prony 方法进行参数估计\n\n对于一个固定的候选阶数 $$p$$，Prony 方法提供了一个估计参数 $$\\{a_j, r_j\\}_{j=1}^p$$ 的程序。该方法巧妙地将这个非线性估计问题转化为两个线性最小二乘问题的序列。\n\n#### 步骤 1A：线性预测和特征多项式\n\nProny 方法的基础在于观察到一个由 $$p$$ 个指数函数组成的无噪声信号 $$s_n = \\sum_{j=1}^{p} a_j r_j^n$$ 是一个 $$p$$ 阶线性齐次递推关系的解。该关系由一个特征多项式 $$\\Psi(z)$$ 定义，其根正是衰减因子 $$r_j$$：\n$$\\Psi(z) = \\prod_{j=1}^{p} (z - r_j) = z^p + c_1 z^{p-1} + \\dots + c_p$$\n这里，$$\\{c_i\\}_{i=1}^p$$ 是多项式系数。递推关系为 $$\\Psi(E)s_n = 0$$，其中 $$E$$ 是移位算子（$$Es_n = s_{n+1}$$），明确地给出：\n$$s_{n+p} + c_1 s_{n+p-1} + \\dots + c_p s_n = 0$$\n这可以被重排为线性预测形式：\n$$s_k = - \\sum_{i=1}^{p} c_i s_{k-i}$$\n对于 $$k \\ge p$$。在存在噪声的情况下，这种关系不是精确的。然而，我们可以在最小二乘意义上找到最能满足此关系的系数 $$c_i$$。我们为未知系数 $$\\mathbf{c} = [c_1, c_2, \\dots, c_p]^T$$ 建立一个超定线性方程组。该系统是为 $$k = p, p+1, \\dots, N-1$$ 构建的：\n$$\n\\begin{pmatrix}\ns_{p-1}  s_{p-2}  \\dots  s_0 \\\\\ns_p  s_{p-1}  \\dots  s_1 \\\\\n\\vdots  \\vdots  \\ddots  \\vdots \\\\\ns_{N-2}  s_{N-3}  \\dots  s_{N-p-1}\n\\end{pmatrix}\n\\begin{pmatrix} c_1 \\\\ c_2 \\\\ \\vdots \\\\ c_p \\end{pmatrix}\n\\approx\n-\\begin{pmatrix} s_p \\\\ s_{p+1} \\\\ \\vdots \\\\ s_{N-1} \\end{pmatrix}\n$$\n这是一个形式为 $$A\\mathbf{c} \\approx \\mathbf{b}$$ 的标准线性最小二乘问题，求解系数向量 $$\\mathbf{c}$$。方程的数量是 $$N-p$$，未知数的数量是 $$p$$。对于一个适定的超定系统，我们需要 $$N-p \\ge p$$，即 $$N \\ge 2p$$。\n\n#### 步骤 1B：衰减因子 ($$r_j$$) 的估计\n\n利用估计出的系数 $$\\hat{c}_i$$，我们构建估计的特征多项式：\n$$\\hat{\\Psi}(z) = z^p + \\hat{c}_1 z^{p-1} + \\dots + \\hat{c}_p$$\n该多项式的根 $$\\hat{r}_1, \\hat{r}_2, \\dots, \\hat{r}_p$$ 是离散衰减因子的估计值。这些根可以使用标准数值多项式求根算法找到。\n\n#### 步骤 1C：振幅 ($$a_j$$) 的估计\n\n一旦确定了衰减因子 $$\\hat{r}_j$$，原始模型 $$s_n \\approx \\sum_{j=1}^{p} a_j \\hat{r}_j^n$$ 在未知振幅 $$a_j$$ 上就变成了线性的。因此，我们可以使用另一次线性最小二乘拟合来求解振幅。我们使用所有 $$N$$ 个数据点（$$n=0, \\dots, N-1$$）构建以下超定系统：\n$$\n\\begin{pmatrix}\n\\hat{r}_1^0  \\hat{r}_2^0  \\dots  \\hat{r}_p^0 \\\\\n\\hat{r}_1^1  \\hat{r}_2^1  \\dots  \\hat{r}_p^1 \\\\\n\\vdots  \\vdots  \\ddots  \\vdots \\\\\n\\hat{r}_1^{N-1}  \\hat{r}_2^{N-1}  \\dots  \\hat{r}_p^{N-1}\n\\end{pmatrix}\n\\begin{pmatrix} a_1 \\\\ a_2 \\\\ \\vdots \\\\ a_p \\end{pmatrix}\n\\approx\n\\begin{pmatrix} s_0 \\\\ s_1 \\\\ \\vdots \\\\ s_{N-1} \\end{pmatrix}\n$$\n左侧的矩阵是一个范德蒙矩阵 $$V$$。求解系统 $$V\\mathbf{a} \\approx \\mathbf{s}$$ 以得到振幅向量 $$\\mathbf{a} = [a_1, a_2, \\dots, a_p]^T$$，从而完成对给定阶数 $$p$$ 的参数估计。\n\n### 2. 模型阶数选择\n\n在为一系列候选阶数 $$p=1, 2, \\dots, p_{\\max}$$ 估计参数之后，我们必须选择最合适的一个。信息准则通过平衡模型保真度（拟合优度）和模型复杂性，为此提供了一种有原则的方法。\n\n#### 步骤 2A：残差平方和 (RSS)\n\n对于每个阶数为 $$p$$ 的模型，我们首先使用估计的参数重构信号：\n$$\\hat{s}_n(p) = \\sum_{j=1}^{p} \\hat{a}_j \\hat{r}_j^n$$\n拟合优度通过残差平方和（$$\\mathrm{RSS}$$）来量化：\n$$\\mathrm{RSS}(p) = \\sum_{n=0}^{N-1} \\left(s_n - \\hat{s}_n(p)\\right)^2$$\n较低的 $$\\mathrm{RSS}$$ 表示对数据的拟合更好。\n\n#### 步骤 2B：贝叶斯信息准则 (BIC)\n\n贝叶斯信息准则 (BIC) 定义为：\n$$\\mathrm{BIC}(p) = N \\ln\\left(\\frac{\\mathrm{RSS}(p)}{N}\\right) + k \\ln(N)$$\n其中 $$N$$ 是数据点的数量，$$k$$ 是模型中自由参数的数量。对于一个 $$p$$ 指数模型，我们有 $$p$$ 个振幅（$$a_j$$）和 $$p$$ 个衰减因子（$$r_j$$），所以总参数数量为 $$k=2p$$。\n\nBIC 目标函数对模型复杂性进行惩罚。第一项 $$N \\ln(\\mathrm{RSS}/N)$$ 随着模型对数据拟合得更好而减小（即随着 $$\\mathrm{RSS}$$ 减小）。第二项 $$k \\ln(N)$$ 随着参数数量 $$p$$ 的增加而增加。最优模型阶数 $$p^\\ast$$ 是使 BIC 最小化的那个，代表了拟合度和复杂性之间的最佳权衡。\n\n#### 步骤 2C：选择策略\n\n总体流程如下：\n1.  对于每个候选阶数 $$p \\in \\{1, 2, \\dots, p_{\\max}\\}$$：\n    a.  应用 Prony 方法估计参数 $$\\{\\hat{a}_j, \\hat{r}_j\\}_{j=1}^p$$。\n    b.  重构信号 $$\\hat{s}_n(p)$$ 并计算 $$\\mathrm{RSS}(p)$$。\n    c.  使用参数数量 $$k=2p$$ 计算 $$\\mathrm{BIC}(p)$$。\n2.  选择最优阶数 $$p^\\ast$$ 作为产生最小 $$\\mathrm{BIC}(p)$$ 值的 $$p$$。如果出现平局，选择最小的 $$p$$。\n\n对每个提供的测试用例都执行此程序，首先根据指定的真实参数和噪声水平生成人工时间序列。固定的随机种子确保了噪声生成的可复现性，并因此确保了最终结果的可复现性。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the model order selection problem for a sum of exponentials\n    using Prony's method and the Bayesian Information Criterion (BIC).\n    \"\"\"\n    # Use a fixed random seed for reproducible noise generation.\n    np.random.seed(0)\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'dt': 0.05, 'N': 64, 'p_true': 2, 'a': [1.0, 0.3], 'b': [1.8, 0.6], 'sigma': 0.002, 'p_max': 4},\n        {'dt': 0.1, 'N': 20, 'p_true': 1, 'a': [0.8], 'b': [1.2], 'sigma': 0.0005, 'p_max': 4},\n        {'dt': 0.02, 'N': 120, 'p_true': 3, 'a': [0.4, 0.6, 0.2], 'b': [2.5, 1.0, 0.15], 'sigma': 0.003, 'p_max': 5}\n    ]\n\n    selected_orders = []\n\n    for case in test_cases:\n        dt, N, a_true, b_true, sigma, p_max = \\\n            case['dt'], case['N'], case['a'], case['b'], case['sigma'], case['p_max']\n\n        # 1. Generate the synthetic noisy time series s_n\n        t = np.arange(N) * dt\n        r_true = np.exp(-np.array(b_true) * dt)\n\n        # Generate the clean signal using a Vandermonde matrix approach\n        V_true = np.vander(r_true, N, increasing=True).T\n        s_clean = V_true @ np.array(a_true)\n        \n        # Add independent and identically distributed Gaussian noise\n        noise = np.random.normal(loc=0.0, scale=sigma, size=N)\n        s_n = s_clean + noise\n\n        # 2. Iterate through candidate model orders p to find the best one\n        min_bic = float('inf')\n        p_star = -1\n\n        for p in range(1, p_max + 1):\n            \n            # Prony's method requires N >= 2p for the first least squares problem\n            # to be overdetermined or exactly determined.\n            if N  2 * p:\n                continue\n\n            # --- Prony's Method Implementation ---\n\n            # 2a. Solve for linear prediction coefficients c.\n            # Set up the linear system Ac = b.\n            # A has shape (N-p, p), b has shape (N-p,).\n            A = np.zeros((N - p, p))\n            for i in range(p):\n                A[:, i] = s_n[p - 1 - i : N - 1 - i]\n            b = -s_n[p:N]\n            \n            # Solve for c using linear least squares.\n            c, _, _, _ = np.linalg.lstsq(A, b, rcond=None)\n            \n            # 2b. Find the roots of the characteristic polynomial.\n            # The coefficients are [1, c_1, c_2, ...].\n            poly_coeffs = np.concatenate(([1], c))\n            roots = np.roots(poly_coeffs)\n            \n            # 2c. Solve for the amplitudes a.\n            # Set up the Vandermonde system Va = s_n.\n            V = np.vander(roots, N, increasing=True).T\n            \n            # Solve for a using linear least squares.\n            a, residuals, _, _ = np.linalg.lstsq(V, s_n, rcond=None)\n            \n            # --- Model Selection using BIC ---\n            \n            # Reconstruct the fitted signal to calculate RSS.\n            # Note: The RSS can also be obtained directly from the residuals\n            # of the lstsq fit for 'a'.\n            s_hat = V @ a\n            rss = np.sum((s_n - s_hat)**2)\n            \n            # If the fit is perfect (unlikely with noise), rss could be 0.\n            # log(0) is -inf, so we handle this case to avoid errors.\n            if rss = 1e-12: # Check against a small epsilon\n                bic_val = -float('inf') \n            else:\n                # The number of free parameters k is 2*p (p amplitudes, p decays).\n                k = 2 * p\n                # Bayesian Information Criterion (BIC)\n                bic_val = N * np.log(rss / N) + k * np.log(N)\n            \n            # Update the best model order p* if a lower BIC is found.\n            # The loop structure naturally breaks ties by preferring smaller p.\n            if bic_val  min_bic:\n                min_bic = bic_val\n                p_star = p\n        \n        selected_orders.append(p_star)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, selected_orders))}]\")\n\nsolve()\n```"
        }
    ]
}