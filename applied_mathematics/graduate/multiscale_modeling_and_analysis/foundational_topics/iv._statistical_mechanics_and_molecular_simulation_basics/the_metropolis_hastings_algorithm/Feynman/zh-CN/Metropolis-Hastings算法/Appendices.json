{
    "hands_on_practices": [
        {
            "introduction": "掌握Metropolis-Hastings算法的第一步是理解其核心机制：接受概率的计算。这个练习提供了一个离散状态空间上的简单场景，让你能够亲手计算从一个状态转移到另一个状态的接受概率。通过这个基础实践，你将学会如何应用Metropolis-Hastings公式，并理解它如何平衡目标分布的概率和提议分布的对称性。",
            "id": "1343441",
            "problem": "一个模拟从非负整数集合 $\\{0, 1, 2, \\dots \\}$ 中生成状态。目标是从一个目标概率分布中进行抽样，其中处于状态 $k$ 的概率，记为 $\\pi(k)$，与 $(1/2)^k$ 成正比。\n\n该模拟使用马尔可夫链在状态之间进行转移。在任意给定状态 $i > 0$ 时，通过以 $1/2$ 的等概率选择 $j=i-1$ 或 $j=i+1$ 来提议下一个状态 $j$。如果当前状态是 $i=0$，则总是提议转移到状态 $j=1$。从状态 $i$ 转移到提议状态 $j$ 的转移概率记为 $Q(j|i)$。\n\n接受提议移动的决定由 Metropolis-Hastings 接受概率确定。\n\n假设链当前处于状态 $X_t=3$，并且提议移动到候选状态 $y=4$。计算此移动被接受的概率。请用精确值表示您的答案。",
            "solution": "我们给定一个在非负整数上的目标分布，其概率与 $(1/2)^{k}$ 成正比。将目标写作\n$$\n\\pi(k)=C\\left(\\frac{1}{2}\\right)^{k},\n$$\n其中 $C$ 是归一化常数（在 Metropolis-Hastings 比率中会被抵消）。\n\n提议核 $Q(j\\mid i)$ 定义如下：\n- 如果 $i0$，则 $Q(i-1\\mid i)=\\frac{1}{2}$ 且 $Q(i+1\\mid i)=\\frac{1}{2}$。\n- 如果 $i=0$，则 $Q(1\\mid 0)=1$。\n\n从当前状态 $i$ 移动到提议状态 $y$ 的 Metropolis-Hastings 接受概率为\n$$\n\\alpha(i\\to y)=\\min\\left\\{1,\\ \\frac{\\pi(y)\\,Q(i\\mid y)}{\\pi(i)\\,Q(y\\mid i)}\\right\\}。\n$$\n\n此处，当前状态为 $i=3$，提议状态为 $y=4$。由于 $i=3$ 和 $y=4$ 均大于 $0$，我们有\n$$\nQ(4\\mid 3)=\\frac{1}{2},\\qquad Q(3\\mid 4)=\\frac{1}{2}。\n$$\n因此，\n$$\n\\frac{\\pi(4)\\,Q(3\\mid 4)}{\\pi(3)\\,Q(4\\mid 3)}\n=\\frac{C\\left(\\frac{1}{2}\\right)^{4}\\cdot \\frac{1}{2}}{C\\left(\\frac{1}{2}\\right)^{3}\\cdot \\frac{1}{2}}\n=\\frac{\\left(\\frac{1}{2}\\right)^{4}}{\\left(\\frac{1}{2}\\right)^{3}}\n=\\frac{1}{2}。\n$$\n因此，接受概率为\n$$\n\\alpha(3\\to 4)=\\min\\left\\{1,\\ \\frac{1}{2}\\right\\}=\\frac{1}{2}。\n$$",
            "answer": "$$\\boxed{\\frac{1}{2}}$$"
        },
        {
            "introduction": "Metropolis-Hastings算法的一个关键要求是遍历性（ergodicity），即马尔可夫链必须能够从任何状态到达任何其他状态。如果这个条件不满足，采样将会被限制在状态空间的一个子集中，导致结果出现严重偏差。这个练习设计了一个不连通的状态空间，旨在揭示当提议分布的步长过小，无法跨越低概率区域时，算法会如何“被困住”，从而帮助你深刻理解遍历性的重要性。",
            "id": "1401742",
            "problem": "一位统计学家正在使用马尔可夫链蒙特卡洛（MCMC）算法从一维目标概率密度 $p(x)$ 中抽样。随机变量 $x$ 的状态空间 $\\mathcal{X}$ 定义为两个不相交区间的并集：$\\mathcal{X} = [-2, -1] \\cup [1, 2]$。\n\n未归一化的目标密度 $f(x)$ 分段定义如下：\n$$\nf(x) = \\begin{cases}\n1  \\text{if } x \\in [-2, -1] \\\\\n3  \\text{if } x \\in [1, 2] \\\\\n0  \\text{otherwise}\n\\end{cases}\n$$\n归一化目标密度为 $p(x) = f(x) / Z$，其中 $Z = \\int_{\\mathcal{X}} f(x) dx$。\n\n抽样器使用 Metropolis-Hastings 算法。在每一步中，给定当前状态 $x_t$，从一个对称的提议分布 $q(x'|x_t)$ 中提议一个候选状态 $x'$，该提议分布是区间 $[x_t - 0.5, x_t + 0.5]$ 上的均匀分布。如果提议的状态 $x'$ 落在状态空间 $\\mathcal{X}$ 之外，它将被自动拒绝。\n\n抽样器在状态 $x_0 = 1.5$ 处初始化。然后运行非常多次的迭代。根据 MCMC 理论，样本的长期平均值 $\\frac{1}{N}\\sum_{i=1}^N x_i$ 应收敛到链的平稳分布下 $x$ 的期望值。\n\n确定 $x$ 的样本均值将收敛到的数值。请用精确分数表示你的答案。",
            "solution": "未归一化的目标密度是分段常数：在 $[-2,-1]$ 上 $f(x)=1$，在 $[1,2]$ 上 $f(x)=3$，其他情况下为 $0$。归一化常数为\n$$\nZ=\\int_{\\mathcal{X}} f(x)\\,dx=\\int_{-2}^{-1} 1\\,dx+\\int_{1}^{2} 3\\,dx=(x)\\big|_{-2}^{-1}+3(x)\\big|_{1}^{2}=1+3=4.\n$$\n因此，全空间上的归一化目标密度为 $p(x)=f(x)/Z$，它将总质量 $\\int_{-2}^{-1} p(x)\\,dx=\\frac{1}{4}$ 分配在 $[-2,-1]$ 上，并将总质量 $\\int_{1}^{2} p(x)\\,dx=\\frac{3}{4}$ 分配在 $[1,2]$ 上。\n\nMetropolis-Hastings 提议是对称的：$q(x'|x)$ 在 $[x-0.5,x+0.5]$ 上是均匀的。落在 $\\mathcal{X}$ 之外的提议被拒绝，这等价于在 $\\mathcal{X}$ 之外目标密度为零的标准 MH 规则。关键在于，由于最大提议步长为 $0.5$，而两个区间之间的间隔为 $2$，因此在任意数量的接受步骤中，从一个区间移动到另一个区间的概率为零：对于任意 $x\\in[1,2]$，提议的支撑集 $[x-0.5,x+0.5]\\subset[0.5,2.5]$，因此任何提议的 $x'1$ 或 $x'>2$ 都落在 $\\mathcal{X}$ 之外并被拒绝。因此，该马尔可夫链有两个封闭的互通类，从 $x_{0}=1.5\\in[1,2]$ 开始，它将永远停留在 $[1,2]$ 中。\n\n在 $[1,2]$ 内部，$f(x)\\equiv 3$ 是常数，因此对于任何提议的 $x'\\in[1,2]$，Metropolis-Hastings 接受概率为 $\\min\\{1,f(x')/f(x)\\}=1$。限制在该类上的马尔可夫链的不变分布在 $[1,2]$ 上与 $f$ 成正比，因此是在 $[1,2]$ 上的均匀分布：\n$$\ng(x)=\\frac{f(x)}{\\int_{1}^{2} f(u)\\,du}=\\frac{3}{\\int_{1}^{2}3\\,du}=\\frac{3}{3}=1\\quad\\text{for }x\\in[1,2],\n$$\n其他情况下 $g(x)=0$。因此，长期样本均值收敛于 $X$ 在 $g$ 分布下的期望，即\n$$\n\\mathbb{E}_{g}[X]=\\int_{1}^{2} x\\,g(x)\\,dx=\\int_{1}^{2} x\\,dx=\\frac{1}{2}\\left(x^{2}\\right)\\bigg|_{1}^{2}=\\frac{1}{2}\\left(4-1\\right)=\\frac{3}{2}.\n$$\n根据封闭互通类内马尔可夫链的遍历定理，经验均值 $\\frac{1}{N}\\sum_{i=1}^{N} x_{i}$ 几乎必然收敛到 $\\mathbb{E}_{g}[X]=\\frac{3}{2}$。",
            "answer": "$$\\boxed{\\frac{3}{2}}$$"
        },
        {
            "introduction": "在实际应用中，选择一个高效的提议分布，特别是合适的步长 $\\sigma$，是Metropolis-Hastings算法成功的关键，也是一大挑战。这个练习将带你亲手实现一个简单的自适应方案，在“预烧期”（burn-in period）根据经验接受率动态调整提议步长。通过逐步追踪一个预设的随机序列，你将体验到算法如何自动“学习”一个合适的参数，从而更有效地探索目标分布。",
            "id": "1401734",
            "problem": "一位计算科学家正在使用随机游走Metropolis算法，从一个一维目标概率分布中生成样本，该分布的密度函数 $\\pi(x)$ 正比于 $\\exp(-x^2/2)$。该算法使用正态分布 $x' \\sim \\mathcal{N}(x, \\sigma^2)$ 从当前状态 $x$ 生成一个提议状态 $x'$，其中 $\\sigma$ 是提议步长。接受概率为 $A(x', x) = \\min\\left(1, \\frac{\\pi(x')}{\\pi(x)}\\right)$。\n\n为了在预烧期优化采样过程，该科学家采用了一种简单的自适应方案来调整步长 $\\sigma$。模拟以每批 $N=5$ 步的方式运行。在每批结束时，计算该批次的经验接受率 $\\hat{\\alpha}$。然后根据以下规则更新下一批次的步长：\n- 如果 $\\hat{\\alpha}  \\alpha_{\\text{target}}$，则增加步长：$\\sigma_{\\text{new}} = \\sigma_{\\text{old}} \\times (1 + \\delta)$。\n- 如果 $\\hat{\\alpha} \\le \\alpha_{\\text{target}}$，则减小步长：$\\sigma_{\\text{new}} = \\sigma_{\\text{old}} \\times (1 - \\delta)$。\n\n模拟从初始状态 $x_0 = 0$ 和初始步长 $\\sigma_0 = 1.0$ 开始。目标接受率为 $\\alpha_{\\text{target}} = 0.5$，适应强度为 $\\delta = 0.1$。\n\n为确保可复现性，模拟所用的随机数序列是预先确定的。对于每一步 $i$，提议按 $x'_i = x_{i-1} + \\sigma_k z_i$ 生成，其中 $\\sigma_k$ 是当前批次的步长，$z_i$ 是一个标准正态变量。如果 $u_i  A(x'_i, x_{i-1})$，则接受该提议，其中 $u_i$ 是一个均匀随机变量。\n\n前两个批次（10步）预先确定的随机变量是：\n- 标准正态变量 ($z_i$): $\\{0.50, -1.20, 0.80, -0.10, 2.00, -0.40, 1.50, -1.80, 0.30, -0.90\\}$\n- 均匀变量 ($u_i$): $\\{0.60, 0.20, 0.90, 0.40, 0.10, 0.70, 0.30, 0.05, 0.80, 0.50\\}$\n\n计算第二批次完成后提议步长的值。将最终答案四舍五入到四位有效数字。",
            "solution": "目标密度正比于 $\\pi(x) \\propto \\exp(-x^{2}/2)$。对于对称的随机游走提议 $x' \\sim \\mathcal{N}(x, \\sigma^{2})$，Metropolis接受概率为\n$$\nA(x',x) = \\min\\left(1,\\frac{\\pi(x')}{\\pi(x)}\\right) = \\min\\left(1,\\exp\\!\\left(-\\frac{x'^{2}-x^{2}}{2}\\right)\\right).\n$$\n在每个批次内，步长 $\\sigma$ 是固定的。在 $N=5$ 步之后，根据经验接受率 $\\hat{\\alpha}$，适应规则如下：\n- 如果 $\\hat{\\alpha}  \\alpha_{\\text{target}}$，则 $\\sigma_{\\text{new}} = \\sigma_{\\text{old}}(1+\\delta)$。\n- 如果 $\\hat{\\alpha} \\le \\alpha_{\\text{target}}$，则 $\\sigma_{\\text{new}} = \\sigma_{\\text{old}}(1-\\delta)$，\n其中 $\\alpha_{\\text{target}}=0.5$ 且 $\\delta=0.1$。从 $x_{0}=0$，$ \\sigma_{0}=1.0$ 开始。\n\n第1批（第1步到第5步，$\\sigma=1.0$）：\n- 第1步：$z_{1}=0.50$，提议 $x' = 0 + 1.0 \\cdot 0.50 = 0.50$。接受概率\n$$\nA=\\min\\left(1,\\exp\\!\\left(-\\frac{0.50^{2}-0^{2}}{2}\\right)\\right)=\\min(1,\\exp(-0.125)).\n$$\n因为 $u_{1}=0.60  \\exp(-0.125) \\approx 0.882$，接受。新的 $x=0.50$。\n- 第2步：$z_{2}=-1.20$，提议 $x' = 0.50 + 1.0 \\cdot (-1.20) = -0.70$。接受概率\n$$\nA=\\min\\left(1,\\exp\\!\\left(-\\frac{(-0.70)^{2}-(0.50)^{2}}{2}\\right)\\right)=\\min(1,\\exp(-0.12)).\n$$\n因为 $u_{2}=0.20  \\exp(-0.12) \\approx 0.887$，接受。新的 $x=-0.70$。\n- 第3步：$z_{3}=0.80$，提议 $x' = -0.70 + 0.80 = 0.10$。这里 $x'^{2}-x^{2}=0.01-0.49=-0.48$，所以\n$$\nA=\\min(1,\\exp(0.24))=1,\n$$\n因此接受（因为 $u_{3}=0.90  1$）。新的 $x=0.10$。\n- 第4步：$z_{4}=-0.10$，提议 $x' = 0.10 - 0.10 = 0.00$。则 $x'^{2}-x^{2}=0-0.01=-0.01$，\n$$\nA=\\min(1,\\exp(0.005))=1,\n$$\n因此接受（$u_{4}=0.40  1$）。新的 $x=0.00$。\n- 第5步：$z_{5}=2.00$，提议 $x' = 0.00 + 2.00 = 2.00$。则 $x'^{2}-x^{2}=4-0=4$，\n$$\nA=\\min(1,\\exp(-2)).\n$$\n因为 $u_{5}=0.10  \\exp(-2) \\approx 0.135$，接受。新的 $x=2.00$。\n\n第1批在5步中有5次接受，所以 $\\hat{\\alpha}=1.0 > \\alpha_{\\text{target}}$。更新\n$$\n\\sigma_{1}=\\sigma_{0}(1+\\delta)=1.0 \\times 1.1=1.1.\n$$\n\n第2批（第6步到第10步，$\\sigma=1.1$），从 $x=2.00$ 开始：\n- 第6步：$z_{6}=-0.40$，提议 $x' = 2.00 + 1.1 \\cdot (-0.40) = 1.56$。则 $x'^{2}-x^{2}=2.4336-4=-1.5664$，\n$$\nA=\\min(1,\\exp(0.7832))=1,\n$$\n接受（$u_{6}=0.70  1$）。新的 $x=1.56$。\n- 第7步：$z_{7}=1.50$，提议 $x' = 1.56 + 1.1 \\cdot 1.50 = 3.21$。则 $x'^{2}-x^{2}=10.3041-2.4336=7.8705$，\n$$\nA=\\min(1,\\exp(-3.93525)).\n$$\n因为 $u_{7}=0.30 > \\exp(-3.93525) \\approx 0.0195$，拒绝。状态保持为 $x=1.56$。\n- 第8步：$z_{8}=-1.80$，提议 $x' = 1.56 + 1.1 \\cdot (-1.80) = -0.42$。则 $x'^{2}-x^{2}=0.1764-2.4336=-2.2572$，\n$$\nA=\\min(1,\\exp(1.1286))=1,\n$$\n接受（$u_{8}=0.05  1$）。新的 $x=-0.42$。\n- 第9步：$z_{9}=0.30$，提议 $x' = -0.42 + 1.1 \\cdot 0.30 = -0.09$。则 $x'^{2}-x^{2}=0.0081-0.1764=-0.1683$，\n$$\nA=\\min(1,\\exp(0.08415))=1,\n$$\n接受（$u_{9}=0.80  1$）。新的 $x=-0.09$。\n- 第10步：$z_{10}=-0.90$，提议 $x' = -0.09 + 1.1 \\cdot (-0.90) = -1.08$。则 $x'^{2}-x^{2}=1.1664-0.0081=1.1583$，\n$$\nA=\\min(1,\\exp(-0.57915)).\n$$\n因为 $u_{10}=0.50  \\exp(-0.57915) \\approx 0.560$，接受。新的 $x=-1.08$。\n\n第2批在5步中有4次接受，所以 $\\hat{\\alpha}=0.8 > \\alpha_{\\text{target}}$。更新\n$$\n\\sigma_{2}=\\sigma_{1}(1+\\delta)=1.1 \\times 1.1 = 1.21.\n$$\n四舍五入到四位有效数字，第二批结束后的步长为 $1.210$。",
            "answer": "$$\\boxed{1.210}$$"
        }
    ]
}