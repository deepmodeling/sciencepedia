{
    "hands_on_practices": [
        {
            "introduction": "我们从一个基础练习开始，直接应用细致平衡条件。这个练习使用一个简单的一维对称随机游走模型，通过直接应用细致平衡方程 $\\pi(i) P(i,j) = \\pi(j) P(j,i)$，你将能够推导出系统的平衡态分布。这个过程将强化这样一个观念：细致平衡是求解可逆系统稳态的一个强有力的工具。",
            "id": "3748914",
            "problem": "考虑一个在有限状态格点 $\\{0,1,\\dots,N\\}$ 上的离散时间最近邻随机游走，其中 $N \\in \\mathbb{N}$ 且 $N \\geq 2$。其动力学由以下转移概率定义：\n$$\nP(i,i-1) = \\frac{1}{2}, \\quad P(i,i+1) = \\frac{1}{2} \\quad \\text{对于所有 } i \\in \\{1,2,\\dots,N-1\\}，\n$$\n以及反射边界：\n$$\nP(0,0) = \\frac{1}{2}, \\quad P(0,1) = \\frac{1}{2}, \\qquad P(N,N) = \\frac{1}{2}, \\quad P(N,N-1) = \\frac{1}{2}。\n$$\n这种随机游走可以被看作是具有诺伊曼边界条件的可逆扩散的粗粒化模型，并在构建尊重界面处局域平衡的介观近似时，广泛应用于多尺度建模与分析中。设 $\\pi$ 表示该马尔可夫链的一个不变分布，由全局平衡条件 $\\pi = \\pi P$ 定义，并回想细致平衡条件要求对所有状态对 $i$ 和 $j$ 都有 $\\pi(i) P(i,j) = \\pi(j) P(j,i)$。\n\n仅从给定的转移结构以及不变分布和细致平衡的定义出发，推导 $\\pi$ 并验证所有相邻状态对上的细致平衡条件。作为最终答案，报告分配给每个状态的不变概率的公共值 $c$，用 $N$ 的闭式形式表示。不需要四舍五入，也不涉及物理单位。您的答案必须是单个解析表达式。",
            "solution": "问题要求我们推导状态空间为 $\\{0, 1, \\dots, N\\}$ 的离散时间马尔可夫链的不变分布，记为 $\\pi$。我们必须从给定的转移概率和细致平衡的定义出发，验证该条件对相邻状态成立，并确定每个状态的不变概率的常数值。\n\n状态空间为 $S = \\{0, 1, \\dots, N\\}$，其中 $N \\in \\mathbb{N}$ 且 $N \\geq 2$。状态总数为 $N+1$。非零转移概率 $P(i,j)$ 如下给出：\n对于内部状态 $i \\in \\{1, 2, \\dots, N-1\\}$：\n$$\nP(i, i-1) = \\frac{1}{2}, \\quad P(i, i+1) = \\frac{1}{2}\n$$\n对于边界状态 $i=0$：\n$$\nP(0, 0) = \\frac{1}{2}, \\quad P(0, 1) = \\frac{1}{2}\n$$\n对于边界状态 $i=N$：\n$$\nP(N, N) = \\frac{1}{2}, \\quad P(N, N-1) = \\frac{1}{2}\n$$\n不变分布 $\\pi$ 是一个概率分布，对所有 $j \\in S$ 满足全局平衡条件 $\\sum_{i \\in S} \\pi(i) P(i,j) = \\pi(j)$。细致平衡条件是一个更强的条件，由下式给出：\n$$\n\\pi(i) P(i,j) = \\pi(j) P(j,i) \\quad \\text{对于所有 } i, j \\in S\n$$\n如果一个分布 $\\pi$ 满足细致平衡条件，那么它保证满足全局平衡条件，因此是一个不变分布。我们将利用这一原理来找到 $\\pi$。我们的方法是假设存在这样一个满足细致平衡的 $\\pi$，然后利用这个假设来确定 $\\pi$ 的形式。\n\n我们将为 $i \\in \\{0, 1, \\dots, N-1\\}$ 的所有相邻状态对 $(i, i+1)$ 系统地检验细致平衡条件。\n\n情况1：边界对 $(0, 1)$。\n这对状态的细致平衡方程是 $\\pi(0) P(0,1) = \\pi(1) P(1,0)$。\n根据问题陈述，我们有 $P(0,1) = \\frac{1}{2}$ 和 $P(1,0) = \\frac{1}{2}$。\n代入这些值可得：\n$$\n\\pi(0) \\cdot \\frac{1}{2} = \\pi(1) \\cdot \\frac{1}{2}\n$$\n这意味着 $\\pi(0) = \\pi(1)$。\n\n情况2：内部对 $(i, i+1)$，其中 $i \\in \\{1, 2, \\dots, N-2\\}$。\n细致平衡方程是 $\\pi(i) P(i,i+1) = \\pi(i+1) P(i+1,i)$。\n这些状态的转移概率是 $P(i, i+1) = \\frac{1}{2}$ 和 $P(i+1, i) = \\frac{1}{2}$。\n代入这些值：\n$$\n\\pi(i) \\cdot \\frac{1}{2} = \\pi(i+1) \\cdot \\frac{1}{2}\n$$\n这意味着对所有 $i = 1, 2, \\dots, N-2$ 都有 $\\pi(i) = \\pi(i+1)$。\n\n情况3：边界对 $(N-1, N)$。\n细致平衡方程是 $\\pi(N-1) P(N-1,N) = \\pi(N) P(N,N-1)$。\n转移概率是 $P(N-1, N) = \\frac{1}{2}$ 和 $P(N, N-1) = \\frac{1}{2}$。\n代入这些值：\n$$\n\\pi(N-1) \\cdot \\frac{1}{2} = \\pi(N) \\cdot \\frac{1}{2}\n$$\n这意味着 $\\pi(N-1) = \\pi(N)$。\n\n结合所有情况的结果，我们得到一系列等式：\n$$\n\\pi(0) = \\pi(1) = \\pi(2) = \\dots = \\pi(N-1) = \\pi(N)\n$$\n这表明不变分布必须是状态空间上的一个均匀分布。我们用 $c$ 表示每个状态的公共概率值，因此对所有 $i \\in \\{0, 1, \\dots, N\\}$ 都有 $\\pi(i) = c$。\n\n我们现在已经按要求验证了所有相邻对的细致平衡条件。为完整起见，我们还应检查非相邻对和自转移。\n对于任何 $|i-j| > 1$ 的非相邻对 $(i,j)$，我们有 $P(i,j) = 0$ 和 $P(j,i) = 0$。细致平衡条件变为 $c \\cdot 0 = c \\cdot 0$，这是平凡满足的。\n对于自转移，例如在状态 $0$ 处，条件是 $\\pi(0)P(0,0)=\\pi(0)P(0,0)$。由于 $\\pi(0)=c$ 和 $P(0,0)=\\frac{1}{2}$，这便是 $c \\cdot \\frac{1}{2} = c \\cdot \\frac{1}{2}$，这也是平凡地成立的。同样的逻辑也适用于状态 $N$ 的自转移。\n\n因此，均匀分布 $\\pi(i)=c$ 对所有状态对都满足细致平衡条件。由于此条件成立，$\\pi$ 确实是一个不变分布。\n\n最后一步是确定常数 $c$ 的值。由于 $\\pi$ 是一个概率分布，所有状态上的概率之和必须等于 $1$：\n$$\n\\sum_{i=0}^{N} \\pi(i) = 1\n$$\n对所有 $i$ 代入 $\\pi(i)=c$：\n$$\n\\sum_{i=0}^{N} c = 1\n$$\n该和包含 $N+1$ 个相同的项，每一项都等于 $c$。因此，方程变为：\n$$\n(N+1)c = 1\n$$\n解出 $c$，我们得到每个状态的不变概率值：\n$$\nc = \\frac{1}{N+1}\n$$\n这就是分配给每个状态的不变概率的公共值，用 $N$ 的闭式形式表示。不变分布是 $\\pi(i) = \\frac{1}{N+1}$，适用于所有 $i \\in \\{0, 1, \\dots, N\\}$。",
            "answer": "$$\n\\boxed{\\frac{1}{N+1}}\n$$"
        },
        {
            "introduction": "理解了平衡态之后，我们转向非平衡系统。这个问题构建了一个虽然拥有稳态分布、但却违反细致平衡条件的马尔可夫链。通过这个例子，你将接触到非平衡稳态（Non-Equilibrium Steady State, NESS）的核心概念，并计算与之相关的稳态概率流，它标志着即使在宏观性质恒定时，系统内部依然存在持续的定向流动。",
            "id": "3748911",
            "problem": "在一个由状态 $\\{1,2,3\\}$ 表示的具有三个亚稳盆的介观粗粒化模型中，考虑一个时间齐次离散时间马尔可夫链，其转移矩阵 $P$ 描述了这些盆之间的有效转移。使用以下由常数 $\\alpha$、$\\beta$ 和 $\\gamma$ 参数化的结构化转移矩阵：\n$$\nP \\;=\\; \\begin{pmatrix}\n\\gamma  \\alpha  \\beta \\\\\n\\beta  \\gamma  \\alpha \\\\\n\\alpha  \\beta  \\gamma\n\\end{pmatrix},\n$$\n其中 $\\alpha$、$\\beta$ 和 $\\gamma$ 为非负数，且满足 $\\alpha+\\beta+\\gamma=1$。设参数为 $\\alpha=\\tfrac{1}{2}$、$\\beta=\\tfrac{3}{10}$ 和 $\\gamma=\\tfrac{1}{5}$。\n\n任务：\n1. 从马尔可夫链的平稳性定义出发，验证均匀分布 $\\pi=(\\tfrac{1}{3},\\tfrac{1}{3},\\tfrac{1}{3})^{\\top}$ 满足平稳条件 $\\pi=P^{\\top}\\pi$。\n2. 使用细致平衡的定义，评估该链相对于 $\\pi$ 是否是可逆的。\n3. 对于有向环 $1\\to 2\\to 3\\to 1$，定义沿边 $i\\to j$ 的稳态概率流为 $J_{i\\to j}=\\pi(i)P(i,j)-\\pi(j)P(j,i)$。计算稳态环流 $J_{\\mathrm{cycle}}$，其定义为由 $P$ 的对称性和稳态性质所决定的 $J_{1\\to 2}$、$J_{2\\to 3}$ 和 $J_{3\\to 1}$ 的共同值。给出 $J_{\\mathrm{cycle}}$ 的精确值，不进行四舍五入。\n最终答案必须是一个实数。不需要单位。",
            "solution": "### 解题推导\n\n解答分为三部分，对应于问题陈述中列出的任务。\n\n#### 1. 平稳性验证\n\n离散时间马尔可夫链的平稳条件由 $\\pi = P^{\\top}\\pi$ 给出，其中 $\\pi$ 是平稳分布向量，$P^{\\top}$ 是转移矩阵 $P$ 的转置。\n\n给定的转移矩阵是：\n$$\nP = \\begin{pmatrix}\n\\gamma  \\alpha  \\beta \\\\\n\\beta  \\gamma  \\alpha \\\\\n\\alpha  \\beta  \\gamma\n\\end{pmatrix}\n$$\n其转置为：\n$$\nP^{\\top} = \\begin{pmatrix}\n\\gamma  \\beta  \\alpha \\\\\n\\alpha  \\gamma  \\beta \\\\\n\\beta  \\alpha  \\gamma\n\\end{pmatrix}\n$$\n给定的平稳分布是均匀分布 $\\pi = (\\frac{1}{3}, \\frac{1}{3}, \\frac{1}{3})^{\\top}$。我们计算乘积 $P^{\\top}\\pi$：\n$$\nP^{\\top}\\pi = \\begin{pmatrix}\n\\gamma  \\beta  \\alpha \\\\\n\\alpha  \\gamma  \\beta \\\\\n\\beta  \\alpha  \\gamma\n\\end{pmatrix}\n\\begin{pmatrix}\n\\frac{1}{3} \\\\\n\\frac{1}{3} \\\\\n\\frac{1}{3}\n\\end{pmatrix} = \\frac{1}{3}\n\\begin{pmatrix}\n\\gamma + \\beta + \\alpha \\\\\n\\alpha + \\gamma + \\beta \\\\\n\\beta + \\alpha + \\gamma\n\\end{pmatrix}\n$$\n根据约束条件 $\\alpha + \\beta + \\gamma = 1$，得到的向量是：\n$$\nP^{\\top}\\pi = \\frac{1}{3}\n\\begin{pmatrix}\n1 \\\\\n1 \\\\\n1\n\\end{pmatrix} =\n\\begin{pmatrix}\n\\frac{1}{3} \\\\\n\\frac{1}{3} \\\\\n\\frac{1}{3}\n\\end{pmatrix} = \\pi\n$$\n条件 $\\pi = P^{\\top}\\pi$ 得到满足。因此，均匀分布 $\\pi$ 确实是该马尔可夫链的平稳分布。这是预料之中的，因为矩阵 $P$ 是双随机的（其行和与列和均为 $1$）。\n\n#### 2. 可逆性评估（细致平衡）\n\n如果一个马尔可夫链对于所有状态对 $i, j$ 满足细致平衡条件，则它相对于平稳分布 $\\pi$ 是可逆的：\n$$\n\\pi(i)P(i,j) = \\pi(j)P(j,i)\n$$\n在我们的例子中，平稳分布是均匀的，所以对于所有 $i \\in \\{1, 2, 3\\}$，$\\pi(i) = \\frac{1}{3}$。细致平衡条件简化为：\n$$\n\\frac{1}{3} P(i,j) = \\frac{1}{3} P(j,i) \\implies P(i,j) = P(j,i)\n$$\n这意味着该链是可逆的，当且仅当其转移矩阵 $P$ 是对称的。我们来检验 $P$ 的对称性：\n-   $P(1,2) = \\alpha$ 且 $P(2,1) = \\beta$。为满足对称性，必须有 $\\alpha = \\beta$。\n-   $P(1,3) = \\beta$ 且 $P(3,1) = \\alpha$。为满足对称性，必须有 $\\beta = \\alpha$。\n-   $P(2,3) = \\alpha$ 且 $P(3,2) = \\beta$。为满足对称性，必须有 $\\alpha = \\beta$。\n\n可逆性的条件是 $\\alpha = \\beta$。我们给定的具体参数值为 $\\alpha = \\frac{1}{2}$ 和 $\\beta = \\frac{3}{10}$。\n由于 $\\frac{1}{2} \\neq \\frac{3}{10}$，条件 $\\alpha = \\beta$ 不满足。矩阵 $P$ 不是对称的。因此，细致平衡条件不满足，该马尔可夫链相对于 $\\pi$ 是不可逆的。不可逆性意味着在稳态下存在非零的净概率流。\n\n#### 3. 稳态环流的计算\n\n从状态 $i$ 到状态 $j$ 的边上的稳态概率流定义为 $J_{i\\to j} = \\pi(i)P(i,j) - \\pi(j)P(j,i)$。我们需要计算环 $1\\to 2\\to 3\\to 1$ 的流。\n\n我们来计算环中每条边的流：\n-   对于边 $1\\to 2$：\n$$\nJ_{1\\to 2} = \\pi(1)P(1,2) - \\pi(2)P(2,1) = \\frac{1}{3}\\alpha - \\frac{1}{3}\\beta = \\frac{1}{3}(\\alpha - \\beta)\n$$\n-   对于边 $2\\to 3$：\n$$\nJ_{2\\to 3} = \\pi(2)P(2,3) - \\pi(3)P(3,2) = \\frac{1}{3}\\alpha - \\frac{1}{3}\\beta = \\frac{1}{3}(\\alpha - \\beta)\n$$\n-   对于边 $3\\to 1$：\n$$\nJ_{3\\to 1} = \\pi(3)P(3,1) - \\pi(1)P(1,3) = \\frac{1}{3}\\alpha - \\frac{1}{3}\\beta = \\frac{1}{3}(\\alpha - \\beta)\n$$\n如上所示，环中所有边的流都是相同的，这是转移矩阵循环对称性的结果。稳态环流就是这个共同的值：\n$$\nJ_{\\mathrm{cycle}} = \\frac{1}{3}(\\alpha - \\beta)\n$$\n现在，我们代入给定的数值 $\\alpha = \\frac{1}{2}$ 和 $\\beta = \\frac{3}{10}$：\n$$\nJ_{\\mathrm{cycle}} = \\frac{1}{3} \\left( \\frac{1}{2} - \\frac{3}{10} \\right)\n$$\n为了计算括号中的表达式：\n$$\n\\frac{1}{2} - \\frac{3}{10} = \\frac{5}{10} - \\frac{3}{10} = \\frac{2}{10} = \\frac{1}{5}\n$$\n将此结果代回 $J_{\\mathrm{cycle}}$ 的表达式中：\n$$\nJ_{\\mathrm{cycle}} = \\frac{1}{3} \\left( \\frac{1}{5} \\right) = \\frac{1}{15}\n$$\n流的正号表示存在沿环 $1 \\to 2 \\to 3 \\to 1$ 方向的净概率流。\n稳态环流的精确值为 $\\frac{1}{15}$。",
            "answer": "$$\\boxed{\\frac{1}{15}}$$"
        },
        {
            "introduction": "最后一个练习将理论与计算实践联系起来，提出了一个源于真实科研场景的挑战。当面对一个通过模拟得到的轨迹数据时，我们如何判断其背后的系统是否满足可逆性？这个练习要求你设计一个统计检验方法，将零净通量的理论概念与有限数据的假设检验任务联系起来，这是计算科学中的一项关键技能。",
            "id": "3748912",
            "problem": "您的任务是设计并实现一个统计检验，用于检验有限状态、时间齐次、离散时间马尔可夫链的细致平衡条件。目标是根据一条长轨迹，判断其底层的马尔可夫链是否满足关于某个平稳分布的细致平衡条件。细致平衡条件规定，对于每一对不同的状态 $i \\neq j$，平稳概率流 $J_{ij}$ 等于零，其中 $J_{ij}$ 定义为 $J_{ij} = \\pi_i P_{ij} - \\pi_j P_{ji}$，$\\pi$ 表示平稳分布，$P$ 表示转移矩阵。您的程序必须实现一个检验，该检验从经验轨迹中估计 $J_{ij}$，并在一个经过多重比较校正的置信区间内评估 $J_{ij} \\approx 0$ 是否成立。\n\n基本原理和定义：\n- 考虑一个在有限状态空间 $\\{1,\\dots,k\\}$ 上的马尔可夫链，其转移矩阵为 $P = (P_{ij})_{i,j=1}^k$，其中 $P_{ij} \\ge 0$ 且对每个 $i$ 都有 $\\sum_{j=1}^k P_{ij} = 1$。\n- 一个平稳分布 $\\pi = (\\pi_1,\\dots,\\pi_k)$ 满足 $\\pi_i \\ge 0$，$\\sum_{i=1}^k \\pi_i = 1$，以及 $\\pi = \\pi P$。\n- 细致平衡条件是指对于所有的 $i \\neq j$，$\\pi_i P_{ij} = \\pi_j P_{ji}$，这等价于对所有 $i \\neq j$，$J_{ij} = 0$。\n- 给定一条轨迹 $(X_t)_{t=0}^{n}$，定义经验转移计数 $C_{ij} = \\#\\{t \\in \\{0,\\dots,n-1\\} : X_t = i, X_{t+1} = j\\}$。经验流估计量为 $\\widehat{J}_{ij} = \\frac{C_{ij} - C_{ji}}{n}$。\n\n任务要求：\n1. 根据上述基本定义，设计一个统计检验来评估原假设，即链是可逆的（满足细致平衡），且仅使用轨迹数据。您的检验必须：\n   - 使用由经验计数 $C_{ij}$ 和 $C_{ji}$ 构建的估计量 $\\widehat{J}_{ij}$。\n   - 从第一性原理出发，论证 $\\widehat{J}_{ij}$ 的一个渐近方差估计，并使用邦费罗尼校正，针对所有 $i  j$ 的无序对 $\\{i,j\\}$，在全局显著性水平 $\\alpha$ 下构建一个双边置信区间。\n   - 当且仅当所有无序对 $\\{i,j\\}$ 的所有已构建置信区间都包含 $0$ 时，判定接受细致平衡假设。\n\n2. 实现约束：\n   - 对每个测试用例，使用给定的转移矩阵 $P$ 和从其平稳分布 $\\pi$ 中抽样的初始状态来模拟轨迹。\n   - 为保证可复现性，所有模拟均使用固定的随机种子 $2025$。\n   - 对每个测试用例，使用全局显著性水平 $\\alpha = 0.05$ 和邦费罗尼校正，覆盖 $m = k(k-1)/2$ 个无序对。\n   - 对于每个 $i  j$ 的无序对 $\\{i,j\\}$，使用正态近似和从经验计数导出的代入式方差估计，计算 $J_{ij}$ 的双边置信区间。\n\n3. 测试套件：\n   为以下三种情况实现您的检验。在所有情况下，状态空间的大小为 $k = 3$。\n\n   - 情况 A（可逆，稠密连接）：选择平稳分布 $\\pi = (0.2, 0.5, 0.3)$ 和一个对称耦合矩阵 $C$，其非对角线元素为 $C_{12} = 0.04$，$C_{13} = 0.03$，$C_{23} = 0.05$，且 $C_{ij} = C_{ji}$，$C_{ii} = 0$。通过 $P_{ij} = C_{ij} / \\pi_i$（对于 $i \\neq j$）和 $P_{ii} = 1 - \\sum_{j \\neq i} P_{ij}$ 定义转移。这给出了显式的转移矩阵\n     $$\n     P^{(A)} = \\begin{pmatrix}\n     0.65  0.20  0.15 \\\\\n     0.08  0.82  0.10 \\\\\n     0.10  0.16666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一个长度为 $n = 300000$ 次转移的轨迹。\n\n   - 情况 B（不可逆，有偏边）：仅修改 $P^{(A)}$ 的第一行，通过增加从状态 $1$ 转移到状态 $2$ 的概率来引入方向性偏差。具体为，\n     $$\n     P^{(B)} = \\begin{pmatrix}\n     0.55  0.30  0.15 \\\\\n     0.08  0.82  0.10 \\\\\n     0.10  0.16666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一个长度为 $n = 300000$ 次转移的轨迹。\n\n   - 情况 C（可逆，稀疏连接且缺少直接边）：选择平稳分布 $\\pi = (0.3, 0.4, 0.3)$ 和对称耦合，其中 $C_{12} = 0.06$，$C_{13} = 0.0$，$C_{23} = 0.08$，$C_{ij} = C_{ji}$，$C_{ii} = 0$。通过 $P_{ij} = C_{ij} / \\pi_i$（对于 $i \\neq j$）和 $P_{ii} = 1 - \\sum_{j \\neq i} P_{ij}$ 定义转移。这给出了显式的转移矩阵\n     $$\n     P^{(C)} = \\begin{pmatrix}\n     0.8  0.2  0.0 \\\\\n     0.15  0.65  0.2 \\\\\n     0.0  0.26666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一个长度为 $n = 150000$ 次转移的轨迹。\n\n4. 统计决策规则：\n   - 对于每个具有 $k = 3$ 个状态的情况，有 $m = 3$ 个无序对。使用邦费罗尼校正的每对显著性水平 $\\alpha_{\\text{pair}} = \\alpha / m$，其中 $\\alpha = 0.05$。\n   - 对于每个 $i  j$ 的无序对 $\\{i,j\\}$，计算经验计数 $C_{ij}$ 和 $C_{ji}$。构建估计量 $\\widehat{J}_{ij} = (C_{ij} - C_{ji})/n$。使用正态近似和代入式方差，构建双边置信区间\n     $$\n     \\widehat{J}_{ij} \\pm z_{1 - \\alpha_{\\text{pair}}/2} \\cdot \\frac{\\sqrt{C_{ij} + C_{ji}}}{n},\n     $$\n     其中 $z_{1 - \\alpha_{\\text{pair}}/2}$ 是标准正态分布在水平 $1 - \\alpha_{\\text{pair}}/2$ 处的分位数。\n   - 当且仅当数值 $0$ 位于所有三个区间内时，判定该情况下的细致平衡条件成立。\n\n5. 输出格式：\n   您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表（例如，$[True,False,True]$）。每个条目按 A、B、C 的顺序对应一种情况，并且是一个布尔值，指示在全局显著性水平 $\\alpha = 0.05$ 下是否接受细致平衡。\n\n此处不适用角度单位和物理单位。所有计算都是无单位的。输出必须是指定格式的单行文本，包含布尔值。",
            "solution": "目标是通过分析单条长轨迹 $(X_t)_{t=0}^{n}$ 来确定一个有限状态、离散时间的马尔可夫链是否是可逆的。如果一个链关于其平稳分布 $\\pi$ 满足细致平衡条件，则该链是可逆的。\n\n对于一个在状态空间 $\\{1, \\dots, k\\}$ 上，具有转移矩阵 $P = (P_{ij})$ 和平稳分布 $\\pi = (\\pi_i)$ 的马尔可夫链，其细致平衡条件由下式给出：\n$$ \\pi_i P_{ij} = \\pi_j P_{ji} \\quad \\text{对于所有状态对 } i, j $$\n这意味着在统计平衡状态下，从状态 $i$ 到状态 $j$ 的转移速率等于从 $j$ 到 $i$ 的转移速率。一个等价的表述是，对于所有状态对 $i, j$，净概率流 $J_{ij} = \\pi_i P_{ij} - \\pi_j P_{ji}$ 为零。\n\n任务是执行一个假设检验，其中原假设 $H_0$ 是链是可逆的，即对所有状态对 $i, j$，$J_{ij} = 0$。该检验将基于从观测轨迹中导出的经验估计。\n\n流 $J_{ij}$ 的经验估计量定义为 $\\widehat{J}_{ij} = \\frac{C_{ij} - C_{ji}}{n}$，其中 $C_{ij}$ 是在长度为 $n$（即 $n+1$ 个状态）的轨迹中观测到的从状态 $i$ 到状态 $j$ 的转移次数。\n$C_{ij} = \\sum_{t=0}^{n-1} \\mathbb{I}(X_t = i, X_{t+1} = j)$，其中 $\\mathbb{I}(\\cdot)$ 是指示函数。\n\n根据马尔可夫链的遍历定理，当 $n \\to \\infty$ 时，经验估计量 $\\widehat{J}_{ij}$ 几乎必然收敛到真实的流 $J_{ij}$。\n$$ \\widehat{J}_{ij} = \\frac{1}{n} \\sum_{t=0}^{n-1} (\\mathbb{I}(X_t=i, X_{t+1}=j) - \\mathbb{I}(X_t=j, X_{t+1}=i)) \\xrightarrow{a.s.} \\pi_i P_{ij} - \\pi_j P_{ji} = J_{ij} $$\n此外，马尔可夫链的中心极限定理 (CLT) 指出，$\\sqrt{n}(\\widehat{J}_{ij} - J_{ij})$ 在分布上收敛于一个均值为 $0$、方差为 $\\sigma_{ij}^2$ 的正态分布。在原假设 $H_0: J_{ij} = 0$ 下，估计量 $\\widehat{J}_{ij}$ 近似服从均值为 $0$ 的正态分布。\n\n需要估计 $\\widehat{J}_{ij}$ 的方差。一个标准且实用的方法，如问题中所述，是将计数 $C_{ij}$ 和 $C_{ji}$ 视为独立的泊松随机变量。对于泊松变量，方差等于其均值。$C_{ij}$ 的均值为 $E[C_{ij}] \\approx n \\pi_i P_{ij}$。该均值的一个代入式估计量就是观测到的计数值 $C_{ij}$ 本身。由此可得：\n$$ Var(\\widehat{J}_{ij}) = Var\\left(\\frac{C_{ij} - C_{ji}}{n}\\right) = \\frac{1}{n^2} (Var(C_{ij}) + Var(C_{ji})) $$\n通过近似 $Var(C_{ij}) \\approx C_{ij}$ 和 $Var(C_{ji}) \\approx C_{ji}$，我们得到估计的方差：\n$$ \\widehat{Var}(\\widehat{J}_{ij}) = \\frac{C_{ij} + C_{ji}}{n^2} $$\n该估计量对应的标准误是：\n$$ SE(\\widehat{J}_{ij}) = \\frac{\\sqrt{C_{ij} + C_{ji}}}{n} $$\n这为问题陈述中给出的置信区间公式提供了依据。\n\n我们正在对所有 $m = k(k-1)/2$ 个 $i \\neq j$ 的无序状态对 $\\{i, j\\}$ 进行同步检验。为了保持全局显著性水平 $\\alpha$，我们必须进行多重比较校正。问题指定了邦费罗尼校正，这是一种控制族内错误率 (FWER) 的保守方法。每个独立检验的显著性水平设为 $\\alpha_{\\text{pair}} = \\alpha/m$。\n\n对于每个 $i  j$ 的对 $\\{i,j\\}$，我们在 $1 - \\alpha_{\\text{pair}}$ 的置信水平下为 $J_{ij}$ 构建一个双边置信区间。该区间为：\n$$ \\left[ \\widehat{J}_{ij} - z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij}), \\quad \\widehat{J}_{ij} + z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij}) \\right] $$\n其中 $z_{1 - \\alpha_{\\text{pair}}/2}$ 是标准正态分布的上 $(1 - \\alpha_{\\text{pair}}/2)$-分位数。\n\n决策规则是：当且仅当数值 $0$ 包含在这 $m$ 个置信区间中的每一个时，接受全局原假设 $H_0$（即，结论为链是可逆的）。条件 $0 \\in [L, U]$ 等价于 $|\\widehat{J}_{ij}| \\le \\text{误差范围}$，其中误差范围为 $z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij})$。\n\n每个测试用例的实现步骤如下：\n1.  **准备**：定义转移矩阵 $P$、状态数 $k$、轨迹长度 $n$ 和全局显著性水平 $\\alpha$。对于情况 B，必须计算其平稳分布 $\\pi^{(B)}$，因为它与情况 A 的不同。这可以通过找到 $P^{(B)}$ 对应于特征值 $1$ 的左特征向量来完成。\n2.  **模拟**：使用固定的种子 ($2025$) 初始化一个随机数生成器以保证可复现性。从平稳分布 $\\pi$ 中抽样初始状态 $X_0$。通过迭代地从由 $P$ 的第 $X_t$ 行给出的概率分布中抽样 $X_{t+1}$ 来生成轨迹 $(X_t)_{t=0}^{n}$。\n3.  **计数**：通过遍历模拟的轨迹，填充经验转移计数矩阵 $C=(C_{ij})$（一个 $k \\times k$ 的矩阵）。\n4.  **检验**：\n    *   对的数量为 $m = k(k-1)/2$。\n    *   邦费罗尼校正后的显著性水平为 $\\alpha_{\\text{pair}} = \\alpha/m$。\n    *   计算临界 z 值 $z_{crit} = z_{1 - \\alpha_{\\text{pair}}/2}$。\n    *   对于每个 $i  j$ 的无序对 $\\{i,j\\}$：\n        *   计算经验流 $\\widehat{J}_{ij} = (C_{ij} - C_{ji}) / n$。\n        *   计算标准误 $SE(\\widehat{J}_{ij}) = \\sqrt{C_{ij} + C_{ji}} / n$。\n        *   检查检验条件 $|\\widehat{J}_{ij}| \\le z_{crit} \\cdot SE(\\widehat{J}_{ij})$ 是否成立。\n    *   如果任何一对不满足该条件，则拒绝该情况下的细致平衡假设。如果所有对都满足该条件，则接受该假设。\n\n对于给定的参数（$k=3$, $\\alpha=0.05$），我们有 $m=3$ 对。每对的显著性水平为 $\\alpha_{\\text{pair}} = 0.05/3$。临界值为 $z_{1 - (0.05/3)/2} = z_{1 - 0.05/6} \\approx z_{0.991667}$。情况 A 和 C 被构造成可逆的，因此预期会通过检验。情况 B 被构造成不可逆的，对于给定的长轨迹长度，预期该检验具有足够的统计功效来检测到这一点并拒绝假设。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef find_stationary_distribution(p_matrix):\n    \"\"\"\n    Computes the stationary distribution of a Markov chain.\n    \"\"\"\n    # We need to find the left eigenvector of P for eigenvalue 1.\n    # This is the same as the right eigenvector of P.T for eigenvalue 1.\n    eigenvalues, eigenvectors = np.linalg.eig(p_matrix.T)\n    \n    # Find the eigenvector corresponding to the eigenvalue closest to 1\n    # Using np.isclose is robust to floating point inaccuracies\n    idx = np.isclose(eigenvalues, 1).argmax()\n    stationary_vector = np.real(eigenvectors[:, idx])\n    \n    # Normalize the eigenvector to make it a probability distribution\n    stationary_distribution = stationary_vector / np.sum(stationary_vector)\n    return stationary_distribution\n\ndef run_test_case(P, n, k, alpha, seed, pi=None):\n    \"\"\"\n    Runs the detailed balance test for a single case.\n\n    Args:\n        P (np.ndarray): The k x k transition matrix.\n        n (int): The number of transitions to simulate.\n        k (int): The number of states.\n        alpha (float): The global significance level.\n        seed (int): The random seed for reproducibility.\n        pi (np.ndarray, optional): The stationary distribution. If None, it's computed.\n\n    Returns:\n        bool: True if detailed balance is accepted, False otherwise.\n    \"\"\"\n    if pi is None:\n        pi = find_stationary_distribution(P)\n\n    # 1. Simulate the trajectory\n    rng = np.random.default_rng(seed)\n    \n    # Initial state sampled from stationary distribution\n    states = np.arange(k)\n    current_state = rng.choice(states, p=pi)\n    \n    # Trajectory simulation\n    trajectory = np.zeros(n + 1, dtype=int)\n    trajectory[0] = current_state\n    for t in range(n):\n        next_state_probs = P[trajectory[t], :]\n        trajectory[t+1] = rng.choice(states, p=next_state_probs)\n\n    # 2. Compute empirical transition counts\n    C = np.zeros((k, k), dtype=int)\n    for t in range(n):\n        i, j = trajectory[t], trajectory[t+1]\n        C[i, j] += 1\n        \n    # 3. Perform the statistical test\n    num_pairs = k * (k - 1) // 2\n    alpha_pair = alpha / num_pairs\n    z_crit = norm.ppf(1 - alpha_pair / 2)\n    \n    overall_acceptance = True\n    \n    for i in range(k):\n        for j in range(i + 1, k):\n            # For each unordered pair {i, j}\n            C_ij = C[i, j]\n            C_ji = C[j, i]\n            \n            # Estimator for flux\n            J_ij_hat = (C_ij - C_ji) / n\n            \n            # Standard error of the estimator\n            # Avoid division by zero if n=0; handle cases with zero counts\n            if C_ij + C_ji == 0:\n                se_J_ij_hat = 0.0\n            else:\n                se_J_ij_hat = np.sqrt(C_ij + C_ji) / n\n\n            # Margin of error for the confidence interval\n            margin_of_error = z_crit * se_J_ij_hat\n            \n            # Check if 0 is in the confidence interval\n            # This is equivalent to |J_ij_hat| = margin_of_error\n            if abs(J_ij_hat)  margin_of_error:\n                overall_acceptance = False\n                break\n        if not overall_acceptance:\n            break\n            \n    return overall_acceptance\n\ndef solve():\n    \"\"\"\n    Main function to define and run all test cases.\n    \"\"\"\n    k = 3\n    alpha = 0.05\n    seed = 2025\n\n    # Case A: Reversible, dense\n    pi_A = np.array([0.2, 0.5, 0.3])\n    P_A = np.array([\n        [0.65, 0.20, 0.15],\n        [0.08, 0.82, 0.10],\n        [0.10, 1/6, 11/15]\n    ])\n    n_A = 300000\n\n    # Case B: Non-reversible, biased\n    P_B = np.array([\n        [0.55, 0.30, 0.15],\n        [0.08, 0.82, 0.10],\n        [0.10, 1/6, 11/15]\n    ])\n    n_B = 300000\n\n    # Case C: Reversible, sparse\n    pi_C = np.array([0.3, 0.4, 0.3])\n    P_C = np.array([\n        [0.8, 0.2, 0.0],\n        [0.15, 0.65, 0.2],\n        [0.0, 4/15, 11/15]\n    ])\n    n_C = 150000\n    \n    test_cases = [\n        (P_A, n_A, pi_A),\n        (P_B, n_B, None),\n        (P_C, n_C, pi_C)\n    ]\n\n    results = []\n    for P, n, pi in test_cases:\n        result = run_test_case(P, n, k, alpha, seed, pi)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}