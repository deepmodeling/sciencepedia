{
    "hands_on_practices": [
        {
            "introduction": "为了建立对细致平衡条件的扎实理解，我们从一个基础练习开始。该问题探讨了有限晶格上的对称随机游走，这是一个经典的扩散模型。通过直接应用细致平衡方程，您将推导出系统的平衡分布，从而展示这一强大条件如何简化可逆过程的分析。",
            "id": "3748914",
            "problem": "考虑一个在有限状态格点 $\\{0,1,\\dots,N\\}$ 上的离散时间最近邻随机游走，其中 $N \\in \\mathbb{N}$ 且 $N \\geq 2$。其动力学由以下转移概率定义：\n$$\nP(i,i-1) = \\frac{1}{2}, \\quad P(i,i+1) = \\frac{1}{2} \\quad \\text{对于所有 } i \\in \\{1,2,\\dots,N-1\\},\n$$\n以及反射边界：\n$$\nP(0,0) = \\frac{1}{2}, \\quad P(0,1) = \\frac{1}{2}, \\qquad P(N,N) = \\frac{1}{2}, \\quad P(N,N-1) = \\frac{1}{2}.\n$$\n这种随机游走可以被看作是带有 Neumann 边界条件的可逆扩散的粗粒度模型，并且在构建尊重界面局部平衡的介观近似时，被广泛应用于多尺度建模与分析。设 $\\pi$ 表示此马尔可夫链的一个不变分布，由全局平衡条件 $\\pi = \\pi P$ 定义，并回顾细致平衡条件要求对所有状态对 $i$ 和 $j$，都有 $\\pi(i) P(i,j) = \\pi(j) P(j,i)$。\n\n仅从给定的转移结构以及不变分布和细致平衡的定义出发，推导 $\\pi$ 并验证所有相邻状态对的细致平衡条件。作为最终答案，报告分配给每个状态的不变概率的公共值 $c$，以 $N$ 的闭式解形式表示。不需要四舍五入，也不涉及物理单位。你的答案必须是单一的解析表达式。",
            "solution": "问题要求我们为状态空间 $\\{0, 1, \\dots, N\\}$ 上的离散时间马尔可夫链推导其不变分布，记为 $\\pi$。我们必须从给定的转移概率和细致平衡的定义出发，验证该条件对相邻状态成立，并确定每个状态的不变概率的常数值。\n\n状态空间为 $S = \\{0, 1, \\dots, N\\}$，其中 $N \\in \\mathbb{N}$ 且 $N \\geq 2$。状态总数为 $N+1$。非零转移概率 $P(i,j)$ 如下：\n对于内部状态 $i \\in \\{1, 2, \\dots, N-1\\}$：\n$$\nP(i, i-1) = \\frac{1}{2}, \\quad P(i, i+1) = \\frac{1}{2}\n$$\n对于边界状态 $i=0$：\n$$\nP(0, 0) = \\frac{1}{2}, \\quad P(0, 1) = \\frac{1}{2}\n$$\n对于边界状态 $i=N$：\n$$\nP(N, N) = \\frac{1}{2}, \\quad P(N, N-1) = \\frac{1}{2}\n$$\n不变分布 $\\pi$ 是一个满足全局平衡条件 $\\sum_{i \\in S} \\pi(i) P(i,j) = \\pi(j)$ 对所有 $j \\in S$ 成立的概率分布。细致平衡条件是一个更强的条件，由下式给出：\n$$\n\\pi(i) P(i,j) = \\pi(j) P(j,i) \\quad \\text{对所有 } i, j \\in S\n$$\n如果一个分布 $\\pi$ 满足细致平衡条件，那么它保证满足全局平衡条件，因此是一个不变分布。我们将利用这个原理来寻找 $\\pi$。我们的方法是假设存在这样一个满足细致平衡的 $\\pi$，然后利用这个假设来确定 $\\pi$ 的形式。\n\n我们将系统地检验所有相邻状态对 $(i, i+1)$（其中 $i \\in \\{0, 1, \\dots, N-1\\}$）的细致平衡条件。\n\n情况 1：边界对 $(0, 1)$。\n这对状态的细致平衡方程是 $\\pi(0) P(0,1) = \\pi(1) P(1,0)$。\n根据问题陈述，我们有 $P(0,1) = \\frac{1}{2}$ 和 $P(1,0) = \\frac{1}{2}$。\n代入这些值可得：\n$$\n\\pi(0) \\cdot \\frac{1}{2} = \\pi(1) \\cdot \\frac{1}{2}\n$$\n这意味着 $\\pi(0) = \\pi(1)$。\n\n情况 2：内部状态对 $(i, i+1)$（其中 $i \\in \\{1, 2, \\dots, N-2\\}$）。\n细致平衡方程是 $\\pi(i) P(i,i+1) = \\pi(i+1) P(i+1,i)$。\n这些状态的转移概率是 $P(i, i+1) = \\frac{1}{2}$ 和 $P(i+1, i) = \\frac{1}{2}$。\n代入这些值：\n$$\n\\pi(i) \\cdot \\frac{1}{2} = \\pi(i+1) \\cdot \\frac{1}{2}\n$$\n这意味着对所有 $i = 1, 2, \\dots, N-2$，都有 $\\pi(i) = \\pi(i+1)$。\n\n情况 3：边界对 $(N-1, N)$。\n细致平衡方程是 $\\pi(N-1) P(N-1,N) = \\pi(N) P(N,N-1)$。\n转移概率是 $P(N-1, N) = \\frac{1}{2}$ 和 $P(N, N-1) = \\frac{1}{2}$。\n代入这些值：\n$$\n\\pi(N-1) \\cdot \\frac{1}{2} = \\pi(N) \\cdot \\frac{1}{2}\n$$\n这意味着 $\\pi(N-1) = \\pi(N)$。\n\n综合所有情况的结果，我们得到一系列等式：\n$$\n\\pi(0) = \\pi(1) = \\pi(2) = \\dots = \\pi(N-1) = \\pi(N)\n$$\n这表明不变分布必须是状态空间上的均匀分布。我们用 $c$ 表示每个状态概率的公共值，即对所有 $i \\in \\{0, 1, \\dots, N\\}$，有 $\\pi(i) = c$。\n\n至此，我们已经按要求验证了所有相邻状态对的细致平衡条件。为完整起见，我们还应检查非相邻对和自转移。\n对于任何非相邻对 $(i,j)$，其中 $|i-j| > 1$，我们有 $P(i,j) = 0$ 和 $P(j,i) = 0$。细致平衡条件变为 $c \\cdot 0 = c \\cdot 0$，这是平凡满足的。\n对于自转移，例如在状态 $0$，条件是 $\\pi(0)P(0,0)=\\pi(0)P(0,0)$。当 $\\pi(0)=c$ 且 $P(0,0)=\\frac{1}{2}$ 时，这变为 $c \\cdot \\frac{1}{2} = c \\cdot \\frac{1}{2}$，这也是平凡成立的。同样的逻辑也适用于状态 $N$ 的自转移。\n\n因此，均匀分布 $\\pi(i)=c$ 对所有状态对都满足细致平衡条件。由于该条件成立，$\\pi$ 确实是一个不变分布。\n\n最后一步是确定常数 $c$ 的值。由于 $\\pi$ 是一个概率分布，所有状态的概率之和必须等于 $1$：\n$$\n\\sum_{i=0}^{N} \\pi(i) = 1\n$$\n代入 $\\pi(i)=c$ 对所有 $i$：\n$$\n\\sum_{i=0}^{N} c = 1\n$$\n这个和包含 $N+1$ 个相同的项，每一项都等于 $c$。因此，方程变为：\n$$\n(N+1)c = 1\n$$\n解出 $c$，我们得到每个状态的不变概率值为：\n$$\nc = \\frac{1}{N+1}\n$$\n这就是分配给每个状态的不变概率的公共值，用 $N$ 的闭式解表示。不变分布为 $\\pi(i) = \\frac{1}{N+1}$，适用于所有 $i \\in \\{0, 1, \\dots, N\\}$。",
            "answer": "$$\n\\boxed{\\frac{1}{N+1}}\n$$"
        },
        {
            "introduction": "在看过了处于平衡态的系统之后，我们现在转向当细致平衡被打破时会发生什么。这个练习研究了一个环形排列的三态系统，这是由外力驱动的非平衡稳态 (NESS) 的一个典型模型。您将确定满足细致平衡所需的确切条件，更重要的是，当该条件不满足时，您将量化由此产生的持续概率流。",
            "id": "3748918",
            "problem": "考虑一个包含三个粗粒化亚稳态 $1$、$2$ 和 $3$ 的连续时间马尔可夫链（CTMC），这些状态排列成一个环，用于模拟多尺度系统中单一热浴等温环境下各盆地之间的跃迁。假设由于粗粒化而具有平移对称性，因此所有顺时针跃迁具有相同的速率 $r > 0$，具体为 $k_{1,2} = r$、$k_{2,3} = r$ 和 $k_{3,1} = r$；所有逆时针跃迁也具有相同的速率 $s > 0$，具体为 $k_{2,1} = s$、$k_{3,2} = s$ 和 $k_{1,3} = s$。无穷小生成元 $L$ 的非对角线项为 $L_{i,j} = k_{i,j}$（$i \\neq j$），对角线项为 $L_{i,i} = -\\sum_{j \\neq i} k_{i,j}$。稳态分布 $\\pi$ 满足 $\\pi L = 0$ 且 $\\sum_{i=1}^{3} \\pi_{i} = 1$。\n\n从主方程和细致平衡的定义（即，在平衡态下，对所有状态对 $i,j$ 均有 $ \\pi_{i} k_{i,j} = \\pi_{j} k_{j,i}$）出发，完成以下任务：\n\n1. 仅使用这些原理，判断仅存在相等的顺时针速率 $r$ 本身是否与细致平衡兼容，并确定逆时针速率必须满足什么附加条件才能满足细致平衡。您的推理不得依赖任何现成的环路判据；它应直接源于上述定义。\n\n2. 计算非平衡稳态 (NESS) 下的稳态边电流，其在每条有向边上的定义为 $J_{i \\to j} = \\pi_{i} k_{i,j} - \\pi_{j} k_{j,i}$，并约定正向电流为顺时针方向。将您的答案表示为关于 $r$ 和 $s$ 的单行矩阵 $\\begin{pmatrix} J_{1 \\to 2}  J_{2 \\to 3}  J_{3 \\to 1} \\end{pmatrix}$。如果您的最终表达式可以简化为一个精确的闭合形式，请给出该精确形式。不需要进行数值计算。",
            "solution": "根据问题陈述的要求，分析分为两部分。\n\n第一部分：细致平衡的条件\n\n细致平衡原理要求，对于一个处于平衡态且具有稳态分布 $\\pi = (\\pi_1, \\pi_2, \\dots)$ 的系统，任意两个状态 $i$ 和 $j$ 之间的净通量为零。这由以下条件表示：\n$$\n\\pi_{i} k_{i,j} = \\pi_{j} k_{j,i} \\quad \\text{对所有状态对 } (i,j)\n$$\n其中 $k_{i,j}$ 是从状态 $i$ 到状态 $j$ 的跃迁速率。\n\n对于给定的环上三态系统，我们必须对三个不同的相连状态对 $(1,2)$、$(2,3)$ 和 $(3,1)$ 检验此条件。\n\n给定的跃迁速率如下：\n顺时针速率：$k_{1,2} = r$、$k_{2,3} = r$、$k_{3,1} = r$，其中 $r > 0$。\n逆时针速率：$k_{2,1} = s$、$k_{3,2} = s$、$k_{1,3} = s$，其中 $s > 0$。\n\n将细致平衡条件应用于每一对状态：\n1. 对于状态对 $(1,2)$：\n$$\n\\pi_1 k_{1,2} = \\pi_2 k_{2,1} \\implies \\pi_1 r = \\pi_2 s \\implies \\pi_2 = \\pi_1 \\frac{r}{s}\n$$\n2. 对于状态对 $(2,3)$：\n$$\n\\pi_2 k_{2,3} = \\pi_3 k_{3,2} \\implies \\pi_2 r = \\pi_3 s \\implies \\pi_3 = \\pi_2 \\frac{r}{s}\n$$\n3. 对于状态对 $(3,1)$：\n$$\n\\pi_3 k_{3,1} = \\pi_1 k_{1,3} \\implies \\pi_3 r = \\pi_1 s\n$$\n\n为了使细致平衡成立，所有三个条件必须同时满足。我们可以用前两个方程将 $\\pi_2$ 和 $\\pi_3$ 表示为 $\\pi_1$ 的函数：\n从条件1，我们得到 $\\pi_2 = \\pi_1 (r/s)$。\n将此代入条件2，我们得到 $\\pi_3 = (\\pi_1 (r/s)) (r/s) = \\pi_1 (r/s)^2$。\n\n现在，我们将 $\\pi_3$ 的这个表达式代入第三个条件：\n$$\n\\left( \\pi_1 \\left(\\frac{r}{s}\\right)^2 \\right) r = \\pi_1 s\n$$\n由于对于任何有物理意义的状态，稳态概率 $\\pi_1$ 必须为非零（即 $\\pi_1 > 0$），我们可以将等式两边同时除以 $\\pi_1$：\n$$\n\\frac{r^3}{s^2} = s \\implies r^3 = s^3\n$$\n鉴于速率 $r$ 和 $s$ 是正实数，该方程唯一的实数解是：\n$$\nr = s\n$$\n因此，存在相等的顺时针速率 $r$ 与细致平衡是兼容的，但仅在逆时针速率 $s$ 也等于 $r$ 这个特定的附加条件下才成立。如果 $r \\neq s$，系统无法满足细致平衡，因为这会导致上述联立方程出现逻辑矛盾。细致平衡的这种破坏是由于环周围存在净概率流环路。\n\n第二部分：非平衡稳态 (NESS) 中的稳态边电流\n\n当系统具有不随时间变化的稳态分布 $\\pi$，但细致平衡不满足时，就会出现非平衡稳态 (NESS)。在本问题中，当 $r \\neq s$ 时即是如此。我们首先需要计算稳态分布 $\\pi = (\\pi_1, \\pi_2, \\pi_3)$。\n\n该 CTMC 的无穷小生成元 $L$ 由下式给出：\n$$\nL = \\begin{pmatrix} -(k_{1,2} + k_{1,3})  k_{1,2}  k_{1,3} \\\\ k_{2,1}  -(k_{2,1} + k_{2,3})  k_{2,3} \\\\ k_{3,1}  k_{3,2}  -(k_{3,1} + k_{3,2}) \\end{pmatrix} = \\begin{pmatrix} -(r+s)  r  s \\\\ s  -(r+s)  r \\\\ r  s  -(r+s) \\end{pmatrix}\n$$\n稳态分布 $\\pi$ 是 $L$ 对应于特征值 $0$ 的左特征向量，满足 $\\pi L = 0$ 和归一化条件 $\\sum_i \\pi_i = 1$。由 $\\pi L = 0$ 得到的方程组是：\n$$\n-\\pi_1(r+s) + \\pi_2 s + \\pi_3 r = 0 \\\\\n\\pi_1 r - \\pi_2(r+s) + \\pi_3 s = 0 \\\\\n\\pi_1 s + \\pi_2 r - \\pi_3(r+s) = 0\n$$\n由于问题设置的平移对称性（速率仅取决于跃迁是顺时针还是逆时针，而与具体状态无关），生成元矩阵具有循环结构。相应的稳态分布必须是均匀的。我们通过设 $\\pi_1 = \\pi_2 = \\pi_3 = c$ 来验证这一点。\n根据归一化条件，$\\pi_1 + \\pi_2 + \\pi_3 = 3c = 1$，得出 $c = 1/3$。\n因此，我们检验 $\\pi_1 = \\pi_2 = \\pi_3 = 1/3$。代入第一个方程：\n$$\n-\\frac{1}{3}(r+s) + \\frac{1}{3} s + \\frac{1}{3} r = \\frac{1}{3}(-r - s + s + r) = 0\n$$\n该方程成立。根据对称性，其他两个方程也成立。因此，稳态分布为 $\\pi = (1/3, 1/3, 1/3)$。此结果对任意 $r > 0$ 和 $s > 0$ 的选择均有效。\n\n对于有向边 $i \\to j$，稳态边电流定义为 $J_{i \\to j} = \\pi_{i} k_{i,j} - \\pi_{j} k_{j,i}$。正电流对应于净顺时针流。我们计算三条顺时针方向边的电流：\n1. 从状态 1到 2 的电流：\n$$\nJ_{1 \\to 2} = \\pi_1 k_{1,2} - \\pi_2 k_{2,1} = \\frac{1}{3} r - \\frac{1}{3} s = \\frac{1}{3}(r-s)\n$$\n2. 从状态 2到 3 的电流：\n$$\nJ_{2 \\to 3} = \\pi_2 k_{2,3} - \\pi_3 k_{3,2} = \\frac{1}{3} r - \\frac{1}{3} s = \\frac{1}{3}(r-s)\n$$\n3. 从状态 3到 1 的电流：\n$$\nJ_{3 \\to 1} = \\pi_3 k_{3,1} - \\pi_1 k_{1,3} = \\frac{1}{3} r - \\frac{1}{3} s = \\frac{1}{3}(r-s)\n$$\n正如在具有单个环路的 NESS 中所预期的那样，净电流沿环路是恒定的。值 $J = \\frac{1}{3}(r-s)$ 量化了环周围的净概率流。如果 $r > s$，则存在净顺时针电流。如果 $s > r$，则存在净逆时针电流（负 $J$）。如果 $r=s$，电流为零，我们恢复到细致平衡成立的平衡情况。\n\n最终答案是这些电流组成的行矩阵。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{1}{3}(r-s)  \\frac{1}{3}(r-s)  \\frac{1}{3}(r-s) \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "前面的练习处理的是理想化模型，其中转移规则是完全已知的。在实践中，我们通常从观测数据中推断系统属性。这最后一个动手实践将挑战您设计并实现一个统计检验，仅根据模拟的轨迹来判断一个马尔可夫链是否可逆，这是模型验证和数据分析中的一项基本任务。",
            "id": "3748912",
            "problem": "您的任务是设计并实现一个统计检验，用于检验有限状态、时齐、离散时间马尔可夫链的细致平衡条件。目标是根据单条长轨迹，判断其底层的链是否相对于某个平稳分布满足细致平衡条件。细致平衡条件指出，对于每一对不同状态 $i \\neq j$，平稳概率流 $J_{ij}$ 等于零，其中 $J_{ij}$ 定义为 $J_{ij} = \\pi_i P_{ij} - \\pi_j P_{ji}$，$\\pi$ 表示平稳分布，$P$ 表示转移矩阵。您的程序必须实现一个检验，该检验从经验轨迹中估计 $J_{ij}$，并评估 $J_{ij} \\approx 0$ 是否在一个经过多重比较校正的置信区间内。\n\n基本原理和定义：\n- 考虑一个在有限状态空间 $\\{1,\\dots,k\\}$ 上的马尔可夫链，其转移矩阵为 $P = (P_{ij})_{i,j=1}^k$，其中 $P_{ij} \\ge 0$ 且对每个 $i$ 都有 $\\sum_{j=1}^k P_{ij} = 1$。\n- 平稳分布 $\\pi = (\\pi_1,\\dots,\\pi_k)$ 满足 $\\pi_i \\ge 0$，$\\sum_{i=1}^k \\pi_i = 1$，以及 $\\pi = \\pi P$。\n- 细致平衡条件为，对于所有 $i \\neq j$，$\\pi_i P_{ij} = \\pi_j P_{ji}$，这等价于对于所有 $i \\neq j$，$J_{ij} = 0$。\n- 给定一条轨迹 $(X_t)_{t=0}^{n}$，定义经验转移计数 $C_{ij} = \\#\\{t \\in \\{0,\\dots,n-1\\} : X_t = i, X_{t+1} = j\\}$。经验流估计量为 $\\widehat{J}_{ij} = \\frac{C_{ij} - C_{ji}}{n}$。\n\n任务要求：\n1. 根据上述基本定义，设计一个统计检验，仅使用轨迹数据来评估链是可逆的（满足细致平衡）这一零假设。您的检验必须：\n   - 使用由经验计数 $C_{ij}$ 和 $C_{ji}$ 构建的估计量 $\\widehat{J}_{ij}$。\n   - 从第一性原理推导 $\\widehat{J}_{ij}$ 的渐近方差估计，并为所有无序对 $\\{i,j\\}$，使用邦费罗尼校正，在全局显著性水平 $\\alpha$ 下构建一个双侧置信区间。\n   - 当且仅当所有无序对 $\\{i,j\\}$ 的所有已构建置信区间都包含 $0$ 时，判定接受细致平衡假设。\n\n2. 实现约束：\n   - 使用给定的转移矩阵 $P$ 和从其平稳分布 $\\pi$ 中抽样的初始状态，为每个测试用例模拟轨迹。\n   - 为保证可复现性，所有模拟均使用固定的随机种子 $2025$。\n   - 对每个测试用例的 $m = k(k-1)/2$ 个无序对，使用全局显著性水平 $\\alpha = 0.05$ 和邦费罗尼校正。\n   - 对于每个无序对 $\\{i,j\\}$，使用正态近似和从经验计数导出的插件方差估计，计算 $J_{ij}$ 的双侧置信区间。\n\n3. 测试套件：\n   为以下三种情况实现您的检验。在所有情况中，状态空间的大小均为 $k = 3$。\n\n   - 情况 A (可逆，稠密连接)：选择平稳分布 $\\pi = (0.2, 0.5, 0.3)$ 和一个对称耦合矩阵 $C$，其非对角线元素为 $C_{12} = 0.04$，$C_{13} = 0.03$，$C_{23} = 0.05$ 且 $C_{ij} = C_{ji}$，以及 $C_{ii} = 0$。通过 $P_{ij} = C_{ij} / \\pi_i$（当 $i \\neq j$）和 $P_{ii} = 1 - \\sum_{j \\neq i} P_{ij}$ 定义转移。这得出的显式转移矩阵为\n     $$\n     P^{(A)} = \\begin{pmatrix}\n     0.65  0.20  0.15 \\\\\n     0.08  0.82  0.10 \\\\\n     0.10  0.16666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一条长度为 $n = 300000$ 次转移的轨迹。\n\n   - 情况 B (不可逆，有偏边)：仅修改 $P^{(A)}$ 的第一行，通过增加从状态 $1$ 转移到状态 $2$ 的概率来引入方向性偏差。具体为：\n     $$\n     P^{(B)} = \\begin{pmatrix}\n     0.55  0.30  0.15 \\\\\n     0.08  0.82  0.10 \\\\\n     0.10  0.16666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一条长度为 $n = 300000$ 次转移的轨迹。\n\n   - 情况 C (可逆，稀疏连接且缺少直接边)：选择平稳分布 $\\pi = (0.3, 0.4, 0.3)$ 和对称耦合，其中 $C_{12} = 0.06$，$C_{13} = 0.0$，$C_{23} = 0.08$ 且 $C_{ij} = C_{ji}$，以及 $C_{ii} = 0$。通过 $P_{ij} = C_{ij} / \\pi_i$（当 $i \\neq j$）和 $P_{ii} = 1 - \\sum_{j \\neq i} P_{ij}$ 定义转移。这得出的显式转移矩阵为\n     $$\n     P^{(C)} = \\begin{pmatrix}\n     0.8  0.2  0.0 \\\\\n     0.15  0.65  0.2 \\\\\n     0.0  0.26666666666666666  0.7333333333333334\n     \\end{pmatrix}.\n     $$\n     模拟一条长度为 $n = 150000$ 次转移的轨迹。\n\n4. 统计决策规则：\n   - 对于每个 $k = 3$ 个状态的情况，有 $m = 3$ 个无序对。使用邦费罗尼校正后的每对显著性水平 $\\alpha_{\\text{pair}} = \\alpha / m$，其中 $\\alpha = 0.05$。\n   - 对于每个无序对 $\\{i,j\\}$，计算经验计数 $C_{ij}$ 和 $C_{ji}$。构建估计量 $\\widehat{J}_{ij} = (C_{ij} - C_{ji})/n$。使用正态近似和插件方差，构建双侧置信区间\n     $$\n     \\widehat{J}_{ij} \\pm z_{1 - \\alpha_{\\text{pair}}/2} \\cdot \\frac{\\sqrt{C_{ij} + C_{ji}}}{n},\n     $$\n     其中 $z_{1 - \\alpha_{\\text{pair}}/2}$ 是标准正态分布在 $1 - \\alpha_{\\text{pair}}/2$ 水平上的分位数。\n   - 当且仅当数值 $0$ 位于所有三个区间内时，判定该情况的细致平衡条件成立。\n\n5. 输出格式：\n   您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表的结果（例如，$[True,False,True]$）。每个条目按 A、B、C 的顺序对应一种情况，是一个布尔值，指示在全局显著性水平 $\\alpha = 0.05$ 下是否接受细致平衡。\n\n此处不涉及角度单位和物理单位。所有计算都是无量纲的。输出必须严格遵守指定格式，仅包含一行布尔值。",
            "solution": "如果一个链相对于其平稳分布 $\\pi$ 满足细致平衡条件，则该链是可逆的。我们的目标是通过分析单条长轨迹 $(X_t)_{t=0}^{n}$ 来确定一个有限状态、离散时间的马尔可夫链是否可逆。\n\n对于一个在状态空间 $\\{1, \\dots, k\\}$ 上，具有转移矩阵 $P = (P_{ij})$ 和平稳分布 $\\pi = (\\pi_i)$ 的马尔可夫链，其细致平衡条件由下式给出：\n$$ \\pi_i P_{ij} = \\pi_j P_{ji} \\quad \\text{对于所有状态对 } i, j $$\n这意味着在统计平衡状态下，从状态 $i$ 到状态 $j$ 的转移速率等于从状态 $j$ 到状态 $i$ 的转移速率。一个等价的表述是，对于所有状态对 $i, j$，净概率流 $J_{ij} = \\pi_i P_{ij} - \\pi_j P_{ji}$ 为零。\n\n任务是执行一个假设检验，其零假设 $H_0$ 是链是可逆的，即对于所有状态对 $i, j$，$J_{ij} = 0$。该检验将基于从观测到的轨迹中导出的经验估计量。\n\n流 $J_{ij}$ 的经验估计量定义为 $\\widehat{J}_{ij} = \\frac{C_{ij} - C_{ji}}{n}$，其中 $C_{ij}$ 是在长度为 $n$（即 $n+1$ 个状态）的轨迹中观测到的从状态 $i$ 到状态 $j$ 的转移次数。\n$C_{ij} = \\sum_{t=0}^{n-1} \\mathbb{I}(X_t = i, X_{t+1} = j)$，其中 $\\mathbb{I}(\\cdot)$ 是指示函数。\n\n根据马尔可夫链的遍历定理，当 $n \\to \\infty$ 时，经验估计量 $\\widehat{J}_{ij}$ 收敛于真实流 $J_{ij}$。\n$$ \\widehat{J}_{ij} = \\frac{1}{n} \\sum_{t=0}^{n-1} (\\mathbb{I}(X_t=i, X_{t+1}=j) - \\mathbb{I}(X_t=j, X_{t+1}=i)) \\xrightarrow{a.s.} \\pi_i P_{ij} - \\pi_j P_{ji} = J_{ij} $$\n此外，马尔可夫链的中心极限定理 (CLT) 指出，$\\sqrt{n}(\\widehat{J}_{ij} - J_{ij})$ 在分布上收敛于一个均值为 $0$、方差为某个 $\\sigma_{ij}^2$ 的正态分布。在零假设 $H_0: J_{ij} = 0$ 下，估计量 $\\widehat{J}_{ij}$ 近似服从均值为 $0$ 的正态分布。\n\n$\\widehat{J}_{ij}$ 的方差需要被估计。一个标准的实用方法，正如问题中所指定的，是将计数 $C_{ij}$ 和 $C_{ji}$ 建模为独立的泊松随机变量。对于泊松变量，方差等于其均值。$C_{ij}$ 的均值为 $E[C_{ij}] \\approx n \\pi_i P_{ij}$。该均值的一个插件估计量就是观测到的计数 $C_{ij}$ 本身。这导致：\n$$ Var(\\widehat{J}_{ij}) = Var\\left(\\frac{C_{ij} - C_{ji}}{n}\\right) = \\frac{1}{n^2} (Var(C_{ij}) + Var(C_{ji})) $$\n通过近似 $Var(C_{ij}) \\approx C_{ij}$ 和 $Var(C_{ji}) \\approx C_{ji}$，我们得到估计的方差：\n$$ \\widehat{Var}(\\widehat{J}_{ij}) = \\frac{C_{ij} + C_{ji}}{n^2} $$\n该估计量的相应标准误是：\n$$ SE(\\widehat{J}_{ij}) = \\frac{\\sqrt{C_{ij} + C_{ji}}}{n} $$\n这为问题陈述中给出的置信区间公式提供了理论依据。\n\n我们正在对所有 $m = k(k-1)/2$ 个 $i \\neq j$ 的无序状态对 $\\{i, j\\}$ 进行同步检验。为了维持全局显著性水平 $\\alpha$，我们必须进行多重比较校正。问题指定了邦费罗尼校正，这是一种控制族错误率 (FWER) 的保守方法。每个独立检验的显著性水平被设为 $\\alpha_{\\text{pair}} = \\alpha/m$。\n\n对于每个无序对 $\\{i,j\\}$，我们构建一个置信水平为 $1 - \\alpha_{\\text{pair}}$ 的 $J_{ij}$ 的双侧置信区间。该区间为：\n$$ \\left[ \\widehat{J}_{ij} - z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij}), \\quad \\widehat{J}_{ij} + z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij}) \\right] $$\n其中 $z_{1 - \\alpha_{\\text{pair}}/2}$ 是标准正态分布的上 $(1 - \\alpha_{\\text{pair}}/2)$-分位数。\n\n决策规则是：当且仅当数值 $0$ 被包含在所有这 $m$ 个置信区间内时，接受全局零假设 $H_0$（即，结论为链是可逆的）。条件 $0 \\in [L, U]$ 等价于 $|\\widehat{J}_{ij}| \\le \\text{误差范围}$，其中误差范围是 $z_{1 - \\alpha_{\\text{pair}}/2} \\cdot SE(\\widehat{J}_{ij})$。\n\n每个测试用例的实现流程如下：\n1.  **准备**：定义转移矩阵 $P$、状态数 $k$、轨迹长度 $n$ 和全局显著性水平 $\\alpha$。对于情况 B，必须计算其平稳分布 $\\pi^{(B)}$，因为它与情况 A 的不同。这可以通过找到 $P^{(B)}$ 对应于特征值 $1$ 的左特征向量来完成。\n2.  **模拟**：为了可复现性，使用一个固定的种子 ($2025$) 初始化一个随机数生成器。初始状态 $X_0$ 从平稳分布 $\\pi$ 中抽样。通过迭代地从由 $P$ 的第 $X_t$ 行给出的概率分布中抽样 $X_{t+1}$ 来生成轨迹 $(X_t)_{t=0}^{n}$。\n3.  **计数**：通过遍历模拟的轨迹来填充 $k \\times k$ 的经验转移计数矩阵 $C=(C_{ij})$。\n4.  **检验**：\n    *   无序对的数量为 $m = k(k-1)/2$。\n    *   经邦费罗尼校正的显著性水平为 $\\alpha_{\\text{pair}} = \\alpha/m$。\n    *   计算临界 z 值，$z_{crit} = z_{1 - \\alpha_{\\text{pair}}/2}$。\n    *   对于每个无序对 $\\{i,j\\}$：\n        *   计算经验流 $\\widehat{J}_{ij} = (C_{ij} - C_{ji}) / n$。\n        *   计算标准误 $SE(\\widehat{J}_{ij}) = \\sqrt{C_{ij} + C_{ji}} / n$。\n        *   检查检验条件 $|\\widehat{J}_{ij}| \\le z_{crit} \\cdot SE(\\widehat{J}_{ij})$ 是否成立。\n    *   如果任一对该条件不成立，则拒绝该情况下的细致平衡假设。如果所有对都满足该条件，则接受该假设。\n\n对于给定的参数（$k=3$, $\\alpha=0.05$），我们有 $m=3$ 对。每对的显著性水平是 $\\alpha_{\\text{pair}} = 0.05/3$。临界值是 $z_{1 - (0.05/3)/2} = z_{1 - 0.05/6} \\approx z_{0.991667}$。情况 A 和 C 被构造成可逆的，因此预期它们会通过检验。情况 B 被构造成不可逆的，对于给定的长轨迹长度，预期该检验将有足够的统计功效来检测到这一点并拒绝该假设。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\n\ndef find_stationary_distribution(p_matrix):\n    \"\"\"\n    Computes the stationary distribution of a Markov chain.\n    \"\"\"\n    # We need to find the left eigenvector of P for eigenvalue 1.\n    # This is the same as the right eigenvector of P.T for eigenvalue 1.\n    eigenvalues, eigenvectors = np.linalg.eig(p_matrix.T)\n    \n    # Find the eigenvector corresponding to the eigenvalue closest to 1\n    # Using np.isclose is robust to floating point inaccuracies\n    idx = np.isclose(eigenvalues, 1).argmax()\n    stationary_vector = np.real(eigenvectors[:, idx])\n    \n    # Normalize the eigenvector to make it a probability distribution\n    stationary_distribution = stationary_vector / np.sum(stationary_vector)\n    return stationary_distribution\n\ndef run_test_case(P, n, k, alpha, seed, pi=None):\n    \"\"\"\n    Runs the detailed balance test for a single case.\n\n    Args:\n        P (np.ndarray): The k x k transition matrix.\n        n (int): The number of transitions to simulate.\n        k (int): The number of states.\n        alpha (float): The global significance level.\n        seed (int): The random seed for reproducibility.\n        pi (np.ndarray, optional): The stationary distribution. If None, it's computed.\n\n    Returns:\n        bool: True if detailed balance is accepted, False otherwise.\n    \"\"\"\n    if pi is None:\n        pi = find_stationary_distribution(P)\n\n    # 1. Simulate the trajectory\n    rng = np.random.default_rng(seed)\n    \n    # Initial state sampled from stationary distribution\n    states = np.arange(k)\n    current_state = rng.choice(states, p=pi)\n    \n    # Trajectory simulation\n    trajectory = np.zeros(n + 1, dtype=int)\n    trajectory[0] = current_state\n    for t in range(n):\n        next_state_probs = P[trajectory[t], :]\n        trajectory[t+1] = rng.choice(states, p=next_state_probs)\n\n    # 2. Compute empirical transition counts\n    C = np.zeros((k, k), dtype=int)\n    for t in range(n):\n        i, j = trajectory[t], trajectory[t+1]\n        C[i, j] += 1\n        \n    # 3. Perform the statistical test\n    num_pairs = k * (k - 1) // 2\n    alpha_pair = alpha / num_pairs\n    z_crit = norm.ppf(1 - alpha_pair / 2)\n    \n    overall_acceptance = True\n    \n    for i in range(k):\n        for j in range(i + 1, k):\n            # For each unordered pair {i, j}\n            C_ij = C[i, j]\n            C_ji = C[j, i]\n            \n            # Estimator for flux\n            J_ij_hat = (C_ij - C_ji) / n\n            \n            # Standard error of the estimator\n            # Avoid division by zero if n=0; handle cases with zero counts\n            if C_ij + C_ji == 0:\n                se_J_ij_hat = 0.0\n            else:\n                se_J_ij_hat = np.sqrt(C_ij + C_ji) / n\n\n            # Margin of error for the confidence interval\n            margin_of_error = z_crit * se_J_ij_hat\n            \n            # Check if 0 is in the confidence interval\n            # This is equivalent to |J_ij_hat| = margin_of_error\n            if abs(J_ij_hat) > margin_of_error:\n                overall_acceptance = False\n                break\n        if not overall_acceptance:\n            break\n            \n    return overall_acceptance\n\ndef solve():\n    \"\"\"\n    Main function to define and run all test cases.\n    \"\"\"\n    k = 3\n    alpha = 0.05\n    seed = 2025\n\n    # Case A: Reversible, dense\n    pi_A = np.array([0.2, 0.5, 0.3])\n    P_A = np.array([\n        [0.65, 0.20, 0.15],\n        [0.08, 0.82, 0.10],\n        [0.10, 1/6, 11/15]\n    ])\n    n_A = 300000\n\n    # Case B: Non-reversible, biased\n    P_B = np.array([\n        [0.55, 0.30, 0.15],\n        [0.08, 0.82, 0.10],\n        [0.10, 1/6, 11/15]\n    ])\n    n_B = 300000\n\n    # Case C: Reversible, sparse\n    pi_C = np.array([0.3, 0.4, 0.3])\n    P_C = np.array([\n        [0.8, 0.2, 0.0],\n        [0.15, 0.65, 0.2],\n        [0.0, 4/15, 11/15]\n    ])\n    n_C = 150000\n    \n    test_cases = [\n        (P_A, n_A, pi_A),\n        (P_B, n_B, None),\n        (P_C, n_C, pi_C)\n    ]\n\n    results = []\n    for P, n, pi in test_cases:\n        result = run_test_case(P, n, k, alpha, seed, pi)\n        results.append(result)\n\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}