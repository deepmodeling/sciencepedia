{
    "hands_on_practices": [
        {
            "introduction": "A numerical scheme is an approximation of a differential equation, and this approximation inevitably introduces errors. This exercise uses Modified Equation Analysis, a powerful technique based on Taylor series expansions, to reveal the true nature of the first-order upwind scheme. By performing this analysis, you will derive the leading-order error term and discover that it takes the form of a physical diffusion term, a phenomenon known as \"artificial diffusion\" or \"numerical viscosity,\" which is key to understanding the scheme's stability and accuracy characteristics .",
            "id": "3997009",
            "problem": "Consider the steady, constant-velocity, one-dimensional (1D) convection of a smooth passive scalar field $\\phi(x)$ governed by the partial differential equation (PDE) $u \\,\\frac{d \\phi}{d x} = 0$, where $u$ is a spatially uniform velocity. Let the spatial domain be discretized by a uniform grid with spacing $h$, and consider the discrete convective term at a generic grid point $x_i$ constructed using the first-order upwind differencing scheme (UDS): for $u>0$ use $(\\phi_i - \\phi_{i-1})/h$ and for $u0$ use $(\\phi_{i+1} - \\phi_i)/h$. Using only the governing conservation law and Taylor-series expansions valid for smooth $\\phi(x)$, perform a modified equation analysis (MEA) to identify the leading-order continuous PDE that the UDS-discretized convective operator approximates. From that leading-order modified PDE, extract the coefficient multiplying $\\frac{d^2 \\phi}{d x^2}$ and interpret it as an equivalent artificial diffusion coefficient $\\alpha_{\\text{num}}$. Express your final result for $\\alpha_{\\text{num}}$ as a closed-form analytic expression in terms of $u$ and $h$. Assume $u$ is measured in $\\mathrm{m}/\\mathrm{s}$ and $h$ in $\\mathrm{m}$ so that $\\alpha_{\\text{num}}$ is in $\\mathrm{m}^2/\\mathrm{s}$. Your boxed final answer must contain only the expression and no units.",
            "solution": "...",
            "answer": "$$\n\\boxed{\\frac{|u|h}{2}}\n$$"
        },
        {
            "introduction": "After analyzing a scheme's properties theoretically, it is crucial to verify them through computation. This practice introduces the Method of Manufactured Solutions (MMS), a cornerstone of rigorous code verification in computational science. You will implement a finite difference solver for a convection-diffusion problem and use a manufactured solution to numerically confirm that the upwind scheme exhibits first-order spatial convergence, a direct consequence of the artificial diffusion derived in the previous exercise .",
            "id": "3996964",
            "problem": "Consider the steady one-dimensional (1D) convection-diffusion balance for a passive scalar (temperature) field $T(x)$ over the domain $x \\in [0,1]$ with constant properties, expressed by the conservation statement\n$$\n- \\alpha \\frac{d^2 T}{dx^2} + \\beta \\frac{d T}{dx} = S(x),\n$$\nwhere $\\alpha > 0$ is the diffusivity, $\\beta$ is a constant convection coefficient, and $S(x)$ is a volumetric source term. The Method of Manufactured Solutions (MMS) prescribes choosing a smooth, nontrivial exact solution $T_{\\text{exact}}(x)$ and deducing $S(x)$ so that $T_{\\text{exact}}(x)$ satisfies the differential equation. You will use MMS to verify the observed spatial convergence order of the Upwind Differencing Scheme (UDS) for the convection term in a finite difference discretization, combined with a second-order central difference for diffusion, under Dirichlet boundary conditions consistent with $T_{\\text{exact}}(x)$. All quantities are nondimensional. No physical units are required.\n\nStarting from the conservation law above, perform the following:\n- Choose the manufactured solution $T_{\\text{exact}}(x) = \\sin(2\\pi x)$ and compute the source term $S(x)$ implied by the governing equation for given constants $\\alpha$ and $\\beta$. Impose Dirichlet boundary conditions $T(0) = T_{\\text{exact}}(0)$ and $T(1) = T_{\\text{exact}}(1)$.\n- Discretize the domain $[0,1]$ with a uniform grid of $N$ interior nodes (grid spacing $h = 1/(N+1)$). At each interior node, approximate the diffusion term with a second-order central difference stencil and the convection term with the Upwind Differencing Scheme (UDS) that uses the one-sided finite difference aligned with the sign of $\\beta$. Assemble and solve the resulting linear system for the discrete approximation $T_h$.\n- For each grid, compute the nodal error $e_i = T_h(x_i) - T_{\\text{exact}}(x_i)$ at interior nodes $x_i = i h$ for $i = 1,2,\\dots,N$, and the discrete $L_2$ error norm defined as $E(h) = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N e_i^2}$.\n- Estimate the observed spatial convergence order between two successive refinements with spacings $h$ and $\\tilde{h}$ as\n$$\np = \\frac{\\ln\\left(E(h)/E(\\tilde{h})\\right)}{\\ln\\left(h/\\tilde{h}\\right)}.\n$$\n\nYour program must evaluate the observed order $p$ for the following test suite, using the last two grid refinements from $N \\in \\{20,40,80,160,320\\}$ to compute $p$ for each case:\n- Case $1$ (happy path): $\\alpha = 10^{-2}$, $\\beta = 1$.\n- Case $2$ (flow reversal): $\\alpha = 10^{-2}$, $\\beta = -1$.\n- Case $3$ (strongly convection-dominated): $\\alpha = 10^{-6}$, $\\beta = 1$.\n- Case $4$ (diffusion-only edge case): $\\alpha = 1$, $\\beta = 0$.\n\nThe expected behavior is that cases with nonzero $\\beta$ exhibit approximately first-order spatial convergence due to UDS, while the diffusion-only case exhibits approximately second-order convergence due to the central difference scheme.\n\nFinal output specification:\n- For each case, output the single float $p$ rounded to three decimals.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of cases $1$ through $4$, for example, $[p_1,p_2,p_3,p_4]$.\n- The angle unit is not applicable. No physical units are required and no percentages are to be used anywhere; all values must be represented as decimals.\n\nEnsure scientific realism and self-consistency. Implementations must directly reflect the described principles without using shortcut formulas not justified by the stated conservation law and finite difference definitions.",
            "solution": "The problem is valid as it presents a standard, well-posed verification exercise for a numerical method using the established Method of Manufactured Solutions (MMS). All components—the governing physical equation, the numerical schemes, and the analysis procedure—are scientifically sound and clearly defined.\n\nThe solution process involves four main steps: derivation of the source term, discretization of the governing equation, assembly and solution of the linear system, and computation of the convergence order.\n\n**1. Source Term Derivation**\nThe governing equation is the one-dimensional steady convection-diffusion equation:\n$$\n- \\alpha \\frac{d^2 T}{dx^2} + \\beta \\frac{d T}{dx} = S(x)\n$$\nThe Method of Manufactured Solutions (MMS) requires us to choose an exact solution, $T_{\\text{exact}}(x)$, and substitute it into the governing equation to derive the corresponding source term $S(x)$ that makes the equation true. The chosen manufactured solution is:\n$$\nT_{\\text{exact}}(x) = \\sin(2\\pi x)\n$$\nWe compute its first and second derivatives with respect to $x$:\n$$\n\\frac{dT_{\\text{exact}}}{dx} = 2\\pi \\cos(2\\pi x)\n$$\n$$\n\\frac{d^2T_{\\text{exact}}}{dx^2} = -4\\pi^2 \\sin(2\\pi x)\n$$\nSubstituting these derivatives into the governing equation gives the source term $S(x)$:\n$$\nS(x) = - \\alpha \\left(-4\\pi^2 \\sin(2\\pi x)\\right) + \\beta \\left(2\\pi \\cos(2\\pi x)\\right)\n$$\n$$\nS(x) = 4\\alpha\\pi^2 \\sin(2\\pi x) + 2\\beta\\pi \\cos(2\\pi x)\n$$\nThe Dirichlet boundary conditions are evaluated from the manufactured solution at the domain boundaries $x=0$ and $x=1$:\n$$\nT(0) = T_{\\text{exact}}(0) = \\sin(0) = 0\n$$\n$$\nT(1) = T_{\\text{exact}}(1) = \\sin(2\\pi) = 0\n$$\n\n**2. Finite Difference Discretization**\nThe domain $x \\in [0,1]$ is discretized using a uniform grid with $N$ interior nodes. The grid points are indexed from $i=0$ to $i=N+1$, such that $x_i = i h$, where the grid spacing is $h = 1/(N+1)$. The numerical solution $T_h$ seeks to approximate $T_{\\text{exact}}$ at the interior nodes $x_i$ for $i=1, 2, \\dots, N$. The unknown values are $T_i \\equiv T_h(x_i)$.\n\nThe discrete form of the governing equation at an interior node $x_i$ is:\n$$\n- \\alpha \\left(\\frac{d^2 T}{dx^2}\\right)_i + \\beta \\left(\\frac{d T}{dx}\\right)_i = S(x_i)\n$$\nThe diffusion term is approximated using a second-order central difference stencil:\n$$\n\\left(\\frac{d^2 T}{dx^2}\\right)_i \\approx \\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\n$$\nThe convection term is approximated using the first-order Upwind Differencing Scheme (UDS), where the stencil depends on the sign of the convection coefficient $\\beta$.\n- If $\\beta > 0$ (flow is in the positive $x$-direction), a backward difference is used:\n$$\n\\left(\\frac{d T}{dx}\\right)_i \\approx \\frac{T_i - T_{i-1}}{h}\n$$\n- If $\\beta  0$ (flow is in the negative $x$-direction), a forward difference is used:\n$$\n\\left(\\frac{d T}{dx}\\right)_i \\approx \\frac{T_{i+1} - T_i}{h}\n$$\n- If $\\beta = 0$, the convection term is zero.\n\nSubstituting these approximations into the governing equation and rearranging yields a linear algebraic equation for each node $i$.\n\n**Case 1: $\\beta > 0$**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) + \\beta \\left(\\frac{T_i - T_{i-1}}{h}\\right) = S_i\n$$\nMultiplying by $h^2$ and grouping terms by unknown $T_j$:\n$$\n(-\\alpha - \\beta h)T_{i-1} + (2\\alpha + \\beta h)T_i + (-\\alpha)T_{i+1} = h^2 S_i\n$$\n\n**Case 2: $\\beta  0$**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) + \\beta \\left(\\frac{T_{i+1} - T_i}{h}\\right) = S_i\n$$\nMultiplying by $h^2$ and grouping terms:\n$$\n(-\\alpha)T_{i-1} + (2\\alpha - \\beta h)T_i + (-\\alpha + \\beta h)T_{i+1} = h^2 S_i\n$$\n\n**Case 3: $\\beta = 0$ (Pure Diffusion)**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) = S_i\n$$\n$$\n(-\\alpha)T_{i-1} + (2\\alpha)T_i + (-\\alpha)T_{i+1} = h^2 S_i\n$$\n\n**3. Linear System Assembly and Solution**\nThe set of $N$ linear equations for the interior nodes $i=1, \\dots, N$ forms a matrix system $A\\mathbf{T}_h = \\mathbf{d}$, where $\\mathbf{T}_h = [T_1, T_2, \\dots, T_N]^T$ is the vector of unknown nodal temperatures. The matrix $A$ is an $N \\times N$ tridiagonal matrix, and $\\mathbf{d}$ is the right-hand side vector.\n\nThe elements of $A$ are the coefficients derived above. For a general row $i$ (representing node $x_i$), the main diagonal entry is $A_{i,i}$, the sub-diagonal is $A_{i,i-1}$, and the super-diagonal is $A_{i,i+1}$. The vector $\\mathbf{d}$ has entries $d_i = h^2 S(x_i)$.\n\nThe boundary conditions $T_0=0$ and $T_{N+1}=0$ affect the first ($i=1$) and last ($i=N$) equations. The terms $T_0$ and $T_{N+1}$ are known and are moved to the right-hand side. Since they are both zero, the right-hand side vector $\\mathbf{d}$ is unaffected.\n\nThe resulting tridiagonal system is solved for $\\mathbf{T}_h$ for each grid configuration.\n\n**4. Error Analysis and Convergence Order**\nAfter obtaining the numerical solution $\\mathbf{T}_h$, the error is computed with respect to the known exact solution. The nodal error at each interior node is $e_i = T_i - T_{\\text{exact}}(x_i)$. The overall error for a given grid spacing $h$ is measured using the discrete $L_2$ norm:\n$$\nE(h) = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N e_i^2}\n$$\nThe observed order of spatial convergence, $p$, is estimated by performing simulations on two grids with different spacings, $h$ and $\\tilde{h}$ (where $\\tilde{h}  h$). The formula is:\n$$\np = \\frac{\\ln\\left(E(h)/E(\\tilde{h})\\right)}{\\ln\\left(h/\\tilde{h}\\right)}\n$$\nFor this problem, $p$ is calculated for each $(\\alpha, \\beta)$ case using the results from the two finest grids, corresponding to $N=160$ ($h=1/161$) and $N=320$ ($\\tilde{h}=1/321$). The expected order is $p \\approx 1$ for cases with convection ($\\beta \\neq 0$) due to the first-order UDS, and $p \\approx 2$ for the pure diffusion case ($\\beta = 0$) due to the second-order central difference scheme for the diffusion term.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_case(alpha, beta, N_list):\n    \"\"\"\n    Solves a single case for a given alpha, beta, and list of grid sizes N.\n    \n    This function implements the Method of Manufactured Solutions (MMS) to\n    verify the spatial convergence order of a finite difference scheme for the\n    1D steady convection-diffusion equation. It calculates the L2 error for a\n    series of refined grids and then computes the observed order of convergence\n    from the last two refinements.\n\n    Args:\n        alpha (float): The diffusivity coefficient.\n        beta (float): The convection coefficient.\n        N_list (list of int): A list of the number of interior grid nodes for each refinement.\n\n    Returns:\n        float: The observed spatial order of convergence, p.\n    \"\"\"\n    errors = []\n    h_values = []\n\n    for N in N_list:\n        # 1. Setup grid\n        h = 1.0 / (N + 1)\n        # We only need interior nodes for setting up and solving the system\n        x_interior = np.linspace(h, 1.0 - h, N)\n\n        # 2. Compute manufactured solution and source term at interior nodes\n        T_exact_interior = np.sin(2 * np.pi * x_interior)\n        S_interior = (4 * alpha * np.pi**2 * np.sin(2 * np.pi * x_interior) +\n                      2 * beta * np.pi * np.cos(2 * np.pi * x_interior))\n        \n        # 3. Assemble the linear system A * T_h = d\n        A = np.zeros((N, N))\n        d = h**2 * S_interior\n        # The boundary conditions T(0)=0 and T(1)=0 are homogeneous, so they\n        # do not contribute to the right-hand side vector d.\n\n        # Define tridiagonal coefficients based on the sign of beta (Upwind Scheme)\n        if beta  0:\n            # Backward difference for convection\n            sub_diag_val = -alpha - beta * h\n            main_diag_val = 2 * alpha + beta * h\n            super_diag_val = -alpha\n        elif beta  0:\n            # Forward difference for convection\n            sub_diag_val = -alpha\n            main_diag_val = 2 * alpha - beta * h\n            super_diag_val = -alpha + beta * h\n        else:  # beta == 0, pure diffusion\n            sub_diag_val = -alpha\n            main_diag_val = 2 * alpha\n            super_diag_val = -alpha\n\n        # Populate the tridiagonal matrix A\n        np.fill_diagonal(A, main_diag_val)\n        if N  1:\n            np.fill_diagonal(A[1:], sub_diag_val)\n            np.fill_diagonal(A[:, 1:], super_diag_val)\n\n        # 4. Solve the linear system for the numerical solution T_h\n        T_h = np.linalg.solve(A, d)\n\n        # 5. Compute the discrete L2 error norm\n        nodal_errors = T_h - T_exact_interior\n        l2_error = np.sqrt(np.sum(nodal_errors**2) / N)\n\n        errors.append(l2_error)\n        h_values.append(h)\n\n    # 6. Compute convergence order p from the last two grid refinements\n    # E(h) - errors[-2], E(tilde_h) - errors[-1]\n    # h    - h_values[-2], tilde_h   - h_values[-1]\n    p = np.log(errors[-2] / errors[-1]) / np.log(h_values[-2] / h_values[-1])\n    \n    return p\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'alpha': 1e-2, 'beta': 1.0},    # Case 1\n        {'alpha': 1e-2, 'beta': -1.0},   # Case 2\n        {'alpha': 1e-6, 'beta': 1.0},    # Case 3\n        {'alpha': 1.0,   'beta': 0.0},    # Case 4\n    ]\n    \n    # Grid refinement sequence\n    N_list = [20, 40, 80, 160, 320]\n    \n    results = []\n    for case in test_cases:\n        alpha = case['alpha']\n        beta = case['beta']\n        \n        # Calculate the observed convergence order for the current case\n        p = solve_case(alpha, beta, N_list)\n        \n        # Round the result to three decimal places\n        results.append(round(p, 3))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Moving beyond simple grids, this practice extends the upwind concept to the more general and powerful finite volume method (FVM) on unstructured meshes, a framework well-suited for complex geometries found in real-world applications like porous media flow. You will derive an explicit upwind FVM scheme from the integral form of a conservation law and, through a monotonicity analysis, deduce the local Courant-Friedrichs-Lewy (CFL) stability condition. This exercise provides fundamental insight into how multiscale heterogeneities in material properties and mesh geometry govern the maximum stable time step for an explicit simulation .",
            "id": "3828203",
            "problem": "Consider the linear advection of a passive scalar in a heterogeneous porous medium, governed by the conservation law $$\\frac{\\partial}{\\partial t}\\left(\\phi(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) + \\nabla \\cdot \\left(\\boldsymbol{v}(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) = 0,$$ where $u(\\boldsymbol{x},t)$ denotes the scalar quantity, $\\phi(\\boldsymbol{x})$ is the porosity, and $\\boldsymbol{v}(\\boldsymbol{x})$ is the velocity field. Assume an unstructured mesh partitioning the domain into polygonal control volumes $\\{K_i\\}$ with areas $\\{|K_i|\\}$, and faces $\\{f\\}$ with lengths $\\{|f|\\}$ and outward unit normals $\\{\\boldsymbol{n}_{i,f}\\}$ relative to each cell $K_i$. The velocity field is piecewise constant at the face scale such that the face-normal projection $a_{i,f} = \\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}$ is constant for each face $f$ and each adjoining cell $K_i$.\n\nYou are to develop the explicit upwind finite volume method for this setting and deduce the local Courant–Friedrichs–Lewy (CFL) restriction per control volume caused by multiscale heterogeneity in $\\phi$, $|K_i|$, $|f|$, and $a_{i,f}$. The derivation must start from the integral form of conservation over a control volume and basic definitions of upwind numerical flux, without invoking any pre-stated CFL formulas. Carefully justify how the sign of $a_{i,f}$ selects the upwind state across internal and boundary faces, and how this leads to a monotonicity condition on the explicit scheme that imposes a local time-step bound. Explicitly discuss how heterogeneity in porosity and geometric measures tightens or relaxes this bound locally.\n\nFor computational assessment, implement the method that, for a given mesh and face data, computes the local maximum stable time step $\\Delta t_i^{\\max}$ for each cell $K_i$ under the explicit upwind scheme, and then returns the global bound $$\\Delta t_{\\text{global}}^{\\max} = \\min_i \\Delta t_i^{\\max}.$$ If a cell has no outflow, i.e., all $a_{i,f} \\le 0$ so that the sum of outgoing face contributions is zero, define $\\Delta t_i^{\\max}$ to be a large sentinel value $10^{12}$ seconds to represent an unconstrained local time step. All time outputs must be expressed in seconds.\n\nInput data are specified implicitly by the following test suite of meshes. Each mesh is given by the list of cells, where each cell has a porosity $\\phi_i$, area $|K_i|$ in meters squared, and a list of faces. Each face is specified by its length $|f|$ in meters, the face-normal projection $a_{i,f}$ in meters per second as seen from the current cell (positive indicates outflow from the cell), and the index of the neighboring cell if the face is internal or `None` if it is a boundary face. For internal faces, the face-normal projections for the two adjacent cells must have opposite signs and equal magnitude.\n\nTest Suite:\n- Case A (balanced heterogeneity):\n  - Cells: $i=0,1,2$\n  - Areas: $|K_0|=2.0$, $|K_1|=2.5$, $|K_2|=1.8$ (all in meters squared)\n  - Porosity: $\\phi_0=\\phi_1=\\phi_2=0.3$\n  - Faces for each cell:\n    - Cell $0$: $(|f|=1.0, a_{0,f}=+0.5, \\text{neighbor}=1)$, $(|f|=0.8, a_{0,f}=-0.1, \\text{neighbor}=2)$, $(|f|=1.2, a_{0,f}=+0.2, \\text{neighbor}=None)$\n    - Cell $1$: $(|f|=1.0, a_{1,f}=-0.5, \\text{neighbor}=0)$, $(|f|=0.9, a_{1,f}=+0.3, \\text{neighbor}=2)$, $(|f|=1.1, a_{1,f}=+0.1, \\text{neighbor}=None)$\n    - Cell $2$: $(|f|=0.8, a_{2,f}=+0.1, \\text{neighbor}=0)$, $(|f|=0.9, a_{2,f}=-0.3, \\text{neighbor}=1)$, $(|f|=1.0, a_{2,f}=+0.05, \\text{neighbor}=None)$\n- Case B (small cell with strong outflow):\n  - Cells: $i=0,1$\n  - Areas: $|K_0|=0.2$, $|K_1|=5.0$\n  - Porosity: $\\phi_0=\\phi_1=0.25$\n  - Faces:\n    - Cell $0$: $(|f|=0.5, a_{0,f}=+3.0, \\text{neighbor}=1)$, $(|f|=0.4, a_{0,f}=+1.0, \\text{neighbor}=None)$, $(|f|=0.3, a_{0,f}=+0.5, \\text{neighbor}=None)$\n    - Cell $1$: $(|f|=0.5, a_{1,f}=-3.0, \\text{neighbor}=0)$, $(|f|=1.2, a_{1,f}=+0.2, \\text{neighbor}=None)$, $(|f|=1.0, a_{1,f}=-0.1, \\text{neighbor}=None)$\n- Case C (heterogeneous porosity dominating the local bound):\n  - Cells: $i=0,1,2$\n  - Areas: $|K_0|=|K_1|=|K_2|=1.0$\n  - Porosity: $\\phi_0=0.1$, $\\phi_1=0.7$, $\\phi_2=0.3$\n  - Faces:\n    - Cell $0$: $(|f|=0.6, a_{0,f}=+0.8, \\text{neighbor}=1)$, $(|f|=0.5, a_{0,f}=+0.4, \\text{neighbor}=None)$, $(|f|=0.5, a_{0,f}=-0.2, \\text{neighbor}=None)$\n    - Cell $1$: $(|f|=0.6, a_{1,f}=-0.8, \\text{neighbor}=0)$, $(|f|=0.6, a_{1,f}=+0.8, \\text{neighbor}=2)$, $(|f|=0.5, a_{1,f}=+0.1, \\text{neighbor}=None)$\n    - Cell $2$: $(|f|=0.6, a_{2,f}=-0.8, \\text{neighbor}=1)$, $(|f|=0.7, a_{2,f}=+0.2, \\text{neighbor}=None)$\n- Case D (no outflow, unconstrained local time step):\n  - Cells: $i=0$\n  - Areas: $|K_0|=3.0$\n  - Porosity: $\\phi_0=0.2$\n  - Faces:\n    - Cell $0$: $(|f|=1.0, a_{0,f}=-0.5, \\text{neighbor}=None)$, $(|f|=2.0, a_{0,f}=-0.1, \\text{neighbor}=None)$\n\nTasks:\n1. Derive the explicit upwind finite volume update for cell averages $u_i^n$ over a time step of size $\\Delta t$ by integrating the conservation law on $K_i$ and replacing face fluxes with upwind values.\n2. From the update, deduce the monotonicity condition ensuring nonnegative coefficients on $u_i^n$ and thereby formulate the local CFL bound $\\Delta t_i^{\\max}$ in terms of $\\phi_i$, $|K_i|$, $|f|$, and $a_{i,f}$.\n3. Implement a program that, for each test case, computes $\\Delta t_{\\text{global}}^{\\max}$ in seconds by taking the minimum of $\\Delta t_i^{\\max}$ over all cells. If a cell has no outflow faces, use $10^{12}$ seconds for its local bound.\n4. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, with each float rounded to six decimal places, for the four cases in the order A, B, C, D.\n\nExpress all time quantities in seconds. Angles are not involved in this problem.",
            "solution": "The problem requires the derivation of the local Courant–Friedrichs–Lewy (CFL) time-step restriction for an explicit upwind finite volume scheme applied to a linear advection equation in a heterogeneous porous medium. The derivation must be followed by a computational implementation to find the global maximum stable time step for several test cases.\n\n### Step 1: Derivation of the Explicit Upwind Finite Volume Scheme\n\nThe governing conservation law is given by:\n$$\n\\frac{\\partial}{\\partial t}\\left(\\phi(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) + \\nabla \\cdot \\left(\\boldsymbol{v}(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) = 0\n$$\nwhere $u$ is the scalar concentration, $\\phi$ is the porosity, and $\\boldsymbol{v}$ is the velocity field.\n\nWe begin by integrating this partial differential equation over an arbitrary control volume $K_i$ and over the time interval $[t^n, t^{n+1}]$, where $\\Delta t = t^{n+1} - t^n$.\n$$\n\\int_{t^n}^{t^{n+1}} \\int_{K_i} \\frac{\\partial}{\\partial t}\\left(\\phi u\\right) d\\boldsymbol{x} dt + \\int_{t^n}^{t^{n+1}} \\int_{K_i} \\nabla \\cdot (\\boldsymbol{v} u) d\\boldsymbol{x} dt = 0\n$$\n\nApplying the divergence theorem to the second term transforms the volume integral into a surface integral over the boundary $\\partial K_i$:\n$$\n\\int_{K_i} \\left[ (\\phi u)^{n+1} - (\\phi u)^n \\right] d\\boldsymbol{x} + \\int_{t^n}^{t^{n+1}} \\int_{\\partial K_i} (\\boldsymbol{v} u) \\cdot \\boldsymbol{n}_{i,f} dS dt = 0\n$$\nHere, $\\boldsymbol{n}_{i,f}$ is the outward unit normal vector to the boundary of $K_i$.\n\nWe introduce the cell-average value of $u$ in cell $K_i$ at time $t$ as $u_i(t) = \\frac{1}{|K_i|} \\int_{K_i} u(\\boldsymbol{x}, t) d\\boldsymbol{x}$. We assume the porosity $\\phi$ is piecewise constant, with value $\\phi_i$ in cell $K_i$. The first term is approximated as:\n$$\n\\int_{K_i} \\left[ (\\phi u)^{n+1} - (\\phi u)^n \\right] d\\boldsymbol{x} \\approx \\phi_i |K_i| \\left(u_i^{n+1} - u_i^n\\right)\n$$\nwhere $u_i^n = u_i(t^n)$.\n\nFor the flux term, we use a first-order explicit time integration (Forward Euler), evaluating the flux at time $t^n$. The boundary $\\partial K_i$ consists of a set of faces $\\mathcal{F}_i$. The flux integral becomes:\n$$\n\\int_{t^n}^{t^{n+1}} \\int_{\\partial K_i} (\\boldsymbol{v} u) \\cdot \\boldsymbol{n}_{i,f} dS dt \\approx \\Delta t \\sum_{f \\in \\mathcal{F}_i} \\int_f (\\boldsymbol{v} u^n) \\cdot \\boldsymbol{n}_{i,f} dS\n$$\nThe problem states that the velocity is piecewise constant $\\boldsymbol{v}_f$ on each face $f$. The integral over a face $f$ is then approximated as:\n$$\n\\int_f (\\boldsymbol{v} u^n) \\cdot \\boldsymbol{n}_{i,f} dS \\approx (\\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}) |f| u_f^n = a_{i,f} |f| u_f^n\n$$\nwhere $a_{i,f} = \\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}$ is the given face-normal velocity projection, $|f|$ is the length of the face, and $u_f^n$ is an approximation of the scalar value $u$ on the face at time $t^n$.\n\nCombining these approximations yields the semi-discrete finite volume scheme:\n$$\n\\phi_i |K_i| \\left(u_i^{n+1} - u_i^n\\right) + \\Delta t \\sum_{f \\in \\mathcal{F}_i} |f| a_{i,f} u_f^n = 0\n$$\nRearranging for $u_i^{n+1}$ gives the update formula:\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| a_{i,f} u_f^n\n$$\nThe upwind scheme defines $u_f^n$ based on the direction of flow. The sign of $a_{i,f}$ indicates flow direction relative to cell $K_i$:\n- If $a_{i,f} > 0$, flow is *outgoing* from $K_i$. The upwind choice for $u_f^n$ is the value from within cell $K_i$, i.e., $u_f^n = u_i^n$.\n- If $a_{i,f}  0$, flow is *incoming* to $K_i$. The upwind choice for $u_f^n$ is the value from the adjacent cell $K_j$, i.e., $u_f^n = u_j^n$.\n- If $a_{i,f} = 0$, there is no advective flux across the face.\n\nThe numerical flux term for a single face $f$, from the perspective of cell $K_i$, can thus be written as:\n$$\n|f| a_{i,f} u_f^n = |f| \\left( \\max(a_{i,f}, 0) u_i^n + \\min(a_{i,f}, 0) u_{j(f)}^n \\right)\n$$\nwhere $j(f)$ is the index of the cell neighboring $K_i$ across face $f$. For a boundary face, $u_{j(f)}^n$ would be a given boundary value.\n\nSubstituting this into the update formula:\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\left( \\max(a_{i,f}, 0) u_i^n + \\min(a_{i,f}, 0) u_{j(f)}^n \\right)\n$$\nWe can group the terms involving $u_i^n$ and neighbor values $u_j^n$:\n$$\nu_i^{n+1} = u_i^n \\left(1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\right) - \\sum_{f \\in \\mathcal{F}_i, \\text{inflow}} \\frac{\\Delta t |f| \\min(a_{i,f}, 0)}{\\phi_i |K_i|} u_{j(f)}^n\n$$\n\n### Step 2: Monotonicity Condition and Local CFL Bound\n\nFor the numerical scheme to be stable in the sense that it does not create new extrema (monotonicity), the update for $u_i^{n+1}$ must be a convex combination of the values at time $t^n$. This requires all coefficients on the right-hand side to be non-negative.\n\n1.  **Coefficient of $u_j^n$ (neighbor cells):** The coefficient for a neighboring cell $u_{j(f)}^n$ is $- \\frac{\\Delta t |f| \\min(a_{i,f}, 0)}{\\phi_i |K_i|}$. For these terms, the flow is incoming, so $\\min(a_{i,f}, 0) = a_{i,f}  0$. Since $\\Delta t$, $|f|$, $\\phi_i$, and $|K_i|$ are all positive, this coefficient is always non-negative. This condition is automatically satisfied by the upwind choice.\n\n2.  **Coefficient of $u_i^n$:** The coefficient of $u_i^n$ is $\\left(1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\right)$. For this to be non-negative, we must have:\n    $$\n    1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\ge 0\n    $$\n    This inequality imposes an upper bound on the time step $\\Delta t$:\n    $$\n    \\Delta t \\le \\frac{\\phi_i |K_i|}{\\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0)}\n    $$\nThe denominator represents the total rate of volumetric outflow from cell $K_i$. The numerator, $\\phi_i |K_i|$, represents the \"storage capacity\" of the cell for the conserved quantity.\n\nThe local maximum stable time step for cell $K_i$ is therefore:\n$$\n\\Delta t_i^{\\max} = \\frac{\\phi_i |K_i|}{\\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0)}\n$$\nIf a cell has no outflow faces (i.e., $a_{i,f} \\le 0$ for all $f \\in \\mathcal{F}_i$), the denominator is zero, and the time step is locally unconstrained. As per the problem statement, we set $\\Delta t_i^{\\max} = 10^{12}$ s in this case.\n\nFor the entire simulation to be stable, the time step $\\Delta t$ must be less than or equal to the minimum of all local bounds:\n$$\n\\Delta t_{\\text{global}}^{\\max} = \\min_{i} \\Delta t_i^{\\max}\n$$\n\n### Step 3: Influence of Heterogeneity\n\nThe derived CFL condition clearly shows how heterogeneity in physical and geometric properties affects stability:\n- **Porosity $\\phi_i$:** A larger porosity $\\phi_i$ increases the cell's storage capacity, which *relaxes* the time-step constraint (allows for a larger $\\Delta t_i^{\\max}$).\n- **Cell Area $|K_i|$:** A larger cell area $|K_i|$ also increases storage capacity, *relaxing* the constraint.\n- **Face Length $|f|$ and Outflow Velocity $a_{i,f} > 0$:** The product $|f|a_{i,f}$ represents the volumetric flow rate out of the cell across face $f$. Larger face lengths or higher outflow velocities increase the total outflow rate $\\sum |f|\\max(a_{i,f}, 0)$, which *tightens* the time-step constraint (requires a smaller $\\Delta t_i^{\\max}$).\n\nThe most restrictive cell in the mesh (the one that determines $\\Delta t_{\\text{global}}^{\\max}$) will typically be a cell that is small (small $|K_i|$), has low porosity (small $\\phi_i$), and/or has large outflow fluxes (large $|f|$ or $a_{i,f}$).",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the global maximum stable time step for several test cases\n    of an explicit upwind finite volume scheme.\n    \"\"\"\n    test_cases = [\n        # Case A: Balanced heterogeneity\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 2.0, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": +0.5, \"neighbor\": 1},\n                    {\"length\": 0.8, \"normal_vel\": -0.1, \"neighbor\": 2},\n                    {\"length\": 1.2, \"normal_vel\": +0.2, \"neighbor\": None}\n                ]},\n                {\"id\": 1, \"area\": 2.5, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": -0.5, \"neighbor\": 0},\n                    {\"length\": 0.9, \"normal_vel\": +0.3, \"neighbor\": 2},\n                    {\"length\": 1.1, \"normal_vel\": +0.1, \"neighbor\": None}\n                ]},\n                {\"id\": 2, \"area\": 1.8, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 0.8, \"normal_vel\": +0.1, \"neighbor\": 0},\n                    {\"length\": 0.9, \"normal_vel\": -0.3, \"neighbor\": 1},\n                    {\"length\": 1.0, \"normal_vel\": +0.05, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case B: Small cell with strong outflow\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 0.2, \"porosity\": 0.25, \"faces\": [\n                    {\"length\": 0.5, \"normal_vel\": +3.0, \"neighbor\": 1},\n                    {\"length\": 0.4, \"normal_vel\": +1.0, \"neighbor\": None},\n                    {\"length\": 0.3, \"normal_vel\": +0.5, \"neighbor\": None}\n                ]},\n                 {\"id\": 1, \"area\": 5.0, \"porosity\": 0.25, \"faces\": [\n                    {\"length\": 0.5, \"normal_vel\": -3.0, \"neighbor\": 0},\n                    {\"length\": 1.2, \"normal_vel\": +0.2, \"neighbor\": None},\n                    {\"length\": 1.0, \"normal_vel\": -0.1, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case C: Heterogeneous porosity dominating\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 1.0, \"porosity\": 0.1, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": +0.8, \"neighbor\": 1},\n                    {\"length\": 0.5, \"normal_vel\": +0.4, \"neighbor\": None},\n                    {\"length\": 0.5, \"normal_vel\": -0.2, \"neighbor\": None}\n                ]},\n                {\"id\": 1, \"area\": 1.0, \"porosity\": 0.7, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": -0.8, \"neighbor\": 0},\n                    {\"length\": 0.6, \"normal_vel\": +0.8, \"neighbor\": 2},\n                    {\"length\": 0.5, \"normal_vel\": +0.1, \"neighbor\": None}\n                ]},\n                {\"id\": 2, \"area\": 1.0, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": -0.8, \"neighbor\": 1},\n                    {\"length\": 0.7, \"normal_vel\": +0.2, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case D: No outflow\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 3.0, \"porosity\": 0.2, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": -0.5, \"neighbor\": None},\n                    {\"length\": 2.0, \"normal_vel\": -0.1, \"neighbor\": None}\n                ]}\n            ]\n        }\n    ]\n\n    results = []\n    \n    for case_data in test_cases:\n        local_max_dts = []\n        for cell in case_data[\"cells\"]:\n            phi_i = cell[\"porosity\"]\n            area_i = cell[\"area\"]\n            \n            # Sum of |f| * max(a_if, 0) over all faces of the cell\n            sum_of_outflows = 0.0\n            for face in cell[\"faces\"]:\n                length_f = face[\"length\"]\n                a_if = face[\"normal_vel\"]\n                if a_if  0:\n                    sum_of_outflows += length_f * a_if\n            \n            # Calculate local max stable time step based on the derived formula\n            if sum_of_outflows  0:\n                dt_i_max = (phi_i * area_i) / sum_of_outflows\n            else:\n                # No outflow, so the local time step is unconstrained.\n                # Use the specified sentinel value.\n                dt_i_max = 1e12\n            \n            local_max_dts.append(dt_i_max)\n            \n        # The global time step is the minimum of all local time steps\n        global_max_dt = min(local_max_dts)\n        results.append(global_max_dt)\n        \n    # Format the final output as specified\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}