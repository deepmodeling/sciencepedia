{
    "hands_on_practices": [
        {
            "introduction": "迎风格式因其出色的稳定性而备受青睐，但这种稳定性并非没有代价。本练习将指导你通过修正方程分析（Modified Equation Analysis, MEA）来揭示迎风格式所引入的内在数值误差。通过推导等效的人工扩散系数，你将定量地理解该格式的主要缺点，并掌握一种评估数值方法精度的基本理论工具。",
            "id": "3997009",
            "problem": "考虑一个光滑被动标量场 $\\phi(x)$ 的稳态、恒定速度、一维 (1D) 对流，该过程由偏微分方程（PDE）$u \\,\\frac{d \\phi}{d x} = 0$ 控制，其中 $u$ 是一个空间均匀的速度。设空间域由间距为 $h$ 的均匀网格离散化，并考虑在通用网格点 $x_i$ 处使用一阶迎风差分格式（UDS）构造的离散对流项：当 $u0$ 时，使用 $(\\phi_i - \\phi_{i-1})/h$；当 $u0$ 时，使用 $(\\phi_{i+1} - \\phi_i)/h$。仅使用控制守恒律和对光滑 $\\phi(x)$ 有效的泰勒级数展开，进行修正方程分析（MEA），以确定 UDS 离散化对流算子所近似的主阶连续偏微分方程。从该主阶修正偏微分方程中，提取乘以 $\\frac{d^2 \\phi}{d x^2}$ 的系数，并将其解释为等效的人工扩散系数 $\\alpha_{\\text{num}}$。将 $\\alpha_{\\text{num}}$ 的最终结果表示为以 $u$ 和 $h$ 为变量的闭式解析表达式。假设 $u$ 的单位是 $\\mathrm{m}/\\mathrm{s}$，$h$ 的单位是 $\\mathrm{m}$，因此 $\\alpha_{\\text{num}}$ 的单位是 $\\mathrm{m}^2/\\mathrm{s}$。最终答案的方框内必须只包含表达式，不含单位。",
            "solution": "...",
            "answer": "$$\n\\boxed{\\frac{|u|h}{2}}\n$$"
        },
        {
            "introduction": "在理论上分析了格式的误差之后，下一步自然是验证计算机代码的实现是否与理论预测相符。本练习采用“制造解方法”（Method of Manufactured Solutions, MMS），这是一种严谨的代码验证技术。通过实现一个求解器并进行网格加密研究，你将亲手验证迎风格式的一阶收敛性，从而将理论分析与实际编程联系起来，这是计算科学研究中的一项核心技能。",
            "id": "3996964",
            "problem": "考虑在域 $x \\in [0,1]$ 上，具有恒定性质的被动标量（温度）场 $T(x)$ 的稳态一维 (1D) 对流扩散平衡，其守恒声明表示为\n$$\n- \\alpha \\frac{d^2 T}{dx^2} + \\beta \\frac{d T}{dx} = S(x),\n$$\n其中 $\\alpha  0$ 是扩散率，$\\beta$ 是一个恒定的对流系数，$S(x)$ 是一个体积源项。制造解方法 (MMS) 要求选择一个光滑、非平凡的精确解 $T_{\\text{exact}}(x)$，并由此推导出 $S(x)$，以使 $T_{\\text{exact}}(x)$ 满足该微分方程。您将使用 MMS 来验证在有限差分法离散化中，对流项采用迎风差分格式 (UDS) 并结合扩散项的二阶中心差分，在与 $T_{\\text{exact}}(x)$ 一致的 Dirichlet 边界条件下，所观测到的空间收敛阶。所有量均为无量纲。无需物理单位。\n\n从上述守恒定律出发，执行以下操作：\n- 选择制造解 $T_{\\text{exact}}(x) = \\sin(2\\pi x)$，并根据给定的常数 $\\alpha$ 和 $\\beta$ 计算控制方程所蕴含的源项 $S(x)$。施加 Dirichlet 边界条件 $T(0) = T_{\\text{exact}}(0)$ 和 $T(1) = T_{\\text{exact}}(1)$。\n- 使用包含 $N$ 个内部节点的均匀网格（网格间距 $h = 1/(N+1)$）对域 $[0,1]$ 进行离散化。在每个内部节点，使用二阶中心差分格式近似扩散项，并使用迎风差分格式 (UDS) 近似对流项，其中 UDS 采用与 $\\beta$ 符号一致的单边有限差分。组装并求解得到的线性系统，以获得离散近似解 $T_h$。\n- 对于每个网格，计算内部节点 $x_i = i h$（$i=1,2,\\dots,N$）处的节点误差 $e_i = T_h(x_i) - T_{\\text{exact}}(x_i)$，以及定义为 $E(h) = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N e_i^2}$ 的离散 $L_2$ 误差范数。\n- 通过两个间距分别为 $h$ 和 $\\tilde{h}$ 的连续加密网格，估算观测到的空间收敛阶，公式如下\n$$\np = \\frac{\\ln\\left(E(h)/E(\\tilde{h})\\right)}{\\ln\\left(h/\\tilde{h}\\right)}.\n$$\n\n您的程序必须为以下测试套件评估观测到的收敛阶 $p$，并使用 $N \\in \\{20,40,80,160,320\\}$ 中的最后两次网格加密来计算每种情况下的 $p$：\n- 情况 1 (理想情况): $\\alpha = 10^{-2}$, $\\beta = 1$。\n- 情况 2 (流动反向): $\\alpha = 10^{-2}$, $\\beta = -1$。\n- 情况 3 (强对流主导): $\\alpha = 10^{-6}$, $\\beta = 1$。\n- 情况 4 (纯扩散边缘情况): $\\alpha = 1$, $\\beta = 0$。\n\n预期的行为是，由于 UDS 的原因，$\\beta$ 不为零的情况表现出大约一阶的空间收敛性，而纯扩散情况由于中心差分格式的原因，表现出大约二阶的收敛性。\n\n最终输出规格：\n- 对于每种情况，输出单个浮点数 $p$，四舍五入到三位小数。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按情况 1 到 4 的顺序排列结果，例如 $[p_1,p_2,p_3,p_4]$。\n- 角度单位不适用。不需要物理单位，任何地方都不要使用百分比；所有值都必须以小数表示。\n\n确保科学真实性和自洽性。实现必须直接反映所述原理，不得使用未由所述守恒定律和有限差分定义证明的捷径公式。",
            "solution": "该问题是有效的，因为它提出了一个使用已建立的制造解方法 (MMS) 对数值方法进行验证的标准、良定练习。所有组成部分——控制物理方程、数值格式和分析过程——在科学上都是合理的且定义清晰。\n\n求解过程包括四个主要步骤：源项推导、控制方程离散化、线性系统组装与求解，以及收敛阶计算。\n\n**1. 源项推导**\n控制方程为一维稳态对流扩散方程：\n$$\n- \\alpha \\frac{d^2 T}{dx^2} + \\beta \\frac{d T}{dx} = S(x)\n$$\n制造解方法 (MMS) 要求我们选择一个精确解 $T_{\\text{exact}}(x)$，并将其代入控制方程，以推导出使方程成立的相应源项 $S(x)$。所选择的制造解为：\n$$\nT_{\\text{exact}}(x) = \\sin(2\\pi x)\n$$\n我们计算其关于 $x$ 的一阶和二阶导数：\n$$\n\\frac{dT_{\\text{exact}}}{dx} = 2\\pi \\cos(2\\pi x)\n$$\n$$\n\\frac{d^2T_{\\text{exact}}}{dx^2} = -4\\pi^2 \\sin(2\\pi x)\n$$\n将这些导数代入控制方程，得到源项 $S(x)$：\n$$\nS(x) = - \\alpha \\left(-4\\pi^2 \\sin(2\\pi x)\\right) + \\beta \\left(2\\pi \\cos(2\\pi x)\\right)\n$$\n$$\nS(x) = 4\\alpha\\pi^2 \\sin(2\\pi x) + 2\\beta\\pi \\cos(2\\pi x)\n$$\nDirichlet 边界条件由制造解在域边界 $x=0$ 和 $x=1$ 处求得：\n$$\nT(0) = T_{\\text{exact}}(0) = \\sin(0) = 0\n$$\n$$\nT(1) = T_{\\text{exact}}(1) = \\sin(2\\pi) = 0\n$$\n\n**2. 有限差分离散化**\n域 $x \\in [0,1]$ 使用包含 $N$ 个内部节点的均匀网格进行离散化。网格点从 $i=0$ 索引到 $i=N+1$，使得 $x_i = i h$，其中网格间距为 $h = 1/(N+1)$。数值解 $T_h$ 旨在逼近内部节点 $x_i$（$i=1, 2, \\dots, N$）处的 $T_{\\text{exact}}$。未知值为 $T_i \\equiv T_h(x_i)$。\n\n在内部节点 $x_i$ 处，控制方程的离散形式为：\n$$\n- \\alpha \\left(\\frac{d^2 T}{dx^2}\\right)_i + \\beta \\left(\\frac{d T}{dx}\\right)_i = S(x_i)\n$$\n扩散项使用二阶中心差分格式进行近似：\n$$\n\\left(\\frac{d^2 T}{dx^2}\\right)_i \\approx \\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\n$$\n对流项使用一阶迎风差分格式 (UDS) 进行近似，其格式取决于对流系数 $\\beta$ 的符号。\n- 如果 $\\beta  0$（流动方向为 $x$ 正方向），则使用后向差分：\n$$\n\\left(\\frac{d T}{dx}\\right)_i \\approx \\frac{T_i - T_{i-1}}{h}\n$$\n- 如果 $\\beta  0$（流动方向为 $x$ 负方向），则使用前向差分：\n$$\n\\left(\\frac{d T}{dx}\\right)_i \\approx \\frac{T_{i+1} - T_i}{h}\n$$\n- 如果 $\\beta = 0$，对流项为零。\n\n将这些近似代入控制方程并重新整理，可以得到每个节点 $i$ 的一个线性代数方程。\n\n**情况 1: $\\beta  0$**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) + \\beta \\left(\\frac{T_i - T_{i-1}}{h}\\right) = S_i\n$$\n乘以 $h^2$ 并按未知数 $T_j$ 对各项进行分组：\n$$\n(-\\alpha - \\beta h)T_{i-1} + (2\\alpha + \\beta h)T_i + (-\\alpha)T_{i+1} = h^2 S_i\n$$\n\n**情况 2: $\\beta  0$**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) + \\beta \\left(\\frac{T_{i+1} - T_i}{h}\\right) = S_i\n$$\n乘以 $h^2$ 并分组各项：\n$$\n(-\\alpha)T_{i-1} + (2\\alpha - \\beta h)T_i + (-\\alpha + \\beta h)T_{i+1} = h^2 S_i\n$$\n\n**情况 3: $\\beta = 0$ (纯扩散)**\n$$\n-\\alpha \\left(\\frac{T_{i-1} - 2T_i + T_{i+1}}{h^2}\\right) = S_i\n$$\n$$\n(-\\alpha)T_{i-1} + (2\\alpha)T_i + (-\\alpha)T_{i+1} = h^2 S_i\n$$\n\n**3. 线性系统组装与求解**\n针对内部节点 $i=1, \\dots, N$ 的 $N$ 个线性方程组构成了一个矩阵系统 $A\\mathbf{T}_h = \\mathbf{d}$，其中 $\\mathbf{T}_h = [T_1, T_2, \\dots, T_N]^T$ 是未知节点温度的向量。矩阵 $A$ 是一个 $N \\times N$ 的三对角矩阵，$\\mathbf{d}$ 是右端向量。\n\n$A$ 的元素是上面推导出的系数。对于一般的第 $i$ 行（代表节点 $x_i$），主对角线元素是 $A_{i,i}$，次对角线是 $A_{i,i-1}$，超对角线是 $A_{i,i+1}$。向量 $\\mathbf{d}$ 的元素为 $d_i = h^2 S(x_i)$。\n\n边界条件 $T_0=0$ 和 $T_{N+1}=0$ 影响第一个 ($i=1$) 和最后一个 ($i=N$) 方程。项 $T_0$ 和 $T_{N+1}$ 是已知的，并被移到右侧。由于它们都为零，右端向量 $\\mathbf{d}$ 不受影响。\n\n对每个网格配置，求解所得的三对角系统以得到 $\\mathbf{T}_h$。\n\n**4. 误差分析与收敛阶**\n在获得数值解 $\\mathbf{T}_h$ 后，计算其相对于已知精确解的误差。每个内部节点的节点误差为 $e_i = T_i - T_{\\text{exact}}(x_i)$。对于给定的网格间距 $h$，总体误差使用离散 $L_2$ 范数来衡量：\n$$\nE(h) = \\sqrt{\\frac{1}{N} \\sum_{i=1}^N e_i^2}\n$$\n观测到的空间收敛阶 $p$ 是通过在两个具有不同间距 $h$ 和 $\\tilde{h}$（其中 $\\tilde{h}  h$）的网格上进行模拟来估算的。公式为：\n$$\np = \\frac{\\ln\\left(E(h)/E(\\tilde{h})\\right)}{\\ln\\left(h/\\tilde{h}\\right)}\n$$\n对于此问题，每个 $(\\alpha, \\beta)$ 情况下的 $p$ 都是使用来自两个最密网格（对应于 $N=160$（$h=1/161$）和 $N=320$（$\\tilde{h}=1/321$））的结果计算的。预期的收敛阶为：对于有对流的情况（$\\beta \\neq 0$），由于一阶的 UDS， $p \\approx 1$；对于纯扩散情况（$\\beta = 0$），由于扩散项的二阶中心差分格式，$p \\approx 2$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_case(alpha, beta, N_list):\n    \"\"\"\n    Solves a single case for a given alpha, beta, and list of grid sizes N.\n    \n    This function implements the Method of Manufactured Solutions (MMS) to\n    verify the spatial convergence order of a finite difference scheme for the\n    1D steady convection-diffusion equation. It calculates the L2 error for a\n    series of refined grids and then computes the observed order of convergence\n    from the last two refinements.\n\n    Args:\n        alpha (float): The diffusivity coefficient.\n        beta (float): The convection coefficient.\n        N_list (list of int): A list of the number of interior grid nodes for each refinement.\n\n    Returns:\n        float: The observed spatial order of convergence, p.\n    \"\"\"\n    errors = []\n    h_values = []\n\n    for N in N_list:\n        # 1. Setup grid\n        h = 1.0 / (N + 1)\n        # We only need interior nodes for setting up and solving the system\n        x_interior = np.linspace(h, 1.0 - h, N)\n\n        # 2. Compute manufactured solution and source term at interior nodes\n        T_exact_interior = np.sin(2 * np.pi * x_interior)\n        S_interior = (4 * alpha * np.pi**2 * np.sin(2 * np.pi * x_interior) +\n                      2 * beta * np.pi * np.cos(2 * np.pi * x_interior))\n        \n        # 3. Assemble the linear system A * T_h = d\n        A = np.zeros((N, N))\n        d = h**2 * S_interior\n        # The boundary conditions T(0)=0 and T(1)=0 are homogeneous, so they\n        # do not contribute to the right-hand side vector d.\n\n        # Define tridiagonal coefficients based on the sign of beta (Upwind Scheme)\n        if beta  0:\n            # Backward difference for convection\n            sub_diag_val = -alpha - beta * h\n            main_diag_val = 2 * alpha + beta * h\n            super_diag_val = -alpha\n        elif beta  0:\n            # Forward difference for convection\n            sub_diag_val = -alpha\n            main_diag_val = 2 * alpha - beta * h\n            super_diag_val = -alpha + beta * h\n        else:  # beta == 0, pure diffusion\n            sub_diag_val = -alpha\n            main_diag_val = 2 * alpha\n            super_diag_val = -alpha\n\n        # Populate the tridiagonal matrix A\n        np.fill_diagonal(A, main_diag_val)\n        if N  1:\n            np.fill_diagonal(A[1:], sub_diag_val)\n            np.fill_diagonal(A[:, 1:], super_diag_val)\n\n        # 4. Solve the linear system for the numerical solution T_h\n        T_h = np.linalg.solve(A, d)\n\n        # 5. Compute the discrete L2 error norm\n        nodal_errors = T_h - T_exact_interior\n        l2_error = np.sqrt(np.sum(nodal_errors**2) / N)\n\n        errors.append(l2_error)\n        h_values.append(h)\n\n    # 6. Compute convergence order p from the last two grid refinements\n    # E(h) - errors[-2], E(tilde_h) - errors[-1]\n    # h    - h_values[-2], tilde_h   - h_values[-1]\n    p = np.log(errors[-2] / errors[-1]) / np.log(h_values[-2] / h_values[-1])\n    \n    return p\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {'alpha': 1e-2, 'beta': 1.0},    # Case 1\n        {'alpha': 1e-2, 'beta': -1.0},   # Case 2\n        {'alpha': 1e-6, 'beta': 1.0},    # Case 3\n        {'alpha': 1.0,   'beta': 0.0},    # Case 4\n    ]\n    \n    # Grid refinement sequence\n    N_list = [20, 40, 80, 160, 320]\n    \n    results = []\n    for case in test_cases:\n        alpha = case['alpha']\n        beta = case['beta']\n        \n        # Calculate the observed convergence order for the current case\n        p = solve_case(alpha, beta, N_list)\n        \n        # Round the result to three decimal places\n        results.append(round(p, 3))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "现实世界中的模拟问题常涉及复杂的几何形状和非均匀材料，这要求使用比结构网格上的简单有限差分更灵活的方法。这项最终实践将迎风格式的概念推广到更通用的非结构网格有限体积法（FVM），并解决了显式时间积分格式的稳定性这一关键问题。通过推导并实现适用于非结构网格的局部 Courant-Friedrichs-Lewy (CFL) 条件，你将学会如何处理几何和物理属性的多尺度非均匀性对数值稳定性的影响，从而为解决复杂流动问题打下坚实基础。",
            "id": "3828203",
            "problem": "考虑非均质多孔介质中被动标量的线性平流，其由守恒定律控制：$$\\frac{\\partial}{\\partial t}\\left(\\phi(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) + \\nabla \\cdot \\left(\\boldsymbol{v}(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) = 0,$$ 其中 $u(\\boldsymbol{x},t)$ 表示标量，$\\phi(\\boldsymbol{x})$ 是孔隙度，$\\boldsymbol{v}(\\boldsymbol{x})$ 是速度场。假设有一个非结构化网格将域划分为多边形控制体 $\\{K_i\\}$，其面积为 $\\{|K_i|\\}$，以及面 $\\{f\\}$，其长度为 $\\{|f|\\}$，相对于每个单元 $K_i$ 的单位外法向量为 $\\{\\boldsymbol{n}_{i,f}\\}$。速度场在面上是分片常数，因此对于每个面 $f$ 和每个相邻单元 $K_i$，面法向投影 $a_{i,f} = \\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}$ 是一个常数。\n\n您需要为此情景建立显式迎风有限体积法，并推导由 $\\phi$、$|K_i|$、$|f|$ 和 $a_{i,f}$ 的多尺度非均质性所引起的每个控制体的局部 Courant–Friedrichs–Lewy (CFL) 限制。推导必须从控制体上的守恒积分形式和迎风数值通量的基本定义开始，不得引用任何预先给出的 CFL 公式。仔细论证 $a_{i,f}$ 的符号如何选择穿过内部面和边界面上的迎风状态，以及这如何导致显式格式的单调性条件，从而施加一个局部时间步长限制。明确讨论孔隙度和几何尺寸的非均质性如何在局部上收紧或放宽此限制。\n\n为了进行计算评估，您需要实现一个方法，该方法对于给定的网格和面数据，计算显式迎风格式下每个单元 $K_i$ 的局部最大稳定时间步长 $\\Delta t_i^{\\max}$，然后返回全局限制 $$\\Delta t_{\\text{global}}^{\\max} = \\min_i \\Delta t_i^{\\max}.$$ 如果一个单元没有流出，即所有 $a_{i,f} \\le 0$，使得流出面贡献的总和为零，则将 $\\Delta t_i^{\\max}$ 定义为一个大的哨兵值 $10^{12}$ 秒，以表示一个不受约束的局部时间步长。所有时间输出必须以秒为单位表示。\n\n输入数据由以下测试套件中的网格隐式指定。每个网格由一个单元列表给出，其中每个单元都有孔隙度 $\\phi_i$、面积 $|K_i|$（单位为平方米），以及一个面列表。每个面由其长度 $|f|$（单位为米）、从当前单元看去的面法向投影 $a_{i,f}$（单位为米/秒，正值表示从单元流出），以及相邻单元的索引（如果面是内部的）或 $\\text{None}$（如果是边界面）指定。对于内部面，两个相邻单元的面法向投影必须符号相反且大小相等。\n\n测试套件：\n- 情况 A (均衡的非均质性):\n  - 单元：$i=0,1,2$\n  - 面积：$|K_0|=2.0$, $|K_1|=2.5$, $|K_2|=1.8$ (均为平方米)\n  - 孔隙度：$\\phi_0=\\phi_1=\\phi_2=0.3$\n  - 每个单元的面：\n    - 单元 $0$：($|f|=1.0, a_{0,f}=+0.5, \\text{邻居}=1$)，($|f|=0.8, a_{0,f}=-0.1, \\text{邻居}=2$)，($|f|=1.2, a_{0,f}=+0.2, \\text{邻居}=\\text{None}$)\n    - 单元 $1$：($|f|=1.0, a_{1,f}=-0.5, \\text{邻居}=0$)，($|f|=0.9, a_{1,f}=+0.3, \\text{邻居}=2$)，($|f|=1.1, a_{1,f}=+0.1, \\text{邻居}=\\text{None}$)\n    - 单元 $2$：($|f|=0.8, a_{2,f}=+0.1, \\text{邻居}=0$)，($|f|=0.9, a_{2,f}=-0.3, \\text{邻居}=1$)，($|f|=1.0, a_{2,f}=+0.05, \\text{邻居}=\\text{None}$)\n- 情况 B (具有强流出的小单元):\n  - 单元：$i=0,1$\n  - 面积：$|K_0|=0.2$, $|K_1|=5.0$\n  - 孔隙度：$\\phi_0=\\phi_1=0.25$\n  - 面：\n    - 单元 $0$：($|f|=0.5, a_{0,f}=+3.0, \\text{邻居}=1$)，($|f|=0.4, a_{0,f}=+1.0, \\text{邻居}=\\text{None}$)，($|f|=0.3, a_{0,f}=+0.5, \\text{邻居}=\\text{None}$)\n    - 单元 $1$：($|f|=0.5, a_{1,f}=-3.0, \\text{邻居}=0$)，($|f|=1.2, a_{1,f}=+0.2, \\text{邻居}=\\text{None}$)，($|f|=1.0, a_{1,f}=-0.1, \\text{邻居}=\\text{None}$)\n- 情况 C (孔隙度非均质性主导局部限制):\n  - 单元：$i=0,1,2$\n  - 面积：$|K_0|=|K_1|=|K_2|=1.0$\n  - 孔隙度：$\\phi_0=0.1$, $\\phi_1=0.7$, $\\phi_2=0.3$\n  - 面：\n    - 单元 $0$：($|f|=0.6, a_{0,f}=+0.8, \\text{邻居}=1$)，($|f|=0.5, a_{0,f}=+0.4, \\text{邻居}=\\text{None}$)，($|f|=0.5, a_{0,f}=-0.2, \\text{邻居}=\\text{None}$)\n    - 单元 $1$：($|f|=0.6, a_{1,f}=-0.8, \\text{邻居}=0$)，($|f|=0.6, a_{1,f}=+0.8, \\text{邻居}=2$)，($|f|=0.5, a_{1,f}=+0.1, \\text{邻居}=\\text{None}$)\n    - 单元 $2$：($|f|=0.6, a_{2,f}=-0.8, \\text{邻居}=1$)，($|f|=0.7, a_{2,f}=+0.2, \\text{邻居}=\\text{None}$)\n- 情况 D (无流出，不受约束的局部时间步长):\n  - 单元：$i=0$\n  - 面积：$|K_0|=3.0$\n  - 孔隙度：$\\phi_0=0.2$\n  - 面：\n    - 单元 $0$：($|f|=1.0, a_{0,f}=-0.5, \\text{邻居}=\\text{None}$)，($|f|=2.0, a_{0,f}=-0.1, \\text{邻居}=\\text{None}$)\n\n任务：\n1. 通过在 $K_i$ 上对守恒定律进行积分，并用迎风值替换面通量，推导单元平均值 $u_i^n$ 在大小为 $\\Delta t$ 的时间步长内的显式迎风有限体积更新公式。\n2. 从更新公式中，推导出确保 $u_i^n$ 系数为非负的单调性条件，并由此构建以 $\\phi_i$、$|K_i|$、$|f|$ 和 $a_{i,f}$ 表示的局部 CFL 限制 $\\Delta t_i^{\\max}$。\n3. 实现一个程序，对于每个测试用例，通过取所有单元的 $\\Delta t_i^{\\max}$ 的最小值来计算 $\\Delta t_{\\text{global}}^{\\max}$ (以秒为单位)。如果一个单元没有流出面，则其局部限制使用 $10^{12}$ 秒。\n4. 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，列表中的结果是按 A、B、C、D 顺序排列的四个情况的计算值，每个浮点数四舍五入到六位小数。\n\n所有时间量均以秒表示。此问题不涉及角度。",
            "solution": "该问题要求推导应用于非均质多孔介质中线性平流方程的显式迎风有限体积格式的局部 Courant–Friedrichs–Lewy (CFL) 时间步长限制。推导之后，需要通过计算实现来找到几个测试用例的全局最大稳定时间步长。\n\n### 步骤 1：显式迎风有限体积格式的推导\n\n控制守恒定律由下式给出：\n$$\n\\frac{\\partial}{\\partial t}\\left(\\phi(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) + \\nabla \\cdot \\left(\\boldsymbol{v}(\\boldsymbol{x})\\, u(\\boldsymbol{x},t)\\right) = 0\n$$\n其中 $u$ 是标量浓度，$\\phi$ 是孔隙度，$\\boldsymbol{v}$ 是速度场。\n\n我们首先将此偏微分方程在一个任意控制体 $K_i$ 上以及时间区间 $[t^n, t^{n+1}]$ 内进行积分，其中 $\\Delta t = t^{n+1} - t^n$。\n$$\n\\int_{t^n}^{t^{n+1}} \\int_{K_i} \\frac{\\partial}{\\partial t}\\left(\\phi u\\right) d\\boldsymbol{x} dt + \\int_{t^n}^{t^{n+1}} \\int_{K_i} \\nabla \\cdot (\\boldsymbol{v} u) d\\boldsymbol{x} dt = 0\n$$\n\n对第二项应用散度定理，将体积分转换为边界 $\\partial K_i$ 上的面积分：\n$$\n\\int_{K_i} \\left[ (\\phi u)^{n+1} - (\\phi u)^n \\right] d\\boldsymbol{x} + \\int_{t^n}^{t^{n+1}} \\int_{\\partial K_i} (\\boldsymbol{v} u) \\cdot \\boldsymbol{n}_{i,f} dS dt = 0\n$$\n此处，$\\boldsymbol{n}_{i,f}$ 是 $K_i$ 边界的单位外法向量。\n\n我们引入单元 $K_i$ 中 $u$ 在时间 $t$ 的单元平均值，即 $u_i(t) = \\frac{1}{|K_i|} \\int_{K_i} u(\\boldsymbol{x}, t) d\\boldsymbol{x}$。我们假设孔隙度 $\\phi$ 是分片常数，在单元 $K_i$ 中的值为 $\\phi_i$。第一项可近似为：\n$$\n\\int_{K_i} \\left[ (\\phi u)^{n+1} - (\\phi u)^n \\right] d\\boldsymbol{x} \\approx \\phi_i |K_i| \\left(u_i^{n+1} - u_i^n\\right)\n$$\n其中 $u_i^n = u_i(t^n)$。\n\n对于通量项，我们使用一阶显式时间积分（前向欧拉法），在时间 $t^n$ 处计算通量。边界 $\\partial K_i$ 由一组面 $\\mathcal{F}_i$ 组成。通量积分变为：\n$$\n\\int_{t^n}^{t^{n+1}} \\int_{\\partial K_i} (\\boldsymbol{v} u^n) \\cdot \\boldsymbol{n}_{i,f} dS dt \\approx \\Delta t \\sum_{f \\in \\mathcal{F}_i} \\int_f (\\boldsymbol{v} u^n) \\cdot \\boldsymbol{n}_{i,f} dS\n$$\n问题陈述速度在每个面 $f$ 上是分片常数 $\\boldsymbol{v}_f$。则在面 $f$ 上的积分近似为：\n$$\n\\int_f (\\boldsymbol{v} u^n) \\cdot \\boldsymbol{n}_{i,f} dS \\approx (\\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}) |f| u_f^n = a_{i,f} |f| u_f^n\n$$\n其中 $a_{i,f} = \\boldsymbol{v}_f \\cdot \\boldsymbol{n}_{i,f}$ 是给定的面法向速度投影， $|f|$ 是面的长度，$u_f^n$ 是在时间 $t^n$ 时面上标量值 $u$ 的一个近似。\n\n结合这些近似，得到半离散有限体积格式：\n$$\n\\phi_i |K_i| \\left(u_i^{n+1} - u_i^n\\right) + \\Delta t \\sum_{f \\in \\mathcal{F}_i} |f| a_{i,f} u_f^n = 0\n$$\n整理得到 $u_i^{n+1}$ 的更新公式：\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| a_{i,f} u_f^n\n$$\n迎风格式根据流动方向定义 $u_f^n$。$a_{i,f}$ 的符号表示相对于单元 $K_i$ 的流动方向：\n- 如果 $a_{i,f}  0$，流动从 $K_i$ *流出*。对于 $u_f^n$ 的迎风选择是来自单元 $K_i$ 内部的值，即 $u_f^n = u_i^n$。\n- 如果 $a_{i,f}  0$，流动向 $K_i$ *流入*。对于 $u_f^n$ 的迎风选择是来自相邻单元 $K_j$ 的值，即 $u_f^n = u_j^n$。\n- 如果 $a_{i,f} = 0$，则没有穿过该面的平流通量。\n\n因此，从单元 $K_i$ 的角度看，单个面 $f$ 的数值通量项可以写为：\n$$\n|f| a_{i,f} u_f^n = |f| \\left( \\max(a_{i,f}, 0) u_i^n + \\min(a_{i,f}, 0) u_{j(f)}^n \\right)\n$$\n其中 $j(f)$ 是穿过面 $f$ 与 $K_i$ 相邻的单元的索引。对于边界面，$u_{j(f)}^n$ 将是给定的边界值。\n\n将此代入更新公式：\n$$\nu_i^{n+1} = u_i^n - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\left( \\max(a_{i,f}, 0) u_i^n + \\min(a_{i,f}, 0) u_{j(f)}^n \\right)\n$$\n我们可以将涉及 $u_i^n$ 和相邻值 $u_j^n$ 的项分组：\n$$\nu_i^{n+1} = u_i^n \\left(1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\right) - \\sum_{f \\in \\mathcal{F}_i, \\text{inflow}} \\frac{\\Delta t |f| \\min(a_{i,f}, 0)}{\\phi_i |K_i|} u_{j(f)}^n\n$$\n\n### 步骤 2：单调性条件与局部 CFL 限制\n\n为使数值格式在不产生新极值的意义上稳定（单调性），$u_i^{n+1}$ 的更新必须是时间 $t^n$ 时各值的凸组合。这要求右侧的所有系数都为非负。\n\n1.  **$u_j^n$ 的系数（相邻单元）：** 相邻单元 $u_{j(f)}^n$ 的系数是 $- \\frac{\\Delta t |f| \\min(a_{i,f}, 0)}{\\phi_i |K_i|}$。对于这些项，流动是流入的，所以 $\\min(a_{i,f}, 0) = a_{i,f}  0$。由于 $\\Delta t$、$|f|$、$\\phi_i$ 和 $|K_i|$ 均为正，此系数始终为非负。该条件通过迎风选择自动满足。\n\n2.  **$u_i^n$ 的系数：** $u_i^n$ 的系数是 $\\left(1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\right)$。为使其为非负，我们必须有：\n    $$\n    1 - \\frac{\\Delta t}{\\phi_i |K_i|} \\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0) \\ge 0\n    $$\n    这个不等式对时间步长 $\\Delta t$ 施加了一个上界：\n    $$\n    \\Delta t \\le \\frac{\\phi_i |K_i|}{\\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0)}\n    $$\n分母表示从单元 $K_i$ 流出的总体积速率。分子 $\\phi_i |K_i|$ 表示单元对守恒量的“存储容量”。\n\n因此，单元 $K_i$ 的局部最大稳定时间步长为：\n$$\n\\Delta t_i^{\\max} = \\frac{\\phi_i |K_i|}{\\sum_{f \\in \\mathcal{F}_i} |f| \\max(a_{i,f}, 0)}\n$$\n如果一个单元没有流出面（即对所有 $f \\in \\mathcal{F}_i$ 都有 $a_{i,f} \\le 0$），则分母为零，局部时间步长不受限制。根据问题陈述，在这种情况下我们设置 $\\Delta t_i^{\\max} = 10^{12}$ 秒。\n\n为使整个模拟稳定，时间步长 $\\Delta t$ 必须小于或等于所有局部限制的最小值：\n$$\n\\Delta t_{\\text{global}}^{\\max} = \\min_{i} \\Delta t_i^{\\max}\n$$\n\n### 步骤 3：非均质性的影响\n\n推导出的 CFL 条件清楚地显示了物理和几何属性的非均质性如何影响稳定性：\n- **孔隙度 $\\phi_i$：** 较大的孔隙度 $\\phi_i$ 增加了单元的存储容量，从而 *放宽* 时间步长限制（允许更大的 $\\Delta t_i^{\\max}$）。\n- **单元面积 $|K_i|$：** 较大的单元面积 $|K_i|$ 同样增加了存储容量，*放宽* 了限制。\n- **面长度 $|f|$ 和流出速度 $a_{i,f}  0$：** 乘积 $|f|a_{i,f}$ 表示穿过面 $f$ 流出单元的体积流率。较大的面长度或更高的流出速度会增加总流出率 $\\sum |f|\\max(a_{i,f}, 0)$，这会 *收紧* 时间步长限制（要求更小的 $\\Delta t_i^{\\max}$）。\n\n网格中最具限制性的单元（即决定 $\\Delta t_{\\text{global}}^{\\max}$ 的单元）通常是面积小（$|K_i|$ 小）、孔隙度低（$\\phi_i$ 小）和/或具有大流出通量（$|f|$ 或 $a_{i,f}$ 大）的单元。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the global maximum stable time step for several test cases\n    of an explicit upwind finite volume scheme.\n    \"\"\"\n    test_cases = [\n        # Case A: Balanced heterogeneity\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 2.0, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": +0.5, \"neighbor\": 1},\n                    {\"length\": 0.8, \"normal_vel\": -0.1, \"neighbor\": 2},\n                    {\"length\": 1.2, \"normal_vel\": +0.2, \"neighbor\": None}\n                ]},\n                {\"id\": 1, \"area\": 2.5, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": -0.5, \"neighbor\": 0},\n                    {\"length\": 0.9, \"normal_vel\": +0.3, \"neighbor\": 2},\n                    {\"length\": 1.1, \"normal_vel\": +0.1, \"neighbor\": None}\n                ]},\n                {\"id\": 2, \"area\": 1.8, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 0.8, \"normal_vel\": +0.1, \"neighbor\": 0},\n                    {\"length\": 0.9, \"normal_vel\": -0.3, \"neighbor\": 1},\n                    {\"length\": 1.0, \"normal_vel\": +0.05, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case B: Small cell with strong outflow\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 0.2, \"porosity\": 0.25, \"faces\": [\n                    {\"length\": 0.5, \"normal_vel\": +3.0, \"neighbor\": 1},\n                    {\"length\": 0.4, \"normal_vel\": +1.0, \"neighbor\": None},\n                    {\"length\": 0.3, \"normal_vel\": +0.5, \"neighbor\": None}\n                ]},\n                 {\"id\": 1, \"area\": 5.0, \"porosity\": 0.25, \"faces\": [\n                    {\"length\": 0.5, \"normal_vel\": -3.0, \"neighbor\": 0},\n                    {\"length\": 1.2, \"normal_vel\": +0.2, \"neighbor\": None},\n                    {\"length\": 1.0, \"normal_vel\": -0.1, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case C: Heterogeneous porosity dominating\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 1.0, \"porosity\": 0.1, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": +0.8, \"neighbor\": 1},\n                    {\"length\": 0.5, \"normal_vel\": +0.4, \"neighbor\": None},\n                    {\"length\": 0.5, \"normal_vel\": -0.2, \"neighbor\": None}\n                ]},\n                {\"id\": 1, \"area\": 1.0, \"porosity\": 0.7, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": -0.8, \"neighbor\": 0},\n                    {\"length\": 0.6, \"normal_vel\": +0.8, \"neighbor\": 2},\n                    {\"length\": 0.5, \"normal_vel\": +0.1, \"neighbor\": None}\n                ]},\n                {\"id\": 2, \"area\": 1.0, \"porosity\": 0.3, \"faces\": [\n                    {\"length\": 0.6, \"normal_vel\": -0.8, \"neighbor\": 1},\n                    {\"length\": 0.7, \"normal_vel\": +0.2, \"neighbor\": None}\n                ]}\n            ]\n        },\n        # Case D: No outflow\n        {\n            \"cells\": [\n                {\"id\": 0, \"area\": 3.0, \"porosity\": 0.2, \"faces\": [\n                    {\"length\": 1.0, \"normal_vel\": -0.5, \"neighbor\": None},\n                    {\"length\": 2.0, \"normal_vel\": -0.1, \"neighbor\": None}\n                ]}\n            ]\n        }\n    ]\n\n    results = []\n    \n    for case_data in test_cases:\n        local_max_dts = []\n        for cell in case_data[\"cells\"]:\n            phi_i = cell[\"porosity\"]\n            area_i = cell[\"area\"]\n            \n            # Sum of |f| * max(a_if, 0) over all faces of the cell\n            sum_of_outflows = 0.0\n            for face in cell[\"faces\"]:\n                length_f = face[\"length\"]\n                a_if = face[\"normal_vel\"]\n                if a_if  0:\n                    sum_of_outflows += length_f * a_if\n            \n            # Calculate local max stable time step based on the derived formula\n            if sum_of_outflows  0:\n                dt_i_max = (phi_i * area_i) / sum_of_outflows\n            else:\n                # No outflow, so the local time step is unconstrained.\n                # Use the specified sentinel value.\n                dt_i_max = 1e12\n            \n            local_max_dts.append(dt_i_max)\n            \n        # The global time step is the minimum of all local time steps\n        global_max_dt = min(local_max_dts)\n        results.append(global_max_dt)\n        \n    # Format the final output as specified\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}