{"hands_on_practices": [{"introduction": "布拉格定律是X射线衍射分析的基石，它将晶体的原子层间距与衍射角联系起来。本练习将引导你从波的干涉这一基本物理原理出发，推导布拉格定律，并应用它来计算衍射角和探索实验中可观测到的衍射级数的物理极限 [@problem_id:2924499]。这有助于你深入理解衍射现象的几何约束条件。", "problem": "一束波长为 $\\lambda$ 的单色X射线入射到一个晶体上，该晶体具有一系列晶面间距为 $d$ 的平行晶格平面。在弹性散射和运动学（单次散射）近似下，当从相邻平面反射的光线之间满足特定的程差条件时，会发生相长干涉。\n\n已知 $\\lambda = 0.15418$ nm 和 $d = 0.2000$ nm：\n\n1. 仅使用等间距反射平面的相长干涉所需的程差和相位对齐条件，推导联系入射角（相对于平面，即布拉格角 $\\theta$）、间距 $d$、波长 $\\lambda$ 和整数级 $n$ 之间的关系。使用此关系计算一级角 $\\theta_{1}$（以度为单位）。将 $\\theta_{1}$ 的值四舍五入到四位有效数字。\n\n2. 仅使用您推导的关系所蕴含的几何约束以及正弦函数的界限，确定对于给定的 $\\lambda$ 和 $d$ 所能满足的最大整数衍射级数 $n_{\\max}$。\n\n所有角度均以度表示。提供 $n_{\\max}$ 作为您的最终答案（一个纯数字，无单位）。", "solution": "所给问题是X射线晶体学中的一个标准练习，它在科学上是合理的、提法恰当的、客观且自洽的。所有必要的数据都已提供，问题清晰明确。因此，该问题有效，将提供解答。\n\n该问题需要基于布拉格衍射原理进行两部分分析。\n\n第1部分：布拉格条件的推导及一级角的计算\n\n当从周期性结构散射的波之间，其相邻重复单元散射的波的光程差为波长的整数倍时，会发生相长干涉。在晶体中，这些重复单元是平行的晶格平面。\n\n考虑两束平行的X射线入射到由晶面间距 $d$ 分隔的两个相邻晶格平面上。设相对于平面的入射角和反射角为布拉格角 $\\theta$。与下层平面相互作用的第二束射线比与上层平面相互作用的第一束射线走过的路径更长。光程差 $\\Delta L$ 由两部分组成：第二束射线到达下层平面所经过的额外距离，以及它在反射后为达到与第一束射线相同的波前所经过的额外距离。\n\n通过简单的几何作图可以证明，这两段路径的长度均为 $d \\sin(\\theta)$。总光程差是这两段路径之和。\n$$\n\\Delta L = d \\sin(\\theta) + d \\sin(\\theta) = 2d \\sin(\\theta)\n$$\n为了发生相长干涉，此光程差必须是波长 $\\lambda$ 的整数倍。此条件表示为：\n$$\n\\Delta L = n\\lambda\n$$\n其中 $n$ 是一个正整数（$n = 1, 2, 3, \\ldots$），称为衍射级数。结合这两个表达式即可得到布拉格定律：\n$$\n2d \\sin(\\theta) = n\\lambda\n$$\n这就是所求的联系 $\\theta$、 $d$、 $\\lambda$ 和 $n$ 的关系。\n\n我们需要计算一级角 $\\theta_{1}$，它对应于 $n=1$。给定值为 $\\lambda = 0.15418 \\, \\text{nm}$ 和 $d = 0.2000 \\, \\text{nm}$。\n对于 $n=1$，方程变为：\n$$\n2d \\sin(\\theta_{1}) = 1 \\cdot \\lambda\n$$\n解出 $\\sin(\\theta_{1})$：\n$$\n\\sin(\\theta_{1}) = \\frac{\\lambda}{2d}\n$$\n代入数值：\n$$\n\\sin(\\theta_{1}) = \\frac{0.15418}{2 \\times 0.2000} = \\frac{0.15418}{0.4000} = 0.38545\n$$\n为了求出角度 $\\theta_{1}$，我们计算这个值的反正弦：\n$$\n\\theta_{1} = \\arcsin(0.38545)\n$$\n计算得出 $\\theta_{1} \\approx 22.6738^\\circ$。题目要求结果四舍五入到四位有效数字。\n$$\n\\theta_{1} \\approx 22.67^\\circ\n$$\n\n第2部分：最大衍射级数的确定\n\n布拉格关系式 $2d \\sin(\\theta) = n\\lambda$ 可以重新整理以求解 $\\sin(\\theta)$：\n$$\n\\sin(\\theta) = \\frac{n\\lambda}{2d}\n$$\n对于一个物理角度 $\\theta$（其中 $0^\\circ \\le \\theta \\le 90^\\circ$），正弦函数的值域为 $0 \\le \\sin(\\theta) \\le 1$。因此，只有在以下条件下，$\\theta$ 才存在物理实解：\n$$\n\\frac{n\\lambda}{2d} \\le 1\n$$\n这个不等式对衍射级数 $n$ 的可能整数值施加了约束。我们可以解出 $n$：\n$$\nn \\le \\frac{2d}{\\lambda}\n$$\n由于 $n$ 必须是正整数，最大可能级数 $n_{\\max}$ 是满足此条件的最大整数。这等同于对右侧表达式取底（向下取整）。\n$$\nn_{\\max} = \\left\\lfloor \\frac{2d}{\\lambda} \\right\\rfloor\n$$\n代入给定的 $d$ 和 $\\lambda$ 值：\n$$\nn_{\\max} = \\left\\lfloor \\frac{2 \\times 0.2000}{0.15418} \\right\\rfloor = \\left\\lfloor \\frac{0.4000}{0.15418} \\right\\rfloor\n$$\n计算分数值：\n$$\n\\frac{0.4000}{0.15418} \\approx 2.59437\n$$\n该值的底为：\n$$\nn_{\\max} = \\lfloor 2.59437 \\rfloor = 2\n$$\n因此，对于该晶体和该X射线波长，可以观察到的最大整数衍射级数为 $2$。级数 $n=1$ 和 $n=2$ 在物理上是可能的，但 $n=3$ 及更高则不可能。题目要求以 $n_{\\max}$ 的值作为最终答案。", "answer": "$$\n\\boxed{2}\n$$", "id": "2924499"}, {"introduction": "为了应用布拉格定律，我们必须能够描述和识别晶体中的特定原子平面族，这正是密勒指数 $(hkl)$ 的作用。这个练习将通过一个正交晶系的实例，让你亲手实践如何从晶面的轴截距确定其密勒指数，并从倒易点阵的基本原理出发推导和计算这些平面的间距 $d_{hkl}$ [@problem_id:2924485]。这构成了从晶体结构到衍射图谱的关键一步。", "problem": "一个简单正交晶体的晶格参数为 $a = 4.20\\ \\text{\\AA}$，$b = 5.60\\ \\text{\\AA}$ 和 $c = 7.35\\ \\text{\\AA}$。考虑一族等间距的平行晶面，它们从常规原点测量，在晶轴上的截距分别为 $x = 2a$、$y = -b$ 和 $z = \\frac{c}{3}$。请从米勒指数的定义（即轴截距的倒数，以 $a$、$b$ 和 $c$ 为单位表示）出发，确定这族晶面的米勒指数。然后，仅利用将正交晶系中晶面与倒易点阵相关联的第一性原理，推导并计算这些晶面的晶面间距。你可以使用公认的正点阵与倒易点阵之间的基本关系作为出发点，但不得在没有推导的情况下假定任何预先记忆的间距公式。\n\n将最终的数值答案表示为以 $\\text{\\AA}$ 为单位的晶面间距，并将答案四舍五入到 $4$ 位有效数字。最终答案仅报告晶面间距。使用负截距在相应米勒指数上产生上划线的惯例。X射线衍射的考虑阐明了需要 $d$ 的原因，但在这里的计算中并非直接需要。", "solution": "该问题陈述得当、内部一致且科学上合理。它是一个固态晶体学中的标准练习，可以通过严格应用基本原理来解决。我们将分两部分进行求解：首先，确定指定晶面族的米勒指数；其次，推导并计算相应的晶面间距。\n\n一族平行晶面的米勒指数 $(h, k, l)$ 被定义为一组三个整数，由该族中一个晶面在晶轴上的截距确定。步骤如下：\n1.  以晶格参数 $a$、$b$ 和 $c$ 为单位，找出晶面在各轴上的截距。\n2.  取这些数的倒数。\n3.  化去所有分数，以获得比值相同的一组最小整数。\n\n题目指出，该族中的一个晶面在 $x=2a$、$y=-b$ 和 $z=\\frac{c}{3}$ 处有截距。\n步骤1：以相应晶格参数为单位表示的截距为 $2$、$-1$ 和 $\\frac{1}{3}$。\n\n步骤2：我们取这些值的倒数：\n$$\n\\frac{1}{2}, \\quad \\frac{1}{-1}, \\quad \\frac{1}{1/3}\n$$\n得到一组数：\n$$\n\\frac{1}{2}, \\quad -1, \\quad 3\n$$\n\n步骤3：为了获得最小的整数集，我们将每个数乘以其分母的最小公倍数，即 $2$：\n$$\nh = \\frac{1}{2} \\times 2 = 1\n$$\n$$\nk = -1 \\times 2 = -2\n$$\n$$\nl = 3 \\times 2 = 6\n$$\n按照惯例，负指数用数字上方的横线表示。因此，这族晶面的米勒指数是 $(hkl) = (1\\bar{2}6)$。\n\n接下来，我们必须推导简单正交晶系的晶面间距 $d_{hkl}$ 的公式。我们从正点阵和倒易点阵之间的基本关系开始。\n\n对于由原胞基矢 $\\mathbf{a}$、$\\mathbf{b}$ 和 $\\mathbf{c}$ 定义的晶格，其对应的倒易点阵由原胞基矢 $\\mathbf{a}^*$、$\\mathbf{b}^*$ 和 $\\mathbf{c}^*$ 定义。倒易点阵中的一个矢量可以写为 $\\mathbf{G}_{hkl} = h\\mathbf{a}^* + k\\mathbf{b}^* + l\\mathbf{c}^*$，其中 $h$、$k$ 和 $l$ 是整数。根据定义，这个矢量 $\\mathbf{G}_{hkl}$ 垂直于米勒指数为 $(hkl)$ 的晶面族。晶面间距 $d_{hkl}$ 与该矢量模长的关系由以下基本关系式给出：\n$$\nd_{hkl} = \\frac{1}{|\\mathbf{G}_{hkl}|}\n$$\n注意：这里省略了因子 $2\\pi$，这在晶体学领域是惯例，与固态物理学领域不同。这与下面使用的倒易矢量定义一致。\n\n对于简单正交点阵，正点阵矢量是相互正交的：$\\mathbf{a} \\cdot \\mathbf{b} = \\mathbf{b} \\cdot \\mathbf{c} = \\mathbf{c} \\cdot \\mathbf{a} = 0$。我们可以将它们与笛卡尔坐标系对齐：$\\mathbf{a} = a\\hat{\\mathbf{x}}$、$\\mathbf{b} = b\\hat{\\mathbf{y}}$ 和 $\\mathbf{c} = c\\hat{\\mathbf{z}}$，其中 $a$、$b$ 和 $c$ 是晶格参数。\n\n倒易点阵矢量定义为 $\\mathbf{a}^* = \\frac{\\mathbf{b} \\times \\mathbf{c}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$、$\\mathbf{b}^* = \\frac{\\mathbf{c} \\times \\mathbf{a}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$ 和 $\\mathbf{c}^* = \\frac{\\mathbf{a} \\times \\mathbf{b}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$。对于正交晶系，晶胞的体积是 $V = \\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c}) = (a\\hat{\\mathbf{x}}) \\cdot (b\\hat{\\mathbf{y}} \\times c\\hat{\\mathbf{z}}) = abc$。叉乘结果为 $\\mathbf{b} \\times \\mathbf{c} = bc\\hat{\\mathbf{x}}$、$\\mathbf{c} \\times \\mathbf{a} = ca\\hat{\\mathbf{y}}$ 和 $\\mathbf{a} \\times \\mathbf{b} = ab\\hat{\\mathbf{z}}$。\n将这些代入定义中可得：\n$$\n\\mathbf{a}^* = \\frac{bc\\hat{\\mathbf{x}}}{abc} = \\frac{1}{a}\\hat{\\mathbf{x}}\n$$\n$$\n\\mathbf{b}^* = \\frac{ca\\hat{\\mathbf{y}}}{abc} = \\frac{1}{b}\\hat{\\mathbf{y}}\n$$\n$$\n\\mathbf{c}^* = \\frac{ab\\hat{\\mathbf{z}}}{abc} = \\frac{1}{c}\\hat{\\mathbf{z}}\n$$\n正交晶系的倒易点阵矢量也是正交的，它们的模是正点阵晶格参数的倒数。\n\n因此，对于 $(hkl)$ 晶面的倒易点阵矢量 $\\mathbf{G}_{hkl}$ 为：\n$$\n\\mathbf{G}_{hkl} = h \\left(\\frac{1}{a}\\hat{\\mathbf{x}}\\right) + k \\left(\\frac{1}{b}\\hat{\\mathbf{y}}\\right) + l \\left(\\frac{1}{c}\\hat{\\mathbf{z}}\\right) = \\frac{h}{a}\\hat{\\mathbf{x}} + \\frac{k}{b}\\hat{\\mathbf{y}} + \\frac{l}{c}\\hat{\\mathbf{z}}\n$$\n由于基矢的正交性，该矢量的模 $|\\mathbf{G}_{hkl}|$ 可利用三维勾股定理求得：\n$$\n|\\mathbf{G}_{hkl}| = \\sqrt{\\left(\\frac{h}{a}\\right)^2 + \\left(\\frac{k}{b}\\right)^2 + \\left(\\frac{l}{c}\\right)^2}\n$$\n将此式代入晶面间距表达式 $d_{hkl} = 1/|\\mathbf{G}_{hkl}|$，我们便得出了从第一性原理推导出的正交晶系所需公式：\n$$\nd_{hkl} = \\frac{1}{\\sqrt{\\frac{h^2}{a^2} + \\frac{k^2}{b^2} + \\frac{l^2}{c^2}}}\n$$\n此推导满足了题目的要求。\n\n现在我们计算 $(1\\bar{2}6)$ 晶面的晶面间距的数值。给定的晶格参数为 $a = 4.20\\ \\text{\\AA}$、$b = 5.60\\ \\text{\\AA}$ 和 $c = 7.35\\ \\text{\\AA}$。米勒指数为 $(h, k, l) = (1, -2, 6)$。\n将这些值代入推导出的公式中：\n$$\nd_{1\\bar{2}6} = \\frac{1}{\\sqrt{\\frac{1^2}{(4.20\\ \\text{\\AA})^2} + \\frac{(-2)^2}{(5.60\\ \\text{\\AA})^2} + \\frac{6^2}{(7.35\\ \\text{\\AA})^2}}}\n$$\n$$\nd_{1\\bar{2}6} = \\frac{1}{\\sqrt{\\frac{1}{17.64} + \\frac{4}{31.36} + \\frac{36}{54.0225}}} \\ \\text{\\AA}\n$$\n现在我们计算分母中的各项：\n$$\n\\frac{h^2}{a^2} = \\frac{1}{17.64} \\approx 0.0566916\\ \\text{\\AA}^{-2}\n$$\n$$\n\\frac{k^2}{b^2} = \\frac{4}{31.36} = \\frac{1}{7.84} \\approx 0.1275510\\ \\text{\\AA}^{-2}\n$$\n$$\n\\frac{l^2}{c^2} = \\frac{36}{54.0225} \\approx 0.6663847\\ \\text{\\AA}^{-2}\n$$\n这些项的和是：\n$$\n\\frac{1}{d_{1\\bar{2}6}^2} \\approx 0.0566916 + 0.1275510 + 0.6663847 \\approx 0.8506273\\ \\text{\\AA}^{-2}\n$$\n取该和的平方根：\n$$\n\\frac{1}{d_{1\\bar{2}6}} \\approx \\sqrt{0.8506273} \\approx 0.9222946\\ \\text{\\AA}^{-1}\n$$\n最后，晶面间距 $d_{1\\bar{2}6}$ 是该值的倒数：\n$$\nd_{1\\bar{2}6} \\approx \\frac{1}{0.9222946} \\approx 1.0842503\\ \\text{\\AA}\n$$\n按照要求将结果四舍五入到 $4$ 位有效数字，我们得到最终答案。", "answer": "$$ \\boxed{1.084} $$", "id": "2924485"}, {"introduction": "在实际材料分析中，衍射图谱通常是多种物相和背景信号的复杂叠加，尤其是在存在峰位重叠时，简单的峰识别变得困难。这项计算实践旨在模拟并解决这一挑战，通过构建一个基于全谱拟合的定量分析流程，让你体验如何从一个混合物相的衍射数据中精确地辨别和量化各个组分的含量 [@problem_id:2924475]。这展示了现代X射线衍射作为一种强大分析工具的实际应用。", "problem": "给定两种候选晶相，其粉末X射线衍射图谱中有几个布拉格峰位彼此接近。目标是实现一种全谱拟合方法，以从一个包含背景和噪声的模拟测量图谱中区分并量化相分数。使用基本原理，从布拉格定律和具有物理动机的峰形出发，并将谱图拟合构建为一个在离散化的2θ轴上的约束参数估计问题。\n\n基本原理：\n- 布拉格定律：对于一级衍射，$2 d \\sin \\theta = \\lambda$，它关联了晶面间距 $d$、入射辐射波长 $\\lambda$ 和布拉格角 $\\theta$。\n- 峰形：假设每个布拉格反射都呈高斯峰形。如果半峰全宽（FWHM）为 $w$（单位为度），则标准差为 $\\sigma = \\dfrac{w}{2 \\sqrt{2 \\ln 2}}$，对于一个中心位于 $2\\theta_0$ 的峰，在 $2\\theta$ 处的高斯函数值为 $\\exp\\!\\left(-\\dfrac{(2\\theta - 2\\theta_0)^2}{2 \\sigma^2}\\right)$。\n- 线性叠加：测量到的强度是各相贡献与一个平滑背景的总和。\n\n构建以下模型。设两种相表示为 $\\mathrm{P}$ 和 $\\mathrm{Q}$。对于每种相，给定一个小的晶面间距列表 $d_{h}$ 和相对峰强度 $I_{h}$，其中 $h$ 是该相中反射的索引。对于给定的波长 $\\lambda$，使用布拉格定律（$n=1$）计算相应的峰中心 $2\\theta_{h}$，即 $\\theta_{h} = \\arcsin\\!\\left(\\dfrac{\\lambda}{2 d_{h}}\\right)$ 且 $2\\theta_{h} = 2 \\theta_{h}$，以度为单位表示。对于选定的FWHM $w$（单位为度），在一个共同的 $2\\theta$ 网格 $\\{x_i\\}_{i=1}^{N}$ 上定义相模板为\n$$\nT_{\\mathrm{phase}}(x_i; w) = \\sum_{h} I_{h} \\exp\\!\\left(-\\dfrac{(x_i - 2\\theta_{h})^2}{2 \\sigma^2}\\right),\n$$\n其中 $\\sigma = \\dfrac{w}{2 \\sqrt{2 \\ln 2}}$。在网格点 $x_i$ 处的全谱强度模型为\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 + b_1 \\,(x_i - x_0),\n$$\n其中 $s_{\\mathrm{P}}$ 和 $s_{\\mathrm{Q}}$ 是相 $\\mathrm{P}$ 和 $\\mathrm{Q}$ 的非负尺度因子，$b_0$ 和 $b_1$ 指定了线性背景，$x_0$ 是网格内为保证数值稳定性而设定的一个固定参考角度。\n\n您的任务是：\n1. 通过在指定参数下计算 $y_{\\text{model}}(x_i)$ 并添加具有给定标准差的独立高斯噪声，来模拟测量数据 $y_{\\text{meas}}(x_i)$。\n2. 建立一个全谱拟合程序，在给定测量数据 $y_{\\text{meas}}(x_i)$、使用布拉格定律和高斯峰形构建的模板 $T_{\\mathrm{P}}(x_i; w)$ 和 $T_{\\mathrm{Q}}(x_i; w)$ 以及线性背景基函数的情况下，估计非负尺度因子 $s_{\\mathrm{P}}$ 和 $s_{\\mathrm{Q}}$ 以及背景参数。将此问题构建为一个针对未知系数的非负线性最小二乘问题，确保相尺度因子的非负性，并使背景能够表示正斜率和负斜率（例如，通过将斜率表示为两个非负分量的差）。不要使用任何逐峰积分的方法；一次性使用整个谱图。\n3. 从拟合得到的非负尺度因子 $\\hat{s}_{\\mathrm{P}}$ 和 $\\hat{s}_{\\mathrm{Q}}$ 计算估计的相分数\n$$\n\\hat{f}_{\\mathrm{P}} = \\dfrac{\\hat{s}_{\\mathrm{P}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}, \\quad\n\\hat{f}_{\\mathrm{Q}} = \\dfrac{\\hat{s}_{\\mathrm{Q}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}},\n$$\n并遵循约定：如果 $\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}} = 0$，则返回 $\\hat{f}_{\\mathrm{P}} = 0$ 和 $\\hat{f}_{\\mathrm{Q}} = 0$。最终分数以小数形式表示，而非百分比。\n\n角度单位和波长：\n- 全程使用度（degrees）作为 $2\\theta$ 的单位。\n- 使用 $\\lambda = 1.5406\\,\\text{\\AA}$（铜K-alpha辐射）。\n- 使用从 $x_{\\min} = 20^\\circ$ 到 $x_{\\max} = 80^\\circ$ 的网格，均匀步长为 $\\Delta x = 0.02^\\circ$。选择 $x_0 = 20^\\circ$。\n\n相参考数据：\n- 相 $\\mathrm{P}$：$d$间距（单位：埃）和相对强度\n  - $\\{d_h\\}_{\\mathrm{P}} = [3.000,\\, 2.572,\\, 2.090,\\, 1.606,\\, 1.380]$\n  - $\\{I_h\\}_{\\mathrm{P}} = [100,\\, 60,\\, 40,\\, 25,\\, 20]$\n- 相 $\\mathrm{Q}$：$d$间距（单位：埃）和相对强度\n  - $\\{d_h\\}_{\\mathrm{Q}} = [2.950,\\, 2.530,\\, 2.060,\\, 1.590,\\, 1.360]$\n  - $\\{I_h\\}_{\\mathrm{Q}} = [90,\\, 65,\\, 35,\\, 30,\\, 25]$\n\n测量数据模拟：\n- 对于每个测试，生成 $y_{\\text{meas}}(x_i) = y_{\\text{model}}(x_i) + \\epsilon_i$，其中噪声 $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$ 是独立的，$\\sigma_{\\text{noise}}$ 被指定为该测试的无噪声模型强度的最大值的一个分数。\n- 为保证可复现性，每个测试使用固定的随机种子。\n\n测试套件：\n- 通用设置：$\\lambda = 1.5406\\,\\text{\\AA}$，网格 $x \\in [20^\\circ, 80^\\circ]$，步长 $\\Delta x = 0.02^\\circ$，参考角度 $x_0 = 20^\\circ$。\n- 每个测试用例是一个元组 $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$，其中：\n  1. 测试 A: $(0.7,\\, 0.3,\\, 0.25^\\circ,\\, 50,\\, 0.5,\\, 0.02,\\, 1)$\n  2. 测试 B: $(0.5,\\, 0.5,\\, 0.20^\\circ,\\, 30,\\, 0.0,\\, 0.03,\\, 2)$\n  3. 测试 C: $(0.95,\\, 0.05,\\, 0.25^\\circ,\\, 20,\\, 1.0,\\, 0.01,\\, 3)$\n  4. 测试 D: $(1.0,\\, 0.0,\\, 0.30^\\circ,\\, 40,\\, -0.3,\\, 0.04,\\, 4)$\n  5. 测试 E: $(0.0,\\, 1.0,\\, 0.22^\\circ,\\, 25,\\, 0.2,\\, 0.02,\\, 5)$\n\n所需输出：\n- 对于每个测试，按照上述方法计算 $(\\hat{f}_{\\mathrm{P}}, \\hat{f}_{\\mathrm{Q}})$。\n- 将每个分数四舍五入到三位小数。\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表。列表中的每个元素是对应于一个测试用例的双元素列表，顺序与上面相同。例如，使用占位符值的输出格式如下：\n  \"[[0.700,0.300],[0.500,0.500],[0.950,0.050],[1.000,0.000],[0.000,1.000]]\"。", "solution": "首先对用户提供的问题进行验证检查。\n\n### 第1步：提取给定信息\n问题提供了以下数据、定义和条件：\n- **布拉格定律（一级）：** $2 d \\sin \\theta = \\lambda$，其中 $d$ 是晶面间距，$\\lambda$ 是波长，$\\theta$ 是布拉格角。\n- **高斯峰形：** 一个中心位于 $2\\theta_0$ 的峰在 $2\\theta$ 处的强度由 $I(2\\theta) = \\exp(-\\frac{(2\\theta - 2\\theta_0)^2}{2 \\sigma^2})$ 给出，其中 $\\sigma = \\frac{w}{2 \\sqrt{2 \\ln 2}}$，$w$ 是半峰全宽（FWHM），单位为度。\n- **相模板函数：** 对于给定相，其在网格 $\\{x_i\\}$ 上的衍射图谱模板为 $T_{\\mathrm{phase}}(x_i; w) = \\sum_{h} I_{h} \\exp(-\\frac{(x_i - 2\\theta_{h})^2}{2 \\sigma^2})$，其中 $h$ 索引该相的反射，$I_h$ 是相对强度，$2\\theta_h$ 是根据 $d_h$ 和布拉格定律计算出的峰位。\n- **全强度模型：** 总模型强度是相模板和背景的线性叠加：$y_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 + b_1 \\,(x_i - x_0)$。\n- **测量模拟：** 测量数据生成为 $y_{\\text{meas}}(x_i) = y_{\\text{model}}(x_i) + \\epsilon_i$，其中 $\\epsilon_i$ 是独立的 高斯噪声 $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$。$\\sigma_{\\text{noise}}$ 是无噪声 $y_{\\text{model}}(x_i)$ 最大值的一个指定分数。\n- **参数估计：** 任务是通过解决一个非负线性最小二乘问题来估计非负尺度因子 $s_{\\mathrm{P}}$ 和 $s_{\\mathrm{Q}}$，以及背景参数 $b_0$ 和 $b_1$。\n- **相分数计算：** 估计的分数为 $\\hat{f}_{\\mathrm{P}} = \\frac{\\hat{s}_{\\mathrm{P}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}$ 和 $\\hat{f}_{\\mathrm{Q}} = \\frac{\\hat{s}_{\\mathrm{Q}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}$。如果 $\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}} = 0$，则两个分数都为0。\n- **常数和网格：**\n    - 波长：$\\lambda = 1.5406\\,\\text{\\AA}$。\n    - $2\\theta$ 网格：$x \\in [20^\\circ, 80^\\circ]$，步长 $\\Delta x = 0.02^\\circ$。\n    - 背景参考角度：$x_0 = 20^\\circ$。\n- **相数据（相P）：**\n    - $d$间距 $\\{d_h\\}_{\\mathrm{P}} = [3.000,\\, 2.572,\\, 2.090,\\, 1.606,\\, 1.380]\\,\\text{\\AA}$。\n    - 相对强度 $\\{I_h\\}_{\\mathrm{P}} = [100,\\, 60,\\, 40,\\, 25,\\, 20]$。\n- **相数据（相Q）：**\n    - $d$间距 $\\{d_h\\}_{\\mathrm{Q}} = [2.950,\\, 2.530,\\, 2.060,\\, 1.590,\\, 1.360]\\,\\text{\\AA}$。\n    - 相对强度 $\\{I_h\\}_{\\mathrm{Q}} = [90,\\, 65,\\, 35,\\, 30,\\, 25]$。\n- **测试用例：** 提供了五个测试用例，形式为元组 $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$。\n\n### 第2步：使用提取的给定信息进行验证\n根据验证标准对问题进行评估：\n- **科学上合理：** 该问题牢固地建立在X射线衍射和晶体学的基本原理之上。布拉格定律、衍射图谱是峰的总和的概念、高斯峰形的使用以及混合物的线性叠加都是标准且科学正确的概念。提供的物理常数（$\\lambda$）和结构参数（$d$间距）是现实的。\n- **适定性：** 该问题是适定的。它要求解决一个参数估计问题，该问题被明确地表述为一个非负线性最小二乘（NNLS）问题。这是一个具有唯一解的凸优化问题。所有必要的数据、函数和约束都已明确定义，使得问题自成体系且无歧义。\n- **客观性：** 问题陈述使用了精确、客观的数学和物理语言。没有主观成分、观点或模糊之处。\n\n### 第3步：结论与行动\n该问题在科学上是合理的、适定的、客观的，并包含了获得唯一解所需的所有信息。因此，该问题被判定为**有效**。将开发一个解决方案。\n\n---\n\n### 解决方案\n目标是从模拟的混合相X射线衍射图谱中确定两种晶相 $\\mathrm{P}$ 和 $\\mathrm{Q}$ 的相分数。这是通过一个全谱拟合程序完成的，该程序被构建为一个非负线性最小二乘（NNLS）问题。\n\n在 $2\\theta$ 网格上每个点 $x_i$ 处测量的强度 $y_{\\text{meas}}$ 的模型是基函数的线性组合：\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 \\cdot 1 + b_1 \\cdot (x_i - x_0)\n$$\n这里，$s_{\\mathrm{P}} \\ge 0$ 和 $s_{\\mathrm{Q}} \\ge 0$ 是相模板 $T_{\\mathrm{P}}$ 和 $T_{\\mathrm{Q}}$ 的尺度因子，$b_0$ 和 $b_1$ 是线性背景的系数。目标是通过最小化模型与模拟数据之间的平方误差 $\\|\\mathbf{y}_{\\text{model}} - \\mathbf{y}_{\\text{meas}}\\|_2^2$ 来估计系数向量 $\\mathbf{c} = [s_{\\mathrm{P}}, s_{\\mathrm{Q}}, b_0, b_1]^T$。\n\n为了将其构建为一个所有系数都必须为非负的纯NNLS问题，我们将无约束的背景参数 $b_0$ 和 $b_1$ 表示为两个非负变量的差：$b_0 = b_{0,+} - b_{0,-}$ 和 $b_1 = b_{1,+} - b_{1,-}$，其中 $b_{0,+}, b_{0,-}, b_{1,+}, b_{1,-} \\ge 0$。模型变为：\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}T_{\\mathrm{P}}(x_i) + s_{\\mathrm{Q}}T_{\\mathrm{Q}}(x_i) + b_{0,+} \\cdot 1 + b_{0,-} \\cdot (-1) + b_{1,+}(x_i - x_0) + b_{1,-} \\cdot (-(x_i - x_0))\n$$\n这可以表示为矩阵形式 $\\mathbf{y}_{\\text{model}} = \\mathbf{A}\\mathbf{c}'$，其中 $\\mathbf{y}$ 是网格上的强度向量，$\\mathbf{A}$ 是设计矩阵，$\\mathbf{c}'$ 是新的系数向量。\n\n待估计的系数向量是 $\\mathbf{c}' = [s_{\\mathrm{P}}, s_{\\mathrm{Q}}, b_{0,+}, b_{0,-}, b_{1,+}, b_{1,-}]^T$。$\\mathbf{c}'$ 的每个分量都约束为非负。\n\n设计矩阵 $\\mathbf{A}$ 的维度为 $N \\times 6$，其中 $N$ 是 $2\\theta$ 网格中的点数。其列是在每个网格点 $x_i$ 处求值的基函数：\n- 第1列：相 $\\mathrm{P}$ 模板，$\\mathbf{T}_{\\mathrm{P}}$\n- 第2列：相 $\\mathrm{Q}$ 模板，$\\mathbf{T}_{\\mathrm{Q}}$\n- 第3列：$b_{0,+}$ 的常数项，一个全为1的向量，$\\mathbf{1}$\n- 第4列：$b_{0,-}$ 的常数项，一个全为-1的向量，$-\\mathbf{1}$\n- 第5列：$b_{1,+}$ 的线性项，向量 $(\\mathbf{x} - x_0)$\n- 第6列：$b_{1,-}$ 的线性项，向量 $-(\\mathbf{x} - x_0)$\n\n算法流程如下：\n\n1.  **定义网格和常量：** 建立从 $x_{\\min}=20^\\circ$ 到 $x_{\\max}=80^\\circ$ 且步长 $\\Delta x=0.02^\\circ$ 的 $2\\theta$ 网格 $\\mathbf{x}$。定义固定波长 $\\lambda = 1.5406\\,\\text{\\AA}$ 和参考角度 $x_0 = 20^\\circ$。\n\n2.  **处理每个测试用例：** 对于每组输入参数 $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$：\n    \n    a. **生成相模板：**\n       - 对于每个相（$\\mathrm{P}$ 和 $\\mathrm{Q}$），使用布拉格定律从给定的 $d_h$ 间距计算峰位 $2\\theta_h$：$2\\theta_h = 2 \\arcsin(\\frac{\\lambda}{2d_h})$。`arcsin` 的结果必须从弧度转换为度。\n       - 根据给定的FWHM $w$ 计算高斯峰的标准差 $\\sigma$：$\\sigma = \\frac{w}{2\\sqrt{2\\ln 2}}$。\n       - 通过对每个相的所有反射的高斯分布求和，构建模板向量 $\\mathbf{T}_{\\mathrm{P}}$ 和 $\\mathbf{T}_{\\mathrm{Q}}$，这些分布在网格 $\\mathbf{x}$ 上求值。\n\n    b. **模拟测量数据：**\n       - 构建无噪声强度谱图 $\\mathbf{y}_{\\text{model}} = s_{\\mathrm{P}}\\mathbf{T}_{\\mathrm{P}} + s_{\\mathrm{Q}}\\mathbf{T}_{\\mathrm{Q}} + b_0 + b_1(\\mathbf{x} - x_0)$。\n       - 计算噪声标准差 $\\sigma_{\\text{noise}} = \\text{noise\\_frac} \\times \\max(\\mathbf{y}_{\\text{model}})$。\n       - 使用指定的随机数生成器种子，创建一个噪声向量 $\\boldsymbol{\\epsilon}$，其中每个元素都从 $\\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$ 中抽取。\n       - 最终的模拟数据为 $\\mathbf{y}_{\\text{meas}} = \\mathbf{y}_{\\text{model}} + \\boldsymbol{\\epsilon}$。\n\n    c. **执行非负最小二乘拟合：**\n       - 如上所述组装 $N \\times 6$ 的设计矩阵 $\\mathbf{A}$。\n       - 求解NNLS问题 $\\min_{\\mathbf{c}' \\ge 0} \\|\\mathbf{A}\\mathbf{c}' - \\mathbf{y}_{\\text{meas}}\\|_2^2$ 以获得估计的系数向量 $\\hat{\\mathbf{c}}'$。\n\n    d. **计算相分数：**\n       - 从解向量中提取估计的相尺度因子：$\\hat{s}_{\\mathrm{P}} = \\hat{c}'_0$ 和 $\\hat{s}_{\\mathrm{Q}} = \\hat{c}'_1$。\n       - 计算总和 $S = \\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}$。\n       - 如果 $S  0$，则计算分数为 $\\hat{f}_{\\mathrm{P}} = \\hat{s}_{\\mathrm{P}} / S$ 和 $\\hat{f}_{\\mathrm{Q}} = \\hat{s}_{\\mathrm{Q}} / S$。\n       - 如果 $S = 0$，则设置 $\\hat{f}_{\\mathrm{P}} = 0$ 和 $\\hat{f}_{\\mathrm{Q}} = 0$。\n       - 结果四舍五入到三位小数。\n\n此过程系统地应用于每个测试用例，以生成最终输出。使用 `scipy.optimize.nnls` 为核心估计步骤提供了一个鲁棒的求解器。", "answer": "[[0.699,0.301],[0.501,0.499],[0.950,0.050],[1.000,0.000],[0.000,1.000]]", "id": "2924475"}]}