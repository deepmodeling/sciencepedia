{"hands_on_practices": [{"introduction": "理论联系实际的第一步是将前向通量采样 (FFS) 的核心方程转化为可执行的代码。这个练习将指导你根据给定的通量和界面穿越数据，实现一个计算速率常数及其统计不确定性的程序。通过这个实践 [@problem_id:2826627]，你将加深对 FFS 方法中原始模拟数据（如通量穿越次数和试探轨迹成功率）如何组合以生成最终物理可观测量（即速率常数）的理解。", "problem": "您将实现一个程序，该程序使用过渡路径取样和前向通量取样的逻辑，计算稀有事件转变的基于界面的速率常数。从区域 $A$ 到区域 $B$ 的速率常数将根据第一性原理计算，其值为反应轨迹穿过选定初始界面的概率通量，乘以轨迹刚穿过该界面后在返回 $A$ 之前到达 $B$ 的条件概率。\n\n基本原理和假设：\n- 考虑一个序参量 $\\lambda(\\mathbf{x})$，用于定义一组不相交的界面 $\\{\\lambda_{0}, \\lambda_{1}, \\dots, \\lambda_{M}\\}$，其中 $\\lambda_{0}$ 是 $A$ 的边界，$\\lambda_{M}$ 位于 $B$ 内。一条离开 $A$ 的轨迹在到达 $B$ 之前必须穿过 $\\lambda_{0}$。\n- 速率常数 $k_{AB}$ 定义为从 $A$ 穿过 $\\lambda_{0}$ 的反应轨迹的平均正通量，乘以一条从 $\\lambda_{0}$ 开始的轨迹在返回 $A$ 之前到达 $B$ 的概率。\n- 测量模型：\n  - 穿过 $\\lambda_{0}$ 的通量通过在总模拟时间 $T$ 内观察到的正向穿越次数 $N_{\\mathrm{flux}}$ 来估计，并使用 $\\widehat{\\Phi} = N_{\\mathrm{flux}}/T$。假设穿越次数服从均值为 $\\Phi T$ 的泊松分布，这意味着对于 $N_{\\mathrm{flux}} \\gg 1$，有 $\\mathrm{Var}(\\widehat{\\Phi}) \\approx \\Phi/T$ 和 $\\mathrm{Var}(\\log \\widehat{\\Phi}) \\approx 1/N_{\\mathrm{flux}}$。\n  - 连续界面之间的条件前进概率通过独立的伯努利试验来估计。在界面 $\\lambda_{i}$ 处，您执行 $n_{i}$ 次尝试性发射，并观察到 $s_{i}$ 次成功到达 $\\lambda_{i+1}$ 而未返回 $A$。估计量为 $\\widehat{p}_{i} = s_{i}/n_{i}$。在界面间独立且 $n_{i}$ 足够大的二项分布模型下，$\\mathrm{Var}(\\widehat{p}_{i}) \\approx \\widehat{p}_{i}(1-\\widehat{p}_{i})/n_{i}$，并通过 delta 方法，当 $0  \\widehat{p}_{i}  1$ 时，有 $\\mathrm{Var}(\\log \\widehat{p}_{i}) \\approx (1-\\widehat{p}_{i})/(n_{i}\\widehat{p}_{i})$。\n- 基于界面的速率估计量是以下乘积\n$$\n\\widehat{k}_{AB} \\;=\\; \\widehat{\\Phi} \\;\\prod_{i=0}^{M-1} \\widehat{p}_{i}\n$$\n约定当没有中间界面时，空积等于 $1$。\n- 在独立性和上述近似下，速率估计量对数的方差为\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) \\;\\approx\\; \\frac{1}{N_{\\mathrm{flux}}} \\;+\\; \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_{i}}{n_{i}\\,\\widehat{p}_{i}}\n$$\n并且 $\\widehat{k}_{AB}$ 的近似标准差为\n$$\n\\sigma_{\\widehat{k}} \\;\\approx\\; \\widehat{k}_{AB}\\,\\sqrt{ \\frac{1}{N_{\\mathrm{flux}}} \\;+\\; \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_{i}}{n_{i}\\,\\widehat{p}_{i}} }\n$$\n\n您的程序必须实现以下规则：\n- 给定 $N_{\\mathrm{flux}}$、$T$（单位为皮秒）和界面试验数据列表 $\\{(n_{i}, s_{i})\\}_{i=0}^{M-1}$，使用上述公式计算 $\\widehat{k}_{AB}$ 和 $\\sigma_{\\widehat{k}}$，结果以 $\\mathrm{ps}^{-1}$ 为单位表示。\n- 如果 $N_{\\mathrm{flux}} = 0$，或任何界面的 $s_{i} = 0$，或任何 $n_{i} = 0$，则将该情况的估计量定义为 $\\widehat{k}_{AB} = 0$ 和 $\\sigma_{\\widehat{k}} = 0$。\n- 如果没有界面（列表为空），则将乘积定义为 $1$，并使用上述泊松近似计算仅基于通量的速率及其不确定性。\n\n实现的输入规范：\n- 没有外部输入。程序必须对硬编码在程序中的测试套件计算结果。\n\n输出规范：\n- 对于每个测试用例，输出一个双元素列表 $[\\widehat{k}_{AB},\\sigma_{\\widehat{k}}]$，单位为 $\\mathrm{ps}^{-1}$，两个值都四舍五入到六位有效数字。您的程序应生成单行输出，其中包含所有提供的测试用例的结果，形式为一个用方括号括起来的逗号分隔列表，其中每个元素是针对一个测试用例的双元素列表，例如 $[[x_{1},y_{1}],[x_{2},y_{2}],\\dots]$，没有额外的空白要求。\n\n测试套件：\n- 案例 A（一般多界面情况）：\n  - $N_{\\mathrm{flux}} = 300$，$T = 20000$ $\\mathrm{ps}$，界面 $[(1000, 300), (900, 270), (800, 160)]$。\n- 案例 B（低通量和多个前进概率小的界面）：\n  - $N_{\\mathrm{flux}} = 10$，$T = 10000$ $\\mathrm{ps}$，界面 $[(50, 5), (40, 4), (30, 3), (20, 2)]$。\n- 案例 C（具有高计数的近吸收性下一界面）：\n  - $N_{\\mathrm{flux}} = 5000$，$T = 100000$ $\\mathrm{ps}$，界面 $[(100, 99)]$。\n- 案例 D（退化的零成功边缘情况）：\n  - $N_{\\mathrm{flux}} = 1000$，$T = 100000$ $\\mathrm{ps}$，界面 $[(100, 0), (100, 100)]$。\n- 案例 E（无界面；仅通量估计）：\n  - $N_{\\mathrm{flux}} = 75$，$T = 5000$ $\\mathrm{ps}$，界面 $[]$。\n\n物理单位：\n- 所有速率和不确定性都必须以 $\\mathrm{ps}^{-1}$ 为单位表示。\n\n最终输出格式：\n- 程序必须打印单行，其中包含一个由五个双元素列表组成的列表，每个测试用例一个，每个内部列表为 $[\\widehat{k}_{AB},\\sigma_{\\widehat{k}}]$，四舍五入到六位有效数字，例如 $[[0.1,0.01],[0.2,0.02],[0.3,0.03],[0.4,0.04],[0.5,0.05]]$。", "solution": "所述问题在科学上是合理的、自洽的且定义明确。它提出了一个理论化学中的标准计算任务，具体来说是使用前向通量取样（FFS）方法计算速率常数。所提供的速率估计量及其不确定性的公式是统计学原理的正确应用。我们将着手推导解决方案。\n\n目标是计算从状态 $A$ 到状态 $B$ 的稀有事件转变的速率常数 $\\widehat{k}_{AB}$ 及其相关的统计不确定性 $\\sigma_{\\widehat{k}}$。该计算基于从模拟中收集的数据，即离开状态 $A$ 的轨迹通量以及这些轨迹通过一系列界面向状态 $B$ 前进的成功概率。\n\n速率常数估计量 $\\widehat{k}_{AB}$ 是两个量的乘积：通过第一个界面的估计通量 $\\widehat{\\Phi}$，以及从该界面到达状态 $B$ 的估计条件概率 $\\widehat{P}(\\lambda_M|\\lambda_0)$。\n\n通量 $\\widehat{\\Phi}$ 是根据在总模拟时间 $T$ 内观察到的第一次界面 $\\lambda_0$ 的正向穿越次数 $N_{\\mathrm{flux}}$ 来估计的。\n$$\n\\widehat{\\Phi} = \\frac{N_{\\mathrm{flux}}}{T}\n$$\n$\\widehat{\\Phi}$ 的单位是时间的倒数，这里是 $\\mathrm{ps}^{-1}$。\n\n条件概率 $\\widehat{P}(\\lambda_M|\\lambda_0)$ 是作为连续界面 $\\{\\lambda_0, \\lambda_1, \\dots, \\lambda_M\\}$ 之间前进概率的乘积来计算的。一条轨迹从界面 $\\lambda_i$ 前进到 $\\lambda_{i+1}$ 而不返回状态 $A$ 的概率估计为 $\\widehat{p}_i$。\n$$\n\\widehat{p}_i = \\frac{s_i}{n_i}\n$$\n其中 $n_i$ 是从 $\\lambda_i$ 开始的尝试性轨迹的数量，$s_i$ 是其中成功到达 $\\lambda_{i+1}$ 的数量。\n\n总条件概率是这些单个概率的乘积，假设界面之间的前进是独立事件。\n$$\n\\widehat{P}(\\lambda_M|\\lambda_0) = \\prod_{i=0}^{M-1} \\widehat{p}_i\n$$\n综合这些，速率常数估计量为：\n$$\n\\widehat{k}_{AB} = \\widehat{\\Phi} \\prod_{i=0}^{M-1} \\widehat{p}_i\n$$\n如果没有中间界面（$M=0$），则乘积为空，按约定等于 $1$，因此 $\\widehat{k}_{AB} = \\widehat{\\Phi}$。\n\n为了估计不确定性 $\\sigma_{\\widehat{k}}$，我们首先计算速率常数对数的方差 $\\mathrm{Var}(\\log \\widehat{k}_{AB})$。假设通量和前进概率的估计量是独立的，则它们对数之和的方差是它们方差的和：\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) = \\mathrm{Var}(\\log \\widehat{\\Phi}) + \\sum_{i=0}^{M-1} \\mathrm{Var}(\\log \\widehat{p}_i)\n$$\n问题为这些方差项提供了标准近似：\n- 通量穿越次数 $N_{\\mathrm{flux}}$ 被建模为泊松分布的随机变量。对于 $N_{\\mathrm{flux}} \\gg 1$，通量估计量对数的方差为 $\\mathrm{Var}(\\log \\widehat{\\Phi}) \\approx 1/N_{\\mathrm{flux}}$。\n- 成功试验次数 $s_i$ 被建模为二项分布的随机变量。使用 delta 方法，概率估计量对数的方差为 $\\mathrm{Var}(\\log \\widehat{p}_i) \\approx (1-\\widehat{p}_i)/(n_i\\widehat{p}_i)$，在 $0  \\widehat{p}_i  1$ 时有效。\n\n将这些代入总和，得到对数的总方差：\n$$\n\\mathrm{Var}(\\log \\widehat{k}_{AB}) \\approx \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_i}{n_i\\widehat{p}_i}\n$$\n$\\widehat{k}_{AB}$ 的标准差可以从其对数的方差近似得到。对于均值为 $\\mu_X$ 的随机变量 $X$，有 $\\mathrm{Var}(\\log X) \\approx \\sigma_X^2/\\mu_X^2$。重新整理并将其应用于我们的估计量，我们得到：\n$$\n\\sigma_{\\widehat{k}} \\approx \\widehat{k}_{AB} \\sqrt{\\mathrm{Var}(\\log \\widehat{k}_{AB})}\n$$\n因此，标准差的最终表达式为：\n$$\n\\sigma_{\\widehat{k}} \\approx \\widehat{k}_{AB} \\sqrt{ \\frac{1}{N_{\\mathrm{flux}}} + \\sum_{i=0}^{M-1} \\frac{1-\\widehat{p}_i}{n_i\\widehat{p}_i} }\n$$\n\n必须处理特定的计算规则：\n1. 如果 $N_{\\mathrm{flux}} = 0$，则通量为零，因此 $\\widehat{k}_{AB} = 0$。\n2. 如果任何 $n_i = 0$，则概率 $\\widehat{p}_i$ 未定义。\n3. 如果任何 $s_i = 0$，则 $\\widehat{p}_i = 0$，这使得总乘积为零，因此 $\\widehat{k}_{AB} = 0$。\n这些退化情况导致速率常数为零。对于这些情况，问题将不确定性 $\\sigma_{\\widehat{k}}$ 也定义为零。这些条件防止了在方差计算中出现除以零的情况。\n\n将要实现的算法将首先检查这些退化条件。如果没有满足这些条件，它将继续使用上述公式计算 $\\widehat{k}_{AB}$ 和 $\\sigma_{\\widehat{k}}$。两种数量的最终数值结果都将四舍五入到六位有效数字。实现将是一个处理硬编码测试套件的 Python 脚本。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes interface-based rate constants and their uncertainties for a given test suite,\n    adhering to the principles of Forward Flux Sampling.\n    \"\"\"\n\n    test_cases = [\n        # Case A: General multi-interface case\n        {\"N_flux\": 300, \"T_ps\": 20000, \"interfaces\": [(1000, 300), (900, 270), (800, 160)]},\n        # Case B: Low flux and many interfaces\n        {\"N_flux\": 10, \"T_ps\": 10000, \"interfaces\": [(50, 5), (40, 4), (30, 3), (20, 2)]},\n        # Case C: Nearly absorbing next interface\n        {\"N_flux\": 5000, \"T_ps\": 100000, \"interfaces\": [(100, 99)]},\n        # Case D: Degenerate zero-success edge case\n        {\"N_flux\": 1000, \"T_ps\": 100000, \"interfaces\": [(100, 0), (100, 100)]},\n        # Case E: No interfaces; flux-only estimate\n        {\"N_flux\": 75, \"T_ps\": 5000, \"interfaces\": []},\n    ]\n\n    def round_to_6_sf(x):\n        \"\"\"Rounds a number to 6 significant figures.\"\"\"\n        if x == 0:\n            return 0.0\n        # Format to 5 decimal places in scientific notation, then convert back to float.\n        # This effectively rounds to 6 significant figures.\n        return float(f'{x:.5e}')\n\n    def format_num(n):\n        \"\"\"Formats a number into a string, using standard or scientific notation as appropriate.\"\"\"\n        if n == 0.0:\n            return \"0.0\"\n        # The {:.6g} format specifier rounds to 6 significant digits.\n        return f\"{n:.6g}\"\n\n    case_results = []\n    for case in test_cases:\n        N_flux = case[\"N_flux\"]\n        T_ps = case[\"T_ps\"]\n        interfaces = case[\"interfaces\"]\n\n        # Check for degenerate conditions as per problem statement\n        is_degenerate = (\n            N_flux == 0 or\n            any(n == 0 for n, s in interfaces) or\n            any(s == 0 for n, s in interfaces)\n        )\n\n        if is_degenerate:\n            k_ab_hat = 0.0\n            sigma_k_hat = 0.0\n        else:\n            # Calculate flux\n            phi_hat = N_flux / T_ps\n\n            # Calculate product of probabilities and variance sum\n            p_prod = 1.0\n            var_log_k_sum = 1.0 / N_flux\n\n            for n_i, s_i in interfaces:\n                p_i_hat = s_i / n_i\n                p_prod *= p_i_hat\n                \n                # The condition s_i  0 is guaranteed by the initial check\n                var_log_k_sum += (1.0 - p_i_hat) / (n_i * p_i_hat)\n\n            # Calculate rate constant\n            k_ab_hat = phi_hat * p_prod\n\n            # Calculate standard deviation\n            sigma_k_hat = k_ab_hat * np.sqrt(var_log_k_sum)\n\n        # Round final results to 6 significant figures\n        k_ab_rounded = round_to_6_sf(k_ab_hat)\n        sigma_k_rounded = round_to_6_sf(sigma_k_hat)\n        \n        # Format for final output string.\n        # Using format_num to get a clean string representation.\n        case_results.append(f\"[{format_num(k_ab_rounded)},{format_num(sigma_k_rounded)}]\")\n\n    # Print the final output in the exact required format\n    print(f\"[{','.join(case_results)}]\")\n\nsolve()\n```", "id": "2826627"}, {"introduction": "一次成功的 FFS 模拟不仅需要正确性，还需要高效性。在有限的计算资源下，如何策略性地放置界面以最小化最终速率常数的统计误差，是 FFS 从业者面临的核心挑战。这个练习 [@problem_id:2690120] 探讨了不同的自适应界面放置策略背后的统计学原理，旨在培养你优化模拟方案以获得最高精度结果的能力。", "problem": "一个稀有的反应事件 $A \\to B$ 通过基于界面的过渡路径方法进行研究，例如前向流采样 (FFS) 或过渡界面采样 (TIS)。设 $\\lambda(\\mathbf{x})$ 是一个从势盆 $A$ 到 $B$ 单调递增的序参量，并考虑一系列界面 $A \\equiv \\{\\lambda \\le \\lambda_{0}\\} \\prec \\{\\lambda=\\lambda_{1}\\} \\prec \\cdots \\prec \\{\\lambda=\\lambda_{M}\\} \\equiv \\{\\lambda \\ge \\lambda_{B}\\}$，其中 $\\lambda_{0}  \\lambda_{1}  \\dots  \\lambda_{M}$。在每个界面 $\\lambda_{i}$ 处，发射 $N_{i}$ 条尝试性轨迹，当它们到达 $\\lambda_{i+1}$ (成功) 或返回到 $A$ (失败) 时终止，从而产生条件概率 $p_{i}\\equiv P(\\lambda_{i+1}\\mid \\lambda_{i})$ 的一个估计量 $\\hat{p}_{i}$。总的穿过概率为 $P_{A\\to B}=\\prod_{i=0}^{M-1}p_{i}$，速率为 $k_{AB}=\\Phi_{A0}\\,P_{A\\to B}$，其中 $\\Phi_{A0}$ 是离开 $A$ 并穿过 $\\lambda_{0}$ 的轨迹的稳态通量。假设一个简单的成本模型，其中每条尝试性轨迹的成本在各个界面上近似恒定，并且在领头阶上，界面估计量是统计独立的，在每个界面上具有二项涨落。\n\n哪个选项最好地描述了一种科学合理的自适应算法，用于放置界面以使 $P(\\lambda_{i+1}\\mid \\lambda_{i})$ 在不同的 $i$ 之间近似恒定，并为在固定总计算预算下估计量方差的预期减少提供了一个正确的第一性原理证明？\n\nA. 从 $\\lambda_{0}$ 开始，选择一个目标成功概率 $p^{\\star}\\in(0,1)$ (例如，$p^{\\star}\\approx 0.2$)。对于每个 $i$，使用从 $\\lambda_{i}$ 开始的 $K$ 次尝试的短引导批次来界定两个候选位置 $\\lambda_{i+1}^{-}$ 和 $\\lambda_{i+1}^{+}$，使得观察到的成功分数跨越 $p^{\\star}$，然后用新的引导性尝试在 $\\lambda$ 中应用二分法搜索，直到估计的 $\\hat{p}_{i}\\approx p^{\\star}$ 在一个容差范围内。重复此过程构造 $\\lambda_{i+1}$，令 $i\\leftarrow i+1$，直到 $\\lambda_{M}=\\lambda_{B}$。在正式计算中，将 $N_{i}$ 大致均匀地分配到各个界面（或者如果每个界面的成本不同，则进行小的调整）。理由：利用二项方差 $\\mathrm{Var}(\\hat{p}_{i})=p_{i}(1-p_{i})/N_{i}$ 和独立性，delta方法展开给出相对方差 $\\mathrm{Var}(\\hat{P}_{A\\to B})/P_{A\\to B}^{2}\\approx \\sum_{i}(1-p_{i})/(p_{i}N_{i})$。对于固定的 $\\prod_{i}p_{i}$ 和固定的 $\\{N_{i}\\}$，当所有 $p_{i}$ 相等时，此和最小化，因此自适应地强制 $p_{i}\\approx p^{\\star}$ 会在固定总成本下减少方差。\n\nB. 在 $\\lambda$ 中均匀放置界面：$\\lambda_{i}=\\lambda_{0}+i(\\lambda_{B}-\\lambda_{0})/M$。在采样过程中，自适应地调整 $N_{i}$，以使每个界面达到相同数量的成功轨迹 $N_{i} \\hat{p}_{i}$，这可以均衡信息含量，从而最小化方差。理由：相等的成功次数意味着对乘积的贡献是平衡的，这是最优的。\n\nC. 首先计算平均力势 $F(\\lambda)$，然后放置界面，使得自由能增量 $\\Delta F_{i}=F(\\lambda_{i+1})-F(\\lambda_{i})$ 相等。这将均匀地划分势垒，从而隐式地使 $p_{i}$ 均匀，并因为势垒被均匀采样而最小化方差。\n\nD. 使界面非常稀疏，以至于每个 $p_{i}\\ll 1$，然后通过在这些界面上选择非常大的 $N_{i}$ 来补偿。因为每个 $\\mathrm{Var}(\\hat{p}_{i})$ 随后与 $p_{i}/N_{i}$ 成比例，所以增大 $N_{i}$ 比增加更多界面能更有效地减少方差。\n\nE. 动态地估计提交者函数 $q(\\mathbf{x})\\equiv P(B\\ \\text{before}\\ A\\mid \\mathbf{x})$，并在提交者函数的分位数 $q_{i}$ 处放置界面，使得 $q_{i+1}-q_{i}$ 是常数。因为提交者函数在界面之间线性变化，所以条件概率 $p_{i}$ 相等，方差被最小化，无需进一步的理由。", "solution": "问题要求评估在过渡路径采样方法（如前向流采样 FFS）中放置界面的不同自适应算法，目标是在固定的计算成本下，最小化估计速率常数的统计误差。核心思想是理解界面的放置（它决定了条件概率 $p_i$）和计算量的分配（$N_i$）如何影响总穿过概率 $P_{A\\to B}$ 的估计量的总方差。\n\n首先，让我们建立基本原理。问题陈述总穿过概率由条件概率的乘积给出：\n$$P_{A\\to B} = \\prod_{i=0}^{M-1} p_i$$\n其中 $p_i = P(\\lambda_{i+1} \\mid \\lambda_i)$ 是从界面 $i$ 开始的轨迹在返回状态 $A$ 之前到达界面 $i+1$ 的概率。该概率的估计量为 $\\hat{P}_{A\\to B} = \\prod_{i=0}^{M-1} \\hat{p}_i$。\n\n分析统计误差的关键是计算该估计量的相对方差 $\\mathrm{Var}(\\hat{P}_{A\\to B}) / P_{A\\to B}^2$。对于小误差，这可以近似为估计量对数的方差。这是 delta 方法的标准应用。\n$$ \\frac{\\mathrm{Var}(\\hat{P}_{A\\to B})}{P_{A\\to B}^2} \\approx \\mathrm{Var}(\\ln \\hat{P}_{A\\to B}) = \\mathrm{Var}\\left(\\sum_{i=0}^{M-1} \\ln \\hat{p}_i\\right) $$\n问题陈述不同界面的估计量 $\\hat{p}_i$ 是统计独立的。因此，和的方差是方差的和：\n$$ \\mathrm{Var}\\left(\\sum_{i=0}^{M-1} \\ln \\hat{p}_i\\right) = \\sum_{i=0}^{M-1} \\mathrm{Var}(\\ln \\hat{p}_i) $$\n对每一项再次使用 delta 方法，$\\mathrm{Var}(\\ln \\hat{p}_i) \\approx \\mathrm{Var}(\\hat{p}_i) / p_i^2$。\n问题假设每个界面上 $N_i$ 次尝试的成功/失败遵循二项涨落。估计量 $\\hat{p}_i$ 是成功尝试的分数，所以其方差由二项方差给出：\n$$ \\mathrm{Var}(\\hat{p}_i) = \\frac{p_i(1 - p_i)}{N_i} $$\n结合这些结果，得到总概率估计量的相对方差的表达式：\n$$ \\mathcal{V} \\equiv \\frac{\\mathrm{Var}(\\hat{P}_{A\\to B})}{P_{A\\to B}^2} \\approx \\sum_{i=0}^{M-1} \\frac{\\mathrm{Var}(\\hat{p}_i)}{p_i^2} = \\sum_{i=0}^{M-1} \\frac{p_i(1 - p_i)/N_i}{p_i^2} = \\sum_{i=0}^{M-1} \\frac{1 - p_i}{p_i N_i} $$\n优化问题是在固定的总计算成本约束下最小化此方差 $\\mathcal{V}$。假设每次尝试的成本恒定，这等价于固定总尝试次数 $N_{tot} = \\sum_{i=0}^{M-1} N_i$。界面位置的选择决定了概率集合 $\\{p_i\\}$，其受限于 $\\prod_{i=0}^{M-1} p_i = P_{A\\to B}$。\n\n最直接的策略，也是某些选项所隐含建议的策略，是均匀分配计算预算，使得所有 $i$ 都有 $N_i = N_{tot}/M$。在这种情况下，方差变为：\n$$ \\mathcal{V} \\approx \\frac{M}{N_{tot}} \\sum_{i=0}^{M-1} \\frac{1 - p_i}{p_i} = \\frac{M}{N_{tot}} \\left( \\sum_{i=0}^{M-1} \\frac{1}{p_i} - M \\right) $$\n为了在固定的 $M$ 下最小化此表达式，我们必须最小化和 $\\sum_{i=0}^{M-1} 1/p_i$，约束条件是乘积 $\\prod_{i=0}^{M-1} p_i = P_{A\\to B}$ 为常数。这是一个经典的优化问题，可以用拉格朗日乘数法解决。设 $f(\\{p_i\\}) = \\sum 1/p_i$，约束为 $g(\\{p_i\\}) = \\prod p_i - P_{A\\to B} = 0$。条件 $\\nabla f = \\mu \\nabla g$ 导致 $-\\frac{1}{p_k^2} = \\mu \\frac{\\prod p_i}{p_k}$，这意味着对于所有 $k$，$1/p_k$ 是常数。因此，当所有概率相等时达到最小值：$p_i = p = (P_{A\\to B})^{1/M}$。\n\n因此，在 $N_i$ 相等的假设下，放置界面的最优策略是选择它们，使得所有条件概率 $p_i$ 都相等。\n\n现在，我们基于此推导评估每个选项。\n\n**A. 该选项提出了一种自适应算法，直接旨在使所有 $p_i$ 等于一个目标值 $p^\\star$。所描述的使用引导运行和二分法搜索的程序是实现这一目标的实用且稳健的方法。其提供的理由与我们上面推导的完全一致：它正确地陈述了相对方差的公式，并断言对于固定的 $\\{N_i\\}$，当所有 $p_i$ 相等时达到最小值。这是一个正确的陈述。因此，所提出的算法及其理由都是合理的。**正确**。**\n\n**B. 这个选项是有缺陷的。首先，在 $\\lambda$ 中均匀放置界面是一种幼稚的、非自适应的策略，通常会导致极不均匀的概率 $p_i$。其次，调整 $N_i$ 以使 $N_i p_i$ 恒定的提议并非最优。对于给定的 $\\{p_i\\}$ 集合，$N_i$ 的最优分配是 $N_i \\propto \\sqrt{(1-p_i)/p_i}$，而不是 $N_i \\propto 1/p_i$。所提供的理由是模糊的（“均衡信息含量”）并且不正确。如思考过程所示，该策略实际上最大化了一个与方差相关的项，使其成为次优选择。**不正确**。**\n\n**C. 这个策略效率低下且通常不正确。计算跨越高势垒的平均力势 (PMF) 通常比稀有事件计算本身计算成本更高，这违背了 FFS 的目的。更重要的是，假设相等的自由能增量 $\\Delta F_i$ 会导致相等的条件概率 $p_i$ 是一个严重的过度简化。概率 $p_i$ 取决于动力学和自由能面的完整形状，特别是前进到 $\\lambda_{i+1}$ 和返回状态 $A$ 之间的竞争。其理由是随意的，缺乏严谨性。**不正确**。**\n\n**D. 这种方法从根本上是错误的。基于界面的方法的全部目的就是将一个单一的、非常稀有的事件（概率为 $P_{A\\to B} \\ll 1$）分解为一系列更频繁的事件（其概率 $p_i$ 不会过小）。对于一个非常小的 $p_i$，必须运行极大数量的尝试 $N_i \\gg 1/p_i$ 才能观察到几次成功。这会导致灾难性的效率损失。相对方差 $\\mathcal{V} \\approx \\sum_i 1/(p_i N_i)$ 表明，就方差而言，小的 $p_i$ 值代价极高。增加更多界面来提高单个 $p_i$ 值，远比试图用暴力增加 $N_i$ 来克服小 $p_i$ 更有效。**不正确**。**\n\n**E. 这个选项存在几个理论和实践上的问题。虽然提交者函数 $q(\\mathbf{x})$ 确实是理想的反应坐标，但它通常是未知的。准确估计它通常和原始速率计算问题一样困难，使得这个建议是循环论证。此外，“提交者函数在界面之间线性变化”的说法是错误的；提交者函数是系统坐标的一个复杂的非线性函数。最后，即使可以将界面定义为真实提交者函数的等值面，这些界面与 FFS 条件概率 $p_i$ 之间的关系也并不像所暗示的那么简单，并且它不能自动保证 $p_i$ 相等。该选项没有为方差最小化提供有效的理由。**不正确**。**\n\n总之，选项 A 正确描述了一种用于在 FFS 中放置界面的标准的、实用的自适应算法，并基于第一性原理的统计分析为其有效性提供了严谨且正确的理由。", "answer": "$$\\boxed{A}$$", "id": "2690120"}, {"introduction": "FFS 方法的成败在很大程度上取决于所选序参数（或反应坐标）的质量。一个“差”的序参数可能会隐藏其他缓慢的自由度，导致模拟结果产生系统性偏差或统计方差过大。这个练习 [@problem_id:2645612] 深入剖析了使用不良序参数的后果，帮助你建立起诊断模拟中潜在问题并设计更可靠 FFS 研究的敏锐直觉。", "problem": "在一个充分混合的随机化学反应网络中，一个稀有事件从反应物盆地 $A$ 转变到产物盆地 $B$，并使用前向通量采样 (FFS) 进行分析。在FFS中，一个序参量 $\\lambda(x)$ 被用来定义一个嵌套的非相交界面族 $\\{\\lambda_0,\\lambda_1,\\dots,\\lambda_n\\}$，其中 $\\lambda_0$ 位于盆地 $A$ 之外，而 $\\lambda_n$ 位于盆地 $B$。精确的速率常数为 $k_{AB} = \\Phi_{A,0}\\, P(\\lambda_n \\mid \\lambda_0)$，其中 $\\Phi_{A,0}$ 是离开 $A$ 并到达 $\\lambda_0$ 的轨迹的稳态首次穿越通量，而 $P(\\lambda_n \\mid \\lambda_0)$ 是首次到达 $\\lambda_0$ 的轨迹在返回 $A$ 之前到达 $\\lambda_n$ 的概率。后者被分解为 $P(\\lambda_n \\mid \\lambda_0) = \\prod_{i=0}^{n-1} p_i$，其中 $p_i = P(\\lambda_{i+1} \\mid \\text{在返回 } A \\text{ 之前首次到达 } \\lambda_i)$。在实际的FFS计算中，每个 $p_i$ 的估计方法是：从在 $\\lambda_i$ 处的首次到达系综中采样的构型出发，启动有限数量的随机试验，并计算在返回 $A$ 之前到达 $\\lambda_{i+1}$ 的试验所占的比例。\n\n假设所选的序参量 $\\lambda(x)$ 很差，体现在以下方面：在某些界面 $\\lambda_i$ 和 $\\lambda_{i+1}$ 之间，与 $\\lambda$ 正交的自由度中存在长寿命的亚稳态子区域 $H^{(1)}, H^{(2)}, \\dots$，其驻留时间远长于微观去相关时间。在给定的界面 $\\lambda_i$ 内，首次到达构型的集合是一个混合体，由具有不同真实前向到达概率 $p_i(x)$ 的子系综构成。并且，由于 $H^{(k)}$ 之间的相互转化很慢，从同一个父构型启动多个子试验往往会在每次试验中保持其子系综的特性。考虑两种FFS变体：一种是直接FFS变体，它以相等的权重收集每个界面上的构型；另一种是分支生长FFS变体，它允许每次成功的试验产生多个后代，而没有明确的路径重加权。\n\n以下哪个陈述最能描述这样一个差的序参量对 $k_{AB}$ 的FFS估计量的方差和偏差所造成的影响？\n\nA. 阶段性估计量 $\\hat{p}_i$ 的方差增加，因为在 $\\lambda_i$ 处的构型中，真实成功概率 $p_i(x)$ 的分布很宽泛；根据全方差定律，一个非零的 $\\mathrm{Var}[p_i(x)]$ 会增加二项方差，而来自同一父构型的重复后代会引入额外的相关性，从而进一步增大了方差。\n\nB. 如果界面之间的亚稳态子区域的寿命长于微观去相关时间，则精确分解式 $k_{AB} = \\Phi_{A,0} \\prod_{i=0}^{n-1} p_i$ 不再成立，因此即使在无限采样的情况下，FFS估计量也是渐近有偏的。\n\nC. 在没有适当路径权重的实际分支生长FFS中，$p_i(x)$ 的长寿命异质性会导致 $\\hat{p}_i$ 出现系统性正偏差，因为具有较大 $p_i(x)$ 的构型会产生更多的后代，并在传播到下一个界面的系综中被过度代表。\n\nD. 引入额外的界面以确保没有单个亚稳态子区域跨越超过一个区间 $(\\lambda_i,\\lambda_{i+1})$，可以减小方差，并且如果每个 $\\lambda_i$ 处的构型系综是由真实的首次到达穿越构建的，那么也可以减小有限样本偏差。\n\nE. 初始通量估计 $\\Phi_{A,0}$ 不受差的序参量的影响，因为它仅取决于盆地 $A$ 中的微观动力学，而不取决于界面的定义或位置。\n\n选择所有适用项。", "solution": "问题陈述经过验证。\n\n### 步骤1：提取已知信息\n- 系统是一个充分混合的随机化学反应网络。\n- 过程是一个从反应物盆地 $A$ 到产物盆地 $B$ 的稀有事件转变。\n- 分析方法是前向通量采样 (FFS)。\n- 一个序参量 $\\lambda(x)$ 定义了界面 $\\{\\lambda_0, \\lambda_1, \\dots, \\lambda_n\\}$。\n- 精确的速率常数由 $k_{AB} = \\Phi_{A,0}\\, P(\\lambda_n \\mid \\lambda_0)$ 给出。\n- $\\Phi_{A,0}$ 是离开 $A$ 并到达 $\\lambda_0$ 的轨迹的稳态首次穿越通量。\n- $P(\\lambda_n \\mid \\lambda_0)$ 是首次到达 $\\lambda_0$ 的轨迹在返回 $A$ 之前到达 $\\lambda_n$ 的概率。\n- 该概率被分解为 $P(\\lambda_n \\mid \\lambda_0) = \\prod_{i=0}^{n-1} p_i$，其中 $p_i = P(\\lambda_{i+1} \\mid \\text{在返回 } A \\text{ 之前首次到达 } \\lambda_i)$。\n- 核心问题是一个“差”的序参量 $\\lambda(x)$，它导致在界面之间与 $\\lambda(x)$ 正交的自由度中出现长寿命的亚稳态子区域 $H^{(k)}$。\n- 一个后果是，在界面 $\\lambda_i$ 处的首次到达构型集合是具有不同真实前向到达概率 $p_i(x)$ 的子系综的混合。\n- 这些子区域之间的相互转化很慢，因此从同一个父构型进行的多次试验往往具有相同的 $p_i(x)$。\n- 考虑了两种FFS变体：直接FFS（等权重）和分支生长FFS（每次成功产生多个后代，无路径重加权）。\n- 问题是关于差的序参量对 $k_{AB}$ 的FFS估计量的方差和偏差的影响。\n\n### 步骤2：使用提取的已知信息进行验证\n- **科学基础：** 该问题牢固地植根于稀有事件的统计力学和高级模拟方法的理论。对前向通量采样、其理论基础以及由差的反应坐标（序参量）带来的实际挑战的描述，都是计算物理和化学领域标准且有据可查的主题。亚稳态、首次到达系综和采样偏差等概念是该领域的核心。\n- **定义明确：** 该问题描述了一个具体的、定义明确的情景，并询问其对FFS估计量统计特性的影响。这个情景并非假设，而是该算法一个已知且关键的失效模式，其后果（对偏差和方差的影响）已有很好的理解。\n- **客观性：** 语言技术性强、精确，且不含主观性。它在一个正式的科学框架内提出了一个清晰的因果问题。\n\n其余的验证标准也得到满足。该问题不是非形式化的、不完整的、不切实际的、病态的、微不足道的或无法验证的。它是一个标准的、尽管是高级的计算科学问题。\n\n### 步骤3：结论与行动\n问题陈述是**有效的**。将推导解答。\n\n### 选项分析\n\n核心问题是序参量 $\\lambda(x)$ 的选择不佳。这意味着 $\\lambda(x)$ 并非对反应进程的完整描述。还存在其他缓慢的、与 $\\lambda(x)$ 正交的自由度，它们也控制着转变过程。因此，在给定界面 $\\lambda_i$ 上的构型，就其未来演化而言，在概率上并非等价。一个构型在这些隐藏的慢变量中的位置决定了它到达 $\\lambda_{i+1}$ 的真实概率 $p_i(x)$。由于序参量很差，这个 $p_i(x)$ 在 $\\lambda_i$ 处的首次到达构型系综中会有显著变化。\n\n**A. 阶段性估计量 $\\hat{p}_i$ 的方差增加，因为在 $\\lambda_i$ 处的构型中，真实成功概率 $p_i(x)$ 的分布很宽泛；根据全方差定律，一个非零的 $\\mathrm{Var}[p_i(x)]$ 会增加二项方差，而来自同一父构型的重复后代会引入额外的相关性，从而进一步增大了方差。**\n\n该陈述是正确的。条件概率的估计量 $\\hat{p}_i$ 是许多类伯努利试验结果的平均值。设 $I$ 为单次试验结果的随机变量（成功为1，失败为0），该试验从 $\\lambda_i$ 处首次到达点系综中采样的构型 $x$ 开始。成功概率为 $p_i(x)$。此结果的方差由全方差定律给出：\n$$ \\mathrm{Var}(I) = E[\\mathrm{Var}(I \\mid x)] + \\mathrm{Var}[E(I \\mid x)] $$\n给定一个构型 $x$，该试验是一个成功概率为 $p_i(x)$ 的简单伯努利试验。因此，$E(I \\mid x) = p_i(x)$ 且 $\\mathrm{Var}(I \\mid x) = p_i(x)(1 - p_i(x))$。将这些代入公式得到：\n$$ \\mathrm{Var}(I) = E[p_i(x)(1 - p_i(x))] + \\mathrm{Var}[p_i(x)] $$\n如果序参量是完美的，所有的 $p_i(x)$ 都将等于平均概率 $p_i$，而 $\\mathrm{Var}[p_i(x)]$ 项将为零。总方差将是简单的二项方差 $p_i(1-p_i)$。一个差的序参量意味着 $p_i(x)$ 的分布很宽，使得 $\\mathrm{Var}[p_i(x)]  0$。此项严格非负，会增加总方差。\n此外，如果从同一个父构型启动多次试验（后代），它们的结果不是独立的。在给定父构型的 $p_i(x)$ 的条件下，它们是条件独立的，但由于它们共享相同的 $p_i(x)$，它们是相关的。试验之间的这种正相关性进一步增加了均值估计量 $\\hat{p}_i$ 的方差。陈述中的两个主张都是正确的。\n结论：**正确**。\n\n**B. 如果界面之间的亚稳态子区域的寿命长于微观去相关时间，则精确分解式 $k_{AB} = \\Phi_{A,0} \\prod_{i=0}^{n-1} p_i$ 不再成立，因此即使在无限采样的情况下，FFS估计量也是渐近有偏的。**\n\n该陈述是错误的。速率常数的表达式 $k_{AB} = \\Phi_{A,0} P(\\lambda_n \\mid \\lambda_0)$ 是一个基于通量-布居原理的精确恒等式，前提是 $\\Phi_{A,0}$ 是稳态通量。分解式 $P(\\lambda_n \\mid \\lambda_0) = \\prod_{i=0}^{n-1} p_i$ 是条件概率定义的直接且精确的推论：\n$$ p_i \\equiv P(\\text{到达 } \\lambda_{i+1} \\mid \\text{从 } A \\text{ 首次到达 } \\lambda_i \\text{ 且尚未返回 } A) $$\n这些数学恒等式无论底层动力学或序参量的选择如何都成立。差的序参量导致的问题不是公式失效，而是FFS算法无法提供对真实量 $p_i$ 的无偏估计。真实的 $p_i$ 是 $p_i(x)$ 在 $\\lambda_i$ 处真实稳态首次到达点系综上的平均值。一个差的坐标和一个朴素的采样方案可能导致有偏的估计量 $\\hat{p}_i$，即 $E[\\hat{p}_i] \\neq p_i$。但理论公式本身是严格正确的。\n结论：**错误**。\n\n**C. 在没有适当路径权重的实际分支生长FFS中，$p_i(x)$ 的长寿命异质性会导致 $\\hat{p}_i$ 出现系统性正偏差，因为具有较大 $p_i(x)$ 的构型会产生更多的后代，并在传播到下一个界面的系综中被过度代表。**\n\n该陈述是正确的。这描述了某些FFS变体中众所周知的“富集偏差”或“选择偏差”。在没有适当重加权的分支生长算法中（例如，在过渡路径采样中使用），成功的轨迹被用来为下一阶段生成起始构型。如果前向概率 $p_i(x)$ 存在异质性，具有高 $p_i(x)$ 的构型天生就更容易成功。因此，它们被优先选择来为界面 $\\lambda_{i+1}$ 的系综“产生”后代。这导致在 $\\lambda_{i+1}$ 处的系综不能代表真实的首次到达系综；它偏向于对应于更快路径的状态空间区域。当我们使用这个有偏的系综来估计 $p_{i+1}$ 时，我们试验的平均成功概率将高于真实的 $p_{i+1}$。这种偏差会通过界面传播和累积，导致对转变概率的系统性高估，从而高估最终的速率常数。\n结论：**正确**。\n\n**D. 引入额外的界面以确保没有单个亚稳态子区域跨越超过一个区间 $(\\lambda_i,\\lambda_{i+1})$，可以减小方差，并且如果每个 $\\lambda_i$ 处的构型系综是由真实的首次到达穿越构建的，那么也可以减小有限样本偏差。**\n\n该陈述是正确的。它描述了一种标准且有效的策略，用于缓解由差的序参量引起的问题。\n1.  **减小方差：** 通过将界面设置得更近，到达下一个界面的概率 $p_i$ 会增加并接近1。估计量 $\\hat{p}_i$ 的伯努利方差与 $p_i(1-p_i)$ 成正比。当 $p_i \\to 1$ 时，这个方差项趋近于0。来自 $\\mathrm{Var}[p_i(x)]$ 的方差贡献也倾向于随着路径段变短和复杂性降低而减少。因此，增加界面通常会减小阶段性估计量的总方差。\n2.  **减小有限样本偏差：** 选项 C 中描述的偏差之所以产生，是因为 $\\lambda_i$ 处的系综是从 $\\lambda_{i-1}$ 处的成功试验中生成的有限样本，导致“快速”构型的富集。通过增加 $p_{i-1}$，我们在给定的计算成本下可以生成更多成功的轨迹。这个更大的成功构型池提供了一个更好、更多样化的样本，用于构建 $\\lambda_i$ 处的系综，使其更好地逼近真实的首次到达系综。这直接对抗了富集偏差机制。关于从“真实的首次到达穿越”构建的附带条件是一种理想化情况，但其原理对实际算法仍然适用：在阶段 $i-1$ 的更好采样会导致在阶段 $i$ 的系综偏差更小。\n结论：**正确**。\n\n**E. 初始通量估计 $\\Phi_{A,0}$ 不受差的序参量的影响，因为它仅取决于盆地 $A$ 中的微观动力学，而不取决于界面的定义或位置。**\n\n该陈述是错误的。初始通量 $\\Phi_{A,0}$ 是首次穿越特定界面 $\\lambda_0$ 的稳态速率。界面 $\\lambda_0$ 被定义为序参量取特定值的曲面，即 $\\{x \\mid \\lambda(x) = \\lambda_0\\}$。函数 $\\lambda(x)$ 和值 $\\lambda_0$ 的选择*定义*了该曲面在状态空间中的几何形状和位置。改变序参量函数或移动界面（改变 $\\lambda_0$）通常会改变该曲面，从而改变穿越它的通量值。虽然总速率常数 $k_{AB}$ 是一个不依赖于FFS机制的物理可观测量，但其分解为 $\\Phi_{A,0}$ 和 $P(\\lambda_n \\mid \\lambda_0)$ 完全取决于界面的选择。选择不同的 $\\lambda(x)$ 和 $\\lambda_0$ 会产生不同的 $\\Phi_{A,0}$，这会被一个不同的 $P(\\lambda_n \\mid \\lambda_0)$ 所补偿，以得到相同的乘积 $k_{AB}$。声称 $\\Phi_{A,0}$ 独立于界面定义的说法是根本错误的。\n结论：**错误**。", "answer": "$$\\boxed{ACD}$$", "id": "2645612"}]}