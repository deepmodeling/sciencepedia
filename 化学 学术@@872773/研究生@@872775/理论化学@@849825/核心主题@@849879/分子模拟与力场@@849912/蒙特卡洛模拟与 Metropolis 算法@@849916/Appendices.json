{"hands_on_practices": [{"introduction": "在执行蒙特卡洛模拟之前，精确设定参数是确保物理真实性和计算效率的基石。本练习将引导你解决一个在周期性边界条件下（PBC）的关键几何约束问题。通过推导最大位移步长，你将学会如何协调粒子移动、相互作用截断半径和模拟盒子尺寸之间的关系，以保证最小镜像约定（MIC）的正确应用，这是任何分子模拟代码正确实现的核心。 [@problem_id:2788157]", "problem": "一个由相同粒子组成的均匀经典流体，使用 Metropolis Monte Carlo (MMC) 算法在一个边长为 $L$ 的三维立方盒子中进行模拟，并采用周期性边界条件 (PBC)。粒子间的对相互作用是有限程的，系统采用半径为 $r_{c}$ 的球形截断，并结合最小镜像约定 (MIC)，该约定通过将分离向量的每个笛卡尔分量包装到区间 $\\left(-\\frac{L}{2}, \\frac{L}{2}\\right]$ 中来定义对间距。数密度为 $\\rho$，粒子总数为 $N$，盒子边长满足数密度定义 $\\rho = \\frac{N}{L^{3}}$。截断半径满足 $r_{c}  \\frac{L}{2}$，以确保 MIC 的明确性。\n\n对于单个随机选择的粒子，MMC 的试探移动包括加上一个随机位移向量 $\\boldsymbol{\\Delta}$，其大小受可调参数 $\\delta_{\\max}$ 限制，即 $|\\boldsymbol{\\Delta}| \\le \\delta_{\\max}$。为了确保在评估单粒子试探移动的能量变化时，永远不需要考虑超出最近周期性镜像的对相互作用，您采用以下平移不变的方案：在为所选粒子提议位移之前，您将所有粒子的位置平移一个公共向量（这在 PBC 下是允许的），使得所选粒子恰好位于主模拟单元的几何中心。然后，您施加位移 $\\boldsymbol{\\Delta}$，并根据需要将坐标包装回主单元格中。\n\n在此方案下，仅使用上述基本定义，确定最大的位移大小 $\\delta_{\\max}$，使得在任何单粒子试探移动后，以试探位置为中心、半径为 $r_{c}$ 的整个相互作用球体保证位于 MIC 唯一选择中心镜像的区域内（因此，根据构造，永远不需要考虑与非最近镜像的超出截断半径的相互作用）。请用 $N$、$\\rho$ 和 $r_{c}$ 表示您的答案，形式为一个封闭的解析表达式。最终答案必须是单个解析表达式。不需要四舍五入，也未提供或需要任何数值。", "solution": "问题陈述已经过严格验证，被认为是科学上可靠、定义明确、客观且内部一致的。它提出了一个在理论化学和计算物理领域内可解的问题。我们将进行推导。\n\n系统是一个边长为 $L$ 的立方模拟盒子，采用周期性边界条件 (PBC)。坐标在主模拟单元内定义，我们将其视为以原点为中心、顶点位于 $(\\pm \\frac{L}{2}, \\pm \\frac{L}{2}, \\pm \\frac{L}{2})$ 的立方体 $C$。因此，该单元内的任何位置向量 $\\mathbf{r} = (x, y, z)$ 的分量都满足 $-\\frac{L}{2}  x \\le \\frac{L}{2}$，对于 $y$ 和 $z$ 也同样如此。\n\n问题描述了一种用于 Metropolis Monte Carlo (MMC) 试探移动的特定方案。对于一个随机选择的粒子（例如粒子 $i$），系统中的所有粒子位置都平移一个公共向量，使得粒子 $i$ 被重新定位到主单元的几何中心，即原点 $\\mathbf{0} = (0, 0, 0)$。然后，一个随机位移向量 $\\boldsymbol{\\Delta}$ 被加到粒子 $i$ 的位置上，得到其新的试探位置 $\\mathbf{r}_{i}^{\\text{new}} = \\boldsymbol{\\Delta}$。位移的大小受限于 $|\\boldsymbol{\\Delta}| \\le \\delta_{\\max}$。\n\n核心要求是找到 $\\delta_{\\max}$ 的最大值，以保证“以试探位置为中心、半径为 $r_{c}$ 的整个相互作用球体保证位于 MIC 唯一选择中心镜像的区域内”。“MIC 唯一选择中心镜像的区域”指的是主模拟单元 $C$ 本身。对于该单元内的任何位置向量 $\\mathbf{p}$，最小镜像约定 (MIC) 将返回 $\\mathbf{p}$ 作为其自身的最近镜像向量。如果相互作用球体的任何部分位于此主单元之外，就需要考虑与那些中心镜像靠近盒子对面的粒子的距离，而这正是该方案旨在避免的。\n\n因此，条件是以新试探位置 $\\mathbf{r}_{i}^{\\text{new}} = \\boldsymbol{\\Delta}$ 为中心、半径为 $r_c$ 的球体必须完全包含在主单元 $C = [-\\frac{L}{2}, \\frac{L}{2}]^3$ 内。\n\n设试探位置为 $\\mathbf{r}_{i}^{\\text{new}} = \\boldsymbol{\\Delta} = (\\Delta_x, \\Delta_y, \\Delta_z)$。一个半径为 $r_c$ 的球体 $S$ 以此点为中心。要使该球体包含在由 $-\\frac{L}{2} \\le x,y,z \\le \\frac{L}{2}$ 定义的立方体内，球体在每个笛卡尔方向上的最大和最小范围必须落在此区间内。\n\n考虑 $x$ 分量。球体沿 $x$ 轴的范围是从 $\\Delta_x - r_c$ 到 $\\Delta_x + r_c$。我们必须满足以下两个不等式：\n$$\n\\Delta_x + r_c \\le \\frac{L}{2}\n$$\n$$\n\\Delta_x - r_c \\ge -\\frac{L}{2}\n$$\n这两个不等式可以合并为关于分量 $\\Delta_x$ 绝对值的单个条件：\n$$\n|\\Delta_x| \\le \\frac{L}{2} - r_c\n$$\n这个条件必须对所有三个笛卡尔分量都成立，所以我们要求对于 $\\alpha \\in \\{x, y, z\\}$，有 $|\\Delta_\\alpha| \\le \\frac{L}{2} - r_c$。\n\n这个约束必须对*任何*满足 $|\\boldsymbol{\\Delta}| \\le \\delta_{\\max}$ 的可能试探位移向量 $\\boldsymbol{\\Delta}$ 都成立。为了保证这一点，我们必须考虑最坏情况，即产生其某个分量（例如 $|\\Delta_\\alpha|$）最大可能值的位移。在约束 $|\\boldsymbol{\\Delta}| = \\sqrt{\\Delta_x^2 + \\Delta_y^2 + \\Delta_z^2} \\le \\delta_{\\max}$ 下，任何单个分量（例如 $|\\Delta_x|$）可以达到的最大值是 $\\delta_{\\max}$。这种情况发生在位移向量与该坐标轴对齐时，例如 $\\boldsymbol{\\Delta} = (\\delta_{\\max}, 0, 0)$。\n\n为确保我们的条件对所有有效位移都成立，我们必须将此条件施加在这种最坏情况的大小上。将 $|\\Delta_\\alpha| = \\delta_{\\max}$ 代入导出的不等式中，得到：\n$$\n\\delta_{\\max} \\le \\frac{L}{2} - r_c\n$$\n问题要求的是满足此保证的最大位移大小 $\\delta_{\\max}$。这便是等式极限：\n$$\n\\delta_{\\max} = \\frac{L}{2} - r_c\n$$\n问题陈述要求最终答案用粒子数 $N$、数密度 $\\rho$ 和截断半径 $r_c$ 来表示。数密度由定义 $\\rho = \\frac{N}{L^3}$ 给出。我们可以解出盒子边长 $L$：\n$$\nL^3 = \\frac{N}{\\rho} \\implies L = \\left(\\frac{N}{\\rho}\\right)^{1/3}\n$$\n将这个 $L$ 的表达式代入我们关于 $\\delta_{\\max}$ 的方程中，得到最终结果：\n$$\n\\delta_{\\max} = \\frac{1}{2}\\left(\\frac{N}{\\rho}\\right)^{1/3} - r_c\n$$\n该表达式是在所述方案和几何约束条件下，最大位移参数 $\\delta_{\\max}$ 的最大可能值。初始给定的条件 $r_c  L/2$ 确保了 $\\delta_{\\max}$ 是一个正的、具有物理意义的量。", "answer": "$$\n\\boxed{\\frac{1}{2}\\left(\\frac{N}{\\rho}\\right)^{1/3} - r_{c}}\n$$", "id": "2788157"}, {"introduction": "一个正确设置的模拟仅仅是起点，其采样效率决定了我们能否在有限的计算时间内获得可靠的结果。本练习将深入探讨在高维系统中优化 Metropolis 算法效率的理论核心。通过分析一个理想化的谐振子模型，你将从第一性原理出发，推导出一个在实践中广泛应用的关于“最优接受率”的著名启发式法则，从而深刻理解为何调整步长以达到特定的接受率是提高 MCMC 采样效率的关键策略。 [@problem_id:2788234]", "problem": "在理论化学中，一个常见的场景是对多自由度体系在势能面局域极小值附近的构型玻尔兹曼分布进行采样，其中势能可以用适当的质量加权简正模近似为谐振势。考虑一个具有 $d$ 个独立简正模的体系，在无量纲单位下其势能为 $U(\\mathbf{x}) = \\frac{1}{2} \\sum_{i=1}^{d} x_{i}^{2}$。使得在逆温度 $\\beta = 1$ 时，坐标 $\\mathbf{x} \\in \\mathbb{R}^{d}$ 的目标分布为 $ \\pi(\\mathbf{x}) \\propto \\exp\\!\\left(-U(\\mathbf{x})\\right)$，即一个 $d$ 维标准正态分布。\n\n我们执行形式为 $\\mathbf{y} = \\mathbf{x} + s\\,\\boldsymbol{\\eta}$ 的局域 Metropolis 随机行走提议，其中 $\\boldsymbol{\\eta} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{I}_{d})$ 且独立于 $\\mathbf{x}$。Metropolis 接受概率为 $a(\\mathbf{x},\\mathbf{y}) = \\min\\!\\left\\{1, \\exp\\!\\left[\\log \\pi(\\mathbf{y}) - \\log \\pi(\\mathbf{x})\\right]\\right\\}$，并假定马尔可夫链处于平稳状态，因此 $\\mathbf{x} \\sim \\pi$。为了研究高维行为，考虑标度关系 $s = \\ell / \\sqrt{d}$，其中 $\\ell  0$ 为固定值，并令 $d \\to \\infty$。\n\n仅从上述定义、标准正态分布的性质以及概率论的经典极限定理出发，完成以下步骤：\n1. 推导当 $d \\to \\infty$ 时平均接受概率 $\\alpha(\\ell) = \\mathbb{E}[a(\\mathbf{x},\\mathbf{y})]$ 作为 $\\ell$ 的函数的极限，并用标准正态累积分布函数表示。你可以使用以下事实：对于独立的标准正态变量，适当缩放的和弱收敛于一个标准正态分布；经验平均几乎必然收敛于其期望值。\n2. 在上述标度关系下，将每次提议的渐近期望平方跳跃距离定义为 $J(\\ell) = \\lim_{d \\to \\infty} \\mathbb{E}\\!\\left[\\|\\mathbf{y} - \\mathbf{x}\\|^{2} \\, a(\\mathbf{x},\\mathbf{y})\\right]$，并证明在极限情况下 $J(\\ell)$ 与 $\\ell^{2} \\alpha(\\ell)$ 成正比。\n3. 在 $\\ell  0$ 的范围内最大化 $J(\\ell)$，并确定在 $d \\to \\infty$ 极限下相应的最优接受概率 $\\alpha^{\\star}$。\n\n作为你的最终答案，仅报告最优接受概率 $\\alpha^{\\star}$ 的数值，四舍五入到三位有效数字。该答案是无量纲的，请勿包含任何单位。", "solution": "给定目标分布为一个 $d$ 维标准正态分布，$\\pi(\\mathbf{x}) \\propto \\exp\\!\\left(-\\|\\mathbf{x}\\|^{2}/2\\right)$，以及一个对称随机行走提议 $\\mathbf{y} = \\mathbf{x} + s\\,\\boldsymbol{\\eta}$，其中 $\\boldsymbol{\\eta} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{I}_{d})$，$s = \\ell/\\sqrt{d}$。Metropolis 接受概率为\n$$\na(\\mathbf{x},\\mathbf{y}) = \\min\\!\\left\\{1, \\exp\\!\\left[\\log \\pi(\\mathbf{y}) - \\log \\pi(\\mathbf{x})\\right]\\right\\}。\n$$\n由于提议是对称的，Hastings 比率简化为目标密度的比值。我们分析在固定 $\\ell  0$ 且 $d \\to \\infty$ 时的高维极限。\n\n步骤 1：推导极限平均接受概率 $\\alpha(\\ell)$。\n\n对数密度差为\n$$\n\\Delta \\equiv \\log \\pi(\\mathbf{y}) - \\log \\pi(\\mathbf{x}) \\;=\\; -\\frac{1}{2}\\big(\\|\\mathbf{y}\\|^{2} - \\|\\mathbf{x}\\|^{2}\\big)。\n$$\n使用 $\\mathbf{y} = \\mathbf{x} + s\\,\\boldsymbol{\\eta}$ 和 $s = \\ell/\\sqrt{d}$，\n$$\n\\|\\mathbf{y}\\|^{2} - \\|\\mathbf{x}\\|^{2} \\;=\\; \\|\\mathbf{x} + s\\,\\boldsymbol{\\eta}\\|^{2} - \\|\\mathbf{x}\\|^{2}\n\\;=\\; 2 s\\, \\mathbf{x} \\cdot \\boldsymbol{\\eta} + s^{2} \\|\\boldsymbol{\\eta}\\|^{2}。\n$$\n因此\n$$\n\\Delta \\;=\\; - s\\, \\mathbf{x} \\cdot \\boldsymbol{\\eta} \\;-\\; \\frac{1}{2} s^{2} \\|\\boldsymbol{\\eta}\\|^{2}。\n$$\n在平稳状态下，$\\mathbf{x} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{I}_{d})$ 且独立于 $\\boldsymbol{\\eta} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{I}_{d})$。在 $s = \\ell/\\sqrt{d}$ 的标度关系下，分别考虑这两项。\n\n- 根据独立性和三角阵列的中心极限定理，或通过直接方差计算，投影\n$$\n\\frac{1}{\\sqrt{d}} \\mathbf{x} \\cdot \\boldsymbol{\\eta} \\;=\\; \\frac{1}{\\sqrt{d}} \\sum_{i=1}^{d} x_{i} \\eta_{i}\n$$\n依分布收敛到一个标准正态随机变量 $Z \\sim \\mathcal{N}(0,1)$，因为被加数 $x_{i}\\eta_{i}$ 是独立的，均值为零，且方差为单位1。因此，\n$$\ns\\, \\mathbf{x} \\cdot \\boldsymbol{\\eta} \\;=\\; \\frac{\\ell}{\\sqrt{d}} \\, \\mathbf{x} \\cdot \\boldsymbol{\\eta} \\;\\xrightarrow[d\\to\\infty]{\\mathcal{D}}\\; \\ell\\, Z.\n$$\n\n- 根据强大数定律，\n$$\n\\frac{1}{d}\\|\\boldsymbol{\\eta}\\|^{2} \\;=\\; \\frac{1}{d} \\sum_{i=1}^{d} \\eta_{i}^{2} \\;\\xrightarrow[d\\to\\infty]{\\text{a.s.}}\\; \\mathbb{E}[\\eta_{1}^{2}] \\;=\\; 1.\n$$\n因此\n$$\n\\frac{1}{2} s^{2} \\|\\boldsymbol{\\eta}\\|^{2} \\;=\\; \\frac{1}{2} \\frac{\\ell^{2}}{d} \\|\\boldsymbol{\\eta}\\|^{2} \\;\\xrightarrow[d\\to\\infty]{\\text{a.s.}}\\; \\frac{1}{2} \\ell^{2}。\n$$\n\n结合这两种收敛，并援引关于有界连续泛函收敛的标准论证，可得出 $\\Delta$ 的极限分布：\n$$\n\\Delta \\;\\xrightarrow[d\\to\\infty]{\\mathcal{D}}\\; - \\ell Z \\;-\\; \\frac{1}{2}\\ell^{2},\n$$\n其中 $Z \\sim \\mathcal{N}(0,1)$ 与其他一切都独立。因此，极限情况下的平均接受概率为\n$$\n\\alpha(\\ell) \\;=\\; \\mathbb{E}\\!\\left[\\min\\!\\left\\{1, \\exp(\\Delta)\\right\\}\\right] \\;=\\; \\mathbb{E}\\!\\left[\\min\\!\\left\\{1, \\exp\\!\\left(-\\ell Z - \\frac{1}{2}\\ell^{2}\\right)\\right\\}\\right]。\n$$\n令 $\\phi(z) = \\frac{1}{\\sqrt{2\\pi}} \\exp(-z^{2}/2)$ 表示标准正态概率密度函数，$\\Phi$ 为其累积分布函数。事件 $\\exp(-\\ell Z - \\ell^{2}/2) \\geq 1$ 等价于 $-\\ell Z - \\ell^{2}/2 \\geq 0$，即 $Z \\leq -\\ell/2$。因此\n$$\n\\alpha(\\ell) \\;=\\; \\mathbb{P}(Z \\leq -\\ell/2) \\;+\\; \\mathbb{E}\\!\\left[\\exp\\!\\left(-\\ell Z - \\frac{1}{2}\\ell^{2}\\right)\\, \\mathbf{1}_{\\{Z  -\\ell/2\\}}\\right]。\n$$\n通过配方法计算第二项：\n\\begin{align*}\n\\mathbb{E}\\!\\left[\\exp\\!\\left(-\\ell Z - \\frac{1}{2}\\ell^{2}\\right)\\, \\mathbf{1}_{\\{Z  -\\ell/2\\}}\\right]\n= \\int_{-\\ell/2}^{\\infty} \\exp\\!\\left(-\\ell z - \\frac{1}{2}\\ell^{2}\\right) \\phi(z)\\, \\mathrm{d}z \\\\\n= \\int_{-\\ell/2}^{\\infty} \\frac{1}{\\sqrt{2\\pi}} \\exp\\!\\left(-\\frac{z^{2}}{2} - \\ell z - \\frac{1}{2}\\ell^{2}\\right) \\, \\mathrm{d}z \\\\\n= \\int_{-\\ell/2}^{\\infty} \\frac{1}{\\sqrt{2\\pi}} \\exp\\!\\left(-\\frac{(z+\\ell)^{2}}{2}\\right) \\, \\mathrm{d}z \\\\\n= \\int_{-\\ell/2+\\ell}^{\\infty} \\frac{1}{\\sqrt{2\\pi}} \\exp\\!\\left(-\\frac{u^{2}}{2}\\right) \\, \\mathrm{d}u \\\\\n= 1 - \\Phi(\\ell/2).\n\\end{align*}\n因此，\n$$\n\\alpha(\\ell) \\;=\\; \\Phi(-\\ell/2) \\;+\\; \\big(1 - \\Phi(\\ell/2)\\big) \\;=\\; 2 \\big(1 - \\Phi(\\ell/2)\\big) \\;=\\; 2 \\, \\Phi(-\\ell/2)。\n$$\n这就是所求的作为 $\\ell$ 函数的极限接受概率。\n\n步骤 2：定义并简化渐近期望平方跳跃距离 $J(\\ell)$。\n\n平方跳跃长度为 $\\|\\mathbf{y} - \\mathbf{x}\\|^{2} = s^{2} \\|\\boldsymbol{\\eta}\\|^{2}$。因此\n$$\n\\mathbb{E}\\!\\left[\\|\\mathbf{y} - \\mathbf{x}\\|^{2} \\, a(\\mathbf{x},\\mathbf{y})\\right]\n\\;=\\; s^{2} \\, \\mathbb{E}\\!\\left[\\|\\boldsymbol{\\eta}\\|^{2} \\, a(\\mathbf{x},\\mathbf{y})\\right]。\n$$\n在标度关系 $s = \\ell/\\sqrt{d}$ 下，并利用 $\\|\\boldsymbol{\\eta}\\|^{2}/d \\to 1$ 几乎必然，而 $a(\\mathbf{x},\\mathbf{y})$ 依分布收敛于 $\\min\\{1, \\exp(-\\ell Z - \\ell^{2}/2)\\}$，其期望为 $\\alpha(\\ell)$，标准的控制收敛论证（接受概率以 $1$ 为界，平方范数随 $d$ 线性增长，而 $s^2$ 按 $1/d$ 缩放）给出\n$$\nJ(\\ell) \\;\\equiv\\; \\lim_{d \\to \\infty} \\mathbb{E}\\!\\left[\\|\\mathbf{y} - \\mathbf{x}\\|^{2} \\, a(\\mathbf{x},\\mathbf{y})\\right]\n\\;=\\; \\ell^{2} \\, \\alpha(\\ell)。\n$$\n因此，在相差一个比例常数的情况下，通过最大化 $\\ell^{2} \\alpha(\\ell)$ 可以使渐近期望平方跳跃距离最大化。\n\n步骤 3：最大化 $J(\\ell)$ 并计算最优接受概率 $\\alpha^{\\star}$。\n\n我们需要最大化\n$$\nH(\\ell) \\;=\\; \\ell^{2} \\, \\alpha(\\ell) \\;=\\; 2 \\, \\ell^{2} \\, \\Phi(-\\ell/2), \\quad \\ell  0。\n$$\n对 $H(\\ell)$ 关于 $\\ell$ 求导，利用 $\\frac{\\mathrm{d}}{\\mathrm{d}\\ell} \\Phi(-\\ell/2) = -\\frac{1}{2} \\phi(\\ell/2)$ 以及标准正态密度是偶函数这一事实：\n\\begin{align*}\nH'(\\ell)\n= 4 \\ell \\, \\Phi(-\\ell/2) \\;+\\; 2 \\ell^{2} \\left(-\\frac{1}{2}\\right) \\phi(\\ell/2) \\\\\n= 4 \\ell \\, \\Phi(-\\ell/2) \\;-\\; \\ell^{2} \\, \\phi(\\ell/2)。\n\\end{align*}\n令 $H'(\\ell) = 0$ 并限制 $\\ell  0$，得到最优性条件\n$$\n4 \\, \\Phi(-\\ell/2) \\;=\\; \\ell \\, \\phi(\\ell/2)。\n$$\n令 $t = \\ell/2  0$。则条件变为\n$$\n2 \\, \\Phi(-t) \\;=\\; t \\, \\phi(t)。\n$$\n这个标量方程在 $(0,\\infty)$ 内有唯一解 $t^{\\star}$。数值求解得到 $t^{\\star} \\approx 1.19$，等价地 $\\ell^{\\star} \\approx 2.38$。相应的最优接受概率是\n$$\n\\alpha^{\\star} \\;=\\; \\alpha(\\ell^{\\star}) \\;=\\; 2 \\, \\Phi\\!\\left(-\\frac{\\ell^{\\star}}{2}\\right) \\;=\\; 2 \\, \\Phi(-t^{\\star})。\n$$\n代入 $t^{\\star} \\approx 1.19$ 得到\n$$\n\\alpha^{\\star} \\;\\approx\\; 2 \\, \\Phi(-1.19)。\n$$\n使用标准正态累积分布函数值 $\\Phi(-1.19) \\approx 0.117$，我们得到\n$$\n\\alpha^{\\star} \\;\\approx\\; 0.234。\n$$\n这个值是在谐振（高斯）近似和 $\\ell/\\sqrt{d}$ 标度关系下，局域随机行走 Metropolis 移动的高维最优接受概率，常被用作高维分子蒙特卡洛模拟中的启发式目标接受率。\n\n四舍五入到三位有效数字，最优接受概率为 $0.234$。", "answer": "$$\\boxed{0.234}$$", "id": "2788234"}, {"introduction": "蒙特卡洛模拟的最终目标是从产生的微观状态系综中提取宏观热力学量。本练习将指导你完成加权直方图分析方法（WHAM）方程的推导，这是一种从多个偏置模拟中组合数据以计算态密度和自由能的强大统计技术。完成这一推导，意味着你掌握了连接模拟原始数据与物理世界可观测量（如反应自由能）的关键理论工具，这是计算化学和物理领域的一项核心技能。 [@problem_id:2788182]", "problem": "考虑一个经典系统，其势能函数为 $U$。对该系统在相同的逆温 $\\beta = 1/(k_B T)$ 下进行 $K$ 次独立的正则模拟。在第 $i$ 次模拟中（$i \\in \\{1,\\dots,K\\}$），加入一个偏置势 $w_i(U)$，使得 Metropolis 算法的稳态分布所对应的目标偏置玻尔兹曼权重正比于 $g(U)\\,\\exp\\!\\big(-\\beta\\,[U + w_i(U)]\\big)$，其中 $g(U)$ 是（未知的）态密度。每次模拟都在能量 $U$ 的一个离散化 $\\{U_m\\}$（具有均匀的箱宽 $\\Delta U$）上产生一个直方图 $H_i(U_m)$，其总计数为 $N_i = \\sum_m H_i(U_m)$。令 $Z_i$ 为偏置系综 $i$ 的（未知）归一化常数，并定义 $f_i \\equiv -\\beta^{-1}\\ln Z_i$。\n\n仅从以下基本要素出发：\n- 用于平衡采样的玻尔兹曼分布以及态密度 $g(U)$ 的定义，\n- 满足细致平衡条件的 Metropolis 算法能从目标分布中采样这一事实，\n- 以及直方图计数围绕其均值的多项式（或独立泊松）模型，\n\n利用最大似然法和必要的归一化约束，推导出自洽的加权直方图分析方法 (WHAM) 方程。这些方程能最优地组合 $K$ 个偏置直方图 $\\{H_i(U_m)\\}$，以估算 $g(U_m)$（相差一个整体的乘法常数），并同时推导出决定 $f_i$ 的相关方程。然后，概述一个能够自洽求解这些方程的不动点迭代方案。\n\n作为最终答案，报告定义 $g(U_m)$ 和 $f_i$ 的两个耦合不动点更新的封闭形式解析表达式，用 $\\{H_i(U_m)\\}$、$\\{N_i\\}$、$\\{w_i(U_m)\\}$、$\\beta$ 和 $\\Delta U$ 表示。你的最终表达式必须是精确的符号公式（不需要进行数值计算）。请仅以解析表达式的形式给出最终答案，不带任何单位。", "solution": "所述问题在科学上是合理的、适定的，并包含了进行严格推导所需的所有信息。这是计算统计力学中的一个标准问题。我将开始推导。\n\n目标是从一组 $K$ 次偏置模拟中，推导出态密度 $g(U)$ 和自由能 $f_i$ 的自洽方程。该推导从第一性原理出发，使用最大似然法。\n\n在逆温为 $\\beta$ 的正则系综中，观察到系统处于能量为 $E$ 的微观态的概率正比于 $\\exp(-\\beta E)$。态密度 $g(U)$ 是能量为 $U$ 时单位能量内的微观态数目。因此，系统能量为 $U$ 的概率由玻尔兹曼分布给出，$P_{\\text{can}}(U) \\propto g(U) \\exp(-\\beta U)$。\n\n在模拟 $i$ 中，施加了一个偏置势 $w_i(U)$。如题目所述，模拟从一个正比于 $g(U)\\exp(-\\beta[U + w_i(U)])$ 的目标分布中采样。因此，在模拟 $i$ 中观察到能量为 $U$ 的概率是：\n$$ P_i(U) = \\frac{g(U) \\exp(-\\beta[U + w_i(U)])}{Z_i} $$\n其中 $Z_i$ 是模拟 $i$ 的配分函数：\n$$ Z_i = \\int g(U) \\exp(-\\beta[U + w_i(U)]) \\, dU $$\n题目定义了自由能 $f_i \\equiv -\\beta^{-1}\\ln Z_i$，因此 $Z_i = \\exp(-\\beta f_i)$。\n\n能量景观被离散化为宽度为 $\\Delta U$ 的箱 $\\{U_m\\}$。我们将连续函数近似为在这些箱上的分段常数。配分函数的积分变为一个求和：\n$$ Z_i \\approx \\Delta U \\sum_m g(U_m) \\exp(-\\beta[U_m + w_i(U_m)]) $$\n令 $g_m \\equiv g(U_m)\\Delta U$ 为箱 $m$ 中的无量纲态数目。配分函数为 $Z_i = \\sum_m g_m \\exp(-\\beta[U_m + w_i(U_m)])$。来自模拟 $i$ 的一个样本落入能量箱 $m$ 的概率是：\n$$ p_{im} = \\frac{g_m \\exp(-\\beta[U_m + w_i(U_m)])}{Z_i} = g_m \\exp(-\\beta[U_m + w_i(U_m) - f_i]) $$\n注意 $\\Delta U$ 已被吸收到 $g_m$ 的定义中。\n\n来自模拟的数据是直方图 $H_i(U_m)$，即来自模拟 $i$ 且落在箱 $m$ 中的样本计数。模拟 $i$ 的总计数是 $N_i = \\sum_m H_i(U_m)$。我们将计数 $H_i(U_m)$ 建模为独立的泊松随机变量。期望计数值 $\\langle H_i(U_m) \\rangle$ 正比于总样本数 $N_i$ 和概率 $p_{im}$。对于大量的独立样本 $N_i$，平均计数为 $\\langle H_i(U_m) \\rangle = N_i p_{im}$。\n$$ \\langle H_i(U_m) \\rangle = N_i g_m \\exp(-\\beta[U_m + w_i(U_m) - f_i]) $$\n对于一组均值为 $\\{\\langle H_i(U_m) \\rangle\\}$ 的独立泊松变量 $\\{H_i(U_m)\\}$，其对数似然函数为（相差一个不依赖于参数 $\\{g_m, f_i\\}$ 的加法常数）：\n$$ \\ln \\mathcal{L}(\\{g_m\\}, \\{f_i\\}) = \\sum_{i=1}^K \\sum_m \\left( H_i(U_m) \\ln \\langle H_i(U_m) \\rangle - \\langle H_i(U_m) \\rangle \\right) $$\n代入 $\\langle H_i(U_m) \\rangle$ 的表达式：\n$$ \\ln \\mathcal{L} = \\sum_{i,m} \\left( H_i(U_m) \\ln\\left(N_i g_m \\exp(-\\beta[U_m + w_i(U_m) - f_i])\\right) - N_i g_m \\exp(-\\beta[U_m + w_i(U_m) - f_i]) \\right) $$\n第二项求和后为一个常数：$\\sum_{i,m} N_i p_{im} = \\sum_i N_i \\sum_m p_{im} = \\sum_i N_i = \\text{常数}$。因此，最大化对数似然等价于最大化：\n$$ \\ln \\mathcal{L}' = \\sum_{i,m} H_i(U_m) \\left( \\ln g_m + \\beta f_i \\right) $$\n必须在定义 $\\{f_i\\}$ 的归一化约束条件下，对 $\\{g_m\\}$ 和 $\\{f_i\\}$ 最大化此式：\n$$ \\exp(-\\beta f_i) = \\sum_m g_m \\exp(-\\beta[U_m + w_i(U_m)]) $$\n我们使用拉格朗日乘子法。需要最大化的目标函数是：\n$$ \\Lambda = \\sum_{i,m} H_i(U_m) \\left( \\ln g_m + \\beta f_i \\right) - \\sum_i \\lambda_i \\left( \\exp(-\\beta f_i) - \\sum_m g_m \\exp(-\\beta[U_m + w_i(U_m)]) \\right) $$\n其中我们省略了不依赖于 $\\{g_m, f_i\\}$ 的项。\n我们将关于参数的偏导数设为零。\n首先，对特定箱 $n$ 的 $g_n$ 求偏导：\n$$ \\frac{\\partial \\Lambda}{\\partial g_n} = \\frac{1}{g_n} \\sum_{i=1}^K H_i(U_n) + \\sum_{i=1}^K \\lambda_i \\exp(-\\beta[U_n + w_i(U_n)]) = 0 $$\n其次，对特定模拟 $j$ 的 $f_j$ 求偏导：\n$$ \\frac{\\partial \\Lambda}{\\partial f_j} = \\beta \\sum_m H_j(U_m) - \\lambda_j (-\\beta \\exp(-\\beta f_j)) = 0 $$\n$$ \\beta N_j + \\lambda_j \\beta \\exp(-\\beta f_j) = 0 \\implies \\lambda_j = -N_j \\exp(\\beta f_j) $$\n将 $\\lambda_i$ 的这个表达式代回到关于 $g_n$ 求导得出的方程中：\n$$ \\frac{\\sum_i H_i(U_n)}{g_n} - \\sum_{i=1}^K N_i \\exp(\\beta f_i) \\exp(-\\beta[U_n + w_i(U_n)]) = 0 $$\n对 $g_n$ 重新整理，得到第一个自洽方程：\n$$ g_n = \\frac{\\sum_{i=1}^K H_i(U_n)}{\\sum_{i=1}^K N_i \\exp(-\\beta[U_n + w_i(U_n) - f_i])} $$\n这给出了无量纲的态数目 $g_m = g(U_m)\\Delta U$。用态密度 $g(U_m)$ 表示，即为：\n$$ g(U_m) = \\frac{1}{\\Delta U} \\frac{\\sum_{i=1}^K H_i(U_m)}{\\sum_{i=1}^K N_i \\exp(-\\beta[U_m + w_i(U_m) - f_i])} $$\n第二个自洽方程就是约束方程，它将 $f_i$ 与 $g(U_m)$ 联系起来：\n$$ \\exp(-\\beta f_i) = \\sum_m g(U_m)\\Delta U \\exp(-\\beta[U_m + w_i(U_m)]) $$\n取对数得到 $f_i$ 的显式方程：\n$$ f_i = -\\frac{1}{\\beta} \\ln \\left( \\Delta U \\sum_m g(U_m) \\exp(-\\beta[U_m + w_i(U_m)]) \\right) $$\n这两个耦合方程就是 WHAM 方程。它们通过不动点迭代进行自洽求解：\n1. 初始化自由能 $\\{f_i^{(0)}\\}$，例如，对所有 $i$ 设 $f_i^{(0)} = 0$。\n2. 在第 $k+1$ 次迭代中，使用当前的自由能 $f_i^{(k)}$ 计算态密度 $g^{(k+1)}(U_m)$ 的新估计值：\n$$ g^{(k+1)}(U_m) = \\frac{1}{\\Delta U} \\frac{\\sum_{i=1}^K H_i(U_m)}{\\sum_{i=1}^K N_i \\exp(-\\beta[U_m + w_i(U_m) - f_i^{(k)}])} $$\n3. 使用新的态密度 $g^{(k+1)}(U_m)$ 计算新的自由能 $f_i^{(k+1)}$：\n$$ f_i^{(k+1)} = -\\frac{1}{\\beta} \\ln \\left( \\Delta U \\sum_m g^{(k+1)}(U_m) \\exp(-\\beta[U_m + w_i(U_m)]) \\right) $$\n4. 重复步骤 2 和 3，直到 $\\{g(U_m)\\}$ 和 $\\{f_i\\}$ 的值收敛。由于存在固有的不确定性，$g(U_m)$ 的确定只相差一个乘法常数，而 $f_i$ 的值则相应地相差一个加法常数。这通常通过在迭代过程中将某个 $f_j$ 设置为一个固定值（例如 0）来解决。更新的最终表达式如下所示。", "answer": "$$ \\boxed{\\begin{pmatrix} g(U_m) = \\frac{\\sum_{k=1}^{K} H_k(U_m)}{\\Delta U \\sum_{k=1}^{K} N_k \\exp(-\\beta [U_m + w_k(U_m) - f_k])} \\\\ f_i = -\\frac{1}{\\beta} \\ln\\left( \\Delta U \\sum_{m} g(U_m) \\exp(-\\beta [U_m + w_i(U_m)]) \\right) \\end{pmatrix}} $$", "id": "2788182"}]}