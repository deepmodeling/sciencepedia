{
    "hands_on_practices": [
        {
            "introduction": "Understanding Bragg diffraction begins with the crystal itself. To describe the periodic arrangement of atoms that scatter X-rays, we use a system called Miller indices to label families of parallel planes. This practice  challenges you to work from the fundamental definition of Miller indices based on a plane's intercepts with the crystal axes. You will then derive the crucial formula for interplanar spacing, $d_{hkl}$, from the properties of the reciprocal lattice, reinforcing the deep connection between a crystal's real-space geometry and the reciprocal-space framework used to interpret diffraction data.",
            "id": "2924485",
            "problem": "A primitive orthorhombic crystal has lattice parameters $a = 4.20\\ \\text{\\AA}$, $b = 5.60\\ \\text{\\AA}$, and $c = 7.35\\ \\text{\\AA}$. Consider the family of equally spaced parallel lattice planes that cut the crystallographic axes at intercepts $x = 2a$, $y = -b$, and $z = \\frac{c}{3}$, measured from the conventional origin. Determine the Miller indices of this family of planes by starting from the definition of Miller indices as the reciprocals of the axis intercepts (expressed in units of $a$, $b$, and $c$), and then, using only first principles that relate lattice planes to the reciprocal lattice in an orthorhombic system, derive and compute the interplanar spacing for these planes. You may use widely accepted foundational relations between the direct and reciprocal lattices as your starting point, but do not assume any pre-memorized spacing formulas without derivation.\n\nExpress your final numerical answer as the interplanar spacing in $\\text{\\AA}$ and round your answer to $4$ significant figures. Report only the interplanar spacing as your final answer. Use the convention that a negative intercept produces an overbar on the corresponding Miller index. X-radiation (X-ray) diffraction considerations motivate the need for $d$ but are not directly required for the computation here.",
            "solution": "The problem as stated is well-posed, internally consistent, and scientifically sound. It presents a standard exercise in solid-state crystallography which can be solved through rigorous application of fundamental principles. We will proceed with the solution in two main parts: first, the determination of the Miller indices for the specified family of lattice planes, and second, the derivation and calculation of the corresponding interplanar spacing.\n\nThe Miller indices $(h, k, l)$ of a family of parallel lattice planes are defined as a set of three integers determined from the intercepts of a plane in the family with the crystallographic axes. The procedure is as follows:\n1.  Find the intercepts of the plane with the axes in terms of the lattice parameters $a$, $b$, and $c$.\n2.  Take the reciprocals of these numbers.\n3.  Clear any fractions to obtain the smallest set of integers having the same ratio.\n\nThe problem states that a plane in the family has intercepts at $x=2a$, $y=-b$, and $z=\\frac{c}{3}$.\nStep 1: The intercepts, expressed as multiples of the respective lattice parameters, are $2$, $-1$, and $\\frac{1}{3}$.\n\nStep 2: We take the reciprocals of these values:\n$$\n\\frac{1}{2}, \\quad \\frac{1}{-1}, \\quad \\frac{1}{1/3}\n$$\nwhich gives the set of numbers:\n$$\n\\frac{1}{2}, \\quad -1, \\quad 3\n$$\n\nStep 3: To obtain the smallest set of integers, we multiply each number by the least common multiple of their denominators, which is $2$:\n$$\nh = \\frac{1}{2} \\times 2 = 1\n$$\n$$\nk = -1 \\times 2 = -2\n$$\n$$\nl = 3 \\times 2 = 6\n$$\nBy convention, a negative index is written with a bar over the number. Therefore, the Miller indices for this family of planes are $(hkl) = (1\\bar{2}6)$.\n\nNext, we must derive the formula for the interplanar spacing, $d_{hkl}$, for a primitive orthorhombic crystal system. We begin from the foundational relationship between the direct lattice and the reciprocal lattice.\n\nFor a crystal lattice defined by primitive vectors $\\mathbf{a}$, $\\mathbf{b}$, and $\\mathbf{c}$, the corresponding reciprocal lattice is defined by primitive vectors $\\mathbf{a}^*$, $\\mathbf{b}^*$, and $\\mathbf{c}^*$. A vector in the reciprocal lattice can be written as $\\mathbf{G}_{hkl} = h\\mathbf{a}^* + k\\mathbf{b}^* + l\\mathbf{c}^*$, where $h$, $k$, and $l$ are integers. This vector $\\mathbf{G}_{hkl}$ is, by definition, normal to the family of lattice planes with Miller indices $(hkl)$. The interplanar spacing $d_{hkl}$ is related to the magnitude of this vector by the fundamental relation:\n$$\nd_{hkl} = \\frac{1}{|\\mathbf{G}_{hkl}|}\n$$\nNote: The factor of $2\\pi$ is omitted here as is conventional in crystallographic, rather than solid-state physics, contexts. This is consistent with the definition of reciprocal vectors used below.\n\nFor a primitive orthorhombic lattice, the direct lattice vectors are mutually orthogonal: $\\mathbf{a} \\cdot \\mathbf{b} = \\mathbf{b} \\cdot \\mathbf{c} = \\mathbf{c} \\cdot \\mathbf{a} = 0$. We can align them with a Cartesian coordinate system: $\\mathbf{a} = a\\hat{\\mathbf{x}}$, $\\mathbf{b} = b\\hat{\\mathbf{y}}$, and $\\mathbf{c} = c\\hat{\\mathbf{z}}$, where $a$, $b$, and $c$ are the lattice parameters.\n\nThe reciprocal lattice vectors are defined as $\\mathbf{a}^* = \\frac{\\mathbf{b} \\times \\mathbf{c}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$, $\\mathbf{b}^* = \\frac{\\mathbf{c} \\times \\mathbf{a}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$, and $\\mathbf{c}^* = \\frac{\\mathbf{a} \\times \\mathbf{b}}{\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})}$. For the orthorhombic system, the volume of the unit cell is $V = \\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c}) = (a\\hat{\\mathbf{x}}) \\cdot (b\\hat{\\mathbf{y}} \\times c\\hat{\\mathbf{z}}) = abc$. The cross products are $\\mathbf{b} \\times \\mathbf{c} = bc\\hat{\\mathbf{x}}$, $\\mathbf{c} \\times \\mathbf{a} = ca\\hat{\\mathbf{y}}$, and $\\mathbf{a} \\times \\mathbf{b} = ab\\hat{\\mathbf{z}}$.\nSubstituting these into the definitions gives:\n$$\n\\mathbf{a}^* = \\frac{bc\\hat{\\mathbf{x}}}{abc} = \\frac{1}{a}\\hat{\\mathbf{x}}\n$$\n$$\n\\mathbf{b}^* = \\frac{ca\\hat{\\mathbf{y}}}{abc} = \\frac{1}{b}\\hat{\\mathbf{y}}\n$$\n$$\n\\mathbf{c}^* = \\frac{ab\\hat{\\mathbf{z}}}{abc} = \\frac{1}{c}\\hat{\\mathbf{z}}\n$$\nThe reciprocal lattice vectors for an orthorhombic system are also orthogonal, and their magnitudes are the reciprocals of the direct lattice parameters.\n\nThe reciprocal lattice vector $\\mathbf{G}_{hkl}$ for the $(hkl)$ planes is therefore:\n$$\n\\mathbf{G}_{hkl} = h \\left(\\frac{1}{a}\\hat{\\mathbf{x}}\\right) + k \\left(\\frac{1}{b}\\hat{\\mathbf{y}}\\right) + l \\left(\\frac{1}{c}\\hat{\\mathbf{z}}\\right) = \\frac{h}{a}\\hat{\\mathbf{x}} + \\frac{k}{b}\\hat{\\mathbf{y}} + \\frac{l}{c}\\hat{\\mathbf{z}}\n$$\nThe magnitude of this vector, $|\\mathbf{G}_{hkl}|$, is found using the Pythagorean theorem in three dimensions due to the orthogonality of the basis vectors:\n$$\n|\\mathbf{G}_{hkl}| = \\sqrt{\\left(\\frac{h}{a}\\right)^2 + \\left(\\frac{k}{b}\\right)^2 + \\left(\\frac{l}{c}\\right)^2}\n$$\nSubstituting this into the expression for the interplanar spacing $d_{hkl} = 1/|\\mathbf{G}_{hkl}|$, we arrive at the required formula for an orthorhombic system, derived from first principles:\n$$\nd_{hkl} = \\frac{1}{\\sqrt{\\frac{h^2}{a^2} + \\frac{k^2}{b^2} + \\frac{l^2}{c^2}}}\n$$\nThis derivation fulfills the requirements of the problem.\n\nWe now compute the numerical value for the interplanar spacing of the $(1\\bar{2}6)$ planes. The given lattice parameters are $a = 4.20\\ \\text{\\AA}$, $b = 5.60\\ \\text{\\AA}$, and $c = 7.35\\ \\text{\\AA}$. The Miller indices are $(h, k, l) = (1, -2, 6)$.\nPlugging these values into the derived formula:\n$$\nd_{1\\bar{2}6} = \\frac{1}{\\sqrt{\\frac{1^2}{(4.20\\ \\text{\\AA})^2} + \\frac{(-2)^2}{(5.60\\ \\text{\\AA})^2} + \\frac{6^2}{(7.35\\ \\text{\\AA})^2}}}\n$$\n$$\nd_{1\\bar{2}6} = \\frac{1}{\\sqrt{\\frac{1}{17.64} + \\frac{4}{31.36} + \\frac{36}{54.0225}}} \\ \\text{\\AA}\n$$\nNow we compute the terms in the denominator:\n$$\n\\frac{h^2}{a^2} = \\frac{1}{17.64} \\approx 0.0566916\\ \\text{\\AA}^{-2}\n$$\n$$\n\\frac{k^2}{b^2} = \\frac{4}{31.36} = \\frac{1}{7.84} \\approx 0.1275510\\ \\text{\\AA}^{-2}\n$$\n$$\n\\frac{l^2}{c^2} = \\frac{36}{54.0225} \\approx 0.6663847\\ \\text{\\AA}^{-2}\n$$\nThe sum of these terms is:\n$$\n\\frac{1}{d_{1\\bar{2}6}^2} \\approx 0.0566916 + 0.1275510 + 0.6663847 \\approx 0.8506273\\ \\text{\\AA}^{-2}\n$$\nTaking the square root of this sum:\n$$\n\\frac{1}{d_{1\\bar{2}6}} \\approx \\sqrt{0.8506273} \\approx 0.9222946\\ \\text{\\AA}^{-1}\n$$\nFinally, the interplanar spacing $d_{1\\bar{2}6}$ is the reciprocal of this value:\n$$\nd_{1\\bar{2}6} \\approx \\frac{1}{0.9222946} \\approx 1.0842503\\ \\text{\\AA}\n$$\nRounding the result to $4$ significant figures as requested, we obtain the final answer.",
            "answer": "$$ \\boxed{1.084} $$"
        },
        {
            "introduction": "With a method to define interplanar spacing $d$, we can now establish the conditions under which diffraction occurs. This exercise  guides you to derive Bragg's Law from the first principle of constructive wave interference, revealing how the path-length difference for X-rays scattering from adjacent planes leads to the famous equation $2d\\sin\\theta=n\\lambda$. By applying this law to calculate a diffraction angle and determine the maximum possible diffraction order, you will develop an intuitive understanding of the physical and geometric constraints that govern every X-ray diffraction experiment.",
            "id": "2924499",
            "problem": "A monochromatic X-ray beam of wavelength $\\lambda$ impinges on a crystal that presents a family of parallel lattice planes with interplanar spacing $d$. Under elastic scattering and the kinematic (single-scattering) approximation, constructive interference arises from a definite path-difference condition between rays reflected from adjacent planes.\n\nGiven $\\lambda = 0.15418$ nm and $d = 0.2000$ nm:\n\n1. Using only the path-difference and phase-alignment condition for constructive interference from equally spaced reflecting planes, derive the relation that links the incidence angle relative to the planes (the Bragg angle $\\theta$), the spacing $d$, the wavelength $\\lambda$, and an integer order $n$. Use this relation to compute the first-order angle $\\theta_{1}$ in degrees. Round your value of $\\theta_{1}$ to four significant figures.\n\n2. Using only the geometric constraint implied by your relation and the bound on the sine function, determine the largest integer diffraction order $n_{\\max}$ that can be satisfied for these $\\lambda$ and $d$.\n\nExpress all angles in degrees. Provide $n_{\\max}$ as your final answer (a pure number, no units).",
            "solution": "The problem presented is a standard exercise in X-ray crystallography and is scientifically sound, well-posed, objective, and self-contained. All necessary data are provided, and the questions are unambiguous. The problem is therefore valid, and a solution will be provided.\n\nThe problem requires a two-part analysis based on the principles of Bragg diffraction.\n\nPart 1: Derivation of the Bragg Condition and Calculation of the First-Order Angle\n\nConstructive interference for waves scattered from a periodic structure occurs when the path-length difference between waves scattered from adjacent repeating units is an integer multiple of the wavelength. In the context of a crystal, these repeating units are the parallel lattice planes.\n\nConsider two parallel X-rays incident upon two adjacent lattice planes separated by an interplanar spacing $d$. Let the angle of incidence and reflection with respect to the plane be the Bragg angle, $\\theta$. The second ray, which interacts with the lower plane, travels a longer path than the first ray, which interacts with the upper plane. The path-length difference, $\\Delta L$, is composed of two segments: an additional distance traveled by the second ray to reach the lower plane, and an additional distance it travels after reflection to reach a common wavefront with the first ray.\n\nBy simple geometric construction, it can be shown that each of these two segments has a length of $d \\sin(\\theta)$. The total path-length difference is the sum of these two segments.\n$$\n\\Delta L = d \\sin(\\theta) + d \\sin(\\theta) = 2d \\sin(\\theta)\n$$\nFor constructive interference, this path-length difference must be an integer multiple of the wavelength, $\\lambda$. This condition is expressed as:\n$$\n\\Delta L = n\\lambda\n$$\nwhere $n$ is a positive integer ($n = 1, 2, 3, \\ldots$) known as the order of the diffraction. Combining these two expressions yields the Bragg's law:\n$$\n2d \\sin(\\theta) = n\\lambda\n$$\nThis is the required relation linking $\\theta$, $d$, $\\lambda$, and $n$.\n\nWe are asked to compute the first-order angle, $\\theta_{1}$, which corresponds to $n=1$. The given values are $\\lambda = 0.15418 \\, \\text{nm}$ and $d = 0.2000 \\, \\text{nm}$.\nFor $n=1$, the equation becomes:\n$$\n2d \\sin(\\theta_{1}) = 1 \\cdot \\lambda\n$$\nSolving for $\\sin(\\theta_{1})$:\n$$\n\\sin(\\theta_{1}) = \\frac{\\lambda}{2d}\n$$\nSubstituting the numerical values:\n$$\n\\sin(\\theta_{1}) = \\frac{0.15418}{2 \\times 0.2000} = \\frac{0.15418}{0.4000} = 0.38545\n$$\nTo find the angle $\\theta_{1}$, we compute the arcsine of this value:\n$$\n\\theta_{1} = \\arcsin(0.38545)\n$$\nThe calculation yields $\\theta_{1} \\approx 22.6738^\\circ$. The problem requires the result to be rounded to four significant figures.\n$$\n\\theta_{1} \\approx 22.67^\\circ\n$$\n\nPart 2: Determination of the Maximum Diffraction Order\n\nThe Bragg relation, $2d \\sin(\\theta) = n\\lambda$, can be rearranged to solve for $\\sin(\\theta)$:\n$$\n\\sin(\\theta) = \\frac{n\\lambda}{2d}\n$$\nThe sine function, for a physical angle $\\theta$ (where $0^\\circ \\le \\theta \\le 90^\\circ$), is bounded by $0 \\le \\sin(\\theta) \\le 1$. Therefore, a physically real solution for $\\theta$ can only exist if:\n$$\n\\frac{n\\lambda}{2d} \\le 1\n$$\nThis inequality places a constraint on the possible integer values of the diffraction order $n$. We can solve for $n$:\n$$\nn \\le \\frac{2d}{\\lambda}\n$$\nSince $n$ must be a positive integer, the maximum possible order, $n_{\\max}$, is the largest integer that satisfies this condition. This is equivalent to taking the floor of the expression on the right-hand side.\n$$\nn_{\\max} = \\left\\lfloor \\frac{2d}{\\lambda} \\right\\rfloor\n$$\nSubstituting the given values for $d$ and $\\lambda$:\n$$\nn_{\\max} = \\left\\lfloor \\frac{2 \\times 0.2000}{0.15418} \\right\\rfloor = \\left\\lfloor \\frac{0.4000}{0.15418} \\right\\rfloor\n$$\nCalculating the value of the fraction:\n$$\n\\frac{0.4000}{0.15418} \\approx 2.59437\n$$\nThe floor of this value is:\n$$\nn_{\\max} = \\lfloor 2.59437 \\rfloor = 2\n$$\nThus, the largest integer diffraction order that can be observed for this crystal with this X-ray wavelength is $2$. Orders $n=1$ and $n=2$ are physically possible, but $n=3$ and higher are not. The problem asks for the value of $n_{\\max}$ as the final answer.",
            "answer": "$$\n\\boxed{2}\n$$"
        },
        {
            "introduction": "The true power of Bragg diffraction is revealed when we use it to analyze complex, real-world materials, which are often mixtures of multiple crystalline phases. This advanced practice  moves beyond single peak analysis to full-profile fitting, a cornerstone of modern quantitative X-ray analysis. You will develop a computational model to synthesize and then deconstruct a powder diffraction pattern from a two-phase mixture, learning how to resolve overlapping peaks and extract precise phase fractions by framing the problem as a linear least-squares fit. This exercise provides direct, hands-on experience with the principles that underpin the automated analysis software used in materials science labs worldwide.",
            "id": "2924475",
            "problem": "You are given two candidate crystalline phases whose powder X-ray diffraction patterns have several Bragg peak positions that are close to each other. The aim is to implement a full-profile fitting approach to discriminate and quantify the phase fractions from a simulated measured pattern that includes background and noise. Use fundamental principles, starting from Bragg’s law and a physically motivated peak profile, and formulate the profile fitting as a constrained parameter estimation problem over a discretized two-theta axis.\n\nFundamental base:\n- Bragg’s law: for first-order diffraction, $2 d \\sin \\theta = \\lambda$, relating interplanar spacing $d$, incident radiation wavelength $\\lambda$, and Bragg angle $\\theta$.\n- Peak profile: assume a Gaussian peak shape for each Bragg reflection. If the full-width at half-maximum (FWHM) is $w$ (in degrees), then the standard deviation is $\\sigma = \\dfrac{w}{2 \\sqrt{2 \\ln 2}}$, and the Gaussian for a peak centered at $2\\theta_0$ evaluated at $2\\theta$ is $\\exp\\!\\left(-\\dfrac{(2\\theta - 2\\theta_0)^2}{2 \\sigma^2}\\right)$.\n- Linear superposition: the measured intensity is the sum of phase contributions and a smooth background.\n\nConstruct the following model. Let the two phases be denoted by $\\mathrm{P}$ and $\\mathrm{Q}$. For each phase, you are given a small list of interplanar spacings $d_{h}$ and relative peak intensities $I_{h}$, where $h$ indexes the reflections in that phase. For a given wavelength $\\lambda$, compute the corresponding peak centroids $2\\theta_{h}$ using Bragg’s law with $n = 1$, that is, $\\theta_{h} = \\arcsin\\!\\left(\\dfrac{\\lambda}{2 d_{h}}\\right)$ and $2\\theta_{h} = 2 \\theta_{h}$, expressed in degrees. For a chosen FWHM $w$ (in degrees), define the phase template on a common $2\\theta$ grid $\\{x_i\\}_{i=1}^{N}$ as\n$$\nT_{\\mathrm{phase}}(x_i; w) = \\sum_{h} I_{h} \\exp\\!\\left(-\\dfrac{(x_i - 2\\theta_{h})^2}{2 \\sigma^2}\\right),\n$$\nwith $\\sigma = \\dfrac{w}{2 \\sqrt{2 \\ln 2}}$. The full-profile intensity model at grid point $x_i$ is\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 + b_1 \\,(x_i - x_0),\n$$\nwhere $s_{\\mathrm{P}}$ and $s_{\\mathrm{Q}}$ are nonnegative scale factors for phases $\\mathrm{P}$ and $\\mathrm{Q}$, $b_0$ and $b_1$ specify a linear background, and $x_0$ is a fixed reference angle within the grid for numerical stability.\n\nYour task is to:\n1. Simulate measured data $y_{\\text{meas}}(x_i)$ by evaluating $y_{\\text{model}}(x_i)$ at the specified parameters and adding independent Gaussian noise with given standard deviation.\n2. Build a full-profile fitting procedure that, given $y_{\\text{meas}}(x_i)$, the templates $T_{\\mathrm{P}}(x_i; w)$ and $T_{\\mathrm{Q}}(x_i; w)$ constructed using Bragg’s law and Gaussian peak shapes, and linear background basis functions, estimates the nonnegative scale factors $s_{\\mathrm{P}}$ and $s_{\\mathrm{Q}}$ together with background parameters. Formulate this as a nonnegative, linear least-squares problem for the unknown coefficients, ensuring nonnegativity for the phase scale factors and a background that can represent both positive and negative slopes (for example, by representing the slope as a difference of two nonnegative components). Do not use any peak-by-peak integration; use the entire profile at once.\n3. From the fitted nonnegative scale factors $\\hat{s}_{\\mathrm{P}}$ and $\\hat{s}_{\\mathrm{Q}}$, compute the estimated phase fractions\n$$\n\\hat{f}_{\\mathrm{P}} = \\dfrac{\\hat{s}_{\\mathrm{P}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}, \\quad\n\\hat{f}_{\\mathrm{Q}} = \\dfrac{\\hat{s}_{\\mathrm{Q}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}},\n$$\nwith the convention that if $\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}} = 0$, return $\\hat{f}_{\\mathrm{P}} = 0$ and $\\hat{f}_{\\mathrm{Q}} = 0$. Express the final fractions as decimals, not percentages.\n\nAngle unit and wavelength:\n- Use $2\\theta$ in degrees throughout.\n- Use $\\lambda = 1.5406\\,\\text{\\AA}$ (Copper K-alpha radiation).\n- Use a grid from $x_{\\min} = 20^\\circ$ to $x_{\\max} = 80^\\circ$ with uniform step $\\Delta x = 0.02^\\circ$. Choose $x_0 = 20^\\circ$.\n\nPhase reference data:\n- Phase $\\mathrm{P}$: $d$-spacings in angstroms and relative intensities\n  - $\\{d_h\\}_{\\mathrm{P}} = [3.000,\\, 2.572,\\, 2.090,\\, 1.606,\\, 1.380]$\n  - $\\{I_h\\}_{\\mathrm{P}} = [100,\\, 60,\\, 40,\\, 25,\\, 20]$\n- Phase $\\mathrm{Q}$: $d$-spacings in angstroms and relative intensities\n  - $\\{d_h\\}_{\\mathrm{Q}} = [2.950,\\, 2.530,\\, 2.060,\\, 1.590,\\, 1.360]$\n  - $\\{I_h\\}_{\\mathrm{Q}} = [90,\\, 65,\\, 35,\\, 30,\\, 25]$\n\nSimulation of measured data:\n- For each test, generate $y_{\\text{meas}}(x_i) = y_{\\text{model}}(x_i) + \\epsilon_i$ with independent noise $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$, where $\\sigma_{\\text{noise}}$ is specified as a fraction of the maximum of the noiseless modeled intensity for that test. Use a fixed random seed per test for reproducibility.\n\nTest suite:\n- Common settings: $\\lambda = 1.5406\\,\\text{\\AA}$, grid $x \\in [20^\\circ, 80^\\circ]$ with $\\Delta x = 0.02^\\circ$, reference angle $x_0 = 20^\\circ$.\n- Each test case is a tuple $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$ where:\n  1. Test A: $(0.7,\\, 0.3,\\, 0.25^\\circ,\\, 50,\\, 0.5,\\, 0.02,\\, 1)$\n  2. Test B: $(0.5,\\, 0.5,\\, 0.20^\\circ,\\, 30,\\, 0.0,\\, 0.03,\\, 2)$\n  3. Test C: $(0.95,\\, 0.05,\\, 0.25^\\circ,\\, 20,\\, 1.0,\\, 0.01,\\, 3)$\n  4. Test D: $(1.0,\\, 0.0,\\, 0.30^\\circ,\\, 40,\\, -0.3,\\, 0.04,\\, 4)$\n  5. Test E: $(0.0,\\, 1.0,\\, 0.22^\\circ,\\, 25,\\, 0.2,\\, 0.02,\\, 5)$\n\nRequired output:\n- For each test, compute $(\\hat{f}_{\\mathrm{P}}, \\hat{f}_{\\mathrm{Q}})$ as described above.\n- Round each fraction to three decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is a two-element list for a test case in the same order as above. For example, an output with placeholder values would be formatted like:\n  \"[[0.700,0.300],[0.500,0.500],[0.950,0.050],[1.000,0.000],[0.000,1.000]]\".",
            "solution": "The user-provided problem is first subjected to a validation check.\n\n### Step 1: Extract Givens\nThe problem provides the following data, definitions, and conditions:\n- **Bragg's Law (First Order):** $2 d \\sin \\theta = \\lambda$, with $d$ being the interplanar spacing, $\\lambda$ the wavelength, and $\\theta$ the Bragg angle.\n- **Gaussian Peak Profile:** The intensity of a peak centered at $2\\theta_0$ and evaluated at $2\\theta$ is given by $I(2\\theta) = \\exp(-\\frac{(2\\theta - 2\\theta_0)^2}{2 \\sigma^2})$, where $\\sigma = \\frac{w}{2 \\sqrt{2 \\ln 2}}$ and $w$ is the full-width at half-maximum (FWHM) in degrees.\n- **Phase Template Function:** For a given phase, its diffraction pattern template on a grid $\\{x_i\\}$ is $T_{\\mathrm{phase}}(x_i; w) = \\sum_{h} I_{h} \\exp(-\\frac{(x_i - 2\\theta_{h})^2}{2 \\sigma^2})$, where $h$ indexes the reflections of that phase, $I_h$ are relative intensities, and $2\\theta_h$ are the peak positions calculated from $d_h$ using Bragg's law.\n- **Full Intensity Model:** The total modeled intensity is a linear superposition of phase templates and a background: $y_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 + b_1 \\,(x_i - x_0)$.\n- **Measurement Simulation:** Measured data is generated as $y_{\\text{meas}}(x_i) = y_{\\text{model}}(x_i) + \\epsilon_i$, where $\\epsilon_i$ is independent Gaussian noise $\\epsilon_i \\sim \\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$. $\\sigma_{\\text{noise}}$ is a specified fraction of the maximum of the noiseless $y_{\\text{model}}(x_i)$.\n- **Parameter Estimation:** The task is to estimate nonnegative scale factors $s_{\\mathrm{P}}$ and $s_{\\mathrm{Q}}$, and background parameters $b_0$ and $b_1$, by solving a nonnegative linear least-squares problem.\n- **Phase Fraction Calculation:** Estimated fractions are $\\hat{f}_{\\mathrm{P}} = \\frac{\\hat{s}_{\\mathrm{P}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}$ and $\\hat{f}_{\\mathrm{Q}} = \\frac{\\hat{s}_{\\mathrm{Q}}}{\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}}$. If $\\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}} = 0$, both fractions are $0$.\n- **Constants and Grid:**\n    - Wavelength: $\\lambda = 1.5406\\,\\text{\\AA}$.\n    - $2\\theta$ Grid: $x \\in [20^\\circ, 80^\\circ]$ with step $\\Delta x = 0.02^\\circ$.\n    - Reference angle for background: $x_0 = 20^\\circ$.\n- **Phase Data (Phase P):**\n    - $d$-spacings $\\{d_h\\}_{\\mathrm{P}} = [3.000,\\, 2.572,\\, 2.090,\\, 1.606,\\, 1.380]\\,\\text{\\AA}$.\n    - Relative intensities $\\{I_h\\}_{\\mathrm{P}} = [100,\\, 60,\\, 40,\\, 25,\\, 20]$.\n- **Phase Data (Phase Q):**\n    - $d$-spacings $\\{d_h\\}_{\\mathrm{Q}} = [2.950,\\, 2.530,\\, 2.060,\\, 1.590,\\, 1.360]\\,\\text{\\AA}$.\n    - Relative intensities $\\{I_h\\}_{\\mathrm{Q}} = [90,\\, 65,\\, 35,\\, 30,\\, 25]$.\n- **Test Cases:** Five test cases are provided as tuples $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is evaluated against the validation criteria:\n- **Scientifically Grounded:** The problem is firmly based on the fundamental principles of X-ray diffraction and crystallography. Bragg's law, the concept of diffraction patterns as a sum of peaks, the use of Gaussian peak shapes, and linear superposition for mixtures are all standard and scientifically correct concepts. The provided physical constants ($\\lambda$) and structural parameters ($d$-spacings) are realistic.\n- **Well-Posed:** The problem is well-posed. It requires solving a parameter estimation problem, which is specifically formulated as a nonnegative linear least-squares (NNLS) problem. This is a convex optimization problem with a unique solution. All necessary data, functions, and constraints are explicitly defined, making the problem self-contained and unambiguous.\n- **Objective:** The problem is stated using precise, objective mathematical and physical language. There are no subjective elements, opinions, or ambiguities.\n\n### Step 3: Verdict and Action\nThe problem is scientifically sound, well-posed, objective, and contains all necessary information for a unique solution. Therefore, the problem is deemed **valid**. A solution will be developed.\n\n---\n\n### Solution\nThe objective is to determine the phase fractions of two crystalline phases, $\\mathrm{P}$ and $\\mathrm{Q}$, from a simulated mixed-phase X-ray diffraction pattern. This is accomplished through a full-profile fitting procedure, formulated as a nonnegative linear least-squares (NNLS) problem.\n\nThe model for the measured intensity $y_{\\text{model}}$ at each point $x_i$ on the $2\\theta$ grid is a linear combination of basis functions:\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}\\, T_{\\mathrm{P}}(x_i; w) + s_{\\mathrm{Q}}\\, T_{\\mathrm{Q}}(x_i; w) + b_0 \\cdot 1 + b_1 \\cdot (x_i - x_0)\n$$\nHere, $s_{\\mathrm{P}} \\ge 0$ and $s_{\\mathrm{Q}} \\ge 0$ are the scale factors for the phase templates $T_{\\mathrm{P}}$ and $T_{\\mathrm{Q}}$, and $b_0$ and $b_1$ are the coefficients for a linear background. The goal is to estimate the coefficient vector $\\mathbf{c} = [s_{\\mathrm{P}}, s_{\\mathrm{Q}}, b_0, b_1]^T$ by minimizing the squared error between the model and the simulated data, $\\|\\mathbf{y}_{\\text{model}} - \\mathbf{y}_{\\text{meas}}\\|_2^2$.\n\nTo formulate this as a pure NNLS problem where all coefficients must be nonnegative, we represent the unconstrained background parameters $b_0$ and $b_1$ as the difference of two nonnegative variables: $b_0 = b_{0,+} - b_{0,-}$ and $b_1 = b_{1,+} - b_{1,-}$, where $b_{0,+}, b_{0,-}, b_{1,+}, b_{1,-} \\ge 0$. The model becomes:\n$$\ny_{\\text{model}}(x_i) = s_{\\mathrm{P}}T_{\\mathrm{P}}(x_i) + s_{\\mathrm{Q}}T_{\\mathrm{Q}}(x_i) + b_{0,+} \\cdot 1 + b_{0,-} \\cdot (-1) + b_{1,+}(x_i - x_0) + b_{1,-} \\cdot (-(x_i - x_0))\n$$\nThis can be expressed in matrix form as $\\mathbf{y}_{\\text{model}} = \\mathbf{A}\\mathbf{c}'$, where $\\mathbf{y}$ is a vector of intensities over the grid, $\\mathbf{A}$ is the design matrix, and $\\mathbf{c}'$ is the new coefficient vector.\n\nThe coefficient vector to be estimated is $\\mathbf{c}' = [s_{\\mathrm{P}}, s_{\\mathrm{Q}}, b_{0,+}, b_{0,-}, b_{1,+}, b_{1,-}]^T$. Each component of $\\mathbf{c}'$ is constrained to be nonnegative.\n\nThe design matrix $\\mathbf{A}$ has dimensions $N \\times 6$, where $N$ is the number of points in the $2\\theta$ grid. Its columns are the basis functions evaluated at each grid point $x_i$:\n- Column $1$: Phase $\\mathrm{P}$ template, $\\mathbf{T}_{\\mathrm{P}}$\n- Column $2$: Phase $\\mathrm{Q}$ template, $\\mathbf{T}_{\\mathrm{Q}}$\n- Column $3$: Constant term for $b_{0,+}$, a vector of ones, $\\mathbf{1}$\n- Column $4$: Constant term for $b_{0,-}$, a vector of minus ones, $-\\mathbf{1}$\n- Column $5$: Linear term for $b_{1,+}$, the vector $(\\mathbf{x} - x_0)$\n- Column $6$: Linear term for $b_{1,-}$, the vector $-(\\mathbf{x} - x_0)$\n\nThe algorithmic procedure is as follows:\n\n1.  **Define Grid and Constants:** Establish the $2\\theta$ grid $\\mathbf{x}$ from $x_{\\min}=20^\\circ$ to $x_{\\max}=80^\\circ$ with step $\\Delta x=0.02^\\circ$. Define the fixed wavelength $\\lambda = 1.5406\\,\\text{\\AA}$ and reference angle $x_0 = 20^\\circ$.\n\n2.  **Process Each Test Case:** For each set of input parameters $(s_{\\mathrm{P}}, s_{\\mathrm{Q}}, w, b_0, b_1, \\text{noise\\_frac}, \\text{seed})$:\n    \n    a. **Generate Phase Templates:**\n       - For each phase ($\\mathrm{P}$ and $\\mathrm{Q}$), calculate the peak positions $2\\theta_h$ from the given $d_h$-spacings using Bragg's Law: $2\\theta_h = 2 \\arcsin(\\frac{\\lambda}{2d_h})$. The result from `arcsin` must be converted from radians to degrees.\n       - Calculate the standard deviation $\\sigma$ of the Gaussian peaks from the given FWHM $w$: $\\sigma = \\frac{w}{2\\sqrt{2\\ln 2}}$.\n       - Construct the template vectors $\\mathbf{T}_{\\mathrm{P}}$ and $\\mathbf{T}_{\\mathrm{Q}}$ by summing the Gaussian profiles for all reflections of each phase, evaluated on the grid $\\mathbf{x}$.\n\n    b. **Simulate Measured Data:**\n       - Construct the noiseless intensity profile $\\mathbf{y}_{\\text{model}} = s_{\\mathrm{P}}\\mathbf{T}_{\\mathrm{P}} + s_{\\mathrm{Q}}\\mathbf{T}_{\\mathrm{Q}} + b_0 + b_1(\\mathbf{x} - x_0)$.\n       - Calculate the noise standard deviation $\\sigma_{\\text{noise}} = \\text{noise\\_frac} \\times \\max(\\mathbf{y}_{\\text{model}})$.\n       - Using the specified seed for the random number generator, create a noise vector $\\boldsymbol{\\epsilon}$ where each element is drawn from $\\mathcal{N}(0, \\sigma_{\\text{noise}}^2)$.\n       - The final simulated data is $\\mathbf{y}_{\\text{meas}} = \\mathbf{y}_{\\text{model}} + \\boldsymbol{\\epsilon}$.\n\n    c. **Perform Nonnegative Least-Squares Fitting:**\n       - Assemble the $N \\times 6$ design matrix $\\mathbf{A}$ as described above.\n       - Solve the NNLS problem $\\min_{\\mathbf{c}' \\ge 0} \\|\\mathbf{A}\\mathbf{c}' - \\mathbf{y}_{\\text{meas}}\\|_2^2$ to obtain the estimated coefficient vector $\\hat{\\mathbf{c}}'$.\n\n    d. **Calculate Phase Fractions:**\n       - Extract the estimated scale factors for the phases from the solution vector: $\\hat{s}_{\\mathrm{P}} = \\hat{c}'_0$ and $\\hat{s}_{\\mathrm{Q}} = \\hat{c}'_1$.\n       - Compute the sum $S = \\hat{s}_{\\mathrm{P}} + \\hat{s}_{\\mathrm{Q}}$.\n       - If $S > 0$, calculate the fractions as $\\hat{f}_{\\mathrm{P}} = \\hat{s}_{\\mathrm{P}} / S$ and $\\hat{f}_{\\mathrm{Q}} = \\hat{s}_{\\mathrm{Q}} / S$.\n       - If $S = 0$, set $\\hat{f}_{\\mathrm{P}} = 0$ and $\\hat{f}_{\\mathrm{Q}} = 0$.\n       - The results are rounded to three decimal places.\n\nThis procedure is systematically applied to each test case to generate the final output. The use of `scipy.optimize.nnls` provides a robust solver for the core estimation step.",
            "answer": "```python\nimport numpy as np\nfrom scipy.optimize import nnls\n\ndef solve():\n    \"\"\"\n    Solves the full-profile fitting problem for all test cases.\n    \"\"\"\n    # Define physical constants and phase data\n    LAMBDA_VAL = 1.5406  # Wavelength in Angstroms\n    PHASE_P_DATA = {\n        'd_spacings': np.array([3.000, 2.572, 2.090, 1.606, 1.380]),\n        'intensities': np.array([100, 60, 40, 25, 20]),\n    }\n    PHASE_Q_DATA = {\n        'd_spacings': np.array([2.950, 2.530, 2.060, 1.590, 1.360]),\n        'intensities': np.array([90, 65, 35, 30, 25]),\n    }\n\n    # Define the 2-theta grid\n    X_MIN, X_MAX, X_STEP = 20.0, 80.0, 0.02\n    x_grid = np.arange(X_MIN, X_MAX + X_STEP / 2, X_STEP)\n    X0 = 20.0\n\n    # Define test cases\n    test_cases = [\n        # (s_P, s_Q, w, b0, b1, noise_frac, seed)\n        (0.7, 0.3, 0.25, 50, 0.5, 0.02, 1),\n        (0.5, 0.5, 0.20, 30, 0.0, 0.03, 2),\n        (0.95, 0.05, 0.25, 20, 1.0, 0.01, 3),\n        (1.0, 0.0, 0.30, 40, -0.3, 0.04, 4),\n        (0.0, 1.0, 0.22, 25, 0.2, 0.02, 5),\n    ]\n\n    def generate_template(phase_data, w, x_grid, lambda_val):\n        \"\"\"\n        Generates a phase template for a given FWHM.\n        \"\"\"\n        d_spacings = phase_data['d_spacings']\n        intensities = phase_data['intensities']\n        \n        # Check for valid d-spacings for the given wavelength\n        valid_indices = d_spacings > lambda_val / 2.0\n        if not np.all(valid_indices):\n            d_spacings = d_spacings[valid_indices]\n            intensities = intensities[valid_indices]\n        \n        # Calculate 2-theta peak positions in degrees\n        theta_rad = np.arcsin(lambda_val / (2 * d_spacings))\n        two_theta_deg = np.degrees(2 * theta_rad)\n        \n        # Calculate Gaussian standard deviation from FWHM\n        sigma = w / (2 * np.sqrt(2 * np.log(2)))\n        \n        template = np.zeros_like(x_grid)\n        for i in range(len(two_theta_deg)):\n            peak_pos = two_theta_deg[i]\n            rel_intensity = intensities[i]\n            gaussian = rel_intensity * np.exp(-((x_grid - peak_pos)**2) / (2 * sigma**2))\n            template += gaussian\n            \n        return template\n\n    results = []\n    for case in test_cases:\n        s_P, s_Q, w, b0, b1, noise_frac, seed = case\n\n        # 1. Generate phase templates for the current FWHM\n        T_P = generate_template(PHASE_P_DATA, w, x_grid, LAMBDA_VAL)\n        T_Q = generate_template(PHASE_Q_DATA, w, x_grid, LAMBDA_VAL)\n\n        # 2. Simulate measured data for the current test case\n        background = b0 + b1 * (x_grid - X0)\n        y_model = s_P * T_P + s_Q * T_Q + background\n        \n        sigma_noise = noise_frac * np.max(y_model)\n        \n        rng = np.random.default_rng(seed)\n        noise = rng.normal(0, sigma_noise, size=x_grid.shape)\n        y_meas = y_model + noise\n\n        # 3. Build the design matrix for Nonnegative Least Squares\n        # Columns for: s_P, s_Q, b0+, b0-, b1+, b1-\n        A = np.stack([\n            T_P,\n            T_Q,\n            np.ones_like(x_grid),\n            -np.ones_like(x_grid),\n            x_grid - X0,\n            -(x_grid - X0),\n        ], axis=1)\n\n        # 4. Solve the NNLS problem\n        coeffs, _ = nnls(A, y_meas)\n        s_P_hat, s_Q_hat = coeffs[0], coeffs[1]\n\n        # 5. Compute phase fractions\n        s_sum = s_P_hat + s_Q_hat\n        if s_sum > 0:\n            f_P_hat = s_P_hat / s_sum\n            f_Q_hat = s_Q_hat / s_sum\n        else:\n            f_P_hat, f_Q_hat = 0.0, 0.0\n            \n        results.append([round(f_P_hat, 3), round(f_Q_hat, 3)])\n\n    # Format the final output string exactly as required\n    formatted_results = [f\"[{res[0]:.3f},{res[1]:.3f}]\" for res in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}