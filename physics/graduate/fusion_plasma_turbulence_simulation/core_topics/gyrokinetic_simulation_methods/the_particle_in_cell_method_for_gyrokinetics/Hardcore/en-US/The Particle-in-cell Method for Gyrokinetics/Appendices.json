{
    "hands_on_practices": [
        {
            "introduction": "The gyroaverage is a cornerstone of gyrokinetics, averaging the electromagnetic fields experienced by a particle over its fast gyromotion. In practice, this integral is replaced by a discrete \"ring-sum\" quadrature. This exercise  offers a direct way to implement this crucial operator and test its accuracy against the exact analytical result, building intuition for the trade-off between computational cost and precision.",
            "id": "4205877",
            "problem": "Consider the Particle-In-Cell (PIC) method for gyrokinetics, where gyroaveraging of fields over fast gyromotion is required to correctly model the interaction between charged particles and electromagnetic fluctuations. The gyroaverage of a scalar field $\\phi$ at a guiding-center position $\\mathbf{R}$ with gyroradius $\\rho$ in the plane perpendicular to the background magnetic field is defined by the operator\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) \\equiv \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\nwhere $\\hat{\\mathbf{e}}_\\perp(\\theta)$ is the unit vector in the plane perpendicular to the background magnetic field rotated by angle $\\theta$. A ring-sum numerical scheme approximates this operator by uniformly sampling $N$ quadrature points around the ring:\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nIn the special case where $\\phi(\\mathbf{x})$ is a plane wave $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{x}\\big)$ with perpendicular wavenumber magnitude $k_\\perp = \\|\\mathbf{k}_\\perp\\|$, the exact scalar factor produced by gyroaveraging is known analytically and is the zeroth-order Bessel function of the first kind evaluated at the dimensionless argument $a \\equiv k_\\perp \\rho$, specifically $J_0(a)$. Therefore, for a plane wave field, resolving the gyroaverage reduces to resolving $J_0(k_\\perp \\rho)$.\n\nYour task is to implement the ring-sum gyroaverage scheme for the plane-wave case and to estimate the minimal number of quadrature points $N$ needed so that the absolute error between the ring-sum and the exact analytic value $J_0(k_\\perp \\rho)$ is less than or equal to a specified tolerance $\\varepsilon$:\n$$\n\\left| \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\theta_j\\big) - J_0(a) \\right| \\le \\varepsilon, \\quad a \\equiv k_\\perp \\rho, \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nThe scalar value to be resolved is $J_0(k_\\perp \\rho)$; there is no need to return the phase factor associated with $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{R}\\big)$.\n\nRequirements:\n- Implement a function that, given $a$ and $N$, computes the ring-sum approximation\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\tfrac{2\\pi j}{N}\\big),\n$$\nand its absolute error with respect to $J_0(a)$.\n- Implement a search procedure that, given $a$, tolerance $\\varepsilon$, and an upper bound $N_{\\max}$, returns the minimal integer $N \\in \\{1,2,\\dots,N_{\\max}\\}$ such that the above error criterion is satisfied. If no such $N$ exists up to $N_{\\max}$, return $-1$.\n- All physical parameters must be treated with consistent units. Use $k_\\perp$ in $\\mathrm{m}^{-1}$ and $\\rho$ in $\\mathrm{m}$, so that $a = k_\\perp \\rho$ is dimensionless.\n- Angles must be in radians.\n\nTest suite:\nFor each tuple $(k_\\perp, \\rho, \\varepsilon, N_{\\max})$, compute $a = k_\\perp \\rho$, then estimate the minimal $N$ satisfying the tolerance. Use the following cases:\n- Case $1$: $k_\\perp = 100$, $\\rho = 1.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-10}$, $N_{\\max} = 512$.\n- Case $2$: $k_\\perp = 1.0\\times 10^{4}$, $\\rho = 1.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-8}$, $N_{\\max} = 4096$.\n- Case $3$: $k_\\perp = 0$, $\\rho = 3.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-12}$, $N_{\\max} = 64$.\n- Case $4$: $k_\\perp = 300$, $\\rho = 5.0\\times 10^{-3}$, $\\varepsilon = 1.0\\times 10^{-12}$, $N_{\\max} = 2048$.\n- Case $5$ (edge case, large argument): $k_\\perp = 2.0\\times 10^{5}$, $\\rho = 2.5\\times 10^{-4}$, $\\varepsilon = 1.0\\times 10^{-6}$, $N_{\\max} = 4096$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list of integers enclosed in square brackets, ordered as specified above, for example, $[N_1,N_2,N_3,N_4,N_5]$. There must be no additional output text.",
            "solution": "The Particle-In-Cell (PIC) method for gyrokinetics replaces the rapid gyromotion around magnetic field lines with an averaged effect over the gyroangle. The guiding-center position $\\mathbf{R}$ evolves on a slower timescale while the gyrophase $\\theta$ is averaged out. The gyroaverage of a scalar field $\\phi$ at fixed $\\mathbf{R}$ and gyroradius $\\rho$ is defined by\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\nwhich is a consequence of averaging over uniform circular motion at angular frequency equal to the cyclotron frequency. In numerical PIC implementations, this integral is commonly approximated by a uniform quadrature on the ring, often referred to as a ring-sum:\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\nTo design and analyze the scheme from first principles, consider the fundamental test field for spectral analysis: a plane wave $\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{x})$. Writing $\\mathbf{k}$ as the sum of parallel and perpendicular components relative to the magnetic field, the dependence of the gyroaverage on the perpendicular component $\\mathbf{k}_\\perp$ isolates the essential behavior. Denote the perpendicular magnitude by $k_\\perp = \\|\\mathbf{k}_\\perp\\|$ and define a dimensionless parameter $a \\equiv k_\\perp \\rho$.\n\nSubstituting the plane wave into the continuous gyroaverage yields\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\Big(i\\,\\mathbf{k}\\cdot\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\Big)\\, d\\theta\n= \\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R}) \\cdot \\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta,\n$$\nwhere the identity $\\mathbf{k}_\\perp \\cdot \\hat{\\mathbf{e}}_\\perp(\\theta) = k_\\perp \\cos\\theta$ is used by aligning axes. The integral\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta\n$$\nevaluates to the zeroth-order Bessel function of the first kind $J_0(a)$, yielding the exact gyroaverage factor for a plane wave. Consequently, the continuous operator reduces to $J_0(a)$ for the scalar magnitude, with an overall phase $\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R})$ that is irrelevant for resolving the scalar factor.\n\nFor the ring-sum approximation with $N$ uniformly spaced angles $\\theta_j = 2\\pi j/N$, the discrete numerical approximation of the scalar factor is\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos\\theta_j\\big).\n$$\nTo understand its error relative to $J_0(a)$, one uses the Fourier series of the generating function (a fundamental identity derived from the Jacobi-Anger expansion):\n$$\n\\exp\\big(i\\,a\\,\\cos\\theta\\big) = \\sum_{m=-\\infty}^{\\infty} i^m J_m(a)\\, \\exp(i\\,m\\,\\theta),\n$$\nwhere $J_m$ is the $m$-th order Bessel function of the first kind. The continuous average over $\\theta$ eliminates all Fourier modes except $m=0$, recovering $J_0(a)$. The discrete sum over a uniform grid implements the trapezoidal rule on a periodic analytic function and exactly passes Fourier modes whose indices are integer multiples of $N$. Therefore,\n$$\nA_N(a) = \\sum_{q=-\\infty}^{\\infty} i^{qN} J_{qN}(a),\n$$\nand the error is the aliasing tail\n$$\nE_N(a) \\equiv A_N(a) - J_0(a) = \\sum_{q\\ne 0} i^{qN} J_{qN}(a).\n$$\nThis expression shows that the error is controlled by high-order Bessel functions $J_{qN}(a)$ at indices that are multiples of $N$. For fixed $a$, the magnitude of $J_n(a)$ decays rapidly with increasing $n$. A classical bound derived from the series definition of $J_n$ states\n$$\n|J_n(a)| \\le \\frac{(|a|/2)^n}{n!}, \\quad \\text{for all integers } n \\ge 0,\n$$\nwhich implies super-algebraic decay of aliasing terms with $N$. In practice, the dominant aliasing term is often $J_N(a)$, and ensuring that $|J_N(a)|$ is below the tolerance $\\varepsilon$ typically suffices to make the total error smaller than $\\varepsilon$.\n\nAlgorithmic design:\n- Compute the dimensionless argument $a = k_\\perp \\rho$ from input values in $\\mathrm{m}^{-1}$ and $\\mathrm{m}$, respectively.\n- For a given $N$, compute $A_N(a)$ by evaluating the uniform sum:\n$$\nA_N(a) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\left(i\\,a\\,\\cos\\left(\\frac{2\\pi j}{N}\\right)\\right).\n$$\n- Evaluate the exact analytic target $J_0(a)$ using a reliable special function implementation.\n- Compute the absolute error:\n$$\n\\mathrm{err}(N;a) \\equiv \\left| A_N(a) - J_0(a) \\right|.\n$$\n- To estimate the minimal $N$ satisfying $\\mathrm{err}(N;a) \\le \\varepsilon$ within an upper bound $N_{\\max}$, perform a search over $N \\in \\{1,2,\\dots,N_{\\max}\\}$ and select the smallest $N$ satisfying the criterion. If no such $N$ exists up to $N_{\\max}$, return $-1$.\n- Special case: when $a = 0$, we have $A_N(0) = 1$ for any $N$, and $J_0(0) = 1$, so the minimal $N$ is $1$ for any tolerance.\n\nThis procedure is principle-based: it starts from the definition of gyroaverage in gyrokinetics, applies it to a plane wave to derive the exact $J_0(a)$ dependence, and constructs the discrete ring-sum as a trapezoidal rule in the gyroangle. The Fourier analysis demonstrates why the ring-sum converges rapidly and provides a physics-informed justification for searching the minimal number of quadrature points required to achieve a specified tolerance. The test suite includes a variety of regimes: small $a$ (Case $1$), moderate $a$ (Case $4$), zero $a$ (Case $3$), and large $a$ with tight tolerance (Cases $2$ and $5$), covering typical and challenging scenarios relevant to fusion plasma turbulence simulation.\n\nThe final program must output a single line containing the integer results $[N_1,N_2,N_3,N_4,N_5]$ for the specified cases, with no additional text.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import special\n\ndef ring_sum(a: float, N: int) -> complex:\n    \"\"\"\n    Compute the ring-sum approximation A_N(a) = (1/N) sum_{j=0}^{N-1} exp(i a cos(2Ï€ j / N)).\n    \"\"\"\n    # Handle trivial case to avoid unnecessary computation\n    if N <= 0:\n        raise ValueError(\"N must be a positive integer.\")\n    if a == 0.0:\n        return 1.0 + 0.0j\n    j = np.arange(N, dtype=np.float64)\n    thetas = (2.0 * np.pi * j) / N\n    values = np.exp(1j * a * np.cos(thetas))\n    return np.mean(values)\n\ndef estimate_min_N(a: float, tol: float, N_max: int) -> int:\n    \"\"\"\n    Estimate the minimal N (1 <= N <= N_max) such that |A_N(a) - J0(a)| <= tol,\n    where A_N(a) is the ring-sum approximation. If not found, return -1.\n    \"\"\"\n    # Exact analytic target\n    J0 = special.j0(a)\n    # Special case: a == 0 => exact for any N, choose N=1\n    if a == 0.0:\n        return 1\n\n    # Linear search over N, ensuring minimality\n    for N in range(1, N_max + 1):\n        A_N = ring_sum(a, N)\n        err = abs(A_N - J0)\n        if err <= tol:\n            return N\n    return -1\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (k_perp [1/m], rho [m], tol, N_max)\n    test_cases = [\n        (100.0, 1.0e-3, 1.0e-10, 512),\n        (1.0e4, 1.0e-3, 1.0e-8, 4096),\n        (0.0, 3.0e-3, 1.0e-12, 64),\n        (300.0, 5.0e-3, 1.0e-12, 2048),\n        (2.0e5, 2.5e-4, 1.0e-6, 4096),\n    ]\n\n    results = []\n    for k_perp, rho, tol, N_max in test_cases:\n        a = k_perp * rho  # Dimensionless\n        N_min = estimate_min_N(a, tol, N_max)\n        results.append(N_min)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "A robust numerical simulation must do more than just implement equations; it must respect the fundamental conservation laws of the physical system it models. This practice  delves into the verification of a discrete energy conservation law within a gyrokinetic Particle-in-Cell framework. By implementing a numerical diagnostic to test this property, you will engage in a critical code verification task and understand how specific discretizations can be \"structure-preserving,\" ensuring the long-term stability and fidelity of a simulation.",
            "id": "4205831",
            "problem": "You are asked to design and implement a numerical diagnostic for energy conservation in a one-dimensional electrostatic gyrokinetic Particle-In-Cell (PIC) method in the long-wavelength limit. The goal is to compute the energy exchange between particles and fields over one timestep and verify that the net exchange matches the change in field energy, using a discretization that reflects the gyrokinetic polarization physics. Your program must produce results for a specified test suite and aggregate them into a single line of output.\n\nStart from the following fundamental base:\n\n- Electrostatics with quasineutrality and polarization in the long-wavelength gyrokinetic limit: the free charge density from particles, denoted by $\\rho_{\\mathrm{free}}(x,t)$, and the polarization charge density, denoted by $\\rho_{\\mathrm{pol}}(x,t)$, satisfy $\\rho_{\\mathrm{free}}(x,t) + \\rho_{\\mathrm{pol}}(x,t) = 0$.\n- The polarization charge density is modeled as $\\rho_{\\mathrm{pol}}(x,t) = -\\epsilon \\,\\partial_x^2 \\phi(x,t)$, where $\\phi(x,t)$ is the electrostatic potential and $\\epsilon$ is a constant representing the long-wavelength polarization coefficient $\\epsilon = n_0 m_i/B^2$ in normalized units.\n- The electrostatic field energy is $W_{\\mathrm{field}}(t) = \\dfrac{1}{2} \\int \\epsilon \\left(\\partial_x \\phi(x,t)\\right)^2 \\, dx$.\n- The energy exchange rate between particles and fields in this electrostatic gyrokinetic model follows from energy conservation: $\\dfrac{d}{dt} W_{\\mathrm{field}}(t) + \\int \\rho_{\\mathrm{free}}(x,t) \\,\\partial_t \\phi(x,t)\\, dx = 0$.\n\nDiscretize the domain, operators, and the time interval as follows:\n\n- Use a one-dimensional periodic domain of length $L$ with a uniform grid of $N$ points and spacing $\\Delta x = L/N$.\n- Represent fields on the grid at two successive times $t^n$ and $t^{n+1}$ by arrays $\\phi^n_i$ and $\\phi^{n+1}_i$ for $i = 0,1,\\dots,N-1$.\n- Use the forward difference for the spatial gradient:\n  $$\n  D_+ \\phi_i = \\frac{\\phi_{i+1} - \\phi_i}{\\Delta x},\n  $$\n  where the index arithmetic is periodic (e.g., $\\phi_N \\equiv \\phi_0$).\n- Use the backward difference for the divergence:\n  $$\n  D_- \\phi_i = \\frac{\\phi_i - \\phi_{i-1}}{\\Delta x}.\n  $$\n- Use the second-order centered Laplacian constructed as $D_- D_+$:\n  $$\n  \\partial_x^2 \\phi_i \\approx \\frac{\\phi_{i+1} - 2\\phi_i + \\phi_{i-1}}{\\Delta x^2}.\n  $$\n- Approximate spatial integrals as discrete sums with $\\int f(x)\\,dx \\approx \\sum_i f_i \\,\\Delta x$.\n- Approximate the time midpoint with the trapezoidal rule: define $\\phi^{\\mathrm{avg}}_i = \\dfrac{1}{2}(\\phi^n_i + \\phi^{n+1}_i)$ and $\\rho_{\\mathrm{free}}^{\\mathrm{avg}}_i = \\dfrac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i)$. Use quasineutrality to obtain the free charge from fields: $\\rho_{\\mathrm{free}}^n{}_i = \\epsilon \\,\\partial_x^2 \\phi^n_i$ and $\\rho_{\\mathrm{free}}^{n+1}{}_i = \\epsilon \\,\\partial_x^2 \\phi^{n+1}_i$.\n\nWith these definitions, compute over one timestep:\n\n- The particle-field energy exchange:\n  $$\n  Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x.\n  $$\n- The change in field energy:\n  $$\n  \\Delta W_{\\mathrm{field}} = W_{\\mathrm{field}}^{n+1} - W_{\\mathrm{field}}^{n} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x.\n  $$\n\nCompute the absolute mismatch\n$$\nM = \\left| Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}} \\right|\n$$\nfor each test case. In exact arithmetic with the specified discretization and periodic boundary conditions, $M$ should be extremely small due to a discrete integration-by-parts identity.\n\nUse normalized units throughout so no physical unit conversion is required. All angles must be in radians.\n\nImplement the following test suite. For each case, construct the grid $x_i = i\\,\\Delta x$ for $i=0,1,\\dots,N-1$, with $\\Delta x = L/N$, and define $\\phi^n_i$ and $\\phi^{n+1}_i$ explicitly as below.\n\n- Case 1 (smooth single mode, amplitude change):\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k = 2$, $A = 0.3$, $\\delta A = 0.01$.\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = (A + \\delta A)\\,\\sin(k x_i)$.\n- Case 2 (no change, exact zero):\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k = 4$, $A = 0.25$.\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = A \\,\\sin(k x_i)$.\n- Case 3 (two-mode combination with amplitude and phase changes):\n  - $N = 256$, $L = 2\\pi$, $\\epsilon = 0.5$.\n  - $k_1 = 3$, $k_2 = 5$, $A_1 = 0.2$, $A_2 = 0.1$, $A_1' = 0.205$, $A_2' = 0.095$, $\\delta\\varphi_1 = 0.02$, $\\delta\\varphi_2 = -0.015$.\n  - $\\phi^n_i = A_1 \\,\\sin(k_1 x_i) + A_2 \\,\\cos(k_2 x_i)$,\n    $\\phi^{n+1}_i = A_1' \\,\\sin(k_1 x_i + \\delta\\varphi_1) + A_2' \\,\\cos(k_2 x_i + \\delta\\varphi_2)$.\n- Case 4 (Nyquist mode, grid-scale oscillation):\n  - $N = 64$, $L = 2\\pi$, $\\epsilon = 1$.\n  - $k_{\\mathrm{nyq}} = N/2$ (integer), $A = 0.1$, $A' = 0.11$.\n  - $\\phi^n_i = A \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$, $\\phi^{n+1}_i = A' \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$.\n\nYour program should compute $M$ for each case and produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[m_1,m_2,m_3,m_4]$). The values should be real numbers (floats). Angles used in trigonometric functions must be in radians, and the grid must use periodic boundary conditions exactly as specified. No input is provided at runtime; all parameters of the test suite must be hardcoded in the program.",
            "solution": "The problem is subjected to validation.\n\n### Step 1: Extract Givens\n\n- **Physical Model**:\n    - Quasineutrality: $\\rho_{\\mathrm{free}}(x,t) + \\rho_{\\mathrm{pol}}(x,t) = 0$.\n    - Polarization charge density: $\\rho_{\\mathrm{pol}}(x,t) = -\\epsilon \\,\\partial_x^2 \\phi(x,t)$.\n    - From the above, free charge density is $\\rho_{\\mathrm{free}}(x,t) = \\epsilon \\,\\partial_x^2 \\phi(x,t)$.\n    - Electrostatic field energy: $W_{\\mathrm{field}}(t) = \\dfrac{1}{2} \\int \\epsilon \\left(\\partial_x \\phi(x,t)\\right)^2 \\, dx$.\n    - Energy conservation law: $\\dfrac{d}{dt} W_{\\mathrm{field}}(t) + \\int \\rho_{\\mathrm{free}}(x,t) \\,\\partial_t \\phi(x,t)\\, dx = 0$.\n\n- **Numerical Discretization**:\n    - Domain: 1D, periodic, length $L$, $N$ grid points, spacing $\\Delta x = L/N$.\n    - Fields at times $t^n$ and $t^{n+1}$: $\\phi^n_i, \\phi^{n+1}_i$ for $i \\in \\{0, 1, \\dots, N-1\\}$.\n    - Forward difference gradient: $D_+ \\phi_i = (\\phi_{i+1} - \\phi_i)/\\Delta x$.\n    - Backward difference divergence: $D_- \\phi_i = (\\phi_i - \\phi_{i-1})/\\Delta x$.\n    - Centered Laplacian: $\\partial_x^2 \\phi_i \\approx D_- D_+ \\phi_i = (\\phi_{i+1} - 2\\phi_i + \\phi_{i-1})/\\Delta x^2$.\n    - Spatial integration: $\\int f(x)\\,dx \\approx \\sum_i f_i \\,\\Delta x$.\n    - Time-centering: $\\phi^{\\mathrm{avg}}_i = \\frac{1}{2}(\\phi^n_i + \\phi^{n+1}_i)$, $\\rho_{\\mathrm{free}}^{\\mathrm{avg}}_i = \\frac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i)$, where $\\rho_{\\mathrm{free}}^k{}_i = \\epsilon (D_-D_+ \\phi^k_i)$.\n\n- **Quantities to Compute**:\n    - Particle-field energy exchange over one timestep: $Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x$.\n    - Change in field energy over one timestep: $\\Delta W_{\\mathrm{field}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x$.\n    - Absolute mismatch: $M = \\left| Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}} \\right|$.\n\n- **Test Suite**:\n    - **Case 1**: $N = 128$, $L = 2\\pi$, $\\epsilon = 1$, $k = 2$, $A = 0.3$, $\\delta A = 0.01$. $\\phi^n_i = A \\sin(k x_i)$, $\\phi^{n+1}_i = (A + \\delta A) \\sin(k x_i)$.\n    - **Case 2**: $N = 128$, $L = 2\\pi$, $\\epsilon = 1$, $k = 4$, $A = 0.25$. $\\phi^n_i = A \\sin(k x_i)$, $\\phi^{n+1}_i = A \\sin(k x_i)$.\n    - **Case 3**: $N = 256$, $L = 2\\pi$, $\\epsilon = 0.5$, $k_1 = 3$, $k_2 = 5$, $A_1 = 0.2$, $A_2 = 0.1$, $A_1' = 0.205$, $A_2' = 0.095$, $\\delta\\varphi_1 = 0.02$, $\\delta\\varphi_2 = -0.015$. $\\phi^n_i = A_1 \\sin(k_1 x_i) + A_2 \\cos(k_2 x_i)$, $\\phi^{n+1}_i = A_1' \\sin(k_1 x_i + \\delta\\varphi_1) + A_2' \\cos(k_2 x_i + \\delta\\varphi_2)$.\n    - **Case 4**: $N = 64$, $L = 2\\pi$, $\\epsilon = 1$, $k_{\\mathrm{nyq}} = N/2=32$, $A = 0.1$, $A' = 0.11$. $\\phi^n_i = A \\cos(k_{\\mathrm{nyq}} x_i)$, $\\phi^{n+1}_i = A' \\cos(k_{\\mathrm{nyq}} x_i)$.\n\n### Step 2: Validate Using Extracted Givens\n\nThe problem is scientifically grounded, well-posed, and objective.\n1.  **Scientific Soundness**: The problem describes a standard, albeit simplified, 1D electrostatic gyrokinetic model. The equations provided for quasineutrality, polarization, field energy, and energy conservation are correct representations of the long-wavelength limit of this model. The finite difference scheme is a standard method for discretizing differential operators.\n2.  **Formalizability**: The problem is expressed with precise mathematical definitions and algorithmic requirements, making it fully formalizable.\n3.  **Completeness**: All necessary parameters and functional forms for the test cases are explicitly provided. The definitions are self-contained.\n4.  **Realism**: The parameters define a numerical experiment and are physically plausible within the context of a simulation.\n5.  **Well-Posed Structure**: The problem asks for the computation of a specific numerical value, the mismatch $M$, which is uniquely determined by the provided inputs and formulas. The underlying premise that $M$ should be near zero for this specific discretization is a well-known property of energy-conserving numerical schemes.\n6.  **Non-Triviality**: The problem requires a careful implementation of discrete calculus and an understanding of how continuous conservation laws are translated to discrete systems. It is not trivial.\n7.  **Verifiability**: The result can be computationally verified by implementing the described algorithm.\n\n### Step 3: Verdict and Action\n\nThe problem statement is **valid**. A solution will be provided.\n\n---\n\nThe objective is to verify a discrete energy conservation law for a specific numerical scheme. The law states that the energy exchanged between particles and the electrostatic field, $Q_{\\mathrm{part}}$, should equal the change in the total energy stored in the field, $\\Delta W_{\\mathrm{field}}$, over a single time step. The problem provides discrete definitions for these quantities and we must show they are indeed equal, up to floating-point precision.\n\nThe two quantities to be compared are:\n1.  The energy exchange, $Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x$.\n2.  The change in field energy, $\\Delta W_{\\mathrm{field}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x$.\n\nWe will now demonstrate that the chosen discretization ensures $Q_{\\mathrm{part}} = \\Delta W_{\\mathrm{field}}$ algebraically.\n\nThe free charge is given by $\\rho_{\\mathrm{free}} = \\epsilon \\partial_x^2\\phi$. The time-averaged free charge density at grid point $i$ is discretized as:\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\frac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i) = \\frac{1}{2} \\epsilon (D_- D_+ \\phi^n_i + D_- D_+ \\phi^{n+1}_i)\n$$\nSince the operator $D_-D_+$ is linear, this is equivalent to:\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\epsilon D_- D_+ \\left( \\frac{\\phi^n_i + \\phi^{n+1}_i}{2} \\right) = \\epsilon D_- D_+ \\phi^{\\mathrm{avg}}_i\n$$\nSubstituting this into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = - \\sum_{i=0}^{N-1} \\epsilon (D_- D_+ \\phi^{\\mathrm{avg}}_i) (\\phi^{n+1}_i - \\phi^n_i) \\Delta x\n$$\nLet's denote the change in potential as $\\delta\\phi_i = \\phi^{n+1}_i - \\phi^{n}_i$.\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\sum_{i=0}^{N-1} (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\delta\\phi_i \\Delta x\n$$\nWe now apply the discrete summation-by-parts identity on a periodic grid, which states $\\sum_i a_i (D_- b_i) \\Delta x = - \\sum_i (D_+ a_i) b_i \\Delta x$. Let $a_i = \\delta\\phi_i$ and $b_i = D_+ \\phi^{\\mathrm{avg}}_i$. Applying the identity:\n$$\n\\sum_{i=0}^{N-1} \\delta\\phi_i (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\Delta x = - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\nSubstituting this back into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\left( - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x \\right) = \\epsilon \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\nNow, we expand the terms $\\delta\\phi_i$ and $\\phi^{\\mathrm{avg}}_i$:\n$$\nD_+ \\delta\\phi_i = D_+(\\phi^{n+1}_i - \\phi^n_i) = D_+\\phi^{n+1}_i - D_+\\phi^n_i\n$$\n$$\nD_+ \\phi^{\\mathrm{avg}}_i = D_+\\left(\\frac{\\phi^{n+1}_i + \\phi^n_i}{2}\\right) = \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i)\n$$\nSubstituting these into the expression for $Q_{\\mathrm{part}}$:\n$$\nQ_{\\mathrm{part}} = \\epsilon \\sum_{i=0}^{N-1} (D_+\\phi^{n+1}_i - D_+\\phi^n_i) \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i) \\Delta x\n$$\nUsing the algebraic identity $(a-b)(a+b) = a^2 - b^2$, the expression simplifies to:\n$$\nQ_{\\mathrm{part}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[ (D_+\\phi^{n+1}_i)^2 - (D_+\\phi^n_i)^2 \\right] \\Delta x\n$$\nThis expression is identical to the definition of $\\Delta W_{\\mathrm{field}}$. Thus, we have shown that with the specified discretizations, $Q_{\\mathrm{part}} = \\Delta W_{\\mathrm{field}}$. The calculated mismatch $M = |Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}}|$ should be zero, or a very small number attributable to floating-point arithmetic errors.\n\nThe computational procedure for each test case is as follows:\n1.  Define the grid parameters $N$, $L$, and the physical constant $\\epsilon$.\n2.  Construct the spatial grid $x_i = i \\Delta x$ for $i = 0, \\dots, N-1$, where $\\Delta x = L/N$.\n3.  Generate the potential arrays $\\phi^n$ and $\\phi^{n+1}$ according to the specified formulas for the test case.\n4.  Compute $Q_{\\mathrm{part}}$:\n    a. Calculate the time-averaged potential $\\phi^{\\mathrm{avg}} = (\\phi^n + \\phi^{n+1})/2$.\n    b. Compute the discrete Laplacian of $\\phi^{\\mathrm{avg}}$: $\\text{Lap}(\\phi^{\\mathrm{avg}})_i = (\\phi^{\\mathrm{avg}}_{i+1} - 2\\phi^{\\mathrm{avg}}_i + \\phi^{\\mathrm{avg}}_{i-1})/\\Delta x^2$, respecting periodic boundaries.\n    c. Compute the time-averaged free charge density $\\rho_{\\mathrm{free}}^{\\mathrm{avg}} = \\epsilon \\cdot \\text{Lap}(\\phi^{\\mathrm{avg}})$.\n    d. Compute the potential difference $\\delta\\phi = \\phi^{n+1} - \\phi^n$.\n    e. Calculate $Q_{\\mathrm{part}} = -\\text{sum}(\\rho_{\\mathrm{free}}^{\\mathrm{avg}} \\cdot \\delta\\phi) \\cdot \\Delta x$.\n5.  Compute $\\Delta W_{\\mathrm{field}}$:\n    a. Compute the discrete forward gradients $D_+\\phi^n$ and $D_+\\phi^{n+1}$. For an array $\\psi$, $(D_+\\psi)_i = (\\psi_{i+1}-\\psi_i)/\\Delta x$, respecting periodic boundaries.\n    b. Square these gradient arrays element-wise.\n    c. Compute $\\Delta W_{\\mathrm{field}} = (1/2)\\epsilon \\cdot \\text{sum}((D_+\\phi^{n+1})^2 - (D_+\\phi^n)^2) \\cdot \\Delta x$.\n6.  Calculate the mismatch $M = |Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}}|$.\n\nThis procedure is implemented for each of the four test cases. Case 2, where $\\phi^n = \\phi^{n+1}$, serves as a null test where both $Q_{\\mathrm{part}}$ and $\\Delta W_{\\mathrm{field}}$ should be identically zero. Case 4 tests the scheme's behavior for the highest-frequency mode resolvable on the grid (the Nyquist mode), where discrete operators can behave differently from their continuous counterparts. The identity is expected to hold in all cases.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the energy conservation mismatch for a 1D electrostatic gyrokinetic\n    PIC model using a specific finite-difference scheme.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"case_id\": 1,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 2.0, \"A\": 0.3, \"deltaA\": 0.01},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: (p[\"A\"] + p[\"deltaA\"]) * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 2,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 4.0, \"A\": 0.25},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 3,\n            \"N\": 256, \"L\": 2.0 * np.pi, \"epsilon\": 0.5,\n            \"params\": {\n                \"k1\": 3.0, \"k2\": 5.0, \"A1\": 0.2, \"A2\": 0.1,\n                \"A1_prime\": 0.205, \"A2_prime\": 0.095,\n                \"d_phi1\": 0.02, \"d_phi2\": -0.015\n            },\n            \"phi_n_func\": lambda x, p: p[\"A1\"] * np.sin(p[\"k1\"] * x) + p[\"A2\"] * np.cos(p[\"k2\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A1_prime\"] * np.sin(p[\"k1\"] * x + p[\"d_phi1\"]) + p[\"A2_prime\"] * np.cos(p[\"k2\"] * x + p[\"d_phi2\"])\n        },\n        {\n            \"case_id\": 4,\n            \"N\": 64, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k_nyq\": 32.0, \"A\": 0.1, \"A_prime\": 0.11},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.cos(p[\"k_nyq\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A_prime\"] * np.cos(p[\"k_nyq\"] * x)\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        N = case[\"N\"]\n        L = case[\"L\"]\n        epsilon = case[\"epsilon\"]\n        params = case[\"params\"]\n\n        dx = L / N\n        x = np.linspace(0.0, L, N, endpoint=False)\n\n        # Generate potential fields at times t^n and t^{n+1}\n        phi_n = case[\"phi_n_func\"](x, params)\n        phi_n1 = case[\"phi_n1_func\"](x, params)\n\n        # ---- Calculate Q_part ----\n        \n        # Calculate time-averaged free charge density, rho_free_avg\n        # rho_free_avg = epsilon * laplacian(phi_avg)\n        # where phi_avg = (phi_n + phi_n1) / 2\n        phi_avg = 0.5 * (phi_n + phi_n1)\n        \n        # Discrete Laplacian operator D_- D_+ using periodic boundaries\n        # np.roll(phi, -1) gives phi_{i+1}\n        # np.roll(phi, 1)  gives phi_{i-1}\n        laplacian_phi_avg = (np.roll(phi_avg, -1) - 2.0 * phi_avg + np.roll(phi_avg, 1)) / (dx**2)\n        \n        rho_free_avg = epsilon * laplacian_phi_avg\n        \n        # Calculate potential difference\n        delta_phi = phi_n1 - phi_n\n        \n        # Calculate energy exchange Q_part\n        Q_part = -np.sum(rho_free_avg * delta_phi) * dx\n\n        # ---- Calculate Delta_W_field ----\n        \n        # Discrete forward difference operator D_+ using periodic boundaries\n        d_plus_phi_n = (np.roll(phi_n, -1) - phi_n) / dx\n        d_plus_phi_n1 = (np.roll(phi_n1, -1) - phi_n1) / dx\n\n        # Calculate field energy at each time\n        W_field_n_sq_term = d_plus_phi_n**2\n        W_field_n1_sq_term = d_plus_phi_n1**2\n        \n        # Calculate change in field energy Delta_W_field\n        delta_W_field = 0.5 * epsilon * np.sum(W_field_n1_sq_term - W_field_n_sq_term) * dx\n\n        # ---- Calculate the mismatch M ----\n        mismatch = np.abs(Q_part - delta_W_field)\n        results.append(mismatch)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Particle-in-Cell simulations are inherently statistical, and their accuracy is fundamentally limited by numerical noise arising from the finite number of macro-particles. This exercise  guides you through the process of analytically deriving this noise floor for the electrostatic potential. Mastering this calculation is essential for practical simulation design, as it empowers you to determine the minimum number of particles, $N_{p}$, needed to resolve a physical signal above the noise, thereby optimizing the use of computational resources.",
            "id": "4205893",
            "problem": "Consider an electrostatic gyrokinetic simulation of a single ion species in a two-dimensional periodic domain of area $A$ with uniform mean ion gyrocenter density $n_{0}$ and adiabatic electrons. The particle-in-cell (PIC) method is used to represent the ion gyrocenter distribution with $N_{p}$ independent macro-particles of identical weight. Each macro-particle carries density weight $w$ and is deposited to the grid with a compact $r$th-order cardinal $B$-spline shape function on a uniform grid of spacing $\\Delta$. The Fourier transform of the $r$th-order shape function is\n$$\nS_{r}(\\mathbf{k}) \\;=\\; \\prod_{j=1}^{2} \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{j}\\Delta}{2}\\right)\\right]^{\\,r+1},\n$$\nwhere $\\mathrm{sinc}(x) = \\frac{\\sin(x)}{x}$ and $\\mathbf{k}=(k_{x},k_{y})$ is the perpendicular wavevector. The ion gyroaveraging at wavenumber magnitude $k_{\\perp}=\\sqrt{k_{x}^{2}+k_{y}^{2}}$ appears as the zeroth-order Bessel function $J_{0}(k_{\\perp}\\rho_{i})$, where $\\rho_{i}$ is the ion thermal Larmor radius. In the electrostatic gyrokinetic quasineutrality relation with adiabatic electrons,\n$$\n\\alpha(\\mathbf{k})\\,\\phi_{\\mathbf{k}} \\;=\\; q_{i}\\,J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)\\,\\delta n_{i,\\mathbf{k}},\n$$\nwith\n$$\n\\alpha(\\mathbf{k}) \\;=\\; \\frac{q_{e}^{2}n_{0e}}{T_{e}} \\;+\\; \\frac{q_{i}^{2}n_{0i}}{T_{i}}\\left[1-\\Gamma_{0}\\!\\left(b_{i}\\right)\\right],\n\\qquad\nb_{i}\\;=\\;k_{\\perp}^{2}\\rho_{i}^{2},\n\\qquad\n\\Gamma_{0}(b)\\;=\\;\\exp(-b)\\,I_{0}(b),\n$$\nand $q_{s}$, $n_{0s}$, $T_{s}$ the charge, mean density, and temperature of species $s$, $I_{0}$ the modified Bessel function of the first kind. Assume singly ionized ions so $q_{i}=e$, and charge neutrality $n_{0e}=n_{0i}=n_{0}$.\n\nThe macro-particles are uniformly and independently distributed over the domain, sampling the uniform equilibrium. The deposited ion gyrocenter density field has Fourier coefficients defined by the unit-area convention, $\\delta n_{i,\\mathbf{k}} = \\frac{1}{A}\\int \\delta n_{i}(\\mathbf{x})\\,\\exp\\!\\left(-i\\mathbf{k}\\cdot\\mathbf{x}\\right)\\,d^{2}x$. The macro-particle density weight $w$ is chosen such that the ensemble average of the deposited density equals $n_{0}$.\n\nStarting from fundamental definitions and the assumptions above, derive the root-mean-square spectral noise amplitude of the electrostatic potential at mode $\\mathbf{k}$, denoted $\\sigma_{\\phi}(\\mathbf{k};N_{p},r)$, as a function of $N_{p}$ and shape order $r$. Then, given a target mode amplitude $|\\phi_{\\mathbf{k}}|=\\Phi_{\\mathrm{t}}>0$ and a required signal-to-noise ratio $\\mathcal{R}>1$, determine the minimum number of macro-particles $N_{p}^{\\min}$ needed so that $\\Phi_{\\mathrm{t}}/\\sigma_{\\phi}(\\mathbf{k};N_{p},r)\\geq \\mathcal{R}$.\n\nExpress your final answers as closed-form analytic expressions in terms of $n_{0}$, $e$, $T_{e}$, $T_{i}$, $\\rho_{i}$, $\\mathbf{k}$, $\\Delta$, $r$, and $\\Phi_{\\mathrm{t}}$, using the definitions above. Do not introduce any additional parameters. No numerical evaluation is required. The final answers must be provided without units.",
            "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in the established theory of gyrokinetic simulations, well-posed with sufficient information for a unique solution, and phrased in objective, formal language. The physical and mathematical models presented, such as the particle-in-cell method, B-spline shape functions, and the gyrokinetic quasineutrality relation, are standard in computational plasma physics. There are no contradictions, ambiguities, or unsound premises.\n\nThe first objective is to derive the root-mean-square (RMS) spectral noise amplitude of the electrostatic potential, $\\sigma_{\\phi}(\\mathbf{k};N_{p},r)$. The macro-particles are distributed uniformly and independently to sample a uniform equilibrium density, $n_{0}$. For any non-zero wavevector $\\mathbf{k} \\neq \\mathbf{0}$, the ensemble average of a density perturbation is zero, i.e., $\\langle \\delta n_{i, \\mathbf{k}} \\rangle = 0$. Consequently, from the quasineutrality relation, the ensemble average of the potential fluctuation is also zero, $\\langle \\phi_{\\mathbf{k}} \\rangle = 0$. The RMS amplitude is therefore the standard deviation, which for a zero-mean process is given by $\\sigma_{\\phi}(\\mathbf{k}) = \\sqrt{\\langle |\\phi_{\\mathbf{k}}|^{2} \\rangle}$.\n\nFrom the given electrostatic gyrokinetic quasineutrality relation, we can express the potential fluctuation $\\phi_{\\mathbf{k}}$ in terms of the ion gyrocenter density fluctuation $\\delta n_{i, \\mathbf{k}}$:\n$$\n\\phi_{\\mathbf{k}} = \\frac{q_{i}\\,J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)}{\\alpha(\\mathbf{k})}\\,\\delta n_{i,\\mathbf{k}}\n$$\nThe variance of the potential is then:\n$$\n\\sigma_{\\phi}^{2}(\\mathbf{k}) = \\langle |\\phi_{\\mathbf{k}}|^{2} \\rangle = \\left| \\frac{q_{i}\\,J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)}{\\alpha(\\mathbf{k})} \\right|^{2} \\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle\n$$\nThe term $\\alpha(\\mathbf{k})$ is real under the given definitions, so the expression simplifies to:\n$$\n\\sigma_{\\phi}^{2}(\\mathbf{k}) = \\frac{q_{i}^{2}\\,J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right)}{\\alpha(\\mathbf{k})^{2}} \\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle\n$$\nThe core of the derivation is to compute the variance of the ion gyrocenter density fluctuation, $\\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle$. The deposited density field is constructed from $N_{p}$ macro-particles with positions $\\{\\mathbf{x}_{j}\\}_{j=1}^{N_p}$ and identical density weight $w$, using the shape function $S_{r}(\\mathbf{x})$ (the real-space function corresponding to the given Fourier transform $S_r(\\mathbf{k})$). The continuous density field is $n(\\mathbf{x}) = \\sum_{j=1}^{N_{p}} w S_{r}(\\mathbf{x} - \\mathbf{x}_{j})$.\n\nThe Fourier coefficient of this density field is defined as:\n$$\nn_{\\mathbf{k}} = \\frac{1}{A} \\int_{A} n(\\mathbf{x}) \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}) d^{2}x = \\frac{1}{A} \\int_{A} \\left( \\sum_{j=1}^{N_{p}} w S_{r}(\\mathbf{x} - \\mathbf{x}_{j}) \\right) \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}) d^{2}x\n$$\nUsing the convolution theorem, the Fourier transform of a sum of shifted functions is the sum of their individual Fourier transforms. The Fourier transform of $S_r(\\mathbf{x}-\\mathbf{x}_j)$ is $S_r(\\mathbf{k})\\exp(-i\\mathbf{k}\\cdot\\mathbf{x}_j)$. Thus, the Fourier coefficient becomes:\n$$\nn_{\\mathbf{k}} = \\frac{w}{A} S_{r}(\\mathbf{k}) \\sum_{j=1}^{N_{p}} \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}_{j})\n$$\nFor $\\mathbf{k} \\neq \\mathbf{0}$, this corresponds to the fluctuation $\\delta n_{i,\\mathbf{k}}$. Before calculating its variance, we determine the weight $w$. It is chosen such that the ensemble average of the deposited density is $n_{0}$.\n$$\n\\langle n(\\mathbf{x}) \\rangle = \\left\\langle \\sum_{j=1}^{N_{p}} w S_{r}(\\mathbf{x} - \\mathbf{x}_{j}) \\right\\rangle = w N_{p} \\langle S_{r}(\\mathbf{x} - \\mathbf{x}_{j}) \\rangle\n$$\nSince particles are uniformly distributed in area $A$, the probability density for a position $\\mathbf{x}_j$ is $1/A$.\n$$\n\\langle S_{r}(\\mathbf{x} - \\mathbf{x}_{j}) \\rangle = \\int_{A} S_{r}(\\mathbf{x} - \\mathbf{x}') \\frac{1}{A} d^{2}x' = \\frac{1}{A} \\int_{A} S_{r}(\\mathbf{y}) d^{2}y\n$$\nThe integral of the shape function over the domain is its Fourier transform at $\\mathbf{k}=\\mathbf{0}$, which is $S_r(\\mathbf{0})=1$. Thus, $\\langle S_{r}(\\mathbf{x} - \\mathbf{x}_{j}) \\rangle = 1/A$.\nThe mean density is $\\langle n(\\mathbf{x}) \\rangle = w N_{p} / A$. Equating this to $n_{0}$ gives the weight:\n$$\nw = \\frac{n_{0}A}{N_{p}}\n$$\nNow we compute the variance of $\\delta n_{i,\\mathbf{k}}$ for $\\mathbf{k} \\neq \\mathbf{0}$:\n$$\n\\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle = \\left\\langle \\left( \\frac{w}{A} S_{r}(\\mathbf{k}) \\sum_{j=1}^{N_{p}} e^{-i\\mathbf{k}\\cdot\\mathbf{x}_{j}} \\right) \\left( \\frac{w}{A} S_{r}^{*}(\\mathbf{k}) \\sum_{l=1}^{N_{p}} e^{i\\mathbf{k}\\cdot\\mathbf{x}_{l}} \\right) \\right\\rangle\n$$\nAs given, $S_{r}(\\mathbf{k})$ is real, so $S_{r}^{*}(\\mathbf{k}) = S_{r}(\\mathbf{k})$.\n$$\n\\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle = \\frac{w^{2}S_{r}^{2}(\\mathbf{k})}{A^{2}} \\left\\langle \\sum_{j,l=1}^{N_{p}} e^{-i\\mathbf{k}\\cdot(\\mathbf{x}_{j}-\\mathbf{x}_{l})} \\right\\rangle\n$$\nThe particle positions $\\mathbf{x}_{j}$ are independent random variables. We separate the sum into diagonal ($j=l$) and off-diagonal ($j\\neq l$) terms.\n$$\n\\left\\langle \\sum_{j,l} \\exp(-i\\mathbf{k}\\cdot(\\mathbf{x}_{j}-\\mathbf{x}_{l})) \\right\\rangle = \\sum_{j=1}^{N_{p}} \\langle \\exp(0) \\rangle + \\sum_{j \\neq l} \\langle \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}_{j}) \\rangle \\langle \\exp(i\\mathbf{k}\\cdot\\mathbf{x}_{l}) \\rangle\n$$\nFor a uniformly distributed particle in a periodic domain of area $A$, the expectation value for $\\mathbf{k} \\neq \\mathbf{0}$ is $\\langle \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}_{j}) \\rangle = \\frac{1}{A} \\int_{A} \\exp(-i\\mathbf{k}\\cdot\\mathbf{x}) d^{2}x = 0$.\nTherefore, all off-diagonal terms vanish. The sum reduces to the diagonal terms:\n$$\n\\left\\langle \\sum_{j,l} \\exp(-i\\mathbf{k}\\cdot(\\mathbf{x}_{j}-\\mathbf{x}_{l})) \\right\\rangle = N_{p}\n$$\nThe density variance is:\n$$\n\\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle = \\frac{w^{2}S_{r}^{2}(\\mathbf{k})}{A^{2}} N_{p}\n$$\nSubstituting $w = n_{0}A/N_{p}$:\n$$\n\\langle |\\delta n_{i,\\mathbf{k}}|^{2} \\rangle = \\frac{(n_{0}A/N_{p})^{2} S_{r}^{2}(\\mathbf{k})}{A^{2}} N_{p} = \\frac{n_{0}^{2} A^{2}}{N_{p}^{2} A^{2}} S_{r}^{2}(\\mathbf{k}) N_{p} = \\frac{n_{0}^{2}}{N_{p}} S_{r}^{2}(\\mathbf{k})\n$$\nNow we assemble the expression for $\\sigma_{\\phi}^{2}(\\mathbf{k})$:\n$$\n\\sigma_{\\phi}^{2}(\\mathbf{k}) = \\frac{q_{i}^{2}\\,J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right)}{\\alpha(\\mathbf{k})^{2}} \\frac{n_{0}^{2}}{N_{p}} S_{r}^{2}(\\mathbf{k})\n$$\nWe use the given assumptions $q_{i}=e$, $n_{0e}=n_{0i}=n_{0}$, and thus $q_{e}=-e$. The term $\\alpha(\\mathbf{k})$ becomes:\n$$\n\\alpha(\\mathbf{k}) = \\frac{(-e)^{2}n_{0}}{T_{e}} + \\frac{e^{2}n_{0}}{T_{i}}\\left[1-\\Gamma_{0}\\!\\left(b_{i}\\right)\\right] = e^{2}n_{0}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)\n$$\nSubstituting this into the expression for $\\sigma_\\phi^2$:\n$$\n\\sigma_{\\phi}^{2}(\\mathbf{k}) = \\frac{e^{2}\\,J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right)}{\\left[e^{2}n_{0}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)\\right]^{2}} \\frac{n_{0}^{2}}{N_{p}} S_{r}^{2}(\\mathbf{k}) = \\frac{J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right) S_{r}^{2}(\\mathbf{k})}{e^{2}N_{p}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)^{2}}\n$$\nTaking the square root gives the first required expression, the RMS noise amplitude:\n$$\n\\sigma_{\\phi}(\\mathbf{k};N_{p},r) = \\frac{\\left|J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)\\right| \\left|S_{r}(\\mathbf{k})\\right|}{e\\sqrt{N_{p}}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)}\n$$\nwhere $b_{i}=k_{\\perp}^{2}\\rho_{i}^{2}$ and $S_{r}(\\mathbf{k}) = \\prod_{j=1}^{2} \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{j}\\Delta}{2}\\right)\\right]^{\\,r+1}$.\n\nThe second objective is to find the minimum number of macro-particles $N_{p}^{\\min}$ required to achieve a signal-to-noise ratio $\\mathcal{R}$ for a target mode amplitude $\\Phi_{\\mathrm{t}}$. The condition is:\n$$\n\\frac{\\Phi_{\\mathrm{t}}}{\\sigma_{\\phi}(\\mathbf{k};N_{p},r)} \\ge \\mathcal{R}\n$$\nWe solve for $N_{p}$:\n$$\n\\Phi_{\\mathrm{t}} \\ge \\mathcal{R} \\sigma_{\\phi}(\\mathbf{k};N_{p},r) \\implies \\sqrt{N_p} \\ge \\frac{\\mathcal{R}}{\\Phi_{\\mathrm{t}}} \\frac{\\left|J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)\\right| \\left|S_{r}(\\mathbf{k})\\right|}{e\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)}\n$$\nSquaring both sides gives the condition on $N_p$:\n$$\nN_{p} \\ge \\left(\\frac{\\mathcal{R}}{\\Phi_{\\mathrm{t}}}\\right)^{2} \\frac{J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right) S_{r}^{2}(\\mathbf{k})}{e^{2}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)^{2}}\n$$\nThe minimum number of particles $N_{p}^{\\min}$ corresponds to the lower bound of this inequality.\n$$\nN_{p}^{\\min} = \\left(\\frac{\\mathcal{R}}{\\Phi_{\\mathrm{t}}}\\right)^{2} \\frac{J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right) S_{r}^{2}(\\mathbf{k})}{e^{2}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(b_{i})}{T_{i}}\\right)^{2}}\n$$\nThis expression provides the required minimum number of particles in terms of the given parameters.\nThe two required expressions have been derived.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{\\left|J_{0}\\!\\left(k_{\\perp}\\rho_{i}\\right)\\right| \\left|\\prod_{j=1}^{2} \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{j}\\Delta}{2}\\right)\\right]^{\\,r+1}\\right|}{e \\sqrt{N_{p}} \\left(\\frac{1}{T_{e}} + \\frac{1 - \\Gamma_{0}(k_{\\perp}^{2}\\rho_{i}^{2})}{T_{i}}\\right)} & \\left(\\frac{\\mathcal{R}}{\\Phi_{\\mathrm{t}}}\\right)^{2} \\frac{J_{0}^{2}\\!\\left(k_{\\perp}\\rho_{i}\\right) \\left(\\prod_{j=1}^{2} \\left[\\mathrm{sinc}\\!\\left(\\frac{k_{j}\\Delta}{2}\\right)\\right]^{\\,r+1}\\right)^{2}}{e^{2}\\left(\\frac{1}{T_{e}} + \\frac{1-\\Gamma_{0}(k_{\\perp}^{2}\\rho_{i}^{2})}{T_{i}}\\right)^{2}} \\end{pmatrix}}\n$$"
        }
    ]
}