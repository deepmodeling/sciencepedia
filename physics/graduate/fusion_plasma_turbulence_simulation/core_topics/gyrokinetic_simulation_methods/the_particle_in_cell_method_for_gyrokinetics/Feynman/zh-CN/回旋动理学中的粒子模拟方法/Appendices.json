{
    "hands_on_practices": [
        {
            "introduction": "本实践聚焦于回旋动理学粒子模拟方法的一个基本方面：如何在回旋中心相空间中正确地初始化粒子。为了精确地表示等离子体的平衡态，必须从一个尊重回旋中心坐标非正则特性的分布中抽样粒子，这一点由相空间雅可比行列式 $B^\\star_\\|$ 保证。本练习将指导您推导麦克斯韦分布的归一化过程，这是建立任何有效回旋动理学模拟的关键第一步 。",
            "id": "4205894",
            "problem": "考虑一个质量为 $m$、电荷为 $q$ 的单离子种类，处在一个用于回旋动理学质点网格法(PIC)聚变等离子体湍流模拟的板坯几何中。设背景磁场大小恒为 $B_0$，单位矢量为 $\\boldsymbol{b}(\\boldsymbol{R})$，满足 $\\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b} = \\tau$，其中 $\\tau$ 是一个常数（扭率），并假设为静电极限，没有涨落的矢量势。回旋中心相空间测度为 $d^3 R \\, 2\\pi \\, d\\mu \\, dv_{\\parallel} \\, B^{\\star}_{\\parallel}/m$，其中 $B^{\\star}_{\\parallel}$ 是由导心变换产生的修正磁场 $\\boldsymbol{B}^{\\star}$ 的平行分量。\n\n假设平衡回旋中心分布函数在 $\\boldsymbol{R}$ 中是空间均匀的，并且在 $\\mu$ 和 $v_{\\parallel}$ 中是可分离的，\n$$\nf_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}) = C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right),\n$$\n具有未知的归一化常数 $C$、温度 $T$ 和目标常数数密度 $n_0$。仅使用基本原理（相空间体积守恒和导心的正确非正则雅可比），要求每个 $\\boldsymbol{R}$ 处的物理数密度满足\n$$\nn_0 \\;=\\; \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{B^{\\star}_{\\parallel}}{m} \\, f_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}).\n$$\n\n从导心非正则哈密顿结构和刘维尔定理出发，确定此几何下的 $B^{\\star}_{\\parallel}$，并计算 $C$ 的闭式解析表达式，使得上述密度约束被精确满足。最后，解释 $B^{\\star}_{\\parallel}$ 在 PIC 中回旋中心相空间采样中的作用，并论证其依赖于 $v_{\\parallel}$ 的部分是否影响给定平衡态下 $C$ 的值。你的最终答案必须是 $C$ 的单一解析表达式。不需要进行数值舍入。",
            "solution": "用于回旋动理学的质点网格法(PIC)通过从正确的相空间测度中采样的离散标记和权重来表示回旋中心分布。对于导心，由于从粒子坐标到回旋中心坐标的变换，其自然相空间测度是非正则的。基本出发点是导心相空间拉格朗日量和刘维尔定理，它们共同表明，当使用正确的雅可比因子书写时，相空间体积元在动力学演化下是守恒的。在回旋中心坐标 $(\\boldsymbol{R}, \\mu, v_{\\parallel}, \\theta)$ 中，其中 $\\boldsymbol{R}$ 是回旋中心位置，$\\mu$ 是磁矩，$v_{\\parallel}$ 是平行速度，$\\theta$ 是回旋相位，不变测度为\n$$\nd^3 R \\, 2\\pi \\, d\\mu \\, dv_{\\parallel} \\, \\frac{B^{\\star}_{\\parallel}}{m},\n$$\n其中 $2\\pi$ 来自对回旋相角 $\\theta$ 的积分，而 $B^{\\star}_{\\parallel}$ 是确保在非正则变量中相空间体积守恒的回旋中心雅可比因子。\n\n根据导心理论，修正磁场为\n$$\n\\boldsymbol{B}^{\\star} = \\boldsymbol{B} + \\frac{m v_{\\parallel}}{q} \\nabla \\times \\boldsymbol{b},\n$$\n其平行分量为\n$$\nB^{\\star}_{\\parallel} = \\boldsymbol{b} \\cdot \\boldsymbol{B}^{\\star} = B + \\frac{m v_{\\parallel}}{q} \\, \\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b}.\n$$\n在给定几何中，$B(\\boldsymbol{R}) = B_0$ 是常数且 $\\boldsymbol{b} \\cdot \\nabla \\times \\boldsymbol{b} = \\tau$ 是常数，因此\n$$\nB^{\\star}_{\\parallel}(v_{\\parallel}) = B_0 + \\frac{m v_{\\parallel}}{q} \\, \\tau.\n$$\n\n平衡回旋中心分布函数被指定为\n$$\nf_{\\mathrm{gc}}(\\boldsymbol{R},\\mu,v_{\\parallel}) = C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right),\n$$\n其中 $C$ 待定，以满足数密度约束：\n$$\nn_0 = \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{B^{\\star}_{\\parallel}(v_{\\parallel})}{m} \\, C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right).\n$$\n代入 $B^{\\star}_{\\parallel}(v_{\\parallel})$：\n$$\nn_0 = \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\int_{0}^{\\infty} 2\\pi \\, d\\mu \\, \\frac{1}{m} \\left(B_0 + \\frac{m v_{\\parallel}}{q} \\tau\\right) C \\, \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T} - \\frac{\\mu B_0}{T}\\right).\n$$\n将积分分成两部分：\n$$\nn_0 = \\frac{2\\pi C}{m} \\left[ B_0 \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) \\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) \\right. \\\\\n\\left. + \\frac{m \\tau}{q} \\int_{-\\infty}^{\\infty} dv_{\\parallel} \\, v_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) \\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) \\right].\n$$\n计算关于 $\\mu$ 的积分：\n$$\n\\int_{0}^{\\infty} d\\mu \\, \\exp\\!\\left(-\\frac{\\mu B_0}{T}\\right) = \\frac{T}{B_0}.\n$$\n计算关于 $v_{\\parallel}$ 的高斯积分。偶函数的高斯积分为\n$$\n\\int_{-\\infty}^{\\infty} dv_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) = \\sqrt{\\frac{2\\pi T}{m}},\n$$\n而奇函数的高斯积分为零：\n$$\n\\int_{-\\infty}^{\\infty} dv_{\\parallel} \\, v_{\\parallel} \\exp\\!\\left(-\\frac{m v_{\\parallel}^{2}}{2 T}\\right) = 0.\n$$\n因此，\n$$\nn_0 = \\frac{2\\pi C}{m} \\left[ B_0 \\, \\sqrt{\\frac{2\\pi T}{m}} \\, \\frac{T}{B_0} + \\frac{m \\tau}{q} \\cdot 0 \\cdot \\frac{T}{B_0} \\right] = \\frac{2\\pi C}{m} \\, \\sqrt{\\frac{2\\pi T}{m}} \\, T.\n$$\n于是，\n$$\nn_0 = 2\\pi C \\, \\frac{T}{m} \\, \\sqrt{\\frac{2\\pi T}{m}}.\n$$\n求解 $C$：\n$$\nC = \\frac{n_0}{2\\pi} \\, \\frac{m}{T} \\left(\\frac{m}{2\\pi T}\\right)^{\\frac{1}{2}} = n_0 \\left(\\frac{m}{2\\pi T}\\right)^{\\frac{3}{2}}.\n$$\n\n当与正确的非正则雅可比结合时，此结果与以回旋中心不变量表示的传统麦克斯韦分布归一化相匹配。$B^{\\star}_{\\parallel}$ 的作用是在非正则导心坐标中提供正确的相空间雅可比，确保刘维尔不变性，从而保证在 PIC 采样中密度和矩的正确计算。在此几何中，$B^{\\star}_{\\parallel} = B_0 + (m v_{\\parallel}/q)\\tau$ 包含一个依赖于 $v_{\\parallel}$ 并且是关于 $v_{\\parallel}$ 的奇函数项。对于一个关于 $v_{\\parallel}$ 为偶函数的各向同性平衡麦克斯韦分布，该奇函数项的贡献积分为零，因此它不影响归一化常数 $C$ 的值。然而，对于非对称分布（例如，带有平行漂移的分布），$B^{\\star}_{\\parallel}$ 中依赖于 $v_{\\parallel}$ 的部分会对矩产生贡献，必须保留以避免在采样和诊断中产生偏差。在所有情况下，将 $B^{\\star}_{\\parallel}$ 包含在测度中对于回旋中心相空间的物理一致性 PIC 采样至关重要。",
            "answer": "$$\\boxed{n_0\\left(\\frac{m}{2\\pi T}\\right)^{\\frac{3}{2}}}$$"
        },
        {
            "introduction": "回旋动理学的核心在于对快速回旋运动效应的平均，这在数值上转化为回旋平均算符。本实践涉及实现一个“环和”方案来近似场的环内平均，并将其与精确的解析结果——贝塞尔函数 $J_0(k_\\perp \\rho)$进行比较 。掌握这种数值技术对于在模拟中正确地将粒子与电磁场耦合至关重要。",
            "id": "4205877",
            "problem": "考虑用于回旋动理学的质点网格 (PIC) 方法，其中需要对快速回旋运动的场进行回旋平均，以正确模拟带电粒子与电磁涨落之间的相互作用。标量场 $\\phi$ 在导心位置 $\\mathbf{R}$、回旋半径为 $\\rho$（在垂直于背景磁场的平面内）的回旋平均由以下算子定义：\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) \\equiv \\frac{1}{2\\pi} \\int_{0}^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\n其中 $\\hat{\\mathbf{e}}_\\perp(\\theta)$ 是在垂直于背景磁场的平面内旋转了角度 $\\theta$ 的单位矢量。环和数值方案通过在环上均匀采样 $N$ 个求积点来近似此算子：\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\n在 $\\phi(\\mathbf{x})$ 是一个平面波 $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{x}\\big)$ 的特殊情况下，其垂直波数大小为 $k_\\perp = \\|\\mathbf{k}_\\perp\\|$，回旋平均产生的精确标量因子在解析上是已知的，它是第一类零阶贝塞尔函数，其无量纲宗量为 $a \\equiv k_\\perp \\rho$，具体为 $J_0(a)$。因此，对于平面波场，解析回旋平均就简化为解析 $J_0(k_\\perp \\rho)$。\n\n您的任务是为平面波情况实现环和回旋平均方案，并估计所需的最小求积点数 $N$，以使环和与精确解析值 $J_0(k_\\perp \\rho)$ 之间的绝对误差小于或等于指定的容差 $\\varepsilon$：\n$$\n\\left| \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\theta_j\\big) - J_0(a) \\right| \\le \\varepsilon, \\quad a \\equiv k_\\perp \\rho, \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\n需要解析的标量值是 $J_0(k_\\perp \\rho)$；无需返回与 $\\exp\\big(i\\,\\mathbf{k}\\cdot \\mathbf{R}\\big)$ 相关的相位因子。\n\n要求：\n- 实现一个函数，在给定 $a$ 和 $N$ 的情况下，计算环和近似值\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos \\tfrac{2\\pi j}{N}\\big),\n$$\n及其与 $J_0(a)$ 的绝对误差。\n- 实现一个搜索过程，在给定 $a$、容差 $\\varepsilon$ 和上限 $N_{\\max}$ 的情况下，返回满足上述误差标准的最小整数 $N \\in \\{1,2,\\dots,N_{\\max}\\}$。如果直到 $N_{\\max}$ 都没有这样的 $N$ 存在，则返回 $-1$。\n- 所有物理参数必须使用一致的单位。使用 $k_\\perp$ (单位 $\\mathrm{m}^{-1}$) 和 $\\rho$ (单位 $\\mathrm{m}$)，因此 $a = k_\\perp \\rho$ 是无量纲的。\n- 角度必须以弧度为单位。\n\n测试套件：\n对于每个元组 $(k_\\perp, \\rho, \\varepsilon, N_{\\max})$，计算 $a = k_\\perp \\rho$，然后估计满足容差的最小 $N$。使用以下情况：\n- 情况 1：$k_\\perp = 100$，$\\rho = 1.0\\times 10^{-3}$，$\\varepsilon = 1.0\\times 10^{-10}$，$N_{\\max} = 512$。\n- 情况 2：$k_\\perp = 1.0\\times 10^{4}$，$\\rho = 1.0\\times 10^{-3}$，$\\varepsilon = 1.0\\times 10^{-8}$，$N_{\\max} = 4096$。\n- 情况 3：$k_\\perp = 0$，$\\rho = 3.0\\times 10^{-3}$，$\\varepsilon = 1.0\\times 10^{-12}$，$N_{\\max} = 64$。\n- 情况 4：$k_\\perp = 300$，$\\rho = 5.0\\times 10^{-3}$，$\\varepsilon = 1.0\\times 10^{-12}$，$N_{\\max} = 2048$。\n- 情况 5（边缘情况，宗量较大）：$k_\\perp = 2.0\\times 10^{5}$，$\\rho = 2.5\\times 10^{-4}$，$\\varepsilon = 1.0\\times 10^{-6}$，$N_{\\max} = 4096$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个逗号分隔的整数列表，用方括号括起来，按上述顺序排列结果，例如 $[N_1,N_2,N_3,N_4,N_5]$。不得有任何额外的输出文本。",
            "solution": "用于回旋动理学的质点网格 (PIC) 方法将围绕磁力线的快速回旋运动替换为在回旋角上的平均效应。导心位置 $\\mathbf{R}$ 在较慢的时间尺度上演化，而回旋相位 $\\theta$ 则被平均掉。标量场 $\\phi$ 在固定 $\\mathbf{R}$ 和回旋半径 $\\rho$ 处的的回旋平均定义为\n$$\n\\langle \\phi \\rangle(\\mathbf{R},\\rho) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\, d\\theta,\n$$\n这是对角频率等于回旋频率的匀速圆周运动进行平均的结果。在数值 PIC 实现中，此积分通常用环上的均匀求积法来近似，常称为环和：\n$$\n\\langle \\phi \\rangle_N(\\mathbf{R},\\rho) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\phi\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta_j)\\big), \\quad \\theta_j = \\frac{2\\pi j}{N}.\n$$\n为了从第一性原理设计和分析该方案，考虑用于谱分析的基本测试场：一个平面波 $\\phi(\\mathbf{x}) = \\exp(i\\,\\mathbf{k}\\cdot\\mathbf{x})$。将 $\\mathbf{k}$ 写成相对于磁场的平行和垂直分量之和，回旋平均对垂直分量 $\\mathbf{k}_\\perp$ 的依赖性分离出了本质行为。用 $k_\\perp = \\|\\mathbf{k}_\\perp\\|$ 表示垂直分量的大小，并定义一个无量纲参数 $a \\equiv k_\\perp \\rho$。\n\n将平面波代入连续回旋平均可得\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\Big(i\\,\\mathbf{k}\\cdot\\big(\\mathbf{R} + \\rho\\,\\hat{\\mathbf{e}}_\\perp(\\theta)\\big)\\Big)\\, d\\theta\n= \\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R}) \\cdot \\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta,\n$$\n其中通过对齐坐标轴使用了恒等式 $\\mathbf{k}_\\perp \\cdot \\hat{\\mathbf{e}}_\\perp(\\theta) = k_\\perp \\cos\\theta$。积分\n$$\n\\frac{1}{2\\pi} \\int_0^{2\\pi} \\exp\\big(i\\,a\\,\\cos\\theta\\big)\\, d\\theta\n$$\n的结果为第一类零阶贝塞尔函数 $J_0(a)$，从而得到平面波的精确回旋平均因子。因此，对于标量大小，连续算子简化为 $J_0(a)$，而整体相位 $\\exp(i\\,\\mathbf{k}\\cdot\\mathbf{R})$ 与解析标量因子无关。\n\n对于具有 $N$ 个均匀间隔角度 $\\theta_j = 2\\pi j/N$ 的环和近似，标量因子的离散数值近似为\n$$\nA_N(a) \\equiv \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\big(i\\,a\\,\\cos\\theta_j\\big).\n$$\n为了理解其相对于 $J_0(a)$ 的误差，可以使用生成函数的傅里葉级数（一个从 Jacobi-Anger 展开推导出的基本恒等式）：\n$$\n\\exp\\big(i\\,a\\,\\cos\\theta\\big) = \\sum_{m=-\\infty}^{\\infty} i^m J_m(a)\\, \\exp(i\\,m\\,\\theta),\n$$\n其中 $J_m$ 是第一类 $m$ 阶贝塞尔函数。对 $\\theta$ 的连续平均消除了除 $m=0$ 之外的所有傅里葉模式，从而恢复了 $J_0(a)$。在均匀网格上的离散求和实现了对周期解析函数的梯形法则，并精确地传递了索引是 $N$ 的整数倍的傅里葉模式。因此，\n$$\nA_N(a) = \\sum_{q=-\\infty}^{\\infty} i^{qN} J_{qN}(a),\n$$\n误差即为混叠尾部\n$$\nE_N(a) \\equiv A_N(a) - J_0(a) = \\sum_{q\\ne 0} i^{qN} J_{qN}(a).\n$$\n此表达式表明，误差由高阶贝塞尔函数 $J_{qN}(a)$ 控制，其阶数是 $N$ 的倍数。对于固定的 $a$，$J_n(a)$ 的大小随着 $n$ 的增加而迅速衰减。从 $J_n$ 的级数定义推导出的一个经典界限表明\n$$\n|J_n(a)| \\le \\frac{(|a|/2)^n}{n!}, \\quad \\text{对于所有整数 } n \\ge 0,\n$$\n这意味着混叠项随 $N$ 呈超代数衰减。在实践中，主要的混叠项通常是 $J_N(a)$，确保 $|J_N(a)|$ 低于容差 $\\varepsilon$ 通常足以使总误差小于 $\\varepsilon$。\n\n算法设计：\n- 从单位分别为 $\\mathrm{m}^{-1}$ 和 $\\mathrm{m}$ 的输入值计算无量纲参数 $a = k_\\perp \\rho$。\n- 对于给定的 $N$，通过计算均匀和来计算 $A_N(a)$：\n$$\nA_N(a) = \\frac{1}{N} \\sum_{j=0}^{N-1} \\exp\\left(i\\,a\\,\\cos\\left(\\frac{2\\pi j}{N}\\right)\\right).\n$$\n- 使用可靠的特殊函数实现来评估精确的解析目标 $J_0(a)$。\n- 计算绝对误差：\n$$\n\\mathrm{err}(N;a) \\equiv \\left| A_N(a) - J_0(a) \\right|.\n$$\n- 为了在上限 $N_{\\max}$ 内估计满足 $\\mathrm{err}(N;a) \\le \\varepsilon$ 的最小 $N$，对 $N \\in \\{1,2,\\dots,N_{\\max}\\}$ 进行搜索，并选择满足标准的最小 $N$。如果在 $N_{\\max}$ 内不存在这样的 $N$，则返回 $-1$。\n- 特殊情况：当 $a = 0$ 时，对于任何 $N$ 都有 $A_N(0) = 1$，并且 $J_0(0) = 1$，因此对于任何容差，最小的 $N$ 都是 $1$。\n\n此过程是基于基本原理的：它从回旋动理学中回旋平均的定义出发，将其应用于平面波以推导出精确的 $J_0(a)$ 依赖关系，并将离散环和构造为回旋角上的梯形法则。傅里葉分析证明了为什么环和收敛迅速，并为搜索达到指定容差所需的最小求积点数提供了物理依据。测试套件包括各种情况：小 $a$（情况 1）、中等 $a$（情况 4）、零 $a$（情况 3）以及大 $a$ 和严格容差（情况 2 和 5），涵盖了与聚变等离子体湍流模拟相关的典型和挑战性场景。\n\n最终程序必须输出一行包含指定情况的整数结果 $[N_1,N_2,N_3,N_4,N_5]$ 的内容，不得有任何附加文本。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import special\n\ndef ring_sum(a: float, N: int) -> complex:\n    \"\"\"\n    Compute the ring-sum approximation A_N(a) = (1/N) sum_{j=0}^{N-1} exp(i a cos(2π j / N)).\n    \"\"\"\n    # Handle trivial case to avoid unnecessary computation\n    if N <= 0:\n        raise ValueError(\"N must be a positive integer.\")\n    if a == 0.0:\n        return 1.0 + 0.0j\n    j = np.arange(N, dtype=np.float64)\n    thetas = (2.0 * np.pi * j) / N\n    values = np.exp(1j * a * np.cos(thetas))\n    return np.mean(values)\n\ndef estimate_min_N(a: float, tol: float, N_max: int) -> int:\n    \"\"\"\n    Estimate the minimal N (1 <= N <= N_max) such that |A_N(a) - J0(a)| <= tol,\n    where A_N(a) is the ring-sum approximation. If not found, return -1.\n    \"\"\"\n    # Exact analytic target\n    J0 = special.j0(a)\n    # Special case: a == 0.0 => exact for any N, choose N=1\n    if a == 0.0:\n        return 1\n\n    # Linear search over N, ensuring minimality\n    for N in range(1, N_max + 1):\n        A_N = ring_sum(a, N)\n        err = abs(A_N - J0)\n        if err <= tol:\n            return N\n    return -1\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each case: (k_perp [1/m], rho [m], tol, N_max)\n    test_cases = [\n        (100.0, 1.0e-3, 1.0e-10, 512),\n        (1.0e4, 1.0e-3, 1.0e-8, 4096),\n        (0.0, 3.0e-3, 1.0e-12, 64),\n        (300.0, 5.0e-3, 1.0e-12, 2048),\n        (2.0e5, 2.5e-4, 1.0e-6, 4096),\n    ]\n\n    results = []\n    for k_perp, rho, tol, N_max in test_cases:\n        a = k_perp * rho  # Dimensionless\n        N_min = estimate_min_N(a, tol, N_max)\n        results.append(N_min)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "一个可靠的模拟必须遵守基本的物理量守恒定律。本实践专注于验证一个回旋动理学模型的离散数值格式的能量守恒特性 。通过实现一个诊断程序，比较粒子与场交换的能量和场能量的变化，您将在代码验证和确认这一最关键的方面之一获得动手经验。",
            "id": "4205831",
            "problem": "您需要设计并实现一个数值诊断程序，用于检验一维长波极限下静电回旋动理学粒子模拟（PIC）方法中的能量守恒。目标是计算一个时间步长内粒子与场之间的能量交换，并验证该净交换量与场能量的变化相匹配，其中使用的离散化方法需要能反映回旋动理学的极化物理。您的程序必须为指定的测试套件生成结果，并将它们汇总成单行输出。\n\n从以下基本原理出发：\n\n- 在长波回旋动理学极限下的静电学，满足准中性与极化条件：由粒子产生的自由电荷密度（记为 $\\rho_{\\mathrm{free}}(x,t)$）和极化电荷密度（记为 $\\rho_{\\mathrm{pol}}(x,t)$）满足 $\\rho_{\\mathrm{free}}(x,t) + \\rho_{\\mathrm{pol}}(x,t) = 0$。\n- 极化电荷密度建模为 $\\rho_{\\mathrm{pol}}(x,t) = -\\epsilon \\,\\partial_x^2 \\phi(x,t)$，其中 $\\phi(x,t)$ 是静电势，$\\epsilon$ 是一个常数，在归一化单位下代表长波极化系数 $\\epsilon = n_0 m_i/B^2$。\n- 静电场能量为 $W_{\\mathrm{field}}(t) = \\dfrac{1}{2} \\int \\epsilon \\left(\\partial_x \\phi(x,t)\\right)^2 \\, dx$。\n- 在此静电回旋动理学模型中，粒子与场之间的能量交换率由能量守恒定律得出：$\\dfrac{d}{dt} W_{\\mathrm{field}}(t) + \\int \\rho_{\\mathrm{free}}(x,t) \\,\\partial_t \\phi(x,t)\\, dx = 0$。\n\n按如下方式离散化区域、算子和时间间隔：\n\n- 使用一个长度为 $L$ 的一维周期性区域，网格包含 $N$ 个均匀分布的点，间距为 $\\Delta x = L/N$。\n- 在两个连续的时间点 $t^n$ 和 $t^{n+1}$，用数组 $\\phi^n_i$ 和 $\\phi^{n+1}_i$（$i = 0,1,\\dots,N-1$）表示网格上的场。\n- 使用向前差分计算空间梯度：\n  $$\n  D_+ \\phi_i = \\frac{\\phi_{i+1} - \\phi_i}{\\Delta x},\n  $$\n  其中下标运算是周期性的（例如，$\\phi_N \\equiv \\phi_0$）。\n- 使用向后差分计算散度：\n  $$\n  D_- \\phi_i = \\frac{\\phi_i - \\phi_{i-1}}{\\Delta x}。\n  $$\n- 使用由 $D_- D_+$ 构成的二阶中心拉普拉斯算子：\n  $$\n  \\partial_x^2 \\phi_i \\approx \\frac{\\phi_{i+1} - 2\\phi_i + \\phi_{i-1}}{\\Delta x^2}。\n  $$\n- 将空间积分近似为离散求和：$\\int f(x)\\,dx \\approx \\sum_i f_i \\,\\Delta x$。\n- 使用梯形法则近似时间中点：定义 $\\phi^{\\mathrm{avg}}_i = \\dfrac{1}{2}(\\phi^n_i + \\phi^{n+1}_i)$ 和 $\\rho_{\\mathrm{free}}^{\\mathrm{avg}}_i = \\dfrac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i)$。利用准中性从场中获得自由电荷：$\\rho_{\\mathrm{free}}^n{}_i = \\epsilon \\,\\partial_x^2 \\phi^n_i$ 和 $\\rho_{\\mathrm{free}}^{n+1}{}_i = \\epsilon \\,\\partial_x^2 \\phi^{n+1}_i$。\n\n根据这些定义，计算一个时间步长内的以下量：\n\n- 粒子-场能量交换：\n  $$\n  Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x.\n  $$\n- 场能量的变化：\n  $$\n  \\Delta W_{\\mathrm{field}} = W_{\\mathrm{field}}^{n+1} - W_{\\mathrm{field}}^{n} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x.\n  $$\n\n计算每个测试案例的绝对不匹配值\n$$\nM = \\left| Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}} \\right|\n$$\n对于指定的离散化和周期性边界条件，在精确计算下，由于一个离散分部积分恒等式，$M$ 的值应该极小。\n\n在整个计算过程中使用归一化单位，因此不需要进行物理单位转换。所有角度必须使用弧度。\n\n实现以下测试套件。对于每个案例，构建网格 $x_i = i\\,\\Delta x$（$i=0,1,\\dots,N-1$），其中 $\\Delta x = L/N$，并明确定义 $\\phi^n_i$ 和 $\\phi^{n+1}_i$ 如下。\n\n- 案例1（平滑单模，振幅变化）：\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$。\n  - $k = 2$, $A = 0.3$, $\\delta A = 0.01$。\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = (A + \\delta A)\\,\\sin(k x_i)$。\n- 案例2（无变化，精确为零）：\n  - $N = 128$, $L = 2\\pi$, $\\epsilon = 1$。\n  - $k = 4$, $A = 0.25$。\n  - $\\phi^n_i = A \\,\\sin(k x_i)$, $\\phi^{n+1}_i = A \\,\\sin(k x_i)$。\n- 案例3（双模组合，振幅和相位均有变化）：\n  - $N = 256$, $L = 2\\pi$, $\\epsilon = 0.5$。\n  - $k_1 = 3$, $k_2 = 5$, $A_1 = 0.2$, $A_2 = 0.1$, $A_1' = 0.205$, $A_2' = 0.095$, $\\delta\\varphi_1 = 0.02$, $\\delta\\varphi_2 = -0.015$。\n  - $\\phi^n_i = A_1 \\,\\sin(k_1 x_i) + A_2 \\,\\cos(k_2 x_i)$,\n    $\\phi^{n+1}_i = A_1' \\,\\sin(k_1 x_i + \\delta\\varphi_1) + A_2' \\,\\cos(k_2 x_i + \\delta\\varphi_2)$。\n- 案例4（奈奎斯特模式，网格尺度振荡）：\n  - $N = 64$, $L = 2\\pi$, $\\epsilon = 1$。\n  - $k_{\\mathrm{nyq}} = N/2$（整数），$A = 0.1$, $A' = 0.11$。\n  - $\\phi^n_i = A \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$, $\\phi^{n+1}_i = A' \\,\\cos(k_{\\mathrm{nyq}}\\, x_i)$。\n\n您的程序应计算每个案例的 $M$ 值，并生成一个单行输出，其中包含一个用方括号括起来的逗号分隔列表的结果（例如，$[m_1,m_2,m_3,m_4]$）。这些值应为实数（浮点数）。三角函数中使用的角度必须是弧度，并且网格必须严格按照规定使用周期性边界条件。程序运行时不提供任何输入；测试套件的所有参数都必须在程序中硬编码。",
            "solution": "本问题的目标是验证所用数值格式的离散能量守恒特性。该守恒定律指出，在一个时间步长内，粒子与静电场之间交换的能量 $Q_{\\mathrm{part}}$ 应该精确等于场中存储的总能量的变化量 $\\Delta W_{\\mathrm{field}}$。我们将通过代数方法证明，对于问题中给出的特定离散化方案，此守恒定律是精确成立的（误差仅限于浮点精度）。\n\n我们需要比较的两个量是：\n1.  **粒子-场能量交换**: $Q_{\\mathrm{part}} = -\\sum_{i=0}^{N-1} \\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i \\left(\\phi^{n+1}_i - \\phi^n_i\\right)\\,\\Delta x$\n2.  **场能量的变化**: $\\Delta W_{\\mathrm{field}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[\\left(D_+ \\phi^{n+1}_i\\right)^2 - \\left(D_+ \\phi^{n}_i\\right)^2\\right] \\Delta x$\n\n现在，我们来证明 $Q_{\\mathrm{part}} = \\Delta W_{\\mathrm{field}}$。\n\n首先，自由电荷密度由 $\\rho_{\\mathrm{free}} = \\epsilon \\partial_x^2\\phi$ 给出。其时间平均值的离散形式为：\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\frac{1}{2}(\\rho_{\\mathrm{free}}^n{}_i + \\rho_{\\mathrm{free}}^{n+1}{}_i) = \\frac{\\epsilon}{2} (D_- D_+ \\phi^n_i + D_- D_+ \\phi^{n+1}_i)\n$$\n利用拉普拉斯算子 $D_-D_+$ 的线性特性，上式可写作：\n$$\n\\rho_{\\mathrm{free}}^{\\mathrm{avg}}{}_i = \\epsilon D_- D_+ \\left( \\frac{\\phi^n_i + \\phi^{n+1}_i}{2} \\right) = \\epsilon D_- D_+ \\phi^{\\mathrm{avg}}_i\n$$\n将此结果代入 $Q_{\\mathrm{part}}$ 的表达式，并用 $\\delta\\phi_i = \\phi^{n+1}_i - \\phi^n_i$ 表示电势的变化：\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\sum_{i=0}^{N-1} (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\delta\\phi_i \\Delta x\n$$\n接下来，我们应用离散的分部求和恒等式（周期性边界条件下），它类似于连续情形下的分部积分：$\\sum_i a_i (D_- b_i) \\Delta x = - \\sum_i (D_+ a_i) b_i \\Delta x$。令 $a_i = \\delta\\phi_i$ 且 $b_i = D_+ \\phi^{\\mathrm{avg}}_i$，则有：\n$$\n\\sum_{i=0}^{N-1} \\delta\\phi_i (D_- (D_+ \\phi^{\\mathrm{avg}}_i)) \\Delta x = - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\n代入 $Q_{\\mathrm{part}}$ 的表达式中：\n$$\nQ_{\\mathrm{part}} = - \\epsilon \\left( - \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x \\right) = \\epsilon \\sum_{i=0}^{N-1} (D_+ \\delta\\phi_i) (D_+ \\phi^{\\mathrm{avg}}_i) \\Delta x\n$$\n然后，展开 $\\delta\\phi_i$ 和 $\\phi^{\\mathrm{avg}}_i$ 的离散导数项：\n$$\nD_+ \\delta\\phi_i = D_+(\\phi^{n+1}_i - \\phi^n_i) = D_+\\phi^{n+1}_i - D_+\\phi^n_i\n$$\n$$\nD_+ \\phi^{\\mathrm{avg}}_i = D_+\\left(\\frac{\\phi^{n+1}_i + \\phi^n_i}{2}\\right) = \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i)\n$$\n将它们代回 $Q_{\\mathrm{part}}$：\n$$\nQ_{\\mathrm{part}} = \\epsilon \\sum_{i=0}^{N-1} (D_+\\phi^{n+1}_i - D_+\\phi^n_i) \\frac{1}{2}(D_+\\phi^{n+1}_i + D_+\\phi^n_i) \\Delta x\n$$\n利用平方差公式 $(a-b)(a+b) = a^2 - b^2$，表达式简化为：\n$$\nQ_{\\mathrm{part}} = \\frac{1}{2}\\epsilon \\sum_{i=0}^{N-1} \\left[ (D_+\\phi^{n+1}_i)^2 - (D_+\\phi^n_i)^2 \\right] \\Delta x\n$$\n这个结果与 $\\Delta W_{\\mathrm{field}}$ 的定义完全相同。因此，我们已经证明了 $Q_{\\mathrm{part}} \\equiv \\Delta W_{\\mathrm{field}}$。计算出的不匹配值 $M = |Q_{\\mathrm{part}} - \\Delta W_{\\mathrm{field}}|$ 应该为零，或一个可归因于浮点运算误差的极小值。\n\n此代数证明解释了为什么该数值格式能够精确地保持能量守恒。要完成此题，需要根据上述公式实现算法，并对每个测试案例计算不匹配值 $M$。由于代数上的等价性，预计在所有情况下 $M$ 都将接近于零。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the energy conservation mismatch for a 1D electrostatic gyrokinetic\n    PIC model using a specific finite-difference scheme.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"case_id\": 1,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 2.0, \"A\": 0.3, \"deltaA\": 0.01},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: (p[\"A\"] + p[\"deltaA\"]) * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 2,\n            \"N\": 128, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k\": 4.0, \"A\": 0.25},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A\"] * np.sin(p[\"k\"] * x)\n        },\n        {\n            \"case_id\": 3,\n            \"N\": 256, \"L\": 2.0 * np.pi, \"epsilon\": 0.5,\n            \"params\": {\n                \"k1\": 3.0, \"k2\": 5.0, \"A1\": 0.2, \"A2\": 0.1,\n                \"A1_prime\": 0.205, \"A2_prime\": 0.095,\n                \"d_phi1\": 0.02, \"d_phi2\": -0.015\n            },\n            \"phi_n_func\": lambda x, p: p[\"A1\"] * np.sin(p[\"k1\"] * x) + p[\"A2\"] * np.cos(p[\"k2\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A1_prime\"] * np.sin(p[\"k1\"] * x + p[\"d_phi1\"]) + p[\"A2_prime\"] * np.cos(p[\"k2\"] * x + p[\"d_phi2\"])\n        },\n        {\n            \"case_id\": 4,\n            \"N\": 64, \"L\": 2.0 * np.pi, \"epsilon\": 1.0,\n            \"params\": {\"k_nyq\": 32.0, \"A\": 0.1, \"A_prime\": 0.11},\n            \"phi_n_func\": lambda x, p: p[\"A\"] * np.cos(p[\"k_nyq\"] * x),\n            \"phi_n1_func\": lambda x, p: p[\"A_prime\"] * np.cos(p[\"k_nyq\"] * x)\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        N = case[\"N\"]\n        L = case[\"L\"]\n        epsilon = case[\"epsilon\"]\n        params = case[\"params\"]\n\n        dx = L / N\n        x = np.linspace(0.0, L, N, endpoint=False)\n\n        # Generate potential fields at times t^n and t^{n+1}\n        phi_n = case[\"phi_n_func\"](x, params)\n        phi_n1 = case[\"phi_n1_func\"](x, params)\n\n        # ---- Calculate Q_part ----\n        \n        # Calculate time-averaged free charge density, rho_free_avg\n        # rho_free_avg = epsilon * laplacian(phi_avg)\n        # where phi_avg = (phi_n + phi_n1) / 2\n        phi_avg = 0.5 * (phi_n + phi_n1)\n        \n        # Discrete Laplacian operator D_- D_+ using periodic boundaries\n        # np.roll(phi, -1) gives phi_{i+1}\n        # np.roll(phi, 1)  gives phi_{i-1}\n        laplacian_phi_avg = (np.roll(phi_avg, -1) - 2.0 * phi_avg + np.roll(phi_avg, 1)) / (dx**2)\n        \n        rho_free_avg = epsilon * laplacian_phi_avg\n        \n        # Calculate potential difference\n        delta_phi = phi_n1 - phi_n\n        \n        # Calculate energy exchange Q_part\n        Q_part = -np.sum(rho_free_avg * delta_phi) * dx\n\n        # ---- Calculate Delta_W_field ----\n        \n        # Discrete forward difference operator D_+ using periodic boundaries\n        d_plus_phi_n = (np.roll(phi_n, -1) - phi_n) / dx\n        d_plus_phi_n1 = (np.roll(phi_n1, -1) - phi_n1) / dx\n\n        # Calculate field energy at each time\n        W_field_n_sq_term = d_plus_phi_n**2\n        W_field_n1_sq_term = d_plus_phi_n1**2\n        \n        # Calculate change in field energy Delta_W_field\n        delta_W_field = 0.5 * epsilon * np.sum(W_field_n1_sq_term - W_field_n_sq_term) * dx\n\n        # ---- Calculate the mismatch M ----\n        mismatch = np.abs(Q_part - delta_W_field)\n        results.append(mismatch)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}