{
    "hands_on_practices": [
        {
            "introduction": "在PIC模拟中，我们将连续的等离子体分布函数离散为有限数量的计算“标记点”（markers）。这种离散化在估算局部物理量（如网格单元中的密度）时，不可避免地会引入统计噪声。本练习将引导你从第一性原理出发，推导为达到给定的密度估算相对误差目标，每个单元所需的平均标记点数，从而将模拟保真度与粒子加载策略及形函数（shape function）的选择直接联系起来。",
            "id": "4195903",
            "problem": "在用于聚变等离子体湍流的一维粒子模拟 (PIC) 中，考虑使用一个紧支集形函数来估计以网格为中心的粒子密度。该区域是周期性的，长度为 $L$，并被离散为 $M$ 个宽度为 $\\Delta = L/M$ 的均匀网格，网格中心位于 $\\{x_i\\}$。共使用 $N$ 个计算标记点（也称为宏粒子）。标记点位置 $\\{x_j\\}_{j=1}^{N}$ 是在 $[0,L)$ 上均匀分布的独立同分布随机变量，标记点权重 $\\{w_j\\}_{j=1}^{N}$ 是独立同分布的，其均值为 $\\bar{w}$，方差为 $\\sigma_{w}^{2}$，且与位置无关。\n\n网格中心 $x_i$ 处的密度是通过使用在网格尺度上应用的、积分为1的 $p$ 阶基本B样条形函数 $M_p(u)$ 对标记点权重进行线性沉积来估计的。具体来说，将网格尺度的形函数定义为\n$$\nS(x) = \\frac{1}{\\Delta} M_p\\!\\left(\\frac{x}{\\Delta}\\right),\n$$\n并将网格中心密度的估计量定义为\n$$\n\\hat{n}_i = \\sum_{j=1}^{N} w_j\\, S(x_i - x_j).\n$$\n假设真实密度在空间上是均匀的，并且该估计量是无偏的。您关心的是在给定网格处估计量的均方根相对误差，\n$$\n\\eta \\equiv \\frac{\\sqrt{\\mathrm{Var}[\\hat{n}_i]}}{\\mathbb{E}[\\hat{n}_i]}.\n$$\n\n仅使用关于独立抽样、独立加数的方差可加性以及形函数归一化的基本事实，并且不引用任何预先推导的PIC噪声公式，推导出为确保逐网格的均方根相对误差满足 $\\eta \\le \\epsilon$（其中 $\\epsilon$ 是给定的目标相对误差）所需的每个网格的最小平均标记点数 $N_c \\equiv N/M$。将您的最终结果表示为一个封闭形式的解析表达式，该表达式应包含 $\\epsilon$、通过无量纲常数\n$$\nI_p \\equiv \\int_{-\\infty}^{\\infty} M_p(u)^2\\, du,\n$$\n表示的形函数阶数 $p$，以及权重统计量 $\\bar{w}$ 和 $\\sigma_w^{2}$。假设周期性区域足够大，以至于边缘效应可以忽略不计，并且 $M$ 足够大，以至于任何在 $M \\to \\infty$ 时消失的有限尺寸修正都可以被忽略。\n\n请以封闭形式给出最小 $N_c$ 作为答案。不需要进行数值计算。您的最终答案必须是单个无单位的封闭形式解析表达式。",
            "solution": "问题要求确定每个网格所需的最小平均标记点数（记为 $N_c$），以确保密度估计量 $\\hat{n}_i$ 的逐网格均方根 (RMS) 相对误差 $\\eta$ 不大于指定的容差 $\\epsilon$。RMS 相对误差定义为 $\\eta \\equiv \\frac{\\sqrt{\\mathrm{Var}[\\hat{n}_i]}}{\\mathbb{E}[\\hat{n}_i]}$。因此，条件为 $\\eta \\le \\epsilon$，这等价于 $\\eta^2 = \\frac{\\mathrm{Var}[\\hat{n}_i]}{(\\mathbb{E}[\\hat{n}_i])^2} \\le \\epsilon^2$。\n\n为解决此问题，我们必须首先推导密度估计量的期望 $\\mathbb{E}[\\hat{n}_i]$ 和方差 $\\mathrm{Var}[\\hat{n}_i]$ 的表达式。\n\n网格中心 $x_i$ 处密度的估计量由以下和式给出：\n$$\n\\hat{n}_i = \\sum_{j=1}^{N} w_j S(x_i - x_j)\n$$\n其中 $\\{w_j\\}_{j=1}^{N}$ 是标记点权重，$\\{x_j\\}_{j=1}^{N}$ 是标记点位置。对于所有 $j \\in \\{1, \\dots, N\\}$，对 $(w_j, x_j)$ 都是独立同分布 (i.i.d.) 的。我们将和中的单项定义为 $Z_j = w_j S(x_i - x_j)$。随机变量 $\\{Z_j\\}_{j=1}^{N}$ 是独立同分布的。\n\n首先，我们计算 $\\hat{n}_i$ 的期望。根据期望的线性性质：\n$$\n\\mathbb{E}[\\hat{n}_i] = \\mathbb{E}\\left[\\sum_{j=1}^{N} Z_j\\right] = \\sum_{j=1}^{N} \\mathbb{E}[Z_j] = N \\mathbb{E}[Z_1]\n$$\n单项 $Z_j$ 的期望为 $\\mathbb{E}[Z_j] = \\mathbb{E}[w_j S(x_i - x_j)]$。由于标记点权重 $w_j$ 和位置 $x_j$ 是独立的，我们可以将期望分开：\n$$\n\\mathbb{E}[Z_j] = \\mathbb{E}[w_j] \\mathbb{E}[S(x_i - x_j)]\n$$\n给定 $\\mathbb{E}[w_j] = \\bar{w}$。标记点位置 $x_j$ 在区间 $[0, L)$ 上均匀分布，因此其概率密度函数为 $f_X(x) = 1/L$（对于 $x \\in [0, L)$）及其他情况下为0。形函数项的期望为：\n$$\n\\mathbb{E}[S(x_i - x_j)] = \\int_{0}^{L} S(x_i - x) f_X(x) dx = \\frac{1}{L} \\int_{0}^{L} S(x_i - x) dx\n$$\n让我们进行变量替换 $y = x_i - x$，因此 $dx = -dy$。积分限从 $x=0 \\to y=x_i$ 和 $x=L \\to y=x_i-L$ 变化。\n$$\n\\mathbb{E}[S(x_i - x_j)] = \\frac{1}{L} \\int_{x_i}^{x_i-L} S(y) (-dy) = \\frac{1}{L} \\int_{x_i-L}^{x_i} S(y) dy\n$$\n由于区域是周期性的且很大，这个在一个周期上的积分约等于在整个实轴上的积分。问题陈述允许我们忽略有限尺寸修正。\n$$\n\\int_{x_i-L}^{x_i} S(y) dy \\approx \\int_{-\\infty}^{\\infty} S(y) dy = \\int_{-\\infty}^{\\infty} \\frac{1}{\\Delta} M_p\\left(\\frac{y}{\\Delta}\\right) dy\n$$\n使用代换 $u = y/\\Delta$，由此可得 $dy = \\Delta du$：\n$$\n\\int_{-\\infty}^{\\infty} \\frac{1}{\\Delta} M_p(u) (\\Delta du) = \\int_{-\\infty}^{\\infty} M_p(u) du = 1\n$$\n这是由B样条 $M_p(u)$ 的归一化条件给出的。\n因此，$\\mathbb{E}[S(x_i - x_j)] = 1/L$。综合这些结果，单项的期望是 $\\mathbb{E}[Z_j] = \\bar{w} \\frac{1}{L}$。\n密度估计量的期望是：\n$$\n\\mathbb{E}[\\hat{n}_i] = N \\frac{\\bar{w}}{L}\n$$\n这就是平均物理密度，与无偏估计量的预期相符。\n\n接下来，我们计算 $\\hat{n}_i$ 的方差。由于各项 $Z_j$ 是独立同分布的，和的方差等于各项方差之和：\n$$\n\\mathrm{Var}[\\hat{n}_i] = \\mathrm{Var}\\left[\\sum_{j=1}^{N} Z_j\\right] = \\sum_{j=1}^{N} \\mathrm{Var}[Z_j] = N \\mathrm{Var}[Z_1]\n$$\n单项的方差由 $\\mathrm{Var}[Z_j] = \\mathbb{E}[Z_j^2] - (\\mathbb{E}[Z_j])^2$ 给出。我们需要计算 $\\mathbb{E}[Z_j^2]$：\n$$\n\\mathbb{E}[Z_j^2] = \\mathbb{E}[w_j^2 S(x_i-x_j)^2] = \\mathbb{E}[w_j^2] \\mathbb{E}[S(x_i-x_j)^2]\n$$\n权重的二阶矩与其方差的关系为 $\\mathbb{E}[w_j^2] = \\mathrm{Var}[w_j] + (\\mathbb{E}[w_j])^2 = \\sigma_w^2 + \\bar{w}^2$。\n形函数平方的期望是：\n$$\n\\mathbb{E}[S(x_i-x_j)^2] = \\int_{0}^{L} S(x_i - x)^2 \\frac{1}{L} dx \\approx \\frac{1}{L} \\int_{-\\infty}^{\\infty} S(y)^2 dy\n$$\n这里我们再次使用了大区域假设。我们代入 $S(y)=\\frac{1}{\\Delta}M_p(y/\\Delta)$:\n$$\n\\int_{-\\infty}^{\\infty} S(y)^2 dy = \\int_{-\\infty}^{\\infty} \\left(\\frac{1}{\\Delta} M_p\\left(\\frac{y}{\\Delta}\\right)\\right)^2 dy = \\frac{1}{\\Delta^2} \\int_{-\\infty}^{\\infty} M_p\\left(\\frac{y}{\\Delta}\\right)^2 dy\n$$\n使用代换 $u = y/\\Delta$，所以 $dy = \\Delta du$:\n$$\n\\frac{1}{\\Delta^2} \\int_{-\\infty}^{\\infty} M_p(u)^2 (\\Delta du) = \\frac{1}{\\Delta} \\int_{-\\infty}^{\\infty} M_p(u)^2 du = \\frac{I_p}{\\Delta}\n$$\n其中 $I_p \\equiv \\int_{-\\infty}^{\\infty} M_p(u)^2 du$ 是给定的无量纲常数。\n所以，$\\mathbb{E}[S(x_i-x_j)^2] \\approx \\frac{1}{L} \\frac{I_p}{\\Delta}$。\n将这些部分组合起来：\n$$\n\\mathbb{E}[Z_j^2] \\approx (\\sigma_w^2 + \\bar{w}^2) \\frac{I_p}{L\\Delta}\n$$\n单项的方差为：\n$$\n\\mathrm{Var}[Z_j] = \\mathbb{E}[Z_j^2] - (\\mathbb{E}[Z_j])^2 \\approx (\\sigma_w^2 + \\bar{w}^2) \\frac{I_p}{L\\Delta} - \\left(\\frac{\\bar{w}}{L}\\right)^2\n$$\n估计量的总方差为：\n$$\n\\mathrm{Var}[\\hat{n}_i] \\approx N \\left[ (\\sigma_w^2 + \\bar{w}^2) \\frac{I_p}{L\\Delta} - \\frac{\\bar{w}^2}{L^2} \\right]\n$$\n现在我们可以构造相对误差的平方 $\\eta^2$：\n$$\n\\eta^2 = \\frac{\\mathrm{Var}[\\hat{n}_i]}{(\\mathbb{E}[\\hat{n}_i])^2} \\approx \\frac{N \\left[ (\\sigma_w^2 + \\bar{w}^2) \\frac{I_p}{L\\Delta} - \\frac{\\bar{w}^2}{L^2} \\right]}{(N \\bar{w}/L)^2} = \\frac{1}{N} \\frac{L^2}{\\bar{w}^2} \\left[ (\\sigma_w^2 + \\bar{w}^2) \\frac{I_p}{L\\Delta} - \\frac{\\bar{w}^2}{L^2} \\right]\n$$\n$$\n\\eta^2 \\approx \\frac{1}{N \\bar{w}^2} \\left[ (\\sigma_w^2 + \\bar{w}^2) \\frac{L I_p}{\\Delta} - \\bar{w}^2 \\right]\n$$\n给定 $\\Delta = L/M$，所以 $L/\\Delta = M$，以及 $N_c = N/M$，所以 $N=N_c M$。将这些代入表达式中：\n$$\n\\eta^2 \\approx \\frac{1}{N_c M \\bar{w}^2} \\left[ (\\sigma_w^2 + \\bar{w}^2) M I_p - \\bar{w}^2 \\right] = \\frac{1}{N_c \\bar{w}^2} \\left[ (\\sigma_w^2 + \\bar{w}^2) I_p - \\frac{\\bar{w}^2}{M} \\right]\n$$\n问题陈述中说明我们可以忽略任何在 $M \\to \\infty$ 时消失的有限尺寸修正。项 $\\bar{w}^2/M$ 就是这样一个修正。在网格数 $M$ 很大的极限下，这一项变得可以忽略不计。\n$$\n\\eta^2 \\approx \\frac{I_p}{N_c \\bar{w}^2} (\\sigma_w^2 + \\bar{w}^2) = \\frac{I_p}{N_c} \\left( \\frac{\\sigma_w^2}{\\bar{w}^2} + 1 \\right)\n$$\n我们要求 $\\eta^2 \\le \\epsilon^2$：\n$$\n\\frac{I_p}{N_c} \\left( 1 + \\frac{\\sigma_w^2}{\\bar{w}^2} \\right) \\le \\epsilon^2\n$$\n求解 $N_c$，我们将不等式两边同乘以 $N_c$ 再除以 $\\epsilon^2$（因为 $N_c  0$ 且 $\\epsilon^2  0$）：\n$$\nI_p \\left( 1 + \\frac{\\sigma_w^2}{\\bar{w}^2} \\right) \\le N_c \\epsilon^2\n$$\n$$\nN_c \\ge \\frac{I_p}{\\epsilon^2} \\left( 1 + \\frac{\\sigma_w^2}{\\bar{w}^2} \\right)\n$$\n每个网格的最小平均标记点数 $N_c$ 是该不等式的下界。\n$$\nN_{c, \\text{min}} = \\frac{I_p}{\\epsilon^2} \\left( 1 + \\frac{\\sigma_w^2}{\\bar{w}^2} \\right)\n$$",
            "answer": "$$\n\\boxed{\\frac{I_p}{\\epsilon^2} \\left( 1 + \\frac{\\sigma_w^2}{\\bar{w}^2} \\right)}\n$$"
        },
        {
            "introduction": "在成功控制了局部密度误差之后，一个更具挑战性的问题是如何确保整个模拟区域内的物理信号能够从背景噪声中被分辨出来。本练习将焦点从实空间转移到傅里叶空间，探讨一个核心的信噪比问题：我们需要多少标记点才能以足够的置信度解析出特定波长和振幅的等离子体密度涨落。掌握这种计算对于有效设计和验证旨在研究等离子体湍流的PIC模拟至关重要。",
            "id": "4195830",
            "problem": "考虑在用于聚变等离子体湍流模拟的粒子模拟（PIC）方法（Particle-In-Cell (PIC)）中进行的一维回旋动理学（GK）平板测试。该区域是一个长度为 $L$ 的周期性区间，我们的目标是解析单个静电密度涨落模式。标记点在位形空间中以相等的权重均匀加载，密度涨落由一个小的相对振幅 $A$ 来表征，使得密度的涨落分量与 $A n_0$ 成比例，其中 $n_0$ 是背景密度标度。目标是确定所需的最小标记点数 $N$，以便在指定的置信水平下，估计的密度涨落的傅里叶余弦振幅能够被解析到预设的相对容差范围内，并根据解析方差估计来验证此要求。\n\n使用以下基本原理：\n- 标记点样本的独立性和均匀加载意味着标记点位置 $x_i$ 是在 $[0,L]$ 上独立同分布的均匀随机变量。\n- 波数为 $k$ 的傅里叶余弦振幅的估计量是通过使用相等权重对标记点位置进行蒙特卡洛积分来定义的。对于模式数 $m \\in \\mathbb{Z}^+$，波数为 $k = 2\\pi m / L$（角度以弧度为单位）。\n- 中心极限定理意味着，对于独立样本，该估计量近似呈正态分布，其方差随 $1/N$ 减小。\n- 对于在 $[0,L]$ 上的均匀采样，当整数 $m \\ge 1$ 且 $m \\ne M/2$（非奈奎斯特频率）时，$\\mathrm{Var}[\\cos(k x)] = 1/2$。\n\n根据这些原理，推导出最小整数标记点数 $N$，使得在置信水平为 $c$ 的双边正态置信区间的半宽度小于或等于 $\\epsilon A n_0$，其中 $\\epsilon$ 是预设的相对容差（无量纲），$c$ 以 $(0,1)$ 内的小数形式给出。\n\n此外，考虑一个具有 $M$ 个等尺寸 $\\Delta x = L/M$ 单元的均匀网格沉积。令 $c_j$ 表示单元 $j$（其中 $j=0,1,\\dots,M-1$）中的标记点数，并使用标记点权重通过网格沉积来定义离散傅里叶余弦振幅估计量。利用均匀采样下计数服从泊松统计的性质，验证当 $m$ 不是奈奎斯特模式时，解析推导的傅里叶余弦振幅方差与基于网格的方差表达式相匹配。\n\n您的程序必须实现以下功能：\n- 对于每个测试用例，计算满足置信度要求的最小整数标记点数 $N_{\\min}$。\n- 通过检查 $N_{\\min} - 1$ 是否不满足要求来验证其紧致性。\n- 将解析方差与基于网格的方差（通过对单元中心 $x_j = j \\Delta x$ 上的 $\\cos^2(k x_j)$ 进行离散求和计算得出）进行比较，并断言它们在小的数值容差范围内匹配。\n\n所有量 $A$、$\\epsilon$ 和 $c$ 都是无量纲的。角度必须以弧度处理。标记点数 $N$ 是一个无单位的整数。为避免无关单位，所有测试均使用 $L = 1.0$ 和 $n_0 = 1.0$。\n\n测试套件：\n- 案例 1（正常路径）：$A = 10^{-2}$，$\\epsilon = 10^{-1}$，$c = 0.95$，$m=3$，$M=64$。\n- 案例 2（高置信度和更严的容差）：$A = 5 \\times 10^{-3}$，$\\epsilon = 5 \\times 10^{-2}$，$c = 0.99$，$m=5$，$M=128$。\n- 案例 3（极小振幅）：$A = 10^{-4}$，$\\epsilon = 2 \\times 10^{-1}$，$c = 0.90$，$m=7$，$M=256$。\n- 案例 4（近乎确定的置信度）：$A = 2 \\times 10^{-2}$，$\\epsilon = 10^{-1}$，$c = 0.999$，$m=9$，$M=512$。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔列表形式的结果。每个测试用例应产生一个形式为 $[N_{\\min}, \\text{tight}, \\text{var\\_match}]$ 的列表，其中 $N_{\\min}$ 是一个整数，$\\text{tight}$ 是一个布尔值，指示 $N_{\\min}-1$ 是否不满足要求，$\\text{var\\_match}$ 是一个布尔值，指示解析方差和基于网格的方差是否在数值容差内匹配。例如，输出必须看起来像 $[[N_1,\\text{True},\\text{True}],[N_2,\\text{True},\\text{True}],\\dots]$。",
            "solution": "该问题在科学上和数学上是适定的，提供了明确的目标和所有必要的信息。它基于粒子模拟（PIC）方法、蒙特卡洛方法和统计分析的既定原则。因此，该问题被认为是有效的，并将提供一个解决方案。\n\n主要目标是确定所需的最小模拟标记点数 $N$，以便以指定的统计置信度解析给定振幅的密度涨落。这是PIC模拟中的一个经典信噪问题，其中“噪声”源于连续等离子体密度的离散粒子表示。\n\n设一维周期性区域的长度为 $L$。我们正在考虑一个具有波数 $k = 2\\pi m / L$ 的单一余弦密度涨落模式，其中 $m$ 是一个正整数模式数。给定的物理密度涨落的余弦振幅为 $A n_0$，其中 $n_0$ 是背景密度，$A$ 是小的无量纲相对振幅。总密度为 $n(x) = n_0 + A n_0 \\cos(kx)$。\n\n在PIC模拟中，等离子体由大量的标记点表示。问题陈述，标记点在位形空间中以相等的权重均匀加载。这对应于使用 $N$ 个标记点来表示均匀的背景密度 $n_0$。每个标记点的位置 $x_i$（对于 $i=1, \\dots, N$）是从区间 $[0, L]$ 上的均匀分布中抽取的独立随机变量。\n\n标记点的离散性引入了采样噪声。尽管标记点代表均匀的背景，对其分布进行傅里叶分析将在所有模式上产生非零的振幅。这就是粒子噪声。我们必须确保这个噪声相对于我们希望解析的物理信号足够小。\n\n基于标记点的密度表示的傅里叶余弦振幅由蒙特卡洛估计量给出：\n$$ \\hat{C}_m = \\frac{2}{L} \\int_0^L \\left(\\sum_{i=1}^N w_i \\delta(x - x_i)\\right) \\cos(kx) dx $$\n对于背景密度 $n_0$，每个标记点的权重相等，为 $w_i = n_0 L / N$。将此代入估计量中得到：\n$$ \\hat{C}_m = \\frac{2}{L} \\sum_{i=1}^N \\frac{n_0 L}{N} \\cos(kx_i) = \\frac{2 n_0}{N} \\sum_{i=1}^N \\cos(kx_i) $$\n这个估计量 $\\hat{C}_m$ 是一个随机变量，因为标记点的位置 $x_i$ 是随机的。我们首先计算它的期望值。由于 $x_i \\sim U[0, L]$ 且 $m \\ge 1$：\n$$ E[\\cos(kx_i)] = \\frac{1}{L} \\int_0^L \\cos\\left(\\frac{2\\pi m x}{L}\\right) dx = 0 $$\n根据期望的线性性质，估计量的期望值为：\n$$ E[\\hat{C}_m] = \\frac{2 n_0}{N} \\sum_{i=1}^N E[\\cos(kx_i)] = 0 $$\n这证实了，平均而言，噪声不会产生系统性的傅里叶分量。\n\n接下来，我们计算估计量的方差。由于标记点位置 $x_i$ 是独立的，和的方差是方差的和：\n$$ \\mathrm{Var}[\\hat{C}_m] = \\mathrm{Var}\\left[\\frac{2 n_0}{N} \\sum_{i=1}^N \\cos(kx_i)\\right] = \\left(\\frac{2 n_0}{N}\\right)^2 \\sum_{i=1}^N \\mathrm{Var}[\\cos(kx_i)] = \\frac{4 n_0^2}{N^2} \\cdot N \\cdot \\mathrm{Var}[\\cos(kx)] = \\frac{4 n_0^2}{N} \\mathrm{Var}[\\cos(kx)] $$\n问题提供了基本结果，即对于 $x \\sim U[0, L]$ 和 $k = 2\\pi m / L$（其中 $m \\in \\mathbb{Z}^+$），$\\mathrm{Var}[\\cos(kx)] = 1/2$。这是从 $E[\\cos(kx)]=0$ 和 $E[\\cos^2(kx)] = \\frac{1}{L} \\int_0^L \\cos^2(kx) dx = \\frac{1}{L} \\int_0^L \\frac{1 + \\cos(2kx)}{2} dx = 1/2$ 推导出来的。\n将此代入 $\\hat{C}_m$ 的方差表达式中：\n$$ \\mathrm{Var}[\\hat{C}_m] = \\frac{4 n_0^2}{N} \\cdot \\frac{1}{2} = \\frac{2 n_0^2}{N} $$\n噪声估计量的标准差是 $\\sigma_{\\hat{C}_m} = \\sqrt{\\mathrm{Var}[\\hat{C}_m]} = n_0 \\sqrt{2/N}$。\n\n根据中心极限定理，对于大的 $N$，估计量 $\\hat{C}_m$ 近似呈正态分布：$\\hat{C}_m \\sim \\mathcal{N}(0, \\sigma_{\\hat{C}_m}^2)$。\n问题要求，在置信水平为 $c$ 时，噪声振幅的双边正态置信区间的半宽度必须小于或等于信号振幅 $A n_0$ 的一个分数 $\\epsilon$。\n置信区间的半宽度 $HW$ 由 $HW = z \\sigma_{\\hat{C}_m}$ 给出，其中 $z$ 是对应于置信水平 $c$ 的标准正态分布的临界值。该值是分位数 $z = \\Phi^{-1}((1+c)/2)$，其中 $\\Phi$ 是标准正态分布的累积分布函数。\n\n因此，解析度要求可表述为：\n$$ z \\sigma_{\\hat{C}_m} \\le \\epsilon A n_0 $$\n代入 $\\sigma_{\\hat{C}_m}$ 的表达式：\n$$ z \\left(n_0 \\sqrt{\\frac{2}{N}}\\right) \\le \\epsilon A n_0 $$\n背景密度标度 $n_0$ 被消去，这对于相对振幅的条件是符合预期的。对于所有计算，我们按照规定使用 $n_0=1.0$。\n$$ z \\sqrt{\\frac{2}{N}} \\le \\epsilon A $$\n我们对这个不等式求解 $N$：\n$$ \\sqrt{\\frac{2}{N}} \\le \\frac{\\epsilon A}{z} \\implies \\frac{2}{N} \\le \\left(\\frac{\\epsilon A}{z}\\right)^2 \\implies N \\ge 2 \\left(\\frac{z}{\\epsilon A}\\right)^2 $$\n最小标记点数 $N_{\\min}$ 必须是一个整数，所以我们取右侧表达式的向上取整（ceiling）：\n$$ N_{\\min} = \\left\\lceil 2 \\left(\\frac{z}{\\epsilon A}\\right)^2 \\right\\rceil $$\n这个公式允许计算每个测试用例的 $N_{\\min}$。紧致性检查，即验证 $N_{\\min}-1$ 不满足条件，由向上取整函数的定义所保证。对于 $N' = N_{\\min}-1$，我们有 $N'  2(z/(\\epsilon A))^2$，这违反了所需的不等式。\n\n最后，我们必须将余弦项的解析方差 $\\mathrm{Var}[\\cos(kx)] = 1/2$ 与基于网格的计算进行验证。一个具有 $M$ 个单元的均匀网格，其单元中心位于 $x_j = j \\Delta x = j (L/M)$，其中 $j=0, 1, \\dots, M-1$。离散方差通过将 $\\cos(kx_j)$ 视为网格点上的离散随机变量来计算。\n函数 $g(x_j)$ 的离散期望为 $E_{\\text{grid}}[g] = \\frac{1}{M}\\sum_{j=0}^{M-1} g(x_j)$。\n波数为 $k = 2\\pi m / L$。在网格点上，$kx_j = 2\\pi m j / M$。\n离散均值为 $E_{\\text{grid}}[\\cos(kx)] = \\frac{1}{M}\\sum_{j=0}^{M-1} \\cos(2\\pi mj/M)$。对于任何不是 $M$ 的倍数的整数 $m$，此和为零。\n离散二阶矩为 $E_{\\text{grid}}[\\cos^2(kx)] = \\frac{1}{M}\\sum_{j=0}^{M-1} \\cos^2(2\\pi mj/M) = \\frac{1}{M}\\sum_{j=0}^{M-1} \\frac{1+\\cos(4\\pi mj/M)}{2}$。\n对于非奈奎斯特模式，即当 $2m$ 不是 $M$ 的倍数时，和 $\\sum_{j=0}^{M-1} \\cos(4\\pi mj/M)$ 为零。问题通过陈述 $m \\neq M/2$ 来保证这一点。\n因此，$E_{\\text{grid}}[\\cos^2(kx)] = \\frac{1}{2M}(M+0) = 1/2$。\n基于网格的方差为 $\\mathrm{Var}_{\\text{grid}}[\\cos(kx)] = E_{\\text{grid}}[\\cos^2(kx)] - (E_{\\text{grid}}[\\cos(kx)])^2 = 1/2 - 0^2 = 1/2$。\n这从解析上证实了，在指定条件下，基于网格的方差与连续空间方差 $1/2$ 是相同的。程序将对此进行数值验证。",
            "answer": "```python\nimport numpy as np\nfrom scipy.stats import norm\nimport math\n\ndef solve():\n    \"\"\"\n    Solves for the minimal marker count in a PIC simulation test case\n    and performs verification checks.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: A, epsilon, c, m, M\n        (1e-2, 1e-1, 0.95, 3, 64),\n        # Case 2\n        (5e-3, 5e-2, 0.99, 5, 128),\n        # Case 3\n        (1e-4, 2e-1, 0.90, 7, 256),\n        # Case 4\n        (2e-2, 1e-1, 0.999, 9, 512),\n    ]\n\n    results = []\n\n    # Constants for all tests\n    L = 1.0\n    n0 = 1.0\n\n    for A, epsilon, c, m, M in test_cases:\n        # 1. Compute minimal marker count N_min\n\n        # The critical value z for a two-sided confidence interval\n        z = norm.ppf((1 + c) / 2)\n\n        # The condition is z * n0 * sqrt(2/N) = epsilon * A * n0.\n        # This simplifies to N = 2 * (z / (epsilon * A))^2.\n        N_star = 2 * (z / (epsilon * A))**2\n        N_min = math.ceil(N_star)\n\n        # 2. Verify tightness: check that N_min - 1 fails the requirement.\n        \n        def get_half_width(N_val):\n            if N_val == 0:\n                return float('inf')\n            # The standard deviation of the noise estimator is n0 * sqrt(2/N)\n            std_dev_est = n0 * np.sqrt(2 / N_val)\n            return z * std_dev_est\n        \n        tolerance_BW = epsilon * A * n0\n        \n        # Check if N_min passes and N_min-1 fails.\n        # Due to floating point precision, use a small tolerance for comparison.\n        tightness_check_pass = get_half_width(N_min) = tolerance_BW\n        tightness_check_fail = get_half_width(N_min - 1) > tolerance_BW\n        tight = tightness_check_pass and tightness_check_fail\n\n        # 3. Verify analytic variance against grid-based variance.\n        # The analytic variance of cos(kx) for x in U[0,L] is 1/2.\n        analytic_var = 0.5\n\n        # Grid-based variance calculation\n        # The condition m != M/2 ensures the discrete sums behave as expected.\n        if 2 * m == M:\n            # This case is excluded by the problem statement, but as a safeguard:\n            var_match = False\n        else:\n            k = 2 * np.pi * m / L\n            # Grid cell centers\n            xj = np.arange(M) * L / M\n            cos_kxj = np.cos(k * xj)\n            \n            # Discrete expectation values\n            E_grid_cos = np.mean(cos_kxj)\n            E_grid_cos_sq = np.mean(cos_kxj**2)\n            \n            grid_based_var = E_grid_cos_sq - E_grid_cos**2\n            \n            # Assert they match within numerical tolerance\n            var_match = np.isclose(grid_based_var, analytic_var)\n\n        # Format result for the current test case\n        case_result = [N_min, tight, var_match]\n        results.append(case_result)\n\n    # Final print statement in the exact required format\n    # Convert each inner list to its string representation\n    # e.g., [123, True, True] - \"[123, True, True]\"\n    # Then join these strings with commas.\n    print(f\"[{','.join(map(str, results))}]\")\n\n\nsolve()\n\n```"
        },
        {
            "introduction": "前面的练习处理的是理想化的一维系统，而真实的聚变等离子体则存在于复杂的磁约束几何中。本练习将理论付诸实践，要求你在托卡马克装置的环形几何中设计一个标记点加载方案。你将推导出一个非平凡的权重函数，以补偿磁通坐标与物理空间体积之间的非线性关系，最终实现物理上均匀的粒子数密度分布，这是进行真实托卡马克模拟的关键一步。",
            "id": "4195838",
            "problem": "考虑一个大环径比的托卡马克，其具有由极向磁通量 $\\psi \\in [0,\\psi_a]$ 标记的同心圆形磁通量面。在用于聚变等离子体湍流的“细胞内粒子”（PIC）模拟中，通常需要在磁通量面上加载计算标记点。目标是从第一性原理和核心几何事实出发，构建一种标记点加载算法，使得每个磁通量面上的单位磁通量面面积的密度均匀。假设以下广泛使用的大环径比关系：磁通量面的小半径 $r$ 随极向磁通量 $\\psi$ 的变化关系为 $r(\\psi) = a \\sqrt{\\psi/\\psi_a}$，主半径为 $R_0$、小半径为 $r$ 的环体的表面积为 $A(\\psi) = 4\\pi^2 R_0 r$。您将使用一个包含 $N_\\psi$ 个等宽区间的网格，在 $\\psi$ 中均匀加载标记点，并在每个区间的中心点放置 $M$ 个标记点。当提及角度时，单位为弧度。\n\n从这些几何关系和均匀表面密度的定义出发，推导必须分配给每个 $\\psi$ 区间中标记点的权重函数，以获得单位磁通量面面积上的均匀密度。请严格使用上述定义的量来表达您的推导过程。使用一个恒定的目标物理表面数密度 $\\rho_0$（单位为标记点/平方米），并为数值计算设置 $\\rho_0 = 1$，以使标记点权重无量纲。\n\n您的程序必须实现最终的算法，以计算测试套件中每个参数集下每个 $\\psi$ 区间中点的标记点权重。对于 $i=0,1,\\dots,N_\\psi-1$，使用区间中点 $\\psi_i = \\left(i+\\frac{1}{2}\\right)\\Delta\\psi$，其中 $\\Delta\\psi = \\psi_a/N_\\psi$。程序应输出所有测试用例的所有权重列表，按顺序连接，形式为一个包含在方括号内的逗号分隔列表的单行。\n\n使用以下科学上合理的参数值测试套件来评估该算法：\n- 测试用例1：$R_0 = 3.0$ 米, $a = 1.0$ 米, $\\psi_a = 0.8$ 韦伯, $N_\\psi = 8$ 个区间, 每个区间 $M = 50$ 个标记点。\n- 测试用例2：$R_0 = 2.5$ 米, $a = 0.5$ 米, $\\psi_a = 0.5$ 韦伯, $N_\\psi = 5$ 个区间, 每个区间 $M = 100$ 个标记点。\n- 测试用例3：$R_0 = 6.0$ 米, $a = 0.8$ 米, $\\psi_a = 1.2$ 韦伯, $N_\\psi = 10$ 个区间, 每个区间 $M = 200$ 个标记点。\n\n在每种情况下，计算并返回 $\\psi$ 区间中点的权重。所有输入长度单位为米，所有磁通量单位为韦伯，输出的权重必须是无量纲的浮点数。您的程序应生成一行输出，其中包含一个方括号内的逗号分隔列表的结果（例如 $[w_1,w_2,\\dots]$），其中每个 $w_i$ 是一个浮点数。",
            "solution": "该问题要求推导并实现一种用于大环径比托卡马克中“细胞内粒子”（PIC）模拟的计算标记点的加权算法。目标是在给定标记点加载方案在极向磁通量坐标 $\\psi$ 中是均匀的情况下，在每个磁通量面上实现均匀的物理粒子表面数密度 $\\rho_0$。\n\n推导从第一性原理开始。设 $dN_{phys}$ 为磁通量面上一个微分表面积元 $dA$ 内的物理粒子数。物理表面数密度定义为 $\\rho_0 = \\frac{dN_{phys}}{dA}$。问题指出，$\\rho_0$ 在所有磁通量面上必须是常数。\n\n在PIC模拟中，我们使用计算标记点来表示物理粒子分布。物理粒子数通过权重 $w$ 与标记点数 $dN_{markers}$ 相关联，即 $dN_{phys} = w \\cdot dN_{markers}$。在相空间中给定位置的每个标记点携带相同的权重。将此代入密度定义，我们得到权重的表达式：\n$$\n\\rho_0 = \\frac{w \\cdot dN_{markers}}{dA} \\implies w = \\rho_0 \\frac{dA}{dN_{markers}}\n$$\n这个表达式表明，权重与物理面积元和占据它的标记点数量之比成正比。为了找到作为极向磁通量函数 $w(\\psi)$ 的权重，我们必须用 $\\psi$ 来表示比率 $\\frac{dA}{dN_{markers}}$。\n\n问题指明，标记点在域 $[0, \\psi_a]$ 上沿坐标 $\\psi$ 均匀加载。这是通过将域划分为 $N_\\psi$ 个等宽的区间（宽度为 $\\Delta\\psi = \\psi_a/N_\\psi$）并在每个区间中放置 $M$ 个标记点来实现的。标记点总数为 $N_{total} = M N_\\psi$。因此，标记点关于 $\\psi$ 的数密度是恒定的：\n$$\n\\frac{dN_{markers}}{d\\psi} = \\frac{N_{total}}{\\psi_a} = \\frac{M N_\\psi}{\\psi_a}\n$$\n由此，我们可以写出 $dN_{markers} = \\left(\\frac{M N_\\psi}{\\psi_a}\\right) d\\psi$。\n\n表面积 $A$ 是 $\\psi$ 的函数。使用链式法则，微分面积元 $dA$ 可以与微分磁通量元 $d\\psi$ 相关联：\n$$\ndA = \\frac{dA}{d\\psi} d\\psi\n$$\n将 $dN_{markers}$ 和 $dA$ 的表达式代入权重 $w$ 的方程中，得到：\n$$\nw(\\psi) = \\rho_0 \\frac{\\frac{dA}{d\\psi} d\\psi}{\\frac{M N_\\psi}{\\psi_a} d\\psi} = \\rho_0 \\frac{\\psi_a}{M N_\\psi} \\frac{dA}{d\\psi}\n$$\n下一步是使用提供的大环径比托卡马克的几何关系计算导数 $\\frac{dA}{d\\psi}$：\n1. 小半径作为极向磁通量的函数：$r(\\psi) = a \\sqrt{\\frac{\\psi}{\\psi_a}}$\n2. 环体的表面积：$A(r) = 4\\pi^2 R_0 r$\n\n首先，通过将 $r(\\psi)$ 代入 $A(r)$，我们将面积 $A$ 表示为 $\\psi$ 的显式函数：\n$$\nA(\\psi) = 4\\pi^2 R_0 r(\\psi) = 4\\pi^2 R_0 a \\sqrt{\\frac{\\psi}{\\psi_a}} = \\left(\\frac{4\\pi^2 R_0 a}{\\sqrt{\\psi_a}}\\right) \\psi^{1/2}\n$$\n现在，我们对 $A(\\psi)$ 关于 $\\psi$ 求导：\n$$\n\\frac{dA}{d\\psi} = \\frac{d}{d\\psi} \\left[ \\left(\\frac{4\\pi^2 R_0 a}{\\sqrt{\\psi_a}}\\right) \\psi^{1/2} \\right] = \\left(\\frac{4\\pi^2 R_0 a}{\\sqrt{\\psi_a}}\\right) \\cdot \\frac{1}{2} \\psi^{-1/2} = \\frac{2\\pi^2 R_0 a}{\\sqrt{\\psi_a \\psi}}\n$$\n将此导数代回 $w(\\psi)$ 的表达式中：\n$$\nw(\\psi) = \\rho_0 \\frac{\\psi_a}{M N_\\psi} \\left( \\frac{2\\pi^2 R_0 a}{\\sqrt{\\psi_a \\psi}} \\right) = \\rho_0 \\frac{2\\pi^2 R_0 a \\psi_a}{M N_\\psi \\sqrt{\\psi_a} \\sqrt{\\psi}} = \\rho_0 \\frac{2\\pi^2 R_0 a \\sqrt{\\psi_a}}{M N_\\psi \\sqrt{\\psi}}\n$$\n问题指出，标记点放置在每个 $\\psi$ 区间的中点。第 $i$ 个区间（其中 $i=0, 1, \\dots, N_\\psi-1$）的中点由 $\\psi_i = \\left(i+\\frac{1}{2}\\right)\\Delta\\psi = \\left(i+\\frac{1}{2}\\right)\\frac{\\psi_a}{N_\\psi}$ 给出。第 $i$ 个区间中标记点的权重 $w_i$ 是通过在 $\\psi=\\psi_i$ 处计算 $w(\\psi)$ 得到的：\n$$\nw_i = w(\\psi_i) = \\rho_0 \\frac{2\\pi^2 R_0 a \\sqrt{\\psi_a}}{M N_\\psi \\sqrt{\\left(i+\\frac{1}{2}\\right)\\frac{\\psi_a}{N_\\psi}}}\n$$\n我们可以通过分离平方根内的项来简化此表达式：\n$$\nw_i = \\rho_0 \\frac{2\\pi^2 R_0 a \\sqrt{\\psi_a}}{M N_\\psi \\sqrt{i+\\frac{1}{2}} \\frac{\\sqrt{\\psi_a}}{\\sqrt{N_\\psi}}} = \\rho_0 \\frac{2\\pi^2 R_0 a \\sqrt{\\psi_a} \\sqrt{N_\\psi}}{M N_\\psi \\sqrt{i+\\frac{1}{2}} \\sqrt{\\psi_a}}\n$$\n消去 $\\sqrt{\\psi_a}$ 并简化 $N_\\psi$ 的因子，得到第 $i$ 个区间中标记点权重的最终算法：\n$$\nw_i = \\rho_0 \\frac{2\\pi^2 R_0 a}{M \\sqrt{N_\\psi} \\sqrt{i+\\frac{1}{2}}} = \\rho_0 \\frac{2\\pi^2 R_0 a}{M \\sqrt{N_\\psi\\left(i+\\frac{1}{2}\\right)}}\n$$\n为了进行数值计算，我们设定目标密度 $\\rho_0 = 1$（单位为 $m^{-2}$），使权重无量纲。最终要实现的公式是：\n$$\nw_i = \\frac{2\\pi^2 R_0 a}{M \\sqrt{N_\\psi\\left(i+\\frac{1}{2}\\right)}} \\quad \\text{对于 } i = 0, 1, \\dots, N_\\psi-1\n$$\n该公式提供了每个区间中标记点的权重，它正确地补偿了磁通量坐标 $\\psi$ 和物理表面积之间的非均匀关系，从而确保最终的加权标记点分布对应于均匀的物理粒子密度。权重与磁通量的平方根成反比，$w \\propto 1/\\sqrt{\\psi}$，这意味着靠近磁轴（$\\psi \\approx 0$）的标记点必须被赋予比靠近边缘的标记点更高的权重。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes marker weights for PIC simulations in a tokamak based on a derived formula.\n\n    The problem requires deriving a weight function for markers loaded uniformly in\n    the poloidal flux coordinate (psi) to achieve a uniform physical density per\n    unit flux surface area.\n\n    The derived formula for the weight w_i in the i-th psi bin is:\n    w_i = (2 * pi^2 * R0 * a) / (M * sqrt(N_psi * (i + 0.5)))\n    where rho_0 is set to 1.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # (R0, a, psi_a, N_psi, M)\n        (3.0, 1.0, 0.8, 8, 50),\n        (2.5, 0.5, 0.5, 5, 100),\n        (6.0, 0.8, 1.2, 10, 200),\n    ]\n\n    # This list will store all weights from all test cases, concatenated.\n    all_weights = []\n\n    for case in test_cases:\n        R0, a, psi_a, N_psi, M = case\n\n        # The parameter psi_a is part of the problem statement and derivation\n        # but cancels out of the final formula for the weights w_i.\n\n        # Create an array for the bin indices i = 0, 1, ..., N_psi - 1\n        i_values = np.arange(N_psi)\n\n        # Calculate the numerator of the weight formula. It is constant for a given case.\n        # Constant target physical surface number density rho_0 is set to 1.\n        numerator = 2 * (np.pi**2) * R0 * a\n\n        # Calculate the denominator, which depends on the bin index i.\n        # This is a vectorized operation over all i_values.\n        denominator = M * np.sqrt(N_psi * (i_values + 0.5))\n\n        # Calculate the weights for the current test case.\n        weights = numerator / denominator\n\n        # Append the calculated weights to the master list.\n        all_weights.extend(weights.tolist())\n\n    # Format the final output as a comma-separated list of floating-point numbers\n    # enclosed in square brackets.\n    # The map(str, ...) converts each float to its string representation.\n    # ','.join(...) concatenates them with commas in between.\n    output_str = f\"[{','.join(map(str, all_weights))}]\"\n    \n    # Final print statement in the exact required format.\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}