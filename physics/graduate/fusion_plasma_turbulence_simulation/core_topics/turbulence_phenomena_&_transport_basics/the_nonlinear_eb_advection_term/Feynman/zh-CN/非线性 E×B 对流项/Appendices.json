{
    "hands_on_practices": [
        {
            "introduction": "理论的优雅必须在数值实践中得到验证。此练习将指导您实现 $E \\times B$ 非线性平流项的守恒通量形式离散化，并验证该方案是否能精确地保持连续方程的两个基本性质：$E \\times B$ 漂移的无散性和总平流标量的守恒性。通过这个基础编码实践，您将深入理解数值守恒律在确保模拟物理保真度方面的重要性。",
            "id": "4205468",
            "problem": "您将实现并验证在二维周期性区域中，电场叉乘磁场（E×B）非线性平流项的守恒通量形式离散化，并证明在一致的中心差分离散化下，E×B漂移速度的离散散度在舍入误差范围内为零。\n\n本问题的基本依据包括以下物理定义和数学事实：\n- 在静电学中，电场为 $\\mathbf{E} = -\\nabla \\phi$，其中 $\\phi$ 是静电势。\n- 对于均匀磁场 $\\mathbf{B} = B_0 \\,\\hat{\\mathbf{z}}$，电场叉乘磁场（E×B）的漂移速度为 $\\mathbf{v}_E = \\dfrac{\\mathbf{E} \\times \\mathbf{B}}{B_0^2}$。在 $B_0 = 1$ 且系数被吸收到单位中的无量纲归一化下，这在二维情况下简化为 $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$，因此有 $v_x = -\\partial_y \\phi$ 和 $v_y = \\partial_x \\phi$。\n- 矢量微积分恒等式 $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,\\nabla\\cdot\\mathbf{v}$ 意味着当 $\\nabla\\cdot\\mathbf{v}_E = 0$ 时，有 $\\mathbf{v}_E\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}_E)$。\n- 在均匀网格上，带周期性边界条件的一致中心差分会导致离散导数的可交换性，这是连续恒等式 $\\partial_x\\partial_y = \\partial_y\\partial_x$ 的离散形式。\n\n您必须实现以下内容，使用无量纲单位，角度以弧度为单位：\n1. 一个二维周期性网格，在 $x$ 方向有 $N_x$ 个点，在 $y$ 方向有 $N_y$ 个点，范围分别为 $[0,L_x)$ 和 $[0,L_y)$。使用均匀间距 $\\Delta x = L_x/N_x$ 和 $\\Delta y = L_y/N_y$。\n2. 中心差分离散导数\n   $$D_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y},$$\n   采用周期性环绕索引。\n3. E×B漂移速度离散地定义为 $v_x = -D_y \\phi$ 和 $v_y = D_x \\phi$。\n4. E×B速度的离散散度 $\\nabla\\cdot\\mathbf{v}_E \\approx D_x v_x + D_y v_y$。\n5. 标量场 $f$ 的守恒通量形式平流，\n   $$\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right),$$\n   其中 $v_x$ 和 $v_y$ 是由与上述相同的离散导数算子一致地构造出来的。\n\n您的程序必须定义并运行以下参数集和场的测试套件，涵盖一般行为和边界情况。所有量均为无量纲，角度以弧度为单位。对于以下每种情况，请精确地按照规定构造 $\\phi(x,y)$ 和 $f(x,y)$：\n\n- 情况1（光滑、非平凡的场，奇数 $N_y$）：\n  - $N_x = 64$，$N_y = 65$，$L_x = 2\\pi$，$L_y = 2\\pi$。\n  - $\\phi(x,y) = \\sin(3x)\\,\\cos(4y)$。\n  - $f(x,y) = \\cos(2x)\\,\\sin(3y)$。\n\n- 情况2（零速度场）：\n  - $N_x = 4$，$N_y = 4$，$L_x = 2\\pi$，$L_y = 2\\pi$。\n  - $\\phi(x,y) = 0.37$（常数）。\n  - $f(x,y) = \\sin(x) + \\cos(y)$。\n\n- 情况3（恒定平流场）：\n  - $N_x = 33$，$N_y = 31$，$L_x = 2\\pi$，$L_y = 2\\pi$。\n  - $\\phi(x,y) = \\sin(5x) + \\sin(7y)$。\n  - $f(x,y) = 1.0$（常数）。\n\n- 情况4（随机场，通过固定种子实现可复现性）：\n  - $N_x = 128$，$N_y = 128$，$L_x = 2\\pi$，$L_y = 2\\pi$。\n  - $\\phi(x,y)$ 和 $f(x,y)$ 是网格上独立同分布的伪随机场，每个都使用固定种子 $42$ 从 $[0,1)$ 中均匀采样。\n\n对于每种情况，计算并返回以下三个指标：\n- $m_1$：$\\mathbf{v}_E$ 离散散度的最大绝对值，即 $\\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$。\n- $m_2$：$\\mathbf{v}_E$ 散度的离散 $L^2$ 范数，按单元格面积缩放，即\n  $$m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}.$$\n- $m_3$：区域积分的守恒通量形式平流的绝对值，即\n  $$m_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|.$$\n\n您的程序应生成单行输出，其中包含四个情况的结果，以逗号分隔列表的形式按从情况1到情况4的顺序排列，每个情况的结果是一个用方括号括起来的逗号分隔的三元组。例如，输出格式必须是\n```\n[[m1_case1,m2_case1,m3_case1],[m1_case2,m2_case2,m3_case2],[m1_case3,m2_case3,m3_case3],[m1_case4,m2_case4,m3_case4]]\n```\n其中每个 $m_k$ 都表示为浮点数。所有量均为无量纲，角度以弧度为单位。",
            "solution": "问题陈述是有效的。它提出了一个在计算等离子体物理学领域中关于E×B平流项数值性质的适定且有科学依据的任务。所有必要的参数和定义都已提供，问题没有矛盾或含糊之处。\n\n这个问题的核心是验证二维周期性区域上E×B非线性项特定数值离散化的两个基本性质。这些性质是连续数学恒等式的离散形式，对于模拟的物理保真度至关重要，特别是在守恒律方面。\n\n首先，我们考虑连续的E×B漂移速度。给定一个均匀磁场 $\\mathbf{B} = B_0 \\hat{\\mathbf{z}}$ 和一个静电势 $\\phi$，电场为 $\\mathbf{E} = -\\nabla \\phi$。在无量纲单位中，系数 $1/B_0$ 被吸收，二维（$x, y$）下的E×B漂移速度由 $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$ 给出。该叉积展开为分量 $v_x = -\\partial_y \\phi$ 和 $v_y = \\partial_x \\phi$。\n\n该速度场的一个关键性质是它是无散度的。其散度计算如下：\n$$\n\\nabla \\cdot \\mathbf{v}_E = \\frac{\\partial v_x}{\\partial x} + \\frac{\\partial v_y}{\\partial y} = \\frac{\\partial}{\\partial x}\\left(-\\frac{\\partial \\phi}{\\partial y}\\right) + \\frac{\\partial}{\\partial y}\\left(\\frac{\\partial \\phi}{\\partial x}\\right) = -\\frac{\\partial^2 \\phi}{\\partial x \\partial y} + \\frac{\\partial^2 \\phi}{\\partial y \\partial x}\n$$\n根据克莱罗定理（Clairaut's theorem）关于混合偏导数相等的定理，如果 $\\phi$ 具有连续的二阶偏导数，那么 $\\frac{\\partial^2 \\phi}{\\partial x \\partial y} = \\frac{\\partial^2 \\phi}{\\partial y \\partial x}$。因此，$\\nabla \\cdot \\mathbf{v}_E = 0$。\n\n问题要求我们研究该性质的离散形式。我们使用一个间距为 $\\Delta x$ 和 $\\Delta y$ 的均匀网格，以及偏导数的中心差分算子：\n$$\nD_x g_{i,j} = \\frac{g_{i+1,j} - g_{i-1,j}}{2\\,\\Delta x}, \\quad D_y g_{i,j} = \\frac{g_{i,j+1} - g_{i,j-1}}{2\\,\\Delta y}\n$$\n这些算子作用于网格函数 $g_{i,j}$ 并利用周期性边界条件。离散速度分量被一致地定义为 $v_x = -D_y \\phi$ 和 $v_y = D_x \\phi$。离散散度则为：\n$$\n(D_x v_x + D_y v_y)_{i,j} = D_x(-D_y \\phi)_{i,j} + D_y(D_x \\phi)_{i,j} = (-D_x D_y + D_y D_x)\\phi_{i,j}\n$$\n这些特定有限差分算子在均匀网格上的一个基本性质是它们是可交换的，即对于任何网格函数 $g$，都有 $D_x D_y g = D_y D_x g$。这可以通过展开算子来证明。因此，离散E×B速度的离散散度 $(D_y D_x - D_x D_y)\\phi$ 在精确算术中必须恒等于零。在浮点计算中获得的任何非零结果都将归因于舍入误差。指标 $m_1$ 和 $m_2$ 旨在测量此数值误差的大小。\n- $m_1 = \\max_{i,j}\\left|\\left(D_x v_x + D_y v_y\\right)_{i,j}\\right|$ 测量最大逐点误差。\n- $m_2 = \\sqrt{\\sum_{i,j} \\left(D_x v_x + D_y v_y\\right)_{i,j}^2\\,\\Delta x\\,\\Delta y}$ 在 $L^2$ 意义上测量网格积分误差。\n我们预计 $m_1$ 和 $m_2$ 都应在机器精度的数量级。\n\n其次，我们考虑标量 $f$ 被速度场 $\\mathbf{v}_E$ 平流的情况。平流项 $\\mathbf{v}_E \\cdot \\nabla f$ 可以使用矢量恒等式 $\\mathbf{v}\\cdot\\nabla f = \\nabla\\cdot(f\\,\\mathbf{v}) - f\\,(\\nabla\\cdot\\mathbf{v})$ 写成“通量形式”或“守恒形式”。由于 $\\nabla \\cdot \\mathbf{v}_E = 0$，这简化为 $\\mathbf{v}_E \\cdot \\nabla f = \\nabla \\cdot (f \\mathbf{v}_E)$。项 $\\nabla \\cdot (f \\mathbf{v}_E)$ 是通量 $f \\mathbf{v}_E$ 的散度。\n\n问题以这种守恒通量形式定义了离散平流算子：\n$$\n\\mathcal{A}(f,\\phi) \\equiv D_x\\!\\left(f\\,v_x\\right) + D_y\\!\\left(f\\,v_y\\right)\n$$\n这是离散通量矢量 $(f v_x, f v_y)$ 的离散散度。守恒格式的一个关键性质是它们不应在区域内虚假地产生或破坏被平流的总量 $f$。总量是区域积分，在离散情况下是和 $\\sum_{i,j} f_{i,j} \\Delta x \\Delta y$。该总量的变化率由平流项在整个区域上的和给出：$\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j} \\Delta x \\Delta y$。\n\n根据周期性区域上散度定理的离散等价形式，离散散度在所有网格单元上的总和必须为零。我们来考察 $x$ 分量的和：\n$$\n\\sum_{i,j} D_x(f v_x)_{i,j} = \\sum_j \\left( \\sum_i \\frac{(f v_x)_{i+1,j} - (f v_x)_{i-1,j}}{2\\Delta x} \\right)\n$$\n内层对索引 $i$ 的求和是一个伸缩求和。由于周期性边界条件，对于每个带正号出现的项 $(f v_x)_{k,j}$，它也会（在移动两个索引后）带负号出现，导致总和恒等于零。同样的逻辑适用于 $y$ 分量。因此，在精确算术中，总和必须为零。指标 $m_3$ 测量用浮点数计算的这个和的绝对值：\n$$\nm_3 = \\left|\\sum_{i,j} \\mathcal{A}(f,\\phi)_{i,j}\\,\\Delta x\\,\\Delta y\\right|\n$$\n我们预计 $m_3$ 也将在机器精度的数量级，这证实了该数值格式是守恒的。\n\n实现将通过为每个测试用例定义网格和场，应用离散算子计算速度、其散度以及通量形式的平流，最后计算三个指标 $m_1, m_2$ 和 $m_3$ 来进行。\n在所有情况下，预计这些指标都会非常小，接近浮点零。对于情况2，其中 $\\phi$ 是常数，速度场解析上为零，所以所有指标都应精确为 $0.0$。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and verifies a conservative discretization of the E×B nonlinear advection term.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"id\": 1,\n            \"Nx\": 64, \"Ny\": 65, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(3 * x) * np.cos(4 * y),\n            \"f_func\": lambda x, y: np.cos(2 * x) * np.sin(3 * y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 2,\n            \"Nx\": 4, \"Ny\": 4, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.full_like(x, 0.37),\n            \"f_func\": lambda x, y: np.sin(x) + np.cos(y),\n            \"is_random\": False\n        },\n        {\n            \"id\": 3,\n            \"Nx\": 33, \"Ny\": 31, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": lambda x, y: np.sin(5 * x) + np.sin(7 * y),\n            \"f_func\": lambda x, y: np.ones_like(x),\n            \"is_random\": False\n        },\n        {\n            \"id\": 4,\n            \"Nx\": 128, \"Ny\": 128, \"Lx\": 2 * np.pi, \"Ly\": 2 * np.pi,\n            \"phi_func\": None, # Will be generated randomly\n            \"f_func\": None,   # Will be generated randomly\n            \"is_random\": True,\n            \"seed\": 42\n        }\n    ]\n\n    # Helper functions for central differences with periodic boundaries\n    def central_diff_x(g, dx):\n        \"\"\"Computes the central difference derivative along the x-axis (axis 0).\"\"\"\n        return (np.roll(g, -1, axis=0) - np.roll(g, 1, axis=0)) / (2 * dx)\n\n    def central_diff_y(g, dy):\n        \"\"\"Computes the central difference derivative along the y-axis (axis 1).\"\"\"\n        return (np.roll(g, -1, axis=1) - np.roll(g, 1, axis=1)) / (2 * dy)\n\n    results = []\n\n    for case in test_cases:\n        # 1. Setup grid and parameters\n        Nx, Ny = case[\"Nx\"], case[\"Ny\"]\n        Lx, Ly = case[\"Lx\"], case[\"Ly\"]\n        dx, dy = Lx / Nx, Ly / Ny\n\n        x = np.linspace(0, Lx, Nx, endpoint=False)\n        y = np.linspace(0, Ly, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        # 2. Construct scalar fields phi and f\n        if case[\"is_random\"]:\n            rng = np.random.default_rng(seed=case[\"seed\"])\n            phi = rng.uniform(size=(Nx, Ny))\n            f = rng.uniform(size=(Nx, Ny))\n        else:\n            phi = case[\"phi_func\"](xx, yy)\n            f = case[\"f_func\"](xx, yy)\n        \n        # 3. Compute discrete E×B velocity components\n        # vx = -Dy(phi)\n        vx = -central_diff_y(phi, dy)\n        # vy = Dx(phi)\n        vy = central_diff_x(phi, dx)\n        \n        # 4. Compute the discrete divergence of the E×B velocity\n        div_vE = central_diff_x(vx, dx) + central_diff_y(vy, dy)\n        \n        # 5. Compute the conservative flux-form advection term\n        flux_x = f * vx\n        flux_y = f * vy\n        advection_term = central_diff_x(flux_x, dx) + central_diff_y(flux_y, dy)\n        \n        # 6. Calculate the three metrics\n        # m1: max absolute value of the discrete divergence of v_E\n        m1 = np.max(np.abs(div_vE))\n        \n        # m2: L2 norm of the divergence of v_E\n        cell_area = dx * dy\n        m2 = np.sqrt(np.sum(div_vE**2) * cell_area)\n        \n        # m3: absolute value of the domain-integrated advection\n        m3 = np.abs(np.sum(advection_term) * cell_area)\n        \n        results.append([m1, m2, m3])\n\n    # Format the final output string as specified\n    formatted_results = [f\"[{r[0]},{r[1]},{r[2]}]\" for r in results]\n    output_string = f\"[{','.join(formatted_results)}]\"\n    \n    print(output_string)\n\nsolve()\n```"
        },
        {
            "introduction": "伪谱法因其高精度而在湍流模拟中备受青睐，但也引入了独特的数值伪影，必须仔细处理。这个练习通过一个解析计算，让您亲手揭示非线性项的伪谱计算中混叠误差是如何产生的。通过从第一性原理推导并应用三分之二去混叠规则，您将对这一关键概念建立起坚实的理论直觉。",
            "id": "4205506",
            "problem": "考虑一个无碰撞的、静电的、二维周期性区域，其尺寸为 $L_x = 2\\pi$ 和 $L_y = 2\\pi$，并存在一个沿 $\\hat{\\mathbf{z}}$ 方向的均匀磁场。在无量纲单位下，并将恒定磁场强度设为1，由静电势 $\\phi(x,y)$ 引起的标量涨落 $g(x,y)$ 的非线性电场-磁场 ($E \\times B$) 平流项可以写成泊松括号的形式\n$$\nJ(\\phi,g) \\equiv \\hat{\\mathbf{z}} \\times \\nabla \\phi \\cdot \\nabla g \\;=\\; \\partial_{x}\\phi\\,\\partial_{y}g \\;-\\; \\partial_{y}\\phi\\,\\partial_{x}g \\, .\n$$\n您将使用伪谱法在一个 $N_x \\times N_y$ 网格上计算此非线性项，其中 $N_x = N_y = 12$ 且每个方向上有等间距点，并采用复指数傅里叶级数约定\n$$\nf(x,y) \\;=\\; \\sum_{k_x=-N_x/2}^{N_x/2-1} \\sum_{k_y=-N_y/2}^{N_y/2-1} \\hat{f}_{k_x,k_y}\\,\\exp\\!\\big(i(k_x x + k_y y)\\big) \\, ,\n$$\n其中 $k_x$ 和 $k_y$ 是整数，您应在每个方向上取主波数集 $\\{-6,-5,\\ldots,5\\}$。伪谱法计算指的是在谱空间中精确计算空间导数，变换到物理空间在网格上逐点进行乘积，然后使用离散傅里叶变换 (DFT) 将乘积变换回谱空间。\n\n设场为具有实数振幅的单傅里叶模式，\n$$\n\\phi(x,y) \\;=\\; \\Phi_0 \\,\\cos(4x + 2y) \\, , \\qquad g(x,y) \\;=\\; G_0 \\,\\cos(3x + 5y) \\, ,\n$$\n其中 $\\Phi_0$ 和 $G_0$ 是实常数。由于有限网格上的 DFT 会将波数在 $x$ 和 $y$ 方向上相差 $N_x$ 和 $N_y$ 整数倍的序列视为相同，二次乘积会产生混叠现象，即不可表示波数上的谱能量会出现在不同的可表示波数上。\n\n从上述定义和 $J(\\phi,g)$ 的 $E \\times B$ 平流形式出发，并完全基于傅里叶分析和离散采样的第一性原理，完成以下任务：\n\n1. 推导 $J(\\phi,g)$ 在所得波矢量下的精确连续表达式（用三角函数表示），然后将 $J(\\phi,g)$ 表示为复指数形式，以确定其连续傅里叶系数。\n2. 使用 $12 \\times 12$ 网格采样和上述指定的主波数集，确定在施加任何去混叠处理之前，伪谱法在波矢量 $\\big(-5,-5\\big)$ 处产生的复傅里叶系数 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$。您的结果必须是关于 $\\Phi_0$ 和 $G_0$ 的解析表达式。\n3. 通过在 DFT 之后截断非线性项来应用三分之二去混叠规则：当 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 时（对于此网格，$N_x/3 = N_y/3 = 4$），设 $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$。确定去混叠后的复傅里叶系数 $\\widehat{J}_{-5,-5}^{(2/3)}$。\n\n您的最终答案必须是在应用三分之二去混叠规则前后，在 $\\big(-5,-5\\big)$ 处的复傅里叶系数对，排列成一个单行矩阵。不需要数值近似；请给出精确的符号表达式。如果需要任何四舍五入，将需要指定有效数字，但此处不需要。",
            "solution": "用户提供的问题是有效的，因为它具有科学依据、问题明确、客观，并包含获得唯一解所需的所有信息。$E \\times B$ 非线性、伪谱法和混叠等概念是计算等离子体物理学中的标准内容。我们接下来进行详细求解。\n\n该问题要求计算非线性 $E \\times B$ 平流项在有和没有去混叠过程下的特定傅里叶系数。平流项由泊松括号给出 $J(\\phi,g) = \\partial_{x}\\phi\\,\\partial_{y}g - \\partial_{y}\\phi\\,\\partial_{x}g$。\n\n设给定的标量场为：\n$$ \\phi(x,y) = \\Phi_0 \\cos(4x + 2y) $$\n$$ g(x,y) = G_0 \\cos(3x + 5y) $$\n\n**第1部分：$J(\\phi,g)$ 的精确连续表达式及其傅里叶系数**\n\n首先，我们计算 $\\phi(x,y)$ 和 $g(x,y)$ 的空间导数。\n$$ \\partial_{x}\\phi = -4\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{y}\\phi = -2\\Phi_0 \\sin(4x + 2y) $$\n$$ \\partial_{x}g = -3G_0 \\sin(3x + 5y) $$\n$$ \\partial_{y}g = -5G_0 \\sin(3x + 5y) $$\n接下来，我们将这些代入 $J(\\phi,g)$ 的表达式中：\n$$ J(\\phi,g) = (\\partial_{x}\\phi)(\\partial_{y}g) - (\\partial_{y}\\phi)(\\partial_{x}g) $$\n$$ J(\\phi,g) = \\big(-4\\Phi_0 \\sin(4x + 2y)\\big)\\big(-5G_0 \\sin(3x + 5y)\\big) - \\big(-2\\Phi_0 \\sin(4x + 2y)\\big)\\big(-3G_0 \\sin(3x + 5y)\\big) $$\n$$ J(\\phi,g) = 20\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) - 6\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\sin(4x + 2y)\\sin(3x + 5y) $$\n为了确定傅里叶模式，我们使用积化和差三角恒等式 $\\sin(A)\\sin(B) = \\frac{1}{2}[\\cos(A-B) - \\cos(A+B)]$。令 $A = 4x+2y$ 且 $B = 3x+5y$。\n则 $A-B = (4x+2y) - (3x+5y) = x - 3y$，且 $A+B = (4x+2y) + (3x+5y) = 7x + 7y$。\n将此代入 $J(\\phi,g)$ 的表达式中：\n$$ J(\\phi,g) = 14\\Phi_0 G_0 \\left( \\frac{1}{2}\\big[\\cos(x - 3y) - \\cos(7x + 7y)\\big] \\right) $$\n$$ J(\\phi,g) = 7\\Phi_0 G_0 \\big(\\cos(x - 3y) - \\cos(7x + 7y)\\big) $$\n这是 $J(\\phi,g)$ 的精确连续表达式。为了求其傅里叶系数，我们使用 $\\cos(\\theta) = \\frac{1}{2}(\\exp(i\\theta) + \\exp(-i\\theta))$ 将其表示为复指数形式。\n$$ J(x,y) = 7\\Phi_0 G_0 \\left( \\frac{\\exp(i(x - 3y)) + \\exp(-i(x - 3y))}{2} - \\frac{\\exp(i(7x + 7y)) + \\exp(-i(7x + 7y))}{2} \\right) $$\n$$ J(x,y) = \\frac{7}{2}\\Phi_0 G_0 \\exp(i(x - 3y)) + \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(x - 3y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(i(7x + 7y)) - \\frac{7}{2}\\Phi_0 G_0 \\exp(-i(7x + 7y)) $$\n通过将其与傅里叶级数形式 $f(x,y) = \\sum_{k_x, k_y} \\hat{f}_{k_x, k_y} \\exp(i(k_x x + k_y y))$ 匹配，我们可以确定波矢量 $\\mathbf{k} = (k_x, k_y)$ 处的非零连续傅里叶系数 $\\hat{J}_{k_x,k_y}$：\n$$ \\hat{J}_{1,-3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-1,3} = \\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n$$ \\hat{J}_{-7,-7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n所有其他连续傅里叶系数均为零。\n\n**第2部分：伪谱系数 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}}$**\n\n伪谱法涉及将场变换到实空间网格上，逐点进行乘法运算，然后将乘积变换回谱空间。在有限网格上，此过程可能导致混叠，即来自不可表示的高波数的能量被错误地映射到可表示的低波数上。\n\n该网格有 $N_x=12$ 和 $N_y=12$ 个点。可表示的波数集合为 $k_x, k_y \\in \\{-6, -5, \\dots, 5\\}$。$\\phi$（模式在 $\\mathbf{k}_\\phi = \\pm(4,2)$）和 $g$（模式在 $\\mathbf{k}_g = \\pm(3,5)$）的非线性相互作用产生和与差的波数：$\\pm \\mathbf{k}_\\phi \\pm \\mathbf{k}_g$。这些是 $\\pm(7,7)$ 和 $\\pm(1,-3)$。\n\n我们来检查这些“真实”波数中哪些在网格上是可表示的：\n- $\\mathbf{k} = (1,-3)$: $k_x=1$ 和 $k_y=-3$ 都在 $[-6,5]$ 范围内。此模式是可表示的。\n- $\\mathbf{k} = (-1,3)$: $k_x=-1$ 和 $k_y=3$ 都在 $[-6,5]$ 范围内。此模式是可表示的。\n- $\\mathbf{k} = (7,7)$: $k_x=7$ 和 $k_y=7$ 都在 $[-6,5]$ 范围之外。此模式是不可表示的，并且会发生混叠。\n- $\\mathbf{k} = (-7,-7)$: $k_x=-7$ 和 $k_y=-7$ 都在 $[-6,5]$ 范围之外。此模式也是不可表示的，并且会发生混叠。\n\n如果 $k' = k + mN$（其中 $m$ 为某个整数，$N$ 为该方向上的网格点数），则波数 $k$ 会混叠到主集合中的波数 $k'$。\n对于 $\\mathbf{k} = (7,7)$ 和 $N_x=N_y=12$：\n- $k_x = 7$: 混叠后的波数为 $k_x' = 7 - 1 \\cdot 12 = -5$。\n- $k_y = 7$: 混叠后的波数为 $k_y' = 7 - 1 \\cdot 12 = -5$。\n因此，在 $\\mathbf{k}=(7,7)$ 处的模式会混叠到 $\\mathbf{k}_{alias} = (-5,-5)$。\n\n对于 $\\mathbf{k} = (-7,-7)$:\n- $k_x = -7$: 混叠后的波数为 $k_x' = -7 + 1 \\cdot 12 = 5$。\n- $k_y = -7$: 混叠后的波数为 $k_y' = -7 + 1 \\cdot 12 = 5$。\n因此，在 $\\mathbf{k}=(-7,-7)$ 处的模式会混叠到 $\\mathbf{k}_{alias} = (5,5)$。\n\n网格上给定波矢量 $\\mathbf{k}$ 处的伪谱系数 $\\widehat{J}_{\\mathbf{k}}^{(\\mathrm{ps})}$，是 $\\mathbf{k}$ 处的真实连续系数与所有混叠到 $\\mathbf{k}$ 的其他波数的真实系数之和。\n我们关心的是在 $\\mathbf{k} = (-5,-5)$ 处的系数。\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{-5,-5} + \\hat{J}_{7,7} + \\hat{J}_{-17,-17} + \\dots $$\n根据我们的分析，真实系数 $\\hat{J}_{-5,-5}$ 为零。唯一一个混叠到 $(-5,-5)$ 的非零真实系数是 $\\hat{J}_{7,7}$。\n因此，在 $(-5,-5)$ 处的总伪谱系数等于在 $(7,7)$ 处的真实系数。\n$$ \\widehat{J}_{-5,-5}^{(\\mathrm{ps})} = \\hat{J}_{7,7} = -\\frac{7}{2}\\Phi_0 G_0 $$\n\n**第3部分：去混叠系数 $\\widehat{J}_{-5,-5}^{(2/3)}$**\n\n该问题指定了一种去混叠程序，该程序包括截断伪谱法计算的非线性项。规则是当 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 时，设 $\\widehat{J}_{k_x,k_y}^{(2/3)} = 0$。\n对于我们的网格，$N_x = N_y = 12$，因此截断条件是 $|k_x| > 4$ 或 $|k_y| > 4$。\n\n我们将此规则应用于在 $\\mathbf{k} = (-5,-5)$ 处的系数。我们检查该波矢量是否满足截断条件：\n- 对于 $k_x = -5$，我们有 $|k_x| = |-5| = 5$。由于 $5 > 4$，$|k_x| > N_x/3$ 的条件得到满足。\n- 对于 $k_y = -5$，我们有 $|k_y| = |-5| = 5$。由于 $5 > 4$， $|k_y| > N_y/3$ 的条件也得到满足。\n\n由于波矢量 $(-5,-5)$ 满足该条件（只要有一个分量满足即可），因此去混叠场中相应的系数必须设为零。\n$$ \\widehat{J}_{-5,-5}^{(2/3)} = 0 $$\n此过程有效地滤除了出现在 $\\mathbf{k}=(-5,-5)$ 处的混叠能量。\n\n最终答案是系数 $\\widehat{J}_{-5,-5}^{(\\mathrm{ps})}$ 和 $\\widehat{J}_{-5,-5}^{(2/3)}$ 对。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n-\\frac{7}{2}\\Phi_0 G_0 & 0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "理解能量如何在不同尺度之间转移是湍流研究的核心。这个实践将理论与应用相结合，要求您利用谱方法来计算非线性 $E \\times B$ 平流项所驱动的谱空间能量转移。通过完成这项任务，您将学会如何从模拟快照中提取关键的物理洞见，这是分析等离子体湍流能量级串的标准诊断工具。",
            "id": "4205469",
            "problem": "给定一个方形域上的二维、周期性、静电回旋动理学（GK）快照。在归一化单位下，电场 $E$ 跨越磁场 $B$ 的垂直平流产生了非线性的 $E \\times B$ 项。对于一个由不可压缩速度 $v_E = \\hat{z} \\times \\nabla \\phi$ 平流的广义场 $g(x,y)$，守恒形式的非线性项是 $x$-$y$ 空间中的泊松括号 $\\{\\phi,g\\}$。您将为特定的快照定义并计算由此括号导出的谱非线性能量转移 $T(k_r,k_\\theta)$，然后将其聚合到波数大小 $k_r$ 和极角 $k_\\theta$ 的极坐标 bin 中。\n\n出发的基本基础：\n- 周期性平板域，$x \\in [0,2\\pi)$ 且 $y \\in [0,2\\pi)$。\n- 归一化的不可压缩平流速度为 $v_E = \\hat{z} \\times \\nabla \\phi$，因此非线性项是泊松括号\n$$\n\\{\\phi, g\\} = \\partial_x \\phi \\, \\partial_y g - \\partial_y \\phi \\, \\partial_x g.\n$$\n- 傅里叶模式 $(k_x,k_y)$ 的非线性能量转移需要直接从括号的定义、实空间能量密度以及周期函数的傅里叶变换性质推断出来。您必须使用快速傅里叶变换（FFT）和周期性边界条件。\n\n您的程序必须为每个测试用例计算以下内容：\n1. 使用提供的 $\\phi(x,y)$ 和 $g(x,y)$ 的解析形式，在 $[0,2\\pi)\\times[0,2\\pi)$ 上大小为 $N_x \\times N_y$ 的均匀网格上构建场。\n2. 通过在傅里叶空间中乘以 $i k_x$ 和 $i k_y$，以谱方法计算 $\\phi$ 和 $g$ 的空间导数。\n3. 在实空间中构建泊松括号场 $\\{\\phi,g\\}(x,y)$，并将其变换回傅里叶空间以获得非线性谱内容。\n4. 根据在没有源和汇的情况下二次能量 $\\frac{1}{2} \\sum_{k_x,k_y} |g_{k_x,k_y}|^2$ 守恒的含义，仅使用括号和场 $g$ 为每个傅里叶模式定义谱非线性能量转移密度 $T(k_x,k_y)$，然后通过将所有大小和角度落入相应 bin 的 $(k_x,k_y)$ 的贡献求和，将 $T$ 聚合到极坐标 bin $T(k_r,k_\\theta)$ 中。角度必须以弧度计算。\n5. 通过将 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 的傅里叶模式置零，对两个场在形成导数之前以及对括号的光谱一致地应用标准的三分之二去混叠规则，以使模式相互作用保持在解析尺度内。\n6. 对于每个测试用例，计算：\n   - 所有谱模式的总非线性转移之和，\n   $$\n   S = \\sum_{k_x,k_y} T(k_x,k_y),\n   $$\n   这应该反映平流的不可压缩性质。\n   - 分箱后的 $T(k_r,k_\\theta)$ 中的最大绝对值，\n   $$\n   M = \\max_{r,\\theta} \\left| T(k_r,k_\\theta) \\right|.\n   $$\n   - 出现最大绝对值的 bin 的索引 $(r_\\star,\\theta_\\star)$，其中 $r_\\star$ 是 $[0, N_r-1]$ 中的整数，$\\theta_\\star$ 是 $[0, N_\\theta-1]$ 中的整数。\n\n分箱细节：\n- 使用 $N_r$ 个均匀间隔的径向 bin，覆盖 $[0,k_{\\max}]$，其中 $k_{\\max} = \\max \\sqrt{k_x^2 + k_y^2}$ 是整个网格上的最大值。\n- 使用 $N_\\theta$ 个均匀间隔的角度 bin，覆盖 $[-\\pi,\\pi]$（以弧度为单位）。\n- 使用标准的半开区间将 $(k_x,k_y)$ 分配到 bin 中，但最后一个 bin 包含最右边的边界。如果一个模式恰好位于边界上，则将其分配到上一个 bin，但对于最终边界，它被分配到最后一个 bin。\n\n数值和单位约定：\n- 所有量都是无量纲的，与归一化的 GK 平板和 $2\\pi$ 周期性一致。角度必须以弧度计算和分箱。\n- 在周期性网格上通过傅里叶变换使用谱微分法。\n- 如上所述，使用三分之二去混叠法。\n\n测试套件：\n对于每个测试用例 $i$，给定 $(N_x,N_y)$、振幅 $A$ 和 $B$、$\\phi(x,y)$ 和 $g(x,y)$ 的解析形式，以及 bin 计数 $(N_r,N_\\theta)$。\n- 用例 1（一般相互作用）：$N_x=16$， $N_y=16$， $A=1.0$， $B=0.8$，\n  $$\n  \\phi(x,y) = A \\cos(2 x)\\cos(y), \\quad g(x,y) = B \\sin(x)\\sin(2 y),\n  $$\n  $N_r=4$, $N_\\theta=4$。\n- 用例 2（各向异性激励）：$N_x=32$， $N_y=16$， $A=0.9$， $B=0.7$，\n  $$\n  \\phi(x,y) = A\\left[\\cos(3 x) + 0.5\\cos(4 y)\\right], \\quad g(x,y) = B \\cos(3 x)\\sin(y),\n  $$\n  $N_r=5$, $N_\\theta=8$。\n- 用例 3（自括号边缘情况）：$N_x=8$， $N_y=8$， $A=1.0$， $B=1.0$，\n  $$\n  \\phi(x,y) = A \\sin(2 x)\\sin(3 y), \\quad g(x,y) = B \\sin(2 x)\\sin(3 y),\n  $$\n  $N_r=3$, $N_\\theta=6$。\n\n最终输出格式：\n- 对于每个测试用例，返回一个列表 $[S, M, r_\\star, \\theta_\\star]$，其中 $S$ 和 $M$ 是四舍五入到小数点后 $10$ 位的浮点数，$r_\\star$ 和 $\\theta_\\star$ 是整数。\n- 您的程序应生成单行输出，其中包含这些列表的逗号分隔列表形式的结果，并用方括号括起来，例如：\n```\n[[S_1,M_1,r_1,theta_1],[S_2,M_2,r_2,theta_2],[S_3,M_3,r_3,theta_3]]\n```\n.",
            "solution": "本问题的核心是计算由非线性E×B平流项引起的谱空间能量转移。该过程基于以下物理和数学原理。\n\n**1. 控制方程与能量守恒**\n由不可压缩速度场 $\\mathbf{v}_E$ 平流的标量场 $g$ 的演化由以下方程描述：\n$$\n\\frac{\\partial g}{\\partial t} + \\mathbf{v}_E \\cdot \\nabla g = 0\n$$\n将 $\\mathbf{v}_E = \\hat{\\mathbf{z}} \\times \\nabla \\phi$ 代入，平流项变为泊松括号的负值，因此控制方程为：\n$$\n\\frac{\\partial g}{\\partial t} - \\{\\phi, g\\} = 0\n$$\n系统的总“能量”定义为 $E_{total} = \\frac{1}{2} \\int g^2 \\,dx\\,dy$。其时间变化率为：\n$$\n\\frac{dE_{total}}{dt} = \\int g \\frac{\\partial g}{\\partial t} \\,dx\\,dy = \\int g \\{\\phi, g\\} \\,dx\\,dy\n$$\n通过分部积分和利用周期性边界条件，可以证明积分 $\\int g \\{\\phi, g\\} \\,dx\\,dy = 0$。这意味着总能量是守恒的。非线性项本身不产生或消耗能量，它只在不同尺度的模式之间重新分配能量。因此，所有谱模式的能量转移之和必须为零，即 $S = \\sum_{k_x,k_y} T(k_x,k_y) = 0$。这是验证数值实现正确性的一个关键指标。\n\n**2. 谱空间能量转移**\n为了分析能量如何在不同尺度（即不同波数）之间转移，我们切换到傅里叶空间。场的演化方程变为：\n$$\n\\frac{\\partial \\hat{g}_k}{\\partial t} = \\widehat{\\{\\phi,g\\}}_k\n$$\n其中 $\\hat{g}_k$ 是 $g$ 在波数矢量 $\\mathbf{k}=(k_x, k_y)$ 处的傅里叶系数，$\\widehat{\\{\\phi,g\\}}_k$ 是泊松括号的傅里叶系数。\n波数 $\\mathbf{k}$ 模式的能量为 $E_k \\propto |\\hat{g}_k|^2$。其变化率定义了该模式的谱能量转移率 $T_k$：\n$$\nT_k = \\frac{d}{dt} \\left(\\frac{1}{2} |\\hat{g}_k|^2\\right) = \\text{Re}\\left(\\hat{g}_k^* \\frac{\\partial \\hat{g}_k}{\\partial t}\\right)\n$$\n将演化方程代入，我们得到计算谱转移的最终公式：\n$$\nT(k_x, k_y) = \\text{Re}\\left( \\hat{g}_{k_x,k_y}^* \\cdot \\widehat{\\{\\phi,g\\}}_{k_x,k_y} \\right)\n$$\n\n**3. 伪谱法与去混叠**\n直接在傅里叶空间中计算 $\\widehat{\\{\\phi,g\\}}_k$ 需要进行卷积，计算成本高昂。伪谱法提供了一种高效的替代方案：\n1. 在傅里叶空间中计算导数的谱（例如，$\\widehat{\\partial_x \\phi} = i k_x \\hat{\\phi}$）。\n2. 将这些导数的谱逆变换回实空间。\n3. 在实空间中执行乘法和减法以计算 $\\{\\phi,g\\}$。\n4. 将得到的实空间场 $\\{\\phi,g\\}$ 正变换回傅里叶空间，得到 $\\widehat{\\{\\phi,g\\}}_k$。\n\n然而，实空间中的乘法会产生混叠（aliasing）误差。为避免这种情况，我们采用**三分之二去混叠规则**：在进行任何非线性计算之前和之后，将所有满足 $|k_x| > N_x/3$ 或 $|k_y| > N_y/3$ 的傅里叶模式的系数置零。这确保了所有非线性相互作用的产物都落在可解析的波数范围内。\n\n**4. 极坐标分箱**\n最后一步是将二维的谱转移 $T(k_x, k_y)$ 聚合到极坐标 $(k_r, k_\\theta)$ 的 bin 中，以分析能量转移对尺度大小 ($k_r$) 和方向 ($k_\\theta$) 的依赖性。我们将每个 $(k_x, k_y)$ 模式的 $T(k_x, k_y)$ 值累加到其对应的 $(k_r, k_\\theta)$ bin 中，从而得到 $T(k_r, k_\\theta)$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import __version__ as scipy_version  # Used only for complying with problem spec on libraries\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases for nonlinear spectral energy transfer.\n    \"\"\"\n\n    def compute_transfer(case):\n        \"\"\"\n        Computes the nonlinear transfer for a single test case.\n        \"\"\"\n        Nx, Ny, A, B, phi_func, g_func, Nr, Ntheta = case\n\n        # 1. Grid and Field Setup\n        x = np.linspace(0, 2 * np.pi, Nx, endpoint=False)\n        y = np.linspace(0, 2 * np.pi, Ny, endpoint=False)\n        xx, yy = np.meshgrid(x, y, indexing='ij')\n\n        phi = phi_func(xx, yy, A)\n        g = g_func(xx, yy, B)\n\n        # 2. Wavenumber Grids\n        kx = np.fft.fftfreq(Nx) * Nx\n        ky = np.fft.fftfreq(Ny) * Ny\n        kxx, kyy = np.meshgrid(kx, ky, indexing='ij')\n\n        # 3. FFTs of the fields\n        phi_k = np.fft.fft2(phi)\n        g_k = np.fft.fft2(g)\n\n        # 4. De-aliasing (2/3 rule)\n        k_max_x_dealias = Nx / 3.0\n        k_max_y_dealias = Ny / 3.0\n        dealias_mask = (np.abs(kxx) = k_max_x_dealias)  (np.abs(kyy) = k_max_y_dealias)\n        \n        phi_k_dealiased = phi_k * dealias_mask\n        g_k_dealiased = g_k * dealias_mask\n\n        # 5. Spectral Derivatives\n        dphi_dx_k = 1j * kxx * phi_k_dealiased\n        dphi_dy_k = 1j * kyy * phi_k_dealiased\n        dg_dx_k = 1j * kxx * g_k_dealiased\n        dg_dy_k = 1j * kyy * g_k_dealiased\n\n        # 6. Inverse FFT to get real-space derivatives\n        dphi_dx = np.fft.ifft2(dphi_dx_k).real\n        dphi_dy = np.fft.ifft2(dphi_dy_k).real\n        dg_dx = np.fft.ifft2(dg_dx_k).real\n        dg_dy = np.fft.ifft2(dg_dy_k).real\n\n        # 7. Poisson Bracket\n        poisson_bracket = dphi_dx * dg_dy - dphi_dy * dg_dx\n\n        # 8. Spectrum of the bracket\n        poisson_bracket_k = np.fft.fft2(poisson_bracket)\n        poisson_bracket_k_dealiased = poisson_bracket_k * dealias_mask\n\n        # 9. Spectral Energy Transfer T(k_x, k_y)\n        T_k = np.real(np.conj(g_k_dealiased) * poisson_bracket_k_dealiased)\n\n        # 10. Total Transfer S\n        S = np.sum(T_k)\n\n        # 11. Binning\n        kr = np.sqrt(kxx**2 + kyy**2)\n        ktheta = np.arctan2(kyy, kxx)\n\n        # Flatten arrays for easier indexing\n        T_k_flat = T_k.flatten()\n        kr_flat = kr.flatten()\n        ktheta_flat = ktheta.flatten()\n\n        k_max_val = np.max(kr_flat)\n        \n        # Define bin edges. k_max_val=0 is a special case.\n        if k_max_val > 0:\n            r_bins = np.linspace(0, k_max_val, Nr + 1)\n        else: # Handle case of zero field\n            r_bins = np.zeros(Nr + 1)\n            \n        theta_bins = np.linspace(-np.pi, np.pi, Ntheta + 1)\n        \n        # Get bin indices for each k-mode\n        r_indices = np.digitize(kr_flat, r_bins) - 1\n        theta_indices = np.digitize(ktheta_flat, theta_bins) - 1\n\n        # Clip indices to be within [0, N-1] to handle edges correctly\n        # The specified rule puts values on the last edge into the last bin.\n        # np.digitize puts x=bins[-1] into bin N, so clipping to N-1 is correct.\n        r_indices = np.clip(r_indices, 0, Nr - 1)\n        theta_indices = np.clip(theta_indices, 0, Ntheta - 1)\n\n        # Sum T_k into the polar bins\n        T_binned = np.zeros((Nr, Ntheta))\n        np.add.at(T_binned, (r_indices, theta_indices), T_k_flat)\n\n        # 12. Find max absolute value and its indices\n        abs_T_binned = np.abs(T_binned)\n        M = np.max(abs_T_binned)\n        \n        # np.argmax returns the first occurrence in case of ties.\n        max_loc_flat = np.argmax(abs_T_binned)\n        r_star, theta_star = np.unravel_index(max_loc_flat, abs_T_binned.shape)\n\n        return [round(S, 10), round(M, 10), int(r_star), int(theta_star)]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (16, 16, 1.0, 0.8,\n         lambda x, y, A: A * np.cos(2 * x) * np.cos(y),\n         lambda x, y, B: B * np.sin(x) * np.sin(2 * y),\n         4, 4),\n\n        (32, 16, 0.9, 0.7,\n         lambda x, y, A: A * (np.cos(3 * x) + 0.5 * np.cos(4 * y)),\n         lambda x, y, B: B * np.cos(3 * x) * np.sin(y),\n         5, 8),\n\n        (8, 8, 1.0, 1.0,\n         lambda x, y, A: A * np.sin(2 * x) * np.sin(3 * y),\n         lambda x, y, B: B * np.sin(2 * x) * np.sin(3 * y),\n         3, 6)\n    ]\n\n    results = []\n    for case in test_cases:\n        result = compute_transfer(case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\".replace(\" \", \"\"))\n\nsolve()\n```"
        }
    ]
}