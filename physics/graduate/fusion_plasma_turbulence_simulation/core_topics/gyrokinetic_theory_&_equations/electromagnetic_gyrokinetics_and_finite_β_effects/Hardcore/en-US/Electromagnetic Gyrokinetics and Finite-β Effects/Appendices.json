{
    "hands_on_practices": [
        {
            "introduction": "The transition from an electrostatic to an electromagnetic description of plasma turbulence is not arbitrary; it is dictated by the fundamental physics of pressure balance. This exercise guides you to derive a critical scaling law from first principles, revealing why the plasma beta, $\\beta$, is the key parameter governing this transition. By quantifying the error introduced when neglecting magnetic pressure fluctuations, you will solidify your understanding of the finite-$\\beta$ regime and its importance in accurately modeling plasma behavior. ",
            "id": "4188499",
            "problem": "Consider a homogeneous, tokamak-like plasma core with a uniform equilibrium magnetic field magnitude $B_0$ and a single ion species characterized by number density $n_i$ and temperature $T_i$, where $T_i$ is measured in energy units so that the ion thermal pressure is $p_{i} = n_i T_i$. Assume low-frequency, anisotropic turbulence in the electromagnetic gyrokinetic (GK) regime with $\\omega \\ll \\Omega_i$ and $k_{\\perp} \\rho_i \\sim 1$, and consider fluctuations that are small in the gyrokinetic ordering sense. In this regime, perpendicular force balance is obtained from the perpendicular component of the magnetohydrodynamics (MHD) momentum equation and the Maxwell stress tensor. \n\nStarting from the fundamental perpendicular pressure balance implied by the combination of the MHD momentum equation and Maxwell stress, and using that the leading-order magnetic pressure perturbation is $\\delta(B^2/8\\pi) \\simeq (B_0 \\,\\delta B_{\\parallel})/(4\\pi)$ for compressional magnetic fluctuations $\\delta B_{\\parallel}$, derive the leading-order balance between the perpendicular thermal pressure perturbation $\\delta p_{\\perp}$ and the compressional magnetic pressure perturbation. Then, define the ion plasma beta as the ratio of ion thermal pressure to equilibrium magnetic pressure, $\\beta_i \\equiv p_i/p_{\\mathrm{mag}}$, with $p_{\\mathrm{mag}} \\equiv B_0^2/(8\\pi)$ in Gaussian centimeter–gram–second (cgs) units. \n\nBy quantifying the effect of neglecting the compressional magnetic fluctuation $\\delta B_{\\parallel}$ in the perpendicular pressure balance, compute the leading-order fractional error, measured relative to the equilibrium magnetic pressure $p_{\\mathrm{mag}}$, that is introduced by setting $\\delta B_{\\parallel}=0$. Express your final answer as a single closed-form analytical expression in terms of $n_i$, $T_i$, and $B_0$ only. Do not include units in your final boxed expression. The result should make explicit how the error scales with $\\beta_i$ and hence identify the $\\beta$ regime in which the error is of order $\\beta$.",
            "solution": "The problem asks for the leading-order fractional error introduced in the perpendicular pressure balance by neglecting the compressional magnetic fluctuation $\\delta B_{\\parallel}$. The error is to be measured relative to the equilibrium magnetic pressure $p_{\\mathrm{mag}}$.\n\nFirst, we establish the perpendicular pressure balance equation. The problem states that in the low-frequency electromagnetic gyrokinetic regime, the perpendicular force balance is determined by the magnetohydrodynamics (MHD) momentum equation. The relevant component of this balance, perpendicular to the magnetic field direction, states that the sum of the perpendicular thermal pressure and the magnetic pressure is constant across the magnetic field lines. For a homogeneous equilibrium, this balance applies to the fluctuating quantities:\n$$\n\\delta p_{\\perp} + \\delta p_{\\mathrm{mag}} = 0\n$$\nHere, $\\delta p_{\\perp}$ is the perturbation in the perpendicular thermal pressure and $\\delta p_{\\mathrm{mag}} = \\delta(B^2/8\\pi)$ is the perturbation in the magnetic pressure. The problem provides the leading-order expression for the magnetic pressure perturbation for compressional fluctuations $\\delta B_{\\parallel}$ (fluctuations in the magnitude of the magnetic field parallel to the equilibrium field $\\mathbf{B}_0$):\n$$\n\\delta p_{\\mathrm{mag}} = \\delta \\left( \\frac{B^2}{8\\pi} \\right) \\simeq \\frac{B_0 \\delta B_{\\parallel}}{4\\pi}\n$$\nwhere $B_0$ is the magnitude of the equilibrium magnetic field. Substituting this into the pressure balance equation yields the leading-order balance between the perpendicular thermal pressure perturbation and the compressional magnetic pressure perturbation:\n$$\n\\delta p_{\\perp} + \\frac{B_0 \\delta B_{\\parallel}}{4\\pi} = 0\n$$\nThis equation represents the \"correct\" physical model in this regime.\n\nNext, we must quantify the error introduced by setting $\\delta B_{\\parallel} = 0$. Setting $\\delta B_{\\parallel} = 0$ corresponds to adopting an electrostatic model, where magnetic fluctuations are ignored. In the context of the pressure balance equation, this approximation means neglecting the term $\\frac{B_0 \\delta B_{\\parallel}}{4\\pi}$. Let's call this the \"neglected term\". The magnitude of this term is fixed by the balance equation itself:\n$$\n\\left| \\frac{B_0 \\delta B_{\\parallel}}{4\\pi} \\right| = | - \\delta p_{\\perp} | = |\\delta p_{\\perp}|\n$$\nThe problem asks for the fractional error, $\\mathcal{E}$, which is the magnitude of the neglected term measured relative to the equilibrium magnetic pressure, $p_{\\mathrm{mag}}$. The equilibrium magnetic pressure is defined as:\n$$\np_{\\mathrm{mag}} = \\frac{B_0^2}{8\\pi}\n$$\nThe fractional error is therefore:\n$$\n\\mathcal{E} = \\frac{\\left| \\text{neglected term} \\right|}{p_{\\mathrm{mag}}} = \\frac{|\\delta p_{\\perp}|}{p_{\\mathrm{mag}}}\n$$\nTo obtain a final expression in terms of equilibrium quantities ($n_i$, $T_i$, $B_0$), we must determine the characteristic magnitude of the perpendicular pressure fluctuation, $|\\delta p_{\\perp}|$. The problem describes a plasma with a single ion species, characterized by density $n_i$ and temperature $T_i$. In the gyrokinetic turbulence regime specified ($\\omega \\ll \\Omega_i$, $k_{\\perp} \\rho_i \\sim 1$), the pressure fluctuations are driven by the free energy available in the plasma, which scales with the thermal energy. Therefore, the characteristic magnitude of the ion perpendicular pressure fluctuation, $\\delta p_{\\perp i}$, is of the order of the equilibrium ion thermal pressure, $p_i$. Assuming that $\\delta p_{\\perp}$ in the balance equation is dominated by the ion contribution, we make the physically motivated substitution:\n$$\n|\\delta p_{\\perp}| \\sim p_i = n_i T_i\n$$\nwhere $T_i$ is in energy units as specified.\n\nSubstituting this characteristic magnitude into the expression for the fractional error $\\mathcal{E}$:\n$$\n\\mathcal{E} \\approx \\frac{p_i}{p_{\\mathrm{mag}}} = \\frac{n_i T_i}{B_0^2 / (8\\pi)}\n$$\nSimplifying this expression gives the final result:\n$$\n\\mathcal{E} \\approx \\frac{8\\pi n_i T_i}{B_0^2}\n$$\nThis expression represents the leading-order fractional error. The problem also asks to relate this to the ion plasma beta, $\\beta_i$, defined as the ratio of ion thermal pressure to equilibrium magnetic pressure:\n$$\n\\beta_i \\equiv \\frac{p_i}{p_{\\mathrm{mag}}} = \\frac{n_i T_i}{B_0^2 / (8\\pi)} = \\frac{8\\pi n_i T_i}{B_0^2}\n$$\nComparing our result for the fractional error with the definition of $\\beta_i$, we find that $\\mathcal{E} \\approx \\beta_i$. This confirms the final part of the problem statement: the error introduced by neglecting compressional magnetic fluctuations (i.e., by using an electrostatic approximation) is of order $\\beta_i$. This is a fundamental result in plasma physics, indicating that electromagnetic effects become significant and cannot be neglected in plasmas where the thermal pressure is a non-negligible fraction of the magnetic pressure (i.e., in a \"finite-$\\beta$\" regime). The final closed-form analytical expression for the leading-order fractional error is $\\frac{8\\pi n_i T_i}{B_0^2}$.",
            "answer": "$$\n\\boxed{\\frac{8\\pi n_i T_i}{B_0^2}}\n$$"
        },
        {
            "introduction": "Translating continuous physical laws into discrete numerical algorithms requires careful design to preserve essential properties like energy conservation. This practice challenges you to implement a numerical solver for a simplified electromagnetic gyrokinetic system that exactly conserves a discrete energy-like quantity. By deriving the system's quadratic invariant and using a structure-preserving Crank-Nicolson scheme, you will gain hands-on experience with geometric integration, a crucial technique for ensuring the long-term stability and physical fidelity of complex simulations. ",
            "id": "4188445",
            "problem": "Consider a single Fourier mode in slab geometry for electromagnetic gyrokinetics with finite plasma beta, characterized by the electrostatic potential $\\phi_k(t)$ and the parallel vector potential $A_{\\parallel,k}(t)$. Work in dimensionless normalization (all quantities are dimensionless; no physical units are used). Assume linear dynamics with adiabatic electrons and neglect compressional magnetic fluctuations so that the parallel dynamics reduces to a two-field system. Define the perpendicular wavenumber parameter $b = k_\\perp^2 \\rho_i^2$, where $\\rho_i$ is the ion Larmor radius, the ion-to-electron temperature ratio $\\tau = T_i/T_e$, and the dimensionless electron beta $\\beta_e$. The ion gyroaveraging enters through the modified Bessel function of the first kind of order $0$, denoted $I_0(b)$, via the standard gyrokinetic operator $\\Gamma_0(b) = I_0(b) e^{-b}$. The ion polarization response is $\\Lambda_i(b,\\tau) = 1 + \\tau - \\Gamma_0(b)$. The Alfvénic coupling frequency is $\\alpha(k_\\parallel,\\beta_e) = k_\\parallel/\\sqrt{\\beta_e}$.\n\nStarting from Maxwell's equations (specifically Faraday's law and Ampère's law) and gyrokinetic quasi-neutrality, the linearized spectral system for this single mode can be written as the two-dimensional ordinary differential equation\n$$\n\\frac{d}{dt}\n\\begin{pmatrix}\n\\phi_k \\\\\nA_{\\parallel,k}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}\n\\begin{pmatrix}\n\\phi_k \\\\\nA_{\\parallel,k}\n\\end{pmatrix},\n$$\nwhere $\\alpha = \\alpha(k_\\parallel,\\beta_e)$ and $\\Lambda_i = \\Lambda_i(b,\\tau)$. This system is Hamiltonian and possesses a quadratic energy-like invariant in the continuous-time limit.\n\nYour tasks are:\n- Derive, from the above physical starting point and system structure, a continuous-time quadratic invariant consistent with energy conservation for the above two-field system, expressed as a positive-definite quadratic form in $\\phi_k$ and $A_{\\parallel,k}$ with coefficients depending on $\\Lambda_i$.\n- Design a Crank–Nicolson (CN) time discretization for the system and construct a discrete quadratic invariant that is exactly preserved by the CN update. Your invariant must be expressed as a quadratic form evaluated on the discrete-time solution at time level $n$, and must reduce to the continuous invariant in the limit of vanishing time step. Explain how the skew-adjointness of the linear operator with respect to an appropriate inner product ensures exact preservation under CN.\n- Implement a program that advances the system using the CN scheme and verifies numerically that your discrete invariant remains constant in time for a set of test cases. For each test case, compute the maximum absolute relative change of the invariant over all time steps, defined as\n$$\n\\max_{0 \\leq n \\leq N} \\left| \\frac{\\mathcal{I}^{(n)} - \\mathcal{I}^{(0)}}{\\mathcal{I}^{(0)}} \\right|,\n$$\nwhere $\\mathcal{I}^{(n)}$ is your discrete invariant at step $n$ and $N$ is the total number of steps. The final results for all test cases must be printed as a single comma-separated list enclosed in square brackets, for example $[r_1,r_2,r_3]$, where each $r_i$ is a floating-point number.\n\nUse the following test suite, where each case is specified by $(k_\\parallel, k_\\perp \\rho_i, \\tau, \\beta_e, \\Delta t, N, \\phi_k(0), A_{\\parallel,k}(0))$:\n- Case $1$: $(k_\\parallel = 0.7, k_\\perp \\rho_i = 0.3, \\tau = 1.0, \\beta_e = 0.02, \\Delta t = 0.05, N = 400, \\phi_k(0) = 0.8, A_{\\parallel,k}(0) = 0.1)$.\n- Case $2$: $(k_\\parallel = 0.7, k_\\perp \\rho_i = 0.3, \\tau = 1.0, \\beta_e = 0.02, \\Delta t = 1.5, N = 100, \\phi_k(0) = 0.8, A_{\\parallel,k}(0) = 0.1)$.\n- Case $3$: $(k_\\parallel = 0.9, k_\\perp \\rho_i = 10^{-6}, \\tau = 1.0, \\beta_e = 0.05, \\Delta t = 0.07, N = 300, \\phi_k(0) = 1.0, A_{\\parallel,k}(0) = -0.5)$.\n- Case $4$: $(k_\\parallel = 0.5, k_\\perp \\rho_i = 10.0, \\tau = 2.0, \\beta_e = 0.03, \\Delta t = 0.04, N = 500, \\phi_k(0) = 0.2, A_{\\parallel,k}(0) = 0.3)$.\n- Case $5$: $(k_\\parallel = 1.2, k_\\perp \\rho_i = 0.5, \\tau = 0.7, \\beta_e = 0.005, \\Delta t = 0.2, N = 1000, \\phi_k(0) = -0.123456789, A_{\\parallel,k}(0) = 0.987654321)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[r_1,r_2,r_3,r_4,r_5]$). All quantities are dimensionless; no physical units are required.",
            "solution": "The problem is validated as scientifically grounded, well-posed, and objective. It represents a standard analysis of a simplified, linearized model in electromagnetic gyrokinetics. All necessary parameters and definitions are provided, and the tasks are clear and mathematically rigorous.\n\nWe begin by deriving the continuous-time quadratic invariant. Let the state vector be $\\mathbf{X}(t) = [\\phi_k(t), A_{\\parallel,k}(t)]^T$. The system of ordinary differential equations is given by $\\frac{d\\mathbf{X}}{dt} = \\mathbf{M}\\mathbf{X}$, where the system matrix $\\mathbf{M}$ is\n$$\n\\mathbf{M} =\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}.\n$$\nA quadratic invariant $\\mathcal{I}(t)$ can be expressed as a quadratic form $\\mathcal{I}(t) = \\mathbf{X}(t)^T \\mathbf{S} \\mathbf{X}(t)$ for some time-independent, symmetric matrix $\\mathbf{S}$. For $\\mathcal{I}(t)$ to be a conserved quantity, its time derivative must be zero:\n$$\n\\frac{d\\mathcal{I}}{dt} = \\frac{d\\mathbf{X}^T}{dt} \\mathbf{S} \\mathbf{X} + \\mathbf{X}^T \\mathbf{S} \\frac{d\\mathbf{X}}{dt} = (\\mathbf{M}\\mathbf{X})^T \\mathbf{S} \\mathbf{X} + \\mathbf{X}^T \\mathbf{S} (\\mathbf{M}\\mathbf{X}) = \\mathbf{X}^T (\\mathbf{M}^T \\mathbf{S} + \\mathbf{S} \\mathbf{M}) \\mathbf{X} = 0.\n$$\nThis equality must hold for any state vector $\\mathbf{X}$, which requires the matrix expression in the parentheses to be the zero matrix: $\\mathbf{M}^T \\mathbf{S} + \\mathbf{S} \\mathbf{M} = \\mathbf{0}$. This condition indicates that the matrix $\\mathbf{M}$ is skew-adjoint with respect to the inner product defined by the bilinear form $\\langle \\mathbf{X}, \\mathbf{Y} \\rangle_{\\mathbf{S}} = \\mathbf{X}^T \\mathbf{S} \\mathbf{Y}$. Let $\\mathbf{S} = \\begin{pmatrix} s_{11} & s_{12} \\\\ s_{12} & s_{22} \\end{pmatrix}$. The condition becomes\n$$\n\\begin{pmatrix}\n0 & -\\alpha \\Lambda_i \\\\\n\\alpha & 0\n\\end{pmatrix}\n\\begin{pmatrix}\ns_{11} & s_{12} \\\\\ns_{12} & s_{22}\n\\end{pmatrix}\n+\n\\begin{pmatrix}\ns_{11} & s_{12} \\\\\ns_{12} & s_{22}\n\\end{pmatrix}\n\\begin{pmatrix}\n0 & \\alpha \\\\\n-\\alpha \\Lambda_i & 0\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n-2 \\alpha \\Lambda_i s_{12} & \\alpha s_{11} - \\alpha \\Lambda_i s_{22} \\\\\n\\alpha s_{11} - \\alpha \\Lambda_i s_{22} & 2 \\alpha s_{12}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n0 & 0 \\\\\n0 & 0\n\\end{pmatrix}.\n$$\nFrom the off-diagonal elements, we find $\\alpha(s_{11} - \\Lambda_i s_{22}) = 0$. Assuming $\\alpha \\neq 0$, we get $s_{11} = \\Lambda_i s_{22}$. From the diagonal elements, we find $s_{12} = 0$. We can choose $s_{22} = 1$ without loss of generality, as any scalar multiple of an invariant is also an invariant. This gives the matrix $\\mathbf{S}$:\n$$\n\\mathbf{S} = \\begin{pmatrix} \\Lambda_i & 0 \\\\ 0 & 1 \\end{pmatrix}.\n$$\nThe continuous-time quadratic invariant is therefore $\\mathcal{I}(t) = \\Lambda_i \\phi_k(t)^2 + A_{\\parallel,k}(t)^2$. For this invariant to correspond to a conserved energy, the quadratic form must be positive-definite, which requires $\\Lambda_i > 0$. The parameter $\\Lambda_i = 1 + \\tau - \\Gamma_0(b)$ where $\\tau = T_i/T_e > 0$ and $b = k_\\perp^2 \\rho_i^2 \\ge 0$. The function $\\Gamma_0(b) = I_0(b)e^{-b}$ satisfies $\\Gamma_0(0)=1$ and is monotonically decreasing for $b>0$, with $\\lim_{b\\to\\infty} \\Gamma_0(b) = 0$. Thus, $0 < \\Gamma_0(b) \\le 1$ for all $b \\ge 0$. This implies $\\Lambda_i = 1 + \\tau - \\Gamma_0(b) \\ge 1 + \\tau - 1 = \\tau > 0$. Since $\\Lambda_i$ is strictly positive, the invariant $\\mathcal{I}(t)$ is a positive-definite quadratic form.\n\nNext, we design a Crank-Nicolson (CN) time discretization. The CN scheme for the system $\\frac{d\\mathbf{X}}{dt} = \\mathbf{M}\\mathbf{X}$ is an implicit method defined by\n$$\n\\frac{\\mathbf{X}^{n+1} - \\mathbf{X}^{n}}{\\Delta t} = \\frac{1}{2}\\mathbf{M}(\\mathbf{X}^{n+1} + \\mathbf{X}^{n}),\n$$\nwhere $\\mathbf{X}^n$ is the state vector at time $t_n = n\\Delta t$. Rearranging to solve for $\\mathbf{X}^{n+1}$:\n$$\n(\\mathbf{I} - \\frac{\\Delta t}{2}\\mathbf{M})\\mathbf{X}^{n+1} = (\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})\\mathbf{X}^{n}.\n$$\nThis gives the one-step update rule $\\mathbf{X}^{n+1} = \\mathbf{U} \\mathbf{X}^n$, where the update matrix $\\mathbf{U}$ is\n$$\n\\mathbf{U} = \\left(\\mathbf{I} - \\frac{\\Delta t}{2}\\mathbf{M}\\right)^{-1} \\left(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M}\\right).\n$$\nThe discrete invariant is the quadratic form evaluated at the discrete time level, $\\mathcal{I}^{(n)} = (\\mathbf{X}^n)^T \\mathbf{S} \\mathbf{X}^n = \\Lambda_i (\\phi_k^{(n)})^2 + (A_{\\parallel,k}^{(n)})^2$. We now show that this invariant is exactly preserved by the CN scheme. We must demonstrate that $\\mathcal{I}^{(n+1)} = \\mathcal{I}^{(n)}$ for all $n$.\n$$\n\\mathcal{I}^{(n+1)} = (\\mathbf{X}^{n+1})^T \\mathbf{S} \\mathbf{X}^{n+1} = (\\mathbf{U} \\mathbf{X}^n)^T \\mathbf{S} (\\mathbf{U} \\mathbf{X}^n) = (\\mathbf{X}^n)^T \\mathbf{U}^T \\mathbf{S} \\mathbf{U} \\mathbf{X}^n.\n$$\nExact conservation requires that $\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = \\mathbf{S}$, which means the update matrix $\\mathbf{U}$ must be $\\mathbf{S}$-orthogonal. This property is a direct consequence of the skew-adjointness of $\\mathbf{M}$ with respect to the $\\mathbf{S}$-inner product. Let $\\tau_{dt} = \\Delta t/2$. Then $\\mathbf{U} = (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$. We use the property $\\mathbf{M}^T\\mathbf{S} + \\mathbf{S}\\mathbf{M} = \\mathbf{0}$, which can be written as $\\mathbf{M}^T = -\\mathbf{S}\\mathbf{M}\\mathbf{S}^{-1}$.\nThe transpose of the update matrix is $\\mathbf{U}^T = ((\\mathbf{I} + \\tau_{dt}\\mathbf{M})^T)((\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1})^T = (\\mathbf{I} + \\tau_{dt}\\mathbf{M}^T)(\\mathbf{I} - \\tau_{dt}\\mathbf{M}^T)^{-1}$.\nSubstituting $\\mathbf{M}^T$:\n$$\n\\mathbf{I} \\pm \\tau_{dt}\\mathbf{M}^T = \\mathbf{I} \\mp \\tau_{dt}\\mathbf{S}\\mathbf{M}\\mathbf{S}^{-1} = \\mathbf{S}(\\mathbf{I} \\mp \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}.\n$$\nSo, $\\mathbf{U}^T = [\\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}] [\\mathbf{S}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1}]^{-1} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})\\mathbf{S}^{-1} \\mathbf{S}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1}$.\nThen, $\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = \\mathbf{S}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}\\mathbf{S}^{-1} \\mathbf{S} (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$.\nSince $(\\mathbf{I} + \\tau_{dt}\\mathbf{M})$ and $(\\mathbf{I} - \\tau_{dt}\\mathbf{M})$ commute, so do their inverses. Thus $(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1} = (\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1}(\\mathbf{I} + \\tau_{dt}\\mathbf{M})^{-1}$.\nMore simply, let $\\mathbf{A} = \\mathbf{I} - \\tau_{dt}\\mathbf{M}$ and $\\mathbf{B} = \\mathbf{I} + \\tau_{dt}\\mathbf{M}$. $\\mathbf{A}$ and $\\mathbf{B}$ commute. $\\mathbf{U} = \\mathbf{A}^{-1}\\mathbf{B}$. We showed $\\mathbf{A}^T = \\mathbf{S}\\mathbf{B}\\mathbf{S}^{-1}$ and $\\mathbf{B}^T = \\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1}$.\n$\\mathbf{U}^T = (\\mathbf{B}^T)((\\mathbf{A}^{-1})^T) = (\\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1})(\\mathbf{A}^T)^{-1} = (\\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1})(\\mathbf{S}\\mathbf{B}\\mathbf{S}^{-1})^{-1} = \\mathbf{S}\\mathbf{A}\\mathbf{S}^{-1}\\mathbf{S}\\mathbf{B}^{-1}\\mathbf{S}^{-1} = \\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{S}^{-1}$.\n$\\mathbf{U}^T \\mathbf{S} \\mathbf{U} = (\\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{S}^{-1}) \\mathbf{S} (\\mathbf{A}^{-1}\\mathbf{B}) = \\mathbf{S}\\mathbf{A}\\mathbf{B}^{-1}\\mathbf{A}^{-1}\\mathbf{B}$. Since $\\mathbf{A}$ and $\\mathbf{B}$ commute, $\\mathbf{B}^{-1}\\mathbf{A}^{-1} = \\mathbf{A}^{-1}\\mathbf{B}^{-1}$.\nSo, $\\mathbf{S}\\mathbf{A}(\\mathbf{B}^{-1}\\mathbf{A}^{-1})\\mathbf{B} = \\mathbf{S}\\mathbf{A}(\\mathbf{A}^{-1}\\mathbf{B}^{-1})\\mathbf{B} = \\mathbf{S}(\\mathbf{A}\\mathbf{A}^{-1})(\\mathbf{B}^{-1}\\mathbf{B}) = \\mathbf{S}\\mathbf{I}\\mathbf{I} = \\mathbf{S}$.\nThis confirms that the discrete invariant $\\mathcal{I}^{(n)}$ is exactly preserved by the CN scheme. This invariant has the same functional form as the continuous one; its conservation is a property of the numerical integration scheme itself.\n\nFor implementation, we construct the explicit update matrix $\\mathbf{U}$. Let $\\tau_{dt}=\\Delta t/2$, $\\alpha' = \\tau_{dt}\\alpha$, $\\Lambda_i' = \\tau_{dt}\\alpha\\Lambda_i$.\n$\\mathbf{I} - \\tau_{dt}\\mathbf{M} = \\begin{pmatrix} 1 & -\\alpha' \\\\ \\Lambda_i' & 1 \\end{pmatrix}$. Its determinant is $1+\\alpha'\\Lambda_i' = 1 + (\\Delta t/2)^2\\alpha^2\\Lambda_i$.\n$\\mathbf{I} + \\tau_{dt}\\mathbf{M} = \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix}$.\n$(\\mathbf{I} - \\tau_{dt}\\mathbf{M})^{-1} = \\frac{1}{1+\\alpha'\\Lambda_i'} \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix}$.\nThus, $\\mathbf{U} = \\frac{1}{1+(\\Delta t/2)^2\\alpha^2\\Lambda_i}(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})^2$.\n$$\n(\\mathbf{I} + \\frac{\\Delta t}{2}\\mathbf{M})^2 = \\begin{pmatrix} 1 & \\alpha' \\\\ -\\Lambda_i' & 1 \\end{pmatrix}^2 = \\begin{pmatrix} 1-\\alpha'\\Lambda_i' & 2\\alpha' \\\\ -2\\Lambda_i' & 1-\\alpha'\\Lambda_i' \\end{pmatrix}.\n$$\nThis provides an explicit formula for updating the state vector, which is then used to numerically verify the conservation of $\\mathcal{I}^{(n)}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import i0\n\ndef solve():\n    \"\"\"\n    Solves the given problem for electromagnetic gyrokinetics,\n    verifying the conservation of a discrete invariant for a Crank-Nicolson scheme.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Format: (k_parallel, k_perp_rho_i, tau, beta_e, dt, N, phi0, A0)\n    test_cases = [\n        (0.7, 0.3, 1.0, 0.02, 0.05, 400, 0.8, 0.1),\n        (0.7, 0.3, 1.0, 0.02, 1.5, 100, 0.8, 0.1),\n        (0.9, 1e-6, 1.0, 0.05, 0.07, 300, 1.0, -0.5),\n        (0.5, 10.0, 2.0, 0.03, 0.04, 500, 0.2, 0.3),\n        (1.2, 0.5, 0.7, 0.005, 0.2, 1000, -0.123456789, 0.987654321),\n    ]\n\n    results = []\n\n    for case in test_cases:\n        # 1. Unpack parameters for the current test case\n        k_parallel, k_perp_rho_i, tau, beta_e, dt, N, phi0, A0 = case\n        \n        # 2. Calculate physical constants for the system\n        # Perpendicular wavenumber parameter b\n        b = k_perp_rho_i**2\n        \n        # Ion gyroaveraging operator Gamma_0(b)\n        # Using scipy.special.i0 for the modified Bessel function I_0\n        gamma0_b = i0(b) * np.exp(-b)\n        \n        # Ion polarization response Lambda_i\n        lambda_i = 1.0 + tau - gamma0_b\n        \n        # Alfvenic coupling frequency alpha\n        alpha = k_parallel / np.sqrt(beta_e)\n        \n        # 3. Set up the Crank-Nicolson scheme\n        # The system is dX/dt = M X, where X = [phi, A_par]^T\n        # M = [[0, alpha], [-alpha * lambda_i, 0]]\n        # The CN update is X_{n+1} = U X_n, where U = (I - dt/2 M)^-1 (I + dt/2 M)\n        \n        # We pre-calculate the update matrix U\n        tau_dt = dt / 2.0\n        \n        # Denominator of the update matrix U\n        denom = 1.0 + (tau_dt**2) * (alpha**2) * lambda_i\n        \n        # Elements of B = (I + dt/2 M)\n        # B = [[1, tau_dt * alpha], [-tau_dt * alpha * lambda_i, 1]]\n        # U = (1/denom) * B^2\n        \n        # Elements of B^2\n        # B^2 = [[1 - (tau_dt*alpha)^2*lambda_i, 2*tau_dt*alpha],\n        #        [-2*tau_dt*alpha*lambda_i, 1 - (tau_dt*alpha)^2*lambda_i]]\n        \n        u11 = (1.0 - (tau_dt**2) * (alpha**2) * lambda_i) / denom\n        u12 = (2.0 * tau_dt * alpha) / denom\n        u21 = (-2.0 * tau_dt * alpha * lambda_i) / denom\n        u22 = u11\n        \n        U = np.array([\n            [u11, u12],\n            [u21, u22]\n        ])\n        \n        # 4. Initialize the simulation\n        # State vector X = [phi_k, A_parallel,k]^T\n        X = np.array([phi0, A0], dtype=np.float64)\n        \n        # The discrete invariant is I = lambda_i * phi^2 + A_par^2\n        invariant_initial = lambda_i * X[0]**2 + X[1]**2\n        \n        # List to store all relative changes of the invariant\n        relative_changes = [0.0] # At n=0, the change is 0\n        \n        # 5. Run the time evolution\n        for _ in range(N):\n            # Update the state vector\n            X = U @ X\n            \n            # Calculate the invariant at the new time step\n            invariant_current = lambda_i * X[0]**2 + X[1]**2\n            \n            # Calculate and store the absolute relative change\n            if invariant_initial != 0:\n                rel_change = np.abs((invariant_current - invariant_initial) / invariant_initial)\n                relative_changes.append(rel_change)\n            else: # Should not happen with the given test cases\n                relative_changes.append(0.0)\n\n        # 6. Find the maximum absolute relative change over all steps\n        max_rel_change = np.max(relative_changes)\n        results.append(max_rel_change)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Real fusion plasmas are inherently inhomogeneous, with properties that vary significantly across the device. This practice explores the consequences of such non-uniformity by comparing two essential modeling paradigms: the local \"flux-tube\" approximation and a more comprehensive \"global\" model. You will implement a model for an electromagnetic instability and compute its growth rate in both frameworks, directly observing how radial profile variations can alter stability predictions. This exercise highlights the limitations of local models and demonstrates the necessity of considering global effects for accurate, predictive simulations of fusion plasmas. ",
            "id": "4188487",
            "problem": "You are to design and implement a self-contained program that compares a local \"flux-tube\" estimate and a nonlocal \"global\" estimate of electromagnetic stability in a simplified large-aspect-ratio tokamak, focusing on the impact of global equilibrium variation of the safety factor and pressure profiles. The comparison is made via a dimensionless growth-rate proxy derived from first principles.\n\nSetup and fundamental base:\n- Consider a large-aspect-ratio torus with major radius to minor radius ratio specified by $R/a$. Use the normalized radial coordinate $x = r/a \\in [0,1]$.\n- Begin from the Gyrokinetic (GK) free-energy conservation law and the Magnetohydrodynamic (MHD) energy principle. In the large-aspect-ratio, shifted-circle, shear-$\\alpha$ reduction, the electromagnetic instability drive is governed by the competition between curvature-pressure drive and magnetic field-line bending (tension). The curvature drive enters through the parameter $\\alpha(x)$, and the stabilizing tension is set by the magnetic shear $s(x)$.\n- Model the safety factor profile by $q(x) = q_0 + q_1 x^2$, and define the magnetic shear by $s(x) = \\dfrac{x}{q(x)} \\dfrac{d q}{d x}$.\n- Model the pressure (represented by the plasma beta) profile by $\\beta(x) = \\beta_0 \\left(1 - x^2\\right)^p$. Use the standard large-aspect-ratio definition for the ballooning parameter $\\alpha(x)$ in this geometry as $\\alpha(x) = - q(x)^2 \\, \\dfrac{R}{a} \\, \\dfrac{d \\beta}{d x}$, recognizing that $r = a x$.\n\nPrinciple-based modeling requirement:\n- Starting from the MHD energy principle, write the perturbed potential energy as an integral of the difference between the curvature-pressure drive density and the field-line bending energy density, weighted by the mode structure. Under the large-aspect-ratio shear-$\\alpha$ reduction, represent the local differential free-energy density as a two-term model,\n  - a drive term proportional to $\\alpha(x)$, with proportionality constant $c_\\alpha$,\n  - a stabilizing term proportional to $s(x)^2$, with proportionality constant $c_s$.\n- Using these definitions, derive a scalar stability measure $\\mathcal{D}$ as the expectation value of the drive-minus-stabilization density with respect to a prescribed radial envelope of the eigenfunction.\n- Define the dimensionless growth-rate proxy by $\\gamma = \\sqrt{\\max(0,\\mathcal{D})}$, consistent with $\\gamma^2$ being proportional to the net release of potential energy per unit generalized inertia.\n\nFlux-tube versus global comparison:\n- Flux-tube (local) estimate at radial position $x_0$: use a Dirac-delta envelope localized at $x_0$, which reduces the expectation to the pointwise value of the differential free-energy density at $x_0$.\n- Global (nonlocal) estimate: use a Gaussian envelope $\\lvert \\psi(x) \\rvert^2 \\propto \\exp\\!\\left( -\\dfrac{(x-x_0)^2}{2 w^2} \\right)$ of width $w$ to form the weighted average of the differential free-energy density across $x$. Integrate over $x \\in [0,1]$.\n\nImplementation requirements:\n- Compute $q(x)$, $dq/dx$, $s(x)$, $\\beta(x)$, $d\\beta/dx$, and $\\alpha(x)$ from the specified profiles and parameters.\n- Form the local differential free-energy density from the two-term shear-$\\alpha$ model with given constants $c_\\alpha$ and $c_s$.\n- Compute the flux-tube growth-rate proxy $\\gamma_{\\mathrm{local}} = \\sqrt{\\max(0,\\mathcal{D}_{\\mathrm{local}})}$, where $\\mathcal{D}_{\\mathrm{local}}$ is the pointwise drive-minus-stabilization density at $x_0$.\n- Compute the global growth-rate proxy $\\gamma_{\\mathrm{global}} = \\sqrt{\\max(0,\\mathcal{D}_{\\mathrm{global}})}$, where $\\mathcal{D}_{\\mathrm{global}}$ is the Gaussian-weighted average of the same density over $x \\in [0,1]$.\n- Quantify the impact of global equilibrium variation as $\\Delta \\gamma = \\gamma_{\\mathrm{global}} - \\gamma_{\\mathrm{local}}$.\n\nAssumptions and units:\n- Work in normalized gyrokinetic units in which time and frequency are dimensionless; report all growth-rate proxies as dimensionless numbers. All lengths are normalized to the minor radius $a$, so $x$ and $w$ are dimensionless. No physical units (e.g., seconds) are required.\n- Angles are not used and need no unit specification.\n\nNumerical details:\n- For the global (Gaussian-weighted) average, evaluate the integrals numerically over $x \\in [0,1]$. You may restrict the numerical integration to the effective support of the Gaussian, e.g., $x \\in [\\max(0, x_0 - 5 w), \\min(1, x_0 + 5 w)]$, to improve efficiency and accuracy.\n\nTest suite:\nFor each parameter tuple below, compute and return $\\gamma_{\\mathrm{local}}$, $\\gamma_{\\mathrm{global}}$, and $\\Delta \\gamma$:\n- Case A (happy path): $q_0 = 1.4$, $q_1 = 1.6$, $\\beta_0 = 0.02$, $p = 2$, $R/a = 3.0$, $x_0 = 0.5$, $w = 0.1$, $c_\\alpha = 0.8$, $c_s = 0.6$.\n- Case B (near-marginal drive at larger radius): $q_0 = 1.2$, $q_1 = 1.0$, $\\beta_0 = 0.01$, $p = 2$, $R/a = 3.0$, $x_0 = 0.8$, $w = 0.15$, $c_\\alpha = 0.8$, $c_s = 0.8$.\n- Case C (narrow mode, local-global agreement check): $q_0 = 1.5$, $q_1 = 1.8$, $\\beta_0 = 0.03$, $p = 2$, $R/a = 3.5$, $x_0 = 0.4$, $w = 0.02$, $c_\\alpha = 0.7$, $c_s = 0.5$.\n- Case D (strong profile curvature and shear): $q_0 = 1.3$, $q_1 = 2.0$, $\\beta_0 = 0.025$, $p = 3$, $R/a = 4.0$, $x_0 = 0.6$, $w = 0.25$, $c_\\alpha = 0.85$, $c_s = 0.65$.\n- Case E (stabilized case): $q_0 = 1.0$, $q_1 = 2.5$, $\\beta_0 = 0.005$, $p = 2$, $R/a = 3.0$, $x_0 = 0.7$, $w = 0.12$, $c_\\alpha = 0.6$, $c_s = 1.0$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of lists, each inner list ordered as $[\\gamma_{\\mathrm{local}}, \\gamma_{\\mathrm{global}}, \\Delta \\gamma]$ for the above cases in order A–E.\n- Each floating-point number must be rounded to exactly six digits after the decimal point.\n- For example, the printed line should look like $[[0.123456,0.234567,0.111111],[\\dots],\\dots]$ with no extra whitespace or text.",
            "solution": "The problem statement has been critically reviewed and is determined to be valid. It is scientifically grounded in the principles of plasma magnetohydrodynamics (MHD), specifically the theory of ballooning instabilities in tokamaks. The problem is well-posed, with all necessary parameters, profiles, and models explicitly defined, leading to a unique and computable solution. The language is objective and the setup is internally consistent and formalizable.\n\nThe task is to compare a local (flux-tube) and a nonlocal (global) estimate for an electromagnetic instability growth rate. This is achieved by deriving and calculating a dimensionless growth-rate proxy, $\\gamma$, from a simplified model of the plasma's potential energy.\n\nFirst, we establish the necessary analytic forms for the plasma equilibrium profiles as functions of the normalized radial coordinate $x = r/a$, where $r$ is the minor radius and $a$ is the machine's minor radius.\n\nThe safety factor profile is given by:\n$$q(x) = q_0 + q_1 x^2$$\nFrom this, the magnetic shear, defined as $s(x) = \\frac{x}{q(x)} \\frac{dq}{dx}$, is calculated. The derivative of the safety factor is:\n$$\\frac{dq}{dx} = \\frac{d}{dx} (q_0 + q_1 x^2) = 2 q_1 x$$\nSubstituting this into the definition for shear yields:\n$$s(x) = \\frac{x}{q_0 + q_1 x^2} (2 q_1 x) = \\frac{2 q_1 x^2}{q_0 + q_1 x^2}$$\n\nThe plasma pressure profile, represented by the plasma beta $\\beta$, is given by:\n$$\\beta(x) = \\beta_0 (1-x^2)^p$$\nThe ballooning parameter, $\\alpha(x)$, is proportional to the pressure gradient. The problem defines it as $\\alpha(x) = -q(x)^2 \\frac{R}{a} \\frac{d\\beta}{dx}$. We calculate the derivative of $\\beta(x)$:\n$$\\frac{d\\beta}{dx} = \\frac{d}{dx} \\left[ \\beta_0 (1-x^2)^p \\right] = \\beta_0 p(1-x^2)^{p-1}(-2x) = -2 p \\beta_0 x (1-x^2)^{p-1}$$\nSubstituting this expression into the definition for $\\alpha(x)$ gives the pressure gradient drive term:\n$$\\alpha(x) = - (q_0 + q_1 x^2)^2 \\left(\\frac{R}{a}\\right) \\left[ -2 p \\beta_0 x (1-x^2)^{p-1} \\right] = 2 p \\beta_0 \\frac{R}{a} x (q_0 + q_1 x^2)^2 (1-x^2)^{p-1}$$\n\nThe problem posits a local differential free-energy density, which we denote as $D(x)$, based on the competition between the pressure-gradient/curvature drive (proportional to $\\alpha(x)$) and the stabilizing magnetic field-line bending (proportional to $s(x)^2$). With the given constants of proportionality, $c_\\alpha$ and $c_s$, the expression is:\n$$D(x) = c_\\alpha \\alpha(x) - c_s s(x)^2$$\nA positive value of $D(x)$ indicates a local tendency towards instability. The dimensionless growth-rate proxy, $\\gamma$, is related to the radially averaged value of this density, $\\mathcal{D}$, by $\\gamma = \\sqrt{\\max(0, \\mathcal{D})}$. This form is consistent with the idea that the squared growth rate, $\\gamma^2$, is proportional to the net potential energy released by the instability.\n\nThe core of the problem is the comparison between two averaging methods for $D(x)$.\n\n1.  **Flux-Tube (Local) Estimate**: This model assumes the instability is highly localized to a single magnetic flux surface at radial position $x_0$. The averaging is performed with a Dirac delta function, $\\delta(x-x_0)$, as the mode's radial envelope. The stability measure $\\mathcal{D}_{\\mathrm{local}}$ is simply the pointwise evaluation of the density $D(x)$ at $x = x_0$:\n    $$\\mathcal{D}_{\\mathrm{local}} = D(x_0) = c_\\alpha \\alpha(x_0) - c_s s(x_0)^2$$\n    The corresponding local growth-rate proxy is:\n    $$\\gamma_{\\mathrm{local}} = \\sqrt{\\max(0, \\mathcal{D}_{\\mathrm{local}})}$$\n\n2.  **Global (Nonlocal) Estimate**: This model considers that a realistic instability has a finite radial width. It employs a Gaussian envelope centered at $x_0$ with width $w$, $|\\psi(x)|^2 \\propto \\exp\\left( -\\frac{(x-x_0)^2}{2 w^2} \\right)$. The stability measure $\\mathcal{D}_{\\mathrm{global}}$ is the weighted average of $D(x)$ over the radial domain $x \\in [0, 1]$:\n    $$\\mathcal{D}_{\\mathrm{global}} = \\frac{\\int_{0}^{1} D(x) \\exp\\left( -\\frac{(x-x_0)^2}{2 w^2} \\right) dx}{\\int_{0}^{1} \\exp\\left( -\\frac{(x-x_0)^2}{2 w^2} \\right) dx}$$\n    The corresponding global growth-rate proxy is:\n    $$\\gamma_{\\mathrm{global}} = \\sqrt{\\max(0, \\mathcal{D}_{\\mathrm{global}})}$$\n    The integrals for $\\mathcal{D}_{\\mathrm{global}}$ must be computed numerically. As suggested, the integration range can be truncated to $x \\in [\\max(0, x_0 - 5w), \\min(1, x_0 + 5w)]$ for computational efficiency, as the Gaussian is negligible outside this interval.\n\nFinally, the impact of the global profile variation is quantified by the difference between the two estimates:\n$$\\Delta \\gamma = \\gamma_{\\mathrm{global}} - \\gamma_{\\mathrm{local}}$$\n\nThe implementation will consist of creating functions for $q(x)$, $s(x)$, and $\\alpha(x)$, then combining them to compute $D(x)$. For each test case, we evaluate $D(x_0)$ to find $\\gamma_{\\mathrm{local}}$ and then perform numerical integration using `scipy.integrate.quad` to find $\\mathcal{D}_{\\mathrm{global}}$ and subsequently $\\gamma_{\\mathrm{global}}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.integrate import quad\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It calculates local and global growth-rate proxies and their difference,\n    then prints the results in the specified format.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    # Each tuple contains: (q0, q1, beta0, p, R_a, x0, w, c_alpha, c_s)\n    test_cases = [\n        # Case A\n        (1.4, 1.6, 0.02, 2, 3.0, 0.5, 0.1, 0.8, 0.6),\n        # Case B\n        (1.2, 1.0, 0.01, 2, 3.0, 0.8, 0.15, 0.8, 0.8),\n        # Case C\n        (1.5, 1.8, 0.03, 2, 3.5, 0.4, 0.02, 0.7, 0.5),\n        # Case D\n        (1.3, 2.0, 0.025, 3, 4.0, 0.6, 0.25, 0.85, 0.65),\n        # Case E\n        (1.0, 2.5, 0.005, 2, 3.0, 0.7, 0.12, 0.6, 1.0),\n    ]\n\n    results = []\n    for params in test_cases:\n        result_tuple = calculate_gammas(*params)\n        results.append(result_tuple)\n    \n    # Format the final output string as specified.\n    inner_strings = [f\"[{g_loc:.6f},{g_glob:.6f},{delta_g:.6f}]\" for g_loc, g_glob, delta_g in results]\n    print(f\"[{','.join(inner_strings)}]\")\n\ndef calculate_gammas(q0, q1, beta0, p, R_a, x0, w, c_alpha, c_s):\n    \"\"\"\n    Calculates local and global growth-rate proxies for a single parameter set.\n    \"\"\"\n    \n    # Define profile functions based on input parameters.\n    # Note: Using np.vectorize allows these functions to work with arrays from quad.\n    \n    @np.vectorize\n    def q_func(x):\n        return q0 + q1 * x**2\n\n    @np.vectorize\n    def s_func(x):\n        # Handle x=0 case to avoid 0/0. At x=0, s=0.\n        if x == 0:\n            return 0.0\n        return (2 * q1 * x**2) / q_func(x)\n\n    @np.vectorize\n    def alpha_func(x):\n        # Handle x=1 case where (1-x^2) might be raised to a negative power if p  1.\n        # For the given test cases with p >= 2, (1-x^2)^(p-1) is well-behaved and is 0 at x=1.\n        if x >= 1.0:\n            return 0.0\n        dbeta_dx = -2 * p * beta0 * x * (1 - x**2)**(p - 1)\n        return -q_func(x)**2 * R_a * dbeta_dx\n\n    # --- Local (Flux-Tube) Calculation ---\n    \n    alpha_local = alpha_func(x0)\n    s_local = s_func(x0)\n    \n    D_local = c_alpha * alpha_local - c_s * s_local**2\n    gamma_local = np.sqrt(max(0, D_local))\n\n    # --- Global (Nonlocal) Calculation ---\n\n    # Define the differential free-energy density D(x)\n    @np.vectorize\n    def D_func(x):\n        return c_alpha * alpha_func(x) - c_s * s_func(x)**2\n\n    # Define the Gaussian envelope\n    def envelope(x):\n        return np.exp(-(x - x0)**2 / (2 * w**2))\n\n    # Integrands for the weighted average\n    def numerator_integrand(x):\n        return D_func(x) * envelope(x)\n    \n    def denominator_integrand(x):\n        return envelope(x)\n\n    # Set integration limits based on the Gaussian support\n    x_min = max(0, x0 - 5 * w)\n    x_max = min(1, x0 + 5 * w)\n\n    # Perform numerical integration using scipy.integrate.quad\n    # The [0] extracts the integral value from the (value, error) tuple returned by quad.\n    integral_numerator, _ = quad(numerator_integrand, x_min, x_max)\n    integral_denominator, _ = quad(denominator_integrand, x_min, x_max)\n\n    # Calculate global stability measure D_global\n    if integral_denominator == 0:\n        # This case should not happen for w > 0, but is included for robustness.\n        D_global = 0.0\n    else:\n        D_global = integral_numerator / integral_denominator\n        \n    gamma_global = np.sqrt(max(0, D_global))\n    \n    # --- Difference ---\n    \n    delta_gamma = gamma_global - gamma_local\n    \n    return gamma_local, gamma_global, delta_gamma\n\nsolve()\n```"
        }
    ]
}