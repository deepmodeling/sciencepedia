{
    "hands_on_practices": [
        {
            "introduction": "在模拟中实现碰撞算符的第一步是将其离散化。一种强大且高效的方法是谱方法，即将算符在精心选择的函数基上表示为一个矩阵。本练习将引导您推导线性化Lenard-Bernstein算符的谱表示，并揭示为何广义厄米-拉盖尔函数和勒让德多项式是解决此类问题的理想选择。",
            "id": "4180568",
            "problem": "您的任务是为聚变等离子体湍流模拟中使用的线性化碰撞算符构建一个截断伽辽金矩阵表示。该模型是针对单一粒子种类的 Lenard-Bernstein (LB) 算符，在热速度为$v_{\\mathrm{th}}$的麦克斯韦平衡态附近进行线性化：\n$$\n\\mathcal{C}[f](\\mathbf{v}) \\;=\\; \\nu\\, \\nabla_{\\mathbf{v}}\\cdot\\left(\\mathbf{v}\\, f \\;+\\; v_{\\mathrm{th}}^2 \\nabla_{\\mathbf{v}} f\\right),\n$$\n其中$\\nu$是一个单位为$\\mathrm{s}^{-1}$的恒定碰撞频率，$\\mathbf{v}$是速度矢量，$f(\\mathbf{v})$是速度分布扰动。在球形速度坐标$(v,\\xi,\\varphi)$中进行计算，其中$v=\\|\\mathbf{v}\\|$，$\\xi=\\cos\\theta$是螺距角余弦，$\\varphi$是回旋相位。假设系统具有轴对称性，因此没有对$\\varphi$的依赖关系。\n\n考虑在速率$v$的广义缔合拉盖尔函数和螺距角余弦$\\xi$的勒让德多项式的张量积基中的谱展开：\n- 定义无量纲速率变量$s = v^2/(2 v_{\\mathrm{th}}^2)$。\n- 对于每个非负整数对$(n,\\ell)$，其中$n \\in \\{0,1,2,\\dots\\}$且$\\ell \\in \\{0,1,2,\\dots\\}$，定义一个径向基函数$R_{n\\ell}(s)$，它与$e^{-s} s^{\\ell/2} L_n^{(\\ell+1/2)}(s)$成正比，其中$L_n^{(\\alpha)}$是次数为$n$、参数为$\\alpha=\\ell+\\tfrac{1}{2}$的缔合拉盖尔多项式。\n- 对于角向依赖性，使用次数为$\\ell$的勒让德多项式$P_\\ell(\\xi)$。\n\n使用与速度空间中麦克斯韦测度相关的带权$L^2$内积，在这些变量中，该内积可分解为一个权重为$e^{-s} s^{1/2}$的径向因子和一个在$\\xi \\in [-1,1]$上的角向因子。您可以假设存在适当的归一化常数，使得张量积基函数在此内积下是标准正交的。\n\n您的目标是：\n1. 从算符$\\mathcal{C}$的定义和球拉普拉斯算子的性质出发，推导关于标准正交基$\\{ R_{n\\ell}(s)P_\\ell(\\xi) \\}$的伽辽金矩阵元\n$$\nC_{(n,\\ell),(n',\\ell')} \\;=\\; \\left\\langle R_{n\\ell}(s)\\,P_\\ell(\\xi)\\,,\\, \\mathcal{C}\\left[ R_{n'\\ell'}(s)\\,P_{\\ell'}(\\xi)\\right]\\right\\rangle,\n$$\n的结构，其中$\\langle \\cdot,\\cdot\\rangle$表示上文定义的内积。\n2. 证明该矩阵在$\\ell$上是块对角的，在$(n,\\ell)$上是对角的，并用$\\nu$、$n$和$\\ell$显式地确定对角元。\n3. 实现一个程序，为给定的碰撞频率$\\nu$、径向截断$N_v$（意味着$n \\in \\{0,1,\\dots,N_v-1\\}$）和角向截断$L_{\\max}$（意味着$\\ell \\in \\{0,1,\\dots,L_{\\max}\\}$）构建截断伽辽金矩阵。您的实现应按固定的枚举顺序输出对角元：外层循环遍历$\\ell$从$0$到$L_{\\max}$，内层循环在每个$\\ell$中遍历$n$从$0$到$N_v-1$。所有对角元都以$\\mathrm{s}^{-1}$为单位表示，并按默认浮点转换进行取整。\n\n测试套件和最终输出规范：\n- 使用以下四个测试用例来测试实现的不同方面：\n    1. 一般情况：$\\nu = 0.7\\,\\mathrm{s}^{-1}$，$N_v = 3$，$L_{\\max} = 2$。\n    2. 各向同性边界：$\\nu = 1.0\\,\\mathrm{s}^{-1}$，$N_v = 4$，$L_{\\max} = 0$。\n    3. 零频率边缘：$\\nu = 0.0\\,\\mathrm{s}^{-1}$，$N_v = 5$，$L_{\\max} = 3$。\n    4. 关于热速度$v_{\\mathrm{th}}$的不变性检查：对于$\\nu = 0.9\\,\\mathrm{s}^{-1}$，$N_v = 2$，$L_{\\max} = 3$，通过比较使用$v_{\\mathrm{th}}=1.0\\,\\mathrm{m/s}$和$v_{\\mathrm{th}}=3.7\\,\\mathrm{m/s}$生成的对角元列表，数值上证明对角元不依赖于$v_{\\mathrm{th}}$，并返回一个布尔值，该布尔值为`true`当且仅当所有对应的元在$10^{-12}$的容差范围内相等。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的结果列表。前三项必须是浮点数列表，表示测试用例1-3的对角元（单位为$\\mathrm{s}^{-1}$），并按指定的枚举顺序列出。第四项必须是测试用例4的布尔值。例如，整体输出格式应如下所示：`[ [...], [...], [...], True ]`，其中每个内部列表都按要求排序。\n\n本问题陈述中的所有符号、变量、函数、算符和数字都应作数学解释，物理量应使用其标明的单位进行处理。",
            "solution": "该问题是有效的。这是一个数理物理学中的适定问题，特别是在等离子体动理学理论的背景下，并且基于已建立的科学原理。所有必要信息都已提供。\n\n主要任务是确定线性化 Lenard-Bernstein 碰撞算符$\\mathcal{C}$在由广义拉盖尔多项式和勒让德多项式组成的谱基中的矩阵元。该算符由下式给出：\n$$\n\\mathcal{C}[f](\\mathbf{v}) \\;=\\; \\nu\\, \\nabla_{\\mathbf{v}}\\cdot\\left(\\mathbf{v}\\, f \\;+\\; v_{\\mathrm{th}}^2 \\nabla_{\\mathbf{v}} f\\right)\n$$\n其中$\\nu$是碰撞频率，$f$是速度分布函数的扰动，$\\mathbf{v}$是速度，$v_{\\mathrm{th}}$是热速度。我们在假设轴对称性的球速度坐标$(v, \\xi)$中工作，其中$v = \\|\\mathbf{v}\\|$且$\\xi = \\cos\\theta$。基函数的形式为$\\Psi_{n\\ell}(v, \\xi) = R_{n\\ell}(v) P_\\ell(\\xi)$。问题陈述这些基函数关于内积$\\langle f, g \\rangle = \\int f(\\mathbf{v})^* g(\\mathbf{v}) d\\mu(\\mathbf{v})$是标准正交的，其中测度$d\\mu(\\mathbf{v})$对应于麦克斯韦分布，即$d\\mu(\\mathbf{v}) \\propto e^{-v^2/(2v_{\\mathrm{th}}^2)} v^2 dv d\\xi$。\n\n矩阵元定义为$C_{(n,\\ell),(n',\\ell')} = \\langle \\Psi_{n\\ell}, \\mathcal{C}[\\Psi_{n'\\ell'}] \\rangle$。我们将证明给定的基函数$\\Psi_{n\\ell}$实际上是算符$\\mathcal{C}$的本征函数。这证明了所得到的伽辽金矩阵是对角的。\n\n首先，让我们展开$\\mathcal{C}$定义中的散度项：\n$$\n\\nabla_{\\mathbf{v}}\\cdot\\left(\\mathbf{v}\\, f\\right) = (\\nabla_{\\mathbf{v}}\\cdot\\mathbf{v}) f + \\mathbf{v}\\cdot(\\nabla_{\\mathbf{v}}f) = 3f + \\mathbf{v}\\cdot(\\nabla_{\\mathbf{v}}f)\n$$\n其中我们使用了三维空间中的$\\nabla_{\\mathbf{v}}\\cdot\\mathbf{v} = 3$。将此代入算符表达式中，得到：\n$$\n\\mathcal{C}[f] = \\nu \\left( 3f + \\mathbf{v}\\cdot\\nabla_{\\mathbf{v}}f + v_{\\mathrm{th}}^2 \\nabla_{\\mathbf{v}}^2 f \\right)\n$$\n接下来，我们在球坐标$(v, \\theta, \\varphi)$中表示微分算符。在轴对称性下，所有关于$\\varphi$的导数都为零。\n算符$\\mathbf{v}\\cdot\\nabla_{\\mathbf{v}}$是沿径向速度方向的方向导数，即$v \\frac{\\partial}{\\partial v}$。\n球坐标中的拉普拉斯算符$\\nabla_{\\mathbf{v}}^2$是：\n$$\n\\nabla_{\\mathbf{v}}^2 f = \\frac{1}{v^2}\\frac{\\partial}{\\partial v}\\left(v^2 \\frac{\\partial f}{\\partial v}\\right) + \\frac{1}{v^2 \\sin\\theta}\\frac{\\partial}{\\partial \\theta}\\left(\\sin\\theta \\frac{\\partial f}{\\partial \\theta}\\right)\n$$\n将角变量更改为螺距角余弦$\\xi = \\cos\\theta$ (因此$d\\xi = -\\sin\\theta d\\theta$)，角向部分变为$\\frac{1}{v^2} \\frac{\\partial}{\\partial \\xi}\\left((1-\\xi^2)\\frac{\\partial f}{\\partial \\xi}\\right)$。这是$\\frac{1}{v^2}$乘以勒让德算子。对于基函数$f = R(v)P_\\ell(\\xi)$，此项变为$-\\frac{\\ell(\\ell+1)}{v^2} R(v) P_\\ell(\\xi)$。\n\n将算符$\\mathcal{C}$作用于基函数$\\Psi_{n'\\ell'}(v, \\xi) = R_{n'\\ell'}(v) P_{\\ell'}(\\xi)$，得到：\n$$\n\\mathcal{C}[\\Psi_{n'\\ell'}] = \\nu \\left( 3\\Psi_{n'\\ell'} + v \\frac{\\partial \\Psi_{n'\\ell'}}{\\partial v} + v_{\\mathrm{th}}^2 \\left[ \\frac{1}{v^2}\\frac{\\partial}{\\partial v}\\left(v^2 \\frac{\\partial \\Psi_{n'\\ell'}}{\\partial v}\\right) - \\frac{\\ell'(\\ell'+1)}{v^2}\\Psi_{n'\\ell'} \\right] \\right)\n$$\n由于$\\Psi_{n'\\ell'}$的角向依赖性完全包含在$P_{\\ell'}(\\xi)$中，而$P_{\\ell'}(\\xi)$是拉普拉斯算子角向部分的本征函数，所以算符$\\mathcal{C}$不会混合不同的角向模$\\ell'$。因此，该矩阵在$\\ell$上是块对角的，即如果$\\ell \\neq \\ell'$，则$C_{(n,\\ell),(n',\\ell')} = 0$。由于勒让德多项式的标准正交性，这证实了$\\ell$上的块对角结构。我们现在分析固定$\\ell$的径向部分。让我们定义一个径向算符$\\mathcal{O}_{\\ell}$：\n$$\n\\mathcal{O}_{\\ell}[R] = \\nu \\left( 3R + v \\frac{dR}{dv} + v_{\\mathrm{th}}^2 \\left[ \\frac{1}{v^2}\\frac{d}{dv}\\left(v^2 \\frac{dR}{dv}\\right) \\right] - \\frac{v_{\\mathrm{th}}^2\\ell(\\ell+1)}{v^2}R \\right)\n$$\n为了分析这个算符，我们切换到无量纲速率变量$s = v^2 / (2v_{\\mathrm{th}}^2)$。链式法则给出了以下导数关系：\n$$\n\\frac{d}{dv} = \\frac{ds}{dv}\\frac{d}{ds} = \\frac{v}{v_{\\mathrm{th}}^2}\\frac{d}{ds}\n$$\n$$\nv\\frac{d}{dv} = v\\left(\\frac{v}{v_{\\mathrm{th}}^2}\\frac{d}{ds}\\right) = \\frac{v^2}{v_{\\mathrm{th}}^2}\\frac{d}{ds} = 2s\\frac{d}{ds}\n$$\n拉普拉斯算子的径向部分是$\\frac{1}{v^2}\\frac{d}{dv}(v^2 \\frac{d}{dv}) = \\frac{d^2}{dv^2} + \\frac{2}{v}\\frac{d}{dv}$。让我们变换这些项：\n$$\n\\frac{d^2}{dv^2} = \\frac{d}{dv}\\left(\\frac{v}{v_{\\mathrm{th}}^2}\\frac{d}{ds}\\right) = \\frac{1}{v_{\\mathrm{th}}^2}\\frac{d}{ds} + \\frac{v}{v_{\\mathrm{th}}^2}\\frac{d}{dv}\\left(\\frac{d}{ds}\\right) = \\frac{1}{v_{\\mathrm{th}}^2}\\frac{d}{ds} + \\frac{v^2}{v_{\\mathrm{th}}^4}\\frac{d^2}{ds^2} = \\frac{1}{v_{\\mathrm{th}}^2}\\left( \\frac{d}{ds} + 2s \\frac{d^2}{ds^2} \\right)\n$$\n所以径向拉普拉斯项变为：\n$$\nv_{\\mathrm{th}}^2 \\left( \\frac{d^2}{dv^2} + \\frac{2}{v}\\frac{d}{dv} \\right) R(s) = v_{\\mathrm{th}}^2 \\left[ \\frac{1}{v_{\\mathrm{th}}^2}\\left(\\frac{d}{ds} + 2s\\frac{d^2}{ds^2}\\right) + \\frac{2}{v}\\left(\\frac{v}{v_{\\mathrm{th}}^2}\\frac{d}{ds}\\right) \\right] R(s) = \\left( 3\\frac{d}{ds} + 2s\\frac{d^2}{ds^2} \\right) R(s)\n$$\n将这些以$s$表示的表达式代入算符$\\mathcal{O}_{\\ell}$中：\n$$\n\\frac{1}{\\nu} \\mathcal{O}_{\\ell}[R] = 3R + 2s\\frac{dR}{ds} + \\left(3\\frac{dR}{ds} + 2s\\frac{d^2R}{ds^2}\\right) - \\frac{\\ell(\\ell+1)}{2s}R\n$$\n$$\n\\frac{1}{\\nu} \\mathcal{O}_{\\ell}[R] = 2s\\frac{d^2R}{ds^2} + (2s+3)\\frac{dR}{ds} + \\left(3 - \\frac{\\ell(\\ell+1)}{2s}\\right)R\n$$\n问题陈述径向基函数为$R_{n\\ell}(s) \\propto e^{-s} s^{\\ell/2} L_n^{(\\ell+1/2)}(s)$。让我们检验它们是否是$\\mathcal{O}_{\\ell}$的本征函数。设$R(s) = e^{-s} u(s)$。\n$R' = e^{-s}(u' - u)$且$R'' = e^{-s}(u'' - 2u' + u)$。\n代入$R$的算符中：\n$$\n\\frac{1}{\\nu} \\mathcal{O}_{\\ell}[e^{-s}u] = e^{-s} \\left[ 2s(u''-2u'+u) + (2s+3)(u'-u) + \\left(3 - \\frac{\\ell(\\ell+1)}{2s}\\right)u \\right]\n$$\n$$\n= e^{-s} \\left[ 2su'' + (-4s + 2s+3)u' + (2s - (2s+3) + 3 - \\frac{\\ell(\\ell+1)}{2s})u \\right]\n$$\n$$\n= e^{-s} \\left[ 2su'' + (3-2s)u' - \\frac{\\ell(\\ell+1)}{2s} u \\right]\n$$\n现在，我们检验$u(s) = s^{\\ell/2} L_n^{(\\alpha)}(s)$，其中$\\alpha = \\ell+1/2$。设$y(s) = L_n^{(\\alpha)}(s)$。所以$u=s^{\\ell/2}y$。\n$u' = \\frac{\\ell}{2}s^{\\ell/2-1}y + s^{\\ell/2}y'$\n$u'' = \\frac{\\ell}{2}(\\frac{\\ell}{2}-1)s^{\\ell/2-2}y + \\ell s^{\\ell/2-1}y' + s^{\\ell/2}y''$\n将这些代入$u$的表达式中，并收集含有$y$, $y'$, $y''$的项：\n$$\n2su'' \\rightarrow 2s\\left(\\frac{\\ell}{2}(\\frac{\\ell}{2}-1)s^{\\ell/2-2}y + \\ell s^{\\ell/2-1}y' + s^{\\ell/2}y''\\right) = \\ell(\\frac{\\ell}{2}-1)s^{\\ell/2-1}y + 2\\ell s^{\\ell/2}y' + 2s^{\\ell/2+1}y''\n$$\n$$\n(3-2s)u' \\rightarrow (3-2s)\\left(\\frac{\\ell}{2}s^{\\ell/2-1}y + s^{\\ell/2}y'\\right) = \\frac{3\\ell}{2}s^{\\ell/2-1}y - \\ell s^{\\ell/2}y + (3-2s)s^{\\ell/2}y'\n$$\n$$\n-\\frac{\\ell(\\ell+1)}{2s}u \\rightarrow -\\frac{\\ell(\\ell+1)}{2}s^{\\ell/2-1}y\n$$\n对$y''$的系数求和：$2s^{\\ell/2+1}y''$。\n对$y'$的系数求和：$(2\\ell s^{\\ell/2} + 3s^{\\ell/2} - 2s^{\\ell/2+1})y' = s^{\\ell/2}(2\\ell+3-2s)y'$。\n对$y$的系数求和：\n$$\n\\left[\\ell(\\frac{\\ell}{2}-1)s^{\\ell/2-1} + \\frac{3\\ell}{2}s^{\\ell/2-1} - \\ell s^{\\ell/2} - \\frac{\\ell(\\ell+1)}{2}s^{\\ell/2-1}\\right]y = s^{\\ell/2-1}y\\left[\\frac{\\ell^2}{2}-\\ell+\\frac{3\\ell}{2}-\\frac{\\ell^2}{2}-\\frac{\\ell}{2}\\right] - \\ell s^{\\ell/2}y = -\\ell s^{\\ell/2}y\n$$\n整个表达式变为：$e^{-s} s^{\\ell/2} \\left[2s y'' + (2\\ell+3-2s)y' -\\ell y \\right]$。\n广义拉盖尔多项式$y = L_n^{(\\alpha)}(s)$满足微分方程：$s y'' + (\\alpha+1-s)y' + ny = 0$。\n当$\\alpha = \\ell+1/2$时，此方程为$s y'' + (\\ell+3/2-s)y' + ny = 0$。\n乘以$2$得到$2s y'' + (2\\ell+3-2s)y' + 2ny = 0$。\n我们可以将$2s y'' + (2\\ell+3-2s)y' = -2ny$代入我们的结果中。\n表达式变为：$e^{-s} s^{\\ell/2} [-2ny - \\ell y] = -(2n+\\ell) e^{-s} s^{\\ell/2} y = -(2n+\\ell) R_{n\\ell}(s)$。\n所以，我们发现$R_{n\\ell}$是径向算符的本征函数：$\\frac{1}{\\nu}\\mathcal{O}_{\\ell}[R_{n\\ell}] = -(2n+\\ell)R_{n\\ell}$。\n因此，基函数$\\Psi_{n\\ell}$是完整算符$\\mathcal{C}$的本征函数：\n$$\n\\mathcal{C}[\\Psi_{n\\ell}] = -\\nu(2n+\\ell) \\Psi_{n\\ell}\n$$\n本征值为$\\lambda_{n\\ell} = -\\nu(2n+\\ell)$。热速度$v_{\\mathrm{th}}$已经消去，所以本征值不依赖于它。\n\n由于基函数是本征函数并且假设是标准正交的，伽辽金矩阵是对角的：\n$$\nC_{(n,\\ell),(n',\\ell')} = \\langle \\Psi_{n\\ell}, \\mathcal{C}[\\Psi_{n'\\ell'}] \\rangle = \\langle \\Psi_{n\\ell}, \\lambda_{n'\\ell'} \\Psi_{n'\\ell'} \\rangle = \\lambda_{n'\\ell'} \\langle \\Psi_{n\\ell}, \\Psi_{n'\\ell'} \\rangle = \\lambda_{n\\ell} \\delta_{nn'} \\delta_{\\ell\\ell'}\n$$\n矩阵的对角元就是本征值$\\lambda_{n\\ell} = -\\nu(2n+\\ell)$。\n\n为了实现该程序，我们计算在指定的$n$和$\\ell$范围内的这些值。要求的枚举顺序是外层循环遍历$\\ell$从$0$到$L_{\\max}$，内层循环在每个$\\ell$中遍历$n$从$0$到$N_v-1$。对于测试用例4，我们必须证明结果与$v_{\\mathrm{th}}$无关。正如本征值$\\lambda_{n\\ell}$的解析推导所示，结果不依赖于$v_{\\mathrm{th}}$。因此，使用两个不同的$v_{\\mathrm{th}}$值进行数值计算将产生相同的本征值列表，从而得到布尔值`True`。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef calculate_diagonals(nu, N_v, L_max):\n    \"\"\"\n    Calculates the diagonal entries of the truncated Galerkin matrix for the\n    linearized Lenard-Bernstein operator.\n\n    The diagonal entries correspond to the eigenvalues lambda_nl = -nu * (2n + l).\n\n    Args:\n        nu (float): The collision frequency in s^-1.\n        N_v (int): The radial truncation number (n goes from 0 to N_v-1).\n        L_max (int): The angular truncation number (l goes from 0 to L_max).\n\n    Returns:\n        list: A list of floating-point numbers representing the diagonal entries\n              in the specified enumeration order.\n    \"\"\"\n    diagonals = []\n    # Loop over l from 0 to L_max (outer loop)\n    for l_val in range(L_max + 1):\n        # Loop over n from 0 to N_v-1 (inner loop)\n        for n_val in range(N_v):\n            # Eigenvalue formula derived in the solution: lambda = -nu * (2n + l)\n            eigenvalue = -nu * (2 * n_val + l_val)\n            diagonals.append(eigenvalue)\n    return diagonals\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test suite and prints the formatted result.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # 1. General case\n        {'nu': 0.7, 'N_v': 3, 'L_max': 2},\n        # 2. Isotropic boundary\n        {'nu': 1.0, 'N_v': 4, 'L_max': 0},\n        # 3. Zero-frequency edge\n        {'nu': 0.0, 'N_v': 5, 'L_max': 3}\n    ]\n\n    results = []\n\n    # Process test cases 1-3\n    for case in test_cases:\n        diagonals = calculate_diagonals(case['nu'], case['N_v'], case['L_max'])\n        results.append(diagonals)\n\n    # Process test case 4: Invariance check with respect to v_th\n    # The derived eigenvalue formula does not depend on v_th, so the results\n    # for v_th=1.0 m/s and v_th=3.7 m/s will be identical.\n    case4_params = {'nu': 0.9, 'N_v': 2, 'L_max': 3}\n    # v_th is not an argument to the calculation function, demonstrating its independence.\n    list_a = calculate_diagonals(case4_params['nu'], case4_params['N_v'], case4_params['L_max'])\n    list_b = calculate_diagonals(case4_params['nu'], case4_params['N_v'], case4_params['L_max'])\n\n    # Compare the two lists for numerical equivalence within the specified tolerance.\n    # rtol=0 is important for comparing with zero values.\n    is_equal = np.allclose(list_a, list_b, atol=1e-12, rtol=0)\n    results.append(is_equal)\n\n    # The final print statement must produce a single-line string representation\n    # of the list of results.\n    # Using f-string automatically handles the conversion of lists and boolean to string.\n    print(f\"[{results[0]},{results[1]},{results[2]},{results[3]}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "一旦我们将碰撞算符离散化，就必须面对其对数值稳定性的影响。本练习探讨了碰撞算符为何会给动理学方程带来“刚性”，从而对显式时间积分格式的步长施加极其严格的限制。理解刚性的来源是为复杂等离子体模拟选择高效隐式或隐-显耦合（IMEX）时间积分方案的关键。",
            "id": "4180542",
            "problem": "考虑一个聚变等离子体湍流模拟中扰动分布$g$的线性化动理学方程，该方程写在一维平行位形空间和速度空间中，\n$$\n\\partial_t g + v_{\\parallel}\\,\\partial_z g + i\\,\\omega_*\\, g \\;=\\; L\\,g,\n$$\n其中$v_{\\parallel}$是平行速度，$\\omega_*$是一个恒定的抗磁驱动频率，$L$是一个线性化的碰撞算符。假设一个简化模型，其中$L$由两个解耦的测试粒子部分组成：螺距角散射和能量扩散，分别作用于螺距角余弦$\\xi$和归一化速率$u = v/v_{\\mathrm{th}}$，\n$$\nL \\;=\\; \\nu\\,\\partial_{\\xi}\\!\\left[(1-\\xi^2)\\,\\partial_{\\xi}\\,\\cdot\\right] \\;+\\; \\nu\\,\\partial_{uu}\\,,\n$$\n其中$\\nu$为恒定碰撞频率，$v_{\\mathrm{th}}$为热速率。在$\\xi$空间中采用勒让德多项式$P_{\\ell}(\\xi)$进行谱表示（因此$\\partial_{\\xi}[(1-\\xi^2)\\partial_{\\xi}] P_{\\ell} = -\\ell(\\ell+1) P_{\\ell}$），截断到$\\ell_{\\max}$，并在$u$空间中使用均匀间距$\\Delta u$的网格，该网格具有足够的分辨率，使得$u$空间中能解析的最大波数可以估计为$k_{u,\\max} \\approx \\pi/\\Delta u$。对于平流项，取波数为$k_{\\parallel}$的单个平行傅里叶模式，因此其线性频率尺度为$\\omega_s = v_{\\mathrm{th}}\\,k_{\\parallel}$。假设所有其他非线性和场耦合都已关闭。\n\n使用以下代表电子尺度湍流分辨率和碰撞强度的数值上合理的参数：\n- $\\nu = 5\\times 10^5\\ \\mathrm{s}^{-1}$,\n- $\\ell_{\\max} = 32$,\n- $\\Delta u = 0.01$,\n- $v_{\\mathrm{th}} = 6\\times 10^7\\ \\mathrm{m/s}$,\n- $k_{\\parallel} = 100\\ \\mathrm{m}^{-1}$,\n- $\\omega_* = 8\\times 10^4\\ \\mathrm{s}^{-1}$.\n\n基于螺距角散射算符和$u$空间中扩散算符的谱性质的第一性原理，以及流项和驱动项的形式，哪个选项正确解释了为什么碰撞算符相对于平流项和驱动项会引入刚性，并为应用于半离散系统的完全显式前向欧拉时间积分器提供了最严格的稳定性限制时间步长$\\Delta t$的一致估计？\n\n选择一个：\n\nA. 螺距角算符的特征值为$-\\nu\\,\\ell(\\ell+1)$，$u$空间扩散的特征值为$-\\nu\\,k_u^2$，因此最大的负实部约为$\\lambda_{\\max}^{(L)} \\approx -\\nu\\,\\ell_{\\max}(\\ell_{\\max}+1)$或$-\\nu\\,(\\pi/\\Delta u)^2$，取两者中较大的一个。在给定参数下，来自$u$空间扩散的$|\\lambda_{\\max}^{(L)}|$超过了$|\\omega_s|$和$|\\omega_*|$，使得系统变得刚性；前向欧拉稳定性边界为$\\Delta t \\lesssim 2/|\\lambda_{\\max}^{(L)}| \\approx 4\\times 10^{-11}\\ \\mathrm{s}$。\n\nB. 碰撞算符贡献的是纯虚数特征值，仅改变$g$的相位，因此刚性不是由碰撞引起的。时间步长受限于流项，为$\\Delta t \\lesssim 1/|\\omega_s| \\approx 1.7\\times 10^{-10}\\ \\mathrm{s}$。\n\nC. 碰撞算符的最大特征值为$-\\nu$，与速度空间分辨率无关，因此时间步长边界为$\\Delta t \\lesssim 2/\\nu \\approx 4\\times 10^{-6}\\ \\mathrm{s}$，远大于平流边界。\n\nD. 刚性主要由螺距角散射决定，其$\\lambda_{\\max}^{(L)} \\approx -\\nu\\,\\ell_{\\max}(\\ell_{\\max}+1)$，因此时间步长边界为$\\Delta t \\lesssim 2/\\left[\\nu\\,\\ell_{\\max}(\\ell_{\\max}+1)\\right] \\approx 4\\times 10^{-9}\\ \\mathrm{s}$；$u$空间中的能量扩散是次要的，可以在刚性估计中忽略。",
            "solution": "从线性化动理学方程开始，\n$$\n\\partial_t g + v_{\\parallel}\\,\\partial_z g + i\\,\\omega_*\\, g \\;=\\; L\\,g,\n$$\n其中$L$由螺距角散射和能量扩散组成，\n$$\nL \\;=\\; \\nu\\,\\partial_{\\xi}\\!\\left[(1-\\xi^2)\\,\\partial_{\\xi}\\,\\cdot\\right] \\;+\\; \\nu\\,\\partial_{uu}\\,.\n$$\n我们分析每一项的谱性质。\n\n对于螺距角散射算符，其著名的本征函数是勒让德多项式$P_{\\ell}(\\xi)$，并且\n$$\n\\partial_{\\xi}\\!\\left[(1-\\xi^2)\\,\\partial_{\\xi} P_{\\ell}\\right] \\;=\\; -\\ell(\\ell+1)P_{\\ell}.\n$$\n乘以$\\nu$，由螺距角散射贡献的特征值为\n$$\n\\lambda_{\\ell}^{(\\xi)} \\;=\\; -\\nu\\ell(\\ell+1).\n$$\n在$\\ell_{\\max}$处截断，来自螺距角散射的最负特征值为\n$$\n\\lambda_{\\max}^{(\\xi)} \\;=\\; -\\nu\\ell_{\\max}(\\ell_{\\max}+1).\n$$\n当$\\nu = 5\\times 10^5\\ \\mathrm{s}^{-1}$且$\\ell_{\\max}=32$时，我们有$\\ell_{\\max}(\\ell_{\\max}+1) = 32\\times 33 = 1056$，因此\n$$\n|\\lambda_{\\max}^{(\\xi)}| \\;=\\; \\nu\\ell_{\\max}(\\ell_{\\max}+1) \\;=\\; (5\\times 10^5)\\times 1056 \\;\\approx\\; 5.28\\times 10^8\\ \\mathrm{s}^{-1}.\n$$\n\n对于归一化速率坐标$u = v/v_{\\mathrm{th}}$中的能量扩散算符，连续算符为$\\nu\\,\\partial_{uu}$，其傅里葉特征值为$-\\nu\\,k_u^2$。在间距为$\\Delta u$的网格上，可解析的最大波数可估计为$k_{u,\\max} \\approx \\pi/\\Delta u$，因此来自$u$空间扩散的最负特征值的模为\n$$\n|\\lambda_{\\max}^{(u)}| \\;\\approx\\; \\nu\\,k_{u,\\max}^2 \\;\\approx\\; \\nu\\left(\\frac{\\pi}{\\Delta u}\\right)^2.\n$$\n当$\\nu = 5\\times 10^5\\ \\mathrm{s}^{-1}$且$\\Delta u = 0.01$时，我们发现\n$$\n\\left(\\frac{\\pi}{\\Delta u}\\right)^2 \\;=\\; \\left(\\frac{3.14159}{0.01}\\right)^2 \\;\\approx\\; (314.159)^2 \\;\\approx\\; 9.87\\times 10^4,\n$$\n所以\n$$\n|\\lambda_{\\max}^{(u)}| \\;\\approx\\; (5\\times 10^5)\\times (9.87\\times 10^4) \\;\\approx\\; 4.94\\times 10^{10}\\ \\mathrm{s}^{-1}.\n$$\n\n接下来，考虑平流项。对于波数为$k_{\\parallel}$的单个平行傅里叶模式，流频率尺度为\n$$\n\\omega_s \\;=\\; v_{\\mathrm{th}}\\,k_{\\parallel}.\n$$\n当$v_{\\mathrm{th}} = 6\\times 10^7\\ \\mathrm{m/s}$且$k_{\\parallel} = 100\\ \\mathrm{m}^{-1}$时，\n$$\n|\\omega_s| \\;=\\; (6\\times 10^7)\\times 100 \\;=\\; 6\\times 10^9\\ \\mathrm{s}^{-1}.\n$$\n抗磁驱动贡献了一个纯虚数项$i\\omega_*$，其$|\\omega_*| = 8\\times 10^4\\ \\mathrm{s}^{-1}$。\n\n比较尺度：\n- $|\\lambda_{\\max}^{(u)}| \\approx 4.94\\times 10^{10}\\ \\mathrm{s}^{-1}$ (实数，负),\n- $|\\lambda_{\\max}^{(\\xi)}| \\approx 5.28\\times 10^{8}\\ \\mathrm{s}^{-1}$ (实数，负),\n- $|\\omega_s| \\approx 6\\times 10^{9}\\ \\mathrm{s}^{-1}$ (纯虚数),\n- $|\\omega_*| \\approx 8\\times 10^{4}\\ \\mathrm{s}^{-1}$ (纯虚数).\n\n模最大的特征值来自碰撞算符，特别是$u$空间中的能量扩散。因为这些特征值具有大的负实部，它们引入了刚性：与速度空间扩散相关的最快衰减模式在时间尺度$O(1/|\\lambda_{\\max}^{(u)}|)$上演化，这远短于平流或驱动的时间尺度。在应用于线性系统$\\partial_t y = A y$的显式前向欧拉格式中，对于具有负实部的特征值$\\lambda$，该本征模式的稳定性要求是$|1 + \\Delta t\\,\\lambda| \\le 1$，对于实数负$\\lambda$这简化为\n$$\n\\Delta t \\;\\le\\; \\frac{2}{|\\lambda|}.\n$$\n因此，最严格的显式时间步长由$L$的最大负实特征值控制，即\n$$\n\\Delta t_{\\max} \\;\\approx\\; \\frac{2}{|\\lambda_{\\max}^{(L)}|} \\;\\approx\\; \\frac{2}{|\\lambda_{\\max}^{(u)}|} \\;\\approx\\; \\frac{2}{4.94\\times 10^{10}} \\;\\approx\\; 4.05\\times 10^{-11}\\ \\mathrm{s}.\n$$\n相比之下，平流项和驱动项是纯虚数的，不施加这种前向欧拉扩散类型的边界；它们在实践中的显式稳定性遵循依赖于空间离散化的Courant–Friedrichs–Lewy (CFL) 限制。即使我们估计一个朴素的边界$\\Delta t \\sim 1/|\\omega_s| \\approx 1.7\\times 10^{-10}\\ \\mathrm{s}$，它仍然比上面计算的碰撞扩散边界要宽松。因此，在这些分辨率和参数选择下，碰撞使得半离散动理学系统相对于平流项和驱动项变得刚性。\n\n逐个选项分析：\n- 选项 A 正确陈述了特征值的标度关系：螺距角散射为$-\\nu\\,\\ell(\\ell+1)$，$u$空间扩散为$-\\nu\\,k_u^2$。它指出了在给定的$\\Delta u$下，模最大的特征值是由于$u$空间扩散，并正确地将其与$|\\omega_s|$和$|\\omega_*|$进行比较，得出刚性的结论。其时间步长估计$\\Delta t \\lesssim 2/|\\lambda_{\\max}^{(L)}|$和数值$\\approx 4\\times 10^{-11}\\ \\mathrm{s}$与上述推导一致。结论：正确。\n- 选项 B 错误地声称碰撞贡献纯虚数特征值；实际上，扩散算符产生负实数特征值，这正是显式格式中刚性的来源。仅由流项限制的时间步长$\\Delta t \\lesssim 1/|\\omega_s|$忽略了占主导地位的碰撞稳定性约束。结论：错误。\n- 选项 C 断言最大的碰撞特征值为$-\\nu$，与分辨率无关，这与扩散（$\\propto k^2$）和螺距角散射（$\\propto \\ell(\\ell+1)$）的谱标度关系相矛盾。由此产生的时间步长$\\Delta t \\approx 2/\\nu$在数量级上过大，并且忽略了分辨率引起的刚性。结论：错误。\n- 选项 D 只关注螺距角散射，忽略了$u$空间扩散的贡献，而在给定参数下，$u$空间扩散的贡献要大得多。其时间步长估计$\\approx 4\\times 10^{-9}\\ \\mathrm{s}$比$u$空间扩散给出的正确边界要宽松，因此不一致。结论：错误。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "除了数值稳定性，保证物理守恒律在离散层面精确成立也至关重要，因为数值误差会破坏这些基本定律。本实践将指导您实现一种通用的修正方法，通过将碰撞项投影到适当的子空间，来精确地强制执行粒子数、动量和能量的守恒。这种技术是开发可靠动理学模拟代码的核心组成部分。",
            "id": "4180552",
            "problem": "一项离散速度模拟旨在聚变等离子体湍流的背景下，通过线性化碰撞算符$L$来推进分布扰动$h(\\mathbf{v})$的演化。在连续介质中，碰撞不变量意味着，当碰撞算符与相应的不变量进行积分时，粒子数、动量和能量的交换量为零。在数值上，离散化的$L$在每个时间步长可能无法精确地保持这些不变量。本题的目标是，在一个有限的三维速度网格上，从第一性原理出发，推导并实现一种最小修正方法，该方法通过在每个时间步之后将$Lh$投影到正交补空间上，来强制执行粒子数、动量和能量的精确离散守恒。\n\n从带有线性化碰撞源$S(\\mathbf{v}) = Lh(\\mathbf{v})$的动理学方程出发，在一个由点$\\mathbf{v}_i = (v_{x,i},v_{y,i},v_{z,i})$和正求积权重$w_i$构成的网格上定义离散内积。离散内积定义为\n$$\n\\langle a, b \\rangle_W = \\sum_{i=1}^{N} w_i\\, a_i\\, b_i,\n$$\n其中$a_i = a(\\mathbf{v}_i)$，$b_i = b(\\mathbf{v}_i)$，$N$是网格点的总数。碰撞不变量包括常数函数$\\phi_0(\\mathbf{v}) = 1$、速度分量$\\phi_1(\\mathbf{v}) = v_x$、$\\phi_2(\\mathbf{v}) = v_y$、$\\phi_3(\\mathbf{v}) = v_z$以及类动能函数$\\phi_4(\\mathbf{v}) = \\lVert \\mathbf{v} \\rVert^2 = v_x^2+v_y^2+v_z^2$。在一个时间步长上的离散守恒要求修正后的源$S_\\perp$满足\n$$\n\\langle \\phi_j, S_\\perp \\rangle_W = 0\n\\quad \\text{for} \\quad j \\in \\{0,1,2,3,4\\}.\n$$\n将该修正表述为$S$在内积$\\langle \\cdot, \\cdot \\rangle_W$下相对于$\\{\\phi_0,\\phi_1,\\phi_2,\\phi_3,\\phi_4\\}$所张成子空间的正交补上的正交投影，并推导出计算$S_\\perp$所必须求解的线性代数系统。然后实现这个修正，并在每个时间步应用它，使得$h^{n+1} = h^n + \\Delta t\\, S_\\perp$不会引起离散不变量的变化。\n\n本问题中的所有量都是无量纲的，不需要物理单位。不使用角度。程序必须是自包含的，不读取任何外部输入；它应按指定格式输出一行结果。\n\n请实现您的程序，为以下每个测试用例构建速度网格、权重、测试分布$h$和未经修正的源$S$。对于均匀网格，权重等于均匀单元体积$\\Delta v_x\\,\\Delta v_y\\,\\Delta v_z$。对于非均匀网格，在每个方向上使用一维节点位置数组，并通过到下一个节点距离的一半加上到前一个节点距离的一半来近似局部单元宽度（端点使用单个相邻区间的一半）。一个节点上的权重是三个方向单元宽度的乘积。\n\n测试套件：\n\n- 情况1（理想情况）：\n  - 每个方向的网格节点：$\\{-2,-1,0,1,2\\}$，因此$N = 5 \\times 5 \\times 5$。\n  - 时间步长：$\\Delta t = 0.1$。\n  - 分布：$h(\\mathbf{v}) = \\exp(-\\lVert \\mathbf{v} \\rVert^2)$。\n  - 源：$S(\\mathbf{v}) = -\\nu h(\\mathbf{v}) + \\alpha v_x + \\beta \\lVert \\mathbf{v} \\rVert^2 + \\gamma v_x v_y$，其中$\\nu = 0.4$，$\\alpha = 0.3$，$\\beta = -0.1$，$\\gamma = 0.05$。\n\n- 情况2（边界情况：源为零）：\n  - 每个方向的网格节点：$\\{-1,0,1\\}$，因此$N = 3 \\times 3 \\times 3$。\n  - 时间步长：$\\Delta t = 0.5$。\n  - 分布：$h(\\mathbf{v}) = \\exp(-\\lVert \\mathbf{v} \\rVert^2)$。\n  - 源：$S(\\mathbf{v}) = 0$。\n\n- 情况3（边缘情况：非均匀网格和大时间步长）：\n  - 网格节点：\n    - $v_x$节点：$\\{-3,-1,0,0.5,2\\}$，\n    - $v_y$节点：$\\{-2.5,-0.5,0.2,1.7\\}$，\n    - $v_z$节点：$\\{-1.5,-0.7,-0.2,0.4,1.4,3.0\\}$，\n    得到$N = 5 \\times 4 \\times 6$。\n  - 时间步长：$\\Delta t = 10.0$。\n  - 分布：$h(\\mathbf{v}) = \\exp(-\\lVert \\mathbf{v} \\rVert^2)$。\n  - 源：$S(\\mathbf{v}) = a_1 v_x + a_2 v_y + a_3 v_z + a_4 \\lVert \\mathbf{v} \\rVert^2 - a_5 h(\\mathbf{v}) + b_1 v_x v_y + b_2 v_y v_z + b_3 v_x v_z$，其中$a_1 = 2.0$，$a_2 = -3.0$，$a_3 = 1.5$，$a_4 = 0.7$，$a_5 = 1.0$，$b_1 = 0.2$，$b_2 = -0.05$，$b_3 = 0.02$。\n\n对于每种情况：\n- 构建在所有网格点上求值的基向量$\\phi_j$。\n- 通过将$S$投影到由$\\langle \\cdot, \\cdot \\rangle_W$所隐含的权重矩阵决定的$\\phi_j$所张成子空间的正交补上，来计算修正后的源$S_\\perp$。\n- 对于$j \\in \\{0,1,2,3,4\\}$，计算不变量残差$r_j = \\langle \\phi_j, S_\\perp \\rangle_W$。\n- 为每种情况报告一个浮点数，其值为$\\max_{j} |r_j|$。\n\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，例如$[r_1,r_2,r_3]$，其中每个$r_k$对应于上面列出的第 k 种情况的最大绝对残差。",
            "solution": "该问题要求推导并实现一种数值方法，用于在等离子体模拟中对线性化碰撞算符强制执行离散守恒律。该方法涉及将未经修正的碰撞源项$S(\\mathbf{v})$投影到由碰撞不变量张成的子空间的正交补上。\n\n此问题设置在动理学理论的背景下，描述了粒子分布函数的演化。在这里，我们考虑对背景分布的扰动$h(\\mathbf{v})$及其因碰撞引起的演化，该演化由线性化算符$L$建模。一个时间步长$\\Delta t$的动理学方程的离散形式是$h^{n+1} = h^n + \\Delta t S$，其中$S=Lh$是碰撞源项。\n\n在连续情况下，碰撞算符守恒粒子数、动量和能量。这一性质在数学上转化为源项与代表这些守恒量（即碰撞不变量）的函数正交。当问题被离散化到有限速度网格上时，由于近似误差，这种守恒性质可能会丢失。任务是在每一步中对源项$S$应用最小修正以恢复它。\n\n其数学框架是一个有限维向量空间，其中网格上的函数表示为向量。该空间配备了一个加权内积，定义为：\n$$\n\\langle a, b \\rangle_W = \\sum_{i=1}^{N} w_i a(\\mathbf{v}_i) b(\\mathbf{v}_i)\n$$\n其中$\\mathbf{v}_i$是速度网格的$N$个点，$w_i > 0$是相应的求积权重。\n\n碰撞不变量被给定为一组五个函数：\n\\begin{itemize}\n    \\item $\\phi_0(\\mathbf{v}) = 1$ (与数密度相关)\n    \\item $\\phi_1(\\mathbf{v}) = v_x$, $\\phi_2(\\mathbf{v}) = v_y$, $\\phi_3(\\mathbf{v}) = v_z$ (与动量相关)\n    \\item $\\phi_4(\\mathbf{v}) = \\lVert \\mathbf{v} \\rVert^2 = v_x^2 + v_y^2 + v_z^2$ (与动能相关)\n\\end{itemize}\n这五个函数在网格上所有函数的向量空间内张成一个子空间，我们称之为$U$。\n$$\nU = \\text{span}\\{\\phi_0, \\phi_1, \\phi_2, \\phi_3, \\phi_4\\}\n$$\n离散守恒要求修正后的源项$S_\\perp$必须与这些基函数中的每一个都关于定义的内积正交：\n$$\n\\langle \\phi_j, S_\\perp \\rangle_W = 0 \\quad \\text{for } j \\in \\{0, 1, 2, 3, 4\\}\n$$\n此条件意味着$S_\\perp$必须属于子空间$U$的正交补，记为$U^\\perp$。\n\n问题规定$S_\\perp$应通过正交投影从未经修正的源$S$推导得出。在$U^\\perp$中最接近$S$（在由内积导出的范数意义下）的唯一向量是$S$在$U^\\perp$上的正交投影。任何向量$S$都可以唯一地分解为一个在$U$中的分量和一个在$U^\\perp$中的分量：\n$$\nS = S_\\| + S_\\perp\n$$\n其中$S_\\| = \\text{proj}_U(S)$是$S$在$U$上的投影，$S_\\perp = \\text{proj}_{U^\\perp}(S)$是在$U^\\perp$上的投影。我们期望的修正源是$S_\\perp = S - S_\\|$。\n\n为了找到$S_\\|$，我们将其表示为$U$的基向量的线性组合：\n$$\nS_\\| = \\sum_{k=0}^{4} c_k \\phi_k\n$$\n系数$c_k$由差分向量$S - S_\\|$必须与子空间$U$正交的条件确定。如果该差分向量与$U$的每个基向量都正交，则此条件得到满足：\n$$\n\\langle \\phi_j, S - S_\\| \\rangle_W = 0 \\quad \\text{for } j \\in \\{0, 1, 2, 3, 4\\}\n$$\n利用内积的线性性质，我们得到：\n$$\n\\langle \\phi_j, S \\rangle_W = \\langle \\phi_j, S_\\| \\rangle_W = \\left\\langle \\phi_j, \\sum_{k=0}^{4} c_k \\phi_k \\right\\rangle_W = \\sum_{k=0}^{4} c_k \\langle \\phi_j, \\phi_k \\rangle_W\n$$\n这构成了关于5个未知系数$c_k$的5个线性方程组。我们可以将其表示为矩阵形式$Gc = b$，其中：\n- $G$是一个$5 \\times 5$的格拉姆矩阵，其元素为$G_{jk} = \\langle \\phi_j, \\phi_k \\rangle_W$。\n- $c$是系数的列向量$[c_0, c_1, c_2, c_3, c_4]^T$。\n- $b$是一个列向量，其元素为$b_j = \\langle \\phi_j, S \\rangle_W$。\n\n实现该解决方案的步骤如下：\n1.  **构建网格和权重。** 对于点$\\mathbf{v}_i = (v_{x,p}, v_{y,q}, v_{z,r})$，权重为$w_i = \\delta v_{x,p} \\delta v_{y,q} \\delta v_{z,r}$。一维单元宽度$\\delta v$根据到相邻节点的距离按规定计算。\n2.  **将函数表示为向量。** 在$N$个网格点上计算函数$S$和$\\phi_j$的值，以获得$\\mathbb{R}^N$中的向量。\n3.  **组合并求解线性系统。** 使用离散内积计算矩阵$G$和向量$b$。然后，求解线性系统$Gc = b$以得到系数向量$c$。只要$\\phi_j$在网格上是线性无关的，格拉姆矩阵$G$就是对称正定的，因此$c$存在唯一解。\n4.  **计算修正后的源。** 计算在不变量子空间上的投影$S_\\| = \\sum_{k=0}^4 c_k \\phi_k$。然后通过减法获得修正后的源：$S_\\perp = S - S_\\|$。\n5.  **计算残差。** 为验证守恒性质，计算残差$r_j = \\langle \\phi_j, S_\\perp \\rangle_W$。每个情况最终报告的值是最大绝对残差$\\max_j |r_j|$。该值量化了守恒强制执行的数值精度。\n时间步长$\\Delta t$和分布$h^n$是为提供上下文和定义$S$而给出的，但它们不直接参与$S_\\perp$残差的计算。",
            "answer": "```python\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Solves the conservation-fixing problem for three given test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (happy path)\n        {\n            \"vx_nodes\": np.array([-2.0, -1.0, 0.0, 1.0, 2.0]),\n            \"vy_nodes\": np.array([-2.0, -1.0, 0.0, 1.0, 2.0]),\n            \"vz_nodes\": np.array([-2.0, -1.0, 0.0, 1.0, 2.0]),\n            \"dt\": 0.1,\n            \"h_func\": lambda vx, vy, vz: np.exp(-(vx**2 + vy**2 + vz**2)),\n            \"s_func\": lambda vx, vy, vz, h: (\n                -0.4 * h + 0.3 * vx - 0.1 * (vx**2 + vy**2 + vz**2) + 0.05 * vx * vy\n            ),\n        },\n        # Case 2 (boundary case: zero source)\n        {\n            \"vx_nodes\": np.array([-1.0, 0.0, 1.0]),\n            \"vy_nodes\": np.array([-1.0, 0.0, 1.0]),\n            \"vz_nodes\": np.array([-1.0, 0.0, 1.0]),\n            \"dt\": 0.5,\n            \"h_func\": lambda vx, vy, vz: np.exp(-(vx**2 + vy**2 + vz**2)),\n            \"s_func\": lambda vx, vy, vz, h: 0.0,\n        },\n        # Case 3 (edge case: nonuniform grid and large timestep)\n        {\n            \"vx_nodes\": np.array([-3.0, -1.0, 0.0, 0.5, 2.0]),\n            \"vy_nodes\": np.array([-2.5, -0.5, 0.2, 1.7]),\n            \"vz_nodes\": np.array([-1.5, -0.7, -0.2, 0.4, 1.4, 3.0]),\n            \"dt\": 10.0,\n            \"h_func\": lambda vx, vy, vz: np.exp(-(vx**2 + vy**2 + vz**2)),\n            \"s_func\": lambda vx, vy, vz, h: (\n                2.0 * vx - 3.0 * vy + 1.5 * vz + 0.7 * (vx**2 + vy**2 + vz**2) \n                - 1.0 * h + 0.2 * vx * vy - 0.05 * vy * vz + 0.02 * vx * vz\n            ),\n        },\n    ]\n\n    results = []\n\n    for case in test_cases:\n        vx_nodes, vy_nodes, vz_nodes = case[\"vx_nodes\"], case[\"vy_nodes\"], case[\"vz_nodes\"]\n\n        # 1. Construct the grid and weights\n        def get_weights_1d(nodes):\n            if len(nodes)  2:\n                return np.ones_like(nodes) if len(nodes) == 1 else np.array([])\n            \n            dv = np.zeros_like(nodes, dtype=float)\n            dv[0] = (nodes[1] - nodes[0]) / 2.0\n            dv[-1] = (nodes[-1] - nodes[-2]) / 2.0\n            dv[1:-1] = (nodes[2:] - nodes[:-2]) / 2.0\n            return dv\n\n        dvx = get_weights_1d(vx_nodes)\n        dvy = get_weights_1d(vy_nodes)\n        dvz = get_weights_1d(vz_nodes)\n\n        # Create 3D grid and weights\n        vx, vy, vz = np.meshgrid(vx_nodes, vy_nodes, vz_nodes, indexing='ij')\n        weights_3d = np.einsum('i,j,k->ijk', dvx, dvy, dvz)\n        \n        # Flatten all arrays\n        N = vx.size\n        vx_flat = vx.flatten()\n        vy_flat = vy.flatten()\n        vz_flat = vz.flatten()\n        w_flat = weights_3d.flatten()\n\n        # 2. Evaluate functions on the grid\n        h = case[\"h_func\"](vx_flat, vy_flat, vz_flat)\n        s_uncorrected = case[\"s_func\"](vx_flat, vy_flat, vz_flat, h)\n\n        # Define invariant basis functions\n        phi_0 = np.ones(N)\n        phi_1 = vx_flat\n        phi_2 = vy_flat\n        phi_3 = vz_flat\n        phi_4 = vx_flat**2 + vy_flat**2 + vz_flat**2\n        phis = [phi_0, phi_1, phi_2, phi_3, phi_4]\n        \n        # 3. Assemble and solve the linear system\n        num_invariants = len(phis)\n        gram_matrix = np.zeros((num_invariants, num_invariants))\n        b_vector = np.zeros(num_invariants)\n\n        w_s = w_flat * s_uncorrected\n        for j in range(num_invariants):\n            b_vector[j] = np.sum(phis[j] * w_s)\n            for k in range(j, num_invariants):\n                val = np.sum(phis[j] * w_flat * phis[k])\n                gram_matrix[j, k] = val\n                gram_matrix[k, j] = val\n\n        coeffs = linalg.solve(gram_matrix, b_vector, assume_a='sym')\n\n        # 4. Compute the corrected source\n        s_parallel = np.zeros(N)\n        for k in range(num_invariants):\n            s_parallel += coeffs[k] * phis[k]\n        \n        s_perp = s_uncorrected - s_parallel\n\n        # 5. Calculate residuals\n        residuals = []\n        w_s_perp = w_flat * s_perp\n        for j in range(num_invariants):\n            residual = np.sum(phis[j] * w_s_perp)\n            residuals.append(residual)\n        \n        max_abs_residual = np.max(np.abs(residuals))\n        results.append(max_abs_residual)\n\n    # Format the final output\n    print(f\"[{','.join(f'{r:.15e}' for r in results)}]\")\n\nif __name__ == \"__main__\":\n    solve()\n```"
        }
    ]
}