{
    "hands_on_practices": [
        {
            "introduction": "To accurately model plasma turbulence in a local, field-following simulation box, we must account for the geometry of the magnetic field. In a tokamak, magnetic field lines on adjacent flux surfaces have different pitches, a property known as magnetic shear. This first exercise  drills down into the core mathematical origin of the twist-and-shift boundary condition, directly connecting the magnetic shear parameter $\\hat{s}$ to the required coordinate shift at the domain boundary. By demonstrating that the shift vanishes when shear is absent, you will build a foundational understanding of why this specialized boundary condition is indispensable for simulating sheared magnetic fields.",
            "id": "4198330",
            "problem": "Consider a local flux-tube model for a magnetized plasma in field-aligned coordinates $(x,y,z)$, where $x$ is a dimensionless radial coordinate, $y$ is a dimensionless binormal coordinate, and $z$ is a dimensionless parallel coordinate proportional to the poloidal angle. The magnetic field admits a Clebsch representation $\\boldsymbol{B}=\\nabla \\alpha \\times \\nabla \\psi$, where $\\psi$ is a flux function and $\\alpha$ is a field-line label that is constant along field lines. In a standard local ordering with dimensionless magnetic shear $\\hat{s}$, one may choose the field-line label locally as $\\alpha=y-\\hat{s}\\,x\\,z$. A scalar fluctuation $f(x,y,z)$ is defined on a parallel domain $z\\in[-L_{z}/2,L_{z}/2]$. The twist-and-shift boundary condition enforces single-valuedness of $f$ along a magnetic field line when identifying the ends $z=-L_{z}/2$ and $z=+L_{z}/2$, which implies the value of $f$ at $(x,y,+L_{z}/2)$ must equal its value at the point $(x,y',-L_{z}/2)$ that lies on the same field line (i.e., has the same $\\alpha$). Starting only from the facts that $\\alpha$ is constant along field lines, that $\\alpha=y-\\hat{s}\\,x\\,z$, and that $f$ is single-valued along a field line, derive the binormal mapping $y'\\equiv y-\\Delta y$ required by the twist-and-shift identification at the two ends, expressed as an explicit formula for $\\Delta y$ in terms of $\\hat{s}$, $x$, and $L_{z}$. Then, evaluate $\\Delta y$ at $\\hat{s}=0$. All coordinates are dimensionless in the adopted normalization; report the final value of $\\Delta y$ at $\\hat{s}=0$ as a dimensionless quantity. Your final answer must be a single number or a single closed-form expression. No rounding is required.",
            "solution": "The starting point is the Clebsch representation $\\boldsymbol{B}=\\nabla \\alpha \\times \\nabla \\psi$ together with the definition of the local field-line label $\\alpha=y-\\hat{s}\\,x\\,z$. By construction, $\\alpha$ is constant along a magnetic field line. The twist-and-shift boundary condition enforces that when one identifies the two parallel ends $z=-L_{z}/2$ and $z=+L_{z}/2$, the scalar field $f$ is single-valued along a given field line. This is implemented by requiring that the point $(x,y,+L_{z}/2)$ be matched to a point $(x,y',-L_{z}/2)$ lying on the same field line, which is equivalent to demanding that the field-line label $\\alpha$ be equal at the two endpoints for those two points.\n\nImpose the equality of the field-line label at the two ends:\n$$\n\\alpha\\big|_{(x,y,+L_{z}/2)}=\\alpha\\big|_{(x,y',-L_{z}/2)}.\n$$\nUsing $\\alpha = y - \\hat{s}\\,x\\,z$, the left-hand side is\n$$\n\\alpha\\big|_{(x,y,+L_{z}/2)}=y-\\hat{s}\\,x\\left(+\\frac{L_{z}}{2}\\right),\n$$\nand the right-hand side is\n$$\n\\alpha\\big|_{(x,y',-L_{z}/2)}=y'-\\hat{s}\\,x\\left(-\\frac{L_{z}}{2}\\right)=y'+\\hat{s}\\,x\\left(\\frac{L_{z}}{2}\\right).\n$$\nEquating these expressions gives\n$$\ny-\\hat{s}\\,x\\left(\\frac{L_{z}}{2}\\right)=y'+\\hat{s}\\,x\\left(\\frac{L_{z}}{2}\\right).\n$$\nSolving for $y'$ yields\n$$\ny'=y-\\hat{s}\\,x\\,L_{z}.\n$$\nBy defining the required shift $\\Delta y$ through $y'=y-\\Delta y$, one immediately identifies\n$$\n\\Delta y=\\hat{s}\\,x\\,L_{z}.\n$$\nThis mapping ensures that $\\alpha$ is unchanged when passing from $z=+L_{z}/2$ to $z=-L_{z}/2$, and therefore enforces single-valuedness of $f$ along a field line via\n$$\nf\\!\\left(x,y,+\\frac{L_{z}}{2}\\right)=f\\!\\left(x,y-\\Delta y,-\\frac{L_{z}}{2}\\right), \\quad \\Delta y=\\hat{s}\\,x\\,L_{z}.\n$$\n\nFinally, evaluating this shift at zero magnetic shear $\\hat{s}=0$ gives\n$$\n\\Delta y\\big|_{\\hat{s}=0}=0.\n$$\nWith $\\Delta y=0$, the twist-and-shift identification reduces to the simple periodic boundary condition\n$$\nf\\!\\left(x,y,+\\frac{L_{z}}{2}\\right)=f\\!\\left(x,y,-\\frac{L_{z}}{2}\\right).\n$$\nThe requested final value of $\\Delta y$ at $\\hat{s}=0$ is therefore $0$, a dimensionless number in the adopted normalization.",
            "answer": "$$\\boxed{0}$$"
        },
        {
            "introduction": "While the physics of magnetic shear is continuous, numerical simulations operate on discrete grids. For spectral (Fourier-based) codes, this discretization imposes important constraints on the simulation parameters. This next practice  explores the crucial link between the physical shear and the discrete Fourier grid used in a flux-tube simulation. Deriving this \"closure condition\" is a vital step in understanding how to construct a numerically stable and physically valid simulation, ensuring that the twist-and-shift operation correctly maps the Fourier modes onto the computational grid.",
            "id": "4198300",
            "problem": "Consider a local field-aligned flux-tube model for gyrokinetic turbulence in fusion plasmas, with perpendicular coordinates $(x,y)$ and parallel coordinate $z$ along the magnetic field. The perpendicular plane is doubly periodic with domain sizes $L_x$ and $L_y$, so that any fluctuating scalar field $f(x,y,z)$ can be expanded at each $z$ as a Fourier series in $(x,y)$ using discrete wavenumbers $k_x = \\frac{2\\pi}{L_x} n_x$ and $k_y = \\frac{2\\pi}{L_y} n_y$ with integers $n_x$ and $n_y$. The parallel coordinate is periodic with extent $L_z$, and a twist-and-shift boundary condition is imposed to account for uniform magnetic shear $\\hat{s}$.\n\nAdopt the standard field-aligned binormal coordinate $\\alpha(y,z)$ defined by a linear shear mapping of the form $\\alpha(y,z) = y + \\hat{s}\\,z\\,x$, which relates the perpendicular coordinates to the field-line label in a sheared slab approximation. Assume the fluctuating phase of a Fourier component is constructed to be constant on surfaces of constant $\\alpha$ and $x$ at $z=0$, and use this to infer how the effective radial wavenumber evolves with $z$ under uniform magnetic shear.\n\nStarting only from: (i) the periodicity of $(x,y)$ implying a discrete Fourier grid with spacing $\\Delta k_x = \\frac{2\\pi}{L_x}$ for $k_x$, (ii) the definition of $\\alpha(y,z)$ above, and (iii) the requirement that after advancing by one parallel period $L_z$ the twist-and-shift remap must land exactly on the discrete $k_x$ grid, derive the closure condition that quantifies the necessary relationship among $\\hat{s}$, $k_y$, $L_z$, and $L_x$ in terms of an integer mode index remap. Then, express the integer remap count $m$ as a single closed-form analytic expression in terms of $\\hat{s}$, $k_y$, $L_z$, and $L_x$.\n\nYour final answer must be the expression for $m$ only, written without units. No numerical evaluation is required. If intermediate dimensional analysis is performed, ensure all quantities are used in a physically consistent manner appropriate for field-aligned, sheared-slab gyrokinetic modeling.",
            "solution": "The problem requires the derivation of the closure condition for a twist-and-shift boundary condition in a sheared slab magnetic geometry and to find an expression for the integer remap count $m$. The derivation will proceed by determining how the radial wavenumber evolves along the parallel coordinate and then applying the periodicity constraint.\n\nLet's begin by considering a single Fourier component of a fluctuating scalar field $f(x,y,z)$ at the reference plane $z=0$. Its spatial dependence is given by the phase factor $\\exp[i(k_x x + k_y y)]$, where $k_x$ and $k_y$ are the radial and binormal wavenumbers, respectively. We denote the initial radial wavenumber at $z=0$ as $k_x(0)$.\n\nThe problem introduces a field-aligned binormal coordinate $\\alpha(y,z) = y + \\hat{s} z x$ and states this serves as a field-line label. In a field-aligned coordinate system, magnetic field lines are represented by curves of constant coordinates. Therefore, for a fixed radial position $x=x_c$, a magnetic field line is a curve in the $(y,z)$-plane where $\\alpha$ is constant. Let this constant be $\\alpha_c$. From the definition of $\\alpha$, we have $y(z) + \\hat{s} z x_c = \\alpha_c$. This can be rewritten as $y(z) = \\alpha_c - \\hat{s} z x_c$. Differentiating this expression with respect to $z$ gives the slope of the field line projection:\n$$ \\frac{dy}{dz} = -\\hat{s} x_c $$\nThis equation describes the trajectory of magnetic field lines in this model.\n\nThe principle of a field-aligned representation is that turbulent structures are highly elongated along the magnetic field. Therefore, the phase of a mode at a point $(x,y,z)$ should be determined by its phase at the point $(x,y_0,0)$ at the $z=0$ plane that lies on the same field line. We can find the back-traced coordinate $y_0$ by integrating the field line equation from $z$ to $0$:\n$$ y(0) - y(z) = \\int_z^0 (-\\hat{s} x) dz' = (-\\hat{s} x)(-z) = \\hat{s} x z $$\nSo, the corresponding point at $z=0$ is $(x, y_0)$ with $y_0 = y(z) + \\hat{s} x z$.\n\nLet the phase of the Fourier mode at $z=0$ be $S_0(x,y) = k_x(0) x + k_y y$. Due to the field-aligned nature, the phase $S(x,y,z)$ of the mode at an arbitrary $z$ is given by evaluating $S_0$ at the back-traced coordinates:\n$$ S(x,y,z) = S_0(x, y_0) = S_0(x, y + \\hat{s} x z) = k_x(0) x + k_y (y + \\hat{s} x z) $$\nWe can re-group the terms to identify the effective wavenumbers at coordinate $z$:\n$$ S(x,y,z) = [k_x(0) + k_y \\hat{s} z]x + k_y y $$\nThis demonstrates how the binormal wavenumber $k_y$ remains constant, but the effective radial wavenumber $k_x^{\\text{eff}}$ evolves linearly with $z$:\n$$ k_x^{\\text{eff}}(z) = k_x(0) + k_y \\hat{s} z $$\nThis result follows from premise (ii), the definition of $\\alpha(y,z)$.\n\nNext, we apply the boundary conditions. The system is periodic in the parallel direction with period $L_z$. The twist-and-shift boundary condition, as stated in premise (iii), requires that the field structure at $z=L_z$ must be representable on the same discrete Fourier grid as the field at $z=0$. This implies that the evolved radial wavenumber $k_x^{\\text{eff}}(L_z)$ must coincide with one of the allowed discrete values for $k_x$.\n\nThe total shift in the radial wavenumber after one parallel period $L_z$ is:\n$$ \\Delta k_x = k_x^{\\text{eff}}(L_z) - k_x(0) = (k_x(0) + k_y \\hat{s} L_z) - k_x(0) = k_y \\hat{s} L_z $$\n\nAccording to premise (i), the periodicity of the domain in the $x$ direction with size $L_x$ defines a discrete grid for the radial wavenumber $k_x$. The spacing between adjacent points on this grid is $\\Delta k_x^{\\text{grid}} = \\frac{2\\pi}{L_x}$. For the evolved mode to land on a point on this grid, its total wavenumber shift, $\\Delta k_x$, must be an integer multiple of the grid spacing $\\Delta k_x^{\\text{grid}}$. We denote this integer as $m$, which is the \"integer remap count\".\n$$ \\Delta k_x = m \\cdot \\Delta k_x^{\\text{grid}} $$\nwhere $m$ must be an integer ($m \\in \\mathbb{Z}$).\n\nSubstituting the expressions for the wavenumber shift and the grid spacing gives the closure condition:\n$$ k_y \\hat{s} L_z = m \\frac{2\\pi}{L_x} $$\nThis equation establishes the required relationship among the magnetic shear $\\hat{s}$, the binormal wavenumber $k_y$, the parallel length $L_z$, and the radial length $L_x$.\n\nThe final step is to solve this equation for the integer remap count $m$. Rearranging the terms, we obtain the closed-form expression for $m$:\n$$ m = \\frac{k_y \\hat{s} L_z L_x}{2\\pi} $$\nThis expression quantifies the number of grid spacings the radial wavenumber $k_x$ is shifted by after one parallel transit, ensuring that the twist-and-shift boundary condition is satisfied. For this condition to hold, the parameters of the simulation must be chosen such that the right-hand side evaluates to an integer for the discrete values of $k_y$ used in the simulation.",
            "answer": "$$\n\\boxed{\\frac{k_y \\hat{s} L_z L_x}{2\\pi}}\n$$"
        },
        {
            "introduction": "The principles of magnetic shear and twist-and-shift boundary conditions are not just theoretical constructs; they are essential tools for simulating real fusion devices. The geometric complexity, and thus the nature of the magnetic shear, can vary dramatically between an axisymmetric tokamak and a non-axisymmetric stellarator. This final, hands-on coding problem  challenges you to implement and compare the effects of shear in these two distinct configurations. By quantifying the numerical error that arises from using an incorrect (periodic) versus a correct (twist-and-shift) boundary condition, you will gain a practical appreciation for why accurately modeling the field-line geometry is critical for predictive turbulence simulations.",
            "id": "4198292",
            "problem": "Consider a simplified linear flux-tube representation of an Ion Temperature Gradient (ITG) mode in a magnetized plasma. The perpendicular fluctuation is represented as a single Fourier component in the plane orthogonal to the magnetic field with perpendicular wavevector components $k_x$ and $k_y$. The parallel coordinate $z$ follows the magnetic field line and is an angle measured in radians. In the presence of magnetic shear, the radial wavenumber $k_x$ varies with $z$ due to the transformation of the perpendicular coordinates along the field line. The twist-and-shift boundary condition is designed to ensure continuity of the Fourier mode across the ends of the parallel domain $z \\in [0,L_z]$ by appropriately shifting $k_x$ at $z=L_z$ relative to $z=0$ by an amount that depends on the integrated geometric shear. In contrast, a naive periodic boundary condition applies zero shift in $k_x$.\n\nStarting from first principles, model the effect of magnetic shear by showing that the change in radial wavenumber across the parallel domain, denoted $\\Delta k_x$, is determined by the integral of a local shear function $s(z)$ weighted by $k_y$. Precisely, derive $\\Delta k_x$ in terms of $k_y$, $s(z)$, and $L_z$. For an axisymmetric tokamak, take the local shear to be constant $s(z)=\\hat{s}$, where $\\hat{s}$ is the magnetic shear parameter. For a non-axisymmetric stellarator, take the local shear to be a simple but nontrivial function of the parallel angle,\n$$\ns(z) = s_0 + s_1 \\cos(z) + s_2 \\sin(2z),\n$$\nwhere $s_0$, $s_1$, and $s_2$ are constants determined by the geometry. All angles are measured in radians.\n\nYou must implement an algorithm to quantify the discrete-grid mismatch induced by applying either:\n- periodic boundary condition (no shift in $k_x$ at the boundary), or\n- twist-and-shift boundary condition (apply an integer index shift in the discrete $k_x$ grid to minimize mismatch).\n\nAssume an identical perpendicular $k_x$ grid for both geometries with uniform spacing $\\Delta k_x^{\\mathrm{grid}}$. Given a computed $\\Delta k_x$ for a geometry, define the dimensionless mismatch error for a chosen integer grid shift $\\Delta i$ as\n$$\ne = \\frac{\\left|\\Delta k_x - \\Delta i \\, \\Delta k_x^{\\mathrm{grid}}\\right|}{\\Delta k_x^{\\mathrm{grid}}}.\n$$\nFor the periodic boundary condition, set $\\Delta i = 0$. For the twist-and-shift boundary condition, choose the integer $\\Delta i$ that minimizes $e$.\n\nYour program must compute, for a set of test cases, the four errors:\n- tokamak periodic error $e_{\\text{per,tok}}$,\n- tokamak twist-and-shift error $e_{\\text{tw,tok}}$,\n- stellarator periodic error $e_{\\text{per,stel}}$,\n- stellarator twist-and-shift error $e_{\\text{tw,stel}}$.\n\nUse the following test suite, where all angles are in radians and all wavenumbers are in normalized units typical of gyrokinetic simulations. Each test case specifies the grid spacing $\\Delta k_x^{\\mathrm{grid}}$, the binormal wavenumber $k_y$, the parallel domain length $L_z$, the tokamak shear $\\hat{s}$, and the stellarator shear coefficients $(s_0,s_1,s_2)$:\n\n- Test Case 1 (general case with moderate shear and nontrivial $z$ geometry):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.125$, $k_y = 0.35$, $L_z = 3.0$,\n    - tokamak $\\hat{s} = 0.8$,\n    - stellarator $(s_0,s_1,s_2) = (0.6,0.3,0.1)$.\n\n- Test Case 2 (perfect registry for tokamak twist-and-shift, near-registry for stellarator):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.1$, $k_y = 0.4$, $L_z = 2.0$,\n    - tokamak $\\hat{s} = 1.25$,\n    - stellarator $(s_0,s_1,s_2) = (1.1,0.2,-0.1)$.\n\n- Test Case 3 (half-grid mismatch for tokamak, near-exact registry for stellarator):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.2$, $k_y = 0.5$, $L_z = 1.5$,\n    - tokamak $\\hat{s} = 0.9333333333333$,\n    - stellarator $(s_0,s_1,s_2) = (0.6,0.3,0.0)$.\n\n- Test Case 4 (no binormal variation, both geometries yield zero shift):\n    - $\\Delta k_x^{\\mathrm{grid}} = 0.15$, $k_y = 0.0$, $L_z = 2.5$,\n    - tokamak $\\hat{s} = 1.0$,\n    - stellarator $(s_0,s_1,s_2) = (0.7,0.2,0.05)$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. The list must contain the four errors for each test case in the order\n$$\n\\left[e_{\\text{per,tok}}^{(1)}, e_{\\text{tw,tok}}^{(1)}, e_{\\text{per,stel}}^{(1)}, e_{\\text{tw,stel}}^{(1)}, \\ldots, e_{\\text{per,tok}}^{(4)}, e_{\\text{tw,tok}}^{(4)}, e_{\\text{per,stel}}^{(4)}, e_{\\text{tw,stel}}^{(4)}\\right],\n$$\nwhere the superscript indicates the test case index. All angles must be in radians, and all outputs must be floats without units.",
            "solution": "The problem statement has been critically evaluated and is determined to be valid. It is scientifically grounded within the established framework of gyrokinetic flux-tube simulations in plasma physics, is mathematically well-posed, and is presented in an objective, formal language. All necessary data and definitions for a unique solution are provided.\n\nThe primary task is to derive the total shift in the radial wavenumber, $\\Delta k_x$, over a parallel domain of length $L_z$ for two different magnetic geometries (tokamak and stellarator), and then to quantify the numerical error introduced when discretizing this shift for both periodic and twist-and-shift boundary conditions.\n\nFirst, we establish the theoretical basis for the wavenumber shift. In the flux-tube model, the magnetic field has a local shear, which causes the orientation of the perpendicular coordinates to change as one moves along a magnetic field line. This geometric effect manifests as a change in the radial wavenumber $k_x$ for a fixed binormal wavenumber $k_y$. The rate of change of $k_x$ with respect to the parallel coordinate $z$ is given by the fundamental relation:\n$$\n\\frac{d k_x}{d z} = k_y s(z)\n$$\nwhere $s(z)$ is the local magnetic shear function.\n\nTo find the total change in the radial wavenumber, $\\Delta k_x = k_x(L_z) - k_x(0)$, we integrate this differential equation over the parallel domain, from $z=0$ to $z=L_z$:\n$$\n\\Delta k_x = \\int_0^{L_z} \\frac{d k_x}{d z'} dz' = \\int_0^{L_z} k_y s(z') dz' = k_y \\int_0^{L_z} s(z') dz'\n$$\nThis formula provides the physically required shift in $k_x$ that a numerical scheme must accommodate to maintain the continuity of the mode across the parallel boundary.\n\nNext, we apply this general formula to the two specific cases defined in the problem.\n\nFor an axisymmetric tokamak, the magnetic shear is approximately constant along the field line within the flux tube, so $s(z) = \\hat{s}$. The integral is straightforward:\n$$\n\\int_0^{L_z} \\hat{s} \\, dz' = \\hat{s} \\int_0^{L_z} dz' = \\hat{s} L_z\n$$\nThus, the wavenumber shift for the tokamak is:\n$$\n\\Delta k_{x, \\text{tok}} = k_y \\hat{s} L_z\n$$\n\nFor a non-axisymmetric stellarator, the shear varies along the field line. The problem provides the model function $s(z) = s_0 + s_1 \\cos(z) + s_2 \\sin(2z)$. We must integrate this function from $z=0$ to $z=L_z$:\n$$\n\\int_0^{L_z} \\left(s_0 + s_1 \\cos(z') + s_2 \\sin(2z')\\right) dz' = \\left[ s_0 z' + s_1 \\sin(z') - \\frac{s_2}{2} \\cos(2z') \\right]_0^{L_z}\n$$\nEvaluating the definite integral yields:\n$$\n\\left( s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} \\cos(2L_z) \\right) - \\left( s_0 \\cdot 0 + s_1 \\sin(0) - \\frac{s_2}{2} \\cos(0) \\right) = s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} \\cos(2L_z) + \\frac{s_2}{2}\n$$\nTherefore, the wavenumber shift for the stellarator is:\n$$\n\\Delta k_{x, \\text{stel}} = k_y \\left( s_0 L_z + s_1 \\sin(L_z) - \\frac{s_2}{2} (\\cos(2L_z) - 1) \\right)\n$$\n\nThe final step is to quantify the numerical mismatch error. The computational grid for the radial wavenumber is discrete, with a uniform spacing $\\Delta k_x^{\\mathrm{grid}}$. A numerical boundary condition must approximate the physical shift $\\Delta k_x$ by an integer multiple of this grid spacing, i.e., by $\\Delta i \\, \\Delta k_x^{\\mathrm{grid}}$ for some integer $\\Delta i$. The dimensionless mismatch error $e$ is defined as:\n$$\ne = \\frac{\\left|\\Delta k_x - \\Delta i \\, \\Delta k_x^{\\mathrm{grid}}\\right|}{\\Delta k_x^{\\mathrm{grid}}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} - \\Delta i \\right|\n$$\n\nFor the periodic boundary condition, no shift is applied, which corresponds to setting the grid shift index $\\Delta i = 0$. The error is then:\n$$\ne_{\\text{per}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} \\right|\n$$\n\nFor the twist-and-shift boundary condition, the integer grid shift $\\Delta i$ is chosen to minimize the error $e$. This is achieved by selecting the integer $\\Delta i$ that is closest to the value of the ratio $X = \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}}$. This optimal integer shift is $\\Delta i_{\\text{opt}} = \\text{round}(X)$, where the $\\text{round}$ function maps a real number to its nearest integer. The resulting minimal error is:\n$$\ne_{\\text{tw}} = \\left| \\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}} - \\text{round}\\left(\\frac{\\Delta k_x}{\\Delta k_x^{\\mathrm{grid}}}\\right) \\right|\n$$\n\nThe algorithm to be implemented will, for each test case, first compute $\\Delta k_{x, \\text{tok}}$ and $\\Delta k_{x, \\text{stel}}$ using the derived formulas. Then, using these values and the given $\\Delta k_x^{\\mathrm{grid}}$, it will calculate the four required errors: $e_{\\text{per,tok}}$, $e_{\\text{tw,tok}}$, $e_{\\text{per,stel}}$, and $e_{\\text{tw,stel}}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem of calculating boundary condition mismatch errors for a set of\n    gyrokinetic simulation test cases.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Test Case 1: general case\n        {'delta_kx_grid': 0.125, 'ky': 0.35, 'Lz': 3.0, 's_hat': 0.8, 's_coeffs': (0.6, 0.3, 0.1)},\n        # Test Case 2: perfect registry for tokamak T&S\n        {'delta_kx_grid': 0.1, 'ky': 0.4, 'Lz': 2.0, 's_hat': 1.25, 's_coeffs': (1.1, 0.2, -0.1)},\n        # Test Case 3: half-grid mismatch for tokamak\n        {'delta_kx_grid': 0.2, 'ky': 0.5, 'Lz': 1.5, 's_hat': 0.9333333333333, 's_coeffs': (0.6, 0.3, 0.0)},\n        # Test Case 4: no binormal variation\n        {'delta_kx_grid': 0.15, 'ky': 0.0, 'Lz': 2.5, 's_hat': 1.0, 's_coeffs': (0.7, 0.2, 0.05)},\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        delta_kx_grid = case['delta_kx_grid']\n        ky = case['ky']\n        Lz = case['Lz']\n        s_hat = case['s_hat']\n        s0, s1, s2 = case['s_coeffs']\n\n        # --- Calculate physical wavenumber shifts ---\n\n        # Tokamak shift\n        delta_kx_tok = ky * s_hat * Lz\n\n        # Stellarator shift\n        integral_stel = s0 * Lz + s1 * np.sin(Lz) - (s2 / 2.0) * (np.cos(2.0 * Lz) - 1.0)\n        delta_kx_stel = ky * integral_stel\n\n        # --- Calculate mismatch errors ---\n        \n        def calculate_errors(delta_kx, grid_spacing):\n            \"\"\"\n            Calculates periodic and twist-and-shift errors for a given physical shift.\n            \n            Args:\n                delta_kx (float): The physical shift in kx.\n                grid_spacing (float): The kx grid spacing.\n            \n            Returns:\n                tuple[float, float]: A tuple containing the periodic error and the \n                                     twist-and-shift error.\n            \"\"\"\n            if grid_spacing == 0:\n                # Avoid division by zero, though problem constraints make this unlikely.\n                return (np.inf, np.inf)\n            \n            # The ratio of the physical shift to the grid spacing\n            X = delta_kx / grid_spacing\n            \n            # Periodic error (shift index Delta_i = 0)\n            e_per = np.abs(X)\n            \n            # Twist-and-shift error (optimal integer shift)\n            # np.round rounds to the nearest even integer for .5 cases (e.g., round(2.5)=2, round(3.5)=4)\n            # The resulting error is 0.5 regardless, so this is fine.\n            delta_i_opt = np.round(X)\n            e_tw = np.abs(X - delta_i_opt)\n\n            return e_per, e_tw\n\n        # Calculate the four errors for the current test case\n        e_per_tok, e_tw_tok = calculate_errors(delta_kx_tok, delta_kx_grid)\n        e_per_stel, e_tw_stel = calculate_errors(delta_kx_stel, delta_kx_grid)\n\n        all_results.extend([e_per_tok, e_tw_tok, e_per_stel, e_tw_stel])\n\n    # Final print statement in the exact required format.\n    # The map(str, ...) converts all floats to their string representation.\n    print(f\"[{','.join(map(str, all_results))}]\")\n\nsolve()\n```"
        }
    ]
}