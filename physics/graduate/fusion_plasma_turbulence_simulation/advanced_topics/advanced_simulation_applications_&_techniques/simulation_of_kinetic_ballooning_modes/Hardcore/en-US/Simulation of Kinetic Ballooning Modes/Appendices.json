{
    "hands_on_practices": [
        {
            "introduction": "The foundation of any plasma turbulence simulation is the background magnetic equilibrium. This first exercise provides a practical, first-principles derivation of two of the most critical geometric parameters that govern kinetic instabilities: the safety factor $q$ and the magnetic shear $\\hat{s}$. By starting from a model toroidal current profile, you will connect a macroscopic plasma property to the microscopic simulation inputs that shape the structure of Kinetic Ballooning Modes.",
            "id": "4016862",
            "problem": "Consider a large-aspect-ratio, axisymmetric tokamak with circular, concentric magnetic flux surfaces. The major radius is $R_{0}$ and the minor radius coordinate labeling flux surfaces is $r \\in [0,a]$. The equilibrium toroidal magnetic field is produced by external coils and is given by $B_{\\phi}(R) = B_{0} R_{0}/R$. The plasma carries a toroidal current that produces a poloidal magnetic field; the total toroidal current enclosed within radius $r$ is $I_{\\mathrm{t}}(r) = I_{0} \\, r/a$, where $I_{0}$ and $a$ are constants. Assume $R \\approx R_{0}$ on each flux surface to leading order in inverse aspect ratio, and neglect geometric corrections beyond this order.\n\nDefine the poloidal magnetic flux function $\\psi(r)$ so that the poloidal magnetic flux enclosed per radian is $2\\pi \\psi$, with the normalization $\\partial \\psi/\\partial r = R_{0} B_{\\theta}(r)$, where $B_{\\theta}(r)$ is the poloidal magnetic field strength on the flux surface of radius $r$. The plasma consists of multiple kinetic species (e.g., main ions, electrons, and a dilute impurity species), but all species share the same equilibrium magnetic geometry described above.\n\nStarting only from fundamental definitions and laws (for example, Maxwell–Ampère’s law $\\nabla \\times \\mathbf{B} = \\mu_{0} \\mathbf{J}$ in magnetostatics and the definition of the safety factor as the number of toroidal turns per poloidal turn of a magnetic field line), derive closed-form expressions for the safety factor $q(\\psi)$ and the magnetic shear $\\hat{s}$, where $\\hat{s}$ is defined by $\\hat{s} = (r/q)\\, \\mathrm{d}q/\\mathrm{d}r$ in the large-aspect-ratio, circular limit.\n\nThen, using your derived expressions, discuss the implications of $q(\\psi)$ and $\\hat{s}$ for the linear mode structure and ballooning representation in multi-species gyrokinetic simulations. In particular, reason from first principles how $q$ and $\\hat{s}$ enter the parallel connection length, the field-line mapping, and the localization of eigenfunctions along the field line when multiple kinetic species are present. Your discussion should emphasize qualitative cause-and-effect grounded in the derived geometry, not numerical estimates.\n\nExpress the final answer as the pair of closed-form analytic expressions for $q(\\psi)$ and $\\hat{s}$ with no numerical substitution. No rounding is required. The final answer must be dimensionless.",
            "solution": "The problem statement is critically validated before proceeding to a solution.\n\n### Step 1: Extract Givens\n-   **System:** Large-aspect-ratio, axisymmetric tokamak with circular, concentric magnetic flux surfaces.\n-   **Coordinates:** Major radius $R_0$, minor radius $r \\in [0,a]$.\n-   **Toroidal Magnetic Field:** $B_{\\phi}(R) = B_{0} R_{0}/R$, where $B_0$ is the on-axis field strength.\n-   **Toroidal Current:** The total toroidal current enclosed within radius $r$ is $I_{\\mathrm{t}}(r) = I_{0} \\, r/a$.\n-   **Approximation:** In the large-aspect-ratio limit, $R \\approx R_0$ on each flux surface.\n-   **Poloidal Flux Function:** $\\psi(r)$ is defined such that its derivative with respect to the minor radius is normalized as $\\partial \\psi/\\partial r = R_{0} B_{\\theta}(r)$, where $B_{\\theta}(r)$ is the poloidal magnetic field.\n-   **Plasma Composition:** Multiple kinetic species share the same equilibrium magnetic geometry.\n-   **Definitions:**\n    -   Maxwell–Ampère’s law: $\\nabla \\times \\mathbf{B} = \\mu_{0} \\mathbf{J}$.\n    -   Safety factor, $q$: number of toroidal turns per poloidal turn of a magnetic field line.\n    -   Magnetic shear, $\\hat{s}$: $\\hat{s} = (r/q)\\, \\mathrm{d}q/\\mathrm{d}r$.\n-   **Tasks:**\n    1.  Derive closed-form expressions for the safety factor $q(\\psi)$ and magnetic shear $\\hat{s}$.\n    2.  Discuss the implications of the derived $q(\\psi)$ and $\\hat{s}$ for linear mode structure and the ballooning representation in multi-species gyrokinetic simulations.\n\n### Step 2: Validate Using Extracted Givens\n-   **Scientific Grounding:** The problem is firmly rooted in the standard magnetohydrodynamic (MHD) description of a tokamak plasma. The concepts of safety factor, magnetic shear, and the large-aspect-ratio circular approximation are canonical in fusion plasma physics. All definitions and laws cited are fundamental.\n-   **Well-Posedness:** The problem provides a specific current profile and magnetic field configuration, which are sufficient to uniquely determine the derived quantities $q$ and $\\hat{s}$. The tasks are well-defined.\n-   **Objectivity:** The problem is stated using precise, objective, and standard scientific terminology.\n-   **Completeness and Consistency:** The information provided is self-contained and sufficient for the derivation. The definition of $I_{\\mathrm{t}}(r)$ allows for the calculation of $B_{\\theta}(r)$ via Ampère's law. The normalization of $\\psi(r)$ allows for a transformation from $r$ as the independent variable to $\\psi$. The provided current profile $I_{\\mathrm{t}}(r) \\propto r$ implies a current density $J_{\\phi}(r) \\propto 1/r$, which is singular at $r=0$. While unphysical at the exact center, this is a common idealization in analytical models to produce tractable results and does not invalidate the mathematical problem as posed.\n-   **No other flaws are detected.** The problem is a standard exercise in tokamak equilibrium physics and its connection to kinetic theory.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution will be provided.\n\n### Derivation of Magnetic Geometry\n\nFirst, we determine the poloidal magnetic field, $B_{\\theta}(r)$, using Ampère's law in its integral form, $\\oint \\mathbf{B} \\cdot d\\mathbf{l} = \\mu_{0} I_{\\mathrm{enclosed}}$. We choose a circular Amperian loop of radius $r$ in the poloidal cross-section, concentric with the magnetic axis. The enclosed current is the total toroidal plasma current, $I_{\\mathrm{t}}(r)$.\n\n$$\nB_{\\theta}(r) \\cdot (2\\pi r) = \\mu_{0} I_{\\mathrm{t}}(r)\n$$\n\nThe problem states that $I_{\\mathrm{t}}(r) = I_{0} \\, r/a$. Substituting this expression:\n\n$$\nB_{\\theta}(r) \\cdot (2\\pi r) = \\mu_{0} \\left( \\frac{I_{0} r}{a} \\right)\n$$\n\nSolving for $B_{\\theta}(r)$, we find that it is surprisingly constant with respect to the minor radius $r$:\n\n$$\nB_{\\theta}(r) = \\frac{\\mu_{0} I_{0}}{2\\pi a}\n$$\n\nNext, we derive the safety factor, $q$. The safety factor $q$ is defined as the number of toroidal turns a magnetic field line makes for every single poloidal turn. In the large-aspect-ratio, circular flux surface approximation ($R \\approx R_0$, $B_\\phi \\approx B_0$), this is given by the ratio of the toroidal circumference (scaled by the magnetic pitch) to the poloidal circumference. A more formal derivation from tracking a field line, $\\frac{dl_{pol}}{dl_{tor}} = \\frac{B_{\\theta}}{B_{\\phi}}$, where $dl_{pol} = r d\\theta$ and $dl_{tor} = R d\\phi$, gives $\\frac{d\\phi}{d\\theta} = \\frac{R B_\\phi}{r B_\\theta}$. The safety factor is $q = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\frac{d\\phi}{d\\theta} d\\theta$. In this limit, this simplifies to:\n\n$$\nq(r) \\approx \\frac{r B_{\\phi}}{R_{0} B_{\\theta}} \\approx \\frac{r B_{0}}{R_{0} B_{\\theta}(r)}\n$$\n\nSubstituting our derived expression for $B_{\\theta}(r)$:\n\n$$\nq(r) = \\frac{r B_{0}}{R_{0} \\left( \\frac{\\mu_{0} I_{0}}{2\\pi a} \\right)} = \\left( \\frac{2\\pi a B_{0}}{\\mu_{0} I_{0} R_{0}} \\right) r\n$$\n\nThis shows that for the given current profile, the safety factor $q$ increases linearly with the minor radius $r$.\n\nNow, we calculate the magnetic shear, $\\hat{s}$, using its definition $\\hat{s} = (r/q) \\, \\mathrm{d}q/\\mathrm{d}r$.\nSince $q(r)$ is of the form $q(r) = C r$ where $C$ is a constant, its derivative is $\\mathrm{d}q/\\mathrm{d}r = C$.\nSubstituting this into the definition of $\\hat{s}$:\n\n$$\n\\hat{s} = \\frac{r}{C r} (C) = 1\n$$\n\nThe magnetic shear is constant and equal to $1$ throughout the plasma minor radius for this specific current profile.\n\nTo express $q$ as a function of the poloidal flux function $\\psi$, we must find the relationship between $r$ and $\\psi$. The problem provides the normalization $\\mathrm{d}\\psi/\\mathrm{d}r = R_{0} B_{\\theta}(r)$. Since $B_{\\theta}(r)$ is a constant, let's call it $B_{\\theta c} = \\frac{\\mu_{0} I_{0}}{2\\pi a}$.\n\n$$\n\\frac{\\mathrm{d}\\psi}{\\mathrm{d}r} = R_{0} B_{\\theta c}\n$$\n\nIntegrating with respect to $r$ from the magnetic axis ($r=0$) to a radius $r$, and setting the boundary condition $\\psi(0)=0$:\n\n$$\n\\psi(r) = \\int_0^r R_{0} B_{\\theta c} \\, dr' = R_{0} B_{\\theta c} r\n$$\n\nFrom this, we can express $r$ in terms of $\\psi$:\n$$\nr = \\frac{\\psi}{R_{0} B_{\\theta c}} = \\frac{\\psi}{R_0 \\left( \\frac{\\mu_0 I_0}{2\\pi a} \\right)} = \\frac{2\\pi a}{\\mu_0 I_0 R_0} \\psi\n$$\n\nFinally, we substitute this expression for $r$ into our equation for $q(r)$:\n\n$$\nq(\\psi) = \\left( \\frac{2\\pi a B_{0}}{\\mu_{0} I_{0} R_{0}} \\right) r(\\psi) = \\left( \\frac{2\\pi a B_{0}}{\\mu_{0} I_{0} R_{0}} \\right) \\left( \\frac{2\\pi a}{\\mu_0 I_0 R_0} \\psi \\right)\n$$\n\n$$\nq(\\psi) = \\frac{4 \\pi^2 a^2 B_{0}}{\\mu_0^2 I_0^2 R_0^2} \\psi\n$$\n\nThe magnetic shear $\\hat{s}=1$ is a constant, so it is already in its final form and does not depend on $\\psi$.\n\n### Implications for Gyrokinetic Simulations\n\nThe safety factor $q(\\psi)$ and magnetic shear $\\hat{s}$ are fundamental inputs for gyrokinetic simulations as they define the magnetic geometry upon which plasma instabilities and turbulence develop.\n\n1.  **Parallel Connection Length and Mode Resonance:** The safety factor $q$ sets the primary scale length for phenomena occurring along the magnetic field line. The parallel connection length, which is the characteristic distance along a field line between regions of favorable and unfavorable magnetic curvature, is approximately $L_c \\sim \\pi q R_0$. A higher value of $q$ implies a longer connection length. In gyrokinetics, the evolution of particle distribution functions is governed by an equation containing a parallel streaming term, $v_\\| \\nabla_\\|$, where $v_\\|$ is the particle velocity parallel to $\\mathbf{B}$ and $\\nabla_\\|$ is the parallel gradient operator. For a turbulent mode, $\\nabla_\\| \\sim 1/L_c \\sim 1/(q R_0)$. Thus, a high $q$ value reduces the effect of parallel streaming and associated damping mechanisms (like Landau damping), which can be destabilizing for certain microinstabilities such as drift waves. For a mode with toroidal number $n$ and poloidal number $m$, the resonant condition is met at a rational surface where $q=m/n$. Our derived linear profile, $q(\\psi) \\propto \\psi \\propto r$, implies that rational surfaces are spaced farther apart at larger radii.\n\n2.  **Field-Line Mapping, Shear, and Eigenfunction Localization:** The magnetic shear $\\hat{s}$ quantifies the radial variation of the field line pitch. A non-zero shear is crucial for mode localization. The ballooning representation is a mathematical tool that maps the two-dimensional problem in the poloidal plane to a one-dimensional problem along an extended field line coordinate, often denoted $\\theta \\in (-\\infty, \\infty)$. In this representation, the parallel wavevector operator for a mode localized near a rational surface becomes dependent on shear. To a first approximation, the effective parallel wavevector for a fluctuation varies along the field line as $k_\\|(\\theta) \\propto \\hat{s}\\theta$. Our result $\\hat{s}=1$ signifies moderate, positive magnetic shear.\n    -   **Cause and Effect:** A positive $\\hat{s}$ causes $k_\\|$ to increase as a particle moves along the field line away from the mode's center (typically the outboard midplane, $\\theta=0$). This rapid increase in $k_\\|$ enhances parallel (Landau) damping. The effect is to radially trap the mode energy, forcing the eigenfunction to be localized, or \"balloon,\" in the region of small $k_\\|$, which corresponds to the outboard side where the magnetic curvature is unfavorable for stability. The value $\\hat{s}=1$ provides a consistent and moderate degree of this localizing effect across all radii, unlike a realistic tokamak where $\\hat{s}$ typically varies with radius.\n\n3.  **Multi-species Context:** The magnetic geometry described by $q(\\psi)$ and $\\hat{s}$ is experienced by all particle species (e.g., electrons, main ions, impurities) equally. However, their kinetic responses are different due to differences in mass, charge, thermal velocity, and density/temperature gradients. The geometry sets the stage by defining the parallel mode structure (the eigenfunction). The resulting linear stability is then determined by the net balance of instability drives and damping contributions from all species integrated over this eigenfunction. For example, the constant shear $\\hat{s}=1$ will impose a specific ballooning structure. This structure, in turn, will determine the wave-particle resonance condition, $\\omega \\sim k_\\| v_\\|$, for each species. Since thermal velocities $v_{th,s} = \\sqrt{2 T_s / m_s}$ differ, the mode may be strongly resonant with one species (driving an instability like the Ion Temperature Gradient mode) while being damped by another. The specific profile $q(\\psi)$ and the constant value $\\hat{s}=1$ thus provide a fixed geometric framework that selects which kinetic effects of the various species become dominant in driving or suppressing turbulence.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} \\frac{4 \\pi^2 a^2 B_{0}}{\\mu_0^2 I_0^2 R_0^2} \\psi  1 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Once the magnetic geometry is defined by parameters like $q$ and $\\hat{s}$, the next challenge is to construct a computational domain that faithfully represents the physics. This practice focuses on the crucial choices of boundary conditions and domain parameters for a local \"flux-tube\" simulation, which models a small, field-aligned section of the tokamak. Properly handling the sheared magnetic field via \"twist-and-shift\" conditions is essential for capturing the correct KBM structure without introducing unphysical numerical artifacts.",
            "id": "4200502",
            "problem": "A local field-aligned flux-tube simulation of the Kinetic Ballooning Mode (KBM) in a tokamak core is to be set up using an electromagnetic gyrokinetic model. The magnetic geometry is approximated as circular with major radius $R_0$, minor radius $r$, safety factor $q(r)$, and magnetic shear $s = \\dfrac{r}{q}\\dfrac{dq}{dr}$. The binormal coordinate $y$ is Fourier decomposed with a single mode $k_y$, and the radial coordinate $x$ is treated in a spectral domain with discrete radial wavenumbers $k_x = m\\,\\Delta k_x$, where $m$ is an integer and $\\Delta k_x = 2\\pi/L_x$ for radial box length $L_x$. The parallel coordinate is the poloidal angle $\\theta$, taken as field-aligned arc length with $\\nabla_\\parallel \\sim \\dfrac{1}{qR_0}\\dfrac{\\partial}{\\partial \\theta}$.\n\nThe linear electromagnetic gyrokinetic system couples the perturbed electrostatic potential $\\phi(\\theta)$ and the parallel component of the vector potential $A_\\parallel(\\theta)$ through quasineutrality and parallel Ampère’s law. In the local ballooning representation, the perpendicular wavenumber along the field line takes the form $k_\\perp^2(\\theta) = k_y^2 + \\big(k_{x0} + s\\,k_y\\,\\theta\\big)^2$, where $k_{x0}$ is the $k_x$ value at $\\theta = 0$. The finite Larmor radius enters through Bessel functions of $k_\\perp \\rho_s$, with ion Larmor radius $\\rho_i$ setting the scale of perpendicular evanescence when $k_\\perp \\rho_i \\gg 1$. The KBM parallel eigenstructure is localized near the ballooning angle where $k_\\perp \\rho_i \\lesssim \\mathcal{O}(1)$ and decays for $|\\theta|$ where $k_\\perp \\rho_i \\gg 1$. The flux-tube method imposes periodicity along the field line modulo the shear-induced shift in $k_x$ after a poloidal circuit, commonly referred to as the “twist-and-shift” mapping.\n\nThe simulation domain in the parallel coordinate is truncated to a finite interval $\\theta \\in [-\\theta_{\\max}, \\theta_{\\max}]$, and boundary conditions must be chosen to minimize artificial reflections and spurious stabilization. Additionally, the discrete $k_x$ grid must be compatible with the field-line mapping over poloidal transits so that energy does not spuriously reflect between unresolved modes. From these facts and the geometric relationships above, select the boundary-condition and domain-choice strategy that most reliably captures the KBM linear physics (growth rate and mode structure) in a local flux-tube computation.\n\nA. Impose simple periodic boundary conditions in $\\theta$ with period $2\\theta_{\\max}$, independent of magnetic shear $s$, because $k_\\perp(\\theta)$ is periodic along a circular tokamak field line; choose $\\theta_{\\max}$ small (e.g., $\\theta_{\\max} = \\pi/2$) and any convenient $L_x$ to reduce computational cost.\n\nB. Impose ballooning (radiation-like) boundary conditions by enforcing $\\phi(\\pm \\theta_{\\max}) = 0$ and $A_\\parallel(\\pm \\theta_{\\max}) = 0$, and choose $\\theta_{\\max}$ large enough that $k_\\perp(\\theta_{\\max})\\,\\rho_i \\gg 1$ (so the eigenfunction tails are negligibly small at the boundaries). For the spectral radial domain, enforce a twist-and-shift mapping $f(k_x,\\theta+2\\pi) = f\\!\\big(k_x - 2\\pi s k_y, \\theta\\big)$ and select $L_x$ so that $n_s \\equiv \\dfrac{s\\,k_y\\,L_x}{2\\pi} \\in \\mathbb{Z}$, ensuring the shear-induced $k_x$ shift lands exactly on the discrete $k_x$ grid.\n\nC. Impose Neumann boundary conditions $\\dfrac{\\partial \\phi}{\\partial \\theta}\\big|_{\\pm \\theta_{\\max}} = 0$ and $\\dfrac{\\partial A_\\parallel}{\\partial \\theta}\\big|_{\\pm \\theta_{\\max}} = 0$ to preserve parallel symmetry while keeping $\\theta_{\\max}$ minimal; choose $L_x$ as small as possible to filter out low-$k_x$ content that would otherwise couple across poloidal transits.\n\nD. Replace the flux-tube field-aligned periodicity with global periodicity by requiring $n = m\\,q$ for toroidal and poloidal mode numbers and enforce periodicity in $\\theta$ over $2\\pi q$; select $\\theta_{\\max} = \\pi q$ and any $L_x$ since global quantization eliminates the need for twist-and-shift.\n\nSelect the option that is most consistent with first-principles geometry and gyrokinetic dynamics for KBM simulation, avoiding artificial stabilization due to boundary and domain choices while preserving the correct parallel and perpendicular structure.",
            "solution": "The problem statement has been validated and found to be scientifically grounded, well-posed, and objective. It accurately describes the setup of a local electromagnetic gyrokinetic simulation of Kinetic Ballooning Modes (KBMs) in a tokamak, a standard problem in computational plasma physics. All provided terms and concepts, such as the ballooning representation, twist-and-shift boundary conditions, and the form of the perpendicular wavenumber, are consistent with established literature. The problem is valid and a solution can be derived.\n\nThe problem asks for the most appropriate numerical strategy for simulating a KBM in a local flux-tube model. The goal is to choose boundary conditions and domain parameters that faithfully represent the physics while minimizing numerical artifacts.\n\nFirst, we analyze the structure of the KBM eigenmode in the ballooning representation. The mode's spatial structure is governed by the perpendicular wavenumber, which varies along the magnetic field line according to\n$$k_\\perp^2(\\theta) = k_y^2 + \\big(k_{x0} + s\\,k_y\\,\\theta\\big)^2$$\nHere, $\\theta$ is the field-aligned coordinate (related to the poloidal angle), $k_y$ is the fixed binormal wavenumber, $k_{x0}$ is the radial wavenumber at $\\theta=0$, and $s$ is the magnetic shear.\n\nThis expression shows that $k_\\perp(\\theta)$ is smallest near $\\theta \\approx -k_{x0}/(s k_y)$ and grows quadratically for large $|\\theta|$. Kinetic effects, such as Finite Larmor Radius (FLR) damping, become very strong when $k_\\perp \\rho_i \\gg 1$, where $\\rho_i$ is the ion Larmor radius. Consequently, the KBM eigenfunction is localized in the parallel direction to the region where $k_\\perp \\rho_i \\lesssim \\mathcal{O}(1)$ and is evanescent (decays to zero) in the regions where $k_\\perp \\rho_i \\gg 1$.\n\nThis physical behavior dictates the appropriate choice for the parallel domain and boundary conditions.\n1.  The parallel computational domain, $\\theta \\in [-\\theta_{\\max}, \\theta_{\\max}]$, must be large enough to contain the significant part of the eigenfunction. This means $\\theta_{\\max}$ must be chosen such that the mode amplitude has decayed to a negligible value at the boundaries. This requires $k_\\perp(\\pm \\theta_{\\max})\\,\\rho_i \\gg 1$.\n2.  The boundary condition must mimic an infinite domain, preventing spurious reflections of waves from the artificial boundary. For a mode that decays to zero, the most natural and effective boundary condition is a Dirichlet condition, $\\phi(\\pm\\theta_{\\max}) = 0$ and $A_\\parallel(\\pm\\theta_{\\max}) = 0$. This is often termed a \"radiation\" or \"absorbing\" boundary condition in this context.\n\nNext, we consider the perpendicular domain. The flux-tube model represents a small patch of the plasma extended along the field. Due to magnetic shear, a magnetic field line twists as it encircles the torus. In the ballooning formalism, this geometric property translates into a periodicity condition on the eigenfunction known as the \"twist-and-shift\" mapping. After one poloidal circuit, $\\theta \\to \\theta + 2\\pi$, a field perturbation must map onto itself, but at a different radial location. In the spectral domain of the radial coordinate $x$ (with wavenumbers $k_x$), this becomes a shift in $k_x$.\n\nThe effective radial wavenumber at a position $\\theta$ along the field line is $k_x^{\\text{eff}}(\\theta) \\approx k_{x0} + s k_y \\theta$. After a full poloidal turn, $\\Delta\\theta = 2\\pi$, the effective radial wavenumber changes by $\\Delta k_x^{\\text{shift}} = s k_y (2\\pi) = 2\\pi s k_y$. This implies that the value of the eigenfunction at $(k_x, \\theta+2\\pi)$ is related to its value at $(k_x - 2\\pi s k_y, \\theta)$. The exact relation is $\\hat{f}(k_x, \\theta+2\\pi) = \\hat{f}(k_x - 2\\pi s k_y, \\theta)$, where $\\hat{f}$ is the spectrally transformed field.\n\nIn a numerical simulation, the radial wavenumbers are discrete, given by $k_x = m\\,\\Delta k_x$ for integer $m$, where the grid spacing is $\\Delta k_x = 2\\pi/L_x$ for a radial box of size $L_x$. For the twist-and-shift mapping to be consistent with this discrete grid, the shifted wavenumber $k_x' = k_x - 2\\pi s k_y$ must also lie on the grid. This requires the shift amount, $2\\pi s k_y$, to be an integer multiple of the grid spacing $\\Delta k_x$:\n$$2\\pi s k_y = n_s \\Delta k_x = n_s \\left(\\frac{2\\pi}{L_x}\\right)$$\nwhere $n_s$ is an integer. This simplifies to the compatibility condition:\n$$s k_y L_x = n_s \\in \\mathbb{Z}$$\nThe radial box size $L_x$ must be chosen to satisfy this condition for the given physical parameters $s$ and $k_y$.\n\nNow we evaluate each option based on this physical and numerical analysis.\n\nA. Impose simple periodic boundary conditions in $\\theta$ with period $2\\theta_{\\max}$, independent of magnetic shear $s$, because $k_\\perp(\\theta)$ is periodic along a circular tokamak field line; choose $\\theta_{\\max}$ small (e.g., $\\theta_{\\max} = \\pi/2$) and any convenient $L_x$ to reduce computational cost.\n- **Incorrect**. This option is flawed in multiple ways. The KBM eigenfunction is not periodic in $\\theta$. The expression for $k_\\perp^2(\\theta)$ is parabolic in $\\theta$, not periodic. Simple periodicity is physically incorrect. Choosing a small $\\theta_{\\max}$ would artificially confine the mode, leading to incorrect results (typically, artificial stabilization). Ignoring the twist-and-shift property and the corresponding constraint on $L_x$ is also incorrect.\n\nB. Impose ballooning (radiation-like) boundary conditions by enforcing $\\phi(\\pm \\theta_{\\max}) = 0$ and $A_\\parallel(\\pm \\theta_{\\max}) = 0$, and choose $\\theta_{\\max}$ large enough that $k_\\perp(\\theta_{\\max})\\,\\rho_i \\gg 1$ (so the eigenfunction tails are negligibly small at the boundaries). For the spectral radial domain, enforce a twist-and-shift mapping $f(k_x,\\theta+2\\pi) = f\\!\\big(k_x - 2\\pi s k_y, \\theta\\big)$ and select $L_x$ so that $n_s \\equiv \\dfrac{s\\,k_y\\,L_x}{2\\pi} \\in \\mathbb{Z}$, ensuring the shear-induced $k_x$ shift lands exactly on the discrete $k_x$ grid.\n- **Correct**. This option correctly identifies all the key requirements for a reliable simulation. It specifies the correct type of boundary condition (radiation-like, i.e., Dirichlet zero), the need for a sufficiently large parallel domain, the correct form of the twist-and-shift mapping, and the necessity of a compatibility condition between the radial box size $L_x$ and the physical parameters. There is a likely typographical error in the compatibility condition provided. As derived above, the correct condition is $s k_y L_x \\in \\mathbb{Z}$, not $s k_y L_x / (2\\pi) \\in \\mathbb{Z}$. However, despite this minor error in the formula, the overall strategy described is the correct one and vastly superior to the other options. This option correctly specifies that $L_x$ must be chosen to satisfy such a compatibility condition, which is the crucial concept.\n\nC. Impose Neumann boundary conditions $\\dfrac{\\partial \\phi}{\\partial \\theta}\\big|_{\\pm \\theta_{\\max}} = 0$ and $\\dfrac{\\partial A_\\parallel}{\\partial \\theta}\\big|_{\\pm \\theta_{\\max}} = 0$ to preserve parallel symmetry while keeping $\\theta_{\\max}$ minimal; choose $L_x$ as small as possible to filter out low-$k_x$ content that would otherwise couple across poloidal transits.\n- **Incorrect**. Neumann boundary conditions are reflective and physically inappropriate for an evanescent mode, as they would trap energy and create artificial standing waves. A minimal $\\theta_{\\max}$ is incorrect for the same reason as in option A. Choosing a small $L_x$ makes the radial spectral grid very coarse ($\\Delta k_x$ is large), which degrades radial resolution and is generally a poor choice. It does not correctly address the coupling across poloidal transits, which requires the twist-and-shift condition.\n\nD. Replace the flux-tube field-aligned periodicity with global periodicity by requiring $n = m\\,q$ for toroidal and poloidal mode numbers and enforce periodicity in $\\theta$ over $2\\pi q$; select $\\theta_{\\max} = \\pi q$ and any $L_x$ since global quantization eliminates the need for twist-and-shift.\n- **Incorrect**. This option describes a global simulation model, not a local flux-tube one. The condition $n = mq$ applies to modes resonant on a particular rational surface, which is a feature of global modes, not the high-$n$ ballooning modes treated by the local model. The problem explicitly asks for the correct setup for a *local flux-tube computation*. Switching to a completely different simulation model does not answer the question.\n\nIn summary, option B provides the most accurate and reliable strategy for setting up a local flux-tube simulation of a KBM, correctly identifying the essential physics of the parallel mode structure and the numerical implementation of the twist-and-shift boundary condition.",
            "answer": "$$\\boxed{B}$$"
        },
        {
            "introduction": "With a well-posed problem setup, the final hurdle is the numerical engine used to solve the governing equations. Electromagnetic gyrokinetic simulations present formidable challenges, including the extreme speed of shear-Alfvén waves and a delicate numerical cancellation in Ampère's law. This exercise challenges you to identify the state-of-the-art algorithmic strategy that simultaneously ensures energy conservation, numerical stability, and physical accuracy when simulating KBMs.",
            "id": "4200513",
            "problem": "Consider a nonlinear electromagnetic gyrokinetic simulation of Kinetic Ballooning Modes (KBMs) in a toroidal magnetic geometry with safety factor profile $q(r)$, finite ion temperature gradients, and finite plasma beta $\\beta$. The code evolves the non-adiabatic perturbed guiding-center distribution $h_s(\\mathbf{R}, v_\\parallel, \\mu, t)$ for each species $s$, together with the electromagnetic fields represented by the scalar potential $\\phi(\\mathbf{r}, t)$ and the parallel component of the vector potential $A_\\parallel(\\mathbf{r}, t)$. The governing equations are derived from the Maxwell–Vlasov system under standard gyrokinetic ordering, where $k_\\perp \\rho_i \\sim \\mathcal{O}(1)$, $\\omega/\\Omega_i \\ll 1$, and $\\beta$ is finite, and the fields obey Faraday’s and Ampère’s laws coupled to the gyroaveraged moments of $h_s$.\n\nIn simulating KBMs, numerical schemes must satisfy three simultaneous requirements rooted in first principles: (i) enforce a consistent discrete representation of Maxwell’s equations and the gyrokinetic Vlasov equation that preserves a discrete free-energy invariant (the sum of particle and field energies) in the collisionless, source-free limit; (ii) avoid the electromagnetic “cancellation problem” in the parallel Ampère constraint, which arises from near-cancellation between the electron adiabatic current and the perturbed current associated with $h_e$ and $A_\\parallel$; and (iii) remove the severe Courant–Friedrichs–Lewy (CFL) time-step constraint associated with the Alfvén speed $v_A$ without introducing unphysical dissipation that distorts KBM physics.\n\nWhich numerical strategy best satisfies all three requirements for accurate and stable KBM simulations?\n\nA. Use a fully explicit Runge–Kutta time integrator for $h_s$, $\\phi$, and $A_\\parallel$ with centered finite-difference spatial discretization and no splitting of electron response. Rely on small time steps chosen from particle thermal speeds to control stability; accept approximate energy conservation.\n\nB. Use an implicit midpoint (Crank–Nicolson (CN)) time discretization for the coupled field–particle system applied consistently to $\\phi$ and $A_\\parallel$ and the field–particle coupling terms, together with a mixed-variable (split-weight or control-variate) electron formulation that analytically removes the adiabatic response from $h_e$ in the parallel Ampère constraint, and a discrete projection that enforces quasineutrality and Ampère’s law in a common variational framework. This combination eliminates the Alfvénic CFL restriction and yields exact discrete free-energy conservation in the linear, collisionless limit.\n\nC. Treat $\\phi$ implicitly but $A_\\parallel$ explicitly, using a conservative spatial discretization. Add hyper-resistivity to damp shear-Alfvén waves and permit larger time steps; accept monotonic energy decay to enhance robustness.\n\nD. Use electrostatic gyrokinetics by neglecting $A_\\parallel$ entirely while retaining kinetic electrons. Integrate with a symplectic scheme to conserve energy and eliminate electromagnetic stiffness and the cancellation problem.\n\nE. Replace physical electrons with a reduced-mass model to slow $v_A$ and permit explicit time stepping without splitting. Maintain the original field solver and accept modified KBM dynamics as a trade-off for numerical stability.\n\nSelect the best option.",
            "solution": "We begin from the Maxwell–Vlasov system and the gyrokinetic reduction under standard ordering appropriate for Kinetic Ballooning Modes (KBMs). In electromagnetic gyrokinetics, the species dynamics is governed by the gyrokinetic Vlasov equation for the non-adiabatic distribution $h_s(\\mathbf{R}, v_\\parallel, \\mu, t)$, coupled to the electromagnetic fields via quasineutrality and the parallel component of Ampère’s law. The field equations are derived from Maxwell’s equations, notably Faraday’s law and Ampère’s law, with the parallel current obtained from velocity moments of $h_s$ and gyroaveraging. Under the ordering $k_\\perp \\rho_i \\sim \\mathcal{O}(1)$ and $\\omega/\\Omega_i \\ll 1$ with finite $\\beta$, the parallel vector potential $A_\\parallel$ captures shear-Alfvén dynamics crucial for KBMs.\n\nA discrete scheme must satisfy three principles:\n\n- Discrete energy conservation: The continuous system possesses a free-energy invariant, comprised of particle free energy and magnetic/electric field energies. In the collisionless, source-free limit, this quantity is conserved. A discrete analog requires consistent time centering of field–particle coupling and spatial discretizations that are compatible (e.g., derived from a common variational or Hamiltonian structure). An implicit midpoint method such as Crank–Nicolson (CN) applied consistently to all coupled terms yields exact discrete conservation for linear, collisionless systems.\n\n- Elimination of the electromagnetic cancellation problem: In the parallel Ampère equation, the electron adiabatic response contributes a current that nearly cancels the non-adiabatic response and the $A_\\parallel$ (inductive) contribution. Without special treatment, finite-precision and discretization errors can overwhelm the small residual, leading to unphysical growth or damping. A mixed-variable (split-weight or control-variate) electron formulation removes the large adiabatic part analytically from $h_e$, leaving only the small non-adiabatic component to be represented numerically, thereby curing the cancellation.\n\n- Removal of the Courant–Friedrichs–Lewy (CFL) restriction associated with the Alfvén speed $v_A$: Explicit time stepping is severely constrained by $v_A$, since shear-Alfvén waves propagate rapidly. Implicit treatment of $A_\\parallel$ (and consistent coupling to particles) removes this stiffness without adding artificial dissipation that would distort KBM eigenstructure and thresholds.\n\nWe now analyze each option:\n\nA. Fully explicit Runge–Kutta with centered differences and no splitting. Explicit schemes for $A_\\parallel$ suffer from a CFL restriction set by $v_A$, i.e., the time step must satisfy a bound of the form $\\Delta t \\lesssim C \\Delta x / v_A$, where $C$ is an order-unity constant. This is prohibitive for realistic parameters. Moreover, without mixed-variable electron treatment, the cancellation problem in the parallel Ampère law persists, leading to large numerical errors. Approximate energy conservation under explicit Runge–Kutta is insufficient for long-time KBM simulations where small growth rates and thresholds are critical. Verdict: Incorrect.\n\nB. Implicit midpoint (Crank–Nicolson (CN)) for the fully coupled system, with mixed-variable electrons and a consistent discrete projection enforcing quasineutrality and Ampère’s law in a unified variational framework. CN time centering of both fields and particle coupling ensures exact discrete conservation of the linear, collisionless free energy. Implicit treatment of $A_\\parallel$ removes the Alfvénic CFL constraint. The mixed-variable (split-weight or control-variate) electron formulation analytically subtracts the adiabatic current from $h_e$, thereby eliminating the cancellation problem. The variationally consistent projection aligns the particle moments with the field discretization, maintaining Maxwell constraints and avoiding spurious energy transfer. This combination satisfies all three requirements without introducing unphysical dissipation. Verdict: Correct.\n\nC. Implicit $\\phi$ but explicit $A_\\parallel$, with hyper-resistivity to damp shear-Alfvén waves. Leaving $A_\\parallel$ explicit retains the Alfvénic CFL restriction; adding hyper-resistivity introduces artificial dissipation that modifies shear-Alfvén dynamics and KBM growth rates and thresholds. While energy may decrease monotonically, this is due to artificial damping rather than true conservation, and the scheme still does not address the cancellation problem. Verdict: Incorrect.\n\nD. Electrostatic gyrokinetics (neglect $A_\\parallel$) with kinetic electrons. KBMs are intrinsically electromagnetic and require $A_\\parallel$ to represent shear-Alfvén coupling and magnetic curvature drive. Neglecting $A_\\parallel$ alters the physics and cannot reproduce KBM behavior. Although this eliminates electromagnetic stiffness and the cancellation problem trivially, it fails requirement (i) of preserving the correct invariant for the physical system and requirement (iii) without compromising physics. Verdict: Incorrect.\n\nE. Reduced-mass electron model to slow $v_A$ with explicit time stepping and no splitting. Artificially increasing the electron mass reduces $v_A$, but this modifies the eigenmode structure, threshold, and nonlinear saturation of KBMs. It does not solve the cancellation problem and breaks physical fidelity. Energy properties are not guaranteed, and explicit time stepping remains limited by other fast scales. Verdict: Incorrect.\n\nTherefore, only option B satisfies all three requirements in a physically faithful and numerically robust manner for KBM simulations.",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}