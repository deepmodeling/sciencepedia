{
    "hands_on_practices": [
        {
            "introduction": "Before embarking on complex simulations, it is essential to verify that the chosen theoretical framework is appropriate for the physical system under study. This exercise provides a crucial first step by having you assess the validity of the gyrokinetic approximation in a tangible astrophysical environment—the intracluster medium (ICM). By calculating the ion gyrofrequency, thermal Larmor radius, and the key dimensionless parameter $k_{\\perp}\\rho_i$ from first principles, you will gain a concrete understanding of the theory's domain of applicability and the importance of scale separation. ",
            "id": "4216719",
            "problem": "Consider the Intracluster Medium (ICM) in a galaxy cluster modeled as a weakly collisional, magnetized hydrogen plasma. Assume a uniform magnetic field magnitude $B = 1 \\times 10^{-6}\\,\\mathrm{G}$ and number density $n = 1 \\times 10^{-3}\\,\\mathrm{cm}^{-3}$. Let the ions be protons with isotropic temperature $T_i = 5\\,\\mathrm{keV}$. Work in Gaussian centimeter–gram–second (cgs) units. Using first principles starting from the Lorentz force and the Maxwell–Boltzmann distribution, derive the ion gyrofrequency $\\Omega_i$ and the ion thermal Larmor radius $\\rho_i$, and evaluate the finite Larmor radius parameter $k_{\\perp}\\rho_i$ for a characteristic perpendicular wavenumber $k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$. Then, assess the validity of Gyrokinetic (GK) theory under the ordering based solely on the finite Larmor radius parameter, by adopting the criterion $k_{\\perp}\\rho_i \\leq 1$ as the threshold for validity.\n\nYou may use the following constants:\n- Elementary charge (Gaussian cgs): $e = 4.803204712 \\times 10^{-10}\\,\\mathrm{statC}$.\n- Proton mass: $m_p = 1.672621923 \\times 10^{-24}\\,\\mathrm{g}$.\n- Speed of light: $c = 2.99792458 \\times 10^{10}\\,\\mathrm{cm/s}$.\n- Boltzmann constant: $k_B = 1.380649 \\times 10^{-16}\\,\\mathrm{erg/K}$.\n- Electronvolt conversion: $1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-12}\\,\\mathrm{erg}$.\n\nInstructions:\n- Derive $\\Omega_i$ from the Lorentz force and $\\rho_i$ from the thermal speed of a Maxwellian ion distribution.\n- Compute the ordered quadruple $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$, where $V = 1$ if $k_{\\perp}\\rho_i \\leq 1$ and $V = 0$ otherwise.\n- Express $\\Omega_i$ in $\\mathrm{s}^{-1}$, $\\rho_i$ in $\\mathrm{cm}$, and $k_{\\perp}\\rho_i$ and $V$ as dimensionless quantities.\n- Round each entry of the quadruple to three significant figures.\n- Provide your final numerical answer as a single row matrix in the order $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$.",
            "solution": "The user wants me to solve a problem in plasma physics, specifically concerning the Intracluster Medium (ICM).\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Magnetic field magnitude: $B = 1 \\times 10^{-6}\\,\\mathrm{G}$\n-   Number density: $n = 1 \\times 10^{-3}\\,\\mathrm{cm}^{-3}$\n-   Ion (proton) isotropic temperature: $T_i = 5\\,\\mathrm{keV}$\n-   Characteristic perpendicular wavenumber: $k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$\n-   System of units: Gaussian centimeter–gram–second (cgs)\n-   Elementary charge: $e = 4.803204712 \\times 10^{-10}\\,\\mathrm{statC}$\n-   Proton mass: $m_p = 1.672621923 \\times 10^{-24}\\,\\mathrm{g}$\n-   Speed of light: $c = 2.99792458 \\times 10^{10}\\,\\mathrm{cm/s}$\n-   Boltzmann constant: $k_B = 1.380649 \\times 10^{-16}\\,\\mathrm{erg/K}$\n-   Electronvolt conversion: $1\\,\\mathrm{eV} = 1.602176634 \\times 10^{-12}\\,\\mathrm{erg}$\n-   Gyrokinetic (GK) validity criterion: $k_{\\perp}\\rho_i \\leq 1$\n-   Output definition: An ordered quadruple $(\\Omega_i, \\rho_i, k_{\\perp}\\rho_i, V)$, where $V=1$ if $k_{\\perp}\\rho_i \\leq 1$ and $V=0$ otherwise.\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded:** The problem is based on fundamental principles of plasma physics, including the Lorentz force and Maxwell-Boltzmann statistics. The application concerns the intracluster medium (ICM), and the given physical parameters ($B$, $n$, $T_i$) are representative of such environments. The concept of gyrokinetics and its domain of validity based on the finite Larmor radius parameter is a standard topic in plasma theory.\n-   **Well-Posed:** The problem provides all necessary data and constants to calculate the requested quantities. The tasks are specified clearly, leading to a unique numerical result. The number density $n$ is provided but not required for the calculation; this does not constitute a contradiction, but is simply extraneous information.\n-   **Objective:** The problem is stated in precise, technical language, free from any subjective or ambiguous terminology.\n\n**Step 3: Verdict and Action**\nThe problem is valid. It is scientifically sound, well-posed, and objective. I will now proceed to the solution.\n\n### Solution Derivation\n\nThe problem requires the calculation of the ion gyrofrequency $\\Omega_i$, the ion thermal Larmor radius $\\rho_i$, the finite Larmor radius parameter $k_{\\perp}\\rho_i$, and a validity flag $V$.\n\n**1. Ion Gyrofrequency ($\\Omega_i$)**\n\nThe motion of a charged particle in a magnetic field is governed by the Lorentz force. In Gaussian cgs units, for an ion (proton) with charge $e$ and mass $m_p$, this force is:\n$$\n\\vec{F} = \\frac{e}{c} (\\vec{v} \\times \\vec{B})\n$$\nFor motion perpendicular to a uniform magnetic field $\\vec{B}$, this force provides the centripetal force required for circular motion:\n$$\nF = m_p a_c = \\frac{m_p v_{\\perp}^2}{r}\n$$\nwhere $v_{\\perp}$ is the component of the ion's velocity perpendicular to $\\vec{B}$ and $r$ is the radius of the circular path. The magnitude of the Lorentz force is $F = \\frac{e v_{\\perp} B}{c}$. Equating the two forces gives:\n$$\n\\frac{m_p v_{\\perp}^2}{r} = \\frac{e v_{\\perp} B}{c}\n$$\nThe angular frequency of this gyromotion, known as the gyrofrequency $\\Omega_i$, is defined as $\\Omega_i = v_{\\perp} / r$. Rearranging the force balance equation to solve for $\\Omega_i$:\n$$\n\\Omega_i = \\frac{v_{\\perp}}{r} = \\frac{e B}{m_p c}\n$$\nSubstituting the given values:\n$e = 4.8032 \\times 10^{-10}\\,\\mathrm{statC}$\n$B = 1 \\times 10^{-6}\\,\\mathrm{G}$\n$m_p = 1.6726 \\times 10^{-24}\\,\\mathrm{g}$\n$c = 2.9979 \\times 10^{10}\\,\\mathrm{cm/s}$\n$$\n\\Omega_i = \\frac{(4.8032 \\times 10^{-10}) (1 \\times 10^{-6})}{(1.6726 \\times 10^{-24}) (2.9979 \\times 10^{10})} = \\frac{4.8032 \\times 10^{-16}}{5.0143 \\times 10^{-14}} \\approx 0.009579\\,\\mathrm{s}^{-1}\n$$\n\n**2. Ion Thermal Larmor Radius ($\\rho_i$)**\n\nThe Larmor radius for a single particle depends on its perpendicular velocity $v_{\\perp}$, as $\\rho = v_{\\perp} / \\Omega_i$. For a population of particles at a given temperature, we define a *thermal* Larmor radius using a characteristic thermal speed. We derive this speed from the Maxwell-Boltzmann distribution.\n\nFor an isotropic temperature $T_i$, the average kinetic energy associated with each degree of freedom is $\\frac{1}{2} k_B T_i$. The motion perpendicular to the magnetic field has two degrees of freedom. Therefore, the average perpendicular kinetic energy is:\n$$\n\\langle \\frac{1}{2} m_p v_{\\perp}^2 \\rangle = 2 \\times \\frac{1}{2} k_B T_i = k_B T_i\n$$\nThe root-mean-square perpendicular speed, $v_{th, \\perp} = \\sqrt{\\langle v_{\\perp}^2 \\rangle}$, is then:\n$$\nv_{th, \\perp} = \\sqrt{\\frac{2 k_B T_i}{m_p}}\n$$\nThe problem gives the ion temperature in energy units, $T_i = 5\\,\\mathrm{keV}$. We must convert this to ergs, the cgs unit of energy, which is equivalent to using the product $k_B T_i$:\n$$\nT_{i, \\mathrm{erg}} = (5 \\times 10^3\\,\\mathrm{eV}) \\times (1.602176634 \\times 10^{-12}\\,\\mathrm{erg/eV}) = 8.01088 \\times 10^{-9}\\,\\mathrm{erg}\n$$\nNow we compute the thermal speed:\n$$\nv_{th, \\perp} = \\sqrt{\\frac{2 \\times (8.01088 \\times 10^{-9}\\,\\mathrm{erg})}{1.67262 \\times 10^{-24}\\,\\mathrm{g}}} \\approx \\sqrt{9.5788 \\times 10^{15}\\,\\mathrm{cm}^2/\\mathrm{s}^2} \\approx 9.7871 \\times 10^7\\,\\mathrm{cm/s}\n$$\nThe thermal Larmor radius $\\rho_i$ is then:\n$$\n\\rho_i = \\frac{v_{th, \\perp}}{\\Omega_i} = \\frac{9.7871 \\times 10^7\\,\\mathrm{cm/s}}{0.009579\\,\\mathrm{s}^{-1}} \\approx 1.0217 \\times 10^{10}\\,\\mathrm{cm}\n$$\n\n**3. Finite Larmor Radius Parameter ($k_{\\perp}\\rho_i$)**\n\nThis parameter compares the spatial scale of the fluctuations, characterized by $1/k_{\\perp}$, to the ion gyroradius $\\rho_i$.\nGiven $k_{\\perp} = 1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}$:\n$$\nk_{\\perp}\\rho_i = (1 \\times 10^{-6}\\,\\mathrm{cm}^{-1}) \\times (1.0217 \\times 10^{10}\\,\\mathrm{cm}) \\approx 1.0217 \\times 10^4\n$$\nThis is a dimensionless quantity.\n\n**4. Gyrokinetic Validity Assessment ($V$)**\n\nThe problem provides the criterion for the validity of the gyrokinetic approximation as $k_{\\perp}\\rho_i \\leq 1$. Our calculated value is:\n$$\nk_{\\perp}\\rho_i \\approx 1.02 \\times 10^4\n$$\nSince $1.02 \\times 10^4$ is much greater than $1$, the condition is not satisfied. Therefore, under this criterion and for the given parameters, the gyrokinetic model is not valid. The problem defines a flag $V$ such that $V=1$ if the condition is met and $V=0$ otherwise. Thus:\n$$\nV = 0\n$$\n\n### Summary of Results\nThe calculated values, rounded to three significant figures, are:\n-   $\\Omega_i \\approx 9.58 \\times 10^{-3}\\,\\mathrm{s}^{-1}$\n-   $\\rho_i \\approx 1.02 \\times 10^{10}\\,\\mathrm{cm}$\n-   $k_{\\perp}\\rho_i \\approx 1.02 \\times 10^4$\n-   $V = 0$\n\nThe final answer is the ordered quadruple of these values.",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n9.58 \\times 10^{-3}  1.02 \\times 10^{10}  1.02 \\times 10^{4}  0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "A core challenge in computational physics is ensuring the numerical stability of a simulation. For explicit time-integration schemes, the Courant-Friedrichs-Lewy (CFL) condition sets a strict upper limit on the time step, $\\Delta t$, to prevent numerical solutions from becoming unphysically divergent. This practice demystifies the CFL condition by having you derive time-step constraints from two distinct physical processes in a gyrokinetic plasma: the rapid parallel streaming of electrons along magnetic field lines and the perpendicular advection from the $\\mathbf{E} \\times \\mathbf{B}$ drift. ",
            "id": "4216743",
            "problem": "Consider an explicit time integration of the electrostatic gyrokinetic equation for a hot, magnetized astrophysical plasma representative of an accretion disk corona. Focus on the advection processes that constrain the time step: parallel streaming along the magnetic field and perpendicular advection by the electric field cross magnetic field drift. Let the computational grid be uniform with spacing $\\Delta z$ along the magnetic field and spacing $\\Delta x$ in one perpendicular direction. The maximum stable time step must satisfy a Courant–Friedrichs–Lewy (CFL) condition based on the requirement that advected information does not traverse more than a fraction of a grid cell in one time step.\n\nUse the following physically consistent data:\n- Magnetic field magnitude $B = 0.01\\,\\mathrm{T}$.\n- Electron temperature $T_e = 1.0\\times 10^7\\,\\mathrm{K}$.\n- Electrostatic potential amplitude $\\phi = 150\\,\\mathrm{V}$.\n- Dominant perpendicular fluctuation wavenumber $k_\\perp = 20\\,\\mathrm{m^{-1}}$.\n- Parallel grid spacing $\\Delta z = 20\\,\\mathrm{m}$.\n- Perpendicular grid spacing $\\Delta x = 0.05\\,\\mathrm{m}$.\n- Courant safety factor $C_{\\mathrm{CFL}} = 0.5$.\n\nStart from the advection of a scalar $f$ satisfying $f_t + v\\,f_x = 0$ in one dimension and its generalization to the gyrokinetic parallel streaming term $v_\\parallel\\,\\partial f/\\partial z$ and the perpendicular electric field cross magnetic field drift advection $\\mathbf{v}_E\\cdot\\nabla_\\perp f$. Derive the CFL constraint on the explicit time step $\\Delta t$ for both processes using first principles. Estimate the electron parallel streaming speed using the thermal speed $v_{\\mathrm{th},e}$ of a Maxwellian electron population and estimate the perpendicular drift speed $v_E$ from the electric field amplitude implied by the potential fluctuation. In the International System of Units (SI), use $v_E = |\\mathbf{E}|/B$ for the magnitude of the electric field cross magnetic field drift. For the electric field amplitude, use $|\\mathbf{E}| \\simeq |\\nabla_\\perp \\phi| \\simeq k_\\perp \\phi$. Neglect relativistic corrections.\n\nCompute the maximum allowable explicit time step $\\Delta t_{\\max}$ (in seconds) that simultaneously satisfies the CFL constraints from both parallel streaming and electric field cross magnetic field drift advection. Round your answer to three significant figures and express it in seconds.",
            "solution": "The problem is valid. It is scientifically grounded in the principles of computational plasma physics, specifically concerning the stability of numerical schemes for solving the gyrokinetic equation. The provided data are physically consistent and the problem is well-posed, leading to a unique solution.\n\nThe Courant–Friedrichs–Lewy (CFL) condition is a necessary condition for the stability of explicit time-integration schemes for solving partial differential equations involving advection. For a one-dimensional advection equation of the form $\\frac{\\partial f}{\\partial t} + v \\frac{\\partial f}{\\partial x} = 0$, where $v$ is the advection speed, the CFL condition for a simple explicit finite-difference scheme states that the numerical domain of dependence must contain the physical domain of dependence. This translates to the constraint that information must not propagate more than one grid cell in a single time step. For a scheme with a Courant safety factor $C_{\\mathrm{CFL}}$, this is expressed as:\n$$|v| \\frac{\\Delta t}{\\Delta x} \\le C_{\\mathrm{CFL}}$$\nThis gives the maximum stable time step $\\Delta t$ for a given speed $|v|$ and grid spacing $\\Delta x$:\n$$\\Delta t \\le C_{\\mathrm{CFL}} \\frac{\\Delta x}{|v|}$$\n\nThe problem requires us to consider two advection processes that constrain the time step $\\Delta t$: parallel streaming and perpendicular $\\mathbf{E} \\times \\mathbf{B}$ drift. The overall maximum allowable time step $\\Delta t_{\\max}$ must satisfy the CFL condition for both processes simultaneously.\n\nThe physical constants required for this calculation are the Boltzmann constant, $k_B \\approx 1.380649 \\times 10^{-23}\\,\\mathrm{J/K}$, and the electron mass, $m_e \\approx 9.109384 \\times 10^{-31}\\,\\mathrm{kg}$.\n\nFirst, we analyze the constraint from parallel streaming. The advection term in the gyrokinetic equation is $v_\\parallel \\frac{\\partial f}{\\partial z}$. The characteristic speed is the parallel particle velocity $v_\\parallel$, and the relevant grid spacing is the parallel one, $\\Delta z$. The most restrictive constraint comes from the fastest particles. The problem instructs us to use the electron thermal speed, $v_{\\mathrm{th},e}$, as the characteristic maximum speed. The thermal speed for a Maxwellian distribution is given by:\n$$v_{\\mathrm{th},e} = \\sqrt{\\frac{k_B T_e}{m_e}}$$\nUsing the given electron temperature $T_e = 1.0 \\times 10^7\\,\\mathrm{K}$:\n$$v_{\\mathrm{th},e} = \\sqrt{\\frac{(1.380649 \\times 10^{-23}\\,\\mathrm{J/K}) \\times (1.0 \\times 10^7\\,\\mathrm{K})}{9.109384 \\times 10^{-31}\\,\\mathrm{kg}}} \\approx 1.231 \\times 10^7\\,\\mathrm{m/s}$$\nThe CFL constraint for parallel streaming, $\\Delta t_\\parallel$, is therefore:\n$$\\Delta t_\\parallel \\le C_{\\mathrm{CFL}} \\frac{\\Delta z}{v_{\\mathrm{th},e}}$$\nUsing the given values $C_{\\mathrm{CFL}} = 0.5$ and $\\Delta z = 20\\,\\mathrm{m}$:\n$$\\Delta t_\\parallel \\le 0.5 \\times \\frac{20\\,\\mathrm{m}}{1.231 \\times 10^7\\,\\mathrm{m/s}} \\approx 8.123 \\times 10^{-7}\\,\\mathrm{s}$$\n\nSecond, we analyze the constraint from the perpendicular $\\mathbf{E} \\times \\mathbf{B}$ drift. The advection term is $\\mathbf{v}_E \\cdot \\nabla_\\perp f$. The characteristic speed is the magnitude of the drift velocity, $v_E = |\\mathbf{v}_E|$, and the relevant grid spacing is the perpendicular one, $\\Delta x$. The problem provides the formula for the drift speed:\n$$v_E = \\frac{|\\mathbf{E}|}{B}$$\nAnd an approximation for the electric field magnitude based on the electrostatic potential fluctuation $\\phi$ and the dominant perpendicular wavenumber $k_\\perp$:\n$$|\\mathbf{E}| \\simeq |\\nabla_\\perp \\phi| \\simeq k_\\perp \\phi$$\nCombining these gives the expression for the drift speed:\n$$v_E \\simeq \\frac{k_\\perp \\phi}{B}$$\nUsing the given values $B = 0.01\\,\\mathrm{T}$, $\\phi = 150\\,\\mathrm{V}$, and $k_\\perp = 20\\,\\mathrm{m^{-1}}$:\n$$v_E \\simeq \\frac{(20\\,\\mathrm{m^{-1}}) \\times (150\\,\\mathrm{V})}{0.01\\,\\mathrm{T}} = \\frac{3000}{0.01}\\,\\mathrm{m/s} = 3.0 \\times 10^5\\,\\mathrm{m/s}$$\nThe CFL constraint for perpendicular advection, $\\Delta t_\\perp$, is:\n$$\\Delta t_\\perp \\le C_{\\mathrm{CFL}} \\frac{\\Delta x}{v_E}$$\nUsing the given values $C_{\\mathrm{CFL}} = 0.5$ and $\\Delta x = 0.05\\,\\mathrm{m}$:\n$$\\Delta t_\\perp \\le 0.5 \\times \\frac{0.05\\,\\mathrm{m}}{3.0 \\times 10^5\\,\\mathrm{m/s}} = \\frac{0.025}{3.0 \\times 10^5}\\,\\mathrm{s} \\approx 8.333 \\times 10^{-8}\\,\\mathrm{s}$$\n\nFinally, for the explicit time integration to be stable, the time step $\\Delta t$ must satisfy both constraints simultaneously. Thus, the maximum allowable time step $\\Delta t_{\\max}$ is the minimum of the individual limits:\n$$\\Delta t_{\\max} = \\min(\\Delta t_\\parallel, \\Delta t_\\perp)$$\nComparing the calculated values:\n$$\\Delta t_{\\max} = \\min(8.123 \\times 10^{-7}\\,\\mathrm{s}, 8.333 \\times 10^{-8}\\,\\mathrm{s}) = 8.333 \\times 10^{-8}\\,\\mathrm{s}$$\nIn this case, the perpendicular $\\mathbf{E} \\times \\mathbf{B}$ advection imposes the more stringent constraint on the time step.\n\nRounding the result to three significant figures gives $8.33 \\times 10^{-8}\\,\\mathrm{s}$.",
            "answer": "$$\\boxed{8.33 \\times 10^{-8}}$$"
        },
        {
            "introduction": "Translating abstract equations into a working numerical model is a fundamental skill in computational science. This exercise guides you through the implementation and validation of the two most essential operators in a linear gyrokinetic simulation: parallel streaming and gyroaveraging. By discretizing the advection term using a conservative finite-volume scheme and implementing the gyroaverage operator via its spectral representation, you will directly engage with the core mechanics of gyrokinetic codes and learn how to verify their correctness against analytical theory and fundamental conservation laws. ",
            "id": "4216799",
            "problem": "Consider a linear, electrostatic Gyrokinetic (GK) model for a single ion species in a uniform magnetic field aligned with the coordinate $s$. Use field-aligned coordinates with perpendicular spectral representation and finite-volume discretization along $s$. The unknown is the non-adiabatic part of the distribution function $g(s,v_\\parallel,\\mu,t)$, where $s$ is the arc length along the magnetic field line, $v_\\parallel$ is the parallel velocity, and $\\mu$ is the magnetic moment. Assume a uniform magnetic field magnitude $B$, species mass $m$, and charge $q$. The electrostatic potential $\\phi$ has a single perpendicular Fourier mode with wavenumber $k_\\perp$ and is periodic along $s$. Explicitly impose periodic boundary conditions along $s$.\n\nStart from well-tested foundational laws: the Vlasov equation and the guiding-center reduction, which yields the GK equation under scale separation and averaging. In the linear, electrostatic, collisionless, homogeneous limit with no magnetic drifts and constant $B$, the GK equation simplifies to parallel streaming of $g$ with a source term proportional to the gyroaveraged electrostatic potential. In this reduced setting, discretize the parallel streaming term with a conservative finite-volume update and represent the perpendicular dynamics spectrally as multiplication by a gyroaveraging factor. The gyroaveraging operator is implemented via the zeroth-order Bessel function of the first kind evaluated at the argument $k_\\perp \\rho$, where the Larmor radius $\\rho$ is related to the magnetic moment via the guiding-center definitions. Use a time-explicit update with an upwind numerical flux for the parallel streaming term.\n\nYour tasks are:\n\n- Derivation target: Starting from the field-aligned, linear, electrostatic, collisionless GK model with uniform $B$, identify the structure of the parallel streaming term and the source term coupling to the gyroaveraged potential. Express the gyroaverage as multiplication by a function of $k_\\perp$ and $\\rho$, and relate $\\rho$ to $\\mu$, $B$, $m$, and $q$ through the guiding-center definition.\n\n- Discretization target along $s$: Let $s \\in [0,L_s]$ be divided into $N_s$ uniform finite volumes of width $\\Delta s = L_s/N_s$, indexed by $i = 0,\\dots,N_s-1$. For fixed $v_\\parallel$, the parallel streaming term is the advection of $g$ with speed $v_\\parallel$. Implement a conservative upwind flux with periodic boundary conditions, so that the update of cell averages $g_i^n$ over one time step $\\Delta t$ is\n$$\ng_i^{n+1} = g_i^n - \\frac{\\Delta t}{\\Delta s}\\left(F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n\\right),\n$$\nwith numerical fluxes $F_{i+\\frac{1}{2}}^n$ chosen by upwind based on the sign of $v_\\parallel$, and $F_{-\\frac{1}{2}}^n \\equiv F_{N_s-\\frac{1}{2}}^n$ and $F_{N_s+\\frac{1}{2}}^n \\equiv F_{\\frac{1}{2}}^n$ (periodic wrap). Ensure the Courant number $C \\equiv |v_\\parallel|\\Delta t/\\Delta s \\le 1$.\n\n- Gyroaverage target: For a given $k_\\perp$, implement the gyroaverage factor as a function of $\\rho$, with $\\rho$ computed from $\\mu$ by the guiding-center relationships. Numerically verify the gyroaverage by comparing the analytic factor to a direct numerical average over the gyroangle.\n\n- Validation metrics: \n  1. A dimensionless relative error between the analytic gyroaverage factor and a direct numerical gyroangle integration over $\\theta \\in [0,2\\pi]$,\n  $$\n  \\varepsilon \\equiv \\sqrt{\\frac{\\sum_j \\left( A_j - N_j \\right)^2}{\\sum_j A_j^2}},\n  $$\n  where $A_j$ is the analytic gyroaverage factor evaluated at the $j$-th $\\rho$ grid point and $N_j$ is the corresponding numerical gyroangle average.\n  2. A dimensionless absolute difference between the total mass (the integral of $g$ over $s$) before and after one finite-volume streaming update with periodic boundaries and zero source term.\n\nImplement the following in a single, runnable program:\n\n- Use the relation between magnetic moment and perpendicular speed derived from guiding-center definitions. The magnetic moment $\\mu$ and perpendicular speed $v_\\perp$ satisfy $v_\\perp^2 = \\frac{2 \\mu B}{m}$, and the Larmor radius is $\\rho = \\frac{v_\\perp}{\\Omega}$ with cyclotron frequency $\\Omega = \\frac{q B}{m}$. Use these to compute $\\rho$ from $\\mu$, $B$, $m$, and $q$.\n- Compute the analytic gyroaverage factor as the zeroth-order Bessel function evaluated at $k_\\perp \\rho$.\n- Compute the numerical gyroangle average by discretizing $\\theta \\in [0,2\\pi]$ uniformly and evaluating the average of $\\cos(k_\\perp \\rho \\cos\\theta)$, which corresponds to the real part of the gyroangle average of the perpendicular-phase factor.\n- Compute the relative error $\\varepsilon$ across a set of $\\rho$ values generated from a uniform grid in $v_\\perp$, converted to $\\mu$, and then to $\\rho$.\n- Discretize the parallel streaming update for one time step using a conservative upwind flux with periodic boundary conditions and compute the absolute mass difference.\n\nUnits and numerical specification:\n\n- Use $B$ in Teslas (T), $m$ in kilograms (kg), $q$ in Coulombs (C), $k_\\perp$ in inverse meters ($\\mathrm{m}^{-1}$), $s$ in meters (m), $v_\\parallel$ in meters per second ($\\mathrm{m/s}$), time in seconds (s), and magnetic moment $\\mu$ in Joules per Tesla ($\\mathrm{J/T}$). The output metrics are dimensionless floats.\n\nTest suite and parameters:\n\n- Test $1$ (gyroaverage accuracy, happy path): $B = 5\\times 10^{-5}\\ \\mathrm{T}$, $m = 1.6726219\\times 10^{-27}\\ \\mathrm{kg}$, $q = 1.602176634\\times 10^{-19}\\ \\mathrm{C}$, $k_\\perp = 50\\ \\mathrm{m}^{-1}$, a uniform grid of $N_\\mu = 256$ values generated by $v_\\perp \\in [0, 2\\times 10^{4}]\\ \\mathrm{m/s}$ mapped to $\\mu$ and then to $\\rho$, and a gyroangle grid with $N_\\theta = 4096$ points over $[0,2\\pi]$.\n- Test $2$ (gyroaverage accuracy, boundary case $k_\\perp = 0$): same $B$, $m$, $q$, $N_\\mu$, $N_\\theta$, and $v_\\perp$ range as Test $1$, but $k_\\perp = 0\\ \\mathrm{m}^{-1}$.\n- Test $3$ (gyroaverage accuracy, large-$k_\\perp$ edge case): same $B$, $m$, $q$, $N_\\mu$, $N_\\theta$, and $v_\\perp$ range as Test $1$, but $k_\\perp = 500\\ \\mathrm{m}^{-1}$.\n- Test $4$ (finite-volume streaming mass conservation): $L_s = 1\\ \\mathrm{m}$, $N_s = 64$, $v_\\parallel = 1000\\ \\mathrm{m/s}$, $\\Delta t = \\Delta s/|v_\\parallel|$, initial cell averages $g_i^0 = 1 + 0.1 \\sin\\left(2\\pi s_i/L_s\\right)$ evaluated at cell centers $s_i = (i+1/2)\\Delta s$, and perform a single time step with periodic boundary conditions and zero source term.\n\nFinal output format:\n\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result1,result2,result3,result4]$), where $result1$, $result2$, and $result3$ are the relative errors $\\varepsilon$ for Tests $1$, $2$, and $3$, respectively, and $result4$ is the absolute mass difference for Test $4$. All outputs must be decimal floats.",
            "solution": "The problem asks for the implementation and validation of two core components of a gyrokinetic (GK) simulation code: the gyroaveraging operator and the parallel streaming operator. The validation is based on fundamental principles and numerical analysis.\n\nFirst, we establish the theoretical framework. The linear, electrostatic, collisionless GK equation for a single ion species in a uniform magnetic field $\\mathbf{B} = B \\mathbf{\\hat{s}}$, with no equilibrium drifts, is given by:\n$$\n\\frac{\\partial g}{\\partial t} + v_\\parallel \\frac{\\partial g}{\\partial s} = S(g, \\phi)\n$$\nHere, $g(s, v_\\parallel, \\mu, t)$ is the non-adiabatic part of the ion distribution function, $s$ is the coordinate along the magnetic field, $v_\\parallel$ is the parallel velocity, and $\\mu$ is the magnetic moment. The term $v_\\parallel \\frac{\\partial g}{\\partial s}$ represents the advection of guiding-centers along the magnetic field line, known as parallel streaming. The term $S$ represents the source due to the interaction with the self-consistent electrostatic potential $\\phi$. For a single perpendicular Fourier mode with wavenumber $k_\\perp$, the source term is proportional to the gyroaveraged potential.\n\nThe gyroaverage of a field $\\psi(\\mathbf{x})$ is its average over a gyroring centered at the guiding-center position $\\mathbf{R}$:\n$$\n\\langle \\psi \\rangle(\\mathbf{R}) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\psi(\\mathbf{R} + \\boldsymbol{\\rho}(\\alpha)) d\\alpha\n$$\nwhere $\\boldsymbol{\\rho}$ is the Larmor radius vector of magnitude $\\rho$ and gyroangle $\\alpha$. For a plane wave component of the potential, $\\phi_\\mathbf{k}(\\mathbf{x}) = \\hat{\\phi}_{\\mathbf{k}_\\perp} e^{i \\mathbf{k}_\\perp \\cdot \\mathbf{x}}$, the gyroaverage is:\n$$\n\\langle \\phi_\\mathbf{k} \\rangle(\\mathbf{R}) = \\hat{\\phi}_{\\mathbf{k}_\\perp} e^{i \\mathbf{k}_\\perp \\cdot \\mathbf{R}} \\left( \\frac{1}{2\\pi} \\int_0^{2\\pi} e^{i \\mathbf{k}_\\perp \\cdot \\boldsymbol{\\rho}(\\alpha)} d\\alpha \\right)\n$$\nThe integral evaluates to the zeroth-order Bessel function of the first kind, $J_0(k_\\perp \\rho)$. Thus, the gyroaveraging operator in Fourier space acts as multiplication by the factor $J_0(k_\\perp \\rho)$. The problem specifies using the real part of the phase factor for numerical verification, which relies on the integral representation:\n$$\nJ_0(x) = \\frac{1}{2\\pi} \\int_0^{2\\pi} \\cos(x \\cos\\theta) d\\theta\n$$\nThe Larmor radius $\\rho$ is determined by the particle's properties and the magnetic field. Based on the provided guiding-center relations, $v_\\perp^2 = \\frac{2\\mu B}{m}$ and $\\rho = \\frac{v_\\perp}{\\Omega}$ with $\\Omega = \\frac{qB}{m}$, we can express $\\rho$ in terms of $\\mu$. Substituting $v_\\perp = \\sqrt{2\\mu B/m}$ into the expression for $\\rho$ yields:\n$$\n\\rho = \\frac{\\sqrt{2\\mu B/m}}{qB/m} = \\frac{m}{qB} \\sqrt{\\frac{2\\mu B}{m}} = \\frac{\\sqrt{2m\\mu B}}{qB}\n$$\nAlternatively, and more directly for the specified task, $\\rho$ can be computed from $v_\\perp$ via $\\rho = \\frac{v_\\perp}{\\Omega} = \\frac{m v_\\perp}{qB}$.\n\nFor the first three tests, we validate the gyroaverage calculation. A set of $N_\\mu=256$ values of the Larmor radius $\\rho_j$ are generated. For each $\\rho_j$, we compute the analytic gyroaverage factor $A_j = J_0(k_\\perp \\rho_j)$ and its numerical approximation $N_j$. The numerical value is computed by discretizing the integral for $J_0(k_\\perp \\rho_j)$ using $N_\\theta=4096$ points for the gyroangle $\\theta$:\n$$\nN_j = \\frac{1}{N_\\theta} \\sum_{k=0}^{N_\\theta-1} \\cos(k_\\perp \\rho_j \\cos\\theta_k)\n$$\nThe accuracy is quantified by the dimensionless relative error $\\varepsilon$:\n$$\n\\varepsilon = \\sqrt{\\frac{\\sum_j (A_j - N_j)^2}{\\sum_j A_j^2}}\n$$\n\nFor the fourth test, we validate the parallel streaming operator. The parallel streaming equation, $\\frac{\\partial g}{\\partial t} + v_\\parallel \\frac{\\partial g}{\\partial s} = 0$, is a linear advection equation. We discretize it using a conservative finite-volume method on a uniform grid of $N_s=64$ cells of width $\\Delta s = L_s/N_s$. The update rule for the cell-averaged value $g_i$ in cell $i$ is:\n$$\ng_i^{n+1} = g_i^n - \\frac{\\Delta t}{\\Delta s} \\left( F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n \\right)\n$$\nwhere $F_{i\\pm 1/2}$ are the numerical fluxes at the cell interfaces. For an upwind scheme with $v_\\parallel > 0$, the flux at interface $i+1/2$ is determined by the state in the upwind cell $i$, so $F_{i+1/2}^n = v_\\parallel g_i^n$. The update becomes:\n$$\ng_i^{n+1} = g_i^n - \\frac{v_\\parallel \\Delta t}{\\Delta s} (g_i^n - g_{i-1}^n)\n$$\nThe problem specifies a time step $\\Delta t$ such that the Courant number $C \\equiv v_\\parallel \\Delta t / \\Delta s = 1$. This simplifies the update rule to:\n$$\ng_i^{n+1} = g_i^n - (g_i^n - g_{i-1}^n) = g_{i-1}^n\n$$\nWith periodic boundary conditions, this corresponds to shifting the entire array of values $g_i^0$ by one cell in the direction of $v_\\parallel$. Specifically, for $v_\\parallel > 0$, $g_i^1$ is the value that was in cell $i-1$ (with $g_0^1 = g_{N_s-1}^0$).\n\nA key property of a conservative numerical scheme for a conservation law is the conservation of total integrated quantities. For parallel streaming, total \"mass\" $M = \\int_0^{L_s} g(s) ds$ must be conserved. The discretized total mass at time step $n$ is $M^n = \\sum_{i=0}^{N_s-1} g_i^n \\Delta s$. Since the update for $C=1$ is a simple permutation of the cell values, $\\sum_i g_i^{n+1} = \\sum_i g_i^n$. Therefore, $M^{n+1}=M^n$, and the discrete mass is exactly conserved in infinite-precision arithmetic. The validation metric is the dimensionless absolute difference $|\\sum_i g_i^1 - \\sum_i g_i^0|$, which should be on the order of floating-point machine precision. The initial condition for $g$ is dimensionless, making this difference dimensionless as well.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import j0\n\ndef calculate_gyro_error(B, m, q, k_perp, N_mu, v_perp_max, N_theta):\n    \"\"\"\n    Calculates the relative error between analytic and numerical gyroaveraging.\n    \n    Args:\n        B (float): Magnetic field strength in Teslas.\n        m (float): Particle mass in kg.\n        q (float): Particle charge in Coulombs.\n        k_perp (float): Perpendicular wavenumber in m^-1.\n        N_mu (int): Number of points on the v_perp/mu/rho grid.\n        v_perp_max (float): Maximum perpendicular velocity in m/s.\n        N_theta (int): Number of points for numerical gyroangle integration.\n        \n    Returns:\n        float: The dimensionless relative error epsilon.\n    \"\"\"\n    # Create a uniform grid in perpendicular velocity.\n    v_perp_grid = np.linspace(0.0, v_perp_max, N_mu)\n    \n    # Calculate the Larmor radius grid.\n    # Cyclotron frequency Omega = q*B/m.\n    # Larmor radius rho = v_perp / Omega = m*v_perp / (q*B).\n    if q == 0 or B == 0:\n        # Avoid division by zero, though test cases are well-behaved.\n        # This case would correspond to infinite Larmor radius.\n        return np.inf\n    \n    omega = q * B / m\n    rho_grid = v_perp_grid / omega\n    \n    # 1. Analytic gyroaverage factor: J0(k_perp * rho)\n    analytic_factors = j0(k_perp * rho_grid)\n    \n    # 2. Numerical gyroaverage factor: average of cos(k_perp * rho * cos(theta))\n    # Using 'endpoint=False' for the theta grid is standard for periodic integrals.\n    theta_grid = np.linspace(0, 2 * np.pi, N_theta, endpoint=False)\n    \n    # Use numpy broadcasting for an efficient calculation across all rho values.\n    # rho_grid[:, np.newaxis] has shape (N_mu, 1).\n    # theta_grid has shape (N_theta,).\n    # cos(theta_grid) has shape (N_theta,).\n    # The argument to np.cos will have shape (N_mu, N_theta).\n    integration_args = k_perp * rho_grid[:, np.newaxis] * np.cos(theta_grid)\n    numerical_factors = np.mean(np.cos(integration_args), axis=1)\n    \n    # 3. Calculate the dimensionless relative error.\n    numerator = np.sum((analytic_factors - numerical_factors)**2)\n    denominator = np.sum(analytic_factors**2)\n    \n    # Handle the case where the denominator might be zero.\n    # For k_perp=0 (Test 2), analytic_factors are all 1, so denominator is N_mu != 0.\n    if denominator == 0.0:\n        return 0.0 if numerator == 0.0 else np.inf\n        \n    error = np.sqrt(numerator / denominator)\n    return error\n\ndef calculate_streaming_conservation(L_s, N_s, v_parallel):\n    \"\"\"\n    Calculates the mass conservation error for a single finite-volume streaming step.\n\n    Args:\n        L_s (float): Length of the periodic domain in s.\n        N_s (int): Number of finite volumes (cells).\n        v_parallel (float): Parallel streaming velocity in m/s.\n\n    Returns:\n        float: The dimensionless absolute difference in total mass.\n    \"\"\"\n    # Setup spatial grid and cell properties.\n    delta_s = L_s / N_s\n    # Cell centers grid s_i = (i+0.5)*delta_s\n    s_grid_centers = (np.arange(N_s) + 0.5) * delta_s\n    \n    # Set the initial condition for cell averages g_i^0.\n    g0 = 1.0 + 0.1 * np.sin(2 * np.pi * s_grid_centers / L_s)\n    \n    # The time step is chosen for a Courant number of 1.\n    # C = |v_parallel| * delta_t / delta_s = 1.\n    # The update for C=1 upwind is a simple shift.\n    \n    # Perform a single time-step update.\n    if v_parallel > 0:\n        # Upwind flux comes from the left (cell i-1).\n        # For C=1, this is g_i^1 = g_{i-1}^0.\n        # This is a right shift of the array.\n        g1 = np.roll(g0, 1)\n    elif v_parallel  0:\n        # Upwind flux comes from the right (cell i+1).\n        # For C=1, this is g_i^1 = g_{i+1}^0.\n        # This is a left shift of the array.\n        g1 = np.roll(g0, -1)\n    else: # v_parallel == 0\n        # No advection, solution does not change.\n        g1 = g0.copy()\n        \n    # Calculate total \"mass\" before and after.\n    # As g is dimensionless, sum(g) is the dimensionless total mass.\n    mass0 = np.sum(g0)\n    mass1 = np.sum(g1)\n    \n    # The problem asks for the dimensionless absolute mass difference.\n    abs_mass_difference = np.abs(mass1 - mass0)\n    \n    return abs_mass_difference\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    # ----- Test Parameters -----\n    # Common parameters for gyroaverage tests\n    B_common = 5e-5  # T\n    m_common = 1.6726219e-27  # kg (proton mass)\n    q_common = 1.602176634e-19  # C (proton charge)\n    N_mu_common = 256\n    v_perp_max_common = 2e4  # m/s\n    N_theta_common = 4096\n\n    test_cases = [\n        # Test 1: Gyroaverage accuracy, happy path\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 50.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n        \n        # Test 2: Gyroaverage accuracy, boundary case k_perp = 0\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 0.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n\n        # Test 3: Gyroaverage accuracy, large k_perp edge case\n        {'type': 'gyro', 'B': B_common, 'm': m_common, 'q': q_common, 'k_perp': 500.0,\n         'N_mu': N_mu_common, 'v_perp_max': v_perp_max_common, 'N_theta': N_theta_common},\n        \n        # Test 4: Finite-volume streaming mass conservation\n        {'type': 'stream', 'L_s': 1.0, 'N_s': 64, 'v_parallel': 1000.0}\n    ]\n\n    results = []\n    for case in test_cases:\n        if case['type'] == 'gyro':\n            result = calculate_gyro_error(\n                case['B'], case['m'], case['q'], case['k_perp'],\n                case['N_mu'], case['v_perp_max'], case['N_theta']\n            )\n        elif case['type'] == 'stream':\n            result = calculate_streaming_conservation(\n                case['L_s'], case['N_s'], case['v_parallel']\n            )\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}