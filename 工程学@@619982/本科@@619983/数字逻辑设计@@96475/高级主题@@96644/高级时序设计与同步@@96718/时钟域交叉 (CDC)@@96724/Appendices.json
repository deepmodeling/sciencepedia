{"hands_on_practices": [{"introduction": "掌握时钟域交叉（CDC）设计的第一步，是识别那些微妙但至关重要的风险。本练习 [@problem_id:1920408] 旨在探讨由组合逻辑产生的“毛刺”（glitch）信号的危险性。通过分析一个逻辑上恒为 $0$ 的电路 $Y = S \\land (\\neg S)$，你将发现物理门电路的传播延迟如何能产生意料之外的瞬态脉冲，而这些脉冲在被异步时钟采样时可能导致灾难性的系统错误，从而深刻理解为何只应同步经过寄存器输出的稳定信号。", "problem": "在一个数字系统中，一个在由`CLK_A`驱动的时钟域中工作的组件，与另一个在由`CLK_B`驱动的异步时钟域中的组件进行通信。一个单位信号`S`，它是由`CLK_A`时钟驱动的寄存器的输出，被用来生成一个控制信号`Y`。这个信号`Y`随后被传递到`CLK_B`域，作为同步D型触发器（DFF）的输入。\n\n从`S`生成`Y`的组合逻辑由布尔表达式`Y = S AND (NOT S)`定义。物理上，这是用一个标准非门和一个标准两输入与门实现的。非门的传播延迟为`t_NOT = 2.0 ns`，与门的传播延迟为`t_AND = 3.5 ns`。在本分析中，假定连线延迟和DFF的时钟到Q端的延迟可以忽略不计。\n\n初始时，信号`S`稳定在逻辑`0`。在时间`t = 0`时，`CLK_A`的一个上升沿导致信号`S`从`0`变为`1`。`Y`的逻辑预期稳态值始终为`0`。然而，物理门电路中不同的传播延迟可能会产生瞬态行为。\n\n在这种情况下，将组合逻辑输出`Y`跨时钟域边界馈送的这种设计选择，其主要且最直接的风险是什么？\n\nA. 电路将消耗过多的静态功耗，因为输出`Y`将卡在逻辑`1`状态。\n\nB. `Y`上的一个短暂毛刺脉冲可能会被`CLK_B`域的同步器采样，导致捕获到错误的值。\n\nC. 逻辑`S AND (NOT S)`是逻辑冗余的，综合工具会将其优化为常数`0`，从而阻止电路的物理实现。\n\nD. 在`S`发生跳变后，输出`Y`将在`0`和`1`之间持续振荡，使得同步无法进行。\n\nE. 信号`S`的跳变将在与门内部造成暂时的电气短路，可能损坏器件。", "solution": "将组合函数定义为 $Y=S \\land \\neg S$。在布尔代数中，对于所有稳定的$S$，该表达式可简化为 $Y \\equiv 0$。\n\n然而，在存在物理门和不相等的传播延迟的情况下，必须检查其时域行为。设反相器的传播延迟为 $t_{\\text{NOT}}$，与门的传播延迟为 $t_{\\text{AND}}$。假设连线延迟和时钟到Q端的延迟可以忽略不计，且$S$在$t=0$时从$0$跳变到$1$。\n\n1) 对于 $t<0$ 的情况，$S=0$ 且 $\\neg S=1$。与门的输入为 $(0,1)$，因此（在任何延迟稳定后）$Y=0$。\n\n2) 在 $t=0^{+}$ 时，`S` 在与门的输入端立即变为 `1`，而反相器的输出在 $t=t_{\\text{NOT}}$ 之前仍为 `1`。因此，在时间区间 $0 \\le t < t_{\\text{NOT}}$ 内，与门的输入为 $(1,1)$。\n\n3) 考虑到与门的传播延迟 $t_{\\text{AND}}$，与门的输出将在一段延迟后反映出 $(1,1)$ 的输入组合。因此，在传输延迟模型下，`Y` 上可能出现一个高电平脉冲，其发生时间为从 $t=t_{\\text{AND}}$ (上升)到 $t=t_{\\text{NOT}}+t_{\\text{AND}}$ (下降)，产生的脉冲宽度为 $t_{\\text{NOT}}$：\n$$\n\\Delta t_{\\text{glitch}} = t_{\\text{NOT}}.\n$$\n在惯性延迟模型下，宽度小于 $t_{\\text{AND}}$ 的脉冲可能会被滤除，但实际上，工艺-电压-温度（PVT）的变化以及不同的路径仍然可能在 `Y` 上产生一个非零脉冲。因此，`Y` 上的短暂毛刺是一个现实存在的冒险（hazard）。\n\n4) 由于 `Y` 被传输到由 $\\mathrm{CLK}_{B}$ 驱动的异步时钟域，并进入一个同步D型触发器，任何这样的短暂毛刺都可能与 $\\mathrm{CLK}_{B}$ 的采样边沿重合，导致同步器捕获到一个错误的逻辑 `1`（尽管其预期的稳态值为 $Y \\equiv 0$）。这是将组合逻辑信号跨时钟域边界传输所带来的主要且最直接的风险。\n\n因此，正确的选项是，`Y` 上的一个短暂毛刺脉冲可能会被 $\\mathrm{CLK}_{B}$ 域的同步器采样，导致捕获到错误的值。", "answer": "$$\\boxed{B}$$", "id": "1920408"}, {"introduction": "在理解了毛刺等意外信号的风险之后，我们现在转向传输合法信号所面临的挑战。本练习 [@problem_id:1920387] 对比了传输一个稳定的电平信号与一个单周期脉冲信号的场景，揭示了常用的双触发器同步器的一个关键局限性。你将通过分析当源时钟周期 $T_{src}$ 与目标时钟周期 $T_{dest}$ 可比时（例如 $T_{src} = 1.5 \\times T_{dest}$）的情况，理解为何简单的脉冲传输会产生不可预测的结果，这对于设计稳健的、基于事件的跨时钟域通信至关重要。", "problem": "在数字系统中，数据经常在以不同时钟频率工作的子系统之间传输，这个过程被称为时钟域交叉（Clock Domain Crossing, CDC）。考虑一个场景，其中一个信号必须从源时钟域（时钟 `clk_src`，周期为 $T_{src}$）传递到目的时钟域（时钟 `clk_dest`，周期为 $T_{dest}$）。已知时钟周期的关系为 $T_{src} = 1.5 \\times T_{dest}$。在目的域中使用一个标准的双触发器同步器，由 `clk_dest` 驱动，来安全地捕获输入信号。\n\n正在比较两种信号传输方法：\n1.  **脉冲信号传输（Pulse Signaling）：**源域产生一个脉冲，该脉冲在 `clk_src` 的一个时钟周期内保持高电平。信号高电平的持续时间为 $T_{src}$。\n2.  **电平信号传输（Level Signaling）：**源域将信号置为高电平，并保证其在高电平状态下稳定至少 $100 \\times T_{src}$ 的持续时间。\n\n从数字设计的角度来看，实现脉冲信号传输的可靠传输比电平信号传输更为困难。以下哪个陈述为这一困难提供了最准确和根本的原因？\n\nA. 脉冲信号的持续时间太短，总会被漏掉，因为信号必须在目的时钟的至少两个周期（$2 \\times T_{dest}$）内保持稳定，才能被双触发器同步器捕获。\n\nB. 单周期脉冲的总能量低于电平信号的总能量，使其更容易受到噪声影响，且不太可能触发同步器中第一个触发器的输入。\n\nC. 因为脉冲的持续时间（$1.5 \\times T_{dest}$）与目的时钟周期相当，所以在脉冲有效期间发生的采样时钟沿的数量可能会变化，导致输出脉冲的宽度不可预测（例如，零、一或两个周期）。\n\nD. 来自较慢 `clk_src` 域的脉冲信号的上升沿无法满足由较快 `clk_dest` 驱动的第一个触发器的建立时间要求。\n\nE. 传输单个脉冲需要握手协议（例如，请求-应答），这仅用一个双触发器同步器是无法实现的。", "solution": "我们已知两个异步时钟域，其周期 $T_{src}$ 和 $T_{dest}$ 满足关系 $T_{src} = \\frac{3}{2} T_{dest}$，并且有一个由目的时钟驱动的双触发器同步器。源端提供一个单周期脉冲（宽度为 $T_{src}$）或一个保持高电平至少 $100 T_{src}$ 的电平信号。\n\n双触发器同步器的基本机制是，第一个触发器在目的时钟沿采样异步输入，第二个触发器在下一个目的时钟沿采样第一个触发器的（可能亚稳态的）输出，从而大大降低亚稳态传播的概率。然而，同步器不保证脉冲宽度的保持，甚至不保证窄脉冲一定能被捕获；相反，捕获到的内容取决于在异步输入有效期间发生了多少个目的时钟域的采样时刻。\n\n假设目的时钟沿出现在时间 $t_{k} = k T_{dest} + \\phi$ 上，其中 $k$ 为整数，$\\phi \\in [0, T_{dest})$ 为某个未知的固定相位偏移。一个宽度为 $T_{src} = \\frac{3}{2} T_{dest}$ 的源域单周期脉冲占据区间\n$$\nI = [t_{0},\\ t_{0} + T_{src}) = [t_{0},\\ t_{0} + \\tfrac{3}{2} T_{dest}) .\n$$\n落在区间 $I$ 内的目的采样时刻的数量是集合的基数\n$$\nN(\\phi) = \\left| \\{ k \\in \\mathbb{Z} : t_{k} \\in I \\} \\right| .\n$$\n由于采样时刻的间隔为 $T_{dest}$，任何长度为 $L$ 的区间包含 $\\lfloor \\frac{L}{T_{dest}} \\rfloor$ 或 $\\lceil \\frac{L}{T_{dest}} \\rceil$ 个采样时刻，具体取决于相位 $\\phi$ 以及区间边界是否与采样点对齐。当 $L = \\frac{3}{2} T_{dest}$ 时，我们得到\n$$\n\\frac{L}{T_{dest}} = \\frac{3}{2} \\quad \\Longrightarrow \\quad N(\\phi) \\in \\{1,\\, 2\\} .\n$$\n因此，在不考虑亚稳态效应的情况下，第一个触发器将在一个或两个目的时钟沿上采样到有效脉冲，并且由于该触发器的输出仅在目的时钟沿更新，它将呈现一个持续一个或两个目的时钟周期的高电平。第二个触发器随后会产生一个持续一个或两个目的时钟周期的输出脉冲。关键在于，确切的宽度是不确定的，因为它取决于未知的相位 $\\phi$。\n\n此外，如果一个目的采样沿发生时任意接近脉冲的跳变沿，第一个触发器可能会进入亚稳态并延迟解析。在这种情况下，第二个触发器在下一个时钟沿可能看不到有效的高电平，从而在病态的相位排列下，有效地将观察到的输出减少到零个周期。因此，在实践中，目的域中的脉冲宽度可以是零、一或两个周期，而具体是哪种情况是无法预先预测的。\n\n相比之下，对于保持高电平至少 $100 T_{src}$ 的电平信号传输，其有效时间至少为\n$$\n100 T_{src} = 100 \\times \\tfrac{3}{2} T_{dest} = 150 T_{dest} ,\n$$\n因此，在信号为高电平期间，至少有150个目的采样时刻。因此，双触发器同步器将可靠地捕获并呈现一个持续多个目的时钟周期的稳定高电平；亚稳态如果发生，也只会扰乱跳变的确切周期，而不会威胁到电平信号本身的存在。\n\n现在评估各个选项：\n\nA 是错误的。双触发器同步器并不要求输入信号为了被捕获而稳定 $2 T_{dest}$ 的时间；一个干净的采样沿就足以捕获一个电平，而第二级的作用是抑制亚稳态。\n\nB 是错误的。捕获是由采样时刻以及建立/保持时间的相对关系决定的，而不是由数字脉冲的“能量”决定的。\n\nC 是正确的。因为脉冲宽度与 $T_{dest}$ 相当，所以在脉冲有效期间发生的目的采样沿数量会随着未知的相位和亚稳态时序而变化，从而产生一个宽度不可预测的输出脉冲（零、一或两个周期）。这种不确定性是根本的困难所在。\n\nD 是错误的。在CDC中，根据定义，相对于目的时钟的建立时间是不保证的；不满足建立时间的问题由同步器处理，而不是脉冲传输困难的根本原因。\n\nE 作为一般性陈述是错误的。虽然握手协议或翻转方案是处理脉冲的常见鲁棒解决方案，但并非说它们“无法用”双触发器同步器实现；而是说，单独的双触发器同步器无法确定性地保持单次脉冲的宽度。\n\n因此，最准确和根本的原因是，在脉冲有效期间发生的目的采样次数的可变性，使得最终在目的域产生的脉冲宽度不可预测，正如选项C所陈述的。", "answer": "$$\\boxed{C}$$", "id": "1920387"}, {"introduction": "设计者常犯的一个错误是在不需要的地方应用复杂的CDC解决方案，因此区分真正的异步系统和仅是多时钟的同步系统至关重要。本练习 [@problem_id:1920380] 提出了一个场景，其中包含两个时钟，一个时钟的频率是另一个的两倍且相位完全对齐。通过分析这个设定，你将学会如何应用标准的同步时序分析来判断一个简单的寄存器是否足以安全地传输数据，从而巩固对“时钟域交叉”问题本质——即时钟间存在未知或任意相位关系——的精确理解。", "problem": "在一个数字系统中，一个`Producer`模块在一个由`clk_A`控制的时钟域中运行，其频率为10 MHz。一个`Consumer`模块在一个由`clk_B`控制的时钟域中运行，其频率为20 MHz。时钟生成电路确保`clk_B`相对于`clk_A`是完全相位对齐且频率加倍的，因此`clk_A`的每个上升沿都与`clk_B`的一个上升沿完全重合。\n\n`Producer`模块生成一个单位信号`data_out`，它是一个由`clk_A`驱动的D型触发器（DFF）的输出。`Consumer`模块尝试使用一个由`clk_B`驱动的单个DFF来捕获这个`data_out`信号。假设生产者的触发器的时钟到Q端延迟以及消费者的触发器的建立时间和保持时间都非零，但足够小，以至于它们的和小于50 ns。\n\n这种使用单个DFF的方法对于将`data_out`信号从`clk_A`域传输到`clk_B`域是否是一种“安全”的方法，即它能正确捕获数据值而不会引入亚稳态？\n\n从以下选项中选择最佳解释。\n\nA. 不，因为任何时候数据在不同时钟频率的域之间跨越时，都需要一个两级触发器同步器来防止亚稳态。\n\nB. 是，因为时钟是同步的。来自10 MHz域的数据在`clk_A`的一个上升沿之后不久发生变化，并且在20 MHz时钟的下一个上升沿（发生在50 ns之后）到来之前很久就会变得稳定，从而满足建立时间和保持时间的要求。\n\nC. 不，因为20 MHz的时钟太快，将不可避免地在`data_out`信号转换时对其进行采样，从而导致亚稳态。\n\nD. 是，因为10 MHz的`data_out`信号会保持恒定整整100 ns，这比`clk_B`的50 ns周期要长，从而保证了安全的捕获。", "solution": "设生产者的时钟为$f_{A}=10\\,\\text{MHz}$，周期$T_{A}=1/f_{A}=100\\,\\text{ns}$；消费者的时钟为$f_{B}=20\\,\\text{MHz}$，周期$T_{B}=1/f_{B}=50\\,\\text{ns}$。根据设计，时钟是同步且完全相位对齐的，因此`clk_A`在$t=nT_{A}$的每个上升沿都与`clk_B`在$t=mT_{B}$（其中$m=2n$）的一个上升沿重合，并且在`clk_A`的连续两个边沿之间，还有一个额外的`clk_B`上升沿出现在$t=nT_{A}+T_{B}$。\n\n生产者的DFF在`clk_A`的上升沿发出一个新值。将生产者的时钟到Q端延迟记为$t\\_{cq,A}>0$。那么，输出`data_out`在时间$t=nT_{A}+t\\_{cq,A}$发生跳变，在其他时间保持不变。\n\n消费者的DFF在`clk_B`的上升沿（时间为$t=mT_{B}$）对`data_out`进行采样。考虑在$t=nT_{A}$数据发出时刻附近的两个连续相关采样时刻：\n1. 在重合边沿$t=nT_{A}$进行采样：在这一时刻，`data_out`尚未改变，因为变化发生在$t=nT_{A}+t\\_{cq,A}$。为了使这次采样安全且不产生亚稳态，必须满足消费者的保持时间约束：\n$$\nt\\_{cq,A} \\ge t\\_{hold,B}.\n$$\n由于数据变化严格发生在采样边沿之后$t\\_{cq,A}>0$的时间点，且实际的$t\\_{hold,B}$很小，所以在典型的同步设计中，这个条件很自然地被满足；在$t=nT_{A}$附近的消费者采样窗口内没有数据跳变，因此消费者安全地捕获了旧值。\n\n2. 在下一个`clk_B`边沿$t=nT_{A}+T_{B}$进行采样：为了让消费者安全地（不产生亚稳态）捕获新发出的值，必须满足建立时间约束：\n$$\nt\\_{cq,A} + t\\_{path} + t\\_{setup,B} \\le T_{B}.\n$$\n这里的$t\\_{path}$是从生产者Q端到消费者D端的传播延迟，由于`data_out`直接来自一个DFF，这个延迟是最小的。问题中说明，生产者的时钟到Q端延迟以及消费者的建立和保持时间都非零，但足够小，以至于它们的和小于$50\\,\\text{ns}=T_{B}$。因此\n$$\nt\\_{cq,A} + t\\_{setup,B} < T_{B}\n$$\n成立，这确保了新值在$t=nT_{A}+T_{B}$之前早已稳定，所以满足了建立时间要求，并且在这个边沿不会引发亚稳态。\n\n因为时钟是同步的且具有固定的相位对齐关系，并且根据给定的假设（特别是$t\\_{cq,A}+t\\_{setup,B}<T_{B}$，且数据变化发生在重合边沿之后，因此保持时间窗口未被违反），一个由`clk_B`驱动的单个消费者DFF将安全地捕获`data_out`：它将在$t=nT_{A}$时采样旧值，并在$t=nT_{A}+T_{B}$时采样新值，而不会引入亚稳态。因此，在这种同步、相位对齐的情况下，不需要两级触发器同步器。在这些选项中，与此推理相符的解释是：时钟是同步的，并且数据值在下一个`clk_B`边沿到来之前早已稳定，满足了建立时间和保持时间要求。\n\n因此，最佳选项是B。", "answer": "$$\\boxed{B}$$", "id": "1920380"}]}