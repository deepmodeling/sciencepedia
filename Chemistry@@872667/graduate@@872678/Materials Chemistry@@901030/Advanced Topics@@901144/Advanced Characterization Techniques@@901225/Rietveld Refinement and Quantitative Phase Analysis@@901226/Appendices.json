{"hands_on_practices": [{"introduction": "The foundation of any accurate Rietveld refinement is high-quality diffraction data, which begins with a precisely calibrated instrument. In the common Bragg-Brentano geometry, systematic errors such as zero shift and specimen displacement can significantly alter peak positions, leading to incorrect lattice parameters and phase identification. This exercise [@problem_id:2517921] provides hands-on practice in deriving a physical model for these errors from first principles and using it to calibrate the diffractometer, a critical skill for obtaining reliable structural information.", "problem": "A Bragg–Brentano parafocusing X-ray diffraction (XRD) instrument exhibits two dominant systematic errors that shift peak positions: an additive zero shift and a specimen displacement along the diffractometer axis. Consider a calibration using a crystalline standard with known expected peak positions, then apply the estimated instrument corrections to a separate sample pattern prior to Rietveld refinement. Your task is to derive from first principles a linearizable relationship between measured and expected positions that allows simultaneous estimation of the zero shift and the specimen displacement using only the known instrument radius and the calibrant peak positions, and then use those estimates to correct a sample’s measured pattern by solving the appropriate implicit equation for the corrected angles. All angles must be treated and reported in degrees, and the specimen displacement must be treated and reported in millimetres.\n\nStarting points you may assume:\n- Bragg’s law for diffraction relates interplanar spacing, wavelength, and the Bragg angle. In the Bragg–Brentano geometry, a peak occurs at a scattering angle that is twice the Bragg angle.\n- In this parafocusing geometry, a small specimen height error modifies the diffraction condition via a deterministic path-length effect that depends on the Bragg angle and the diffractometer radius.\n- The zero shift is an additive angular offset to the measured $2\\theta$ that is independent of angle.\n\nDo not use any “shortcut” formulas not derived from these principles; instead, construct the appropriate relation and estimation procedure from these bases.\n\nFor each test case below, you are given:\n- The diffractometer radius $R$ in millimetres.\n- The expected calibrant peak positions (true) in $2\\theta$ in degrees.\n- The measured calibrant peak positions in $2\\theta$ in degrees.\n- A set of sample peak positions (observed) in $2\\theta$ in degrees that must be corrected using your estimated instrument parameters.\n\nYour program must, for each test case:\n1) Estimate the zero shift $z$ in degrees and the specimen displacement $\\Delta h$ in millimetres from the calibrant peaks and $R$, using a physically justified linearizable model derived from the Bragg–Brentano geometry with a small-displacement approximation. Do not assume either parameter is known a priori.\n2) Apply the estimated $z$ and $\\Delta h$ to correct each provided sample $2\\theta$ by solving the appropriate implicit correction equation for the corrected $2\\theta$ using a numerically stable fixed-point or root-finding iteration. Use a convergence tolerance of $\\varepsilon = 10^{-10}$ degrees on the corrected $2\\theta$ and a maximum of $100$ iterations per peak. If the iteration does not converge within the limit, return the last iterate.\n3) Report all outputs as real numbers rounded to six decimal places.\n\nTest suite (three cases):\n- Case $1$:\n  - $R = 200.0$ mm\n  - Expected calibrant $2\\theta$ (degrees): $[28.44200, 47.30500, 56.11900]$\n  - Measured calibrant $2\\theta$ (degrees): $[28.40870, 47.27610, 56.09320]$\n  - Sample observed $2\\theta$ (degrees): $[30.00000, 45.00000, 60.00000, 75.00000]$\n- Case $2$:\n  - $R = 217.5$ mm\n  - Expected calibrant $2\\theta$ (degrees): $[28.44200, 47.30500, 56.11900]$\n  - Measured calibrant $2\\theta$ (degrees): $[28.32200, 47.18500, 55.99900]$\n  - Sample observed $2\\theta$ (degrees): $[25.00000, 40.00000, 55.00000, 70.00000]$\n- Case $3$:\n  - $R = 160.0$ mm\n  - Expected calibrant $2\\theta$ (degrees): $[28.44200, 47.30500, 56.11900]$\n  - Measured calibrant $2\\theta$ (degrees): $[28.58100, 47.43630, 56.24560]$\n  - Sample observed $2\\theta$ (degrees): $[35.00000, 50.00000, 65.00000, 80.00000]$\n\nAngle unit: degrees. Length unit: millimetres. No other units may be used. Express $z$ as a real number in degrees and $\\Delta h$ as a real number in millimetres. Each corrected sample peak must be expressed as a real number in degrees.\n\nFinal output format:\n- Produce a single line containing a comma-separated list enclosed in square brackets.\n- The list must concatenate, in order, for each test case: the estimated zero shift $z$ (degrees), the estimated specimen displacement $\\Delta h$ (millimetres), followed by the corrected sample $2\\theta$ values (degrees) in the exact order given for that case.\n- All numbers must be rounded to six decimal places.\n- Concretely, for three cases each with four sample peaks, the output must contain $3 \\times (2 + 4) = 18$ numbers, e.g., $[z_1, \\Delta h_1, c_{1,1}, c_{1,2}, c_{1,3}, c_{1,4}, z_2, \\Delta h_2, c_{2,1}, c_{2,2}, c_{2,3}, c_{2,4}, z_3, \\Delta h_3, c_{3,1}, c_{3,2}, c_{3,3}, c_{3,4}]$, where each $c_{i,j}$ is a corrected sample $2\\theta$ in degrees.", "solution": "The problem is validated as scientifically grounded, well-posed, and an objective task in applied physics and data analysis. It requires the derivation and application of a model for systematic errors in Bragg-Brentano X-ray diffractometry. The solution proceeds in two stages: first, the derivation of the model and estimation of instrument parameters from calibration data; second, the application of these parameters to correct measured data from a sample.\n\nThe relationship between the measured scattering angle, $2\\theta_m$, and the true crystallographic scattering angle, $2\\theta_c$, is affected by several systematic errors. The problem specifies two dominant errors: an instrument zero shift, $z$, and a specimen displacement error, $\\Delta h$. The measured angle is the sum of the true angle and the contributions from these errors.\n\nThe zero shift, $z$, is a constant angular offset added to all measurements, independent of the angle itself. Thus, its contribution to the measured angle is simply $+z$.\n\nThe specimen displacement error arises when the sample surface is not perfectly coincident with the goniometer's focusing circle axis. A displacement $\\Delta h$ of the specimen along its surface normal (perpendicular to the sample plane) introduces an angle-dependent shift in the measured peak position. A geometric analysis of the Bragg-Brentano parafocusing geometry reveals that for a small displacement $\\Delta h$ relative to the goniometer radius $R$, the induced angular shift in $2\\theta$, denoted $\\Delta(2\\theta)_{disp}$, is given in radians by:\n$$\n\\Delta(2\\theta)_{disp} \\approx -2\\frac{\\Delta h}{R}\\cos(\\theta_c)\n$$\nwhere $\\theta_c = 2\\theta_c / 2$ is the true Bragg angle. The negative sign indicates that a positive displacement (sample too high, toward the source/detector) shifts the peak to a lower $2\\theta$ value. To work in degrees, as required, we convert this expression:\n$$\n\\Delta(2\\theta)_{disp, deg} = \\left(-2\\frac{\\Delta h}{R}\\cos(\\theta_c)\\right) \\times \\frac{180}{\\pi} = -\\frac{360}{\\pi}\\frac{\\Delta h}{R}\\cos(\\theta_c)\n$$\nCombining both error terms, the relationship between the measured and true angles is:\n$$\n2\\theta_m \\approx 2\\theta_c + z + \\Delta(2\\theta)_{disp, deg} = 2\\theta_c + z - \\frac{360}{\\pi}\\frac{\\Delta h}{R}\\cos(\\theta_c)\n$$\nTo estimate the unknown parameters $z$ and $\\Delta h$, we rearrange this equation into a linear form suitable for regression. Using the provided calibrant data, for which both $2\\theta_m$ and $2\\theta_c$ are known for a set of peaks $i=1, \\dots, N$:\n$$\n2\\theta_{m,i} - 2\\theta_{c,i} = z - \\left(\\frac{360}{\\pi R}\\Delta h\\right) \\cos(\\theta_{c,i})\n$$\nThis equation is of the form $Y_i = C + M X_i$, which defines a straight line. We can identify the variables and coefficients:\n- The dependent variable is $Y_i = 2\\theta_{m,i} - 2\\theta_{c,i}$.\n- The independent variable is $X_i = \\cos(\\theta_{c,i}) = \\cos(2\\theta_{c,i}/2)$.\n- The intercept is $C = z$.\n- The slope is $M = -\\frac{360}{\\pi R}\\Delta h$.\n\nGiven a set of calibration peaks, the values for $z$ and $M$ can be determined by performing a linear least-squares fit of $Y$ versus $X$. The instrument zero shift $z$ is directly given by the intercept of the fit. The specimen displacement $\\Delta h$ can be calculated from the slope $M$:\n$$\n\\Delta h = -M \\frac{\\pi R}{360}\n$$\nOnce the parameters $z$ and $\\Delta h$ (via $M$) are estimated, they can be used to correct the measured peak positions, $2\\theta_{obs}$, for a new sample. For such a sample, the true, corrected position $2\\theta_{corr}$ is unknown. It is found by solving the following implicit equation:\n$$\n2\\theta_{obs} = 2\\theta_{corr} + z - \\frac{360}{\\pi}\\frac{\\Delta h}{R}\\cos(\\theta_{corr})\n$$\nSubstituting $M = -\\frac{360}{\\pi R}\\Delta h$, we get:\n$$\n2\\theta_{obs} = 2\\theta_{corr} + z + M \\cos(\\theta_{corr})\n$$\nRearranging to solve for $2\\theta_{corr}$ gives:\n$$\n2\\theta_{corr} = 2\\theta_{obs} - z - M \\cos(\\frac{2\\theta_{corr}}{2})\n$$\nThis equation is in the form $x = g(x)$, where $x = 2\\theta_{corr}$ and $g(x) = (2\\theta_{obs} - z) - M \\cos(x/2)$. It can be solved numerically using fixed-point iteration. We define an iterative sequence:\n$$\nx_{k+1} = (2\\theta_{obs} - z) - M \\cos\\left(\\frac{\\pi}{180} \\frac{x_k}{2}\\right)\n$$\nA suitable initial guess is $x_0 = 2\\theta_{obs} - z$, which neglects the small displacement correction. The iteration is repeated until the change between successive values, $|x_{k+1} - x_k|$, falls below a specified tolerance $\\varepsilon = 10^{-10}$. The convergence is rapid because the derivative $|g'(x)| = |(M \\pi / 360) \\sin(x/2)| = |(\\Delta h/R)\\sin(x/2)|$ is typically much less than $1$. If convergence is not achieved within $100$ iterations, the last computed value is used. All angles must be handled in degrees, with conversions to radians for trigonometric function arguments.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves for instrument correction parameters and applies them to sample data\n    for a series of test cases in X-ray diffraction analysis.\n    \"\"\"\n    # Test cases as provided in the problem description.\n    test_cases = [\n        {\n            \"R\": 200.0,\n            \"cal_true\": np.array([28.44200, 47.30500, 56.11900]),\n            \"cal_meas\": np.array([28.40870, 47.27610, 56.09320]),\n            \"sam_obs\": np.array([30.00000, 45.00000, 60.00000, 75.00000]),\n        },\n        {\n            \"R\": 217.5,\n            \"cal_true\": np.array([28.44200, 47.30500, 56.11900]),\n            \"cal_meas\": np.array([28.32200, 47.18500, 55.99900]),\n            \"sam_obs\": np.array([25.00000, 40.00000, 55.00000, 70.00000]),\n        },\n        {\n            \"R\": 160.0,\n            \"cal_true\": np.array([28.44200, 47.30500, 56.11900]),\n            \"cal_meas\": np.array([28.58100, 47.43630, 56.24560]),\n            \"sam_obs\": np.array([35.00000, 50.00000, 65.00000, 80.00000]),\n        }\n    ]\n\n    all_results = []\n    \n    # Define constants for the iterative correction\n    TOLERANCE = 1e-10\n    MAX_ITERATIONS = 100\n\n    for case in test_cases:\n        R = case[\"R\"]\n        cal_true_2theta = case[\"cal_true\"]\n        cal_meas_2theta = case[\"cal_meas\"]\n        sam_obs_2theta = case[\"sam_obs\"]\n\n        # Step 1: Estimate z and delta_h using linear regression.\n        # The model is: 2theta_meas = 2theta_true + z - (360/pi * delta_h/R) * cos(theta_true)\n        # We linearize this as: y = C + M*x\n        # where y = 2theta_meas - 2theta_true, x = cos(theta_true), C = z, M = -(360/pi * delta_h/R)\n        \n        y_cal = cal_meas_2theta - cal_true_2theta\n        theta_true_deg = cal_true_2theta / 2.0\n        x_cal = np.cos(np.deg2rad(theta_true_deg))\n\n        # Perform linear least-squares regression to find slope (M) and intercept (C).\n        # np.polyfit(x, y, 1) returns [slope, intercept].\n        slope, intercept = np.polyfit(x_cal, y_cal, 1)\n\n        # Estimate parameters z and delta_h from regression results.\n        z_est = intercept  # in degrees\n        # From M = -(360/pi * delta_h/R), we get delta_h = -M * (pi*R/360)\n        delta_h_est = -slope * (np.pi * R / 360.0)  # in mm\n\n        all_results.append(z_est)\n        all_results.append(delta_h_est)\n\n        # Step 2: Correct sample peak positions by solving the implicit equation.\n        # 2theta_corr = 2theta_obs - z + (360/pi * delta_h/R) * cos(theta_corr)\n        # Using the slope M: 2theta_corr = 2theta_obs - z - M * cos(theta_corr)\n        \n        corrected_peaks = []\n        for obs_peak in sam_obs_2theta:\n            # Fixed-point iteration: x_{k+1} = g(x_k)\n            # where x = 2theta_corr\n\n            # Initial guess for the corrected angle\n            x_corr = obs_peak - z_est\n            \n            constant_term = obs_peak - z_est\n            cosine_coeff = -slope\n            \n            for _ in range(MAX_ITERATIONS):\n                x_prev = x_corr\n                # The argument to cosine must be in radians. x_prev is 2*theta in degrees.\n                theta_corr_rad = np.deg2rad(x_prev / 2.0)\n                x_corr = constant_term + cosine_coeff * np.cos(theta_corr_rad)\n                \n                if np.abs(x_corr - x_prev) < TOLERANCE:\n                    break\n            \n            corrected_peaks.append(x_corr)\n        \n        all_results.extend(corrected_peaks)\n\n    # Format all numbers to six decimal places for the final output string.\n    formatted_results = [f\"{num:.6f}\" for num in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "2517921"}, {"introduction": "Beyond instrumental corrections, the true power of Rietveld refinement lies in its ability to solve for complex structural details by incorporating chemical and physical knowledge directly into the mathematical model. Many advanced materials feature crystallographic sites with mixed atomic occupancy, which requires careful handling during refinement. This practice [@problem_id:2517932] delves into the core of constrained refinement, demonstrating how to enforce fundamental principles like charge neutrality and full site occupancy to determine the precise cation distribution in a mixed-oxide system.", "problem": "You are given a simplified but scientifically grounded model of constrained occupancy refinement for a mixed-cation site in an oxide, suitable for formulating a constrained least-squares problem as used in Rietveld refinement for quantitative phase analysis. Consider an idealized perovskite-like oxide of nominal composition $\\mathrm{AFeO}_{3-\\delta}$ measured by Neutron Powder Diffraction (NPD). The $\\mathrm{A}$ site exhibits cation mixing between strontium and lanthanum, and the oxygen site may be sub-stoichiometric to enforce charge neutrality. The iron site is fully occupied and fixed as $\\mathrm{Fe}^{3+}$. Assume isotropic displacement parameters and fixed lattice for the purposes of this problem; focus solely on occupancies and constraints.\n\nFundamental bases and assumptions:\n- The total scattering amplitude contribution from a crystallographic site for a chosen set of reflections is modeled linearly as the product of its average coherent scattering length and a known reflection-dependent scale factor. For a site with average coherent scattering length $b_{\\mathrm{avg}}$, the amplitude proxy for a given reflection is $S \\, b_{\\mathrm{avg}}$, where $S$ is a known scale constant for that reflection. This is a standard linearization used in occupancy refinement when reflections are chosen such that phase interference from other sites is negligible.\n- The coherent neutron scattering lengths are constants: $b_{\\mathrm{Sr}} = 7.02 \\,\\mathrm{fm}$, $b_{\\mathrm{La}} = 8.24 \\,\\mathrm{fm}$, and $b_{\\mathrm{O}} = 5.803 \\,\\mathrm{fm}$.\n- The unknown occupancies are collected in the vector $\\mathbf{x} = \\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big]^{\\mathsf{T}}$, where $x_{\\mathrm{Sr}}$ and $x_{\\mathrm{La}}$ are the fractional occupancies of strontium and lanthanum on the $\\mathrm{A}$ site (a single site) and $x_{\\mathrm{O}}$ is the site occupancy factor for oxygen, assumed common to three equivalent oxygen sites so that the total oxygen per formula unit is $3\\,x_{\\mathrm{O}}$.\n- Full occupancy on the $\\mathrm{A}$ site is enforced by the constraint $x_{\\mathrm{Sr}} + x_{\\mathrm{La}} = 1$.\n- Charge neutrality is enforced across the formula unit using fixed $\\mathrm{Fe}^{3+}$ and variable oxygen occupancy. The neutrality condition is $2\\,x_{\\mathrm{Sr}} + 3\\,x_{\\mathrm{La}} + 3 - 2 \\cdot 3 \\, x_{\\mathrm{O}} = 0$, which can be written as $2\\,x_{\\mathrm{Sr}} + 3\\,x_{\\mathrm{La}} - 6\\,x_{\\mathrm{O}} = -3$.\n- Let $\\mathcal{A}$ denote the mixed $\\mathrm{A}$ site and $\\mathcal{O}$ denote the oxygen site. For a set of reflections chosen to be dominated by site $\\mathcal{A}$, the amplitude proxies are $y_{\\mathcal{A},k} = S_{\\mathcal{A},k}\\,\\big(b_{\\mathrm{Sr}}\\,x_{\\mathrm{Sr}} + b_{\\mathrm{La}}\\,x_{\\mathrm{La}}\\big)$ for $k$ in a specified set. For a set of reflections dominated by site $\\mathcal{O}$, the amplitude proxies are $y_{\\mathcal{O},\\ell} = S_{\\mathcal{O},\\ell}\\,\\big(b_{\\mathrm{O}}\\,x_{\\mathrm{O}}\\big)$ for $\\ell$ in a specified set.\n\nYour task is to:\n- Formulate the constrained linear least-squares problem that minimizes the sum of squared residuals between observed amplitude proxies and their calculated values, subject to the linear constraints of full occupancy and charge neutrality.\n- Implement an algorithm to solve the constrained least-squares problem by solving the Karush-Kuhn-Tucker (KKT) linear system for equality-constrained least squares.\n- Apply your solver to the provided test suite and return the refined occupancies.\n\nMathematical formulation:\n- Stack the equations for the $\\mathcal{A}$-site amplitude proxies and the $\\mathcal{O}$-site amplitude proxies into a single linear system $\\mathbf{M}\\,\\mathbf{x} \\approx \\mathbf{y}$, where $\\mathbf{M}$ has rows of the form $S_{\\mathcal{A},k}\\,[\\,b_{\\mathrm{Sr}},\\, b_{\\mathrm{La}},\\, 0\\,]$ for the $\\mathcal{A}$-site-dominated reflections and $S_{\\mathcal{O},\\ell}\\,[\\,0,\\, 0,\\, b_{\\mathrm{O}}\\,]$ for the $\\mathcal{O}$-site-dominated reflections. The constraint matrix is $\\mathbf{A}_{\\mathrm{eq}}\\,\\mathbf{x} = \\mathbf{b}_{\\mathrm{eq}}$ with\n$$\n\\mathbf{A}_{\\mathrm{eq}} =\n\\begin{bmatrix}\n1 & 1 & 0 \\\\\n2 & 3 & -6\n\\end{bmatrix},\n\\quad\n\\mathbf{b}_{\\mathrm{eq}} =\n\\begin{bmatrix}\n1 \\\\\n-3\n\\end{bmatrix}.\n$$\n- Solve the equality-constrained least-squares problem by forming the KKT system\n$$\n\\begin{bmatrix}\n\\mathbf{H} & \\mathbf{A}_{\\mathrm{eq}}^{\\mathsf{T}} \\\\\n\\mathbf{A}_{\\mathrm{eq}} & \\mathbf{0}\n\\end{bmatrix}\n\\begin{bmatrix}\n\\mathbf{x} \\\\\n\\boldsymbol{\\lambda}\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n\\mathbf{g} \\\\\n\\mathbf{b}_{\\mathrm{eq}}\n\\end{bmatrix},\n\\quad\n\\text{with }\n\\mathbf{H} = \\mathbf{M}^{\\mathsf{T}} \\mathbf{M},\n\\;\n\\mathbf{g} = \\mathbf{M}^{\\mathsf{T}} \\mathbf{y},\n$$\nwhere $\\boldsymbol{\\lambda}$ are Lagrange multipliers. Extract $\\mathbf{x}$.\n\nTest suite and numerical data:\n- Use scale factors $S_{\\mathcal{A}} = \\big[\\,1.0,\\, 0.8,\\, 1.2\\,\\big]$ and $S_{\\mathcal{O}} = \\big[\\,1.0,\\, 0.9\\,\\big]$ for the $\\mathcal{A}$ and $\\mathcal{O}$ sets, respectively.\n- Use coherent scattering lengths $b_{\\mathrm{Sr}} = 7.02$ (in $\\mathrm{fm}$), $b_{\\mathrm{La}} = 8.24$ (in $\\mathrm{fm}$), and $b_{\\mathrm{O}} = 5.803$ (in $\\mathrm{fm}$).\n- The observed amplitude proxies $\\mathbf{y}$ for each case are:\n\nCase $\\mathbf{1}$ (moderate mixing, oxygen deficiency consistent with neutrality):\n- Ground-truth mixture (not used directly by your solver, provided for context): $x_{\\mathrm{Sr}} = 0.4$, $x_{\\mathrm{La}} = 0.6$, $x_{\\mathrm{O}} = 14/15$.\n- Observed $\\mathcal{A}$-site amplitudes: $y_{\\mathcal{A}} = \\big[\\,7.752,\\, 6.2016,\\, 9.3024\\,\\big]$.\n- Observed $\\mathcal{O}$-site amplitudes: $y_{\\mathcal{O}} = \\big[\\,5.416133333333333,\\, 4.87452\\,\\big]$.\n\nCase $\\mathbf{2}$ (boundary with $\\mathrm{Sr}$-rich):\n- Ground-truth mixture: $x_{\\mathrm{Sr}} = 1.0$, $x_{\\mathrm{La}} = 0.0$, $x_{\\mathrm{O}} = 5/6$.\n- Observed $\\mathcal{A}$-site amplitudes: $y_{\\mathcal{A}} = \\big[\\,7.02,\\, 5.616,\\, 8.424\\,\\big]$.\n- Observed $\\mathcal{O}$-site amplitudes: $y_{\\mathcal{O}} = \\big[\\,4.835833333333333,\\, 4.35225\\,\\big]$.\n\nCase $\\mathbf{3}$ (boundary with $\\mathrm{La}$-rich):\n- Ground-truth mixture: $x_{\\mathrm{Sr}} = 0.0$, $x_{\\mathrm{La}} = 1.0$, $x_{\\mathrm{O}} = 1.0$.\n- Observed $\\mathcal{A}$-site amplitudes: $y_{\\mathcal{A}} = \\big[\\,8.24,\\, 6.592,\\, 9.888\\,\\big]$.\n- Observed $\\mathcal{O}$-site amplitudes: $y_{\\mathcal{O}} = \\big[\\,5.803,\\, 5.2227\\,\\big]$.\n\nProgramming task:\n- Implement a program that builds $\\mathbf{M}$ and $\\mathbf{y}$ for each case using the provided $S_{\\mathcal{A}}$, $S_{\\mathcal{O}}$, $b_{\\mathrm{Sr}}$, $b_{\\mathrm{La}}$, and $b_{\\mathrm{O}}$, and the observed amplitude proxies listed above. Then solve the KKT system to obtain the refined occupancies $\\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big]$ for each case.\n- Numerical outputs must be expressed as decimal fractions rounded to six decimal places.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is a sublist of the three refined occupancies $\\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big]$ rounded to six decimal places. For example, the output should look like $[[a_1,b_1,c_1],[a_2,b_2,c_2],[a_3,b_3,c_3]]$ with no additional text or spaces.", "solution": "We begin from the fundamental structure-factor concept in diffraction, where the intensity of a reflection is proportional to the squared modulus of the structure factor, and the structure factor is a sum of atomic scattering contributions. When reflections are chosen such that a single site dominates the amplitude and the phase interference from other sites is negligible, one can model an amplitude proxy as linear in the site’s average scattering length times a known geometric scale factor. For a site with partial occupancies, the average coherent scattering length is the occupancy-weighted sum of the constituent species’ coherent neutron scattering lengths.\n\nLet $\\mathbf{x} = \\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big]^{\\mathsf{T}}$ be the vector of unknown occupancies. For the $\\mathrm{A}$ site, the average coherent scattering length is\n$$\nb_{\\mathrm{avg},\\mathcal{A}} = b_{\\mathrm{Sr}}\\,x_{\\mathrm{Sr}} + b_{\\mathrm{La}}\\,x_{\\mathrm{La}},\n$$\nand the amplitude proxy for the $k$-th selected reflection is\n$$\ny_{\\mathcal{A},k} \\approx S_{\\mathcal{A},k} \\, b_{\\mathrm{avg},\\mathcal{A}} = S_{\\mathcal{A},k}\\,\\big(b_{\\mathrm{Sr}}\\,x_{\\mathrm{Sr}} + b_{\\mathrm{La}}\\,x_{\\mathrm{La}}\\big).\n$$\nFor the oxygen site with occupancy $x_{\\mathrm{O}}$ common to three equivalent sites per formula unit, the amplitude proxy for the $\\ell$-th selected reflection is\n$$\ny_{\\mathcal{O},\\ell} \\approx S_{\\mathcal{O},\\ell} \\, b_{\\mathrm{O}} \\, x_{\\mathrm{O}}.\n$$\n\nWe enforce two linear constraints:\n- Full occupancy on the $\\mathrm{A}$ site:\n$$\nx_{\\mathrm{Sr}} + x_{\\mathrm{La}} = 1.\n$$\n- Charge neutrality using fixed $\\mathrm{Fe}^{3+}$, mixed $\\mathrm{Sr}^{2+}$ and $\\mathrm{La}^{3+}$ on the $\\mathrm{A}$ site, and three oxygen sites of occupancy $x_{\\mathrm{O}}$ each carrying charge $-2$:\n$$\n2\\,x_{\\mathrm{Sr}} + 3\\,x_{\\mathrm{La}} + 3 - 2 \\cdot 3 \\, x_{\\mathrm{O}} = 0 \\;\\;\\Longleftrightarrow\\;\\; 2\\,x_{\\mathrm{Sr}} + 3\\,x_{\\mathrm{La}} - 6\\,x_{\\mathrm{O}} = -3.\n$$\nStacking these constraints yields\n$$\n\\mathbf{A}_{\\mathrm{eq}} =\n\\begin{bmatrix}\n1 & 1 & 0 \\\\\n2 & 3 & -6\n\\end{bmatrix},\n\\quad\n\\mathbf{b}_{\\mathrm{eq}} =\n\\begin{bmatrix}\n1 \\\\\n-3\n\\end{bmatrix}.\n$$\n\nWe now assemble a linear system $\\mathbf{M}\\,\\mathbf{x} \\approx \\mathbf{y}$ that stacks all amplitude proxy equations:\n- For each $\\mathcal{A}$-site reflection with scale $S_{\\mathcal{A},k}$, include a row $S_{\\mathcal{A},k}\\,[\\,b_{\\mathrm{Sr}},\\, b_{\\mathrm{La}},\\, 0\\,]$.\n- For each $\\mathcal{O}$-site reflection with scale $S_{\\mathcal{O},\\ell}$, include a row $S_{\\mathcal{O},\\ell}\\,[\\,0,\\, 0,\\, b_{\\mathrm{O}}\\,]$.\n\nGiven observed amplitude proxies $\\mathbf{y}$, the constrained least-squares problem is\n$$\n\\min_{\\mathbf{x}} \\;\\; \\|\\mathbf{M}\\,\\mathbf{x} - \\mathbf{y}\\|_2^2 \\quad \\text{subject to} \\quad \\mathbf{A}_{\\mathrm{eq}}\\,\\mathbf{x} = \\mathbf{b}_{\\mathrm{eq}}.\n$$\nThe first-order optimality conditions (Karush-Kuhn-Tucker conditions) for equality constraints lead to the linear KKT system\n$$\n\\begin{bmatrix}\n\\mathbf{H} & \\mathbf{A}_{\\mathrm{eq}}^{\\mathsf{T}} \\\\\n\\mathbf{A}_{\\mathrm{eq}} & \\mathbf{0}\n\\end{bmatrix}\n\\begin{bmatrix}\n\\mathbf{x} \\\\\n\\boldsymbol{\\lambda}\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n\\mathbf{g} \\\\\n\\mathbf{b}_{\\mathrm{eq}}\n\\end{bmatrix},\n\\quad\n\\text{with} \\quad\n\\mathbf{H} = \\mathbf{M}^{\\mathsf{T}} \\mathbf{M}, \\;\\; \\mathbf{g} = \\mathbf{M}^{\\mathsf{T}} \\mathbf{y}.\n$$\nSolving this linear system yields the refined occupancies $\\mathbf{x}$ that minimize the residual under the constraints. This approach is robust because $\\mathbf{H}$ is positive semidefinite and the constraints couple the otherwise block-diagonal normal equations, resulting in a nonsingular KKT matrix under the given data.\n\nWe now apply this to the provided test suite.\n\nConstants:\n- $b_{\\mathrm{Sr}} = 7.02$,\n- $b_{\\mathrm{La}} = 8.24$,\n- $b_{\\mathrm{O}} = 5.803$,\n- $S_{\\mathcal{A}} = \\big[\\,1.0,\\, 0.8,\\, 1.2\\,\\big]$,\n- $S_{\\mathcal{O}} = \\big[\\,1.0,\\, 0.9\\,\\big]$.\n\nFor each case, we form $\\mathbf{M}$ with five rows:\n$$\n\\mathbf{M} =\n\\begin{bmatrix}\n1.0\\,b_{\\mathrm{Sr}} & 1.0\\,b_{\\mathrm{La}} & 0 \\\\\n0.8\\,b_{\\mathrm{Sr}} & 0.8\\,b_{\\mathrm{La}} & 0 \\\\\n1.2\\,b_{\\mathrm{Sr}} & 1.2\\,b_{\\mathrm{La}} & 0 \\\\\n0 & 0 & 1.0\\,b_{\\mathrm{O}} \\\\\n0 & 0 & 0.9\\,b_{\\mathrm{O}}\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n7.02 & 8.24 & 0 \\\\\n5.616 & 6.592 & 0 \\\\\n8.424 & 9.888 & 0 \\\\\n0 & 0 & 5.803 \\\\\n0 & 0 & 5.2227\n\\end{bmatrix}.\n$$\nWe then solve the KKT system for each $\\mathbf{y}$ corresponding to the observed amplitudes.\n\nBecause the observations were generated exactly from the physical model and constraints, the constrained least-squares solution recovers the ground-truth occupancies to within numerical precision. The refined results (rounded to six decimal places) are:\n- Case $1$: $\\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big] = \\big[0.400000,\\, 0.600000,\\, 0.933333\\big]$.\n- Case $2$: $\\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big] = \\big[1.000000,\\, 0.000000,\\, 0.833333\\big]$.\n- Case $3$: $\\big[x_{\\mathrm{Sr}},\\, x_{\\mathrm{La}},\\, x_{\\mathrm{O}}\\big] = \\big[0.000000,\\, 1.000000,\\, 1.000000\\big]$.\n\nAlgorithmic steps for the program:\n1. Define constants $b_{\\mathrm{Sr}}$, $b_{\\mathrm{La}}$, $b_{\\mathrm{O}}$, $S_{\\mathcal{A}}$, and $S_{\\mathcal{O}}$.\n2. For each test case, assemble $\\mathbf{M}$ using the scale factors and scattering lengths, and set $\\mathbf{y}$ from the provided observed amplitudes.\n3. Form $\\mathbf{H} = \\mathbf{M}^{\\mathsf{T}}\\mathbf{M}$ and $\\mathbf{g} = \\mathbf{M}^{\\mathsf{T}}\\mathbf{y}$.\n4. Assemble the KKT matrix and right-hand side and solve for $\\mathbf{x}$.\n5. Round $\\mathbf{x}$ to six decimal places and collect across cases.\n6. Print the aggregated list in the exact format specified.\n\nThe program will output:\n$$\n\\big[\\,[0.4,0.6,0.933333],[1.0,0.0,0.833333],[0.0,1.0,1.0]\\,\\big],\n$$\nwith each entry rounded to six decimal places and formatted without spaces as required.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve_case(yA, yO, b_Sr, b_La, b_O, SA, SO):\n    \"\"\"\n    Solve the constrained least squares:\n        minimize || M x - y ||^2\n    subject to A_eq x = b_eq,\n    using the KKT system formulation.\n    \"\"\"\n    # Build M matrix\n    # Rows for A-site dominated reflections\n    MA = np.array([[SA[0] * b_Sr, SA[0] * b_La, 0.0],\n                   [SA[1] * b_Sr, SA[1] * b_La, 0.0],\n                   [SA[2] * b_Sr, SA[2] * b_La, 0.0]], dtype=float)\n    # Rows for O-site dominated reflections\n    MO = np.array([[0.0, 0.0, SO[0] * b_O],\n                   [0.0, 0.0, SO[1] * b_O]], dtype=float)\n    M = np.vstack([MA, MO])\n\n    # Observed y vector\n    y = np.concatenate([np.array(yA, dtype=float), np.array(yO, dtype=float)])\n\n    # Constraint matrices\n    Aeq = np.array([[1.0, 1.0, 0.0],\n                    [2.0, 3.0, -6.0]], dtype=float)\n    beq = np.array([1.0, -3.0], dtype=float)\n\n    # Form KKT system\n    H = M.T @ M\n    g = M.T @ y\n\n    # KKT matrix and rhs\n    KKT = np.block([\n        [H, Aeq.T],\n        [Aeq, np.zeros((Aeq.shape[0], Aeq.shape[0]))]\n    ])\n    rhs = np.concatenate([g, beq])\n\n    # Solve KKT system\n    sol = np.linalg.solve(KKT, rhs)\n    x = sol[:3]\n    return x\n\ndef main():\n    # Constants (neutron coherent scattering lengths in fm)\n    b_Sr = 7.02\n    b_La = 8.24\n    b_O = 5.803\n\n    # Scale factors\n    SA = [1.0, 0.8, 1.2]\n    SO = [1.0, 0.9]\n\n    # Test cases: observed amplitude proxies\n    # Case 1\n    yA1 = [7.752, 6.2016, 9.3024]\n    yO1 = [5.416133333333333, 4.87452]\n    # Case 2\n    yA2 = [7.02, 5.616, 8.424]\n    yO2 = [4.835833333333333, 4.35225]\n    # Case 3\n    yA3 = [8.24, 6.592, 9.888]\n    yO3 = [5.803, 5.2227]\n\n    test_cases = [\n        (yA1, yO1),\n        (yA2, yO2),\n        (yA3, yO3),\n    ]\n\n    results = []\n    for yA, yO in test_cases:\n        x = solve_case(yA, yO, b_Sr, b_La, b_O, SA, SO)\n        results.append(x)\n\n    # Final print statement in the exact required format: no spaces\n    case_strings = [f\"[{','.join([f'{v:.6f}' for v in res])}]\" for res in results]\n    print(f\"[{','.join(case_strings)}]\")\n\nif __name__ == \"__main__\":\n    main()\n```", "id": "2517932"}, {"introduction": "A primary application of Rietveld refinement is quantitative phase analysis (QPA), the determination of the weight fractions of different crystalline phases in a mixture. However, simply relating diffraction intensity to phase amount can be misleading due to sample-dependent physical effects that bias the measured intensities. This exercise [@problem_id:2517872] tackles this challenge head-on, guiding you to re-evaluate a quantitative analysis by correcting for two prevalent systematic errors: microabsorption and preferred orientation, thereby transforming raw refinement outputs into accurate, physically meaningful results.", "problem": "You are given a set of phase-quantitative results from Rietveld refinement along with physical parameters needed to reassess two common sources of systematic bias in quantitative phase analysis: microabsorption and preferred orientation. The aim is to re-estimate the phase fractions when alternative modeling choices are used. The problem must be solved by reasoning from first principles about diffraction intensities and attenuation, without relying on any canned formula that directly maps reported phase fractions to corrected ones.\n\nYou must assume the following foundational base:\n- The Beer–Lambert law for attenuation of X-rays, namely that intensity decays as $I = I_0 \\exp(-\\mu \\ell)$ through path length $\\ell$ with linear attenuation coefficient $\\mu$.\n- In Rietveld refinement, the refined scale factor for a phase is, to leading order, proportional to the diffracted intensity that would be obtained from the amount of that phase present in the irradiated volume.\n- Preferred orientation alters the distribution of crystallite orientations, thereby weighting certain Bragg peaks by a multiplicative factor relative to a random powder. A standard phenomenological model widely used to quantify this weighting at a Bragg angle-dependent orientation is the March–Dollase function.\n\nYou will adopt the following physically motivated, simplified intensity model:\n- Consider a phase $k$ comprising approximately spherical crystallites of radius $R_k$ (in micrometers). Let the mass attenuation coefficient be $\\mu_{m,k}$ (in cm$^2$ g$^{-1}$) and the density be $\\rho_k$ (in g cm$^{-3}$). The linear attenuation coefficient is $\\mu_k = \\mu_{m,k}\\,\\rho_k$ (in cm$^{-1}$).\n- A microabsorption transmission factor $T_k$ for a sphere is defined by averaging the Beer–Lambert attenuation over rays through a sphere of radius $R_k$:\n$$\nT_k(x_k) = \\frac{1 - e^{-x_k}}{x_k}, \\quad \\text{with } x_k = 2 \\mu_k R_k^{(\\mathrm{cm})}, \\quad R_k^{(\\mathrm{cm})} = R_k^{(\\mu \\mathrm{m})} \\times 10^{-4}.\n$$\n- A preferred orientation intensity multiplier for a phase $k$ is approximated by a single effective March–Dollase factor\n$$\nP_k(r_k,\\theta_k) = \\left(r_k^2 \\cos^2 \\theta_k + r_k^{-1} \\sin^2 \\theta_k\\right)^{-3/2},\n$$\nwhere $r_k$ is the March–Dollase parameter and $\\theta_k$ is an effective angle, both taken as given for each phase; $\\theta_k$ must be treated in degrees in the input but used in radians in calculations.\n\nFor a published analysis that reported phase fractions $\\{w_{k}^{(\\mathrm{pub})}\\}_k$ under the modeling choice that neglected both microabsorption and preferred orientation, you are to re-estimate the fractions under alternative modeling choices. Treat the Rietveld scale factors as proportional to the published fractions when both microabsorption and preferred orientation were neglected. Then, by first-principles reasoning, derive how the microabsorption transmission factors $\\{T_k\\}$ and preferred orientation multipliers $\\{P_k\\}$ alter the conversion between scale factor and actual phase fraction. Implement this logic to compute corrected fractions for specified modeling choices.\n\nAngles must be interpreted in degrees in the input parameters and converted to radians for trigonometric functions. Physical units must be used as specified: $\\mu_m$ in cm$^2$ g$^{-1}$, $\\rho$ in g cm$^{-3}$, and $R$ in $\\mu$m, with internal conversion of $R$ to cm. Final phase fractions are unitless and must be expressed as decimals.\n\nTest suite and required outputs:\n- For each test case, you are given:\n  - Published phase fractions $w^{(\\mathrm{pub})}$ as a list that sums to $1$.\n  - Per-phase arrays of the same length for $\\mu_m$, $\\rho$, $R$ (in $\\mu$m), $r$, and $\\theta$ (in degrees).\n  - A modeling choice flag taking one of the values in the set $\\{\\text{\"none\"}, \\text{\"microabsorption\"}, \\text{\"texture\"}, \\text{\"both\"}\\}$ indicating which corrections to apply in recomputing the fractions.\n- Your program must compute corrected fractions for each test case and return each result as a list of floats, each rounded to $6$ decimal places, such that the list sums to $1$ within rounding tolerance. Fractions must be decimals (not percentages).\n\nThe test suite consists of the following $7$ cases, all framed for X-ray radiation at a fixed wavelength where the given $\\mu_m$ values are applicable:\n- Case $1$ (sanity, three-phase sample $S1$, no corrections):\n  - $w^{(\\mathrm{pub})} = [0.5, 0.3, 0.2]$\n  - $\\mu_m = [260, 53, 48]$ cm$^2$ g$^{-1}$\n  - $\\rho = [5.24, 3.98, 2.65]$ g cm$^{-3}$\n  - $R = [10, 5, 3]$ $\\mu$m\n  - $r = [0.9, 1.1, 1.0]$\n  - $\\theta = [30, 45, 0]$ degrees\n  - modeling choice: \"none\"\n- Case $2$ (same $S1$, microabsorption only):\n  - same parameters as Case $1$\n  - modeling choice: \"microabsorption\"\n- Case $3$ (same $S1$, preferred orientation only):\n  - same parameters as Case $1$\n  - modeling choice: \"texture\"\n- Case $4$ (same $S1$, both corrections):\n  - same parameters as Case $1$\n  - modeling choice: \"both\"\n- Case $5$ (two-phase sample $S2$, negligible microabsorption, microabsorption only):\n  - $w^{(\\mathrm{pub})} = [0.6, 0.4]$\n  - $\\mu_m = [50, 60]$ cm$^2$ g$^{-1}$\n  - $\\rho = [3.0, 3.0]$ g cm$^{-3}$\n  - $R = [1.0, 1.0]$ $\\mu$m\n  - $r = [2.0, 1.0]$\n  - $\\theta = [10, 0]$ degrees\n  - modeling choice: \"microabsorption\"\n- Case $6$ (same $S2$, strong texture only):\n  - same parameters as Case $5$\n  - modeling choice: \"texture\"\n- Case $7$ (two-phase sample $S3$, strong microabsorption contrast, microabsorption only):\n  - $w^{(\\mathrm{pub})} = [0.7, 0.3]$\n  - $\\mu_m = [300, 30]$ cm$^2$ g$^{-1}$\n  - $\\rho = [7.2, 2.5]$ g cm$^{-3}$\n  - $R = [15.0, 2.0]$ $\\mu$m\n  - $r = [1.0, 1.0]$\n  - $\\theta = [0, 0]$ degrees\n  - modeling choice: \"microabsorption\"\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is the list of corrected fractions for one test case in the order above, with each fraction rounded to $6$ decimal places. For example, a syntactically correct output would look like $[[0.1,0.9],[0.2,0.8]]$ for two hypothetical cases. No additional text or characters are permitted in the output line.", "solution": "The problem as stated is valid. It is scientifically grounded in the principles of X-ray diffraction and quantitative phase analysis, well-posed, and contains all necessary information for a unique solution. The simplified models for microabsorption and preferred orientation are standard approximations in the field. We shall proceed with a solution derived from first principles.\n\nThe objective is to re-estimate quantitative phase analysis results, $\\{w_k^{(\\mathrm{pub})}\\}_k$, by applying corrections for microabsorption and preferred orientation that were initially neglected. The foundation of this re-estimation lies in the relationship between the true weight fraction of a phase, $w_k$, and the intensity it contributes to the diffraction pattern, $I_k$.\n\nIn a powder diffraction experiment, the intensity measured for a reflection from phase $k$, $I_k^{(\\mathrm{meas})}$, is proportional to its true weight fraction $w_k$. However, this relationship is modulated by several physical effects, including microabsorption and preferred orientation (texture). We can express this as:\n$$I_k^{(\\mathrm{meas})} \\propto w_k \\cdot T_k \\cdot P_k$$\nHere, $T_k$ is the microabsorption transmission factor and $P_k$ is the preferred orientation (texture) factor for phase $k$. The proportionality constant absorbs instrumental factors and intrinsic scattering properties of the phase, which are constant for all phases in the analysis.\n\nThe problem states that the published weight fractions, $w_k^{(\\mathrm{pub})}$, were obtained from an analysis that neglected both microabsorption and preferred orientation. This is equivalent to assuming that $T_k = 1$ and $P_k = 1$ for all phases. Under such an assumption, the measured intensity is taken to be directly proportional to the weight fraction:\n$$I_k^{(\\mathrm{meas})} \\propto w_k^{(\\mathrm{pub})}$$\n\nBy equating these two proportionalities, we establish the core relationship between the true weight fractions and the published, uncorrected ones:\n$$w_k^{(\\mathrm{pub})} \\propto w_k \\cdot T_k \\cdot P_k$$\nFrom this, we can solve for the true weight fraction, $w_k$, which we will denote as $w_k^{(\\mathrm{corr})}$ to signify the corrected value. We find that $w_k^{(\\mathrm{corr})}$ is proportional to the published fraction divided by the correction factors:\n$$w_k^{(\\mathrm{corr})} \\propto \\frac{w_k^{(\\mathrm{pub})}}{T_k \\cdot P_k}$$\nLet us define an un-normalized corrected weight fraction, $w_k'$, as:\n$$w_k' = \\frac{w_k^{(\\mathrm{pub})}}{T_k \\cdot P_k}$$\nSince the sum of all weight fractions in the sample must equal unity, we must re-normalize these values:\n$$w_k^{(\\mathrm{corr})} = \\frac{w_k'}{\\sum_j w_j'} = \\frac{w_k^{(\\mathrm{pub})} / (T_k \\cdot P_k)}{\\sum_j \\left( w_j^{(\\mathrm{pub})} / (T_j \\cdot P_j) \\right)}$$\nThis is the final equation we will implement. The values of $T_k$ and $P_k$ are determined by the `modeling_choice` flag. If a correction is not applied, the corresponding factor remains $1$.\n\nThe specific models for the correction factors are provided.\n\nFor microabsorption, the transmission factor $T_k$ for a spherical crystallite is:\n$$T_k(x_k) = \\frac{1 - e^{-x_k}}{x_k}$$\nwhere the dimensionless parameter $x_k$ is given by $x_k = 2 \\mu_k R_k^{(\\mathrm{cm})}$. The linear attenuation coefficient $\\mu_k$ (in cm$^{-1}$) is calculated from the given mass attenuation coefficient $\\mu_{m,k}$ (in cm$^2$ g$^{-1}$) and density $\\rho_k$ (in g cm$^{-3}$) as $\\mu_k = \\mu_{m,k} \\rho_k$. The crystallite radius $R_k$, given in micrometers ($\\mu$m), must be converted to centimeters (cm) using $R_k^{(\\mathrm{cm})} = R_k^{(\\mu \\mathrm{m})} \\times 10^{-4}$.\n\nFor preferred orientation, the intensity multiplier $P_k$ is modeled by the March–Dollase function:\n$$P_k(r_k, \\theta_k) = \\left(r_k^2 \\cos^2 \\theta_k + r_k^{-1} \\sin^2 \\theta_k\\right)^{-3/2}$$\nHere, $r_k$ is the March–Dollase parameter and $\\theta_k$ is an effective angle. The angle $\\theta_k$ is provided in degrees and must be converted to radians for use in trigonometric functions, via $\\theta_k^{(\\mathrm{rad})} = \\theta_k^{(\\mathrm{deg})} \\frac{\\pi}{180}$. A value of $r_k = 1$ indicates no preferred orientation, which results in $P_k=1$ for any angle $\\theta_k$.\n\nThe algorithm for each test case is as follows:\n1.  For each phase $k$ in the mixture, initialize correction factors $T_k \\leftarrow 1$ and $P_k \\leftarrow 1$.\n2.  Based on the `modeling_choice`, calculate the necessary correction factors.\n    - If `modeling_choice` is `\"microabsorption\"` or `\"both\"`, calculate each $T_k$ using the formula provided. Special care is taken for the case $x_k \\to 0$, where the limit of $T_k$ is $1$.\n    - If `modeling_choice` is `\"texture\"` or `\"both\"`, calculate each $P_k$ using the March–Dollase formula.\n3.  Compute the un-normalized corrected weight fraction $w_k'$ for each phase using $w_k' = w_k^{(\\mathrm{pub})} / (T_k \\cdot P_k)$.\n4.  Sum the un-normalized fractions: $W' = \\sum_j w_j'$.\n5.  Compute the final, normalized corrected weight fractions: $w_k^{(\\mathrm{corr})} = w_k' / W'$.\n6.  The final results are rounded to the specified precision of $6$ decimal places.\nThis procedure rigorously applies the physical correction models, derived from first principles, to re-evaluate the initial quantitative analysis.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the Rietveld quantitative phase analysis correction problem\n    for a given suite of test cases.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (sanity, three-phase sample S1, no corrections)\n        {\n            \"w_pub\": [0.5, 0.3, 0.2],\n            \"mu_m\": [260, 53, 48],\n            \"rho\": [5.24, 3.98, 2.65],\n            \"R\": [10, 5, 3],\n            \"r\": [0.9, 1.1, 1.0],\n            \"theta\": [30, 45, 0],\n            \"choice\": \"none\",\n        },\n        # Case 2 (same S1, microabsorption only)\n        {\n            \"w_pub\": [0.5, 0.3, 0.2],\n            \"mu_m\": [260, 53, 48],\n            \"rho\": [5.24, 3.98, 2.65],\n            \"R\": [10, 5, 3],\n            \"r\": [0.9, 1.1, 1.0],\n            \"theta\": [30, 45, 0],\n            \"choice\": \"microabsorption\",\n        },\n        # Case 3 (same S1, preferred orientation only)\n        {\n            \"w_pub\": [0.5, 0.3, 0.2],\n            \"mu_m\": [260, 53, 48],\n            \"rho\": [5.24, 3.98, 2.65],\n            \"R\": [10, 5, 3],\n            \"r\": [0.9, 1.1, 1.0],\n            \"theta\": [30, 45, 0],\n            \"choice\": \"texture\",\n        },\n        # Case 4 (same S1, both corrections)\n        {\n            \"w_pub\": [0.5, 0.3, 0.2],\n            \"mu_m\": [260, 53, 48],\n            \"rho\": [5.24, 3.98, 2.65],\n            \"R\": [10, 5, 3],\n            \"r\": [0.9, 1.1, 1.0],\n            \"theta\": [30, 45, 0],\n            \"choice\": \"both\",\n        },\n        # Case 5 (two-phase sample S2, negligible microabsorption, microabsorption only)\n        {\n            \"w_pub\": [0.6, 0.4],\n            \"mu_m\": [50, 60],\n            \"rho\": [3.0, 3.0],\n            \"R\": [1.0, 1.0],\n            \"r\": [2.0, 1.0],\n            \"theta\": [10, 0],\n            \"choice\": \"microabsorption\",\n        },\n        # Case 6 (same S2, strong texture only)\n        {\n            \"w_pub\": [0.6, 0.4],\n            \"mu_m\": [50, 60],\n            \"rho\": [3.0, 3.0],\n            \"R\": [1.0, 1.0],\n            \"r\": [2.0, 1.0],\n            \"theta\": [10, 0],\n            \"choice\": \"texture\",\n        },\n        # Case 7 (two-phase sample S3, strong microabsorption contrast, microabsorption only)\n        {\n            \"w_pub\": [0.7, 0.3],\n            \"mu_m\": [300, 30],\n            \"rho\": [7.2, 2.5],\n            \"R\": [15.0, 2.0],\n            \"r\": [1.0, 1.0],\n            \"theta\": [0, 0],\n            \"choice\": \"microabsorption\",\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        w_pub = np.array(case[\"w_pub\"])\n        mu_m = np.array(case[\"mu_m\"])\n        rho = np.array(case[\"rho\"])\n        R_micron = np.array(case[\"R\"])\n        r = np.array(case[\"r\"])\n        theta_deg = np.array(case[\"theta\"])\n        choice = case[\"choice\"]\n        \n        num_phases = len(w_pub)\n        T_factors = np.ones(num_phases)\n        P_factors = np.ones(num_phases)\n\n        if choice in [\"microabsorption\", \"both\"]:\n            mu = mu_m * rho                  # Linear attenuation coefficient in cm^-1\n            R_cm = R_micron * 1e-4           # Radius in cm\n            x = 2 * mu * R_cm\n            \n            # Avoid division by zero for x_k=0, where lim T_k = 1.\n            # Using np.where to handle vectorization properly.\n            T_factors = np.where(x == 0, 1.0, (1.0 - np.exp(-x)) / x)\n\n        if choice in [\"texture\", \"both\"]:\n            theta_rad = np.deg2rad(theta_deg)\n            cos2_theta = np.cos(theta_rad)**2\n            sin2_theta = np.sin(theta_rad)**2\n            \n            # March-Dollase term\n            term = r**2 * cos2_theta + r**(-1) * sin2_theta\n            P_factors = term**(-1.5)\n\n        # Calculate un-normalized corrected weight fractions\n        w_prime = w_pub / (T_factors * P_factors)\n        \n        # Normalize to get final corrected weight fractions\n        w_corr = w_prime / np.sum(w_prime)\n        \n        # Round and format\n        rounded_w_corr = np.round(w_corr, 6).tolist()\n        results.append(rounded_w_corr)\n\n    # Print in the exact required format, removing spaces from list string representation\n    print(f\"[{','.join(map(str, results))}]\".replace(\" \", \"\"))\n\nsolve()\n```", "id": "2517872"}]}