{"hands_on_practices": [{"introduction": "The success of an umbrella sampling simulation hinges on the careful placement of biasing windows along the reaction coordinate. Sufficient statistical overlap between adjacent windows is crucial for accurately reconstructing the free energy profile. This exercise [@problem_id:2772126] moves beyond heuristic guidelines by tasking you with a first-principles derivation of the optimal window spacing, connecting a quantitative measure of overlap—the Bhattacharyya coefficient—to the physical properties of the system and the strength of the bias. Mastering this calculation provides a rigorous foundation for designing efficient and reliable umbrella sampling studies.", "problem": "Consider a one-dimensional reaction coordinate $\\xi$ with an underlying unbiased potential of mean force (PMF) $W(\\xi)$ that is locally harmonic in the region of interest, $W(\\xi) \\approx \\frac{1}{2}\\kappa(\\xi-\\xi^{\\ast})^{2}$, where $\\kappa0$ is a constant curvature and $\\xi^{\\ast}$ is a fixed reference position. You plan to perform umbrella sampling using a family of harmonic biasing potentials $U_{i}(\\xi)=\\frac{1}{2}k(\\xi-\\xi_{i})^{2}$, where all windows share the same force constant $k0$ and their centers are uniformly spaced, $\\xi_{i+1}-\\xi_{i}=\\Delta$. The system is at temperature $T$, and all energies are molar (per mole). Assume canonical equilibrium within each umbrella window and that the harmonic approximation for $W(\\xi)$ holds across adjacent windows.\n\nDefine the statistical overlap between any two neighboring biased ensembles $i$ and $i+1$ by the Bhattacharyya coefficient $\\mathrm{BC}_{i,i+1}$,\n$$\n\\mathrm{BC}_{i,i+1} \\equiv \\int_{-\\infty}^{\\infty}\\sqrt{p_{i}(\\xi)\\,p_{i+1}(\\xi)}\\,d\\xi,\n$$\nwhere $p_{i}(\\xi)\\propto \\exp\\!\\big(-\\beta\\,[W(\\xi)+U_{i}(\\xi)]\\big)$ is the equilibrium probability density in window $i$ and $\\beta = (R T)^{-1}$ with $R$ the universal gas constant expressed in $\\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}$.\n\nStarting only from the Boltzmann distribution, the harmonic forms of $W(\\xi)$ and $U_{i}(\\xi)$, and the above definition of $\\mathrm{BC}_{i,i+1}$, derive an analytic expression for the window spacing $\\Delta$ that achieves a target overlap $\\mathrm{BC}_{i,i+1}=1/2$. Then evaluate the spacing for the following parameters:\n- $k = 10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}$,\n- $\\kappa = 2.00\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}$,\n- $T = 300.0\\ \\mathrm{K}$,\n- $R = 8.314462618\\times 10^{-3}\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}$.\n\nRound your final numerical result for $\\Delta$ to four significant figures and express it in nanometers.", "solution": "The problem is subjected to validation and is found to be scientifically grounded, well-posed, and self-contained. The provided data are sufficient and consistent for deriving a unique solution. We proceed with the derivation.\n\nThe objective is to derive an expression for the window spacing, $\\Delta$, that results in a statistical overlap of $\\mathrm{BC}_{i,i+1} = 1/2$ between adjacent umbrella sampling windows, and then to compute its numerical value.\n\nFirst, we characterize the equilibrium probability density, $p_{i}(\\xi)$, for a system in the $i$-th umbrella window. The total potential energy experienced by the system in this window is the sum of the unbiased potential of mean force, $W(\\xi)$, and the biasing potential, $U_i(\\xi)$.\n$$\nV_{i}(\\xi) = W(\\xi) + U_{i}(\\xi)\n$$\nGiven the harmonic approximations for $W(\\xi)$ and $U_i(\\xi)$:\n$$\nV_{i}(\\xi) = \\frac{1}{2}\\kappa(\\xi-\\xi^{\\ast})^{2} + \\frac{1}{2}k(\\xi-\\xi_{i})^{2}\n$$\nwhere $\\kappa$ and $k$ are force constants, $\\xi^{\\ast}$ is the minimum of the unbiased PMF, and $\\xi_i$ is the center of the $i$-th biasing potential. We expand the quadratic terms:\n$$\nV_{i}(\\xi) = \\frac{1}{2}\\kappa(\\xi^2 - 2\\xi\\xi^{\\ast} + (\\xi^{\\ast})^2) + \\frac{1}{2}k(\\xi^2 - 2\\xi\\xi_i + \\xi_i^2)\n$$\n$$\nV_{i}(\\xi) = \\frac{1}{2}(\\kappa+k)\\xi^2 - (\\kappa\\xi^{\\ast} + k\\xi_i)\\xi + \\frac{1}{2}(\\kappa(\\xi^{\\ast})^2 + k\\xi_i^2)\n$$\nThis expression is a quadratic function of $\\xi$, which can be rewritten in a standard harmonic form by completing the square.\n$$\nV_{i}(\\xi) = \\frac{1}{2}(\\kappa+k)\\left(\\xi - \\frac{\\kappa\\xi^{\\ast} + k\\xi_i}{\\kappa+k}\\right)^2 + C_i\n$$\nwhere $C_i$ is a constant term that does not depend on the coordinate $\\xi$. The total potential in each window is thus harmonic with a combined force constant $k_{tot} = \\kappa+k$ and a minimum located at:\n$$\n\\mu_i = \\frac{\\kappa\\xi^{\\ast} + k\\xi_i}{\\kappa+k}\n$$\nThe equilibrium probability density $p_i(\\xi)$ follows the Boltzmann distribution, $p_i(\\xi) \\propto \\exp(-\\beta V_i(\\xi))$, where $\\beta = (RT)^{-1}$. Since $V_i(\\xi)$ is quadratic in $\\xi$, $p_i(\\xi)$ is a Gaussian (normal) distribution:\n$$\np_{i}(\\xi) = \\mathcal{N}(\\xi | \\mu_i, \\sigma_{tot}^2) = \\frac{1}{\\sqrt{2\\pi\\sigma_{tot}^2}}\\exp\\left(-\\frac{(\\xi-\\mu_i)^2}{2\\sigma_{tot}^2}\\right)\n$$\nThe variance $\\sigma_{tot}^2$ is the same for all windows and is given by:\n$$\n\\sigma_{tot}^2 = \\frac{1}{\\beta k_{tot}} = \\frac{1}{\\beta(\\kappa+k)} = \\frac{RT}{\\kappa+k}\n$$\nNext, we evaluate the Bhattacharyya coefficient, $\\mathrm{BC}_{i,i+1}$, between two adjacent windows, $i$ and $i+1$.\n$$\n\\mathrm{BC}_{i,i+1} = \\int_{-\\infty}^{\\infty}\\sqrt{p_{i}(\\xi)\\,p_{i+1}(\\xi)}\\,d\\xi\n$$\nThe integrand involves the geometric mean of two Gaussian densities with the same variance $\\sigma_{tot}^2$ but different means $\\mu_i$ and $\\mu_{i+1}$.\n$$\n\\sqrt{p_{i}(\\xi)p_{i+1}(\\xi)} = \\sqrt{\\frac{1}{2\\pi\\sigma_{tot}^2}\\exp\\left(-\\frac{(\\xi-\\mu_i)^2}{2\\sigma_{tot}^2}\\right)\\exp\\left(-\\frac{(\\xi-\\mu_{i+1})^2}{2\\sigma_{tot}^2}\\right)}\n$$\n$$\n= \\frac{1}{\\sqrt{2\\pi\\sigma_{tot}^2}}\\exp\\left(-\\frac{(\\xi-\\mu_i)^2 + (\\xi-\\mu_{i+1})^2}{4\\sigma_{tot}^2}\\right)\n$$\nThe exponent's numerator can be rearranged:\n$$\n(\\xi-\\mu_i)^2 + (\\xi-\\mu_{i+1})^2 = 2\\xi^2 - 2\\xi(\\mu_i+\\mu_{i+1}) + \\mu_i^2+\\mu_{i+1}^2 = 2\\left(\\xi-\\frac{\\mu_i+\\mu_{i+1}}{2}\\right)^2 + \\frac{1}{2}(\\mu_i-\\mu_{i+1})^2\n$$\nSubstituting this back into the expression for the geometric mean:\n$$\n\\sqrt{p_{i}(\\xi)p_{i+1}(\\xi)} = \\frac{1}{\\sqrt{2\\pi\\sigma_{tot}^2}}\\exp\\left(-\\frac{2\\left(\\xi-\\frac{\\mu_i+\\mu_{i+1}}{2}\\right)^2 + \\frac{1}{2}(\\mu_i-\\mu_{i+1})^2}{4\\sigma_{tot}^2}\\right)\n$$\n$$\n= \\exp\\left(-\\frac{(\\mu_i-\\mu_{i+1})^2}{8\\sigma_{tot}^2}\\right) \\frac{1}{\\sqrt{2\\pi\\sigma_{tot}^2}}\\exp\\left(-\\frac{\\left(\\xi-\\frac{\\mu_i+\\mu_{i+1}}{2}\\right)^2}{2\\sigma_{tot}^2}\\right)\n$$\nNow we integrate over $\\xi$ to obtain $\\mathrm{BC}_{i,i+1}$:\n$$\n\\mathrm{BC}_{i,i+1} = \\exp\\left(-\\frac{(\\mu_i-\\mu_{i+1})^2}{8\\sigma_{tot}^2}\\right) \\int_{-\\infty}^{\\infty} \\frac{1}{\\sqrt{2\\pi\\sigma_{tot}^2}}\\exp\\left(-\\frac{\\left(\\xi-\\frac{\\mu_i+\\mu_{i+1}}{2}\\right)^2}{2\\sigma_{tot}^2}\\right)d\\xi\n$$\nThe integral is of a normalized Gaussian probability density over its entire domain, which equals $1$. Therefore:\n$$\n\\mathrm{BC}_{i,i+1} = \\exp\\left(-\\frac{(\\mu_i-\\mu_{i+1})^2}{8\\sigma_{tot}^2}\\right)\n$$\nThe difference between the means of adjacent distributions is:\n$$\n\\mu_{i+1} - \\mu_i = \\frac{\\kappa\\xi^{\\ast} + k\\xi_{i+1}}{\\kappa+k} - \\frac{\\kappa\\xi^{\\ast} + k\\xi_i}{\\kappa+k} = \\frac{k(\\xi_{i+1}-\\xi_i)}{\\kappa+k} = \\frac{k\\Delta}{\\kappa+k}\n$$\nSubstituting the expressions for $(\\mu_{i+1}-\\mu_i)^2$ and $\\sigma_{tot}^2$ into the formula for $\\mathrm{BC}_{i,i+1}$:\n$$\n\\mathrm{BC}_{i,i+1} = \\exp\\left(-\\frac{1}{8} \\left(\\frac{k\\Delta}{\\kappa+k}\\right)^2 \\frac{1}{\\sigma_{tot}^2}\\right) = \\exp\\left(-\\frac{k^2\\Delta^2}{8(\\kappa+k)^2} \\beta(\\kappa+k)\\right)\n$$\n$$\n\\mathrm{BC}_{i,i+1} = \\exp\\left(-\\frac{\\beta k^2 \\Delta^2}{8(\\kappa+k)}\\right)\n$$\nWe are given the condition that the overlap must be $\\mathrm{BC}_{i,i+1} = 1/2$.\n$$\n\\frac{1}{2} = \\exp\\left(-\\frac{\\beta k^2 \\Delta^2}{8(\\kappa+k)}\\right)\n$$\nTaking the natural logarithm of both sides:\n$$\n\\ln\\left(\\frac{1}{2}\\right) = -\\ln(2) = -\\frac{\\beta k^2 \\Delta^2}{8(\\kappa+k)}\n$$\n$$\n\\ln(2) = \\frac{\\beta k^2 \\Delta^2}{8(\\kappa+k)}\n$$\nWe can now solve for $\\Delta^2$:\n$$\n\\Delta^2 = \\frac{8(\\kappa+k)\\ln(2)}{\\beta k^2}\n$$\nSubstituting $\\beta = (RT)^{-1}$, we obtain the final analytical expression for the window spacing $\\Delta$:\n$$\n\\Delta = \\sqrt{\\frac{8RT(\\kappa+k)\\ln(2)}{k^2}} = \\frac{\\sqrt{8RT(\\kappa+k)\\ln(2)}}{k}\n$$\nFinally, we substitute the given numerical values:\n$k = 10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}$\n$\\kappa = 2.00\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}$\n$T = 300.0\\ \\mathrm{K}$\n$R = 8.314462618\\times 10^{-3}\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}$\n\nFirst, calculate the product $RT$:\n$RT = (8.314462618\\times 10^{-3}\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{K}^{-1}) \\times (300.0\\ \\mathrm{K}) = 2.4943387854\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}$\nNext, calculate the term $\\kappa+k$:\n$\\kappa+k = 2.00\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2} + 10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2} = 12.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}$\nNow, substitute these into the expression for $\\Delta$:\n$$\n\\Delta = \\frac{\\sqrt{8 \\times (2.4943387854\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}) \\times (12.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}) \\times \\ln(2)}}{10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}}\n$$\n$$\n\\Delta = \\frac{\\sqrt{239.456523398\\ \\mathrm{kJ}^2\\ \\mathrm{mol}^{-2}\\ \\mathrm{nm}^{-2} \\times \\ln(2)}}{10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}}\n$$\n$$\n\\Delta = \\frac{\\sqrt{165.9868065\\ \\mathrm{kJ}^2\\ \\mathrm{mol}^{-2}\\ \\mathrm{nm}^{-2}}}{10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}}\n$$\n$$\n\\Delta = \\frac{12.8835959\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-1}}{10.0\\ \\mathrm{kJ}\\ \\mathrm{mol}^{-1}\\ \\mathrm{nm}^{-2}} = 1.28835959\\ \\mathrm{nm}\n$$\nRounding to four significant figures as requested gives:\n$$\n\\Delta \\approx 1.288\\ \\mathrm{nm}\n$$", "answer": "$$\n\\boxed{1.288}\n$$", "id": "2772126"}, {"introduction": "Unlike the static potentials used in umbrella sampling, well-tempered metadynamics (WTmetaD) employs an adaptive bias that diminishes over time, leading to eventual convergence. The rate of convergence and the degree of sampling enhancement are controlled by a single key parameter, the bias factor $\\gamma$. This problem [@problem_id:2772131] invites you to delve into the core theory of WTmetaD, deriving the direct relationship between $\\gamma$, the effective compression of the free energy landscape, and the resulting acceleration of rare events. By solving this, you will gain a quantitative understanding of how to tune WTmetaD for maximum efficiency.", "problem": "A molecular system is characterized by a one-dimensional collective variable $s$ with an underlying reversible barrier of unbiased Helmholtz free energy height $\\Delta F_{0}$ separating two metastable basins. The system is simulated at absolute temperature $T$ under canonical ($NVT$) conditions and enhanced using Well-Tempered Metadynamics (WTmetaD), which adaptively builds a bias potential $V(s,t)$ by depositing Gaussians whose instantaneous height is attenuated according to the accumulated bias. Assume that deposition parameters are chosen to reach the stationary (asymptotic) regime where the marginal stationary distribution along $s$ is well defined and the bias grows uniformly in $s$.\n\nStarting from the canonical distribution $P(s) \\propto \\exp\\!\\left(-\\beta F(s)\\right)$ with $\\beta = 1/(k_{B} T)$, and from the defining WTmetaD property that the asymptotic bias deposition rate at $s$ is proportional to $P_{b}(s)\\exp\\!\\left(-V(s)/(k_{B}\\Delta T)\\right)$, where $P_{b}(s) \\propto \\exp\\!\\left(-\\beta(F(s)+V(s))\\right)$ is the biased stationary marginal and $\\Delta T$ is the WTmetaD tempering parameter, derive the asymptotic relation between $F(s)$ and $V(s)$ in terms of the bias factor $\\gamma \\equiv (T+\\Delta T)/T$. Then, using the Transition State Theory (TST) approximation that a rate across a barrier of height $\\Delta F$ scales as $\\exp\\!\\left(-\\beta \\Delta F\\right)$ up to a common prefactor, show how the acceleration factor $S \\equiv r(\\gamma)/r(0)$ depends on $\\gamma$, and solve for the value of $\\gamma$ required to achieve a target acceleration $S_{\\mathrm{target}}$ in terms of $\\Delta F_{0}$, $T$, and fundamental constants.\n\nFinally, evaluate this $\\gamma$ numerically for the case $\\Delta F_{0} = 40\\ \\mathrm{kJ\\, mol^{-1}}$, $T = 300\\ \\mathrm{K}$, and $S_{\\mathrm{target}} = 1.0 \\times 10^{6}$, using the universal gas constant $R = 8.314462618 \\times 10^{-3}\\ \\mathrm{kJ\\, mol^{-1}\\, K^{-1}}$. Round your final answer for $\\gamma$ to four significant figures. The final answer must be a single real number (dimensionless).", "solution": "The problem statement is scientifically grounded, well-posed, objective, and contains sufficient information for a unique solution. It is a valid problem in theoretical chemistry. We proceed with the derivation and calculation.\n\nThe problem asks for three derivations followed by a numerical calculation concerning the properties of Well-Tempered Metadynamics (WTmetaD). We will address each part in sequence.\n\nFirst, we derive the asymptotic relationship between the unbiased Helmholtz free energy $F(s)$ and the accumulated bias potential $V(s)$. In the stationary (asymptotic) regime of WTmetaD, the bias potential grows uniformly across the collective variable space $s$. This implies that the rate of bias deposition, $\\dot{V}(s,t)$, becomes independent of the collective variable $s$ and is thus a constant. The problem states that this rate is proportional to the product of the biased probability distribution $P_{b}(s)$ and an attenuation factor $\\exp(-V(s)/(k_{B}\\Delta T))$. We can write this as:\n$$\n\\dot{V}(s) \\propto P_{b}(s) \\exp\\left(-\\frac{V(s)}{k_{B}\\Delta T}\\right) = \\text{Constant}\n$$\nThe biased distribution $P_{b}(s)$ is related to the canonical probability distribution $P(s)$ by $P_{b}(s) \\propto \\exp(-\\beta(F(s)+V(s)))$, where $\\beta = 1/(k_{B}T)$. Substituting this into the rate equation gives:\n$$\n\\text{Constant} \\propto \\exp\\left(-\\beta(F(s)+V(s))\\right) \\exp\\left(-\\frac{V(s)}{k_{B}\\Delta T}\\right)\n$$\nCombining the exponential terms, we have:\n$$\n\\text{Constant} \\propto \\exp\\left(-\\beta F(s) - \\beta V(s) - \\frac{1}{k_{B}\\Delta T}V(s)\\right)\n$$\nFor this expression to be constant for all $s$, the argument of the exponential must be constant. Taking the logarithm of both sides:\n$$\n-\\beta F(s) - V(s)\\left(\\beta + \\frac{1}{k_{B}\\Delta T}\\right) = \\text{Constant}'\n$$\nWe can rewrite the coefficient of $V(s)$ using $\\beta = 1/(k_{B}T)$:\n$$\n\\beta + \\frac{1}{k_{B}\\Delta T} = \\frac{1}{k_{B}T} + \\frac{1}{k_{B}\\Delta T} = \\frac{1}{k_{B}}\\left(\\frac{\\Delta T + T}{T\\Delta T}\\right)\n$$\nThe problem defines the bias factor $\\gamma = (T+\\Delta T)/T$. From this, we have $T+\\Delta T = \\gamma T$ and $\\Delta T = (\\gamma-1)T$. Substituting these into the coefficient:\n$$\n\\frac{1}{k_{B}}\\left(\\frac{\\gamma T}{T(\\gamma-1)T}\\right) = \\frac{\\gamma}{k_{B}T(\\gamma-1)} = \\beta\\frac{\\gamma}{\\gamma-1}\n$$\nThe equation for the exponential argument thus becomes:\n$$\n-\\beta F(s) - V(s)\\left(\\beta\\frac{\\gamma}{\\gamma-1}\\right) = \\text{Constant}'\n$$\nSolving for $V(s)$, we find the asymptotic relationship:\n$$\nV(s) = -\\frac{\\gamma-1}{\\gamma}F(s) + C\n$$\nwhere $C$ is an arbitrary constant that can be set to zero by choosing an appropriate reference for the potential. This is the first required result.\n\nSecond, we derive the acceleration factor $S$. In the presence of the bias potential, the system evolves on an effective free energy surface $F_{\\text{eff}}(s) = F(s) + V(s)$. Substituting the asymptotic form of $V(s)$ (with $C=0$):\n$$\nF_{\\text{eff}}(s) = F(s) + \\left(-\\frac{\\gamma-1}{\\gamma}F(s)\\right) = F(s)\\left(1 - \\frac{\\gamma-1}{\\gamma}\\right) = F(s)\\left(\\frac{\\gamma - (\\gamma-1)}{\\gamma}\\right) = \\frac{F(s)}{\\gamma}\n$$\nThe effective free energy landscape is a compressed version of the original one. The original unbiased barrier height is $\\Delta F_{0}$. The effective barrier height on the biased surface, $\\Delta F_{\\text{eff}}$, is therefore:\n$$\n\\Delta F_{\\text{eff}} = \\frac{\\Delta F_{0}}{\\gamma}\n$$\nAccording to Transition State Theory (TST), the rate of crossing a barrier $\\Delta F$ is $r \\propto \\exp(-\\beta \\Delta F)$. The rate in the unbiased system, denoted $r(0)$, corresponds to a barrier of $\\Delta F_0$, so $r(0) \\propto \\exp(-\\beta \\Delta F_{0})$. The rate in the WTmetaD-biased system, $r(\\gamma)$, corresponds to the effective barrier $\\Delta F_{\\text{eff}}$, so $r(\\gamma) \\propto \\exp(-\\beta \\Delta F_{\\text{eff}}) = \\exp(-\\beta \\Delta F_{0}/\\gamma)$. The acceleration factor $S$ is the ratio of these rates:\n$$\nS = \\frac{r(\\gamma)}{r(0)} = \\frac{\\exp\\left(-\\beta \\frac{\\Delta F_{0}}{\\gamma}\\right)}{\\exp\\left(-\\beta \\Delta F_{0}\\right)} = \\exp\\left(-\\beta \\frac{\\Delta F_{0}}{\\gamma} + \\beta \\Delta F_{0}\\right)\n$$\n$$\nS = \\exp\\left(\\beta \\Delta F_{0}\\left(1 - \\frac{1}{\\gamma}\\right)\\right) = \\exp\\left(\\beta \\Delta F_{0}\\frac{\\gamma-1}{\\gamma}\\right)\n$$\nThis is the second required result, expressing the dependence of $S$ on $\\gamma$.\n\nThird, we solve for the value of $\\gamma$ required to achieve a target acceleration $S_{\\mathrm{target}}$. We start from the expression for $S$ and set $S=S_{\\mathrm{target}}$:\n$$\nS_{\\mathrm{target}} = \\exp\\left(\\beta \\Delta F_{0}\\frac{\\gamma-1}{\\gamma}\\right)\n$$\nTaking the natural logarithm of both sides:\n$$\n\\ln(S_{\\mathrm{target}}) = \\beta \\Delta F_{0}\\frac{\\gamma-1}{\\gamma}\n$$\nRearranging to isolate the term with $\\gamma$:\n$$\n\\frac{\\ln(S_{\\mathrm{target}})}{\\beta \\Delta F_{0}} = 1 - \\frac{1}{\\gamma}\n$$\nSolving for $1/\\gamma$:\n$$\n\\frac{1}{\\gamma} = 1 - \\frac{\\ln(S_{\\mathrm{target}})}{\\beta \\Delta F_{0}} = \\frac{\\beta \\Delta F_{0} - \\ln(S_{\\mathrm{target}})}{\\beta \\Delta F_{0}}\n$$\nFinally, inverting the expression gives $\\gamma$:\n$$\n\\gamma = \\frac{\\beta \\Delta F_{0}}{\\beta \\Delta F_{0} - \\ln(S_{\\mathrm{target}})}\n$$\nThis is the analytical expression for $\\gamma$ required to achieve the target acceleration.\n\nFinally, we evaluate this expression numerically. The given parameters are $\\Delta F_{0} = 40\\ \\mathrm{kJ\\, mol^{-1}}$, $T = 300\\ \\mathrm{K}$, $S_{\\mathrm{target}} = 1.0 \\times 10^{6}$, and $R = 8.314462618 \\times 10^{-3}\\ \\mathrm{kJ\\, mol^{-1}\\, K^{-1}}$. Since $\\Delta F_0$ is a molar quantity, we must use $\\beta = 1/(RT)$.\nFirst, we compute the dimensionless quantity $\\beta \\Delta F_{0}$:\n$$\n\\beta \\Delta F_{0} = \\frac{\\Delta F_{0}}{RT} = \\frac{40\\ \\mathrm{kJ\\, mol^{-1}}}{(8.314462618 \\times 10^{-3}\\ \\mathrm{kJ\\, mol^{-1}\\, K^{-1}}) \\times (300\\ \\mathrm{K})} \\approx 16.03636\n$$\nNext, we compute the natural logarithm of the target acceleration:\n$$\n\\ln(S_{\\mathrm{target}}) = \\ln(1.0 \\times 10^{6}) \\approx 13.81551\n$$\nNow, we substitute these values into our expression for $\\gamma$:\n$$\n\\gamma = \\frac{16.03636}{16.03636 - 13.81551} = \\frac{16.03636}{2.22085} \\approx 7.22086\n$$\nRounding this result to four significant figures as requested gives $\\gamma = 7.221$.", "answer": "$$\\boxed{7.221}$$", "id": "2772131"}, {"introduction": "Enhanced sampling simulations generate a wealth of data from multiple, biased ensembles. The final, crucial step is to combine this data to reconstruct the single, unbiased free energy surface of the underlying system. This practical coding challenge [@problem_id:2455424] guides you through the implementation of the Weighted Histogram Analysis Method (WHAM), a cornerstone algorithm for this task. By building a WHAM solver from scratch to analyze data from a model umbrella sampling experiment, you will gain an intimate, hands-on understanding of how information is optimally stitched together to reveal the true thermodynamic landscape.", "problem": "A ligand’s internal rotation around a dihedral coordinate is modeled as a one-dimensional periodic coordinate $\\theta \\in [-\\pi,\\pi)$ in radians. The ligand resides in a buried, nearly-symmetric binding pocket, which induces an unknown reduced potential of mean force $u_0(\\theta)$ in units of thermal energy $k_\\mathrm{B}T$ (dimensionless). At equilibrium without external bias, the probability density is $p_0(\\theta) \\propto \\exp\\!\\left(-u_0(\\theta)\\right)$, and the free energy profile is $F(\\theta) = -\\ln p_0(\\theta) + \\text{constant}$ in units of $k_\\mathrm{B}T$. A set of $M$ harmonic-bias experiments are carried out, each applying a bias $u_i(\\theta)$ and collecting $N_i$ independent equilibrium samples of $\\theta$ from the corresponding biased distribution $p_i(\\theta) \\propto \\exp\\!\\left(-[u_0(\\theta)+u_i(\\theta)]\\right)$. The harmonic bias is $u_i(\\theta) = \\tfrac{k}{2}\\,d(\\theta,\\theta_i)^2$ with stiffness $k$ in units of $k_\\mathrm{B}T/\\mathrm{rad}^2$, where $d(\\theta,\\theta_i)$ is the minimum-image angular distance in radians, defined by $d(\\theta,\\theta_i) = \\mathrm{wrap}(\\theta-\\theta_i)$ with $\\mathrm{wrap}(x)$ mapping $x$ into $(-\\pi,\\pi]$ by adding or subtracting multiples of $2\\pi$. For each experiment $i \\in \\{1,\\ldots,M\\}$, a histogram $h_{i,j}$ of the sampled angles is formed over $B$ uniform bins partitioning $[-\\pi,\\pi)$, indexed by $j \\in \\{0,1,\\ldots,B-1\\}$ with bin width $\\Delta\\theta = 2\\pi/B$ and bin centers $\\theta_j = -\\pi + (j+\\tfrac{1}{2})\\Delta\\theta$. The count $h_{i,j}$ is the number of samples in bin $j$ for window $i$.\n\nYour task is to estimate the unbiased free energy profile $F(\\theta_j)$ up to an additive constant from these biased histograms and then compute two scalar quantities per test case:\n- The barrier height $\\Delta F_\\mathrm{bar}$ between the two lowest minima near $\\theta \\approx 0$ and $\\theta \\approx \\pi$, defined as the maximum value of $F(\\theta)$ along the direct path from $\\theta=0$ to $\\theta=\\pi$ (i.e., $\\theta \\in [0,\\pi]$) minus the lower of the two minimum values found within the neighborhoods $\\theta \\in [-\\pi/3,\\pi/3]$ (near $\\theta \\approx 0$) and $\\theta$ satisfying $|d(\\theta,\\pi)| \\le \\pi/3$ (near $\\theta \\approx \\pi$).\n- The asymmetry $\\Delta F_\\mathrm{asym} = F_\\mathrm{min}(\\text{near } \\pi) - F_\\mathrm{min}(\\text{near } 0)$, where $F_\\mathrm{min}(\\text{near } 0)$ is the minimum of $F(\\theta)$ over $\\theta \\in [-\\pi/3,\\pi/3]$, and $F_\\mathrm{min}(\\text{near } \\pi)$ is the minimum of $F(\\theta)$ over angles that satisfy $|d(\\theta,\\pi)| \\le \\pi/3$.\n\nAngles must be handled in radians. Energies and free energies must be treated in units of $k_\\mathrm{B}T$ (dimensionless). The final reported scalar results are dimensionless floats.\n\nTo make the problem fully specified and testable, you will generate the histograms deterministically from a known reduced potential $u_0(\\theta)$ using the following construction per test case:\n- The underlying reduced potential is $u_0(\\theta) = -\\alpha \\cos(2\\theta) - \\beta \\cos(\\theta)$ with given parameters $(\\alpha,\\beta)$.\n- The number of windows is $M = 8$, with bias centers $\\theta_i = -\\pi + i \\cdot \\frac{\\pi}{4}$ for $i \\in \\{0,1,2,3,4,5,6,7\\}$.\n- The bin count is $B$ as specified per test case, with uniform bins over $[-\\pi,\\pi)$.\n- For each window $i$, the bias is $u_i(\\theta) = \\tfrac{k}{2}\\,d(\\theta,\\theta_i)^2$ with the specified stiffness $k$.\n- For each window $i$, the exact expected discrete probability for bin $j$ is\n$$\np_{i,j} = \\frac{\\exp\\!\\left(-[u_0(\\theta_j) + u_i(\\theta_j)]\\right)}{\\sum_{m=0}^{B-1} \\exp\\!\\left(-[u_0(\\theta_m) + u_i(\\theta_m)]\\right)}.\n$$\n- The histogram counts are deterministically set by rounding the expected counts $N_i p_{i,j}$ to integers such that the total in window $i$ is exactly $N_i$. Specifically, for each window $i$, first compute the real vector $\\mathbf{e}_i$ with components $e_{i,j} = N_i p_{i,j}$, take the floor of each component to get integers, and then distribute the remaining $N_i - \\sum_j \\lfloor e_{i,j}\\rfloor$ counts by adding one to the bins with the largest fractional parts $e_{i,j} - \\lfloor e_{i,j}\\rfloor$ (breaking any exact ties by lower $j$).\n\nYou must implement a program that:\n- Constructs the histograms using the above deterministic procedure.\n- Uses only the histograms $h_{i,j}$, the known biases $u_i(\\theta_j)$, the counts $N_i$, and the bin centers $\\theta_j$ to estimate the unbiased free energy $F(\\theta_j)$ up to an additive constant.\n- Computes $\\Delta F_\\mathrm{bar}$ and $\\Delta F_\\mathrm{asym}$ as defined.\n\nTest Suite. Implement your program to run the following three cases and aggregate their results:\n- Case $1$ (happy path, strongly bimodal and nearly symmetric):\n  - $\\alpha = 1.5$, $\\beta = 0.1$.\n  - $k = 20$.\n  - $B = 60$.\n  - $(N_0,\\ldots,N_7) = (2000,1500,2500,1800,2200,1600,2400,1700)$.\n- Case $2$ (boundary case, nearly flat pocket):\n  - $\\alpha = 0.15$, $\\beta = 0.0$.\n  - $k = 8$.\n  - $B = 60$.\n  - $(N_0,\\ldots,N_7) = (1200,1200,1200,1200,1200,1200,1200,1200)$.\n- Case $3$ (asymmetric case with reversed minimum ordering):\n  - $\\alpha = 1.6$, $\\beta = -0.3$.\n  - $k = 25$.\n  - $B = 60$.\n  - $(N_0,\\ldots,N_7) = (3000,1800,2200,2000,2600,1800,2400,1600)$.\n\nFinal Output Format. Your program should produce a single line of output containing the three pairs of results in a list-of-lists form:\n- The output must be a single line string representing $[\\,[\\Delta F_\\mathrm{bar}^{(1)},\\Delta F_\\mathrm{asym}^{(1)}],\\,[\\Delta F_\\mathrm{bar}^{(2)},\\Delta F_\\mathrm{asym}^{(2)}],\\,[\\Delta F_\\mathrm{bar}^{(3)},\\Delta F_\\mathrm{asym}^{(3)}]\\,]$, where superscripts indicate the case number.\n- All angles must be in radians internally, and the reported values are floats in units of $k_\\mathrm{B}T$ (dimensionless). No units should be printed.", "solution": "The problem presented is a well-defined exercise in computational statistical mechanics, specifically the reconstruction of a potential of mean force (PMF), or free energy profile, from a set of biased simulations. This is a standard task in molecular dynamics, often addressed using the Weighted Histogram Analysis Method (WHAM) or the Multistate Bennett Acceptance Ratio (MBAR) method. The problem provides all necessary data and a deterministic procedure to generate simulation-like histograms, thus making it a complete and solvable numerical problem.\nThe problem is valid as it is scientifically grounded, well-posed, and objective. It does not violate any fundamental principles of physics or mathematics. All parameters and procedures are described with sufficient precision to admit a unique solution.\n\nMy approach will be to implement the procedure as follows:\n1.  For each test case, first generate the required input data. This involves discretizing the coordinate $\\theta$, calculating the true underlying potential $u_0(\\theta)$ and the biasing potentials $u_i(\\theta)$ on this grid, and then constructing the histograms $h_{i,j}$ using the specified deterministic rounding procedure based on the exact biased probabilities.\n2.  With the histograms $h_{i,j}$, number of samples $N_i$, and bias potentials $u_i(\\theta_j)$ in hand, the next step is to compute the unbiased free energy profile $F(\\theta_j)$. I will use the WHAM equations, which provide a self-consistent set of relations to find the optimal estimate of the free energy profile. The equations are:\n    $$\n    e^{-F_j} = C \\cdot \\frac{\\sum_{i=1}^M h_{i,j}}{\\sum_{i=1}^M N_i e^{f_i - u_{i,j}}}\n    $$\n    $$\n    e^{-f_i} = \\sum_{j=0}^{B-1} e^{-F_j - u_{i,j}}\n    $$\n    Here, $F_j$ is the free energy of bin $j$, $u_{i,j} = u_i(\\theta_j)$ is the bias potential of window $i$ in bin $j$, and $f_i$ are the free energies of the individual simulations. $C$ is a normalization constant. These equations are solved iteratively until the values of $F_j$ and $f_i$ converge. To ensure numerical stability, calculations involving sums of exponentials are performed in log-space using the log-sum-exp trick.\n\n3.  After obtaining the converged free energy profile $F(\\theta_j)$, the final step is to extract the two requested scalar quantities: the barrier height $\\Delta F_\\mathrm{bar}$ and the asymmetry $\\Delta F_\\mathrm{asym}$. This requires identifying the correct index ranges that correspond to the angular regions specified in the problem: $\\theta \\in [0,\\pi]$ for the barrier top, $\\theta \\in [-\\pi/3, \\pi/3]$ for the minimum near zero, and $|d(\\theta,\\pi)| \\le \\pi/3$ for the minimum near $\\pi$. The minima and maximum of the profile $F(\\theta_j)$ are found within these specific index ranges, and the final scalars are calculated according to their definitions.\n\nA critical component is the correct handling of periodic boundary conditions for the angle $\\theta$. The minimum-image angular distance $d(\\theta, \\phi)$ must be calculated using a function that correctly wraps the difference $\\theta-\\phi$ into the interval $(-\\pi, \\pi]$, as specified. This is squared to compute the harmonic bias energies.\n\nThe entire procedure is encapsulated in a Python script that processes each of the three test cases and formats the final results as a single string, conforming to the specified output format.\n```python\nimport numpy as np\nfrom scipy.special import logsumexp\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It orchestrates the data generation, analysis, and final output formatting.\n    \"\"\"\n\n    def wrap_to_pi(x):\n        \"\"\"\n        Wraps angle(s) x to the interval (-pi, pi].\n\n        Parameters:\n        x (float or np.ndarray): The angle(s) in radians.\n\n        Returns:\n        float or np.ndarray: The wrapped angle(s).\n        \"\"\"\n        y = np.mod(x, 2 * np.pi)\n        # For an array y, np.where is used for conditional assignment.\n        # if y > pi, it is mapped to y - 2*pi, resulting in the range (-pi, 0).\n        # if y = pi, it is unchanged, giving the range [0, pi].\n        # The combination of these two is (-pi, pi].\n        y = np.where(y > np.pi, y - 2 * np.pi, y)\n        return y\n\n    def process_case(alpha, beta, k, B, N_i):\n        \"\"\"\n        Processes a single test case: generates histograms, runs WHAM, and computes results.\n        \"\"\"\n        # 1. Setup grid and parameters\n        M = 8  # Number of windows\n        delta_theta = 2 * np.pi / B\n        theta_j = -np.pi + (np.arange(B) + 0.5) * delta_theta\n        theta_i_centers = -np.pi + np.arange(M) * np.pi / 4\n\n        # 2. Generate histograms deterministically\n        histograms = np.zeros((M, B), dtype=np.int64)\n        bias_potentials = np.zeros((M, B))\n        \n        # Calculate unbiased potential on the grid\n        u0_j = -alpha * np.cos(2 * theta_j) - beta * np.cos(theta_j)\n\n        for i in range(M):\n            # Calculate bias potential for window i\n            d_theta = wrap_to_pi(theta_j - theta_i_centers[i])\n            ui_j = 0.5 * k * d_theta**2\n            bias_potentials[i, :] = ui_j\n\n            # Calculate total potential and exact probabilities for bin j in window i\n            total_potential = u0_j + ui_j\n            log_probs = -total_potential\n            log_probs -= logsumexp(log_probs)  # Normalize using logsumexp\n            probs = np.exp(log_probs)\n            \n            # Calculate expected counts\n            expected_counts = N_i[i] * probs\n            \n            # Deterministic rounding procedure\n            floored_counts = np.floor(expected_counts)\n            h_ij = floored_counts.astype(np.int64)\n            # Use round() to handle potential float precision issues\n            remainder = int(round(N_i[i] - np.sum(floored_counts)))\n            \n            if remainder > 0:\n                fractional_parts = expected_counts - floored_counts\n                j_indices = np.arange(B)\n                # Sort indices by fractional part (descending) and then index (ascending) to break ties\n                sorted_indices = np.lexsort((j_indices, -fractional_parts))\n                indices_to_increment = sorted_indices[:remainder]\n                h_ij[indices_to_increment] += 1\n            \n            histograms[i, :] = h_ij\n\n        # 3. Reconstruct free energy profile using WHAM\n        F = np.zeros(B)  # Initial guess for free energies\n        N_i_arr = np.array(N_i)\n        total_counts_j = np.sum(histograms, axis=0)\n        \n        # Bins with zero counts will have infinite free energy\n        non_zero_counts = total_counts_j > 0\n        log_total_counts_j = np.full(B, -np.inf)\n        if np.any(non_zero_counts):\n            log_total_counts_j[non_zero_counts] = np.log(total_counts_j[non_zero_counts])\n\n        # WHAM iterative solution\n        max_iter = 10000\n        tolerance = 1e-9\n        for _ in range(max_iter):\n            F_old = F.copy()\n            \n            # Update f_i (dimensionless free energies of each simulation)\n            f = -logsumexp(-F[np.newaxis, :] - bias_potentials, axis=1)\n\n            # Update F_j (unbiased free energy profile)\n            log_sum_exp_term = logsumexp(np.log(N_i_arr)[:, np.newaxis] + f[:, np.newaxis] - bias_potentials, axis=0)\n            F = -log_total_counts_j + log_sum_exp_term\n\n            # Normalize F to prevent drift and handle any infinities\n            finite_F = F[np.isfinite(F)]\n            if finite_F.size > 0:\n                F -= np.min(finite_F)\n            \n            # Check for convergence\n            if np.all(np.isclose(F, F_old, atol=tolerance, rtol=0)):\n                break\n\n        # 4. Analyze the free energy profile F\n        # Define index ranges for analysis using boolean masks\n        range_0_pi_mask = theta_j >= 0\n        range_near_0_mask = (theta_j >= -np.pi/3)  (theta_j = np.pi/3)\n        range_near_pi_mask = (theta_j = -2*np.pi/3) | (theta_j >= 2*np.pi/3)\n\n        # Ensure ranges are not empty before taking min/max\n        if not np.any(range_near_0_mask) or not np.any(range_near_pi_mask) or not np.any(range_0_pi_mask):\n             return [np.nan, np.nan] # Should not happen with B=60\n\n        # Find minima and maxima in the specified ranges\n        F_min_near_0 = np.min(F[range_near_0_mask])\n        F_min_near_pi = np.min(F[range_near_pi_mask])\n        F_barrier_top = np.max(F[range_0_pi_mask])\n\n        # Calculate final scalar quantities\n        delta_F_bar = F_barrier_top - min(F_min_near_0, F_min_near_pi)\n        delta_F_asym = F_min_near_pi - F_min_near_0\n        \n        return [delta_F_bar, delta_F_asym]\n\n    # Define the test cases from the problem statement\n    test_cases = [\n        # Case 1: happy path, strongly bimodal and nearly symmetric\n        {\n            \"alpha\": 1.5, \"beta\": 0.1, \"k\": 20, \"B\": 60,\n            \"N_i\": [2000, 1500, 2500, 1800, 2200, 1600, 2400, 1700]\n        },\n        # Case 2: boundary case, nearly flat pocket\n        {\n            \"alpha\": 0.15, \"beta\": 0.0, \"k\": 8, \"B\": 60,\n            \"N_i\": [1200, 1200, 1200, 1200, 1200, 1200, 1200, 1200]\n        },\n        # Case 3: asymmetric case with reversed minimum ordering\n        {\n            \"alpha\": 1.6, \"beta\": -0.3, \"k\": 25, \"B\": 60,\n            \"N_i\": [3000, 1800, 2200, 2000, 2600, 1800, 2400, 1600]\n        }\n    ]\n    \n    results = []\n    for case_params in test_cases:\n        result = process_case(**case_params)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "answer": "[[3.013444793540209, -0.1989678857416393], [0.2985160007297394, 0.0], [3.801646206385317, 0.5989714397576579]]", "id": "2455424"}]}