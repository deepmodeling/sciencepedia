{"hands_on_practices": [{"introduction": "A cornerstone of epigenetics is understanding how methylation patterns are maintained or lost across cell divisions. This practice explores \"passive demethylation,\" the gradual dilution of a methylation mark due to imperfect maintenance following semiconservative DNA replication. By constructing a simple probabilistic model [@problem_id:2805059], you will derive the expected trajectory of methylation loss over generations, providing a fundamental baseline against which active regulatory processes can be identified and quantified.", "problem": "A single autosomal locus contains a single 5′-Cytosine-phosphate-Guanine-3′ (CpG) dyad that is symmetrically methylated on both DNA strands in a clonal cell population at generation $n=0$. Assume the following experimentally grounded principles:\n- Deoxyribonucleic acid (DNA) replication is semiconservative: at each S phase, each parental strand serves as template for a newly synthesized complementary strand, yielding two daughter duplexes.\n- DNA Methyltransferase 1 (DNMT1) is the maintenance methyltransferase that acts at hemimethylated CpG dyads after replication. For each hemimethylated dyad in a given S phase, DNMT1 independently succeeds in methylating the nascent cytosine with probability $1-p$ and fails with probability $p$, where $0 \\leq p \\leq 1$ is constant across generations and cells.\n- There is no de novo methylation: fully unmethylated dyads are not methylated.\n- Consider a “nascent-strand-tracking” lineage: at each division, among the two daughter duplexes, focus on the duplex that contains the strand newly synthesized in the immediately preceding S phase (thus, over $n$ generations, you always follow the strand that was newly synthesized at each step).\n\nDefine $M_n$ to be the probability (equivalently, the expected fraction across an ensemble of independent, identically evolving lineages) that the CpG cytosine on the tracked strand is methylated after maintenance at generation $n$. The initial condition is $M_0=1$ because the starting strand at $n=0$ is methylated.\n\nUsing only the principles above and treating maintenance events across generations as independent, derive a closed-form expression for $M_n$ as a function of $p$ and $n$. Your final answer must be a single analytic expression. No rounding is required, and no units are needed.", "solution": "The problem statement is subjected to validation and is found to be valid. It is scientifically grounded in the established principles of DNA replication and maintenance methylation, well-posed with a clear initial condition and rules of evolution, and expressed in objective, formal language. It is a solvable problem in probabilistic modeling.\n\nLet $M_n$ be the probability that the cytosine on the tracked strand is methylated after maintenance methylation at generation $n$. The initial condition is given as $M_0 = 1$, as the CpG dyad is symmetrically methylated at generation $n=0$. We are tasked with finding a closed-form expression for $M_n$.\n\nThe core of the problem lies in correctly interpreting the \"nascent-strand-tracking\" lineage. This rule states that at each generation, we follow the strand that was newly synthesized. This implies that the tracked strand at generation $n+1$ is the nascent strand synthesized using the tracked strand of generation $n$ as its template. We can therefore establish a recurrence relation for $M_n$.\n\nLet us consider the transition from generation $n$ to generation $n+1$. The state of the tracked strand for generation $n+1$ depends entirely on the state of its template, which is the tracked strand from generation $n$. We can find $M_{n+1}$, the probability that the tracked strand at generation $n+1$ is methylated, by conditioning on the methylation status of the tracked strand at generation $n$. We apply the law of total probability.\n\nThere are two mutually exclusive possibilities for the tracked strand at generation $n$:\n\nCase 1: The tracked strand at generation $n$ is methylated.\nThe probability of this event is, by definition, $M_n$. When this strand serves as a template during DNA replication, it produces a hemimethylated CpG dyad: the template strand is methylated, and the nascent strand is unmethylated. According to the problem, the maintenance methyltransferase DNMT1 acts on this hemimethylated dyad. DNMT1 succeeds in methylating the nascent cytosine with a probability of $1-p$. Since the nascent strand is the tracked strand for generation $n+1$, the probability of it being methylated in this case is $1-p$.\n\nCase 2: The tracked strand at generation $n$ is unmethylated.\nThe probability of this event is $1 - M_n$. When this unmethylated strand serves as a template, it produces a fully unmethylated CpG dyad: both the template and the nascent strand are unmethylated. The problem explicitly states there is no *de novo* methylation. Therefore, this unmethylated dyad remains unmethylated. The probability of the nascent strand (the tracked strand for generation $n+1$) becoming methylated in this case is $0$.\n\nCombining these two cases, the probability $M_{n+1}$ can be written as:\n$$\nM_{n+1} = P(\\text{nascent strand is methylated} | \\text{template is methylated}) \\cdot P(\\text{template is methylated}) + P(\\text{nascent strand is methylated} | \\text{template is unmethylated}) \\cdot P(\\text{template is unmethylated})\n$$\nSubstituting the probabilities derived from the problem statement:\n$$\nM_{n+1} = (1-p) \\cdot M_n + (0) \\cdot (1-M_n)\n$$\nThis simplifies to the following linear recurrence relation:\n$$\nM_{n+1} = (1-p)M_n\n$$\nThis is a geometric progression. We can solve it by iteration, starting from the given initial condition $M_0 = 1$.\nFor $n=1$:\n$$\nM_1 = (1-p)M_0 = (1-p) \\cdot 1 = 1-p\n$$\nFor $n=2$:\n$$\nM_2 = (1-p)M_1 = (1-p)(1-p) = (1-p)^2\n$$\nFor $n=3$:\n$$\nM_3 = (1-p)M_2 = (1-p)(1-p)^2 = (1-p)^3\n$$\nBy induction, the general solution for any generation $n \\geq 0$ is:\n$$\nM_n = (1-p)^n M_0\n$$\nSince $M_0 = 1$, the final expression for $M_n$ is:\n$$\nM_n = (1-p)^n\n$$\nThis expression gives the probability that the cytosine on the tracked nascent strand is methylated at generation $n$, as a function of the maintenance failure probability $p$ and the number of generations $n$.", "answer": "$$\\boxed{(1-p)^{n}}$$", "id": "2805059"}, {"introduction": "While bisulfite sequencing is a workhorse for methylation analysis, it cannot distinguish between 5-methylcytosine ($5mC$) and its oxidized derivative, 5-hydroxymethylcytosine ($5hmC$), which often have distinct regulatory roles. This exercise [@problem_id:2805008] tackles this challenge by demonstrating how to build a mathematical model that integrates data from both conventional (BS-seq) and oxidative (oxBS-seq) bisulfite sequencing. You will learn to deconvolve these mixed signals to accurately estimate the true abundance of $5hmC$, while accounting for experimental variables like non-conversion rates and oxidation efficiency.", "problem": "A single CpG locus in the gene body of a neuronally expressed gene is profiled by conventional bisulfite sequencing (BS-seq) and oxidative bisulfite sequencing (oxBS-seq). Conventional bisulfite sequencing (BS-seq) reports the fraction of reads calling cytosine as methylated signal, which comprises both 5-methylcytosine and 5-hydroxymethylcytosine, plus residual non-conversion of unmodified cytosine. Oxidative bisulfite sequencing (oxBS-seq) uses a prior oxidation step intended to convert 5-hydroxymethylcytosine into a form that is deaminated by bisulfite, so that only 5-methylcytosine is retained as cytosine, again with a small residual non-conversion of unmodified cytosine. Assume the following, where each probability refers to a single CpG site sampled uniformly at random across sequencing reads:\n- The true fractions of cytosines in states 5-methylcytosine, 5-hydroxymethylcytosine, and unmodified cytosine are $m$, $h$, and $u$, respectively, with $m + h + u = 1$.\n- In BS-seq, 5-methylcytosine and 5-hydroxymethylcytosine are always read as cytosine, while unmodified cytosine is read as cytosine with non-conversion probability $b_{BS}$.\n- In oxBS-seq, 5-methylcytosine is always read as cytosine, 5-hydroxymethylcytosine is oxidized with efficiency $\\epsilon_{ox}$ and, if oxidized, is deaminated and read as thymine; if not oxidized, it is read as cytosine. Unmodified cytosine is read as cytosine with non-conversion probability $b_{ox}$.\nYou measure at this locus the observed methylation fractions $ \\beta_{BS} = 0.78 $ and $ \\beta_{ox} = 0.65 $. Independent spike-in controls estimate the oxidation efficiency as $ \\epsilon_{ox} = 0.92 $ and the bisulfite non-conversion rates as $ b_{BS} = 0.005 $ and $ b_{ox} = 0.004 $. Using only the law of total probability and the definitions above, derive an expression for the true 5-hydroxymethylcytosine fraction $h$ in terms of $ \\beta_{BS}, \\beta_{ox}, \\epsilon_{ox}, b_{BS}, b_{ox} $, and then compute its value for the parameters given. Report the final value of $h$ as a decimal fraction, rounded to four significant figures.", "solution": "The problem requires the derivation of the true fraction of 5-hydroxymethylcytosine, denoted by $h$, from experimental measurements obtained via conventional bisulfite sequencing (BS-seq) and oxidative bisulfite sequencing (oxBS-seq). The solution proceeds by first establishing a mathematical model based on the law of total probability that relates the observable quantities to the true underlying molecular fractions, and then solving the resulting system of equations.\n\nLet $m$, $h$, and $u$ be the true fractions of 5-methylcytosine, 5-hydroxymethylcytosine, and unmodified cytosine at the CpG locus, respectively. These fractions must sum to $1$.\n$$m + h + u = 1$$\n\nThe observed methylation fraction in any experiment, denoted $\\beta$, is the probability that a sequencing read at the CpG site is reported as cytosine (C). We can express this using the law of total probability, conditioned on the true state of the cytosine base.\n$$P(\\text{read C}) = \\sum_{\\text{state } S \\in \\{m, h, u\\}} P(\\text{read C} | \\text{state is } S) \\cdot P(\\text{state is } S)$$\n\nFor conventional bisulfite sequencing (BS-seq), the observed methylation fraction is $\\beta_{BS}$. According to the problem statement:\n- A 5-methylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } m) = 1$.\n- A 5-hydroxymethylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } h) = 1$.\n- An unmodified cytosine is read as cytosine with a non-conversion probability $b_{BS}$, so $P(\\text{read C} | \\text{state is } u) = b_{BS}$.\n\nSubstituting these probabilities and the true fractions ($P(\\text{state is } m)=m$, $P(\\text{state is } h)=h$, $P(\\text{state is } u)=u$) into the law of total probability, we obtain the first equation:\n$$\\beta_{BS} = (1 \\cdot m) + (1 \\cdot h) + (b_{BS} \\cdot u) = m + h + b_{BS} u \\quad (1)$$\n\nFor oxidative bisulfite sequencing (oxBS-seq), the observed methylation fraction is $\\beta_{ox}$. The probabilities are defined as:\n- A 5-methylcytosine is always read as cytosine, so $P(\\text{read C} | \\text{state is } m) = 1$.\n- A 5-hydroxymethylcytosine is read as cytosine only if it fails to be oxidized. The probability of non-oxidation is $1 - \\epsilon_{ox}$. Thus, $P(\\text{read C} | \\text{state is } h) = 1 - \\epsilon_{ox}$.\n- An unmodified cytosine is read as cytosine with a non-conversion probability $b_{ox}$, so $P(\\text{read C} | \\text{state is } u) = b_{ox}$.\n\nThis gives the second equation:\n$$\\beta_{ox} = (1 \\cdot m) + ((1 - \\epsilon_{ox}) \\cdot h) + (b_{ox} \\cdot u) = m + (1 - \\epsilon_{ox})h + b_{ox} u \\quad (2)$$\n\nWe have a system of three linear equations for the three unknowns $m$, $h$, and $u$:\n1. $m + h + b_{BS} u = \\beta_{BS}$\n2. $m + (1 - \\epsilon_{ox})h + b_{ox} u = \\beta_{ox}$\n3. $m + h + u = 1$\n\nOur objective is to derive an expression for $h$. A systematic approach is to first eliminate $m$. By subtracting equation (3) from equation (1), we can find an expression for $u$.\n$$(m + h + b_{BS} u) - (m + h + u) = \\beta_{BS} - 1$$\n$$u(b_{BS} - 1) = \\beta_{BS} - 1$$\n$$u = \\frac{\\beta_{BS} - 1}{b_{BS} - 1} = \\frac{1 - \\beta_{BS}}{1 - b_{BS}}$$\nThis expression gives the true fraction of unmodified cytosine, $u$, in terms of the BS-seq measurement, $\\beta_{BS}$, and its corresponding non-conversion rate, $b_{BS}$.\n\nNext, we can eliminate $m$ by subtracting equation (2) from equation (1):\n$$(\\beta_{BS}) - (\\beta_{ox}) = (m + h + b_{BS} u) - (m + (1 - \\epsilon_{ox})h + b_{ox} u)$$\n$$\\beta_{BS} - \\beta_{ox} = h - (1 - \\epsilon_{ox})h + u(b_{BS} - b_{ox})$$\n$$\\beta_{BS} - \\beta_{ox} = h(1 - (1 - \\epsilon_{ox})) + u(b_{BS} - b_{ox})$$\n$$\\beta_{BS} - \\beta_{ox} = h \\epsilon_{ox} + u(b_{BS} - b_{ox})$$\nThis equation relates $h$ and $u$. We can now substitute the expression for $u$ we previously derived into this equation:\n$$\\beta_{BS} - \\beta_{ox} = h \\epsilon_{ox} + \\left(\\frac{1 - \\beta_{BS}}{1 - b_{BS}}\\right)(b_{BS} - b_{ox})$$\nNow, we solve for $h$. First, isolate the term $h \\epsilon_{ox}$:\n$$h \\epsilon_{ox} = (\\beta_{BS} - \\beta_{ox}) - (b_{BS} - b_{ox})\\frac{1 - \\beta_{BS}}{1 - b_{BS}}$$\nFinally, dividing by $\\epsilon_{ox}$ yields the desired expression for $h$:\n$$h = \\frac{1}{\\epsilon_{ox}} \\left[ (\\beta_{BS} - \\beta_{ox}) - (b_{BS} - b_{ox})\\frac{1 - \\beta_{BS}}{1 - b_{BS}} \\right]$$\n\nNow, we substitute the given numerical values into this expression:\n$\\beta_{BS} = 0.78$\n$\\beta_{ox} = 0.65$\n$\\epsilon_{ox} = 0.92$\n$b_{BS} = 0.005$\n$b_{ox} = 0.004$\n\n$$h = \\frac{1}{0.92} \\left[ (0.78 - 0.65) - (0.005 - 0.004)\\frac{1 - 0.78}{1 - 0.005} \\right]$$\n$$h = \\frac{1}{0.92} \\left[ 0.13 - (0.001)\\frac{0.22}{0.995} \\right]$$\nWe calculate the term inside the bracket:\n$$0.13 - (0.001) \\cdot \\frac{0.22}{0.995} = 0.13 - \\frac{0.00022}{0.995}$$\n$$0.13 - 0.0002211055... = 0.1297788944...$$\nNow we complete the calculation for $h$:\n$$h = \\frac{0.1297788944...}{0.92} \\approx 0.1410640157...$$\nRounding the result to four significant figures as required by the problem statement gives:\n$$h \\approx 0.1411$$\nThis value represents the true fraction of 5-hydroxymethylcytosine at the specified locus.", "answer": "$$\\boxed{0.1411}$$", "id": "2805008"}, {"introduction": "Ultimately, we study DNA methylation to understand its role in gene regulation, including its influence on transcription factor (TF) binding. This is a computational practice that simulates a common and powerful analysis in genomics, where we test the hypothesis that a specific TF preferentially binds to unmethylated DNA motifs. By implementing a stratified permutation test [@problem_id:2805078], you will learn to rigorously assess the statistical significance of an observed association while controlling for confounding genomic features, a crucial skill for drawing robust biological conclusions from high-throughput data.", "problem": "You are given a stylized representation of Chromatin Immunoprecipitation followed by sequencing (ChIP-seq) peaks for a Transcription Factor (TF) and Whole-Genome Bisulfite Sequencing (WGBS) methylation measurements at the core CpG of the TF motif within each peak. The task is to formalize and implement a permutation-based enrichment test to determine whether the fraction of unmethylated motif CpGs in TF-bound sites is greater than expected relative to a matched genomic background, accounting for confounding structure via stratification.\n\nFundamental basis and definitions:\n- The Central Dogma and gene regulation establish that transcriptional activity is influenced by protein-DNA interactions. Epigenetic DNA methylation at cytosine-phosphate-guanine (CpG) dinucleotides is a widely accepted regulatory mark that can modulate TF binding.\n- Whole-Genome Bisulfite Sequencing (WGBS) yields an estimated methylation proportion at each CpG that can be represented as a real number in the closed interval $[0,1]$.\n- Consider a threshold $\\tau \\in [0,1]$ defining “unmethylated” as having methylation proportion less than or equal to $\\tau$.\n- Let there be a finite set of peaks (candidate TF binding sites) indexed by $i \\in \\{1,\\dots,n\\}$. For each peak $i$, you are given a methylation proportion $m_i \\in [0,1]$ for the motif CpG, and a stratum label $s_i \\in \\{0,1,\\dots,K-1\\}$ indicating a matched covariate class (for example, a bin of GC content or CpG density).\n- For each stratum $k \\in \\{0,1,\\dots,K-1\\}$, you are given a background pool $M^{(k)} = \\{b^{(k)}_1,\\dots,b^{(k)}_{N_k}\\}$ of methylation proportions representing matched genomic sites not bound by the TF. You may assume $N_k$ is sufficiently large for sampling without replacement in the supplied test suite.\n\nYour program must:\n1. Compute the observed fraction of unmethylated motif CpGs across the peaks using the given $\\tau$.\n2. Perform a one-sided enrichment test via a stratified permutation procedure under the null hypothesis that the unmethylated fraction in TF-bound sites is not greater than the matched background:\n   - For each of $B$ permutations, and for each stratum $k$, sample without replacement exactly $n_k$ values from $M^{(k)}$, where $n_k$ is the number of peaks in stratum $k$ (i.e., the count of indices $i$ with $s_i = k$). Combine the sampled values over strata and compute the permuted fraction of unmethylated sites under threshold $\\tau$.\n   - Use a fixed pseudorandom seed for reproducibility as specified per test case.\n   - Compute a one-sided right-tail P-value for enrichment using a plus-one correction to avoid zero-valued P, comparing the observed fraction to the empirical null distribution generated by the $B$ permutations.\n3. For each test case, output the pair consisting of the observed unmethylated fraction and the P-value, as decimals.\n\nTest suite:\nFor each test case below, use the provided parameters exactly as given.\n\n- Test case $1$ (two strata, enrichment expected):\n  - $\\tau = 0.2$\n  - Peaks methylation values $[0.05, 0.10, 0.80, 0.15, 0.25, 0.02, 0.30, 0.05, 0.18, 0.19, 0.40, 0.10]$\n  - Peaks strata $[0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]$\n  - Background per stratum:\n    - Stratum $0$: $[0.35, 0.60, 0.45, 0.50, 0.70, 0.55, 0.40, 0.65, 0.48, 0.52, 0.33, 0.47, 0.58, 0.62, 0.41, 0.75, 0.28, 0.31, 0.36, 0.44]$\n    - Stratum $1$: $[0.25, 0.20, 0.15, 0.10, 0.05, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.18, 0.22, 0.27, 0.33, 0.12, 0.08, 0.38, 0.42]$\n  - $B = 2000$\n  - Random seed $= 42$\n\n- Test case $2$ (two strata, near-null behavior expected):\n  - $\\tau = 0.25$\n  - Peaks methylation values $[0.20, 0.26, 0.24, 0.35, 0.40, 0.23, 0.28, 0.18, 0.38, 0.27]$\n  - Peaks strata $[0, 0, 0, 0, 0, 1, 1, 1, 1, 1]$\n  - Background per stratum:\n    - Stratum $0$: $[0.10, 0.12, 0.20, 0.26, 0.24, 0.30, 0.35, 0.40, 0.45, 0.50, 0.22, 0.27, 0.29, 0.33, 0.37, 0.41, 0.23, 0.19, 0.28, 0.32]$\n    - Stratum $1$: $[0.15, 0.18, 0.22, 0.26, 0.28, 0.30, 0.12, 0.35, 0.40, 0.45, 0.50, 0.55, 0.20, 0.24, 0.27, 0.29, 0.31, 0.33, 0.17, 0.19]$\n  - $B = 2000$\n  - Random seed $= 123$\n\n- Test case $3$ (one stratum, all peaks unmethylated, strong enrichment expected):\n  - $\\tau = 0.2$\n  - Peaks methylation values $[0.00, 0.02, 0.05, 0.10, 0.12, 0.15, 0.18, 0.19]$\n  - Peaks strata $[0, 0, 0, 0, 0, 0, 0, 0]$\n  - Background per stratum:\n    - Stratum $0$: $[0.30, 0.35, 0.40, 0.45, 0.50, 0.60, 0.55, 0.48, 0.52, 0.58, 0.62, 0.70, 0.75, 0.80, 0.28, 0.33, 0.37, 0.42, 0.47, 0.53, 0.57, 0.63, 0.68, 0.73, 0.77, 0.82, 0.85, 0.90, 0.95, 0.99]$\n  - $B = 2000$\n  - Random seed $= 7$\n\n- Test case $4$ (one stratum, observed depletion; one-sided enrichment P-value should be large):\n  - $\\tau = 0.5$\n  - Peaks methylation values $[0.60, 0.70, 0.40, 0.55, 0.65]$\n  - Peaks strata $[0, 0, 0, 0, 0]$\n  - Background per stratum:\n    - Stratum $0$: $[0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.33, 0.47]$\n  - $B = 2000$\n  - Random seed $= 99$\n\nFinal output specification:\n- For each test case, return the observed unmethylated fraction and the P-value as decimals, each rounded to six decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is itself a two-element list of the form $[\\text{fraction}, \\text{pvalue}]$; for example: $[[0.500000,0.123000],[0.400000,0.876000]]$.", "solution": "The problem requires a critical assessment of its validity before proceeding to a solution.\n\n### Step 1: Extract Givens\n\n- **Topic**: Principles of Genetics; DNA methylation and gene regulation.\n- **Context**: A stylized representation of Chromatin Immunoprecipitation sequencing (ChIP-seq) for a Transcription Factor (TF) and Whole-Genome Bisulfite Sequencing (WGBS) data.\n- **Definitions**:\n    - Methylation proportion: A real number in the closed interval $[0,1]$.\n    - Unmethylated threshold $\\tau \\in [0,1]$: A site is \"unmethylated\" if its methylation proportion is $\\le \\tau$.\n    - Peaks: A finite set of $n$ candidate TF binding sites, indexed by $i \\in \\{1,\\dots,n\\}$.\n    - Peak Data: For each peak $i$, a methylation proportion $m_i \\in [0,1]$ and a stratum label $s_i \\in \\{0,1,\\dots,K-1\\}$.\n    - Background Data: For each stratum $k$, a background pool $M^{(k)} = \\{b^{(k)}_1,\\dots,b^{(k)}_{N_k}\\}$ of methylation proportions from non-TF-bound sites. $N_k$ is assumed to be large enough for sampling without replacement.\n- **Task**:\n    1.  Compute the observed fraction of unmethylated motif CpGs across all peaks.\n    2.  Perform a one-sided enrichment test using a stratified permutation procedure with $B$ permutations.\n        - For each permutation, sample $n_k$ values from the background pool $M^{(k)}$ for each stratum $k$, where $n_k$ is the number of peaks in stratum $k$.\n        - Combine sampled values and compute the permuted fraction of unmethylated sites.\n        - Use a specified pseudorandom seed for reproducibility.\n    3.  Compute a one-sided right-tail P-value with a plus-one correction: $(C+1)/(B+1)$, where $C$ is the count of permuted fractions greater than or equal to the observed fraction.\n    4.  Output the pair [observed unmethylated fraction, P-value] for each test case.\n- **Test Cases**:\n    - **Test case 1**: $\\tau = 0.2$, $B = 2000$, seed $= 42$. Data for peaks (methylation, strata) and background pools (strata $0$, $1$) are provided.\n    - **Test case 2**: $\\tau = 0.25$, $B = 2000$, seed $= 123$. Data for peaks (methylation, strata) and background pools (strata $0$, $1$) are provided.\n    - **Test case 3**: $\\tau = 0.2$, $B = 2000$, seed $= 7$. Data for peaks (methylation, strata) and background pool (stratum $0$) are provided.\n    - **Test case 4**: $\\tau = 0.5$, $B = 2000$, seed $= 99$. Data for peaks (methylation, strata) and background pool (stratum $0$) are provided.\n- **Output Format**: A single line string `[[fraction1,pvalue1],[fraction2,pvalue2],...]` where each value is rounded to six decimal places.\n\n### Step 2: Validate Using Extracted Givens\n\n- **Scientifically Grounded**: The problem is well-grounded in molecular biology and computational biology. The concepts of TF binding, DNA methylation, ChIP-seq, WGBS, and the use of permutation testing to assess statistical significance are standard and fundamental in the field of genomics. The premise is factually sound.\n- **Well-Posed**: The problem is well-posed. It specifies the inputs, the exact computational procedure (stratified permutation testing), the null hypothesis, the formula for the P-value, and the required output format. A unique and stable solution can be determined from the given data and procedure.\n- **Objective**: The problem is stated in precise, objective, and quantitative terms. It asks for the implementation of a standard statistical test, leaving no room for subjective interpretation.\n- **Completeness and Consistency**: The problem is self-contained. All necessary data, including methylation values, strata labels, background pools, permutation counts ($B$), and random seeds, are provided for each test case. The condition that background pools are sufficiently large for sampling without replacement is explicitly stated, removing a potential ambiguity. There are no contradictions.\n- **Realism**: The data values (methylation proportions between $0$ and $1$) are realistic. The scenario of testing for differential methylation in TF binding sites versus a genomic background is a common and practical task in bioinformatics research.\n- **Other Flaws**: The problem is not trivial, non-formalizable, ill-posed, or pseudo-profound. It requires a correct implementation of a specific and meaningful statistical procedure.\n\n### Step 3: Verdict and Action\n\nThe problem is valid. It is scientifically sound, well-posed, objective, and complete. A reasoned solution will be developed.\n\n### Solution\n\nThe task is to implement a stratified permutation test to determine if a set of Transcription Factor (TF) binding sites (peaks) is significantly enriched for unmethylated CpGs compared to a matched genomic background. Stratification is used to control for potential confounding variables, such as local GC content, which can influence DNA methylation independently of TF binding.\n\nLet the set of $n$ peak methylation values be $\\{m_1, m_2, \\dots, m_n\\}$, and their corresponding stratum labels be $\\{s_1, s_2, \\dots, s_n\\}$, where $s_i \\in \\{0, 1, \\dots, K-1\\}$. The methylation threshold for being \"unmethylated\" is $\\tau$.\n\n1.  **Calculate the Observed Test Statistic**\n    The test statistic is the fraction of peaks that are unmethylated. Let this observed fraction be $F_{obs}$. It is calculated as:\n    $$ F_{obs} = \\frac{1}{n} \\sum_{i=1}^{n} \\mathbb{I}(m_i \\le \\tau) $$\n    where $\\mathbb{I}(\\cdot)$ is the indicator function, which is $1$ if its argument is true and $0$ otherwise.\n\n2.  **Generate the Null Distribution via Stratified Permutation**\n    The null hypothesis, $H_0$, is that the methylation levels at TF-bound sites are drawn from the same distribution as the matched background sites. The permutation test generates an empirical distribution for the test statistic under this null hypothesis. The stratification ensures that the permuted datasets maintain the same confounding structure as the observed data.\n\n    First, we determine the number of peaks within each stratum $k$, denoted as $n_k$:\n    $$ n_k = \\sum_{i=1}^{n} \\mathbb{I}(s_i = k) \\quad \\text{for } k \\in \\{0, 1, \\dots, K-1\\} $$\n    Note that the total number of peaks is $n = \\sum_{k=0}^{K-1} n_k$.\n\n    The permutation procedure is repeated $B$ times. For each permutation $j \\in \\{1, \\dots, B\\}$:\n    a. A new set of `resampled` methylation values is constructed.\n    b. For each stratum $k$, we randomly sample, without replacement, $n_k$ methylation values from the corresponding background pool $M^{(k)}$.\n    c. These sampled values from all strata are combined into a single set of $n$ values.\n    d. The test statistic is computed for this permuted set, yielding a permuted fraction $F_{perm}^{(j)}$:\n    $$ F_{perm}^{(j)} = \\frac{1}{n} \\sum_{m' \\in \\text{resampled set } j} \\mathbb{I}(m' \\le \\tau) $$\n    This collection of $B$ values, $\\{F_{perm}^{(1)}, F_{perm}^{(2)}, \\dots, F_{perm}^{(B)}\\}$, forms the empirical null distribution.\n\n3.  **Calculate the P-value**\n    We are performing a one-sided test for enrichment, meaning we want to know if $F_{obs}$ is significantly *greater* than what is expected by chance. The P-value is the probability of observing a test statistic as extreme as or more extreme than $F_{obs}$, assuming the null hypothesis is true. This is estimated from the empirical null distribution.\n\n    The number of permutations yielding a fraction greater than or equal to the observed fraction is counted:\n    $$ C = \\sum_{j=1}^{B} \\mathbb{I}(F_{perm}^{(j)} \\ge F_{obs}) $$\n    To avoid a P-value of $0$ when no permuted statistic exceeds the observed one (which can lead to overconfidence in the result), a pseudocount of $1$ is added to both the numerator and the denominator. The final P-value is:\n    $$ P = \\frac{C + 1}{B + 1} $$\n\nThis procedure will be implemented for each test case, using the specified parameters, data, and random seeds to ensure reproducibility. The final result for each case will be the pair $[F_{obs}, P]$, with values formatted to six decimal places.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the stratified permutation test on all test cases.\n    \"\"\"\n    test_cases = [\n        {\n            \"tau\": 0.2,\n            \"peak_methylation\": np.array([0.05, 0.10, 0.80, 0.15, 0.25, 0.02, 0.30, 0.05, 0.18, 0.19, 0.40, 0.10]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1]),\n            \"background\": {\n                0: np.array([0.35, 0.60, 0.45, 0.50, 0.70, 0.55, 0.40, 0.65, 0.48, 0.52, 0.33, 0.47, 0.58, 0.62, 0.41, 0.75, 0.28, 0.31, 0.36, 0.44]),\n                1: np.array([0.25, 0.20, 0.15, 0.10, 0.05, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.18, 0.22, 0.27, 0.33, 0.12, 0.08, 0.38, 0.42])\n            },\n            \"B\": 2000,\n            \"seed\": 42\n        },\n        {\n            \"tau\": 0.25,\n            \"peak_methylation\": np.array([0.20, 0.26, 0.24, 0.35, 0.40, 0.23, 0.28, 0.18, 0.38, 0.27]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1]),\n            \"background\": {\n                0: np.array([0.10, 0.12, 0.20, 0.26, 0.24, 0.30, 0.35, 0.40, 0.45, 0.50, 0.22, 0.27, 0.29, 0.33, 0.37, 0.41, 0.23, 0.19, 0.28, 0.32]),\n                1: np.array([0.15, 0.18, 0.22, 0.26, 0.28, 0.30, 0.12, 0.35, 0.40, 0.45, 0.50, 0.55, 0.20, 0.24, 0.27, 0.29, 0.31, 0.33, 0.17, 0.19])\n            },\n            \"B\": 2000,\n            \"seed\": 123\n        },\n        {\n            \"tau\": 0.2,\n            \"peak_methylation\": np.array([0.00, 0.02, 0.05, 0.10, 0.12, 0.15, 0.18, 0.19]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0, 0, 0, 0]),\n            \"background\": {\n                0: np.array([0.30, 0.35, 0.40, 0.45, 0.50, 0.60, 0.55, 0.48, 0.52, 0.58, 0.62, 0.70, 0.75, 0.80, 0.28, 0.33, 0.37, 0.42, 0.47, 0.53, 0.57, 0.63, 0.68, 0.73, 0.77, 0.82, 0.85, 0.90, 0.95, 0.99])\n            },\n            \"B\": 2000,\n            \"seed\": 7\n        },\n        {\n            \"tau\": 0.5,\n            \"peak_methylation\": np.array([0.60, 0.70, 0.40, 0.55, 0.65]),\n            \"peak_strata\": np.array([0, 0, 0, 0, 0]),\n            \"background\": {\n                0: np.array([0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.33, 0.47])\n            },\n            \"B\": 2000,\n            \"seed\": 99\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        tau = case[\"tau\"]\n        peak_methylation = case[\"peak_methylation\"]\n        peak_strata = case[\"peak_strata\"]\n        background = case[\"background\"]\n        B = case[\"B\"]\n        seed = case[\"seed\"]\n\n        n_peaks = len(peak_methylation)\n\n        # 1. Compute the observed fraction of unmethylated peaks\n        observed_unmethylated_count = np.sum(peak_methylation = tau)\n        observed_fraction = observed_unmethylated_count / n_peaks\n\n        # 2. Perform stratified permutation test\n        \n        # Determine unique strata and counts per stratum\n        strata_labels, strata_counts = np.unique(peak_strata, return_counts=True)\n        strata_info = dict(zip(strata_labels, strata_counts))\n\n        # Initialize random number generator for reproducibility\n        rng = np.random.default_rng(seed)\n\n        permuted_fractions = np.zeros(B)\n        \n        for i in range(B):\n            permuted_methylation = []\n            for stratum, count in strata_info.items():\n                background_pool = background[stratum]\n                # Sample 'count' values from the background pool without replacement\n                samples = rng.choice(background_pool, size=count, replace=False)\n                permuted_methylation.extend(samples)\n            \n            permuted_methylation = np.array(permuted_methylation)\n            permuted_unmethylated_count = np.sum(permuted_methylation = tau)\n            permuted_fractions[i] = permuted_unmethylated_count / n_peaks\n            \n        # 3. Compute the one-sided P-value with +1 correction\n        # Count how many permuted fractions are >= observed fraction\n        count_ge_observed = np.sum(permuted_fractions >= observed_fraction)\n        p_value = (count_ge_observed + 1) / (B + 1)\n        \n        all_results.append([observed_fraction, p_value])\n\n    # Format the final output string\n    formatted_pairs = []\n    for fraction, pvalue in all_results:\n        formatted_pairs.append(f\"[{fraction:.6f},{pvalue:.6f}]\")\n    \n    final_output_string = f\"[{','.join(formatted_pairs)}]\"\n    print(final_output_string)\n\nsolve()\n```", "id": "2805078"}]}