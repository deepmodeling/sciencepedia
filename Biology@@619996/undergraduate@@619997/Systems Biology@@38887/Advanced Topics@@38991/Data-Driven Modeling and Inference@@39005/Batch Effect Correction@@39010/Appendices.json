{"hands_on_practices": [{"introduction": "The most effective strategy for dealing with batch effects is to prevent them at the source through careful experimental design. When the biological variable of interest (e.g., treatment vs. control) is correlated with a technical variable (e.g., the experimental batch), the design is said to be \"confounded,\" making it difficult or impossible to separate the true biological signal from technical noise. This first exercise [@problem_id:1418479] challenges you to think like an experimentalist and devise a study layout that minimizes this confounding, ensuring the data collected is as robust and interpretable as possible.", "problem": "A systems biology research group is conducting a proteomic study to identify protein expression differences between cancerous and healthy tissues. They have collected 20 tumor samples (T) and 20 healthy control samples (C). The analysis will be performed using a mass spectrometer that processes samples loaded onto 24-well plates. Due to the total of 40 samples, the experiment must be run in two separate batches, using two 24-well plates (Plate 1 and Plate 2).\n\nIt is known that non-biological, systematic variations can occur between different batches (e.g., due to minor differences in instrument calibration or reagent preparation on different days). This is known as a **batch effect**. An experimental design is \"confounded\" if it is impossible to distinguish the biological effect of interest (cancer vs. healthy) from the technical batch effect.\n\nWhich of the following experimental designs for distributing the 40 samples across the two 24-well plates is optimal for minimizing the confounding between the treatment effect (T vs. C) and the batch effect (Plate 1 vs. Plate 2)?\n\nA. Place all 20 tumor samples (T) on Plate 1 and all 20 healthy control samples (C) on Plate 2.\n\nB. Completely randomize the assignment of the 40 samples to the 48 available wells on the two plates, leaving 8 wells empty at random.\n\nC. Place 10 tumor samples (T) and 10 healthy control samples (C) on Plate 1. Place the remaining 10 tumor samples (T) and 10 healthy control samples (C) on Plate 2. Leave 4 wells empty on each plate.\n\nD. Fill Plate 1 completely with 12 tumor samples (T) and 12 healthy control samples (C). Place the remaining 8 tumor samples (T) and 8 healthy control samples (C) on Plate 2.", "solution": "We formalize the notion of confounding between the biological treatment (tumor versus control) and the technical batch (Plate 1 versus Plate 2) using a linear model and the orthogonality of design columns.\n\nLet there be $N=40$ samples. Define, for sample $i$,\n- the treatment indicator $x_{i}=1$ if tumor (T) and $x_{i}=0$ if control (C),\n- the batch indicator $z_{i}=1$ if Plate 1 and $z_{i}=0$ if Plate 2.\n\nIn a linear model $y_{i}=\\mu+\\tau x_{i}+\\beta z_{i}+\\epsilon_{i}$, confounding between treatment and batch occurs if the design columns for $x$ and $z$ are not orthogonal. A practical diagnostic is the sample covariance between $x$ and $z$:\n$$\n\\operatorname{Cov}(x,z)\\ \\propto\\ \\bar{xz}-\\bar{x}\\,\\bar{z},\n$$\nwhere $\\bar{x}$, $\\bar{z}$ and $\\bar{xz}$ are the sample means of $x$, $z$ and $xz$, respectively. Absence of confounding corresponds to $\\bar{xz}=\\bar{x}\\,\\bar{z}$, i.e., orthogonality of treatment and batch in the design. In terms of counts, letting $n$ denote total samples, $n_{1}$ the number on Plate 1, and $t_{1}$ the number of tumor samples on Plate 1, we have\n$$\n\\bar{x}=\\frac{20}{40}=\\frac{1}{2},\\quad \\bar{z}=\\frac{n_{1}}{40},\\quad \\bar{xz}=\\frac{t_{1}}{40}.\n$$\nThus orthogonality is equivalent to\n$$\n\\frac{t_{1}}{40}=\\frac{1}{2}\\cdot\\frac{n_{1}}{40}\\quad\\Longleftrightarrow\\quad t_{1}=\\frac{n_{1}}{2},\n$$\nwhich means that each plate should have the same proportion of tumor and control as the overall study, namely one half tumor and one half control.\n\nWe now assess each option.\n\nA. All tumor on Plate 1 and all control on Plate 2. Here $n_{1}=20$ and $t_{1}=20$, so\n$$\n\\bar{xz}=\\frac{20}{40}=\\frac{1}{2},\\quad \\bar{x}\\bar{z}=\\frac{1}{2}\\cdot\\frac{20}{40}=\\frac{1}{4},\n$$\nhence $\\bar{xz}-\\bar{x}\\bar{z}\\neq 0$. This is complete confounding.\n\nB. Completely randomize across 48 wells with 8 empty at random. While the expected proportion of tumor per plate equals the overall proportion, randomization does not guarantee $t_{1}=n_{1}/2$ in the realized allocation. Therefore $\\bar{xz}-\\bar{x}\\bar{z}$ need not be zero, and confounding may occur by chance. This is not optimal when a deterministic balanced allocation is available.\n\nC. Put 10 tumor and 10 control on Plate 1, and 10 tumor and 10 control on Plate 2, with 4 empty wells per plate. Here $n_{1}=20$ and $t_{1}=10$, so\n$$\n\\bar{xz}=\\frac{10}{40}=\\frac{1}{4},\\quad \\bar{x}\\bar{z}=\\frac{1}{2}\\cdot\\frac{20}{40}=\\frac{1}{4},\n$$\nhence $\\bar{xz}-\\bar{x}\\bar{z}=0$. Treatment and batch are orthogonal, so there is no confounding. In addition, the batch sizes are equal, which improves precision of adjusted treatment estimates.\n\nD. Fill Plate 1 with 12 tumor and 12 control, and place 8 tumor and 8 control on Plate 2. Here $n_{1}=24$ and $t_{1}=12$, so\n$$\n\\bar{xz}=\\frac{12}{40}=\\frac{3}{10},\\quad \\bar{x}\\bar{z}=\\frac{1}{2}\\cdot\\frac{24}{40}=\\frac{3}{10},\n$$\nhence $\\bar{xz}-\\bar{x}\\bar{z}=0$. Treatment and batch are also orthogonal, so there is no confounding. However, the unequal batch sizes reduce efficiency relative to a design with equal numbers per batch when estimating treatment effects adjusted for batch.\n\nAmong the provided options, both C and D eliminate confounding by ensuring equal tumor-to-control proportion within each plate. Between these, C is optimal because it also balances the total number of samples per plate, which yields more efficient estimation and guards against plate-level differences unrelated to treatment while preserving zero confounding.", "answer": "$$\\boxed{C}$$", "id": "1418479"}, {"introduction": "Even with a well-designed experiment, subtle batch effects can still arise. The next step is to apply computational methods to correct for this unwanted variation. This practice [@problem_id:1418467] provides a hands-on introduction to a fundamental correction technique using a simplified dataset. By manually performing a gene-wise mean adjustment, you will gain a concrete understanding of how these algorithms work to align data from different batches, laying the groundwork for understanding more complex correction models.", "problem": "In a systems biology experiment designed to analyze the transcriptional response of cancer cells to a new drug, a researcher collects gene expression data. Due to logistical constraints, the experiment is conducted in two separate batches. After data acquisition, the researcher suspects a significant batch effect, where the measurement platform's calibration differed between the two runs.\n\nBelow is a table of the raw, unitless gene expression values for two genes, G1 and G2, across six cell samples. Samples S1, S2, and S3 belong to Batch 1, while samples S4, S5, and S6 belong to Batch 2.\n\n|       | S1 | S2 | S3 | S4 | S5 | S6 |\n| :---- | :- | :- | :- | :- | :- | :- |\n| **G1**| 5  | 7  | 9  | 12 | 15 | 18 |\n| **G2**| 22 | 30 | 26 | 35 | 41 | 38 |\n\nTo correct for the batch effect, the researcher decides to apply a gene-wise mean adjustment. This correction method adjusts the data for each gene individually, such that after correction, the mean expression value within each batch becomes equal to the overall mean expression value of that gene across all samples.\n\nCalculate the full corrected data matrix, with genes as rows and samples as columns. Present your final answer as a 2x6 matrix.", "solution": "The goal is to adjust the expression data for each gene so that the mean of the values within each batch is equal to the overall mean for that gene across all samples. We will perform this correction for each gene, G1 and G2, independently.\n\nLet $x_{g,s}$ be the expression value of gene $g$ in sample $s$. The adjusted value $x'_{g,s}$ for a sample in batch $b$ is given by the formula:\n$$x'_{g,s} = x_{g,s} + (\\text{Mean}_{g,\\text{overall}} - \\text{Mean}_{g,b})$$\nwhere $\\text{Mean}_{g,b}$ is the mean expression of gene $g$ in batch $b$, and $\\text{Mean}_{g,\\text{overall}}$ is the mean expression of gene $g$ across all samples.\n\n**Step 1: Correction for Gene G1**\n\nFirst, we calculate the required means for Gene G1.\nThe samples for G1 in Batch 1 are {5, 7, 9}. The mean for Batch 1 is:\n$$ \\text{Mean}_{\\text{G1, Batch 1}} = \\frac{5 + 7 + 9}{3} = \\frac{21}{3} = 7 $$\nThe samples for G1 in Batch 2 are {12, 15, 18}. The mean for Batch 2 is:\n$$ \\text{Mean}_{\\text{G1, Batch 2}} = \\frac{12 + 15 + 18}{3} = \\frac{45}{3} = 15 $$\nThe overall mean for G1 across all six samples is:\n$$ \\text{Mean}_{\\text{G1, overall}} = \\frac{5 + 7 + 9 + 12 + 15 + 18}{6} = \\frac{66}{6} = 11 $$\nNow, we calculate the adjustment factors for each batch.\nFor Batch 1, the adjustment factor is:\n$$ \\Delta_1 = \\text{Mean}_{\\text{G1, overall}} - \\text{Mean}_{\\text{G1, Batch 1}} = 11 - 7 = +4 $$\nFor Batch 2, the adjustment factor is:\n$$ \\Delta_2 = \\text{Mean}_{\\text{G1, overall}} - \\text{Mean}_{\\text{G1, Batch 2}} = 11 - 15 = -4 $$\nWe apply these adjustments to the original G1 data.\nFor Batch 1 (S1, S2, S3):\n$$ x'_{\\text{G1,S1}} = 5 + 4 = 9 $$\n$$ x'_{\\text{G1,S2}} = 7 + 4 = 11 $$\n$$ x'_{\\text{G1,S3}} = 9 + 4 = 13 $$\nFor Batch 2 (S4, S5, S6):\n$$ x'_{\\text{G1,S4}} = 12 - 4 = 8 $$\n$$ x'_{\\text{G1,S5}} = 15 - 4 = 11 $$\n$$ x'_{\\text{G1,S6}} = 18 - 4 = 14 $$\nThe corrected expression row for G1 is [9, 11, 13, 8, 11, 14].\n\n**Step 2: Correction for Gene G2**\n\nNext, we repeat the process for Gene G2.\nThe samples for G2 in Batch 1 are {22, 30, 26}. The mean for Batch 1 is:\n$$ \\text{Mean}_{\\text{G2, Batch 1}} = \\frac{22 + 30 + 26}{3} = \\frac{78}{3} = 26 $$\nThe samples for G2 in Batch 2 are {35, 41, 38}. The mean for Batch 2 is:\n$$ \\text{Mean}_{\\text{G2, Batch 2}} = \\frac{35 + 41 + 38}{3} = \\frac{114}{3} = 38 $$\nThe overall mean for G2 across all six samples is:\n$$ \\text{Mean}_{\\text{G2, overall}} = \\frac{22 + 30 + 26 + 35 + 41 + 38}{6} = \\frac{192}{6} = 32 $$\nNow, we calculate the adjustment factors for each batch for G2.\nFor Batch 1, the adjustment factor is:\n$$ \\Delta_1 = \\text{Mean}_{\\text{G2, overall}} - \\text{Mean}_{\\text{G2, Batch 1}} = 32 - 26 = +6 $$\nFor Batch 2, the adjustment factor is:\n$$ \\Delta_2 = \\text{Mean}_{\\text{G2, overall}} - \\text{Mean}_{\\text{G2, Batch 2}} = 32 - 38 = -6 $$\nWe apply these adjustments to the original G2 data.\nFor Batch 1 (S1, S2, S3):\n$$ x'_{\\text{G2,S1}} = 22 + 6 = 28 $$\n$$ x'_{\\text{G2,S2}} = 30 + 6 = 36 $$\n$$ x'_{\\text{G2,S3}} = 26 + 6 = 32 $$\nFor Batch 2 (S4, S5, S6):\n$$ x'_{\\text{G2,S4}} = 35 - 6 = 29 $$\n$$ x'_{\\text{G2,S5}} = 41 - 6 = 35 $$\n$$ x'_{\\text{G2,S6}} = 38 - 6 = 32 $$\nThe corrected expression row for G2 is [28, 36, 32, 29, 35, 32].\n\n**Step 3: Assemble the Final Matrix**\n\nWe now assemble the corrected rows for G1 and G2 into a final 2x6 matrix as requested. The first row corresponds to G1, and the second row corresponds to G2.\n$$\n\\text{Corrected Matrix} = \\begin{pmatrix}\n9 & 11 & 13 & 8 & 11 & 14 \\\\\n28 & 36 & 32 & 29 & 35 & 32\n\\end{pmatrix}\n$$", "answer": "$$\\boxed{\\begin{pmatrix} 9 & 11 & 13 & 8 & 11 & 14 \\\\ 28 & 36 & 32 & 29 & 35 & 32 \\end{pmatrix}}$$", "id": "1418467"}, {"introduction": "After applying a correction algorithm, a critical final step is to verify that the process has not inadvertently damaged the data. An overly aggressive correction can remove not only the technical batch effect but also the true biological variation you aim to study. This exercise [@problem_id:1418485] demonstrates how to perform a vital quality control check by leveraging prior biological knowledge. You will learn to use known \"housekeeping genes\" and disease biomarkers to visually confirm that the unwanted noise has been reduced while the meaningful biological signal remains intact.", "problem": "A systems biology researcher is conducting a transcriptomics study to compare gene expression profiles between tumor samples and adjacent healthy tissue samples from a cohort of patients. Due to the large number of samples, the ribonucleic acid (RNA) extraction and sequencing were performed in two separate experimental runs, or **batches**. The researcher suspects that this has introduced a **batch effect**—a systematic, non-biological variation that confounds the data.\n\nTo address this, the researcher applies a computational batch correction algorithm to the gene expression data. However, there is a concern that the algorithm might have been overly aggressive, potentially removing not only the unwanted technical variation but also the true biological differences between the tumor and healthy tissues. The researcher wants to perform a simple, non-statistical, visual check to ensure that the meaningful biological signal has been preserved after the correction.\n\nFor this purpose, the researcher has identified two sets of genes from prior literature:\n1.  **Housekeeping Genes**: A set of genes known to have stable expression levels across most cell types and conditions, including tumor and healthy tissue.\n2.  **Known Cancer Biomarkers**: A set of genes known to be significantly differentially expressed between this specific type of tumor and healthy tissue.\n\nWhich of the following approaches is the most appropriate visual check to confirm that the biological signal of interest was preserved during batch correction?\n\nA. Generate a heatmap of all genes for all samples, and visually inspect to see if the two batches form distinct clusters. If they do not, the biological signal is preserved.\n\nB. Use a dimensionality reduction technique like Principal Component Analysis (PCA) on the corrected data. Plot the samples on the first two principal components and color the points by their biological group (tumor vs. healthy). If the groups show clear separation, the biological signal is preserved.\n\nC. For a few selected Housekeeping Genes and a few selected Known Cancer Biomarkers, plot their expression levels for every sample. A successful correction that preserves the biological signal would show the Housekeeping Genes having similar expression across all samples, while the Known Cancer Biomarkers still show distinct expression levels between the tumor and healthy groups, regardless of their original batch.\n\nD. For each gene, calculate the average expression within the tumor group and the healthy group. Plot these averages against each other (tumor average vs. healthy average). If the points form a cloud around the $y=x$ line, the correction was unsuccessful. If they deviate significantly, the biological signal has been preserved.", "solution": "The objective is to verify that batch correction has removed non-biological batch-related variation while preserving the true biological differences between tumor and healthy tissues. A non-statistical, visual check should leverage prior biological knowledge and directly assess two criteria:\n1) Stability of expression for genes expected to be invariant across conditions (housekeeping genes).\n2) Preservation of known differential expression for genes that are biomarkers of the tumor type.\n\nEvaluate each proposed approach against these criteria:\n\n- Option A focuses on whether batches form clusters in a heatmap of all genes. While lack of batch clustering suggests batch effects were reduced, this does not address whether the tumor-versus-healthy biological signal was preserved. Moreover, using all genes dilutes the check, since many genes are irrelevant to the biological contrast.\n\n- Option B uses PCA with samples colored by tumor versus healthy. This is a common exploratory visualization, but it is indirect: the leading principal components may not capture the tumor–healthy contrast even if it is preserved, and separation can be influenced by residual confounders. It does not explicitly test the behavior of known stable genes and known biomarkers, despite those being available and most informative for this purpose.\n\n- Option C directly plots expression for selected housekeeping genes and known cancer biomarkers across all samples. A successful correction should yield housekeeping genes with similar expression across all samples (indicating removal of technical variation) and known biomarkers still showing distinct expression between tumor and healthy across batches (indicating preservation of biological signal). This is a targeted, non-statistical, visual validation that uses prior biological knowledge precisely aligned with the goal.\n\n- Option D compares tumor and healthy averages per gene and interprets proximity to the line $y=x$ as unsuccessful correction. This logic is flawed because most genes are not differentially expressed and should lie near $y=x$ even when the correction is successful. It also ignores the batch factor and does not leverage the curated gene sets.\n\nTherefore, the most appropriate visual check, given the stated goal and the availability of housekeeping and biomarker gene sets, is to use targeted plots demonstrating stability of housekeeping gene expression and preservation of differential expression in known biomarkers across batches, which is described in Option C.", "answer": "$$\\boxed{C}$$", "id": "1418485"}]}