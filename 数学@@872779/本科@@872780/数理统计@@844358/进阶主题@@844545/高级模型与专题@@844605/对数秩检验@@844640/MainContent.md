## 引言
在医学研究、工程[可靠性分析](@entry_id:192790)以及众多其他科学领域中，比较不同组别随时间推移的事件发生情况是一项核心任务。例如，在[临床试验](@entry_id:174912)中，我们想知道新疗法是否比标准疗法更能延长患者的生存期；在工业生产中，我们关心新材料制成的部件是否比旧材料更耐用。虽然[Kaplan-Meier曲线](@entry_id:178171)提供了生存经验的直观可视化，但它本身无法回答一个关键问题：我们观察到的生存曲线之间的差异，是真实效应的体现，还是仅仅源于[随机抽样](@entry_id:175193)带来的偶然波动？

为了解决这一知识空白，我们需要一种严谨的统计工具来量化证据，从而做出[科学推断](@entry_id:155119)。[对数秩检验](@entry_id:168043)（Log-rank Test）正是为这一目的而设计的黄金标准方法。它是一种[非参数检验](@entry_id:176711)，能够有力地比较两个或多个组的整个生存[分布](@entry_id:182848)，同时恰当地处理了[生存数据](@entry_id:165675)中普遍存在的删失问题。

本文将带领读者系统性地掌握[对数秩检验](@entry_id:168043)。在**“原理与机制”**一章中，我们将深入剖析该检验的核心思想——比较观测事件与期望事件，详细拆解其计算步骤，并探讨其与[Cox比例风险模型](@entry_id:174252)等核心统计理论的深刻联系。接下来，在**“应用与跨学科联系”**一章中，我们将展示[对数秩检验](@entry_id:168043)如何超越其经典的临床应用，在工程、生物信息学甚至商业分析等领域发挥作用，并讨论如何通过扩展模型[处理时间](@entry_id:196496)依赖性分组、[竞争风险](@entry_id:173277)等复杂数据。最后，通过**“动手实践”**部分的精选练习，您将有机会亲手计算和解释检验结果，将理论知识转化为实践技能。

## 原理与机制

在[生存分析](@entry_id:163785)领域，对不同组别（例如，接受不同治疗的患者群体）的生存经验进行比较是一项核心任务。虽然[Kaplan-Meier曲线](@entry_id:178171)为我们提供了生存概率随时间变化的直观视觉呈现，但我们需要一种严谨的统计方法来判断观测到的曲线差异是否具有[统计显著性](@entry_id:147554)，而不仅仅是由于随机抽样变异造成的。Log-rank检验（[对数秩检验](@entry_id:168043)）正是为此目的而设计的关键工具。本章将深入探讨log-rank检验的基本原理、计算机制、理论基础及其在复杂数据场景下的重要扩展。

### 核心假设：比较生存[分布](@entry_id:182848)

Log-rank检验的根本目标是比较两个或多个组别的 **整个生存[分布](@entry_id:182848)**。它并非简单地比较平均生存时间或[中位生存时间](@entry_id:634182)等单一指标，因为这些指标在存在[删失数据](@entry_id:173222)时可能难以准确估计，或无法完全捕捉组间差异的全貌。例如，在一个比较两种新金属合金（X和Y）涡轮[叶片寿命](@entry_id:199745)的工程研究中，研究人员关心的不仅仅是哪种合金的[平均寿命](@entry_id:195236)更长，而是它们的整体失效模式是否存在差异[@problem_id:1962139]。

因此，log-rank检验所评估的[原假设](@entry_id:265441)（null hypothesis, $H_0$）和[备择假设](@entry_id:167270)（alternative hypothesis, $H_1$）可以正式表述为：

- **[原假设](@entry_id:265441) $H_0$**：所有组别的生存[分布](@entry_id:182848)完全相同。如果用生存函数 $S(t)$（即生存时间超过 $t$ 的概率）来表示，那么对于任意两组（例如组1和组2），我们有 $H_0: S_1(t) = S_2(t)$ 对所有时间点 $t \ge 0$ 成立。

- **[备择假设](@entry_id:167270) $H_1$**：至少有两个组别的生存[分布](@entry_id:182848)在某个时间点上存在差异。即 $H_1: S_1(t) \neq S_2(t)$ 对于至少一个时间点 $t \ge 0$ 成立。

由于生存函数 $S(t)$ 和[风险函数](@entry_id:166593)（hazard function）$h(t)$ 之间存在[一一对应](@entry_id:143935)的关系（$h(t) = -\frac{d}{dt}\ln S(t)$），上述假设也可以等价地用[风险函数](@entry_id:166593)来表述：

- **$H_0$**: $h_1(t) = h_2(t)$ 对所有 $t \ge 0$ 成立。
- **$H_1$**: $h_1(t) \neq h_2(t)$ 对于至少一个 $t \ge 0$ 成立。

这个假设框架的普适性极强，无论是在评估p53[基因突变](@entry_id:262628)对肺癌患者预后的影响[@problem_id:1438443]，还是在临床试验中比较新疗法的效果，log-rank检验评估的都是生存曲线在整个观察期内是否一致的根本性问题。

### 检验的直觉：观测事件数与期望事件数

Log-rank检验的核心思想可以用一个非常直观的概念来概括：**在每个事件发生的时间点，比较各组实际发生的事件数（观测值）与在[原假设](@entry_id:265441)成立条件下预期会发生的事件数（[期望值](@entry_id:153208)）**。如果[原假设](@entry_id:265441)（即各组生存风险相同）为真，那么在任何一个事件发生时，该事件发生在任何一个特定组别的概率，应当只取决于该组别在当时“处于风险中”的人数占所有“处于风险中”总人数的比例。

让我们通过构建一个2x2[列联表](@entry_id:162738)来形式化这个想法。假设在某个特定的事件时间点 $t_j$，我们有以下信息：

| 组别 | 事件数 | 未发生事件数 | 风险集总人数 |
| :--- | :---: | :---: | :---: |
| 组 1 | $d_{1j}$ | $n_{1j} - d_{1j}$ | $n_{1j}$ |
| 组 2 | $d_{2j}$ | $n_{2j} - d_{2j}$ | $n_{2j}$ |
| **总计**| **$d_j$** | **$n_j - d_j$** | **$n_j$** |

- **风险集 (Risk Set)**：$n_{1j}$ 和 $n_{2j}$ 分别是组1和组2在时间点 $t_j$ 之前（紧邻该时间点）仍处于研究中且尚未经历事件或被删失的个体数量。$n_j = n_{1j} + n_{2j}$ 是该时刻的总风险人数。
- **事件数 (Events)**：$d_{1j}$ 和 $d_{2j}$ 是在时间点 $t_j$ 实际观测到发生事件的个体数量。$d_j = d_{1j} + d_{2j}$ 是该时刻的总事件数。

在原假设 $H_0$ 成立的条件下，这 $d_j$ 个事件中的每一个都“公平地”从 $n_j$ 个风险个体中产生。因此，我们预期发生在组1的事件数 **$E_{1j}$** 应为：

$E_{1j} = (\text{总事件数}) \times (\text{组1在风险集中的比例}) = d_j \times \frac{n_{1j}}{n_j}$

而组1实际观测到的事件数是 **$O_{1j} = d_{1j}$**。

Log-rank检验通过在 **所有不同的事件时间点** 上累加这种观测值与[期望值](@entry_id:153208)之间的差异 $(O_{1j} - E_{1j})$，来构建一个总的[检验统计量](@entry_id:167372)。如果这个累加的总差异显著偏离零，我们就有了拒绝原假设的证据。

### 计算机制

要执行log-rank检验，我们需要精确定义其统计量的分子和分母。

#### 风险集的构建

正确构建每个事件时间点的风险集是计算的基础。**风险集**在时间 $t$ 的定义是：所有在时间 $t$ 之前既未经历事件也未被删失的受试者集合。

让我们考虑一个在临床试验中的具体例子：一位患者在时间 $t_c$ 因非健康原因（如搬家）退出研究，其数据在 $t_c$ 被 **[右删失](@entry_id:164686) (right-censored)**。如果在该研究中，其他患者分别在 $t_{before}$ 和 $t_{after}$ 发生了不良事件，其中 $0  t_{before}  t_c  t_{after}$。那么，这位在 $t_c$ 被删失的患者：

- 在计算 $t_{before}$ 时刻的风险集时，**会被包含在内**，因为在 $t_{before}$ 时他/她仍然在被观察且未发生事件。
- 在计算 $t_{after}$ 时刻的风险集时，**则被排除在外**，因为在 $t_{after}$ 时他/她已经不再处于风险中（已被删失）[@problem_id:1962149]。

这个处理方式确保了每个受试者贡献的信息仅限于他们实际被观察到的时间段内，这是[生存分析](@entry_id:163785)能够有效处理[删失数据](@entry_id:173222)的关键。

#### 检验统计量的构建

标准的log-rank[检验统计量](@entry_id:167372)通常表示为 $Z^2 = \frac{U^2}{V}$，它近似服从自由度为1的卡方($\chi^2$)[分布](@entry_id:182848)。

**1. 统计量的分子 $U$**

分子 $U$ 是所有事件时间点上观测事件数与期望事件数之差的总和：

$U = \sum_{j=1}^{D} (O_{1j} - E_{1j}) = \sum_{j=1}^{D} \left(d_{1j} - d_j \frac{n_{1j}}{n_j}\right)$

其中，求和遍历所有 $D$ 个不同的事件时间点。

**2. 统计量的分母 $V$（[方差](@entry_id:200758)）**

分母 $V$ 是 $U$ 在原假设下的[方差](@entry_id:200758)，即 $\text{Var}(U)$。基于在不同事件时间点的统计量是[相互独立](@entry_id:273670)的假设，总[方差](@entry_id:200758)是每个时间点[方差](@entry_id:200758)的总和：$V = \sum_{j=1}^{D} \text{Var}(O_{1j})$。

在任何一个事件时间点 $t_j$，给定风险集大小（$n_{1j}, n_{2j}$）和总事件数 $d_j$，组1的事件数 $O_{1j}$ 服从 **[超几何分布](@entry_id:193745) (hypergeometric distribution)**。这个[分布](@entry_id:182848)描述了从一个包含两种类型物品的有限总体中不放回抽样的问题，完美契合了我们的情景。

[超几何分布](@entry_id:193745)的[方差](@entry_id:200758)公式为：

$\text{Var}(O_{1j}) = \frac{(\text{总样本量} - \text{抽样数})}{(\text{总样本量} - 1)} \times (\text{抽样数}) \times (\frac{\text{A类物品数}}{\text{总样本量}}) \times (1 - \frac{\text{A类物品数}}{\text{总样本量}})$

将我们的符号代入，可得：

$\text{Var}(O_{1j}) = \frac{n_j - d_j}{n_j - 1} \times d_j \times \frac{n_{1j}}{n_j} \times \frac{n_{2j}}{n_j} = \frac{d_j n_{1j} n_{2j} (n_j - d_j)}{n_j^2 (n_j - 1)}$

这个公式精确地处理了事件时间存在 **并列（ties）** 的情况（即 $d_j > 1$）。如果某个时间点没有并列事件（$d_j = 1$），则[方差](@entry_id:200758)简化为 $\text{Var}(O_{1j}) = \frac{n_{1j}n_{2j}}{n_j^2}$，这恰好是[伯努利试验](@entry_id:268355)的[方差](@entry_id:200758)。

因此，总[方差](@entry_id:200758)为：

$V = \sum_{j=1}^{D} \frac{d_j n_{1j} n_{2j} (n_j - d_j)}{n_j^2 (n_j - 1)}$

通过一个包含并列事件时间的数值例子，我们可以清晰地看到这个计算过程[@problem_id:1962150]。例如，在某时间点 $t=6$，风险集中有8人（组1和组2各4人），且同时发生2个事件（每组1个）。则该点的[方差](@entry_id:200758)贡献为 $\text{Var}(O_{1}) = 2 \cdot \frac{4}{8} \cdot \frac{4}{8} \cdot \frac{8-2}{8-1} = \frac{3}{7}$。将所有事件时间点的[方差](@entry_id:200758)贡献相加，即可得到总[方差](@entry_id:200758) $V$。

### 理论基础与关联

Log-rank检验不仅在直观上合理，其背后还有着坚实的[数理统计](@entry_id:170687)理论支撑。

#### 与[Cox比例风险模型](@entry_id:174252)的联系

一个深刻的联系是，**log-rank检验等价于[Cox比例风险模型](@entry_id:174252)（Cox Proportional Hazards Model）的[得分检验](@entry_id:171353)（Score Test）**[@problem_id:1953916]。

考虑一个简单的[Cox模型](@entry_id:164053) $h(t|x_i) = h_0(t) \exp(\beta x_i)$，其中 $x_i$ 是一个二元[协变](@entry_id:634097)量，代表分组（例如，$x_i=1$ 为治疗组，$x_i=0$ 为对照组）。检验治疗效果是否存在，即是检验[原假设](@entry_id:265441) $H_0: \beta=0$。

从该模型的偏似然函数（partial likelihood）出发推导出的、用于检验 $H_0: \beta=0$ 的得分检验统计量，其形式与log-rank[检验统计量](@entry_id:167372)完全一致。得分统计量的分子 $U(0)$ 正是 $\sum(O_{1j} - E_{1j})$，而其信息矩阵 $I(0)$ 则对应log-rank检验的[方差](@entry_id:200758) $V$。

这一等价性具有重要意义：
1.  它为log-rank检验提供了来自主流半参数[回归模型](@entry_id:163386)的理论背书。
2.  它揭示了log-rank检验最敏感的场景：当两组的[风险函数](@entry_id:166593)满足 **[比例风险假设](@entry_id:163597) (Proportional Hazards Assumption)** 时，即一个组的[风险函数](@entry_id:166593)在所有时间点上都是另一个组的常数倍（$h_2(t) = \theta h_1(t)$，其中 $\theta$ 是常数[风险比](@entry_id:173429)）。在这种情况下，log-rank检验是局部最优的（most powerful）检验方法[@problem_id:1962137]。

#### 鞅理论表述（高级）

对于寻求更深层次理论理解的读者，log-rank检验的统计特性可以通过 **[计数过程](@entry_id:260664) (counting process)** 和 **鞅论 (martingale theory)** 进行优雅地描述。

我们可以将组 $i$ 的事件发生[过程建模](@entry_id:183557)为[计数过程](@entry_id:260664) $N_i(t)$，将在险人数[过程建模](@entry_id:183557)为 $Y_i(t)$。在原假设 $H_0$（共同[风险函数](@entry_id:166593)为 $\lambda(t)$）下，$N_i(t)$ 的强度（intensity）为 $Y_i(t)\lambda(t)dt$。

此时，log-rank统计量的分子 $U$ 可以表示为一个[随机过程](@entry_id:159502)对另一个[随机过程](@entry_id:159502)的积分（Stieltjes积分）：
$Z = \int_{0}^{\tau} \left( dN_1(t) - \frac{Y_1(t)}{Y(t)} dN(t) \right)$
其中 $N(t) = N_1(t) + N_2(t)$，$Y(t) = Y_1(t) + Y_2(t)$。

通过[鞅](@entry_id:267779)理论可以证明，在原假设下，过程 $Z(t)$ 是一个 **均值为零的[鞅](@entry_id:267779)**[@problem_id:1962135]。这意味着在任何时候，该过程的[期望值](@entry_id:153208)都为零，即 $E[Z(\tau)] = 0$。这为 $U$ 的期望为零提供了严格的数学证明。

更进一步，利用[鞅中心极限定理](@entry_id:198119)，可以推导出在大样本下，[标准化](@entry_id:637219)后的统计量 $n^{-1/2}Z$ 收敛于一个正态分布，其均值为0，[渐近方差](@entry_id:269933)为：
$V_{asym} = \int_{0}^{\tau} \frac{\pi_{1}(t)\pi_{2}(t)}{\pi_{1}(t)+\pi_{2}(t)}\lambda(t)dt$
其中 $\pi_i(t)$ 是组 $i$ 在时间 $t$ 处于风险中的个体所占比例的[极限函数](@entry_id:157601)。这个表达式为离散的超几何[方差](@entry_id:200758)提供了连续时间下的理论对应，深刻揭示了检验统计量的[渐近性质](@entry_id:177569)。

### 扩展与高级应用

标准的log-rank检验在实际应用中可以进行多种扩展，以适应更复杂的[数据结构](@entry_id:262134)和研究问题。

#### 加权Log-rank检验

标准log-rank检验对所有事件时间点的 $(O-E)$ 差异给予相同的权重（权重为1）。然而，在某些情况下，我们可能希望对不同时期的事件赋予不同的重要性。例如，如果预期治疗效果主要体现在研究早期，我们可能想给早期的事件更大权重。

**$G^{\rho}$ 检验族** 提供了一个统一的框架来实现这一点[@problem_id:1962137]。其检验统计量为：
$U(\rho) = \sum_{j=1}^{D} W(t_j) (O_{1j} - E_{1j})$
其中权重函数 $W(t_j)$ 与合并样本的[Kaplan-Meier](@entry_id:169317)生存估计 $\hat{S}(t)$ 相关：$W(t_j) = [\hat{S}(t_j-)]^{\rho}$。

- **$\rho = 0$**: 权重 $W(t_j) = [\hat{S}(t_j-)]^0 = 1$。这正是 **标准log-rank检验**，对所有事件一视同仁，最适用于[比例风险](@entry_id:166780)的备择假设。
- **$\rho > 0$** (例如 $\rho=1$, Peto-Peto检验): 由于 $\hat{S}(t)$ 随时间递减，这会给 **早期事件** 更大的权重。当备择假设是生存曲线在早期就分离时，这类[检验功效](@entry_id:175836)更高。
- **$\rho  0$**: 这会给 **晚期事件** 更大的权重，适用于生存曲线在后期才分离的情况。

选择合适的权重至关重要。在某些特殊的[备择假设](@entry_id:167270)下，例如风险差异随时间变化且以某种方式“抵消”时，标准log-rank检验可能完全失去[检验功效](@entry_id:175836)（渐近功效为零）。但在这种情况下，一个经过恰当加权的检验（如Peto-Peto检验）可能仍然具有检测到差异的能力[@problem_id:1962145]。

#### 分层Log-rank检验

在多中心[临床试验](@entry_id:174912)或存在重要混杂因素（如年龄组、疾病分期）的研究中，直接合并所有数据进行比较可能会掩盖或扭曲真实的[处理效应](@entry_id:636010)。**分层log-rank检验 (stratified log-rank test)** 提供了一个解决方案。

其基本思想是：
1.  将所有受试者按[混杂变量](@entry_id:199777)（如临床中心）分成 $K$ 个 **层 (strata)**。
2.  在 **每一个层内部**，独立地计算观测值 $(O_k)$、[期望值](@entry_id:153208) $(E_k)$ 和[方差](@entry_id:200758) $(V_k)$。
3.  将各层的结果进行汇总，得到总的统计量：
    - 总的观测值-[期望值](@entry_id:153208)之差：$U_{strat} = \sum_{k=1}^{K} (O_k - E_k) = \sum_{k=1}^{K} \sum_{i} (d_{k,i,A} - E_{k,i,A})$
    - 总[方差](@entry_id:200758)：$V_{strat} = \sum_{k=1}^{K} V_k = \sum_{k=1}^{K} \sum_{i} \text{Var}(d_{k,i,A})$
4.  最终的[检验统计量](@entry_id:167372)为 $Z^2 = \frac{U_{strat}^2}{V_{strat}}$，它同样近似服从自由度为1的$\chi^2$[分布](@entry_id:182848)[@problem_id:1962152]。

分层检验的假设是，在每一层内，组间的[风险比](@entry_id:173429)是恒定的，但这个[风险比](@entry_id:173429)可以因层而异。它有效地控制了分层变量的混杂效应。

#### [竞争风险](@entry_id:173277)

在许多研究中，受试者可能经历多种类型的事件，这些事件相互排斥，一个事件的发生会阻止其他事件的发生。这被称为 **[竞争风险](@entry_id:173277) (competing risks)**。例如，在评估一种新疗法对疾病进展（事件1）的影响时，患者可能会因其他原因死亡（事件2），事件2就是一个[竞争风险](@entry_id:173277)。

当使用标准log-rank检验分析特定原因（如事件1）的风险时，通常的做法是将所有其他原因的事件（如事件2）视为删失。一个自然的问题是：这种处理方式是否有效，尤其是在两组的[竞争风险](@entry_id:173277)发生率不同的情况下？

理论分析表明，即使两组的竞争事件风险（$\lambda_2^{(A)}(t)$ 和 $\lambda_2^{(B)}(t)$）存在显著差异，只要我们关注的事件1的[原假设](@entry_id:265441)（$\lambda_1^{(A)}(t) = \lambda_1^{(B)}(t)$）成立，标准log-rank检验统计量的[期望值](@entry_id:153208)依然为零[@problem_id:1962154]。这意味着，该检验在控制 **[第一类错误](@entry_id:163360) (Type I error)** 方面仍然是有效的（即它不会错误地增加拒绝真实[原假设](@entry_id:265441)的概率）。

然而，需要注意的是，[竞争风险](@entry_id:173277)的差异会影响风险集的人员构成，从而改变检验的 **功效 (power)**。此外，对结果的解释也需要更加谨慎。在这种情况下，我们比较的是 **特定原因[风险函数](@entry_id:166593) (cause-specific hazard functions)**，而[Kaplan-Meier](@entry_id:169317)方法估计的“生存函数”实际上反映的是在未发生任何事件的情况下存活的概率，其解释变得复杂。更合适的分析工具可能是针对累积发生率函数(Cumulative Incidence Functions)的检验，例如Gray's test。

综上所述，log-rank检验是一个强大而灵活的工具，其原理植根于对每个事件时间点的风险进行比较。理解其计算机制、理论基础以及各种扩展形式，对于在实践中正确应用和解读[生存分析](@entry_id:163785)结果至关重要。