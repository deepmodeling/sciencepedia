## 引言
在经典的[统计推断](@entry_id:172747)中，我们往往依赖于固定样本量的方法，即在分析开始前就确定所需数据的规模。然而，在[临床试验](@entry_id:174912)、工业生产或互联网A/B测试等众多现实场景中，数据是逐步、连续到达的。在这种情况下，等待收集完所有预设数据不仅耗时，还可能错失关键的决策时机，造成资源浪费。序贯分析（Sequential Analysis）正是为了解决这一挑战而生，它提供了一套动态、高效的决策框架，允许我们在数据收集的过程中随时评估证据，做出最及时的判断。

本文将带领您深入探索序贯分析的世界。在“原理与机制”一章中，我们将揭示其核心工具——[序贯概率比检验](@entry_id:176474)（SPRT）的工作方式，学习如何构建检验并评估其性能。接着，在“应用与[交叉](@entry_id:147634)学科联系”一章中，我们将展示序贯分析如何在工业质量控制、生物医学研究和商业决策等领域大放异彩。最后，通过“动手实践”部分，您将有机会亲手应用这些理论，巩固所学知识。通过本文的学习，您将掌握这一强大的统计方法，学会在信息不断累积的过程中，以最有效的方式做出科学、及时的判断。

## 原理与机制

在经典的[假设检验框架](@entry_id:165093)中，我们通常预先固定样本量，然后一次性收集所有数据进行分析。然而，在许多现实场景中，数据是逐个或分批次获得的。例如，在[临床试验](@entry_id:174912)中，患者的反应是随时间陆续出现的；在工业生产线上，产品是连续不断地被检验的。在这些情况下，等待收集完一个庞大的预设样本可能会延迟关键决策，造成不必要的时间和资源浪费。序贯分析（Sequential Analysis）为此提供了一个强大而高效的替代方案，它允许我们在每个新数据点获得后都重新评估证据，并动态地决定是立即做出结论，还是继续收集更多数据。本章将深入探讨序贯分析的核心原理和机制，重点介绍其最经典的方法——[序贯概率比检验](@entry_id:176474)（Sequential Probability Ratio Test, SPRT）。

### [序贯概率比检验](@entry_id:176474) (SPRT)

[序贯概率比检验](@entry_id:176474)是由 Abraham Wald 在第二次世界大战期间为解决军事物资的高效抽检问题而发展的。其核心思想是，在检验两个简单假设 $H_0: \theta = \theta_0$ 和 $H_1: \theta = \theta_1$ 时，我们不断累积证据，直到有足够把握接受其中一个假设为止。

#### [检验统计量](@entry_id:167372)：似然比

假设我们观测一个[独立同分布](@entry_id:169067)（i.i.d.）的[随机变量](@entry_id:195330)序列 $X_1, X_2, \dots$。在收集了 $n$ 个观测值后，我们可以构建关于这两个假设的[似然函数](@entry_id:141927)。在 $H_1$ 为真时的似然函数为 $L_n(\theta_1) = \prod_{i=1}^n f(X_i; \theta_1)$，在 $H_0$ 为真时的[似然函数](@entry_id:141927)为 $L_n(\theta_0) = \prod_{i=1}^n f(X_i; \theta_0)$，其中 $f(x; \theta)$ 是单个观测值的概率密度函数或[概率质量函数](@entry_id:265484)。

SPRT 的核心是**[似然比](@entry_id:170863) (Likelihood Ratio)** 统计量：
$$
\Lambda_n = \frac{L_n(\theta_1)}{L_n(\theta_0)} = \frac{\prod_{i=1}^n f(X_i; \theta_1)}{\prod_{i=1}^n f(X_i; \theta_0)}
$$
这个比值 $\Lambda_n$ 直观地衡量了当前数据支持 $H_1$ 相对于 $H_0$ 的证据强度。如果 $\Lambda_n$ 很大，说明数据在 $H_1$ 下出现的可能性远大于在 $H_0$ 下，我们就有理由倾向于 $H_1$；反之亦然。

为了计算方便，我们通常使用**[对数似然比](@entry_id:274622) (Log-Likelihood Ratio)**：
$$
S_n = \ln(\Lambda_n) = \sum_{i=1}^n \ln \left( \frac{f(X_i; \theta_1)}{f(X_i; \theta_0)} \right) = \sum_{i=1}^n Z_i
$$
其中 $Z_i = \ln \left( \frac{f(X_i; \theta_1)}{f(X_i; \theta_0)} \right)$ 是第 $i$ 个观测值对总证据的贡献。由于 $X_i$ 是[独立同分布](@entry_id:169067)的，所以 $Z_i$ 也是[独立同分布](@entry_id:169067)的[随机变量](@entry_id:195330)。这表明，[对数似然比](@entry_id:274622) $S_n$ 的演变过程是一个**[随机游走](@entry_id:142620) (Random Walk)**。

#### 决策法则

SPRT 的决策过程非常直观。我们设定两个边界，一个上边界 $A$ 和一个下边界 $B$，其中 $0 \lt B \lt 1 \lt A$。在每一步观测后，我们计算似然比 $\Lambda_n$，并遵循以下规则：

1.  如果 $\Lambda_n \ge A$，则停止检验，并**拒绝 $H_0$**（即接受 $H_1$）。
2.  如果 $\Lambda_n \le B$，则停止检验，并**接受 $H_0$**。
3.  如果 $B \lt \Lambda_n \lt A$，则证据尚不充分，**继续抽样**。

在使用[对数似然比](@entry_id:274622)时，这个法则等价于比较 $S_n$ 与两个对数边界 $a = \ln A$ 和 $b = \ln B$（其中 $b \lt 0 \lt a$）。

**示例：检验[伯努利分布](@entry_id:266933)的参数**
考虑一个移动应用的新功能可能导致应用崩溃率增加的情景 [@problem_id:1954182]。历史崩溃率为 $p_0 = 0.05$（$H_0$），而不可接受的高崩溃率为 $p_1 = 0.20$（$H_1$）。每次用户会话是一个[伯努利试验](@entry_id:268355)，结果为“崩溃”或“成功”。
在 $n$ 次会话中，若观测到 $k$ 次崩溃和 $n-k$ 次成功，则[似然函数](@entry_id:141927)为 $L(p) = p^k (1-p)^{n-k}$。[对数似然比](@entry_id:274622)为：
$$
S_n = \ln\left(\frac{p_1^k (1-p_1)^{n-k}}{p_0^k (1-p_0)^{n-k}}\right) = k \ln\left(\frac{p_1}{p_0}\right) + (n-k) \ln\left(\frac{1-p_1}{1-p_0}\right)
$$
假设在 $n=15$ 次会话后，记录到 $k=5$ 次崩溃。则检验统计量的值为：
$$
S_{15} = 5 \ln\left(\frac{0.20}{0.05}\right) + (15-5) \ln\left(\frac{1-0.20}{1-0.05}\right) = 5\ln(4) + 10\ln\left(\frac{0.80}{0.95}\right) \approx 5.188
$$
如果预设的对数上边界 $a=2.95$，那么此时 $S_{15} \approx 5.188 \gt 2.95$，我们将停止检验并得出结论：新功能显著增加了崩溃率，需要回滚。

### 构建一个SPRT：设定边界

决策边界 $A$ 和 $B$ 的选择直接决定了检验的性能，即犯错的概率。在假设检验中，我们关注两类错误：
*   **[第一类错误](@entry_id:163360) (Type I Error)**：当 $H_0$ 为真时，错误地拒绝了 $H_0$。其概率记为 $\alpha$。
*   **[第二类错误](@entry_id:173350) (Type II Error)**：当 $H_1$ 为真时，错误地接受了 $H_0$。其概率记为 $\beta$。

Wald 证明了，为了达到预设的错误率 $(\alpha, \beta)$，[决策边界](@entry_id:146073)可以通过以下非常简洁的近似公式来设定：
$$
A \approx \frac{1-\beta}{\alpha} \quad \text{and} \quad B \approx \frac{\beta}{1-\alpha}
$$
这些被称为 **Wald 近似 (Wald's Approximations)**。它们是近似的，因为在推导中忽略了[随机游走](@entry_id:142620) $S_n$ 在停止时可能会“越过”边界而不是恰好停在边界上的那一小部分，即所谓的**超射 (overshoot)**。然而，在大多数实际应用中，这种近似非常精确，足以指导实践。

例如，一个半导体制造商希望通过 SPRT 来控制 CPU 的次品率，设定 $H_0: p=0.02$ 和 $H_1: p=0.08$ [@problem_id:1954145]。如果管理层设定的可接受风险为 $\alpha = 0.04$ 和 $\beta = 0.07$，则检验的边界应设为：
$$
A \approx \frac{1-0.07}{0.04} = \frac{0.93}{0.04} = 23.25
$$
$$
B \approx \frac{0.07}{1-0.04} = \frac{0.07}{0.96} \approx 0.07292
$$
检验员将在似然比超过 $23.25$ 时判定为低质量批次，在[似然比](@entry_id:170863)低于 $0.07292$ 时判定为高质量批次。

### SPRT 的几何视图与实施

抽象的似然比边界对于一线操作人员来说可能不够直观。幸运的是，在许多常见[分布](@entry_id:182848)（如伯努利、正态、指数分布）中，SPRT 的决策区域可以转化为关于累计统计量的线性边界，从而极大地简化了实施。

以最常见的伯努利试验为例，我们已经知道[对数似然比](@entry_id:274622) $S_n$ 是关于成功次数（或缺陷数）$k_n$ 和试验次数 $n$ 的线性函数 [@problem_id:1954141]。[决策边界](@entry_id:146073) $S_n = \ln C$（其中 $C$ 是 $A$ 或 $B$）可以被重写为关于成功次数 $k_n$ 的表达式：
$$
k_n \ln\left(\frac{p_1}{p_0}\right) + (n-k_n) \ln\left(\frac{1-p_1}{1-p_0}\right) = \ln C
$$
整理后可得：
$$
k_n \left[ \ln\left(\frac{p_1}{p_0}\right) - \ln\left(\frac{1-p_1}{1-p_0}\right) \right] = \ln C - n \ln\left(\frac{1-p_1}{1-p_0}\right)
$$
这可以表示为两条[平行线](@entry_id:169007) $k_n = s \cdot n + c$ 的形式，其中斜率 $s$ 和截距 $c$ 为：
*   **公共斜率 $s$**: $s = \frac{\ln\left(\frac{1-p_0}{1-p_1}\right)}{\ln\left(\frac{p_1(1-p_0)}{p_0(1-p_1)}\right)}$
*   **接受域截距 $c_0$** (对应 $\ln B$): $c_0 = \frac{\ln\left(\frac{\beta}{1-\alpha}\right)}{\ln\left(\frac{p_1(1-p_0)}{p_0(1-p_1)}\right)}$
*   **[拒绝域](@entry_id:172793)截距 $c_1$** (对应 $\ln A$): $c_1 = \frac{\ln\left(\frac{1-\beta}{\alpha}\right)}{\ln\left(\frac{p_1(1-p_0)}{p_0(1-p_1)}\right)}$

这样，检验过程就变成了一个简单的图表作业：在 $(n, k_n)$ 平面上画出这两条线，然后每进行一次试验，就在图上描一个点。只要点在这两条线之间，就继续试验。一旦点触及或越过下面那条线，就接受 $H_0$；一旦触及或越过上面那条线，就拒绝 $H_0$。

### SPRT 的性能评估

一个好的检验程序不仅要准确，还要高效。SPRT 的性能主要通过两个函数来刻画：**操作特征 (OC) 函数**和**[平均样本数 (ASN)](@entry_id:174445) 函数**。

#### 操作特征 (OC) 函数

**操作特征 (OC) 函数**，记作 $L(\theta)$，定义为当真实参数为 $\theta$ 时，SPRT 最终做出“接受 $H_0$”决策的概率。
$$
L(\theta) = P(\text{接受 } H_0 \mid \text{真实参数为 } \theta)
$$
这个函数完整地描述了检验在所有可能真实情况下的行为。根据其定义和 $\alpha, \beta$ 的含义，我们有：
*   $L(\theta_0) = P(\text{接受 } H_0 \mid H_0 \text{ 为真}) = 1 - P(\text{拒绝 } H_0 \mid H_0 \text{ 为真}) = 1 - \alpha$
*   $L(\theta_1) = P(\text{接受 } H_0 \mid H_1 \text{ 为真}) = \beta$

对于任何一个特定的参数值 $p'$，如果计算出 $L(p')=0.4$，其实际意义是：如果该批次产品的真实合格率恰好是 $p'$，那么进行序贯检验后，有 40% 的可能性我们会得出结论说该批次仅符合标准质量要求（即接受 $H_0$），而有 $1-0.4=0.6$ 的可能性我们会得出结论说该批次是优等品（即拒绝 $H_0$）[@problem_id:1954180]。

#### [平均样本数 (ASN)](@entry_id:174445) 函数

**[平均样本数 (ASN)](@entry_id:174445) 函数**，记作 $E_\theta[N]$，表示当真实参数为 $\theta$ 时，SPRT 平均需要多少个样本才能做出决策。这是衡量检验效率的核心指标。

**ASN 函数的形状**：一个非常有趣且重要的特性是，ASN 函数通常不是单调的 [@problem_id:1954125]。当真实参数 $\theta$ 恰好等于 $\theta_0$ 或 $\theta_1$ 时，ASN 值相对较小。这是因为此时数据提供的证据具有明确的“倾[向性](@entry_id:144651)”。[对数似然比](@entry_id:274622)的增量 $Z_i$ 的期望 $E_\theta[Z_i]$（即[随机游走](@entry_id:142620)的“漂移”）会显著地不为零（在 $\theta=\theta_0$ 时为负，在 $\theta=\theta_1$ 时为正），从而推动 $S_n$ 快速地走向其中一个边界。

然而，当真实参数 $\theta$ 处于 $\theta_0$ 和 $\theta_1$ 之间的某个值 $\theta^*$ 时，证据会变得非常“模棱两可”。此时，每次观测对 $H_0$ 和 $H_1$ 的支持度可能相差无几，导致 $Z_i$ 的期望 $E_{\theta^*}[Z_i]$ 接近于零。[随机游走](@entry_id:142620) $S_n$ 几乎没有系统性的漂移，就像一个醉汉在原地徘徊，需要很长时间才能偶然撞到其中一个边界。因此，ASN 函数在 $\theta_0$ 和 $\theta_1$ 之间达到其峰值。这个现象可以用一个经典的“赌徒破产”问题来类比：一个赌本为 $a$ 的赌徒与一个赌本为 $b$ 的对手进行公平赌博（每次输赢概率各 0.5），其期望的赌局次数为 $ab$ [@problem_id:1954170]。这个零漂移的[对称随机游走](@entry_id:273558)，正对应了SPRT在最不确定情况下耗时最长的情形。

**ASN 的计算**：利用 Wald 等式，可以得到 ASN 的一个近似表达式：
$$
E_\theta[N] \approx \frac{L(\theta) \ln B + (1-L(\theta)) \ln A}{E_\theta[Z_i]}
$$
其中 $E_\theta[Z_i]$ 是单个[对数似然比](@entry_id:274622)增量的期望。这个公式在计算特定场景（如[生物信息学](@entry_id:146759)中根据[核苷酸](@entry_id:275639)序列区分菌株）下的预期样本量时非常有用 [@problem_id:1954191]。

### SPRT 的最优性与效率

SPRT 最吸引人的地方在于其卓越的效率。**Wald-Wolfowitz 定理**指出：在所有具有相同或更小[错误概率](@entry_id:267618) $(\alpha, \beta)$ 的检验中，SPRT 在 $H_0$ 和 $H_1$ 为真时，所需平均样本数 $E_{\theta_0}[N]$ 和 $E_{\theta_1}[N]$ 都是最小的。

这意味着，相比于传统的固定样本量检验，SPRT 在达到相同决策精度的情况下，平均而言能节省大量样本。这种节省在真实情况与 $H_0$ 或 $H_1$ 高度吻合时尤为显著。

例如，考虑检验[正态分布](@entry_id:154414)均值 $\mu$ 是 $\mu_0=100$ 还是 $\mu_1=101$（已知 $\sigma=2$），并要求 $\alpha=0.05, \beta=0.10$ [@problem_id:1954148]。
*   一个**固定样本检验**需要约 $n=35$ 个样本才能达到此精度。
*   而 **SPRT** 在真实均值为 $\mu_0=100$ 的情况下，平均仅需约 $E_0[N]=16$ 个样本。

所需样本量的比率约为 $16/35 \approx 0.46$，这意味着 SPRT 平均能节省超过 50% 的样本量。这种效率提升在成本高昂或耗时良久的测试中具有巨大的实用价值。

### 实际考量与扩展

理论上，SPRT 保证以概率 1 终止，但其样本数 $N$ 是一个[随机变量](@entry_id:195330)，没有确定的上界。这在实践中可能导致问题。

#### 截断 SPRT

为了避免测试运行时间过长，实际应用中通常采用**截断SPRT (Truncated SPRT)**。即设定一个最大样本量 $N_{max}$。如果检验在达到 $N_{max}$ 之前没有自然停止，则强制终止，并根据一个预设的终端规则做出决策。一个常见的终端规则是：在 $n=N_{max}$ 时，如果最终的[对数似然比](@entry_id:274622) $S_{N_{max}} \gt 0$，则拒绝 $H_0$；如果 $S_{N_{max}} \le 0$，则接受 $H_0$ [@problem_id:1954172]。引入截断会轻微改变实际的错误率 $\alpha$ 和 $\beta$，但保证了检验一定会在有限时间内完成。

#### [复合假设](@entry_id:164787)的挑战

标准 SPRT 的优雅和最优性是建立在检验两个**简单假设**的基础上的。当面对**[复合假设](@entry_id:164787)**，特别是“简单vs复合”的情形（例如 $H_0: \mu = \mu_0$ vs $H_1: \mu \neq \mu_0$），直接应用 SPRT 会遇到根本性的困难。

一个看似自然的推广是**广义序贯[似然比检验](@entry_id:268070) (GSLRT)**，其检验统计量为：
$$
Z_n = \ln \left( \frac{\sup_{\mu \neq \mu_0} L_n(\mu)}{L_n(\mu_0)} \right)
$$
对于正态分布均值的双边检验，这个统计量可以简化为 $Z_n = \frac{n}{2\sigma^2}(\bar{X}_n - \mu_0)^2$。然而，这个统计量在 $H_0$ 为真时的行为与标准 SPRT 完全不同。在 $H_0$ 为真时，该统计量 $Z_n$ 的[期望值](@entry_id:153208) $E_0[Z_n]$ 是一个正常数（具体为 1/2），而不是像标准SPRT在原假设为真时那样具有负的期望 [@problem_id:1954174]。这意味着 $Z_n$ 在 $H_0$ 下没有向接受域（下边界）漂移的趋势，反而会因为随机波动而倾向于增大。因此，这种简单的推广会导致检验几乎永远不会因为达到下边界而终止并接受 $H_0$。

解决[复合假设](@entry_id:164787)的序贯检验问题需要更复杂的检验程序，例如基于加权函数的检验或分阶段抽样方案，这些是序贯分析领域更深入的研究课题。