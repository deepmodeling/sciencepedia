{"hands_on_practices": [{"introduction": "Understanding how HLA haplotypes are inherited is fundamental to transplantation medicine, particularly for finding suitable donors among family members. This problem challenges you to apply core principles of Mendelian genetics to the unique context of the MHC region [@problem_id:5055655]. By calculating the probability of two siblings being HLA-identical, you will see how meiotic recombination slightly reduces the classic $1/4$ chance, providing a more accurate, real-world estimate.", "problem": "A couple is being evaluated for sibling Human Leukocyte Antigen (HLA) matching across the classical loci HLA-A, HLA-B, and HLA-DRB1, which reside within the Major Histocompatibility Complex (MHC) on chromosome $6$. Each parent carries two distinct HLA haplotypes defined across these typed loci: the father has haplotypes $H_1$ and $H_2$, and the mother has haplotypes $H_3$ and $H_4$, with $H_1$, $H_2$, $H_3$, and $H_4$ all mutually different at the typed loci.\n\nUse the following foundational principles:\n- Mendelian segregation: each child independently receives one haplotype from the father and one from the mother, with probability $1/2$ for each haplotype per parent.\n- Meiotic recombination: treat the three typed loci together as a single haplotype block with an overall recombination fraction $r$ per meiosis such that a gamete is nonrecombinant with probability $(1-r)$ and recombinant with probability $r$. Assume independent meioses for different conceptions and for the two parents.\n- High polymorphism and locus density: assume that if recombination occurs within this block, the resulting recombinant haplotype differs from the nonrecombinant parental haplotypes and that the probability two independent recombinations produce identical recombinant haplotypes across all typed loci is negligible.\n\nUnder these assumptions, derive from first principles the probability that two independently conceived full siblings are fully HLA-identical across HLA-A, HLA-B, and HLA-DRB1. Then, using $r = 0.02$, compute the numerical value of this probability and express the final result as a decimal fraction. Round your answer to four significant figures.", "solution": "The user wants me to solve a problem in medical genetics.\n\nHere's my plan:\n1.  **Validate the problem statement.**\n    *   **Step 1: Extract Givens:** I will list all the information provided in the problem.\n        *   Parents: Father and Mother.\n        *   Loci: $HLA\\text{-}A$, $HLA\\text{-}B$, and $HLA\\text{-}DRB1$ on chromosome $6$.\n        *   Father's haplotypes: $H_1$ and $H_2$. They are distinct.\n        *   Mother's haplotypes: $H_3$ and $H_4$. They are distinct.\n        *   All four parental haplotypes ($H_1, H_2, H_3, H_4$) are mutually different.\n        *   Mendelian segregation: A child receives one haplotype from each parent, each with probability $1/2$. This principle is further refined by the recombination model.\n        *   Meiotic recombination: The three loci are treated as a single haplotype block.\n        *   Recombination fraction: $r$ per meiosis.\n        *   Probability of a nonrecombinant gamete: $1-r$.\n        *   Probability of a recombinant gamete: $r$.\n        *   Independent meioses for different conceptions and for the two parents.\n        *   Assumption about recombination: If recombination occurs, the resulting haplotype differs from the nonrecombinant parental haplotypes. The probability that two independent recombinations produce identical recombinant haplotypes is negligible.\n        *   Goal: Derive the probability that two full siblings are fully HLA-identical across the three loci.\n        *   Numerical value: Calculate this probability for $r = 0.02$.\n        *   Final format: Decimal fraction rounded to four significant figures.\n\n    *   **Step 2: Validate Using Extracted Givens:**\n        *   **Scientifically Grounded?** Yes. The problem is based on fundamental principles of Mendelian genetics, including segregation, independent assortment (between parents), and meiotic recombination. The context of HLA genetics is appropriate and common for such problems. The specified loci are standard in clinical HLA typing.\n        *   **Well-Posed?** Yes. All necessary parameters ($r$, parental haplotypes) and simplifying assumptions (uniqueness of recombinants, independent meioses) are provided. The objective is clearly stated. A unique probabilistic solution exists.\n        *   **Objective?** Yes. The language is formal and precise, typical of a scientific problem statement. It is free from subjectivity.\n        *   **Invalidity Checklist:**\n            1.  **Scientific or Factual Unsoundness:** None. The model is a standard, albeit simplified, representation of genetic inheritance.\n            2.  **Non-Formalizable or Irrelevant:** None. The problem is directly formalizable using probability theory and is relevant to medical genetics.\n            3.  **Incomplete or Contradictory Setup:** None. The problem is self-contained and internally consistent.\n            4.  **Unrealistic or Infeasible:** None. The value of $r=0.02$ is a plausible recombination frequency for the MHC region. The assumptions are standard for introductory genetics problems.\n            5.  **Ill-Posed or Poorly Structured:** None. The question is unambiguous.\n            6.  **Pseudo-Profound, Trivial, or Tautological:** None. The problem requires a careful application of probability rules in a non-trivial context (i.e., including recombination).\n            7.  **Outside Scientific Verifiability:** None. The result is verifiable within the given mathematical model.\n\n    *   **Step 3: Verdict and Action:** The problem is deemed **valid**. I will proceed with the full solution.\n\n2.  **Solve the problem.**\n    The problem asks for the probability that two independently conceived full siblings are fully HLA-identical. This means they must have the same pair of HLA haplotypes.\n\n    Let the father's genotype be represented as the pair of haplotypes $(H_1, H_2)$ and the mother's as $(H_3, H_4)$. The problem states that $H_1, H_2, H_3, H_4$ are all distinct.\n\n    A child's genotype is formed by inheriting one haplotype from the father and one from the mother. The process of gamete formation in each parent is subject to meiotic recombination with a recombination fraction $r$.\n\n    First, let's determine the probabilities of different types of gametes produced by a single parent, for instance, the father with genotype $(H_1, H_2)$. According to the problem statement, a gamete is nonrecombinant with probability $(1-r)$ and recombinant with probability $r$. In a large pool of gametes from this parent, the haplotypes $H_1$ and $H_2$ are expected to be present in equal proportions. Therefore, a gamete will contain a nonrecombinant haplotype $H_1$ with probability $\\frac{1-r}{2}$ and a nonrecombinant haplotype $H_2$ with probability $\\frac{1-r}{2}$. The remaining probability, $r$, corresponds to the formation of recombinant haplotypes. Let's denote a recombinant haplotype from the father as $R_F$.\n\n    So, for a child, the probability of inheriting a specific haplotype from the father is:\n    -   $P(\\text{inherits } H_1) = \\frac{1-r}{2}$\n    -   $P(\\text{inherits } H_2) = \\frac{1-r}{2}$\n    -   $P(\\text{inherits any recombinant } R_F) = r$\n\n    Similarly, for the mother with genotype $(H_3, H_4)$, the probabilities are:\n    -   $P(\\text{inherits } H_3) = \\frac{1-r}{2}$\n    -   $P(\\text{inherits } H_4) = \\frac{1-r}{2}$\n    -   $P(\\text{inherits any recombinant } R_M) = r$\n\n    Let Sibling 1 ($S_1$) and Sibling 2 ($S_2$) be two independently conceived children. Let their genotypes be $G_1 = (H_{p1}, H_{m1})$ and $G_2 = (H_{p2}, H_{m2})$, where $H_{pi}$ is the haplotype inherited from the father and $H_{mi}$ is the haplotype inherited from the mother for sibling $i \\in \\{1, 2\\}$.\n\n    The siblings are fully HLA-identical if their genotypes are identical, i.e., $G_1 = G_2$. Since the parental haplotypes are all distinct ($H_1, H_2, H_3, H_4$), and recombinant haplotypes are assumed to be unique and distinct from parental ones, a paternal haplotype can never be identical to a maternal haplotype. Therefore, for the genotypes to be identical, the siblings must have inherited the same haplotype from the father AND the same haplotype from the mother. That is, $G_1=G_2$ if and only if $H_{p1} = H_{p2}$ and $H_{m1} = H_{m2}$.\n\n    The inheritances from the father and mother are independent events. Thus, the probability of the siblings being identical is:\n    $P(G_1 = G_2) = P(H_{p1} = H_{p2} \\text{ and } H_{m1} = H_{m2})$\n    $P(G_1 = G_2) = P(H_{p1} = H_{p2}) \\times P(H_{m1} = H_{m2})$\n\n    Let's calculate the probability that both siblings inherit the same haplotype from the father, $P(H_{p1} = H_{p2})$. This can occur if both inherit $H_1$, or both inherit $H_2$, or both inherit the *same* recombinant haplotype.\n    -   The probability that both inherit $H_1$ is $P(H_{p1}=H_1) \\times P(H_{p2}=H_1) = \\left(\\frac{1-r}{2}\\right) \\times \\left(\\frac{1-r}{2}\\right) = \\frac{(1-r)^2}{4}$.\n    -   The probability that both inherit $H_2$ is $P(H_{p1}=H_2) \\times P(H_{p2}=H_2) = \\left(\\frac{1-r}{2}\\right) \\times \\left(\\frac{1-r}{2}\\right) = \\frac{(1-r)^2}{4}$.\n    -   The probability that both inherit a recombinant haplotype is $P(H_{p1} \\text{ is recombinant and } H_{p2} \\text{ is recombinant}) = r \\times r = r^2$. However, the problem explicitly states that \"the probability two independent recombinations produce identical recombinant haplotypes...is negligible.\" This means that even if both siblings inherit a recombinant haplotype, the probability that these two haplotypes are identical is $0$. Therefore, this path does not contribute to the siblings being identical.\n\n    The total probability of inheriting the same haplotype from the father is the sum of the probabilities for the mutually exclusive events of inheriting $H_1$ or $H_2$:\n    $P(H_{p1} = H_{p2}) = \\frac{(1-r)^2}{4} + \\frac{(1-r)^2}{4} = 2 \\times \\frac{(1-r)^2}{4} = \\frac{(1-r)^2}{2}$.\n\n    The inheritance process for the mother is identical. Therefore, the probability that both siblings inherit the same haplotype from the mother is also:\n    $P(H_{m1} = H_{m2}) = \\frac{(1-r)^2}{2}$.\n\n    Now, we can find the total probability that the two siblings are fully HLA-identical:\n    $P(\\text{identical}) = P(H_{p1} = H_{p2}) \\times P(H_{m1} = H_{m2}) = \\left(\\frac{(1-r)^2}{2}\\right) \\times \\left(\\frac{(1-r)^2}{2}\\right) = \\frac{(1-r)^4}{4}$.\n\n    This is the general formula derived from first principles. As a check, for the case of no recombination ($r=0$), the probability becomes $\\frac{(1-0)^4}{4} = \\frac{1}{4}$, which is the classic Mendelian probability for fully matched siblings.\n\n    Now, we must compute the numerical value for $r = 0.02$.\n    $P(\\text{identical}) = \\frac{(1 - 0.02)^4}{4} = \\frac{(0.98)^4}{4}$.\n    Let's compute the value:\n    $(0.98)^2 = 0.9604$.\n    $(0.98)^4 = (0.9604)^2 = 0.92236816$.\n    $P(\\text{identical}) = \\frac{0.92236816}{4} = 0.23059204$.\n\n    The problem requires the answer to be rounded to four significant figures. The first four significant figures are $2$, $3$, $0$, $5$. The fifth significant figure is $9$, which is greater than or equal to $5$, so we round up the last significant digit.\n    $0.23059204 \\approx 0.2306$.", "answer": "$$\n\\boxed{0.2306}\n$$", "id": "5055655"}, {"introduction": "Once we understand the patterns of inheritance, the next step is to accurately determine an individual's specific HLA alleles—a process called HLA typing. This practice places you in the role of a clinical geneticist tasked with interpreting two different types of lab reports: one from an older, protein-based method and one from modern DNA sequencing [@problem_id:5055675]. By resolving the discrepancies between these reports, you will gain a practical understanding of key concepts like null alleles and serologic ambiguity, and appreciate why high-resolution molecular typing is now the standard of care.", "problem": "A laboratory evaluates an organ transplant candidate by two independent assays of Human Leukocyte Antigen (HLA) genes in the Major Histocompatibility Complex (MHC). The first is serologic typing using complement-dependent cytotoxicity (CDC), which detects cell-surface protein epitopes with antigen-specific antisera. The second is molecular typing by polymerase chain reaction (PCR) sequence-based typing (SBT), which reads coding-region deoxyribonucleic acid (DNA) sequences to infer alleles.\n\nUse the following foundational facts:\n- By the Central Dogma of Molecular Biology, DNA is transcribed to ribonucleic acid (RNA) and translated to protein, and cell-surface expression of a protein requires a functional open reading frame.\n- Classical class I HLA loci (HLA-A, HLA-B, HLA-C) and class II HLA loci (for example, HLA-DRB1, HLA-DQB1) are codominantly expressed, so in the absence of loss-of-function alleles, both parental alleles are present on the cell surface.\n- Serologic typing detects shared epitopes (antigenic specificities) on proteins; different alleles that encode identical or highly similar epitope structures can be indistinguishable by serology. Molecular typing distinguishes alleles by their DNA sequence, including synonymous and non-expressed (null) variants.\n\nThe patient’s results are:\n- Serologic typing (CDC):\n  - HLA-A: A2\n  - HLA-B: B7, B62\n  - HLA-C: Cw6\n  - HLA-DR: DR4, DR53\n  - HLA-DQ: DQ8\n- Molecular typing (PCR SBT):\n  - HLA-A: A*02:01, A*02:09\n  - HLA-B: B*07:02, B*15:01\n  - HLA-C: C*06:02, C*07:02N\n  - HLA-DRB1: DRB1*04:01; HLA-DRB4: DRB4*01:03\n  - HLA-DQB1: DQB1*03:02\n\nWhich one of the following interpretations most accurately explains the observed pattern and highlights a key limitation of serologic typing relative to molecular typing?\n\nA. The presence of an HLA-C null allele led to apparent serologic homozygosity at HLA-C, whereas molecular typing detected the null allele, and two distinct HLA-A alleles within the A2 serogroup are indistinguishable by serology.\n\nB. Serology is inherently higher resolution than molecular typing for HLA-B and correctly identified B*07:02 versus B*15:01, which molecular typing missed.\n\nC. The discrepancy at HLA-A suggests a sequencing artifact; serology is the gold standard for distinguishing A*02:01 from A*02:09.\n\nD. The presence of DR53 by serology indicates a novel HLA-DRB1 allele not detectable by molecular typing.\n\nE. Molecular typing cannot detect expression differences; only serology can identify null alleles.", "solution": "The user has requested a critical validation of the problem statement, followed by a detailed solution and evaluation of the provided options.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n\nThe problem provides the following information:\n\n-   **Assay 1 (Serologic Typing - CDC):** Detects cell-surface protein epitopes using antigen-specific antisera.\n-   **Assay 2 (Molecular Typing - PCR SBT):** Reads coding-region deoxyribonucleic acid (DNA) sequences to infer alleles.\n-   **Foundational Fact 1 (Central Dogma):** DNA is transcribed to ribonucleic acid (RNA) and translated to protein. Cell-surface expression requires a functional open reading frame.\n-   **Foundational Fact 2 (Codominant Expression):** Classical class I (HLA-A, HLA-B, HLA-C) and class II (e.g., HLA-DRB1, HLA-DQB1) loci are codominantly expressed. In the absence of loss-of-function alleles, both parental alleles are expressed.\n-   **Foundational Fact 3 (Method Comparison):** Serology detects shared epitopes; different alleles may be indistinguishable. Molecular typing distinguishes alleles by DNA sequence, including synonymous and non-expressed (null) variants.\n-   **Patient Results (Serologic):**\n    -   HLA-A: A2\n    -   HLA-B: B7, B62\n    -   HLA-C: Cw6\n    -   HLA-DR: DR4, DR53\n    -   HLA-DQ: DQ8\n-   **Patient Results (Molecular):**\n    -   HLA-A: A*02:01, A*02:09\n    -   HLA-B: B*07:02, B*15:01\n    -   HLA-C: C*06:02, C*07:02N\n    -   HLA-DRB1: DRB1*04:01; HLA-DRB4: DRB4*01:03\n    -   HLA-DQB1: DQB1*03:02\n-   **Question:** Which interpretation most accurately explains the observed pattern and highlights a key limitation of serologic typing relative to molecular typing?\n\n**Step 2: Validate Using Extracted Givens**\n\n-   **Scientifically Grounded:** The problem is based on fundamental principles of medical genetics and immunology, specifically the HLA system. The description of serologic and molecular typing methods is accurate. The concept of codominant expression, null alleles (indicated by the 'N' suffix in standard nomenclature), serologic groups versus specific alleles, and the genetic organization of the HLA-DR region (including loci like DRB1 and DRB4) are all established scientific facts.\n-   **Well-Posed:** The problem presents two sets of experimental data and asks for the best interpretation based on provided principles. The discrepancies between the two datasets are the core of the problem and are explainable, leading to a unique, correct interpretation.\n-   **Objective:** The problem is phrased in precise, objective, technical language. The data are presented without bias.\n-   **Completeness and Consistency:** The problem provides all necessary information to resolve the apparent discrepancies. The foundational facts serve as the rules for interpretation. The data are internally consistent with known principles of HLA genetics (e.g., the correspondence between serotype B62 and allele group B15, the existence of the A*02 serogroup containing multiple alleles, and the DR4-DR53 association via the DRB1 and DRB4 loci).\n\n**Step 3: Verdict and Action**\n\nThe problem statement is **valid**. It is scientifically sound, well-posed, and provides a clear basis for deriving a solution. The solution process may now proceed.\n\n### Derivation and Option Analysis\n\nThe task is to reconcile the serologic and molecular typing results, focusing on discrepancies that reveal the limitations of serology. We will analyze the results locus by locus.\n\n**1. Locus-by-Locus Analysis**\n\n-   **HLA-A:** Serology reports A2, suggesting homozygosity. Molecular typing reveals heterozygosity for two distinct alleles, A*02:01 and A*02:09. Both of these alleles encode proteins that carry the A2 epitope. This demonstrates a key limitation of serology: its resolution is insufficient to distinguish between different alleles that express the same or very similar surface antigens. This is a case of \"antigen splitting\" where molecular typing provides higher resolution.\n\n-   **HLA-B:** Serology reports two antigens, B7 and B62. Molecular typing reports two alleles, B*07:02 and B*15:01. The allele B*07:02 encodes the B7 antigen. The allele B*15:01 encodes the B62 antigen (B62 is a serologic \"split\" of the broader B15 antigen group). The results are concordant.\n\n-   **HLA-C:** Serology reports only Cw6, suggesting homozygosity. Molecular typing, however, identifies two different alleles: C*06:02 and C*07:02N.\n    -   C*06:02 codes for the Cw6 protein, which is detected by serology.\n    -   C*07:02N is a *null allele*, indicated by the 'N' suffix. As stated in the foundational facts, a functional protein is not produced from this allele. Since serology detects cell-surface proteins, it cannot detect the product of a null allele.\n    -   This leads to \"apparent homozygosity\" in the serologic result. This is a critical limitation of serology: it cannot detect alleles that are not expressed on the cell surface.\n\n-   **HLA-DR:** Serology reports DR4 and DR53. Molecular typing reports DRB1*04:01 and DRB4*01:03. The DR4 specificity is encoded by the DRB1*04:01 allele at the DRB1 locus. The DR53 specificity is encoded by the DRB4*01:03 allele, which is at a separate locus, DRB4, that is frequently inherited along with certain DRB1 alleles like DR4. The results are concordant and illustrate the complex genetics of the Class II region, which molecular typing clarifies. The single DRB1 allele reported may indicate homozygosity or a partial typing result; however, the provided data are consistent.\n\n-   **HLA-DQ:** Serology reports DQ8. Molecular typing reports DQB1*03:02. The DQB1*03:02 allele encodes a protein with the DQ8 specificity. The results are concordant.\n\n**2. Synthesis and Evaluation of Options**\n\nThe analysis reveals two major discrepancies that highlight the limitations of serology:\n-   At HLA-A, serology has lower resolution than molecular typing.\n-   At HLA-C, serology fails to detect a null allele, giving a misleading result of homozygosity.\n\nWe now evaluate each option against this understanding.\n\n**A. The presence of an HLA-C null allele led to apparent serologic homozygosity at HLA-C, whereas molecular typing detected the null allele, and two distinct HLA-A alleles within the A2 serogroup are indistinguishable by serology.**\n-   **Justification:** This statement precisely and correctly describes the two key findings from our analysis. It identifies the \"apparent serologic homozygosity\" at HLA-C caused by the null allele C*07:02N, which was correctly identified by molecular typing. It also correctly identifies the situation at HLA-A, where serology could not distinguish between two different alleles (A*02:01 and A*02:09) within the same serogroup (A2). This option perfectly captures the pattern and highlights fundamental limitations of serology.\n-   **Verdict:** **Correct**.\n\n**B. Serology is inherently higher resolution than molecular typing for HLA-B and correctly identified B*07:02 versus B*15:01, which molecular typing missed.**\n-   **Justification:** This statement is factually incorrect. First, molecular typing is inherently of higher resolution than serology, as it analyzes the underlying DNA sequence. Second, molecular typing did *not* miss the distinction; it reported B*07:02 and B*15:01, which correspond perfectly to the serotypes B7 and B62. The premise is false.\n-   **Verdict:** **Incorrect**.\n\n**C. The discrepancy at HLA-A suggests a sequencing artifact; serology is the gold standard for distinguishing A*02:01 from A*02:09.**\n-   **Justification:** This statement reverses the roles of the technologies. The discrepancy at HLA-A is a well-known feature of the A2 serogroup, not an artifact. Serology is fundamentally incapable of distinguishing alleles like A*02:01 and A*02:09 because they encode highly similar protein epitopes. DNA sequencing (molecular typing) is the definitive method—the \"gold standard\"—for making such a distinction.\n-   **Verdict:** **Incorrect**.\n\n**D. The presence of DR53 by serology indicates a novel HLA-DRB1 allele not detectable by molecular typing.**\n-   **Justification:** This interpretation is incorrect. DR53 is a well-known serologic specificity that is not encoded by the DRB1 locus. It is encoded by the DRB4 locus. The molecular typing result, DRB4*01:03, is the specific allele that codes for the DR53 antigen. Therefore, molecular typing *did* detect the genetic basis for the DR53 serotype; it is not a novel or missed allele.\n-   **Verdict:** **Incorrect**.\n\n**E. Molecular typing cannot detect expression differences; only serology can identify null alleles.**\n-   **Justification:** This statement is the exact opposite of reality. Molecular typing identifies null alleles by finding mutations in the DNA sequence (e.g., premature stop codons, frameshifts) that are known to prevent protein expression; the 'N' suffix is a direct result of this molecular identification. Conversely, serology *cannot* identify null alleles because it looks for the protein product, which is absent. The absence of an expected antigen is merely suggestive, not definitive, evidence for a null allele from a serologic perspective.\n-   **Verdict:** **Incorrect**.", "answer": "$$\\boxed{A}$$", "id": "5055675"}, {"introduction": "The extreme diversity of the HLA system is not random; it has been shaped by selection pressures from infectious diseases, which also results in many HLA alleles being associated with autoimmune disorders. This hands-on exercise guides you through the fundamental statistical workflow used to discover these associations in population studies [@problem_id:5055656]. You will implement key statistical tests and correction methods to analyze case-control data, learning to distinguish true genetic signals from statistical noise and to classify alleles as conferring risk, protection, or no effect.", "problem": "You are to write a complete program that implements a principled statistical workflow to test associations between alleles of the human leukocyte antigen (HLA) within the major histocompatibility complex (MHC) and a binary disease status. The task must be formulated purely in mathematical and algorithmic terms as follows.\n\nFundamental base and definitions to be used:\n- A $2\\times 2$ contingency table for a single allele encodes counts for cases and controls by allele presence:\n  - Let $a$ be the number of cases with the allele.\n  - Let $b$ be the number of controls with the allele.\n  - Let $c$ be the number of cases without the allele.\n  - Let $d$ be the number of controls without the allele.\n  - Let $N = a + b + c + d$ be the grand total, $n = a + c$ be the number of cases, and $K = a + b$ be the total with the allele.\n- Under the null hypothesis of independence (no association), and conditioning on the fixed margins $(N,n,K)$, the probability of observing a specific top-left cell count $X = x$ is the hypergeometric probability\n  $$P(X=x) = \\frac{\\binom{K}{x}\\binom{N-K}{n-x}}{\\binom{N}{n}}.$$\n- The two-sided Fisher exact test $p$-value for an observed table with $X=a$ is the sum of probabilities of all feasible tables with probability less than or equal to the observed table’s probability:\n  $$p = \\sum_{x \\in \\mathcal{S}} P(X=x), \\quad \\mathcal{S} = \\{x: P(X=x) \\le P(X=a)\\},$$\n  where the feasible support satisfies $x \\in [\\max(0, n-(N-K)), \\min(n, K)]$.\n- The odds ratio (OR) quantifies direction and magnitude of association. Compute the odds ratio as\n  $$\\operatorname{OR} = \\frac{a\\,d}{b\\,c},$$\n  except that if any of $a,b,c,d$ equals $0$, apply the Haldane–Anscombe correction by adding $0.5$ to each cell and then compute\n  $$\\operatorname{OR}_{\\mathrm{HA}} = \\frac{(a+0.5)(d+0.5)}{(b+0.5)(c+0.5)}.$$\n- Multiple testing control across $m$ alleles within a test case must use one of:\n  - Bonferroni correction at familywise error rate $\\alpha$: declare significant those alleles with $p \\le \\alpha/m$.\n  - Benjamini–Hochberg (BH) procedure at false discovery rate target $q$: let $p_{(1)} \\le \\cdots \\le p_{(m)}$ be the ordered $p$-values, find the largest $k$ such that $p_{(k)} \\le (k/m)\\,q$, and declare the $k$ corresponding hypotheses with the $k$ smallest $p$-values significant.\n\nProgram requirements:\n- For each test case, you must:\n  $1.$ Compute the two-sided Fisher exact test $p$-value for each allele table using the above hypergeometric model.\n  $2.$ Apply the specified multiple testing procedure (Bonferroni or BH) using the provided error-rate target ($\\alpha$ for Bonferroni or $q$ for BH) over all alleles in that test case.\n  $3.$ Classify each allele into one of three integer-encoded outcomes based on statistical significance and direction by the odds ratio:\n    - Return $+1$ if the allele is significant and $\\operatorname{OR} > 1$ (risk-associated).\n    - Return $-1$ if the allele is significant and $\\operatorname{OR} < 1$ (protective).\n    - Return $0$ if the allele is not significant (regardless of $\\operatorname{OR}$), or if $\\operatorname{OR} = 1$ exactly under the non-corrected calculation, or equals $1$ after applying the Haldane–Anscombe correction when required.\n- Angle units and physical units are not involved in this problem.\n- All returned numerical values must be integers as defined above.\n\nTest suite:\nProvide your program with the following three test cases, each comprising a list of $2 \\times 2$ tables and a multiple testing configuration. For each $2 \\times 2$ table, the tuple $(a,b,c,d)$ is given in that order.\n\n- Test case $1$:\n  - Method: \"bh\" (Benjamini–Hochberg).\n  - Target $q = 0.05$.\n  - Allele tables:\n    $1.$ $(a,b,c,d) = (30, 10, 70, 90)$,\n    $2.$ $(a,b,c,d) = (5, 30, 95, 70)$,\n    $3.$ $(a,b,c,d) = (12, 11, 88, 89)$.\n- Test case $2$:\n  - Method: \"bonferroni\".\n  - Target $\\alpha = 0.10$.\n  - Allele tables:\n    $1.$ $(a,b,c,d) = (0, 20, 100, 80)$,\n    $2.$ $(a,b,c,d) = (25, 25, 75, 75)$,\n    $3.$ $(a,b,c,d) = (1, 0, 99, 100)$.\n- Test case $3$:\n  - Method: \"bh\" (Benjamini–Hochberg).\n  - Target $q = 0.10$.\n  - Allele tables:\n    $1.$ $(a,b,c,d) = (35, 15, 65, 85)$,\n    $2.$ $(a,b,c,d) = (30, 18, 70, 82)$,\n    $3.$ $(a,b,c,d) = (26, 20, 74, 80)$,\n    $4.$ $(a,b,c,d) = (18, 22, 82, 78)$.\n\nFinal output specification:\n- For each test case, output a list of integers in the same order as the input allele tables, using the encoding $+1$ for risk, $-1$ for protective, $0$ for not significant.\n- Aggregate the lists for all test cases into a single list, preserving test case order.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For example, if a program produced three per-test-case lists $[1,0]$, $[0,-1,1]$, and $[0]$, then the final line must be exactly \"[[1,0],[0,-1,1],[0]]\".", "solution": "The user requires a program to perform a statistical analysis of genetic association data based on a series of $2 \\times 2$ contingency tables. The analysis involves calculating Fisher's exact test $p$-values, computing odds ratios, applying multiple testing corrections, and classifying alleles based on the results.\n\n### Principle-Based Design and Algorithmic Workflow\n\nThe solution is structured as a sequence of well-defined statistical and computational steps, adhering to the principles outlined in the problem statement.\n\n#### 1. Data Representation and Core Statistical Measures\n\n- **Contingency Table**: Each allele's data is given as a tuple $(a, b, c, d)$ representing the counts in a $2 \\times 2$ table:\n  - Row 1: Allele Present (Cases: $a$, Controls: $b$)\n  - Row 2: Allele Absent (Cases: $c$, Controls: $d$)\n- **Odds Ratio (OR)**: The odds ratio is a measure of effect size. It is calculated as $\\operatorname{OR} = (a \\cdot d) / (b \\cdot c)$. If any cell count is zero, the Haldane–Anscombe correction is applied by adding $0.5$ to each cell, yielding $\\operatorname{OR}_{\\mathrm{HA}} = ((a+0.5)(d+0.5)) / ((b+0.5)(c+0.5))$. An $\\operatorname{OR} > 1$ suggests a risk association, while an $\\operatorname{OR} < 1$ suggests a protective association. An $\\operatorname{OR} = 1$ indicates no association.\n\n#### 2. Fisher's Exact Test for Statistical Significance\n\nThe core of the significance testing is Fisher's exact test, which is appropriate for contingency tables, especially with small cell counts. The test is based on the hypergeometric distribution.\n\n- **Null Hypothesis ($H_0$)**: The presence or absence of the allele is independent of the disease status (case vs. control).\n- **Conditional Model**: Under $H_0$, if we fix the marginal totals of the table (total cases, total controls, total with allele, total without allele), the number of cases with the allele (the count $a$) follows a hypergeometric distribution.\n- **Hypergeometric Probability**: The probability of observing a count of $x$ in the top-left cell is given by:\n  $$P(X=x) = \\frac{\\binom{K}{x}\\binom{N-K}{n-x}}{\\binom{N}{n}}$$\n  where $n = a+c$ is the total number of cases, $K = a+b$ is the total number of individuals with the allele, and $N = a+b+c+d$ is the grand total. The variable $x$ can range over its feasible support, $[\\max(0, n-(N-K)), \\min(n, K)]$. Computationally, this probability mass function (PMF) is implemented using `scipy.stats.hypergeom.pmf`.\n- **Two-Sided $p$-value**: The $p$-value represents the probability of observing a result at least as extreme as the actual observed table, assuming the null hypothesis is true. For a two-sided test, this is calculated by summing the probabilities of all possible tables (i.e., all feasible values of $x$) that are as probable or less probable than the observed table:\n  $$p = \\sum_{x \\in \\mathcal{S}} P(X=x), \\quad \\text{where } \\mathcal{S} = \\{x: P(X=x) \\le P(X=a)\\}$$\n  This summation is performed over the entire support of the distribution.\n\n#### 3. Multiple Testing Correction\n\nWhen performing multiple statistical tests simultaneously (one for each allele), the probability of making a Type I error (a false positive) across the entire family of tests is inflated. To control this, a correction procedure is necessary.\n\n- **Bonferroni Correction**: This method controls the Family-Wise Error Rate (FWER), the probability of making at least one Type I error. It is a conservative method where the significance threshold for each individual test, $\\alpha_{\\text{ind}}$, is adjusted to $\\alpha / m$, where $\\alpha$ is the desired FWER and $m$ is the number of tests. An allele is declared significant if its $p$-value is less than or equal to this adjusted threshold: $p \\le \\alpha/m$.\n- **Benjamini–Hochberg (BH) Procedure**: This method controls the False Discovery Rate (FDR), the expected proportion of false positives among all significant results. It is generally more powerful than the Bonferroni correction. The procedure is as follows:\n  1. Rank the $m$ $p$-values in ascending order: $p_{(1)} \\le p_{(2)} \\le \\cdots \\le p_{(m)}$.\n  2. Find the largest integer $k$ such that the $k$-th ranked $p$-value satisfies $p_{(k)} \\le \\frac{k}{m}q$, where $q$ is the target FDR.\n  3. Declare the $k$ alleles corresponding to the smallest $k$ $p$-values ($p_{(1)}, \\dots, p_{(k)}$) as statistically significant.\n\n#### 4. Allele Classification\n\nBased on the statistical significance and the direction of effect (from the odds ratio), each allele is classified into one of three categories:\n\n- **Risk ($+1$)**: The association is statistically significant after multiple testing correction, and the odds ratio is greater than $1$.\n- **Protective ($-1$)**: The association is statistically significant, and the odds ratio is less than $1$.\n- **No Association ($0$)**: The association is not statistically significant, or the odds ratio is exactly $1$. The $\\operatorname{OR}=1$ condition takes precedence, as it represents a perfect null effect, making a significance test moot.\n\n### Implementation Strategy\n\nThe program implements this workflow systematically for each provided test case.\n\n1.  A `solve()` function encapsulates the entire process.\n2.  For each test case, it initializes lists to store calculated $p$-values and odds ratios.\n3.  It iterates through each allele table in the test case:\n    a. A helper function `calculate_or` computes the odds ratio, correctly applying the Haldane-Anscombe correction for zero-valued cells.\n    b. A helper function `fisher_exact_p_value` implements the two-sided Fisher's test as defined, by summing probabilities from the hypergeometric PMF over the appropriate set $\\mathcal{S}$.\n4.  After processing all alleles in a test case, it applies the specified multiple testing correction (`bonferroni` or `bh`) to the collected $p$-values to generate a list of booleans indicating significance. The BH procedure requires careful handling of $p$-value ranks and original indices to ensure correct mapping of significance back to the original alleles.\n5.  Finally, it iterates through the results, applying the classification rules to produce the final integer-coded output for the test case.\n6.  The results from all test cases are aggregated into a list of lists and formatted into the precise string representation required for the final answer.\n\nThis structured, principle-based approach ensures correctness, robustness, and adherence to the problem's stringent requirements.", "answer": "```python\nimport numpy as np\nfrom scipy.stats import hypergeom\n\ndef solve():\n    \"\"\"\n    Main function to run the HLA association analysis for the given test suite.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"method\": \"bh\",\n            \"target\": 0.05,\n            \"tables\": [\n                (30, 10, 70, 90),\n                (5, 30, 95, 70),\n                (12, 11, 88, 89),\n            ]\n        },\n        {\n            \"method\": \"bonferroni\",\n            \"target\": 0.10,\n            \"tables\": [\n                (0, 20, 100, 80),\n                (25, 25, 75, 75),\n                (1, 0, 99, 100),\n            ]\n        },\n        {\n            \"method\": \"bh\",\n            \"target\": 0.10,\n            \"tables\": [\n                (35, 15, 65, 85),\n                (30, 18, 70, 82),\n                (26, 20, 74, 80),\n                (18, 22, 82, 78),\n            ]\n        }\n    ]\n\n    final_results = []\n\n    for case in test_cases:\n        method = case[\"method\"]\n        target_level = case[\"target\"]\n        tables = case[\"tables\"]\n        num_alleles = len(tables)\n\n        p_values = []\n        odds_ratios = []\n\n        for a, b, c, d in tables:\n            # 1. Compute Odds Ratio\n            odds_ratios.append(calculate_or(a, b, c, d))\n\n            # 2. Compute Fisher's Exact Test P-value\n            p_values.append(fisher_exact_p_value(a, b, c, d))\n\n        # 3. Apply Multiple Testing Correction\n        is_significant = apply_multiple_testing_correction(p_values, method, target_level)\n\n        # 4. Classify alleles\n        case_results = []\n        for i in range(num_alleles):\n            or_val = odds_ratios[i]\n            is_sig = is_significant[i]\n\n            # Rule: OR=1 is always classified as 0.\n            if or_val == 1.0:\n                classification = 0\n            elif not is_sig:\n                classification = 0\n            elif is_sig and or_val > 1.0:\n                classification = 1\n            elif is_sig and or_val < 1.0:\n                classification = -1\n            else: # Should not be reached with valid inputs\n                classification = 0\n            \n            case_results.append(classification)\n        \n        final_results.append(case_results)\n    \n    # Final print statement in the exact required format '[[...],[...]]'\n    print(str(final_results).replace(\" \", \"\"))\n\ndef calculate_or(a, b, c, d):\n    \"\"\"\n    Computes the odds ratio for a 2x2 contingency table.\n    Applies Haldane-Anscombe correction if any cell is zero.\n    \"\"\"\n    if a == 0 or b == 0 or c == 0 or d == 0:\n        # Haldane-Anscombe correction\n        or_val = ((a + 0.5) * (d + 0.5)) / ((b + 0.5) * (c + 0.5))\n    else:\n        or_val = (a * d) / (b * c)\n    return or_val\n\ndef fisher_exact_p_value(a, b, c, d):\n    \"\"\"\n    Computes the two-sided Fisher's exact test p-value using the hypergeometric distribution.\n    The p-value is the sum of probabilities of all tables with a probability\n    less than or equal to the observed table's probability.\n    \"\"\"\n    N_total = a + b + c + d\n    n_cases_total = a + c\n    K_allele_total = a + b\n\n    # Map to scipy's hypergeom(M, n, N) notation:\n    # M: total number of objects (population size)\n    # n: total number of type I objects (alleles in population)\n    # N: size of the sample (number of cases)\n    M_pop, n_typeI, N_sample = N_total, K_allele_total, n_cases_total\n\n    # Define the support of the distribution for the top-left cell count 'x'\n    support_min = max(0, N_sample - (M_pop - n_typeI))\n    support_max = min(N_sample, n_typeI)\n\n    # Probability of the observed table (X=a)\n    # Use a small tolerance for floating-point comparisons\n    p_observed = hypergeom.pmf(a, M_pop, n_typeI, N_sample)\n    \n    p_value = 0.0\n    for x in range(support_min, support_max + 1):\n        p_x = hypergeom.pmf(x, M_pop, n_typeI, N_sample)\n        if p_x <= p_observed + 1e-12:  # Sum probabilities of tables as or more extreme\n            p_value += p_x\n            \n    return p_value\n\ndef apply_multiple_testing_correction(p_values, method, target_level):\n    \"\"\"\n    Applies the specified multiple testing correction procedure.\n    \"\"\"\n    m = len(p_values)\n    is_significant = [False] * m\n\n    if method == \"bonferroni\":\n        threshold = target_level / m\n        for i in range(m):\n            if p_values[i] <= threshold:\n                is_significant[i] = True\n    \n    elif method == \"bh\":\n        # Sort p-values while keeping track of original indices\n        indexed_p_values = sorted(enumerate(p_values), key=lambda x: x[1])\n        \n        q = target_level\n        largest_k = 0\n        # Find the largest k such that p(k) <= (k/m)*q\n        for i in range(m - 1, -1, -1):\n            rank = i + 1\n            original_index, p_val = indexed_p_values[i]\n            if p_val <= (rank / m) * q:\n                largest_k = rank\n                break\n        \n        # Mark the k smallest p-values as significant\n        for i in range(largest_k):\n            original_index, _ = indexed_p_values[i]\n            is_significant[original_index] = True\n            \n    return is_significant\n\nsolve()\n```", "id": "5055656"}]}