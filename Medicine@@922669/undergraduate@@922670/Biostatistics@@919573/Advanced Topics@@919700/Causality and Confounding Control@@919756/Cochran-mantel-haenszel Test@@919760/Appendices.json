{"hands_on_practices": [{"introduction": "Understanding the Cochran-Mantel-Haenszel (CMH) test begins with mastering its fundamental calculation. The test's power lies in its ability to aggregate evidence across different strata, comparing the observed frequency of an event to what would be expected if there were no underlying association. This practice will ground you in the mechanics of the CMH test statistic, $Q_{MH}$, by guiding you step-by-step through its construction from raw contingency table data. [@problem_id:4900624]", "problem": "An investigator studies the association between a binary exposure and a binary disease outcome across $3$ clinically defined strata (for example, age groups), yielding three $2 \\times 2$ contingency tables with stratum-specific cell counts given as $(a_k,b_k,c_k,d_k)$ for $k \\in \\{1,2,3\\}$. The observed counts are $(a_1,b_1,c_1,d_1)=(12,8,18,22)$, $(a_2,b_2,c_2,d_2)=(5,15,20,10)$, and $(a_3,b_3,c_3,d_3)=(9,11,13,27)$. Define the stratum $k$ row totals $m_{1k}=a_k+b_k$ and $m_{0k}=c_k+d_k$, the column totals $n_{1k}=a_k+c_k$ and $n_{0k}=b_k+d_k$, and the grand total $n_k=m_{1k}+m_{0k}=n_{1k}+n_{0k}$.\n\nUnder the null hypothesis of no exposure–outcome association within each stratum (that is, a common odds ratio equal to $1$), conditional on the fixed margins $(m_{1k},m_{0k},n_{1k},n_{0k})$, the cell count $a_k$ follows the hypergeometric model with expected value $E[a_k]=\\frac{m_{1k}n_{1k}}{n_k}$ and variance $\\operatorname{Var}(a_k)=\\frac{m_{1k}m_{0k}n_{1k}n_{0k}}{n_k^{2}(n_k-1)}$. Starting from this stratified hypergeometric framework, construct the Cochran–Mantel–Haenszel (CMH) test statistic $Q_{MH}$ for testing a common odds ratio of $1$ by aggregating the stratum-specific deviations $a_k-E[a_k]$ and their variances across strata. Compute the numeric value of $Q_{MH}$ from the data above and briefly interpret it in terms of the large-sample reference distribution.\n\nRound your final numeric answer for $Q_{MH}$ to four significant figures. No units are required.", "solution": "The problem statement is well-defined, scientifically sound, and provides all necessary information to compute the Cochran-Mantel-Haenszel test statistic. I will therefore proceed with the solution.\n\nThe Cochran–Mantel–Haenszel (CMH) test is used to test for an association between a binary exposure and a binary outcome, while adjusting for one or more categorical confounding variables (strata). The null hypothesis, $H_0$, is that there is no association between the exposure and the outcome within any of the strata, which corresponds to a common odds ratio (OR) of $1$ across all strata.\n\nThe CMH test statistic, $Q_{MH}$, aggregates information across $K$ strata. For each stratum $k$ (where $k=1, \\dots, K$), the data can be represented in a $2 \\times 2$ contingency table:\n\n$$\n\\begin{array}{c|cc|c}\n & \\text{Outcome +} & \\text{Outcome -} & \\text{Total} \\\\\n\\hline\n\\text{Exposed} & a_k & b_k & m_{1k} \\\\\n\\text{Unexposed} & c_k & d_k & m_{0k} \\\\\n\\hline\n\\text{Total} & n_{1k} & n_{0k} & n_k\n\\end{array}\n$$\n\nThe problem states that under the null hypothesis, conditional on the marginal totals $(m_{1k}, m_{0k}, n_{1k}, n_{0k})$, the count $a_k$ follows a hypergeometric distribution. The expectation and variance of $a_k$ are given by:\n$$E[a_k] = \\frac{m_{1k}n_{1k}}{n_k}$$\n$$\\operatorname{Var}(a_k) = \\frac{m_{1k}m_{0k}n_{1k}n_{0k}}{n_k^{2}(n_k-1)}$$\n\nThe CMH statistic is constructed by summing the deviations of the observed counts $a_k$ from their expected values $E[a_k]$ across all strata, and then comparing the square of this sum to the sum of the variances. The formula for the uncorrected CMH statistic is:\n$$Q_{MH} = \\frac{\\left( \\sum_{k=1}^{K} (a_k - E[a_k]) \\right)^2}{\\sum_{k=1}^{K} \\operatorname{Var}(a_k)}$$\n\nWe are given data for $K=3$ strata. We will compute the necessary quantities for each stratum.\n\n**Stratum 1:**\nThe observed counts are $(a_1, b_1, c_1, d_1) = (12, 8, 18, 22)$.\nThe marginal totals are:\n$m_{11} = a_1 + b_1 = 12 + 8 = 20$\n$m_{01} = c_1 + d_1 = 18 + 22 = 40$\n$n_{11} = a_1 + c_1 = 12 + 18 = 30$\n$n_{01} = b_1 + d_1 = 8 + 22 = 30$\n$n_1 = m_{11} + m_{01} = 20 + 40 = 60$\n\nThe expected value of $a_1$ under $H_0$ is:\n$$E[a_1] = \\frac{m_{11}n_{11}}{n_1} = \\frac{20 \\times 30}{60} = 10$$\nThe variance of $a_1$ is:\n$$\\operatorname{Var}(a_1) = \\frac{m_{11}m_{01}n_{11}n_{01}}{n_1^{2}(n_1-1)} = \\frac{20 \\times 40 \\times 30 \\times 30}{60^2 (60-1)} = \\frac{720000}{3600 \\times 59} = \\frac{200}{59}$$\nThe deviation is $a_1 - E[a_1] = 12 - 10 = 2$.\n\n**Stratum 2:**\nThe observed counts are $(a_2, b_2, c_2, d_2) = (5, 15, 20, 10)$.\nThe marginal totals are:\n$m_{12} = a_2 + b_2 = 5 + 15 = 20$\n$m_{02} = c_2 + d_2 = 20 + 10 = 30$\n$n_{12} = a_2 + c_2 = 5 + 20 = 25$\n$n_{02} = b_2 + d_2 = 15 + 10 = 25$\n$n_2 = m_{12} + m_{02} = 20 + 30 = 50$\n\nThe expected value of $a_2$ under $H_0$ is:\n$$E[a_2] = \\frac{m_{12}n_{12}}{n_2} = \\frac{20 \\times 25}{50} = 10$$\nThe variance of $a_2$ is:\n$$\\operatorname{Var}(a_2) = \\frac{m_{12}m_{02}n_{12}n_{02}}{n_2^{2}(n_2-1)} = \\frac{20 \\times 30 \\times 25 \\times 25}{50^2 (50-1)} = \\frac{375000}{2500 \\times 49} = \\frac{150}{49}$$\nThe deviation is $a_2 - E[a_2] = 5 - 10 = -5$.\n\n**Stratum 3:**\nThe observed counts are $(a_3, b_3, c_3, d_3) = (9, 11, 13, 27)$.\nThe marginal totals are:\n$m_{13} = a_3 + b_3 = 9 + 11 = 20$\n$m_{03} = c_3 + d_3 = 13 + 27 = 40$\n$n_{13} = a_3 + c_3 = 9 + 13 = 22$\n$n_{03} = b_3 + d_3 = 11 + 27 = 38$\n$n_3 = m_{13} + m_{03} = 20 + 40 = 60$\n\nThe expected value of $a_3$ under $H_0$ is:\n$$E[a_3] = \\frac{m_{13}n_{13}}{n_3} = \\frac{20 \\times 22}{60} = \\frac{44}{6} = \\frac{22}{3}$$\nThe variance of $a_3$ is:\n$$\\operatorname{Var}(a_3) = \\frac{m_{13}m_{03}n_{13}n_{03}}{n_3^{2}(n_3-1)} = \\frac{20 \\times 40 \\times 22 \\times 38}{60^2 (60-1)} = \\frac{668800}{3600 \\times 59} = \\frac{1672}{9 \\times 59} = \\frac{1672}{531}$$\nThe deviation is $a_3 - E[a_3] = 9 - \\frac{22}{3} = \\frac{27-22}{3} = \\frac{5}{3}$.\n\nNow we aggregate these results.\nThe sum of the deviations is:\n$$\\sum_{k=1}^{3} (a_k - E[a_k]) = 2 + (-5) + \\frac{5}{3} = -3 + \\frac{5}{3} = \\frac{-9+5}{3} = -\\frac{4}{3}$$\nThe sum of the variances is:\n$$\\sum_{k=1}^{3} \\operatorname{Var}(a_k) = \\frac{200}{59} + \\frac{150}{49} + \\frac{1672}{531}$$\nTo sum these fractions, we find a common denominator. The denominators are $59$, $49=7^2$, and $531=9 \\times 59 = 3^2 \\times 59$. The least common denominator is $3^2 \\times 7^2 \\times 59 = 9 \\times 49 \\times 59 = 26019$.\n$$\\sum_{k=1}^{3} \\operatorname{Var}(a_k) = \\frac{200 \\times (9 \\times 49)}{26019} + \\frac{150 \\times (9 \\times 59)}{26019} + \\frac{1672 \\times 49}{26019}$$\n$$\\sum_{k=1}^{3} \\operatorname{Var}(a_k) = \\frac{200 \\times 441}{26019} + \\frac{150 \\times 531}{26019} + \\frac{81928}{26019} = \\frac{88200 + 79650 + 81928}{26019} = \\frac{249778}{26019}$$\n\nFinally, we compute the CMH statistic $Q_{MH}$:\n$$Q_{MH} = \\frac{\\left(-\\frac{4}{3}\\right)^2}{\\frac{249778}{26019}} = \\frac{\\frac{16}{9}}{\\frac{249778}{26019}} = \\frac{16}{9} \\times \\frac{26019}{249778}$$\nSince $26019 = 9 \\times 2891$, we can simplify:\n$$Q_{MH} = \\frac{16 \\times (9 \\times 2891)}{9 \\times 249778} = \\frac{16 \\times 2891}{249778} = \\frac{46256}{249778} \\approx 0.185186$$\nRounding to four significant figures, we get $Q_{MH} \\approx 0.1852$.\n\n**Interpretation:**\nUnder the null hypothesis of no association (common odds ratio of $1$), the CMH test statistic $Q_{MH}$ follows, for sufficiently large sample sizes, a chi-squared distribution with $1$ degree of freedom, denoted $\\chi^2_1$.\nThe calculated value of the statistic is $Q_{MH} \\approx 0.1852$. We compare this value to the critical value from the $\\chi^2_1$ distribution. For a typical significance level of $\\alpha = 0.05$, the critical value is $3.841$. Since $0.1852 \\ll 3.841$, the test statistic does not fall in the rejection region. Therefore, we do not have sufficient statistical evidence to reject the null hypothesis. The observed data are consistent with the hypothesis of no association between the exposure and the outcome, after adjusting for the stratified variable.", "answer": "$$\\boxed{0.1852}$$", "id": "4900624"}, {"introduction": "After mastering the calculation, the next critical skill is interpreting the result in a meaningful analytical context. A key assumption of the CMH test is that the association between exposure and outcome is consistent across strata, a concept known as homogeneity of effect. This exercise challenges you to interpret the result of a CMH test alongside a Breslow-Day test for homogeneity, a common scenario in epidemiological research that helps distinguish between confounding and effect modification. [@problem_id:4900599]", "problem": "An observational multi-center study investigates whether an exposure $E$ is associated with a binary disease outcome $D$, stratifying by clinical center $S \\in \\{1,2,3\\}$. Within each stratum, patients are cross-classified by $E$ and $D$ in $2 \\times 2$ tables. The observed counts are:\n\nStratum $S=1$:\n$$\n\\begin{array}{c|cc}\n & D=1 & D=0 \\\\\n\\hline\nE=1 & 18 & 82 \\\\\nE=0 & 9 & 91\n\\end{array}\n$$\n\nStratum $S=2$:\n$$\n\\begin{array}{c|cc}\n & D=1 & D=0 \\\\\n\\hline\nE=1 & 25 & 75 \\\\\nE=0 & 12 & 88\n\\end{array}\n$$\n\nStratum $S=3$:\n$$\n\\begin{array}{c|cc}\n & D=1 & D=0 \\\\\n\\hline\nE=1 & 30 & 70 \\\\\nE=0 & 14 & 86\n\\end{array}\n$$\n\nYou apply the Cochran-Mantel-Haenszel (CMH) test to assess whether there is an association between $E$ and $D$ after conditioning on $S$, and the Breslow-Day (BD) test to assess whether the stratum-specific odds ratios are homogeneous across $S$. The CMH test yields a $p$-value of $0.004$, and the BD test yields a $p$-value of $0.55$.\n\nUsing only first principles and core definitions, interpret these results. In particular, discuss what the pattern of a significant CMH test alongside a non-significant BD test implies about claiming and reporting a common effect. Choose the single best statement.\n\nA. The data provide evidence of an association between $E$ and $D$ conditional on $S$, and no evidence against homogeneity of stratum-specific odds ratios; it is appropriate to summarize with a single common odds ratio (for example, a Mantel-Haenszel estimate) and its confidence interval, while noting that a non-significant BD test does not prove perfect homogeneity.\n\nB. The combination of a significant CMH test and non-significant BD test indicates Simpson’s paradox; the adjusted association is an artifact, so only the unadjusted pooled $2 \\times 2$ table should be reported.\n\nC. The significant CMH test together with the non-significant BD test indicates strong effect modification; therefore a common effect is invalid and only stratum-specific odds ratios should be reported.\n\nD. The results show that stratification by $S$ has removed confounding so completely that no adjusted association remains; thus the exposure has no effect and no odds ratio should be reported.\n\nE. The CMH test is only valid when the BD test is significant; since the BD test is non-significant here, the CMH result should be ignored and logistic regression with an interaction term is mandatory.", "solution": "The user has provided a problem in biostatistics requiring the interpretation of results from a Cochran-Mantel-Haenszel (CMH) test and a Breslow-Day (BD) test applied to stratified $2 \\times 2$ contingency tables.\n\n### Step 1: Extract Givens\n\n-   **Study Design**: An observational multi-center study investigating the association between a binary exposure $E$ and a binary disease outcome $D$.\n-   **Stratification**: The study is stratified by clinical center $S$, with $S \\in \\{1, 2, 3\\}$.\n-   **Data**: The observed counts in $2 \\times 2$ tables for each stratum are as follows. For a generic stratum $i$, the table is:\n    $$\n    \\begin{array}{c|cc|c}\n     & D=1 & D=0 & \\text{Total} \\\\\n    \\hline\n    E=1 & a_i & b_i & n_{1i} \\\\\n    E=0 & c_i & d_i & n_{0i} \\\\\n    \\hline\n    \\text{Total} & m_{1i} & m_{0i} & N_i\n    \\end{array}\n    $$\n    -   Stratum $S=1$: $a_1=18$, $b_1=82$, $c_1=9$, $d_1=91$.\n    -   Stratum $S=2$: $a_2=25$, $b_2=75$, $c_2=12$, $d_2=88$.\n    -   Stratum $S=3$: $a_3=30$, $b_3=70$, $c_3=14$, $d_3=86$.\n-   **Statistical Results**:\n    -   Cochran-Mantel-Haenszel (CMH) test: $p$-value $= 0.004$.\n    -   Breslow-Day (BD) test: $p$-value $= 0.55$.\n-   **Question**: Interpret the combination of these two test results, specifically regarding the claim and reporting of a common effect, and choose the best statement among the options.\n\n### Step 2: Validate Using Extracted Givens\n\n-   **Scientific Groundedness**: The problem is grounded in the established principles of epidemiology and biostatistics. The analysis of stratified categorical data using CMH and BD tests is a standard and fundamental technique for handling confounding and effect modification.\n-   **Well-Posedness**: The problem is well-posed. It provides the necessary context (study design), data (counts in tables), and specific statistical results ($p$-values) required to arrive at a definitive interpretation. The question is clear and requires applying core statistical reasoning.\n-   **Objectivity**: The problem statement is objective and devoid of subjective or ambiguous language. It presents factual data and test outcomes.\n-   **Consistency Check**: Let's perform a brief check on the plausibility of the results. The stratum-specific odds ratios ($OR_i = \\frac{a_i d_i}{b_i c_i}$) are:\n    -   $OR_1 = \\frac{18 \\times 91}{82 \\times 9} = \\frac{1638}{738} \\approx 2.22$\n    -   $OR_2 = \\frac{25 \\times 88}{75 \\times 12} = \\frac{2200}{900} \\approx 2.44$\n    -   $OR_3 = \\frac{30 \\times 86}{70 \\times 14} = \\frac{2580}{980} \\approx 2.63$\n    The odds ratios are all greater than $1$ and are of a similar magnitude. This consistency is what the Breslow-Day test for homogeneity evaluates. A high $p$-value ($0.55$) is entirely plausible, as it indicates a failure to detect a statistically significant difference among these odds ratios. The CMH test evaluates the null hypothesis of no association (common $OR=1$) assuming homogeneity. Since each stratum suggests an association with an $OR > 2$, it is highly plausible that the combined evidence would be statistically significant, consistent with the given $p$-value of $0.004$. The provided information is internally consistent and factually sound.\n\n### Step 3: Verdict and Action\n\nThe problem statement is valid. It is scientifically sound, well-posed, objective, and consistent. I will proceed with deriving the solution.\n\n### Derivation and Option Analysis\n\n**Core Principles**\n\n1.  **Cochran-Mantel-Haenszel (CMH) Test**: The CMH test is used to assess the association between two binary variables (here, $E$ and $D$) across multiple strata (here, $S$). It tests the null hypothesis, $H_0: OR_{\\text{common}} = 1$, where $OR_{\\text{common}}$ is the common odds ratio across all strata. A significant result (small $p$-value) indicates that there is an association between the exposure and the outcome after adjusting for the stratifying variable. A key assumption for the standard interpretation of the CMH test is that the odds ratio is homogeneous (constant) across the strata.\n\n2.  **Breslow-Day (BD) Test**: The BD test is a test for homogeneity of odds ratios. It evaluates the null hypothesis, $H_0: OR_1 = OR_2 = \\dots = OR_k$, where $k$ is the number of strata. A non-significant result (large $p$-value) suggests that the data do not provide sufficient evidence to reject the assumption of a common odds ratio across strata. This supports the primary assumption of the CMH test. A significant result (small $p$-value) suggests the presence of heterogeneity or \"effect modification,\" meaning the strength or direction of the association between exposure and outcome differs depending on the stratum.\n\n**Interpretation of Given Results**\n\n-   **BD test result ($p=0.55$)**: This $p$-value is large (i.e., greater than conventional significance levels like $\\alpha=0.05$ or $\\alpha=0.10$). We fail to reject the null hypothesis of homogeneous odds ratios. This means the data are consistent with the assumption that the association between $E$ and $D$ is of similar magnitude in all three clinical centers. This does not prove homogeneity, but it means we lack evidence against it.\n-   **CMH test result ($p=0.004$)**: This $p$-value is small. We reject the null hypothesis that the common odds ratio is $1$. This provides strong evidence that there is a statistically significant association between exposure $E$ and disease $D$ after controlling for the confounding effect of the clinical center $S$.\n\n**Synthesis**\n\nThe combination of a non-significant BD test and a significant CMH test represents the ideal scenario for summarizing the effect with a single, adjusted measure of association. The BD test result supports the assumption of homogeneity needed for the CMH test, and the CMH test result indicates a significant underlying association. Therefore, it is standard and appropriate practice to report a summary measure, like the Mantel-Haenszel estimated common odds ratio, as the primary finding.\n\n**Option-by-Option Analysis**\n\n**A. The data provide evidence of an association between $E$ and $D$ conditional on $S$, and no evidence against homogeneity of stratum-specific odds ratios; it is appropriate to summarize with a single common odds ratio (for example, a Mantel-Haenszel estimate) and its confidence interval, while noting that a non-significant BD test does not prove perfect homogeneity.**\nThis statement correctly interprets both test results. The significant CMH test ($p=0.004$) shows an association conditional on $S$. The non-significant BD test ($p=0.55$) shows no evidence against homogeneity. The conclusion to report a common odds ratio is the correct statistical practice in this situation. The final clause, \"...noting that a non-significant BD test does not prove perfect homogeneity,\" is a statistically sound and important caveat, correctly distinguishing between \"acceptance\" of the null hypothesis and \"failure to reject\" it.\n**Verdict: Correct.**\n\n**B. The combination of a significant CMH test and non-significant BD test indicates Simpson’s paradox; the adjusted association is an artifact, so only the unadjusted pooled $2 \\times 2$ table should be reported.**\nThis is incorrect. Simpson's paradox typically involves a reversal of association direction upon stratification. The non-significant BD test implies the association is consistent, not reversing, across strata. The purpose of stratification and adjusted analysis is to control for confounding variables like $S$. The adjusted association (from the CMH test) is considered the more valid one, not an artifact. Reporting only the unadjusted (crude) result would be ignoring the potential confounding that motivated the stratified analysis in the first place.\n**Verdict: Incorrect.**\n\n**C. The significant CMH test together with the non-significant BD test indicates strong effect modification; therefore a common effect is invalid and only stratum-specific odds ratios should be reported.**\nThis is incorrect. Effect modification (heterogeneity of effect) is indicated by a *significant* BD test, not a non-significant one. The $p$-value of $0.55$ provides no evidence of effect modification. Therefore, the conclusion that a common effect is invalid is false; the results actually support the validity of reporting a common effect.\n**Verdict: Incorrect.**\n\n**D. The results show that stratification by $S$ has removed confounding so completely that no adjusted association remains; thus the exposure has no effect and no odds ratio should be reported.**\nThis is factually incorrect. The CMH test, which measures the adjusted association, yielded a highly significant $p$-value of $0.004$. This explicitly indicates that an adjusted association *does* remain after stratification. The conclusion that the exposure has no effect is a direct contradiction of the evidence.\n**Verdict: Incorrect.**\n\n**E. The CMH test is only valid when the BD test is significant; since the BD test is non-significant here, the CMH result should be ignored and logistic regression with an interaction term is mandatory.**\nThis statement has the logic reversed. The standard CMH test for a common association is most appropriately interpreted when its underlying assumption of homogeneity is met, which is supported by a *non-significant* BD test. If the BD test were significant, it would call into question the interpretation of a single common odds ratio from the CMH test. Furthermore, logistic regression with an interaction term is the analog to a *significant* BD test (i.e., when effect modification is present). Since the BD test is non-significant, the appropriate model-based analog would be a logistic regression model with main effects only (no interaction).\n**Verdict: Incorrect.**", "answer": "$$\\boxed{A}$$", "id": "4900599"}, {"introduction": "The standard CMH test relies on a large-sample approximation, but what happens when data are sparse? This advanced practice contrasts the asymptotic CMH test with its exact counterpart to explore the limits of the chi-square approximation. The exact test derives its p-value directly from the underlying hypergeometric distribution of the data, providing a more reliable result in small-sample or sparse-data situations. By implementing and comparing both methods, you will gain a deeper appreciation for statistical assumptions and learn when exact inference is necessary. [@problem_id:4924627]", "problem": "You are given three stratified collections of independent $2 \\times 2$ contingency tables. For each stratified collection, you must implement both an asymptotic Mantel-Haenszel stratified analysis and an exact Mantel-Haenszel stratified analysis, then compare the outputs and reconcile any discrepancies by quantifying agreement. The implementation must follow first principles starting from the hypergeometric model under the null hypothesis of no association within each stratum. The asymptotic analysis should use the Cochran-Mantel-Haenszel test statistic without continuity correction. The exact analysis should condition on fixed stratum margins and obtain the exact two-sided $p$-value via convolution of stratum-level hypergeometric probability mass functions. Your program must produce the required outputs for the test suite and print them in the specified format.\n\nFundamental base to use:\n- The conditional distribution of the upper-left cell count $a_i$ in stratum $i$ of a $2 \\times 2$ table, given fixed row and column margins, is hypergeometric, with mean $\\mathbb{E}[a_i]$ and variance $\\mathrm{Var}(a_i)$ determined by the margins.\n- The Cochran-Mantel-Haenszel (CMH) statistic is constructed from the sum of deviations $\\sum_i (a_i - \\mathbb{E}[a_i])$ and its variance $\\sum_i \\mathrm{Var}(a_i)$, and under the null hypothesis is approximated by a chi-square distribution with $1$ degree of freedom.\n- The Mantel-Haenszel (MH) common odds ratio estimator is derived from the stratum cross-products and is consistent under a common odds ratio model.\n\nDefinitions:\n- Mantel-Haenszel (MH) common odds ratio estimator across strata.\n- Cochran-Mantel-Haenszel (CMH) chi-square test without continuity correction.\n- Confidence interval (CI) is not required in this task.\n\nData structure and notation:\n- Each stratum $i$ has a $2 \\times 2$ table with counts $\\begin{pmatrix} a_i & b_i \\\\ c_i & d_i \\end{pmatrix}$, row totals $n_{1i} = a_i + b_i$, $n_{2i} = c_i + d_i$, column totals $m_{1i} = a_i + c_i$, $m_{2i} = b_i + d_i$, and total $n_i = n_{1i} + n_{2i}$.\n- Under the null hypothesis, $a_i$ follows a hypergeometric distribution with population size $n_i$, number of successes $m_{1i}$, and draws $n_{1i}$.\n\nTasks to implement per stratified collection:\n1. Compute the asymptotic MH common odds ratio estimate using stratum cross-products and the CMH $p$-value using the chi-square approximation without continuity correction.\n2. Compute the exact two-sided CMH $p$-value by convolving the stratum-level hypergeometric probability mass functions for the total $A = \\sum_i a_i$, and summing the probability of outcomes whose CMH statistic is at least as extreme as observed.\n3. Return a boolean indicating whether the asymptotic and exact $p$-values agree within a tolerance $\\epsilon = 0.01$.\n\nTest suite (three stratified collections):\n- Test case $1$ (moderate counts, typical scenario):\n  - Stratum $1$: $\\begin{pmatrix} 12 & 8 \\\\ 9 & 11 \\end{pmatrix}$.\n  - Stratum $2$: $\\begin{pmatrix} 7 & 13 \\\\ 11 & 9 \\end{pmatrix}$.\n  - Stratum $3$: $\\begin{pmatrix} 9 & 11 \\\\ 12 & 8 \\end{pmatrix}$.\n- Test case $2$ (sparse counts with zero cells in different positions across strata):\n  - Stratum $1$: $\\begin{pmatrix} 0 & 5 \\\\ 4 & 6 \\end{pmatrix}$.\n  - Stratum $2$: $\\begin{pmatrix} 3 & 0 \\\\ 2 & 7 \\end{pmatrix}$.\n  - Stratum $3$: $\\begin{pmatrix} 1 & 2 \\\\ 0 & 9 \\end{pmatrix}$.\n- Test case $3$ (small sample counts where exact and asymptotic may diverge appreciably):\n  - Stratum $1$: $\\begin{pmatrix} 1 & 0 \\\\ 1 & 1 \\end{pmatrix}$.\n  - Stratum $2$: $\\begin{pmatrix} 0 & 1 \\\\ 1 & 1 \\end{pmatrix}$.\n  - Stratum $3$: $\\begin{pmatrix} 1 & 1 \\\\ 0 & 1 \\end{pmatrix}$.\n\nRequired computations and outputs per test case:\n- Compute the MH common odds ratio estimate $\\hat{\\theta}_{\\mathrm{MH}}$.\n- Compute the asymptotic CMH $p$-value $p_{\\mathrm{asym}}$ using the chi-square approximation with $1$ degree of freedom, without continuity correction.\n- Compute the exact two-sided CMH $p$-value $p_{\\mathrm{exact}}$ via the convolution-based distribution of $A = \\sum_i a_i$ under the null hypothesis.\n- Compute the boolean $\\mathrm{agree}$ which is $\\mathrm{True}$ if $\\lvert p_{\\mathrm{asym}} - p_{\\mathrm{exact}} \\rvert \\le \\epsilon$ with $\\epsilon = 0.01$, and $\\mathrm{False}$ otherwise.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. For each test case in order $1, 2, 3$, output the quadruple $\\left[\\hat{\\theta}_{\\mathrm{MH}}, p_{\\mathrm{asym}}, p_{\\mathrm{exact}}, \\mathrm{agree}\\right]$ flattened into a single list. Floats must be rounded to $6$ decimal places, and the boolean must be either $\\mathrm{True}$ or $\\mathrm{False}$. For example, the final printed line should look like $\\left[\\hat{\\theta}_{\\mathrm{MH},1}, p_{\\mathrm{asym},1}, p_{\\mathrm{exact},1}, \\mathrm{agree}_1, \\hat{\\theta}_{\\mathrm{MH},2}, p_{\\mathrm{asym},2}, p_{\\mathrm{exact},2}, \\mathrm{agree}_2, \\hat{\\theta}_{\\mathrm{MH},3}, p_{\\mathrm{asym},3}, p_{\\mathrm{exact},3}, \\mathrm{agree}_3\\right]$ with each numeric value rounded to $6$ decimal places.", "solution": "The problem is valid as it presents a well-defined, scientifically-grounded task in biostatistics. It provides all necessary data and definitions for performing a Mantel-Haenszel stratified analysis. The methods requested—asymptotic Cochran-Mantel-Haenszel (CMH) test, Mantel-Haenszel (MH) common odds ratio estimation, and an exact test based on the convolution of hypergeometric distributions—are standard and rigorously defined. The problem is objective, self-contained, and computationally feasible.\n\nThe solution will be developed following first principles for stratified analysis of $2 \\times 2$ tables. For a collection of $k$ strata, indexed by $i=1, \\dots, k$, each stratum is represented by a contingency table:\n$$ \\begin{pmatrix} a_i & b_i \\\\ c_i & d_i \\end{pmatrix} $$\nThe row totals are $n_{1i} = a_i + b_i$ and $n_{2i} = c_i + d_i$. The column totals are $m_{1i} = a_i + c_i$ and $m_{2i} = b_i + d_i$. The total count for stratum $i$ is $n_i = a_i + b_i + c_i + d_i$.\n\nThe fundamental assumption for the analysis, under the null hypothesis ($H_0$) of no association between the row and column variables within any stratum (i.e., the common odds ratio $\\theta$ is $1$), is that the count $a_i$ in each table follows a hypergeometric distribution, conditional on the marginal totals. The parameters for this distribution are population size $N=n_i$, number of 'success' items in the population $K=m_{1i}$, and number of draws $n=n_{1i}$. The probability mass function (PMF) for $a_i$ is given by:\n$$ P(a_i = x | H_0) = \\frac{\\binom{m_{1i}}{x} \\binom{m_{2i}}{n_{1i}-x}}{\\binom{n_i}{n_{1i}}} $$\nThe support for $a_i$ is $[\\max(0, n_{1i}+m_{1i}-n_i), \\min(n_{1i}, m_{1i})]$. The conditional expectation and variance of $a_i$ under $H_0$ are:\n$$ \\mathbb{E}[a_i | H_0] = \\frac{n_{1i} m_{1i}}{n_i} $$\n$$ \\mathrm{Var}(a_i | H_0) = \\frac{n_{1i} n_{2i} m_{1i} m_{2i}}{n_i^2 (n_i - 1)} $$\n\nThe tasks require computing three quantities for each test case.\n\n**1. Mantel-Haenszel Common Odds Ratio Estimator ($\\hat{\\theta}_{\\mathrm{MH}}$)**\nThe MH estimator provides a pooled estimate of the common odds ratio across all strata. It is calculated as the ratio of summed weighted cross-products:\n$$ \\hat{\\theta}_{\\mathrm{MH}} = \\frac{\\sum_{i=1}^k R_i}{\\sum_{i=1}^k S_i} = \\frac{\\sum_{i=1}^k (a_i d_i / n_i)}{\\sum_{i=1}^k (b_i c_i / n_i)} $$\nThis estimator is consistent even with sparse data.\n\n**2. Asymptotic Cochran-Mantel-Haenszel (CMH) Test**\nThe CMH test assesses the overall association by comparing the total observed count of the top-left cells, $A = \\sum a_i$, to its expected value under $H_0$. The test statistic (without continuity correction) is:\n$$ \\chi^2_{\\mathrm{CMH}} = \\frac{\\left( \\sum_{i=1}^k a_i - \\sum_{i=1}^k \\mathbb{E}[a_i | H_0] \\right)^2}{\\sum_{i=1}^k \\mathrm{Var}(a_i | H_0)} $$\nLet $A_{\\mathrm{obs}} = \\sum a_i$, $E = \\sum \\mathbb{E}[a_i | H_0]$, and $V = \\sum \\mathrm{Var}(a_i | H_0)$. The statistic simplifies to:\n$$ \\chi^2_{\\mathrm{CMH}} = \\frac{(A_{\\mathrm{obs}} - E)^2}{V} $$\nUnder $H_0$, this statistic is asymptotically distributed as a chi-square variable with $1$ degree of freedom ($\\chi^2_1$). The asymptotic two-sided $p$-value, $p_{\\mathrm{asym}}$, is the probability of observing a test statistic at least as large as the one calculated:\n$$ p_{\\mathrm{asym}} = P(\\chi^2_1 \\ge \\chi^2_{\\mathrm{CMH}}) $$\nThis is computed using the survival function of the $\\chi^2_1$ distribution.\n\n**3. Exact Mantel-Haenszel Test**\nThe exact test computes the $p$-value from the exact conditional distribution of a sufficient statistic, which is $A = \\sum a_i$. Since the $a_i$ are independent under the conditioning, the distribution of their sum $A$ is the convolution of their individual hypergeometric PMFs.\nLet $P_i$ be the PMF of $a_i$. The PMF of $A$, denoted $P_A$, is:\n$$ P_A = P_1 * P_2 * \\dots * P_k $$\nwhere $*$ denotes the convolution operation. This can be computed iteratively. If $P_{1..j}$ is the PMF for $\\sum_{i=1}^j a_i$, then $P_{1..j+1} = P_{1..j} * P_{j+1}$.\n\nThe problem specifies that the two-sided exact $p$-value, $p_{\\mathrm{exact}}$, is obtained by \"summing the probability of outcomes whose CMH statistic is at least as extreme as observed.\" This means we identify all possible values $j$ for the sum $A$ that would yield a $\\chi^2_{\\mathrm{CMH}}$ value greater than or equal to the observed statistic, $\\chi^2_{\\mathrm{obs}} = (A_{\\mathrm{obs}} - E)^2 / V$.\nThe exact $p$-value is then the sum of the probabilities of these values occurring:\n$$ p_{\\mathrm{exact}} = \\sum_{j \\text{ s.t. } \\frac{(j-E)^2}{V} \\ge \\chi^2_{\\mathrm{obs}}} P_A(j) $$\nThe condition $\\frac{(j-E)^2}{V} \\ge \\frac{(A_{\\mathrm{obs}}-E)^2}{V}$ is equivalent to $|j-E| \\ge |A_{\\mathrm{obs}}-E|$. The algorithm involves:\na. Computing the PMF for each $a_i$.\nb. Convolving these PMFs to find the exact distribution of $A = \\sum a_i$.\nc. Calculating the observed statistic $\\chi^2_{\\mathrm{obs}}$.\nd. Summing the probabilities $P_A(j)$ for all values $j$ in the support of $A$ that satisfy the extremeness condition.\n\nFinally, the agreement between the asymptotic and exact $p$-values is assessed using a tolerance $\\epsilon = 0.01$. The boolean $\\mathrm{agree}$ is $\\mathrm{True}$ if $|p_{\\mathrm{asym}} - p_{\\mathrm{exact}}| \\le \\epsilon$ and $\\mathrm{False}$ otherwise. These steps will be implemented for each test case provided.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import hypergeom, chi2\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print results.\n    \"\"\"\n    test_cases = [\n        # Test case 1\n        [\n            [[12, 8], [9, 11]],\n            [[7, 13], [11, 9]],\n            [[9, 11], [12, 8]]\n        ],\n        # Test case 2\n        [\n            [[0, 5], [4, 6]],\n            [[3, 0], [2, 7]],\n            [[1, 2], [0, 9]]\n        ],\n        # Test case 3\n        [\n            [[1, 0], [1, 1]],\n            [[0, 1], [1, 1]],\n            [[1, 1], [0, 1]]\n        ]\n    ]\n\n    all_results = []\n    for case in test_cases:\n        results = compute_mh_analysis(case)\n        all_results.extend(results)\n\n    # Format output as specified\n    formatted_results = []\n    for item in all_results:\n        if isinstance(item, float):\n            formatted_results.append(f\"{item:.6f}\")\n        else:\n            formatted_results.append(str(item))\n\n    print(f\"[{','.join(formatted_results)}]\")\n\ndef compute_mh_analysis(strata_data):\n    \"\"\"\n    Performs Mantel-Haenszel analysis for a given set of stratified 2x2 tables.\n\n    Args:\n        strata_data (list): A list of 2x2 tables, where each table is a list of lists.\n\n    Returns:\n        list: A list containing [theta_mh, p_asym, p_exact, agree].\n    \"\"\"\n    observed_a_sum = 0.0\n    expected_a_sum = 0.0\n    variance_a_sum = 0.0\n    R_sum = 0.0\n    S_sum = 0.0\n\n    # Initialize the convolved PMF with a delta function at 0\n    # A dictionary is used to map {value: probability}\n    convolved_pmf = {0: 1.0}\n\n    for table in strata_data:\n        a, b = table[0]\n        c, d = table[1]\n\n        n1 = a + b\n        n2 = c + d\n        m1 = a + c\n        m2 = b + d\n        n = n1 + n2\n\n        if n == 0:\n            continue\n\n        # Accumulate sums for CMH statistic and MH OR\n        observed_a_sum += a\n        \n        expected_a = (n1 * m1) / n\n        expected_a_sum += expected_a\n        \n        if n > 1:\n            variance_a = (n1 * n2 * m1 * m2) / (n**2 * (n - 1))\n            variance_a_sum += variance_a\n        \n        R_sum += (a * d) / n\n        S_sum += (b * c) / n\n\n        # Hypergeometric distribution for stratum i\n        # M=total items, n=success items, N=draws\n        # M=n, n=m1, N=n1\n        M, n_hyper, N_hyper = n, m1, n1\n        \n        min_a = max(0, N_hyper - (M - n_hyper))\n        max_a = min(N_hyper, n_hyper)\n        \n        stratum_pmf = {}\n        for k in range(min_a, max_a + 1):\n            prob = hypergeom.pmf(k, M, n_hyper, N_hyper)\n            if prob > 0:\n                stratum_pmf[k] = prob\n        \n        # Convolve with the existing total PMF\n        new_convolved_pmf = {}\n        for val1, prob1 in convolved_pmf.items():\n            for val2, prob2 in stratum_pmf.items():\n                new_val = val1 + val2\n                new_prob = prob1 * prob2\n                new_convolved_pmf[new_val] = new_convolved_pmf.get(new_val, 0) + new_prob\n        convolved_pmf = new_convolved_pmf\n\n    # 1. MH common odds ratio\n    theta_mh = R_sum / S_sum if S_sum > 0 else np.inf\n\n    # 2. Asymptotic CMH p-value\n    if variance_a_sum > 0:\n        chi2_cmh = (observed_a_sum - expected_a_sum)**2 / variance_a_sum\n        p_asym = chi2.sf(chi2_cmh, 1)\n    else: # If variance is zero, there's no variability, p-value is 1 unless obs != exp\n        chi2_cmh = 0.0\n        if abs(observed_a_sum - expected_a_sum) > 1e-9:\n             p_asym = 0.0 # An impossible outcome\n        else:\n             p_asym = 1.0\n\n    # 3. Exact CMH p-value\n    p_exact = 0.0\n    if variance_a_sum > 0:\n        obs_dev_sq = (observed_a_sum - expected_a_sum)**2\n        # Use a small tolerance for float comparison\n        dev_threshold = obs_dev_sq - 1e-9\n        \n        for total_a, prob in convolved_pmf.items():\n            current_dev_sq = (total_a - expected_a_sum)**2\n            if current_dev_sq >= dev_threshold:\n                p_exact += prob\n    else:\n        p_exact = 1.0\n\n    # 4. Agreement\n    epsilon = 0.01\n    agree = abs(p_asym - p_exact) = epsilon\n\n    return [theta_mh, p_asym, p_exact, agree]\n\nif __name__ == \"__main__\":\n    solve()\n```", "id": "4924627"}]}