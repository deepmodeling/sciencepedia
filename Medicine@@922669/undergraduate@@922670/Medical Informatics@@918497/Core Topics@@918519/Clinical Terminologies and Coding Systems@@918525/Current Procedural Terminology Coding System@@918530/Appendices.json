{"hands_on_practices": [{"introduction": "A foundational concept in procedural coding is determining which services are integral to a larger procedure versus which are separately reportable. This exercise explores the crucial \"bundling\" principle within the Current Procedural Terminology (CPT) system, focusing on the common clinical scenario where a diagnostic evaluation leads directly to a therapeutic intervention. Mastering this logic is essential for accurate coding, as it requires you to identify the primary, most comprehensive service that encapsulates the entirety of the surgical work performed. [@problem_id:4424845]", "problem": "A $27$-year-old patient with chronic pelvic pain and dysmenorrhea is scheduled for a diagnostic laparoscopy to evaluate suspected pelvic pathology. Informed consent includes the possibility of proceeding to definitive laparoscopic intervention if a treatable condition is identified. Intraoperatively, after establishing pneumoperitoneum and camera port placement, the surgeon performs a systematic diagnostic survey of the upper abdomen and pelvis, recording visual inspection of the diaphragmatic peritoneum, liver edge, omentum, uterus, adnexa, cul-de-sac, and paracolic gutters. No acute pathology requiring emergent treatment is identified. The patient had requested permanent contraception if no treatable cause of pain was found. The surgeon proceeds with bilateral laparoscopic tubal ligation using mechanical clips applied to each oviduct. During entry, a single thin omental adhesion to the anterior abdominal wall is lysed solely to facilitate safe trocar placement and visualization; no other adhesions are lysed for therapeutic purposes.\n\nUsing the foundational principles of Current Procedural Terminology (CPT) and the National Correct Coding Initiative (NCCI), select the most appropriate CPT coding for this encounter. Base your selection on the following core rules:\n- CPT codes represent defined procedural services and their typical components. A code designated as a “separate procedure” is generally not separately reportable when it is performed as an integral component of a more extensive procedure during the same session.\n- NCCI bundling edits prevent reporting of component services that are integral to more extensive procedures. Modifier 59 (distinct procedural service) may be used only when documentation supports a truly distinct service (e.g., different anatomic site, separate session) that is not merely necessary to accomplish the primary procedure.\n\nWhich option best reflects correct coding?\n\nA. $49320$ (laparoscopy, abdomen, diagnostic) and $58671$ (laparoscopy, surgical; tubal ligation by device), with modifier 51 on the second code for multiple procedures\n\nB. $58670$ (laparoscopy, surgical; with fulguration of oviducts by coagulation) alone\n\nC. $58671$ (laparoscopy, surgical; tubal ligation by device) alone\n\nD. $58671$ and $58660$ (laparoscopy, lysis of adhesions), with modifier 59 on $58660$\n\nE. $49320$ with modifier 59 and $58671$", "solution": "## Problem Validation\n\n### Step 1: Extract Givens\n\nThe problem statement provides the following information:\n- **Patient Profile:** A $27$-year-old patient.\n- **Clinical Presentation:** Chronic pelvic pain and dysmenorrhea.\n- **Planned Procedure:** Diagnostic laparoscopy to evaluate suspected pelvic pathology.\n- **Informed Consent:** Includes proceeding to definitive laparoscopic intervention if a treatable condition is identified.\n- **Intraoperative Diagnostic Survey:** A systematic diagnostic survey of the upper abdomen and pelvis was performed. No acute pathology requiring emergent treatment was identified.\n- **Patient Request:** Permanent contraception if no treatable cause of pain was found.\n- **Definitive Procedure Performed:** Bilateral laparoscopic tubal ligation using mechanical clips applied to each oviduct.\n- **Incidental Procedure Performed:** Lysis of a single thin omental adhesion to the anterior abdominal wall.\n- **Reason for Incidental Procedure:** \"solely to facilitate safe trocar placement and visualization\". No other adhesions were lysed for therapeutic purposes.\n- **Applicable Rules:**\n    1.  CPT codes represent defined services. A \"separate procedure\" code is generally not separately reportable when it is an integral component of a more extensive procedure.\n    2.  NCCI bundling edits prevent reporting of component services integral to more extensive procedures.\n    3.  Modifier 59 is for a \"truly distinct service...not merely necessary to accomplish the primary procedure.\"\n\n### Step 2: Validate Using Extracted Givens\n\nThe problem statement is evaluated against the validation criteria:\n\n- **Scientifically Grounded:** The clinical scenario is entirely plausible and common in gynecologic surgery. The progression from a diagnostic evaluation for chronic pelvic pain to a planned secondary procedure (tubal ligation) is standard practice. The described surgical steps (pneumoperitoneum, diagnostic survey, application of clips, lysis of adhesion for access) are medically accurate. The problem is grounded in the established, formal principles of the Current Procedural Terminology (CPT) and the National Correct Coding Initiative (NCCI), which are the standard rule sets for medical billing in the United States.\n- **Well-Posed:** The problem is well-posed. It provides a detailed clinical narrative and a clear set of established rules (the coding principles) to apply. The question asks for the \"most appropriate\" coding, which directs the solver to find a unique, correct answer based on the hierarchical and bundling logic inherent in the CPT/NCCI system.\n- **Objective:** The language is clinical, precise, and objective, describing actions and findings without ambiguity or subjective bias.\n\nThe problem exhibits no flaws:\n1.  **Scientific or Factual Unsoundness:** None. The medical and coding premises are sound.\n2.  **Non-Formalizable or Irrelevant:** The problem is highly formalizable within the CPT/NCCI rule-based system and is directly relevant to the principles of coding diagnostic and operative laparoscopy.\n3.  **Incomplete or Contradictory Setup:** The problem is complete. It provides all necessary details to distinguish between separately reportable procedures and bundled components. The reason for the lysis of adhesion is explicitly stated, which is critical for correct coding.\n4.  **Unrealistic or Infeasible:** The scenario is realistic.\n5.  **Ill-Posed or Poorly Structured:** The problem is well-structured and leads to a unique solution based on the application of the given rules.\n6.  **Pseudo-Profound, Trivial, or Tautological:** The problem requires specialized knowledge of procedural coding logic and is not trivial.\n7.  **Outside Scientific Verifiability:** The solution is verifiable by cross-referencing the official CPT codebook and NCCI policy manuals.\n\n### Step 3: Verdict and Action\n\nThe problem statement is **valid**. The solution will proceed.\n\n## Solution Derivation\n\nThe solution is derived by applying the provided foundational principles of CPT and NCCI to the procedures performed. The core principle is that when multiple procedures are performed during the same encounter, they are not necessarily all billable. One must identify the primary, most extensive procedure and determine which other services are considered integral, incidental, or bundled components.\n\n**1. Analysis of Diagnostic vs. Surgical Laparoscopy:**\nThe surgeon began with a diagnostic laparoscopy (CPT code $49320$, *Laparoscopy, abdomen, peritoneum, and omentum, diagnostic, with or without collection of specimen(s) by brushing or washing (separate procedure)*). However, the procedure did not end there. A decision was made to proceed to a definitive surgical procedure: tubal ligation. The CPT/NCCI guidelines state that when a diagnostic procedure leads to a surgical procedure at the same site during the same session, the diagnostic component is considered integral to the surgical procedure. The work of the diagnostic survey is bundled into the more comprehensive surgical code. Therefore, CPT code $49320$ should not be reported separately.\n\n**2. Analysis of the Surgical Procedure:**\nThe definitive surgical procedure was a bilateral tubal ligation using mechanical clips. We must identify the CPT code that accurately describes this.\n- CPT $58670$: *Laparoscopy, surgical; with fulguration of oviducts (with or without transection)*. This involves using electrical energy (fulguration) for occlusion. This does not match the description.\n- CPT $58671$: *Laparoscopy, surgical; with occlusion of oviducts by device (e.g., band, clip, or Fallopian ring)*. This code perfectly matches the description of applying \"mechanical clips\". This is the correct code for the primary surgical procedure.\n\n**3. Analysis of the Lysis of Adhesion:**\nA single omental adhesion was lysed. The CPT code for laparoscopic lysis of adhesions is $58660$. However, the problem explicitly states this was done \"solely to facilitate safe trocar placement and visualization\" and was not for therapeutic purposes. NCCI principles and general coding rules consider work necessary to gain access to the surgical field or to make the primary procedure feasible as an integral part of that primary procedure. This is not considered a \"distinct procedural service\". Therefore, CPT code $58660$ is not separately reportable. Applying modifier 59 would be incorrect, as it is reserved for situations that are truly distinct, not for work that is instrumental to completing the main service.\n\n**4. Synthesis of Correct Coding:**\nBased on the analysis:\n- The diagnostic laparoscopy ($49320$) is bundled into the surgical laparoscopy.\n- The lysis of adhesion ($58660$) is bundled because it was performed for access.\n- The only reportable procedure is the definitive surgical procedure: laparoscopic tubal ligation with a device.\n\nThe correct and most appropriate coding for this entire encounter is a single CPT code: $58671$.\n\n## Option-by-Option Analysis\n\n**A. $49320$ (laparoscopy, abdomen, diagnostic) and $58671$ (laparoscopy, surgical; tubal ligation by device), with modifier 51 on the second code for multiple procedures**\nThis option incorrectly reports the diagnostic laparoscopy ($49320$) separately. When a diagnostic laparoscopy is converted to or followed by a therapeutic laparoscopy in the same session, the diagnostic service is bundled and not separately reportable.\n*Verdict: Incorrect.*\n\n**B. $58670$ (laparoscopy, surgical; with fulguration of oviducts by coagulation) alone**\nThis option uses the wrong CPT code for the surgical procedure. The code $58670$ is for tubal ligation by fulguration, whereas the procedure described used \"mechanical clips\", which is correctly described by code $58671$.\n*Verdict: Incorrect.*\n\n**C. $58671$ (laparoscopy, surgical; tubal ligation by device) alone**\nThis option correctly identifies the single, definitive surgical procedure code that represents the entire service. It correctly excludes the bundled diagnostic laparoscopy and the bundled lysis of adhesion for access. The CPT code $58671$ accurately describes a laparoscopic tubal ligation using clips.\n*Verdict: Correct.*\n\n**D. $58671$ and $58660$ (laparoscopy, lysis of adhesions), with modifier 59 on $58660$**\nThis option incorrectly reports the lysis of adhesions ($58660$). The problem explicitly states this was done for access, not for therapeutic reasons. Such incidental work is bundled into the primary procedure. Using modifier 59 to unbundle it is a violation of the rule that the service must be \"truly distinct\" and \"not merely necessary to accomplish the primary procedure.\"\n*Verdict: Incorrect.*\n\n**E. $49320$ with modifier 59 and $58671$**\nThis option incorrectly reports the diagnostic laparoscopy ($49320$) and misuses modifier 59. A diagnostic procedure that leads to a therapeutic one is the opposite of a \"distinct procedural service\"; it is an integral precursor. Modifier 59 cannot be used to unbundle these components.\n*Verdict: Incorrect.*", "answer": "$$\\boxed{C}$$", "id": "4424845"}, {"introduction": "Moving beyond conceptual rules, this practice delves into the quantitative and hierarchical nature of coding for complex services like infusions and injections. You will analyze a detailed clinical timeline and apply a strict hierarchy of service categories, along with time-based reporting rules, to correctly code a multi-part patient encounter. This exercise hones the critical skill of deconstructing a narrative of care into a precise set of initial, sequential, and add-on codes to ultimately determine the correct reimbursement. [@problem_id:4831700]", "problem": "In outpatient infusion coding under the Current Procedural Terminology (CPT) coding system, services are categorized hierarchically and time-based reporting rules apply. The hierarchy for intravenous administration establishes that chemotherapy infusion supersedes therapeutic/prophylactic/diagnostic infusion, which supersedes hydration. Only one “initial” service may be selected per encounter, and it must be chosen from the highest applicable category. Additional reporting for sequential and concurrent infusions and for intravenous pushes and injections follows category-specific rules.\n\nA patient undergoes the following services in a single hospital outpatient encounter:\n- Chemotherapy infusion of Drug A begins at $08{:}00$ and ends at $09{:}35$, lasting $95$ minutes total.\n- Hydration runs concurrently via a secondary line from $08{:}10$ to $08{:}50$, lasting $40$ minutes.\n- After the chemotherapy infusion ends, a therapeutic antibiotic infusion (Drug B) is administered sequentially from $09{:}40$ to $10{:}10$, lasting $30$ minutes.\n- An antiemetic is administered as an intravenous push at $08{:}05$.\n- A vitamin B12 injection is administered intramuscularly at $10{:}20$.\n\nAssume the following Relative Value Units (RVUs) for the relevant CPT codes:\n- Initial chemotherapy infusion (up to $1$ hour): CPT $96413$ has $3.40$ RVUs.\n- Each additional hour of chemotherapy infusion: CPT $96415$ has $1.60$ RVUs.\n- Concurrent infusion add-on: CPT $96368$ has $0.80$ RVUs.\n- Additional sequential infusion of a new therapeutic/prophylactic/diagnostic substance/drug (up to $1$ hour): CPT $96367$ has $1.20$ RVUs.\n- Intravenous push of a new therapeutic/prophylactic/diagnostic substance/drug: CPT $96375$ has $0.70$ RVUs.\n- Intramuscular injection: CPT $96372$ has $0.60$ RVUs.\n\nUse the core CPT hierarchy and time-based reporting rules to determine the correctly reportable codes from this encounter and compute the total professional payment using a national conversion factor of $C = 36.00$ dollars per RVU. Express the final payment in United States dollars (USD) and round your answer to four significant figures.", "solution": "The problem is assessed to be valid. It presents a self-contained, rule-based scenario within the domain of medical informatics and computational healthcare billing, which is a formalizable topic. The provided data, definitions, and constraints are sufficient and internally consistent, allowing for a unique solution by applying the given hierarchical and time-based rules. The problem is well-posed.\n\nThe solution proceeds by systematically applying the Current Procedural Terminology (CPT) coding rules as described in the problem statement to the patient encounter. The total professional payment is the product of the sum of the Relative Value Units (RVUs) for all correctly reported services and the national conversion factor.\n\nThe primary principle is the service hierarchy: Chemotherapy infusion $>$ Therapeutic/Prophylactic/Diagnostic infusion $>$ Hydration. Only one \"initial\" service can be reported, and it must correspond to the highest-ranking service provided during the encounter.\n\n1.  **Determination of the Initial Service:**\n    The patient received a chemotherapy infusion, a therapeutic infusion, and hydration. According to the specified hierarchy, chemotherapy is the highest-ranking service. Therefore, the initial service code must be for the chemotherapy infusion.\n\n2.  **Coding the Chemotherapy Infusion:**\n    The chemotherapy infusion lasted for a total of $95$ minutes. CPT coding for prolonged services is based on time blocks.\n    -   The first hour of service (minutes $1$ through $60$) is reported as the initial service. The appropriate code is CPT $96413$ (Initial chemotherapy infusion, up to $1$ hour), which corresponds to $3.40$ RVUs.\n    -   The remaining time is $95 - 60 = 35$ minutes. The rule for additional hours requires reporting CPT $96415$ for each additional hour of infusion. Conventionally, a unit of time is reportable once more than half of that unit has been completed. Since $35$ minutes is greater than half of an hour ($30$ minutes), one additional hour of chemotherapy infusion is reportable. The code is CPT $96415$ (Each additional hour of chemotherapy infusion), corresponding to $1.60$ RVUs.\n\n3.  **Coding the Concurrent Hydration:**\n    A hydration infusion was administered concurrently with the chemotherapy for $40$ minutes. While standard CPT guidelines often preclude separate reporting of concurrent hydration, this problem must be treated as a self-contained system. The problem provides a code, CPT $96368$, described as a \"Concurrent infusion add-on\" with $0.80$ RVUs. Given that a concurrent infusion service was rendered and a corresponding code is provided within the problem's defined set of rules, it is appropriate to report it.\n    -   The code for the concurrent service is CPT $96368$, which adds $0.80$ RVUs.\n\n4.  **Coding the Sequential Therapeutic Infusion:**\n    After the chemotherapy was complete, a sequential infusion of a therapeutic antibiotic (Drug B) was administered for $30$ minutes. This is an additional infusion of a new therapeutic drug.\n    -   The appropriate code is CPT $96367$ (Additional sequential infusion of a new therapeutic/prophylactic/diagnostic substance/drug, up to $1$ hour). The duration of $30$ minutes falls within the \"up to $1$ hour\" parameter. This service corresponds to $1.20$ RVUs.\n\n5.  **Coding the Intravenous (IV) Push:**\n    An antiemetic was administered as an IV push. This is a therapeutic/prophylactic substance distinct from the chemotherapy agent. An IV push of a non-chemotherapy substance is a separately reportable service.\n    -   The code is CPT $96375$ (Intravenous push of a new therapeutic/prophylactic/diagnostic substance/drug), which corresponds to $0.70$ RVUs.\n\n6.  **Coding the Intramuscular (IM) Injection:**\n    An IM injection of vitamin B12 was given. This service involves a different route of administration (intramuscular) and is not part of the intravenous service hierarchy. It is therefore a distinct and separately reportable procedure.\n    -   The code is CPT $96372$ (Intramuscular injection), which corresponds to $0.60$ RVUs.\n\n7.  **Calculation of Total RVUs and Final Payment:**\n    The total RVUs for the encounter is the sum of the RVUs for all reportable codes.\n    $$ \\text{Total RVU} = \\text{RVU}_{96413} + \\text{RVU}_{96415} + \\text{RVU}_{96368} + \\text{RVU}_{96367} + \\text{RVU}_{96375} + \\text{RVU}_{96372} $$\n    $$ \\text{Total RVU} = 3.40 + 1.60 + 0.80 + 1.20 + 0.70 + 0.60 = 8.30 $$\n    The total payment is calculated by multiplying the total RVUs by the conversion factor, $C = 36.00$ dollars per RVU.\n    $$ \\text{Total Payment} = (\\text{Total RVU}) \\times C $$\n    $$ \\text{Total Payment} = 8.30 \\times 36.00 = 298.8 $$\n    The problem requests the answer to be rounded to four significant figures. The calculated value $298.8$ already consists of four significant figures.\n\nThus, the total professional payment for this encounter is $298.80$ USD.", "answer": "$$\n\\boxed{298.8}\n$$", "id": "4831700"}, {"introduction": "This final practice bridges the gap between manual coding and the core work of medical informatics: automation and data integrity. Here, you will translate the abstract rules and logic of the CPT system into a functional computer program designed to validate medical claims. By implementing checks for code formats, referential integrity between services, and dependencies like add-on code requirements, you will experience firsthand how computational methods are used to enforce billing accuracy and data quality at scale in modern healthcare systems. [@problem_id:4831697]", "problem": "You are given a simplified validation and referential integrity task grounded in the Current Procedural Terminology (CPT) coding system. The goal is to implement a deterministic validator that enforces format constraints on CPT codes and modifiers, checks existence of codes against a versioned master set, and verifies referential integrity among related identifiers, all using first-principles from relational database theory and formal languages.\n\nFundamental base used for the derivation:\n- Relational Model of Data: A relation consists of tuples over attributes; a primary key uniquely identifies tuples; a foreign key must reference an existing primary key in the referenced relation. Referential integrity is the requirement that for every foreign key value $f$, there exists a matching primary key value $p$ in the referenced relation.\n- Formal Language Theory: a regular language can be recognized by a deterministic finite automaton (DFA) or matched by a regular expression; membership in a finite set can be decided by set containment.\n- CPT context: For this exercise, a CPT code is modeled as a string of exactly $5$ digits. A modifier, if present, is modeled as exactly $2$ uppercase letters or digits. Validity of a CPT code is defined by membership in a provided master set for the specific test case.\n\nYou must implement a program that validates a list of claims. Each claim is a collection of claim lines, and each claim line is a tuple with the following attributes:\n- line identifier (string),\n- claim identifier (string),\n- CPT code (string),\n- quantity (integer),\n- modifier (string; empty string means no modifier),\n- order identifier (string; empty string means no order),\n- parent line identifier (string; empty string means no parent).\n\nValidation rules to implement:\n- Format validation:\n  - CPT code must consist of exactly $5$ digits.\n  - If a modifier is present (non-empty string), it must be exactly $2$ characters, each an uppercase letter $A$–$Z$ or a digit $0$–$9$.\n- Code existence:\n  - CPT code must exist in the provided master set for the case.\n- Referential integrity:\n  - If an order identifier is present, it must exist in the provided set of valid orders.\n  - If a parent line identifier is present, it must refer to an existing line identifier within the same claim and must not be equal to its own line identifier.\n  - Line identifiers must be unique within a claim.\n- Add-on requirement:\n  - A provided mapping associates certain CPT codes (add-on codes) to one or more required base CPT codes. If a claim line’s CPT code appears as a key in the mapping, then at least one of the required base CPT codes must also appear as a CPT code in another line of the same claim.\n\nInput specification within the program:\n- Each test case is a tuple containing:\n  - a master set of CPT codes (set of strings),\n  - an add-on mapping (dictionary from string to list of strings),\n  - a set of valid order identifiers (set of strings),\n  - a list of claims; each claim is a dictionary with a claim identifier and a list of line dictionaries. Each line dictionary contains the attributes described above.\n\nOutput specification:\n- For each test case, produce a boolean indicating whether all claims in that test case pass all validation rules.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[True,False,True]\").\n\nTest suite to cover different facets:\n- Case $1$ (happy path): Master codes {\"11111\",\"12345\",\"54321\",\"77777\"}; add-on mapping {\"12345\": [\"11111\"]}; valid orders {\"ORD1\"}; claim \"C1\" has three lines: \n  - line \"L1\": code \"11111\", quantity $1$, modifier \"26\", no order, no parent;\n  - line \"L2\": code \"12345\", quantity $1$, modifier \"AA\", no order, no parent;\n  - line \"L3\": code \"54321\", quantity $2$, empty modifier, order \"ORD1\", no parent.\n  Expected result: True.\n- Case $2$ (code format boundary): Master codes {\"22222\"}; no add-ons; no orders; claim \"C2\" has one line with code \"2222\" (only $4$ digits), quantity $1$, empty modifier, no order, no parent. Expected result: False.\n- Case $3$ (modifier format edge): Master codes {\"33333\"}; no add-ons; no orders; claim \"C3\" has one line with code \"33333\", quantity $1$, modifier \"A*\", no order, no parent. Expected result: False.\n- Case $4$ (add-on without base): Master codes {\"11111\",\"12345\"}; add-on mapping {\"12345\": [\"11111\"]}; no orders; claim \"C4\" has one line with code \"12345\", quantity $1$, empty modifier, no order, no parent. Expected result: False.\n- Case $5$ (missing parent reference): Master codes {\"44444\"}; no add-ons; no orders; claim \"C5\" has one line with code \"44444\", quantity $1$, empty modifier, no order, parent \"L999\" (nonexistent). Expected result: False.\n- Case $6$ (referential integrity satisfied): Master codes {\"55555\",\"66666\"}; no add-ons; valid orders {\"ORD9\",\"ORD8\"}; claim \"C6\" has two lines:\n  - line \"L1\": code \"55555\", quantity $1$, modifier \"99\", order \"ORD9\", no parent;\n  - line \"L2\": code \"66666\", quantity $3$, modifier \"B2\", empty order, parent \"L1\".\n  Expected result: True.\n- Case $7$ (duplicate line identifiers): Master codes {\"77777\"}; no add-ons; no orders; claim \"C7\" has two lines both with line identifier \"L1\" and code \"77777\", quantities $1$, empty modifiers, no orders, no parents. Expected result: False.\n\nImplement the validator according to the rules above and apply it to the provided test suite. Your program should produce the single-line output in the specified format.", "solution": "The problem requires the implementation of a deterministic validator for a simplified model of medical claims, based on the Current Procedural Terminology (CPT) system. The validation process is grounded in first principles from relational database theory and formal language theory. A given test case is considered valid if and only if all claims within it adhere to a specific set of rules. The solution is architected as a hierarchical validator that processes each claim and its constituent lines systematically.\n\nThe core of the solution is a function that validates a single claim. A claim is a collection of lines, which can be viewed as a relation where each line is a tuple. The validation of a claim proceeds in three main stages: enforcing entity integrity for line identifiers, performing line-level validation against format and existence constraints, and finally, verifying inter-line referential integrity and other relational constraints.\n\nFirst, a preliminary check ensures the uniqueness of the `$line\\_identifier$` for all lines within a single claim. This corresponds to the entity integrity constraint in the relational model, where a primary key must uniquely identify each tuple in a relation. We achieve this by collecting all `$line\\_identifier$` values into a list and comparing its size to the size of a set constructed from the same values. If the sizes differ, a duplicate `$line\\_identifier$` exists, and the claim is invalid. This pre-computed set of unique `$line\\_identifier$`s is also used later for efficient referential integrity checks.\n\nSecond, each line in the claim is individually validated against a series of rules. This stage involves checks that can be performed on a single line tuple, sometimes with reference to external master data sets but not to other lines in the same claim.\n- **Format Validation**: This is an application of formal language theory. We verify that the `$CPT\\_code$` and `$modifier$` strings belong to specified regular languages. A valid `$CPT\\_code$` must match the pattern of exactly $5$ digits (equivalent to the regular expression `\\d{5}`). A non-empty `$modifier$` must match the pattern of exactly $2$ alphanumeric, uppercase characters (equivalent to `[A-Z0-9]{2}`). This is implemented by checking the string length and iterating through its characters to verify they fall within the allowed character sets, `$0-9$` and `$A-Z$`.\n- **Existence Validation**: This is a direct application of set theory. The `$CPT\\_code$` of a line must exist in the provided `$master\\_set$ of CPT codes. This is a simple membership test: `cpt_code` $\\in$ `master_set`.\n- **Referential Integrity (External)**: This applies the relational model's principle of referential integrity for foreign keys pointing to external relations. If a line contains a non-empty `$order\\_identifier$`, this value is treated as a foreign key that must reference a primary key in the `valid_orders` relation. This is implemented as a set membership test: `order_identifier` $\\in$ `valid_orders`.\n\nThird, after all lines have passed individual validation, claim-level checks that involve relationships between lines are performed. This stage ensures the internal consistency of the claim relation itself.\n- **Referential Integrity (Internal)**: A non-empty `$parent\\_line\\_identifier$` acts as a self-referencing foreign key. It must point to an existing `$line\\_identifier$` within the same claim. The validation ensures two conditions: the value of `$parent\\_line\\_identifier$` exists in the pre-computed set of the claim's line identifiers, and it is not a self-reference (`$parent\\_line\\_identifier$` $\\neq$ the line's own `$line\\_identifier$`).\n- **Add-on Requirement**: This is the most complex relational constraint. If a line's `$CPT\\_code$` is designated as an add-on code in the `$add\\_on\\_mapping$`, then at least one of its specified base codes must be present on a different line within the same claim. To implement this check, the algorithm iterates through each line. If the line's `$CPT\\_code$` is an add-on, it then scans all *other* lines in the claim, checking if any of their `$CPT\\_code$`s match one of the required base codes. If no such base code is found on any other line, the validation fails. This process is conceptually analogous to executing a dependent subquery or a join in a relational database to verify a condition across related tuples.\n\nA claim is deemed valid only if all its lines pass all applicable validation steps. The overall test case is valid only if every single claim within it is valid. If any check at any level fails, the validation process for that test case terminates immediately with a result of `False`.", "answer": "```python\ndef solve():\n    \"\"\"\n    Main function to define test cases and run the validator.\n    \"\"\"\n    test_cases = [\n        # Case 1: Happy path\n        (\n            {\"11111\", \"12345\", \"54321\", \"77777\"},\n            {\"12345\": [\"11111\"]},\n            {\"ORD1\"},\n            [\n                {\n                    \"claim_id\": \"C1\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"11111\", \"quantity\": 1, \"modifier\": \"26\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                        {\"line_id\": \"L2\", \"cpt_code\": \"12345\", \"quantity\": 1, \"modifier\": \"AA\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                        {\"line_id\": \"L3\", \"cpt_code\": \"54321\", \"quantity\": 2, \"modifier\": \"\", \"order_id\": \"ORD1\", \"parent_line_id\": \"\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 2: CPT code format boundary (4 digits)\n        (\n            {\"22222\"},\n            {},\n            {},\n            [\n                {\n                    \"claim_id\": \"C2\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"2222\", \"quantity\": 1, \"modifier\": \"\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 3: Modifier format edge (invalid character)\n        (\n            {\"33333\"},\n            {},\n            {},\n            [\n                {\n                    \"claim_id\": \"C3\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"33333\", \"quantity\": 1, \"modifier\": \"A*\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 4: Add-on without base\n        (\n            {\"11111\", \"12345\"},\n            {\"12345\": [\"11111\"]},\n            {},\n            [\n                {\n                    \"claim_id\": \"C4\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"12345\", \"quantity\": 1, \"modifier\": \"\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 5: Missing parent reference\n        (\n            {\"44444\"},\n            {},\n            {},\n            [\n                {\n                    \"claim_id\": \"C5\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"44444\", \"quantity\": 1, \"modifier\": \"\", \"order_id\": \"\", \"parent_line_id\": \"L999\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 6: Referential integrity satisfied\n        (\n            {\"55555\", \"66666\"},\n            {},\n            {\"ORD9\", \"ORD8\"},\n            [\n                {\n                    \"claim_id\": \"C6\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"55555\", \"quantity\": 1, \"modifier\": \"99\", \"order_id\": \"ORD9\", \"parent_line_id\": \"\"},\n                        {\"line_id\": \"L2\", \"cpt_code\": \"66666\", \"quantity\": 3, \"modifier\": \"B2\", \"order_id\": \"\", \"parent_line_id\": \"L1\"},\n                    ]\n                }\n            ]\n        ),\n        # Case 7: Duplicate line identifiers\n        (\n            {\"77777\"},\n            {},\n            {},\n            [\n                {\n                    \"claim_id\": \"C7\",\n                    \"lines\": [\n                        {\"line_id\": \"L1\", \"cpt_code\": \"77777\", \"quantity\": 1, \"modifier\": \"\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                        {\"line_id\": \"L1\", \"cpt_code\": \"77777\", \"quantity\": 1, \"modifier\": \"\", \"order_id\": \"\", \"parent_line_id\": \"\"},\n                    ]\n                }\n            ]\n        )\n    ]\n\n    results = []\n    for case in test_cases:\n        results.append(validate_test_case(case))\n\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef validate_test_case(case_data):\n    \"\"\"\n    Validates an entire test case. A case is valid if all its claims are valid.\n    \"\"\"\n    master_codes, addon_map, valid_orders, claims = case_data\n    for claim in claims:\n        if not validate_claim(claim['lines'], master_codes, addon_map, valid_orders):\n            return False\n    return True\n\ndef validate_claim(lines, master_codes, addon_map, valid_orders):\n    \"\"\"\n    Validates a single claim by checking all its lines against all rules.\n    \"\"\"\n    # Rule: Line identifiers must be unique within a claim.\n    line_ids_list = [line['line_id'] for line in lines]\n    if len(line_ids_list) != len(set(line_ids_list)):\n        return False\n    line_id_set = set(line_ids_list)\n\n    # First pass: validate individual line properties (format, existence, external refs)\n    for line in lines:\n        # Rule: CPT code must consist of exactly 5 digits.\n        cpt_code = line['cpt_code']\n        if not (isinstance(cpt_code, str) and len(cpt_code) == 5 and cpt_code.isdigit()):\n            return False\n\n        # Rule: Modifier, if present, must be 2 uppercase alphanumeric characters.\n        modifier = line['modifier']\n        if modifier:\n            if not(isinstance(modifier, str) and len(modifier) == 2):\n                return False\n            for char in modifier:\n                if not (char.isdigit() or ('A' = char = 'Z')):\n                    return False\n\n        # Rule: CPT code must exist in the master set.\n        if cpt_code not in master_codes:\n            return False\n\n        # Rule: Order identifier, if present, must be in the valid set.\n        order_id = line['order_id']\n        if order_id and order_id not in valid_orders:\n            return False\n\n        # Rule: Parent line identifier, if present, must refer to an existing line.\n        parent_line_id = line['parent_line_id']\n        if parent_line_id:\n            if parent_line_id not in line_id_set:\n                return False\n            # Rule: ... and must not be equal to its own line identifier.\n            if parent_line_id == line['line_id']:\n                return False\n\n    # Second pass: validate inter-line relationships (add-on requirement)\n    for line in lines:\n        cpt_code = line['cpt_code']\n        # Rule: Check add-on requirement.\n        if cpt_code in addon_map:\n            required_bases = set(addon_map[cpt_code])\n            found_base_on_other_line = False\n            for other_line in lines:\n                if line['line_id'] != other_line['line_id']:\n                    if other_line['cpt_code'] in required_bases:\n                        found_base_on_other_line = True\n                        break\n            if not found_base_on_other_line:\n                return False\n\n    return True\n\nsolve()\n```", "id": "4831697"}]}