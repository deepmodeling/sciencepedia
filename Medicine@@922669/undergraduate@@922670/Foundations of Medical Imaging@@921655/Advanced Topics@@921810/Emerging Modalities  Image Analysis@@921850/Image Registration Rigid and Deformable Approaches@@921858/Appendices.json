{"hands_on_practices": [{"introduction": "This first exercise grounds the theory of rigid registration in a practical scenario. You will estimate a 2D rigid transformation by aligning sets of corresponding fiducial markers using the least-squares method. This practice is crucial for understanding how to evaluate the quality of a registration, introducing the concept of Target Registration Error (TRE) to measure accuracy on independent landmarks. [@problem_id:4892896]", "problem": "A two-dimensional rigid registration is performed between a pre-operative axial slice and an intra-operative axial slice of the same patient. The rigid transform from the pre-operative coordinate system to the intra-operative coordinate system is of the form $\\mathbf{x}' = \\mathbf{R}\\mathbf{x} + \\mathbf{t}$, where $\\mathbf{R} \\in \\mathbb{R}^{2 \\times 2}$ is a rotation matrix with $\\det(\\mathbf{R}) = 1$ and $\\mathbf{t} \\in \\mathbb{R}^{2}$ is a translation vector. The transform is estimated by minimizing the sum of squared distances between corresponding fiducial landmarks (least squares). Use only the following foundational facts: a rigid transform preserves distances and angles; a least-squares rigid alignment that minimizes the sum of squared inter-landmark distances is achieved by aligning centroids and then finding the rotation that best aligns centered point sets.\n\nYou are given the following fiducial correspondences (all coordinates are in millimeters), where the first coordinate in each pair is in the pre-operative frame and the second is in the intra-operative frame:\n- $\\mathbf{p}_{1} = (0,\\,0)$ corresponds to $\\mathbf{q}_{1} = (1,\\,2)$,\n- $\\mathbf{p}_{2} = (1,\\,0)$ corresponds to $\\mathbf{q}_{2} = (1,\\,3)$,\n- $\\mathbf{p}_{3} = (0,\\,2)$ corresponds to $\\mathbf{q}_{3} = (-1,\\,2)$.\n\nAfter estimating the rigid transform from these fiducials, you will evaluate the Root Mean Square Target Registration Error (RMS-TRE) on two independent target landmarks (not used in the estimation). The target landmarks are:\n- $\\mathbf{t}_{1} = (2,\\,1)$ in the pre-operative frame corresponds to $\\mathbf{u}_{1} = (0.2,\\,3.8)$ in the intra-operative frame,\n- $\\mathbf{t}_{2} = (-1,\\,1)$ in the pre-operative frame corresponds to $\\mathbf{u}_{2} = (0.2,\\,1.2)$ in the intra-operative frame.\n\nTasks:\n1. From first principles of rigid alignment, determine the least-squares rigid transform parameters $(\\mathbf{R}, \\mathbf{t})$ that map the pre-operative frame to the intra-operative frame using the fiducials $\\{\\mathbf{p}_{i}\\} \\leftrightarrow \\{\\mathbf{q}_{i}\\}$.\n2. Apply the estimated transform to the target landmarks $\\{\\mathbf{t}_{j}\\}$ to obtain transformed points $\\{\\hat{\\mathbf{u}}_{j}\\}$ in the intra-operative frame. Compute the Root Mean Square Target Registration Error (RMS-TRE) defined as\n$$\n\\mathrm{RMS-TRE} \\;=\\; \\sqrt{\\frac{1}{M}\\sum_{j=1}^{M} \\lVert \\hat{\\mathbf{u}}_{j} - \\mathbf{u}_{j} \\rVert^{2}},\n$$\nwhere $\\lVert \\cdot \\rVert$ denotes the Euclidean norm and $M$ is the number of target landmarks.\n3. Compute the pre-registration RMS error on the same targets, defined as\n$$\n\\mathrm{RMS-pre} \\;=\\; \\sqrt{\\frac{1}{M}\\sum_{j=1}^{M} \\lVert \\mathbf{t}_{j} - \\mathbf{u}_{j} \\rVert^{2}},\n$$\nwhich corresponds to evaluating the error under the identity mapping (no registration).\n4. Report the single dimensionless ratio\n$$\nr \\;=\\; \\frac{\\mathrm{RMS-TRE}}{\\mathrm{RMS-pre}}.\n$$\n\nRound your final answer for $r$ to four significant figures. Do not include any unit with your final answer. Angles, if any are used internally, must be treated in radians, but no angle is requested in the final answer.", "solution": "The goal is to find the 2D rigid transformation $\\mathbf{x}' = \\mathbf{R}\\mathbf{x} + \\mathbf{t}$ that aligns the pre-operative fiducials $\\{\\mathbf{p}_i\\}$ with the intra-operative fiducials $\\{\\mathbf{q}_i\\}$ using a least-squares approach, and then evaluate the accuracy on separate target landmarks.\n\n### Task 1: Determine the Rigid Transform $(\\mathbf{R}, \\mathbf{t})$\n\nThe standard method for least-squares rigid alignment separates the estimation of rotation and translation. First, the centroids of the point sets are aligned, and then the optimal rotation is found for the centered points.\n\n**1. Calculate Centroids:**\nThe centroids of the pre-operative points $\\{\\mathbf{p}_i\\}$ and intra-operative points $\\{\\mathbf{q}_i\\}$ are:\n$$ \\bar{\\mathbf{p}} = \\frac{1}{3} \\sum_{i=1}^{3} \\mathbf{p}_{i} = \\frac{1}{3} \\left( \\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix} + \\begin{pmatrix} 0 \\\\ 2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/3 \\\\ 2/3 \\end{pmatrix} $$\n$$ \\bar{\\mathbf{q}} = \\frac{1}{3} \\sum_{i=1}^{3} \\mathbf{q}_{i} = \\frac{1}{3} \\left( \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 3 \\end{pmatrix} + \\begin{pmatrix} -1 \\\\ 2 \\end{pmatrix} \\right) = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} $$\n\n**2. Determine Rotation $\\mathbf{R}$:**\nSince the problem fiducials correspond to a perfect rigid transformation (i.e., the distances between points are preserved), we can find the rotation matrix $\\mathbf{R}$ directly by aligning relative vectors. Let's consider the vectors originating from point 1:\n- Pre-operative vectors: $\\mathbf{v}_1 = \\mathbf{p}_2 - \\mathbf{p}_1 = (1, 0)^T$, $\\mathbf{v}_2 = \\mathbf{p}_3 - \\mathbf{p}_1 = (0, 2)^T$.\n- Intra-operative vectors: $\\mathbf{w}_1 = \\mathbf{q}_2 - \\mathbf{q}_1 = (0, 1)^T$, $\\mathbf{w}_2 = \\mathbf{q}_3 - \\mathbf{q}_1 = (-2, 0)^T$.\n\nWe need to find $\\mathbf{R}$ such that $\\mathbf{R}\\mathbf{v}_1 = \\mathbf{w}_1$ and $\\mathbf{R}\\mathbf{v}_2 = \\mathbf{w}_2$. Let $\\mathbf{R} = \\begin{pmatrix} \\cos\\theta  -\\sin\\theta \\\\ \\sin\\theta  \\cos\\theta \\end{pmatrix}$.\nFrom $\\mathbf{R}\\mathbf{v}_1 = \\mathbf{w}_1$:\n$$ \\begin{pmatrix} \\cos\\theta \\\\ \\sin\\theta \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} \\implies \\theta = \\pi/2 $$\nThis gives $\\mathbf{R} = \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix}$. We verify with the second pair of vectors:\n$$ \\mathbf{R}\\mathbf{v}_2 = \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -2 \\\\ 0 \\end{pmatrix} = \\mathbf{w}_2 $$\nThe rotation matrix is correct.\n\n**3. Determine Translation $\\mathbf{t}$:**\nThe translation vector is found by ensuring the centroids align after rotation: $\\mathbf{t} = \\bar{\\mathbf{q}} - \\mathbf{R}\\bar{\\mathbf{p}}$.\n$$ \\mathbf{t} = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} - \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix} \\begin{pmatrix} 1/3 \\\\ 2/3 \\end{pmatrix} = \\begin{pmatrix} 1/3 \\\\ 7/3 \\end{pmatrix} - \\begin{pmatrix} -2/3 \\\\ 1/3 \\end{pmatrix} = \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} $$\nThe complete rigid transform is defined by $\\mathbf{R} = \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix}$ and $\\mathbf{t} = \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix}$.\n\n### Task 2: Compute Root Mean Square Target Registration Error (RMS-TRE)\n\nWe apply the estimated transform to the target landmarks $\\{\\mathbf{t}_j\\}$ and compare to the ground truth $\\{\\mathbf{u}_j\\}$.\n- Target 1: $\\mathbf{t}_1 = (2, 1)^T$, $\\mathbf{u}_1 = (0.2, 3.8)^T$\n  $$ \\hat{\\mathbf{u}}_1 = \\mathbf{R}\\mathbf{t}_1 + \\mathbf{t} = \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix}\\begin{pmatrix} 2 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ 2 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 4 \\end{pmatrix} $$\n  The squared error is $e_1^2 = \\lVert \\hat{\\mathbf{u}}_1 - \\mathbf{u}_1 \\rVert^2 = \\lVert (0, 4)^T - (0.2, 3.8)^T \\rVert^2 = (-0.2)^2 + (0.2)^2 = 0.04 + 0.04 = 0.08$.\n- Target 2: $\\mathbf{t}_2 = (-1, 1)^T$, $\\mathbf{u}_2 = (0.2, 1.2)^T$\n  $$ \\hat{\\mathbf{u}}_2 = \\mathbf{R}\\mathbf{t}_2 + \\mathbf{t} = \\begin{pmatrix} 0  -1 \\\\ 1  0 \\end{pmatrix}\\begin{pmatrix} -1 \\\\ 1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} -1 \\\\ -1 \\end{pmatrix} + \\begin{pmatrix} 1 \\\\ 2 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix} $$\n  The squared error is $e_2^2 = \\lVert \\hat{\\mathbf{u}}_2 - \\mathbf{u}_2 \\rVert^2 = \\lVert (0, 1)^T - (0.2, 1.2)^T \\rVert^2 = (-0.2)^2 + (-0.2)^2 = 0.04 + 0.04 = 0.08$.\n\nThe RMS-TRE is:\n$$ \\mathrm{RMS-TRE} = \\sqrt{\\frac{1}{2}(e_1^2 + e_2^2)} = \\sqrt{\\frac{1}{2}(0.08 + 0.08)} = \\sqrt{0.08} $$\n\n### Task 3: Compute Pre-registration RMS Error (RMS-pre)\n\nThis is the error before registration is applied.\n- Target 1: Squared error $d_1^2 = \\lVert \\mathbf{t}_1 - \\mathbf{u}_1 \\rVert^2 = \\lVert (2, 1)^T - (0.2, 3.8)^T \\rVert^2 = (1.8)^2 + (-2.8)^2 = 3.24 + 7.84 = 11.08$.\n- Target 2: Squared error $d_2^2 = \\lVert \\mathbf{t}_2 - \\mathbf{u}_2 \\rVert^2 = \\lVert (-1, 1)^T - (0.2, 1.2)^T \\rVert^2 = (-1.2)^2 + (-0.2)^2 = 1.44 + 0.04 = 1.48$.\n\nThe RMS-pre is:\n$$ \\mathrm{RMS-pre} = \\sqrt{\\frac{1}{2}(d_1^2 + d_2^2)} = \\sqrt{\\frac{1}{2}(11.08 + 1.48)} = \\sqrt{\\frac{12.56}{2}} = \\sqrt{6.28} $$\n\n### Task 4: Report the Ratio $r$\n\nThe final ratio is:\n$$ r = \\frac{\\mathrm{RMS-TRE}}{\\mathrm{RMS-pre}} = \\frac{\\sqrt{0.08}}{\\sqrt{6.28}} = \\sqrt{\\frac{0.08}{6.28}} = \\sqrt{\\frac{2}{157}} \\approx 0.1128665... $$\nRounding to four significant figures, the ratio is $0.1129$.", "answer": "$$ \\boxed{0.1129} $$", "id": "4892896"}, {"introduction": "Building on rigid alignment, this practice explores the more flexible affine transformation model. You will derive the least-squares estimator for an affine map and discover a critical aspect of practical implementation: numerical stability. By analyzing the condition number of the system with and without data normalization, you will see firsthand why pre-processing coordinates is not just good practice, but essential for robust results. [@problem_id:4892850]", "problem": "Consider two-dimensional affine image registration between a source image and a target image, where a point $\\mathbf{x} \\in \\mathbb{R}^{2}$ in the source is mapped to the target by $\\mathbf{y} = \\mathbf{A}\\mathbf{x} + \\mathbf{t}$ with $\\mathbf{A} \\in \\mathbb{R}^{2 \\times 2}$ and $\\mathbf{t} \\in \\mathbb{R}^{2}$. Suppose you are given $M$ corresponding landmark pairs $\\{(\\mathbf{x}_{i}, \\mathbf{y}_{i})\\}_{i=1}^{M}$ and you wish to estimate the affine parameters by minimizing the sum of squared residuals.\n\nStarting from the linear least-squares formulation and the definition of the Singular Value Decomposition (SVD), derive the least-squares estimator for the affine parameters by explicitly constructing the stacked linear system for the unknowns and expressing the solution in terms of the SVD of the design matrix. Then, analyze the numerical conditioning with and without isotropic normalization of the source coordinates.\n\nUse the following noise-free correspondences with $M = 4$ source landmarks:\n- $\\mathbf{x}_{1} = (1000, 1)$,\n- $\\mathbf{x}_{2} = (2000, -1)$,\n- $\\mathbf{x}_{3} = (-1000, 1)$,\n- $\\mathbf{x}_{4} = (-2000, -1)$,\n\nand the target landmarks generated by a fixed underlying affine transform $\\mathbf{A}_{\\text{true}} = \\begin{pmatrix} 2  0.5 \\\\ -0.25  1 \\end{pmatrix}$ and $\\mathbf{t}_{\\text{true}} = \\begin{pmatrix} 10 \\\\ -5 \\end{pmatrix}$.\n\nDefine the $2$-norm condition number $\\kappa_{2}(\\mathbf{H})$ of the design matrix $\\mathbf{H}$ as the ratio of its largest to smallest singular values. Compute:\n1. $\\kappa_{2}$ for the unnormalized design matrix built from the given source landmarks.\n2. $\\kappa_{2}$ for the design matrix after isotropic normalization of the source coordinates, where normalization is defined as subtracting the mean of $\\{x_{i}\\}$ and $\\{y_{i}\\}$ and then scaling by $s_{x} = \\sqrt{\\frac{1}{M}\\sum_{i=1}^{M} x_{i}^{2}}$ and $s_{y} = \\sqrt{\\frac{1}{M}\\sum_{i=1}^{M} y_{i}^{2}}$ so that the normalized coordinates have zero mean and unit variance along each axis.\n\nReport the single scalar ratio $\\kappa_{2,\\text{unnorm}} / \\kappa_{2,\\text{norm}}$. Round your final answer to four significant figures. No units are required. Your derivation must start from the linear least-squares setup and the definition of SVD, and must justify the conditioning behavior you compute.", "solution": "### Derivation of the Least-Squares Estimator\n\nThe affine transformation for a point $\\mathbf{x}_i = (x_{i1}, x_{i2})^T$ to a point $\\mathbf{y}_i = (y_{i1}, y_{i2})^T$ is given by $\\mathbf{y}_i = \\mathbf{A}\\mathbf{x}_i + \\mathbf{t}$. This can be rewritten using homogeneous coordinates. Let $\\tilde{\\mathbf{x}}_i = (x_{i1}, x_{i2}, 1)^T$. The transformation can be expressed as a single matrix multiplication:\n$$ \\begin{pmatrix} y_{i1} \\\\ y_{i2} \\end{pmatrix} = \\begin{pmatrix} a_{11}  a_{12}  t_1 \\\\ a_{21}  a_{22}  t_2 \\end{pmatrix} \\begin{pmatrix} x_{i1} \\\\ x_{i2} \\\\ 1 \\end{pmatrix} $$\nTo solve for the 6 unknown parameters, we can formulate a linear system. The two equations for the $i$-th point are:\n$$ y_{i1} = a_{11}x_{i1} + a_{12}x_{i2} + t_1 $$\n$$ y_{i2} = a_{21}x_{i1} + a_{22}x_{i2} + t_2 $$\nNotice that the parameters for each row are independent. We can create a design matrix $\\mathbf{P}$ from the source coordinates:\n$$ \\mathbf{P} = \\begin{pmatrix}\nx_{11}  x_{12}  1 \\\\\nx_{21}  x_{22}  1 \\\\\n\\vdots  \\vdots  \\vdots \\\\\nx_{M1}  x_{M2}  1\n\\end{pmatrix} $$\nThe unknown parameters can be arranged into vectors $\\mathbf{p}_1 = (a_{11}, a_{12}, t_1)^T$ and $\\mathbf{p}_2 = (a_{21}, a_{22}, t_2)^T$. The target coordinates form vectors $\\mathbf{b}_1 = (y_{11}, \\dots, y_{M1})^T$ and $\\mathbf{b}_2 = (y_{12}, \\dots, y_{M2})^T$.\nThe problem reduces to two independent linear least-squares systems:\n$$ \\mathbf{P}\\mathbf{p}_1 = \\mathbf{b}_1 \\quad \\text{and} \\quad \\mathbf{P}\\mathbf{p}_2 = \\mathbf{b}_2 $$\nThe numerical stability of solving these systems depends on the condition number of the design matrix $\\mathbf{P}$. The condition number is defined as $\\kappa_2(\\mathbf{P}) = \\sigma_{\\max} / \\sigma_{\\min}$, where $\\sigma_{\\max}$ and $\\sigma_{\\min}$ are the largest and smallest singular values of $\\mathbf{P}$.\n\n### Task 1: Condition Number for Unnormalized Coordinates\n\nThe source points are $\\mathbf{x}_{1}=(1000, 1)$, $\\mathbf{x}_{2}=(2000, -1)$, $\\mathbf{x}_{3}=(-1000, 1)$, $\\mathbf{x}_{4}=(-2000, -1)$. The unnormalized design matrix $\\mathbf{P}_{\\text{unnorm}}$ is:\n$$ \\mathbf{P}_{\\text{unnorm}} = \\begin{pmatrix} 1000  1  1 \\\\ 2000  -1  1 \\\\ -1000  1  1 \\\\ -2000  -1  1 \\end{pmatrix} $$\nThe singular values are the square roots of the eigenvalues of $\\mathbf{P}_{\\text{unnorm}}^T \\mathbf{P}_{\\text{unnorm}}$.\n$$ \\mathbf{P}_{\\text{unnorm}}^T \\mathbf{P}_{\\text{unnorm}} = \\begin{pmatrix} \\sum x_i^2  \\sum x_i y_i  \\sum x_i \\\\ \\sum x_i y_i  \\sum y_i^2  \\sum y_i \\\\ \\sum x_i  \\sum y_i  M \\end{pmatrix} $$\nWe compute the sums:\n- $\\sum x_i = 1000 + 2000 - 1000 - 2000 = 0$\n- $\\sum y_i = 1 - 1 + 1 - 1 = 0$\n- $\\sum x_i^2 = 1000^2 + 2000^2 + (-1000)^2 + (-2000)^2 = 10 \\times 10^6$\n- $\\sum y_i^2 = 1^2 + (-1)^2 + 1^2 + (-1)^2 = 4$\n- $\\sum x_i y_i = 1000(1) + 2000(-1) - 1000(1) - 2000(-1) = 0$\n- $M = 4$\n\nThe matrix is diagonal:\n$$ \\mathbf{P}_{\\text{unnorm}}^T\\mathbf{P}_{\\text{unnorm}} = \\begin{pmatrix} 10 \\times 10^6  0  0 \\\\ 0  4  0 \\\\ 0  0  4 \\end{pmatrix} $$\nThe eigenvalues are $\\lambda_1 = 10^7, \\lambda_2 = 4, \\lambda_3 = 4$. The singular values of $\\mathbf{P}_{\\text{unnorm}}$ are their square roots:\n- $\\sigma_{\\max} = \\sqrt{10^7} = 1000\\sqrt{10}$\n- $\\sigma_{\\min} = \\sqrt{4} = 2$\nThe condition number for the unnormalized case is:\n$$ \\kappa_{2,\\text{unnorm}} = \\frac{\\sigma_{\\max}}{\\sigma_{\\min}} = \\frac{1000\\sqrt{10}}{2} = 500\\sqrt{10} $$\n\n### Task 2: Condition Number for Normalized Coordinates\n\nNormalization involves centering and scaling the data.\n1.  **Centering**: The mean of the source coordinates is $(\\bar{x}, \\bar{y}) = (0, 0)$. The data is already centered.\n2.  **Scaling**: The scaling factors are defined as the Root Mean Square of each coordinate:\n    - $s_x = \\sqrt{\\frac{1}{M}\\sum x_i^2} = \\sqrt{\\frac{1}{4}(10 \\times 10^6)} = \\sqrt{2.5 \\times 10^6} = 500\\sqrt{10}$\n    - $s_y = \\sqrt{\\frac{1}{M}\\sum y_i^2} = \\sqrt{\\frac{1}{4}(4)} = 1$\nThe normalized coordinates $\\tilde{\\mathbf{x}}_i = (x_i/s_x, y_i/s_y)$ are used to build the new design matrix $\\mathbf{P}_{\\text{norm}}$. For this new matrix, we compute the sums:\n- $\\sum \\tilde{x}_i = 0$ and $\\sum \\tilde{y}_i = 0$ (since data was centered).\n- $\\sum \\tilde{x}_i^2 = \\sum (x_i/s_x)^2 = \\frac{1}{s_x^2} \\sum x_i^2 = \\frac{1}{(\\frac{1}{M}\\sum x_i^2)} \\sum x_i^2 = M = 4$.\n- $\\sum \\tilde{y}_i^2 = \\sum (y_i/s_y)^2 = \\frac{1}{s_y^2} \\sum y_i^2 = \\frac{1}{(\\frac{1}{M}\\sum y_i^2)} \\sum y_i^2 = M = 4$.\n- $\\sum \\tilde{x}_i \\tilde{y}_i = \\frac{1}{s_x s_y} \\sum x_i y_i = 0$.\nThe matrix $\\mathbf{P}_{\\text{norm}}^T\\mathbf{P}_{\\text{norm}}$ is:\n$$ \\mathbf{P}_{\\text{norm}}^T\\mathbf{P}_{\\text{norm}} = \\begin{pmatrix} 4  0  0 \\\\ 0  4  0 \\\\ 0  0  4 \\end{pmatrix} = 4\\mathbf{I}_3 $$\nThe eigenvalues are all $\\lambda = 4$. The singular values of $\\mathbf{P}_{\\text{norm}}$ are all $\\sigma = \\sqrt{4} = 2$.\nThe condition number for the normalized case is:\n$$ \\kappa_{2,\\text{norm}} = \\frac{\\sigma_{\\max}}{\\sigma_{\\min}} = \\frac{2}{2} = 1 $$\nA condition number of 1 is optimal, indicating a perfectly conditioned problem. Normalization has balanced the scales of the columns in the design matrix, drastically improving numerical stability.\n\n### Final Ratio Calculation\n\nThe ratio of the condition numbers is:\n$$ \\frac{\\kappa_{2,\\text{unnorm}}}{\\kappa_{2,\\text{norm}}} = \\frac{500\\sqrt{10}}{1} = 500\\sqrt{10} $$\nComputing the numerical value:\n$$ 500\\sqrt{10} \\approx 500 \\times 3.16227766 \\approx 1581.1388... $$\nRounding to four significant figures gives $1581$.", "answer": "$$\\boxed{1581}$$", "id": "4892850"}, {"introduction": "Our final practice problem transitions from global transformations to the powerful world of deformable registration. Using a Free-Form Deformation (FFD) model based on B-splines, you will investigate a fundamental property of the deformation field: its local invertibility. By calculating the Jacobian determinant, you will practice the essential skill of checking for \"folding,\" ensuring the transformation remains physically plausible. [@problem_id:4892868]", "problem": "Consider a two-dimensional Free-Form Deformation (FFD) based on tensor-product cubic B-splines for image registration. Let the spatial transform be defined as a displacement field superposed on the identity mapping, where the deformed position is given by $\\mathbf{T}(x,y) = (x,y) + \\mathbf{u}(x,y)$. The displacement field is constructed from a uniform control lattice of spacing $h$ using the tensor-product cubic B-spline basis functions. Within any lattice cell, introduce the parametric coordinates $s \\in [0,1]$ and $t \\in [0,1]$, and let the local displacement be $\\mathbf{u}(x,y) = \\sum_{p=0}^{3} \\sum_{q=0}^{3} B_{p}(s) B_{q}(t) \\,\\mathbf{d}_{p,q}$, where $\\mathbf{d}_{p,q} = (d^{x}_{p,q}, d^{y}_{p,q})$ are the control point displacements.\n\nThe cubic B-spline basis functions on $[0,1]$ are defined by\n$$\nB_{0}(r) = \\frac{(1-r)^{3}}{6}, \\quad\nB_{1}(r) = \\frac{3r^{3} - 6r^{2} + 4}{6}, \\quad\nB_{2}(r) = \\frac{-3r^{3} + 3r^{2} + 3r + 1}{6}, \\quad\nB_{3}(r) = \\frac{r^{3}}{6},\n$$\nfor any scalar argument $r \\in [0,1]$.\n\nAssume a single nonzero control displacement within the $4 \\times 4$ neighborhood influencing the evaluation point: specifically, $\\mathbf{d}_{1,2} = (a,b)$ with $a = 2$ mm and $b = -1$ mm, and all other $\\mathbf{d}_{p,q} = (0,0)$. The control lattice spacing is $h = 20$ mm. Evaluate at the center of the cell, where $s = 0.5$ and $t = 0.5$.\n\nStarting from the definitions above and basic multivariable calculus (chain rule), compute the Jacobian determinant $J(x,y) = \\det\\!\\left(\\nabla \\mathbf{T}(x,y)\\right)$ at the evaluation point. Then, determine whether the mapping is locally invertible by checking the sign of $J(x,y)$. Express the final answer as a single exact value for the Jacobian determinant (dimensionless). No rounding is required.", "solution": "The transformation is given by $\\mathbf{T}(x,y) = (x,y) + \\mathbf{u}(x,y)$. Its Jacobian matrix is $\\nabla \\mathbf{T} = \\mathbf{I} + \\nabla \\mathbf{u}$, where $\\mathbf{I}$ is the $2 \\times 2$ identity matrix and $\\nabla \\mathbf{u}$ is the Jacobian of the displacement field.\n\n### Step 1: Simplify the Displacement Field\nGiven that only the control point displacement $\\mathbf{d}_{1,2} = (a, b)$ is non-zero, the summation for the displacement field $\\mathbf{u}(x,y)$ simplifies to a single term:\n$$ \\mathbf{u}(x,y) = B_{1}(s) B_{2}(t) \\, \\mathbf{d}_{1,2} $$\nThe scalar components of the displacement are:\n$$ u_x(x,y) = a B_{1}(s) B_{2}(t) $$\n$$ u_y(x,y) = b B_{1}(s) B_{2}(t) $$\n\n### Step 2: Compute the Jacobian of the Displacement Field\nWe need to find the partial derivatives of $u_x$ and $u_y$ with respect to $x$ and $y$. The parametric coordinates $(s, t)$ are linked to the spatial coordinates $(x, y)$ by the control lattice spacing $h$: $s = (x - x_0)/h$ and $t = (y - y_0)/h$ for a cell origin $(x_0, y_0)$. Therefore, $\\frac{\\partial s}{\\partial x} = \\frac{1}{h}$, $\\frac{\\partial s}{\\partial y} = 0$, $\\frac{\\partial t}{\\partial x} = 0$, and $\\frac{\\partial t}{\\partial y} = \\frac{1}{h}$.\n\nUsing the chain rule, and denoting the derivative of a basis function as $B'(r) = \\frac{dB}{dr}$:\n$$ \\frac{\\partial u_x}{\\partial x} = \\frac{\\partial}{\\partial s}(a B_{1}(s) B_{2}(t)) \\frac{\\partial s}{\\partial x} = \\frac{a}{h} B'_{1}(s) B_{2}(t) $$\n$$ \\frac{\\partial u_x}{\\partial y} = \\frac{\\partial}{\\partial t}(a B_{1}(s) B_{2}(t)) \\frac{\\partial t}{\\partial y} = \\frac{a}{h} B_{1}(s) B'_{2}(t) $$\n$$ \\frac{\\partial u_y}{\\partial x} = \\frac{\\partial}{\\partial s}(b B_{1}(s) B_{2}(t)) \\frac{\\partial s}{\\partial x} = \\frac{b}{h} B'_{1}(s) B_{2}(t) $$\n$$ \\frac{\\partial u_y}{\\partial y} = \\frac{\\partial}{\\partial t}(b B_{1}(s) B_{2}(t)) \\frac{\\partial t}{\\partial y} = \\frac{b}{h} B_{1}(s) B'_{2}(t) $$\nThe Jacobian matrix of the transformation $\\mathbf{T}$ is therefore:\n$$ \\nabla \\mathbf{T} = \\begin{pmatrix} 1 + \\frac{a}{h} B'_{1}(s) B_{2}(t)  \\frac{a}{h} B_{1}(s) B'_{2}(t) \\\\ \\frac{b}{h} B'_{1}(s) B_{2}(t)  1 + \\frac{b}{h} B_{1}(s) B'_{2}(t) \\end{pmatrix} $$\n\n### Step 3: Calculate the Jacobian Determinant\nThe determinant $J = \\det(\\nabla \\mathbf{T})$ is:\n$$ J = \\left(1 + \\frac{a}{h} B'_{1}(s) B_{2}(t)\\right)\\left(1 + \\frac{b}{h} B_{1}(s) B'_{2}(t)\\right) - \\left(\\frac{a}{h} B_{1}(s) B'_{2}(t)\\right)\\left(\\frac{b}{h} B'_{1}(s) B_{2}(t)\\right) $$\nExpanding and simplifying, the cross-product terms cancel out:\n$$ J = 1 + \\frac{a}{h} B'_{1}(s) B_{2}(t) + \\frac{b}{h} B_{1}(s) B'_{2}(t) $$\n\n### Step 4: Evaluate Basis Functions and Derivatives\nWe need the values of $B_1(r)$, $B_2(r)$, $B'_1(r)$, and $B'_2(r)$ at the evaluation point $s=t=r=0.5$.\nThe derivatives of the basis functions are:\n$$ B'_{1}(r) = \\frac{9r^2 - 12r}{6} = \\frac{3r^2 - 4r}{2} $$\n$$ B'_{2}(r) = \\frac{-9r^2 + 6r + 3}{6} = \\frac{-3r^2 + 2r + 1}{2} $$\nAt $r=0.5$:\n$$ B_{1}(0.5) = \\frac{3(0.5)^{3} - 6(0.5)^{2} + 4}{6} = \\frac{3/8 - 6/4 + 4}{6} = \\frac{3/8 - 12/8 + 32/8}{6} = \\frac{23/8}{6} = \\frac{23}{48} $$\n$$ B_{2}(0.5) = \\frac{-3(0.5)^{3} + 3(0.5)^{2} + 3(0.5) + 1}{6} = \\frac{-3/8 + 3/4 + 3/2 + 1}{6} = \\frac{-3/8 + 6/8 + 12/8 + 8/8}{6} = \\frac{23/8}{6} = \\frac{23}{48} $$\n$$ B'_{1}(0.5) = \\frac{3(0.5)^2 - 4(0.5)}{2} = \\frac{3/4 - 2}{2} = \\frac{-5/4}{2} = -\\frac{5}{8} $$\n$$ B'_{2}(0.5) = \\frac{-3(0.5)^2 + 2(0.5) + 1}{2} = \\frac{-3/4 + 1 + 1}{2} = \\frac{5/4}{2} = \\frac{5}{8} $$\n\n### Step 5: Compute the Final Value\nSubstitute the given values $a=2$, $b=-1$, $h=20$ and the calculated function values into the expression for $J$:\n$$ J = 1 + \\frac{2}{20} \\left(-\\frac{5}{8}\\right) \\left(\\frac{23}{48}\\right) + \\frac{-1}{20} \\left(\\frac{23}{48}\\right) \\left(\\frac{5}{8}\\right) $$\n$$ J = 1 - \\frac{1}{10} \\left(\\frac{115}{384}\\right) - \\frac{1}{20} \\left(\\frac{115}{384}\\right) $$\nFactor out the common term $\\frac{115}{384}$:\n$$ J = 1 - \\frac{115}{384} \\left(\\frac{1}{10} + \\frac{1}{20}\\right) = 1 - \\frac{115}{384} \\left(\\frac{2+1}{20}\\right) = 1 - \\frac{115}{384} \\left(\\frac{3}{20}\\right) $$\n$$ J = 1 - \\frac{345}{7680} $$\nSimplify the fraction:\n$$ \\frac{345}{7680} = \\frac{69}{1536} = \\frac{23}{512} $$\nThe Jacobian determinant is:\n$$ J = 1 - \\frac{23}{512} = \\frac{512 - 23}{512} = \\frac{489}{512} $$\nSince $J = 489/512 > 0$, the transformation is locally invertible and orientation-preserving at this point. The exact value of the determinant is $\\frac{489}{512}$.", "answer": "$$\n\\boxed{\\frac{489}{512}}\n$$", "id": "4892868"}]}