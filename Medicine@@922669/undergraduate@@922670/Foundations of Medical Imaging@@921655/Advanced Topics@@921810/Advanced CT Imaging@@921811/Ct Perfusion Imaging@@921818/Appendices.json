{"hands_on_practices": [{"introduction": "CT perfusion analysis begins with measuring how contrast concentration changes over time in a feeding artery. However, a CT scanner measures X-ray attenuation in Hounsfield Units (HU), not concentration directly. This first practice guides you through the fundamental step of converting the measured enhancement curve, $\\Delta HU(t)$, into a true arterial concentration curve, $c_a(t)$, using a calibration factor. By also calculating how uncertainty in this factor affects your result [@problem_id:4873907], you will engage with the crucial concept of error propagation in quantitative imaging.", "problem": "In X-ray Computed Tomography (CT) perfusion imaging, the change in CT number in Hounsfield Units (HU) within an arterial region of interest (ROI), denoted by $\\Delta HU(t)$, arises primarily from the additional linear attenuation due to iodinated contrast material. At a fixed tube potential and reconstruction setting, assume a linear relationship between the iodine concentration $c_{a}(t)$ in $\\mathrm{mg/mL}$ and the change in CT number $\\Delta HU(t)$, characterized by a calibration factor $k$ with units $\\mathrm{HU}/(\\mathrm{mg/mL})$. This linearity follows from the definition of HU, additive linear attenuation of mixtures, and the proportionality of iodine’s contribution to the linear attenuation coefficient to its concentration.\n\nYou are given a measured arterial enhancement curve modeled as a gamma-variate:\n$$\n\\Delta HU(t) \\;=\\; 120 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\!\\left(-\\frac{t - 4}{3}\\right) H(t - 4),\n$$\nwhere $t$ is time in seconds and $H(\\cdot)$ is the Heaviside step function. The calibration factor is $k = 25 \\;\\mathrm{HU}/(\\mathrm{mg/mL})$, with a standard uncertainty $u_{k} = 1 \\;\\mathrm{HU}/(\\mathrm{mg/mL})$. Assume the only source of uncertainty is $k$; neglect noise or bias in $\\Delta HU(t)$ and any other systematic effects.\n\nStarting from first principles that define HU and the linear additivity of attenuation in mixtures, derive the arterial concentration curve $c_{a}(t)$ in $\\mathrm{mg/mL}$ as a function of $t$. Then, using first-order (linear) uncertainty propagation, derive the corresponding standard uncertainty $u_{c_{a}}(t)$ in $\\mathrm{mg/mL}$ due solely to the uncertainty in $k$.\n\nExpress your final answer as closed-form functions of $t$ in $\\mathrm{mg/mL}$, using the given numerical values. If you choose to write piecewise definitions, ensure they are explicit and consistent. No rounding is required. Provide your final answer as the pair $\\big(c_{a}(t),\\,u_{c_{a}}(t)\\big)$.", "solution": "The problem is deemed valid as it is scientifically grounded in the principles of X-ray attenuation and CT imaging, is well-posed with sufficient information for a unique solution, and is expressed in objective, formal language.\nThe solution proceeds in two parts: first, deriving the arterial concentration curve $c_a(t)$, and second, deriving its standard uncertainty $u_{c_a}(t)$.\n\n**Part 1: Derivation of the Arterial Concentration Curve $c_a(t)$**\n\nThe problem starts with the premise of a linear relationship between the change in CT number, $\\Delta HU(t)$, and the iodine concentration, $c_a(t)$. We begin by justifying this relationship from first principles as requested.\n\nThe Hounsfield Unit ($HU$) for a material with a linear X-ray attenuation coefficient $\\mu$ is defined relative to the attenuation coefficient of water, $\\mu_{\\text{water}}$, at a specific X-ray energy spectrum:\n$$HU = 1000 \\times \\frac{\\mu - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$$\nLet $\\mu_{\\text{blood}}$ be the baseline attenuation coefficient of blood before the arrival of the contrast agent. The corresponding baseline CT number is:\n$$HU_{\\text{blood}} = 1000 \\times \\frac{\\mu_{\\text{blood}} - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$$\nWhen iodinated contrast is present in the blood at concentration $c_a(t)$, the attenuation coefficient of the mixture becomes $\\mu(t)$. The CT number at time $t$ is:\n$$HU(t) = 1000 \\times \\frac{\\mu(t) - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$$\nThe change in CT number, or enhancement, $\\Delta HU(t)$, is the difference between $HU(t)$ and $HU_{\\text{blood}}$:\n$$\\Delta HU(t) = HU(t) - HU_{\\text{blood}} = 1000 \\left( \\frac{\\mu(t) - \\mu_{\\text{water}}}{\\mu_{\\text{water}}} - \\frac{\\mu_{\\text{blood}} - \\mu_{\\text{water}}}{\\mu_{\\text{water}}} \\right) = 1000 \\frac{\\mu(t) - \\mu_{\\text{blood}}}{\\mu_{\\text{water}}}$$\nThe problem states that the additional linear attenuation is due to the contrast material. For the dilute solutions typical in this context, the change in the attenuation coefficient of the mixture, $\\Delta \\mu(t) = \\mu(t) - \\mu_{\\text{blood}}$, is directly proportional to the mass concentration of the added iodine, $c_a(t)$. Let this proportionality be $\\Delta \\mu(t) = \\alpha \\cdot c_a(t)$, where $\\alpha$ is a constant specific to iodine at the given CT scanner settings.\n\nSubstituting this into the expression for $\\Delta HU(t)$:\n$$\\Delta HU(t) = \\left( \\frac{1000 \\, \\alpha}{\\mu_{\\text{water}}} \\right) c_a(t)$$\nThis confirms the linear relationship. The term in the parentheses is the calibration factor $k$:\n$$k = \\frac{1000 \\, \\alpha}{\\mu_{\\text{water}}}$$\nThus, we have the model provided in the problem statement:\n$$\\Delta HU(t) = k \\cdot c_a(t)$$\nTo find the arterial concentration $c_a(t)$, we simply rearrange this equation:\n$$c_a(t) = \\frac{\\Delta HU(t)}{k}$$\nWe are given the expression for the arterial enhancement curve:\n$$\\Delta HU(t) = 120 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4)$$\nand the value of the calibration factor:\n$$k = 25 \\;\\mathrm{HU}/(\\mathrm{mg/mL})$$\nSubstituting these into the equation for $c_a(t)$:\n$$c_a(t) = \\frac{1}{25} \\left[ 120 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4) \\right]$$\nWe compute the numerical prefactor:\n$$\\frac{120}{25} = 4.8$$\nThis yields the final expression for the arterial concentration curve:\n$$c_a(t) = 4.8 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4)$$\nThe unit for $c_a(t)$ is $\\mathrm{mg/mL}$.\n\n**Part 2: Derivation of the Standard Uncertainty $u_{c_a}(t)$**\n\nThe problem asks for the standard uncertainty in $c_a(t)$ arising solely from the uncertainty in $k$, using first-order uncertainty propagation. The relationship is $c_a = \\frac{\\Delta HU}{k}$, where only $k$ is treated as a random variable. The uncertainty in $\\Delta HU(t)$ is neglected as per the problem statement.\n\nFor a function $f(x)$ of a single variable $x$ with standard uncertainty $u_x$, the standard uncertainty in $f$, denoted $u_f$, is given by:\n$$u_f = \\left| \\frac{df}{dx} \\right| u_x$$\nIn our case, $c_a$ is a function of $k$. The uncertainty $u_{c_a}(t)$ is:\n$$u_{c_a}(t) = \\left| \\frac{\\partial c_a}{\\partial k} \\right| u_k$$\nWe compute the partial derivative of $c_a(t)$ with respect to $k$:\n$$\\frac{\\partial c_a}{\\partial k} = \\frac{\\partial}{\\partial k} \\left( \\frac{\\Delta HU(t)}{k} \\right) = \\Delta HU(t) \\cdot (-1) k^{-2} = -\\frac{\\Delta HU(t)}{k^2}$$\nSubstituting this into the uncertainty formula:\n$$u_{c_a}(t) = \\left| -\\frac{\\Delta HU(t)}{k^2} \\right| u_k = \\frac{\\Delta HU(t)}{k^2} u_k$$\nTo obtain a more insightful expression, we substitute $\\Delta HU(t) = k \\cdot c_a(t)$:\n$$u_{c_a}(t) = \\frac{k \\cdot c_a(t)}{k^2} u_k = \\frac{c_a(t)}{k} u_k = c_a(t) \\left( \\frac{u_k}{k} \\right)$$\nThis shows that the standard uncertainty in concentration is directly proportional to the concentration itself, where the constant of proportionality is the relative uncertainty in the calibration factor.\n\nWe are given the values for $k$ and its standard uncertainty $u_k$:\n$$k = 25 \\;\\mathrm{HU}/(\\mathrm{mg/mL})$$\n$$u_k = 1 \\;\\mathrm{HU}/(\\mathrm{mg/mL})$$\nThe relative uncertainty in $k$ is:\n$$\\frac{u_k}{k} = \\frac{1}{25} = 0.04$$\nSo, the uncertainty in concentration is $4\\%$ of the concentration value at any time $t$:\n$$u_{c_a}(t) = 0.04 \\cdot c_a(t)$$\nSubstituting the expression we derived for $c_a(t)$:\n$$u_{c_a}(t) = 0.04 \\left[ 4.8 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4) \\right]$$\nWe compute the new numerical prefactor:\n$$0.04 \\times 4.8 = 0.192$$\nThis yields the final expression for the standard uncertainty in the arterial concentration:\n$$u_{c_a}(t) = 0.192 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4)$$\nThe unit for $u_{c_a}(t)$ is also $\\mathrm{mg/mL}$.\n\nThe final answer is the pair of functions $(c_a(t), u_{c_a}(t))$.", "answer": "$$ \\boxed{ \\begin{pmatrix} 4.8 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4) & 0.192 \\left(\\frac{t - 4}{3}\\right)^{2} \\exp\\left(-\\frac{t - 4}{3}\\right) H(t - 4) \\end{pmatrix} } $$", "id": "4873907"}, {"introduction": "In healthy brain tissue, contrast agent stays within the blood vessels. However, in pathologies like tumors or severe stroke, the blood-brain barrier can break down, allowing the agent to leak into the surrounding tissue. This exercise challenges you to derive the Patlak graphical model from first principles of mass conservation, a cornerstone technique used to quantify this leakage [@problem_id:4873858]. By applying the model to a dataset, you will see how a simple linear plot can reveal complex physiological parameters like the vascular permeability ($K^{\\text{trans}}$) and plasma volume ($v_p$).", "problem": "A dynamic contrast-enhanced computed tomography (CT) perfusion experiment is performed on a homogeneous tissue voxel. The arterial input function (AIF) is measured from a supplying artery and is assumed to represent plasma concentration after appropriate hematocrit correction. The voxel is modeled as a two-compartment system consisting of a vascular plasma space with plasma volume fraction $v_{p}$ and an extravascular–extracellular space (EES) that exchanges tracer with the plasma. Over the time window considered, assume irreversible leakage (negligible backflux from the EES to plasma) and linear time-invariant behavior.\n\nStarting from first principles appropriate to indicator-dilution theory and mass conservation, and without invoking any pre-derived kinetic plotting formulas, do the following:\n\n1) Using the convolution representation of tissue concentration and a compartmental mass-balance for the EES, derive a linear graphical relationship between a suitably transformed tissue concentration–time curve and the arterial input function that directly exposes the plasma volume fraction $v_{p}$ and the volume transfer constant $K^{\\text{trans}}$ (units $\\text{min}^{-1}$) as, respectively, the intercept and slope of a straight line. Clearly state the assumptions used at each step.\n\n2) Consider a synthetic, noise-free dynamic CT dataset with arterial input function\n$$\nc_{a}(t) \\;=\\; 5\\,\\exp(-0.2\\,t)\\quad\\text{mg}\\,\\text{mL}^{-1},\\qquad t \\ge 0\\ \\text{min},\n$$\nand measured tissue concentrations (expressed per $\\text{mL}$ of tissue) at times $t \\in \\{2,4,6\\}$ minutes:\n$$\nc_{t}(2)=1.156619874\\ \\text{mg}\\,\\text{mL}^{-1},\\quad\nc_{t}(4)=1.764345349\\ \\text{mg}\\,\\text{mL}^{-1},\\quad\nc_{t}(6)=2.171715917\\ \\text{mg}\\,\\text{mL}^{-1}.\n$$\nUsing your derivation from part $1)$, construct the appropriate transformed variables from $c_{a}(t)$ and $c_{t}(t)$ at these sampling times and estimate $K^{\\text{trans}}$ (in $\\text{min}^{-1}$) and $v_{p}$ (as a decimal fraction). Round each of your two estimates to four significant figures. Express $K^{\\text{trans}}$ in $\\text{min}^{-1}$ and $v_{p}$ as a unitless decimal fraction.", "solution": "The problem is assessed to be valid as it is scientifically grounded in the principles of tracer kinetic modeling, is well-posed with sufficient and consistent information, and is expressed objectively. I will proceed with a full solution.\n\nThe problem is divided into two parts. The first part requires the derivation of a linear graphical method for estimating the plasma volume fraction $v_{p}$ and the volume transfer constant $K^{\\text{trans}}$. The second part requires the application of this method to a synthetic dataset.\n\n### Part 1: Derivation of the Linear Graphical Relationship\n\nThe derivation begins from the principle of mass conservation for an indicator (contrast agent) in a homogeneous tissue voxel.\n\n**1. Mass Conservation and Compartmentalization**\nThe total concentration of the contrast agent within the tissue voxel, $c_t(t)$ (expressed as mass per unit volume of tissue), is the sum of its concentration in the vascular plasma space, $c_{p, \\text{tissue}}(t)$, and its concentration in the extravascular-extracellular space (EES), $c_{e, \\text{tissue}}(t)$.\n$$c_t(t) = c_{p, \\text{tissue}}(t) + c_{e, \\text{tissue}}(t)$$\nIt is crucial to note that $c_{p, \\text{tissue}}(t)$ and $c_{e, \\text{tissue}}(t)$ are concentrations averaged over the entire voxel volume, not the volumes of their respective compartments.\n\n**2. Vascular Plasma Space Contribution**\nThe contribution from the vascular plasma space is the concentration of the agent in the plasma, $c_a(t)$ (mass per unit volume of plasma, given by the Arterial Input Function), scaled by the fraction of the tissue volume occupied by plasma, $v_p$.\n$$c_{p, \\text{tissue}}(t) = v_p c_a(t)$$\nThis step assumes that the plasma concentration within the voxel's capillaries and venules is identical to the concentration measured in the large feeding artery, $c_a(t)$, at the same time $t$.\n\n**3. EES Contribution and Mass Balance**\nWe apply the principle of mass conservation to the EES compartment. The rate of change of tracer concentration in the EES (per unit tissue volume), $\\frac{d}{dt} c_{e, \\text{tissue}}(t)$, is equal to the net flux of the tracer into the EES from the plasma, also expressed per unit tissue volume.\n$$\\frac{d}{dt} c_{e, \\text{tissue}}(t) = J_{\\text{net}}(t)$$\nThe net flux is the difference between influx ($J_{\\text{in}}$) and outflux ($J_{\\text{out}}$). The influx is modeled as being proportional to the arterial plasma concentration, where the constant of proportionality is the volume transfer constant, $K^{\\text{trans}}$. This constant represents the clearance of the tracer from the plasma into the EES, per unit volume of tissue.\n$$J_{\\text{in}}(t) = K^{\\text{trans}} c_a(t)$$\nThe units of $K^{\\text{trans}}$ are $\\text{time}^{-1}$, consistent with the problem statement, arising from $(\\text{mass} \\cdot \\text{time}^{-1} \\cdot \\text{tissue volume}^{-1}) / (\\text{mass} \\cdot \\text{plasma volume}^{-1})$ and noting that volumes are measured in the same units (e.g., $\\text{mL}$).\n\nA critical assumption given in the problem is that of **irreversible leakage**. This implies that the backflux of the tracer from the EES into the plasma is negligible ($J_{\\text{out}} \\approx 0$) over the time window of the experiment. This approximation is valid under conditions of high permeability, large EES volume relative to influx rate, or during early times after tracer arrival before significant accumulation in the EES has occurred.\n\nWith this assumption, the net flux is equal to the influx:\n$$J_{\\text{net}}(t) \\approx J_{\\text{in}}(t) = K^{\\text{trans}} c_a(t)$$\nThe mass balance equation for the EES thus simplifies to a first-order ordinary differential equation:\n$$\\frac{d}{dt} c_{e, \\text{tissue}}(t) = K^{\\text{trans}} c_a(t)$$\nTo find the total concentration accumulated in the EES at time $t$, we integrate this equation from time $0$ (before tracer arrival, so $c_{e, \\text{tissue}}(0) = 0$) to $t$:\n$$c_{e, \\text{tissue}}(t) = \\int_0^t K^{\\text{trans}} c_a(\\tau) d\\tau$$\nSince $K^{\\text{trans}}$ is a constant (a consequence of the linear time-invariant assumption), it can be moved outside the integral:\n$$c_{e, \\text{tissue}}(t) = K^{\\text{trans}} \\int_0^t c_a(\\tau) d\\tau$$\n\n**4. Total Tissue Concentration and Linearization**\nSubstituting the expressions for $c_{p, \\text{tissue}}(t)$ and $c_{e, \\text{tissue}}(t)$ into the initial mass conservation equation gives the complete model for total tissue concentration:\n$$c_t(t) = v_p c_a(t) + K^{\\text{trans}} \\int_0^t c_a(\\tau) d\\tau$$\nThis is the fundamental equation for the Patlak model. To transform it into a linear graphical relationship, we algebraically rearrange it into the canonical form of a straight line, $Y = mX + b$. Assuming $c_a(t) \\neq 0$ for $t > 0$, we can divide the entire equation by $c_a(t)$:\n$$\\frac{c_t(t)}{c_a(t)} = v_p + K^{\\text{trans}} \\frac{\\int_0^t c_a(\\tau) d\\tau}{c_a(t)}$$\nBy inspection, this equation is linear. We can identify the components of the line as follows:\n-   Dependent variable (\"Y-axis\"): $Y(t) = \\frac{c_t(t)}{c_a(t)}$\n-   Independent variable (\"X-axis\"): $X(t) = \\frac{\\int_0^t c_a(\\tau) d\\tau}{c_a(t)}$\n-   Slope: $m = K^{\\text{trans}}$\n-   Y-intercept: $b = v_p$\n\nTherefore, a plot of $\\frac{c_t(t)}{c_a(t)}$ versus $\\frac{\\int_0^t c_a(\\tau) d\\tau}{c_a(t)}$ will yield a straight line. The slope of this line is a direct measure of the volume transfer constant, $K^{\\text{trans}}$, and its y-intercept provides the plasma volume fraction, $v_{p}$. This is the required graphical relationship.\n\n### Part 2: Application to Synthetic Data\n\nWe now apply the derived linear relationship to the provided dataset.\n\n**1. Define Transformed Variables**\nThe arterial input function is given as $c_a(t) = 5\\exp(-0.2t)$.\nFirst, we compute the integral of $c_a(t)$, which is required for the independent variable $X(t)$:\n$$\\int_0^t c_a(\\tau) d\\tau = \\int_0^t 5\\exp(-0.2\\tau) d\\tau = 5 \\left[ \\frac{\\exp(-0.2\\tau)}{-0.2} \\right]_0^t = -25 (\\exp(-0.2t) - \\exp(0)) = 25(1 - \\exp(-0.2t))$$\nNow we can write the explicit forms for our plotting variables $X(t)$ and $Y(t)$:\n$$X(t) = \\frac{25(1 - \\exp(-0.2t))}{5\\exp(-0.2t)} = 5 \\left(\\frac{1}{\\exp(-0.2t)} - 1\\right) = 5(\\exp(0.2t) - 1)$$\n$$Y(t) = \\frac{c_t(t)}{c_a(t)} = \\frac{c_t(t)}{5\\exp(-0.2t)}$$\n\n**2. Calculate Coordinates for Data Points**\nWe compute the $(X, Y)$ coordinates for each of the given time points: $t \\in \\{2, 4, 6\\}$.\n\n-   For $t=2$:\n    $$X(2) = 5(\\exp(0.2 \\times 2) - 1) = 5(\\exp(0.4) - 1) \\approx 5(1.4918247 - 1) = 2.4591235$$\n    $$Y(2) = \\frac{1.156619874}{5\\exp(-0.4)} \\approx \\frac{1.156619874}{5 \\times 0.6703200} = 0.3450940$$\n\n-   For $t=4$:\n    $$X(4) = 5(\\exp(0.2 \\times 4) - 1) = 5(\\exp(0.8) - 1) \\approx 5(2.2255409 - 1) = 6.1277045$$\n    $$Y(4) = \\frac{1.764345349}{5\\exp(-0.8)} \\approx \\frac{1.764345349}{5 \\times 0.4493290} = 0.7853240$$\n\n-   For $t=6$:\n    $$X(6) = 5(\\exp(0.2 \\times 6) - 1) = 5(\\exp(1.2) - 1) \\approx 5(3.3201169 - 1) = 11.6005845$$\n    $$Y(6) = \\frac{2.171715917}{5\\exp(-1.2)} \\approx \\frac{2.171715917}{5 \\times 0.3011942} = 1.4420640$$\n\n**3. Estimate Slope and Intercept**\nSince the data are noise-free, any two points will define the line. We use the points for $t=2$ and $t=6$ to maximize the baseline for a more robust estimate.\n\nThe slope, $K^{\\text{trans}}$, is calculated as:\n$$K^{\\text{trans}} = \\frac{Y(6) - Y(2)}{X(6) - X(2)} \\approx \\frac{1.4420640 - 0.3450940}{11.6005845 - 2.4591235} = \\frac{1.0969700}{9.1414610} = 0.1200000$$\n\nThe y-intercept, $v_{p}$, is calculated using the point-slope form of a line with the point $(X(2), Y(2))$:\n$$v_p = Y(2) - K^{\\text{trans}} \\cdot X(2) \\approx 0.3450940 - (0.1200000) \\cdot (2.4591235) = 0.3450940 - 0.29509482 = 0.04999918$$\nThe results strongly suggest the exact values are $K^{\\text{trans}} = 0.12$ and $v_p = 0.05$.\n\n**4. Final Answer**\nRounding these estimates to four significant figures as requested:\n-   $K^{\\text{trans}} = 0.1200$ (units $\\text{min}^{-1}$)\n-   $v_p = 0.05000$ (unitless decimal fraction)\n\nThese are the final estimated parameters.", "answer": "$$\\boxed{\\begin{pmatrix} 0.1200 & 0.05000 \\end{pmatrix}}$$", "id": "4873858"}, {"introduction": "A CT perfusion study generates several different parameter maps, such as CBF, CBV, and MTT, each offering a unique piece of the puzzle. The final diagnostic step involves synthesizing this multi-parametric information to classify tissue, for instance, as healthy, at-risk (penumbra), or irreversibly damaged (ischemic core). This advanced practice guides you to build a probabilistic classifier that formally combines these parameters—along with their measurement uncertainties—to compute a confidence map of tissue status [@problem_id:4873906]. This exercise bridges the gap between quantitative measurement and real-world clinical decision-making.", "problem": "You are given multi-parametric computed tomography perfusion imaging data for brain tissue, consisting of four features per voxel: Cerebral Blood Flow (CBF), Cerebral Blood Volume (CBV), Mean Transit Time (MTT), and Time-to-maximum of the residue function ($T_{\\max}$). The goal is to design a probabilistic classifier that integrates these features together with voxel-wise measurement uncertainty to produce a confidence value (posterior probability) that a voxel is ischemic core tissue. The classifier must be derived from first principles of probability and well-established properties of Gaussian models for physiological variability and measurement noise.\n\nAssume the following modeling assumptions:\n- The true but unobserved physiological feature vector for a voxel is denoted by $\\mathbf{x} \\in \\mathbb{R}^4$ with ordered components $(\\mathrm{CBF}, \\mathrm{CBV}, \\mathrm{MTT}, T_{\\max})$.\n- The observed feature vector is $\\mathbf{y} \\in \\mathbb{R}^4$, and the measurement noise is additive, zero-mean, and Gaussian with voxel-specific diagonal covariance $\\mathbf{D} = \\mathrm{diag}(\\sigma_{\\mathrm{CBF}}^2, \\sigma_{\\mathrm{CBV}}^2, \\sigma_{\\mathrm{MTT}}^2, \\sigma_{T_{\\max}}^2)$, where each $\\sigma$ is provided for each voxel.\n- For each tissue class $c \\in \\{\\text{normal}, \\text{penumbra}, \\text{core}\\}$, the physiological variability of $\\mathbf{x}$ is modeled as a multivariate Gaussian distribution with mean $\\boldsymbol{\\mu}_c \\in \\mathbb{R}^4$ and diagonal covariance $\\boldsymbol{\\Sigma}_c = \\mathrm{diag}(\\tau_{\\mathrm{CBF},c}^2, \\tau_{\\mathrm{CBV},c}^2, \\tau_{\\mathrm{MTT},c}^2, \\tau_{T_{\\max},c}^2)$. Class priors $\\pi_c$ are provided and satisfy $\\sum_c \\pi_c = 1$.\n\nPhysical units and input conventions:\n- $\\mathrm{CBF}$ is in $\\mathrm{mL}/(100~\\mathrm{g})/\\mathrm{min}$, $\\mathrm{CBV}$ is in $\\mathrm{mL}/(100~\\mathrm{g})$, $\\mathrm{MTT}$ is in $\\mathrm{s}$, and $T_{\\max}$ is in $\\mathrm{s}$.\n- All inputs for $\\mathbf{y}$ must be interpreted in these units. The output is a unitless probability for the ischemic core class expressed as a decimal number.\n\nFrom these assumptions and core probability definitions, construct a classifier that, for each voxel, computes the posterior probability $p(\\text{core}\\mid \\mathbf{y})$ using the joint effect of physiological variability and voxel-wise measurement noise. Use only core definitions, such as the definition of conditional probability, total probability, and Gaussian closure properties under linear operations, to derive an implementable algorithm.\n\nParameters for the classifier (shared across all voxels):\n- Class priors: $\\pi_{\\text{normal}} = 0.60$, $\\pi_{\\text{penumbra}} = 0.25$, $\\pi_{\\text{core}} = 0.15$.\n- Class-conditional Gaussian means (ordered as $(\\mathrm{CBF}, \\mathrm{CBV}, \\mathrm{MTT}, T_{\\max})$):\n  - $\\boldsymbol{\\mu}_{\\text{normal}} = (50, 4.0, 4.5, 3.5)$\n  - $\\boldsymbol{\\mu}_{\\text{penumbra}} = (22, 4.5, 8.0, 7.0)$\n  - $\\boldsymbol{\\mu}_{\\text{core}} = (10, 2.0, 12.0, 9.0)$\n- Class-conditional diagonal variances:\n  - $\\boldsymbol{\\Sigma}_{\\text{normal}} = \\mathrm{diag}(8^2, 0.6^2, 1.0^2, 1.0^2)$\n  - $\\boldsymbol{\\Sigma}_{\\text{penumbra}} = \\mathrm{diag}(6^2, 0.7^2, 1.5^2, 1.5^2)$\n  - $\\boldsymbol{\\Sigma}_{\\text{core}} = \\mathrm{diag}(5^2, 0.5^2, 2.0^2, 2.0^2)$\n\nTest suite (each case is a voxel with $(\\mathbf{y}, \\boldsymbol{\\sigma})$, where $\\boldsymbol{\\sigma}$ lists the measurement standard deviations per feature in the same order):\n- Case $1$:\n  - $\\mathbf{y} = (48, 4.1, 4.7, 3.6)$\n  - $\\boldsymbol{\\sigma} = (5, 0.5, 0.8, 0.7)$\n- Case $2$:\n  - $\\mathbf{y} = (20, 4.7, 9.2, 8.0)$\n  - $\\boldsymbol{\\sigma} = (6, 0.6, 1.0, 1.2)$\n- Case $3$:\n  - $\\mathbf{y} = (12, 1.8, 13.5, 10.5)$\n  - $\\boldsymbol{\\sigma} = (4, 0.4, 1.5, 1.5)$\n- Case $4$ (high measurement uncertainty):\n  - $\\mathbf{y} = (18, 3.0, 10.0, 8.5)$\n  - $\\boldsymbol{\\sigma} = (20, 2.0, 5.0, 5.0)$\n- Case $5$ (feature conflict: low $\\mathrm{CBF}$ with elevated $\\mathrm{CBV}$):\n  - $\\mathbf{y} = (12, 5.5, 8.5, 7.5)$\n  - $\\boldsymbol{\\sigma} = (3, 0.5, 1.0, 1.0)$\n- Case $6$ (zero measurement uncertainty at a penumbra-like point):\n  - $\\mathbf{y} = (22, 4.5, 8.0, 7.0)$\n  - $\\boldsymbol{\\sigma} = (0, 0, 0, 0)$\n\nProgramming task:\n- Implement the derived classifier to compute $p(\\text{core}\\mid \\mathbf{y})$ for each of the above cases.\n- Use the provided priors, means, and class-conditional diagonal variances, together with each case’s measurement standard deviations $\\boldsymbol{\\sigma}$, to incorporate uncertainty correctly at prediction time.\n- Report the ischemic core posterior probability for each case, rounded to $6$ decimal places.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\text{result}_1,\\text{result}_2,\\dots]$).\n- The list must contain the $6$ rounded posterior probabilities for the cases in the order given above.", "solution": "The problem requires the design of a probabilistic classifier to determine the posterior probability that a voxel belongs to the ischemic core class, denoted $c = \\text{core}$, given an observed feature vector $\\mathbf{y} \\in \\mathbb{R}^4$. The classifier must be derived from first principles, integrating physiological variability and voxel-wise measurement uncertainty.\n\nThe target quantity is the posterior probability $p(c=\\text{core} \\mid \\mathbf{y})$. According to Bayes' theorem, the posterior probability for any class $c$ is given by:\n$$p(c \\mid \\mathbf{y}) = \\frac{p(\\mathbf{y} \\mid c) \\pi_c}{p(\\mathbf{y})}$$\nwhere $\\pi_c$ is the prior probability of class $c$, $p(\\mathbf{y} \\mid c)$ is the class-conditional likelihood of observing $\\mathbf{y}$ given the tissue is of class $c$, and $p(\\mathbf{y})$ is the marginal likelihood or evidence. The evidence term serves as a normalization constant and is calculated using the law of total probability by summing over all possible classes $c' \\in \\{\\text{normal, penumbra, core}\\}$:\n$$p(\\mathbf{y}) = \\sum_{c'} p(\\mathbf{y} \\mid c') \\pi_{c'}$$\nThe core of the derivation is to determine the analytical form of the class-conditional likelihood, $p(\\mathbf{y} \\mid c)$.\n\nThe problem provides a two-stage generative model for the observed data $\\mathbf{y}$:\n1.  **Physiological Variability**: The true but unobserved physiological feature vector, $\\mathbf{x} \\in \\mathbb{R}^4$, for a given tissue class $c$, is a random variable drawn from a multivariate Gaussian distribution:\n    $$p(\\mathbf{x} \\mid c) = \\mathcal{N}(\\mathbf{x}; \\boldsymbol{\\mu}_c, \\boldsymbol{\\Sigma}_c)$$\n    Here, $\\boldsymbol{\\mu}_c$ is the mean feature vector for class $c$, and $\\boldsymbol{\\Sigma}_c$ is the diagonal covariance matrix representing physiological variability within the class.\n\n2.  **Measurement Noise**: The observed feature vector $\\mathbf{y}$ is related to the true vector $\\mathbf{x}$ through an additive, zero-mean Gaussian noise model:\n    $$\\mathbf{y} = \\mathbf{x} + \\boldsymbol{\\epsilon}, \\quad \\text{where} \\quad \\boldsymbol{\\epsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{D})$$\n    This implies that the distribution of $\\mathbf{y}$ conditioned on a specific true value $\\mathbf{x}$ is:\n    $$p(\\mathbf{y} \\mid \\mathbf{x}) = \\mathcal{N}(\\mathbf{y}; \\mathbf{x}, \\mathbf{D})$$\n    where $\\mathbf{D}$ is the diagonal covariance matrix of the measurement noise, specific to each voxel.\n\nTo find the likelihood $p(\\mathbf{y} \\mid c)$, we must marginalize out the unknown true feature vector $\\mathbf{x}$:\n$$p(\\mathbf{y} \\mid c) = \\int p(\\mathbf{y}, \\mathbf{x} \\mid c) \\, d\\mathbf{x}$$\nUsing the chain rule of probability, $p(\\mathbf{y}, \\mathbf{x} \\mid c) = p(\\mathbf{y} \\mid \\mathbf{x}, c) p(\\mathbf{x} \\mid c)$. The measurement process is independent of the tissue class once the true features $\\mathbf{x}$ are known, so $p(\\mathbf{y} \\mid \\mathbf{x}, c) = p(\\mathbf{y} \\mid \\mathbf{x})$. This simplifies the integral to:\n$$p(\\mathbf{y} \\mid c) = \\int p(\\mathbf{y} \\mid \\mathbf{x}) p(\\mathbf{x} \\mid c) \\, d\\mathbf{x}$$\nThis integral represents the convolution of two Gaussian distributions. A fundamental property of Gaussian distributions is that their convolution results in another Gaussian distribution.\n\nAlternatively, we can reason about the sum of independent random variables. Conditional on class $c$, the observed vector $\\mathbf{y}$ is the sum of two independent random vectors: the true physiological state $\\mathbf{x} \\sim \\mathcal{N}(\\boldsymbol{\\mu}_c, \\boldsymbol{\\Sigma}_c)$ and the measurement noise $\\boldsymbol{\\epsilon} \\sim \\mathcal{N}(\\mathbf{0}, \\mathbf{D})$. The mean of the sum is the sum of the means, and the covariance of the sum is the sum of the covariances:\n$$E[\\mathbf{y} \\mid c] = E[\\mathbf{x} \\mid c] + E[\\boldsymbol{\\epsilon}] = \\boldsymbol{\\mu}_c + \\mathbf{0} = \\boldsymbol{\\mu}_c$$\n$$\\text{Cov}(\\mathbf{y} \\mid c) = \\text{Cov}(\\mathbf{x} \\mid c) + \\text{Cov}(\\boldsymbol{\\epsilon}) = \\boldsymbol{\\Sigma}_c + \\mathbf{D}$$\nThus, the class-conditional likelihood $p(\\mathbf{y} \\mid c)$ is a multivariate Gaussian distribution with mean $\\boldsymbol{\\mu}_c$ and a combined covariance matrix $\\boldsymbol{\\Lambda}_c = \\boldsymbol{\\Sigma}_c + \\mathbf{D}$:\n$$p(\\mathbf{y} \\mid c) = \\mathcal{N}(\\mathbf{y}; \\boldsymbol{\\mu}_c, \\boldsymbol{\\Sigma}_c + \\mathbf{D})$$\nThis is a critical result: the total effective variance for a class is the sum of the intrinsic physiological variance and the measurement variance.\n\nGiven that both $\\boldsymbol{\\Sigma}_c = \\mathrm{diag}(\\tau_{1,c}^2, \\tau_{2,c}^2, \\tau_{3,c}^2, \\tau_{4,c}^2)$ and $\\mathbf{D} = \\mathrm{diag}(\\sigma_1^2, \\sigma_2^2, \\sigma_3^2, \\sigma_4^2)$ are diagonal, their sum $\\boldsymbol{\\Lambda}_c$ is also diagonal. The probability density function of a $d$-dimensional multivariate Gaussian with a diagonal covariance matrix $\\boldsymbol{\\Lambda}_c = \\mathrm{diag}(\\lambda_{1,c}^2, \\dots, \\lambda_{d,c}^2)$ simplifies to a product of $d$ univariate Gaussian densities:\n$$p(\\mathbf{y} \\mid c) = \\prod_{i=1}^d \\frac{1}{\\sqrt{2\\pi \\lambda_{i,c}^2}} \\exp\\left(-\\frac{(y_i - \\mu_{i,c})^2}{2\\lambda_{i,c}^2}\\right)$$\nwhere $\\lambda_{i,c}^2 = \\tau_{i,c}^2 + \\sigma_i^2$, $d=4$, $y_i$ is the $i$-th component of $\\mathbf{y}$, and $\\mu_{i,c}$ is the $i$-th component of $\\boldsymbol{\\mu}_c$.\n\nFor numerical stability, computations are best performed in the logarithmic domain. The log-likelihood is:\n$$\\ln p(\\mathbf{y} \\mid c) = \\sum_{i=1}^d \\left( -\\frac{1}{2} \\ln(2\\pi) - \\frac{1}{2}\\ln(\\lambda_{i,c}^2) - \\frac{(y_i-\\mu_{i,c})^2}{2\\lambda_{i,c}^2} \\right)$$\nThe term $-\\frac{d}{2}\\ln(2\\pi)$ is a constant across all classes and will cancel out during the normalization of posterior probabilities. Thus, we can work with a \"proportional\" log-likelihood, denoted $\\ln \\tilde{L}_c$:\n$$\\ln \\tilde{L}_c = -\\frac{1}{2} \\sum_{i=1}^d \\left( \\ln(\\tau_{i,c}^2 + \\sigma_i^2) + \\frac{(y_i-\\mu_{i,c})^2}{\\tau_{i,c}^2 + \\sigma_i^2} \\right)$$\nThe logarithm of the unnormalized posterior for class $c$, $\\ln J_c$, is then:\n$$\\ln J_c = \\ln \\pi_c + \\ln \\tilde{L}_c$$\nThe posterior probability for the ischemic core class is then found by converting back to linear scale and normalizing:\n$$p(c=\\text{core} \\mid \\mathbf{y}) = \\frac{\\exp(\\ln J_{\\text{core}})}{\\sum_{c' \\in \\{\\text{normal, penumbra, core}\\}} \\exp(\\ln J_{c'})}$$\nTo prevent numerical overflow or underflow when exponentiating, the log-sum-exp trick is employed. Let $\\ell_{\\max} = \\max_{c'}(\\ln J_{c'})$. The posterior is calculated as:\n$$p(c=\\text{core} \\mid \\mathbf{y}) = \\frac{\\exp(\\ln J_{\\text{core}} - \\ell_{\\max})}{\\sum_{c'} \\exp(\\ln J_{c'} - \\ell_{\\max})}$$\nThis formulation provides a robust and numerically stable algorithm to compute the desired posterior probabilities for each voxel based on its measured features $\\mathbf{y}$ and measurement uncertainties $\\boldsymbol{\\sigma}$. The algorithm correctly combines prior knowledge, physiological models, and measurement noise into a single principled prediction.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements a probabilistic classifier for CT perfusion data.\n\n    The classifier calculates the posterior probability that a voxel is ischemic core tissue,\n    p(core|y), based on observed features y and their measurement uncertainty.\n    The derivation follows Bayesian principles, modeling physiological variability\n    and measurement noise as Gaussian distributions. The resulting class-conditional\n    likelihood p(y|c) becomes a Gaussian with mean equal to the class mean and covariance\n    equal to the sum of the physiological and measurement covariances.\n    \"\"\"\n\n    # Classifier parameters (shared across all voxels)\n    # Class priors: normal, penumbra, core\n    priors = np.array([0.60, 0.25, 0.15])\n    \n    # Class-conditional means (CBF, CBV, MTT, Tmax)\n    mus = {\n        'normal': np.array([50.0, 4.0, 4.5, 3.5]),\n        'penumbra': np.array([22.0, 4.5, 8.0, 7.0]),\n        'core': np.array([10.0, 2.0, 12.0, 9.0])\n    }\n    \n    # Class-conditional physiological standard deviations (tau)\n    taus = {\n        'normal': np.array([8.0, 0.6, 1.0, 1.0]),\n        'penumbra': np.array([6.0, 0.7, 1.5, 1.5]),\n        'core': np.array([5.0, 0.5, 2.0, 2.0])\n    }\n\n    # Class-conditional physiological variances (tau^2)\n    sigmas_sq_phys = {\n        'normal': taus['normal']**2,\n        'penumbra': taus['penumbra']**2,\n        'core': taus['core']**2\n    }\n    \n    class_order = ['normal', 'penumbra', 'core']\n\n    # Test suite: (y, sigma) for each voxel\n    test_cases = [\n        # Case 1\n        (np.array([48.0, 4.1, 4.7, 3.6]), np.array([5.0, 0.5, 0.8, 0.7])),\n        # Case 2\n        (np.array([20.0, 4.7, 9.2, 8.0]), np.array([6.0, 0.6, 1.0, 1.2])),\n        # Case 3\n        (np.array([12.0, 1.8, 13.5, 10.5]), np.array([4.0, 0.4, 1.5, 1.5])),\n        # Case 4 (high measurement uncertainty)\n        (np.array([18.0, 3.0, 10.0, 8.5]), np.array([20.0, 2.0, 5.0, 5.0])),\n        # Case 5 (feature conflict)\n        (np.array([12.0, 5.5, 8.5, 7.5]), np.array([3.0, 0.5, 1.0, 1.0])),\n        # Case 6 (zero measurement uncertainty)\n        (np.array([22.0, 4.5, 8.0, 7.0]), np.array([0.0, 0.0, 0.0, 0.0]))\n    ]\n    \n    results = []\n\n    for y_obs, sigma_obs in test_cases:\n        log_J = [] # Stores log of unnormalized posterior for each class\n        d = len(y_obs) # Dimensionality of the feature space\n\n        # Measurement noise variance\n        D_diag = sigma_obs**2\n        \n        for i, class_name in enumerate(class_order):\n            pi_c = priors[i]\n            mu_c = mus[class_name]\n            Sigma_c_diag = sigmas_sq_phys[class_name]\n            \n            # Effective variance is sum of physiological and measurement variances\n            Lambda_c_diag = Sigma_c_diag + D_diag\n\n            # Check for zero variance, which would imply infinite density.\n            # In this problem, physiological variances are non-zero, so this\n            # only occurs if sigma_obs and tau are both zero, which is not the case.\n            if np.any(Lambda_c_diag = 0):\n                # This case is physically/mathematically ill-defined\n                # Assign a very large negative log probability\n                log_L_tilde = -np.inf\n            else:\n                # Log-determinant of diagonal covariance matrix\n                log_det_term = np.sum(np.log(Lambda_c_diag))\n                \n                # Squared Mahalanobis distance for diagonal covariance\n                mahalanobis_sq = np.sum(((y_obs - mu_c)**2) / Lambda_c_diag)\n                \n                # Proportional log-likelihood (omitting constant factor -d/2*log(2pi))\n                log_L_tilde = -0.5 * (log_det_term + mahalanobis_sq)\n\n            # Log of unnormalized posterior: log(pi_c * L_tilde_c)\n            log_J_c = np.log(pi_c) + log_L_tilde\n            log_J.append(log_J_c)\n\n        # Use log-sum-exp trick for numerical stability\n        log_J = np.array(log_J)\n        l_max = np.max(log_J)\n        \n        # Exponentiate and normalize\n        J_norm = np.exp(log_J - l_max)\n        evidence = np.sum(J_norm)\n        \n        posteriors = J_norm / evidence\n        \n        # Get the posterior for the 'core' class (index 2)\n        posterior_core = posteriors[2]\n        \n        results.append(round(posterior_core, 6))\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4873906"}]}