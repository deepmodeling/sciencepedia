{"hands_on_practices": [{"introduction": "The core principle of Time-of-Flight (TOF) PET is elegantly simple, rooted in the basic physics of distance, speed, and time. Before we can appreciate its impact on image quality, we must first master the fundamental relationship between an annihilation event's position and the resulting time difference measured by the detectors. This exercise ([@problem_id:4937384]) will guide you through a first-principles calculation to solidify your understanding of how TOF information originates from the kinematics of the two oppositely-directed $\\gamma$ photons.", "problem": "A positron annihilation event occurs along a straight line-of-response (LOR) connecting two opposing detectors, labeled A and B. The distance between the two detector entrance planes along the LOR is $L = 0.80\\,\\mathrm{m}$. Define a one-dimensional coordinate $s$ along the LOR with the midpoint at $s=0$, positive $s$ pointing toward detector A. The annihilation occurs at position $s = x$ with $x = +0.050\\,\\mathrm{m}$, so that it is offset toward detector A.\n\nAssume the following fundamental facts:\n- The annihilation produces two $\\gamma$ photons that are emitted simultaneously and travel in opposite directions along the LOR.\n- Each photon propagates at the speed of light $c = 2.99792458 \\times 10^{8}\\,\\mathrm{m/s}$.\n- The emission time is $t_{e} = 0$.\n\nUsing only these foundations, compute:\n- The expected arrival time at detector A, $t_{A}$.\n- The expected arrival time at detector B, $t_{B}$.\n- The resulting measured time difference $\\Delta t \\equiv t_{B} - t_{A}$.\n\nExpress all final times in nanoseconds and round your results to four significant figures. Your final answer must be a single row vector $\\big(t_{A},\\,t_{B},\\,\\Delta t\\big)$ in that order.", "solution": "The problem is valid as it is scientifically grounded in the principles of positron-electron annihilation, is well-posed with all necessary information provided, and is stated objectively. We can therefore proceed with the solution.\n\nThe problem defines a one-dimensional coordinate system $s$ along the line-of-response (LOR) between two detectors, A and B. The total distance between the detectors is $L = 0.80\\,\\mathrm{m}$. The origin $s=0$ is at the midpoint of the LOR. Detector A is in the positive direction and detector B is in the negative direction. The positions of the detector planes are therefore:\n- Detector A: $s_A = +\\frac{L}{2}$\n- Detector B: $s_B = -\\frac{L}{2}$\n\nSubstituting the value of $L$:\n- $s_A = +\\frac{0.80\\,\\mathrm{m}}{2} = +0.40\\,\\mathrm{m}$\n- $s_B = -\\frac{0.80\\,\\mathrm{m}}{2} = -0.40\\,\\mathrm{m}$\n\nThe positron annihilation event occurs at position $x = +0.050\\,\\mathrm{m}$. Two $\\gamma$ photons are emitted simultaneously at time $t_e = 0$ and travel in opposite directions along the LOR at the speed of light, $c = 2.99792458 \\times 10^{8}\\,\\mathrm{m/s}$.\n\nFirst, we calculate the distance each photon travels to reach its respective detector.\nThe photon traveling towards detector A moves from the annihilation position $x$ to the detector position $s_A$. The distance, $d_A$, is the absolute difference between these positions:\n$$d_A = |s_A - x| = |\\frac{L}{2} - x|$$\nSince $x < \\frac{L}{2}$ ($0.050 < 0.40$), the absolute value is not necessary, and we have:\n$$d_A = \\frac{L}{2} - x$$\nSubstituting the given values:\n$$d_A = 0.40\\,\\mathrm{m} - 0.050\\,\\mathrm{m} = 0.35\\,\\mathrm{m}$$\n\nThe other photon travels towards detector B, from position $x$ to position $s_B$. The distance, $d_B$, is:\n$$d_B = |s_B - x| = |-\\frac{L}{2} - x| = |- ( \\frac{L}{2} + x )| = \\frac{L}{2} + x$$\nSubstituting the given values:\n$$d_B = \\frac{0.80\\,\\mathrm{m}}{2} + 0.050\\,\\mathrm{m} = 0.40\\,\\mathrm{m} + 0.050\\,\\mathrm{m} = 0.45\\,\\mathrm{m}$$\nAs a consistency check, the sum of the distances should be the total length of the LOR: $d_A + d_B = 0.35\\,\\mathrm{m} + 0.45\\,\\mathrm{m} = 0.80\\,\\mathrm{m} = L$. This is correct.\n\nNext, we calculate the arrival times at each detector. Since the photons travel at a constant speed $c$ and the emission time is $t_e=0$, the arrival time is simply the distance divided by the speed.\n\nThe arrival time at detector A, $t_A$, is:\n$$t_A = \\frac{d_A}{c} = \\frac{\\frac{L}{2} - x}{c}$$\nSubstituting the numerical values:\n$$t_A = \\frac{0.35\\,\\mathrm{m}}{2.99792458 \\times 10^{8}\\,\\mathrm{m/s}} \\approx 1.167471 \\times 10^{-9}\\,\\mathrm{s}$$\n\nThe arrival time at detector B, $t_B$, is:\n$$t_B = \\frac{d_B}{c} = \\frac{\\frac{L}{2} + x}{c}$$\nSubstituting the numerical values:\n$$t_B = \\frac{0.45\\,\\mathrm{m}}{2.99792458 \\times 10^{8}\\,\\mathrm{m/s}} \\approx 1.501034 \\times 10^{-9}\\,\\mathrm{s}$$\n\nFinally, we compute the measured time difference, $\\Delta t$, defined as $t_B - t_A$:\n$$\\Delta t = t_B - t_A = \\frac{d_B}{c} - \\frac{d_A}{c} = \\frac{d_B - d_A}{c}$$\nSubstituting the symbolic expressions for the distances:\n$$\\Delta t = \\frac{(\\frac{L}{2} + x) - (\\frac{L}{2} - x)}{c} = \\frac{2x}{c}$$\nThis is a key result in time-of-flight PET, relating the time difference directly to the event's position offset from the center.\nUsing the numerical values:\n$$\\Delta t = \\frac{2 \\times 0.050\\,\\mathrm{m}}{2.99792458 \\times 10^{8}\\,\\mathrm{m/s}} = \\frac{0.10\\,\\mathrm{m}}{2.99792458 \\times 10^{8}\\,\\mathrm{m/s}} \\approx 3.33564 \\times 10^{-10}\\,\\mathrm{s}$$\n\nThe problem requires the final times to be expressed in nanoseconds ($1\\,\\mathrm{ns} = 10^{-9}\\,\\mathrm{s}$) and rounded to four significant figures.\n\nConverting our results:\n$t_A \\approx 1.167471 \\times 10^{-9}\\,\\mathrm{s} = 1.167471\\,\\mathrm{ns}$\nRounding to four significant figures, $t_A \\approx 1.167\\,\\mathrm{ns}$.\n\n$t_B \\approx 1.501034 \\times 10^{-9}\\,\\mathrm{s} = 1.501034\\,\\mathrm{ns}$\nRounding to four significant figures, $t_B \\approx 1.501\\,\\mathrm{ns}$.\n\n$\\Delta t \\approx 3.33564 \\times 10^{-10}\\,\\mathrm{s} = 0.333564 \\times 10^{-9}\\,\\mathrm{s} = 0.333564\\,\\mathrm{ns}$\nRounding to four significant figures, $\\Delta t \\approx 0.3336\\,\\mathrm{ns}$.\n\nThe final answer is the row vector $(t_A, t_B, \\Delta t)$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1.167 & 1.501 & 0.3336\n\\end{pmatrix}\n}\n$$", "id": "4937384"}, {"introduction": "Now that we understand how timing differences relate to event position, the next critical question is: why is this localization useful? The primary benefit of TOF PET is a significant improvement in image quality, specifically the signal-to-noise ratio (SNR). This practice ([@problem_id:4937368]) explores this crucial link by asking you to derive the famous \"TOF gain\" formula, which quantifies how much the SNR improves as a function of the object size and the system's timing precision.", "problem": "A positron emission tomography (PET) system with time-of-flight (TOF) capability measures the arrival time difference of the two coincident gamma photons to localize the annihilation point along the line of response (LOR). Consider a centrally traversing LOR through a uniform object whose extent along the LOR is approximately the object diameter $D$. In non-time-of-flight (non-TOF) PET, each detected event is equally plausible anywhere along this extent. In TOF-PET, the coincidence timing resolution (CTR) limits the longitudinal uncertainty to an effective spatial width $\\Delta x$, related to the timing resolution by $\\Delta x = c \\Delta t / 2$, where $c$ is the speed of light and $\\Delta t$ is the CTR expressed in seconds. Assume Poisson counting statistics, uncorrelated contributions, and that reconstruction weights distribute uniformly over their support along the LOR. Under these assumptions:\n\n- Derive, from first principles, an expression for the expected signal-to-noise ratio (SNR) gain factor $G$ defined as the ratio of the TOF SNR to the non-TOF SNR, expressed only in terms of $D$ and $\\Delta x$.\n\n- Then evaluate $G$ numerically for $D = 30\\,\\text{cm}$ and $CTR = 300\\,\\text{ps}$ using $\\Delta x = c \\Delta t / 2$ with $c = 2.99792458 \\times 10^{8}\\,\\text{m/s}$.\n\nRound your final numerical answer to three significant figures. Express the final value as a dimensionless number.", "solution": "The problem requires the derivation of the signal-to-noise ratio (SNR) gain factor for time-of-flight (TOF) positron emission tomography (PET) compared to non-TOF PET, based on first principles and a set of simplifying assumptions. Subsequently, this gain factor is to be evaluated numerically.\n\n### Step 1: Problem Validation\n\nThe problem statement has been validated and is deemed valid. It is scientifically grounded in the principles of PET imaging, well-posed with sufficient and consistent information, and objectively stated. The assumptions provided—Poisson statistics, uniform object, and uniform distribution of reconstruction weights over their support—are standard simplifications used for deriving the foundational TOF gain relationship. All necessary parameters for both the analytical derivation and numerical calculation are provided. Therefore, I will proceed with the solution.\n\n### Step 2: Derivation of the SNR Gain Factor $G$\n\nThe signal-to-noise ratio (SNR) is generically defined as the ratio of the magnitude of the signal to the standard deviation of the signal (the noise).\n$$\n\\text{SNR} = \\frac{\\text{Signal}}{\\text{Noise}} = \\frac{S}{\\sigma}\n$$\nwhere $\\sigma$ is the standard deviation, and the variance is $\\sigma^2$.\n\nThe problem states that we should assume Poisson counting statistics. For a process that yields $N$ total counts, the variance is equal to the mean, so $\\text{Var}(N) = N$. The noise is $\\sigma = \\sqrt{N}$.\n\nThe core of the problem lies in understanding how the noise variance in the reconstructed image is affected by the backprojection process in non-TOF and TOF PET. The problem directs us to assume that reconstruction weights are distributed uniformly over their support. This implies a simplified backprojection model.\n\nLet us consider a single Line of Response (LOR) of length $D$ passing through a uniform object. Let the total number of annihilation events detected along this LOR be $N$.\n\n**Non-TOF PET:**\nIn non-TOF PET, the time difference between the arrival of the two gamma photons is not measured with sufficient precision to localize the event along the LOR. Therefore, any detected event is considered to have originated with equal probability from any point along the segment of the LOR that traverses the object, which has extent $D$.\n\nDuring reconstruction (in a simplified backprojection model), each of the $N$ detected events is distributed over the entire length $D$. The variance at any given point in the reconstructed image along this LOR is proportional to the total number of counts that are backprojected through it. Since all $N$ events are spread across the entire length $D$, all $N$ events contribute to the noise variance at every point along the LOR. Let $k$ be the constant of proportionality. The variance in the non-TOF reconstructed image is thus:\n$$\n\\sigma_{\\text{non-TOF}}^2 \\propto N \\implies \\sigma_{\\text{non-TOF}}^2 = k N\n$$\n\n**TOF-PET:**\nIn TOF-PET, the arrival time difference $\\delta t$ localizes the annihilation event to a position along the LOR. The coincidence timing resolution (CTR), $\\Delta t$, results in a positional uncertainty of effective spatial width $\\Delta x = \\frac{c \\Delta t}{2}$.\n\nAccording to the problem's assumption, the reconstruction weight for a single event is distributed uniformly over this support length $\\Delta x$. To calculate the variance at a specific point on the LOR, we now only need to consider the events whose localization segment $\\Delta x$ contains this point.\n\nGiven that the object is uniform, the $N$ events are generated uniformly along the length $D$. The probability that a randomly chosen point on the LOR is covered by the localization segment $\\Delta x$ of a random event is the ratio of the lengths, $\\frac{\\Delta x}{D}$. Therefore, the average number of events contributing to the noise at any given point is the total number of events $N$ multiplied by this probability. This is the effective number of noise-contributing counts, $N_{\\text{eff}}$.\n$$\nN_{\\text{eff}} = N \\left(\\frac{\\Delta x}{D}\\right)\n$$\nThe variance in the TOF case is proportional to this effective number of counts, using the same constant of proportionality $k$:\n$$\n\\sigma_{\\text{TOF}}^2 \\propto N_{\\text{eff}} \\implies \\sigma_{\\text{TOF}}^2 = k N \\left(\\frac{\\Delta x}{D}\\right)\n$$\n\n**SNR Gain Factor (G):**\nThe SNR gain factor $G$ is defined as the ratio of the TOF SNR to the non-TOF SNR.\n$$\nG = \\frac{\\text{SNR}_{\\text{TOF}}}{\\text{SNR}_{\\text{non-TOF}}}\n$$\nThe signal $S$ is related to the true tracer concentration, which is the quantity we aim to measure. In this comparative analysis, we assume that both reconstruction methods provide an unbiased estimate of the signal, so $S_{\\text{TOF}} = S_{\\text{non-TOF}} = S$.\n$$\nG = \\frac{S / \\sigma_{\\text{TOF}}}{S / \\sigma_{\\text{non-TOF}}} = \\frac{\\sigma_{\\text{non-TOF}}}{\\sigma_{\\text{TOF}}} = \\sqrt{\\frac{\\sigma_{\\text{non-TOF}}^2}{\\sigma_{\\text{TOF}}^2}}\n$$\nSubstituting the expressions for the variances:\n$$\nG = \\sqrt{\\frac{k N}{k N \\left(\\frac{\\Delta x}{D}\\right)}} = \\sqrt{\\frac{1}{\\frac{\\Delta x}{D}}}\n$$\nThis simplifies to the expression for the SNR gain factor in terms of $D$ and $\\Delta x$:\n$$\nG = \\sqrt{\\frac{D}{\\Delta x}}\n$$\n\n### Step 3: Numerical Evaluation of $G$\n\nWe are given the following values:\nObject diameter, $D = 30\\,\\text{cm} = 0.30\\,\\text{m}$.\nCoincidence timing resolution, $\\Delta t = 300\\,\\text{ps} = 300 \\times 10^{-12}\\,\\text{s}$.\nSpeed of light, $c = 2.99792458 \\times 10^{8}\\,\\text{m/s}$.\n\nFirst, we calculate the longitudinal uncertainty $\\Delta x$ using the provided formula:\n$$\n\\Delta x = \\frac{c \\Delta t}{2}\n$$\nSubstituting the numerical values:\n$$\n\\Delta x = \\frac{(2.99792458 \\times 10^{8}\\,\\text{m/s}) \\times (300 \\times 10^{-12}\\,\\text{s})}{2}\n$$\n$$\n\\Delta x = \\frac{8.99377374 \\times 10^{-2}\\,\\text{m}}{2}\n$$\n$$\n\\Delta x = 0.0449688687\\,\\text{m}\n$$\n\nNext, we calculate the gain factor $G$ using the derived expression:\n$$\nG = \\sqrt{\\frac{D}{\\Delta x}}\n$$\nSubstituting the values for $D$ and $\\Delta x$:\n$$\nG = \\sqrt{\\frac{0.30\\,\\text{m}}{0.0449688687\\,\\text{m}}}\n$$\n$$\nG = \\sqrt{6.67128170...}\n$$\n$$\nG = 2.58288243...\n$$\nThe problem requires rounding the final numerical answer to three significant figures.\n$$\nG \\approx 2.58\n$$\nThe gain factor $G$ is a dimensionless quantity, as required.", "answer": "$$\\boxed{2.58}$$", "id": "4937368"}, {"introduction": "Having established the physical principle of TOF and its benefit to SNR, we now turn to its practical implementation within the image reconstruction process. This final exercise ([@problem_id:4937399]) provides a hands-on look at how the TOF timing information is incorporated into the powerful Expectation-Maximization (EM) algorithm. By working through a numerical update for a single image voxel, you will see exactly how the measured TOF data actively guides the algorithm toward a more accurate image.", "problem": "Consider a simplified model of Time-of-Flight Positron Emission Tomography (TOF-PET), in which coincidence events are binned by time-of-flight index along each line of response. There are two lines of response (LORs) indexed by $i \\in \\{1,2\\}$, three time-of-flight (TOF) bins indexed by $m \\in \\{1,2,3\\}$, and three voxels indexed by $j \\in \\{1,2,3\\}$. The measured coincidence counts in each LOR and TOF bin are $y_{im}$, and the background counts (randoms and scatter) are $s_{im}$. The forward model uses system matrix elements $p_{ijm}$ (counts per kilobecquerel) that map voxel activity $x_j$ (in kilobecquerels) to expected counts in each LOR-bin. The current activity estimate is $x_j^{(k)}$.\n\nYou will compute a single-voxel Expectation-Maximization update for voxel $j=2$ that explicitly accounts for TOF binning. Your derivation must begin from the Poisson data model for TOF-binned PET and the Expectation-Maximization (EM) conservation-of-counts principle, treating $s_{im}$ as known additive background, without invoking any shortcut formulas. Use the following data:\n\n- Measured counts for $i=1$: $(y_{1,1}, y_{1,2}, y_{1,3}) = (100, 250, 120)$; for $i=2$: $(y_{2,1}, y_{2,2}, y_{2,3}) = (80, 200, 90)$.\n- Background counts for $i=1$: $(s_{1,1}, s_{1,2}, s_{1,3}) = (5, 10, 5)$; for $i=2$: $(s_{2,1}, s_{2,2}, s_{2,3}) = (4, 8, 4)$.\n- System matrix elements (counts per kilobecquerel):\n  - For $i=1$: voxel $j=1$: $(p_{1,1,1}, p_{1,1,2}, p_{1,1,3}) = (4, 2, 1)$; voxel $j=2$: $(p_{1,2,1}, p_{1,2,2}, p_{1,2,3}) = (5, 15, 6)$; voxel $j=3$: $(p_{1,3,1}, p_{1,3,2}, p_{1,3,3}) = (2, 2, 4)$.\n  - For $i=2$: voxel $j=1$: $(p_{2,1,1}, p_{2,1,2}, p_{2,1,3}) = (3, 1, 0.5)$; voxel $j=2$: $(p_{2,2,1}, p_{2,2,2}, p_{2,2,3}) = (4, 12, 7)$; voxel $j=3$: $(p_{2,3,1}, p_{2,3,2}, p_{2,3,3}) = (1, 2, 3)$.\n- Current activity estimate (kilobecquerels): $(x_1^{(k)}, x_2^{(k)}, x_3^{(k)}) = (6, 10, 4)$.\n\nStart from the Poisson model assumptions and the EM framework to obtain the single-voxel update for $x_2$, then evaluate it numerically for the given data. Express the final updated activity $x_2^{(k+1)}$ in kilobecquerels (kBq). Round your answer to four significant figures.", "solution": "The problem requires the calculation of a single voxel update using the Expectation-Maximization (EM) algorithm for Time-of-Flight (TOF) PET data. The problem is scientifically sound, well-posed, and provides all necessary data for the computation. We will first derive the general TOF-EM update equation from the underlying Poisson statistical model and then apply it to the given numerical data for voxel $j=2$.\n\n**1. Derivation of the TOF-EM Update Equation**\n\nThe measured counts $y_{im}$ in each LOR-bin $(i,m)$ are modeled as independent Poisson random variables with a mean $\\bar{y}_{im}$ given by the sum of expected true counts and background counts:\n$$ \\bar{y}_{im} = \\sum_{j'} p_{ij'm} x_{j'} + s_{im} $$\nThe Expectation-Maximization (EM) algorithm finds the maximum likelihood estimate of the activity image $x$ iteratively. The update equation for a voxel $j$ from iteration $k$ to $k+1$ is derived from the principle of conserving counts and can be expressed in its multiplicative form:\n$$ x_j^{(k+1)} = x_j^{(k)} \\frac{1}{\\sum_{i,m} p_{ijm}} \\sum_{i,m} \\left( p_{ijm} \\frac{y_{im}}{\\sum_{j'} p_{ij'm} x_{j'}^{(k)} + s_{im}} \\right) $$\nThis equation updates the current estimate $x_j^{(k)}$ by a correction factor. This factor is a weighted sum of the ratios of measured data ($y_{im}$) to the data estimated from the current image ($\\bar{y}_{im}^{(k)}$). The denominator $\\sum_{i,m} p_{ijm}$ is the total sensitivity of voxel $j$.\n\n**2. Numerical Calculation for Voxel $j=2$**\n\nWe apply the formula to compute $x_2^{(k+1)}$ using the current estimate $(x_1^{(k)}, x_2^{(k)}, x_3^{(k)}) = (6, 10, 4)$ kBq.\n\n**Step A: Calculate Expected Counts $\\bar{y}_{im}^{(k)}$**\nFirst, we compute the expected total counts in each bin based on the current image estimate:\n- $\\bar{y}_{1,1}^{(k)} = p_{1,1,1}x_1^{(k)} + p_{1,2,1}x_2^{(k)} + p_{1,3,1}x_3^{(k)} + s_{1,1} = 4(6) + 5(10) + 2(4) + 5 = 87$\n- $\\bar{y}_{1,2}^{(k)} = p_{1,1,2}x_1^{(k)} + p_{1,2,2}x_2^{(k)} + p_{1,3,2}x_3^{(k)} + s_{1,2} = 2(6) + 15(10) + 2(4) + 10 = 180$\n- $\\bar{y}_{1,3}^{(k)} = p_{1,1,3}x_1^{(k)} + p_{1,2,3}x_2^{(k)} + p_{1,3,3}x_3^{(k)} + s_{1,3} = 1(6) + 6(10) + 4(4) + 5 = 87$\n- $\\bar{y}_{2,1}^{(k)} = p_{2,1,1}x_1^{(k)} + p_{2,2,1}x_2^{(k)} + p_{2,3,1}x_3^{(k)} + s_{2,1} = 3(6) + 4(10) + 1(4) + 4 = 66$\n- $\\bar{y}_{2,2}^{(k)} = p_{2,1,2}x_1^{(k)} + p_{2,2,2}x_2^{(k)} + p_{2,3,2}x_3^{(k)} + s_{2,2} = 1(6) + 12(10) + 2(4) + 8 = 142$\n- $\\bar{y}_{2,3}^{(k)} = p_{2,1,3}x_1^{(k)} + p_{2,2,3}x_2^{(k)} + p_{2,3,3}x_3^{(k)} + s_{2,3} = 0.5(6) + 7(10) + 3(4) + 4 = 89$\n\n**Step B: Calculate Sensitivity for Voxel $j=2$**\nThe total sensitivity for voxel 2 is the sum of its system matrix elements:\n$$ c_2 = \\sum_{i,m} p_{i,2,m} = (5 + 15 + 6) + (4 + 12 + 7) = 26 + 23 = 49 $$\n\n**Step C: Calculate the Correction Sum**\nWe compute the sum of the correction terms for voxel 2:\n$$ \\text{Correction Sum} = \\sum_{i,m} p_{i,2,m} \\frac{y_{im}}{\\bar{y}_{im}^{(k)}} $$\n$$ \\text{Sum} = \\left(5 \\frac{100}{87}\\right) + \\left(15 \\frac{250}{180}\\right) + \\left(6 \\frac{120}{87}\\right) + \\left(4 \\frac{80}{66}\\right) + \\left(12 \\frac{200}{142}\\right) + \\left(7 \\frac{90}{89}\\right) $$\n$$ \\text{Sum} \\approx 5.7471 + 20.8333 + 8.2759 + 4.8485 + 16.9014 + 7.0787 \\approx 63.6849 $$\n\n**Step D: Compute Final Updated Activity $x_2^{(k+1)}$**\nFinally, we assemble the components to calculate the updated activity:\n$$ x_2^{(k+1)} = x_2^{(k)} \\frac{\\text{Correction Sum}}{c_2} = 10 \\times \\frac{63.6849}{49} \\approx 12.9969 $$\nRounding to four significant figures gives $13.00$.", "answer": "$$\\boxed{13.00}$$", "id": "4937399"}]}