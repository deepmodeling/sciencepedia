{"hands_on_practices": [{"introduction": "To master electronic focusing, we must first understand how to precisely control the timing of signals from individual transducer elements. This foundational practice [@problem_id:4882907] guides you through the process of calculating the exact inter-element time delays required to steer an ultrasound beam to a desired angle. By working from the first principles of wave propagation, you will develop a core skill for designing any phased-array imaging sequence.", "problem": "A uniform linear ultrasound array lies along the $x$-axis with element pitch $p = 0.3\\ \\text{mm}$. The medium is homogeneous soft tissue with speed of sound $c = 1540\\ \\text{m/s}$. Consider electronically steering a narrowband transmit beam of center frequency $f = 5\\ \\text{MHz}$ to an angle $\\theta = 20^{\\circ}$ relative to the array normal (the $z$-axis). Using first-principles reasoning from plane-wave propagation and the phase of time-harmonic fields, derive the adjacent-element time-delay increment $\\Delta t$ required to produce a plane wave steered to angle $\\theta$ and the corresponding adjacent-element phase difference $\\phi$ under the narrowband (phase-shift) approximation. Then, based on the derived $\\phi$, determine whether phase wrapping would be needed (i.e., whether $\\phi \\geq 2\\pi$).\n\nYour derivation must begin from the representation of a time-harmonic plane wave $p(\\mathbf{r},t) \\propto \\exp\\!\\big(i(\\mathbf{k}\\cdot \\mathbf{r} - \\omega t)\\big)$, the relation $\\omega = 2\\pi f$, and $\\lVert \\mathbf{k} \\rVert = k = \\omega/c$. Do not assume any focusing law; instead, use fundamental geometry of plane-wave steering to obtain the required inter-element delay law. \n\nCompute the numerical values for $\\Delta t$ and $\\phi$ using the parameters above. Round your numerical answers to four significant figures. Express $\\Delta t$ in nanoseconds and $\\phi$ in radians. Provide your final answer as a two-entry row $\\big[\\Delta t,\\ \\phi\\big]$. Also state whether phase wrapping is needed in your reasoning.", "solution": "The problem is scientifically grounded, well-posed, objective, and contains all necessary information to derive a unique solution. It is a standard problem in the field of medical imaging and acoustics. Therefore, the problem is valid.\n\nWe begin the derivation from first principles. The ultrasound array is a uniform linear array positioned along the $x$-axis, with elements separated by a pitch $p$. We wish to form a plane wave that propagates at an angle $\\theta$ relative to the array normal, which is the $z$-axis.\n\nLet the array elements be indexed by an integer $n$, with the element $n=0$ located at the origin $(x,z)=(0,0)$. The position of the $n$-th element is given by the vector $\\mathbf{r}_n = (np, 0, 0)$.\n\nA plane wave is characterized by its wavefronts, which are surfaces of constant phase. For a plane wave to be steered at an angle $\\theta$ with respect to the $z$-axis, the wavefronts must be planar and oriented perpendicular to the direction of propagation.\n\nConsider a planar wavefront that passes through the origin $(0,0)$ at time $t=0$. For this wavefront to propagate at an angle $\\theta$, the signals emitted by the different array elements must be appropriately timed. Let's analyze the geometric path length difference. The element at $x=p$ (i.e., $n=1$) is at a different position than the element at $x=0$. For a wavefront propagating into the half-space $z>0$ at an angle $\\theta$ relative to the $z$-axis, the path length from the element at $x=p$ to the wavefront is shorter than the path length from the element at $x=0$ by an amount $\\Delta L$. This path length difference is given by the geometry:\n$$ \\Delta L = p \\sin(\\theta) $$\nThis is the extra distance the wave from the origin element must travel to reach the same wavefront as the wave from the element at $x=p$. To ensure that the signals from these two elements contribute constructively to this same wavefront, the signal from the element at $x=p$ must be delayed in time relative to the signal from the element at $x=0$. This time delay, which we denote as the adjacent-element time-delay increment $\\Delta t$, must exactly compensate for the travel time over the path difference $\\Delta L$.\nThe time delay is therefore:\n$$ \\Delta t = \\frac{\\Delta L}{c} $$\nwhere $c$ is the speed of sound in the medium. Substituting the expression for $\\Delta L$, we get the formula for the required time delay increment between adjacent elements:\n$$ \\Delta t = \\frac{p \\sin(\\theta)}{c} $$\nFor the $n$-th element at position $x_n = np$, the total delay relative to the element at the origin is $t_n = n \\Delta t$.\n\nUnder the narrowband approximation, the transmitted signal is a time-harmonic wave, which can be represented in complex form as proportional to $\\exp(-i\\omega t)$, where $\\omega$ is the angular frequency. A time delay of $\\Delta t$ corresponds to a phase shift of $\\phi$. A signal delayed by $\\Delta t$ is represented as $\\exp(-i\\omega(t-\\Delta t)) = \\exp(-i\\omega t)\\exp(i\\omega \\Delta t)$. The term $\\exp(i\\omega \\Delta t)$ represents a phase shift $\\phi$.\nThus, the adjacent-element phase difference $\\phi$ is:\n$$ \\phi = \\omega \\Delta t $$\nThe angular frequency $\\omega$ is related to the center frequency $f$ by $\\omega = 2\\pi f$. Substituting this and the expression for $\\Delta t$:\n$$ \\phi = (2\\pi f) \\left( \\frac{p \\sin(\\theta)}{c} \\right) = \\frac{2\\pi f p \\sin(\\theta)}{c} $$\nWe can also express this in terms of the wavenumber $k = \\omega/c = 2\\pi f / c = 2\\pi/\\lambda$, where $\\lambda$ is the wavelength.\n$$ \\phi = k p \\sin(\\theta) $$\nThis completes the derivation of the required formulas.\n\nNow, we compute the numerical values using the given parameters:\n- Element pitch: $p = 0.3\\ \\text{mm} = 0.3 \\times 10^{-3}\\ \\text{m}$\n- Speed of sound: $c = 1540\\ \\text{m/s}$\n- Center frequency: $f = 5\\ \\text{MHz} = 5 \\times 10^6\\ \\text{Hz}$\n- Steering angle: $\\theta = 20^{\\circ}$\n\nFirst, we calculate the adjacent-element time-delay increment $\\Delta t$:\n$$ \\Delta t = \\frac{(0.3 \\times 10^{-3}\\ \\text{m}) \\sin(20^{\\circ})}{1540\\ \\text{m/s}} $$\nUsing $\\sin(20^{\\circ}) \\approx 0.34202$:\n$$ \\Delta t \\approx \\frac{(0.3 \\times 10^{-3}) \\times 0.34202}{1540}\\ \\text{s} \\approx 6.6627 \\times 10^{-8}\\ \\text{s} $$\nThe problem asks for the answer in nanoseconds ($1\\ \\text{ns} = 10^{-9}\\ \\text{s}$).\n$$ \\Delta t \\approx 66.627\\ \\text{ns} $$\nRounding to four significant figures, we get $\\Delta t = 66.63\\ \\text{ns}$.\n\nNext, we calculate the corresponding adjacent-element phase difference $\\phi$:\n$$ \\phi = \\omega \\Delta t = 2\\pi f \\Delta t $$\n$$ \\phi = 2\\pi (5 \\times 10^6\\ \\text{Hz}) (6.6627 \\times 10^{-8}\\ \\text{s}) $$\n$$ \\phi = 10\\pi \\times 10^6 \\times 6.6627 \\times 10^{-8}\\ \\text{rad} = 0.66627\\pi\\ \\text{rad} \\approx 2.0931\\ \\text{rad} $$\nRounding to four significant figures, we get $\\phi = 2.093\\ \\text{rad}$.\n\nFinally, we must determine if phase wrapping is needed. Phase wrapping is required when the calculated phase shift $\\phi$ is greater than or equal to $2\\pi$, as the phase shifters can apply shifts in the range $[0, 2\\pi)$ or $(-\\pi, \\pi]$.\nWe compare our calculated phase shift $\\phi$ to $2\\pi$:\n$$ \\phi \\approx 2.093\\ \\text{rad} $$\n$$ 2\\pi \\approx 2 \\times 3.14159 = 6.283\\ \\text{rad} $$\nSince $2.093 < 6.283$, we have $\\phi < 2\\pi$. Therefore, phase wrapping is not needed for this steering angle and set of parameters.", "answer": "$$\\boxed{\\begin{pmatrix} 66.63 & 2.093 \\end{pmatrix}}$$", "id": "4882907"}, {"introduction": "Effective ultrasound imaging requires not just creating a focus, but maintaining its quality as echoes return from different depths. This design exercise [@problem_id:4882934] challenges you to create a dynamic receive aperture law, a critical component of dynamic focusing. You will learn how to adjust the number of active elements in real-time to maintain a constant $F$-number, ensuring consistent image resolution throughout the field of view.", "problem": "An ultrasound imaging system uses a one-dimensional linear array with a total of $128$ identical elements and center-to-center pitch $p = 0.3\\ \\text{mm}$. In dynamic receive focusing, the effective receive aperture grows with imaging depth $z$ to aim for an approximately constant $F$-number $F \\approx 1.5$ over a depth range from $z = 10\\ \\text{mm}$ to $z = 60\\ \\text{mm}$. Assume the following physically motivated base:\n- The $F$-number is defined as $F = z/D$, where $z$ is the focal (imaging) depth and $D$ is the effective receive aperture width.\n- For a uniformly weighted, centrally symmetric subaperture on a uniform linear array with negligible kerf and element width comparable to the pitch, the effective aperture width is approximated by $D \\approx N p$, where $N$ is the number of active elements and $p$ is the pitch.\n- The subaperture must use an integer number of elements, and cannot exceed the full array size $N \\leq 128$.\n\nStarting from these bases, derive a dynamic receive aperture growth law $N(z)$ that selects the number of active elements as a function of depth $z$ to maintain $F \\approx 1.5$ over the specified range, honoring the integer and maximum-size constraints. Your law should use the nearest-integer choice of $N$ to the ideal continuous value implied by $F = z/D$, and it should saturate at the full-aperture limit when needed. Treat $z$ as expressed in millimeters.\n\nProvide your final result as a single closed-form expression $N(z)$ in terms of $z$ only, with any constants numerically simplified. State your answer as the analytic expression for $N(z)$; do not include physical units in the final expression.", "solution": "The problem requires the derivation of a dynamic receive aperture growth law, denoted by the function $N(z)$, which specifies the number of active elements $N$ as a function of imaging depth $z$. The derivation must satisfy several conditions: maintaining a nearly constant $F$-number, respecting the discrete nature of transducer elements, and adhering to the physical size limit of the array.\n\nFirst, the problem statement is validated.\n\n**Step 1: Extract Givens**\n- Total number of elements: $128$\n- Center-to-center pitch: $p = 0.3\\ \\text{mm}$\n- Target $F$-number: $F \\approx 1.5$\n- Imaging depth range: $z = 10\\ \\text{mm}$ to $z = 60\\ \\text{mm}$\n- Definition of $F$-number: $F = z/D$, where $D$ is the effective receive aperture width.\n- Approximation for aperture width: $D \\approx N p$, where $N$ is the number of active elements.\n- Constraint on $N$: $N$ must be an integer.\n- Constraint on maximum aperture: $N \\le 128$.\n- Rule for discretization: $N$ should be the nearest-integer choice to the ideal continuous value.\n- Saturation condition: The law must saturate at the full-aperture limit.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded, as it is based on fundamental principles of ultrasound beamforming, including the definitions of $F$-number and aperture size, which are central to medical imaging physics. All provided values and parameters are physically realistic for a clinical ultrasound probe. The problem is well-posed; it provides sufficient information and clear, consistent constraints to derive a unique function $N(z)$. The language is objective and precise. The problem does not violate any of the invalidity criteria.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A reasoned solution will be provided.\n\n**Solution Derivation**\n\nThe core of the problem is to maintain a constant $F$-number. The relationship between the $F$-number $F$, the imaging depth $z$, and the aperture width $D$ is given by:\n$$F = \\frac{z}{D}$$\n\nThe effective aperture width $D$ is related to the number of active elements $N$ and the pitch $p$ by the approximation:\n$$D \\approx N p$$\n\nTo find an ideal, continuous number of elements $N_{\\text{ideal}}$ that would perfectly maintain the target $F$-number, we can combine these two equations. Substituting the expression for $D$ into the $F$-number equation gives:\n$$F \\approx \\frac{z}{N p}$$\n\nSolving for $N$ yields the ideal number of elements as a function of depth $z$:\n$$N_{\\text{ideal}}(z) = \\frac{z}{F p}$$\n\nNow, we substitute the given numerical values for $F$ and $p$. The target $F$-number is $F = 1.5$, and the pitch is $p = 0.3\\ \\text{mm}$. The input $z$ is understood to be in millimeters.\n$$N_{\\text{ideal}}(z) = \\frac{z}{1.5 \\times 0.3} = \\frac{z}{0.45}$$\n\nTo express the constant as a rational number, we can write:\n$$N_{\\text{ideal}}(z) = \\frac{1}{0.45}z = \\frac{100}{45}z = \\frac{20}{9}z$$\n\nThis expression gives the ideal number of elements, which is a continuous real number. However, the physical system has two constraints that must be incorporated into the final law for $N(z)$:\n1.  The number of elements $N$ must be an integer. The problem specifies using the \"nearest-integer choice\". This is mathematically equivalent to a rounding function. A standard implementation of rounding a non-negative number $x$ to the nearest integer is $\\lfloor x + 0.5 \\rfloor$.\n2.  The number of elements $N$ cannot exceed the total number of elements available in the array, which is $128$. This imposes an upper limit, or saturation, on $N$.\n\nWe apply these two constraints sequentially. First, we apply the nearest-integer rule to $N_{\\text{ideal}}(z)$:\n$$N_{\\text{rounded}}(z) = \\left\\lfloor N_{\\text{ideal}}(z) + \\frac{1}{2} \\right\\rfloor = \\left\\lfloor \\frac{20}{9}z + \\frac{1}{2} \\right\\rfloor$$\n\nNext, we apply the saturation constraint. The number of active elements cannot be more than $128$. This means that if the calculated rounded number of elements exceeds $128$, it must be capped at $128$. This can be expressed using the minimum function:\n$$N(z) = \\min\\left(N_{\\text{rounded}}(z), 128\\right)$$\n\nSubstituting the expression for $N_{\\text{rounded}}(z)$, we arrive at the final closed-form expression for the dynamic receive aperture growth law:\n$$N(z) = \\min\\left(\\left\\lfloor \\frac{20}{9}z + \\frac{1}{2} \\right\\rfloor, 128\\right)$$\n\nThis expression for $N(z)$ provides the number of active elements for any given depth $z$ (in mm), satisfying all the conditions specified in the problem statement. The number of elements grows linearly with depth (in a stepwise integer fashion) until the aperture saturates at the full array size of $128$ elements.", "answer": "$$\\boxed{\\min\\left(\\left\\lfloor \\frac{20}{9}z + \\frac{1}{2} \\right\\rfloor, 128\\right)}$$", "id": "4882934"}, {"introduction": "Beyond basic focusing, advanced beamforming techniques can significantly enhance image quality by suppressing artifacts. This computational practice [@problem_id:4882937] allows you to simulate a synthetic aperture imaging method known as coherent compounding. By building the simulation from the ground up, you will directly observe and quantify how combining data from multiple transmit angles reduces sidelobe levels and improves the final image.", "problem": "Consider a one-dimensional linear ultrasound array performing electronic transmit steering and dynamic receive focusing in a homogeneous medium. Use the following well-tested physical laws and definitions as the sole modeling basis: (i) propagation time is $t = r/c$ for distance $r$ and sound speed $c$, (ii) the baseband response of a narrowband sinusoid at center frequency $f_0$ after propagation delay $t$ is $\\exp(-j 2 \\pi f_0 t)$, and (iii) dynamic receive focusing is achieved by matched filtering (phase conjugation) using the hypothesized propagation times to each beamformed point. A single unit-amplitude point scatterer is located at $(x_s, z_s) = (0, z_0)$ with $z_0 &gt; 0$. The transducer lies along the $x$-axis at $z = 0$. The $N$ array elements are centered at the origin and uniformly spaced with pitch $p$, so that element $m$ has lateral coordinate $x_m = \\left(m - \\frac{N-1}{2}\\right) p$ for integer $m \\in \\{0,1,\\dots,N-1\\}$. Two plane-wave transmissions at steering angles $\\theta = \\pm 10^\\circ$ (degrees) are emitted from the array plane at $t=0$. The arrival time of a plane wave steered at angle $\\theta$ to a spatial location $(x,z)$ is proportional to the projection of $(x,z)$ onto the plane-wave propagation direction, i.e., use the travel-time model $t_{\\mathrm{tx}}^{(\\theta)}(x,z) = \\left(x \\sin \\theta + z \\cos \\theta\\right)/c$ up to an immaterial additive constant. The receive time from $(x,z)$ to element $m$ is $t_{\\mathrm{rx}}(x,z;x_m) = \\sqrt{(x_m - x)^2 + z^2}/c$. Assume attenuation and angular sensitivity are negligible and all elements have identical sensitivity. For a given transmit angle $\\theta$, the complex baseband signal at element $m$ due to the actual scatterer at $(0,z_0)$ is $s_m^{(\\theta)} = \\exp\\left(-j 2 \\pi f_0 \\left[t_{\\mathrm{tx}}^{(\\theta)}(0,z_0) + t_{\\mathrm{rx}}(0,z_0;x_m)\\right]\\right)$. To form a dynamically focused beamformed output at a lateral test position $x$ (at depth $z_0$), apply matched filtering delays corresponding to the hypothesized propagation times to $(x,z_0)$ for the same transmit angle $\\theta$, yielding $b^{(\\theta)}(x) = \\sum_{m=0}^{N-1} s_m^{(\\theta)} \\exp\\left(+j 2 \\pi f_0 \\left[t_{\\mathrm{tx}}^{(\\theta)}(x,z_0) + t_{\\mathrm{rx}}(x,z_0;x_m)\\right]\\right)$. Define the two-angle coherently compounded output as $b^{\\mathrm{comp}}(x) = \\sum_{\\theta \\in \\{-10^\\circ,+10^\\circ\\}} b^{(\\theta)}(x)$. The Point Spread Function (PSF) is the magnitude of the beamformed output $|b(x)|$ as a function of lateral position $x$ at fixed depth $z_0$. Normalize each PSF by its maximum over the evaluated $x$ range. Define the mainlobe region around the peak as the interval between the first local minima to the left and right of the global maximum of the normalized PSF magnitude. Define the peak sidelobe level (PSL) as the maximum value of the normalized PSF magnitude outside the mainlobe region. For comparison to single-angle focusing, use $\\theta = +10^\\circ$ alone as the single-angle case.\n\nTask: Write a program that computes the normalized single-angle PSF for $\\theta = +10^\\circ$, the normalized coherently compounded PSF for $\\theta \\in \\{-10^\\circ,+10^\\circ\\}$, and then quantifies the sidelobe reduction due to compounding by computing the difference in decibels between the single-angle PSL and the compounded PSL, i.e., $20 \\log_{10}(\\mathrm{PSL}_{\\mathrm{single}}) - 20 \\log_{10}(\\mathrm{PSL}_{\\mathrm{comp}})$. Express the final answers in decibels in the output as floating-point numbers. Angles must be interpreted in degrees in the transmit model, and the physical quantities must use the International System of Units: $x$ and $z$ in $\\mathrm{m}$, $c$ in $\\mathrm{m/s}$, $f_0$ in $\\mathrm{Hz}$, and $p$ in $\\mathrm{m}$. The lateral evaluation grid must be uniform over a specified range. The program should implement the definitions above without introducing any alternative beam pattern formulas or approximations.\n\nTest Suite: Your program must execute the following three parameter sets and output the sidelobe reduction for each, in this order:\n\n- Case $1$ (typical aperture and depth): $N = 128$, $p = 0.0003\\,\\mathrm{m}$, $f_0 = 5.0 \\times 10^6\\,\\mathrm{Hz}$, $c = 1540\\,\\mathrm{m/s}$, $z_0 = 0.040\\,\\mathrm{m}$, lateral grid $x \\in [-0.015\\,\\mathrm{m}, 0.015\\,\\mathrm{m}]$ with step $\\Delta x = 0.00005\\,\\mathrm{m}$.\n- Case $2$ (smaller aperture, shallower target): $N = 64$, $p = 0.0003\\,\\mathrm{m}$, $f_0 = 5.0 \\times 10^6\\,\\mathrm{Hz}$, $c = 1540\\,\\mathrm{m/s}$, $z_0 = 0.020\\,\\mathrm{m}$, lateral grid $x \\in [-0.015\\,\\mathrm{m}, 0.015\\,\\mathrm{m}]$ with step $\\Delta x = 0.00005\\,\\mathrm{m}$.\n- Case $3$ (denser pitch, higher frequency, deeper target): $N = 128$, $p = 0.0002\\,\\mathrm{m}$, $f_0 = 7.5 \\times 10^6\\,\\mathrm{Hz}$, $c = 1540\\,\\mathrm{m/s}$, $z_0 = 0.050\\,\\mathrm{m}$, lateral grid $x \\in [-0.010\\,\\mathrm{m}, 0.010\\,\\mathrm{m}]$ with step $\\Delta x = 0.00005\\,\\mathrm{m}$.\n\nOutput Specification: Your program should produce a single line of output containing the sidelobe reduction values for the three cases, in decibels, rounded to three decimal places, as a comma-separated list enclosed in square brackets, e.g., $[a_1,a_2,a_3]$ where each $a_k$ is a float. No other text should be printed.", "solution": "The user-provided problem is evaluated as scientifically sound, self-contained, and well-posed. All physical models, mathematical definitions, and numerical parameters are provided explicitly and are consistent with established principles in the field of medical ultrasound imaging. The task is to implement a direct simulation based on these first principles.\n\nThe solution proceeds by first constructing the mathematical model for the beamformed signal, then defining the procedure for calculating the Point Spread Function (PSF) and the Peak Sidelobe Level (PSL), and finally applying this procedure to the specified test cases.\n\nFirst, we establish the geometric and physical parameters. The system consists of a linear array of $N$ transducer elements. The position of the $m$-th element, for $m \\in \\{0, 1, \\dots, N-1\\}$, is given by $x_m = \\left(m - \\frac{N-1}{2}\\right) p$, where $p$ is the element pitch. A single point scatterer is located at $(x_s, z_s) = (0, z_0)$. The medium has a constant speed of sound, $c$. The transducer operates at a center frequency $f_0$. It is convenient to define the acoustic wavenumber $k = \\frac{2\\pi f_0}{c}$.\n\nThe imaging process involves two stages: transmit and receive.\n1.  **Transmit Stage**: A plane wave is electronically steered at an angle $\\theta$ relative to the $z$-axis. The time it takes for this wavefront to travel from the array plane ($z=0$) to a point $(x, z)$ is given by $t_{\\mathrm{tx}}^{(\\theta)}(x,z) = (x \\sin\\theta + z \\cos\\theta)/c$. For the scatterer at $(0, z_0)$, the transmit travel time is $t_{\\mathrm{tx}}^{(\\theta)}(0, z_0) = (z_0 \\cos\\theta)/c$.\n\n2.  **Receive Stage**: After scattering, the ultrasonic wave propagates from the scatterer at $(0, z_0)$ to each array element $m$ at $(x_m, 0)$. This is a spherical wave, and the travel time to element $m$ is determined by the Euclidean distance: $t_{\\mathrm{rx}}(0, z_0; x_m) = \\frac{\\sqrt{(x_m - 0)^2 + (0 - z_0)^2}}{c} = \\frac{\\sqrt{x_m^2 + z_0^2}}{c}$.\n\nThe total travel time from transmission to reception at element $m$ for a given transmit angle $\\theta$ is the sum of the transmit and receive times: $T_m^{(\\theta)} = t_{\\mathrm{tx}}^{(\\theta)}(0, z_0) + t_{\\mathrm{rx}}(0, z_0; x_m)$. The complex baseband signal received at element $m$ is modeled as a phase rotation corresponding to this total delay:\n$$s_m^{(\\theta)} = \\exp(-j 2\\pi f_0 T_m^{(\\theta)}) = \\exp\\left(-j k \\left[z_0 \\cos\\theta + \\sqrt{x_m^2 + z_0^2}\\right]\\right)$$\n\nTo reconstruct an image, the received signals are coherently summed using a technique called dynamic receive focusing. This process, equivalent to matched filtering, applies a conjugate phase shift to the signal from each element, corresponding to the *hypothesized* travel time from a focal point $(x, z_0)$ to that element. For a given transmit angle $\\theta$, the total hypothesized travel time from transmission to a focal point $(x, z_0)$ and then to element $m$ is $T_{m,\\text{focus}}^{(\\theta)}(x, z_0) = t_{\\mathrm{tx}}^{(\\theta)}(x, z_0) + t_{\\mathrm{rx}}(x, z_0; x_m)$.\nThe focusing phase shift for element $m$ is $\\exp(+j 2\\pi f_0 T_{m,\\text{focus}}^{(\\theta)}(x, z_0))$.\n\nThe beamformed output for a transmit angle $\\theta$ is the coherent sum over all elements, evaluated at a lateral test position $x$ at the known depth $z_0$:\n$$b^{(\\theta)}(x) = \\sum_{m=0}^{N-1} s_m^{(\\theta)} \\exp\\left(+j 2\\pi f_0 \\left[t_{\\mathrm{tx}}^{(\\theta)}(x, z_0) + t_{\\mathrm{rx}}(x, z_0; x_m)\\right]\\right)$$\nSubstituting the expressions for the signal and the focusing delays, along with the definitions of the travel times:\n$$b^{(\\theta)}(x) = \\sum_{m=0}^{N-1} \\exp\\left(-j k \\left[z_0 \\cos\\theta + \\sqrt{x_m^2 + z_0^2}\\right]\\right) \\exp\\left(+j k \\left[x \\sin\\theta + z_0 \\cos\\theta + \\sqrt{(x_m - x)^2 + z_0^2}\\right]\\right)$$\nThe term $j k z_0 \\cos\\theta$ cancels out, simplifying the expression to:\n$$b^{(\\theta)}(x) = \\sum_{m=0}^{N-1} \\exp\\left(j k \\left[x \\sin\\theta + \\sqrt{(x_m - x)^2 + z_0^2} - \\sqrt{x_m^2 + z_0^2}\\right]\\right)$$\nThis is the fundamental equation to be implemented.\n\nThe problem requires comparison between a single-angle case and a coherently compounded case.\n-   The single-angle beamformed output uses $\\theta = +10^\\circ$: $b^{\\mathrm{single}}(x) = b^{(+10^\\circ)}(x)$.\n-   The coherently compounded output sums the results from $\\theta = +10^\\circ$ and $\\theta = -10^\\circ$: $b^{\\mathrm{comp}}(x) = b^{(+10^\\circ)}(x) + b^{(-10^\\circ)}(x)$.\n\nThe Point Spread Function (PSF) is the magnitude of the complex beamformed output, normalized to its maximum value. For the single-angle case:\n$$\\mathrm{PSF}_{\\mathrm{single}}(x) = \\frac{|b^{\\mathrm{single}}(x)|}{\\max_x |b^{\\mathrm{single}}(x)|}$$\nAnd similarly for the compounded case:\n$$\\mathrm{PSF}_{\\mathrm{comp}}(x) = \\frac{|b^{\\mathrm{comp}}(x)|}{\\max_x |b^{\\mathrm{comp}}(x)|}$$\n\nThe Peak Sidelobe Level (PSL) is the maximum of the normalized PSF outside the mainlobe. The mainlobe is defined as the region between the first local minimum to the left and the first local minimum to the right of the global maximum. The algorithm to find the PSL is as follows:\n1.  Compute the normalized PSF over the specified lateral grid $x$.\n2.  Locate the index of the global maximum (the peak of the mainlobe).\n3.  Identify all local minima of the PSF. This can be achieved by finding the peaks of the negative PSF.\n4.  Find the indices of the first local minimum to the left and to the right of the global maximum. These define the boundaries of the mainlobe.\n5.  The sidelobe region consists of all points outside this mainlobe interval.\n6.  The PSL is the maximum value of the PSF in the sidelobe region.\n\nFinally, the sidelobe reduction due to compounding is quantified as the difference in the PSL values on a decibel (dB) scale:\n$$\\Delta_{\\mathrm{PSL}} [\\text{dB}] = 20 \\log_{10}(\\mathrm{PSL}_{\\mathrm{single}}) - 20 \\log_{10}(\\mathrm{PSL}_{\\mathrm{comp}})$$\n\nThis procedure is applied to each of the three test cases provided in the problem statement. The implementation will use `numpy` for efficient array computation and `scipy.signal.find_peaks` to identify the local minima of the PSFs. Angles given in degrees must be converted to radians for use in trigonometric functions.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import signal\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for the given test cases.\n    It computes the Point Spread Functions (PSFs) for single-angle and \n    coherently compounded plane-wave imaging, calculates the Peak Sidelobe Level (PSL) \n    for each, and determines the sidelobe reduction in decibels.\n    \"\"\"\n\n    test_cases = [\n        {\n            \"N\": 128, \"p\": 0.0003, \"f0\": 5.0e6, \"c\": 1540, \"z0\": 0.040,\n            \"x_range\": [-0.015, 0.015], \"dx\": 0.00005\n        },\n        {\n            \"N\": 64, \"p\": 0.0003, \"f0\": 5.0e6, \"c\": 1540, \"z0\": 0.020,\n            \"x_range\": [-0.015, 0.015], \"dx\": 0.00005\n        },\n        {\n            \"N\": 128, \"p\": 0.0002, \"f0\": 7.5e6, \"c\": 1540, \"z0\": 0.050,\n            \"x_range\": [-0.010, 0.010], \"dx\": 0.00005\n        }\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        N = case[\"N\"]\n        p = case[\"p\"]\n        f0 = case[\"f0\"]\n        c = case[\"c\"]\n        z0 = case[\"z0\"]\n        x_min, x_max = case[\"x_range\"]\n        dx = case[\"dx\"]\n\n        # 1. Define Geometry and Grid\n        k = 2 * np.pi * f0 / c\n        thetas_deg = [-10.0, 10.0]\n        thetas_rad = np.deg2rad(thetas_deg)\n        x_m = (np.arange(N) - (N - 1) / 2) * p\n        x_grid = np.arange(x_min, x_max + dx, dx)\n\n        # 2. Calculate Beamformed Outputs\n        \n        # Reshape for broadcasting\n        # x_m: (N,) -> (N, 1)\n        # x_grid: (M,) -> (1, M) where M is number of grid points\n        x_m_bc = x_m[:, np.newaxis]\n        x_grid_bc = x_grid[np.newaxis, :]\n\n        # Term for actual scatterer at (0, z0)\n        rx_dist_scatterer = np.sqrt(x_m_bc**2 + z0**2)\n        \n        # Term for hypothesized scatterer at (x, z0)\n        rx_dist_focus = np.sqrt((x_m_bc - x_grid_bc)**2 + z0**2)\n        \n        # Calculate b_theta for each steering angle\n        b_thetas = []\n        for theta in thetas_rad:\n            phase = k * (x_grid_bc * np.sin(theta) + rx_dist_focus - rx_dist_scatterer)\n            b_theta = np.sum(np.exp(1j * phase), axis=0)\n            b_thetas.append(b_theta)\n\n        # 3. Form Single-Angle and Compounded Outputs\n        b_single = b_thetas[1]  # Using theta = +10 degrees\n        b_comp = b_thetas[0] + b_thetas[1]\n\n        # 4. Calculate Normalized PSFs\n        psf_single = np.abs(b_single)\n        psf_single_norm = psf_single / np.max(psf_single)\n\n        psf_comp = np.abs(b_comp)\n        psf_comp_norm = psf_comp / np.max(psf_comp)\n\n        # 5. Calculate PSL for each PSF\n        def find_psl(psf):\n            \"\"\"\n            Calculates the Peak Sidelobe Level (PSL) for a given normalized PSF.\n            \"\"\"\n            # Find the mainlobe peak\n            peak_idx = np.argmax(psf)\n            \n            # Find all local minima by finding peaks of the inverted PSF\n            minima_indices, _ = signal.find_peaks(-psf)\n            \n            # Find the first minima to the left and right of the main peak\n            left_minima = minima_indices[minima_indices < peak_idx]\n            right_minima = minima_indices[minima_indices > peak_idx]\n            \n            if left_minima.size == 0 or right_minima.size == 0:\n                # Fallback if no minima found on one side, which is unlikely for these PSFs.\n                # In this case, we cannot define the sidelobe region properly as per the problem.\n                # Returning NaN would indicate an issue with the PSF shape or grid extent.\n                return np.nan\n\n            first_left_min_idx = np.max(left_minima)\n            first_right_min_idx = np.min(right_minima)\n            \n            # The sidelobe regions are everything outside the mainlobe,\n            # including the minima themselves.\n            sidelobe_values = np.concatenate((psf[:first_left_min_idx + 1], psf[first_right_min_idx:]))\n            \n            if sidelobe_values.size == 0:\n                return 0.0 # No sidelobes present\n            \n            return np.max(sidelobe_values)\n\n        psl_single = find_psl(psf_single_norm)\n        psl_comp = find_psl(psf_comp_norm)\n        \n        # 6. Calculate Sidelobe Reduction in dB\n        # Ensure PSL values are > 0 to avoid log(0) issues.\n        # Given the nature of diffraction, PSL will be > 0.\n        db_diff = 20 * np.log10(psl_single) - 20 * np.log10(psl_comp)\n        results.append(db_diff)\n\n    # Final print statement in the exact required format.\n    # The problem asks for rounding to three decimal places.\n    print(f\"[{','.join(f'{r:.3f}' for r in results)}]\")\n\nsolve()\n```", "id": "4882937"}]}