{"hands_on_practices": [{"introduction": "A CT scanner captures a wide range of tissue densities, but our eyes and computer screens can only perceive a limited grayscale palette. This exercise bridges the gap between the raw data stored in a DICOM file and what we see on the screen. By working through the complete conversion from a stored pixel value to a final normalized gray value, you will master the fundamental pipeline of CT image display, including the crucial roles of DICOM rescaling and windowing parameters. [@problem_id:4873190]", "problem": "A computed tomography slice is stored with Digital Imaging and Communications in Medicine (DICOM) metadata indicating that the physical quantity to be displayed is the Hounsfield Unit, obtained from the stored pixel values by an affine rescaling characterized by a slope and an intercept. The stored pixel values are quantized to a $12$-bit unsigned integer in the range $[0,4095]$. The DICOM header lists a Rescale Slope $m = 1.25$ and a Rescale Intercept $b = -1024$ (in Hounsfield Units). The display system applies linear windowing with window level $L$ and window width $W$ to map Hounsfield Units to a unitless normalized gray value in $[0,1]$, by linearly mapping the interval $\\left[L - \\frac{W}{2},\\, L + \\frac{W}{2}\\right]$ to $[0,1]$ and clamping values outside this interval to the nearest endpoint.\n\nAssume a clinician specifies a target tissue attenuation of $-600$ Hounsfield Units and requests that you choose the stored pixel value $PV$ (an integer in $[0,4095]$) that produces a displayed Hounsfield Unit as close as possible to the target when passed through the DICOM rescaling. In the event of an exact tie between two integers, choose the smaller $PV$. For display, use a window level $L = -600$ and window width $W = 1500$.\n\nStarting from the definitions of Hounsfield Units and affine rescaling, and from the definition of linear windowing stated above, determine the final normalized display gray value in $[0,1]$ that results from the chosen $PV$. Round your final answer to four significant figures. Express the final answer as a unitless decimal.", "solution": "The problem requires a two-step calculation. First, we must identify the optimal stored pixel value ($PV$) that produces a Hounsfield Unit ($HU$) value closest to a specified target. Second, we must compute the final normalized gray value ($GV$) that results from applying a linear windowing function to this Hounsfield Unit value.\n\nThe first step involves the DICOM rescaling of stored pixel values. The relationship between the stored pixel value $PV$ and the resulting physical quantity, in this case, Hounsfield Units ($HU$), is an affine transformation:\n$$HU = m \\cdot PV + b$$\nThe problem provides the Rescale Slope $m = 1.25$, the Rescale Intercept $b = -1024$, and the target tissue attenuation $HU_{target} = -600$. The stored pixel values are $12$-bit unsigned integers, meaning $PV$ must be an integer in the range $[0, 4095]$.\n\nOur objective is to find the integer $PV$ in this range that minimizes the absolute difference $|HU - HU_{target}|$. Substituting the given values and the rescaling equation, we want to minimize:\n$$| (m \\cdot PV + b) - HU_{target} | = | (1.25 \\cdot PV - 1024) - (-600) | = | 1.25 \\cdot PV - 424 |$$\nTo perfectly achieve the target, the expression inside the absolute value would be zero. We can find the ideal, non-integer value of $PV$ by solving the equation:\n$$1.25 \\cdot PV_{ideal} - 424 = 0$$\n$$PV_{ideal} = \\frac{424}{1.25} = \\frac{424}{5/4} = 424 \\cdot \\frac{4}{5} = 339.2$$\nSince $PV$ must be an integer, the optimal value will be one of the two integers surrounding $PV_{ideal}$: $PV_1 = 339$ or $PV_2 = 340$. We must determine which of these yields an $HU$ value closer to $HU_{target} = -600$.\n\nFor $PV_1 = 339$:\n$$HU_1 = 1.25 \\cdot 339 - 1024 = 423.75 - 1024 = -600.25$$\nThe absolute difference from the target is $|-600.25 - (-600)| = |-0.25| = 0.25$.\n\nFor $PV_2 = 340$:\n$$HU_2 = 1.25 \\cdot 340 - 1024 = 425 - 1024 = -599$$\nThe absolute difference from the target is $|-599 - (-600)| = |1| = 1$.\n\nComparing the two differences, $0.25  1$. Therefore, $PV_1 = 339$ produces a Hounsfield Unit value closer to the target. This value is within the allowed range $[0, 4095]$. We select this pixel value, $PV_{chosen} = 339$, which corresponds to a Hounsfield Unit value of $HU_{chosen} = -600.25$.\n\nThe second step is to calculate the final normalized display gray value, $GV$, from $HU_{chosen}$ using the specified windowing parameters. The window level is $L = -600$ and the window width is $W = 1500$. The windowing function linearly maps the Hounsfield Unit interval $[L - \\frac{W}{2}, L + \\frac{W}{2}]$ to the gray value interval $[0, 1]$.\n\nFirst, we calculate the bounds of the Hounsfield Unit window:\n$$HU_{min} = L - \\frac{W}{2} = -600 - \\frac{1500}{2} = -600 - 750 = -1350$$\n$$HU_{max} = L + \\frac{W}{2} = -600 + \\frac{1500}{2} = -600 + 750 = 150$$\nThe Hounsfield Unit window is $[-1350, 150]$.\n\nThe value to be displayed, $HU_{chosen} = -600.25$, lies within this interval ($-1350 \\le -600.25 \\le 150$), so no clamping is needed. The normalized gray value $GV$ is found by linear interpolation within this range:\n$$GV = \\frac{HU_{chosen} - HU_{min}}{HU_{max} - HU_{min}}$$\nNoting that $HU_{max} - HU_{min} = W$, the formula is:\n$$GV = \\frac{HU_{chosen} - HU_{min}}{W}$$\nSubstituting the values:\n$$GV = \\frac{-600.25 - (-1350)}{1500} = \\frac{-600.25 + 1350}{1500} = \\frac{749.75}{1500}$$\nPerforming the division:\n$$GV \\approx 0.4998333...$$\nThe problem requires the final answer to be rounded to four significant figures. The first four significant figures are $4$, $9$, $9$, $8$. The fifth significant digit is $3$, which is less than $5$, so we round down.\n$$GV \\approx 0.4998$$\nThis is the final unitless normalized gray value.", "answer": "$$\\boxed{0.4998}$$", "id": "4873190"}, {"introduction": "Windowing is a powerful tool for visual diagnosis, but it poses a significant risk for quantitative analysis. This practice demonstrates why performing measurements, such as tissue segmentation via thresholding, on the displayed 8-bit image is problematic. You will derive the mathematical relationship between a threshold in the display domain and its equivalent in the Hounsfield Unit domain, revealing how display settings, specifically the window level ($WL$) and window width ($WW$), can introduce a critical bias into your results. [@problem_id:4873151]", "problem": "A Computed Tomography (CT) image is stored in Hounsfield Units (HU), denoted by $h \\in \\mathbb{R}$. For display, the system uses a window level $WL$ and window width $WW$ to map HU values to $8$-bit grayscale values $g \\in [0,255]$. The lower and upper cutoffs of the display window are defined by $L = WL - \\frac{WW}{2}$ and $U = WL + \\frac{WW}{2}$. All HU values $h \\leq L$ are displayed as $g = 0$, all HU values $h \\geq U$ are displayed as $g = 255$, and values $h \\in (L, U)$ are displayed using a linear ramp between $0$ and $255$. A Region of Interest (ROI) segmentation algorithm thresholds on the displayed grayscale values: a voxel is classified as belonging to the ROI if and only if $g \\geq t_{g}$, where $t_{g} \\in [0,255]$ is a user-chosen threshold in the display domain.\n\nStarting from these definitions, and without assuming any additional display nonlinearity or quantization effects beyond the $8$-bit discretization, derive an analytic expression for the HU-domain threshold $t_{h}$ such that $h \\geq t_{h}$ is exactly equivalent to $g \\geq t_{g}$ under the given windowing transformation, assuming $t_{g} \\in [0,255]$ and $h \\in [L,U]$ (i.e., in the linear ramp region). Your derivation should make clear how thresholding on displayed values introduces a dependence on $WW$ in the equivalent HU threshold.\n\nExpress your final answer for $t_{h}$ in Hounsfield Units (HU). No rounding is required; provide a closed-form expression in terms of $WL$, $WW$, and $t_{g}$.", "solution": "The goal is to find an analytical expression for the Hounsfield Unit (HU) threshold, $t_h$, that is equivalent to a given grayscale threshold, $t_g$, for voxels whose HU values fall within the linear portion of the display window.\n\nFirst, we define the linear transformation that maps HU values ($h$) to 8-bit grayscale values ($g$). For HU values within the display window $[L, U]$, the grayscale value is linearly mapped from 0 to 255. The endpoints of this mapping are $(h, g) = (L, 0)$ and $(h, g) = (U, 255)$.\n\nThe equation for this linear relationship can be formulated. The slope of the line is the change in gray value divided by the change in HU value:\n$$m = \\frac{255 - 0}{U - L}$$\nWe know that the width of the HU window is $U - L = WW$. So, the mapping is:\n$$g(h) = \\frac{255}{WW}(h - L)$$\nThe segmentation condition is defined in the display domain as $g \\geq t_g$. We substitute the expression for $g(h)$ into this inequality, assuming the HU value is in the linear region:\n$$\\frac{255}{WW}(h - L) \\geq t_g$$\nTo find the equivalent condition for $h$, we solve this inequality. Since $WW$ is a positive value, we can multiply both sides by $\\frac{WW}{255}$ without changing the direction of the inequality:\n$$h - L \\geq t_g \\cdot \\frac{WW}{255}$$\nAdding $L$ to both sides isolates $h$:\n$$h \\geq L + t_g \\frac{WW}{255}$$\nThis inequality is in the desired form $h \\geq t_h$. By direct comparison, we can identify the HU-domain threshold $t_h$ as:\n$$t_h = L + t_g \\frac{WW}{255}$$\nTo express $t_h$ in terms of the initial parameters $WL$, $WW$, and $t_g$, we substitute the definition of $L = WL - \\frac{WW}{2}$:\n$$t_h = \\left(WL - \\frac{WW}{2}\\right) + t_g \\frac{WW}{255}$$\nThis expression can be rearranged by factoring out $WW$:\n$$t_h = WL + WW \\left(\\frac{t_g}{255}\\right) - WW \\left(\\frac{1}{2}\\right)$$\n$$t_h = WL + WW \\left( \\frac{t_g}{255} - \\frac{1}{2} \\right)$$\nThis final expression represents the Hounsfield Unit threshold $t_h$ equivalent to applying a grayscale threshold $t_g$. It clearly shows that $t_h$ depends on both the window level ($WL$) and the window width ($WW$), highlighting the danger of performing quantitative thresholding on a displayed image rather than the raw HU data.", "answer": "$$\\boxed{WL + WW \\left( \\frac{t_g}{255} - \\frac{1}{2} \\right)}$$", "id": "4873151"}, {"introduction": "In medical imaging, the apparent sharpness of an edge between different tissues can be crucial for diagnosis. This exercise explores how the choice of window width ($WW$) directly impacts the visual representation of an anatomical boundary, especially in high-contrast areas like the interface between bone and soft tissue. By calculating a \"visible transition width,\" you will quantitatively demonstrate how a narrow window, while increasing contrast, can lead to saturation that alters the perceived structure of an edge. [@problem_id:4873184]", "problem": "A computed tomography (CT) line profile across a high-contrast interface between soft tissue and cortical bone is modeled as a one-dimensional edge spread function with partial volume averaging. The true Hounsfield unit (HU) values are $h_{s} = 40$ for soft tissue and $h_{b} = 1400$ for bone. Due to finite spatial resolution, the edge is broadened into a linear ramp over a width of $L = 2$ pixels, so that the HU as a function of position $x$ (in pixels) across the edge is\n$$\nh(x) =\n\\begin{cases}\nh_{s},  x \\leq 0, \\\\\nh_{s} + \\dfrac{h_{b} - h_{s}}{L}\\,x,  0  x  L, \\\\\nh_{b},  x \\geq L.\n\\end{cases}\n$$\nDisplayed grayscale intensity is obtained from HU by the standard linear windowing transformation with window level (WL) and window width (WW): intensities are clamped to black for $h \\leq WL - WW/2$, clamped to white for $h \\geq WL + WW/2$, and mapped linearly between these bounds.\n\nDefine the “visible transition width” $W_{\\text{vis}}$ (in pixels) as the length in $x$ over which the displayed intensity is neither clamped to black nor clamped to white, that is, the set of $x$ values such that $WL - WW/2  h(x)  WL + WW/2$.\n\nFor a fixed window level of $WL = 200$, compare two window widths: a narrow window $WW_{1} = 300$ and a wide window $WW_{2} = 1200$. Compute the ratio\n$$\nR = \\dfrac{W_{\\text{vis}}(WW_{1})}{W_{\\text{vis}}(WW_{2})},\n$$\nwhere $W_{\\text{vis}}(WW)$ is the visible transition width (in pixels) under window width $WW$. Round your final answer for $R$ to three significant figures. Express the answer as a unitless decimal number.", "solution": "The problem asks for the ratio of \"visible transition widths\" for two different window settings. The visible transition width, $W_{\\text{vis}}$, is the spatial extent over which the displayed image is not saturated (neither pure black nor pure white). This corresponds to the portion of the edge ramp where the HU values fall within the display window's range.\n\nFirst, let's define the edge profile and display window parameters. The HU profile $h(x)$ transitions linearly from $h_s = 40$ to $h_b = 1400$ over a spatial width of $L=2$ pixels. The slope of this ramp is:\n$$m = \\frac{h_b - h_s}{L} = \\frac{1400 - 40}{2} = \\frac{1360}{2} = 680 \\text{ HU/pixel}$$\nThe HU values along the ramp are in the range $(40, 1400)$.\n\nThe display window is defined by its lower bound $h_{lower} = WL - WW/2$ and upper bound $h_{upper} = WL + WW/2$. The visible HU range on the ramp is the intersection of the ramp's HU range $(40, 1400)$ and the display window's HU range $(h_{lower}, h_{upper})$. Let this visible HU interval be $(h_{vis, min}, h_{vis, max})$. The corresponding spatial width is then $W_{\\text{vis}} = (h_{vis, max} - h_{vis, min}) / m$.\n\n**Case 1: Narrow window ($WW_1 = 300$)**\nWith $WL=200$, the display window bounds are:\n$h_{lower,1} = 200 - 300/2 = 50$ HU.\n$h_{upper,1} = 200 + 300/2 = 350$ HU.\nThe display window is $(50, 350)$. The visible HU interval is the intersection of $(40, 1400)$ and $(50, 350)$, which is $(50, 350)$.\nThe visible transition width is:\n$$W_{\\text{vis}}(WW_1) = \\frac{350 - 50}{680} = \\frac{300}{680} = \\frac{15}{34} \\text{ pixels}$$\n\n**Case 2: Wide window ($WW_2 = 1200$)**\nWith $WL=200$, the display window bounds are:\n$h_{lower,2} = 200 - 1200/2 = -400$ HU.\n$h_{upper,2} = 200 + 1200/2 = 800$ HU.\nThe display window is $(-400, 800)$. The visible HU interval is the intersection of $(40, 1400)$ and $(-400, 800)$, which is $(40, 800)$.\nThe visible transition width is:\n$$W_{\\text{vis}}(WW_2) = \\frac{800 - 40}{680} = \\frac{760}{680} = \\frac{19}{17} \\text{ pixels}$$\n\n**Ratio Calculation**\nThe ratio $R$ is:\n$$R = \\frac{W_{\\text{vis}}(WW_1)}{W_{\\text{vis}}(WW_2)} = \\frac{15/34}{19/17} = \\frac{15}{34} \\times \\frac{17}{19} = \\frac{15}{2 \\times 17} \\times \\frac{17}{19} = \\frac{15}{2 \\times 19} = \\frac{15}{38}$$\nAs a decimal rounded to three significant figures:\n$$R = \\frac{15}{38} \\approx 0.3947368...$$\n$$R \\approx 0.395$$", "answer": "$$\\boxed{0.395}$$", "id": "4873184"}]}