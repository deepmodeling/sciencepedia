{"hands_on_practices": [{"introduction": "Balanced SSFP imaging is known for its high signal-to-noise ratio, but it is also highly sensitive to off-resonance effects, leading to characteristic 'banding' artifacts. This first practice challenges you to derive the fundamental relationship between the sequence repetition time ($T_R$) and the frequency spacing of these signal nulls. Mastering this calculation is the first step toward understanding and controlling one of the most important behaviors of bSSFP sequences. [@problem_id:4928331]", "problem": "A Balanced Steady-State Free Precession (bSSFP) magnetic resonance imaging sequence uses fully balanced gradients within each repetition time so that net gradient moment per repetition is zero. Consider a single isochromat in the rotating frame with longitudinal relaxation time $T_1$, transverse relaxation time $T_2$, repetition time $T_R$, flip angle $\\alpha$, and off-resonance frequency $f$ (in Hz). Over each $T_R$, the isochromat accrues an off-resonance phase $\\,\\Delta \\phi = 2\\pi f T_R\\,$ due solely to $f$ because the gradients are balanced.\n\nStarting from the Bloch equation in the rotating frame and the fact that balanced gradients produce a time-symmetric refocusing at echo time $T_R/2$, reason from first principles about the coherence pathways to derive an analytic expression for the frequency spacing between successive magnitude nulls of the steady-state transverse signal in bSSFP as a function of $T_R$. Then, using your expression, compute the spacing in Hz when $T_R = 3.0$ ms. Express the frequency spacing in Hz and round your numerical answer to three significant figures.", "solution": "The problem requires the derivation of the frequency spacing between successive magnitude nulls in a Balanced Steady-State Free Precession (bSSFP) signal as a function of the repetition time $T_R$, and then a numerical calculation for a given $T_R$.\n\nThe foundation of the bSSFP sequence is the establishment of a dynamic equilibrium, or steady state, for the magnetization. In this state, the magnetization vector at the beginning of any given repetition time ($T_R$) interval is identical to the vector at the beginning of any other $T_R$ interval, except for a phase shift in the transverse plane.\n\nLet's analyze the evolution of a single isochromat with an off-resonance frequency $f$. In the rotating frame, this off-resonance causes the magnetization vector to precess at an angular frequency of $\\omega = 2\\pi f$. Over the course of one repetition time, $T_R$, the total phase accrued by the transverse component of the magnetization due to this off-resonance is $\\Delta \\phi = \\omega T_R = 2\\pi f T_R$. The problem statement correctly notes that because the imaging gradients are fully balanced, their net contribution to the phase over one $T_R$ is zero. Therefore, the only source of net phase accumulation from one $T_R$ to the next is the off-resonance $f$.\n\nThe steady-state signal in bSSFP is a function of the tissue parameters ($T_1$, $T_2$), the sequence parameters ($\\alpha$, $T_R$), and the off-resonance phase $\\Delta\\phi$. The signal arises from the coherent sum of multiple coherence pathways. At the echo time, which is $T_R/2$ due to the time-symmetric refocusing nature of the sequence, components of the transverse magnetization from many previous $T_R$ intervals contribute to the measured signal.\n\nThe crucial insight is that the entire system is driven by a periodic train of radiofrequency (RF) pulses. Consequently, the steady-state response of the magnetization must be periodic with respect to the off-resonance phase $\\Delta\\phi$. Any physical state of the magnetization, and thus the signal magnitude $|S|$, must be identical if the phase $\\Delta\\phi$ is shifted by an integer multiple of $2\\pi$. That is, $|S(\\Delta\\phi)| = |S(\\Delta\\phi + 2\\pi n)|$ for any integer $n$. This establishes that the frequency response profile of the bSSFP signal is periodic.\n\nThe bSSFP signal profile exhibits bands of high signal separated by signal nulls. A signal null represents a condition of maximum destructive interference among the contributing coherence pathways. For a sequence with a constant RF pulse phase (as is implied by the problem's lack of specified phase cycling), the condition for maximum constructive interference occurs at on-resonance, where $f=0$ and thus $\\Delta\\phi=0$. This creates the center of the primary signal passband.\n\nAs the off-resonance frequency $f$ increases, the phase $\\Delta\\phi$ increases, and the contributing signal components become increasingly dephased. The first instance of maximum destructive interference, a signal null, occurs when the phase accumulated over one $T_R$ is an odd multiple of $\\pi$. Specifically, the first null occurs at $\\Delta\\phi = \\pi$. Subsequent nulls appear each time the phase increases by another $2\\pi$ from a previous null's position. In general, the signal nulls are located at off-resonance frequencies $f_{null}$ that satisfy the condition:\n$$ \\Delta\\phi = 2\\pi f_{null} T_R = (2n+1)\\pi $$\nwhere $n$ is an integer. Solving for $f_{null}$ gives the frequencies of the nulls:\n$$ f_{null, n} = \\frac{2n+1}{2T_R} $$\n\nTo find the frequency spacing between successive nulls, we calculate the difference between the frequencies of the $(n+1)$-th null and the $n$-th null. Let this spacing be denoted by $\\Delta f_{spacing}$.\n$$ \\Delta f_{spacing} = f_{null, n+1} - f_{null, n} $$\nSubstituting the expression for $f_{null}$:\n$$ \\Delta f_{spacing} = \\frac{2(n+1)+1}{2T_R} - \\frac{2n+1}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{(2n+2+1) - (2n+1)}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{2n+3 - 2n-1}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{2}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{1}{T_R} $$\nThis is the analytic expression for the frequency spacing between successive magnitude nulls. It depends solely on the repetition time $T_R$, and not on the tissue parameters $T_1$, $T_2$, or the flip angle $\\alpha$. These other parameters affect the amplitude and width of the signal passband, but not the fundamental periodicity of the nulls.\n\nNow, we compute the numerical value of this spacing for the given $T_R$.\nThe repetition time is given as $T_R = 3.0$ ms. We must convert this to SI units (seconds) for the frequency to be in Hertz (Hz).\n$$ T_R = 3.0 \\, \\text{ms} = 3.0 \\times 10^{-3} \\, \\text{s} $$\nUsing the derived expression for the spacing:\n$$ \\Delta f_{spacing} = \\frac{1}{T_R} = \\frac{1}{3.0 \\times 10^{-3} \\, \\text{s}} $$\n$$ \\Delta f_{spacing} = \\frac{1000}{3.0} \\, \\text{Hz} \\approx 333.333... \\, \\text{Hz} $$\nThe problem requires the answer to be rounded to three significant figures.\n$$ \\Delta f_{spacing} \\approx 333 \\, \\text{Hz} $$", "answer": "$$\\boxed{333}$$", "id": "4928331"}, {"introduction": "Off-resonance is not just an external imperfection; it also arises from the intrinsic chemical properties of tissues, such as the chemical shift between water and fat. This exercise builds on the concept of phase accumulation to determine a specific repetition time ($T_R$) that places water and fat signals in direct opposition. This principle is fundamental to understanding chemical shift artifacts in bSSFP and is a key concept behind techniques that exploit this effect for fat suppression or quantification. [@problem_id:4928302]", "problem": "You are analyzing a balanced Steady-State Free Precession (bSSFP) magnetic resonance imaging sequence with repetition time $\\mathrm{TR}$ on a system operating at static field $B_0$. In bSSFP, all gradient moments over one repetition interval are balanced so that any transverse dephasing due to gradients is nulled across each $\\mathrm{TR}$. Consider two spin species, water and the main lipid peak (fat), whose resonance frequencies differ by a chemical shift $\\Delta f_{\\mathrm{cs}}$ relative to one another. The chemical shift is specified in parts per million (ppm) with respect to the on-resonance Larmor frequency $f_0$ of water, so that $\\Delta f_{\\mathrm{cs}} = \\delta \\times 10^{-6} f_0$, where $\\delta$ is the chemical shift in ppm and $f_0$ is the Larmor frequency in hertz. Assume $f_0 = \\left(\\frac{\\gamma}{2\\pi}\\right) B_0$, where $\\frac{\\gamma}{2\\pi}$ is the proton gyromagnetic ratio in hertz per tesla. Work in radians for all phase angles.\n\nStarting from the Larmor precession of transverse magnetization and the definition of chemical shift, derive the condition on $\\mathrm{TR}$ such that water and the main fat peak are exactly $180^\\circ$ out of phase at the time of each subsequent radiofrequency pulse in steady state. Then, using $\\delta \\approx 3.5$ ppm and $\\frac{\\gamma}{2\\pi} \\approx 42.577 \\times 10^{6}$ hertz per tesla, compute the corresponding $\\mathrm{TR}$ for $B_0 = 1.5$ tesla and $B_0 = 3.0$ tesla.\n\nExpress your final numerical results for $\\mathrm{TR}$ in milliseconds and round them to three significant figures.", "solution": "The user wants to derive the condition on the repetition time $\\mathrm{TR}$ for a balanced Steady-State Free Precession (bSSFP) sequence such that water and fat spins are $180^\\circ$ out of phase at the time of each radiofrequency (RF) pulse. This phase difference arises from their different Larmor precession frequencies due to chemical shift.\n\nFirst, we formalize the problem by stating the givens and validating the premises.\n\nThe problem provides:\n- Sequence type: Balanced Steady-State Free Precession (bSSFP)\n- Repetition time: $\\mathrm{TR}$\n- Static magnetic field: $B_0$\n- Spin species: Water and fat\n- Chemical shift frequency difference between fat and water: $\\Delta f_{\\mathrm{cs}}$\n- Definition of chemical shift: $\\Delta f_{\\mathrm{cs}} = \\delta \\times 10^{-6} f_0$, where $\\delta$ is the chemical shift in parts per million (ppm) and $f_0$ is the water Larmor frequency.\n- Definition of Larmor frequency: $f_0 = \\left(\\frac{\\gamma}{2\\pi}\\right) B_0$\n- Proton gyromagnetic ratio: $\\frac{\\gamma}{2\\pi} \\approx 42.577 \\times 10^{6}$ hertz per tesla (Hz/T)\n- Chemical shift value: $\\delta \\approx 3.5$ ppm\n- Field strengths for calculation: $B_0 = 1.5$ T and $B_0 = 3.0$ T\n- Condition: Water and fat are to be $180^\\circ$ out of phase at each RF pulse.\n- Output format: $\\mathrm{TR}$ in milliseconds (ms), rounded to three significant figures.\n\nThe problem is scientifically grounded in the principles of nuclear magnetic resonance (NMR) and magnetic resonance imaging (MRI). The concepts of Larmor precession, chemical shift, and pulse sequence timing are fundamental to the field. The provided physical constants and parameters are standard and realistic. The problem is well-posed, objective, and contains sufficient information for a unique solution. Therefore, the problem is valid.\n\nWe proceed with the derivation.\n\nThe angular frequency of precession (Larmor frequency) of a spin in a magnetic field $B_0$ is given by $\\omega = \\gamma B_0$. In terms of linear frequency $f$, this is $\\omega = 2\\pi f$, so $f = \\frac{\\gamma}{2\\pi} B_0$. Due to chemical shift, different molecular environments (like water and fat) experience slightly different effective magnetic fields, leading to different Larmor frequencies.\n\nLet the Larmor frequency of water be $f_0$. The Larmor frequency of fat, $f_{\\mathrm{fat}}$, is shifted relative to water by $\\Delta f_{\\mathrm{cs}}$.\nThe frequency difference is given by:\n$$ \\Delta f = |f_{\\mathrm{fat}} - f_0| = |\\Delta f_{\\mathrm{cs}}| $$\nUsing the provided definitions:\n$$ \\Delta f = |\\delta| \\times 10^{-6} \\times f_0 = |\\delta| \\times 10^{-6} \\times \\left(\\frac{\\gamma}{2\\pi}\\right) B_0 $$\n\nOver a time interval $\\Delta t$, a spin precessing at a frequency $f$ accumulates a phase $\\phi = 2\\pi f \\Delta t$ radians relative to a stationary axis in the transverse plane. In an MRI sequence, we are interested in the phase evolution over the repetition time, $\\mathrm{TR}$.\n\nThe phase accumulated by water spins in one $\\mathrm{TR}$ is $\\phi_{\\mathrm{water}} = 2\\pi f_0 \\mathrm{TR}$.\nThe phase accumulated by fat spins in one $\\mathrm{TR}$ is $\\phi_{\\mathrm{fat}} = 2\\pi f_{\\mathrm{fat}} \\mathrm{TR}$.\n\nThe phase difference, $\\Delta\\phi$, that accumulates between fat and water over one interval $\\mathrm{TR}$ is:\n$$ \\Delta\\phi = \\phi_{\\mathrm{fat}} - \\phi_{\\mathrm{water}} = 2\\pi (f_{\\mathrm{fat}} - f_0) \\mathrm{TR} = 2\\pi \\Delta f_{\\mathrm{cs}} \\mathrm{TR} $$\nThe magnitude of this phase difference is:\n$$ |\\Delta\\phi| = 2\\pi \\Delta f \\mathrm{TR} $$\n\nThe problem requires that water and fat be $180^\\circ$ out of phase. In radians, $180^\\circ$ corresponds to $\\pi$ radians. For the two species' magnetization vectors to be anti-parallel (out of phase), their phase difference must be an odd integer multiple of $\\pi$.\n$$ |\\Delta\\phi| = (2k+1)\\pi, \\quad k \\in \\{0, 1, 2, \\dots\\} $$\nHere, $k$ is a non-negative integer.\n\nEquating the two expressions for the phase difference magnitude:\n$$ 2\\pi \\Delta f \\mathrm{TR} = (2k+1)\\pi $$\nSolving for $\\mathrm{TR}$, we get the general condition:\n$$ \\mathrm{TR} = \\frac{2k+1}{2 \\Delta f} $$\nTypically, the shortest possible $\\mathrm{TR}$ that satisfies this condition is desired, which corresponds to choosing $k=0$. This gives the specific condition for the first out-of-phase time point:\n$$ \\mathrm{TR}_{\\mathrm{out-of-phase}} = \\frac{1}{2 \\Delta f} $$\nIn a bSSFP sequence, the phase relationship between species at steady state is determined by the phase evolution during the $\\mathrm{TR}$ interval. Setting $\\mathrm{TR}$ according to this condition ensures that fat and water signals are maximally opposed at the time of echo formation (which aligns with the RF pulse timing in bSSFP).\n\nNow, we substitute the expression for $\\Delta f$:\n$$ \\mathrm{TR} = \\frac{1}{2 \\left( |\\delta| \\times 10^{-6} \\times \\left(\\frac{\\gamma}{2\\pi}\\right) B_0 \\right)} $$\n\nWe can now compute the numerical values for the given field strengths. We use the provided constants: $\\delta = 3.5$ and $\\frac{\\gamma}{2\\pi} = 42.577 \\times 10^{6} \\, \\text{Hz/T}$.\n\nCase 1: $B_0 = 1.5$ T\nFirst, calculate the chemical shift frequency difference $\\Delta f_{1.5}$:\n$$ \\Delta f_{1.5} = 3.5 \\times 10^{-6} \\times (42.577 \\times 10^{6} \\, \\text{Hz/T}) \\times 1.5 \\, \\text{T} $$\n$$ \\Delta f_{1.5} = 3.5 \\times 42.577 \\times 1.5 \\, \\text{Hz} \\approx 223.529 \\, \\text{Hz} $$\nNow, calculate the required $\\mathrm{TR}$:\n$$ \\mathrm{TR}_{1.5} = \\frac{1}{2 \\times \\Delta f_{1.5}} = \\frac{1}{2 \\times 223.529} \\, \\text{s} \\approx 0.0022368 \\, \\text{s} $$\nThe problem requires the answer in milliseconds (ms), so we multiply by $1000$:\n$$ \\mathrm{TR}_{1.5} \\approx 2.2368 \\, \\text{ms} $$\nRounding to three significant figures, we get:\n$$ \\mathrm{TR}_{1.5} \\approx 2.24 \\, \\text{ms} $$\n\nCase 2: $B_0 = 3.0$ T\nThe field strength is doubled compared to the first case. Since $\\Delta f$ is directly proportional to $B_0$, the frequency difference will also be doubled.\n$$ \\Delta f_{3.0} = 3.5 \\times 10^{-6} \\times (42.577 \\times 10^{6} \\, \\text{Hz/T}) \\times 3.0 \\, \\text{T} $$\n$$ \\Delta f_{3.0} = 3.5 \\times 42.577 \\times 3.0 \\, \\text{Hz} \\approx 447.058 \\, \\text{Hz} $$\nThis is indeed $2 \\times \\Delta f_{1.5}$.\nNow, calculate the required $\\mathrm{TR}$:\n$$ \\mathrm{TR}_{3.0} = \\frac{1}{2 \\times \\Delta f_{3.0}} = \\frac{1}{2 \\times 447.058} \\, \\text{s} \\approx 0.0011184 \\, \\text{s} $$\nIn milliseconds:\n$$ \\mathrm{TR}_{3.0} \\approx 1.1184 \\, \\text{ms} $$\nRounding to three significant figures, we get:\n$$ \\mathrm{TR}_{3.0} \\approx 1.12 \\, \\text{ms} $$\n\nThe results show that as the main magnetic field strength $B_0$ increases, the chemical shift frequency difference $\\Delta f$ increases, and consequently, the repetition time $\\mathrm{TR}$ required to achieve a specific phase difference (in this case, out-of-phase) decreases.", "answer": "$$\n\\boxed{\\begin{pmatrix} 2.24  1.12 \\end{pmatrix}}\n$$", "id": "4928302"}, {"introduction": "While analytical solutions provide deep insight, the full behavior of the bSSFP signal across its vast parameter space is best explored through computation. This hands-on coding exercise tasks you with implementing the complete Bloch equation model for the bSSFP steady state. By building a numerical solver, you will gain a powerful tool to visualize and understand the complex interplay of tissue properties and sequence parameters that governs bSSFP's unique contrast. [@problem_id:4928374]", "problem": "Implement a program that, starting from the Bloch equation model, computes the complex steady-state transverse magnetization $M_{xy,\\infty}$ for a fully balanced Steady-State Free Precession (SSFP) sequence, also known as balanced Steady-State Free Precession (bSSFP), normalized by the equilibrium longitudinal magnetization $M_0$. The computation must be based on first principles using the following modeling assumptions and definitions.\n\nYou must model the magnetization vector $M = [M_x,M_y,M_z]^\\top$ in the rotating frame under the Bloch equations with relaxation, where the longitudinal and transverse relaxations are characterized by time constants $T_1$ and $T_2$, respectively. Over a repetition time $TR$, relaxation is represented by the diagonal matrix $E = \\mathrm{diag}(E_2,E_2,E_1)$ with $E_1 = \\exp(-TR/T_1)$ and $E_2 = \\exp(-TR/T_2)$, and the equilibrium magnetization vector is $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$. The net off-resonance phase accrual per repetition is represented as a rotation about the $z$-axis by angle $\\phi$ using a rotation matrix $R_z(\\phi)$, and the radiofrequency (RF) pulse is modeled as an instantaneous rotation about the $x$-axis by the flip angle $\\alpha$ using $R_x(\\alpha)$. Use right-handed rotations with the standard definitions\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1  0  0\\\\\n0  \\cos\\alpha  -\\sin\\alpha\\\\\n0  \\sin\\alpha  \\cos\\alpha\n\\end{bmatrix},\\quad\nR_z(\\phi) =\n\\begin{bmatrix}\n\\cos\\phi  -\\sin\\phi  0\\\\\n\\sin\\phi  \\cos\\phi  0\\\\\n0  0  1\n\\end{bmatrix}.\n$$\n\nLet $M_n^-$ denote the magnetization immediately before the $n$-th RF pulse and $M_n^+$ the magnetization immediately after that RF pulse. In a steady-state, the magnetization becomes time-invariant across repetitions. Derive from the Bloch equations and these rotations an appropriate discrete-time affine mapping across one repetition, solve for the steady-state fixed point $M_\\infty^-$, then compute $M_\\infty^+ = R_x(\\alpha) M_\\infty^-$. Report the complex steady-state signal as\n$$\nM_{xy,\\infty} \\equiv M_x^+ + i\\,M_y^+,\n$$\nnormalized by $M_0$ (that is, set $M_0 = 1$ without loss of generality).\n\nAngle units and time units must be respected as follows:\n- Flip angle $\\alpha$ must be provided in degrees and converted to radians internally.\n- Off-resonance phase $\\phi$ must be provided and used in radians.\n- All relaxation times $T_1$, $T_2$, and the repetition time $TR$ must be provided in milliseconds, and the exponential decays must use these values consistently so that $TR/T_1$ and $TR/T_2$ are dimensionless.\n\nYour program must implement a general solver based on the above physics and then evaluate $M_{xy,\\infty}/M_0$ for the following test suite of parameter sets (each tuple is $(T_1\\ \\mathrm{ms}, T_2\\ \\mathrm{ms}, TR\\ \\mathrm{ms}, \\alpha\\ \\mathrm{deg}, \\phi\\ \\mathrm{rad})$):\n- Case A (general bSSFP working point): $(1200, 40, 3.5, 65, \\pi/2)$.\n- Case B (boundary, no excitation): $(1000, 80, 4.0, 0, 0)$.\n- Case C (long $T_2$ with small flip, on-resonance): $(1000, 200, 4.0, 30, 0)$.\n- Case D (very short $T_2$ with large flip, band edge): $(1200, 10, 5.0, 90, \\pi)$.\n- Case E (moderate relaxation, band edge): $(800, 80, 3.0, 50, \\pi)$.\n\nRequirements for numerical output:\n- For each case, output the real and imaginary parts of $M_{xy,\\infty}/M_0$ as two floating-point numbers.\n- Round each floating-point number to $6$ decimal places.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order $[\\Re(M_{xy,\\infty}^{(A)}), \\Im(M_{xy,\\infty}^{(A)}), \\Re(M_{xy,\\infty}^{(B)}), \\Im(M_{xy,\\infty}^{(B)}), \\dots]$ for Cases A through E.\n\nExpress all angles internally in radians and ensure dimensional consistency when computing exponentials. No user input is required; the program must hard-code the above test suite and print the results for all cases in a single line as specified.", "solution": "We begin from the Bloch equations in the rotating frame with relaxation,\n$$\n\\frac{d}{dt}\n\\begin{bmatrix}\nM_x\\\\\nM_y\\\\\nM_z\n\\end{bmatrix}\n=\n\\gamma\n\\begin{bmatrix}\nM_y B_z - M_z B_y\\\\\nM_z B_x - M_x B_z\\\\\nM_x B_y - M_y B_x\n\\end{bmatrix}\n-\n\\begin{bmatrix}\n\\frac{M_x}{T_2} \\\\\n\\frac{M_y}{T_2} \\\\\n\\frac{M_z - M_0}{T_1}\n\\end{bmatrix},\n$$\nwhere $\\gamma$ is the gyromagnetic ratio and $M_0$ is the equilibrium longitudinal magnetization (aligned with the $z$-axis). For a fully balanced Steady-State Free Precession (SSFP) sequence (balanced SSFP, or bSSFP), the gradient moments are zero over each repetition time $TR$, and any static off-resonance produces a net phase accrual $\\phi$ per repetition as a rotation about the $z$-axis. The radiofrequency (RF) pulse is modeled as an instantaneous rotation of the magnetization about the $x$-axis by the flip angle $\\alpha$.\n\nOver a finite time interval $TR$ in the absence of RF, the Bloch equation solution can be decomposed into a rotation about $z$ by $\\phi$ together with exponential relaxation. Introducing the relaxation matrix\n$$\nE = \\mathrm{diag}(E_2,E_2,E_1),\\quad E_1 = e^{-TR/T_1},\\quad E_2 = e^{-TR/T_2},\n$$\nand the equilibrium vector $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$, the free evolution over $TR$ maps an initial magnetization $M$ to\n$$\nM \\mapsto R_z(\\phi)\\,E\\,M + \\left(I - E\\right) M_{\\mathrm{eq}},\n$$\nwhere $R_z(\\phi)$ is the right-handed rotation about the $z$-axis by angle $\\phi$. The instantaneous RF pulse maps $M^- \\mapsto M^+ = R_x(\\alpha) M^-$, where $R_x(\\alpha)$ is the right-handed rotation about the $x$-axis by flip angle $\\alpha$. Using the standard rotation matrices\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1  0  0\\\\\n0  \\cos\\alpha  -\\sin\\alpha\\\\\n0  \\sin\\alpha  \\cos\\alpha\n\\end{bmatrix},\\quad\nR_z(\\phi) =\n\\begin{bmatrix}\n\\cos\\phi  -\\sin\\phi  0\\\\\n\\sin\\phi  \\cos\\phi  0\\\\\n0  0  1\n\\end{bmatrix},\n$$\nwe can write the discrete-time evolution across one repetition as follows. Let $M_n^-$ denote magnetization immediately before the $n$-th RF pulse, and $M_n^+$ immediately after it. Then\n$$\nM_n^+ = R_x(\\alpha)\\,M_n^-,\n$$\nand after free evolution through $TR$ with off-resonance and relaxation,\n$$\nM_{n+1}^- = R_z(\\phi)\\,E\\,M_n^+ + \\left(I - E\\right) M_{\\mathrm{eq}}.\n$$\nEliminating $M_n^+$, we obtain an affine recursion on $M_n^-$:\n$$\nM_{n+1}^- = \\underbrace{R_z(\\phi)\\,E\\,R_x(\\alpha)}_{A}\\, M_n^- + \\underbrace{\\left(I - E\\right) M_{\\mathrm{eq}}}_{c}.\n$$\nIn steady state, the magnetization is time-invariant, so $M_{n+1}^- = M_n^- = M_\\infty^-$. Therefore $M_\\infty^-$ satisfies the linear system\n$$\n\\left(I - A\\right) M_\\infty^- = c.\n$$\nProvided $I - A$ is nonsingular (which holds in practice for $E_1  1$ and $E_2  1$), the unique steady-state solution is\n$$\nM_\\infty^- = \\left(I - R_z(\\phi)\\,E\\,R_x(\\alpha)\\right)^{-1} \\left(I - E\\right) M_{\\mathrm{eq}}.\n$$\nThe magnetization immediately after the RF pulse is\n$$\nM_\\infty^+ = R_x(\\alpha) M_\\infty^-.\n$$\nThe complex transverse steady-state signal is then defined as\n$$\nM_{xy,\\infty} \\equiv M_x^+ + i\\,M_y^+.\n$$\n\nNormalization by $M_0$ is straightforward because the system is linear in $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$. Setting $M_0 = 1$ yields $M_{xy,\\infty}/M_0$ directly. Angles must be handled consistently: convert the flip angle $\\alpha$ from degrees to radians as $\\alpha_{\\mathrm{rad}} = \\alpha_{\\mathrm{deg}} \\cdot \\pi/180$, and use the provided $\\phi$ in radians. Relaxation times $T_1$, $T_2$, and the repetition time $TR$ are provided in milliseconds and must be used consistently so that $TR/T_1$ and $TR/T_2$ are dimensionless within the exponentials defining $E_1$ and $E_2$.\n\nAlgorithmic steps to compute $M_{xy,\\infty}/M_0$ for any given $(T_1, T_2, TR, \\alpha, \\phi)$:\n1. Set $M_0 = 1$ and form $M_{\\mathrm{eq}} = [0,0,1]^\\top$.\n2. Convert $\\alpha$ from degrees to radians and take $\\phi$ as given in radians.\n3. Compute $E_1 = \\exp(-TR/T_1)$ and $E_2 = \\exp(-TR/T_2)$ using the times in milliseconds.\n4. Form the matrices $E = \\mathrm{diag}(E_2,E_2,E_1)$, $R_x(\\alpha)$, and $R_z(\\phi)$.\n5. Form $A = R_z(\\phi)\\,E\\,R_x(\\alpha)$ and $c = (I - E) M_{\\mathrm{eq}}$.\n6. Solve the linear system $(I - A) M_\\infty^- = c$ for $M_\\infty^-$ using a numerically stable solver (avoid explicit matrix inversion).\n7. Compute $M_\\infty^+ = R_x(\\alpha) M_\\infty^-$.\n8. Form $M_{xy,\\infty} = M_x^+ + i\\,M_y^+$.\n9. Output $\\Re(M_{xy,\\infty})$ and $\\Im(M_{xy,\\infty})$ as floats rounded to $6$ decimal places.\n\nConsistency checks and edge cases:\n- For $\\alpha = 0$ (Case B), $R_x(\\alpha) = I$, and the steady-state must remain aligned with $z$; hence $M_{xy,\\infty} = 0 + i\\,0$. The formulation above reproduces this, providing a boundary validation.\n- For very short $T_2$ (Case D), $E_2$ is small, strongly attenuating transverse components, so $|M_{xy,\\infty}|$ should be small.\n- At band edges (e.g., $\\phi = \\pi$), the phase of $M_{xy,\\infty}$ changes characteristically; the rotation matrix formulation captures this behavior.\n\nThe program implements this solver and evaluates the specified test suite, printing a single line in the exact required format:\n$[\\Re(M_{xy,\\infty}^{(A)}), \\Im(M_{xy,\\infty}^{(A)}), \\Re(M_{xy,\\infty}^{(B)}), \\Im(M_{xy,\\infty}^{(B)}), \\Re(M_{xy,\\infty}^{(C)}), \\Im(M_{xy,\\infty}^{(C)}), \\Re(M_{xy,\\infty}^{(D)}), \\Im(M_{xy,\\infty}^{(D)}), \\Re(M_{xy,\\infty}^{(E)}), \\Im(M_{xy,\\infty}^{(E)})]$, with each float rounded to $6$ decimal places.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef rotation_x(alpha_rad: float) - np.ndarray:\n    ca = np.cos(alpha_rad)\n    sa = np.sin(alpha_rad)\n    return np.array([[1.0, 0.0, 0.0],\n                     [0.0, ca,  -sa],\n                     [0.0, sa,   ca]], dtype=float)\n\ndef rotation_z(phi_rad: float) - np.ndarray:\n    cp = np.cos(phi_rad)\n    sp = np.sin(phi_rad)\n    return np.array([[cp, -sp, 0.0],\n                     [sp,  cp, 0.0],\n                     [0.0, 0.0, 1.0]], dtype=float)\n\ndef ssfp_steady_state_Mxy(T1_ms: float, T2_ms: float, TR_ms: float,\n                          alpha_deg: float, phi_rad: float) - complex:\n    # Normalize M0 = 1 (results scale linearly with M0)\n    Meq = np.array([0.0, 0.0, 1.0], dtype=float)\n\n    # Convert units\n    alpha_rad = np.deg2rad(alpha_deg)  # degrees to radians\n\n    # Relaxation factors (times in ms consistently)\n    E1 = np.exp(-TR_ms / T1_ms)\n    E2 = np.exp(-TR_ms / T2_ms)\n\n    # Matrices\n    E = np.diag([E2, E2, E1])\n    Rx = rotation_x(alpha_rad)\n    Rz = rotation_z(phi_rad)\n\n    I = np.eye(3, dtype=float)\n    A = Rz @ E @ Rx\n    c = (I - E) @ Meq\n\n    # Solve (I - A) M_minus = c\n    M_minus = np.linalg.solve(I - A, c)\n\n    # Magnetization immediately after RF\n    M_plus = Rx @ M_minus\n\n    # Complex transverse signal\n    Mxy = M_plus[0] + 1j * M_plus[1]\n    return Mxy\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple: (T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad)\n    test_cases = [\n        (1200.0,  40.0, 3.5, 65.0, np.pi/2),  # Case A\n        (1000.0,  80.0, 4.0,  0.0, 0.0),      # Case B\n        (1000.0, 200.0, 4.0, 30.0, 0.0),      # Case C\n        (1200.0,  10.0, 5.0, 90.0, np.pi),    # Case D\n        (800.0,   80.0, 3.0, 50.0, np.pi),    # Case E\n    ]\n\n    # Compute results and format to 6 decimal places\n    formatted_results = []\n    for case in test_cases:\n        T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad = case\n        Mxy = ssfp_steady_state_Mxy(T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad)\n        re = f\"{Mxy.real:.6f}\"\n        im = f\"{Mxy.imag:.6f}\"\n        formatted_results.append(re)\n        formatted_results.append(im)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4928374"}]}