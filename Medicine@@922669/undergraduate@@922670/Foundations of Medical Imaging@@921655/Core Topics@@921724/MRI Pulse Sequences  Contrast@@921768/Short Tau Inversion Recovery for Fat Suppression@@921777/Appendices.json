{"hands_on_practices": [{"introduction": "This first exercise lays the groundwork for understanding Short Tau Inversion Recovery (STIR) at its most fundamental level. By solving the Bloch equation that governs longitudinal magnetization recovery after a perfect $180^{\\circ}$ inversion pulse, you will derive the classic formula for the inversion time ($TI$) required to null the signal from fat. This practice [@problem_id:4922663] is the cornerstone for all further exploration of STIR sequences and connects the underlying physics to a critical imaging parameter.", "problem": "A Short Tau Inversion Recovery (STIR) sequence is used in magnetic resonance imaging to suppress the signal from fat by timing the readout at the instant when the longitudinal magnetization of fat crosses zero. Consider a perfectly adiabatic inversion pulse of flip angle $180^{\\circ}$ followed by a delay $TI$ before the excitation and readout. Assume a long repetition time so that $TR \\gg T_{1,\\text{fat}}$, and neglect transverse relaxation and readout effects during $TI$. Use the longitudinal component of the Bloch equation, written as the first-order linear differential equation $dM_{z}(t)/dt = \\left(M_{0} - M_{z}(t)\\right)/T_{1}$, together with the initial condition immediately after the inversion pulse $M_{z}(0^{+}) = -M_{0}$, to derive the condition on $TI$ that nulls fat magnetization.\n\nEvaluate the ideal inversion time $TI_{\\text{ideal}}$ for fat with longitudinal relaxation time $T_{1,\\text{fat}} = 370$ ms at $3$ T. Express your final numerical answer in ms and round to three significant figures.\n\nIn addition, briefly explain, based on physical and empirical considerations grounded in the same longitudinal recovery model, why in practice radiologists often use slightly shorter $TI$ values than the calculated ideal value, even at the same field strength and temperature. Your explanation will not be graded numerically, but it should be consistent with the underlying physics.", "solution": "The problem asks for the derivation of the ideal inversion time ($TI$) for a Short Tau Inversion Recovery (STIR) sequence, its numerical calculation for fat tissue, and an explanation for a common clinical practice. The validation of the problem statement confirms that it is scientifically grounded, well-posed, and objective. The provided physical model and parameters are consistent with the principles of magnetic resonance imaging.\n\nThe time evolution of the longitudinal magnetization, $M_z(t)$, following an event that perturbs it from its thermal equilibrium value, $M_0$, is described by the longitudinal component of the Bloch equation. The problem provides this as a first-order linear ordinary differential equation:\n$$\n\\frac{dM_{z}(t)}{dt} = \\frac{M_{0} - M_{z}(t)}{T_{1}}\n$$\nHere, $T_1$ is the longitudinal (or spin-lattice) relaxation time constant for the tissue of interest. This equation describes the recovery of $M_z$ towards its equilibrium value $M_0$.\n\nThe STIR sequence begins with a $180^{\\circ}$ inversion pulse. Assuming the magnetization is at equilibrium ($M_z = M_0$) before the pulse, a perfect $180^{\\circ}$ pulse flips the magnetization vector such that immediately after the pulse, at time $t=0^{+}$, the longitudinal component is fully inverted. This gives the initial condition:\n$$\nM_{z}(0^{+}) = -M_{0}\n$$\nWe must solve the differential equation subject to this initial condition. The equation can be rearranged for integration by separation of variables:\n$$\n\\frac{dM_{z}}{M_{0} - M_{z}} = \\frac{dt}{T_{1}}\n$$\nIntegrating both sides yields:\n$$\n\\int \\frac{dM_{z}}{M_{0} - M_{z}} = \\int \\frac{dt}{T_{1}} \\\\\n-\\ln|M_{0} - M_{z}(t)| = \\frac{t}{T_{1}} + C'\n$$\nwhere $C'$ is the constant of integration. Exponentiating both sides gives:\n$$\n|M_{0} - M_{z}(t)| = \\exp\\left(-\\frac{t}{T_{1}} - C'\\right) = C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nwhere $C = e^{-C'}$. Since $M_z(t)$ starts at $-M_0$ and recovers towards $+M_0$, the quantity $M_0 - M_z(t)$ is always non-negative for $t \\ge 0$, so the absolute value can be removed.\n$$\nM_{0} - M_{z}(t) = C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nThe solution for $M_z(t)$ is:\n$$\nM_{z}(t) = M_{0} - C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nTo find the constant $C$, we apply the initial condition $M_{z}(0) = -M_{0}$:\n$$\n-M_{0} = M_{0} - C \\exp(0) = M_{0} - C\n$$\nSolving for $C$, we find $C = M_{0} - (-M_{0}) = 2M_{0}$. Substituting this back into the general solution gives the specific equation for longitudinal magnetization recovery following a perfect inversion:\n$$\nM_{z}(t) = M_{0}\\left(1 - 2\\exp\\left(-\\frac{t}{T_{1}}\\right)\\right)\n$$\nThe goal of STIR is to suppress the signal from a specific tissue (in this case, fat) by applying the subsequent excitation pulse at the exact moment its longitudinal magnetization is zero. This time is the inversion time, $TI$. We find this time by setting $M_{z}(TI) = 0$:\n$$\n0 = M_{0}\\left(1 - 2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right)\\right)\n$$\nSince the equilibrium magnetization $M_0$ is non-zero, the term in the parenthesis must be zero:\n$$\n1 - 2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = 0 \\\\\n2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = 1 \\\\\n\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = \\frac{1}{2}\n$$\nTo solve for $TI$, we take the natural logarithm of both sides:\n$$\n-\\frac{TI}{T_{1,\\text{fat}}} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)\n$$\nThis gives the expression for the ideal inversion time, $TI_{\\text{ideal}}$:\n$$\nTI_{\\text{ideal}} = T_{1,\\text{fat}} \\ln(2)\n$$\nThe problem specifies the longitudinal relaxation time for fat at a field strength of $3$ T as $T_{1,\\text{fat}} = 370$ ms. We can now calculate the numerical value for $TI_{\\text{ideal}}$:\n$$\nTI_{\\text{ideal}} = 370 \\, \\text{ms} \\times \\ln(2) \\approx 370 \\times 0.693147 \\approx 256.46459 \\, \\text{ms}\n$$\nRounding this result to three significant figures, as requested, we get:\n$$\nTI_{\\text{ideal}} = 256 \\, \\text{ms}\n$$\n\nThe second part of the problem asks for an explanation of why, in practice, radiologists often use a slightly shorter $TI$ than this calculated ideal value. The explanation must be grounded in the same physical model. The ideal calculation assumes a perfect $180^{\\circ}$ inversion pulse. In reality, imperfections in the radiofrequency ($B_1$) field lead to spatial variations in the flip angle, meaning that for much of the tissue volume, the flip angle $\\alpha$ may be less than $180^{\\circ}$.\n\nLet's analyze the effect of an imperfect flip angle $\\alpha  180^{\\circ}$ using the same longitudinal recovery model. The initial condition after the pulse becomes $M_{z}(0^{+}) = M_{0} \\cos(\\alpha)$. The integration constant $C$ in the general solution $M_{z}(t) = M_{0} - C \\exp(-t/T_{1})$ is now:\n$$\nM_{0} \\cos(\\alpha) = M_{0} - C \\implies C = M_{0}(1 - \\cos(\\alpha))\n$$\nThe recovery equation becomes:\n$$\nM_{z}(t) = M_{0}\\left(1 - (1 - \\cos(\\alpha))\\exp\\left(-\\frac{t}{T_{1}}\\right)\\right)\n$$\nSetting $M_{z}(TI) = 0$ to find the new nulling time:\n$$\n1 - (1 - \\cos(\\alpha))\\exp\\left(-\\frac{TI}{T_{1}}\\right) = 0 \\\\\n\\exp\\left(-\\frac{TI}{T_{1}}\\right) = \\frac{1}{1 - \\cos(\\alpha)} \\\\\nTI = T_{1} \\ln(1 - \\cos(\\alpha))\n$$\nFor a perfect pulse, $\\alpha = 180^{\\circ}$, so $\\cos(\\alpha) = -1$, and $TI = T_{1}\\ln(1 - (-1)) = T_{1}\\ln(2)$, which is our ideal case. For an imperfect pulse where $\\alpha  180^{\\circ}$ (but $\\alpha > 90^{\\circ}$ for inversion), we have $-1  \\cos(\\alpha)  0$. This means $1  1 - \\cos(\\alpha)  2$. Since $\\ln(x)$ is a monotonically increasing function for $x>0$, it follows that $\\ln(1 - \\cos(\\alpha))  \\ln(2)$. Consequently, the required inversion time for a non-ideal pulse is shorter than the ideal one: $TI  TI_{\\text{ideal}}$. Since practical STIR sequences must be robust to $B_1$ inhomogeneity, choosing a slightly shorter $TI$ provides a better average nulling effect across the imaging volume where flip angles are commonly less than the prescribed $180^{\\circ}$.\n\nAdditionally, biological fat is not a single substance with a single $T_1$ value, but a mixture of triglycerides with a distribution of $T_1$ values. Choosing a $TI$ slightly shorter than the ideal value for the average $T_1$ can result in more robust overall suppression of the signal from the entire distribution of fat components.", "answer": "$$\\boxed{256}$$", "id": "4922663"}, {"introduction": "Real-world MRI involves repeating sequences rapidly, which means the magnetization may not fully recover between repetitions, leading to a 'steady state'. This practice [@problem_id:4922633] moves beyond the simple ideal case to explore how STIR functions within a steady-state sequence. You will calculate the precise inversion time to null fat under these more realistic conditions and then evaluate the corresponding signal from water, providing a quantitative grasp of how STIR powerfully generates contrast between different tissues.", "problem": "A Short Tau Inversion Recovery (STIR) sequence in Magnetic Resonance Imaging (MRI) is used to suppress fat signal via an inversion pulse followed by an inversion time before excitation. Consider a STIR spin-echo sequence that repeats every repetition time $TR$, consisting of a perfect $180^{\\circ}$ inversion pulse at time $t=0$, free longitudinal relaxation for an inversion time $TI$, a perfect $90^{\\circ}$ excitation at $t=TI$ that instantaneously tips the longitudinal magnetization into the transverse plane (so the longitudinal component just after excitation is zero), and then free longitudinal relaxation until the next inversion at $t=TR$. Assume perfect spoiling of transverse components between pulses, negligible transverse relaxation effects on the longitudinal component, and that the system has reached a steady periodic state across repetitions.\n\nLet fat have longitudinal relaxation time $T_1^{\\mathrm{fat}}$ and water have longitudinal relaxation time $T_1^{\\mathrm{water}}$. Given $TR = 2500$ ms, $T_1^{\\mathrm{fat}} = 260$ ms, and $T_1^{\\mathrm{water}} = 1200$ ms, determine the longitudinal magnetization of water immediately before the $90^{\\circ}$ excitation, $M_z^{\\mathrm{water}}(TI)$, at the inversion time $TI$ that nulls fat in steady state. Express your final answer as a fraction of the water equilibrium magnetization $M_0^{\\mathrm{water}}$ (unitless), and round your answer to $4$ significant figures. Also briefly justify, in words, the expected contrast between water and fat under these conditions. Do not report $TI$ as your final answer; only report the requested fraction for water.", "solution": "The problem statement will first be validated against the required criteria.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n- Sequence type: Short Tau Inversion Recovery (STIR) spin-echo sequence.\n- Sequence timing: Repeats every repetition time, $TR$. A perfect $180^{\\circ}$ inversion pulse is applied at time $t=0$, followed by free longitudinal relaxation for an inversion time $TI$. A perfect $90^{\\circ}$ excitation occurs at $t=TI$. Free longitudinal relaxation then proceeds until the next inversion at $t=TR$.\n- Post-excitation state: The longitudinal component just after the $90^{\\circ}$ excitation is zero.\n- Assumptions: Perfect spoiling of transverse components, negligible transverse relaxation effects on longitudinal recovery, and the system is in a steady periodic state.\n- Repetition time: $TR = 2500$ ms.\n- Longitudinal relaxation time of fat: $T_1^{\\mathrm{fat}} = 260$ ms.\n- Longitudinal relaxation time of water: $T_1^{\\mathrm{water}} = 1200$ ms.\n- Objective: Determine the longitudinal magnetization of water immediately before the $90^{\\circ}$ excitation, $M_z^{\\mathrm{water}}(TI)$, at the specific $TI$ that nulls the fat signal.\n- Required output format: Express the answer as a unitless fraction of the water equilibrium magnetization $M_0^{\\mathrm{water}}$, rounded to $4$ significant figures.\n- Additional task: Briefly justify, in words, the expected contrast between water and fat.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientifically Grounded:** The problem is based on the fundamental principles of nuclear magnetic resonance (NMR) and its application in Magnetic Resonance Imaging (MRI). The Bloch equations, specifically for longitudinal relaxation, and the concept of a STIR pulse sequence are standard, well-established topics in medical physics. The given $T_1$ values for fat and water at clinical field strengths are realistic.\n- **Well-Posed:** The problem provides a clear objective and all necessary parameters ($TR$, $T_1$ values) and conditions (steady state, perfect pulses, fat nulling) to determine a unique solution for the requested quantity. The path to the solution is well-defined.\n- **Objective:** The problem is stated in precise, quantitative terms, free from any subjectivity or ambiguity.\n- **Completeness and Consistency:** The problem is self-contained. The provided data are dimensionally consistent (all times are in ms) and physically plausible for an MRI experiment. There are no contradictory constraints.\n\n**Step 3: Verdict and Action**\nThe problem is valid. It is scientifically sound, well-posed, objective, and complete. A solution will be provided.\n\n### Solution\n\nThe evolution of the longitudinal magnetization, $M_z$, following a perturbation, is described by the Bloch equation for longitudinal relaxation:\n$$ M_z(t) = M_0 + (M_z(0^+) - M_0)\\exp(-t/T_1) $$\nwhere $M_z(t)$ is the longitudinal magnetization at time $t$, $M_z(0^+)$ is the initial magnetization at $t=0^+$, $M_0$ is the equilibrium magnetization, and $T_1$ is the longitudinal relaxation time.\n\nWe are analyzing a STIR sequence in a steady periodic state. Let's trace the longitudinal magnetization of a generic tissue through one cycle, from $t=0$ to $t=TR$. Let $M_z(TR^-)$ be the magnetization just before the $180^{\\circ}$ inversion pulse at the end of a cycle.\n\n1.  At $t=0$, a perfect $180^{\\circ}$ pulse inverts the magnetization: $M_z(0^+) = -M_z(TR^-)$.\n\n2.  From $t=0$ to $t=TI$, the magnetization recovers for a duration of $TI$:\n    $$ M_z(TI^-) = M_0 + (M_z(0^+) - M_0)\\exp(-TI/T_1) = M_0 + (-M_z(TR^-) - M_0)\\exp(-TI/T_1) $$\n\n3.  At $t=TI$, a perfect $90^{\\circ}$ pulse is applied, which tips the longitudinal magnetization $M_z(TI^-)$ into the transverse plane. The signal acquired is proportional to the magnitude of $M_z(TI^-)$. Immediately after this pulse, the longitudinal magnetization is zero: $M_z(TI^+) = 0$.\n\n4.  From $t=TI$ to $t=TR$, the magnetization recovers from zero for a duration of $TR-TI$:\n    $$ M_z(TR^-) = M_0 + (M_z(TI^+) - M_0)\\exp(-(TR-TI)/T_1) = M_0 + (0 - M_0)\\exp(-(TR-TI)/T_1) $$\n    $$ M_z(TR^-) = M_0(1 - \\exp(-(TR-TI)/T_1)) $$\n\nThis expression for $M_z(TR^-)$ is valid because the system is in a steady state. We can now substitute this back into the equation for $M_z(TI^-)$:\n$$ M_z(TI^-) = M_0 \\left(1 - \\exp(-TI/T_1)\\right) - \\left[M_0\\left(1 - \\exp\\left(-\\frac{TR-TI}{T_1}\\right)\\right)\\right]\\exp(-TI/T_1) $$\n$$ M_z(TI^-) = M_0 \\left[1 - \\exp(-TI/T_1) - \\exp(-TI/T_1) + \\exp\\left(-\\frac{TR-TI}{T_1}\\right)\\exp\\left(-\\frac{TI}{T_1}\\right)\\right] $$\n$$ M_z(TI^-) = M_0 \\left[1 - 2\\exp(-TI/T_1) + \\exp(-TR/T_1)\\right] $$\nThis is the general expression for the longitudinal magnetization available for signal generation in a steady-state STIR sequence.\n\nThe problem specifies that the inversion time $TI$ is chosen to null the signal from fat. This means $M_z^{\\mathrm{fat}}(TI^-) = 0$. Using the derived expression for fat:\n$$ 0 = M_0^{\\mathrm{fat}} \\left[1 - 2\\exp(-TI/T_1^{\\mathrm{fat}}) + \\exp(-TR/T_1^{\\mathrm{fat}})\\right] $$\nSince $M_0^{\\mathrm{fat}} \\neq 0$, the term in the brackets must be zero:\n$$ 1 - 2\\exp(-TI/T_1^{\\mathrm{fat}}) + \\exp(-TR/T_1^{\\mathrm{fat}}) = 0 $$\n$$ 2\\exp(-TI/T_1^{\\mathrm{fat}}) = 1 + \\exp(-TR/T_1^{\\mathrm{fat}}) $$\n$$ \\exp(-TI/T_1^{\\mathrm{fat}}) = \\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2} $$\nTaking the natural logarithm of both sides and solving for $TI$:\n$$ TI = -T_1^{\\mathrm{fat}} \\ln\\left(\\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2}\\right) $$\nThe problem asks for the longitudinal magnetization of water at this specific $TI$, expressed as a fraction of its equilibrium magnetization $M_0^{\\mathrm{water}}$. Let this fraction be $F_{\\mathrm{water}}$.\n$$ F_{\\mathrm{water}} = \\frac{M_z^{\\mathrm{water}}(TI^-)}{M_0^{\\mathrm{water}}} = 1 - 2\\exp(-TI/T_1^{\\mathrm{water}}) + \\exp(-TR/T_1^{\\mathrm{water}}) $$\nTo evaluate this, we need the term $\\exp(-TI/T_1^{\\mathrm{water}})$. From the expression for $TI$:\n$$ -\\frac{TI}{T_1^{\\mathrm{water}}} = \\frac{T_1^{\\mathrm{fat}}}{T_1^{\\mathrm{water}}} \\ln\\left(\\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2}\\right) $$\nUsing the property $a\\ln(x) = \\ln(x^a)$:\n$$ -\\frac{TI}{T_1^{\\mathrm{water}}} = \\ln\\left[\\left(\\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2}\\right)^{\\frac{T_1^{\\mathrm{fat}}}{T_1^{\\mathrm{water}}}}\\right] $$\nExponentiating both sides gives:\n$$ \\exp(-TI/T_1^{\\mathrm{water}}) = \\left(\\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2}\\right)^{\\frac{T_1^{\\mathrm{fat}}}{T_1^{\\mathrm{water}}}} $$\nNow, we substitute this into the expression for $F_{\\mathrm{water}}$:\n$$ F_{\\mathrm{water}} = 1 - 2\\left(\\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2}\\right)^{\\frac{T_1^{\\mathrm{fat}}}{T_1^{\\mathrm{water}}}} + \\exp(-TR/T_1^{\\mathrm{water}}) $$\nWe can now substitute the given numerical values: $TR = 2500$ ms, $T_1^{\\mathrm{fat}} = 260$ ms, and $T_1^{\\mathrm{water}} = 1200$ ms.\n\nFirst, calculate the exponential terms:\n$$ \\exp(-TR/T_1^{\\mathrm{fat}}) = \\exp(-2500/260) = \\exp(-125/13) \\approx 6.67005 \\times 10^{-5} $$\n$$ \\exp(-TR/T_1^{\\mathrm{water}}) = \\exp(-2500/1200) = \\exp(-25/12) \\approx 0.124505 $$\nNext, calculate the term related to $TI$:\n$$ \\frac{1 + \\exp(-TR/T_1^{\\mathrm{fat}})}{2} = \\frac{1 + 6.67005 \\times 10^{-5}}{2} \\approx 0.50003335 $$\nThe exponent is the ratio of relaxation times:\n$$ \\frac{T_1^{\\mathrm{fat}}}{T_1^{\\mathrm{water}}} = \\frac{260}{1200} = \\frac{13}{60} $$\nSo, the term $\\exp(-TI/T_1^{\\mathrm{water}})$ is:\n$$ \\exp(-TI/T_1^{\\mathrm{water}}) = (0.50003335)^{13/60} \\approx 0.860561 $$\nFinally, substitute these values into the expression for $F_{\\mathrm{water}}$:\n$$ F_{\\mathrm{water}} \\approx 1 - 2(0.860561) + 0.124505 $$\n$$ F_{\\mathrm{water}} \\approx 1 - 1.721122 + 0.124505 = -0.596617 $$\nRounding the result to $4$ significant figures, we get $-0.5966$.\n\nThe negative sign indicates that the water's longitudinal magnetization vector is pointing in the $-z$ direction at the moment of the $90^{\\circ}$ excitation pulse. This is expected, as water's long $T_1$ means it has not had enough time to recover past the zero-crossing point after the initial $180^{\\circ}$ inversion, unlike fat.\n\nThe expected contrast is justified as follows: a STIR sequence with the calculated $TI$ is designed specifically to make fat invisible. At the time of excitation ($t=TI$), the longitudinal magnetization of fat is zero, so it produces no transverse magnetization and hence no signal. In contrast, the longitudinal magnetization of water at this same time is large in magnitude (approximately $59.7\\%$ of its equilibrium value, but inverted). This large longitudinal magnetization is converted into a large transverse magnetization by the $90^{\\circ}$ pulse, producing a strong signal. Therefore, the resulting image will exhibit high contrast between water-rich tissues (which will appear bright, assuming magnitude reconstruction) and fatty tissues (which will appear dark or \"nulled\"). This is the principle of fat suppression with STIR.", "answer": "$$\\boxed{-0.5966}$$", "id": "4922633"}, {"introduction": "The ultimate test of understanding is often the ability to build a model from scratch. This final hands-on practice [@problem_id:4922701] challenges you to create a complete numerical simulation of the STIR sequence. By implementing the step-by-step effects of RF pulses and relaxation periods on both fat and water magnetization, you will develop a powerful tool for exploring how sequence parameters affect the final image contrast, cementing your understanding of the underlying physics in a practical, computational context.", "problem": "You are to model Short Tau Inversion Recovery (STIR) for fat suppression followed by a Turbo Spin Echo (TSE) readout using the Bloch equations, and implement the resulting model as a runnable program. The physical scenario is: a nonselective inversion radiofrequency pulse of flip angle $180^\\circ$, free relaxation during an inversion time $TI$, a slice-selective excitation radiofrequency pulse of flip angle $90^\\circ$, and a TSE train producing the first spin echo at echo time $TE$. Short Tau Inversion Recovery (STIR) refers to choosing a short $TI$ to null fat signal. Turbo Spin Echo (TSE) refers to a rapid spin-echo readout with repeated $180^\\circ$ refocusing pulses.\n\nThe fundamental base to use is the Bloch equations in the rotating frame with relaxation. Let the magnetization vector be $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$, the equilibrium magnetization be $M_0$, the longitudinal relaxation time be $T_1$, and the transverse relaxation time be $T_2$. Under no applied radiofrequency field in the rotating frame, the Bloch equations are:\n$$\n\\frac{d}{dt}\\begin{bmatrix}M_x\\\\M_y\\\\M_z\\end{bmatrix}\n=\n\\begin{bmatrix}\n-\\frac{M_x}{T_2}\\\\\n-\\frac{M_y}{T_2}\\\\\n\\frac{M_0 - M_z}{T_1}\n\\end{bmatrix}.\n$$\nUnder a radiofrequency pulse modeled as a hard pulse about the $x$-axis with flip angle $\\alpha$ (in degrees), the magnetization is instantaneously rotated by the rotation matrix $R_x(\\alpha)$:\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1  0  0\\\\\n0  \\cos(\\alpha_\\mathrm{rad})  -\\sin(\\alpha_\\mathrm{rad})\\\\\n0  \\sin(\\alpha_\\mathrm{rad})  \\cos(\\alpha_\\mathrm{rad})\n\\end{bmatrix},\n\\quad\n\\alpha_\\mathrm{rad} = \\alpha \\cdot \\frac{\\pi}{180}.\n$$\n\nYour program must:\n- Start from the initial condition $\\mathbf{M}(0^-) = [0,0,M_0]^\\top$ for each species.\n- Apply a nonselective inversion pulse modeled as a rotation by flip angle $\\alpha_\\mathrm{inv}$ (in degrees) about the $x$-axis to obtain $\\mathbf{M}(0^+)$.\n- Numerically integrate the Bloch equations during the inversion time $TI$ (in milliseconds) with no applied field by a forward Euler discretization with a fixed time step $\\Delta t$ (in milliseconds) satisfying $\\Delta t = 0.1\\,\\mathrm{ms}$, to obtain $\\mathbf{M}(TI^-)$.\n- Apply a slice-selective excitation pulse modeled as a rotation by flip angle $\\alpha_\\mathrm{exc}$ (in degrees) about the $x$-axis to obtain $\\mathbf{M}(TI^+)$.\n- Model the TSE readout as producing the first spin echo at time $TE$ (in milliseconds) after the excitation, assuming perfect $180^\\circ$ refocusing pulses and negligible diffusion and off-resonance, so that the transverse magnetization magnitude decays as $\\exp(-TE/T_2)$. The echo amplitude for a species is then defined as\n$$\nS = \\left\\|\\begin{bmatrix}M_x(TI^+)\\\\ M_y(TI^+)\\end{bmatrix}\\right\\| \\cdot \\exp\\!\\left(-\\frac{TE}{T_2}\\right).\n$$\n\nTo explore fat suppression, consider two species: a \"fat-like\" species and a \"water-like\" species, each with its own $T_1$, $T_2$, and $M_0$ but experiencing the same radiofrequency pulses and timing. The radiofrequency flip angles may be scaled by a dimensionless transmit sensitivity factor $b$ such that the effective applied flip angles are $b \\cdot \\alpha_\\mathrm{inv}$ and $b \\cdot \\alpha_\\mathrm{exc}$.\n\nYour task is to implement this model and compute, for a small test suite of cases, the ratio $r = S_\\mathrm{fat}/S_\\mathrm{water}$, where $S_\\mathrm{fat}$ and $S_\\mathrm{water}$ are the echo amplitudes of the fat-like and water-like species, respectively. Express all times in milliseconds, angles in degrees, and output the ratios as unitless floating-point numbers.\n\nTest suite:\n- Species parameters (used for all test cases):\n  - Fat-like: $T_{1,\\mathrm{fat}} = 250\\,\\mathrm{ms}$, $T_{2,\\mathrm{fat}} = 80\\,\\mathrm{ms}$, $M_{0,\\mathrm{fat}} = 1.0$.\n  - Water-like: $T_{1,\\mathrm{water}} = 1000\\,\\mathrm{ms}$, $T_{2,\\mathrm{water}} = 100\\,\\mathrm{ms}$, $M_{0,\\mathrm{water}} = 1.0$.\n- Case $1$ (happy path near fat null): $TI = 175\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $2$ (boundary with $TI$ very short): $TI = 0\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $3$ (edge case with transmit under-flip): $TI = 175\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 0.9$.\n- Case $4$ (long inversion time): $TI = 1000\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $5$ (increased $TE$ to probe $T_2$ weighting): $TI = 175\\,\\mathrm{ms}$, $TE = 80\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the cases $1$ through $5$, where each entry is the floating-point ratio $r = S_\\mathrm{fat}/S_\\mathrm{water}$ for that case. For example, an output of the correct format is $[r_1,r_2,r_3,r_4,r_5]$ with each $r_i$ a float.", "solution": "The problem requires the modeling of a Short Tau Inversion Recovery (STIR) pulse sequence followed by a Turbo Spin Echo (TSE) readout to determine the signal ratio between fat-like and water-like tissue. The solution is derived by simulating the behavior of the magnetization vector, $\\mathbf{M}(t)$, for each species according to the Bloch equations, subjected to a sequence of radiofrequency (RF) pulses and relaxation periods.\n\nThe simulation process for a single species (characterized by $T_1$, $T_2$, and $M_0$) is as follows:\n\n1.  **Initial State**: At time $t=0^-$, before any RF pulses are applied, the system is in thermal equilibrium. The magnetization vector is aligned with the main magnetic field (conventionally the $z$-axis), with no transverse components.\n    $$\n    \\mathbf{M}(0^-) = \\begin{bmatrix} 0 \\\\ 0 \\\\ M_0 \\end{bmatrix}\n    $$\n\n2.  **Inversion Pulse**: At $t=0$, a nonselective inversion pulse is applied. This is modeled as an instantaneous rotation of the magnetization vector around the $x$-axis of the rotating frame. The flip angle, $\\alpha_\\mathrm{inv}$, is scaled by the transmit sensitivity factor $b$. The effective flip angle in radians is $\\alpha'_\\mathrm{inv} = (b \\cdot \\alpha_\\mathrm{inv}) \\cdot (\\pi/180)$. The magnetization state immediately after the pulse, $\\mathbf{M}(0^+)$, is calculated by applying the rotation matrix $R_x(\\alpha'_\\mathrm{inv})$:\n    $$\n    \\mathbf{M}(0^+) = R_x(\\alpha'_\\mathrm{inv}) \\mathbf{M}(0^-) =\n    \\begin{bmatrix}\n    1  0  0 \\\\\n    0  \\cos(\\alpha'_\\mathrm{inv})  -\\sin(\\alpha'_\\mathrm{inv}) \\\\\n    0  \\sin(\\alpha'_\\mathrm{inv})  \\cos(\\alpha'_\\mathrm{inv})\n    \\end{bmatrix}\n    \\begin{bmatrix} 0 \\\\ 0 \\\\ M_0 \\end{bmatrix}\n    =\n    \\begin{bmatrix} 0 \\\\ -M_0 \\sin(\\alpha'_\\mathrm{inv}) \\\\ M_0 \\cos(\\alpha'_\\mathrm{inv}) \\end{bmatrix}\n    $$\n    For an ideal inversion pulse, $\\alpha_\\mathrm{inv}=180^\\circ$ and $b=1$, so $\\alpha'_\\mathrm{inv}=\\pi$, and $\\mathbf{M}(0^+) = [0, 0, -M_0]^\\top$.\n\n3.  **Free Relaxation during Inversion Time ($TI$)**: For the duration of the inversion time, from $t=0^+$ to $t=TI^-$, the magnetization evolves according to the Bloch equations without any applied RF field. The problem specifies a numerical integration using the forward Euler method with a time step of $\\Delta t = 0.1 \\, \\mathrm{ms}$. The discretized equations for a single time step are:\n    $$\n    M_x(t+\\Delta t) = M_x(t) \\left(1 - \\frac{\\Delta t}{T_2}\\right)\n    $$\n    $$\n    M_y(t+\\Delta t) = M_y(t) \\left(1 - \\frac{\\Delta t}{T_2}\\right)\n    $$\n    $$\n    M_z(t+\\Delta t) = M_z(t) \\left(1 - \\frac{\\Delta t}{T_1}\\right) + \\frac{M_0 \\Delta t}{T_1}\n    $$\n    This iterative update is applied $N = \\text{int}(TI / \\Delta t)$ times, starting from the initial state $\\mathbf{M}(0^+)$, to compute the final state at the end of the inversion period, $\\mathbf{M}(TI^-)$.\n\n4.  **Excitation Pulse**: At $t=TI$, a slice-selective excitation pulse is applied. This is also modeled as an instantaneous rotation about the $x$-axis. The effective flip angle in radians is $\\alpha'_\\mathrm{exc} = (b \\cdot \\alpha_\\mathrm{exc}) \\cdot (\\pi/180)$. The magnetization state after the excitation pulse, $\\mathbf{M}(TI^+)$, is:\n    $$\n    \\mathbf{M}(TI^+) = R_x(\\alpha'_\\mathrm{exc}) \\mathbf{M}(TI^-) =\n    \\begin{bmatrix}\n    1  0  0 \\\\\n    0  \\cos(\\alpha'_\\mathrm{exc})  -\\sin(\\alpha'_\\mathrm{exc}) \\\\\n    0  \\sin(\\alpha'_\\mathrm{exc})  \\cos(\\alpha'_\\mathrm{exc})\n    \\end{bmatrix}\n    \\begin{bmatrix} M_x(TI^-) \\\\ M_y(TI^-) \\\\ M_z(TI^-) \\end{bmatrix}\n    $$\n\n5.  **Echo Signal Calculation**: The TSE readout generates a spin echo at an echo time $TE$ after the excitation pulse. The model assumes perfect refocusing, so the signal amplitude is determined by the magnitude of the transverse magnetization immediately after excitation, $\\| \\mathbf{M}_{xy}(TI^+) \\|$, which then decays due to $T_2$ relaxation over the time $TE$. The echo amplitude, $S$, is given by:\n    $$\n    S = \\left\\| \\begin{bmatrix} M_x(TI^+) \\\\ M_y(TI^+) \\end{bmatrix} \\right\\| \\cdot \\exp\\left(-\\frac{TE}{T_2}\\right) = \\sqrt{M_x(TI^+)^2 + M_y(TI^+)^2} \\cdot \\exp\\left(-\\frac{TE}{T_2}\\right)\n    $$\n\nTo solve the problem, this entire procedure is executed twice for each test case: once using the parameters for the fat-like species ($T_{1,\\mathrm{fat}}, T_{2,\\mathrm{fat}}, M_{0,\\mathrm{fat}}$) to calculate $S_\\mathrm{fat}$, and once using the parameters for the water-like species ($T_{1,\\mathrm{water}}, T_{2,\\mathrm{water}}, M_{0,\\mathrm{water}}$) to calculate $S_\\mathrm{water}$. The final result for each case is the ratio $r = S_\\mathrm{fat} / S_\\mathrm{water}$.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Models a STIR-TSE sequence and computes the fat-to-water signal ratio for a suite of test cases.\n    \"\"\"\n    \n    # Species parameters (fixed for all test cases)\n    species_params = {\n        'fat': {'T1': 250.0, 'T2': 80.0, 'M0': 1.0},\n        'water': {'T1': 1000.0, 'T2': 100.0, 'M0': 1.0}\n    }\n    \n    # Test cases\n    test_cases = [\n        {'TI': 175.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0}, # Case 1\n        {'TI': 0.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0},   # Case 2\n        {'TI': 175.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 0.9}, # Case 3\n        {'TI': 1000.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0},# Case 4\n        {'TI': 175.0, 'TE': 80.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0}, # Case 5\n    ]\n\n    dt = 0.1  # Time step in milliseconds for numerical integration\n\n    def compute_signal(species_props, seq_params):\n        \"\"\"\n        Computes the echo signal for a single species given sequence parameters.\n        \"\"\"\n        T1, T2, M0 = species_props['T1'], species_props['T2'], species_props['M0']\n        TI, TE = seq_params['TI'], seq_params['TE']\n        alpha_inv_deg, alpha_exc_deg = seq_params['alpha_inv'], seq_params['alpha_exc']\n        b = seq_params['b']\n\n        # Step 1: Initial state\n        M = np.array([0.0, 0.0, M0])\n\n        # Step 2: Inversion pulse\n        alpha_inv_rad = b * alpha_inv_deg * np.pi / 180.0\n        cos_a_inv = np.cos(alpha_inv_rad)\n        sin_a_inv = np.sin(alpha_inv_rad)\n        Rx_inv = np.array([\n            [1, 0, 0],\n            [0, cos_a_inv, -sin_a_inv],\n            [0, sin_a_inv, cos_a_inv]\n        ])\n        M = Rx_inv @ M\n\n        # Step 3: Free relaxation during inversion time (TI)\n        num_steps = int(TI / dt)\n        if num_steps  0:\n            # Pre-calculate factors for Euler integration\n            e1 = dt / T1\n            e2 = dt / T2\n            c1z = 1.0 - e1\n            c2z = e1 * M0\n            c_xy = 1.0 - e2\n\n            for _ in range(num_steps):\n                M[0] *= c_xy\n                M[1] *= c_xy\n                M[2] = M[2] * c1z + c2z\n\n        # Step 4: Excitation pulse\n        alpha_exc_rad = b * alpha_exc_deg * np.pi / 180.0\n        cos_a_exc = np.cos(alpha_exc_rad)\n        sin_a_exc = np.sin(alpha_exc_rad)\n        Rx_exc = np.array([\n            [1, 0, 0],\n            [0, cos_a_exc, -sin_a_exc],\n            [0, sin_a_exc, cos_a_exc]\n        ])\n        M = Rx_exc @ M\n\n        # Step 5: Echo signal calculation\n        M_xy = np.sqrt(M[0]**2 + M[1]**2)\n        S = M_xy * np.exp(-TE / T2)\n        \n        return S\n\n    results = []\n    for case in test_cases:\n        S_fat = compute_signal(species_params['fat'], case)\n        S_water = compute_signal(species_params['water'], case)\n        \n        if S_water != 0:\n            ratio = S_fat / S_water\n        else:\n            # Handle the case of zero water signal to avoid division by zero.\n            # In practice, with noise, this would be a large, poorly-defined number.\n            # For this simulation, if fat signal is also zero, ratio is NaN (becomes 0/0), \n            # otherwise it's infinity. We can cap it or represent as a large number\n            # but given the physics, if S_water is 0, S_fat will be non-zero,\n            # so the ratio is effectively infinite. Let's use numpy's representation.\n            ratio = np.inf if S_fat  0 else 0.0\n\n        results.append(ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```", "id": "4922701"}]}