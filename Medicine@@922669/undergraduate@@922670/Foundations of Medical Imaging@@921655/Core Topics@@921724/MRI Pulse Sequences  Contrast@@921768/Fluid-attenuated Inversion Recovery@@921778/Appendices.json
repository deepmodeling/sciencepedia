{"hands_on_practices": [{"introduction": "The cornerstone of any inversion recovery sequence is the precise timing needed to null the signal from a target tissue. This first exercise allows you to put theory into practice by deriving and calculating the nulling inversion time ($TI_{null}$) from the fundamental Bloch equation. By working through this problem [@problem_id:4885520], you will not only master this essential calculation but also explore how factors like the main magnetic field strength influence imaging parameters.", "problem": "A Fluid-Attenuated Inversion Recovery (FLAIR) sequence in Magnetic Resonance Imaging (MRI) uses an inversion recovery to suppress the signal from Cerebrospinal Fluid (CSF). Consider an idealized FLAIR sequence with a perfect inversion pulse that instantaneously flips the longitudinal magnetization by an angle of $\\pi$ radians, followed by a free recovery period with complete spoiling of transverse magnetization. Assume the longitudinal component of magnetization, $M_{z}(t)$, in the absence of further radiofrequency excitation or gradients, obeys the Bloch longitudinal relaxation law, with time constant $T_{1}$ and equilibrium magnetization $M_{0}$. The longitudinal recovery follows a first-order differential equation and begins from the initial condition immediately after the inversion pulse.\n\nStarting from the appropriate longitudinal relaxation differential equation and the post-inversion initial condition, derive the condition for the inversion time $TI_{\\text{null}}$ that nulls the longitudinal magnetization of CSF, i.e., $M_{z}(TI_{\\text{null}})=0$.\n\nUsing your derived expression, compute $TI_{\\text{null}}$ for CSF at $1.5\\ \\mathrm{T}$ assuming $T_{1}^{\\text{CSF}}=3000\\ \\mathrm{ms}$, and at $3\\ \\mathrm{T}$ assuming $T_{1}^{\\text{CSF}}=4500\\ \\mathrm{ms}$. Express both inversion times in $\\mathrm{ms}$ and round each to four significant figures. Additionally, to quantitatively compare the field-strength dependence, compute the ratio $\\dfrac{TI_{\\text{null}}(3\\ \\mathrm{T})}{TI_{\\text{null}}(1.5\\ \\mathrm{T})}$ and round it to four significant figures. The final answer must consist of the two inversion times in $\\mathrm{ms}$ and the dimensionless ratio, in that order, presented together as a single entity.", "solution": "The user-provided problem is assessed against the validation criteria.\n\n### Step 1: Extract Givens\n- **Sequence Type**: Fluid-Attenuated Inversion Recovery (FLAIR).\n- **Imaging Target**: Suppression of Cerebrospinal Fluid (CSF) signal.\n- **Pulse Sequence Model**: A perfect inversion pulse (angle of $\\pi$ radians) followed by free recovery. Transverse magnetization is completely spoiled.\n- **Physical Model**: Longitudinal magnetization $M_z(t)$ recovery is governed by the Bloch longitudinal relaxation law.\n- **Model Parameters**: Longitudinal relaxation time $T_1$, equilibrium magnetization $M_0$.\n- **Governing Equation**: First-order differential equation for longitudinal relaxation.\n- **Initial Condition**: State of magnetization immediately after the inversion pulse.\n- **Objective 1 (Derivation)**: Find the inversion time $TI_{\\text{null}}$ for which $M_{z}(TI_{\\text{null}})=0$.\n- **Objective 2 (Calculation)**: Compute $TI_{\\text{null}}$ for CSF at a field strength of $1.5\\ \\mathrm{T}$ where $T_{1}^{\\text{CSF}}=3000\\ \\mathrm{ms}$.\n- **Objective 3 (Calculation)**: Compute $TI_{\\text{null}}$ for CSF at a field strength of $3\\ \\mathrm{T}$ where $T_{1}^{\\text{CSF}}=4500\\ \\mathrm{ms}$.\n- **Objective 4 (Calculation)**: Compute the ratio $\\dfrac{TI_{\\text{null}}(3\\ \\mathrm{T})}{TI_{\\text{null}}(1.5\\ \\mathrm{T})}$.\n- **Formatting Requirement**: Round all numerical results to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded**: The problem is based on the Bloch equations, the established and fundamental model for nuclear magnetic resonance phenomena, including MRI. The FLAIR sequence is a standard and widely used clinical technique. The provided $T_1$ values for CSF at different magnetic field strengths ($1.5\\ \\mathrm{T}$ and $3\\ \\mathrm{T}$) are physically realistic. The problem is rigorously grounded in the principles of MRI physics.\n2.  **Well-Posed**: The problem provides a clear differential equation, a well-defined initial condition following the inversion pulse, and a specific target condition ($M_z = 0$). This structure guarantees the existence of a unique and meaningful solution for the inversion time, $TI_{\\text{null}}$.\n3.  **Objective**: The problem is stated using precise, unambiguous terminology from the field of medical physics. It is free from subjective assertions or opinions.\n\nThe problem does not exhibit any flaws such as scientific unsoundness, missing information, internal contradictions, or unrealistic conditions. It is a well-posed, standard problem in the foundations of medical imaging.\n\n### Step 3: Verdict and Action\nThe problem is valid. A complete solution will be provided.\n\n### Solution Derivation and Calculation\nThe recovery of the longitudinal component of magnetization, $M_z$, following a perturbation is described by the Bloch longitudinal relaxation equation:\n$$\n\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}\n$$\nwhere $M_0$ is the equilibrium magnetization and $T_1$ is the longitudinal relaxation time constant. This is a first-order linear ordinary differential equation. Its general solution, describing $M_z$ as a function of time $t$, is:\n$$\nM_z(t) = M_0 + \\left( M_z(0) - M_0 \\right) \\exp\\left(-\\frac{t}{T_1}\\right)\n$$\nwhere $M_z(0)$ is the initial magnetization at $t=0$.\n\nIn an inversion recovery sequence, the system is assumed to be at thermal equilibrium ($M_z = M_0$) before the sequence begins. A perfect inversion pulse rotates the magnetization vector by an angle of $\\pi$ radians ($180^\\circ$). This instantaneously inverts the longitudinal component of magnetization. Therefore, the initial condition for the recovery period, at time $t=0$ immediately after the pulse, is $M_z(0) = -M_0$.\n\nSubstituting this initial condition into the general solution gives the specific equation for recovery after a perfect inversion:\n$$\nM_z(t) = M_0 + \\left( -M_0 - M_0 \\right) \\exp\\left(-\\frac{t}{T_1}\\right)\n$$\n$$\nM_z(t) = M_0 \\left( 1 - 2 \\exp\\left(-\\frac{t}{T_1}\\right) \\right)\n$$\nThe null time, $TI_{\\text{null}}$, is the time $t$ at which the longitudinal magnetization crosses zero, i.e., $M_z(TI_{\\text{null}}) = 0$. This condition is desired in a FLAIR sequence to suppress the signal from the targeted tissue (in this case, CSF). We set the equation for $M_z(t)$ to zero and solve for $t = TI_{\\text{null}}$:\n$$\n0 = M_0 \\left( 1 - 2 \\exp\\left(-\\frac{TI_{\\text{null}}}{T_1}\\right) \\right)\n$$\nSince the equilibrium magnetization $M_0$ is non-zero, we can divide by it:\n$$\n0 = 1 - 2 \\exp\\left(-\\frac{TI_{\\text{null}}}{T_1}\\right)\n$$\n$$\n2 \\exp\\left(-\\frac{TI_{\\text{null}}}{T_1}\\right) = 1\n$$\n$$\n\\exp\\left(-\\frac{TI_{\\text{null}}}{T_1}\\right) = \\frac{1}{2}\n$$\nTo solve for $TI_{\\text{null}}$, we take the natural logarithm of both sides:\n$$\n-\\frac{TI_{\\text{null}}}{T_1} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)\n$$\nThis yields the expression for the nulling inversion time:\n$$\nTI_{\\text{null}} = T_1 \\ln(2)\n$$\nNow we apply this formula to the given cases for CSF.\n\n**Case 1: CSF at $1.5\\ \\mathrm{T}$**\nGiven $T_{1}^{\\text{CSF}}(1.5\\ \\mathrm{T}) = 3000\\ \\mathrm{ms}$.\n$$\nTI_{\\text{null}}(1.5\\ \\mathrm{T}) = (3000\\ \\mathrm{ms}) \\times \\ln(2) \\approx 2079.4415\\ \\mathrm{ms}\n$$\nRounding to four significant figures yields:\n$$\nTI_{\\text{null}}(1.5\\ \\mathrm{T}) = 2079\\ \\mathrm{ms}\n$$\n\n**Case 2: CSF at $3\\ \\mathrm{T}$**\nGiven $T_{1}^{\\text{CSF}}(3\\ \\mathrm{T}) = 4500\\ \\mathrm{ms}$.\n$$\nTI_{\\text{null}}(3\\ \\mathrm{T}) = (4500\\ \\mathrm{ms}) \\times \\ln(2) \\approx 3119.1623\\ \\mathrm{ms}\n$$\nRounding to four significant figures yields:\n$$\nTI_{\\text{null}}(3\\ \\mathrm{T}) = 3119\\ \\mathrm{ms}\n$$\n\n**Case 3: Ratio of Inversion Times**\nWe are asked to compute the ratio $\\dfrac{TI_{\\text{null}}(3\\ \\mathrm{T})}{TI_{\\text{null}}(1.5\\ \\mathrm{T})}$. Using the derived formula:\n$$\n\\text{Ratio} = \\frac{T_{1}^{\\text{CSF}}(3\\ \\mathrm{T}) \\ln(2)}{T_{1}^{\\text{CSF}}(1.5\\ \\mathrm{T}) \\ln(2)} = \\frac{T_{1}^{\\text{CSF}}(3\\ \\mathrm{T})}{T_{1}^{\\text{CSF}}(1.5\\ \\mathrm{T})}\n$$\nSubstituting the given values:\n$$\n\\text{Ratio} = \\frac{4500\\ \\mathrm{ms}}{3000\\ \\mathrm{ms}} = 1.5\n$$\nThe problem requires this result to be rounded to four significant figures. An exact value of $1.5$ is written as $1.500$ to meet this constraint.\n\nThe three required values are the two inversion times in order ($1.5\\ \\mathrm{T}$, then $3\\ \\mathrm{T}$) followed by the dimensionless ratio.", "answer": "$$\n\\boxed{\\begin{pmatrix} 2079  3119  1.500 \\end{pmatrix}}\n$$", "id": "4885520"}, {"introduction": "While nulling the signal from cerebrospinal fluid (CSF) is the primary objective of FLAIR, its diagnostic power lies in the resulting contrast between different tissues. This practice [@problem_id:4885508] moves beyond single-tissue nulling to model how FLAIR generates this crucial contrast. You will determine the residual signal from a non-nulled tissue, providing a quantitative understanding of how FLAIR achieves its characteristic T2-weighting while the bright CSF signal is suppressed.", "problem": "A fluid-attenuated inversion recovery (FLAIR) magnetic resonance imaging sequence uses a $180^{\\circ}$ inversion pulse followed by an inversion time $TI$ before a $90^{\\circ}$ excitation and a turbo spin-echo (TSE) readout with an effective echo time $TE_{\\mathrm{eff}}$. The purpose of FLAIR is to null the signal from cerebrospinal fluid (CSF) by choosing $TI$ appropriately, while retaining signal from tissues such as white matter (WM). Assume the following:\n- The longitudinal relaxation follows the Bloch equation, with longitudinal recovery governed by $T_1$ and transverse decay by $T_2$.\n- A perfect $180^{\\circ}$ inversion and a perfect $90^{\\circ}$ excitation are applied.\n- The repetition time is $TR=8000\\ \\mathrm{ms}$, sufficiently long to justify the single-inversion recovery model for $M_z(TI)$.\n- The CSF longitudinal relaxation time is $T_1^{\\mathrm{CSF}}=3000\\ \\mathrm{ms}$.\n- The WM transverse relaxation time is $T_2^{\\mathrm{WM}}=80\\ \\mathrm{ms}$.\n- The effective echo time is $TE_{\\mathrm{eff}}=120\\ \\mathrm{ms}$.\n- Ignore $T_2$ decay during $TI$ and assume the signal is proportional to the longitudinal magnetization at the inversion time times the transverse decay factor at echo: $S \\propto M_z(TI)\\,\\exp(-TE/T_2)$.\n\nStarting from the longitudinal recovery solution of the Bloch equation for a single $180^{\\circ}$ inversion followed by recovery, derive the inversion time $TI$ that nulls CSF under the long-$TR$ approximation. Then, using $TI$ chosen to null CSF, determine the relative signal scaling coefficients for CSF and WM with respect to the equilibrium magnetization $M_0$ under the simplified model $S \\propto M_z(TI)\\,\\exp(-TE/T_2)$, treating $T_1^{\\mathrm{WM}}$ as an unknown parameter. Express your final result as a $1\\times 2$ row matrix containing the dimensionless scaling factors $\\left[\\alpha_{\\mathrm{CSF}},\\ \\alpha_{\\mathrm{WM}}\\right]$ in terms of $T_1^{\\mathrm{WM}}$, with $TE=TE_{\\mathrm{eff}}$. No numerical rounding is required, and no physical units should be included in the final expression.", "solution": "The problem requires the derivation of the signal scaling coefficients for cerebrospinal fluid (CSF) and white matter (WM) in a Fluid-Attenuated Inversion Recovery (FLAIR) sequence. The solution is derived from the Bloch equation for longitudinal magnetization recovery following an inversion pulse.\n\nFirst, we model the longitudinal magnetization $M_z$ as a function of time $t$ after a perfect $180^{\\circ}$ inversion pulse. The problem states that the repetition time $TR$ is sufficiently long to assume that the magnetization fully recovers to its equilibrium value $M_0$ before each inversion pulse. Therefore, the initial condition at $t=0$ (immediately after the $180^{\\circ}$ pulse) is $M_z(0) = -M_0$. The longitudinal relaxation is described by the differential equation:\n$$\n\\frac{dM_z}{dt} = -\\frac{M_z(t) - M_0}{T_1}\n$$\nThe solution to this equation with the initial condition $M_z(0) = -M_0$ is:\n$$\nM_z(t) = M_0 \\left(1 - 2\\exp\\left(-\\frac{t}{T_1}\\right)\\right)\n$$\nIn a FLAIR sequence, a $90^{\\circ}$ excitation pulse is applied at an inversion time $TI$ after the $180^{\\circ}$ pulse. The magnitude of the longitudinal magnetization available to be flipped into the transverse plane is therefore $M_z(TI)$.\n\nThe primary goal of FLAIR is to null the signal from CSF. According to the provided signal model $S \\propto M_z(TI)\\,\\exp(-TE/T_2)$, the signal is zero if and only if the longitudinal magnetization at time $TI$ is zero. We must therefore choose $TI$ such that $M_z^{\\mathrm{CSF}}(TI) = 0$. Using the longitudinal recovery equation for CSF:\n$$\nM_z^{\\mathrm{CSF}}(TI) = M_0 \\left(1 - 2\\exp\\left(-\\frac{TI}{T_1^{\\mathrm{CSF}}}\\right)\\right) = 0\n$$\nSolving for $TI$:\n$$\n1 = 2\\exp\\left(-\\frac{TI}{T_1^{\\mathrm{CSF}}}\\right)\n$$\n$$\n\\frac{1}{2} = \\exp\\left(-\\frac{TI}{T_1^{\\mathrm{CSF}}}\\right)\n$$\nTaking the natural logarithm of both sides:\n$$\n\\ln\\left(\\frac{1}{2}\\right) = -\\frac{TI}{T_1^{\\mathrm{CSF}}}\n$$\n$$\n-\\ln(2) = -\\frac{TI}{T_1^{\\mathrm{CSF}}}\n$$\nThis gives the expression for the inversion time that nulls the CSF signal:\n$$\nTI = T_1^{\\mathrm{CSF}} \\ln(2)\n$$\nThe problem asks for the dimensionless signal scaling coefficients $\\alpha$, where the signal $S$ is given by $S = \\alpha M_0$. From the provided model, this coefficient for a given tissue is:\n$$\n\\alpha = \\frac{M_z(TI)}{M_0} \\exp\\left(-\\frac{TE_{\\mathrm{eff}}}{T_2}\\right)\n$$\nThe ratio of longitudinal magnetization to equilibrium magnetization at time $TI$ is:\n$$\n\\frac{M_z(TI)}{M_0} = 1 - 2\\exp\\left(-\\frac{TI}{T_1}\\right)\n$$\nNow, we can calculate the scaling coefficients for CSF and WM using the specific $TI = T_1^{\\mathrm{CSF}} \\ln(2)$.\n\nFor CSF, the scaling coefficient $\\alpha_{\\mathrm{CSF}}$ is:\n$$\n\\alpha_{\\mathrm{CSF}} = \\left(1 - 2\\exp\\left(-\\frac{TI}{T_1^{\\mathrm{CSF}}}\\right)\\right) \\exp\\left(-\\frac{TE_{\\mathrm{eff}}}{T_2^{\\mathrm{CSF}}}\\right)\n$$\nBy the very definition of $TI$, the first term is zero:\n$$\n1 - 2\\exp\\left(-\\frac{T_1^{\\mathrm{CSF}}\\ln(2)}{T_1^{\\mathrm{CSF}}}\\right) = 1 - 2\\exp(-\\ln(2)) = 1 - 2\\left(\\frac{1}{2}\\right) = 1 - 1 = 0\n$$\nTherefore, the scaling coefficient for CSF is:\n$$\n\\alpha_{\\mathrm{CSF}} = 0\n$$\nThis is the expected outcome, as the sequence is designed to null the CSF signal.\n\nFor WM, the scaling coefficient $\\alpha_{\\mathrm{WM}}$ is calculated using the same inversion time $TI = T_1^{\\mathrm{CSF}} \\ln(2)$, but with the relaxation times for WM ($T_1^{\\mathrm{WM}}$ and $T_2^{\\mathrm{WM}}$).\n$$\n\\alpha_{\\mathrm{WM}} = \\left(1 - 2\\exp\\left(-\\frac{TI}{T_1^{\\mathrm{WM}}}\\right)\\right) \\exp\\left(-\\frac{TE_{\\mathrm{eff}}}{T_2^{\\mathrm{WM}}}\\right)\n$$\nSubstitute $TI = T_1^{\\mathrm{CSF}}\\ln(2)$:\n$$\n\\alpha_{\\mathrm{WM}} = \\left(1 - 2\\exp\\left(-\\frac{T_1^{\\mathrm{CSF}}\\ln(2)}{T_1^{\\mathrm{WM}}}\\right)\\right) \\exp\\left(-\\frac{TE_{\\mathrm{eff}}}{T_2^{\\mathrm{WM}}}\\right)\n$$\nWe can simplify the exponential term involving $T_1$:\n$$\n\\exp\\left(-\\frac{T_1^{\\mathrm{CSF}}\\ln(2)}{T_1^{\\mathrm{WM}}}\\right) = \\left(\\exp(\\ln(2))\\right)^{-\\frac{T_1^{\\mathrm{CSF}}}{T_1^{\\mathrm{WM}}}} = 2^{-\\frac{T_1^{\\mathrm{CSF}}}{T_1^{\\mathrm{WM}}}}\n$$\nSo the longitudinal magnetization part becomes:\n$$\n1 - 2 \\cdot 2^{-\\frac{T_1^{\\mathrm{CSF}}}{T_1^{\\mathrm{WM}}}} = 1 - 2^{1 - \\frac{T_1^{\\mathrm{CSF}}}{T_1^{\\mathrm{WM}}}}\n$$\nNow, we substitute the given numerical values: $T_1^{\\mathrm{CSF}} = 3000\\ \\mathrm{ms}$, $TE_{\\mathrm{eff}} = 120\\ \\mathrm{ms}$, and $T_2^{\\mathrm{WM}} = 80\\ \\mathrm{ms}$. Note that $T_1^{\\mathrm{WM}}$ remains as a parameter.\nThe ratio for the transverse decay is:\n$$\n\\frac{TE_{\\mathrm{eff}}}{T_2^{\\mathrm{WM}}} = \\frac{120}{80} = \\frac{3}{2}\n$$\nSo, the full expression for $\\alpha_{\\mathrm{WM}}$ is:\n$$\n\\alpha_{\\mathrm{WM}} = \\left(1 - 2^{1 - \\frac{3000}{T_1^{\\mathrm{WM}}}}\\right) \\exp\\left(-\\frac{3}{2}\\right)\n$$\nThe final result is the $1 \\times 2$ row matrix containing the dimensionless scaling factors $[\\alpha_{\\mathrm{CSF}}, \\alpha_{\\mathrm{WM}}]$.\n$$\n\\left[\\alpha_{\\mathrm{CSF}},\\ \\alpha_{\\mathrm{WM}}\\right] = \\left[0,\\ \\left(1 - 2^{1 - \\frac{3000}{T_1^{\\mathrm{WM}}}}\\right) \\exp\\left(-\\frac{3}{2}\\right)\\right]\n$$", "answer": "$$\n\\boxed{\\begin{pmatrix} 0  \\left(1 - 2^{1 - \\frac{3000}{T_1^{\\mathrm{WM}}}}\\right) \\exp\\left(-\\frac{3}{2}\\right) \\end{pmatrix}}\n$$", "id": "4885508"}, {"introduction": "Theoretical models often assume that tissue properties are uniform, but real biological tissues are heterogeneous. This final, computational practice [@problem_id:4885472] tackles this real-world complexity by using a map of spatially varying $T_1$ values. This exercise guides you through the practical challenge of selecting a single, global inversion time for a heterogeneous region and then quantifying the resulting imperfections in signal suppression, bridging the gap between ideal formulas and practical imaging performance.", "problem": "You are given a spatial map of longitudinal spin-lattice relaxation times $T_1(x)$ and a binary mask indicating voxels belonging to cerebrospinal fluid (CSF). Consider Fluid-Attenuated Inversion Recovery (FLAIR), which uses an inversion pulse followed by an inversion time to attenuate CSF signal. Starting from the Bloch equations for longitudinal magnetization recovery after a perfect inversion pulse, derive from first principles the voxel-wise inversion time $TI_{\\text{null}}(x)$ that makes the longitudinal magnetization at each location $x$ equal to zero. Then, formally define a global scalar inversion time $TI_g$ as the median of the voxel-wise $TI_{\\text{null}}(x)$ restricted to CSF voxels indicated by the mask. Using the derived expressions, quantify how spatial variation in $T_1(x)$ affects CSF suppression uniformity under a single global $TI_g$ by computing:\n- The global inversion time $TI_g$ expressed in milliseconds, rounded to the nearest integer.\n- The mean absolute residual longitudinal magnetization over CSF voxels, defined as the mean of $R(x)=\\lvert M_z(TI_g;x)/M_0 \\rvert$ over CSF voxels, where $M_0$ is the equilibrium longitudinal magnetization assumed spatially uniform and strictly positive. Express this as a dimensionless float rounded to four decimal places.\n- The fraction of CSF voxels whose residual $\\lvert M_z(TI_g;x)/M_0 \\rvert$ is less than or equal to a specified threshold $\\epsilon$. Express this fraction as a decimal float rounded to four decimal places.\n\nBegin your derivation from the following fundamental base:\n- The longitudinal component of the Bloch equations after a perfect inversion pulse (flip angle $\\pi$) describing relaxation towards equilibrium magnetization is governed by first-order exponential recovery. You may assume a spatially uniform equilibrium longitudinal magnetization $M_0$ and a voxel-dependent longitudinal relaxation time $T_1(x)$.\n- The longitudinal magnetization $M_z(t;x)$ evolves deterministically under these conditions.\n\nFrom these principles, derive the condition for $M_z(TI_{\\text{null}}(x);x)=0$ and solve for $TI_{\\text{null}}(x)$ in terms of $T_1(x)$. Use this to construct the global $TI_g$ for CSF suppression and the residual magnetization metric $R(x)$.\n\nImplement a program that computes, for each provided test case, the list $[TI_g, \\overline{R}, f_{\\le \\epsilon}]$, where $TI_g$ is an integer in milliseconds, $\\overline{R}$ is the mean residual as defined above, and $f_{\\le \\epsilon}$ is the fraction of CSF voxels whose residual is less than or equal to $\\epsilon$. Use $\\epsilon = 0.05$ for all cases.\n\nPhysical units and formatting requirements:\n- Express $TI_g$ in milliseconds (ms), rounded to the nearest integer.\n- Express $\\overline{R}$ and $f_{\\le \\epsilon}$ as decimal floats rounded to four decimal places.\n- Angles, if any, are not required; do not use degrees or radians.\n- Your program should produce a single line of output containing the per-case results as a comma-separated list of case results, each case being a comma-separated triple enclosed in square brackets. The entire list must be enclosed in square brackets, with no spaces (e.g., $[[TI_1,\\overline{R}_1,f_1],[TI_2,\\overline{R}_2,f_2]]$).\n\nTest Suite (each case provides $T_1$ values in seconds and a CSF mask of the same length with $1$ for CSF voxel and $0$ otherwise):\n- Case $1$ (uniform CSF $T_1$):\n    - $T_1$ map: [$4.0$, $4.0$, $4.0$, $4.0$, $4.0$]\n    - CSF mask: [$1$, $1$, $1$, $1$, $1$]\n- Case $2$ (mild CSF $T_1$ variation):\n    - $T_1$ map: [$3.5$, $3.8$, $4.0$, $4.2$, $4.5$]\n    - CSF mask: [$1$, $1$, $1$, $1$, $1$]\n- Case $3$ (mixed tissue types with CSF mask):\n    - $T_1$ map: [$4.0$, $3.6$, $4.4$, $1.2$, $0.9$, $1.4$, $4.1$, $3.9$]\n    - CSF mask: [$1$, $1$, $1$, $0$, $0$, $0$, $1$, $1$]\n- Case $4$ (wide CSF $T_1$ variation):\n    - $T_1$ map: [$2.5$, $5.0$, $4.0$, $3.0$, $6.5$]\n    - CSF mask: [$1$, $1$, $1$, $1$, $1$]\n\nYour program must compute the requested outputs for all test cases and then print a single line in the exact required format described above.", "solution": "The problem is valid. It is scientifically grounded in the principles of Nuclear Magnetic Resonance (NMR) physics, is well-posed with a clear objective and sufficient data, and is expressed in precise, objective language. I will now proceed with the solution.\n\nThe problem asks for a derivation of the inversion time ($TI$) for a Fluid-Attenuated Inversion Recovery (FLAIR) sequence and an analysis of its performance under spatially varying longitudinal relaxation times, $T_1(x)$. The solution is developed from first principles, starting with the Bloch equation for longitudinal magnetization.\n\n### 1. Longitudinal Magnetization Recovery after Inversion\n\nThe evolution of the longitudinal component of magnetization, $M_z$, following an initial perturbation is described by the Bloch equation:\n$$\n\\frac{dM_z(t;x)}{dt} = \\frac{M_0 - M_z(t;x)}{T_1(x)}\n$$\nwhere $M_z(t;x)$ is the magnetization at time $t$ and spatial location $x$, $M_0$ is the thermal equilibrium magnetization (assumed to be spatially uniform and positive), and $T_1(x)$ is the voxel-dependent spin-lattice relaxation time.\n\nA FLAIR sequence begins with a perfect inversion pulse, which flips the equilibrium magnetization by $180$ degrees. This sets the initial condition at $t=0$:\n$$\nM_z(0;x) = -M_0\n$$\nThis is a first-order linear ordinary differential equation. We solve it by separation of variables or by recognizing its standard exponential recovery form. Let's define the deviation from equilibrium as $\\Delta M_z(t;x) = M_z(t;x) - M_0$. The differential equation becomes $\\frac{d(\\Delta M_z)}{dt} = -\\frac{\\Delta M_z}{T_1(x)}$, with the solution $\\Delta M_z(t;x) = C e^{-t/T_1(x)}$.\nTherefore, the general solution for $M_z(t;x)$ is:\n$$\nM_z(t;x) = M_0 + C e^{-t/T_1(x)}\n$$\nWe use the initial condition to find the constant $C$. At $t=0$:\n$$\nM_z(0;x) = -M_0 = M_0 + C e^0 = M_0 + C\n$$\nThis yields $C = -2M_0$. Substituting $C$ back into the general solution gives the explicit time-evolution of the longitudinal magnetization after a perfect inversion:\n$$\nM_z(t;x) = M_0 (1 - 2e^{-t/T_1(x)})\n$$\n\n### 2. Voxel-Wise Nulling Inversion Time ($TI_{\\text{null}}$)\n\nThe objective of FLAIR is to null the signal from a specific tissue, in this case, Cerebrospinal Fluid (CSF). This is achieved by applying the imaging part of the sequence at the precise moment when the longitudinal magnetization of CSF passes through zero. This duration is called the inversion time, $TI$. We can find the ideal voxel-wise inversion time, $TI_{\\text{null}}(x)$, by setting $M_z(t;x)$ to zero and solving for $t = TI_{\\text{null}}(x)$.\n$$\nM_z(TI_{\\text{null}}(x);x) = 0\n$$\n$$\nM_0 (1 - 2e^{-TI_{\\text{null}}(x)/T_1(x)}) = 0\n$$\nSince $M_0$ is strictly positive, we can divide by it:\n$$\n1 - 2e^{-TI_{\\text{null}}(x)/T_1(x)} = 0\n$$\n$$\n2e^{-TI_{\\text{null}}(x)/T_1(x)} = 1\n$$\n$$\ne^{-TI_{\\text{null}}(x)/T_1(x)} = \\frac{1}{2}\n$$\nTaking the natural logarithm of both sides:\n$$\n-\\frac{TI_{\\text{null}}(x)}{T_1(x)} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)\n$$\nSolving for $TI_{\\text{null}}(x)$ gives the fundamental relationship:\n$$\nTI_{\\text{null}}(x) = T_1(x) \\ln(2)\n$$\nThis equation shows that the ideal nulling time for any given voxel is directly proportional to its $T_1$ relaxation time.\n\n### 3. Global Inversion Time ($TI_g$) for CSF Suppression\n\nIn practice, a single global inversion time, $TI_g$, must be used for the entire imaging volume. The problem defines $TI_g$ as the median of the ideal nulling times, $TI_{\\text{null}}(x)$, calculated over all voxels corresponding to CSF. Let $S_{CSF}$ denote the set of spatial indices $x$ where the CSF mask is active.\n$$\nTI_g = \\text{median}\\{TI_{\\text{null}}(x) \\mid x \\in S_{CSF}\\}\n$$\nUsing the derived expression for $TI_{\\text{null}}(x)$:\n$$\nTI_g = \\text{median}\\{T_1(x) \\ln(2) \\mid x \\in S_{CSF}\\}\n$$\nSince $\\ln(2)$ is a positive constant, it can be factored out of the median calculation:\n$$\nTI_g = \\ln(2) \\cdot \\text{median}\\{T_1(x) \\mid x \\in S_{CSF}\\}\n$$\nThis choice of $TI_g$ optimally nulls the signal from a CSF voxel whose $T_1$ value is the median of all CSF $T_1$ values.\n\n### 4. Quantifying Suppression Uniformity\n\nWhen a single $TI_g$ is applied, CSF voxels with $T_1(x)$ values different from the median will not be perfectly nulled. We can quantify this imperfection.\nThe normalized residual longitudinal magnetization at a voxel $x$ is:\n$$\n\\frac{M_z(TI_g;x)}{M_0} = 1 - 2e^{-TI_g/T_1(x)}\n$$\nThe problem defines the residual metric $R(x)$ as the absolute value of this quantity:\n$$\nR(x) = \\left| \\frac{M_z(TI_g;x)}{M_0} \\right| = \\left| 1 - 2e^{-TI_g/T_1(x)} \\right|\n$$\nThe metrics for evaluating suppression uniformity are:\n1.  **Global Inversion Time ($TI_g$)**: As derived above, calculated for the CSF compartment and expressed in milliseconds, rounded to the nearest integer.\n2.  **Mean Absolute Residual ($\\overline{R}$)**: The average of $R(x)$ over all CSF voxels. It provides a single measure of the average suppression error across the CSF space.\n    $$\n    \\overline{R} = \\frac{1}{|S_{CSF}|} \\sum_{x \\in S_{CSF}} R(x)\n    $$\n3.  **Fraction of Well-Suppressed Voxels ($f_{\\le \\epsilon}$)**: The fraction of CSF voxels for which the residual $R(x)$ is below a given tolerance threshold $\\epsilon = 0.05$.\n    $$\n    f_{\\le \\epsilon} = \\frac{|\\{x \\in S_{CSF} \\mid R(x) \\le \\epsilon\\}|}{|S_{CSF}|}\n    $$\n\n### 5. Computational Algorithm\n\nThe procedure to compute these metrics for each test case is as follows:\n1.  Given a $T_1$ map and a CSF mask, extract the $T_1$ values for the CSF voxels (where mask value is $1$). Let this set of $T_1$ values (in seconds) be $\\{T_{1,CSF}\\}$.\n2.  Calculate the median of this set: $T_{1,\\text{med}} = \\text{median}\\{T_{1,CSF}\\}$.\n3.  Calculate the global inversion time in seconds: $TI_g^{\\text{sec}} = T_{1,\\text{med}} \\cdot \\ln(2)$.\n4.  Convert $TI_g$ to milliseconds and round to the nearest integer for the final output: $TI_g^{\\text{ms}} = \\text{round}(TI_g^{\\text{sec}} \\cdot 1000)$.\n5.  Using $TI_g^{\\text{sec}}$ and the set $\\{T_{1,CSF}\\}$, compute the residual $R(x)$ for each CSF voxel.\n6.  Calculate the mean of these residuals to get $\\overline{R}$.\n7.  Count the number of residuals less than or equal to $\\epsilon=0.05$ and divide by the total number of CSF voxels to get $f_{\\le \\epsilon}$.\n8.  Format the results ($TI_g^{\\text{ms}}$, $\\overline{R}$, $f_{\\le \\epsilon}$) to the specified precision and assemble the final output string.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the FLAIR analysis problem for the given test suite.\n    \n    The function performs the following steps for each test case:\n    1. Extracts T1 values for CSF voxels using the provided mask.\n    2. Calculates the global inversion time (TI_g) based on the median CSF T1.\n    3. Computes the residual magnetization for each CSF voxel using the global TI_g.\n    4. Calculates the mean residual magnetization (R_bar) and the fraction of\n       well-suppressed voxels (f_le_eps).\n    5. Formats the results according to the problem specification.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (uniform CSF T1)\n        (np.array([4.0, 4.0, 4.0, 4.0, 4.0]), np.array([1, 1, 1, 1, 1])),\n        # Case 2 (mild CSF T1 variation)\n        (np.array([3.5, 3.8, 4.0, 4.2, 4.5]), np.array([1, 1, 1, 1, 1])),\n        # Case 3 (mixed tissue types with CSF mask)\n        (np.array([4.0, 3.6, 4.4, 1.2, 0.9, 1.4, 4.1, 3.9]), np.array([1, 1, 1, 0, 0, 0, 1, 1])),\n        # Case 4 (wide CSF T1 variation)\n        (np.array([2.5, 5.0, 4.0, 3.0, 6.5]), np.array([1, 1, 1, 1, 1])),\n    ]\n\n    epsilon = 0.05\n    all_results = []\n\n    for t1_map_s, csf_mask in test_cases:\n        # Step 1: Extract T1 values for CSF voxels\n        csf_t1_s = t1_map_s[csf_mask == 1]\n        \n        if csf_t1_s.size == 0:\n            # Handle cases with no CSF voxels if necessary, though not in test suite\n            continue\n\n        # Step 2: Calculate the global inversion time TI_g\n        # TI_g = median(T1_csf) * ln(2)\n        median_t1_s = np.median(csf_t1_s)\n        ti_g_s = median_t1_s * np.log(2)\n        \n        # Convert to milliseconds and round for output\n        ti_g_ms = int(round(ti_g_s * 1000))\n\n        # Step 3: Compute the residual magnetization R(x) for each CSF voxel\n        # R(x) = |1 - 2 * exp(-TI_g / T1(x))|\n        residuals = np.abs(1 - 2 * np.exp(-ti_g_s / csf_t1_s))\n\n        # Step 4: Calculate the mean residual (R_bar) and fraction of suppressed voxels (f_le_eps)\n        mean_residual = np.mean(residuals)\n        \n        num_suppressed = np.sum(residuals = epsilon)\n        fraction_suppressed = num_suppressed / len(csf_t1_s)\n        \n        # Store the formatted result for this case\n        case_result_str = f\"[{ti_g_ms},{mean_residual:.4f},{fraction_suppressed:.4f}]\"\n        all_results.append(case_result_str)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(all_results)}]\")\n\nsolve()\n```", "id": "4885472"}]}