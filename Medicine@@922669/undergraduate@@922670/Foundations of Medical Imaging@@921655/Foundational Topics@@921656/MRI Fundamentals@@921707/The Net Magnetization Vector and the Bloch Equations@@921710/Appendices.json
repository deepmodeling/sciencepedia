{"hands_on_practices": [{"introduction": "This practice bridges the theoretical Bloch equations with the practical goal of generating image contrast. You will model the MRI signal from a single voxel containing a mixture of two different tissue types, a common situation known as the partial volume effect. By applying the principles of steady-state magnetization in a spoiled gradient-echo sequence, you will calculate how distinct relaxation properties ($T_1$ and $T_2^*$) and sequence parameters combine to produce a single, composite signal, a core skill for understanding and interpreting MRI data [@problem_id:4934143].", "problem": "A single Magnetic Resonance Imaging (MRI) voxel contains two non-exchanging compartments, each contributing to the net magnetization through its own relaxation properties and volume fraction. The static magnetic field is applied along the $z$-axis. The dynamics of the magnetization vector $\\mathbf{M}(t)$ are governed by the Bloch equations, with longitudinal recovery characterized by the longitudinal relaxation time $T_{1}$ and transverse decay characterized by the effective transverse relaxation time $T_{2}^{\\ast}$. A spoiled gradient-echo sequence is used, with the following properties: the Radiofrequency (RF) pulse has flip angle $\\alpha$, Repetition Time (TR) is $20$ milliseconds, Time of Echo (TE) is $5$ milliseconds, and perfect spoiling ensures that the transverse magnetization is zero immediately before each RF pulse. Off-resonance effects are negligible.\n\nCompartment $\\mathrm{A}$ has volume fraction $f_{\\mathrm{A}} = 0.6$, longitudinal relaxation time $T_{1,\\mathrm{A}} = 1500$ milliseconds, and effective transverse relaxation time $T_{2,\\mathrm{A}}^{\\ast} = 40$ milliseconds. Compartment $\\mathrm{B}$ has volume fraction $f_{\\mathrm{B}} = 0.4$, longitudinal relaxation time $T_{1,\\mathrm{B}} = 600$ milliseconds, and effective transverse relaxation time $T_{2,\\mathrm{B}}^{\\ast} = 15$ milliseconds. Assume the equilibrium longitudinal magnetization per unit volume is the same in both compartments and denote it by $M_{0}$.\n\nStarting from the Bloch equations and first principles of relaxation and rotation, derive the steady-state transverse magnetization at time $t = \\mathrm{TE}$ for each compartment under the spoiled gradient-echo sequence, accounting for RF rotation and relaxation during $\\mathrm{TR}$ and $\\mathrm{TE}$. Then, using linear superposition consistent with partial volume, compute the net voxel signal at $t = \\mathrm{TE}$ as a fraction of $M_{0}$.\n\nUse $\\alpha = 0.35$ radians. Express the final answer as a single real number equal to $S(\\mathrm{TE})/M_{0}$, rounded to three significant figures. The time quantities $T_{1}$, $T_{2}^{\\ast}$, $\\mathrm{TR}$, and $\\mathrm{TE}$ are all in milliseconds; ensure consistent units in all exponential factors.", "solution": "The user-provided problem has been validated and is determined to be sound, well-posed, and complete. All provided parameters are physically realistic and consistent. The problem is a standard, non-trivial application of the Bloch equations to a common Magnetic Resonance Imaging (MRI) sequence and a multi-compartment model.\n\nThe problem asks for the net signal at the time of echo, $t=\\mathrm{TE}$, for a spoiled gradient-echo (GRE) sequence, arising from a voxel containing two non-exchanging compartments. The final answer should be expressed as a fraction of the equilibrium magnetization per unit volume, $M_{0}$.\n\nFirst, we will derive the steady-state signal for a single compartment, subject to a spoiled GRE sequence. The state of the magnetization vector, $\\mathbf{M}(t) = (M_x(t), M_y(t), M_z(t))$, is analyzed over one repetition time, $\\mathrm{TR}$. The sequence consists of an RF pulse followed by relaxation.\n\nThe \"perfect spoiling\" condition is critical: it implies that any transverse magnetization ($M_x, M_y$) is dephased and effectively zero immediately before each RF pulse. Therefore, at time $t=0^{-}$ (just before the pulse), the magnetization is purely longitudinal:\n$$ \\mathbf{M}(0^{-}) = \\begin{pmatrix} 0 \\\\ 0 \\\\ M_z^{-} \\end{pmatrix} $$\nwhere $M_z^{-}$ is the longitudinal magnetization at the beginning of the steady-state cycle.\n\nAt time $t=0$, an RF pulse with flip angle $\\alpha$ is applied, conventionally considered to be around the $x$-axis. This pulse rotates the magnetization vector. The state immediately after the pulse, at $t=0^{+}$, is:\n$$ \\mathbf{M}(0^{+}) = R_x(\\alpha) \\mathbf{M}(0^{-}) = \\begin{pmatrix} 1 & 0 & 0 \\\\ 0 & \\cos\\alpha & \\sin\\alpha \\\\ 0 & -\\sin\\alpha & \\cos\\alpha \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0 \\\\ M_z^{-} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ M_z^{-} \\sin\\alpha \\\\ M_z^{-} \\cos\\alpha \\end{pmatrix} $$\nSo, immediately after the pulse, the longitudinal magnetization is $M_z(0^{+}) = M_z^{-} \\cos\\alpha$, and the transverse magnetization has a magnitude of $M_{xy}(0^{+}) = |M_z^{-} \\sin\\alpha|$. Assuming $\\alpha$ is a positive angle, $M_{xy}(0^{+}) = M_z^{-} \\sin\\alpha$.\n\nBetween $t=0^{+}$ and $t=\\mathrm{TR}$, the magnetization components evolve according to the Bloch equations, decoupled from each other in the absence of RF fields.\nThe longitudinal component, $M_z$, recovers towards its equilibrium value $M_0$ with time constant $T_1$:\n$$ M_z(t) = M_0 + (M_z(0^{+}) - M_0) \\exp\\left(-\\frac{t}{T_1}\\right) $$\nThe transverse component, $M_{xy}$, decays to zero with time constant $T_2^{\\ast}$:\n$$ M_{xy}(t) = M_{xy}(0^{+}) \\exp\\left(-\\frac{t}{T_2^{\\ast}}\\right) $$\nAt the end of the repetition time, $t=\\mathrm{TR}$, the longitudinal magnetization is:\n$$ M_z(\\mathrm{TR}) = M_0 + (M_z^{-} \\cos\\alpha - M_0) \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right) $$\nIn the steady state, the longitudinal magnetization at the end of one cycle must be equal to the longitudinal magnetization at the beginning of the next cycle. Thus, $M_z(\\mathrm{TR}) = M_z^{-}$.\n$$ M_z^{-} = M_0 + (M_z^{-} \\cos\\alpha - M_0) \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right) $$\nWe can now solve for the steady-state longitudinal magnetization $M_z^{-}$. Let $E_1 = \\exp(-\\mathrm{TR}/T_1)$.\n$$ M_z^{-} = M_0 + M_z^{-} E_1 \\cos\\alpha - M_0 E_1 $$\n$$ M_z^{-} (1 - E_1 \\cos\\alpha) = M_0 (1 - E_1) $$\n$$ M_z^{-} = M_0 \\frac{1 - E_1}{1 - E_1 \\cos\\alpha} = M_0 \\frac{1 - \\exp(-\\mathrm{TR}/T_1)}{1 - \\exp(-\\mathrm{TR}/T_1) \\cos\\alpha} $$\nThis is the well-known Ernst equation for the steady-state longitudinal magnetization in a spoiled GRE sequence.\n\nThe signal, $S$, is proportional to the magnitude of the transverse magnetization at the echo time, $t=\\mathrm{TE}$. Starting from $M_{xy}(0^{+}) = M_z^{-} \\sin\\alpha$, the signal at $t=\\mathrm{TE}$ is:\n$$ S(\\mathrm{TE}) = M_{xy}(\\mathrm{TE}) = M_{xy}(0^{+}) \\exp\\left(-\\frac{\\mathrm{TE}}{T_2^{\\ast}}\\right) = M_z^{-} \\sin\\alpha \\exp\\left(-\\frac{\\mathrm{TE}}{T_2^{\\ast}}\\right) $$\nSubstituting the expression for $M_z^{-}$:\n$$ S(\\mathrm{TE}) = M_0 \\frac{1 - \\exp(-\\mathrm{TR}/T_1)}{1 - \\exp(-\\mathrm{TR}/T_1) \\cos\\alpha} \\sin\\alpha \\exp\\left(-\\frac{\\mathrm{TE}}{T_2^{\\ast}}\\right) $$\nThis expression gives the signal per unit volume for a single compartment.\n\nThe problem describes a voxel with two non-exchanging compartments, A and B. The net signal from the voxel is the linear superposition of the signals from each compartment, weighted by their respective volume fractions, $f_{\\mathrm{A}}$ and $f_{\\mathrm{B}}$.\n$$ S_{net}(\\mathrm{TE}) = f_{\\mathrm{A}} S_{\\mathrm{A}}(\\mathrm{TE}) + f_{\\mathrm{B}} S_{\\mathrm{B}}(\\mathrm{TE}) $$\nThe equilibrium magnetization per unit volume, $M_0$, is assumed to be the same for both compartments. We are asked to find $S_{net}(\\mathrm{TE}) / M_0$.\n$$ \\frac{S_{net}(\\mathrm{TE})}{M_0} = f_{\\mathrm{A}} \\frac{S_{\\mathrm{A}}(\\mathrm{TE})}{M_0} + f_{\\mathrm{B}} \\frac{S_{\\mathrm{B}}(\\mathrm{TE})}{M_0} $$\nUsing the derived signal equation for each compartment:\n$$ \\frac{S_{\\mathrm{A}}(\\mathrm{TE})}{M_0} = \\frac{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{A}})}{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{A}}) \\cos\\alpha} \\sin\\alpha \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{A}}^{\\ast}}\\right) $$\n$$ \\frac{S_{\\mathrm{B}}(\\mathrm{TE})}{M_0} = \\frac{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{B}})}{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{B}}) \\cos\\alpha} \\sin\\alpha \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{B}}^{\\ast}}\\right) $$\nCombining these gives the total normalized signal:\n$$ \\frac{S_{net}(\\mathrm{TE})}{M_0} = \\sin\\alpha \\left[ f_{\\mathrm{A}} \\left(\\frac{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{A}})}{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{A}}) \\cos\\alpha}\\right) \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{A}}^{\\ast}}\\right) + f_{\\mathrm{B}} \\left(\\frac{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{B}})}{1 - \\exp(-\\mathrm{TR}/T_{1,\\mathrm{B}}) \\cos\\alpha}\\right) \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{B}}^{\\ast}}\\right) \\right] $$\n\nNow, we substitute the given numerical values, ensuring all time units are consistent (milliseconds, ms).\nGiven parameters:\n$\\alpha = 0.35$ radians\n$\\mathrm{TR} = 20$ ms\n$\\mathrm{TE} = 5$ ms\nCompartment A: $f_{\\mathrm{A}} = 0.6$, $T_{1,\\mathrm{A}} = 1500$ ms, $T_{2,\\mathrm{A}}^{\\ast} = 40$ ms\nCompartment B: $f_{\\mathrm{B}} = 0.4$, $T_{1,\\mathrm{B}} = 600$ ms, $T_{2,\\mathrm{B}}^{\\ast} = 15$ ms\n\nFirst, we compute the exponential and trigonometric terms.\n$$ \\sin\\alpha = \\sin(0.35) \\approx 0.342898 $$\n$$ \\cos\\alpha = \\cos(0.35) \\approx 0.939373 $$\nFor compartment A:\n$$ \\frac{\\mathrm{TR}}{T_{1,\\mathrm{A}}} = \\frac{20}{1500} = \\frac{1}{75} \\implies \\exp\\left(-\\frac{\\mathrm{TR}}{T_{1,\\mathrm{A}}}\\right) \\approx 0.986752 $$\n$$ \\frac{\\mathrm{TE}}{T_{2,\\mathrm{A}}^{\\ast}} = \\frac{5}{40} = \\frac{1}{8} = 0.125 \\implies \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{A}}^{\\ast}}\\right) \\approx 0.882497 $$\nFor compartment B:\n$$ \\frac{\\mathrm{TR}}{T_{1,\\mathrm{B}}} = \\frac{20}{600} = \\frac{1}{30} \\implies \\exp\\left(-\\frac{\\mathrm{TR}}{T_{1,\\mathrm{B}}}\\right) \\approx 0.967216 $$\n$$ \\frac{\\mathrm{TE}}{T_{2,\\mathrm{B}}^{\\ast}} = \\frac{5}{15} = \\frac{1}{3} \\implies \\exp\\left(-\\frac{\\mathrm{TE}}{T_{2,\\mathrm{B}}^{\\ast}}\\right) \\approx 0.716531 $$\n\nNow calculate the contribution from each compartment.\nContribution from A:\n$$ S'_{\\mathrm{A}} = f_{\\mathrm{A}} \\left(\\frac{1 - 0.986752}{1 - 0.986752 \\times 0.939373}\\right) \\times 0.882497 $$\n$$ S'_{\\mathrm{A}} = 0.6 \\left(\\frac{0.013248}{1 - 0.926941}\\right) \\times 0.882497 = 0.6 \\left(\\frac{0.013248}{0.073059}\\right) \\times 0.882497 $$\n$$ S'_{\\mathrm{A}} = 0.6 \\times 0.181336 \\times 0.882497 \\approx 0.096053 $$\n\nContribution from B:\n$$ S'_{\\mathrm{B}} = f_{\\mathrm{B}} \\left(\\frac{1 - 0.967216}{1 - 0.967216 \\times 0.939373}\\right) \\times 0.716531 $$\n$$ S'_{\\mathrm{B}} = 0.4 \\left(\\frac{0.032784}{1 - 0.908582}\\right) \\times 0.716531 = 0.4 \\left(\\frac{0.032784}{0.091418}\\right) \\times 0.716531 $$\n$$ S'_{\\mathrm{B}} = 0.4 \\times 0.358595 \\times 0.716531 \\approx 0.102798 $$\n\nThe total normalized signal is the sum of these contributions multiplied by $\\sin\\alpha$:\n$$ \\frac{S_{net}(\\mathrm{TE})}{M_0} = \\sin(0.35) \\times (S'_{\\mathrm{A}} + S'_{\\mathrm{B}}) $$\n$$ \\frac{S_{net}(\\mathrm{TE})}{M_0} \\approx 0.342898 \\times (0.096053 + 0.102798) $$\n$$ \\frac{S_{net}(\\mathrm{TE})}{M_0} \\approx 0.342898 \\times 0.198851 \\approx 0.0681815 $$\nRounding to three significant figures, the result is $0.0682$.", "answer": "$$\n\\boxed{0.0682}\n$$", "id": "4934143"}, {"introduction": "Having explored signal generation, we now turn to the spatial control of magnetization, a cornerstone of MRI. This exercise simulates the challenge of an imperfect magnetic field and introduces the solution: tailored magnetic field gradients. You will use the precession component of the Bloch equation to derive the precise gradient pulse required to counteract phase dispersion caused by a linear field inhomogeneity, ensuring all spins within a region are perfectly rephased at a specific echo time [@problem_id:4934150]. This principle of phase management is fundamental to forming echoes and achieving high-quality images.", "problem": "A homogeneous cylindrical sample is placed in a static magnetic field aligned with the laboratory $z$-axis. The main field has nominal magnitude $B_0$, but there exists a residual inhomogeneity that varies linearly along the $x$-direction, so that the local deviation of the $z$-directed field from $B_0$ is $\\Delta B_z(x)=\\alpha\\,x$ for $|x|$ within the object extent, where $\\alpha$ is a constant with units tesla per meter. At time $t=0$, an ideal instantaneous $90^{\\circ}$ radiofrequency (RF) pulse on resonance with the Larmor frequency corresponding to $B_0$ tips the net magnetization vector into the transverse plane. Immediately after $t=0$, a shim precompensation is applied by turning on a $z$-directed magnetic field gradient that varies linearly along $x$, of the form $\\Delta B_{z,\\mathrm{shim}}(x,t)=G_s(t)\\,x$ for $t\\in[0,\\tau]$, where $G_s(t)$ is under experimental control. For $t\\in(\\tau, \\mathrm{TE}]$, no additional gradients are applied. Neglect longitudinal and transverse relaxation during $[0,\\mathrm{TE}]$.\n\nStarting from the Bloch equations and working in the frame rotating at the on-resonance angular frequency corresponding to $B_0$, derive the exact closed-form expression for the gradient moment\n$$\nm_s \\equiv \\int_{0}^{\\tau} G_s(t)\\,dt\n$$\nthat must be applied so that, at the echo time $\\mathrm{TE}$, the transverse magnetization across all positions $x$ in the linear region has zero relative phase (i.e., is fully rephased with respect to $x$). Express your final answer as a single analytic expression in terms of $\\alpha$ and $\\mathrm{TE}$. Express the required gradient moment in T·s·m$^{-1}$. No numerical evaluation is required.", "solution": "The problem requires the derivation of the gradient moment $m_s$ that ensures the transverse magnetization is rephased at the echo time $\\mathrm{TE}$, in the presence of a linear static field inhomogeneity. The derivation will start from the Bloch equation in the rotating frame.\n\nLet the gyromagnetic ratio be $\\gamma$. The problem states to work in the frame rotating at the on-resonance angular frequency $\\omega_0 = \\gamma B_0$, where $B_0$ is the nominal main magnetic field strength. In this frame, and neglecting relaxation effects, the evolution of the magnetization vector $\\vec{M}'$ is governed by the equation:\n$$\n\\frac{d\\vec{M}'}{dt} = \\gamma (\\vec{M}' \\times \\vec{B}_{\\text{eff}}')\n$$\nwhere $\\vec{B}_{\\text{eff}}'$ is the effective magnetic field in the rotating frame. This effective field is the difference between the total physical magnetic field $\\vec{B}$ and the field corresponding to the frame's rotation, $B_0 \\hat{k}$:\n$$\n\\vec{B}_{\\text{eff}}' = \\vec{B} - B_0 \\hat{k}\n$$\nThe total magnetic field $\\vec{B}(x, t)$ along the $z$-axis is the sum of the main field $B_0$, the static inhomogeneity $\\Delta B_z(x) = \\alpha x$, and the applied shim gradient field $\\Delta B_{z,\\mathrm{shim}}(x,t) = G_s(t) x$.\n$$\n\\vec{B}(x, t) = \\left( B_0 + \\alpha x + G_s(t) x \\right) \\hat{k} \\quad \\text{for } t \\in [0, \\tau]\n$$\n$$\n\\vec{B}(x, t) = \\left( B_0 + \\alpha x \\right) \\hat{k} \\quad \\text{for } t \\in (\\tau, \\mathrm{TE}]\n$$\nThus, the effective field in the rotating frame, which is purely along the $z'$-axis, is:\n$$\nB'_{\\text{eff}, z}(x, t) = \\alpha x + \\Delta B_{z,\\mathrm{shim}}(x,t)\n$$\nwhere\n$$\n\\Delta B_{z,\\mathrm{shim}}(x,t) = \\begin{cases} G_s(t) x & \\text{for } t \\in [0, \\tau] \\\\ 0 & \\text{for } t \\in (\\tau, \\mathrm{TE}] \\end{cases}\n$$\nAt time $t=0$, a $90^{\\circ}$ RF pulse places the magnetization in the transverse ($x'$-$y'$) plane. The subsequent phase evolution of this transverse magnetization is determined by the precession around the effective field $B'_{\\text{eff}, z}$. The angular frequency of this precession in the rotating frame is:\n$$\n\\omega'(x,t) = \\gamma B'_{\\text{eff}, z}(x,t) = \\gamma \\left( \\alpha x + \\Delta B_{z,\\mathrm{shim}}(x,t) \\right)\n$$\nThe total phase $\\phi(x, \\mathrm{TE})$ accumulated by the magnetization at position $x$ at the echo time $\\mathrm{TE}$, relative to its phase at $t=0$, is the time integral of this frequency from $t=0$ to $t=\\mathrm{TE}$:\n$$\n\\phi(x, \\mathrm{TE}) = \\int_{0}^{\\mathrm{TE}} \\omega'(x,t) \\, dt = \\int_{0}^{\\mathrm{TE}} \\gamma \\left( \\alpha x + \\Delta B_{z,\\mathrm{shim}}(x,t) \\right) dt\n$$\nWe can separate this integral into the two time intervals defined by the application of the shim gradient:\n$$\n\\phi(x, \\mathrm{TE}) = \\int_{0}^{\\tau} \\gamma \\left( \\alpha x + G_s(t) x \\right) dt + \\int_{\\tau}^{\\mathrm{TE}} \\gamma \\left( \\alpha x \\right) dt\n$$\nSince $\\gamma$, $\\alpha$, and $x$ are not functions of time, they can be factored out of the integrals:\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x \\int_{0}^{\\tau} \\left( \\alpha + G_s(t) \\right) dt + \\gamma x \\int_{\\tau}^{\\mathrm{TE}} \\alpha \\, dt\n$$\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x \\left( \\alpha \\int_{0}^{\\tau} dt + \\int_{0}^{\\tau} G_s(t) \\, dt \\right) + \\gamma x \\left( \\alpha [\\mathrm{TE} - \\tau] \\right)\n$$\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x \\left( \\alpha \\tau + \\int_{0}^{\\tau} G_s(t) \\, dt \\right) + \\gamma x \\alpha (\\mathrm{TE} - \\tau)\n$$\nThe problem defines the gradient moment as $m_s \\equiv \\int_{0}^{\\tau} G_s(t) \\, dt$. Substituting this into the expression for the phase yields:\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x ( \\alpha \\tau + m_s ) + \\gamma x \\alpha (\\mathrm{TE} - \\tau)\n$$\nExpanding the terms, we get:\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x \\alpha \\tau + \\gamma x m_s + \\gamma x \\alpha \\mathrm{TE} - \\gamma x \\alpha \\tau\n$$\nThe terms involving $\\tau$ cancel each other, simplifying the total accumulated phase to:\n$$\n\\phi(x, \\mathrm{TE}) = \\gamma x (m_s + \\alpha \\mathrm{TE})\n$$\nThe condition for a rephased echo is that the phase of the transverse magnetization is independent of the spatial position $x$. This means that $\\phi(x, \\mathrm{TE})$ must be constant for all $x$, which requires the coefficient of $x$ to be zero:\n$$\n\\gamma (m_s + \\alpha \\mathrm{TE}) = 0\n$$\nSince the gyromagnetic ratio $\\gamma$ is a non-zero physical constant, the term in the parenthesis must be zero:\n$$\nm_s + \\alpha \\mathrm{TE} = 0\n$$\nSolving this equation for the gradient moment $m_s$ gives the final expression:\n$$\nm_s = -\\alpha \\mathrm{TE}\n$$\nThis result indicates that the pre-phasing gradient moment must be equal in magnitude and opposite in sign to the total phase evolution caused by the static field inhomogeneity over the entire echo time interval.", "answer": "$$\n\\boxed{-\\alpha\\,\\mathrm{TE}}\n$$", "id": "4934150"}, {"introduction": "While analytical models are powerful, they often rely on simplifying assumptions, such as instantaneous radiofrequency (RF) pulses. This computational practice challenges you to build a more realistic model by numerically solving the complete Bloch equations, including the simultaneous effects of relaxation and precession during an RF pulse of finite duration. By implementing a numerical solver, you will gain a deeper intuition for the complex interplay of forces on the net magnetization vector and develop a versatile tool for simulating a wide range of MRI phenomena that are intractable to solve by hand [@problem_id:4934146].", "problem": "You are to write a complete, runnable program that numerically solves the Bloch equations for magnetization dynamics during a rectangular Radiofrequency (RF) excitation in Magnetic Resonance Imaging (MRI), explicitly including relaxation during the pulse. Work in the rotating frame of the RF transmit frequency. Begin from fundamental precession and relaxation principles. The precession of the net magnetization vector under an effective magnetic field and relaxation is described by a system of ordinary differential equations derived from: the precession law $d\\mathbf{M}/dt = \\gamma \\, \\mathbf{M} \\times \\mathbf{B}$ and the phenomenological longitudinal and transverse relaxation with time constants $T_1$ and $T_2$. In the rotating frame, the effective angular frequency vector is $\\boldsymbol{\\Omega} = \\left[\\gamma B_{1x}, \\gamma B_{1y}, \\Delta \\omega \\right]$, where $\\gamma$ is the gyromagnetic ratio, $B_{1x}$ and $B_{1y}$ are the RF field components in Tesla, and $\\Delta \\omega$ is the frequency offset in radians per second. The Bloch equations with relaxation in the rotating frame are then\n$$\n\\frac{d}{dt}\n\\begin{bmatrix}\nM_x \\\\\nM_y \\\\\nM_z\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nM_y \\Omega_z - M_z \\Omega_y \\\\\nM_z \\Omega_x - M_x \\Omega_z \\\\\nM_x \\Omega_y - M_y \\Omega_x\n\\end{bmatrix}\n-\n\\begin{bmatrix}\nM_x/T_2 \\\\\nM_y/T_2 \\\\\n0\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n0 \\\\\n0 \\\\\n(M_0 - M_z)/T_1\n\\end{bmatrix},\n$$\nwith initial condition $\\mathbf{M}(0) = [0, 0, M_0]^\\top$.\n\nImplement a numerical solver for these equations over the pulse duration $t \\in [0, \\tau]$ for a rectangular RF pulse with constant $B_1$ applied along the rotating-frame $x$-axis (that is, $B_{1x} = B_1$, $B_{1y} = 0$) and constant detuning $\\Delta \\omega$. Use the gyromagnetic ratio of the hydrogen proton $\\gamma = 2\\pi \\times 42.57747892 \\times 10^6$ in $\\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$. Treat $T_1$ and $T_2$ as positive real numbers in seconds, with the special case that either may be $+\\infty$ (in which case the corresponding relaxation rate is zero). The target outputs for each test case are:\n- the transverse magnetization magnitude at the end of the pulse, $\\lVert M_{xy}(\\tau) \\rVert = \\sqrt{M_x(\\tau)^2 + M_y(\\tau)^2}$ in the same arbitrary units as $M_0$, and\n- the longitudinal component at the end of the pulse, $M_z(\\tau)$ in the same arbitrary units as $M_0$.\n\nNumerical and physical unit requirements:\n- Use seconds for time-related quantities ($\\tau$, $T_1$, $T_2$), Tesla for $B_1$, radians per second for $\\Delta \\omega$, and arbitrary but consistent magnetization units for $M_0$.\n- Angles must be in radians if any appear.\n- Express all outputs in the units specified here.\n- Round each reported float to $6$ decimal places.\n\nTest suite to implement and evaluate:\nFor each test, simulate only during the RF pulse interval $[0,\\tau]$ with the given constant parameters. Each test case is a tuple $(M_0, T_1, T_2, B_1, \\Delta \\omega, \\tau)$ with the following values:\n\n- Case A (on-resonance, moderate relaxation): $(1.0,\\; 1.2,\\; 0.080,\\; 2.934944\\times 10^{-6},\\; 0.0,\\; 0.002)$.\n- Case B (on-resonance, no relaxation): $(1.0,\\; +\\infty,\\; +\\infty,\\; 2.934944\\times 10^{-6},\\; 0.0,\\; 0.002)$.\n- Case C (off-resonance, moderate relaxation): $(1.0,\\; 1.2,\\; 0.080,\\; 2.934944\\times 10^{-6},\\; 2\\pi \\times 500,\\; 0.002)$.\n- Case D (on-resonance, short $T_2$): $(1.0,\\; 1.2,\\; 0.005,\\; 2.934944\\times 10^{-6},\\; 0.0,\\; 0.002)$.\n\nIn Case A, the RF amplitude $B_1$ is chosen such that, ignoring relaxation and detuning, the nominal flip angle would be $\\alpha = \\pi/2$ for the specified duration $\\tau$. Your code must use the numeric value listed. In Case B, $T_1$ and $T_2$ are $+\\infty$ to test the ideal, no-relaxation rotation. In Case C, use the specified nonzero detuning. In Case D, use a very short $T_2$.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list of lists, with each inner list containing the two floats $[\\lVert M_{xy}(\\tau) \\rVert, M_z(\\tau)]$ for a test case, in the same order as the test cases above.\n- All floats must be rounded to $6$ decimal places.\n- For example, the overall structure must look like $[[a_1,b_1],[a_2,b_2],[a_3,b_3],[a_4,b_4]]$ with no extra text.\n\nConstraints and guidance:\n- Do not assume any closed-form solution; use a numerical ordinary differential equation solver with appropriate tolerances for stability and accuracy.\n- Ensure correct handling of $T_1 = +\\infty$ or $T_2 = +\\infty$ by treating the corresponding relaxation rate as zero.\n- The program must be fully self-contained, use no external input, and adhere to the specified output format exactly.", "solution": "The problem is valid as it is scientifically grounded in the principles of nuclear magnetic resonance, is well-posed with a complete set of parameters and initial conditions, and is expressed in objective, formal language. It presents a standard computational physics task without any internal contradictions, ambiguities, or factual errors.\n\nThe problem requires the numerical solution of the Bloch equations in the rotating frame to determine the state of the net magnetization vector, $\\mathbf{M}$, after the application of a rectangular radiofrequency (RF) pulse. The solution proceeds by first defining the specific system of ordinary differential equations (ODEs) based on the problem statement, then employing a numerical ODE solver to find the magnetization state at the end of the pulse, and finally calculating the required output values.\n\nThe evolution of the magnetization vector $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$ in the rotating frame is governed by the Bloch equation, which incorporates both precession around an effective magnetic field and phenomenological relaxation processes. The general form of the equation is:\n$$\n\\frac{d\\mathbf{M}}{dt} = \\mathbf{M} \\times \\boldsymbol{\\Omega} + \\mathbf{R}(\\mathbf{M})\n$$\nHere, $\\boldsymbol{\\Omega}$ is the effective angular frequency vector and $\\mathbf{R}(\\mathbf{M})$ represents the relaxation terms.\n\nBased on the problem statement, the components of the $\\boldsymbol{\\Omega}$ vector are $\\boldsymbol{\\Omega} = [\\gamma B_{1x}, \\gamma B_{1y}, \\Delta \\omega]$. The RF pulse is specified as being constant and applied along the rotating-frame $x$-axis, which implies $B_{1x} = B_1$ and $B_{1y} = 0$. Thus, the effective angular frequency vector becomes:\n$$\n\\boldsymbol{\\Omega} = [\\gamma B_1, 0, \\Delta \\omega]^\\top\n$$\nFor convenience, we define the on-resonance nutation frequency as $\\omega_1 = \\gamma B_1$. The vector is then $\\boldsymbol{\\Omega} = [\\omega_1, 0, \\Delta \\omega]^\\top$.\n\nThe relaxation term $\\mathbf{R}(\\mathbf{M})$ combines transverse relaxation with time constant $T_2$ and longitudinal relaxation with time constant $T_1$ towards the equilibrium magnetization $M_0$. The full system of $3$ coupled first-order linear ODEs is given as:\n$$\n\\frac{d}{dt}\n\\begin{bmatrix}\nM_x \\\\\nM_y \\\\\nM_z\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nM_y \\Omega_z - M_z \\Omega_y \\\\\nM_z \\Omega_x - M_x \\Omega_z \\\\\nM_x \\Omega_y - M_y \\Omega_x\n\\end{bmatrix}\n-\n\\begin{bmatrix}\nM_x/T_2 \\\\\nM_y/T_2 \\\\\n0\n\\end{bmatrix}\n+\n\\begin{bmatrix}\n0 \\\\\n0 \\\\\n(M_0 - M_z)/T_1\n\\end{bmatrix}\n$$\nSubstituting the components of $\\boldsymbol{\\Omega}$ yields the specific system to be solved:\n$$\n\\frac{dM_x}{dt} = M_y (\\Delta \\omega) - M_z (0) - \\frac{M_x}{T_2} = \\Delta \\omega M_y - \\frac{M_x}{T_2}\n$$\n$$\n\\frac{dM_y}{dt} = M_z (\\omega_1) - M_x (\\Delta \\omega) - \\frac{M_y}{T_2} = \\omega_1 M_z - \\Delta \\omega M_x - \\frac{M_y}{T_2}\n$$\n$$\n\\frac{dM_z}{dt} = M_x (0) - M_y (\\omega_1) + \\frac{M_0 - M_z}{T_1} = -\\omega_1 M_y + \\frac{M_0 - M_z}{T_1}\n$$\nThis is a linear, time-invariant system of ODEs. The problem is an initial value problem (IVP), with the initial condition specified as the magnetization being fully aligned with the z-axis at thermal equilibrium: $\\mathbf{M}(0) = [0, 0, M_0]^\\top$.\n\nThe solution will be obtained by numerical integration over the time interval $t \\in [0, \\tau]$. We will utilize the `solve_ivp` function from the SciPy library, which is a high-quality, general-purpose ODE solver. A Python function will be implemented to represent the system of derivatives, taking the current time $t$, the magnetization state vector $\\mathbf{M}(t)$, and the set of physical parameters $(M_0, T_1, T_2, B_1, \\Delta \\omega)$ as input. This function will calculate the derivative vector $[dM_x/dt, dM_y/dt, dM_z/dt]^\\top$.\n\nThe gyromagnetic ratio for the proton is given as $\\gamma = 2\\pi \\times 42.57747892 \\times 10^6 \\, \\mathrm{rad}\\,\\mathrm{s}^{-1}\\,\\mathrm{T}^{-1}$. Special handling is required for the cases where $T_1$ or $T_2$ are infinite; in these instances, the corresponding relaxation rates, $R_1 = 1/T_1$ and $R_2 = 1/T_2$, are set to $0$.\n\nFor each test case provided, the `solve_ivp` function will be called with the appropriate parameters, initial condition vector $[0, 0, M_0]^\\top$, and the time span $[0, \\tau]$. High-precision relative and absolute tolerances (e.g., $10^{-8}$) will be used to ensure the accuracy of the numerical integration.\n\nUpon obtaining the solution, the magnetization vector at the final time, $\\mathbf{M}(\\tau) = [M_x(\\tau), M_y(\\tau), M_z(\\tau)]^\\top$, is extracted. From this final state, the two required output quantities are calculated:\n1. The magnitude of the transverse magnetization: $\\lVert M_{xy}(\\tau) \\rVert = \\sqrt{M_x(\\tau)^2 + M_y(\\tau)^2}$.\n2. The longitudinal magnetization component: $M_z(\\tau)$.\n\nThese two floating-point values are then rounded to $6$ decimal places as specified. The final program will format these results for all test cases into a single-line string representing a list of lists, adhering strictly to the required output format.", "answer": "```python\nimport numpy as np\nfrom scipy.integrate import solve_ivp\n\ndef solve():\n    \"\"\"\n    Numerically solves the Bloch equations for various test cases and formats the output.\n    \"\"\"\n    # Gyromagnetic ratio for hydrogen proton in rad/s/T\n    GAMMA = 2 * np.pi * 42.57747892e6\n\n    def bloch_ode(t, M, M0, T1, T2, B1, delta_omega):\n        \"\"\"\n        Defines the system of ordinary differential equations for magnetization dynamics\n        in the rotating frame.\n        \n        Args:\n            t (float): Current time (unused for this time-invariant system).\n            M (np.ndarray): Current magnetization vector [Mx, My, Mz].\n            M0 (float): Equilibrium magnetization.\n            T1 (float): Longitudinal relaxation time constant.\n            T2 (float): Transverse relaxation time constant.\n            B1 (float): RF magnetic field amplitude.\n            delta_omega (float): Frequency offset.\n            \n        Returns:\n            list: The derivatives [dMx/dt, dMy/dt, dMz/dt].\n        \"\"\"\n        Mx, My, Mz = M\n\n        # Handle potentially infinite relaxation times\n        R1 = 1 / T1 if not np.isinf(T1) and T1 > 0 else 0.0\n        R2 = 1 / T2 if not np.isinf(T2) and T2 > 0 else 0.0\n\n        # RF field in frequency units (rad/s)\n        omega1 = GAMMA * B1\n\n        # The Bloch equations in the rotating frame\n        dMxdt = delta_omega * My - R2 * Mx\n        dMydt = omega1 * Mz - delta_omega * Mx - R2 * My\n        dMzdt = -omega1 * My + R1 * (M0 - Mz)\n        \n        return [dMxdt, dMydt, dMzdt]\n\n    # Test cases as tuples: (M0, T1, T2, B1, delta_omega, tau)\n    test_cases = [\n        # Case A: on-resonance, moderate relaxation\n        (1.0, 1.2, 0.080, 2.934944e-6, 0.0, 0.002),\n        # Case B: on-resonance, no relaxation\n        (1.0, np.inf, np.inf, 2.934944e-6, 0.0, 0.002),\n        # Case C: off-resonance, moderate relaxation\n        (1.0, 1.2, 0.080, 2.934944e-6, 2 * np.pi * 500, 0.002),\n        # Case D: on-resonance, short T2\n        (1.0, 1.2, 0.005, 2.934944e-6, 0.0, 0.002),\n    ]\n\n    all_results = []\n    for M0, T1, T2, B1, delta_omega, tau in test_cases:\n        # Initial condition: magnetization at thermal equilibrium\n        M_initial = [0.0, 0.0, M0]\n        \n        # Time interval for the simulation\n        t_span = [0, tau]\n        \n        # Arguments to pass to the ODE function\n        ode_args = (M0, T1, T2, B1, delta_omega)\n        \n        # Numerically solve the ODE system\n        sol = solve_ivp(\n            bloch_ode,\n            t_span,\n            M_initial,\n            args=ode_args,\n            method='RK45',  # A robust Runge-Kutta solver\n            dense_output=True,\n            rtol=1e-9,  # High precision tolerances\n            atol=1e-9\n        )\n        \n        # Evaluate the solution at the end of the pulse (t = tau)\n        M_final = sol.sol(tau)\n        Mx_final, My_final, Mz_final = M_final\n        \n        # Calculate the required output values\n        Mxy_magnitude = np.sqrt(Mx_final**2 + My_final**2)\n        Mz_component = Mz_final\n        \n        # Store the rounded results\n        all_results.append([round(Mxy_magnitude, 6), round(Mz_component, 6)])\n\n    # Format the final output string exactly as required\n    formatted_pairs = [f\"[{pair[0]},{pair[1]}]\" for pair in all_results]\n    final_output_string = f\"[{','.join(formatted_pairs)}]\"\n    \n    print(final_output_string)\n\nsolve()\n```", "id": "4934146"}]}