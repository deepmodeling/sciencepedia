{"hands_on_practices": [{"introduction": "Creating specific image contrasts is fundamental to diagnostic Magnetic Resonance Imaging. This exercise explores how to generate a proton density (PD) weighted image by suppressing the influence of the longitudinal relaxation time, $T_1$. By adjusting the repetition time ($TR$), you will calculate the necessary conditions to allow for nearly full magnetization recovery, thereby isolating the signal's dependence on the number of protons in the tissue [@problem_id:4552293]. This practice reinforces the direct link between a key sequence parameter and the resulting image contrast, while also highlighting the practical trade-off between contrast purity and total scan time.", "problem": "A radiomics protocol must extract intensity features from brain Magnetic Resonance Imaging (MRI) in a manner that emphasizes proton density (PD) while minimizing longitudinal relaxation time ($T_1$) and transverse relaxation time ($T_2$) contrast. Consider a single-echo spin-echo acquisition with a short echo time ($TE$ is fixed and sufficiently small) and a baseline repetition time ($\\mathrm{TR}_0$) used for a $T_1$-weighted scan. The scan time for a two-dimensional acquisition with fixed matrix size and number of signal averages is directly proportional to the repetition time $\\,\\mathrm{TR}\\,$.\n\nThe imaged field contains white matter with longitudinal relaxation time $T_1 = 900\\,\\mathrm{ms}$, gray matter with longitudinal relaxation time $T_1 = 1400\\,\\mathrm{ms}$, and cerebrospinal fluid with longitudinal relaxation time $T_1 = 4000\\,\\mathrm{ms}$. Define a PD-dominant acquisition as one in which the tissue with the largest longitudinal relaxation time has recovered at least a fraction $f = 0.95$ of its equilibrium longitudinal magnetization by the time the next radiofrequency excitation is applied. The baseline repetition time is $\\mathrm{TR}_0 = 500\\,\\mathrm{ms}$.\n\nStarting from first principles of longitudinal relaxation and the standard spin-echo signal formation, derive the minimum repetition time $\\,\\mathrm{TR}_{\\min}\\,$ required to meet the PD-dominant criterion for the compartment with the largest $T_1$, and compute the relative scan time increase factor $R$, defined as $R = \\mathrm{TR}_{\\min}/\\mathrm{TR}_0$. Round your final value of $R$ to four significant figures and express it as a dimensionless factor.\n\nAdditionally, in your derivation, explain—using the mathematical form of longitudinal recovery and its rate—why lengthening $\\,\\mathrm{TR}\\,$ beyond the longest $T_1$ exhibits diminishing returns for further reducing residual $T_1$-weighting.", "solution": "The problem is valid as it is scientifically grounded in the principles of Magnetic Resonance Imaging (MRI), is well-posed with sufficient and consistent data, and is expressed in objective, formal language. We may therefore proceed with the solution.\n\nThe problem requires the derivation of a minimum repetition time, $\\mathrm{TR}_{\\min}$, for a proton density (PD)-dominant spin-echo acquisition and the subsequent calculation of the relative scan time increase factor, $R$.\n\nFirst, we establish the fundamental principles. The longitudinal magnetization, $M_z$, of a tissue with longitudinal relaxation time $T_1$ recovers following a $90^\\circ$ radiofrequency (RF) excitation pulse according to the Bloch equation solution:\n$$M_z(t) = M_0 \\left(1 - \\exp\\left(-\\frac{t}{T_1}\\right)\\right)$$\nwhere $M_0$ is the equilibrium magnetization, proportional to the proton density $\\rho$, and $t$ is the time elapsed since the excitation. In a spin-echo sequence, this recovery time is the repetition time, $\\mathrm{TR}$. Thus, the longitudinal magnetization available just before the next RF pulse is:\n$$M_z(\\mathrm{TR}) = M_0 \\left(1 - \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right)\\right)$$\n\nThe signal intensity $S$ in a spin-echo experiment is proportional to the transverse magnetization immediately after the $90^\\circ$ pulse, which is $M_z(\\mathrm{TR})$, and also depends on the transverse relaxation that occurs during the echo time, $\\mathrm{TE}$. The signal equation is:\n$$S \\propto \\rho \\left(1 - \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right)\\right) \\exp\\left(-\\frac{\\mathrm{TE}}{T_2}\\right)$$\nTo achieve a PD-dominant image, the contrast contributions from $T_1$ and $T_2$ must be minimized. The problem states that $\\mathrm{TE}$ is \"sufficiently small,\" which implies $\\mathrm{TE} \\ll T_2$ for all tissues. This makes the term $\\exp(-\\mathrm{TE}/T_2)$ approach $1$, thus minimizing $T_2$-weighting. To minimize $T_1$-weighting, the term $(1 - \\exp(-\\mathrm{TR}/T_1))$ must approach $1$. This requires $\\mathrm{TR} \\gg T_1$.\n\nThe problem provides a specific criterion for a PD-dominant acquisition: the tissue with the largest $T_1$ must recover at least a fraction $f=0.95$ of its equilibrium longitudinal magnetization. The fraction of recovery is given by $\\frac{M_z(\\mathrm{TR})}{M_0}$. The condition is therefore:\n$$\\frac{M_z(\\mathrm{TR})}{M_0} = 1 - \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right) \\geq f$$\nWe are asked to find the minimum $\\mathrm{TR}$, denoted $\\mathrm{TR}_{\\min}$, that satisfies this for the compartment with the largest $T_1$. The tissues provided are white matter ($T_1 = 900~\\mathrm{ms}$), gray matter ($T_1 = 1400~\\mathrm{ms}$), and cerebrospinal fluid (CSF) ($T_1 = 4000~\\mathrm{ms}$). The largest $T_1$ is that of CSF, so we set $T_{1,\\text{max}} = 4000~\\mathrm{ms}$.\n\nTo find the minimum TR, we use the equality:\n$$1 - \\exp\\left(-\\frac{\\mathrm{TR}_{\\min}}{T_{1,\\text{max}}}\\right) = f$$\nWe now solve for $\\mathrm{TR}_{\\min}$:\n$$\\exp\\left(-\\frac{\\mathrm{TR}_{\\min}}{T_{1,\\text{max}}}\\right) = 1 - f$$\nTaking the natural logarithm of both sides:\n$$-\\frac{\\mathrm{TR}_{\\min}}{T_{1,\\text{max}}} = \\ln(1 - f)$$\n$$\\mathrm{TR}_{\\min} = -T_{1,\\text{max}} \\ln(1 - f)$$\nSubstituting the given values, $T_{1,\\text{max}} = 4000~\\mathrm{ms}$ and $f = 0.95$:\n$$\\mathrm{TR}_{\\min} = -4000 \\ln(1 - 0.95) = -4000 \\ln(0.05)~\\mathrm{ms}$$\nUsing the property $\\ln(x) = -\\ln(1/x)$, we can write:\n$$\\mathrm{TR}_{\\min} = 4000 \\ln\\left(\\frac{1}{0.05}\\right) = 4000 \\ln(20)~\\mathrm{ms}$$\n\nNext, we compute the relative scan time increase factor, $R$, which is defined as $R = \\mathrm{TR}_{\\min}/\\mathrm{TR}_0$. The baseline repetition time is given as $\\mathrm{TR}_0 = 500~\\mathrm{ms}$.\n$$R = \\frac{\\mathrm{TR}_{\\min}}{\\mathrm{TR}_0} = \\frac{-T_{1,\\text{max}} \\ln(1 - f)}{\\mathrm{TR}_0}$$\nSubstituting the numerical values:\n$$R = \\frac{-4000~\\mathrm{ms} \\times \\ln(0.05)}{500~\\mathrm{ms}} = -8 \\ln(0.05) = 8 \\ln(20)$$\nTo obtain the numerical value, we use $\\ln(20) \\approx 2.99573227$.\n$$R = 8 \\times 2.99573227 \\approx 23.965858$$\nRounding this result to four significant figures gives $23.97$.\n\nFinally, we address the question of why lengthening $\\mathrm{TR}$ beyond the longest $T_1$ exhibits diminishing returns for reducing residual $T_1$-weighting. The degree of $T_1$-weighting is determined by how much the factor $g(\\mathrm{TR}) = 1 - \\exp(-\\mathrm{TR}/T_1)$ deviates from $1$. The \"return\" on increasing $\\mathrm{TR}$ is the increase in this factor, which brings the signal closer to its pure PD-dependence. We can analyze this by examining the rate of change of $g(\\mathrm{TR})$ with respect to $\\mathrm{TR}$:\n$$\\frac{dg}{d\\mathrm{TR}} = \\frac{d}{d\\mathrm{TR}}\\left(1 - \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right)\\right) = -\\left(-\\frac{1}{T_1}\\right) \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right) = \\frac{1}{T_1} \\exp\\left(-\\frac{\\mathrm{TR}}{T_1}\\right)$$\nThis derivative represents the marginal gain in signal recovery per unit increase in TR. The function $\\exp(-\\mathrm{TR}/T_1)$ is an exponentially decaying function of $\\mathrm{TR}$.\n- When $\\mathrm{TR}$ is short (e.g., $\\mathrm{TR} \\ll T_1$), the exponential term is close to $1$, and the rate of recovery is significant (close to $1/T_1$). Small increases in $\\mathrm{TR}$ lead to large reductions in $T_1$-weighting.\n- When $\\mathrm{TR}$ becomes long (e.g., $\\mathrm{TR} > 3T_1$, where recovery is already $>95\\%$), the term $\\exp(-\\mathrm{TR}/T_1)$ becomes very small. Consequently, the rate of recovery, $\\frac{1}{T_1} \\exp(-\\mathrm{TR}/T_1)$, approaches zero.\nThis means that for very long $\\mathrm{TR}$ values, each additional millisecond added to TR yields a progressively smaller increase in longitudinal magnetization recovery. Since scan time is directly proportional to $\\mathrm{TR}$, this translates to a poor trade-off: large increases in scan time produce negligible reductions in the already small residual $T_1$-weighting. This is the principle of diminishing returns. For instance, increasing TR from $3T_1$ to $4T_1$ increases recovery from $95.02\\%$ to $98.17\\%$, a gain of about $3.15\\%$. Increasing TR from $4T_1$ to $5T_1$ increases recovery from $98.17\\%$ to $99.33\\%$, a gain of only about $1.16\\%$. The cost in scan time for each percentage point of gain becomes increasingly prohibitive.", "answer": "$$\\boxed{23.97}$$", "id": "4552293"}, {"introduction": "A central task in quantitative MRI is the accurate measurement of tissue-specific relaxation properties. This practice illuminates the critical distinction between the true transverse relaxation time, $T_2$, and the apparent transverse relaxation time, $T_2^*$, which is influenced by magnetic field inhomogeneities. You will derive and quantify the systematic error, or bias, that occurs when a gradient-echo sequence is mistakenly used for $T_2$ mapping [@problem_id:4552356]. This exercise clarifies why spin-echo sequences are essential for accurate $T_2$ measurement and how sequence choice directly impacts the biophysical interpretation of imaging data.", "problem": "A radiomics pipeline aims to produce transverse relaxation maps for a brain study performed at a static magnetic field of $B_0$ using a multi-echo acquisition. Due to an implementation oversight, the pipeline fits a monoexponential decay to magnitude data from a multi-echo gradient-echo acquisition to estimate transverse relaxation time, labeling the resulting parameter as $T_2$. The target tissue voxel of interest is well-modeled as a single compartment with constant proton density and is imaged under fully relaxed conditions so that $TR \\gg T_1$ and radiofrequency flip angles and refocusing pulses do not introduce additional weighting. Neglect diffusion and flow.\n\nUse only the following fundamental bases:\n- Under fully relaxed conditions, the spin-echo signal as a function of echo time $TE$ decays as $S_{\\mathrm{SE}}(TE) = S_0 \\rho \\exp(-TE/T_2)$, where $S_0$ is a system constant and $\\rho$ is the proton density.\n- Under fully relaxed conditions, the gradient-echo signal experiences both irreversible spin-spin dephasing characterized by $T_2$ and reversible dephasing due to static field inhomogeneity characterized by a time constant $T_2'$. Treat these two decoherence processes as independent exponential decays that multiply in time.\n\nDefine the bias of the pipeline’s $T_2$ estimate as $B \\equiv \\hat{T}_2^{(\\mathrm{GRE})} - T_2$, where $\\hat{T}_2^{(\\mathrm{GRE})}$ is the parameter obtained by monoexponential fitting of the gradient-echo signal versus $TE$ and $T_2$ is the true irreversible transverse relaxation time of the tissue as it would be measured by an ideal spin-echo sequence. Assume noise-free data and perfect monoexponential fitting.\n\n1. Derive an analytical expression for $B$ in terms of $T_2$ and $T_2'$ starting from the stated signal models and the independence of the two exponential decays in the gradient-echo signal.\n2. For a tissue with true $T_2 = 65$ milliseconds and reversible dephasing time $T_2' = 35$ milliseconds, evaluate $B$. Round your final numerical answer to four significant figures. Express the final bias in milliseconds.", "solution": "The problem statement is evaluated as valid. It is scientifically grounded in the principles of magnetic resonance imaging (MRI), specifically the distinction between spin-echo and gradient-echo signal decay. The problem is well-posed, providing all necessary definitions, models, and data to derive a unique solution. The language is objective and precise.\n\nThe first step is to derive the analytical expression for the bias, $B$. We are given the fundamental signal models and the composition of decoherence processes.\n\nThe spin-echo (SE) signal, which accounts only for irreversible spin-spin relaxation, is given by:\n$$S_{\\mathrm{SE}}(TE) = S_0 \\rho \\exp\\left(-\\frac{TE}{T_2}\\right)$$\nHere, $TE$ is the echo time, $T_2$ is the true transverse relaxation time, $S_0$ is a proportionality constant, and $\\rho$ is the proton density.\n\nThe gradient-echo (GRE) signal is subject to both the irreversible dephasing characterized by $T_2$ and an additional reversible dephasing due to static magnetic field inhomogeneities, characterized by the time constant $T_2'$. The problem states these two processes are independent exponential decays that multiply. Therefore, the GRE signal, $S_{\\mathrm{GRE}}(TE)$, can be expressed as:\n$$S_{\\mathrm{GRE}}(TE) = \\left(S_0 \\rho \\exp\\left(-\\frac{TE}{T_2}\\right)\\right) \\times \\exp\\left(-\\frac{TE}{T_2'}\\right)$$\nCombining the exponential terms, we get:\n$$S_{\\mathrm{GRE}}(TE) = S_0 \\rho \\exp\\left(-\\frac{TE}{T_2} - \\frac{TE}{T_2'}\\right)$$\nFactoring out $-TE$ from the exponent yields:\n$$S_{\\mathrm{GRE}}(TE) = S_0 \\rho \\exp\\left(-TE \\left(\\frac{1}{T_2} + \\frac{1}{T_2'}\\right)\\right)$$\nThis equation is in the form of a monoexponential decay, $S(TE) = A \\exp(-TE/\\tau)$, where $A=S_0 \\rho$ and the effective decay time constant $\\tau$ is given by the relation:\n$$\\frac{1}{\\tau} = \\frac{1}{T_2} + \\frac{1}{T_2'}$$\nThe problem states that the radiomics pipeline performs a monoexponential fit to the GRE signal and calls the resulting time constant $\\hat{T}_2^{(\\mathrm{GRE})}$. By definition of the fit, this estimated parameter must be equal to the effective time constant $\\tau$. In standard MRI terminology, this effective transverse relaxation time for a GRE sequence is denoted $T_2^*$. Thus:\n$$\\hat{T}_2^{(\\mathrm{GRE})} = T_2^* = \\tau$$\nWe can now express $\\hat{T}_2^{(\\mathrm{GRE})}$ in terms of $T_2$ and $T_2'$. From the rate addition formula:\n$$\\frac{1}{\\hat{T}_2^{(\\mathrm{GRE})}} = \\frac{1}{T_2} + \\frac{1}{T_2'} = \\frac{T_2' + T_2}{T_2 T_2'}$$\nInverting this expression gives the estimated relaxation time:\n$$\\hat{T}_2^{(\\mathrm{GRE})} = \\frac{T_2 T_2'}{T_2 + T_2'}$$\nThe problem defines the bias $B$ as the difference between this estimated value and the true $T_2$ value:\n$$B \\equiv \\hat{T}_2^{(\\mathrm{GRE})} - T_2$$\nSubstituting our expression for $\\hat{T}_2^{(\\mathrm{GRE})}$ into the definition of bias:\n$$B = \\frac{T_2 T_2'}{T_2 + T_2'} - T_2$$\nTo simplify, we find a common denominator:\n$$B = \\frac{T_2 T_2'}{T_2 + T_2'} - \\frac{T_2 (T_2 + T_2')}{T_2 + T_2'}$$\n$$B = \\frac{T_2 T_2' - T_2^2 - T_2 T_2'}{T_2 + T_2'}$$\nThe term $T_2 T_2'$ cancels in the numerator, leading to the final analytical expression for the bias:\n$$B = \\frac{-T_2^2}{T_2 + T_2'}$$\nThis completes the first part of the problem. This result demonstrates that the estimate from the GRE signal, $\\hat{T}_2^{(\\mathrm{GRE})}$, is always an underestimate of the true $T_2$ (since $T_2$ and $T_2'$ are positive quantities), resulting in a negative bias.\n\nFor the second part, we must evaluate $B$ for the given tissue parameters:\nTrue transverse relaxation time, $T_2 = 65$ ms.\nReversible dephasing time, $T_2' = 35$ ms.\n\nSubstituting these numerical values into our derived expression for $B$:\n$$B = \\frac{-(65)^2}{65 + 35}$$\nAll values are in milliseconds, so the resulting bias will also be in milliseconds.\nFirst, calculate the denominator:\n$$65 + 35 = 100$$\nNext, calculate the numerator:\n$$-(65)^2 = -4225$$\nNow, compute the bias:\n$$B = \\frac{-4225}{100} = -42.25$$\nThe problem requires the answer to be rounded to four significant figures. The calculated value $-42.25$ already has four significant figures. Therefore, the bias $B$ is $-42.25$ ms.", "answer": "$$\\boxed{-42.25}$$", "id": "4552356"}, {"introduction": "The reliability of radiomics hinges on the stability and reproducibility of quantitative image features across different acquisition settings. This computational exercise bridges the gap between the fundamental physics of MRI signal decay and the practical challenge of feature robustness. By modeling how signal intensity scales with echo time ($TE$), you will predict and empirically verify the behavior of texture features derived from a Laplacian of Gaussian (LoG) filter [@problem_id:4552340]. This hands-on coding problem demonstrates how an understanding of the underlying image formation process is crucial for designing and validating robust quantitative imaging biomarkers.", "problem": "You are given a synthetic two-dimensional image model and asked to analyze the stability of Laplacian of Gaussian (LoG) filter–based radiomic features across echo time settings in Magnetic Resonance Imaging (MRI). Radiomics (quantitative image feature extraction) aims to capture robust descriptors of image patterns. Here, the image contrast is controlled by transverse relaxation (described by the parameter $T_2$), and the echo time $TE$ determines the amplitude of the signal at the time of acquisition. Use the following scientifically established base: under a spin-echo acquisition and echo time $TE$, the transverse magnetization decays exponentially with time constant $T_2$, so the signal amplitude scales as $e^{-TE/T_2}$ when other parameters are fixed.\n\nConstruct a $128 \\times 128$ phantom image $\\mathcal{I}_0$ with a centered square of side length $64$ pixels having proton density $PD = 1$ and a uniform background with proton density $PD = 0$. Define the observed image at echo time $TE$ and relaxation time $T_2$ as\n$$\n\\mathcal{I}(TE, T_2) = \\mathcal{I}_0 \\cdot e^{-TE/T_2},\n$$\nwhere both $TE$ and $T_2$ are in milliseconds, and the exponential argument uses the same unit so that the ratio $TE/T_2$ is dimensionless.\n\nDefine the Laplacian of Gaussian (LoG) filter $L_\\sigma[\\cdot]$ with scale parameter $\\sigma$ measured in pixels. For any image $\\mathcal{I}$, define two radiomic features computed from the LoG response:\n1. The absolute response sum (an $L^1$-type feature):\n$$\nF_1(\\mathcal{I}; \\sigma) = \\sum_{x,y} \\left| L_\\sigma[\\mathcal{I}](x,y) \\right|.\n$$\n2. The energy of the response (an $L^2$-type feature):\n$$\nF_2(\\mathcal{I}; \\sigma) = \\sum_{x,y} \\left( L_\\sigma[\\mathcal{I}](x,y) \\right)^2.\n$$\n\nYou must reason from first principles about how the exponential contrast amplitude scaling and the linearity of the LoG operator determine the expected scaling of $F_1$ and $F_2$ as $TE$ changes. Based on that derivation, define, for a baseline at $TE_0 = 0\\,\\mathrm{ms}$,\n$$\nR_i(TE, T_2; \\sigma) = \\frac{F_i\\big(\\mathcal{I}(TE, T_2); \\sigma\\big)}{F_i\\big(\\mathcal{I}(TE_0, T_2); \\sigma\\big)} \\quad \\text{for } i \\in \\{1,2\\},\n$$\nand compute the deviation (error) between the empirically measured ratio $R_i(TE, T_2; \\sigma)$ and the theoretically predicted ratio obtained from your derivation. Report this deviation as a non-negative real number (a float), i.e., the absolute difference between the measured and predicted ratios.\n\nPhysical units: $TE$ and $T_2$ must be treated in milliseconds, and the final deviation values are dimensionless. Angles are not involved. Express all final answers as floats (decimal numbers).\n\nImplement the LoG operator with a Gaussian scale $\\sigma$ in pixels. Use the entire image domain in the sums. Assume idealized conditions where $T_2$ is uniform across the image and $PD$ is exactly as defined.\n\nYour program should evaluate the following test suite of parameter sets, each given as a tuple $(TE, T_2, \\sigma, i)$, where $i$ is the feature index ($1$ for $F_1$, $2$ for $F_2$):\n\n- Case A (baseline check, happy path): $(0 \\ \\mathrm{ms}, 80 \\ \\mathrm{ms}, 1.5, 1)$\n- Case B (moderate decay, feature $F_1$): $(60 \\ \\mathrm{ms}, 80 \\ \\mathrm{ms}, 1.5, 1)$\n- Case C (strong decay, feature $F_2$): $(120 \\ \\mathrm{ms}, 60 \\ \\mathrm{ms}, 2.0, 2)$\n- Case D (strong decay, small $\\sigma$, feature $F_1$): $(200 \\ \\mathrm{ms}, 100 \\ \\mathrm{ms}, 0.8, 1)$\n- Case E (weak decay, large $\\sigma$, feature $F_2$): $(20 \\ \\mathrm{ms}, 300 \\ \\mathrm{ms}, 3.0, 2)$\n\nFor each case, compute the absolute deviation between the measured ratio and the theoretically predicted ratio. Your program should produce a single line of output containing the deviations as a comma-separated list enclosed in square brackets (e.g., \"[dA,dB,dC,dD,dE]\"), in the order of the cases listed above. The final numerical outputs must be floats in dimensionless units.", "solution": "The problem requires an analysis of the stability of two radiomic features, derived from the Laplacian of Gaussian (LoG) filter response, with respect to changes in MRI echo time ($TE$). We must first derive the theoretical scaling behavior of these features and then compare this theory to empirical measurements from a synthetic phantom image, quantifying any deviation.\n\nThe image signal intensity is given to scale with echo time $TE$ and transverse relaxation time $T_2$ according to the exponential decay model $e^{-TE/T_2}$. The problem defines the observed image $\\mathcal{I}(TE, T_2)$ based on a proton density phantom $\\mathcal{I}_0$ as:\n$$\n\\mathcal{I}(TE, T_2) = \\mathcal{I}_0 \\cdot e^{-TE/T_2}\n$$\nHere, $\\mathcal{I}_0$ is a $128 \\times 128$ image with a centered $64 \\times 64$ square of value $1$ and a background of $0$. The term $e^{-TE/T_2}$ is a scalar multiplier that uniformly scales the intensity of the entire image.\n\nThe two radiomic features, $F_1$ and $F_2$, are computed from the response of the LoG filter, $L_\\sigma[\\cdot]$, applied to an image $\\mathcal{I}$:\n$$\nF_1(\\mathcal{I}; \\sigma) = \\sum_{x,y} \\left| L_\\sigma[\\mathcal{I}](x,y) \\right|\n$$\n$$\nF_2(\\mathcal{I}; \\sigma) = \\sum_{x,y} \\left( L_\\sigma[\\mathcal{I}](x,y) \\right)^2\n$$\n\nThe central principle for our theoretical derivation is the linearity of the Laplacian of Gaussian operator. The LoG filter is a composition of two linear operations: convolution with a Gaussian kernel and application of the Laplacian differential operator ($\\nabla^2$). The composition of linear operators is itself linear. Therefore, for any image $\\mathcal{I}$ and any scalar constant $c$, the following property holds:\n$$\nL_\\sigma[c \\cdot \\mathcal{I}] = c \\cdot L_\\sigma[\\mathcal{I}]\n$$\n\nWe apply this property to our image model. Let the scalar constant be $c = e^{-TE/T_2}$. Then the LoG response of the image at a given echo time $TE$ is:\n$$\nL_\\sigma[\\mathcal{I}(TE, T_2)] = L_\\sigma[\\mathcal{I}_0 \\cdot e^{-TE/T_2}] = e^{-TE/T_2} \\cdot L_\\sigma[\\mathcal{I}_0]\n$$\nThe baseline image is defined at $TE_0 = 0\\,\\mathrm{ms}$. At this echo time, the scalar multiplier is $e^{-0/T_2} = 1$. Thus, the baseline image is $\\mathcal{I}(TE_0, T_2) = \\mathcal{I}_0$, and its LoG response is $L_\\sigma[\\mathcal{I}_0]$.\n\nWith this relationship, we can derive the theoretical scaling for each feature.\n\nFor feature $F_1$:\n$$\nF_1(\\mathcal{I}(TE, T_2); \\sigma) = \\sum_{x,y} \\left| L_\\sigma[\\mathcal{I}(TE, T_2)](x,y) \\right| = \\sum_{x,y} \\left| e^{-TE/T_2} \\cdot L_\\sigma[\\mathcal{I}_0](x,y) \\right|\n$$\nSince $TE \\ge 0$ and $T_2 > 0$, the exponential term $e^{-TE/T_2}$ is always non-negative. We can factor it out of the absolute value and the summation:\n$$\nF_1(\\mathcal{I}(TE, T_2); \\sigma) = e^{-TE/T_2} \\sum_{x,y} \\left| L_\\sigma[\\mathcal{I}_0](x,y) \\right|\n$$\nThe summation term is simply the feature $F_1$ evaluated on the baseline image, which is $F_1(\\mathcal{I}(TE_0, T_2); \\sigma)$. Therefore:\n$$\nF_1(\\mathcal{I}(TE, T_2); \\sigma) = e^{-TE/T_2} \\cdot F_1(\\mathcal{I}(TE_0, T_2); \\sigma)\n$$\nThe theoretically predicted ratio $R_{1, \\text{theory}}$ is:\n$$\nR_{1, \\text{theory}}(TE, T_2; \\sigma) = \\frac{F_1(\\mathcal{I}(TE, T_2); \\sigma)}{F_1(\\mathcal{I}(TE_0, T_2); \\sigma)} = e^{-TE/T_2}\n$$\n\nFor feature $F_2$:\n$$\nF_2(\\mathcal{I}(TE, T_2); \\sigma) = \\sum_{x,y} \\left( L_\\sigma[\\mathcal{I}(TE, T_2)](x,y) \\right)^2 = \\sum_{x,y} \\left( e^{-TE/T_2} \\cdot L_\\sigma[\\mathcal{I}_0](x,y) \\right)^2\n$$\nWe can separate the squared terms and factor out the constant exponential factor:\n$$\nF_2(\\mathcal{I}(TE, T_2); \\sigma) = \\left(e^{-TE/T_2}\\right)^2 \\sum_{x,y} \\left( L_\\sigma[\\mathcal{I}_0](x,y) \\right)^2 = e^{-2 \\cdot TE/T_2} \\sum_{x,y} \\left( L_\\sigma[\\mathcal{I}_0](x,y) \\right)^2\n$$\nThe summation is the feature $F_2$ evaluated on the baseline image, $F_2(\\mathcal{I}(TE_0, T_2); \\sigma)$. So:\n$$\nF_2(\\mathcal{I}(TE, T_2); \\sigma) = e^{-2 \\cdot TE/T_2} \\cdot F_2(\\mathcal{I}(TE_0, T_2); \\sigma)\n$$\nThe theoretically predicted ratio $R_{2, \\text{theory}}$ is:\n$$\nR_{2, \\text{theory}}(TE, T_2; \\sigma) = \\frac{F_2(\\mathcal{I}(TE, T_2); \\sigma)}{F_2(\\mathcal{I}(TE_0, T_2); \\sigma)} = e^{-2 \\cdot TE/T_2}\n$$\n\nThe computational part of the problem is to calculate the deviation between these perfect theoretical ratios and the empirically measured ratios for each test case. The procedure is as follows:\n1.  For each test case $(TE, T_2, \\sigma, i)$, determine the appropriate theoretical ratio, $R_{i, \\text{theory}}$, using the formulas derived above.\n2.  Generate the base phantom image $\\mathcal{I}_0$.\n3.  The baseline image is $\\mathcal{I}_{\\text{baseline}} = \\mathcal{I}(TE_0, T_2) = \\mathcal{I}_0$.\n4.  Generate the test image $\\mathcal{I}_{\\text{test}} = \\mathcal{I}(TE, T_2) = \\mathcal{I}_0 \\cdot e^{-TE/T_2}$.\n5.  Apply the LoG filter with scale $\\sigma$ to both $\\mathcal{I}_{\\text{baseline}}$ and $\\mathcal{I}_{\\text{test}}$ to get their respective LoG responses. This is performed numerically using `scipy.ndimage.gaussian_laplace`.\n6.  Calculate the feature values $F_i(\\mathcal{I}_{\\text{baseline}}; \\sigma)$ and $F_i(\\mathcal{I}_{\\text{test}}; \\sigma)$ by summing over the pixels of the LoG response images according to the definitions of $F_1$ and $F_2$.\n7.  Compute the measured ratio $R_{i, \\text{measured}} = F_i(\\mathcal{I}_{\\text{test}}; \\sigma) / F_i(\\mathcal{I}_{\\text{baseline}}; \\sigma)$. The denominator is non-zero as LoG applied to a non-constant image yields a non-zero result.\n8.  The final deviation is the absolute difference: $\\Delta_i = |R_{i, \\text{measured}} - R_{i, \\text{theory}}|$.\n\nThis deviation, while theoretically zero, will be a small non-negative number in practice due to floating-point arithmetic precision and numerical approximations inherent in the discrete convolution algorithm. The program will implement this full procedure for all specified test cases. For Case A, where $TE=0$, both the measured and theoretical ratios are exactly $1$, so their deviation is exactly $0$.", "answer": "```python\nimport numpy as np\nfrom scipy.ndimage import gaussian_laplace\n\ndef solve():\n    \"\"\"\n    Solves the radiomic feature stability problem by comparing theoretical and empirical ratios.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        (0.0, 80.0, 1.5, 1),   # Case A\n        (60.0, 80.0, 1.5, 1),   # Case B\n        (120.0, 60.0, 2.0, 2),  # Case C\n        (200.0, 100.0, 0.8, 1),  # Case D\n        (20.0, 300.0, 3.0, 2),  # Case E\n    ]\n\n    results = []\n\n    # Create the base phantom image, I_0\n    img_size = 128\n    square_size = 64\n    I0 = np.zeros((img_size, img_size), dtype=np.float64)\n    start_idx = (img_size - square_size) // 2\n    end_idx = start_idx + square_size\n    I0[start_idx:end_idx, start_idx:end_idx] = 1.0\n\n    for te, t2, sigma, i in test_cases:\n        # Step 1: Calculate the theoretically predicted ratio.\n        if i == 1:\n            predicted_ratio = np.exp(-te / t2)\n        elif i == 2:\n            predicted_ratio = np.exp(-2.0 * te / t2)\n        else:\n            # This path should not be taken with the given test cases.\n            raise ValueError(f\"Invalid feature index: {i}\")\n\n        # Step 2: Empirically measure the ratio.\n        # The baseline image for ratio calculation corresponds to TE_0 = 0 ms, which is I0.\n        # Apply LoG filter to the baseline image.\n        log_response_base = gaussian_laplace(I0, sigma=sigma)\n        \n        # Calculate the feature value for the baseline image.\n        if i == 1:\n            F_base = np.sum(np.abs(log_response_base))\n        else: # i == 2\n            F_base = np.sum(np.square(log_response_base))\n\n        # Generate the test image for the given TE.\n        I_test = I0 * np.exp(-te / t2)\n        \n        # Apply LoG filter to the test image.\n        log_response_test = gaussian_laplace(I_test, sigma=sigma)\n\n        # Calculate the feature value for the test image.\n        if i == 1:\n            F_test = np.sum(np.abs(log_response_test))\n        else: # i == 2\n            F_test = np.sum(np.square(log_response_test))\n            \n        # Compute the measured ratio.\n        # For a non-trivial image, F_base is guaranteed to be non-zero.\n        if F_base == 0:\n            # Defensive check, though not expected for this problem's setup.\n            # If the base feature is 0, the test feature will also be 0, making the ratio indeterminate.\n            # For TE=0, they are equal, ratio is 1. If TE>0 and F_base=0, something is wrong.\n            # We assume F_base > 0 based on the problem's nature.\n            measured_ratio = 1.0 if F_test == 0.0 else np.inf\n        else:\n            measured_ratio = F_test / F_base\n\n        # Step 3: Compute the deviation.\n        deviation = np.abs(measured_ratio - predicted_ratio)\n        results.append(deviation)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4552340"}]}