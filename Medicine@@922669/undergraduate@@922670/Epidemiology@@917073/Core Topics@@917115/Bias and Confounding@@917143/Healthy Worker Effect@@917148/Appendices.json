{"hands_on_practices": [{"introduction": "The healthy worker effect can systematically distort our findings when comparing an occupational cohort to the general population. This first exercise provides a quantitative look at this bias by deriving how the Standardized Mortality Ratio ($SMR$) is influenced by the underlying health differences between workers and the public. By working through this problem [@problem_id:4597939], you will formalize the concept of the healthy worker effect and calculate the exact magnitude of the resulting bias in a hypothetical cohort study.", "problem": "A manufacturing cohort study seeks to quantify the magnitude of selection bias due to the healthy worker effect when estimating the effect of a hazardous exposure on all-cause mortality. Consider a cohort of exposed workers, partitioned into $2$ strata by time since hire: stratum $i=1$ with $t<5$ years and stratum $i=2$ with $t \\ge 5$ years. Let $r_{g,i}$ denote the all-cause mortality rate in the general population for stratum $i$, $s_i$ denote the multiplicative selection factor capturing the healthy worker effect such that unexposed workers in stratum $i$ have baseline rate $r_{u,i} = s_i \\, r_{g,i}$ with $0 < s_i < 1$, and $RR_{\\text{true}}$ denote the true causal rate ratio for exposure relative to no exposure within workers that is constant across strata. Let $\\text{PY}_i$ denote the person-years (PY) contributed by the exposed workers in stratum $i$.\n\nUsing only core definitions of incidence rate, expected events under indirect standardization, and the Standardized Mortality Ratio (SMR), derive an expression for the observed SMR of the exposed cohort versus the general population as a function of $RR_{\\text{true}}$, $\\{s_i\\}$, $\\{r_{g,i}\\}$, and $\\{\\text{PY}_i\\}$. Define the bias magnitude $B$ as $B = RR_{\\text{obs}}/RR_{\\text{true}}$, where $RR_{\\text{obs}}$ is the observed SMR. Then, using the following scientifically plausible values, compute $B$:\n\n- Stratum $1$: $\\text{PY}_1 = 30{,}000$, $r_{g,1} = 0.004 \\text{ per PY}$, $s_1 = 0.50$.\n- Stratum $2$: $\\text{PY}_2 = 70{,}000$, $r_{g,2} = 0.010 \\text{ per PY}$, $s_2 = 0.80$.\n\nExpress your final answer as a unitless number and round to four significant figures.", "solution": "The problem is subjected to validation and is determined to be a valid, well-posed problem in epidemiology. It is scientifically grounded in the principles of cohort studies, selection bias (specifically, the healthy worker effect), and indirect standardization. All necessary parameters and definitions are provided, and the numerical values are plausible.\n\nThe objective is to derive an expression for the observed Standardized Mortality Ratio (SMR) and then to compute the bias magnitude, $B$, defined as the ratio of the observed SMR to the true causal rate ratio, $RR_{\\text{true}}$.\n\nFirst, we define the components of the SMR. The SMR is the ratio of the total observed deaths in the cohort to the total expected deaths.\n$$\n\\text{SMR} = \\frac{\\text{Observed Events}}{\\text{Expected Events}} = \\frac{O_{\\text{total}}}{E_{\\text{total}}}\n$$\n\nThe total observed events, $O_{\\text{total}}$, is the sum of observed events across all strata. The number of observed events in a given stratum $i$, denoted $O_i$, is the product of the mortality rate in the exposed workers of that stratum, $r_{e,i}$, and the person-years, $\\text{PY}_i$.\n$$\nO_i = r_{e,i} \\cdot \\text{PY}_i\n$$\nThe rate $r_{e,i}$ is related to the rate in unexposed workers, $r_{u,i}$, by the true causal rate ratio, $RR_{\\text{true}}$. The problem states this relationship is constant across strata:\n$$\nRR_{\\text{true}} = \\frac{r_{e,i}}{r_{u,i}} \\implies r_{e,i} = RR_{\\text{true}} \\cdot r_{u,i}\n$$\nThe rate in unexposed workers, $r_{u,i}$, is influenced by the healthy worker effect, represented by the selection factor $s_i$, relative to the general population rate $r_{g,i}$:\n$$\nr_{u,i} = s_i \\cdot r_{g,i}\n$$\nBy substitution, we find the mortality rate in the exposed workers as a function of the general population rate, the selection factor, and the true rate ratio:\n$$\nr_{e,i} = RR_{\\text{true}} \\cdot (s_i \\cdot r_{g,i})\n$$\nThe total number of observed events is the sum over all strata:\n$$\nO_{\\text{total}} = \\sum_{i} O_i = \\sum_{i} (r_{e,i} \\cdot \\text{PY}_i) = \\sum_{i} (RR_{\\text{true}} \\cdot s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)\n$$\n\nNext, we calculate the total expected events, $E_{\\text{total}}$. This is determined by applying the stratum-specific mortality rates of the reference (general) population, $r_{g,i}$, to the person-years of the study cohort in each stratum. The expected events in stratum $i$, denoted $E_i$, is:\n$$\nE_i = r_{g,i} \\cdot \\text{PY}_i\n$$\nThe total expected events is the sum over all strata:\n$$\nE_{\\text{total}} = \\sum_{i} E_i = \\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)\n$$\n\nNow, we can derive the expression for the SMR by substituting the expressions for $O_{\\text{total}}$ and $E_{\\text{total}}$:\n$$\n\\text{SMR} = \\frac{\\sum_{i} (RR_{\\text{true}} \\cdot s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\nSince $RR_{\\text{true}}$ is a constant, it can be factored out of the summation in the numerator:\n$$\n\\text{SMR} = RR_{\\text{true}} \\cdot \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\nThis is the required expression for the observed SMR.\n\nThe problem defines the observed rate ratio as $RR_{\\text{obs}} = \\text{SMR}$ and the bias magnitude as $B = RR_{\\text{obs}}/RR_{\\text{true}}$. Substituting our expression for SMR gives:\n$$\nB = \\frac{\\text{SMR}}{RR_{\\text{true}}} = \\frac{1}{RR_{\\text{true}}} \\left( RR_{\\text{true}} \\cdot \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)} \\right)\n$$\nThe $RR_{\\text{true}}$ terms cancel, yielding the expression for the bias magnitude:\n$$\nB = \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\nThis demonstrates that the bias factor $B$ is a weighted average of the stratum-specific selection factors $\\{s_i\\}$, where the weights are the stratum-specific expected numbers of deaths, $E_i = r_{g,i} \\cdot \\text{PY}_i$.\n\nWe now compute $B$ using the provided numerical values for the two strata ($i=1, 2$):\nFor stratum $1$: $\\text{PY}_1 = 30{,}000$, $r_{g,1} = 0.004$, $s_1 = 0.50$.\nFor stratum $2$: $\\text{PY}_2 = 70{,}000$, $r_{g,2} = 0.010$, $s_2 = 0.80$.\n\nFirst, calculate the numerator, $\\sum_{i=1}^{2} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)$:\n$$\n\\text{Numerator} = (s_1 \\cdot r_{g,1} \\cdot \\text{PY}_1) + (s_2 \\cdot r_{g,2} \\cdot \\text{PY}_2)\n$$\n$$\n\\text{Numerator} = (0.50 \\cdot 0.004 \\cdot 30{,}000) + (0.80 \\cdot 0.010 \\cdot 70{,}000)\n$$\n$$\n\\text{Numerator} = (60) + (560) = 620\n$$\n\nNext, calculate the denominator, $\\sum_{i=1}^{2} (r_{g,i} \\cdot \\text{PY}_i)$:\n$$\n\\text{Denominator} = (r_{g,1} \\cdot \\text{PY}_1) + (r_{g,2} \\cdot \\text{PY}_2)\n$$\n$$\n\\text{Denominator} = (0.004 \\cdot 30{,}000) + (0.010 \\cdot 70{,}000)\n$$\n$$\n\\text{Denominator} = (120) + (700) = 820\n$$\nThese terms represent the expected deaths in each stratum, $E_1=120$ and $E_2=700$.\n\nFinally, compute the bias magnitude $B$:\n$$\nB = \\frac{\\text{Numerator}}{\\text{Denominator}} = \\frac{620}{820} = \\frac{62}{82} = \\frac{31}{41}\n$$\nAs a decimal, this is approximately $0.75609756...$. Rounding to four significant figures, we get $0.7561$.\nThis value, being less than $1$, indicates that the observed SMR is an underestimate of the true rate ratio, which is the expected direction of bias from the healthy worker effect.", "answer": "$$\\boxed{0.7561}$$", "id": "4597939"}, {"introduction": "Now that we understand how the healthy worker effect can create bias, the next logical step is to learn how to control for it. This practice problem demonstrates a key epidemiological technique, indirect standardization, to create a more valid comparison between a worker cohort and the general population. You will calculate a Standardized Mortality Ratio ($SMR$) that adjusts for confounding factors like age and pre-existing health status, providing a more accurate estimate of mortality risk [@problem_id:4640831].", "problem": "A factory cohort is evaluated for all-cause mortality over a fixed follow-up, with person-time accumulated and deaths recorded in strata defined by age and baseline health status at cohort entry. To mitigate the healthy worker effect (a form of selection bias), you will perform indirect standardization that accounts jointly for age and health status by using stratum-specific mortality rates from the general population as the standard.\n\nFoundational definitions to use:\n- A mortality rate in a stratum is the number of deaths per unit person-time, here provided per $1{,}000$ person-years (PY).\n- Expected deaths under the standard are obtained by multiplying the standard mortality rate for each stratum by the cohort’s person-years in that stratum.\n- The Standardized Mortality Ratio (SMR) is the ratio of total observed deaths in the cohort to total expected deaths under the standard.\n\nStrata are defined by age group $\\{20\\text{--}39,\\ 40\\text{--}59,\\ 60\\text{--}74\\}$ and baseline health status $\\{\\text{no diagnosed cardiometabolic disease},\\ \\text{diagnosed cardiometabolic disease}\\}$.\n\nGeneral population (standard) mortality rates for each stratum (per $1{,}000$ PY) are:\n- Age $20\\text{--}39$, no disease: $1.2$; Age $20\\text{--}39$, disease: $3.6$.\n- Age $40\\text{--}59$, no disease: $4.5$; Age $40\\text{--}59$, disease: $11.0$.\n- Age $60\\text{--}74$, no disease: $18.0$; Age $60\\text{--}74$, disease: $35.0$.\n\nCohort person-years and observed deaths by stratum are:\n- Age $20\\text{--}39$, no disease: PY $32{,}000$; deaths $48$. Age $20\\text{--}39$, disease: PY $1{,}800$; deaths $9$.\n- Age $40\\text{--}59$, no disease: PY $27{,}000$; deaths $133$. Age $40\\text{--}59$, disease: PY $4{,}200$; deaths $60$.\n- Age $60\\text{--}74$, no disease: PY $12{,}500$; deaths $260$. Age $60\\text{--}74$, disease: PY $2{,}300$; deaths $115$.\n\nUsing only the foundational definitions above and performing indirect standardization that jointly accounts for age and baseline health status, compute the bias-mitigated Standardized Mortality Ratio for the cohort relative to the general population. Express your final answer as a decimal rounded to four significant figures. No unit is required for the SMR.", "solution": "The user wants me to solve the problem by following these steps.\n1.  First, validate the problem statement.\n2.  If it is valid, then solve it.\n\n### Step 1: Extract Givens\n- **Task**: Compute the bias-mitigated Standardized Mortality Ratio (SMR) for a factory cohort relative to the general population using indirect standardization.\n- **Foundational Definitions**:\n    - A mortality rate is the number of deaths per unit person-time, given per $1{,}000$ person-years (PY).\n    - Expected deaths = (standard mortality rate for a stratum) $\\times$ (cohort’s person-years in that stratum).\n    - SMR = (total observed deaths in the cohort) / (total expected deaths under the standard).\n- **Stratification**: Strata are defined by age group $\\{20\\text{--}39,\\ 40\\text{--}59,\\ 60\\text{--}74\\}$ and baseline health status $\\{\\text{no diagnosed cardiometabolic disease},\\ \\text{diagnosed cardiometabolic disease}\\}$.\n- **General Population (Standard) Mortality Rates (per $1{,}000$ PY)**:\n    - Age $20\\text{--}39$, no disease: $1.2$.\n    - Age $20\\text{--}39$, disease: $3.6$.\n    - Age $40\\text{--}59$, no disease: $4.5$.\n    - Age $40\\text{--}59$, disease: $11.0$.\n    - Age $60\\text{--}74$, no disease: $18.0$.\n    - Age $60\\text{--}74$, disease: $35.0$.\n- **Cohort Data (Person-Years and Observed Deaths)**:\n    - Age $20\\text{--}39$, no disease: PY $32{,}000$; deaths $48$.\n    - Age $20\\text{--}39$, disease: PY $1{,}800$; deaths $9$.\n    - Age $40\\text{--}59$, no disease: PY $27{,}000$; deaths $133$.\n    - Age $40\\text{--}59$, disease: PY $4{,}200$; deaths $60$.\n    - Age $60\\text{--}74$, no disease: PY $12{,}500$; deaths $260$.\n    - Age $60\\text{--}74$, disease: PY $2{,}300$; deaths $115$.\n- **Final Output Requirement**: The SMR should be expressed as a decimal rounded to four significant figures.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is assessed against the validation criteria:\n- **Scientifically Grounded**: The problem describes the calculation of a Standardized Mortality Ratio (SMR) using indirect standardization, a standard and fundamental method in epidemiology for controlling confounding. The concept of the healthy worker effect is a well-established form of selection bias in occupational epidemiology. The data and methods are scientifically sound.\n- **Well-Posed**: The problem provides all necessary data (observed deaths, person-years, standard rates for each stratum) and clear definitions to calculate a unique SMR. The instructions are unambiguous.\n- **Objective**: The problem is stated in precise, quantitative, and objective terms. There are no subjective claims or opinions.\n- **Completeness and Consistency**: The data are complete, with values provided for all six strata defined by age and health status. There are no contradictions in the provided information. Mortality rates increase with age and with the presence of disease, which is consistent with established epidemiological facts.\n- **Realism**: The provided person-years, death counts, and mortality rates are plausible for a large cohort study.\n\nThe problem does not exhibit any of the flaws listed (e.g., scientific unsoundness, incompleteness, ambiguity). It is a standard, formalizable exercise in biostatistics and epidemiology.\n\n### Step 3: Verdict and Action\nThe problem is valid. I will proceed with the solution.\n\nThe problem requires the calculation of the Standardized Mortality Ratio (SMR) for the factory cohort. The formula for the SMR is given as:\n$$\n\\text{SMR} = \\frac{\\text{Total Observed Deaths}}{\\text{Total Expected Deaths}}\n$$\nLet $D_O$ represent the total observed deaths and $D_E$ represent the total expected deaths.\n\nFirst, we calculate the total number of observed deaths ($D_O$) in the cohort by summing the deaths across all strata.\nLet $d_i$ be the observed deaths in stratum $i$. The strata are indexed as follows:\n$1$: Age $20\\text{--}39$, no disease\n$2$: Age $20\\text{--}39$, disease\n$3$: Age $40\\text{--}59$, no disease\n$4$: Age $40\\text{--}59$, disease\n$5$: Age $60\\text{--}74$, no disease\n$6$: Age $60\\text{--}74$, disease\n\n$$\nD_O = \\sum_{i=1}^{6} d_i = 48 + 9 + 133 + 60 + 260 + 115\n$$\n$$\nD_O = 625\n$$\nSo, the total number of observed deaths is $625$.\n\nNext, we calculate the total number of expected deaths ($D_E$). This is done by applying the stratum-specific mortality rates from the standard (general) population to the person-years of the cohort in each corresponding stratum. Let $E_i$ be the expected deaths in stratum $i$, $PY_i$ be the person-years in the cohort for stratum $i$, and $R_i$ be the standard mortality rate for stratum $i$. The standard rates are given per $1{,}000$ person-years, so we must divide them by $1{,}000$ to get the rate per person-year.\n\nThe expected deaths for each stratum are calculated as follows:\n$$\nE_i = PY_i \\times \\frac{R_i}{1000}\n$$\n\n- **Stratum 1 (Age $20\\text{--}39$, no disease)**:\n  $PY_1 = 32{,}000$, $R_1 = 1.2$ per $1{,}000$ PY\n  $E_1 = 32{,}000 \\times \\frac{1.2}{1000} = 38.4$\n\n- **Stratum 2 (Age $20\\text{--}39$, disease)**:\n  $PY_2 = 1{,}800$, $R_2 = 3.6$ per $1{,}000$ PY\n  $E_2 = 1{,}800 \\times \\frac{3.6}{1000} = 6.48$\n\n- **Stratum 3 (Age $40\\text{--}59$, no disease)**:\n  $PY_3 = 27{,}000$, $R_3 = 4.5$ per $1{,}000$ PY\n  $E_3 = 27{,}000 \\times \\frac{4.5}{1000} = 121.5$\n\n- **Stratum 4 (Age $40\\text{--}59$, disease)**:\n  $PY_4 = 4{,}200$, $R_4 = 11.0$ per $1{,}000$ PY\n  $E_4 = 4{,}200 \\times \\frac{11.0}{1000} = 46.2$\n\n- **Stratum 5 (Age $60\\text{--}74$, no disease)**:\n  $PY_5 = 12{,}500$, $R_5 = 18.0$ per $1{,}000$ PY\n  $E_5 = 12{,}500 \\times \\frac{18.0}{1000} = 225.0$\n\n- **Stratum 6 (Age $60\\text{--}74$, disease)**:\n  $PY_6 = 2{,}300$, $R_6 = 35.0$ per $1{,}000$ PY\n  $E_6 = 2{,}300 \\times \\frac{35.0}{1000} = 80.5$\n\nThe total expected deaths, $D_E$, is the sum of the expected deaths from all strata:\n$$\nD_E = \\sum_{i=1}^{6} E_i = 38.4 + 6.48 + 121.5 + 46.2 + 225.0 + 80.5\n$$\n$$\nD_E = 518.08\n$$\nSo, the total number of expected deaths is $518.08$.\n\nFinally, we compute the SMR:\n$$\n\\text{SMR} = \\frac{D_O}{D_E} = \\frac{625}{518.08}\n$$\n$$\n\\text{SMR} \\approx 1.20637704\n$$\nThe problem requires the answer to be rounded to four significant figures. The first four significant figures are $1$, $2$, $0$, and $6$. The fifth significant figure is $3$, which is less than $5$, so we round down.\n$$\n\\text{SMR} \\approx 1.206\n$$", "answer": "$$\n\\boxed{1.206}\n$$", "id": "4640831"}, {"introduction": "To truly master the concept of the healthy worker effect, it's invaluable to build a model of the process from the ground up. This advanced exercise challenges you to write a computer simulation that generates a population, selects healthier individuals into a workforce, and observes health outcomes. By modeling the entire system [@problem_id:4597935], you will gain a deep, intuitive understanding of how selection bias operates and be able to distinguish between biased external comparisons and less biased internal comparisons.", "problem": "Write a complete, runnable program that uses simulation and Monte Carlo design to study the healthy worker effect as a selection phenomenon. You must construct a generative model for mortality in which employment selection depends on latent health (frailty), and quantify how naive external comparisons are biased while internal comparisons are less biased. The program must implement the following model, all defined in purely mathematical terms.\n\nFundamental base and core definitions:\n- Let $U$ denote a latent multiplicative frailty. Model $\\ln U$ as a Normal random variable with mean $\\mu_Z$ and variance $\\sigma_Z^2$. Set $\\mu_Z = -\\sigma_Z^2/2$ so that $\\mathbb{E}[U] = 1$.\n- Let $\\lambda_0$ denote the baseline hazard rate for the general population (per person-year). For an individual with frailty $U$, the individual hazard is $h = \\lambda_0 U$ in the absence of exposure.\n- Let $X \\in \\{0,1\\}$ denote a binary workplace exposure. Exposure multiplies the hazard by a factor $\\mathrm{HR}_X$, so the hazard is $h_X = \\lambda_0 U \\cdot \\mathrm{HR}_X^{X}$.\n- For a fixed follow-up duration $T$ (in years), and assuming a constant hazard over $[0,T]$, the probability of death by time $T$ is $p_T = 1 - \\exp(-T h_X)$.\n- Let $S \\in \\{0,1\\}$ denote employment status at baseline. Employment is selected based on health via a logistic model:\n$$\n\\Pr(S=1 \\mid U) = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U) = \\frac{1}{1 + \\exp\\left(-(\\beta_0 - \\beta_1 \\ln U)\\right)}.\n$$\nHere $\\beta_1 \\ge 0$ encodes that larger frailty $U$ (worse health) reduces employment probability, producing the healthy worker effect.\n\nQuantities to estimate via Monte Carlo:\n- Standardized Mortality Ratio (SMR) among unexposed workers, defined as\n$$\n\\mathrm{SMR}_{\\text{unexp}} = \\frac{\\text{Observed deaths among workers with } X=0 \\text{ during } [0,T]}{\\text{Expected deaths using external rate } \\lambda_0 \\text{ and person-time } T}.\n$$\nFormally, if there are $n_0$ unexposed workers, expected deaths $= n_0 \\cdot \\lambda_0 \\cdot T$.\n- Internal risk ratio comparing exposed to unexposed workers, defined as\n$$\n\\widehat{\\mathrm{RR}}_{\\text{internal}} = \\frac{\\widehat{R}_1}{\\widehat{R}_0},\n$$\nwhere $\\widehat{R}_x$ is the sample risk among workers with $X=x$ over $[0,T]$.\n- The target causal marginal risk ratio among workers obtained by the g-computation formula,\n$$\n\\mathrm{RR}_{\\text{true}} = \\frac{\\mathbb{E}[\\,1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X)\\mid S=1\\,]}{\\mathbb{E}[\\,1 - \\exp(-T \\lambda_0 U)\\mid S=1\\,]}.\n$$\nThis is computed by averaging counterfactual risks over the empirical distribution of $U$ among the employed.\n- The Monte Carlo bias and mean squared error (MSE) of the internal risk ratio, defined over $R$ independent repetitions as\n$$\n\\text{Bias} = \\frac{1}{R}\\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right),\n\\quad\n\\text{MSE} = \\frac{1}{R}\\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)^2.\n$$\n\nSimulation design for one repetition:\n- Generate $N$ independent draws of $Z \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$ with $\\mu_Z = -\\sigma_Z^2/2$, and set $U = \\exp(Z)$.\n- Compute $p_{\\text{emp}} = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U)$ and draw $S \\sim \\mathrm{Bernoulli}(p_{\\text{emp}})$.\n- Among those with $S=1$, draw exposure $X \\sim \\mathrm{Bernoulli}(p_X)$ independently.\n- For each worker, compute risk $p_T = 1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X^{X})$ and draw the death indicator $Y \\sim \\mathrm{Bernoulli}(p_T)$.\n- Compute $\\mathrm{SMR}_{\\text{unexp}}$ using unexposed workers only, taking expected deaths as $n_0 \\lambda_0 T$ and observed deaths as $\\sum Y$ over unexposed workers.\n- Compute $\\widehat{\\mathrm{RR}}_{\\text{internal}}$ as the ratio of sample risks in exposed and unexposed workers.\n- Compute $\\mathrm{RR}_{\\text{true}}$ by evaluating\n$$\nr_1 = 1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X), \\quad r_0 = 1 - \\exp(-T \\lambda_0 U)\n$$\nover the same employed workers and taking the ratio of means, $\\mathrm{RR}_{\\text{true}} = \\overline{r}_1 / \\overline{r}_0$.\n\nMonte Carlo aggregation:\n- Repeat the above $R$ times with independent random number streams and compute the Monte Carlo averages of $\\mathrm{SMR}_{\\text{unexp}}$, Bias, and MSE.\n\nYour program must implement the following test suite, where each test case is a tuple of parameters $(\\text{seed}, N, R, \\lambda_0, \\sigma_Z, \\beta_0, \\beta_1, p_X, \\mathrm{HR}_X, T)$:\n- Case A (general case): $(202311, 100000, 40, 0.08, 0.7, 0.0, 1.2, 0.5, 1.5, 5.0)$.\n- Case B (no healthy worker effect, boundary): $(202312, 100000, 40, 0.08, 0.7, 0.0, 0.0, 0.5, 1.5, 5.0)$.\n- Case C (strong selection, short follow-up): $(202313, 100000, 40, 0.08, 0.9, -0.4, 2.0, 0.5, 2.0, 0.5)$.\n- Case D (no exposure effect, edge): $(202314, 100000, 40, 0.08, 0.7, 0.0, 1.0, 0.5, 1.0, 3.0)$.\n\nNotes and constraints:\n- All random number generation must be reproducible by seeding from the provided integer seed in each test case; use independent substreams across repetitions.\n- All answers are dimensionless ratios; express them as decimals.\n- Handle any potential zero denominators gracefully by defining ratios only when both groups exist; under the given parameters and sample sizes, the probability of a degenerate group is negligible.\n\nRequired final output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the following order:\n$[\\overline{\\mathrm{SMR}}_{\\text{unexp}}^{A}, \\text{Bias}^{A}, \\text{MSE}^{A}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{B}, \\text{Bias}^{B}, \\text{MSE}^{B}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{C}, \\text{Bias}^{C}, \\text{MSE}^{C}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{D}, \\text{Bias}^{D}, \\text{MSE}^{D}]$,\nwhere bars indicate Monte Carlo averages over $R$ repetitions. Each number must be printed with exactly $6$ digits after the decimal point.", "solution": "The problem requires the implementation of a Monte Carlo simulation to study the healthy worker effect, a form of selection bias in epidemiology. I will first validate the problem statement and then provide a detailed solution.\n\n### Problem Validation\n\nThe problem statement provides a comprehensive and mathematically precise description of a generative model for population health, employment selection, and mortality.\n\n**Step 1: Extracted Givens**\n-   **Latent Frailty**: $U$ is a random variable such that $\\ln U \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$, with the constraint $\\mu_Z = -\\sigma_Z^2/2$ to ensure $\\mathbb{E}[U] = 1$.\n-   **Hazard Model**: The individual hazard is $h_X = \\lambda_0 U \\cdot \\mathrm{HR}_X^X$, where $\\lambda_0$ is the baseline hazard, $X \\in \\{0,1\\}$ is a binary exposure, and $\\mathrm{HR}_X$ is the hazard ratio for the exposure.\n-   **Mortality Risk**: The probability of death over a follow-up period $T$ is $p_T = 1 - \\exp(-T h_X)$.\n-   **Employment Selection**: The probability of being employed, $S=1$, is governed by $\\Pr(S=1 \\mid U) = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U)$, with $\\beta_1 \\ge 0$.\n-   **Simulation Parameters**: A total of $N$ individuals are simulated over $R$ repetitions. Among workers, exposure is assigned with probability $p_X$.\n-   **Metrics**:\n    1.  $\\mathrm{SMR}_{\\text{unexp}}$: Standardized Mortality Ratio for unexposed workers, comparing observed deaths to expected deaths based on the external rate $\\lambda_0$.\n    2.  $\\widehat{\\mathrm{RR}}_{\\text{internal}}$: The ratio of sample risks between exposed and unexposed workers.\n    3.  $\\mathrm{RR}_{\\text{true}}$: The true causal risk ratio within the worker population, estimated via g-computation on the empirical sample of workers.\n    4.  $\\text{Bias}$ and $\\text{MSE}$: The Monte Carlo bias and mean squared error of $\\widehat{\\mathrm{RR}}_{\\text{internal}}$ as an estimator for $\\mathrm{RR}_{\\text{true}}$.\n-   **Test Cases**: Four specific sets of parameters $(\\text{seed}, N, R, \\lambda_0, \\sigma_Z, \\beta_0, \\beta_1, p_X, \\mathrm{HR}_X, T)$ are provided.\n\n**Step 2: Validation Using Extracted Givens**\n-   **Scientifically Grounded**: The model is a standard and well-established formalization of the healthy worker effect used in epidemiological research and teaching. It uses core concepts like frailty models (log-normal distribution), hazard rates, survival analysis, and selection on a latent variable. All elements are scientifically sound.\n-   **Well-Posed**: The problem is specified with mathematical precision. All parameters and algorithmic steps for the simulation are defined, ensuring that a unique, computable result can be obtained for each test case given the random number generator seed.\n-   **Objective**: The problem is stated in objective, mathematical terms, free of any subjectivity or ambiguity.\n\nThe problem does not violate any of the invalidity criteria. It is a well-defined, scientifically valid, and formalizable simulation task.\n\n**Step 3: Verdict and Action**\nThe problem is **valid**. A solution will be constructed.\n\n### Solution Derivation\n\nThe solution involves programming a Monte Carlo simulation based on the provided generative model. The program will be structured to handle multiple test cases, with each case involving $R$ independent repetitions of a simulation on a population of size $N$.\n\n**Core Simulation Logic (Single Repetition)**\n\nFor a single repetition, we execute the following steps, which are designed for efficient vectorized computation.\n\n1.  **Generate Population Frailty**: We generate $N$ independent draws from the latent frailty distribution. First, we sample $Z_i \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$ for $i=1, \\dots, N$, where $\\mu_Z = -\\sigma_Z^2/2$. Then, we compute the frailty for each individual as $U_i = \\exp(Z_i)$. The use of $Z_i = \\ln U_i$ is computationally convenient.\n\n2.  **Simulate Employment Selection**: For each individual $i$, we calculate their probability of employment, $p_{\\text{emp}, i} = \\Pr(S_i=1 \\mid U_i)$. This is given by the logistic model:\n    $$ p_{\\text{emp}, i} = \\frac{1}{1 + \\exp(-(\\beta_0 - \\beta_1 Z_i))} $$\n    We then draw the employment status $S_i \\sim \\mathrm{Bernoulli}(p_{\\text{emp}, i})$. This process creates a sub-population of workers ($S_i=1$) who are, on average, healthier (lower $U_i$) than the general population, provided $\\beta_1 > 0$.\n\n3.  **Assign Exposure and Simulate Outcomes**: We restrict the subsequent steps to the cohort of workers (all individuals with $S_i=1$).\n    -   Among the workers, we randomly assign exposure status $X_i \\sim \\mathrm{Bernoulli}(p_X)$. Crucially, this assignment is independent of their frailty $U_i$.\n    -   For each worker, we calculate their individual hazard $h_{X,i} = \\lambda_0 U_i \\cdot \\mathrm{HR}_X^{X_i}$ and their risk of death over the follow-up period $T$, $p_{T,i} = 1 - \\exp(-T h_{X,i})$.\n    -   The death outcome for each worker, $Y_i$, is then drawn from a Bernoulli distribution, $Y_i \\sim \\mathrm{Bernoulli}(p_{T,i})$.\n\n**Calculation of Metrics (Single Repetition)**\n\nAfter simulating the data for one repetition, we calculate the required quantities.\n\n1.  **$\\mathrm{SMR}_{\\text{unexp}}$**: We identify the group of unexposed workers (those with $S_i=1, X_i=0$). Let this group have size $n_0$.\n    -   The observed number of deaths is $O = \\sum_{i: S_i=1, X_i=0} Y_i$.\n    -   The expected number of deaths, using the external general population rate $\\lambda_0$, is $E = n_0 \\cdot \\lambda_0 \\cdot T$.\n    -   The SMR for this repetition is $\\mathrm{SMR}_{\\text{unexp}} = O / E$. Since workers are healthier than the general population (when $\\beta_1 > 0$), we expect $\\mathrm{SMR}_{\\text{unexp}} < 1$.\n\n2.  **$\\widehat{\\mathrm{RR}}_{\\text{internal}}$**: We compare the risk in exposed workers to unexposed workers.\n    -   Let $n_1$ be the number of exposed workers ($S_i=1, X_i=1$).\n    -   The sample risk in unexposed workers is $\\widehat{R}_0 = (\\sum_{i: S_i=1, X_i=0} Y_i) / n_0$.\n    -   The sample risk in exposed workers is $\\widehat{R}_1 = (\\sum_{i: S_i=1, X_i=1} Y_i) / n_1$.\n    -   The internal risk ratio is $\\widehat{\\mathrm{RR}}_{\\text{internal}} = \\widehat{R}_1 / \\widehat{R}_0$.\n\n3.  **$\\mathrm{RR}_{\\text{true}}$**: This quantity represents the true causal effect of exposure on risk *within the specific worker population generated in this repetition*. It is calculated using the g-formula by averaging counterfactual outcomes over the empirical distribution of $U_i$ for the workers in this sample.\n    -   For each worker $i$ (with frailty $U_i$), we compute their counterfactual risk under no exposure, $r_{0,i} = 1 - \\exp(-T \\lambda_0 U_i)$, and under exposure, $r_{1,i} = 1 - \\exp(-T \\lambda_0 U_i \\mathrm{HR}_X)$.\n    -   We then average these risks over all workers in the sample: $\\bar{r}_0 = \\frac{1}{n_{\\text{workers}}} \\sum_{i: S_i=1} r_{0,i}$ and $\\bar{r}_1 = \\frac{1}{n_{\\text{workers}}} \\sum_{i: S_i=1} r_{1,i}$.\n    -   The true risk ratio for this population is $\\mathrm{RR}_{\\text{true}} = \\bar{r}_1 / \\bar{r}_0$. Because exposure $X$ was randomly assigned within the worker group and is thus not confounded by $U$, $\\widehat{\\mathrm{RR}}_{\\text{internal}}$ is an unbiased estimator for $\\mathrm{RR}_{\\text{true}}$.\n\n**Monte Carlo Aggregation**\n\nThe entire simulation process is repeated $R$ times, with each repetition using an independent random number stream seeded from a master generator. This ensures reproducibility and statistical independence across repetitions. We collect the values of $\\mathrm{SMR}_{\\text{unexp}}^{(r)}$, $\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)}$, and $\\mathrm{RR}_{\\text{true}}^{(r)}$ for each repetition $r=1, \\dots, R$.\n\nThe final summary statistics are then computed:\n-   **Average SMR**: $\\overline{\\mathrm{SMR}}_{\\text{unexp}} = \\frac{1}{R} \\sum_{r=1}^R \\mathrm{SMR}_{\\text{unexp}}^{(r)}$.\n-   **Bias**: $\\text{Bias} = \\frac{1}{R} \\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)$. This measures the average estimation error of the internal risk ratio.\n-   **MSE**: $\\text{MSE} = \\frac{1}{R} \\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)^2$. This measures the overall quality of the estimator, combining both bias and variance.\n\nThe program will execute this logic for each of the four test cases and format the final results as specified.", "answer": "```python\nimport numpy as np\nfrom scipy.special import expit\n\ndef _single_repetition(params, rng):\n    \"\"\"\n    Performs a single repetition of the healthy worker effect simulation.\n    \"\"\"\n    _, N, _, lambda_0, sigma_Z, beta_0, beta_1, p_X, HR_X, T = params\n\n    # Step 1: Generate population frailty\n    # mu_Z = -sigma_Z^2 / 2 ensures E[U] = 1 in the general population\n    mu_Z = -sigma_Z**2 / 2.0\n    # Z is ln(U)\n    Z = rng.normal(mu_Z, sigma_Z, size=N)\n    U = np.exp(Z)\n\n    # Step 2: Simulate employment selection\n    logit_p_emp = beta_0 - beta_1 * Z\n    p_emp = expit(logit_p_emp)\n    S = rng.binomial(1, p_emp, size=N)\n    \n    workers_mask = (S == 1)\n    if not np.any(workers_mask):\n        # In the unlikely event no workers are selected, metrics are undefined\n        return np.nan, np.nan, np.nan\n\n    U_workers = U[workers_mask]\n    num_workers = len(U_workers)\n\n    # Step 3: Assign exposure and simulate outcomes for workers\n    X_workers = rng.binomial(1, p_X, size=num_workers)\n    \n    hazard_workers = lambda_0 * U_workers * (HR_X ** X_workers)\n    risk_workers = 1 - np.exp(-T * hazard_workers)\n    Y_workers = rng.binomial(1, risk_workers, size=num_workers)\n\n    # --- Calculate metrics for this repetition ---\n\n    # 1. Standardized Mortality Ratio (SMR) for unexposed workers\n    unexp_workers_local_mask = (X_workers == 0)\n    n0 = np.sum(unexp_workers_local_mask)\n    smr_unexp = np.nan\n    if n0 > 0:\n        observed_deaths = np.sum(Y_workers[unexp_workers_local_mask])\n        expected_deaths = n0 * lambda_0 * T\n        if expected_deaths > 0:\n            smr_unexp = observed_deaths / expected_deaths\n\n    # 2. Internal Risk Ratio (estimated)\n    exp_workers_local_mask = (X_workers == 1)\n    n1 = np.sum(exp_workers_local_mask)\n    rr_hat = np.nan\n    if n0 > 0 and n1 > 0:\n        risk_hat_0 = np.sum(Y_workers[unexp_workers_local_mask]) / n0\n        risk_hat_1 = np.sum(Y_workers[exp_workers_local_mask]) / n1\n        # Handle case where no deaths occur in the reference group\n        if risk_hat_0 > 0:\n            rr_hat = risk_hat_1 / risk_hat_0\n\n    # 3. True Causal Risk Ratio (g-computation on the worker sample)\n    counterfactual_risk_0 = 1 - np.exp(-T * lambda_0 * U_workers)\n    counterfactual_risk_1 = 1 - np.exp(-T * lambda_0 * U_workers * HR_X)\n    \n    mean_risk_0 = np.mean(counterfactual_risk_0)\n    mean_risk_1 = np.mean(counterfactual_risk_1)\n    \n    rr_true = np.nan\n    if mean_risk_0 > 0:\n        rr_true = mean_risk_1 / mean_risk_0\n        \n    return smr_unexp, rr_hat, rr_true\n\n\ndef run_simulation(params):\n    \"\"\"\n    Runs the Monte Carlo simulation for a given set of parameters.\n    \"\"\"\n    # Unpack parameters\n    seed, _, R, _, _, _, _, _, _, _ = params\n    \n    # Master random number generator\n    rng_master = np.random.default_rng(seed)\n    \n    # Store results from each repetition\n    reps_smr = []\n    reps_rr_hat = []\n    reps_rr_true = []\n\n    # Create independent random number streams for each repetition\n    child_rngs = rng_master.spawn(R)\n    \n    for i in range(R):\n        smr, rr_hat, rr_true = _single_repetition(params, child_rngs[i])\n        reps_smr.append(smr)\n        reps_rr_hat.append(rr_hat)\n        reps_rr_true.append(rr_true)\n\n    # Convert to numpy arrays for vectorized calculations\n    reps_smr = np.array(reps_smr)\n    reps_rr_hat = np.array(reps_rr_hat)\n    reps_rr_true = np.array(reps_rr_true)\n    \n    # --- Aggregate results over R repetitions ---\n    \n    # Calculate average SMR, ignoring any NaNs\n    avg_smr = np.nanmean(reps_smr)\n    \n    # Calculate bias and MSE\n    # Filter out NaNs from ratio calculations, which occur if groups are empty or have zero events\n    valid_mask = ~np.isnan(reps_rr_hat) & ~np.isnan(reps_rr_true)\n    \n    bias, mse = np.nan, np.nan\n    if np.any(valid_mask):\n        diffs = reps_rr_hat[valid_mask] - reps_rr_true[valid_mask]\n        bias = np.mean(diffs)\n        mse = np.mean(diffs**2)\n        \n    return avg_smr, bias, mse\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final result.\n    \"\"\"\n    # Test cases defined as tuples:\n    # (seed, N, R, lambda_0, sigma_Z, beta_0, beta_1, p_X, HR_X, T)\n    test_cases = [\n        # Case A: General case\n        (202311, 100000, 40, 0.08, 0.7, 0.0, 1.2, 0.5, 1.5, 5.0),\n        # Case B: No healthy worker effect\n        (202312, 100000, 40, 0.08, 0.7, 0.0, 0.0, 0.5, 1.5, 5.0),\n        # Case C: Strong selection, short follow-up\n        (202313, 100000, 40, 0.08, 0.9, -0.4, 2.0, 0.5, 2.0, 0.5),\n        # Case D: No exposure effect\n        (202314, 100000, 40, 0.08, 0.7, 0.0, 1.0, 0.5, 1.0, 3.0),\n    ]\n\n    all_results = []\n    for case_params in test_cases:\n        avg_smr, bias, mse = run_simulation(case_params)\n        all_results.extend([avg_smr, bias, mse])\n\n    # Format the output as a single comma-separated string with 6 decimal places each\n    formatted_results = [f\"{x:.6f}\" for x in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4597935"}]}