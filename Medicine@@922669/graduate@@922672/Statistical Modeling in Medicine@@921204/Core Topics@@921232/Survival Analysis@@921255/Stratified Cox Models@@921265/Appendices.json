{"hands_on_practices": [{"introduction": "Before relying on statistical software to analyze survival data, it is crucial to understand the fundamental mechanics of the models being fitted. This exercise provides a hands-on opportunity to compute the partial likelihood for a stratified Cox model from first principles. By manually constructing the stratum-specific risk sets and calculating each contribution to the likelihood, you will gain a concrete understanding of how stratification isolates comparisons within groups, a core feature of this powerful technique. [@problem_id:4610388]", "problem": "A precision oncology registry contains time-to-event data for a small cohort of patients with a solid tumor, with sex recorded to permit stratification. Two mutually exclusive clinical events are recorded: cause $1$ is disease progression, and cause $2$ is non-cancer death. Suppose the analysis targets the cause-specific hazard for disease progression using a stratified Cox Proportional Hazards (CPH) model, with the baseline hazard allowed to differ by sex but a common regression coefficient across strata for a single binary genomic covariate $z \\in \\{0,1\\}$ indicating high expression of a pathway activation signature. The cause-specific hazard for progression in stratum $s \\in \\{\\text{female}, \\text{male}\\}$ is\n$$\\lambda_{1,s}(t \\mid z) = \\lambda_{1,0,s}(t)\\,\\exp(\\beta z),$$\nwhere $\\lambda_{1,0,s}(t)$ is an unspecified, stratum-specific baseline hazard and $\\beta$ is the common log hazard ratio for high expression.\n\nYou are given the following event histories. Each line lists $(\\text{sex}, z, t, \\text{type})$, where $t$ is the observed time in months to the first event or censoring, and $\\text{type} \\in \\{1,2,\\text{cens}\\}$ denotes progression, death, or right-censoring, respectively.\n\n- $(\\text{female},\\,1,\\,4,\\,1)$\n- $(\\text{female},\\,0,\\,6,\\,2)$\n- $(\\text{female},\\,1,\\,10,\\,\\text{cens})$\n- $(\\text{female},\\,0,\\,5,\\,1)$\n- $(\\text{male},\\,1,\\,3,\\,1)$\n- $(\\text{male},\\,0,\\,8,\\,2)$\n- $(\\text{male},\\,1,\\,7,\\,\\text{cens})$\n\nAssume that for the cause-specific analysis of progression (cause $1$), any non-cancer death (cause $2$) removes a subject from the risk set at its time of occurrence (i.e., it is treated as a competing event), and right-censoring removes a subject at its censoring time. There is no left-truncation and no tied event times.\n\nTask: For each progression event time within each sex stratum, explicitly identify the risk set under the cause-specific CPH model and write down the corresponding partial likelihood contribution. Verify that, due to stratification, the denominator at each event time contains only subjects from the same sex stratum. Finally, provide the pooled partial likelihood for $\\beta$ across all progression events as a single analytic expression $L(\\beta)$.\n\nAnswer format: Provide $L(\\beta)$ as a closed-form expression in terms of $\\exp(\\beta)$. The final answer must be a single analytic expression. Do not round and do not include any units.", "solution": "The user wants me to solve a problem related to stratified Cox models in a competing risks setting.\n\nHere's my plan:\n1.  **Validate the problem:**\n    *   Extract all the given information.\n    *   Check for scientific soundness, well-posedness, and objectivity. This is a standard biostatistics problem, so it should be valid.\n\n2.  **Understand the model and data:**\n    *   Model: Stratified Cox Proportional Hazards (CPH) model for a specific cause (cause 1: progression).\n    *   Hazard function: `lambda_{1,s}(t | z) = lambda_{1,0,s}(t) * exp(beta * z)`.\n    *   `s` is the stratum (sex: female, male).\n    *   `lambda_{1,0,s}(t)` is the stratum-specific baseline hazard.\n    *   `beta` is the common log hazard ratio for the covariate `z`.\n    *   `z` is a binary covariate (0 or 1).\n    *   Competing risk: Cause 2 (non-cancer death) is treated as a censoring event in the cause-specific analysis of cause 1.\n    *   Data: A list of 7 patients with `(sex, z, t, type)`.\n\n3.  **Break down the task:**\n    *   **Part 1:** For each progression event, identify the risk set *within its stratum*.\n    *   **Part 2:** For each progression event, write down the partial likelihood contribution.\n    *   **Part 3:** Verify that the denominators only include subjects from the same stratum.\n    *   **Part 4:** Combine these contributions to form the total partial likelihood `L(beta)`.\n\n4.  **Execute the plan:**\n\n    *   **Data Organization:** I'll first organize the data by stratum (sex).\n\n        *   **Stratum: Female**\n            *   Patient F1: (z=1, t=4, type=1) - Progression event\n            *   Patient F2: (z=0, t=6, type=2) - Competing event (treated as censored at t=6)\n            *   Patient F3: (z=1, t=10, type=cens) - Censored at t=10\n            *   Patient F4: (z=0, t=5, type=1) - Progression event\n\n        *   **Stratum: Male**\n            *   Patient M1: (z=1, t=3, type=1) - Progression event\n            *   Patient M2: (z=0, t=8, type=2) - Competing event (treated as censored at t=8)\n            *   Patient M3: (z=1, t=7, type=cens) - Censored at t=7\n\n    *   **Identify Event Times:** The progression events (type=1) are the only ones that contribute to the numerator of the partial likelihood.\n        *   Female stratum event times: `t=4` (from F1) and `t=5` (from F4).\n        *   Male stratum event times: `t=3` (from M1).\n\n    *   **Calculate Partial Likelihood Contributions (Stratum by Stratum):**\n\n        *   The partial likelihood contribution for an event at time `t_i` for subject `i` is:\n            `L_i(beta) = [exp(beta * z_i)] / [sum_{j in R(t_i)} exp(beta * z_j)]`\n            where `R(t_i)` is the risk set at time `t_i`. The risk set `R(t_i)` consists of all subjects `j` whose event/censoring time `t_j` is greater than or equal to `t_i`.\n\n        *   **Male Stratum:**\n            *   **Event at t=3 (Patient M1, z=1):**\n                *   Who is at risk at time `t=3` in the male stratum?\n                    *   M1: `t=3`, at risk. (z=1)\n                    *   M2: `t=8`, at risk. (z=0)\n                    *   M3: `t=7`, at risk. (z=1)\n                *   Risk Set `R_M(3)` = {M1, M2, M3}.\n                *   Denominator sum: `exp(beta*1) + exp(beta*0) + exp(beta*1) = 2*exp(beta) + 1`.\n                *   Numerator: `exp(beta*1) = exp(beta)`.\n                *   Partial Likelihood Contribution `L_M1(beta)`: `exp(beta) / (2*exp(beta) + 1)`.\n\n        *   **Female Stratum:**\n            *   The event times are `t=4` and `t=5`. I need to process them in chronological order.\n            *   **Event at t=4 (Patient F1, z=1):**\n                *   Who is at risk at time `t=4` in the female stratum?\n                    *   F1: `t=4`, at risk. (z=1)\n                    *   F2: `t=6`, at risk. (z=0)\n                    *   F3: `t=10`, at risk. (z=1)\n                    *   F4: `t=5`, at risk. (z=0)\n                *   Risk Set `R_F(4)` = {F1, F2, F3, F4}.\n                *   Denominator sum: `exp(beta*1) + exp(beta*0) + exp(beta*1) + exp(beta*0) = 2*exp(beta) + 2`.\n                *   Numerator: `exp(beta*1) = exp(beta)`.\n                *   Partial Likelihood Contribution `L_F1(beta)`: `exp(beta) / (2*exp(beta) + 2)`.\n\n            *   **Event at t=5 (Patient F4, z=0):**\n                *   Who is at risk at time `t=5` in the female stratum?\n                    *   F1: event at `t=4`, no longer in risk set.\n                    *   F2: `t=6`, at risk. (z=0)\n                    *   F3: `t=10`, at risk. (z=1)\n                    *   F4: `t=5`, at risk. (z=0)\n                *   Risk Set `R_F(5)` = {F2, F3, F4}.\n                *   Denominator sum: `exp(beta*0) + exp(beta*1) + exp(beta*0) = exp(beta) + 2`.\n                *   Numerator: `exp(beta*0) = 1`.\n                *   Partial Likelihood Contribution `L_F4(beta)`: `1 / (exp(beta) + 2)`.\n\n    *   **Verify Stratification:** The problem statement explicitly asks to verify that the denominator at each event time contains only subjects from the same sex stratum. My process above naturally does this. The risk sets `R_M(3)`, `R_F(4)`, and `R_F(5)` were constructed only using subjects from the corresponding stratum (Male or Female). This is the definition of a stratified Cox model: the partial likelihood is the product of the likelihoods from each stratum, and within each stratum, the risk sets are confined to that stratum. So, the verification is complete.\n\n    *   **Combine Contributions for the Total Partial Likelihood:**\n        *   The total partial likelihood `L(beta)` is the product of the individual contributions from all events.\n        *   `L(beta) = L_M1(beta) * L_F1(beta) * L_F4(beta)`\n        *   `L(beta) = [exp(beta) / (2*exp(beta) + 1)] * [exp(beta) / (2*exp(beta) + 2)] * [1 / (exp(beta) + 2)]`\n        *   `L(beta) = [exp(beta)]^2 / [(2*exp(beta) + 1) * (2*exp(beta) + 2) * (exp(beta) + 2)]`\n        *   `L(beta) = exp(2*beta) / [(2*exp(beta) + 1) * 2*(exp(beta) + 1) * (exp(beta) + 2)]`\n        *   Let's simplify the denominator slightly for the final expression.\n        *   `L(beta) = exp(2*beta) / [2 * (2*exp(beta) + 1) * (exp(beta) + 1) * (exp(beta) + 2)]`\n\n    *   **Final Answer Formatting:**\n        *   The answer should be a single analytic expression `L(beta)`.\n        *   I will use `\\exp(\\beta)` and `\\exp(2\\beta)`.\n        *   The final expression is: `\\frac{\\exp(2\\beta)}{2(2\\exp(\\beta) + 1)(\\exp(\\beta) + 1)(\\exp(\\beta) + 2)}`.\n\n5.  **Review and Double-Check:**\n\n    *   **Problem Validation:**\n        *   Givens: The model `lambda_{1,s}(t | z) = lambda_{1,0,s}(t) * exp(beta * z)`, the data for 7 patients, the definition of strata (`s`=sex), the definition of events (1=progression, 2=death, cens=censored), and the handling of competing risks (cause 2 is treated as censoring for the cause-specific analysis of cause 1).\n        *   Scientifically Grounded: Yes, this is a standard application of survival analysis in biostatistics. The Cox model and competing risks framework are well-established.\n        *   Well-Posed: Yes, the problem is well-defined and leads to a unique expression for the partial likelihood.\n        *   Objective: Yes, the language is precise and quantitative.\n        *   Verdict: **Valid**.\n\n    *   **Solution Logic:**\n        *   Stratification: Correctly handled by separating the data into male and female cohorts and forming risk sets within each.\n        *   Risk Sets:\n            *   Event at `t=3` (Male, z=1): Risk set is {M1, M2, M3}. `z` values are {1, 0, 1}. Correct.\n            *   Event at `t=4` (Female, z=1): Risk set is {F1, F2, F3, F4}. `z` values are {1, 0, 1, 0}. Correct.\n            *   Event at `t=5` (Female, z=0): Risk set is {F2, F3, F4} since F1 had an event at `t=4`. `z` values are {0, 1, 0}. Correct.\n        *   Competing Risk Handling: Correctly treated cause 2 events as censoring. For example, patient F2 (t=6, type=2) is in the risk set at `t=4` and `t=5` but is removed from risk after `t=6`. Patient M2 (t=8, type=2) is in the risk set at `t=3` but removed after `t=8`. This is the standard cause-specific hazard approach.\n        *   Partial Likelihood Terms:\n            *   `t=3`: Numerator `exp(beta*1)`, Denominator `exp(beta*1) + exp(beta*0) + exp(beta*1) = 2*exp(beta) + 1`. Correct.\n            *   `t=4`: Numerator `exp(beta*1)`, Denominator `exp(beta*1) + exp(beta*0) + exp(beta*1) + exp(beta*0) = 2*exp(beta) + 2`. Correct.\n            *   `t=5`: Numerator `exp(beta*0)`, Denominator `exp(beta*0) + exp(beta*1) + exp(beta*0) = exp(beta) + 2`. Correct.\n        *   Total Likelihood `L(beta)`: Product of the three terms.\n            `[exp(beta) / (2*exp(beta) + 1)] * [exp(beta) / (2*exp(beta) + 2)] * [1 / (exp(beta) + 2)]`\n            `= exp(2*beta) / [(2*exp(beta) + 1) * (2(exp(beta) + 1)) * (exp(beta) + 2)]`\n            `= exp(2*beta) / [2 * (2*exp(beta) + 1) * (exp(beta) + 1) * (exp(beta) + 2)]`\n            Looks correct. The algebra is straightforward.\n\n    *   **Final Output Format Check:**\n        *   Everything must be in LaTeX.\n        *   No markdown headers.\n        *   Final answer in `\\boxed{...}`.\n        *   Using `\\exp(...)`.\n        *   Using `\\frac{...}{...}`.\n        *   The logic and calculation appear sound. I am ready to write the solution.", "answer": "$$\n\\boxed{\\frac{\\exp(2\\beta)}{2(2\\exp(\\beta)+1)(\\exp(\\beta)+1)(\\exp(\\beta)+2)}}\n$$", "id": "4610388"}, {"introduction": "A common question when learning about stratified models is, 'Why not just add the stratifying variable as a covariate in a standard Cox model?' This exercise provides a decisive answer by presenting a hypothetical but illustrative clinical scenario where doing so leads to model failure. You will explore how non-proportional hazards, a common issue in real-world data, can make parameter estimates for a standard model undefinable, and then see how stratification elegantly resolves the problem by allowing for different baseline hazard shapes in each group. [@problem_id:4985401]", "problem": "A clinical cohort study enrolls patients at baseline time $t=0$ from two hospitals, indexed by a stratum indicator $Z \\in \\{0,1\\}$, with $Z=0$ for Hospital A and $Z=1$ for Hospital B. A single binary biomarker covariate $X \\in \\{0,1\\}$ is measured at baseline. Due to changes in supportive care, Hospital B exhibits a delayed baseline hazard pattern (a time shift), so its event times occur later than those in Hospital A, even when the biomarker $X$ is the same. This phenomenon is not a constant multiplicative change in hazard over time and therefore cannot be encoded as a time-invariant log-hazard ratio for $Z$ under proportional hazards.\n\nThe data consist of $8$ patients, $4$ per hospital, all entering at $t=0$. The observed event and censoring times are:\n- Hospital A ($Z=0$): two patients with $X=1$ and two with $X=0$. One patient with $X=1$ fails at $t=1$, one patient with $X=0$ fails at $t=2$, and the other two are administratively censored at $t=3$.\n- Hospital B ($Z=1$): two patients with $X=1$ and two with $X=0$. One patient with $X=0$ fails at $t=5$, one patient with $X=1$ fails at $t=6$, and the other two are administratively censored at $t=7$.\n\nAssume no tied event times and that censoring is independent and non-informative. Consider two modeling strategies:\n1. An unstratified Cox Proportional Hazards (CPH) model with linear predictor $\\beta X + \\gamma Z$, so the hazard is $h(t \\mid X,Z) = h_{0}(t)\\,\\exp(\\beta X + \\gamma Z)$ with a single baseline hazard $h_{0}(t)$ for all patients.\n2. A stratified Cox model by hospital, with common biomarker effect but stratum-specific baseline hazards $h_{0Z}(t)$: $h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$.\n\nStarting from the definition of the CPH model and its partial likelihood, and using the given event times and risk sets induced by the data, derive the partial likelihood for the stratified model and show how stratification removes the violation caused by the delayed baseline hazard in Hospital B. Then, contrast with the unstratified indicator-adjusted model, explaining why a time-invariant $\\gamma$ cannot absorb a time shift and how maximizing the partial likelihood in $\\gamma$ fails (i.e., does not achieve a finite maximizer), thereby demonstrating that indicator adjustment does not resolve the non-proportionality.\n\nWhat is the maximum partial likelihood estimate of the common biomarker log-hazard ratio $\\beta$ under the correctly stratified Cox model for this data? You may leave the final answer in exact form. Do not include units. If an approximation were needed, round to four significant figures, but here an exact value is acceptable.", "solution": "The user wants me to analyze two Cox modeling strategies for a given survival dataset and to compute the maximum partial likelihood estimate for the biomarker effect in the correctly specified stratified model.\n\n### Step 1: Extract Givens\n- **Stratum Indicator**: $Z \\in \\{0,1\\}$, where $Z=0$ for Hospital A and $Z=1$ for Hospital B.\n- **Biomarker Covariate**: $X \\in \\{0,1\\}$.\n- **Patient Data**:\n    - **Hospital A ($Z=0$)**: $4$ patients start at $t=0$.\n        - Two patients with $X=1$. One fails at $t=1$, the other is censored at $t=3$.\n        - Two patients with $X=0$. One fails at $t=2$, the other is censored at $t=3$.\n    - **Hospital B ($Z=1$)**: $4$ patients start at $t=0$.\n        - Two patients with $X=1$. One fails at $t=6$, the other is censored at $t=7$.\n        - Two patients with $X=0$. One fails at $t=5$, the other is censored at $t=7$.\n- **Event Times**: $t=1$ ($Z=0, X=1$), $t=2$ ($Z=0, X=0$), $t=5$ ($Z=1, X=0$), $t=6$ ($Z=1, X=1$).\n- **Model 1 (Unstratified)**: Hazard $h(t \\mid X,Z) = h_{0}(t)\\,\\exp(\\beta X + \\gamma Z)$.\n- **Model 2 (Stratified)**: Hazard $h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$.\n- **Assumptions**: No tied event times, independent and non-informative censoring.\n\n### Step 2: Validate Using Extracted Givens\n1.  **Scientifically Grounded**: The problem is set within the established framework of survival analysis, specifically Cox proportional hazards models and stratification. These are standard, well-understood statistical methods used in medical research. The scenario of non-proportional hazards due to differing hospital protocols is scientifically realistic.\n2.  **Well-Posed**: The problem is structured to have a unique and meaningful solution. It asks for a specific derivation and calculation based on provided data and model definitions. The data are sufficient to perform the analysis.\n3.  **Objective**: The problem is stated using precise, objective mathematical and statistical terms ($h(t)$, $\\beta$, stratified model, partial likelihood). There are no subjective or opinion-based statements.\n4.  **Complete and Consistent**: All necessary data (event times, censoring times, covariates, stratum indicators) and model forms are provided. There are no contradictions in the setup.\n5.  **Not Ill-Posed**: While the unstratified model is shown to be ill-posed (no finite MLE for $\\gamma$), this is part of the problem's explicit goal: to demonstrate this failure. The core task of finding $\\beta$ under the stratified model is well-posed.\n\n### Step 3: Verdict and Action\nThe problem is valid. I will proceed with the full solution.\n\n### Derivation and Solution\n\nThe problem requires a comparative analysis of two Cox modeling strategies and the calculation of a parameter estimate for the superior model. We begin by defining the Cox partial likelihood, then apply it to both the stratified and unstratified models to demonstrate their properties with the given data.\n\nThe partial likelihood for a Cox model with parameter vector $\\boldsymbol{\\theta}$ is given by the product of probabilities over the distinct failure times $t_{(1)}  t_{(2)}  \\dots  t_{(D)}$. For each failure at time $t_{(i)}$, the contribution to the likelihood is the conditional probability that the specific subject $i$ fails, given that a failure occurred at that time among the set of subjects at risk, $R(t_{(i)})$.\n$$\nL(\\boldsymbol{\\theta}) = \\prod_{i=1}^{D} \\frac{h(t_{(i)} \\mid \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} h(t_{(j)} \\mid \\mathbf{x}_j)} = \\prod_{i=1}^{D} \\frac{h_{0}(t_{(i)}) \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} h_{0}(t_{(i)}) \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_j)} = \\prod_{i=1}^{D} \\frac{\\exp(\\boldsymbol{\\theta}' \\mathbf{x}_i)}{\\sum_{j \\in R(t_{(i)})} \\exp(\\boldsymbol{\\theta}' \\mathbf{x}_j)}\n$$\nwhere $\\mathbf{x}_i$ is the covariate vector for subject $i$.\n\n**Analysis of the Stratified Model (Model 2)**\n\nThe stratified model is defined by the hazard function $h(t \\mid X,Z) = h_{0Z}(t)\\,\\exp(\\beta X)$. The key feature of stratification is that the baseline hazard $h_{0Z}(t)$ is specific to each stratum $Z \\in \\{0, 1\\}$. Consequently, risk sets are formed *within* each stratum, and the total partial likelihood is the product of the partial likelihoods from each stratum.\n$$\nL_{\\text{stratified}}(\\beta) = L_{Z=0}(\\beta) \\times L_{Z=1}(\\beta)\n$$\nThis model structure inherently accommodates the \"delayed baseline hazard\" in Hospital B ($Z=1$). The difference in event timing patterns between hospitals is absorbed by the different baseline hazard functions, $h_{00}(t)$ and $h_{01}(t)$. The model does not assume a constant hazard ratio between the hospitals, thus correctly handling the non-proportionality. Comparisons are only made between patients within the same hospital.\n\n**Analysis of the Unstratified Model (Model 1) and its Failure**\n\nThe unstratified model, $h(t \\mid X,Z) = h_0(t)\\,\\exp(\\beta X + \\gamma Z)$, assumes a common baseline hazard $h_0(t)$ and that the hazard ratio between hospitals is constant over time, given by $\\exp(\\gamma)$. We now demonstrate why this assumption is untenable for the given data and leads to a non-finite estimate for $\\gamma$.\n\nThe ordered event times for the combined cohort are $t=1$, $t=2$, $t=5$, and $t=6$.\nThe log-partial likelihood is $\\ell(\\beta, \\gamma) = \\sum_{i: \\text{failure}} \\left( (\\beta X_i + \\gamma Z_i) - \\ln \\left( \\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma Z_j) \\right) \\right)$.\n\nThe data show a complete separation of failure times by hospital: all failures in Hospital A ($Z=0$, at $t=1, 2$) occur before any failures in Hospital B ($Z=1$, at $t=5, 6$). Let's examine the score function for $\\gamma$, $\\frac{\\partial \\ell}{\\partial \\gamma} = \\sum_{i: \\text{failure}} \\left( Z_i - \\frac{\\sum_{j \\in R(t_i)} Z_j \\exp(\\beta X_j + \\gamma Z_j)}{\\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma Z_j)} \\right)$.\n\n- For the events at $t=1$ and $t=2$, the failing individual has $Z_i=0$. The risk sets $R(1)$ and $R(2)$ contain individuals from both hospitals ($Z=0$ and $Z=1$). The term for these events is $0 - P(Z=1 \\mid j \\in R(t_i) \\text{ selected to fail})$. Since individuals with $Z=1$ are in the risk set but do not fail, this term is negative.\n- For the events at $t=5$ and $t=6$, the failing individual has $Z_i=1$. However, the two non-failing patients from Hospital A were censored at $t=3$. Thus, the risk sets $R(5)$ and $R(6)$ contain *only* individuals from Hospital B, for whom $Z_j = 1$. For these events, the score contribution is $1 - \\frac{\\sum_{j \\in R(t_i)} 1 \\cdot \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(t_i)} \\exp(\\beta X_j + \\gamma)} = 1 - 1 = 0$.\n\nTherefore, the score for $\\gamma$ depends only on the first two failure times:\n$$\n\\frac{\\partial \\ell}{\\partial \\gamma} = - \\frac{\\sum_{j \\in R(1), Z_j=1} \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(1)} \\exp(\\beta X_j + \\gamma Z_j)} - \\frac{\\sum_{j \\in R(2), Z_j=1} \\exp(\\beta X_j + \\gamma)}{\\sum_{j \\in R(2)} \\exp(\\beta X_j + \\gamma Z_j)}\n$$\nLet's write out the sums for the first term. At $t=1$, $R(1)$ has all $8$ patients.\nNumerator: $2\\exp(\\beta+\\gamma) + 2\\exp(\\gamma) = 2\\exp(\\gamma)(\\exp(\\beta)+1)$.\nDenominator: $2\\exp(\\beta) + 2 + 2\\exp(\\beta+\\gamma) + 2\\exp(\\gamma) = 2(\\exp(\\beta)+1) + 2\\exp(\\gamma)(\\exp(\\beta)+1)$.\nThe term is $-\\frac{2\\exp(\\gamma)(\\exp(\\beta)+1)}{2(\\exp(\\beta)+1) + 2\\exp(\\gamma)(\\exp(\\beta)+1)} = -\\frac{\\exp(\\gamma)}{1+\\exp(\\gamma)}$.\nA similar calculation for the second term also yields a negative value. As long as $\\exp(\\beta)+10$ (which is always true), both terms in the score equation for $\\gamma$ are strictly negative for any finite $\\gamma$.\nSince $\\frac{\\partial \\ell}{\\partial \\gamma}  0$, the log-likelihood is a monotonically decreasing function of $\\gamma$. The likelihood is therefore maximized as $\\gamma \\to -\\infty$. This indicates there is no finite Maximum Likelihood Estimate (MLE) for $\\gamma$. The model is trying to make the hazard for Hospital B infinitely small relative to Hospital A to explain why all Hospital B failures occurred later, which is a failure of the proportional hazards assumption that a time-invariant $\\gamma$ cannot fix.\n\n**Calculation of $\\beta_{MLE}$ for the Stratified Model**\n\nWe now calculate the MLE for the common biomarker effect $\\beta$ under the correctly specified stratified model.\n$\\ell_{\\text{stratified}}(\\beta) = \\ell_{Z=0}(\\beta) + \\ell_{Z=1}(\\beta)$.\n\n**Stratum 1: Hospital A ($Z=0$)**\n- Event at $t=1$: Failure has $X=1$. Risk set $R_A(1)$ has subjects with $X$ values $\\{1, 1, 0, 0\\}$.\n  Likelihood term: $\\frac{\\exp(\\beta \\cdot 1)}{\\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0)} = \\frac{\\exp(\\beta)}{2\\exp(\\beta) + 2}$.\n- Event at $t=2$: Failure has $X=0$. Risk set $R_A(2)$ has subjects with $X$ values $\\{1, 0, 0\\}$ (one subject with $X=1$ failed at $t=1$).\n  Likelihood term: $\\frac{\\exp(\\beta \\cdot 0)}{\\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0)} = \\frac{1}{\\exp(\\beta) + 2}$.\nSo, $\\ell_{Z=0}(\\beta) = \\ln\\left(\\frac{\\exp(\\beta)}{2\\exp(\\beta) + 2}\\right) + \\ln\\left(\\frac{1}{\\exp(\\beta) + 2}\\right) = \\beta - \\ln(2(\\exp(\\beta)+1)) - \\ln(\\exp(\\beta)+2)$.\n\n**Stratum 2: Hospital B ($Z=1$)**\n- Event at $t=5$: Failure has $X=0$. Risk set $R_B(5)$ has subjects with $X$ values $\\{0, 0, 1, 1\\}$.\n  Likelihood term: $\\frac{\\exp(\\beta \\cdot 0)}{\\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1)} = \\frac{1}{2 + 2\\exp(\\beta)}$.\n- Event at $t=6$: Failure has $X=1$. Risk set $R_B(6)$ has subjects with $X$ values $\\{0, 1, 1\\}$ (one subject with $X=0$ failed at $t=5$).\n  Likelihood term: $\\frac{\\exp(\\beta \\cdot 1)}{\\exp(\\beta \\cdot 0) + \\exp(\\beta \\cdot 1) + \\exp(\\beta \\cdot 1)} = \\frac{\\exp(\\beta)}{1 + 2\\exp(\\beta)}$.\nSo, $\\ell_{Z=1}(\\beta) = \\ln\\left(\\frac{1}{2 + 2\\exp(\\beta)}\\right) + \\ln\\left(\\frac{\\exp(\\beta)}{1 + 2\\exp(\\beta)}\\right) = -\\ln(2(1+\\exp(\\beta))) + \\beta - \\ln(1+2\\exp(\\beta))$.\n\n**Total Log-Likelihood and Score Equation**\n$\\ell_{\\text{stratified}}(\\beta) = \\ell_{Z=0}(\\beta) + \\ell_{Z=1}(\\beta) = 2\\beta - 2\\ln(2) - 2\\ln(\\exp(\\beta)+1) - \\ln(\\exp(\\beta)+2) - \\ln(1+2\\exp(\\beta))$.\nTo find the MLE, we differentiate with respect to $\\beta$ and set the result to $0$:\n$$\n\\frac{d\\ell_{\\text{stratified}}}{d\\beta} = 2 - \\frac{2\\exp(\\beta)}{\\exp(\\beta)+1} - \\frac{\\exp(\\beta)}{\\exp(\\beta)+2} - \\frac{2\\exp(\\beta)}{1+2\\exp(\\beta)} = 0\n$$\nLet $u = \\exp(\\beta)$. Since $\\beta$ is real, $u  0$. The score equation becomes:\n$$\n2 = \\frac{2u}{u+1} + \\frac{u}{u+2} + \\frac{2u}{1+2u}\n$$\nAssuming $u \\neq 0$, we can divide by $u$:\n$$\n\\frac{2}{u} = \\frac{2}{u+1} + \\frac{1}{u+2} + \\frac{2}{1+2u}\n$$\nRearranging terms:\n$$\n\\frac{2}{u} - \\frac{2}{u+1} = \\frac{1}{u+2} + \\frac{2}{1+2u}\n$$\n$$\n\\frac{2(u+1) - 2u}{u(u+1)} = \\frac{(1+2u) + 2(u+2)}{(u+2)(1+2u)}\n$$\n$$\n\\frac{2}{u(u+1)} = \\frac{4u+5}{(u+2)(2u+1)}\n$$\nCross-multiplying gives:\n$$\n2(u+2)(2u+1) = u(u+1)(4u+5)\n$$\n$$\n2(2u^2 + 5u + 2) = u(4u^2 + 9u + 5)\n$$\n$$\n4u^2 + 10u + 4 = 4u^3 + 9u^2 + 5u\n$$\nThis simplifies to the cubic equation:\n$$\n4u^3 + 5u^2 - 5u - 4 = 0\n$$\nWe can test for simple rational roots. Let $P(u) = 4u^3 + 5u^2 - 5u - 4$.\n$P(1) = 4(1)^3 + 5(1)^2 - 5(1) - 4 = 4 + 5 - 5 - 4 = 0$.\nThus, $u=1$ is a root. This corresponds to $\\exp(\\hat{\\beta}) = 1$, which gives $\\hat{\\beta} = \\ln(1) = 0$.\n\nTo check for other positive roots, we factor the polynomial:\n$(u-1)(4u^2 + 9u + 4) = 0$.\nThe quadratic factor $4u^2 + 9u + 4 = 0$ has discriminant $\\Delta = 9^2 - 4(4)(4) = 81 - 64 = 17  0$. The roots are $u = \\frac{-9 \\pm \\sqrt{17}}{8}$. Since $\\sqrt{17}  \\sqrt{81} = 9$, both of these roots are negative. As $u = \\exp(\\beta)$ must be positive, these are not valid solutions.\nTherefore, the only valid solution is $u=1$, which implies $\\hat{\\beta}=0$.\n\nA check of the second derivative of the log-likelihood (the information) at $\\beta=0$ confirms it is negative, so this solution corresponds to a maximum.\n$$\n\\frac{d^2\\ell}{d\\beta^2}\\bigg|_{\\beta=0} = -\\frac{2\\exp(0)}{(\\exp(0)+1)^2} - \\frac{2\\exp(0)}{(\\exp(0)+2)^2} - \\frac{2\\exp(0)}{(1+2\\exp(0))^2} = -\\frac{2}{4} - \\frac{2}{9} - \\frac{2}{9} = -\\frac{1}{2} - \\frac{4}{9} = -\\frac{17}{18}  0\n$$\nThus, the maximum partial likelihood estimate for $\\beta$ is $0$.", "answer": "$$\n\\boxed{0}\n$$", "id": "4985401"}, {"introduction": "Beyond analyzing existing data, a key role for a statistician is to design future studies with sufficient power to detect meaningful effects. This exercise extends the principles of the stratified Cox model into the domain of study design. By deriving the formula for the minimum detectable hazard ratio from first principles, you will see how statistical information aggregates across strata and how expected event counts and covariate variance directly influence the power of a stratified clinical trial. [@problem_id:4985403]", "problem": "A randomized clinical study will be analyzed with a stratified Cox proportional hazards (PH) model. There are $K$ strata indexed by $s \\in \\{1,\\dots,K\\}$, each with its own baseline hazard function but a common log-hazard ratio parameter $\\theta$ for a single covariate $X$. Let $d_s$ denote the expected number of observed events in stratum $s$, and let $v_s$ denote the anticipated average within-risk-set variance of $X$ in stratum $s$ over event times, as obtained from prior data or pilot information. Assume a two-sided hypothesis test of $H_0:\\theta=0$ at type I error $\\alpha$ and target power $1-\\beta$ to detect a harmful effect with hazard ratio greater than $1$ (that is, $\\theta0$). Let $z_p$ denote the $p$-th quantile of the standard normal distribution.\n\nUsing only the following foundational facts:\n- Under standard large-sample theory for the partial likelihood score in the Cox model, the normalized score statistic for $\\theta$ is asymptotically normal with mean proportional to $\\theta$ and variance $1$.\n- Under stratification with independent strata and a common $\\theta$, Fisher information about $\\theta$ adds across strata.\n- Under Schoenfeldâ€™s large-sample approximation for the Cox model, each observed event contributes information approximately equal to the within-risk-set variance of $X$, so that the total information can be approximated from the anticipated event counts and within-risk-set variances,\n\nderive from first principles a closed-form analytic expression for the smallest detectable hazard ratio $HR_{\\text{det}}$ (greater than $1$) as a function of $\\alpha$, $\\beta$, $\\{d_s\\}_{s=1}^K$, and $\\{v_s\\}_{s=1}^K$. Express your final answer as a single analytic expression for $HR_{\\text{det}}$ in terms of $z_{1-\\alpha/2}$, $z_{1-\\beta}$, and $\\sum_{s=1}^K d_s v_s$. No numerical evaluation or rounding is required.", "solution": "The user wants me to act as a meticulous STEM professor and solve a problem related to stratified Cox models.\n\n### Step 1: Extract Givens\n- Model: Stratified Cox proportional hazards (PH) model.\n- Strata: $K$ strata, indexed by $s \\in \\{1, \\dots, K\\}$.\n- Hazard Model: Each stratum has a unique baseline hazard $h_{0s}(t)$, but all strata share a common log-hazard ratio parameter $\\theta$ for a single covariate $X$. The hazard for an individual $i$ in stratum $s$ is $h_i(t|X_i) = h_{0s}(t) \\exp(\\theta X_i)$.\n- Expected Events: $d_s$ is the expected number of observed events in stratum $s$.\n- Covariate Variance: $v_s$ is the anticipated average within-risk-set variance of $X$ in stratum $s$.\n- Hypothesis Test: A two-sided test of the null hypothesis $H_0: \\theta=0$.\n- Type I Error: $\\alpha$.\n- Power: $1-\\beta$ for detecting an alternative hypothesis where the hazard ratio is greater than $1$, which corresponds to $\\theta  0$.\n- Notation: $z_p$ denotes the $p$-th quantile of the standard normal distribution.\n- Foundational Facts:\n    1. The normalized score statistic for $\\theta$ is asymptotically normal with a mean proportional to $\\theta$ and a variance of $1$.\n    2. Fisher information about the common parameter $\\theta$ is additive across independent strata.\n    3. Schoenfeld's large-sample approximation: The information contributed by each event is approximately the within-risk-set variance of the covariate $X$.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is based on the well-established statistical theory of the Cox proportional hazards model, including stratification, score tests, and power calculations using standard large-sample approximations (e.g., Schoenfeld's formula). All principles are standard in biostatistics and survival analysis.\n- **Well-Posed**: The problem is clearly stated and provides all necessary components to derive the requested formula. It asks for a derivation of a standard power/sample size formula, which has a unique and meaningful solution.\n- **Objective**: The language is technical and precise, with no subjectivity or ambiguity.\n\nThe problem does not violate any of the invalidity criteria. It is a scientifically sound, well-posed, and objective question that can be solved by applying the fundamental principles of statistical inference as specified.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A full derivation will be provided.\n\n### Derivation\nThe objective is to derive an expression for the smallest detectable hazard ratio, $HR_{\\text{det}}$, which corresponds to a specific log-hazard ratio $\\theta_A  0$ that can be detected with power $1-\\beta$ in a two-sided test at significance level $\\alpha$.\n\nLet $U(\\theta)$ be the score function (the first derivative of the log-partial likelihood with respect to $\\theta$) and $I(\\theta)$ be the Fisher information (the negative of the expected second derivative). The score test for the null hypothesis $H_0: \\theta=0$ is based on the score statistic $U(0)$. The standardized test statistic is given by:\n$$\nZ = \\frac{U(0)}{\\sqrt{I(0)}}\n$$\nUnder $H_0: \\theta=0$, this statistic is asymptotically distributed as a standard normal random variable, $Z \\sim N(0, 1)$.\n\nFor a two-sided test with a Type I error rate of $\\alpha$, we reject the null hypothesis $H_0$ if the observed value of $|Z|$ exceeds the critical value $z_{1-\\alpha/2}$. That is, the rejection region is $\\{z \\in \\mathbb{R} : |z|  z_{1-\\alpha/2}\\}$.\n\nNow, we consider the distribution of $Z$ under a specific alternative hypothesis $H_A: \\theta = \\theta_A  0$. Based on large-sample theory for likelihood-based tests (and consistent with the first foundational fact provided), the test statistic $Z$ under $H_A$ is asymptotically normally distributed with a non-zero mean and variance $1$:\n$$\nZ | H_A \\sim N(\\theta_A \\sqrt{I(0)}, 1)\n$$\nThe power of the test, $1-\\beta$, is the probability of correctly rejecting $H_0$ when $H_A$ is true. Since we are interested in detecting an effect where $\\theta_A  0$, the mean of $Z$ under $H_A$ is positive, and the test statistic will tend to be large and positive. The power is thus:\n$$\n1-\\beta = P(|Z|  z_{1-\\alpha/2} | \\theta = \\theta_A) = P(Z  z_{1-\\alpha/2} | \\theta = \\theta_A) + P(Z  -z_{1-\\alpha/2} | \\theta = \\theta_A)\n$$\nFor a well-powered study, the mean $\\theta_A \\sqrt{I(0)}$ is sufficiently large and positive, making the second term, $P(Z  -z_{1-\\alpha/2})$, negligible. Therefore, we can accurately approximate the power by considering only the upper tail of the rejection region:\n$$\n1-\\beta \\approx P(Z  z_{1-\\alpha/2} | \\theta = \\theta_A)\n$$\nTo evaluate this probability, we standardize the random variable $Z$ using its distribution under $H_A$. Let $\\tilde{Z} = Z - \\theta_A \\sqrt{I(0)}$. Under $H_A$, $\\tilde{Z} \\sim N(0,1)$.\nThe power equation becomes:\n$$\n1-\\beta \\approx P(\\tilde{Z} + \\theta_A \\sqrt{I(0)}  z_{1-\\alpha/2})\n$$\n$$\n1-\\beta \\approx P(\\tilde{Z}  z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})\n$$\nLet $\\Phi(\\cdot)$ be the cumulative distribution function (CDF) of the standard normal distribution. Then $P(\\tilde{Z}  x) = 1 - \\Phi(x)$.\n$$\n1-\\beta \\approx 1 - \\Phi(z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})\n$$\nThis implies $\\beta \\approx \\Phi(z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)})$. By the definition of the standard normal quantile $z_p$, we have $\\Phi(z_p)=p$. Thus:\n$$\nz_{\\beta} \\approx z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)}\n$$\nUsing the symmetry of the standard normal distribution, $z_{\\beta} = -z_{1-\\beta}$. Substituting this into the equation gives:\n$$\n-z_{1-\\beta} \\approx z_{1-\\alpha/2} - \\theta_A \\sqrt{I(0)}\n$$\nSolving for $\\theta_A$, the minimum detectable log-hazard ratio, we get:\n$$\n\\theta_A \\sqrt{I(0)} \\approx z_{1-\\alpha/2} + z_{1-\\beta}\n$$\n$$\n\\theta_A \\approx \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{I(0)}}\n$$\nNext, we must determine the total Fisher information $I(0)$. The second foundational fact states that information is additive across the $K$ independent strata:\n$$\nI(0) = \\sum_{s=1}^K I_s(0)\n$$\nwhere $I_s(0)$ is the information from stratum $s$.\nThe third foundational fact provides Schoenfeld's approximation: the total information is the sum of the within-risk-set variances of the covariate $X$ over all event times. In stratum $s$, we expect $d_s$ events, and the anticipated average within-risk-set variance is $v_s$. Thus, the total information from stratum $s$ is approximated as:\n$$\nI_s(0) \\approx d_s v_s\n$$\nSumming over all strata, the total Fisher information is:\n$$\nI(0) \\approx \\sum_{s=1}^K d_s v_s\n$$\nSubstituting this expression for $I(0)$ into our equation for $\\theta_A$:\n$$\n\\theta_A = \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}}\n$$\nThe problem asks for the smallest detectable hazard ratio, $HR_{\\text{det}}$, not the log-hazard ratio. The relationship is $HR = \\exp(\\theta)$. Therefore,\n$$\nHR_{\\text{det}} = \\exp(\\theta_A) = \\exp\\left( \\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}} \\right)\n$$\nThis is the final closed-form analytic expression for the smallest detectable hazard ratio as a function of the specified parameters.", "answer": "$$\n\\boxed{\\exp\\left(\\frac{z_{1-\\alpha/2} + z_{1-\\beta}}{\\sqrt{\\sum_{s=1}^K d_s v_s}}\\right)}\n$$", "id": "4985403"}]}