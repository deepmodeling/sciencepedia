{"hands_on_practices": [{"introduction": "Mastering fluorescence microscopy begins with understanding its fundamental physical boundaries. No matter how perfect the lenses or sensitive the camera, the wave nature of light imposes a hard limit on the smallest details that can be distinguished, a principle known as the diffraction limit. This exercise [@problem_id:5108031] challenges you to derive and calculate this limit for a typical high-resolution objective, providing a tangible value for the best possible resolving power and helping you interpret what you see—and what you cannot see—at the cellular level.", "problem": "In direct immunofluorescence microscopy of human skin, immunoglobulin deposits at the basement membrane zone (BMZ) are visualized using fluorescein isothiocyanate (FITC)-conjugated antibodies, whose emission is centered near $520\\,\\mathrm{nm}$. Consider imaging such deposits with an oil-immersion objective of numerical aperture (NA) $1.4$, in a diffraction-limited system that collects fluorescence emission. Starting from (i) the definition of numerical aperture, $\\mathrm{NA} = n \\sin(\\theta_{\\max})$, where $n$ is the refractive index of the immersion medium and $\\theta_{\\max}$ is the maximal half-angle of the objective’s collection cone, and (ii) the well-established property that incoherent fluorescence imaging has an optical transfer function whose spatial-frequency support is finite with a cutoff determined by the pupil geometry, derive the smallest resolvable lateral spatial period $d$ as a function of the emission wavelength $\\lambda$ and the numerical aperture $\\mathrm{NA}$. Then, evaluate $d$ for $\\lambda = 520\\,\\mathrm{nm}$ and $\\mathrm{NA} = 1.4$. Express your numerical result in nanometers, and round your answer to four significant figures. Finally, based on the computed $d$, explain whether thin, linear BMZ deposits whose intrinsic physical thickness is on the order of tens of nanometers would appear as continuous linear structures, and whether substructures finer than $d$ would be separable under these imaging conditions.", "solution": "The problem as stated is scientifically grounded, well-posed, and objective. It provides all necessary parameters and relies on fundamental principles of Fourier optics as applied to fluorescence microscopy. The values provided for the emission wavelength ($\\lambda = 520\\,\\mathrm{nm}$) and numerical aperture ($\\mathrm{NA} = 1.4$) are typical and physically realistic for the described experimental setup. Therefore, the problem is valid, and a solution can be formulated.\n\nThe problem asks for a derivation of the smallest resolvable lateral spatial period, $d$, in a diffraction-limited incoherent imaging system. This quantity is fundamentally determined by the spatial-frequency cutoff of the system's Optical Transfer Function (OTF). An object can be represented as a superposition of sinusoidal patterns of varying spatial frequencies. The OTF describes the system's ability to transfer the contrast of these patterns from the object to the image. The highest spatial frequency that the system can transmit, denoted as $f_{\\text{cutoff}}$, defines the finest possible detail that can be resolved. The smallest resolvable spatial period $d$ is the reciprocal of this cutoff frequency, $d = 1/f_{\\text{cutoff}}$.\n\nFor an incoherent imaging system, such as fluorescence microscopy where fluorophores emit independently, the OTF is given by the normalized autocorrelation of the system's pupil function. The pupil function, $P(\\mathbf{f})$, defines the aperture through which light is collected, expressed in terms of spatial frequencies $\\mathbf{f}$. For a circular objective aperture in a diffraction-limited system, the pupil function is a circular disk. The radius of this disk, $f_{\\text{pupil}}$, represents the maximum spatial frequency that can be collected by the objective.\n\nThis maximum spatial frequency is determined by the largest angle of diffraction that the objective can capture. Light from a structure with spatial frequency $f$ is diffracted at an angle $\\alpha$ according to the grating equation $n \\sin(\\alpha) = f \\lambda$, where $n$ is the refractive index of the medium between the object and the objective, and $\\lambda$ is the vacuum wavelength of the light. The objective collects light within a cone defined by the maximal half-angle $\\theta_{\\max}$. Thus, the maximum collectible spatial frequency corresponds to $\\alpha = \\theta_{\\max}$.\n$$f_{\\text{pupil}} = \\frac{n \\sin(\\theta_{\\max})}{\\lambda}$$\nUsing the definition of numerical aperture, $\\mathrm{NA} = n \\sin(\\theta_{\\max})$, we can write the radius of the pupil function as:\n$$f_{\\text{pupil}} = \\frac{\\mathrm{NA}}{\\lambda}$$\nThe OTF for an incoherent system is the autocorrelation of this circular pupil function. The mathematical operation of autocorrelation of a function with a given support (in this case, a disk of a certain radius) results in a new function whose support extends to twice the original dimension. Therefore, the cutoff frequency of the incoherent OTF is twice the radius of the pupil function:\n$$f_{\\text{cutoff}} = 2 \\times f_{\\text{pupil}} = \\frac{2\\,\\mathrm{NA}}{\\lambda}$$\nAny spatial frequencies in the object higher than $f_{\\text{cutoff}}$ will not be present in the image. The smallest resolvable spatial period $d$ is the inverse of this maximum spatial frequency:\n$$d = \\frac{1}{f_{\\text{cutoff}}} = \\frac{\\lambda}{2\\,\\mathrm{NA}}$$\nThis expression represents the smallest period of a sinusoidal grating that can be resolved by the microscope, often referred to as the Abbe diffraction limit for incoherent imaging.\n\nNext, we evaluate $d$ using the provided values: emission wavelength $\\lambda = 520\\,\\mathrm{nm}$ and numerical aperture $\\mathrm{NA} = 1.4$.\n$$d = \\frac{520\\,\\mathrm{nm}}{2 \\times 1.4} = \\frac{520\\,\\mathrm{nm}}{2.8}$$\n$$d = 185.71428...\\,\\mathrm{nm}$$\nRounding this result to four significant figures as requested, we obtain:\n$$d \\approx 185.7\\,\\mathrm{nm}$$\n\nFinally, we interpret this result in the context of imaging immunoglobulin deposits at the basement membrane zone (BMZ).\n\nThe problem states that the intrinsic physical thickness of these deposits is on the order of tens of nanometers (e.g., $20\\,\\mathrm{nm}$ to $50\\,\\mathrm{nm}$). This thickness is substantially smaller than the calculated resolution limit of $d \\approx 185.7\\,\\mathrm{nm}$. When an object's dimensions are smaller than the resolution limit, its true size and shape cannot be resolved. Instead, the image of such a sub-resolution object is determined by the system's point spread function (PSF), which is the image of an ideal point source. The width of the PSF is directly related to the resolution limit $d$.\n\nTherefore, a thin, linear BMZ deposit will be imaged by convolving its actual structure with the system's PSF. Since the physical width of the deposit is much smaller than the width of the PSF, the resulting image will be a blurred line whose apparent width is not the true thickness of the deposit but is dictated by the PSF width, approximately $185.7\\,\\mathrm{nm}$. Along its length, the structure will appear continuous, as the PSFs from adjacent points on the line will overlap to form an unbroken, albeit blurred, line.\n\nRegarding the separability of substructures, the value $d \\approx 185.7\\,\\mathrm{nm}$ represents the fundamental limit of resolution. Any two features of the deposit that are closer together than this distance cannot be distinguished as separate entities. For instance, if the deposit were composed of multiple finer strands, or contained small gaps or clusters, these details would be unresolvable if their characteristic size or spacing were less than $\\approx 185.7\\,\\mathrm{nm}$. The imaging process would average over these details, effectively blurring them out and rendering them invisible. Consequently, substructures finer than $d$ would not be separable under these imaging conditions.", "answer": "$$\\boxed{185.7}$$", "id": "5108031"}, {"introduction": "An image is only as good as its weakest link. While the objective lens determines the optical resolution, the digital camera must be chosen and configured correctly to faithfully record it. This practice [@problem_id:5108063] introduces the critical concept of Nyquist-Shannon sampling, which dictates the proper pixel size needed to capture the details resolved by the optics without losing information. By calculating the maximum allowable pixel size, you will learn how to bridge the gap between the analog, light-based image and its digital representation, a crucial step in quantitative microscopy.", "problem": "In a Direct Immunofluorescence (DIF) microscopy assay for detecting in situ immunoglobulin deposition in a human skin biopsy, fluorescein isothiocyanate-conjugated anti-human immunoglobulin G is used, yielding an emission spectrum peaked at wavelength $520\\ \\mathrm{nm}$. The specimen is imaged on an epifluorescence microscope using a $60\\times$ oil-immersion objective with numerical aperture (NA) $1.40$. Assume diffraction-limited performance dominated by the emission wavelength and an ideal circular aperture.\n\nStarting from fundamental definitions of diffraction-limited resolution for incoherent imaging and sampling theory, derive the lateral diffraction-limited resolution at the specimen plane and the corresponding maximum allowable camera pixel pitch (on the sensor) that ensures Nyquist sampling at total magnification $M=60$. Then compute the maximum allowable camera pixel pitch numerically.\n\nFinally, based on your derived bound, determine within your reasoning whether a scientific camera with pixel pitch $6.5\\ \\mu\\mathrm{m}$ meets the sampling requirement at $60\\times$, but report only the maximum allowable camera pixel pitch as your final numeric answer.\n\nRound your final numeric answer to three significant figures and express it in micrometers.", "solution": "The problem statement is evaluated as valid. It is scientifically grounded in the principles of optical microscopy and digital imaging, is well-posed with all necessary information provided, and is phrased in objective, formal language. The provided values are physically realistic for a high-performance fluorescence microscopy setup.\n\nThe solution proceeds by first deriving the theoretical lateral resolution of the microscope objective, and then applying the Nyquist-Shannon sampling theorem to determine the maximum camera pixel pitch required to adequately sample the image formed by this objective.\n\nThe lateral diffraction-limited resolution, $d$, of an optical system for incoherent imaging is the minimum distance between two point-like sources at the specimen that can be distinguished as separate objects. For a circular aperture, this is conventionally given by the Rayleigh criterion, which is based on the diffraction pattern (Airy disk) produced by each point source. The resolution limit is reached when the central maximum of one point's Airy disk falls on the first minimum of the other's. This distance is given by:\n$$ d = \\frac{0.61 \\lambda}{\\mathrm{NA}} $$\nwhere $\\lambda$ is the wavelength of the emitted light and $\\mathrm{NA}$ is the numerical aperture of the objective lens. For this problem, we use the emission wavelength of the fluorophore, $\\lambda_{\\mathrm{em}} = 520\\ \\mathrm{nm}$, and the objective's numerical aperture, $\\mathrm{NA} = 1.40$.\n\nSubstituting the given values, the resolution at the specimen plane is:\n$$ d = \\frac{0.61 \\times 520\\ \\mathrm{nm}}{1.40} = \\frac{317.2\\ \\mathrm{nm}}{1.40} \\approx 226.57\\ \\mathrm{nm} $$\nThis represents the size of the smallest resolvable feature in the specimen.\n\nNext, we apply the Nyquist-Shannon sampling theorem to determine the appropriate sampling by the digital camera. The theorem states that to avoid aliasing and loss of information, the sampling frequency must be at least twice the highest spatial frequency present in the signal. The highest spatial frequency, $f_{\\mathrm{max}}$, that the objective can resolve is the reciprocal of the smallest resolvable feature size, $d$:\n$$ f_{\\mathrm{max}} = \\frac{1}{d} $$\nThe Nyquist criterion requires a sampling frequency, $f_{\\mathrm{s}}$, such that:\n$$ f_{\\mathrm{s}} \\ge 2 f_{\\mathrm{max}} $$\nIn digital imaging, the sampling frequency is determined by the pixel pitch. The sampling interval in the specimen plane, denoted as $p_{\\mathrm{specimen}}$, is the effective size of a camera pixel projected back onto the specimen. The sampling frequency is its reciprocal, $f_{\\mathrm{s}} = 1/p_{\\mathrm{specimen}}$. The Nyquist criterion can thus be written in terms of the sampling interval:\n$$ \\frac{1}{p_{\\mathrm{specimen}}} \\ge \\frac{2}{d} $$\nThis implies that the maximum allowable sampling interval (effective pixel size) at the specimen is half the resolution distance:\n$$ p_{\\mathrm{specimen}} \\le \\frac{d}{2} $$\n\nThe effective pixel size at the specimen, $p_{\\mathrm{specimen}}$, is related to the physical pixel pitch of the camera sensor, $p_{\\mathrm{camera}}$, by the total magnification of the system, $M$:\n$$ p_{\\mathrm{specimen}} = \\frac{p_{\\mathrm{camera}}}{M} $$\nSubstituting this relationship into the sampling condition yields the requirement for the camera's physical pixel pitch:\n$$ \\frac{p_{\\mathrm{camera}}}{M} \\le \\frac{d}{2} $$\nTherefore, the maximum allowable camera pixel pitch, $p_{\\mathrm{camera, max}}$, that satisfies Nyquist sampling is:\n$$ p_{\\mathrm{camera, max}} = \\frac{M \\cdot d}{2} $$\n\nNow we can combine the expression for $d$ with this result to obtain the complete formula for the maximum allowable camera pixel pitch:\n$$ p_{\\mathrm{camera, max}} = \\frac{M}{2} \\left( \\frac{0.61 \\lambda_{\\mathrm{em}}}{\\mathrm{NA}} \\right) $$\n\nWe compute the numerical value using the provided parameters: $M = 60$, $\\lambda_{\\mathrm{em}} = 520\\ \\mathrm{nm}$, and $\\mathrm{NA} = 1.40$.\n$$ p_{\\mathrm{camera, max}} = \\frac{60}{2} \\left( \\frac{0.61 \\times 520\\ \\mathrm{nm}}{1.40} \\right) = 30 \\times (226.5714...\\ \\mathrm{nm}) $$\n$$ p_{\\mathrm{camera, max}} \\approx 6797.14\\ \\mathrm{nm} $$\nTo express this value in micrometers ($\\mu\\mathrm{m}$), we use the conversion $1\\ \\mu\\mathrm{m} = 1000\\ \\mathrm{nm}$:\n$$ p_{\\mathrm{camera, max}} \\approx 6.79714\\ \\mu\\mathrm{m} $$\nRounding to three significant figures as requested, we get:\n$$ p_{\\mathrm{camera, max}} = 6.80\\ \\mu\\mathrm{m} $$\n\nBased on this derived bound, we can determine whether a scientific camera with a pixel pitch of $6.5\\ \\mu\\mathrm{m}$ meets the sampling requirement. The condition is $p_{\\mathrm{camera}} \\le p_{\\mathrm{camera, max}}$. Since $6.5\\ \\mu\\mathrm{m} < 6.80\\ \\mu\\mathrm{m}$, the camera with a $6.5\\ \\mu\\mathrm{m}$ pixel pitch does satisfy the Nyquist sampling criterion for this optical configuration.\n\nThe final answer required is the numerical value for the maximum allowable camera pixel pitch.", "answer": "$$\n\\boxed{6.80}\n$$", "id": "5108063"}, {"introduction": "Acquiring a high-quality image is the prerequisite, but the ultimate scientific value often lies in extracting objective, quantitative data from it. This advanced practice [@problem_id:5108030] moves from image acquisition to computational analysis, tasking you with building a model to interpret spatial patterns of fluorescence along a biological structure. By implementing algorithms to measure correlation length and nonlinearity, you will learn how to transform qualitative visual impressions of 'linear' or 'punctate' staining into robust, reproducible metrics, a cornerstone of modern immunodiagnostics.", "problem": "In Direct Immunofluorescence (DIF) microscopy of human skin, deposition of immune complexes along the Basement Membrane Zone (BMZ) produces spatial patterns of fluorescence intensity along the BMZ that can be interrogated by one-dimensional line scans. Consider a line scan that samples fluorescence intensity along the BMZ at equally spaced positions. Let the discrete positions be $x_i = i \\cdot s$ for $i \\in \\{0,1,\\dots,N-1\\}$, where $s$ is the pixel size in micrometers ($\\mu \\mathrm{m}$), and let the measured intensity at position $x_i$ be $I_i$. The objectives are to model spatial continuity of BMZ staining using the normalized autocorrelation of a detrended line scan and to quantify deviations from linearity that are indicative of punctate immune complex deposition.\n\nYour program must, for each provided test case, perform the following computations:\n\n1. Fit a straight line $I_i \\approx a x_i + b$ to $\\{(x_i,I_i)\\}$ by least squares, compute residuals $r_i = I_i - (a x_i + b)$, and center residuals $r_i$ by subtracting their mean $\\bar{r}$. Use the centered residuals for subsequent calculations.\n2. Compute the normalized autocorrelation $C_k$ of the centered residuals for integer lags $k \\in \\{1,2,\\dots,K\\}$, where for each $k$,\n$$\nC_k = \\frac{1}{(N-k)\\,\\sigma_r^2} \\sum_{i=0}^{N-k-1} (r_i - \\bar{r})(r_{i+k} - \\bar{r}),\n$$\nand $\\sigma_r^2$ is the variance of the centered residuals. Define the correlation length $L_c$ (in micrometers) as $L_c = s \\cdot k^\\ast$, where $k^\\ast$ is the smallest $k$ such that $C_k \\le e^{-1}$. If no such $k$ exists up to $k = N-2$, set $L_c = s \\cdot (N-1)$. If $\\sigma_r^2 = 0$, set $L_c = 0$.\n3. Define the nonlinearity index $D$ using the discrete second differences of the residuals,\n$$\n\\Delta^2 r_i = r_{i+1} - 2 r_i + r_{i-1} \\quad \\text{for } i \\in \\{1,2,\\dots,N-2\\}.\n$$\nCompute\n$$\nD = \\frac{\\sqrt{\\frac{1}{N-2}\\sum_{i=1}^{N-2} (\\Delta^2 r_i)^2}}{\\sqrt{\\frac{1}{N}\\sum_{i=0}^{N-1} r_i^2} + \\epsilon},\n$$\nwhere $\\epsilon$ is a small positive constant to avoid division by zero. Use $\\epsilon = 10^{-12}$ in the implementation. If $\\sigma_r^2 = 0$, set $D = 0$.\n4. Classify whether immune complex deposition is present using a threshold on $D$: return a boolean $\\mathrm{Imm}$ such that $\\mathrm{Imm} = \\mathrm{True}$ if $D \\ge T$ and $\\mathrm{Imm} = \\mathrm{False}$ otherwise. Use $T = 0.35$.\n5. Report $L_c$ in micrometers ($\\mu \\mathrm{m}$) rounded to two decimal places and $D$ rounded to three decimal places. The boolean $\\mathrm{Imm}$ should be unrounded.\n\nSynthetic line scans must be generated according to the following model to form a test suite:\n- The intensity series is \n$$\nI_i = b + a x_i + n_i + S_i,\n$$\nwhere $n_i \\sim \\mathcal{N}(0,\\sigma^2)$ is Gaussian noise with standard deviation $\\sigma$ and $S_i$ is a sum of Gaussian peaks representing punctate immune complexes. Peaks are placed at equally spaced centers with period $p$ pixels, beginning at $i_0 = \\lfloor p/2 \\rfloor$, i.e., centers at $i_j = i_0 + j p$ for all integers $j$ such that $0 \\le i_j < N$. Each peak contributes \n$$\nA \\exp\\left( -\\frac{(i - i_j)^2}{2 w^2} \\right),\n$$\nwhere $A$ is the peak amplitude and $w$ is the peak width in pixels. If $A = 0$ or $p = 0$, set $S_i = 0$ for all $i$. Use independent pseudorandom Gaussian noise for each test case with the specified random seed.\n\nTest suite (each test case is a tuple $(N,s,a,b,\\sigma,p,A,w,\\text{seed})$):\n- Case $1$: $(200, 0.2, 0.02, 10.0, 0.5, 20, 3.0, 2.0, 123)$.\n- Case $2$: $(100, 0.25, 0.0, 5.0, 0.0, 0, 0.0, 1.0, 42)$.\n- Case $3$: $(20, 0.5, 0.0, 7.0, 1.0, 0, 0.0, 1.0, 7)$.\n- Case $4$: $(150, 0.1, 0.0, 8.0, 0.2, 10, 4.0, 1.0, 99)$.\n\nYour program should produce a single line of output containing a list of results, one per test case, where each result is a list $[L_c, D, \\mathrm{Imm}]$ with $L_c$ in micrometers ($\\mu \\mathrm{m}$) rounded to two decimal places, $D$ rounded to three decimal places, and $\\mathrm{Imm}$ as a boolean. The final output must be a comma-separated list enclosed in square brackets, for example, $[[L_{c,1}, D_1, \\mathrm{Imm}_1],[L_{c,2}, D_2, \\mathrm{Imm}_2],[L_{c,3}, D_3, \\mathrm{Imm}_3],[L_{c,4}, D_4, \\mathrm{Imm}_4]]$.", "solution": "The problem requires the implementation of a computational analysis pipeline for one-dimensional fluorescence intensity line scans, modeling data from Direct Immunofluorescence microscopy. The analysis aims to quantify spatial continuity and nonlinearity, which are indicative of immune complex deposition patterns. The process involves generating synthetic data, performing signal processing, and classifying the results.\n\nThe overall workflow proceeds as follows: First, synthetic line scan data is generated based on a specified model. Second, these data are processed to extract two key metrics: the correlation length $L_c$ and a nonlinearity index $D$. Finally, the scan is classified based on the value of $D$.\n\n**1. Synthetic Data Generation**\nA synthetic intensity profile, $I_i$, is generated for discrete positions $x_i = i \\cdot s$ where $i \\in \\{0, 1, \\dots, N-1\\}$, $N$ is the number of points, and $s$ is the pixel size in micrometers ($\\mu\\text{m}$). The model for the intensity is a superposition of four components:\n$$\nI_i = b + a x_i + n_i + S_i\n$$\n-   A constant baseline intensity $b$.\n-   A linear trend with slope $a$.\n-   A noise component $n_i$, with each $n_i$ drawn independently from a Gaussian distribution $\\mathcal{N}(0, \\sigma^2)$ with a specified standard deviation $\\sigma$.\n-   A signal component $S_i$ representing punctate immune deposits. This component is modeled as a sum of Gaussian peaks, $S_i = \\sum_{j} A \\exp\\left( -\\frac{(i - i_j)^2}{2 w^2} \\right)$. The peaks have amplitude $A$ and width $w$. They are located at positions $i_j = \\lfloor p/2 \\rfloor + j \\cdot p$ for integers $j$ such that $0 \\le i_j < N$, where $p$ is the period of deposition. If $A=0$ or $p=0$, no peaks are generated ($S_i=0$).\nA specified random seed is used to ensure reproducibility of the noise component $n_i$.\n\n**2. Detrending and Residual Calculation**\nThe raw intensity data $I_i$ contains a background trend $a x_i + b$ which is not part of the signal of interest. To analyze the fluctuations caused by noise and depositions, this trend must be removed. This is achieved by fitting a straight line to the data $\\{(x_i, I_i)\\}$ using the method of ordinary least squares (OLS). The OLS fit finds coefficients $a_{\\text{fit}}$ and $b_{\\text{fit}}$ that minimize the sum of squared differences between the data and the fitted line.\n\nThe residuals, $r_i$, are the differences between the original data and the fitted line:\n$$\nr_i = I_i - (a_{\\text{fit}} x_i + b_{\\text{fit}})\n$$\nAccording to the problem statement, these residuals are then centered by subtracting their mean, $\\bar{r} = \\frac{1}{N}\\sum_{i=0}^{N-1} r_i$. For an OLS fit that includes an intercept term, the sum of residuals is mathematically guaranteed to be zero, thus $\\bar{r}=0$. Therefore, this centering step, while explicitly performed, does not alter the residuals. These centered residuals, which we can denote as $r'_i = r_i - \\bar{r} = r_i$, are used in all subsequent calculations.\n\nA special case arises if the residuals are all zero, which implies their variance $\\sigma_r^2 = \\frac{1}{N}\\sum (r'_i)^2$ is zero. In this scenario, as per the problem, both $L_c$ and $D$ are set to $0$.\n\n**3. Correlation Length, $L_c$**\nThe correlation length $L_c$ quantifies the spatial continuity of the signal. It is derived from the normalized autocorrelation function $C_k$ of the centered residuals $r'_i$. For a discrete lag $k \\in \\{1, 2, \\dots, N-2\\}$, the autocorrelation is calculated using the specific formula provided:\n$$\nC_k = \\frac{1}{(N-k)\\,\\sigma_r^2} \\sum_{i=0}^{N-k-1} r'_i r'_{i+k}\n$$\nwhere $\\sigma_r^2 = \\frac{1}{N}\\sum_{i=0}^{N-1} (r'_i)^2$ is the variance of the centered residuals.\n\nThe correlation length $L_c$ is defined as $L_c = s \\cdot k^\\ast$, where $k^\\ast$ is the smallest integer lag $k \\ge 1$ for which the autocorrelation $C_k$ drops to or below the value of $e^{-1} \\approx 0.36788$. This threshold is common in physics and engineering for defining characteristic decay lengths or times. If $C_k$ never falls below this threshold for any $k$ up to $N-2$, $k^\\ast$ is set to $N-1$ by definition.\n\n**4. Nonlinearity Index, $D$**\nThe nonlinearity index $D$ is designed to quantify the \"spikiness\" or \"roughness\" of the signal, which is characteristic of punctate depositions. It is based on the discrete second differences of the residuals:\n$$\n\\Delta^2 r'_i = r'_{i+1} - 2 r'_i + r'_{i-1} \\quad \\text{for } i \\in \\{1, 2, \\dots, N-2\\}\n$$\nThis operation acts as a high-pass filter, amplifying sharp local changes and approximating the second derivative. The index $D$ is defined as the ratio of the root mean square (RMS) of these second differences to the standard deviation of the residuals:\n$$\nD = \\frac{\\sqrt{\\frac{1}{N-2}\\sum_{i=1}^{N-2} (\\Delta^2 r'_i)^2}}{\\sqrt{\\frac{1}{N}\\sum_{i=0}^{N-1} (r'_i)^2} + \\epsilon} = \\frac{\\text{RMS}(\\Delta^2 r')}{\\sigma_r + \\epsilon}\n$$\nThe denominator normalizes the index, making it a scale-invariant measure of high-frequency content. A small constant $\\epsilon = 10^{-12}$ is added to prevent division by zero in the case where the residuals are non-zero but have zero variance in theory (which is impossible for $N>1$ but must be handled for numerical stability).\n\n**5. Classification**\nFinally, the presence of immune complex deposition is determined by a simple thresholding rule. The boolean variable $\\mathrm{Imm}$ is set to $\\mathrm{True}$ if the nonlinearity index $D$ is greater than or equal to a given threshold $T=0.35$, and $\\mathrm{False}$ otherwise. A high value of $D$ suggests significant high-frequency content, which is interpreted as evidence for punctate depositions.\n\nThe final output for each test case is a list containing the correlation length $L_c$ rounded to two decimal places, the nonlinearity index $D$ rounded to three decimal places, and the boolean classification $\\mathrm{Imm}$.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print results.\n    \"\"\"\n\n    def analyze_scan(N, s, a_true, b_true, sigma, p, A, w, seed):\n        \"\"\"\n        Generates and analyzes a single synthetic line scan based on the problem specification.\n\n        Args:\n            N (int): Number of sample points.\n            s (float): Pixel size in micrometers.\n            a_true (float): Slope of the linear trend.\n            b_true (float): Intercept of the linear trend.\n            sigma (float): Standard deviation of Gaussian noise.\n            p (int): Period of Gaussian peaks in pixels.\n            A (float): Amplitude of Gaussian peaks.\n            w (float): Width (std. dev.) of Gaussian peaks in pixels.\n            seed (int): Random seed for noise generation.\n\n        Returns:\n            list: A list containing [Lc, D, Imm] with specified rounding.\n        \"\"\"\n        # Step 1: Generate Synthetic Data\n        rng = np.random.default_rng(seed)\n        x = np.arange(N) * s\n\n        noise = rng.normal(loc=0.0, scale=sigma, size=N) if sigma > 0 else np.zeros(N)\n\n        S = np.zeros(N)\n        if A != 0 and p > 0:\n            i0 = int(np.floor(p / 2))\n            peak_centers = np.arange(i0, N, p)\n            i_indices = np.arange(N)\n            for center in peak_centers:\n                S += A * np.exp(-((i_indices - center)**2) / (2 * w**2))\n\n        I = b_true + a_true * x + noise + S\n\n        # Step 1 (cont.): Detrending and Residuals\n        a_fit, b_fit = np.polyfit(x, I, 1)\n        r = I - (a_fit * x + b_fit)\n        r_c = r - np.mean(r)\n\n        var_r = np.var(r_c)\n\n        # Handle the sigma_r^2 = 0 edge case\n        if var_r  1e-15:\n            Lc = 0.0\n            D = 0.0\n        else:\n            # Step 2: Correlation Length Lc\n            e_inv = np.exp(-1.0)\n            k_star = N - 1\n\n            # Per problem, C_k sums from i=0 to N-k-1, which is N-k terms.\n            # np.dot(r_c[:N-k], r_c[k:]) correctly does this sum.\n            # Normalization is by (N-k) * variance.\n            # var_r is calculated with N in denominator, as is standard for np.var.\n            \n            # The problem asks for C_k with a specific normalization, let's follow it precisely.\n            # variance of centered residuals is sum(r_c**2)/N\n            # C_k = (sum_{i=0}^{N-k-1} r_c[i]*r_c[i+k]) / ((N-k)*var_r)\n            \n            for k in range(1, N - 1):\n                C_k_num = np.dot(r_c[:N-k], r_c[k:])\n                C_k_den = (N - k) * var_r\n                \n                if C_k_den == 0:\n                    C_k = np.inf\n                else:\n                    C_k = C_k_num / C_k_den\n\n                if C_k = e_inv:\n                    k_star = k\n                    break\n            \n            Lc = s * k_star\n\n            # Step 3: Nonlinearity Index D\n            epsilon = 1e-12\n            if N = 2:\n                D = 0.0\n            else:\n                delta2_r = r_c[2:] - 2 * r_c[1:-1] + r_c[:-2]\n                # RMS of second diff: sqrt(sum(delta2_r**2) / (N-2))\n                num_D = np.sqrt(np.mean(delta2_r**2))\n                # Sqrt of variance: sqrt(sum(r_c**2)/N)\n                den_D = np.sqrt(var_r) + epsilon\n                D = num_D / den_D\n\n        # Step 4: Classification\n        T = 0.35\n        Imm = D >= T\n        \n        # Step 5: Reporting\n        Lc_rounded = round(Lc, 2)\n        D_rounded = round(D, 3)\n        \n        return [Lc_rounded, D_rounded, bool(Imm)]\n\n    test_cases = [\n        (200, 0.2, 0.02, 10.0, 0.5, 20, 3.0, 2.0, 123),\n        (100, 0.25, 0.0, 5.0, 0.0, 0, 0.0, 1.0, 42),\n        (20, 0.5, 0.0, 7.0, 1.0, 0, 0.0, 1.0, 7),\n        (150, 0.1, 0.0, 8.0, 0.2, 10, 4.0, 1.0, 99),\n    ]\n\n    results = []\n    for case in test_cases:\n        result = analyze_scan(*case)\n        results.append(result)\n\n    # Format the final output string as per requirements\n    # e.g., [[0.8, 1.085, True],[0.0, 0.0, False],...]\n    output_str = \"[\" + \",\".join(str(res) for res in results) + \"]\"\n    print(output_str)\n\nsolve()\n```", "id": "5108030"}]}