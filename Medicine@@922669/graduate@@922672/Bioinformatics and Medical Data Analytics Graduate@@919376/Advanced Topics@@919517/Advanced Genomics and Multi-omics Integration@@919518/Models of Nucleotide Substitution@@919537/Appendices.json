{"hands_on_practices": [{"introduction": "This foundational practice connects the microscopic details of a substitution model to a macroscopic evolutionary measure. By deriving the famous Jukes-Cantor distance correction formula from its instantaneous rate matrix, you will mathematically trace how to account for unobserved substitutions, or 'multiple hits'. This exercise solidifies the core logic behind transforming a simple count of sequence differences, $p$, into a meaningful estimate of evolutionary distance, $d$ [@problem_id:2407121].", "problem": "A continuous-time Markov chain (CTMC) on the nucleotide alphabet $\\{A, C, G, T\\}$ evolves according to the Jukes–Cantor (JC) model. The JC instantaneous rate matrix $Q_{JC}$ is defined by $Q_{ij} = \\alpha$ for $i \\neq j$ and $Q_{ii} = -3\\alpha$, where $\\alpha > 0$ is a constant and $i,j \\in \\{A, C, G, T\\}$. Let $P(t) = \\exp(Q_{JC} t)$ denote the transition probability matrix at time $t \\ge 0$. Assume the process is stationary with the uniform stationary distribution $\\pi_i = \\frac{1}{4}$ for all $i$.\n\nConsider two homologous DNA sequences that have evolved from a common ancestor under the JC model along a path of total elapsed time $\\tau > 0$ (that is, the sum of the branch durations separating the two sequences is $\\tau$). Let $p$ denote the expected Hamming fraction of nucleotide differences between the two sequences at a homologous site under this model. Define the Jukes–Cantor evolutionary distance $d$ to be the expected number of substitutions per site along the path connecting the two sequences. Under the JC model, the average instantaneous substitution rate per site at stationarity is $\\mu = \\sum_{i} \\pi_i \\left(-Q_{ii}\\right)$, and thus $d = \\mu \\,\\tau$.\n\nStarting from the definitions above and the rate matrix $Q_{JC}$, derive a closed-form expression for $d$ as a function of $p$ only, eliminating $\\alpha$ and $\\tau$. Express your final result as a single analytic expression in terms of $p$ only. No units are required.", "solution": "The problem statement is subjected to validation.\n\n**Step 1: Extract Givens**\n- **Model**: A continuous-time Markov chain (CTMC) on the nucleotide alphabet $\\{A, C, G, T\\}$.\n- **Model Name**: Jukes–Cantor (JC).\n- **Instantaneous Rate Matrix ($Q_{JC}$)**: $Q_{ij} = \\alpha$ for $i \\neq j$ and $Q_{ii} = -3\\alpha$, where $\\alpha > 0$.\n- **Transition Probability Matrix ($P(t)$)**: $P(t) = \\exp(Q_{JC} t)$ for time $t \\ge 0$.\n- **Stationary Distribution ($\\pi$)**: Uniform, $\\pi_i = \\frac{1}{4}$ for all $i \\in \\{A, C, G, T\\}$.\n- **Evolutionary Scenario**: Two homologous sequences evolve from a common ancestor.\n- **Total Elapsed Time**: $\\tau > 0$, sum of branch durations separating the two sequences.\n- **Observed Difference ($p$)**: Expected Hamming fraction of nucleotide differences between the two sequences.\n- **Evolutionary Distance ($d$)**: Expected number of substitutions per site, defined as $d = \\mu \\tau$.\n- **Average Substitution Rate ($\\mu$)**: Defined as $\\mu = \\sum_{i} \\pi_i (-Q_{ii})$.\n- **Objective**: Derive a closed-form expression for $d$ as a function of $p$.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientific Grounding**: The problem is scientifically grounded. The Jukes-Cantor model is a fundamental and widely used model in molecular evolution and phylogenetics. All provided definitions are standard and correct within this field.\n- **Well-Posedness**: The problem is well-posed. It requests the derivation of a specific, standard formula ($d$ as a function of $p$) from first principles as laid out in the problem statement. The setup is sufficient to determine a unique analytical solution.\n- **Objectivity**: The problem is stated in precise, objective mathematical language, free from ambiguity or subjective content.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A complete solution will be derived.\n\nThe objective is to derive an expression for the evolutionary distance $d$ in terms of the observed proportion of differing sites $p$. This requires establishing a relationship between each of these quantities and the underlying parameters of the JC model, which are the substitution rate parameter $\\alpha$ and the total time $\\tau$.\n\nFirst, we determine the average rate of substitution per site, $\\mu$. By definition, $\\mu = \\sum_{i} \\pi_i (-Q_{ii})$.\nThe problem provides the stationary distribution $\\pi_i = \\frac{1}{4}$ for all $4$ nucleotide states $i \\in \\{A, C, G, T\\}$.\nThe diagonal elements of the rate matrix are given as $Q_{ii} = -3\\alpha$.\nTherefore, the rate $\\mu$ is:\n$$ \\mu = \\sum_{i \\in \\{A,C,G,T\\}} \\left(\\frac{1}{4}\\right) (-(-3\\alpha)) = 4 \\times \\frac{3\\alpha}{4} = 3\\alpha $$\nThe evolutionary distance $d$, defined as the expected number of substitutions per site, is given by $d = \\mu \\tau$. Substituting the expression for $\\mu$, we have:\n$$ d = 3\\alpha\\tau $$\n\nNext, we must find an expression for $p$, the expected fraction of nucleotide differences. For a time-reversible Markov model such as JC, the probability of observing a difference between two sequences separated by a total branch length of $\\tau$ is equivalent to the probability that a single sequence will change its state over a time interval $\\tau$. Let us assume the process starts at equilibrium, meaning the initial nucleotide is drawn from the stationary distribution $\\pi$. The probability of a difference is then the probability of starting in any state $i$ and ending in any other state $j \\neq i$ after time $\\tau$.\n$$ p = \\sum_{i} \\pi_i \\left( \\sum_{j \\neq i} P_{ij}(\\tau) \\right) $$\nDue to the symmetry of the JC model, the probability of changing from state $i$ to any other state is independent of the starting state $i$. That is, $\\sum_{j \\neq i} P_{ij}(\\tau)$ is the same for all $i$. Since $\\sum_i \\pi_i = 1$, the expression for $p$ simplifies to:\n$$ p = \\sum_{j \\neq i} P_{ij}(\\tau) = 1 - P_{ii}(\\tau) $$\nfor any arbitrarily chosen state $i$.\n\nWe must now determine the transition probability $P_{ii}(\\tau)$. The transition matrix $P(t)$ is the solution to the master equation $\\frac{d P(t)}{dt} = P(t) Q_{JC}$ with initial condition $P(0) = I$, the identity matrix. It is simpler to solve for the probability vector. Let $p_k(t)$ be the probability of being in state $k$ at time $t$. Consider a sequence starting in state $i$ at $t=0$. The change in probability of remaining in state $i$ is described by the differential equation:\n$$ \\frac{dp_i(t)}{dt} = \\sum_{k} p_k(t) Q_{ki} $$\nUsing the specific entries of the JC matrix, with $p_i(0)=1$ and $p_j(0)=0$ for $j \\neq i$:\n$$ \\frac{dp_i(t)}{dt} = p_i(t) Q_{ii} + \\sum_{j \\neq i} p_j(t) Q_{ji} = p_i(t)(-3\\alpha) + \\sum_{j \\neq i} p_j(t) \\alpha $$\nSince the probabilities must sum to unity, $\\sum_{j \\neq i} p_j(t) = 1 - p_i(t)$. Substituting this into the equation gives:\n$$ \\frac{dp_i(t)}{dt} = -3\\alpha p_i(t) + \\alpha(1 - p_i(t)) = \\alpha - 4\\alpha p_i(t) $$\nThis is a first-order linear ordinary differential equation. We can solve it using an integrating factor or by separation of variables. Let us rearrange to find the solution:\n$$ \\frac{dp_i}{dt} + 4\\alpha p_i = \\alpha $$\nThe general solution is the sum of the homogeneous solution, $C \\exp(-4\\alpha t)$, and a particular solution. For the particular solution, we try a constant $p_i = K$, which gives $4\\alpha K = \\alpha$, so $K = \\frac{1}{4}$.\nThe general solution is $p_i(t) = \\frac{1}{4} + C \\exp(-4\\alpha t)$.\nWe apply the initial condition $p_i(0) = 1$:\n$$ 1 = \\frac{1}{4} + C \\exp(0) \\implies C = \\frac{3}{4} $$\nThus, the probability of remaining in the same state after time $t$ is:\n$$ P_{ii}(t) = p_i(t) = \\frac{1}{4} + \\frac{3}{4} \\exp(-4\\alpha t) $$\nNow we can compute $p$ by substituting $t=\\tau$:\n$$ p = 1 - P_{ii}(\\tau) = 1 - \\left( \\frac{1}{4} + \\frac{3}{4} \\exp(-4\\alpha \\tau) \\right) = \\frac{3}{4} - \\frac{3}{4} \\exp(-4\\alpha \\tau) $$\n$$ p = \\frac{3}{4} \\left( 1 - \\exp(-4\\alpha \\tau) \\right) $$\n\nWe have established two relations:\n1. $d = 3\\alpha \\tau$\n2. $p = \\frac{3}{4} (1 - \\exp(-4\\alpha \\tau))$\n\nOur goal is to express $d$ as a function of $p$. From equation (1), we have $\\alpha \\tau = \\frac{d}{3}$. We can substitute this into equation (2):\n$$ p = \\frac{3}{4} \\left( 1 - \\exp\\left(-4 \\left(\\frac{d}{3}\\right)\\right) \\right) = \\frac{3}{4} \\left( 1 - \\exp\\left(-\\frac{4d}{3}\\right) \\right) $$\nNow, we must invert this expression to solve for $d$.\n$$ \\frac{4p}{3} = 1 - \\exp\\left(-\\frac{4d}{3}\\right) $$\n$$ \\exp\\left(-\\frac{4d}{3}\\right) = 1 - \\frac{4p}{3} $$\nTaking the natural logarithm of both sides:\n$$ -\\frac{4d}{3} = \\ln\\left(1 - \\frac{4p}{3}\\right) $$\nFinally, solving for $d$:\n$$ d = -\\frac{3}{4} \\ln\\left(1 - \\frac{4p}{3}\\right) $$\nThis is the Jukes-Cantor distance formula, which corrects the observed proportion of differences $p$ to estimate the actual number of substitutions that have occurred per site. Note that the argument of the logarithm requires $1 - \\frac{4p}{3} > 0$, which implies $p < \\frac{3}{4}$. This is expected, as at infinite time ($\\tau \\to \\infty$), the probability of any nucleotide at a site becomes $\\frac{1}{4}$, so the probability of a mismatch $p$ approaches $\\frac{3}{4}$.", "answer": "$$\n\\boxed{-\\frac{3}{4} \\ln\\left(1 - \\frac{4p}{3}\\right)}\n$$", "id": "2407121"}, {"introduction": "The choice of a substitution model carries significant consequences for phylogenetic inference. This exercise explores the critical issue of model misspecification, asking you to predict the systematic biases in branch length estimation that occur when a simple model like Jukes-Cantor is applied to data generated by a more complex, heterogeneous process. Understanding these effects is essential for selecting appropriate models and correctly interpreting the results of phylogenetic analyses [@problem_id:2407130].", "problem": "A set of aligned deoxyribonucleic acid (DNA) sequences evolved under a continuous-time Markov chain (CTMC) on the $4$-state nucleotide alphabet. In such models, a branch length is defined as the expected number of substitutions per site, that is, if the instantaneous rate matrix is scaled so the average substitution rate is $1$, a branch of duration $t$ has length $t$. Consider estimating maximum-likelihood branch lengths on a fixed topology using the Jukes–Cantor (JC$69$) model, which assumes equal base frequencies and equal substitution rates among all nucleotide pairs. Suppose the true data-generating process is closer to a General Time Reversible (GTR) model with unequal equilibrium base frequencies and unequal exchangeability rates, including elevated transition rates relative to transversion rates as in the Kimura two-parameter (K$80$) model. Which statement best describes how using JC$69$ in place of a GTR-like process can systematically bias the estimated branch lengths?\n\nA. They are systematically underestimated, especially for longer branches, because the equal-rates, equal-frequencies assumption under-corrects for multiple unobserved substitutions when transitions are more frequent or base frequencies are unequal.\n\nB. They are systematically overestimated across all branches, because the equal-rates assumption forces the model to interpret any pattern heterogeneity as extra change.\n\nC. They are unbiased on average; model misspecification only increases the variance of the estimates without shifting their expectation.\n\nD. They remain correct provided the tree topology is fixed; only the inferred substitution parameters are biased by using JC$69$.\n\nE. Any biases on individual branches cancel so that the total tree length (the sum of branch lengths) is unbiased even if individual branches are biased.", "solution": "The problem statement is subjected to validation.\n\n### Step 1: Extract Givens\n-   The system consists of a set of aligned deoxyribonucleic acid (DNA) sequences.\n-   The evolutionary process is a continuous-time Markov chain (CTMC) on the $4$-state nucleotide alphabet {A, C, G, T}.\n-   A branch length is defined as the expected number of substitutions per site, achieved by scaling the instantaneous rate matrix $Q$ such that the average substitution rate is $1$.\n-   The task is to estimate maximum-likelihood branch lengths on a fixed topology.\n-   The model used for estimation is the Jukes–Cantor (JC$69$) model. JC$69$ assumes equal base frequencies ($\\pi_A = \\pi_C = \\pi_G = \\pi_T = 1/4$) and equal substitution rates among all nucleotide pairs.\n-   The true data-generating process is described as being \"closer to a General Time Reversible (GTR) model\" with two key features: ($1$) unequal equilibrium base frequencies and ($2$) unequal exchangeability rates, specifically with elevated transition rates relative to transversion rates, a characteristic of the Kimura two-parameter (K$80$) model.\n-   The question asks for the nature of the systematic bias in estimated branch lengths when using the JC$69$ model in place of the correct GTR-like process.\n\n### Step 2: Validate Using Extracted Givens\nThe problem setup is scientifically sound and well-posed.\n-   **Scientifically Grounded**: The problem is rooted in the core theory of molecular evolution and phylogenetics. The JC$69$, K$80$, and GTR models are standard, well-defined mathematical models of nucleotide substitution. The concept of model misspecification and its impact on parameter estimation (such as branch lengths) is a fundamental and critical topic in computational biology and statistics. The description of the models and the estimation framework (Maximum Likelihood) is accurate.\n-   **Well-Posed**: The question asks about the direction of a systematic bias, which is a well-defined statistical concept. A qualitative answer can be rigorously derived from the properties of the models in question.\n-   **Objective**: The problem uses precise, objective terminology from its field. There is no subjective or ambiguous language.\n\nThe problem statement does not violate any of the invalidity criteria. It is a standard, albeit non-trivial, conceptual problem in phylogenetics.\n\n### Step 3: Verdict and Action\nThe problem is valid. A full solution will be derived.\n\n### Derivation\nThe core of this problem lies in understanding the consequences of model misspecification. We are fitting a simple model, Jukes-Cantor (JC$69$), to data generated by a more complex and realistic process, a General Time Reversible (GTR)-like model.\n\nA branch length, $t$, in this context represents the expected number of nucleotide substitutions per site that have occurred along that branch. To estimate $t$ from two aligned sequences, we first calculate the observed proportion of sites that differ, let us call this $p_d$. Because multiple substitutions can occur at the same site over time (e.g., A $\\to$ G $\\to$ A, which results in no observable change, or A $\\to$ G $\\to$ C, which results in one observed difference but two substitution events), $p_d$ is an underestimate of the true number of substitutions. A substitution model provides a mathematical formula to \"correct\" $p_d$ to estimate $t$.\n\nThe Jukes-Cantor (JC$69$) model is the simplest substitution model. It assumes:\n$1$. Equal equilibrium base frequencies: $\\pi_A = \\pi_C = \\pi_G = \\pi_T = 1/4$.\n$2$. A single rate, $\\alpha$, for all possible substitutions. The instantaneous rate matrix $Q_{JC}$ is given by:\n$$\nQ_{JC} = \\begin{pmatrix}\n-3\\alpha & \\alpha & \\alpha & \\alpha \\\\\n\\alpha & -3\\alpha & \\alpha & \\alpha \\\\\n\\alpha & \\alpha & -3\\alpha & \\alpha \\\\\n\\alpha & \\alpha & \\alpha & -3\\alpha\n\\end{pmatrix}\n$$\nThe expected number of substitutions per site per unit time is $\\sum_i \\pi_i (-Q_{ii}) = 4 \\times (\\frac{1}{4} \\times 3\\alpha) = 3\\alpha$. To define branch length as the expected number of substitutions, we set this average rate to $1$, which means we scale the matrix by setting $\\alpha = 1/3$.\nThe probability of observing a difference at a site after a branch of length $t$ is $P_{\\text{diff}}(t) = \\frac{3}{4}(1 - e^{-4t/3})$. By inverting this relationship, we get the JC$69$ distance correction formula used to estimate the branch length, $t_{JC}$, from the observed divergence $p_d$:\n$$\nt_{JC} = -\\frac{3}{4} \\ln\\left(1 - \\frac{4}{3} p_d\\right)\n$$\nThis correction accounts for multiple substitutions *under the assumption that all substitution pathways are equally likely*.\n\nThe true data-generating process is GTR-like. This means two key assumptions of JC$69$ are violated:\n$1$. **Unequal base frequencies**: The equilibrium frequencies are not all equal to $1/4$.\n$2$. **Rate heterogeneity among substitution types**: Specifically, the rate of transitions (substitutions within purines, A $\\leftrightarrow$ G, or within pyrimidines, C $\\leftrightarrow$ T) is higher than the rate of transversions (substitutions between purines and pyrimidines).\n\nLet us analyze the impact of these violations. The phenomenon of multiple unobserved substitutions (\"multiple hits\") becomes more prevalent when certain substitution pathways are \"hotter\" than others. For example, if the transition rate is much higher than the transversion rate, a sequence of substitutions like A $\\to$ G $\\to$ A is far more likely than JC$69$ would predict. Such a sequence of two substitutions is entirely unobservable, as the starting and ending states are identical. Similarly, a sequence like A $\\to$ G $\\to$ T involves two substitutions but is observed as a single transversion (A $\\to$ T).\n\nWhen the JC$69$ model is used to analyze such data, it applies its correction formula, which is based on a uniform rate of change. It is \"unaware\" of the fact that the high transition rate has caused many more hidden substitutions than would be expected under its own simple assumptions. For a given observed divergence $p_d$, the true number of substitutions that occurred is greater than the number estimated by the JC$69$ formula. Consequently, JC$69$ consistently *under-corrects* for multiple hits.\n\nThis leads to a systematic **underestimation** of the branch length. This underestimation is most pronounced for longer branches. For very short branches, the probability of any substitution is low, and the probability of multiple substitutions is negligible ($t \\approx p_d$). In this regime, the choice of model has little effect. However, as the branch length increases, \"saturation\" occurs—the observed divergence $p_d$ approaches its equilibrium value, and the signal of additional substitutions is lost. It is precisely on these longer, more saturated branches that the model's ability to correct for multiple hits is most critical. Since the JC$69$ correction is insufficient for GTR-like data, the discrepancy between the estimated length $t_{JC}$ and the true length $t_{GTR}$ grows as the branch length increases.\n\n### Option-by-Option Analysis\n\n**A. They are systematically underestimated, especially for longer branches, because the equal-rates, equal-frequencies assumption under-corrects for multiple unobserved substitutions when transitions are more frequent or base frequencies are unequal.**\nThis statement is **Correct**. As derived above, the core issue is the failure of the simple JC$69$ model to account for the higher-than-average incidence of multiple hits caused by rate heterogeneity (e.g., high transition/transversion ratio) and base frequency biases characteristic of a GTR-like process. This leads to an under-correction for saturation, resulting in a systematic underestimation of branch lengths, an effect that worsens with increasing branch length.\n\n**B. They are systematically overestimated across all branches, because the equal-rates assumption forces the model to interpret any pattern heterogeneity as extra change.**\nThis statement is **Incorrect**. The bias is a systematic underestimation, not overestimation. The model does not interpret heterogeneity as extra change; rather, it fails to detect the extra change that has occurred, as it is hidden by multiple substitutions.\n\n**C. They are unbiased on average; model misspecification only increases the variance of the estimates without shifting their expectation.**\nThis statement is **Incorrect**. While model misspecification does typically increase the variance of estimates, it can also introduce significant systematic bias. In this canonical example, a persistent, directional bias (underestimation) is a well-known consequence.\n\n**D. They remain correct provided the tree topology is fixed; only the inferred substitution parameters are biased by using JC69.**\nThis statement is **Incorrect**. Branch lengths are fundamental parameters of a phylogenetic model that are estimated from the data. The JC$69$ model's only \"substitution parameter\" is the single rate $\\alpha$, which is intrinsically linked to the branch length $t$. Stating that branch lengths remain correct while substitution parameters are biased is a contradiction in this context. The branch lengths themselves are the parameters that become biased.\n\n**E. Any biases on individual branches cancel so that the total tree length (the sum of branch lengths) is unbiased even if individual branches are biased.**\nThis statement is **Incorrect**. The bias is a systematic underestimation that applies to essentially all branches (especially longer ones). Summing these underestimated lengths will result in a total tree length that is also systematically underestimated. There is no theoretical reason to expect cancellation of errors.", "answer": "$$\\boxed{A}$$", "id": "2407130"}, {"introduction": "To truly master nucleotide substitution models, one must be able to translate theory into practice. This capstone programming exercise guides you through implementing the Hasegawa-Kishino-Yano (HKY85) model, a widely-used model that incorporates biases in base composition and transition/transversion rates. By constructing the rate matrix $Q$ and computing the transition probability matrix $P(t)$ from first principles, you will gain an intimate, hands-on understanding of how these powerful phylogenetic tools operate [@problem_id:4585593].", "problem": "Consider a time-homogeneous continuous-time Markov chain (CTMC) on the four deoxyribonucleic acid (DNA) nucleotides Adenine, Cytosine, Guanine, Thymine, with state space of size $4$ and infinitesimal generator (rate) matrix $Q \\in \\mathbb{R}^{4 \\times 4}$. In the Hasegawa-Kishino-Yano $1985$ (HKY85) nucleotide substitution model, the instantaneous substitution rate from state $i$ to state $j$ is determined by the equilibrium base frequencies and a transition or transversion bias. Let $\\pi = (\\pi_A,\\pi_C,\\pi_G,\\pi_T)$ denote the stationary base frequencies with $\\pi_i > 0$ and $\\sum_{i} \\pi_i = 1$, and let $\\kappa > 0$ be the transition-to-transversion rate ratio. Define the set of transitions as the pairs $\\{A,G\\}$ and $\\{C,T\\}$; all other pairs are transversions. The off-diagonal entries of $Q$ satisfy $Q_{ij} = s_{ij} \\pi_j$ for $i \\neq j$, where $s_{ij} = \\kappa$ if $(i,j)$ is a transition pair and $s_{ij} = 1$ otherwise. The diagonal entries are determined by the requirement of row sums equal to zero, that is $Q_{ii} = -\\sum_{j \\neq i} Q_{ij}$. The expected instantaneous substitution rate is defined as $\\mu = \\sum_{i} \\pi_i (-Q_{ii})$, and the matrix $Q$ must be scaled so that $\\mu = 1$.\n\nThe transition probability matrix at time $t$, denoted $P(t) \\in \\mathbb{R}^{4 \\times 4}$, is defined by the matrix exponential $P(t) = \\exp(Q t)$. The HKY85 generator constructed as above is reversible with respect to $\\pi$, that is it satisfies detailed balance $\\pi_i Q_{ij} = \\pi_j Q_{ji}$.\n\nYour task is to implement a program that, for each test case provided below, performs the following steps grounded in first principles:\n\n- Construct the HKY85 generator matrix $Q$ using the given $\\pi$ and $\\kappa$, enforce the zero row-sum constraint $Q \\mathbf{1} = \\mathbf{0}$, and scale $Q$ so that the expected rate $\\mu = 1$.\n- Compute $P(t)$ by two independent methods:\n  1. A spectral-decomposition route exploiting reversibility: use the fact that $Q$ is similar to a symmetric matrix $H$ under the similarity transform $H = S Q S^{-1}$ with $S = \\mathrm{diag}(\\sqrt{\\pi_A},\\sqrt{\\pi_C},\\sqrt{\\pi_G},\\sqrt{\\pi_T})$, then use orthonormal eigendecomposition of $H$ to obtain $P(t)$.\n  2. A direct numerical route using a stable algorithm for the matrix exponential to obtain $P(t)$.\n- Quantify and aggregate the following four diagnostics for each test case using the $P(t)$ obtained by the spectral route unless otherwise specified:\n  1. The Frobenius norm difference between the spectral and numerical $P(t)$, namely $\\lVert P_{\\mathrm{spec}}(t) - P_{\\mathrm{num}}(t) \\rVert_F$.\n  2. The maximal violation of stochasticity across rows, namely $\\max_{i} \\left| \\sum_{j} P_{ij}(t) - 1 \\right|$.\n  3. The violation of stationarity under the left action of $\\pi$, namely $\\lVert \\pi P(t) - \\pi \\rVert_2$ computed using the Euclidean norm.\n  4. The maximal deviation of rows from the stationary distribution, namely $\\max_{i} \\lVert P_{i\\cdot}(t) - \\pi \\rVert_2$, where $P_{i\\cdot}(t)$ denotes row $i$ of $P(t)$.\n\nExplain conceptually in your algorithmic design and subsequent interpretation how the base frequencies $\\pi$ determine the eigenstructure of the symmetrized operator and the stationary eigenvector.\n\nUse the following test suite, with base order fixed as $(A,C,G,T)$:\n\n- Test case $1$ (balanced frequencies, boundary time): $\\pi = (0.25, 0.25, 0.25, 0.25)$, $\\kappa = 1.0$, $t = 0.0$.\n- Test case $2$ (balanced frequencies, moderate bias): $\\pi = (0.25, 0.25, 0.25, 0.25)$, $\\kappa = 2.0$, $t = 0.5$.\n- Test case $3$ (moderate skew, stronger bias, longer time): $\\pi = (0.35, 0.15, 0.35, 0.15)$, $\\kappa = 3.0$, $t = 2.0$.\n- Test case $4$ (strong skew, extreme bias, long time): $\\pi = (0.70, 0.10, 0.15, 0.05)$, $\\kappa = 10.0$, $t = 5.0$.\n- Test case $5$ (skewed with very small time): $\\pi = (0.40, 0.10, 0.40, 0.10)$, $\\kappa = 20.0$, $t = 10^{-8}$.\n\nAll quantities in this problem are dimensionless, and no physical units apply.\n\nYour program should produce a single line of output containing the concatenated diagnostics for the five test cases, in order, each test case contributing a list of four floating-point numbers arranged as $[\\lVert P_{\\mathrm{spec}} - P_{\\mathrm{num}} \\rVert_F, \\max \\text{ row-sum deviation}, \\lVert \\pi P - \\pi \\rVert_2, \\max \\text{ row deviation from } \\pi]$. Aggregate all $5$ cases into a single flat list printed as a comma-separated sequence enclosed in square brackets, for example $[d_{1,1},d_{1,2},d_{1,3},d_{1,4},d_{2,1},\\dots,d_{5,4}]$. The outputs must be real numbers computed by your program and must not require any external input.", "solution": "The supplied problem is valid as it is scientifically grounded in the established HKY85 model of nucleotide substitution, mathematically well-posed with all necessary data provided, and formulated with objective and unambiguous language. The task is a standard computational problem in molecular evolution, requiring the application of linear algebra and the theory of continuous-time Markov chains.\n\n### Algorithmic Design and Underlying Principles\n\nThe solution proceeds in four main stages for each test case: constructing the HKY85 generator matrix $Q$, computing the transition probability matrix $P(t)$ via two independent methods, and finally, calculating a set of diagnostic metrics.\n\n#### 1. Construction and Scaling of the Generator Matrix $Q$\n\nThe HKY85 model is a continuous-time Markov chain (CTMC) on the state space of four nucleotides $\\{A, C, G, T\\}$, which we index as $\\{0, 1, 2, 3\\}$. The dynamics of this process are governed by the infinitesimal generator matrix $Q \\in \\mathbb{R}^{4 \\times 4}$.\n\nThe off-diagonal entries $Q_{ij}$ (for $i \\neq j$) represent the instantaneous rate of substitution from nucleotide $i$ to nucleotide $j$. In the HKY85 model, this rate is defined as $Q_{ij} = s_{ij} \\pi_j$. Here, $\\pi = (\\pi_A, \\pi_C, \\pi_G, \\pi_T)$ is the vector of stationary (or equilibrium) base frequencies, and $s_{ij}$ is a rate multiplier that depends on whether the substitution is a transition or a transversion.\n\n-   A **transition** is a substitution between purines ($A \\leftrightarrow G$) or between pyrimidines ($C \\leftrightarrow T$). For these pairs, $s_{ij} = \\kappa$, where $\\kappa > 0$ is the transition-to-transversion rate ratio.\n-   A **transversion** is a substitution between a purine and a pyrimidine. For these pairs, $s_{ij} = 1$.\n\nThe base order is fixed as $(A, C, G, T)$. The matrix of rate multipliers $S_m$ (with $i,j \\in \\{0, 1, 2, 3\\}$) for off-diagonal elements is:\n$$\nS_m = \\begin{pmatrix}\n- & 1 & \\kappa & 1 \\\\\n1 & - & 1 & \\kappa \\\\\n\\kappa & 1 & - & 1 \\\\\n1 & \\kappa & 1 & -\n\\end{pmatrix}\n$$\nThe diagonal entries of $Q$ are determined by the property that the sum of each row of a generator matrix must be zero: $Q_{ii} = -\\sum_{j \\neq i} Q_{ij}$. This ensures the conservation of probability.\n\nLet this initially constructed matrix be $Q'$. The problem requires that $Q$ be scaled such that the expected number of substitutions per site per unit of time, $\\mu$, is equal to $1$. This expected rate is defined as the average of the exit rates from each state, weighted by their stationary frequencies: $\\mu = -\\sum_{i} \\pi_i Q_{ii}$. We first calculate this rate for the unscaled matrix, $\\mu' = -\\sum_{i} \\pi_i Q'_{ii}$, and then define the final, scaled generator as $Q = Q' / \\mu'$. This normalization makes the branch length $t$ interpretable as the expected number of substitutions per site.\n\n#### 2. Computation of the Transition Probability Matrix $P(t)$\n\nThe matrix $P(t)$, where $P_{ij}(t)$ is the probability of being in state $j$ at time $t$ given the process was in state $i$ at time $0$, is given by the matrix exponential:\n$$\nP(t) = \\exp(Q t)\n$$\nWe compute this matrix using two distinct methods to cross-validate the results.\n\n**Method 1: Spectral Decomposition**\n\nThe HKY85 model is designed to be **time-reversible** with respect to $\\pi$, satisfying the detailed balance condition $\\pi_i Q_{ij} = \\pi_j Q_{ji}$. This property implies that $Q$ is similar to a symmetric matrix, which allows for a stable and elegant eigendecomposition. Let $S = \\mathrm{diag}(\\sqrt{\\pi_0}, \\sqrt{\\pi_1}, \\sqrt{\\pi_2}, \\sqrt{\\pi_3})$. The similarity transformation is given by $H = S Q S^{-1}$. The entries of this symmetrized matrix $H$ are:\n$$\nH_{ij} = \\sqrt{\\frac{\\pi_i}{\\pi_j}} Q_{ij} = \\sqrt{\\frac{\\pi_i}{\\pi_j}} (s_{ij} \\pi_j) = s_{ij} \\sqrt{\\pi_i \\pi_j}\n$$\nSince $s_{ij} = s_{ji}$, it is clear that $H_{ij} = H_{ji}$, so $H$ is a symmetric matrix.\n\nA symmetric matrix has a complete set of orthonormal eigenvectors and real eigenvalues. Thus, we can write its eigendecomposition as $H = U \\Lambda U^T$, where $U$ is an orthogonal matrix whose columns are the eigenvectors of $H$, and $\\Lambda = \\mathrm{diag}(\\lambda_0, \\lambda_1, \\lambda_2, \\lambda_3)$ is the diagonal matrix of corresponding eigenvalues.\n\nFrom $Q = S^{-1} H S$, we derive the expression for $P(t)$:\n$$\nP(t) = \\exp(Q t) = \\exp((S^{-1} H S)t) = S^{-1} \\exp(H t) S = S^{-1} (U \\exp(\\Lambda t) U^T) S\n$$\nThe matrix $\\exp(\\Lambda t)$ is simply a diagonal matrix with entries $e^{\\lambda_i t}$. This provides a numerically stable and analytically powerful method to calculate $P(t)$.\n\nThis spectral approach illuminates the central role of the stationary frequencies $\\pi$. First, the eigenstructure (eigenvalues $\\lambda_i$ and eigenvectors in $U$) of the symmetrized operator $H$ is directly determined by its entries $s_{ij}\\sqrt{\\pi_i \\pi_j}$, which are functions of $\\pi$. Second, reversibility implies that $\\pi$ is the stationary distribution of the process. This means $\\pi$ is the left eigenvector of $Q$ corresponding to the eigenvalue $\\lambda=0$, satisfying $\\pi Q = \\mathbf{0}$. This zero-eigenvalue mode governs the long-term behavior of the system, ensuring that as $t \\to \\infty$, each row of $P(t)$ converges to $\\pi$.\n\n**Method 2: Direct Numerical Matrix Exponential**\n\nAs an independent verification, we compute $P(t)$ directly using a robust numerical algorithm for the matrix exponential. We use the `scipy.linalg.expm` function, which implements a scaling and squaring algorithm based on Padé approximants. This method is a standard and highly reliable way to compute the exponential of a general square matrix.\n$$\nP_{\\mathrm{num}}(t) = \\mathrm{expm}(Q t)\n$$\n\n#### 3. Diagnostic Metrics\n\nWe quantify the properties of the computed transition matrix $P(t) = P_{\\mathrm{spec}}(t)$ and compare it with the numerical version $P_{\\mathrm{num}}(t)$ through four diagnostics:\n\n1.  **Frobenius Norm Difference**: $\\lVert P_{\\mathrm{spec}}(t) - P_{\\mathrm{num}}(t) \\rVert_F$. This measures the overall numerical discrepancy between the two computational methods. A small value validates the correctness of both implementations.\n\n2.  **Maximal Row-Sum Violation**: $\\max_{i} \\left| \\sum_{j} P_{ij}(t) - 1 \\right|$. For any valid transition probability matrix, each row must sum to $1$, as the process must transition to *some* state. This metric checks for violations of this stochasticity property due to numerical errors.\n\n3.  **Stationarity Violation**: $\\lVert \\pi P(t) - \\pi \\rVert_2$. Since $\\pi$ is the stationary distribution, it must be invariant under the action of $P(t)$, i.e., $\\pi P(t) = \\pi$. This diagnostic computes the Euclidean norm of the difference, measuring any deviation from this fundamental property.\n\n4.  **Maximal Row Deviation from Stationarity**: $\\max_{i} \\lVert P_{i\\cdot}(t) - \\pi \\rVert_2$. Each row $P_{i\\cdot}(t)$ of the transition matrix represents the probability distribution of states at time $t$, starting from state $i$. As $t \\to \\infty$, all rows should converge to the stationary distribution $\\pi$. This metric measures the maximum Euclidean distance of any such row from $\\pi$, indicating how close the system is to equilibrium.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.linalg import expm\n\ndef solve():\n    \"\"\"\n    Main function to run the HKY85 model simulations for all test cases.\n    \"\"\"\n    \n    # Test cases as specified in the problem statement.\n    # Each tuple contains (pi, kappa, t).\n    # pi is a tuple of (pi_A, pi_C, pi_G, pi_T).\n    test_cases = [\n        # Test case 1 (balanced frequencies, boundary time)\n        ((0.25, 0.25, 0.25, 0.25), 1.0, 0.0),\n        # Test case 2 (balanced frequencies, moderate bias)\n        ((0.25, 0.25, 0.25, 0.25), 2.0, 0.5),\n        # Test case 3 (moderate skew, stronger bias, longer time)\n        ((0.35, 0.15, 0.35, 0.15), 3.0, 2.0),\n        # Test case 4 (strong skew, extreme bias, long time)\n        ((0.70, 0.10, 0.15, 0.05), 10.0, 5.0),\n        # Test case 5 (skewed with very small time)\n        ((0.40, 0.10, 0.40, 0.10), 20.0, 1e-8),\n    ]\n\n    all_diagnostics = []\n\n    for pi_tuple, kappa, t in test_cases:\n        pi = np.array(pi_tuple)\n        \n        # 1. Construct the unscaled HKY85 generator matrix Q'\n        Q_prime = np.zeros((4, 4))\n        \n        # Define transitions {A,G} <-> {0,2} and {C,T} <-> {1,3}\n        purines = {0, 2}\n        pyrimidines = {1, 3}\n        \n        for i in range(4):\n            for j in range(4):\n                if i == j:\n                    continue\n                \n                # Determine if it's a transition or transversion\n                is_transition = (i in purines and j in purines) or (i in pyrimidines and j in pyrimidines)\n                s_ij = kappa if is_transition else 1.0\n                Q_prime[i, j] = s_ij * pi[j]\n        \n        # Set diagonal elements such that row sums are zero\n        for i in range(4):\n            Q_prime[i, i] = -np.sum(Q_prime[i, :])\n            \n        # 2. Scale Q so that the expected substitution rate mu is 1\n        mu_prime = -np.sum(pi * np.diag(Q_prime))\n\n        # Avoid division by zero if mu_prime is zero (e.g. if all rates are zero)\n        if np.isclose(mu_prime, 0.0):\n            Q = Q_prime # Or handle as an error, but here Q will be a zero matrix\n        else:\n            Q = Q_prime / mu_prime\n            \n        # 3. Compute P(t) via Spectral Decomposition\n        S = np.diag(np.sqrt(pi))\n        S_inv = np.diag(1.0 / np.sqrt(pi))\n        H = S @ Q @ S_inv\n        \n        # Eigendecomposition of the symmetric matrix H\n        # np.linalg.eigh is for hermitian/symmetric matrices and is more stable\n        eigenvalues, U = np.linalg.eigh(H)\n        \n        exp_lambda_t = np.diag(np.exp(eigenvalues * t))\n        \n        P_spec = S_inv @ U @ exp_lambda_t @ U.T @ S\n        \n        # 4. Compute P(t) via Direct Numerical Method\n        P_num = expm(Q * t)\n        \n        # 5. Calculate the four diagnostics\n        \n        # D1: Frobenius norm difference\n        d1 = np.linalg.norm(P_spec - P_num, 'fro')\n        \n        # D2: Maximal row-sum violation\n        row_sums = np.sum(P_spec, axis=1)\n        d2 = np.max(np.abs(row_sums - 1.0))\n\n        # D3: Stationarity violation\n        pi_P = pi @ P_spec\n        d3 = np.linalg.norm(pi_P - pi, 2)\n        \n        # D4: Maximal row deviation from stationarity\n        row_deviations = []\n        for i in range(4):\n            row_i = P_spec[i, :]\n            deviation = np.linalg.norm(row_i - pi, 2)\n            row_deviations.append(deviation)\n        d4 = np.max(row_deviations)\n        \n        all_diagnostics.extend([d1, d2, d3, d4])\n\n    # Final print statement in the exact required format\n    print(f\"[{','.join(f'{d:.12e}' for d in all_diagnostics)}]\")\n\nsolve()\n```", "id": "4585593"}]}