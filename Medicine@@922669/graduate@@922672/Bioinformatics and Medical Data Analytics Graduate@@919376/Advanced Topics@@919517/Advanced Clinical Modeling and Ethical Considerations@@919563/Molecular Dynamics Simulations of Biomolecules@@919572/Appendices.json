{"hands_on_practices": [{"introduction": "Before any molecular dynamics simulation can begin, we must first define the environment in which our biomolecule will be studied. This exercise guides you through the crucial task of setting up a simulation box with periodic boundary conditions, a standard technique to mimic an infinite system and minimize edge effects. By applying fundamental geometric principles, you will determine the appropriate box dimensions that not only provide adequate solvation but also prevent the solute from artificially interacting with its own periodic images, a critical check for simulation validity [@problem_id:4586373].", "problem": "A molecular dynamics (MD) simulation is to be prepared for a globular biomolecular solute that can be conservatively enclosed within a sphere of radius $R = 3\\,\\mathrm{nm}$. The system will be simulated in a cubic box with periodic boundary conditions (PBC). To reduce spurious finite-size effects, the initial solvated configuration must provide at least $p = 1.2\\,\\mathrm{nm}$ of solvent between the solute surface and each face of the cubic box in every direction. The nonbonded interactions are treated with a pairwise real-space cutoff of $r_{c} = 1.0\\,\\mathrm{nm}$ for both Lennard–Jones (LJ) interactions and the real-space part of electrostatics, while long-range electrostatics are computed with Particle Mesh Ewald (PME). Using only fundamental geometric reasoning, the minimum image convention under PBC, and the definition of a real-space cutoff, derive the minimum cubic box length $L_{\\min}$ that satisfies the solvent padding requirement and argue whether this choice guarantees that no atom of the solute can directly interact in real space with any atom of its own periodic images. Express the final $L_{\\min}$ as a single number in nanometers. Provide the exact decimal value (no rounding instruction is required).", "solution": "The problem statement is first validated to ensure it is scientifically sound, well-posed, and objective.\n\n### Step 1: Extract Givens\n- The solute is a globular biomolecule.\n- The solute is enclosed within a sphere of radius $R = 3\\,\\mathrm{nm}$.\n- The simulation box is cubic with periodic boundary conditions (PBC).\n- There must be a minimum solvent padding of $p = 1.2\\,\\mathrm{nm}$ between the solute surface and each face of the cubic box.\n- The real-space athermal (Lennard-Jones) and electrostatic interaction cutoff is $r_{c} = 1.0\\,\\mathrm{nm}$.\n- The task is to derive the minimum cubic box length, $L_{\\min}$, and determine if this length prevents the solute from interacting with its own periodic images.\n\n### Step 2: Validate Using Extracted Givens\nThe problem is scientifically grounded, describing a standard protocol for setting up a molecular dynamics (MD) simulation. The concepts of periodic boundary conditions, solvent padding, and interaction cutoffs are fundamental to the field. The provided values for solute radius, padding, and cutoff distance are physically realistic. The problem is well-posed, as it provides sufficient, consistent information to derive a unique geometric solution and support a logical argument. The language is objective and precise. Therefore, the problem is deemed valid.\n\n### Step 3: Derivation and Argument\n\nThe solution consists of two parts: first, the derivation of the minimum cubic box length, $L_{\\min}$, based on the given geometric constraints, and second, an argument assessing whether this box length prevents the solute from interacting with its own periodic images.\n\n#### Part 1: Derivation of the Minimum Box Length $L_{\\min}$\nLet the cubic simulation box have a side length of $L$. We can, without loss of generality, place the center of the box at the origin of a Cartesian coordinate system, so its faces are at $x = \\pm \\frac{L}{2}$, $y = \\pm \\frac{L}{2}$, and $z = \\pm \\frac{L}{2}$.\n\nThe biomolecular solute is contained within a sphere of radius $R = 3\\,\\mathrm{nm}$. For optimal placement that maximizes the distance to all faces, the sphere containing the solute should also be centered at the origin.\n\nThe maximum extent of the solute along any Cartesian axis is its diameter, $D = 2R$.\n\nThe problem states that there must be a solvent layer of at least thickness $p = 1.2\\,\\mathrm{nm}$ between the solute surface and each face of the box. The total length $L$ of the box along one dimension must therefore accommodate the solute's full diameter ($2R$) plus the padding on both sides ($p$ on one side and $p$ on the other).\nTherefore, the minimum required length $L_{\\min}$ is the sum of these segments:\n$$ L_{\\min} = 2R + 2p $$\nSubstituting the given values $R = 3\\,\\mathrm{nm}$ and $p = 1.2\\,\\mathrm{nm}$:\n$$ L_{\\min} = 2(3\\,\\mathrm{nm}) + 2(1.2\\,\\mathrm{nm}) $$\n$$ L_{\\min} = 6\\,\\mathrm{nm} + 2.4\\,\\mathrm{nm} $$\n$$ L_{\\min} = 8.4\\,\\mathrm{nm} $$\n\n#### Part 2: Argument on Self-Interaction\nThe second part of the question is to determine if this box size, $L_{\\min} = 8.4\\,\\mathrm{nm}$, is sufficient to prevent any atom of the solute from directly interacting with any atom of its own periodic images.\n\nIn a system with periodic boundary conditions, an atom interacts with the closest periodic image of every other atom in the system (the minimum image convention). For a solute molecule to not \"see\" its own image, the shortest distance between any atom in the central solute and any atom in any of the solute's periodic images must be greater than the real-space interaction cutoff, $r_c$.\n\nLet the solute in the primary box be centered at the origin. Its atoms are contained within a sphere of radius $R$. The periodic images of this solute are centered at positions corresponding to integer multiples of the box vectors, for example, at $(\\pm L, 0, 0)$, $(0, \\pm L, 0)$, etc. The closest images are in the adjacent boxes.\n\nConsider the solute in the primary box and its image in the adjacent box along the $+x$ direction, centered at $(L, 0, 0)$. The solute in the primary box extends at most to $x = +R$. The solute in the image box extends at most to $x = L-R$ (in the direction of the primary box).\n\nThe minimum distance, $d_{\\min}$, between the surfaces of the solute in the primary box and its closest periodic image is the distance between their centers, $L$, minus the extent of each towards the other, $R$.\n$$ d_{\\min} = L - R - R = L - 2R $$\nFor there to be no direct real-space interaction, this minimum separation must be strictly greater than the cutoff radius $r_c$.\n$$ d_{\\min} > r_c $$\n$$ L - 2R > r_c $$\nWe must verify if our calculated $L_{\\min}$ satisfies this condition. We substitute $L = L_{\\min} = 2R + 2p$ into the inequality:\n$$ (2R + 2p) - 2R > r_c $$\n$$ 2p > r_c $$\nNow we substitute the given numerical values for $p$ and $r_c$:\n$$ p = 1.2\\,\\mathrm{nm} $$\n$$ r_c = 1.0\\,\\mathrm{nm} $$\nThe condition becomes:\n$$ 2(1.2\\,\\mathrm{nm}) > 1.0\\,\\mathrm{nm} $$\n$$ 2.4\\,\\mathrm{nm} > 1.0\\,\\mathrm{nm} $$\nThis inequality is true. The margin of safety is $2p - r_c = 1.4\\,\\mathrm{nm}$.\n\nThus, the minimum box length $L_{\\min}$ derived from the solvent padding requirement is indeed sufficient to guarantee that no atom of the solute can directly interact in real space with any atom of its own periodic images, as the shortest distance between the solute and its image ($2.4\\,\\mathrm{nm}$) is more than double the interaction cutoff radius ($1.0\\,\\mathrm{nm}$).\nThis also satisfies the general criterion for using a spherical cutoff, which is $L > 2r_c$. In our case, $L_{\\min} = 8.4\\,\\mathrm{nm}$ is much greater than $2r_c = 2.0\\,\\mathrm{nm}$.\n\nThe final value for the minimum cubic box length is $L_{\\min} = 8.4\\,\\mathrm{nm}$.", "answer": "$$\\boxed{8.4}$$", "id": "4586373"}, {"introduction": "The accuracy and stability of a molecular dynamics simulation are fundamentally limited by the choice of the integration time step, $\\Delta t$. This practice delves into the heart of the simulation engine by exploring the stability of the Verlet integrator, one of the most common algorithms for propagating atomic motion. By modeling the fastest motions in the system as a harmonic oscillator, you will derive the theoretical upper bound on $\\Delta t$, providing a rigorous justification for the typical femtosecond-scale time steps used in biomolecular simulations [@problem_id:4586302].", "problem": "A research group in bioinformatics and medical data analytics is performing Molecular Dynamics (MD) simulations of a solvated peptide with unconstrained hydrogen bonds. In MD, numerical stability of the time integration is controlled by the highest vibrational frequency present in the system. Consider a single normal mode approximated near equilibrium by a harmonic oscillator with natural angular frequency $\\omega$ arising from linearization of Newton's second law $m\\,d^{2}x/dt^{2}=-\\partial U/\\partial x$ about a minimum of the potential energy $U(x)$. The simulation uses the standard position form of the Verlet integrator to propagate atomic positions. \n\nStarting from these fundamental bases (Newton’s second law, small-amplitude harmonic approximation, and the position form of the Verlet integrator), derive the explicit upper bound on the MD time step $\\Delta t$ required for linear stability as a function of the highest angular frequency $\\omega_{\\max}$ in the biomolecule. Then, under the laboratory’s conservative policy that production runs use a safety factor $s=0.25$ relative to the maximum stable $\\Delta t$ you derive, compute a feasible $\\Delta t$ for a peptide whose unconstrained X–H bond stretching sets $\\omega_{\\max}=3\\times 10^{14}\\ \\mathrm{s}^{-1}$. \n\nExpress your final $\\Delta t$ in femtoseconds (fs) and round your answer to three significant figures. Your final answer must be a single real-valued number.", "solution": "The problem requires the derivation of the stability condition for the Verlet integrator applied to a harmonic oscillator, followed by the application of this result to a specific biomolecular simulation scenario. The derivation proceeds from the fundamental principles outlined in the problem statement.\n\nFirst, we model the high-frequency vibration of an X-H bond as a one-dimensional simple harmonic oscillator. The potential energy $U(x)$ near a minimum at equilibrium position $x=0$ is approximated by the first non-zero term in its Taylor expansion, $U(x) \\approx \\frac{1}{2}kx^2$, where $k$ is the effective spring constant of the bond. Newton's second law of motion is $m\\frac{d^2x}{dt^2} = F(x)$, where the force is $F(x) = -\\frac{\\partial U}{\\partial x} = -kx$. The equation of motion is therefore $m\\frac{d^2x}{dt^2} = -kx$. This can be expressed in terms of the natural angular frequency of the oscillator, $\\omega = \\sqrt{\\frac{k}{m}}$, as:\n$$\n\\frac{d^2x}{dt^2} = -\\omega^2 x(t)\n$$\nThe acceleration at time $t$ is thus $a(t) = -\\omega^2 x(t)$.\n\nNext, we introduce the standard position form of the Verlet integrator. The position of a particle at time step $n+1$, denoted $x_{n+1} = x((n+1)\\Delta t)$, is propagated from the positions at time steps $n$ and $n-1$ using the following finite difference equation:\n$$\nx_{n+1} = 2x_n - x_{n-1} + a_n (\\Delta t)^2\n$$\nwhere $a_n = a(n\\Delta t)$ is the acceleration at time step $n$ and $\\Delta t$ is the integration time step.\n\nWe substitute the expression for the acceleration of the harmonic oscillator into the Verlet integration formula:\n$$\nx_{n+1} = 2x_n - x_{n-1} - \\omega^2 x_n (\\Delta t)^2\n$$\nRearranging this equation gives a linear homogeneous recurrence relation with constant coefficients:\n$$\nx_{n+1} - \\left(2 - \\omega^2 (\\Delta t)^2\\right) x_n + x_{n-1} = 0\n$$\n\nTo analyze the stability of this numerical scheme, we propose a solution of the form $x_n = A\\lambda^n$. Substituting this ansatz into the recurrence relation yields the characteristic equation for $\\lambda$:\n$$\nA\\lambda^{n+1} - \\left(2 - \\omega^2 (\\Delta t)^2\\right) A\\lambda^n + A\\lambda^{n-1} = 0\n$$\nFor a non-trivial solution ($A \\ne 0, \\lambda \\ne 0$), we can divide by $A\\lambda^{n-1}$ to obtain a quadratic equation in $\\lambda$:\n$$\n\\lambda^2 - \\left(2 - \\omega^2 (\\Delta t)^2\\right) \\lambda + 1 = 0\n$$\n\nFor the trajectory $x_n$ to remain bounded, which is the condition for numerical stability, the magnitude of the roots $\\lambda$ of the characteristic equation must not exceed unity, i.e., $|\\lambda| \\le 1$. Let us define a variable $\\beta = 1 - \\frac{\\omega^2 (\\Delta t)^2}{2}$. The characteristic equation can be rewritten as $\\lambda^2 - 2\\beta\\lambda + 1 = 0$. The roots are given by the quadratic formula:\n$$\n\\lambda = \\frac{2\\beta \\pm \\sqrt{4\\beta^2 - 4}}{2} = \\beta \\pm \\sqrt{\\beta^2 - 1}\n$$\n\nThe stability depends on the nature of these roots, which is determined by the discriminant $\\beta^2 - 1$:\n1. If $|\\beta| > 1$, then $\\beta^2 - 1 > 0$, and the roots are real. Since the product of the roots is $\\lambda_1 \\lambda_2 = 1$ (from the constant term of the quadratic), one root must have a magnitude greater than $1$. This leads to an exponential growth in the solution $x_n = A\\lambda^n$, signifying instability.\n2. If $|\\beta| \\le 1$, then $\\beta^2 - 1 \\le 0$. The roots are complex conjugates (or real and equal if $|\\beta|=1$).\n   - If $|\\beta| < 1$, the roots are $\\lambda = \\beta \\pm i\\sqrt{1-\\beta^2}$. The magnitude of these roots is $|\\lambda| = \\sqrt{\\beta^2 + \\left(\\sqrt{1-\\beta^2}\\right)^2} = \\sqrt{\\beta^2 + 1 - \\beta^2} = 1$. The solution is oscillatory with constant amplitude, which corresponds to a stable integration that correctly reproduces the energy-conserving dynamics of the harmonic oscillator.\n   - At the boundary, $|\\beta|=1$, the roots are real and equal, $\\lambda_{1,2}=\\beta=\\pm 1$. This is the limit of stability.\n\nTherefore, the condition for numerical stability of the Verlet integrator for a harmonic oscillator is $|\\beta| \\le 1$. Substituting the definition of $\\beta$:\n$$\n\\left| 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} \\right| \\le 1\n$$\nThis absolute value inequality is equivalent to the compound inequality:\n$$\n-1 \\le 1 - \\frac{\\omega^2 (\\Delta t)^2}{2} \\le 1\n$$\nThe right-hand side, $1 - \\frac{\\omega^2 (\\Delta t)^2}{2} \\le 1$, implies $-\\frac{\\omega^2 (\\Delta t)^2}{2} \\le 0$, which is always true for real $\\omega$ and $\\Delta t$. The left-hand side provides the critical constraint on the time step:\n$$\n-1 \\le 1 - \\frac{\\omega^2 (\\Delta t)^2}{2}\n$$\n$$\n\\frac{\\omega^2 (\\Delta t)^2}{2} \\le 2\n$$\n$$\n\\omega^2 (\\Delta t)^2 \\le 4\n$$\nTaking the square root of both sides (since $\\omega > 0$ and $\\Delta t > 0$) yields the stability condition:\n$$\n\\omega \\Delta t \\le 2\n$$\nIn a complex system like a biomolecule, this condition must hold for all vibrational modes. The stability of the entire simulation is governed by the mode with the highest frequency, $\\omega_{\\max}$, as it imposes the most restrictive limit on $\\Delta t$. The upper bound for the time step is thus:\n$$\n\\Delta t \\le \\frac{2}{\\omega_{\\max}}\n$$\nThe maximum stable time step is $\\Delta t_{\\max} = \\frac{2}{\\omega_{\\max}}$.\n\nNow, we apply this derived result to the specific problem. We are given the highest angular frequency $\\omega_{\\max} = 3 \\times 10^{14}\\ \\mathrm{s}^{-1}$. The maximum stable time step is:\n$$\n\\Delta t_{\\max} = \\frac{2}{3 \\times 10^{14}\\ \\mathrm{s}^{-1}} = \\frac{2}{3} \\times 10^{-14}\\ \\mathrm{s}\n$$\nThe laboratory's policy is to use a feasible time step $\\Delta t$ that is a fraction of this maximum value, determined by a safety factor $s=0.25$:\n$$\n\\Delta t = s \\cdot \\Delta t_{\\max} = 0.25 \\cdot \\left(\\frac{2}{3} \\times 10^{-14}\\ \\mathrm{s}\\right) = \\frac{1}{4} \\cdot \\frac{2}{3} \\times 10^{-14}\\ \\mathrm{s} = \\frac{2}{12} \\times 10^{-14}\\ \\mathrm{s} = \\frac{1}{6} \\times 10^{-14}\\ \\mathrm{s}\n$$\nFinally, we convert this result to femtoseconds (fs), using the conversion factor $1\\ \\mathrm{fs} = 10^{-15}\\ \\mathrm{s}$:\n$$\n\\Delta t = \\left(\\frac{1}{6} \\times 10^{-14}\\ \\mathrm{s}\\right) \\times \\left(\\frac{1\\ \\mathrm{fs}}{10^{-15}\\ \\mathrm{s}}\\right) = \\frac{1}{6} \\times 10^{(-14 - (-15))}\\ \\mathrm{fs} = \\frac{1}{6} \\times 10^{1}\\ \\mathrm{fs} = \\frac{10}{6}\\ \\mathrm{fs} = \\frac{5}{3}\\ \\mathrm{fs}\n$$\nEvaluating this fraction gives $\\Delta t \\approx 1.666... \\mathrm{fs}$. As per the problem's requirement, we round this to three significant figures:\n$$\n\\Delta t \\approx 1.67\\ \\mathrm{fs}\n$$", "answer": "$$\\boxed{1.67}$$", "id": "4586302"}, {"introduction": "A primary goal of molecular dynamics in medical data analytics is to compute thermodynamically meaningful quantities, such as the binding free energy of a drug to its target protein. This advanced practice transitions from running simulations to analyzing their output, focusing on the powerful Multistate Bennett Acceptance Ratio (MBAR) method for free energy calculation. You will implement the core self-consistency equations and statistical error analysis of MBAR, turning raw simulation data into a precise estimate of the free energy difference between alchemical states, a cornerstone of modern computational drug design [@problem_id:4586308].", "problem": "You are given an alchemical series with $K=12$ windows (thermodynamic states) used in molecular dynamics free energy calculations. Let $N_i$ denote the number of uncorrelated samples drawn from window $i$, and let $O_{ij}$ denote the overlap matrix entries defined as the total weight assigned to state $j$ by all samples drawn from window $i$ under Multistate Bennett Acceptance Ratio (MBAR) reweighting. Each row of $O$ satisfies the normalization constraint $\\sum_{j=1}^{K} O_{ij} = N_i$. The MBAR dimensionless reduced free energies $f_j$ satisfy the self-consistency property that the total weight assigned to state $j$ across all samples equals $N_j e^{-f_j}$, which enforces a global normalization and fixes the absolute scale.\n\nStarting from the statistical mechanical Boltzmann definition of reduced potentials and the MBAR self-consistency framework, derive from first principles how to compute the dimensionless free energies $f_j$ solely from $N_i$ and $O_{ij}$, and then compute the physical free energy difference $\\Delta G$ between window $1$ and window $12$ at absolute temperature $T$ using $\\Delta G = R T \\Delta f$, where $\\Delta f = f_{12} - f_{1}$, $R$ is the molar gas constant, and $T$ must be specified in kelvin. Additionally, estimate the large-sample uncertainty of $\\Delta G$ using asymptotic normal approximations based on the Central Limit Theorem and the delta method, modeling the per-window overlap row $O_{i\\cdot}$ as arising from a multinomial distribution over states $j$ with probabilities $p_{ij} = O_{ij} / N_i$. In this approximation, for each state $j$,\n$$\nS_j = \\sum_{i=1}^{K} O_{ij}, \\quad \\hat{f}_j = -\\ln\\left(\\frac{S_j}{N_j}\\right),\n$$\nand the variance and covariance of the aggregated column sums are\n$$\n\\mathrm{Var}(S_j) \\approx \\sum_{i=1}^{K} N_i p_{ij} (1 - p_{ij}), \\quad \\mathrm{Cov}(S_j,S_k) \\approx -\\sum_{i=1}^{K} N_i p_{ij} p_{ik},\n$$\nyielding, by the delta method,\n$$\n\\mathrm{Var}(\\hat{f}_j) \\approx \\frac{\\mathrm{Var}(S_j)}{S_j^2}, \\quad \\mathrm{Cov}(\\hat{f}_j,\\hat{f}_k) \\approx \\frac{\\mathrm{Cov}(S_j,S_k)}{S_j S_k},\n$$\nand therefore\n$$\n\\mathrm{Var}(\\Delta f) \\approx \\mathrm{Var}(\\hat{f}_{12}) + \\mathrm{Var}(\\hat{f}_{1}) - 2 \\, \\mathrm{Cov}(\\hat{f}_{12},\\hat{f}_{1}),\n$$\nwith uncertainty in energy units given by\n$$\n\\sigma_{\\Delta G} \\approx R T \\sqrt{\\mathrm{Var}(\\Delta f)}.\n$$\n\nExpress the final energy difference and its uncertainty in kilojoules per mole (kJ/mol). Use $R = 8.314462618 \\times 10^{-3}$ kJ mol$^{-1}$ K$^{-1}$. Use $T=300$ K.\n\nYour program must implement this procedure and produce a single-line output containing the results for all provided test cases in a single Python list, where each element is the pair $[\\Delta G, \\sigma_{\\Delta G}]$ for one test case, both as floating-point numbers in kJ/mol.\n\nTest Suite. For each test case, $N$ and an overlap matrix $O$ must be specified. To ensure scientific self-consistency and plausibility without requiring raw per-sample reduced potentials, the overlap matrices $O$ in these tests are constructed to be MBAR-consistent rank-one matrices of the form\n$$\nO_{ij} = N_i \\alpha_j, \\quad \\text{with} \\quad \\alpha_j = \\frac{N_j e^{-f_j}}{\\sum_{m=1}^{K} N_m e^{-f_m}},\n$$\nwhere the vector $f$ is a specified target dimensionless free energy profile for the series and an additive constant is chosen such that $\\sum_{j=1}^{K} N_j e^{-f_j} = \\sum_{i=1}^{K} N_i$ (this enforces MBAR normalization). This construction yields $\\sum_{j} O_{ij} = N_i$ and $\\sum_{i} O_{ij} = N_j e^{-f_j}$, ensuring the overlap matrix is physically consistent with MBAR self-consistency.\n\nProvide implementations for the following three test cases:\n\n- Test Case 1 (happy path, uniform $N$, moderate free energy gradient):\n    - $N = [1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000]$.\n    - Base $f_j$ before normalization: $f_j^{\\mathrm{base}} = 0.5 \\times (j-1)$ for $j=1,\\dots,12$.\n    - The actual $f_j$ used in $O$ is $f_j = f_j^{\\mathrm{base}} + c$, where $c$ is chosen such that $\\sum_{j} N_j e^{-f_j} = \\sum_{i} N_i$.\n\n- Test Case 2 (edge case, nonuniform $N$, steep free energy gradient):\n    - $N = [200,400,600,800,1000,1200,1200,1000,800,600,400,200]$.\n    - Base $f_j^{\\mathrm{base}} = 1.0 \\times (j-1)$, normalized with $c$ as above.\n\n- Test Case 3 (boundary condition, very small $N$, flat free energy profile):\n    - $N = [5,10,5,10,5,10,5,10,5,10,5,10]$.\n    - Base $f_j^{\\mathrm{base}} = 0$ for all $j$, normalized with $c$ as above (which equals $0$ in this case).\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., \"[[result_case1_deltaG,result_case1_sigma],[result_case2_deltaG,result_case2_sigma],[result_case3_deltaG,result_case3_sigma]]\"), where each result is expressed in kJ/mol, with both $\\Delta G$ and its uncertainty $\\sigma_{\\Delta G}$ as floating-point numbers.", "solution": "The problem requires the derivation and implementation of a method to compute the free energy difference, $\\Delta G$, and its associated uncertainty, $\\sigma_{\\Delta G}$, between two thermodynamic states in an alchemical series using the Multistate Bennett Acceptance Ratio (MBAR) framework. The analysis is based on a given number of samples per state, $N_i$, and a provided overlap matrix, $O_{ij}$.\n\nFirst, we address the derivation of the dimensionless reduced free energies, $f_j$, from the provided quantities. The problem is set in the context of an alchemical simulation with $K=12$ thermodynamic states. The overlap matrix entry $O_{ij}$ is defined as the total weight assigned to state $j$ by all $N_i$ uncorrelated samples drawn from window $i$. The total weight, $S_j$, assigned to state $j$ from all samples across all $K$ windows is the sum of contributions from each window $i$:\n$$\nS_j = \\sum_{i=1}^{K} O_{ij}\n$$\nThe problem statement provides the fundamental self-consistency property of the MBAR method, which connects this aggregate weight $S_j$ to the dimensionless reduced free energy $f_j$ of state $j$ and the number of samples $N_j$ drawn from that state. This property is rooted in the principles of statistical mechanics and maximum likelihood estimation that underpin the MBAR method. The given relation is:\n$$\nS_j = N_j e^{-f_j}\n$$\nThis equation establishes a direct link between the observable data (summarized in $S_j$ and $N_j$) and the thermodynamic quantity of interest ($f_j$). To derive the expression for $f_j$, we simply solve this equation. Rearranging the terms, we get:\n$$\ne^{-f_j} = \\frac{S_j}{N_j}\n$$\nTaking the natural logarithm of both sides gives:\n$$\n-f_j = \\ln\\left(\\frac{S_j}{N_j}\\right)\n$$\nFinally, multiplying by $-1$ yields the estimator for the dimensionless free energy of state $j$:\n$$\n\\hat{f}_j = -\\ln\\left(\\frac{S_j}{N_j}\\right)\n$$\nThe hat symbol ($\\hat{\\cdot}$) is used to denote that this is an estimate derived from a finite number of samples.\n\nWith the estimator for the individual free energies, we can compute the dimensionless free energy difference, $\\Delta f$, between the final state (window $12$) and the initial state (window $1$). Using $1$-based indexing as in the problem text, this is:\n$$\n\\Delta f = \\hat{f}_{12} - \\hat{f}_{1}\n$$\nThe corresponding physical free energy difference, $\\Delta G$, is obtained by scaling $\\Delta f$ by the product of the molar gas constant, $R$, and the absolute temperature, $T$:\n$$\n\\Delta G = R T \\Delta f = R T (\\hat{f}_{12} - \\hat{f}_{1})\n$$\nThe problem specifies the values $R = 8.314462618 \\times 10^{-3} \\, \\text{kJ mol}^{-1} \\text{K}^{-1}$ and $T = 300 \\, \\text{K}$.\n\nNext, we address the estimation of the uncertainty, $\\sigma_{\\Delta G}$. The uncertainty arises because the overlap matrix entries $O_{ij}$ are themselves random variables derived from a finite number of samples. The problem provides a statistical model where the samples from each window $i$ are distributed among the $K$ states according to a multinomial distribution. The set of overlap counts for window $i$, $\\{O_{i1}, O_{i2}, \\dots, O_{iK}\\}$, is modeled as a multinomial random vector with $N_i$ total trials and probabilities $p_{ij} = O_{ij} / N_i$. Since samples drawn from different windows are independent, the variances and covariances of the aggregate sums $S_j$ are the sums of variances and covariances from each window.\n\nThe variance of $S_j$ and the covariance between $S_j$ and $S_k$ are given by the asymptotic formulas:\n$$\n\\mathrm{Var}(S_j) \\approx \\sum_{i=1}^{K} N_i p_{ij} (1 - p_{ij})\n$$\n$$\n\\mathrm{Cov}(S_j,S_k) \\approx -\\sum_{i=1}^{K} N_i p_{ij} p_{ik} \\quad (\\text{for } j \\neq k)\n$$\nWe use the delta method to propagate these uncertainties to the estimated free energies $\\hat{f}_j$. The first-order Taylor expansion gives the partial derivative $\\frac{\\partial \\hat{f}_j}{\\partial S_j} = \\frac{\\partial}{\\partial S_j} (-\\ln(S_j/N_j)) = -1/S_j$. The resulting variances and covariances for the free energy estimates are:\n$$\n\\mathrm{Var}(\\hat{f}_j) \\approx \\left(\\frac{\\partial \\hat{f}_j}{\\partial S_j}\\right)^2 \\mathrm{Var}(S_j) = \\frac{\\mathrm{Var}(S_j)}{S_j^2}\n$$\n$$\n\\mathrm{Cov}(\\hat{f}_j,\\hat{f}_k) \\approx \\left(\\frac{\\partial \\hat{f}_j}{\\partial S_j}\\right) \\left(\\frac{\\partial \\hat{f}_k}{\\partial S_k}\\right) \\mathrm{Cov}(S_j,S_k) = \\frac{\\mathrm{Cov}(S_j,S_k)}{S_j S_k}\n$$\nThe variance of the free energy difference $\\Delta f = \\hat{f}_{12} - \\hat{f}_1$ is then found using the standard formula for the variance of a difference between two correlated variables:\n$$\n\\mathrm{Var}(\\Delta f) \\approx \\mathrm{Var}(\\hat{f}_{12}) + \\mathrm{Var}(\\hat{f}_{1}) - 2 \\, \\mathrm{Cov}(\\hat{f}_{12},\\hat{f}_{1})\n$$\nThe standard uncertainty in $\\Delta f$, denoted $\\sigma_{\\Delta f}$, is the square root of this variance. The uncertainty in the physical free energy difference, $\\sigma_{\\Delta G}$, is then:\n$$\n\\sigma_{\\Delta G} = R T \\sigma_{\\Delta f} = R T \\sqrt{\\mathrm{Var}(\\Delta f)}\n$$\nThe implementation will first generate the overlap matrices for each test case according to the specified procedure, which creates a self-consistent, rank-one matrix $O_{ij} = N_i \\alpha_j$. Although the free energies $f_j$ used to generate $O_{ij}$ are known, the algorithm will treat $O_{ij}$ and $N_i$ as the primary inputs and re-calculate the free energies and their uncertainties as if the underlying $f_j$ were unknown, thereby validating the computational procedure.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the specified test cases and print the results.\n    \"\"\"\n\n    def calculate_free_energy_and_uncertainty(N, f_base):\n        \"\"\"\n        Calculates the free energy difference and its uncertainty for a single test case.\n\n        Args:\n            N (np.ndarray): Array of sample counts for each of the K windows.\n            f_base (np.ndarray): Array of base dimensionless free energies for the K windows.\n\n        Returns:\n            list: A list containing [delta_G, sigma_delta_G] in kJ/mol.\n        \"\"\"\n        # Constants\n        K = 12\n        R = 8.314462618e-3  # kJ mol^-1 K^-1\n        T = 300.0            # K\n        RT = R * T\n\n        # Ensure inputs are numpy arrays\n        N = np.array(N, dtype=float)\n        f_base = np.array(f_base, dtype=float)\n\n        # 1. Generate the MBAR-consistent overlap matrix O\n        # This part simulates the an ideal output from an MBAR calculation\n        # to serve as a self-consistent test case.\n\n        # Calculate the normalization constant c for the true free energies\n        sum_N = np.sum(N)\n        sum_N_exp_f_base = np.sum(N * np.exp(-f_base))\n        \n        # log is used to avoid potential numerical overflow/underflow\n        # c = ln( (sum N_j exp(-f_j_base)) / (sum N_i) )\n        c = np.log(sum_N_exp_f_base / sum_N)\n\n        # The \"true\" dimensionless free energies used to generate the data\n        f_true = f_base + c\n\n        # Calculate the alpha_j probabilities\n        # alpha_j = N_j * exp(-f_true_j) / sum_N\n        alpha = (N * np.exp(-f_true)) / sum_N\n\n        # Construct the rank-one overlap matrix O\n        # O_ij = N_i * alpha_j\n        O = np.outer(N, alpha)\n\n        # 2. Analyze the data (N, O) to recover the free energies and uncertainties\n        # This part implements the procedure described in the problem statement,\n        # treating N and O as the only available inputs.\n\n        # Calculate S_j, the column sums of O\n        S = np.sum(O, axis=0)\n        \n        # As a check: in this idealized case, S_j = sum_i(N_i * alpha_j) = sum_N * alpha_j\n        # And f_hat_j = -log(S_j/N_j) = -log((sum_N*alpha_j)/N_j)\n        #            = -log((sum_N/N_j) * (N_j*exp(-f_true_j)/sum_N)) = f_true_j\n        # So, the recovered free energies should match the true ones exactly.\n        f_hat = -np.log(S / N)\n        \n        # Calculate the dimensionless free energy difference between window 12 and 1\n        delta_f = f_hat[11] - f_hat[0]\n\n        # Calculate the physical free energy difference in kJ/mol\n        delta_G = RT * delta_f\n\n        # 3. Estimate the uncertainty\n        \n        # Calculate the probability matrix p_ij = O_ij / N_i\n        # In this special case, each row of p is identical and equal to alpha.\n        p = O / N[:, np.newaxis]\n\n        # Calculate Var(S_j) and Cov(S_j, S_k) for j,k in {0, 11}\n        # Var(S_j) = sum_i N_i * p_ij * (1 - p_ij)\n        var_S_0 = np.sum(N * p[:, 0] * (1 - p[:, 0]))\n        var_S_11 = np.sum(N * p[:, 11] * (1 - p[:, 11]))\n\n        # Cov(S_j, S_k) = -sum_i N_i * p_ij * p_ik\n        cov_S_0_11 = -np.sum(N * p[:, 0] * p[:, 11])\n\n        # Propagate uncertainty to f_hat using the delta method\n        # Var(f_hat_j) = Var(S_j) / S_j^2\n        var_f_hat_0 = var_S_0 / (S[0]**2)\n        var_f_hat_11 = var_S_11 / (S[11]**2)\n        \n        # Cov(f_hat_j, f_hat_k) = Cov(S_j, S_k) / (S_j * S_k)\n        cov_f_hat_0_11 = cov_S_0_11 / (S[0] * S[11])\n\n        # Calculate variance of the free energy difference\n        # Var(f_12 - f_1) = Var(f_12) + Var(f_1) - 2*Cov(f_12, f_1)\n        var_delta_f = var_f_hat_11 + var_f_hat_0 - 2 * cov_f_hat_0_11\n\n        # Calculate uncertainty in physical units (kJ/mol)\n        sigma_delta_G = RT * np.sqrt(var_delta_f)\n\n        return [delta_G, sigma_delta_G]\n\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1: uniform N, moderate gradient\n        {\n            \"N\": np.full(12, 1000),\n            \"f_base\": 0.5 * np.arange(12)\n        },\n        # Case 2: nonuniform N, steep gradient\n        {\n            \"N\": [200, 400, 600, 800, 1000, 1200, 1200, 1000, 800, 600, 400, 200],\n            \"f_base\": 1.0 * np.arange(12)\n        },\n        # Case 3: small N, flat profile\n        {\n            \"N\": [5, 10, 5, 10, 5, 10, 5, 10, 5, 10, 5, 10],\n            \"f_base\": np.zeros(12)\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_free_energy_and_uncertainty(case[\"N\"], case[\"f_base\"])\n        results.append(result)\n\n    # Format the final output string exactly as required.\n    # The map(str, ...) converts each inner list like [1.23, 4.56] to a string \"'[1.23, 4.56]'\".\n    # The outer join then puts them together with commas.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "4586308"}]}