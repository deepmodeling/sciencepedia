{"hands_on_practices": [{"introduction": "The chemical changes induced by bisulfite treatment present a fundamental challenge for mapping sequencing reads, as standard aligners expect a direct match to the reference genome. This exercise demystifies the elegant computational solution to this problem: creating in silico converted reference genomes. By implementing the logic to generate these references and map reads to them, you will gain a foundational understanding of how all modern bisulfite sequencing alignment tools work [@problem_id:4544140].", "problem": "You are given a single-stranded deoxyribonucleic acid (DNA) reference sequence $S$ over the alphabet $\\{\\text{A}, \\text{C}, \\text{G}, \\text{T}\\}$ and a set of observed sequencing reads $\\{r_i\\}$ originating from a directional sodium bisulfite sequencing library. Use the following foundational facts as the basis for your derivation and program design: (i) Sodium bisulfite converts unmethylated cytosine ($\\text{C}$) to uracil ($\\text{U}$), and during sequencing $\\text{U}$ is read as thymine ($\\text{T}$), while methylated cytosine remains as cytosine. (ii) Complementarity implies that cytosine ($\\text{C}$) pairs with guanine ($\\text{G}$), and adenine ($\\text{A}$) pairs with thymine ($\\text{T}$). (iii) In directional libraries from Whole-Genome Bisulfite Sequencing (WGBS), the sequenced read orientation is preserved, so reads derived from the forward-strand template exhibit $\\text{C}\\rightarrow\\text{T}$ conversions on the read sequence, whereas reads derived from the reverse-strand template exhibit $\\text{G}\\rightarrow\\text{A}$ conversions on the read sequence (reflecting $\\text{C}\\rightarrow\\text{T}$ on the opposite template and subsequent base pairing).\n\nYour task is to derive, from these facts, how to construct two converted references and show algorithmically how mapping to both captures reads from both strands in directional libraries. Construct the two converted references via functions $f_{\\text{CT}}$ and $f_{\\text{GA}}$ defined as:\n- $$f_{\\text{CT}}(S) = \\text{replace every } \\text{C} \\text{ in } S \\text{ with } \\text{T},$$\n- $$f_{\\text{GA}}(S) = \\text{replace every } \\text{G} \\text{ in } S \\text{ with } \\text{A}.$$\n\nDefine a read $r$ as \"mapped\" to a converted reference $R$ if and only if $r$ is an exact substring of $R$ with no mismatches. Treat the ambiguous base $\\text{N}$ as a strict mismatch (i.e., positions with $\\text{N}$ cannot match any character in $R$). Use this definition to compute, for each test case with a reference $S$ and reads $\\{r_i\\}$, the integers:\n- $$M_{\\text{CT}} = \\text{number of reads } r_i \\text{ that are exact substrings of } f_{\\text{CT}}(S),$$\n- $$M_{\\text{GA}} = \\text{number of reads } r_i \\text{ that are exact substrings of } f_{\\text{GA}}(S),$$\n- $$M_{\\text{both}} = \\text{number of reads } r_i \\text{ that are exact substrings of at least one of } f_{\\text{CT}}(S) \\text{ or } f_{\\text{GA}}(S).$$\n\nYour program must implement the construction of $f_{\\text{CT}}(S)$ and $f_{\\text{GA}}(S)$, perform exact substring mapping with the $\\text{N}$-mismatch rule, and compute the specified integers for each test case. No physical units are involved. All outputs must be integers.\n\nTest Suite (each test case is a pair $(S, \\{r_i\\})$):\n- Test Case $1$: \n  - $S = \\text{\"ACCGTGACCTAGC\"}$\n  - Reads $\\{r_i\\} = [\\text{\"ATTGTG\"}, \\text{\"ATAACC\"}, \\text{\"TTTAG\"}, \\text{\"ATNGTG\"}, \\text{\"ATTGTGATTTAGTAAAAA\"}, \\text{\"ACCGT\"}]$\n- Test Case $2$: \n  - $S = \\text{\"ATATATAT\"}$\n  - Reads $\\{r_i\\} = [\\text{\"ATATA\"}, \\text{\"TATAT\"}, \\text{\"GATAT\"}, \\text{\"ATATATAT\"}, \\text{\"NATAT\"}]$\n- Test Case $3$: \n  - $S = \\text{\"CCCCGGGG\"}$\n  - Reads $\\{r_i\\} = [\\text{\"TTTTG\"}, \\text{\"CCCAA\"}, \\text{\"CCCCG\"}, \\text{\"AAA\"}, \\text{\"GGGG\"}, \\text{\"TTTTAAAA\"}]$\n- Test Case $4$: \n  - $S = \\text{\"AGCT\"}$\n  - Reads $\\{r_i\\} = [\\text{\"AGTT\"}, \\text{\"AACT\"}, \\text{\"AGCT\"}, \\text{\"NNNN\"}, \\text{\"AGTTA\"}]$\n- Test Case $5$: \n  - $S = \\text{\"CGCGCG\"}$\n  - Reads $\\{r_i\\} = [\\text{\"TGTG\"}, \\text{\"CAC\"}, \\text{\"TGCA\"}, \\text{\"CACACA\"}, \\text{\"TGTGTG\"}, \\text{\"ACAC\"}, \\text{\"GTGT\"}]$\n\nYour program should produce a single line of output containing, for each test case, a list $[M_{\\text{CT}}, M_{\\text{GA}}, M_{\\text{both}}]$. Aggregate all test case results into a single top-level list. The exact output format is a single line with no spaces, as a comma-separated list enclosed in square brackets; for example, $$[[m_{1,\\text{CT}},m_{1,\\text{GA}},m_{1,\\text{both}}],[m_{2,\\text{CT}},m_{2,\\text{GA}},m_{2,\\text{both}}],\\dots]$$ where each $m_{k,\\cdot}$ is an integer for test case $k$.", "solution": "The problem requires the derivation and implementation of an algorithm to quantify read alignments in directional sodium bisulfite sequencing by creating two computationally converted reference sequences. The validation and solution are as follows.\n\n### **Problem Validation**\n\n**Step 1: Extract Givens**\n\n*   **Reference Sequence:** A single-stranded DNA sequence $S$ over the alphabet $\\{\\text{A}, \\text{C}, \\text{G}, \\text{T}\\}$.\n*   **Reads:** A set of observed sequencing reads $\\{r_i\\}$.\n*   **Sequencing Context:** Directional sodium bisulfite sequencing.\n*   **Principle (i):** Sodium bisulfite converts unmethylated cytosine ($\\text{C}$) to uracil ($\\text{U}$), which is sequenced as thymine ($\\text{T}$). Methylated cytosine remains as cytosine ($\\text{C}$).\n*   **Principle (ii):** Base complementarity is $\\text{C} \\leftrightarrow \\text{G}$ and $\\text{A} \\leftrightarrow \\text{T}$.\n*   **Principle (iii):** In directional libraries, reads from the forward-strand template exhibit $\\text{C}\\rightarrow\\text{T}$ conversions; reads from the reverse-strand template exhibit $\\text{G}\\rightarrow\\text{A}$ conversions on the read sequence relative to the forward reference $S$.\n*   **Function Definitions:**\n    *   $f_{\\text{CT}}(S) = \\text{replace every } \\text{C} \\text{ in } S \\text{ with } \\text{T}$.\n    *   $f_{\\text{GA}}(S) = \\text{replace every } \\text{G} \\text{ in } S \\text{ with } \\text{A}$.\n*   **Mapping Definition:** A read $r$ is \"mapped\" to a reference $R$ if $r$ is an exact substring of $R$.\n*   **Ambiguous Base Rule:** The base $\\text{N}$ is treated as a strict mismatch.\n*   **Quantities to Compute:**\n    *   $M_{\\text{CT}} = \\text{number of reads } r_i \\text{ that are exact substrings of } f_{\\text{CT}}(S)$.\n    *   $M_{\\text{GA}} = \\text{number of reads } r_i \\text{ that are exact substrings of } f_{\\text{GA}}(S)$.\n    *   $M_{\\text{both}} = \\text{number of reads } r_i \\text{ that are exact substrings of at least one of } f_{\\text{CT}}(S) \\text{ or } f_{\\text{GA}}(S)$.\n*   **Test Suite:** Five test cases, each consisting of a pair $(S, \\{r_i\\})$.\n\n**Step 2: Validate Using Extracted Givens**\n\nThe problem is reviewed against the specified validation criteria.\n*   **Scientifically Grounded:** The problem statement is based on the well-established principles of Whole-Genome Bisulfite Sequencing (WGBS). The use of in-silico converted genomes to enable the alignment of bisulfite-treated reads is a standard and fundamental technique in the field of DNA methylation analysis, employed by widely-used bioinformatics tools. The description is a correct, albeit simplified, model of the process.\n*   **Well-Posed:** All terms ($S$, $r_i$, $f_{\\text{CT}}$, $f_{\\text{GA}}$, \"mapped\") are precisely defined. The inputs (test cases) are provided, and the required outputs ($M_{\\text{CT}}$, $M_{\\text{GA}}$, $M_{\\text{both}}$) are unambiguously specified. For any given input, a unique, stable, and meaningful set of integer outputs can be computed.\n*   **Objective:** The problem is stated in objective, scientific language, free from subjective claims or ambiguity.\n\nThe problem does not exhibit any of the listed flaws (e.g., scientific unsoundness, incompleteness, contradiction, infeasibility). It is a formalizable and solvable problem directly relevant to bioinformatics.\n\n**Step 3: Verdict and Action**\n\nThe problem is **valid**. A solution will be provided.\n\n### **Derivation and Algorithmic Design**\n\nThe core principle of bisulfite sequencing is that it introduces predictable changes to the DNA sequence that are dependent on methylation status. An alignment algorithm must account for these changes to correctly map reads back to a reference genome. The problem asks us to formalize this for a directional library.\n\n**1. Theoretical Foundation**\n\nLet $S$ be the original forward-strand reference sequence.\n\n*   **Forward-Strand Reads:** A read originating from the forward strand template is subject to bisulfite conversion. Any unmethylated cytosine ($\\text{C}$) on this strand becomes a uracil ($\\text{U}$), which is subsequently read as a thymine ($\\text{T}$) by the sequencer. Methylated cytosines are protected and remain as $\\text{C}$. Therefore, a sequencing read from this strand will align to the original reference $S$ at a position where all original $\\text{T}$s are still $\\text{T}$s, all methylated $\\text{C}$s are still $\\text{C}$s, but all unmethylated $\\text{C}$s have become $\\text{T}$s. Since we do not know the methylation status a priori, to find all possible alignment locations for such a read, we must consider that *any* $\\text{C}$ in the reference could have been unmethylated and thus converted to a $\\text{T}$. The function $f_{\\text{CT}}(S)$, which creates a converted reference by replacing every $\\text{C}$ in $S$ with a $\\text{T}$, correctly models this \"all-Cs-are-unmethylated\" scenario. A read derived from the forward strand will be an exact substring of $f_{\\text{CT}}(S)$ if all of its corresponding cytosines in the original genome were either unmethylated or were already thymines. Reads containing cytosines (from methylated sites) will not match this fully-converted reference, but this problem defines mapping against the fully converted references only.\n\n*   **Reverse-Strand Reads:** The reverse strand is the complement of $S$. A cytosine on the reverse strand corresponds to a guanine ($\\text{G}$) on the forward strand $S$. When the reverse strand undergoes bisulfite treatment, its unmethylated cytosines are converted to uracils (read as thymines). However, standard alignment practice is to map all reads back to the single forward-reference sequence $S$. A $\\text{C} \\rightarrow \\text{T}$ conversion on the reverse-complement strand manifests as a $\\text{G} \\rightarrow \\text{A}$ change when the read is oriented and compared against the forward reference $S$. This is a direct consequence of base pairing rules. Therefore, to account for reads originating from the reverse strand, we must consider that any $\\text{G}$ in the reference $S$ (corresponding to a $\\text{C}$ on the reverse strand) could be read as an $\\text{A}$. The function $f_{\\text{GA}}(S)$, which replaces every $\\text{G}$ in $S$ with an $\\text{A}$, correctly models this scenario for the reverse strand.\n\n**2. Algorithmic Procedure**\n\nBased on the derivation above, the algorithm to compute the required counts for a given test case $(S, \\{r_i\\})$ is as follows:\n\n*   **Step 1: Reference Conversion.**\n    *   Construct the forward-converted reference $R_{\\text{CT}} = f_{\\text{CT}}(S)$. This is achieved by replacing every occurrence of the character '$\\text{C}$' in string $S$ with '$\\text{T}$'.\n    *   Construct the reverse-converted reference $R_{\\text{GA}} = f_{\\text{GA}}(S)$. This is achieved by replacing every occurrence of the character '$\\text{G}$' in string $S$ with '$\\text{A}$'.\n\n*   **Step 2: Read Mapping and Counting.**\n    *   Initialize three integer counters: $M_{\\text{CT}} \\leftarrow 0$, $M_{\\text{GA}} \\leftarrow 0$, and $M_{\\text{both}} \\leftarrow 0$.\n    *   Iterate through each read $r$ in the set of reads $\\{r_i\\}$. For each $r$:\n        *   The rule that the ambiguous base '$\\text{N}$' is a strict mismatch implies that any read containing '$\\text{N}$' cannot be an exact substring of $R_{\\text{CT}}$ or $R_{\\text{GA}}$, as these references are composed only of characters from $\\{\\text{A}, \\text{C}, \\text{G}, \\text{T}\\}$. Standard substring search functions correctly handle this; no special check for '$\\text{N}$' is needed if using such functions.\n        *   Determine if $r$ maps to $R_{\\text{CT}}$. Let this be a boolean variable, `maps_ct`. This is true if and only if $r$ is an exact substring of $R_{\\text{CT}}$.\n        *   Determine if $r$ maps to $R_{\\text{GA}}$. Let this be a boolean variable, `maps_ga`. This is true if and only if $r$ is an exact substring of $R_{\\text{GA}}$.\n        *   Update the counters based on these findings:\n            *   If `maps_ct` is true, increment $M_{\\text{CT}}$ by $1$.\n            *   If `maps_ga` is true, increment $M_{\\text{GA}}$ by $1$.\n            *   If `maps_ct` is true OR `maps_ga` is true, increment $M_{\\text{both}}$ by $1$.\n\n*   **Step 3: Collate Results.**\n    *   After iterating through all reads, the final values of $M_{\\text{CT}}$, $M_{\\text{GA}}$, and $M_{\\text{both}}$ form the result triplet for the test case. This procedure is repeated for all test cases in the suite.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the bisulfite sequencing read mapping problem for a suite of test cases.\n    \"\"\"\n    # Test Suite: Each case is a tuple (S, reads) where S is the reference\n    # sequence and reads is a list of sequencing reads.\n    test_cases = [\n        # Test Case 1\n        (\"ACCGTGACCTAGC\", [\"ATTGTG\", \"ATAACC\", \"TTTAG\", \"ATNGTG\", \"ATTGTGATTTAGTAAAAA\", \"ACCGT\"]),\n        # Test Case 2\n        (\"ATATATAT\", [\"ATATA\", \"TATAT\", \"GATAT\", \"ATATATAT\", \"NATAT\"]),\n        # Test Case 3\n        (\"CCCCGGGG\", [\"TTTTG\", \"CCCAA\", \"CCCCG\", \"AAA\", \"GGGG\", \"TTTTAAAA\"]),\n        # Test Case 4\n        (\"AGCT\", [\"AGTT\", \"AACT\", \"AGCT\", \"NNNN\", \"AGTTA\"]),\n        # Test Case 5\n        (\"CGCGCG\", [\"TGTG\", \"CAC\", \"TGCA\", \"CACACA\", \"TGTGTG\", \"ACAC\", \"GTGT\"])\n    ]\n\n    all_results = []\n\n    for S, reads in test_cases:\n        # Step 1: Construct the two in-silico converted references.\n        # f_CT(S): C -> T conversion for reads from the forward strand.\n        R_CT = S.replace('C', 'T')\n        \n        # f_GA(S): G -> A conversion for reads from the reverse strand.\n        R_GA = S.replace('G', 'A')\n\n        # Step 2: Initialize counters for the current test case.\n        M_CT = 0\n        M_GA = 0\n        M_both = 0\n\n        # Step 3: Iterate through each read and check for exact substring matches.\n        for r in reads:\n            # The problem defines 'N' as a strict mismatch. The 'in' operator\n            # naturally handles this, as a read containing 'N' will not be found\n            # as a substring in a reference that does not contain 'N'.\n            \n            # Check if read r maps to the C->T converted reference.\n            maps_ct = r in R_CT\n            \n            # Check if read r maps to the G->A converted reference.\n            maps_ga = r in R_GA\n            \n            # Update counters based on mapping results.\n            if maps_ct:\n                M_CT += 1\n            \n            if maps_ga:\n                M_GA += 1\n            \n            # M_both counts reads that map to at least one of the references.\n            if maps_ct or maps_ga:\n                M_both += 1\n        \n        all_results.append([M_CT, M_GA, M_both])\n\n    # Format the final output as specified: [[r1_ct,r1_ga,r1_both],[r2_ct,r2_ga,r2_both],...]\n    # Using map(str, ...) converts each inner list to its string representation.\n    # Joining with ',' separates the string representations of the lists.\n    # The outer f-string adds the enclosing brackets.\n    output_str = f\"[{','.join(map(str, all_results))}]\"\n    \n    # The problem asks for a single line of output with no spaces.\n    # The string representation of a list in Python includes spaces after commas.\n    # To match the specified format precisely, we remove spaces.\n    print(output_str.replace(\" \", \"\"))\n\nsolve()\n\n```", "id": "4544140"}, {"introduction": "Once reads are successfully aligned, the raw data is not yet ready for analysis, as it contains noise from various experimental and technical sources. This practice walks you through the essential process of data filtering, where each alignment is scrutinized for mapping quality, base quality, and potential PCR duplication to ensure the reliability of downstream conclusions. You will apply these common filters to a dataset and then use the high-confidence observations to derive a quantitative methylation estimate, directly connecting the practice of data hygiene to the principles of statistical inference [@problem_id:4544197].", "problem": "A single cytosine–phosphate–guanine (CpG) site is interrogated by whole-genome bisulfite sequencing. In sodium bisulfite treatment, an unmethylated cytosine is deaminated to uracil and sequenced as thymine, while a methylated cytosine remains as cytosine. A Phred base quality score $Q$ encodes the probability of a base-calling error as $P(\\text{error}) = 10^{-Q/10}$. A Phred-scaled mapping quality $MQ$ encodes the probability that a read is incorrectly mapped as $P(\\text{wrong map}) = 10^{-MQ/10}$. Reads marked as duplicates are assumed to be polymerase chain reaction (PCR) duplicates and are to be excluded. You are given a set of $20$ reads covering a single CpG with the observed base at the CpG ($C$ or $T$), the read’s mapping quality $MQ$, the base quality $Q$ at the CpG position, and a duplicate flag $\\mathrm{DUP} \\in \\{0,1\\}$:\n- Read $1$: base $C$, $MQ=37$, $Q=35$, $\\mathrm{DUP}=0$\n- Read $2$: base $C$, $MQ=41$, $Q=32$, $\\mathrm{DUP}=0$\n- Read $3$: base $T$, $MQ=38$, $Q=33$, $\\mathrm{DUP}=0$\n- Read $4$: base $C$, $MQ=29$, $Q=38$, $\\mathrm{DUP}=0$\n- Read $5$: base $T$, $MQ=36$, $Q=28$, $\\mathrm{DUP}=0$\n- Read $6$: base $C$, $MQ=60$, $Q=40$, $\\mathrm{DUP}=1$\n- Read $7$: base $C$, $MQ=60$, $Q=40$, $\\mathrm{DUP}=0$\n- Read $8$: base $T$, $MQ=31$, $Q=31$, $\\mathrm{DUP}=0$\n- Read $9$: base $T$, $MQ=34$, $Q=30$, $\\mathrm{DUP}=0$\n- Read $10$: base $C$, $MQ=35$, $Q=30$, $\\mathrm{DUP}=0$\n- Read $11$: base $T$, $MQ=50$, $Q=39$, $\\mathrm{DUP}=0$\n- Read $12$: base $C$, $MQ=33$, $Q=29$, $\\mathrm{DUP}=0$\n- Read $13$: base $C$, $MQ=32$, $Q=35$, $\\mathrm{DUP}=0$\n- Read $14$: base $T$, $MQ=45$, $Q=35$, $\\mathrm{DUP}=1$\n- Read $15$: base $C$, $MQ=42$, $Q=31$, $\\mathrm{DUP}=0$\n- Read $16$: base $T$, $MQ=55$, $Q=37$, $\\mathrm{DUP}=0$\n- Read $17$: base $C$, $MQ=47$, $Q=30$, $\\mathrm{DUP}=0$\n- Read $18$: base $T$, $MQ=30$, $Q=30$, $\\mathrm{DUP}=0$\n- Read $19$: base $C$, $MQ=44$, $Q=34$, $\\mathrm{DUP}=0$\n- Read $20$: base $T$, $MQ=39$, $Q=31$, $\\mathrm{DUP}=0$\n\nApply the following filters to obtain high-confidence observations: retain only reads with $MQ \\geq 30$, base quality $Q \\geq 30$ at the CpG position, and $\\mathrm{DUP} = 0$. Let $n$ be the number of retained reads, $c$ the retained count of observed $C$, and $t$ the retained count of observed $T$, with $n=c+t$.\n\nAssume a bisulfite non-conversion rate $r = 0.01$, meaning an unmethylated cytosine fails to convert with probability $r$ before sequencing. Assume a symmetric base-calling error model with per-read error probability $e$ equal to the error implied by the minimum retained base-quality threshold, i.e., $e = 10^{-Q_{\\min}/10}$ with $Q_{\\min}=30$. Under these assumptions and the biochemical process of bisulfite conversion, derive from first principles the probability of observing a $C$ at this site in a retained read as a linear function of the methylation fraction $m \\in [0,1]$. Then, using a method-of-moments argument equating the empirical fraction $\\hat{p} = c/n$ to the derived expectation, solve for an estimator $\\hat{m}$ of $m$ in closed form and evaluate it numerically from the filtered data.\n\nBriefly justify how each filter (mapping quality, base quality, duplicate removal) affects estimation bias and variance in this context, but report as your final answer only the numerical value of $\\hat{m}$ as a decimal (no percentage sign). Round your final reported value to four significant figures.", "solution": "The problem is assessed to be valid as it is scientifically grounded in the principles of bisulfite sequencing, well-posed with sufficient data and clear objectives, and objectively stated.\n\nThe solution proceeds in five steps: first, filtering the provided sequencing data; second, deriving a probabilistic model for the observed base as a function of the methylation fraction; third, deriving an estimator for the methylation fraction using the method of moments; fourth, calculating the numerical value of the estimate; and fifth, justifying the use of data filters.\n\nFirst, the raw sequencing data must be filtered to retain only high-confidence observations. The specified criteria are a mapping quality $MQ \\geq 30$, a base quality $Q \\geq 30$ at the CpG position, and the absence of a duplicate flag (i.e., $\\mathrm{DUP} = 0$). We apply these filters to the set of $20$ reads:\n- Read $1$: $C, MQ=37, Q=35, \\mathrm{DUP}=0$. Kept.\n- Read $2$: $C, MQ=41, Q=32, \\mathrm{DUP}=0$. Kept.\n- Read $3$: $T, MQ=38, Q=33, \\mathrm{DUP}=0$. Kept.\n- Read $4$: $C, MQ=29, Q=38, \\mathrm{DUP}=0$. Discarded ($MQ < 30$).\n- Read $5$: $T, MQ=36, Q=28, \\mathrm{DUP}=0$. Discarded ($Q < 30$).\n- Read $6$: $C, MQ=60, Q=40, \\mathrm{DUP}=1$. Discarded ($\\mathrm{DUP} = 1$).\n- Read $7$: $C, MQ=60, Q=40, \\mathrm{DUP}=0$. Kept.\n- Read $8$: $T, MQ=31, Q=31, \\mathrm{DUP}=0$. Kept.\n- Read $9$: $T, MQ=34, Q=30, \\mathrm{DUP}=0$. Kept.\n- Read $10$: $C, MQ=35, Q=30, \\mathrm{DUP}=0$. Kept.\n- Read $11$: $T, MQ=50, Q=39, \\mathrm{DUP}=0$. Kept.\n- Read $12$: $C, MQ=33, Q=29, \\mathrm{DUP}=0$. Discarded ($Q < 30$).\n- Read $13$: $C, MQ=32, Q=35, \\mathrm{DUP}=0$. Kept.\n- Read $14$: $T, MQ=45, Q=35, \\mathrm{DUP}=1$. Discarded ($\\mathrm{DUP} = 1$).\n- Read $15$: $C, MQ=42, Q=31, \\mathrm{DUP}=0$. Kept.\n- Read $16$: $T, MQ=55, Q=37, \\mathrm{DUP}=0$. Kept.\n- Read $17$: $C, MQ=47, Q=30, \\mathrm{DUP}=0$. Kept.\n- Read $18$: $T, MQ=30, Q=30, \\mathrm{DUP}=0$. Kept.\n- Read $19$: $C, MQ=44, Q=34, \\mathrm{DUP}=0$. Kept.\n- Read $20$: $T, MQ=39, Q=31, \\mathrm{DUP}=0$. Kept.\n\nAfter filtering, the number of retained reads is $n=15$. The count of observed cytosines ($C$) is $c=8$. The count of observed thymines ($T$) is $t=7$. The sum is $c+t = 8+7=15=n$, as expected. The empirical fraction of observed $C$ bases is $\\hat{p} = \\frac{c}{n} = \\frac{8}{15}$.\n\nSecond, we derive the probability of observing a $C$ at this site in a given retained read, denoted $P(\\text{obs}=C)$. This probability is a function of the true methylation fraction $m \\in [0,1]$, the bisulfite non-conversion rate $r$, and the base-calling error rate $e$. Let a DNA molecule be methylated with probability $m$ and unmethylated with probability $1-m$.\n\nThe observation of a $C$ can arise from two mutually exclusive scenarios based on the true state of the DNA molecule:\n1.  The original cytosine is methylated (probability $m$). It is not affected by bisulfite treatment and remains a $C$. It is then sequenced correctly as a $C$. The probability of a correct base call is $1-e$. The total probability for this path is $P(\\text{obs}=C \\text{ and methylated}) = m \\times 1 \\times (1-e) = m(1-e)$.\n\n2.  The original cytosine is unmethylated (probability $1-m$). Two sub-paths can lead to observing a $C$:\n    a. Bisulfite non-conversion: The unmethylated $C$ fails to convert to uracil (probability $r$). It remains a $C$ and is then correctly sequenced as a $C$ (probability $1-e$). The probability for this sub-path is $(1-m) \\times r \\times (1-e)$.\n    b. Conversion and sequencing error: The unmethylated $C$ correctly converts to uracil (which is read as $T$) (probability $1-r$). This $T$ is then incorrectly sequenced as a $C$ due to a base-calling error (probability $e$). The probability for this sub-path is $(1-m) \\times (1-r) \\times e$.\n\nThe total probability of observing a $C$ is the sum of the probabilities of these disjoint paths:\n$$ P(\\text{obs}=C) = m(1-e) + (1-m)r(1-e) + (1-m)(1-r)e $$\nThis expression can be rearranged to show its linear dependence on $m$:\n$$ P(\\text{obs}=C) = m(1-e) + (1-m)[r(1-e) + e(1-r)] $$\n$$ P(\\text{obs}=C) = m(1-e) + (1-m)(r - re + e - re) $$\n$$ P(\\text{obs}=C) = m(1-e) + (1-m)(r + e - 2re) $$\nGrouping terms by $m$:\n$$ P(\\text{obs}=C) = m(1-e) - m(r+e-2re) + (r+e-2re) $$\n$$ P(\\text{obs}=C) = m[(1-e) - (r+e-2re)] + (r+e-2re) $$\n$$ P(\\text{obs}=C) = m[1 - 2e - r + 2re] + (r+e-2re) $$\nFactoring the coefficient of $m$ gives $(1-r)(1-2e)$. Thus, the linear function is:\n$$ P(\\text{obs}=C) = m(1-r)(1-2e) + (r+e-2re) $$\n\nThird, we derive the estimator $\\hat{m}$ for $m$. The method of moments equates the empirical sample moment with the corresponding theoretical population moment. Here, we equate the sample proportion of observed $C$s, $\\hat{p} = c/n$, to the theoretical probability $P(\\text{obs}=C)$:\n$$ \\hat{p} = \\hat{m}(1-r)(1-2e) + (r+e-2re) $$\nSolving for the estimator $\\hat{m}$:\n$$ \\hat{p} - (r+e-2re) = \\hat{m}(1-r)(1-2e) $$\n$$ \\hat{m} = \\frac{\\hat{p} - (r+e-2re)}{(1-r)(1-2e)} $$\nThis is the closed-form estimator for the methylation fraction $m$.\n\nFourth, we evaluate $\\hat{m}$ numerically. The given parameters are the non-conversion rate $r = 0.01$ and the base-calling error probability $e$, which is derived from the minimum quality threshold $Q_{\\min}=30$:\n$$ e = 10^{-Q_{\\min}/10} = 10^{-30/10} = 10^{-3} = 0.001 $$\nWe have the empirical fraction $\\hat{p} = 8/15$.\nThe term $r+e-2re$ is computed as:\n$$ r+e-2re = 0.01 + 0.001 - 2(0.01)(0.001) = 0.011 - 0.00002 = 0.01098 $$\nThe denominator term $(1-r)(1-2e)$ is:\n$$ (1-r)(1-2e) = (1-0.01)(1-2 \\times 0.001) = (0.99)(1-0.002) = (0.99)(0.998) = 0.98802 $$\nSubstituting these values into the estimator for $\\hat{m}$:\n$$ \\hat{m} = \\frac{\\frac{8}{15} - 0.01098}{0.98802} $$\n$$ \\hat{m} = \\frac{0.53333... - 0.01098}{0.98802} = \\frac{0.522353...}{0.98802} \\approx 0.528687 $$\nRounding to four significant figures, the estimated methylation level is $\\hat{m} \\approx 0.5287$.\n\nFifth, we briefly justify the data filtering steps.\n- **Mapping Quality ($MQ$) Filter**: This filter removes reads that may not originate from the genomic locus of interest. Including such reads could introduce significant bias, as their methylation state is unrelated to the target CpG site. For instance, if a mis-mapped read comes from an unmethylated paralogous region, it would contribute a $T$ observation, artificially deflating the methylation estimate. Removing low-$MQ$ reads reduces this source of bias.\n- **Base Quality ($Q$) Filter**: This filter removes base calls that have a high probability of being erroneous. Including low-quality bases would increase the noise in the counts of $C$ and $T$, leading to higher variance in the final estimate $\\hat{m}$. Furthermore, the derivation assumes a single, low error rate $e$. Including reads with much higher error probabilities would violate this model assumption and could introduce bias. Filtering for high $Q$ ensures that the error model is a reasonable approximation and improves the precision of the estimate.\n- **Duplicate Read Removal**: PCR duplicates are multiple reads originating from the amplification of a single DNA fragment. Including them would violate the assumption of independent observations. It would effectively over-count the evidence from one original molecule, leading to an artificially low variance estimate and potential for severe bias. If the single over-amplified fragment is methylated, the estimate would be biased upwards; if unmethylated, biased downwards. Removing duplicates ensures each retained read is an independent draw from the population of molecules, yielding a more accurate and unbiased estimate of $m$.", "answer": "$$\\boxed{0.5287}$$", "id": "4544197"}, {"introduction": "While calculating a simple fraction of methylated reads provides a useful summary, a more powerful approach is to model the evidence for methylation probabilistically. This advanced exercise guides you through the construction of a Bayesian inference model, a sophisticated method that rigorously integrates prior biological knowledge with the specific evidence from each individual sequencing read. By completing this practice, you will learn to calculate the posterior probability of methylation for a given site, a nuanced metric that accounts for uncertainties such as sequencing errors and incomplete bisulfite conversion [@problem_id:4544155].", "problem": "A single-end Whole-Genome Bisulfite Sequencing (WGBS) read has been aligned to a cytosine-to-thymine converted reference on the forward strand. In bisulfite chemistry, unmethylated cytosine is deaminated to uracil and is read as thymine after polymerase extension, whereas methylated cytosine is protected and remains cytosine. Assume a bisulfite conversion efficiency of $e = 0.99$ for unmethylated cytosines and zero conversion for methylated cytosines. Sequencing errors are modeled independently per base with Phred-scaled quality score $Q$, where the error probability is $p_{\\text{err}} = 10^{-Q/10}$, and conditional on an error the substituted base is equally likely among the other three nucleotides.\n\nYou are given the forward-strand converted reference substring spanning genomic positions $3$ through $14$ (inclusive):\nTTGTTTATGTGT\n\nThe alignment of a length-$12$ read to this substring is positionally exact (no indels), with the following read bases and Phred quality scores (index $1$ corresponds to genomic position $3$, index $12$ to genomic position $14$):\n- Read bases: TCGTTCATGTGT\n- Quality scores $Q_{1..12}$: $[35, 30, 40, 25, 32, 28, 37, 33, 39, 20, 36, 30]$\n\nYou are provided a binary mask indicating which positions in the converted reference originate from cytosines in the unconverted genome (that is, positions where the converted reference shows T due to conversion of genomic C). Within the substring above (genomic positions $3$ to $14$), the cytosine-origin positions are indices $\\{1, 2, 4, 6, 10\\}$, corresponding to genomic positions $\\{3, 4, 6, 8, 12\\}$. For these cytosine-origin positions, you are also given their context classification: genomic positions $4$ and $12$ are Cytosine-phosphate-Guanine (CpG), and genomic positions $3$, $6$, and $8$ are C followed by a non-guanine base (CH).\n\nUse a Bayesian model to call methylation states at the covered cytosine-origin positions. Let $M$ denote the event that a cytosine is methylated and $U$ denote unmethylated. Use the following priors:\n- CpG prior methylation probability $P(M \\mid \\text{CpG}) = 0.7$,\n- CH prior methylation probability $P(M \\mid \\text{CH}) = 0.1$.\n\nFrom first principles, derive the per-site posterior probabilities $P(M \\mid b_i)$ for each covered cytosine-origin position $i$, given its observed base $b_i$ and quality $Q_i$. Then:\n1. Reconstruct the original genomic sequence for the region by reverting each cytosine-origin position in the converted reference back to cytosine while leaving all other positions unchanged.\n2. Compute the expected methylation fraction across the covered cytosine-origin positions as the mean of the per-site posterior methylation probabilities:\n$$\\bar{f} = \\frac{1}{N}\\sum_{i \\in \\{\\text{cytosine-origin indices}\\}} P(M \\mid b_i),$$\nwhere $N$ is the number of covered cytosine-origin positions.\n\nExpress the final expected methylation fraction $\\bar{f}$ as a decimal without a percentage sign, and round your answer to four significant figures. No units are required.", "solution": "The problem is scientifically grounded, well-posed, and contains all necessary information for a unique solution. It is therefore deemed valid. The solution proceeds by first reconstructing the original genomic sequence and then applying a Bayesian model to determine the expected methylation fraction across the specified cytosine-origin sites.\n\nThe given parameters for the model are:\n- Bisulfite conversion efficiency for unmethylated cytosine: $e = 0.99$.\n- Probability of sequencing error for a base with Phred quality score $Q$: $p_{\\text{err}} = 10^{-Q/10}$.\n- Conditional on an error, substitution to any of the other three bases is equiprobable.\n- Prior methylation probability for CpG context: $P(M \\mid \\text{CpG}) = 0.7$.\n- Prior methylation probability for CH context: $P(M \\mid \\text{CH}) = 0.1$.\n\nThe data for the 12-base-pair region (genomic positions $3$ to $14$) are:\n- Converted reference sequence: `TTGTTTATGTGT`\n- Read bases ($b_i$): `TCGTTCATGTGT`\n- Quality scores ($Q_i$): $[35, 30, 40, 25, 32, 28, 37, 33, 39, 20, 36, 30]$\n- Cytosine-origin indices (1-based, within the substring): $\\{1, 2, 4, 6, 10\\}$.\n- Contexts for these cytosine-origin sites:\n    - CpG: indices $2$ and $10$.\n    - CH: indices $1, 4, 6$.\n\n### Part 1: Reconstruct the Original Genomic Sequence\n\nThe converted reference `TTGTTTATGTGT` shows a thymine (`T`) at positions where the original genomic sequence had an unmethylated cytosine (`C`) that was successfully converted. The problem states that indices $\\{1, 2, 4, 6, 10\\}$ are cytosine-origin positions. In the provided converted reference, all these positions are `T`. To reconstruct the original genomic sequence, we revert these `T`s back to `C`s.\n\n- Converted Reference: `T T G T T T A T G T G T`\n- 1-based index:      `1 2 3 4 5 6 7 8 9 10 11 12`\n- C-origin sites (marked with `*`): `* *   *   *     *`\n\nReverting the bases at indices $1, 2, 4, 6, 10$:\n- Index $1$: `T` $\\rightarrow$ `C`\n- Index $2$: `T` $\\rightarrow$ `C`\n- Index $4$: `T` $\\rightarrow$ `C`\n- Index $6$: `T` $\\rightarrow$ `C`\n- Index $10$: `T` $\\rightarrow$ `C`\n\nThe resulting original genomic sequence for this region is `CCGCTCATGCGT`.\n\n### Part 2: Compute the Expected Methylation Fraction\n\nWe compute the expected methylation fraction $\\bar{f}$ as the mean of the per-site posterior methylation probabilities $P(M \\mid b_i)$ for the $N=5$ cytosine-origin sites.\n$$ \\bar{f} = \\frac{1}{N}\\sum_{i \\in \\{1, 2, 4, 6, 10\\}} P(M \\mid b_i) $$\nFor each site $i$, we use Bayes' theorem to find the posterior probability of methylation ($M$) given the observed base $b_i$ and its quality score $Q_i$:\n$$ P(M \\mid b_i, Q_i) = \\frac{P(b_i \\mid M, Q_i) P(M)}{P(b_i \\mid Q_i)} $$\nThe denominator, or marginal likelihood, is the sum over all possible states (methylated, $M$, and unmethylated, $U$):\n$$ P(b_i \\mid Q_i) = P(b_i \\mid M, Q_i) P(M) + P(b_i \\mid U, Q_i) P(U) $$\nThe prior for unmethylation is $P(U) = 1 - P(M)$. The per-site error probability is $p_{\\text{err},i} = 10^{-Q_i/10}$.\n\nThe likelihood functions $P(b_i \\mid \\text{State}, Q_i)$ depend on the true underlying state of the cytosine.\n\n**Likelihood given Methylation ($M$):**\nIf a cytosine is methylated, it is not converted. The base to be sequenced is `C`.\n- If the observed base is `C` ($b_i = \\text{'C'}$), the sequencer reads correctly.\n  $$ P(b_i=\\text{'C'} \\mid M, Q_i) = 1 - p_{\\text{err},i} $$\n- If the observed base is not `C` ($b_i \\in \\{\\text{'A', 'T', 'G'}\\}$), it is a sequencing error.\n  $$ P(b_i \\neq \\text{'C'} \\mid M, Q_i) = \\frac{p_{\\text{err},i}}{3} $$\n\n**Likelihood given Unmethylation ($U$):**\nIf a cytosine is unmethylated, it is converted to uracil (`U`), which is read as thymine (`T`), with probability $e=0.99$. It fails to convert and remains `C` with probability $1-e=0.01$. This is a mixture model where the true base to be sequenced is `T` with probability $e$ and `C` with probability $1-e$.\nLet $L(b_i | \\text{true}, Q_i)$ be the probability of observing $b_i$ given a true base.\n$$ P(b_i \\mid U, Q_i) = e \\cdot L(b_i \\mid \\text{true='T'}, Q_i) + (1-e) \\cdot L(b_i \\mid \\text{true='C'}, Q_i) $$\n- If the observed base is `C` ($b_i = \\text{'C'}$):\n  $$ P(b_i=\\text{'C'} \\mid U, Q_i) = e \\cdot \\frac{p_{\\text{err},i}}{3} + (1-e) \\cdot (1 - p_{\\text{err},i}) $$\n- If the observed base is `T` ($b_i = \\text{'T'}$):\n  $$ P(b_i=\\text{'T'} \\mid U, Q_i) = e \\cdot (1 - p_{\\text{err},i}) + (1-e) \\cdot \\frac{p_{\\text{err},i}}{3} $$\n- If the observed base is `A` or `G` ($b_i \\in \\{\\text{'A', 'G'}\\}$):\n  $$ P(b_i \\in \\{\\text{'A', 'G'}\\} \\mid U, Q_i) = e \\cdot \\frac{p_{\\text{err},i}}{3} + (1-e) \\cdot \\frac{p_{\\text{err},i}}{3} = \\frac{p_{\\text{err},i}}{3} $$\n\nNow, we calculate $P(M \\mid b_i)$ for each of the $N=5$ cytosine-origin sites.\n\n**Site 1 (Index 1):**\n- Context: CH, $P(M)=0.1$, $P(U)=0.9$.\n- Data: $b_1=\\text{'T'}$, $Q_1=35$. $p_{\\text{err},1} = 10^{-3.5}$.\n- Likelihoods:\n  $L_M = P(b_1=\\text{'T'} \\mid M) = \\frac{p_{\\text{err},1}}{3} = \\frac{10^{-3.5}}{3}$.\n  $L_U = P(b_1=\\text{'T'} \\mid U) = 0.99(1-10^{-3.5}) + 0.01(\\frac{10^{-3.5}}{3})$.\n- Posterior:\n  $P(M \\mid b_1) = \\frac{L_M \\cdot 0.1}{L_M \\cdot 0.1 + L_U \\cdot 0.9} \\approx \\frac{(\\frac{3.162 \\times 10^{-4}}{3}) \\cdot 0.1}{(...) \\cdot 0.1 + (0.99(0.99968) + 0.01(\\frac{3.162 \\times 10^{-4}}{3})) \\cdot 0.9} \\approx \\frac{1.054 \\times 10^{-5}}{1.054 \\times 10^{-5} + 0.8907} \\approx 1.1832 \\times 10^{-5}$.\n\n**Site 2 (Index 2):**\n- Context: CpG, $P(M)=0.7$, $P(U)=0.3$.\n- Data: $b_2=\\text{'C'}$, $Q_2=30$. $p_{\\text{err},2} = 10^{-3}$.\n- Likelihoods:\n  $L_M = P(b_2=\\text{'C'} \\mid M) = 1-10^{-3} = 0.999$.\n  $L_U = P(b_2=\\text{'C'} \\mid U) = 0.99(\\frac{10^{-3}}{3}) + 0.01(1-10^{-3}) = 0.00033 + 0.00999 = 0.01032$.\n- Posterior:\n  $P(M \\mid b_2) = \\frac{0.999 \\cdot 0.7}{0.999 \\cdot 0.7 + 0.01032 \\cdot 0.3} = \\frac{0.6993}{0.6993 + 0.003096} = \\frac{0.6993}{0.702396} \\approx 0.995593$.\n\n**Site 3 (Index 4):**\n- Context: CH, $P(M)=0.1$, $P(U)=0.9$.\n- Data: $b_4=\\text{'T'}$, $Q_4=25$. $p_{\\text{err},4} = 10^{-2.5}$.\n- Likelihoods:\n  $L_M = P(b_4=\\text{'T'} \\mid M) = \\frac{10^{-2.5}}{3}$.\n  $L_U = P(b_4=\\text{'T'} \\mid U) = 0.99(1-10^{-2.5}) + 0.01(\\frac{10^{-2.5}}{3})$.\n- Posterior:\n  $P(M \\mid b_4) = \\frac{L_M \\cdot 0.1}{L_M \\cdot 0.1 + L_U \\cdot 0.9} \\approx \\frac{(\\frac{3.162 \\times 10^{-3}}{3}) \\cdot 0.1}{(...) \\cdot 0.1 + (0.99(0.9968) + 0.01(\\frac{3.162 \\times 10^{-3}}{3})) \\cdot 0.9} \\approx \\frac{1.054 \\times 10^{-4}}{1.054 \\times 10^{-4} + 0.8882} \\approx 1.1866 \\times 10^{-4}$.\n\n**Site 4 (Index 6):**\n- Context: CH, $P(M)=0.1$, $P(U)=0.9$.\n- Data: $b_6=\\text{'C'}$, $Q_6=28$. $p_{\\text{err},6} = 10^{-2.8}$.\n- Likelihoods:\n  $L_M = P(b_6=\\text{'C'} \\mid M) = 1-10^{-2.8} \\approx 0.998415$.\n  $L_U = P(b_6=\\text{'C'} \\mid U) = 0.99(\\frac{10^{-2.8}}{3}) + 0.01(1-10^{-2.8}) \\approx 0.000523 + 0.009984 = 0.010507$.\n- Posterior:\n  $P(M \\mid b_6) = \\frac{0.998415 \\cdot 0.1}{0.998415 \\cdot 0.1 + 0.010507 \\cdot 0.9} = \\frac{0.0998415}{0.0998415 + 0.0094563} = \\frac{0.0998415}{0.1092978} \\approx 0.913480$.\n\n**Site 5 (Index 10):**\n- Context: CpG, $P(M)=0.7$, $P(U)=0.3$.\n- Data: $b_{10}=\\text{'T'}$, $Q_{10}=20$. $p_{\\text{err},10} = 10^{-2} = 0.01$.\n- Likelihoods:\n  $L_M = P(b_{10}=\\text{'T'} \\mid M) = \\frac{0.01}{3}$.\n  $L_U = P(b_{10}=\\text{'T'} \\mid U) = 0.99(1-0.01) + 0.01(\\frac{0.01}{3}) = 0.99(0.99) + \\frac{0.0001}{3} = 0.9801 + 3.\\overline{3} \\times 10^{-5} \\approx 0.980133$.\n- Posterior:\n  $P(M \\mid b_{10}) = \\frac{(\\frac{0.01}{3}) \\cdot 0.7}{(\\frac{0.01}{3}) \\cdot 0.7 + 0.980133 \\cdot 0.3} = \\frac{0.002\\overline{3}}{0.002\\overline{3} + 0.29404} = \\frac{0.002\\overline{3}}{0.29637\\overline{3}} \\approx 0.007873$.\n\nFinally, we compute the average of these five posterior probabilities:\n$$ \\bar{f} = \\frac{1}{5} \\left( P(M \\mid b_1) + P(M \\mid b_2) + P(M \\mid b_4) + P(M \\mid b_6) + P(M \\mid b_{10}) \\right) $$\n$$ \\bar{f} \\approx \\frac{1}{5} (1.1832 \\times 10^{-5} + 0.995593 + 1.1866 \\times 10^{-4} + 0.913480 + 0.007873) $$\n$$ \\bar{f} \\approx \\frac{1}{5} (0.000011832 + 0.995593 + 0.00011866 + 0.913480 + 0.007873) $$\n$$ \\bar{f} \\approx \\frac{1.917076}{5} \\approx 0.3834152 $$\nRounding the result to four significant figures gives $\\bar{f} = 0.3834$.", "answer": "$$ \\boxed{0.3834} $$", "id": "4544155"}]}