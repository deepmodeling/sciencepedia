{"hands_on_practices": [{"introduction": "This first exercise is the cornerstone of your practical training. You will start with raw time-to-event data from two hypothetical patient cohorts and manually perform the fundamental calculations for survival analysis. By constructing the Kaplan-Meier curves step-by-step and deriving the log-rank statistic from first principles, you will gain a deep, intuitive understanding of the mechanics that software packages automate [@problem_id:4576971].", "problem": "A clinical genomics study in advanced oncology seeks to compare overall survival between two molecular cohorts: a mutation-positive cohort and a wild-type cohort. Baseline is study entry at time $t=0$, and follow-up is in months. Under the assumption of non-informative right censoring, the survival function $S(t)$ is defined as $S(t) = \\Pr(T > t)$ for a nonnegative event time $T$. You are given individual observed times $t_i$ and right-censoring indicators $\\delta_i$ with $\\delta_i = 1$ indicating an event and $\\delta_i = 0$ indicating right censoring. The two cohorts are:\n\nMutation-positive cohort (group $\\mathcal{M}$), $8$ individuals:\n- $\\text{M1}: t_1 = 2, \\ \\delta_1 = 1$\n- $\\text{M2}: t_2 = 5, \\ \\delta_2 = 0$\n- $\\text{M3}: t_3 = 6, \\ \\delta_3 = 1$\n- $\\text{M4}: t_4 = 7, \\ \\delta_4 = 1$\n- $\\text{M5}: t_5 = 9, \\ \\delta_5 = 0$\n- $\\text{M6}: t_6 = 12, \\ \\delta_6 = 1$\n- $\\text{M7}: t_7 = 15, \\ \\delta_7 = 0$\n- $\\text{M8}: t_8 = 18, \\ \\delta_8 = 1$\n\nWild-type cohort (group $\\mathcal{W}$), $8$ individuals:\n- $\\text{W1}: t_1 = 3, \\ \\delta_1 = 1$\n- $\\text{W2}: t_2 = 4, \\ \\delta_2 = 1$\n- $\\text{W3}: t_3 = 8, \\ \\delta_3 = 0$\n- $\\text{W4}: t_4 = 10, \\ \\delta_4 = 1$\n- $\\text{W5}: t_5 = 11.5, \\ \\delta_5 = 0$\n- $\\text{W6}: t_6 = 14, \\ \\delta_6 = 1$\n- $\\text{W7}: t_7 = 17, \\ \\delta_7 = 0$\n- $\\text{W8}: t_8 = 20, \\ \\delta_8 = 1$\n\nTasks:\n- Using only foundational definitions of $S(t)$ and right-censoring, identify the distinct observed event times from the pooled cohorts and, at each such time $t_{(j)}$, construct the pooled risk set size $n_{j}$ (number at risk immediately prior to $t_{(j)}$), the event count $d_{j}$, and the group-specific risk set sizes $n_{\\mathcal{M},j}$ and $n_{\\mathcal{W},j}$ together with group-specific event indicators.\n- From first principles, step by step, derive the Kaplan–Meier (KM) estimators for both cohorts by multiplicative updates at the cohort-specific event times, explicitly showing the contribution of each event time.\n- Under the null hypothesis that the two cohorts share the same hazard function over time, use the finite-population sampling logic within each pooled risk set at each event time to construct the log-rank statistic comparing group $\\mathcal{M}$ versus group $\\mathcal{W}$.\n\nReport the final value of the log-rank chi-square statistic for the comparison $\\mathcal{M}$ versus $\\mathcal{W}$. Round your final numeric answer to four significant figures. Do not include any units in your final report.", "solution": "The problem is assessed to be **valid**. It presents a standard, well-posed problem in biostatistics, specifically in survival analysis. All necessary data for the two cohorts (mutation-positive and wild-type) are provided, including observed times and event/censoring indicators. The assumptions (non-informative right censoring) and definitions (survival function $S(t)$) are clearly stated. The tasks—constructing risk sets, deriving Kaplan-Meier estimators, and calculating the log-rank statistic—are standard procedures based on the provided data. The problem is scientifically grounded, self-contained, and objective, with no contradictions, ambiguities, or factual unsoundness.\n\nThe core of the analysis involves comparing the survival distributions of the two cohorts, group $\\mathcal{M}$ (mutation-positive) and group $\\mathcal{W}$ (wild-type), using the log-rank test. This test operates under the null hypothesis, $H_0$, that there is no difference in the survival (or hazard) functions between the two groups. The test statistic is constructed by summing the differences between the observed and expected number of events at each distinct event time over the course of the study.\n\nFirst, we must pool the data from both cohorts and identify all distinct event times, denoted as $t_{(j)}$, where $j=1, \\dots, k$. The censored observations are used to correctly determine the size of the risk set at each event time. The risk set at time $t_{(j)}$, denoted $n_j$, consists of all individuals who have not yet experienced an event and have not been censored prior to $t_{(j)}$.\n\nThe distinct event times in the pooled data are: $2, 3, 4, 6, 7, 10, 12, 14, 18, 20$.\nAt each of these $k=10$ event times, we tabulate the following quantities:\n- $t_{(j)}$: the $j$-th distinct event time.\n- $n_{\\mathcal{M},j}$ and $n_{\\mathcal{W},j}$: the number of individuals at risk in group $\\mathcal{M}$ and group $\\mathcal{W}$, respectively, immediately prior to $t_{(j)}$.\n- $n_j = n_{\\mathcal{M},j} + n_{\\mathcal{W},j}$: the total number of individuals at risk.\n- $d_{\\mathcal{M},j}$ and $d_{\\mathcal{W},j}$: the number of events observed in group $\\mathcal{M}$ and group $\\mathcal{W}$, respectively, at time $t_{(j)}$.\n- $d_j = d_{\\mathcal{M},j} + d_{\\mathcal{W},j}$: the total number of events at $t_{(j)}$.\n\nThe following table summarizes this information, which is derived by meticulously tracking subjects from $t=0$:\n| $j$ | $t_{(j)}$ | $n_{\\mathcal{M},j}$ | $n_{\\mathcal{W},j}$ | $n_j$ | $d_{\\mathcal{M},j}$ | $d_{\\mathcal{W},j}$ | $d_j$ |\n|---|---|---|---|---|---|---|---|\n| $1$ | $2$  | $8$ | $8$ | $16$ | $1$ | $0$ | $1$ |\n| $2$ | $3$  | $7$ | $8$ | $15$ | $0$ | $1$ | $1$ |\n| $3$ | $4$  | $7$ | $7$ | $14$ | $0$ | $1$ | $1$ |\n| $4$ | $6$  | $6$ | $6$ | $12$ | $1$ | $0$ | $1$ |\n| $5$ | $7$  | $5$ | $6$ | $11$ | $1$ | $0$ | $1$ |\n| $6$ | $10$ | $3$ | $5$ | $8$  | $0$ | $1$ | $1$ |\n| $7$ | $12$ | $3$ | $3$ | $6$  | $1$ | $0$ | $1$ |\n| $8$ | $14$ | $2$ | $3$ | $5$  | $0$ | $1$ | $1$ |\n| $9$ | $18$ | $1$ | $1$ | $2$  | $1$ | $0$ | $1$ |\n| $10$| $20$ | $0$ | $1$ | $1$  | $0$ | $1$ | $1$ |\n\nAs requested, we first derive the Kaplan-Meier (KM) estimators for both cohorts. The KM estimator for the survival function, $\\hat{S}(t)$, is the product-limit estimator: $\\hat{S}(t) = \\prod_{t_{(i)} \\le t} \\left(1 - \\frac{d_i}{n_i}\\right)$, calculated using cohort-specific event times, event counts, and risk sets.\n\nFor the mutation-positive cohort ($\\mathcal{M}$):\n- Event times: $2, 6, 7, 12, 18$.\n- $\\hat{S}_{\\mathcal{M}}(t) = 1$ for $t \\in [0, 2)$.\n- At $t=2$: $n_{\\mathcal{M}}=8, d_{\\mathcal{M}}=1$. $\\hat{S}_{\\mathcal{M}}(t) = 1 - \\frac{1}{8} = \\frac{7}{8}$ for $t \\in [2, 6)$.\n- At $t=6$: $n_{\\mathcal{M}}=6, d_{\\mathcal{M}}=1$. $\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{8} \\times (1 - \\frac{1}{6}) = \\frac{7}{8} \\times \\frac{5}{6} = \\frac{35}{48}$ for $t \\in [6, 7)$.\n- At $t=7$: $n_{\\mathcal{M}}=5, d_{\\mathcal{M}}=1$. $\\hat{S}_{\\mathcal{M}}(t) = \\frac{35}{48} \\times (1 - \\frac{1}{5}) = \\frac{35}{48} \\times \\frac{4}{5} = \\frac{7}{12}$ for $t \\in [7, 12)$.\n- At $t=12$: $n_{\\mathcal{M}}=3, d_{\\mathcal{M}}=1$. $\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{12} \\times (1 - \\frac{1}{3}) = \\frac{7}{12} \\times \\frac{2}{3} = \\frac{7}{18}$ for $t \\in [12, 18)$.\n- At $t=18$: $n_{\\mathcal{M}}=1, d_{\\mathcal{M}}=1$. $\\hat{S}_{\\mathcal{M}}(t) = \\frac{7}{18} \\times (1 - \\frac{1}{1}) = 0$ for $t \\ge 18$.\n\nFor the wild-type cohort ($\\mathcal{W}$):\n- Event times: $3, 4, 10, 14, 20$.\n- $\\hat{S}_{\\mathcal{W}}(t) = 1$ for $t \\in [0, 3)$.\n- At $t=3$: $n_{\\mathcal{W}}=8, d_{\\mathcal{W}}=1$. $\\hat{S}_{\\mathcal{W}}(t) = 1 - \\frac{1}{8} = \\frac{7}{8}$ for $t \\in [3, 4)$.\n- At $t=4$: $n_{\\mathcal{W}}=7, d_{\\mathcal{W}}=1$. $\\hat{S}_{\\mathcal{W}}(t) = \\frac{7}{8} \\times (1 - \\frac{1}{7}) = \\frac{3}{4}$ for $t \\in [4, 10)$.\n- At $t=10$: $n_{\\mathcal{W}}=5, d_{\\mathcal{W}}=1$. $\\hat{S}_{\\mathcal{W}}(t) = \\frac{3}{4} \\times (1 - \\frac{1}{5}) = \\frac{3}{5}$ for $t \\in [10, 14)$.\n- At $t=14$: $n_{\\mathcal{W}}=3, d_{\\mathcal{W}}=1$. $\\hat{S}_{\\mathcal{W}}(t) = \\frac{3}{5} \\times (1 - \\frac{1}{3}) = \\frac{2}{5}$ for $t \\in [14, 20)$.\n- At $t=20$: $n_{\\mathcal{W}}=1, d_{\\mathcal{W}}=1$. $\\hat{S}_{\\mathcal{W}}(t) = \\frac{2}{5} \\times (1 - \\frac{1}{1}) = 0$ for $t \\ge 20$.\n\nNow, we construct the log-rank statistic. For each event time $t_{(j)}$, we calculate the expected number of events in group $\\mathcal{M}$, $E_{\\mathcal{M},j}$, under the null hypothesis. This is given by the total number of events $d_j$ multiplied by the proportion of the risk set belonging to group $\\mathcal{M}$: $E_{\\mathcal{M},j} = d_j \\frac{n_{\\mathcal{M},j}}{n_j}$. The variance of the observed event count in group $\\mathcal{M}$, $d_{\\mathcal{M},j}$, is derived from the hypergeometric distribution: $V_j = \\frac{n_{\\mathcal{M},j} n_{\\mathcal{W},j} d_j (n_j - d_j)}{n_j^2 (n_j - 1)}$.\n\nThe log-rank statistic $\\chi^2$ is then computed as:\n$$ \\chi^2 = \\frac{(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2}{V} $$\nwhere $O_{\\mathcal{M}} = \\sum_{j=1}^{k} d_{\\mathcal{M},j}$, $E_{\\mathcal{M}} = \\sum_{j=1}^{k} E_{\\mathcal{M},j}$, and $V = \\sum_{j=1}^{k} V_j$.\n\nLet's compute the components:\nTotal observed events in group $\\mathcal{M}$: $O_{\\mathcal{M}} = 1+0+0+1+1+0+1+0+1+0 = 5$.\n\nTotal expected events in group $\\mathcal{M}$:\n$E_{\\mathcal{M}} = \\sum_{j=1}^{10} d_j \\frac{n_{\\mathcal{M},j}}{n_j} = 1(\\frac{8}{16}) + 1(\\frac{7}{15}) + 1(\\frac{7}{14}) + 1(\\frac{6}{12}) + 1(\\frac{5}{11}) + 1(\\frac{3}{8}) + 1(\\frac{3}{6}) + 1(\\frac{2}{5}) + 1(\\frac{1}{2}) + 1(\\frac{0}{1})$\n$E_{\\mathcal{M}} = \\frac{1}{2} + \\frac{7}{15} + \\frac{1}{2} + \\frac{1}{2} + \\frac{5}{11} + \\frac{3}{8} + \\frac{1}{2} + \\frac{2}{5} + \\frac{1}{2} + 0 = \\frac{5}{2} + \\frac{7}{15} + \\frac{5}{11} + \\frac{3}{8} + \\frac{2}{5} = \\frac{5539}{1320} \\approx 4.19621$\n\nTotal variance:\n$V = \\sum_{j=1}^{10} V_j = \\frac{8 \\cdot 8 \\cdot 1 \\cdot 15}{16^2(15)} + \\frac{7 \\cdot 8 \\cdot 1 \\cdot 14}{15^2(14)} + \\frac{7 \\cdot 7 \\cdot 1 \\cdot 13}{14^2(13)} + \\frac{6 \\cdot 6 \\cdot 1 \\cdot 11}{12^2(11)} + \\frac{5 \\cdot 6 \\cdot 1 \\cdot 10}{11^2(10)} + \\frac{3 \\cdot 5 \\cdot 1 \\cdot 7}{8^2(7)} + \\frac{3 \\cdot 3 \\cdot 1 \\cdot 5}{6^2(5)} + \\frac{2 \\cdot 3 \\cdot 1 \\cdot 4}{5^2(4)} + \\frac{1 \\cdot 1 \\cdot 1 \\cdot 1}{2^2(1)} + 0$\n$V = \\frac{64}{256} + \\frac{56}{225} + \\frac{49}{196} + \\frac{36}{144} + \\frac{30}{121} + \\frac{15}{64} + \\frac{9}{36} + \\frac{6}{25} + \\frac{1}{4}$\n$V = \\frac{1}{4} + \\frac{56}{225} + \\frac{1}{4} + \\frac{1}{4} + \\frac{30}{121} + \\frac{15}{64} + \\frac{1}{4} + \\frac{6}{25} + \\frac{1}{4} = \\frac{5}{4} + \\frac{56}{225} + \\frac{30}{121} + \\frac{15}{64} + \\frac{6}{25}$\nSumming these fractions gives $V = \\frac{3870215}{1742400} \\approx 2.22120$.\n\nNow, we calculate the $\\chi^2$ statistic:\n$O_{\\mathcal{M}} - E_{\\mathcal{M}} = 5 - \\frac{5539}{1320} = \\frac{6600 - 5539}{1320} = \\frac{1061}{1320}$\n$(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2 = \\left(\\frac{1061}{1320}\\right)^2 = \\frac{1125721}{1742400}$\n\n$\\chi^2 = \\frac{(O_{\\mathcal{M}} - E_{\\mathcal{M}})^2}{V} = \\frac{1125721/1742400}{3870215/1742400} = \\frac{1125721}{3870215} \\approx 0.290867$\n\nRounding the result to four significant figures gives $0.2909$.", "answer": "$$\n\\boxed{0.2909}\n$$", "id": "4576971"}, {"introduction": "Clinical and genomic studies often involve baseline factors that can influence survival outcomes, potentially confounding the comparison between treatment groups. This practice introduces the stratified log-rank test, a key technique for adjusting for such heterogeneity. Working with data already organized by transcriptomic stratum, you will learn to compute the overall test statistic by combining information across layers, a crucial skill for valid inference in complex study designs [@problem_id:4576961].", "problem": "An oncology study evaluates two therapies, labeled group $A$ (treatment) and group $B$ (control), for progression-free survival across $3$ transcriptomic strata defined by RNA sequencing. Within each stratum, consider the finite-population risk set immediately prior to each distinct event time and assume that at each listed time exactly $1$ event occurs (no tied failures at the listed times). You are given, for each stratum $s \\in \\{1,2,3\\}$ and ordered event time $t_{s,j}$, the pair of at-risk counts $(n_{A,sj}, n_{B,sj})$ just prior to $t_{s,j}$ and the group in which the event occurs.\n\nStratum $1$:\n- At $t_{1,1}$: risk set $(n_{A,11}, n_{B,11}) = (10, 12)$; the event occurs in group $A$.\n- At $t_{1,2}$: risk set $(n_{A,12}, n_{B,12}) = (9, 12)$; the event occurs in group $B$.\n- At $t_{1,3}$: risk set $(n_{A,13}, n_{B,13}) = (8, 10)$; the event occurs in group $A$.\n\nStratum $2$:\n- At $t_{2,1}$: risk set $(n_{A,21}, n_{B,21}) = (15, 15)$; the event occurs in group $B$.\n- At $t_{2,2}$: risk set $(n_{A,22}, n_{B,22}) = (14, 14)$; the event occurs in group $B$.\n- At $t_{2,3}$: risk set $(n_{A,23}, n_{B,23}) = (14, 13)$; the event occurs in group $A$.\n- At $t_{2,4}$: risk set $(n_{A,24}, n_{B,24}) = (13, 13)$; the event occurs in group $A$.\n\nStratum $3$:\n- At $t_{3,1}$: risk set $(n_{A,31}, n_{B,31}) = (6, 9)$; the event occurs in group $A$.\n- At $t_{3,2}$: risk set $(n_{A,32}, n_{B,32}) = (5, 9)$; the event occurs in group $B$.\n\nStarting only from the core definition that, under the null hypothesis $H_{0}$ of equal stratum-specific hazards for groups $A$ and $B$, the conditional probability that the single event at time $t_{s,j}$ arises from group $A$ equals the proportion of group $A$ in the risk set at that instant, and that the conditional variance follows the sampling-without-replacement logic for one draw from a finite risk set, do the following:\n\n- For each listed event time within each stratum, compute the observed-minus-expected increment for group $A$ and its conditional variance under $H_{0}$, conditioning on the risk set at that time.\n- Sum these increments and variances across all listed times and all strata to obtain a single grand total observed-minus-expected value and a single grand total variance.\n- Form the $1$ degree-of-freedom stratified log-rank chi-square statistic as the squared grand total observed-minus-expected divided by the grand total variance.\n\nReport the final chi-square value as a single real number, rounded to $4$ significant figures. No units are required.", "solution": "We are to compare two therapies across multiple strata using the stratified log-rank test. The foundational principles we use are:\n\n1. Under the null hypothesis $H_{0}$ of equal hazards within each stratum, the instantaneous probability that the event at a given failure time arises from a specific group equals that group’s fraction in the risk set just prior to that time. If the risk set at time $t_{s,j}$ has $n_{A,sj}$ in group $A$ and $n_{B,sj}$ in group $B$, then with exactly one event at that time, the conditional probability that the event is from group $A$ is\n$$\np_{s,j} \\equiv \\frac{n_{A,sj}}{n_{A,sj} + n_{B,sj}}.\n$$\n\n2. Conditioning on the risk set for one event at a time (no ties), the variance of the indicator that the event is in group $A$ is\n$$\n\\operatorname{Var}_{H_{0}}(I\\{\\text{event in }A\\}\\mid \\text{risk set}) \\;=\\; p_{s,j}\\bigl(1 - p_{s,j}\\bigr),\n$$\nbecause the finite population correction equals $1$ when exactly one unit is sampled without replacement.\n\nFor each event time, define the observed-minus-expected increment for group $A$ as\n$$\n\\Delta_{s,j} \\;=\\; I\\{\\text{event in }A\\} \\;-\\; p_{s,j},\n$$\nwith conditional variance $\\sigma^{2}_{s,j} = p_{s,j}\\bigl(1 - p_{s,j}\\bigr)$.\n\nWe will compute $\\Delta_{s,j}$ and $\\sigma^{2}_{s,j}$ at each listed event, then sum across all strata and events:\n$$\nU \\;=\\; \\sum_{s}\\sum_{j} \\Delta_{s,j}, \\qquad V \\;=\\; \\sum_{s}\\sum_{j} \\sigma^{2}_{s,j},\n$$\nand finally form the stratified log-rank chi-square statistic with one degree of freedom:\n$$\nX^{2} \\;=\\; \\frac{U^{2}}{V}.\n$$\n\nCompute contributions by stratum.\n\nStratum $1$:\n- $t_{1,1}$: $(n_{A}, n_{B}) = (10,12)$, so $p = \\frac{10}{22} = \\frac{5}{11}$. Event in $A$ gives $\\Delta_{1,1} = 1 - \\frac{5}{11} = \\frac{6}{11}$, and $\\sigma^{2}_{1,1} = \\frac{5}{11}\\cdot\\frac{6}{11} = \\frac{30}{121}$.\n- $t_{1,2}$: $(n_{A}, n_{B}) = (9,12)$, so $p = \\frac{9}{21} = \\frac{3}{7}$. Event in $B$ gives $\\Delta_{1,2} = 0 - \\frac{3}{7} = -\\frac{3}{7}$, and $\\sigma^{2}_{1,2} = \\frac{3}{7}\\cdot\\frac{4}{7} = \\frac{12}{49}$.\n- $t_{1,3}$: $(n_{A}, n_{B}) = (8,10)$, so $p = \\frac{8}{18} = \\frac{4}{9}$. Event in $A$ gives $\\Delta_{1,3} = 1 - \\frac{4}{9} = \\frac{5}{9}$, and $\\sigma^{2}_{1,3} = \\frac{4}{9}\\cdot\\frac{5}{9} = \\frac{20}{81}$.\n\nSumming for stratum $1$:\n$$\nU_{1} \\;=\\; \\frac{6}{11} \\;-\\; \\frac{3}{7} \\;+\\; \\frac{5}{9} \\;=\\; \\frac{466}{693},\n$$\n$$\nV_{1} \\;=\\; \\frac{30}{121} \\;+\\; \\frac{12}{49} \\;+\\; \\frac{20}{81} \\;=\\; \\frac{355262}{480249}.\n$$\n\nStratum $2$:\n- $t_{2,1}$: $(n_{A}, n_{B}) = (15,15)$, $p = \\frac{1}{2}$, event in $B$: $\\Delta_{2,1} = -\\frac{1}{2}$, $\\sigma^{2}_{2,1} = \\frac{1}{4}$.\n- $t_{2,2}$: $(n_{A}, n_{B}) = (14,14)$, $p = \\frac{1}{2}$, event in $B$: $\\Delta_{2,2} = -\\frac{1}{2}$, $\\sigma^{2}_{2,2} = \\frac{1}{4}$.\n- $t_{2,3}$: $(n_{A}, n_{B}) = (14,13)$, $p = \\frac{14}{27}$, event in $A$: $\\Delta_{2,3} = 1 - \\frac{14}{27} = \\frac{13}{27}$, $\\sigma^{2}_{2,3} = \\frac{14}{27}\\cdot\\frac{13}{27} = \\frac{182}{729}$.\n- $t_{2,4}$: $(n_{A}, n_{B}) = (13,13)$, $p = \\frac{1}{2}$, event in $A$: $\\Delta_{2,4} = \\frac{1}{2}$, $\\sigma^{2}_{2,4} = \\frac{1}{4}$.\n\nSumming for stratum $2$:\n$$\nU_{2} \\;=\\; -\\frac{1}{2} \\;-\\; \\frac{1}{2} \\;+\\; \\frac{13}{27} \\;+\\; \\frac{1}{2} \\;=\\; -\\frac{1}{2} \\;+\\; \\frac{13}{27} \\;=\\; -\\frac{1}{54},\n$$\n$$\nV_{2} \\;=\\; \\frac{1}{4} \\;+\\; \\frac{1}{4} \\;+\\; \\frac{182}{729} \\;+\\; \\frac{1}{4} \\;=\\; \\frac{3}{4} \\;+\\; \\frac{182}{729} \\;=\\; \\frac{2915}{2916}.\n$$\n\nStratum $3$:\n- $t_{3,1}$: $(n_{A}, n_{B}) = (6,9)$, $p = \\frac{6}{15} = \\frac{2}{5}$, event in $A$: $\\Delta_{3,1} = 1 - \\frac{2}{5} = \\frac{3}{5}$, $\\sigma^{2}_{3,1} = \\frac{2}{5}\\cdot\\frac{3}{5} = \\frac{6}{25}$.\n- $t_{3,2}$: $(n_{A}, n_{B}) = (5,9)$, $p = \\frac{5}{14}$, event in $B$: $\\Delta_{3,2} = -\\frac{5}{14}$, $\\sigma^{2}_{3,2} = \\frac{5}{14}\\cdot\\frac{9}{14} = \\frac{45}{196}$.\n\nSumming for stratum $3$:\n$$\nU_{3} \\;=\\; \\frac{3}{5} \\;-\\; \\frac{5}{14} \\;=\\; \\frac{17}{70},\n$$\n$$\nV_{3} \\;=\\; \\frac{6}{25} \\;+\\; \\frac{45}{196} \\;=\\; \\frac{2301}{4900}.\n$$\n\nAggregate across strata:\n$$\nU \\;=\\; U_{1} + U_{2} + U_{3} \\;=\\; \\frac{466}{693} \\;-\\; \\frac{1}{54} \\;+\\; \\frac{17}{70}.\n$$\nUsing the least common multiple denominator $20790$, we have\n$$\nU \\;=\\; \\frac{466\\cdot 30 \\;-\\; 1\\cdot 385 \\;+\\; 17\\cdot 297}{20790}\n\\;=\\; \\frac{13980 \\;-\\; 385 \\;+\\; 5049}{20790}\n\\;=\\; \\frac{18644}{20790}\n\\;=\\; \\frac{9322}{10395}.\n$$\nAlso,\n$$\nV \\;=\\; V_{1} + V_{2} + V_{3} \\;=\\; \\frac{355262}{480249} \\;+\\; \\frac{2915}{2916} \\;+\\; \\frac{2301}{4900}.\n$$\n\nThe stratified log-rank chi-square statistic with one degree of freedom is\n$$\nX^{2} \\;=\\; \\frac{U^{2}}{V}\n\\;=\\; \\frac{\\left(\\frac{9322}{10395}\\right)^{2}}{\\;\\frac{355262}{480249} + \\frac{2915}{2916} + \\frac{2301}{4900}\\;}\n\\;=\\; \\frac{\\frac{86899684}{108056025}}{\\;\\frac{355262}{480249} + \\frac{2915}{2916} + \\frac{2301}{4900}\\;}.\n$$\n\nFor the final numeric value (rounding only at the end), evaluate the numerator and denominator:\n- $U^{2} \\approx 0.804209485$.\n- $V \\approx 0.7397454237281077 \\;+\\; 0.9996570644718793 \\;+\\; 0.4695918367346939 \\;=\\; 2.2089943249346809$.\n\nHence,\n$$\nX^{2} \\;\\approx\\; \\frac{0.804209485}{2.2089943249346809} \\;\\approx\\; 0.364061363.\n$$\n\nRounded to $4$ significant figures, the stratified log-rank chi-square statistic is $0.3641$.", "answer": "$$\\boxed{0.3641}$$", "id": "4576961"}, {"introduction": "Real-world survival data frequently includes complexities like left-truncation, where subjects enter a study after time zero. This advanced coding exercise challenges you to correctly implement the Kaplan-Meier estimator and log-rank test by properly defining the risk set to account for delayed entry. By comparing your results to a naive analysis that ignores truncation, you will directly observe the potential for significant bias and appreciate the importance of handling data structures accurately [@problem_id:4576983].", "problem": "A randomized oncology cohort study includes patients who are enrolled at different calendar times relative to the start of observation, creating left truncation (also called delayed entry). Let $T_i$ denote the failure time for subject $i$, $C_i$ denote the right censoring time, and $L_i$ denote the left truncation (entry) time when the subject first becomes observable and eligible to contribute to the risk set. The observed time is $X_i = \\min(T_i, C_i)$, with event indicator $\\Delta_i = \\mathbf{1}\\{T_i \\le C_i\\}$. Subjects belong to one of two treatment groups indicated by $G_i \\in \\{0,1\\}$. For a time $t$, the at-risk set must reflect left truncation: a subject is at risk at time $t$ if and only if $L_i \\le t \\le X_i$. The survival function is defined by $S(t) = \\mathbb{P}(T > t)$.\n\nImplement Kaplan–Meier estimation with left truncation by constructing the risk set at each distinct event time $t_j$ from the definition above, and form the estimator of $S(t)$ as a product over event times not exceeding $t$. Then implement the log-rank test between the two groups with left truncation by forming, at each event time $t_j$, the observed events in group $0$ and the expected number under the null hypothesis proportional to the risk set size in group $0$, and aggregating the standardized difference across all event times. Also implement a \"naive\" analysis that ignores left truncation by setting all $L_i = 0$ and re-computing Kaplan–Meier and log-rank analyses. The null distribution for the log-rank statistic is the standard normal distribution via large-sample approximation.\n\nYour program must compute, for each test case below:\n- The maximum absolute difference between the Kaplan–Meier survival estimates computed with left truncation and the naive analysis across a supplied evaluation grid of times.\n- The two-sided log-rank $p$-value computed with left truncation.\n- The two-sided log-rank $p$-value computed by the naive analysis.\n\nAll time values are abstract time units with no physical unit. Angles are not involved. Percentages, if any arise, must be expressed as decimals.\n\nUse the following test suite. Each case supplies vectors of entry times $L$, observed times $X$, event indicators $\\Delta$, group labels $G$, and evaluation times $\\mathcal{T}_{\\mathrm{eval}}$. The vectors are aligned by index.\n\nCase $\\mathrm{A}$ (general delayed entry, mixed events and censoring):\n- $L = [\\,0.0,\\,1.0,\\,2.0,\\,0.5,\\,3.0,\\,0.0,\\,2.0,\\,1.5,\\,4.0,\\,0.0,\\,5.0,\\,3.0\\,]$\n- $X = [\\,5.0,\\,6.0,\\,7.5,\\,4.0,\\,9.0,\\,3.5,\\,8.0,\\,6.2,\\,9.5,\\,2.0,\\,7.0,\\,6.0\\,]$\n- $\\Delta = [\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,0\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,4.0,\\,6.0,\\,8.0\\,]$\n\nCase $\\mathrm{B}$ (no truncation; all entries at time zero):\n- $L = [\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0,\\,0.0\\,]$\n- $X = [\\,5.0,\\,7.0,\\,4.0,\\,10.0,\\,3.0,\\,6.0,\\,8.0,\\,5.0,\\,9.0,\\,2.0\\,]$\n- $\\Delta = [\\,1,\\,0,\\,1,\\,0,\\,1,\\,1,\\,0,\\,0,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,5.0,\\,7.0,\\,9.0\\,]$\n\nCase $\\mathrm{C}$ (heavy truncation; many late entries):\n- $L = [\\,3.0,\\,4.0,\\,5.0,\\,6.0,\\,2.5,\\,4.5,\\,5.5,\\,7.0,\\,8.0,\\,3.5,\\,6.5,\\,1.0\\,]$\n- $X = [\\,3.5,\\,6.0,\\,9.0,\\,7.5,\\,3.0,\\,7.0,\\,8.0,\\,9.5,\\,10.0,\\,5.0,\\,7.2,\\,2.0\\,]$\n- $\\Delta = [\\,1,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,0,\\,0,\\,1,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1,\\,0,\\,0,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,2.0,\\,4.0,\\,6.0,\\,8.0\\,]$\n\nCase $\\mathrm{D}$ (tied event times across groups with concurrent censoring):\n- $L = [\\,0.0,\\,1.0,\\,2.0,\\,2.5,\\,0.0,\\,1.5,\\,2.0,\\,3.0\\,]$\n- $X = [\\,3.0,\\,3.0,\\,5.0,\\,7.0,\\,3.0,\\,3.0,\\,7.0,\\,7.0\\,]$\n- $\\Delta = [\\,1,\\,1,\\,0,\\,1,\\,1,\\,0,\\,1,\\,1\\,]$\n- $G = [\\,0,\\,0,\\,0,\\,0,\\,1,\\,1,\\,1,\\,1\\,]$\n- $\\mathcal{T}_{\\mathrm{eval}} = [\\,3.0,\\,7.0\\,]$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case contributes a list of three floats in the order described above. For example, the final output format must be\n$[\\,[d_{\\mathrm{A}},p_{\\mathrm{A}}^{\\mathrm{left}},p_{\\mathrm{A}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{B}},p_{\\mathrm{B}}^{\\mathrm{left}},p_{\\mathrm{B}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{C}},p_{\\mathrm{C}}^{\\mathrm{left}},p_{\\mathrm{C}}^{\\mathrm{naive}}],\\,[d_{\\mathrm{D}},p_{\\mathrm{D}}^{\\mathrm{left}},p_{\\mathrm{D}}^{\\mathrm{naive}}]\\,]$ where each $d_{\\cdot}$ is the maximum absolute difference in Kaplan–Meier survival across the supplied evaluation times for that case, and each $p_{\\cdot}^{\\mathrm{left}}$ or $p_{\\cdot}^{\\mathrm{naive}}$ is the corresponding two-sided log-rank $p$-value.", "solution": "The user requests the implementation and comparison of two survival analysis methodologies: one correctly accounting for left-truncated (delayed entry) data, and a \"naive\" one that ignores it. The specific tasks are to compute the Kaplan-Meier (KM) survival curves and perform the log-rank test for both scenarios. For each provided test case, three values must be calculated: the maximum absolute difference between the two KM estimates over a grid of evaluation times, and the two-sided p-values from both the correct and naive log-rank tests.\n\n### Principle-Based Design\n\nThe solution will be structured around two core statistical methods, adapted for left-truncated data.\n\n#### 1. Kaplan-Meier Estimator with Left Truncation\n\nThe survival function $S(t) = \\mathbb{P}(T > t)$ is estimated using the Kaplan-Meier product-limit formula. For data with left truncation, the formula remains the same, but the definition of the risk set is modified.\n\nLet $\\tau_1 < \\tau_2 < \\dots < \\tau_K$ be the distinct event times observed in the data. The Kaplan-Meier estimator is given by:\n$$ \\hat{S}(t) = \\prod_{j: \\tau_j \\le t} \\left(1 - \\frac{d_j}{n_j}\\right) $$\n- $\\tau_j$: The $j$-th distinct event time.\n- $d_j$: The number of subjects experiencing an event at time $\\tau_j$. Mathematically, $d_j = |\\{i: X_i = \\tau_j, \\Delta_i = 1\\}|$.\n- $n_j$: The number of subjects in the risk set at time $\\tau_j$. With left truncation, a subject $i$ is at risk at time $t$ if they have entered the study ($L_i \\le t$) and have not yet experienced an event or been censored ($X_i \\ge t$). Thus, the risk set size is $n_j = |\\{i: L_i \\le \\tau_j \\le X_i\\}|$.\n\nFor the \"naive\" analysis, left truncation is ignored by setting all entry times $L_i$ to $0$. The risk set definition then simplifies to the standard form for right-censored data: $n_j^{\\text{naive}} = |\\{i: X_i \\ge \\tau_j\\}|$.\n\nThe implementation will first identify all unique event times. Then, for each evaluation time $t \\in \\mathcal{T}_{\\mathrm{eval}}$, it will compute the product of survival factors $(1 - d_j/n_j)$ for all event times $\\tau_j \\le t$.\n\n#### 2. Log-Rank Test with Left Truncation\n\nThe log-rank test is a non-parametric hypothesis test for comparing the survival distributions of two or more groups. For two groups ($G=0$ and $G=1$), the null hypothesis is $H_0: S_0(t) = S_1(t)$.\n\nThe test statistic is constructed by summing the differences between the observed and expected number of events in one group (e.g., group $0$) over all distinct event times $\\tau_j$.\n\nAt each event time $\\tau_j$:\n- Let $d_j$ be the total number of events, and $n_j$ be the total number of subjects at risk, both computed as defined above (respecting left truncation).\n- Let $d_{0j}$ and $n_{0j}$ be the number of events and number at risk in group $0$, respectively.\n- Under $H_0$, the number of events is expected to be distributed proportionally to the sizes of the risk sets. The expected number of events in group $0$ at $\\tau_j$ is $E_{0j} = d_j \\frac{n_{0j}}{n_j}$.\n\nThe log-rank statistic $Z$ is constructed as:\n$$ Z = \\frac{U}{\\sqrt{V}} = \\frac{\\sum_j (d_{0j} - E_{0j})}{\\sqrt{\\sum_j V_j}} $$\n- $U = \\sum_j (d_{0j} - E_{0j})$ is the sum of observed minus expected events.\n- $V = \\sum_j V_j$ is the sum of the variances of each term. The variance $V_j$ of $d_{0j}$ follows from the hypergeometric distribution, given by:\n$$ V_j = \\frac{n_{0j} n_{1j} d_j (n_j - d_j)}{n_j^2 (n_j - 1)} $$\nwhere $n_{1j} = n_j - n_{0j}$ is the number at risk in group 1. This formula is valid for $n_j > 1$. If $n_j \\le 1$, the variance contribution is $0$.\n\nUnder the null hypothesis, $Z$ follows a standard normal distribution $\\mathcal{N}(0,1)$ for large sample sizes. The two-sided p-value is obtained as $2 \\times \\mathbb{P}(N(0,1) > |Z|)$.\n\nThe naive log-rank test is performed by setting all $L_i = 0$ before computing all quantities ($n_j, n_{0j}$, etc.).\n\n### Implementation Strategy\n\nTwo helper functions will be created: `kaplan_meier_estimator` and `log_rank_test`. Both will accept the data arrays $L, X, \\Delta$ (and $G$ for the log-rank test) as input.\n1.  `kaplan_meier_estimator(t_eval, L, X, Delta)`: Computes the pooled-cohort KM survival probability for each time point in `t_eval`.\n2.  `log_rank_test(L, X, Delta, G)`: Computes the log-rank p-value for comparing groups $0$ and $1$.\n\nThe main `solve` function will iterate through the provided test cases. For each case, it will:\n- Call the helper functions once with the given $L$ array to get the left-truncated results ($S_{\\text{left}}$, $p_{\\text{left}}$).\n- Call the helper functions a second time with a modified $L$ array of all zeros to get the naive results ($S_{\\text{naive}}$, $p_{\\text{naive}}$).\n- Compute the maximum absolute difference $d = \\max |S_{\\text{left}}(t) - S_{\\text{naive}}(t)|$ over the evaluation times.\n- Collate the three results ($d$, $p_{\\textleft}$, $p_{\\text{naive}}$) for the final output. The final list of results will be formatted into the required string representation.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef kaplan_meier_estimator(t_eval, L, X, Delta):\n    \"\"\"\n    Computes Kaplan-Meier survival estimates with support for left truncation.\n    \"\"\"\n    L, X, Delta = np.asarray(L), np.asarray(X), np.asarray(Delta)\n    t_eval = np.asarray(t_eval)\n\n    # Get unique event times in ascending order\n    unique_event_times = np.unique(X[Delta == 1])\n\n    # Build the survival curve as a step function starting at S(0)=1\n    survival_curve_times = [0.0]\n    survival_curve_probs = [1.0]\n    \n    current_prob = 1.0\n    for t_j in unique_event_times:\n        # Number of events at time t_j\n        d_j = np.sum((X == t_j)  (Delta == 1))\n        \n        # Number of subjects at risk at time t_j (L_i = t_j = X_i)\n        n_j = np.sum((L = t_j)  (X >= t_j))\n        \n        if n_j > 0:\n            current_prob *= (1.0 - d_j / n_j)\n        \n        survival_curve_times.append(t_j)\n        survival_curve_probs.append(current_prob)\n\n    times = np.array(survival_curve_times)\n    probs = np.array(survival_curve_probs)\n\n    # Evaluate survival at requested times using the step function\n    results = []\n    for t in t_eval:\n        # Find the index of the last event time = t\n        idx = np.searchsorted(times, t, side='right') - 1\n        results.append(probs[idx])\n            \n    return np.array(results)\n\ndef log_rank_test(L, X, Delta, G):\n    \"\"\"\n    Performs the log-rank test for two groups with support for left truncation.\n    \"\"\"\n    L, X, Delta, G = np.asarray(L), np.asarray(X), np.asarray(Delta), np.asarray(G)\n    \n    # Get unique event times across all data\n    unique_event_times = np.unique(X[Delta == 1])\n\n    U = 0.0  # Numerator of Z-statistic: Sum of (Observed - Expected)\n    V = 0.0  # Denominator of Z-statistic: Sum of variances\n\n    for t_j in unique_event_times:\n        # Define mask for subjects at risk at time t_j\n        at_risk_mask = (L = t_j)  (X >= t_j)\n        n_j = np.sum(at_risk_mask)\n        d_j = np.sum((X == t_j)  (Delta == 1))\n\n        # Variance is only defined for n_j > 1\n        if n_j > 1:\n            # Group 0 specifics\n            at_risk_g0_mask = at_risk_mask  (G == 0)\n            n_0j = np.sum(at_risk_g0_mask)\n            d_0j = np.sum((X == t_j)  (Delta == 1)  (G == 0))\n            \n            # Group 1 specifics (by subtraction)\n            n_1j = n_j - n_0j\n\n            # Expected events in group 0 under H0\n            E_0j = d_j * (n_0j / n_j)\n            \n            # Update U and V\n            U += (d_0j - E_0j)\n            \n            # Variance based on hypergeometric distribution\n            # This is valid for tied event times\n            if n_j > 1:\n                V_j = (n_0j * n_1j * d_j * (n_j - d_j)) / (n_j**2 * (n_j - 1))\n                V += V_j\n\n    # Compute Z-statistic and two-sided p-value\n    if V > 1e-9: # Use a small tolerance for floating point precision\n        Z = U / np.sqrt(V)\n        p_value = 2 * norm.sf(np.abs(Z))\n    else:\n        # If variance is zero, no statistical evidence to reject H0\n        p_value = 1.0\n        \n    return p_value\n\ndef solve():\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A\n        {'L': [0.0, 1.0, 2.0, 0.5, 3.0, 0.0, 2.0, 1.5, 4.0, 0.0, 5.0, 3.0],\n         'X': [5.0, 6.0, 7.5, 4.0, 9.0, 3.5, 8.0, 6.2, 9.5, 2.0, 7.0, 6.0],\n         'Delta': [1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0],\n         'G': [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],\n         'T_eval': [2.0, 4.0, 6.0, 8.0]},\n        # Case B\n        {'L': [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],\n         'X': [5.0, 7.0, 4.0, 10.0, 3.0, 6.0, 8.0, 5.0, 9.0, 2.0],\n         'Delta': [1, 0, 1, 0, 1, 1, 0, 0, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1, 1, 1],\n         'T_eval': [2.0, 5.0, 7.0, 9.0]},\n        # Case C\n        {'L': [3.0, 4.0, 5.0, 6.0, 2.5, 4.5, 5.5, 7.0, 8.0, 3.5, 6.5, 1.0],\n         'X': [3.5, 6.0, 9.0, 7.5, 3.0, 7.0, 8.0, 9.5, 10.0, 5.0, 7.2, 2.0],\n         'Delta': [1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1],\n         'T_eval': [2.0, 4.0, 6.0, 8.0]},\n        # Case D\n        {'L': [0.0, 1.0, 2.0, 2.5, 0.0, 1.5, 2.0, 3.0],\n         'X': [3.0, 3.0, 5.0, 7.0, 3.0, 3.0, 7.0, 7.0],\n         'Delta': [1, 1, 0, 1, 1, 0, 1, 1],\n         'G': [0, 0, 0, 0, 1, 1, 1, 1],\n         'T_eval': [3.0, 7.0]},\n    ]\n    \n    all_results = []\n    \n    for case_data in test_cases:\n        L = np.array(case_data['L'])\n        X = np.array(case_data['X'])\n        Delta = np.array(case_data['Delta'])\n        G = np.array(case_data['G'])\n        T_eval = np.array(case_data['T_eval'])\n        \n        # Left-truncated (\"correct\") analysis\n        S_left = kaplan_meier_estimator(T_eval, L, X, Delta)\n        p_left = log_rank_test(L, X, Delta, G)\n        \n        # Naive analysis (ignore left truncation)\n        L_naive = np.zeros_like(L, dtype=float)\n        S_naive = kaplan_meier_estimator(T_eval, L_naive, X, Delta)\n        p_naive = log_rank_test(L_naive, X, Delta, G)\n        \n        # Compute maximum absolute difference in survival estimates\n        d = np.max(np.abs(S_left - S_naive))\n        \n        all_results.append([d, p_left, p_naive])\n        \n    # Final print statement in the exact required format.\n    formatted_results = [f\"[{res[0]},{res[1]},{res[2]}]\" for res in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "4576983"}]}