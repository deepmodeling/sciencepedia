{"hands_on_practices": [{"introduction": "Nonlinear mixed-effects models excel at describing complex biological systems, but their estimation often relies on linearization. This exercise demonstrates a fundamental technique in pharmacokinetics: transforming a multiplicative, nonlinear model for a parameter like clearance into a linear form. By applying the natural logarithm, you will see how covariates and log-normal random effects can be represented within a familiar linear regression framework, a crucial skill for both building and interpreting NLME models. [@problem_id:4568900]", "problem": "Consider a structural parameterization for individual clearance in a population pharmacokinetic study under the framework of Nonlinear Mixed-Effects Modeling (NLME). Let the individual clearance $CL_{i}$ be modeled as a multiplicative decomposition into a typical value and interindividual variability, together with an allometric covariate effect of body weight $WT_{i}$ referenced to $70$ kilograms. Specifically, assume the following scientifically grounded bases:\n\n- Allometric scaling from physiological theory: the typical metabolic rate scales with body mass as a power law with exponent $3/4$ for adult mammals.\n- Log-normal interindividual variability: multiplicative random effects on a positive parameter can be represented as an exponential of a mean-zero normal random variable, which implies additivity of noise on the logarithmic scale.\n- Independence of covariate and random effect: the body weight $WT_{i}$ is treated as an observed covariate independent of the random effect.\n\nStarting from these principles, let the parameterization be\n$$\nCL_{i} \\;=\\; \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp\\!\\big(\\eta_{CL,i}\\big),\n$$\nwhere $\\theta_{CL} \\!>\\! 0$ is the typical clearance at $WT=70$ kilograms, $\\beta$ is the allometric exponent, and $\\eta_{CL,i} \\sim \\mathcal{N}(0,\\omega_{CL}^{2})$ represents interindividual variability on the log scale.\n\nAssume the physiologically motivated allometric exponent $\\beta = 0.75$. Using only the bases above and general properties of the natural logarithm, derive a linear relationship between $\\ln(CL_{i})$ and $\\ln(WT_{i}/70)$ and identify the regression intercept and slope for the log-linear representation with additive error $\\eta_{CL,i}$. Provide your final answer as a row matrix containing, in order, the intercept and the slope. No numerical substitution is required, and no rounding is necessary.", "solution": "The problem statement has been validated and is deemed valid. It is scientifically grounded in established principles of pharmacokinetics and allometric scaling, well-posed with a unique solution, and free from ambiguity or contradiction. We may therefore proceed with the derivation.\n\nThe starting point is the given structural model for individual clearance, $CL_{i}$:\n$$\nCL_{i} = \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp(\\eta_{CL,i})\n$$\nwhere $CL_{i}$ is the clearance for the $i$-th individual, $\\theta_{CL}$ is the typical clearance for an individual with a body weight of $70$ kilograms, $WT_{i}$ is the body weight of the $i$-th individual, $\\beta$ is the allometric exponent, and $\\eta_{CL,i}$ is the random effect representing interindividual variability, with $\\eta_{CL,i} \\sim \\mathcal{N}(0, \\omega_{CL}^{2})$.\n\nThe objective is to derive a linear relationship between $\\ln(CL_{i})$ and $\\ln(WT_{i}/70)$. This process is achieved by applying the natural logarithm function to both sides of the equation.\n$$\n\\ln(CL_{i}) = \\ln\\left( \\theta_{CL} \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\exp(\\eta_{CL,i}) \\right)\n$$\nUsing the property of logarithms that the logarithm of a product is the sum of the logarithms, $\\ln(a \\cdot b \\cdot c) = \\ln(a) + \\ln(b) + \\ln(c)$, we can expand the right-hand side:\n$$\n\\ln(CL_{i}) = \\ln(\\theta_{CL}) + \\ln\\left( \\left(\\frac{WT_{i}}{70}\\right)^{\\beta} \\right) + \\ln(\\exp(\\eta_{CL,i}))\n$$\nNext, we apply two further properties of logarithms. First, the power rule, $\\ln(x^{p}) = p \\ln(x)$, is applied to the second term. Second, the property that the natural logarithm is the inverse function of the exponential function, $\\ln(\\exp(x)) = x$, is applied to the third term. This yields:\n$$\n\\ln(CL_{i}) = \\ln(\\theta_{CL}) + \\beta \\ln\\left(\\frac{WT_{i}}{70}\\right) + \\eta_{CL,i}\n$$\nThis equation represents a linear model. A general linear regression model takes the form:\n$$\nY = \\text{Intercept} + (\\text{Slope}) \\cdot X + \\text{Error}\n$$\nBy comparing our derived equation to this general form, we can identify the corresponding components:\n- The dependent variable, $Y$, is $\\ln(CL_{i})$.\n- The independent variable, $X$, is $\\ln(WT_{i}/70)$.\n- The additive error term is $\\eta_{CL,i}$, which is consistent with the problem's premises as $\\eta_{CL,i}$ is a random variable with a mean of $0$.\n- The intercept is the constant term, which corresponds to $\\ln(\\theta_{CL})$.\n- The slope is the coefficient of the independent variable, which corresponds to $\\beta$.\n\nThe problem specifies to assume the physiologically motivated allometric exponent $\\beta = 0.75$. Substituting this value for the slope, we have:\nSlope $= \\beta = 0.75$.\nThe intercept remains in its symbolic form as $\\ln(\\theta_{CL})$, as no value for the typical clearance $\\theta_{CL}$ is provided.\n\nTherefore, the regression intercept and slope for the log-linear representation are $\\ln(\\theta_{CL})$ and $0.75$, respectively.", "answer": "$$\\boxed{\\begin{pmatrix} \\ln(\\theta_{CL}) & 0.75 \\end{pmatrix}}$$", "id": "4568900"}, {"introduction": "A theoretically sound model is only useful if its parameters can be reliably estimated from experimental data. This practice challenges you to think critically about the link between study design and parameter identifiability, a crucial real-world consideration in pharmacometrics. By analyzing a sparse sampling scenario, you will explore why certain parameters in a standard pharmacokinetic model may be practically impossible to estimate, even when using sophisticated NLME methods that borrow strength across a population. [@problem_id:4568885]", "problem": "A one-compartment oral dosing model with first-order absorption and linear elimination is used to describe plasma concentrations in a Nonlinear Mixed-Effects (NLME) analysis. Each subject receives a single immediate-release oral dose of amount $D$, with known absolute bioavailability $F=1$. The structural parameters are clearance $CL$, volume of distribution $V$, and the first-order absorption rate constant $K_a$. Inter-individual variability is assumed log-normal on $CL$, $V$, and $K_a$, and the residual error is proportional. Each subject has only two post-dose plasma samples at times $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$.\n\nUsing the governing mass-balance principles for one-compartment models with first-order absorption and linear elimination, assess structural identifiability and practical estimability under this sparse design. Which statement best describes which parameters can be estimated reliably at the population level?\n\nA. With two late post-dose samples, only the elimination rate constant $k=CL/V$ is reliably estimable; $CL$, $V$, and $K_a$ are not separately identifiable.\n\nB. Both $CL$ and $V$ are identifiable from the slope and intercept of the semi-log concentration–time profile, while $K_a$ is not.\n\nC. All three parameters $CL$, $V$, and $K_a$ are identifiable because NLME modeling borrows strength across subjects.\n\nD. Only $K_a$ is identifiable from two post-dose samples because the absorption phase dominates the profile at $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$.", "solution": "The validity of the problem statement is hereby confirmed.\n\n**1. Problem Validation**\n\n**Step 1: Extract Givens**\n-   Model: One-compartment oral dosing, first-order absorption, linear elimination.\n-   Dose ($D$): Single immediate-release oral dose.\n-   Bioavailability ($F$): $F=1$.\n-   Structural Parameters: Clearance ($CL$), Volume of distribution ($V$), Absorption rate constant ($K_a$).\n-   Inter-individual Variability (IIV): Assumed log-normal on $CL$, $V$, and $K_a$.\n-   Residual Error: Proportional.\n-   Analysis Method: Nonlinear Mixed-Effects (NLME).\n-   Sampling Design: Two post-dose samples per subject at times $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$.\n-   Question: Assess structural identifiability and practical estimability to determine which parameters can be estimated reliably at the population level.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically sound, well-posed, and objective. It describes a standard scenario in pharmacokinetics and pharmacometrics. The model is a fundamental one, and the question about parameter estimability from a sparse sampling design is a critical and common consideration in clinical study design and analysis. The provided information is self-contained and sufficient to allow for a principled assessment. The problem does not violate any fundamental scientific laws, is not based on false premises, and uses well-defined terminology within its field.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A full solution will be derived.\n\n**2. Derivation of Solution**\n\nThe concentration-time profile for a one-compartment model following a single oral dose is described by the Bateman function. The governing system of differential equations is:\n$$ \\frac{dA_{gut}}{dt} = -K_a \\cdot A_{gut}(t) $$\n$$ \\frac{dA_{c}}{dt} = K_a \\cdot A_{gut}(t) - k \\cdot A_{c}(t) $$\nwhere $A_{gut}(t)$ is the amount of drug in the absorption compartment, $A_c(t)$ is the amount in the central compartment, $K_a$ is the first-order absorption rate constant, and $k$ is the first-order elimination rate constant. The initial conditions are $A_{gut}(0) = F \\cdot D = D$ (since $F=1$) and $A_c(0)=0$.\n\nThe solution for the concentration in the central compartment, $C(t) = A_c(t) / V$, is:\n$$ C(t) = \\frac{K_a F D}{V(K_a - k)} (e^{-kt} - e^{-K_a t}) $$\nGiven that $F=1$ and the structural parameters are $CL$, $V$, and $K_a$, we can substitute the elimination rate constant $k = CL/V$:\n$$ C(t) = \\frac{K_a D}{V(K_a - CL/V)} (e^{-(CL/V)t} - e^{-K_a t}) $$\nThe model has three structural parameters to estimate: $CL$, $V$, and $K_a$.\n\nThe data available for each subject consist of only two concentration measurements at $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$. This is a very sparse sampling design. For an immediate-release formulation, the absorption process is typically rapid. A typical absorption half-life ($t_{1/2,abs} = \\ln(2)/K_a$) might be in the range of $0.5\\,\\mathrm{h}$ to $2\\,\\mathrm{h}$. Consequently, the sampling times at $t=6\\,\\mathrm{h}$ and $t=24\\,\\mathrm{h}$ are likely to fall well into the post-absorptive, terminal elimination phase of the drug's disposition.\n\nIn the terminal elimination phase, time $t$ is large enough such that the absorption process is essentially complete. Mathematically, this means $e^{-K_a t} \\to 0$ much faster than $e^{-kt}$ (assuming the common case where $K_a > k$). The concentration equation simplifies to:\n$$ C(t) \\approx \\left[\\frac{K_a D}{V(K_a - k)}\\right] e^{-kt} \\quad \\text{for large } t $$\nTaking the natural logarithm of this expression yields:\n$$ \\ln C(t) \\approx \\ln\\left(\\frac{K_a D}{V(K_a - k)}\\right) - k t $$\nThis equation describes a straight line on a semi-logarithmic plot of concentration versus time, with a slope of $-k$. With two data points $(t_1, C_1)$ and $(t_2, C_2)$ in this linear region, the slope can be estimated as:\n$$ \\text{Slope} = \\frac{\\ln C_2 - \\ln C_1}{t_2 - t_1} \\approx -k $$\nIn this problem, the two available points at $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$ will primarily inform this slope. An NLME model will effectively average these slope estimates across the population to derive a robust population estimate for the typical value of $k = CL/V$.\n\nNow, let's consider the other parameters. The intercept of the terminal line on the semi-log plot is a complex term: $\\ln\\left(\\frac{K_a D}{V(K_a - k)}\\right)$. From our two data points, we can estimate $k$ (the slope) and we can estimate a point on the line, which effectively gives us the intercept. However, this intercept value is a function of both $V$ and $K_a$. We have one piece of information (the intercept value) and two unknown parameters ($V$ and $K_a$) embedded within it. It is mathematically impossible to uniquely determine $V$ and $K_a$ separately from this single value. This is a classic identifiability problem.\n\nSince the data are collected late in the profile, they contain minimal to no information about the initial absorption phase, which is required to estimate $K_a$. Without a reliable estimate of $K_a$, the intercept term cannot be resolved. Furthermore, since $V$ is confounded with $K_a$ in the intercept, $V$ cannot be reliably estimated either. Because we can only estimate the ratio $k = CL/V$, and we cannot estimate $V$ separately, it follows that we also cannot estimate $CL$ separately.\n\nThus, under this sparse sampling design, only the composite parameter $k = CL/V$ is practically estimable. The individual parameters $CL$, $V$, and $K_a$ are not practically identifiable at the population level.\n\n**3. Evaluation of Options**\n\n**A. With two late post-dose samples, only the elimination rate constant $k=CL/V$ is reliably estimable; $CL$, $V$, and $K_a$ are not separately identifiable.**\nThis statement is consistent with the analysis above. The two late data points primarily define the terminal elimination slope, which yields an estimate of $k$. The information required to separate $V$ and $K_a$ from the intercept, and thus to separate $CL$ and $V$ from the ratio $k$, is absent from the data.\n**Verdict: Correct.**\n\n**B. Both $CL$ and $V$ are identifiable from the slope and intercept of the semi-log concentration–time profile, while $K_a$ is not.**\nThis statement is incorrect. The slope of the semi-log profile provides an estimate of the ratio $k = CL/V$, not $CL$ and $V$ individually. The intercept is a function of $V$ and $K_a$ and does not allow for the separate estimation of $V$, especially when $K_a$ is also unknown. Therefore, neither $CL$ nor $V$ can be identified separately.\n**Verdict: Incorrect.**\n\n**C. All three parameters $CL$, $V$, and $K_a$ are identifiable because NLME modeling borrows strength across subjects.**\nThis statement misrepresents the power of NLME modeling. While NLME analysis does \"borrow strength\" across subjects, it can only do so when the combined data from all subjects adequately characterize the entire pharmacokinetic profile. In this case, every subject is sampled at the same two late time points. This creates a systematic deficiency of information about the absorption and peak concentration phases across the entire population dataset. NLME cannot create information that was never collected. Therefore, parameters governing the early phase ($K_a$) and those confounded with them ($V$ and $CL$) remain non-estimable.\n**Verdict: Incorrect.**\n\n**D. Only $K_a$ is identifiable from two post-dose samples because the absorption phase dominates the profile at $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$.**\nThis statement is based on a false premise. The absorption phase, governed by $K_a$, dominates at early times, typically within the first few hours for an immediate-release product. The sampling times $t_1=6\\,\\mathrm{h}$ and $t_2=24\\,\\mathrm{h}$ are characteristic of the post-absorptive or terminal elimination phase, where the influence of $K_a$ is minimal or negligible. Therefore, $K_a$ is the least likely parameter to be identifiable from these data.\n**Verdict: Incorrect.**", "answer": "$$\\boxed{A}$$", "id": "4568885"}, {"introduction": "Model evaluation is a critical final step in the NLME workflow, and Conditionally Weighted Residuals (CWRES) are a powerful diagnostic tool. This exercise bridges theory and practice by asking you to implement the calculation of CWRES from first principles. You will synthesize concepts of structural modeling, inter-individual variability, and residual error, and apply the Delta method to approximate the total conditional variance, providing a deep, hands-on understanding of this essential diagnostic metric. [@problem_id:4568868]", "problem": "A nonlinear mixed-effects model in clinical pharmacology is considered for an intravenous bolus dose in a one-compartment system. For individual $i$ at sampling time $t_{ij}$, the structural concentration prediction is given by the well-tested one-compartment formula\n$$\nC_{ij} = \\frac{D_i}{V_i}\\exp\\!\\left(-\\frac{CL_i}{V_i}\\,t_{ij}\\right),\n$$\nwhere $D_i$ is the administered dose, $CL_i$ is clearance, and $V_i$ is volume of distribution. Inter-individual variability is represented by log-normal random effects,\n$$\nCL_i = CL_{\\text{pop}}\\exp(\\eta_{CL,i}),\\quad V_i = V_{\\text{pop}}\\exp(\\eta_{V,i}),\n$$\nwhere $CL_{\\text{pop}}$ and $V_{\\text{pop}}$ are population parameters, and $(\\eta_{CL,i},\\eta_{V,i})$ are individual-specific random effects whose conditional mean (the Empirical Bayes Estimate (EBE)) is used for prediction and whose conditional covariance matrix is denoted $S_i \\in \\mathbb{R}^{2\\times 2}$. The observation model is a combined proportional-additive residual error model,\n$$\ny_{ij} = C_{ij}\\left(1+\\epsilon_{p,ij}\\right) + \\epsilon_{a,ij},\n$$\nwith $\\epsilon_{p,ij}\\sim \\mathcal{N}(0,\\sigma_p^2)$ and $\\epsilon_{a,ij}\\sim \\mathcal{N}(0,\\sigma_a^2)$, independent of each other and of the random effects. All concentrations must be expressed in $\\mathrm{mg/L}$, doses in $\\mathrm{mg}$, clearance in $\\mathrm{L/h}$, volume in $\\mathrm{L}$, and time in $\\mathrm{h}$.\n\nConditionally Weighted Residuals (CWRES) are defined for each observation as the residual normalized by the square root of the conditional variance of the observation given the model and the data. To estimate the conditional variance in a scientifically principled way, use the first-order sensitivity (Delta Method) approximation: if $C_{ij}$ depends on uncertain $\\boldsymbol{\\eta}_i = (\\eta_{CL,i}, \\eta_{V,i})^\\top$ with conditional covariance $S_i$, then\n$$\n\\mathrm{Var}\\!\\left[C_{ij}\\mid \\text{data}\\right] \\approx \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij} \\;+\\; \\mathrm{Var}\\!\\left[\\epsilon_{p,ij}\\right]\\cdot C_{ij}^2 \\;+\\; \\mathrm{Var}\\!\\left[\\epsilon_{a,ij}\\right].\n$$\nThe gradient $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ must be derived from first principles using the chain rule and the above structural model definitions.\n\nYour task is to write a complete program that:\n- Computes $CL_i$ and $V_i$ from $CL_{\\text{pop}}$, $V_{\\text{pop}}$, and the provided EBE values $(\\eta_{CL,i},\\eta_{V,i})$.\n- Computes $C_{ij}$ for each sampling time $t_{ij}$.\n- Derives $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ and uses the Delta Method with the provided $S_i$ to estimate the conditional variance.\n- Computes CWRES for each observation $y_{ij}$ as $(y_{ij}-C_{ij})/\\sqrt{\\mathrm{Var}[y_{ij}\\mid \\text{data}]}$.\n- Produces a single line of output containing all CWRES values as a comma-separated list enclosed in square brackets, with each number rounded to $6$ decimal places. CWRES are dimensionless.\n\nUse the following test suite, which spans a general case, a boundary condition, and an edge case:\n- Case $1$ (general \"happy path\"):\n  - $D_1 = 100\\ \\mathrm{mg}$, $CL_{\\text{pop}} = 5\\ \\mathrm{L/h}$, $V_{\\text{pop}} = 50\\ \\mathrm{L}$.\n  - $\\eta_{CL,1} = 0.1$, $\\eta_{V,1} = -0.05$ (EBE).\n  - $S_1 = \\begin{pmatrix} 0.04 & 0.01 \\\\ 0.01 & 0.03 \\end{pmatrix}$.\n  - Sampling times $t_{1j}\\in \\{0.5, 2.0, 8.0\\}\\ \\mathrm{h}$.\n  - Observations $y_{1j}\\in \\{2.06, 1.62, 0.80\\}\\ \\mathrm{mg/L}$.\n  - $\\sigma_p = 0.15$ (dimensionless), $\\sigma_a = 0.05\\ \\mathrm{mg/L}$.\n- Case $2$ (boundary condition at time zero):\n  - $D_2 = 200\\ \\mathrm{mg}$, $CL_{\\text{pop}} = 3\\ \\mathrm{L/h}$, $V_{\\text{pop}} = 40\\ \\mathrm{L}$.\n  - $\\eta_{CL,2} = 0.0$, $\\eta_{V,2} = 0.0$ (EBE).\n  - $S_2 = \\begin{pmatrix} 0.0001 & 0.0 \\\\ 0.0 & 0.0001 \\end{pmatrix}$.\n  - Sampling times $t_{2j}\\in \\{0.0, 1.0\\}\\ \\mathrm{h}$.\n  - Observations $y_{2j}\\in \\{5.05, 4.60\\}\\ \\mathrm{mg/L}$.\n  - $\\sigma_p = 0.10$ (dimensionless), $\\sigma_a = 0.02\\ \\mathrm{mg/L}$.\n- Case $3$ (edge case with zero proportional error and correlated $\\boldsymbol{\\eta}$):\n  - $D_3 = 50\\ \\mathrm{mg}$, $CL_{\\text{pop}} = 10\\ \\mathrm{L/h}$, $V_{\\text{pop}} = 20\\ \\mathrm{L}$.\n  - $\\eta_{CL,3} = -0.2$, $\\eta_{V,3} = 0.2$ (EBE).\n  - $S_3 = \\begin{pmatrix} 0.05 & -0.02 \\\\ -0.02 & 0.07 \\end{pmatrix}$.\n  - Sampling times $t_{3j}\\in \\{0.5, 3.0\\}\\ \\mathrm{h}$.\n  - Observations $y_{3j}\\in \\{2.35, 0.60\\}\\ \\mathrm{mg/L}$.\n  - $\\sigma_p = 0.00$ (dimensionless), $\\sigma_a = 0.10\\ \\mathrm{mg/L}$.\n\nYour program should produce a single line of output containing the CWRES for all observations in the order listed above (case by case, time order within each case) as a comma-separated list enclosed in square brackets, with each entry rounded to $6$ decimal places (for example, $[x_1,x_2,\\dots]$).", "solution": "The problem is valid. It is a well-posed, scientifically grounded problem in clinical pharmacology that is self-contained and free of contradictions. The models, parameters, and data are standard in the field of pharmacometrics and are consistent with fundamental principles. All provided covariance matrices are positive definite. The task requires a rigorous application of established mathematical and statistical methods.\n\nThe objective is to compute the Conditionally Weighted Residuals (CWRES) for a series of pharmacokinetic observations. The calculation is performed in a sequence of steps, starting from the fundamental model definitions.\n\nThe foundational model consists of three components: a structural model describing the drug concentration over time, an inter-individual variability model for key parameters, and a residual error model for the observations.\nFor an individual $i$, the structural model for drug concentration $C_{ij}$ at time $t_{ij}$ after an intravenous bolus dose $D_i$ is given by the one-compartment model:\n$$\nC_{ij} = \\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right)\n$$\nThe parameters clearance ($CL_i$) and volume of distribution ($V_i$) vary between individuals. This variability is modeled log-normally around population typical values ($CL_{\\text{pop}}$, $V_{\\text{pop}}$):\n$$\nCL_i = CL_{\\text{pop}}\\exp(\\eta_{CL,i})\n$$\n$$\nV_i = V_{\\text{pop}}\\exp(\\eta_{V,i})\n$$\nHere, $\\eta_{CL,i}$ and $\\eta_{V,i}$ are the individual-specific random effects, for which we use their conditional means (Empirical Bayes Estimates, EBEs) for prediction.\n\nThe observed concentration $y_{ij}$ is related to the true (structural) concentration $C_{ij}$ through a combined proportional and additive error model:\n$$\ny_{ij} = C_{ij}(1+\\epsilon_{p,ij}) + \\epsilon_{a,ij}\n$$\nwhere $\\epsilon_{p,ij} \\sim \\mathcal{N}(0, \\sigma_p^2)$ and $\\epsilon_{a,ij} \\sim \\mathcal{N}(0, \\sigma_a^2)$ represent independent, normally distributed proportional and additive error terms, respectively.\n\nCWRES are defined as the difference between the observed and predicted concentrations, normalized by the an estimate of the conditional standard deviation of the observation. The formula for CWRES is:\n$$\n\\text{CWRES}_{ij} = \\frac{y_{ij} - C_{ij}}{\\sqrt{\\mathrm{Var}[y_{ij} \\mid \\text{data}]}}\n$$\nwhere $C_{ij}$ is computed using the EBEs for $\\boldsymbol{\\eta}_i = (\\eta_{CL,i}, \\eta_{V,i})^\\top$. The conditional variance, $\\mathrm{Var}[y_{ij} \\mid \\text{data}]$, accounts for two sources of variability: the uncertainty in the individual parameters $\\boldsymbol{\\eta}_i$ and the residual unexplained variability (measurement error).\n\nThe total conditional variance is approximated using the first-order Taylor expansion (Delta Method). It is the sum of the variance due to parameter uncertainty and the variance of the residual error:\n$$\n\\mathrm{Var}[y_{ij} \\mid \\text{data}] \\approx \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij} + \\mathrm{Var}\\left[C_{ij}\\epsilon_{p,ij} + \\epsilon_{a,ij}\\right]\n$$\nGiven the independence of the error terms, the residual variance component is:\n$$\n\\mathrm{Var}\\left[C_{ij}\\epsilon_{p,ij} + \\epsilon_{a,ij}\\right] = C_{ij}^2 \\mathrm{Var}[\\epsilon_{p,ij}] + \\mathrm{Var}[\\epsilon_{a,ij}] = C_{ij}^2\\sigma_p^2 + \\sigma_a^2\n$$\nThe term $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ is the gradient (vector of first partial derivatives) of the structural model $C_{ij}$ with respect to the random effects $\\boldsymbol{\\eta}_i$, evaluated at the EBEs. $S_i$ is the conditional covariance matrix of the EBEs.\n\nThe crucial step is to derive the gradient $\\nabla_{\\boldsymbol{\\eta}} C_{ij} = \\left(\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}}, \\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}}\\right)^\\top$. We apply the chain rule.\n\nLet's derive the first component, $\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}}$:\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}} = \\frac{\\partial C_{ij}}{\\partial CL_i} \\frac{\\partial CL_i}{\\partial \\eta_{CL,i}}\n$$\nThe derivative of $CL_i$ with respect to $\\eta_{CL,i}$ is:\n$$\n\\frac{\\partial CL_i}{\\partial \\eta_{CL,i}} = \\frac{\\partial}{\\partial \\eta_{CL,i}} \\left(CL_{\\text{pop}}\\exp(\\eta_{CL,i})\\right) = CL_{\\text{pop}}\\exp(\\eta_{CL,i}) = CL_i\n$$\nThe derivative of $C_{ij}$ with respect to $CL_i$ is:\n$$\n\\frac{\\partial C_{ij}}{\\partial CL_i} = \\frac{\\partial}{\\partial CL_i} \\left(\\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right)\\right) = \\frac{D_i}{V_i} \\exp\\left(-\\frac{CL_i}{V_i}t_{ij}\\right) \\cdot \\left(-\\frac{t_{ij}}{V_i}\\right) = -C_{ij}\\frac{t_{ij}}{V_i}\n$$\nCombining these, we get:\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{CL,i}} = \\left(-C_{ij}\\frac{t_{ij}}{V_i}\\right) \\cdot CL_i = -C_{ij}\\frac{CL_i t_{ij}}{V_i}\n$$\nNow, for the second component, $\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}}$:\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}} = \\frac{\\partial C_{ij}}{\\partial V_i} \\frac{\\partial V_i}{\\partial \\eta_{V,i}}\n$$\nThe derivative of $V_i$ with respect to $\\eta_{V,i}$ is:\n$$\n\\frac{\\partial V_i}{\\partial \\eta_{V,i}} = \\frac{\\partial}{\\partial \\eta_{V,i}} \\left(V_{\\text{pop}}\\exp(\\eta_{V,i})\\right) = V_{\\text{pop}}\\exp(\\eta_{V,i}) = V_i\n$$\nThe derivative of $C_{ij}$ with respect to $V_i$ requires the product rule, as $V_i$ appears in the pre-exponential factor and inside the exponential:\n$$\n\\frac{\\partial C_{ij}}{\\partial V_i} = \\frac{\\partial}{\\partial V_i} \\left(D_i V_i^{-1} \\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right)\\right)\n$$\n$$\n= D_i \\left[ (-1)V_i^{-2}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) + V_i^{-1}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) \\cdot \\left(\\frac{CL_i t_{ij}}{V_i^2}\\right) \\right]\n$$\n$$\n= \\frac{D_i}{V_i}\\exp\\left(-\\frac{CL_i t_{ij}}{V_i}\\right) \\left[ -\\frac{1}{V_i} + \\frac{CL_i t_{ij}}{V_i^2} \\right] = C_{ij} \\frac{1}{V_i}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\n$$\nCombining these, we find:\n$$\n\\frac{\\partial C_{ij}}{\\partial \\eta_{V,i}} = \\left(C_{ij} \\frac{1}{V_i}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\\right) \\cdot V_i = C_{ij}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right)\n$$\nThus, the gradient vector is:\n$$\n\\nabla_{\\boldsymbol{\\eta}} C_{ij} = \\begin{pmatrix} -C_{ij} \\frac{CL_i t_{ij}}{V_i} \\\\ C_{ij}\\left(\\frac{CL_i t_{ij}}{V_i} - 1\\right) \\end{pmatrix}\n$$\nThe variance contribution from parameter uncertainty is the quadratic form $\\text{Var}_{\\eta} = \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij}$.\n\nThe complete algorithm for each observation $(y_{ij}, t_{ij})$ is as follows:\n$1$. Calculate individual parameters $CL_i$ and $V_i$ using the population parameters and the EBEs $\\eta_{CL,i}$ and $\\eta_{V,i}$.\n$2$. Calculate the predicted concentration $C_{ij}$ using the structural model.\n$3$. Calculate the components of the gradient $\\nabla_{\\boldsymbol{\\eta}} C_{ij}$ using the derived formulas.\n$4$. Compute the variance due to parameter uncertainty: $\\text{Var}_{\\eta} = \\nabla_{\\boldsymbol{\\eta}} C_{ij}^\\top S_i \\nabla_{\\boldsymbol{\\eta}} C_{ij}$.\n$5$. Compute the residual error variance: $\\text{Var}_{\\epsilon} = C_{ij}^2\\sigma_p^2 + \\sigma_a^2$.\n$6$. Sum the variances to get the total conditional variance: $\\text{Var}_{\\text{total}} = \\text{Var}_{\\eta} + \\text{Var}_{\\epsilon}$.\n$7$. Compute the CWRES: $\\text{CWRES}_{ij} = (y_{ij} - C_{ij}) / \\sqrt{\\text{Var}_{\\text{total}}}$.\n\nThis procedure is applied to all observations in the provided test suite.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes Conditionally Weighted Residuals (CWRES) for a series of\n    pharmacokinetic test cases based on a one-compartment model.\n    \"\"\"\n    test_cases = [\n        {\n            \"D\": 100.0, \"CLpop\": 5.0, \"Vpop\": 50.0,\n            \"eta_CL\": 0.1, \"eta_V\": -0.05,\n            \"S\": np.array([[0.04, 0.01], [0.01, 0.03]]),\n            \"times\": [0.5, 2.0, 8.0],\n            \"obs\": [2.06, 1.62, 0.80],\n            \"sigma_p\": 0.15, \"sigma_a\": 0.05,\n        },\n        {\n            \"D\": 200.0, \"CLpop\": 3.0, \"Vpop\": 40.0,\n            \"eta_CL\": 0.0, \"eta_V\": 0.0,\n            \"S\": np.array([[0.0001, 0.0], [0.0, 0.0001]]),\n            \"times\": [0.0, 1.0],\n            \"obs\": [5.05, 4.60],\n            \"sigma_p\": 0.10, \"sigma_a\": 0.02,\n        },\n        {\n            \"D\": 50.0, \"CLpop\": 10.0, \"Vpop\": 20.0,\n            \"eta_CL\": -0.2, \"eta_V\": 0.2,\n            \"S\": np.array([[0.05, -0.02], [-0.02, 0.07]]),\n            \"times\": [0.5, 3.0],\n            \"obs\": [2.35, 0.60],\n            \"sigma_p\": 0.00, \"sigma_a\": 0.10,\n        }\n    ]\n\n    all_cwres = []\n\n    for case in test_cases:\n        # Unpack case parameters\n        D_i = case[\"D\"]\n        CL_pop = case[\"CLpop\"]\n        V_pop = case[\"Vpop\"]\n        eta_CL_i = case[\"eta_CL\"]\n        eta_V_i = case[\"eta_V\"]\n        S_i = case[\"S\"]\n        sigma_p = case[\"sigma_p\"]\n        sigma_a = case[\"sigma_a\"]\n\n        # 1. Calculate individual parameters\n        CL_i = CL_pop * np.exp(eta_CL_i)\n        V_i = V_pop * np.exp(eta_V_i)\n        \n        elimination_rate_k = CL_i / V_i\n\n        for t_ij, y_ij in zip(case[\"times\"], case[\"obs\"]):\n            # 2. Calculate predicted concentration\n            C_ij = (D_i / V_i) * np.exp(-elimination_rate_k * t_ij)\n\n            # 3. Calculate the gradient vector\n            grad_C_eta_CL = -C_ij * elimination_rate_k * t_ij\n            grad_C_eta_V = C_ij * (elimination_rate_k * t_ij - 1)\n            grad_vector = np.array([grad_C_eta_CL, grad_C_eta_V])\n\n            # 4. Compute variance from parameter uncertainty (Delta Method)\n            # Var_eta = grad^T * S * grad\n            var_eta = grad_vector.T @ S_i @ grad_vector\n\n            # 5. Compute residual error variance\n            var_epsilon = (C_ij**2) * (sigma_p**2) + (sigma_a**2)\n\n            # 6. Total conditional variance\n            total_variance = var_eta + var_epsilon\n\n            # 7. Compute CWRES\n            if total_variance > 0:\n                cwres = (y_ij - C_ij) / np.sqrt(total_variance)\n            else:\n                # Handle potential division by zero, though unlikely with valid inputs\n                cwres = np.nan \n\n            all_cwres.append(cwres)\n\n    # Round results to 6 decimal places\n    rounded_results = [round(r, 6) for r in all_cwres]\n    \n    # Format the final output string\n    print(f\"[{','.join(map(str, rounded_results))}]\")\n\nsolve()\n```", "id": "4568868"}]}