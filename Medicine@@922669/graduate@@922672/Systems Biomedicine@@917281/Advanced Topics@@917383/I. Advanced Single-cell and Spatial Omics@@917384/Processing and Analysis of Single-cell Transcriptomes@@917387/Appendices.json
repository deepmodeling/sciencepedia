{"hands_on_practices": [{"introduction": "A well-designed experiment is the bedrock of any successful scientific inquiry. In single-cell genomics, where costs can be substantial, determining the appropriate number of cells to sequence is a critical first step. This exercise guides you through the process of calculating the minimum sample size required to detect a rare cell type with a desired statistical power, ensuring your experiment has a high probability of achieving its goal without wasting resources [@problem_id:4378856].", "problem": "Design a statistically principled sampling strategy for a single-cell ribonucleic acid sequencing (scRNA-seq) experiment aimed at detecting a rare cell type in a single biological sample. Assume each captured cell is independently and identically classified into cell types, and the presence of the target cell type in the captured set follows a binomial model with true prevalence $p$ in the sample. The count of target-type cells among $n$ captured cells is modeled as a binomial random variable $X \\sim \\mathrm{Bin}(n,p)$, reflecting independent Bernoulli trials with success probability $p$.\n\nYou will use a one-sided hypothesis testing framework to formalize “detection” as rejecting a null hypothesis that the target type is absent in the captured set. The significance level $\\alpha$ is the maximum Type I error rate tolerated, and the power $1-\\beta$ is the minimum probability to correctly detect the target type when its true prevalence equals $p$. The decision rule is based on a critical count threshold $k_{\\mathrm{crit}}$ such that observing $X \\geq k_{\\mathrm{crit}}$ constitutes “detection.”\n\nStarting from the binomial model and the definitions of significance and power, derive an expression for the minimal per-sample cell count $n_{\\min}(p,\\alpha,\\beta)$ needed to guarantee power at least $1-\\beta$ while controlling the significance at $\\alpha$ under the idealized null hypothesis that the target type is absent in the captured set. Then, compute the minimal per-sample cell count for $p=0.01$, $\\alpha=0.05$, and $\\beta=0.2$. Report the minimal integer $n$ that satisfies the design constraints. If any approximation is used, express the final numerical answer to four significant figures. No physical units are required for the answer.", "solution": "Let $X$ be the number of target cells detected out of a total of $n$ captured cells. The problem states that $X$ follows a binomial distribution, $X \\sim \\mathrm{Bin}(n, p)$, where $p$ is the true prevalence of the rare cell type.\n\n**1. Formulating the Hypothesis Test and Decision Rule**\n\nThe goal is to detect the presence of the cell type. We can frame this as a hypothesis test:\n- **Null Hypothesis ($H_0$)**: The cell type is absent, which corresponds to a prevalence of $p=0$.\n- **Alternative Hypothesis ($H_1$)**: The cell type is present, so $p > 0$.\n\nDetection is defined as rejecting $H_0$. The decision rule is to reject $H_0$ if the observed count $X$ is greater than or equal to a critical threshold, $X \\geq k_{\\mathrm{crit}}$.\n\n**2. Determining the Critical Threshold $k_{\\mathrm{crit}}$**\n\nThe test must satisfy a significance level of $\\alpha$. This means the probability of a Type I error (incorrectly rejecting $H_0$ when it is true) must be at most $\\alpha$.\n$$ P(\\text{Type I Error}) = P(X \\geq k_{\\mathrm{crit}} | H_0 \\text{ is true}) = P(X \\geq k_{\\mathrm{crit}} | p=0) \\leq \\alpha $$\nUnder $H_0: p=0$, the distribution is $\\mathrm{Bin}(n, 0)$, where $P(X=0) = 1$ and $P(X>0) = 0$.\nIf we choose any critical count $k_{\\mathrm{crit}} \\geq 1$, the probability of a Type I error is $P(X \\geq k_{\\mathrm{crit}} | p=0) = 0$. Since the specified $\\alpha=0.05$, the condition $0 \\leq 0.05$ is always met for any $k_{\\mathrm{crit}} \\geq 1$.\n\nTo maximize the power of the test (the ability to detect the cell type when it is present), we should choose the smallest possible integer value for $k_{\\mathrm{crit}}$ that constitutes evidence against the null hypothesis. Observing even one cell ($X=1$) is evidence of presence. Therefore, we set the critical value $k_{\\mathrm{crit}}=1$.\nThe decision rule is: \"detection\" occurs if we observe at least one target cell ($X \\geq 1$).\n\n**3. Deriving Minimal Sample Size $n$ from the Power Constraint**\n\nThe power of the test is the probability of correctly rejecting $H_0$ when the true prevalence is $p$. The problem requires a power of at least $1-\\beta$.\n$$ \\text{Power} = P(X \\geq 1 | p) \\geq 1-\\beta $$\nThe probability of observing at least one target cell is the complement of observing zero target cells:\n$$ P(X \\geq 1 | p) = 1 - P(X=0 | p) $$\nSubstituting this into the power constraint:\n$$ 1 - P(X=0 | p) \\geq 1-\\beta $$\nThis simplifies to:\n$$ P(X=0 | p) \\leq \\beta $$\nFor a binomial distribution $X \\sim \\mathrm{Bin}(n, p)$, the probability mass function gives $P(X=0) = \\binom{n}{0} p^0 (1-p)^{n-0} = (1-p)^n$.\nThe inequality becomes:\n$$ (1-p)^n \\leq \\beta $$\nTo solve for $n$, we take the natural logarithm of both sides. As $\\ln(x)$ is a monotonically increasing function, the inequality is preserved.\n$$ \\ln((1-p)^n) \\leq \\ln(\\beta) $$\n$$ n \\ln(1-p) \\leq \\ln(\\beta) $$\nSince $0  p  1$, the term $\\ln(1-p)$ is negative. Dividing by a negative number reverses the inequality's direction:\n$$ n \\geq \\frac{\\ln(\\beta)}{\\ln(1-p)} $$\nThis provides the general expression for the minimal required sample size. Since $n$ must be an integer, the minimal cell count, $n_{\\min}$, is the smallest integer satisfying this condition, which is the ceiling of the right-hand side.\n$$ n_{\\min}(p, \\beta) = \\left\\lceil \\frac{\\ln(\\beta)}{\\ln(1-p)} \\right\\rceil $$\nNote that this result does not depend on $\\alpha$ because our choice of $k_{\\mathrm{crit}}=1$ works for any $\\alpha > 0$.\n\n**4. Numerical Calculation**\n\nWe compute the minimal integer $n$ for the given parameters: $p=0.01$, $\\alpha=0.05$, and $\\beta=0.2$.\n$$ n \\geq \\frac{\\ln(0.2)}{\\ln(1-0.01)} = \\frac{\\ln(0.2)}{\\ln(0.99)} $$\nUsing the numerical values of the logarithms:\n$$ \\ln(0.2) \\approx -1.6094379 $$\n$$ \\ln(0.99) \\approx -0.0100503 $$\nThe ratio is:\n$$ n \\geq \\frac{-1.6094379}{-0.0100503} \\approx 160.14 $$\nSince the number of cells $n$ must be an integer, we take the ceiling of this value.\n$$ n_{\\min} = \\lceil 160.14 \\rceil = 161 $$\nTherefore, a minimum of 161 cells must be sequenced to meet the design criteria.", "answer": "$$\n\\boxed{161}\n$$", "id": "4378856"}, {"introduction": "Technical artifacts can confound biological signals, and one of the most common in droplet-based scRNA-seq is the \"doublet\"—a single barcode associated with transcripts from two or more cells. This practice introduces a powerful statistical framework for identifying such artifacts by testing for deviations from an expected singlet expression model. You will learn to leverage both global overdispersion and specific co-expression signatures to create a robust doublet detection rule, a crucial quality control step in any analysis workflow [@problem_id:4378827].", "problem": "You are given a mathematical framework for counts from single-cell ribonucleic acid sequencing (scRNA-seq) where each cell is either a singlet (one biological cell) or a doublet (two biological cells captured together). Let $G$ denote the number of genes. For a cell with observed unique molecular identifier counts $\\mathbf{x} \\in \\mathbb{N}^G$, a known library size $L \\in \\mathbb{R}_{0}$, and a known baseline singlet mean vector $\\boldsymbol{\\mu} \\in \\mathbb{R}_{0}^G$, assume the singlet count model for gene $g$ is independent across genes and follows either a Poisson distribution or a Negative Binomial distribution. Under the Negative Binomial parameterization used here, the per-gene variance is $V_g = L \\mu_g + \\phi_g (L \\mu_g)^2$, where $\\phi_g \\ge 0$ is a gene-specific dispersion parameter and $\\mu_g$ is the baseline singlet mean per unit library size. Define the standardized Pearson-type residual for gene $g$ by\n$$\nr_g = \\frac{x_g - L \\mu_g}{\\sqrt{L \\mu_g + \\phi_g (L \\mu_g)^2}}.\n$$\nUnder the singlet model with independence across genes, the residuals $\\{r_g\\}_{g=1}^G$ are approximately standard normal and independent, so the scalar statistic\n$$\nT = \\sum_{g=1}^G r_g^2\n$$\nis approximately chi-square distributed with $G$ degrees of freedom under the singlet model. Doublets formed by mixing two singlets (possibly of different cell types) induce coherent gene coexpression deviations along a gene-program difference vector. Let $\\mathbf{v} \\in \\mathbb{R}^G$ be a known coexpression direction derived from singlet models (for example, a difference between two singlet mean programs), and consider the directional statistic\n$$\nU = \\left(\\frac{\\mathbf{v}^\\top \\mathbf{r}}{\\|\\mathbf{v}\\|_2}\\right)^2,\n$$\nwhich is approximately chi-square distributed with $1$ degree of freedom under the singlet model. You will design a decision rule using overdispersion relative to the singlet model and directional coexpression to distinguish singlets from doublets: compute the survival function (upper-tail probability) $p$-values $p_{\\mathrm{gen}}$ for $T$ (with $G$ degrees of freedom) and $p_{\\mathrm{dir}}$ for $U$ (with $1$ degree of freedom), and classify a cell as a doublet if either $p_{\\mathrm{gen}}  \\alpha$ or $p_{\\mathrm{dir}}  \\alpha$, where $\\alpha \\in (0,1)$ is a given significance level.\n\nStarting from the definitions of the Poisson and Negative Binomial distributions and their variance properties, derive the residuals, their null distribution under independence, and the mixture-induced rank-$1$ coexpression deviation for doublets. Then implement the above decision rule.\n\nYour program must implement this logic for the following test suite. For each case, you are given $G$, $\\boldsymbol{\\mu}$, $\\boldsymbol{\\phi}$, $L$, $\\mathbf{x}$, $\\mathbf{v}$, and $\\alpha$. All vectors are ordered gene-wise. For each case, output a boolean indicating whether the cell is classified as a doublet.\n\n- Case $1$ (happy path singlet): $G = 5$, $\\boldsymbol{\\mu} = [8,3,1,5,2]$, $\\boldsymbol{\\phi} = [0,0,0,0,0]$, $L = 1$, $\\mathbf{x} = [8,3,1,5,2]$, $\\mathbf{v} = [0,0,0,0,0]$, $\\alpha = 0.01$.\n- Case $2$ (distinct-type doublet with strong coexpression): $G = 5$, $\\boldsymbol{\\mu} = [8,3,1,5,2]$, $\\boldsymbol{\\phi} = [0,0,0,0,0]$, $L = 2$, $\\mathbf{x} = [10,10,2,7,8]$, $\\mathbf{v} = [-8,9,1,-4,10]$, $\\alpha = 0.01$.\n- Case $3$ (same-type doublet boundary): $G = 5$, $\\boldsymbol{\\mu} = [8,3,1,5,2]$, $\\boldsymbol{\\phi} = [0,0,0,0,0]$, $L = 2$, $\\mathbf{x} = [16,6,2,10,4]$, $\\mathbf{v} = [0,0,0,0,0]$, $\\alpha = 0.01$.\n- Case $4$ (Negative Binomial dispersion absorbs moderate deviations): $G = 5$, $\\boldsymbol{\\mu} = [8,3,1,5,2]$, $\\boldsymbol{\\phi} = [0.5,0.5,0.5,0.5,0.5]$, $L = 1$, $\\mathbf{x} = [9,5,0,3,4]$, $\\mathbf{v} = [0,0,0,0,0]$, $\\alpha = 0.01$.\n- Case $5$ (directional coexpression detectable while global overdispersion is modest): $G = 5$, $\\boldsymbol{\\mu} = [8,3,1,5,2]$, $\\boldsymbol{\\phi} = [0,0,0,0,0]$, $L = 1$, $\\mathbf{x} = [4,6,1,3,5]$, $\\mathbf{v} = [-8,9,1,-4,10]$, $\\alpha = 0.01$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (e.g., $[result_1,result_2,\\dots]$). Each $result_i$ must be a boolean. No units are required; all quantities are dimensionless counts or probabilities. Angles are not used. Express any threshold comparisons in terms of decimal values (for example, use $\\alpha = 0.01$ as a decimal).", "solution": "The problem requires the design and implementation of a statistical test to classify single cells as singlets or doublets based on their gene expression count profiles from single-cell RNA sequencing (scRNA-seq). The classification relies on detecting deviations from a baseline singlet model. This solution first derives the statistical foundations of the test and then describes the algorithm's implementation.\n\n**1. Statistical Modeling of Single-Cell Counts**\n\nThe number of observed Unique Molecular Identifiers (UMIs) for a gene $g$, denoted by $x_g$, is a discrete random variable. The problem proposes two models for these counts under the singlet hypothesis.\n\nA simple model for count data is the Poisson distribution. If a random variable $X$ follows a Poisson distribution with mean $\\lambda$, its probability mass function is $P(X=k) = e^{-\\lambda}\\lambda^k / k!$ for $k \\in \\{0, 1, 2, ...\\}$. A key property of the Poisson distribution is that its variance equals its mean: $E[X] = V[X] = \\lambda$.\n\nHowever, scRNA-seq data often exhibit overdispersion, where the variance is greater than the mean. The Negative Binomial (NB) distribution is a common choice to model such data. A frequent parameterization of the NB distribution is via its mean $\\mu$ and a dispersion parameter $\\alpha$, such that the variance is $V = \\mu + \\alpha\\mu^2$.\n\nThe problem defines a generalized variance structure for the count of gene $g$, $x_g$, in a cell with total library size $L$. The expected count is $E[x_g] = L\\mu_g$, where $\\mu_g$ is the baseline mean expression for gene $g$ per unit library size. The variance is given as $V_g = L\\mu_g + \\phi_g(L\\mu_g)^2$. This formula encapsulates both models:\n- If $\\phi_g = 0$, the variance becomes $V_g = L\\mu_g$, which is equal to the mean. This corresponds to the Poisson model, $x_g \\sim \\text{Poisson}(L\\mu_g)$.\n- If $\\phi_g  0$, the variance is greater than the mean. This corresponds to the Negative Binomial model, with the mean being $L\\mu_g$ and the dispersion parameter being $\\phi_g$.\n\n**2. Derivation of Residuals and Test Statistics under the Singlet Null Hypothesis**\n\nThe null hypothesis ($H_0$) is that the observed cell is a singlet and its gene expression profile conforms to the specified statistical model. Under $H_0$, the expected count for gene $g$ is $E[x_g] = L\\mu_g$ and its variance is $V_g = L \\mu_g + \\phi_g (L \\mu_g)^2$.\n\nTo quantify the deviation of an observed count $x_g$ from its expectation, we compute a standardized residual. The problem defines a Pearson-type residual, which is the difference between the observed and expected values, standardized by the model's standard deviation:\n$$\nr_g = \\frac{x_g - E[x_g]}{\\sqrt{V_g}} = \\frac{x_g - L \\mu_g}{\\sqrt{L \\mu_g + \\phi_g (L \\mu_g)^2}}\n$$\nFor models like Poisson and Negative Binomial, if the expected counts $L\\mu_g$ are sufficiently large, the Central Limit Theorem implies that the distribution of $x_g$ is approximately Normal. After standardizing, the resulting residual $r_g$ is approximately a standard normal random variable, $r_g \\stackrel{\\text{approx}}{\\sim} \\mathcal{N}(0, 1)$. The problem assumes independence of gene counts, so the residuals $\\{r_g\\}_{g=1}^G$ are approximately independent and identically distributed standard normal variables. The vector of residuals $\\mathbf{r} = [r_1, r_2, \\ldots, r_G]^\\top$ is thus approximately distributed as a multivariate standard normal, $\\mathbf{r} \\sim \\mathcal{N}(\\mathbf{0}, I_G)$, where $I_G$ is the $G \\times G$ identity matrix.\n\nBased on these residuals, two test statistics are constructed:\n\n**a. Total Overdispersion Statistic ($T$)**: This statistic measures the total magnitude of deviation across all genes. It is defined as the sum of the squared residuals:\n$$\nT = \\sum_{g=1}^G r_g^2\n$$\nBy definition, the sum of squares of $G$ independent standard normal random variables follows a chi-square distribution with $G$ degrees of freedom. Therefore, under $H_0$, the statistic $T$ is approximately chi-square distributed: $T \\sim \\chi^2(G)$. A large value of $T$ suggests that the observed counts are more variable than predicted by the singlet model, which could be a sign of a doublet.\n\n**b. Directional Coexpression Statistic ($U$)**: A doublet formed from two distinct cell types (e.g., type A and type B) is expected to have an expression profile that is a mixture of the two constituent profiles. If the baseline profiles are $\\boldsymbol{\\mu}_A$ and $\\boldsymbol{\\mu}_B$, the deviation from a generic singlet profile $\\boldsymbol{\\mu}$ will be concentrated along the direction of the difference vector, $\\boldsymbol{\\mu}_A - \\boldsymbol{\\mu}_B$. This represents a specific \"rank-1\" coexpression pattern. The vector $\\mathbf{v}$ in the problem statement represents this known directional perturbation.\n\nTo test for deviation specifically along this direction, we project the residual vector $\\mathbf{r}$ onto the unit vector in the direction of $\\mathbf{v}$, which is $\\mathbf{v}/\\|\\mathbf{v}\\|_2$. The projected value is a scalar given by the dot product: $\\frac{\\mathbf{v}^\\top \\mathbf{r}}{\\|\\mathbf{v}\\|_2}$. Since $\\mathbf{r} \\sim \\mathcal{N}(\\mathbf{0}, I_G)$, this projection, being a linear combination of independent normal variables, is also normally distributed. Its mean is $E[\\frac{\\mathbf{v}^\\top \\mathbf{r}}{\\|\\mathbf{v}\\|_2}] = \\frac{\\mathbf{v}^\\top E[\\mathbf{r}]}{\\|\\mathbf{v}\\|_2} = 0$. Its variance is $V[\\frac{\\mathbf{v}^\\top \\mathbf{r}}{\\|\\mathbf{v}\\|_2}] = \\frac{1}{\\|\\mathbf{v}\\|_2^2} V[\\mathbf{v}^\\top \\mathbf{r}] = \\frac{1}{\\|\\mathbf{v}\\|_2^2} \\mathbf{v}^\\top \\text{Cov}(\\mathbf{r}) \\mathbf{v} = \\frac{1}{\\|\\mathbf{v}\\|_2^2} \\mathbf{v}^\\top I_G \\mathbf{v} = \\frac{\\|\\mathbf{v}\\|_2^2}{\\|\\mathbf{v}\\|_2^2} = 1$.\nThus, under $H_0$, the projection is a standard normal variable. The directional statistic $U$ is the square of this projection:\n$$\nU = \\left(\\frac{\\mathbf{v}^\\top \\mathbf{r}}{\\|\\mathbf{v}\\|_2}\\right)^2\n$$\nAs the square of a single standard normal variable, $U$ follows a chi-square distribution with $1$ degree of freedom under $H_0$: $U \\sim \\chi^2(1)$. A large value of $U$ indicates a strong deviation from the singlet model specifically along the predefined doublet direction $\\mathbf{v}$. If $\\mathbf{v} = \\mathbf{0}$, no direction is specified. In this case, the directional projection is undefined, but logically corresponds to a test with no power. We interpret this as $U=0$, which yields a p-value of $1$, correctly indicating no evidence against $H_0$ from this test.\n\n**3. Decision Rule and Implementation**\n\nTo decide whether a cell is a doublet, we assess how unlikely the observed statistics $T$ and $U$ are under the singlet null hypothesis. This is done by calculating p-values, which are the probabilities of observing a test statistic at least as extreme as the one computed. These are found using the survival function (1 - CDF) of the respective chi-square distributions.\n\n- The general overdispersion p-value is $p_{\\mathrm{gen}} = P(T'  T \\mid T' \\sim \\chi^2(G))$.\n- The directional coexpression p-value is $p_{\\mathrm{dir}} = P(U'  U \\mid U' \\sim \\chi^2(1))$.\n\nThe final decision rule is to classify the cell as a doublet if either p-value falls below a given significance level $\\alpha$:\n$$\n\\text{classify as doublet if } (p_{\\mathrm{gen}}  \\alpha) \\text{ or } (p_{\\mathrm{dir}}  \\alpha)\n$$\nThe algorithm proceeds as follows for each cell:\n1.  Given the input parameters $G$, $\\boldsymbol{\\mu}$, $\\boldsymbol{\\phi}$, $L$, $\\mathbf{x}$, $\\mathbf{v}$, and $\\alpha$.\n2.  Compute the vector of expected counts: $\\mathbf{E} = L\\boldsymbol{\\mu}$.\n3.  Compute the vector of variances: $\\mathbf{Var} = \\mathbf{E} + \\boldsymbol{\\phi} \\circ (\\mathbf{E} \\circ \\mathbf{E})$, where $\\circ$ denotes element-wise multiplication.\n4.  Compute the vector of residuals: $\\mathbf{r} = (\\mathbf{x} - \\mathbf{E}) / \\sqrt{\\mathbf{Var}}$.\n5.  Calculate the statistic $T = \\sum_{g=1}^G r_g^2 = \\|\\mathbf{r}\\|_2^2$.\n6.  Calculate the p-value $p_{\\mathrm{gen}}$ from the survival function of a $\\chi^2(G)$ distribution.\n7.  Check if $\\mathbf{v} = \\mathbf{0}$. If so, set $U=0$. Otherwise, calculate $U = (\\mathbf{v}^\\top \\mathbf{r} / \\|\\mathbf{v}\\|_2)^2$.\n8.  Calculate the p-value $p_{\\mathrm{dir}}$ from the survival function of a $\\chi^2(1)$ distribution.\n9.  Return `True` (doublet) if $p_{\\mathrm{gen}}  \\alpha$ or $p_{\\mathrm{dir}}  \\alpha$, and `False` (singlet) otherwise. This procedure is implemented for the provided test cases.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import chi2\n\ndef solve():\n    \"\"\"\n    Implements the doublet detection logic for a suite of test cases.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case 1 (happy path singlet)\n        {\n            \"G\": 5, \"mu\": [8, 3, 1, 5, 2], \"phi\": [0, 0, 0, 0, 0],\n            \"L\": 1, \"x\": [8, 3, 1, 5, 2], \"v\": [0, 0, 0, 0, 0], \"alpha\": 0.01\n        },\n        # Case 2 (distinct-type doublet with strong coexpression)\n        {\n            \"G\": 5, \"mu\": [8, 3, 1, 5, 2], \"phi\": [0, 0, 0, 0, 0],\n            \"L\": 2, \"x\": [10, 10, 2, 7, 8], \"v\": [-8, 9, 1, -4, 10], \"alpha\": 0.01\n        },\n        # Case 3 (same-type doublet boundary)\n        {\n            \"G\": 5, \"mu\": [8, 3, 1, 5, 2], \"phi\": [0, 0, 0, 0, 0],\n            \"L\": 2, \"x\": [16, 6, 2, 10, 4], \"v\": [0, 0, 0, 0, 0], \"alpha\": 0.01\n        },\n        # Case 4 (Negative Binomial dispersion absorbs moderate deviations)\n        {\n            \"G\": 5, \"mu\": [8, 3, 1, 5, 2], \"phi\": [0.5, 0.5, 0.5, 0.5, 0.5],\n            \"L\": 1, \"x\": [9, 5, 0, 3, 4], \"v\": [0, 0, 0, 0, 0], \"alpha\": 0.01\n        },\n        # Case 5 (directional coexpression detectable while global overdispersion is modest)\n        {\n            \"G\": 5, \"mu\": [8, 3, 1, 5, 2], \"phi\": [0, 0, 0, 0, 0],\n            \"L\": 1, \"x\": [4, 6, 1, 3, 5], \"v\": [-8, 9, 1, -4, 10], \"alpha\": 0.01\n        },\n    ]\n\n    results = []\n    for case in test_cases:\n        # Unpack parameters and convert to numpy arrays for vectorized operations\n        G = case[\"G\"]\n        mu = np.array(case[\"mu\"], dtype=float)\n        phi = np.array(case[\"phi\"], dtype=float)\n        L = float(case[\"L\"])\n        x = np.array(case[\"x\"], dtype=float)\n        v = np.array(case[\"v\"], dtype=float)\n        alpha = float(case[\"alpha\"])\n\n        # Step 1: Calculate expected counts and variance\n        # E[x_g] = L * mu_g\n        expected_counts = L * mu\n        # V[x_g] = L*mu_g + phi_g * (L*mu_g)^2\n        variance = expected_counts + phi * (expected_counts**2)\n        \n        # Denominator should not be zero since L  0 and mu_g  0\n        std_dev = np.sqrt(variance)\n\n        # Step 2: Calculate Pearson-type residuals\n        # r_g = (x_g - E[x_g]) / sqrt(V[x_g])\n        r = (x - expected_counts) / std_dev\n\n        # Step 3: Calculate the total overdispersion statistic T\n        # T = sum(r_g^2)\n        T_stat = np.sum(r**2)\n        \n        # Step 4: Calculate the p-value for T\n        # T ~ chi^2(G) under the null hypothesis.\n        p_gen = chi2.sf(T_stat, df=G)\n\n        # Step 5: Calculate the directional statistic U\n        v_norm = np.linalg.norm(v)\n        \n        U_stat = 0.0\n        # If v is the zero vector, the directional test is not applicable.\n        # U = 0, which corresponds to p_dir = 1.\n        if v_norm  0:\n            # U = (v^T * r / ||v||)^2\n            U_stat = (np.dot(v, r) / v_norm)**2\n            \n        # Step 6: Calculate the p-value for U\n        # U ~ chi^2(1) under the null hypothesis.\n        p_dir = chi2.sf(U_stat, df=1)\n\n        # Step 7: Apply the decision rule\n        # Classify as doublet if either p-value is less than alpha\n        is_doublet = (p_gen  alpha) or (p_dir  alpha)\n        results.append(is_doublet)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```", "id": "4378827"}, {"introduction": "The high frequency of zero counts is a defining feature of single-cell transcriptome data, leading to a long-standing debate on the appropriate statistical models. This exercise challenges the common assumption that these zeros necessitate a \"zero-inflated\" model, demonstrating instead how a more parsimonious Negative Binomial distribution naturally arises from a hierarchical model of biological and technical variation [@problem_id:4378811]. By deriving the model's properties from first principles, you will gain a deeper intuition for why it effectively captures the key statistical features of UMI-based data.", "problem": "Consider a single gene measured in single-cell ribonucleic acid sequencing (single-cell RNA-seq) using Unique Molecular Identifiers (UMI). Under UMI-based protocols, deduplication ensures each captured messenger ribonucleic acid (mRNA) molecule contributes at most one count, so the observed count for a gene in a cell can be modeled as a sampling outcome. A core, well-tested modeling approach in systems biomedicine for UMI counts is the following hierarchical model: conditional on a latent expression intensity, the observed count is a Poisson sample, and the latent intensity varies across cells due to biological heterogeneity. Specifically, let the observed UMI count for the gene in a randomly chosen cell be $Y$, and the latent intensity be $\\Lambda$. Assume $Y \\mid \\Lambda \\sim \\operatorname{Poisson}(\\Lambda)$, and the latent intensity follows a gamma distribution $\\Lambda \\sim \\operatorname{Gamma}(\\theta, \\text{rate}=\\theta/\\mu)$ so that $\\mathbb{E}[\\Lambda] = \\mu$ and $\\operatorname{Var}[\\Lambda] = \\mu^{2}/\\theta$. This gamma-Poisson mixture produces a negative binomial marginal for $Y$ with mean $\\mu$ and variance $\\mu + \\mu^{2}/\\theta$.\n\nUsing only these fundamental definitions and the hierarchical structure described above, provide a first-principles argument for why explicit zero inflation is often unnecessary for UMI data under appropriate models, addressing the origin of zeros as sampling zeros and how the gamma-Poisson mixture naturally captures both mean-variance structure and zero frequency without an additional zero-generating mechanism. Then, derive the closed-form expression for the marginal probability of observing a zero count, $\\mathbb{P}(Y = 0)$, in terms of the parameters $\\mu$ and $\\theta$ under the gamma-Poisson model specified.\n\nYour final answer must be the single analytic expression for $\\mathbb{P}(Y = 0)$. No numerical approximation is required, and no units are needed.", "solution": "The modeling of Unique Molecular Identifier (UMI) counts in single-cell ribonucleic acid sequencing (single-cell RNA-seq) leverages key properties of the protocol: polymerase chain reaction (PCR) amplification bias is mitigated by deduplication, and each captured messenger ribonucleic acid (mRNA) molecule contributes at most one count. This supports the use of a Poisson sampling model for the observed counts conditional on a latent intensity. Biological heterogeneity between cells, including cell state variability, transcriptional bursting, and differences in effective capture efficiency, induces variation in the latent intensity. A widely accepted and well-tested representation of this heterogeneity is a gamma distribution on the latent intensity, producing a gamma-Poisson mixture (also called a negative binomial marginal). These modeling choices are aligned with the central dogma in that captured mRNA molecules reflect gene expression levels, and with statistical descriptions of counting processes under sampling variability.\n\nTo argue why explicit zero inflation is often unnecessary for UMI data, observe that zeros arise naturally under Poisson sampling when the latent intensity is small. Under UMI protocols, the deduplicated counts approximate a true sampling process where each molecule has a small probability of being captured and counted. Conditional on the latent intensity $\\Lambda$, the probability of a zero is\n$$\n\\mathbb{P}(Y = 0 \\mid \\Lambda) = \\exp(-\\Lambda).\n$$\nTherefore, even without any additional zero-generating mechanism, cells with low $\\Lambda$ will frequently produce zeros as sampling zeros. When $\\Lambda$ itself varies across cells according to a gamma distribution, the marginal probability of a zero integrates over this heterogeneity. The gamma-Poisson mixture consequently produces both overdispersion (variance exceeding the mean) and elevated zero frequencies consistent with empirical UMI data, obviating the need for an explicit zero-inflation component. In contrast, zero-inflated models introduce a separate process that generates structural zeros, which is generally unnecessary when the sampling plus heterogeneity mechanism already accounts for observed zero rates, provided appropriate offsets and covariates (such as library size or cell-specific depth) are included in the model. Empirical studies have shown that under UMI protocols, negative binomial models with cell- and gene-specific normalization often match the zero frequencies without zero inflation.\n\nWe now derive the closed-form expression for the marginal zero probability $\\mathbb{P}(Y=0)$ under the specified gamma-Poisson model. Let $Y \\mid \\Lambda \\sim \\operatorname{Poisson}(\\Lambda)$ and $\\Lambda \\sim \\operatorname{Gamma}(\\theta, \\text{rate}=\\theta/\\mu)$, so the probability density function of $\\Lambda$ is\n$$\nf_{\\Lambda}(\\lambda) = \\frac{(\\theta/\\mu)^{\\theta}}{\\Gamma(\\theta)} \\lambda^{\\theta - 1} \\exp\\!\\left(-\\frac{\\theta}{\\mu}\\lambda\\right), \\quad \\lambda  0.\n$$\nThe marginal zero probability is the expectation of the conditional zero probability with respect to the gamma distribution:\n$$\n\\mathbb{P}(Y = 0) = \\mathbb{E}\\big[\\exp(-\\Lambda)\\big] = \\int_{0}^{\\infty} \\exp(-\\lambda) \\, f_{\\Lambda}(\\lambda) \\, d\\lambda.\n$$\nSubstituting the gamma density,\n$$\n\\mathbb{P}(Y = 0) = \\int_{0}^{\\infty} \\exp(-\\lambda) \\, \\frac{(\\theta/\\mu)^{\\theta}}{\\Gamma(\\theta)} \\lambda^{\\theta - 1} \\exp\\!\\left(-\\frac{\\theta}{\\mu}\\lambda\\right) d\\lambda = \\frac{(\\theta/\\mu)^{\\theta}}{\\Gamma(\\theta)} \\int_{0}^{\\infty} \\lambda^{\\theta - 1} \\exp\\!\\left(-\\left[1 + \\frac{\\theta}{\\mu}\\right]\\lambda\\right) d\\lambda.\n$$\nRecognize the integral as the gamma integral with a scaling factor. For $c  0$ and $\\alpha  0$,\n$$\n\\int_{0}^{\\infty} \\lambda^{\\alpha - 1} \\exp(-c \\lambda) \\, d\\lambda = \\frac{\\Gamma(\\alpha)}{c^{\\alpha}}.\n$$\nSetting $\\alpha = \\theta$ and $c = 1 + \\theta/\\mu$, we obtain\n$$\n\\int_{0}^{\\infty} \\lambda^{\\theta - 1} \\exp\\!\\left(-\\left[1 + \\frac{\\theta}{\\mu}\\right]\\lambda\\right) d\\lambda = \\frac{\\Gamma(\\theta)}{\\left(1 + \\frac{\\theta}{\\mu}\\right)^{\\theta}}.\n$$\nTherefore,\n$$\n\\mathbb{P}(Y = 0) = \\frac{(\\theta/\\mu)^{\\theta}}{\\Gamma(\\theta)} \\cdot \\frac{\\Gamma(\\theta)}{\\left(1 + \\frac{\\theta}{\\mu}\\right)^{\\theta}} = \\left(\\frac{\\theta/\\mu}{1 + \\theta/\\mu}\\right)^{\\theta} = \\left(\\frac{\\theta}{\\theta + \\mu}\\right)^{\\theta}.\n$$\nEquivalently, using the identity $\\left(\\frac{\\theta}{\\theta + \\mu}\\right)^{\\theta} = \\left(1 + \\frac{\\mu}{\\theta}\\right)^{-\\theta}$, we have\n$$\n\\mathbb{P}(Y = 0) = \\left(1 + \\frac{\\mu}{\\theta}\\right)^{-\\theta}.\n$$\nThis matches the probability of zero for a negative binomial parameterization with number of failures $r = \\theta$ and success probability $p = \\theta/(\\theta + \\mu)$, under which $\\mathbb{P}(Y = 0) = p^{r}$. The derivation from the gamma-Poisson mixture shows that elevated zero frequency is an intrinsic property of the model, providing a principled reason why explicit zero inflation is often unnecessary for UMI data when appropriate normalization and covariates are included.", "answer": "$$\\boxed{\\left(\\frac{\\theta}{\\theta+\\mu}\\right)^{\\theta}}$$", "id": "4378811"}]}