{"hands_on_practices": [{"introduction": "A cornerstone of systems pharmacology is understanding how macroscopic, phenomenological models emerge from microscopic, mechanistic principles. This first practice grounds the widely used $E_{\\max}$ model in the fundamental theory of receptor-ligand binding. By deriving the relationship between drug concentration and effect from the law of mass action, you will solidify your understanding of how biophysical interactions at the molecular level give rise to the observable dose-response curve [@problem_id:4374362].", "problem": "A drug produces a biomarker response in a target tissue modeled within a Physiologically Based Pharmacokinetic (PBPK) framework, where the effect-site concentration is assumed equal to the central plasma concentration due to rapid effect-site equilibration. The pharmacodynamic transduction is governed by receptor binding and subsequent signal generation. Consider a single receptor class with reversible ligand binding under mass-action kinetics: the free receptor concentration is denoted by $R$, the free ligand (drug) concentration by $L$, and the receptor-ligand complex concentration by $RL$. The association and dissociation rate constants are $k_{\\text{on}}$ and $k_{\\text{off}}$, respectively. At equilibrium, the dissociation constant $K_{D}$ satisfies $K_{D} = \\frac{k_{\\text{off}}}{k_{\\text{on}}} = \\frac{R \\, L}{RL}$. The total receptor concentration is $R_{\\text{tot}} = R + RL$. Assume non-cooperative binding and linear transduction: the fractional occupancy is the fraction of receptors bound, and the observed effect $E$ is proportional to receptor occupancy with proportionality constant equal to the maximal effect $E_{\\max}$. In addition, the concentration at half-maximal effect $EC_{50}$ is defined as the $L$ that yields $E = \\frac{E_{\\max}}{2}$.\n\nA population variant is observed in which the maximal transduction capacity is $E_{\\max} = 100$ units, the potency parameter $EC_{50} = 2$ mg/L, and the Hill coefficient $n = 1$. Using these biophysical definitions and assumptions, derive the steady-state input–output relationship $E$ as a function of the concentration $C$ (identify $C$ with $L$), and then compute the values of $E$ at $C = 1$ mg/L, $C = 2$ mg/L, and $C = 8$ mg/L.\n\nRound your numerical results to four significant figures. Express the final effect in units of \"units\". Provide your final answer as a row vector of the three effect values in the order corresponding to $C = 1$, $C = 2$, and $C = 8$ mg/L.", "solution": "The problem requires the derivation of a steady-state pharmacodynamic model and its application to compute specific biomarker responses. The validation of the problem statement is the mandatory first step.\n\n### Problem Validation\n\n**Step 1: Extract Givens**\n-   Pharmacodynamic model framework: Physiologically Based Pharmacokinetic (PBPK).\n-   Effect-site concentration: Assumed equal to central plasma concentration ($C_e = C_p$), which is denoted as $L$ and then as $C$.\n-   Receptor binding kinetics: Reversible, mass-action.\n-   Variables: Free receptor concentration ($R$), free ligand concentration ($L$), receptor-ligand complex concentration ($RL$).\n-   Rate constants: Association ($k_{\\text{on}}$), dissociation ($k_{\\text{off}}$).\n-   Equilibrium dissociation constant: $K_{D} = \\frac{k_{\\text{off}}}{k_{\\text{on}}} = \\frac{R \\, L}{RL}$.\n-   Total receptor concentration: $R_{\\text{tot}} = R + RL$.\n-   Binding characteristics: Non-cooperative.\n-   Transduction model: Linear, effect $E$ is proportional to receptor occupancy.\n-   Proportionality constant: Maximal effect, $E_{\\max}$.\n-   Potency parameter: $EC_{50}$ is the ligand concentration $L$ that yields $E = \\frac{E_{\\max}}{2}$.\n-   Population variant parameters: $E_{\\max} = 100$ units, $EC_{50} = 2$ mg/L, Hill coefficient $n = 1$.\n-   Task: Derive the relationship $E(C)$ and compute $E$ for $C = 1$ mg/L, $C = 2$ mg/L, and $C = 8$ mg/L.\n-   Rounding: Results must be rounded to four significant figures.\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded:** The problem is based on classical receptor theory and the principles of pharmacodynamics. The use of mass-action kinetics, the definition of the dissociation constant $K_D$, the concept of receptor occupancy, and the simple Emax model are all standard and fundamental concepts in pharmacology and systems biomedicine. The problem is scientifically sound.\n-   **Well-Posed:** The problem statement is self-contained. It provides a clear set of definitions and parameters ($E_{\\max}$, $EC_{50}$, $n=1$) and asks for a specific derivation followed by numerical calculations. The information is sufficient to arrive at a unique solution. The consistency between the mechanistic description (non-cooperative binding) and the phenomenological parameter (Hill coefficient $n=1$) confirms the problem's internal logic.\n-   **Objective:** The problem is stated using precise, unambiguous scientific language. There are no subjective or opinion-based elements.\n\n**Step 3: Verdict and Action**\nThe problem is valid. It is scientifically grounded, well-posed, objective, and internally consistent. The solution process can proceed.\n\n### Solution Derivation and Calculation\n\nThe problem asks for the derivation of the steady-state input-output relationship, $E(C)$, based on the provided biophysical principles.\n\nThe observed effect, $E$, is stated to be linearly proportional to the fractional receptor occupancy, with the maximal effect, $E_{\\max}$, as the constant of proportionality. The fractional occupancy, which we can denote as $\\theta$, is the ratio of the concentration of bound receptors ($RL$) to the total receptor concentration ($R_{\\text{tot}}$).\n$$E = E_{\\max} \\cdot \\theta = E_{\\max} \\cdot \\frac{RL}{R_{\\text{tot}}}$$\nTo find an expression for $\\theta$ as a function of ligand concentration $L$, we use the equilibrium condition and the conservation of receptors.\nThe total receptor concentration is the sum of free and bound receptors:\n$$R_{\\text{tot}} = R + RL \\implies R = R_{\\text{tot}} - RL$$\nAt equilibrium, the dissociation constant $K_{D}$ is given by:\n$$K_{D} = \\frac{R \\cdot L}{RL}$$\nSubstituting the expression for $R$ into the equation for $K_{D}$:\n$$K_{D} = \\frac{(R_{\\text{tot}} - RL) \\cdot L}{RL}$$\nWe now solve this equation for the complex concentration $RL$:\n$$K_{D} \\cdot RL = (R_{\\text{tot}} - RL) \\cdot L = R_{\\text{tot}} \\cdot L - RL \\cdot L$$\n$$K_{D} \\cdot RL + RL \\cdot L = R_{\\text{tot}} \\cdot L$$\n$$RL \\cdot (K_{D} + L) = R_{\\text{tot}} \\cdot L$$\n$$RL = \\frac{R_{\\text{tot}} \\cdot L}{K_{D} + L}$$\nNow, we can determine the fractional occupancy $\\theta$:\n$$\\theta = \\frac{RL}{R_{\\text{tot}}} = \\frac{1}{R_{\\text{tot}}} \\left( \\frac{R_{\\text{tot}} \\cdot L}{K_{D} + L} \\right) = \\frac{L}{K_{D} + L}$$\nSubstituting this expression for $\\theta$ back into the equation for the effect $E$:\n$$E(L) = E_{\\max} \\cdot \\frac{L}{K_{D} + L}$$\nThe problem defines $EC_{50}$ as the concentration $L$ at which the effect is half-maximal, i.e., $E(L=EC_{50}) = \\frac{E_{\\max}}{2}$. We use this definition to relate $K_{D}$ to $EC_{50}$.\n$$\\frac{E_{\\max}}{2} = E_{\\max} \\cdot \\frac{EC_{50}}{K_{D} + EC_{50}}$$\nAssuming $E_{\\max} \\neq 0$, we can divide both sides by $E_{\\max}$:\n$$\\frac{1}{2} = \\frac{EC_{50}}{K_{D} + EC_{50}}$$\n$$K_{D} + EC_{50} = 2 \\cdot EC_{50}$$\n$$K_{D} = EC_{50}$$\nThis shows that for a simple non-cooperative binding model, the microscopic dissociation constant $K_D$ is equivalent to the macroscopic potency parameter $EC_{50}$.\n\nBy identifying the ligand concentration $L$ with the general drug concentration $C$, the final steady-state input-output relationship is:\n$$E(C) = E_{\\max} \\frac{C}{EC_{50} + C}$$\nThis equation is the standard simple $E_{\\max}$ model, which is a specific form of the Hill equation $E(C) = \\frac{E_{\\max} \\cdot C^n}{EC_{50}^n + C^n}$ with the Hill coefficient $n=1$. The problem's given value of $n=1$ is consistent with this derivation from first principles of non-cooperative binding.\n\nNow, we compute the values of $E$ for the given concentrations using the provided parameters: $E_{\\max} = 100$ units and $EC_{50} = 2$ mg/L.\nThe model is:\n$$E(C) = 100 \\frac{C}{2 + C}$$\n\n1.  For $C = 1$ mg/L:\n    $$E(1) = 100 \\cdot \\frac{1}{2 + 1} = 100 \\cdot \\frac{1}{3} = 33.333... \\text{ units}$$\n    Rounding to four significant figures, we get $E(1) = 33.33$ units.\n\n2.  For $C = 2$ mg/L:\n    $$E(2) = 100 \\cdot \\frac{2}{2 + 2} = 100 \\cdot \\frac{2}{4} = 100 \\cdot \\frac{1}{2} = 50 \\text{ units}$$\n    As expected, at $C = EC_{50}$, the effect is exactly half of $E_{\\max}$.\n    Expressing this with four significant figures gives $E(2) = 50.00$ units.\n\n3.  For $C = 8$ mg/L:\n    $$E(8) = 100 \\cdot \\frac{8}{2 + 8} = 100 \\cdot \\frac{8}{10} = 80 \\text{ units}$$\n    Expressing this with four significant figures gives $E(8) = 80.00$ units.\n\nThe computed values for the effect $E$ at concentrations $C=1$, $C=2$, and $C=8$ mg/L are $33.33$, $50.00$, and $80.00$ units, respectively.", "answer": "$$\n\\boxed{\\begin{pmatrix} 33.33 & 50.00 & 80.00 \\end{pmatrix}}\n$$", "id": "4374362"}, {"introduction": "Moving beyond static models, we now consider a dynamic signaling pathway where drug action propagates through a series of molecular events. A critical task in analyzing such systems is to identify which parameters have the greatest influence on the final output. This computational exercise introduces you to elasticity analysis, a form of sensitivity analysis, to quantify how a change in each pathway parameter—from binding rates to protein degradation—affects the overall drug efficacy [@problem_id:4378068]. This technique is invaluable for identifying the most potent targets for intervention and for understanding the robustness of biological systems.", "problem": "Consider a minimal pharmacodynamic (PD) signaling module in systems pharmacology that maps a drug-receptor interaction to a downstream effect through mass-action kinetics and a saturable transduction. Let a drug at concentration $D$ bind a receptor with total concentration $R_{\\mathrm{tot}}$ to form a complex $C$, parameterized by an association rate $k_{\\mathrm{on}}$ and a dissociation rate $k_{\\mathrm{off}}$. The complex activates an effector species $X$ with production rate $k_{\\mathrm{cat}}$ and degradation rate $k_{\\mathrm{deg}}$. The downstream effect $E$ is a saturable function of $X$ with a maximal effect $E_{\\max}$ and a half-saturation constant $EC_{50}$. All quantities are assumed positive and constant in time except for the dynamic variables $C$ and $X$. Assume drug concentration $D$ is not depleted and remains constant.\n\nStarting from the law of mass action and conservation of receptor, the ordinary differential equations (ODEs) for the system are:\n$$\n\\frac{dC}{dt} = k_{\\mathrm{on}}\\, D\\, (R_{\\mathrm{tot}} - C) - k_{\\mathrm{off}}\\, C,\n$$\n$$\n\\frac{dX}{dt} = k_{\\mathrm{cat}}\\, C - k_{\\mathrm{deg}}\\, X.\n$$\nThe downstream effect is modeled as:\n$$\nE(X) = \\frac{E_{\\max}\\, X}{EC_{50} + X}.\n$$\nYou must compute, at steady state, the dimensionless elasticity (normalized sensitivity) of the effect $E$ with respect to each pathway parameter $p \\in \\{k_{\\mathrm{on}}, k_{\\mathrm{off}}, R_{\\mathrm{tot}}, D, k_{\\mathrm{cat}}, k_{\\mathrm{deg}}, E_{\\max}, EC_{50}\\}$, defined by:\n$$\n\\mathcal{S}_p = \\frac{\\partial E}{\\partial p}\\cdot\\frac{p}{E},\n$$\nevaluated at the steady-state effect $E^\\ast$ under the given parameter set.\n\nTo ensure numerical stability and general applicability, estimate $\\frac{\\partial E}{\\partial p}$ using a central finite difference with a small multiplicative perturbation $h$ applied to parameter $p$:\n- Use $h = 10^{-6}$.\n- For each parameter $p$, evaluate $E$ at $p(1+h)$ and $p(1-h)$, keeping all other parameters fixed.\n- Use the central difference approximation for the elasticity under multiplicative perturbation, which simplifies to:\n$$\n\\mathcal{S}_p \\approx \\frac{E\\big|_{p(1+h)} - E\\big|_{p(1-h)}}{2\\,h\\,E\\big|_{p}}.\n$$\n\nUnits:\n- $D$ and $R_{\\mathrm{tot}}$ are in nanomolar (nM).\n- $k_{\\mathrm{on}}$ is in $(\\mathrm{nM}\\cdot \\mathrm{s})^{-1}$.\n- $k_{\\mathrm{off}}$, $k_{\\mathrm{cat}}$, and $k_{\\mathrm{deg}}$ are in $\\mathrm{s}^{-1}$.\n- $X$ and $EC_{50}$ are in nM.\n- $E_{\\max}$ and $E$ are in arbitrary effect units (a.u.).\nYour computed elasticities $\\mathcal{S}_p$ are dimensionless.\n\nFor reference, the steady state is defined by $dC/dt = 0$ and $dX/dt = 0$ under the given ODEs. No explicit formulas are provided; derive all needed quantities from first principles.\n\nImplement a program that, for each parameter set in the test suite below, computes the list of elasticities $[\\mathcal{S}_{k_{\\mathrm{on}}}, \\mathcal{S}_{k_{\\mathrm{off}}}, \\mathcal{S}_{R_{\\mathrm{tot}}}, \\mathcal{S}_{D}, \\mathcal{S}_{k_{\\mathrm{cat}}}, \\mathcal{S}_{k_{\\mathrm{deg}}}, \\mathcal{S}_{E_{\\max}}, \\mathcal{S}_{EC_{50}}]$ and the index (integer) of the parameter with the largest absolute elasticity in that list, where indices follow the parameter ordering as just listed (starting at $0$).\n\nTest suite (each case is an ordered tuple of parameters $(k_{\\mathrm{on}}, k_{\\mathrm{off}}, R_{\\mathrm{tot}}, D, k_{\\mathrm{cat}}, k_{\\mathrm{deg}}, E_{\\max}, EC_{50})$):\n1. Nominal operating regime (happy path): $(1.0\\times 10^{-3}, 1.0\\times 10^{-2}, 100.0, 50.0, 0.5, 0.1, 1.0, 20.0)$.\n2. Saturating drug concentration: $(1.0\\times 10^{-3}, 1.0\\times 10^{-2}, 100.0, 10000.0, 0.5, 0.1, 1.0, 20.0)$.\n3. Low receptor availability boundary: $(1.0\\times 10^{-3}, 1.0\\times 10^{-2}, 1.0, 50.0, 0.5, 0.1, 1.0, 20.0)$.\n4. Fast effector turnover boundary: $(1.0\\times 10^{-3}, 1.0\\times 10^{-2}, 100.0, 50.0, 0.5, 10.0, 1.0, 20.0)$.\n\nFinal output format:\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets. Each test case’s result must itself be a list containing the eight elasticities in the specified order followed by the integer index of the parameter with largest absolute elasticity. For example:\n\"[[e11,e12,e13,e14,e15,e16,e17,e18,i1],[e21,e22,e23,e24,e25,e26,e27,e28,i2],...]\".\nAll numeric outputs must be raw decimal floats without any units attached. Angles are not involved. Percentages are not involved.", "solution": "The user-provided problem statement has been meticulously validated and is determined to be **valid**. It is scientifically grounded, self-contained, and well-posed. The task is to compute the dimensionless elasticity of a pharmacodynamic (PD) effect with respect to its underlying model parameters at steady state.\n\nThe solution proceeds in two main stages: first, the derivation of the steady-state expressions for the system's variables, and second, the design of a numerical algorithm to compute the required elasticities.\n\n### 1. Steady-State Analysis of the Pharmacodynamic Model\n\nThe system is described by a set of two coupled ordinary differential equations (ODEs) for the concentrations of the drug-receptor complex, $C$, and the downstream effector, $X$.\n\nThe first ODE governs the formation and dissociation of the drug-receptor complex $C$:\n$$\n\\frac{dC}{dt} = k_{\\mathrm{on}}\\, D\\, (R_{\\mathrm{tot}} - C) - k_{\\mathrm{off}}\\, C\n$$\nAt steady state, the rate of change is zero, $\\frac{dC}{dt} = 0$. We solve for the steady-state concentration $C^\\ast$:\n$$\nk_{\\mathrm{on}}\\, D\\, (R_{\\mathrm{tot}} - C^\\ast) - k_{\\mathrm{off}}\\, C^\\ast = 0\n$$\n$$\nk_{\\mathrm{on}}\\, D\\, R_{\\mathrm{tot}} - k_{\\mathrm{on}}\\, D\\, C^\\ast - k_{\\mathrm{off}}\\, C^\\ast = 0\n$$\n$$\nk_{\\mathrm{on}}\\, D\\, R_{\\mathrm{tot}} = (k_{\\mathrm{on}}\\, D + k_{\\mathrm{off}})\\, C^\\ast\n$$\nIsolating $C^\\ast$ yields:\n$$\nC^\\ast = \\frac{k_{\\mathrm{on}}\\, D\\, R_{\\mathrm{tot}}}{k_{\\mathrm{on}}\\, D + k_{\\mathrm{off}}}\n$$\nThis expression can be simplified by introducing the equilibrium dissociation constant $K_D = k_{\\mathrm{off}}/k_{\\mathrm{on}}$, giving the familiar Hill-Langmuir equation for receptor occupancy:\n$$\nC^\\ast = \\frac{R_{\\mathrm{tot}}\\, D}{K_D + D}\n$$\n\nThe second ODE describes the turnover of the effector species $X$, which is produced at a rate proportional to $C$ and undergoes first-order degradation:\n$$\n\\frac{dX}{dt} = k_{\\mathrm{cat}}\\, C - k_{\\mathrm{deg}}\\, X\n$$\nAt steady state, $\\frac{dX}{dt} = 0$, so we can solve for the steady-state concentration $X^\\ast$ using the previously found $C^\\ast$:\n$$\nk_{\\mathrm{cat}}\\, C^\\ast - k_{\\mathrm{deg}}\\, X^\\ast = 0\n$$\n$$\nX^\\ast = \\frac{k_{\\mathrm{cat}}}{k_{\\mathrm{deg}}}\\, C^\\ast\n$$\nSubstituting the expression for $C^\\ast$:\n$$\nX^\\ast = \\frac{k_{\\mathrm{cat}}}{k_{\\mathrm{deg}}} \\left( \\frac{k_{\\mathrm{on}}\\, D\\, R_{\\mathrm{tot}}}{k_{\\mathrm{on}}\\, D + k_{\\mathrm{off}}} \\right)\n$$\n\nFinally, the downstream biological effect $E$ is a saturable function of $X$, given by:\n$$\nE(X) = \\frac{E_{\\max}\\, X}{EC_{50} + X}\n$$\nThe steady-state effect, $E^\\ast$, is found by substituting $X^\\ast$ into this equation:\n$$\nE^\\ast = \\frac{E_{\\max}\\, X^\\ast}{EC_{50} + X^\\ast}\n$$\nThis composite function for $E^\\ast$ provides a complete analytical mapping from the set of all parameters $p \\in \\{k_{\\mathrm{on}}, k_{\\mathrm{off}}, R_{\\mathrm{tot}}, D, k_{\\mathrm{cat}}, k_{\\mathrm{deg}}, E_{\\max}, EC_{50}\\}$ to the steady-state system output. This function is the computational core of our analysis.\n\n### 2. Numerical Elasticity Calculation\n\nThe problem requires the calculation of the dimensionless elasticity (or normalized sensitivity) of the effect $E$ with respect to each parameter $p$. The elasticity, $\\mathcal{S}_p$, is defined as the fractional change in $E$ for a fractional change in $p$:\n$$\n\\mathcal{S}_p = \\frac{\\partial E}{\\partial p}\\cdot\\frac{p}{E} = \\frac{\\partial \\ln E}{\\partial \\ln p}\n$$\nInstead of a direct analytical differentiation of the complex expression for $E^\\ast$, the problem specifies a numerical approach using a central finite difference approximation. The perturbation applied to each parameter $p$ is multiplicative, with a small factor $h = 10^{-6}$. The formula for the elasticity is given as:\n$$\n\\mathcal{S}_p \\approx \\frac{E\\big|_{p(1+h)} - E\\big|_{p(1-h)}}{2\\,h\\,E\\big|_{p}}\n$$\nThis formula numerically estimates the logarithmic derivative $\\frac{\\partial \\ln E}{\\partial \\ln p}$ evaluated at the nominal parameter values.\n\n### 3. Algorithmic Implementation\n\nThe overall algorithm is implemented as a function that processes each test case (a specific set of parameters).\n\n1.  A core function, `calculate_E_ss(params)`, is defined. This function takes a tuple of the eight parameters as input and returns the steady-state effect $E^\\ast$ by implementing the analytical formulas derived in Section 1.\n\n2.  For each test case provided:\n    a. The nominal parameter vector $P_{nominal} = (k_{\\mathrm{on}}, k_{\\mathrm{off}}, \\dots, EC_{50})$ is taken.\n    b. The baseline effect $E_{nominal} = \\text{calculate\\_E\\_ss}(P_{nominal})$ is computed.\n    c. A loop iterates through each parameter $p_i$ in $P_{nominal}$ for $i \\in \\{0, 1, \\dots, 7\\}$.\n    d. Inside the loop, for each parameter $p_i$:\n        i. Two perturbed parameter vectors are generated:\n           - $P_{plus}$, where the $i$-th element is $p_i(1+h)$.\n           - $P_{minus}$, where the $i$-th element is $p_i(1-h)$.\n        ii. The corresponding effects, $E_{plus} = \\text{calculate\\_E\\_ss}(P_{plus})$ and $E_{minus} = \\text{calculate\\_E\\_ss}(P_{minus})$, are calculated.\n        iii. The elasticity $\\mathcal{S}_{p_i}$ is computed using the central difference formula:\n            $$\n            \\mathcal{S}_{p_i} = \\frac{E_{plus} - E_{minus}}{2 \\cdot h \\cdot E_{nominal}}\n            $$\n            Given that all parameters are specified to be positive, $E_{nominal}$ will be non-zero, preventing division by zero.\n        iv. The computed elasticity is stored in a list.\n    e. After the loop completes, a list of eight elasticities corresponding to the eight parameters is obtained.\n    f. The absolute values of these elasticities are taken, and the index of the largest absolute value is determined. This index corresponds to the parameter to which the system's effect is most sensitive.\n    g. This index is appended to the list of elasticities, forming the complete result for the test case.\n\n3.  The results from all test cases are collected and formatted into a single string as specified in the problem statement, with each test case's result represented as a list of nine numbers (eight elasticities and one index).\n\nThis structured numerical approach allows for a robust and accurate estimation of the system's sensitivities without requiring complex and error-prone analytical differentiation of the full steady-state response function.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the systems pharmacology elasticity problem for a given test suite.\n    \"\"\"\n\n    # Define the test cases from the problem statement.\n    # Each case is an ordered tuple of parameters:\n    # (k_on, k_off, R_tot, D, k_cat, k_deg, E_max, EC50)\n    test_cases = [\n        (1.0e-3, 1.0e-2, 100.0, 50.0, 0.5, 0.1, 1.0, 20.0),\n        (1.0e-3, 1.0e-2, 100.0, 10000.0, 0.5, 0.1, 1.0, 20.0),\n        (1.0e-3, 1.0e-2, 1.0, 50.0, 0.5, 0.1, 1.0, 20.0),\n        (1.0e-3, 1.0e-2, 100.0, 50.0, 0.5, 10.0, 1.0, 20.0),\n    ]\n\n    h = 1.0e-6  # Multiplicative perturbation factor\n\n    def calculate_E_ss(params):\n        \"\"\"\n        Calculates the steady-state aeffect E* based on the model equations.\n        \n        Args:\n            params (tuple): A tuple of the 8 model parameters in the specified order.\n\n        Returns:\n            float: The steady-state effect E*.\n        \"\"\"\n        k_on, k_off, R_tot, D, k_cat, k_deg, E_max, EC50 = params\n        \n        # Calculate steady-state complex concentration C*\n        # C* = (k_on * D * R_tot) / (k_on * D + k_off)\n        # All parameters are positive, so no division by zero here.\n        C_ss = (k_on * D * R_tot) / (k_on * D + k_off)\n        \n        # Calculate steady-state effector concentration X*\n        # X* = (k_cat / k_deg) * C*\n        # k_deg is positive, so no division by zero.\n        X_ss = (k_cat / k_deg) * C_ss\n        \n        # Calculate steady-state effect E*\n        # E* = (E_max * X_ss) / (EC50 + X_ss)\n        # EC50 and X_ss are positive, so no division by zero.\n        E_ss = (E_max * X_ss) / (EC50 + X_ss)\n        \n        return E_ss\n\n    def compute_elasticities_for_case(case_params):\n        \"\"\"\n        Computes the list of elasticities and the index of the max absolute elasticity\n        for a single parameter set.\n        \n        Args:\n            case_params (tuple): A tuple of the 8 model parameters.\n            \n        Returns:\n            list: A list containing 8 float elasticities and 1 integer index.\n        \"\"\"\n        num_params = len(case_params)\n        params_nominal = list(case_params)\n        \n        E_nominal = calculate_E_ss(params_nominal)\n        \n        elasticities = []\n        \n        for i in range(num_params):\n            p_i = params_nominal[i]\n            \n            # Perturb parameter p_i positively\n            params_plus = params_nominal[:]\n            params_plus[i] = p_i * (1 + h)\n            E_plus = calculate_E_ss(params_plus)\n            \n            # Perturb parameter p_i negatively\n            params_minus = params_nominal[:]\n            params_minus[i] = p_i * (1 - h)\n            E_minus = calculate_E_ss(params_minus)\n            \n            # Calculate elasticity using the central finite difference formula\n            if E_nominal == 0:\n                # This case should not be reached given positive parameters,\n                # but it's a safe guard. If E is 0, elasticity is undefined\n                # or 0 if the numerator is also 0.\n                elasticity = 0.0\n            else:\n                elasticity = (E_plus - E_minus) / (2 * h * E_nominal)\n            \n            elasticities.append(elasticity)\n            \n        # Find the index of the parameter with the largest absolute elasticity\n        if elasticities:\n            max_abs_elasticity_idx = np.argmax(np.abs(np.array(elasticities)))\n        else:\n            max_abs_elasticity_idx = -1 # Should not happen\n\n        result_for_case = elasticities + [int(max_abs_elasticity_idx)]\n        \n        return result_for_case\n\n    # Process all test cases\n    results = []\n    for case in test_cases:\n        result_list = compute_elasticities_for_case(case)\n        # Format the list of numbers into a string like \"[num1,num2,...]\"\n        result_string = f\"[{','.join(map(str, result_list))}]\"\n        results.append(result_string)\n\n    # Final print statement in the exact required format.\n    # The format is a string representation of a list of lists.\n    # Example: \"[[e1,e2,i1],[f1,f2,i2]]\"\n    # The `results` list already contains strings like `\"[e1,e2,i1]\"`.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```", "id": "4378068"}, {"introduction": "The ultimate goal of systems pharmacology is often to control a biological system to achieve a therapeutic outcome, a challenge compounded by patient-to-patient variability. This advanced practice applies principles from engineering control theory to a core problem in drug delivery: designing a safe and effective dosing regimen in the face of uncertainty. You will implement and compare a standard Model Predictive Control (MPC) strategy with a robust controller designed to guarantee safety despite uncertainty in the drug's elimination rate, demonstrating how quantitative modeling can lead to more reliable therapeutic strategies [@problem_id:4378103].", "problem": "Consider a one-compartment pharmacokinetic (PK) model for a drug administered by continuous intravenous infusion. The task is to design a robust controller and compare its performance to a nominal Model Predictive Control (MPC) strategy under parameter uncertainty in the elimination rate constant. You must implement both controllers and compute performance degradation versus the nominal MPC in terms of tracking error and constraint violations.\n\nFundamental base and model. Start from the mass-balance for a well-mixed compartment of volume $V$ (liters) with concentration $x(t)$ (milligrams per liter, mg/L), elimination characterized by a first-order rate constant $k_e$ (per hour, $1/\\mathrm{h}$), and controlled infusion rate $u(t)$ (milligrams per hour, mg/h):\n$$\n\\frac{dx(t)}{dt} = -k_e x(t) + \\frac{u(t)}{V}.\n$$\nUse a forward-Euler discretization with a fixed time step $\\Delta t$ (hours) to obtain the discrete-time dynamics:\n$$\nx_{k+1} = x_k + \\Delta t \\left( -k_e x_k + \\frac{u_k}{V} \\right) = A x_k + B u_k,\n$$\nwhere $A = 1 - \\Delta t \\, k_e$ and $B = \\frac{\\Delta t}{V}$.\n\nControl objective and constraints. The controller aims to track a prescribed concentration setpoint $x_{\\mathrm{ref}}$ (mg/L) while respecting:\n- Input (dose) constraints $0 \\le u_k \\le u_{\\max}$ (mg/h).\n- State (toxicity) constraints $x_{k} \\le x_{\\max}$ (mg/L) at all steps.\n\nAt each time step, define a surrogate quadratic one-step objective that penalizes tracking error at the next step and input move size:\n$$\nJ_k(u_k) = w_e \\left( x_{k+1} - x_{\\mathrm{ref}} \\right)^2 + w_u \\left( u_k - u_{k-1} \\right)^2,\n$$\nwith positive weights $w_e$ and $w_u$. Assume the controller knows $x_k$ and $u_{k-1}$ at the decision time.\n\nUncertainty. The true elimination rate $k_e$ is uncertain but bounded within a known interval $[k_{\\min}, k_{\\max}]$. The nominal MPC uses a nominal value $k_{\\mathrm{nom}}$ for prediction and constraint enforcement. The robust controller must guarantee satisfaction of the toxicity constraint $x_{k+1} \\le x_{\\max}$ for all realizations $k_e \\in [k_{\\min}, k_{\\max}]$ and for all state values encountered during operation, without violating the input bounds.\n\nController designs to implement:\n1. Nominal Model Predictive Control (MPC). At each step, minimize $J_k(u_k)$ subject to $0 \\le u_k \\le u_{\\max}$ and the constraint $x_{k+1} \\le x_{\\max}$ predicted using $k_{\\mathrm{nom}}$.\n2. Robust controller. At each step, minimize the same $J_k(u_k)$ but enforce robust state constraint tightening: enforce $x_{k+1} \\le x_{\\max}$ for the worst-case next state prediction over $k_e \\in [k_{\\min}, k_{\\max}]$ at the current state $x_k$. Use the extremal value in $[k_{\\min}, k_{\\max}]$ that yields the largest $x_{k+1}$ for constraint enforcement. Also enforce $0 \\le u_k \\le u_{\\max}$.\n\nPerformance metrics. For a given simulation horizon of $T$ hours and step size $\\Delta t$, define $N = \\lfloor T / \\Delta t \\rfloor$ and simulate the closed-loop system using the true $k_e = k_{\\mathrm{true}}$:\n- Tracking error at step $k$: $e_k = x_{k+1} - x_{\\mathrm{ref}}$. Report the time-average absolute tracking error $\\frac{1}{N} \\sum_{k=0}^{N-1} |e_k|$ as a float in mg/L.\n- Constraint violation magnitude at step $k$: the nonnegative exceedance of the toxicity constraint on the realized next state, $\\max\\{0, x_{k+1} - x_{\\max}\\}$ (mg/L), plus any input bound violation $\\max\\{0, -u_k\\} + \\max\\{0, u_k - u_{\\max}\\}$ (mg/h). Report the cumulative sum over the horizon as a float. Note: express both metrics in their native units as floats (do not convert units or use percentages).\n\nPerformance comparison. For each test case, compute:\n- Error degradation of the robust controller versus nominal MPC: $\\Delta_{\\mathrm{err}} = \\overline{|e|}_{\\mathrm{rob}} - \\overline{|e|}_{\\mathrm{nom}}$ (mg/L).\n- Violation reduction due to robustness: $\\Delta_{\\mathrm{vio}} = V_{\\mathrm{nom}} - V_{\\mathrm{rob}}$, where $V_{\\cdot}$ denotes the cumulative violation magnitude as defined above (units mg/L plus mg/h, reported as a float).\n\nYour program must implement both controllers, run the simulations, and output $[\\,[\\Delta_{\\mathrm{err}}^{(1)}, \\Delta_{\\mathrm{vio}}^{(1)}], \\ldots, [\\Delta_{\\mathrm{err}}^{(M)}, \\Delta_{\\mathrm{vio}}^{(M)}]\\,]$ for the provided $M$ test cases, in a single line, with no extra text.\n\nTest suite. Use the following four test cases. For each, initialize $x_0 = 0$ mg/L, $u_{-1} = 0$ mg/h, $w_e = 1.0$, $w_u = 0.05$, and simulate with step size $\\Delta t$ and horizon $T$ as specified. All angles are irrelevant in this context. Physical units must be as stated above.\n\n- Case 1 (happy path):\n    - $V = 10$ L,\n    - $k_{\\mathrm{nom}} = 0.20\\, \\mathrm{h}^{-1}$,\n    - $k_{\\min} = 0.15\\, \\mathrm{h}^{-1}$,\n    - $k_{\\max} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $k_{\\mathrm{true}} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $x_{\\mathrm{ref}} = 2.0$ mg/L,\n    - $x_{\\max} = 4.0$ mg/L,\n    - $u_{\\max} = 80$ mg/h,\n    - $\\Delta t = 0.25$ h,\n    - $T = 12$ h.\n\n- Case 2 (boundary: worst-case accumulation and target near toxicity):\n    - $V = 12$ L,\n    - $k_{\\mathrm{nom}} = 0.20\\, \\mathrm{h}^{-1}$,\n    - $k_{\\min} = 0.15\\, \\mathrm{h}^{-1}$,\n    - $k_{\\max} = 0.30\\, \\mathrm{h}^{-1}$,\n    - $k_{\\mathrm{true}} = 0.15\\, \\mathrm{h}^{-1}$,\n    - $x_{\\mathrm{ref}} = 3.5$ mg/L,\n    - $x_{\\max} = 4.0$ mg/L,\n    - $u_{\\max} = 120$ mg/h,\n    - $\\Delta t = 0.25$ h,\n    - $T = 12$ h.\n\n- Case 3 (edge: no uncertainty):\n    - $V = 10$ L,\n    - $k_{\\mathrm{nom}} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $k_{\\min} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $k_{\\max} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $k_{\\mathrm{true}} = 0.25\\, \\mathrm{h}^{-1}$,\n    - $x_{\\mathrm{ref}} = 2.5$ mg/L,\n    - $x_{\\max} = 5.0$ mg/L,\n    - $u_{\\max} = 100$ mg/h,\n    - $\\Delta t = 0.25$ h,\n    - $T = 12$ h.\n\n- Case 4 (edge: small volume and faster true elimination):\n    - $V = 5$ L,\n    - $k_{\\mathrm{nom}} = 0.22\\, \\mathrm{h}^{-1}$,\n    - $k_{\\min} = 0.18\\, \\mathrm{h}^{-1}$,\n    - $k_{\\max} = 0.30\\, \\mathrm{h}^{-1}$,\n    - $k_{\\mathrm{true}} = 0.30\\, \\mathrm{h}^{-1}$,\n    - $x_{\\mathrm{ref}} = 3.0$ mg/L,\n    - $x_{\\max} = 4.0$ mg/L,\n    - $u_{\\max} = 50$ mg/h,\n    - $\\Delta t = 0.25$ h,\n    - $T = 12$ h.\n\nFinal output format. Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each test case result is a two-element list in the order $[\\Delta_{\\mathrm{err}}, \\Delta_{\\mathrm{vio}}]$. For example: $[[0.1,0.0],[0.2,1.5],[\\ldots]]$.", "solution": "The user-provided problem is assessed for validity.\n\n### Step 1: Extract Givens\nThe problem provides the following data, definitions, and constraints:\n- **Continuous-time model:** $\\frac{dx(t)}{dt} = -k_e x(t) + \\frac{u(t)}{V}$\n- **Discrete-time model:** $x_{k+1} = A x_k + B u_k$, where $A = 1 - \\Delta t \\, k_e$ and $B = \\frac{\\Delta t}{V}$.\n- **State variable:** $x(t)$ (drug concentration, mg/L).\n- **Control input:** $u(t)$ (infusion rate, mg/h).\n- **Model parameters:** $V$ (volume, L), $k_e$ (elimination rate constant, $1/\\mathrm{h}$), $\\Delta t$ (time step, h).\n- **Control objective:** Track a setpoint $x_{\\mathrm{ref}}$ (mg/L) by minimizing a one-step quadratic cost function:\n  $$J_k(u_k) = w_e ( x_{k+1} - x_{\\mathrm{ref}} )^2 + w_u ( u_k - u_{k-1} )^2$$\n- **Weights:** Positive scalars $w_e$ and $w_u$.\n- **Constraints:**\n  - Input: $0 \\le u_k \\le u_{\\max}$ (mg/h).\n  - State: $x_{k} \\le x_{\\max}$ (mg/L).\n- **Uncertainty:** The elimination rate constant $k_e$ is unknown but bounded: $k_e \\in [k_{\\min}, k_{\\max}]$. A nominal value $k_{\\mathrm{nom}}$ is also given.\n- **Controller 1 (Nominal MPC):** Minimizes $J_k(u_k)$ subject to $0 \\le u_k \\le u_{\\max}$ and a predicted state constraint $x_{k+1} \\le x_{\\max}$ using $k_e = k_{\\mathrm{nom}}$.\n- **Controller 2 (Robust Controller):** Minimizes $J_k(u_k)$ subject to $0 \\le u_k \\le u_{\\max}$ and a robustified state constraint that must hold for the worst-case $k_e \\in [k_{\\min}, k_{\\max}]$.\n- **Simulation conditions:** The system state evolves according to a true elimination rate $k_{\\mathrm{true}}$. Simulation horizon is $T$ hours, yielding $N = \\lfloor T / \\Delta t \\rfloor$ steps. Initial conditions are $x_0 = 0$ mg/L and $u_{-1} = 0$ mg/h.\n- **Performance Metrics:**\n  - Time-average absolute tracking error: $\\overline{|e|} = \\frac{1}{N} \\sum_{k=0}^{N-1} |x_{k+1} - x_{\\mathrm{ref}}|$.\n  - Cumulative constraint violation: $V = \\sum_{k=0}^{N-1} (\\max\\{0, x_{k+1} - x_{\\max}\\} + \\max\\{0, -u_k\\} + \\max\\{0, u_k - u_{\\max}\\})$.\n- **Required Output:** For each test case, compute:\n  - Error degradation: $\\Delta_{\\mathrm{err}} = \\overline{|e|}_{\\mathrm{rob}} - \\overline{|e|}_{\\mathrm{nom}}$.\n  - Violation reduction: $\\Delta_{\\mathrm{vio}} = V_{\\mathrm{nom}} - V_{\\mathrm{rob}}$.\n- **Test Suite:** Four distinct test cases with specified numerical values for all parameters are provided.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded:** The problem is based on a standard one-compartment pharmacokinetic model, a fundamental concept in pharmacology and biomedical engineering. The control strategies, namely Model Predictive Control (MPC) and robust control, are well-established paradigms in control theory. The problem is scientifically and mathematically sound.\n- **Well-Posed:** For each controller at every time step, the task is to minimize a convex quadratic function of a single variable ($u_k$) over a closed interval defined by linear constraints. This is a simple Quadratic Programming (QP) problem which is guaranteed to have a unique, stable solution. The overall problem is well-posed.\n- **Objective:** The problem statement is precise, quantitative, and free of ambiguity. All terms are clearly defined, and parameters are specified with their physical units. It is an objective, formalizable problem.\n- **Flaw Check:** The problem statement does not violate any of the invalidity criteria. It is scientifically sound, well-posed, complete, feasible, and non-trivial. It presents a standard engineering problem of controller design under uncertainty.\n\n### Step 3: Verdict and Action\nThe problem is **valid**. A solution will be developed and implemented.\n\n---\n\n### Solution Derivation\n\nThe core of the problem is to determine the optimal control input $u_k$ at each time step $k$ for two different controllers. Both controllers minimize the same objective function but under different constraints.\n\n**1. Optimization Problem Formulation**\n\nThe objective function to be minimized is:\n$$J_k(u_k) = w_e \\left( x_{k+1} - x_{\\mathrm{ref}} \\right)^2 + w_u \\left( u_k - u_{k-1} \\right)^2$$\nThe next state $x_{k+1}$ is predicted using the discrete-time model, $x_{k+1} = (1 - \\Delta t \\, k_{\\mathrm{pred}}) x_k + \\frac{\\Delta t}{V} u_k$. For performance prediction (i.e., in the objective function), it is standard practice to use the nominal model parameter, so we set $k_{\\mathrm{pred}} = k_{\\mathrm{nom}}$. Let $A_{\\mathrm{nom}} = 1 - \\Delta t \\, k_{\\mathrm{nom}}$ and $B = \\frac{\\Delta t}{V}$. Substituting $x_{k+1} = A_{\\mathrm{nom}} x_k + B u_k$ into $J_k(u_k)$:\n$$J_k(u_k) = w_e \\left( A_{\\mathrm{nom}} x_k + B u_k - x_{\\mathrm{ref}} \\right)^2 + w_u \\left( u_k - u_{k-1} \\right)^2$$\nThis is a quadratic function of $u_k$. To find the unconstrained minimum, we set its derivative with respect to $u_k$ to zero:\n$$\\frac{dJ_k}{du_k} = 2 w_e B (A_{\\mathrm{nom}} x_k + B u_k - x_{\\mathrm{ref}}) + 2 w_u (u_k - u_{k-1}) = 0$$\nSolving for $u_k$ yields the unconstrained optimal input, $u_k^*$:\n$$(w_e B^2 + w_u) u_k = w_u u_{k-1} - w_e B (A_{\\mathrm{nom}} x_k - x_{\\mathrm{ref}})$$\n$$u_k^* = \\frac{w_u u_{k-1} - w_e B (A_{\\mathrm{nom}} x_k - x_{\\mathrm{ref}})}{w_e B^2 + w_u}$$\nThis $u_k^*$ represents the ideal input based purely on minimizing tracking and input change penalties, without considering any operational constraints.\n\n**2. Constraint Formulation and Control Law**\n\nThe control input $u_k$ must satisfy the hard constraints. The optimization problem is:\n$$\\min_{u_k} J_k(u_k) \\quad \\text{subject to} \\quad 0 \\le u_k \\le u_{\\max} \\quad \\text{and} \\quad x_{k+1} \\le x_{\\max}$$\nThe state constraint $x_{k+1} \\le x_{\\max}$ can be rewritten as a linear constraint on $u_k$. The value of $k_e$ used to evaluate this constraint, let's call it $k_c$, differs between the two controllers.\n$$(1 - \\Delta t \\, k_c) x_k + B u_k \\le x_{\\max}$$\n$$B u_k \\le x_{\\max} - (1 - \\Delta t \\, k_c) x_k$$\nSince $B = \\Delta t / V > 0$, we have:\n$$u_k \\le \\frac{1}{B} (x_{\\max} - (1 - \\Delta t \\, k_c) x_k) \\equiv u_{k, \\mathrm{state\\_max}}$$\nThe complete set of constraints on $u_k$ is therefore $0 \\le u_k \\le \\min(u_{\\max}, u_{k, \\mathrm{state\\_max}})$. Let $u_{k, \\mathrm{upper}} = \\min(u_{\\max}, u_{k, \\mathrm{state\\_max}})$. The feasible set for $u_k$ is the interval $[0, u_{k, \\mathrm{upper}}]$.\n\nThe solution to minimizing the convex quadratic $J_k(u_k)$ over the interval $[0, u_{k, \\mathrm{upper}}]$ is found by projecting the unconstrained minimum $u_k^*$ onto this interval.\n- If the interval is non-empty (i.e., $u_{k, \\mathrm{upper}} \\ge 0$), the optimal constrained input is $u_k = \\mathrm{clip}(u_k^*, 0, u_{k, \\mathrm{upper}})$.\n- If the interval is empty (i.e., $u_{k, \\mathrm{upper}}  0$), no feasible input exists that satisfies all constraints. In this scenario, the controller must choose an action. The only physically realizable non-negative input is $u_k = 0$. This choice satisfies $0 \\le u_k \\le u_{\\max}$ but will necessarily lead to a state constraint violation.\n\n**3. Controller-Specific Designs**\n\n- **Nominal MPC:** This controller uses the nominal model for all predictions. Thus, for the state constraint, it sets $k_c = k_{\\mathrm{nom}}$.\n  - $u_{k, \\mathrm{state\\_max, nom}} = \\frac{V}{\\Delta t} (x_{\\max} - (1 - \\Delta t \\, k_{\\mathrm{nom}}) x_k)$.\n  - The control law is determined by projecting $u_k^*$ onto the feasible set defined using this bound.\n\n- **Robust Controller:** This controller must guarantee the state constraint $x_{k+1} \\le x_{\\max}$ for all possible $k_e \\in [k_{\\min}, k_{\\max}]$. It must therefore use the worst-case $k_e$ that maximizes $x_{k+1}$. We analyze the dependency of $x_{k+1}$ on $k_e$:\n  $$x_{k+1}(k_e) = (1 - \\Delta t \\, k_e) x_k + B u_k$$\n  $$\\frac{\\partial x_{k+1}}{\\partial k_e} = -\\Delta t \\, x_k$$\n  Since $\\Delta t > 0$ and drug concentration $x_k \\ge 0$, this derivative is non-positive. This indicates that $x_{k+1}$ is a monotonically non-increasing function of $k_e$. The maximum value of $x_{k+1}$ therefore occurs at the minimum value of $k_e$, i.e., $k_e = k_{\\min}$.\n  The robust controller enforces the state constraint using $k_c = k_{\\min}$.\n  - $u_{k, \\mathrm{state\\_max, rob}} = \\frac{V}{\\Delta t} (x_{\\max} - (1 - \\Delta t \\, k_{\\min}) x_k)$.\n  - Since $k_{\\min} \\le k_{\\mathrm{nom}}$, it follows that $u_{k, \\mathrm{state\\_max, rob}} \\le u_{k, \\mathrm{state\\_max, nom}}$. The robust controller is inherently more conservative, imposing a tighter (or equal) upper bound on the control input to ensure safety.\n\n**4. Simulation and Evaluation**\n\nFor each test case, the system is simulated for $N = \\lfloor T / \\Delta t \\rfloor$ steps. In each step $k$:\n1. The appropriate controller (Nominal or Robust) calculates the control input $u_k$ based on the current state $x_k$ and previous input $u_{k-1}$.\n2. The system's state is updated to $x_{k+1}$ using the *true* elimination rate, $k_{\\mathrm{true}}$:\n   $$x_{k+1} = (1 - \\Delta t \\, k_{\\mathrm{true}}) x_k + B u_k$$\n3. The tracking error $|x_{k+1} - x_{\\mathrm{ref}}|$ and any constraint violations are calculated and accumulated.\nAfter the simulation, the final metrics $\\overline{|e|}$ and $V$ are computed. The differences $\\Delta_{\\mathrm{err}}$ and $\\Delta_{\\mathrm{vio}}$ are then determined by comparing the results from the two controller simulations. This procedure is implemented in the provided Python code.", "answer": "```python\nimport numpy as np\n\ndef calculate_control_input(x_k, u_km1, params, controller_type):\n    \"\"\"\n    Calculates the optimal control input u_k for a given controller type.\n    \"\"\"\n    # Unpack parameters\n    V = params['V']\n    k_nom = params['k_nom']\n    k_min = params['k_min']\n    x_ref = params['x_ref']\n    x_max = params['x_max']\n    u_max = params['u_max']\n    dt = params['dt']\n    w_e = params['w_e']\n    w_u = params['w_u']\n    \n    # Calculate unconstrained optimal control input u_k_star\n    # This is based on minimizing the one-step cost J_k using the nominal model.\n    k_pred = k_nom\n    B = dt / V\n    A_nom = 1 - dt * k_pred\n    \n    cost_term1 = A_nom * x_k - x_ref\n    \n    numerator = w_u * u_km1 - w_e * B * cost_term1\n    denominator = w_e * B**2 + w_u\n    u_k_star = numerator / denominator\n\n    # Determine the upper bound on u_k from the state constraint x_{k+1} = x_max\n    if controller_type == 'nominal':\n        # Use nominal k_e for constraint prediction\n        k_c = k_nom\n    elif controller_type == 'robust':\n        # Use worst-case k_e for constraint prediction to ensure robustness.\n        # x_{k+1} is maximized at k_e = k_min because dx_{k+1}/dk_e = -dt*x_k = 0.\n        k_c = k_min\n    else:\n        raise ValueError(\"Invalid controller type\")\n\n    # The constraint is (1 - dt*k_c)*x_k + (dt/V)*u_k = x_max\n    # Solving for u_k gives: u_k = (V/dt) * (x_max - (1 - dt*k_c)*x_k)\n    if dt = 0: # Avoid division by zero, though dt is given as positive.\n        u_k_state_max = np.inf if (x_max - (1 - dt * k_c) * x_k) = 0 else -np.inf\n    else:\n        u_k_state_max = (V / dt) * (x_max - (1 - dt * k_c) * x_k)\n    \n    # The feasible set for u_k is [0, min(u_max, u_k_state_max)]\n    u_upper_bound = min(u_max, u_k_state_max)\n    \n    # If the feasible set is empty (u_upper_bound  0), the only physically possible\n    # non-negative input is u_k=0. This will violate the state constraint, but is\n    # the necessary action.\n    if u_upper_bound  0:\n        u_k = 0.0\n    else:\n        # Otherwise, project the unconstrained optimum onto the feasible interval [0, u_upper_bound].\n        u_k = np.clip(u_k_star, 0.0, u_upper_bound)\n        \n    return u_k\n\ndef run_simulation(params, controller_type):\n    \"\"\"\n    Simulates the closed-loop system for a given controller and computes performance metrics.\n    \"\"\"\n    # Unpack simulation parameters\n    V = params['V']\n    k_true = params['k_true']\n    x_ref = params['x_ref']\n    x_max = params['x_max']\n    u_max = params['u_max']\n    dt = params['dt']\n    T = params['T']\n    \n    x_0 = params['x0']\n    u_m1 = params['u_m1']\n\n    N = int(T / dt)\n    \n    # Initialize state and input\n    x_k = x_0\n    u_km1 = u_m1\n    \n    total_abs_error = 0.0\n    total_violation = 0.0\n    \n    for _ in range(N):\n        # 1. Calculate control input u_k using the specified controller\n        u_k = calculate_control_input(x_k, u_km1, params, controller_type)\n        \n        # 2. Simulate the true system dynamics for one step\n        A_true = 1 - dt * k_true\n        B = dt / V\n        x_kp1 = A_true * x_k + B * u_k\n        \n        # 3. Calculate performance metrics for this step\n        # Tracking error\n        error_k = x_kp1 - x_ref\n        total_abs_error += abs(error_k)\n        \n        # Constraint violation\n        state_violation = max(0, x_kp1 - x_max)\n        input_violation_neg = max(0, -u_k)\n        input_violation_pos = max(0, u_k - u_max)\n        total_violation += state_violation + input_violation_neg + input_violation_pos\n        \n        # 4. Update state and input for the next iteration\n        x_k = x_kp1\n        u_km1 = u_k\n    \n    avg_abs_error = total_abs_error / N if N  0 else 0.0\n    \n    return avg_abs_error, total_violation\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and format the final output.\n    \"\"\"\n    test_cases = [\n        # Case 1: Happy path\n        {'V': 10, 'k_nom': 0.20, 'k_min': 0.15, 'k_max': 0.25, 'k_true': 0.25, 'x_ref': 2.0, 'x_max': 4.0, 'u_max': 80, 'dt': 0.25, 'T': 12},\n        # Case 2: Boundary: worst-case accumulation and target near toxicity\n        {'V': 12, 'k_nom': 0.20, 'k_min': 0.15, 'k_max': 0.30, 'k_true': 0.15, 'x_ref': 3.5, 'x_max': 4.0, 'u_max': 120, 'dt': 0.25, 'T': 12},\n        # Case 3: Edge: no uncertainty\n        {'V': 10, 'k_nom': 0.25, 'k_min': 0.25, 'k_max': 0.25, 'k_true': 0.25, 'x_ref': 2.5, 'x_max': 5.0, 'u_max': 100, 'dt': 0.25, 'T': 12},\n        # Case 4: Edge: small volume and faster true elimination\n        {'V': 5, 'k_nom': 0.22, 'k_min': 0.18, 'k_max': 0.30, 'k_true': 0.30, 'x_ref': 3.0, 'x_max': 4.0, 'u_max': 50, 'dt': 0.25, 'T': 12},\n    ]\n\n    shared_params = {'x0': 0.0, 'u_m1': 0.0, 'w_e': 1.0, 'w_u': 0.05}\n\n    output_results = []\n    for case_params in test_cases:\n        full_params = {**case_params, **shared_params}\n        \n        # Run simulation for Nominal MPC\n        avg_err_nom, cum_vio_nom = run_simulation(full_params, 'nominal')\n        \n        # Run simulation for Robust Controller\n        avg_err_rob, cum_vio_rob = run_simulation(full_params, 'robust')\n        \n        # Calculate performance differences\n        delta_err = avg_err_rob - avg_err_nom\n        delta_vio = cum_vio_nom - cum_vio_rob\n        \n        output_results.append(f\"[{delta_err},{delta_vio}]\")\n        \n    # Print the final result in the exact required format\n    print(f\"[{','.join(output_results)}]\")\n\nsolve()\n```", "id": "4378103"}]}