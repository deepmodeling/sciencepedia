{"hands_on_practices": [{"introduction": "A clinical decision support system is only as reliable as the data it processes. Before any clinical interpretation, it is crucial to first determine whether a detected genetic variant is a true biological signal or merely a technical artifact. This exercise demonstrates how to apply Bayes' theorem to build a foundational quality control filter, integrating disparate sources of sequencing evidence such as read depth, base quality, and strand bias to compute a posterior quality score for a variant candidate [@problem_id:4324283]. Mastering this quantitative approach is a vital first step in constructing any robust genomic analysis pipeline.", "problem": "A Clinical Decision Support (CDS) pipeline for genomics integrates read-level Quality Control (QC) evidence to produce a posterior variant quality score that guides filtering in a precision medicine workflow. Consider a Single Nucleotide Variant (SNV) candidate at a locus in a clinical gene panel. The sequencing metrics at this locus are: total read depth $n=12$, with $k=6$ reads supporting the alternate allele; mean base quality across the alternate-supporting reads $Q_{b}=25$; and a two-sided strand bias $p$-value $p_{\\mathrm{sb}}=0.01$ computed under the null of no strand bias using Fisher’s exact test. Assume a per-locus prior probability of a true variant $P(H_{1})=10^{-4}$ and its complement $P(H_{0})=1-P(H_{1})$. \n\nModel the evidence using two hypotheses: $H_{1}$ (true heterozygous variant with no intrinsic strand bias) and $H_{0}$ (no true variant; observed alternate-supporting reads arise from sequencing error). Use the following foundational bases and assumptions:\n\n1. Bayes’ theorem for posterior odds and probabilities.\n2. The definition of the Phred transform for a probability $p$: $Q=-10\\log_{10}(p)$.\n3. Independent per-read base-calling errors with per-read error probability $\\varepsilon = 10^{-Q_{b}/10}$.\n4. Under $H_{1}$ for a heterozygous SNV without strand bias, the per-read probability of an alternate call is approximately $p_{\\text{alt}|H_{1}}=\\frac{1}{2}$; thus the count $k$ of alternate-supporting reads among $n$ follows a binomial distribution with $p=\\frac{1}{2}$. \n5. Under $H_{0}$, the per-read probability of an alternate call equals the base error probability $\\varepsilon$, and the count $k$ follows a binomial distribution with $p=\\varepsilon$.\n6. Treat the observed strand bias $p$-value as multiplicative evidence against $H_{1}$ via the factor $p_{\\mathrm{sb}}$ in the Bayes factor; under $H_{0}$, do not penalize with $p_{\\mathrm{sb}}$.\n\nStarting from these bases, derive the posterior probability $P(H_{1}\\mid D)$ given the data $D=\\{n=12,\\;k=6,\\;Q_{b}=25,\\;p_{\\mathrm{sb}}=0.01\\}$ and compute the posterior Phred quality score\n$$\nQ_{\\text{post}}=-10\\log_{10}\\!\\big(1-P(H_{1}\\mid D)\\big).\n$$\nAdditionally, impose a posterior false call constraint $\\theta=10^{-4}$ and determine the implied Phred decision threshold $Q_{\\text{th}}=-10\\log_{10}(\\theta)$. State whether the candidate passes or fails relative to $Q_{\\text{th}}$.\n\nRound your computed $Q_{\\text{post}}$ to four significant figures. Express $Q_{\\text{post}}$ in Phred units. For the pass/fail decision, describe your reasoning, but only report the numerical value of $Q_{\\text{post}}$ as your final answer.", "solution": "The problem is to calculate the posterior probability of a single nucleotide variant (SNV) being a true variant, given a set of sequencing data, and to determine if this variant passes a quality threshold. The problem is scientifically grounded in Bayesian statistics and standard models used in genomics. It is well-posed, with all necessary parameters and models explicitly defined. Therefore, the problem is valid and a solution can be derived.\n\nThe core of the analysis rests on Bayes' theorem, which is most conveniently expressed in terms of odds. The posterior odds of hypothesis $H_{1}$ (true variant) versus hypothesis $H_{0}$ (sequencing error) given the data $D$ is the product of the prior odds and the Bayes Factor (BF):\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\frac{P(H_{1})}{P(H_{0})} \\times \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})}\n$$\nThe data $D$ consists of the total read depth $n=12$, the number of reads supporting the alternate allele $k=6$, the mean base quality of alternate reads $Q_{b}=25$, and the strand bias $p$-value $p_{\\mathrm{sb}}=0.01$.\n\nFirst, we establish the prior odds. Given the prior probability of a true variant $P(H_{1})=10^{-4}$, the prior probability of no true variant is $P(H_{0})=1-P(H_{1})=1-10^{-4}=0.9999$. The prior odds are:\n$$\n\\frac{P(H_{1})}{P(H_{0})} = \\frac{10^{-4}}{1-10^{-4}} = \\frac{10^{-4}}{0.9999}\n$$\n\nNext, we formulate the Bayes Factor, which is the ratio of the likelihoods of observing the data under the two competing hypotheses, $\\text{BF} = P(D\\mid H_{1}) / P(D\\mid H_{0})$. The problem specifies how to model the likelihoods based on the different pieces of evidence.\n\nThe base-calling error probability, $\\varepsilon$, is derived from the Phred-scaled base quality $Q_{b}=25$:\n$$\n\\varepsilon = 10^{-Q_{b}/10} = 10^{-25/10} = 10^{-2.5}\n$$\nThe likelihood of observing $k$ alternate-supporting reads out of a total of $n$ reads is modeled by a binomial distribution, $P(k|n, p) = \\binom{n}{k}p^{k}(1-p)^{n-k}$.\nUnder $H_{1}$ (true heterozygous variant), the probability of observing an alternate allele is $p = \\frac{1}{2}$.\n$$\nP(k=6 \\mid n=12, H_{1}) = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{6} \\left(1-\\frac{1}{2}\\right)^{12-6} = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12}\n$$\nUnder $H_{0}$ (sequencing error), the probability of observing an alternate allele is the error rate $p = \\varepsilon$.\n$$\nP(k=6 \\mid n=12, H_{0}) = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{12-6} = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}\n$$\nThe problem states that the strand bias $p$-value, $p_{\\mathrm{sb}}$, is to be treated as a multiplicative penalty against the likelihood of $H_{1}$, while $H_{0}$ is not penalized. This implies that the total likelihood for $H_{1}$ is $P(D\\mid H_{1}) = P(k|n, H_1) \\times p_{\\mathrm{sb}}$, and for $H_{0}$ is $P(D\\mid H_{0}) = P(k|n, H_0) \\times 1$.\n\nThe Bayes Factor is therefore:\n$$\n\\text{BF} = \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})} = \\frac{\\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}} = \\frac{\\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\varepsilon^{6} (1-\\varepsilon)^{6}}\n$$\nSubstituting the known values $p_{\\mathrm{sb}}=0.01=10^{-2}$ and $\\varepsilon=10^{-2.5}$:\n$$\n\\text{BF} = \\frac{(0.5)^{12} \\times 10^{-2}}{\\left(10^{-2.5}\\right)^{6} (1-10^{-2.5})^{6}} = \\frac{2^{-12} \\times 10^{-2}}{10^{-15} (1-10^{-2.5})^{6}} = \\frac{10^{13}}{2^{12} (1-10^{-2.5})^{6}}\n$$\nWe calculate the numerical value: $2^{12} = 4096$.\n$$\n\\text{BF} = \\frac{10^{13}}{4096 \\times (1-10^{-2.5})^{6}} \\approx \\frac{10^{13}}{4096 \\times (0.9968377)^{6}} \\approx \\frac{10^{13}}{4096 \\times 0.981190} \\approx \\frac{10^{13}}{4018.956} \\approx 2.488206 \\times 10^{9}\n$$\nNow, we compute the posterior odds:\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\left(\\frac{10^{-4}}{0.9999}\\right) \\times (2.488206 \\times 10^{9}) \\approx 248845.5\n$$\nThe posterior probability of $H_{1}$ is related to the posterior odds $O_{\\text{post}}$ by $P(H_{1}\\mid D) = O_{\\text{post}} / (1 + O_{\\text{post}})$. The quantity needed for the Phred score is the posterior probability of error, which is $P(H_{0}\\mid D) = 1 - P(H_{1}\\mid D) = 1 / (1 + O_{\\text{post}})$.\n$$\n1 - P(H_{1}\\mid D) = \\frac{1}{1 + 248845.5} = \\frac{1}{248846.5} \\approx 4.01854 \\times 10^{-6}\n$$\nThe posterior Phred quality score $Q_{\\text{post}}$ is defined as:\n$$\nQ_{\\text{post}} = -10\\log_{10}(1 - P(H_{1}\\mid D))\n$$\n$$\nQ_{\\text{post}} = -10\\log_{10}(4.01854 \\times 10^{-6}) = -10(\\log_{10}(4.01854) - 6) \\approx -10(0.604067 - 6) = -10(-5.395933) \\approx 53.95933\n$$\nRounding to four significant figures, we get $Q_{\\text post} = 53.96$.\n\nFinally, we must determine if the candidate passes or fails. The posterior false call constraint is $\\theta=10^{-4}$. The corresponding Phred decision threshold $Q_{\\text{th}}$ is:\n$$\nQ_{\\text{th}} = -10\\log_{10}(\\theta) = -10\\log_{10}(10^{-4}) = -10(-4) = 40\n$$\nThe decision rule is to pass the candidate if its quality score is greater than or equal to the threshold. We compare our computed score to the threshold:\n$$\nQ_{\\text{post}} = 53.96 > Q_{\\text{th}} = 40\n$$\nSince the posterior quality score of the SNV candidate is greater than the decision threshold, the candidate passes the quality filter. The final answer required is the numerical value of $Q_{\\text{post}}$.", "answer": "$$\n\\boxed{53.96}\n$$", "id": "4324283"}, {"introduction": "Beyond rare disorders, a primary goal of genomic medicine is to predict an individual's susceptibility to common, complex diseases through the use of Polygenic Risk Scores (PRS). A PRS aggregates the small effects of many genetic variants into a single score that quantifies risk. This practice guides you through the entire end-to-end calculation, from combining weighted risk alleles into a raw score, to standardizing this score against population parameters, and finally to converting it into a clinically meaningful absolute risk estimate using a log-odds model [@problem_id:4324199]. This skill is essential for understanding how a CDSS can translate a patient's unique genetic profile into a clear, actionable metric for risk stratification.", "problem": "An informatics team is building a clinical decision support module that integrates a Polygenic Risk Score (PRS) for a common complex disease into an individualized absolute risk estimate on the log-odds scale. The PRS is computed as a weighted sum of single-nucleotide polymorphisms (SNPs), with genotype coded as the number of risk alleles. Assume Hardy–Weinberg Equilibrium (HWE) and independence across SNPs, so that for each SNP with risk allele frequency $p_j$, the genotype count $x_j \\in \\{0,1,2\\}$ is distributed as a binomial random variable with $n=2$ and probability $p_j$, yielding $\\mathbb{E}[x_j] = 2p_j$ and $\\mathrm{Var}(x_j) = 2p_j(1-p_j)$. The raw PRS is $S = \\sum_{j=1}^{m} \\beta_j x_j$, where $\\beta_j$ is the per-risk-allele log-odds weight from a validated genome-wide association study. The standardized PRS $z$-score for an individual is defined as $z = \\dfrac{S - \\mu_S}{\\sigma_S}$, where $\\mu_S = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$ and $\\sigma_S = \\sqrt{\\sum_{j=1}^{m} \\beta_j^{2} \\mathrm{Var}(x_j)}$ under the independence assumption.\n\nTo translate the standardized PRS into absolute risk, use a logistic model grounded in the definitions of odds and log-odds: the odds for probability $p$ is $\\dfrac{p}{1-p}$, the log-odds (logit) is $\\ln\\!\\left(\\dfrac{p}{1-p}\\right)$, and the inverse-logit (logistic function) is $\\dfrac{1}{1+\\exp(-\\eta)}$ for linear predictor $\\eta$. Suppose the module encodes the population-calibrated baseline incidence $I_0$ as the risk at standardized PRS $z=0$, and models the effect of the PRS as a log-odds shift of $\\gamma$ per one standard deviation of $z$, so that for an individual with standardized PRS $z$, the linear predictor is $\\eta = \\alpha + \\gamma z$, with intercept $\\alpha$ satisfying $\\alpha = \\ln\\!\\left(\\dfrac{I_0}{1-I_0}\\right)$.\n\nConsider $m=5$ SNPs with the following parameters, where all $\\beta_j$ are per-allele log-odds weights, $p_j$ are population risk allele frequencies, and $x_j$ are the individual’s observed risk-allele counts:\n- SNP $1$: $\\beta_1 = 0.12$, $p_1 = 0.30$, $x_1 = 1$.\n- SNP $2$: $\\beta_2 = -0.08$, $p_2 = 0.45$, $x_2 = 0$.\n- SNP $3$: $\\beta_3 = 0.25$, $p_3 = 0.10$, $x_3 = 1$.\n- SNP $4$: $\\beta_4 = 0.05$, $p_4 = 0.60$, $x_4 = 1$.\n- SNP $5$: $\\beta_5 = 0.15$, $p_5 = 0.20$, $x_5 = 2$.\n\nAssume a baseline incidence $I_0 = 0.12$ and a per-standard-deviation log-odds effect $\\gamma = 0.35$. Using only the fundamental definitions provided above (binomial genotype model under Hardy–Weinberg Equilibrium, independence across SNPs, odds, log-odds, and the logistic link), compute the individual’s standardized PRS $z$ and then derive the absolute risk $p$ from the log-odds model. Report only the final absolute risk as a decimal. Round your final answer to four significant figures. No percentage signs are permitted.", "solution": "The problem is deemed valid as it is scientifically grounded in established principles of statistical genetics and epidemiology, well-posed with sufficient information for a unique solution, and expressed in objective, formal language. The solution proceeds by methodically applying the definitions provided in the problem statement.\n\nThe calculation is performed in a series of steps:\n1.  Compute the population mean $\\mathbb{E}[x_j]$ and variance $\\mathrm{Var}(x_j)$ for the genotype count of each of the $m=5$ SNPs.\n2.  Compute the individual's raw Polygenic Risk Score (PRS), $S$.\n3.  Compute the population mean PRS, $\\mu_S$.\n4.  Compute the population variance, $\\sigma_S^2$, and standard deviation, $\\sigma_S$, of the PRS.\n5.  Compute the individual's standardized PRS $z$-score.\n6.  Compute the individual's absolute risk $p$ using the provided logistic risk model.\n\n**Step 1: Population moments for each SNP**\nFor each SNP $j$, the genotype count $x_j$ is a binomial random variable with parameters $n=2$ and probability $p_j$. The mean and variance are given by:\n$\\mathbb{E}[x_j] = 2p_j$\n$\\mathrm{Var}(x_j) = 2p_j(1-p_j)$\n\nUsing the provided risk allele frequencies $p_j$:\n- For SNP $1$ ($p_1 = 0.30$):\n  $\\mathbb{E}[x_1] = 2(0.30) = 0.60$\n  $\\mathrm{Var}(x_1) = 2(0.30)(1 - 0.30) = 0.42$\n- For SNP $2$ ($p_2 = 0.45$):\n  $\\mathbb{E}[x_2] = 2(0.45) = 0.90$\n  $\\mathrm{Var}(x_2) = 2(0.45)(1 - 0.45) = 0.495$\n- For SNP $3$ ($p_3 = 0.10$):\n  $\\mathbb{E}[x_3] = 2(0.10) = 0.20$\n  $\\mathrm{Var}(x_3) = 2(0.10)(1 - 0.10) = 0.18$\n- For SNP $4$ ($p_4 = 0.60$):\n  $\\mathbb{E}[x_4] = 2(0.60) = 1.20$\n  $\\mathrm{Var}(x_4) = 2(0.60)(1 - 0.60) = 0.48$\n- For SNP $5$ ($p_5 = 0.20$):\n  $\\mathbb{E}[x_5] = 2(0.20) = 0.40$\n  $\\mathrm{Var}(x_5) = 2(0.20)(1 - 0.20) = 0.32$\n\n**Step 2: Individual's raw PRS, $S$**\nThe raw PRS is the weighted sum of the individual's risk allele counts: $S = \\sum_{j=1}^{m} \\beta_j x_j$.\nSubstituting the given $\\beta_j$ and $x_j$ values:\n$$S = (0.12)(1) + (-0.08)(0) + (0.25)(1) + (0.05)(1) + (0.15)(2)$$\n$$S = 0.12 + 0 + 0.25 + 0.05 + 0.30 = 0.72$$\n\n**Step 3: Population mean PRS, $\\mu_S$**\nThe population mean of the PRS is $\\mu_S = \\mathbb{E}[S] = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$.\nSubstituting the $\\beta_j$ and the calculated $\\mathbb{E}[x_j]$:\n$$\\mu_S = (0.12)(0.60) + (-0.08)(0.90) + (0.25)(0.20) + (0.05)(1.20) + (0.15)(0.40)$$\n$$\\mu_S = 0.072 - 0.072 + 0.050 + 0.060 + 0.060 = 0.170$$\n\n**Step 4: Population variance and standard deviation of the PRS**\nThe population variance of the PRS, assuming independence across SNPs, is $\\sigma_S^2 = \\mathrm{Var}(S) = \\sum_{j=1}^{m} \\beta_j^2 \\mathrm{Var}(x_j)$.\n$$\\sigma_S^2 = (0.12)^2(0.42) + (-0.08)^2(0.495) + (0.25)^2(0.18) + (0.05)^2(0.48) + (0.15)^2(0.32)$$\n$$\\sigma_S^2 = (0.0144)(0.42) + (0.0064)(0.495) + (0.0625)(0.18) + (0.0025)(0.48) + (0.0225)(0.32)$$\n$$\\sigma_S^2 = 0.006048 + 0.003168 + 0.01125 + 0.0012 + 0.0072$$\n$$\\sigma_S^2 = 0.028866$$\nThe standard deviation is the square root of the variance:\n$$\\sigma_S = \\sqrt{0.028866}$$\n\n**Step 5: Standardized PRS $z$-score**\nThe standardized PRS is $z = \\dfrac{S - \\mu_S}{\\sigma_S}$.\n$$z = \\frac{0.72 - 0.170}{\\sqrt{0.028866}} = \\frac{0.55}{\\sqrt{0.028866}}$$\n$$z \\approx \\frac{0.55}{0.16989997} \\approx 3.237216$$\n\n**Step 6: Individual absolute risk, $p$**\nThe absolute risk is determined by a logistic model with linear predictor $\\eta = \\alpha + \\gamma z$.\nFirst, calculate the intercept $\\alpha$ based on the baseline incidence $I_0 = 0.12$:\n$$\\alpha = \\ln\\left(\\frac{I_0}{1-I_0}\\right) = \\ln\\left(\\frac{0.12}{1-0.12}\\right) = \\ln\\left(\\frac{0.12}{0.88}\\right) = \\ln\\left(\\frac{3}{22}\\right)$$\n$$\\alpha \\approx -1.992430$$\nNext, calculate the linear predictor $\\eta$ using $\\gamma = 0.35$ and the calculated $z$:\n$$\\eta = \\alpha + \\gamma z = \\ln\\left(\\frac{3}{22}\\right) + (0.35)\\left(\\frac{0.55}{\\sqrt{0.028866}}\\right)$$\n$$\\eta \\approx -1.992430 + (0.35)(3.237216) \\approx -1.992430 + 1.133026$$\n$$\\eta \\approx -0.859404$$\nFinally, calculate the absolute risk $p$ using the inverse-logit function:\n$$p = \\frac{1}{1 + \\exp(-\\eta)}$$\n$$p = \\frac{1}{1 + \\exp(-(-0.859404))} = \\frac{1}{1 + \\exp(0.859404)}$$\n$$p \\approx \\frac{1}{1 + 2.36173} \\approx \\frac{1}{3.36173} \\approx 0.297464$$\nRounding the final result to four significant figures gives $0.2975$.", "answer": "$$\\boxed{0.2975}$$", "id": "4324199"}, {"introduction": "The ultimate purpose of a genomic CDSS is to deliver precise, actionable recommendations directly into the clinical workflow at the point of care. This requires translating evidence-based clinical guidelines into deterministic, computational rules that an Electronic Health Record (EHR) system can execute. This hands-on coding problem simulates this process by asking you to implement a pharmacogenomic dosing rule from the Clinical Pharmacogenetics Implementation Consortium (CPIC) using the CDS Hooks interoperability standard [@problem_id:4324236]. By building a service that automatically suggests a thiopurine dose adjustment based on a patient's genotype, you will bridge the critical gap between abstract clinical knowledge and practical health IT implementation.", "problem": "You are to implement a complete, runnable program that encodes an actionable Clinical Pharmacogenetics Implementation Consortium (CPIC) guideline recommendation into a rules engine trigger compatible with Clinical Decision Support (CDS) Hooks and computes a dosing suggestion to be rendered in the Electronic Health Record (EHR). The goal is to formalize the minimal input (payload) and the decision logic needed to produce a quantitative thiopurine dosing recommendation based on thiopurine S-methyltransferase (TPMT) and nudix hydrolase 15 (NUDT15) pharmacogenomic phenotypes.\n\nFundamental base to use:\n- Genotype-to-phenotype-to-therapy is grounded in the Central Dogma of Molecular Biology and pharmacokinetics: inherited variants in enzyme-encoding genes alter enzyme activity, which alters active metabolite exposure. This is a well-tested basis for pharmacogenomics.\n- CPIC (Clinical Pharmacogenetics Implementation Consortium) provides clinically validated recommendations for thiopurines conditioned on TPMT and NUDT15 phenotypes. You may treat the phenotype-to-dose adjustment categories below as well-tested facts.\n- CDS Hooks is an event-driven specification where a service receives a request when a particular clinical workflow event occurs. The hook identifier and context determine whether a rule should fire.\n\nMinimal payload definition (as a set of key-value constraints):\n- The request is a single dictionary with the following keys:\n  - \"hook\": a string equal to \"medication-prescribe\".\n  - \"context\": a dictionary that must include:\n    - \"medication\": a case-insensitive string naming the drug.\n    - \"standardDoseMg\": a real value in milligrams representing the clinician-entered standard dose for this patient. Denote this by $D_s$ with unit mg.\n  - \"prefetch\": a dictionary that may include:\n    - \"genomics\": a list of zero or more dictionaries, each with:\n      - \"gene\": a case-insensitive string equal to \"TPMT\" or \"NUDT15\".\n      - \"phenotype\": a case-insensitive string equal to \"Normal metabolizer\", \"Intermediate metabolizer\", or \"Poor metabolizer\". Denote the TPMT phenotype by $P_{\\mathrm{TPMT}}$ and the NUDT15 phenotype by $P_{\\mathrm{NUDT15}}$.\n\nTrigger semantics:\n- The rule triggers if and only if the value of \"hook\" equals \"medication-prescribe\" and the value of \"medication\" is in the set of thiopurines: {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"} (case-insensitive). Otherwise, no pharmacogenomic adjustment should be applied.\n\nDose adjustment facts to be used as the foundational starting point:\n- For patients with both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ equal to \"Normal metabolizer\", the initial dose multiplier is $m = 1.0$.\n- For patients with exactly one of $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ equal to \"Intermediate metabolizer\" and the other \"Normal metabolizer\", the initial dose multiplier is $m = 0.5$.\n- For patients with both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ equal to \"Intermediate metabolizer\", the initial dose multiplier is $m = 0.2$.\n- For patients with either $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ equal to \"Poor metabolizer\", the initial dose multiplier is $m = 0.1$.\n- If a gene is missing from \"genomics\", treat the missing gene as \"Normal metabolizer\" for the purpose of computing $m$.\n- If the rule does not trigger, set $m = 1.0$.\n\nDecision computation and output:\n- Let $D_s$ be the standard dose in milligrams.\n- Compute the recommended dose $D_r = m \\times D_s$ in milligrams.\n- Round $D_r$ to the nearest integer milligram using half-up rounding (i.e., values with fractional part exactly $0.5$ round up, away from zero).\n- Your program must output only a single line containing a comma-separated list of the integer recommendations for the specified test suite, enclosed in square brackets.\n\nUnit specification:\n- All doses must be expressed in milligrams (mg) as integers after rounding.\n\nAngle and percentage specification:\n- No angles are used.\n- Any fractional multipliers must be treated as decimals (e.g., $0.5$), not percentages.\n\nTest suite:\nFor each test case below, construct the payload and compute the final integer $D_r$ in mg.\n\n- Test case $1$ (happy path, both normal):\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $2$ (single intermediate):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $3$ (poor for one gene):\n  - \"medication\" = \"thioguanine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Poor metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $4$ (both intermediate):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 40$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Intermediate metabolizer\"\n  - Expected trigger: yes\n\n- Test case $5$ (missing genomics, default behavior):\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 60$ mg\n  - \"genomics\" list is empty\n  - Expected trigger: yes\n\n- Test case $6$ (half-up rounding check):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 35$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Poor metabolizer\"\n  - Expected trigger: yes\n\n- Test case $7$ (non-target medication, rule does not trigger):\n  - \"medication\" = \"clopidogrel\"\n  - $D_s = 75$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: no\n\nRequired final output format:\n- Your program should produce a single line of output containing the results for the seven test cases as a comma-separated list enclosed in square brackets (e.g., \"[$x_1,x_2,x_3,x_4,x_5,x_6,x_7$]\"), where each $x_i$ is the integer $D_r$ in mg for test case $i$ in order.", "solution": "The problem requires the formalization and implementation of a clinical decision support (CDS) rule based on the Clinical Pharmacogenetics Implementation Consortium (CPIC) guidelines for thiopurine dosing. The implementation must be compatible with the CDS Hooks specification, translating pharmacogenomic phenotypes for thiopurine S-methyltransferase ($TPMT$) and nudix hydrolase 15 ($NUDT15$) into a specific dosing recommendation. The solution entails a systematic, step-by-step translation of the provided clinical logic into a computational algorithm.\n\nFirst, a validation of the problem statement is necessary.\n\n**Step 1: Extract Givens**\n\n- **Hook Specification**: The rule is triggered by a CDS Hooks request where the `hook` identifier is `\"medication-prescribe\"`.\n- **Triggering Medication Set**: The rule applies if the prescribed `medication` is one of `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` (case-insensitive).\n- **Input Data Structure (Payload)**:\n  - `hook`: string, must be `\"medication-prescribe\"`.\n  - `context`: dictionary containing:\n    - `medication`: string, name of the drug.\n    - `standardDoseMg`: real number, the standard dose $D_s$ in milligrams (mg).\n  - `prefetch`: dictionary that may contain:\n    - `genomics`: a list of dictionaries, each with:\n      - `gene`: string, `\"TPMT\"` or `\"NUDT15\"` (case-insensitive).\n      - `phenotype`: string, `\"Normal metabolizer\"`, `\"Intermediate metabolizer\"`, or `\"Poor metabolizer\"` (case-insensitive). We denote these by $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$.\n- **Dose Adjustment Rules (Multiplier $m$)**:\n  1. If the trigger conditions are not met, the dose multiplier $m$ is $1.0$.\n  2. If a gene's phenotype is missing, it is assumed to be `\"Normal metabolizer\"`.\n  3. If both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ are `\"Normal metabolizer\"`, then $m = 1.0$.\n  4. If one phenotype is `\"Intermediate metabolizer\"` and the other is `\"Normal metabolizer\"`, then $m = 0.5$.\n  5. If both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ are `\"Intermediate metabolizer\"`, then $m = 0.2$.\n  6. If either $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ is `\"Poor metabolizer\"`, then $m = 0.1$.\n- **Computation and Output**:\n  - The recommended dose is calculated as $D_r = m \\times D_s$.\n  - The final result $D_r$ must be rounded to the nearest integer using half-up rounding.\n  - The output is a single-line string with comma-separated integer results for the test suite, enclosed in square brackets.\n- **Test Suite**: Seven specific test cases are provided with defined inputs and expected trigger behavior.\n\n**Step 2: Validate Using Extracted Givens**\n\n- **Scientifically Grounded**: The problem is grounded in established pharmacogenomic principles and references real-world, evidence-based CPIC guidelines and the CDS Hooks technical standard. The relationship between $TPMT$/$NUDT15$ genetic variants, enzyme activity, and thiopurine metabolism is a cornerstone of personalized medicine. The provided dose adjustment factors are simplifications but representative of the actual clinical guidelines. The problem is scientifically sound.\n- **Well-Posed**: The problem is well-posed. The inputs are rigorously defined, the logical rules for dose adjustment are deterministic and cover all specified combinations, and the default behavior for missing data is explicitly stated. The calculation and rounding rules are unambiguous, ensuring a unique solution for any valid input.\n- **Objective**: The problem is stated in precise, objective language, free of ambiguity or subjective claims. All parameters and rules are quantitative or logical.\n\n**Step 3: Verdict and Action**\n\nThe problem statement is valid. It is scientifically grounded, well-posed, and objective. It provides a complete and consistent set of requirements for developing a computational solution. We may proceed with the solution design.\n\n**Solution Design and Algorithm**\n\nThe core of the solution is a function that processes an input payload, applies the triggering and dosing logic, and returns a computed dose. This process can be broken down into four main stages.\n\n**1. Rule Trigger Evaluation**\nThe first step is to determine if the pharmacogenomic-based dosing rule should be applied. This is governed by two conditions that must be met simultaneously:\n- The context of the CDS Hooks call must be a medication prescription event. This is verified by checking if the input `hook` key has a value equal to `\"medication-prescribe\"`.\n- The prescribed medication must be a thiopurine. This is verified by checking if the case-insensitive value of the `medication` key is present in the set `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}`.\n\nIf either of these conditions fails, the rule does not trigger. In this scenario, the dose multiplier $m$ is set to $1.0$, and the recommended dose $D_r$ is simply the standard dose $D_s$.\n\n**2. Phenotype Determination with Defaults**\nIf the rule triggers, the next step is to ascertain the patient's $TPMT$ and $NUDT15$ metabolic phenotypes. The problem specifies default values: if a gene's phenotype is not provided in the `prefetch` section of the payload, it should be treated as `\"Normal metabolizer\"`.\nThe algorithm will therefore initialize the phenotypes $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ to `\"Normal metabolizer\"`. It then iterates through the `genomics` list in the `prefetch` data. For each entry, it identifies the gene (e.g., `\"TPMT\"` or `\"NUDT15\"`) and its corresponding phenotype, updating the initialized values. This process must be case-insensitive for both gene names and phenotype descriptions.\n\n**3. Dose Multiplier ($m$) Calculation**\nWith both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ determined, the dose multiplier $m$ can be calculated based on the provided hierarchy of rules. To ensure correctness, these rules must be evaluated in order of precedence, starting with the most critical phenotype (Poor Metabolizer). Let us represent the phenotypes canonically as NM (Normal Metabolizer), IM (Intermediate Metabolizer), and PM (Poor Metabolizer).\n\nThe logic is as follows:\n- **Condition 1 (Highest Precedence)**: If $P_{\\mathrm{TPMT}} = \\text{PM}$ or $P_{\\mathrm{NUDT15}} = \\text{PM}$, set $m = 0.1$. This rule overrides all others.\n- **Condition 2**: Else, if $P_{\\mathrm{TPMT}} = \\text{IM}$ and $P_{\\mathrm{NUDT15}} = \\text{IM}$, set $m = 0.2$.\n- **Condition 3**: Else, if ($P_{\\mathrm{TPMT}} = \\text{IM}$ and $P_{\\mathrm{NUDT15}} = \\text{NM}$) or ($P_{\\mathrm{TPMT}} = \\text{NM}$ and $P_{\\mathrm{NUDT15}} = \\text{IM}$), set $m = 0.5$.\n- **Condition 4 (Base Case)**: Else (which implies $P_{\\mathrm{TPMT}} = \\text{NM}$ and $P_{\\mathrm{NUDT15}} = \\text{NM}$), set $m = 1.0$.\n\nThis structured evaluation ensures that the correct multiplier is selected according to the specified clinical logic.\n\n**4. Final Dose Calculation and Rounding**\nThe final step is to compute the recommended dose, $D_r$, and format it as required.\n- The unrounded recommended dose is calculated by the formula:\n$$D_r = m \\times D_s$$\nwhere $D_s$ is the standard dose provided in the input context.\n- The problem specifies half-up rounding to the nearest integer. For a non-negative value $x$, this can be implemented computationally as $\\lfloor x + 0.5 \\rfloor$, which is equivalent to `int(x + 0.5)` in Python for positive numbers.\n\nBy applying this four-step process to each test case in the provided suite, we can generate the required list of integer dose recommendations. The final implementation encapsulates this logic into a complete, runnable program.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print the final results.\n    \"\"\"\n\n    # Define the test cases from the problem statement as a list of dictionaries.\n    test_cases = [\n        # Test case 1 (happy path, both normal)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 2 (single intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 3 (poor for one gene)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"thioguanine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Poor metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 4 (both intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 40},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Intermediate metabolizer\"},\n                ]\n            },\n        },\n        # Test case 5 (missing genomics, default behavior)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 60},\n            \"prefetch\": {\"genomics\": []},\n        },\n        # Test case 6 (half-up rounding check)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 35},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Poor metabolizer\"},\n                ]\n            },\n        },\n        # Test case 7 (non-target medication, rule does not trigger)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"clopidogrel\", \"standardDoseMg\": 75},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n    ]\n\n    results = [compute_recommendation(case) for case in test_cases]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_recommendation(payload: dict) -> int:\n    \"\"\"\n    Computes a thiopurine dosing recommendation based on a CDS Hooks payload.\n\n    Args:\n        payload: A dictionary representing the CDS Hooks request.\n\n    Returns:\n        The recommended dose in milligrams, rounded to the nearest integer.\n    \"\"\"\n    \n    # Define constants for the rule logic.\n    THIOPURINES = {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}\n    \n    # Phenotype canonical representations for internal use.\n    NM = \"normal metabolizer\"\n    IM = \"intermediate metabolizer\"\n    PM = \"poor metabolizer\"\n\n    context = payload.get(\"context\", {})\n    standard_dose = context.get(\"standardDoseMg\", 0.0)\n    medication = context.get(\"medication\", \"\").lower()\n    hook = payload.get(\"hook\", \"\")\n\n    # 1. Rule Trigger Evaluation\n    # Rule triggers only for thiopurine prescriptions.\n    if not (hook == \"medication-prescribe\" and medication in THIOPURINES):\n        # If the rule doesn't trigger, use the standard dose (multiplier is 1.0).\n        # Rounding is still applied to handle potential float inputs.\n        return int(standard_dose + 0.5)\n\n    # 2. Phenotype Determination with Defaults\n    # Default phenotypes to \"Normal metabolizer\".\n    phenotypes = {\"tpmt\": NM, \"nudt15\": NM}\n\n    prefetch = payload.get(\"prefetch\", {})\n    genomics_data = prefetch.get(\"genomics\", [])\n    \n    for record in genomics_data:\n        gene = record.get(\"gene\", \"\").lower()\n        phenotype = record.get(\"phenotype\", \"\").lower()\n        if gene in phenotypes:\n            phenotypes[gene] = phenotype\n    \n    p_tpmt = phenotypes[\"tpmt\"]\n    p_nudt15 = phenotypes[\"nudt15\"]\n\n    # 3. Dose Multiplier (m) Calculation\n    # The rules are checked in order of highest precedence (most severe impact).\n    multiplier = 1.0  # Default multiplier\n\n    if p_tpmt == PM or p_nudt15 == PM:\n        multiplier = 0.1\n    elif p_tpmt == IM and p_nudt15 == IM:\n        multiplier = 0.2\n    elif (p_tpmt == IM and p_nudt15 == NM) or (p_tpmt == NM and p_nudt15 == IM):\n        multiplier = 0.5\n    elif p_tpmt == NM and p_nudt15 == NM:\n        multiplier = 1.0\n        \n    # 4. Final Dose Calculation and Rounding\n    recommended_dose_unrounded = multiplier * standard_dose\n    \n    # Apply half-up rounding. For positive numbers, int(x + 0.5) suffices.\n    final_dose = int(recommended_dose_unrounded + 0.5)\n    \n    return final_dose\n\nsolve()\n```", "id": "4324236"}]}