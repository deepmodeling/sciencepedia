{"hands_on_practices": [{"introduction": "A central challenge in isoform quantification is that a single sequencing fragment can be compatible with multiple transcripts. This ambiguity is handled by grouping fragments into \"equivalence classes\" and then deconvolving the counts mathematically. This exercise provides a hands-on look at the core linear algebra of this deconvolution, where you will set up and solve a linear system to estimate isoform abundances from ambiguous fragment evidence [@problem_id:4393439].", "problem": "A gene implicated in a precision oncology panel expresses three transcript isoforms, denoted $T_{1}$, $T_{2}$, and $T_{3}$. A bias-corrected RNA sequencing (RNA-Seq) pipeline groups sequenced fragments into three equivalence classes based on compatibility with sets of isoforms, denoted $E_{1}$, $E_{2}$, and $E_{3}$. The pipeline reports observed fragment counts $c_{i}$ for each equivalence class $E_{i}$ and models fragment generation as a mixture: fragments are generated from transcript isoform $T_{j}$ in proportion to its unknown fragment count $f_{j}$, and a fragment from $T_{j}$ contributes to equivalence class $E_{i}$ with a known conditional probability $A_{ij}$ reflecting mapping compatibility and effective length corrections. The total expected count in each equivalence class is the sum of contributions from all isoforms.\n\nUsing core definitions of mixture models and the linearity of expectation in count processes, derive an explicit linear system relating the observed equivalence class counts to the unknown transcript fragment counts via a matrix whose entries are the conditional probabilities described above. Then, for the following bias-corrected compatibility matrix and observed counts,\n$$\nA \\;=\\;\n\\begin{pmatrix}\n0.5 & 0.3 & 0.2 \\\\\n0.2 & 0.4 & 0.4 \\\\\n0.3 & 0.3 & 0.4\n\\end{pmatrix},\n\\qquad\nc \\;=\\;\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix},\n$$\nformulate the corresponding linear system and determine whether it admits a solution with the nonnegativity constraints $f_{1} \\geq 0$, $f_{2} \\geq 0$, $f_{3} \\geq 0$. If solvable, compute the unique solution for the fragment count vector $f = (f_{1}, f_{2}, f_{3})$. Express the final fragment count vector as a row matrix. No rounding is required.", "solution": "The user wants me to solve a problem about transcript isoform quantification.\n\n**Problem Validation**\n\n**Step 1: Extract Givens**\n-   Transcript isoforms: $T_{1}$, $T_{2}$, $T_{3}$.\n-   Equivalence classes: $E_{1}$, $E_{2}$, $E_{3}$.\n-   Observed fragment counts for each equivalence class $E_{i}$ are given by the vector $c$.\n-   Unknown fragment counts for each transcript isoform $T_{j}$ are given by the vector $f$, with components $f_{j}$.\n-   The conditional probability that a fragment from $T_{j}$ contributes to equivalence class $E_{i}$ is $A_{ij}$.\n-   The model is described as a mixture: the total expected count in each equivalence class is the sum of contributions from all isoforms.\n-   The specific compatibility matrix $A$ is:\n$$\nA \\;=\\;\n\\begin{pmatrix}\n0.5 & 0.3 & 0.2 \\\\\n0.2 & 0.4 & 0.4 \\\\\n0.3 & 0.3 & 0.4\n\\end{pmatrix}\n$$\n-   The specific observed count vector $c$ is:\n$$\nc \\;=\\;\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\n-   Nonnegativity constraints are imposed on the solution: $f_{1} \\ge 0$, $f_{2} \\ge 0$, $f_{3} \\ge 0$.\n\n**Step 2: Validate Using Extracted Givens**\n-   **Scientifically Grounded:** The problem describes a simplified but standard and scientifically valid model for transcript isoform quantification from RNA-Seq data. The use of equivalence classes and a mixture model to deconvolve counts is a cornerstone of widely used bioinformatics tools (e.g., RSEM, Kallisto, Salmon). The formulation is consistent with established principles in computational biology.\n-   **Well-Posed:** The problem is well-posed. It requires deriving and solving a system of linear equations. The problem provides all necessary data (a matrix $A$ and a vector $c$) and clear instructions. The existence and uniqueness of a solution depend on the properties of the matrix $A$. The determinant of $A$ can be computed:\n    $$\n    \\det(A) = 0.5(0.4 \\cdot 0.4 - 0.4 \\cdot 0.3) - 0.3(0.2 \\cdot 0.4 - 0.4 \\cdot 0.3) + 0.2(0.2 \\cdot 0.3 - 0.4 \\cdot 0.3)\n    $$\n    $$\n    \\det(A) = 0.5(0.16 - 0.12) - 0.3(0.08 - 0.12) + 0.2(0.06 - 0.12)\n    $$\n    $$\n    \\det(A) = 0.5(0.04) - 0.3(-0.04) + 0.2(-0.06) = 0.02 + 0.012 - 0.012 = 0.02\n    $$\n    Since $\\det(A) \\neq 0$, the matrix $A$ is invertible, which implies that a unique solution to the linear system exists. The problem then correctly asks to check if this unique solution satisfies the nonnegativity constraints.\n-   **Objective:** The problem is stated using precise, objective, and standard scientific terminology. It is free of ambiguity or subjective claims.\n-   **Other Flaws:** The problem does not exhibit any other flaws from the checklist. The data is self-consistent; for instance, the columns of matrix $A$ each sum to $1$, which is expected if $A_{ij}$ represents $P(\\text{class } i | \\text{isoform } j)$ and all fragments are assigned to one of the classes.\n\n**Step 3: Verdict and Action**\nThe problem is valid. A complete solution will be provided.\n\n**Solution Derivation**\n\nThe problem requires relating the observed equivalence class counts ($c$) to the unknown transcript fragment counts ($f$) via the compatibility matrix $A$.\n\nLet $f_{j}$ be the unknown number of fragments originating from transcript isoform $T_{j}$. Let $c_{i}$ be the observed number of fragments assigned to equivalence class $E_{i}$. The conditional probability that a fragment originating from isoform $T_{j}$ is compatible with (and thus contributes to) equivalence class $E_{i}$ is given by $A_{ij}$.\n\nThe total expected number of fragments in equivalence class $E_{i}$, denoted $\\mathbb{E}[c_{i}]$, is the sum of the expected contributions from each transcript isoform. The expected contribution from isoform $T_{j}$ to class $E_{i}$ is the product of the total number of fragments from $T_{j}$ and the conditional probability of assignment, i.e., $f_{j} A_{ij}$.\n\nSumming over all isoforms $j \\in \\{1, 2, 3\\}$, we get the total expected count for class $E_{i}$:\n$$\n\\mathbb{E}[c_{i}] = \\sum_{j=1}^{3} A_{ij} f_{j}\n$$\nIn this modeling framework, the observed counts $c_{i}$ are treated as the best estimates for their expected values, $\\mathbb{E}[c_{i}]$. Therefore, we establish the relationship:\n$$\nc_{i} = \\sum_{j=1}^{3} A_{ij} f_{j}\n$$\nThis set of three equations (for $i=1, 2, 3$) can be written in matrix form. Let $c$ be the column vector of observed counts and $f$ be the column vector of unknown isoform counts. The relationship is:\n$$\n\\begin{pmatrix} c_{1} \\\\ c_{2} \\\\ c_{3} \\end{pmatrix} = \\begin{pmatrix}\nA_{11} & A_{12} & A_{13} \\\\\nA_{21} & A_{22} & A_{23} \\\\\nA_{31} & A_{32} & A_{33}\n\\end{pmatrix}\n\\begin{pmatrix} f_{1} \\\\ f_{2} \\\\ f_{3} \\end{pmatrix}\n$$\nThis is the linear system $c = Af$.\n\nNow, we substitute the given numerical values for $A$ and $c$:\n$$\n\\begin{pmatrix}\n0.5 & 0.3 & 0.2 \\\\\n0.2 & 0.4 & 0.4 \\\\\n0.3 & 0.3 & 0.4\n\\end{pmatrix}\n\\begin{pmatrix}\nf_{1} \\\\\nf_{2} \\\\\nf_{3}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\nTo solve for the vector $f$, we must compute the inverse of matrix $A$, denoted $A^{-1}$. The solution is then given by $f = A^{-1}c$. As established during validation, $\\det(A) = 0.02$, so the inverse exists.\n\nThe inverse matrix $A^{-1}$ is calculated via the formula $A^{-1} = \\frac{1}{\\det(A)}\\text{adj}(A)$, where $\\text{adj}(A)$ is the adjugate of $A$ (the transpose of its cofactor matrix).\n\nThe cofactor matrix $C$ of A has entries $C_{ij} = (-1)^{i+j}M_{ij}$, where $M_{ij}$ is the minor of the entry $A_{ij}$.\n$C_{11} = (0.4)(0.4) - (0.4)(0.3) = 0.16 - 0.12 = 0.04$\n$C_{12} = -((0.2)(0.4) - (0.4)(0.3)) = -(0.08 - 0.12) = 0.04$\n$C_{13} = (0.2)(0.3) - (0.4)(0.3) = 0.06 - 0.12 = -0.06$\n$C_{21} = -((0.3)(0.4) - (0.2)(0.3)) = -(0.12 - 0.06) = -0.06$\n$C_{22} = (0.5)(0.4) - (0.2)(0.3) = 0.20 - 0.06 = 0.14$\n$C_{23} = -((0.5)(0.3) - (0.3)(0.3)) = -(0.15 - 0.09) = -0.06$\n$C_{31} = (0.3)(0.4) - (0.2)(0.4) = 0.12 - 0.08 = 0.04$\n$C_{32} = -((0.5)(0.4) - (0.2)(0.2)) = -(0.20 - 0.04) = -0.16$\n$C_{33} = (0.5)(0.4) - (0.3)(0.2) = 0.20 - 0.06 = 0.14$\n\nThe cofactor matrix is $C = \\begin{pmatrix} 0.04 & 0.04 & -0.06 \\\\ -0.06 & 0.14 & -0.06 \\\\ 0.04 & -0.16 & 0.14 \\end{pmatrix}$.\nThe adjugate matrix is the transpose of $C$: $\\text{adj}(A) = C^T = \\begin{pmatrix} 0.04 & -0.06 & 0.04 \\\\ 0.04 & 0.14 & -0.16 \\\\ -0.06 & -0.06 & 0.14 \\end{pmatrix}$.\n\nThe inverse matrix is:\n$$\nA^{-1} = \\frac{1}{0.02} \\begin{pmatrix} 0.04 & -0.06 & 0.04 \\\\ 0.04 & 0.14 & -0.16 \\\\ -0.06 & -0.06 & 0.14 \\end{pmatrix} = 50 \\begin{pmatrix} 0.04 & -0.06 & 0.04 \\\\ 0.04 & 0.14 & -0.16 \\\\ -0.06 & -0.06 & 0.14 \\end{pmatrix} = \\begin{pmatrix} 2 & -3 & 2 \\\\ 2 & 7 & -8 \\\\ -3 & -3 & 7 \\end{pmatrix}\n$$\nNow we compute the solution vector $f = A^{-1}c$:\n$$\n\\begin{pmatrix}\nf_{1} \\\\\nf_{2} \\\\\nf_{3}\n\\end{pmatrix}\n=\n\\begin{pmatrix}\n2 & -3 & 2 \\\\\n2 & 7 & -8 \\\\\n-3 & -3 & 7\n\\end{pmatrix}\n\\begin{pmatrix}\n140 \\\\\n160 \\\\\n150\n\\end{pmatrix}\n$$\nThe components of $f$ are:\n$f_{1} = (2)(140) + (-3)(160) + (2)(150) = 280 - 480 + 300 = 100$\n$f_{2} = (2)(140) + (7)(160) + (-8)(150) = 280 + 1120 - 1200 = 200$\n$f_{3} = (-3)(140) + (-3)(160) + (7)(150) = -420 - 480 + 1050 = 150$\n\nThe solution for the fragment count vector is $f = (100, 200, 150)^T$.\n\nThe final step is to determine if this solution satisfies the nonnegativity constraints:\n$f_{1} = 100 \\ge 0$\n$f_{2} = 200 \\ge 0$\n$f_{3} = 150 \\ge 0$\nAll components are non-negative, so the system admits a valid, physically meaningful solution. The unique solution for the fragment count vector is indeed $(100, 200, 150)$.", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n100 & 200 & 150\n\\end{pmatrix}\n}\n$$", "id": "4393439"}, {"introduction": "Accurate comparison of gene expression across samples requires careful normalization, but not all methods are created equal. The once-common FPKM/RPKM metrics contain a critical statistical flaw that makes them unreliable for between-sample comparisons, particularly when a gene's isoform usage changes. By simulating a dataset based on the first principles of sequencing [@problem_id:4393431], this practice will allow you to personally demonstrate and understand why modern metrics like Transcripts Per Million (TPM) are more robust.", "problem": "You are asked to formalize and demonstrate, with a simulated dataset, why Reads Per Kilobase per Million mapped reads (RPKM) and Fragments Per Kilobase per Million mapped reads (FPKM) are unsuitable for between-sample comparisons when there is differential isoform usage. The setting is precision medicine and genomic diagnostics, specifically transcript discovery and isoform quantification. Start from the fundamental definitions and laws of molecular counting and uniform random sampling in sequencing.\n\nUse the following foundational base:\n- The Central Dogma of molecular biology: DNA is transcribed into RNA, and RNA molecules are fragmented and sequenced; the sequencing process samples fragments approximately uniformly across transcribed bases.\n- Under uniform sampling, the expected number of fragments from an isoform is proportional to the product of its molecule count and its length; that is, for isoform $j$ with length $L_j$ and molecule count $A_j$, the expected fragments $C_j$ satisfy $C_j \\propto A_j \\cdot L_j$.\n- The definition of Fragments Per Kilobase per Million mapped reads (FPKM): for a gene (treated as a single feature with length $L_{\\text{gene}}$), $$\\mathrm{FPKM}_{\\text{gene}} = \\frac{10^9 \\cdot C_{\\text{gene}}}{L_{\\text{gene}} \\cdot N},$$ where $C_{\\text{gene}}$ is the number of fragments mapping to the gene, $L_{\\text{gene}}$ is the gene length in bases, and $N$ is the total number of mapped fragments in the sample.\n- The analogous length-corrected isoform rate for isoform $j$ in a sample is $$R_j = \\frac{C_j}{L_j},$$ and Transcripts Per Million (TPM) at the gene level can be defined by aggregating isoforms as $$\\mathrm{TPM}_{\\text{gene}} = \\frac{10^6 \\cdot \\sum_{j \\in \\text{gene}} R_j}{\\sum_{k \\in \\text{all isoforms}} R_k}.$$\n\nYou will simulate deterministic expected fragment counts based on the proportionality above, without stochastic noise. Consider two genes in each test case. Each gene has two isoforms with specified lengths (in bases) and sample-specific isoform usage proportions. For a sample $S$, gene $g$ has total molecule count $T_{g}^{S}$ and isoform usage proportions $\\{p_{gj}^{S}\\}$ with $\\sum_j p_{gj}^{S} = 1$. The expected total “nucleotide mass” in sample $S$ is $$M_{\\text{total}}^{S} = \\sum_{g} \\sum_{j \\in g} T_{g}^{S} \\cdot p_{gj}^{S} \\cdot L_{gj}.$$ With a given total number of mapped fragments $N^{S}$ in sample $S$, the expected fragment count for isoform $j$ of gene $g$ is $$C_{gj}^{S} = N^{S} \\cdot \\frac{T_{g}^{S} \\cdot p_{gj}^{S} \\cdot L_{gj}}{M_{\\text{total}}^{S}},$$ and the expected fragment count for gene $g$ is $$C_{g}^{S} = \\sum_{j \\in g} C_{gj}^{S}.$$\n\nCompute for each gene $g$ the following quantities between two samples $A$ and $B$:\n1. The naive gene-level FPKM fold-change $$\\mathrm{FC}^{\\mathrm{FPKM}}_g = \\frac{\\mathrm{FPKM}_{g}^{B}}{\\mathrm{FPKM}_{g}^{A}},$$ using a fixed gene length $L_{g}^{\\text{union}}$ equal to the union-of-exons length (provided as the maximum isoform length in these test cases).\n2. The true molecule fold-change $$\\mathrm{FC}^{\\mathrm{true}}_g = \\frac{T_{g}^{B}}{T_{g}^{A}}.$$\n3. The gene-level TPM fold-change $$\\mathrm{FC}^{\\mathrm{TPM}}_g = \\frac{\\mathrm{TPM}_{g}^{B}}{\\mathrm{TPM}_{g}^{A}}.$$\n\nYour program must:\n- Implement the deterministic model above to compute $C_{gj}^{S}$, $C_{g}^{S}$, $\\mathrm{FPKM}_{g}^{S}$, and $\\mathrm{TPM}_{g}^{S}$ for each gene $g$ in samples $A$ and $B$.\n- For each test case, output a list of six floats in the order $[\\mathrm{FC}^{\\mathrm{FPKM}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{FPKM}}_{\\text{gene2}}, \\mathrm{FC}^{\\mathrm{true}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{true}}_{\\text{gene2}}, \\mathrm{FC}^{\\mathrm{TPM}}_{\\text{gene1}}, \\mathrm{FC}^{\\mathrm{TPM}}_{\\text{gene2}}]$.\n\nTest suite:\n- Case $1$ (happy path with strong differential isoform usage in one gene):\n  - Gene $1$: isoform lengths $[800, 3200]$, union-of-exons length $L_{1}^{\\text{union}} = 3200$.\n  - Gene $2$: isoform lengths $[2000, 2000]$, union-of-exons length $L_{2}^{\\text{union}} = 2000$.\n  - Sample $A$: $T_{1}^{A} = 100000$, $T_{2}^{A} = 100000$, proportions $p_{1}^{A} = [0.8, 0.2]$, $p_{2}^{A} = [0.5, 0.5]$, total fragments $N^{A} = 2000000$.\n  - Sample $B$: $T_{1}^{B} = 100000$, $T_{2}^{B} = 100000$, proportions $p_{1}^{B} = [0.2, 0.8]$, $p_{2}^{B} = [0.5, 0.5]$, total fragments $N^{B} = 2000000$.\n- Case $2$ (edge case where one gene’s isoforms have equal lengths but the other gene does not):\n  - Gene $1$: isoform lengths $[1000, 1000]$, union-of-exons length $L_{1}^{\\text{union}} = 1000$.\n  - Gene $2$: isoform lengths $[500, 3000]$, union-of-exons length $L_{2}^{\\text{union}} = 3000$.\n  - Sample $A$: $T_{1}^{A} = 150000$, $T_{2}^{A} = 150000$, proportions $p_{1}^{A} = [0.7, 0.3]$, $p_{2}^{A} = [0.9, 0.1]$, total fragments $N^{A} = 2000000$.\n  - Sample $B$: $T_{1}^{B} = 150000$, $T_{2}^{B} = 150000$, proportions $p_{1}^{B} = [0.3, 0.7]$, $p_{2}^{B} = [0.1, 0.9]$, total fragments $N^{B} = 2000000$.\n- Case $3$ (edge case with different library sizes and true differential expression confounded by isoform usage):\n  - Gene $1$: isoform lengths $[500, 4500]$, union-of-exons length $L_{1}^{\\text{union}} = 4500$.\n  - Gene $2$: isoform lengths $[2500, 2500]$, union-of-exons length $L_{2}^{\\text{union}} = 2500$.\n  - Sample $A$: $T_{1}^{A} = 100000$, $T_{2}^{A} = 200000$, proportions $p_{1}^{A} = [0.9, 0.1]$, $p_{2}^{A} = [0.5, 0.5]$, total fragments $N^{A} = 3000000$.\n  - Sample $B$: $T_{1}^{B} = 50000$, $T_{2}^{B} = 200000$, proportions $p_{1}^{B} = [0.1, 0.9]$, $p_{2}^{B} = [0.5, 0.5]$, total fragments $N^{B} = 1500000$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one test case and is itself a list of six floats in the order specified above, for example, $$[[x_1, x_2, x_3, x_4, x_5, x_6],[y_1, y_2, y_3, y_4, y_5, y_6],[z_1, z_2, z_3, z_4, z_5, z_6]].$$", "solution": "The problem statement has been critically validated and is deemed valid. It is scientifically grounded in the principles of transcriptomics and RNA sequencing data analysis, is well-posed with a clear and complete set of definitions and data, and is objective in its formulation. The problem correctly formalizes a well-documented artifact in the FPKM/RPKM normalization method and contrasts it with the properties of the TPM method, which is a key concept in genomic diagnostics and precision medicine.\n\nThe task is to demonstrate, through a deterministic simulation, why Fragments Per Kilobase per Million (FPKM) is unsuitable for between-sample comparisons of gene expression, particularly when differential isoform usage occurs. We will contrast this with the true fold-change in molecule count and the fold-change calculated from Transcripts Per Million (TPM).\n\n### Principle-Based Design\n\nThe solution is based on the provided model of RNA sequencing, which assumes that the expected number of fragments sequenced from a given transcript isoform is proportional to the product of its length and its abundance (number of molecules). We will implement a function that calculates key metrics for a given sample based on this principle and then use it to compute fold-changes between two samples ($A$ and $B$) for three test cases.\n\n**1. Model of Expected Fragment Counts**\n\nFor any given sample $S$, we are provided with the total molecule count for each gene $g$, denoted $T_g^S$, and the proportions $p_{gj}^S$ for each of its isoforms $j$. The molecule count of a specific isoform $j$ of gene $g$ is thus $A_{gj}^S = T_g^S \\cdot p_{gj}^S$.\n\nThe core assumption is that fragments are sampled uniformly from the total pool of all transcribed nucleotides. The total \"nucleotide mass\" of an isoform is its abundance multiplied by its length, $A_{gj}^S \\cdot L_{gj}$. The total nucleotide mass in the sample is the sum over all isoforms across all genes:\n$$M_{\\text{total}}^S = \\sum_{\\text{all genes } k} \\sum_{\\text{isoforms } i \\in k} T_k^S \\cdot p_{ki}^S \\cdot L_{ki}$$\n\nThe fraction of the total library that corresponds to isoform $gj$ is its nucleotide mass divided by the total nucleotide mass. Therefore, given a total number of sequenced fragments $N^S$, the expected fragment count for isoform $gj$ is:\n$$C_{gj}^S = N^S \\cdot \\frac{T_g^S \\cdot p_{gj}^S \\cdot L_{gj}}{M_{\\text{total}}^S}$$\n\nThe total fragment count for a gene $g$ is the sum of counts from its isoforms:\n$$C_g^S = \\sum_{j \\in g} C_{gj}^S$$\n\n**2. Quantification Metrics and Fold-Changes**\n\nWe will compute three types of fold-changes for each gene $g$ between samples $A$ and $B$.\n\n- **True Fold-Change ($\\mathrm{FC}^{\\mathrm{true}}_g$):** This is the ground truth, defined as the ratio of the total molecule counts of the gene in the two samples.\n  $$\\mathrm{FC}^{\\mathrm{true}}_g = \\frac{T_g^B}{T_g^A}$$\n\n- **FPKM Fold-Change ($\\mathrm{FC}^{\\mathrm{FPKM}}_g$):** FPKM for a gene is defined as:\n  $$\\mathrm{FPKM}_g^S = \\frac{10^9 \\cdot C_g^S}{L_g^{\\text{union}} \\cdot N^S}$$\n  where $L_g^{\\text{union}}$ is a fixed, representative length for the gene (here, the union-of-exons length). The fold-change is the ratio of FPKM values:\n  $$\\mathrm{FC}^{\\mathrm{FPKM}}_g = \\frac{\\mathrm{FPKM}_g^B}{\\mathrm{FPKM}_g^A} = \\frac{C_g^B / (L_g^{\\text{union}} \\cdot N^B)}{C_g^A / (L_g^{\\text{union}} \\cdot N^A)} = \\frac{C_g^B}{C_g^A} \\cdot \\frac{N^A}{N^B}$$\n  The problem with FPKM arises because $C_g^S$ depends on the *average transcript length* of gene $g$ in sample $S$, $\\bar{L}_g^S = \\sum_{j \\in g} p_{gj}^S L_{gj}$, and also on the total nucleotide mass $M_{\\text{total}}^S$ of the entire library. A change in isoform proportions for gene $g$ alters $\\bar{L}_g^S$, and a change in expression or isoform usage for *any* gene alters $M_{\\text{total}}^S$. Both effects create a non-linear bias, causing $\\mathrm{FC}^{\\mathrm{FPKM}}_g$ to deviate from $\\mathrm{FC}^{\\mathrm{true}}_g$.\n\n- **TPM Fold-Change ($\\mathrm{FC}^{\\mathrm{TPM}}_g$):** TPM is designed to represent the relative molar concentration of a gene's transcripts within a sample. It is defined based on length-normalized counts $R_j = C_j/L_j$:\n  $$\\mathrm{TPM}_g^S = \\frac{10^6 \\cdot \\sum_{j \\in g} R_j^S}{\\sum_{\\text{all isoforms } k} R_k^S}$$\n  A key insight is that this expression simplifies significantly. Since $R_j^S = (N^S/M_{\\text{total}}^S) \\cdot A_j^S$, the terms involving library size and composition cancel out:\n  $$\\mathrm{TPM}_g^S = 10^6 \\cdot \\frac{\\sum_{j \\in g} A_{gj}^S}{\\sum_{\\text{all isoforms } k} A_k^S} = 10^6 \\cdot \\frac{T_g^S}{\\sum_{\\text{all genes } k} T_k^S}$$\n  This shows that TPM is directly proportional to the gene's molecule count as a fraction of the total molecules in the sample. The TPM fold-change is therefore:\n  $$\\mathrm{FC}^{\\mathrm{TPM}}_g = \\frac{\\mathrm{TPM}_g^B}{\\mathrm{TPM}_g^A} = \\frac{T_g^B / \\sum_k T_k^B}{T_g^A / \\sum_k T_k^A} = \\left(\\frac{T_g^B}{T_g^A}\\right) \\cdot \\left(\\frac{\\sum_k T_k^A}{\\sum_k T_k^B}\\right) = \\mathrm{FC}^{\\mathrm{true}}_g \\cdot \\frac{\\text{Total Molecules in A}}{\\text{Total Molecules in B}}$$\n  TPM corrects for the length-based bias seen in FPKM. However, its fold-change is still not identical to the true fold-change unless the total number of molecules per sample is constant, a strong assumption that is often violated.\n\n**3. Implementation**\n\nThe implementation will consist of a primary function to iterate through the test cases. A helper function will be designed to perform the calculations for a single sample, taking as input the gene molecule counts, isoform proportions and lengths, and total fragment count. This function will calculate and return the FPKM and TPM values for each gene. The main function will call this helper for samples $A$ and $B$, then compute and collect the six required fold-change values for each test case.", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the problem by iterating through test cases and calculating fold-changes\n    for FPKM, true molecule count, and TPM between two samples.\n    \"\"\"\n\n    test_cases = [\n        # Case 1 (happy path with strong differential isoform usage in one gene)\n        {\n            \"gene_isoform_lengths\": np.array([[800, 3200], [2000, 2000]], dtype=float),\n            \"union_lengths\": np.array([3200, 2000], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([100000, 100000], dtype=float),\n                \"isoform_proportions\": np.array([[0.8, 0.2], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([100000, 100000], dtype=float),\n                \"isoform_proportions\": np.array([[0.2, 0.8], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            }\n        },\n        # Case 2 (edge case where one gene’s isoforms have equal lengths)\n        {\n            \"gene_isoform_lengths\": np.array([[1000, 1000], [500, 3000]], dtype=float),\n            \"union_lengths\": np.array([1000, 3000], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([150000, 150000], dtype=float),\n                \"isoform_proportions\": np.array([[0.7, 0.3], [0.9, 0.1]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([150000, 150000], dtype=float),\n                \"isoform_proportions\": np.array([[0.3, 0.7], [0.1, 0.9]], dtype=float),\n                \"total_mapped_fragments\": 2000000.0\n            }\n        },\n        # Case 3 (different library sizes and true differential expression)\n        {\n            \"gene_isoform_lengths\": np.array([[500, 4500], [2500, 2500]], dtype=float),\n            \"union_lengths\": np.array([4500, 2500], dtype=float),\n            \"sample_A\": {\n                \"gene_molecule_counts\": np.array([100000, 200000], dtype=float),\n                \"isoform_proportions\": np.array([[0.9, 0.1], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 3000000.0\n            },\n            \"sample_B\": {\n                \"gene_molecule_counts\": np.array([50000, 200000], dtype=float),\n                \"isoform_proportions\": np.array([[0.1, 0.9], [0.5, 0.5]], dtype=float),\n                \"total_mapped_fragments\": 1500000.0\n            }\n        }\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        # Calculate metrics for Sample A\n        fpkm_A, tpm_A = calculate_metrics(\n            case[\"sample_A\"][\"gene_molecule_counts\"],\n            case[\"sample_A\"][\"isoform_proportions\"],\n            case[\"gene_isoform_lengths\"],\n            case[\"union_lengths\"],\n            case[\"sample_A\"][\"total_mapped_fragments\"]\n        )\n\n        # Calculate metrics for Sample B\n        fpkm_B, tpm_B = calculate_metrics(\n            case[\"sample_B\"][\"gene_molecule_counts\"],\n            case[\"sample_B\"][\"isoform_proportions\"],\n            case[\"gene_isoform_lengths\"],\n            case[\"union_lengths\"],\n            case[\"sample_B\"][\"total_mapped_fragments\"]\n        )\n\n        # Calculate fold-changes\n        fc_fpkm = fpkm_B / fpkm_A\n        fc_true = case[\"sample_B\"][\"gene_molecule_counts\"] / case[\"sample_A\"][\"gene_molecule_counts\"]\n        fc_tpm = tpm_B / tpm_A\n\n        # Assemble results in the specified order\n        case_results = [\n            fc_fpkm[0], fc_fpkm[1],\n            fc_true[0], fc_true[1],\n            fc_tpm[0], fc_tpm[1]\n        ]\n        all_results.append(case_results)\n\n    # Format the final output string\n    output_str = f\"[{','.join([f'[{\",\".join(map(str, res))}]' for res in all_results])}]\"\n    print(output_str)\n\n\ndef calculate_metrics(gene_molecule_counts, isoform_proportions, isoform_lengths, union_lengths, total_mapped_fragments):\n    \"\"\"\n    Calculates FPKM and TPM values for a single sample.\n\n    Args:\n        gene_molecule_counts (np.array): Array of total molecule counts per gene (T_g).\n        isoform_proportions (np.array): 2D array of isoform proportions per gene (p_gj).\n        isoform_lengths (np.array): 2D array of isoform lengths per gene (L_gj).\n        union_lengths (np.array): Array of gene union-of-exons lengths.\n        total_mapped_fragments (float): Total number of mapped fragments in the sample (N).\n\n    Returns:\n        tuple[np.array, np.array]: A tuple containing arrays of FPKM values and TPM values.\n    \"\"\"\n    # Reshape gene_molecule_counts to allow broadcasting\n    T_g = gene_molecule_counts[:, np.newaxis]\n\n    # Calculate molecule count per isoform: A_gj = T_g * p_gj\n    isoform_molecule_counts = T_g * isoform_proportions\n    \n    # Calculate nucleotide mass per isoform: A_gj * L_gj\n    nucleotide_mass_per_isoform = isoform_molecule_counts * isoform_lengths\n    \n    # Calculate total nucleotide mass for the sample: M_total\n    M_total = np.sum(nucleotide_mass_per_isoform)\n    \n    # Calculate expected fragment counts per isoform: C_gj\n    isoform_fragment_counts = total_mapped_fragments * nucleotide_mass_per_isoform / M_total\n    \n    # Calculate expected fragment counts per gene: C_g\n    gene_fragment_counts = np.sum(isoform_fragment_counts, axis=1)\n    \n    # Calculate FPKM for each gene\n    fpkm_values = (1e9 * gene_fragment_counts) / (union_lengths * total_mapped_fragments)\n    \n    # Calculate TPM for each gene using the simplified and stable formula:\n    # TPM_g = 1e6 * (T_g / sum(T_all))\n    # This is mathematically equivalent to the definition based on fragment counts.\n    total_molecules_in_sample = np.sum(gene_molecule_counts)\n    tpm_values = 1e6 * gene_molecule_counts / total_molecules_in_sample\n    \n    return fpkm_values, tpm_values\n\nsolve()\n\n```", "id": "4393431"}, {"introduction": "In some complex loci, the information from short-read sequencing is fundamentally insufficient to distinguish between highly similar isoforms, leading to a mathematically \"unidentifiable\" system. This advanced exercise challenges you to think like an experimental designer, moving beyond pure data analysis to solve such an ambiguity. You will quantify how supplementing a short-read experiment with targeted long-read sequencing can provide the missing information needed to make the isoform abundances fully resolvable [@problem_id:4393520].", "problem": "In transcript-level quantification for precision medicine, consider a locus with alternative splicing that generates $3$ isoforms: $\\mathcal{I}_{1}$ with exon chain $E_{1}\\text{-}E_{2}\\text{-}E_{3}$, $\\mathcal{I}_{2}$ with exon chain $E_{1}\\text{-}E_{2b}\\text{-}E_{3}$, and $\\mathcal{I}_{3}$ with exon skipping $E_{1}\\text{-}E_{3}$. You are using short-read ribonucleic acid (RNA-seq) with single-end reads of length $L=75$ nucleotides and a splice-junction mapping requirement of at least $s=15$ nucleotides of anchor on each side of a junction. The exon lengths are $|E_{1}|=180$, $|E_{2}|=12$, $|E_{2b}|=13$, and $|E_{3}|=220$ nucleotides. Under these parameters, reads cannot validly span the $E_{2}\\text{-}E_{3}$ or $E_{2b}\\text{-}E_{3}$ junctions because $|E_{2}|<s$ and $|E_{2b}|<s$, but reads can validly span the exon-skipping junction $E_{1}\\text{-}E_{3}$ because $|E_{1}|\\ge s$ and $|E_{3}|\\ge s$. Let the standard linear mixture model for isoform quantification be $y=A\\theta+\\varepsilon$, where $y$ is the vector of expected feature counts, $A$ is the design matrix encoding feature compatibility for the isoforms, $\\theta$ is the vector of isoform abundances, and $\\varepsilon$ is noise. Under the current short-read design, the available features are total exon body coverage (present in all isoforms) and the exon-skipping $E_{1}\\text{-}E_{3}$ junction (unique to $\\mathcal{I}_{3}$). The corresponding design matrix is\n$$\nA_{\\text{short}}=\\begin{pmatrix}\n1 & 1 & 1\\\\\n0 & 0 & 1\n\\end{pmatrix},\n$$\nwhich has rank strictly less than $3$, so $\\theta$ is not identifiable.\n\nPropose an experimental design change that makes the augmented design matrix full column rank at this locus and justify it quantitatively. Specifically, consider augmenting the assay with targeted full-length complementary deoxyribonucleic acid (cDNA) long-read sequencing using Single Molecule Real-Time (SMRT) or Nanopore technology, which yields per-molecule isoform-resolved observations. Model these as additional rows added to $A$, each long-read contributing a one-hot row vector equal to a standard basis vector for the isoform it came from. Assume the isoform fractions at this locus in the sample are $f_{1}=0.6$, $f_{2}=0.3$, and $f_{3}=0.1$, and that $n$ full-length molecules from this locus are independently observed from this categorical distribution.\n\nCompute the smallest integer $n$ such that, with probability at least $0.95$, the augmented design matrix has full column rank, i.e., each isoform has been observed at least once among the $n$ long-reads so that the set of added one-hot rows spans all $3$ columns. Provide your final answer as a single integer. No rounding instruction is necessary beyond choosing the minimal such integer.", "solution": "The problem as stated is subjected to validation.\n\n### Step 1: Extract Givens\n- Number of isoforms: $3$; denoted $\\mathcal{I}_{1}$, $\\mathcal{I}_{2}$, $\\mathcal{I}_{3}$.\n- Isoform structures: $\\mathcal{I}_{1}$ is $E_{1}\\text{-}E_{2}\\text{-}E_{3}$, $\\mathcal{I}_{2}$ is $E_{1}\\text{-}E_{2b}\\text{-}E_{3}$, $\\mathcal{I}_{3}$ is $E_{1}\\text{-}E_{3}$.\n- Short-read length: $L=75$ nucleotides.\n- Splice-junction anchor size: $s=15$ nucleotides.\n- Exon lengths: $|E_{1}|=180$, $|E_{2}|=12$, $|E_{2b}|=13$, $|E_{3}|=220$ nucleotides.\n- Short-read design matrix: $A_{\\text{short}}=\\begin{pmatrix} 1 & 1 & 1 \\\\ 0 & 0 & 1 \\end{pmatrix}$. This matrix is stated to have rank less than $3$.\n- Proposed experimental change: Augmenting with targeted full-length cDNA long-read sequencing.\n- Modeling of long reads: Each of $n$ long-reads contributes a one-hot row vector corresponding to the observed isoform.\n- Isoform fractions: $f_{1}=0.6$, $f_{2}=0.3$, $f_{3}=0.1$.\n- Sampling model: The $n$ long-reads are independent observations from a categorical distribution with probabilities $(f_1, f_2, f_3)$.\n- Objective: Find the smallest integer $n$ such that the augmented design matrix has full column rank with a probability of at least $0.95$.\n- Condition for full column rank: Each of the three isoforms has been observed at least once among the $n$ long-reads.\n\n### Step 2: Validate Using Extracted Givens\nThe problem describes a common challenge in genomics: the non-identifiability of isoform abundances from short-read RNA-seq data due to shared exons and ambiguous reads. The parameters given (read length, exon sizes, anchor length) are realistic. The short-read design matrix correctly reflects the information available: one feature counts reads compatible with any isoform body, and another counts reads specific to the exon-skipping junction of $\\mathcal{I}_3$. The rank of $A_{\\text{short}}$ is $2$, which is less than the number of isoforms ($3$), confirming the identifiability issue.\n\nThe proposed solution, augmentation with long-read data, is a standard and powerful technique to resolve such ambiguities. The modeling of each long read as a perfect, isoform-resolved observation contributing a one-hot vector is a correct representation of its role in the linear system. The augmented matrix achieves full column rank if and only if the set of added one-hot vectors spans $\\mathbb{R}^3$. This occurs precisely when the basis vectors $e_1^T = (1, 0, 0)$, $e_2^T = (0, 1, 0)$, and $e_3^T = (0, 0, 1)$ are all present, meaning each isoform is observed at least once.\n\nThe probabilistic component of the problem is well-defined. The isoform fractions are given as probabilities for a categorical distribution, and they correctly sum to $1$ ($0.6+0.3+0.1=1.0$). The task is to find the minimum number of trials $n$ to achieve a certain success condition (observing all categories) with a given probability. This is a classic probability problem (related to the coupon collector's problem) set in a scientifically valid and well-posed context. The problem is self-contained, objective, and scientifically grounded.\n\n### Step 3: Verdict and Action\nThe problem is valid. A reasoned solution will be provided.\n\n### Solution\nThe problem is to find the smallest integer $n$ such that, with a probability of at least $0.95$, we observe at least one molecule of each of the $3$ isoforms from a sample of $n$ independently drawn molecules. The probabilities of drawing an individual molecule of isoform $\\mathcal{I}_{1}$, $\\mathcal{I}_{2}$, or $\\mathcal{I}_{3}$ are given by their fractions: $p_{1} = 0.6$, $p_{2} = 0.3$, and $p_{3} = 0.1$.\n\nLet $E$ be the event that after $n$ draws, we have observed at least one of each isoform. We are looking for the smallest integer $n$ such that $P(E) \\ge 0.95$.\n\nIt is more straightforward to calculate the probability of the complement event, $E^c$, which is the event that at least one isoform is *not* observed. The condition $P(E) \\ge 0.95$ is equivalent to $P(E^c) \\le 0.05$.\n\nLet $A_i$ be the event that isoform $\\mathcal{I}_i$ is not observed in the $n$ draws. The event $E^c$ is the union of these events: $E^c = A_1 \\cup A_2 \\cup A_3$.\n\nWe use the Principle of Inclusion-Exclusion to find the probability of this union:\n$$P(E^c) = P(A_1 \\cup A_2 \\cup A_3) = \\sum_{i=1}^3 P(A_i) - \\sum_{1 \\le i < j \\le 3} P(A_i \\cap A_j) + P(A_1 \\cap A_2 \\cap A_3)$$\n\nLet's compute each term:\nThe probability that a single draw is *not* isoform $\\mathcal{I}_i$ is $(1-p_i)$. Since the $n$ draws are independent, the probability that none of the $n$ draws are isoform $\\mathcal{I}_i$ is $P(A_i) = (1-p_i)^n$.\n- $P(A_1) = (1-p_1)^n = (1-0.6)^n = (0.4)^n$\n- $P(A_2) = (1-p_2)^n = (1-0.3)^n = (0.7)^n$\n- $P(A_3) = (1-p_3)^n = (1-0.1)^n = (0.9)^n$\n\nThe probability of the intersection, $P(A_i \\cap A_j)$, is the probability that neither isoform $\\mathcal{I}_i$ nor $\\mathcal{I}_j$ is observed. This means all $n$ draws must be of the third isoform, $\\mathcal{I}_k$ (where $k \\neq i, j$). This probability is $p_k^n = (1-p_i-p_j)^n$.\n- $P(A_1 \\cap A_2) = p_3^n = (0.1)^n$\n- $P(A_1 \\cap A_3) = p_2^n = (0.3)^n$\n- $P(A_2 \\cap A_3) = p_1^n = (0.6)^n$\n\nThe probability of the triple intersection, $P(A_1 \\cap A_2 \\cap A_3)$, is the probability that none of the three isoforms are observed. Since these are the only possibilities, this event is impossible, and its probability is $0$.\n\nSubstituting these into the inclusion-exclusion formula:\n$$P(E^c) = \\left[ (0.4)^n + (0.7)^n + (0.9)^n \\right] - \\left[ (0.1)^n + (0.3)^n + (0.6)^n \\right] + 0$$\nLet $g(n) = P(E^c) = (0.9)^n + (0.7)^n + (0.4)^n - (0.6)^n - (0.3)^n - (0.1)^n$. We need to find the smallest integer $n$ such that $g(n) \\le 0.05$.\n\nThe function $g(n)$ is a sum of exponential terms with bases less than $1$, so it is a monotonically decreasing function of $n$ for $n>0$. We can find the required $n$ by testing integer values. The dominant term for large $n$ is $(0.9)^n$. A rough estimate can be obtained by solving $(0.9)^n \\approx 0.05$, which gives $n \\approx \\frac{\\ln(0.05)}{\\ln(0.9)} \\approx \\frac{-2.9957}{-0.1054} \\approx 28.4$. This suggests the answer is likely near $n=28$ or $n=29$.\n\nLet's test $n=28$:\n$g(28) = (0.9)^{28} + (0.7)^{28} + (0.4)^{28} - (0.6)^{28} - (0.3)^{28} - (0.1)^{28}$\n$g(28) \\approx 0.0523356 + 0.0000401 + (7.2 \\times 10^{-12}) - 0.00000022 - (2.3 \\times 10^{-14}) - (1 \\times 10^{-28})$\n$g(28) \\approx 0.0523755 - 0.00000022 \\approx 0.052375$\nSince $g(28) > 0.05$, $n=28$ is not sufficient.\n\nNow let's test $n=29$:\n$g(29) = (0.9)^{29} + (0.7)^{29} + (0.4)^{29} - (0.6)^{29} - (0.3)^{29} - (0.1)^{29}$\n$g(29) \\approx 0.0471020 + 0.0000281 + (2.9 \\times 10^{-12}) - 0.00000013 - (6.9 \\times 10^{-15}) - (1 \\times 10^{-29})$\n$g(29) \\approx 0.0471301 - 0.00000013 \\approx 0.047130$\nSince $g(29) \\approx 0.04713 \\le 0.05$, the condition is satisfied for $n=29$.\n\nAs $g(n)$ is a decreasing function, $n=29$ is the smallest integer for which the probability of observing all three isoforms is at least $0.95$.", "answer": "$$\\boxed{29}$$", "id": "4393520"}]}