{"hands_on_practices": [{"introduction": "This first practice focuses on the cornerstone of population genetics: estimating allele frequencies from observed genotype data. Before we can test for Hardy-Weinberg Equilibrium or assess disease risk, we need a robust method to calculate the frequency of alleles in a population. This exercise guides you through deriving the maximum likelihood estimator (MLE) for an allele frequency, a fundamental technique in statistical genetics, and asks you to evaluate its performance by calculating its bias [@problem_id:4370662].", "problem": "A clinical genomics laboratory is estimating the allele frequency of a biallelic single-nucleotide variant to inform evidence thresholds for pathogenicity classification in precision medicine. At a single autosomal locus with alleles $A$ and $a$, the laboratory observes genotype counts $(n_{AA}, n_{Aa}, n_{aa})$ from $n$ unrelated individuals who were typed with high-confidence assays. Assume the population is large, individuals are drawn at random, and the locus follows the Hardy–Weinberg equilibrium (HWE) model under random mating, so that the genotype probabilities are $p^{2}$, $2p(1-p)$, and $(1-p)^{2}$ for $AA$, $Aa$, and $aa$, respectively, where $p$ is the frequency of allele $A$ and $q=1-p$ is the frequency of allele $a$. Treat the observed counts as one realization from a multinomial sampling model with $n$ trials and the above genotype probabilities.\n\nStarting from the fundamental definition of the multinomial likelihood and without assuming any particular estimator, derive the maximum likelihood estimator (MLE) $\\hat{p}$ for the allele frequency $p$ in terms of $(n_{AA}, n_{Aa}, n_{aa}, n)$. Then, using the well-known properties of expectations under the multinomial model, compute the expected value $\\mathbb{E}[\\hat{p}]$ and the bias $\\operatorname{Bias}(\\hat{p})=\\mathbb{E}[\\hat{p}]-p$ under finite sample size $n$.\n\nReport the bias as a single real number. If your result is exact, do not round. No physical units are required.", "solution": "The laboratory is observing genotype counts at a biallelic locus, and the Hardy–Weinberg equilibrium (HWE) model specifies the genotype probabilities in terms of the allele frequency $p$ as $p^{2}$ for $AA$, $2p(1-p)$ for $Aa$, and $(1-p)^{2}$ for $aa$. Let the observed counts be $(n_{AA}, n_{Aa}, n_{aa})$ with total $n=n_{AA}+n_{Aa}+n_{aa}$. Under the multinomial sampling framework, the likelihood function for $p$ is\n$$\nL(p \\mid n_{AA}, n_{Aa}, n_{aa}) \\propto \\left(p^{2}\\right)^{n_{AA}} \\left(2p(1-p)\\right)^{n_{Aa}} \\left((1-p)^{2}\\right)^{n_{aa}},\n$$\nwhere the multinomial coefficient is a constant with respect to $p$ and can be dropped for maximization. The log-likelihood is\n$$\n\\ell(p) = n_{AA} \\ln\\left(p^{2}\\right) + n_{Aa} \\ln\\left(2p(1-p)\\right) + n_{aa} \\ln\\left((1-p)^{2}\\right).\n$$\nUsing logarithm properties, this simplifies to\n$$\n\\ell(p) = 2 n_{AA} \\ln p + n_{Aa} \\left(\\ln 2 + \\ln p + \\ln(1-p)\\right) + 2 n_{aa} \\ln(1-p).\n$$\nThe term $n_{Aa} \\ln 2$ is constant with respect to $p$ and does not affect the maximization. Differentiate $\\ell(p)$ with respect to $p$:\n$$\n\\frac{d\\ell}{dp} = \\frac{2 n_{AA}}{p} + \\frac{n_{Aa}}{p} - \\frac{n_{Aa}}{1-p} - \\frac{2 n_{aa}}{1-p} = \\frac{2 n_{AA} + n_{Aa}}{p} - \\frac{n_{Aa} + 2 n_{aa}}{1-p}.\n$$\nSet the derivative equal to zero to find the critical point:\n$$\n\\frac{2 n_{AA} + n_{Aa}}{p} = \\frac{n_{Aa} + 2 n_{aa}}{1-p}.\n$$\nCross-multiply to solve for $p$:\n$$\n(2 n_{AA} + n_{Aa})(1-p) = (n_{Aa} + 2 n_{aa}) p,\n$$\n$$\n(2 n_{AA} + n_{Aa}) - (2 n_{AA} + n_{Aa}) p = p n_{Aa} + 2 p n_{aa},\n$$\n$$\n(2 n_{AA} + n_{Aa}) = p \\left[(2 n_{AA} + n_{Aa}) + n_{Aa} + 2 n_{aa}\\right] = p \\left[2 n_{AA} + 2 n_{Aa} + 2 n_{aa}\\right] = 2 n p.\n$$\nTherefore, the maximum likelihood estimator is\n$$\n\\hat{p} = \\frac{2 n_{AA} + n_{Aa}}{2 n}.\n$$\n\nWe now evaluate the expectation $\\mathbb{E}[\\hat{p}]$ under the multinomial model with parameters $(p^{2}, 2p(1-p), (1-p)^{2})$. The expectations of the counts are\n$$\n\\mathbb{E}[n_{AA}] = n p^{2}, \\quad \\mathbb{E}[n_{Aa}] = n \\cdot 2p(1-p), \\quad \\mathbb{E}[n_{aa}] = n (1-p)^{2}.\n$$\nBy linearity of expectation,\n$$\n\\mathbb{E}[\\hat{p}] = \\mathbb{E}\\left[\\frac{2 n_{AA} + n_{Aa}}{2 n}\\right] = \\frac{2 \\mathbb{E}[n_{AA}] + \\mathbb{E}[n_{Aa}]}{2 n} = \\frac{2 n p^{2} + n \\cdot 2p(1-p)}{2 n}.\n$$\nSimplify the numerator:\n$$\n2 n p^{2} + 2 n p(1-p) = 2 n \\left(p^{2} + p - p^{2}\\right) = 2 n p.\n$$\nHence,\n$$\n\\mathbb{E}[\\hat{p}] = \\frac{2 n p}{2 n} = p.\n$$\nThe bias is defined as\n$$\n\\operatorname{Bias}(\\hat{p}) = \\mathbb{E}[\\hat{p}] - p = p - p = 0.\n$$\nThus, under finite sample size $n$ with multinomial sampling from a population characterized by allele frequency $p$ and Hardy–Weinberg genotype probabilities, the estimator $\\hat{p} = (2 n_{AA} + n_{Aa})/(2 n)$ is unbiased, and its bias is exactly zero.", "answer": "$$\\boxed{0}$$", "id": "4370662"}, {"introduction": "With a reliable estimate of allele frequencies in hand, we can now test whether a population's genotype frequencies conform to the Hardy-Weinberg Equilibrium (HWE) model. This is not just a theoretical check; testing for HWE is a critical quality control step in genomic studies to detect issues like genotyping error or population stratification. This practice will have you apply the widely used chi-square ($ \\chi^2 $) goodness-of-fit test to assess the deviation of observed genotype counts from HWE expectations [@problem_id:4370688].", "problem": "A clinical pharmacogenomics laboratory aims to validate the genotype quality for a biallelic single-nucleotide variant in a gene implicated in adverse drug reactions before using the data for precision dosing. The cohort consists of $N$ unrelated individuals of homogeneous continental ancestry who were genotyped using a Clinical Laboratory Improvement Amendments (CLIA)-validated pipeline with orthogonal confirmation for discordant calls. Let the two alleles at the locus be denoted $A$ and $a$, and suppose the observed genotype counts are $n_{AA} = 290$, $n_{Aa} = 190$, and $n_{aa} = 20$, with $N = n_{AA} + n_{Aa} + n_{aa} = 500$.\n\nUsing only core definitions and first principles from population genetics, proceed as follows:\n- Define allele frequencies $p$ for allele $A$ and $q$ for allele $a$ in terms of the observed genotype counts and $N$, and explain the relationship between $p$ and $q$ under random union of gametes.\n- From the random union of gametes model and the assumptions underlying Hardy-Weinberg Equilibrium (HWE), derive the expected genotype frequencies in terms of $p$ and $q$ without invoking any pre-memorized formulas.\n- Compute the expected genotype counts under HWE for the given sample using your derived expressions.\n- Treat this as a goodness-of-fit problem where the allele frequency parameters are estimated from the sample, and compute the chi-square test statistic for deviation from HWE using one degree of freedom.\n\nIn your reasoning, clearly articulate the conditions under which the chi-square approximation is valid for this test in a clinical genomics context (e.g., independence, ancestry homogeneity, and minimum expected cell counts), and briefly justify the degrees of freedom used.\n\nRound your final chi-square test statistic to four significant figures. Express the final answer as a unitless real number.", "solution": "The first step is to define the allele frequencies from the observed genotype counts. The total number of individuals in the sample is $N = n_{AA} + n_{Aa} + n_{aa} = 290 + 190 + 20 = 500$. Since each diploid individual carries two alleles at this locus, the total number of alleles in the sample is $2N = 1000$.\n\nThe frequency of allele $A$, denoted by $p$, is the total number of $A$ alleles divided by the total number of alleles in the sample. Individuals with genotype $AA$ carry two $A$ alleles, and individuals with genotype $Aa$ carry one $A$ allele.\nThe total count of allele $A$ is $2 \\times n_{AA} + 1 \\times n_{Aa}$.\nTherefore, the frequency $p$ is:\n$$p = \\frac{2n_{AA} + n_{Aa}}{2N}$$\nSubstituting the given values:\n$$p = \\frac{2(290) + 190}{2(500)} = \\frac{580 + 190}{1000} = \\frac{770}{1000} = 0.77$$\n\nSimilarly, the frequency of allele $a$, denoted by $q$, is the total number of $a$ alleles divided by the total number of alleles. Individuals with genotype $aa$ carry two $a$ alleles, and individuals with genotype $Aa$ carry one $a$ allele.\nThe total count of allele $a$ is $1 \\times n_{Aa} + 2 \\times n_{aa}$.\nTherefore, the frequency $q$ is:\n$$q = \\frac{n_{Aa} + 2n_{aa}}{2N}$$\nSubstituting the given values:\n$$q = \\frac{190 + 2(20)}{2(500)} = \\frac{190 + 40}{1000} = \\frac{230}{1000} = 0.23$$\n\nFor a biallelic locus, there are only two possible alleles, $A$ and $a$. Thus, their frequencies must sum to $1$. This can be shown from the definitions:\n$$p + q = \\frac{2n_{AA} + n_{Aa}}{2N} + \\frac{n_{Aa} + 2n_{aa}}{2N} = \\frac{2n_{AA} + 2n_{Aa} + 2n_{aa}}{2N} = \\frac{2(n_{AA} + n_{Aa} + n_{aa})}{2N} = \\frac{2N}{2N} = 1$$\nOur calculated values are consistent with this relationship: $0.77 + 0.23 = 1.00$.\n\nNext, we derive the expected genotype frequencies under the assumptions of Hardy-Weinberg Equilibrium (HWE). HWE describes a state of genetic stability in a population under specific idealized conditions, including random mating (panmixia), a large population size, and the absence of evolutionary influences such as mutation, gene flow, and natural selection. Under random mating, which is equivalent to the random union of gametes, we can model the formation of genotypes as independent probabilistic events.\nConsider a conceptual gene pool where the gametes carrying allele $A$ are present with frequency $p$ and gametes carrying allele $a$ are present with frequency $q$. The formation of a diploid genotype is equivalent to drawing two gametes independently from this pool.\nThe probability of forming a homozygous $AA$ genotype is the probability of drawing an $A$ gamete followed by another $A$ gamete. Since these are independent events, this probability is $p \\times p = p^2$.\n$$f(AA) = p^2$$\nThe probability of forming a homozygous $aa$ genotype is the probability of drawing an $a$ gamete followed by another $a$ gamete. This probability is $q \\times q = q^2$.\n$$f(aa) = q^2$$\nA heterozygous $Aa$ genotype can be formed in two mutually exclusive ways:\n1. Drawing an $A$ gamete first, then an $a$ gamete. The probability is $p \\times q$.\n2. Drawing an $a$ gamete first, then an $A$ gamete. The probability is $q \\times p$.\nThe total probability of forming a heterozygote is the sum of these probabilities: $pq + qp = 2pq$.\n$$f(Aa) = 2pq$$\nThese are the expected genotype frequencies under HWE. The sum of these frequencies is $p^2 + 2pq + q^2 = (p+q)^2 = 1^2 = 1$, as expected.\n\nNow, we compute the expected genotype counts for the given sample of size $N=500$. The expected count for each genotype is its expected frequency multiplied by the total sample size $N$. We use the allele frequencies $p=0.77$ and $q=0.23$ estimated from the sample data.\n\nExpected count of $AA$:\n$$E_{AA} = N \\times p^2 = 500 \\times (0.77)^2 = 500 \\times 0.5929 = 296.45$$\nExpected count of $Aa$:\n$$E_{Aa} = N \\times 2pq = 500 \\times 2 \\times 0.77 \\times 0.23 = 500 \\times 0.3542 = 177.10$$\nExpected count of $aa$:\n$$E_{aa} = N \\times q^2 = 500 \\times (0.23)^2 = 500 \\times 0.0529 = 26.45$$\nThe sum of expected counts is $296.45 + 177.10 + 26.45 = 500$, which matches the sample size $N$.\n\nFinally, we compute the chi-square ($\\chi^2$) test statistic to assess the goodness-of-fit between the observed and expected counts. The formula is:\n$$\\chi^2 = \\sum_{\\text{genotypes}} \\frac{(\\text{Observed} - \\text{Expected})^2}{\\text{Expected}}$$\nThe observed counts are $O_{AA} = 290$, $O_{Aa} = 190$, and $O_{aa} = 20$.\n$$\\chi^2 = \\frac{(O_{AA} - E_{AA})^2}{E_{AA}} + \\frac{(O_{Aa} - E_{Aa})^2}{E_{Aa}} + \\frac{(O_{aa} - E_{aa})^2}{E_{aa}}$$\n$$\\chi^2 = \\frac{(290 - 296.45)^2}{296.45} + \\frac{(190 - 177.10)^2}{177.10} + \\frac{(20 - 26.45)^2}{26.45}$$\n$$\\chi^2 = \\frac{(-6.45)^2}{296.45} + \\frac{(12.9)^2}{177.10} + \\frac{(-6.45)^2}{26.45}$$\n$$\\chi^2 = \\frac{41.6025}{296.45} + \\frac{166.41}{177.10} + \\frac{41.6025}{26.45}$$\n$$\\chi^2 \\approx 0.1403359 + 0.9396386 + 1.5728733$$\n$$\\chi^2 \\approx 2.6528478$$\nRounding the result to four significant figures gives $2.653$.\n\nThe degrees of freedom for this test are justified as follows. The general formula for degrees of freedom ($df$) in a goodness-of-fit test is $df = (\\text{number of categories}) - 1 - (\\text{number of parameters estimated from the data})$. We have $3$ genotype categories ($AA$, $Aa$, $aa$). We estimated one independent parameter, the allele frequency $p$, from the data (since $q$ is determined by $p$ via $q=1-p$). Therefore, the degrees of freedom are $df = 3 - 1 - 1 = 1$.\n\nThe validity of this chi-square test in a clinical genomics context depends on several conditions being met:\n1.  **Independence of Observations**: The problem states the cohort consists of $N$ **unrelated** individuals. This is a crucial assumption for the chi-square test. Cryptic relatedness, if not accounted for, would violate this.\n2.  **Ancestry Homogeneity**: The problem specifies a cohort of **homogeneous continental ancestry**. This is critical because population admixture (stratification) is a well-known cause for significant deviations from HWE, even with perfect genotyping. Testing for HWE is a standard quality control measure to detect such issues.\n3.  **Minimum Expected Cell Counts**: The chi-square distribution is a continuous approximation to the discrete multinomial distribution of the test statistic. This approximation is valid when the expected counts are sufficiently large. A common rule of thumb is that all expected counts should be at least $5$. Here, our expected counts are $E_{AA} = 296.45$, $E_{Aa} = 177.10$, and $E_{aa} = 26.45$, all of which are well above the threshold of $5$. Therefore, the use of the chi-square approximation is justified.\n4.  **Large Sample Size**: The total sample size $N=500$ is large enough to provide a stable estimate of allele frequencies and to satisfy the assumptions underlying the chi-square test's distributional properties.\nThe context of a CLIA-validated pipeline implies high-quality genotyping, which minimizes the chance of technical artifacts (e.g., differential allelic amplification, incorrect genotype calling) being the source of deviation from HWE. Thus, a significant deviation would more likely point to a violation of population genetic assumptions, like stratification, which this test is designed to detect.", "answer": "$$\n\\boxed{2.653}\n$$", "id": "4370688"}, {"introduction": "While the chi-square test is a powerful tool, its underlying statistical assumptions can be violated in samples with rare variants, a common scenario in precision medicine. To address this, we turn to exact tests, which provide accurate results regardless of sample size or allele frequency. This advanced practice challenges you to derive the exact conditional probability distribution used for HWE testing and then implement it computationally to calculate a mid-$p$ value, a sophisticated and practical skill in modern genomic diagnostics [@problem_id:4370711].", "problem": "A diploid, bi-allelic locus is genotyped in a cohort used for quality control in precision medicine and genomic diagnostics. Let there be a sample of $n$ unrelated individuals from a panmictic population with no inbreeding, no genotyping error, and no selection at the locus. Under Hardy-Weinberg Equilibrium (HWE), the genotype counts follow Hardy-Weinberg proportions induced by random union of gametes. Consider the conditional exact test for HWE that fixes the observed allele counts and enumerates all possible genotype count configurations consistent with these fixed allele counts and the fixed sample size.\n\nFundamental base:\n- Random union of gametes implies that, conditional on the total count of a particular allele among the $2n$ sampled chromosomes, all pairings of the $2n$ alleles into $n$ unordered diploid genotypes are equally likely.\n- The genotype configuration is determined by the number of heterozygotes. Given a fixed count of the allele $A$, denoted $m$, and the number of heterozygotes $h$, the remaining counts of homozygotes are fully determined by conservation of alleles and individuals.\n\nDefinitions:\n- Let the observed genotype counts be $(n_{AA}, n_{Aa}, n_{aa})$ for genotypes $AA$, $Aa$, and $aa$, respectively.\n- Let $n = n_{AA} + n_{Aa} + n_{aa}$ be the sample size.\n- Let $m = 2 n_{AA} + n_{Aa}$ be the total count of allele $A$ among the $2n$ sampled chromosomes.\n- Feasible genotype configurations at fixed $(n, m)$ correspond to all integers $h$ (the number of heterozygotes) such that $h$ has the same parity as $m$ and $0 \\le h \\le \\min(m, 2n - m)$; for each feasible $h$, the implied homozygote counts are $n_{AA} = (m - h)/2$ and $n_{aa} = (2n - m - h)/2$.\n\nTask:\n- Derive from first principles the conditional probability mass function for the number of heterozygotes $h$ under Hardy-Weinberg Equilibrium (HWE), using the random union of gametes model and combinatorial counting arguments. This derivation must start from the assumption that, conditional on $m$, each pairing of the $2n$ alleles into $n$ unordered diploid genotypes is equally likely.\n- Implement a program that:\n  1. Computes $n$ and $m$ from $(n_{AA}, n_{Aa}, n_{aa})$.\n  2. Enumerates all feasible $h$ values consistent with $(n, m)$.\n  3. Computes the conditional probability $P(h \\mid n, m)$ for each feasible $h$.\n  4. Computes the mid-$p$ value for the observed configuration, defined as the sum of probabilities strictly less than the observed configuration’s probability plus one half of the observed configuration’s probability. Formally, let $p_{\\text{obs}} = P(h_{\\text{obs}} \\mid n, m)$, then the mid-$p$ value is\n     $$p_{\\text{mid}} = \\sum_{h : P(h \\mid n, m) < p_{\\text{obs}}} P(h \\mid n, m) + \\frac{1}{2} p_{\\text{obs}}.$$\n  5. Handles boundary cases robustly, including situations with a single feasible configuration (such as $m = 0$, $m = 2n$, or $n = 1$ and $m = 1$), where $p_{\\text{mid}}$ must equal $0.5$.\n\nNumerical requirements:\n- All outputs must be expressed as decimals.\n- Round each reported mid-$p$ value to exactly $12$ decimal places.\n\nTest suite:\n- Use the following test cases, given as $(n_{AA}, n_{Aa}, n_{aa})$:\n  1. $(36, 48, 16)$ with $n = 100$ and $m = 120$.\n  2. $(0, 50, 0)$ with $n = 50$ and $m = 50$.\n  3. $(30, 0, 0)$ with $n = 30$ and $m = 60$.\n  4. $(12, 1, 12)$ with $n = 25$ and $m = 25$.\n  5. $(20, 18, 2)$ with $n = 40$ and $m = 58$.\n  6. $(0, 1, 0)$ with $n = 1$ and $m = 1$.\n\nFinal output format:\n- Your program should produce a single line of output containing the mid-$p$ values for the six test cases as a comma-separated list enclosed in square brackets, with each value rounded to $12$ decimal places (e.g., $[0.123456789012,0.500000000000,0.000000000001]$). No other text should be printed.", "solution": "The objective is to derive the conditional probability mass function (PMF) for the number of heterozygotes, $h$, under Hardy-Weinberg Equilibrium (HWE), and then to implement an algorithm to compute the mid-$p$ value for an observed genotype configuration.\n\n### Derivation of the PMF $P(h \\mid n, m)$\n\nThe derivation proceeds from the first principles of population genetics and statistical inference as specified in the problem statement. We consider a random sample of $n$ diploid individuals from a large, randomly mating (panmictic) population. Let the two alleles at the locus be $A$ and $a$, with population frequencies $p$ and $q=1-p$, respectively.\n\n1.  **Unconditional Probability of Genotype Counts**: Under HWE, the genotypes $AA$, $Aa$, and $aa$ occur with probabilities $p^2$, $2pq$, and $q^2$. For a random sample of $n$ individuals, the counts of these genotypes $(n_{AA}, n_{Aa}, n_{aa})$ follow a multinomial distribution. Let $h = n_{Aa}$ be the number of heterozygotes. The probability of observing a specific set of genotype counts is:\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n!}{n_{AA}! h! n_{aa}!} (p^2)^{n_{AA}} (2pq)^{h} (q^2)^{n_{aa}} $$\n    This can be rearranged by grouping terms with $p$ and $q$:\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^{2n_{AA}+h} q^{h+2n_{aa}} $$\n\n2.  **Allele Counts**: The total count of allele $A$ in the sample is $m = 2n_{AA} + h$, and the total count of allele $a$ is $2n-m = h + 2n_{aa}$. Substituting these into the expression gives:\n    $$ P(n_{AA}, h, n_{aa}) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^m q^{2n-m} $$\n    This is the joint probability of the genotype counts and the allele counts (since the genotype counts determine the allele counts).\n\n3.  **Conditional Distribution**: The exact test for HWE conditions on the observed allele counts $(m, 2n-m)$, thereby eliminating the unknown allele frequency $p$ as a nuisance parameter. To find the conditional probability $P(n_{AA}, h, n_{aa} \\mid n, m)$, we must divide the joint probability by the marginal probability of observing $m$ copies of allele $A$ in a sample of $2n$ alleles. This marginal probability follows a binomial distribution, as each of the $2n$ alleles in the sample can be thought of as an independent draw from the population's gene pool:\n    $$ P(m \\mid n) = \\binom{2n}{m} p^m q^{2n-m} = \\frac{(2n)!}{m!(2n-m)!} p^m q^{2n-m} $$\n\n4.  **Final PMF**: The conditional probability is the ratio $P(n_{AA}, h, n_{aa}) / P(m \\mid n)$:\n    $$ P(h \\mid n, m) = \\frac{\\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} p^m q^{2n-m}}{\\frac{(2n)!}{m!(2n-m)!} p^m q^{2n-m}} $$\n    The terms involving $p$ and $q$ cancel, yielding a distribution that depends only on the counts $n, m,$ and $h$:\n    $$ P(h \\mid n, m) = \\frac{n! \\, 2^h}{n_{AA}! h! n_{aa}!} \\frac{m!(2n-m)!}{(2n)!} $$\n    Given $n$ and $m$, the homozygote counts are functions of $h$: $n_{AA} = (m-h)/2$ and $n_{aa} = (2n-m-h)/2$. Substituting these gives the final PMF for $h$:\n    $$ P(h \\mid n, m) = \\frac{n! \\, m! \\, (2n-m)! \\, 2^h}{(2n)! \\, h! \\, ((m-h)/2)! \\, ((2n-m-h)/2)!} $$\n    This distribution is defined for all feasible integer values of $h$, which are those having the same parity as $m$ and satisfying $0 \\le h \\le \\min(m, 2n-m)$. This formula is the desired result derived from first principles. It corresponds to a specific case of the multivariate hypergeometric distribution and formalizes the combinatorial argument of counting the number of ways to pair $m$ 'A' alleles and $2n-m$ 'a' alleles into $n$ genotypes.\n\n### Algorithm for Mid-$p$ Value Computation\n\nThe program implements the following steps for each test case $(n_{AA,obs}, n_{Aa,obs}, n_{aa,obs})$:\n\n1.  **Initialization**: Compute the sample size $n = n_{AA,obs} + n_{Aa,obs} + n_{aa,obs}$ and the allele count $m = 2n_{AA,obs} + n_{Aa,obs}$. The observed number of heterozygotes is $h_{obs} = n_{Aa,obs}$.\n\n2.  **Enumeration of Feasible Configurations**: Generate all possible integer values for the number of heterozygotes, $h$, consistent with the fixed $n$ and $m$. These values must have the same parity as $m$ and lie in the range $[0, \\min(m, 2n-m)]$. The step size for enumeration is $2$, starting from $m \\pmod 2$.\n\n3.  **Probability Calculation**: For each feasible $h$, calculate the conditional probability $P(h \\mid n, m)$ using the derived PMF. To handle the large numbers involved in factorials, computations are performed in log-space using the `gammaln` function from the `scipy.special` library, where $\\log(k!) = \\text{gammaln}(k+1)$. The log-probability is:\n    $$ \\log P(h) = \\log(n!) + \\log(m!) + \\log((2n-m)!) - \\log((2n)!) + h\\log(2) - \\log(h!) - \\log(n_{AA}!) - \\log(n_{aa}!) $$\n    The probabilities are then recovered by exponentiation. To maintain numerical precision, the log-probabilities are shifted by their maximum value before exponentiation, and the resulting probabilities are normalized to sum to $1$.\n\n4.  **Mid-$p$ Value Calculation**: The problem defines the mid-$p$ value as $p_{\\text{mid}} = \\sum_{h : P(h) < p_{\\text{obs}}} P(h) + \\frac{1}{2} p_{\\text{obs}}$, where $p_{obs} = P(h_{obs} \\mid n, m)$. This formula is unambiguous if no other configuration has a probability equal to $p_{obs}$. For a robust implementation that correctly handles potential ties in probability (where multiple distinct $h$ values yield the same probability $p_{obs}$), the standard statistical definition is adopted. This involves summing all probabilities strictly less than $p_{obs}$, and adding one-half of the total probability mass at $p_{obs}$:\n    $$ p_{\\text{mid}} = \\left( \\sum_{h : P(h) < p_{\\text{obs}}} P(h) \\right) + \\frac{1}{2} \\left( \\sum_{h : P(h) = p_{\\text{obs}}} P(h) \\right) $$\n    This ensures the p-value is well-defined and behaves correctly under all conditions, including the boundary cases stipulated in the problem (e.g., $m=0$, $m=2n$), where only one configuration is possible and the mid-$p$ value correctly resolves to $0.5$.\n\n5.  **Output Formatting**: The final computed mid-$p$ value for each test case is rounded and formatted to exactly $12$ decimal places. The results are collected and printed in the specified list format.", "answer": "```python\nimport numpy as np\nfrom scipy.special import gammaln\n\ndef calculate_mid_p(n_AA_obs, n_Aa_obs, n_aa_obs):\n    \"\"\"\n    Computes the mid-p value for the Hardy-Weinberg Equilibrium exact test.\n    \"\"\"\n    n = n_AA_obs + n_Aa_obs + n_aa_obs\n    if n == 0:\n        return 0.5  # A reasonable default for an empty sample\n\n    m = 2 * n_AA_obs + n_Aa_obs\n    h_obs = n_Aa_obs\n\n    # Enumerate all feasible heterozygote counts (h)\n    h_min = m % 2\n    h_max = min(m, 2 * n - m)\n    feasible_h = list(range(h_min, h_max + 1, 2))\n\n    # If there is only one possible configuration, the mid-p-value is 0.5\n    if len(feasible_h) = 1:\n        return 0.5\n\n    # Compute log-probabilities for each feasible h to avoid numerical overflow/underflow\n    log_probs = {}\n    \n    # Constant part of the log-probability formula: log( n! m! (2n-m)! / (2n)! )\n    log_constant = (gammaln(n + 1) + gammaln(m + 1) + \n                    gammaln(2 * n - m + 1) - gammaln(2 * n + 1))\n    \n    for h in feasible_h:\n        # Implied homozygote counts\n        n_AA = (m - h) // 2\n        n_aa = (2 * n - m - h) // 2\n        \n        # Variable part of the log-probability: log( 2^h / (h! n_AA! n_aa!) )\n        log_variable_part = h * np.log(2) - (gammaln(h + 1) + \n                                             gammaln(n_AA + 1) + \n                                             gammaln(n_aa + 1))\n        \n        log_probs[h] = log_constant + log_variable_part\n\n    # Normalize probabilities to ensure numerical stability\n    # 1. Shift by max log probability to prevent underflow when exponentiating\n    max_log_prob = max(log_probs.values())\n    probs = {h: np.exp(lp - max_log_prob) for h, lp in log_probs.items()}\n    \n    # 2. Normalize so that total probability is 1.0\n    sum_of_probs = sum(probs.values())\n    probs = {h: p / sum_of_probs for h, p in probs.items()}\n    \n    # Calculate the mid-p value\n    if h_obs not in probs:\n      # This should not happen for valid inputs derived from the same sample.\n      # If h_obs is not feasible, it's an impossible observation.\n      # This case is not specified by the problem, but we return a default.\n      return 1.0\n\n    p_obs = probs[h_obs]\n    \n    sum_less = 0.0\n    sum_equal = 0.0\n    \n    # Use a small tolerance for floating-point comparisons\n    tolerance = 1e-15 \n    \n    for p in probs.values():\n        if p  p_obs - tolerance:\n            sum_less += p\n        elif abs(p - p_obs)  tolerance:\n            sum_equal += p\n            \n    # The mid-p value is the sum of probabilities of less likely configurations\n    # plus half the probability of equally likely configurations.\n    p_mid = sum_less + 0.5 * sum_equal\n    \n    return p_mid\n\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and produce the final output.\n    \"\"\"\n    # Test cases given as (n_AA, n_Aa, n_aa)\n    test_cases = [\n        (36, 48, 16),\n        (0, 50, 0),\n        (30, 0, 0),\n        (12, 1, 12),\n        (20, 18, 2),\n        (0, 1, 0),\n    ]\n\n    results = []\n    for case in test_cases:\n        n_AA, n_Aa, n_aa = case\n        mid_p_value = calculate_mid_p(n_AA, n_Aa, n_aa)\n        results.append(mid_p_value)\n\n    # Format results to 12 decimal places and print in the required format\n    formatted_results = [f\"{r:.12f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n\n```", "id": "4370711"}]}