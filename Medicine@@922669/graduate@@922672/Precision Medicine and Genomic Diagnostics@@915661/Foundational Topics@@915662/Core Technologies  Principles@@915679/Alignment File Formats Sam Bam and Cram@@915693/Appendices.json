{"hands_on_practices": [{"introduction": "The core of any alignment file is its ability to precisely describe where a read maps to the reference genome. This is accomplished through the interplay of the `POS` field and the CIGAR string. This exercise provides foundational practice in decoding these fields to determine the exact genomic interval covered by an aligned read, a critical skill for tasks like coverage calculation and structural variant analysis. [@problem_id:4314820]", "problem": "In a clinical whole-genome sequencing pipeline for precision oncology, read alignments are stored in Sequence Alignment/Map (SAM), Binary Alignment/Map (BAM), and Compressed Reference-oriented Alignment Map (CRAM) files, all of which encode the alignment of each read to the reference using a positional coordinate and a CIGAR (Concise Idiosyncratic Gapped Alignment Report) string. By specification, the SAM/BAM/CRAM coordinate system is $1$-based and inclusive, and the CIGAR string is composed of operation-length pairs where operations denote how the read aligns to the reference. The fundamental operations and whether they consume reference coordinates are well-defined: $M$, $D$, $N$, $=$, and $X$ consume reference positions; $I$, $S$, $H$, and $P$ do not consume reference positions. Soft clipping ($S$) denotes segments present in the read that are not aligned to the reference but are retained in the record; matches or mismatches ($M$) denote positions that are aligned to the reference and consume both query and reference lengths. Consider an alignment record from a CRAM file that, after conversion to SAM representation, has $POS=100$ and the CIGAR string `8S92M`. Using only the above foundational definitions, determine the exact closed reference interval covered by the aligned bases of this read and the number of soft-clipped bases. Express your final answer as a row matrix containing, in order, the left interval endpoint, the right interval endpoint, and the soft-clipped count. No rounding is required and no units are to be used.", "solution": "The user wants me to solve the following problem:\nIn a clinical whole-genome sequencing pipeline for precision oncology, read alignments are stored in Sequence Alignment/Map (SAM), Binary Alignment/Map (BAM), and Compressed Reference-oriented Alignment Map (CRAM) files, all of which encode the alignment of each read to the reference using a positional coordinate and a CIGAR (Concise Idiosyncratic Gapped Alignment Report) string. By specification, the SAM/BAM/CRAM coordinate system is $1$-based and inclusive, and the CIGAR string is composed of operation-length pairs where operations denote how the read aligns to the reference. The fundamental operations and whether they consume reference coordinates are well-defined: $M$, $D$, $N$, $=$, and $X$ consume reference positions; $I$, $S$, $H$, and $P$ do not consume reference positions. Soft clipping ($S$) denotes segments present in the read that are not aligned to the reference but are retained in the record; matches or mismatches ($M$) denote positions that are aligned to the reference and consume both query and reference lengths. Consider an alignment record from a CRAM file that, after conversion to SAM representation, has $POS=100$ and the CIGAR string `8S92M`. Using only the above foundational definitions, determine the exact closed reference interval covered by the aligned bases of this read and the number of soft-clipped bases. Express your final answer as a row matrix containing, in order, the left interval endpoint, the right interval endpoint, and the soft-clipped count. No rounding is required and no units are to be used.\n\n**Problem Validation**\n\n**Step 1: Extract Givens**\n- The coordinate system is $1$-based and inclusive.\n- `POS` (left-most mapping position of the first CIGAR-defined base that consumes reference) is $100$.\n- The CIGAR string is `8S92M`.\n- CIGAR operations that consume reference positions: $M$, $D$, $N$, $=$, $X$.\n- CIGAR operations that do not consume reference positions: $I$, $S$, $H$, $P$.\n- The task is to find the closed reference interval $[start, end]$ covered by the aligned bases and the count of soft-clipped bases.\n\n**Step 2: Validate Using Extracted Givens**\nThe problem is scientifically grounded in the established SAM/BAM/CRAM specification, which is a standard in bioinformatics. The terms are well-defined, and the provided data ($POS=100$, CIGAR=`8S92M`) are sufficient and consistent for calculating a unique, meaningful solution. The problem is well-posed, objective, and does not violate any scientific principles or contain logical flaws.\n\n**Step 3: Verdict and Action**\nThe problem is valid. The solution process will proceed.\n\n**Solution Derivation**\n\nThe problem requires the determination of two quantities from a given Sequence Alignment/Map (SAM) record: the reference genomic interval covered by the aligned portion of the read, and the count of soft-clipped bases.\n\n1.  **Number of Soft-Clipped Bases:**\n    The CIGAR string is given as `8S92M`. The CIGAR string is a sequence of length-operation pairs. The operation $S$ denotes 'soft clipping', which indicates bases present in the sequencing read but not aligned to the reference genome. The first part of the CIGAR string is `8S`, which explicitly states that there are $8$ soft-clipped bases at the beginning of the read. The second part, `92M`, does not involve soft clipping. Therefore, the total number of soft-clipped bases for this alignment record is $8$.\n\n2.  **Reference Genomic Interval:**\n    The reference interval is defined by the portion of the read that is aligned to the reference genome. This interval is determined by the `POS` field and the CIGAR operations that consume reference sequence.\n\n    a.  **Left Endpoint (Start Position):**\n        The `POS` field in a SAM record gives the $1$-based, inclusive starting position of the alignment on the reference sequence. The problem states that $POS = 100$. This is the leftmost coordinate of the alignment. Therefore, the left endpoint of the closed reference interval is $100$.\n\n    b.  **Right Endpoint (End Position):**\n        The right endpoint is calculated by determining the total length of the alignment on the reference genome and adding it to the start position. The length on the reference is the sum of the lengths of all CIGAR operations that consume reference bases. The provided CIGAR string is `8S92M`.\n        - The operation `8S` ($8$ Soft-clipped bases) does not consume reference positions. Its contribution to the reference length is $0$.\n        - The operation `92M` ($92$ Matches/Mismatches) does consume reference positions. Its contribution to the reference length is $92$.\n\n        The total length of the alignment on the reference, $L_{ref}$, is the sum of the lengths of all reference-consuming operations.\n        $$L_{ref} = 0 (\\text{from 8S}) + 92 (\\text{from 92M}) = 92$$\n        The coordinate system is $1$-based and inclusive. If an alignment starts at position $P_{start}$ and has a length of $L_{ref}$, the interval it covers is $[P_{start}, P_{start} + L_{ref} - 1]$.\n        Using the given values:\n        - $P_{start} = POS = 100$\n        - $L_{ref} = 92$\n        The right endpoint, $P_{end}$, is calculated as:\n        $$P_{end} = P_{start} + L_{ref} - 1 = 100 + 92 - 1 = 191$$\n        Thus, the closed reference interval covered by the aligned bases is $[100, 191]$.\n\n3.  **Final Assembly:**\n    The problem requests the final answer as a row matrix containing the left interval endpoint, the right interval endpoint, and the soft-clipped count, in that order.\n    - Left endpoint: $100$\n    - Right endpoint: $191$\n    - Soft-clipped count: $8$\n\nThe resulting row matrix is $\\begin{pmatrix} 100  191  8 \\end{pmatrix}$.", "answer": "$$\\boxed{\\begin{pmatrix} 100  191  8 \\end{pmatrix}}$$", "id": "4314820"}, {"introduction": "Beyond knowing *where* a read aligns, it is crucial to understand *how confidently* each base was called by the sequencer. The `QUAL` field in a SAM file encodes this information using a compact ASCII representation. This practice will guide you through the process of converting these characters back into their underlying Phred quality scores and, ultimately, their base-call error probabilities, providing a quantitative grasp of data quality. [@problem_id:4314709]", "problem": "A clinical genomics pipeline for targeted sequencing in precision oncology stores read alignments in the Sequence Alignment/Map (SAM) text format, with downstream archiving in the Binary Alignment/Map (BAM) and Compressed Reference-oriented Alignment Map (CRAM) formats. To calibrate variant calling confidence, a bioinformatician inspects the SAM QUAL field for a read spanning a clinically relevant single-nucleotide variant and finds the three-character quality string “F?@” for the three consecutive bases centered on the variant locus. In the SAM specification, base quality characters are encoded using Phred-plus-33 (“Phred+33”) such that the numerical Phred quality score $Q$ is obtained by subtracting $33$ from the American Standard Code for Information Interchange (ASCII) code of the character. The ASCII codes for the characters “F”, “?”, and “@” are $70$, $63$, and $64$, respectively. The Phred quality score $Q$ is defined from first principles by the base-call error probability $p$ via $Q=-10\\log_{10}(p)$, where $\\log_{10}(\\cdot)$ denotes the base-$10$ logarithm. Starting only from these definitions, convert the QUAL string “F?@” to the corresponding Phred scores and compute the base-call error probabilities $p$ for each of the three bases. Provide the three probabilities as decimal numbers rounded to six significant figures, in the same order as the characters in the QUAL string. Do not express the results with a percentage sign; probabilities must be pure decimal numbers without units.", "solution": "The problem requires the conversion of a base quality string from a SAM file into corresponding base-call error probabilities. The process involves two sequential transformations derived from the definitions provided: first, from an ASCII character to a numerical Phred quality score, denoted as $Q$, and second, from the Phred score to the error probability, denoted as $p$.\n\nThe problem states the following definitions:\n1. The conversion from an ASCII character to a Phred score $Q$ uses the Phred$+33$ encoding scheme, which is defined by the relation:\n$$Q = A - 33$$\nwhere $A$ represents the numerical ASCII code of the character.\n\n2. The Phred quality score $Q$ is defined from first principles in terms of the base-call error probability $p$ by the equation:\n$$Q = -10\\log_{10}(p)$$\n\nTo determine the probability $p$ for a given quality character, we must first express $p$ as a function of $Q$. We can rearrange the second equation by algebraic manipulation. Dividing by $-10$ gives:\n$$-\\frac{Q}{10} = \\log_{10}(p)$$\nBy the definition of the base-$10$ logarithm, if $y = \\log_{10}(x)$, then $x = 10^y$. Applying this to our equation yields the expression for $p$:\n$$p = 10^{-\\frac{Q}{10}}$$\nWe can now substitute the first equation into this result to obtain a single formula that directly relates the ASCII code $A$ to the probability $p$:\n$$p = 10^{-\\frac{(A - 33)}{10}}$$\n\nThe problem provides the QUAL string \"F?@\", with the corresponding ASCII codes $A_F = 70$, $A_? = 63$, and $A_@ = 64$. We will now apply the derived formula to each character in sequence.\n\nFor the first character, 'F':\nThe given ASCII code is $A_F = 70$.\nFirst, we calculate the Phred quality score, $Q_F$:\n$$Q_F = 70 - 33 = 37$$\nNext, we compute the corresponding base-call error probability, $p_F$:\n$$p_F = 10^{-\\frac{37}{10}} = 10^{-3.7}$$\nThe numerical value, rounded to six significant figures as required, is:\n$$p_F \\approx 1.99526 \\times 10^{-4} = 0.000199526$$\n\nFor the second character, '?':\nThe given ASCII code is $A_? = 63$.\nThe Phred quality score, $Q_?$, is:\n$$Q_? = 63 - 33 = 30$$\nThe corresponding base-call error probability, $p_?$, is:\n$$p_? = 10^{-\\frac{30}{10}} = 10^{-3}$$\nThe numerical value is exactly $0.001$. To adhere to the requirement of six significant figures, we express this as:\n$$p_? = 0.00100000$$\n\nFor the third character, '@':\nThe given ASCII code is $A_@ = 64$.\nThe Phred quality score, $Q_@$, is:\n$$Q_@ = 64 - 33 = 31$$\nThe corresponding base-call error probability, $p_@$, is:\n$$p_@ = 10^{-\\frac{31}{10}} = 10^{-3.1}$$\nThe numerical value, rounded to six significant figures, is:\n$$p_@ \\approx 7.94328 \\times 10^{-4} = 0.000794328$$\n\nThe three requested probabilities, in the same order as the characters in the QUAL string \"F?@\", are $0.000199526$, $0.00100000$, and $0.000794328$.", "answer": "$$\\boxed{\\begin{pmatrix} 0.000199526  0.00100000  0.000794328 \\end{pmatrix}}$$", "id": "4314709"}, {"introduction": "The ultimate goal of analyzing alignment files is often to make biological inferences by aggregating information across many reads. This capstone exercise simulates a fundamental step in variant calling: calculating the depth of coverage and the alternate allele fraction at a specific genomic locus. Success requires synthesizing your understanding of CIGAR strings, alignment positions, and base-level information to parse multiple, complex records and arrive at a quantitative conclusion. [@problem_id:4314720]", "problem": "A central task in precision medicine and genomic diagnostics is to quantify base-level coverage and allele support from alignment files in Sequence Alignment/Map (SAM), Binary Alignment/Map (BAM), or Compressed Reference-oriented Alignment Map (CRAM) formats. In these formats, the Compact Idiosyncratic Gapped Alignment Report (CIGAR) string encodes how each read aligns to the reference, where operation $M$ consumes one reference base and one read base (either a match or a mismatch), operation $I$ consumes read bases but not reference bases, and operation $D$ consumes reference bases but not read bases. The MD tag specifies the positions of mismatches and deletions relative to the reference: numbers indicate runs of matches, letters indicate the reference base at a mismatch position, and a caret followed by letters indicates deleted reference bases. For the purposes of depth and allele fraction at a locus, a read contributes to the base-level depth at that reference position if and only if the CIGAR at that position consumes both the reference and the read (i.e., an $M$ at that locus), not a deletion ($D$). Insertions ($I$) do not consume the reference and therefore do not represent a base at the locus.\n\nConsider three reads aligned to chromosome $1$ such that each overlaps the locus chr$1$:$101$. Assume the reference base at chr$1$:$101$ is $A$. The three alignments are:\n\n- Read $R_{1}$: reference name chr$1$, leftmost alignment position POS $=97$, CIGAR = `5M`, MD tag = `4A0`. The observed read base at chr$1$:$101$ (from the SEQ field) is $G$.\n- Read $R_{2}$: reference name chr$1$, leftmost alignment position POS $=99$, CIGAR = `2M1I2M`, MD tag = `2A1`. The observed read base at chr$1$:$101$ is $G$.\n- Read $R_{3}$: reference name chr$1$, leftmost alignment position POS $=98$, CIGAR = `3M1D1M`, MD tag = `3^A1`.\n\nAssume all three reads pass mapping quality and base quality filters, there is no soft or hard clipping, and duplicate marking is not applicable. Define the base-level depth $D$ at chr$1$:$101$ as the number of reads that contribute an aligned read base at that position (i.e., exclude any read that has a deletion at that position). Define the alternate allele fraction $\\mathrm{AF}$ at chr$1$:$101$ relative to the reference base $A$ as the ratio\n$$\n\\mathrm{AF}=\\frac{\\text{number of reads with a non-reference base at chr }1:101}{\\text{number of reads that contribute a base at chr }1:101}.\n$$\nUse the CIGAR and MD semantics above to determine, for each read, whether it contributes a base at chr$1$:$101$ and, if so, whether that base equals the reference or an alternate allele. Provide exact values for $D$ and $\\mathrm{AF}$ with no rounding. Report your final answer as two real numbers in the order $D, \\mathrm{AF}$.", "solution": "The user wants to solve the problem, so I will do that.\nThe problem is valid. I will now solve it.\n\nThe problem requires the calculation of the base-level depth ($D$) and the alternate allele fraction ($\\mathrm{AF}$) at the genomic locus chr$1$:$101$. The reference base at this position is given as $A$. To solve this, we must analyze the alignment of each of the three reads ($R_1$, $R_2$, $R_3$) with respect to this locus. The key is to correctly interpret the CIGAR string for each read to determine which reference positions it covers and with which operation type (`M`, `I`, or `D`).\n\nAccording to the problem statement, a read contributes to the depth at a locus if and only if its CIGAR string has an `M` operation (match/mismatch) spanning that reference position. A read with a `D` operation (deletion) at the locus does not contribute to the depth. Reads with an `I` operation (insertion) do not consume the reference genome, so their effect is on the read itself and the CIGAR operations that follow, but the insertion does not align to the locus in question.\n\nLet's analyze each read individually. The reference is $1$-based.\n\n**Analysis of Read $R_1$:**\n- Leftmost alignment position (POS): $97$.\n- CIGAR string: `5M`.\n- This CIGAR string indicates that the first $5$ bases of the read align to the first $5$ bases of the reference starting at position $97$. The alignment thus covers reference positions $97, 98, 99, 100, 101$.\n- The specific operation at reference position $101$ is `M`. Based on the definition provided, this read contributes to the depth at chr$1$:$101$.\n- The problem states that the observed read base at chr$1$:$101$ is $G$. The reference base is $A$. Since $G \\neq A$, this read supports an alternate allele. The MD tag `4A0` confirms this: $4$ matches followed by a mismatch where the reference was `A` (at position $97+4 = 101$), which is consistent.\n\n**Analysis of Read $R_2$:**\n- Leftmost alignment position (POS): $99$.\n- CIGAR string: `2M1I2M`.\n- We trace the alignment along the reference:\n  - The `2M` operation aligns the first $2$ read bases to reference positions $99$ and $100$.\n  - The `1I` operation indicates an insertion of $1$ base in the read. This operation consumes a base from the read but does not advance the position on the reference. The reference position remains at the end of position $100$.\n  - The `2M` operation that follows aligns the next $2$ read bases to reference positions $101$ and $102$.\n- The specific operation at reference position $101$ is `M`. Therefore, this read contributes to the depth at chr$1$:$101$.\n- The problem states that the observed read base at chr$1$:$101$ is $G$. Since the reference is $A$, this read also supports an alternate allele. The MD tag `2A1` is consistent: $2$ matches (positions $99, 100$), followed by a mismatch where the reference is `A` (at position $101$), followed by $1$ match (position $102$).\n\n**Analysis of Read $R_3$:**\n- Leftmost alignment position (POS): $98$.\n- CIGAR string: `3M1D1M`.\n- We trace the alignment along the reference:\n  - The `3M` operation aligns the first $3$ read bases to reference positions $98, 99, 100$.\n  - The `1D` operation indicates a deletion of $1$ base from the reference. This operation consumes the reference base at position $101$ but does not consume a base from the read.\n  - The `1M` operation aligns the next read base to reference position $102$.\n- The specific operation at reference position $101$ is `D`. According to the problem's definition, a read with a deletion at a locus does not contribute to the base-level depth.\n- Therefore, read $R_3$ does not contribute to the depth at chr$1$:$101$. The MD tag `3^A1` is consistent: $3$ matches, followed by a deletion of reference base `A` (at position $98+3=101$), followed by $1$ match.\n\n**Calculation of Depth ($D$):**\nThe depth $D$ is the count of reads that contribute a base at chr$1$:$101$.\n- $R_1$ contributes.\n- $R_2$ contributes.\n- $R_3$ does not contribute.\nSo, the total number of contributing reads is $2$.\n$$ D = 2 $$\n\n**Calculation of Alternate Allele Fraction ($\\mathrm{AF}$):**\nThe formula for $\\mathrm{AF}$ is given as:\n$$ \\mathrm{AF}=\\frac{\\text{number of reads with a non-reference base at chr }1:101}{\\text{number of reads that contribute a base at chr }1:101} $$\n- The denominator is the depth $D$, which we found to be $2$.\n- The numerator is the count of reads from the contributing set (reads $R_1$ and $R_2$) that have a non-reference base.\n  - Read $R_1$ has base $G$ at this position. $G \\neq A$ (reference). This is a non-reference base.\n  - Read $R_2$ has base $G$ at this position. $G \\neq A$ (reference). This is also a non-reference base.\n- The number of reads with a non-reference base is $2$.\nTherefore, the alternate allele fraction is:\n$$ \\mathrm{AF} = \\frac{2}{2} = 1 $$\n\nThe final values are $D=2$ and $\\mathrm{AF}=1$.", "answer": "$$\\boxed{\\begin{pmatrix} 2  1 \\end{pmatrix}}$$", "id": "4314720"}]}