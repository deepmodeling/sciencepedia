{"hands_on_practices": [{"introduction": "The foundation of pharmacomicrobiomics lies in the biochemical reactions between microbial enzymes and drugs. This first exercise grounds our understanding in these fundamental principles by applying the Michaelis-Menten model of enzyme kinetics to a clinically relevant scenario [@problem_id:4368036]. By calculating the rate of drug cleavage under specific conditions, you will develop a quantitative intuition for how microbial metabolic capacity directly influences the biotransformation of a therapeutic compound.", "problem": "A patient-specific pharmacomicrobiomic assessment suggests that gut microbial azoreductase activity predominantly governs biotransformation of the prodrug sulfasalazine into its active moieties within the colon. Assume a well-mixed colonic lumen in which the sulfasalazine concentration is maintained at a constant value by continuous inflow and outflow, reflecting steady luminal exposure during transit. Let the bacterial enzyme kinetics be characterized by a maximum velocity $V_{\\max} = 0.8\\,\\mathrm{mM}\\,\\mathrm{h}^{-1}$ and a Michaelis constant $K_{m} = 0.2\\,\\mathrm{mM}$, and let the maintained luminal sulfasalazine concentration be $[S] = 0.4\\,\\mathrm{mM}$. Treat the colon segment as sufficiently large that $[S]$ is effectively constant over the time window considered and assume a memoryless cleavage process for any given sulfasalazine molecule under these constant-substrate conditions.\n\nStarting from the core definitions of enzyme kinetics, mass action, and the steady-state assumption for the enzyme–substrate complex, derive an expression for the time-dependent fraction of molecules cleaved by the microbial enzyme when the substrate concentration is constant. Then, using that expression, compute the fraction of sulfasalazine molecules present at time $t=0$ that have been cleaved by time $t=6\\,\\mathrm{h}$.\n\nExpress the final fraction as a decimal number without a percentage sign and round your answer to four significant figures. You do not need to report physical units for the fraction; time is in hours and concentration is in millimolar.", "solution": "The problem is first validated to ensure it is scientifically grounded, well-posed, and objective.\n\n**Step 1: Extract Givens**\n- **System:** Microbial azoreductase acting on sulfasalazine.\n- **Model:** Well-mixed colonic lumen with constant substrate concentration $[S]$ due to steady inflow/outflow.\n- **Enzyme Kinetic Parameters:**\n  - Maximum velocity, $V_{\\max} = 0.8\\,\\mathrm{mM}\\,\\mathrm{h}^{-1}$.\n  - Michaelis constant, $K_{m} = 0.2\\,\\mathrm{mM}$.\n- **Substrate Concentration:** $[S] = 0.4\\,\\mathrm{mM}$.\n- **Assumptions:**\n  - $[S]$ is effectively constant.\n  - The cleavage process is memoryless for any given molecule.\n- **Objective 1:** Derive an expression for the time-dependent fraction of molecules cleaved.\n- **Objective 2:** Calculate this fraction for a cohort of molecules present at $t=0$ by time $t=6\\,\\mathrm{h}$.\n- **Output Format:** Decimal number rounded to four significant figures.\n\n**Step 2: Validate Using Extracted Givens**\n- **Scientific Grounding:** The problem is based on the Michaelis-Menten model of enzyme kinetics, a cornerstone of biochemistry. The context of pharmacomicrobiomics and the sulfasalazine example are scientifically sound and relevant.\n- **Well-Posedness:** All necessary parameters ($V_{\\max}$, $K_m$, $[S]$, $t$) are provided. The assumptions, particularly the constant substrate concentration and the memoryless process, define a clear and solvable mathematical model. A unique solution exists.\n- **Objectivity:** The problem statement is quantitative and free of subjective or ambiguous language.\n\n**Verdict:** The problem is valid. It is a well-defined application of enzyme kinetics principles.\n\n**Step 3: Proceed with Solution**\n\nThe rate of an enzyme-catalyzed reaction, $v$, is described by the Michaelis-Menten equation:\n$$ v = \\frac{V_{\\max} [S]}{K_{m} + [S]} $$\nwhere $v$ is the reaction velocity, $V_{\\max}$ is the maximum velocity, $K_{m}$ is the Michaelis constant, and $[S]$ is the substrate concentration.\n\nAccording to the problem statement, the substrate concentration $[S]$ is maintained at a constant value of $0.4\\,\\mathrm{mM}$. Consequently, the reaction velocity $v$ is also constant:\n$$ v = \\frac{0.8\\,\\mathrm{mM}\\,\\mathrm{h}^{-1} \\times 0.4\\,\\mathrm{mM}}{0.2\\,\\mathrm{mM} + 0.4\\,\\mathrm{mM}} = \\frac{0.32}{0.6}\\,\\mathrm{mM}\\,\\mathrm{h}^{-1} = \\frac{8}{15}\\,\\mathrm{mM}\\,\\mathrm{h}^{-1} $$\nThis constant velocity means that, for the system as a whole, product is formed at a constant rate, which is characteristic of a zero-order reaction.\n\nHowever, the question asks for the fraction of a specific cohort of molecules—those present at time $t=0$—that have been cleaved by a later time $t$. We must consider the fate of these individual molecules within the larger, constant-concentration pool. The assumption of a \"memoryless cleavage process\" implies that for any given substrate molecule, the probability of being cleaved per unit time is constant. This is the defining characteristic of a first-order process from the perspective of the molecule's survival.\n\nLet's define a pseudo-first-order rate constant, $k$, for the cleavage of any individual sulfasalazine molecule. The overall rate of conversion, $v$, represents the total concentration of substrate converted per unit time. This conversion is distributed among all substrate molecules present at concentration $[S]$. Therefore, the rate constant $k$ (the probability of conversion per molecule, per unit time, scaled by concentration) is the overall velocity $v$ divided by the total substrate concentration $[S]$:\n$$ k = \\frac{v}{[S]} $$\nSubstituting the Michaelis-Menten expression for $v$, we get:\n$$ k = \\frac{1}{[S]} \\left( \\frac{V_{\\max} [S]}{K_{m} + [S]} \\right) = \\frac{V_{\\max}}{K_{m} + [S]} $$\nThe units of $k$ are $(\\mathrm{mM}\\,\\mathrm{h}^{-1}) / (\\mathrm{mM}) = \\mathrm{h}^{-1}$, as expected for a first-order rate constant.\n\nLet $N(t)$ be the number (or concentration) of molecules from the original cohort (present at $t=0$) that remain uncleaved at time $t$. The rate of change of $N(t)$ follows first-order kinetics:\n$$ \\frac{dN(t)}{dt} = -k N(t) $$\nThis is a separable differential equation. Integrating from $t=0$ to $t$ gives:\n$$ \\int_{N(0)}^{N(t)} \\frac{dN}{N} = - \\int_0^t k \\, dt' $$\n$$ \\ln\\left(\\frac{N(t)}{N(0)}\\right) = -kt $$\n$$ N(t) = N(0) \\exp(-kt) $$\nThe fraction of the original molecules that remain uncleaved at time $t$, $F_{remain}(t)$, is:\n$$ F_{remain}(t) = \\frac{N(t)}{N(0)} = \\exp(-kt) $$\nThe fraction of molecules that have been cleaved by time $t$, $F_{cleaved}(t)$, is therefore:\n$$ F_{cleaved}(t) = 1 - F_{remain}(t) = 1 - \\exp(-kt) $$\nSubstituting the expression for $k$, we arrive at the general expression for the time-dependent fraction of molecules cleaved:\n$$ F_{cleaved}(t) = 1 - \\exp\\left( -\\frac{V_{\\max}}{K_{m} + [S]} t \\right) $$\nThis completes the first part of the problem.\n\nFor the second part, we compute the numerical value at $t=6\\,\\mathrm{h}$, using the given parameters:\n$V_{\\max} = 0.8\\,\\mathrm{mM}\\,\\mathrm{h}^{-1}$\n$K_{m} = 0.2\\,\\mathrm{mM}$\n$[S] = 0.4\\,\\mathrm{mM}$\n$t = 6\\,\\mathrm{h}$\n\nFirst, we calculate the rate constant $k$:\n$$ k = \\frac{0.8\\,\\mathrm{mM}\\,\\mathrm{h}^{-1}}{0.2\\,\\mathrm{mM} + 0.4\\,\\mathrm{mM}} = \\frac{0.8}{0.6}\\,\\mathrm{h}^{-1} = \\frac{4}{3}\\,\\mathrm{h}^{-1} $$\nNow we calculate the exponent $-kt$:\n$$ -kt = -\\left(\\frac{4}{3}\\,\\mathrm{h}^{-1}\\right) \\times (6\\,\\mathrm{h}) = -8 $$\nFinally, we compute the fraction of cleaved molecules:\n$$ F_{cleaved}(6\\,\\mathrm{h}) = 1 - \\exp(-8) $$\nUsing a calculator, $\\exp(-8) \\approx 0.0003354626$.\n$$ F_{cleaved}(6\\,\\mathrm{h}) \\approx 1 - 0.0003354626 = 0.9996645374 $$\nRounding the result to four significant figures, we get $0.9997$.", "answer": "$$\\boxed{0.9997}$$", "id": "4368036"}, {"introduction": "Moving from a single reaction to a dynamic system, this practice explores how microbial activity impacts drug concentrations within a physiological context. We will use pharmacokinetic compartmental modeling—a cornerstone of pharmacology—to simulate the fate of the chemotherapy drug irinotecan's metabolite, SN-38, in the colon [@problem_id:4367938]. This exercise will equip you with the skills to translate biological processes into a mathematical framework, enabling you to predict how inhibiting microbial enzymes can mitigate drug toxicity.", "problem": "A single-compartment colonic lumen model is used to represent the microbial deconjugation of the irinotecan metabolite 7-ethyl-10-hydroxycamptothecin (SN-38) glucuronide to unconjugated SN-38 by bacterial $\\beta$-glucuronidase (beta-glucuronidase, abbreviated here as $\\beta$G). Assume the following scientifically grounded base:\n- The colonic lumen contains two chemical species: SN-38 glucuronide (denoted as SN-38G) and unconjugated SN-38 (denoted as SN-38).\n- Hepatic-biliary delivery provides a constant influx $I$ of SN-38G into the colon.\n- Microbial $\\beta$G-mediated deconjugation converts SN-38G to SN-38 following first-order kinetics with rate constant $k_{\\beta G}$, consistent with a pseudo-first-order approximation under substrate-limited conditions.\n- SN-38G is removed from the lumen by gastrointestinal transit at a first-order rate constant $k_g$, and unconjugated SN-38 is removed by absorption/binding/sequestration at a first-order rate constant $k_b$.\n- Steady state is achieved under constant dosing and stable microbial enzyme activity.\n\nStarting from these principles (mass balance and first-order kinetics), derive the steady-state amounts of SN-38G and SN-38 in the colon and use them to obtain a closed-form expression for the absolute reduction in the steady-state colonic SN-38 amount when an orally administered $\\beta$G inhibitor halves the effective deconjugation rate constant $k_{\\beta G}$. Use the parameter values $k_g = 1.2\\,\\text{h}^{-1}$, $k_b = 0.6\\,\\text{h}^{-1}$, and a baseline colonic SN-38G influx $I = 5\\,\\text{mg}\\,\\text{h}^{-1}$. Express the final reduction as a closed-form analytic expression in terms of $k_{\\beta G}$, in milligrams (mg). No rounding is required.", "solution": "The problem statement has been critically reviewed and determined to be valid. It is scientifically grounded in the established principles of pharmacokinetic compartmental modeling and a well-documented drug-microbiome interaction. The problem is well-posed, with all necessary parameters and conditions provided to derive a unique, meaningful solution.\n\nWe begin by establishing a mathematical model for the system. Let $G(t)$ represent the amount of SN-38 glucuronide (SN-38G) in milligrams ($mg$) and $S(t)$ represent the amount of unconjugated SN-38 in milligrams ($mg$) within the single-compartment colonic lumen at time $t$ in hours ($h$). The dynamics of these two species are described by a system of first-order ordinary differential equations based on the principles of mass balance.\n\nThe rate of change of the amount of SN-38G, $\\frac{dG}{dt}$, is determined by its constant influx $I$ and its removal through two first-order processes: microbial deconjugation with rate constant $k_{\\beta G}$ and gastrointestinal transit with rate constant $k_g$. The governing equation for $G(t)$ is:\n$$\n\\frac{dG}{dt} = I - k_{\\beta G} G - k_g G = I - (k_{\\beta G} + k_g)G\n$$\n\nThe rate of change of the amount of SN-38, $\\frac{dS}{dt}$, is determined by its formation from the deconjugation of SN-38G and its removal via absorption/binding/sequestration with a first-order rate constant $k_b$. The governing equation for $S(t)$ is:\n$$\n\\frac{dS}{dt} = k_{\\beta G} G - k_b S\n$$\n\nThe problem asks for the steady-state condition, where the amounts of both species no longer change over time. At steady state, $\\frac{dG}{dt} = 0$ and $\\frac{dS}{dt} = 0$. Let $G_{ss}$ and $S_{ss}$ denote the steady-state amounts.\n\nFrom the equation for $G(t)$, we solve for $G_{ss}$:\n$$\n0 = I - (k_{\\beta G} + k_g)G_{ss}\n$$\n$$\nG_{ss} = \\frac{I}{k_{\\beta G} + k_g}\n$$\n\nNext, we use the steady-state condition for $S(t)$ and the expression for $G_{ss}$ to solve for $S_{ss}$:\n$$\n0 = k_{\\beta G} G_{ss} - k_b S_{ss}\n$$\n$$\nk_b S_{ss} = k_{\\beta G} G_{ss}\n$$\n$$\nS_{ss} = \\frac{k_{\\beta G}}{k_b} G_{ss} = \\frac{k_{\\beta G}}{k_b} \\left( \\frac{I}{k_{\\beta G} + k_g} \\right) = \\frac{I k_{\\beta G}}{k_b (k_{\\beta G} + k_g)}\n$$\nThis is the general expression for the steady-state amount of SN-38.\n\nWe now consider the two scenarios described in the problem. First, the baseline (initial) state, where the deconjugation rate constant is $k_{\\beta G}$. The steady-state amount of SN-38, denoted as $S_{ss, \\text{initial}}$, is given by the expression derived above:\n$$\nS_{ss, \\text{initial}} = \\frac{I k_{\\beta G}}{k_b (k_{\\beta G} + k_g)}\n$$\n\nSecond, the inhibited (final) state, where an orally administered inhibitor halves the effective deconjugation rate constant. The new rate constant is $k'_{\\beta G} = \\frac{k_{\\beta G}}{2}$. To find the new steady-state amount of SN-38, $S_{ss, \\text{final}}$, we substitute $k'_{\\beta G}$ for $k_{\\beta G}$ in the general expression for $S_{ss}$:\n$$\nS_{ss, \\text{final}} = \\frac{I k'_{\\beta G}}{k_b (k'_{\\beta G} + k_g)} = \\frac{I \\left(\\frac{k_{\\beta G}}{2}\\right)}{k_b \\left(\\frac{k_{\\beta G}}{2} + k_g\\right)} = \\frac{I k_{\\beta G}}{2k_b \\left(\\frac{k_{\\beta G} + 2k_g}{2}\\right)} = \\frac{I k_{\\beta G}}{k_b (k_{\\beta G} + 2k_g)}\n$$\n\nThe absolute reduction in the steady-state colonic SN-38 amount, $\\Delta S_{ss}$, is the difference between the initial and final amounts:\n$$\n\\Delta S_{ss} = S_{ss, \\text{initial}} - S_{ss, \\text{final}}\n$$\n$$\n\\Delta S_{ss} = \\frac{I k_{\\beta G}}{k_b (k_{\\beta G} + k_g)} - \\frac{I k_{\\beta G}}{k_b (k_{\\beta G} + 2k_g)}\n$$\nWe can factor out the common term $\\frac{I k_{\\beta G}}{k_b}$:\n$$\n\\Delta S_{ss} = \\frac{I k_{\\beta G}}{k_b} \\left( \\frac{1}{k_{\\beta G} + k_g} - \\frac{1}{k_{\\beta G} + 2k_g} \\right)\n$$\nTo simplify the expression in the parenthesis, we find a common denominator:\n$$\n\\frac{1}{k_{\\beta G} + k_g} - \\frac{1}{k_{\\beta G} + 2k_g} = \\frac{(k_{\\beta G} + 2k_g) - (k_{\\beta G} + k_g)}{(k_{\\beta G} + k_g)(k_{\\beta G} + 2k_g)} = \\frac{k_{\\beta G} + 2k_g - k_{\\beta G} - k_g}{(k_{\\beta G} + k_g)(k_{\\beta G} + 2k_g)} = \\frac{k_g}{(k_{\\beta G} + k_g)(k_{\\beta G} + 2k_g)}\n$$\nSubstituting this back into the expression for $\\Delta S_{ss}$:\n$$\n\\Delta S_{ss} = \\frac{I k_{\\beta G}}{k_b} \\left( \\frac{k_g}{(k_{\\beta G} + k_g)(k_{\\beta G} + 2k_g)} \\right) = \\frac{I k_g k_{\\beta G}}{k_b (k_{\\beta G} + k_g)(k_{\\beta G} + 2k_g)}\n$$\nThis is the final closed-form expression for the absolute reduction in terms of the system parameters.\n\nThe problem requires this expression to be evaluated using the given parameter values: $I = 5\\,\\text{mg}\\,\\text{h}^{-1}$, $k_g = 1.2\\,\\text{h}^{-1}$, and $k_b = 0.6\\,\\text{h}^{-1}$. The expression should remain in terms of $k_{\\beta G}$.\n$$\n\\Delta S_{ss} = \\frac{(5)(1.2)k_{\\beta G}}{(0.6)(k_{\\beta G} + 1.2)(k_{\\beta G} + 2(1.2))}\n$$\n$$\n\\Delta S_{ss} = \\frac{6 k_{\\beta G}}{0.6(k_{\\beta G} + 1.2)(k_{\\beta G} + 2.4)}\n$$\n$$\n\\Delta S_{ss} = \\frac{10 k_{\\beta G}}{(k_{\\beta G} + 1.2)(k_{\\beta G} + 2.4)}\n$$\nThe units of this expression are milligrams ($mg$), as required.", "answer": "$$\n\\boxed{\\frac{10 k_{\\beta G}}{(k_{\\beta G} + 1.2)(k_{\\beta G} + 2.4)}}\n$$", "id": "4367938"}, {"introduction": "The ultimate goal of precision medicine is to integrate diverse patient data into predictive models that guide clinical decisions. This capstone practice challenges you to build such a model from the ground up, combining host genetics, microbial gene abundance, and clinical data to predict drug exposure [@problem_id:4367939]. By implementing a Bayesian hierarchical model using variational inference, you will gain hands-on experience with the sophisticated statistical and computational techniques required to navigate the complexity of multi-omics data and develop personalized therapeutic strategies.", "problem": "You are tasked with designing and implementing a Bayesian hierarchical model to predict the area under the concentration-time curve ($AUC$) for a glucuronidated drug by integrating host genotype, microbial gene abundance, and clinical covariates. Your implementation must be a complete, runnable program that computes posterior predictive means using mean-field variational inference under conjugate priors.\n\nScientific basis and modeling assumptions:\n- Assume the linear-Gaussian observation model: for each individual $i \\in \\{1,\\dots,n\\}$, the drug exposure is modeled as $y_i \\sim \\mathcal{N}(x_i^\\top \\beta, \\sigma^2)$, where $y_i$ denotes $AUC$ (in $\\mathrm{mg \\cdot h/L}$), $x_i \\in \\mathbb{R}^p$ is the feature vector, $\\beta \\in \\mathbb{R}^p$ are regression coefficients, and $\\sigma^2$ is the observation variance.\n- Partition the coefficients $\\beta$ into three disjoint groups corresponding to biological domains: host genotype ($g$), microbial gene abundance ($m$), and clinical covariates including an intercept ($c$). Assign independent Gaussian priors with group-specific variances: for each group $u \\in \\{g,m,c\\}$ and each coefficient index $j$ in that group, $\\beta_j \\sim \\mathcal{N}(0, \\tau_u^2)$.\n- Assign inverse-gamma priors to the variance parameters: $\\sigma^2 \\sim \\mathrm{IG}(a_\\sigma, b_\\sigma)$ and $\\tau_u^2 \\sim \\mathrm{IG}(a_u, b_u)$ for $u \\in \\{g,m,c\\}$, where $\\mathrm{IG}$ denotes the inverse-gamma distribution parameterized by shape and scale.\n- Use mean-field variational inference with the factorization $q(\\beta) \\prod_{u \\in \\{g,m,c\\}} q(\\tau_u^2) \\; q(\\sigma^2)$, exploiting the conjugacy of the normal-inverse-gamma family to derive coordinate ascent updates.\n\nData and preprocessing:\n- Let $n = 6$ training individuals.\n- Host genotype matrix $G \\in \\mathbb{R}^{6 \\times 3}$ (columns are counts of minor alleles for three loci, each entry is in $\\{0,1,2\\}$):\n  - Row $1$: $[0, 1, 0]$\n  - Row $2$: $[1, 0, 1]$\n  - Row $3$: $[2, 1, 0]$\n  - Row $4$: $[0, 0, 0]$\n  - Row $5$: $[1, 2, 1]$\n  - Row $6$: $[0, 1, 2]$\n- Microbial gene abundance matrix $M \\in \\mathbb{R}^{6 \\times 2}$ (relative abundances on $[0,1]$):\n  - Row $1$: $[0.3, 0.1]$\n  - Row $2$: $[0.0, 0.5]$\n  - Row $3$: $[0.8, 0.2]$\n  - Row $4$: $[0.1, 0.0]$\n  - Row $5$: $[0.5, 0.4]$\n  - Row $6$: $[0.9, 0.0]$\n- Clinical covariates matrix $C \\in \\mathbb{R}^{6 \\times 2}$ (age in years, estimated glomerular filtration rate in $\\mathrm{mL/min/1.73m^2}$):\n  - Row $1$: $[55, 95]$\n  - Row $2$: $[70, 60]$\n  - Row $3$: $[45, 110]$\n  - Row $4$: $[65, 80]$\n  - Row $5$: $[50, 100]$\n  - Row $6$: $[75, 70]$\n- Outcomes vector $y \\in \\mathbb{R}^6$ of observed $AUC$ (in $\\mathrm{mg \\cdot h/L}$):\n  - $y = [12.5, 10.2, 13.8, 11.0, 12.1, 10.8]$.\n- Construct the design matrix $X \\in \\mathbb{R}^{6 \\times p}$ by concatenating $G$, $M$, and $C$, and appending a column of ones for the intercept; thus $p = 3 + 2 + 2 + 1 = 8$. Do not standardize the intercept column.\n- Standardize each non-intercept predictor column in $X$ by subtracting the training mean and dividing by the training standard deviation computed over the $n = 6$ training individuals. Do not standardize $y$.\n\nPriors and initialization:\n- Use hyperparameters $a_\\sigma = 1$, $b_\\sigma = 1$, $a_g = 1$, $b_g = 1$, $a_m = 1$, $b_m = 1$, $a_c = 1$, $b_c = 1$.\n- Initialize the variational expectations using $E[1/\\sigma^2] = a_\\sigma/b_\\sigma$ and $E[1/\\tau_u^2] = a_u/b_u$ for $u \\in \\{g,m,c\\}$.\n\nInference task:\n- Implement coordinate ascent mean-field variational inference to obtain the Gaussian factor $q(\\beta) = \\mathcal{N}(\\mu_\\beta, \\Sigma_\\beta)$ and inverse-gamma factors for $\\sigma^2$ and $\\tau_u^2$ for $u \\in \\{g,m,c\\}$.\n- Use a convergence tolerance of $\\epsilon = 10^{-8}$ on the maximum absolute change in the mean vector $\\mu_\\beta$ across iterations or a hard cap of $T_{\\max} = 1000$ iterations, whichever is first.\n\nPrediction:\n- Given three held-out test cases, construct their feature vectors, standardize them using the training means and standard deviations (computed above), and include the intercept term of $1$. Compute the posterior predictive mean $\\hat{y}_\\ast = x_\\ast^\\top \\mu_\\beta$ for each. Express results in $\\mathrm{mg \\cdot h/L}$ as decimal numbers.\n- Test cases are defined as follows (each line is $[G_1,G_2,G_3; M_1,M_2; \\mathrm{Age}, \\mathrm{eGFR}]$):\n  - Case $1$: $[1, 0, 0; 0.2, 0.3; 60, 90]$.\n  - Case $2$: $[0, 1, 0; 0.0, 0.0; 65, 85]$.\n  - Case $3$: $[0, 0, 2; 0.9, 0.5; 50, 100]$.\n\nRequirements:\n- Your program must implement the above model and inference without requiring any user input and must use the specified data and hyperparameters.\n- Output formatting: Your program should produce a single line of output containing the three posterior predictive means in a comma-separated list enclosed in square brackets, with each value rounded to exactly three decimal places, for example $[x_1,x_2,x_3]$.\n- Units: All outputs are $AUC$ in $\\mathrm{mg \\cdot h/L}$.\n- Test Suite: The above three cases must be processed in this order and the results aggregated as specified, ensuring coverage of a typical case, a case with zero microbial abundance, and a case with high microbial abundance but no genotype burden on two loci.", "solution": "The problem requires the design and implementation of a Bayesian hierarchical model to predict drug Area Under the Curve ($AUC$) using variational inference. The solution involves specifying the model, deriving the update equations for the variational parameters, and implementing the algorithm to compute posterior predictive means for given test cases.\n\n### 1. Model Specification\n\nThe model is defined by a likelihood for the observed data and priors for the unknown parameters.\n\n**Likelihood**: For each of $n$ individuals, the drug $AUC$, denoted by $y_i$, is assumed to follow a normal distribution. The full dataset is $y \\in \\mathbb{R}^n$.\n$$\np(y | X, \\beta, \\sigma^2) = \\prod_{i=1}^n \\mathcal{N}(y_i | x_i^\\top \\beta, \\sigma^2)\n$$\nwhere $X \\in \\mathbb{R}^{n \\times p}$ is the design matrix, $x_i^\\top$ is the $i$-th row of $X$, and $\\beta \\in \\mathbb{R}^p$ is the vector of regression coefficients. $\\sigma^2$ is the observation variance.\n\n**Priors**: The coefficients $\\beta$ are partitioned into three groups: host genotype ($g$), microbial gene abundance ($m$), and clinical covariates including an intercept ($c$). Each coefficient $\\beta_j$ within a group $u \\in \\{g, m, c\\}$ is given a zero-mean normal prior with a group-specific variance $\\tau_u^2$.\n$$\np(\\beta | \\{\\tau_u^2\\}) = \\prod_{u \\in \\{g,m,c\\}} \\prod_{j \\in \\text{group } u} \\mathcal{N}(\\beta_j | 0, \\tau_u^2)\n$$\nThe variance parameters $\\sigma^2$ and $\\tau_u^2$ are given inverse-gamma priors, which are conjugate to the normal likelihood and priors. Let $p_u$ be the number of coefficients in group $u$.\n$$\np(\\sigma^2) = \\mathrm{IG}(\\sigma^2 | a_\\sigma, b_\\sigma)\n$$\n$$\np(\\tau_u^2) = \\mathrm{IG}(\\tau_u^2 | a_u, b_u) \\quad \\text{for } u \\in \\{g, m, c\\}\n$$\nThe inverse-gamma distribution is parameterized by shape $a$ and scale $b$, with density $f(z | a, b) \\propto z^{-a-1} \\exp(-b/z)$.\n\n### 2. Mean-Field Variational Inference\n\nWe approximate the true posterior $p(\\beta, \\sigma^2, \\{\\tau_u^2\\} | y, X)$ with a factorized variational distribution $q(\\beta, \\sigma^2, \\{\\tau_u^2\\})$:\n$$\nq(\\beta, \\sigma^2, \\{\\tau_u^2\\}) = q(\\beta) q(\\sigma^2) \\prod_{u \\in \\{g,m,c\\}} q(\\tau_u^2)\n$$\nThe optimal form for each factor $q_j^*$ is found by minimizing the Kullback-Leibler divergence between $q$ and the true posterior, which is equivalent to maximizing the Evidence Lower Bound (ELBO). This leads to the coordinate ascent variational inference (CAVI) update rule:\n$$\n\\log q_j^*(\\theta_j) = \\mathbb{E}_{q(\\theta_{\\neg j})} [\\log p(y, \\theta)] + \\text{const}\n$$\nwhere $\\theta_j$ is one block of parameters (e.g., $\\beta$) and $\\theta_{\\neg j}$ represents all other parameters.\n\n### 3. Derivation of Update Equations\n\nWe derive the specific forms of the variational factors by applying the CAVI update rule.\n\n**Update for $q(\\beta)$**:\nThe log-posterior for $\\beta$ involves quadratic terms, so $q(\\beta)$ will be a multivariate normal distribution, $q(\\beta) = \\mathcal{N}(\\mu_\\beta, \\Sigma_\\beta)$. The parameters are found by completing the square:\n$$\n\\Sigma_\\beta = \\left( \\mathbb{E}\\left[\\frac{1}{\\sigma^2}\\right] X^\\top X + \\mathbb{E}[D_\\tau^{-1}] \\right)^{-1}\n$$\n$$\n\\mu_\\beta = \\Sigma_\\beta \\left( \\mathbb{E}\\left[\\frac{1}{\\sigma^2}\\right] X^\\top y \\right)\n$$\nwhere $D_\\tau^{-1}$ is a diagonal matrix with entries $1/\\tau_u^2$ for coefficients in group $u$. Its expectation $\\mathbb{E}[D_\\tau^{-1}]$ is a diagonal matrix with entries $\\mathbb{E}[1/\\tau_u^2]$.\n\n**Update for $q(\\sigma^2)$**:\nDue to conjugacy, $q(\\sigma^2)$ is an inverse-gamma distribution, $q(\\sigma^2) = \\mathrm{IG}(a'_\\sigma, b'_\\sigma)$. Its parameters are updated as:\n$$\na'_\\sigma = a_\\sigma + \\frac{n}{2}\n$$\n$$\nb'_\\sigma = b_\\sigma + \\frac{1}{2}\\mathbb{E}_{\\beta}\\left[ (y - X\\beta)^\\top (y - X\\beta) \\right]\n$$\nThe expectation term expands to:\n$$\n\\mathbb{E}_{\\beta}\\left[ (y - X\\beta)^\\top (y - X\\beta) \\right] = (y - X\\mu_\\beta)^\\top(y - X\\mu_\\beta) + \\mathrm{tr}(X^\\top X \\Sigma_\\beta)\n$$\nThe required expectation for other updates is $\\mathbb{E}[1/\\sigma^2] = a'_\\sigma / b'_\\sigma$.\n\n**Update for $q(\\tau_u^2)$**:\nSimilarly, each $q(\\tau_u^2)$ for $u \\in \\{g, m, c\\}$ is an inverse-gamma distribution, $q(\\tau_u^2) = \\mathrm{IG}(a'_u, b'_u)$, with $p_u$ being the number of coefficients in group $u$.\n$$\na'_u = a_u + \\frac{p_u}{2}\n$$\n$$\nb'_u = b_u + \\frac{1}{2} \\sum_{j \\in \\text{group } u} \\mathbb{E}_\\beta[\\beta_j^2]\n$$\nThe expectation of the squared coefficient is $\\mathbb{E}[\\beta_j^2] = \\mathrm{Var}[\\beta_j] + (\\mathbb{E}[\\beta_j])^2 = (\\Sigma_\\beta)_{jj} + (\\mu_\\beta)_j^2$. The required expectation is $\\mathbb{E}[1/\\tau_u^2] = a'_u / b'_u$.\n\n### 4. Algorithm and Prediction\n\nThe CAVI algorithm proceeds as follows:\n1.  **Preprocessing**: Construct the design matrix $X$ by concatenating the provided matrices $G$, $M$, $C$, and a column of ones for the intercept. Standardize all predictor columns (except the intercept) using the mean and standard deviation from the training data. Store these statistics.\n2.  **Initialization**: Initialize the expectations $\\mathbb{E}[1/\\sigma^2]$ and $\\mathbb{E}[1/\\tau_u^2]$ for all $u$, typically to $1.0$ as specified.\n3.  **Iteration**: Repeatedly cycle through the updates for $q(\\beta)$, $q(\\sigma^2)$, and each $q(\\tau_u^2)$ using the derived equations.\n4.  **Convergence**: Stop when the maximum absolute change in the elements of $\\mu_\\beta$ between iterations falls below a tolerance $\\epsilon = 10^{-8}$, or a maximum number of iterations $T_{\\max} = 1000$ is reached.\n5.  **Prediction**: For a new test case with feature vector $x_{\\text{raw}, \\ast}$, first standardize it using the stored training means and standard deviations to get $x_{\\text{std}, \\ast}$. Then, form the full vector $x_\\ast$ by appending a $1$ for the intercept. The posterior predictive mean is then calculated as:\n    $$\n    \\hat{y}_\\ast = \\mathbb{E}[y_\\ast] = x_\\ast^\\top \\mathbb{E}[\\beta] = x_\\ast^\\top \\mu_\\beta\n    $$\n    This provides the final point estimate for the drug $AUC$ for the test case. The implementation will perform this for all three specified test cases.", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# No other libraries are used.\n\ndef solve():\n    \"\"\"\n    Implements a Bayesian hierarchical model with mean-field variational inference\n    to predict drug AUC from genotype, microbiome, and clinical data.\n    \"\"\"\n    # 1. Data and Constants\n    # ----------------------\n    \n    # Raw data matrices and vectors\n    G = np.array([\n        [0, 1, 0], [1, 0, 1], [2, 1, 0], \n        [0, 0, 0], [1, 2, 1], [0, 1, 2]\n    ], dtype=np.float64)\n    \n    M = np.array([\n        [0.3, 0.1], [0.0, 0.5], [0.8, 0.2], \n        [0.1, 0.0], [0.5, 0.4], [0.9, 0.0]\n    ], dtype=np.float64)\n    \n    C = np.array([\n        [55, 95], [70, 60], [45, 110], \n        [65, 80], [50, 100], [75, 70]\n    ], dtype=np.float64)\n    \n    y = np.array([12.5, 10.2, 13.8, 11.0, 12.1, 10.8], dtype=np.float64)\n\n    # Model dimensions\n    n, p_g = G.shape\n    _, p_m = M.shape\n    _, p_c_feats = C.shape\n    p = p_g + p_m + p_c_feats + 1 # +1 for intercept\n\n    # Group indices for coefficients beta\n    g_indices = list(range(p_g))\n    m_indices = list(range(p_g, p_g + p_m))\n    c_indices = list(range(p_g + p_m, p)) # Clinical features + intercept\n    \n    # Hyperparameters for Inverse-Gamma priors\n    a_sigma, b_sigma = 1.0, 1.0\n    a_g, b_g = 1.0, 1.0\n    a_m, b_m = 1.0, 1.0\n    a_c, b_c = 1.0, 1.0\n    \n    # Inference parameters\n    T_max = 1000\n    epsilon = 1e-8\n\n    # 2. Data Preprocessing\n    # ----------------------\n    \n    # Concatenate features, excluding intercept for now\n    X_unscaled_features = np.hstack((G, M, C))\n    \n    # Compute training means and standard deviations for standardization\n    train_means = np.mean(X_unscaled_features, axis=0)\n    train_stds = np.std(X_unscaled_features, axis=0)\n    \n    # Standardize features\n    X_scaled_features = (X_unscaled_features - train_means) / train_stds\n    \n    # Add intercept to form the final design matrix X\n    X = np.hstack((X_scaled_features, np.ones((n, 1))))\n\n    # 3. Variational Inference (CAVI)\n    # -------------------------------\n    \n    # Initialize expectations of precision parameters\n    E_inv_sigma_sq = a_sigma / b_sigma\n    E_inv_tau_g_sq = a_g / b_g\n    E_inv_tau_m_sq = a_m / b_m\n    E_inv_tau_c_sq = a_c / b_c\n    \n    # Initialize variational parameters for beta\n    mu_beta = np.zeros(p)\n    Sigma_beta = np.eye(p)\n    \n    XTX = X.T @ X\n    XTy = X.T @ y\n\n    for _ in range(T_max):\n        mu_beta_old = mu_beta.copy()\n        \n        # --- Update q(beta) ---\n        D_diag = np.zeros(p)\n        D_diag[g_indices] = E_inv_tau_g_sq\n        D_diag[m_indices] = E_inv_tau_m_sq\n        D_diag[c_indices] = E_inv_tau_c_sq\n        D = np.diag(D_diag)\n        \n        Sigma_beta_inv = E_inv_sigma_sq * XTX + D\n        Sigma_beta = np.linalg.inv(Sigma_beta_inv)\n        mu_beta = Sigma_beta @ (E_inv_sigma_sq * XTy)\n        \n        # --- Update q(sigma^2) ---\n        a_sigma_prime = a_sigma + n / 2\n        res_exp = np.sum((y - X @ mu_beta)**2)\n        trace_exp = np.trace(XTX @ Sigma_beta)\n        b_sigma_prime = b_sigma + 0.5 * (res_exp + trace_exp)\n        E_inv_sigma_sq = a_sigma_prime / b_sigma_prime\n        \n        # --- Update q(tau_g^2) ---\n        a_g_prime = a_g + len(g_indices) / 2\n        beta_g_sq_exp = np.sum(np.diag(Sigma_beta)[g_indices] + mu_beta[g_indices]**2)\n        b_g_prime = b_g + 0.5 * beta_g_sq_exp\n        E_inv_tau_g_sq = a_g_prime / b_g_prime\n        \n        # --- Update q(tau_m^2) ---\n        a_m_prime = a_m + len(m_indices) / 2\n        beta_m_sq_exp = np.sum(np.diag(Sigma_beta)[m_indices] + mu_beta[m_indices]**2)\n        b_m_prime = b_m + 0.5 * beta_m_sq_exp\n        E_inv_tau_m_sq = a_m_prime / b_m_prime\n\n        # --- Update q(tau_c^2) ---\n        a_c_prime = a_c + len(c_indices) / 2\n        beta_c_sq_exp = np.sum(np.diag(Sigma_beta)[c_indices] + mu_beta[c_indices]**2)\n        b_c_prime = b_c + 0.5 * beta_c_sq_exp\n        E_inv_tau_c_sq = a_c_prime / b_c_prime\n\n        # --- Check for convergence ---\n        if np.max(np.abs(mu_beta - mu_beta_old)) < epsilon:\n            break\n\n    # 4. Prediction on Test Cases\n    # ---------------------------\n    \n    test_cases_raw = [\n        # G1 G2 G3  M1  M2   Age eGFR\n        [1, 0, 0, 0.2, 0.3, 60, 90],  # Case 1\n        [0, 1, 0, 0.0, 0.0, 65, 85],  # Case 2\n        [0, 0, 2, 0.9, 0.5, 50, 100]  # Case 3\n    ]\n    \n    predictions = []\n    for case in test_cases_raw:\n        x_raw_star = np.array(case, dtype=np.float64)\n        \n        # Standardize using training statistics\n        x_scaled_star = (x_raw_star - train_means) / train_stds\n        \n        # Add intercept\n        x_star = np.hstack((x_scaled_star, 1.0))\n        \n        # Compute posterior predictive mean\n        y_pred = x_star @ mu_beta\n        predictions.append(y_pred)\n    \n    # 5. Format and Print Output\n    # --------------------------\n    \n    # Format to 3 decimal places\n    formatted_results = [f\"{p:.3f}\" for p in predictions]\n    print(f\"[{','.join(formatted_results)}]\")\n\n# Execute the solver\nsolve()\n\n```", "id": "4367939"}]}