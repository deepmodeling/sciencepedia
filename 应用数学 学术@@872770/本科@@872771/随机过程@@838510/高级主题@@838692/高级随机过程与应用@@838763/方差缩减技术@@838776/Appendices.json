{"hands_on_practices": [{"introduction": "控制变量法是蒙特卡罗模拟中一种强大而基础的方差缩减技术。这个练习将带你深入其核心机制，通过一个具体的积分估算问题，练习如何推导并计算最优控制系数 $b^*$ [@problem_id:1348947]。掌握这个计算过程对于理解控制变量法为何能有效降低估计方差至关重要。", "problem": "在蒙特卡罗方法中，一个常见的任务是估计积分 $I = \\int_a^b g(x) dx$ 的值。这通常通过将积分重构为期望值 $E[f(X)]$ 来实现，其中 $X$ 是一个随机变量，$f$ 是一个相关函数。一个标准的“原始”蒙特卡罗估计量则使用 $f(X_i)$ 的 $N$ 次独立抽样的样本均值。\n\n为了在给定样本数量的情况下提高估计的精度，可以采用方差缩减技术。其中一种技术是控制变量法。这需要找到一个与 $f(X)$ 相关且期望 $\\mu_C = E[C]$ 已知的随机变量 $C$。然后可以构建一个新的、改进的估计量 $Z(b) = f(X) - b(C - \\mu_C)$，其中 $b$ 是一个常数系数。$b$ 的取值应使 $Z(b)$ 的方差最小化。这个最优系数，记为 $b^*$，由以下公式给出：\n$$b^* = \\frac{\\text{Cov}(f(X), C)}{\\text{Var}(C)}$$\n\n考虑估计积分 $I = \\int_0^1 \\cos\\left(\\frac{\\pi x}{2}\\right) dx$ 的问题。这等价于求 $Y = \\cos\\left(\\frac{\\pi X}{2}\\right)$ 的期望值，其中 $X$ 是在区间 $[0, 1]$ 上均匀分布的随机变量。我们将使用随机变量 $C = X$ 作为控制变量，因为它与 $Y$ 相关，且其性质易于确定。\n\n你的任务是计算该控制变量的最优系数 $b^*$ 的精确理论值。请用一个关于 $\\pi$ 的闭式解析表达式来表示你的答案。", "solution": "我们有 $X \\sim \\text{Unif}[0,1]$，$Y=\\cos\\left(\\frac{\\pi X}{2}\\right)$，以及 $C=X$。最优控制变量系数为\n$$\nb^{*}=\\frac{\\text{Cov}(Y,C)}{\\text{Var}(C)}.\n$$\n首先计算 $\\text{Var}(C)$。使用 $E[X]=\\int_{0}^{1}x\\,dx=\\frac{1}{2}$ 和 $E[X^{2}]=\\int_{0}^{1}x^{2}\\,dx=\\frac{1}{3}$，我们得到\n$$\n\\text{Var}(C)=E[X^{2}]-\\left(E[X]\\right)^{2}=\\frac{1}{3}-\\frac{1}{4}=\\frac{1}{12}.\n$$\n接下来计算 $E[Y]$：\n$$\nE[Y]=\\int_{0}^{1}\\cos\\left(\\frac{\\pi x}{2}\\right)\\,dx=\\left.\\frac{2}{\\pi}\\sin\\left(\\frac{\\pi x}{2}\\right)\\right|_{0}^{1}=\\frac{2}{\\pi}.\n$$\n现在计算 $E[CY]=E\\!\\left[X\\cos\\left(\\frac{\\pi X}{2}\\right)\\right]$。令 $a=\\frac{\\pi}{2}$。则\n$$\nE[CY]=\\int_{0}^{1}x\\cos(ax)\\,dx.\n$$\n使用分部积分法，令 $u=x$，$dv=\\cos(ax)\\,dx$，则 $du=dx$ 且 $v=\\frac{1}{a}\\sin(ax)$，我们得到\n$$\n\\int x\\cos(ax)\\,dx=\\frac{x\\sin(ax)}{a}+\\frac{\\cos(ax)}{a^{2}}.\n$$\n从 $0$ 到 $1$ 求值，\n$$\n\\int_{0}^{1}x\\cos(ax)\\,dx=\\frac{\\sin(a)}{a}+\\frac{\\cos(a)-1}{a^{2}}.\n$$\n当 $a=\\frac{\\pi}{2}$ 时，我们有 $\\sin(a)=1$ 和 $\\cos(a)=0$，因此\n$$\nE[CY]=\\frac{1}{a}-\\frac{1}{a^{2}}=\\frac{2}{\\pi}-\\frac{4}{\\pi^{2}}.\n$$\n因此，\n$$\n\\text{Cov}(Y,C)=E[CY]-E[Y]E[C]=\\left(\\frac{2}{\\pi}-\\frac{4}{\\pi^{2}}\\right)-\\left(\\frac{2}{\\pi}\\right)\\left(\\frac{1}{2}\\right) = \\left(\\frac{2}{\\pi}-\\frac{4}{\\pi^{2}}\\right) - \\frac{1}{\\pi} = \\frac{1}{\\pi}-\\frac{4}{\\pi^{2}} = \\frac{\\pi-4}{\\pi^{2}}.\n$$\n最后，\n$$\nb^{*}=\\frac{\\text{Cov}(Y,C)}{\\text{Var}(C)}=\\frac{\\frac{\\pi-4}{\\pi^{2}}}{\\frac{1}{12}}=\\frac{12(\\pi-4)}{\\pi^{2}}.\n$$", "answer": "$$\\boxed{\\frac{12(\\pi - 4)}{\\pi^{2}}}$$", "id": "1348947"}, {"introduction": "重要性采样是另一种关键的方差缩减技术，尤其在处理罕见事件估计时威力巨大。与直接计算不同，本练习旨在培养你设计有效采样方案的直觉 [@problem_id:1348967]。通过选择一个“加权”的概率分布，我们将学习如何引导样本更多地出现在我们感兴趣的关键区域，从而以更少的样本量获得更精确的估计。", "problem": "在一个蒙特卡洛模拟练习中，我们的目标是估计一个标准的公平六面骰子独立投掷20次的结果之和超过100的概率 $p$。设 $X_i$（其中 $i=1, \\dots, 20$）为第 $i$ 次投掷的结果，因此 $X_i$ 是一个在集合 $\\{1, 2, 3, 4, 5, 6\\}$ 上均匀分布的随机变量。我们关心的是 $p = P(\\sum_{i=1}^{20} X_i  100)$。\n\n由于这是一个稀有事件，朴素的蒙特卡洛模拟效率低下。为了提高效率，我们可以使用重要性采样，这是一种方差缩减技术。这涉及到对每次骰子投掷，从一个不同的、“加权的”概率质量函数（PMF）（我们称之为 $q(k)$）进行采样，而不是从原始的均匀PMF $p(k) = 1/6$ 进行采样。\n\n对于单次骰子投掷（其中 $k \\in \\{1, 2, 3, 4, 5, 6\\}$），以下哪个加权PMF $q(k)$ 的选择是实施重要性采样以低方差估计 $p$ 的最合适的选择？\n\nA. $q(k) = \\frac{1}{6}$，对于 $k \\in \\{1, 2, 3, 4, 5, 6\\}$\n\nB. $q(k) = \\frac{7-k}{21}$，对于 $k \\in \\{1, 2, 3, 4, 5, 6\\}$\n\nC. $q(k) = \\frac{1}{3}$，对于 $k \\in \\{4, 5, 6\\}$，以及 $q(k) = 0$，对于 $k \\in \\{1, 2, 3\\}$\n\nD. $q(k) = \\frac{k}{21}$，对于 $k \\in \\{1, 2, 3, 4, 5, 6\\}$", "solution": "设 $X_{1},\\dots,X_{20}$ 是独立同分布的随机变量，其名义PMF为在 $\\{1,2,3,4,5,6\\}$ 上的 $p(k)=\\frac{1}{6}$，并设 $S=\\sum_{i=1}^{20}X_{i}$。我们想要求解 $p^{\\star}=P(S100)$。重要性采样通过从一个在 $\\{1,\\dots,6\\}$ 上的提议PMF $q$ 中独立同分布地采样 $Y_{1},\\dots,Y_{20}$，并使用以下无偏估计量来估计 $p^{\\star}$：\n$$\n\\widehat{p}=\\mathbf{1}\\{Y_{1}+\\cdots+Y_{20}100\\}\\prod_{i=1}^{20}\\frac{p(Y_{i})}{q(Y_{i})}.\n$$\n无偏性要求，限制在稀有事件集上的 $p$ 相对于 $q$ 必须是绝对连续的，在这里这相当于对于任何可能出现在对 $S100$ 有贡献的序列中的每一个 $k\\in\\{1,\\dots,6\\}$，都有 $q(k)0$。由于在 $\\{S100\\}$ 中存在包含 $1,2,3,4,5,6$ 中任意值的序列，我们需要对所有的 $k\\in\\{1,\\dots,6\\}$ 都有 $q(k)0$。\n\n对稀有事件 $S100$ 进行方差缩减，需要提议的分布能使大的结果更有可能出现，从而增加 $P_{q}(S100)$，同时保持似然比稳定。对于单次投掷，似然比为 $L(k)=\\frac{p(k)}{q(k)}$。对于由大的 $k$ 值主导的稀有事件， $L(k)$ 随 $k$ 减小是有利的，这样事件的典型样本会获得较小的权重，从而减小方差。从启发式角度看，最优的提议分布是一个指数倾斜分布 $q_{\\theta}(k)\\propto p(k)\\exp(\\theta k)$，其中 $\\theta0$。这种分布将更多的概率质量放在较大的 $k$ 值上，并且具有完全支撑集。\n\n评估每个选项：\n\nA. $q(k)=\\frac{1}{6}$。这是名义PMF。它不提供任何方差缩减，因此对于稀有事件来说不是最合适的。\n\nB. $q(k)=\\frac{7-k}{21}$。这个提议分布偏好小的 $k$ 值（因为 $q(1)\\cdotsq(6)$），这将概率质量移出了稀有事件区域。其单次投掷的似然比为\n$$\nL_{B}(k)=\\frac{\\frac{1}{6}}{\\frac{7-k}{21}}=\\frac{7}{2(7-k)},\n$$\n它随 $k$ 增大而增大，给予在 $S100$ 条件下典型的大结果以较大的权重，从而增大了方差。这是不合适的。\n\nC. 对于 $k\\in\\{4,5,6\\}$，$q(k)=\\frac{1}{3}$，而对于 $k\\in\\{1,2,3\\}$，$q(k)=0$。虽然这极大地偏好大的点数，但它违反了绝对连续性要求，因为存在 $S100$ 的序列，其中包含 $\\{1,2,3\\}$ 中的值，这些序列在 $p$ 下具有正概率，但在 $q$ 下概率为零。因此，$\\prod_{i}p(Y_{i})/q(Y_{i})$ 在整个稀有事件集上没有良好定义，无法用这个 $q$ 构建一个对 $P(S100)$ 的无偏重要性采样（IS）估计量。\n\nD. $q(k)=\\frac{k}{21}$。这个提议分布偏好大的 $k$ 值，同时保持了完全支撑集。其单次投掷的似然比为\n$$\nL_{D}(k)=\\frac{\\frac{1}{6}}{\\frac{k}{21}}=\\frac{7}{2k},\n$$\n它随 $k$ 增大而减小，因此事件的典型样本会获得较小的权重，从而稳定了估计量并减小了方差。此外，每个PMF下的期望值证实了倾斜的方向：\n$$\n\\mathbb{E}_{p}[X]=\\frac{1+2+3+4+5+6}{6}=\\frac{7}{2},\\quad\n\\mathbb{E}_{B}[X]=\\frac{7\\sum_{k=1}^{6}k-\\sum_{k=1}^{6}k^{2}}{21}=\\frac{56}{21}=\\frac{8}{3}  \\frac{7}{2},\n$$\n$$\n\\mathbb{E}_{C}[X]=\\frac{4+5+6}{3}=5\\quad\\text{(但 $q$ 有零值，对无偏IS无效)},\n$$\n$$\n\\mathbb{E}_{D}[X]=\\frac{\\sum_{k=1}^{6}k^{2}}{21}=\\frac{91}{21}=\\frac{13}{3}\\frac{7}{2}.\n$$\n因此，D向正确的方向倾斜，保持了完全支撑集，并且产生的似然比对于大的 $k$ 值更小，所有这些都有助于在估计 $P(S100)$ 时获得更低的方差。\n\n因此，在给定的选项中，D是用于低方差重要性采样的最合适的选择。", "answer": "$$\\boxed{D}$$", "id": "1348967"}, {"introduction": "理论上的方差缩减效果在实践中并非总能转化为效率的提升。本练习将引导你思考一个更高级、更现实的问题：方差缩减带来的统计收益与额外计算成本之间的权衡 [@problem_id:2446657]。通过分析一个设置了计算预算的场景，你将学会判断何时使用控制变量法是明智的，并理解在有限的计算资源下，整体效率才是最终目标。", "problem": "一位金融分析师试图在风险中性测度下，使用蒙特卡洛（MC）方法估计某衍生证券的预期折现收益 $Y$。设 $Y$ 是一个平方可积的随机变量，其方差有限，为 $\\sigma_Y^2 = \\operatorname{Var}(Y)$。对于每个模拟路径，计算 $Y$ 的时间成本为 $c_Y = 1$ 个单位。该分析师还考虑使用一个控制变量 $X$，其均值已知，为 $\\mu_X = \\mathbb{E}[X]$。在每条路径上，$X$ 与 $Y$ 由相同的底层随机性计算得出，其方差有限，为 $\\sigma_X^2 = \\operatorname{Var}(X)$，且与 $Y$ 的相关系数为 $\\rho = \\operatorname{Corr}(Y,X)$。在一条路径上计算 $X$ 会产生额外的时间成本 $c_X$ 个单位。总计算预算为 $B$ 个时间单位，并且两种估计量都是通过对独立同分布（i.i.d.）样本取平均值得到的。假设所有情况下估计量都是无偏的，并忽略样本数量的整数效应。\n\n分析师可以使用形式为 $\\bar{Y} - \\beta(\\bar{X} - \\mu_X)$ 的线性控制变量估计量，其中系数 $\\beta$ 是最优选择的。\n\n在下列哪种情况下，最优线性控制变量估计量的渐近均方误差（MSE）会严格大于原始蒙特卡洛（crude MC）估计量的均方误差（即，在固定预算 $B$ 下，控制变量估计量的方差超过原始蒙特卡洛估计量的方差）？选择所有适用项。\n\nA. $\\rho = 0.8$ 且 $c_X = 0.2$。\n\nB. $\\rho = 0.5$ 且 $c_X = 1$。\n\nC. $\\rho = 0.95$ 且 $c_X = 5$。\n\nD. $\\rho = 0.9$ 且 $c_X = 10$。", "solution": "对问题陈述进行验证。\n\n**步骤1：提取已知条件**\n-   待估计的量是预期折现收益 $\\mathbb{E}[Y]$。\n-   $Y$ 是一个平方可积的随机变量，其方差有限，为 $\\sigma_Y^2 = \\operatorname{Var}(Y)$。\n-   生成一个 $Y$ 样本的计算成本是 $c_Y = 1$。\n-   $X$ 是一个控制变量，其均值已知，为 $\\mu_X = \\mathbb{E}[X]$。\n-   $X$ 的方差有限，为 $\\sigma_X^2 = \\operatorname{Var}(X)$。\n-   $Y$ 和 $X$ 之间的相关系数是 $\\rho = \\operatorname{Corr}(Y, X)$。\n-   生成一个 $X$ 样本的额外计算成本是 $c_X$。\n-   总计算预算是 $B$。\n-   估计量是独立同分布（i.i.d.）样本的平均值。\n-   所有估计量都是无偏的。\n-   样本数量的整数效应将被忽略。\n-   控制变量估计量的形式为 $\\bar{Y} - \\beta(\\bar{X} - \\mu_X)$，其中系数 $\\beta$ 是最优选择的。\n\n**步骤2：已知条件的验证**\n该问题在科学上基于蒙特卡洛方法和方差缩减技术的既定理论，特别是控制变量法，这是计算金融和统计学中的一个标准课题。问题提法明确，提供了一个清晰的目标：在固定的计算预算下，比较两种估计量的均方误差（MSE）。语言客观而精确。所有术语如方差、相关性和均方误差都是标准的且定义明确。问题的设定是自洽且一致的，提供了足够的信息来进行推导比较，而无需 $\\sigma_Y^2$、$\\sigma_X^2$ 或 $B$ 的具体数值，因为这些值在相对比较中会抵消掉。该问题不违反任何基本原则，不基于错误的前提，并且可以被形式化并严格求解。\n\n**步骤3：结论**\n问题是有效的。我们将继续进行推导和求解。\n\n目标是找到关于 $\\rho$ 和 $c_X$ 的条件，使得在固定的总计算预算 $B$ 下，最优线性控制变量估计量的渐近均方误差严格大于原始蒙特卡洛估计量的均方误差。由于估计量是无偏的，它们的均方误差等于它们的方差。\n\n**原始蒙特卡洛（MC）估计量**\n$\\mathbb{E}[Y]$ 的估计量是 $N_{MC}$ 个 $Y$ 的独立同分布样本的样本均值：\n$$ \\bar{Y}_{MC} = \\frac{1}{N_{MC}} \\sum_{i=1}^{N_{MC}} Y_i $$\n每个样本的成本是 $c_Y = 1$。在总预算为 $B$ 的情况下，样本数量为 $N_{MC} = B / c_Y = B$。\n该估计量的均方误差即为其方差：\n$$ \\operatorname{MSE}(\\bar{Y}_{MC}) = \\operatorname{Var}(\\bar{Y}_{MC}) = \\frac{\\operatorname{Var}(Y)}{N_{MC}} = \\frac{\\sigma_Y^2}{B} $$\n\n**最优线性控制变量（CV）估计量**\n控制变量估计量是使用变量 $Z(\\beta) = Y - \\beta(X - \\mu_X)$ 构建的。该估计量是 $N_{CV}$ 个 $Z(\\beta)$ 样本的样本均值：\n$$ \\bar{Y}_{CV} = \\frac{1}{N_{CV}} \\sum_{i=1}^{N_{CV}} (Y_i - \\beta(X_i - \\mu_X)) $$\n对于任何 $\\beta$，该估计量对于 $\\mathbb{E}[Y]$ 都是无偏的，因为 $\\mathbb{E}[Z(\\beta)] = \\mathbb{E}[Y] - \\beta(\\mathbb{E}[X] - \\mu_X) = \\mathbb{E}[Y]$。\n单个样本 $Z(\\beta)$ 的方差是：\n$$ \\sigma_{CV}^2(\\beta) = \\operatorname{Var}(Z(\\beta)) = \\operatorname{Var}(Y - \\beta X) = \\operatorname{Var}(Y) + \\beta^2 \\operatorname{Var}(X) - 2\\beta \\operatorname{Cov}(Y, X) $$\n$$ \\sigma_{CV}^2(\\beta) = \\sigma_Y^2 + \\beta^2 \\sigma_X^2 - 2\\beta \\rho \\sigma_Y \\sigma_X $$\n为了找到最优系数 $\\beta^*$，我们对该方差关于 $\\beta$ 进行最小化：\n$$ \\frac{d}{d\\beta} \\sigma_{CV}^2(\\beta) = 2\\beta \\sigma_X^2 - 2\\rho \\sigma_Y \\sigma_X = 0 $$\n这得到最优的 $\\beta^*$：\n$$ \\beta^* = \\frac{\\rho \\sigma_Y \\sigma_X}{\\sigma_X^2} = \\frac{\\rho \\sigma_Y}{\\sigma_X} $$\n将 $\\beta^*$ 代入方差表达式，得到最小方差：\n$$ \\operatorname{Var}(Z(\\beta^*)) = \\sigma_Y^2 + \\left(\\frac{\\rho \\sigma_Y}{\\sigma_X}\\right)^2 \\sigma_X^2 - 2\\left(\\frac{\\rho \\sigma_Y}{\\sigma_X}\\right) \\rho \\sigma_Y \\sigma_X $$\n$$ \\operatorname{Var}(Z(\\beta^*)) = \\sigma_Y^2 + \\rho^2 \\sigma_Y^2 - 2\\rho^2 \\sigma_Y^2 = \\sigma_Y^2 (1 - \\rho^2) $$\nCV方法的每个样本的计算成本是 $Y$ 和 $X$ 的成本之和，即 $c_{CV} = c_Y + c_X = 1 + c_X$。\n在总预算为 $B$ 的情况下，样本数量为 $N_{CV} = B / c_{CV} = B / (1 + c_X)$。\n最优CV估计量的均方误差即为其方差：\n$$ \\operatorname{MSE}(\\bar{Y}_{CV}) = \\frac{\\operatorname{Var}(Z(\\beta^*))}{N_{CV}} = \\frac{\\sigma_Y^2 (1 - \\rho^2)}{B / (1 + c_X)} = \\frac{\\sigma_Y^2 (1 - \\rho^2)(1 + c_X)}{B} $$\n\n**均方误差（MSE）的比较**\n我们需要找到CV估计量严格差于原始MC估计量的情形。这对应于条件：\n$$ \\operatorname{MSE}(\\bar{Y}_{CV})  \\operatorname{MSE}(\\bar{Y}_{MC}) $$\n$$ \\frac{\\sigma_Y^2 (1 - \\rho^2)(1 + c_X)}{B}  \\frac{\\sigma_Y^2}{B} $$\n由于 $\\sigma_Y^2  0$（否则估计是平凡的）且 $B  0$，我们可以将不等式简化为：\n$$ (1 - \\rho^2)(1 + c_X)  1 $$\n这个不等式表达了一种权衡关系。项 $(1 - \\rho^2)$ 是每个样本的方差缩减因子，而 $(1 + c_X)$ 是成本因子，即样本量缩减因子的倒数。如果成本的增加超过了方差缩减带来的好处，那么CV方法就是不利的。我们现在根据这个条件测试每个选项。\n\n**逐项分析**\n\n**A. $\\rho = 0.8$ 且 $c_X = 0.2$。**\n我们计算表达式 $(1 - \\rho^2)(1 + c_X)$：\n$$ (1 - (0.8)^2)(1 + 0.2) = (1 - 0.64)(1.2) = (0.36)(1.2) = 0.432 $$\n条件 $0.432  1$ 是假的。控制变量显著提高了效率。\n**结论：不正确。**\n\n**B. $\\rho = 0.5$ 且 $c_X = 1$。**\n我们计算表达式 $(1 - \\rho^2)(1 + c_X)$：\n$$ (1 - (0.5)^2)(1 + 1) = (1 - 0.25)(2) = (0.75)(2) = 1.5 $$\n条件 $1.5  1$ 是真的。在这种情况下，控制变量法导致了更大的均方误差。\n**结论：正确。**\n\n**C. $\\rho = 0.95$ 且 $c_X = 5$。**\n我们计算表达式 $(1 - \\rho^2)(1 + c_X)$：\n$$ (1 - (0.95)^2)(1 + 5) = (1 - 0.9025)(6) = (0.0975)(6) = 0.585 $$\n条件 $0.585  1$ 是假的。尽管成本很高，但极高的相关性使得控制变量仍然是有益的。\n**结论：不正确。**\n\n**D. $\\rho = 0.9$ 且 $c_X = 10$。**\n我们计算表达式 $(1 - \\rho^2)(1 + c_X)$：\n$$ (1 - (0.9)^2)(1 + 10) = (1 - 0.81)(11) = (0.19)(11) = 2.09 $$\n条件 $2.09  1$ 是真的。极高的计算成本 $c_X$ 没有被 $\\rho = 0.9$ 的相关性所带来的方差缩减充分补偿。\n**结论：正确。**", "answer": "$$\\boxed{BD}$$", "id": "2446657"}]}