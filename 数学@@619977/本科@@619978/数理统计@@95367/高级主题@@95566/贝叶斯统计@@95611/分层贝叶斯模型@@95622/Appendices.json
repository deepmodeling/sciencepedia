{"hands_on_practices": [{"introduction": "分层贝叶斯模型的核心优势在于“借力”（borrowing strength），即利用所有组的信息来改进对单个组的估计。这个练习通过一个临床试验的场景，直观地展示了这一概念。我们将为一个新患者的真实疗效（对数生长率 $k_i$）建立一个经验贝叶斯估计，通过这个过程，你将看到个体测量值是如何被“收缩”（shrink）到总体平均值，从而得到一个更稳健的估计 [@problem_id:1920805]。", "problem": "在一项新的癌症疗法的临床试验中，研究人员为每位患者的治疗反应建模。该反应由患者特定的真实对数增长率来表征，对于患者 $i$ 记为 $k_i$，其中负值表示肿瘤缩小。真实增长率 $k_i$ 不能直接观测。取而代之的是，为每位患者测量一个带噪声的对数增长率 $d_i$。\n\n研究人员采用分层贝叶斯模型来综合所有患者的信息。该模型结构如下：\n\n1.  **观测模型**：对于患者 $i$，测得的对数增长率 $d_i$ 被假定为围绕真实增长率 $k_i$ 正态分布，其方差 $s^2$ 已知且恒定，代表测量误差。\n    $$d_i | k_i, s^2 \\sim \\mathcal{N}(k_i, s^2)$$\n\n2.  **总体模型**：患者特定的真实增长率 $k_i$ 被假定为从一个共同的总体分布中抽取，该分布为正态分布，其均值 $\\mu$ 和方差 $\\tau^2$ 未知。此分布代表了该疗法的整体疗效和患者间的变异性。\n    $$k_i | \\mu, \\tau^2 \\sim \\mathcal{N}(\\mu, \\tau^2)$$\n\n一项初步研究提供了来自 $N$ 位患者的数据，得到了测量的对数增长率 $\\{d_1, d_2, \\ldots, d_N\\}$。总体超参数 $\\mu$ 和 $\\tau^2$ 使用矩估计法从这些数据中估计，得到“代入”估计量 $\\hat{\\mu}$ 和 $\\hat{\\tau}^2$。这些估计量计算如下：\n-   $\\hat{\\mu} = \\bar{d}$，其中 $\\bar{d} = \\frac{1}{N} \\sum_{i=1}^{N} d_i$。\n-   $\\hat{\\tau}^2 = S_d^2 - s^2$，其中 $S_d^2 = \\frac{1}{N-1} \\sum_{i=1}^{N} (d_i - \\bar{d})^2$ 是测量值的样本方差。您可以假设研究数据满足 $S_d^2 > s^2$，从而确保 $\\hat{\\tau}^2 > 0$。\n\n现在，一位新的患者（索引为 $N+1$）进入试验，观测到其测量的对数增长率为 $d_{N+1}$。使用先前估计的超参数，我们希望找到这位新患者*真实*对数增长率 $k_{N+1}$ 的最佳估计。\n\n您的任务是推导 $k_{N+1}$ 的经验贝叶斯估计的表达式，该估计定义为其后验均值 $E[k_{N+1} | d_{N+1}, \\hat{\\mu}, \\hat{\\tau}^2]$。请用 $\\bar{d}$、 $S_d^2$、 $s^2$ 和 $d_{N+1}$ 来表示您的最终答案。", "solution": "我们从分层模型开始：对于一位新患者，\n$$d_{N+1} \\mid k_{N+1}, s^{2} \\sim \\mathcal{N}(k_{N+1}, s^{2}), \\quad k_{N+1} \\mid \\mu, \\tau^{2} \\sim \\mathcal{N}(\\mu, \\tau^{2}).$$\n使用贝叶斯定理处理共轭正态-正态对，在给定 $\\mu$、$\\tau^{2}$、 $s^{2}$ 和 $d_{N+1}$ 的条件下，$k_{N+1}$ 的后验分布是正态分布，其精度等于先验精度与似然精度之和。对指数部分进行配方，\n$$\\ln p(k_{N+1} \\mid d_{N+1}, \\mu, \\tau^{2}, s^{2})=\\text{const}-\\frac{1}{2s^{2}}(d_{N+1}-k_{N+1})^{2}-\\frac{1}{2\\tau^{2}}(k_{N+1}-\\mu)^{2},$$\n该式是关于 $k_{N+1}$ 的二次函数，其中 $k_{N+1}^{2}$ 的系数等于 $\\frac{1}{s^{2}}+\\frac{1}{\\tau^{2}}$，一次项的系数等于 $\\frac{d_{N+1}}{s^{2}}+\\frac{\\mu}{\\tau^{2}}$。因此，后验均值为\n$$E[k_{N+1} \\mid d_{N+1}, \\mu, \\tau^{2}]=\\frac{\\frac{d_{N+1}}{s^{2}}+\\frac{\\mu}{\\tau^{2}}}{\\frac{1}{s^{2}}+\\frac{1}{\\tau^{2}}}=\\frac{\\tau^{2} d_{N+1}+s^{2}\\mu}{\\tau^{2}+s^{2}}.$$\n在经验贝叶斯方法中，我们代入矩估计法得到的估计量 $\\hat{\\mu}=\\bar{d}$ 和 $\\hat{\\tau}^{2}=S_{d}^{2}-s^{2}$，得到\n$$E[k_{N+1} \\mid d_{N+1}, \\hat{\\mu}, \\hat{\\tau}^{2}]=\\frac{(S_{d}^{2}-s^{2})\\, d_{N+1}+s^{2}\\,\\bar{d}}{(S_{d}^{2}-s^{2})+s^{2}}=\\frac{(S_{d}^{2}-s^{2})\\, d_{N+1}+s^{2}\\,\\bar{d}}{S_{d}^{2}}.$$\n等价地，这可以写成一个收缩估计量\n$$\\left(1-\\frac{s^{2}}{S_{d}^{2}}\\right)d_{N+1}+\\frac{s^{2}}{S_{d}^{2}}\\bar{d},$$\n该形式明确地显示了施加于 $d_{N+1}$、使其向总体均值 $\\bar{d}$ 收缩的数据驱动权重 $1-\\frac{s^{2}}{S_{d}^{2}}$。", "answer": "$$\\boxed{\\frac{(S_{d}^{2}-s^{2})\\, d_{N+1}+s^{2}\\,\\bar{d}}{S_{d}^{2}}}$$", "id": "1920805"}, {"introduction": "分层模型不仅能处理均值参数，也能有效地为方差等其他参数建模。本练习设定了一个多实验室合作测量物理常数的场景。我们将使用一个正态-逆伽马（Normal-Inverse-Gamma）共轭模型来估计某个特定实验室的测量方差 $\\sigma_K^2$，这个方差本身被假定为从一个描述所有实验室普遍水平的超先验分布中抽取 [@problem_id:1920769]。这个实践将帮助你理解如何将分层思想应用于估计不确定性，而不仅仅是中心趋势。", "problem": "一个研究联盟正在协调多个大学实验室的实验，以测量一个新发现粒子的基本物理常数——衰变率 $\\lambda$。通过一个在国家实验室进行的高精度实验，已知该常数的真值为 $\\lambda_{\\text{true}} = 5.20$ s$^{-1}$。来自大学实验室的测量值会受到随机误差的影响。\n\n提出了一个分层贝叶斯模型来分析这些数据。来自任何一个给定实验室的测量值 $x_i$ 被建模为从一个正态分布 $N(\\lambda_{\\text{true}}, \\sigma^2)$ 中抽取的样本，其中特定于实验室的方差 $\\sigma^2$ 是未知的。根据以往对此类实验的经验，不同实验室的方差 $\\sigma^2$ 本身也被建模为从一个共同的逆伽马分布 $IG(\\alpha, \\beta)$ 中抽取的随机变量。一个 $IG(a, b)$ 分布的概率密度函数 (PDF) 由 $p(y; a, b) = \\frac{b^a}{\\Gamma(a)} y^{-(a+1)} \\exp(-\\frac{b}{y})$ 给出，其中 $y > 0$。对于此研究联盟，超参数被设定为 $\\alpha = 3$ 和 $\\beta = 0.500$ s$^{-2}$。\n\n一个特定的实验室 'Lab K' 进行了一项实验，获得了以下五个关于衰变率的测量值 ($n_K=5$)（单位为 s$^{-1}$）：\n$$ \\{5.35, 4.90, 5.70, 5.05, 5.50\\} $$\n\n在给定 Lab K 的实验数据的情况下，计算其测量方差 $\\sigma_K^2$ 的后验期望值。结果以 s$^{-2}$ 为单位表示，并四舍五入到三位有效数字。", "solution": "我们将 Lab K 的五个测量值 $x_{1:n}$ 建模为 $x_{i} \\mid \\sigma^{2} \\sim N(\\lambda_{\\text{true}}, \\sigma^{2})$，其中 $\\lambda_{\\text{true}}$ 已知，先验为 $\\sigma^{2} \\sim IG(\\alpha, \\beta)$，其密度为 $p(y;\\alpha,\\beta)=\\frac{\\beta^{\\alpha}}{\\Gamma(\\alpha)}y^{-(\\alpha+1)}\\exp\\!\\left(-\\frac{\\beta}{y}\\right)$ (对于 $y>0$) 。对于均值已知的 $n$ 个观测值，其似然函数正比于\n$$\nL(\\sigma^{2}\\mid x_{1:n}) \\propto (\\sigma^{2})^{-n/2}\\exp\\!\\left(-\\frac{S}{2\\sigma^{2}}\\right),\n$$\n其中 $S=\\sum_{i=1}^{n}(x_{i}-\\lambda_{\\text{true}})^{2}$。与先验结合后，得到共轭后验分布\n$$\n\\sigma^{2}\\mid x_{1:n} \\sim IG\\!\\left(\\alpha+\\frac{n}{2},\\,\\beta+\\frac{S}{2}\\right).\n$$\n在此参数化下，对于 $IG(a,b)$ 分布，当 $a>1$ 时其均值存在，且等于 $\\mathbb{E}[Y]=\\frac{b}{a-1}$。因此，\n$$\n\\mathbb{E}[\\sigma^{2}\\mid x_{1:n}] \\;=\\; \\frac{\\beta+\\frac{S}{2}}{\\alpha+\\frac{n}{2}-1}.\n$$\n\n对于 Lab K，我们有 $\\lambda_{\\text{true}}=5.20$，$x_{1:5}=\\{5.35,\\,4.90,\\,5.70,\\,5.05,\\,5.50\\}$，$\\alpha=3$ 以及 $\\beta=0.500$。计算相对于 $\\lambda_{\\text{true}}$ 的残差：\n$$\n\\{0.15,\\,-0.30,\\,0.50,\\,-0.15,\\,0.30\\},\n$$\n所以\n$$\nS=\\sum (x_{i}-\\lambda_{\\text{true}})^{2}=0.15^{2}+(-0.30)^{2}+0.50^{2}+(-0.15)^{2}+0.30^{2}=0.475.\n$$\n因此，后验参数为\n$$\n\\alpha^{\\prime}=\\alpha+\\frac{n}{2}=3+\\frac{5}{2}=5.5,\\qquad\n\\beta^{\\prime}=\\beta+\\frac{S}{2}=0.500+\\frac{0.475}{2}=0.7375.\n$$\n$\\sigma^{2}$ 的后验均值为\n$$\n\\mathbb{E}[\\sigma^{2}\\mid x_{1:5}]=\\frac{\\beta^{\\prime}}{\\alpha^{\\prime}-1}=\\frac{0.7375}{5.5-1}=\\frac{0.7375}{4.5}=\\frac{59}{360}\\approx 0.163888\\ldots\n$$\n四舍五入到三位有效数字，结果为 $0.164$ s$^{-2}$。", "answer": "$$\\boxed{0.164}$$", "id": "1920769"}, {"introduction": "分层贝叶斯模型最强大的应用之一是进行模型选择，即比较关于数据生成过程的不同假设。这个高级练习将我们带入市场分析领域，使用狄利克雷-多项式模型（Dirichlet-Multinomial）来分析不同城市的消费者偏好。你的任务是推导一个后验概率，以判断整个市场是“同质的”（由参数 $\\alpha_{hom}$ 决定）还是“异质的”（由参数 $\\alpha_{het}$ 决定），这展示了分层建模如何超越参数估计，帮助我们回答关于数据结构本身的更深层次问题 [@problem_id:1920764]。", "problem": "一家市场分析公司正在研究三个相互竞争的产品品牌（品牌A、品牌B、品牌C）在两个不同的大城市（城市1和城市2）的消费者购买行为。该公司采用层次贝叶斯模型来分析数据，该模型既考虑了特定于城市的偏好，也考虑了共享的市场特征。\n\n该模型规定如下：\n- 对于每个城市 $j \\in \\{1, 2\\}$，对 $N_j$ 名消费者进行调查，偏好每个品牌的消费者数量记录为向量 $\\mathbf{x}_j = (x_{jA}, x_{jB}, x_{jC})$，其中 $N_j = x_{jA} + x_{jB} + x_{jC}$。假设每个城市计数的数据生成过程是在给定特定于城市的市场份额向量 $\\boldsymbol{\\theta}_j = (\\theta_{jA}, \\theta_{jB}, \\theta_{jC})$ 的条件下服从多项分布。\n\n- 市场份额向量 $\\boldsymbol{\\theta}_j$ 本身被假定是从一个共同的狄利克雷先验分布中抽取的，即 $\\boldsymbol{\\theta}_j \\sim \\text{Dirichlet}(\\alpha \\mathbf{p})$。基础测度 $\\mathbf{p} = (p_A, p_B, p_C)$ 被固定为代表对全国市场份额的均匀先验信念，因此 $\\mathbf{p} = (1/3, 1/3, 1/3)$。\n\n- 标量集中度参数 $\\alpha > 0$ 决定了城市之间的相似程度。大的 $\\alpha$ 表明两个城市的市场份额都非常接近全国平均水平 $\\mathbf{p}$，表示一个“同质”市场。小的 $\\alpha$ 允许城市之间有更大的差异，表示一个“异质”市场。\n\n该公司正在考虑关于市场结构的两种假设，这两种假设由 $\\alpha$ 的值区分：\n1.  同质市场 ($H_{hom}$): 集中度参数为 $\\alpha = \\alpha_{hom}$。\n2.  异质市场 ($H_{het}$): 集中度参数为 $\\alpha = \\alpha_{het}$。\n\n公司的初始信念是市场为同质的概率为 $\\pi_0$，因此 $P(H_{hom}) = \\pi_0$。\n\n给定从两个城市观测到的消费者计数 $\\mathbf{x}_1 = (x_{1A}, x_{1B}, x_{1C})$ 和 $\\mathbf{x}_2 = (x_{2A}, x_{2B}, x_{2C})$，推导同质市场假设的后验概率 $P(H_{hom} | \\mathbf{x}_1, \\mathbf{x}_2)$ 的闭式解析表达式。你的最终表达式应使用 $\\pi_0, \\alpha_{hom}, \\alpha_{het}, \\mathbf{x}_1, \\mathbf{x}_2, N_1,$ 和 $N_2$ 表示。", "solution": "我们被要求在一个层次贝叶斯模型下计算同质市场假设的后验概率，该模型包含两个相互竞争的假设，它们仅在狄利克雷集中度参数的固定值上有所不同。数据由各城市的品牌计数 $\\mathbf{x}_{j}=(x_{jA},x_{jB},x_{jC})$ 组成，其中 $j \\in \\{1,2\\}$ 且 $N_{j}=\\sum_{c \\in \\{A,B,C\\}} x_{jc}$。每个城市的似然函数是在给定特定于城市的市场份额向量 $\\boldsymbol{\\theta}_{j}$ 的条件下的多项分布，而 $\\boldsymbol{\\theta}_{j}$ 的先验是参数为 $\\alpha \\mathbf{p}$ 的狄利克雷分布，其中 $\\mathbf{p}=(1/3,1/3,1/3)$ 是固定的。\n\n我们首先计算在给定固定 $\\alpha$ 的情况下数据的边际似然。对于每个城市 $j$，条件模型是\n$$\n\\mathbf{x}_{j} \\mid \\boldsymbol{\\theta}_{j} \\sim \\text{Multinomial}\\left(N_{j},\\boldsymbol{\\theta}_{j}\\right), \\quad \\boldsymbol{\\theta}_{j} \\sim \\text{Dirichlet}\\left(\\alpha \\mathbf{p}\\right).\n$$\n对 $\\boldsymbol{\\theta}_{j}$ 进行积分，得到狄利克雷-多项边际似然：\n$$\nm(\\mathbf{x}_{j} \\mid \\alpha)=\\int \\left[\\frac{N_{j}!}{\\prod_{c \\in \\{A,B,C\\}} x_{jc}!} \\prod_{c \\in \\{A,B,C\\}} \\theta_{jc}^{x_{jc}} \\right] \\cdot \\left[\\frac{1}{B(\\alpha \\mathbf{p})} \\prod_{c \\in \\{A,B,C\\}} \\theta_{jc}^{\\alpha p_{c}-1} \\right] d\\boldsymbol{\\theta}_{j}.\n$$\n使用多元贝塔函数 $B(\\mathbf{a})=\\frac{\\prod_{c} \\Gamma(a_{c})}{\\Gamma(\\sum_{c} a_{c})}$ 的恒等式以及狄利克雷先验与多项分布的共轭性，我们有\n$$\nm(\\mathbf{x}_{j} \\mid \\alpha)=\\frac{N_{j}!}{\\prod_{c \\in \\{A,B,C\\}} x_{jc}!} \\cdot \\frac{B(\\alpha \\mathbf{p}+\\mathbf{x}_{j})}{B(\\alpha \\mathbf{p})}.\n$$\n当 $\\mathbf{p}=(1/3,1/3,1/3)$ 时，对于每个 $c \\in \\{A,B,C\\}$ 我们有 $\\alpha p_{c}=\\alpha/3$ 并且 $\\sum_{c} \\alpha p_{c}=\\alpha$。因此，\n$$\n\\frac{B(\\alpha \\mathbf{p}+\\mathbf{x}_{j})}{B(\\alpha \\mathbf{p})}\n=\\frac{\\Gamma(\\alpha)}{\\Gamma(\\alpha+N_{j})}\\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha}{3}\\right)}.\n$$\n因此，城市 $j$ 的边际似然为\n$$\nm(\\mathbf{x}_{j} \\mid \\alpha)=\\frac{N_{j}!}{\\prod_{c \\in \\{A,B,C\\}} x_{jc}!} \\cdot \\frac{\\Gamma(\\alpha)}{\\Gamma(\\alpha+N_{j})}\\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha}{3}\\right)}.\n$$\n假设在给定 $\\alpha$ 的条件下各城市之间相互独立，所有数据的边际似然是各城市边际似然的乘积：\n$$\nm(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha)=\\prod_{j=1}^{2} \\left[ \\frac{N_{j}!}{\\prod_{c \\in \\{A,B,C\\}} x_{jc}!} \\cdot \\frac{\\Gamma(\\alpha)}{\\Gamma(\\alpha+N_{j})}\\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha}{3}\\right)} \\right].\n$$\n我们现在在 $H_{hom}$ 和 $H_{het}$ 之间进行贝叶斯模型选择，它们分别指定了 $\\alpha=\\alpha_{hom}$ 和 $\\alpha=\\alpha_{het}$。根据用于假设检验的贝叶斯法则，在先验 $P(H_{hom})=\\pi_{0}$ 和 $P(H_{het})=1-\\pi_{0}$ 的情况下，$H_{hom}$ 的后验概率为\n$$\nP(H_{hom} \\mid \\mathbf{x}_{1},\\mathbf{x}_{2})=\\frac{\\pi_{0}\\, m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{hom})}{\\pi_{0}\\, m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{hom})+(1-\\pi_{0})\\, m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{het})}.\n$$\n等价地，使用贝叶斯因子表示法，这可以写作\n$$\nP(H_{hom} \\mid \\mathbf{x}_{1},\\mathbf{x}_{2})=\\left[1+\\frac{1-\\pi_{0}}{\\pi_{0}} \\cdot \\frac{m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{het})}{m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{hom})}\\right]^{-1}.\n$$\n代入乘积形式的边际似然，并通过消去多项式系数进行简化，我们得到\n$$\n\\frac{m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{het})}{m(\\mathbf{x}_{1},\\mathbf{x}_{2} \\mid \\alpha_{hom})}\n=\\prod_{j=1}^{2} \\left[ \\frac{\\Gamma(\\alpha_{het})}{\\Gamma(\\alpha_{hom})} \\cdot \\frac{\\Gamma(\\alpha_{hom}+N_{j})}{\\Gamma(\\alpha_{het}+N_{j})} \\cdot \\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}+x_{jc}\\right)} \\cdot \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}\\right)} \\right].\n$$\n因此，同质市场假设的后验概率的闭式解析表达式为\n$$\nP(H_{hom} \\mid \\mathbf{x}_{1},\\mathbf{x}_{2})=\\left[1+\\frac{1-\\pi_{0}}{\\pi_{0}} \\prod_{j=1}^{2} \\left\\{ \\frac{\\Gamma(\\alpha_{het})}{\\Gamma(\\alpha_{hom})} \\cdot \\frac{\\Gamma(\\alpha_{hom}+N_{j})}{\\Gamma(\\alpha_{het}+N_{j})} \\cdot \\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}+x_{jc}\\right)} \\cdot \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}\\right)} \\right\\} \\right]^{-1}.\n$$\n该表达式用 $\\pi_{0}$、$\\alpha_{hom}$、$\\alpha_{het}$、$\\mathbf{x}_{1}$、$\\mathbf{x}_{2}$、$N_{1}$ 和 $N_{2}$ 表示，符合要求。", "answer": "$$\\boxed{\\left[1+\\frac{1-\\pi_{0}}{\\pi_{0}} \\prod_{j=1}^{2} \\left\\{ \\frac{\\Gamma(\\alpha_{het})}{\\Gamma(\\alpha_{hom})} \\cdot \\frac{\\Gamma(\\alpha_{hom}+N_{j})}{\\Gamma(\\alpha_{het}+N_{j})} \\cdot \\prod_{c \\in \\{A,B,C\\}} \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}+x_{jc}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}+x_{jc}\\right)} \\cdot \\frac{\\Gamma\\!\\left(\\frac{\\alpha_{hom}}{3}\\right)}{\\Gamma\\!\\left(\\frac{\\alpha_{het}}{3}\\right)} \\right\\} \\right]^{-1}}$$", "id": "1920764"}]}