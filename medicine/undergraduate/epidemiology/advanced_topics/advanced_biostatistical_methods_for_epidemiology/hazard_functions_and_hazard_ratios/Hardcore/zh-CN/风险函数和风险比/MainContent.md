## 引言
在流行病学和临床研究中，我们不仅关心事件（如疾病发生或死亡）是否发生，更关心它在何时发生。时间至事件分析（或称生存分析）为此[类数](@entry_id:156164)据提供了强大的分析框架。在这一框架中，[风险函数](@entry_id:166593)（Hazard Function）与风险比（Hazard Ratio, HR）是两个居于核心地位的度量指标，它们是量化和比较不同人群瞬时风险的关键。然而，对这些指标的理解往往停留在表面，其背后深刻的统计原理、复杂的模型假设以及解释上的诸多陷阱，常常被忽视。本文旨在填补这一知识鸿沟，引领读者从基本原理深入到高级应用。

本文将分为三个部分，系统性地构建您对[风险函数](@entry_id:166593)与风险比的全面认识。在“原理与机制”一章中，我们将从第一性原理出发，剖析[风险函数](@entry_id:166593)的数学定义，探讨其与生存函数的关系，并阐明[Cox比例风险模型](@entry_id:174252)如何巧妙地[估计风险](@entry_id:139340)比。我们还将直面其核心假定——[比例风险](@entry_id:166780)假定，以及当该假定被违背后所带来的挑战。随后，在“应用与跨学科联系”一章中，我们将展示这些理论工具如何在临床医学、预后评估、[观察性研究](@entry_id:174507)偏倚处理以及与因果推断、机器学习等前沿领域的交叉中发挥关键作用。最后，通过“动手实践”中的具体问题，您将有机会亲自应用所学知识，解决模拟的真实研究场景。

现在，让我们首先进入第一章，深入探索[风险函数](@entry_id:166593)与风险比的“原理与机制”。

## 原理与机制

在流行病学研究中，我们不仅关心事件（如疾病发作或死亡）是否发生，还同样关心它何时发生。生存分析，或称时间至事件分析，提供了一套强大的工具来研究这[类数](@entry_id:156164)据。继前一章对基本概念的介绍之后，本章将深入探讨生存分析的两个核心概念——**风险函数 (hazard function)** 与 **风险比 (hazard ratio)**——的原理与机制。我们将从它们的基本定义出发，探讨其估计方法，并最终剖析在解释这些指标时所面临的复杂挑战。

### 风险函数：量化瞬时风险

在随访研究中，我们常常希望量化一个个体在特定时间点发生事件的“瞬时风险”。例如，在一个队列研究中，一个活到 $t$ 时刻的个体，在紧接着的下一个瞬间发生事件的概率有多大？这个概念正是由**风险函数**（或称**危险率函数**），记为 $h(t)$，来捕捉的。

从数学上讲，[风险函数](@entry_id:166593)被严谨地定义为，在时间 $T$ 大于等于 $t$ 的条件下，事件发生在时间区间 $[t, t+\Delta t)$ 内的[条件概率](@entry_id:151013)与该区间长度 $\Delta t$ 之比，在 $\Delta t$ 趋向于零时的极限 。如果用 $T$ 表示事件时间这个随机变量，那么：

$$
h(t) = \lim_{\Delta t \to 0} \frac{\mathbb{P}(t \le T  t+\Delta t \mid T \ge t)}{\Delta t}
$$

这个定义至关重要。它明确指出，风险函数是一个**瞬时事件率**，其评估对象是那些**直到 $t$ 时刻仍然“在风险中”（即尚未经历事件）**的个体。因此，$h(t)$ 的单位是时间的倒数（例如，事件数/人-年）。一个常见的误解是将其与概率混淆，但[风险函数](@entry_id:166593)本身不是概率，它可以取大于1的值。例如，在一个关于不良事件 (adverse event) 的临床试验中，如果某个时间点的[风险率](@entry_id:266388)近似为每天 $0.004$，这意味着在那个时间点仍然未发生事件的个体，在接下来的一天内发生事件的近似概率为 $0.004$ 。

[风险函数](@entry_id:166593)与生存分析中的另外两个关键函数——**生存函数 (survival function)** $S(t)$ 和**[概率密度函数](@entry_id:140610) (probability density function)** $f(t)$——有着密不可分的关系。

生存函数 $S(t) = \mathbb{P}(T  t)$ 描述了个体生存超过时间 $t$ 的概率。概率密度函数 $f(t)$ 则是事件时间 $T$ 的概率分布，对于连续变量，$f(t) = -\frac{d}{dt} S(t)$。

基于风险[函数的极限](@entry_id:158708)定义，我们可以推导出它与 $f(t)$ 和 $S(t)$ 的关系 ：

$$
h(t) = \frac{f(t)}{S(t)}
$$

这个关系式直观地表明，瞬时风险率是事件在该时刻发生的[概率密度](@entry_id:143866)与生存到该时刻的概率之比。将 $f(t) = -S'(t)$ 代入，我们得到 $h(t) = -S'(t)/S(t) = -\frac{d}{dt}\ln(S(t))$。通过对这个表达式从 $0$ 到 $t$ 积分，我们可以反过来从风险函数得到生存函数：

$$
S(t) = \exp\left(-\int_0^t h(u)du\right)
$$

这个积分 $\int_0^t h(u)du$ 被称为**[累积风险函数](@entry_id:169734) (cumulative hazard function)**，记为 $H(t)$。

为了具体理解这些函数之间的联系，假设在一个队列研究中，未暴露组的[风险函数](@entry_id:166593)服从一个**[Weibull分布](@entry_id:270143)**的特例，其形式为 $h_U(t) = \lambda t$，其中 $\lambda = 4.0 \times 10^{-3}$ 月$^{-2}$ 。我们可以据此推导该组的生存函数和[概率密度函数](@entry_id:140610)。首先，计算[累积风险函数](@entry_id:169734)：

$H_U(t) = \int_0^t \lambda u \, du = \frac{\lambda t^2}{2}$

于是，生存函数为：

$S_U(t) = \exp\left(-\frac{\lambda t^2}{2}\right)$

[概率密度函数](@entry_id:140610)则为：

$f_U(t) = h_U(t)S_U(t) = (\lambda t) \exp\left(-\frac{\lambda t^2}{2}\right)$

这个例子清晰地展示了，一旦风险函数的形式被确定，整个生存过程的概率特征也就随之确定。

### 风险比：比较不同组的风险

在流行病学中，我们很少关心单一群体的绝对风险，而更关心暴露组与非暴露组之间风险的相对大小。**风险比 (Hazard Ratio, HR)** 正是为此而生的核心效应度量。它被定义为两个组（例如，暴露组 $E$ 和非暴露组 $U$）在同一时间点 $t$ 的[风险函数](@entry_id:166593)之比 ：

$$
HR(t) = \frac{h_E(t)}{h_U(t)}
$$

$HR(t)$ 的解释必须精确：如果 $HR(t) = 2$，这意味着在时间点 $t$，**在那些尚未经历事件的个体中**，暴露组发生事件的**[瞬时速率](@entry_id:182981)**是未暴露组的两倍 。

值得强调的是，风险比(HR)在概念上不同于我们熟悉的**风险比 (Risk Ratio, RR)** 或**比值比 (Odds Ratio, OR)**。RR是特定时间段内累积发生率（风险）的比值，而OR是该时间段内事件发生几率的比值。HR则是一个[瞬时速率](@entry_id:182981)的比值。

在一般情况下，这三个指标并不相等。考虑一个随机临床试验，比较新疗法与标准疗法。假设事件时间服从[指数分布](@entry_id:273894)（即[风险函数](@entry_id:166593)为常数），[对照组](@entry_id:188599)风险 $\lambda_C = 0.4$/年，治疗组风险 $\lambda_T = 0.2$/年。那么，风险比恒为 $HR = \lambda_T / \lambda_C = 0.5$ 。然而，在1年终点时，[对照组](@entry_id:188599)的累积发生率（风险）为 $R_C = 1 - e^{-0.4 \times 1} \approx 0.3297$，治疗组为 $R_T = 1 - e^{-0.2 \times 1} \approx 0.1813$。

-   **风险比 (RR)** at 1 year: $\frac{R_T}{R_C} \approx \frac{0.1813}{0.3297} \approx 0.550$
-   **比值比 (OR)** at 1 year: $\frac{R_T/(1-R_T)}{R_C/(1-R_C)} \approx \frac{0.1813/0.8187}{0.3297/0.6703} \approx 0.450$

我们看到 $HR=0.5$, $RR \approx 0.55$, $OR \approx 0.45$。这三个值各不相同。RR的值比HR更接近1，这种现象被称为效应值的“衰减”或“趋向于无效值”。只有在“**稀有事件假定 (rare event assumption)**”下，即当事件在整个研究期间发生得很少时（$R(t)$ 很小），$RR$ 和 $OR$ 才会近似等于 $HR$ 。

### [比例风险](@entry_id:166780)假定及其违背

风险比的一个关键特性是它可能是时间依赖的，即 $HR(t)$。然而，许多生存分析方法，尤其是广受欢迎的**[Cox比例风险模型](@entry_id:174252)**，都基于一个核心假定——**比例风险 (Proportional Hazards, PH) 假定**。该假定认为风险比在整个随访期间是一个常数，即 $HR(t) = HR$。这意味着暴露组的[风险函数](@entry_id:166593)在所有时间点都是非暴露组[风险函数](@entry_id:166593)的一个固定倍数。

[指数分布](@entry_id:273894)模型（恒定风险）天然满足PH假定 。然而，在现实世界中，PH假定常常被违背。

一个简单的例子是，某项干预措施的效应随时间变化。例如，一项RCT研究显示，在0-30天内，治疗组的每日条件事件概率为$0.002$，而安慰剂组为$0.004$，对应的 $HR \approx 0.5$。但在30-60天，两组的概率均变为$0.003$，对应的 $HR \approx 1.0$ 。由于HR从$0.5$变为$1.0$，PH假定在整个60天内不成立。

一个更复杂的例子涉及到**时间依赖性协变量 (time-dependent covariates)**。假设我们研究流感疫苗接种对住院风险的影响，个体可能在随访期间的任何时间点接种疫苗，且疫苗的保护效果可能随时间减弱 。例如，一个在第4个月接种疫苗的个体，其[风险函数](@entry_id:166593) $h_V(t)$ 在不同时间段相对于未接种者 $h_U(t)$ 可能是变化的：
- $t \in [0, 4)$ (接种前): $h_V(t) = h_U(t)$, $HR(t) = 1$
- $t \in [4, 10)$ (接种后0-6个月): $h_V(t) = 0.4 h_U(t)$, $HR(t) = 0.4$
- $t \in [10, 12]$ (接种后6个月): $h_V(t) = 0.8 h_U(t)$, $HR(t) = 0.8$

显然，HR是随时间变化的[阶梯函数](@entry_id:159192)，PH假定不成立。在这种情况下，计算该接种疫苗个体的12个月生存概率时，必须分段积分其随时间变化的风险函数：
$$
S_V(12) = \exp\left(-\int_{0}^{4} h_U(s)ds - \int_{4}^{10} 0.4 h_U(s)ds - \int_{10}^{12} 0.8 h_U(s)ds\right)
$$
这与在一个恒定HR下计算生存概率是截然不同的。

### 风险比的估计

在实际研究中，我们需要从数据中估计HR。主要有两种途径：参数模型和[半参数模型](@entry_id:200031)。

#### 参数方法
如果我们就风险函数的形式做出特定假设（如恒定风险），就可以使用**最大似然估计 (Maximum Likelihood Estimation, MLE)**。例如，在一个具有**左截断 (left truncation)** 和**右删失 (right censoring)** 的队列研究中，假设暴露组A和非暴露组B的风险恒定为 $\lambda_A$ 和 $\lambda_B$ 。

对于每个个体 $i$，其似然贡献为 $\lambda^{\delta_i} \exp(-\lambda t_{\text{risk},i})$，其中 $\delta_i$ 是事件指示符（事件=1，删失=0），$t_{\text{risk},i}$ 是个体在风险中的总时间。整个队列的总[似然函数](@entry_id:141927)可以被分解为两组似然的乘积。最大化[对数似然函数](@entry_id:168593)可得到每个组风险率的MLE：
$$
\hat{\lambda}_g = \frac{D_g}{T_g}
$$
其中 $D_g$ 是 $g$ 组的总事件数，$T_g$ 是 $g$ 组的总人-时数。这正是我们熟悉的**发生率密度 (incidence rate)**。根据MLE的不变性，HR的MLE就是两个发生率密度的比值：
$$
\hat{\theta} = \frac{\hat{\lambda}_A}{\hat{\lambda}_B} = \frac{D_A / T_A}{D_B / T_B}
$$

#### 半参数方法：Cox模型
在多数情况下，我们不想对基线风险函数 $\lambda_0(t)$ 的形式做出过强的假设。**[Cox比例风险模型](@entry_id:174252)**正是为此而设计的强大工具 。该模型假设：
$$
\lambda(t \mid X) = \lambda_0(t) \exp(\beta X)
$$
其中 $X$ 是协变量（如暴露状态，X=1为暴露，X=0为非暴露），$\beta$ 是对数风险比，$\lambda_0(t)$ 是未指定的**基线[风险函数](@entry_id:166593)**。$\exp(\beta)$ 就是我们感兴趣的、假定为常数的HR。

[Cox模型](@entry_id:164053)的巧妙之处在于它使用**[偏似然](@entry_id:165240) (partial likelihood)** 来估计 $\beta$，而无需估计 $\lambda_0(t)$。[偏似然](@entry_id:165240)的思想是，在每个事件发生的时间点，我们只考虑“是哪个特定[个体发生](@entry_id:164036)了事件，而不是其他在风险集中的个体”的条件概率。

在第 $k$ 个事件发生的时间 $t_{(k)}$，假设个体 $j_k$ 发生了事件，当时的风险集为 $R_k$（所有在 $t_{(k)}$ 之前存活且未删失的个体）。那么，该事件对[偏似然](@entry_id:165240)的贡献是：
$$
L_k(\beta) = \frac{\text{个体 } j_k \text{ 的风险}}{\text{风险集 } R_k \text{ 中所有个体的风险之和}} = \frac{\lambda(t_{(k)} \mid X_{j_k})}{\sum_{i \in R_k} \lambda(t_{(k)} \mid X_i)} = \frac{\lambda_0(t_{(k)}) \exp(\beta X_{j_k})}{\sum_{i \in R_k} \lambda_0(t_{(k)}) \exp(\beta X_i)} = \frac{\exp(\beta X_{j_k})}{\sum_{i \in R_k} \exp(\beta X_i)}
$$
基线风险 $\lambda_0(t_{(k)})$ 被约掉了。总的[偏似然](@entry_id:165240)是所有事件时间点贡献的乘积 $L(\beta) = \prod_k L_k(\beta)$。通过最大化这个偏[似然函数](@entry_id:141927) (partial likelihood function)，我们就能得到 $\beta$ 的估计值 $\hat{\beta}$。

例如，在一个小型数据集中，假设有3个事件，风险集在每个事件时间点都恰好包含4名暴露者($X=1$)和6名非暴露者($X=0$)。前两个事件发生在暴露者身上，第三个事件发生在非暴露者身上 。偏似然函数为：
$$
L(\beta) = \frac{\exp(\beta)}{4\exp(\beta)+6} \times \frac{\exp(\beta)}{4\exp(\beta)+6} \times \frac{\exp(0)}{4\exp(\beta)+6} = \frac{\exp(2\beta)}{(4\exp(\beta)+6)^3}
$$
通过最大化其对数形式，我们可以解出 $\exp(\hat{\beta})=3$，即 $\hat{\beta} = \ln(3)$。

### 高级主题与解释挑战

尽管HR应用广泛，但对其进行恰当的因果解释却充满挑战。这主要源于两个高级主题：非可折叠性和[竞争风险](@entry_id:173277)。

#### 非可折叠性与因果解释

HR是一个**非可折叠 (non-collapsible)** 的度量。这意味着，即使在一个不存在混杂的随机试验中，根据某个预后因素分层的条件HR（conditional HR）是一个常数，合并数据后得到的边际HR（marginal HR）也通常不等于这个条件HR，并且会随时间变化  。

想象一个RCT，干预措施在一个未被观察到的预后因素（如“高脆弱性”和“低脆弱性”亚组）的每个层内都具有恒定的HR=0.5。由于随机化，干预组和[对照组](@entry_id:188599)在基线时具有相同的亚组构成。然而，随着时间推移，风险更高的高脆弱性个体在两个组中都会更快地经历事件并退出风险集。由于[对照组](@entry_id:188599)的总体风险更高，其高脆弱性亚组的耗竭速度会比干预组更快。这导致两组幸存者（即风险集）的构成随时间发生差异性变化：[对照组](@entry_id:188599)的风险集中，“健壮”的低脆弱性个体比例会越来越高。

这种由“幸存者偏倚”(survivor bias)引起的风险集构成的动态变化，导致边际风险比不再恒定，并且会偏离真实的条件风险比。例如，在  的设定下，尽管条件HR恒为0.5，但计算出的边际HR在 t=10 时约为0.62。

这一现象是HR固有的数学特性，而非传统意义上的**混杂 (confounding)** 。它的关键因果推断启示是：H[R比](@entry_id:161177)较的是不同组中**幸存者**的瞬时风险。而“幸存到t时刻”本身是一个受干预影响的结果。对一个受干预影响的中间变量进行条件化，会使因果解释变得复杂。因此，即使是从Cox模型中得到的HR，也必须谨慎解释其为群体的“平均因果效应” 。

#### 竞争风险

在许多研究中，个体可能经历多种类型的事件，而我们只对其中一种感兴趣。如果其他事件（称为**[竞争风险](@entry_id:173277) (competing risks)**）的发生会阻止我们观察到主要事件，那么标准的生存分析方法（如[Kaplan-Meier](@entry_id:169317)法或将竞争事件视为删失的[Cox模型](@entry_id:164053)）可能会产生误导性结果 。

在竞争风险框架下，我们需要区分两种风险度量：
1.  **特定原因风险 (Cause-Specific Hazard, CSH)**, $h_k(t)$: 这是在 $t$ 时刻，在所有仍在风险中的个体中，发生 $k$ 类事件的[瞬时速率](@entry_id:182981)。
2.  **子分布风险 (Subdistribution Hazard, SDH)**, $\lambda_k(t)$: 这是在 $t$ 时刻，在那些尚未经历 $k$ 类事件的个体（包括存活者和已经历竞争事件者）中，发生 $k$ 类事件的[瞬时速率](@entry_id:182981)。

CSH和SDH的风险集定义不同，这导致它们衡量的是不同的东西。CSH关注事件的“病因学”机制，而SDH关注事件的“预后”或累积概率。

一个重要的结论是，一个因素对竞争事件风险的影响会“溢出”到主要事件的累积概率上。考虑一个例子，暴露组和非暴露组的主要事件CSH完全相同（CSHR=1）。但暴露组的竞争事件CSH更高。这意味着暴露组的个体更容易因竞争事件而脱离风险池，从而“没有机会”经历主要事件。结果是，暴露组的主要事件**累积发生函数 (Cumulative Incidence Function, CIF)** 会低于非暴露组。相应地，其SDH也会更低（SDHR  1） 。

这说明，即使某暴露因素不影响主要事件的瞬时生物学风险（CSH不变），但只要它影响了竞争事件的风险，它就会改变主要事件的长期累积发生概率和SDH 。因此，在存在竞争风险时，研究者必须明确他们是想估计对CSH的效应（如通过对CSH建模的[Cox模型](@entry_id:164053)）还是对SDH的效应（如通过Fine-Gray模型），因为两者回答的是不同的科学问题。