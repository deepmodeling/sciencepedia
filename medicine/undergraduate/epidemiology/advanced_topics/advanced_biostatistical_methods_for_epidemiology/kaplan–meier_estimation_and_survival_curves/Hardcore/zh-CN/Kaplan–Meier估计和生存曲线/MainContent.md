## 引言
在流行病学、临床医学及众多科学领域，理解从某个起点到特定事件发生所经历的时间至关重要。这类“事件时间数据”的分析构成了生存分析的核心。然而，由于失访、研究结束等原因导致的数据不完整性，即“删失”和“截断”，使得传统的统计方法不再适用。这便引出了一个核心问题：我们如何才能在数据不完整的情况下，准确地估计和比较不同群体的生存状况？

本文旨在系统性地介绍Kaplan-Meier估计法，它是解决上述问题的基石性非参数工具。通过本文的学习，读者将能够掌握从原始数据到深刻洞见的全过程。文章分为三个核心部分：首先，在“原理与机制”一章中，我们将深入探讨生存数据的独特结构，阐明Kaplan-Meier乘积极限公式的数学基础，并解释如何构建和解读生存曲线。接着，“应用与跨学科联系”一章将展示该方法在临床试验、流行病学研究乃至社会科学中的广泛应用，并讨论如何处理混杂、偏倚以及非比例风险等现实世界中的复杂问题。最后，“动手实践”部分将提供一系列精心设计的练习，帮助读者将理论知识转化为解决实际问题的能力。

## 原理与机制

在流行病学和临床研究中，我们常常关心从某个明确定义的起点（如出生、诊断或接受治疗）到某个终点事件（如发病、复发或死亡）发生所经历的时间。这类数据被称为“[生存数据](@entry_id:165675)”或“事件时间数据”。本章将深入探讨估计和解释这[类数](@entry_id:156164)据的核心原理与机制，重点介绍[Kaplan-Meier](@entry_id:169317)估计法，这是生存分析领域基石性的非参数方法。

### [生存数据](@entry_id:165675)的基本构成：删失与截断

要准确分析事件时间数据，首先必须理解其独特的结构，这种结构源于观察过程中的不完整性。设 $T$ 为一个非负随机变量，代表我们感兴趣的真实事件时间。在理想情况下，我们可以对研究中的每个个体精确观察到其 $T$ 值。然而，在现实世界的随访研究中，由于各种原因，我们往往无法获得完整的事件时间信息，这便引出了**删失 (censoring)** 与 **截断 (truncation)** 的概念。

#### 数据删失的类型

删失指的是在研究期间，我们知道某个个体的事件时间落在某个时间区间内，但无法确定其精确值。删失是针对已纳入研究样本的个体而言的。主要有三种类型 ：

1.  **右删失 (Right Censoring)**：这是最常见的删失类型。当随访结束时，某个个体的终点事件仍未发生，我们只知道其真实的事件时间 $T$ 大于其最后一次被观察到的时间 $C$。即，我们只知道 $T > C$。典型例子包括：
    *   **管理性删失**：研究在预设的日期结束，此时仍有部分参与者未发生事件。例如，在一项为期24个月的肺结核发病队列研究中，某参与者在24个月随访结束时仍未发病，其数据在24个月时被右删失。
    *   **失访**：参与者因与研究结果无关的原因（如搬家）而中断联系。例如，一名参与者在第6个月的检查中状态良好，但此后失联，其数据在6个月时被右删失，我们只知道其事件时间（如果会发生的话）大于6个月。

2.  **[左删失](@entry_id:169731) (Left Censoring)**：当事件已知在某个观察时间点之前已经发生，但具体发生时间不详时，便产生[左删失](@entry_id:169731)。我们只知道 $T \le C$，其中 $C$ 是首次观察时间。例如，在一个从出生开始追踪水痘感染年龄的出生队列中，一个孩子在18个月大时首次就诊，血液检查显示其已具有水痘抗体（即已感染过）。我们无法确定其确切感染时间，只知道感染发生在从出生到18个月的区间 $(0, 18]$ 内。因此，其感染时间在18个月时被[左删失](@entry_id:169731)。

3.  **[区间删失](@entry_id:636589) (Interval Censoring)**：当事件已知发生于两次相邻的观察时间点之间时，即 $a  T \le b$，数据便被[区间删失](@entry_id:636589)。这在需要定期检测才能发现事件的研究中非常普遍。例如，在一项针对HIV的性传播感染研究中，参与者每季度接受检测。若一名参与者在第6个月检测为阴性，但在第12个月检测为阳性，则其血清转换（即感染事件）的发生时间被[区间删失](@entry_id:636589)在 $(6, 12]$ 月之间。

#### 截断：样本选择的视角

与删失不同，**截断 (truncation)** 是一种影响样本构成的现象，而非影响样本内个体观察完整性的现象。截断决定了哪些个体从一开始就有可能被纳入研究样本。

*   **左截断 (Left Truncation)**，也称为**延迟进入 (delayed entry)**，指的是个体只有在存活到某个特定时间 $L$ 之后，才有可能被观察到并纳入研究。在时间 $L$ 之前，该个体对于研究者是“不可见的”，即使其存在于目标人群中。一旦进入研究，他们就从 $L$ 时刻开始贡献风险信息。例如，一项研究从2020年1月1日开始招募已确诊某疾病超过2年的患者。那么，只有那些在2018年1月1日之前确诊且存活至2020年1月1日的患者才能进入研究。他们的事件时间（从确诊算起）就存在左截断，因为那些在确诊后2年内死亡的患者永远不会被纳入样本 。

*   **右截断 (Right Truncation)** 较为少见，通常发生在回顾性研究中。它指的是只有当个体的事件时间 $T$ 小于某个截断时间点 $R$ 时，该个体才会被纳入样本。例如，一个基于死亡登记处的研究，旨在分析某罕见病患者的生存情况。如果该登记处成立于2010年，研究者在2020年收集数据，那么只有在2010年至2020年间死亡的患者才会被记录和纳入。那些在2020年后死亡的患者（即 $T > R$）将完全从样本中缺失。

区分删失与截断至关重要。删失的个体在删失时间点之前为风险集的计算贡献了信息；而截断的个体在截断区间之外则完全不为风险集贡献任何信息，因为他们根本就不在研究样本中 。

### 乘积极限公式：逐步估计生存率

Kaplan-Meier (KM) 估计的核心目标是估计**生存函数 (survival function)**，$S(t)$。该函数定义为一个个体生存时间超过 $t$ 的概率，即 $S(t) = \mathbb{P}(T > t)$。KM方法是一种[非参数方法](@entry_id:138925)，它不预设生存时间服从任何特定的概率分布，而是直接从数据中估计生存曲线。

其基本思想来源于条件[概率的[链式法](@entry_id:268139)则](@entry_id:190743)。假设研究中所有事件都发生在离散的时间点 $t_{(1)}  t_{(2)}  \dots  t_{(m)}$。那么，生存到任意时间 $t$（其中 $t_{(k)} \le t  t_{(k+1)}$）的概率可以表示为一系列条件生存概率的乘积：
$S(t) = \mathbb{P}(T > t_{(k)}) = \mathbb{P}(T > t_{(1)}) \times \mathbb{P}(T > t_{(2)} | T > t_{(1)}) \times \dots \times \mathbb{P}(T > t_{(k)} | T > t_{(k-1)})$

由于在两个相邻事件时间点之间没有事件发生，生存函数 $S(t)$ 在这些区间内是恒定的，只在每个事件时间点 $t_{(j)}$ 发生阶梯状的下降。因此，KM曲线是一条右连续的[阶梯函数](@entry_id:159192)。

估计生存函数的任务就转化为在每个事件时间点 $t_{(j)}$ 估计条件生存概率 $\mathbb{P}(T > t_{(j)} | T \ge t_{(j)})$。为此，我们需要两个关键要素：

1.  **风险集 (Risk Set)**：在任意时间点 $t$，风险集 $R(t)$ 是指在该时刻之前**仍在研究中（即未被删失或发生事件）**且**有资格发生事件**的个体集合。在处理左[截断数据](@entry_id:163004)时，其定义尤为重要。一个体 $j$（其进入时间为 $L_j$，观测时间为 $X_j$）在事件时间 $t_{(i)}$ 属于风险集，当且仅当他们已进入研究（$L_j \le t_{(i)}$）并且到该时刻仍处于随访中（$X_j \ge t_{(i)}$） 。我们将风险集的大小记为 $n_j = |R(t_{(j)})|$。

2.  **事件数 (Number of Events)**：在事件时间点 $t_{(j)}$ 发生的事件数量，记为 $d_j$。如果事件时间有重复（tied event times），$d_j$ 将大于1。

有了这两个量，在时间点 $t_{(j)}$ 存活的条件概率的经验估计就是：
$$ \frac{n_j - d_j}{n_j} = 1 - \frac{d_j}{n_j} $$
这就是在 $t_{(j)}$ 时刻，风险集中的个体没有发生事件的比例。

将所有这些[条件概率](@entry_id:151013)连乘，便得到**[Kaplan-Meier](@entry_id:169317)[乘积极限估计量](@entry_id:171437) (product-limit estimator)**：
$$ \hat{S}(t) = \prod_{j: t_{(j)} \le t} \left(1 - \frac{d_j}{n_j}\right) $$
按照惯例，在第一个事件发生之前，$\hat{S}(t) = 1$。

让我们通过一个例子来演示这个计算过程 。考虑一个有8名受试者的队列，数据包含左截断（进入时间 $L_j$）和[右删失](@entry_id:164686)。事件时间为 $t=2.0, 3.0, 4.0, 5.0$。

*   **在第一个事件时间 $t_1 = 2.0$**：
    我们需要找到所有满足 $L_j \le 2.0$ 且 $X_j \ge 2.0$ 的个体。通过逐一检查数据，我们发现有6名个体符合条件。因此，风险集大小 $n_1 = 6$。假设在 $t_1=2.0$ 时有1个事件（$d_1=1$）。
    $\hat{S}(2.0) = (1 - \frac{1}{6}) = \frac{5}{6} \approx 0.833$

*   **在第二个事件时间 $t_2 = 3.0$**：
    我们需要重新计算风险集。此时，在 $t_1=2.0$ 发生事件的个体已退出，一些在 $2.0$ 和 $3.0$ 之间被删失的个体也已退出，而一些在 $2.0$ 之后才进入研究的个体可能新加入。假设计算后，风险集大小为 $n_2=5$。若此时有1个事件（$d_2=1$）。
    $\hat{S}(3.0) = \hat{S}(2.0) \times (1 - \frac{d_2}{n_2}) = \frac{5}{6} \times (1 - \frac{1}{5}) = \frac{5}{6} \times \frac{4}{5} = \frac{4}{6} \approx 0.667$

这个过程持续进行，直到最后一个事件时间点。该算法的精髓在于其对每个事件时间点动态更新风险集的能力，从而自然地处理了[右删失](@entry_id:164686)和左截断 。

### 解释生存曲线

生成KM曲线后，下一步是解读其提供的丰富信息。

#### [中位生存时间](@entry_id:634182)

生存曲线本身提供了完整的生存信息，但我们常常需要一个单一的概括性指标，其中最常用的就是**[中位生存时间](@entry_id:634182) (median survival time)**。它被定义为生存概率首次达到或低于 $0.5$ 的时间点。形式上，[中位生存时间](@entry_id:634182) $m$ 定义为：
$$ m = \inf\{t: \hat{S}(t) \le 0.5\} $$
这里的 $\inf$ 表示[下确界](@entry_id:140118)，即满足条件的所有 $t$ 中的最小值。

这个定义有几个重要的推论 ：
*   **唯一性**：使用[下确界](@entry_id:140118)的定义确保了[中位生存时间](@entry_id:634182)总是唯一的。即使KM曲线在 $S(t)=0.5$ 的水平上有一段平坦的区间（例如从时间 $a$ 到 $b$），[中位生存时间](@entry_id:634182)也唯一定义为 $m=a$。
*   **存在性**：如果由于删失率过高，生存曲线在整个随访期间始终保持在 $0.5$ 以上（即 $\hat{S}(t) > 0.5$ 对所有观测到的 $t$ 成立），那么[中位生存时间](@entry_id:634182)就“未达到”(not reached)。在这种情况下，我们不能估计一个确切的 $m$ 值，而应报告 $m > T_{max}$，其中 $T_{max}$ 是研究中最长的随访时间。将其强行设置为 $T_{max}$ 是不正确的，会低估真实的[中位生存时间](@entry_id:634182)。
*   **跳跃点**：如果生存曲线在某个事件时间点 $t_j$ 从高于 $0.5$（$\hat{S}(t_j^-) > 0.5$）直接跳到低于或等于 $0.5$（$\hat{S}(t_j) \le 0.5$），那么[中位生存时间](@entry_id:634182)就精确地等于 $t_j$。

#### 比较生存曲线

在临床试验等情境中，我们更关心的是比较不同组别（如治疗组与安慰剂组）的生存差异。通过在同一坐标系中绘制两组或多组的KM曲线，我们可以直观地进行比较。

*   如果一条曲线始终位于另一条曲线之上，这表明该组的生存情况在整个随访期间都更优。
*   如果曲线发生**交叉 (crossing)**，这意味着两组的相对风险（或生存优势）随时间发生了逆转。例如，一种新疗法可能在短期内显著提高生存率，但其长期毒副作用可能导致远期生存率反而低于标准疗法。

[曲线交叉](@entry_id:189391)的现象直接关联到一个重要的统计假设：**[比例风险假设](@entry_id:163597) (proportional hazards assumption)**。该假设认为，两组的[风险函数](@entry_id:166593)（瞬时事件发生率）之比在所有时间点上都是一个常数，即 $h_A(t) = \lambda h_B(t)$。在此假设下，生存函数之间存在关系 $S_A(t) = [S_B(t)]^\lambda$，这意味着两条生存曲线除了在 $t=0$ 处相遇外，不应在任何其他地方交叉。因此，观察到KM[曲线交叉](@entry_id:189391)是[比例风险假设](@entry_id:163597)不成立的一个强烈视觉信号 。

### 关键假设：非信息性删失

KM估计的有效性依赖于一个至关重要的假设：**非信息性删失 (non-informative censoring)**。这个假设的本质是，一个体在某个时间点被删失，这一事实本身不应提供关于该个体未来事件风险的任何额外信息。换句话说，在任何时间点 $t$，被删失的个体与那些继续留在研究中的个体，在未来的事件风险方面是无法区分的（或可交换的）。

当删失原因与个体的预后或事件风险相关时，就会发生**信息性删失 (informative censoring)** 或 **依赖性删失 (dependent censoring)**，这将导致KM估计产生偏倚 。
*   **导致偏倚的机制**：假设病情较重的患者更有可能因健康恶化而失访（例如，转到研究网络之外的医院接受重症监护）。这些患者的真实事件风险更高。如果我们将他们作为普通右删失处理，那么留在研究中的风险集就会被人为地“净化”，看起来比实际情况更健康。这将导致观察到的事件率偏低，从而高估生存概率，使KM曲线产生向上的偏倚。
*   **非信息性删失的例子**：参与者因配偶在外地找到工作而举家搬迁，或研究因达到预定日期而结束（管理性删失），这些通常被认为是与个体健康状况无关的，因此属于非信息性删失。

从更严谨的[计数过程](@entry_id:260664)理论来看，非信息性删失的正式假设是，在给定基线协变量 $Z$ 的条件下，真实事件时间 $T$ 与删失时间 $C$ 是条件独立的（$T \perp C \mid Z$）。这意味着，在控制了个体基线特征（如年龄、疾病分期）后，删失机制不依赖于事件过程。这一假设保证了我们从观测数据中估计出的风险率能一致地反映真实的事件风险率 。

### 假设检验：对数秩检验

为了从统计上正式比较两条或多条生存曲线是否存在差异，我们通常使用**对数秩检验 (log-rank test)**。

[对数秩检验](@entry_id:168043)是一种[非参数检验](@entry_id:176711)，其**零假设 ($H_0$)** 是：所有组的生存分布完全相同。这等价于说，对于所有时间点 $t$，各组的生存函数都相等（$H_0: S_1(t) = S_2(t) = \dots = S_k(t)$），或者说，各组的[风险函数](@entry_id:166593)都相等（$H_0: h_1(t) = h_2(t) = \dots = h_k(t)$）。

检验的原理是在每个事件时间点，基于零假设（即所有组合并在一起），计算每个组的“期望”事件数，然后将其与“观察到”的事件数进行比较。最后，将所有事件时间点的（观察-期望）差异汇总起来，构成一个服从[卡方分布](@entry_id:165213)的检验统计量。

对数秩检验在[比例风险假设](@entry_id:163597)成立时具有最大的[统计功效](@entry_id:197129)。当生存[曲线交叉](@entry_id:189391)时（即非[比例风险](@entry_id:166780)），早期和晚期的（观察-期望）差异可能方向相反，从而在总和中相互抵消，导致[检验功效](@entry_id:175836)下降 。

### 相关方法比较：精算[生命表](@entry_id:154706)法

在[Kaplan-Meier](@entry_id:169317)方法普及之前，**精算[生命表](@entry_id:154706)法 (actuarial life-table method)** 是估计生存函数的主要工具。与KM方法在每个事件时间点进行计算不同，生命表法将随访时间划分成固定的区间（如年、月），然后在每个区间内汇总事件和删失信息。

在区间 $i$ 内，其核心是估计一个有效的风险人数 $n_{i,eff}$。标准做法是假设删失均匀发生在该区间内，因此被删失的个体平均贡献了一半区间的风险时间。有效风险人数估计为 $n_{i,eff} = n'_i - c_i/2$，其中 $n'_i$ 是区间开始时的风险人数，$c_i$ 是区间内的删失数。

Kaplan-Meier方法与生命表法之间存在一种**偏倚-方差权衡 (bias-variance trade-off)** ：
*   **[生命表](@entry_id:154706)法**：通过对时间进行分组，该方法平滑了数据，通常能降低估计的方差。然而，这种分组引入了偏倚，因为“删失均匀分布”的假设很少能被完美满足。区间越宽，这种偏倚可能越大。例如，如果删失主要发生在区间早期，那么 $n_{i,eff}$ 会被高估，导致事件率被低估，生存率被高估。
*   **Kaplan-Meier方法**：通过使用精确的事件时间，KM估计避免了因时间分组而引入的偏倚，通常被认为是（渐近）无偏的。但其结果可能比[生命表](@entry_id:154706)法有更大的方差，曲线的[阶梯形](@entry_id:153067)状也更“曲折”。

在理论上，当[生命表](@entry_id:154706)法的区间宽度趋近于零时，其估计结果会收敛于Kaplan-Meier估计 。在现代计算条件下，由于可以轻松处理精确的事件时间，[Kaplan-Meier](@entry_id:169317)方法已成为非参数生存分析的标准和首选方法。