{
    "hands_on_practices": [
        {
            "introduction": "孟德尔随机化 (MR) 的核心思想是通过基因变异作为工具变量来推断因果关系。这个练习将引导您完成一项最基本的MR计算：Wald比率估计。通过利用来自两个独立样本的汇总数据，您将学习如何计算暴露对结局的因果效应估计值，并使用delta方法评估其统计显著性，这是理解MR定量框架的基石。",
            "id": "4611689",
            "problem": "在一项双样本孟德尔随机化（MR）分析中，一个单个遗传变异被用作一个连续暴露的工具变量。假设标准的工具变量条件成立：相关性（该遗传变异影响暴露）、独立性（该遗传变异与暴露-结局关系的混杂因素无关）和排他性限制（该遗传变异仅通过暴露影响结局）。在来自研究A的一个大样本中，对暴露与遗传变异进行线性回归，得出的汇总关联估计值为 $\\hat{\\beta}_{XG}$，其标准误为 $SE(\\hat{\\beta}_{XG})$。在来自研究B的一个独立大样本中，对二元结局与同一遗传变异进行逻辑斯蒂回归，得出的对数优势比关联估计值为 $\\hat{\\beta}_{YG}$，其标准误为 $SE(\\hat{\\beta}_{YG})$。将这两个样本视为独立的，并在对数优势比尺度上解释遗传变异对结局的影响。\n\n给定以下汇总统计数据：\n- 研究 A：$\\hat{\\beta}_{XG} = 0.08$ 且 $SE(\\hat{\\beta}_{XG}) = 0.01$。\n- 研究 B：$\\hat{\\beta}_{YG} = 0.024$ 且 $SE(\\hat{\\beta}_{YG}) = 0.006$。\n\n根据核心工具变量恒等式，即在这些假设下，因果效应等于遗传与结局的关联除以遗传与暴露的关联，构建暴露对结局的因果对数优势比效应的比率估计量。然后，对独立估计量的平滑函数使用一阶泰勒级数（delta方法）近似，推导出该比率估计量的近似标准误。最后，计算Wald检验统计量 $z = \\hat{\\beta}_{W} / SE(\\hat{\\beta}_{W})$，以检验因果效应为零的原假设。\n\n只报告 $z$ 的值，四舍五入到四位有效数字。最终答案中不要包含任何单位。",
            "solution": "用户希望计算使用双样本孟德尔随机化（MR）估计的因果效应的Wald检验统计量。\n\n### 步骤1：问题验证\n根据指定标准验证问题陈述。\n\n**1. 提取已知条件：**\n- 一个单个遗传变异是连续暴露（$X$）和二元结局（$Y$）的工具变量（IV）。\n- 假设三个核心IV假定（相关性、独立性、排他性限制）成立。\n- 该分析是一个双样本MR，估计值来自两个独立的研究。\n- 研究A（暴露样本）：\n    - 与暴露的遗传关联：$\\hat{\\beta}_{XG} = 0.08$。\n    - 关联的标准误：$SE(\\hat{\\beta}_{XG}) = 0.01$。\n- 研究B（结局样本）：\n    - 与结局对数优势比的遗传关联：$\\hat{\\beta}_{YG} = 0.024$。\n    - 关联的标准误：$SE(\\hat{\\beta}_{YG}) = 0.006$。\n- 任务是计算Wald检验统计量 $z = \\hat{\\beta}_{W} / SE(\\hat{\\beta}_{W})$，用于检验无因果效应的原假设，其中 $\\hat{\\beta}_{W}$ 是因果效应的比率估计量。\n\n**2. 使用提取的已知条件进行验证：**\n- **科学依据：** 该问题描述了一个标准的双样本孟德尔随机化分析，这是流行病学中一种广泛使用且经过验证的方法。工具变量假设、比率估计量以及delta方法的使用都是该方法论的核心组成部分。\n- **适定性：** 该问题提供了所有必要数据，并明确指定了用于计算单个明确定义量（Wald统计量）的方法（比率估计、delta方法）。\n- **客观性：** 该问题使用精确、定量和客观的语言陈述。\n\n**3. 结论与行动：**\n该问题在科学上是合理的、适定的、客观的和完整的。因此，它被判定为**有效**。现在将构建解决方案。\n\n### 步骤2：求解\n暴露 $X$ 对结局 $Y$ 对数优势比的因果效应记为 $\\beta_W$。在工具变量假设下，遗传与结局的关联（$\\beta_{YG}$）是因果效应与遗传与暴露的关联（$\\beta_{XG}$）的乘积：\n$$ \\beta_{YG} = \\beta_W \\cdot \\beta_{XG} $$\n因此，因果效应的比率估计量（也称为Wald估计量）由两个关联估计值的比率给出：\n$$ \\hat{\\beta}_W = \\frac{\\hat{\\beta}_{YG}}{\\hat{\\beta}_{XG}} $$\n使用所提供的值，我们可以计算因果效应的点估计值：\n$$ \\hat{\\beta}_W = \\frac{0.024}{0.08} = 0.3 $$\n这个值表示暴露每增加一个单位，结局的对数优势比估计增加 $0.3$。\n\n为了构建Wald检验统计量，我们需要该估计量的标准误 $SE(\\hat{\\beta}_W)$。问题指定使用一阶泰勒级数近似（delta方法）来求此值。设我们的估计量是两个随机变量的函数，$f(x, y) = y/x$，其中 $x = \\hat{\\beta}_{XG}$ 且 $y = \\hat{\\beta}_{YG}$。该函数的方差可以近似为：\n$$ \\text{Var}(f(x, y)) \\approx \\left(\\frac{\\partial f}{\\partial x}\\right)^2 \\text{Var}(x) + \\left(\\frac{\\partial f}{\\partial y}\\right)^2 \\text{Var}(y) + 2 \\left(\\frac{\\partial f}{\\partial x}\\right) \\left(\\frac{\\partial f}{\\partial y}\\right) \\text{Cov}(x, y) $$\n$f(x, y)$ 的偏导数是：\n$$ \\frac{\\partial f}{\\partial x} = -\\frac{y}{x^2} \\quad \\text{和} \\quad \\frac{\\partial f}{\\partial y} = \\frac{1}{x} $$\n由于估计值 $\\hat{\\beta}_{XG}$ 和 $\\hat{\\beta}_{YG}$ 来自两个独立的样本，它们的协方差为零，即 $\\text{Cov}(\\hat{\\beta}_{XG}, \\hat{\\beta}_{YG}) = 0$。方差公式简化为：\n$$ \\text{Var}(\\hat{\\beta}_W) \\approx \\left(-\\frac{\\hat{\\beta}_{YG}}{\\hat{\\beta}_{XG}^2}\\right)^2 \\text{Var}(\\hat{\\beta}_{XG}) + \\left(\\frac{1}{\\hat{\\beta}_{XG}}\\right)^2 \\text{Var}(\\hat{\\beta}_{YG}) $$\n估计量的方差是其标准误的平方，因此 $\\text{Var}(\\hat{\\beta}) = [SE(\\hat{\\beta})]^2$。将此关系代入公式，得到因果效应估计量标准误平方的表达式：\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{\\hat{\\beta}_{YG}^2}{\\hat{\\beta}_{XG}^4} [SE(\\hat{\\beta}_{XG})]^2 + \\frac{1}{\\hat{\\beta}_{XG}^2} [SE(\\hat{\\beta}_{YG})]^2 $$\n现在我们代入给定的数值：\n- $\\hat{\\beta}_{XG} = 0.08$\n- $SE(\\hat{\\beta}_{XG}) = 0.01$\n- $\\hat{\\beta}_{YG} = 0.024$\n- $SE(\\hat{\\beta}_{YG}) = 0.006$\n\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{(0.024)^2}{(0.08)^4} (0.01)^2 + \\frac{1}{(0.08)^2} (0.006)^2 $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx \\frac{0.000576}{0.00004096} (0.0001) + \\frac{1}{0.0064} (0.000036) $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx (14.0625) \\times (0.0001) + (156.25) \\times (0.000036) $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx 0.00140625 + 0.005625 $$\n$$ [SE(\\hat{\\beta}_W)]^2 \\approx 0.00703125 $$\n标准误是方差的平方根：\n$$ SE(\\hat{\\beta}_W) = \\sqrt{0.00703125} \\approx 0.08385256... $$\n最后，我们计算原假设 $H_0: \\beta_W = 0$ 的Wald检验统计量 $z$：\n$$ z = \\frac{\\hat{\\beta}_W}{SE(\\hat{\\beta}_W)} $$\n$$ z = \\frac{0.3}{0.08385256...} \\approx 3.57770876... $$\n四舍五入到四位有效数字，我们得到：\n$$ z \\approx 3.578 $$",
            "answer": "$$\\boxed{3.578}$$"
        },
        {
            "introduction": "现代MR研究通常使用多个遗传变异作为工具变量以增强统计功效。本练习将理论与实践相结合，要求您编写代码来实现几种核心的MR分析方法，包括逆方差加权 (IVW) 和MR-Egger回归。通过这项编程实践，您不仅能掌握如何汇总多个工具变量的信息来估计因果效应，还能学会计算如Cochran’s $Q$统计量和$I^2$等关键异质性指标，从而评估分析结果的稳健性。",
            "id": "2404096",
            "problem": "在孟德尔随机化 (MR) 的背景下，您会获得来自全基因组关联研究 (GWAS) 工具变量的摘要关联数据，其中每个工具变量都是一个单核苷酸多态性 (SNP)。对于每个SNP，您拥有其与暴露的关联性，表示为 $ \\beta_{GX,i} $，以及其与结局的关联性，表示为 $ \\beta_{GY,i} $，同时还有结局关联性的标准误 $ \\sigma_{GY,i} $。假设以下基本前提：(i) 暴露-结局关系呈线性因果模型；(ii) 除了任何潜在的水平多效性外，工具变量仅通过暴露影响结局；(iii) $ \\beta_{GY,i} $ 的抽样变异由 $ \\sigma_{GY,i} $ 量化，并且为了加权目的，$ \\beta_{GX,i} $ 的不确定性相对于 $ \\sigma_{GY,i} $ 可以忽略不计；(iv) 因果效应可通过使用加权最小二乘法汇总每个变异的信息来估计。\n\n您的任务是编写一个完整的程序，为下述每个测试用例计算生成 (a) $ \\beta_{GY} $ 相对于 $ \\beta_{GX} $ 的散点图（包含截距约束的逆方差加权 (IVW) 回归线和孟德尔随机化Egger (MR-Egger) 回归线）以及 (b) 比率估计值与其标准误的漏斗图（用于直观检查异质性和多效性）所需的数值对象。您的程序无需绘制任何图形，但必须返回定义这些图形的精确数值。\n\n仅从上述基本原则出发，为每个测试用例实现以下计算：\n- 使用由结局方差的倒数定义的权重 $ w_i $，即 $ w_i $ 与 $ 1 / \\sigma_{GY,i}^2 $ 成正比。\n- 通过求解截距固定为零的加权最小二乘问题，计算截距约束的IVW因果斜率估计值，该问题旨在最小化 $ \\sum_i w_i \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right)^2 $ (对 $ b $ 求解)。\n- 通过最小化 $ \\sum_i w_i \\left( \\beta_{GY,i} - a - b \\, \\beta_{GX,i} \\right)^2 $ (对 $ a $ 和 $ b $ 求解)，计算具有无约束截距的MR-Egger加权回归线。\n- 在IVW拟合下，计算用于异质性的 Cochran's $ Q $ 统计量和相应的 $ I^2 $ 异质性指标，其中 $ Q $ 比较加权残差的离散度与其在同质性假设下的期望值。\n- 对于漏斗图，在 $ \\beta_{GX,i} $ 的不确定性相对于 $ \\sigma_{GY,i} $ 可以忽略不计的假设下，计算每个变异的比率估计值 $ \\theta_i $ 及其近似标准误 $ s_i $。然后，围绕合并的IVW效应，为每个变异计算伪95%漏斗图界限，公式为 $ \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i $。\n\n您的程序必须将这些计算应用于以下测试套件。每个测试用例由三个等长列表定义：$ \\beta_{GX} $、$ \\beta_{GY} $ 和 $ \\sigma_{GY} $。\n\n测试用例A (理想情况；一致的工具变量)：\n- $ \\beta_{GX} = [\\, 0.08, \\, 0.12, \\, 0.10, \\, 0.15, \\, 0.07, \\, 0.11 \\,] $\n- $ \\beta_{GY} = [\\, 0.040, \\, 0.060, \\, 0.051, \\, 0.072, \\, 0.033, \\, 0.057 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.018, \\, 0.022, \\, 0.019, \\, 0.021, \\, 0.020 \\,] $\n\n测试用例B (定向多效性；预期截距非零)：\n- $ \\beta_{GX} = [\\, 0.05, \\, -0.04, \\, 0.09, \\, 0.12, \\, 0.03, \\, 0.07 \\,] $\n- $ \\beta_{GY} = [\\, 0.037, \\, 0.007, \\, 0.048, \\, 0.054, \\, 0.029, \\, 0.042 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.021, \\, 0.019, \\, 0.018, \\, 0.022, \\, 0.020 \\,] $\n\n测试用例C (异质性和一个弱工具变量)：\n- $ \\beta_{GX} = [\\, 0.20, \\, 0.15, \\, 0.10, \\, 0.05, \\, 0.004 \\,] $\n- $ \\beta_{GY} = [\\, 0.080, \\, 0.070, \\, 0.045, \\, 0.050, \\, 0.010 \\,] $\n- $ \\sigma_{GY} = [\\, 0.015, \\, 0.015, \\, 0.016, \\, 0.020, \\, 0.020 \\,] $\n\n测试用例D (平衡多效性；异质性且截距近似为零)：\n- $ \\beta_{GX} = [\\, 0.10, \\, 0.12, \\, 0.09, \\, 0.11, \\, 0.08 \\,] $\n- $ \\beta_{GY} = [\\, 0.080, \\, 0.052, \\, 0.064, \\, 0.056, \\, 0.048 \\,] $\n- $ \\sigma_{GY} = [\\, 0.020, \\, 0.020, \\, 0.020, \\, 0.020, \\, 0.020 \\,] $\n\n实现和数值要求：\n- 将所有权重视为 $ w_i = 1 / \\sigma_{GY,i}^2 $。\n- 对于漏斗图，计算 $ \\theta_i = \\beta_{GY,i} / \\beta_{GX,i} $ 和 $ s_i = \\sigma_{GY,i} / \\lvert \\beta_{GX,i} \\rvert $。\n- 在漏斗图界限 $ \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i $ 中，使用IVW斜率作为合并效应。\n- 对于IVW拟合下的Cochran异质性统计量，计算 $ Q $，然后计算 $ I^2 = \\max \\left( 0, \\, \\dfrac{Q - (M - 1)}{Q} \\right) $，其中 $ M $ 是变异的数量。如果 $ Q = 0 $，则设 $ I^2 = 0 $。\n- 您的程序必须为每个测试用例输出一个包含以下顺序九个元素的列表：\n  1. IVW斜率 (浮点数),\n  2. MR-Egger斜率 (浮点数),\n  3. MR-Egger截距 (浮点数),\n  4. IVW Cochran’s $ Q $ (浮点数),\n  5. IVW $ I^2 $ (浮点数),\n  6. 比率估计值列表 $ [ \\theta_i ] $,\n  7. 比率标准误列表 $ [ s_i ] $,\n  8. 漏斗图下界列表 $ [ \\theta_{\\text{IVW}} - 1.96 \\, s_i ] $,\n  9. 漏斗图上界列表 $ [ \\theta_{\\text{IVW}} + 1.96 \\, s_i ] $。\n- 将所有浮点数四舍五入至六位小数。\n- 最终输出格式：您的程序应生成一行输出，其中包含四个测试用例的结果，聚合为一个用方括号括起来的逗号分隔列表，没有空格。即，形式为 $ [r_A, r_B, r_C, r_D] $ 的单行，其中每个 $ r_\\cdot $ 是上述的九元素列表。\n\n边界条件和科学现实性：\n- 确保 $ \\lvert \\beta_{GX,i} \\rvert $ 不为零，以避免在比率计算中出现除以零的错误。所提供的测试套件满足此条件；一般而言，如果任何 $ \\lvert \\beta_{GX,i} \\rvert $ 低于某个小阈值 $ \\varepsilon $，则应在比率和漏斗图组件中排除该变异，同时在回归拟合中保持一致性（如果处理得当）。在此测试套件中，无需进行任何排除。",
            "solution": "问题陈述经评估有效。它在科学上基于孟德尔随机化（MR）的既定原则，这是遗传流行病学中的一种标准方法。问题是适定的，为所需的计算提供了所有必要的数据和明确的数学定义。其语言客观、正式，没有歧义或主观性陈述。它提出了一个基于可验证的统计学和数学原理的可解决的计算任务。\n\n我们现在将系统地推导所需的量。背景是使用遗传变异作为工具变量来估计暴露对结局的因果效应。对于 $M$ 个遗传变异（SNP）中的每一个，我们都给出了其与暴露的估计关联性 $\\beta_{GX,i}$、其与结局的估计关联性 $\\beta_{GY,i}$，以及后者的标准误 $\\sigma_{GY,i}$。\n\n所有加权计算的权重由结局方差的倒数定义，假设为此目的 $\\beta_{GX,i}$ 的不确定性可以忽略不计：\n$$\nw_i = \\frac{1}{\\sigma_{GY,i}^2}\n$$\n\n**1. 截距约束的逆方差加权 (IVW) 斜率**\n\nIVW方法通过求解一个加权最小二乘问题来估计因果效应 $b$，该问题强制回归线通过原点。这对应于无水平多效性的假设。目标是最小化加权残差平方和：\n$$\nS(b) = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right)^2\n$$\n为找到最小值，我们将关于 $b$ 的导数设为零：\n$$\n\\frac{dS}{db} = -2 \\sum_{i=1}^{M} w_i \\beta_{GX,i} \\left( \\beta_{GY,i} - b \\, \\beta_{GX,i} \\right) = 0\n$$\n求解 $b$ 可得出IVW估计值，我们将其表示为 $\\theta_{\\text{IVW}}$：\n$$\n\\theta_{\\text{IVW}} = \\frac{\\sum_{i=1}^{M} w_i \\beta_{GX,i} \\beta_{GY,i}}{\\sum_{i=1}^{M} w_i \\beta_{GX,i}^2}\n$$\n\n**2. 孟德尔随机化Egger (MR-Egger) 回归**\n\nMR-Egger方法放宽了IVW方法的无多效性假设，允许在 $\\beta_{GY,i}$ 对 $\\beta_{GX,i}$ 的回归中存在非零截距。截距 $a$ 可解释为平均定向多效性效应的估计值，而斜率 $b$ 仍然是因果效应的估计值。我们对 $a$ 和 $b$ 最小化以下目标函数：\n$$\nS(a, b) = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - a - b \\, \\beta_{GX,i} \\right)^2\n$$\n这是一个标准的加权线性回归问题。MR-Egger斜率 ($b_{\\text{Egger}}$) 和截距 ($a_{\\text{Egger}}$) 的解由正规方程给出：\n$$\nb_{\\text{Egger}} = \\frac{ \\left(\\sum w_i\\right) \\left(\\sum w_i \\beta_{GX,i} \\beta_{GY,i}\\right) - \\left(\\sum w_i \\beta_{GX,i}\\right) \\left(\\sum w_i \\beta_{GY,i}\\right) }{ \\left(\\sum w_i\\right) \\left(\\sum w_i \\beta_{GX,i}^2\\right) - \\left(\\sum w_i \\beta_{GX,i}\\right)^2 }\n$$\n$$\na_{\\text{Egger}} = \\frac{\\sum w_i \\beta_{GY,i}}{\\sum w_i} - b_{\\text{Egger}} \\frac{\\sum w_i \\beta_{GX,i}}{\\sum w_i}\n$$\n这些公式对应于加权最小二乘回归系数的标准解。\n\n**3. Cochran’s Q 统计量和 I² 异质性指标**\n\n工具变量特异性因果估计值之间的异质性可能表明违反了MR假设（如多效性），或者真实因果效应对不同工具变量所针对的人群子集有所不同。IVW模型的Cochran’s $Q$ 统计量通过对单个比率估计值与合并IVW估计值之间的加权平方差求和来量化这种异质性。其计算公式为：\n$$\nQ = \\sum_{i=1}^{M} w_i \\left( \\frac{\\beta_{GY,i}}{\\beta_{GX,i}} - \\theta_{\\text{IVW}} \\right)^2 \\beta_{GX,i}^2 = \\sum_{i=1}^{M} w_i \\left( \\beta_{GY,i} - \\theta_{\\text{IVW}} \\beta_{GX,i} \\right)^2\n$$\n在同质性的原假设下（即所有工具变量估计相同的因果效应），$Q$ 服从自由度为 $M-1$ 的卡方分布。\n\n$I^2$ 统计量描述了工具变量间的变异中由异质性而非抽样误差所占的百分比。它由 $Q$ 导出：\n$$\nI^2 = \\max\\left(0, \\frac{Q - (M-1)}{Q}\\right)\n$$\n如果 $Q=0$（在实践中极不可能），则 $I^2$ 定义为 $0$。\n\n**4. 漏斗图组件**\n\n漏斗图是一种用于研究异质性和发表偏倚的可视化工具。它绘制了每个工具变量的效应量与其精确度的度量。\n\n-   **每个变异的比率估计值 ($\\theta_i$)：** 这是从单个工具变量 $i$ 估计的因果效应：\n    $$\n    \\theta_i = \\frac{\\beta_{GY,i}}{\\beta_{GX,i}}\n    $$\n-   **比率估计值的标准误 ($s_i$)：** 使用delta方法并假设 $\\beta_{GX,i}$ 的测量误差可忽略不计，$\\theta_i$ 的标准误近似为：\n    $$\n    s_i = \\text{SE}(\\theta_i) \\approx \\frac{\\sigma_{GY,i}}{\\lvert \\beta_{GX,i} \\rvert}\n    $$\n-   **漏斗图界限：** 漏斗图围绕合并的IVW因果估计值 $\\theta_{\\text{IVW}}$ 构建。对于伪95%置信区间，每个变异 $i$ 的界限为：\n    $$\n    \\text{Bounds}_i = \\theta_{\\text{IVW}} \\pm 1.96 \\, s_i\n    $$\n    下界和上界分别为 $\\theta_{\\text{IVW}} - 1.96 \\, s_i$ 和 $\\theta_{\\text{IVW}} + 1.96 \\, s_i$。\n\n该实现将为每个提供的测试用例计算这九个量：IVW斜率、MR-Egger斜率和截距、IVW拟合的Cochran's $Q$ 和 $I^2$ 统计量，以及比率估计值列表、其标准误列表和相应的漏斗图下界和上界列表。所有浮点数将按要求四舍五入到六位小数。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_mr_metrics(beta_gx: list[float], beta_gy: list[float], sigma_gy: list[float]) -> list:\n    \"\"\"\n    Computes Mendelian randomization metrics for a given set of summary statistics.\n\n    Args:\n        beta_gx: List of SNP-exposure associations.\n        beta_gy: List of SNP-outcome associations.\n        sigma_gy: List of standard errors for SNP-outcome associations.\n\n    Returns:\n        A list containing nine elements as specified in the problem description.\n    \"\"\"\n    # Convert lists to NumPy arrays for vectorized operations\n    bgx = np.array(beta_gx)\n    bgy = np.array(beta_gy)\n    sgy = np.array(sigma_gy)\n    \n    # 1. Weights\n    # w_i = 1 / sigma_GY,i^2\n    w = 1.0 / (sgy**2)\n    \n    # 2. IVW Slope (Intercept-constrained)\n    # theta_ivw = (sum w_i * beta_gx_i * beta_gy_i) / (sum w_i * beta_gx_i^2)\n    ivw_numerator = np.sum(w * bgx * bgy)\n    ivw_denominator = np.sum(w * bgx**2)\n    ivw_slope = ivw_numerator / ivw_denominator\n    \n    # 3. MR-Egger Slope and Intercept\n    # Weighted least squares regression of bgy on bgx with weights w\n    W = np.sum(w)\n    Swx = np.sum(w * bgx)\n    Swy = np.sum(w * bgy)\n    Swxx = np.sum(w * bgx**2)\n    Swxy = np.sum(w * bgx * bgy)\n    \n    egger_denominator = (W * Swxx - Swx**2)\n    if egger_denominator == 0:\n        # This case is unlikely with real data but handle for robustness\n        mr_egger_slope = np.nan\n        mr_egger_intercept = np.nan\n    else:\n        mr_egger_slope = (W * Swxy - Swx * Swy) / egger_denominator\n        mr_egger_intercept = (Swy / W) - mr_egger_slope * (Swx / W)\n\n    # 4. Cochran's Q for IVW\n    # Q = sum w_i * (beta_gy_i - theta_ivw * beta_gx_i)^2\n    cochran_q = np.sum(w * (bgy - ivw_slope * bgx)**2)\n    \n    # 5. I^2 for IVW\n    M = len(bgx)\n    df = M - 1\n    if cochran_q == 0:\n        i_squared = 0.0\n    else:\n        i_squared = max(0.0, (cochran_q - df) / cochran_q)\n\n    # 6. Ratio estimates (theta_i)\n    # theta_i = beta_gy_i / beta_gx_i\n    theta_i = bgy / bgx\n    \n    # 7. Ratio standard errors (s_i)\n    # s_i = sigma_gy_i / |beta_gx_i|\n    s_i = sgy / np.abs(bgx)\n    \n    # 8.  9. Funnel plot bounds\n    # lower/upper = theta_ivw +/- 1.96 * s_i\n    z_score = 1.96\n    funnel_lower_bounds = ivw_slope - z_score * s_i\n    funnel_upper_bounds = ivw_slope + z_score * s_i\n    \n    # Assemble results and round to 6 decimal places\n    results = [\n        round(ivw_slope, 6),\n        round(mr_egger_slope, 6),\n        round(mr_egger_intercept, 6),\n        round(cochran_q, 6),\n        round(i_squared, 6),\n        [round(val, 6) for val in theta_i],\n        [round(val, 6) for val in s_i],\n        [round(val, 6) for val in funnel_lower_bounds],\n        [round(val, 6) for val in funnel_upper_bounds],\n    ]\n    \n    return results\n\ndef format_result_list(res_list: list) -> str:\n    \"\"\"Formats a single test case result list into the required string format.\"\"\"\n    str_parts = []\n    for item in res_list:\n        if isinstance(item, list):\n            formatted_list = f\"[{','.join([f'{x:.6f}' for x in item])}]\"\n            str_parts.append(formatted_list)\n        else:\n            str_parts.append(f\"{item:.6f}\")\n    return f\"[{','.join(str_parts)}]\"\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final output.\n    \"\"\"\n    test_cases = {\n        'A': {\n            \"beta_gx\": [0.08, 0.12, 0.10, 0.15, 0.07, 0.11],\n            \"beta_gy\": [0.040, 0.060, 0.051, 0.072, 0.033, 0.057],\n            \"sigma_gy\": [0.020, 0.018, 0.022, 0.019, 0.021, 0.020]\n        },\n        'B': {\n            \"beta_gx\": [0.05, -0.04, 0.09, 0.12, 0.03, 0.07],\n            \"beta_gy\": [0.037, 0.007, 0.048, 0.054, 0.029, 0.042],\n            \"sigma_gy\": [0.020, 0.021, 0.019, 0.018, 0.022, 0.020]\n        },\n        'C': {\n            \"beta_gx\": [0.20, 0.15, 0.10, 0.05, 0.004],\n            \"beta_gy\": [0.080, 0.070, 0.045, 0.050, 0.010],\n            \"sigma_gy\": [0.015, 0.015, 0.016, 0.020, 0.020]\n        },\n        'D': {\n            \"beta_gx\": [0.10, 0.12, 0.09, 0.11, 0.08],\n            \"beta_gy\": [0.080, 0.052, 0.064, 0.056, 0.048],\n            \"sigma_gy\": [0.020, 0.020, 0.020, 0.020, 0.020]\n        }\n    }\n\n    all_results_str = []\n    # Process cases in alphabetical order to match output format\n    for key in sorted(test_cases.keys()):\n        case = test_cases[key]\n        result = calculate_mr_metrics(case[\"beta_gx\"], case[\"beta_gy\"], case[\"sigma_gy\"])\n        all_results_str.append(format_result_list(result))\n\n    print(f\"[{','.join(all_results_str)}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "MR分析的有效性高度依赖于其核心假设，尤其是“排他性限定”假设（即工具变量仅通过暴露影响结局）。由于该假设无法直接检验，科学家们设计了诸如负面对照研究等巧妙方法来间接评估其合理性。在这个思想实验中，您将扮演研究设计者的角色，任务是为一项MR研究设计一个严谨的负面对照分析方案，以增强对因果推断结论的信心。",
            "id": "2404125",
            "problem": "您正在计划一项阴性对照孟德尔随机化 (MR) 研究，以评估用于研究血管结局时，低密度脂蛋白胆固醇 (LDL-C) 遗传工具变量的有效性。设 $G$ 表示一组与 LDL-C（暴露，$X$）有强关联的单核苷酸多态性 (SNPs; Single Nucleotide Polymorphisms)。设 $Y$ 表示一种血管结局，如冠状动脉疾病，并设 $Y^{\\ast}$ 表示一个建议的阴性对照结局，即意外死亡，这在生物学上不被认为是由 LDL-C 引起的。您可以从主要为欧洲血统的大型队列中获取 $X$ 和 $Y^{\\ast}$ 的汇总水平全基因组关联研究 (GWAS; Genome-Wide Association Study) 结果，并且您可以将分析限制在无亲缘关系的个体中。主要目标是设计并分析一个阴性对照 MR，通过检验 $G$ 是否对 $Y^{\\ast}$ 没有因果效应，来评估这些遗传工具变量是否可能满足对 $Y$ 的排他性限制。\n\n哪种分析计划最恰当地实施了这种阴性对照 MR，既符合基本原则，又能产生关于工具变量有效性的可解释证据？\n\nA. 采用单样本设计，在意外死亡队列中根据 $G$ 计算加权多基因评分，并拟合 $Y^{\\ast}$ 对多基因评分的逻辑回归，同时校正 LDL-C、年龄、性别和主成分。如果 $p$ 值超过 $0.05$，则宣告成功，并将无关联解释为有效性的证明。\n\nB. 采用双样本 MR 设计，使用非重叠样本：选择独立的 LDL-C SNPs $G$（经过连锁不平衡 (LD; Linkage Disequilibrium) 修剪），协调等位基因，并使用逆方差加权 (IVW; Inverse-Variance Weighted) 估计量作为主要方法来估计 $G$–$Y^{\\ast}$ 的因果效应，并辅以孟德尔随机化-Egger (MR-Egger; Mendelian randomization-Egger)、加权中位数和留一法分析。将分析限制在单一血统，并校正 $G$–表型关联中的群体结构（例如，主成分 (PCs; Principal Components)）。使用 MR-Egger 截距评估水平多效性，使用 Cochran’s $Q$ 检验评估异质性。使用 Steiger 方向性检验确保 $G$ 解释的 $X$ 方差多于其解释的 $Y^{\\ast}$ 方差。如果 $G$–$Y^{\\ast}$ 的因果估计在所有敏感性分析中均为空值，并且没有证据表明存在不平衡的多效性，则得出结论，这些工具变量通过了阴性对照检验，从而支持了对血管结局的排他性限制。\n\nC. 拟合 $Y^{\\ast}$ 对 LDL-C 多基因评分的回归，同时校正吸烟和教育以消除已测量的混杂因素，允许 LDL-C 和意外死亡队列之间存在样本重叠以最大化统计功效，并将不显著的关联解释为工具变量有效的证据。\n\nD. 为了最大化统计功效，纳入所有与 LDL-C 相关的 SNPs，无论其关联强度或 LD 如何，创建一个全基因组多基因评分，并检验其与 $Y^{\\ast}$ 的关联。如果检测到任何关联，将其归因于 $Y^{\\ast}$ 中的选择偏倚或对撞偏倚，并继续使用这些工具变量于 $Y$，而不进行进一步的敏感性分析。\n\nE. 跳过阴性对照，转而在双样本 MR 中仅使用 IVW 验证 $G$ 是否与阳性对照结局（例如，$Y$）相关；如果效应显著，则推断 $G$ 对所有下游应用（包括血管结局）均有效。",
            "solution": "问题陈述要求为一项阴性对照孟德尔随机化 (MR) 研究提供最合适的分析计划。目标是使用一个阴性对照结局，$Y^{\\ast}$（意外死亡），来评估用于暴露 $X$（LDL-C）的遗传工具变量 $G$ 在研究主要结局 $Y$（血管疾病）时的有效性。具体来说，我们要评估排他性限制假设的合理性。\n\n在继续之前，必须验证问题陈述的有效性。\n\n**步骤 1：提取已知条件**\n-   遗传工具变量 ($G$)：一组与 LDL-C 有强关联的单核苷酸多态性 (SNPs)。\n-   暴露 ($X$)：低密度脂蛋白胆固醇 (LDL-C)。\n-   主要结局 ($Y$)：血管结局（例如，冠状动脉疾病）。\n-   阴性对照结局 ($Y^{\\ast}$)：意外死亡，假设不受 $X$ 的因果影响。\n-   可用数据：来自主要为欧洲血统的大型队列的 $X$ 和 $Y^{\\ast}$ 的汇总水平全基因组关联研究 (GWAS) 结果。分析可限于无亲缘关系的个体。\n-   目标：设计一个阴性对照 MR，检验 $G$ 是否对 $Y^{\\ast}$ 存在因果效应，以评估 $G \\rightarrow X \\rightarrow Y$ 分析中排他性限制假设的合理性。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题具有科学依据。孟德尔随机化是进行因果推断的有效方法。使用阴性对照结局是检测 MR 假设违规（尤其是排他性限制，该限制在其他情况下无法检验）的一种标准且重要的技术。选择 LDL-C、血管结局和意外死亡具有生物学合理性。问题提法得当，提供了足够的信息（汇总水平的 GWAS 数据，明确的暴露/结局）来设计一个标准的双样本 MR 研究。没有内部矛盾、不切实际的要求或含糊不清之处。语言精确客观。\n\n**步骤 3：结论与行动**\n问题有效。我们将继续从基本原则推导正确的方法论，并评估给定的选项。\n\n**从基本原则推导正确的方法论**\n\n用遗传工具变量 $G$ 估计暴露 $X$ 对结局 $Y$ 的因果效应的有效性，取决于三个核心假设：\n1.  **相关性 (IV1)：** 工具变量 $G$ 必须与暴露 $X$ 相关。形式上，$G \\not\\perp X$。\n2.  **排他性限制 (IV2)：** 工具变量 $G$ 除了通过暴露 $X$ 之外，不得通过任何其他途径影响结局 $Y$。形式上，$G \\perp Y | X, U$，其中 $U$ 代表所有混杂因素。一个常见的违规情况是水平多效性，即 $G$ 对 $Y$ 有直接影响。\n3.  **独立性 (IV3)：** 工具变量 $G$ 必须独立于任何使 $X$ 和 $Y$ 之间的传统观察性关联产生偏倚的未测量混杂因素 $U$。形式上，$G \\perp U$。\n\n排他性限制 (IV2) 是最难验证的假设。阴性对照实验提供了一个部分检验。我们选择一个阴性对照结局 $Y^{\\ast}$，已知 $X$ 对其的因果效应为零。如果我们对 $X$ 和 $Y^{\\ast}$ 进行 MR 分析，只要工具变量 $G$ 有效，估计的因果效应应为空值。\n\n在双样本 MR 设置中，因果估计值由 SNP-结局关联 ($\\hat{\\beta}_{GY^{\\ast}}$) 与 SNP-暴露关联 ($\\hat{\\beta}_{GX}}$) 的比率得出。如果我们观察到 $G$ 对 $Y^{\\ast}$ 有统计学上显著的非零效应，这不可能是由 $X$ 介导的（因为真实的 $X \\rightarrow Y^{\\ast}$ 效应为零）。因此，这个非零效应必定源于对 $G \\rightarrow Y^{\\ast}$ 分析的 MR 假设的违背，最可能是一个绕过 $X$ 的多效性通路 ($G \\rightarrow Y^{\\ast}$)。由于水平多效性是遗传变异本身的特征，其在 $G \\rightarrow Y^{\\ast}$ 分析中的存在强烈暗示它也将在主要的 $G \\rightarrow Y$ 分析中存在，从而使工具变量无效。\n\n使用所提供的汇总水平 GWAS 数据进行稳健的分析计划必须包括：\n-   一个**双样本 MR 设计**，对 $G-X$ 和 $G-Y^{\\ast}$ 的关联使用非重叠样本以防止偏倚。\n-   仔细的**工具变量选择**：SNPs 必须与暴露强相关 ($p  5 \\times 10^{-8}$) 并经过连锁不平衡 (LD) 修剪以确保它们是独立的。\n-   **数据协调**：两个 GWAS 汇总数据集之间的等位基因及其效应大小必须正确对齐。\n-   一个**主要分析方法**，通常是逆方差加权 (IVW) MR，它在无多效性或平衡多效性的假设下提供最高的统计功效。\n-   一套全面的**敏感性分析**来检测和解释多效性。这包括：\n    -   **MR-Egger 回归**：其截距为方向性（不平衡）多效性提供了一个正式的检验。\n    -   **加权中位数估计量**：如果高达 $50\\%$ 的工具变量无效，它能提供一个稳健的估计。\n    -   **异质性检验**：Cochran's $Q$ 统计量检验来自单个 SNP 的因果估计值的变异性，这是多效性的一个指标。\n    -   **留一法分析**：识别有影响力的 SNPs。\n-   **额外的质量控制**，例如 **Steiger 方向性检验**，以确认工具变量解释的暴露 $X$ 的方差多于结局 $Y^{\\ast}$ 的方差，如果因果方向是 $G \\rightarrow X \\rightarrow Y^{\\ast}$，这是预期的。\n-   **控制群体分层**，通过将分析限制在单一血统，并使用已针对群体结构（例如，通过主成分）进行调整的汇总统计数据。\n-   **谨慎的解释**：在所有分析中，$G-Y^{\\ast}$ 关联的空发现*支持*但不能明确*证明*工具变量的有效性。一个显著的发现会严重质疑这些工具变量。\n\n**评估选项**\n\n**A. 采用单样本设计，在意外死亡队列中根据 $G$ 计算加权多基因评分，并拟合 $Y^{\\ast}$ 对多基因评分的逻辑回归，同时校正 LDL-C、年龄、性别和主成分。如果 $p$ 值超过 $0.05$，则宣告成功，并将无关联解释为有效性的证明。**\n这种方法存在根本性缺陷。在结局对工具变量的回归中校正暴露 (LDL-C) 是一个严重错误。这种条件化阻断了 MR 设计用来利用的因果通路 ($G \\rightarrow X \\rightarrow Y^{\\ast}$) 并引入了对撞偏倚。此外，将大于 $0.05$ 的 $p$ 值解释为有效性的“证明”是对统计假设检验的天真和不正确的应用。\n**结论：不正确。**\n\n**B. 采用双样本 MR 设计，使用非重叠样本：选择独立的 LDL-C SNPs $G$（经过连锁不平衡 (LD) 修剪），协调等位基因，并使用逆方差加权 (IVW) 估计量作为主要方法来估计 $G$–$Y^{\\ast}$ 的因果效应，并辅以孟德尔随机化-Egger (MR-Egger)、加权中位数和留一法分析。将分析限制在单一血统，并校正 $G$–表型关联中的群体结构（例如，主成分 (PCs)）。使用 MR-Egger 截距评估水平多效性，使用 Cochran’s $Q$ 检验评估异质性。使用 Steiger 方向性检验确保 $G$ 解释的 $X$ 方差多于其解释的 $Y^{\\ast}$ 方差。如果 $G$–$Y^{\\ast}$ 的因果估计在所有敏感性分析中均为空值，并且没有证据表明存在不平衡的多效性，则得出结论，这些工具变量通过了阴性对照检验，从而支持了对血管结局的排他性限制。**\n该选项细致地描述了当前双样本汇总数据 MR 分析的最佳实践。它正确地指明了使用非重叠样本、适当的工具变量选择、数据协调、主要的 IVW 分析，以及一套完整的敏感性分析（MR-Egger、加权中位数、异质性、留一法）来严格检验多效性。它还包括了关键的质量控制步骤，如 Steiger 检验和对群体结构的控制。最终的解释是适当谨慎的，指出一个空结果“支持”该假设，而不是证明它。\n**结论：正确。**\n\n**C. 拟合 $Y^{\\ast}$ 对 LDL-C 多基因评分的回归，同时校正吸烟和教育以消除已测量的混杂因素，允许 LDL-C 和意外死亡队列之间存在样本重叠以最大化统计功效，并将不显著的关联解释为工具变量有效的证据。**\n这个选项包含多个错误。首先，在双样本 MR 设计中允许显著的样本重叠会引入偏向于混杂的观察性估计的偏倚，尤其是在使用弱工具变量时；这违背了设计的初衷。虽然存在校正重叠的方法，但建议为了“最大化统计功效”而允许重叠是糟糕的建议。其次，它忽略了检测多效性所需的关键的敏感性分析套件。第三，解释再次过于简单化。\n**结论：不正确。**\n\n**D. 为了最大化统计功效，纳入所有与 LDL-C 相关的 SNPs，无论其关联强度或 LD 如何，创建一个全基因组多基因评分，并检验其与 $Y^{\\ast}$ 的关联。如果检测到任何关联，将其归因于 $Y^{\\ast}$ 中的选择偏倚或对撞偏倚，并继续使用这些工具变量于 $Y$，而不进行进一步的敏感性分析。**\n这个提议在科学上是站不住脚的。包含弱工具变量会使 MR 估计产生偏倚。包含处于 LD 中的 SNPs 违反了标准 MR 估计量的独立性假设，导致不正确的标准误。最过分的是，该计划是进行一个测试，然后如果测试揭示了问题（一个非空关联），就将其归因于其他一些没有证据的偏倚而忽略结果，并继续使用有缺陷的工具变量。这代表了对科学方法的蓄意漠视。\n**结论：不正确。**\n\n**E. 跳过阴性对照，转而在双样本 MR 中仅使用 IVW 验证 $G$ 是否与阳性对照结局（例如，$Y$）相关；如果效应显著，则推断 $G$ 对所有下游应用（包括血管结局）均有效。**\n这个选项完全没有抓住问题的要点。它提议的是一个阳性对照实验，而不是阴性对照。阳性对照可以确认研究有足够的统计功效，但无法检验排他性限制假设。一个多效性的工具变量可以轻易地在阳性对照结局上产生显著效应。仅依赖 IVW 是不够的，从单个阳性结果推断普遍有效性是一种危险的过度简化。\n**结论：不正确。**\n\n总而言之，只有选项 B 为阴性对照 MR 研究提出了一个方法学上健全、全面且解释正确的计划。",
            "answer": "$$\\boxed{B}$$"
        }
    ]
}