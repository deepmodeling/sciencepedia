{
    "hands_on_practices": [
        {
            "introduction": "诊断检验的效用不仅取决于其固有的灵敏度（sensitivity）和特异度（specificity），还取决于其应用场景。本练习将通过一个具体的计算任务，揭示疾病患病率（prevalence）如何深刻影响阳性预测值（PPV）和阴性预测值（NPV）。通过从贝叶斯定理（Bayes' theorem）等第一性原理出发进行推导和计算，你将切实理解为何同一个检验在高风险人群中表现优异，而在低风险人群中则可能效果不佳。",
            "id": "4607798",
            "problem": "一位研究者使用一个固定的决策阈值来评估一种疾病的二元诊断测试，该阈值对应于受试者工作特征(ROC)曲线上的单个操作点。在此阈值下，该测试的灵敏度为 $ \\text{Se} = 0.80 $，特异度为 $ \\text{Sp} = 0.95 $。考虑两个患病率分别为 $ p = 0.05 $ 和 $ p = 0.50 $ 的人群。仅从灵敏度、特异度、患病率、似然比(LR)的定义以及比值形式的贝叶斯定理出发，推导在每种患病率下阳性预测值(PPV)和阴性预测值(NPV)的表达式。计算当 $ p = 0.05 $ 和 $ p = 0.50 $ 时的 $ \\text{PPV} $ 和 $ \\text{NPV} $。为总结患病率对阳性结果的验后概率的影响，报告比率 $ r = \\dfrac{\\text{PPV at } p = 0.50}{\\text{PPV at } p = 0.05} $。将您最终报告的 $ r $ 值四舍五入到四位有效数字。以单个无量纲数的形式提供您的最终答案。",
            "solution": "该问题要求基于基本定义和贝叶斯定理，在两种不同疾病患病率下，推导并计算一个诊断测试的阳性预测值(PPV)和阴性预测值(NPV)。最终目标是计算PPV的比率。\n\n首先，我们正式定义所涉及的事件和概率。\n设 $D$ 为个体患有该疾病的事件。\n设 $D^c$ 为个体未患该疾病的事件。\n设 $T^+$ 为测试结果为阳性的事件。\n设 $T^-$ 为测试结果为阴性的事件。\n\n给定的量为：\n- 灵敏度($\\text{Se}$): 在患有疾病的情况下，测试结果为阳性的概率。\n$$ \\text{Se} = P(T^+ | D) = 0.80 $$\n- 特异度($\\text{Sp}$): 在未患疾病的情况下，测试结果为阴性的概率。\n$$ \\text{Sp} = P(T^- | D^c) = 0.95 $$\n- 患病率($p$): 患有该疾病的先验概率。\n$$ p = P(D) $$\n我们给定了两种患病率：$p_1 = 0.05$ 和 $p_2 = 0.50$。\n\n需要推导的量为：\n- 阳性预测值($\\text{PPV}$): 在测试结果为阳性的情况下，患有该疾病的验后概率。\n$$ \\text{PPV} = P(D | T^+) $$\n- 阴性预测值($\\text{NPV}$): 在测试结果为阴性的情况下，未患该疾病的验后概率。\n$$ \\text{NPV} = P(D^c | T^-) $$\n\n问题指导我们使用比值形式的贝叶斯定理，该定理指出，后验比值等于先验比值乘以似然比。\n$$ \\text{Posterior Odds} = \\text{Likelihood Ratio} \\times \\text{Prior Odds} $$\n\n**PPV的推导**\n\n对于阳性测试结果($T^+$)，我们关心的是疾病的后验概率 $P(D|T^+)$。疾病的先验比值是患病概率与不患病概率之比：\n$$ \\text{Odds}_{\\text{pre}} = \\frac{P(D)}{P(D^c)} = \\frac{p}{1-p} $$\n阳性测试后的疾病后验比值为：\n$$ \\text{Odds}_{\\text{post}}(T^+) = \\frac{P(D | T^+)}{P(D^c | T^+)} $$\n相关的似然比是阳性似然比($\\text{LR}^+$)，定义为患病组中测试结果为阳性的概率与非患病组中测试结果为阳性的概率之比：\n$$ \\text{LR}^+ = \\frac{P(T^+ | D)}{P(T^+ | D^c)} $$\n我们知道 $P(T^+ | D) = \\text{Se}$。分母是 $P(T^+ | D^c) = 1 - P(T^- | D^c) = 1 - \\text{Sp}$。\n因此，\n$$ \\text{LR}^+ = \\frac{\\text{Se}}{1 - \\text{Sp}} $$\n应用比值形式的贝叶斯定理：\n$$ \\text{Odds}_{\\text{post}}(T^+) = \\text{LR}^+ \\times \\text{Odds}_{\\text{pre}} = \\left( \\frac{\\text{Se}}{1 - \\text{Sp}} \\right) \\left( \\frac{p}{1 - p} \\right) $$\n为了求出PPV，我们将后验比值转换回概率。对于任何事件 $A$，其比值为 $\\text{Odds}(A) = P(A) / (1-P(A))$，其概率为 $P(A) = \\text{Odds}(A) / (1 + \\text{Odds}(A))$。\n$$ \\text{PPV} = \\frac{\\text{Odds}_{\\text{post}}(T^+)}{1 + \\text{Odds}_{\\text{post}}(T^+)} $$\n\n**NPV的推导**\n\n对于阴性测试结果($T^-$)，我们关心的是未患病的后验概率 $P(D^c|T^-)$。我们可以用*不*患病比值来构建这个公式。不患病的先验比值为：\n$$ \\text{Odds}_{\\text{pre}}(D^c) = \\frac{P(D^c)}{P(D)} = \\frac{1-p}{p} $$\n阴性测试后不患病的后验比值为：\n$$ \\text{Odds}_{\\text{post}}(D^c | T^-) = \\frac{P(D^c | T^-)}{P(D | T^-)} $$\n相关的似然比描述了阴性测试为疾病不存在提供的证据。这个比值是 $\\frac{P(T^-|D^c)}{P(T^-|D)}$。\n我们知道 $P(T^-|D^c) = \\text{Sp}$。分母是 $P(T^-|D) = 1 - P(T^+|D) = 1 - \\text{Se}$。\n给定阴性测试下无疾病的似然比是：$\\frac{\\text{Sp}}{1 - \\text{Se}}$。注意，这是阴性似然比 $\\text{LR}^- = \\frac{1-\\text{Se}}{\\text{Sp}}$ 的倒数。\n对不患病比值应用贝叶斯定理：\n$$ \\text{Odds}_{\\text{post}}(D^c | T^-) = \\left( \\frac{\\text{Sp}}{1 - \\text{Se}} \\right) \\left( \\frac{1-p}{p} \\right) $$\n将这些后验比值转换为概率NPV：\n$$ \\text{NPV} = \\frac{\\text{Odds}_{\\text{post}}(D^c | T^-)}{1 + \\text{Odds}_{\\text{post}}(D^c | T^-)} $$\n\n**计算**\n\n首先，使用给定的值 $\\text{Se} = 0.80$ 和 $\\text{Sp} = 0.95$ 计算似然比。\n$$ \\text{LR}^+ = \\frac{0.80}{1 - 0.95} = \\frac{0.80}{0.05} = 16 $$\n用于NPV推导的似然比是：\n$$ \\frac{\\text{Sp}}{1 - \\text{Se}} = \\frac{0.95}{1 - 0.80} = \\frac{0.95}{0.20} = 4.75 = \\frac{19}{4} $$\n\n**情况1：患病率 $p = 0.05$**\n\n疾病的先验比值：\n$$ \\text{Odds}_{\\text{pre},1} = \\frac{0.05}{1 - 0.05} = \\frac{0.05}{0.95} = \\frac{5}{95} = \\frac{1}{19} $$\n给定阳性测试的疾病后验比值：\n$$ \\text{Odds}_{\\text{post},1}(T^+) = \\text{LR}^+ \\times \\text{Odds}_{\\text{pre},1} = 16 \\times \\frac{1}{19} = \\frac{16}{19} $$\n当 $p=0.05$ 时的 PPV：\n$$ \\text{PPV}_1 = \\frac{16/19}{1 + 16/19} = \\frac{16/19}{35/19} = \\frac{16}{35} $$\n无疾病的先验比值：\n$$ \\text{Odds}_{\\text{pre},1}(D^c) = \\frac{1-0.05}{0.05} = \\frac{0.95}{0.05} = 19 $$\n给定阴性测试的无疾病后验比值：\n$$ \\text{Odds}_{\\text{post},1}(D^c | T^-) = \\left( \\frac{\\text{Sp}}{1 - \\text{Se}} \\right) \\times \\text{Odds}_{\\text{pre},1}(D^c) = \\frac{19}{4} \\times 19 = \\frac{361}{4} $$\n当 $p=0.05$ 时的 NPV：\n$$ \\text{NPV}_1 = \\frac{361/4}{1 + 361/4} = \\frac{361/4}{365/4} = \\frac{361}{365} $$\n\n**情况2：患病率 $p = 0.50$**\n\n疾病的先验比值：\n$$ \\text{Odds}_{\\text{pre},2} = \\frac{0.50}{1 - 0.50} = \\frac{0.50}{0.50} = 1 $$\n给定阳性测试的疾病后验比值：\n$$ \\text{Odds}_{\\text{post},2}(T^+) = \\text{LR}^+ \\times \\text{Odds}_{\\text{pre},2} = 16 \\times 1 = 16 $$\n当 $p=0.50$ 时的 PPV：\n$$ \\text{PPV}_2 = \\frac{16}{1 + 16} = \\frac{16}{17} $$\n无疾病的先验比值：\n$$ \\text{Odds}_{\\text{pre},2}(D^c) = \\frac{1-0.50}{0.50} = 1 $$\n给定阴性测试的无疾病后验比值：\n$$ \\text{Odds}_{\\text{post},2}(D^c | T^-) = \\left( \\frac{\\text{Sp}}{1 - \\text{Se}} \\right) \\times \\text{Odds}_{\\text{pre},2}(D^c) = \\frac{19}{4} \\times 1 = \\frac{19}{4} $$\n当 $p=0.50$ 时的 NPV：\n$$ \\text{NPV}_2 = \\frac{19/4}{1 + 19/4} = \\frac{19/4}{23/4} = \\frac{19}{23} $$\n\n**预测值总结：**\n当 $p=0.05$ 时：$\\text{PPV}_1 = \\frac{16}{35} \\approx 0.4571$, $\\text{NPV}_1 = \\frac{361}{365} \\approx 0.9890$\n当 $p=0.50$ 时：$\\text{PPV}_2 = \\frac{16}{17} \\approx 0.9412$, $\\text{NPV}_2 = \\frac{19}{23} \\approx 0.8261$\n\n**最终计算：比率 $r$**\n\n问题要求计算比率 $r = \\dfrac{\\text{PPV at } p = 0.50}{\\text{PPV at } p = 0.05}$。\n$$ r = \\frac{\\text{PPV}_2}{\\text{PPV}_1} = \\frac{16/17}{16/35} = \\frac{16}{17} \\times \\frac{35}{16} = \\frac{35}{17} $$\n现在，我们计算其数值并将结果四舍五入到四位有效数字。\n$$ r = \\frac{35}{17} \\approx 2.0588235... $$\n四舍五入到四位有效数字得到 $2.059$。",
            "answer": "$$\\boxed{2.059}$$"
        },
        {
            "introduction": "在评估了单一决策阈值下的检验性能后，我们进一步学习如何评估检验在所有可能阈值下的整体表现。ROC曲线下面积（Area Under the ROC Curve, AUC）是衡量检验区分患者与非患者总体能力的综合指标。这项编程练习将通过将其与直观的概率意义——即随机选择的患者其检验值高于随机选择的非患者的概率——联系起来，为你揭开AUC的神秘面纱，亲手实现其非参数计算将加深你对这一核心概念的理解。",
            "id": "4607911",
            "problem": "给定来自两个独立组的经验性诊断标志物测量值：疾病病例组和非疾病对照组。基本原理如下。对于一个阈值 $t$，灵敏度（真阳性率）定义为 $\\mathrm{TPR}(t) = \\mathbb{P}(X_1 \\ge t)$，特异度定义为 $\\mathrm{TNR}(t) = \\mathbb{P}(X_0  < t)$，其中 $X_1$ 表示病例组中的标志物，而 $X_0$ 表示对照组中的标志物。受试者工作特征 (ROC) 曲线是映射 $t \\mapsto (\\mathrm{FPR}(t), \\mathrm{TPR}(t))$，其中 $\\mathrm{FPR}(t) = 1 - \\mathrm{TNR}(t) = \\mathbb{P}(X_0 \\ge t)$。曲线下面积 (AUC) 概括了所有阈值下的 ROC 曲线，是衡量病例组和对照组之间区分度的一个指标。\n\n仅从这些定义出发，推导出一个算法，用于计算 AUC 的非参数估计，该算法仅使用病例组和对照组的经验性标志物值，而不对 $X_1$ 或 $X_0$ 作任何参数分布假设。当病例和对照之间出现相等的标志物值时，您的算法还必须提供一个对数据中的结（ties）进行校正的版本。\n\n您的程序必须从第一性原理出发实现以下两者：\n- 一个朴素的非参数 AUC 估计，它将标志物值相等的病例-对照对视为贡献零区分度。\n- 一个经结校正的非参数 AUC 估计，它为标志物值相等的对分配一半的区分度贡献。\n\n使用以下测试套件，每个测试用例包含 $n_1 = 50$ 个病例值和 $n_0 = 60$ 个对照值：\n\n- 测试用例 1 (有重叠但无结)：\n  - 对照组：$C_i = i$，其中 $i \\in \\{0,1,2,\\dots,59\\}$。\n  - 病例组：$D_j = j + 0.5$，其中 $j \\in \\{20,21,\\dots,69\\}$。\n  这会产生在 $\\{20.5,21.5,\\dots,69.5\\}$ 内的病例值和在 $\\{0,1,\\dots,59\\}$ 内的对照值，因此存在重叠，但任何病例和对照值之间都没有完全相等的情况。\n\n- 测试用例 2 (有重叠且有结)：\n  - 对照组：$C_i = i$，其中 $i \\in \\{0,1,2,\\dots,59\\}$。\n  - 病例组：$D_j = j$，其中 $j \\in \\{20,21,\\dots,69\\}$。\n  这会产生在 $\\{20,21,\\dots,69\\}$ 内的病例值和在 $\\{0,1,\\dots,59\\}$ 内的对照值，因此在从 $20$ 到 $59$ 的所有整数上都存在结。\n\n- 测试用例 3 (完全为结的边缘情况)：\n  - 对照组：$C_i = 50$，其中 $i \\in \\{1,2,\\dots,60\\}$。\n  - 病例组：$D_j = 50$，其中 $j \\in \\{1,2,\\dots,50\\}$。\n  所有病例和对照的值都相等。\n\n对于每个测试用例，您的输出必须是一个包含两个小数的列表：$\\left[\\text{AUC}_{\\text{naive}}, \\text{AUC}_{\\text{tie-corrected}}\\right]$，其中两个条目都是上面定义的非参数估计值。将所有值表示为小数（而非百分比），并四舍五入到六位小数。\n\n最终输出格式：您的程序应生成单行文本，其中包含三个测试用例的结果，格式为方括号括起来的、由逗号分隔的列表之列表，例如 $\\left[[a_1,b_1],[a_2,b_2],[a_3,b_3]\\right]$，其中 $a_k$ 和 $b_k$ 是测试用例 $k$ 的两个 AUC 估计值。不应打印任何其他文本。",
            "solution": "该问题要求推导并实现一个非参数算法来计算受试者工作特征曲线下面积 (AUC)，包括处理结值的版本。\n\n### 从第一性原理推导\n\n曲线下面积 (AUC) 是衡量诊断测试整体性能的指标。从几何上看，它是受试者工作特征 (ROC) 曲线下的面积，该曲线绘制了在所有可能的阈值 $t$ 下，真阳性率 (TPR) 相对于假阳性率 (FPR) 的关系。提供的定义如下：\n- 真阳性率 (灵敏度)：$\\mathrm{TPR}(t) = \\mathbb{P}(X_1 \\ge t)$，其中 $X_1$ 是疾病病例的标志物值。\n- 假阳性率：$\\mathrm{FPR}(t) = \\mathbb{P}(X_0 \\ge t)$，其中 $X_0$ 是非疾病对照的标志物值。\n\nAUC 是 ROC 曲线 $y(x)$ 从 0 到 1 对 $x$ 的积分：\n$$ \\mathrm{AUC} = \\int_0^1 \\mathrm{TPR} \\, d(\\mathrm{FPR}) $$\n$\\mathrm{TPR}$ 和 $\\mathrm{FPR}$ 都是阈值 $t$ 的函数。为了推导，我们假设 $X_1$ 和 $X_0$ 是连续随机变量，其概率密度函数 (PDF) 分别为 $f_1(t)$ 和 $f_0(t)$。然而，最终的算法将不依赖于此假设。\n\n在连续性假设下，$\\mathrm{FPR}(t) = \\int_t^\\infty f_0(u) \\, du$。其微分为 $d(\\mathrm{FPR}) = \\frac{d}{dt} \\left( \\int_t^\\infty f_0(u) \\, du \\right) dt = -f_0(t) \\, dt$。\n当阈值 $t$ 从 $-\\infty$ 扫到 $+\\infty$ 时，$\\mathrm{FPR}(t)$ 从 $1$ 扫到 $0$。我们将积分变量从 $\\mathrm{FPR}$ 更改为 $t$：\n$$ \\mathrm{AUC} = \\int_{t=+\\infty}^{t=-\\infty} \\mathrm{TPR}(t) (-f_0(t)) \\, dt = \\int_{-\\infty}^{+\\infty} \\mathrm{TPR}(t) f_0(t) \\, dt $$\n代入定义 $\\mathrm{TPR}(t) = \\mathbb{P}(X_1 \\ge t) = \\int_t^\\infty f_1(u) \\, du$：\n$$ \\mathrm{AUC} = \\int_{-\\infty}^{+\\infty} \\left( \\int_t^\\infty f_1(u) \\, du \\right) f_0(t) \\, dt $$\n这是一个在由 $-\\infty < t < \\infty$ 和 $t \\le u < \\infty$ 定义的区域上的二重积分。我们可以将其重写为：\n$$ \\mathrm{AUC} = \\iint_{u \\ge t} f_1(u) f_0(t) \\, du \\, dt $$\n由于 $X_1$ 和 $X_0$ 是独立的，它们的联合 PDF 是 $f_1(u)f_0(t)$。该积分表示随机选择的 $X_1$ 值（表示为 $u$）大于或等于随机选择的 $X_0$ 值（表示为 $t$）的概率。对于连续变量，$\\mathbb{P}(X_1=X_0)=0$，因此这可以简化。于是，我们得到了 AUC 深刻的概率解释：\n$$ \\mathrm{AUC} = \\mathbb{P}(X_1 > X_0) $$\n该结果表明，AUC 是随机选择的病例的标志物值高于随机选择的对照的标志物值的概率。这一解释是构建非参数估计量的关键。\n\n### 非参数估计\n\n给定 $n_1$ 个病例值的经验样本 $\\{d_1, d_2, \\dots, d_{n_1}\\}$ 和 $n_0$ 个对照值的经验样本 $\\{c_1, c_2, \\dots, c_{n_0}\\}$，我们可以直接估计这个概率。我们构成所有 $n_1 \\times n_0$ 个可能的病例-对照对 $(d_j, c_i)$，并计算满足所需条件的对的比例。\n\n**1. 朴素非参数 AUC 估计**\n\n问题要求一种估计方法，其中结对区分度的贡献为零。这直接对应于估计 $\\mathbb{P}(X_1 > X_0)$。我们计算病例值严格大于对照值的对的数量。设 $\\mathbf{1}_{d_j > c_i}$ 为一个指示函数，当 $d_j > c_i$ 时为 $1$，否则为 $0$。估计值为：\n$$ \\widehat{\\mathrm{AUC}}_{\\text{naive}} = \\frac{1}{n_1 n_0} \\sum_{j=1}^{n_1} \\sum_{i=1}^{n_0} \\mathbf{1}_{d_j > c_i} $$\n\n**2. 经结校正的非参数 AUC 估计**\n\n当标志物值为离散值或以有限精度测量时，可能会出现结 ($d_j = c_i$)。问题指明，对于经结校正的估计，结对获得“一半贡献”。此方法估计了一致性概率更普遍的形式，即 $\\mathbb{P}(X_1 > X_0) + 0.5 \\cdot \\mathbb{P}(X_1 = X_0)$。\n\n我们定义一个评分函数 $S(d_j, c_i)$：\n$$ S(d_j, c_i) = \\begin{cases} 1 & \\text{如果 } d_j > c_i \\\\ 0.5 & \\text{如果 } d_j = c_i \\\\ 0 & \\text{如果 } d_j < c_i \\end{cases} $$\n经结校正的 AUC 估计是所有对的平均得分：\n$$ \\widehat{\\mathrm{AUC}}_{\\text{tie-corrected}} = \\frac{1}{n_1 n_0} \\sum_{j=1}^{n_1} \\sum_{i=1}^{n_0} S(d_j, c_i) $$\n这是 AUC 的标准非参数定义，等同于 Mann-Whitney U 统计量除以总对数。\n\n### 算法实现\n\n该算法直接源于这些估计公式。对于给定的病例值和对照值数组：\n1. 初始化两个计数器 `numerator_naive` 和 `numerator_tie_corrected` 为 $0$。\n2. 遍历病例数据中的每个病例值 $d_j$。\n3. 对于每个 $d_j$，遍历对照数据中的每个对照值 $c_i$。\n4.  比较 $d_j$ 和 $c_i$：\n    - 如果 $d_j > c_i$，将 `numerator_naive` 增加 $1$，`numerator_tie_corrected` 增加 $1$。\n    - 如果 $d_j = c_i$，将 `numerator_tie_corrected` 增加 $0.5$。\n    - 如果 $d_j < c_i$，不执行任何操作。\n5. 循环完成后，计算总对数 $N_{pairs} = n_1 \\times n_0$。\n6. 计算最终估计值：\n   - $\\widehat{\\mathrm{AUC}}_{\\text{naive}} = \\text{numerator\\_naive} / N_{pairs}$\n   - $\\widehat{\\mathrm{AUC}}_{\\text{tie-corrected}} = \\text{numerator\\_tie\\_corrected} / N_{pairs}$\n7. 将结果四舍五入到所需的小数位数（六位）。\n\n该算法是非参数的，因为它仅使用数据的秩，而不使用其具体值或任何假定的底层分布。它具有鲁棒性，并直接实现了所推导的原理。",
            "answer": "```python\nimport numpy as np\n\ndef calculate_auc(cases, controls):\n    \"\"\"\n    Computes nonparametric AUC estimates based on pairwise comparisons.\n\n    Args:\n        cases (array-like): A list or numpy array of marker values for the case group.\n        controls (array-like): A list or numpy array of marker values for the control group.\n\n    Returns:\n        A list containing two floats:\n        - The naive AUC estimate (ties count as 0).\n        - The tie-corrected AUC estimate (ties count as 0.5).\n    \"\"\"\n    n1 = len(cases)\n    n0 = len(controls)\n\n    if n1 == 0 or n0 == 0:\n        return [0.0, 0.0]\n\n    numerator_naive = 0\n    numerator_tie_corrected = 0.0\n\n    # Iterate through all case-control pairs\n    for d_val in cases:\n        for c_val in controls:\n            if d_val > c_val:\n                numerator_naive += 1\n                numerator_tie_corrected += 1.0\n            elif d_val == c_val:\n                numerator_tie_corrected += 0.5\n    \n    denominator = n1 * n0\n    \n    auc_naive = numerator_naive / denominator\n    auc_tie_corrected = numerator_tie_corrected / denominator\n    \n    return [auc_naive, auc_tie_corrected]\n\ndef solve():\n    \"\"\"\n    Defines the test cases, computes AUC for each, and prints the formatted result.\n    \"\"\"\n    # Test case 1: Overlap without ties\n    # n1 = 50, n0 = 60\n    controls1 = np.arange(60, dtype=float)  # C_i = i for i in {0, ..., 59}\n    cases1 = np.arange(20, 70, dtype=float) + 0.5  # D_j = j + 0.5 for j in {20, ..., 69}\n\n    # Test case 2: Overlap with ties\n    # n1 = 50, n0 = 60\n    controls2 = np.arange(60, dtype=float)  # C_i = i for i in {0, ..., 59}\n    cases2 = np.arange(20, 70, dtype=float)  # D_j = j for j in {20, ..., 69}\n\n    # Test case 3: Complete tie edge case\n    # n1 = 50, n0 = 60\n    controls3 = np.full(60, 50.0)\n    cases3 = np.full(50, 50.0)\n\n    test_cases = [\n        (cases1, controls1),\n        (cases2, controls2),\n        (cases3, controls3)\n    ]\n\n    results = []\n    for case in test_cases:\n        cases, controls = case\n        result = calculate_auc(cases, controls)\n        results.append(result)\n\n    # Format the output string as per the problem specification.\n    # e.g., [[a1,b1],[a2,b2],[a3,b3]] with 6 decimal places.\n    outer_list_str = []\n    for res_pair in results:\n        # Format each float to 6 decimal places.\n        inner_list_str = f\"[{res_pair[0]:.6f},{res_pair[1]:.6f}]\"\n        outer_list_str.append(inner_list_str)\n    \n    final_output = f\"[{','.join(outer_list_str)}]\"\n    \n    print(final_output)\n\nsolve()\n```"
        },
        {
            "introduction": "最后，我们将探讨AUC的局限性，并引入一个更贴近临床决策的评估指标。本练习设计了一个情景，其中两个模型具有完全相同的区分能力（AUC），但其校准度（calibration）却不同。通过计算净获益（Net Benefit），一个根据临床决策阈值权衡真阳性和假阳性的指标，你将理解为何一个校准良好的模型对于在实践中做出最优决策至关重要，从而连接起统计评估与真实世界临床效用之间的桥梁。",
            "id": "4607812",
            "problem": "一项流行病学研究考虑了两个二元结局预测模型，这两个模型在一个由 $N=20$ 名个体（索引为 $i=1,\\dots,20$）组成的队列上进行评估。对于模型 $A$，给出了预测概率 $p_{A,i}$ 和观测结局 $Y_i \\in \\{0,1\\}$ 如下：\n- $i=1$：$p_{A,1}=0.85$，$Y_1=1$\n- $i=2$：$p_{A,2}=0.80$，$Y_2=1$\n- $i=3$：$p_{A,3}=0.75$，$Y_3=1$\n- $i=4$：$p_{A,4}=0.70$，$Y_4=1$\n- $i=5$：$p_{A,5}=0.60$，$Y_5=1$\n- $i=6$：$p_{A,6}=0.55$，$Y_6=1$\n- $i=7$：$p_{A,7}=0.50$，$Y_7=1$\n- $i=8$：$p_{A,8}=0.45$，$Y_8=0$\n- $i=9$：$p_{A,9}=0.40$，$Y_9=1$\n- $i=10$：$p_{A,10}=0.35$，$Y_{10}=0$\n- $i=11$：$p_{A,11}=0.30$，$Y_{11}=0$\n- $i=12$：$p_{A,12}=0.25$，$Y_{12}=0$\n- $i=13$：$p_{A,13}=0.22$，$Y_{13}=1$\n- $i=14$：$p_{A,14}=0.18$，$Y_{14}=0$\n- $i=15$：$p_{A,15}=0.15$，$Y_{15}=0$\n- $i=16$：$p_{A,16}=0.12$，$Y_{16}=0$\n- $i=17$：$p_{A,17}=0.10$，$Y_{17}=0$\n- $i=18$：$p_{A,18}=0.08$，$Y_{18}=0$\n- $i=19$：$p_{A,19}=0.06$，$Y_{19}=0$\n- $i=20$：$p_{A,20}=0.04$，$Y_{20}=0$\n\n模型 $B$ 通过对模型 $A$ 输出的单调变换定义，$p_{B,i}=(p_{A,i})^2$，因此两个模型按风险对个体进行的排序是相同的，但数值校准度不同。考虑使用单一阈值概率 $p_t=0.20$ 进行分类：如果模型的预测概率至少为 $p_t$，则将个体分类为检验阳性，否则分类为检验阴性。假设基于此分类的决策旨在最大化阈值 $p_t$ 下的决策分析净获益。\n\n仅使用灵敏度（sensitivity）和特异度（specificity）、受试者工作特征（ROC）排序、ROC曲线下面积（AUC）、似然比（likelihood ratios）和基于阈值的决策分析的基本定义，确定哪个选项正确地说明了在阈值 $p_t=0.20$ 下哪个模型产生更大的决策分析净获益，并解释原因。注意，模型 $A$ 对这些数据有良好的校准度，而模型 $B$ 由于其变换而校准不佳。\n\n选择一项：\n- A. 模型 $A$ 在 $p_t=0.20$ 时产生更高的净获益，因为尽管ROC曲线下面积（AUC）相同，但其校准度将更多真实病例置于阈值之上，并且考虑到 $p_t$ 的权衡，假阳性的增加是可接受的。\n- B. 模型 $B$ 在 $p_t=0.20$ 时产生更高的净获益，因为其更高的特异度和更大的阳性似然比在任何阈值下都意味着更高的净获益。\n- C. 两个模型在 $p_t=0.20$ 时产生相等的净获益，因为相等的AUC意味着在任何阈值下性能都相等。\n- D. 模型 $B$ 在 $p_t=0.20$ 时产生更高的净获益，因为当AUC相等时，降低概率的校准不佳会减少过度治疗，从而提高净获益。",
            "solution": "问题要求确定在指定的概率阈值 $p_t = 0.20$ 下，两个预测模型（模型 $A$ 或模型 $B$）中哪一个产生更高的决策分析净获益。分析将首先验证问题，然后根据基本定义推导每个模型的净获益，最后评估每个选项。\n\n首先，我们从问题陈述中整理必要的信息。该队列由 $N=20$ 名个体组成。我们必须确定有结局（病例，$Y=1$）和无结局（非病例，$Y=0$）的个体数量。\n- 病例 ($D$)：$Y_i=1$ 的个体为 $i \\in \\{1, 2, 3, 4, 5, 6, 7, 9, 13\\}$。病例总数为 $D = 9$。\n- 非病例 ($H$)：$Y_i=0$ 的个体为 $i \\in \\{8, 10, 11, 12, 14, 15, 16, 17, 18, 19, 20\\}$。非病例总数为 $H=11$。\n受试者总数为 $N = D+H = 9+11=20$，这与问题陈述一致。\n\n决策阈值给定为 $p_t = 0.20$。如果个体的预测概率大于或等于 $p_t$，则分类为检验阳性，否则为检验阴性。\n\n阈值 $p_t$ 下的决策分析净获益 (NB) 定义为：\n$$NB(p_t) = \\frac{TP}{N} - \\frac{FP}{N} \\cdot \\frac{p_t}{1-p_t}$$\n其中 $TP$ 是真阳性数，$FP$ 是假阳性数，$N$ 是个体总数。项 $\\frac{p_t}{1-p_t}$ 表示在阈值下的结局优势比，它定义了假阳性与真阳性之间的相对成本。对于 $p_t=0.20$，这个权衡是 $\\frac{0.20}{1-0.20} = \\frac{0.20}{0.80} = \\frac{1}{4}$。\n\n**模型 A 的分析**\n对于模型 $A$，如果 $p_{A,i} \\ge 0.20$，个体就被分类为检验阳性。我们检查所提供的数据，以找出哪些个体符合此标准，并确定他们是真阳性还是假阳性。\n- $p_{A,i} \\ge 0.20$ 的个体：这些是个体 $i = 1, \\dots, 13$。\n- 模型 A 的真阳性 ($TP_A$)：这些是 $p_{A,i} \\ge 0.20$ 的病例 ($Y_i=1$)。\n  - 个体 $1, 2, 3, 4, 5, 6, 7, 9, 13$ 是病例。他们的 $p_{A,i}$ 都 $\\ge 0.22 > 0.20$。\n  - 因此，$TP_A = 9$。\n- 模型 A 的假阳性 ($FP_A$)：这些是 $p_{A,i} \\ge 0.20$ 的非病例 ($Y_i=0$)。\n  - 个体 $8, 10, 11, 12$ 是非病例。他们的概率分别为 $0.45, 0.35, 0.30, 0.25$，所有这些都 $\\ge 0.20$。\n  - 因此，$FP_A = 4$。\n\n现在，我们计算模型 A 在 $p_t=0.20$ 时的净获益：\n$$NB_A(0.20) = \\frac{TP_A}{N} - \\frac{FP_A}{N} \\cdot \\frac{0.20}{1-0.20} = \\frac{9}{20} - \\frac{4}{20} \\cdot \\frac{1}{4}$$\n$$NB_A(0.20) = \\frac{9}{20} - \\frac{1}{20} = \\frac{8}{20} = 0.40$$\n\n**模型 B 的分析**\n对于模型 B，预测概率为 $p_{B,i} = (p_{A,i})^2$。如果 $p_{B,i} \\ge 0.20$，个体就被分类为检验阳性。这个条件等价于 $(p_{A,i})^2 \\ge 0.20$，可简化为 $p_{A,i} \\ge \\sqrt{0.20}$。\n$\\sqrt{0.20} = \\sqrt{1/5} = 1/\\sqrt{5} \\approx 0.4472$。\n所以，对于模型 B，分类规则等同于基于模型 A 的概率使用一个更高的有效阈值，约为 $0.4472$。\n\n我们找出满足标准 $p_{A,i} \\ge 0.4472$ 的个体：\n- $p_{A,i} \\ge 0.4472$ 的个体：这些是个体 $i = 1, \\dots, 8$。\n- 模型 B 的真阳性 ($TP_B$)：这些是 $p_{A,i} \\ge 0.4472$ 的病例 ($Y_i=1$)。\n  - 个体 $1, 2, 3, 4, 5, 6, 7$ 是概率 $\\ge 0.50$ 的病例。\n  - 因此，$TP_B = 7$。\n- 模型 B 的假阳性 ($FP_B$)：这些是 $p_{A,i} \\ge 0.4472$ 的非病例 ($Y_i=0$)。\n  - 个体 $8$ 是一个非病例，其 $p_{A,8} = 0.45 \\ge 0.4472$。\n  - 因此，$FP_B = 1$。\n\n现在，我们计算模型 B 的净获益。在净获益公式中使用决策阈值 $p_t=0.20$ 至关重要，因为这个值反映了决策者的偏好，而不是模型的内部概率尺度。\n$$NB_B(0.20) = \\frac{TP_B}{N} - \\frac{FP_B}{N} \\cdot \\frac{0.20}{1-0.20} = \\frac{7}{20} - \\frac{1}{20} \\cdot \\frac{1}{4}$$\n$$NB_B(0.20) = \\frac{7}{20} - \\frac{1}{80} = \\frac{28}{80} - \\frac{1}{80} = \\frac{27}{80} = 0.3375$$\n\n**净获益比较**\n比较两个模型，我们发现 $NB_A(0.20) = 0.40$ 和 $NB_B(0.20) = 0.3375$。\n显然，$NB_A(0.20) > NB_B(0.20)$。在决策阈值 $p_t=0.20$ 下，模型 A 提供了更大的净获益。\n\n**选项评估**\n\n- **A. 模型 $A$ 在 $p_t=0.20$ 时产生更高的净获益，因为尽管ROC曲线下面积（AUC）相同，但其校准度将更多真实病例置于阈值之上，并且考虑到 $p_t$ 的权衡，假阳性的增加是可接受的。**\n  - “模型 $A$ 在 $p_t=0.20$ 时产生更高的净获益”这一结论与我们的计算（$0.40 > 0.3375$）一致。\n  - “ROC曲线下面积（AUC）相同”的说法是正确的。由于 $p_{B,i}=(p_{A,i})^2$ 是一个严格单调的变换，两个模型按预测概率对个体进行的排序是相同的。由于ROC曲线是基于这个排序构建的，因此ROC曲线以及AUC都是相同的。\n  - 模型 A “将更多真实病例置于阈值之上”的说法是正确的（$TP_A=9$ vs $TP_B=7$）。\n  - “假阳性增加是可接受的”的说法也是正确的。模型 A 的 $FP_A=4$ 而模型 B 的 $FP_B=1$，增加了3个。这种权衡（为增加3个FP而获得2个TP）导致了更高的净获益，在 $p_t=0.20$ 的决策阈值背景下使其变得“可接受”。模型 A 卓越的校准度使其原始概率输出在给定的阈值 $p_t$ 下成为更好的行动指南。这个选项与分析完全一致。\n  - 结论：**正确**。\n\n- **B. 模型 $B$ 在 $p_t=0.20$ 时产生更高的净获益，因为其更高的特异度和更大的阳性似然比在任何阈值下都意味着更高的净获益。**\n  - 前提“模型 $B$ 产生更高的净获益”是错误的。\n  - 让我们检查一下由阈值 $p_t=0.20$ 定义的操作点的一些辅助声明。模型 A 的灵敏度和特异度分别为 $TPR_A = TP_A/D = 9/9 = 1.0$ 和 $Spec_A = (H-FP_A)/H = (11-4)/11 = 7/11$。假阳性率为 $FPR_A = 1 - Spec_A = 4/11$。对于模型 B，$TPR_B = 7/9$，$Spec_B = (11-1)/11=10/11$。所以 $Spec_B > Spec_A$。阳性似然比为 $LR+_A = TPR_A/FPR_A = 1.0 / (4/11) = 2.75$ 和 $LR+_B = TPR_B/FPR_B = (7/9)/(1/11) = 77/9 \\approx 8.56$。所以 $LR+_B > LR+_A$。尽管这两个声明对于特定的分类点是正确的，但“在任何阈值下都意味着更高的净获益”的一般性断言是错误的。净获益取决于 TPR 和 FPR 之间的特定权衡，而这个权衡由 $p_t$ 决定。\n  - 结论：**不正确**。\n\n- **C. 两个模型在 $p_t=0.20$ 时产生相等的净获益，因为相等的AUC意味着在任何阈值下性能都相等。**\n  - 前提“两个模型产生相等的净获益”是错误的。\n  - 推理“相等的AUC意味着在任何阈值下性能都相等”是对这些指标的基本误解。AUC 衡量的是所有阈值下的整体区分能力（排序能力），而不是在单个特定阈值下的性能。影响特定阈值下性能的校准度，并未被AUC捕获。\n  - 结论：**不正确**。\n\n- **D. 模型 $B$ 在 $p_t=0.20$ 时产生更高的净获益，因为当AUC相等时，降低概率的校准不佳会减少过度治疗，从而提高净获益。**\n  - 前提“模型 $B$ 产生更高的净获益”是错误的。\n  - 推理是有缺陷的。虽然模型 B 的校准不佳确实导致了更少的假阳性（$FP_B=1$ vs $FP_A=4$）——减少了可称为“过度治疗”的情况——但这是以错失真实病例为代价的（$TP_B=7$ vs $TP_A=9$）。在这种情况下，以净获益衡量的效用净效应是负的。减少FP并不自动提高净获益；与TP的平衡才是关键。\n  - 结论：**不正确**。\n\n总之，模型 A 产生更高的净获益，因为它的校准度更好。将决策阈值 $p_t=0.20$ 应用于模型 A 的良好校准概率，相比于将相同阈值应用于模型 B 的校准不佳概率，会得到更优的分类决策。",
            "answer": "$$\\boxed{A}$$"
        }
    ]
}