{
    "hands_on_practices": [
        {
            "introduction": "在我们着手纠正一种偏倚之前，我们必须首先理解其结构和量级。这个练习提供了一个理论模型，用于量化“健康工人效应”如何系统性地扭曲标准化死亡比（SMR），从而导致对风险的低估。通过推导偏倚因子，我们能够对这个问题获得清晰、定量的认识。",
            "id": "4597939",
            "problem": "一项制造业队列研究旨在量化在评估危险暴露对全因死亡率的影响时，由健康工人效应所导致的选择偏倚的大小。考虑一个暴露工人的队列，根据受雇以来的时间将其划分为$2$个层：层$i=1$为$t < 5$年，层$i=2$为$t \\ge 5$年。设$r_{g,i}$表示一般人群中第$i$层的全因死亡率，$s_i$表示捕捉健康工人效应的乘性选择因子，使得第$i$层中未暴露工人的基线率为$r_{u,i} = s_i \\, r_{g,i}$，其中$0 < s_i < 1$。$RR_{\\text{true}}$表示工人中暴露相对于未暴露的真实因果率比，且该值在各层中恒定。设$\\text{PY}_i$表示第$i$层中暴露工人贡献的人年（Person-Years (PY)）。\n\n仅使用发生率、间接标准化下的期望事件数以及标准化死亡比（SMR）的核心定义，推导暴露队列相对于一般人群的观测SMR的表达式，该表达式应为$RR_{\\text{true}}$、$\\{s_i\\}$、$\\{r_{g,i}\\}$和$\\{\\text{PY}_i\\}$的函数。将偏倚大小$B$定义为$B = RR_{\\text{obs}}/RR_{\\text{true}}$，其中$RR_{\\text{obs}}$是观测到的SMR。然后，使用以下科学上合理的值计算$B$：\n\n- 层 $1$：$\\text{PY}_1 = 30{,}000$，$r_{g,1} = 0.004 \\text{ 每人年}$，$s_1 = 0.50$。\n- 层 $2$：$\\text{PY}_2 = 70{,}000$，$r_{g,2} = 0.010 \\text{ 每人年}$，$s_2 = 0.80$。\n\n将您的最终答案表示为一个无单位数，并四舍五入到四位有效数字。",
            "solution": "该问题已经过验证，并被确定为流行病学中一个有效的、合理设置的问题。其科学基础在于队列研究、选择偏倚（特别是健康工人效应）和间接标准化的原则。所有必要的参数和定义都已提供，数值也是合理的。\n\n目标是推导观测标准化死亡比（SMR）的表达式，然后计算偏倚大小$B$，其定义为观测SMR与真实因果率比$RR_{\\text{true}}$的比值。\n\n首先，我们定义SMR的组成部分。SMR是队列中观测到的总死亡人数与期望的总死亡人数之比。\n$$\n\\text{SMR} = \\frac{\\text{观测事件数}}{\\text{期望事件数}} = \\frac{O_{\\text{total}}}{E_{\\text{total}}}\n$$\n\n观测事件总数$O_{\\text{total}}$是所有层的观测事件数之和。在给定层$i$中，观测事件数（记为$O_i$）是该层暴露工人的死亡率$r_{e,i}$与人年数$\\text{PY}_i$的乘积。\n$$\nO_i = r_{e,i} \\cdot \\text{PY}_i\n$$\n率$r_{e,i}$通过真实因果率比$RR_{\\text{true}}$与未暴露工人的率$r_{u,i}$相关。问题陈述该关系在各层中是恒定的：\n$$\nRR_{\\text{true}} = \\frac{r_{e,i}}{r_{u,i}} \\implies r_{e,i} = RR_{\\text{true}} \\cdot r_{u,i}\n$$\n未暴露工人的率$r_{u,i}$受到健康工人效应的影响，该效应由选择因子$s_i$表示，是相对于一般人群的率$r_{g,i}$而言的：\n$$\nr_{u,i} = s_i \\cdot r_{g,i}\n$$\n通过代入，我们得到暴露工人的死亡率，其是一般人群死亡率、选择因子和真实率比的函数：\n$$\nr_{e,i} = RR_{\\text{true}} \\cdot (s_i \\cdot r_{g,i})\n$$\n观测事件总数是所有层的总和：\n$$\nO_{\\text{total}} = \\sum_{i} O_i = \\sum_{i} (r_{e,i} \\cdot \\text{PY}_i) = \\sum_{i} (RR_{\\text{true}} \\cdot s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)\n$$\n\n接下来，我们计算期望事件总数$E_{\\text{total}}$。这是通过将参考（一般）人群的特定分层死亡率$r_{g,i}$应用于研究队列中每个层的人年数来确定的。在第$i$层中的期望事件数（记为$E_i$）是：\n$$\nE_i = r_{g,i} \\cdot \\text{PY}_i\n$$\n期望事件总数是所有层的总和：\n$$\nE_{\\text{total}} = \\sum_{i} E_i = \\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)\n$$\n\n现在，我们可以通过代入$O_{\\text{total}}$和$E_{\\text{total}}$的表达式来推导SMR的表达式：\n$$\n\\text{SMR} = \\frac{\\sum_{i} (RR_{\\text{true}} \\cdot s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\n由于$RR_{\\text{true}}$是一个常数，它可以从分子的求和中提取出来：\n$$\n\\text{SMR} = RR_{\\text{true}} \\cdot \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\n这就是所要求的观测SMR的表达式。\n\n问题将观测率比定义为$RR_{\\text{obs}} = \\text{SMR}$，将偏倚大小定义为$B = RR_{\\text{obs}}/RR_{\\text{true}}$。代入我们的SMR表达式可得：\n$$\nB = \\frac{\\text{SMR}}{RR_{\\text{true}}} = \\frac{1}{RR_{\\text{true}}} \\left( RR_{\\text{true}} \\cdot \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)} \\right)\n$$\n$RR_{\\text{true}}$项相互消去，得到偏倚大小的表达式：\n$$\nB = \\frac{\\sum_{i} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)}{\\sum_{i} (r_{g,i} \\cdot \\text{PY}_i)}\n$$\n这表明偏倚因子$B$是各层特定选择因子$\\{s_i\\}$的加权平均值，其中权重是各层特定的期望死亡人数，$E_i = r_{g,i} \\cdot \\text{PY}_i$。\n\n现在我们使用为两个层（$i=1, 2$）提供的数值来计算$B$：\n对于层1：$\\text{PY}_1 = 30{,}000$，$r_{g,1} = 0.004$，$s_1 = 0.50$。\n对于层2：$\\text{PY}_2 = 70{,}000$，$r_{g,2} = 0.010$，$s_2 = 0.80$。\n\n首先，计算分子 $\\sum_{i=1}^{2} (s_i \\cdot r_{g,i} \\cdot \\text{PY}_i)$：\n$$\n\\text{分子} = (s_1 \\cdot r_{g,1} \\cdot \\text{PY}_1) + (s_2 \\cdot r_{g,2} \\cdot \\text{PY}_2)\n$$\n$$\n\\text{分子} = (0.50 \\cdot 0.004 \\cdot 30{,}000) + (0.80 \\cdot 0.010 \\cdot 70{,}000)\n$$\n$$\n\\text{分子} = (60) + (560) = 620\n$$\n\n接下来，计算分母 $\\sum_{i=1}^{2} (r_{g,i} \\cdot \\text{PY}_i)$：\n$$\n\\text{分母} = (r_{g,1} \\cdot \\text{PY}_1) + (r_{g,2} \\cdot \\text{PY}_2)\n$$\n$$\n\\text{分母} = (0.004 \\cdot 30{,}000) + (0.010 \\cdot 70{,}000)\n$$\n$$\n\\text{分母} = (120) + (700) = 820\n$$\n这些项代表了每个层的期望死亡人数，$E_1=120$ 和 $E_2=700$。\n\n最后，计算偏倚大小$B$：\n$$\nB = \\frac{\\text{分子}}{\\text{分母}} = \\frac{620}{820} = \\frac{62}{82} = \\frac{31}{41}\n$$\n换算成小数，结果约为$0.75609756...$。四舍五入到四位有效数字，我们得到$0.7561$。\n这个值小于1，表明观测到的SMR低估了真实的率比，这与健康工人效应所导致的预期偏倚方向一致。",
            "answer": "$$\\boxed{0.7561}$$"
        },
        {
            "introduction": "在理解了偏倚的性质之后，下一步是应用实用方法来减轻其影响。这个问题模拟了职业流行病学中的一个常见场景，即我们拥有分层数据。通过执行间接标准化，你将学习一种基本技术，以调整如年龄和基线健康状况等混杂变量，从而获得对工人群体死亡风险更准确的估计。",
            "id": "4640831",
            "problem": "一个工厂队列在一个固定的随访期内接受了全因死亡率评估，期间累积了人时数并记录了死亡人数，这些数据按队列进入时的年龄和基线健康状况进行分层。为了减轻“健康工人效应”（一种选择偏倚），您将通过使用来自一般人群的特定分层死亡率作为标准，进行同时考虑年龄和健康状况的间接标准化。\n\n使用的基本定义：\n- 分层死亡率是指每单位人时数的死亡人数，此处以每$1{,}000$人年（PY）为单位提供。\n- 标准下的预期死亡人数是通过将每个分层的标准死亡率乘以该分层中队列的人年数得出的。\n- 标准化死亡比（SMR）是队列中总观察死亡人数与标准下总预期死亡人数之比。\n\n分层由年龄组$\\{20\\text{--}39,\\ 40\\text{--}59,\\ 60\\text{--}74\\}$和基线健康状况$\\{\\text{无疾病},\\ \\text{有疾病}\\}$定义。\n\n一般人群（标准）各分层的死亡率（每$1{,}000$人年）如下：\n- 年龄$20\\text{--}39$，无疾病：$1.2$；年龄$20\\text{--}39$，有疾病：$3.6$。\n- 年龄$40\\text{--}59$，无疾病：$4.5$；年龄$40\\text{--}59$，有疾病：$11.0$。\n- 年龄$60\\text{--}74$，无疾病：$18.0$；年龄$60\\text{--}74$，有疾病：$35.0$。\n\n队列各分层的人年数和观察死亡人数如下：\n- 年龄$20\\text{--}39$，无疾病：PY $32{,}000$；死亡 $48$。年龄$20\\text{--}39$，有疾病：PY $1{,}800$；死亡 $9$。\n- 年龄$40\\text{--}59$，无疾病：PY $27{,}000$；死亡 $133$。年龄$40\\text{--}59$，有疾病：PY $4{,}200$；死亡 $60$。\n- 年龄$60\\text{--}74$，无疾病：PY $12{,}500$；死亡 $260$。年龄$60\\text{--}74$，有疾病：PY $2{,}300$；死亡 $115$。\n\n仅使用上述基本定义，并执行同时考虑年龄和基线健康状况的间接标准化，计算该队列相对于一般人群的、已减轻偏倚的标准化死亡比。将最终答案表示为四舍五入到四位有效数字的小数。SMR 不需要单位。",
            "solution": "用户希望我按照以下步骤解决问题。\n1.  首先，验证问题陈述。\n2.  如果有效，则解决它。\n\n### 步骤1：提取已知信息\n- **任务**：使用间接标准化方法，计算工厂队列相对于一般人群的、已减轻偏倚的标准化死亡比（SMR）。\n- **基本定义**：\n    - 死亡率是每单位人时数的死亡人数，以每 $1{,}000$ 人年（PY）为单位。\n    - 预期死亡人数 = （某分层的标准死亡率） $\\times$ （该分层中队列的人年数）。\n    - SMR = （队列中总观察死亡人数） / （标准下总预期死亡人数）。\n- **分层**：分层由年龄组 $\\{20\\text{--}39,\\ 40\\text{--}59,\\ 60\\text{--}74\\}$ 和基线健康状况 $\\{\\text{无疾病},\\ \\text{有疾病}\\}$ 定义。\n- **一般人群（标准）死亡率（每 $1{,}000$ 人年）**：\n    - 年龄 $20\\text{--}39$，无疾病：$1.2$。\n    - 年龄 $20\\text{--}39$，有疾病：$3.6$。\n    - 年龄 $40\\text{--}59$，无疾病：$4.5$。\n    - 年龄 $40\\text{--}59$，有疾病：$11.0$。\n    - 年龄 $60\\text{--}74$，无疾病：$18.0$。\n    - 年龄 $60\\text{--}74$，有疾病：$35.0$。\n- **队列数据（人年数和观察死亡人数）**：\n    - 年龄 $20\\text{--}39$，无疾病：PY $32{,}000$；死亡 $48$。\n    - 年龄 $20\\text{--}39$，有疾病：PY $1{,}800$；死亡 $9$。\n    - 年龄 $40\\text{--}59$，无疾病：PY $27{,}000$；死亡 $133$。\n    - 年龄 $40\\text{--}59$，有疾病：PY $4{,}200$；死亡 $60$。\n    - 年龄 $60\\text{--}74$，无疾病：PY $12{,}500$；死亡 $260$。\n    - 年龄 $60\\text{--}74$，有疾病：PY $2{,}300$；死亡 $115$。\n- **最终输出要求**：SMR 应表示为四舍五入到四位有效数字的小数。\n\n### 步骤2：使用提取的已知信息进行验证\n根据验证标准评估问题：\n- **科学性**：该问题描述了使用间接标准化方法计算标准化死亡比（SMR），这是流行病学中控制混杂因素的一种标准和基本方法。“健康工人效应”是职业流行病学中一种公认的选择偏倚形式。数据和方法在科学上是合理的。\n- **适定性**：该问题提供了计算唯一SMR所需的所有必要数据（观察死亡人数、人年数、各分层的标准率）和明确的定义。指令清晰明确。\n- **客观性**：该问题以精确、定量和客观的术语陈述。没有主观陈述或意见。\n- **完整性和一致性**：数据是完整的，为按年龄和健康状况定义的所有六个分层都提供了数值。所提供的信息没有矛盾。死亡率随年龄和疾病的存在而增加，这与已确立的流行病学事实一致。\n- **现实性**：所提供的人年数、死亡人数和死亡率对于大型队列研究来说是合理的。\n\n该问题没有表现出任何列出的缺陷（例如，科学不合理性、不完整性、模糊性）。这是生物统计学和流行病学中的一个标准的、可形式化的练习。\n\n### 步骤3：结论和行动\n问题有效。我将继续进行解答。\n\n该问题要求计算工厂队列的标准化死亡比（SMR）。SMR的公式如下：\n$$\n\\text{SMR} = \\frac{\\text{总观察死亡人数}}{\\text{总预期死亡人数}}\n$$\n设 $D_O$ 代表总观察死亡人数，$D_E$ 代表总预期死亡人数。\n\n首先，我们通过对所有分层的死亡人数求和，计算队列中的总观察死亡人数（$D_O$）。\n设 $d_i$ 为分层 $i$ 中的观察死亡人数。分层索引如下：\n$1$：年龄 $20\\text{--}39$，无疾病\n$2$：年龄 $20\\text{--}39$，有疾病\n$3$：年龄 $40\\text{--}59$，无疾病\n$4$：年龄 $40\\text{--}59$，有疾病\n$5$：年龄 $60\\text{--}74$，无疾病\n$6$：年龄 $60\\text{--}74$，有疾病\n\n$$\nD_O = \\sum_{i=1}^{6} d_i = 48 + 9 + 133 + 60 + 260 + 115\n$$\n$$\nD_O = 625\n$$\n所以，总观察死亡人数为 $625$。\n\n接下来，我们计算总预期死亡人数（$D_E$）。这是通过将标准（一般）人群的分层特定死亡率应用于每个相应分层中队列的人年数来完成的。设 $E_i$ 为分层 $i$ 中的预期死亡人数，$PY_i$ 为分层 $i$ 中队列的人年数，$R_i$ 为分层 $i$ 的标准死亡率。标准率以每 $1{,}000$ 人年为单位，因此我们必须将其除以 $1{,}000$ 以获得每人年的率。\n\n每个分层的预期死亡人数计算如下：\n$$\nE_i = PY_i \\times \\frac{R_i}{1000}\n$$\n\n- **分层1（年龄 $20\\text{--}39$，无疾病）**：\n  $PY_1 = 32{,}000$, $R_1 = 1.2$ 每 $1{,}000$ 人年\n  $E_1 = 32{,}000 \\times \\frac{1.2}{1000} = 38.4$\n\n- **分层2（年龄 $20\\text{--}39$，有疾病）**：\n  $PY_2 = 1{,}800$, $R_2 = 3.6$ 每 $1{,}000$ 人年\n  $E_2 = 1{,}800 \\times \\frac{3.6}{1000} = 6.48$\n\n- **分层3（年龄 $40\\text{--}59$，无疾病）**：\n  $PY_3 = 27{,}000$, $R_3 = 4.5$ 每 $1{,}000$ 人年\n  $E_3 = 27{,}000 \\times \\frac{4.5}{1000} = 121.5$\n\n- **分层4（年龄 $40\\text{--}59$，有疾病）**：\n  $PY_4 = 4{,}200$, $R_4 = 11.0$ 每 $1{,}000$ 人年\n  $E_4 = 4{,}200 \\times \\frac{11.0}{1000} = 46.2$\n\n- **分层5（年龄 $60\\text{--}74$，无疾病）**：\n  $PY_5 = 12{,}500$, $R_5 = 18.0$ 每 $1{,}000$ 人年\n  $E_5 = 12{,}500 \\times \\frac{18.0}{1000} = 225.0$\n\n- **分层6（年龄 $60\\text{--}74$，有疾病）**：\n  $PY_6 = 2{,}300$, $R_6 = 35.0$ 每 $1{,}000$ 人年\n  $E_6 = 2{,}300 \\times \\frac{35.0}{1000} = 80.5$\n\n总预期死亡人数 $D_E$ 是所有分层预期死亡人数的总和：\n$$\nD_E = \\sum_{i=1}^{6} E_i = 38.4 + 6.48 + 121.5 + 46.2 + 225.0 + 80.5\n$$\n$$\nD_E = 518.08\n$$\n所以，总预期死亡人数为 $518.08$。\n\n最后，我们计算 SMR：\n$$\n\\text{SMR} = \\frac{D_O}{D_E} = \\frac{625}{518.08}\n$$\n$$\n\\text{SMR} \\approx 1.20637704\n$$\n问题要求答案四舍五入到四位有效数字。前四位有效数字是 $1$、$2$、$0$ 和 $6$。第五位有效数字是 $3$，小于 $5$，所以我们向下舍入。\n$$\n\\text{SMR} \\approx 1.206\n$$",
            "answer": "$$\n\\boxed{1.206}\n$$"
        },
        {
            "introduction": "虽然对静态数据进行计算至关重要，但现代流行病学也使用模拟来探索复杂的因果系统。这项高级实践要求你从基本原理出发，建立一个计算模型，其中包括潜在健康状况和基于健康状况的入职选择。这种方法能够让你深刻理解“健康工人效应”是如何动态产生的，并允许你探索影响其大小的各种因素。",
            "id": "4597935",
            "problem": "编写一个完整、可运行的程序，使用模拟和蒙特卡洛设计来研究作为一种选择现象的健康工人效应。您必须构建一个死亡率的生成模型，其中就业选择取决于潜在健康（体弱），并量化朴素的外部比较如何存在偏倚，而内部比较的偏倚较小。该程序必须实现以下纯粹用数学术语定义的模型。\n\n基本和核心定义：\n- 令 $U$ 表示一个潜在的乘法性体弱。将 $\\ln U$ 建模为均值为 $\\mu_Z$、方差为 $\\sigma_Z^2$ 的正态随机变量。设置 $\\mu_Z = -\\sigma_Z^2/2$，使得 $\\mathbb{E}[U] = 1$。\n- 令 $\\lambda_0$ 表示一般人群的基线风险率（单位：每人年）。对于体弱为 $U$ 的个体，在没有暴露的情况下，其个体风险为 $h = \\lambda_0 U$。\n- 令 $X \\in \\{0,1\\}$ 表示二元工作场所暴露。暴露会使风险乘以一个因子 $\\mathrm{HR}_X$，因此风险为 $h_X = \\lambda_0 U \\cdot \\mathrm{HR}_X^{X}$。\n- 对于一个固定的随访期 $T$（单位：年），并假设风险在 $[0,T]$ 期间是恒定的，那么到时间 $T$ 为止的死亡概率是 $p_T = 1 - \\exp(-T h_X)$。\n- 令 $S \\in \\{0,1\\}$ 表示基线时的就业状态。就业是基于健康通过一个逻辑斯谛模型进行选择的：\n$$\n\\Pr(S=1 \\mid U) = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U) = \\frac{1}{1 + \\exp\\left(-(\\beta_0 - \\beta_1 \\ln U)\\right)}.\n$$\n这里 $\\beta_1 \\ge 0$ 编码了较大的体弱 $U$（较差的健康状况）会降低就业概率，从而产生健康工人效应。\n\n通过蒙特卡洛估计的量：\n- 未暴露工人中的标准化死亡比（SMR），定义为\n$$\n\\mathrm{SMR}_{\\text{unexp}} = \\frac{\\text{在 }[0,T]\\text{ 期间，}X=0\\text{ 的工人中的观察死亡数}}{\\text{使用外部率 }\\lambda_0\\text{ 和人时 }T\\text{ 的预期死亡数}}。\n$$\n形式上，如果有 $n_0$ 名未暴露工人，预期死亡数 = $n_0 \\cdot \\lambda_0 \\cdot T$。\n- 比较暴露与未暴露工人的内部风险比，定义为\n$$\n\\widehat{\\mathrm{RR}}_{\\text{internal}} = \\frac{\\widehat{R}_1}{\\widehat{R}_0},\n$$\n其中 $\\widehat{R}_x$ 是在 $[0,T]$ 期间 $X=x$ 的工人的样本风险。\n- 通过 g-计算公式获得的工人中的目标因果边际风险比，\n$$\n\\mathrm{RR}_{\\text{true}} = \\frac{\\mathbb{E}[\\,1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X)\\mid S=1\\,]}{\\mathbb{E}[\\,1 - \\exp(-T \\lambda_0 U)\\mid S=1\\,]}。\n$$\n这是通过对受雇者中 $U$ 的经验分布进行反事实风险平均计算得出的。\n- 内部风险比的蒙特卡洛偏倚和均方误差（MSE），在 $R$ 次独立重复中定义为\n$$\n\\text{Bias} = \\frac{1}{R}\\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right),\n\\quad\n\\text{MSE} = \\frac{1}{R}\\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)^2.\n$$\n\n单次重复的模拟设计：\n- 生成 $N$ 个独立的 $Z \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$ 抽样，其中 $\\mu_Z = -\\sigma_Z^2/2$，并设置 $U = \\exp(Z)$。\n- 计算 $p_{\\text{emp}} = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U)$ 并抽取 $S \\sim \\mathrm{Bernoulli}(p_{\\text{emp}})$。\n- 在 $S=1$ 的人群中，独立地抽取暴露 $X \\sim \\mathrm{Bernoulli}(p_X)$。\n- 对于每位工人，计算风险 $p_T = 1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X^{X})$ 并抽取死亡指示符 $Y \\sim \\mathrm{Bernoulli}(p_T)$。\n- 仅使用未暴露的工人计算 $\\mathrm{SMR}_{\\text{unexp}}$，将预期死亡数设为 $n_0 \\lambda_0 T$，观察到的死亡数设为未暴露工人的 $\\sum Y$。\n- 计算 $\\widehat{\\mathrm{RR}}_{\\text{internal}}$，即暴露工人和未暴露工人样本风险的比率。\n- 通过评估\n$$\nr_1 = 1 - \\exp(-T \\lambda_0 U \\mathrm{HR}_X), \\quad r_0 = 1 - \\exp(-T \\lambda_0 U)\n$$\n对相同的受雇工人进行计算，并取均值的比率，$\\mathrm{RR}_{\\text{true}} = \\overline{r}_1 / \\overline{r}_0$，来计算 $\\mathrm{RR}_{\\text{true}}$。\n\n蒙特卡洛聚合：\n- 使用独立的随机数流将上述过程重复 $R$ 次，并计算 $\\mathrm{SMR}_{\\text{unexp}}$、偏倚和 MSE 的蒙特卡洛平均值。\n\n您的程序必须实现以下测试套件，其中每个测试用例都是一个参数元组 $(\\text{seed}, N, R, \\lambda_0, \\sigma_Z, \\beta_0, \\beta_1, p_X, \\mathrm{HR}_X, T)$：\n- 案例 A（一般情况）： $(202311, 100000, 40, 0.08, 0.7, 0.0, 1.2, 0.5, 1.5, 5.0)$。\n- 案例 B（无健康工人效应，边界情况）： $(202312, 100000, 40, 0.08, 0.7, 0.0, 0.0, 0.5, 1.5, 5.0)$。\n- 案例 C（强选择，短随访）： $(202313, 100000, 40, 0.08, 0.9, -0.4, 2.0, 0.5, 2.0, 0.5)$。\n- 案例 D（无暴露效应，边缘情况）： $(202314, 100000, 40, 0.08, 0.7, 0.0, 1.0, 0.5, 1.0, 3.0)$。\n\n注释和约束：\n- 所有的随机数生成必须是可复现的，方法是在每个测试用例中使用提供的整数种子进行播种；在各次重复中使用独立的子流。\n- 所有答案都是无量纲的比率；请用小数表示。\n- 通过仅在两个组都存在时才定义比率来优雅地处理任何潜在的零分母情况；在给定的参数和样本量下，出现退化组的概率可以忽略不计。\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，结果按以下顺序排列：\n$[\\overline{\\mathrm{SMR}}_{\\text{unexp}}^{A}, \\text{Bias}^{A}, \\text{MSE}^{A}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{B}, \\text{Bias}^{B}, \\text{MSE}^{B}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{C}, \\text{Bias}^{C}, \\text{MSE}^{C}, \\overline{\\mathrm{SMR}}_{\\text{unexp}}^{D}, \\text{Bias}^{D}, \\text{MSE}^{D}]$,\n其中，横线表示对 $R$ 次重复的蒙特卡洛平均。每个数字必须精确打印到小数点后 $6$ 位。",
            "solution": "该问题要求实现一个蒙特卡洛模拟，以研究健康工人效应，这是流行病学中一种选择偏倚。我将首先验证问题陈述，然后提供详细的解决方案。\n\n### 问题验证\n\n问题陈述为一个关于人口健康、就业选择和死亡率的生成模型提供了全面且数学上精确的描述。\n\n**步骤1：提取的已知信息**\n- **潜在体弱**：$U$ 是一个随机变量，使得 $\\ln U \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$，并有约束 $\\mu_Z = -\\sigma_Z^2/2$ 以确保 $\\mathbb{E}[U] = 1$。\n- **风险模型**：个体风险为 $h_X = \\lambda_0 U \\cdot \\mathrm{HR}_X^X$，其中 $\\lambda_0$ 是基线风险， $X \\in \\{0,1\\}$ 是二元暴露，$\\mathrm{HR}_X$ 是暴露的风险比。\n- **死亡风险**：在随访期 $T$ 内的死亡概率为 $p_T = 1 - \\exp(-T h_X)$。\n- **就业选择**：被雇佣（$S=1$）的概率由 $\\Pr(S=1 \\mid U) = \\operatorname{logit}^{-1}(\\beta_0 - \\beta_1 \\ln U)$ 决定，其中 $\\beta_1 \\ge 0$。\n- **模拟参数**：总共模拟 $N$ 个个体，重复 $R$ 次。在工人中，以概率 $p_X$ 分配暴露。\n- **指标**：\n    1. $\\mathrm{SMR}_{\\text{unexp}}$：未暴露工人的标准化死亡比，比较观察到的死亡人数与基于外部率 $\\lambda_0$ 的预期死亡人数。\n    2. $\\widehat{\\mathrm{RR}}_{\\text{internal}}$：暴露与未暴露工人之间样本风险的比率。\n    3. $\\mathrm{RR}_{\\text{true}}$：工人人群中的真实因果风险比，通过对工人的经验样本进行g-计算来估计。\n    4. $\\text{Bias}$ 和 $\\text{MSE}$：$\\widehat{\\mathrm{RR}}_{\\text{internal}}$ 作为 $\\mathrm{RR}_{\\text{true}}$ 估计量的蒙特卡洛偏倚和均方误差。\n- **测试用例**：提供了四组特定的参数集 $(\\text{seed}, N, R, \\lambda_0, \\sigma_Z, \\beta_0, \\beta_1, p_X, \\mathrm{HR}_X, T)$。\n\n**步骤2：使用提取的已知信息进行验证**\n- **科学依据**：该模型是对健康工人效应的一个标准且成熟的形式化表述，用于流行病学研究和教学。它使用了体弱模型（对数正态分布）、风险率、生存分析和基于潜在变量的选择等核心概念。所有元素都具有科学合理性。\n- **适定性**：问题以数学精度进行了规定。模拟的所有参数和算法步骤都已定义，确保对于每个测试用例，给定随机数生成器种子，可以获得唯一的、可计算的结果。\n- **客观性**：问题以客观的、数学的术语陈述，没有任何主观性或模糊性。\n\n该问题没有违反任何无效性标准。它是一个定义明确、科学有效且可形式化的模拟任务。\n\n**步骤3：结论与行动**\n该问题是**有效的**。将构建一个解决方案。\n\n### 解决方案推导\n\n该解决方案涉及根据提供的生成模型编写一个蒙特卡洛模拟程序。程序将被构造成可以处理多个测试用例，每个用例都涉及对大小为 $N$ 的人群进行 $R$ 次独立重复模拟。\n\n**核心模拟逻辑（单次重复）**\n\n对于单次重复，我们执行以下步骤，这些步骤被设计用于高效的向量化计算。\n\n1.  **生成人群体弱**：我们从潜在体弱分布中生成 $N$ 个独立的抽样。首先，我们对 $i=1, \\dots, N$ 抽取 $Z_i \\sim \\mathcal{N}(\\mu_Z, \\sigma_Z^2)$，其中 $\\mu_Z = -\\sigma_Z^2/2$。然后，我们计算每个个体的体弱 $U_i = \\exp(Z_i)$。使用 $Z_i = \\ln U_i$ 在计算上很方便。\n\n2.  **模拟就业选择**：对于每个个体 $i$，我们计算其就业概率 $p_{\\text{emp}, i} = \\Pr(S_i=1 \\mid U_i)$。这由逻辑斯谛模型给出：\n    $$ p_{\\text{emp}, i} = \\frac{1}{1 + \\exp(-(\\beta_0 - \\beta_1 Z_i))} $$\n    然后我们抽取就业状态 $S_i \\sim \\mathrm{Bernoulli}(p_{\\text{emp}, i})$。这个过程创建了一个工人子群体（$S_i=1$），在 $\\beta_1 > 0$ 的情况下，他们平均比一般人群更健康（即 $U_i$ 更低）。\n\n3.  **分配暴露并模拟结果**：我们将后续步骤限制在工人队列中（所有 $S_i=1$ 的个体）。\n    -   在工人中，我们随机分配暴露状态 $X_i \\sim \\mathrm{Bernoulli}(p_X)$。关键是，这种分配独立于他们的体弱 $U_i$。\n    -   对于每个工人，我们计算其个体风险 $h_{X,i} = \\lambda_0 U_i \\cdot \\mathrm{HR}_X^{X_i}$ 和在随访期 $T$ 内的死亡风险 $p_{T,i} = 1 - \\exp(-T h_{X,i})$。\n    -   然后从伯努利分布中为每个工人抽取死亡结果 $Y_i$，即 $Y_i \\sim \\mathrm{Bernoulli}(p_{T,i})$。\n\n**指标计算（单次重复）**\n\n在模拟完一次重复的数据后，我们计算所需的量。\n\n1.  **$\\mathrm{SMR}_{\\text{unexp}}$**：我们识别出未暴露的工人组（那些 $S_i=1, X_i=0$ 的个体）。设该组的大小为 $n_0$。\n    -   观察到的死亡人数为 $O = \\sum_{i: S_i=1, X_i=0} Y_i$。\n    -   使用外部一般人群率 $\\lambda_0$ 的预期死亡人数为 $E = n_0 \\cdot \\lambda_0 \\cdot T$。\n    -   本次重复的 SMR 为 $\\mathrm{SMR}_{\\text{unexp}} = O / E$。由于工人比一般人群更健康（当 $\\beta_1 > 0$ 时），我们预期 $\\mathrm{SMR}_{\\text{unexp}} < 1$。\n\n2.  **$\\widehat{\\mathrm{RR}}_{\\text{internal}}$**：我们比较暴露工人与未暴露工人的风险。\n    -   设 $n_1$ 为暴露工人的数量（$S_i=1, X_i=1$）。\n    -   未暴露工人的样本风险为 $\\widehat{R}_0 = (\\sum_{i: S_i=1, X_i=0} Y_i) / n_0$。\n    -   暴露工人的样本风险为 $\\widehat{R}_1 = (\\sum_{i: S_i=1, X_i=1} Y_i) / n_1$。\n    -   内部风险比为 $\\widehat{\\mathrm{RR}}_{\\text{internal}} = \\widehat{R}_1 / \\widehat{R}_0$。\n\n3.  **$\\mathrm{RR}_{\\text{true}}$**：这个量代表了暴露在*本次重复生成的特定工人人群中*对风险的真实因果效应。它是通过使用g-公式，对该样本中工人的 $U_i$ 经验分布进行反事实结果平均来计算的。\n    -   对于每个工人 $i$（体弱为 $U_i$），我们计算他们在无暴露下的反事实风险 $r_{0,i} = 1 - \\exp(-T \\lambda_0 U_i)$，和在暴露下的反事实风险 $r_{1,i} = 1 - \\exp(-T \\lambda_0 U_i \\mathrm{HR}_X)$。\n    -   然后我们对样本中所有工人平均这些风险：$\\bar{r}_0 = \\frac{1}{n_{\\text{workers}}} \\sum_{i: S_i=1} r_{0,i}$ 和 $\\bar{r}_1 = \\frac{1}{n_{\\text{workers}}} \\sum_{i: S_i=1} r_{1,i}$。\n    -   该人群的真实风险比为 $\\mathrm{RR}_{\\text{true}} = \\bar{r}_1 / \\bar{r}_0$。因为暴露 $X$ 是在工人组内随机分配的，因此不受 $U$ 的混淆，所以 $\\widehat{\\mathrm{RR}}_{\\text{internal}}$ 是 $\\mathrm{RR}_{\\text{true}}$ 的一个无偏估计量。\n\n**蒙特卡洛聚合**\n\n整个模拟过程重复 $R$ 次，每次重复使用从主生成器播种的独立随机数流。这确保了跨重复的可复现性和统计独立性。我们收集每次重复 $r=1, \\dots, R$ 的 $\\mathrm{SMR}_{\\text{unexp}}^{(r)}$、$\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)}$ 和 $\\mathrm{RR}_{\\text{true}}^{(r)}$ 的值。\n\n然后计算最终的汇总统计量：\n- **平均 SMR**：$\\overline{\\mathrm{SMR}}_{\\text{unexp}} = \\frac{1}{R} \\sum_{r=1}^R \\mathrm{SMR}_{\\text{unexp}}^{(r)}$。\n- **偏倚**：$\\text{Bias} = \\frac{1}{R} \\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)$。这衡量了内部风险比的平均估计误差。\n- **MSE**：$\\text{MSE} = \\frac{1}{R} \\sum_{r=1}^R \\left(\\widehat{\\mathrm{RR}}_{\\text{internal}}^{(r)} - \\mathrm{RR}_{\\text{true}}^{(r)}\\right)^2$。这衡量了估计量的整体质量，结合了偏倚和方差。\n\n程序将对四个测试用例中的每一个执行此逻辑，并按规定格式化最终结果。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import expit\n\ndef _single_repetition(params, rng):\n    \"\"\"\n    Performs a single repetition of the healthy worker effect simulation.\n    \"\"\"\n    _, N, _, lambda_0, sigma_Z, beta_0, beta_1, p_X, HR_X, T = params\n\n    # Step 1: Generate population frailty\n    # mu_Z = -sigma_Z^2 / 2 ensures E[U] = 1 in the general population\n    mu_Z = -sigma_Z**2 / 2.0\n    # Z is ln(U)\n    Z = rng.normal(mu_Z, sigma_Z, size=N)\n    U = np.exp(Z)\n\n    # Step 2: Simulate employment selection\n    logit_p_emp = beta_0 - beta_1 * Z\n    p_emp = expit(logit_p_emp)\n    S = rng.binomial(1, p_emp, size=N)\n    \n    workers_mask = (S == 1)\n    if not np.any(workers_mask):\n        # In the unlikely event no workers are selected, metrics are undefined\n        return np.nan, np.nan, np.nan\n\n    U_workers = U[workers_mask]\n    num_workers = len(U_workers)\n\n    # Step 3: Assign exposure and simulate outcomes for workers\n    X_workers = rng.binomial(1, p_X, size=num_workers)\n    \n    hazard_workers = lambda_0 * U_workers * (HR_X ** X_workers)\n    risk_workers = 1 - np.exp(-T * hazard_workers)\n    Y_workers = rng.binomial(1, risk_workers, size=num_workers)\n\n    # --- Calculate metrics for this repetition ---\n\n    # 1. Standardized Mortality Ratio (SMR) for unexposed workers\n    unexp_workers_local_mask = (X_workers == 0)\n    n0 = np.sum(unexp_workers_local_mask)\n    smr_unexp = np.nan\n    if n0 > 0:\n        observed_deaths = np.sum(Y_workers[unexp_workers_local_mask])\n        expected_deaths = n0 * lambda_0 * T\n        if expected_deaths > 0:\n            smr_unexp = observed_deaths / expected_deaths\n\n    # 2. Internal Risk Ratio (estimated)\n    exp_workers_local_mask = (X_workers == 1)\n    n1 = np.sum(exp_workers_local_mask)\n    rr_hat = np.nan\n    if n0 > 0 and n1 > 0:\n        risk_hat_0 = np.sum(Y_workers[unexp_workers_local_mask]) / n0\n        risk_hat_1 = np.sum(Y_workers[exp_workers_local_mask]) / n1\n        # Handle case where no deaths occur in the reference group\n        if risk_hat_0 > 0:\n            rr_hat = risk_hat_1 / risk_hat_0\n\n    # 3. True Causal Risk Ratio (g-computation on the worker sample)\n    counterfactual_risk_0 = 1 - np.exp(-T * lambda_0 * U_workers)\n    counterfactual_risk_1 = 1 - np.exp(-T * lambda_0 * U_workers * HR_X)\n    \n    mean_risk_0 = np.mean(counterfactual_risk_0)\n    mean_risk_1 = np.mean(counterfactual_risk_1)\n    \n    rr_true = np.nan\n    if mean_risk_0 > 0:\n        rr_true = mean_risk_1 / mean_risk_0\n        \n    return smr_unexp, rr_hat, rr_true\n\n\ndef run_simulation(params):\n    \"\"\"\n    Runs the Monte Carlo simulation for a given set of parameters.\n    \"\"\"\n    # Unpack parameters\n    seed, _, R, _, _, _, _, _, _, _ = params\n    \n    # Master random number generator\n    rng_master = np.random.default_rng(seed)\n    \n    # Store results from each repetition\n    reps_smr = []\n    reps_rr_hat = []\n    reps_rr_true = []\n\n    # Create independent random number streams for each repetition\n    child_rngs = rng_master.spawn(R)\n    \n    for i in range(R):\n        smr, rr_hat, rr_true = _single_repetition(params, child_rngs[i])\n        reps_smr.append(smr)\n        reps_rr_hat.append(rr_hat)\n        reps_rr_true.append(rr_true)\n\n    # Convert to numpy arrays for vectorized calculations\n    reps_smr = np.array(reps_smr)\n    reps_rr_hat = np.array(reps_rr_hat)\n    reps_rr_true = np.array(reps_rr_true)\n    \n    # --- Aggregate results over R repetitions ---\n    \n    # Calculate average SMR, ignoring any NaNs\n    avg_smr = np.nanmean(reps_smr)\n    \n    # Calculate bias and MSE\n    # Filter out NaNs from ratio calculations, which occur if groups are empty or have zero events\n    valid_mask = ~np.isnan(reps_rr_hat)  ~np.isnan(reps_rr_true)\n    \n    bias, mse = np.nan, np.nan\n    if np.any(valid_mask):\n        diffs = reps_rr_hat[valid_mask] - reps_rr_true[valid_mask]\n        bias = np.mean(diffs)\n        mse = np.mean(diffs**2)\n        \n    return avg_smr, bias, mse\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print the final result.\n    \"\"\"\n    # Test cases defined as tuples:\n    # (seed, N, R, lambda_0, sigma_Z, beta_0, beta_1, p_X, HR_X, T)\n    test_cases = [\n        # Case A: General case\n        (202311, 100000, 40, 0.08, 0.7, 0.0, 1.2, 0.5, 1.5, 5.0),\n        # Case B: No healthy worker effect\n        (202312, 100000, 40, 0.08, 0.7, 0.0, 0.0, 0.5, 1.5, 5.0),\n        # Case C: Strong selection, short follow-up\n        (202313, 100000, 40, 0.08, 0.9, -0.4, 2.0, 0.5, 2.0, 0.5),\n        # Case D: No exposure effect\n        (202314, 100000, 40, 0.08, 0.7, 0.0, 1.0, 0.5, 1.0, 3.0),\n    ]\n\n    all_results = []\n    for case_params in test_cases:\n        avg_smr, bias, mse = run_simulation(case_params)\n        all_results.extend([avg_smr, bias, mse])\n\n    # Format the output as a single comma-separated string with 6 decimal places each\n    formatted_results = [f\"{x:.6f}\" for x in all_results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}