{
    "hands_on_practices": [
        {
            "introduction": "理论是实践的基石。本练习将引导你从第一性原理出发，通过数学推导来揭示伯克森偏倚的核心机制。你将证明，即使两种疾病在普通人群中是相互独立的，但在仅考虑住院患者时，它们之间也会出现一种虚假的负相关关系，从而为理解选择偏倚打下坚实的理论基础 。",
            "id": "4573105",
            "problem": "考虑一个源总体，其中两个二元健康指标 $X$ 和 $Y$ 分别代表两种不同的、非重叠的入院合格病症的存在与否。具体来说，$X=1$ 表示个体患有病症 A，$X=0$ 表示未患病症 A；$Y=1$ 表示个体患有病症 B，$Y=0$ 表示未患病症 B。假设在源总体中，$X$ 和 $Y$ 是独立的，且 $P(X=1)=p$ 和 $P(Y=1)=q$，其中 $0  p, q  1$。入院规则是，当且仅当个体至少患有一种病症（即 $X=1$ 或 $Y=1$）时，他们才会被收治。请推导出在入院患者子集中，$X$ 和 $Y$ 之间的协方差 $\\mathrm{Cov}(X,Y \\mid \\text{入院})$ 的表达式。",
            "solution": "首先验证问题陈述的科学合理性、自洽性和良定性。该问题是概率论中的一个标准的、定义明确的练习，具体涉及条件概率及其在流行病学选择偏倚（伯克森偏倚，Berkson's bias）中的应用。所有变量和条件都已明确定义：两个二元随机变量 $X$ 和 $Y$ 在源总体中独立，且 $P(X=1)=p$ 和 $P(Y=1)=q$，其中 $0  p, q  1$。入院规则是确定性的（当且仅当 $X=1$ 或 $Y=1$ 时入院），并且要求推导条件协方差。该问题在科学上是合理的，在数学上是良定的，并且表述客观。我们将继续提供完整的推导。\n\n### 解答推导\n\n我们的目标是计算条件协方差 $\\mathrm{Cov}(X,Y \\mid S=1)$，其中 $S=1$ 表示入院事件。协方差的定义是：\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\mathbb{E}[XY \\mid S=1] - \\mathbb{E}[X \\mid S=1]\\,\\mathbb{E}[Y \\mid S=1]\n$$\n我们需要计算右侧的三个项。\n\n**1. 条件事件的概率 $P(S=1)$**\n事件 $S=1$ 发生当且仅当 $X=1$ 或 $Y=1$。使用补集规则更容易计算其概率。事件 $S=0$ 发生当且仅当 $X=0$ 且 $Y=0$。由于 $X$ 和 $Y$ 是独立的：\n$$\nP(S=0) = P(X=0, Y=0) = P(X=0)P(Y=0) = (1-p)(1-q)\n$$\n因此，$P(S=1) = 1 - P(S=0) = 1 - (1-p)(1-q) = p+q-pq$。\n\n**2. 条件期望 $\\mathbb{E}[X \\mid S=1]$ 和 $\\mathbb{E}[Y \\mid S=1]$**\n对于二元变量，$E[X \\mid S=1] = P(X=1 \\mid S=1)$。根据条件概率的定义：\n$$\nP(X=1 \\mid S=1) = \\frac{P(X=1 \\text{ and } S=1)}{P(S=1)}\n$$\n事件“$X=1$ 且 $S=1$”等价于“$X=1$ 且 ($X=1$ 或 $Y=1$)”，这简化为事件“$X=1$”。因此，$P(X=1 \\text{ and } S=1) = P(X=1) = p$。\n所以，\n$$\n\\mathbb{E}[X \\mid S=1] = \\frac{p}{p+q-pq}\n$$\n同理，通过对称性可得：\n$$\n\\mathbb{E}[Y \\mid S=1] = \\frac{q}{p+q-pq}\n$$\n\n**3. 条件期望 $\\mathbb{E}[XY \\mid S=1]$**\n对于二元变量，$\\mathbb{E}[XY \\mid S=1] = P(X=1, Y=1 \\mid S=1)$。\n$$\nP(X=1, Y=1 \\mid S=1) = \\frac{P(X=1, Y=1 \\text{ and } S=1)}{P(S=1)}\n$$\n事件“$X=1, Y=1$ 且 $S=1$”简化为事件“$X=1, Y=1$”。由于独立性，$P(X=1, Y=1) = P(X=1)P(Y=1) = pq$。\n所以，\n$$\n\\mathbb{E}[XY \\mid S=1] = \\frac{pq}{p+q-pq}\n$$\n\n**4. 组合各项**\n现在我们将所有部分代入协方差公式：\n\\begin{align*}\n\\mathrm{Cov}(X,Y \\mid S=1) = \\frac{pq}{p+q-pq} - \\left(\\frac{p}{p+q-pq}\\right) \\left(\\frac{q}{p+q-pq}\\right) \\\\\n= \\frac{pq(p+q-pq) - pq}{(p+q-pq)^2} \\\\\n= \\frac{pq(p+q-pq - 1)}{(p+q-pq)^2} \\\\\n= \\frac{pq(-(1-p-q+pq))}{(p+q-pq)^2} \\\\\n= \\frac{-pq(1-p)(1-q)}{(p+q-pq)^2}\n\\end{align*}\n这个最终表达式表明，只要 $p$ 和 $q$ 严格介于 0 和 1 之间，分子就为负，分母为正，因此条件协方差严格为负。这证明了在入院患者中，两种原本独立的疾病之间出现了虚假的负相关关系。",
            "answer": "$$\\boxed{\\mathrm{Cov}(X,Y \\mid \\text{入院}) = \\frac{-pq(1-p)(1-q)}{(p+q-pq)^2}}$$"
        },
        {
            "introduction": "在掌握了基本理论后，让我们将其应用于一个更贴近现实的流行病学研究场景。本练习模拟了一项基于医院的病例对照研究，其中入院概率同时受暴露因素和疾病状态的影响。通过计算和比较真实世界的比值比（Odds Ratio, $OR$）与医院样本中的观测比值比，你将亲手量化伯克森偏倚对关联性度量的具体影响，并体会到它在实际研究中的重要性 。",
            "id": "4573155",
            "problem": "考虑一个源人群，其中暴露 $E \\in \\{0,1\\}$ 和结局（疾病）$D \\in \\{0,1\\}$ 是独立的，且 $P(E=1)=0.30$ 和 $P(D=1)=0.10$。一项以医院为基础的病例对照研究设计仅对入院患者进行抽样，其中入院与否取决于 $E$ 和 $D$ 两者。设入院比值为 $k_{e,d}=\\frac{P(A=1 \\mid E=e,D=d)}{P(A=0 \\mid E=e,D=d)}$，并假设以下特定分层的入院比值已知：$k_{1,1}=9$，$k_{1,0}=3$，$k_{0,1}=6$ 以及 $k_{0,0}=\\frac{1}{5}$。假设个体间的入院决定是相互独立的，并且在入院患者中，病例和对照组分别定义为 $D=1$ 和 $D=0$。\n\n仅使用独立性、比值、概率和比值比（OR）的基本定义，且不使用任何专门的快捷公式，推导出入院患者中观察到的暴露-结局比值比 $\\text{OR}_{\\text{admitted}}$，然后计算偏倚因子 $\\text{BF}=\\frac{\\text{OR}_{\\text{admitted}}}{\\text{OR}_{\\text{true}}}$，其中 $\\text{OR}_{\\text{true}}$ 是源人群中的比值比。将最终的 $\\text{BF}$ 数值四舍五入至四位有效数字。以小数形式表示答案，不要包含百分号。",
            "solution": "在尝试解答之前，对问题进行验证。\n\n### 步骤 1：提取已知条件\n- 源人群变量：暴露 $E \\in \\{0,1\\}$，结局（疾病）$D \\in \\{0,1\\}$。\n- 源人群中的独立性：$E$ 和 $D$ 是独立的。\n- 源人群中的概率：$P(E=1) = 0.30$，$P(D=1) = 0.10$。\n- 入院变量：$A \\in \\{0,1\\}$。\n- 入院比值定义：$k_{e,d} = \\frac{P(A=1 \\mid E=e,D=d)}{P(A=0 \\mid E=e,D=d)}$。\n- 特定入院比值：$k_{1,1}=9$，$k_{1,0}=3$，$k_{0,1}=6$ 以及 $k_{0,0}=\\frac{1}{5}$。\n- 研究设计：以医院为基础的病例对照研究，抽样来自入院患者（$A=1$）。在 $A=1$ 层中，病例为 $D=1$，对照为 $D=0$。\n- 所需计算：推导在入院患者中观察到的比值比 $\\text{OR}_{\\text{admitted}}$，并计算偏倚因子 $\\text{BF}=\\frac{\\text{OR}_{\\text{admitted}}}{\\text{OR}_{\\text{true}}}$。\n- 方法论约束：仅使用基本定义，不使用专门的快捷公式。\n- 最终答案要求：将 $\\text{BF}$ 四舍五入至四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据：** 该问题描述了一个经典的流行病学现象，称为Berkson偏倚或对撞因子分层偏倚。该数学模型是流行病学和生物统计学中使用的标准表示法，用以说明选择偏倚如何产生虚假关联。其前提是合理的。\n- **适定性：** 该问题提供了所有必要的数据（流行率、独立性条件和特定分层的入院比值），足以唯一确定所求量。目标陈述清晰。\n- **客观性：** 该问题以精确、定量且无偏倚的术语陈述。\n\n该问题是有效的，因为它具有科学依据、适定性、客观性且自洽。它呈现了一个流行病学中标准的、可解的情景，没有矛盾或含糊之处。\n\n### 步骤 3：结论与行动\n问题有效。将提供完整解答。\n\n### 解答推导\n\n解答分三部分推导：首先，我们计算源人群中的真实比值比（$\\text{OR}_{\\text{true}}$）；其次，我们计算医院人群中观察到的比值比（$\\text{OR}_{\\text{admitted}}$）；第三，我们计算偏倚因子（$\\text{BF}$）。\n\n**第 1 部分：真实比值比（$\\text{OR}_{\\text{true}}$）**\n\n源人群中的比值比定义为患病者中的暴露比值与非患病者中的暴露比值之比。\n$$\n\\text{OR}_{\\text{true}} = \\frac{\\text{odds}(E=1 \\mid D=1)}{\\text{odds}(E=1 \\mid D=0)} = \\frac{P(E=1 \\mid D=1) / P(E=0 \\mid D=1)}{P(E=1 \\mid D=0) / P(E=0 \\mid D=0)}\n$$\n问题陈述暴露 $E$ 和疾病 $D$ 在源人群中是独立的。根据独立性的定义，$P(E=e \\mid D=d) = P(E=e)$ 对所有 $e, d \\in \\{0,1\\}$ 成立。将此性质应用于比值比表达式：\n$$\n\\text{OR}_{\\text{true}} = \\frac{P(E=1) / P(E=0)}{P(E=1) / P(E=0)} = 1\n$$\n因此，在不存在关联的源人群中，真实比值比为 $1$。\n\n**第 2 部分：观察到的比值比（$\\text{OR}_{\\text{admitted}}$）**\n\n现在分析局限于入院患者的子人群（即，以 $A=1$ 为条件）。观察到的比值比 $\\text{OR}_{\\text{admitted}}$ 是入院病例（$D=1, A=1$）中的暴露比值与入院对照（$D=0, A=1$）中的暴露比值之比。\n$$\n\\text{OR}_{\\text{admitted}} = \\frac{\\text{odds}(E=1 \\mid D=1, A=1)}{\\text{odds}(E=1 \\mid D=0, A=1)} = \\frac{P(E=1 \\mid D=1, A=1) / P(E=0 \\mid D=1, A=1)}{P(E=1 \\mid D=0, A=1) / P(E=0 \\mid D=0, A=1)}\n$$\n使用条件概率的定义 $P(X \\mid Y) = P(X,Y)/P(Y)$，我们可以简化比值项。例如，入院病例中的暴露比值变为：\n$$\n\\frac{P(E=1, D=1, A=1) / P(D=1, A=1)}{P(E=0, D=1, A=1) / P(D=1, A=1)} = \\frac{P(E=1, D=1, A=1)}{P(E=0, D=1, A=1)}\n$$\n将此应用于完整的 $\\text{OR}_{\\text{admitted}}$ 表达式，得到暴露、疾病和入院的联合概率的交叉乘积比：\n$$\n\\text{OR}_{\\text{admitted}} = \\frac{P(E=1, D=1, A=1) \\cdot P(E=0, D=0, A=1)}{P(E=0, D=1, A=1) \\cdot P(E=1, D=0, A=1)}\n$$\n为了计算这个值，我们必须找到四个联合概率 $P(E=e, D=d, A=1)$。每个概率都可以使用概率的链式法则进行分解：\n$$\nP(E=e, D=d, A=1) = P(A=1 \\mid E=e, D=d) \\cdot P(E=e, D=d)\n$$\n由于 $E$ 和 $D$ 在源人群中是独立的，因此 $P(E=e, D=d) = P(E=e) \\cdot P(D=d)$。所以：\n$$\nP(E=e, D=d, A=1) = P(A=1 \\mid E=e, D=d) \\cdot P(E=e) \\cdot P(D=d)\n$$\n首先，我们确定 $E$ 和 $D$ 的概率：\n- $P(E=1) = 0.30 \\implies P(E=0) = 1 - 0.30 = 0.70$\n- $P(D=1) = 0.10 \\implies P(D=0) = 1 - 0.10 = 0.90$\n\n接下来，我们使用关系式 $p = \\frac{\\text{odds}}{1+\\text{odds}}$，将给定的入院比值 $k_{e,d}$ 转换为条件入院概率 $P(A=1 \\mid E=e, D=d)$。\n- $P(A=1 \\mid E=1, D=1) = \\frac{k_{1,1}}{1+k_{1,1}} = \\frac{9}{1+9} = \\frac{9}{10}$\n- $P(A=1 \\mid E=1, D=0) = \\frac{k_{1,0}}{1+k_{1,0}} = \\frac{3}{1+3} = \\frac{3}{4}$\n- $P(A=1 \\mid E=0, D=1) = \\frac{k_{0,1}}{1+k_{0,1}} = \\frac{6}{1+6} = \\frac{6}{7}$\n- $P(A=1 \\mid E=0, D=0) = \\frac{k_{0,0}}{1+k_{0,0}} = \\frac{1/5}{1+1/5} = \\frac{1/5}{6/5} = \\frac{1}{6}$\n\n现在，我们计算四个联合概率：\n- $P(E=1, D=1, A=1) = P(A=1|1,1) P(E=1) P(D=1) = \\frac{9}{10} \\cdot (0.30) \\cdot (0.10) = \\frac{9}{10} \\cdot \\frac{3}{10} \\cdot \\frac{1}{10} = \\frac{27}{1000}$\n- $P(E=1, D=0, A=1) = P(A=1|1,0) P(E=1) P(D=0) = \\frac{3}{4} \\cdot (0.30) \\cdot (0.90) = \\frac{3}{4} \\cdot \\frac{3}{10} \\cdot \\frac{9}{10} = \\frac{81}{400}$\n- $P(E=0, D=1, A=1) = P(A=1|0,1) P(E=0) P(D=1) = \\frac{6}{7} \\cdot (0.70) \\cdot (0.10) = \\frac{6}{7} \\cdot \\frac{7}{10} \\cdot \\frac{1}{10} = \\frac{42}{700} = \\frac{6}{100}$\n- $P(E=0, D=0, A=1) = P(A=1|0,0) P(E=0) P(D=0) = \\frac{1}{6} \\cdot (0.70) \\cdot (0.90) = \\frac{1}{6} \\cdot \\frac{7}{10} \\cdot \\frac{9}{10} = \\frac{63}{600}$\n\n最后，我们将这些联合概率代入 $\\text{OR}_{\\text{admitted}}$ 的表达式中：\n$$\n\\text{OR}_{\\text{admitted}} = \\frac{\\frac{27}{1000} \\cdot \\frac{63}{600}}{\\frac{6}{100} \\cdot \\frac{81}{400}} = \\frac{27 \\cdot 63 \\cdot 100 \\cdot 400}{1000 \\cdot 600 \\cdot 6 \\cdot 81}\n$$\n我们简化此表达式：\n$$\n\\text{OR}_{\\text{admitted}} = \\frac{27 \\cdot 63 \\cdot 40000}{6 \\cdot 81 \\cdot 600000} = \\frac{27 \\cdot 63 \\cdot 4}{6 \\cdot 81 \\cdot 60} = \\frac{1 \\cdot (7 \\cdot 9) \\cdot 4}{6 \\cdot 3 \\cdot 60} = \\frac{7 \\cdot 9 \\cdot 4}{18 \\cdot 60} = \\frac{7 \\cdot 1 \\cdot 4}{2 \\cdot 60} = \\frac{28}{120} = \\frac{7}{30}\n$$\n入院患者中观察到的比值比是 $\\frac{7}{30}$。\n\n**第 3 部分：偏倚因子（$\\text{BF}$）**\n\n偏倚因子是观察到的比值比与真实比值比之比。\n$$\n\\text{BF} = \\frac{\\text{OR}_{\\text{admitted}}}{\\text{OR}_{\\text{true}}} = \\frac{7/30}{1} = \\frac{7}{30}\n$$\n为了提供最终的数值答案，我们按要求将此分数转换为小数并四舍五入到四位有效数字。\n$$\n\\text{BF} = \\frac{7}{30} \\approx 0.233333...\n$$\n四舍五入到四位有效数字得到 $0.2333$。这展示了Berkson偏倚，即两个独立的因素（$E$ 和 $D$）都增加了被选择（入院）的概率，导致在被选择的人群中它们虚假地呈负相关（因为 $\\text{OR}_{\\text{admitted}}  1$）。",
            "answer": "$$\n\\boxed{0.2333}\n$$"
        },
        {
            "introduction": "为了连接抽象理论与数据实践，本练习将指导你通过计算机模拟来“亲眼见证”伯克森偏倚的产生。你将首先推导出条件协方差的理论公式，然后编写程序生成模拟数据，并最终验证模拟结果与理论预测的一致性。这种将数学推导与编程实践相结合的方法，将为你提供一个直观且有力的工具，以加深对这一复杂概念的理解 。",
            "id": "4573152",
            "problem": "您需要实现一个程序，使用二元选择机制凭经验证明伯克森偏误（Berkson’s bias），并验证在对撞因子（collider）上进行条件化时产生的负条件协方差。考虑两个独立的二元变量 $X$ 和 $Y$，其中 $X \\sim \\mathrm{Bernoulli}(p_X)$ 且 $Y \\sim \\mathrm{Bernoulli}(p_Y)$。定义一个选择指示器 $S \\in \\{0,1\\}$，当且仅当 $X=1$ 或 $Y=1$ 时，$S=1$。您的任务如下，仅基于基本概率定义。\n\n1. 使用独立性、条件概率和协方差的定义，推导出以 $p_X$ 和 $p_Y$ 表示的条件协方差 $\\mathrm{Cov}(X,Y \\mid S=1)$ 的封闭形式表达式。唯一允许的起点是：\n   - 独立性：对于所有 $x \\in \\{0,1\\}$ 和 $y \\in \\{0,1\\}$，$P(X=x, Y=y) = P(X=x)\\,P(Y=y)$。\n   - 条件概率：当 $P(B) \\neq 0$ 时，$P(A \\mid B) = \\dfrac{P(A \\cap B)}{P(B)}$。\n   - 二元变量的期望和协方差：$\\mathbb{E}[X \\mid S=1] = P(X=1 \\mid S=1)$，$\\mathbb{E}[XY \\mid S=1] = P(X=1,Y=1 \\mid S=1)$，以及 $\\mathrm{Cov}(X,Y \\mid S=1) = \\mathbb{E}[XY \\mid S=1] - \\mathbb{E}[X \\mid S=1]\\,\\mathbb{E}[Y \\mid S=1]$。\n\n2. 实现一个模拟，对于给定的 $(p_X, p_Y)$，生成 $N$ 个独立的样本对 $(X_i,Y_i)$，其中 $X_i \\sim \\mathrm{Bernoulli}(p_X)$ 且 $Y_i \\sim \\mathrm{Bernoulli}(p_Y)$，当且仅当 $X_i=1$ 或 $Y_i=1$ 时应用选择 $S_i=1$，并计算经验条件协方差\n   $$\\widehat{\\mathrm{Cov}}(X,Y \\mid S=1) = \\widehat{\\mathbb{E}}[XY \\mid S=1] - \\widehat{\\mathbb{E}}[X \\mid S=1]\\;\\widehat{\\mathbb{E}}[Y \\mid S=1],$$\n   其中帽子符号表示限制在 $S=1$ 子集上的样本均值。\n\n3. 对于下面的每个测试用例，计算经验估计值与理论值之间的绝对差：\n   $$\\left|\\widehat{\\mathrm{Cov}}(X,Y \\mid S=1) - \\mathrm{Cov}(X,Y \\mid S=1)\\right|.$$\n\n实现要求：\n- 每个测试用例使用 $N=2{,}000{,}000$ 个模拟样本对。\n- 使用固定的伪随机种子 $20231111$ 以确保结果可复现。\n- 如果 $P(S=1)=0$，则条件协方差未定义，程序应能优雅地处理此情况；但是，所提供的测试套件中不包含此类情况。\n\n测试套件（每个项目指定 $(p_X,p_Y)$）：\n- $(p_X, p_Y) = (0.5, 0.5)$\n- $(p_X, p_Y) = (0.1, 0.1)$\n- $(p_X, p_Y) = (0.9, 0.9)$\n- $(p_X, p_Y) = (0.0, 0.2)$\n- $(p_X, p_Y) = (1.0, 0.3)$\n\n最终输出格式：\n- 您的程序应生成一行输出，其中包含一个包含 $5$ 个浮点数的列表，每个浮点数等于上述定义的一个测试用例的绝对差，顺序与所列顺序相同。将每个浮点数四舍五入到 $6$ 位小数。输出必须是单行，格式完全符合用方括号括起来的逗号分隔列表，例如：$[0.123456,0.000001,0.010000,0.000000,0.500000]$。",
            "solution": "用户提供的问题经评估有效。它在科学上基于概率论，问题阐述清晰，提供了所有必要信息，并且表述客观。任务是通过理论推导和数值模拟来证明伯克森偏误。\n\n### 第 1 部分：条件协方差的理论推导\n\n问题要求推导出条件协方差 $\\mathrm{Cov}(X,Y \\mid S=1)$ 的封闭形式表达式，其中 $X \\sim \\mathrm{Bernoulli}(p_X)$ 和 $Y \\sim \\mathrm{Bernoulli}(p_Y)$ 是独立的二元随机变量，且选择事件为当且仅当 $X=1$ 或 $Y=1$ 时 $S=1$。\n\n提供的条件协方差定义为：\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\mathbb{E}[XY \\mid S=1] - \\mathbb{E}[X \\mid S=1]\\,\\mathbb{E}[Y \\mid S=1]\n$$\n我们将计算右侧的每一项。对于二元变量，期望是变量为 $1$ 的概率。\n\n**1. 条件事件的概率**\n\n条件事件是 $S=1$，它对应于逻辑析取 $(X=1) \\lor (Y=1)$。其概率 $P(S=1)$ 使用补集规则计算。\n事件 $S=0$ 发生当且仅当 $X=0$ 且 $Y=0$。\n$$\nP(S=0) = P(X=0, Y=0)\n$$\n由于 $X$ 和 $Y$ 的独立性，我们有：\n$$\nP(X=0, Y=0) = P(X=0)P(Y=0) = (1-p_X)(1-p_Y)\n$$\n因此，事件 $S=1$ 的概率是：\n$$\nP(S=1) = 1 - P(S=0) = 1 - (1-p_X)(1-p_Y) = 1 - (1 - p_X - p_Y + p_X p_Y) = p_X + p_Y - p_X p_Y\n$$\n为使条件概率有明确定义，必须有 $P(S=1) \\neq 0$。对于所提供的所有测试用例，这一点都成立，因为它仅在 $p_X=0$ 且 $p_Y=0$ 时才为 $0$。\n\n**2. $X$ 和 $Y$ 的条件期望**\n\n给定 $S=1$ 时 $X$ 的条件期望是 $\\mathbb{E}[X \\mid S=1] = P(X=1 \\mid S=1)$。使用条件概率的定义 $P(A \\mid B) = P(A \\cap B) / P(B)$：\n$$\n\\mathbb{E}[X \\mid S=1] = P(X=1 \\mid S=1) = \\frac{P(X=1 \\text{ and } S=1)}{P(S=1)}\n$$\n事件“$X=1$ 且 $S=1$”等价于“$X=1$ 且 ($X=1$ 或 $Y=1$)”，这可以简化为“$X=1$”。因此：\n$$\nP(X=1 \\text{ and } S=1) = P(X=1) = p_X\n$$\n将此式和 $P(S=1)$ 的表达式代入可得：\n$$\n\\mathbb{E}[X \\mid S=1] = \\frac{p_X}{p_X + p_Y - p_X p_Y}\n$$\n根据对称性，$Y$ 的条件期望是：\n$$\n\\mathbb{E}[Y \\mid S=1] = \\frac{p_Y}{p_X + p_Y - p_X p_Y}\n$$\n\n**3. 乘积 $XY$ 的条件期望**\n\n给定 $S=1$ 时乘积 $XY$ 的条件期望是 $\\mathbb{E}[XY \\mid S=1] = P(X=1, Y=1 \\mid S=1)$。\n$$\n\\mathbb{E}[XY \\mid S=1] = P(X=1, Y=1 \\mid S=1) = \\frac{P(X=1, Y=1 \\text{ and } S=1)}{P(S=1)}\n$$\n事件“$X=1, Y=1$ 且 $S=1$”等价于“$X=1, Y=1$ 且 ($X=1$ 或 $Y=1$)”，这可以简化为“$X=1, Y=1$”。由于独立性，$P(X=1, Y=1) = P(X=1)P(Y=1) = p_X p_Y$。因此：\n$$\n\\mathbb{E}[XY \\mid S=1] = \\frac{p_X p_Y}{p_X + p_Y - p_X p_Y}\n$$\n\n**4. 条件协方差的最终表达式**\n\n现在我们将各项组合起来。令 $P_S = p_X + p_Y - p_X p_Y$。\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\mathbb{E}[XY \\mid S=1] - \\mathbb{E}[X \\mid S=1]\\mathbb{E}[Y \\mid S=1]\n$$\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\frac{p_X p_Y}{P_S} - \\left(\\frac{p_X}{P_S}\\right) \\left(\\frac{p_Y}{P_S}\\right) = \\frac{p_X p_Y P_S - p_X p_Y}{P_S^2}\n$$\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\frac{p_X p_Y (P_S - 1)}{P_S^2}\n$$\n代入 $P_S - 1 = (p_X + p_Y - p_X p_Y) - 1 = -(1 - p_X - p_Y + p_X p_Y) = -(1-p_X)(1-p_Y)$。\n这就得到了最终的封闭形式表达式：\n$$\n\\mathrm{Cov}(X,Y \\mid S=1) = \\frac{-p_X p_Y (1-p_X)(1-p_Y)}{(p_X + p_Y - p_X p_Y)^2}\n$$\n该表达式表明，如果 $p_X, p_Y \\in (0,1)$，则条件协方差严格为负。这种在最初独立的变量之间引起的负相关性是伯克森偏误的一种表现，它是一种选择偏误或对撞因子分层偏误（collider stratification bias）。如果 $p_X$ 或 $p_Y$ 为 $0$ 或 $1$，则协方差为 $0$，因为其中一个变量是常数，或者条件化变得无关紧要。\n\n### 第 2 部分：模拟设计\n\n该模拟通过计算条件协方差的经验估计值来验证理论结果。对于每个测试用例 $(p_X, p_Y)$ 的过程如下：\n\n1.  **设置随机数生成器**：使用固定的种子 $20231111$ 初始化一个伪随机数生成器，以确保可复现性。\n2.  **生成样本**：生成 $N=2{,}000{,}000$ 个独立的样本对 $(X_i, Y_i)$，其中 $X_i \\sim \\mathrm{Bernoulli}(p_X)$ 且 $Y_i \\sim \\mathrm{Bernoulli}(p_Y)$。这是通过在 $[0,1)$ 中生成均匀随机数并将其与 $p_X$ 和 $p_Y$ 进行比较来实现的。\n3.  **应用选择**：对于每对 $(X_i, Y_i)$，确定选择指示器 $S_i$。如果 $X_i=1$ 或 $Y_i=1$，则 $S_i=1$，否则 $S_i=0$。创建一个布尔掩码以识别所有 $S_i=1$ 的样本。\n4.  **筛选数据**：通过仅选择那些 $S_i=1$ 的样本对 $(X_i, Y_i)$ 来形成一个新的、较小的数据集。\n5.  **计算经验估计值**：在此选定的子集上计算样本均值以估计条件期望：\n    -   $\\widehat{\\mathbb{E}}[X \\mid S=1] = \\text{所选 } X_i \\text{ 的均值}$。\n    -   $\\widehat{\\mathbb{E}}[Y \\mid S=1] = \\text{所选 } Y_i \\text{ 的均值}$。\n    -   $\\widehat{\\mathbb{E}}[XY \\mid S=1] = \\text{所选 } X_i Y_i \\text{ 的均值}$。\n6.  **计算经验协方差**：使用这些估计值计算经验条件协方差：\n    $$\n    \\widehat{\\mathrm{Cov}}(X,Y \\mid S=1) = \\widehat{\\mathbb{E}}[XY \\mid S=1] - \\widehat{\\mathbb{E}}[X \\mid S=1]\\;\\widehat{\\mathbb{E}}[Y \\mid S=1]\n    $$\n7.  **计算绝对差**：计算经验估计值 $\\widehat{\\mathrm{Cov}}(X,Y \\mid S=1)$ 与第 1 部分推导的理论值 $\\mathrm{Cov}(X,Y \\mid S=1)$ 之间的绝对差。然后将此差值格式化为 $6$ 位小数。\n\n对每个测试用例重复此过程，并将得到的绝对差收集起来，以指定格式打印。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n# from scipy import ...\n\ndef solve():\n    \"\"\"\n    Performs a simulation to demonstrate Berkson's bias, compares the\n    empirical conditional covariance with the theoretical value, and prints\n    the absolute difference for a suite of test cases.\n    \"\"\"\n    # Define the simulation parameters and test cases from the problem statement.\n    N = 2_000_000\n    SEED = 20231111\n    test_cases = [\n        (0.5, 0.5),\n        (0.1, 0.1),\n        (0.9, 0.9),\n        (0.0, 0.2),\n        (1.0, 0.3),\n    ]\n\n    rng = np.random.default_rng(SEED)\n    results = []\n\n    for p_x, p_y in test_cases:\n        # Theoretical calculation\n        # The general formula for conditional covariance is derived as:\n        # Cov(X,Y|S=1) = -p_x*p_y*(1-p_x)*(1-p_y) / (p_x + p_y - p_x*p_y)^2\n        # This formula is valid for all provided test cases, including edge\n        # cases where p_x or p_y is 0 or 1, resulting in a covariance of 0.\n        \n        # Denominator is P(S=1), where S=1 iff X=1 or Y=1\n        denom = p_x + p_y - p_x * p_y\n        \n        if denom == 0:\n            # This occurs only if p_x=0 and p_y=0.\n            # In this case, S is never 1, and the conditional covariance is undefined.\n            # The problem statement guarantees this case will not be in the test suite.\n            theo_cov = np.nan\n        else:\n            numerator = -p_x * p_y * (1.0 - p_x) * (1.0 - p_y)\n            theo_cov = numerator / (denom**2)\n\n        # Simulation\n        # Generate N Bernoulli samples for X and Y\n        x_samples = (rng.random(N)  p_x).astype(np.int8)\n        y_samples = (rng.random(N)  p_y).astype(np.int8)\n\n        # Selection indicator S=1 if X=1 or Y=1\n        s_mask = np.logical_or(x_samples, y_samples)\n\n        # Filter the samples based on the selection criterion S=1\n        x_cond = x_samples[s_mask]\n        y_cond = y_samples[s_mask]\n\n        if x_cond.size == 0:\n            # If no samples are selected, empirical covariance is undefined.\n            # Set to NaN to indicate this. The difference will also be NaN,\n            # but this case is excluded by the problem statement.\n            emp_cov = np.nan\n        else:\n            # Calculate empirical conditional expectations\n            emp_mean_x_cond = np.mean(x_cond)\n            emp_mean_y_cond = np.mean(y_cond)\n\n            # The product XY must be computed on the selected samples\n            xy_prod_cond = x_cond * y_cond\n            emp_mean_xy_cond = np.mean(xy_prod_cond)\n\n            # Calculate the empirical conditional covariance\n            emp_cov = emp_mean_xy_cond - emp_mean_x_cond * emp_mean_y_cond\n\n        # Calculate the absolute difference between empirical and theoretical values\n        abs_diff = np.abs(emp_cov - theo_cov)\n        results.append(f\"{abs_diff:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}