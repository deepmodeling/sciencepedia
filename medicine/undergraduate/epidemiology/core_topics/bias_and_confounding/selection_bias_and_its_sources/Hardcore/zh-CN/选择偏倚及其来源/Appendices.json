{
    "hands_on_practices": [
        {
            "introduction": "为了准确评估和校正选择偏倚，首先必须能在数学上描述它。当选择过程与研究结局相关时，它会系统性地扭曲我们观察到的风险比（$RR$）。本练习将引导你从条件概率的基本定律出发，推导出这种扭曲效应的精确形式——一个被称为偏倚因子（$BF$）的乘数，从而为理解偏倚的量化分析打下坚实的理论基础。",
            "id": "4633341",
            "problem": "考虑一项队列研究，其中包含一个二元暴露 $X \\in \\{0,1\\}$，一个二元结局 $Y \\in \\{0,1\\}$，以及一个二元选择指示变量 $S \\in \\{0,1\\}$，该指示变量表明个体是否被纳入分析样本。令目标参数为人群风险比 $RR_{\\text{pop}} = \\frac{P(Y=1 \\mid X=1)}{P(Y=1 \\mid X=0)}$。假设选择仅依赖于结局，即对于所有 $x \\in \\{0,1\\}$ 和 $y \\in \\{0,1\\}$ 均有 $P(S=1 \\mid Y=y, X=x) = P(S=1 \\mid Y=y)$，并考虑在所选样本中计算的风险比 $RR_{\\text{sel}} = \\frac{P(Y=1 \\mid X=1, S=1)}{P(Y=1 \\mid X=0, S=1)}$。通过关系式 $RR_{\\text{sel}} = RR_{\\text{pop}} \\times BF$ 定义风险比的乘性偏倚因子 $BF$。仅从条件概率定律和 Bayes 定理出发，推导 $BF$，并用比率 $r = \\frac{P(S=1 \\mid Y=1)}{P(S=1 \\mid Y=0)}$ 以及人群风险 $P(Y=1 \\mid X=1)$ 和 $P(Y=1 \\mid X=0)$ 来表示它。提供 $BF$ 的最终表达式。不需要进行数值近似，也没有适用的单位。",
            "solution": "该问题在科学上基于流行病学和概率论的原理，问题陈述清晰，信息充分且一致，表述客观，因此是有效的。我们可以继续进行推导。\n\n我们的目标是推导乘性偏倚因子 $BF$ 的表达式，该因子由关系式 $RR_{\\text{sel}} = RR_{\\text{pop}} \\times BF$ 定义。量 $RR_{\\text{sel}}$ 和 $RR_{\\text{pop}}$ 分别是所选样本和总人群中的风险比。\n\n人群风险比由下式给出：\n$$RR_{\\text{pop}} = \\frac{P(Y=1 \\mid X=1)}{P(Y=1 \\mid X=0)}$$\n\n在所选样本（其中选择指示变量 $S=1$）中计算的风险比为：\n$$RR_{\\text{sel}} = \\frac{P(Y=1 \\mid X=1, S=1)}{P(Y=1 \\mid X=0, S=1)}$$\n\n为了求出偏倚因子，我们必须首先使用人群层面的概率来表示 $RR_{\\text{sel}}$ 中的各项。让我们分析在给定暴露状态 $x \\in \\{0,1\\}$ 时，所选子人群中风险的一般项 $P(Y=1 \\mid X=x, S=1)$。\n\n使用 Bayes 定理，我们可以反转对事件 $S=1$ 的条件：\n$$P(Y=1 \\mid X=x, S=1) = \\frac{P(S=1 \\mid Y=1, X=x) P(Y=1 \\mid X=x)}{P(S=1 \\mid X=x)}$$\n\n问题陈述选择仅依赖于结局，这对应于条件独立性陈述 $S \\perp X \\mid Y$。形式上，这表示为对所有 $x, y$ 都有 $P(S=1 \\mid Y=y, X=x) = P(S=1 \\mid Y=y)$。将此应用于我们表达式的分子，我们得到：\n$$P(S=1 \\mid Y=1, X=x) = P(S=1 \\mid Y=1)$$\n\n接下来，我们通过对结局 Y 进行边缘化，使用全概率定律来展开分母 $P(S=1 \\mid X=x)$：\n$$P(S=1 \\mid X=x) = \\sum_{y \\in \\{0,1\\}} P(S=1, Y=y \\mid X=x)$$\n$$P(S=1 \\mid X=x) = P(S=1 \\mid Y=1, X=x) P(Y=1 \\mid X=x) + P(S=1 \\mid Y=0, X=x) P(Y=0 \\mid X=x)$$\n再次应用条件独立性假设 $S \\perp X \\mid Y$，我们得到：\n$$P(S=1 \\mid X=x) = P(S=1 \\mid Y=1) P(Y=1 \\mid X=x) + P(S=1 \\mid Y=0) P(Y=0 \\mid X=x)$$\n由于 Y 是二元的，因此 $P(Y=0 \\mid X=x) = 1 - P(Y=1 \\mid X=x)$。代入此式可得：\n$$P(S=1 \\mid X=x) = P(S=1 \\mid Y=1) P(Y=1 \\mid X=x) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=x))$$\n\n现在，我们将简化后的分子和展开后的分母代回所选组风险的表达式中：\n$$P(Y=1 \\mid X=x, S=1) = \\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=x)}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=x) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=x))}$$\n\n有了这个一般表达式，我们可以通过取 $x=1$ 和 $x=0$ 的比率来构建 $RR_{\\text{sel}}$：\n$$RR_{\\text{sel}} = \\frac{P(Y=1 \\mid X=1, S=1)}{P(Y=1 \\mid X=0, S=1)}$$\n代入我们推导出的表达式：\n$$RR_{\\text{sel}} = \\frac{\\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1)}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=1))}}{\\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0)}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=0))}}$$\n这个繁分数可以被简化。我们重新排列各项以分离出人群风险比：\n$$RR_{\\text{sel}} = \\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1)}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0)} \\times \\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=0))}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=1))}$$\n第一项分数中的 $P(S=1 \\mid Y=1)$ 项相消，剩下人群风险比 $RR_{\\text{pop}}$：\n$$RR_{\\text{sel}} = \\frac{P(Y=1 \\mid X=1)}{P(Y=1 \\mid X=0)} \\times \\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=0))}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=1))}$$\n通过将其与定义 $RR_{\\text{sel}} = RR_{\\text{pop}} \\times BF$ 进行比较，我们可以确定偏倚因子 BF 为：\n$$BF = \\frac{P(S=1 \\mid Y=1) P(Y=1 \\mid X=0) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=0))}{P(S=1 \\mid Y=1) P(Y=1 \\mid X=1) + P(S=1 \\mid Y=0) (1 - P(Y=1 \\mid X=1))}$$\n\n最后，我们必须用指定的比率 $r = \\frac{P(S=1 \\mid Y=1)}{P(S=1 \\mid Y=0)}$ 以及人群风险 $P(Y=1 \\mid X=1)$ 和 $P(Y=1 \\mid X=0)$ 来表示 $BF$。为此，我们将 $BF$ 表达式的分子和分母同时除以 $P(S=1 \\mid Y=0)$，假设 $P(S=1 \\mid Y=0) \\neq 0$：\n$$BF = \\frac{\\frac{P(S=1 \\mid Y=1)}{P(S=1 \\mid Y=0)} P(Y=1 \\mid X=0) + (1 - P(Y=1 \\mid X=0))}{\\frac{P(S=1 \\mid Y=1)}{P(S=1 \\mid Y=0)} P(Y=1 \\mid X=1) + (1 - P(Y=1 \\mid X=1))}$$\n将 r 代入此表达式，得到最终结果：\n$$BF = \\frac{r P(Y=1 \\mid X=0) + 1 - P(Y=1 \\mid X=0)}{r P(Y=1 \\mid X=1) + 1 - P(Y=1 \\mid X=1)}$$\n此表达式量化了因基于结局变量选择研究样本而对风险比产生的乘性偏倚。",
            "answer": "$$\n\\boxed{\\frac{r P(Y=1 \\mid X=0) + 1 - P(Y=1 \\mid X=0)}{r P(Y=1 \\mid X=1) + 1 - P(Y=1 \\mid X=1)}}\n$$"
        },
        {
            "introduction": "理论推导为我们提供了理解偏倚的框架，而数值计算则让我们能将其应用于实际问题。本练习基于一个假设的研究场景，其中观察到的风险比因选择偏倚而被夸大。你的任务是利用给定的选择概率，首先计算出这个被偏倚的风险比，然后推导出偏倚校正因子，并最终估算出无偏倚的真实风险比，从而体验从识别偏倚到量化校正的全过程。",
            "id": "4633382",
            "problem": "一位研究者在一项观察性队列研究中，研究暴露 $E \\in \\{0,1\\}$ 与二元结局 $D \\in \\{0,1\\}$ 之间的关联。令 $S \\in \\{0,1\\}$ 表示是否被选入分析样本，其中 $S=1$ 表示被纳入。该研究者报告，在被选中的个体中，暴露组的结局风险为 $0.24$，非暴露组的结局风险为 $0.08$。用符号表示为，$P(D=1 \\mid E=1, S=1)=0.24$ 和 $P(D=1 \\mid E=0, S=1)=0.08$。\n\n后来发现，样本选择同时取决于 $E$ 和 $D$，其经验支持的概率如下：\n- $P(S=1 \\mid E=1, D=1)=0.90$，\n- $P(S=1 \\mid E=1, D=0)=0.30$，\n- $P(S=1 \\mid E=0, D=1)=0.30$，\n- $P(S=1 \\mid E=0, D=0)=0.20$。\n\n假设在源人群中，在 $E$ 的各个水平上，结局是罕见的（罕见结局近似法），并且除了选择偏倚外，没有其他偏倚来源。仅使用核心概率定义和风险比的定义（风险比 (RR) $=$ $P(D=1 \\mid E=1)/P(D=1 \\mid E=0)$），按以下步骤进行：\n\n1. 计算在被选个体中观察到的风险比 $\\mathrm{RR}_{\\text{obs}}$。\n2. 根据第一性原理和所述的罕见结局近似法，推导由给定选择概率所隐含的乘性选择偏倚因子 $\\mathrm{BF}$，其中该偏倚因子量化了选择如何对风险比产生乘性扭曲。然后计算 $\\mathrm{BF}^{-1}$。\n3. 计算经选择偏倚校正后的风险比 $\\mathrm{RR}_{\\text{corr}}=\\mathrm{RR}_{\\text{obs}} \\times \\mathrm{BF}^{-1}$ 并报告此值。\n\n将最终答案表示为单个实数（无单位，无百分号）。如果需要任何近似，可以使用上述的罕见结局近似法；否则，提供精确值。",
            "solution": "该问题要求根据观察数据和一组已知的选择概率，计算经选择偏倚校正后的风险比。该问题提法明确，具有流行病学原理的科学依据，并为在指定的罕见结局近似法下获得唯一解提供了所有必要数据。因此，该问题是有效的。\n\n解题过程按照题目要求分三步进行。\n\n步骤 1：计算观察到的风险比 $\\mathrm{RR}_{\\text{obs}}$。\n观察到的风险比 $\\mathrm{RR}_{\\text{obs}}$ 是在被选个体 ($S=1$) 中测得的暴露组 ($E=1$) 的结局风险 ($D=1$) 与非暴露组 ($E=0$) 的风险之比。题目直接给出了这些风险值。\n已知：\n暴露的被选个体的风险：$P(D=1 \\mid E=1, S=1) = 0.24$\n非暴露的被选个体的风险：$P(D=1 \\mid E=0, S=1) = 0.08$\n\n因此，观察到的风险比为：\n$$\n\\mathrm{RR}_{\\text{obs}} = \\frac{P(D=1 \\mid E=1, S=1)}{P(D=1 \\mid E=0, S=1)} = \\frac{0.24}{0.08} = 3\n$$\n\n步骤 2：推导乘性选择偏倚因子 $\\mathrm{BF}$，并计算其倒数 $\\mathrm{BF}^{-1}$。\n选择偏倚因子 $\\mathrm{BF}$ 是一个乘性因子，它表示真实风险比 $\\mathrm{RR}$ 经过扭曲后产生观察到的风险比 $\\mathrm{RR}_{\\text{obs}}$ 的倍数。真实风险比在源人群中定义为 $\\mathrm{RR} = \\frac{P(D=1 \\mid E=1)}{P(D=1 \\mid E=0)}$。它们之间的关系是：\n$$\n\\mathrm{RR}_{\\text{obs}} = \\mathrm{RR} \\times \\mathrm{BF}\n$$\n为了推导 $\\mathrm{BF}$，我们将 $\\mathrm{RR}_{\\text{obs}}$ 用真实风险和选择概率来表示。使用贝叶斯定理 (Bayes' theorem)，我们可以将以选择为条件的风险写成：\n$$\nP(D=1 \\mid E, S=1) = \\frac{P(S=1 \\mid D=1, E) P(D=1 \\mid E)}{P(S=1 \\mid E)}\n$$\n将此代入 $\\mathrm{RR}_{\\text{obs}}$ 的表达式中：\n$$\n\\mathrm{RR}_{\\text{obs}} = \\frac{\\frac{P(S=1 \\mid D=1, E=1) P(D=1 \\mid E=1)}{P(S=1 \\mid E=1)}}{\\frac{P(S=1 \\mid D=1, E=0) P(D=1 \\mid E=0)}{P(S=1 \\mid E=0)}}\n$$\n重新排列各项以分离出真实风险比 $\\mathrm{RR}$：\n$$\n\\mathrm{RR}_{\\text{obs}} = \\left( \\frac{P(D=1 \\mid E=1)}{P(D=1 \\mid E=0)} \\right) \\times \\left( \\frac{P(S=1 \\mid D=1, E=1)}{P(S=1 \\mid D=1, E=0)} \\right) \\times \\left( \\frac{P(S=1 \\mid E=0)}{P(S=1 \\mid E=1)} \\right)\n$$\n$$\n\\mathrm{RR}_{\\text{obs}} = \\mathrm{RR} \\times \\underbrace{\\left( \\frac{P(S=1 \\mid D=1, E=1)}{P(S=1 \\mid D=1, E=0)} \\right) \\times \\left( \\frac{P(S=1 \\mid E=0)}{P(S=1 \\mid E=1)} \\right)}_{\\mathrm{BF}}\n$$\n偏倚因子 $\\mathrm{BF}$ 包含 $P(S=1 \\mid E=1)$ 和 $P(S=1 \\mid E=0)$ 这两项，需要进行简化。我们使用全概率公式，以结局 $D$ 为条件对其进行展开：\n$$\nP(S=1 \\mid E) = P(S=1 \\mid D=1, E)P(D=1 \\mid E) + P(S=1 \\mid D=0, E)P(D=0 \\mid E)\n$$\n由于 $P(D=0 \\mid E) = 1 - P(D=1 \\mid E)$，上式变为：\n$$\nP(S=1 \\mid E) = P(S=1 \\mid D=1, E)P(D=1 \\mid E) + P(S=1 \\mid D=0, E)(1 - P(D=1 \\mid E))\n$$\n现在，我们应用“罕见结局近似法”，该方法指出在源人群中，每个暴露分层内的结局都是罕见的。这意味着 $P(D=1 \\mid E=1) \\approx 0$ 且 $P(D=1 \\mid E=0) \\approx 0$。\n在此近似下：\n- $1 - P(D=1 \\mid E) \\approx 1$。\n- 与第二项相比，$P(S=1 \\mid D=1, E)P(D=1 \\mid E)$ 这一项变得可以忽略不计。\n因此，$P(S=1 \\mid E)$ 的表达式简化为：\n$$\nP(S=1 \\mid E) \\approx P(S=1 \\mid D=0, E)\n$$\n对 $E=1$ 和 $E=0$ 应用此近似：\n$P(S=1 \\mid E=1) \\approx P(S=1 \\mid D=0, E=1)$\n$P(S=1 \\mid E=0) \\approx P(S=1 \\mid D=0, E=0)$\n将这些近似值代回 $\\mathrm{BF}$ 的公式中：\n$$\n\\mathrm{BF} \\approx \\left( \\frac{P(S=1 \\mid D=1, E=1)}{P(S=1 \\mid D=1, E=0)} \\right) \\times \\left( \\frac{P(S=1 \\mid D=0, E=0)}{P(S=1 \\mid D=0, E=1)} \\right)\n$$\n现在，我们代入给定的选择概率数值：\n- $P(S=1 \\mid E=1, D=1) = 0.90$\n- $P(S=1 \\mid E=0, D=1) = 0.30$\n- $P(S=1 \\mid E=1, D=0) = 0.30$\n- $P(S=1 \\mid E=0, D=0) = 0.20$\n$$\n\\mathrm{BF} \\approx \\frac{0.90}{0.30} \\times \\frac{0.20}{0.30} = 3 \\times \\frac{2}{3} = 2\n$$\n题目要求计算偏倚因子的倒数 $\\mathrm{BF}^{-1}$：\n$$\n\\mathrm{BF}^{-1} \\approx \\frac{1}{2} = 0.5\n$$\n\n步骤 3：计算经选择偏倚校正后的风险比 $\\mathrm{RR}_{\\text{corr}}$。\n校正后的风险比定义为 $\\mathrm{RR}_{\\text{corr}} = \\mathrm{RR}_{\\text{obs}} \\times \\mathrm{BF}^{-1}$。这等同于求解真实风险比 $\\mathrm{RR} = \\mathrm{RR}_{\\text{obs}} / \\mathrm{BF}$。\n使用前面步骤的结果：\n$\\mathrm{RR}_{\\text{obs}} = 3$\n$\\mathrm{BF}^{-1} \\approx 0.5$\n因此，经选择偏倚校正后的风险比为：\n$$\n\\mathrm{RR}_{\\text{corr}} \\approx 3 \\times 0.5 = 1.5\n$$\n该值代表了在考虑了选择偏倚后，源人群中估计的风险比。",
            "answer": "$$\\boxed{1.5}$$"
        },
        {
            "introduction": "当偏倚的结构变得复杂时，纯粹的解析推导可能变得异常困难。蒙特卡洛模拟为我们提供了一种强大的计算工具，用以探索不同偏倚情景下估计量的表现。本练习将指导你设计一个模拟研究，比较三种不同的估计量（朴素估计量、调整后的完整病例估计量和逆概率加权估计量）在多种选择机制下的性能，包括经典的对撞偏倚和因未测量变量导致的非随机缺失。这项实践旨在培养现代流行病学研究中至关重要的计算和方法学评估技能。",
            "id": "4633363",
            "problem": "您的任务是设计并实现一个蒙特卡洛模拟研究，以量化结果删失下的选择偏倚，并比较三种边际暴露效应的估计量：一个朴素的未调整完整病例估计量、一个调整后的完整病例估计量，以及一个逆概率加权（IPW）估计量。研究的核心现象是由信息性删失引起的选择偏倚，特别是当删失概率取决于同时也能预测结果的变量时。\n\n推导的基本依据：您必须从选择偏倚、缺失机制以及通过条件化或重加权进行识别的核心定义出发。具体来说：当以暴露和另一个预测变量的共同效应（对撞因子）变量为条件时，会产生选择偏倚；在给定协变量下随机缺失意味着，在观测到的协变量的条件下，缺失指示符与结果独立；逆概率加权通过对每个完整观测值按其选择概率的倒数进行重加权，来恢复目标边际分布。\n\n所有模拟中使用的数据生成机制：\n- 对于每次重复，生成一个大小为 $n$ 的样本，包含二元暴露 $A \\in \\{0,1\\}$、基线协变量 $Z \\in \\mathbb{R}$，以及可能存在的未测量协变量 $U \\in \\mathbb{R}$。从 $A \\sim \\text{Bernoulli}(p_A)$、$Z \\sim \\mathcal{N}(0,1)$ 中抽样，并且当 $U$ 存在时，从独立于 $A$ 和 $Z$ 的 $U \\sim \\mathcal{N}(0,1)$ 中抽样。\n- 生成一个连续结果\n$$\nY \\;=\\; \\beta_0 \\;+\\; \\beta_A A \\;+\\; \\beta_Z Z \\;+\\; \\beta_U U \\;+\\; \\varepsilon,\n$$\n其中 $\\varepsilon \\sim \\mathcal{N}(0,\\sigma^2)$ 是独立噪声，在没有 $U$ 的情景中，$\\beta_U$ 设为 $0$。\n- 生成一个删失指示符 $R \\in \\{0,1\\}$，使得 $R=1$ 表示 $Y$ 被观测到。选择模型为逻辑斯谛模型：\n$$\n\\Pr(R=1 \\mid A,Z,U) \\;=\\; \\operatorname{expit}\\left(\\alpha_0 + \\alpha_A A + \\alpha_Z Z + \\alpha_U U\\right),\n$$\n其中 $\\operatorname{expit}(x)=\\frac{1}{1+e^{-x}}$。在没有 $U$ 的情景中，设置 $\\alpha_U=0$。观测到的结果为 $Y_{\\text{obs}} = Y$（如果 $R=1$），否则缺失。分析师总是能观测到所有个体的 $(A,Z,R)$，但只有当 $R=1$ 时才能观测到 $Y$。\n\n待估量：\n- 目标待估量是边际暴露效应\n$$\n\\Delta \\;=\\; \\mathbb{E}[Y \\mid A=1] \\;-\\; \\mathbb{E}[Y \\mid A=0].\n$$\n在上述线性模型中，当 $A$ 独立于 $Z$ 和 $U$，且 $\\mathbb{E}[Z]=0$ 和 $\\mathbb{E}[U]=0$ 时，待估量等于 $\\Delta = \\beta_A$。\n\n待比较的估计量：\n- 朴素未调整完整病例估计量 $\\widehat{\\Delta}_{\\text{naive}}$：仅在 $R=1$ 的个体中计算的 $A=1$ 和 $A=0$ 之间 $Y$ 的样本均值之差，忽略 $Z$。\n- 调整后完整病例估计量 $\\widehat{\\Delta}_{\\text{cc}}$：仅对 $R=1$ 的个体拟合 $Y$ 对截距项、$A$ 和 $Z$ 的普通最小二乘回归，得到的 $A$ 的系数。\n- IPW 估计量 $\\widehat{\\Delta}_{\\text{ipw}}$：为 $R=1$ 的个体定义权重 $w = 1/\\Pr(R=1 \\mid A,Z)$（只有测量到的预测变量 $A$ 和 $Z$ 进入权重计算）。对于 $a \\in \\{0,1\\}$，估计加权均值 $\\widehat{\\mu}_a = \\sum_{i: R_i=1, A_i=a} w_i Y_i / \\sum_{i: R_i=1, A_i=a} w_i$，并设 $\\widehat{\\Delta}_{\\text{ipw}} = \\widehat{\\mu}_1 - \\widehat{\\mu}_0$。在选择模型仅使用 $A$ 和 $Z$ 的情景中，使用真实的选择概率作为权重。在选择依赖于未测量的 $U$ 的情景中，使用忽略了 $U$ 的错误设定的模型来计算权重（即，使用不正确的 $\\Pr(R=1 \\mid A,Z)$），以说明残余偏倚。\n\n偏倚定义：\n- 对于每个估计量 $\\widehat{\\Delta}$，将偏倚定义为\n$$\n\\text{bias}(\\widehat{\\Delta}) \\;=\\; \\mathbb{E}[\\widehat{\\Delta}] \\;-\\; \\Delta.\n$$\n通过跨重复的蒙特卡洛平均来近似期望值。\n\n模拟和测试套件：\n- 在所有模拟中固定以下常量：$p_A = 0.5$, $\\beta_0 = 0$, $\\beta_A = 1$, $\\beta_Z = 1$, $\\sigma^2=1$。当存在时，设 $\\beta_U=1$。\n- 每次重复使用 $n=5000$ 个个体，共 $M=200$ 次重复，并使用固定的随机数生成器种子 $12345$。\n- 实现以下五个情景，每个情景由 $(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U)$ 定义：\n    1. 情景 A (非信息性删失)：$(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U) = (0.5, 0, 0, 0, 0)$。\n    2. 情景 B (删失仅依赖于暴露)：$(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U) = (0, 1, 0, 0, 0)$。\n    3. 情景 C (删失仅依赖于协变量)：$(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U) = (0, 0, 1, 0, 0)$。\n    4. 情景 D (对撞因子诱导的选择：依赖于暴露和协变量)：$(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U) = (0, 1, 1, 0, 0)$。\n    5. 情景 E (由于未测量的预测变量导致的非随机缺失)：$(\\alpha_0,\\alpha_A,\\alpha_Z,\\alpha_U,\\beta_U) = (0, 1, 1, 1, 1)$。\n- 对于情景 A-D，按规定使用真实的 $\\Pr(R=1 \\mid A,Z)$ 计算 IPW；对于情景 E，使用忽略了 $U$ 的错误设定模型计算 IPW，即使用 $\\Pr(R=1 \\mid A,Z)$ 而不是 $\\Pr(R=1 \\mid A,Z,U)$。\n\n要求输出：\n- 对于每个情景，计算每个估计量在 $M$ 次重复中的蒙特卡洛平均偏倚。将这些偏倚表示为 $b_{\\text{naive}}, b_{\\text{cc}}, b_{\\text{ipw}}$。将情景 A 到 E 的输出汇总成一个长度为 15 的扁平列表，顺序固定如下：\n$$\n[b_{\\text{naive}}^{(A)}, b_{\\text{cc}}^{(A)}, b_{\\text{ipw}}^{(A)}, b_{\\text{naive}}^{(B)}, b_{\\text{cc}}^{(B)}, b_{\\text{ipw}}^{(B)}, b_{\\text{naive}}^{(C)}, b_{\\text{cc}}^{(C)}, b_{\\text{ipw}}^{(C)}, b_{\\text{naive}}^{(D)}, b_{\\text{cc}}^{(D)}, b_{\\text{ipw}}^{(D)}, b_{\\text{naive}}^{(E)}, b_{\\text{cc}}^{(E)}, b_{\\text{ipw}}^{(E)} ].\n$$\n- 您的程序应生成单行输出，包含一个用方括号括起来的逗号分隔列表的结果（例如，\"[$x_1,x_2,\\dots,x_{15}$]\"）。将偏倚表示为实数（浮点数）。不涉及物理单位。\n\n科学真实性约束：\n- 通过逻辑斯谛链接函数确保选择概率保持在开区间 $(0,1)$ 内。\n- 使用选择偏倚和缺失机制的定义作为基本依据；不要依赖于未记录的快捷方式或预先推导的偏倚公式。\n\n您的任务是按照规定实现模拟，并打印所需的单行输出。程序不应读取任何用户输入。请严格按照规定使用随机种子和参数，以确保可复现性。",
            "solution": "问题陈述是有效的。它提出了一个定义明确且有科学依据的蒙特卡洛模拟研究，旨在探究流行病学中的选择偏倚。数据生成机制、待估量和估计量都以数学精度进行了规定，且模拟参数是完整的。所设计的情景旨在阐释基本概念，如对撞偏倚和由未测量混杂因素引起的偏倚，这些都是因果推断和缺失数据研究的核心。该问题是客观的，并要求一个定量的、可复现的解决方案。\n\n目标是实现此模拟，以量化在五种不同数据删失情景下，三种不同估计量对边际暴露效应 $\\Delta$ 的偏倚。待估量的真值已知为 $\\Delta = \\beta_A = 1$。对于任何估计量 $\\widehat{\\Delta}$，其偏倚通过蒙特卡洛近似计算为 $\\text{bias}(\\widehat{\\Delta}) = \\mathbb{E}[\\widehat{\\Delta}] - \\Delta \\approx \\left(\\frac{1}{M} \\sum_{j=1}^{M} \\widehat{\\Delta}^{(j)}\\right) - 1$，其中 $M=200$ 是模拟重复的次数。\n\n整体逻辑流程涉及一个嵌套循环结构。外层循环遍历五个指定的情景，内层循环对每个情景运行 $M=200$ 次重复。在每次重复中，执行以下步骤：\n\n1.  **数据生成**：根据指定的数据生成机制（DGM）生成一个大小为 $n=5000$ 的数据集。\n    -   二元暴露 $A$ 从伯努利分布 $A \\sim \\text{Bernoulli}(p_A)$ 中抽取，其中 $p_A=0.5$。\n    -   基线协变量 $Z$ 从标准正态分布 $Z \\sim \\mathcal{N}(0,1)$ 中抽取。\n    -   对于情景 E，未测量的协变量 $U$ 也从标准正态分布 $U \\sim \\mathcal{N}(0,1)$ 中抽取。对于所有其他情景，其效应 $\\beta_U$ 为 $0$。\n    -   误差项 $\\varepsilon$ 从均值为 $0$、方差为 $\\sigma^2=1$ 的正态分布中抽取，即 $\\varepsilon \\sim \\mathcal{N}(0,1)$。\n    -   连续结果 $Y$ 作为线性函数生成：$Y = \\beta_0 + \\beta_A A + \\beta_Z Z + \\beta_U U + \\varepsilon$，其中参数 $\\beta_0=0$，$\\beta_A=1$，$\\beta_Z=1$，而 $\\beta_U$ 在情景 E 中为 $1$，否则为 $0$。\n    -   删失指示符 $R \\in \\{0, 1\\}$ 从伯努利试验中生成，其中被观测到的概率 ($R=1$) 由逻辑斯谛模型给出：$\\Pr(R=1 \\mid A,Z,U) = \\operatorname{expit}(\\alpha_0 + \\alpha_A A + \\alpha_Z Z + \\alpha_U U)$。系数 $(\\alpha_0, \\alpha_A, \\alpha_Z, \\alpha_U)$ 由具体情景定义。\n    -   可用于分析的数据集包括所有个体 $i=1, \\dots, n$ 的 $(A_i, Z_i, R_i)$，以及仅对 $R_i=1$ 的那些个体的结果 $Y_i$。\n\n2.  **估计**：使用三种不同方法从生成的数据中估计边际效应 $\\Delta$。所有估计量都在数据的完整病例子集（其中 $R=1$）上操作。\n    -   **朴素未调整估计量 ($\\widehat{\\Delta}_{\\text{naive}}$)**：这是暴露组 ($A=1$) 和非暴露组 ($A=0$) 之间观测结果 $Y_{\\text{obs}}$ 样本均值的简单差值。\n        $$ \\widehat{\\Delta}_{\\text{naive}} = \\frac{\\sum_{i: R_i=1, A_i=1} Y_i}{\\sum_{i: R_i=1} I(A_i=1)} - \\frac{\\sum_{i: R_i=1, A_i=0} Y_i}{\\sum_{i: R_i=1} I(A_i=0)} $$\n    -   **调整后完整病例估计量 ($\\widehat{\\Delta}_{\\text{cc}}$)**：该估计量是通过对结果 $Y$、截距项、暴露 $A$ 和协变量 $Z$ 进行普通最小二乘（OLS）回归所获得的暴露 $A$ 的系数。回归仅在 $R=1$ 的个体子集上拟合。这是通过在模型 $Y_{\\text{obs}} \\sim \\beta'_0 + \\beta'_A A_{\\text{obs}} + \\beta'_Z Z_{\\text{obs}}$ 上使用 `numpy.linalg.lstsq` 来实现的。$\\widehat{\\Delta}_{\\text{cc}}$ 是所得的估计值 $\\beta'_A$。\n    -   **逆概率加权估计量 ($\\widehat{\\Delta}_{\\text{ipw}}$)**：该估计量计算完整病例中的加权均值差。每个被观测到的个体 $i$ 被赋予一个权重 $w_i$，该权重等于其被观测概率的倒数。\n        -   对于情景 A-D，权重使用真实的选择模型计算，该模型仅依赖于 $A$ 和 $Z$：$w_i = 1 / \\Pr(R_i=1 \\mid A_i, Z_i) = 1 / \\operatorname{expit}(\\alpha_0 + \\alpha_A A_i + \\alpha_Z Z_i)$。\n        -   对于情景 E，真实的选择机制包括未测量的变量 $U$。按照指示，IPW 估计量被故意错误设定，使用的权重基于一个忽略了 $U$ 的模型：$w_i = 1 / \\operatorname{expit}(\\alpha_0 + \\alpha_A A_i + \\alpha_Z Z_i)$，其中系数是为情景 E 指定的那些。这模拟了研究人员不知道 $U$ 存在的分析。\n        然后，估计值计算为 $\\widehat{\\Delta}_{\\text{ipw}} = \\widehat{\\mu}_1 - \\widehat{\\mu}_0$，其中 $\\widehat{\\mu}_a = \\frac{\\sum_{i: R_i=1, A_i=a} w_i Y_i}{\\sum_{i: R_i=1, A_i=a} w_i}$。\n\n3.  **偏倚汇总**：在给定情景下完成 $M=200$ 次重复后，计算三种方法中每一种的平均估计值。然后通过减去真实效应 $\\Delta=1$ 来得到偏倚。对所有五个情景重复此过程。\n\n最终输出是一个扁平化列表，按指定顺序包含五个情景中每种情景的三个计算出的偏倚值 ($b_{\\text{naive}}, b_{\\text{cc}}, b_{\\text{ipw}}$)。实现使用了 `numpy` 库进行数值运算和随机数生成，并使用 `scipy.special.expit` 来实现逻辑斯谛函数，同时遵守指定的环境约束。随机种子固定为 $12345$ 以确保可复现性。",
            "answer": "```python\nimport numpy as np\nfrom scipy.special import expit\n\ndef solve():\n    \"\"\"\n    Implements a Monte Carlo simulation to quantify selection bias for three estimators\n    of a marginal exposure effect across five scenarios of outcome attrition.\n    \"\"\"\n    \n    # --- Simulation Constants ---\n    N = 5000  # Sample size per replicate\n    M = 200   # Number of replicates\n    P_A = 0.5 # Probability of exposure A=1\n    BETA_0 = 0.0\n    BETA_A = 1.0 # True marginal effect (Delta)\n    BETA_Z = 1.0\n    SIGMA_SQ = 1.0\n    \n    SEED = 12345\n    rng = np.random.default_rng(SEED)\n\n    # --- Scenario Definitions ---\n    # Each scenario is (alpha_0, alpha_A, alpha_Z, alpha_U, beta_U)\n    scenarios = {\n        'A': {'alpha_0': 0.5, 'alpha_A': 0.0, 'alpha_Z': 0.0, 'alpha_U': 0.0, 'beta_U': 0.0}, # Non-informative\n        'B': {'alpha_0': 0.0, 'alpha_A': 1.0, 'alpha_Z': 0.0, 'alpha_U': 0.0, 'beta_U': 0.0}, # Depends on exposure\n        'C': {'alpha_0': 0.0, 'alpha_A': 0.0, 'alpha_Z': 1.0, 'alpha_U': 0.0, 'beta_U': 0.0}, # Depends on covariate\n        'D': {'alpha_0': 0.0, 'alpha_A': 1.0, 'alpha_Z': 1.0, 'alpha_U': 0.0, 'beta_U': 0.0}, # Collider-induced\n        'E': {'alpha_0': 0.0, 'alpha_A': 1.0, 'alpha_Z': 1.0, 'alpha_U': 1.0, 'beta_U': 1.0}, # Unmeasured predictor\n    }\n    \n    scenario_order = ['A', 'B', 'C', 'D', 'E']\n    all_biases = []\n\n    for scen_key in scenario_order:\n        params = scenarios[scen_key]\n        \n        estimates_naive = []\n        estimates_cc = []\n        estimates_ipw = []\n\n        for _ in range(M):\n            # 1. Generate Data\n            A = rng.binomial(1, P_A, N)\n            Z = rng.normal(0, 1, N)\n            \n            U = np.zeros(N)\n            if params['beta_U'] != 0:\n                U = rng.normal(0, 1, N)\n            \n            epsilon = rng.normal(0, np.sqrt(SIGMA_SQ), N)\n            \n            Y = BETA_0 + BETA_A * A + BETA_Z * Z + params['beta_U'] * U + epsilon\n            \n            logit_p_R = params['alpha_0'] + params['alpha_A'] * A + params['alpha_Z'] * Z + params['alpha_U'] * U\n            p_R = expit(logit_p_R)\n            R = rng.binomial(1, p_R, N)\n            \n            # 2. Filter for Complete Cases\n            observed_mask = (R == 1)\n            A_obs = A[observed_mask]\n            Z_obs = Z[observed_mask]\n            Y_obs = Y[observed_mask]\n            \n            # Handle rare cases where an exposure group has no observed subjects\n            if np.sum(A_obs == 1) == 0 or np.sum(A_obs == 0) == 0:\n                estimates_naive.append(np.nan)\n                estimates_cc.append(np.nan)\n                estimates_ipw.append(np.nan)\n                continue\n\n            # 3. Estimate Delta with three methods\n            \n            # 3.1 Naïve Unadjusted Complete-Case Estimator\n            mean_y_a1 = np.mean(Y_obs[A_obs == 1])\n            mean_y_a0 = np.mean(Y_obs[A_obs == 0])\n            delta_naive = mean_y_a1 - mean_y_a0\n            estimates_naive.append(delta_naive)\n            \n            # 3.2 Adjusted Complete-Case Estimator\n            X_cc = np.vstack([np.ones(len(A_obs)), A_obs, Z_obs]).T\n            try:\n                coeffs_cc = np.linalg.lstsq(X_cc, Y_obs, rcond=None)[0]\n                delta_cc = coeffs_cc[1]\n                estimates_cc.append(delta_cc)\n            except np.linalg.LinAlgError:\n                estimates_cc.append(np.nan)\n\n            # 3.3 IPW Estimator\n            # Calculate weights for observed subjects\n            A_for_weights = A[observed_mask]\n            Z_for_weights = Z[observed_mask]\n\n            if scen_key == 'E':\n                # Use misspecified model for weights, omitting U\n                logit_p_R_w = params['alpha_0'] + params['alpha_A'] * A_for_weights + params['alpha_Z'] * Z_for_weights\n            else:\n                # Use correctly specified model for weights\n                logit_p_R_w = params['alpha_0'] + params['alpha_A'] * A_for_weights + params['alpha_Z'] * Z_for_weights\n            \n            p_R_w = expit(logit_p_R_w)\n            weights = 1.0 / p_R_w\n            \n            mask_a1_obs = (A_obs == 1)\n            mask_a0_obs = (A_obs == 0)\n\n            # Weighted mean for A=1\n            sum_w_a1 = np.sum(weights[mask_a1_obs])\n            mu_1_ipw = np.sum(weights[mask_a1_obs] * Y_obs[mask_a1_obs]) / sum_w_a1 if sum_w_a1 > 0 else 0\n            \n            # Weighted mean for A=0\n            sum_w_a0 = np.sum(weights[mask_a0_obs])\n            mu_0_ipw = np.sum(weights[mask_a0_obs] * Y_obs[mask_a0_obs]) / sum_w_a0 if sum_w_a0 > 0 else 0\n\n            delta_ipw = mu_1_ipw - mu_0_ipw\n            estimates_ipw.append(delta_ipw)\n\n        # 4. Calculate Average Bias for the Scenario\n        # Use nanmean to be robust to any failed estimations\n        bias_naive = np.nanmean(estimates_naive) - BETA_A\n        bias_cc = np.nanmean(estimates_cc) - BETA_A\n        bias_ipw = np.nanmean(estimates_ipw) - BETA_A\n        \n        all_biases.extend([bias_naive, bias_cc, bias_ipw])\n\n    # 5. Format and Print Final Output\n    print(f\"[{','.join(map(str, all_biases))}]\")\n\nsolve()\n```"
        }
    ]
}