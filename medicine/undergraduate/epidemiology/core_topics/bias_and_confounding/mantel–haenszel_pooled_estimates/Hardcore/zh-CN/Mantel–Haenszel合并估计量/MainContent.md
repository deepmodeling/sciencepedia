## 引言
在流行病学研究中，准确评估暴露与结局之间的关联至关重要，但这一任务常常因混杂因素的存在而变得复杂。混杂会扭曲真实的效应，甚至导致与事实完全相反的结论。那么，我们如何才能剥离这些干扰，获得一个无偏的、可靠的关联估计值呢？分层分析提供了一种经典而直观的解决方案，而Mantel-Haenszel (MH) 汇总估计正是实现这一目标的核心技术。本文将系统地引导您掌握MH方法。在“原理与机制”章节中，我们将深入探讨分层分析背后的逻辑，MH公式的构建，及其重要的理论基础。随后，在“应用与跨学科联系”章节中，您将看到该方法如何在临床医学、公共卫生等领域解决实际问题，包括控制混杂、探究效应修饰等。最后，通过“动手实践”环节，您将有机会亲手应用所学知识，巩固对混杂控制和数据分析的理解。

## 原理与机制

在流行病学研究中，我们旨在准确量化暴露与结局之间的关联。然而，这种关系时常被其他变量所扭曲，这些变量即为**混杂因素（confounders）**。为了获得无偏的效应估计，我们必须对混杂因素进行控制。分层分析（stratified analysis）是一种经典而直观的混杂控制方法，而 Mantel-Haenszel 汇总估计（Mantel-Haenszel pooled estimate）则是该方法的核心工具。本章将深入探讨分层分析的原理、Mantel-Haenszel 估计的构建机制、其理论基础以及在实践中的局限性。

### 分层分析的逻辑：控制混杂

混杂的本质在于比较的“不公平”。当一个变量（混杂因素）既与暴露相关，又与结局相关（且不位于暴露与结局的因果路径上）时，它就会在暴露组与非暴露组之间造成系统性差异，从而歪曲我们观察到的暴露-结局关联。

一个经典的混杂效应表现为**辛普森悖论（Simpson's Paradox）**，即在总体人群中观察到的关联方向与在每个亚组（stratum）中观察到的方向完全相反。让我们通过一个假设的研究案例来理解这一点。研究人员旨在评估某项暴露（$E$）与一种二元疾病结局（$D$）之间的关联，同时怀疑一个二元协变量（$Z$）可能是一个混杂因素 。

如果我们忽略变量 $Z$ 的影响，将所有数据汇总（或称“粗略分析”），我们可能得到如下的 $2 \times 2$ 表：

| | 患病 ($D=1$) | 未患病 ($D=0$) |
| :--- | :---: | :---: |
| 暴露 ($E=1$) | 132 | 868 |
| 非暴露 ($E=0$) | 275 | 725 |

基于此汇总表，我们可以计算出**粗略比值比（crude odds ratio, OR）**：
$$ OR_{\text{crude}} = \frac{132 \times 725}{868 \times 275} \approx 0.40 $$

这个结果（$OR  1$）似乎表明暴露具有强烈的保护作用，能将患病的比值降低约 60%。

然而，如果我们根据混杂因素 $Z$ 的两个水平（$Z=1$ 和 $Z=2$）将人群分为两个亚组，并分别在每个亚组内进行分析，情况可能会截然不同。

- 在亚组 $Z=1$ 中，数据为：暴露者中 46 例患病、54 例未患病；非暴露者中 270 例患病、630 例未患病。该亚组的**层内比值比（stratum-specific odds ratio）**为：
$$ OR_{Z=1} = \frac{46 \times 630}{54 \times 270} \approx 2.00 $$

- 在亚组 $Z=2$ 中，数据为：暴露者中 86 例患病、814 例未患病；非暴露者中 5 例患病、95 例未患病。该亚组的层内比值比为：
$$ OR_{Z=2} = \frac{86 \times 95}{814 \times 5} \approx 2.01 $$

在两个亚组中，我们都观察到比值比约为 2.0，表明暴露实际上是一个风险因素，使患病的比值增加了一倍。这种戏剧性的反转揭示了混杂的强大影响。其根本原因在于，混杂因素 $Z$ 的分布在暴露组和非暴露组之间极不均衡。在此案例中，绝大多数暴露者（$86+814=900$ 人）属于低基线风险的 $Z=2$ 亚组，而绝大多数非暴露者（$270+630=900$ 人）则属于高基线风险的 $Z=1$ 亚组。因此，粗略分析错误地将“暴露组的低风险”归因于暴露本身，而实际上是因为该组主要由低风险个体构成。

**分层（stratification）**通过在混杂因素的每个水平内部分别进行比较，打破了这种虚假关联。通过比较“相似”的个体（例如，仅在 $Z=1$ 组内比较暴露者与非暴露者），我们消除了 $Z$ 带来的偏倚，从而揭示了真实的暴露效应 。

### Mantel-Haenszel 汇总估计：合并层内信息

在进行分层分析并确认各层内的效应方向一致后，我们通常希望得到一个单一的、经过调整的效应概括值。Mantel-Haenszel (MH) 方法提供了一种有效的方式来合并来自不同层的信息，以生成一个**汇总比值比（pooled odds ratio）**。

#### 效应同质性假设

在进行汇总之前，一个关键的前提是**效应[同质性](@entry_id:636502)（homogeneity of effect）**。这意味着各层内的效应量（如此处的比值比）是基本相同的。如果层间效应存在显著差异，这种情况被称为**效应修饰（effect modification）**或[交互作用](@entry_id:164533)（interaction）。在这种情况下，将不同的效应值强行合并成一个平均值可能会掩盖重要的科学发现，并产生误导性的结论 。例如，如果某项暴露在一个年龄组中有害（$OR > 1$），在另一个年龄组中无害（$OR=1$），而在第三个年龄组中具有保护性（$OR  1$），那么报告一个单一的汇总比值比将无法反映这种复杂的真实情况。因此，在计算汇总估计之前，检查层间效应的同质性是至关重要的一步。

#### Mantel-Haenszel 公式

假定效应[同质性](@entry_id:636502)成立，我们可以使用 Mantel-Haenszel 公式计算汇总比值比。对于 $k$ 个独立的 $2 \times 2$ 表（每个表代表一个分层），第 $i$ 层的数据结构如下 ：

| | 患病 (Cases) | 未患病 (Non-cases) | 合计 |
| :--- | :---: | :---: | :---: |
| **暴露** | $a_i$ | $b_i$ | $a_i+b_i$ |
| **非暴露** | $c_i$ | $d_i$ | $c_i+d_i$ |
| **合计** | $a_i+c_i$ | $b_i+d_i$ | $n_i$ |

其中，$a_i$ 是暴露患病数，$b_i$ 是暴露非患病数，$c_i$ 是非暴露患病数，$d_i$ 是非暴露非患病数，$n_i$ 是该层的总人数。

Mantel-Haenszel 汇总比值比（$\hat{\psi}_{MH}$）的计算公式为 ：
$$ \hat{\psi}_{MH} = \frac{\sum_{i=1}^{k} \frac{a_i d_i}{n_i}}{\sum_{i=1}^{k} \frac{b_i c_i}{n_i}} $$
这个公式的结构非常巧妙。它并非简单地对各层的比值比 $\frac{a_i d_i}{b_i c_i}$ 进行平均。相反，它将所有层的“一致对”贡献（$a_i d_i$，即暴露患病者与非暴露非患病者的乘积）和“[不一致对](@entry_id:166371)”贡献（$b_i c_i$，即暴露非患病者与非暴露患病者的乘积）分别加权汇总，然后求其比值。每层的权重是其总人数的倒数 $1/n_i$。这种加权方式赋予了信息量更大（通常是样本量更大且分布更均衡）的层更大的影响力，并使得该估计量在[稀疏数据](@entry_id:636194)（即某些层样本量很小）的情况下依然具有良好的统计学性质。

让我们应用此公式于一个包含三个分层的研究数据 ：
- 第 1 层: $(a_1, b_1, c_1, d_1) = (20, 30, 10, 40)$， $n_1=100$
- 第 2 层: $(a_2, b_2, c_2, d_2) = (20, 60, 12, 108)$， $n_2=200$
- 第 3 层: $(a_3, b_3, c_3, d_3) = (48, 72, 36, 144)$， $n_3=300$

公式的分子为：
$$ \sum_{i=1}^{3} \frac{a_i d_i}{n_i} = \frac{20 \times 40}{100} + \frac{20 \times 108}{200} + \frac{48 \times 144}{300} = 8.00 + 10.80 + 23.04 = 41.84 $$

公式的分母为：
$$ \sum_{i=1}^{3} \frac{b_i c_i}{n_i} = \frac{30 \times 10}{100} + \frac{60 \times 12}{200} + \frac{72 \times 36}{300} = 3.00 + 3.60 + 8.64 = 15.24 $$

因此，Mantel-Haenszel 汇总比值比为：
$$ \hat{\psi}_{MH} = \frac{41.84}{15.24} \approx 2.75 $$
这个经过调整的汇总估计值 2.75，与在存在严重混杂时计算出的粗略比值比（通常会偏离）相比，更准确地反映了在控制了分层变量后的暴露与结局之间的关联。值得注意的是，同样的 Mantel-Haenszel 原理也可以应用于计算汇总**风险比（risk ratio, RR）**和**风险差（risk difference, RD）**。

### 理论基础与深层洞见

Mantel-Haenszel 方法不仅是一个实用的计算工具，其背后还有深刻的理论支撑。

#### 与因果推断框架的联系

分层分析的现代理解与**潜在结局（potential outcomes）**因果推断框架紧密相连。在该框架下，控制混杂的目标是达到**[可交换性](@entry_id:263314)（exchangeability）**，即暴露组和非暴露组在所有其他（影响结局的）特征上是可比的。在非随机化的[观察性研究](@entry_id:174507)中，这种无条件的[可交换性](@entry_id:263314)通常不成立。

然而，通过对一组充分的混杂因素 $Z$ 进行分层，我们可以期望达到**条件[可交换性](@entry_id:263314)（conditional exchangeability）**  。其形式化表达为 $Y^a \perp A \mid Z$，意为在给定的混杂因素水平 $Z=z$ 内，个体的潜在结局（$Y^a$，即无论其真实暴露状态如何，如果被暴露于水平 $a$ 时将会发生的结局）与其实际接受的暴露（$A$）是独立的。这意味着，在每个层内，暴露组和非暴露组是可比的。因此，在层内计算的关联度量（如 $OR_i$）可以被解释为对该层因果效应的[无偏估计](@entry_id:756289)。假定因果效应在各层间恒定，MH 汇总估计量便是对这一共同因果效应的有效估计。

#### 可折叠性与不可折叠性

不同的效应度量在汇总时表现出不同的数学特性。风险比（RR）和风险差（RD）是**可折叠的（collapsible）**。这意味着，如果在各层中效应（RR 或 RD）恒定，并且不存在混杂（即分层变量与暴露无关），那么粗略的（汇总的）效应估计值将等于层内的共同效应值。

然而，比值比（OR）是**不可折叠的（non-collapsible）** 。即使在没有混杂的情况下，只要分层变量本身是结局的一个风险因素，粗略比值比通常也不会等于层内共同的比值比（它会趋向于 1，即“偏向于无效假设”）。这意味着，即使一个变量不是传统意义上的混杂因素（因为它与暴露无关），仅仅因为它与结局有关，用它进行分层调整也会改变比值比的估计值。这是比值比的一个固有数学特性，源于其定义的非线性。这一特性解释了为何在 logistic 回归中，向模型中添加一个与暴露无关但与结局相关的预测变量，仍会改变暴露变量的系数（即对数比值比）。

#### MH 权重的理论来源（高级）

MH 估计量的权重方案 $\frac{b_i c_i}{n_i}$（隐式地）并非随意选择。与标准荟萃分析（meta-analysis）中常用的对数比值比的逆方差权重不同，MH 权重源于一个基于**条件似然（conditional likelihood）**的理论模型。该模型假设在每个 $2 \times 2$ 表中，行合计与列合计（即边际总数）是固定的，唯一的随机变量是单元格 $a_i$ 的计数，其服从一个以共同比值比 $\theta$ 为参数的非中心[超几何分布](@entry_id:193745)。从这个模型出发，通过[矩估计法](@entry_id:270941)（method of moments）可以推导出 Mantel-Haenszel 估计量 。这种基于条件模型的推导赋予了 MH 估计量优良的统计特性，尤其是在处理[稀疏数据](@entry_id:636194)时，其表现通常优于依赖大样本[正态近似](@entry_id:261668)的逆方差加权法。

### 实践局限与拓展

尽管分层分析和 MH 方法在概念上清晰且功能强大，但在应用于复杂现实世界数据时，它们也面临着一些重要的局限性 。

- **[维数灾难](@entry_id:143920)与[稀疏数据](@entry_id:636194)**：当需要控制的混杂因素不止一个，或者某些混杂因素有多个水平时，分层的组合数量会急剧增加（例如，按 2 个水平的年龄和 3 个水平的吸烟状况分层，会产生 $2 \times 3 = 6$ 个亚组）。这会导致许多层内的样本量非常小，即**数据稀疏（sparse data）**。在极端情况下，某些单元格的计数可能为零，导致层内比值比无法计算（例如，分母为零），或者估计值极不稳定。

- **残余混杂**：分层只能控制我们所划分的类别内的混杂。如果一个连续的混杂因素（如年龄）被粗略地划分为少数几个类别（如“年轻”、“年老”），那么在每个类别内部，暴露组和非暴露组的平均年龄可能仍然存在差异。这种层内未被完全控制的混杂被称为**残余混杂（residual confounding）**。

- **效应修饰的挑战**：如前所述，MH 方法的核心是假定效应[同质性](@entry_id:636502)。如果数据中存在真实的效应修饰，那么首要任务应该是描述和报告这种异质性，而不是计算一个可能掩盖真相的汇总值。

- **[正定性](@entry_id:149643)违例**：在某些层中，可能完全没有暴露者或非暴露者，这使得在该层内进行比较成为不可能。这种情况被称为**[正定性](@entry_id:149643)（positivity）**假设的违例。分层方法无法从这些层中提取信息，在计算时只能将其舍弃。

由于以上局限，尤其是在处理多个连续或多分类混杂因素时，现代流行病学研究更倾向于使用**多变量回归模型（multivariable regression models）**，如 logistic 回归。[回归模型](@entry_id:163386)通过假设一个函数形式来描述暴露、结局和协变量之间的关系，从而能更灵活、更有效地同时控制多个混杂因素，并且能够自然地处理连续变量和检验[交互作用](@entry_id:164533)。尽管如此，分层分析作为一种基础方法，对于理解混杂控制的核心思想、诊断数据特征以及进行初步分析，仍然具有不可替代的价值。