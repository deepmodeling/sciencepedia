{
    "hands_on_practices": [
        {
            "introduction": "本节的第一个练习为直接年龄标准化方法奠定了基础。你将学习如何将原始数据——不同年龄组的死亡人数和人口规模——转化为一个单一的汇总指标：年龄标化率（$ASR$）。掌握这一基本计算方法 ，是公平比较不同年龄结构人群健康结局的关键第一步。",
            "id": "4587073",
            "problem": "一个地区卫生部门希望在使用直接年龄标化法控制年龄结构的情况下，比较不同管辖区的死亡率。考虑在单个研究区域内对全因死亡率进行为期一年的观察，该区域被划分为五个年龄分层。对于每个分层 $a$，给定了一年内的总死亡人数 $d_a$ 和总风险人时 $n_a$（假设每位居民贡献大约一个人年）。同时，也给定了预先指定的标准人口中每个年龄分层的人数 $W_a$。数据如下：\n- 年龄 $0$ 至 $14$ 岁：$d_a = 12$，$n_a = 120{,}000$，$W_a = 300{,}000$。\n- 年龄 $15$ 至 $44$ 岁：$d_a = 48$，$n_a = 300{,}000$，$W_a = 500{,}000$。\n- 年龄 $45$ 至 $64$ 岁：$d_a = 150$，$n_a = 180{,}000$，$W_a = 150{,}000$。\n- 年龄 $65$ 至 $74$ 岁：$d_a = 200$，$n_a = 80{,}000$，$W_a = 35{,}000$。\n- 年龄 $75$ 岁及以上：$d_a = 500$，$n_a = 40{,}000$，$W_a = 15{,}000$。\n\n仅使用核心定义和直接年龄标化法原理——即估计如果研究区域的年龄别率应用于标准人口时将观察到的率——来计算该研究区域的死亡率年龄标化率 (ASR)。将最终的年龄标化率表示为每 $100{,}000$ 人年的事件数。将您的答案四舍五入到四位有效数字。",
            "solution": "该问题要求使用直接法计算死亡率的年龄标化率 (ASR)。该方法通过将研究人口的年龄别率应用于一个共同的“标准”人口，从而实现对不同年龄结构人口之间率的比较。\n\n对问题陈述的先验验证证实了其科学性、问题的合规性，并且包含了获得唯一解所需的所有数据。所提供的数据如下：\n- 对于年龄分层 $a=1$ (年龄 $0-14$ 岁)：$d_1 = 12$ 例死亡， $n_1 = 120,000$ 人年， $W_1 = 300,000$ 标准人口。\n- 对于年龄分层 $a=2$ (年龄 $15-44$ 岁)：$d_2 = 48$ 例死亡， $n_2 = 300,000$ 人年， $W_2 = 500,000$ 标准人口。\n- 对于年龄分层 $a=3$ (年龄 $45-64$ 岁)：$d_3 = 150$ 例死亡， $n_3 = 180,000$ 人年， $W_3 = 150,000$ 标准人口。\n- 对于年龄分层 $a=4$ (年龄 $65-74$ 岁)：$d_4 = 200$ 例死亡， $n_4 = 80,000$ 人年， $W_4 = 35,000$ 标准人口。\n- 对于年龄分层 $a=5$ (年龄 $75+$ 岁)：$d_5 = 500$ 例死亡， $n_5 = 40,000$ 人年， $W_5 = 15,000$ 标准人口。\n\n直接标化法的核心原理是计算如果研究人口具有与标准人口相同的年龄结构时将观察到的总率。ASR 的公式由年龄别率的加权平均值给出，其中权重是标准人口在每个年龄分层中的比例。等效地，它是标准人口中的预期总事件数除以标准人口的总规模。\n\n设 $m_a$ 为分层 $a$ 的年龄别死亡率，计算方法为死亡人数 $d_a$ 除以风险人时 $n_a$。\n$$m_a = \\frac{d_a}{n_a}$$\n\n以每 $k$ 人年（在本例中，$k=100,000$）表示的 ASR 计算如下：\n$$ASR = \\left( \\frac{\\sum_{a} (m_a \\cdot W_a)}{\\sum_{a} W_a} \\right) \\times k = \\left( \\frac{\\sum_{a} \\frac{d_a}{n_a} W_a}{\\sum_{a} W_a} \\right) \\times 100,000$$\n\n首先，我们计算每个分层的年龄别死亡率 ($m_a$)：\n- 分层 1: $m_1 = \\frac{12}{120,000} = 0.0001$ 死亡/人年。\n- 分层 2: $m_2 = \\frac{48}{300,000} = 0.00016$ 死亡/人年。\n- 分层 3: $m_3 = \\frac{150}{180,000} = \\frac{1}{1200} \\approx 0.0008333...$ 死亡/人年。\n- 分层 4: $m_4 = \\frac{200}{80,000} = \\frac{1}{400} = 0.0025$ 死亡/人年。\n- 分层 5: $m_5 = \\frac{500}{40,000} = \\frac{1}{80} = 0.0125$ 死亡/人年。\n\n接下来，我们计算标准人口中每个年龄分层的预期死亡人数，$E_a = m_a \\cdot W_a$：\n- 分层 1: $E_1 = 0.0001 \\times 300,000 = 30$\n- 分层 2: $E_2 = 0.00016 \\times 500,000 = 80$\n- 分层 3: $E_3 = \\frac{1}{1200} \\times 150,000 = \\frac{1500}{12} = 125$\n- 分层 4: $E_4 = 0.0025 \\times 35,000 = 87.5$\n- 分层 5: $E_5 = 0.0125 \\times 15,000 = 187.5$\n\n现在，我们将预期死亡人数相加，得到标准人口中的总预期死亡人数，$\\sum_{a} E_a$：\n$$ \\sum_{a} E_a = 30 + 80 + 125 + 87.5 + 187.5 = 510 $$\n\n我们还将标准人口计数相加，得到标准人口的总规模，$\\sum_{a} W_a$：\n$$ \\sum_{a} W_a = 300,000 + 500,000 + 150,000 + 35,000 + 15,000 = 1,000,000 $$\n\n原始的、未标度的 ASR 是总预期死亡人数除以总标准人口：\n$$ ASR_{\\text{raw}} = \\frac{\\sum_{a} E_a}{\\sum_{a} W_a} = \\frac{510}{1,000,000} = 0.00051 $$\n\n最后，我们将此率进行标度，以表示为每 $100,000$ 人年：\n$$ ASR = ASR_{\\text{raw}} \\times 100,000 = 0.00051 \\times 100,000 = 51 $$\n\n问题要求答案四舍五入到四位有效数字。数字 $51$ 有两位有效数字。为了用四位有效数字表示它，我们在小数点后添加尾随零。\n$$ ASR = 51.00 $$\n年龄标化率为每 $100,000$ 人年 $51.00$ 例死亡。",
            "answer": "$$\\boxed{51.00}$$"
        },
        {
            "introduction": "年龄标化率（$ASR$）并非一个绝对值，它的大小与所选的标准人口密切相关。本练习  旨在阐明这一关键概念，要求你使用两种不同的标准人口——一个“较年轻”的全球标准人口和一个“较年老”的地区标准人口——为同一个研究人群计算 $ASR$。通过这个实践，你将深化对标准人口选择如何影响最终结果及其解读的理解。",
            "id": "4587099",
            "problem": "一个公共卫生部门正在比较同一研究人群中一种慢性病的负担在两种不同标准人群下的情况，以了解年龄标化率 (ASR) 如何响应年龄权重的差异。年龄标化率 (ASR) 的概念性定义为：如果研究人群具有某一特定标准人群的年龄分布，将会观察到的率；它是通过将研究人群的年龄别率与标准人群的年龄分布权重相结合来构建的。考虑了两种标准：世界卫生组织 (WHO) 世界标准人群和一个区域性标准，后者的年龄分布对高年龄组赋予了更重的权重。\n\n为您提供了研究人群按年龄分层的病例数和人时分母，以及每种标准的年龄分布权重。所有数据集的年龄分层都是相同的。\n\n研究人群数据（发病病例和人年），按年龄组分列：\n- 年龄 $0$–$14$ 岁：病例 $40$；人年 $200{,}000$。\n- 年龄 $15$–$44$ 岁：病例 $220$；人年 $500{,}000$。\n- 年龄 $45$–$64$ 岁：病例 $480$；人年 $300{,}000$。\n- 年龄 $65$–$74$ 岁：病例 $360$；人年 $100{,}000$。\n- 年龄 $\\geq 75$ 岁：病例 $500$；人年 $80{,}000$。\n\n各年龄组的标准人群权重（比例总和为 $1$）：\n- 世界卫生组织 (WHO) 世界标准：$0$–$14$ 岁：$0.30$；$15$–$44$ 岁：$0.43$；$45$–$64$ 岁：$0.17$；$65$–$74$ 岁：$0.06$；$\\geq 75$ 岁：$0.04$。\n- 对高年龄组权重更重的区域性标准：$0$–$14$ 岁：$0.18$；$15$–$44$ 岁：$0.36$；$45$–$64$ 岁：$0.24$；$65$–$74$ 岁：$0.12$；$\\geq 75$ 岁：$0.10$。\n\n使用直接年龄标化法，首先计算研究人群每个年龄组每 $100{,}000$ 人年的年龄别发病率。然后，计算基于 WHO 世界标准和区域性标准的年龄标化率 (ASR)。最后，报告区域性标准 ASR 与 WHO 标准 ASR 的比率，作为倍数变化。将最终比率表示为无量纲数，并四舍五入到四位有效数字。",
            "solution": "该问题是有效的，因为它科学地基于标准流行病学方法，问题设定良好，数据充分且一致，并以客观语言表述。直接年龄标化法是公共卫生领域比较不同年龄结构人群率的一个基本工具。\n\n求解过程分四步：首先，计算研究人群的年龄别发病率；其次，使用世界卫生组织 (WHO) 标准人群权重计算年龄标化率 (ASR)；第三，使用区域性标准人群权重计算 ASR；最后，计算区域性标准 ASR 与 WHO 标准 ASR 的比率。\n\n设年龄分层由 $i$ 索引，其中 $i \\in \\{1, 2, 3, 4, 5\\}$ 分别对应于年龄组 $0–14$ 岁、$15–44$ 岁、$45–64$ 岁、$65–74$ 岁和 $\\geq 75$ 岁。\n设 $C_i$ 为年龄分层 $i$ 中的病例数，$P_i$ 为人年数。每 $100,000$ 人年的年龄别发病率 $R_i$ 由以下公式给出：\n$$R_i = \\frac{C_i}{P_i} \\times 100,000$$\n\n使用所提供的研究人群数据，我们计算五个年龄别率：\n- 对于年龄组 $1$ ($0–14$ 岁)：$C_1 = 40$，$P_1 = 200,000$。\n$$R_1 = \\frac{40}{200,000} \\times 100,000 = 20 \\text{ per } 100,000 \\text{ person-years}$$\n- 对于年龄组 $2$ ($15–44$ 岁)：$C_2 = 220$，$P_2 = 500,000$。\n$$R_2 = \\frac{220}{500,000} \\times 100,000 = 44 \\text{ per } 100,000 \\text{ person-years}$$\n- 对于年龄组 $3$ ($45–64$ 岁)：$C_3 = 480$，$P_3 = 300,000$。\n$$R_3 = \\frac{480}{300,000} \\times 100,000 = 160 \\text{ per } 100,000 \\text{ person-years}$$\n- 对于年龄组 $4$ ($65–74$ 岁)：$C_4 = 360$，$P_4 = 100,000$。\n$$R_4 = \\frac{360}{100,000} \\times 100,000 = 360 \\text{ per } 100,000 \\text{ person-years}$$\n- 对于年龄组 $5$ ($\\geq 75$ 岁)：$C_5 = 500$，$P_5 = 80,000$。\n$$R_5 = \\frac{500}{80,000} \\times 100,000 = 625 \\text{ per } 100,000 \\text{ person-years}$$\n\n接下来，我们使用直接法计算 ASR。ASR 的公式是年龄别率的加权和，其中权重 $w_i$ 是标准人群在每个年龄分层中的比例：\n$$ASR = \\sum_{i=1}^{5} R_i \\cdot w_i$$\n\n设 $w_{\\text{WHO},i}$ 为 WHO 标准人群的权重。\n$w_{\\text{WHO},1} = 0.30$, $w_{\\text{WHO},2} = 0.43$, $w_{\\text{WHO},3} = 0.17$, $w_{\\text{WHO},4} = 0.06$, $w_{\\text{WHO},5} = 0.04$.\n\nWHO 标准的 ASR ($ASR_{\\text{WHO}}$) 为：\n$$ASR_{\\text{WHO}} = (20 \\times 0.30) + (44 \\times 0.43) + (160 \\times 0.17) + (360 \\times 0.06) + (625 \\times 0.04)$$\n$$ASR_{\\text{WHO}} = 6.00 + 18.92 + 27.20 + 21.60 + 25.00$$\n$$ASR_{\\text{WHO}} = 98.72$$\n\n现在，设 $w_{\\text{REG},i}$ 为区域性标准人群的权重。\n$w_{\\text{REG},1} = 0.18$, $w_{\\text{REG},2} = 0.36$, $w_{\\text{REG},3} = 0.24$, $w_{\\text{REG},4} = 0.12$, $w_{\\text{REG},5} = 0.10$.\n\n区域性标准的 ASR ($ASR_{\\text{REG}}$) 为：\n$$ASR_{\\text{REG}} = (20 \\times 0.18) + (44 \\times 0.36) + (160 \\times 0.24) + (360 \\times 0.12) + (625 \\times 0.10)$$\n$$ASR_{\\text{REG}} = 3.60 + 15.84 + 38.40 + 43.20 + 62.50$$\n$$ASR_{\\text{REG}} = 163.54$$\n\n最后，我们计算区域性标准 ASR 与 WHO 标准 ASR 的比率，作为倍数变化。\n$$\\text{Ratio} = \\frac{ASR_{\\text{REG}}}{ASR_{\\text{WHO}}} = \\frac{163.54}{98.72}$$\n$$\\text{Ratio} \\approx 1.656655186...$$\n\n将结果四舍五入到四位有效数字，我们得到：\n$$\\text{Ratio} \\approx 1.657$$\n该比率表明，与使用较年轻的 WHO 世界人群进行标化相比，使用较年长的区域性人群进行标化所得的估计疾病负担大约高出 $1.657$ 倍，这反映了年龄与该疾病发病率之间的强正相关关系。",
            "answer": "$$\\boxed{1.657}$$"
        },
        {
            "introduction": "仅仅一个 $ASR$ 的点估计值所提供的信息是不完整的，我们还需要量化其统计不确定性。这个高级实践  将带你从手动计算走向编程实现。你将编写一个程序，它不仅能计算 $ASR$，还能计算其 $95\\%$ 置信区间，这需要你运用泊松分布方差的原理，从而创建一个稳健且可重复的分析工具。",
            "id": "4587003",
            "problem": "您的任务是实现一个完整的、可复现的程序，该程序基于年龄别率和标准人口加权的基本定义来计算直接年龄标化率。对于每个测试用例，该程序必须接受按 $a$ 索引的分层的年龄别事件数数组 $d_a$、相应的年龄别风险人口数组 $n_a$ 以及标准人口权重数组 $W_a$。程序必须输出年龄标化率 $ASR$ 及其双侧 $95\\%$ 置信区间 (CI)，该置信区间需通过有效的概率模型和方差传播推导得出，同时要正确处理整数除法、权重归一化以及率和方差的缩放等常见计算陷阱。所有率都必须以每 $100{,}000$ 人年的事件数作为单位，并以小数值（而非百分比）表示。\n\n从以下核心基础出发：(i) 年龄别率定义为事件数与风险人口时间的商；(ii) 直接标化法使用固定的外部标准人口分布来形成加权合并率，您必须设计算法和代码以实现以下功能：\n- 根据每个分层的计数和人口数，构建其年龄别率的估计量。\n- 使用归一化的标准人口权重合并各年龄别率，以产生单一的年龄标化率。\n- 对每个分层的事件数采用适合稀有事件的概率假设，并应用方差传播来获得年龄标化率的标准误。\n- 使用标准正态参照构建双侧置信区间，确保将率缩放至每 $100{,}000$ 人年的事件数时，该缩放一致地应用于点估计和方差。\n\n您的实现必须明确防范以下情况：\n- 当 $d_a$ 和 $n_a$ 为整数时，整数除法导致率为零值，应通过强制执行浮点除法来避免。\n- 未归一化的权重 $W_a$；程序必须在内部对 $W_a$ 进行归一化，使其总和为 $1$，并且如果 $\\sum_a W_a = 0$，则必须引发错误。\n- 分母为零 $n_a$：如果在某个分层中 $n_a = 0$ 且 $d_a = 0$，则其对率和方差的贡献定义为 $0$；如果 $n_a = 0$ 且 $d_a > 0$，则输入无效，必须引发错误。\n- 不正确的缩放：乘以缩放因子 $100{,}000$ 必须应用于合并率，而方差必须按该因子的平方进行缩放。\n\n测试套件：\n在您的程序中提供并评估以下三个测试用例。每个测试用例是一个元组 $(d,n,W,S,\\alpha)$，其中 $S$ 是缩放因子（所有用例均使用 $S=100{,}000$），$\\alpha$ 是显著性水平（对于 $95\\%$ 置信区间，$\\alpha = 0.05$）：\n1. 具有中等计数和未归一化标准权重的正常路径：\n   - $d = [12,25,40,30]$\n   - $n = [1200,2300,2000,1500]$\n   - $W = [5000,7000,6000,4000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n2. 边缘案例，包含零计数和一个风险人口为零但事件也为零的分层（有效情况），以及相等的权重：\n   - $d = [0,5,0,2]$\n   - $n = [1000,400,0,600]$\n   - $W = [10000,10000,10000,10000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n3. 混合了小率和多个零计数，使用未归一化的权重和五个分层：\n   - $d = [1,0,3,2,0]$\n   - $n = [10000,8000,6000,4000,2000]$\n   - $W = [2000,3000,2500,1500,1000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含三个测试用例的结果，形式为用方括号括起来的逗号分隔列表，其中每个元素本身是包含三个小数值 $[ASR, LCL, UCL]$ 的逗号分隔列表，并四舍五入到六位小数。例如：\n\"[[ASR_1,LCL_1,UCL_1],[ASR_2,LCL_2,UCL_2],[ASR_3,LCL_3,UCL_3]]\"。",
            "solution": "该问题被评估为有效，因为它提出了一个流行病学领域中定义明确、有科学依据的计算任务，没有任何歧义或矛盾。\n\n目标是计算直接年龄标化率 (ASR) 及其置信区间，这是一种校正了人口年龄结构差异的综合性率的度量。该方法依赖于用外部标准人口中相应年龄分层的个体比例，对研究人群的年龄别率进行加权。\n\n设年龄分层由 $a$ 索引。我们给定：\n- $d_a$：分层 $a$ 中的事件数（例如，死亡、疾病病例）。\n- $n_a$：分层 $a$ 中的风险人口（例如，人年）。\n- $W_a$：分层 $a$ 中标准人口的个体数。\n\n**第1步：年龄别率**\n对于每个年龄分层 $a$，年龄别率 $\\hat{r}_a$ 估计为事件数除以风险人口。为防止整数算术问题，此除法必须使用浮点数执行。\n$$ \\hat{r}_a = \\frac{d_a}{n_a} $$\n问题规定，如果 $n_a = 0$ 且 $d_a = 0$，则该分层对总率及其方差的贡献为 $0$。在这种情况下，通过定义 $\\hat{r}_a = 0$ 来处理。$n_a=0$ 但 $d_a > 0$ 的情况在逻辑上不一致，代表无效输入。\n\n**第2步：归一化的标准人口权重**\n标准人口数 $W_a$ 必须转换为总和为 $1$ 的归一化权重 $w_a$。分层 $a$ 的权重是其在总标准人口中所占的比例。\n$$ w_a = \\frac{W_a}{\\sum_j W_j} $$\n总标准人口 $\\sum_j W_j = 0$ 是无效输入，因为它使得归一化无法进行。\n\n**第3步：年龄标化率 (ASR)**\n原始（未缩放的）ASR，记为 $\\text{ASR}_{\\text{raw}}$，是使用归一化的标准人口权重计算的年龄别率的加权平均值：\n$$ \\text{ASR}_{\\text{raw}} = \\sum_a w_a \\hat{r}_a = \\sum_a \\left( \\frac{W_a}{\\sum_j W_j} \\right) \\frac{d_a}{n_a} $$\n最终的 ASR 通常以每个标准人口规模（例如 $S = 100{,}000$）来表示。\n$$ \\text{ASR} = S \\times \\text{ASR}_{\\text{raw}} $$\n\n**第4步：ASR 的方差**\n为了构建置信区间，我们首先需要 ASR 的方差。这需要一个关于事件数 $d_a$ 的概率模型。鉴于这些是在指定的人口时间内发生的事件计数，且通常是稀有事件，泊松分布是合适的模型。我们假设每个分层中的计数 $D_a$ 是一个独立的泊松随机变量：\n$$ D_a \\sim \\text{Poisson}(\\lambda_a = r_a^{\\text{true}} n_a) $$\n其中 $r_a^{\\text{true}}$ 是真实的潜在率。泊松分布的一个关键特性是其方差等于其均值，即 $\\text{Var}(D_a) = \\lambda_a$。我们用观察到的计数 $d_a$ 来估计未知的均值 $\\lambda_a$。\n$$ \\widehat{\\text{Var}}(D_a) = d_a $$\n年龄别率 $\\hat{r}_a = D_a/n_a$ 是一个随机变量。其方差通过将 $n_a$ 视为固定常数来求得：\n$$ \\text{Var}(\\hat{r}_a) = \\text{Var}\\left(\\frac{D_a}{n_a}\\right) = \\frac{1}{n_a^2} \\text{Var}(D_a) $$\n代入 $\\text{Var}(D_a)$ 的估计值，我们得到年龄别率的估计方差：\n$$ \\widehat{\\text{Var}}(\\hat{r}_a) = \\frac{d_a}{n_a^2} $$\n对于 $n_a=0$ 和 $d_a=0$ 的情况，对总方差的贡献为 $0$。\n\n由于假定各分层是独立的，$\\text{ASR}_{\\text{raw}}$（即 $\\hat{r}_a$ 的线性组合）的方差是它们方差的加权和：\n$$ \\widehat{\\text{Var}}(\\text{ASR}_{\\text{raw}}) = \\text{Var}\\left(\\sum_a w_a \\hat{r}_a\\right) = \\sum_a w_a^2 \\text{Var}(\\hat{r}_a) = \\sum_a w_a^2 \\frac{d_a}{n_a^2} $$\n最终缩放后的 ASR 的方差为：\n$$ \\widehat{\\text{Var}}(\\text{ASR}) = \\widehat{\\text{Var}}(S \\times \\text{ASR}_{\\text{raw}}) = S^2 \\widehat{\\text{Var}}(\\text{ASR}_{\\text{raw}}) = S^2 \\sum_a w_a^2 \\frac{d_a}{n_a^2} $$\n\n**第5步：置信区间 (CI)**\nASR 的标准误 (SE) 是其方差的平方根：\n$$ \\text{SE}(\\text{ASR}) = \\sqrt{\\widehat{\\text{Var}}(\\text{ASR})} = S \\sqrt{\\sum_a w_a^2 \\frac{d_a}{n_a^2}} $$\n根据中心极限定理，ASR 估计量的分布可以用正态分布来近似，尤其是在总事件数很大时。一个双侧 $(1-\\alpha) \\times 100\\%$ 置信区间的构建如下：\n$$ \\text{CI} = \\text{ASR} \\pm z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\n其中 $z_{1-\\alpha/2}$ 是标准正态分布的 $(1-\\alpha/2)$-分位数。对于 $95\\%$ 的置信区间，$\\alpha = 0.05$，且 $z_{0.975} \\approx 1.96$。置信下限 (LCL) 和置信上限 (UCL) 分别为：\n$$ \\text{LCL} = \\text{ASR} - z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\n$$ \\text{UCL} = \\text{ASR} + z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\n实现将使用这些公式，同时系统地处理指定的边缘情况和数据类型以确保正确性。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef calculate_asr(d, n, W, S, alpha):\n    \"\"\"\n    Computes a directly age-standardized rate (ASR) and its confidence interval.\n\n    Args:\n        d (list | np.ndarray): Age-specific event counts.\n        n (list | np.ndarray): Age-specific populations at risk.\n        W (list | np.ndarray): Standard population counts or weights.\n        S (float): Scaling factor for the rate (e.g., 100000).\n        alpha (float): Significance level for the confidence interval (e.g., 0.05 for 95% CI).\n\n    Returns:\n        tuple[float, float, float]: A tuple containing the ASR, lower confidence limit,\n                                     and upper confidence limit.\n    \"\"\"\n    # Convert inputs to numpy arrays of float type to prevent integer division\n    d_arr = np.array(d, dtype=float)\n    n_arr = np.array(n, dtype=float)\n    W_arr = np.array(W, dtype=float)\n\n    # --- Problem Validation as per requirements ---\n    if d_arr.shape != n_arr.shape or n_arr.shape != W_arr.shape:\n        raise ValueError(\"Input arrays d, n, and W must have the same shape.\")\n\n    # Check for invalid condition: population is 0 but events > 0\n    if np.any((n_arr == 0) & (d_arr > 0)):\n        raise ValueError(\"Invalid input: event count d_a > 0 where population n_a = 0.\")\n    \n    # Check for non-normalizable weights\n    W_sum = np.sum(W_arr)\n    if W_sum == 0:\n        raise ValueError(\"Sum of standard population weights W_a cannot be zero.\")\n\n    # --- Calculations ---\n    \n    # Normalize standard population weights\n    w = W_arr / W_sum\n\n    # Calculate age-specific rates (r_a = d_a / n_a)\n    # handles n_a = 0 by setting rate to 0, which is correct for (d_a=0, n_a=0)\n    age_specific_rates = np.divide(d_arr, n_arr, out=np.zeros_like(d_arr), where=(n_arr != 0))\n    \n    # Calculate raw Age-Standardized Rate (ASR)\n    asr_raw = np.sum(w * age_specific_rates)\n    \n    # Calculate variance of each age-specific rate (var(r_a) = d_a / n_a^2)\n    # handles n_a = 0 by setting variance to 0, consistent with zero contribution\n    var_age_specific_rates = np.divide(d_arr, n_arr**2, out=np.zeros_like(d_arr), where=(n_arr != 0))\n\n    # Calculate variance of the raw ASR\n    var_asr_raw = np.sum(w**2 * var_age_specific_rates)\n\n    # Scale ASR and calculate Standard Error (SE)\n    asr_scaled = S * asr_raw\n    se_asr_scaled = S * np.sqrt(var_asr_raw)\n\n    # Calculate the z-score for the confidence interval\n    z_score = norm.ppf(1 - alpha / 2)\n    \n    # Calculate the margin of error\n    margin_of_error = z_score * se_asr_scaled\n\n    # Calculate Lower and Upper Confidence Limits (LCL, UCL)\n    lcl = asr_scaled - margin_of_error\n    ucl = asr_scaled + margin_of_error\n    \n    return asr_scaled, lcl, ucl\n\ndef solve():\n    \"\"\"\n    Runs the defined test cases and prints the results in the specified format.\n    \"\"\"\n    # (d, n, W, S, alpha)\n    test_cases = [\n        # 1. Happy path with moderate counts and non-normalized standard weights\n        ([12, 25, 40, 30], [1200, 2300, 2000, 1500], [5000, 7000, 6000, 4000], 100000, 0.05),\n        \n        # 2. Edge case with zero counts and a stratum with zero population at risk (valid)\n        ([0, 5, 0, 2], [1000, 400, 0, 600], [10000, 10000, 10000, 10000], 100000, 0.05),\n        \n        # 3. Mixed small rates and several zero counts, five strata\n        ([1, 0, 3, 2, 0], [10000, 8000, 6000, 4000, 2000], [2000, 3000, 2500, 1500, 1000], 100000, 0.05),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        d, n, W, S, alpha = case\n        result = calculate_asr(d, n, W, S, alpha)\n        all_results.append(result)\n\n    # Format the results as specified: \"[[ASR_1,LCL_1,UCL_1],[...],...]\"\n    # with each value rounded to six decimal places.\n    formatted_results = [\n        f\"[{res[0]:.6f},{res[1]:.6f},{res[2]:.6f}]\" for res in all_results\n    ]\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}