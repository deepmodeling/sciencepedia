{
    "hands_on_practices": [
        {
            "introduction": "To make fair comparisons of health outcomes between populations, we must first account for differences in their age structures. This exercise provides a foundational, hands-on opportunity to perform a direct age standardization from start to finish. By working with raw mortality counts ($d_a$), person-time data ($n_a$), and a standard population ($W_a$), you will master the core mechanics of calculating an Age-Standardized Rate (ASR), a fundamental skill for any epidemiologist .",
            "id": "4587073",
            "problem": "A regional health department seeks to compare mortality rates across jurisdictions while controlling for age structure, using the method of direct age standardization. Consider a one-year observation of all-cause mortality in a single study region partitioned into five age strata. For each stratum $a$, you are given the total number of deaths $d_a$ and the total person-time at risk $n_a$ over the year (assume each resident contributes approximately one person-year). You are also given the counts $W_a$ of individuals in each age stratum in a prespecified standard population. The data are:\n- Ages $0$ to $14$: $d_a = 12$, $n_a = 120{,}000$, $W_a = 300{,}000$.\n- Ages $15$ to $44$: $d_a = 48$, $n_a = 300{,}000$, $W_a = 500{,}000$.\n- Ages $45$ to $64$: $d_a = 150$, $n_a = 180{,}000$, $W_a = 150{,}000$.\n- Ages $65$ to $74$: $d_a = 200$, $n_a = 80{,}000$, $W_a = 35{,}000$.\n- Ages $75$ and older: $d_a = 500$, $n_a = 40{,}000$, $W_a = 15{,}000$.\n\nUsing only core definitions and the principle that direct age standardization estimates the rate that would be observed if the study regionâ€™s age-specific rates applied to the standard population, compute the Age-Standardized Rate (ASR) for mortality for the study region. Express the final age-standardized rate in events per $100{,}000$ person-years. Round your answer to four significant figures.",
            "solution": "The problem requires the calculation of the Age-Standardized Rate (ASR) for mortality using the direct method. This method allows for the comparison of rates between populations with different age structures by applying the age-specific rates of the study population to a common 'standard' population.\n\nThe a priori validation of the problem statement confirms that it is scientifically grounded, well-posed, and contains all necessary data for a unique solution. The provided data are:\n- For age stratum $a=1$ (ages $0-14$): $d_1 = 12$ deaths, $n_1 = 120,000$ person-years, $W_1 = 300,000$ standard population.\n- For age stratum $a=2$ (ages $15-44$): $d_2 = 48$ deaths, $n_2 = 300,000$ person-years, $W_2 = 500,000$ standard population.\n- For age stratum $a=3$ (ages $45-64$): $d_3 = 150$ deaths, $n_3 = 180,000$ person-years, $W_3 = 150,000$ standard population.\n- For age stratum $a=4$ (ages $65-74$): $d_4 = 200$ deaths, $n_4 = 80,000$ person-years, $W_4 = 35,000$ standard population.\n- For age stratum $a=5$ (ages $75+$): $d_5 = 500$ deaths, $n_5 = 40,000$ person-years, $W_5 = 15,000$ standard population.\n\nThe core principle of direct standardization is to calculate the overall rate that would be observed if the study population had the same age structure as the standard population. The formula for the ASR is given by a weighted average of the age-specific rates, where the weights are the proportions of the standard population in each age stratum. Equivalently, it is the total number of expected events in the standard population divided by the total size of the standard population.\n\nLet $m_a$ be the age-specific mortality rate for stratum $a$, calculated as the number of deaths $d_a$ divided by the person-time at risk $n_a$.\n$$m_a = \\frac{d_a}{n_a}$$\n\nThe ASR, expressed per $k$ person-years (in this case, $k=100,000$), is calculated as:\n$$ASR = \\left( \\frac{\\sum_{a} (m_a \\cdot W_a)}{\\sum_{a} W_a} \\right) \\times k = \\left( \\frac{\\sum_{a} \\frac{d_a}{n_a} W_a}{\\sum_{a} W_a} \\right) \\times 100,000$$\n\nFirst, we calculate the age-specific mortality rates ($m_a$) for each stratum:\n- Stratum 1: $m_1 = \\frac{12}{120,000} = 0.0001$ deaths per person-year.\n- Stratum 2: $m_2 = \\frac{48}{300,000} = 0.00016$ deaths per person-year.\n- Stratum 3: $m_3 = \\frac{150}{180,000} = \\frac{1}{1200} \\approx 0.0008333...$ deaths per person-year.\n- Stratum 4: $m_4 = \\frac{200}{80,000} = \\frac{1}{400} = 0.0025$ deaths per person-year.\n- Stratum 5: $m_5 = \\frac{500}{40,000} = \\frac{1}{80} = 0.0125$ deaths per person-year.\n\nNext, we calculate the expected number of deaths in the standard population for each age stratum, $E_a = m_a \\cdot W_a$:\n- Stratum 1: $E_1 = 0.0001 \\times 300,000 = 30$\n- Stratum 2: $E_2 = 0.00016 \\times 500,000 = 80$\n- Stratum 3: $E_3 = \\frac{1}{1200} \\times 150,000 = \\frac{1500}{12} = 125$\n- Stratum 4: $E_4 = 0.0025 \\times 35,000 = 87.5$\n- Stratum 5: $E_5 = 0.0125 \\times 15,000 = 187.5$\n\nNow, we sum the expected deaths to find the total expected number of deaths in the standard population, $\\sum_{a} E_a$:\n$$ \\sum_{a} E_a = 30 + 80 + 125 + 87.5 + 187.5 = 510 $$\n\nWe also sum the standard population counts to find the total standard population size, $\\sum_{a} W_a$:\n$$ \\sum_{a} W_a = 300,000 + 500,000 + 150,000 + 35,000 + 15,000 = 1,000,000 $$\n\nThe raw, unscaled ASR is the total expected deaths divided by the total standard population:\n$$ ASR_{\\text{raw}} = \\frac{\\sum_{a} E_a}{\\sum_{a} W_a} = \\frac{510}{1,000,000} = 0.00051 $$\n\nFinally, we scale this rate to be expressed per $100,000$ person-years:\n$$ ASR = ASR_{\\text{raw}} \\times 100,000 = 0.00051 \\times 100,000 = 51 $$\n\nThe problem requires the answer to be rounded to four significant figures. The number $51$ has two significant figures. To express it with four significant figures, we add trailing zeros after the decimal point.\n$$ ASR = 51.00 $$\nThe Age-Standardized Rate is $51.00$ deaths per $100,000$ person-years.",
            "answer": "$$\\boxed{51.00}$$"
        },
        {
            "introduction": "An Age-Standardized Rate is a powerful point estimate, but it doesn't tell the whole story; we also need to understand its statistical precision. This practice moves from calculation to theory, guiding you through the derivation of the variance for an ASR. By assuming that event counts follow a Poisson distribution, you will use the principles of variance propagation to derive the formula that allows us to construct confidence intervals, transforming the ASR from a simple number into a robust statistical measure .",
            "id": "4587015",
            "problem": "Consider a study estimating the Direct Age-Standardized Rate (ASR) for an outcome across $A$ age groups indexed by $a \\in \\{1,2,\\dots,A\\}$. For age group $a$, let $d_{a}$ denote the observed number of events and $n_{a}$ denote the fixed person-time at risk. Assume that the event counts $d_{a}$ are independent and follow a Poisson distribution with mean $\\mu_{a}$, and define the observed age-specific rate $r_{a} = d_{a}/n_{a}$. The age-standardized rate is constructed using fixed standard population weights $\\{w_{a}\\}_{a=1}^{A}$ (with $\\sum_{a=1}^{A} w_{a} = 1$) as\n$$\nASR = \\sum_{a=1}^{A} w_{a} r_{a}.\n$$\nStarting from the properties of the Poisson distribution and the differentiable mapping used in the delta method, and under the assumption that the age-specific rate variances satisfy $Var(r_{a}) \\approx r_{a}/n_{a}$, derive an explicit closed-form analytic expression for the approximate variance of $ASR$ in terms of $\\{w_{a}\\}_{a=1}^{A}$, $\\{r_{a}\\}_{a=1}^{A}$, and $\\{n_{a}\\}_{a=1}^{A}$. Assume the denominators $\\{n_{a}\\}_{a=1}^{A}$ and the weights $\\{w_{a}\\}_{a=1}^{A}$ are fixed and nonrandom. Provide your final expression in simplified form. Your answer must be a single closed-form analytic expression. No numerical rounding is required.",
            "solution": "The problem statement has been validated and is deemed scientifically grounded, well-posed, and objective. It represents a standard derivation in epidemiology for estimating the variance of a direct age-standardized rate. All necessary data and assumptions are provided.\n\nThe objective is to derive an expression for the approximate variance of the Age-Standardized Rate (ASR). The ASR is defined as a linear combination of the age-specific rates, $r_a$:\n$$\nASR = \\sum_{a=1}^{A} w_{a} r_{a}\n$$\nwhere $w_a$ are fixed, nonrandom weights, and $r_a = d_a/n_a$ are the observed age-specific rates. Since the $\\{w_a\\}$ are constants and the $\\{r_a\\}$ are random variables, the ASR is a random variable. We seek to find its variance, $\\text{Var}(ASR)$.\n\nThe variance of a linear combination of random variables is given by:\n$$\n\\text{Var}(ASR) = \\text{Var}\\left(\\sum_{a=1}^{A} w_{a} r_{a}\\right) = \\sum_{a=1}^{A} \\sum_{b=1}^{A} w_a w_b \\text{Cov}(r_a, r_b)\n$$\nThe problem states that the event counts $d_a$ are independent for each age group $a \\in \\{1, 2, \\dots, A\\}$. The age-specific rates are defined as $r_a = d_a/n_a$, where $n_a$ is a fixed, nonrandom denominator (person-time at risk). Since the $d_a$ are independent random variables, the $r_a$ must also be independent. For independent random variables, the covariance is zero, i.e., $\\text{Cov}(r_a, r_b) = 0$ for $a \\neq b$. The covariance of a variable with itself is its variance, $\\text{Cov}(r_a, r_a) = \\text{Var}(r_a)$.\n\nApplying the independence property, the double summation for the variance of the ASR simplifies to a single summation:\n$$\n\\text{Var}(ASR) = \\sum_{a=1}^{A} w_a^2 \\text{Var}(r_a)\n$$\nNow, we must determine the variance of each age-specific rate, $\\text{Var}(r_a)$. We are given that $r_a = d_a/n_a$, where $n_a$ is a constant. Using the property of variance that $\\text{Var}(cX) = c^2 \\text{Var}(X)$ for a constant $c$, we have:\n$$\n\\text{Var}(r_a) = \\text{Var}\\left(\\frac{d_a}{n_a}\\right) = \\frac{1}{n_a^2} \\text{Var}(d_a)\n$$\nThe problem states that the event count $d_a$ follows a Poisson distribution with mean $\\mu_a$, i.e., $d_a \\sim \\text{Poisson}(\\mu_a)$. A fundamental property of the Poisson distribution is that its variance is equal to its mean. Therefore:\n$$\n\\text{Var}(d_a) = \\mu_a\n$$\nSubstituting this into the expression for $\\text{Var}(r_a)$:\n$$\n\\text{Var}(r_a) = \\frac{\\mu_a}{n_a^2}\n$$\nThe parameter $\\mu_a$ is the expected number of events. The true underlying age-specific rate, let's call it $\\lambda_a$, is defined as the expected number of events per unit of person-time, $\\lambda_a = E[r_a]$.\n$$\n\\lambda_a = E[r_a] = E\\left[\\frac{d_a}{n_a}\\right] = \\frac{1}{n_a} E[d_a] = \\frac{\\mu_a}{n_a}\n$$\nFrom this relationship, we can express the unknown mean parameter $\\mu_a$ in terms of the true rate $\\lambda_a$ and the known person-time $n_a$: $\\mu_a = n_a \\lambda_a$. Substituting this back into our expression for $\\text{Var}(r_a)$:\n$$\n\\text{Var}(r_a) = \\frac{n_a \\lambda_a}{n_a^2} = \\frac{\\lambda_a}{n_a}\n$$\nThis gives the true variance of the age-specific rate $r_a$. Now we can write the true variance of the ASR as:\n$$\n\\text{Var}(ASR) = \\sum_{a=1}^{A} w_a^2 \\frac{\\lambda_a}{n_a}\n$$\nThis expression depends on the true, but unknown, age-specific rates $\\{\\lambda_a\\}$. To obtain a usable estimate of the variance from the observed data, we must replace the unknown parameters $\\lambda_a$ with their sample estimates. The natural and unbiased estimator for the true rate $\\lambda_a$ is the observed rate $r_a$. This substitution provides an approximate variance:\n$$\n\\text{Var}(ASR) \\approx \\sum_{a=1}^{A} w_a^2 \\frac{r_a}{n_a}\n$$\nThis result is consistent with the problem's explicit assumption that $\\text{Var}(r_a) \\approx r_a/n_a$. This approximation arises from using the observed rate $r_a$ as a plug-in estimator for the true rate $\\lambda_a$ in the variance formula $\\text{Var}(r_a) = \\lambda_a/n_a$.\n\nThe final expression for the approximate variance of the ASR, in terms of the given quantities $\\{w_a\\}$, $\\{r_a\\}$, and $\\{n_a\\}$, is:\n$$\n\\text{Var}(ASR) \\approx \\sum_{a=1}^{A} \\frac{w_a^2 r_a}{n_a}\n$$\nThis is a closed-form analytic expression as required.",
            "answer": "$$ \\boxed{ \\sum_{a=1}^{A} \\frac{w_a^2 r_a}{n_a} } $$"
        },
        {
            "introduction": "In modern public health, robust and reproducible analysis is paramount. This final practice challenges you to synthesize the concepts of ASR calculation and its variance into a practical computational tool. You will design and implement an algorithm that not only computes the ASR and its confidence interval but also handles the real-world complexities of imperfect data, such as zero-event strata and non-normalized weights. This exercise bridges the gap between epidemiological theory and practical data science, equipping you with the skills to produce reliable and automated public health metrics .",
            "id": "4587003",
            "problem": "You are tasked with implementing a complete, reproducible program that computes a directly age-standardized rate based on fundamental definitions of age-specific rates and standard population weighting. The program must accept, for each test case, arrays of age-specific event counts $d_a$ for strata indexed by $a$, arrays of corresponding age-specific populations at risk $n_a$, and arrays of standard population weights $W_a$. The program must output the age-standardized rate $ASR$ together with a two-sided $95\\%$ confidence interval (CI) derived from a valid probabilistic model and variance propagation, while correctly handling common computational pitfalls such as integer division, normalization of weights, and scaling of rates and variances. All rates must be expressed in units of events per $100{,}000$ person-years as decimal values, not as percentages.\n\nStarting from the core foundations that (i) an age-specific rate is defined as the quotient of events over population-time at risk and (ii) direct standardization forms a weighted combined rate using a fixed external standard population distribution, you must design the algorithm and code to:\n- Form the age-specific rate estimator for each stratum from its count and population.\n- Combine the age-specific rates using normalized standard population weights to produce a single age-standardized rate.\n- Use a probabilistic assumption for the event counts in each stratum that is appropriate for rare events and apply variance propagation to obtain a standard error of the age-standardized rate.\n- Construct a two-sided confidence interval using a standard normal reference, ensuring that the scaling to events per $100{,}000$ person-years is consistently applied to both the point estimate and the variance.\n\nYour implementation must explicitly guard against the following:\n- Integer division leading to zero-valued rates when $d_a$ and $n_a$ are integers, by enforcing floating-point division.\n- Non-normalized weights $W_a$; the program must internally normalize $W_a$ so that their sum equals $1$ and must raise an error if $\\sum_a W_a = 0$.\n- Zero denominators $n_a$: if $n_a = 0$ and $d_a = 0$ in a stratum, its contribution to both the rate and variance is defined to be $0$; if $n_a = 0$ and $d_a > 0$, the input is invalid and must raise an error.\n- Incorrect scaling: the multiplication by a scaling factor of $100{,}000$ must be applied to the combined rate, and variance must be scaled by the square of the same factor.\n\nTest Suite:\nProvide and evaluate the following three test cases within your program. Each test case is a tuple $(d,n,W,S,\\alpha)$, where $S$ is the scaling factor (use $S=100{,}000$ for all cases) and $\\alpha$ is the significance level ($\\alpha = 0.05$ for a $95\\%$ confidence interval):\n1. Happy path with moderate counts and non-normalized standard weights:\n   - $d = [12,25,40,30]$\n   - $n = [1200,2300,2000,1500]$\n   - $W = [5000,7000,6000,4000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n2. Edge case with zero counts and a stratum with zero population at risk but zero events (valid), and equal weights:\n   - $d = [0,5,0,2]$\n   - $n = [1000,400,0,600]$\n   - $W = [10000,10000,10000,10000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n3. Mixed small rates and several zero counts, non-normalized weights and five strata:\n   - $d = [1,0,3,2,0]$\n   - $n = [10000,8000,6000,4000,2000]$\n   - $W = [2000,3000,2500,1500,1000]$\n   - $S = 100000$\n   - $\\alpha = 0.05$\n\nFinal Output Format:\nYour program should produce a single line of output containing the results for the three test cases as a comma-separated list enclosed in square brackets, where each element is itself a comma-separated list of three decimal values $[ASR, LCL, UCL]$ rounded to six decimal places. For example:\n\"[[ASR_1,LCL_1,UCL_1],[ASR_2,LCL_2,UCL_2],[ASR_3,LCL_3,UCL_3]]\".",
            "solution": "The problem is assessed to be valid as it presents a well-posed, scientifically grounded computational task in epidemiology, free from ambiguity or contradiction.\n\nThe objective is to compute the directly age-standardized rate (ASR), a summary measure of a rate that accounts for differences in the age structure of the population, along with its confidence interval. The method relies on weighting age-specific rates from a study population by the proportions of individuals in corresponding age strata of an external standard population.\n\nLet the age strata be indexed by $a$. We are given:\n- $d_a$: the number of events (e.g., deaths, disease cases) in stratum $a$.\n- $n_a$: the population at risk (e.g., person-years) in stratum $a$.\n- $W_a$: the number of individuals in the standard population in stratum $a$.\n\n**Step 1: Age-Specific Rates**\nFor each age stratum $a$, the age-specific rate, $\\hat{r}_a$, is estimated as the number of events divided by the population at risk. To prevent integer arithmetic issues, this division must be performed using floating-point numbers.\n$$ \\hat{r}_a = \\frac{d_a}{n_a} $$\nThe problem specifies that if $n_a = 0$ and $d_a = 0$, the stratum contributes $0$ to the overall rate and its variance. This is handled by defining $\\hat{r}_a = 0$ in this case. A situation where $n_a=0$ but $d_a > 0$ is logically inconsistent and represents invalid input.\n\n**Step 2: Normalized Standard Population Weights**\nThe standard population counts, $W_a$, must be converted into normalized weights, $w_a$, which sum to $1$. The weight for stratum $a$ is its proportion of the total standard population.\n$$ w_a = \\frac{W_a}{\\sum_j W_j} $$\nA total standard population of $\\sum_j W_j = 0$ is an invalid input, as it makes normalization impossible.\n\n**Step 3: Age-Standardized Rate (ASR)**\nThe raw (unscaled) ASR, denoted $\\text{ASR}_{\\text{raw}}$, is the weighted average of the age-specific rates, using the normalized standard population weights:\n$$ \\text{ASR}_{\\text{raw}} = \\sum_a w_a \\hat{r}_a = \\sum_a \\left( \\frac{W_a}{\\sum_j W_j} \\right) \\frac{d_a}{n_a} $$\nThe final ASR is typically expressed per a standard population size, such as $S = 100{,}000$.\n$$ \\text{ASR} = S \\times \\text{ASR}_{\\text{raw}} $$\n\n**Step 4: Variance of the ASR**\nTo construct a confidence interval, we first need the variance of the ASR. This requires a probabilistic model for the event counts $d_a$. Given that these are counts of events, often rare, over a specified population-time, the Poisson distribution is the appropriate model. We assume the count in each stratum, $D_a$, is an independent Poisson random variable:\n$$ D_a \\sim \\text{Poisson}(\\lambda_a = r_a^{\\text{true}} n_a) $$\nwhere $r_a^{\\text{true}}$ is the true underlying rate. A key property of the Poisson distribution is that its variance equals its mean, $\\text{Var}(D_a) = \\lambda_a$. We estimate the unknown mean $\\lambda_a$ with the observed count $d_a$.\n$$ \\widehat{\\text{Var}}(D_a) = d_a $$\nThe age-specific rate $\\hat{r}_a = D_a/n_a$ is a random variable. Its variance is found by treating $n_a$ as a fixed constant:\n$$ \\text{Var}(\\hat{r}_a) = \\text{Var}\\left(\\frac{D_a}{n_a}\\right) = \\frac{1}{n_a^2} \\text{Var}(D_a) $$\nSubstituting the estimate for $\\text{Var}(D_a)$, we get the estimated variance of the age-specific rate:\n$$ \\widehat{\\text{Var}}(\\hat{r}_a) = \\frac{d_a}{n_a^2} $$\nFor the case where $n_a=0$ and $d_a=0$, the contribution to the total variance is $0$.\n\nSince the strata are assumed independent, the variance of the $\\text{ASR}_{\\text{raw}}$, which is a linear combination of the $\\hat{r}_a$, is the weighted sum of their variances:\n$$ \\widehat{\\text{Var}}(\\text{ASR}_{\\text{raw}}) = \\text{Var}\\left(\\sum_a w_a \\hat{r}_a\\right) = \\sum_a w_a^2 \\text{Var}(\\hat{r}_a) = \\sum_a w_a^2 \\frac{d_a}{n_a^2} $$\nThe variance of the final, scaled ASR is:\n$$ \\widehat{\\text{Var}}(\\text{ASR}) = \\widehat{\\text{Var}}(S \\times \\text{ASR}_{\\text{raw}}) = S^2 \\widehat{\\text{Var}}(\\text{ASR}_{\\text{raw}}) = S^2 \\sum_a w_a^2 \\frac{d_a}{n_a^2} $$\n\n**Step 5: Confidence Interval (CI)**\nThe standard error (SE) of the ASR is the square root of its variance:\n$$ \\text{SE}(\\text{ASR}) = \\sqrt{\\widehat{\\text{Var}}(\\text{ASR})} = S \\sqrt{\\sum_a w_a^2 \\frac{d_a}{n_a^2}} $$\nBy the Central Limit Theorem, the distribution of the ASR estimator can be approximated by a normal distribution, especially for a large total number of events. A two-sided $(1-\\alpha) \\times 100\\%$ confidence interval is constructed as:\n$$ \\text{CI} = \\text{ASR} \\pm z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\nwhere $z_{1-\\alpha/2}$ is the $(1-\\alpha/2)$-quantile of the standard normal distribution. For a $95\\%$ confidence interval, $\\alpha = 0.05$, and $z_{0.975} \\approx 1.96$. The lower (LCL) and upper (UCL) confidence limits are:\n$$ \\text{LCL} = \\text{ASR} - z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\n$$ \\text{UCL} = \\text{ASR} + z_{1-\\alpha/2} \\times \\text{SE}(\\text{ASR}) $$\nThe implementation will use these formulas while systematically handling the specified edge cases and data types to ensure correctness.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef calculate_asr(d, n, W, S, alpha):\n    \"\"\"\n    Computes a directly age-standardized rate (ASR) and its confidence interval.\n\n    Args:\n        d (list | np.ndarray): Age-specific event counts.\n        n (list | np.ndarray): Age-specific populations at risk.\n        W (list | np.ndarray): Standard population counts or weights.\n        S (float): Scaling factor for the rate (e.g., 100000).\n        alpha (float): Significance level for the confidence interval (e.g., 0.05 for 95% CI).\n\n    Returns:\n        tuple[float, float, float]: A tuple containing the ASR, lower confidence limit,\n                                     and upper confidence limit.\n    \"\"\"\n    # Convert inputs to numpy arrays of float type to prevent integer division\n    d_arr = np.array(d, dtype=float)\n    n_arr = np.array(n, dtype=float)\n    W_arr = np.array(W, dtype=float)\n\n    # --- Problem Validation as per requirements ---\n    if d_arr.shape != n_arr.shape or n_arr.shape != W_arr.shape:\n        raise ValueError(\"Input arrays d, n, and W must have the same shape.\")\n\n    # Check for invalid condition: population is 0 but events > 0\n    if np.any((n_arr == 0) & (d_arr > 0)):\n        raise ValueError(\"Invalid input: event count d_a > 0 where population n_a = 0.\")\n    \n    # Check for non-normalizable weights\n    W_sum = np.sum(W_arr)\n    if W_sum == 0:\n        raise ValueError(\"Sum of standard population weights W_a cannot be zero.\")\n\n    # --- Calculations ---\n    \n    # Normalize standard population weights\n    w = W_arr / W_sum\n\n    # Calculate age-specific rates (r_a = d_a / n_a)\n    # handles n_a = 0 by setting rate to 0, which is correct for (d_a=0, n_a=0)\n    age_specific_rates = np.divide(d_arr, n_arr, out=np.zeros_like(d_arr), where=(n_arr != 0))\n    \n    # Calculate raw Age-Standardized Rate (ASR)\n    asr_raw = np.sum(w * age_specific_rates)\n    \n    # Calculate variance of each age-specific rate (var(r_a) = d_a / n_a^2)\n    # handles n_a = 0 by setting variance to 0, consistent with zero contribution\n    var_age_specific_rates = np.divide(d_arr, n_arr**2, out=np.zeros_like(d_arr), where=(n_arr != 0))\n\n    # Calculate variance of the raw ASR\n    var_asr_raw = np.sum(w**2 * var_age_specific_rates)\n\n    # Scale ASR and calculate Standard Error (SE)\n    asr_scaled = S * asr_raw\n    se_asr_scaled = S * np.sqrt(var_asr_raw)\n\n    # Calculate the z-score for the confidence interval\n    z_score = norm.ppf(1 - alpha / 2)\n    \n    # Calculate the margin of error\n    margin_of_error = z_score * se_asr_scaled\n\n    # Calculate Lower and Upper Confidence Limits (LCL, UCL)\n    lcl = asr_scaled - margin_of_error\n    ucl = asr_scaled + margin_of_error\n    \n    return asr_scaled, lcl, ucl\n\ndef solve():\n    \"\"\"\n    Runs the defined test cases and prints the results in the specified format.\n    \"\"\"\n    # (d, n, W, S, alpha)\n    test_cases = [\n        # 1. Happy path with moderate counts and non-normalized standard weights\n        ([12, 25, 40, 30], [1200, 2300, 2000, 1500], [5000, 7000, 6000, 4000], 100000, 0.05),\n        \n        # 2. Edge case with zero counts and a stratum with zero population at risk (valid)\n        ([0, 5, 0, 2], [1000, 400, 0, 600], [10000, 10000, 10000, 10000], 100000, 0.05),\n        \n        # 3. Mixed small rates and several zero counts, five strata\n        ([1, 0, 3, 2, 0], [10000, 8000, 6000, 4000, 2000], [2000, 3000, 2500, 1500, 1000], 100000, 0.05),\n    ]\n\n    all_results = []\n    for case in test_cases:\n        d, n, W, S, alpha = case\n        result = calculate_asr(d, n, W, S, alpha)\n        all_results.append(result)\n\n    # Format the results as specified: \"[[ASR_1,LCL_1,UCL_1],[...],...]\"\n    # with each value rounded to six decimal places.\n    formatted_results = [\n        f\"[{res[0]:.6f},{res[1]:.6f},{res[2]:.6f}]\" for res in all_results\n    ]\n    \n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}