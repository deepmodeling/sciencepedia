{
    "hands_on_practices": [
        {
            "introduction": "平衡稳态自由进动 (bSSFP) 序列的一个标志性特征是其对主磁场不均匀性极其敏感，这会导致图像中出现被称为“条带伪影”的暗带。本练习将引导你从第一性原理出发，推导这些伪影带之间的频率间隔，从而揭示重复时间 ($T_R$) 这一关键序列参数与图像伪影之间的直接联系。掌握这种关系对于在临床实践中优化图像质量和解决伪影问题至关重要。",
            "id": "4928331",
            "problem": "平衡稳态自由进动（bSSFP）磁共振成像序列在每个重复时间内使用完全平衡的梯度，因此每个重复周期的净梯度矩为零。考虑一个在旋转坐标系中的单个等时线，其纵向弛豫时间为$T_1$，横向弛豫时间为$T_2$，重复时间为$T_R$，翻转角为$\\alpha$，离共振频率为$f$（单位为Hz）。在每个$T_R$内，由于梯度是平衡的，该等时线仅因$f$而累积一个离共振相位$\\Delta \\phi = 2\\pi f T_R$。从旋转坐标系中的布洛赫方程出发，并利用平衡梯度在回波时间$T_R/2$处产生时间对称重聚焦这一事实，基于第一性原理对相干通路进行推理，以推导bSSFP中稳态横向信号的连续幅度零点之间的频率间隔关于$T_R$的解析表达式。然后，使用您的表达式，计算当$T_R = 3.0$ ms时该间隔的频率（以Hz为单位）。请用Hz表示频率间隔，并将您的数值答案四舍五入到三位有效数字。",
            "solution": "该问题要求推导平衡稳态自由进动（bSSFP）信号中连续幅度零点之间的频率间隔与重复时间$T_R$的函数关系，然后针对给定的$T_R$进行数值计算。\n\nbSSFP序列的基础是为磁化强度建立一个动态平衡，即稳态。在这种状态下，任何给定重复时间（$T_R$）间隔开始时的磁化矢量与任何其他$T_R$间隔开始时的矢量相同，只是在横向平面上有一个相移。\n\n让我们分析一个具有离共振频率$f$的单个等时线的演化。在旋转坐标系中，这种离共振导致磁化矢量以角频率$\\omega = 2\\pi f$进动。在一个重复时间$T_R$的过程中，由于这种离共振，磁化强度的横向分量累积的总相位为$\\Delta \\phi = \\omega T_R = 2\\pi f T_R$。问题陈述正确地指出，由于成像梯度是完全平衡的，它们在一个$T_R$内对相位的净贡献为零。因此，从一个$T_R$到下一个$T_R$的唯一净相位累积来源是离共振$f$。\n\nbSSFP中的稳态信号是组织参数（$T_1$、$T_2$）、序列参数（$\\alpha$、$T_R$）和离共振相位$\\Delta\\phi$的函数。该信号源于多个相干通路的相干叠加。在回波时间（由于序列的时间对称重聚焦特性而为$T_R/2$），来自许多先前$T_R$间隔的横向磁化分量对测量的信号有贡献。\n\n关键的洞察是，整个系统由一串周期性的射频（RF）脉冲驱动。因此，磁化强度的稳态响应必须相对于离共振相位$\\Delta\\phi$是周期性的。磁化强度的任何物理状态，以及因此的信号幅度$|S|$，如果相位$\\Delta\\phi$移动了$2\\pi$的整数倍，则必须是相同的。也就是说，对于任何整数$n$，都有$|S(\\Delta\\phi)| = |S(\\Delta\\phi + 2\\pi n)|$。这确定了bSSFP信号的频率响应曲线是周期性的。\n\nbSSFP信号曲线表现为由信号零点分隔的高信号带。信号零点代表了贡献的相干通路之间最大相消干涉的条件。对于具有恒定射频脉冲相位的序列（正如问题中未指定相位循环所暗示的那样），最大相长干涉的条件发生在共振时，此时$f=0$且$\\Delta\\phi=0$。这产生了主信号通带的中心。\n\n随着离共振频率$f$的增加，相位$\\Delta\\phi$增加，贡献的信号分量变得越来越失相。最大相消干涉的第一个实例，即一个信号零点，发生在当一个$T_R$内累积的相位是$\\pi$的奇数倍时。具体来说，第一个零点出现在$\\Delta\\phi = \\pi$处。随后的零点在每次相位从前一个零点的位置再增加$2\\pi$时出现。总的来说，信号零点位于满足以下条件的离共振频率$f_{null}$处：\n$$ \\Delta\\phi = 2\\pi f_{null} T_R = (2n+1)\\pi $$\n其中$n$是一个整数。求解$f_{null}$可得零点的频率：\n$$ f_{null, n} = \\frac{2n+1}{2T_R} $$\n\n为了找到连续零点之间的频率间隔，我们计算第$(n+1)$个零点和第$n$个零点的频率之差。设此间隔为$\\Delta f_{spacing}$。\n$$ \\Delta f_{spacing} = f_{null, n+1} - f_{null, n} $$\n代入$f_{null}$的表达式：\n$$ \\Delta f_{spacing} = \\frac{2(n+1)+1}{2T_R} - \\frac{2n+1}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{(2n+2+1) - (2n+1)}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{2n+3 - 2n-1}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{2}{2T_R} $$\n$$ \\Delta f_{spacing} = \\frac{1}{T_R} $$\n这就是连续幅度零点之间频率间隔的解析表达式。它仅取决于重复时间$T_R$，而与组织参数$T_1$、$T_2$或翻转角$\\alpha$无关。这些其他参数影响信号通带的幅度和宽度，但不影响零点的基本周期性。\n\n现在，我们为给定的$T_R$计算该间隔的数值。\n给定的重复时间为$T_R = 3.0$ ms。我们必须将其转换为国际单位制（秒），以便频率以赫兹（Hz）为单位。\n$$ T_R = 3.0 \\, \\text{ms} = 3.0 \\times 10^{-3} \\, \\text{s} $$\n使用推导出的间隔表达式：\n$$ \\Delta f_{spacing} = \\frac{1}{T_R} = \\frac{1}{3.0 \\times 10^{-3} \\, \\text{s}} $$\n$$ \\Delta f_{spacing} = \\frac{1000}{3.0} \\, \\text{Hz} \\approx 333.333... \\, \\text{Hz} $$\n问题要求将答案四舍五入到三位有效数字。\n$$ \\Delta f_{spacing} \\approx 333 \\, \\text{Hz} $$",
            "answer": "$$\\boxed{333}$$"
        },
        {
            "introduction": "尽管 bSSFP 序列功能强大，但其应用受到一个重要的现实世界因素的制约：比吸收率 (SAR)，它衡量了射频 (RF) 能量在患者体内的沉积情况。本练习将探讨在严格的 SAR 安全限制下，我们如何确定最大允许的翻转角 ($\\alpha_{\\max}$)，并评估这对图像对比度的影响。通过这个计算，你将理解在高场强磁共振成像中，图像质量、扫描速度和患者安全之间必须进行的权衡 。",
            "id": "4928355",
            "problem": "一个平衡稳态自由进动 (bSSFP) 序列在一个 $3~\\mathrm{T}$ 的全身系统上运行，重复时间 $T_R = 2.5~\\mathrm{ms}$。每次射频 (RF) 激发使用一个持续时间为 $\\tau = 0.5~\\mathrm{ms}$ 的限时方波脉冲。射频发射线圈在等中心处的效率由 $\\beta = 0.12~\\mu\\mathrm{T}/\\sqrt{\\mathrm{W}}$ 表征，这意味着脉冲期间的横向磁场幅度 $B_1^+$ 满足 $B_1^+ = \\beta \\sqrt{P_{\\mathrm{peak}}}$，其中 $P_{\\mathrm{peak}}$ 是脉冲期间的瞬时射频输入功率。氢的旋磁比为 $\\gamma = 2.675 \\times 10^{8}~\\mathrm{rad~s^{-1}~T^{-1}}$。假设每个 $T_R$ 有一个射频脉冲，并且平均输入功率满足 $P_{\\mathrm{avg}} = P_{\\mathrm{peak}} \\frac{\\tau}{T_R}$。\n\n比吸收率 (SAR) 定义为每单位质量吸收的射频功率。对于该患者和序列几何结构，扫描仪的电磁模型得出一个比例关系 $\\mathrm{SAR} = s P_{\\mathrm{avg}}$，其中 $s = f/m$，患者质量 $m = 70~\\mathrm{kg}$，吸收分数 $f = 0.7$。在 $3~\\mathrm{T}$ 的正常操作模式下，全身 SAR 限值为 $\\mathrm{SAR}_{\\max} = 2~\\mathrm{W/kg}$。\n\n从基本翻转角关系 $\\alpha = \\gamma \\int_{0}^{\\tau} B_1^+(t)\\, dt$ 和上述定义出发，推导受 $\\mathrm{SAR}_{\\max}$ 限制的最大允许翻转角 $\\alpha_{\\max}$ 的表达式，并根据给定参数计算其数值。将您的最终数值答案以度为单位表示，并四舍五入到三位有效数字。\n\n然后，基于稳态磁化和饱和行为的第一性原理，简要评估此 $\\alpha_{\\max}$ 将如何影响具有不同 $T_1$ 和 $T_2$ 的组织（例如，心肌与血液）之间的 bSSFP 对比度。您的评估应为定性评估；最终答案必须仅为计算出的角度。",
            "solution": "用户提供了一个基于磁共振成像 (MRI) 物理学原理的有效且定义明确的问题。任务是推导平衡稳态自由进动 (bSSFP) 序列中受比吸收率 (SAR) 限制的最大允许翻转角 $\\alpha_{\\max}$ 的表达式，并计算其值。\n\n推导过程通过建立从 SAR 限值回到翻转角 $\\alpha$ 的一系列关系来进行。\n\n首先，比吸收率 $\\mathrm{SAR}$ 受最大值 $\\mathrm{SAR}_{\\max}$ 的限制：\n$$ \\mathrm{SAR} \\le \\mathrm{SAR}_{\\max} $$\n问题定义了 $\\mathrm{SAR}$ 与平均射频输入功率 $P_{\\mathrm{avg}}$ 之间的线性关系为 $\\mathrm{SAR} = s P_{\\mathrm{avg}}$，其中比例常数为 $s = f/m$。因此，最大平均功率 $P_{\\mathrm{avg, max}}$ 由 $\\mathrm{SAR}_{\\max}$ 决定：\n$$ s P_{\\mathrm{avg, max}} = \\mathrm{SAR}_{\\max} \\implies P_{\\mathrm{avg, max}} = \\frac{\\mathrm{SAR}_{\\max}}{s} = \\frac{\\mathrm{SAR}_{\\max} m}{f} $$\n\n接下来，平均功率 $P_{\\mathrm{avg}}$ 通过脉冲的占空比与射频脉冲期间的瞬时峰值功率 $P_{\\mathrm{peak}}$ 相关。对于每个重复时间 $T_R$ 中持续时间为 $\\tau$ 的一个脉冲，占空比为 $\\tau/T_R$。该关系式如下：\n$$ P_{\\mathrm{avg}} = P_{\\mathrm{peak}} \\frac{\\tau}{T_R} $$\n由此，我们可以找到对应于 $P_{\\mathrm{avg, max}}$ 的最大允许峰值功率 $P_{\\mathrm{peak, max}}$：\n$$ P_{\\mathrm{peak, max}} = P_{\\mathrm{avg, max}} \\frac{T_R}{\\tau} = \\left(\\frac{\\mathrm{SAR}_{\\max} m}{f}\\right) \\frac{T_R}{\\tau} $$\n\n峰值功率 $P_{\\mathrm{peak}}$ 通过线圈效率 $\\beta$ 决定了射频磁场横向分量的幅度 $B_1^+$：\n$$ B_1^+ = \\beta \\sqrt{P_{\\mathrm{peak}}} $$\n因此，可实现的最大场幅度 $B_{1, \\max}^+$ 为：\n$$ B_{1, \\max}^+ = \\beta \\sqrt{P_{\\mathrm{peak, max}}} = \\beta \\sqrt{\\frac{\\mathrm{SAR}_{\\max} m T_R}{f \\tau}} $$\n\n最后，翻转角 $\\alpha$ 由射频场幅度在脉冲持续时间上的时间积分确定。问题指定了一个限时方波脉冲，意味着 $B_1^+(t)$ 在 $t \\in [0, \\tau]$ 期间为常数幅度 $B_1^+$，在其他时间为零。基本关系是：\n$$ \\alpha = \\gamma \\int_{0}^{\\tau} B_1^+(t)\\, dt = \\gamma B_1^+ \\tau $$\n其中 $\\gamma$ 是旋磁比。当使用最大场幅度 $B_{1, \\max}^+$ 时，可以获得最大翻转角 $\\alpha_{\\max}$：\n$$ \\alpha_{\\max} = \\gamma B_{1, \\max}^+ \\tau $$\n\n将 $B_{1, \\max}^+$ 的表达式代入 $\\alpha_{\\max}$ 的方程，得到最终的符号表达式：\n$$ \\alpha_{\\max} = \\gamma \\left( \\beta \\sqrt{\\frac{\\mathrm{SAR}_{\\max} m T_R}{f \\tau}} \\right) \\tau $$\n通过将因子 $\\tau$ 移到平方根内，我们可以简化此表达式：\n$$ \\alpha_{\\max} = \\gamma \\beta \\sqrt{\\frac{\\mathrm{SAR}_{\\max} m T_R \\tau^2}{f \\tau}} = \\gamma \\beta \\sqrt{\\frac{\\mathrm{SAR}_{\\max} m T_R \\tau}{f}} $$\n这就是推导出的最大允许翻转角的表达式。\n\n现在，我们代入给定的数值来计算 $\\alpha_{\\max}$：\n- 旋磁比：$\\gamma = 2.675 \\times 10^{8}~\\mathrm{rad~s^{-1}~T^{-1}}$\n- 线圈效率：$\\beta = 0.12 \\times 10^{-6}~\\mathrm{T}/\\sqrt{\\mathrm{W}}$\n- 最大 SAR：$\\mathrm{SAR}_{\\max} = 2~\\mathrm{W/kg}$\n- 患者质量：$m = 70~\\mathrm{kg}$\n- 重复时间：$T_R = 2.5 \\times 10^{-3}~\\mathrm{s}$\n- 脉冲持续时间：$\\tau = 0.5 \\times 10^{-3}~\\mathrm{s}$\n- 吸收分数：$f = 0.7$\n\n将这些值代入推导出的 $\\alpha_{\\max}$ 公式（以弧度为单位）：\n$$ \\alpha_{\\max} = (2.675 \\times 10^{8}) \\times (0.12 \\times 10^{-6}) \\sqrt{\\frac{(2) \\times (70) \\times (2.5 \\times 10^{-3}) \\times (0.5 \\times 10^{-3})}{0.7}} $$\n$$ \\alpha_{\\max} = (3.21 \\times 10^{1}) \\sqrt{\\frac{1.75 \\times 10^{-4}}{0.7}} $$\n$$ \\alpha_{\\max} = 32.1 \\sqrt{2.5 \\times 10^{-4}} = 32.1 \\times \\sqrt{2.5} \\times 10^{-2} $$\n$$ \\alpha_{\\max} \\approx 32.1 \\times 1.581139 \\times 10^{-2} \\approx 0.507545~\\mathrm{rad} $$\n要将角度表示为度，我们使用转换公式 $\\alpha_{\\mathrm{deg}} = \\alpha_{\\mathrm{rad}} \\times (180/\\pi)$：\n$$ \\alpha_{\\max, \\mathrm{deg}} = 0.507545 \\times \\frac{180}{\\pi} \\approx 29.083^\\circ $$\n四舍五入到三位有效数字，最大允许翻转角为 $29.1^\\circ$。\n\n关于对 bSSFP 对比度的影响，这个 $\\alpha_{\\max} \\approx 29.1^\\circ$ 的值对于 bSSFP 成像而言是一个相对较低的翻转角。在许多应用中，例如心脏电影成像，通常使用 $45^\\circ$ 到 $70^\\circ$ 范围的翻转角来最大化信噪比 (SNR) 以及血液和心肌等组织之间的对比度。bSSFP 稳态信号是 $\\alpha$、$T_R$ 以及组织参数 $T_1$ 和 $T_2$ 的函数，其特有的亮血外观源于其对 $T_2/T_1$ 比值的敏感性。由于受 SAR 限值的制约而只能使用低翻转角，该序列是在 SAR 受限模式下运行，而不是在对比度优化或信号优化模式下运行。这将导致整体信噪比低于在允许更高翻转角时可能达到的水平。虽然基本的 $T_2/T_1$ 对比度机制得以保留，但降低的信噪比会降低对比度噪声比 (CNR)，这可能会损害图像的诊断质量，例如，使血池和心肌之间的边界变得不那么清晰。这种限制是高场磁共振成像中常见的权衡，尤其对于像 bSSFP 这样的快速成像序列。",
            "answer": "$$\n\\boxed{29.1}\n$$"
        },
        {
            "introduction": "为了将前面学到的所有概念融会贯通，最后的练习是构建一个 bSSFP 信号的完整计算模型。通过编程实现基于 Bloch 方程的稳态信号模拟，你将能够量化地探索组织参数 ($T_1$, $T_2$) 和序列参数 ($T_R$, $\\alpha$, 离共振频率) 如何共同决定最终的复数信号。这项实践将为你提供超越简单解析公式的深刻直觉，并让你能够亲自验证如 SAR 限制下的翻转角  或离共振效应  等对信号的影响。",
            "id": "4928374",
            "problem": "实现一个程序，从 Bloch 方程模型出发，计算完全平衡稳态自由进动 (SSFP) 序列（也称为平衡稳态自由进动，bSSFP）的复数稳态横向磁化强度 $M_{xy,\\infty}$，并用平衡纵向磁化强度 $M_0$ 对其进行归一化。该计算必须基于第一性原理，并使用以下建模假设和定义。\n\n你必须在旋转坐标系中，根据带弛豫的 Bloch 方程对磁化矢量 $M = [M_x,M_y,M_z]^\\top$ 进行建模，其中纵向和横向弛豫分别由时间常数 $T_1$ 和 $T_2$ 表征。在一个重复时间 $T_R$ 内，弛豫由对角矩阵 $E = \\mathrm{diag}(E_2,E_2,E_1)$ 表示，其中 $E_1 = \\exp(-T_R/T_1)$ 和 $E_2 = \\exp(-T_R/T_2)$，平衡磁化矢量为 $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$。每个重复周期内净的离共振相位累积表示为使用旋转矩阵 $R_z(\\phi)$ 绕 $z$ 轴旋转角度 $\\phi$，射频 (RF) 脉冲被建模为使用 $R_x(\\alpha)$ 绕 $x$ 轴按翻转角 $\\alpha$ 进行的瞬时旋转。使用右手旋转及以下标准定义\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1  & 0 & 0\\\\\n0  & \\cos\\alpha & -\\sin\\alpha\\\\\n0  & \\sin\\alpha & \\cos\\alpha\n\\end{bmatrix},\\quad\nR_z(\\phi) =\n\\begin{bmatrix}\n\\cos\\phi & -\\sin\\phi & 0\\\\\n\\sin\\phi & \\cos\\phi & 0\\\\\n0 & 0 & 1\n\\end{bmatrix}.\n$$\n\n令 $M_n^-$ 表示第 $n$ 个射频脉冲前的瞬时磁化强度，$M_n^+$ 表示该射频脉冲后的瞬时磁化强度。在稳态下，磁化强度在重复周期之间保持时不变。从 Bloch 方程和这些旋转推导出跨越一个重复周期的适当的离散时间仿射映射，求解稳态不动点 $M_\\infty^-$，然后计算 $M_\\infty^+ = R_x(\\alpha) M_\\infty^-$。将复数稳态信号报告为\n$$\nM_{xy,\\infty} \\equiv M_x^+ + i\\,M_y^+,\n$$\n并用 $M_0$ 进行归一化（也就是说，不失一般性地设 $M_0 = 1$）。\n\n必须遵循以下角度单位和时间单位：\n- 翻转角 $\\alpha$ 必须以度为单位提供，并在内部转换为弧度。\n- 离共振相位 $\\phi$ 必须以弧度为单位提供和使用。\n- 所有弛豫时间 $T_1$、$T_2$ 和重复时间 $T_R$ 必须以毫秒为单位提供，并且指数衰减必须一致地使用这些值，以使 $T_R/T_1$ 和 $T_R/T_2$ 是无量纲的。\n\n你的程序必须基于上述物理原理实现一个通用求解器，然后为以下参数集测试套件评估 $M_{xy,\\infty}/M_0$（每个元组为 $(T_1~\\mathrm{ms}, T_2~\\mathrm{ms}, T_R~\\mathrm{ms}, \\alpha~\\mathrm{deg}, \\phi~\\mathrm{rad})$）：\n- 情况 A（通用 bSSFP 工作点）：$(1200, 40, 3.5, 65, \\pi/2)$。\n- 情况 B（边界，无激励）：$(1000, 80, 4.0, 0, 0)$。\n- 情况 C（长 $T_2$、小翻转角、在共振）：$(1000, 200, 4.0, 30, 0)$。\n- 情况 D（极短 $T_2$、大翻转角、带边）：$(1200, 10, 5.0, 90, \\pi)$。\n- 情况 E（中等弛豫、带边）：$(800, 80, 3.0, 50, \\pi)$。\n\n数值输出要求：\n- 对于每种情况，将 $M_{xy,\\infty}/M_0$ 的实部和虚部输出为两个浮点数。\n- 将每个浮点数四舍五入到 $6$ 位小数。\n- 你的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，顺序为 $[\\Re(M_{xy,\\infty}^{(A)}), \\Im(M_{xy,\\infty}^{(A)}), \\Re(M_{xy,\\infty}^{(B)}), \\Im(M_{xy,\\infty}^{(B)}), \\dots]$，涵盖情况 A 到 E。\n\n在内部以弧度表示所有角度，并在计算指数时确保量纲一致性。无需用户输入；程序必须硬编码上述测试套件，并按规定将所有情况的结果打印在单行中。",
            "solution": "我们从旋转坐标系中带弛豫的 Bloch 方程开始，\n$$\n\\frac{d}{dt}\n\\begin{bmatrix}\nM_x\\\\\nM_y\\\\\nM_z\n\\end{bmatrix}\n=\n\\gamma\n\\begin{bmatrix}\nM_y B_z - M_z B_y\\\\\nM_z B_x - M_x B_z\\\\\nM_x B_y - M_y B_x\n\\end{bmatrix}\n-\n\\begin{bmatrix}\n\\frac{M_x}{T_2}\\\\\n\\frac{M_y}{T_2}\\\\\n\\frac{M_z - M_0}{T_1}\n\\end{bmatrix},\n$$\n其中 $\\gamma$ 是旋磁比，$M_0$ 是平衡纵向磁化强度（与 $z$ 轴对齐）。对于完全平衡稳态自由进动 (SSFP) 序列（平衡 SSFP，或 bSSFP），在每个重复时间 $T_R$ 内梯度矩为零，任何静态离共振都会在每个重复周期内产生一个净相位累积 $\\phi$，表现为绕 $z$ 轴的旋转。射频 (RF) 脉冲被建模为磁化强度绕 $x$ 轴按翻转角 $\\alpha$ 进行的瞬时旋转。\n\n在没有射频脉冲的有限时间间隔 $T_R$ 内，Bloch 方程的解可以分解为绕 $z$ 轴旋转 $\\phi$ 和指数弛豫。引入弛豫矩阵\n$$\nE = \\mathrm{diag}(E_2,E_2,E_1),\\quad E_1 = e^{-T_R/T_1},\\quad E_2 = e^{-T_R/T_2},\n$$\n和平衡矢量 $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$，在 $T_R$ 期间的自由演化将初始磁化强度 $M$ 映射为\n$$\nM \\mapsto R_z(\\phi)\\,E\\,M + \\left(I - E\\right) M_{\\mathrm{eq}},\n$$\n其中 $R_z(\\phi)$ 是绕 $z$ 轴按角度 $\\phi$ 的右手旋转。瞬时射频脉冲将 $M^-$ 映射为 $M^+ = R_x(\\alpha) M^-$，其中 $R_x(\\alpha)$ 是绕 $x$ 轴按翻转角 $\\alpha$ 的右手旋转。使用标准旋转矩阵\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1  & 0 & 0\\\\\n0  & \\cos\\alpha & -\\sin\\alpha\\\\\n0  & \\sin\\alpha & \\cos\\alpha\n\\end{bmatrix},\\quad\nR_z(\\phi) =\n\\begin{bmatrix}\n\\cos\\phi & -\\sin\\phi & 0\\\\\n\\sin\\phi & \\cos\\phi & 0\\\\\n0 & 0 & 1\n\\end{bmatrix},\n$$\n我们可以将跨越一个重复周期的离散时间演化写为如下形式。令 $M_n^-$ 表示第 $n$ 个射频脉冲前的瞬时磁化强度，$M_n^+$ 表示其后的瞬时磁化强度。于是\n$$\nM_n^+ = R_x(\\alpha)\\,M_n^-,\n$$\n经过 $T_R$ 时间内带有离共振和弛豫的自由演化后，\n$$\nM_{n+1}^- = R_z(\\phi)\\,E\\,M_n^+ + \\left(I - E\\right) M_{\\mathrm{eq}}.\n$$\n消去 $M_n^+$，我们得到关于 $M_n^-$ 的仿射递归关系：\n$$\nM_{n+1}^- = \\underbrace{R_z(\\phi)\\,E\\,R_x(\\alpha)}_{A}\\, M_n^- + \\underbrace{\\left(I - E\\right) M_{\\mathrm{eq}}}_{c}.\n$$\n在稳态下，磁化强度是时不变的，因此 $M_{n+1}^- = M_n^- = M_\\infty^-$。因此 $M_\\infty^-$ 满足线性系统\n$$\n\\left(I - A\\right) M_\\infty^- = c.\n$$\n只要 $I - A$ 是非奇异的（在实践中对于 $E_1  1$ 和 $E_2  1$ 成立），唯一的稳态解是\n$$\nM_\\infty^- = \\left(I - R_z(\\phi)\\,E\\,R_x(\\alpha)\\right)^{-1} \\left(I - E\\right) M_{\\mathrm{eq}}.\n$$\n射频脉冲后的瞬时磁化强度为\n$$\nM_\\infty^+ = R_x(\\alpha) M_\\infty^-.\n$$\n复数横向稳态信号则定义为\n$$\nM_{xy,\\infty} \\equiv M_x^+ + i\\,M_y^+.\n$$\n\n用 $M_0$ 进行归一化很简单，因为系统对于 $M_{\\mathrm{eq}} = [0,0,M_0]^\\top$ 是线性的。设 $M_0 = 1$ 可以直接得到 $M_{xy,\\infty}/M_0$。角度必须一致处理：将翻转角 $\\alpha$ 从度转换为弧度，即 $\\alpha_{\\mathrm{rad}} = \\alpha_{\\mathrm{deg}} \\cdot \\pi/180$，并使用以弧度为单位的 $\\phi$。弛豫时间 $T_1$、$T_2$ 和重复时间 $T_R$ 以毫秒为单位提供，并且必须一致地使用，以使在定义 $E_1$ 和 $E_2$ 的指数函数中，$T_R/T_1$ 和 $T_R/T_2$ 是无量纲的。\n\n对任意给定的 $(T_1, T_2, T_R, \\alpha, \\phi)$ 计算 $M_{xy,\\infty}/M_0$ 的算法步骤：\n1. 设 $M_0 = 1$ 并构造 $M_{\\mathrm{eq}} = [0,0,1]^\\top$。\n2. 将 $\\alpha$ 从度转换为弧度，并按给定的弧度值使用 $\\phi$。\n3. 使用以毫秒为单位的时间计算 $E_1 = \\exp(-T_R/T_1)$ 和 $E_2 = \\exp(-T_R/T_2)$。\n4. 构造矩阵 $E = \\mathrm{diag}(E_2,E_2,E_1)$、$R_x(\\alpha)$ 和 $R_z(\\phi)$。\n5. 构造 $A = R_z(\\phi)\\,E\\,R_x(\\alpha)$ 和 $c = (I - E) M_{\\mathrm{eq}}$。\n6. 使用数值稳定的求解器求解线性系统 $(I - A) M_\\infty^- = c$ 以得到 $M_\\infty^-$（避免显式矩阵求逆）。\n7. 计算 $M_\\infty^+ = R_x(\\alpha) M_\\infty^-$。\n8. 构造 $M_{xy,\\infty} = M_x^+ + i\\,M_y^+$。\n9. 将 $\\Re(M_{xy,\\infty})$ 和 $\\Im(M_{xy,\\infty})$ 作为浮点数输出，并四舍五入到 $6$ 位小数。\n\n一致性检查和边界情况：\n- 对于 $\\alpha = 0$（情况 B），$R_x(\\alpha) = I$，稳态必须保持与 $z$ 轴对齐；因此 $M_{xy,\\infty} = 0 + i\\,0$。上述公式重现了这一点，提供了边界验证。\n- 对于非常短的 $T_2$（情况 D），$E_2$ 很小，会强烈衰减横向分量，因此 $|M_{xy,\\infty}|$ 应该很小。\n- 在带边（例如 $\\phi = \\pi$），$M_{xy,\\infty}$ 的相位会发生特征性变化；旋转矩阵的公式能够捕捉到这种行为。\n\n程序实现了这个求解器并评估了指定的测试套件，以精确要求的格式打印单行结果：\n$[\\Re(M_{xy,\\infty}^{(A)}), \\Im(M_{xy,\\infty}^{(A)}), \\Re(M_{xy,\\infty}^{(B)}), \\Im(M_{xy,\\infty}^{(B)}), \\Re(M_{xy,\\infty}^{(C)}), \\Im(M_{xy,\\infty}^{(C)}), \\Re(M_{xy,\\infty}^{(D)}), \\Im(M_{xy,\\infty}^{(D)}), \\Re(M_{xy,\\infty}^{(E)}), \\Im(M_{xy,\\infty}^{(E)})]$，每个浮点数四舍五入到 $6$ 位小数。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef rotation_x(alpha_rad: float) - np.ndarray:\n    ca = np.cos(alpha_rad)\n    sa = np.sin(alpha_rad)\n    return np.array([[1.0, 0.0, 0.0],\n                     [0.0, ca,  -sa],\n                     [0.0, sa,   ca]], dtype=float)\n\ndef rotation_z(phi_rad: float) - np.ndarray:\n    cp = np.cos(phi_rad)\n    sp = np.sin(phi_rad)\n    return np.array([[cp, -sp, 0.0],\n                     [sp,  cp, 0.0],\n                     [0.0, 0.0, 1.0]], dtype=float)\n\ndef ssfp_steady_state_Mxy(T1_ms: float, T2_ms: float, TR_ms: float,\n                          alpha_deg: float, phi_rad: float) - complex:\n    # Normalize M0 = 1 (results scale linearly with M0)\n    Meq = np.array([0.0, 0.0, 1.0], dtype=float)\n\n    # Convert units\n    alpha_rad = np.deg2rad(alpha_deg)  # degrees to radians\n\n    # Relaxation factors (times in ms consistently)\n    E1 = np.exp(-TR_ms / T1_ms)\n    E2 = np.exp(-TR_ms / T2_ms)\n\n    # Matrices\n    E = np.diag([E2, E2, E1])\n    Rx = rotation_x(alpha_rad)\n    Rz = rotation_z(phi_rad)\n\n    I = np.eye(3, dtype=float)\n    A = Rz @ E @ Rx\n    c = (I - E) @ Meq\n\n    # Solve (I - A) M_minus = c\n    M_minus = np.linalg.solve(I - A, c)\n\n    # Magnetization immediately after RF\n    M_plus = Rx @ M_minus\n\n    # Complex transverse signal\n    Mxy = M_plus[0] + 1j * M_plus[1]\n    return Mxy\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Each tuple: (T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad)\n    test_cases = [\n        (1200.0,  40.0, 3.5, 65.0, np.pi/2),  # Case A\n        (1000.0,  80.0, 4.0,  0.0, 0.0),      # Case B\n        (1000.0, 200.0, 4.0, 30.0, 0.0),      # Case C\n        (1200.0,  10.0, 5.0, 90.0, np.pi),    # Case D\n        (800.0,   80.0, 3.0, 50.0, np.pi),    # Case E\n    ]\n\n    # Compute results and format to 6 decimal places\n    formatted_results = []\n    for case in test_cases:\n        T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad = case\n        Mxy = ssfp_steady_state_Mxy(T1_ms, T2_ms, TR_ms, alpha_deg, phi_rad)\n        re = f\"{Mxy.real:.6f}\"\n        im = f\"{Mxy.imag:.6f}\"\n        formatted_results.append(re)\n        formatted_results.append(im)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}