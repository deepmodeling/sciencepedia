{
    "hands_on_practices": [
        {
            "introduction": "The effectiveness of the Short Tau Inversion Recovery (STIR) technique hinges on a precise timing calculation. This first exercise will guide you through the fundamental physics, starting from the Bloch equation for longitudinal relaxation, to derive the ideal inversion time ($TI$) required to null the signal from fat. By working through this derivation, you will solidify your understanding of how spin-lattice relaxation governs the STIR mechanism and calculate the canonical value for fat suppression .",
            "id": "4922663",
            "problem": "A Short Tau Inversion Recovery (STIR) sequence is used in magnetic resonance imaging to suppress the signal from fat by timing the readout at the instant when the longitudinal magnetization of fat crosses zero. Consider a perfectly adiabatic inversion pulse of flip angle $180^{\\circ}$ followed by a delay $TI$ before the excitation and readout. Assume a long repetition time so that $TR \\gg T_{1,\\text{fat}}$, and neglect transverse relaxation and readout effects during $TI$. Use the longitudinal component of the Bloch equation, written as the first-order linear differential equation $dM_{z}(t)/dt = \\left(M_{0} - M_{z}(t)\\right)/T_{1}$, together with the initial condition immediately after the inversion pulse $M_{z}(0^{+}) = -M_{0}$, to derive the condition on $TI$ that nulls fat magnetization.\n\nEvaluate the ideal inversion time $TI_{\\text{ideal}}$ for fat with longitudinal relaxation time $T_{1,\\text{fat}} = 370$ ms at $3$ T. Express your final numerical answer in ms and round to three significant figures.\n\nIn addition, briefly explain, based on physical and empirical considerations grounded in the same longitudinal recovery model, why in practice radiologists often use slightly shorter $TI$ values than the calculated ideal value, even at the same field strength and temperature. Your explanation will not be graded numerically, but it should be consistent with the underlying physics.",
            "solution": "The problem asks for the derivation of the ideal inversion time ($TI$) for a Short Tau Inversion Recovery (STIR) sequence, its numerical calculation for fat tissue, and an explanation for a common clinical practice. The validation of the problem statement confirms that it is scientifically grounded, well-posed, and objective. The provided physical model and parameters are consistent with the principles of magnetic resonance imaging.\n\nThe time evolution of the longitudinal magnetization, $M_z(t)$, following an event that perturbs it from its thermal equilibrium value, $M_0$, is described by the longitudinal component of the Bloch equation. The problem provides this as a first-order linear ordinary differential equation:\n$$\n\\frac{dM_{z}(t)}{dt} = \\frac{M_{0} - M_{z}(t)}{T_{1}}\n$$\nHere, $T_1$ is the longitudinal (or spin-lattice) relaxation time constant for the tissue of interest. This equation describes the recovery of $M_z$ towards its equilibrium value $M_0$.\n\nThe STIR sequence begins with a $180^{\\circ}$ inversion pulse. Assuming the magnetization is at equilibrium ($M_z = M_0$) before the pulse, a perfect $180^{\\circ}$ pulse flips the magnetization vector such that immediately after the pulse, at time $t=0^{+}$, the longitudinal component is fully inverted. This gives the initial condition:\n$$\nM_{z}(0^{+}) = -M_{0}\n$$\nWe must solve the differential equation subject to this initial condition. The equation can be rearranged for integration by separation of variables:\n$$\n\\frac{dM_{z}}{M_{0} - M_{z}} = \\frac{dt}{T_{1}}\n$$\nIntegrating both sides yields:\n$$\n\\int \\frac{dM_{z}}{M_{0} - M_{z}} = \\int \\frac{dt}{T_{1}} \\\\\n-\\ln|M_{0} - M_{z}(t)| = \\frac{t}{T_{1}} + C'\n$$\nwhere $C'$ is the constant of integration. Exponentiating both sides gives:\n$$\n|M_{0} - M_{z}(t)| = \\exp\\left(-\\frac{t}{T_{1}} - C'\\right) = C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nwhere $C = e^{-C'}$. Since $M_z(t)$ starts at $-M_0$ and recovers towards $+M_0$, the quantity $M_0 - M_z(t)$ is always non-negative for $t \\ge 0$, so the absolute value can be removed.\n$$\nM_{0} - M_{z}(t) = C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nThe solution for $M_z(t)$ is:\n$$\nM_{z}(t) = M_{0} - C \\exp\\left(-\\frac{t}{T_{1}}\\right)\n$$\nTo find the constant $C$, we apply the initial condition $M_{z}(0) = -M_{0}$:\n$$\n-M_{0} = M_{0} - C \\exp(0) = M_{0} - C\n$$\nSolving for $C$, we find $C = M_{0} - (-M_{0}) = 2M_{0}$. Substituting this back into the general solution gives the specific equation for longitudinal magnetization recovery following a perfect inversion:\n$$\nM_{z}(t) = M_{0} - 2M_{0} \\exp\\left(-\\frac{t}{T_{1}}\\right) = M_{0}\\left(1 - 2\\exp\\left(-\\frac{t}{T_{1}}\\right)\\right)\n$$\nThe goal of STIR is to suppress the signal from a specific tissue (in this case, fat) by applying the subsequent excitation pulse at the exact moment its longitudinal magnetization is zero. This time is the inversion time, $TI$. We find this time by setting $M_{z}(TI) = 0$:\n$$\n0 = M_{0}\\left(1 - 2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right)\\right)\n$$\nSince the equilibrium magnetization $M_0$ is non-zero, the term in the parenthesis must be zero:\n$$\n1 - 2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = 0 \\\\\n2\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = 1 \\\\\n\\exp\\left(-\\frac{TI}{T_{1,\\text{fat}}}\\right) = \\frac{1}{2}\n$$\nTo solve for $TI$, we take the natural logarithm of both sides:\n$$\n-\\frac{TI}{T_{1,\\text{fat}}} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)\n$$\nThis gives the expression for the ideal inversion time, $TI_{\\text{ideal}}$:\n$$\nTI_{\\text{ideal}} = T_{1,\\text{fat}} \\ln(2)\n$$\nThe problem specifies the longitudinal relaxation time for fat at a field strength of $3$ T as $T_{1,\\text{fat}} = 370$ ms. We can now calculate the numerical value for $TI_{\\text{ideal}}$:\n$$\nTI_{\\text{ideal}} = 370 \\, \\text{ms} \\times \\ln(2) \\approx 370 \\times 0.693147 \\approx 256.46459 \\, \\text{ms}\n$$\nRounding this result to three significant figures, as requested, we get:\n$$\nTI_{\\text{ideal}} = 256 \\, \\text{ms}\n$$\n\nThe second part of the problem asks for an explanation of why, in practice, radiologists often use a slightly shorter $TI$ than this calculated ideal value. The explanation must be grounded in the same physical model. The ideal calculation assumes a perfect $180^{\\circ}$ inversion pulse. In reality, imperfections in the radiofrequency ($B_1$) field lead to spatial variations in the flip angle, meaning that for much of the tissue volume, the flip angle $\\alpha$ may be less than $180^{\\circ}$.\n\nLet's analyze the effect of an imperfect flip angle $\\alpha < 180^{\\circ}$ using the same longitudinal recovery model. The initial condition after the pulse becomes $M_{z}(0^{+}) = M_{0} \\cos(\\alpha)$. The integration constant $C$ in the general solution $M_{z}(t) = M_{0} - C \\exp(-t/T_{1})$ is now:\n$$\nM_{0} \\cos(\\alpha) = M_{0} - C \\implies C = M_{0}(1 - \\cos(\\alpha))\n$$\nThe recovery equation becomes:\n$$\nM_{z}(t) = M_{0}\\left(1 - (1 - \\cos(\\alpha))\\exp\\left(-\\frac{t}{T_{1}}\\right)\\right)\n$$\nSetting $M_{z}(TI) = 0$ to find the new nulling time:\n$$\n1 - (1 - \\cos(\\alpha))\\exp\\left(-\\frac{TI}{T_{1}}\\right) = 0 \\\\\n\\exp\\left(-\\frac{TI}{T_{1}}\\right) = \\frac{1}{1 - \\cos(\\alpha)} \\\\\nTI = T_{1} \\ln(1 - \\cos(\\alpha))\n$$\nFor a perfect pulse, $\\alpha = 180^{\\circ}$, so $\\cos(\\alpha) = -1$, and $TI = T_{1}\\ln(1 - (-1)) = T_{1}\\ln(2)$, which is our ideal case. For an imperfect pulse where $\\alpha < 180^{\\circ}$ (but $\\alpha > 90^{\\circ}$ for inversion), we have $-1 < \\cos(\\alpha) < 0$. This means $1 < 1 - \\cos(\\alpha) < 2$. Since $\\ln(x)$ is a monotonically increasing function for $x>0$, it follows that $\\ln(1 - \\cos(\\alpha)) < \\ln(2)$. Consequently, the required inversion time for a non-ideal pulse is shorter than the ideal one: $TI < TI_{\\text{ideal}}$. Since practical STIR sequences must be robust to $B_1$ inhomogeneity, choosing a slightly shorter $TI$ provides a better average nulling effect across the imaging volume where flip angles are commonly less than the prescribed $180^{\\circ}$.\n\nAdditionally, biological fat is not a single substance with a single $T_1$ value, but a mixture of triglycerides with a distribution of $T_1$ values. Choosing a $TI$ slightly shorter than the ideal value for the average $T_1$ can result in more robust overall suppression of the signal from the entire distribution of fat components.",
            "answer": "$$\\boxed{256}$$"
        },
        {
            "introduction": "While the ideal inversion time provides a theoretical target, its practical implementation requires high precision. This exercise explores the consequences of small timing errors by having you calculate the sensitivity of the residual fat signal around the null point. Understanding this sensitivity quantitatively reveals why stable and accurate hardware timing is critical for robust fat suppression in clinical MRI .",
            "id": "4922673",
            "problem": "Short Tau Inversion Recovery (STIR) in Magnetic Resonance Imaging (MRI) uses an inversion pulse followed by an inversion time $TI$ chosen to null the fat signal. Consider a single inversion recovery preparation for fat in which the longitudinal magnetization $M_z(t)$ obeys the longitudinal Bloch equation $dM_z/dt = (M_0 - M_z)/T_1$, with $M_0$ the thermal equilibrium magnetization and $T_1$ the longitudinal relaxation time of fat. Assume a perfect $180^\\circ$ inversion at $t=0$ so that $M_z(0^+) = -M_0$, and a repetition time $TR$ satisfying $TR \\gg T_1$ so that full recovery occurs between preparations and readout perturbations are negligible up to time $TI$. \n\nStarting from the differential equation and its initial condition, derive the form of $M_z(TI)$ for fat, determine the nulling inversion time $TI_0$ that satisfies $M_z(TI_0)=0$, and then compute the sensitivity of the residual fat signal to small $TI$ errors by evaluating the derivative $\\partial (M_z/M_0)/\\partial TI$ at $TI=TI_0$. Finally, using $T_{1,\\mathrm{fat}} = 280\\,\\mathrm{ms}$, compute the numerical value of this sensitivity in $\\mathrm{s}^{-1}$. Round your answer to $4$ significant figures and express it in $\\mathrm{s}^{-1}$. In one or two sentences, interpret what this value implies about the timing precision required for fat suppression near the null point.",
            "solution": "The problem statement will be validated before a solution is attempted.\n\n### Step 1: Extract Givens\n- The longitudinal magnetization $M_z(t)$ follows the differential equation: $\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}$.\n- $M_0$ is the thermal equilibrium magnetization.\n- $T_1$ is the longitudinal relaxation time of fat.\n- The initial condition after a perfect $180^\\circ$ inversion pulse at $t=0$ is $M_z(0^+) = -M_0$.\n- The repetition time $TR$ satisfies $TR \\gg T_1$.\n- The specific longitudinal relaxation time for fat is given as $T_{1,\\mathrm{fat}} = 280\\,\\mathrm{ms}$.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded:** The problem describes the longitudinal relaxation of magnetization in MRI following an inversion pulse, governed by the Bloch equation. This is a fundamental and well-established concept in the physics of MRI. The equation and initial condition are standard for an inversion-recovery sequence. The value for $T_{1,\\mathrm{fat}}$ is a typical, physically realistic value at common field strengths.\n- **Well-Posed:** The problem provides a first-order linear ordinary differential equation with a well-defined initial condition. The required tasks (solving the ODE, finding a specific time, calculating a derivative, and evaluating a numerical value) are all mathematically well-defined and lead to a unique solution.\n- **Objective:** The problem is stated using precise, standard terminology from physics and mathematics. It is free from subjective, ambiguous, or opinion-based language.\n\n### Step 3: Verdict and Action\nThe problem is valid. It is scientifically sound, well-posed, and objective. A solution will be provided.\n\nThe evolution of the longitudinal magnetization $M_z$ after an inversion pulse is described by the Bloch equation for longitudinal relaxation:\n$$\n\\frac{dM_z}{dt} = \\frac{M_0 - M_z}{T_1}\n$$\nThis is a first-order linear ordinary differential equation. We can rearrange it into the standard form:\n$$\n\\frac{dM_z}{dt} + \\frac{1}{T_1} M_z = \\frac{M_0}{T_1}\n$$\nThe general solution to this equation is the sum of the homogeneous solution and a particular solution. The homogeneous equation is $\\frac{dM_{z,h}}{dt} + \\frac{1}{T_1} M_{z,h} = 0$, which has the solution $M_{z,h}(t) = C \\exp(-t/T_1)$, where $C$ is a constant of integration. A particular solution is a constant value $M_{z,p} = M_0$.\nThus, the general solution is:\n$$\nM_z(t) = M_0 + C \\exp\\left(-\\frac{t}{T_1}\\right)\n$$\nTo find the constant $C$, we apply the initial condition. The problem states that at $t=0$, a perfect $180^\\circ$ inversion pulse is applied, flipping the magnetization from its equilibrium value $M_0$ (since $TR \\gg T_1$ ensures full recovery before the pulse) to $-M_0$. Therefore, the initial condition is $M_z(0^+) = -M_0$.\nSubstituting this into the general solution at $t=0$:\n$$\nM_z(0) = M_0 + C \\exp(0) = M_0 + C\n$$\n$$\n-M_0 = M_0 + C \\implies C = -2M_0\n$$\nSubstituting the value of $C$ back into the general solution gives the specific solution for the magnetization recovery:\n$$\nM_z(t) = M_0 - 2M_0 \\exp\\left(-\\frac{t}{T_1}\\right)\n$$\nThis can be factored to give the form of the longitudinal magnetization at any time $t$ after the inversion pulse:\n$$\nM_z(t) = M_0 \\left(1 - 2\\exp\\left(-\\frac{t}{T_1}\\right)\\right)\n$$\nThe problem asks for $M_z(TI)$, which is found by setting $t=TI$:\n$$\nM_z(TI) = M_0 \\left(1 - 2\\exp\\left(-\\frac{TI}{T_1}\\right)\\right)\n$$\nNext, we determine the nulling inversion time $TI_0$, which is the specific time at which the fat signal is zero. This is achieved by setting $M_z(TI_0) = 0$:\n$$\n0 = M_0 \\left(1 - 2\\exp\\left(-\\frac{TI_0}{T_1}\\right)\\right)\n$$\nSince $M_0 \\neq 0$, we must have:\n$$\n1 - 2\\exp\\left(-\\frac{TI_0}{T_1}\\right) = 0\n$$\n$$\n2\\exp\\left(-\\frac{TI_0}{T_1}\\right) = 1\n$$\n$$\n\\exp\\left(-\\frac{TI_0}{T_1}\\right) = \\frac{1}{2}\n$$\nTaking the natural logarithm of both sides:\n$$\n-\\frac{TI_0}{T_1} = \\ln\\left(\\frac{1}{2}\\right) = -\\ln(2)\n$$\nSolving for $TI_0$:\n$$\nTI_0 = T_1 \\ln(2)\n$$\nNow, we compute the sensitivity of the residual fat signal to small errors in the inversion time $TI$. The residual signal is the normalized magnetization $M_z/M_0$. Let's define this normalized signal as $S(TI)$:\n$$\nS(TI) = \\frac{M_z(TI)}{M_0} = 1 - 2\\exp\\left(-\\frac{TI}{T_1}\\right)\n$$\nThe sensitivity is the derivative of $S(TI)$ with respect to $TI$, evaluated at the null point $TI = TI_0$.\nFirst, we find the derivative:\n$$\n\\frac{\\partial S}{\\partial TI} = \\frac{\\partial}{\\partial TI} \\left(1 - 2\\exp\\left(-\\frac{TI}{T_1}\\right)\\right) = -2 \\cdot \\left(-\\frac{1}{T_1}\\right) \\exp\\left(-\\frac{TI}{T_1}\\right) = \\frac{2}{T_1} \\exp\\left(-\\frac{TI}{T_1}\\right)\n$$\nNow, we evaluate this derivative at $TI = TI_0 = T_1 \\ln(2)$:\n$$\n\\left. \\frac{\\partial S}{\\partial TI} \\right|_{TI=TI_0} = \\frac{2}{T_1} \\exp\\left(-\\frac{T_1 \\ln(2)}{T_1}\\right) = \\frac{2}{T_1} \\exp(-\\ln(2))\n$$\nUsing the property $\\exp(-\\ln(x)) = \\exp(\\ln(x^{-1})) = x^{-1}$, we have $\\exp(-\\ln(2)) = 1/2$.\n$$\n\\left. \\frac{\\partial S}{\\partial TI} \\right|_{TI=TI_0} = \\frac{2}{T_1} \\cdot \\frac{1}{2} = \\frac{1}{T_1}\n$$\nThe sensitivity of the residual signal at the null point is simply the inverse of the longitudinal relaxation time.\n\nFinally, we compute the numerical value of this sensitivity using the given value $T_{1,\\mathrm{fat}} = 280\\,\\mathrm{ms}$. The units must be in $\\mathrm{s}^{-1}$, so we first convert $T_1$ to seconds:\n$$\nT_{1,\\mathrm{fat}} = 280\\,\\mathrm{ms} = 0.280\\,\\mathrm{s}\n$$\nThe sensitivity is:\n$$\n\\text{Sensitivity} = \\frac{1}{T_{1,\\mathrm{fat}}} = \\frac{1}{0.280\\,\\mathrm{s}} \\approx 3.571428...\\,\\mathrm{s}^{-1}\n$$\nRounding to $4$ significant figures, the numerical value is $3.571\\,\\mathrm{s}^{-1}$.\n\nThis sensitivity value of approximately $3.571\\,\\mathrm{s}^{-1}$ indicates that the magnitude of the normalized residual fat signal increases by about $3.571$ times the timing error (in seconds) near the null point. This highlights that for effective fat suppression, the inversion time $TI$ must be chosen with high precision, as small deviations from the ideal $TI_0$ can lead to a noticeable reappearance of the fat signal.",
            "answer": "$$\n\\boxed{3.571}\n$$"
        },
        {
            "introduction": "To gain a comprehensive understanding of image contrast in STIR imaging, we move from analytical formulas to a full computational model. This practice challenges you to implement a Bloch equation simulator for a STIR sequence, accounting for multiple tissue types, radiofrequency pulse effects, and readout decay. Building this simulation provides a powerful, hands-on tool for visualizing how different sequence parameters interact to create the final fat-suppressed image .",
            "id": "4922701",
            "problem": "You are to model Short Tau Inversion Recovery (STIR) for fat suppression followed by a Turbo Spin Echo (TSE) readout using the Bloch equations, and implement the resulting model as a runnable program. The physical scenario is: a nonselective inversion radiofrequency pulse of flip angle $180^\\circ$, free relaxation during an inversion time $TI$, a slice-selective excitation radiofrequency pulse of flip angle $90^\\circ$, and a TSE train producing the first spin echo at echo time $TE$. Short Tau Inversion Recovery (STIR) refers to choosing a short $TI$ to null fat signal. Turbo Spin Echo (TSE) refers to a rapid spin-echo readout with repeated $180^\\circ$ refocusing pulses.\n\nThe fundamental base to use is the Bloch equations in the rotating frame with relaxation. Let the magnetization vector be $\\mathbf{M}(t) = [M_x(t), M_y(t), M_z(t)]^\\top$, the equilibrium magnetization be $M_0$, the longitudinal relaxation time be $T_1$, and the transverse relaxation time be $T_2$. Under no applied radiofrequency field in the rotating frame, the Bloch equations are:\n$$\n\\frac{d}{dt}\\begin{bmatrix}M_x\\\\M_y\\\\M_z\\end{bmatrix}\n=\n\\begin{bmatrix}\n-\\frac{M_x}{T_2} \\\\\n-\\frac{M_y}{T_2} \\\\\n\\frac{M_0 - M_z}{T_1}\n\\end{bmatrix}.\n$$\nUnder a radiofrequency pulse modeled as a hard pulse about the $x$-axis with flip angle $\\alpha$ (in degrees), the magnetization is instantaneously rotated by the rotation matrix $R_x(\\alpha)$:\n$$\nR_x(\\alpha) =\n\\begin{bmatrix}\n1 & 0 & 0\\\\\n0 & \\cos(\\alpha_\\mathrm{rad}) & -\\sin(\\alpha_\\mathrm{rad})\\\\\n0 & \\sin(\\alpha_\\mathrm{rad}) & \\cos(\\alpha_\\mathrm{rad})\n\\end{bmatrix},\n\\quad\n\\alpha_\\mathrm{rad} = \\alpha \\cdot \\frac{\\pi}{180}.\n$$\n\nYour program must:\n- Start from the initial condition $\\mathbf{M}(0^-) = [0,0,M_0]^\\top$ for each species.\n- Apply a nonselective inversion pulse modeled as a rotation by flip angle $\\alpha_\\mathrm{inv}$ (in degrees) about the $x$-axis to obtain $\\mathbf{M}(0^+)$.\n- Numerically integrate the Bloch equations during the inversion time $TI$ (in milliseconds) with no applied field by a forward Euler discretization with a fixed time step $\\Delta t$ (in milliseconds) satisfying $\\Delta t = 0.1\\,\\mathrm{ms}$, to obtain $\\mathbf{M}(TI^-)$.\n- Apply a slice-selective excitation pulse modeled as a rotation by flip angle $\\alpha_\\mathrm{exc}$ (in degrees) about the $x$-axis to obtain $\\mathbf{M}(TI^+)$.\n- Model the TSE readout as producing the first spin echo at time $TE$ (in milliseconds) after the excitation, assuming perfect $180^\\circ$ refocusing pulses and negligible diffusion and off-resonance, so that the transverse magnetization magnitude decays as $\\exp(-TE/T_2)$. The echo amplitude for a species is then defined as\n$$\nS = \\left\\|\\begin{bmatrix}M_x(TI^+)\\\\ M_y(TI^+)\\end{bmatrix}\\right\\| \\cdot \\exp\\!\\left(-\\frac{TE}{T_2}\\right).\n$$\n\nTo explore fat suppression, consider two species: a \"fat-like\" species and a \"water-like\" species, each with its own $T_1$, $T_2$, and $M_0$ but experiencing the same radiofrequency pulses and timing. The radiofrequency flip angles may be scaled by a dimensionless transmit sensitivity factor $b$ such that the effective applied flip angles are $b \\cdot \\alpha_\\mathrm{inv}$ and $b \\cdot \\alpha_\\mathrm{exc}$.\n\nYour task is to implement this model and compute, for a small test suite of cases, the ratio $r = S_\\mathrm{fat}/S_\\mathrm{water}$, where $S_\\mathrm{fat}$ and $S_\\mathrm{water}$ are the echo amplitudes of the fat-like and water-like species, respectively. Express all times in milliseconds, angles in degrees, and output the ratios as unitless floating-point numbers.\n\nTest suite:\n- Species parameters (used for all test cases):\n  - Fat-like: $T_{1,\\mathrm{fat}} = 250\\,\\mathrm{ms}$, $T_{2,\\mathrm{fat}} = 80\\,\\mathrm{ms}$, $M_{0,\\mathrm{fat}} = 1.0$.\n  - Water-like: $T_{1,\\mathrm{water}} = 1000\\,\\mathrm{ms}$, $T_{2,\\mathrm{water}} = 100\\,\\mathrm{ms}$, $M_{0,\\mathrm{water}} = 1.0$.\n- Case $1$ (happy path near fat null): $TI = 175\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $2$ (boundary with $TI$ very short): $TI = 0\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $3$ (edge case with transmit under-flip): $TI = 175\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 0.9$.\n- Case $4$ (long inversion time): $TI = 1000\\,\\mathrm{ms}$, $TE = 10\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n- Case $5$ (increased $TE$ to probe $T_2$ weighting): $TI = 175\\,\\mathrm{ms}$, $TE = 80\\,\\mathrm{ms}$, $\\alpha_\\mathrm{inv} = 180^\\circ$, $\\alpha_\\mathrm{exc} = 90^\\circ$, $b = 1.0$.\n\nFinal output format:\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, in the order of the cases $1$ through $5$, where each entry is the floating-point ratio $r = S_\\mathrm{fat}/S_\\mathrm{water}$ for that case. For example, an output of the correct format is $[r_1,r_2,r_3,r_4,r_5]$ with each $r_i$ a float.",
            "solution": "The problem requires the modeling of a Short Tau Inversion Recovery (STIR) pulse sequence followed by a Turbo Spin Echo (TSE) readout to determine the signal ratio between fat-like and water-like tissue. The solution is derived by simulating the behavior of the magnetization vector, $\\mathbf{M}(t)$, for each species according to the Bloch equations, subjected to a sequence of radiofrequency (RF) pulses and relaxation periods.\n\nThe simulation process for a single species (characterized by $T_1$, $T_2$, and $M_0$) is as follows:\n\n1.  **Initial State**: At time $t=0^-$, before any RF pulses are applied, the system is in thermal equilibrium. The magnetization vector is aligned with the main magnetic field (conventionally the $z$-axis), with no transverse components.\n    $$\n    \\mathbf{M}(0^-) = \\begin{bmatrix} 0 \\\\ 0 \\\\ M_0 \\end{bmatrix}\n    $$\n\n2.  **Inversion Pulse**: At $t=0$, a nonselective inversion pulse is applied. This is modeled as an instantaneous rotation of the magnetization vector around the $x$-axis of the rotating frame. The flip angle, $\\alpha_\\mathrm{inv}$, is scaled by the transmit sensitivity factor $b$. The effective flip angle in radians is $\\alpha'_\\mathrm{inv} = (b \\cdot \\alpha_\\mathrm{inv}) \\cdot (\\pi/180)$. The magnetization state immediately after the pulse, $\\mathbf{M}(0^+)$, is calculated by applying the rotation matrix $R_x(\\alpha'_\\mathrm{inv})$:\n    $$\n    \\mathbf{M}(0^+) = R_x(\\alpha'_\\mathrm{inv}) \\mathbf{M}(0^-) =\n    \\begin{bmatrix}\n    1 & 0 & 0 \\\\\n    0 & \\cos(\\alpha'_\\mathrm{inv}) & -\\sin(\\alpha'_\\mathrm{inv}) \\\\\n    0 & \\sin(\\alpha'_\\mathrm{inv}) & \\cos(\\alpha'_\\mathrm{inv})\n    \\end{bmatrix}\n    \\begin{bmatrix} 0 \\\\ 0 \\\\ M_0 \\end{bmatrix}\n    =\n    \\begin{bmatrix} 0 \\\\ -M_0 \\sin(\\alpha'_\\mathrm{inv}) \\\\ M_0 \\cos(\\alpha'_\\mathrm{inv}) \\end{bmatrix}\n    $$\n    For an ideal inversion pulse, $\\alpha_\\mathrm{inv}=180^\\circ$ and $b=1$, so $\\alpha'_\\mathrm{inv}=\\pi$, and $\\mathbf{M}(0^+) = [0, 0, -M_0]^\\top$.\n\n3.  **Free Relaxation during Inversion Time ($TI$)**: For the duration of the inversion time, from $t=0^+$ to $t=TI^-$, the magnetization evolves according to the Bloch equations without any applied RF field. The problem specifies a numerical integration using the forward Euler method with a time step of $\\Delta t = 0.1 \\, \\mathrm{ms}$. The discretized equations for a single time step are:\n    $$\n    M_x(t+\\Delta t) = M_x(t) \\left(1 - \\frac{\\Delta t}{T_2}\\right)\n    $$\n    $$\n    M_y(t+\\Delta t) = M_y(t) \\left(1 - \\frac{\\Delta t}{T_2}\\right)\n    $$\n    $$\n    M_z(t+\\Delta t) = M_z(t) \\left(1 - \\frac{\\Delta t}{T_1}\\right) + \\frac{M_0 \\Delta t}{T_1}\n    $$\n    This iterative update is applied $N = \\text{int}(TI / \\Delta t)$ times, starting from the initial state $\\mathbf{M}(0^+)$, to compute the final state at the end of the inversion period, $\\mathbf{M}(TI^-)$.\n\n4.  **Excitation Pulse**: At $t=TI$, a slice-selective excitation pulse is applied. This is also modeled as an instantaneous rotation about the $x$-axis. The effective flip angle in radians is $\\alpha'_\\mathrm{exc} = (b \\cdot \\alpha_\\mathrm{exc}) \\cdot (\\pi/180)$. The magnetization state after the excitation pulse, $\\mathbf{M}(TI^+)$, is:\n    $$\n    \\mathbf{M}(TI^+) = R_x(\\alpha'_\\mathrm{exc}) \\mathbf{M}(TI^-) =\n    \\begin{bmatrix}\n    1 & 0 & 0 \\\\\n    0 & \\cos(\\alpha'_\\mathrm{exc}) & -\\sin(\\alpha'_\\mathrm{exc}) \\\\\n    0 & \\sin(\\alpha'_\\mathrm{exc}) & \\cos(\\alpha'_\\mathrm{exc})\n    \\end{bmatrix}\n    \\begin{bmatrix} M_x(TI^-) \\\\ M_y(TI^-) \\\\ M_z(TI^-) \\end{bmatrix}\n    $$\n\n5.  **Echo Signal Calculation**: The TSE readout generates a spin echo at an echo time $TE$ after the excitation pulse. The model assumes perfect refocusing, so the signal amplitude is determined by the magnitude of the transverse magnetization immediately after excitation, $\\left\\| \\mathbf{M}_{xy}(TI^+) \\right\\|$, which then decays due to $T_2$ relaxation over the time $TE$. The echo amplitude, $S$, is given by:\n    $$\n    S = \\left\\| \\begin{bmatrix} M_x(TI^+) \\\\ M_y(TI^+) \\end{bmatrix} \\right\\| \\cdot \\exp\\left(-\\frac{TE}{T_2}\\right) = \\sqrt{M_x(TI^+)^2 + M_y(TI^+)^2} \\cdot \\exp\\left(-\\frac{TE}{T_2}\\right)\n    $$\n\nTo solve the problem, this entire procedure is executed twice for each test case: once using the parameters for the fat-like species ($T_{1,\\mathrm{fat}}, T_{2,\\mathrm{fat}}, M_{0,\\mathrm{fat}}$) to calculate $S_\\mathrm{fat}$, and once using the parameters for the water-like species ($T_{1,\\mathrm{water}}, T_{2,\\mathrm{water}}, M_{0,\\mathrm{water}}$) to calculate $S_\\mathrm{water}$. The final result for each case is the ratio $r = S_\\mathrm{fat} / S_\\mathrm{water}$.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Models a STIR-TSE sequence and computes the fat-to-water signal ratio for a suite of test cases.\n    \"\"\"\n    \n    # Species parameters (fixed for all test cases)\n    species_params = {\n        'fat': {'T1': 250.0, 'T2': 80.0, 'M0': 1.0},\n        'water': {'T1': 1000.0, 'T2': 100.0, 'M0': 1.0}\n    }\n    \n    # Test cases\n    test_cases = [\n        {'TI': 175.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0}, # Case 1\n        {'TI': 0.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0},   # Case 2\n        {'TI': 175.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 0.9}, # Case 3\n        {'TI': 1000.0, 'TE': 10.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0},# Case 4\n        {'TI': 175.0, 'TE': 80.0, 'alpha_inv': 180.0, 'alpha_exc': 90.0, 'b': 1.0}, # Case 5\n    ]\n\n    dt = 0.1  # Time step in milliseconds for numerical integration\n\n    def compute_signal(species_props, seq_params):\n        \"\"\"\n        Computes the echo signal for a single species given sequence parameters.\n        \"\"\"\n        T1, T2, M0 = species_props['T1'], species_props['T2'], species_props['M0']\n        TI, TE = seq_params['TI'], seq_params['TE']\n        alpha_inv_deg, alpha_exc_deg = seq_params['alpha_inv'], seq_params['alpha_exc']\n        b = seq_params['b']\n\n        # Step 1: Initial state\n        M = np.array([0.0, 0.0, M0])\n\n        # Step 2: Inversion pulse\n        alpha_inv_rad = b * alpha_inv_deg * np.pi / 180.0\n        cos_a_inv = np.cos(alpha_inv_rad)\n        sin_a_inv = np.sin(alpha_inv_rad)\n        Rx_inv = np.array([\n            [1, 0, 0],\n            [0, cos_a_inv, -sin_a_inv],\n            [0, sin_a_inv, cos_a_inv]\n        ])\n        M = Rx_inv @ M\n\n        # Step 3: Free relaxation during inversion time (TI)\n        num_steps = int(TI / dt)\n        if num_steps > 0:\n            # Pre-calculate factors for Euler integration\n            e1 = dt / T1\n            e2 = dt / T2\n            c1z = 1.0 - e1\n            c2z = e1 * M0\n            c_xy = 1.0 - e2\n\n            for _ in range(num_steps):\n                M[0] *= c_xy\n                M[1] *= c_xy\n                M[2] = M[2] * c1z + c2z\n\n        # Step 4: Excitation pulse\n        alpha_exc_rad = b * alpha_exc_deg * np.pi / 180.0\n        cos_a_exc = np.cos(alpha_exc_rad)\n        sin_a_exc = np.sin(alpha_exc_rad)\n        Rx_exc = np.array([\n            [1, 0, 0],\n            [0, cos_a_exc, -sin_a_exc],\n            [0, sin_a_exc, cos_a_exc]\n        ])\n        M = Rx_exc @ M\n\n        # Step 5: Echo signal calculation\n        M_xy = np.sqrt(M[0]**2 + M[1]**2)\n        S = M_xy * np.exp(-TE / T2)\n        \n        return S\n\n    results = []\n    for case in test_cases:\n        S_fat = compute_signal(species_params['fat'], case)\n        S_water = compute_signal(species_params['water'], case)\n        \n        if S_water != 0:\n            ratio = S_fat / S_water\n        else:\n            # Handle the case of zero water signal to avoid division by zero.\n            # In practice, with noise, this would be a large, poorly-defined number.\n            # For this simulation, if fat signal is also zero, ratio is NaN (becomes 0/0), \n            # otherwise it's infinity. We can cap it or represent as a large number\n            # but given the physics, if S_water is 0, S_fat will be non-zero,\n            # so the ratio is effectively infinite. Let's use numpy's representation.\n            ratio = np.inf if S_fat > 0 else 0.0\n\n        results.append(ratio)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(f'{r:.6f}' for r in results)}]\")\n\nsolve()\n```"
        }
    ]
}