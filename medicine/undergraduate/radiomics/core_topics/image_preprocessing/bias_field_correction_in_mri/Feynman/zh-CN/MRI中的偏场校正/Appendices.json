{
    "hands_on_practices": [
        {
            "introduction": "许多先进的偏置场校正算法（如N4ITK）都基于清晰的数学模型。本练习将通过一个可管理的、一维的计算任务来揭开其神秘面纱，让您亲手实践核心步骤。我们将学习如何利用B样条基函数和最小二乘法来估计平滑的偏置场，这正是这些先进工具背后的核心思想。",
            "id": "4531113",
            "problem": "在放射组学中，磁共振成像 (MRI) 的强度不均匀性通常被建模为一个乘性的、缓慢变化的偏置场。考虑乘性模型 $I_{\\text{obs}}(x) = b(x)\\, I_{\\text{true}}(x) + n(x)$，其中 $I_{\\text{obs}}(x)$ 是空间位置 $x$ 处的观测强度，$I_{\\text{true}}(x)$ 是真实的底层组织强度，$b(x)$ 是一个平滑的乘性偏置场，而 $n(x)$ 是本问题中我们将忽略的噪声。在用于放射组学强度标准化的均匀白质感兴趣区域内，通常假设 $I_{\\text{true}}(x) \\approx I_{\\text{ref}}$ 在空间上是恒定的。取自然对数可得到对数偏置的加性模型：$y(x) \\equiv \\ln I_{\\text{obs}}(x) - \\ln I_{\\text{ref}} \\approx \\ln b(x)$。使用 Insight Toolkit (N4ITK) 的非参数非均匀强度归一化方法用一个低频 B 样条基来表示 $\\ln b(x)$，并通过在掩模上最小化一个合适的数据保真度目标函数来估计其系数。\n\n考虑一个白质区域内沿单根成像轴的一维剖面，其位置为 $x \\in \\{0, 1, 2, 3\\}$（单位为任意空间单位），其中 $I_{\\text{ref}} = 100$。假设观测强度为 $I_{\\text{obs}}(0) = 100$，$I_{\\text{obs}}(1) = 100\\,\\exp(0.02)$，$I_{\\text{obs}}(2) = 100\\,\\exp(0.04)$ 以及 $I_{\\text{obs}}(3) = 100\\,\\exp(0.06)$。在 N4ITK 的单个粗网格步骤中，用一个在 $x=0$ 和 $x=3$ 处有两个控制点的线性 B 样条展开来近似 $[0,3]$ 上的 $\\ln b(x)$，其基函数为\n- $B_{1}(x) = 1 - \\frac{x}{3}$ 在 $[0,3]$ 上，其他情况下 $B_{1}(x) = 0$，\n- $B_{2}(x) = \\frac{x}{3}$ 在 $[0,3]$ 上，其他情况下 $B_{2}(x) = 0$。\n假设保真度项中所有四个样本的权重均为单位权重。\n\n从乘性模型及其对数变换开始，建立 B 样条系数的最小二乘估计，并进行推导以计算在 $x_{0} = 1.5$ 处的预测对数偏置。然后，返回到乘性尺度，以获得这个粗略 N4ITK 步骤将产生的估计偏置值 $\\hat{b}(x_{0})$。\n\n$\\hat{b}(1.5)$ 的值是多少？以指数函数的形式给出您的最终答案的精确表达式。将结果报告为无量纲量；不要四舍五入。",
            "solution": "用户希望使用 N4ITK 偏置场校正算法的简化一维模型，确定在特定点 $x_0 = 1.5$ 处的估计偏置场值 $\\hat{b}(x_0)$。\n\n问题从观测 MRI 强度的乘性模型开始：\n$$I_{\\text{obs}}(x) = b(x)\\, I_{\\text{true}}(x) + n(x)$$\n忽略噪声项 $n(x)$ 并假设在均匀区域内真实强度恒定 $I_{\\text{true}}(x) \\approx I_{\\text{ref}}$，模型简化为：\n$$I_{\\text{obs}}(x) \\approx b(x)\\, I_{\\text{ref}}$$\n对该方程取自然对数，得到对数偏置 $\\ln b(x)$ 的加性模型：\n$$\\ln(I_{\\text{obs}}(x)) \\approx \\ln(b(x)) + \\ln(I_{\\text{ref}})$$\n我们将被拟合的量 $y(x)$ 定义为观测到的对数偏置：\n$$y(x) \\equiv \\ln(I_{\\text{obs}}(x)) - \\ln(I_{\\text{ref}}) \\approx \\ln(b(x))$$\n问题提供了以下数据：\n- 样本点：$x \\in \\{0, 1, 2, 3\\}$。\n- 参考强度：$I_{\\text{ref}} = 100$。\n- 观测强度：\n  - $I_{\\text{obs}}(0) = 100$\n  - $I_{\\text{obs}}(1) = 100\\,\\exp(0.02)$\n  - $I_{\\text{obs}}(2) = 100\\,\\exp(0.04)$\n  - $I_{\\text{obs}}(3) = 100\\,\\exp(0.06)$\n\n首先，我们计算每个样本点处的观测对数偏置值 $y(x)$：\n- $y(0) = \\ln(I_{\\text{obs}}(0)) - \\ln(100) = \\ln(100) - \\ln(100) = 0$。\n- $y(1) = \\ln(I_{\\text{obs}}(1)) - \\ln(100) = \\ln(100\\,\\exp(0.02)) - \\ln(100) = \\ln(100) + 0.02 - \\ln(100) = 0.02$。\n- $y(2) = \\ln(I_{\\text{obs}}(2)) - \\ln(100) = \\ln(100\\,\\exp(0.04)) - \\ln(100) = \\ln(100) + 0.04 - \\ln(100) = 0.04$。\n- $y(3) = \\ln(I_{\\text{obs}}(3)) - \\ln(100) = \\ln(100\\,\\exp(0.06)) - \\ln(100) = \\ln(100) + 0.06 - \\ln(100) = 0.06$。\n\n对数偏置场 $\\ln b(x)$ 由两个基函数 $B_1(x) = 1 - \\frac{x}{3}$ 和 $B_2(x) = \\frac{x}{3}$ 的线性组合来近似：\n$$\\ln \\hat{b}(x) = c_1 B_1(x) + c_2 B_2(x)$$\n我们需要找到系数 $c_1$ 和 $c_2$，以最小化模型 $\\ln \\hat{b}(x_i)$ 和观测数据 $y(x_i)$ 之间的平方差之和。目标函数为：\n$$J(c_1, c_2) = \\sum_{i=0}^{3} (y(x_i) - (c_1 B_1(x_i) + c_2 B_2(x_i)))^2$$\n这是一个线性最小二乘问题，可以写成矩阵形式 $\\mathbf{A}\\mathbf{c} \\approx \\mathbf{y}$。解 $\\hat{\\mathbf{c}}$ 可以通过求解正规方程 $(\\mathbf{A}^T \\mathbf{A}) \\hat{\\mathbf{c}} = \\mathbf{A}^T \\mathbf{y}$ 得到。\n\n观测向量 $\\mathbf{y}$ 是：\n$$\\mathbf{y} = \\begin{pmatrix} 0 \\\\ 0.02 \\\\ 0.04 \\\\ 0.06 \\end{pmatrix}$$\n设计矩阵 $\\mathbf{A}$ 是通过在每个样本点 $x_i$ 处计算基函数的值来构建的：\n- $B_1(0) = 1$, $B_2(0) = 0$\n- $B_1(1) = 1 - 1/3 = 2/3$, $B_2(1) = 1/3$\n- $B_1(2) = 1 - 2/3 = 1/3$, $B_2(2) = 2/3$\n- $B_1(3) = 1 - 3/3 = 0$, $B_2(3) = 3/3 = 1$\n$$\\mathbf{A} = \\begin{pmatrix} B_1(0)  B_2(0) \\\\ B_1(1)  B_2(1) \\\\ B_1(2)  B_2(2) \\\\ B_1(3)  B_2(3) \\end{pmatrix} = \\begin{pmatrix} 1  0 \\\\ 2/3  1/3 \\\\ 1/3  2/3 \\\\ 0  1 \\end{pmatrix}$$\n待确定的系数向量是 $\\mathbf{c} = \\begin{pmatrix} c_1 \\\\ c_2 \\end{pmatrix}$。\n\n接下来，我们计算 $\\mathbf{A}^T \\mathbf{A}$ 和 $\\mathbf{A}^T \\mathbf{y}$：\n$$\\mathbf{A}^T \\mathbf{A} = \\begin{pmatrix} 1  2/3  1/3  0 \\\\ 0  1/3  2/3  1 \\end{pmatrix} \\begin{pmatrix} 1  0 \\\\ 2/3  1/3 \\\\ 1/3  2/3 \\\\ 0  1 \\end{pmatrix} = \\begin{pmatrix} 1+\\frac{4}{9}+\\frac{1}{9}  \\frac{2}{9}+\\frac{2}{9} \\\\ \\frac{2}{9}+\\frac{2}{9}  \\frac{1}{9}+\\frac{4}{9}+1 \\end{pmatrix} = \\begin{pmatrix} \\frac{14}{9}  \\frac{4}{9} \\\\ \\frac{4}{9}  \\frac{14}{9} \\end{pmatrix}$$\n$$\\mathbf{A}^T \\mathbf{y} = \\begin{pmatrix} 1  2/3  1/3  0 \\\\ 0  1/3  2/3  1 \\end{pmatrix} \\begin{pmatrix} 0 \\\\ 0.02 \\\\ 0.04 \\\\ 0.06 \\end{pmatrix} = \\begin{pmatrix} 0 \\cdot 1 + (2/3)(0.02) + (1/3)(0.04) + 0 \\cdot 0.06 \\\\ 0 \\cdot 0 + (1/3)(0.02) + (2/3)(0.04) + 1 \\cdot 0.06 \\end{pmatrix} = \\begin{pmatrix} \\frac{0.04}{3} + \\frac{0.04}{3} \\\\ \\frac{0.02}{3} + \\frac{0.08}{3} + \\frac{0.18}{3} \\end{pmatrix} = \\begin{pmatrix} \\frac{0.08}{3} \\\\ \\frac{0.28}{3} \\end{pmatrix}$$\n现在我们求解方程组 $(\\mathbf{A}^T \\mathbf{A}) \\mathbf{c} = \\mathbf{A}^T \\mathbf{y}$。我们求 $\\mathbf{A}^T \\mathbf{A}$ 的逆矩阵：\n$$\\det(\\mathbf{A}^T \\mathbf{A}) = \\left(\\frac{14}{9}\\right)^2 - \\left(\\frac{4}{9}\\right)^2 = \\frac{196 - 16}{81} = \\frac{180}{81}$$\n$$(\\mathbf{A}^T \\mathbf{A})^{-1} = \\frac{81}{180} \\begin{pmatrix} \\frac{14}{9}  -\\frac{4}{9} \\\\ -\\frac{4}{9}  \\frac{14}{9} \\end{pmatrix} = \\frac{9}{20} \\begin{pmatrix} \\frac{14}{9}  -\\frac{4}{9} \\\\ -\\frac{4}{9}  \\frac{14}{9} \\end{pmatrix} = \\frac{1}{20} \\begin{pmatrix} 14  -4 \\\\ -4  14 \\end{pmatrix}$$\n系数向量是 $\\mathbf{c} = (\\mathbf{A}^T \\mathbf{A})^{-1} (\\mathbf{A}^T \\mathbf{y})$：\n$$\\mathbf{c} = \\frac{1}{20} \\begin{pmatrix} 14  -4 \\\\ -4  14 \\end{pmatrix} \\begin{pmatrix} \\frac{0.08}{3} \\\\ \\frac{0.28}{3} \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 14(0.08) - 4(0.28) \\\\ -4(0.08) + 14(0.28) \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 1.12 - 1.12 \\\\ -0.32 + 3.92 \\end{pmatrix} = \\frac{1}{60} \\begin{pmatrix} 0 \\\\ 3.6 \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ 0.06 \\end{pmatrix}$$\n因此，我们求得系数为 $c_1 = 0$ 和 $c_2 = 0.06$。\n\n估计的对数偏置场为：\n$$\\ln \\hat{b}(x) = 0 \\cdot \\left(1 - \\frac{x}{3}\\right) + 0.06 \\cdot \\left(\\frac{x}{3}\\right) = 0.02x$$\n注意，观测到的对数偏置数据 $y(x_i)$ 完全位于直线 $y=0.02x$ 上。由于该函数位于基函数张成的空间内，因此最小二乘拟合是精确的，平方误差之和为零。\n\n问题要求在 $x_0 = 1.5$ 处的估计偏置值 $\\hat{b}(x_0)$。首先，我们计算在该点的估计对数偏置：\n$$\\ln \\hat{b}(1.5) = 0.02 \\times 1.5 = 0.03$$\n最后，我们对这个结果取指数，以找到乘性尺度上的偏置场值：\n$$\\hat{b}(1.5) = \\exp(\\ln \\hat{b}(1.5)) = \\exp(0.03)$$\n这是一个无量纲的量，符合要求。",
            "answer": "$$\\boxed{\\exp(0.03)}$$"
        },
        {
            "introduction": "在应用了校正算法之后，我们如何证明它确实有效？本练习将我们的关注点从算法的“如何做”转移到其“效果如何”。我们将运用基础的统计工具——配对t检验，来严格评估偏置场校正是否在放射组学特征的可重复性上带来了统计学上的显著提升，而这正是定量医学影像分析的一个关键目标。",
            "id": "4531093",
            "problem": "考虑磁共振成像 (MRI)，其中在扫描 $j$ 中空间位置 $\\mathbf{x}$ 处观测到的强度可以表示为 $I_{j}(\\mathbf{x}) = B_{j}(\\mathbf{x})\\,S(\\mathbf{x}) + \\varepsilon_{j}(\\mathbf{x})$，其中 $B_{j}(\\mathbf{x})$ 表示一个平滑的乘性偏置场，$S(\\mathbf{x})$ 是真实的底层信号，而 $\\varepsilon_{j}(\\mathbf{x})$ 是随机噪声。在影像组学中，一个标量特征 $F$ 是图像强度分布的确定性泛函；对于一个固定的受试者 $i$ 和扫描 $r \\in \\{1,2\\}$，将在偏置场校正前的特征表示为 $F_{i,r}^{\\text{pre}}$，校正后的特征表示为 $F_{i,r}^{\\text{post}}$。一种校正方法旨在减少由 $B_{j}(\\mathbf{x})$ 引入的伪差，从而使特征 $F$ 在重复扫描中更具可复现性。\n\n假设对每位受试者 $i$ 进行测试-重测采集，得到两个校正前的特征测量值 $F_{i,1}^{\\text{pre}}$ 和 $F_{i,2}^{\\text{pre}}$，以及两个校正后的测量值 $F_{i,1}^{\\text{post}}$ 和 $F_{i,2}^{\\text{post}}$。将每位受试者的绝对测试-重测误差定义为 $e_{i}^{\\text{pre}} = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert$ 和 $e_{i}^{\\text{post}} = \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。令配对差异为 $d_{i} = e_{i}^{\\text{pre}} - e_{i}^{\\text{post}}$。我们感兴趣的假设是单侧检验 $H_{0}: \\mu_{d} = 0$ 对比 $H_{1}: \\mu_{d} > 0$，其中 $\\mu_{d}$ 是 $d_{i}$ 的总体均值。在受试者相互独立且标准化均值差异的抽样分布近似服从学生t分布的假设下，计算观测到的配对差异的单侧p值，并判断在显著性水平 $\\alpha = 0.05$ 下，偏置场校正后可复现性的改善是否具有统计显著性。\n\n你的程序必须：\n- 对于每个测试用例，计算 $e_{i}^{\\text{pre}}$、$e_{i}^{\\text{post}}$、配对差异 $d_{i}$、针对 $H_{1}: \\mu_{d} > 0$ 的单侧p值，并输出一个决策整数，其中 $1$ 表示在 $\\alpha = 0.05$ 时拒绝 $H_{0}$，$0$ 表示未能拒绝 $H_{0}$。\n- 如果 $d_{i}$ 的样本标准差为零或样本量小于 $2$，则将p值定义为 $1.0$，决策定义为 $0$。\n- 将每个p值四舍五入到六位小数。\n\n测试套件（每个用例列出每位受试者的配对数据；配对数据是单个影像组学特征在校正前和校正后的两次测量值）：\n\n- 用例 1 (普遍改善, 10 位受试者):\n  受试者 1: 校正前 (100, 110), 校正后 (100, 102)。\n  受试者 2: 校正前 (95, 85), 校正后 (95, 96)。\n  受试者 3: 校正前 (120, 130), 校正后 (120, 119)。\n  受试者 4: 校正前 (80, 92), 校正后 (80, 81)。\n  受试者 5: 校正前 (60, 72), 校正后 (60, 63)。\n  受试者 6: 校正前 (105, 99), 校正后 (105, 104)。\n  受试者 7: 校正前 (140, 150), 校正后 (140, 142)。\n  受试者 8: 校正前 (77, 88), 校正后 (77, 78)。\n  受试者 9: 校正前 (90, 104), 校正后 (90, 92)。\n  受试者 10: 校正前 (112, 100), 校正后 (112, 111)。\n\n- 用例 2 (没有改善, 误差相同, 4 位受试者):\n  受试者 1: 校正前 (100, 105), 校正后 (100, 105)。\n  受试者 2: 校正前 (95, 100), 校正后 (95, 100)。\n  受试者 3: 校正前 (120, 115), 校正后 (120, 115)。\n  受试者 4: 校正前 (80, 85), 校正后 (80, 85)。\n\n- 用例 3 (小样本, 混合效应, 3 位受试者):\n  受试者 1: 校正前 (90, 98), 校正后 (90, 95)。\n  受试者 2: 校正前 (110, 117), 校正后 (110, 117)。\n  受试者 3: 校正前 (70, 76), 校正后 (70, 74)。\n\n- 用例 4 (校正后更差, 5 位受试者):\n  受试者 1: 校正前 (100, 102), 校正后 (100, 104)。\n  受试者 2: 校正前 (95, 96), 校正后 (95, 98)。\n  受试者 3: 校正前 (120, 123), 校正后 (120, 126)。\n  受试者 4: 校正前 (80, 82), 校正后 (80, 82)。\n  受试者 5: 校正前 (60, 61), 校正后 (60, 65)。\n\n最终输出格式：\n你的程序应生成一行输出，其中包含四个用例的结果列表，每个用例的结果是一个包含两个元素的列表 $[p, d]$，其中 $p$ 是四舍五入到六位小数的单侧p值，$d$ 是决策整数（$1$ 或 $0$）。例如，输出必须采用 $[[p_{1},d_{1}],[p_{2},d_{2}],[p_{3},d_{3}],[p_{4},d_{4}]]$ 的形式，不含任何额外文本。",
            "solution": "该问题要求对磁共振成像（MRI）影像组学中偏置场校正算法的有效性进行统计评估。具体来说，我们需要确定校正方法是否能使影像组学特征 $F$ 的可复现性得到统计上显著的改善。这种改善通过绝对测试-重测误差的减少来量化。这将通过对一组受试者在校正前和校正后测量的测试-重测误差执行单侧配对学生t检验来完成。\n\n问题的核心在于假设检验。对于每位受试者 $i$，我们都获得了配对数据：一对校正前的测试-重测测量值 $(F_{i,1}^{\\text{pre}}, F_{i,2}^{\\text{pre}})$ 和一对校正后的测量值 $(F_{i,1}^{\\text{post}}, F_{i,2}^{\\text{post}})$。受试者 $i$ 在校正前的绝对测试-重测误差定义为 $e_{i}^{\\text{pre}} = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert$，校正后的定义为 $e_{i}^{\\text{post}} = \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。\n\n为了评估改善情况，我们考虑每位受试者的配对差异 $d_{i} = e_{i}^{\\text{pre}} - e_{i}^{\\text{post}}$。$d_{i}$ 的正值表示受试者 $i$ 在校正后的测试-重测误差减小了，这表明可复现性得到了改善。目标是检验这种改善在总体中是否是系统性的，而不仅仅是随机偶然的结果。\n\n统计假设是针对这些差异的总体均值 $\\mu_{d}$ 来构建的：\n- 原假设 ($H_{0}$): $\\mu_{d} = 0$。该假设指出，平均而言，校正前和校正后的误差没有差异。观察到的差异是由于随机抽样变异性造成的。\n- 备择假设 ($H_{1}$): $\\mu_{d} > 0$。该假设主张，偏置场校正系统性地减少了测试-重测误差，从而导致正的均值差异。\n\n这是一个单侧（右尾）检验，因为我们特别感兴趣的是校正是否*改善*了可复现性（即减少了误差）。问题指出，标准化均值差异服从学生t分布。这是配对t检验的基础。\n\n每个测试用例的步骤如下：\n\n1.  **计算配对差异**：对于一个包含 $n$ 位受试者的样本，计算差异向量 $\\mathbf{d} = [d_1, d_2, \\ldots, d_n]$，其中 $d_i = \\lvert F_{i,1}^{\\text{pre}} - F_{i,2}^{\\text{pre}} \\rvert - \\lvert F_{i,1}^{\\text{post}} - F_{i,2}^{\\text{post}} \\rvert$。\n\n2.  **处理边缘情况**：问题规定，如果样本量 $n < 2$ 或差异的样本标准差为 $0$，则检验无定论。在这些情况下，p值定义为 $1.0$，我们未能拒绝 $H_0$。小于 $2$ 的样本量不允许计算样本标准差。标准差为 $0$ 意味着所有的 $d_i$ 值都相同；如果它们的均值不大于 $0$，就没有证据反对 $H_0$。如果它们的均值大于 $0$ 但 $s_d = 0$，$t$统计量将是无穷大，这是一个有问题的奇点。该规则提供了一种处理这种情况的实用方法。\n\n3.  **计算检验统计量**：如果 $n \\ge 2$ 且样本标准差 $s_d > 0$，我们继续进行。\n    -   计算差异的样本均值：\n        $$ \\bar{d} = \\frac{1}{n} \\sum_{i=1}^{n} d_i $$\n    -   计算差异的样本标准差（使用贝塞尔校正）：\n        $$ s_d = \\sqrt{\\frac{1}{n-1} \\sum_{i=1}^{n} (d_i - \\bar{d})^2} $$\n    -   计算均值差异的标准误：\n        $$ SE(\\bar{d}) = \\frac{s_d}{\\sqrt{n}} $$\n    -   计算 $t$ 统计量，它衡量样本均值 $\\bar{d}$ 与假设均值 $0$ 相差多少个标准误：\n        $$ t = \\frac{\\bar{d} - 0}{SE(\\bar{d})} = \\frac{\\bar{d}}{s_d / \\sqrt{n}} $$\n\n4.  **计算 p 值**：p 值是在原假设为真的前提下，观测到至少与计算出的 $t$ 统计量一样极端的统计量的概率。对于我们的右尾检验，这对应于自由度为 $\\nu = n-1$ 的学生t分布的概率密度函数下，位于我们计算的 $t$ 统计量右侧的面积。\n    $$ p = P(T_{\\nu} \\ge t) $$\n    这可以使用 $t$ 分布的生存函数（1 减去累积分布函数）来计算。然后将 p 值四舍五入到六位小数。\n\n5.  **做出决策**：将 p 值与给定的显著性水平 $\\alpha = 0.05$ 进行比较。\n    -   如果 $p \\le \\alpha$，我们拒绝原假设 $H_0$。这表明观察到的误差减少是统计显著的。决策用整数 $1$ 表示。\n    -   如果 $p > \\alpha$，我们未能拒绝原假设 $H_0$。没有足够的证据得出校正方法能提高可复现性的结论。决策用整数 $0$ 表示。\n\n每个用例的最终输出是一个包含两个元素的列表，其中包括四舍五入后的 p 值和整数决策。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import t\n\ndef solve():\n    \"\"\"\n    Computes one-sided p-values and decisions for a paired t-test\n    on radiomics feature reproducibility improvement.\n    \"\"\"\n    # Test suite data as provided in the problem statement.\n    test_cases = [\n        # Case 1\n        [\n            {'pre': (100, 110), 'post': (100, 102)},\n            {'pre': (95, 85), 'post': (95, 96)},\n            {'pre': (120, 130), 'post': (120, 119)},\n            {'pre': (80, 92), 'post': (80, 81)},\n            {'pre': (60, 72), 'post': (60, 63)},\n            {'pre': (105, 99), 'post': (105, 104)},\n            {'pre': (140, 150), 'post': (140, 142)},\n            {'pre': (77, 88), 'post': (77, 78)},\n            {'pre': (90, 104), 'post': (90, 92)},\n            {'pre': (112, 100), 'post': (112, 111)},\n        ],\n        # Case 2\n        [\n            {'pre': (100, 105), 'post': (100, 105)},\n            {'pre': (95, 100), 'post': (95, 100)},\n            {'pre': (120, 115), 'post': (120, 115)},\n            {'pre': (80, 85), 'post': (80, 85)},\n        ],\n        # Case 3\n        [\n            {'pre': (90, 98), 'post': (90, 95)},\n            {'pre': (110, 117), 'post': (110, 117)},\n            {'pre': (70, 76), 'post': (70, 74)},\n        ],\n        # Case 4\n        [\n            {'pre': (100, 102), 'post': (100, 104)},\n            {'pre': (95, 96), 'post': (95, 98)},\n            {'pre': (120, 123), 'post': (120, 126)},\n            {'pre': (80, 82), 'post': (80, 82)},\n            {'pre': (60, 61), 'post': (60, 65)},\n        ]\n    ]\n\n    results = []\n    alpha = 0.05\n    rounding_digits = 6\n\n    for case_data in test_cases:\n        # Calculate paired differences d_i for each subject\n        differences = []\n        for subject_data in case_data:\n            e_pre = abs(subject_data['pre'][0] - subject_data['pre'][1])\n            e_post = abs(subject_data['post'][0] - subject_data['post'][1])\n            d_i = e_pre - e_post\n            differences.append(d_i)\n\n        d = np.array(differences)\n        n = len(d)\n\n        # Handle special conditions as per problem statement\n        if n  2:\n            p_value = 1.0\n            decision = 0\n            results.append([round(p_value, rounding_digits), decision])\n            continue\n        \n        s_d = np.std(d, ddof=1) # Sample standard deviation\n\n        if s_d == 0:\n            p_value = 1.0\n            decision = 0\n            results.append([round(p_value, rounding_digits), decision])\n            continue\n\n        # Perform the paired t-test\n        d_bar = np.mean(d)\n        t_statistic = d_bar / (s_d / np.sqrt(n))\n        df = n - 1\n\n        # Calculate one-sided (right-tailed) p-value\n        # p = P(T > t_statistic)\n        p_value = t.sf(t_statistic, df)\n        \n        p_value_rounded = round(p_value, rounding_digits)\n\n        # Make decision based on significance level alpha\n        decision = 1 if p_value_rounded = alpha else 0\n        \n        results.append([p_value_rounded, decision])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "最后的这个练习介绍了一种更复杂的、基于模型的视角，其中偏置场校正不再是一个孤立的预处理步骤。我们将探索期望最大化（EM）算法，用它来同时估计偏置场并执行组织分类。这揭示了医学图像分析中的一个强大原则：联合解决相互耦合的问题可以得到更稳健和准确的结果。",
            "id": "4531103",
            "problem": "在磁共振成像（MRI）放射组学中，低频强度不均匀性（偏置场）会扭曲体素强度，并可能干扰下游的特征提取。在一个小的同质区域内，通常可以将平滑的乘性偏置场近似为一个单一的常数因子。考虑一个针对小块双组织区域的简化生成模型，其中体素$i$处观测到的强度$y_{i}$源于一个潜组织类别$z_{i} \\in \\{1,2\\}$，该类别具有特定类别的均值$\\mu_{k}$和一个全局未知的乘性偏置参数$b0$，并被已知方差$\\sigma^{2}$的零均值高斯噪声所污染。其条件分布为\n$$\np(y_{i} \\mid z_{i}=k, b) = \\frac{1}{\\sqrt{2\\pi}\\,\\sigma}\\,\\exp\\!\\left(-\\frac{(y_{i} - b\\,\\mu_{k})^{2}}{2\\sigma^{2}}\\right).\n$$\n假设混合先验为$p(z_{i}=k) = \\pi_{k}$，且$\\sum_{k=1}^{2}\\pi_{k}=1$。您将执行一次期望最大化（EM）算法的迭代，以联合推斷软分割（后验类别成员资格）并更新偏置参数$b$。\n\n任务：\n1) 从潜变量模型的最大似然原理和完整数据对数似然的定义出发，根据第一性原理推导出在给定固定的类别均值$\\mu_{1}, \\mu_{2}$、已知方差$\\sigma^{2}$和混合权重$\\pi_{1}, \\pi_{2}$的情况下，全局乘性偏置参数$b$的最大化步骤的闭式更新公式。您的推导必须通过构建在当前后验责任下的期望完整数据对数似然，然后对$b$进行优化来进行。\n\n2) 考虑$N=4$个体素，其观测强度分别为$y_{1}=82$、$y_{2}=120$、$y_{3}=78$、$y_{4}=130$。设类别均值为$\\mu_{1}=110$和$\\mu_{2}=80$，标准差为$\\sigma=10$，混合权重为$\\pi_{1}=\\pi_{2}=\\tfrac{1}{2}$。使用$b^{(0)}=1$初始化EM算法。执行期望步骤以计算后验责任\n$$\n\\gamma_{ik} \\equiv p(z_{i}=k \\mid y_{i}, b^{(0)}, \\mu_{1}, \\mu_{2}, \\sigma^{2}, \\pi_{1}, \\pi_{2}),\n$$\n然后使用您推导出的表达式执行最大化步骤，以计算更新后的偏置估计$b^{(1)}$。报告$b^{(1)}$的数值，四舍五入至五位有效数字。最终答案以无单位的纯数字形式表示。",
            "solution": "## 解答\n\n### 任务1：偏置参数$b$的M步更新推导\n\n期望最大化（EM）算法是一种在具有潜变量的统计模型中寻找参数最大似然估计的迭代方法。该算法在两个步骤之间交替进行：期望（E）步，该步骤创建一个函数，用于计算使用当前参数估计评估的对数似然的期望；以及最大化（M）步，该步骤计算使E步中找到的期望对数似然最大化的参数。\n\n设观测数据为$Y = \\{y_1, ..., y_N\\}$，潜数据为$Z = \\{z_1, ..., z_N\\}$。我们引入指示变量$z_{ik}$，使得如果体素$i$属于类别$k$，则$z_{ik}=1$，否则$z_{ik}=0$。完整数据集为$(Y, Z)$。待估计的参数记为$\\theta$。在本问题中，我们唯一更新的参数是$b$，而$\\mu_k$、$\\sigma^2$和$\\pi_k$被视为固定的。\n\n完整数据似然由下式给出：\n$$L_c(\\theta; Y, Z) = p(Y, Z | \\theta) = \\prod_{i=1}^{N} p(y_i, z_i | \\theta) = \\prod_{i=1}^{N} \\prod_{k=1}^{2} [p(y_i|z_i=k, \\theta) p(z_i=k | \\theta)]^{z_{ik}}$$\n完整数据对数似然为：\n$$\\mathcal{L}_c(\\theta; Y, Z) = \\log L_c(\\theta; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ \\log p(y_i|z_i=k, \\theta) + \\log p(z_i=k | \\theta) \\right]$$\n代入给定的分布，其中$\\theta$隐含地包含$b$：\n$$p(y_i|z_i=k, b) = \\mathcal{N}(y_i; b\\mu_k, \\sigma^2)$$\n$$p(z_i=k) = \\pi_k$$\n完整数据对数似然变为：\n$$\\mathcal{L}_c(b; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ \\log\\left(\\frac{1}{\\sqrt{2\\pi}\\sigma}\\exp\\left(-\\frac{(y_i - b\\mu_k)^2}{2\\sigma^2}\\right)\\right) + \\log \\pi_k \\right]$$\n$$\\mathcal{L}_c(b; Y, Z) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} z_{ik} \\left[ -\\frac{1}{2}\\log(2\\pi\\sigma^2) - \\frac{(y_i - b\\mu_k)^2}{2\\sigma^2} + \\log \\pi_k \\right]$$\n\n**E步**：我们计算完整数据对数似然关于潜变量$Z$的后验分布的期望，给定观测数据$Y$和当前参数估计$b^{(t)}$。此函数记为$Q(b | b^{(t)})$。\n$$Q(b | b^{(t)}) = E_{Z|Y, b^{(t)}}[\\mathcal{L}_c(b; Y, Z)]$$\n指示变量$z_{ik}$的期望是后验概率，或称责任（responsibility），$\\gamma_{ik}^{(t)}$：\n$$E[z_{ik}] = p(z_i=k | y_i, b^{(t)}) = \\gamma_{ik}^{(t)}$$\n所以$Q$函数是：\n$$Q(b | b^{(t)}) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\left[ -\\frac{1}{2}\\log(2\\pi\\sigma^2) - \\frac{(y_i - b\\mu_k)^2}{2\\sigma^2} + \\log \\pi_k \\right]$$\n\n**M步**：我们找到使$Q$函数最大化的参数$b$。这给出了更新后的估计$b^{(t+1)}$。\n$$b^{(t+1)} = \\arg\\max_{b} Q(b | b^{(t)})$$\n为了最大化$Q(b | b^{(t)})$关于$b$，我们只需考虑依赖于$b$的项。这等价于最小化以下表达式：\n$$J(b) = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (y_i - b\\mu_k)^2$$\n我们取$J(b)$关于$b$的导数并令其为零：\n$$\\frac{\\partial J(b)}{\\partial b} = \\frac{\\partial}{\\partial b} \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (y_i^2 - 2by_i\\mu_k + b^2\\mu_k^2) = 0$$\n$$\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} (-2y_i\\mu_k + 2b\\mu_k^2) = 0$$\n$$-2\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i\\mu_k + 2b\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2 = 0$$\n解出$b$：\n$$b \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2 = \\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i\\mu_k$$\n这得到$b^{(t+1)}$的M步更新方程：\n$$b^{(t+1)} = \\frac{\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} y_i \\mu_k}{\\sum_{i=1}^{N} \\sum_{k=1}^{2} \\gamma_{ik}^{(t)} \\mu_k^2}$$\n\n### 任务2：数值计算\n\n给定$N=4$个体素，强度为$y = \\{82, 120, 78, 130\\}$，类别均值为$\\mu_1=110$和$\\mu_2=80$，标准差为$\\sigma=10$（$\\sigma^2=100$），混合权重为$\\pi_1=\\pi_2=\\frac{1}{2}$。初始偏置估计为$b^{(0)}=1$。\n\n**迭代$t=0$的E步**：我们使用$b^{(0)}=1$计算责任$\\gamma_{ik}^{(0)}$。\n责任$\\gamma_{ik}^{(0)}$由贝叶斯定理给出：\n$$\\gamma_{ik}^{(0)} = p(z_i=k | y_i, b^{(0)}) = \\frac{p(y_i | z_i=k, b^{(0)}) p(z_i=k)}{\\sum_{j=1}^{2} p(y_i | z_i=j, b^{(0)}) p(z_i=j)}$$\n由于$\\pi_1 = \\pi_2$，先验项可以消掉。设$\\mathcal{L}_{ik} = p(y_i|z_i=k, b^{(0)})$。\n对于给定的$i$，项$\\frac{1}{\\sqrt{2\\pi}\\sigma}$对所有$\\mathcal{L}_{ik}$是公共的，因此也会消掉。我们只需要指数部分来计算责任：\n$$\\gamma_{i1}^{(0)} = \\frac{\\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_1)^2}{2\\sigma^2}\\right)}{\\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_1)^2}{2\\sigma^2}\\right) + \\exp\\left(-\\frac{(y_i - b^{(0)}\\mu_2)^2}{2\\sigma^2}\\right)}$$\n且$\\gamma_{i2}^{(0)} = 1 - \\gamma_{i1}^{(0)}$。已知$b^{(0)}=1$, $\\mu_1=110$, $\\mu_2=80$, $\\sigma^2=100$：\n\n- 对于$i=1$, $y_1=82$：\n  - $(y_1 - b^{(0)}\\mu_1)^2 = (82 - 110)^2 = (-28)^2 = 784$。\n  - $(y_1 - b^{(0)}\\mu_2)^2 = (82 - 80)^2 = (2)^2 = 4$。\n  - $\\gamma_{11}^{(0)} = \\frac{\\exp(-784/200)}{\\exp(-784/200) + \\exp(-4/200)} = \\frac{\\exp(-3.92)}{\\exp(-3.92) + \\exp(-0.02)} \\approx 0.019839$。\n  - $\\gamma_{12}^{(0)} = 1 - \\gamma_{11}^{(0)} \\approx 0.980161$。\n\n- 对于$i=2$, $y_2=120$：\n  - $(y_2 - b^{(0)}\\mu_1)^2 = (120 - 110)^2 = (10)^2 = 100$。\n  - $(y_2 - b^{(0)}\\mu_2)^2 = (120 - 80)^2 = (40)^2 = 1600$。\n  - $\\gamma_{21}^{(0)} = \\frac{\\exp(-100/200)}{\\exp(-100/200) + \\exp(-1600/200)} = \\frac{\\exp(-0.5)}{\\exp(-0.5) + \\exp(-8)} \\approx 0.999448$。\n  - $\\gamma_{22}^{(0)} = 1 - \\gamma_{21}^{(0)} \\approx 0.000552$。\n\n- 对于$i=3$, $y_3=78$：\n  - $(y_3 - b^{(0)}\\mu_1)^2 = (78 - 110)^2 = (-32)^2 = 1024$。\n  - $(y_3 - b^{(0)}\\mu_2)^2 = (78 - 80)^2 = (-2)^2 = 4$。\n  - $\\gamma_{31}^{(0)} = \\frac{\\exp(-1024/200)}{\\exp(-1024/200) + \\exp(-4/200)} = \\frac{\\exp(-5.12)}{\\exp(-5.12) + \\exp(-0.02)} \\approx 0.006059$。\n  - $\\gamma_{32}^{(0)} = 1 - \\gamma_{31}^{(0)} \\approx 0.993941$。\n\n- 对于$i=4$, $y_4=130$：\n  - $(y_4 - b^{(0)}\\mu_1)^2 = (130 - 110)^2 = (20)^2 = 400$。\n  - $(y_4 - b^{(0)}\\mu_2)^2 = (130 - 80)^2 = (50)^2 = 2500$。\n  - $\\gamma_{41}^{(0)} = \\frac{\\exp(-400/200)}{\\exp(-400/200) + \\exp(-2500/200)} = \\frac{\\exp(-2)}{\\exp(-2) + \\exp(-12.5)} \\approx 0.999973$。\n  - $\\gamma_{42}^{(0)} = 1 - \\gamma_{41}^{(0)} \\approx 0.000027$。\n\n**M步**：我们使用推导出的公式和计算出的责任来计算更新后的偏置$b^{(1)}$。\n$$b^{(1)} = \\frac{\\sum_{i=1}^{4} (\\gamma_{i1}^{(0)} y_i \\mu_1 + \\gamma_{i2}^{(0)} y_i \\mu_2)}{\\sum_{i=1}^{4} (\\gamma_{i1}^{(0)} \\mu_1^2 + \\gamma_{i2}^{(0)} \\mu_2^2)}$$\n首先，计算分子：\n分子 = $(\\gamma_{11}^{(0)} y_1 \\mu_1 + \\gamma_{12}^{(0)} y_1 \\mu_2) + (\\gamma_{21}^{(0)} y_2 \\mu_1 + \\gamma_{22}^{(0)} y_2 \\mu_2) + \\dots$\n- $i=1$：$(0.019839 \\times 82 \\times 110) + (0.980161 \\times 82 \\times 80) \\approx 179.0 + 6429.9 \\approx 6608.9$\n- $i=2$：$(0.999448 \\times 120 \\times 110) + (0.000552 \\times 120 \\times 80) \\approx 13192.7 + 5.3 \\approx 13198.0$\n- $i=3$：$(0.006059 \\times 78 \\times 110) + (0.993941 \\times 78 \\times 80) \\approx 52.0 + 6202.4 \\approx 6254.4$\n- $i=4$：$(0.999973 \\times 130 \\times 110) + (0.000027 \\times 130 \\times 80) \\approx 14299.6 + 0.3 \\approx 14299.9$\n分子之和 $\\approx 6608.9 + 13198.0 + 6254.4 + 14299.9 = 40361.2$\n\n接着，计算分母，其中$\\mu_1^2=12100$和$\\mu_2^2=6400$：\n分母 = $(\\gamma_{11}^{(0)} \\mu_1^2 + \\gamma_{12}^{(0)} \\mu_2^2) + (\\gamma_{21}^{(0)} \\mu_1^2 + \\gamma_{22}^{(0)} \\mu_2^2) + \\dots$\n- $i=1$：$(0.019839 \\times 12100) + (0.980161 \\times 6400) \\approx 240.1 + 6273.0 \\approx 6513.1$\n- $i=2$：$(0.999448 \\times 12100) + (0.000552 \\times 6400) \\approx 12093.3 + 3.5 \\approx 12096.8$\n- $i=3$：$(0.006059 \\times 12100) + (0.993941 \\times 6400) \\approx 73.3 + 6361.2 \\approx 6434.5$\n- $i=4$：$(0.999973 \\times 12100) + (0.000027 \\times 6400) \\approx 12099.7 + 0.2 \\approx 12099.9$\n分母之和 $\\approx 6513.1 + 12096.8 + 6434.5 + 12099.9 = 37144.3$\n\n最后，我们计算$b^{(1)}$：\n$$b^{(1)} = \\frac{40361.2}{37144.3} \\approx 1.086598$$\n四舍五入到五位有效数字，更新后的偏置估计为$1.0866$。",
            "answer": "$$\\boxed{1.0866}$$"
        }
    ]
}