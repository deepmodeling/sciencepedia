{
    "hands_on_practices": [
        {
            "introduction": "在处理类别不平衡的数据集时，简单的随机分组可能导致某些折（fold）中正样本或负样本的比例严重偏离全体数据集的分布，从而影响模型评估的可靠性。分层 k 折交叉验证是解决此问题的关键技术。 这个练习将通过基本的概率论，推导并计算在分层抽样下每个折中各类别的期望样本数，从而让你从根本上理解为什么该方法能确保评估的公平性。",
            "id": "4535090",
            "problem": "在一项放射组学分类研究中，每位患者被标记为阳性（例如，响应者）或阴性（例如，无响应者）。为了在缓解类别不平衡的同时估计泛化性能，该团队使用了分层 $k$ 折交叉验证，并且在部署中他们计划使用嵌套交叉验证，其中外层循环本身也是分层的。假设在每个类别内部，分配到各折的操作使得每个个体被分配到外层循环的任何一折的概率都相同，并且在同一类别内，这种分配是可交换的。利用概率论的基本规则，特别是指示随机变量之和的期望以及分层折叠的等概率分配原则，推导在分层 $k$ 折交叉验证中，每个外层折叠中阳性样本的期望数量和阴性样本的期望数量（用 $N_1$、$N_0$ 和 $k$ 表示）。然后，对于 $N_1=36$、$N_0=84$ 和 $k=5$ 的情况，显式计算这些期望值。将最终的期望计数表示为精确的有理数（不要四舍五入）。",
            "solution": "问题要求推导在分层 $k$ 折交叉验证设置中，每个折叠中阳性和阴性样本的期望数量，然后进行具体的数值计算。推导将基于概率论原理，特别是使用指示随机变量和期望的线性性质。\n\n设 $N_1$ 为数据集中阳性样本的总数，$N_0$ 为阴性样本的总数。设 $k$ 为折数。样本总数为 $N = N_1 + N_0$。该过程是分层的，这意味着对每个类别（阳性和阴性）分别进行折叠划分。\n\n首先，我们来推导每个折叠中阳性样本的期望数量。\n设阳性样本集为 $\\mathcal{S}_1 = \\{P_1, P_2, \\dots, P_{N_1}\\}$。\n设折叠集为 $\\mathcal{F} = \\{F_1, F_2, \\dots, F_k\\}$。\n我们关心的是任意一个折叠中阳性样本的数量，比如说对于某个 $j \\in \\{1, \\dots, k\\}$ 的折叠 $F_j$。设这个数量由随机变量 $X_j$ 表示。\n\n为了求出 $X_j$ 的期望值，我们可以将 $X_j$ 表示为指示随机变量之和。对于每个阳性样本 $P_i \\in \\mathcal{S}_1$，设 $I_{i,j}$ 为一个指示变量，使得：\n$$\nI_{i,j} = \\begin{cases} 1  \\text{if sample } P_i \\text{ is in fold } F_j \\\\ 0  \\text{otherwise} \\end{cases}\n$$\n折叠 $F_j$ 中阳性样本的总数是所有阳性样本的这些指示变量之和：\n$$\nX_j = \\sum_{i=1}^{N_1} I_{i,j}\n$$\n根据期望的线性性质，$X_j$ 的期望值是各个指示变量期望值之和：\n$$\nE[X_j] = E\\left[\\sum_{i=1}^{N_1} I_{i,j}\\right] = \\sum_{i=1}^{N_1} E[I_{i,j}]\n$$\n指示变量的期望是它所指示事件的概率。因此，\n$$\nE[I_{i,j}] = P(I_{i,j} = 1)\n$$\n其中 $P(I_{i,j} = 1)$ 是样本 $P_i$ 被分配到折叠 $F_j$ 的概率。问题陈述中提到“在每个类别内部，分配到各折的操作使得每个个体被分配到任何一折的概率都相同”。由于有 $k$ 个折叠，并且每个样本必须被分配到且仅分配到一个折叠，因此特定样本 $P_i$ 被分配到特定折叠 $F_j$ 的概率是 $\\frac{1}{k}$。\n$$\nP(I_{i,j} = 1) = \\frac{1}{k}\n$$\n这对任何阳性样本 $i \\in \\{1, \\dots, N_1\\}$ 和任何折叠 $j \\in \\{1, \\dots, k\\}$ 都成立。\n将此概率代回指示变量期望的表达式中：\n$$\nE[I_{i,j}] = \\frac{1}{k}\n$$\n现在，我们可以计算这个和：\n$$\nE[X_j] = \\sum_{i=1}^{N_1} \\frac{1}{k} = N_1 \\cdot \\frac{1}{k} = \\frac{N_1}{k}\n$$\n由于我们选择的折叠 $F_j$ 是任意的，所以这个结果对任何折叠都成立。让 $E[N_{1,\\text{fold}}]$ 表示每个折叠中阳性样本的期望数量。\n$$\nE[N_{1,\\text{fold}}] = \\frac{N_1}{k}\n$$\n每个折叠中阴性样本期望数量的推导遵循完全相同的逻辑。\n设阴性样本集为 $\\mathcal{S}_0 = \\{N_1, N_2, \\dots, N_{N_0}\\}$。\n设 $Y_j$ 为折叠 $F_j$ 中阴性样本数量的随机变量。\n设 $J_{i,j}$ 为阴性样本 $N_i$ 在折叠 $F_j$ 中的指示变量。\n$$\nY_j = \\sum_{i=1}^{N_0} J_{i,j}\n$$\n根据期望的线性性质：\n$$\nE[Y_j] = \\sum_{i=1}^{N_0} E[J_{i,j}] = \\sum_{i=1}^{N_0} P(J_{i,j}=1)\n$$\n基于相同的分配原则，任何阴性样本 $N_i$ 被分配到任何折叠 $F_j$ 的概率也是 $\\frac{1}{k}$。\n$$\nP(J_{i,j}=1) = \\frac{1}{k}\n$$\n因此，折叠 $F_j$ 中阴性样本的期望数量，记为 $E[N_{0,\\text{fold}}]$，是：\n$$\nE[Y_j] = \\sum_{i=1}^{N_0} \\frac{1}{k} = N_0 \\cdot \\frac{1}{k} = \\frac{N_0}{k}\n$$\n所以，通用表达式为 $E[N_{1,\\text{fold}}] = \\frac{N_1}{k}$ 和 $E[N_{0,\\text{fold}}] = \\frac{N_0}{k}$。\n\n现在我们将这些公式应用于问题中给出的具体值：\n$N_1 = 36$（阳性）\n$N_0 = 84$（阴性）\n$k = 5$（折）\n\n每个折叠中阳性样本的期望数量是：\n$$\nE[N_{1,\\text{fold}}] = \\frac{N_1}{k} = \\frac{36}{5}\n$$\n每个折叠中阴性样本的期望数量是：\n$$\nE[N_{0,\\text{fold}}] = \\frac{N_0}{k} = \\frac{84}{5}\n$$\n问题要求将这些值表示为精确的有理数，它们已经是了。这些值代表了如果随机分配过程重复多次，在每个折叠中会发现的各类样本的平均数量。在任何单次划分中，实际计数必须是整数，并尽可能均匀地分布（例如，对于阳性样本：一个折叠有 $8$ 个，四个折叠有 $7$ 个，因为 $36 = 1 \\times 8 + 4 \\times 7$）。这些折叠的平均值确实是 $\\frac{36}{5} = 7.2$。对于阴性样本也是类似的，$84 = 4 \\times 17 + 1 \\times 16$，平均值为 $\\frac{84}{5} = 16.8$。因此，推导出的期望值被证实是正确的。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{36}{5}  \\frac{84}{5}\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "嵌套交叉验证是获得模型泛化性能无偏估计的黄金标准，但其强大功能的背后是高昂的计算成本。 这个实践将引导你一步步拆解嵌套交叉验证的流程——包括外循环的性能评估和内循环的超参数搜索——来精确计算所需的模型训练总次数。通过这个计算，你将对选择这种稳健评估方法时所涉及的实际计算开销有更深刻的认识。",
            "id": "4535122",
            "problem": "一个放射组学研究团队正在构建一个二元分类器，使用从计算机断层扫描中提取的定量特征来区分高级别和低级别肿瘤。他们选择使用带有径向基函数 (RBF) 核的支持向量机 (SVM)。为了获得泛化性能的无偏估计并调整超参数，他们采用了嵌套交叉验证（CV），其中外部 $k$ 折交叉验证用于性能评估，内部 $k$ 折交叉验证通过网格搜索进行超参数选择。\n\n根据定义，在 $k$ 折交叉验证中，数据集被划分为 $k$ 个不相交的折；对于每个折 $i$，模型在 $k-1$ 个训练折上进行训练，并在留出的折 $i$ 上进行评估。在嵌套交叉验证中，对于每个外部折，都会在外部训练数据上运行一个内部交叉验证循环来选择超参数。超参数网格搜索通过在每个内部训练折上训练模型，从而利用内部交叉验证来评估每个候选超参数设置。在内部交叉验证为该外部划分选出最佳超参数后，模型会在完整的外部训练数据上重新拟合一次，然后再在外部测试折上进行评估。模型在某个数据划分上的每一次单独训练都算作一次模型拟合，并且在不同的折或超参数设置之间不存在拟合的重用或热启动。\n\n该团队指定的超参数网格为 $C \\in \\{0.1, 1, 10\\}$ 和 $\\gamma \\in \\{10^{-3}, 10^{-2}, 10^{-1}\\}$。他们选择 $k_{\\text{outer}} = 5$ 和 $k_{\\text{inner}} = 3$。\n\n假设该过程严格遵守上述定义，请计算完成整个嵌套交叉验证过程所需的模型拟合总次数，包括所有用于超参数评估的内部交叉验证拟合，以及在评估前为每个外部折在完整的外部训练集上进行的单次重新拟合。请将您的最终答案表示为单个整数，无需四舍五入。",
            "solution": "问题陈述已经过验证，被认为是有效的。它在科学上基于标准的机器学习方法论（嵌套交叉验证），提法得当，提供了所有必要的参数，并以客观、无歧义的语言表达。\n\n目标是计算完成整个嵌套交叉验证过程所需的模型拟合总次数。让我们系统地剖析所描述的过程。\n\n该过程涉及一个用于性能评估的外部循环和一个用于超参数调整的内部循环。我们有以下给定参数：\n- 外部交叉验证的折数，$k_{\\text{outer}} = 5$。\n- 内部交叉验证的折数，$k_{\\text{inner}} = 3$。\n- 超参数 $C$ 的值集为 $\\{0.1, 1, 10\\}$。其值的数量为 $N_C = 3$。\n- 超参数 $\\gamma$ 的值集为 $\\{10^{-3}, 10^{-2}, 10^{-1}\\}$。其值的数量为 $N_\\gamma = 3$。\n\n在网格搜索中需要评估的超参数组合总数是每个超参数值的数量的乘积。设 $N_{\\text{params}}$ 为网格中的组合数。\n$$N_{\\text{params}} = N_C \\times N_\\gamma = 3 \\times 3 = 9$$\n这 $9$ 对不同的超参数必须在每个外部折的训练过程中进行评估。\n\n整个过程包括 $k_{\\text{outer}}$ 次外部循环迭代。在每次迭代中，一个折被留出作为外部测试集，剩下的 $k_{\\text{outer}}-1$ 个折构成外部训练集。让我们分析这个外部循环单次迭代的模型拟合次数。\n\n1.  **用于超参数调整的内部交叉验证：**\n    对于一次特定的外部循环迭代（例如，对于外部折 $i$），相应的外部训练数据被用来从网格中找到最佳的超参数。这是通过使用内部 $k_{\\text{inner}}$ 折交叉验证来完成的。\n    - 对于 $N_{\\text{params}} = 9$ 个超参数设置中的*每一个*，都在外部训练数据上执行一次完整的 $k_{\\text{inner}}$ 折交叉验证。\n    - 根据定义，一次 $k_{\\text{inner}}$ 折交叉验证涉及将模型训练 $k_{\\text{inner}}$ 次，每次都在 $k_{\\text{inner}}-1$ 个内部折的不同组合上进行训练，并在剩余的内部折上进行评估。\n    - 因此，对于单个外部折，内部交叉验证循环的模型拟合同总次数是超参数设置的数量乘以内部折的数量。\n    - 设 $N_{\\text{fits, inner-loop}}$ 为此数字。\n    $$N_{\\text{fits, inner-loop}} = N_{\\text{params}} \\times k_{\\text{inner}} = 9 \\times 3 = 27$$\n    这 $27$ 次拟合是为了评估所有候选超参数，并为当前的外部训练集选出最佳的一个。\n\n2.  **为外部折评估进行的模型重新拟合：**\n    在内部交叉验证循环确定了最佳超参数对（例如，$(C^*, \\gamma^*)$）之后，问题陈述中说明：“模型会在完整的外部训练数据上重新拟合一次，然后再在外部测试折上进行评估。”\n    - 这个步骤涉及一次单独的模型训练。模型使用最佳超参数 $(C^*, \\gamma^*)$ 在*整个*外部训练集（所有 $k_{\\text{outer}}-1$ 个折的组合）上进行训练。\n    - 这为我们当前外部循环迭代的计数增加了正好 $1$ 次模型拟合。\n\n3.  **每次外部循环迭代的总拟合次数：**\n    外部循环一次完整迭代的总拟合次数是内部交叉验证的拟合次数与最终重新拟合步骤的拟合次数之和。\n    - 设 $N_{\\text{fits, one-outer-iter}}$ 为此数字。\n    $$N_{\\text{fits, one-outer-iter}} = N_{\\text{fits, inner-loop}} + 1 = 27 + 1 = 28$$\n\n4.  **模型拟合总次数：**\n    对于外部交叉验证的 $k_{\\text{outer}}$ 个折中的每一个，都会重复步骤 $1$-$3$ 中描述的过程。由于不同折之间的拟合不存在重用，我们只需将每次外部迭代的拟合次数乘以外部迭代的次数。\n    - 设 $N_{\\text{fits, total}}$ 为整个嵌套交叉验证过程的模型拟合总次数。\n    $$N_{\\text{fits, total}} = k_{\\text{outer}} \\times N_{\\text{fits, one-outer-iter}}$$\n    代入给定值和计算值：\n    $$N_{\\text{fits, total}} = 5 \\times 28 = 140$$\n\n总而言之，计算如下：外部循环运行 $k_{\\text{outer}}=5$ 次。在每次运行内部，对 $N_{\\text{params}}=9$ 种超参数设置进行网格搜索。每种设置都通过 $k_{\\text{inner}}=3$ 折交叉验证进行评估，从而产生 $9 \\times 3 = 27$ 次训练。此后，一个最终模型在完整的外部训练数据上进行训练，这又增加了 $1$ 次训练。因此，5 次外部运行中的每一次都需要 $27 + 1 = 28$ 次模型训练。总次数为 $5 \\times 28 = 140$。",
            "answer": "$$\\boxed{140}$$"
        },
        {
            "introduction": "理论和计算成本都已了解，现在是时候将它们付诸实践了。这个综合性练习模拟了嵌套交叉验证流程中最关键的环节：在内循环中进行模型调优，并在外循环中进行最终性能评估。 你将使用预先计算好的模型分数，练习如何在验证集上选择最佳决策阈值，然后在独立的测试集上评估模型的真实性能，从而严格遵守数据分离原则，避免任何形式的数据泄露，最终得到对模型泛化能力无偏的估计。",
            "id": "4535117",
            "problem": "一项二元放射组学分类任务旨在使用从医学影像中提取的定量特征来区分恶性病变 ($y=1$) 和良性病变 ($y=0$)。假设采用嵌套交叉验证设计，其中包含 $K=3$ 个外层折和 $k=2$ 个内层折。在每个内层循环中，严格对内层训练分区应用合成少数类过采样技术 (SMOTE) 以解决类别不平衡问题，并训练一个概率分类器以生成校准分数。在每个外层折中，通过在内层验证集预测上最大化约登指数 (Youden's J) 来选择决策阈值 $\\tau$。约登指数 $J$ 定义为 $J=\\mathrm{TPR}+\\mathrm{TNR}-1$，其中 $\\mathrm{TPR}$ 是真阳性率，$\\mathrm{TNR}$ 是真阴性率。受试者工作特征曲线下面积 (AUC) 定义为随机选择的正例得分高于随机选择的负例得分的概率，对于有限样本，这等于正确排序的正负样本对的比例，其中平局计为二分之一。\n\n对于每个外层折 $j\\in\\{1,2,3\\}$，给定内层验证集预测（仅对内层训练分区应用SMOTE进行训练后获得）和外层测试集预测（SMOTE从不应用于测试数据）。仅使用内层验证集预测来选择 $\\tau_{j}$，然后在对应的外层测试集上使用 $\\tau_{j}$ 评估灵敏度（真阳性率），并使用成对排序定义计算外层测试集上的 AUC。\n\n外层折 1:\n- 内层验证集 (得分, $y$): $(0.72,1)$, $(0.56,1)$, $(0.48,0)$, $(0.20,0)$。\n- 外层测试集 (得分, $y$): $(0.80,1)$, $(0.60,1)$, $(0.40,0)$, $(0.30,0)$。\n\n外层折 2:\n- 内层验证集 (得分, $y$): $(0.62,1)$, $(0.52,1)$, $(0.50,0)$, $(0.18,0)$。\n- 外层测试集 (得分, $y$): $(0.60,1)$, $(0.35,1)$, $(0.50,0)$, $(0.20,0)$。\n\n外层折 3:\n- 内层验证集 (得分, $y$): $(0.40,1)$, $(0.32,1)$, $(0.38,0)$, $(0.12,0)$。\n- 外层测试集 (得分, $y$): $(0.45,1)$, $(0.25,1)$, $(0.40,0)$, $(0.10,0)$。\n\n任务:\n1. 对于每个外层折 $j$，通过在由唯一内层验证分数组​​成的候选阈值集上评估 $J$，确定在内层验证集上使约登指数 $J$ 最大化的阈值 $\\tau_j$。\n2. 对于每个外层折 $j$，使用正例和负例之间的得分成对排序来计算外层测试集的 AUC。\n3. 对于每个外层折 $j$，计算在选定的 $\\tau_j$ 下的外层测试集灵敏度。\n4. 报告三个外层折的宏平均外层 AUC（三个特定折的 AUC 值的算术平均值）和微平均外层灵敏度（所有外层测试集中的总真阳性数除以所有外层测试集中的总正例数）。将您的最后两个值四舍五入到四位有效数字。将您的最终答案表示为一个二元行矩阵 $\\begin{pmatrix}\\text{AUC}  \\text{灵敏度}\\end{pmatrix}$，不带单位。\n\n通过您的计算证明，SMOTE 和阈值调整仅限于内层循环中的训练分区，不使用任何外层测试数据。",
            "solution": "问题陈述经证实具有科学依据、问题明确且客观。它描述了机器学习中模型评估的一种标准且现实的程序，特别是在医学影像分析（放射组学）的背景下。所提供的数据是完整和一致的，任务定义明确并使用了标准指标。该问题是可解的，需要仔细应用指定的方法论。\n\n该问题要求基于嵌套交叉验证 (CV) 程序进行分析。嵌套 CV 的核心原则是提供模型性能的无偏估计。这是通过将用于模型调优（超参数优化，如选择决策阈值 $\\tau$）的数据与用于最终性能评估的数据分开来实现的。\n\n在这个问题中，对于一个 $K=3$ 折 CV 的每个外层折 $j \\in \\{1,2,3\\}$，都有一个关联的外层测试集。剩余的数据用于内层 CV 循环（包含 $k=2$ 个折）。这个内层循环用于训练和调优模型。问题陈述指出，决策阈值 $\\tau_j$ 是在内层验证集的预测上选择的。这个选择过程模拟了在实际应用中会发生的模型调优，而不会“偷看”最终的测试数据。一旦确定了折 $j$ 的最优阈值 $\\tau_j$，它就被固定下来。然后使用这个固定的阈值来评估模型在完全独立的折 $j$ 的外层测试集上的性能（灵敏度）。AUC 是一个与阈值无关的指标，也在此外层测试集上计算。这种严格的分离确保了每个外层折的性能指标（在 $\\tau_j$ 下的灵敏度和 AUC）不会被乐观地偏倚。\n\nSMOTE 的使用仅限于内层训练分区，这些分区甚至没有提供给我们，从而正确地防止了任何从验证集或测试集到过采样过程的数据泄漏。我们的计算将严格遵守这种数据分离，从而证明嵌套 CV 协议的正确实施。\n\n我们对每个外层折进行计算。\n\n### 外层折 $j=1$\n\n#### 1. 阈值选择 ($\\tau_1$)\n折 1 的内层验证集由得分-标签对给出： $\\{(0.72,1), (0.56,1), (0.48,0), (0.20,0)\\}$。有 $P_{val,1}=2$ 个正例（得分 $\\{0.72, 0.56\\}$）和 $N_{val,1}=2$ 个负例（得分 $\\{0.48, 0.20\\}$）。\n候选阈值是唯一的得分值：$\\{0.20, 0.48, 0.56, 0.72\\}$。我们为每个候选阈值 $\\tau$ 计算约登指数 $J = \\mathrm{TPR} + \\mathrm{TNR} - 1$。如果一个样本的得分 $\\ge \\tau$，则预测为正例。\n\n- 对于 $\\tau = 0.20$：预测为 $\\{1,1,1,1\\}$。TP$=2$, FP$=2$, TN$=0$, FN$=0$。\n$\\mathrm{TPR} = \\frac{2}{2} = 1$。$\\mathrm{TNR} = \\frac{0}{2} = 0$。$J = 1 + 0 - 1 = 0$。\n- 对于 $\\tau = 0.48$：预测为 $\\{1,1,1,0\\}$。TP$=2$, FP$=1$, TN$=1$, FN$=0$。\n$\\mathrm{TPR} = \\frac{2}{2} = 1$。$\\mathrm{TNR} = \\frac{1}{2} = 0.5$。$J = 1 + 0.5 - 1 = 0.5$。\n- 对于 $\\tau = 0.56$：预测为 $\\{1,1,0,0\\}$。TP$=2$, FP$=0$, TN$=2$, FN$=0$。\n$\\mathrm{TPR} = \\frac{2}{2} = 1$。$\\mathrm{TNR} = \\frac{2}{2} = 1$。$J = 1 + 1 - 1 = 1$。\n- 对于 $\\tau = 0.72$：预测为 $\\{1,0,0,0\\}$。TP$=1$, FP$=0$, TN$=2$, FN$=1$。\n$\\mathrm{TPR} = \\frac{1}{2} = 0.5$。$\\mathrm{TNR} = \\frac{2}{2} = 1$。$J = 0.5 + 1 - 1 = 0.5$。\n\n最大的约登指数 $J$ 为 $1$，出现在 $\\tau_1 = 0.56$。\n\n#### 2. 折 1 的外层测试集评估\n外层测试集是 $\\{(0.80,1), (0.60,1), (0.40,0), (0.30,0)\\}$。有 $P_{test,1}=2$ 个正例（得分 $\\{0.80, 0.60\\}$）和 $N_{test,1}=2$ 个负例（得分 $\\{0.40, 0.30\\}$）。\n\n- **AUC 计算**：正负样本对的数量为 $P_{test,1} \\times N_{test,1} = 2 \\times 2 = 4$。\n这些对是 $(0.80, 0.40)$, $(0.80, 0.30)$, $(0.60, 0.40)$, 和 $(0.60, 0.30)$。\n在所有 $4$ 个对中，正例的得分都大于负例的得分。没有平局。\n$\\mathrm{AUC}_1 = \\frac{4}{4} = 1$。\n\n- **灵敏度计算**：使用选定的阈值 $\\tau_1 = 0.56$，我们对外部测试集中的正例进行分类：\n- 得分 $0.80 \\ge 0.56 \\implies$ 真阳性 (TP)。\n- 得分 $0.60 \\ge 0.56 \\implies$ 真阳性 (TP)。\n真阳性数为 $\\mathrm{TP}_1 = 2$。\n$\\mathrm{Sensitivity}_1 = \\frac{\\mathrm{TP}_1}{P_{test,1}} = \\frac{2}{2} = 1$。\n\n### 外层折 $j=2$\n\n#### 1. 阈值选择 ($\\tau_2$)\n折 2 的内层验证集是 $\\{(0.62,1), (0.52,1), (0.50,0), (0.18,0)\\}$。有 $P_{val,2}=2$ 个正例（得分 $\\{0.62, 0.52\\}$）和 $N_{val,2}=2$ 个负例（得分 $\\{0.50, 0.18\\}$）。\n候选阈值是 $\\{0.18, 0.50, 0.52, 0.62\\}$。\n\n- 对于 $\\tau = 0.18$：TP$=2$, FP$=2$, TN$=0$, FN$=0$。$\\mathrm{TPR} = 1$, $\\mathrm{TNR} = 0$。$J=0$。\n- 对于 $\\tau = 0.50$：TP$=2$, FP$=1$, TN$=1$, FN$=0$。$\\mathrm{TPR} = 1$, $\\mathrm{TNR} = 0.5$。$J=0.5$。\n- 对于 $\\tau = 0.52$：TP$=2$, FP$=0$, TN$=2$, FN$=0$。$\\mathrm{TPR} = 1$, $\\mathrm{TNR} = 1$。$J=1$。\n- 对于 $\\tau = 0.62$：TP$=1$, FP$=0$, TN$=2$, FN$=1$。$\\mathrm{TPR} = 0.5$, $\\mathrm{TNR} = 1$。$J=0.5$。\n\n最大的约登指数 $J$ 为 $1$，出现在 $\\tau_2 = 0.52$。\n\n#### 2. 折 2 的外层测试集评估\n外层测试集是 $\\{(0.60,1), (0.35,1), (0.50,0), (0.20,0)\\}$。有 $P_{test,2}=2$ 个正例（得分 $\\{0.60, 0.35\\}$）和 $N_{test,2}=2$ 个负例（得分 $\\{0.50, 0.20\\}$）。\n\n- **AUC 计算**：对的数量为 $2 \\times 2 = 4$。\n- $(0.60, 0.50)$: 正例得分 $>$ 负例得分（正确排序，$+1$）。\n- $(0.60, 0.20)$: 正例得分 $>$ 负例得分（正确排序，$+1$）。\n- $(0.35, 0.50)$: 正例得分 $<$ 负例得分（错误排序，$+0$）。\n- $(0.35, 0.20)$: 正例得分 $>$ 负例得分（正确排序，$+1$）。\n正确排序的对数为 $3$。\n$\\mathrm{AUC}_2 = \\frac{3}{4} = 0.75$。\n\n- **灵敏度计算**：使用 $\\tau_2 = 0.52$，我们对外部测试集中的正例进行分类：\n- 得分 $0.60 \\ge 0.52 \\implies$ 真阳性 (TP)。\n- 得分 $0.35  0.52 \\implies$ 假阴性 (FN)。\n真阳性数为 $\\mathrm{TP}_2 = 1$。\n$\\mathrm{Sensitivity}_2 = \\frac{\\mathrm{TP}_2}{P_{test,2}} = \\frac{1}{2} = 0.5$。\n\n### 外层折 $j=3$\n\n#### 1. 阈值选择 ($\\tau_3$)\n折 3 的内层验证集是 $\\{(0.40,1), (0.32,1), (0.38,0), (0.12,0)\\}$。有 $P_{val,3}=2$ 个正例（得分 $\\{0.40, 0.32\\}$）和 $N_{val,3}=2$ 个负例（得分 $\\{0.38, 0.12\\}$）。\n候选阈值是 $\\{0.12, 0.32, 0.38, 0.40\\}$。\n\n- 对于 $\\tau = 0.12$：TP$=2$, FP$=2$, TN$=0$。$\\mathrm{TPR} = 1$, $\\mathrm{TNR} = 0$。$J=0$。\n- 对于 $\\tau = 0.32$：TP$=2$, FP$=1$, TN$=1$。$\\mathrm{TPR} = 1$, $\\mathrm{TNR} = 0.5$。$J=0.5$。\n- 对于 $\\tau = 0.38$：TP$=1$, FP$=1$, TN$=1$。$\\mathrm{TPR} = 0.5$, $\\mathrm{TNR} = 0.5$。$J=0$。\n- 对于 $\\tau = 0.40$：TP$=1$, FP$=0$, TN$=2$。$\\mathrm{TPR} = 0.5$, $\\mathrm{TNR} = 1$。$J=0.5$。\n\n最大的约登指数 $J$ 为 $0.5$，在 $\\tau = 0.32$ 和 $\\tau = 0.40$ 处均可达到。问题没有指定平局打破规则。一个常见的约定是选择较低的阈值以优先考虑灵敏度。我们将采用这个约定并选择 $\\tau_3 = 0.32$。（注意：在这种特定情况下，选择 $\\tau=0.40$ 会得到相同的测试灵敏度）。\n\n#### 2. 折 3 的外层测试集评估\n外层测试集是 $\\{(0.45,1), (0.25,1), (0.40,0), (0.10,0)\\}$。有 $P_{test,3}=2$ 个正例（得分 $\\{0.45, 0.25\\}$）和 $N_{test,3}=2$ 个负例（得分 $\\{0.40, 0.10\\}$）。\n\n- **AUC 计算**：对的数量为 $2 \\times 2 = 4$。\n- $(0.45, 0.40)$: 正例得分 $$ 负例得分（正确排序，$+1$）。\n- $(0.45, 0.10)$: 正例得分 $$ 负例得分（正确排序，$+1$）。\n- $(0.25, 0.40)$: 正例得分 $$ 负例得分（错误排序，$+0$）。\n- $(0.25, 0.10)$: 正例得分 $$ 负例得分（正确排序，$+1$）。\n正确排序的对数为 $3$。\n$\\mathrm{AUC}_3 = \\frac{3}{4} = 0.75$。\n\n- **灵敏度计算**：使用 $\\tau_3 = 0.32$，我们对外部测试集中的正例进行分类：\n- 得分 $0.45 \\ge 0.32 \\implies$ 真阳性 (TP)。\n- 得分 $0.25  0.32 \\implies$ 假阴性 (FN)。\n真阳性数为 $\\mathrm{TP}_3 = 1$。\n$\\mathrm{Sensitivity}_3 = \\frac{\\mathrm{TP}_3}{P_{test,3}} = \\frac{1}{2} = 0.5$。\n\n### 最终性能聚合\n\n#### 宏平均 AUC\n宏平均 AUC 是每个外层折 AUC 的算术平均值。\n$$ \\mathrm{AUC}_{\\text{macro}} = \\frac{\\mathrm{AUC}_1 + \\mathrm{AUC}_2 + \\mathrm{AUC}_3}{3} = \\frac{1 + 0.75 + 0.75}{3} = \\frac{2.5}{3} \\approx 0.833333... $$\n四舍五入到四位有效数字，$\\mathrm{AUC}_{\\text{macro}} = 0.8333$。\n\n#### 微平均灵敏度\n微平均灵敏度是所有折的总真阳性数除以所有折的总正例数。\n$$ \\mathrm{Sensitivity}_{\\text{micro}} = \\frac{\\sum_{j=1}^3 \\mathrm{TP}_j}{\\sum_{j=1}^3 P_{test,j}} = \\frac{\\mathrm{TP}_1 + \\mathrm{TP}_2 + \\mathrm{TP}_3}{P_{test,1} + P_{test,2} + P_{test,3}} = \\frac{2 + 1 + 1}{2 + 2 + 2} = \\frac{4}{6} = \\frac{2}{3} \\approx 0.666666... $$\n四舍五入到四位有效数字，$\\mathrm{Sensitivity}_{\\text{micro}} = 0.6667$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix} 0.8333  0.6667 \\end{pmatrix}\n}\n$$"
        }
    ]
}