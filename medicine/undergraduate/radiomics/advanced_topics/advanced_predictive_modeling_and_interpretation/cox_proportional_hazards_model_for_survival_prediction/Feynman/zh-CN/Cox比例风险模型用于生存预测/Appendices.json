{
    "hands_on_practices": [
        {
            "introduction": "Cox模型的偏似然是建立在评估特定事件时间点的风险之上的。其中一个关键概念是“风险集”，它包括了在特定时刻所有可能经历事件的个体。本练习  将提供手动计算风险集成员的实践，这对于理解生存数据（特别是包含交错入组等复杂情况的数据）如何对模型做出贡献至关重要。",
            "id": "4534781",
            "problem": "在一项关于非小细胞肺癌的影像组学研究中，一个包含 $3$ 名患者的队列使用Cox比例风险（PH）模型进行建模，其中具有影像组学特征向量 $\\mathbf{x}_{i}$ 的患者 $i$ 的风险函数为 $h(t \\mid \\mathbf{x}_{i}) = h_{0}(t) \\exp(\\boldsymbol{\\beta}^{\\top}\\mathbf{x}_{i})$，$h_{0}(t)$ 是基线风险，$\\boldsymbol{\\beta}$ 是系数向量。由于影像可及性导致的交错进入（左截断）和不完全随访（右删失），每位患者 $i$ 由进入时间 $a_{i}$、观测结束时间 $y_{i}$ 和事件指示符 $\\delta_{i} \\in \\{0,1\\}$ 来表征，其中 $\\delta_{i} = 1$ 表示在时间 $y_{i}$ 发生事件，$\\delta_{i} = 0$ 表示在时间 $y_{i}$ 发生右删失。观测到的时间如下：患者 $1$ 的数据为 $a_{1} = 0$, $y_{1} = 3$, $\\delta_{1} = 1$；患者 $2$ 的数据为 $a_{2} = 2$, $y_{2} = 5$, $\\delta_{2} = 0$；患者 $3$ 的数据为 $a_{3} = 4$, $y_{3} = 6$, $\\delta_{3} = 1$。\n\n假设采用生存分析中针对左截断和右删失的标准惯例：在任何时间 $t$，如果一个个体在时间 $t$ 之前已经进入研究，并且在时间 $t$ 之前既未发生事件也未被删失，则认为该个体处于风险中。使用此惯例，确定风险集在时间 $3$ 和时间 $5$ 的大小，即 $|R(3)|$ 和 $|R(5)|$，其中 $R(t)$ 表示在时间 $t$ 处于风险中的个体集合。请以有序对 $\\left(|R(3)|, |R(5)|\\right)$ 的形式报告您的答案，结果为精确整数，无需四舍五入。",
            "solution": "该问题陈述有效，源自生存分析领域，该领域是统计学的一个分支，常用于影像组学等医学研究领域。问题清晰、科学合理，并包含了得出唯一、可验证解所需的所有信息。\n\n该问题的核心是在给定时间 $t$ 正确构建风险集 $R(t)$。问题中给出了受左截断（交错进入）和右删失影响的生存数据的标准定义。个体 $i$ 处于风险集 $R(t)$ 中的充分必要条件是，他们在时间 $t$ 或之前已经进入研究，并且在时间 $t$ 时仍在观察中（即尚未发生事件或被删失）。\n\n设患者 $i$ 的数据为三元组 $(a_{i}, y_{i}, \\delta_{i})$，其中 $a_{i}$ 是进入时间，$y_{i}$ 是事件或删失发生的时间，$\\delta_{i}$ 是事件指示符。根据所给定义，患者 $i$ 是风险集 $R(t)$ 的成员，当且仅当满足以下两个条件：\n1. 患者已进入研究：$a_{i} \\le t$。\n2. 患者尚未发生事件或被删失：$y_{i} \\ge t$。\n\n因此，患者 $i$ 处于风险中的时间区间为 $[a_{i}, y_{i}]$。我们获得了 $3$ 名患者的数据：\n- 患者 1：$(a_{1}, y_{1}, \\delta_{1}) = (0, 3, 1)$。该患者在时间区间 $[0, 3]$ 内处于风险中。\n- 患者 2：$(a_{2}, y_{2}, \\delta_{2}) = (2, 5, 0)$。该患者在时间区间 $[2, 5]$ 内处于风险中。\n- 患者 3：$(a_{3}, y_{3}, \\delta_{3}) = (4, 6, 1)$。该患者在时间区间 $[4, 6]$ 内处于风险中。\n\n问题要求计算在两个特定时间点 $t=3$ 和 $t=5$ 时风险集的大小，记为 $|R(t)|$。\n\n首先，我们来确定在 $t=3$ 时风险集的大小，即 $|R(3)|$。我们对每位患者进行条件检查：\n- 患者 1：风险区间为 $[0, 3]$。由于 $0 \\le 3$ 且 $3 \\ge 3$，患者 1 在风险集 $R(3)$ 中。\n- 患者 2：风险区间为 $[2, 5]$。由于 $2 \\le 3$ 且 $5 \\ge 3$，患者 2 在风险集 $R(3)$ 中。\n- 患者 3：风险区间为 $[4, 6]$。由于进入时间为 $a_{3}=4$，晚于 $t=3$，因此条件 $a_{3} \\le 3$ 不满足。所以，患者 3 不在风险集 $R(3)$ 中。\n因此，在 $t=3$ 时处于风险中的个体集合为 $R(3) = \\{1, 2\\}$。该集合的大小为 $|R(3)| = 2$。\n\n接下来，我们确定在 $t=5$ 时风险集的大小，即 $|R(5)|$。我们再次对每位患者进行条件检查：\n- 患者 1：风险区间为 $[0, 3]$。该患者的事件发生在 $y_{1}=3$，早于 $t=5$。条件 $y_{1} \\ge 5$ 不满足。所以，患者 1 不在风险集 $R(5)$ 中。\n- 患者 2：风险区间为 $[2, 5]$。由于 $2 \\le 5$ 且 $5 \\ge 5$，患者 2 在风险集 $R(5)$ 中。请注意，该患者在时间 $5$ 被删失，因此他们在恰好时间 $5$ 时被认为处于风险中，但在任何时间 $t > 5$ 时将不处于风险中。\n- 患者 3：风险区间为 $[4, 6]$。由于 $4 \\le 5$ 且 $6 \\ge 5$，患者 3 在风险集 $R(5)$ 中。\n因此，在 $t=5$ 时处于风险中的个体集合为 $R(5) = \\{2, 3\\}$。该集合的大小为 $|R(5)| = 2$。\n\n问题要求提供有序对 $(|R(3)|, |R(5)|)$。根据我们的计算，这个有序对是 $(2, 2)$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n2  2\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "Cox模型的一个主要输出是风险比（hazard ratio），它量化了某个特征对生存风险的影响。然而，如果缺少对其不确定性的度量，这个点估计是不完整的。本练习  演示了为风险比构建置信区间的标准统计流程，这是正确解释和报告模型发现的显著性和精确度的关键技能。",
            "id": "4534726",
            "problem": "一项放射组学研究使用计算机断层扫描 (CT) 特征，通过 Cox 比例风险 (PH) 模型来预测事件发生时间结果。对于一个协变量向量为 $\\mathbf{x}$ 且放射组学纹理特征为 $x_k$ 的患者，其风险函数建模为 $h(t \\mid \\mathbf{x}) = h_0(t)\\exp(\\mathbf{x}^\\top \\boldsymbol{\\beta})$，其中 $h_0(t)$ 是基线风险，$\\boldsymbol{\\beta}$ 是未知的回归系数。与特征 $x_k$ 每增加一个单位相关联的风险比为 $\\exp(\\beta_k)$。假设该模型通过偏似然法进行拟合，$\\beta_k$ 的估计量（记为 $\\hat{\\beta}_k$）的估计方差为 $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)$，该方差从观测信息的逆矩阵中获得。在标准的大样本正则性条件下，$\\hat{\\beta}_k$ 近似服从正态分布。在一个肺癌患者队列中，对于某个纹理特征 $x_k$，模型拟合得出 $\\hat{\\beta}_k = 0.40$ 且 $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k) = 0.0225$。设 $\\alpha = 0.05$。哪个选项正确地使用 $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)$ 为风险比 $\\exp(\\beta_k)$ 构建了 $100(1-\\alpha)\\%$ 置信区间 (CI)，并给出了其数值？\n\nA. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)})] = [1.11,\\ 2.00]$。\n\nB. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha/2}\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha/2}\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k))] = [1.43,\\ 1.56]$。\n\nC. $[\\exp(\\hat{\\beta}_k) - z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)},\\ \\exp(\\hat{\\beta}_k) + z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}] = [1.20,\\ 1.79]$。\n\nD. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)})] = [1.17,\\ 1.91]$。",
            "solution": "问题陈述在科学和统计上都是合理的。它提出了生存分析中的一个标准任务：为一个从Cox比例风险模型中导出的风险比构建置信区间。所有必要的信息都已提供，问题定义明确。\n\n目标是为风险比 $HR = \\exp(\\beta_k)$ 构建一个 $100(1-\\alpha)\\%$ 的置信区间 (CI)。\n给定的数据如下：\n- 对数风险系数的点估计值：$\\hat{\\beta}_k = 0.40$。\n- 估计量的估计方差：$\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k) = 0.0225$。\n- 显著性水平：$\\alpha = 0.05$。\n\n问题陈述指出估计量 $\\hat{\\beta}_k$ 近似服从正态分布。这是最大偏似然估计的大样本理论中的一个标准结果。因此，我们首先为参数 $\\beta_k$ 构建一个置信区间，然后对其进行变换以获得 $\\exp(\\beta_k)$ 的置信区间。\n\n步骤1：为 $\\beta_k$ 构建 $100(1-\\alpha)\\%$ 置信区间。\n对于一个服从正态分布的估计量，其双侧置信区间的通用公式是：\n$$ \\text{CI}_{\\beta_k} = \\left[ \\hat{\\beta}_k - z_{1-\\alpha/2} \\cdot \\mathrm{SE}(\\hat{\\beta}_k), \\quad \\hat{\\beta}_k + z_{1-\\alpha/2} \\cdot \\mathrm{SE}(\\hat{\\beta}_k) \\right] $$\n其中 $\\mathrm{SE}(\\hat{\\beta}_k)$ 是估计量的标准误，$z_{1-\\alpha/2}$ 是标准正态分布的上 $1-\\alpha/2$ 分位数。\n\n首先，我们根据给定的方差计算标准误 ($\\mathrm{SE}$):\n$$ \\mathrm{SE}(\\hat{\\beta}_k) = \\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)} = \\sqrt{0.0225} = 0.15 $$\n\n接下来，我们求临界值 $z_{1-\\alpha/2}$。当 $\\alpha = 0.05$ 时，我们需要标准正态分布的 $1 - 0.05/2 = 0.975$ 分位数。\n$$ z_{0.975} \\approx 1.96 $$\n\n现在，我们可以计算 $\\beta_k$ 的 $95\\%$ 置信区间：\n$$ \\text{CI}_{\\beta_k} = [0.40 - 1.96 \\times 0.15, \\quad 0.40 + 1.96 \\times 0.15] $$\n$$ \\text{CI}_{\\beta_k} = [0.40 - 0.294, \\quad 0.40 + 0.294] $$\n$$ \\text{CI}_{\\beta_k} = [0.106, \\quad 0.694] $$\n\n步骤2：将 $\\beta_k$ 的置信区间转换为风险比 $HR = \\exp(\\beta_k)$ 的置信区间。\n指数函数 $f(x) = \\exp(x)$ 是严格递增且单调的。因此，我们可以通过对 $\\beta_k$ 置信区间的端点应用该函数来获得 $HR$ 的置信区间。这种方法，称为变换法（在此上下文中也称为对数变换法），可以保持覆盖概率。\n风险比置信区间的通用形式是：\n$$ \\text{CI}_{\\exp(\\beta_k)} = \\left[ \\exp\\left(\\hat{\\beta}_k - z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}\\right), \\quad \\exp\\left(\\hat{\\beta}_k + z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}\\right) \\right] $$\n\n使用计算出的 $\\beta_k$ 区间：\n$$ \\text{下界} = \\exp(0.106) \\approx 1.11183 $$\n$$ \\text{上界} = \\exp(0.694) \\approx 2.00171 $$\n\n四舍五入到小数点后两位，风险比的 $95\\%$ 置信区间为 $[1.11, 2.00]$。\n\n现在，我们评估每个选项：\n\nA. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)})] = [1.11,\\ 2.00]$。\n该选项展示了构建风险比置信区间的正确公式，即首先在对数风险（线性预测器）尺度上找到置信区间，然后对端点取指数。如上所述，其数值计算也是正确的。\n结论：**正确**。\n\nB. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha/2}\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha/2}\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k))] = [1.43,\\ 1.56]$。\n此选项在构建对数风险尺度的区间时，错误地使用了方差 $\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)$，而不是标准误 $\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}$。误差范围必须与估计量具有相同的单位，这要求使用标准误。该公式在量纲上和统计上都是不正确的。\n结论：**不正确**。\n\nC. $[\\exp(\\hat{\\beta}_k) - z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)},\\ \\exp(\\hat{\\beta}_k) + z_{1-\\alpha/2}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}] = [1.20,\\ 1.79]$。\n此选项错误地围绕风险比的点估计值 $\\exp(\\hat{\\beta}_k)$ 构建了一个对称的置信区间。估计量 $\\exp(\\hat{\\beta}_k)$ 服从对数正态分布，而不是正态分布。在此尺度上使用对称置信区间是不合适的，并且可能导致下界小于0。正确的方法是在满足正态性假设的尺度（即 $\\beta_k$ 尺度）上构建置信区间，然后进行变换。\n结论：**不正确**。\n\nD. $[\\exp(\\hat{\\beta}_k - z_{1-\\alpha}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)}),\\ \\exp(\\hat{\\beta}_k + z_{1-\\alpha}\\sqrt{\\widehat{\\mathrm{Var}}(\\hat{\\beta}_k)})] = [1.17,\\ 1.91]$。\n此选项为双侧 $100(1-\\alpha)\\%$ 置信区间使用了错误的临界值 $z_{1-\\alpha}$。双侧区间需要将总误差概率 $\\alpha$ 分成两个大小为 $\\alpha/2$ 的尾部，因此必须使用临界值 $z_{1-\\alpha/2}$。使用 $z_{1-\\alpha}$（这里 $z_{0.95} \\approx 1.645$）将对应于一个 $100(1-2\\alpha)\\% = 90\\%$ 的置信区间，而不是 $95\\%$ 的置信区间。\n结论：**不正确**。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "要真正掌握Cox模型，理解其生成过程——即生存时间如何从其底层结构中产生——是极其宝贵的。本模拟练习  要求你实现逆变换采样方法，以便从具有指定基线风险和特征效应的Cox模型中生成数据。这种实践将巩固你对基线风险、线性预测器和生存函数之间相互作用的理解，从而搭建起从理论到数据生成的桥梁。",
            "id": "4534752",
            "problem": "您的任务是实现一个模拟程序，使用Cox比例风险(PH)模型为由影像组学特征代表的患者生成生存时间。Cox比例风险模型指定，以影像组学特征的协变量向量为条件的风险函数与基线风险成比例。您必须根据生存函数和风险函数的基本定义，推导并实现用于生成生存时间的逆变换采样。\n\n从以下基本定义和事实出发：\n- 以协变量为条件的风险函数定义为 $h(t \\mid \\boldsymbol{x}) = h_0(t)\\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$，其中 $h_0(t)$ 是基线风险函数，$\\boldsymbol{x}$ 是协变量向量。\n- 累积风险函数定义为 $H(t) = \\int_{0}^{t} h(s)\\,\\mathrm{d}s$，生存函数通过 $S(t) = \\exp(-H(t))$ 与累积风险相关。\n- 逆变换采样需要抽取一个均匀随机变量 $U$，其中 $U \\sim \\mathrm{Uniform}(0,1)$，并求解 $S(T \\mid \\boldsymbol{x}) = U$ 以得到 $T$。\n\n您必须：\n- 使用上述基础，推导所需的逆映射，以便从指定的基线累积风险和线性预测器 $\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}$ 生成生存时间 $T$（单位：月）。\n- 为三种科学上常见的基线累积风险族实现逆变换算法：\n  1. 指数基线：$H_0(t) = \\lambda t$，速率参数 $\\lambda$ 的单位为 月$^{-1}$。\n  2. 威布尔基线：$H_0(t) = \\left(\\dfrac{t}{\\lambda}\\right)^{\\kappa}$，尺度参数 $\\lambda$ 的单位为 月，形状参数 $\\kappa$ 无量纲。\n  3. 分段常数基线风险：$h_0(t)$ 在覆盖 $[0,\\infty)$ 的连续区间上等于常数速率，产生一个可通过分段选择来求逆的分段线性基线累积风险 $H_0(t)$。\n\n最终的生存时间以月为单位表示。将每个生成的生存时间四舍五入到 $6$ 位小数。该算法必须是确定性的，通过使用提供的均匀值 $U$ 进行逆变换采样（无需生成随机数）。\n\n实现您的程序，为以下参数值测试套件计算生存时间。每个测试用例包括基线风险设定、协变量向量 $\\boldsymbol{x}$、系数向量 $\\boldsymbol{\\beta}$ 和均匀变量 $U$。\n\n测试套件：\n- 案例 1 (指数基线)：\n  - 基线参数：$\\lambda = 0.05$ 月$^{-1}$。\n  - 协变量：$\\boldsymbol{x} = [0.5,-0.2,1.0]$。\n  - 系数：$\\boldsymbol{\\beta} = [0.3,0.1,-0.4]$。\n  - 均匀变量：$U = 0.25$。\n- 案例 2 (威布尔基线)：\n  - 基线参数：$\\lambda = 12$ 月，$\\kappa = 1.5$。\n  - 协变量：$\\boldsymbol{x} = [-1.0,0.0,2.0]$。\n  - 系数：$\\boldsymbol{\\beta} = [0.2,-0.5,0.3]$。\n  - 均匀变量：$U = 0.8$。\n- 案例 3 (分段常数基线风险，第一区间结果)：\n  - 基线风险率和区间端点：当 $t \\in [0,6]$ 月时，$h_0(t)=0.02$；当 $t \\in (6,18]$ 月时，$h_0(t)=0.10$；当 $t \\in (18,\\infty)$ 月时，$h_0(t)=0.03$。\n  - 协变量：$\\boldsymbol{x} = [2.0,1.0,-0.5]$。\n  - 系数：$\\boldsymbol{\\beta} = [0.05,0.4,0.6]$。\n  - 均匀变量：$U = 0.999$。\n- 案例 4 (指数基线，大线性预测器边缘情况)：\n  - 基线参数：$\\lambda = 0.01$ 月$^{-1}$。\n  - 协变量：$\\boldsymbol{x} = [10.0,-10.0,5.0]$。\n  - 系数：$\\boldsymbol{\\beta} = [0.5,-0.4,0.2]$。\n  - 均匀变量：$U = 0.5$。\n- 案例 5 (威布尔基线，极小 $U$ 边缘情况)：\n  - 基线参数：$\\lambda = 24$ 月，$\\kappa = 2.0$。\n  - 协变量：$\\boldsymbol{x} = [1.5,-0.5,0.2]$。\n  - 系数：$\\boldsymbol{\\beta} = [-0.3,0.7,-0.1]$。\n  - 均匀变量：$U = 10^{-12}$。\n- 案例 6 (分段常数基线风险，后续区间结果)：\n  - 基线风险率和区间端点：当 $t \\in [0,6]$ 月时，$h_0(t)=0.02$；当 $t \\in (6,18]$ 月时，$h_0(t)=0.10$；当 $t \\in (18,\\infty)$ 月时，$h_0(t)=0.03$。\n  - 协变量：$\\boldsymbol{x} = [2.0,1.0,-0.5]$。\n  - 系数：$\\boldsymbol{\\beta} = [0.05,0.4,0.6]$。\n  - 均匀变量：$U = 0.01$。\n\n您的程序应生成单行输出，其中包含 $6$ 个案例的生存时间（单位：月），每个时间四舍五入到 $6$ 位小数，格式为逗号分隔的列表并用方括号括起。例如，输出格式必须与 $[t_1,t_2,t_3,t_4,t_5,t_6]$ 完全一样，其中每个 $t_i$ 是一个浮点数，代表案例 $i$ 的生存时间（单位：月）。",
            "solution": "该问题要求推导并实现一种算法，使用逆变换采样从Cox比例风险(PH)模型生成生存时间。解决方案首先推导出生存时间 $T$ 的通用公式，然后将该公式特化用于三种常见的基线风险族：指数、威布尔和分段常数。\n\n**1. Cox PH模型逆变换采样的通用推导**\n\nCox比例风险模型由具有协变量向量 $\\boldsymbol{x}$ 的个体的风险函数定义：\n$$h(t \\mid \\boldsymbol{x}) = h_0(t)\\exp(\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta})$$\n其中 $h_0(t)$ 是基线风险函数，$\\boldsymbol{\\beta}$ 是系数向量，$\\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}$ 是线性预测器。为方便起见，令线性预测器为 $\\eta = \\boldsymbol{x}^{\\top}\\boldsymbol{\\beta}$。\n\n累积风险函数 $H(t \\mid \\boldsymbol{x})$ 是风险函数从 $0$ 到 $t$ 的积分：\n$$H(t \\mid \\boldsymbol{x}) = \\int_{0}^{t} h(s \\mid \\boldsymbol{x}) \\, \\mathrm{d}s = \\int_{0}^{t} h_0(s)\\exp(\\eta) \\, \\mathrm{d}s$$\n由于 $\\exp(\\eta)$ 相对于积分变量 $s$ 是常数，我们可以将其提出：\n$$H(t \\mid \\boldsymbol{x}) = \\exp(\\eta) \\int_{0}^{t} h_0(s) \\, \\mathrm{d}s = \\exp(\\eta) H_0(t)$$\n其中 $H_0(t) = \\int_{0}^{t} h_0(s) \\, \\mathrm{d}s$ 是基线累积风险函数。\n\n生存函数 $S(t \\mid \\boldsymbol{x})$ 给出了存活超过时间 $t$ 的概率，并与累积风险函数相关：\n$$S(t \\mid \\boldsymbol{x}) = \\exp(-H(t \\mid \\boldsymbol{x})) = \\exp(-H_0(t)\\exp(\\eta))$$\n\n逆变换采样是一种从累积分布函数为 $F(t)$ 的分布中生成随机样本 $T$ 的方法。它通过生成一个均匀随机数 $U \\sim \\mathrm{Uniform}(0,1)$ 并求解 $F(T)=U$ 来得到 $T$。在生存分析中，使用生存函数 $S(t) = 1-F(t)$ 更为方便。如果 $U \\sim \\mathrm{Uniform}(0,1)$，那么 $1-U$ 也服从 $\\mathrm{Uniform}(0,1)$ 分布。因此，我们可以等价地求解 $S(T)=U$ 以得到 $T$。\n\n设 $S(T \\mid \\boldsymbol{x}) = U$：\n$$U = \\exp(-H_0(T)\\exp(\\eta))$$\n为了求解 $T$，我们逐步对该方程进行逆运算：\n\\begin{align*}\n\\ln(U) = -H_0(T)\\exp(\\eta) \\\\\n-\\ln(U) = H_0(T)\\exp(\\eta) \\\\\nH_0(T) = -\\ln(U)\\exp(-\\eta)\n\\end{align*}\n最后，我们将基线累积风险函数的逆函数 $H_0^{-1}$ 应用于等式两边，以分离出 $T$：\n$$T = H_0^{-1}(-\\ln(U)\\exp(-\\eta))$$\n这就是通用公式。$T$ 的具体形式取决于基线累积风险函数 $H_0(t)$ 及其逆函数 $H_0^{-1}$ 的选择。我们定义量 $V = -\\ln(U)\\exp(-\\eta)$。问题简化为求解 $T = H_0^{-1}(V)$。\n\n**2. 针对特定基线风险族的推导**\n\n**A. 指数基线风险**\n指数基线给出了一个恒定的基线风险 $h_0(t) = \\lambda$。基线累积风险为：\n$$H_0(t) = \\int_{0}^{t} \\lambda \\, \\mathrm{d}s = \\lambda t$$\n为了求逆函数 $H_0^{-1}$，我们令 $y = H_0(t) = \\lambda t$ 并求解 $t$：\n$$t = \\frac{y}{\\lambda} \\implies H_0^{-1}(y) = \\frac{y}{\\lambda}$$\n将 $V$ 代入此逆函数，得到生存时间 $T$：\n$$T = H_0^{-1}(V) = \\frac{V}{\\lambda} = \\frac{-\\ln(U)\\exp(-\\eta)}{\\lambda}$$\n\n**B. 威布尔基线风险**\n对于威布尔分布，基线累积风险由形状参数 $\\kappa$ 和尺度参数 $\\lambda$ 参数化：\n$$H_0(t) = \\left(\\frac{t}{\\lambda}\\right)^{\\kappa}$$\n为了求逆函数 $H_0^{-1}$，我们令 $y = (t/\\lambda)^{\\kappa}$ 并求解 $t$：\n\\begin{align*}\ny^{1/\\kappa} = \\frac{t}{\\lambda} \\\\\nt = \\lambda y^{1/\\kappa} \\implies H_0^{-1}(y) = \\lambda y^{1/\\kappa}\n\\end{align*}\n将 $V$ 代入此逆函数，得到生存时间 $T$：\n$$T = H_0^{-1}(V) = \\lambda V^{1/\\kappa} = \\lambda \\left(-\\ln(U)\\exp(-\\eta)\\right)^{1/\\kappa}$$\n\n**C. 分段常数基线风险**\n在这种情况下，基线风险 $h_0(t)$ 是一个阶梯函数，在一组划分了 $[0, \\infty)$ 的不相交时间区间上为常数。令定义区间的时间点为 $0 = \\tau_0  \\tau_1  \\dots  \\tau_m$，并令第 $i$ 个区间 $(\\tau_{i-1}, \\tau_i]$ 内的恒定风险为 $c_i$。\n\n基线累积风险 $H_0(t)$ 是一个连续的分段线性函数。对于第 $i$ 个区间中的 $t$，即 $t \\in (\\tau_{i-1}, \\tau_i]$，$H_0(t)$ 计算如下：\n$$H_0(t) = H_0(\\tau_{i-1}) + c_i(t - \\tau_{i-1})$$\n其中 $H_0(\\tau_{i-1})$ 是前一个区间末尾的累积风险，且 $H_0(\\tau_0) = H_0(0) = 0$。\n\n为了求解 $T = H_0^{-1}(V)$，我们必须首先确定 $T$ 属于哪个区间 $i$。这通过将 $V$ 的值与在区间边界上预先计算的累积风险值 $H_0(\\tau_j)$（其中 $j=0, 1, \\dots, m-1$）进行比较来完成。如果我们发现 $H_0(\\tau_{i-1})  V \\le H_0(\\tau_i)$，那么我们知道 $T$ 位于区间 $(\\tau_{i-1}, \\tau_i]$ 内。\n\n然后我们可以对该区间的线性方程求逆以找到 $T$：\n\\begin{align*}\nV = H_0(\\tau_{i-1}) + c_i(T - \\tau_{i-1}) \\\\\nV - H_0(\\tau_{i-1}) = c_i(T - \\tau_{i-1}) \\\\\n\\frac{V - H_0(\\tau_{i-1})}{c_i} = T - \\tau_{i-1} \\\\\nT = \\tau_{i-1} + \\frac{V - H_0(\\tau_{i-1})}{c_i}\n\\end{align*}\n此公式适用于所有区间，包括第一个区间，其中 $\\tau_0=0$ 且 $H_0(\\tau_0)=0$。对于最后一个区间 $(\\tau_{m-1}, \\infty)$，条件是 $V > H_0(\\tau_{m-1})$。",
            "answer": "```python\nimport numpy as np\n\ndef _calculate_exponential_time(params, x, beta, u):\n    \"\"\"\n    为指数基线风险计算生存时间。\n    \n    公式: T = (-log(U) * exp(-eta)) / lambda\n    \"\"\"\n    lambda_param = params['lambda']\n    eta = np.dot(x, beta)\n    \n    # 使用 np.log 和 np.exp 以确保数值稳定性\n    # `u` 是一个标量值。\n    if u == 0 or u >= 1:\n        # 处理 log(u) 的边缘情况\n        if u == 0: return np.inf\n        if u >= 1: return 0.0\n\n    neg_log_u = -np.log(u)\n    exp_neg_eta = np.exp(-eta)\n    \n    time = (neg_log_u * exp_neg_eta) / lambda_param\n    return time\n\ndef _calculate_weibull_time(params, x, beta, u):\n    \"\"\"\n    为威布尔基线风险计算生存时间。\n    \n    公式: T = lambda * (-log(U) * exp(-eta))^(1/kappa)\n    \"\"\"\n    lambda_param = params['lambda']\n    kappa_param = params['kappa']\n    eta = np.dot(x, beta)\n    \n    if u == 0 or u >= 1:\n        if u == 0: return np.inf\n        if u >= 1: return 0.0\n\n    neg_log_u = -np.log(u)\n    exp_neg_eta = np.exp(-eta)\n    \n    base = neg_log_u * exp_neg_eta\n    time = lambda_param * np.power(base, 1.0 / kappa_param)\n    return time\n\ndef _calculate_piecewise_time(params, x, beta, u):\n    \"\"\"\n    为分段常数基线风险计算生存时间。\n    \n    公式: T = tau_{i-1} + (V - H_0(tau_{i-1})) / c_i\n    其中 V = -log(U) * exp(-eta)\n    \"\"\"\n    rates = params['rates']\n    endpoints = params['endpoints']\n    eta = np.dot(x, beta)\n    \n    if u == 0 or u >= 1:\n        if u == 0: return np.inf\n        if u >= 1: return 0.0\n\n    V = -np.log(u) * np.exp(-eta)\n    \n    # 区间断点\n    tau_points = [0] + endpoints\n    \n    # 预计算每个断点处的累积风险\n    H0_at_tau = [0.0]\n    current_H0 = 0.0\n    for i in range(len(rates) - 1): # 遍历有界区间\n        interval_duration = tau_points[i+1] - tau_points[i]\n        current_H0 += rates[i] * interval_duration\n        H0_at_tau.append(current_H0)\n\n    # 找到正确的区间并计算时间\n    for i in range(len(H0_at_tau)):\n        H0_prev = H0_at_tau[i]\n        tau_prev = tau_points[i]\n        \n        # 检查 V 是否落在下一个区间内\n        # 如果存在，下一个断点是 H0_at_tau[i+1]\n        if i + 1  len(H0_at_tau):\n            H0_next = H0_at_tau[i+1]\n            if V = H0_next:\n                time = tau_prev + (V - H0_prev) / rates[i]\n                return time\n        else:\n            # 这是最后一个无界区间\n            time = tau_prev + (V - H0_prev) / rates[i]\n            return time\n    \n    # 对于有效的输入，不应到达此处\n    return np.nan\n\n\ndef solve():\n    \"\"\"\n    解决所有测试用例的主函数。\n    \"\"\"\n    test_cases = [\n        # 案例 1 (指数基线)\n        {\n            \"type\": \"exponential\",\n            \"params\": {\"lambda\": 0.05},\n            \"x\": np.array([0.5, -0.2, 1.0]),\n            \"beta\": np.array([0.3, 0.1, -0.4]),\n            \"U\": 0.25,\n        },\n        # 案例 2 (威布尔基线)\n        {\n            \"type\": \"weibull\",\n            \"params\": {\"lambda\": 12, \"kappa\": 1.5},\n            \"x\": np.array([-1.0, 0.0, 2.0]),\n            \"beta\": np.array([0.2, -0.5, 0.3]),\n            \"U\": 0.8,\n        },\n        # 案例 3 (分段常数基线风险, 第一区间结果)\n        {\n            \"type\": \"piecewise\",\n            \"params\": {\"rates\": [0.02, 0.10, 0.03], \"endpoints\": [6, 18]},\n            \"x\": np.array([2.0, 1.0, -0.5]),\n            \"beta\": np.array([0.05, 0.4, 0.6]),\n            \"U\": 0.999,\n        },\n        # 案例 4 (指数基线, 大线性预测器边缘情况)\n        {\n            \"type\": \"exponential\",\n            \"params\": {\"lambda\": 0.01},\n            \"x\": np.array([10.0, -10.0, 5.0]),\n            \"beta\": np.array([0.5, -0.4, 0.2]),\n            \"U\": 0.5,\n        },\n        # 案例 5 (威布尔基线, 极小 U 边缘情况)\n        {\n            \"type\": \"weibull\",\n            \"params\": {\"lambda\": 24, \"kappa\": 2.0},\n            \"x\": np.array([1.5, -0.5, 0.2]),\n            \"beta\": np.array([-0.3, 0.7, -0.1]),\n            \"U\": 1e-12,\n        },\n        # 案例 6 (分段常数基线风险, 后续区间结果)\n        {\n            \"type\": \"piecewise\",\n            \"params\": {\"rates\": [0.02, 0.10, 0.03], \"endpoints\": [6, 18]},\n            \"x\": np.array([2.0, 1.0, -0.5]),\n            \"beta\": np.array([0.05, 0.4, 0.6]),\n            \"U\": 0.01,\n        },\n    ]\n\n    results = []\n    \n    # 调度器映射\n    solvers = {\n        \"exponential\": _calculate_exponential_time,\n        \"weibull\": _calculate_weibull_time,\n        \"piecewise\": _calculate_piecewise_time,\n    }\n\n    for case in test_cases:\n        solver_func = solvers[case[\"type\"]]\n        time = solver_func(case[\"params\"], case[\"x\"], case[\"beta\"], case[\"U\"])\n        results.append(round(time, 6))\n\n    # 严格按照要求格式化最终输出字符串。\n    # 使用格式说明符以确保一致的6位小数。\n    formatted_results = [f\"{r:.6f}\" for r in results]\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```"
        }
    ]
}