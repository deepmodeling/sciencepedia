{
    "hands_on_practices": [
        {
            "introduction": "The Standardized Uptake Value ($SUV$) is a cornerstone of quantitative Positron Emission Tomography (PET) imaging. This first practice focuses on the fundamental calculation of the body-weight normalized $SUV$ ($SUV_{bw}$). By working through this problem , you will apply the core principles of radioactive decay and activity normalization to translate raw imaging data into a meaningful clinical metric.",
            "id": "4555037",
            "problem": "A whole-body Positron Emission Tomography (PET) study using Fluorine-18 ($^{18}\\mathrm{F}$) is performed on a patient of body mass $m_{bw}=70\\,\\mathrm{kg}$. Immediately before injection at time $t=0$, the syringe activity is measured as $A_{pre}=310\\,\\mathrm{MBq}$, and immediately after injection (negligible delay relative to $t=0$), the residual syringe activity is measured as $A_{post}=7\\,\\mathrm{MBq}$. The scan starts at $t=60\\,\\mathrm{min}$ after injection. The PET image is reconstructed decay-corrected to the scan start time, and a lesion’s mean activity concentration at scan start is reported as $C_t=8.5\\,\\mathrm{kBq}/\\mathrm{ml}$. The physical half-life of $^{18}\\mathrm{F}$ is $T_{1/2}=109.77\\,\\mathrm{min}$. Assume soft-tissue density is approximately $1\\,\\mathrm{g}/\\mathrm{ml}$.\n\nUsing only the radioactive decay law for activity and the definition of the body-mass–normalized Standardized Uptake Value (SUV) as the ratio of tissue activity concentration to injected activity per unit body mass, with all quantities referenced to the same time point (scan start), compute the body weight normalized standardized uptake value $SUV_{bw}$ for this lesion, including appropriate decay correction of the net injected activity to the scan start.\n\nExpress the final $SUV_{bw}$ as a pure number (no units) and round your answer to three significant figures.",
            "solution": "The problem is well-posed and scientifically grounded. We will proceed to a complete solution.\n\nThe objective is to compute the body-mass–normalized Standardized Uptake Value ($SUV_{bw}$) for a lesion observed in a Positron Emission Tomography (PET) scan. The problem defines this quantity as the ratio of the tissue activity concentration to the injected activity per unit body mass, with all quantities referenced to the same time point. The specified time point is the scan start time, $t$.\n\nThe formula for $SUV_{bw}$ is therefore:\n$$\nSUV_{bw} = \\frac{C_{t}}{\\left(\\frac{A_{inj,t}}{m_{bw}}\\right)}\n$$\nwhere:\n-   $C_{t}$ is the mean activity concentration in the lesion at the scan start time $t$.\n-   $A_{inj,t}$ is the net injected radioactive dose, decay-corrected to the scan start time $t$.\n-   $m_{bw}$ is the patient's body mass.\n\nTo ensure that $SUV_{bw}$ is a dimensionless quantity, the units of the numerator and the denominator must be equivalent. The numerator, $C_t$, is given in units of activity per volume ($\\mathrm{kBq}/\\mathrm{ml}$). The denominator is in units of activity per mass ($\\mathrm{kBq}/\\mathrm{g}$, once conversions are made). The problem provides the assumption that soft-tissue density is $\\rho = 1\\,\\mathrm{g}/\\mathrm{ml}$, which establishes the equivalence between volume in milliliters ($\\mathrm{ml}$) and mass in grams ($\\mathrm{g}$).\n\nThe solution proceeds in the following steps:\n1.  Calculate the net injected activity at the time of injection, $t = 0$.\n2.  Use the radioactive decay law to correct this activity to the scan start time, $t = 60\\,\\mathrm{min}$.\n3.  Substitute all quantities with consistent units into the $SUV_{bw}$ formula and compute the final value.\n\n**Step 1: Net Injected Activity at $t=0$**\n\nThe net injected activity, $A_{inj,0}$, is the difference between the pre-injection syringe activity, $A_{pre}$, and the post-injection residual activity, $A_{post}$.\nGiven:\n-   $A_{pre} = 310\\,\\mathrm{MBq}$\n-   $A_{post} = 7\\,\\mathrm{MBq}$\n\n$$\nA_{inj,0} = A_{pre} - A_{post} = 310\\,\\mathrm{MBq} - 7\\,\\mathrm{MBq} = 303\\,\\mathrm{MBq}\n$$\n\n**Step 2: Decay Correction of Injected Activity**\n\nThe activity of a radionuclide decays exponentially over time according to the radioactive decay law:\n$$\nA(t) = A_0 \\exp(-\\lambda t)\n$$\nwhere $A_0$ is the initial activity, $t$ is the elapsed time, and $\\lambda$ is the decay constant. The decay constant is related to the half-life, $T_{1/2}$, by:\n$$\n\\lambda = \\frac{\\ln(2)}{T_{1/2}}\n$$\nWe need to find the injected activity at the scan start time, $A_{inj,t}$, given the activity at $t=0$, which is $A_{inj,0}$.\nGiven:\n-   Scan start time: $t = 60\\,\\mathrm{min}$\n-   Half-life of $^{18}\\mathrm{F}$: $T_{1/2} = 109.77\\,\\mathrm{min}$\n\nSubstituting the expression for $\\lambda$ into the decay law:\n$$\nA_{inj,t} = A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)\n$$\nPlugging in the numerical values:\n$$\nA_{inj,t} = (303\\,\\mathrm{MBq}) \\exp\\left(-\\frac{\\ln(2) \\cdot 60\\,\\mathrm{min}}{109.77\\,\\mathrm{min}}\\right)\n$$\n\n**Step 3: Calculation of $SUV_{bw}$**\n\nWe can now assemble the complete expression for $SUV_{bw}$:\n$$\nSUV_{bw} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,t}} = \\frac{C_{t} \\cdot m_{bw}}{A_{inj,0} \\exp\\left(-\\frac{\\ln(2) \\cdot t}{T_{1/2}}\\right)}\n$$\nBefore we substitute the values, we must ensure all units are consistent. Let's convert all quantities to a base system of units:\n-   Lesion activity concentration: $C_t = 8.5\\,\\mathrm{kBq}/\\mathrm{ml}$\n-   Patient body mass: $m_{bw} = 70\\,\\mathrm{kg} = 70 \\times 10^3\\,\\mathrm{g} = 70000\\,\\mathrm{g}$\n-   Net injected activity at $t=0$: $A_{inj,0} = 303\\,\\mathrm{MBq} = 303 \\times 10^3\\,\\mathrm{kBq} = 303000\\,\\mathrm{kBq}$\n-   Time: $t=60\\,\\mathrm{min}$\n-   Half-life: $T_{1/2}=109.77\\,\\mathrm{min}$\n\nSubstituting these values into the expression for $SUV_{bw}$:\n$$\nSUV_{bw} = \\frac{(8.5\\,\\mathrm{kBq}/\\mathrm{ml}) \\cdot (70000\\,\\mathrm{g})}{(303000\\,\\mathrm{kBq}) \\cdot \\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right)}\n$$\nAs previously noted, the term $\\mathrm{g}/\\mathrm{ml}$ is effectively unity due to the density assumption, and the activity units ($\\mathrm{kBq}$) cancel, yielding a dimensionless result.\n\nFirst, let's evaluate the exponential term (the decay factor):\n$$\n\\exp\\left(-\\frac{\\ln(2) \\cdot 60}{109.77}\\right) \\approx \\exp\\left(-\\frac{0.693147 \\cdot 60}{109.77}\\right) \\approx \\exp(-0.37884) \\approx 0.684654\n$$\nNow, substitute this back into the main equation:\n$$\nSUV_{bw} \\approx \\frac{8.5 \\cdot 70000}{303000 \\cdot 0.684654}\n$$\n$$\nSUV_{bw} \\approx \\frac{595000}{207439.84} \\approx 2.86828\n$$\nThe problem requires the final answer to be rounded to three significant figures.\n$$\nSUV_{bw} \\approx 2.87\n$$\nThe body weight normalized standardized uptake value for the lesion is $2.87$.",
            "answer": "$$\\boxed{2.87}$$"
        },
        {
            "introduction": "While the formula for $SUV$ is straightforward, its accuracy in clinical practice depends on correctly measuring its components. This exercise  explores a common technical confounder: tracer extravasation, where a portion of the dose fails to enter systemic circulation. You will quantify the resulting bias, gaining a crucial understanding of how technical errors can impact quantitative results and clinical interpretation.",
            "id": "4555058",
            "problem": "A Positron Emission Tomography (PET) study is performed using a glucose analog tracer where the Standardized Uptake Value (SUV) is defined by the foundational relationship that normalizes the measured activity concentration to the injected activity per unit body mass: the SUV is proportional to the quotient of the measured activity concentration in a volume of interest divided by the injected activity per unit body mass. In routine practice, the injected activity is computed from a pre-injection syringe assay and a post-injection residual assay, both decay-corrected to the time of injection. Consider a case in which an extravasation at the injection site causes some tracer to remain locally near the injection site and not participate in the systemic distribution. Assume that the measured tissue activity concentration in a target lesion and the patient body mass remain the same regardless of whether the injected activity is computed with or without correcting for extravasation, and that all assay values are decay-corrected to the injection time. \n\nLet the pre-injection syringe activity be $A_{\\mathrm{pre}} = 300\\,\\mathrm{MBq}$, the post-injection residual syringe activity be $A_{\\mathrm{post}} = 5\\,\\mathrm{MBq}$, and the activity extravasated near the injection site be $A_{\\mathrm{ex}} = 10\\,\\mathrm{MBq}$. The nominal injected activity used in standard SUV computation (ignoring extravasation) is $A_{\\mathrm{nom}} = A_{\\mathrm{pre}} - A_{\\mathrm{post}}$, whereas the effective activity available to the systemic circulation is $A_{\\mathrm{eff}} = A_{\\mathrm{nom}} - A_{\\mathrm{ex}}$.\n\nDefine the SUV fractional bias $b$ introduced by ignoring extravasation as the relative difference between the SUV computed with $A_{\\mathrm{nom}}$ and the SUV that would be obtained using the correct $A_{\\mathrm{eff}}$:\n$$\nb \\equiv \\frac{\\mathrm{SUV}_{\\mathrm{meas}} - \\mathrm{SUV}_{\\mathrm{true}}}{\\mathrm{SUV}_{\\mathrm{true}}}.\n$$\nA negative value indicates an underestimation of the true SUV. Using only the definitions above and first principles, compute $b$ for the given values of $A_{\\mathrm{pre}}$, $A_{\\mathrm{post}}$, and $A_{\\mathrm{ex}}$. Express your final result as a pure decimal number with no units, and round your answer to four significant figures.",
            "solution": "The problem is validated as self-contained, scientifically grounded, and well-posed. All necessary data and definitions are provided, and no contradictions or ambiguities are present. The scenario described is a standard consideration in quantitative PET imaging.\n\nThe Standardized Uptake Value (SUV) is defined as being proportional to the ratio of the measured tissue activity concentration, $C_{\\mathrm{tissue}}$, to the injected activity per unit body mass. Let the patient's body mass be $M$ and the injected activity be $A_{\\mathrm{inj}}$. The relationship can be expressed as:\n$$\n\\mathrm{SUV} = \\kappa \\frac{C_{\\mathrm{tissue}}}{A_{\\mathrm{inj}} / M}\n$$\nwhere $\\kappa$ is a proportionality constant, which is typically equal to $1$ when units are appropriately managed (e.g., $C_{\\mathrm{tissue}}$ in $\\mathrm{kBq/mL}$ and $A_{\\mathrm{inj}}/M$ in $\\mathrm{kBq/g}$, assuming tissue density of $1\\,\\mathrm{g/mL}$). The problem states that $C_{\\mathrm{tissue}}$ and $M$ are constant regardless of the extravasation. We can therefore combine all constant terms into a single constant, $K$:\n$$\nK = \\kappa C_{\\mathrm{tissue}} M\n$$\nThis allows the SUV to be expressed as a simpler inverse relationship with the injected activity:\n$$\n\\mathrm{SUV} = \\frac{K}{A_{\\mathrm{inj}}}\n$$\nThe problem defines two different SUV values based on two different calculations of the injected activity. The measured SUV, $\\mathrm{SUV}_{\\mathrm{meas}}$, is calculated using the nominal injected activity, $A_{\\mathrm{nom}}$. This is the standard calculation which incorrectly assumes all activity leaving the syringe enters the systemic circulation.\n$$\n\\mathrm{SUV}_{\\mathrm{meas}} = \\frac{K}{A_{\\mathrm{nom}}}\n$$\nThe true SUV, $\\mathrm{SUV}_{\\mathrm{true}}$, is the value that would be obtained if the calculation correctly accounted for the extravasated activity, $A_{\\mathrm{ex}}$. This means using the effective activity, $A_{\\mathrm{eff}}$, which is the portion of the tracer that actually reaches the systemic circulation.\n$$\n\\mathrm{SUV}_{\\mathrm{true}} = \\frac{K}{A_{\\mathrm{eff}}}\n$$\nThe fractional bias, $b$, is defined as:\n$$\nb \\equiv \\frac{\\mathrm{SUV}_{\\mathrm{meas}} - \\mathrm{SUV}_{\\mathrm{true}}}{\\mathrm{SUV}_{\\mathrm{true}}}\n$$\nSubstituting the expressions for $\\mathrm{SUV}_{\\mathrm{meas}}$ and $\\mathrm{SUV}_{\\mathrm{true}}$ into the definition of bias:\n$$\nb = \\frac{\\frac{K}{A_{\\mathrm{nom}}} - \\frac{K}{A_{\\mathrm{eff}}}}{\\frac{K}{A_{\\mathrm{eff}}}}\n$$\nThe constant $K$ cancels from the numerator and denominator, confirming that the bias is independent of patient mass and tissue activity concentration, as expected.\n$$\nb = \\frac{\\frac{1}{A_{\\mathrm{nom}}} - \\frac{1}{A_{\\mathrm{eff}}}}{\\frac{1}{A_{\\mathrm{eff}}}}\n$$\nThis expression can be simplified by multiplying the numerator and denominator by $A_{\\mathrm{eff}}$:\n$$\nb = \\left( \\frac{1}{A_{\\mathrm{nom}}} - \\frac{1}{A_{\\mathrm{eff}}} \\right) A_{\\mathrm{eff}} = \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{nom}}} - \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{eff}}} = \\frac{A_{\\mathrm{eff}}}{A_{\\mathrm{nom}}} - 1\n$$\nNow, we compute the numerical values for $A_{\\mathrm{nom}}$ and $A_{\\mathrm{eff}}$ using the given data:\n- Pre-injection syringe activity: $A_{\\mathrm{pre}} = 300\\,\\mathrm{MBq}$\n- Post-injection residual syringe activity: $A_{\\mathrm{post}} = 5\\,\\mathrm{MBq}$\n- Extravasated activity: $A_{\\mathrm{ex}} = 10\\,\\mathrm{MBq}$\n\nThe nominal injected activity is:\n$$\nA_{\\mathrm{nom}} = A_{\\mathrm{pre}} - A_{\\mathrm{post}} = 300\\,\\mathrm{MBq} - 5\\,\\mathrm{MBq} = 295\\,\\mathrm{MBq}\n$$\nThe effective activity available to the systemic circulation is this nominal activity minus the extravasated portion:\n$$\nA_{\\mathrm{eff}} = A_{\\mathrm{nom}} - A_{\\mathrm{ex}} = 295\\,\\mathrm{MBq} - 10\\,\\mathrm{MBq} = 285\\,\\mathrm{MBq}\n$$\nNow, substitute these values into the derived expression for the bias $b$:\n$$\nb = \\frac{285}{295} - 1\n$$\nPerforming the calculation:\n$$\nb \\approx 0.9661016949... - 1 = -0.033898305...\n$$\nThe problem requires the result to be rounded to four significant figures. The first non-zero digit is $3$ in the hundredths place, so we keep it and the next three digits. The fifth significant digit is $8$, which is $\\ge 5$, so we round up the fourth significant digit ($9$).\n$$\nb \\approx -0.03390\n$$\nThe negative sign indicates that the measured SUV is an underestimation of the true SUV, which is consistent with using a larger-than-actual injected activity ($A_{\\mathrm{nom}} > A_{\\mathrm{eff}}$) in the denominator of the SUV calculation.",
            "answer": "$$\\boxed{-0.03390}$$"
        },
        {
            "introduction": "This final practice elevates your skills from single calculations to building a complete radiomics workflow. Here , you will implement a program to compute a suite of advanced $SUV$ metrics, including lean-body-mass normalized $SUV_{lbm}$ and spatial metrics like $SUV_{max}$ and $SUV_{peak}$. This comprehensive exercise synthesizes all the core concepts and demonstrates how they are applied in practice to extract rich, quantitative information from PET imaging data.",
            "id": "4554997",
            "problem": "A developer is tasked with implementing a program to compute four quantitative radiomics metrics based on the Standardized Uptake Value (SUV) for a segmented lesion in Positron Emission Tomography (PET). The requested metrics are body-weight normalized SUV ($SUV_{bw}$), lean-body-mass normalized SUV ($SUV_{lbm}$), peak SUV ($SUV_{peak}$), and maximum SUV ($SUV_{max}$). The program must start from first principles: the exponential radioactive decay law and unit-consistent normalization of activity concentration by administered activity per reference mass, and must incorporate residual activity and decay corrections to the scan time. All computations must be consistent with scientific realism and correct unit handling.\n\nFundamental principles and definitions:\n- Radioactive decay for a radionuclide with half-life $T_{1/2}$: if an activity $A_0$ is measured at a reference time, then the activity at time $t$ is $$A(t) = A_0 \\cdot 2^{-t/T_{1/2}}.$$\n- Activity concentration $C_t$ measured at scan time is a physical quantity in kilobecquerel per milliliter (kBq/mL).\n- The net administered activity at the time of injection is the difference between the pre-injection activity and the residual post-injection activity, both measured at the time of injection. This net activity must be decay-corrected to the scan time using the exponential decay law.\n- The body-weight normalized SUV is defined as the ratio between tissue activity concentration and administered activity per unit body mass. Unit consistency requires mass to be in grams for comparability with milliliters (assuming $1$ milliliter approximately corresponds to $1$ gram of tissue). The lean-body-mass normalized SUV replaces body mass with lean body mass.\n- Lean Body Mass (LBM) should be computed using the Janmahasatian formulation, where body mass is in kilograms and height is in meters, and then converted to grams for unit consistency:\n  - For males: $$LBM = \\frac{9270 \\cdot W}{6680 + 216 \\cdot BMI},$$\n  - For females: $$LBM = \\frac{9270 \\cdot W}{8780 + 244 \\cdot BMI},$$\n  where $$BMI = \\frac{W}{H^2},$$ with $W$ in kilograms and $H$ in meters.\n\nDefinitions to apply precisely:\n- Let $A_{pre}$ and $A_{post}$ be the measured pre-injection activity and post-injection residual activity at injection time, both in megabecquerel (MBq). The net administered activity at injection time is $$A_{inj} = A_{pre} - A_{post}.$$ To obtain the administered activity at scan time (uptake time) $t$ (in minutes), decay-correct $$A_{scan} = A_{inj} \\cdot 2^{-t/T_{1/2}}.$$ Convert $A_{scan}$ to kilobecquerel (kBq) by multiplying by $1000$.\n- Given a $C_t$ map in kBq/mL at scan time, and a binary lesion mask of the same shape, restrict all spatial summaries to voxels where the mask equals $1$.\n- Compute the voxel-wise body-weight normalized SUV map $$SUV_{bw}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot M_{g}}{A_{scan,kBq}},$$ where $M_{g}$ is the total body mass in grams ($kg \\times 1000$).\n- Compute the voxel-wise lean-body-mass normalized SUV map $$SUV_{lbm}(\\mathbf{r}) = \\frac{C_t(\\mathbf{r}) \\cdot LBM_{g}}{A_{scan,kBq}},$$ where $LBM_{g}$ is the lean body mass in grams ($kg \\times 1000$).\n- Compute $$SUV_{max} = \\max_{\\mathbf{r} \\in \\text{lesion}} SUV_{bw}(\\mathbf{r}).$$\n- Compute $$SUV_{peak}$$ as the maximum mean of $SUV_{bw}$ over all contiguous $3 \\times 3 \\times 3$ voxel kernels fully contained within the lesion mask. If the lesion mask does not contain any fully-contained $3 \\times 3 \\times 3$ kernel, define $$SUV_{peak} = SUV_{max}.$$\n\nAll physical quantities and units:\n- $C_t$ map entries are in kBq/mL, at the scan time.\n- $A_{pre}$ and $A_{post}$ are in MBq, measured at injection time.\n- Uptake time $t$ is in minutes.\n- Half-life $T_{1/2}$ is in minutes.\n- Body mass is in kilograms and height is in centimeters; use meters when computing body mass index (BMI).\n- Express all final SUV metrics as unitless floats rounded to four decimal places.\n\nTest Suite:\nImplement your program to compute $SUV_{bw}$, $SUV_{lbm}$, $SUV_{peak}$, and $SUV_{max}$ for each of the following three parameter sets. Each test case provides:\n- a $C_t$ map (as a $z \\times y \\times x$ array),\n- a lesion mask of the same shape,\n- $A_{pre}$ (MBq),\n- $A_{post}$ (MBq),\n- body mass (kg),\n- height (cm),\n- sex ($\\text{male}$ or $\\text{female}$),\n- uptake time $t$ (minutes),\n- half-life $T_{1/2}$ (minutes).\n\nCase $1$ (general case, male, nonzero residual, nonzero uptake):\n- $A_{pre} = 370$ MBq, $A_{post} = 5$ MBq, $M = 80$ kg, $H = 180$ cm, sex $=$ male, $t = 60$ minutes, $T_{1/2} = 109.77$ minutes.\n- $C_t$ map ($4 \\times 4 \\times 4$):\n  - $z=0$:\n    - $y=0$: $[2.2, 2.4, 2.5, 2.3]$,\n    - $y=1$: $[2.5, 3.0, 3.2, 2.6]$,\n    - $y=2$: $[2.3, 2.9, 3.1, 2.4]$,\n    - $y=3$: $[2.1, 2.2, 2.3, 2.0]$.\n  - $z=1$:\n    - $y=0$: $[2.4, 3.1, 3.5, 2.6]$,\n    - $y=1$: $[3.2, 8.5, 12.0, 4.0]$,\n    - $y=2$: $[3.1, 10.0, 14.5, 4.2]$,\n    - $y=3$: $[2.6, 4.3, 5.0, 3.0]$.\n  - $z=2$:\n    - $y=0$: $[2.3, 3.0, 3.4, 2.5]$,\n    - $y=1$: $[3.1, 9.0, 13.0, 4.1]$,\n    - $y=2$: $[3.0, 11.5, 16.0, 4.4]$,\n    - $y=3$: $[2.5, 4.5, 5.2, 3.1]$.\n  - $z=3$:\n    - $y=0$: $[2.2, 2.8, 3.0, 2.3]$,\n    - $y=1$: $[2.9, 4.0, 4.5, 3.2]$,\n    - $y=2$: $[2.8, 4.2, 4.8, 3.3]$,\n    - $y=3$: $[2.3, 3.2, 3.5, 2.6]$.\n- Lesion mask ($4 \\times 4 \\times 4$): ones for indices $z \\in \\{1,2,3\\}$, $y \\in \\{1,2,3\\}$, $x \\in \\{1,2,3\\}$; zeros elsewhere.\n\nCase $2$ (boundary case: zero residual, zero uptake, female):\n- $A_{pre} = 185$ MBq, $A_{post} = 0$ MBq, $M = 55$ kg, $H = 165$ cm, sex $=$ female, $t = 0$ minutes, $T_{1/2} = 109.77$ minutes.\n- $C_t$ map ($3 \\times 3 \\times 3$):\n  - $z=0$:\n    - $y=0$: $[6.0, 7.0, 6.5]$,\n    - $y=1$: $[6.8, 8.0, 7.2]$,\n    - $y=2$: $[6.2, 7.5, 6.7]$.\n  - $z=1$:\n    - $y=0$: $[7.0, 9.0, 7.5]$,\n    - $y=1$: $[8.5, 12.5, 9.0]$,\n    - $y=2$: $[7.2, 9.5, 7.8]$.\n  - $z=2$:\n    - $y=0$: $[6.5, 7.8, 7.0]$,\n    - $y=1$: $[7.5, 10.5, 8.2]$,\n    - $y=2$: $[6.8, 8.7, 7.1]$.\n- Lesion mask ($3 \\times 3 \\times 3$): ones everywhere.\n\nCase $3$ (edge case: very high residual leading to small net activity, nonzero uptake, male; lesion too small for a $3 \\times 3 \\times 3$ kernel so $SUV_{peak}$ falls back to $SUV_{max}$):\n- $A_{pre} = 100$ MBq, $A_{post} = 90$ MBq, $M = 100$ kg, $H = 175$ cm, sex $=$ male, $t = 120$ minutes, $T_{1/2} = 109.77$ minutes.\n- $C_t$ map ($3 \\times 3 \\times 3$):\n  - $z=0$:\n    - $y=0$: $[3.0, 4.0, 3.5]$,\n    - $y=1$: $[4.5, 6.0, 5.0]$,\n    - $y=2$: $[3.2, 4.8, 3.8]$.\n  - $z=1$:\n    - $y=0$: $[4.0, 5.0, 4.3]$,\n    - $y=1$: $[6.5, 9.0, 7.5]$,\n    - $y=2$: $[4.0, 6.2, 5.0]$.\n  - $z=2$:\n    - $y=0$: $[3.5, 4.2, 3.7]$,\n    - $y=1$: $[5.2, 7.0, 6.0]$,\n    - $y=2$: $[3.6, 5.5, 4.2]$.\n- Lesion mask ($3 \\times 3 \\times 3$): ones for indices $z \\in \\{0,1\\}$, $y \\in \\{0,1\\}$, $x \\in \\{0,1\\}$; zeros elsewhere.\n\nRequired final outputs:\n- For each test case, compute and round to four decimal places the four floats $[SUV_{bw}, SUV_{lbm}, SUV_{peak}, SUV_{max}]$.\n- Your program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element is the list for one test case. For example, the output format must be exactly of the form $$\\texttt{[[s11,s12,s13,s14],[s21,s22,s23,s24],[s31,s32,s33,s34]]},$$ with each $s_{ij}$ a float in decimal notation (rounded to four decimal places).",
            "solution": "The problem statement is assessed to be valid. It is scientifically grounded in the principles of nuclear medicine and quantitative imaging, specifically Positron Emission Tomography (PET). The problem is well-posed, providing all necessary physical constants, patient data, imaging data, and explicit mathematical formulations for the radiomic metrics to be computed. The definitions for Standardized Uptake Value (SUV), including body-weight and lean-body-mass normalizations, radioactive decay, and peak SUV, are precise and consistent with practices in the field. The use of the Janmahasatian formulation for lean body mass is a specific and valid choice. The units are clearly stated and their handling, particularly the conversion between mass and volume based on an assumed tissue density of $1 \\text{ g/mL}$, is explicitly justified and correct. The test cases are well-defined and cover general, boundary, and edge conditions, ensuring a comprehensive test of the implementation. There are no contradictions, ambiguities, or factual errors.\n\nThe solution proceeds by first establishing a general computational framework based on the provided definitions and principles. This framework is then applied systematically to each of the three test cases. An ambiguity in the output specification for $SUV_{bw}$ and $SUV_{lbm}$ (which are defined as voxel-wise maps but requested as single floats) is resolved by the most scientifically reasonable interpretation: these values represent the mean SUV over the entire lesion volume.\n\n### General Computational Methodology\n\nFor each test case, the following sequence of calculations is performed:\n\n1.  **Activity Calculation**: The net administered activity at injection time, $A_{inj}$, is calculated in megabecquerels ($MBq$):\n    $$A_{inj} = A_{pre} - A_{post}$$\n    This activity is then decay-corrected to the scan time $t$ using the provided half-life $T_{1/2}$:\n    $$A_{scan} [MBq] = A_{inj} \\cdot 2^{-t/T_{1/2}}$$\n    For use in the SUV formula, this activity is converted to kilobecquerels ($kBq$):\n    $$A_{scan,kBq} = A_{scan} [MBq] \\cdot 1000$$\n\n2.  **Mass and LBM Calculation**: The patient's body mass $M$ in kilograms ($kg$) and height $H$ in centimeters ($cm$) are converted to grams ($g$) and meters ($m$), respectively.\n    $$M_g = M [kg] \\cdot 1000$$\n    $$H_m = H [cm] / 100$$\n    The Body Mass Index ($BMI$) is computed as:\n    $$BMI = \\frac{M [kg]}{H_m^2}$$\n    The Lean Body Mass ($LBM$) in $kg$ is calculated using the sex-specific Janmahasatian formulation:\n    $$LBM_{male} [kg] = \\frac{9270 \\cdot M [kg]}{6680 + 216 \\cdot BMI}$$\n    $$LBM_{female} [kg] = \\frac{9270 \\cdot M [kg]}{8780 + 244 \\cdot BMI}$$\n    $LBM$ is then converted to grams for unit consistency in the SUV calculation:\n    $$LBM_g = LBM [kg] \\cdot 1000$$\n\n3.  **SUV Calculation**: The voxel-wise $SUV_{bw}$ map is computed. It is convenient to first calculate a conversion factor, $F_{bw}$:\n    $$F_{bw} = \\frac{M_g}{A_{scan,kBq}}$$\n    Then, for each voxel located at position $\\mathbf{r}$:\n    $$SUV_{bw}(\\mathbf{r}) = C_t(\\mathbf{r}) \\cdot F_{bw}$$\n    where $C_t(\\mathbf{r})$ is the activity concentration in $kBq/mL$. The $SUV_{lbm}$ values are derived by scaling the $SUV_{bw}$ values:\n    $$SUV_{lbm}(\\mathbf{r}) = SUV_{bw}(\\mathbf{r}) \\cdot \\frac{LBM_g}{M_g}$$\n\n4.  **Radiomic Metrics Calculation**: The four required metrics are computed from the $SUV_{bw}$ map and the lesion mask.\n    -   $SUV_{bw,mean}$: The mean of $SUV_{bw}(\\mathbf{r})$ for all voxels $\\mathbf{r}$ within the lesion (where the mask is $1$).\n    -   $SUV_{lbm,mean}$: The mean of $SUV_{lbm}(\\mathbf{r})$ for all voxels $\\mathbf{r}$ within the lesion. This is equivalent to $SUV_{bw,mean} \\cdot \\frac{LBM_g}{M_g}$.\n    -   $SUV_{max}$: The maximum value of $SUV_{bw}(\\mathbf{r})$ over all voxels $\\mathbf{r}$ within the lesion.\n    -   $SUV_{peak}$: The maximum of the mean $SUV_{bw}$ values calculated over all possible contiguous $3 \\times 3 \\times 3$ voxel kernels that are fully contained within the lesion. If no such kernel exists, $SUV_{peak} = SUV_{max}$.\n\n### Application to Test Cases\n\n#### Case 1\n- **Inputs**: $A_{pre} = 370$ MBq, $A_{post} = 5$ MBq, $M = 80$ kg, $H = 180$ cm, sex=male, $t = 60$ min, $T_{1/2} = 109.77$ min.\n- **Activity**: $A_{inj} = 370 - 5 = 365$ MBq. $A_{scan} = 365 \\cdot 2^{-60/109.77} \\approx 250.40096$ MBq. $A_{scan,kBq} \\approx 250400.96$ kBq.\n- **Mass**: $M_g = 80000$ g. $H_m = 1.8$ m. $BMI = 80 / (1.8^2) \\approx 24.6914$. $LBM \\approx \\frac{9270 \\cdot 80}{6680 + 216 \\cdot 24.6914} \\approx 61.7284$ kg. $LBM_g \\approx 61728.4$ g.\n- **SUV Factors**: $F_{bw} = 80000 / 250400.96 \\approx 0.319488$. Ratio $\\frac{LBM_g}{M_g} \\approx 0.771605$.\n- **Lesion Data**: The lesion is a $3 \\times 3 \\times 3$ sub-volume. The sum of $C_t$ values within the lesion is $169.6$ kBq/mL over $27$ voxels. Mean $C_t = 169.6 / 27 \\approx 6.2815$ kBq/mL. The maximum $C_t$ is $16.0$ kBq/mL.\n- **Metrics**:\n    -   $SUV_{bw,mean} = 6.2815 \\cdot 0.319488 \\approx 2.0068$.\n    -   $SUV_{lbm,mean} = 2.0068 \\cdot 0.771605 \\approx 1.5485$.\n    -   $SUV_{max} = 16.0 \\cdot 0.319488 \\approx 5.1118$.\n    -   $SUV_{peak}$: The lesion is a $3 \\times 3 \\times 3$ volume, so only one $3 \\times 3 \\times 3$ kernel can be fully contained. Its mean is the lesion's mean. Thus, $SUV_{peak} = SUV_{bw,mean} \\approx 2.0068$.\n- **Result**: $[2.0068, 1.5485, 2.0068, 5.1118]$\n\n#### Case 2\n- **Inputs**: $A_{pre} = 185$ MBq, $A_{post} = 0$ MBq, $M = 55$ kg, $H = 165$ cm, sex=female, $t = 0$ min, $T_{1/2} = 109.77$ min.\n- **Activity**: $A_{inj} = 185 - 0 = 185$ MBq. Since $t=0$, $A_{scan} = 185$ MBq. $A_{scan,kBq} = 185000$ kBq.\n- **Mass**: $M_g = 55000$ g. $H_m = 1.65$ m. $BMI = 55 / (1.65^2) \\approx 20.2020$. $LBM \\approx \\frac{9270 \\cdot 55}{8780 + 244 \\cdot 20.2020} \\approx 37.1901$ kg. $LBM_g \\approx 37190.1$ g.\n- **SUV Factors**: $F_{bw} = 55000 / 185000 = 11/37 \\approx 0.297297$. Ratio $\\frac{LBM_g}{M_g} \\approx 0.676184$.\n- **Lesion Data**: The lesion is the entire $3 \\times 3 \\times 3$ volume. Sum of $C_t = 210.0$ kBq/mL over $27$ voxels. Mean $C_t = 210.0 / 27 \\approx 7.7778$ kBq/mL. Maximum $C_t = 12.5$ kBq/mL.\n- **Metrics**:\n    -   $SUV_{bw,mean} = (210/27) \\cdot (11/37) \\approx 2.3123$.\n    -   $SUV_{lbm,mean} = 2.3123 \\cdot 0.676184 \\approx 1.5635$.\n    -   $SUV_{max} = 12.5 \\cdot (11/37) \\approx 3.7162$.\n    -   $SUV_{peak}$: Similar to Case 1, the lesion is a $3 \\times 3 \\times 3$ volume, so $SUV_{peak} = SUV_{bw,mean} \\approx 2.3123$.\n- **Result**: $[2.3123, 1.5635, 2.3123, 3.7162]$\n\n#### Case 3\n- **Inputs**: $A_{pre} = 100$ MBq, $A_{post} = 90$ MBq, $M = 100$ kg, $H = 175$ cm, sex=male, $t = 120$ min, $T_{1/2} = 109.77$ min.\n- **Activity**: $A_{inj} = 100 - 90 = 10$ MBq. $A_{scan} = 10 \\cdot 2^{-120/109.77} \\approx 4.68840$ MBq. $A_{scan,kBq} \\approx 4688.40$ kBq.\n- **Mass**: $M_g = 100000$ g. $H_m = 1.75$ m. $BMI = 100 / (1.75^2) \\approx 32.6531$. $LBM \\approx \\frac{9270 \\cdot 100}{6680 + 216 \\cdot 32.6531} \\approx 67.5020$ kg. $LBM_g \\approx 67502.0$ g.\n- **SUV Factors**: $F_{bw} = 100000 / 4688.40 \\approx 21.3292$. Ratio $\\frac{LBM_g}{M_g} \\approx 0.675020$.\n- **Lesion Data**: The lesion is a $2 \\times 2 \\times 2$ sub-volume. Sum of $C_t = 42.0$ kBq/mL over $8$ voxels. Mean $C_t = 42.0 / 8 = 5.25$ kBq/mL. Maximum $C_t = 9.0$ kBq/mL.\n- **Metrics**:\n    -   $SUV_{bw,mean} = 5.25 \\cdot 21.3292 \\approx 111.9785$.\n    -   $SUV_{lbm,mean} = 111.9785 \\cdot 0.675020 \\approx 75.5881$.\n    -   $SUV_{max} = 9.0 \\cdot 21.3292 \\approx 191.9632$.\n    -   $SUV_{peak}$: The lesion size is $2 \\times 2 \\times 2$, which is smaller than the $3 \\times 3 \\times 3$ kernel. No such kernel can be fully contained. Per the problem definition, $SUV_{peak} = SUV_{max} \\approx 191.9632$.\n- **Result**: $[111.9785, 75.5881, 191.9632, 191.9632]$\n\nThe following program implements this logic.",
            "answer": "```python\nimport numpy as np\n\ndef compute_metrics(C_t_map, lesion_mask, A_pre, A_post, M_kg, H_cm, sex, t_min, T_half_min):\n    \"\"\"\n    Computes SUV-based radiomics metrics for a single PET lesion case.\n    \n    Args:\n        C_t_map (np.ndarray): 3D array of activity concentration in kBq/mL.\n        lesion_mask (np.ndarray): 3D binary mask of the lesion.\n        A_pre (float): Pre-injection activity in MBq.\n        A_post (float): Post-injection residual activity in MBq.\n        M_kg (float): Patient body mass in kg.\n        H_cm (float): Patient height in cm.\n        sex (str): Patient sex, 'male' or 'female'.\n        t_min (float): Uptake time from injection to scan in minutes.\n        T_half_min (float): Radionuclide half-life in minutes.\n        \n    Returns:\n        list: A list of four floats [SUV_bw_mean, SUV_lbm_mean, SUV_peak, SUV_max].\n    \"\"\"\n    # Step 1: Activity Calculation\n    A_inj_MBq = A_pre - A_post\n    A_scan_MBq = A_inj_MBq * (2**(-t_min / T_half_min))\n    A_scan_kBq = A_scan_MBq * 1000\n\n    if A_scan_kBq == 0:\n        # Avoid division by zero if there's no activity\n        return [0.0, 0.0, 0.0, 0.0]\n\n    # Step 2: Mass and LBM Calculation\n    M_g = M_kg * 1000\n    H_m = H_cm / 100\n    \n    BMI = M_kg / (H_m**2)\n\n    if sex == 'male':\n        LBM_kg = (9270 * M_kg) / (6680 + 216 * BMI)\n    elif sex == 'female':\n        LBM_kg = (9270 * M_kg) / (8780 + 244 * BMI)\n    else:\n        raise ValueError(\"Sex must be 'male' or 'female'\")\n    LBM_g = LBM_kg * 1000\n\n    # Step 3: SUV Calculation\n    F_bw = M_g / A_scan_kBq\n    suv_bw_map = C_t_map * F_bw\n    \n    # Step 4: Radiomic Metrics Calculation\n    lesion_suv_bw_voxels = suv_bw_map[lesion_mask == 1]\n    \n    # Check if lesion is empty\n    if lesion_suv_bw_voxels.size == 0:\n        return [0.0, 0.0, 0.0, 0.0]\n\n    suv_bw_mean = np.mean(lesion_suv_bw_voxels)\n    \n    lbm_to_bw_ratio = LBM_g / M_g\n    suv_lbm_mean = suv_bw_mean * lbm_to_bw_ratio\n    \n    suv_max = np.max(lesion_suv_bw_voxels)\n\n    # SUV_peak calculation\n    kernel_means = []\n    # Iterate through all possible top-left-front corners of a 3x3x3 kernel\n    lim_z, lim_y, lim_x = [dim - 2 for dim in lesion_mask.shape]\n    if lim_z > 0 and lim_y > 0 and lim_x > 0:\n        for z in range(lim_z):\n            for y in range(lim_y):\n                for x in range(lim_x):\n                    # Define kernel regions for mask and SUV map\n                    mask_kernel = lesion_mask[z:z+3, y:y+3, x:x+3]\n                    \n                    # Check if the kernel is fully contained within the lesion\n                    if np.all(mask_kernel == 1):\n                        suv_kernel = suv_bw_map[z:z+3, y:y+3, x:x+3]\n                        kernel_means.append(np.mean(suv_kernel))\n\n    if not kernel_means:\n        suv_peak = suv_max\n    else:\n        suv_peak = max(kernel_means)\n\n    return [suv_bw_mean, suv_lbm_mean, suv_peak, suv_max]\n\ndef solve():\n    \"\"\"\n    Main function to run test cases and print results.\n    \"\"\"\n    test_cases = [\n        {\n            \"C_t_map\": np.array([\n                [[2.2, 2.4, 2.5, 2.3], [2.5, 3.0, 3.2, 2.6], [2.3, 2.9, 3.1, 2.4], [2.1, 2.2, 2.3, 2.0]],\n                [[2.4, 3.1, 3.5, 2.6], [3.2, 8.5, 12.0, 4.0], [3.1, 10.0, 14.5, 4.2], [2.6, 4.3, 5.0, 3.0]],\n                [[2.3, 3.0, 3.4, 2.5], [3.1, 9.0, 13.0, 4.1], [3.0, 11.5, 16.0, 4.4], [2.5, 4.5, 5.2, 3.1]],\n                [[2.2, 2.8, 3.0, 2.3], [2.9, 4.0, 4.5, 3.2], [2.8, 4.2, 4.8, 3.3], [2.3, 3.2, 3.5, 2.6]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [1, 2, 3], [1, 2, 3], [1, 2, 3]),\n            \"A_pre\": 370.0, \"A_post\": 5.0, \"M_kg\": 80.0, \"H_cm\": 180.0, \"sex\": \"male\", \"t_min\": 60.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[6.0, 7.0, 6.5], [6.8, 8.0, 7.2], [6.2, 7.5, 6.7]],\n                [[7.0, 9.0, 7.5], [8.5, 12.5, 9.0], [7.2, 9.5, 7.8]],\n                [[6.5, 7.8, 7.0], [7.5, 10.5, 8.2], [6.8, 8.7, 7.1]]\n            ]),\n            \"lesion_mask_def\": (\"all\",),\n            \"A_pre\": 185.0, \"A_post\": 0.0, \"M_kg\": 55.0, \"H_cm\": 165.0, \"sex\": \"female\", \"t_min\": 0.0, \"T_half_min\": 109.77\n        },\n        {\n            \"C_t_map\": np.array([\n                [[3.0, 4.0, 3.5], [4.5, 6.0, 5.0], [3.2, 4.8, 3.8]],\n                [[4.0, 5.0, 4.3], [6.5, 9.0, 7.5], [4.0, 6.2, 5.0]],\n                [[3.5, 4.2, 3.7], [5.2, 7.0, 6.0], [3.6, 5.5, 4.2]]\n            ]),\n            \"lesion_mask_def\": (\"indices\", [0, 1], [0, 1], [0, 1]),\n            \"A_pre\": 100.0, \"A_post\": 90.0, \"M_kg\": 100.0, \"H_cm\": 175.0, \"sex\": \"male\", \"t_min\": 120.0, \"T_half_min\": 109.77\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        shape = case[\"C_t_map\"].shape\n        mask = np.zeros(shape, dtype=int)\n        mask_def = case[\"lesion_mask_def\"]\n        if mask_def[0] == \"all\":\n            mask.fill(1)\n        elif mask_def[0] == \"indices\":\n            z_indices, y_indices, x_indices = mask_def[1], mask_def[2], mask_def[3]\n            for z in z_indices:\n                for y in y_indices:\n                    for x in x_indices:\n                        mask[z, y, x] = 1\n\n        results = compute_metrics(\n            case[\"C_t_map\"], mask, case[\"A_pre\"], case[\"A_post\"],\n            case[\"M_kg\"], case[\"H_cm\"], case[\"sex\"],\n            case[\"t_min\"], case[\"T_half_min\"]\n        )\n        all_results.append(results)\n    \n    # Format the final output string exactly as required\n    outer_parts = []\n    for res in all_results:\n        inner_parts = [f\"{val:.4f}\" for val in res]\n        outer_parts.append(f\"[{','.join(inner_parts)}]\")\n    \n    final_output_str = f\"[{','.join(outer_parts)}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}