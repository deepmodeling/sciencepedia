{
    "hands_on_practices": [
        {
            "introduction": "在评估任何模型之前，我们必须首先确保验证过程的完整性。第一个练习  揭示了动态系统中数据泄露这一严重陷阱，即来自未来的信息在不经意间污染了预测任务。通过解析地推导由此产生的偏差，您将深刻理解为何采用如滚动原点验证这样严格遵循时序的验证设计，对于获得可信的性能评估是必不可少的。",
            "id": "3921440",
            "problem": "考虑一个动态生物医学系统，其中一个潜在的生物标志物过程在离散时间中演化。令$X_t$表示时间$t$的生物标志物，令下一个时间点的感兴趣的临床结果为$Y_{t+1}$。该生物标志物遵循一个一阶自回归过程，\n$$\nX_{t+1} = \\phi X_t + \\eta_{t+1},\n$$\n其中$\\eta_{t+1}$是一个零均值新息，其方差为$\\sigma_{\\eta}^{2}$，且独立于$X_t$。临床结果根据以下公式生成\n$$\nY_{t+1} = \\beta X_{t+1} + \\epsilon_{t+1},\n$$\n其中$\\epsilon_{t+1}$是零均值噪声，其方差为$\\sigma_{\\epsilon}^{2}$，且独立于$X_t$和$\\eta_{t+1}$。在预测时间$t$，模型可用的真实信息集是$\\mathcal{I}_t = \\{X_t\\}$。\n\n假设一个从业者错误地使用了一个由未来协变量工程化的特征（一种数据泄露），具体来说是未来的生物标志物$X_{t+1}$本身，来估计均方误差下的预测性能。也就是说，他们使用信息集$\\mathcal{I}_{t+1}^{\\mathrm{leak}} = \\{X_{t+1}\\}$来评估模型，而这个信息集在实际部署时在时间$t$是不可用的。假设模型在平方损失下被最优构建，即它们达到了给定可用特征下结果的条件期望。\n\n仅使用平方损失下的条件期望和方差的基本定义，以及所述的独立性关系，推导一个由这种泄露引入的估计均方误差中的偏差的闭式解析表达式，该偏差定义为\n$$\n\\mathrm{Bias} = \\mathbb{E}\\!\\left[\\mathrm{MSE}_{\\mathrm{leak}}\\right] - \\mathbb{E}\\!\\left[\\mathrm{MSE}_{\\mathrm{deploy}}\\right],\n$$\n其中$\\mathrm{MSE}_{\\mathrm{leak}}$是使用$\\mathcal{I}_{t+1}^{\\mathrm{leak}} = \\{X_{t+1}\\}$进行评估时的均方误差，$\\mathrm{MSE}_{\\mathrm{deploy}}$是在时间$t$仅使用$\\mathcal{I}_t = \\{X_t\\}$进行预测时的均方误差。将最终答案表示为$\\beta$和$\\sigma_{\\eta}^{2}$的符号表达式。不需要四舍五入，也不需要物理单位。\n\n最后，提出一种科学合理的预测验证设计，在动态生物医学建模中避免此类泄露，确保训练、特征工程和评估都尊重按时间索引的数据可用性。",
            "solution": "该问题要求推导当未来信息泄露到动态生物医学模型的特征集中时，均方误差估计中的偏差。偏差定义为存在泄露时的期望均方误差（MSE）与正常部署场景下的期望MSE之差。我们将首先推导这两个期望MSE值的表达式，然后计算它们的差值。最后，将描述一个恰当的验证协议。\n\n该系统由两个方程定义：\n生物标志物过程：$X_{t+1} = \\phi X_t + \\eta_{t+1}$，其中$\\mathbb{E}[\\eta_{t+1}] = 0$且$\\mathrm{Var}(\\eta_{t+1}) = \\sigma_{\\eta}^{2}$。\n结果过程：$Y_{t+1} = \\beta X_{t+1} + \\epsilon_{t+1}$，其中$\\mathbb{E}[\\epsilon_{t+1}] = 0$且$\\mathrm{Var}(\\epsilon_{t+1}) = \\sigma_{\\epsilon}^{2}$。\n随机变量$\\eta_{t+1}$和$\\epsilon_{t+1}$彼此独立，且独立于$X_t$。\n\n问题陈述模型在平方损失下是最优的，这意味着预测是给定可用信息下结果的条件期望。\n\n首先，我们计算数据泄露下的期望MSE，$\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{leak}}]$。\n在这种情况下，从业者错误地使用了信息集$\\mathcal{I}_{t+1}^{\\mathrm{leak}} = \\{X_{t+1}\\}$。最优预测器是$\\hat{Y}_{t+1}^{\\mathrm{leak}} = \\mathbb{E}[Y_{t+1} | X_{t+1}]$。\n我们代入$Y_{t+1}$的定义：\n$$\n\\hat{Y}_{t+1}^{\\mathrm{leak}} = \\mathbb{E}[\\beta X_{t+1} + \\epsilon_{t+1} | X_{t+1}]\n$$\n利用条件期望的线性性质：\n$$\n\\hat{Y}_{t+1}^{\\mathrm{leak}} = \\mathbb{E}[\\beta X_{t+1} | X_{t+1}] + \\mathbb{E}[\\epsilon_{t+1} | X_{t+1}]\n$$\n由于$X_{t+1}$在条件集中是给定的，$\\mathbb{E}[\\beta X_{t+1} | X_{t+1}] = \\beta X_{t+1}$。\n噪声项$\\epsilon_{t+1}$独立于$X_t$和$\\eta_{t+1}$，因此也独立于$X_{t+1} = \\phi X_t + \\eta_{t+1}$。因此，以$X_{t+1}$为条件不会改变$\\epsilon_{t+1}$的期望：\n$$\n\\mathbb{E}[\\epsilon_{t+1} | X_{t+1}] = \\mathbb{E}[\\epsilon_{t+1}] = 0\n$$\n所以，带有泄露信息的预测器是$\\hat{Y}_{t+1}^{\\mathrm{leak}} = \\beta X_{t+1}$。\n\n这种情况下的均方误差是$\\mathrm{MSE}_{\\mathrm{leak}} = (Y_{t+1} - \\hat{Y}_{t+1}^{\\mathrm{leak}})^2$。其期望为：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{leak}}] = \\mathbb{E}\\left[\\left( (\\beta X_{t+1} + \\epsilon_{t+1}) - \\beta X_{t+1} \\right)^2\\right] = \\mathbb{E}[\\epsilon_{t+1}^2]\n$$\n由于$\\epsilon_{t+1}$的均值为$0$，其平方的期望等于其方差：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{leak}}] = \\mathrm{Var}(\\epsilon_{t+1}) = \\sigma_{\\epsilon}^{2}\n$$\n这个结果是直观的：如果未来的生物标志物$X_{t+1}$是已知的，那么唯一的预测误差来源是不可约的噪声$\\epsilon_{t+1}$。\n\n接下来，我们计算正常部署场景下的期望MSE，$\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}]$。\n在时间$t$的部署中，可用信息被正确指定为$\\mathcal{I}_t = \\{X_t\\}$。最优预测器是$\\hat{Y}_{t+1}^{\\mathrm{deploy}} = \\mathbb{E}[Y_{t+1} | X_t]$。\n我们代入$Y_{t+1}$和$X_{t+1}$的表达式：\n$$\n\\hat{Y}_{t+1}^{\\mathrm{deploy}} = \\mathbb{E}[\\beta X_{t+1} + \\epsilon_{t+1} | X_t] = \\mathbb{E}[\\beta(\\phi X_t + \\eta_{t+1}) + \\epsilon_{t+1} | X_t]\n$$\n利用期望的线性性质并分配条件：\n$$\n\\hat{Y}_{t+1}^{\\mathrm{deploy}} = \\mathbb{E}[\\beta \\phi X_t | X_t] + \\mathbb{E}[\\beta \\eta_{t+1} | X_t] + \\mathbb{E}[\\epsilon_{t+1} | X_t]\n$$\n由于$X_t$在条件集中是给定的，$\\mathbb{E}[\\beta \\phi X_t | X_t] = \\beta \\phi X_t$。\n新息$\\eta_{t+1}$独立于$X_t$，所以$\\mathbb{E}[\\beta \\eta_{t+1} | X_t] = \\beta \\mathbb{E}[\\eta_{t+1}] = \\beta \\cdot 0 = 0$。\n噪声$\\epsilon_{t+1}$也独立于$X_t$，所以$\\mathbb{E}[\\epsilon_{t+1} | X_t] = \\mathbb{E}[\\epsilon_{t+1}] = 0$。\n因此，正确的预测器是$\\hat{Y}_{t+1}^{\\mathrm{deploy}} = \\beta \\phi X_t$。\n\n部署的均方误差是$\\mathrm{MSE}_{\\mathrm{deploy}} = (Y_{t+1} - \\hat{Y}_{t+1}^{\\mathrm{deploy}})^2$。其期望为：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\mathbb{E}\\left[\\left( Y_{t+1} - \\beta \\phi X_t \\right)^2\\right]\n$$\n代入$Y_{t+1} = \\beta(\\phi X_t + \\eta_{t+1}) + \\epsilon_{t+1}$：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\mathbb{E}\\left[\\left( \\beta(\\phi X_t + \\eta_{t+1}) + \\epsilon_{t+1} - \\beta \\phi X_t \\right)^2\\right]\n$$\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\mathbb{E}\\left[\\left( \\beta \\eta_{t+1} + \\epsilon_{t+1} \\right)^2\\right]\n$$\n展开平方项：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\mathbb{E}[\\beta^2 \\eta_{t+1}^2 + 2\\beta \\eta_{t+1}\\epsilon_{t+1} + \\epsilon_{t+1}^2]\n$$\n根据期望的线性性质：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\beta^2 \\mathbb{E}[\\eta_{t+1}^2] + 2\\beta \\mathbb{E}[\\eta_{t+1}\\epsilon_{t+1}] + \\mathbb{E}[\\epsilon_{t+1}^2]\n$$\n我们知道$\\mathbb{E}[\\eta_{t+1}^2] = \\mathrm{Var}(\\eta_{t+1}) = \\sigma_{\\eta}^2$和$\\mathbb{E}[\\epsilon_{t+1}^2] = \\mathrm{Var}(\\epsilon_{t+1}) = \\sigma_{\\epsilon}^2$，因为两者均为零均值。由于$\\eta_{t+1}$和$\\epsilon_{t+1}$是独立的，它们乘积的期望是它们期望的乘积：$\\mathbb{E}[\\eta_{t+1}\\epsilon_{t+1}] = \\mathbb{E}[\\eta_{t+1}]\\mathbb{E}[\\epsilon_{t+1}] = 0 \\cdot 0 = 0$。\n代入这些值，我们得到：\n$$\n\\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}] = \\beta^2 \\sigma_{\\eta}^2 + 0 + \\sigma_{\\epsilon}^2 = \\beta^2 \\sigma_{\\eta}^2 + \\sigma_{\\epsilon}^2\n$$\n部署误差由两部分组成：不可约误差$\\sigma_{\\epsilon}^2$以及来自未来生物标志物演化不确定性的误差$\\beta^2 \\sigma_{\\eta}^2$。\n\n最后，我们计算由于泄露导致的估计MSE中的偏差。\n$$\n\\mathrm{Bias} = \\mathbb{E}[\\mathrm{MSE}_{\\mathrm{leak}}] - \\mathbb{E}[\\mathrm{MSE}_{\\mathrm{deploy}}]\n$$\n代入推导出的表达式：\n$$\n\\mathrm{Bias} = \\sigma_{\\epsilon}^{2} - \\left(\\beta^2 \\sigma_{\\eta}^2 + \\sigma_{\\epsilon}^2\\right) = -\\beta^2 \\sigma_{\\eta}^2\n$$\n偏差为负，表明泄露的MSE估计是乐观偏误的，低估了真实的预测误差。该偏差的大小与生物标志物效应大小的平方$\\beta^2$以及生物标志物新息过程的方差$\\sigma_{\\eta}^2$成正比。\n\n为了防止此类泄露，动态模型的科学合理的预测验证设计必须严格遵守数据的时间因果关系。一种标准且稳健的方法是**滚动原点验证**（也称为时间序列交叉验证或前向验证）。这个过程模拟了真实世界的场景，即随着新数据的出现，模型会定期重新训练。\n\n步骤如下：\n$1$. 数据集按时间顺序从时间$t=1$到$T$排列。\n$2$. 定义一个从时间$t=1$到$t=T_0$的初始训练集，其中$T_0  T$。\n$3$. 模型，包括所有特征工程步骤，仅使用区间$[1, T_0]$内的数据进行训练。关键的是，用于预测时间$t+1$结果的任何特征都必须从时间$t$或之前可用的信息中导出。\n$4$. 使用训练好的模型预测下一个时间点的结果$Y_{T_0+1}$。计算并存储预测误差，例如$(Y_{T_0+1} - \\hat{Y}_{T_0+1})^2$。\n$5$. 时间窗口向前推进一个步长。将$T_0+1$的新数据点并入训练集，该训练集现在跨越$[1, T_0+1]$（一个扩展窗口）或$[2, T_0+1]$（一个固定大小的滑动窗口）。\n$6$. 模型在这个更新后的训练集上重新训练，并对$Y_{T_0+2}$进行预测。记录误差。\n$7$. 这个滚动原点、重新训练和预测下一点的过程被重复，直到对整个期望的评估期（例如，直到时间$T$）都进行了预测。\n$8$. 然后通过对存储的每个步骤的预测误差求平均来计算整体模型性能指标，例如均方误差。\n\n这种方法确保在每个评估点，模型只接触到过去可用的信息，从而防止任何形式的未来数据污染，并提供对模型真实部署性能的现实、无偏的估计。",
            "answer": "$$\n\\boxed{- \\beta^{2} \\sigma_{\\eta}^{2}}\n$$"
        },
        {
            "introduction": "获得一组有效的预测后，下一步是使用恰当的度量标准来量化其质量。本练习  超越了简单的误差度量，介绍了严格正常评分规则 (strictly proper scoring rules)，该规则用于评估整个预测分布。您将推导并应用对数分数 (logarithmic score) 和连续分级概率分数 (Continuous Ranked Probability Score, CRPS)，并学习它们如何独特地惩罚预测的不同方面，从而对模型的校准度 (calibration) 和锐度 (sharpness) 进行全面评估。",
            "id": "3921410",
            "problem": "考虑一个用于2型糖尿病患者葡萄糖-胰岛素调节的经过验证的状态空间模型，其中时间点 $t+1$ 的毛细血管血糖测量值 $y_{t+1}$ 的提前一步预测分布，是根据时间点 $t$ 的滤波分布和历史数据 $\\mathcal{D}_t$ 得到的边际预测 $p(y_{t+1}\\mid \\mathcal{D}_t)$。假设该模型产生一个高斯预测 $y_{t+1}\\sim \\mathcal{N}(\\mu_{t+1\\mid t},\\sigma_{t+1\\mid t}^2)$，其中 $\\mu_{t+1\\mid t}=105$，$\\sigma_{t+1\\mid t}=15$ (单位均为毫克/分升，$\\mathrm{mg/dL}$)。实际测量值为 $y_{t+1}=130$ $\\mathrm{mg/dL}$。\n\n基于使用严格正常评分规则进行预测验证的基本原理，将对数分数定义为在观测值处评估的预测密度的自然对数，并将连续分级概率分数 (CRPS) 定义为预测累积分布函数与实际观测值的经验累积分布函数之间的积分平方差。从这些核心定义和高斯分布的性质出发，推导高斯预测分布的对数分数和CRPS的闭式表达式（用 $\\mu_{t+1\\mid t}$、$\\sigma_{t+1\\mid t}$ 和 $y_{t+1}$ 表示），然后使用上述给定值对它们进行数值计算。\n\n科学地解释每个分数惩罚预测性能的哪些方面，以及它们在评估动态生物医学模型的校准度和锐度方面如何互为补充。\n\n报告对数分数的数值（以自然信息单位“nats”为单位）和CRPS的数值（以 $\\mathrm{mg/dL}$ 为单位），并将两者都四舍五入到四位有效数字。将最终数值答案以单行矩阵的形式给出，其中第一个条目为对数分数，第二个条目为CRPS。",
            "solution": "该问题是有效的，因为它在统计预测和生物医学建模方面有科学依据，是适定的，并包含了推导出唯一解所需的所有信息。\n\n目标是针对给定的高斯预测预报和实际观测值，推导并评估两个严格正常评分规则：对数分数 ($S_{log}$) 和连续分级概率分数 ($S_{CRPS}$)。我们还将提供对这些分数的科学解释。\n\n血糖水平 $y_{t+1}$ 的预测分布为高斯分布 $y_{t+1} \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其均值 $\\mu = \\mu_{t+1\\mid t} = 105$，标准差 $\\sigma = \\sigma_{t+1\\mid t} = 15$。观测值为 $y = y_{t+1} = 130$。\n\n首先，我们处理对数分数。对数分数的定义是在实际观测值 $y$ 处评估的预测概率密度函数 (PDF) $p(y|\\mu, \\sigma^2)$ 的自然对数。高斯分布的PDF为：\n$$p(y|\\mu, \\sigma^2) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y-\\mu)^2}{2\\sigma^2}\\right)$$\n因此，对数分数 $S_{log}$ 为：\n$$S_{log} = \\ln(p(y|\\mu, \\sigma^2)) = \\ln\\left(\\frac{1}{\\sqrt{2\\pi\\sigma^2}} \\exp\\left(-\\frac{(y-\\mu)^2}{2\\sigma^2}\\right)\\right)$$\n利用对数的性质，我们可以分离各项以获得闭式表达式：\n$$S_{log} = \\ln\\left((2\\pi\\sigma^2)^{-1/2}\\right) - \\frac{(y-\\mu)^2}{2\\sigma^2} = -\\frac{1}{2}\\ln(2\\pi\\sigma^2) - \\frac{(y-\\mu)^2}{2\\sigma^2}$$\n这可以进一步写成：\n$$S_{log} = -\\ln(\\sigma) - \\frac{1}{2}\\ln(2\\pi) - \\frac{1}{2}\\left(\\frac{y-\\mu}{\\sigma}\\right)^2$$\n现在，我们代入给定的数值：$\\mu=105$，$\\sigma=15$，和 $y=130$。\n$$S_{log} = -\\ln(15) - \\frac{1}{2}\\ln(2\\pi) - \\frac{1}{2}\\left(\\frac{130 - 105}{15}\\right)^2$$\n$$S_{log} = -\\ln(15) - \\frac{1}{2}\\ln(2\\pi) - \\frac{1}{2}\\left(\\frac{25}{15}\\right)^2 = -\\ln(15) - \\frac{1}{2}\\ln(2\\pi) - \\frac{1}{2}\\left(\\frac{5}{3}\\right)^2$$\n$$S_{log} \\approx -2.70805 - \\frac{1}{2}(1.83788) - \\frac{1}{2}(2.77778) \\approx -2.70805 - 0.91894 - 1.38889 \\approx -5.01588$$\n四舍五入到四位有效数字，对数分数为 $-5.016$ nats。\n\n接下来，我们处理连续分级概率分数 ($S_{CRPS}$)。CRPS 定义为预测累积分布函数 (CDF) $F(z)$ 与观测值的经验 CDF（一个以 $y$ 为中心的 Heaviside 函数 $H(z-y)$）之间的积分平方差：\n$$S_{CRPS} = \\int_{-\\infty}^{\\infty} (F(z) - H(z-y))^2 dz$$\n另一种对于此推导更方便的表示法是 $S_{CRPS} = E_F[|X-y|] - \\frac{1}{2} E_F[|X-X'|]$，其中 $X$ 和 $X'$ 是从预测分布 $F$ 中抽取的独立随机变量。对于我们的高斯情况，$X, X' \\sim \\mathcal{N}(\\mu, \\sigma^2)$。\n\n我们来推导每一项。第二项 $\\frac{1}{2} E_F[|X-X'|]$ 仅取决于预测分布的离散程度。两个独立高斯变量之差 $X-X'$ 服从均值为 $\\mu-\\mu=0$、方差为 $\\sigma^2+\\sigma^2=2\\sigma^2$ 的高斯分布。令 $D = X-X' \\sim \\mathcal{N}(0, 2\\sigma^2)$。我们需要计算 $E[|D|]$，这是一个折叠正态分布的均值。\n$$E[|D|] = \\int_{-\\infty}^{\\infty} |d| \\frac{1}{\\sqrt{2\\pi(2\\sigma^2)}} \\exp\\left(-\\frac{d^2}{2(2\\sigma^2)}\\right) dd = 2 \\int_{0}^{\\infty} d \\frac{1}{2\\sigma\\sqrt{\\pi}} \\exp\\left(-\\frac{d^2}{4\\sigma^2}\\right) dd = \\frac{2\\sigma}{\\sqrt{\\pi}}$$\n因此，第二项是 $\\frac{1}{2}E[|D|] = \\frac{\\sigma}{\\sqrt{\\pi}}$。\n\n第一项 $E_F[|X-y|]$ 取决于预测和观测值。令 $z_{std} = (X-\\mu)/\\sigma$ 为标准正态变量，$z_{std} \\sim \\mathcal{N}(0, 1)$。则 $X = \\sigma z_{std} + \\mu$。期望变为：\n$$E_F[|X-y|] = E[|\\sigma z_{std} + \\mu - y|] = \\sigma E[|z_{std} - \\frac{y-\\mu}{\\sigma}|]$$\n令标准化观测值为 $z = \\frac{y-\\mu}{\\sigma}$。我们需要计算 $E[|z_{std}-z|]$。\n$$E[|z_{std}-z|] = \\int_{-\\infty}^{\\infty} |x-z|\\phi(x)dx = \\int_{-\\infty}^{z} (z-x)\\phi(x)dx + \\int_{z}^{\\infty} (x-z)\\phi(x)dx$$\n其中 $\\phi(x)$ 是标准正态PDF。利用 $\\int x\\phi(x)dx = -\\phi(x)$ 和 $\\int \\phi(x)dx = \\Phi(x)$（其中 $\\Phi(x)$ 是标准正态CDF）这两个事实，我们得到：\n$$E[|z_{std}-z|] = z\\Phi(z) + \\phi(z) - z(1-\\Phi(z)) + \\phi(z) = z(2\\Phi(z)-1) + 2\\phi(z)$$\n将此代回，得到 $E_F[|X-y|] = \\sigma \\left( z(2\\Phi(z)-1) + 2\\phi(z) \\right)$。\n\n结合这两项，高斯预测的 CRPS 的闭式表达式为：\n$$S_{CRPS} = \\sigma \\left[ z(2\\Phi(z) - 1) + 2\\phi(z) - \\frac{1}{\\sqrt{\\pi}} \\right]$$\n其中 $z = \\frac{y-\\mu}{\\sigma}$。我们现在代入数值：\n$$z = \\frac{130 - 105}{15} = \\frac{25}{15} = \\frac{5}{3}$$\n我们需要标准正态PDF $\\phi(z)$ 和 CDF $\\Phi(z)$ 在 $z=5/3 \\approx 1.6667$ 处的值。\n$\\phi(5/3) = \\frac{1}{\\sqrt{2\\pi}}\\exp\\left(-\\frac{1}{2}(\\frac{5}{3})^2\\right) \\approx 0.099471$\n$\\Phi(5/3) \\approx 0.952210$\n将这些值代入 CRPS 公式：\n$$S_{CRPS} = 15 \\left[ \\frac{5}{3}(2(0.952210) - 1) + 2(0.099471) - \\frac{1}{\\sqrt{\\pi}} \\right]$$\n$$S_{CRPS} \\approx 15 \\left[ 1.6667(0.90442) + 0.198942 - \\frac{1}{1.77245} \\right]$$\n$$S_{CRPS} \\approx 15 [1.50737 + 0.19894 - 0.56419] \\approx 15 [1.14212] \\approx 17.1318$$\n四舍五入到四位有效数字，CRPS 为 $17.13$ $\\mathrm{mg/dL}$。\n\n最后，对这些分数进行科学解释。\n对数分数 $S_{log} = \\ln(p(y))$ 根据模型为单个实际结果分配的密度来评估预测模型。它会严厉惩罚那些认为观测结果极不可能（即分配了低概率密度）的预测。预测分布极端尾部的一个观测值就可能导致一个绝对值很大的负分，从而可能在多次预测的平均分数中占据主导地位。这使其成为**校准度**的绝佳诊断工具，因为一个校准良好的模型不应系统性地被结果“惊吓”到。该分数由一个惩罚不准确性（$y$ 与 $\\mu$ 的距离）的项和一个惩罚锐度不足（$\\sigma$ 较大）的项组成，但其对尾部表现的极端敏感性使其成为识别校准不良的敏锐工具。\n\n连续分级概率分数 $S_{CRPS} = \\int (F(z) - H(z-y))^2 dz$ 评估的是整个预测分布与观测值的一致性。它是平均绝对误差的推广；如果预测是确定性点估计 $\\mu$（即 $F(z)$ 是在 $\\mu$ 处的阶跃函数），CRPS 就简化为 $|y-\\mu|$。与对数分数相比，CRPS 对单个不太可能发生的事件不那么敏感，提供了更稳健的整体性能度量。其分解式 $E|X-y| - \\frac{1}{2} E|X-X'|$ 揭示了它既奖励**校准度**和**准确性**（通过最小化预测与从预测分布中抽取的样本之间的期望距离），也奖励**锐度**（第二项是对分布离散程度的惩罚；较小的离散程度导致较小的惩罚）。一个重要的实际优势是 CRPS 的单位与测量值本身的单位相同（本例中为 $\\mathrm{mg/dL}$），这使得它可以直接解释为广义的误差大小。\n\n在生物医学建模中，使用这两种分数是互补的。CRPS 提供了对整体预测性能的稳健、可解释的总结，平衡了预测既要以结果为中心（准确）又要集中（锐利）的需求。对数分数则作为概率校准的更严格检验，标记那些未能在所有可能结果的全范围内分配适当概率的模型，这对于不确定性下的风险评估和决策至关重要。\n\n计算出的分数，四舍五入到四位有效数字，为：\n对数分数：$-5.016$ nats。\nCRPS：$17.13$ $\\mathrm{mg/dL}$。",
            "answer": "$$\\boxed{\\begin{pmatrix} -5.016  17.13 \\end{pmatrix}}$$"
        },
        {
            "introduction": "模型验证的一个关键方面，尤其是在临床环境中，是评估其校准度——即模型的预测概率是否与观测到的事件频率一致。最后一个练习  专注于事件风险模型的这项任务。您将推导并计算两个关键指标，整体校准度 (calibration-in-the-large) 和校准斜率 (calibration slope)，它们共同用于诊断系统性的预测过高或过低问题以及模型风险区分度的保真度。",
            "id": "3921434",
            "problem": "一个生物医学重症监护室部署了一个动态事件风险模型，该模型在一个共同的里程碑时间 $t_{0}$，为每位患者输出在未来 $H$ 天内发生急性不良事件的预测概率 $p_{i}$。令 $Y_{i} \\in \\{0,1\\}$ 表示在预测范围 $[t_{0}, t_{0}+H]$ 内观测到的事件指示变量。广义校准（Calibration-in-the-large）量化了整个队列中的系统性高估或低估，而校准斜率（calibration slope）则量化了当动态模型的风险区分度映射到绝对风险时是否过于极端或过于平缓。\n\n从独立结果的伯努利似然和 logit 链接函数的定义出发，推导如何通过将逻辑斯蒂再校准模型拟合到观测结果和模型提供的预测风险对数优势，来估计动态风险预测的广义校准和校准斜率。具体而言：\n\n- 使用以下基本假设：$Y_{i} \\sim \\mathrm{Bernoulli}(\\pi_{i})$ 对所有 $i$ 独立，logit 链接函数为 $\\mathrm{logit}(z) = \\ln\\!\\big(z/(1-z)\\big)$，并且最大似然估计 (MLE) 是通过求解伯努利-逻辑斯蒂模型的得分方程获得的。\n\n- 证明一个双参数逻辑斯蒂再校准模型 $\\mathrm{logit}(\\pi_{i}) = \\alpha + \\beta\\,x_{i}$，其中 $x_{i} = \\mathrm{logit}(p_{i})$，在 $x_{i}$ 取两个具有分组计数的不同值的特殊情况下，可以得到以各组经验事件率表示的最大似然估计量的闭式表达式。将 $\\beta$ 解释为校准斜率。\n\n- 将广义校准定义为斜率固定为 1 的单参数逻辑斯蒂模型 $\\mathrm{logit}(\\pi_{i}) = \\gamma + 1 \\cdot x_{i}$ 的截距 $\\gamma$，并以分组二项式形式推導 $\\gamma$ 的估计方程。通过引入优势乘子 $s = \\exp(\\gamma)$ 来简化此方程，并表达出 $\\gamma$ 的解。\n\n现在考虑以下一个科学上合理的、预测范围为 $H = 30$ 天的动态预测验证实验。在里程碑时间 $t_{0}$，模型产生了两种不同的预测概率：对于 $60$ 名患者，$p_{i} = 0.1$；对于 $40$ 名患者，$p_{i} = 0.3$。在随后的 $30$ 天内，第一组的 $60$ 名患者中有 $9$ 名发生了该事件，第二组的 $40$ 名患者中有 $16$ 名发生了该事件。\n\n仅使用上述原理，计算：\n- 来自双参数再校准模型的校准斜率估计值 $\\widehat{\\beta}$，以及\n- 来自斜率固定为 1 的单参数模型的广义校准估计值 $\\widehat{\\gamma}$。\n\n将您的最终答案以包含精确解析表达式的行矩阵 $\\big(\\widehat{\\beta},\\,\\widehat{\\gamma}\\big)$ 的形式报告。不包括单位。无需四舍五入。",
            "solution": "该问题具有科学依据，提法明確，客观，并包含得出唯一解所需的所有信息。因此，该问题被认定为有效。我们着手进行推导和计算。\n\n问题要求推导校准斜率和广义校准的估计量，并根据所提供的数据集进行后续计算。\n\n令 $Y_i \\in \\{0, 1\\}$ 为患者 $i$ 的二元结果，遵循伯努利分布 $Y_i \\sim \\mathrm{Bernoulli}(\\pi_i)$，其中 $\\pi_i$ 是真实的事件概率。模型预测的概率是 $p_i$。logit 链接函数由 $\\mathrm{logit}(z) = \\ln(z/(1-z))$ 给出。预测概率的 logit 是 $x_i = \\mathrm{logit}(p_i)$。\n\n$n$ 次独立伯努利试验的对数似然的一般形式是：\n$$ \\ell(\\{\\pi_i\\}) = \\sum_{i=1}^n \\left[ Y_i \\ln(\\pi_i) + (1-Y_i) \\ln(1-\\pi_i) \\right] $$\n\n我们可以用对数优势 $\\eta_i = \\mathrm{logit}(\\pi_i) = \\ln(\\pi_i / (1-\\pi_i))$ 来重新表达它。由此，我们有 $\\pi_i = \\frac{\\exp(\\eta_i)}{1+\\exp(\\eta_i)}$ 和 $1-\\pi_i = \\frac{1}{1+\\exp(\\eta_i)}$。将这些代入对数似然函数中，得到：\n$$ \\ell(\\{\\eta_i\\}) = \\sum_{i=1}^n \\left[ Y_i \\eta_i - \\ln(1+\\exp(\\eta_i)) \\right] $$\n\n**第1部分：双参数再校准模型（校准斜率）**\n\n双参数逻辑斯蒂再校准模型假设真实对数优势 $\\eta_i$ 和模型预测的对数优势 $x_i$ 之间存在线性关系：\n$$ \\eta_i = \\mathrm{logit}(\\pi_i) = \\alpha + \\beta x_i $$\n参数 $\\alpha$（截距）和 $\\beta$（校准斜率）将通过最大似然法进行估计。\n\n问题指定了一个基于患者预测概率的两个不同组别的情景。\n组1 ($j=1$)：$n_1$ 名患者，预测对数优势为 $x_1 = \\mathrm{logit}(p_1)$。令 $k_1$ 为该组观测到的事件数。\n组2 ($j=2$)：$n_2$ 名患者，预测对数优势为 $x_2 = \\mathrm{logit}(p_2)$。令 $k_2$ 为该组观测到的事件数。\n\n对于组 $j$ 中的所有患者，假设真实概率 $\\pi_j$ 是相同的，并通过 $\\mathrm{logit}(\\pi_j) = \\alpha + \\beta x_j$ 与 $x_j$ 相关联。\n对数似然可以写成针对分组数据的形式，其中每个组遵循二项分布：\n$$ \\ell(\\alpha, \\beta) = \\left[ k_1 \\ln(\\pi_1) + (n_1-k_1) \\ln(1-\\pi_1) \\right] + \\left[ k_2 \\ln(\\pi_2) + (n_2-k_2) \\ln(1-\\pi_2) \\right] $$\n用对数优势 $\\eta_j = \\alpha + \\beta x_j$ 表示：\n$$ \\ell(\\alpha, \\beta) = \\sum_{j=1}^2 \\left[ k_j \\eta_j - n_j \\ln(1+\\exp(\\eta_j)) \\right] = \\sum_{j=1}^2 \\left[ k_j (\\alpha + \\beta x_j) - n_j \\ln(1+\\exp(\\alpha + \\beta x_j)) \\right] $$\n为了找到最大似然估计 $(\\widehat{\\alpha}, \\widehat{\\beta})$，我们求解得分方程 $\\frac{\\partial\\ell}{\\partial\\alpha} = 0$ 和 $\\frac{\\partial\\ell}{\\partial\\beta} = 0$。\n$$ \\frac{\\partial\\ell}{\\partial\\alpha} = \\sum_{j=1}^2 \\left( k_j - n_j \\frac{\\exp(\\eta_j)}{1+\\exp(\\eta_j)} \\right) = \\sum_{j=1}^2 (k_j - n_j \\pi_j) = 0 $$\n$$ \\frac{\\partial\\ell}{\\partial\\beta} = \\sum_{j=1}^2 \\left( k_j x_j - n_j x_j \\frac{\\exp(\\eta_j)}{1+\\exp(\\eta_j)} \\right) = \\sum_{j=1}^2 x_j(k_j - n_j \\pi_j) = 0 $$\n如果对于每个组，拟合概率 $\\widehat{\\pi}_j$ 等于经验事件率 $\\frac{k_j}{n_j}$，则这些方程得到满足。这是饱和逻辑斯蒂模型的一个普遍性质。\n因此，最大似然估计 $(\\widehat{\\alpha}, \\widehat{\\beta})$ 必须满足以下线性方程组：\n$$ \\mathrm{logit}\\left(\\frac{k_1}{n_1}\\right) = \\widehat{\\alpha} + \\widehat{\\beta} x_1 $$\n$$ \\mathrm{logit}\\left(\\frac{k_2}{n_2}\\right) = \\widehat{\\alpha} + \\widehat{\\beta} x_2 $$\n用第二个方程减去第一个方程，得到：\n$$ \\mathrm{logit}\\left(\\frac{k_2}{n_2}\\right) - \\mathrm{logit}\\left(\\frac{k_1}{n_1}\\right) = \\widehat{\\beta} (x_2 - x_1) $$\n求解校准斜率估计值 $\\widehat{\\beta}$：\n$$ \\widehat{\\beta} = \\frac{\\mathrm{logit}(k_2/n_2) - \\mathrm{logit}(k_1/n_1)}{x_2 - x_1} $$\n该表达式代表了连接观测对数优势与预测对数优势的直线的斜率。\n\n**第2部分：单参数再校准模型（广义校准）**\n\n单参数模型将校准斜率固定为 $1$，并估计一个截距项 $\\gamma$，称为广义校准：\n$$ \\mathrm{logit}(\\pi_i) = \\gamma + x_i $$\n该模型的对数似然是：\n$$ \\ell(\\gamma) = \\sum_i \\left[ Y_i(\\gamma + x_i) - \\ln(1 + \\exp(\\gamma + x_i)) \\right] $$\n得分方程通过对 $\\gamma$ 求导并设为零得到：\n$$ \\frac{d\\ell}{d\\gamma} = \\sum_i \\left( Y_i - \\frac{\\exp(\\gamma + x_i)}{1 + \\exp(\\gamma + x_i)} \\right) = \\sum_i (Y_i - \\pi_i) = 0 $$\n这个方程意味着，对于最大似然估计 $\\widehat{\\gamma}$，观测到的事件总数必须等于再校准模型下预期的事件总数：$\\sum_i Y_i = \\sum_i \\widehat{\\pi}_i$。\n\n对于分组数据，该方程变为：\n$$ \\sum_{j=1}^2 k_j = \\sum_{j=1}^2 n_j \\widehat{\\pi}_j = \\sum_{j=1}^2 n_j \\frac{\\exp(\\widehat{\\gamma} + x_j)}{1 + \\exp(\\widehat{\\gamma} + x_j)} $$\n引入优势乘子 $s = \\exp(\\gamma)$ 并使用 $\\exp(x_j) = p_j/(1-p_j)$，我们可以简化 $\\pi_j$ 的表达式：\n$$ \\pi_j = \\frac{s \\cdot \\exp(x_j)}{1 + s \\cdot \\exp(x_j)} = \\frac{s \\cdot [p_j/(1-p_j)]}{1 + s \\cdot [p_j/(1-p_j)]} = \\frac{s \\cdot p_j}{(1-p_j) + s \\cdot p_j} $$\n因此，最大似然估计 $\\widehat{s}$ 的估计方程是：\n$$ \\sum_{j=1}^2 k_j = \\sum_{j=1}^2 n_j \\frac{\\widehat{s} \\cdot p_j}{1 - p_j + \\widehat{s} \\cdot p_j} $$\n一旦通过解此方程找到 $\\widehat{s}$，广义校准就由 $\\widehat{\\gamma} = \\ln(\\widehat{s})$ 给出。\n\n**第3部分：数值计算**\n\n所提供的数据如下：\n组1: $n_1=60$, $p_1=0.1$, $k_1=9$。\n组2: $n_2=40$, $p_2=0.3$, $k_2=16$。\n\n首先，我们计算所需的输入值：\n- 预测对数优势：\n  $x_1 = \\mathrm{logit}(p_1) = \\mathrm{logit}(0.1) = \\ln\\left(\\frac{0.1}{0.9}\\right) = \\ln\\left(\\frac{1}{9}\\right) = -\\ln(9)$。\n  $x_2 = \\mathrm{logit}(p_2) = \\mathrm{logit}(0.3) = \\ln\\left(\\frac{0.3}{0.7}\\right) = \\ln\\left(\\frac{3}{7}\\right)$。\n- 经验事件率：\n  $\\widehat{\\pi}_1 = k_1/n_1 = 9/60 = 3/20 = 0.15$。\n  $\\widehat{\\pi}_2 = k_2/n_2 = 16/40 = 2/5 = 0.4$。\n- 观测对数优势：\n  $\\mathrm{logit}(\\widehat{\\pi}_1) = \\mathrm{logit}(0.15) = \\ln\\left(\\frac{0.15}{0.85}\\right) = \\ln\\left(\\frac{15}{85}\\right) = \\ln\\left(\\frac{3}{17}\\right)$。\n  $\\mathrm{logit}(\\widehat{\\pi}_2) = \\mathrm{logit}(0.4) = \\ln\\left(\\frac{0.4}{0.6}\\right) = \\ln\\left(\\frac{4}{6}\\right) = \\ln\\left(\\frac{2}{3}\\right)$。\n\n$\\widehat{\\beta}$ 的计算：\n$$ \\widehat{\\beta} = \\frac{\\mathrm{logit}(\\widehat{\\pi}_2) - \\mathrm{logit}(\\widehat{\\pi}_1)}{x_2 - x_1} = \\frac{\\ln(2/3) - \\ln(3/17)}{\\ln(3/7) - (-\\ln(9))} = \\frac{\\ln\\left(\\frac{2/3}{3/17}\\right)}{\\ln(3/7) + \\ln(9)} = \\frac{\\ln(34/9)}{\\ln(27/7)} $$\n\n$\\widehat{\\gamma}$ 的计算：\n观测到的事件总数为 $k_1+k_2 = 9+16=25$。$s = \\exp(\\gamma)$ 的估计方程是：\n$$ 25 = n_1 \\frac{s \\cdot p_1}{1 - p_1 + s \\cdot p_1} + n_2 \\frac{s \\cdot p_2}{1 - p_2 + s \\cdot p_2} $$\n$$ 25 = 60 \\frac{s \\cdot 0.1}{1 - 0.1 + s \\cdot 0.1} + 40 \\frac{s \\cdot 0.3}{1 - 0.3 + s \\cdot 0.3} $$\n$$ 25 = \\frac{6s}{0.9 + 0.1s} + \\frac{12s}{0.7 + 0.3s} $$\n将分子和分母乘以 $10$ 以消除小数：\n$$ 25 = \\frac{60s}{9 + s} + \\frac{120s}{7 + 3s} $$\n为了求解 $s$，我们找到一个共同的分母：\n$$ 25(9+s)(7+3s) = 60s(7+3s) + 120s(9+s) $$\n$$ 25(63 + 27s + 7s + 3s^2) = 420s + 180s^2 + 1080s + 120s^2 $$\n$$ 25(3s^2 + 34s + 63) = 300s^2 + 1500s $$\n$$ 75s^2 + 850s + 1575 = 300s^2 + 1500s $$\n整理成标准二次型 $as^2+bs+c=0$：\n$$ (300-75)s^2 + (1500-850)s - 1575 = 0 $$\n$$ 225s^2 + 650s - 1575 = 0 $$\n将整个方程除以 $25$：\n$$ 9s^2 + 26s - 63 = 0 $$\n我们使用二次方程求根公式 $s = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$ 来求解 $s$：\n$$ s = \\frac{-26 \\pm \\sqrt{26^2 - 4(9)(-63)}}{2(9)} = \\frac{-26 \\pm \\sqrt{676 + 2268}}{18} = \\frac{-26 \\pm \\sqrt{2944}}{18} $$\n为了简化根式，我们找到 $2944$ 的素数分解：$2944 = 64 \\times 46 = 2^6 \\times 46$。\n因此，$\\sqrt{2944} = \\sqrt{64 \\times 46} = 8\\sqrt{46}$。\n$$ s = \\frac{-26 \\pm 8\\sqrt{46}}{18} = \\frac{-13 \\pm 4\\sqrt{46}}{9} $$\n由于 $s = \\exp(\\gamma)$ 必须为正，我们必须选择正根。我们注意到 $4\\sqrt{46} = \\sqrt{16 \\times 46} = \\sqrt{736}$ 并且 $13 = \\sqrt{169}$，所以 $4\\sqrt{46} > 13$。正根是：\n$$ \\widehat{s} = \\frac{-13 + 4\\sqrt{46}}{9} $$\n最后，广义校准的估计值为：\n$$ \\widehat{\\gamma} = \\ln(\\widehat{s}) = \\ln\\left(\\frac{-13 + 4\\sqrt{46}}{9}\\right) $$",
            "answer": "$$ \\boxed{\\begin{pmatrix} \\frac{\\ln\\left(\\frac{34}{9}\\right)}{\\ln\\left(\\frac{27}{7}\\right)}  \\ln\\left(\\frac{-13 + 4\\sqrt{46}}{9}\\right) \\end{pmatrix}} $$"
        }
    ]
}