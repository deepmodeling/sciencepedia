{
    "hands_on_practices": [
        {
            "introduction": "此练习将侧重于将 Emax 模型拟合到数据的基本数学原理。通过从最大似然原理推导非线性最小二乘目标函数，然后计算其梯度，您将深入了解优化算法如何找到最佳拟合参数。对于任何建模者来说，这都是一项基石技能。",
            "id": "3936351",
            "problem": "一项药效学实验测量了在给药浓度 $C_{i}$ (其中 $i=1,\\dots,n$) 下的效应值 $E_{i}$。假设一个标准的饱和暴露-反应结构，其中作为浓度函数的期望效应由最大效应 (Emax) 模型建模\n$$\nE(C;\\theta)=E_{0}+E_{\\max}\\,\\frac{C}{EC_{50}+C},\n$$\n其中 $\\theta=(E_{0},E_{\\max},EC_{50})$ 分别代表基线效应 $E_{0}$、药物引起的最大效应 $E_{\\max}$ 和半数最大效应浓度 (EC50)。假设测量误差是加性的、独立的，并且服从均值为零、共同方差为 $\\sigma^{2}$ 的高斯分布，即\n$$\nE_{i}=E(C_{i};\\theta)+\\varepsilon_{i},\\quad \\varepsilon_{i}\\sim\\mathcal{N}(0,\\sigma^{2}),\\quad \\text{independent across }i.\n$$\n从这些假设和高斯似然出发，推导出以下形式的非线性最小二乘目标\n$$\nS(\\theta)=\\sum_{i=1}^{n}\\bigl(E_{i}-E(C_{i};\\theta)\\bigr)^{2},\n$$\n然后，仅使用第一性原理和符号微分，推导关于 $\\theta=(E_{0},E_{\\max},EC_{50})$ 的梯度 $\\nabla S(\\theta)$。将最终答案表示为梯度分量的闭式解析表达式，用 $(E_{i},C_{i})$、$E_{0}$、$E_{\\max}$ 和 $EC_{50}$ 表示。无需四舍五入，最终答案中不应包含单位。",
            "solution": "该问题是有效的，因为它在科学上基于标准的药效学建模和统计学原理，问题陈述清晰且信息充分，足以进行唯一的解析推导，并且是客观陈述的。\n\n按照要求，解答过程分为两部分。首先，我们根据给定的高斯误差模型，从最大似然原理推导出非线性最小二乘目标函数 $S(\\theta)$。其次，我们推导该目标函数关于参数向量 $\\theta=(E_{0},E_{\\max},EC_{50})$ 的梯度 $\\nabla S(\\theta)$。\n\n**第一部分：非线性最小二乘目标的推导**\n\n问题陈述测量误差 $\\varepsilon_{i}$ 是独立同分布 (i.i.d.) 的，服从均值为 $0$、共同方差为 $\\sigma^{2}$ 的高斯（正态）分布。这表示为 $\\varepsilon_{i} \\sim \\mathcal{N}(0, \\sigma^{2})$。单个误差项 $\\varepsilon_i$ 的概率密度函数 (PDF) 由下式给出：\n$$\nf(\\varepsilon_{i}) = \\frac{1}{\\sqrt{2\\pi\\sigma^{2}}} \\exp\\left(-\\frac{\\varepsilon_{i}^{2}}{2\\sigma^{2}}\\right)\n$$\n观测效应 $E_i$、模型预测值 $E(C_i; \\theta)$ 和误差之间的关系是 $E_i = E(C_i; \\theta) + \\varepsilon_i$。因此，误差项可以表示为 $\\varepsilon_i = E_i - E(C_i; \\theta)$。将此代入 PDF，我们得到在给定浓度 $C_i$ 和参数 $\\theta$ 及 $\\sigma^2$ 的条件下观测到 $E_i$ 的条件概率：\n$$\np(E_{i}|C_{i}, \\theta, \\sigma^2) = \\frac{1}{\\sqrt{2\\pi\\sigma^{2}}} \\exp\\left(-\\frac{(E_{i}-E(C_{i};\\theta))^{2}}{2\\sigma^{2}}\\right)\n$$\n似然函数 $L(\\theta, \\sigma^2)$ 是观测到整个数据集 $\\{E_i\\}_{i=1}^n$ 的联合概率。由于假设误差是独立的，联合概率是各个概率的乘积：\n$$\nL(\\theta, \\sigma^2) = \\prod_{i=1}^{n} p(E_{i}|C_{i}, \\theta, \\sigma^2) = \\prod_{i=1}^{n} \\frac{1}{\\sqrt{2\\pi\\sigma^{2}}} \\exp\\left(-\\frac{(E_{i}-E(C_{i};\\theta))^{2}}{2\\sigma^{2}}\\right)\n$$\n这可以简化为：\n$$\nL(\\theta, \\sigma^2) = \\left(\\frac{1}{2\\pi\\sigma^{2}}\\right)^{n/2} \\exp\\left(-\\frac{1}{2\\sigma^{2}}\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta))^{2}\\right)\n$$\n最大似然估计 (MLE) 原理指出，我们应该选择使该似然函数最大化的参数。通常使用似然函数的自然对数，即对数似然 $\\ell(\\theta, \\sigma^2)$，会更为方便，因为对数是单调递增函数。最大化对数似然等同于最大化似然本身。\n$$\n\\ell(\\theta, \\sigma^2) = \\ln(L(\\theta, \\sigma^2)) = \\ln\\left[\\left(\\frac{1}{2\\pi\\sigma^{2}}\\right)^{n/2} \\exp\\left(-\\frac{1}{2\\sigma^{2}}\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta))^{2}\\right)\\right]\n$$\n利用对数的性质，上式变为：\n$$\n\\ell(\\theta, \\sigma^2) = -\\frac{n}{2}\\ln(2\\pi\\sigma^2) - \\frac{1}{2\\sigma^2}\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta))^{2}\n$$\n为了找到最优参数向量 $\\theta$，我们需要关于 $\\theta$ 最大化 $\\ell(\\theta, \\sigma^2)$。观察到第一项 $-\\frac{n}{2}\\ln(2\\pi\\sigma^2)$ 和第二项中的因子 $-\\frac{1}{2\\sigma^2}$ 都不依赖于 $\\theta$（假设 $\\sigma^2$ 不是 $\\theta$ 的函数）。因此，关于 $\\theta$ 最大化 $\\ell(\\theta, \\sigma^2)$ 等价于最小化平方差之和项：\n$$\nS(\\theta) = \\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta))^{2}\n$$\n这正是问题中所述的非线性最小二乘目标函数。\n\n**第二部分：梯度 $\\nabla S(\\theta)$ 的推导**\n\n$S(\\theta)$ 的梯度是其关于 $\\theta=(E_{0},E_{\\max},EC_{50})$ 的每个分量的偏导数组成的向量。\n$$\n\\nabla S(\\theta) = \\left( \\frac{\\partial S}{\\partial E_{0}}, \\frac{\\partial S}{\\partial E_{\\max}}, \\frac{\\partial S}{\\partial EC_{50}} \\right)\n$$\n我们使用链式法则分别计算每个分量。对于一个通用参数 $p \\in \\{E_0, E_{\\max}, EC_{50}\\}$，其偏导数为：\n$$\n\\frac{\\partial S}{\\partial p} = \\frac{\\partial}{\\partial p} \\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta))^{2} = \\sum_{i=1}^{n} 2(E_{i}-E(C_{i};\\theta)) \\cdot \\frac{\\partial}{\\partial p}(-E(C_{i};\\theta))\n$$\n$$\n\\frac{\\partial S}{\\partial p} = -2\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta)) \\frac{\\partial E(C_{i};\\theta)}{\\partial p}\n$$\n模型函数为 $E(C;\\theta)=E_{0}+E_{\\max}\\,\\frac{C}{EC_{50}+C}$。我们现在求 $E(C_i;\\theta)$ 关于每个参数的偏导数。\n\n1.  **关于 $E_0$ 的偏导数：**\n    $$\n    \\frac{\\partial E(C_{i};\\theta)}{\\partial E_{0}} = \\frac{\\partial}{\\partial E_{0}}\\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right) = 1\n    $$\n    将此代入梯度分量的一般公式：\n    $$\n    \\frac{\\partial S}{\\partial E_{0}} = -2\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta)) \\cdot 1 = -2\\sum_{i=1}^{n}\\left(E_{i} - \\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\\right)\n    $$\n\n2.  **关于 $E_{\\max}$ 的偏导数：**\n    $$\n    \\frac{\\partial E(C_{i};\\theta)}{\\partial E_{\\max}} = \\frac{\\partial}{\\partial E_{\\max}}\\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right) = \\frac{C_{i}}{EC_{50}+C_{i}}\n    $$\n    将此代入一般公式：\n    $$\n    \\frac{\\partial S}{\\partial E_{\\max}} = -2\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta)) \\left(\\frac{C_{i}}{EC_{50}+C_{i}}\\right) = -2\\sum_{i=1}^{n}\\left(E_{i} - \\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\\right)\\left(\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\n    $$\n\n3.  **关于 $EC_{50}$ 的偏导数：**\n    这里我们使用微分的商法则。令 $u = C_i$ 且 $v = EC_{50}+C_i$。则 $\\frac{\\partial u}{\\partial EC_{50}} = 0$ 且 $\\frac{\\partial v}{\\partial EC_{50}} = 1$。\n    $$\n    \\frac{\\partial E(C_{i};\\theta)}{\\partial EC_{50}} = \\frac{\\partial}{\\partial EC_{50}}\\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right) = E_{\\max} \\frac{\\partial}{\\partial EC_{50}}\\left(\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\n    $$\n    $$\n    \\frac{\\partial}{\\partial EC_{50}}\\left(\\frac{C_{i}}{EC_{50}+C_{i}}\\right) = \\frac{0 \\cdot (EC_{50}+C_{i}) - C_i \\cdot 1}{(EC_{50}+C_{i})^2} = -\\frac{C_{i}}{(EC_{50}+C_{i})^{2}}\n    $$\n    因此，\n    $$\n    \\frac{\\partial E(C_{i};\\theta)}{\\partial EC_{50}} = -E_{\\max}\\frac{C_{i}}{(EC_{50}+C_{i})^{2}}\n    $$\n    将此代入一般公式：\n    $$\n    \\frac{\\partial S}{\\partial EC_{50}} = -2\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta)) \\left(-E_{\\max}\\frac{C_{i}}{(EC_{50}+C_{i})^{2}}\\right)\n    $$\n    $$\n    \\frac{\\partial S}{\\partial EC_{50}} = 2\\sum_{i=1}^{n}(E_{i}-E(C_{i};\\theta)) \\left(E_{\\max}\\frac{C_{i}}{(EC_{50}+C_{i})^{2}}\\right) = 2 E_{\\max}\\sum_{i=1}^{n}\\left(E_{i} - \\left(E_{0}+E_{\\max}\\,\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\\right)\\frac{C_{i}}{(EC_{50}+C_{i})^{2}}\n    $$\n这三个表达式构成了梯度向量 $\\nabla S(\\theta)$ 的分量。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -2\\sum_{i=1}^{n}\\left(E_{i} - E_{0} - E_{\\max}\\frac{C_{i}}{EC_{50}+C_{i}}\\right) \\\\ -2\\sum_{i=1}^{n}\\left(E_{i} - E_{0} - E_{\\max}\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\\frac{C_{i}}{EC_{50}+C_{i}} \\\\ 2 E_{\\max}\\sum_{i=1}^{n}\\left(E_{i} - E_{0} - E_{\\max}\\frac{C_{i}}{EC_{50}+C_{i}}\\right)\\frac{C_{i}}{(EC_{50}+C_{i})^{2}} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "本练习将 Emax 模型的数学形式与其在受体理论中的生物物理学起源联系起来。您将从第一性原理推导出经典的双曲线形状，然后探索一种强大的技术——logit 变换——来线性化剂量-反应曲线。这项实践阐明了模型的理论基础，并为数据分析和可视化提供了一个经典工具。",
            "id": "3936364",
            "problem": "在体外测定中，测量了受体介导的药效学效应 $E(C)$ 作为激动剂浓度 $C$ 的函数。在零浓度时，基线效应为 $E_{0}$，而当 $C \\to \\infty$ 时，效应饱和于 $E_{0} + E_{\\max}$。假设存在一类具有一对一结合和快速平衡的非协同性受体，因此占据的受体分数由质量作用定律给出。进一步假设，从受体占据到效应的转导在动态范围内是线性的，因此在 $E_{0}$ 和 $E_{0} + E_{\\max}$ 之间，效应与占据率成比例地变化。\n\n令 $EC_{50}$ 表示半数有效浓度，定义为效应处于 $E_{0}$ 和 $E_{0} + E_{\\max}$ 中间点时的浓度 $C$。定义归一化效应 $y$ 为 $y = (E - E_{0})/E_{\\max}$，归一化浓度 $x$ 为 $x = C/EC_{50}$。\n\n仅使用上述物理和定义性假设：\n- 推导 $y$ 关于 $x$ 的函数形式。\n- 然后，在平均响应经过logit变换后残差误差变为同方差的工作假设下，构建一个能将 $y$ 线性化为 $\\ln C$ 的显式变换。\n\n以 $y$ 的logit变换关于 $C$ 和 $EC_{50}$ 的单个闭式解析表达式的形式给出最终答案。答案中不要包含任何单位。",
            "solution": "该问题被验证为具有科学依据、问题明确且客观。它描述了药效学中的一个标准推导过程，植根于质量作用定律和线性系统理论，并提出了一个清晰、可解决的任务。没有矛盾、歧义或事实不准确之处。\n\n解答过程根据题目要求分两部分进行。\n\n首先，我们推导归一化效应 $y$ 关于归一化浓度 $x$ 的函数形式。\n\n激动剂（浓度 $C$）与一类非协同性受体的结合由可逆反应 $A + R \\rightleftharpoons AR$ 描述。在平衡状态下，质量作用定律给出解离常数 $K_d$ 为：\n$$K_d = \\frac{[A][R]}{[AR]}$$\n在我们的符号体系中，$[A] = C$。总受体浓度为 $[R_T] = [R] + [AR]$。被占据的受体分数，我们表示为 $f_{\\text{occ}}$，由 $f_{\\text{occ}} = \\frac{[AR]}{[R_T]}$ 给出。\n我们可以用 $[AR]$ 和 $C$ 来表示 $[R]$：$[R] = \\frac{K_d [AR]}{C}$。\n将此代入 $[R_T]$ 的表达式中：\n$$[R_T] = \\frac{K_d [AR]}{C} + [AR] = [AR] \\left( \\frac{K_d}{C} + 1 \\right) = [AR] \\left( \\frac{K_d + C}{C} \\right)$$\n现在我们可以将被占据的受体分数写为：\n$$f_{\\text{occ}} = \\frac{[AR]}{[R_T]} = \\frac{[AR]}{[AR] \\left( \\frac{K_d + C}{C} \\right)} = \\frac{C}{C + K_d}$$\n题目指出从受体占据到效应的转导是线性的。效应 $E$ 从基线 $E_0$（当 $f_{\\text{occ}}=0$ 时）变化到最大值 $E_0 + E_{\\max}$（当 $f_{\\text{occ}}=1$ 时）。因此，超出基线的效应 $E - E_0$ 与被占据的受体分数成正比，比例常数为可能的最大超基线效应 $E_{\\max}$。\n$$E(C) - E_0 = E_{\\max} \\cdot f_{\\text{occ}}$$\n代入 $f_{\\text{occ}}$ 的表达式，得到简单的 $E_{\\max}$ 模型：\n$$E(C) - E_0 = E_{\\max} \\frac{C}{C + K_d}$$\n接下来，我们将 $K_d$ 与半数有效浓度 $EC_{50}$ 联系起来。根据定义，当 $C = EC_{50}$ 时，效应处于基线和最大值之间的一半，即 $E(EC_{50}) = E_0 + \\frac{1}{2} E_{\\max}$。\n根据我们的模型，当 $C = EC_{50}$ 时，超基线效应为 $E(EC_{50}) - E_0 = \\frac{1}{2} E_{\\max}$。\n将 $C=EC_{50}$ 代入模型方程：\n$$E(EC_{50}) - E_0 = E_{\\max} \\frac{EC_{50}}{EC_{50} + K_d}$$\n令 $EC_{50}$ 处效应的两个表达式相等：\n$$\\frac{1}{2} E_{\\max} = E_{\\max} \\frac{EC_{50}}{EC_{50} + K_d}$$\n$$\\frac{1}{2} = \\frac{EC_{50}}{EC_{50} + K_d} \\implies EC_{50} + K_d = 2 EC_{50} \\implies K_d = EC_{50}$$\n因此，对于此模型，解离常数等于半数有效浓度。我们现在可以用 $EC_{50}$ 来写出效应模型：\n$$E(C) - E_0 = E_{\\max} \\frac{C}{C + EC_{50}}$$\n题目定义了归一化效应 $y = \\frac{E - E_0}{E_{\\max}}$。从上面的方程，我们可以直接确定 $y$：\n$$y = \\frac{C}{C + EC_{50}}$$\n为了用归一化浓度 $x = C/EC_{50}$ 来表示 $y$，我们将分子和分母同时除以 $EC_{50}$：\n$$y = \\frac{C/EC_{50}}{(C/EC_{50}) + (EC_{50}/EC_{50})} = \\frac{x}{x + 1}$$\n这就完成了第一部分的推导。\n\n第二，我们构建将 $y$ 线性化为 $\\ln C$ 的变换。题目建议对平均响应进行logit变换。应用于变量 $p \\in (0, 1)$ 的logit函数定义为 $\\text{logit}(p) = \\ln\\left(\\frac{p}{1-p}\\right)$。我们将此变换应用于我们的归一化效应 $y$。\n\n我们有 $y$ 关于 $C$ 和 $EC_{50}$ 的表达式：\n$$y = \\frac{C}{C + EC_{50}}$$\n我们还需要找到 $1-y$ 的表达式：\n$$1 - y = 1 - \\frac{C}{C + EC_{50}} = \\frac{C + EC_{50}}{C + EC_{50}} - \\frac{C}{C + EC_{50}} = \\frac{EC_{50}}{C + EC_{50}}$$\n现在我们构建比值 $\\frac{y}{1-y}$：\n$$\\frac{y}{1-y} = \\frac{\\left( \\frac{C}{C + EC_{50}} \\right)}{\\left( \\frac{EC_{50}}{C + EC_{50}} \\right)} = \\frac{C}{EC_{50}}$$\n取自然对数，得到 $y$ 的logit变换：\n$$\\text{logit}(y) = \\ln\\left(\\frac{y}{1-y}\\right) = \\ln\\left(\\frac{C}{EC_{50}}\\right)$$\n为了验证此变换将 $y$ 线性化为 $\\ln C$ 的函数，我们可以使用对数的性质重写该表达式：\n$$\\text{logit}(y) = \\ln(C) - \\ln(EC_{50})$$\n这是一个形如 $Y = mX + b$ 的方程，其中变换后的变量是 $Y = \\text{logit}(y)$，自变量是 $X = \\ln(C)$，斜率是 $m=1$，截距是 $b = -\\ln(EC_{50})$。这是一个线性关系。\n\n所要求的最终答案是 $y$ 的logit变换关于 $C$ 和 $EC_{50}$ 的单个闭式解析表达式。这就是我们刚刚推导出的表达式。",
            "answer": "$$\\boxed{\\ln\\left(\\frac{C}{EC_{50}}\\right)}$$"
        },
        {
            "introduction": "这项高级计算实践解决了现代统计建模中的一个关键挑战：确保参数估计的高效性和稳定性。您将为 S 型 Emax 模型的参数实施对数重参数化，并使用费雪信息矩阵 (Fisher Information Matrix) 来量化问题几何结构的改善。此练习展示了一种关键技术，用于提高贝叶斯分析中汉密尔顿蒙特卡罗 (Hamiltonian Monte Carlo, HMC) 等复杂算法的性能。",
            "id": "3936398",
            "problem": "考虑用于药效学中关联药物浓度与效应的S型最大效应模型（通常称为S型$E_{\\max}$模型）。设在浓度$C$下观测到的效应模型为 $E(C) = E_0 + E_{\\max} \\dfrac{C^n}{EC_{50}^n + C^n}$，其中$E_0$是基线效应，$E_{\\max}$是最大药物效应，$EC_{50}$是产生半数最大效应时的浓度，$n$是控制陡峭度的希尔系数。假设测量噪声为独立同分布（IID）的高斯噪声：在浓度$C_i$下的每次观测$y_i$满足$y_i \\sim \\mathcal{N}(E(C_i), \\sigma^2)$，其中方差$\\sigma^2$已知。\n\n从一个基本前提开始，即在高斯噪声下，参数$\\mathbf{p}$的期望费雪信息矩阵由$I(\\mathbf{p}) = \\dfrac{1}{\\sigma^2} \\sum_{i=1}^N \\nabla_{\\mathbf{p}} E(C_i) \\, \\nabla_{\\mathbf{p}} E(C_i)^\\top$给出，其中$\\nabla_{\\mathbf{p}} E(C_i)$表示均值函数在浓度$C_i$处相对于参数向量的梯度。对于原始参数化$\\mathbf{p} = (EC_{50}, n)$，此矩阵反映了负对数似然的局部曲率，从而反映了与哈密顿蒙特卡洛（HMC）提议动态相关的局部几何结构。考虑一个由$\\theta = \\log EC_{50}$和$\\phi = \\log n$定义的重参数化$\\boldsymbol{\\psi} = (\\theta, \\phi)$，它将$(EC_{50}, n)$的受约束正参数空间映射到$(\\theta, \\phi)$的无约束实数空间。\n\n您的任务是实现这种重参数化，并使用费雪信息框架来量化它如何改变局部几何结构。具体来说：\n\n- 从模型定义和基本微分法则出发，推导$\\mathbf{p} = (EC_{50}, n)$的梯度$\\nabla_{\\mathbf{p}} E(C)$。然后使用链式法则推导$\\boldsymbol{\\psi} = (\\theta, \\phi)$的梯度$\\nabla_{\\boldsymbol{\\psi}} E(C)$。\n- 对于每个提供的测试用例，计算两个期望费雪信息矩阵：$I_{\\text{orig}}$用于原始参数$(EC_{50}, n)$，$I_{\\text{repar}}$用于重参数化后的参数$(\\theta, \\phi)$。\n- 对于每个矩阵，计算其谱条件数$\\kappa = \\dfrac{\\lambda_{\\max}}{\\lambda_{\\min}}$，其中$\\lambda_{\\max}$和$\\lambda_{\\min}$是对称半正定矩阵的最大和最小特征值。当$\\lambda_{\\min}$在数值上非正或极小（例如，由于设计简并而低于$10^{-12}$）时，将条件数视为$+\\infty$。\n- 对于每个测试用例，输出标量比值$r = \\dfrac{\\kappa_{\\text{orig}}}{\\kappa_{\\text{repar}}}$，该值反映了各向同性的改善程度（大于$1$的值表示重参数化产生了更小的条件数，因此局部几何结构更具各向同性）。\n\n在所有计算中使用以下常数和单位：\n- 基线效应 $E_0 = 0$ a.u.（任意单位）。\n- 最大效应 $E_{\\max} = 100$ a.u.。\n- 噪声标准差 $\\sigma = 5$ a.u.。\n- 浓度 $C_i$ 单位为微摩尔/升（$\\mu\\text{mol}/\\text{L}$）；最终数值输出是无单位的浮点数。\n\n测试套件（每个用例使用剂量设计$[0.1, 0.5, 1.0, 3.0, 10.0, 30.0]$，单位为$\\mu\\text{mol}/\\text{L}$）：\n- 用例1（理想情况）：$EC_{50} = 3.0$，$n = 2.0$。\n- 用例2（陡峭响应）：$EC_{50} = 3.0$，$n = 5.0$。\n- 用例3（$EC_{50}$相对于剂量较大）：$EC_{50} = 30.0$，$n = 2.0$。\n- 用例4（$EC_{50}$相对于剂量较小）：$EC_{50} = 0.3$，$n = 2.0$。\n\n您的程序应计算给定顺序中每个用例的$r$值，并生成一行输出，其中包含一个用方括号括起来的逗号分隔列表的结果，例如，$[r_1, r_2, r_3, r_4]$。\n\n所有答案必须是浮点数。最终输出是无单位的。不涉及角度，因此无需指定角度单位。",
            "solution": "目标是分析当一个统计模型的参数空间进行重参数化时，其局部几何性质的改善情况。这通过比较原始和重参数化后S型$E_{\\max}$模型的费雪信息矩阵（FIM）的谱条件数来实现。较小的条件数表示负对数似然曲面的几何结构更具各向同性（球形），这对于哈密顿蒙特卡洛（HMC）等采样算法是有利的。\n\nS型$E_{\\max}$模型通过以下方程将药物浓度$C$与可观测效应$E(C)$关联起来：\n$$\nE(C) = E_0 + E_{\\max} \\frac{C^n}{EC_{50}^n + C^n}\n$$\n本问题的参数为$E_0 = 0$，$E_{\\max} = 100$，以及噪声标准差$\\sigma = 5$。待估计的参数向量最初是$\\mathbf{p} = (EC_{50}, n)^\\top$。测量噪声假设为独立同分布的高斯噪声，$y_i \\sim \\mathcal{N}(E(C_i), \\sigma^2)$。\n\n参数向量$\\mathbf{p}$的期望费雪信息矩阵（FIM）由下式给出：\n$$\nI(\\mathbf{p}) = \\frac{1}{\\sigma^2} \\sum_{i=1}^N \\nabla_{\\mathbf{p}} E(C_i) \\, \\nabla_{\\mathbf{p}} E(C_i)^\\top\n$$\n其中$N$是浓度点$C_i$的数量。\n\n重参数化由$\\theta = \\log EC_{50}$和$\\phi = \\log n$定义，得到新的参数向量$\\boldsymbol{\\psi} = (\\theta, \\phi)^\\top$。这将参数空间从$(EC_{50}, n)$的$(0, \\infty) \\times (0, \\infty)$转换为$(\\theta, \\phi)$的$(-\\infty, \\infty) \\times (-\\infty, \\infty)$。\n\n解题过程分为四个步骤：\n1.  推导均值函数$E(C)$关于原始参数$\\mathbf{p} = (EC_{50}, n)$的梯度。\n2.  使用链式法则推导关于重参数化后参数$\\boldsymbol{\\psi} = (\\theta, \\phi)$的梯度。\n3.  为两种参数化构建FIM，$I_{\\text{orig}}$和$I_{\\text{repar}}$。\n4.  计算每个测试用例的条件数及其比值。\n\n**1. 关于原始参数$\\mathbf{p} = (EC_{50}, n)$的梯度**\n梯度向量为$\\nabla_{\\mathbf{p}} E(C) = \\begin{pmatrix} \\partial E / \\partial EC_{50} \\\\ \\partial E / \\partial n \\end{pmatrix}$。当$E_0=0$时，我们有$E(C) = E_{\\max} \\frac{C^n}{EC_{50}^n + C^n}$。\n\n关于$EC_{50}$的偏导数为：\n$$\n\\frac{\\partial E}{\\partial EC_{50}} = E_{\\max} \\cdot C^n \\cdot \\frac{\\partial}{\\partial EC_{50}} (EC_{50}^n + C^n)^{-1} = E_{\\max} C^n (-1) (EC_{50}^n + C^n)^{-2} (n \\cdot EC_{50}^{n-1})\n$$\n$$\n\\frac{\\partial E}{\\partial EC_{50}} = -E_{\\max} \\frac{n C^n EC_{50}^{n-1}}{(EC_{50}^n + C^n)^2}\n$$\n\n关于$n$的偏导数使用商法则对$f(n) = \\frac{C^n}{EC_{50}^n + C^n}$求导。注意$\\frac{d}{dn}(a^n) = a^n \\log a$。\n$$\n\\frac{\\partial E}{\\partial n} = E_{\\max} \\frac{(\\frac{\\partial}{\\partial n} C^n)(EC_{50}^n + C^n) - C^n(\\frac{\\partial}{\\partial n}(EC_{50}^n + C^n))}{(EC_{50}^n + C^n)^2}\n$$\n$$\n\\frac{\\partial E}{\\partial n} = E_{\\max} \\frac{(C^n \\log C)(EC_{50}^n + C^n) - C^n(EC_{50}^n \\log EC_{50} + C^n \\log C)}{(EC_{50}^n + C^n)^2}\n$$\n$$\n\\frac{\\partial E}{\\partial n} = E_{\\max} \\frac{C^n EC_{50}^n (\\log C - \\log EC_{50})}{(EC_{50}^n + C^n)^2} = E_{\\max} \\frac{C^n EC_{50}^n \\log(C/EC_{50})}{(EC_{50}^n + C^n)^2}\n$$\n\n**2. 关于重参数化后参数$\\boldsymbol{\\psi} = (\\theta, \\phi)$的梯度**\n关于$\\boldsymbol{\\psi} = (\\theta, \\phi)^\\top$的梯度使用链式法则求得，其中$EC_{50} = e^\\theta$且$n = e^\\phi$。\n$$\n\\frac{\\partial E}{\\partial \\theta} = \\frac{\\partial E}{\\partial EC_{50}} \\frac{\\partial EC_{50}}{\\partial \\theta} = \\frac{\\partial E}{\\partial EC_{50}} \\cdot e^\\theta = \\frac{\\partial E}{\\partial EC_{50}} \\cdot EC_{50}\n$$\n$$\n\\frac{\\partial E}{\\partial \\phi} = \\frac{\\partial E}{\\partial n} \\frac{\\partial n}{\\partial \\phi} = \\frac{\\partial E}{\\partial n} \\cdot e^\\phi = \\frac{\\partial E}{\\partial n} \\cdot n\n$$\n代入步骤1中的表达式：\n$$\n\\frac{\\partial E}{\\partial \\theta} = \\left( -E_{\\max} \\frac{n C^n EC_{50}^{n-1}}{(EC_{50}^n + C^n)^2} \\right) \\cdot EC_{50} = -E_{\\max} \\frac{n C^n EC_{50}^{n}}{(EC_{50}^n + C^n)^2}\n$$\n$$\n\\frac{\\partial E}{\\partial \\phi} = \\left( E_{\\max} \\frac{C^n EC_{50}^n \\log(C/EC_{50})}{(EC_{50}^n + C^n)^2} \\right) \\cdot n = E_{\\max} \\frac{n C^n EC_{50}^n \\log(C/EC_{50})}{(EC_{50}^n + C^n)^2}\n$$\n梯度向量为$\\nabla_{\\boldsymbol{\\psi}} E(C) = \\begin{pmatrix} \\partial E / \\partial \\theta \\\\ \\partial E / \\partial \\phi \\end{pmatrix}$。\n\n**3. FIM的构建**\n对于每个测试用例，我们给定一组参数值$(EC_{50}, n)$和一组固定的浓度$C_i \\in \\{0.1, 0.5, 1.0, 3.0, 10.0, 30.0\\}$。对于每个浓度$C_i$，计算梯度向量$\\nabla_{\\mathbf{p}} E(C_i)$和$\\nabla_{\\boldsymbol{\\psi}} E(C_i)$。然后通过对所有浓度的这些向量的外积求和并乘以$1/\\sigma^2$来计算FIM：\n$$\nI_{\\text{orig}} = \\frac{1}{\\sigma^2} \\sum_{i=1}^6 \\nabla_{\\mathbf{p}} E(C_i) \\, (\\nabla_{\\mathbf{p}} E(C_i))^\\top\n$$\n$$\nI_{\\text{repar}} = \\frac{1}{\\sigma^2} \\sum_{i=1}^6 \\nabla_{\\boldsymbol{\\psi}} E(C_i) \\, (\\nabla_{\\boldsymbol{\\psi}} E(C_i))^\\top\n$$\n\n**4. 条件数与比值**\nFIM是对称半正定的$2 \\times 2$矩阵。对于每个FIM，我们计算其特征值$\\lambda_{\\max}$和$\\lambda_{\\min}$。谱条件数$\\kappa$是最大特征值与最小特征值的比值：\n$$\n\\kappa = \\frac{\\lambda_{\\max}}{\\lambda_{\\min}}\n$$\n如果$\\lambda_{\\min}$在数值上与零无法区分（具体来说，如果$\\lambda_{\\min} \\le 10^{-12}$），则出于实际目的，该矩阵被认为是奇异的，条件数取为$+\\infty$。这表明参数从给定的实验设计中是局部不可识别的。\n\n最后，重参数化带来的改善由比值$r$量化：\n$$\nr = \\frac{\\kappa_{\\text{orig}}}{\\kappa_{\\text{repar}}}\n$$\n比值$r > 1$表示重参数化使得局部几何结构更具各向同性，改善了参数估计问题的条件。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the ratio of condition numbers of the Fisher Information Matrix\n    for original and reparameterized sigmoid Emax models.\n    \"\"\"\n    # Define constants and experimental design\n    E_MAX = 100.0\n    SIGMA = 5.0\n    CONCENTRATIONS = np.array([0.1, 0.5, 1.0, 3.0, 10.0, 30.0])\n    \n    # Define test cases: (EC50, n)\n    test_cases = [\n        (3.0, 2.0),\n        (3.0, 5.0),\n        (30.0, 2.0),\n        (0.3, 2.0),\n    ]\n\n    # Threshold for treating an eigenvalue as zero\n    LAMBDA_MIN_TOL = 1e-12\n\n    def gradient_p(C, ec50, n):\n        \"\"\"\n        Computes the gradient of E(C) w.r.t. original parameters p = (EC50, n).\n        \"\"\"\n        # Handle C=0 case to avoid log(0)\n        if C == 0:\n            return np.array([0.0, 0.0])\n            \n        C_pow_n = C**n\n        ec50_pow_n = ec50**n\n        denominator = ec50_pow_n + C_pow_n\n        \n        # dE/dEC50\n        dE_dEC50_num = -E_MAX * n * C_pow_n * ec50**(n - 1)\n        dE_dEC50 = dE_dEC50_num / (denominator**2)\n        \n        # dE/dn\n        # Note: np.log is the natural logarithm\n        log_C_div_ec50 = np.log(C / ec50)\n        dE_dn_num = E_MAX * C_pow_n * ec50_pow_n * log_C_div_ec50\n        dE_dn = dE_dn_num / (denominator**2)\n        \n        return np.array([dE_dEC50, dE_dn])\n\n    def gradient_psi(C, ec50, n):\n        \"\"\"\n        Computes the gradient of E(C) w.r.t. reparameterized parameters psi = (log(EC50), log(n)).\n        This is done via the chain rule using the gradient w.r.t. p.\n        \"\"\"\n        grad_p_vec = gradient_p(C, ec50, n)\n        \n        # dE/d(theta) = dE/dEC50 * dEC50/d(theta) = dE/dEC50 * ec50\n        dE_dtheta = grad_p_vec[0] * ec50\n        \n        # dE/d(phi) = dE/dn * dn/d(phi) = dE/dn * n\n        dE_dphi = grad_p_vec[1] * n\n        \n        return np.array([dE_dtheta, dE_dphi])\n\n    def calculate_fim(grad_func, concentrations, params):\n        \"\"\"\n        Calculates the Fisher Information Matrix.\n        \"\"\"\n        ec50, n = params\n        fim = np.zeros((2, 2))\n        for c in concentrations:\n            g = grad_func(c, ec50, n)\n            outer_product = np.outer(g, g)\n            fim += outer_product\n            \n        return fim / (SIGMA**2)\n\n    def get_condition_number(fim):\n        \"\"\"\n        Calculates the spectral condition number of a matrix.\n        \"\"\"\n        # eigvalsh is for symmetric/Hermitian matrices and is more stable\n        eigenvalues = np.linalg.eigvalsh(fim)\n        lambda_min = np.min(eigenvalues)\n        lambda_max = np.max(eigenvalues)\n        \n        if lambda_min = LAMBDA_MIN_TOL:\n            return np.inf\n        \n        return lambda_max / lambda_min\n\n    results = []\n    for ec50, n in test_cases:\n        params = (ec50, n)\n        \n        # Calculate FIM for original parameterization\n        fim_orig = calculate_fim(gradient_p, CONCENTRATIONS, params)\n        kappa_orig = get_condition_number(fim_orig)\n        \n        # Calculate FIM for reparameterization\n        fim_repar = calculate_fim(gradient_psi, CONCENTRATIONS, params)\n        kappa_repar = get_condition_number(fim_repar)\n        \n        # Calculate the improvement ratio\n        # np.inf / number -> inf\n        # number / np.inf -> 0.0\n        # np.inf / np.inf -> nan\n        if kappa_repar == 0 or np.isinf(kappa_repar) and np.isinf(kappa_orig):\n            # Avoid division by zero and handle inf/inf\n            ratio = np.nan if np.isinf(kappa_orig) else (np.inf if kappa_orig > 0 and kappa_repar==0 else 0)\n        else:\n            ratio = kappa_orig / kappa_repar\n        \n        results.append(ratio)\n    \n    # Format the final output as specified\n    # Use nan_to_num to handle potential inf/inf cases, replacing nan with a representative value if needed\n    # For this problem, let's keep the string 'nan' if it occurs, as it's informative.\n    print(f\"[{','.join(map(str, np.nan_to_num(results, nan=np.nan, posinf=np.inf, neginf=-np.inf)))}]\")\n\nsolve()\n```"
        }
    ]
}