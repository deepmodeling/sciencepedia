{
    "hands_on_practices": [
        {
            "introduction": "Understanding the ECG forward problem begins with modeling how electrical signals from the heart propagate through the torso's complex tissues. This exercise uses a classic concentric spherical model to build intuition about the effects of tissue heterogeneity on the body surface potential. By deriving the potential in a three-layer model representing the heart, lungs, and torso, you will quantify how the low-conductivity lung layer attenuates and \"smears\" the signal, a crucial concept for accurately interpreting ECGs .",
            "id": "3883439",
            "problem": "Consider the electrocardiogram (ECG) forward problem in the quasi-static regime of Maxwell’s equations, where the electric potential $\\Phi(\\mathbf{r})$ in a conductive medium satisfies $\\nabla \\cdot (\\sigma(\\mathbf{r}) \\nabla \\Phi(\\mathbf{r})) = \\nabla \\cdot \\mathbf{J}_{p}(\\mathbf{r})$ with $\\mathbf{J}_{p}$ the impressed source current density. Model the torso as a concentric three-layer spherical conductor: an inner sphere representing the heart of radius $a_{1}$ and conductivity $\\sigma_{1}$, a spherical shell representing the lungs spanning $a_{1} < r < a_{2}$ with conductivity $\\sigma_{2}$, and an outer spherical shell representing the torso spanning $a_{2} < r < a_{3}$ with conductivity $\\sigma_{3}$. Assume the outer boundary $r = a_{3}$ is insulating, i.e., $\\partial \\Phi/\\partial r \\big|_{r=a_{3}} = 0$. A cardiac source is modeled as a point current dipole of moment $\\mathbf{p} = p \\,\\hat{\\mathbf{z}}$ located at the geometric center $r = 0$.\n\nStarting from the governing equation above and separation-of-variables in spherical coordinates, use Legendre polynomial expansions to derive the analytical expression for the potential in each layer consistent with axial symmetry. Impose continuity of potential and continuity of normal current at $r = a_{1}$ and $r = a_{2}$, and the insulating boundary condition at $r = a_{3}$, to obtain the potential on the outer surface $r = a_{3}$ in terms of the model parameters $p$, $a_{1}$, $a_{2}$, $a_{3}$, $\\sigma_{1}$, $\\sigma_{2}$, and $\\sigma_{3}$. Then, define the attenuation factor due to the lung shell as the ratio of the surface potential amplitude at $r = a_{3}$ for the three-layer model to that for an otherwise identical two-layer model with no lung shell (i.e., the heart of radius $a_{1}$ with conductivity $\\sigma_{1}$ embedded directly in the torso shell $a_{1} < r < a_{3}$ with conductivity $\\sigma_{3}$, and the same insulating boundary at $r = a_{3}$).\n\nExpress your final answer for the attenuation factor as a single closed-form analytic expression in terms of $a_{1}$, $a_{2}$, $a_{3}$, $\\sigma_{1}$, $\\sigma_{2}$, and $\\sigma_{3}$. The attenuation factor is dimensionless; no units are required. Do not provide any numerical evaluation; no rounding is needed.",
            "solution": "### Derivation of the Attenuation Factor\n\nThe governing equation is $\\nabla \\cdot (\\sigma(\\mathbf{r}) \\nabla \\Phi(\\mathbf{r})) = \\nabla \\cdot \\mathbf{J}_{p}(\\mathbf{r})$. The source is a point current dipole at the origin, $\\mathbf{J}_{p}(\\mathbf{r}) = \\mathbf{p} \\delta(\\mathbf{r})$, where $\\delta(\\mathbf{r})$ is the Dirac delta function. The right hand side is $\\nabla \\cdot (\\mathbf{p} \\delta(\\mathbf{r}))$. This source term can be incorporated by considering the primary potential of the dipole in an infinite homogeneous medium of conductivity $\\sigma_1$. This primary potential is $\\Phi_{p}(r, \\theta) = \\frac{1}{4\\pi\\sigma_1} \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{r^3} = \\frac{p \\cos\\theta}{4\\pi\\sigma_1 r^2}$.\n\nIn any region with constant conductivity $\\sigma$ and no sources, the governing equation simplifies to Laplace's equation, $\\nabla^2 \\Phi = 0$.\nDue to the axial symmetry of the dipole source $\\mathbf{p} = p \\hat{\\mathbf{z}}$, the potential $\\Phi$ will only depend on $r$ and $\\theta$. The general solution to Laplace's equation in spherical coordinates with axial symmetry is given by a Legendre polynomial expansion, $\\Phi(r, \\theta) = \\sum_{l=0}^{\\infty} (A_l r^l + B_l r^{-(l+1)}) P_l(\\cos\\theta)$. The dipole source term corresponds to the $l=1$ mode, since $P_1(\\cos\\theta) = \\cos\\theta$. Thus, all coefficients for $l \\neq 1$ will be zero. We can drop the summation and the $P_1(\\cos\\theta)$ factor from the intermediate steps, as it is common to all terms.\n\n**Part 1: Three-Layer Model**\n\nThe potential in each layer can be written as:\n1.  Region $1$ ($0 < r < a_1$, conductivity $\\sigma_1$):\n    $\\Phi_1(r) = S \\sigma_1^{-1} r^{-2} + A_1 r$. Here $S = p/(4\\pi)$ is the dipole source strength factor. The $A_1 r$ term is the secondary potential, which must be regular at the origin.\n2.  Region $2$ ($a_1 < r < a_2$, conductivity $\\sigma_2$):\n    $\\Phi_2(r) = B_2 r + C_2 r^{-2}$.\n3.  Region $3$ ($a_2 < r < a_3$, conductivity $\\sigma_3$):\n    $\\Phi_3(r) = B_3 r + C_3 r^{-2}$.\n\nThe five unknown coefficients ($A_1, B_2, C_2, B_3, C_3$) are determined by the boundary and interface conditions:\n1.  $\\Phi_1(a_1) = \\Phi_2(a_1) \\implies S\\sigma_1^{-1} a_1^{-2} + A_1 a_1 = B_2 a_1 + C_2 a_1^{-2}$\n2.  $\\sigma_1 \\Phi'_1(a_1) = \\sigma_2 \\Phi'_2(a_1) \\implies \\sigma_1(-2S\\sigma_1^{-1}a_1^{-3} + A_1) = \\sigma_2(B_2 - 2C_2 a_1^{-3})$\n3.  $\\Phi_2(a_2) = \\Phi_3(a_2) \\implies B_2 a_2 + C_2 a_2^{-2} = B_3 a_2 + C_3 a_2^{-2}$\n4.  $\\sigma_2 \\Phi'_2(a_2) = \\sigma_3 \\Phi'_3(a_2) \\implies \\sigma_2(B_2 - 2C_2 a_2^{-3}) = \\sigma_3(B_3 - 2C_3 a_2^{-3})$\n5.  $\\Phi'_3(a_3) = 0 \\implies B_3 - 2C_3 a_3^{-3} = 0 \\implies B_3 = 2C_3 a_3^{-3}$\n\nOur goal is the potential amplitude on the outer surface, $V_{3L} = \\Phi_3(a_3)$. Using condition $5$, we get $V_{3L} = B_3 a_3 + C_3 a_3^{-2} = (2C_3 a_3^{-3}) a_3 + C_3 a_3^{-2} = 3C_3 a_3^{-2}$. We need to solve for $C_3$.\nThis system of five linear equations can be solved for $C_3$. The process involves systematic elimination of the other coefficients. We first express $B_2$ and $C_2$ in terms of $C_3$ using conditions $3, 4, 5$. Then we express $A_1$ in terms of $B_2, C_2$ using condition $1$. Finally, substituting everything into condition $2$ yields an equation for $C_3$. Alternatively, we can eliminate $A_1$ from conditions $1$ and $2$. Multiplying condition $1$ by $\\sigma_1 a_1^{-1}$ and subtracting condition $2$ gives:\n$\\sigma_1(S\\sigma_1^{-1}a_1^{-3} + A_1) - \\sigma_1(-2S\\sigma_1^{-1}a_1^{-3} + A_1) = \\sigma_1 a_1^{-1}(B_2 a_1 + C_2 a_1^{-2}) - \\sigma_2(B_2 - 2C_2 a_1^{-3})$\n$3S a_1^{-3} = (\\sigma_1 - \\sigma_2)B_2 + (\\sigma_1 + 2\\sigma_2)C_2 a_1^{-3}$\n$3S = (\\sigma_1 - \\sigma_2)B_2 a_1^3 + (\\sigma_1 + 2\\sigma_2)C_2$\n\nSolving the subsystem for $B_2$ and $C_2$ in terms of $C_3$ (from conditions 3, 4, 5) yields:\n$C_2 = C_3 \\frac{(\\sigma_2+2\\sigma_3) + 2(\\sigma_2-\\sigma_3)(a_2/a_3)^3}{3\\sigma_2}$\n$B_2 = C_3 \\frac{2(2\\sigma_2+\\sigma_3)a_3^{-3} + 2(\\sigma_2-\\sigma_3)a_2^{-3}}{3\\sigma_2}$\n\nSubstituting these into the equation for $3S$ and solving for $C_3$ gives:\n$C_3 = \\frac{9S\\sigma_2}{D_{3L}}$\nwhere the denominator $D_{3L}$ is:\n$D_{3L} = (\\sigma_1 + 2\\sigma_2)(\\sigma_2 + 2\\sigma_3) + 2\\left(\\frac{a_1}{a_2}\\right)^3 (\\sigma_1 - \\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_2}{a_3}\\right)^3 (\\sigma_1 + 2\\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_1}{a_3}\\right)^3 (\\sigma_1 - \\sigma_2)(2\\sigma_2 + \\sigma_3)$.\nThe surface potential amplitude is $V_{3L} = 3C_3 a_3^{-2} = \\frac{27S\\sigma_2 a_3^{-2}}{D_{3L}}$.\n\n**Part 2: Two-Layer Model**\n\nThis model is a special case of the three-layer model where layer $2$ is absent, which can be modeled by setting $a_2=a_1$ or by setting $\\sigma_2 = \\sigma_3$ and ignoring $a_2$. A direct derivation is safer.\n1.  Region $1$ ($0 < r < a_1$, conductivity $\\sigma_1$):\n    $\\Phi_1(r) = S \\sigma_1^{-1} r^{-2} + A'_1 r$\n2.  Region $2'$ ($a_1 < r < a_3$, conductivity $\\sigma_3$):\n    $\\Phi'_2(r) = B'_3 r + C'_3 r^{-2}$\n\nThe three conditions are:\n1.  $\\Phi_1(a_1) = \\Phi'_2(a_1) \\implies S\\sigma_1^{-1} a_1^{-2} + A'_1 a_1 = B'_3 a_1 + C'_3 a_1^{-2}$\n2.  $\\sigma_1 \\Phi'_1(a_1) = \\sigma_3 \\Phi'_2(a_1) \\implies \\sigma_1(-2S\\sigma_1^{-1}a_1^{-3} + A'_1) = \\sigma_3(B'_3 - 2C'_3 a_1^{-3})$\n3.  $\\Phi'_2(a_3) = 0 \\implies B'_3 - 2C'_3 a_3^{-3} = 0 \\implies B'_3 = 2C'_3 a_3^{-3}$\n\nThe surface potential amplitude is $V_{2L} = \\Phi'_2(a_3) = B'_3 a_3 + C'_3 a_3^{-2} = 3C'_3 a_3^{-2}$. We solve for $C'_3$.\nEliminating $A'_1$ from conditions $1$ and $2$ gives:\n$3S a_1^{-3} = (\\sigma_1 - \\sigma_3)B'_3 + (\\sigma_1+2\\sigma_3)C'_3 a_1^{-3}$\nSubstitute $B'_3 = 2C'_3 a_3^{-3}$ (condition $3$):\n$3S a_1^{-3} = (\\sigma_1 - \\sigma_3)(2C'_3 a_3^{-3}) + (\\sigma_1+2\\sigma_3)C'_3 a_1^{-3}$\n$3S = C'_3 \\left( 2(\\sigma_1 - \\sigma_3)\\left(\\frac{a_1}{a_3}\\right)^3 + (\\sigma_1+2\\sigma_3) \\right)$\nSo, $C'_3 = \\frac{3S}{D_{2L}}$, where $D_{2L} = (\\sigma_1+2\\sigma_3) + 2(\\sigma_1-\\sigma_3)\\left(\\frac{a_1}{a_3}\\right)^3$.\nThe surface potential amplitude is $V_{2L} = 3C'_3 a_3^{-2} = \\frac{9S a_3^{-2}}{D_{2L}}$.\n\n**Part 3: Attenuation Factor**\n\nThe attenuation factor $\\mathcal{A}$ is the ratio of the two surface potential amplitudes:\n$\\mathcal{A} = \\frac{V_{3L}}{V_{2L}} = \\frac{27S\\sigma_2 a_3^{-2}/D_{3L}}{9S a_3^{-2}/D_{2L}} = \\frac{3\\sigma_2 D_{2L}}{D_{3L}}$.\nSubstituting the expressions for $D_{2L}$ and $D_{3L}$:\n$\\mathcal{A} = \\frac{3\\sigma_2 \\left[ (\\sigma_1 + 2\\sigma_3) + 2(\\sigma_1 - \\sigma_3) \\left(\\frac{a_1}{a_3}\\right)^3 \\right]}{(\\sigma_1 + 2\\sigma_2)(\\sigma_2 + 2\\sigma_3) + 2\\left(\\frac{a_1}{a_2}\\right)^3 (\\sigma_1 - \\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_2}{a_3}\\right)^3 (\\sigma_1 + 2\\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_1}{a_3}\\right)^3 (\\sigma_1 - \\sigma_2)(2\\sigma_2 + \\sigma_3)}$\nThis is the final closed-form analytical expression for the attenuation factor.",
            "answer": "$$\n\\boxed{\n\\frac{3\\sigma_2 \\left[ (\\sigma_1 + 2\\sigma_3) + 2(\\sigma_1 - \\sigma_3) \\left(\\frac{a_1}{a_3}\\right)^3 \\right]}{(\\sigma_1 + 2\\sigma_2)(\\sigma_2 + 2\\sigma_3) + 2\\left(\\frac{a_1}{a_2}\\right)^3 (\\sigma_1 - \\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_2}{a_3}\\right)^3 (\\sigma_1 + 2\\sigma_2)(\\sigma_2 - \\sigma_3) + 2\\left(\\frac{a_1}{a_3}\\right)^3 (\\sigma_1 - \\sigma_2)(2\\sigma_2 + \\sigma_3)}\n}\n$$"
        },
        {
            "introduction": "Once potentials are established within the torso, the next step is understanding how they are measured by surface electrodes. This practice introduces the powerful principle of reciprocity and the concept of the lead field, which describes an electrode's sensitivity to cardiac sources. You will apply the method of images and integrate over an electrode's surface to calculate the measured voltage, providing a rigorous link between an internal dipole source and the signal captured by a unipolar ECG lead .",
            "id": "3883395",
            "problem": "A homogeneous, isotropic torso volume conductor is modeled as the upper half-space $\\{(x,y,z) \\in \\mathbb{R}^{3} : z > 0\\}$ with constant conductivity $\\sigma$. The body surface is modeled by the plane $z=0$. Consider a unipolar electrocardiogram (ECG) lead realized by injecting a total current $I=1$ ampere uniformly over a circular electrode patch of radius $a$ centered at the origin on the plane $z=0$, and withdrawing the return current uniformly over a distant concentric annulus between radii $a$ and $R$, with $R \\to \\infty$. Assume the current density on the circular disk is uniform and equal to $j_{0} = I/(\\pi a^{2})$ on $\\{x^{2}+y^{2} \\le a^{2}, z=0\\}$, and the remainder of the plane is insulating in the limit $R \\to \\infty$.\n\nInside the torso, the impressed cardiac source is modeled by a point current dipole of moment $\\mathbf{p} = p\\,\\hat{\\mathbf{z}}$ (magnitude $p$ and oriented along the positive $z$-axis) located at $\\mathbf{x}_{0} = (0,0,d)$ with $d>0$. Let $u_{L}(\\mathbf{x})$ be the lead field potential satisfying $\\nabla \\cdot (\\sigma \\nabla u_{L}) = 0$ in $z>0$ with Neumann boundary condition $-\\sigma \\,\\partial u_{L}/\\partial n = j_{n}$ on $z=0$, where $j_{n}$ is the normal current density corresponding to the described electrode configuration ($j_{n}=j_{0}$ on the disk, vanishing elsewhere in the limit $R \\to \\infty$). Using the reciprocity theorem for volume conductors and the appropriate Green’s function for the upper half-space, express the measured lead voltage $V$ due to the dipole source as a boundary integral of the Green’s function weighted by the electrode flux $j_{n}$, and evaluate $V$ in closed form for this configuration.\n\nYour derivation must start from the governing field equations $\\mathbf{J} = -\\sigma \\nabla u$ and $\\nabla \\cdot \\mathbf{J} = 0$ in the passive region, and use the reciprocity relation connecting the lead voltage to the lead field. You may invoke the method of images to construct the Neumann Green’s function for the half-space. Assume the return annulus contribution vanishes as $R \\to \\infty$.\n\nProvide the final result as a single closed-form analytic expression for $V$ in terms of $a$, $d$, $\\sigma$, and $p$. Express $V$ in volts. No numerical substitution is required and no rounding is needed.",
            "solution": "The problem asks for the voltage $V$ measured by a unipolar ECG lead due to a point current dipole source within a homogeneous, isotropic half-space conductor. The solution will be derived using the principle of reciprocity.\n\nThe cardiac source is a point current dipole with moment $\\mathbf{p} = p\\,\\hat{\\mathbf{z}}$ located at $\\mathbf{x}_{0} = (0,0,d)$ in the conductor, which occupies the region $z>0$. The impressed current density for such a source is $\\mathbf{J}_{i}(\\mathbf{x}) = \\mathbf{p}\\,\\delta(\\mathbf{x} - \\mathbf{x}_{0})$, where $\\delta(\\cdot)$ is the $3$D Dirac delta function.\n\nThe reciprocity theorem for a volume conductor relates the voltage $V$ measured by a lead to the impressed current source $\\mathbf{J}_i$ and the lead field potential $u_L$. The lead field potential $u_L$ is the potential that would exist in the conductor if the lead electrodes were energized with a current. For a dipole source, the reciprocity theorem simplifies to:\n$$V = \\mathbf{p} \\cdot \\nabla u_{L}(\\mathbf{x}_{0})$$\nTo find $V$, we must first determine the lead field potential $u_{L}(\\mathbf{x})$ and then compute its gradient at the source location $\\mathbf{x}_{0}$.\n\nThe lead field potential $u_L$ is governed by Laplace's equation in the source-free conductor volume, as the energizing currents are applied at the boundary:\n$$\\nabla^2 u_{L}(\\mathbf{x}) = 0 \\quad \\text{for } z > 0$$\nThe boundary condition on the surface $z=0$ is given by the injected current density $j_n$. The problem states $-\\sigma \\,\\partial u_{L}/\\partial n = j_{n}$. The outward normal from the conductor volume $z>0$ at the boundary $z=0$ is $\\hat{\\mathbf{n}} = -\\hat{\\mathbf{z}}$. Therefore, the boundary condition is:\n$$-\\sigma \\frac{\\partial u_{L}}{\\partial (-z)} = \\sigma \\frac{\\partial u_{L}}{\\partial z} = j_{n}(x,y)$$\nThe current density $j_n$ is uniform over a circular patch of radius $a$ and zero elsewhere, as the return current is at infinity. The total injected current is $I=1$ ampere, so the current density is $j_0 = I/(\\pi a^2) = 1/(\\pi a^2)$.\n$$j_{n}(x,y) = \\begin{cases} \\frac{1}{\\pi a^2} & \\text{if } x^2+y^2 \\le a^2 \\\\ 0 & \\text{if } x^2+y^2 > a^2 \\end{cases}$$\nThe solution to this Neumann boundary value problem can be constructed using the appropriate Green's function. The potential $u_L(\\mathbf{x})$ at a point $\\mathbf{x}$ in the volume due to a surface current density $j_n(\\mathbf{x}')$ at $\\mathbf{x}'$ on the boundary is given by:\n$$u_{L}(\\mathbf{x}) = \\int_{z'=0} \\frac{j_n(\\mathbf{x}')}{\\sigma} G_N(\\mathbf{x}, \\mathbf{x}') \\, dx' dy'$$\nwhere $G_N(\\mathbf{x}, \\mathbf{x}')$ is the Neumann Green's function for the half-space, which satisfies $\\nabla^2 G_N = -\\delta(\\mathbf{x}-\\mathbf{x}')$ in $z>0$ and $\\partial G_N / \\partial z' = 0$ on $z'=0$. Using the method of images for a source at $\\mathbf{x}'=(x',y',z')$, we place an image source of the same sign at $\\mathbf{x}'_{image}=(x',y',-z')$. When the source point $\\mathbf{x}'$ is on the boundary ($z'=0$), the source and image coincide, yielding:\n$$G_N(\\mathbf{x}, (x',y',0)) = 2 \\times G_{\\text{free-space}} = 2 \\times \\frac{1}{4\\pi |\\mathbf{x} - \\mathbf{x}'|} = \\frac{1}{2\\pi \\sqrt{(x-x')^2 + (y-y')^2 + z^2}}$$\nSubstituting this and $j_n$ into the integral for $u_L$:\n$$u_{L}(\\mathbf{x}) = \\int_{x'^2+y'^2 \\le a^2} \\frac{1/(\\pi a^2)}{\\sigma} \\frac{1}{2\\pi \\sqrt{(x-x')^2 + (y-y')^2 + z^2}} \\, dx' dy'$$\n$$u_{L}(\\mathbf{x}) = \\frac{1}{2\\pi^2 a^2 \\sigma} \\int_{x'^2+y'^2 \\le a^2} \\frac{dx' dy'}{\\sqrt{(x-x')^2 + (y-y')^2 + z^2}}$$\nNext, we compute the gradient $\\nabla u_L(\\mathbf{x})$ and evaluate it at $\\mathbf{x}_0 = (0,0,d)$. We can differentiate under the integral sign:\n$$\\nabla u_{L}(\\mathbf{x}) = -\\frac{1}{2\\pi^2 a^2 \\sigma} \\int_{x'^2+y'^2 \\le a^2} \\frac{(x-x', y-y', z)}{\\left( (x-x')^2 + (y-y')^2 + z^2 \\right)^{3/2}} \\, dx' dy'$$\nEvaluating at $\\mathbf{x}_0 = (0,0,d)$:\n$$\\nabla u_{L}(\\mathbf{x}_0) = -\\frac{1}{2\\pi^2 a^2 \\sigma} \\int_{x'^2+y'^2 \\le a^2} \\frac{(-x', -y', d)}{\\left( x'^2 + y'^2 + d^2 \\right)^{3/2}} \\, dx' dy'$$\nDue to the circular symmetry of the integration domain, the integrals of the $x$ and $y$ components, which have odd integrands in $x'$ and $y'$ respectively, are zero. The only non-zero component is along the $z$-axis:\n$$\\frac{\\partial u_{L}}{\\partial z}\\bigg|_{\\mathbf{x}_0} = -\\frac{1}{2\\pi^2 a^2 \\sigma} \\int_{x'^2+y'^2 \\le a^2} \\frac{d}{\\left( x'^2 + y'^2 + d^2 \\right)^{3/2}} \\, dx' dy'$$\nTo evaluate this integral, we switch to polar coordinates for the integration variables: $x' = r' \\cos\\theta'$, $y' = r' \\sin\\theta'$, $dx' dy' = r' dr' d\\theta'$.\n$$\\frac{\\partial u_{L}}{\\partial z}\\bigg|_{\\mathbf{x}_0} = -\\frac{d}{2\\pi^2 a^2 \\sigma} \\int_0^{2\\pi} \\int_0^a \\frac{r' dr' d\\theta'}{(r'^2 + d^2)^{3/2}}$$\nThe integral over $\\theta'$ yields $2\\pi$:\n$$\\frac{\\partial u_{L}}{\\partial z}\\bigg|_{\\mathbf{x}_0} = -\\frac{2\\pi d}{2\\pi^2 a^2 \\sigma} \\int_0^a \\frac{r'}{(r'^2 + d^2)^{3/2}} dr' = -\\frac{d}{\\pi a^2 \\sigma} \\int_0^a \\frac{r'}{(r'^2 + d^2)^{3/2}} dr'$$\nThe remaining integral can be solved with a substitution $u = r'^2+d^2$, $du = 2r' dr'$:\n$$\\int_0^a \\frac{r' dr'}{(r'^2+d^2)^{3/2}} = \\frac{1}{2} \\int_{d^2}^{a^2+d^2} u^{-3/2} du = \\frac{1}{2} \\left[ -2u^{-1/2} \\right]_{d^2}^{a^2+d^2} = \\left[ -\\frac{1}{\\sqrt{u}} \\right]_{d^2}^{a^2+d^2} = -\\frac{1}{\\sqrt{a^2+d^2}} + \\frac{1}{\\sqrt{d^2}} = \\frac{1}{d} - \\frac{1}{\\sqrt{a^2+d^2}}$$\nSubstituting this back gives the gradient component:\n$$\\frac{\\partial u_{L}}{\\partial z}\\bigg|_{\\mathbf{x}_0} = -\\frac{d}{\\pi a^2 \\sigma} \\left( \\frac{1}{d} - \\frac{1}{\\sqrt{a^2+d^2}} \\right) = -\\frac{1}{\\pi a^2 \\sigma} \\left( 1 - \\frac{d}{\\sqrt{a^2+d^2}} \\right)$$\nSo, the gradient vector at the dipole location is $\\nabla u_{L}(\\mathbf{x}_0) = \\left(0, 0, -\\frac{1}{\\pi a^2 \\sigma} \\left( 1 - \\frac{d}{\\sqrt{a^2+d^2}} \\right) \\right)$.\n\nFinally, we find the measured voltage $V$ using the reciprocity relation:\n$$V = \\mathbf{p} \\cdot \\nabla u_{L}(\\mathbf{x}_{0}) = (0,0,p) \\cdot \\left(0, 0, -\\frac{1}{\\pi a^2 \\sigma} \\left( 1 - \\frac{d}{\\sqrt{a^2+d^2}} \\right) \\right)$$\n$$V = -\\frac{p}{\\pi a^2 \\sigma} \\left( 1 - \\frac{d}{\\sqrt{a^2+d^2}} \\right) = \\frac{p}{\\pi a^2 \\sigma} \\left( \\frac{d}{\\sqrt{a^2+d^2}} - 1 \\right)$$\nThis is the closed-form expression for the measured lead voltage.",
            "answer": "$$\n\\boxed{\n\\frac{p}{\\pi a^2 \\sigma} \\left( \\frac{d}{\\sqrt{a^2 + d^2}} - 1 \\right)\n}\n$$"
        },
        {
            "introduction": "The final link in the modeling chain is the boundary between the body and the measurement apparatus. While often simplified as perfectly insulating, the torso-air interface is more realistically modeled with a finite impedance due to the electrode-skin connection. This exercise challenges you to compare the ideal insulating Neumann boundary condition with a more realistic impedance-based Robin boundary condition, allowing you to quantify the error introduced by the simpler assumption and appreciate its impact on computed lead amplitudes .",
            "id": "3883450",
            "problem": "You are tasked with deriving and implementing an Electrocardiogram (ECG) forward model to quantitatively compare surface lead amplitudes computed with Neumann versus Robin boundary conditions for a homogeneous spherical torso. The model assumptions are as follows. The torso is represented by a homogeneous sphere of radius $R$ and conductivity $\\sigma$, containing a current dipole of magnitude $p$ located at the center and oriented along the $z$-axis. The electric potential $\\phi(\\mathbf{r})$ in the quasi-static conduction limit obeys the elliptic partial differential equation\n$$\n\\nabla \\cdot \\left(\\sigma \\nabla \\phi(\\mathbf{r})\\right) = - \\nabla \\cdot \\mathbf{J}_s(\\mathbf{r}),\n$$\nwhere the source current density is a point dipole given by\n$$\n\\mathbf{J}_s(\\mathbf{r}) = \\mathbf{p} \\,\\delta(\\mathbf{r}),\n\\quad\n\\mathbf{p} = p\\,\\hat{\\mathbf{z}}.\n$$\nTwo boundary models at the spherical surface $r=R$ must be considered:\n1. Neumann (insulating exterior medium): \n$$\n\\sigma \\,\\frac{\\partial \\phi}{\\partial n}\\bigg|_{r=R} = 0.\n$$\n2. Robin (uniform shunt to a distant reference through finite contact impedance): \n$$\n\\sigma \\,\\frac{\\partial \\phi}{\\partial n}\\bigg|_{r=R} + \\kappa\\,\\phi(R,\\theta) = 0,\n\\quad\n\\kappa = \\frac{1}{Z_c\\,4\\pi R^2}.\n$$\nThe Robin coefficient $\\kappa$ represents a spatially uniform surface admittance density equal to the total shunt admittance $1/Z_c$ spread over the spherical area $4\\pi R^2$, so that $\\kappa$ has units $\\text{S}/\\text{m}^2$ and renders $\\sigma \\,\\partial \\phi/\\partial n + \\kappa\\,\\phi$ in units of $\\text{A}/\\text{m}^2$. This idealized boundary captures the effect of finite contact impedance without prescribing electrode patches. Angles are measured with respect to the dipole axis.\n\nUsing only first principles and well-tested facts in electro-quasistatics and spherical harmonics, derive surface potentials $\\phi(R,\\theta)$ for both boundary models for a central dipole, and then the lead amplitude defined as the voltage difference between two surface points at polar angles $\\theta_1$ and $\\theta_2$:\n$$\n\\Delta V = \\phi(R,\\theta_1) - \\phi(R,\\theta_2).\n$$\nExpress lead amplitudes in volts ($\\text{V}$). Then compute the percentage difference between the Robin and Neumann lead amplitudes as\n$$\n\\delta = \\frac{\\Delta V_{\\text{Robin}} - \\Delta V_{\\text{Neumann}}}{\\Delta V_{\\text{Neumann}}},\n$$\nand report $\\delta$ as a decimal fraction (for example, $0.123$ means $12.3$ percent), with no percentage sign.\n\nYour program must use $Z_c = 1\\,\\text{k}\\Omega$ and implement the formulas you derive to compute $\\delta$ for the following test suite. Angles are in $\\text{radians}$, radii in $\\text{m}$, conductivity in $\\text{S}/\\text{m}$, and dipole moment in $\\text{A}\\cdot\\text{m}$:\n\n- Test case $1$: $R = 0.15\\,\\text{m}$, $\\sigma = 0.20\\,\\text{S}/\\text{m}$, $p = 1.0\\times 10^{-5}\\,\\text{A}\\cdot\\text{m}$, $\\theta_1 = 0$, $\\theta_2 = \\pi$.\n- Test case $2$: $R = 0.15\\,\\text{m}$, $\\sigma = 0.05\\,\\text{S}/\\text{m}$, $p = 1.0\\times 10^{-5}\\,\\text{A}\\cdot\\text{m}$, $\\theta_1 = \\pi/3$, $\\theta_2 = 2\\pi/3$.\n- Test case $3$: $R = 0.10\\,\\text{m}$, $\\sigma = 0.20\\,\\text{S}/\\text{m}$, $p = 1.0\\times 10^{-5}\\,\\text{A}\\cdot\\text{m}$, $\\theta_1 = \\pi/4$, $\\theta_2 = 3\\pi/4$.\n- Test case $4$: $R = 0.15\\,\\text{m}$, $\\sigma = 0.20\\,\\text{S}/\\text{m}$, $p = 1.0\\times 10^{-6}\\,\\text{A}\\cdot\\text{m}$, $\\theta_1 = 0.49\\pi$, $\\theta_2 = 0.51\\pi$.\n- Test case $5$: $R = 0.20\\,\\text{m}$, $\\sigma = 0.25\\,\\text{S}/\\text{m}$, $p = 1.0\\times 10^{-5}\\,\\text{A}\\cdot\\text{m}$, $\\theta_1 = 0$, $\\theta_2 = \\pi$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets (for example, $[\\delta_1,\\delta_2,\\delta_3,\\delta_4,\\delta_5]$). Each $\\delta_i$ must be printed as a floating-point number rounded to six decimal places.",
            "solution": "### Derivation of Surface Potentials and Relative Difference\n\nThe governing equation for the potential $\\phi$ in a homogeneous medium of conductivity $\\sigma$ is:\n$$\n\\nabla \\cdot (\\sigma \\nabla \\phi) = -\\nabla \\cdot \\mathbf{J}_s\n$$\nSince $\\sigma$ is a constant scalar, this simplifies to Poisson's equation:\n$$\n\\sigma \\nabla^2 \\phi = -\\nabla \\cdot \\mathbf{J}_s\n$$\nThe source term is a current dipole at the origin, $\\mathbf{J}_s(\\mathbf{r}) = \\mathbf{p} \\delta(\\mathbf{r})$. Its divergence is $\\nabla \\cdot \\mathbf{J}_s = \\mathbf{p} \\cdot \\nabla\\delta(\\mathbf{r})$. The equation becomes:\n$$\n\\nabla^2 \\phi = -\\frac{1}{\\sigma} \\mathbf{p} \\cdot \\nabla\\delta(\\mathbf{r})\n$$\nThe potential for a current dipole $\\mathbf{p}$ at the origin in an infinite homogeneous medium is the particular solution to this equation:\n$$\n\\phi_{\\text{source}}(r, \\theta) = \\frac{\\mathbf{p} \\cdot \\mathbf{r}}{4\\pi\\sigma r^3} = \\frac{p r \\cos\\theta}{4\\pi\\sigma r^3} = \\frac{p \\cos\\theta}{4\\pi\\sigma r^2}\n$$\nIn spherical coordinates, with $\\mathbf{p}$ along the $z$-axis, this depends only on $r$ and the polar angle $\\theta$. The total potential inside the sphere is the sum of this source potential and a solution to Laplace's equation ($\\nabla^2\\phi=0$) that is regular at the origin. This reaction potential accounts for the boundary effects.\n\nDue to the problem's azimuthal symmetry and the $\\cos\\theta$ dependence of the source (which corresponds to the Legendre polynomial $P_1(\\cos\\theta)$), the general solution inside the sphere can be written as:\n$$\n\\phi(r, \\theta) = \\left( \\frac{p}{4\\pi\\sigma} r^{-2} + A r \\right) P_1(\\cos\\theta) = \\left( \\frac{p}{4\\pi\\sigma r^2} + A r \\right) \\cos\\theta\n$$\nHere, $A$ is an unknown coefficient to be determined by the boundary conditions. An additive constant term ($l=0$) is also possible, but it vanishes for the Robin case and is irrelevant for the potential differences calculated in the Neumann case, so we can omit it.\n\nThe radial derivative is:\n$$\n\\frac{\\partial \\phi}{\\partial r} = \\left( -2 \\frac{p}{4\\pi\\sigma r^3} + A \\right) \\cos\\theta\n$$\nWe apply the boundary conditions at the surface $r=R$. The outward normal derivative is $\\frac{\\partial}{\\partial n} = \\frac{\\partial}{\\partial r}$.\n\n**1. Neumann Boundary Condition**\nThe condition is $\\sigma \\frac{\\partial \\phi}{\\partial r}\\big|_{r=R} = 0$.\n$$\n\\sigma \\left( -2 \\frac{p}{4\\pi\\sigma R^3} + A_N \\right) \\cos\\theta = 0\n$$\nFor this to hold for all $\\theta$, the term in parentheses must be zero.\n$$\nA_N = \\frac{2p}{4\\pi\\sigma R^3}\n$$\nSubstituting $A_N$ into the expression for $\\phi(r,\\theta)$ and evaluating at $r=R$:\n$$\n\\phi_N(R, \\theta) = \\left( \\frac{p}{4\\pi\\sigma R^2} + \\frac{2p}{4\\pi\\sigma R^3} R \\right) \\cos\\theta = \\frac{3p}{4\\pi\\sigma R^2} \\cos\\theta\n$$\n\n**2. Robin Boundary Condition**\nThe condition is $\\sigma \\frac{\\partial \\phi}{\\partial r}\\big|_{r=R} + \\kappa \\phi(R, \\theta) = 0$.\n$$\n\\sigma \\left( -2 \\frac{p}{4\\pi\\sigma R^3} + A_R \\right) \\cos\\theta + \\kappa \\left( \\frac{p}{4\\pi\\sigma R^2} + A_R R \\right) \\cos\\theta = 0\n$$\nAgain, the coefficient of $\\cos\\theta$ must be zero.\n$$\n\\sigma \\left( -2 \\frac{p}{4\\pi\\sigma R^3} + A_R \\right) + \\kappa \\left( \\frac{p}{4\\pi\\sigma R^2} + A_R R \\right) = 0\n$$\n$$\n-\\frac{2p}{4\\pi R^3} + \\sigma A_R + \\frac{\\kappa p}{4\\pi\\sigma R^2} + \\kappa A_R R = 0\n$$\nSolving for $A_R$:\n$$\nA_R (\\sigma + \\kappa R) = \\frac{2p}{4\\pi R^3} - \\frac{\\kappa p}{4\\pi\\sigma R^2} = \\frac{p}{4\\pi\\sigma R^3} (2\\sigma - \\kappa R)\n$$\n$$\nA_R = \\frac{p}{4\\pi\\sigma R^3} \\frac{2\\sigma - \\kappa R}{\\sigma + \\kappa R}\n$$\nSubstituting $A_R$ into the potential at $r=R$:\n$$\n\\phi_R(R, \\theta) = \\left( \\frac{p}{4\\pi\\sigma R^2} + A_R R \\right) \\cos\\theta = \\frac{p}{4\\pi\\sigma R^2} \\left( 1 + \\frac{2\\sigma - \\kappa R}{\\sigma + \\kappa R} \\right) \\cos\\theta\n$$\nSimplifying the term in the parenthesis:\n$$\n1 + \\frac{2\\sigma - \\kappa R}{\\sigma + \\kappa R} = \\frac{\\sigma + \\kappa R + 2\\sigma - \\kappa R}{\\sigma + \\kappa R} = \\frac{3\\sigma}{\\sigma + \\kappa R}\n$$\nSo, the surface potential for the Robin case is:\n$$\n\\phi_R(R, \\theta) = \\frac{p}{4\\pi\\sigma R^2} \\frac{3\\sigma}{\\sigma + \\kappa R} \\cos\\theta = \\frac{3p}{4\\pi R^2 (\\sigma + \\kappa R)} \\cos\\theta\n$$\n\n**3. Lead Amplitudes and Relative Difference**\nThe lead amplitude for the Neumann case is:\n$$\n\\Delta V_N = \\phi_N(R, \\theta_1) - \\phi_N(R, \\theta_2) = \\frac{3p}{4\\pi\\sigma R^2} (\\cos\\theta_1 - \\cos\\theta_2)\n$$\nThe lead amplitude for the Robin case is:\n$$\n\\Delta V_R = \\phi_R(R, \\theta_1) - \\phi_R(R, \\theta_2) = \\frac{3p}{4\\pi R^2 (\\sigma + \\kappa R)} (\\cos\\theta_1 - \\cos\\theta_2)\n$$\nThe relative difference $\\delta$ is defined as:\n$$\n\\delta = \\frac{\\Delta V_R - \\Delta V_N}{\\Delta V_N} = \\frac{\\Delta V_R}{\\Delta V_N} - 1\n$$\nTaking the ratio:\n$$\n\\frac{\\Delta V_R}{\\Delta V_N} = \\frac{\\frac{3p}{4\\pi R^2 (\\sigma + \\kappa R)} (\\cos\\theta_1 - \\cos\\theta_2)}{\\frac{3p}{4\\pi\\sigma R^2} (\\cos\\theta_1 - \\cos\\theta_2)} = \\frac{\\sigma}{\\sigma + \\kappa R}\n$$\nThis elegant simplification shows that the ratio is independent of the dipole moment $p$ and the electrode positions $\\theta_1, \\theta_2$ (provided $\\cos\\theta_1 \\neq \\cos\\theta_2$).\nNow, we find $\\delta$:\n$$\n\\delta = \\frac{\\sigma}{\\sigma + \\kappa R} - 1 = \\frac{\\sigma - (\\sigma + \\kappa R)}{\\sigma + \\kappa R} = \\frac{-\\kappa R}{\\sigma + \\kappa R}\n$$\nFinally, we substitute the definition of $\\kappa = \\frac{1}{Z_c 4\\pi R^2}$:\n$$\n\\delta = \\frac{-\\left(\\frac{1}{Z_c 4\\pi R^2}\\right) R}{\\sigma + \\left(\\frac{1}{Z_c 4\\pi R^2}\\right) R} = \\frac{-\\frac{1}{4\\pi Z_c R}}{\\sigma + \\frac{1}{4\\pi Z_c R}}\n$$\nTo simplify further, we multiply the numerator and denominator by $4\\pi Z_c R$:\n$$\n\\delta = \\frac{-1}{4\\pi \\sigma Z_c R + 1}\n$$\nThis is the final formula to be implemented. The parameters $p$, $\\theta_1$, and $\\theta_2$ are extraneous for calculating $\\delta$, though they are necessary to define the lead voltages themselves.",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Derives and implements an ECG forward model to compare surface lead amplitudes\n    computed with Neumann versus Robin boundary conditions for a homogeneous\n    spherical torso. The relative difference is calculated for a suite of test cases.\n    \"\"\"\n    \n    # The relative difference, delta, is given by the derived formula:\n    # delta = -1 / (4 * pi * sigma * Z_c * R + 1)\n    # where all parameters are in SI units.\n    \n    # Constant parameter from the problem statement\n    Z_c = 1000.0  # Contact impedance in Ohms (1 kOhm)\n\n    # Test cases from the problem statement.\n    # Each tuple contains: (R in m, sigma in S/m)\n    # The other parameters (p, theta1, theta2) are not needed for calculating delta.\n    test_cases = [\n        (0.15, 0.20),  # Test case 1\n        (0.15, 0.05),  # Test case 2\n        (0.10, 0.20),  # Test case 3\n        (0.15, 0.20),  # Test case 4\n        (0.20, 0.25),  # Test case 5\n    ]\n\n    results = []\n    for case in test_cases:\n        R, sigma = case\n        \n        # Calculate the denominator of the derived formula for delta.\n        # The term 4*pi*sigma*Z_c*R is dimensionless.\n        denominator = 4 * np.pi * sigma * Z_c * R + 1\n        \n        # Calculate delta\n        delta = -1.0 / denominator\n        \n        # Round the result to six decimal places as required.\n        results.append(round(delta, 6))\n\n    # Format the final output as a comma-separated list in square brackets.\n    # The map(str, ...) ensures each number is converted to its string representation.\n    print(f\"[{','.join(map(str, results))}]\")\n\n# Execute the solver function.\nsolve()\n```"
        }
    ]
}