{
    "hands_on_practices": [
        {
            "introduction": "Metabolic Control Analysis begins with understanding the local properties of each component in a system. The elasticity coefficient, $\\epsilon$, is our primary tool for this, quantifying the sensitivity of a single enzyme's reaction rate to changes in metabolite concentrations. This first exercise  provides practice in deriving this fundamental parameter for an enzyme following the ubiquitous Michaelis-Menten kinetics, a cornerstone calculation for any systems biologist.",
            "id": "1498186",
            "problem": "A bioengineer is investigating a critical enzyme in a synthetic metabolic pathway. The enzyme is known to follow simple Michaelis-Menten kinetics, where its reaction rate, $v$, is described by the equation:\n$$\nv = \\frac{V_{\\text{max}} S}{K_M + S}\n$$\nIn this model, $S$ represents the concentration of the substrate, $V_{\\text{max}}$ is the maximum possible reaction rate, and $K_M$ is the Michaelis constant. To understand how fluctuations in substrate levels affect the enzyme's activity, the bioengineer uses Metabolic Control Analysis (MCA). A key parameter in MCA is the elasticity coefficient, $\\epsilon_S^v$, which provides a dimensionless measure of an enzyme's local sensitivity to changes in the concentration of a metabolite. For the substrate $S$, this coefficient quantifies the fractional change in the enzyme's rate $v$ resulting from an infinitesimal fractional change in the substrate concentration $S$.\n\nDerive an analytical expression for the elasticity coefficient $\\epsilon_S^v$ as a function of the substrate concentration $S$ and the Michaelis constant $K_M$.",
            "solution": "The elasticity coefficient, $\\epsilon_S^v$, is defined as the partial derivative of the natural logarithm of the reaction rate $v$ with respect to the natural logarithm of the substrate concentration $S$. An equivalent and more direct definition for calculation is:\n$$\n\\epsilon_S^v = \\frac{\\partial v}{\\partial S} \\frac{S}{v}\n$$\nThe problem provides the Michaelis-Menten equation for the reaction rate $v$ as a function of the substrate concentration $S$:\n$$\nv(S) = \\frac{V_{\\text{max}} S}{K_M + S}\n$$\nFirst, we must calculate the partial derivative of the rate $v$ with respect to the substrate concentration $S$, which is $\\frac{\\partial v}{\\partial S}$. We use the quotient rule for differentiation, which states that for a function $f(x) = \\frac{g(x)}{h(x)}$, the derivative is $f'(x) = \\frac{g'(x)h(x) - g(x)h'(x)}{[h(x)]^2}$.\n\nIn our case, $g(S) = V_{\\text{max}} S$ and $h(S) = K_M + S$. Their derivatives with respect to $S$ are:\n$$\n\\frac{\\partial g}{\\partial S} = V_{\\text{max}}\n$$\n$$\n\\frac{\\partial h}{\\partial S} = 1\n$$\nApplying the quotient rule to $v(S)$:\n$$\n\\frac{\\partial v}{\\partial S} = \\frac{(V_{\\text{max}})(K_M + S) - (V_{\\text{max}} S)(1)}{(K_M + S)^2}\n$$\nNow, we expand the numerator:\n$$\n\\frac{\\partial v}{\\partial S} = \\frac{V_{\\text{max}} K_M + V_{\\text{max}} S - V_{\\text{max}} S}{(K_M + S)^2}\n$$\nThe terms $V_{\\text{max}} S$ and $-V_{\\text{max}} S$ cancel out, simplifying the derivative to:\n$$\n\\frac{\\partial v}{\\partial S} = \\frac{V_{\\text{max}} K_M}{(K_M + S)^2}\n$$\nNow we substitute this derivative back into the definition of the elasticity coefficient:\n$$\n\\epsilon_S^v = \\left( \\frac{V_{\\text{max}} K_M}{(K_M + S)^2} \\right) \\frac{S}{v}\n$$\nNext, we substitute the original expression for $v = \\frac{V_{\\text{max}} S}{K_M + S}$ into this equation:\n$$\n\\epsilon_S^v = \\left( \\frac{V_{\\text{max}} K_M}{(K_M + S)^2} \\right) \\frac{S}{\\frac{V_{\\text{max}} S}{K_M + S}}\n$$\nTo simplify this complex fraction, we can multiply by the reciprocal of the denominator:\n$$\n\\epsilon_S^v = \\frac{V_{\\text{max}} K_M}{(K_M + S)^2} \\cdot \\frac{S(K_M + S)}{V_{\\text{max}} S}\n$$\nNow, we can cancel common terms in the numerator and the denominator. The term $V_{\\text{max}}$ cancels out. The term $S$ also cancels out. One factor of $(K_M + S)$ in the numerator cancels with one of the two factors in the denominator.\n$$\n\\epsilon_S^v = \\frac{\\cancel{V_{\\text{max}}} K_M}{(\\cancel{K_M + S})(K_M+S)} \\cdot \\frac{\\cancel{S}(\\cancel{K_M + S})}{\\cancel{V_{\\text{max}}} \\cancel{S}}\n$$\nAfter cancellation, we are left with the final expression for the elasticity coefficient:\n$$\n\\epsilon_S^v = \\frac{K_M}{K_M + S}\n$$\nThis expression gives the elasticity of a Michaelis-Menten enzyme with respect to its substrate as a function of the substrate concentration $S$ and the Michaelis constant $K_M$.",
            "answer": "$$\\boxed{\\frac{K_M}{K_M + S}}$$"
        },
        {
            "introduction": "While elasticities describe local enzyme behavior, our ultimate goal is to understand how these local responses translate into global control over the entire pathway. Flux control coefficients, $C^J$, measure this system-level influence. This exercise  guides you through the derivation of a flux control coefficient from the underlying elasticities in a simple linear pathway, illustrating the profound connection between local kinetics and global physiological control.",
            "id": "1498150",
            "problem": "Consider a simple unbranched metabolic pathway where a substrate $S_{in}$ is converted to an intermediate metabolite $X$, which is then converted to a final product $S_{out}$. The reactions are catalyzed by enzymes $E_1$ and $E_2$, respectively:\n$$ S_{in} \\xrightarrow{v_1, E_1} X \\xrightarrow{v_2, E_2} S_{out} $$\nThe concentration of the initial substrate $S_{in}$ is held constant, and the product $S_{out}$ is immediately removed from the system. The system is operating at a steady state, where the concentration of the intermediate metabolite $X$, denoted by $x$, is constant, and the pathway flux is $J = v_1 = v_2$.\n\nThe rates of the two reactions, $v_1$ and $v_2$, are functions of metabolite and enzyme concentrations. We assume that the rate of each reaction is directly proportional to the concentration of the enzyme that catalyzes it. We consider $v_1$ to be a function of the concentration of enzyme $E_1$ (denoted $e_1$) and the intermediate concentration $x$. Similarly, $v_2$ is a function of the concentration of enzyme $E_2$ (denoted $e_2$) and the intermediate concentration $x$.\n\nThe flux control coefficient of enzyme $E_1$ with respect to the flux $J$ is defined as $C_{E_1}^J = \\frac{\\partial \\ln J}{\\partial \\ln e_1}$. The elasticity coefficients of the reaction rates $v_1$ and $v_2$ with respect to the intermediate $X$ are defined as $\\epsilon_{x}^{v_1} = \\frac{\\partial \\ln v_1}{\\partial \\ln x}$ and $\\epsilon_{x}^{v_2} = \\frac{\\partial \\ln v_2}{\\partial \\ln x}$.\n\nDerive an expression for the flux control coefficient $C_{E_1}^J$ in terms of the elasticity coefficients $\\epsilon_{x}^{v_1}$ and $\\epsilon_{x}^{v_2}$.",
            "solution": "At steady state, the internal balance imposes $v_{1}(e_{1},x)=v_{2}(e_{2},x)=J$ and the steady-state condition $v_{1}-v_{2}=0$. Consider an infinitesimal perturbation in $e_{1}$ with $e_{2}$ held constant. Differentiating the steady-state condition gives\n$$\n\\mathrm{d}v_{1}-\\mathrm{d}v_{2}=0,\n$$\nthat is,\n$$\n\\frac{\\partial v_{1}}{\\partial e_{1}}\\,\\mathrm{d}e_{1}+\\frac{\\partial v_{1}}{\\partial x}\\,\\mathrm{d}x-\\frac{\\partial v_{2}}{\\partial x}\\,\\mathrm{d}x=0.\n$$\nSolving for $\\mathrm{d}x$ yields\n$$\n\\mathrm{d}x=-\\frac{\\frac{\\partial v_{1}}{\\partial e_{1}}}{\\frac{\\partial v_{1}}{\\partial x}-\\frac{\\partial v_{2}}{\\partial x}}\\,\\mathrm{d}e_{1}.\n$$\nThe flux change at the new steady state can be computed using $J=v_{2}$ (since $e_{2}$ is fixed):\n$$\n\\mathrm{d}J=\\mathrm{d}v_{2}=\\frac{\\partial v_{2}}{\\partial x}\\,\\mathrm{d}x=-\\frac{\\frac{\\partial v_{1}}{\\partial e_{1}}\\,\\frac{\\partial v_{2}}{\\partial x}}{\\frac{\\partial v_{1}}{\\partial x}-\\frac{\\partial v_{2}}{\\partial x}}\\,\\mathrm{d}e_{1}.\n$$\nHence,\n$$\n\\frac{\\partial J}{\\partial e_{1}}=-\\frac{\\frac{\\partial v_{1}}{\\partial e_{1}}\\,\\frac{\\partial v_{2}}{\\partial x}}{\\frac{\\partial v_{1}}{\\partial x}-\\frac{\\partial v_{2}}{\\partial x}}.\n$$\nBy definition, the flux control coefficient is\n$$\nC_{E_{1}}^{J}=\\frac{\\partial \\ln J}{\\partial \\ln e_{1}}=\\frac{e_{1}}{J}\\,\\frac{\\partial J}{\\partial e_{1}}.\n$$\nUse the elasticities with respect to $x$, defined by $\\epsilon_{x}^{v_{i}}=\\left(\\frac{\\partial v_{i}}{\\partial x}\\right)\\frac{x}{v_{i}}$, and the proportionality of rate to enzyme, which implies $\\left(\\frac{\\partial v_{1}}{\\partial e_{1}}\\right)\\frac{e_{1}}{v_{1}}=1$. Then\n$$\nC_{E_{1}}^{J}=\\frac{e_{1}}{J}\\left[-\\frac{\\frac{\\partial v_{1}}{\\partial e_{1}}\\,\\frac{\\partial v_{2}}{\\partial x}}{\\frac{\\partial v_{1}}{\\partial x}-\\frac{\\partial v_{2}}{\\partial x}}\\right]\n=-\\frac{1}{J}\\,\\frac{v_{1}\\,\\left(\\epsilon_{x}^{v_{2}}\\frac{v_{2}}{x}\\right)}{\\left(\\epsilon_{x}^{v_{1}}\\frac{v_{1}}{x}\\right)-\\left(\\epsilon_{x}^{v_{2}}\\frac{v_{2}}{x}\\right)}.\n$$\nAt steady state $v_{1}=v_{2}=J$, so this simplifies to\n$$\nC_{E_{1}}^{J}=-\\frac{1}{J}\\,\\frac{J\\left(\\epsilon_{x}^{v_{2}}\\frac{J}{x}\\right)}{\\left(\\epsilon_{x}^{v_{1}}-\\epsilon_{x}^{v_{2}}\\right)\\frac{J}{x}}\n=\\frac{\\epsilon_{x}^{v_{2}}}{\\epsilon_{x}^{v_{2}}-\\epsilon_{x}^{v_{1}}}.\n$$\nThis is the desired expression in terms of the elasticities with respect to the intermediate $X$.",
            "answer": "$$\\boxed{\\frac{\\epsilon_{x}^{v_{2}}}{\\epsilon_{x}^{v_{2}}-\\epsilon_{x}^{v_{1}}}}$$"
        },
        {
            "introduction": "Analytical derivations are invaluable for building intuition, but real-world biological networks are often too complex for such methods. To analyze these systems, we need a robust computational framework. This advanced practice  challenges you to implement a complete MCA algorithm from first principles, from calculating elasticities with finite differences to solving for control coefficients using numerically stable linear algebra, providing a powerful tool for quantitative systems analysis.",
            "id": "3901070",
            "problem": "You are tasked to design and implement a complete algorithm, grounded in first principles of Metabolic Control Analysis (MCA), that computes local elasticities and global control coefficients for biochemical reaction networks at a steady state. The algorithm must start from the canonical mass-balance description and proceed by a principled linearization around a given steady state. Your program must be numerically robust.\n\nFoundational base for this task:\n- The macroscopic dynamics of metabolite concentrations are described by the ordinary differential equation $d x / d t = S \\, v(x)$, where $S \\in \\mathbb{R}^{m \\times n}$ is the stoichiometric matrix, $x \\in \\mathbb{R}^{m}$ is the concentration vector, and $v(x) \\in \\mathbb{R}^{n}$ is the reaction rate vector as a function of $x$.\n- A steady state $x^\\ast$ satisfies $S \\, v(x^\\ast) = 0$.\n- Metabolic Control Analysis (MCA) quantifies how steady-state fluxes and concentrations respond to small changes in enzyme activities, assuming reactions scale multiplicatively with their respective enzyme activities and linearizing around $x^\\ast$.\n\nYour algorithm must implement the following steps without using any shortcut formulas directly stated in this problem:\n1. Given $S$, the function $v(x)$, and a specified steady state $x^\\ast$, compute the elasticity matrix $\\varepsilon(x^\\ast) \\in \\mathbb{R}^{n \\times m}$, where $\\varepsilon_{i j}(x^\\ast)$ is the partial derivative of the $i$-th reaction rate with respect to the $j$-th metabolite concentration, evaluated at $x^\\ast$. Use a numerically stable finite-difference scheme compatible with nonnegative concentrations.\n2. Construct the linearized system whose solution defines the steady-state response of $x$ and $v$ to infinitesimal multiplicative changes in enzyme activities. Solve for the concentration control coefficients $C^{x} \\in \\mathbb{R}^{m \\times n}$ and the flux control coefficients $C^{J} \\in \\mathbb{R}^{n \\times n}$. Your method must address potentially singular or ill-conditioned Jacobians by employing a robust generalized inverse and appropriate conditioning strategies.\n3. Quantify two diagnostic properties associated with MCA control coefficients and report them for each test case:\n   - The Summation Theorem diagnostic for flux control coefficients: for each flux index $i$, the sum over all enzymes of the corresponding control coefficients should equal the scalar $1$. Report the maximum absolute deviation from $1$ over all flux indices.\n   - The Summation Theorem diagnostic for concentration control coefficients: for each metabolite index $j$, the sum over all enzymes of the corresponding control coefficients should equal the scalar $0$. Report the maximum absolute deviation from $0$ over all metabolite indices.\n\nNumerical stability considerations that your algorithm must explicitly include:\n- Choice of finite-difference step sizes for estimating $\\varepsilon(x^\\ast)$ must be scale-aware and must respect nonnegativity of concentrations when forming $x^\\ast \\pm \\Delta x$.\n- Conditioning of the linear systems must employ a singular value decomposition based generalized inverse or an equivalent numerically stable method, with a principled threshold for small singular values.\n- Guard against division by small steady-state fluxes or concentrations by stating and implementing appropriate checks or regularization.\n\nImplement the algorithm and test it on the following three scientifically plausible networks. In each case, $m$ is the number of metabolites, $n$ is the number of reactions, all concentrations are in arbitrary but consistent units, and all rates are in concentration per time. Control coefficients are dimensionless.\n\nTest Suite:\n- Case 1 (happy path, well-conditioned open system):\n  - $m = 2$, $n = 3$,\n  - $$S = \\begin{bmatrix} 1  -1  0 \\\\ 0  1  -1 \\end{bmatrix}.$$\n  - Rates:\n    - $v_1(x) = 2$ (constant inflow into metabolite $A$),\n    - $v_2(x) = V_{\\max} \\, x_A / (K + x_A)$ with $V_{\\max} = 10$ and $K = 1$,\n    - $v_3(x) = k_3 \\, x_B$ with $k_3 = 0.5$.\n  - Choose $$x^\\ast = \\begin{bmatrix} K \\, v_1 / (V_{\\max} - v_1) \\\\ v_1 / k_3 \\end{bmatrix} = \\begin{bmatrix} 0.25 \\\\ 4 \\end{bmatrix}.$$\n- Case 2 (near saturation in one step, mildly ill-conditioned):\n  - $m = 2$, $n = 3$,\n  - $$S = \\begin{bmatrix} 1  -1  0 \\\\ 0  1  -1 \\end{bmatrix}.$$\n  - Rates:\n    - $v_1(x) = 9.9$ (constant inflow),\n    - $v_2(x) = V_{\\max} \\, x_A / (K + x_A)$ with $V_{\\max} = 10$ and $K = 0.1$,\n    - $v_3(x) = k_3 \\, x_B$ with $k_3 = 1$.\n  - Choose $$x^\\ast = \\begin{bmatrix} K \\, v_1 / (V_{\\max} - v_1) \\\\ v_1 / k_3 \\end{bmatrix} = \\begin{bmatrix} 9.9 \\\\ 9.9 \\end{bmatrix}.$$\n- Case 3 (closed two-metabolite reversible conversion, singular Jacobian with conserved moiety):\n  - $m = 2$, $n = 2$,\n  - $$S = \\begin{bmatrix} -1  1 \\\\ 1  -1 \\end{bmatrix}.$$\n  - Rates:\n    - $v_1(x) = k_f \\, x_A$ with $k_f = 1$,\n    - $v_2(x) = k_b \\, x_B$ with $k_b = 1$.\n  - Choose $$x^\\ast = \\begin{bmatrix} 2 \\\\ 2 \\end{bmatrix}.$$\n\nYour program must:\n- Implement the algorithm described above.\n- For each case, compute the elasticity matrix at $x^\\ast$, then compute $C^{J}$ and $C^{x}$ using a numerically robust approach.\n- For each case, compute and store two floats:\n  - The maximum absolute deviation from $1$ of the row sums of $C^{J}$.\n  - The maximum absolute deviation from $0$ of the row sums of $C^{x}$.\n- Produce a single line of output containing the six results in the order corresponding to Case 1, Case 2, Case 3, as a comma-separated Python list of floats:\n  \"[sJ1,sX1,sJ2,sX2,sJ3,sX3]\".\nNo other text may be printed. All control coefficients are dimensionless, so no physical units are required in the final output. Angles do not appear in this task. Percentages must not be used; report raw decimals.\n\nThe algorithm and solution must be universally applicable in purely mathematical terms and reproducible with any modern programming language. The final answer must be a complete, runnable Python program that implements the algorithm and produces the required output format.",
            "solution": "The problem is valid as it presents a well-defined, scientifically grounded task within the field of Metabolic Control Analysis (MCA) that can be formalized and solved using established mathematical principles. All necessary data and definitions are provided, and the test cases are consistent and representative of common scenarios in systems biology.\n\nThis problem requires the design and implementation of an algorithm to compute the control coefficients of a biochemical network from first principles. The solution proceeds in several steps: derivation of the core MCA equations via linearization, numerical computation of the elasticity matrix, robust solution of the resulting linear system for control coefficients, and verification using the summation theorems.\n\nThe starting point is the mass-balance equation for a network of $m$ metabolites and $n$ reactions:\n$$\n\\frac{d x}{d t} = S \\cdot v(x, p)\n$$\nwhere $x \\in \\mathbb{R}^{m}$ is the vector of metabolite concentrations, $S \\in \\mathbb{R}^{m \\times n}$ is the stoichiometric matrix, and $v(x, p) \\in \\mathbb{R}^{n}$ is the vector of reaction rates, which depend on concentrations $x$ and a set of parameters $p$. In MCA, the parameters $p_k$ typically represent the activity (e.g., concentration) of the enzyme catalyzing reaction $k$. We assume a simple multiplicative relationship, $v_k(x, p_k) \\propto p_k$. A steady state $x^*$ is achieved when the time derivatives are zero, satisfying the condition:\n$$\nS \\cdot v(x^*, p) = 0\n$$\nControl coefficients quantify the systemic response to infinitesimal perturbations in these parameters. The concentration control coefficient $C^x_{jk}$ and flux control coefficient $C^J_{ik}$ are defined as the scaled, fractional changes in steady-state concentration $x_j$ or flux $J_i = v_i$ with respect to a fractional change in parameter $p_k$:\n$$\nC^x_{jk} = \\frac{\\partial \\ln x_j}{\\partial \\ln p_k} = \\frac{p_k}{x_j^*} \\frac{\\partial x_j}{\\partial p_k} \\Big|_{ss} \\quad \\text{and} \\quad C^J_{ik} = \\frac{\\partial \\ln J_i}{\\partial \\ln p_k} = \\frac{p_k}{J_i^*} \\frac{\\partial v_i}{\\partial p_k} \\Big|_{ss}\n$$\nThese coefficients are determined by linearizing the steady-state equation. Consider a small perturbation $dp$ to the parameters, which causes the steady state to shift from $x^*$ to $x^* + dx$. The new steady state must satisfy $S \\cdot v(x^* + dx, p + dp) = 0$. A first-order Taylor expansion yields:\n$$\nS \\left( v(x^*, p) + \\frac{\\partial v}{\\partial x} dx + \\frac{\\partial v}{\\partial p} dp \\right) = 0\n$$\nGiven $S \\cdot v(x^*, p) = 0$, this simplifies to $S \\frac{\\partial v}{\\partial x} dx = -S \\frac{\\partial v}{\\partial p} dp$. The matrix $J_v = \\frac{\\partial v}{\\partial x}$ is the $n \\times m$ Jacobian of reaction rates with respect to metabolite concentrations. Its elements are the unscaled elasticities $\\varepsilon^u_{ij} = \\frac{\\partial v_i}{\\partial x_j}$, which are computed at $x^*$.\n\nFor certain systems, the rows of $S$ may be linearly dependent, implying one or more conservation relationships of the form $L^T x = \\text{constant}$, where the columns of $L$ form a basis for the null space of $S^T$ (the left null space of $S$). Since a parameter perturbation does not alter these conserved totals, any change $dx$ in concentrations must satisfy $L^T dx = 0$.\n\nCombining these, we obtain a system of linear equations for the unscaled concentration responses $\\frac{\\partial x}{\\partial p_k}$ for each parameter perturbation $p_k$. Let $C_u^x = \\frac{\\partial x}{\\partial p}$ be the $m \\times n$ matrix of unscaled concentration control coefficients. The governing system is:\n$$\n\\begin{pmatrix} S J_v \\\\ L^T \\end{pmatrix} C_u^x = \\begin{pmatrix} -S \\frac{\\partial v}{\\partial p} \\\\ 0 \\end{pmatrix}\n$$\nThe term $\\frac{\\partial v}{\\partial p}$ represents the direct effect of parameters on rates. Assuming $v_k \\propto p_k$, we have $\\frac{\\partial v_i}{\\partial p_k} = \\delta_{ik} \\frac{v_i}{p_k}$. For simplicity of scaling, we can set the reference parameter values $p_k=1$, which gives $\\frac{\\partial v}{\\partial p} = \\text{diag}(v_1^*, \\dots, v_n^*) = D_v$. The system becomes:\n$$\n\\begin{pmatrix} S J_v \\\\ L^T \\end{pmatrix} C_u^x = \\begin{pmatrix} -S D_v \\\\ 0 \\end{pmatrix}\n$$\nThis is an overdetermined system if $L^T$ is non-empty, which we solve for $C_u^x$ using a numerically robust method like the Moore-Penrose pseudoinverse, obtained via Singular Value Decomposition (SVD).\n\nThe algorithm proceeds as follows:\n1.  **Compute Unscaled Elasticity Matrix**: Given the rate functions $v(x)$ and steady state $x^*$, compute the matrix $J_v$, where $(J_v)_{ij} = \\frac{\\partial v_i}{\\partial x_j} |_{x^*}$. This is done numerically using a central finite-difference scheme, $\\frac{f(z+h) - f(z-h)}{2h}$, with a relative step size $h$. A forward difference is used as a fallback if the central difference step would result in a negative concentration.\n\n2.  **Construct and Solve the Linear System**:\n    a. Determine the number of conservation laws, $r = m - \\text{rank}(S)$. If $r  0$, compute a basis for the left null space of $S$ to form the matrix $L^T$.\n    b. Construct the system matrix $A = \\begin{pmatrix} S J_v \\\\ L^T \\end{pmatrix}$ and the right-hand side matrix $B = \\begin{pmatrix} -S D_v \\\\ 0 \\end{pmatrix}$. For systems without conservation laws ($r=0$), these simplify to $A = S J_v$ and $B = -S D_v$.\n    c. Solve the system $A C_u^x = B$ for the unscaled concentration control coefficients $C_u^x$ using the pseudoinverse: $C_u^x = \\text{pinv}(A) B$.\n\n3.  **Calculate Scaled Control Coefficients**:\n    a. The scaled concentration control coefficients $C^x$ are obtained by scaling $C_u^x$: $C^x = D_x^{-1} C_u^x$, where $D_x = \\text{diag}(x_1^*, \\dots, x_m^*)$. Care is taken for any near-zero concentrations.\n    b. The unscaled flux control coefficients $C_u^J = \\frac{\\partial v}{\\partial p}$ are found via the chain rule: $C_u^J = J_v C_u^x + D_v$.\n    c. The scaled flux control coefficients $C^J$ are then $C^J = D_v^{-1} C_u^J = D_v^{-1} J_v C_u^x + I$.\n\n4.  **Verify with Summation Theorems**:\n    a. The flux control summation theorem states that for each flux $i$, $\\sum_{k=1}^n C^J_{ik} = 1$.\n    b. The concentration control summation theorem states that for each metabolite $j$, $\\sum_{k=1}^n C^x_{jk} = 0$.\n    We compute the maximum absolute deviation from these theoretical values across all fluxes and metabolites, respectively. These diagnostics serve as a measure of the numerical accuracy and internal consistency of the calculation.",
            "answer": "```python\nimport numpy as np\nfrom scipy import linalg\n\ndef solve():\n    \"\"\"\n    Main function to run Metabolic Control Analysis on the defined test cases.\n    \"\"\"\n\n    def compute_elasticity_matrix(v_func, x_star):\n        \"\"\"\n        Computes the unscaled elasticity matrix (Jacobian of v w.r.t. x)\n        at the steady state x_star using a finite-difference scheme.\n        \"\"\"\n        m = len(x_star)\n        \n        # We need the number of reactions, n. We get this by calling v_func once.\n        v_star_probe = v_func(x_star)\n        n = len(v_star_probe)\n\n        J_v = np.zeros((n, m))\n        h_rel = 1e-7  # Relative step size\n        h_abs = 1e-9  # Absolute step size for zero concentrations\n\n        v_star = v_func(x_star)\n\n        for j in range(m):\n            x_j = x_star[j]\n            h = h_rel * abs(x_j) + h_abs\n\n            x_pert_fwd = x_star.copy()\n            x_pert_fwd[j] += h\n\n            # Use central difference if possible, otherwise forward difference\n            if x_j - h >= 0:\n                x_pert_bwd = x_star.copy()\n                x_pert_bwd[j] -= h\n                v_fwd = v_func(x_pert_fwd)\n                v_bwd = v_func(x_pert_bwd)\n                J_v[:, j] = (v_fwd - v_bwd) / (2 * h)\n            else:\n                v_fwd = v_func(x_pert_fwd)\n                J_v[:, j] = (v_fwd - v_star) / h\n        \n        return J_v\n\n    def compute_mca_coeffs(S, v_func, x_star):\n        \"\"\"\n        Computes control coefficients and summation theorem diagnostics for a given system.\n        \"\"\"\n        m, n = S.shape\n\n        # Step 1: Compute unscaled elasticity matrix (Jacobian)\n        J_v = compute_elasticity_matrix(v_func, x_star)\n        \n        v_star = v_func(x_star)\n\n        # Step 2: Construct and solve the linear system for unscaled coefficients\n        rank_S = np.linalg.matrix_rank(S)\n        num_conservations = m - rank_S\n\n        # System matrix A\n        A_top = S @ J_v\n        if num_conservations > 0:\n            # L.T is basis for left null space of S\n            L_T = linalg.null_space(S.T).T\n            if L_T.ndim == 1: L_T = L_T.reshape(1, -1)\n            A = np.vstack([A_top, L_T])\n        else:\n            A = A_top\n\n        # RHS matrix B\n        D_v = np.diag(v_star)\n        B_top = -S @ D_v\n        if num_conservations > 0:\n            B_bottom = np.zeros((num_conservations, n))\n            B = np.vstack([B_top, B_bottom])\n        else:\n            B = B_top\n        \n        # Solve using pseudoinverse for robustness\n        C_u_x = np.linalg.pinv(A) @ B\n\n        # Step 3: Calculate scaled control coefficients\n        # Guard against division by zero for concentrations\n        x_inv = np.array([1.0/val if abs(val) > 1e-12 else 0.0 for val in x_star])\n        D_x_inv = np.diag(x_inv)\n        C_x = D_x_inv @ C_u_x\n\n        # Calculate C_j = D_v_inv @ (J_v @ C_u_x + D_v) = (D_v_inv @ J_v @ D_x @ C_x) + I\n        # It's more direct to use C_u_x to avoid re-scaling J_v\n        C_u_j = J_v @ C_u_x + D_v\n        \n        # Guard against division by zero for fluxes\n        v_inv = np.array([1.0/val if abs(val) > 1e-12 else 0.0 for val in v_star])\n        D_v_inv = np.diag(v_inv)\n        C_j = D_v_inv @ C_u_j\n\n        # Step 4: Calculate Summation Theorem diagnostics\n        sum_j = np.sum(C_j, axis=1)\n        dev_j = np.max(np.abs(sum_j - 1.0))\n\n        sum_x = np.sum(C_x, axis=1)\n        dev_x = np.max(np.abs(sum_x - 0.0))\n\n        return dev_j, dev_x\n\n    # Test Suite Definition\n    test_cases = [\n        {\n            \"name\": \"Case 1\",\n            \"S\": np.array([[1, -1, 0], [0, 1, -1]]),\n            \"v_func\": lambda x: np.array([\n                2.0,                            # v1\n                10.0 * x[0] / (1.0 + x[0]),     # v2\n                0.5 * x[1]                      # v3\n            ]),\n            \"x_star\": np.array([0.25, 4.0])\n        },\n        {\n            \"name\": \"Case 2\",\n            \"S\": np.array([[1, -1, 0], [0, 1, -1]]),\n            \"v_func\": lambda x: np.array([\n                9.9,                            # v1\n                10.0 * x[0] / (0.1 + x[0]),     # v2\n                1.0 * x[1]                      # v3\n            ]),\n            \"x_star\": np.array([9.9, 9.9])\n        },\n        {\n            \"name\": \"Case 3\",\n            \"S\": np.array([[-1, 1], [1, -1]]),\n            \"v_func\": lambda x: np.array([\n                1.0 * x[0],                     # v1\n                1.0 * x[1]                      # v2\n            ]),\n            \"x_star\": np.array([2.0, 2.0])\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        dev_j, dev_x = compute_mca_coeffs(case[\"S\"], case[\"v_func\"], case[\"x_star\"])\n        results.extend([dev_j, dev_x])\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}