{
    "hands_on_practices": [
        {
            "introduction": "任何随机模拟的第一步都是为每个化学反应建立正确的数学表示。这个练习将指导你从基本原理出发，推导一个基础双分子反应的倾向性函数和化学计量向量。这两个要素是随机模拟算法（SSA）的核心组成部分，掌握它们对于构建任何化学反应网络的精确随机模型至关重要。",
            "id": "5278829",
            "problem": "在T细胞和抗原呈递细胞之间的免疫突触中，考虑一个均匀混合微域内的单一反应通道：一个T细胞受体与一个肽-主要组织相容性复合体配体结合，该过程被建模为受体-配体复合物的可逆形成。我们关注正向结合反应 $R + L \\to RL$。设时间 $t$ 时的离散分子数为：未结合受体 $R$ 的数量为 $x_R(t)$，游离配体 $L$ 的数量为 $x_L(t)$，以及结合复合物 $RL$ 的数量为 $x_{RL}(t)$。假设微域体积恒定，并且结合事件是无记忆的，这与化学主方程（CME）框架一致（首次使用时定义CME：化学主方程（CME）描述了在一个均匀混合的反应系统中，离散分子数量的概率分布随时间的演化）。在Gillespie的随机模拟背景下，每个反应通道都是一个无记忆的跳跃，其在无穷小时间间隔内的发生由其倾向函数决定。\n\n从CME中的定义出发，即当系统处于状态 $x = (x_R, x_L, x_{RL})$ 时，一个给定的反应通道在无穷小时间间隔 $\\mathrm{d}t$ 内发生的概率为 $a(x)\\,\\mathrm{d}t + o(\\mathrm{d}t)$，并仅使用离散状态、均匀混合反应动力学的第一性原理以及分子尺度上质量作用下的反应对计数方法，推导：\n\n1. 正向结合反应 $R + L \\to RL$ 的倾向函数 $a(x)$，用有效随机速率常数 $c$ 和分子数 $x_R$、$x_L$ 表示。\n2. 此反应的化学计量更新向量 $\\nu$，基于有序物种基 $(R, L, RL)$。\n\n将您的最终答案表示为一个无单位的单行矩阵 $\\left(a(x), \\nu_R, \\nu_L, \\nu_{RL}\\right)$。无需进行数值舍入。",
            "solution": "该问题要求为正向结合反应 $R + L \\to RL$ 推导两个量：倾向函数 $a(x)$ 和化学计量更新向量 $\\nu$。推导必须基于随机反应动力学的第一性原理。\n\n系统在任意时刻 $t$ 的状态由离散分子数的向量 $x(t) = (x_R(t), x_L(t), x_{RL}(t))$ 给出，其中 $x_R$、$x_L$ 和 $x_{RL}$ 分别是物种 $R$、$L$ 和 $RL$ 的分子数量。为简单起见，我们将状态表示为 $x$。物种按 $(R, L, RL)$ 的顺序排列。\n\n首先，我们推导倾向函数 $a(x)$。问题将化学主方程（CME）定义为描述均匀混合反应系统中离散分子数量概率分布随时间演化的控制方程。它进一步提供了基本定义，即在无穷小时间间隔 $[t, t+dt)$ 内，一个特定的反应通道发生的概率为 $a(x)\\,dt + o(dt)$，其中 $a(x)$ 是倾向函数。\n\n该反应是双分子结合反应：$R + L \\to RL$。推导过程源于在均匀混合系统中，从分子层面对该反应的物理和概率解释。“均匀混合”假设意味着分子在整个体积内均匀分布，每个分子与任何其他分子反应的可能性均等。“无记忆”假设意味着在下一个无穷小时间间隔内发生反应的概率仅取决于系统的当前状态，而与其历史无关。\n\n设 $c$ 为有效随机速率常数。该常数包含了单个特定的 $R$ 和 $L$ 分子对在单位时间间隔内发生反应的概率。因此，一个特定的反应物对，例如第 $i$ 个 $R$ 分子和第 $j$ 个 $L$ 分子，在无穷小时间间隔 $dt$ 内发生反应的概率是 $c \\, dt$。\n\n任务是找出在 $dt$ 时间内*任意*一对 $R$ 和 $L$ 分子发生反应的总概率。由于系统处于状态 $x$，存在 $x_R$ 个 $R$ 物种分子和 $x_L$ 个 $L$ 物种分子。该反应涉及两个不同的物种。可以形成的不同 $(R, L)$ 对的数量是每种物种分子数量的乘积。\n不同反应对的数量 = $x_R \\times x_L$。\n\n由于这些对中的每一对在时间间隔 $dt$ 内发生反应的独立概率均为 $c \\, dt$，并且这些事件是互斥的（如果一对发生反应，系统状态会改变，从而改变了另一对在同一无穷小瞬间发生反应的条件），因此发生一次反应事件的总概率是每个不同反应对概率的总和。\n在 $dt$ 内发生一次反应的概率 = $\\sum_{i=1}^{x_R} \\sum_{j=1}^{x_L} (\\text{反应对 } (R_i, L_j) \\text{ 发生反应的概率})$\n在 $dt$ 内发生一次反应的概率 = $(x_R x_L) \\times (c \\, dt)$\n\n将此表达式与问题中提供的定义 $a(x)\\,dt$ 进行比较，我们可以确定倾向函数 $a(x)$：\n$a(x) \\, dt = c \\, x_R \\, x_L \\, dt$\n因此，正向结合反应的倾向函数为：\n$a(x) = c \\, x_R \\, x_L$\n\n接下来，我们推导化学计量更新向量 $\\nu$。向量 $\\nu$ 描述了单次反应事件后所有物种分子数量的变化。状态向量的顺序为 $x = (x_R, x_L, x_{RL})$。\n反应为 $R + L \\to RL$。\n每次该反应发生时：\n- 一个 $R$ 分子被消耗。$x_R$ 的变化为 $\\Delta x_R = -1$。\n- 一个 $L$ 分子被消耗。$x_L$ 的变化为 $\\Delta x_L = -1$。\n- 一个 $RL$ 分子被生成。$x_{RL}$ 的变化为 $\\Delta x_{RL} = +1$。\n\n化学计量更新向量 $\\nu$ 是这些变化的向量，对应于有序物种基 $(R, L, RL)$。\n$\\nu = (\\Delta x_R, \\Delta x_L, \\Delta x_{RL})$\n代入数值，我们得到：\n$\\nu = (-1, -1, 1)$\n\n该向量的分量为 $\\nu_R = -1$, $\\nu_L = -1$ 和 $\\nu_{RL} = 1$。\n\n问题要求以单行矩阵 $(a(x), \\nu_R, \\nu_L, \\nu_{RL})$ 的形式给出最终答案。综合我们推导出的结果：\n$a(x) = c \\, x_R \\, x_L$\n$\\nu_R = -1$\n$\\nu_L = -1$\n$\\nu_{RL} = 1$\n\n最终的组合结果是 $(c \\, x_R \\, x_L, -1, -1, 1)$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nc x_R x_L & -1 & -1 & 1\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "虽然随机模拟算法（SSA）能够提供精确的模拟路径，但对于复杂的生物系统，其计算成本可能成为一个瓶颈。本练习旨在比较两种主流SSA变体——直接法（Direct Method）和下一反应法（Next-Reaction Method）——的计算效率。通过分析它们的计算复杂度，你将获得在实际应用中选择合适算法的关键洞见，这对于处理大规模生化网络至关重要。",
            "id": "3935994",
            "problem": "考虑一个具有 $M$ 个反应通道的充分混合的生化反应网络，其离散状态向量 $X(t)$ 根据化学主方程（CME）演化。设倾向函数为 $a_{j}(X(t))$，其中 $j \\in \\{1,2,\\dots,M\\}$，并令 $a_{0}(X(t)) = \\sum_{j=1}^{M} a_{j}(X(t))$。随机模拟算法（SSA）通过从当前状态抽样下一个反应事件及其发生时间来推进系统演化。\n\n你需要从 CME 和 SSA 所蕴含的事件选择的第一性原理出发，分析两种 SSA 变体的每个模拟步骤（即每个反应事件）的计算复杂度：\n\n- 直接法（Gillespie 的原始算法），以及\n- Gibson–Bruck 的下一反应法。\n\n对基本操作的成本模型使用以下建模假设：\n- 每次浮点加法、乘法、除法、比较、在 $(0,1)$ 上生成一个均匀随机变量以及计算自然对数，都贡献一个单位成本 $1$。\n- 一个以假定触发时间为键的二叉最小堆（优先队列）支持 `extract-min` 和 `key-decrease`（或 `update`）操作，每层堆的单位成本为1，因此每次此类操作的成本按 $\\log_{2}(M)$ 比例缩放。\n- 网络的依赖关系图具有有界出度：任何单个反应的触发所影响的倾向函数的数量，其上限为一个不随 $M$ 增长的常数 $d$。\n- 在直接法中，反应索引是通过扫描倾向的累加和直到超过阈值为止来确定的；不要假设任何预计算的树或别名方法。\n- 在下一反应法中，当倾向发生变化时，使用标准的风险率重标定来维护和更新假定触发时间；对受影响反应的更新是通过堆的键值更新来完成的。\n\n从将倾向解释为风险率的 CME 解释以及 SSA 的步骤结构出发，根据所述假设，推导出两种方法每一步的主导阶成本，并仅表示为 $M$ 的函数。忽略不随 $M$ 变化的加法常数和项，并且只报告 $M$ 的首项增长阶。以行矩阵的形式提供你的最终答案，第一个条目对应直接法，第二个条目对应 Gibson–Bruck 的下一反应法。无需四舍五入，也无物理单位适用。",
            "solution": "该问题要求从第一性原理出发，推导随机模拟算法（SSA）的两种变体——直接法和下一反应法——每个模拟步骤的计算复杂度。该复杂度需要表示为反应通道数 $M$ 的函数的首项增长项。\n\nSSA 的基础在于这样一个事实：对于处于状态 $X(t)$ 的系统，量 $a_j(X(t)) dt$ 表示反应通道 $j$ 在无穷小时间间隔 $[t, t+dt)$ 内触发的概率。这种将倾向解释为泊松过程的风险率的观点，意味着等待任意类型*下一个*反应的时间 $\\tau$ 是一个指数随机变量，其速率参数为 $a_0(X(t)) = \\sum_{j=1}^{M} a_j(X(t))$。$\\tau$ 的概率密度函数是 $P(\\tau) = a_0 \\exp(-a_0 \\tau)$。假定一个反应在时间 $t+\\tau$ 发生，那么该反应是反应 $\\mu$ 的概率为 $P(\\mu) = a_\\mu(X(t))/a_0(X(t))$。两种 SSA 变体是在数学上等价的方法，用于从它们的联合分布中抽样对 $(\\tau, \\mu)$。\n\n我们基于给定的成本模型，分析一个完整步骤的计算成本，该步骤将系统从一个反应事件推进到下一个反应事件。\n\n**直接法分析**\n\n直接法顺序地抽样 $(\\tau, \\mu)$。首先，它抽样到下一个事件发生的时间 $\\tau$，然后抽样该事件的索引 $\\mu$。单个步骤流程如下：\n\n1.  **准备**：在一个步骤的开始，系统处于特定状态 $X$。为了确定下一个事件，所有 $M$ 个倾向函数 $a_j(X)$（其中 $j \\in \\{1, 2, \\dots, M\\}$）都必须是已知的。在一个朴素的实现中，每一步都会重新评估所有 $M$ 个倾向。一个更优化的方法是利用依赖关系图，只更新受前一个反应影响的倾向。然而，决定直接法复杂度的步骤是选择反应索引，无论如何都需要访问所有的 $a_j$ 值。\n    *   必须计算总倾向 $a_0$：$a_0 = \\sum_{j=1}^{M} a_j(X)$。这需要 $M-1$ 次浮点加法。因此成本与 $M$ 成正比。\n\n2.  **抽样到下一个事件的时间 $\\tau$**：$\\tau$ 的值从速率为 $a_0$ 的指数分布中抽取。使用反演法，计算公式为 $\\tau = \\frac{1}{a_0} \\ln(\\frac{1}{r_1})$，其中 $r_1$ 是来自均匀分布 $U(0,1)$ 的一个随机变量。根据成本模型，此步骤涉及一次随机数生成、一次对数运算和一次除法。这是一个与 $M$ 无关的常数成本，$O(1)$。\n\n3.  **抽样下一个反应的索引 $\\mu$**：索引 $\\mu$ 从离散概率分布 $P(\\mu) = a_\\mu/a_0$ 中抽取。问题指定这是通过生成第二个均匀随机变量 $r_2 \\in U(0,1)$ 并找到满足不等式 $\\sum_{k=1}^{\\mu} a_k(X) > r_2 a_0(X)$ 的最小整数 $\\mu$ 来完成的。这通过线性搜索实现：\n    *   计算阈值 $T = r_2 \\times a_0$。这需要一次随机数生成和一次乘法，成本为 $O(1)$。\n    *   对 $j=1, 2, \\dots$ 迭代计算累加和 $S_j = \\sum_{k=1}^{j} a_k(X)$，并将其与 $T$ 进行比较。第一个满足 $S_j > T$ 的 $j$ 就给出 $\\mu=j$。这个过程每次迭代涉及一次加法和一次比较。在最坏情况下，此搜索需要 $M$ 次迭代。平均而言，搜索将需要 $M/2$ 次迭代。\n\n4.  **成本聚合**：每一步的总成本是这些操作成本的总和。\n    *   计算 $a_0$ 的成本：$O(M)$。\n    *   计算 $\\tau$ 的成本：$O(1)$。\n    *   线性搜索 $\\mu$ 的成本：$O(M)$。\n\n总成本由线性操作主导。因此，直接法每一步计算成本的首项增长是 $M$ 的线性函数。\n\n主导阶成本 $\\propto M$。\n\n**下一反应法（Gibson–Bruck）分析**\n\n该方法重新阐述了抽样问题。它将 $M$ 个反应视为相互竞争的泊松过程。它为每个反应通道 $j$ 生成一个假定触发时间 $\\tau_j$，并将具有最小假定时间的事件确定为下一个事件，即 $(\\tau, \\mu) = (\\min_j\\{\\tau_j\\}, \\arg\\min_j\\{\\tau_j\\})$。为避免在每一步都重新生成所有 $M$ 个假定时间，使用一个索引优先队列（最小堆）来存储对 $(j, \\tau_j)$。当一个反应触发时，只需更新少数受影响反应的假定时间。\n\n单个步骤流程如下：\n\n1.  **确定下一个事件 $(\\mu, \\tau)$**：下一个反应索引 $\\mu$ 及其绝对触发时间 $\\tau$ 对应于优先队列中具有最小键的元素。这需要一次 `extract-min` 操作。根据大小为 $M$ 的二叉最小堆的成本模型，此操作的成本与 $\\log_2(M)$ 成正比。\n\n2.  **更新系统状态和时间**：系统时间推进到 $\\tau$，状态向量 $X$ 根据反应 $\\mu$ 的化学计量关系进行更新。此成本相对于 $M$ 是常数，即 $O(1)$。\n\n3.  **更新假定触发时间**：在反应 $\\mu$ 触发后，状态从 $X$ 变为 $X'$ 会改变一组反应的倾向。问题指出，这个集合的大小受一个常数 $d$（依赖关系图的出度）的限制。对于每个受影响的反应 $k$，其假定时间 $\\tau_k$ 必须被更新。\n    *   **对于刚刚触发的反应 $\\mu$**：必须生成一个新的假定时间。这包括生成一个新的随机变量 $r_\\mu \\sim U(0,1)$，重新计算倾向 $a_\\mu(X')$，并计算新的时间增量 $\\Delta \\tau_\\mu = \\frac{1}{a_\\mu(X')} \\ln(\\frac{1}{r_\\mu})$。新的绝对时间是 $\\tau_\\mu' = \\tau + \\Delta \\tau_\\mu$。这些计算的成本是常数，$O(1)$。然后将这个新时间 $\\tau_\\mu'$ 插回优先队列，其成本与 $\\log_2(M)$ 成正比。\n    *   **对于其他受影响的反应 $k \\neq \\mu$**：Gibson-Bruck 算法使用一个重标定规则来更新假定时间，而无需生成新的随机数：$\\tau_k' = \\tau + \\frac{a_k(X)}{a_k(X')} (\\tau_k - \\tau)$。在计算出新的倾向 $a_k(X')$（成本也为 $O(1)$）之后，此计算涉及几次浮点运算，成本为 $O(1)$。然后，优先队列中反应 $k$ 的键必须更新为 $\\tau_k'$。这个 `key-update` 操作的成本与 $\\log_2(M)$ 成正比。\n\n4.  **成本聚合**：总成本是这些操作的成本之和。有一次 `extract-min` 操作，一次 `insert` 操作（对于反应 $\\mu$），以及最多 $d-1$ 次 `key-update` 操作。\n    *   找到下一个事件的成本 (`extract-min`)：$O(\\log_2 M)$。\n    *   更新反应 $\\mu$ 的成本（计算 + `insert`）：$O(1) + O(\\log_2 M)$。\n    *   更新其他（最多）$d-1$ 个受影响反应的成本：对于每一个反应，计算成本为 $O(1)$，堆更新成本为 $O(\\log_2 M)$。这部分的总成本是 $(d-1) \\times O(\\log_2 M) = O(d \\log_2 M)$。\n\n总成本是这些成本的总和：$O(\\log_2 M) + O(\\log_2 M) + O(d \\log_2 M)$。由于 $d$ 是一个与 $M$ 无关的常数，总和由与 $\\log_2(M)$ 成正比的项主导。因此，下一反应法每一步计算成本的首项增长是 $M$ 的对数函数。\n\n主导阶成本 $\\propto \\log_2(M)$。\n\n**结论**\n\n每一步的主导阶成本，表示为反应通道数 $M$ 的函数，对于直接法是 $M$，对于下一反应法是 $\\log_2(M)$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\nM & \\log_{2}(M)\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "对于分子数量庞大且反应频繁的系统，精确的SSA方法可能过于缓慢，因此需要采用如tau-leaping这样的近似方法。这个高级练习不仅要求你推导这种近似所引入误差的解析表达式，还需要你编写程序来量化它。通过这个实践，你将把理论分析与计算实践联系起来，深入理解近似方法在随机模拟中的权衡与应用。",
            "id": "3936055",
            "problem": "考虑一个模拟均匀混合体积中移入-死亡过程的单物种线性反应网络，该网络由两个反应定义：$R_1: \\varnothing \\to X$，速率恒为 $k_0$，化学计量变化为 $+1$；以及 $R_2: X \\to \\varnothing$，一级速率为 $k_1 X$，化学计量变化为 $-1$。分子数概率分布的时间演化由化学主方程 (CME) 控制。随机模拟算法 (SSA) 能产生 CME 的精确样本路径。tau-跳跃方法通过以固定步长 $ \\tau $ 向前跳跃来近似该过程，并假设在每次跳跃期间反应倾向保持不变，其中反应发生次数被建模为独立的泊松随机变量。\n\n您的任务是，从第一性原理出发，并且不调用预先组合的 tau-跳跃误差公式，为使用固定步长 $\\tau$ 的 tau-跳跃方法在时间 $T$ 的方差推导出一个闭式表达式，并量化其相对于 CME 下（即 SSA 下）精确方差的误差。仅使用核心定义和定律，即：\n- 线性反应网络的 CME 矩动力学。\n- 全期望定律和全方差定律。\n- tau-跳跃方法的定义步骤，该步骤将大小为 $\\tau$ 的步长内的反应发生次数替换为独立的泊松随机变量，其均值等于在该步长开始时评估的倾向函数值乘以 $\\tau$。\n\n请按以下步骤进行：\n- 从该网络的 CME 出发，对于一般的初始均值 $m(0) = m_0$ 和初始方差 $V(0) = V_0$，推导在 SSA 下于时间 $t$ 的均值 $m(t)$ 和方差 $V(t)$ 的闭式解。\n- 对于具有固定步长 $\\tau$ 的 tau-跳跃方法，写出状态 $X_{n+1}$ 在从 $t_n$ 到 $t_{n+1} = t_n + \\tau$ 的一个步长内的单步条件更新，然后使用全期望定律和全方差定律推导均值 $m_{n+1}$ 和方差 $V_{n+1}$ 关于 $m_n$ 和 $V_n$ 的递推关系。\n- 以闭式形式求解这些递推关系，以获得在 $T = N \\tau$ 时的 tau-跳跃方差。\n\n然后，您必须实现一个程序，对于给定的参数集 $(k_0, k_1, m_0, V_0, T, \\tau)$（其中 $T$ 是 $\\tau$ 的整数倍），计算绝对误差\n$$\nE(\\tau) = \\left|V_{\\text{tau}}(T,\\tau) - V_{\\text{exact}}(T)\\right|.\n$$\n本问题中的所有量都是无量纲的，不需要物理单位。所有计算都必须以实数运算进行。\n\n测试套件：\n您的程序必须为以下每个参数集计算 $E(\\tau)$。在每种情况下，$T$ 都是 $\\tau$ 的精确整数倍；如果 $N = T/\\tau$，则 $N$ 是一个整数。\n\n- 情况 1：$k_0 = 40$, $k_1 = 2$, $m_0 = 0$, $V_0 = 0$, $T = 1.0$, $\\tau = 0.05$。\n- 情况 2：$k_0 = 40$, $k_1 = 2$, $m_0 = 0$, $V_0 = 0$, $T = 0.8$, $\\tau = 0.4$。\n- 情况 3：$k_0 = 20$, $k_1 = 1.0$, $m_0 = 50$, $V_0 = 0$, $T = 2.0$, $\\tau = 0.2$。\n- 情况 4：$k_0 = 50$, $k_1 = 1.0$, $m_0 = 50$, $V_0 = 0$, $T = 2.0$, $\\tau = 0.25$。\n- 情况 5：$k_0 = 5.0$, $k_1 = 0.2$, $m_0 = 10$, $V_0 = 0$, $T = 5.0$, $\\tau = 0.5$。\n\n您的程序应生成单行输出，其中包含一个由方括号括起来的逗号分隔的浮点数列表。第 $i$ 个数字必须是情况 $i$ 的 $E(\\tau)$ 值，顺序与上文相同，浮点数采用默认字符串格式。例如，一个有效的输出格式如 $[a_1,a_2,a_3,a_4,a_5]$，其中每个 $a_i$ 都是一个浮点数。",
            "solution": "该问题在科学和数学上是合理的、适定的，并包含唯一解所需的所有信息。推导过程按要求从第一性原理出发。\n\n该反应网络是一个移入-死亡过程，定义如下：\n$R_1: \\varnothing \\xrightarrow{k_0} X$，倾向函数为 $a_1(x) = k_0$，化学计量变化为 $\\nu_1 = +1$。\n$R_2: X \\xrightarrow{k_1} \\varnothing$，倾向函数为 $a_2(x) = k_1 x$，化学计量变化为 $\\nu_2 = -1$。\n这里，$x$ 是物种 $X$ 的分子数。\n\n**第一部分：从化学主方程 (CME) 推导精确方差**\n\n分子数 $X(t)$ 的矩的时间演化可以从 CME 推导出来。\n设 $m(t) = \\mathbb{E}[X(t)]$ 为均值，$V(t) = \\text{Var}(X(t))$ 为方差。\n函数 $f(X(t))$ 的期望值时间演化的一般主方程为\n$$ \\frac{d\\mathbb{E}[f(X(t))]}{dt} = \\sum_{j=1}^{2} \\mathbb{E}[(f(X(t) + \\nu_j) - f(X(t))) a_j(X(t))] $$\n\n对于均值，我们设 $f(x) = x$。\n$$ \\frac{dm(t)}{dt} = \\mathbb{E}[(X+1-X)a_1(X)] + \\mathbb{E}[(X-1-X)a_2(X)] = \\mathbb{E}[\\nu_1 a_1(X)] + \\mathbb{E}[\\nu_2 a_2(X)] $$\n$$ \\frac{dm(t)}{dt} = (+1)\\mathbb{E}[k_0] + (-1)\\mathbb{E}[k_1 X(t)] = k_0 - k_1 m(t) $$\n这是一个一阶线性常微分方程 (ODE)。在初始条件 $m(0) = m_0$ 下，其解为：\n$$ m(t) = \\frac{k_0}{k_1} + \\left(m_0 - \\frac{k_0}{k_1}\\right)e^{-k_1 t} $$\n\n对于方差 $V(t) = \\mathbb{E}[X(t)^2] - m(t)^2$，我们推导其 ODE。对于线性反应网络，方差动力学由以下公式给出：\n$$ \\frac{dV(t)}{dt} = \\sum_{j=1}^{2} \\nu_j^2 \\mathbb{E}[a_j(X(t))] + 2 \\cdot \\text{Cov}\\left(X(t), \\sum_{j=1}^{2} \\nu_j a_j(X(t))\\right) $$\n第一项是噪声贡献之和：\n$$ \\sum_{j=1}^{2} \\nu_j^2 \\mathbb{E}[a_j(X(t))] = (+1)^2 \\mathbb{E}[k_0] + (-1)^2 \\mathbb{E}[k_1 X(t)] = k_0 + k_1 m(t) $$\n第二项包含协方差。随机速率之和为 $\\sum_j \\nu_j a_j(X) = k_0 - k_1 X$。\n$$ 2 \\cdot \\text{Cov}(X, k_0 - k_1 X) = 2 \\cdot \\text{Cov}(X, -k_1 X) = -2k_1 \\cdot \\text{Cov}(X, X) = -2k_1 \\text{Var}(X) = -2k_1 V(t) $$\n结合这些项，得到方差的 ODE：\n$$ \\frac{dV(t)}{dt} = k_0 + k_1 m(t) - 2k_1 V(t) $$\n代入 $m(t)$ 的解：\n$$ \\frac{dV(t)}{dt} + 2k_1 V(t) = k_0 + k_1 \\left[ \\frac{k_0}{k_1} + \\left(m_0 - \\frac{k_0}{k_1}\\right)e^{-k_1 t} \\right] = 2k_0 + (k_1 m_0 - k_0)e^{-k_1 t} $$\n这是关于 $V(t)$ 的一阶线性 ODE。使用积分因子 $e^{2k_1 t}$，在初始条件 $V(0)=V_0$ 下求解：\n$$ \\frac{d}{dt}(V(t)e^{2k_1 t}) = 2k_0 e^{2k_1 t} + (k_1 m_0 - k_0)e^{k_1 t} $$\n从 $0$ 积分到 $t$：\n$$ V(t)e^{2k_1 t} - V_0 = \\frac{k_0}{k_1}(e^{2k_1 t}-1) + (m_0 - \\frac{k_0}{k_1})(e^{k_1 t}-1) $$\n求解 $V(t)$：\n$$ V(t) = V_0 e^{-2k_1 t} + \\frac{k_0}{k_1}(1-e^{-2k_1 t}) + (m_0 - \\frac{k_0}{k_1})(e^{-k_1 t}-e^{-2k_1 t}) $$\n整理各项：\n$$ V(t) = \\frac{k_0}{k_1} + \\left(m_0 - \\frac{k_0}{k_1}\\right)e^{-k_1 t} + (V_0 - m_0)e^{-2k_1 t} $$\n前两项与 $m(t)$ 相同。因此，在时间 $t$ 的精确方差，记为 $V_{\\text{exact}}(t)$，是：\n$$ V_{\\text{exact}}(t) = m(t) + (V_0 - m_0)e^{-2k_1 t} $$\n在时间 $T$，我们有：\n$$ V_{\\text{exact}}(T) = \\left(\\frac{k_0}{k_1} + \\left(m_0 - \\frac{k_0}{k_1}\\right)e^{-k_1 T}\\right) + (V_0 - m_0)e^{-2k_1 T} $$\n\n**第二部分：Tau-跳跃方差**\n\ntau-跳跃方法通过以下方式将时间 $t_n = n\\tau$ 的状态 $X_n$ 更新到时间 $t_{n+1} = t_n + \\tau$ 的状态 $X_{n+1}$：\n$$ X_{n+1} = X_n + K_1 - K_2 $$\n其中 $K_1$ 和 $K_2$ 是在 $[t_n, t_{n+1})$ 内的反应发生次数。以 $X_n$ 为条件，它们是独立的泊松随机变量：\n$$ K_1 | X_n \\sim \\text{Pois}(a_1(X_n)\\tau) = \\text{Pois}(k_0\\tau) $$\n$$ K_2 | X_n \\sim \\text{Pois}(a_2(X_n)\\tau) = \\text{Pois}(k_1 X_n \\tau) $$\n设 $m_n = \\mathbb{E}[X_n]$ 和 $V_n = \\text{Var}(X_n)$。我们使用全期望定律和全方差定律。\n\n更新的条件均值为：\n$$ \\mathbb{E}[X_{n+1} | X_n] = X_n + \\mathbb{E}[K_1|X_n] - \\mathbb{E}[K_2|X_n] = X_n + k_0\\tau - k_1 X_n \\tau = (1-k_1\\tau)X_n + k_0\\tau $$\n根据全期望定律，$\\mathbb{E}[X_{n+1}] = \\mathbb{E}[\\mathbb{E}[X_{n+1}|X_n]]$：\n$$ m_{n+1} = \\mathbb{E}[(1-k_1\\tau)X_n + k_0\\tau] = (1-k_1\\tau)m_n + k_0\\tau $$\n这是均值的线性递推关系。\n\n更新的条件方差为（使用 $K_1, K_2$ 的条件独立性）：\n$$ \\text{Var}(X_{n+1} | X_n) = \\text{Var}(K_1|X_n) + \\text{Var}(K_2|X_n) = k_0\\tau + k_1 X_n \\tau = (k_0 + k_1 X_n)\\tau $$\n根据全方差定律，$\\text{Var}(X_{n+1}) = \\mathbb{E}[\\text{Var}(X_{n+1}|X_n)] + \\text{Var}(\\mathbb{E}[X_{n+1}|X_n])$：\n$$ V_{n+1} = \\mathbb{E}[(k_0 + k_1 X_n)\\tau] + \\text{Var}((1-k_1\\tau)X_n + k_0\\tau) $$\n$$ V_{n+1} = (k_0 + k_1 m_n)\\tau + (1-k_1\\tau)^2 V_n $$\n这是方差的线性递推关系。\n\n为了求出 $V_n$ 的闭式解，我们首先求解 $m_n$。对于 $m_{n+1} = (1-k_1\\tau)m_n + k_0\\tau$ 及初始值 $m_0$，其解为：\n$$ m_n = \\frac{k_0}{k_1} + \\left(m_0 - \\frac{k_0}{k_1}\\right)(1-k_1\\tau)^n $$\n现在我们求解 $V_n$。设 $A = (1-k_1\\tau)^2$ 和 $B_n = (k_0 + k_1 m_n)\\tau$。递推关系为 $V_{n+1} = A V_n + B_n$。\n将 $m_n$ 代入 $B_n$：\n$$ B_n = \\left( k_0 + k_1\\left( \\frac{k_0}{k_1} + \\left(m_0-\\frac{k_0}{k_1}\\right)(1-k_1\\tau)^n \\right) \\right)\\tau $$\n$$ B_n = 2k_0\\tau + k_1\\tau\\left(m_0-\\frac{k_0}{k_1}\\right)(1-k_1\\tau)^n $$\n设 $r_m = 1-k_1\\tau$。递推关系为 $V_{n+1} = A V_n + 2k_0\\tau + k_1\\tau(m_0-k_0/k_1)r_m^n$。\n这是一个标准的线性非齐次递推关系。假设 $k_1\\tau \\notin \\{0, 1, 2\\}$，一个特解具有形式 $V_n^{(p)} = P + Q r_m^n$。将其代入方程并匹配系数可得：\n$$ P = \\frac{2k_0\\tau}{1-A} = \\frac{2k_0\\tau}{1-(1-k_1\\tau)^2} = \\frac{2k_0\\tau}{k_1\\tau(2-k_1\\tau)} = \\frac{2k_0}{k_1(2-k_1\\tau)} $$\n$$ Q = \\frac{k_1\\tau(m_0-k_0/k_1)}{r_m-A} = \\frac{k_1\\tau(m_0-k_0/k_1)}{(1-k_1\\tau)-(1-k_1\\tau)^2} = \\frac{k_1\\tau(m_0-k_0/k_1)}{k_1\\tau(1-k_1\\tau)} = \\frac{m_0-k_0/k_1}{1-k_1\\tau} $$\n通解为 $V_n = C A^n + V_n^{(p)} = C A^n + P + Q r_m^n$。\n常数 $C$ 可由初始条件 $V_0$ 求得：\n$$ V_0 = C + P + Q \\implies C = V_0 - P - Q $$\n$V_n$ 的闭式解为：\n$$ V_n = P + Q r_m^n + (V_0 - P - Q) A^n $$\n代入 $A=r_m^2 = (1-k_1\\tau)^2$:\n$$ V_n = P + Q (1-k_1\\tau)^n + (V_0 - P - Q) (1-k_1\\tau)^{2n} $$\n在时间 $T=N\\tau$ 的 tau-跳跃方差为 $V_{\\text{tau}}(T,\\tau) = V_N$。\n\n**第三部分：绝对误差**\n在时间 $T$，tau-跳跃方差与精确 CME 方差之间的绝对误差 $E(\\tau)$ 为：\n$$ E(\\tau) = |V_{\\text{tau}}(T, \\tau) - V_{\\text{exact}}(T)| $$\n其中 $V_{\\text{tau}}(T, \\tau)$ 是 $N=T/\\tau$ 时的 $V_N$，而 $V_{\\text{exact}}(T)$ 是在第一部分中推导的公式。这些公式将被实现以计算所需的值。",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Computes the absolute error between the exact variance and the tau-leaping\n    variance for an immigration-death process.\n    \"\"\"\n\n    test_cases = [\n        {'k0': 40, 'k1': 2, 'm0': 0, 'v0': 0, 'T': 1.0, 'tau': 0.05},\n        {'k0': 40, 'k1': 2, 'm0': 0, 'v0': 0, 'T': 0.8, 'tau': 0.4},\n        {'k0': 20, 'k1': 1.0, 'm0': 50, 'v0': 0, 'T': 2.0, 'tau': 0.2},\n        {'k0': 50, 'k1': 1.0, 'm0': 50, 'v0': 0, 'T': 2.0, 'tau': 0.25},\n        {'k0': 5.0, 'k1': 0.2, 'm0': 10, 'v0': 0, 'T': 5.0, 'tau': 0.5},\n    ]\n\n    results = []\n    \n    for case in test_cases:\n        k0 = case['k0']\n        k1 = case['k1']\n        m0 = case['m0']\n        v0 = case['v0']\n        T = case['T']\n        tau = case['tau']\n        \n        # Ensure N is an integer, handling potential floating point inaccuracies\n        N = int(round(T / tau))\n\n        # Part 1: Exact Variance from CME\n        # Check for k1=0 to avoid division by zero\n        if k1 == 0:\n            # Pure immigration process (Poisson process)\n            m_exact_T = m0 + k0 * T\n            V_exact_T = v0 + k0 * T\n        else:\n            # Immigration-death process\n            k0_over_k1 = k0 / k1\n            m_exact_T = k0_over_k1 + (m0 - k0_over_k1) * np.exp(-k1 * T)\n            V_exact_T = m_exact_T + (v0 - m0) * np.exp(-2 * k1 * T)\n\n        # Part 2: Tau-Leaping Variance\n        V_tau_T = 0.0\n        if k1 == 0:\n            # For pure immigration, tau-leaping is exact\n            V_tau_T = v0 + N * k0 * tau\n        else:\n            k1_tau = k1 * tau\n            \n            # General Case: Handles all test cases provided\n            if abs(k1_tau - 1.0) > 1e-12 and abs(k1_tau - 2.0) > 1e-12:\n                P = (2.0 * k0) / (k1 * (2.0 - k1_tau))\n                Q = (m0 - k0 / k1) / (1.0 - k1_tau)\n                rm = 1.0 - k1_tau\n                V_tau_T = P + Q * (rm**N) + (v0 - P - Q) * (rm**(2 * N))\n            \n            # Special Case: k1*tau = 1\n            elif abs(k1_tau - 1.0)  1e-12:\n                if N == 0:\n                    V_tau_T = v0\n                elif N == 1:\n                    V_tau_T = m0 + k0 / k1\n                else:  # N >= 2\n                    V_tau_T = 2.0 * k0 / k1\n            \n            # Special Case: k1*tau = 2\n            elif abs(k1_tau - 2.0)  1e-12:\n                C1 = 2.0 * k0 * tau\n                C2 = k1_tau * (m0 - k0 / k1)\n                sum_term = 0.0\n                if N % 2 != 0:  # N is odd\n                    sum_term = 1.0\n                V_tau_T = v0 + N * C1 + C2 * sum_term\n\n        # Part 3: Absolute Error\n        error = abs(V_tau_T - V_exact_T)\n        results.append(error)\n\n    # Format the final output string\n    output_str = f\"[{','.join(map(str, results))}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}