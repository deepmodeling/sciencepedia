{
    "hands_on_practices": [
        {
            "introduction": "许多非编码变异的一个常见效应是改变转录因子的结合亲和力，从而影响基因表达，这是功能基因组学研究的核心。本练习将引导你使用一个基础的生物物理模型，将解离常数（$K_d$）的变化与转录输出的变化联系起来，正如在MPRA（大规模并行报告基因检测）等实验中所测量的那样。通过这个实践，你将加强构建和解释基因调控定量模型的能力。",
            "id": "4342291",
            "problem": "使用大规模并行报告基因检测 (MPRA, Massively Parallel Reporter Assay) 来探测增强子中的一个转录因子结合位点，其中报告基因构建体以与该位点被转录因子占据的概率成正比的速率驱动转录。假设转录因子与 DNA 位点之间存在简单的单一位点结合平衡，没有协同性且基础转录可忽略不计，因此报告基因的转录速率由 $r = k_{\\max} P_{\\text{bound}}$ 给出，其中 $k_{\\max}$ 是位点特异性的最大转录速率常数，$P_{\\text{bound}}$ 是该位点被占据的平衡概率。解离常数由质量作用定律定义为 $K_d = \\frac{[\\mathrm{TF}][S]}{[C]}$，其中 $[\\mathrm{TF}]$ 是游离转录因子的浓度，$[S]$ 是游离位点的浓度，$[C]$ 是转录因子-位点复合物的浓度。\n\n考虑一个参考等位基因，其解离常数为 $K_d^{\\text{ref}} = 10\\,\\mathrm{nM}$，以及一个变异等位基因，其解离常数为 $K_d^{\\text{var}} = 50\\,\\mathrm{nM}$。实验在极限转录因子浓度 $[\\mathrm{TF}] = 0.1\\,\\mathrm{nM}$ 下进行，其中 $[\\mathrm{TF}] \\ll K_d^{\\text{ref}}$ 且 $[\\mathrm{TF}] \\ll K_d^{\\text{var}}$，并且游离转录因子不会因与单个位点结合而显著减少。\n\n从 $K_d$ 的定义和单一位点结合的平衡出发，推导 $P_{\\text{bound}}$ 的函数形式，然后，利用极限浓度假设，推导变异等位基因与参考等位基因之间报告基因转录速率倍数变化的领导项表达式 $\\frac{r^{\\text{var}}}{r^{\\text{ref}}}$。计算此倍数变化的自然对数 $L = \\ln\\!\\left(\\frac{r^{\\text{var}}}{r^{\\text{ref}}}\\right)$，结果为一个实数。将您的答案四舍五入到四位有效数字。最终答案无需单位。",
            "solution": "用户要求我解决一个关于转录因子结合功能基因组学的问题。\n\n**1. 问题验证**\n\n首先，我将验证问题陈述。\n\n**步骤 1：提取已知条件**\n-   报告基因转录速率由方程 $r = k_{\\max} P_{\\text{bound}}$ 给出。\n-   $k_{\\max}$ 是位点特异性的最大转录速率常数。\n-   $P_{\\text{bound}}$ 是一个位点被转录因子占据的平衡概率。\n-   该平衡是针对单一位点的，没有协同性且基础转录可忽略不计。\n-   解离常数定义为 $K_d = \\frac{[\\mathrm{TF}][S]}{[C]}$，其中 $[\\mathrm{TF}]$ 是游离转录因子的浓度，$[S]$ 是游离位点的浓度，$[C]$ 是转录因子-位点复合物的浓度。\n-   参考等位基因解离常数：$K_d^{\\text{ref}} = 10\\,\\mathrm{nM}$。\n-   变异等位基因解离常数：$K_d^{\\text{var}} = 50\\,\\mathrm{nM}$。\n-   实验转录因子浓度：$[\\mathrm{TF}] = 0.1\\,\\mathrm{nM}$。\n-   极限浓度假设：$[\\mathrm{TF}] \\ll K_d^{\\text{ref}}$ 且 $[\\mathrm{TF}] \\ll K_d^{\\text{var}}$。\n-   假设：游离转录因子浓度不会因结合而显著减少。\n-   任务是首先推导 $P_{\\text{bound}}$ 的函数形式，然后推导报告基因转录速率倍数变化的领导项表达式 $\\frac{r^{\\text{var}}}{r^{\\text{ref}}}$，最后计算 $L = \\ln\\!\\left(\\frac{r^{\\text{var}}}{r^{\\text{ref}}}\\right)$ 并保留四位有效数字。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题具有科学依据，采用了生物化学的基石——单一位点生物分子结合的标准 Langmuir-Hill 模型。使用大规模并行报告基因检测 (MPRA) 进行变异效应表征的背景是功能基因组学中一个有效且前沿的课题。所提供的值（纳摩尔范围内的 $K_d$，亚纳摩尔的 $[\\mathrm{TF}]$）对于转录因子-DNA 相互作用是物理上现实的。问题陈述清晰，提供了得出唯一解所需的所有必要信息、定义和约束。语言客观精确。该问题不违反任何指定的无效标准。\n\n**步骤 3：结论与行动**\n问题有效。我将继续进行解答。\n\n**2. 解题推导**\n\n解题过程按要求分为三部分：推导 $P_{\\text{bound}}$ 的表达式，推导转录速率倍数变化的领导项近似值，以及计算最终数值。\n\n**第 1 部分：推导平衡结合概率 $P_{\\text{bound}}$**\n\n结合位点被占据的概率 $P_{\\text{bound}}$ 是处于复合物形式的位点占总位点的比例。设 $[S]_{\\text{total}}$ 为结合位点的总浓度。根据位点的质量守恒：\n$$[S]_{\\text{total}} = [S] + [C]$$\n其中 $[S]$ 是游离（未占据）位点的浓度，$[C]$ 是转录因子-DNA 复合物（已占据位点）的浓度。\n\n$P_{\\text{bound}}$ 定义为：\n$$P_{\\text{bound}} = \\frac{[C]}{[S]_{\\text{total}}} = \\frac{[C]}{[S] + [C]}$$\n解离常数 $K_d$ 由解离反应 $C \\rightleftharpoons \\mathrm{TF} + S$ 的质量作用定律给出：\n$$K_d = \\frac{[\\mathrm{TF}][S]}{[C]}$$\n我们可以重新整理这个表达式来解出游离位点的浓度 $[S]$：\n$$[S] = \\frac{K_d [C]}{[\\mathrm{TF}]}$$\n现在，将这个 $[S]$ 的表达式代入 $P_{\\text{bound}}$ 的方程中：\n$$P_{\\text{bound}} = \\frac{[C]}{\\frac{K_d [C]}{[\\mathrm{TF}]} + [C]}$$\n分子和分母的两项中都含有 $[C]$，因此可以消去：\n$$P_{\\text{bound}} = \\frac{1}{\\frac{K_d}{[\\mathrm{TF}]} + 1}$$\n分子和分母同乘以 $[\\mathrm{TF}]$，得到单一位点结合等温线（或 Hill-Langmuir 方程）的标准形式：\n$$P_{\\text{bound}} = \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d}$$\n问题陈述指出，游离转录因子不会因结合而显著减少，这证实了将 $[\\mathrm{TF}]$ 视为等于所提供浓度的恒定参数是合理的。\n\n**第 2 部分：推导倍数变化 $\\frac{r^{\\text{var}}}{r^{\\text{ref}}}$ 的领导项表达式**\n\n转录速率 $r$ 与 $P_{\\text{bound}}$ 成正比，比例常数为 $k_{\\max}$：\n$$r = k_{\\max} P_{\\text{bound}} = k_{\\max} \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d}$$\n我们正在比较同一结合位点的参考等位基因和变异等位基因。在这类问题中，一个标准的假设是突变影响结合亲和力（即 $K_d$），但不影响因子结合后的最大转录输出。因此，我们假设两个等位基因的 $k_{\\max}$ 相同：$k_{\\max}^{\\text{ref}} = k_{\\max}^{\\text{var}} = k_{\\max}$。\n\n变异等位基因和参考等位基因的转录速率分别为：\n$$r^{\\text{var}} = k_{\\max} \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d^{\\text{var}}}$$\n$$r^{\\text{ref}} = k_{\\max} \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d^{\\text{ref}}}$$\n倍数变化是这两个速率的比值：\n$$\\frac{r^{\\text{var}}}{r^{\\text{ref}}} = \\frac{k_{\\max} \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d^{\\text{var}}}}{k_{\\max} \\frac{[\\mathrm{TF}]}{[\\mathrm{TF}] + K_d^{\\text{ref}}}}$$\n消去共同项 $k_{\\max}$ 和 $[\\mathrm{TF}]$，得到倍数变化的确切表达式：\n$$\\frac{r^{\\text{var}}}{r^{\\text{ref}}} = \\frac{[\\mathrm{TF}] + K_d^{\\text{ref}}}{[\\mathrm{TF}] + K_d^{\\text{var}}}$$\n问题要求在两个等位基因都满足极限浓度假设 $[\\mathrm{TF}] \\ll K_d$ 的情况下的*领导项表达式*。在此极限下，结合概率得以简化。对于一个通用的 $K_d$：\n$$P_{\\text{bound}} = \\frac{[\\mathrm{TF}]}{K_d + [\\mathrm{TF}]} = \\frac{[\\mathrm{TF}]}{K_d \\left(1 + \\frac{[\\mathrm{TF}]}{K_d}\\right)} = \\frac{[\\mathrm{TF}]}{K_d} \\left(1 + \\frac{[\\mathrm{TF}]}{K_d}\\right)^{-1}$$\n对于小的 $x$，使用一阶泰勒展开 $(1+x)^{-1} \\approx 1 - x$，其中 $x = \\frac{[\\mathrm{TF}]}{K_d} \\ll 1$：\n$$P_{\\text{bound}} \\approx \\frac{[\\mathrm{TF}]}{K_d} \\left(1 - \\frac{[\\mathrm{TF}]}{K_d}\\right) = \\frac{[\\mathrm{TF}]}{K_d} - \\left(\\frac{[\\mathrm{TF}]}{K_d}\\right)^2 + \\dots$$\n领导项是第一项，它对应于结合曲线的线性区域：\n$$P_{\\text{bound}} \\approx \\frac{[\\mathrm{TF}]}{K_d}$$\n将此近似应用于转录速率：\n$$r^{\\text{var}} \\approx k_{\\max} \\frac{[\\mathrm{TF}]}{K_d^{\\text{var}}}$$\n$$r^{\\text{ref}} \\approx k_{\\max} \\frac{[\\mathrm{TF}]}{K_d^{\\text{ref}}}$$\n倍数变化的领导项表达式是这些近似速率的比值：\n$$\\frac{r^{\\text{var}}}{r^{\\text{ref}}} \\approx \\frac{k_{\\max} \\frac{[\\mathrm{TF}]}{K_d^{\\text{var}}}}{k_{\\max} \\frac{[\\mathrm{TF}]}{K_d^{\\text{ref}}}} = \\frac{K_d^{\\text{ref}}}{K_d^{\\text{var}}}$$\n\n**第 3 部分：计算 $L = \\ln\\!\\left(\\frac{r^{\\text{var}}}{r^{\\text{ref}}}\\right)$**\n\n使用推导出的领导项表达式和给定值：\n$$K_d^{\\text{ref}} = 10\\,\\mathrm{nM}$$\n$$K_d^{\\text{var}} = 50\\,\\mathrm{nM}$$\n倍数变化约等于：\n$$\\frac{r^{\\text{var}}}{r^{\\text{ref}}} \\approx \\frac{10\\,\\mathrm{nM}}{50\\,\\mathrm{nM}} = \\frac{1}{5} = 0.2$$\n问题要求计算此倍数变化的自然对数，我们将其记为 $L$：\n$$L = \\ln\\!\\left(\\frac{r^{\\text{var}}}{r^{\\text{ref}}}\\right) \\approx \\ln(0.2)$$\n$$L = \\ln\\left(\\frac{1}{5}\\right) = -\\ln(5)$$\n现在，我们计算数值：\n$$L \\approx -1.609437912\\dots$$\n将结果四舍五入到四位有效数字，得到：\n$$L \\approx -1.609$$",
            "answer": "$$\\boxed{-1.609}$$"
        },
        {
            "introduction": "在建立了理论模型之后，下一步是从真实的实验数据中量化变异效应，而RNA测序是功能基因组学中的主力检测技术。该技术的一个关键应用是测量遗传变异如何影响RNA剪接。本练习专注于推导并应用统计方法，直接从测序读数（read counts）中计算“剪接包含百分比”（Percent Spliced In, PSI或$\\Psi$），这是剪接定量的标准指标。",
            "id": "4342287",
            "problem": "在一次使用核糖核酸测序（RNA-seq）的功能基因组学分析中，为了表征一个基因组变异对盒式外显子的影响，“剪接纳入百分比”（percent spliced in, PSI）是指在所有携带包含或排除剪接点的分子中，包含了该外显子的信使核糖核酸分子所占的比例。形式上，对于一个具有两种互斥剪接点结果（包含和排除）的二元剪接事件，PSI是根据真实的剪接点使用概率来定义的。假设以下符合情景的基本前提：分子生物学的中心法则，RNA-seq的读数计数为潜在的转录本丰度提供了带有噪声的样本这一概念，以及一个二项采样模型，其中每个跨剪接点的读数都是从异构体使用分布中进行的独立同分布抽样。\n\n在单个样本中，您观察到该外显子有 $N_{\\text{inc}}$ 个包含剪接点的读数和 $N_{\\text{exc}}$ 个排除剪接点的读数。在上述假设下：\n- 精确定义PSI（表示为 $\\,\\Psi\\,$），将其作为潜在剪接点使用分布的一个参数。\n- 从二项似然出发，根据观察到的计数值 $\\,N_{\\text{inc}}\\,$ 和 $\\,N_{\\text{exc}}\\,$，推导 $\\,\\Psi\\,$ 的最大似然估计量。\n- 在二项模型下推导该估计量的抽样方差，并提供一个仅依赖于 $\\,N_{\\text{inc}}\\,$ 和 $\\,N_{\\text{exc}}\\,$ 的一致的代入估计量。\n- 使用观察到的计数值 $\\,N_{\\text{inc}} = 87\\,$ 和 $\\,N_{\\text{exc}} = 213\\,$，计算抽样方差的代入估计值。将您的答案四舍五入到四位有效数字。以标准科学记数法 $a \\times 10^{b}$（其中 $1 \\leq |a|  10$）的形式表示您的最终答案，该答案为一个无量纲小数。",
            "solution": "问题陈述已经过验证，被认为是有效的。它在科学上基于RNA测序（RNA-seq）数据的标准统计建模，问题提出得当，信息充分，可得出唯一解，并以客观、正式的语言表述。因此，我们可以开始求解。\n\n该问题要求进行几项与来自RNA-seq数据的剪接纳入百分比（$\\text{PSI}$ 或 $\\Psi$）相关的推导，并最终进行数值计算。我们将按顺序解决每个部分。\n\n首先，我们必须精确定义参数 $\\Psi$。问题陈述指出，对于一个二元剪接事件，每个跨剪接点的读数都是一个独立同分布的抽样。这对应于一系列Bernoulli试验。设 $X_i$ 是一个随机变量，表示第 $i$ 个读数的结果，其中 $i = 1, \\dots, N$。我们可以定义，如果读数来自一个包含剪接点，则结果 $X_i=1$；如果它来自一个排除剪接点，则结果 $X_i=0$。参数 $\\Psi$ 是每次试验的成功概率，即随机选择的一个跨剪接点的读数支持外显子包含异构体的概率。\n$$\nP(X_i = 1) = \\Psi\n$$\n$$\nP(X_i = 0) = 1 - \\Psi\n$$\n因此，$\\Psi$ 是潜在的Bernoulli分布的参数，该分布控制着任何单个观察到的分子的剪接结果。\n\n其次，我们推导 $\\Psi$ 的最大似然估计量（$\\text{MLE}$）。我们观察到 $N_{\\text{inc}}$ 个包含读数和 $N_{\\text{exc}}$ 个排除读数。观察到的跨剪接点读数的总数是 $N = N_{\\text{inc}} + N_{\\text{exc}}$。包含读数的数量 $N_{\\text{inc}}$ 可以被建模为一个服从二项分布的随机变量，其试验次数为 $N$，成功概率为 $\\Psi$。其概率质量函数是：\n$$\nP(N_{\\text{inc}} | N, \\Psi) = \\binom{N}{N_{\\text{inc}}} \\Psi^{N_{\\text{inc}}} (1-\\Psi)^{N-N_{\\text{inc}}}\n$$\n给定观察数据（$N_{\\text{inc}}$ 和 $N_{\\text{exc}}$），似然函数 $L(\\Psi)$ 是观察到这些数据的概率，并被看作是参数 $\\Psi$ 的函数：\n$$\nL(\\Psi | N_{\\text{inc}}, N_{\\text{exc}}) = \\binom{N_{\\text{inc}}+N_{\\text{exc}}}{N_{\\text{inc}}} \\Psi^{N_{\\text{inc}}} (1-\\Psi)^{N_{\\text{exc}}}\n$$\n为了找到 $\\text{MLE}$，计算上更简单的方法是最大化对数似然函数 $\\ell(\\Psi) = \\ln(L(\\Psi))$：\n$$\n\\ell(\\Psi) = \\ln\\left(\\binom{N_{\\text{inc}}+N_{\\text{exc}}}{N_{\\text{inc}}}\\right) + N_{\\text{inc}}\\ln(\\Psi) + N_{\\text{exc}}\\ln(1-\\Psi)\n$$\n我们通过对 $\\Psi$ 求导并令其为零来找到最大值。\n$$\n\\frac{d\\ell}{d\\Psi} = \\frac{N_{\\text{inc}}}{\\Psi} - \\frac{N_{\\text{exc}}}{1-\\Psi}\n$$\n令导数为 $0$：\n$$\n\\frac{N_{\\text{inc}}}{\\hat{\\Psi}} - \\frac{N_{\\text{exc}}}{1-\\hat{\\Psi}} = 0 \\implies \\frac{N_{\\text{inc}}}{\\hat{\\Psi}} = \\frac{N_{\\text{exc}}}{1-\\hat{\\Psi}}\n$$\n$$\nN_{\\text{inc}}(1-\\hat{\\Psi}) = N_{\\text{exc}}\\hat{\\Psi}\n$$\n$$\nN_{\\text{inc}} - N_{\\text{inc}}\\hat{\\Psi} = N_{\\text{exc}}\\hat{\\Psi}\n$$\n$$\nN_{\\text{inc}} = (N_{\\text{inc}} + N_{\\text{exc}})\\hat{\\Psi}\n$$\n求解 $\\hat{\\Psi}$，即 $\\Psi$ 的最大似然估计量，我们得到：\n$$\n\\hat{\\Psi} = \\frac{N_{\\text{inc}}}{N_{\\text{inc}} + N_{\\text{exc}}}\n$$\n\n第三，我们推导估计量 $\\hat{\\Psi}$ 的抽样方差。估计量 $\\hat{\\Psi}$ 是随机变量 $N_{\\text{inc}}$ 和总计数 $N = N_{\\text{inc}} + N_{\\text{exc}}$ 的函数，后者被视为固定的试验次数。\n$$\n\\hat{\\Psi} = \\frac{N_{\\text{inc}}}{N}\n$$\n该估计量的方差是：\n$$\n\\text{Var}(\\hat{\\Psi}) = \\text{Var}\\left(\\frac{N_{\\text{inc}}}{N}\\right) = \\frac{1}{N^2}\\text{Var}(N_{\\text{inc}})\n$$\n由于 $N_{\\text{inc}}$ 服从二项分布 $\\text{Bin}(N, \\Psi)$，其方差为 $\\text{Var}(N_{\\text{inc}}) = N\\Psi(1-\\Psi)$。将此代入 $\\text{Var}(\\hat{\\Psi})$ 的方程中：\n$$\n\\text{Var}(\\hat{\\Psi}) = \\frac{1}{N^2} \\left[N\\Psi(1-\\Psi)\\right] = \\frac{\\Psi(1-\\Psi)}{N}\n$$\n代入 $N = N_{\\text{inc}} + N_{\\text{exc}}$，估计量的抽样方差为：\n$$\n\\text{Var}(\\hat{\\Psi}) = \\frac{\\Psi(1-\\Psi)}{N_{\\text{inc}} + N_{\\text{exc}}}\n$$\n这个表达式依赖于真实的、未知的参数 $\\Psi$。该方差的一个一致的代入估计量，表示为 $\\widehat{\\text{Var}}(\\hat{\\Psi})$，是通过将未知参数 $\\Psi$ 替换为其一致估计量 $\\hat{\\Psi}$ 得到的：\n$$\n\\widehat{\\text{Var}}(\\hat{\\Psi}) = \\frac{\\hat{\\Psi}(1-\\hat{\\Psi})}{N} = \\frac{\\hat{\\Psi}(1-\\hat{\\Psi})}{N_{\\text{inc}} + N_{\\text{exc}}}\n$$\n我们可以通过代入 $\\hat{\\Psi}$ 的表达式，仅用观察到的计数值来表示它：\n$$\n\\hat{\\Psi} = \\frac{N_{\\text{inc}}}{N_{\\text{inc}} + N_{\\text{exc}}} \\quad \\text{和} \\quad 1-\\hat{\\Psi} = \\frac{N_{\\text{exc}}}{N_{\\text{inc}} + N_{\\text{exc}}}\n$$\n$$\n\\widehat{\\text{Var}}(\\hat{\\Psi}) = \\frac{\\left(\\frac{N_{\\text{inc}}}{N_{\\text{inc}} + N_{\\text{exc}}}\\right)\\left(\\frac{N_{\\text{exc}}}{N_{\\text{inc}} + N_{\\text{exc}}}\\right)}{N_{\\text{inc}} + N_{\\text{exc}}} = \\frac{N_{\\text{inc}}N_{\\text{exc}}}{(N_{\\text{inc}} + N_{\\text{exc}})^3}\n$$\n这就是所要求的抽样方差的一致的代入估计量。\n\n第四，我们使用观察到的计数值 $N_{\\text{inc}} = 87$ 和 $N_{\\text{exc}} = 213$ 来计算这个代入估计的数值。\n读数总数是 $N = N_{\\text{inc}} + N_{\\text{exc}} = 87 + 213 = 300$。\n估计的PSI为 $\\hat{\\Psi} = \\frac{87}{300} = 0.29$。\n方差的代入估计值为：\n$$\n\\widehat{\\text{Var}}(\\hat{\\Psi}) = \\frac{\\hat{\\Psi}(1-\\hat{\\Psi})}{N} = \\frac{(0.29)(1 - 0.29)}{300} = \\frac{(0.29)(0.71)}{300}\n$$\n$$\n\\widehat{\\text{Var}}(\\hat{\\Psi}) = \\frac{0.2059}{300} \\approx 0.000686333...\n$$\n或者，使用估计量的另一种形式：\n$$\n\\widehat{\\text{Var}}(\\hat{\\Psi}) = \\frac{(87)(213)}{(87+213)^3} = \\frac{18531}{300^3} = \\frac{18531}{27000000} \\approx 0.000686333...\n$$\n问题要求答案四舍五入到四位有效数字，并以标准科学记数法表示。\n值为 $0.000686333...$。前四位有效数字是 $6$、$8$、$6$ 和 $3$。四舍五入后得到 $0.0006863$。\n以标准科学记数法 $a \\times 10^b$（其中 $1 \\leq |a|  10$）表示，即为 $6.863 \\times 10^{-4}$。",
            "answer": "$$\\boxed{6.863 \\times 10^{-4}}$$"
        },
        {
            "introduction": "现在，我们将分析尺度从单个变异或基因事件扩展到全基因组范围的功能筛选，CRISPR合并筛选（pooled screens）是一项能够系统性测试数千个基因或调控元件功能的强大技术。这个实践问题将带你完成一个完整的数据分析流程：对原始读数进行标准化，计算倍数变化，并使用广义线性模型（GLM）从多个导向RNA（gRNA）的嘈杂数据中严谨地推断基因水平的效应。这是一次深入现代功能基因组学生物信息学分析的动手实践。",
            "id": "4342320",
            "problem": "您将获得来自成簇规律间隔短回文重复序列 (CRISPR) 混合筛选的计数数据，其中每个向导 RNA (gRNA) 靶向一个基因，并在两个时间点测量其读数计数。目标是计算经文库大小标准化的对数倍数变化，然后拟合一个广义线性模型 (GLM)，以从靶向同一基因的多个 gRNA 推断基因水平的效应。\n\n基本原理：\n- 在 CRISPR 混合筛选中，给定时间点每个 gRNA 的测序读数计数可以通过泊松抽样过程很好地近似，其均值与真实丰度和文库大小成正比。如果 $c_i(t)$ 表示 gRNA $i$ 在时间 $t$ 的观测计数，$L_t$ 表示时间 $t$ 的总文库大小，则 gRNA $i$ 在时间 $t$ 的标准化丰度为 $n_i(t) = \\dfrac{c_i(t) + s}{L_t}$，其中 $s  0$ 是一个小的伪计数，用于稳定比率并避免除以零。\n- gRNA $i$ 在时间 $t_0$ 和时间 $t_1$ 之间的对数倍数变化定义为\n$$\n\\ell_i = \\log_2\\left(\\frac{n_i(t_1)}{n_i(t_0)}\\right) = \\log_2\\left(\\frac{c_i(t_1)+s}{c_i(t_0)+s}\\right) + \\log_2\\left(\\frac{L_{t_0}}{L_{t_1}}\\right).\n$$\n- 在泊松模型下，并假设 $c_i(t_0)$ 和 $c_i(t_1)$ 相互独立，delta 方法可得出以 2 为底的对数倍数变化的近似方差：\n$$\n\\operatorname{Var}(\\ell_i) \\approx \\frac{1}{(\\ln 2)^2} \\left(\\frac{1}{c_i(t_1)+s} + \\frac{1}{c_i(t_0)+s}\\right).\n$$\n- 为了推断基因水平的效应，我们使用高斯 GLM（具有恒等连接函数的正态分布）和异方差误差来对 gRNA 水平的对数倍数变化进行建模，并采用加权最小二乘法：\n$$\n\\ell_i = \\alpha + \\sum_{g \\in \\mathcal{G}\\setminus\\{g_{\\text{base}}\\}} \\beta_g \\cdot \\mathbf{1}\\{g_i = g\\} + \\varepsilon_i,\n$$\n其中 $g_i$ 是 gRNA $i$ 靶向的基因，$\\alpha$ 是截距，$g_{\\text{base}}$ 是选定的基线基因（例如，非靶向对照），$\\beta_g$ 是相对于基线的基因水平效应，且 $\\varepsilon_i \\sim \\mathcal{N}(0, \\sigma_i^2)$，其中 $\\sigma_i^2 \\approx \\operatorname{Var}(\\ell_i)$。加权最小二乘法得出\n$$\n\\hat{\\boldsymbol{\\theta}} = \\left(\\mathbf{X}^\\top \\mathbf{W} \\mathbf{X}\\right)^{-1} \\mathbf{X}^\\top \\mathbf{W} \\mathbf{y},\n$$\n其中 $\\mathbf{y}$ 是 $\\ell_i$ 的向量，$\\mathbf{X}$ 是设计矩阵，其包含一列全为 1（截距）以及除基线基因外每个基因的独热指示符，$\\mathbf{W}$ 是一个对角矩阵，其对角线上的元素为 $w_i = 1/\\sigma_i^2$。\n\n任务：\n编写一个 Python 程序以实现以下功能：\n1. 对于每个提供的测试用例，使用上述公式为所有 gRNA 计算经文库大小标准化的以 2 为底的对数倍数变化 $\\ell_i$。\n2. 使用上述方差近似公式计算权重 $w_i = 1/\\operatorname{Var}(\\ell_i)$。\n3. 构建设计矩阵 $\\mathbf{X}$，包含一个截距列和除给定基线基因外的每个基因的独热编码列。\n4. 拟合加权最小二乘模型以估计相对于基线的基因水平效应 $\\beta_g$。\n5. 对于每个测试用例，将估计的基因效应输出到一个列表中，该列表按基因标签（不包括基线基因）的字典序排序。将每个估计的效应四舍五入到六位小数。\n\n假设：\n- 所有计数 $c_i(t)$ 均为非负整数。\n- 伪计数 $s$ 是严格为正的给定值。\n- 对于每个测试用例，文库大小 $L_{t_0}$ 和 $L_{t_1}$ 是已知的正常数。\n\n角度单位不适用。答案中不使用物理单位。所有输出必须是四舍五入到六位小数的浮点数。\n\n测试套件：\n- 案例 1（一般情况，每个基因有多个向导，文库大小均衡）：\n    - $t_0$ 时的计数：$[1000, 1200, 900, 1100, 800, 850]$\n    - $t_1$ 时的计数：$[980, 1180, 600, 700, 1200, 1300]$\n    - 基因标签：$[\\text{NTC}, \\text{NTC}, \\text{G1}, \\text{G1}, \\text{G2}, \\text{G2}]$\n    - 基线基因：$\\text{NTC}$\n    - 文库大小：$(L_{t_0}, L_{t_1}) = (1000000, 1000000)$\n    - 伪计数：$s = 1$\n- 案例 2（包含零计数和不等文库大小的边缘情况）：\n    - $t_0$ 时的计数：$[500, 600, 400, 450]$\n    - $t_1$ 时的计数：$[520, 590, 0, 10]$\n    - 基因标签：$[\\text{NTC}, \\text{NTC}, \\text{G3}, \\text{G3}]$\n    - 基线基因：$\\text{NTC}$\n    - 文库大小：$(L_{t_0}, L_{t_1}) = (1000000, 800000)$\n    - 伪计数：$s = 1$\n- 案例 3（一个基因只有一个向导的边界情况）：\n    - $t_0$ 时的计数：$[2000, 2100, 1500]$\n    - $t_1$ 时的计数：$[1990, 2050, 1600]$\n    - 基因标签：$[\\text{NTC}, \\text{NTC}, \\text{G4}]$\n    - 基线基因：$\\text{NTC}$\n    - 文库大小：$(L_{t_0}, L_{t_1}) = (2000000, 2000000)$\n    - 伪计数：$s = 1$\n\n最终输出格式：\n您的程序应生成单行输出，其中包含一个用方括号括起来的列表的逗号分隔列表，每个内部列表对应一个测试用例，并包含按基因标签（不包括基线）字典序排列并四舍五-入到六位小数的估计基因效应。例如，打印的输出必须如下所示\n$$\n[[x_1,x_2],[y_1],[z_1]]\n$$\n其中 $x_i$、$y_i$ 和 $z_i$ 是保留六位小数的浮点数。",
            "solution": "该问题要求使用广义线性模型 (GLM) 从 CRISPR 混合筛选计数数据中估计基因水平的效应。所提供的框架是分析此类数据的一种标准且在统计上可靠的方法。解决方案通过实施指定的分析工作流程来进行，该流程涉及数据标准化、方差估计和拟合加权最小二乘 (WLS) 模型。\n\n问题的核心在于求解用于 WLS 估计的矩阵方程：\n$$\n\\hat{\\boldsymbol{\\theta}} = \\left(\\mathbf{X}^\\top \\mathbf{W} \\mathbf{X}\\right)^{-1} \\mathbf{X}^\\top \\mathbf{W} \\mathbf{y}\n$$\n其中 $\\hat{\\boldsymbol{\\theta}}$ 是估计系数（截距和基因效应）的向量，$\\mathbf{X}$ 是设计矩阵，$\\mathbf{W}$ 是对角权重矩阵，$\\mathbf{y}$ 是观测到的对数倍数变化的向量。\n\n每个测试用例的步骤如下：\n\n1.  **计算对数倍数变化 (LFCs)**：响应向量，表示为 $\\mathbf{y}$，由每个 gRNA $i$ 的经文库大小标准化的以 2 为底的对数倍数变化 $\\ell_i$ 组成。给定时间 $t_0$ 和 $t_1$ 的原始计数 $c_i(t_0)$ 和 $c_i(t_1)$、总文库大小 $L_{t_0}$ 和 $L_{t_1}$ 以及伪计数 $s  0$，gRNA $i$ 的 LFC 计算如下：\n    $$\n    \\ell_i = \\log_2\\left(\\frac{c_i(t_1)+s}{c_i(t_0)+s}\\right) + \\log_2\\left(\\frac{L_{t_0}}{L_{t_1}}\\right)\n    $$\n    这个 $\\ell_i$ 值的向量构成了 WLS 模型中的响应向量 $\\mathbf{y}$。\n\n2.  **计算权重**：每个 LFC 测量值 $\\ell_i$ 的精度取决于原始读数计数。delta 方法为 $\\ell_i$ 提供了一个近似方差：\n    $$\n    \\sigma_i^2 = \\operatorname{Var}(\\ell_i) \\approx \\frac{1}{(\\ln 2)^2} \\left(\\frac{1}{c_i(t_1)+s} + \\frac{1}{c_i(t_0)+s}\\right)\n    $$\n    在加权最小二乘法中，每个观测值都按其方差的倒数进行加权，以便为更精确的测量值赋予更大的影响。因此，观测值 $i$ 的权重为 $w_i = 1/\\sigma_i^2$。这些权重构成了权重矩阵 $\\mathbf{W}$ 的对角元素，其中所有非对角元素均为零。\n    $$\n    w_i = \\frac{(\\ln 2)^2}{\\frac{1}{c_i(t_1)+s} + \\frac{1}{c_i(t_0)+s}}\n    $$\n\n3.  **构建设计矩阵**：设计矩阵 $\\mathbf{X}$ 编码了 gRNA 与待估计基因效应之间的关系。模型为：\n    $$\n    \\ell_i = \\alpha + \\sum_{g \\in \\mathcal{G}\\setminus\\{g_{\\text{base}}\\}} \\beta_g \\cdot \\mathbf{1}\\{g_i = g\\} + \\varepsilon_i\n    $$\n    此处，$\\alpha$ 是截距，代表基线基因 ($g_{\\text{base}}$) 的效应，$\\beta_g$ 是基因 $g$ 相对于此基线的差异效应。为构建 $\\mathbf{X}$，我们首先确定唯一的非基线基因集合，并按字典序对其进行排序。$\\mathbf{X}$ 的第一列是全为 1 的列，对应于截距 $\\alpha$。后续各列是每个非基线基因的指示变量（独热编码）。对于给定的基因 $g$，如果 gRNA $i$ 靶向基因 $g$，则其对应列的第 $i$ 行将为 1，否则为 0。这种形式可以防止完全多重共线性（“虚拟变量陷阱”），并使模型参数可识别。\n\n4.  **求解 WLS 系统**：在构建了 $\\mathbf{y}$、$\\mathbf{W}$ 和 $\\mathbf{X}$ 之后，通过求解 WLS 的“正规方程组”来找到系数向量 $\\hat{\\boldsymbol{\\theta}} = [\\hat{\\alpha}, \\hat{\\beta}_{g_1}, \\hat{\\beta}_{g_2}, \\dots]^\\top$。我们不直接计算可能数值不稳定的矩阵逆 $(\\mathbf{X}^\\top \\mathbf{W} \\mathbf{X})^{-1}$，而是求解等价且更稳定的线性系统：\n    $$\n    \\left(\\mathbf{X}^\\top \\mathbf{W} \\mathbf{X}\\right) \\hat{\\boldsymbol{\\theta}} = \\mathbf{X}^\\top \\mathbf{W} \\mathbf{y}\n    $$\n    这是一个标准的线性代数问题。解向量 $\\hat{\\boldsymbol{\\theta}}$ 的第一个元素是估计的截距 $\\hat{\\alpha}$，其后是按构建 $\\mathbf{X}$ 时使用的相同字典序排列的估计基因效应 $\\hat{\\beta}_g$。\n\n5.  **生成输出**：最后一步是从向量 $\\hat{\\boldsymbol{\\theta}}$ 中提取基因效应 $\\hat{\\beta}_g$（即除第一个元素外的所有元素），将它们四舍五入到指定的六位小数，并根据每个测试用例的输出要求进行格式化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process all test cases and print the final result.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"c0\": [1000, 1200, 900, 1100, 800, 850],\n            \"c1\": [980, 1180, 600, 700, 1200, 1300],\n            \"gene_labels\": [\"NTC\", \"NTC\", \"G1\", \"G1\", \"G2\", \"G2\"],\n            \"baseline_gene\": \"NTC\",\n            \"library_sizes\": (1000000, 1000000),\n            \"s\": 1\n        },\n        {\n            \"c0\": [500, 600, 400, 450],\n            \"c1\": [520, 590, 0, 10],\n            \"gene_labels\": [\"NTC\", \"NTC\", \"G3\", \"G3\"],\n            \"baseline_gene\": \"NTC\",\n            \"library_sizes\": (1000000, 800000),\n            \"s\": 1\n        },\n        {\n            \"c0\": [2000, 2100, 1500],\n            \"c1\": [1990, 2050, 1600],\n            \"gene_labels\": [\"NTC\", \"NTC\", \"G4\"],\n            \"baseline_gene\": \"NTC\",\n            \"library_sizes\": (2000000, 2000000),\n            \"s\": 1\n        }\n    ]\n\n    all_results = []\n    for case in test_cases:\n        betas = _estimate_gene_effects(**case)\n        all_results.append(betas)\n\n    # Format the final output string as specified.\n    case_strings = []\n    for result_list in all_results:\n        num_strings = [f\"{b:.6f}\" for b in result_list]\n        case_strings.append(f'[{\",\".join(num_strings)}]')\n    \n    final_output = f\"[{','.join(case_strings)}]\"\n    print(final_output)\n\ndef _estimate_gene_effects(c0, c1, gene_labels, baseline_gene, library_sizes, s):\n    \"\"\"\n    Performs CRISPR screen analysis for a single case.\n    Computes log-fold changes, weights, and fits a WLS model to get gene effects.\n    \"\"\"\n    # Ensure inputs are numpy arrays for vectorized operations\n    c0 = np.array(c0, dtype=float)\n    c1 = np.array(c1, dtype=float)\n    gene_labels = np.array(gene_labels)\n    L0, L1 = library_sizes\n\n    # 1. Compute log fold changes (the response vector y)\n    # l_i = log2((c1_i+s)/(c0_i+s)) + log2(L0/L1)\n    log2_lib_ratio = np.log2(L0 / L1)\n    y = np.log2(c1 + s) - np.log2(c0 + s) + log2_lib_ratio\n\n    # 2. Compute weights for WLS (the weight matrix W)\n    # Var(l_i) approx (1/ln(2)^2) * (1/(c1+s) + 1/(c0+s))\n    # w_i = 1 / Var(l_i)\n    ln2_squared = np.log(2)**2\n    # Add a small epsilon to denominator to prevent division by zero if c0+s or c1+s is somehow zero\n    var_lfc = (1 / ln2_squared) * (1 / (c1 + s + 1e-9) + 1 / (c0 + s + 1e-9))\n    weights = 1 / var_lfc\n    W = np.diag(weights)\n\n    # 3. Construct the design matrix X\n    # Get unique non-baseline genes, sorted lexicographically\n    unique_genes = np.unique(gene_labels)\n    target_genes = sorted([g for g in unique_genes if g != baseline_gene])\n\n    # First column is the intercept\n    intercept_col = np.ones(len(gene_labels))\n    X_cols = [intercept_col]\n\n    # Add a one-hot encoded column for each target gene\n    for gene in target_genes:\n        gene_col = (gene_labels == gene).astype(int)\n        X_cols.append(gene_col)\n\n    X = np.stack(X_cols, axis=1)\n\n    # 4. Solve the WLS system for coefficients theta\n    # (X.T @ W @ X) @ theta = X.T @ W @ y\n    # Use np.linalg.solve for numerical stability\n    XT_W = X.T @ W\n    XT_W_X = XT_W @ X\n    XT_W_y = XT_W @ y\n\n    theta = np.linalg.solve(XT_W_X, XT_W_y)\n\n    # 5. Extract gene effects (betas)\n    # The estimated coefficients in theta are [alpha, beta_g1, beta_g2, ...]\n    # The gene effects are all coefficients after the first (intercept).\n    betas = theta[1:]\n\n    return betas\n\nsolve()\n```"
        }
    ]
}