{
    "hands_on_practices": [
        {
            "introduction": "在我们从循环肿瘤DNA（ctDNA）片段化模式中提取任何生物学见解之前，必须将原始的测序数据转化为可供分析的格式。本练习将引导你评估不同的生物信息学流程设计，这些流程旨在将带有唯一分子标识符（UMI）的双端测序读段（reads）处理成一个精确的片段表 ()。这个过程是所有下游片段化分析的基础，此阶段的选择将直接影响最终结果的准确性。",
            "id": "4322504",
            "problem": "一个血浆游离脱氧核糖核酸(DNA)文库已通过双末端测序读段进行了测序，以支持循环肿瘤DNA片段化分析。该文库在读段1 (Read 1) 的$5'$端整合了长度为$K$个核苷酸的唯一分子标识符(UMIs)。每个读段对的读段长度为$L$个碱基。比对器报告序列比对/图谱(SAM)记录，并输出二进制比对/图谱(BAM)格式，包括CIGAR字符串和比对质量(MAPQ)。假设片段末端反映了核酸酶切位点，并且必须在每条链的$5'$端进行注释。目标是设计一个计算流程，将原始FASTQ文件转换为一个片段表，该表的行代表物理DNA分子，其最小列包括染色体、片段起始坐标$s$、片段结束坐标$e$、片段长度$\\ell$、共有UMI $u$以及一个从参考基因组序列派生的、能够感知链特异性的末端上下文注释。\n\n推导的基本依据：\n- 双末端测序为每个原始DNA片段提供两个读段。对于典型的插入片段，正确的方向意味着一个配对读段比对到正向链，另一个比对到反向链，并且片段长度$\\ell$等于$e - s + 1$，其中$s$和$e$分别是根据比对位置计算出的、位于正向链和反向链上的$5'$端基因组坐标。\n- 比对质量$Q$与错误比对的概率$p_{\\text{err}} = 10^{-Q/10}$相关；较高的$Q$意味着用于末端坐标估计的错配概率较低。\n- UMI合并旨在将源自同一原始分子的测序或聚合酶链式反应(PCR)重复进行合并。UMI碰撞的风险随着原始分子数量$M$相对于UMI空间大小$U$的增加而增加，其中对于随机$K$-mer UMI，$U = 4^{K}$。\n\n给定一项研究，其中$L = 150$，$K = 12$，估计有$M = 10^{6}$个原始分子，请评估以下从FASTQ到片段表的候选流程。选择所有通过第一性原理推理，能够为循环肿瘤DNA片段化分析产生无偏、链特异性正确的片段末端坐标和经过适当合并的分子计数的流程。\n\nA. 从读段1的前$K$个碱基中提取UMI序列，将其移动到读段的头部信息中，并在比对前从读段中硬剪切掉这$K$个碱基；对两个配对读段进行接头剪切和质量剪切；使用高保真、允许空位的比对器将其比对到人类参考基因组；仅保留$Q \\ge 30$且插入片段大小一致的正确配对比对。对于每个读段对，计算$s$为正向链配对读段的$5'$坐标（比对起始位置），$e$为反向链配对读段的$5'$坐标（比对结束位置，考虑CIGAR中的比对匹配长度），然后设$\\ell = e - s + 1$。通过将具有相同共有UMI $u$和相同$\\{s,e\\}$（允许$\\delta \\le 1$个碱基的容差，以防局部比对产生微小变异）的记录进行分组来合并重复，为每个组创建一个共有行。通过在$s$和$e$处从参考基因组检索三核苷酸上下文来注释两端，对反向链末端使用反向互补上下文。\n\nB. 不剪切UMI；在序列中保留UMI进行读段比对；保留$Q \\ge 20$的比对；使用每个配对读段的$3'$坐标来定义片段末端；仅通过UMI合并重复，忽略基因组位置，因为在$M = 10^{6}$时，对于$K = 12$的UMI碰撞可以忽略不计；使用测序读段的碱基而非参考序列来注释末端基序。\n\nC. 在比对前将配对读段合并成单条序列；比对合并后的读段；计算片段长度$\\ell$为总比对长度；使用最外侧的软剪切位置定义末端坐标以捕获潜在的微同源性；通过要求在$\\pm 5$个碱基的容差内具有相等的UMI和相等的$\\ell$来合并重复；使用包括软剪切部分的比对读段序列来注释末端上下文。\n\nD. 提取并剪切UMI；进行接头和质量剪切；比对到人类参考基因组；保留$20 \\le Q  30$的正确配对比对；使用$5'$坐标计算$s$和$e$，如A选项所示；通过要求相同的UMI和在$\\delta = 10$个碱基容差内的$\\{s,e\\}$来合并重复，以适应比对的不确定性；使用参考序列注释末端上下文。\n\n答案选项：\nA, B, C, D",
            "solution": "问题陈述被认为是有效的。它在科学上基于基因组学和生物信息学的原理，特别是关于分析游离DNA以用于循环肿瘤DNA分析等应用。该问题定义明确，提供了清晰的目标以及所有必需的参数和定义。所使用的术语和给定的数值在现代测序实验中是标准的和现实的。\n\n目标是确定一个计算流程，该流程能正确处理带有唯一分子标识符(UMI)的双末端测序数据，以生成用于片段化分析的准确片段表。一次准确的分析需要：\n1. 正确处理UMI以防止比对假象。\n2. 高置信度的比对以建立精确的基因组坐标。\n3. 生物学上正确的片段末端（$s$, $e$）和长度（$\\ell$）的定义和计算。\n4. 稳健的去重（UMI合并），既要考虑PCR重复，也要考虑随机的UMI碰撞。\n5. 注释片段末端序列上下文的正确方法。\n\n我们获得了具体参数：读段长度$L=150$，UMI长度$K=12$，以及估计有$M=10^6$个原始分子。\n\n首先，让我们评估UMI碰撞风险。UMI空间的大小是$U = 4^K = 4^{12} = 16,777,216 \\approx 1.68 \\times 10^7$。对于$M=10^6$个不同的分子，预期碰撞次数（不同的分子偶然被分配到相同UMI的对数）的生日问题近似法计算为$E[\\text{collisions}] \\approx \\frac{M^2}{2U} = \\frac{(10^6)^2}{2 \\times 4^{12}} = \\frac{10^{12}}{2 \\times 16,777,216} \\approx 29,802$。这是一个相当大的碰撞次数，表明仅基于UMI序列进行重复合并是不充分的，并将导致对不同分子的显著低估。正确的合并必须同时利用片段的基因组坐标。\n\n现在我们评估每个提议的流程。\n\n### A选项评估\n\n1.  **UMI处理**：“从读段1的前$K$个碱基中提取UMI序列，将其移动到读段的头部信息中，并在比对前从读段中硬剪切掉这$K$个碱基”。这是正确的程序。它隔离了非生物学的UMI序列，防止其干扰生物学插入序列与参考基因组的比对。\n2.  **剪切与比对**：“对两个配对读段进行接头剪切和质量剪切；使用高保真、允许空位的比对器将其比对到人类参考基因组；仅保留$Q \\ge 30$且插入片段大小一致的正确配对比对”。这是一个稳健的方案。接头和质量剪切是标准的预处理步骤。使用高保真的允许空位的比对器对于精确比对至关重要。筛选具有高比对质量（$Q \\ge 30$，对应最大错配概率$p_{\\text{err}} = 10^{-30/10} = 0.001$）的正确配对读段，对于确保片段末端坐标的精确性是关键。\n3.  **片段坐标计算**：“计算$s$为正向链配对读段的$5'$坐标（比对起始位置），$e$为反向链配对读段的$5'$坐标（比对结束位置，考虑CIGAR中的比对匹配长度），然后设$\\ell = e - s + 1$”。这正确地将片段的边界识别为原始DNA分子两条链的$5'$端。正向链的$5'$端对应于正向读段的比对起始位置。反向链的$5'$端对应于反向互补读段序列的$3'$端，其计算方式为反向读段的比对起始位置加上其在参考序列上的比对长度。在确定两个末端坐标后，通常将它们排序，使$s$为起始，$e$为结束。长度计算$\\ell = e - s + 1$对于基于1的包含性坐标是正确的。\n4.  **UMI合并**：“通过将具有相同共有UMI $u$和相同$\\{s,e\\}$（允许$\\delta \\le 1$个碱基的容差）的记录进行分组来合并重复”。这是正确的去重方法。它要求UMI和基因组坐标都匹配，从而区分真正的PCR重复和随机的UMI碰撞。一个$\\delta \\le 1$个碱基的小容差是适当的，可以解释微小的比对模糊性（例如，在插入缺失周围），而不会错误地合并不同但邻近的片段。\n5.  **末端上下文注释**：“通过在$s$和$e$处从参考基因组检索三核苷酸上下文来注释两端，对反向链末端使用反向互补上下文”。这是科学上合理的方法。对核酸酶切位点偏好的分析应基于不变的参考基因组序列，而不是可能包含测序错误或种系/体细胞变异的读段序列。通过为反向链末端取反向互补来正确处理上下文的链特异性也至关重要。\n\n**对A的结论**：该流程在方法上是健全的，每一步都采用了最佳实践，以确保无偏倚和准确的片段分析。**正确**。\n\n### B选项评估\n\n1.  **UMI处理**：“不剪切UMI；在序列中保留UMI进行读段比对”。这是一个主要缺陷。这会导致读段的$5'$端出现错配，从而引起比对假象，如软剪切（这会改变报告的坐标）或降低比对质量。\n2.  **比对与筛选**：“保留$Q \\ge 20$的比对”。$Q=20$（$p_{\\text{err}}=0.01$）的比对质量阈值对于需要精确末端坐标的应用来说，不如期望的那么严格。\n3.  **片段坐标计算**：“使用每个配对读段的$3'$坐标来定义片段末端”。这在生物学上是不正确的。产生片段的核酸酶切位点位于链的$5'$端。\n4.  **UMI合并**：“仅通过UMI合并重复...因为在$M=10^6$时，对于$K=12$的UMI碰撞可以忽略不计”。如上所述，这个前提是错误的。预期的碰撞次数达数万次，这不可忽略。仅通过UMI进行合并将严重低估文库的复杂性。\n5.  **末端上下文注释**：“使用测序读段的碱基而非参考序列来注释末端基序”。这是不正确的，因为它将切割基序的分析与测序错误和变异混淆在一起。\n\n**对B的结论**：该流程在其设计的每个关键方面都存在缺陷。**不正确**。\n\n### C选项评估\n\n1.  **配对读段处理**：“在比对前将配对读段合并成单条序列”。这从根本上改变了数据结构，使其与目标不兼容。合并读段将原始片段的两个不同末端合并成一个序列，使得识别两个独立的核酸酶切位点成为不可能，而这正是片段化分析的主要目标。\n2.  **片段坐标计算**：“计算片段长度$\\ell$为总比对长度；使用最外侧的软剪切位置定义末端坐标”。这是错误的合并步骤的直接后果，并且是不正确的。片段长度是外侧$5'$端之间的基因组距离，而不是合并序列的长度。软剪切位置不是片段末端的可靠标记。\n3.  **UMI合并**：“通过要求在$\\pm 5$个碱基的容差内具有相等的UMI和相等的$\\ell$来合并重复”。这是不充分的。它没有使用基因组坐标$\\{s,e\\}$，这意味着位于不同位置但恰好具有相同长度和UMI的两个不同片段将被错误地合并。\n4.  **末端上下文注释**：“使用包括软剪切部分的比对读段序列来注释末端上下文”。这是不正确的，因为它使用了读段数据而不是参考序列，并且更错误的是它使用了软剪切的碱基，而根据定义，这些碱基并未比对到参考序列上。\n\n**对C的结论**：该流程的起始步骤——合并配对读段——使其从根本上不适合所述目标。**不正确**。\n\n### D选项评估\n\n1.  **UMI处理**：“提取并剪切UMI；进行接头和质量剪切”。此步骤是正确的。\n2.  **比对与筛选**：“保留$20 \\le Q  30$的正确配对比对”。这个筛选标准是不合逻辑的。它特意选择中等比对质量的读段，而丢弃最高质量的读段（$Q \\ge 30$）。对于依赖坐标精度的分析，必须使用可用的最高置信度的比对，而不是排除它们。\n3.  **UMI合并**：“通过要求相同的UMI和在$\\delta = 10$个碱基容差内的$\\{s,e\\}$来合并重复”。虽然同时使用UMI和坐标是正确的原则，但$\\delta=10$个碱基的容差过大。如此大的窗口将导致错误地合并染色体上物理位置相近的不同分子，通过人为地移除短片段和降低文库复杂性估计来产生偏倚。\n4.  **末端上下文注释**：“使用参考序列注释末端上下文”。此步骤是正确的。\n\n**对D的结论**：尽管有一些正确的组成部分，但该流程由于不合逻辑的MAPQ过滤器和过于宽松的合并容差而存在严重缺陷，这两者都会引入显著的偏倚。**不正确**。\n\n基于以上分析，只有流程A代表了实现研究目标的完整、稳健且科学有效的方法。",
            "answer": "$$\\boxed{A}$$"
        },
        {
            "introduction": "无细胞DNA（cfDNA）分析中的一个常见任务是比较不同队列（例如癌症患者和健康对照组）之间的片段化模式。本练习提供了一个动手实践的机会，让你应用一种基本的非参数统计方法——Kolmogorov-Smirnov检验 ()。通过根据给定的短片段与长片段比率数据，你将亲自计算检验统计量，从而更深入地理解如何量化和检验分布层面的差异。",
            "id": "4322550",
            "problem": "在基因组诊断中的循环肿瘤脱氧核糖核酸（ctDNA）片段化分析中，一个常用的汇总特征是短片段与长片段的比率，对于每个血浆样本，该比率定义为在固定的碱基对窗口内测量的短片段计数与长片段计数的比值。假设对两个队列进行了分析：队列A（非恶性肿瘤对照组）和队列B（确诊实体瘤患者）。对于每个个体，使用相同的流程从其无细胞脱氧核糖核酸（cfDNA）片段大小直方图中计算短片段与长片段的比率。给你以下比率测量值：\n- 队列A，样本量 $n=10$：$0.58, 0.62, 0.66, 0.69, 0.73, 0.77, 0.81, 0.86, 0.92, 0.98$。\n- 队列B，样本量 $m=12$：$0.70, 0.74, 0.79, 0.83, 0.88, 0.93, 1.00, 1.05, 1.10, 1.15, 1.22, 1.30$。\n\n使用非参数分布比较的第一性原理，特别是经验累积分布函数（ECDF）的定义和双样本Kolmogorov–Smirnov（KS）检验，完成以下任务：\n- 根据样本构建经验累积分布函数 $F_{A}(x)$ 和 $F_{B}(x)$。\n- 计算双样本Kolmogorov–Smirnov统计量 $D=\\sup_{x}\\left|F_{A}(x)-F_{B}(x)\\right|$。\n- 使用双样本Kolmogorov分布的渐近形式，在显著性水平 $\\alpha=0.05$ 下评估是否存在证据表明两个队列的短片段与长片段比率的分布不同。用文字陈述你的结论。\n- 将Kolmogorov–Smirnov统计量 $D$ 视为效应量。报告该效应量。\n\n你最终报告的值必须是效应量 $D$。将最终答案四舍五入至四位有效数字。不需要单位。",
            "solution": "首先验证问题以确保其具有科学依据、问题明确且客观。\n\n**步骤1：提取已知条件**\n- **主题**：循环肿瘤DNA（ctDNA）片段化分析。\n- **度量**：短片段与长片段的比率。\n- **队列A（对照组）**：样本量 $n=10$。数据：$0.58, 0.62, 0.66, 0.69, 0.73, 0.77, 0.81, 0.86, 0.92, 0.98$。\n- **队列B（患者组）**：样本量 $m=12$。数据：$0.70, 0.74, 0.79, 0.83, 0.88, 0.93, 1.00, 1.05, 1.10, 1.15, 1.22, 1.30$。\n- **任务**：\n    1. 构建经验累积分布函数（ECDFs）$F_{A}(x)$ 和 $F_{B}(x)$。\n    2. 计算双样本Kolmogorov–Smirnov（KS）统计量 $D=\\sup_{x}\\left|F_{A}(x)-F_{B}(x)\\right|$。\n    3. 使用渐近KS分布，在 $\\alpha=0.05$ 的水平上评估是否存在统计学上的显著差异。\n    4. 将KS统计量 $D$ 作为效应量报告，并四舍五入至四位有效数字。\n\n**步骤2：使用提取的已知条件进行验证**\n- **科学依据**：该问题在基因组诊断学和生物统计学领域有充分的依据。ctDNA片段比率和Kolmogorov-Smirnov检验的使用是标准做法。\n- **问题的明确性**：该问题提供了所有必要的数据，并定义了一个具有唯一解的清晰计算任务。\n- **客观性**：问题陈述是客观的，不含主观论断。\n- **缺陷检查**：该问题没有违反任何无效标准。它在科学上是合理的，可形式化的，完整的，并且结构良好。\n\n**步骤3：判定与行动**\n- **判定**：问题有效。\n- **行动**：继续解答。\n\n**解**\n\n该问题要求使用双样本Kolmogorov-Smirnov（KS）检验来比较来自队列A和队列B的短片段与长片段比率的分布。\n\n**1. 经验累积分布函数（ECDFs）**\n\n设队列A的有序样本为 $x_{A,1}, x_{A,2}, \\dots, x_{A,n}$，其中 $n=10$；队列B的有序样本为 $x_{B,1}, x_{B,2}, \\dots, x_{B,m}$，其中 $m=12$。\n\n一个样本的ECDF定义为小于或等于给定值 $x$ 的样本点所占的比例。\n对于队列A，ECDF $F_A(x)$ 由下式给出：\n$$F_A(x) = \\frac{1}{n} \\sum_{i=1}^{n} I(x_{A,i} \\le x) = \\frac{1}{10} \\times (\\text{队列A中小于或等于 } x \\text{ 的观测值数量})$$\n其中 $I(\\cdot)$ 是指示函数。函数 $F_A(x)$ 是一个阶梯函数，从 $0$ 开始，在队列A的每个数据点处增加一个步长 $1/n = 1/10 = 0.1$，最终达到值 $1$。\n\n对于队列B，ECDF $F_B(x)$ 由下式给出：\n$$F_B(x) = \\frac{1}{m} \\sum_{j=1}^{m} I(x_{B,j} \\le x) = \\frac{1}{12} \\times (\\text{队列B中小于或等于 } x \\text{ 的观测值数量})$$\n函数 $F_B(x)$ 是一个阶梯函数，从 $0$ 开始，在队列B的每个数据点处增加一个步长 $1/m = 1/12$，最终达到值 $1$。\n\n**2. 双样本KS统计量 $D$ 的计算**\n\n双样本KS统计量 $D$ 是两个ECDF在所有可能的 $x$ 值上的最大绝对差：\n$$D = \\sup_{x} |F_A(x) - F_B(x)|$$\n两个阶梯函数之差的上确界必定出现在任一队列的某个观测数据点上。为了找到这个最大差值，我们将所有 $n+m=22$ 个唯一数据点合并并排序，然后在每个数据点及其左极限点处计算差值 $|F_A(x) - F_B(x)|$。\n\n设合并并排序后的观测值列表为 $z_1, z_2, \\dots, z_{22}$。我们对所有 $k \\in \\{1, \\dots, 22\\}$ 计算 $|F_A(z_k) - F_B(z_k)|$ 和 $|F_A(z_k^-) - F_B(z_k^-)|$，其中 $z_k^-$ 表示一个恰好小于 $z_k$ 的值。对于 $k>1$，后者等价于 $|F_A(z_{k-1}) - F_B(z_{k-1})|$。\n\n计算过程通过遍历排序后的合并数据列表进行：\n$0.58, 0.62, 0.66, 0.69, 0.70, 0.73, 0.74, 0.77, 0.79, 0.81, 0.83, 0.86, 0.88, 0.92, 0.93, 0.98, 1.00, 1.05, 1.10, 1.15, 1.22, 1.30$。\n\n最大差值是通过系统地计算在这些数据点定义的区间边界上的 $|F_A(x) - F_B(x)|$ 值来找到的。\n- 在 $x  0.58$ 时，$F_A(x)=0$ 且 $F_B(x)=0$，所以差值为 $0$。\n- 在 $x=0.69$ 时，$F_A(0.69) = 4/10 = 0.4$ 且 $F_B(0.69)=0$，得出差值为 $|0.4-0.0|=0.4$。\n- 在 $x=0.70$ 左极限点，$F_A(0.70^-) = 4/10 = 0.4$ 且 $F_B(0.70^-)=0$，所以差值仍为 $0.4$。\n- 在 $x=0.73$ 时，$F_A(0.73) = 5/10=0.5$ 且 $F_B(0.73) = 1/12 \\approx 0.0833$，得出差值为 $|0.5 - 1/12| = 5/12 \\approx 0.4167$。\n- 在队列A的最后一个观测值 $x=0.98$ 之前，我们在 $x = 0.93$ 处评估差值。此时，$F_A(0.93)=9/10=0.9$ 且 $F_B(0.93)=6/12=0.5$，差值为 $|0.9-0.5|=0.4$。\n- 在 $x=0.98$ 时，$F_A(0.98) = 10/10 = 1.0$ 且 $F_B(0.98)=6/12=0.5$。差值为 $|1.0 - 0.5| = 0.5$。\n- 在 $x=1.00$ 左极限点，ECDF的值为 $F_A(1.00^-) = F_A(0.98) = 1.0$ 且 $F_B(1.00^-) = F_B(0.98) = 0.5$。差值为 $|1.0-0.5|=0.5$。\n- 在 $x=1.00$ 时，$F_A(1.00)=1.0$ 且 $F_B(1.00) = 7/12 \\approx 0.5833$。差值为 $|1.0 - 7/12| = 5/12 \\approx 0.4167$。\n\n在评估了所有数据点的差值后，发现最大差值为 $0.5$。\n$$D = 0.5$$\n\n**3. 在 $\\alpha=0.05$ 下的假设检验**\n\n我们检验以下假设：\n- 原假设，$H_0$：两个样本来自相同的潜在连续分布。\n- 备择假设，$H_1$：两个样本来自不同的分布。\n\n问题指定使用KS统计量分布的渐近形式。将检验统计量与一个临界值 $D_{crit}$ 进行比较，该临界值取决于显著性水平 $\\alpha$ 以及样本量 $n$ 和 $m$。如果观测到的统计量 $D$ 大于 $D_{crit}$，我们就拒绝 $H_0$。\n临界值由以下公式给出：\n$$D_{crit} = c(\\alpha) \\sqrt{\\frac{n+m}{nm}}$$\n其中 $c(\\alpha)$ 是从极限Kolmogorov分布导出的一个常数。对于显著性水平 $\\alpha=0.05$，标准值为 $c(0.05) \\approx 1.3581$。\n\n使用给定的样本量 $n=10$ 和 $m=12$：\n$$D_{crit} \\approx 1.3581 \\sqrt{\\frac{10+12}{10 \\times 12}} = 1.3581 \\sqrt{\\frac{22}{120}} = 1.3581 \\sqrt{0.18333...}$$\n$$D_{crit} \\approx 1.3581 \\times 0.42817 = 0.5816$$\n我们将计算出的统计量 $D=0.5$ 与此临界值进行比较：\n$$D = 0.5  D_{crit} \\approx 0.5816$$\n由于观测到的KS统计量小于临界值，我们在 $\\alpha=0.05$ 的显著性水平上未能拒绝原假设。\n\n**结论**：基于Kolmogorov-Smirnov检验，在 $5\\%$ 的显著性水平上，没有足够的统计证据得出结论，认为非恶性肿瘤对照组队列和实体瘤患者队列的短片段与长片段比率的分布是不同的。\n\n**4. 效应量**\n\n问题要求将Kolmogorov-Smirnov统计量 $D$ 视为效应量。\n计算出的效应量为 $D=0.5$。四舍五入到四位有效数字得到 $0.5000$。",
            "answer": "$$\n\\boxed{0.5000}\n$$"
        },
        {
            "introduction": "本练习将引导你超越简单的汇总统计，进入复杂的建模领域，利用启动子区域的核小体足迹来推断cfDNA的组织来源。这项高级实践要求你实现一个带正则化的非负最小二乘算法，以将混合信号分解为其组成组织的贡献 ()。这个练习旨在连接理论模型与实际编程实现，这是计算基因组学中的一项关键技能。",
            "id": "4322534",
            "problem": "给定一个在精准医疗和基因组诊断学领域内，基于循环肿瘤脱氧核糖核酸 (ctDNA) 片段化分析的来源组织推断问题的形式化描述。在血浆中，游离脱氧核糖核酸 (cfDNA) 的片段化模式反映了核小体的占据情况，而 cfDNA 中的启动子足迹与组织特异性的转录活性相关。在 cfDNA 来源的混合模型下，来自样本的启动子足迹向量可以被建模为跨启动子的组织特异性核小体占据图谱的非负线性组合。\n\n从以下基本要素开始：\n- 观测基础：启动子周围的 cfDNA 片段末端密度受核小体占据和转录活性的调节。\n- 线性混合建模：一个 cfDNA 样本是来自不同组织的贡献的混合物。\n- 组织分数的非负性以及混合物的组分性质。\n\n形式上，假设有 $K$ 个组织和 $P$ 个启动子。定义：\n- $X \\in \\mathbb{R}^{P \\times K}$ 是组织特异性、表达衍生的核小体图谱矩阵，其中第 $k$ 列编码了组织 $k$ 在 $P$ 个启动子上的预期启动子足迹。\n- $f \\in \\mathbb{R}^{P}$ 是从样本中观测到的 cfDNA 启动子足迹向量（每个启动子的片段末端密度，假定为非负）。\n- $w \\in \\mathbb{R}_{\\ge 0}^{P}$ 是每个启动子的非负可靠性权重（例如，逆方差权重、核小体可比对性权重或启动子置信度权重）。\n- $b \\in \\mathbb{R}_{\\ge 0}^{K}$ 是未知的非负组织混合系数，代表来源组织分数。\n- $\\lambda \\in \\mathbb{R}_{\\ge 0}$ 是一个正则化参数，用于在共线性情况下稳定估计。\n\n假设一个线性观测模型 $f \\approx X b + \\varepsilon$，并采用加权、正则化的非负最小二乘法原理：通过最小化目标函数来推断 $b$\n$$\nJ(b) \\;=\\; \\left\\| W \\left(f - X b \\right) \\right\\|_2^2 \\;+\\; \\lambda \\left\\| b \\right\\|_2^2\n$$\n约束条件为 $b \\ge 0$，其中 $W = \\mathrm{diag}(w) \\in \\mathbb{R}^{P \\times P}$ 是权重的对角矩阵。在获得最小化子 $\\hat{b}$ 后，通过以下方式将其归一化以获得组成分数 $\\tilde{b}$\n$$\n\\tilde{b}_k \\;=\\; \n\\begin{cases}\n\\frac{\\hat{b}_k}{\\sum_{j=1}^{K} \\hat{b}_j},  \\text{如果 } \\sum_{j=1}^{K} \\hat{b}_j > 0, \\\\\n0,  \\text{其他情况},\n\\end{cases}\n$$\n对于 $k \\in \\{1,\\dots,K\\}$。\n\n实现一个算法，该算法：\n1. 用 $w$ 缩放 $X$ 和 $f$ 的行（即，构成 $X' = W X$ 和 $f' = W f$）。\n2. 通过使用 $\\sqrt{\\lambda} I_K$ 增广系统来引入吉洪诺夫正则化，其中 $I_K \\in \\mathbb{R}^{K \\times K}$ 是单位矩阵，产生一个增广最小二乘问题：\n$$\n\\min_{b \\ge 0} \\left\\| \\begin{bmatrix} X' \\\\ \\sqrt{\\lambda} I_K \\end{bmatrix} b - \\begin{bmatrix} f' \\\\ 0_K \\end{bmatrix} \\right\\|_2^2,\n$$\n其中 $0_K \\in \\mathbb{R}^{K}$ 是零向量。\n3. 求解非负最小二乘问题以获得 $\\hat{b}$。\n4. 如上文定义，将 $\\hat{b}$ 归一化为 $\\tilde{b}$。\n\n设计一个程序，对以下每个测试用例执行此算法。为保证可复现性，所有数值矩阵和向量都已精确指定。\n\n测试用例 1（一般情况，信息性权重，中度正则化）：\n- $P = 5$, $K = 3$。\n- 数据：\n$$\nX \\;=\\; \n\\begin{bmatrix}\n0.8  0.1  0.2 \\\\\n1.0  0.2  0.3 \\\\\n0.2  0.9  0.1 \\\\\n0.0  0.7  0.9 \\\\\n0.6  0.3  0.4\n\\end{bmatrix}, \\quad\nf \\;=\\;\n\\begin{bmatrix}\n0.55 \\\\ 0.68 \\\\ 0.40 \\\\ 0.31 \\\\ 0.47\n\\end{bmatrix}, \\quad\nw \\;=\\;\n\\begin{bmatrix}\n1.0 \\\\ 0.8 \\\\ 1.2 \\\\ 1.0 \\\\ 0.9\n\\end{bmatrix}, \\quad\n\\lambda \\;=\\; 0.05.\n$$\n\n测试用例 2（两个组织之间高度共线性，均匀权重，强正则化）：\n- $P = 5$, $K = 3$。\n- 数据：\n$$\nX \\;=\\;\n\\begin{bmatrix}\n0.4  0.39  0.10 \\\\\n0.6  0.59  0.20 \\\\\n0.8  0.79  0.30 \\\\\n0.5  0.49  0.40 \\\\\n0.7  0.69  0.50\n\\end{bmatrix}, \\quad\nf \\;=\\;\n\\begin{bmatrix}\n0.400 \\\\ 0.592 \\\\ 0.799 \\\\ 0.495 \\\\ 0.693\n\\end{bmatrix}, \\quad\nw \\;=\\;\n\\begin{bmatrix}\n1.0 \\\\ 1.0 \\\\ 1.0 \\\\ 1.0 \\\\ 1.0\n\\end{bmatrix}, \\quad\n\\lambda \\;=\\; 0.10.\n$$\n\n测试用例 3（零信号的边界情况，异构权重，最小正则化）：\n- $P = 4$, $K = 2$。\n- 数据：\n$$\nX \\;=\\;\n\\begin{bmatrix}\n0.2  0.8 \\\\\n0.3  0.7 \\\\\n0.5  0.5 \\\\\n0.9  0.1\n\\end{bmatrix}, \\quad\nf \\;=\\;\n\\begin{bmatrix}\n0.0 \\\\ 0.0 \\\\ 0.0 \\\\ 0.0\n\\end{bmatrix}, \\quad\nw \\;=\\;\n\\begin{bmatrix}\n1.0 \\\\ 0.5 \\\\ 0.8 \\\\ 0.6\n\\end{bmatrix}, \\quad\n\\lambda \\;=\\; 0.01.\n$$\n\n您的程序必须实现上述算法，并为每个测试用例生成归一化的组织分数向量 $\\tilde{b}$。要求的最终输出格式是包含一个列表的列表的单行，其中每个内部列表是一个测试用例的结果，每个浮点数必须四舍五入到 $6$ 位小数。例如，输出格式的形式为\n$$\n\\left[ \\left[ \\tilde{b}^{(1)}_1, \\dots, \\tilde{b}^{(1)}_{K_1} \\right], \\left[ \\tilde{b}^{(2)}_1, \\dots, \\tilde{b}^{(2)}_{K_2} \\right], \\left[ \\tilde{b}^{(3)}_1, \\dots, \\tilde{b}^{(3)}_{K_3} \\right] \\right],\n$$\n以单行形式打印，使用十进制表示法。不涉及物理单位或角度；所有输出均为无量纲小数。",
            "solution": "该问题要求实现一种算法，以从循环肿瘤 DNA (ctDNA) 片段化模式中推断来源组织的混合分数。该问题被构建为一个带吉洪诺夫正则化的非负最小二乘 (NNLS) 优化问题。验证和求解过程将按以下步骤进行。\n\n### 问题验证\n\n#### 步骤 1：提取给定信息\n\n问题由一个数学模型和一个求解该模型的算法定义，并应用于三个具体的测试用例。\n\n**模型与目标函数：**\n- 设 $K$ 为组织数量，$P$ 为启动子数量。\n- $X \\in \\mathbb{R}^{P \\times K}$：组织特异性启动子足迹矩阵。\n- $f \\in \\mathbb{R}^{P}$：从样本中观测到的 cfDNA 启动子足迹向量。\n- $w \\in \\mathbb{R}_{\\ge 0}^{P}$：每个启动子的非负可靠性权重。\n- $b \\in \\mathbb{R}_{\\ge 0}^{K}$：未知的非负组织混合系数。\n- $\\lambda \\in \\mathbb{R}_{\\ge 0}$：正则化参数。\n系数 $b$ 将通过最小化以下目标函数来推断：\n$$\nJ(b) \\;=\\; \\left\\| W \\left(f - X b \\right) \\right\\|_2^2 \\;+\\; \\lambda \\left\\| b \\right\\|_2^2\n$$\n约束条件为 $b \\ge 0$，其中 $W = \\mathrm{diag}(w)$。\n\n**解的归一化：**\n找到最小化子 $\\hat{b}$ 后，将其归一化为组成分数 $\\tilde{b}$：\n$$\n\\tilde{b}_k \\;=\\; \n\\begin{cases}\n\\frac{\\hat{b}_k}{\\sum_{j=1}^{K} \\hat{b}_j},  \\text{如果 } \\sum_{j=1}^{K} \\hat{b}_j > 0, \\\\\n0,  \\text{其他情况}。\n\\end{cases}\n$$\n\n**算法：**\n1.  缩放数据矩阵：$X' = W X$ 和 $f' = W f$。\n2.  构建一个增广最小二乘问题：\n    $$\n    \\min_{b \\ge 0} \\left\\| \\begin{bmatrix} X' \\\\ \\sqrt{\\lambda} I_K \\end{bmatrix} b - \\begin{bmatrix} f' \\\\ 0_K \\end{bmatrix} \\right\\|_2^2\n    $$\n    其中 $I_K$ 是 $K \\times K$ 单位矩阵，$0_K$ 是 $K \\times 1$ 零向量。\n3.  求解得到的非负最小二乘问题，得到 $\\hat{b}$。\n4.  将 $\\hat{b}$ 归一化以获得 $\\tilde{b}$。\n\n**测试用例：**\n\n- **测试用例 1：** $P = 5, K = 3, \\lambda = 0.05$。\n  $$\n  X = \\begin{bmatrix} 0.8  0.1  0.2 \\\\ 1.0  0.2  0.3 \\\\ 0.2  0.9  0.1 \\\\ 0.0  0.7  0.9 \\\\ 0.6  0.3  0.4 \\end{bmatrix}, \\ f = \\begin{bmatrix} 0.55 \\\\ 0.68 \\\\ 0.40 \\\\ 0.31 \\\\ 0.47 \\end{bmatrix}, \\ w = \\begin{bmatrix} 1.0 \\\\ 0.8 \\\\ 1.2 \\\\ 1.0 \\\\ 0.9 \\end{bmatrix}\n  $$\n- **测试用例 2：** $P = 5, K = 3, \\lambda = 0.10$。\n  $$\n  X = \\begin{bmatrix} 0.4  0.39  0.10 \\\\ 0.6  0.59  0.20 \\\\ 0.8  0.79  0.30 \\\\ 0.5  0.49  0.40 \\\\ 0.7  0.69  0.50 \\end{bmatrix}, \\ f = \\begin{bmatrix} 0.400 \\\\ 0.592 \\\\ 0.799 \\\\ 0.495 \\\\ 0.693 \\end{bmatrix}, \\ w = \\begin{bmatrix} 1.0 \\\\ 1.0 \\\\ 1.0 \\\\ 1.0 \\\\ 1.0 \\end{bmatrix}\n  $$\n- **测试用例 3：** $P = 4, K = 2, \\lambda = 0.01$。\n  $$\n  X = \\begin{bmatrix} 0.2  0.8 \\\\ 0.3  0.7 \\\\ 0.5  0.5 \\\\ 0.9  0.1 \\end{bmatrix}, \\ f = \\begin{bmatrix} 0.0 \\\\ 0.0 \\\\ 0.0 \\\\ 0.0 \\end{bmatrix}, \\ w = \\begin{bmatrix} 1.0 \\\\ 0.5 \\\\ 0.8 \\\\ 0.6 \\end{bmatrix}\n  $$\n\n#### 步骤 2：使用提取的给定信息进行验证\n\n- **科学依据：** 该问题明确地位于计算生物学和精准医疗领域。线性混合模型是解决像组织来源推断这类反卷积问题的标准且适当的选择。其根本的生物学前提——即启动子周围的 cfDNA 片段化模式具有组织特异性——是基于已有的研究。使用加权最小二乘法来考虑测量可靠性，以及使用吉洪诺夫正则化来处理共线性，是数值分析和统计建模中的经典方法。非负性约束是物理上的必然要求。该问题在科学上是合理的。\n- **适定性：** 目标函数 $J(b)$ 是两个平方范数之和，当 $\\lambda > 0$ 时，它是一个严格凸函数。约束集 $b \\ge 0$ 是一个凸集。在凸集上最小化一个严格凸函数是一个适定问题，保证存在唯一的最小值。所提供的算法正确地将目标函数转换为标准的非负最小二乘形式，对此存在高效且稳定的求解器。\n- **客观性：** 问题陈述是形式化和数学化的，所有变量、常数和数据都得到了精确无歧义的定义。\n- **缺陷检查清单：** 该问题没有缺陷。它不是科学上不合理、不可形式化、不完整、自相矛盾、不切实际、不适定或无聊的。所有数据和维度都是一致的。\n\n#### 步骤 3：结论与行动\n\n问题是有效的。将遵循指定的算法来开发解决方案。\n\n### 求解推导与算法设计\n\n核心任务是求解以下约束优化问题：\n$$\n\\min_{b \\ge 0} J(b) \\quad \\text{其中} \\quad J(b) = \\left\\| W(f - Xb) \\right\\|_2^2 + \\lambda \\left\\| b \\right\\|_2^2\n$$\n\n我们将遵循规定的算法步骤来求解未知的系数向量 $b$。\n\n**步骤 1：加权变换**\n目标函数的首项是残差平方的加权和。设 $w$ 为权重向量。矩阵 $W = \\mathrm{diag}(w)$ 是一个对角线上为权重的对角矩阵。通过用 $w$ 中的相应权重缩放 $f$ 和 $X$ 的行，可以简化此项。我们定义：\n- $f' = Wf$\n- $X' = WX$\n在计算上，如果 $f$ 是一个列向量，$X$ 是一个矩阵，这等同于将每一行与相应的权重进行逐元素相乘。具体来说，对于第 $i$ 行，$f'_i = w_i f_i$，而 $X'$ 的第 $i$ 行是 $w_i$ 乘以 $X$ 的第 $i$ 行。\n有了这些新变量，目标函数的首项变为：\n$$\n\\left\\| W(f - Xb) \\right\\|_2^2 = \\left\\| Wf - WXb \\right\\|_2^2 = \\left\\| f' - X'b \\right\\|_2^2\n$$\n这现在是一个标准的、无权重的最小二乘项。\n\n**步骤 2：正则化与系统增广**\n目标函数现在是 $J(b) = \\| f' - X'b \\|_2^2 + \\lambda \\| b \\|_2^2$。第二项，即吉洪诺夫正则化惩罚项，也可以表示为一个欧几里得范数的平方：\n$$\n\\lambda \\|b\\|_2^2 = \\left(\\sqrt{\\lambda}\\right)^2 \\sum_{k=1}^K b_k^2 = \\sum_{k=1}^K \\left(\\sqrt{\\lambda} b_k\\right)^2 = \\left\\| \\sqrt{\\lambda} b \\right\\|_2^2 = \\left\\| \\sqrt{\\lambda}I_K b \\right\\|_2^2\n$$\n其中 $I_K$ 是 $K \\times K$ 单位矩阵。我们可以将其写为 $\\| 0_K - \\sqrt{\\lambda}I_K b \\|_2^2$，其中 $0_K$ 是长度为 $K$ 的零向量。\n整个目标函数现在可以表示为两个平方范数之和：\n$$\nJ(b) = \\| f' - X'b \\|_2^2 + \\| 0_K - \\sqrt{\\lambda}I_K b \\|_2^2\n$$\n欧几里得范数的一个关键性质是，两个向量的平方范数之和等于它们串联后向量的平方范数。因此，我们可以构建一个增广线性系统。设：\n$$\nA_{\\text{aug}} = \\begin{bmatrix} X' \\\\ \\sqrt{\\lambda} I_K \\end{bmatrix} \\in \\mathbb{R}^{(P+K) \\times K} \\quad \\text{和} \\quad y_{\\text{aug}} = \\begin{bmatrix} f' \\\\ 0_K \\end{bmatrix} \\in \\mathbb{R}^{(P+K)}\n$$\n目标函数则等价于此增广系统残差的平方范数：\n$$\nJ(b) = \\left\\| y_{\\text{aug}} - A_{\\text{aug}} b \\right\\|_2^2\n$$\n原始问题已被转换为一个标准的非负最小二乘问题：$\\min_{b \\ge 0} \\| y_{\\text{aug}} - A_{\\text{aug}} b \\|_2^2$。\n\n**步骤 3：求解非负最小二乘 (NNLS) 问题**\n这种标准形式可以使用已有的数值算法高效求解，例如由 Lawson 和 Hanson 开发的活动集方法。`scipy.optimize.nnls` 函数提供了该算法的实现。它以矩阵 $A_{\\text{aug}}$ 和向量 $y_{\\text{aug}}$ 作为输入，并返回在 $\\hat{b} \\ge 0$ 约束下使范数最小化的解向量 $\\hat{b}$。\n\n**步骤 4：归一化**\n向量 $\\hat{b}$ 包含了解正则化系统的最优非负系数。这些系数代表了每种组织的相对贡献。为了将它们解释为一个整体的组分部分，它们必须被归一化以使总和为 1。我们计算总和 $S = \\sum_{j=1}^{K} \\hat{b}_j$。\n- 如果 $S > 0$，则归一化分数为 $\\tilde{b}_k = \\hat{b}_k / S$，对于每个 $k=1, \\dots, K$。\n- 如果 $S = 0$（仅当 $\\hat{b}$ 是零向量时发生），这意味着没有检测到任何组织贡献（例如，零信号或信号与所有组织谱图正交）。在这种情况下，所有的分数贡献都设为零，因此对所有 $k$ 都有 $\\tilde{b}_k = 0$。\n\n至此，算法完成。该实现将系统地将这四个步骤应用于每个提供的测试用例。对于测试用例3，其中 $f$ 是零向量，我们预期 $J(b)=\\|WXb\\|_2^2 + \\lambda\\|b\\|_2^2$ 的最小化子是 $b=0$，因为 $\\lambda > 0$ 并且矩阵 $WX$ 具有非负项。因此，我们预计 $\\hat{b}=0$，从而 $\\tilde{b}=0$。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import nnls\n\ndef solve():\n    \"\"\"\n    Solves the tissue-of-origin inference problem for three test cases using\n    a regularized, weighted, non-negative least-squares algorithm.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    test_cases = [\n        {\n            \"P\": 5, \"K\": 3, \"lambda\": 0.05,\n            \"X\": np.array([\n                [0.8, 0.1, 0.2],\n                [1.0, 0.2, 0.3],\n                [0.2, 0.9, 0.1],\n                [0.0, 0.7, 0.9],\n                [0.6, 0.3, 0.4]\n            ]),\n            \"f\": np.array([0.55, 0.68, 0.40, 0.31, 0.47]),\n            \"w\": np.array([1.0, 0.8, 1.2, 1.0, 0.9])\n        },\n        {\n            \"P\": 5, \"K\": 3, \"lambda\": 0.10,\n            \"X\": np.array([\n                [0.4, 0.39, 0.10],\n                [0.6, 0.59, 0.20],\n                [0.8, 0.79, 0.30],\n                [0.5, 0.49, 0.40],\n                [0.7, 0.69, 0.50]\n            ]),\n            \"f\": np.array([0.400, 0.592, 0.799, 0.495, 0.693]),\n            \"w\": np.array([1.0, 1.0, 1.0, 1.0, 1.0])\n        },\n        {\n            \"P\": 4, \"K\": 2, \"lambda\": 0.01,\n            \"X\": np.array([\n                [0.2, 0.8],\n                [0.3, 0.7],\n                [0.5, 0.5],\n                [0.9, 0.1]\n            ]),\n            \"f\": np.array([0.0, 0.0, 0.0, 0.0]),\n            \"w\": np.array([1.0, 0.5, 0.8, 0.6])\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        X = case[\"X\"]\n        f = case[\"f\"]\n        w = case[\"w\"]\n        lambda_reg = case[\"lambda\"]\n        K = case[\"K\"]\n        P = case[\"P\"]\n\n        # Step 1: Scale rows of X and f by weights w.\n        # W is a diagonal matrix, so WX and Wf are equivalent to scaling\n        # each row of X and f by the corresponding element of w.\n        # In numpy, this is efficiently done using broadcasting.\n        # w[:, np.newaxis] reshapes w from (P,) to (P, 1) for broadcasting.\n        X_prime = X * w[:, np.newaxis]\n        f_prime = f * w\n\n        # Step 2: Incorporate Tikhonov regularization by augmenting the system.\n        # The objective min ||W(f-Xb)||^2 + lambda*||b||^2 is equivalent to\n        # min || [X']b - [f'] ||^2\n        #      || [sqrt(lambda)I]  [0] ||\n        # over b = 0.\n\n        # Create the augmented matrix A_aug of size (P+K) x K.\n        sqrt_lambda_I = np.sqrt(lambda_reg) * np.eye(K)\n        A_aug = np.vstack((X_prime, sqrt_lambda_I))\n\n        # Create the augmented vector y_aug of size (P+K).\n        zeros_K = np.zeros(K)\n        y_aug = np.concatenate((f_prime, zeros_K))\n\n        # Step 3: Solve the non-negative least-squares problem.\n        # nnls finds b_hat that minimizes ||A_aug * b - y_aug|| subject to b = 0.\n        b_hat, _ = nnls(A_aug, y_aug)\n\n        # Step 4: Normalize b_hat to obtain compositional fractions b_tilde.\n        b_hat_sum = np.sum(b_hat)\n        \n        if b_hat_sum > 0:\n            b_tilde = b_hat / b_hat_sum\n        else:\n            b_tilde = np.zeros_like(b_hat)\n        \n        all_results.append(b_tilde)\n\n    # Format the final output string as specified.\n    # Each float must be represented with 6 decimal places.\n    formatted_results = []\n    for res_array in all_results:\n        string_list = [f\"{x:.6f}\" for x in res_array]\n        formatted_results.append(f\"[{','.join(string_list)}]\")\n    \n    final_output_string = f\"[{','.join(formatted_results)}]\"\n    \n    # Final print statement in the exact required format.\n    print(final_output_string)\n\nsolve()\n```"
        }
    ]
}