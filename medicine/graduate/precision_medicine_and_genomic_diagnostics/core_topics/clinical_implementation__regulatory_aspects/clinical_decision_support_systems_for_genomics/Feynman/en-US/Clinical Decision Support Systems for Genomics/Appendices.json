{
    "hands_on_practices": [
        {
            "introduction": "A clinical decision support system is fundamentally reliant on the quality of its input data. In genomics, this means distinguishing true genetic variants from background sequencing errors. This first practice exercise takes you under the hood of a variant quality control pipeline, demonstrating how Bayesian reasoning is used to synthesize multiple quality metrics—such as read depth, base quality, and strand bias—into a single, robust posterior quality score. By calculating this score yourself, you will gain a foundational understanding of the probabilistic nature of variant calling and the basis for filtering decisions in a clinical workflow. ",
            "id": "4324283",
            "problem": "A Clinical Decision Support (CDS) pipeline for genomics integrates read-level Quality Control (QC) evidence to produce a posterior variant quality score that guides filtering in a precision medicine workflow. Consider a Single Nucleotide Variant (SNV) candidate at a locus in a clinical gene panel. The sequencing metrics at this locus are: total read depth $n=12$, with $k=6$ reads supporting the alternate allele; mean base quality across the alternate-supporting reads $Q_{b}=25$; and a two-sided strand bias $p$-value $p_{\\mathrm{sb}}=0.01$ computed under the null of no strand bias using Fisher’s exact test. Assume a per-locus prior probability of a true variant $P(H_{1})=10^{-4}$ and its complement $P(H_{0})=1-P(H_{1})$. \n\nModel the evidence using two hypotheses: $H_{1}$ (true heterozygous variant with no intrinsic strand bias) and $H_{0}$ (no true variant; observed alternate-supporting reads arise from sequencing error). Use the following foundational bases and assumptions:\n\n1. Bayes’ theorem for posterior odds and probabilities.\n2. The definition of the Phred transform for a probability $p$: $Q=-10\\log_{10}(p)$.\n3. Independent per-read base-calling errors with per-read error probability $\\varepsilon = 10^{-Q_{b}/10}$.\n4. Under $H_{1}$ for a heterozygous SNV without strand bias, the per-read probability of an alternate call is approximately $p_{\\text{alt}|H_{1}}=\\frac{1}{2}$; thus the count $k$ of alternate-supporting reads among $n$ follows a binomial distribution with $p=\\frac{1}{2}$. \n5. Under $H_{0}$, the per-read probability of an alternate call equals the base error probability $\\varepsilon$, and the count $k$ follows a binomial distribution with $p=\\varepsilon$.\n6. Treat the observed strand bias $p$-value as multiplicative evidence against $H_{1}$ via the factor $p_{\\mathrm{sb}}$ in the Bayes factor; under $H_{0}$, do not penalize with $p_{\\mathrm{sb}}$.\n\nStarting from these bases, derive the posterior probability $P(H_{1}\\mid D)$ given the data $D=\\{n=12,\\;k=6,\\;Q_{b}=25,\\;p_{\\mathrm{sb}}=0.01\\}$ and compute the posterior Phred quality score\n$$\nQ_{\\text{post}}=-10\\log_{10}\\!\\big(1-P(H_{1}\\mid D)\\big).\n$$\nAdditionally, impose a posterior false call constraint $\\theta=10^{-4}$ and determine the implied Phred decision threshold $Q_{\\text{th}}=-10\\log_{10}(\\theta)$. State whether the candidate passes or fails relative to $Q_{\\text{th}}$.\n\nRound your computed $Q_{\\text{post}}$ to four significant figures. Express $Q_{\\text{post}}$ in Phred units. For the pass/fail decision, describe your reasoning, but only report the numerical value of $Q_{\\text{post}}$ as your final answer.",
            "solution": "The problem is to calculate the posterior probability of a single nucleotide variant (SNV) being a true variant, given a set of sequencing data, and to determine if this variant passes a quality threshold. The problem is scientifically grounded in Bayesian statistics and standard models used in genomics. It is well-posed, with all necessary parameters and models explicitly defined. Therefore, the problem is valid and a solution can be derived.\n\nThe core of the analysis rests on Bayes' theorem, which is most conveniently expressed in terms of odds. The posterior odds of hypothesis $H_{1}$ (true variant) versus hypothesis $H_{0}$ (sequencing error) given the data $D$ is the product of the prior odds and the Bayes Factor (BF):\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\frac{P(H_{1})}{P(H_{0})} \\times \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})}\n$$\nThe data $D$ consists of the total read depth $n=12$, the number of reads supporting the alternate allele $k=6$, the mean base quality of alternate reads $Q_{b}=25$, and the strand bias $p$-value $p_{\\mathrm{sb}}=0.01$.\n\nFirst, we establish the prior odds. Given the prior probability of a true variant $P(H_{1})=10^{-4}$, the prior probability of no true variant is $P(H_{0})=1-P(H_{1})=1-10^{-4}=0.9999$. The prior odds are:\n$$\n\\frac{P(H_{1})}{P(H_{0})} = \\frac{10^{-4}}{1-10^{-4}} = \\frac{10^{-4}}{0.9999}\n$$\n\nNext, we formulate the Bayes Factor, which is the ratio of the likelihoods of observing the data under the two competing hypotheses, $\\text{BF} = P(D\\mid H_{1}) / P(D\\mid H_{0})$. The problem specifies how to model the likelihoods based on the different pieces of evidence.\n\nThe base-calling error probability, $\\varepsilon$, is derived from the Phred-scaled base quality $Q_{b}=25$:\n$$\n\\varepsilon = 10^{-Q_{b}/10} = 10^{-25/10} = 10^{-2.5}\n$$\nThe likelihood of observing $k$ alternate-supporting reads out of a total of $n$ reads is modeled by a binomial distribution, $P(k|n, p) = \\binom{n}{k}p^{k}(1-p)^{n-k}$.\nUnder $H_{1}$ (true heterozygous variant), the probability of observing an alternate allele is $p = \\frac{1}{2}$.\n$$\nP(k=6 \\mid n=12, H_{1}) = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{6} \\left(1-\\frac{1}{2}\\right)^{12-6} = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12}\n$$\nUnder $H_{0}$ (sequencing error), the probability of observing an alternate allele is the error rate $p = \\varepsilon$.\n$$\nP(k=6 \\mid n=12, H_{0}) = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{12-6} = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}\n$$\nThe problem states that the strand bias $p$-value, $p_{\\mathrm{sb}}$, is to be treated as a multiplicative penalty against the likelihood of $H_{1}$, while $H_{0}$ is not penalized. This implies that the total likelihood for $H_{1}$ is $P(D\\mid H_{1}) = P(k|n, H_1) \\times p_{\\mathrm{sb}}$, and for $H_{0}$ is $P(D\\mid H_{0}) = P(k|n, H_0) \\times 1$.\n\nThe Bayes Factor is therefore:\n$$\n\\text{BF} = \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})} = \\frac{\\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}} = \\frac{\\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\varepsilon^{6} (1-\\varepsilon)^{6}}\n$$\nSubstituting the known values $p_{\\mathrm{sb}}=0.01=10^{-2}$ and $\\varepsilon=10^{-2.5}$:\n$$\n\\text{BF} = \\frac{(0.5)^{12} \\times 10^{-2}}{\\left(10^{-2.5}\\right)^{6} (1-10^{-2.5})^{6}} = \\frac{2^{-12} \\times 10^{-2}}{10^{-15} (1-10^{-2.5})^{6}} = \\frac{10^{13}}{2^{12} (1-10^{-2.5})^{6}}\n$$\nWe calculate the numerical value: $2^{12} = 4096$.\n$$\n\\text{BF} = \\frac{10^{13}}{4096 \\times (1-10^{-2.5})^{6}} \\approx \\frac{10^{13}}{4096 \\times (0.9968377)^{6}} \\approx \\frac{10^{13}}{4096 \\times 0.981190} \\approx \\frac{10^{13}}{4018.956} \\approx 2.488206 \\times 10^{9}\n$$\nNow, we compute the posterior odds:\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\left(\\frac{10^{-4}}{0.9999}\\right) \\times (2.488206 \\times 10^{9}) \\approx 248845.5\n$$\nThe posterior probability of $H_{1}$ is related to the posterior odds $O_{\\text{post}}$ by $P(H_{1}\\mid D) = O_{\\text{post}} / (1 + O_{\\text{post}})$. The quantity needed for the Phred score is the posterior probability of error, which is $P(H_{0}\\mid D) = 1 - P(H_{1}\\mid D) = 1 / (1 + O_{\\text{post}})$.\n$$\n1 - P(H_{1}\\mid D) = \\frac{1}{1 + 248845.5} = \\frac{1}{248846.5} \\approx 4.01854 \\times 10^{-6}\n$$\nThe posterior Phred quality score $Q_{\\text{post}}$ is defined as:\n$$\nQ_{\\text{post}} = -10\\log_{10}(1 - P(H_{1}\\mid D))\n$$\n$$\nQ_{\\text{post}} = -10\\log_{10}(4.01854 \\times 10^{-6}) = -10(\\log_{10}(4.01854) - 6) \\approx -10(0.604067 - 6) = -10(-5.395933) \\approx 53.95933\n$$\nRounding to four significant figures, we get $Q_{\\text post} = 53.96$.\n\nFinally, we must determine if the candidate passes or fails. The posterior false call constraint is $\\theta=10^{-4}$. The corresponding Phred decision threshold $Q_{\\text{th}}$ is:\n$$\nQ_{\\text{th}} = -10\\log_{10}(\\theta) = -10\\log_{10}(10^{-4}) = -10(-4) = 40\n$$\nThe decision rule is to pass the candidate if its quality score is greater than or equal to the threshold. We compare our computed score to the threshold:\n$$\nQ_{\\text{post}} = 53.96 > Q_{\\text{th}} = 40\n$$\nSince the posterior quality score of the SNV candidate is greater than the decision threshold, the candidate passes the quality filter. The final answer required is the numerical value of $Q_{\\text{post}}$.",
            "answer": "$$\n\\boxed{53.96}\n$$"
        },
        {
            "introduction": "After establishing a variant's technical validity, the crucial next step is clinical interpretation. This is often a complex process of evidence integration, where different data types may point in opposite directions. This practice problem places you in a common and challenging scenario: adjudicating a conflict between functional data suggesting pathogenicity and population frequency data suggesting a benign effect. By quantitatively calculating a maximum credible allele frequency and weighing the evidence, you will learn the principles behind the ACMG/AMP guidelines and appreciate how a sophisticated CDSS must handle evidentiary conflict to arrive at a responsible classification. ",
            "id": "4324229",
            "problem": "A Clinical Decision Support System (CDSS) for genomic interpretation is evaluating a missense variant in a gene with established autosomal-dominant association to a cardiac arrhythmia phenotype. The functional study is a well-validated in vitro assay showing a reduction of current density by approximately $60\\%$, consistent with the known loss-of-function disease mechanism for this gene. The American College of Medical Genetics and Genomics (ACMG) criterion for well-validated functional evidence (PS3) could therefore be applicable. However, the Genome Aggregation Database (gnomAD) reports the following ancestry-stratified observations for the variant: in non-Finnish Europeans there are $240$ alleles observed out of $300{,}000$ total alleles, giving an ancestry-matched allele frequency of approximately $0.0008$.\n\nFor the disease in question, the following epidemiologic and genetic-architecture facts are well supported:\n- Disease prevalence is approximately $1/5000$ ($K = 2\\times 10^{-4}$).\n- Penetrance for pathogenic heterozygotes is approximately $50\\%$ ($p=0.5$) overall.\n- Gene-level contribution to disease is approximately $35\\%$ of all cases ($g=0.35$).\n- The largest single variant in this gene historically accounts for no more than $5\\%$ of gene-positive cases ($a=0.05$).\n\nThe Clinical Decision Support System (CDSS) must adjudicate the apparent conflict between functional assay evidence suggesting pathogenicity and population allele frequency suggesting benignity. Using only fundamental principles such as Hardy–Weinberg equilibrium for rare alleles and Bayes’ theorem for evidence integration, determine which of the following CDSS adjudication strategies is most appropriate in this scenario.\n\nA. Apply a fixed ancestry-agnostic allele-frequency threshold of $5\\%$ as a stand-alone benign rule and classify the variant as benign if this threshold is exceeded, regardless of functional results.\n\nB. Compute a disease- and ancestry-specific maximum credible allele frequency threshold using disease prevalence, penetrance, and genetic and allelic heterogeneity; compare the observed ancestry-matched frequency to this threshold, and then integrate the population evidence (e.g., ACMG BS1) and functional assay evidence (e.g., ACMG PS3) using a Bayesian framework. If functional and population evidence are both strong but discordant, classify as a variant of uncertain significance unless additional case-level or segregation evidence resolves the conflict.\n\nC. Automatically down-weight or ignore population evidence whenever any in vitro assay suggests a deleterious effect, because functional data are mechanistically closer to disease and therefore should dominate.\n\nD. Evaluate special-case scenarios that can reconcile the conflict, including reduced or age-dependent penetrance, subpopulation founder effects with subpopulation-specific disease prevalence, recessive or oligogenic mechanisms, or gain-of-function versus loss-of-function mechanism mismatch; if applicable, adjust priors, thresholds, or the disease model and re-run the Bayesian integration under the appropriate model rather than forcing a dominant, high-penetrance model.\n\nE. Disregard the Genome Aggregation Database (gnomAD) entirely for late-onset diseases, because population databases are unreliable for such disorders.\n\nSelect all that apply.",
            "solution": "The user has provided a clinical genomics problem and asks for the most appropriate adjudication strategy for a variant with conflicting evidence. The\nsolution requires a rigorous validation of the problem statement, followed by a quantitative analysis based on principles of population genetics and variant interpretation guidelines.\n\n### Step 1: Extract Givens\n\nThe problem provides the following explicit data and conditions:\n-   **Gene and Disease Context**: Autosomal-dominant cardiac arrhythmia phenotype. The gene's known disease mechanism is loss-of-function.\n-   **Variant Functional Evidence**: A well-validated *in vitro* assay shows a current density reduction of approximately $60\\%$. This is presented as potentially meeting the American College of Medical Genetics and Genomics (ACMG) criterion PS3 (strong pathogenic evidence).\n-   **Variant Population Data**: From the Genome Aggregation Database (gnomAD), non-Finnish European population:\n    -   Allele Count (AC): $240$\n    -   Total Alleles (AN): $300,000$\n    -   Derived Allele Frequency ($AF_{obs}$): $240 / 300,000 \\approx 0.0008$\n-   **Epidemiological and Genetic Architecture Data**:\n    -   Disease Prevalence ($K$): $\\approx 1/5000$, which is $K = 2 \\times 10^{-4}$.\n    -   Penetrance ($p$): $\\approx 50\\%$, or $p = 0.5$.\n    -   Gene-level Contribution to Disease ($g$): $\\approx 35\\%$, or $g = 0.35$.\n    -   Maximum Allelic Contribution ($a$): The largest single variant contributes no more than $5\\%$ of gene-positive cases, so $a = 0.05$.\n\n### Step 2: Validate Using Extracted Givens\n\nThe problem is subjected to validation against mandatory criteria.\n\n-   **Scientifically Grounded**: The problem is well-grounded in established principles of medical and population genetics. It uses concepts like autosomal dominant inheritance, penetrance, genetic and allelic heterogeneity, and standard data sources (gnomAD) and interpretation frameworks (ACMG). The provided numerical values for prevalence, penetrance, and genetic architecture are realistic for a rare Mendelian disorder. The scenario of conflicting evidence between functional studies and population frequency is a common and critical challenge in clinical genomics.\n-   **Well-Posed**: The problem is clearly stated. It provides all necessary quantitative information to calculate a maximum credible allele frequency and compare it to the observed frequency. The question asks for an evaluation of adjudication strategies, which is a well-defined task.\n-   **Objective**: The problem is stated using objective, quantitative, and precise language, free from subjective or biased claims.\n\nThe problem statement successfully passes all validation criteria. It is a valid, solvable scientific problem.\n\n### Step 3: Verdict and Action\n\nThe problem is **valid**. The solution process will now proceed.\n\n### Principle-Based Derivation and Option Analysis\n\nThe core of the problem is the conflict between the functional evidence (suggesting pathogenicity, PS3) and the population allele frequency (which appears high, potentially suggesting a benign nature, BS1). To adjudicate this, we must first quantitatively determine if the observed allele frequency is indeed too high for the variant to be a cause of the specified disease under the given genetic model.\n\nWe calculate the maximum credible allele frequency ($AF_{max}$) for a single pathogenic variant in this gene, given the disease parameters.\n\n1.  **Prevalence due to the gene**: The overall disease prevalence is $K = 2 \\times 10^{-4}$. The fraction of cases attributable to this specific gene is $g = 0.35$. Therefore, the prevalence of the disease caused by variants in this gene ($K_{gene}$) is:\n    $$K_{gene} = K \\times g = (2 \\times 10^{-4}) \\times 0.35 = 0.7 \\times 10^{-4}$$\n\n2.  **Cumulative pathogenic allele frequency**: For a rare autosomal dominant disease, the prevalence is approximately twice the product of the cumulative pathogenic allele frequency ($f_{gene}$) and the penetrance ($p$). This relationship stems from the Hardy-Weinberg principle, where the heterozygote frequency is approximately $2f$ for a rare allele.\n    $$K_{gene} \\approx 2 \\times f_{gene} \\times p$$\n    We can solve for the maximum cumulative allele frequency for *all* pathogenic variants in this gene ($f_{gene,max}$):\n    $$f_{gene,max} = \\frac{K_{gene}}{2 \\times p} = \\frac{0.7 \\times 10^{-4}}{2 \\times 0.5} = \\frac{0.7 \\times 10^{-4}}{1} = 7 \\times 10^{-5}$$\n\n3.  **Maximum single variant allele frequency**: The problem states that the single largest-effect variant accounts for no more than $a = 0.05$ ($5\\%$) of all pathogenic alleles in this gene. This factor accounts for allelic heterogeneity. Therefore, the maximum credible allele frequency for any single pathogenic variant ($AF_{max}$) is:\n    $$AF_{max} = f_{gene,max} \\times a = (7 \\times 10^{-5}) \\times 0.05 = 3.5 \\times 10^{-6}$$\n\n4.  **Comparison with observed frequency**: The observed allele frequency in the ancestry-matched population is $AF_{obs} = 0.0008$, which is $8 \\times 10^{-4}$.\n    We compare the observed frequency to the calculated maximum credible frequency:\n    $$AF_{obs} = 8 \\times 10^{-4} \\quad \\text{vs.} \\quad AF_{max} = 3.5 \\times 10^{-6}$$\n    The observed frequency ($800 \\times 10^{-6}$) is more than $200$ times greater than the maximum credible frequency ($3.5 \\times 10^{-6}$) for a pathogenic variant under the specified disease model. This constitutes very strong evidence that the variant is benign (ACMG criterion BS1).\n\nThe problem now becomes one of adjudicating between strong pathogenic evidence (PS3 from the functional study) and strong benign evidence (BS1 from the population frequency analysis).\n\n### Option-by-Option Analysis\n\n**A. Apply a fixed ancestry-agnostic allele-frequency threshold of $5\\%$ as a stand-alone benign rule and classify the variant as benign if this threshold is exceeded, regardless of functional results.**\nThe observed allele frequency is $0.0008$, which is $0.08\\%$. This is far below the $5\\%$ ($0.05$) threshold. Therefore, this rule (which corresponds to ACMG rule BA1 for common benign variants) is not triggered. Moreover, using a generic, high threshold is scientifically inferior to calculating a disease-specific threshold as we have done above. This strategy is naive and inapplicable. **Incorrect**.\n\n**B. Compute a disease- and ancestry-specific maximum credible allele frequency threshold using disease prevalence, penetrance, and genetic and allelic heterogeneity; compare the observed ancestry-matched frequency to this threshold, and then integrate the population evidence (e.g., ACMG BS1) and functional assay evidence (e.g., ACMG PS3) using a Bayesian framework. If functional and population evidence are both strong but discordant, classify as a variant of uncertain significance unless additional case-level or segregation evidence resolves the conflict.**\nThis option precisely describes the rigorous, quantitative process performed above. It correctly identifies that the observed frequency is too high (BS1 evidence) and that this conflicts with the functional evidence (PS3). In the ACMG/AMP framework, the presence of strong but conflicting evidence (one pathogenic, one benign) mandates a classification of \"Variant of Uncertain Significance\" (VUS). This strategy represents the standard-of-care, evidence-based approach to variant interpretation. **Correct**.\n\n**C. Automatically down-weight or ignore population evidence whenever any *in vitro* assay suggests a deleterious effect, because functional data are mechanistically closer to disease and therefore should dominate.**\nThis strategy is scientifically unsound. While functional assays provide mechanistic insight, they are not infallible and may not perfectly recapitulate the *in vivo* cellular environment or organismal biology. The quantitative evidence from a large population database like gnomAD is extremely powerful and cannot be ignored. The discrepancy of over $200$-fold between the observed and maximum credible allele frequencies is a robust finding that must be addressed, not dismissed. Ascribing automatic dominance to one evidence type over another is a flawed heuristic. **Incorrect**.\n\n**D. Evaluate special-case scenarios that can reconcile the conflict, including reduced or age-dependent penetrance, subpopulation founder effects with subpopulation-specific disease prevalence, recessive or oligogenic mechanisms, or gain-of-function versus loss-of-function mechanism mismatch; if applicable, adjust priors, thresholds, or the disease model and re-run the Bayesian integration under the appropriate model rather than forcing a dominant, high-penetrance model.**\nThis option describes a sophisticated and critical step in resolving deep conflicts in evidence. The VUS classification from strategy (B) arises because the data are inconsistent with the initial disease model (dominant, $p=0.5$). Strategy (D) proposes to investigate *why* there is a conflict by questioning the model's assumptions. For example, if the true penetrance were much lower (e.g., $\\approx 0.004$), the high allele frequency would be compatible with pathogenicity. Similarly, a recessive mode of inheritance or other complex genetic models could explain the observations. This represents a deeper level of scientific inquiry aimed at finding a model that consistently explains all available data. This is an essential component of a comprehensive adjudication strategy, especially for a CDSS aiming for high accuracy. **Correct**.\n\n**E. Disregard the Genome Aggregation Database (gnomAD) entirely for late-onset diseases, because population databases are unreliable for such disorders.**\nThis is an oversimplification and an incorrect assertion. While it is true that for late-onset diseases, asymptomatic carriers can be present in population databases, this does not render the data \"unreliable\" or useless. It simply means the data must be interpreted with caution, often by modeling reduced penetrance (as suggested in option D). Discarding one of the most powerful tools in modern genomics based on this concern is an extreme and inappropriate action. The magnitude of the allele frequency discrepancy in this problem is far too large to be explained solely by the presence of pre-symptomatic individuals. **Incorrect**.\n\n### Conclusion\nBoth options B and D describe appropriate and essential strategies for a sophisticated CDSS. Option B outlines the standard procedure for integrating the conflicting evidence under the initial model, correctly concluding with a VUS classification. Option D outlines the necessary follow-up investigation, which involves questioning and potentially revising the initial model to resolve the fundamental conflict. A complete adjudication process involves both steps. Since the prompt asks to select all applicable strategies, both are correct.",
            "answer": "$$\\boxed{BD}$$"
        },
        {
            "introduction": "The ultimate goal of many genomic CDSS is to provide clear, actionable guidance at the point of care. This final practice moves from interpretation to implementation, tasking you with encoding a real-world pharmacogenomic guideline into an executable rule. You will translate a Clinical Pharmacogenetics Implementation Consortium (CPIC) recommendation for thiopurine dosing into a computational logic that responds to a simulated 'CDS Hooks' event from an electronic health record. This exercise provides concrete experience in building the rule-based engine that turns a patient's genetic profile into a life-saving dose adjustment. ",
            "id": "4324236",
            "problem": "You are to implement a complete, runnable program that encodes an actionable Clinical Pharmacogenetics Implementation Consortium (CPIC) guideline recommendation into a rules engine trigger compatible with Clinical Decision Support (CDS) Hooks and computes a dosing suggestion to be rendered in the Electronic Health Record (EHR). The goal is to formalize the minimal input (payload) and the decision logic needed to produce a quantitative thiopurine dosing recommendation based on thiopurine S-methyltransferase (TPMT) and nudix hydrolase 15 (NUDT15) pharmacogenomic phenotypes.\n\nFundamental base to use:\n- Genotype-to-phenotype-to-therapy is grounded in the Central Dogma of Molecular Biology and pharmacokinetics: inherited variants in enzyme-encoding genes alter enzyme activity, which alters active metabolite exposure. This is a well-tested basis for pharmacogenomics.\n- CPIC (Clinical Pharmacogenetics Implementation Consortium) provides clinically validated recommendations for thiopurines conditioned on TPMT and NUDT15 phenotypes. You may treat the phenotype-to-dose adjustment categories below as well-tested facts.\n- CDS Hooks is an event-driven specification where a service receives a request when a particular clinical workflow event occurs. The hook identifier and context determine whether a rule should fire.\n\nMinimal payload definition (as a set of key-value constraints):\n- The request is a single dictionary with the following keys:\n  - \"hook\": a string equal to \"medication-prescribe\".\n  - \"context\": a dictionary that must include:\n    - \"medication\": a case-insensitive string naming the drug.\n    - \"standardDoseMg\": a real value in milligrams representing the clinician-entered standard dose for this patient. Denote this by $D_s$ with unit mg.\n  - \"prefetch\": a dictionary that may include:\n    - \"genomics\": a list of zero or more dictionaries, each with:\n      - \"gene\": a case-insensitive string equal to \"TPMT\" or \"NUDT15\".\n      - \"phenotype\": a case-insensitive string equal to \"Normal metabolizer\", \"Intermediate metabolizer\", or \"Poor metabolizer\". Denote the TPMT phenotype by $P_{\\mathrm{TPMT}}$ and the NUDT15 phenotype by $P_{\\mathrm{NUDT15}}$.\n\nTrigger semantics:\n- The rule triggers if and only if the value of \"hook\" equals \"medication-prescribe\" and the value of \"medication\" is in the set of thiopurines: {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"} (case-insensitive). Otherwise, no pharmacogenomic adjustment should be applied.\n\nDose adjustment facts to be used as the foundational starting point:\n- For patients with both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ equal to \"Normal metabolizer\", the initial dose multiplier is $m = 1.0$.\n- For patients with exactly one of $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ equal to \"Intermediate metabolizer\" and the other \"Normal metabolizer\", the initial dose multiplier is $m = 0.5$.\n- For patients with both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ equal to \"Intermediate metabolizer\", the initial dose multiplier is $m = 0.2$.\n- For patients with either $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ equal to \"Poor metabolizer\", the initial dose multiplier is $m = 0.1$.\n- If a gene is missing from \"genomics\", treat the missing gene as \"Normal metabolizer\" for the purpose of computing $m$.\n- If the rule does not trigger, set $m = 1.0$.\n\nDecision computation and output:\n- Let $D_s$ be the standard dose in milligrams.\n- Compute the recommended dose $D_r = m \\times D_s$ in milligrams.\n- Round $D_r$ to the nearest integer milligram using half-up rounding (i.e., values with fractional part exactly $0.5$ round up, away from zero).\n- Your program must output only a single line containing a comma-separated list of the integer recommendations for the specified test suite, enclosed in square brackets.\n\nUnit specification:\n- All doses must be expressed in milligrams (mg) as integers after rounding.\n\nAngle and percentage specification:\n- No angles are used.\n- Any fractional multipliers must be treated as decimals (e.g., $0.5$), not percentages.\n\nTest suite:\nFor each test case below, construct the payload and compute the final integer $D_r$ in mg.\n\n- Test case $1$ (happy path, both normal):\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $2$ (single intermediate):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $3$ (poor for one gene):\n  - \"medication\" = \"thioguanine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Poor metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: yes\n\n- Test case $4$ (both intermediate):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 40$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Intermediate metabolizer\"\n  - Expected trigger: yes\n\n- Test case $5$ (missing genomics, default behavior):\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 60$ mg\n  - \"genomics\" list is empty\n  - Expected trigger: yes\n\n- Test case $6$ (half-up rounding check):\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 35$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Poor metabolizer\"\n  - Expected trigger: yes\n\n- Test case $7$ (non-target medication, rule does not trigger):\n  - \"medication\" = \"clopidogrel\"\n  - $D_s = 75$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - Expected trigger: no\n\nRequired final output format:\n- Your program should produce a single line of output containing the results for the seven test cases as a comma-separated list enclosed in square brackets (e.g., \"[$x_1,x_2,x_3,x_4,x_5,x_6,x_7$]\"), where each $x_i$ is the integer $D_r$ in mg for test case $i$ in order.",
            "solution": "The problem requires the formalization and implementation of a clinical decision support (CDS) rule based on the Clinical Pharmacogenetics Implementation Consortium (CPIC) guidelines for thiopurine dosing. The implementation must be compatible with the CDS Hooks specification, translating pharmacogenomic phenotypes for thiopurine S-methyltransferase ($TPMT$) and nudix hydrolase 15 ($NUDT15$) into a specific dosing recommendation. The solution entails a systematic, step-by-step translation of the provided clinical logic into a computational algorithm.\n\nFirst, a validation of the problem statement is necessary.\n\n**Step 1: Extract Givens**\n\n- **Hook Specification**: The rule is triggered by a CDS Hooks request where the `hook` identifier is `\"medication-prescribe\"`.\n- **Triggering Medication Set**: The rule applies if the prescribed `medication` is one of `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` (case-insensitive).\n- **Input Data Structure (Payload)**:\n  - `hook`: string, must be `\"medication-prescribe\"`.\n  - `context`: dictionary containing:\n    - `medication`: string, name of the drug.\n    - `standardDoseMg`: real number, the standard dose $D_s$ in milligrams (mg).\n  - `prefetch`: dictionary that may contain:\n    - `genomics`: a list of dictionaries, each with:\n      - `gene`: string, `\"TPMT\"` or `\"NUDT15\"` (case-insensitive).\n      - `phenotype`: string, `\"Normal metabolizer\"`, `\"Intermediate metabolizer\"`, or `\"Poor metabolizer\"` (case-insensitive). We denote these by $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$.\n- **Dose Adjustment Rules (Multiplier $m$)**:\n  1. If the trigger conditions are not met, the dose multiplier $m$ is $1.0$.\n  2. If a gene's phenotype is missing, it is assumed to be `\"Normal metabolizer\"`.\n  3. If both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ are `\"Normal metabolizer\"`, then $m = 1.0$.\n  4. If one phenotype is `\"Intermediate metabolizer\"` and the other is `\"Normal metabolizer\"`, then $m = 0.5$.\n  5. If both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ are `\"Intermediate metabolizer\"`, then $m = 0.2$.\n  6. If either $P_{\\mathrm{TPMT}}$ or $P_{\\mathrm{NUDT15}}$ is `\"Poor metabolizer\"`, then $m = 0.1$.\n- **Computation and Output**:\n  - The recommended dose is calculated as $D_r = m \\times D_s$.\n  - The final result $D_r$ must be rounded to the nearest integer using half-up rounding.\n  - The output is a single-line string with comma-separated integer results for the test suite, enclosed in square brackets.\n- **Test Suite**: Seven specific test cases are provided with defined inputs and expected trigger behavior.\n\n**Step 2: Validate Using Extracted Givens**\n\n- **Scientifically Grounded**: The problem is grounded in established pharmacogenomic principles and references real-world, evidence-based CPIC guidelines and the CDS Hooks technical standard. The relationship between $TPMT$/$NUDT15$ genetic variants, enzyme activity, and thiopurine metabolism is a cornerstone of personalized medicine. The provided dose adjustment factors are simplifications but representative of the actual clinical guidelines. The problem is scientifically sound.\n- **Well-Posed**: The problem is well-posed. The inputs are rigorously defined, the logical rules for dose adjustment are deterministic and cover all specified combinations, and the default behavior for missing data is explicitly stated. The calculation and rounding rules are unambiguous, ensuring a unique solution for any valid input.\n- **Objective**: The problem is stated in precise, objective language, free of ambiguity or subjective claims. All parameters and rules are quantitative or logical.\n\n**Step 3: Verdict and Action**\n\nThe problem statement is valid. It is scientifically grounded, well-posed, and objective. It provides a complete and consistent set of requirements for developing a computational solution. We may proceed with the solution design.\n\n**Solution Design and Algorithm**\n\nThe core of the solution is a function that processes an input payload, applies the triggering and dosing logic, and returns a computed dose. This process can be broken down into four main stages.\n\n**1. Rule Trigger Evaluation**\nThe first step is to determine if the pharmacogenomic-based dosing rule should be applied. This is governed by two conditions that must be met simultaneously:\n- The context of the CDS Hooks call must be a medication prescription event. This is verified by checking if the input `hook` key has a value equal to `\"medication-prescribe\"`.\n- The prescribed medication must be a thiopurine. This is verified by checking if the case-insensitive value of the `medication` key is present in the set `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}`.\n\nIf either of these conditions fails, the rule does not trigger. In this scenario, the dose multiplier $m$ is set to $1.0$, and the recommended dose $D_r$ is simply the standard dose $D_s$.\n\n**2. Phenotype Determination with Defaults**\nIf the rule triggers, the next step is to ascertain the patient's $TPMT$ and $NUDT15$ metabolic phenotypes. The problem specifies default values: if a gene's phenotype is not provided in the `prefetch` section of the payload, it should be treated as `\"Normal metabolizer\"`.\nThe algorithm will therefore initialize the phenotypes $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ to `\"Normal metabolizer\"`. It then iterates through the `genomics` list in the `prefetch` data. For each entry, it identifies the gene (e.g., `\"TPMT\"` or `\"NUDT15\"`) and its corresponding phenotype, updating the initialized values. This process must be case-insensitive for both gene names and phenotype descriptions.\n\n**3. Dose Multiplier ($m$) Calculation**\nWith both $P_{\\mathrm{TPMT}}$ and $P_{\\mathrm{NUDT15}}$ determined, the dose multiplier $m$ can be calculated based on the provided hierarchy of rules. To ensure correctness, these rules must be evaluated in order of precedence, starting with the most critical phenotype (Poor Metabolizer). Let us represent the phenotypes canonically as NM (Normal Metabolizer), IM (Intermediate Metabolizer), and PM (Poor Metabolizer).\n\nThe logic is as follows:\n- **Condition 1 (Highest Precedence)**: If $P_{\\mathrm{TPMT}} = \\text{PM}$ or $P_{\\mathrm{NUDT15}} = \\text{PM}$, set $m = 0.1$. This rule overrides all others.\n- **Condition 2**: Else, if $P_{\\mathrm{TPMT}} = \\text{IM}$ and $P_{\\mathrm{NUDT15}} = \\text{IM}$, set $m = 0.2$.\n- **Condition 3**: Else, if ($P_{\\mathrm{TPMT}} = \\text{IM}$ and $P_{\\mathrm{NUDT15}} = \\text{NM}$) or ($P_{\\mathrm{TPMT}} = \\text{NM}$ and $P_{\\mathrm{NUDT15}} = \\text{IM}$), set $m = 0.5$.\n- **Condition 4 (Base Case)**: Else (which implies $P_{\\mathrm{TPMT}} = \\text{NM}$ and $P_{\\mathrm{NUDT15}} = \\text{NM}$), set $m = 1.0$.\n\nThis structured evaluation ensures that the correct multiplier is selected according to the specified clinical logic.\n\n**4. Final Dose Calculation and Rounding**\nThe final step is to compute the recommended dose, $D_r$, and format it as required.\n- The unrounded recommended dose is calculated by the formula:\n$$D_r = m \\times D_s$$\nwhere $D_s$ is the standard dose provided in the input context.\n- The problem specifies half-up rounding to the nearest integer. For a non-negative value $x$, this can be implemented computationally as $\\lfloor x + 0.5 \\rfloor$, which is equivalent to `int(x + 0.5)` in Python for positive numbers.\n\nBy applying this four-step process to each test case in the provided suite, we can generate the required list of integer dose recommendations. The final implementation encapsulates this logic into a complete, runnable program.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print the final results.\n    \"\"\"\n\n    # Define the test cases from the problem statement as a list of dictionaries.\n    test_cases = [\n        # Test case 1 (happy path, both normal)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 2 (single intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 3 (poor for one gene)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"thioguanine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Poor metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 4 (both intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 40},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Intermediate metabolizer\"},\n                ]\n            },\n        },\n        # Test case 5 (missing genomics, default behavior)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 60},\n            \"prefetch\": {\"genomics\": []},\n        },\n        # Test case 6 (half-up rounding check)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 35},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Poor metabolizer\"},\n                ]\n            },\n        },\n        # Test case 7 (non-target medication, rule does not trigger)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"clopidogrel\", \"standardDoseMg\": 75},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n    ]\n\n    results = [compute_recommendation(case) for case in test_cases]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_recommendation(payload: dict) -> int:\n    \"\"\"\n    Computes a thiopurine dosing recommendation based on a CDS Hooks payload.\n\n    Args:\n        payload: A dictionary representing the CDS Hooks request.\n\n    Returns:\n        The recommended dose in milligrams, rounded to the nearest integer.\n    \"\"\"\n    \n    # Define constants for the rule logic.\n    THIOPURINES = {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}\n    \n    # Phenotype canonical representations for internal use.\n    NM = \"normal metabolizer\"\n    IM = \"intermediate metabolizer\"\n    PM = \"poor metabolizer\"\n\n    context = payload.get(\"context\", {})\n    standard_dose = context.get(\"standardDoseMg\", 0.0)\n    medication = context.get(\"medication\", \"\").lower()\n    hook = payload.get(\"hook\", \"\")\n\n    # 1. Rule Trigger Evaluation\n    # Rule triggers only for thiopurine prescriptions.\n    if not (hook == \"medication-prescribe\" and medication in THIOPURINES):\n        # If the rule doesn't trigger, use the standard dose (multiplier is 1.0).\n        # Rounding is still applied to handle potential float inputs.\n        return int(standard_dose + 0.5)\n\n    # 2. Phenotype Determination with Defaults\n    # Default phenotypes to \"Normal metabolizer\".\n    phenotypes = {\"tpmt\": NM, \"nudt15\": NM}\n\n    prefetch = payload.get(\"prefetch\", {})\n    genomics_data = prefetch.get(\"genomics\", [])\n    \n    for record in genomics_data:\n        gene = record.get(\"gene\", \"\").lower()\n        phenotype = record.get(\"phenotype\", \"\").lower()\n        if gene in phenotypes:\n            phenotypes[gene] = phenotype\n    \n    p_tpmt = phenotypes[\"tpmt\"]\n    p_nudt15 = phenotypes[\"nudt15\"]\n\n    # 3. Dose Multiplier (m) Calculation\n    # The rules are checked in order of highest precedence (most severe impact).\n    multiplier = 1.0  # Default multiplier\n\n    if p_tpmt == PM or p_nudt15 == PM:\n        multiplier = 0.1\n    elif p_tpmt == IM and p_nudt15 == IM:\n        multiplier = 0.2\n    elif (p_tpmt == IM and p_nudt15 == NM) or (p_tpmt == NM and p_nudt15 == IM):\n        multiplier = 0.5\n    elif p_tpmt == NM and p_nudt15 == NM:\n        multiplier = 1.0\n        \n    # 4. Final Dose Calculation and Rounding\n    recommended_dose_unrounded = multiplier * standard_dose\n    \n    # Apply half-up rounding. For positive numbers, int(x + 0.5) suffices.\n    final_dose = int(recommended_dose_unrounded + 0.5)\n    \n    return final_dose\n\nsolve()\n```"
        }
    ]
}