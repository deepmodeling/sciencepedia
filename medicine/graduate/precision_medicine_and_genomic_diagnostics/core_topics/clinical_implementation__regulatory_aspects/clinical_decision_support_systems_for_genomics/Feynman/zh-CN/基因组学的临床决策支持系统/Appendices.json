{
    "hands_on_practices": [
        {
            "introduction": "在任何临床解读开始之前，临床决策支持系统（CDSS）必须首先确定检测到的基因变异是真实存在的，还是仅仅是测序过程中的假象。这项练习  将指导您完成现代变异检出流程中使用的基本贝叶斯计算，为候选变异分配质量分数。这是任何基因组分析流程中至关重要的第一步。",
            "id": "4324283",
            "problem": "一个用于基因组学的临床决策支持（CDS）流程整合了读段水平的质量控制（QC）证据，以生成一个后验变异质量得分，该得分在精准医疗工作流程中指导过滤。考虑一个位于临床基因面板中某个位点的候选单核苷酸变异（SNV）。该位点的测序指标如下：总读段深度 $n=12$，其中有 $k=6$ 个读段支持替代等位基因；支持替代等位基因的读段的平均碱基质量为 $Q_{b}=25$；以及使用 Fisher 精确检验在无链偏向性的原假设下计算出的双边链偏向性 $p$ 值为 $p_{\\mathrm{sb}}=0.01$。假设每个位点存在真实变异的先验概率为 $P(H_{1})=10^{-4}$，其互补概率为 $P(H_{0})=1-P(H_{1})$。\n\n使用两个假设对证据进行建模：$H_{1}$（无内在链偏向性的真实杂合变异）和 $H_{0}$（无真实变异；观测到的支持替代等位基因的读段由测序错误引起）。使用以下基本依据和假设：\n\n1. 用于计算后验优势比和后验概率的贝叶斯定理。\n2. 概率 $p$ 的 Phred 转换定义：$Q=-10\\log_{10}(p)$。\n3. 独立的每次读段碱基识别错误，每次读段的错误概率为 $\\varepsilon = 10^{-Q_{b}/10}$。\n4. 在 $H_{1}$ 假设下，对于一个无链偏向性的杂合 SNV，每次读段中识别为替代等位基因的概率约为 $p_{\\text{alt}|H_{1}}=\\frac{1}{2}$；因此，$n$ 个读段中支持替代等位基因的读段数 $k$ 服从参数为 $p=\\frac{1}{2}$ 的二项分布。\n5. 在 $H_{0}$ 假设下，每次读段中识别为替代等位基因的概率等于碱基错误概率 $\\varepsilon$，计数 $k$ 服从参数为 $p=\\varepsilon$ 的二项分布。\n6. 将观测到的链偏向性 $p$ 值视为通过贝叶斯因子中的因子 $p_{\\mathrm{sb}}$ 反对 $H_{1}$ 的乘法证据；在 $H_{0}$ 假设下，不使用 $p_{\\mathrm{sb}}$ 进行惩罚。\n\n从这些基础出发，给定数据 $D=\\{n=12,\\;k=6,\\;Q_{b}=25,\\;p_{\\mathrm{sb}}=0.01\\}$，推导出后验概率 $P(H_{1}\\mid D)$，并计算后验 Phred 质量得分\n$$\nQ_{\\text{post}}=-10\\log_{10}\\!\\big(1-P(H_{1}\\mid D)\\big).\n$$\n此外，施加一个后验假阳性约束 $\\theta=10^{-4}$，并确定隐含的 Phred 决策阈值 $Q_{\\text{th}}=-10\\log_{10}(\\theta)$。说明该候选变异相对于 $Q_{\\text{th}}$ 是通过还是不通过。\n\n将计算出的 $Q_{\\text{post}}$ 四舍五入至四位有效数字。以 Phred 单位表示 $Q_{\\text{post}}$。对于通过/不通过的决策，描述你的推理过程，但最终答案只报告 $Q_{\\text{post}}$ 的数值。",
            "solution": "这个问题是要求在给定一组测序数据的情况下，计算一个单核苷酸变异（SNV）为真实变异的后验概率，并确定该变异是否通过一个质量阈值。该问题在科学上基于贝叶斯统计和基因组学中使用的标准模型。问题提法恰当，所有必需的参数和模型都有明确定义。因此，该问题是有效的，并且可以推导出解决方案。\n\n分析的核心在于贝叶斯定理，用优势比的形式表达最为方便。给定数据 $D$，假设 $H_{1}$（真实变异）相对于假设 $H_{0}$（测序错误）的后验优势比是先验优势比与贝叶斯因子（BF）的乘积：\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\frac{P(H_{1})}{P(H_{0})} \\times \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})}\n$$\n数据 $D$ 包括总读段深度 $n=12$，支持替代等位基因的读段数 $k=6$，替代等位基因读段的平均碱基质量 $Q_{b}=25$，以及链偏向性 $p$ 值 $p_{\\mathrm{sb}}=0.01$。\n\n首先，我们建立先验优势比。给定真实变异的先验概率 $P(H_{1})=10^{-4}$，则无真实变异的先验概率为 $P(H_{0})=1-P(H_{1})=1-10^{-4}=0.9999$。先验优势比为：\n$$\n\\frac{P(H_{1})}{P(H_{0})} = \\frac{10^{-4}}{1-10^{-4}} = \\frac{10^{-4}}{0.9999}\n$$\n\n接下来，我们构建贝叶斯因子，它是指在两个竞争假设下观测到数据的似然比，即 $\\text{BF} = P(D\\mid H_{1}) / P(D\\mid H_{0})$。问题指明了如何根据不同的证据片段对似然进行建模。\n\n碱基识别错误概率 $\\varepsilon$ 由 Phred 标度的碱基质量 $Q_{b}=25$ 推导得出：\n$$\n\\varepsilon = 10^{-Q_{b}/10} = 10^{-25/10} = 10^{-2.5}\n$$\n在总共 $n$ 个读段中观测到 $k$ 个支持替代等位基因的读段的似然由二项分布建模，即 $P(k|n, p) = \\binom{n}{k}p^{k}(1-p)^{n-k}$。\n在 $H_{1}$（真实杂合变异）假设下，观测到替代等位基因的概率为 $p = \\frac{1}{2}$。\n$$\nP(k=6 \\mid n=12, H_{1}) = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{6} \\left(1-\\frac{1}{2}\\right)^{12-6} = \\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12}\n$$\n在 $H_{0}$（测序错误）假设下，观测到替代等位基因的概率为错误率 $p = \\varepsilon$。\n$$\nP(k=6 \\mid n=12, H_{0}) = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{12-6} = \\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}\n$$\n问题指出，链偏向性 $p$ 值 $p_{\\mathrm{sb}}$ 应被视为对 $H_{1}$ 似然的乘法惩罚，而 $H_{0}$ 不受惩罚。这意味着 $H_{1}$ 的总似然为 $P(D\\mid H_{1}) = P(k|n, H_1) \\times p_{\\mathrm{sb}}$，而 $H_{0}$ 的总似然为 $P(D\\mid H_{0}) = P(k|n, H_0) \\times 1$。\n\n因此，贝叶斯因子为：\n$$\n\\text{BF} = \\frac{P(D\\mid H_{1})}{P(D\\mid H_{0})} = \\frac{\\binom{12}{6} \\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\binom{12}{6} \\varepsilon^{6} (1-\\varepsilon)^{6}} = \\frac{\\left(\\frac{1}{2}\\right)^{12} p_{\\mathrm{sb}}}{\\varepsilon^{6} (1-\\varepsilon)^{6}}\n$$\n代入已知值 $p_{\\mathrm{sb}}=0.01=10^{-2}$ 和 $\\varepsilon=10^{-2.5}$：\n$$\n\\text{BF} = \\frac{(0.5)^{12} \\times 10^{-2}}{\\left(10^{-2.5}\\right)^{6} (1-10^{-2.5})^{6}} = \\frac{2^{-12} \\times 10^{-2}}{10^{-15} (1-10^{-2.5})^{6}} = \\frac{10^{13}}{2^{12} (1-10^{-2.5})^{6}}\n$$\n我们计算其数值：$2^{12} = 4096$。\n$$\n\\text{BF} = \\frac{10^{13}}{4096 \\times (1-10^{-2.5})^{6}} \\approx \\frac{10^{13}}{4096 \\times (0.9968377)^{6}} \\approx \\frac{10^{13}}{4096 \\times 0.981190} \\approx \\frac{10^{13}}{4018.956} \\approx 2.488206 \\times 10^{9}\n$$\n现在，我们计算后验优势比：\n$$\n\\frac{P(H_{1}\\mid D)}{P(H_{0}\\mid D)} = \\left(\\frac{10^{-4}}{0.9999}\\right) \\times (2.488206 \\times 10^{9}) \\approx 248845.5\n$$\n$H_{1}$ 的后验概率与后验优势比 $O_{\\text{post}}$ 的关系为 $P(H_{1}\\mid D) = O_{\\text{post}} / (1 + O_{\\text{post}})$。计算 Phred 得分所需的量是后验错误概率，即 $P(H_{0}\\mid D) = 1 - P(H_{1}\\mid D) = 1 / (1 + O_{\\text{post}})$。\n$$\n1 - P(H_{1}\\mid D) = \\frac{1}{1 + 248845.5} = \\frac{1}{248846.5} \\approx 4.01854 \\times 10^{-6}\n$$\n后验 Phred 质量得分 $Q_{\\text{post}}$ 定义为：\n$$\nQ_{\\text{post}} = -10\\log_{10}(1 - P(H_{1}\\mid D))\n$$\n$$\nQ_{\\text{post}} = -10\\log_{10}(4.01854 \\times 10^{-6}) = -10(\\log_{10}(4.01854) - 6) \\approx -10(0.604067 - 6) = -10(-5.395933) \\approx 53.95933\n$$\n四舍五入到四位有效数字，我们得到 $Q_{\\text post} = 53.96$。\n\n最后，我们必须确定该候选变异是通过还是不通过。后验假阳性约束为 $\\theta=10^{-4}$。相应的 Phred 决策阈值 $Q_{\\text{th}}$ 为：\n$$\nQ_{\\text{th}} = -10\\log_{10}(\\theta) = -10\\log_{10}(10^{-4}) = -10(-4) = 40\n$$\n决策规则是，如果候选变异的质量得分大于或等于阈值，则通过。我们将计算出的得分与阈值进行比较：\n$$\nQ_{\\text{post}} = 53.96 > Q_{\\text{th}} = 40\n$$\n由于该 SNV 候选变异的后验质量得分大于决策阈值，因此该候选变异通过了质量过滤。要求的最终答案是 $Q_{\\text{post}}$ 的数值。",
            "answer": "$$\n\\boxed{53.96}\n$$"
        },
        {
            "introduction": "从单个变异转向复杂的性状，本练习探讨了CDSS如何整合来自多个遗传标记的信息来预测个体患上某种常见疾病的风险。您将实践多基因风险评分（Polygenic Risk Score, PRS）的核心计算 ，学习如何标准化评分并将其转化为具有临床意义的绝对风险估计值。",
            "id": "4324199",
            "problem": "一个信息学团队正在构建一个临床决策支持模块，该模块将一种常见复杂疾病的多基因风险评分 (PRS) 整合到一个基于对数优势比标度的个体化绝对风险评估中。该 PRS 计算为单核苷酸多态性 (SNPs) 的加权和，其中基因型编码为风险等位基因的数量。假设满足 Hardy-Weinberg 平衡 (HWE) 并且各个 SNP 之间相互独立，因此对于每个风险等位基因频率为 $p_j$ 的 SNP，其基因型计数 $x_j \\in \\{0,1,2\\}$ 服从参数为 $n=2$ 和概率为 $p_j$ 的二项分布，得出 $\\mathbb{E}[x_j] = 2p_j$ 和 $\\mathrm{Var}(x_j) = 2p_j(1-p_j)$。原始 PRS 为 $S = \\sum_{j=1}^{m} \\beta_j x_j$，其中 $\\beta_j$ 是来自经过验证的全基因组关联研究的每个风险等位基因的对数优势比权重。个体的标准化 PRS z-分数定义为 $z = \\dfrac{S - \\mu_S}{\\sigma_S}$，其中在独立性假设下，$\\mu_S = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$ 且 $\\sigma_S = \\sqrt{\\sum_{j=1}^{m} \\beta_j^{2} \\mathrm{Var}(x_j)}$。\n\n为了将标准化 PRS 转化为绝对风险，使用一个基于优势比和对数优势比定义的逻辑斯谛模型：概率 $p$ 的优势比是 $\\dfrac{p}{1-p}$，对数优势比 (logit) 是 $\\ln\\!\\left(\\dfrac{p}{1-p}\\right)$，对于线性预测子 $\\eta$，反-logit (逻辑斯谛函数) 是 $\\dfrac{1}{1+\\exp(-\\eta)}$。假设该模块将经人群校准的基线发病率 $I_0$ 编码为标准化 PRS $z=0$ 时的风险，并将 PRS 的效应建模为 z 每增加一个标准差，对数优势比偏移 $\\gamma$。因此，对于一个标准化 PRS 为 z 的个体，其线性预测子为 $\\eta = \\alpha + \\gamma z$，其中截距 $\\alpha$ 满足 $\\alpha = \\ln\\!\\left(\\dfrac{I_0}{1-I_0}\\right)$。\n\n考虑 $m=5$ 个 SNP，其参数如下，其中所有 $\\beta_j$ 均为每个等位基因的对数优势比权重，$p_j$ 是人群风险等位基因频率，$x_j$ 是个体观察到的风险等位基因计数：\n- SNP 1：$\\beta_1 = 0.12$, $p_1 = 0.30$, $x_1 = 1$。\n- SNP 2：$\\beta_2 = -0.08$, $p_2 = 0.45$, $x_2 = 0$。\n- SNP 3：$\\beta_3 = 0.25$, $p_3 = 0.10$, $x_3 = 1$。\n- SNP 4：$\\beta_4 = 0.05$, $p_4 = 0.60$, $x_4 = 1$。\n- SNP 5：$\\beta_5 = 0.15$, $p_5 = 0.20$, $x_5 = 2$。\n\n假设基线发病率 $I_0 = 0.12$，每标准差的对数优势比效应 $\\gamma = 0.35$。仅使用以上提供的基本定义（Hardy-Weinberg 平衡下的二项基因型模型、SNP 间的独立性、优势比、对数优势比和逻辑斯谛连接），计算该个体的标准化 PRS $z$ 值，然后从对数优势比模型中推导出绝对风险 $p$。仅以小数形式报告最终的绝对风险。将最终答案四舍五入到四位有效数字。不允许使用百分号。",
            "solution": "该问题被认为是有效的，因为它在科学上基于统计遗传学和流行病学的既定原则，提法明确且有足够的信息得到唯一解，并以客观、正式的语言表述。求解过程通过系统地应用问题陈述中提供的定义来进行。\n\n计算分以下几个步骤进行：\n1.  计算 $m=5$ 个 SNP 中每个 SNP 基因型计数的群体均值 $\\mathbb{E}[x_j]$ 和方差 $\\mathrm{Var}(x_j)$。\n2.  计算个体的原始多基因风险评分 (PRS)，$S$。\n3.  计算 PRS 的群体均值 $\\mu_S$。\n4.  计算 PRS 的群体方差 $\\sigma_S^2$ 和标准差 $\\sigma_S$。\n5.  计算个体的标准化 PRS z-分数。\n6.  使用所提供的逻辑斯谛风险模型计算个体的绝对风险 $p$。\n\n**步骤 1：每个 SNP 的群体矩**\n对于每个 SNP $j$，基因型计数 $x_j$ 是一个参数为 $n=2$ 和概率为 $p_j$ 的二项随机变量。其均值和方差由以下公式给出：\n$\\mathbb{E}[x_j] = 2p_j$\n$\\mathrm{Var}(x_j) = 2p_j(1-p_j)$\n\n使用提供的风险等位基因频率 $p_j$：\n- 对于 SNP 1 ($p_1 = 0.30$)：\n  $\\mathbb{E}[x_1] = 2(0.30) = 0.60$\n  $\\mathrm{Var}(x_1) = 2(0.30)(1 - 0.30) = 0.42$\n- 对于 SNP 2 ($p_2 = 0.45$)：\n  $\\mathbb{E}[x_2] = 2(0.45) = 0.90$\n  $\\mathrm{Var}(x_2) = 2(0.45)(1 - 0.45) = 0.495$\n- 对于 SNP 3 ($p_3 = 0.10$)：\n  $\\mathbb{E}[x_3] = 2(0.10) = 0.20$\n  $\\mathrm{Var}(x_3) = 2(0.10)(1 - 0.10) = 0.18$\n- 对于 SNP 4 ($p_4 = 0.60$)：\n  $\\mathbb{E}[x_4] = 2(0.60) = 1.20$\n  $\\mathrm{Var}(x_4) = 2(0.60)(1 - 0.60) = 0.48$\n- 对于 SNP 5 ($p_5 = 0.20$)：\n  $\\mathbb{E}[x_5] = 2(0.20) = 0.40$\n  $\\mathrm{Var}(x_5) = 2(0.20)(1 - 0.20) = 0.32$\n\n**步骤 2：个体的原始 PRS, $S$**\n原始 PRS 是个体风险等位基因计数的加权和：$S = \\sum_{j=1}^{m} \\beta_j x_j$。\n代入给定的 $\\beta_j$ 和 $x_j$ 值：\n$$S = (0.12)(1) + (-0.08)(0) + (0.25)(1) + (0.05)(1) + (0.15)(2)$$\n$$S = 0.12 + 0 + 0.25 + 0.05 + 0.30 = 0.72$$\n\n**步骤 3：PRS 的群体均值, $\\mu_S$**\nPRS 的群体均值是 $\\mu_S = \\mathbb{E}[S] = \\sum_{j=1}^{m} \\beta_j \\mathbb{E}[x_j]$。\n代入 $\\beta_j$ 和计算出的 $\\mathbb{E}[x_j]$：\n$$\\mu_S = (0.12)(0.60) + (-0.08)(0.90) + (0.25)(0.20) + (0.05)(1.20) + (0.15)(0.40)$$\n$$\\mu_S = 0.072 - 0.072 + 0.050 + 0.060 + 0.060 = 0.170$$\n\n**步骤 4：PRS 的群体方差和标准差**\n假设 SNP 之间相互独立，PRS 的群体方差为 $\\sigma_S^2 = \\mathrm{Var}(S) = \\sum_{j=1}^{m} \\beta_j^2 \\mathrm{Var}(x_j)$。\n$$\\sigma_S^2 = (0.12)^2(0.42) + (-0.08)^2(0.495) + (0.25)^2(0.18) + (0.05)^2(0.48) + (0.15)^2(0.32)$$\n$$\\sigma_S^2 = (0.0144)(0.42) + (0.0064)(0.495) + (0.0625)(0.18) + (0.0025)(0.48) + (0.0225)(0.32)$$\n$$\\sigma_S^2 = 0.006048 + 0.003168 + 0.01125 + 0.0012 + 0.0072$$\n$$\\sigma_S^2 = 0.028866$$\n标准差是方差的平方根：\n$$\\sigma_S = \\sqrt{0.028866}$$\n\n**步骤 5：标准化 PRS z-分数**\n标准化 PRS 为 $z = \\dfrac{S - \\mu_S}{\\sigma_S}$。\n$$z = \\frac{0.72 - 0.170}{\\sqrt{0.028866}} = \\frac{0.55}{\\sqrt{0.028866}}$$\n$$z \\approx \\frac{0.55}{0.16989997} \\approx 3.237216$$\n\n**步骤 6：个体绝对风险, $p$**\n绝对风险由一个带有线性预测子 $\\eta = \\alpha + \\gamma z$ 的逻辑斯谛模型确定。\n首先，根据基线发病率 $I_0 = 0.12$ 计算截距 $\\alpha$：\n$$\\alpha = \\ln\\left(\\frac{I_0}{1-I_0}\\right) = \\ln\\left(\\frac{0.12}{1-0.12}\\right) = \\ln\\left(\\frac{0.12}{0.88}\\right) = \\ln\\left(\\frac{3}{22}\\right)$$\n$$\\alpha \\approx -1.992430$$\n接下来，使用 $\\gamma = 0.35$ 和计算出的 $z$ 计算线性预测子 $\\eta$：\n$$\\eta = \\alpha + \\gamma z = \\ln\\left(\\frac{3}{22}\\right) + (0.35)\\left(\\frac{0.55}{\\sqrt{0.028866}}\\right)$$\n$$\\eta \\approx -1.992430 + (0.35)(3.237216) \\approx -1.992430 + 1.133026$$\n$$\\eta \\approx -0.859404$$\n最后，使用反-logit 函数计算绝对风险 $p$：\n$$p = \\frac{1}{1 + \\exp(-\\eta)}$$\n$$p = \\frac{1}{1 + \\exp(-(-0.859404))} = \\frac{1}{1 + \\exp(0.859404)}$$\n$$p \\approx \\frac{1}{1 + 2.36173} \\approx \\frac{1}{3.36173} \\approx 0.297464$$\n将最终结果四舍五入到四位有效数字，得到 $0.2975$。",
            "answer": "$$\\boxed{0.2975}$$"
        },
        {
            "introduction": "将基因组数据转化为可操作的临床建议是CDSS的最终目标。这项练习  将通过把一项临床药物遗传学实施联盟（Clinical Pharmacogenetics Implementation Consortium, CPIC）的药物基因组学指南编码到一个基于规则的系统中，来模拟真实世界CDSS模块的开发过程。您将学习如何处理患者数据和基因组表型，以生成具体、个性化的药物剂量建议，从而架起从基因型到临床行动的桥梁。",
            "id": "4324236",
            "problem": "您需要实现一个完整、可运行的程序，该程序将一项可操作的临床药理遗传学实施联盟 (CPIC) 指南建议编码为与临床决策支持 (CDS) Hooks 兼容的规则引擎触发器，并计算剂量建议，以便在电子健康记录 (EHR) 中呈现。目标是形式化最小输入（载荷）和决策逻辑，以根据硫嘌呤 S-甲基转移酶 (TPMT) 和 nudix 水解酶 15 (NUDT15) 的药物基因组学表型，生成定量的硫嘌呤类药物剂量建议。\n\n使用的基本依据：\n- 基因型-表型-治疗的模式根植于分子生物学中心法则和药物动力学：编码酶的基因中的遗传变异会改变酶的活性，从而改变活性代谢物的暴露量。这是药物基因组学经过充分验证的基础。\n- CPIC（临床药理遗传学实施联盟）为硫嘌呤类药物提供了基于 TPMT 和 NUDT15 表型的临床验证建议。您可以将下文中的表型-剂量调整类别视为经过充分验证的事实。\n- CDS Hooks 是一种事件驱动规范，当特定临床工作流事件发生时，服务会收到一个请求。钩子标识符和上下文决定了规则是否应该触发。\n\n最小载荷定义（作为一组键值约束）：\n- 请求是一个包含以下键的字典：\n  - \"hook\": 一个等于 \"medication-prescribe\" 的字符串。\n  - \"context\": 一个必须包含以下内容的字典：\n    - \"medication\": 一个不区分大小写的字符串，表示药物名称。\n    - \"standardDoseMg\": 一个以毫克为单位的实数值，代表临床医生为该患者输入的标准剂量。用 $D_s$ 表示，单位为 mg。\n  - \"prefetch\": 一个可能包含以下内容的字典：\n    - \"genomics\": 一个包含零个或多个字典的列表，每个字典包含：\n      - \"gene\": 一个不区分大小写的字符串，等于 \"TPMT\" 或 \"NUDT15\"。\n      - \"phenotype\": 一个不区分大小写的字符串，等于 \"Normal metabolizer\"、\"Intermediate metabolizer\" 或 \"Poor metabolizer\"。用 $P_{\\mathrm{TPMT}}$ 表示 TPMT 表型，用 $P_{\\mathrm{NUDT15}}$ 表示 NUDT15 表型。\n\n触发器语义：\n- 当且仅当 \"hook\" 的值等于 \"medication-prescribe\" 且 \"medication\" 的值在硫嘌呤类药物集合 {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"} 中（不区分大小写）时，规则才会触发。否则，不应应用任何药物基因组学调整。\n\n用作基础起点的剂量调整事实：\n- 对于 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 \"Normal metabolizer\" 的患者，初始剂量乘数为 $m = 1.0$。\n- 对于 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 中恰好有一个为 \"Intermediate metabolizer\" 且另一个为 \"Normal metabolizer\" 的患者，初始剂量乘数为 $m = 0.5$。\n- 对于 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 \"Intermediate metabolizer\" 的患者，初始剂量乘数为 $m = 0.2$。\n- 对于 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 任一为 \"Poor metabolizer\" 的患者，初始剂量乘数为 $m = 0.1$。\n- 如果 \"genomics\" 中缺少某个基因，则在计算 $m$ 时将该缺失基因视为 \"Normal metabolizer\"。\n- 如果规则未触发，则设置 $m = 1.0$。\n\n决策计算与输出：\n- 设 $D_s$ 是以毫克为单位的标准剂量。\n- 计算推荐剂量 $D_r = m \\times D_s$（单位：毫克）。\n- 使用四舍五入（即小数部分恰好为 $0.5$ 时向上舍入，远离零）将 $D_r$ 舍入到最接近的整数毫克。\n- 您的程序必须仅输出一行，其中包含指定测试套件的整数推荐值列表（以逗号分隔），并用方括号括起来。\n\n单位规范：\n- 所有剂量在舍入后必须以整数形式表示，单位为毫克 (mg)。\n\n角度和百分比规范：\n- 不使用角度。\n- 任何分数乘数都必须作为小数（例如，$0.5$）处理，而不是百分比。\n\n测试套件：\n对于下面的每个测试用例，构建载荷并计算最终的整数 $D_r$（单位：mg）。\n\n- 测试用例 1（理想路径，均为正常）：\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 2（单个中间型）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 3（一个基因为弱代谢型）：\n  - \"medication\" = \"thioguanine\"\n  - $D_s = 50$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Poor metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：是\n\n- 测试用例 4（均为中间型）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 40$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Intermediate metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Intermediate metabolizer\"\n  - 预期触发：是\n\n- 测试用例 5（缺少基因组学信息，默认行为）：\n  - \"medication\" = \"mercaptopurine\"\n  - $D_s = 60$ mg\n  - \"genomics\" 列表为空\n  - 预期触发：是\n\n- 测试用例 6（四舍五入检查）：\n  - \"medication\" = \"azathioprine\"\n  - $D_s = 35$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Poor metabolizer\"\n  - 预期触发：是\n\n- 测试用例 7（非目标药物，规则不触发）：\n  - \"medication\" = \"clopidogrel\"\n  - $D_s = 75$ mg\n  - $P_{\\mathrm{TPMT}}$ = \"Normal metabolizer\", $P_{\\mathrm{NUDT15}}$ = \"Normal metabolizer\"\n  - 预期触发：否\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含七个测试用例的结果，格式为逗号分隔的列表，并用方括号括起来（例如，\"[$x_1,x_2,x_3,x_4,x_5,x_6,x_7$]\"），其中每个 $x_i$ 是按顺序排列的第 $i$ 个测试用例的整数 $D_r$（单位：mg）。",
            "solution": "该问题要求形式化并实现一条基于临床药理遗传学实施联盟 (CPIC) 硫嘌呤类药物剂量指南的临床决策支持 (CDS) 规则。该实现必须与 CDS Hooks 规范兼容，将硫嘌呤 S-甲基转移酶 ($TPMT$) 和 nudix 水解酶 15 ($NUDT15$) 的药物基因组学表型转化为具体的剂量建议。该解决方案需要将所提供的临床逻辑系统地、一步步地转化为计算算法。\n\n首先，有必要对问题陈述进行验证。\n\n**步骤 1：提取已知条件**\n\n- **钩子规范**：规则由 CDS Hooks 请求触发，其中 `hook` 标识符为 `\"medication-prescribe\"`。\n- **触发药物集合**：如果所开的 `medication` 是 `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` 之一（不区分大小写），则规则适用。\n- **输入数据结构（载荷）**：\n  - `hook`：字符串，必须是 `\"medication-prescribe\"`。\n  - `context`：字典，包含：\n    - `medication`：字符串，药物名称。\n    - `standardDoseMg`：实数，标准剂量 $D_s$，单位为毫克 (mg)。\n  - `prefetch`：字典，可能包含：\n    - `genomics`：一个字典列表，每个字典包含：\n      - `gene`：字符串，`\"TPMT\"` 或 `\"NUDT15\"`（不区分大小写）。\n      - `phenotype`：字符串，`\"Normal metabolizer\"`、`\"Intermediate metabolizer\"` 或 `\"Poor metabolizer\"`（不区分大小写）。我们用 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 表示这些表型。\n- **剂量调整规则（乘数 $m$）**：\n  1. 如果触发条件未满足，剂量乘数 $m$ 为 $1.0$。\n  2. 如果某个基因的表型缺失，则假定其为 `\"Normal metabolizer\"`。\n  3. 如果 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 `\"Normal metabolizer\"`，则 $m = 1.0$。\n  4. 如果一个表型为 `\"Intermediate metabolizer\"` 而另一个为 `\"Normal metabolizer\"`，则 $m = 0.5$。\n  5. 如果 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 均为 `\"Intermediate metabolizer\"`，则 $m = 0.2$。\n  6. 如果 $P_{\\mathrm{TPMT}}$ 或 $P_{\\mathrm{NUDT15}}$ 任一为 `\"Poor metabolizer\"`，则 $m = 0.1$。\n- **计算与输出**：\n  - 推荐剂量计算公式为 $D_r = m \\times D_s$。\n  - 最终结果 $D_r$ 必须使用四舍五入规则舍入到最接近的整数。\n  - 输出为单行字符串，包含测试套件的逗号分隔的整数结果，并用方括号括起来。\n- **测试套件**：提供了七个具体的测试用例，定义了输入和预期的触发行为。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n- **科学依据**：该问题根植于已确立的药物基因组学原理，并引用了现实世界中基于证据的 CPIC 指南和 CDS Hooks 技术标准。$TPMT$/$NUDT15$ 基因变异、酶活性与硫嘌呤类药物代谢之间的关系是个性化医疗的基石。所提供的剂量调整因子是简化表示，但代表了实际的临床指南。该问题在科学上是合理的。\n- **适定性**：该问题是适定的。输入被严格定义，剂量调整的逻辑规则是确定性的，并涵盖了所有指定的组合，且明确说明了缺失数据的默认行为。计算和舍入规则是明确的，确保任何有效输入都有唯一的解。\n- **客观性**：该问题以精确、客观的语言陈述，没有歧义或主观论断。所有参数和规则都是定量的或逻辑的。\n\n**步骤 3：结论与行动**\n\n问题陈述是有效的。它具有科学依据、适定且客观。它为开发计算解决方案提供了一套完整且一致的需求。我们可以继续进行解决方案设计。\n\n**解决方案设计与算法**\n\n解决方案的核心是一个函数，它处理输入载荷，应用触发和剂量逻辑，并返回计算出的剂量。这个过程可以分解为四个主要阶段。\n\n**1. 规则触发评估**\n第一步是确定是否应应用基于药物基因组学的剂量规则。这取决于两个必须同时满足的条件：\n- CDS Hooks 调用的上下文必须是药物处方事件。通过检查输入 `hook` 键的值是否等于 `\"medication-prescribe\"` 来验证这一点。\n- 所开的药物必须是硫嘌呤类药物。通过检查 `medication` 键的不区分大小写的值是否存在于集合 `{\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}` 中来验证这一点。\n\n如果任一条件不满足，则规则不触发。在这种情况下，剂量乘数 $m$ 设置为 $1.0$，推荐剂量 $D_r$ 就是标准剂量 $D_s$。\n\n**2. 确定表型及默认值**\n如果规则触发，下一步是确定患者的 $TPMT$ 和 $NUDT15$ 代谢表型。问题指定了默认值：如果载荷的 `prefetch` 部分未提供某个基因的表型，则应将其视为 `\"Normal metabolizer\"`。\n因此，算法会将表型 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 初始化为 `\"Normal metabolizer\"`。然后，它遍历 `prefetch` 数据中的 `genomics` 列表。对于每个条目，它识别基因（例如 `\"TPMT\"` 或 `\"NUDT15\"`）及其对应的表型，并更新初始化的值。这个过程对于基因名称和表型描述都必须不区分大小写。\n\n**3. 剂量乘数 ($m$) 计算**\n在确定了 $P_{\\mathrm{TPMT}}$ 和 $P_{\\mathrm{NUDT15}}$ 之后，可以根据所提供的规则层次结构计算剂量乘数 $m$。为确保正确性，必须按优先级顺序评估这些规则，从最关键的表型（弱代谢型）开始。让我们将表型规范地表示为 NM（正常代谢型）、IM（中间代谢型）和 PM（弱代谢型）。\n\n逻辑如下：\n- **条件 1（最高优先级）**：如果 $P_{\\mathrm{TPMT}} = \\text{PM}$ 或 $P_{\\mathrm{NUDT15}} = \\text{PM}$，则设置 $m = 0.1$。此规则覆盖所有其他规则。\n- **条件 2**：否则，如果 $P_{\\mathrm{TPMT}} = \\text{IM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{IM}$，则设置 $m = 0.2$。\n- **条件 3**：否则，如果 ($P_{\\mathrm{TPMT}} = \\text{IM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{NM}$) 或 ($P_{\\mathrm{TPMT}} = \\text{NM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{IM}$)，则设置 $m = 0.5$。\n- **条件 4（基本情况）**：否则（这意味着 $P_{\\mathrm{TPMT}} = \\text{NM}$ 且 $P_{\\mathrm{NUDT15}} = \\text{NM}$），则设置 $m = 1.0$。\n\n这种结构化的评估确保了根据指定的临床逻辑选择正确的乘数。\n\n**4. 最终剂量计算与舍入**\n最后一步是计算推荐剂量 $D_r$，并按要求对其进行格式化。\n- 未舍入的推荐剂量通过以下公式计算：\n$$D_r = m \\times D_s$$\n其中 $D_s$ 是输入上下文中提供的标准剂量。\n- 问题指定使用四舍五入到最近的整数。对于非负值 $x$，这在计算上可以实现为 $\\lfloor x + 0.5 \\rfloor$，对于正数，这等同于 Python 中的 `int(x + 0.5)`。\n\n通过将这个四步过程应用于所提供套件中的每个测试用例，我们可以生成所需的整数剂量建议列表。最终的实现将此逻辑封装到一个完整、可运行的程序中。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to process test cases and print the final results.\n    \"\"\"\n\n    # Define the test cases from the problem statement as a list of dictionaries.\n    test_cases = [\n        # Test case 1 (happy path, both normal)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 2 (single intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 3 (poor for one gene)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"thioguanine\", \"standardDoseMg\": 50},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Poor metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n        # Test case 4 (both intermediate)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 40},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Intermediate metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Intermediate metabolizer\"},\n                ]\n            },\n        },\n        # Test case 5 (missing genomics, default behavior)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"mercaptopurine\", \"standardDoseMg\": 60},\n            \"prefetch\": {\"genomics\": []},\n        },\n        # Test case 6 (half-up rounding check)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"azathioprine\", \"standardDoseMg\": 35},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Poor metabolizer\"},\n                ]\n            },\n        },\n        # Test case 7 (non-target medication, rule does not trigger)\n        {\n            \"hook\": \"medication-prescribe\",\n            \"context\": {\"medication\": \"clopidogrel\", \"standardDoseMg\": 75},\n            \"prefetch\": {\n                \"genomics\": [\n                    {\"gene\": \"TPMT\", \"phenotype\": \"Normal metabolizer\"},\n                    {\"gene\": \"NUDT15\", \"phenotype\": \"Normal metabolizer\"},\n                ]\n            },\n        },\n    ]\n\n    results = [compute_recommendation(case) for case in test_cases]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef compute_recommendation(payload: dict) -> int:\n    \"\"\"\n    Computes a thiopurine dosing recommendation based on a CDS Hooks payload.\n\n    Args:\n        payload: A dictionary representing the CDS Hooks request.\n\n    Returns:\n        The recommended dose in milligrams, rounded to the nearest integer.\n    \"\"\"\n    \n    # Define constants for the rule logic.\n    THIOPURINES = {\"azathioprine\", \"mercaptopurine\", \"thioguanine\"}\n    \n    # Phenotype canonical representations for internal use.\n    NM = \"normal metabolizer\"\n    IM = \"intermediate metabolizer\"\n    PM = \"poor metabolizer\"\n\n    context = payload.get(\"context\", {})\n    standard_dose = context.get(\"standardDoseMg\", 0.0)\n    medication = context.get(\"medication\", \"\").lower()\n    hook = payload.get(\"hook\", \"\")\n\n    # 1. Rule Trigger Evaluation\n    # Rule triggers only for thiopurine prescriptions.\n    if not (hook == \"medication-prescribe\" and medication in THIOPURINES):\n        # If the rule doesn't trigger, use the standard dose (multiplier is 1.0).\n        # Rounding is still applied to handle potential float inputs.\n        return int(standard_dose + 0.5)\n\n    # 2. Phenotype Determination with Defaults\n    # Default phenotypes to \"Normal metabolizer\".\n    phenotypes = {\"tpmt\": NM, \"nudt15\": NM}\n\n    prefetch = payload.get(\"prefetch\", {})\n    genomics_data = prefetch.get(\"genomics\", [])\n    \n    for record in genomics_data:\n        gene = record.get(\"gene\", \"\").lower()\n        phenotype = record.get(\"phenotype\", \"\").lower()\n        if gene in phenotypes:\n            phenotypes[gene] = phenotype\n    \n    p_tpmt = phenotypes[\"tpmt\"]\n    p_nudt15 = phenotypes[\"nudt15\"]\n\n    # 3. Dose Multiplier (m) Calculation\n    # The rules are checked in order of highest precedence (most severe impact).\n    multiplier = 1.0  # Default multiplier\n\n    if p_tpmt == PM or p_nudt15 == PM:\n        multiplier = 0.1\n    elif p_tpmt == IM and p_nudt15 == IM:\n        multiplier = 0.2\n    elif (p_tpmt == IM and p_nudt15 == NM) or (p_tpmt == NM and p_nudt15 == IM):\n        multiplier = 0.5\n    elif p_tpmt == NM and p_nudt15 == NM:\n        multiplier = 1.0\n        \n    # 4. Final Dose Calculation and Rounding\n    recommended_dose_unrounded = multiplier * standard_dose\n    \n    # Apply half-up rounding. For positive numbers, int(x + 0.5) suffices.\n    final_dose = int(recommended_dose_unrounded + 0.5)\n    \n    return final_dose\n\nsolve()\n```"
        }
    ]
}