{
    "hands_on_practices": [
        {
            "introduction": "在临床流式细胞术中，获得细胞群的绝对计数至关重要，例如监测HIV感染者的CD4+ T细胞数量或评估细胞治疗的剂量。本实践将指导您通过基本原理推导使用参照微球进行绝对计数的公式，这是单平台绝对计数方法的核心。通过解决这个基于真实场景的计算问题，您将掌握将流式细胞仪事件数转化为具有临床意义的细胞浓度的基本技能 。",
            "id": "5124139",
            "problem": "使用流式细胞术对全血进行临床免疫分型分析，该分析采用荧光标记抗体识别白细胞，并结合基于微球的绝对计数策略。样本经过红细胞（RBCs）裂解，用抗分化簇45（CD45）抗体染色以圈门白细胞，并与浓度可溯源至标准品的校准微球均匀混合。在数据采集过程中，流式细胞仪吸取未知体积 $V_{a}$ 的混合液，并报告CD45阳性白细胞和微球的事件计数。假设以下基本原理：(i) 在均匀取样条件下，所吸取体积中计数的事件期望数等于分析物浓度与所吸取体积的乘积；(ii) 在同一混合液中，微球和白细胞的取样过程完全相同。\n\n从这些基本原理和浓度（单位体积内的事件数）的定义出发，推导白细胞绝对浓度 $C_{\\text{cells}}$ 的解析表达式，该表达式应使用记录的白细胞事件数 $N_{\\text{cells}}$、记录的微球事件数 $N_{\\text{beads}}$ 和已知的微球浓度 $C_{\\text{beads}}$ 来表示。除上述陈述外，不要假设任何有关仪器的知识。\n\n然后，使用您推导出的表达式，根据以下科学上合理的采集数据计算白细胞的绝对浓度：\n\n- 记录的CD45阳性白细胞事件数：$N_{\\text{cells}} = 85{,}000$。\n- 记录的微球事件数：$N_{\\text{beads}} = 12{,}345$。\n- 校准微球浓度：$C_{\\text{beads}} = 2.00 \\times 10^{6}$ 微球/毫升。\n\n最终浓度以细胞/毫升为单位表示，并将最终数值结果四舍五入至四位有效数字。",
            "solution": "问题陈述已经过严格评估，并被确定为有效。它科学地基于分析细胞学的原理，问题提出得当、客观，并包含得出唯一解所需的完整且一致的信息。因此，我们可以继续进行推导和计算。\n\n该问题要求根据陈述中提供的第一性原理，推导白细胞绝对浓度 $C_{\\text{cells}}$ 的解析表达式。让我们正式定义这些变量：\n- $C_{\\text{cells}}$：白细胞的绝对浓度（单位体积内的事件数）。\n- $N_{\\text{cells}}$：流式细胞仪记录的白细胞事件数。\n- $C_{\\text{beads}}$：已知的校准微球绝对浓度（单位体积内的事件数）。\n- $N_{\\text{beads}}$：流式细胞仪记录的微球事件数。\n- $V_{a}$：流式细胞仪吸取并分析的样本混合液的未知体积。\n\n推导从基本原理（i）开始：所吸取体积中计数的事件期望数等于分析物浓度与所吸取体积的乘积。这个原理可以对白细胞和微球分别用数学方式表达。\n\n对于白细胞，该关系为：\n$$ N_{\\text{cells}} = C_{\\text{cells}} \\cdot V_{a} \\quad (1) $$\n\n对于校准微球，同样的关系成立。基本原理（ii）指出，微球和白细胞的取样过程相同，这确保了相同的体积 $V_{a}$ 适用于两种事件类型。因此：\n$$ N_{\\text{beads}} = C_{\\text{beads}} \\cdot V_{a} \\quad (2) $$\n\n我们得到了一个由两个方程组成的方程组。目标是从已知量 $N_{\\text{cells}}$、$N_{\\text{beads}}$ 和 $C_{\\text{beads}}$ 中确定 $C_{\\text{cells}}$。体积 $V_{a}$ 是一个必须消去的未知无关参数。我们可以通过在一个方程中分离出 $V_{a}$ 并将其代入另一个方程来实现这一点。\n\n从方程（2）中，我们可以解出分析体积 $V_{a}$：\n$$ V_{a} = \\frac{N_{\\text{beads}}}{C_{\\text{beads}}} $$\n该表达式表示，在微球浓度为 $C_{\\text{beads}}$ 的情况下，为产生 $N_{\\text{beads}}$ 个计数所必须分析的样本体积。\n\n现在，我们将这个 $V_{a}$ 的表达式代入方程（1）：\n$$ N_{\\text{cells}} = C_{\\text{cells}} \\cdot \\left(\\frac{N_{\\text{beads}}}{C_{\\text{beads}}}\\right) $$\n\n最后，我们重新整理这个方程，解出我们所求的量，即白细胞绝对浓度 $C_{\\text{cells}}$：\n$$ C_{\\text{cells}} = \\frac{N_{\\text{cells}}}{N_{\\text{beads}}} \\cdot C_{\\text{beads}} $$\n这就是所求的解析表达式。它表明，未知的细胞浓度可以通过将已知的微球浓度乘以细胞计数与微球计数的比率来确定。这种比率法是流式细胞术中单平台绝对计数的基础，因为它避免了对分析体积进行精确、独立的测量。\n\n接下来，我们使用这个推导出的表达式来计算给定采集数据的白细胞绝对浓度：\n- 记录的CD45阳性白细胞事件数：$N_{\\text{cells}} = 85000$。\n- 记录的微球事件数：$N_{\\text{beads}} = 12345$。\n- 校准微球浓度：$C_{\\text{beads}} = 2.00 \\times 10^{6}$ 微球/毫升。\n\n将这些数值代入我们推導出的公式：\n$$ C_{\\text{cells}} = \\frac{85000}{12345} \\cdot (2.00 \\times 10^{6} \\text{ mL}^{-1}) $$\n\n首先，我们计算计数的比率：\n$$ \\frac{N_{\\text{cells}}}{N_{\\text{beads}}} = \\frac{85000}{12345} \\approx 6.8853787 $$\n\n然后，我们将这个无量纲的比率乘以微球浓度：\n$$ C_{\\text{cells}} \\approx 6.8853787 \\cdot (2.00 \\times 10^{6} \\text{ mL}^{-1}) $$\n$$ C_{\\text{cells}} \\approx 13.7707574 \\times 10^{6} \\text{ cells/mL} $$\n\n为了用标准科学记数法表示，我们调整尾数和指数：\n$$ C_{\\text{cells}} \\approx 1.37707574 \\times 10^{7} \\text{ cells/mL} $$\n\n问题要求将最终数值结果四舍五入至四位有效数字。前四位有效数字是 $1$、$3$、$7$ 和 $7$。第五位有效数字是 $0$，所以我们向下舍入（截断）。\n$$ C_{\\text{cells}} \\approx 1.377 \\times 10^{7} \\text{ cells/mL} $$",
            "answer": "$$\n\\boxed{1.377 \\times 10^{7}}\n$$"
        },
        {
            "introduction": "在免疫表型分析中，准确设定门控是区分阳性和阴性群体的关键，尤其是在处理表达较弱的标志物时，其界限往往模糊不清。本实践探讨了如何使用“荧光减一”（FMO）对照来设定具有统计学依据的门控阈值，这被认为是确定稀有或弱表达群体边界的金标准。通过这个练习，您将学会如何基于FMO群体的统计分布来设定一个客观的阈值，并深入理解在特异性（低假阳性）和灵敏度（低假阴性）之间进行权衡的必要性 。",
            "id": "5124163",
            "problem": "一项流式细胞术免疫分型实验旨在对白细胞亚群中一个低表达的标记进行门控。为了使用荧光扣除一 (FMO) 对照来设定一个符合统计学原理的阈值，假设以下具有科学依据的条件：(i) FMO对照的测量值用于量化在相同染色组合和仪器设置下，标记通道的背景荧光，(ii) 来自FMO对照的对数转换荧光强度 $L = \\ln(I)$ 能很好地用均值为 $\\mu_{\\text{FMO}}$、标准差为 $\\sigma_{\\text{FMO}}$ 的高斯分布来近似，以及 (iii) 门控在对数转换轴上进行，阈值定义在FMO均值以上三个标准差处，然后转换回线性强度轴进行报告。在此，$I$ 表示以任意单位 (a.u.) 计的荧光强度。荧光扣除一 (FMO) 是指包含了除目标标记物之外所有荧光染料的对照。\n\n现提供FMO分布在自然对数尺度上的估计参数：$\\mu_{\\text{FMO}} = 5.30$ 和 $\\sigma_{\\text{FMO}} = 0.40$。使用所述标准，在线性强度尺度上设置阈值门，并计算\n$$I_{\\text{gate}} = \\exp\\!\\big(\\mu_{\\text{FMO}} + 3\\,\\sigma_{\\text{FMO}}\\big).$$\n以任意荧光单位 (a.u.) 表示最终的门控阈值，并将您的答案四舍五入到四位有效数字。\n\n此外，请基于高斯分布的尾部特性以及 $L$ 和 $I$ 之间的单调映射关系，讨论将门设置在FMO均值以上三个标准差处所固有的假阳性与假阴性之间的权衡。您最终报告的答案必须是按上述规定计算出的 $I_{\\text{gate}}$ 的单一数值。",
            "solution": "该问题具有科学依据，定义明确且客观。它描述了一种在流式细胞术免疫分型中设定阈值的标准且符合统计学原理的方法。其中的假设，包括对数转换荧光数据的高斯近似以及使用荧光扣除一 (FMO) 对照，都是该领域中常用且经过验证的做法。所有必要的数据和定义都已提供，足以计算出唯一且有意义的答案。因此，该问题是有效的。\n\n主要任务是计算线性荧光强度尺度上的门控阈值 $I_{\\text{gate}}$。门控策略是在自然对数转换尺度 $L = \\ln(I)$ 上定义的。在这个对数尺度上，阈值 $L_{\\text{gate}}$ 被设定在FMO对照分布均值 ($\\mu_{\\text{FMO}}$) 以上三个标准差 ($3\\,\\sigma_{\\text{FMO}}$) 的位置。\n\n对数尺度阈值的计算公式如下：\n$$L_{\\text{gate}} = \\mu_{\\text{FMO}} + 3\\,\\sigma_{\\text{FMO}}$$\n\n问题提供了FMO对照在对数尺度上高斯分布的参数：\n- 均值: $\\mu_{\\text{FMO}} = 5.30$\n- 标准差: $\\sigma_{\\text{FMO}} = 0.40$\n\n将这些值代入 $L_{\\text{gate}}$ 的方程中：\n$$L_{\\text{gate}} = 5.30 + 3 \\times 0.40$$\n$$L_{\\text{gate}} = 5.30 + 1.20$$\n$$L_{\\text{gate}} = 6.50$$\n\n该值表示在对数转换荧光强度轴上的门控阈值。为了找到线性强度尺度上对应的阈值 $I_{\\text{gate}}$，我们必须对对数变换 $L = \\ln(I)$ 进行逆变换。逆变换是指数函数 $I = \\exp(L)$。\n\n将此变换应用于 $L_{\\text{gate}}$ 即可得到 $I_{\\text{gate}}$：\n$$I_{\\text{gate}} = \\exp(L_{\\text{gate}})$$\n$$I_{\\text{gate}} = \\exp(6.50)$$\n\n计算其数值：\n$$I_{\\text{gate}} \\approx 665.1416$$\n\n问题要求答案四舍五入到四位有效数字。前四位有效数字是 $6$、$6$、$5$ 和 $1$。第五位数字是 $4$，小于 $5$，因此我们向下舍入。\n$$I_{\\text{gate}} \\approx 665.1$$\n单位是任意荧光单位 (a.u.)。\n\n次要任务是讨论这种门控策略的权衡。阈值的选择本质上涉及假阳性（I型错误）和假阴性（II型错误）之间的权衡。\n\n当一个实际上是阴性的细胞（即其荧光属于背景FMO分布）因其强度落在门控之上 $I > I_{\\text{gate}}$ 而被分类为阳性时，就发生了**假阳性**。由于对数转换后的FMO数据被建模为高斯分布的随机变量 $L \\sim \\mathcal{N}(\\mu_{\\text{FMO}}, \\sigma_{\\text{FMO}}^2)$，因此假阳性的概率就是 $L > L_{\\text{gate}}$ 的概率。我们设定 $L_{\\text{gate}} = \\mu_{\\text{FMO}} + 3\\,\\sigma_{\\text{FMO}}$。因此，假阳性率是高斯分布中超出均值三个标准差的右上尾部分的面积。\n对于标准正态分布 $Z \\sim \\mathcal{N}(0, 1)$，这个概率是：\n$$P(\\text{False Positive}) = P(L > \\mu_{\\text{FMO}} + 3\\,\\sigma_{\\text{FMO}}) = P(Z > 3) \\approx 0.00135$$\n这对应于大约 $0.135\\%$ 的假阳性率。通过将门设置在 $3\\,\\sigma_{\\text{FMO}}$ 处，实验者选择保持一个非常低的将背景事件错误分类为阳性的比率。这优先保证了高特异性。\n\n当一个实际上是阳性的细胞（即表达目标标记物）因其强度落在门控或门控以下 $I \\le I_{\\text{gate}}$ 而被分类为阴性时，就发生了**假阴性**。假阴性率取决于*阳性*群体的荧光分布。我们假设阳性群体也服从对数正态分布，其特征参数为 $\\mu_{\\text{pos}}$ 和 $\\sigma_{\\text{pos}}$。如果来自该群体的细胞的对数强度 $L_{\\text{pos}} \\le L_{\\text{gate}}$，则会发生假阴性。\n问题指出标记是“低表达”的，这意味着阳性群体的分布与阴性（FMO）分布没有很好地分离；即 $\\mu_{\\text{pos}}$ 仅略大于 $\\mu_{\\text{FMO}}$。通过设定一个严格的（高的）阈值，如 $L_{\\text{gate}} = \\mu_{\\text{FMO}} + 3\\,\\sigma_{\\text{FMO}}$，来最小化假阳性，相当一部分的弱阳性群体可能会落在这个阈值以下。这导致了高的假阴性率，从而降低了灵敏度（检测真阳性的效能较低）。\n\n总而言之，权衡如下：\n- 一个更严格（更高）的门，例如设置在 $4\\,\\sigma_{\\text{FMO}}$ 处，会进一步降低假阳性率但增加假阴性率，使得检测弱信号变得更加困难。\n- 一个更宽松（更低）的门，例如设置在 $2\\,\\sigma_{\\text{FMO}}$ 处，会增加假阳性率（至约 $2.28\\%$）但降低假阴性率，从而改善对弱阳性群体的检测。\n\n$3\\,\\sigma_{\\text{FMO}}$ 的选择是一个常规的折衷方案，它在很大程度上偏向于特异性而非灵敏度。指数函数 $I = \\exp(L)$ 的单调性确保了门控决策及所有相关的错误概率在对数和线性尺度上是等效的。如果在对数尺度上 A > B，那么在线性尺度上 exp(A) > exp(B)。",
            "answer": "$$\n\\boxed{665.1}\n$$"
        },
        {
            "introduction": "现代流式细胞术分析正越来越多地采用计算方法来克服手动圈门的局限性。通过将细胞群体建模为统计分布的混合体，我们可以定量评估和优化圈门策略。本实践要求您构建一个计算模型，以模拟在简化的三参数（$FSC$、$SSC$、$CD45$）空间中，不同的矩形门控策略如何影响目标白细胞亚群的预期纯度。这个练习将使您能够从系统的角度理解不同细胞群之间的重叠如何影响分析结果，并为探索更高级的自动化圈门算法奠定基础 。",
            "id": "5124146",
            "problem": "您将获得一个流式细胞术免疫分型的概念模型，该模型包含以下通道：前向散射 ($FSC$)、侧向散射 ($SSC$) 和分化簇 $45$ ($CD45$) 表达，所有这些都以任意单位 (a.u.) 测量。其生物学基础是，$FSC$ 与细胞大小相关，$SSC$ 与细胞内部颗粒度相关，$CD45$ 在各类白细胞中表达，并具有亚群特异性的强度。假设有一个白细胞群体的混合物，其中每个群体在三个通道上均由独立的高斯分布表示，并采用矩形设门策略，通过对 $FSC$、$SSC$ 和 $CD45$ 的下界和上界来定义纳入标准。\n\n基本和核心定义：\n- 令观测事件的特征向量为 $\\mathbf{x} = (x_{F}, x_{S}, x_{45})$，其中 $x_{F}$ 是 $FSC$，$x_{S}$ 是 $SSC$，$x_{45}$ 是 $CD45$。\n- 考虑四个潜类别（群体）：淋巴细胞 ($L$)、单核细胞 ($M$)、粒细胞 ($G$) 和碎片/非白细胞 ($D$)。每个类别 $i \\in \\{L, M, G, D\\}$ 从各通道上独立正态分布的乘积生成 $\\mathbf{x}$，其均值为 $\\boldsymbol{\\mu}_i = (\\mu_{i,F}, \\mu_{i,S}, \\mu_{i,45})$，标准差为 $\\boldsymbol{\\sigma}_i = (\\sigma_{i,F}, \\sigma_{i,S}, \\sigma_{i,45})$。\n- 混合比例为 $\\mathbf{w} = (w_L, w_M, w_G, w_D)$，且满足 $\\sum_i w_i = 1$ 和 $w_i \\ge 0$。\n- 一个矩形门 $R$ 由下界 $\\mathbf{L} = (L_F, L_S, L_{45})$ 和上界 $\\mathbf{U} = (U_F, U_S, U_{45})$ 定义，对于每个通道 $k \\in \\{F,S,45\\}$，都有 $L_k \\le U_k$。\n- 对于给定的类别 $i$ 和门 $R$，在该类别分布下，门内概率为\n$$\nP_i(R) = \\prod_{k \\in \\{F,S,45\\}} \\left[ \\Phi\\!\\left(\\frac{U_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) - \\Phi\\!\\left(\\frac{L_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) \\right],\n$$\n其中 $\\Phi(\\cdot)$ 是标准正态累积分布函数。\n- 在该混合模型下，所有落入 $R$ 内的事件的期望总分数为\n$$\nT(R) = \\sum_{i \\in \\{L,M,G,D\\}} w_i \\, P_i(R).\n$$\n- 如果门 $R$ 被设计为靶向特定类别 $t \\in \\{L,M,G\\}$，则定义期望纯度（以 $[0,1]$ 范围的小数表示）为\n$$\n\\mathrm{Purity}_t(R) = \n\\begin{cases}\n\\dfrac{w_t \\, P_t(R)}{T(R)}  \\text{if } T(R) > \\epsilon, \\\\\n0.0  \\text{if } T(R) \\le \\epsilon,\n\\end{cases}\n$$\n其中 $\\epsilon = 10^{-12}$。\n\n使用以下科学上合理的参数化，该参数化编码了免疫分型中观察到的典型分离情况：\n- 均值 (a.u.):\n  - 淋巴细胞 $L$: $\\boldsymbol{\\mu}_L = (300, 200, 800)$\n  - 单核细胞 $M$: $\\boldsymbol{\\mu}_M = (500, 400, 600)$\n  - 粒细胞 $G$: $\\boldsymbol{\\mu}_G = (700, 700, 400)$\n  - 碎片 $D$: $\\boldsymbol{\\mu}_D = (100, 100, 100)$\n- 标准差 (a.u.):\n  - 淋巴细胞 $L$: $\\boldsymbol{\\sigma}_L = (50, 50, 50)$\n  - 单核细胞 $M$: $\\boldsymbol{\\sigma}_M = (60, 60, 60)$\n  - 粒细胞 $G$: $\\boldsymbol{\\sigma}_G = (70, 70, 70)$\n  - 碎片 $D$: $\\boldsymbol{\\sigma}_D = (40, 40, 40)$\n- 混合比例 (分数):\n  - $\\mathbf{w} = (w_L, w_M, w_G, w_D) = (0.35, 0.10, 0.45, 0.10)$\n\n您的任务是实现一个程序，在上述独立高斯和混合物假设下，为靶向每个白细胞亚群的门计算期望纯度。门在 $(FSC, SSC, CD45)$ 空间中是矩形的，如下所示。所有边界均以任意单位 (a.u.) 给出。\n\n设门策略测试集：\n- 情况 $1$ (标准设门):\n  - 靶向 $L$ 的门: $\\mathbf{L} = (250, 150, 700)$, $\\mathbf{U} = (400, 350, 1000)$\n  - 靶向 $M$ 的门: $\\mathbf{L} = (420, 320, 500)$, $\\mathbf{U} = (600, 520, 750)$\n  - 靶向 $G$ 的门: $\\mathbf{L} = (600, 600, 300)$, $\\mathbf{U} = (850, 900, 600)$\n- 情况 $2$ (窄单核细胞门):\n  - 靶向 $L$ 的门: $\\mathbf{L} = (250, 150, 700)$, $\\mathbf{U} = (400, 350, 1000)$\n  - 靶向 $M$ 的门: $\\mathbf{L} = (495, 395, 585)$, $\\mathbf{U} = (505, 405, 615)$\n  - 靶向 $G$ 的门: $\\mathbf{L} = (600, 600, 300)$, $\\mathbf{U} = (850, 900, 600)$\n- 情况 $3$ (重叠的淋巴-单核细胞门):\n  - 靶向 $L$ 的门: $\\mathbf{L} = (350, 300, 650)$, $\\mathbf{U} = (520, 500, 850)$\n  - 靶向 $M$ 的门: $\\mathbf{L} = (420, 320, 500)$, $\\mathbf{U} = (600, 520, 750)$\n  - 靶向 $G$ 的门: $\\mathbf{L} = (600, 600, 300)$, $\\mathbf{U} = (850, 900, 600)$\n- 情况 $4$ (极高值门，近空区域):\n  - 靶向 $L$ 的门: $\\mathbf{L} = (950, 950, 950)$, $\\mathbf{U} = (1000, 1000, 1000)$\n  - 靶向 $M$ 的门: $\\mathbf{L} = (950, 950, 950)$, $\\mathbf{U} = (1000, 1000, 1000)$\n  - 靶向 $G$ 的门: $\\mathbf{L} = (950, 950, 950)$, $\\mathbf{U} = (1000, 1000, 1000)$\n\n程序要求：\n- 使用上述定义和提供的参数，为每种情况下的每个门实现 $\\mathrm{Purity}_t(R)$ 的计算。所有纯度必须表示为 $[0,1]$ 范围的小数。\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，每种情况贡献一个包含三个纯度的列表，顺序为靶向 $L$、靶向 $M$ 和靶向 $G$。例如，输出必须具有 $[[p_{1,L},p_{1,M},p_{1,G}],[p_{2,L},p_{2,M},p_{2,G}],[p_{3,L},p_{3,M},p_{3,G}],[p_{4,L},p_{4,M},p_{4,G}]]$ 的形式，所有条目均为十进制浮点数。",
            "solution": "本问题要求在一个简化的流式细胞术免疫分型模型中，为各种设门策略计算期望纯度。该模型基于四种不同细胞群体的混合物，每种群体在前向散射 ($FSC$)、侧向散射 ($SSC$) 和 $CD45$ 表达这些特征上由一个三元高斯分布来表征。所提供的均值、标准差和混合比例等参数在科学上是合理的，并反映了典型的白细胞分化模式。该问题定义明确、数学上一致且有科学依据；因此，它是有效的。\n\n解决方案通过算法化地编码所提供的数学定义来实现。任务的核心是计算特定矩形门内目标群体的纯度。对于每个门和目标群体的组合，这涉及三个主要的计算步骤。\n\n首先，我们必须计算来自给定类别 $i \\in \\{L, M, G, D\\}$ 的一个事件落入指定的矩形门 $R$ 内的概率。门 $R$ 由其下界 $\\mathbf{L} = (L_F, L_S, L_{45})$ 和上界 $\\mathbf{U} = (U_F, U_S, U_{45})$ 定义。问题指出，每个类别的特征都服从独立的正态分布。对于单个通道 $k \\in \\{F, S, 45\\}$，来自类别 $i$ 的事件落入 $L_k$ 和 $U_k$ 之间的概率由正态概率密度函数的积分给出：\n$$ P(\\text{event from } i \\text{ has } x_k \\in [L_k, U_k]) = \\int_{L_k}^{U_k} \\frac{1}{\\sqrt{2\\pi}\\sigma_{i,k}} e^{-\\frac{(x - \\mu_{i,k})^2}{2\\sigma_{i,k}^2}} dx $$\n在对边界进行标准化后，该积分可以使用标准正态累积分布函数 ($\\mathrm{CDF}$)，记为 $\\Phi(\\cdot)$ 来计算：\n$$ P(\\dots) = \\Phi\\left(\\frac{U_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) - \\Phi\\left(\\frac{L_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) $$\n由于通道 ($FSC$, $SSC$, $CD45$) 之间相互独立的假设，类别 $i$ 的总门内概率 $P_i(R)$ 是每个通道概率的乘积：\n$$ P_i(R) = \\prod_{k \\in \\{F,S,45\\}} \\left[ \\Phi\\left(\\frac{U_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) - \\Phi\\left(\\frac{L_k - \\mu_{i,k}}{\\sigma_{i,k}}\\right) \\right] $$\n对四个类别 ($L$、$M$、$G$、$D$) 中的每一个都执行此计算。\n\n其次，我们确定所有事件（来自任何类别）中落入门 $R$ 内的期望总分数。这是任意事件落入 $R$ 内的总概率，根据全概率定律，它是每个类别门内概率的加权和。权重是混合比例 $w_i$。\n$$ T(R) = \\sum_{i \\in \\{L,M,G,D\\}} w_i \\, P_i(R) $$\n这个量 $T(R)$ 代表门 $R$ 的总产出率。\n\n第三，我们计算门 $R$ 对目标群体 $t \\in \\{L,M,G\\}$ 的纯度。纯度定义为在事件已落入门 $R$ 的条件下，该事件属于类别 $t$ 的条件概率。这是贝叶斯定理的直接应用：\n$$ \\mathrm{Purity}_t(R) = P(\\text{class}=t \\,|\\, \\mathbf{x} \\in R) = \\frac{P(\\mathbf{x} \\in R \\,|\\, \\text{class}=t) P(\\text{class}=t)}{P(\\mathbf{x} \\in R)} $$\n代入我们模型中的各项：\n- $P(\\mathbf{x} \\in R \\,|\\, \\text{class}=t) = P_t(R)$\n- $P(\\text{class}=t) = w_t$\n- $P(\\mathbf{x} \\in R) = T(R)$\n这给出了纯度的计算公式：\n$$ \\mathrm{Purity}_t(R) = \\frac{w_t \\, P_t(R)}{T(R)} $$\n为了处理门被设置在几乎没有事件的区域的情况，使用了一个数值稳定性阈值 $\\epsilon = 10^{-12}$。如果 $T(R)$ 低于此阈值，则纯度定义为 $0.0$，以避免除以一个接近零的数，并反映空门的纯度为零。\n\n实现部分会将给定的参数 ($\\boldsymbol{\\mu}_i$、$\\boldsymbol{\\sigma}_i$、$w_i$) 和每个测试用例的门定义存储在合适的数据结构中，例如字典和列表。将创建一个函数，使用 `scipy.stats.norm.cdf` 来计算 $\\Phi(\\cdot)$，并使用 `numpy` 数组进行高效的向量化计算，从而计算出 $P_i(R)$。程序的主要部分会遍历四个测试用例中的每一个。对于每个用例，它会使用各自的门计算三个目标群体 ($L$、$M$、$G$) 的纯度。每个用例产生的结果纯度被收集到一个列表中，最终输出是一个包含所有四个用例结果的列表，并按指定格式进行格式化。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef solve():\n    \"\"\"\n    Computes expected purities for leukocyte gates in a flow cytometry model.\n    \"\"\"\n    # Define the model parameters: means, standard deviations, and mixture weights.\n    params = {\n        'L': {'mu': np.array([300, 200, 800]), 'sigma': np.array([50, 50, 50]), 'w': 0.35},\n        'M': {'mu': np.array([500, 400, 600]), 'sigma': np.array([60, 60, 60]), 'w': 0.10},\n        'G': {'mu': np.array([700, 700, 400]), 'sigma': np.array([70, 70, 70]), 'w': 0.45},\n        'D': {'mu': np.array([100, 100, 100]), 'sigma': np.array([40, 40, 40]), 'w': 0.10}\n    }\n    class_keys = ['L', 'M', 'G', 'D']\n    target_keys = ['L', 'M', 'G']\n    epsilon = 1e-12\n\n    # Define the test suite of gating strategies.\n    test_cases = [\n        # Case 1 (standard gating)\n        {\n            'L': {'L_bounds': np.array([250, 150, 700]), 'U_bounds': np.array([400, 350, 1000])},\n            'M': {'L_bounds': np.array([420, 320, 500]), 'U_bounds': np.array([600, 520, 750])},\n            'G': {'L_bounds': np.array([600, 600, 300]), 'U_bounds': np.array([850, 900, 600])}\n        },\n        # Case 2 (narrow monocyte gate)\n        {\n            'L': {'L_bounds': np.array([250, 150, 700]), 'U_bounds': np.array([400, 350, 1000])},\n            'M': {'L_bounds': np.array([495, 395, 585]), 'U_bounds': np.array([505, 405, 615])},\n            'G': {'L_bounds': np.array([600, 600, 300]), 'U_bounds': np.array([850, 900, 600])}\n        },\n        # Case 3 (overlapping lymphocyte-monocyte gate)\n        {\n            'L': {'L_bounds': np.array([350, 300, 650]), 'U_bounds': np.array([520, 500, 850])},\n            'M': {'L_bounds': np.array([420, 320, 500]), 'U_bounds': np.array([600, 520, 750])},\n            'G': {'L_bounds': np.array([600, 600, 300]), 'U_bounds': np.array([850, 900, 600])}\n        },\n        # Case 4 (extreme high gate, near-empty region)\n        {\n            'L': {'L_bounds': np.array([950, 950, 950]), 'U_bounds': np.array([1000, 1000, 1000])},\n            'M': {'L_bounds': np.array([950, 950, 950]), 'U_bounds': np.array([1000, 1000, 1000])},\n            'G': {'L_bounds': np.array([950, 950, 950]), 'U_bounds': np.array([1000, 1000, 1000])}\n        }\n    ]\n\n    def calculate_Pi_R(L_bounds, U_bounds, mu, sigma):\n        \"\"\"\n        Calculates the in-gate probability P_i(R) for a single class i.\n        \"\"\"\n        # Standardize the gate bounds\n        z_lower = (L_bounds - mu) / sigma\n        z_upper = (U_bounds - mu) / sigma\n        # Calculate probability for each independent channel using the standard normal CDF\n        prob_per_channel = norm.cdf(z_upper) - norm.cdf(z_lower)\n        # Total probability is the product over all channels\n        return np.prod(prob_per_channel)\n\n    all_results = []\n    for case in test_cases:\n        case_results = []\n        for target_t in target_keys:\n            gate = case[target_t]\n            L_bounds = gate['L_bounds']\n            U_bounds = gate['U_bounds']\n\n            # Calculate P_i(R) for all classes using the current gate\n            Pi_R = {\n                cls: calculate_Pi_R(L_bounds, U_bounds, params[cls]['mu'], params[cls]['sigma'])\n                for cls in class_keys\n            }\n\n            # Calculate the total fraction of events in the gate, T(R)\n            T_R = sum(params[cls]['w'] * Pi_R[cls] for cls in class_keys)\n            \n            # Calculate purity for the target class\n            if T_R > epsilon:\n                purity = (params[target_t]['w'] * Pi_R[target_t]) / T_R\n            else:\n                purity = 0.0\n            \n            case_results.append(purity)\n        all_results.append(case_results)\n\n    # Format the final output string as a list of lists of floats.\n    # e.g., [[p1L,p1M,p1G],[p2L,p2M,p2G],...]\n    output_str = f\"[{','.join([f'[{\",\".join(map(str, r))}]' for r in all_results])}]\"\n    print(output_str)\n\nsolve()\n```"
        }
    ]
}