{
    "hands_on_practices": [
        {
            "introduction": "To effectively use Organ-on-Chip (OOC) systems for diagnostic modeling, one must first master the fundamental principles of mass transport. This practice lays the groundwork by developing a mathematical model for biomarker concentration dynamics within a perfused microfluidic chamber . By constructing and solving a mass balance equation that accounts for secretion, fluid flow, and degradation, you will derive the analytical expression that governs how a biomarker accumulates, providing a cornerstone for interpreting experimental data.",
            "id": "5145123",
            "problem": "An Organ-on-Chip (OOC) microfluidic device is used to model the secretion and fate of a diagnostic biomarker produced by a living tissue compartment under continuous perfusion. The device has a well-mixed effective perfusate volume $V$ through which a constant volumetric flow rate $Q$ of fresh medium (with biomarker concentration $0$ at the inlet) is maintained. The tissue secretes the biomarker into the perfusate at a constant molar production rate $R$ (in $\\text{mol}\\,\\text{s}^{-1}$). The biomarker is subject to first-order degradation in the perfusate with half-life $t_{1/2}$ due to proteolysis and adsorption to matrix components. Assume perfect mixing in $V$, negligible wall adsorption relative to bulk first-order degradation, and that the measured outlet concentration equals the well-mixed chamber concentration.\n\nStarting from the mass conservation statement, “accumulation equals inflow minus outflow plus generation minus degradation,” and using the definition of first-order decay and the half-life concept $C(t_{1/2}) = C(0)/2$, derive the analytical expression for the outlet concentration $C_{\\text{out}}(t)$ as a function of $t$, $t_{1/2}$, $Q$, $V$, and $R$, given the initial condition $C_{\\text{out}}(0) = 0$ and a step onset of secretion at $t = 0$.\n\nExpress your final analytical expression for $C_{\\text{out}}(t)$ in $\\text{mol}\\,\\text{m}^{-3}$, using time $t$ in $\\text{s}$ and parameters in consistent SI units. No numerical evaluation is required.",
            "solution": "The problem is scientifically grounded, well-posed, and provides a complete set of consistent information to derive the requested analytical expression. The model described is a standard continuous stirred-tank reactor (CSTR) model with a first-order decay term, which is a fundamental concept in chemical engineering and biotransport phenomena. The derivation proceeds by formalizing the provided mass balance statement into a solvable ordinary differential equation.\n\nLet $C(t)$ be the concentration of the biomarker in the well-mixed volume $V$ at time $t$. The problem states that the outlet concentration is equal to the chamber concentration, so $C_{\\text{out}}(t) = C(t)$. The number of moles of the biomarker in the volume is $n(t) = V C(t)$. The mass conservation principle is stated as: rate of accumulation = rate of inflow - rate of outflow + rate of generation - rate of degradation. We will formulate each term for the number of moles of the biomarker.\n\n1.  **Rate of Accumulation**: This is the rate of change of the number of moles in the volume $V$. Since $V$ is a constant, the accumulation rate is $\\frac{dn}{dt} = \\frac{d(VC)}{dt} = V\\frac{dC}{dt}$.\n\n2.  **Rate of Inflow**: The volumetric flow rate is $Q$ and the biomarker concentration in the inflow is $0$. The molar inflow rate is $Q \\times C_{\\text{in}} = Q \\times 0 = 0$.\n\n3.  **Rate of Outflow**: The perfusate leaves at a flow rate $Q$ with the chamber concentration $C(t)$. The molar outflow rate is $Q C(t)$.\n\n4.  **Rate of Generation**: The tissue secretes the biomarker at a constant rate $R$, given in units of $\\text{mol}\\,\\text{s}^{-1}$.\n\n5.  **Rate of Degradation**: The degradation is a first-order process, meaning its rate is proportional to the number of moles present, $n(t)$. The degradation rate is $k n(t) = k V C(t)$, where $k$ is the first-order rate constant in units of $\\text{s}^{-1}$. The problem provides the half-life $t_{1/2}$. The relationship between the rate constant $k$ and the half-life $t_{1/2}$ for a first-order process is derived from the decay equation $C(t) = C(0)\\exp(-kt)$. By definition, at $t=t_{1/2}$, $C(t_{1/2}) = C(0)/2$. Substituting this gives $\\frac{C(0)}{2} = C(0)\\exp(-kt_{1/2})$, which simplifies to $\\frac{1}{2} = \\exp(-kt_{1/2})$. Taking the natural logarithm of both sides yields $\\ln(\\frac{1}{2}) = -kt_{1/2}$, or $-\\ln(2) = -kt_{1/2}$. Thus, the rate constant is $k = \\frac{\\ln(2)}{t_{1/2}}$. The degradation rate is therefore $\\frac{\\ln(2)}{t_{1/2}} V C(t)$.\n\nAssembling these terms into the mass balance equation:\n$$V\\frac{dC}{dt} = 0 - Q C(t) + R - \\frac{\\ln(2)}{t_{1/2}} V C(t)$$\nThis is a first-order linear ordinary differential equation. We can rearrange it into the standard form $\\frac{dy}{dx} + P(x)y = Q(x)$.\n$$V\\frac{dC}{dt} + Q C(t) + \\frac{\\ln(2)}{t_{1/2}} V C(t) = R$$\n$$\\frac{dC}{dt} + \\left(\\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}\\right) C(t) = \\frac{R}{V}$$\nLet us define a constant $\\lambda = \\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}$. The ODE simplifies to:\n$$\\frac{dC}{dt} + \\lambda C(t) = \\frac{R}{V}$$\nThis equation can be solved using an integrating factor, $I(t) = \\exp\\left(\\int \\lambda dt\\right) = \\exp(\\lambda t)$. Multiplying the ODE by $I(t)$ gives:\n$$\\exp(\\lambda t) \\frac{dC}{dt} + \\lambda \\exp(\\lambda t) C(t) = \\frac{R}{V} \\exp(\\lambda t)$$\nThe left side is the derivative of the product $C(t) I(t)$:\n$$\\frac{d}{dt}\\left(C(t)\\exp(\\lambda t)\\right) = \\frac{R}{V} \\exp(\\lambda t)$$\nIntegrating both sides with respect to $t$:\n$$\\int \\frac{d}{dt}\\left(C(t)\\exp(\\lambda t)\\right) dt = \\int \\frac{R}{V} \\exp(\\lambda t) dt$$\n$$C(t)\\exp(\\lambda t) = \\frac{R}{V\\lambda} \\exp(\\lambda t) + K$$\nwhere $K$ is the constant of integration. Solving for $C(t)$ yields the general solution:\n$$C(t) = \\frac{R}{V\\lambda} + K \\exp(-\\lambda t)$$\nTo find $K$, we apply the initial condition $C(0) = 0$.\n$$C(0) = 0 = \\frac{R}{V\\lambda} + K \\exp(0)$$\n$$0 = \\frac{R}{V\\lambda} + K \\implies K = -\\frac{R}{V\\lambda}$$\nSubstituting $K$ back into the general solution gives the particular solution:\n$$C(t) = \\frac{R}{V\\lambda} - \\frac{R}{V\\lambda} \\exp(-\\lambda t) = \\frac{R}{V\\lambda} \\left(1 - \\exp(-\\lambda t)\\right)$$\nFinally, we substitute the expression for $\\lambda$ back into the solution:\n$$C(t) = \\frac{R}{V\\left(\\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}\\right)} \\left(1 - \\exp\\left(-\\left(\\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}\\right)t\\right)\\right)$$\nSimplifying the denominator of the pre-factor:\n$$C(t) = \\frac{R}{Q + V\\frac{\\ln(2)}{t_{1/2}}} \\left(1 - \\exp\\left(-\\left(\\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}\\right)t\\right)\\right)$$\nSince the problem specifies that the outlet concentration $C_{\\text{out}}(t)$ is equal to the chamber concentration $C(t)$, this expression is the final answer.",
            "answer": "$$\\boxed{\\frac{R}{Q + V \\frac{\\ln(2)}{t_{1/2}}} \\left(1 - \\exp\\left(-\\left(\\frac{Q}{V} + \\frac{\\ln(2)}{t_{1/2}}\\right)t\\right)\\right)}$$"
        },
        {
            "introduction": "A major challenge in translating OOC diagnostics into reliable clinical tools is ensuring consistency and comparability of results across different batches of microfluidic chips. This exercise tackles the real-world problem of calibration transfer, where measurements from a new device lot must be harmonized with a validated reference standard . By applying orthogonal regression, a statistical method that accounts for measurement error in both systems, you will learn to calculate the correct calibration function and quantify the diagnostic bias that arises from lot-to-lot variation.",
            "id": "5145035",
            "problem": "A laboratory consortium uses Organ-on-Chip (OoC) systems to quantify cytokine release, and diagnostic modeling requires consistent calibration across microfluidic immunoassay chip lots. Consider two lots: a reference lot that has been validated to read concentrations without systematic bias and a new lot that must be calibrated to the reference. The transfer calibration is modeled by a straight line $y = a + m x$, where $x$ denotes the measurement from the reference lot and $y$ denotes the measurement from the new lot. Because both $x$ and $y$ carry measurement uncertainty, the calibration is performed using orthogonal regression (Deming regression), with an error variance ratio $\\lambda = \\sigma_{y}^{2} / \\sigma_{x}^{2}$ established from replicate spiked controls.\n\nYou are provided summary statistics computed from $n$ matched calibrator pairs $\\{(x_{i}, y_{i})\\}_{i=1}^{n}$ spanning the clinically relevant dynamic range:\n- Sample means: $\\bar{x} = 1.20\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$, $\\bar{y} = 1.26\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$.\n- Centered second moments: $S_{xx} = 0.040\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$, $S_{yy} = 0.052\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$, $S_{xy} = 0.047\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$, where $S_{xx} = \\frac{1}{n}\\sum_{i=1}^{n}(x_{i} - \\bar{x})^{2}$, $S_{yy} = \\frac{1}{n}\\sum_{i=1}^{n}(y_{i} - \\bar{y})^{2}$, and $S_{xy} = \\frac{1}{n}\\sum_{i=1}^{n}(x_{i} - \\bar{x})(y_{i} - \\bar{y})$.\n- Error variance ratio: $\\lambda = 1.20$.\n\nA clinical decision threshold validated on the reference lot is $x_{\\mathrm{th}} = 1.50\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$. If a receiving laboratory mistakenly applies the same numeric threshold on the new lot without calibration transfer (i.e., uses $y_{\\mathrm{used}} = x_{\\mathrm{th}}$ instead of the correct transferred threshold $y_{\\mathrm{correct}} = a + m x_{\\mathrm{th}}$), the bias in the applied diagnostic threshold on the new lot is defined as $b = y_{\\mathrm{used}} - y_{\\mathrm{correct}}$.\n\nStarting from the measurement error model assumptions and the definition of orthogonal regression with ratio $\\lambda$, derive the expressions needed to obtain the orthogonal regression slope $m$ and intercept $a$ from the provided summary statistics, compute $m$ and $a$, and then compute the bias $b$ at $x_{\\mathrm{th}}$. Express the final bias $b$ in $\\mathrm{ng}\\,\\mathrm{mL}^{-1}$ and round your answer to three significant figures.",
            "solution": "The problem is valid. It is a scientifically grounded, well-posed, and objective problem in applied statistics, specifically concerning method comparison and calibration transfer using Deming regression, which is appropriate for the stated context of organ-on-chip diagnostics. All necessary data and definitions are provided, and they are internally consistent and realistic.\n\nThe task is to determine the bias in a clinical decision threshold when a new diagnostic lot is used without proper calibration transfer. The calibration relationship between the reference lot measurements, $x$, and the new lot measurements, $y$, is given by a linear model, $y = a + m x$. Since both measurement systems have inherent uncertainty, the parameters $m$ (slope) and $a$ (intercept) must be estimated using Deming regression, a form of errors-in-variables model that minimizes the weighted sum of squared residuals in both $x$ and $y$ dimensions. The regression requires a known ratio of the error variances, $\\lambda = \\sigma_{y}^{2} / \\sigma_{x}^{2}$.\n\nThe Deming regression line is guaranteed to pass through the centroid of the data, $(\\bar{x}, \\bar{y})$. This allows the intercept $a$ to be calculated directly from the slope $m$ and the sample means:\n$$a = \\bar{y} - m\\bar{x}$$\n\nThe slope $m$ is determined by minimizing the objective function associated with the weighted orthogonal distances. The standard formula for the Deming regression slope, derived from this minimization and expressed in terms of the provided summary statistics ($S_{xx}$, $S_{yy}$, $S_{xy}$) and the error variance ratio ($\\lambda$), is:\n$$m = \\frac{(S_{yy} - \\lambda S_{xx}) + \\sqrt{(S_{yy} - \\lambda S_{xx})^2 + 4 \\lambda S_{xy}^2}}{2 S_{xy}}$$\nThe sign of the square root is chosen to match the sign of the sample covariance $S_{xy}$. Since $S_{xy} > 0$ in this problem, we use the positive root.\n\nWe are given the following summary statistics:\n- Sample means: $\\bar{x} = 1.20\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$, $\\bar{y} = 1.26\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$.\n- Centered second moments: $S_{xx} = 0.040\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$, $S_{yy} = 0.052\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$, $S_{xy} = 0.047\\,(\\mathrm{ng}\\,\\mathrm{mL}^{-1})^{2}$.\n- Error variance ratio: $\\lambda = 1.20$.\n\nFirst, we compute the slope $m$.\nLet's calculate the components of the slope formula.\nThe term $S_{yy} - \\lambda S_{xx}$ is:\n$$S_{yy} - \\lambda S_{xx} = 0.052 - (1.20)(0.040) = 0.052 - 0.048 = 0.004$$\nThe term under the square root (the discriminant) is:\n$$(S_{yy} - \\lambda S_{xx})^2 + 4 \\lambda S_{xy}^2 = (0.004)^2 + 4(1.20)(0.047)^2$$\n$$= 0.000016 + 4.8 \\times 0.002209 = 0.000016 + 0.0106032 = 0.0106192$$\nTaking the square root:\n$$\\sqrt{0.0106192} \\approx 0.1030495$$\nThe denominator is $2 S_{xy}$:\n$$2 S_{xy} = 2(0.047) = 0.094$$\nNow, we can assemble the slope $m$:\n$$m = \\frac{0.004 + 0.1030495}{0.094} = \\frac{0.1070495}{0.094} \\approx 1.1388245$$\n\nNext, we compute the intercept $a$ using the formula $a = \\bar{y} - m\\bar{x}$:\n$$a = 1.26 - (1.1388245)(1.20) = 1.26 - 1.3665894 \\approx -0.1065894$$\nSo, the calibration transfer function is approximately $y = -0.1065894 + 1.1388245 x$.\n\nThe problem defines the bias, $b$, resulting from the failure to apply this calibration to a clinical threshold. The reference threshold is $x_{\\mathrm{th}} = 1.50\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$. If this value is mistakenly used on the new lot, then $y_{\\mathrm{used}} = x_{\\mathrm{th}} = 1.50\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$.\nThe correct threshold on the new lot, $y_{\\mathrm{correct}}$, is found by applying the calibration transfer function:\n$$y_{\\mathrm{correct}} = a + m x_{\\mathrm{th}}$$\nSubstituting the values we found for $a$, $m$, and the given $x_{\\mathrm{th}}$:\n$$y_{\\mathrm{correct}} = (-0.1065894) + (1.1388245)(1.50)$$\n$$y_{\\mathrm{correct}} = -0.1065894 + 1.70823675 \\approx 1.60164735\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$$\n\nThe bias $b$ is defined as the difference between the incorrectly used threshold and the correct threshold:\n$$b = y_{\\mathrm{used}} - y_{\\mathrm{correct}}$$\n$$b = 1.50 - 1.60164735 = -0.10164735\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$$\n\nThe problem requires the final answer to be rounded to three significant figures. The first significant digit of $b$ is the $1$ in the tenths place. The third significant digit is the $1$ in the thousandths place. The following digit is $6$, which is greater than or equal to $5$, so we round up the third significant digit.\n$$b \\approx -0.102\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$$\nThis negative bias indicates that using the uncalibrated threshold of $1.50\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$ on the new lot is an underestimation of the correct diagnostic threshold, which is approximately $1.60\\,\\mathrm{ng}\\,\\mathrm{mL}^{-1}$.",
            "answer": "$$\\boxed{-0.102}$$"
        },
        {
            "introduction": "Beyond predicting outcomes, a key goal of OOC modeling is to gain mechanistic insight into complex biological processes. This practice introduces a state-of-the-art technique from explainable AI, Shapley Additive Explanations (SHAP), to dissect the contributions of multiple interacting biomarkers to a cellular response . By implementing the SHAP value calculation from first principles for a model of inflammatory response, you will learn how to attribute an outcome to individual inputs and their synergies, linking a quantitative model back to its underlying biological pathways.",
            "id": "5145066",
            "problem": "You are modeling an organ-on-chip barrier disruption readout as a function of four biomarker inputs. The goal is to compute feature importance using Shapley Additive Explanations (SHAP) from first principles and verify that the computed feature attributions are consistent with known mechanistic pathways that influence the chip output.\n\nFundamental base and model specification:\n- Consider a chip output function $f(\\mathbf{x})$ that maps four dimensionless fold-change inputs to a dimensionless barrier disruption index. The inputs are:\n  - $x_1$: Tumor Necrosis Factor alpha (TNF-$\\alpha$), pro-inflammatory.\n  - $x_2$: Interferon gamma (IFN-$\\gamma$), pro-inflammatory.\n  - $x_3$: Interleukin-6 (IL-$6$), pro-inflammatory.\n  - $x_4$: Dexamethasone (Dex), anti-inflammatory.\n- The background (reference) fold-change vector is $\\mathbf{z} = [1, 1, 1, 1]$, representing no perturbation relative to baseline.\n- The chip readout is modeled as\n  $$f(\\mathbf{x}) = b + w_1 x_1 + w_2 x_2 + w_3 x_3 + w_4 x_4 + w_{12}\\, x_1 x_2,$$\n  with constants\n  $$b = 0.1,\\quad w_1 = 0.6,\\quad w_2 = 0.5,\\quad w_3 = 0.2,\\quad w_4 = -0.4,\\quad w_{12} = 0.5.$$\n  This encodes the mechanistic knowledge that TNF-$\\alpha$ and IFN-$\\gamma$ are pro-inflammatory and synergize, IL-$6$ is pro-inflammatory, and dexamethasone is anti-inflammatory.\n\nSHAP definition to be implemented:\n- For a function $f: \\mathbb{R}^n \\to \\mathbb{R}$, the Shapley value for feature $i$ at point $\\mathbf{x}$ relative to background $\\mathbf{z}$ is\n  $$\\phi_i(\\mathbf{x}) = \\sum_{S \\subseteq N \\setminus \\{i\\}} \\frac{|S|!\\,(n-|S|-1)!}{n!}\\,\\Big(f(\\mathbf{x}_{S \\cup \\{i\\}};\\mathbf{z}_{-(S \\cup \\{i\\})}) - f(\\mathbf{x}_S;\\mathbf{z}_{-S})\\Big),$$\n  where $N = \\{1,2,\\dots,n\\}$, $n=4$, and the notation $f(\\mathbf{x}_S;\\mathbf{z}_{-S})$ means that for indices in $S$ we use $\\mathbf{x}$, and for indices not in $S$ we use $\\mathbf{z}$. Use the degenerate background distribution at $\\mathbf{z}$ for missing features.\n\nMechanistic consistency checks to be verified for each test case:\n- Known pathways imply sign consistency:\n  - For pro-inflammatory biomarkers $x_1$, $x_2$, $x_3$, if $x_i - z_i$ is positive (respectively negative), then $\\phi_i(\\mathbf{x})$ should be nonnegative (respectively nonpositive), up to a small numerical tolerance.\n  - For anti-inflammatory dexamethasone $x_4$, if $x_4 - z_4$ is positive (respectively negative), then $\\phi_4(\\mathbf{x})$ should be nonpositive (respectively nonnegative), up to a small numerical tolerance.\n  - If $x_i = z_i$, then $\\phi_i(\\mathbf{x})$ should be numerically close to zero.\n- Synergy consistency for the TNF-$\\alpha$ and IFN-$\\gamma$ interaction:\n  - The combined attribution beyond the linear terms for $x_1$ and $x_2$ must equal the contribution of the interaction term at $\\mathbf{x}$ relative to $\\mathbf{z}$:\n    $$\\Big(\\phi_1(\\mathbf{x}) + \\phi_2(\\mathbf{x})\\Big) - \\Big(w_1(x_1 - z_1) + w_2(x_2 - z_2)\\Big) \\approx w_{12}\\,\\big(x_1 x_2 - z_1 z_2\\big),$$\n    within a small numerical tolerance.\n\nTest suite:\n- Use the following four input vectors $\\mathbf{x}$ to test the implementation:\n  - Case $1$: $\\mathbf{x}^{(1)} = [3,\\,3,\\,1.5,\\,1]$\n  - Case $2$: $\\mathbf{x}^{(2)} = [1.2,\\,1.1,\\,1.0,\\,2.0]$\n  - Case $3$: $\\mathbf{x}^{(3)} = [1,\\,1,\\,1,\\,1]$\n  - Case $4$: $\\mathbf{x}^{(4)} = [0.5,\\,2.0,\\,0.8,\\,1.0]$\n\nRequired tasks:\n- Implement the exact Shapley value computation for $n=4$ using the definition above with the background $\\mathbf{z}$.\n- For each test case $\\mathbf{x}^{(k)}$, compute the vector of SHAP values $[\\phi_1(\\mathbf{x}^{(k)}), \\phi_2(\\mathbf{x}^{(k)}), \\phi_3(\\mathbf{x}^{(k)}), \\phi_4(\\mathbf{x}^{(k)})]$.\n- For each test case, compute a boolean that is $True$ if and only if all mechanistic consistency checks stated above are satisfied within a tolerance of $\\tau = 10^{-6}$, and $False$ otherwise.\n\nFinal output format:\n- Your program should produce a single line of output containing a list of length $4$ (one entry per test case), where each entry is a list of the four SHAP values followed by the boolean consistency flag, i.e., for case $k$ output $[\\phi_1(\\mathbf{x}^{(k)}), \\phi_2(\\mathbf{x}^{(k)}), \\phi_3(\\mathbf{x}^{(k)}), \\phi_4(\\mathbf{x}^{(k)}), \\text{consistency}^{(k)}]$.\n- The overall output should therefore be a single line containing a list of lists, for example $[[\\dots, \\text{True}],[\\dots, \\text{False}],\\dots]$.",
            "solution": "The problem statement has been critically examined and is determined to be valid. It is scientifically grounded within the context of mathematical modeling, well-posed, and provides a complete and consistent set of specifications for a solvable computational task. The task is to compute Shapley Additive Explanations (SHAP) values for a given four-dimensional polynomial model of an organ-on-chip readout and to verify the results against a set of mechanistic consistency checks.\n\nThe solution proceeds by first implementing the exact SHAP value computation from its fundamental definition, as specified. Subsequently, the consistency checks are implemented and applied to the computed SHAP values for each test case.\n\nThe chip readout function is given by\n$$f(\\mathbf{x}) = b + w_1 x_1 + w_2 x_2 + w_3 x_3 + w_4 x_4 + w_{12}\\, x_1 x_2$$\nwhere $\\mathbf{x} = [x_1, x_2, x_3, x_4]$ is the vector of biomarker inputs. The constants are $b = 0.1$, $w_1 = 0.6$, $w_2 = 0.5$, $w_3 = 0.2$, $w_4 = -0.4$, and $w_{12} = 0.5$. The background reference input is $\\mathbf{z} = [1, 1, 1, 1]$.\n\nThe Shapley value $\\phi_i(\\mathbf{x})$ for feature $i$ is defined as the weighted sum of its marginal contributions over all possible subsets of other features:\n$$\\phi_i(\\mathbf{x}) = \\sum_{S \\subseteq N \\setminus \\{i\\}} \\frac{|S|!\\,(n-|S|-1)!}{n!}\\,\\Big(f(\\mathbf{x}_{S \\cup \\{i\\}};\\mathbf{z}_{-(S \\cup \\{i\\})}) - f(\\mathbf{x}_S;\\mathbf{z}_{-S})\\Big)$$\nHere, $n=4$ is the number of features, $N = \\{1,2,3,4\\}$, and the notation $f(\\mathbf{x}_A;\\mathbf{z}_{-A})$ denotes the evaluation of the function $f$ with an input vector where components with indices in the set $A$ are taken from $\\mathbf{x}$, and all other components are taken from the background vector $\\mathbf{z}$.\n\nTo compute $\\phi_i(\\mathbfx)$ for a specific feature $i$, we must iterate through all $2^{n-1} = 2^3 = 8$ subsets $S$ of the other features $N \\setminus \\{i\\}$. For each subset $S$, we compute its size $|S|$, the combinatorial weight $\\frac{|S|!\\,(n-|S|-1)!}{n!}$, and the marginal contribution of feature $i$ when added to the set $S$, which is the term $\\Big(f(\\mathbf{x}_{S \\cup \\{i\\}};\\mathbf{z}_{-(S \\cup \\{i\\})}) - f(\\mathbf{x}_S;\\mathbf{z}_{-S})\\Big)$. The sum of these weighted contributions gives the exact Shapley value.\n\nFor a polynomial model such as the one given, it is possible to derive an analytical solution for the SHAP values. This provides a valuable method for verifying the correctness of the direct implementation. The SHAP framework is additive, so we can consider the linear and interaction terms separately.\nFor the linear terms $w_j x_j$, the SHAP value is $\\phi_i(w_j x_j) = w_j(x_j - z_j)$ if $i=j$ and $0$ otherwise.\nFor the interaction term $w_{12} x_1 x_2$, the SHAP values are non-zero only for $i=1$ and $i=2$. A derivation from the definitional formula yields:\n$\\phi_1(w_{12} x_1 x_2) = \\frac{1}{2} w_{12} (x_1 - z_1) (x_2 + z_2)$\n$\\phi_2(w_{12} x_1 x_2) = \\frac{1}{2} w_{12} (x_2 - z_2) (x_1 + z_1)$\n$\\phi_i(w_{12} x_1 x_2) = 0$ for $i \\in \\{3,4\\}$.\n\nCombining these, the full analytical expressions for the SHAP values are:\n$\\phi_1(\\mathbf{x}) = w_1(x_1 - z_1) + \\frac{1}{2} w_{12} (x_1 - z_1) (x_2 + z_2)$\n$\\phi_2(\\mathbf{x}) = w_2(x_2 - z_2) + \\frac{1}{2} w_{12} (x_2 - z_2) (x_1 + z_1)$\n$\\phi_3(\\mathbf{x}) = w_3(x_3 - z_3)$\n$\\phi_4(\\mathbf{x}) = w_4(x_4 - z_4)$\n\nWe can now verify the mechanistic synergy consistency check using these analytical forms. The check is:\n$\\Big(\\phi_1(\\mathbf{x}) + \\phi_2(\\mathbf{x})\\Big) - \\Big(w_1(x_1 - z_1) + w_2(x_2 - z_2)\\Big) \\approx w_{12}\\,\\big(x_1 x_2 - z_1 z_2\\big)$\nSubstituting the analytical expressions, the left-hand side becomes:\n$\\phi_1(w_{12} x_1 x_2) + \\phi_2(w_{12} x_1 x_2) = \\frac{1}{2} w_{12} \\big[ (x_1 - z_1) (x_2 + z_2) + (x_2 - z_2) (x_1 + z_1) \\big]$\n$= \\frac{1}{2} w_{12} \\big[ (x_1 x_2 + x_1 z_2 - z_1 x_2 - z_1 z_2) + (x_2 x_1 + x_2 z_1 - z_2 x_1 - z_2 z_1) \\big]$\n$= \\frac{1}{2} w_{12} \\big[ 2 x_1 x_2 - 2 z_1 z_2 \\big] = w_{12} (x_1 x_2 - z_1 z_2)$\nThis is identical to the right-hand side, confirming that the synergy check must hold exactly (up to machine precision).\n\nThe implementation will, as required, compute the SHAP values by implementing the summation formula directly. For each of the four test cases, a vector of four SHAP values $[\\phi_1, \\phi_2, \\phi_3, \\phi_4]$ will be computed. Then, a boolean flag is determined by evaluating all mechanistic consistency checks:\n1.  **Sign Consistency**: Pro-inflammatory inputs ($x_1, x_2, x_3$) with fold-change greater than $1$ must have non-negative attribution, and vice-versa. The anti-inflammatory input ($x_4$) must exhibit the opposite relationship. Inputs with no change must have zero attribution.\n2.  **Synergy Consistency**: The combined attribution of $x_1$ and $x_2$ beyond their linear effects must match the contribution from their interaction term.\n\nAll checks are performed using a numerical tolerance of $\\tau = 10^{-6}$. The final output for each test case is a list containing the four SHAP values and the boolean consistency flag.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import factorial\nfrom itertools import combinations\n\ndef solve():\n    \"\"\"\n    Computes SHAP values and verifies mechanistic consistency for a given\n    organ-on-chip model readout.\n    \"\"\"\n\n    # Define model parameters\n    b = 0.1\n    w1, w2, w3, w4, w12 = 0.6, 0.5, 0.2, -0.4, 0.5\n    weights = {'b': b, 'w1': w1, 'w2': w2, 'w3': w3, 'w4': w4, 'w12': w12}\n\n    # Define background vector and feature count\n    z_vec = np.array([1.0, 1.0, 1.0, 1.0])\n    n_features = 4\n\n    # Define test cases\n    test_cases = [\n        np.array([3.0, 3.0, 1.5, 1.0]),\n        np.array([1.2, 1.1, 1.0, 2.0]),\n        np.array([1.0, 1.0, 1.0, 1.0]),\n        np.array([0.5, 2.0, 0.8, 1.0]),\n    ]\n\n    def model_func(x):\n        \"\"\" The chip readout model function f(x). \"\"\"\n        x1, x2, x3, x4 = x[0], x[1], x[2], x[3]\n        f_val = (weights['b'] +\n                 weights['w1'] * x1 +\n                 weights['w2'] * x2 +\n                 weights['w3'] * x3 +\n                 weights['w4'] * x4 +\n                 weights['w12'] * x1 * x2)\n        return f_val\n\n    def calculate_shap(x_vec, z_vec, feature_idx):\n        \"\"\"\n        Computes the exact Shapley value for a feature using the fundamental definition.\n        \"\"\"\n        phi = 0.0\n        all_indices = list(range(n_features))\n        other_indices = [j for j in all_indices if j != feature_idx]\n        n_fact = factorial(n_features)\n\n        for k in range(n_features):  # k is the size of subset S\n            weight = factorial(k) * factorial(n_features - k - 1) / n_fact\n            for s_tuple in combinations(other_indices, k):\n                S = set(s_tuple)\n                s_union_i = S.union({feature_idx})\n\n                # v1: input vector for f(x_{S U {i}}, z_{-(S U {i})})\n                v1 = np.copy(z_vec)\n                v1[list(s_union_i)] = x_vec[list(s_union_i)]\n                \n                # v2: input vector for f(x_S, z_{-S})\n                v2 = np.copy(z_vec)\n                if S:\n                    v2[list(S)] = x_vec[list(S)]\n\n                term = model_func(v1) - model_func(v2)\n                phi += weight * term\n        \n        return phi\n\n    def check_consistency(x_vec, z_vec, phi_vec):\n        \"\"\"\n        Verifies all mechanistic consistency checks for a given test case.\n        \"\"\"\n        tau = 1e-6\n        w = weights\n        \n        # 1. Sign Consistency Check\n        pro_inflammatory_indices = {0, 1, 2}\n        for i in range(n_features):\n            delta_x = x_vec[i] - z_vec[i]\n            phi_i = phi_vec[i]\n\n            if i in pro_inflammatory_indices:\n                if delta_x > tau and phi_i  -tau: return False\n                if delta_x  -tau and phi_i > tau: return False\n            else: # Anti-inflammatory (i=3)\n                if delta_x > tau and phi_i > tau: return False\n                if delta_x  -tau and phi_i  -tau: return False\n            \n            if abs(delta_x) = tau and abs(phi_i) > tau: return False\n\n        # 2. Synergy Consistency Check\n        x1, x2 = x_vec[0], x_vec[1]\n        z1, z2 = z_vec[0], z_vec[1]\n        phi1, phi2 = phi_vec[0], phi_vec[1]\n\n        synergy_attribution = (phi1 + phi2) - (w['w1'] * (x1 - z1) + w['w2'] * (x2 - z2))\n        expected_synergy = w['w12'] * (x1 * x2 - z1 * z2)\n\n        if abs(synergy_attribution - expected_synergy) > tau:\n            return False\n\n        return True\n\n    results = []\n    for x_case in test_cases:\n        phi_values = [calculate_shap(x_case, z_vec, i) for i in range(n_features)]\n        consistency_flag = check_consistency(x_case, z_vec, np.array(phi_values))\n        \n        # Round numerical results for clean output, but use full precision for checks\n        output_row = [round(p, 8) for p in phi_values] + [consistency_flag]\n        results.append(output_row)\n\n    # Format the final output string\n    # str() on a list produces a string representation like '[val1, val2, ...]'\n    final_output_str = f\"[{','.join(map(str, results))}]\"\n    print(final_output_str)\n\nsolve()\n```"
        }
    ]
}