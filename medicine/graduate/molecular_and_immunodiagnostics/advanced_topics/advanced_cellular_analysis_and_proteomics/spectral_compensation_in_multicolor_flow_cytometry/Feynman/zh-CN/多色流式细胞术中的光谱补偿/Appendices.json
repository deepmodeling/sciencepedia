{
    "hands_on_practices": [
        {
            "introduction": "准确的光谱补偿始于精确计算溢漏系数。然而，直接使用阳性样本的荧光强度中位数进行计算会受到仪器背景和细胞自发荧光的干扰，从而产生偏差。本练习将指导您使用适当的对照（未染色细胞）来校正这些背景信号，推导出一个无偏的溢漏系数估计量，这是建立可靠补偿矩阵的基础。",
            "id": "5164935",
            "problem": "在用于分子和免疫诊断的多色流式细胞术中，由主检测器 $i$ 激发的荧光染料到次级检测器 $j$ 的光谱溢漏被建模为线性混合，而背景荧光和细胞自发荧光则以加性方式贡献于观测到的强度。考虑一个仅用荧光染料 $i$ 标记的单染样本、一个未染色的细胞对照，以及一个缓冲液空白对照（无细胞）。令 $M_{k}^{(\\mathrm{pos})}$ 表示单染阳性细胞在检测器 $k \\in \\{i,j\\}$ 中观测到的中位荧光强度，$M_{k}^{(\\mathrm{neg})}$ 表示未染色细胞对照在检测器 $k$ 中的中位数，而 $M_{k}^{(\\mathrm{blank})}$ 表示缓冲液空白对照在检测器 $k$ 中的中位数。假设以下被广泛接受的基础：\n- 任何检测器中测得的中位数是三个独立贡献的总和：仪器基线偏移、细胞自发荧光（对于含细胞的样本）以及荧光染料发射。\n- 从荧光染料 $i$ 到检测器 $j$ 的溢漏与检测器 $i$ 中捕获的主发射成正比，比例系数为 $s_{ij}$，且不依赖于基线项。\n- 在固定的仪器设置下，对于固定的细胞群，所有关系在中位数水平上都是线性的。\n\n给定在固定仪器设置和匹配的圈门下收集到的以下中位数（任意单位）：\n- $M_{i}^{(\\mathrm{pos})} = 78{,}300$, $M_{j}^{(\\mathrm{pos})} = 12{,}640$。\n- $M_{i}^{(\\mathrm{neg})} = 1{,}380$, $M_{j}^{(\\mathrm{neg})} = 1{,}190$。\n- $M_{i}^{(\\mathrm{blank})} = 210$, $M_{j}^{(\\mathrm{blank})} = 195$。\n\n从上述线性度和加性假设出发，分析当直接使用包含偏移量的观测中位数构建 $s_{ij}$ 的估计量时，忽略背景和自发荧光会如何使其产生偏差。然后，推导一个用于 $s_{ij}$ 的调整后估计量，该估计量在计算任何比率或斜率之前移除了适当的基线中位数，并证明其在模型下的无偏性。最后，使用所提供的中位数，计算 $s_{ij}$ 的调整后值。将您的答案四舍五入到 $4$ 位有效数字，并以无单位小数的形式报告。",
            "solution": "首先对问题进行验证，以确保其科学上合理、提法恰当且信息完整。\n\n### 步骤 1：提取已知条件\n- **领域**：多色流式细胞术中的光谱补偿。\n- **模型框架**：\n    - 观测到的中位强度是仪器基线、细胞自发荧光和荧光染料发射的线性总和。\n    - 光谱溢漏是一种线性现象。\n- **变量与定义**：\n    - $M_{k}^{(\\mathrm{pos})}$：单染阳性细胞在检测器 $k$ 中观测到的中位荧光强度。\n    - $M_{k}^{(\\mathrm{neg})}$：未染色细胞对照在检测器 $k$ 中的中位数。\n    - $M_{k}^{(\\mathrm{blank})}$：缓冲液空白对照（无细胞）在检测器 $k$ 中的中位数。\n    - $k \\in \\{i, j\\}$，其中 $i$ 是该荧光染料的主检测器，$j$ 是一个次级检测器。\n    - $s_{ij}$：溢漏系数，表示从荧光染料 $i$ 发出的、在通道 $j$ 中检测到的发射信号相对于在其主通道 $i$ 中检测到的发射信号的比例。\n- **假设**：\n    1. 中位强度的线性度和加性。\n    2. 溢漏系数 $s_{ij}$ 与基线和自发荧光无关。\n- **数值数据**：\n    - $M_{i}^{(\\mathrm{pos})} = 78300$\n    - $M_{j}^{(\\mathrm{pos})} = 12640$\n    - $M_{i}^{(\\mathrm{neg})} = 1380$\n    - $M_{j}^{(\\mathrm{neg})} = 1190$\n    - $M_{i}^{(\\mathrm{blank})} = 210$\n    - $M_{j}^{(\\mathrm{blank})} = 195$\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学依据**：该问题具有充分的科学依据。用于荧光溢漏和加性背景的线性模型是流式细胞术中光谱补偿所使用的标准基础模型。使用单染、未染色和空白对照是标准的实验操作。\n- **提法恰当性**：该问题定义清晰。它提供了一个形式化模型、所有必要的数据以及一个需要推导和计算的特定量。存在唯一、稳定的解。\n- **客观性**：该问题使用精确、定量且无偏的术语进行陈述。\n- **结论**：该问题是有效的。这是免疫诊断数据分析中一个标准的、非平凡的问题，旨在检验对信号构成和背景扣除的基本理解。\n\n### 步骤 3：结论与行动\n该问题是**有效的**。将提供完整解答。\n\n### 推导与求解\n\n让我们将问题描述中的加性模型形式化。对于任何检测器 $k \\in \\{i, j\\}$，观测到的中位荧光强度 $M_k$ 是三个组分的总和：\n1.  $B_k$：仪器的基线偏移，即在没有细胞时存在的信号。这由缓冲液空白对照测得。因此，$M_{k}^{(\\mathrm{blank})} = B_k$。\n2.  $A_k$：中位自发荧光，即细胞自身的内在荧光，与任何添加的荧光染料无关。\n3.  $F_k$：源于被测特定荧光染料的中位荧光信号。\n\n基于此，我们可以为三种样本类型的中位强度写出表达式：\n- 对于缓冲液空白对照（无细胞，无荧光染料）：\n$$M_{k}^{(\\mathrm{blank})} = B_k$$\n- 对于未染色细胞对照（有细胞，无荧光染料）：\n$$M_{k}^{(\\mathrm{neg})} = B_k + A_k$$\n- 对于单染阳性细胞（有细胞和荧光染料 $i$）：\n$$M_{k}^{(\\mathrm{pos})} = B_k + A_k + F_k$$\n此处，$F_k$ 是荧光染料 $i$ 对检测器 $k$ 中信号的贡献。\n\n溢漏系数 $s_{ij}$ 定义为从荧光染料 $i$ 发出的、在次级通道 $j$ 中检测到的真实荧光与在主通道 $i$ 中检测到的真实荧光之比。\n$$s_{ij} = \\frac{F_j}{F_i}$$\n该定义基于完全从背景和自发荧光中分离出来的真实荧光染料信号 $F_i$ 和 $F_j$。\n\n**朴素估计量的分析**\n一个朴素的 $s_{ij}$ 估计量，我们可记为 $\\hat{s}_{ij}^{(\\mathrm{naive})}$，可能通过忽略背景和自发荧光的贡献，简单地取阳性样本观测到的总中位数之比来计算：\n$$\\hat{s}_{ij}^{(\\mathrm{naive})} = \\frac{M_j^{(\\mathrm{pos})}}{M_i^{(\\mathrm{pos})}}$$\n代入完整的中位数模型表达式：\n$$\\hat{s}_{ij}^{(\\mathrm{naive})} = \\frac{B_j + A_j + F_j}{B_i + A_i + F_i}$$\n代入 $F_j = s_{ij} F_i$：\n$$\\hat{s}_{ij}^{(\\mathrm{naive})} = \\frac{B_j + A_j + s_{ij} F_i}{B_i + A_i + F_i}$$\n此表达式显然不等于真实的 $s_{ij}$，除非检测器 $j$ 的总背景项 $(B_j + A_j)$ 等于 $s_{ij}$ 乘以检测器 $i$ 的总背景项 $(B_i + A_i)$。这通常不成立。$B_k+A_k$ 项引入了显著的偏差，该偏差取决于信背比。因此，该估计量是不正确且有偏的。\n\n**调整后估计量的推导**\n为了获得 $s_{ij}$ 的无偏估计，我们必须首先从观测到的中位数中分离出真实的荧光值 $F_i$ 和 $F_j$。根据我们的模型方程：\n$$M_{k}^{(\\mathrm{pos})} = (B_k + A_k) + F_k$$\n和\n$$M_{k}^{(\\mathrm{neg})} = B_k + A_k$$\n项 $B_k + A_k$ 代表了检测器 $k$ 中一个细胞的总背景信号，包括仪器噪声和细胞自发荧光。这正是由未染色细胞对照 $M_{k}^{(\\mathrm{neg})}$ 所测量的。因此，我们可以通过从单染阳性群体的中位数中减去未染色对照的中位数来找到真实的荧光染料信号 $F_k$：\n$$F_k = M_{k}^{(\\mathrm{pos})} - M_{k}^{(\\mathrm{neg})}$$\n这种减法正确地移除了仪器基线和细胞自发荧光的综合效应。\n\n现在，我们可以使用这些扣除背景后的荧光值来构建调整后的估计量 $\\hat{s}_{ij}^{(\\mathrm{adj})}$：\n$$\\hat{s}_{ij}^{(\\mathrm{adj})} = \\frac{F_j}{F_i} = \\frac{M_j^{(\\mathrm{pos})} - M_j^{(\\mathrm{neg})}}{M_i^{(\\mathrm{pos})} - M_i^{(\\mathrm{neg})}}$$\n\n**无偏性证明**\n通过将模型表达式代入分子和分母，我们可以验证此估计量在模型的假设下是无偏的：\n$$M_j^{(\\mathrm{pos})} - M_j^{(\\mathrm{neg})} = (B_j + A_j + F_j) - (B_j + A_j) = F_j$$\n$$M_i^{(\\mathrm{pos})} - M_i^{(\\mathrm{neg})} = (B_i + A_i + F_i) - (B_i + A_i) = F_i$$\n因此：\n$$\\hat{s}_{ij}^{(\\mathrm{adj})} = \\frac{F_j}{F_i}$$\n由于溢漏的定义是 $F_j = s_{ij} F_i$，可得：\n$$\\hat{s}_{ij}^{(\\mathrm{adj})} = \\frac{s_{ij} F_i}{F_i} = s_{ij}$$\n该估计量正确地恢复了 $s_{ij}$ 的真实值，证明了它在线性加性模型下是无偏的。请注意，缓冲液空白对照的数据 ($M_k^{(\\mathrm{blank})}$) 在此计算中并非明确需要，因为未染色细胞对照 ($M_k^{(\\mathrm{neg})}$) 已作为染色细胞的综合基线。\n\n**调整后溢漏系数的计算**\n使用提供的数值数据：\n- $M_{i}^{(\\mathrm{pos})} = 78300$\n- $M_{j}^{(\\mathrm{pos})} = 12640$\n- $M_{i}^{(\\mathrm{neg})} = 1380$\n- $M_{j}^{(\\mathrm{neg})} = 1190$\n\n首先，计算真实的荧光信号 $F_i$ 和 $F_j$：\n$$F_i = M_{i}^{(\\mathrm{pos})} - M_{i}^{(\\mathrm{neg})} = 78300 - 1380 = 76920$$\n$$F_j = M_{j}^{(\\mathrm{pos})} - M_{j}^{(\\mathrm{neg})} = 12640 - 1190 = 11450$$\n\n现在，计算溢漏系数 $s_{ij}$：\n$$s_{ij} = \\frac{F_j}{F_i} = \\frac{11450}{76920} \\approx 0.1488559542...$$\n\n问题要求将答案四舍五入到 $4$ 位有效数字。\n$$s_{ij} \\approx 0.1489$$\n这个无量纲值表明，大约有 $14.89\\%$ 的来自荧光染料 $i$ 的信号溢漏到检测器 $j$ 中。",
            "answer": "$$\\boxed{0.1489}$$"
        },
        {
            "introduction": "光谱补偿并非没有代价，它会在校正信号的同时引入“扩展误差”(spreading error)，即增加补偿后细胞群的方差。本练习将带您从统计学角度深入分析补偿过程，通过推导补偿后信号的方差表达式，您将从数学上理解溢漏系数的估计不确定性是如何导致信号展宽的。掌握这一概念对于评估和优化多色方案的分辨率至关重要。",
            "id": "5164942",
            "problem": "在多色流式细胞术中，当一种荧光团的发射光谱被部分地在非主通道中检测到时，就会产生光谱溢漏。考虑一个测量两种荧光团的双通道仪器。设测得的随机变量为 $x_{1}$ 和 $x_{2}$，其均值分别为 $\\mu_{1}$ 和 $\\mu_{2}$，方差分别为 $\\sigma_{1}^{2}$ 和 $\\sigma_{2}^{2}$。假设通道噪声源是独立的，因此 $\\operatorname{Cov}(x_{1}, x_{2}) = 0$。从通道 $2$ 到通道 $1$ 的光谱溢漏补偿通过线性变换 $y_{1} = x_{1} - s_{12} x_{2}$ 进行，其中 $s_{12}$ 是通过校准估计出的溢漏系数。\n\n在实践中，基于校准的溢漏估计是不确定的。将应用的补偿系数建模为 $\\hat{s}_{12} = s_{12} + \\epsilon$，其中 $\\epsilon$ 是一个代表估计误差的零均值随机变量，其方差为 $\\sigma_{s}^{2}$，且 $\\epsilon$ 独立于 $x_{1}$ 和 $x_{2}$。那么，应用补偿后的信号为 $y_{1} = x_{1} - \\hat{s}_{12} x_{2}$。\n\n仅使用方差、独立性和期望线性性质的基本定义，推导 $\\operatorname{Var}(y_{1})$ 关于 $s_{12}$、$\\mu_{2}$、$\\sigma_{1}^{2}$、$\\sigma_{2}^{2}$ 和 $\\sigma_{s}^{2}$ 的精确表达式。简要解释在这些假设下，$s_{12}$ 的不确定性如何影响 $\\operatorname{Var}(y_{1})$。\n\n以 $\\operatorname{Var}(y_{1})$ 关于指定量的单个闭式解析表达式的形式给出你的最终答案。不需要进行数值计算。",
            "solution": "带有不确定溢漏系数的补偿后信号由下式给出\n$$\ny_{1} = x_{1} - \\hat{s}_{12} x_{2} = x_{1} - (s_{12} + \\epsilon) x_{2} = (x_{1} - s_{12} x_{2}) - \\epsilon x_{2}.\n$$\n我们要求解 $\\operatorname{Var}(y_{1})$。根据方差的定义及其性质，对于任意随机变量 $A$ 和 $B$，\n$$\n\\operatorname{Var}(A + B) = \\operatorname{Var}(A) + \\operatorname{Var}(B) + 2\\,\\operatorname{Cov}(A,B).\n$$\n令 $A = x_{1} - s_{12} x_{2}$ 且 $B = -\\epsilon x_{2}$。那么\n$$\n\\operatorname{Var}(y_{1}) = \\operatorname{Var}(x_{1} - s_{12} x_{2}) + \\operatorname{Var}(\\epsilon x_{2}) + 2\\,\\operatorname{Cov}(x_{1} - s_{12} x_{2}, -\\epsilon x_{2}).\n$$\n我们在给定的假设下计算每一项。\n\n首先，使用 $\\operatorname{Cov}(x_{1}, x_{2}) = 0$ 和协方差的双线性性质，我们得到\n$$\n\\operatorname{Var}(x_{1} - s_{12} x_{2}) = \\operatorname{Var}(x_{1}) + s_{12}^{2}\\operatorname{Var}(x_{2}) - 2 s_{12} \\operatorname{Cov}(x_{1}, x_{2}) = \\sigma_{1}^{2} + s_{12}^{2} \\sigma_{2}^{2}.\n$$\n\n其次，我们计算 $\\operatorname{Var}(\\epsilon x_{2})$。对于独立的随机变量 $U$ 和 $V$，\n$$\n\\operatorname{Var}(UV) = \\mathbb{E}[U^{2} V^{2}] - \\big(\\mathbb{E}[UV]\\big)^{2}.\n$$\n当 $U = \\epsilon$ 和 $V = x_{2}$ 时，根据独立性可得 $\\mathbb{E}[UV] = \\mathbb{E}[\\epsilon]\\mathbb{E}[x_{2}] = 0 \\cdot \\mu_{2} = 0$，以及\n$$\n\\mathbb{E}[\\epsilon^{2} x_{2}^{2}] = \\mathbb{E}[\\epsilon^{2}] \\, \\mathbb{E}[x_{2}^{2}] = \\sigma_{s}^{2} \\, \\big(\\operatorname{Var}(x_{2}) + (\\mathbb{E}[x_{2}])^{2}\\big) = \\sigma_{s}^{2} \\, (\\sigma_{2}^{2} + \\mu_{2}^{2}).\n$$\n因此，\n$$\n\\operatorname{Var}(\\epsilon x_{2}) = \\sigma_{s}^{2} \\, (\\sigma_{2}^{2} + \\mu_{2}^{2}).\n$$\n\n第三，我们计算协方差项 $\\operatorname{Cov}(x_{1} - s_{12} x_{2}, -\\epsilon x_{2})$。利用协方差的线性性质，\n$$\n\\operatorname{Cov}(x_{1} - s_{12} x_{2}, -\\epsilon x_{2}) = -\\operatorname{Cov}(x_{1}, \\epsilon x_{2}) + s_{12}\\operatorname{Cov}(x_{2}, \\epsilon x_{2}).\n$$\n因为 $\\epsilon$ 与 $x_{1}$ 和 $x_{2}$ 都独立且均值为零，我们有\n$$\n\\operatorname{Cov}(x_{1}, \\epsilon x_{2}) = \\mathbb{E}[x_{1} \\epsilon x_{2}] - \\mathbb{E}[x_{1}] \\mathbb{E}[\\epsilon x_{2}] = \\mathbb{E}[x_{1}]\\mathbb{E}[\\epsilon]\\mathbb{E}[x_{2}] - \\mu_{1} \\cdot 0 = 0,\n$$\n以及\n$$\n\\operatorname{Cov}(x_{2}, \\epsilon x_{2}) = \\mathbb{E}[x_{2}\\epsilon x_{2}] - \\mathbb{E}[x_{2}] \\mathbb{E}[\\epsilon x_{2}] = \\mathbb{E}[\\epsilon]\\mathbb{E}[x_{2}^{2}] - \\mu_{2} \\cdot 0 = 0.\n$$\n因此，\n$$\n\\operatorname{Cov}(x_{1} - s_{12} x_{2}, -\\epsilon x_{2}) = 0.\n$$\n\n综合所有项，我们得到\n$$\n\\operatorname{Var}(y_{1}) = \\sigma_{1}^{2} + s_{12}^{2} \\sigma_{2}^{2} + \\sigma_{s}^{2} (\\sigma_{2}^{2} + \\mu_{2}^{2}).\n$$\n\n对溢漏不确定性敏感度的解释：前两项 $\\sigma_{1}^{2} + s_{12}^{2} \\sigma_{2}^{2}$ 是在溢漏系数精确已知时的方差贡献。溢漏系数的不确定性增加了第三项 $\\sigma_{s}^{2} (\\sigma_{2}^{2} + \\mu_{2}^{2})$，该项与估计误差方差 $\\sigma_{s}^{2}$ 以及 $x_{2}$ 的二阶矩成线性关系。这表明，即使 $x_{2}$ 的方差很小，一个较大的均值 $\\mu_{2}$ 也会增加 $\\operatorname{Var}(y_{1})$ 对 $s_{12}$ 不确定性的敏感度，反之亦然。偏导数 $\\partial \\operatorname{Var}(y_{1}) / \\partial \\sigma_{s}^{2} = (\\sigma_{2}^{2} + \\mu_{2}^{2})$ 在独立性和零均值误差的假设下，精确地量化了这种敏感度。",
            "answer": "$$\\boxed{\\sigma_{1}^{2} + s_{12}^{2} \\sigma_{2}^{2} + \\sigma_{s}^{2} \\left(\\sigma_{2}^{2} + \\mu_{2}^{2}\\right)}$$"
        },
        {
            "introduction": "对溢漏和扩展误差的深刻理解，使我们能够从被动的数据校正转向主动的实验设计。本项高级计算练习将多色分析方案的设计形式化为一个优化问题。您将学习如何构建一个算法，通过智能地将荧光素分配给抗原，从而在确保弱表达抗原足够分离度的同时，将关键通道中的累积溢漏扩展控制在预算之内，这代表了将补偿理论应用于复杂实验设计的综合实践。",
            "id": "5164898",
            "problem": "您的任务是设计并实现一种有原则的算法，用于在多色流式细胞术方案中为抗原分配荧光团，该算法基于信号形成和补偿引起的扩散的第一性原理模型。目标是将明亮的荧光团分配给表达量低的抗原，将暗淡的荧光团分配给表达量高的抗原，同时控制关键通道中的累积扩散。您必须从基本定义中形式化一个目标函数，并实现一个分配算法，该算法作用于一组离散的候选抗原-荧光团配对。\n\n从以下核心原则和定义开始：\n- 对于一个荧光团-抗原对，其光子发射可以很好地用一个计数过程来描述，在泊松过程下，该过程的方差约等于其均值。在高计数情况下，这可以近似为一个方差等于均值的高斯分布。\n- 经过线性补偿（解混合）后，关键通道中的方差由溢出贡献累积而成。一个广泛使用的近似是，通道中由补偿引起的扩散与每个贡献荧光团记录的信号成正比。\n- 设有 $n$ 种抗原，由 $i \\in \\{0,\\dots,n-1\\}$ 索引，其丰度为 $A_i \\gt 0$；以及 $n$ 种荧光团，由 $j \\in \\{0,\\dots,n-1\\}$ 索引，其固有分子亮度为 $B_j \\gt 0$。一个标量检测增益 $\\beta \\gt 0$ 将亮度-丰度乘积映射到预期的单个事件平均计数值。对于配对 $(i,j)$，平均检测信号为\n$$\nM_{i,j} = \\beta \\, A_i \\, B_j.\n$$\n- 用 $\\sigma_0 \\gt 0$ 表示主检测通道中的基线标准差。定义一个目标分离指数 $d^\\star \\gt 0$（无量纲），表示在高斯近似下，阳性群体与阴性群体的均值与标准差之比的期望值。对于给定的配对 $(i,j)$，近似分离指数为\n$$\nd'_{i,j} \\approx \\frac{M_{i,j}}{\\sigma_0}.\n$$\n当 $d'_{i,j} \\lt d^\\star$ 时，分离不充分。定义每个配对的凸性不足损失\n$$\n\\ell_{i,j} = \\left(\\max\\{0, \\, d^\\star - d'_{i,j}\\}\\right)^2.\n$$\n- 设有 $K$ 个关键通道，由 $k \\in \\{0,\\dots,K-1\\}$ 索引。荧光团 $j$ 到关键通道 $k$ 的补偿引起的扩散系数为 $S_{j,k} \\ge 0$。在扩散累积的线性近似下，对于一个分配 $p$（一个从抗原到荧光团的双射），通道 $k$ 中的总扩散为\n$$\n\\mathrm{Spread}_k(p) \\,=\\, \\sum_{i=0}^{n-1} S_{p(i),k} \\, M_{i,p(i)}.\n$$\n给定通道预算 $C_k \\gt 0$，代表了首选的上限。您必须通过惩罚超出预算的情况来控制累积扩散。\n\n将分配问题表述为一个拉格朗日松弛的线性总和最小化问题。为通道 $k \\in \\{0,\\dots,K-1\\}$ 引入非负拉格朗日乘子 $\\lambda_k \\ge 0$，并定义每个配对的成本\n$$\nc_{i,j}(\\lambda) \\,=\\, \\ell_{i,j} \\;+\\; \\sum_{k=0}^{K-1} \\lambda_k \\, S_{j,k} \\, M_{i,j}.\n$$\n给定 $\\lambda$，在所有双射 $p$ 上最小化总成本 $\\sum_{i=0}^{n-1} c_{i,p(i)}(\\lambda)$。然后，基于扩散约束的违反情况，使用次梯度步骤更新 $\\lambda$：\n$$\n\\lambda_k \\leftarrow \\max\\Big\\{0,\\, \\lambda_k + \\eta \\cdot \\big(\\mathrm{Spread}_k(p) - C_k\\big) \\Big\\},\n$$\n其中步长为正数 $\\eta \\gt 0$（您可以在迭代中调整此步长）。迭代直至稳定。返回在平衡了损失和软约束违反的增强分数下遇到的最佳分配。\n\n您的实现必须：\n- 不接受用户输入，并且必须在下面给出的固定测试集上运行。\n- 对每次迭代的线性分配子问题使用匈牙利算法。\n- 使用固定的迭代预算和确定性的步长调度。\n\n测试集（所有量均为无量纲；输出中无需报告物理单位）：\n- 测试用例 1（理想路径）：\n  - $n = 4$,\n  - $A = [\\,0.1,\\;0.3,\\;1.0,\\;3.0\\,]$,\n  - $B = [\\,5.0,\\;2.0,\\;0.8,\\;0.3\\,]$,\n  - $K = 2$,\n  - $S$ (行对应于 $j$，列对应于 $k$):\n    $$\n    \\begin{bmatrix}\n    0.4  0.4\\\\\n    0.2  0.1\\\\\n    0.05  0.05\\\\\n    0.01  0.02\n    \\end{bmatrix}\n    $$\n  - $C = [\\,1.0,\\;1.0\\,]$,\n  - $\\beta = 1.0$,\n  - $\\sigma_0 = 0.2$,\n  - $d^\\star = 3.0$.\n- 测试用例 2（紧凑的扩散预算以引发权衡）：\n  - $n = 4$,\n  - $A = [\\,0.4,\\;0.5,\\;1.0,\\;1.2\\,]$,\n  - $B = [\\,5.0,\\;2.0,\\;0.8,\\;0.3\\,]$,\n  - $K = 2$,\n  - $S$:\n    $$\n    \\begin{bmatrix}\n    0.4  0.4\\\\\n    0.2  0.1\\\\\n    0.05  0.05\\\\\n    0.01  0.02\n    \\end{bmatrix}\n    $$\n  - $C = [\\,0.35,\\;0.35\\,]$,\n  - $\\beta = 1.0$,\n  - $\\sigma_0 = 0.3$,\n  - $d^\\star = 3.0$.\n- 测试用例 3（包含一个极暗抗原的边界情况）：\n  - $n = 4$,\n  - $A = [\\,0.05,\\;0.5,\\;1.0,\\;2.0\\,]$,\n  - $B = [\\,5.0,\\;2.0,\\;0.8,\\;0.3\\,]$,\n  - $K = 2$,\n  - $S$:\n    $$\n    \\begin{bmatrix}\n    0.4  0.4\\\\\n    0.2  0.1\\\\\n    0.05  0.05\\\\\n    0.01  0.02\n    \\end{bmatrix}\n    $$\n  - $C = [\\,1.0,\\;1.0\\,]$,\n  - $\\beta = 1.0$,\n  - $\\sigma_0 = 0.25$,\n  - $d^\\star = 3.0$.\n\n要求的最终输出格式：\n- 您的程序应生成单行输出，其中包含一个逗号分隔的 Python 风格的列表的列表的结果。\n- 对于每个测试用例，按 $i = 0$ 到 $i = n-1$ 的顺序输出一个包含 $n$ 个整数的列表，指定分配给抗原 $i$ 的荧光团的从零开始的索引 $j$。例如：`[[0,1,2,3],[\\dots],[\\dots]]`。",
            "solution": "该问题是有效的。它提出了一个与多色流式细胞术方案设计相关的、适定的、有科学依据的优化任务。所有必需的参数、定义和约束都已提供，构成了一个自洽且逻辑一致的问题陈述。用于信号、分离和扩散的底层模型是该领域使用的标准近似，尽管是简化版本。提议的解决方案，即通过次梯度法求解线性总和分配问题的拉格朗日松弛，是组合优化中的一种标准且合适的技术。\n\n任务是确定一个最优分配 $p$，它是从 $n$ 个抗原的集合到 $n$ 个荧光团的集合的一个双射，$p: \\{0, \\dots, n-1\\} \\to \\{0, \\dots, n-1\\}$。目标是找到一种配对，既能最小化抗原群体分离度的不足，又能同时控制几个关键检测器通道中的总溢漏扩散。这是一个带约束的组合优化问题。所提供的框架使用拉格朗日松弛来处理扩散约束。\n\n一个分配 $p$ 的总成本被分解为各个抗原-荧光团配对成本的总和。根据拉格朗日公式的规定，将抗原 $i$ 与荧光团 $j$ 配对的成本 $c_{i,j}$ 由两项组成：\n\n1. **分离不足损失 ($\\ell_{i,j}$)**：该项惩罚未能达到期望分离指数 $d^\\star$ 的配对。对 $(i, j)$ 的平均信号为 $M_{i,j} = \\beta A_i B_j$，其中 $A_i$ 是抗原丰度，$B_j$ 是荧光团亮度。近似分离指数为 $d'_{i,j} \\approx M_{i,j} / \\sigma_0$，其中 $\\sigma_0$ 是基线标准差。不足损失是对差额的二次惩罚：\n$$\n\\ell_{i,j} = \\left(\\max\\{0, \\, d^\\star - d'_{i,j}\\}\\right)^2\n$$\n该项鼓励具有高信号 $M_{i,j}$ 的配对，以确保足够的分离。\n\n2. **惩罚性溢出扩散**：该项考虑了 $K$ 个关键通道中总扩散的约束。对于每个通道 $k$，来自一个分配 $p$ 的总扩散 $\\mathrm{Spread}_k(p)$ 近似为一个线性和：\n$$\n\\mathrm{Spread}_k(p) = \\sum_{i=0}^{n-1} S_{p(i),k} \\, M_{i,p(i)}\n$$\n其中 $S_{j,k}$ 是荧光团 $j$ 到通道 $k$ 的溢漏扩散系数。问题使用非负拉格朗日乘子 $\\lambda_k \\ge 0$ 施加软约束 $\\mathrm{Spread}_k(p) \\le C_k$。对 $(i,j)$ 配对的成本的扩散贡献是信号 $M_{i,j}$ 乘以溢出系数的总和，而每个溢出系数又由其对应的拉格朗日乘子加权：\n$$\n\\text{Spread Cost}_{i,j}(\\lambda) = \\left( \\sum_{k=0}^{K-1} \\lambda_k S_{j,k} \\right) M_{i,j}\n$$\n\n在拉格朗日乘子 $\\lambda = \\{\\lambda_0, \\dots, \\lambda_{K-1}\\}$ 的给定状态下，配对 $(i, j)$ 的组合成本为：\n$$\nc_{i,j}(\\lambda) \\,=\\, \\ell_{i,j} \\;+\\; \\left( \\sum_{k=0}^{K-1} \\lambda_k S_{j,k} \\right) M_{i,j}\n$$\n\n优化通过迭代次梯度法进行：\n\n**步骤 1：线性分配问题 (LAP)。**\n对于一组固定的乘子 $\\lambda$，寻找最小化总解耦成本 $\\sum_{i=0}^{n-1} c_{i,p(i)}(\\lambda)$ 的分配 $p$ 的问题是一个经典的线性分配问题。我们首先构建一个 $n \\times n$ 的成本矩阵，其元素为 $c_{i,j}(\\lambda)$。然后，采用匈牙利算法在多项式时间内为这个特定的成本矩阵找到最优分配 $p^*$。\n\n**步骤 2：拉格朗日乘子的次梯度更新。**\n在步骤 1 中获得的分配 $p^*$ 用于评估每个关键通道 $k$ 的总扩散 $\\mathrm{Spread}_k(p^*)$。由项 $(\\mathrm{Spread}_k(p^*) - C_k)$ 给出的约束违反（或满足）程度，可作为对偶目标函数的次梯度。更新拉格朗日乘子，以便在下一次迭代中更重地惩罚导致约束被违反的配对。更新规则是一个投影次梯度步骤：\n$$\n\\lambda_k \\leftarrow \\max\\Big\\{0,\\, \\lambda_k + \\eta \\cdot \\big(\\mathrm{Spread}_k(p^*) - C_k\\big) \\Big\\}\n$$\n其中 $\\eta > 0$ 是步长。为帮助收敛，$\\eta$ 被安排在迭代过程中减小，例如，$\\eta_t = \\eta_0 / \\sqrt{t+1}$，其中 $t$ 是迭代索引。最初，所有 $\\lambda_k$ 都设置为 $0$，这意味着第一次迭代解决的是仅专注于最小化分离损失的无约束问题。\n\n**步骤 3：迭代与解选择。**\n重复步骤 1 和 2 固定次数的迭代。针对对偶问题的次梯度法不保证原始目标（分配的真实成本）的单调改进。因此，有必要在所有迭代中跟踪找到的最佳分配。分配 $p$ 的质量通过一个增强分数来评估，该分数结合了主要目标（总分离损失）和对任何违反扩散预算 $C_k$ 的行为的重度加权惩罚：\n$$\n\\text{Score}(p) = \\sum_{i=0}^{n-1} \\ell_{i,p(i)} + P \\sum_{k=0}^{K-1} \\max\\{0, \\mathrm{Spread}_k(p) - C_k\\}\n$$\n其中 $P$ 是一个大的正常数惩罚。在整个迭代过程中遇到的得分最低的分配被保留为最终解。这个过程有效地在“获得用于良好分离的明亮信号”和“管理由此产生的溢漏扩散以遵守通道预算”之间进行了权衡。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import linear_sum_assignment\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite and print the results.\n    \"\"\"\n    test_cases = [\n        {\n            \"n\": 4, \"A\": [0.1, 0.3, 1.0, 3.0], \"B\": [5.0, 2.0, 0.8, 0.3],\n            \"K\": 2, \"S\": [[0.4, 0.4], [0.2, 0.1], [0.05, 0.05], [0.01, 0.02]],\n            \"C\": [1.0, 1.0], \"beta\": 1.0, \"sigma_0\": 0.2, \"d_star\": 3.0\n        },\n        {\n            \"n\": 4, \"A\": [0.4, 0.5, 1.0, 1.2], \"B\": [5.0, 2.0, 0.8, 0.3],\n            \"K\": 2, \"S\": [[0.4, 0.4], [0.2, 0.1], [0.05, 0.05], [0.01, 0.02]],\n            \"C\": [0.35, 0.35], \"beta\": 1.0, \"sigma_0\": 0.3, \"d_star\": 3.0\n        },\n        {\n            \"n\": 4, \"A\": [0.05, 0.5, 1.0, 2.0], \"B\": [5.0, 2.0, 0.8, 0.3],\n            \"K\": 2, \"S\": [[0.4, 0.4], [0.2, 0.1], [0.05, 0.05], [0.01, 0.02]],\n            \"C\": [1.0, 1.0], \"beta\": 1.0, \"sigma_0\": 0.25, \"d_star\": 3.0\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        result = optimize_assignment(case)\n        results.append(result)\n\n    # Format output to match the specification \"[ [a,b,...],[c,d,...] ]\"\n    inner_lists_as_strings = [f\"[{','.join(map(str, r))}]\" for r in results]\n    print(f\"[{','.join(inner_lists_as_strings)}]\")\n\ndef optimize_assignment(params):\n    \"\"\"\n    Solves the fluorophore-antigen assignment problem for a single test case.\n    \n    This function implements the Lagrangian relaxation with a subgradient method.\n    \"\"\"\n    n = params[\"n\"]\n    K = params[\"K\"]\n    A = np.array(params[\"A\"], dtype=float)\n    B = np.array(params[\"B\"], dtype=float)\n    S = np.array(params[\"S\"], dtype=float)\n    C = np.array(params[\"C\"], dtype=float)\n    beta = float(params[\"beta\"])\n    sigma_0 = float(params[\"sigma_0\"])\n    d_star = float(params[\"d_star\"])\n\n    # --- Hyperparameters for the optimization algorithm ---\n    N_ITERATIONS = 200\n    ETA_0 = 0.1\n    SCORE_PENALTY = 1e4\n\n    # --- Pre-calculate fixed matrices ---\n    # M_ij: Mean detected signal for antigen i with fluorophore j\n    M = beta * np.outer(A, B)\n    # D'_ij: Approximate separation index\n    D_prime = M / sigma_0\n    # L_ij: Shortfall loss\n    L = np.square(np.maximum(0, d_star - D_prime))\n\n    # --- Initialize state for iterative optimization ---\n    # lambdas: Lagrange multipliers for spread constraints\n    lambdas = np.zeros(K)\n    best_assignment = None\n    best_score = np.inf\n\n    for t in range(N_ITERATIONS):\n        # --- Step 1: Construct cost matrix and solve LAP ---\n        # spread_penalty_per_fluorophore_j = sum_k(lambda_k * S_jk)\n        spread_penalty_per_fluorophore = S @ lambdas\n        # Cost matrix c_ij = l_ij + M_ij * spread_penalty_per_fluorophore_j\n        cost_matrix = L + M * spread_penalty_per_fluorophore[np.newaxis, :]\n        \n        # Solve the Linear Assignment Problem (LAP) using the Hungarian algorithm\n        row_ind, col_ind = linear_sum_assignment(cost_matrix)\n        # The assignment p where p[i] is the fluorophore for antigen i\n        p = np.zeros_like(row_ind, dtype=int)\n        p[row_ind] = col_ind\n\n        # --- Step 2: Evaluate the current assignment ---\n        # Total shortfall loss for the current assignment p\n        current_total_loss = L[row_ind, col_ind].sum()\n        \n        # Total spread per channel for the current assignment p\n        # Spread_k(p) = sum_i S_{p(i),k} * M_{i,p(i)}\n        current_spread = np.zeros(K)\n        for i in range(n):\n            j = p[i]  # Fluorophore index for antigen i\n            current_spread += S[j, :] * M[i, j]\n\n        # --- Step 3: Track the best assignment found so far ---\n        # Score = primary objective + penalty for soft constraint violation\n        spread_violation = np.sum(np.maximum(0, current_spread - C))\n        current_score = current_total_loss + SCORE_PENALTY * spread_violation\n        \n        if current_score  best_score:\n            best_score = current_score\n            best_assignment = p\n\n        # --- Step 4: Update Lagrange multipliers via subgradient step ---\n        eta = ETA_0 / np.sqrt(t + 1.0)\n        gradient = current_spread - C\n        lambdas = np.maximum(0, lambdas + eta * gradient)\n    \n    return list(best_assignment)\n\nif __name__ == \"__main__\":\n    solve()\n\n```"
        }
    ]
}