{
    "hands_on_practices": [
        {
            "introduction": "原始的医学影像数据，如CT扫描，其强度以亨氏单位（Hounsfield Units, $HU$）来衡量，具有很宽的动态范围。直接将这些原始值输入深度神经网络可能并非最佳选择。本练习将向您展示窗位（windowing）和归一化（normalization）这两个至关重要的数据预处理步骤，它们通过标准化输入数据来凸显感兴趣的组织，并改善模型的收敛性和性能 。",
            "id": "5004651",
            "problem": "计算机断层扫描 (CT) 为每个体素分配一个以亨斯菲尔德单位 (HU) 表示的强度值，该值由线性变换 $HU = 1000 \\cdot \\frac{\\mu - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$ 定义，其中 $\\mu$ 是物质的线性衰减系数，$\\mu_{\\text{water}}$ 是水的线性衰减系数。在用于转化医学的临床影像到学习流程中，会使用窗位技术来限制和重新缩放HU值的动态范围，以突出感兴趣的组织，然后将其输入到卷积神经网络 (CNN) 中。窗位技术使用中心 $c$ 和宽度 $w$ 定义了下限 $L = c - \\frac{w}{2}$ 和上限 $U = c + \\frac{w}{2}$，将HU值裁剪到区间 $[L, U]$ 内，并将裁剪后的强度线性重新缩放至 $[0, 1]$ 上的无量纲值。另外，归一化是一种统计变换（例如，$z$-分数归一化），它使用数据集级别的矩来标准化输入CNN的重新缩放后的值。\n\n考虑一个针对肺部优化的窗位，其中心 $c = -600$，宽度 $w = 1500$。设训练数据集中经过窗位调整和重新缩放后的强度值（在 $[0, 1]$ 区间内）的经验均值为 $\\mu = 0.42$，标准差为 $\\sigma = 0.18$。单个体素的原始强度为 $HU = -750$。请仅使用上述定义以及仿射映射和统计标准化的第一性原理，计算在应用肺窗和随后的$z$-分数归一化之后，输入到CNN第一层的单一标量值。\n\n将您的最终数值答案四舍五入到四位有效数字。以无量纲小数形式表示答案。",
            "solution": "用户希望我解决以下问题：\n计算机断层扫描 (CT) 为每个体素分配一个以亨斯菲尔德单位 (HU) 表示的强度值，该值由线性变换 $HU = 1000 \\cdot \\frac{\\mu - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$ 定义，其中 $\\mu$ 是物质的线性衰减系数，$\\mu_{\\text{water}}$ 是水的线性衰减系数。在用于转化医学的临床影像到学习流程中，会使用窗位技术来限制和重新缩放HU值的动态范围，以突出感兴趣的组织，然后将其输入到卷积神经网络 (CNN) 中。窗位技术使用中心 $c$ 和宽度 $w$ 定义了下限 $L = c - \\frac{w}{2}$ 和上限 $U = c + \\frac{w}{2}$，将HU值裁剪到区间 $[L, U]$ 内，并将裁剪后的强度线性重新缩放至 $[0, 1]$ 上的无量纲值。另外，归一化是一种统计变换（例如，$z$-分数归一化），它使用数据集级别的矩来标准化输入CNN的重新缩放后的值。\n\n考虑一个针对肺部优化的窗位，其中心 $c = -600$，宽度 $w = 1500$。设训练数据集中经过窗位调整和重新缩放后的强度值（在 $[0, 1]$ 区间内）的经验均值为 $\\mu = 0.42$，标准差为 $\\sigma = 0.18$。单个体素的原始强度为 $HU = -750$。请仅使用上述定义以及仿射映射和统计标准化的第一性原理，计算在应用肺窗和随后的$z$-分数归一化之后，输入到CNN第一层的单一标量值。\n\n将您的最终数值答案四舍五入到四位有效数字。以无量纲小数形式表示答案。\n\n### 步骤1：提取已知条件\n\n-   亨斯菲尔德单位 (HU) 定义：$HU = 1000 \\cdot \\frac{\\mu_{material} - \\mu_{\\text{water}}}{\\mu_{\\text{water}}}$\n-   窗位下限：$L = c - \\frac{w}{2}$\n-   窗位上限：$U = c + \\frac{w}{2}$\n-   窗位处理过程：\n    1.  将HU值裁剪到区间 [L, U]。\n    2.  将裁剪后的强度线性重新缩放至 [0, 1]。\n-   归一化过程：使用数据集级别的矩进行$z$-分数归一化。\n-   肺窗中心：$c = -600$\n-   肺窗宽度：$w = 1500$\n-   经过窗位调整和重新缩放的强度的数据集均值：$\\mu_{dataset} = 0.42$\n-   经过窗位调整和重新缩放的强度的数据集标准差：$\\sigma_{dataset} = 0.18$\n-   原始体素强度：$HU_{raw} = -750$\n-   要求输出：经过窗位调整和$z$-分数归一化后，四舍五入到四位有效数字的最终标量值。\n\n### 步骤2：使用提取的已知条件进行验证\n\n对问题进行验证。\n\n-   **科学依据：** 该问题具有科学依据。亨斯菲尔德单位、CT窗位技术和z-分数归一化的定义都是标准的且表述正确。肺窗的数值（$c=-600$，$w=1500$）、原始肺部HU值（-750 HU是典型的肺实质值）以及数据集统计数据（$\\mu=0.42$，$\\sigma=0.18$）在医学图像分析和深度学习的背景下都是真实且合理的。\n-   **适定性：** 该问题是适定的。它提供了执行计算序列所需的所有必要数据和定义。步骤清晰明确，导向唯一的解。\n-   **客观性：** 该问题以精确、客观的语言陈述，没有主观或模糊的术语。\n\n该问题没有表现出任何缺陷，如科学上不成立、不完整性、矛盾或不可行性。这是一个可形式化且可解的问题，与医学图像分析的深度学习领域直接相关。\n\n### 步骤3：结论与操作\n\n问题被判定为**有效**。将提供解答。\n\n计算按问题中定义的两个阶段进行：首先是窗位操作，其次是$z$-分数归一化。\n\n**阶段1：窗位调整与重新缩放**\n\n首先，我们确定指定肺窗的亨斯菲尔德单位区间 $[L, U]$。该窗位由中心 $c = -600$ 和宽度 $w = 1500$ 定义。\n\n下限 $L$ 计算如下：\n$$L = c - \\frac{w}{2} = -600 - \\frac{1500}{2} = -600 - 750 = -1350$$\n\n上限 $U$ 计算如下：\n$$U = c + \\frac{w}{2} = -600 + \\frac{1500}{2} = -600 + 750 = 150$$\n\n因此，窗位区间为 $[-1350, 150]$ HU。\n\n接下来，必须将原始体素强度 $HU_{raw} = -750$ 裁剪到此区间内。我们检查该值是否在边界内：\n$$-1350 \\leq -750 \\leq 150$$\n条件满足。因此，裁剪后的强度 $HU_{clipped}$ 等于原始强度：\n$$HU_{clipped} = -750$$\n\n此阶段的最后一步是将裁剪后的值从区间 $[L, U]$ 线性重新缩放至无量纲区间 $[0, 1]$。设 $I$ 为重新缩放后的强度。此线性映射的公式为：\n$$I = \\frac{HU_{clipped} - L}{U - L}$$\n\n代入已知值：\n$$I = \\frac{-750 - (-1350)}{150 - (-1350)} = \\frac{-750 + 1350}{150 + 1350} = \\frac{600}{1500}$$\n\n简化分数可得：\n$$I = \\frac{6}{15} = \\frac{2}{5} = 0.4$$\n这是中间的、经过窗位调整和重新缩放的值。\n\n**阶段2：Z-分数归一化**\n\n第二阶段是对重新缩放后的强度 $I$ 应用$z$-分数归一化。问题陈述此归一化使用整个训练数据集中经过窗位调整和重新缩放的值的经验均值 $\\mu_{dataset} = 0.42$ 和标准差 $\\sigma_{dataset} = 0.18$。\n\n$z$-分数的公式（我们记为 $z_{val}$）是：\n$$z_{val} = \\frac{x - \\mu}{\\sigma}$$\n在我们的情境中，数据点 $x$ 是重新缩放后的强度 $I = 0.4$，均值 $\\mu$ 是 $\\mu_{dataset} = 0.42$，标准差 $\\sigma$ 是 $\\sigma_{dataset} = 0.18$。\n\n将这些值代入$z$-分数公式：\n$$z_{val} = \\frac{0.4 - 0.42}{0.18} = \\frac{-0.02}{0.18}$$\n\n简化后可得：\n$$z_{val} = -\\frac{2}{18} = -\\frac{1}{9}$$\n\n问题要求最终答案是四舍五入到四位有效数字的小数。我们将分数转换为其小数表示形式：\n$$z_{val} = -0.111111...$$\n\n将此值四舍五入到四位有效数字，我们保留前四个非零数字。第一位有效数字是十分位上的 $1$。接下来的三位数字也是 $1$。第五位有效数字是 $1$，小于 $5$，所以我们不进行进位。\n\n最终值为 $-0.1111$。这是输入到CNN第一层的无量纲标量值。",
            "answer": "$$ \\boxed{-0.1111} $$"
        },
        {
            "introduction": "对于肿瘤分割等任务，模型的训练目标必须精确地反映期望的临床结果——即预测结果与真实标签（ground truth）之间在空间上的高度重叠。Sørensen–Dice系数是衡量这种重叠度的绝佳指标，但为了进行基于梯度的优化，必须将其转化为一个可微的损失函数。本练习  将引导您完成Dice损失函数及其梯度的基本推导，揭示一个几何相似性度量是如何被转化为驱动网络学习的信号的。",
            "id": "5004648",
            "problem": "在用于磁共振成像肿瘤分割的转化医学工作流中，考虑一个概率分割的场景，其中每个像素都被赋予一个预测为肿瘤阳性的概率。从Sørensen–Dice系数的定义开始，对于预测概率的非负向量 $p = (p_{1}, \\dots, p_{n})$ 和二元真实标签 $y = (y_{1}, \\dots, y_{n})$，该系数由以下基本表达式定义：\n$$\n\\mathrm{Dice}(p,y) = \\frac{2 \\sum_{i=1}^{n} p_{i} y_{i}}{\\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i}}.\n$$\n使用此核心定义以及经验风险最小化原则（该原则要求目标函数可微、随系数增加而减小，并且界于0和1之间），推导出一个合适的Dice损失泛函 $L(p,y)$，然后推导其对于通用索引 $k$ 的分量 $p_k$ 的梯度。最后，针对一个简单的双像素掩码，当真实标签为 $y = (1, 1)$、预测概率为 $p = (0.3, 0.7)$ 时，计算该梯度。将最终梯度表示为一个行矩阵，使用精确值且不进行四舍五入。无需提供物理单位。",
            "solution": "问题陈述具有科学依据、是适定的，并包含了得出唯一解所需的所有信息。所提供的定义和原则在医学图像分析的深度学习领域是标准的。因此，我们可以直接进行推导。\n\n该问题要求推导一个合适的损失泛函、其梯度，并进行一次具体的计算。我们将按顺序解决这些问题。\n\n首先，我们基于所提供的Sørensen–Dice系数 $\\mathrm{Dice}(p,y)$ 来定义一个合适的Dice损失泛函 $L(p,y)$。问题陈述该损失泛函必须是可微的、界于0和1之间，并且必须随着Dice系数的增加而减小。对于非负预测值 $p_i$ 和二元标签 $y_i$，Dice系数本身界于0（无重叠）和1（完全重叠）之间。一个满足所有陈述标准的简单且标准的选择是将损失定义为1减去Dice系数：\n$$\nL(p,y) = 1 - \\mathrm{Dice}(p,y)\n$$\n代入给定的Dice系数定义，我们得到：\n$$\nL(p,y) = 1 - \\frac{2 \\sum_{i=1}^{n} p_{i} y_{i}}{\\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i}}\n$$\n当Dice系数为1（最优）时，该损失函数为0；当Dice系数为0（最差情况）时，该损失函数为1，这对于一个待最小化的损失函数而言是期望的行为。只要分母不为零，该函数对 $p_i$ 就是可微的，这一条件在实践中通常通过添加一个小的平滑常数来保证，但此处未指定，因此在本次形式推导中将予以省略。\n\n其次，我们推导损失泛函 $L(p,y)$ 关于预测向量 $p$ 的一个分量 $p_k$ 的梯度。损失的梯度是Dice系数梯度的负值：\n$$\n\\frac{\\partial L(p,y)}{\\partial p_k} = - \\frac{\\partial}{\\partial p_k} \\left( \\frac{2 \\sum_{i=1}^{n} p_{i} y_{i}}{\\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i}} \\right)\n$$\n为应用除法求导法则，我们定义分子为 $N = 2 \\sum_{i=1}^{n} p_{i} y_{i}$，分母为 $D = \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i}$。除法求导法则为 $\\frac{\\partial}{\\partial x} (\\frac{N}{D}) = \\frac{D \\frac{\\partial N}{\\partial x} - N \\frac{\\partial D}{\\partial x}}{D^2}$。\n\n我们计算 $N$ 和 $D$ 关于 $p_k$ 的偏导数：\n和 $\\sum_{i=1}^{n} p_{i} y_{i}$ 关于 $p_k$ 的导数是 $y_k$，因为当 $i \\neq k$ 时，$p_i$ 与 $p_k$ 相互独立。因此：\n$$\n\\frac{\\partial N}{\\partial p_k} = \\frac{\\partial}{\\partial p_k} \\left( 2 \\sum_{i=1}^{n} p_{i} y_{i} \\right) = 2 y_k\n$$\n类似地，和 $\\sum_{i=1}^{n} p_i$ 关于 $p_k$ 的导数是 $1$。和 $\\sum_{i=1}^{n} y_i$ 相对于 $p_k$ 是一个常数。因此：\n$$\n\\frac{\\partial D}{\\partial p_k} = \\frac{\\partial}{\\partial p_k} \\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right) = 1\n$$\n将这些代入除法求导法则：\n$$\n\\frac{\\partial \\mathrm{Dice}(p,y)}{\\partial p_k} = \\frac{D \\frac{\\partial N}{\\partial p_k} - N \\frac{\\partial D}{\\partial p_k}}{D^2} = \\frac{\\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right) (2 y_k) - \\left( 2 \\sum_{i=1}^{n} p_{i} y_{i} \\right) (1)}{\\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right)^2}\n$$\n损失函数的梯度是该表达式的负值：\n$$\n\\frac{\\partial L(p,y)}{\\partial p_k} = - \\frac{2 y_k \\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right) - 2 \\sum_{i=1}^{n} p_{i} y_{i}}{\\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right)^2} = \\frac{2 \\sum_{i=1}^{n} p_{i} y_{i} - 2 y_k \\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right)}{\\left( \\sum_{i=1}^{n} p_{i} + \\sum_{i=1}^{n} y_{i} \\right)^2}\n$$\n这就是Dice损失关于单个预测概率 $p_k$ 的梯度的通用表达式。\n\n第三，我们针对所提供的具体案例计算此梯度：一个双像素掩码（$n=2$），其真实标签为 $y = (1, 1)$，预测概率为 $p = (0.3, 0.7)$。\n\n我们计算所需的各项和：\n预测概率之和：\n$$\n\\sum_{i=1}^{2} p_i = p_1 + p_2 = 0.3 + 0.7 = 1.0\n$$\n真实标签之和：\n$$\n\\sum_{i=1}^{2} y_i = y_1 + y_2 = 1 + 1 = 2.0\n$$\n概率与标签乘积之和：\n$$\n\\sum_{i=1}^{2} p_i y_i = p_1 y_1 + p_2 y_2 = (0.3)(1) + (0.7)(1) = 0.3 + 0.7 = 1.0\n$$\n现在我们可以计算 $k=1$ 和 $k=2$ 时的偏导数。\n\n对于 $k=1$，我们有 $p_k = p_1 = 0.3$ 和 $y_k = y_1 = 1$。\n$$\n\\frac{\\partial L}{\\partial p_1} = \\frac{2 (1.0) - 2 (1) (1.0 + 2.0)}{(1.0 + 2.0)^2} = \\frac{2 - 2(3)}{3^2} = \\frac{2 - 6}{9} = -\\frac{4}{9}\n$$\n对于 $k=2$，我们有 $p_k = p_2 = 0.7$ 和 $y_k = y_2 = 1$。由于 $y_1 = y_2 = 1$，计算过程是相同的。\n$$\n\\frac{\\partial L}{\\partial p_2} = \\frac{2 (1.0) - 2 (1) (1.0 + 2.0)}{(1.0 + 2.0)^2} = \\frac{2 - 2(3)}{3^2} = \\frac{2 - 6}{9} = -\\frac{4}{9}\n$$\n因此，损失函数 $L(p,y)$ 关于向量 $p$ 的梯度为 $\\nabla_p L = \\left( \\frac{\\partial L}{\\partial p_1}, \\frac{\\partial L}{\\partial p_2} \\right) = \\left(-\\frac{4}{9}, -\\frac{4}{9}\\right)$。问题要求将其表示为行矩阵。",
            "answer": "$$\n\\boxed{\\begin{pmatrix} -\\frac{4}{9}  -\\frac{4}{9} \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "在医学影像领域，开发复杂、高分辨率的三维模型的雄心常常会遇到一个硬性物理限制：GPU内存。成功训练这些模型需要精确理解不同组件——模型参数、优化器状态和批处理数据——是如何消耗这一有限资源的。本练习  提供了一种基于第一性原理的内存使用量估算方法，这项技能对于确定最大可行批量大小以及在模型架构和训练策略方面做出明智决策至关重要。",
            "id": "5004649",
            "problem": "一个转化放射学团队正在开发一种三维卷积神经网络，用于从多模态磁共振成像（MRI）扫描中分割胶质瘤亚区，旨在对该流程进行前瞻性验证以用于临床部署。训练使用图形处理器（GPU）加速和混合精度：前向传播的激活值和数据张量使用半精度（float16），而模型参数、优化器状态和梯度则使用单精度（float32）。优化器为自适应矩估计（Adam），该优化器会为参数维护两个形状相同的矩向量。假设为单节点训练，无梯度累积。\n\n该网络消耗的输入区块具有 $C_{\\text{in}} = 4$ 种 MRI 模态，空间维度为 $D = 128$、$H = 128$ 和 $W = 128$，并为每个体素生成类别对数（logits），其中 $C_{\\text{out}} = 3$ 个类别。每个训练样本包括一个标签张量，其形状为 $(D,H,W)$，包含整数类索引。该团队通过梯度检查点技术对架构进行了分析，并测得每个样本保留的前向激活值（为反向传播必须存储的激活值）总数等于输入元素数量的 $r_{\\text{eff}}$ 倍，其中 $r_{\\text{eff}} = 180$。假设使用以下数据类型（dtypes）和内存约定：\n- 输入和对数（logits）张量在训练期间以 float16 格式存储。\n- 保留的前向激活值为 float16 格式。\n- 模型参数、梯度和 Adam 矩向量（$m$ 和 $v$）为 float32 格式。\n- 标签为 $16$ 位整数。\n- 有 $1$ 吉比字节（gibibyte）的固定库/工作空间开销。\n- 一吉比字节等于 $2^{30}$ 字节；一兆比字节（mebibyte）等于 $2^{20}$ 字节。\n\n该模型具有 $P = 67{,}108{,}864$ 个可训练参数。内存预算为单个 GPU，拥有 $24$ 吉比字节。根据内存等于元素数量乘以每个元素的字节数这一定义，以及 Adam 优化器会维护两个与参数大小相同的辅助矩张量，计算最大可行整数批量大小 $B_{\\max}$，使得批量大小为 $B$ 时分配的总训练内存不超过 $24$ 吉比字节的预算。请将您的最终答案表示为 $B_{\\max}$ 的整数值。",
            "solution": "该问题要求确定在固定的内存预算下，于单个图形处理器（GPU）上训练深度学习模型的最大可行整数批量大小，表示为 $B_{\\max}$。总内存消耗 $M_{\\text{total}}$ 不得超过可用的 GPU 内存 $M_{\\text{budget}}$。\n\n为解决此问题，我们首先将总内存使用量形式化为批量大小 $B$ 的函数。总内存可分解为两个主要部分：\n$1$. 静态内存 $M_{\\text{static}}$，它与批量大小无关。这包括模型参数、其对应的梯度、优化器状态以及任何固定的系统开销。\n$2$. 动态内存 $M_{\\text{dynamic}}$，它随批量大小 $B$ 线性增长。这包括输入数据批次、相应的标签、保留的前向传播激活值以及输出的对数（logits）所占用的内存。\n\n控制性约束由以下不等式表示：\n$$M_{\\text{total}}(B) = M_{\\text{static}} + B \\times m_{\\text{dynamic}} \\le M_{\\text{budget}}$$\n其中 $m_{\\text{dynamic}}$ 是批次中每个样本所需的内存。我们必须根据所提供的规格计算 $M_{\\text{static}}$ 和 $m_{\\text{dynamic}}$。\n\n首先，我们定义相关的常量和数据大小（以字节为单位）：\n- 单精度浮点数 (`float32`) 的大小：$S_{f32} = 4$ 字节。\n- 半精度浮点数 (`float16`) 的大小：$S_{f16} = 2$ 字节。\n- $16$ 位整数的大小：$S_{i16} = 2$ 字节。\n- 可训练参数总数：$P = 67{,}108{,}864$。\n- 输入张量维度：$C_{\\text{in}} = 4$, $D = 128$, $H = 128$, $W = 128$。\n- 输出张量类别数：$C_{\\text{out}} = 3$。\n- 激活值保留因子：$r_{\\text{eff}} = 180$。\n- 固定开销：$M_{\\text{overhead}} = 1$ 吉比字节 $= 2^{30}$ 字节。\n- GPU 总内存预算：$M_{\\text{budget}} = 24$ 吉比字节 $= 24 \\times 2^{30}$ 字节。\n\n我们来分析参数数量 $P$。我们观察到 $P = 67{,}108{,}864 = 64 \\times 1024^2 = 2^6 \\times (2^{10})^2 = 2^6 \\times 2^{20} = 2^{26}$。这将简化计算。\n\n接下来，我们计算静态内存 $M_{\\text{static}}$。它是模型参数、梯度、优化器状态和固定开销的内存总和。\n- 参数内存 ($M_{\\text{params}}$)：$P$ 个参数以 `float32` 格式存储。\n  $$M_{\\text{params}} = P \\times S_{f32}$$\n- 梯度内存 ($M_{\\text{grads}}$)：为每个参数存储一个 `float32` 类型的梯度。\n  $$M_{\\text{grads}} = P \\times S_{f32}$$\n- 优化器状态内存 ($M_{\\text{optim}}$)：Adam 优化器为每个参数维护两个矩向量（$m$ 和 $v$），两者均为 `float32` 格式。\n  $$M_{\\text{optim}} = 2 \\times P \\times S_{f32}$$\n模型权重和优化器的总内存是这三个部分的总和：\n$$M_{\\text{model}} = M_{\\text{params}} + M_{\\text{grads}} + M_{\\text{optim}} = (1 + 1 + 2) \\times P \\times S_{f32} = 4 P S_{f32}$$\n代入数值：\n$$M_{\\text{model}} = 4 \\times 2^{26} \\times 4 = 2^2 \\times 2^{26} \\times 2^2 = 2^{30} \\text{ 字节}$$\n这正好是 $1$ 吉比字节。\n总静态内存是 $M_{\\text{model}}$ 加上固定开销：\n$$M_{\\text{static}} = M_{\\text{model}} + M_{\\text{overhead}} = 2^{30} \\text{ 字节} + 1 \\times 2^{30} \\text{ 字节} = 2 \\times 2^{30} \\text{ 字节}$$\n因此，$M_{\\text{static}} = 2$ 吉比字节。\n\n现在，我们计算每个样本的动态内存 $m_{\\text{dynamic}}$。这是批量大小 $B=1$ 时所需的内存。令 $V$ 为一个空间体积中的体素数：\n$$V = D \\times H \\times W = 128 \\times 128 \\times 128 = (2^7)^3 = 2^{21}$$\n每个样本内存的组成部分如下：\n- 输入张量内存 ($m_{\\text{input}}$)：$C_{\\text{in}} \\times V$ 个 `float16` 类型的元素。\n  $$m_{\\text{input}} = C_{\\text{in}} \\times V \\times S_{f16}$$\n- 标签张量内存 ($m_{\\text{labels}}$)：$V$ 个 $16$ 位整数类型的元素。\n  $$m_{\\text{labels}} = V \\times S_{i16}$$\n- 保留的激活值内存 ($m_{\\text{act}}$)：保留的元素数量是输入元素数量（$C_{\\text{in}} \\times V$）的 $r_{\\text{eff}}$ 倍。这些元素以 `float16` 格式存储。\n  $$m_{\\text{act}} = r_{\\text{eff}} \\times (C_{\\text{in}} \\times V) \\times S_{f16}$$\n- 输出对数（logits）内存 ($m_{\\text{logits}}$)：$C_{\\text{out}} \\times V$ 个 `float16` 类型的元素。\n  $$m_{\\text{logits}} = C_{\\text{out}} \\times V \\times S_{f16}$$\n每个样本的总动态内存是以上各项之和：\n$$m_{\\text{dynamic}} = m_{\\text{input}} + m_{\\text{labels}} + m_{\\text{act}} + m_{\\text{logits}}$$\n$$m_{\\text{dynamic}} = (C_{\\text{in}} V S_{f16}) + (V S_{i16}) + (r_{\\text{eff}} C_{\\text{in}} V S_{f16}) + (C_{\\text{out}} V S_{f16})$$\n提取公因式 $V$：\n$$m_{\\text{dynamic}} = V \\times [ (C_{\\text{in}} + r_{\\text{eff}}C_{\\text{in}} + C_{\\text{out}})S_{f16} + S_{i16} ]$$\n代入给定值：\n$C_{\\text{in}} = 4$，$C_{\\text{out}} = 3$，$r_{\\text{eff}} = 180$，$S_{f16}=2$，$S_{i16}=2$，$V=2^{21}$。\n$$m_{\\text{dynamic}} = 2^{21} \\times [ (4 + 180 \\times 4 + 3) \\times 2 + 2 ]$$\n$$m_{\\text{dynamic}} = 2^{21} \\times [ (4 + 720 + 3) \\times 2 + 2 ]$$\n$$m_{\\text{dynamic}} = 2^{21} \\times [ 727 \\times 2 + 2 ]$$\n$$m_{\\text{dynamic}} = 2^{21} \\times [ 1454 + 2 ]$$\n$$m_{\\text{dynamic}} = 2^{21} \\times 1456 \\text{ 字节}$$\n\n计算出 $M_{\\text{static}}$ 和 $m_{\\text{dynamic}}$ 后，我们就可以求解 $B_{\\max}$。可用于动态分配的内存为 $M_{\\text{budget}} - M_{\\text{static}}$：\n$$M_{\\text{available}} = M_{\\text{budget}} - M_{\\text{static}} = 24 \\times 2^{30} - 2 \\times 2^{30} = 22 \\times 2^{30} \\text{ 字节}$$\n最大批量大小 $B$ 必须满足：\n$$B \\times m_{\\text{dynamic}} \\le M_{\\text{available}}$$\n$$B \\le \\frac{M_{\\text{available}}}{m_{\\text{dynamic}}}$$\n由于批量大小必须是整数，我们对结果值向下取整：\n$$B_{\\max} = \\left\\lfloor \\frac{M_{\\text{available}}}{m_{\\text{dynamic}}} \\right\\rfloor = \\left\\lfloor \\frac{22 \\times 2^{30}}{1456 \\times 2^{21}} \\right\\rfloor$$\n简化表达式：\n$$B_{\\max} = \\left\\lfloor \\frac{22 \\times 2^{(30-21)}}{1456} \\right\\rfloor = \\left\\lfloor \\frac{22 \\times 2^{9}}{1456} \\right\\rfloor$$\n因为 $2^9 = 512$：\n$$B_{\\max} = \\left\\lfloor \\frac{22 \\times 512}{1456} \\right\\rfloor = \\left\\lfloor \\frac{11264}{1456} \\right\\rfloor$$\n进行除法运算：\n$$\\frac{11264}{1456} \\approx 7.73626...$$\n向下取整得到最大整数批量大小：\n$$B_{\\max} = \\lfloor 7.73626... \\rfloor = 7$$\n因此，最大可行整数批量大小为 $7$。",
            "answer": "$$\\boxed{7}$$"
        }
    ]
}