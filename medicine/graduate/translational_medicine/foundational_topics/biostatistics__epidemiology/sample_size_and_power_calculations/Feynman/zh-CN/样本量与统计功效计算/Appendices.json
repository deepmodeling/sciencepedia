{
    "hands_on_practices": [
        {
            "introduction": "我们从一项基础实践开始，它涉及连续性结果的样本量计算，这是样本量设计的基石。这项练习  不仅仅是简单地套用公式，它要求您从假设检验和统计功效的基本定义出发，推导出核心方程。更重要的是，它引导您像一名真正的转化医学科学家那样思考：当研究规划所依赖的参数（例如总体标准差 $\\sigma$）存在不确定性时，采用一个保守的估计值将如何保障研究的功效。",
            "id": "4778541",
            "problem": "计划进行一项心血管医学领域的单臂初步研究，以评估一种新的生活方式干预是否能对收缩压产生非零的改变。设 $X_{1}, X_{2}, \\dots, X_{n}$ 是个体变化分数的独立同分布测量值，建模为均值为 $\\mu$、已知总体标准差为 $\\sigma$ 的高斯分布。主要分析将使用基于样本均值的标准正态检验，在显著性水平 $\\alpha = 0.05$ 下，检验双侧原假设 $H_{0}: \\mu = \\mu_{0}$ 与备择假设 $H_{1}: \\mu \\neq \\mu_{0}$。临床上有意义的效应是真实均值差为 $\\delta = \\mu - \\mu_{0} = 2$，并且设计要求在 $H_{1}$ 下的统计功效为 $1 - \\beta = 0.80$。\n\n仅从原假设和备择假设下检验统计量的分布以及统计功效的定义出发，推导当 $\\sigma = 5$ 时，对于 $\\alpha = 0.05$ 的双侧检验，保证至少达到目标功效所需的最小整数样本量 $n$。您可以假定标准正态分布及其分位数的通常性质。报告满足要求的最小整数 $n$。\n\n接着，考虑一个规划情景，其中真实的 $\\sigma$ 未知，而使用了一个保守的规划值 $s$，且 $s > \\sigma$。用文字和符号讨论，在规划计算中用这样一个高估的 $s$ 替代 $\\sigma$，当实际数据遵循所述模型时，如何影响达到的功效和 I 型错误。并量化所需的 $n$ 相对于 $\\sigma$ 如何随 $s$ 缩放。这部分不要求计算；请基于同样的基础和正态分位数提供一个有原则的论证。\n\n最终数值答案必须是一个单一数字，且必须是最小整数 $n$；最终答案框中不需要单位。如果使用了任何近似，请确保它保证达到至少目标功效，而不是更少。",
            "solution": "该问题要求推导单样本、双侧 z 检验的最小样本量，然后对规划阶段高估总体标准差的影响进行概念性分析。\n\n### 第 1 部分：样本量计算\n\n该问题经确认为具有科学依据、问题明确且客观。它代表了统计功效分析的一个标准应用。\n\n**1. 检验统计量和拒绝域**\n\n设 $X_{1}, X_{2}, \\dots, X_{n}$ 是来自一个均值为 $\\mu$、已知标准差为 $\\sigma$ 的高斯分布的独立同分布随机变量样本。我们检验原假设 $H_{0}: \\mu = \\mu_{0}$ 与备择假设 $H_{1}: \\mu \\neq \\mu_{0}$。样本均值为 $\\bar{X} = \\frac{1}{n}\\sum_{i=1}^{n} X_{i}$。\n\n在 $H_{0}$ 下，样本均值服从分布 $\\bar{X} \\sim N(\\mu_{0}, \\sigma^{2}/n)$。检验统计量是标准化的样本均值：\n$$Z = \\frac{\\bar{X} - \\mu_{0}}{\\sigma/\\sqrt{n}}$$\n在 $H_{0}$ 下，$Z$ 服从标准正态分布，$Z \\sim N(0, 1)$。\n\n对于显著性水平为 $\\alpha$ 的双侧检验，如果检验统计量的观测值落在分布的尾部，我们就拒绝 $H_{0}$。拒绝域由 $|Z| > z_{1-\\alpha/2}$ 定义，其中 $z_{1-\\alpha/2}$ 是标准正态分布的 $(1-\\alpha/2)$-分位数。这对应于在以下情况下拒绝 $H_{0}$：\n$$\\frac{\\bar{X} - \\mu_{0}}{\\sigma/\\sqrt{n}} > z_{1-\\alpha/2} \\quad \\text{或} \\quad \\frac{\\bar{X} - \\mu_{0}}{\\sigma/\\sqrt{n}}  -z_{1-\\alpha/2}$$\n等价地，样本均值 $\\bar{X}$ 的拒绝域是：\n$$\\bar{X} > \\mu_{0} + z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}} \\quad \\text{或} \\quad \\bar{X}  \\mu_{0} - z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}}$$\n\n**2. 统计功效**\n\n统计功效 $1-\\beta$ 是当备择假设 $H_{1}$ 为真时，正确拒绝 $H_{0}$ 的概率。我们考虑一个特定的备择假设，其中真实均值为 $\\mu_{1} = \\mu_{0} + \\delta$，$\\delta$ 是临床上有意义的效应大小。在此备择假设下，$\\bar{X} \\sim N(\\mu_{1}, \\sigma^{2}/n)$。\n\n功效是样本均值 $\\bar{X}$ 落在拒绝域内的概率，该概率在 $H_{1}$ 指定的分布下计算：\n$$1 - \\beta = P\\left(\\bar{X} > \\mu_{0} + z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}} \\bigg| \\mu=\\mu_{1}\\right) + P\\left(\\bar{X}  \\mu_{0} - z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}} \\bigg| \\mu=\\mu_{1}\\right)$$\n为了评估这些概率，我们相对于其在 $H_{1}$ 下的分布来标准化 $\\bar{X}$。设 $Z' = \\frac{\\bar{X} - \\mu_{1}}{\\sigma/\\sqrt{n}}$。在 $H_{1}$ 下，$Z' \\sim N(0, 1)$。我们可以将 $\\bar{X}$ 表示为 $\\bar{X} = \\mu_{1} + Z'(\\sigma/\\sqrt{n})$。将此代入拒绝域的不等式：\n$$1 - \\beta = P\\left(\\mu_{1} + Z'\\frac{\\sigma}{\\sqrt{n}} > \\mu_{0} + z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}}\\right) + P\\left(\\mu_{1} + Z'\\frac{\\sigma}{\\sqrt{n}}  \\mu_{0} - z_{1-\\alpha/2}\\frac{\\sigma}{\\sqrt{n}}\\right)$$\n整理关于 $Z'$ 的不等式并使用 $\\mu_{1} - \\mu_{0} = \\delta$：\n$$1 - \\beta = P\\left(Z' > z_{1-\\alpha/2} - \\frac{\\delta\\sqrt{n}}{\\sigma}\\right) + P\\left(Z'  -z_{1-\\alpha/2} - \\frac{\\delta\\sqrt{n}}{\\sigma}\\right)$$\n设 $\\Phi(\\cdot)$ 是标准正态分布的累积分布函数 (CDF)。功效是：\n$$1 - \\beta = \\left[1 - \\Phi\\left(z_{1-\\alpha/2} - \\frac{\\delta\\sqrt{n}}{\\sigma}\\right)\\right] + \\Phi\\left(-z_{1-\\alpha/2} - \\frac{\\delta\\sqrt{n}}{\\sigma}\\right)$$\n使用对称性属性 $\\Phi(-x) = 1 - \\Phi(x)$，第一项变为 $\\Phi\\left(\\frac{\\delta\\sqrt{n}}{\\sigma} - z_{1-\\alpha/2}\\right)$。对于 $\\delta > 0$ 的指定备择假设，第二项的参数 $-z_{1-\\alpha/2} - \\frac{\\delta\\sqrt{n}}{\\sigma}$ 是一个大的负数。取到如此小的值的概率 $\\Phi$ 是可以忽略不计的。因此，一个标准且高度准确的近似是只考虑第一项，它代表在正确的尾部拒绝：\n$$1 - \\beta \\approx \\Phi\\left(\\frac{|\\delta|\\sqrt{n}}{\\sigma} - z_{1-\\alpha/2}\\right)$$\n使用绝对值 $|\\delta|$ 是为了推广到 $\\mu_{0}$ 两侧的备择假设。\n\n**3. 样本量公式的推导**\n\n为了求出样本量 $n$，我们求解近似的功效方程。对两边应用标准正态CDF的反函数，即分位数函数 $\\Phi^{-1}(\\cdot)=z_{(\\cdot)}$：\n$$\\Phi^{-1}(1-\\beta) \\approx \\frac{|\\delta|\\sqrt{n}}{\\sigma} - z_{1-\\alpha/2}$$\n根据定义，$\\Phi^{-1}(1-\\beta) = z_{1-\\beta}$。\n$$z_{1-\\beta} \\approx \\frac{|\\delta|\\sqrt{n}}{\\sigma} - z_{1-\\alpha/2}$$\n解出 $n$：\n$$z_{1-\\alpha/2} + z_{1-\\beta} \\approx \\frac{|\\delta|\\sqrt{n}}{\\sigma}$$\n$$\\sqrt{n} \\approx \\frac{\\sigma(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|}$$\n$$n \\approx \\left( \\frac{\\sigma(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|} \\right)^{2}$$\n\n**4. 数值计算**\n\n给定以下值：\n- 显著性水平 $\\alpha = 0.05$。\n- 功效 $1 - \\beta = 0.80$，所以 $\\beta = 0.20$。\n- 标准差 $\\sigma = 5$。\n- 效应大小 $\\delta = 2$，所以 $|\\delta| = 2$。\n\n所需的标准正态分布分位数为：\n- $z_{1-\\alpha/2} = z_{1-0.025} = z_{0.975} \\approx 1.95996$。\n- $z_{1-\\beta} = z_{1-0.20} = z_{0.80} \\approx 0.84162$。\n\n将这些值代入 $n$ 的公式：\n$$n \\approx \\left( \\frac{5 \\times (1.95996 + 0.84162)}{2} \\right)^{2}$$\n$$n \\approx \\left( \\frac{5 \\times 2.80158}{2} \\right)^{2}$$\n$$n \\approx (2.5 \\times 2.80158)^{2}$$\n$$n \\approx (7.00395)^{2}$$\n$$n \\approx 49.0553$$\n由于样本量 $n$ 必须是整数，我们必须取该值的上取整（ceiling），以确保功效至少达到目标值 $0.80$。选择 $n=49$ 会导致功效略低于 $0.80$。因此，最小整数样本量为：\n$$n = 50$$\n\n### 第 2 部分：高估标准差的影响\n\n我们现在分析这样一种情景：研究是使用标准差的保守估计值 $s$ 来规划的，使得 $s > \\sigma$，其中 $\\sigma$ 是真实值。\n\n**1. 对所需样本量 ($n$) 的影响**\n\n样本量计算基于公式 $n = \\left(\\frac{\\text{SD} \\times (z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|}\\right)^{2}$。在规划阶段，我们使用 $s$ 作为标准差 (SD)。规划的样本量 $n_{plan}$ 将是：\n$$n_{plan} = \\left( \\frac{s(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|} \\right)^{2}$$\n如果已知真实 $\\sigma$，本应足够的样本量是 $n_{true} = \\left( \\frac{\\sigma(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|} \\right)^{2}$。\n两者之间的关系是：\n$$\\frac{n_{plan}}{n_{true}} = \\frac{\\left(s/|\\delta|\\right)^{2}}{\\left(\\sigma/|\\delta|\\right)^{2}} = \\left(\\frac{s}{\\sigma}\\right)^{2}$$\n因为 $s > \\sigma$，所以 $(s/\\sigma)^{2} > 1$，因此 $n_{plan} > n_{true}$。所需的样本量随标准差估计值的平方缩放。高估标准差会导致招募比严格必要时更大的样本量。\n\n**2. 对 I 型错误率 ($\\alpha$) 的影响**\n\nI 型错误率 $\\alpha$ 是当 $H_0$ 为真时拒绝它的概率。这个率由检验的临界值 $z_{1-\\alpha/2}$ 的选择所固定。用于最终数据分析的检验统计量是 $Z = \\frac{\\bar{X} - \\mu_0}{\\sigma / \\sqrt{n}}$，其中 $n$ 是使用的样本量，$\\sigma$ 是真实的（且已知的）总体标准差。规划值 $s$ 仅用于确定 $n$；它不进入最终分析。拒绝 $H_0$ 的条件是 $|Z| > z_{1-\\alpha/2}$。在 $H_0$ 下，$Z \\sim N(0, 1)$，无论 $n$ 的具体值或它是如何选择的。因此，I 型错误的概率仍然恰好是 $\\alpha$。使用保守的估计值 $s$ 进行规划，对检验的实际 I 型错误率**没有影响**。\n\n**3. 对达成功效 ($1-\\beta$) 的影响**\n\n研究使用通过 $s$ 推导出的样本量 $n_{plan}$ 进行。达成功效是在给定样本量 $n_{plan}$ 和真实标准差 $\\sigma$ 的情况下，对于一个真实的效应大小 $|\\delta|$，拒绝 $H_0$ 的实际概率。达成功效是：\n$$\\text{Power}_{\\text{achieved}} \\approx \\Phi\\left(\\frac{|\\delta|\\sqrt{n_{plan}}}{\\sigma} - z_{1-\\alpha/2}\\right)$$\n我们知道 $\\sqrt{n_{plan}} = \\frac{s(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|}$。将此代入功效表达式：\n$$\\text{Power}_{\\text{achieved}} \\approx \\Phi\\left(\\frac{|\\delta|}{\\sigma} \\frac{s(z_{1-\\alpha/2} + z_{1-\\beta})}{|\\delta|} - z_{1-\\alpha/2}\\right)$$\n$$\\text{Power}_{\\text{achieved}} \\approx \\Phi\\left(\\frac{s}{\\sigma}(z_{1-\\alpha/2} + z_{1-\\beta}) - z_{1-\\alpha/2}\\right)$$\n令 $c = s/\\sigma$。因为 $s > \\sigma$，我们有 $c > 1$。\n$$\\text{Power}_{\\text{achieved}} \\approx \\Phi\\left(c z_{1-\\alpha/2} + c z_{1-\\beta} - z_{1-\\alpha/2}\\right) = \\Phi\\left((c-1)z_{1-\\alpha/2} + c z_{1-\\beta}\\right)$$\n目标功效 $1-\\beta$ 对应于 $\\Phi$ 函数中参数为 $z_{1-\\beta}$ 的情况（即 $1-\\beta = \\Phi(z_{1-\\beta})$）。为了将达成功效与目标功效进行比较，我们比较它们在 CDF 中的参数：\n$$(c-1)z_{1-\\alpha/2} + c z_{1-\\beta} \\quad \\text{与} \\quad z_{1-\\beta}$$\n差值为 $(c-1)z_{1-\\alpha/2} + (c-1)z_{1-\\beta} = (c-1)(z_{1-\\alpha/2} + z_{1-\\beta})$。\n因为 $c > 1$，所以 $(c-1)$ 是正的。分位数 $z_{1-\\alpha/2}$ 和 $z_{1-\\beta}$ 也是正的（对于典型的 $\\alpha=0.05$ 和功效 $ >0.5$）。因此，差值是严格为正的。\n$$(c-1)z_{1-\\alpha/2} + c z_{1-\\beta} > z_{1-\\beta}$$\n因为 $\\Phi$ 是一个单调递增函数，所以可以得出：\n$$\\text{Power}_{\\text{achieved}} > 1-\\beta$$\n因此，使用一个高估的标准差 $s$ 进行规划，会得出一个样本量 $n_{plan}$，该样本量产生的达成功效大于目标水平 $1-\\beta$。这就是为什么这种做法被认为是“保守的”：如果初始对变异性的估计过于乐观（即太低），它可以保护研究不至于功效不足。",
            "answer": "$$\\boxed{50}$$"
        },
        {
            "introduction": "理论上的样本量只是研究设计的第一步，真实世界的研究要复杂得多。这项实践  聚焦于一个在临床试验规划中至关重要且极为现实的问题：受试者脱落。您将学习如何调整初始招募目标，以弥补预期的受试者流失，从而确保完成研究的最终分析人数足以维持预设的统计功效。这个看似简单的计算，是确保研究稳健性的必备技能。",
            "id": "4579232",
            "problem": "一个预防医学团队正在设计一项双臂社区随机对照试验（Randomized Controlled Trial (RCT)），以评估邮寄结直肠癌筛查试剂盒对六个月内完成筛查的影响。主要结局是二元的（完成 vs. 未完成），基于比较比例的标准大样本近似法进行的未经调整的样本量计算表明，在固定的I型错误率下，每组需要 $300$ 名参与者才能达到期望的统计功效。然而，由于预期的失访和退出，团队预计每组的损耗比例为 $0.15$。\n\n假设统计功效取决于可分析的参与者数量，并且损耗与治疗分配和结局无关。团队希望计划每组的初始招募人数，以使每组预期的可分析参与者数量等于未经调整的要求。\n\n仅使用这些假设和定义（损耗比例为 $a$ 时，预期保留比例为 $1 - a$），计算每组最终计划招募的参与者数量。由于参与者计数是离散的，将最终计划计数报告为不小于计算值的最小整数（向上取整）。请以每组参与者的单个整数计数的格式提供您的答案。除此整数约束外，不需要进行额外的四舍五入。",
            "solution": "问题陈述经评估为有效。它在科学上基于生物统计学和临床试验设计的原则，特别涉及针对参与者损耗的样本量调整。问题提取得当，提供了所有必要的数据和明确的目标。语言精确客观，假设明确说明。\n\n设 $N_{unadj}$ 表示为达到期望统计功效所需的每组未经调整的样本量。这是必须完成研究并纳入最终分析的目标参与者数量。根据问题陈述，我们得到：\n$$ N_{unadj} = 300 $$\n\n设 $a$ 为预期失访或退出的参与者比例（损耗）。问题给出的值为：\n$$ a = 0.15 $$\n\n因此，预期保留并提供可分析数据的参与者比例为 $1 - a$。\n\n设 $N_{initial}$ 为试验每组最初招募的参与者数量。每组预期的可分析参与者数量，我们可表示为 $E[N_{final}]$，是初始招募的参与者数量乘以预期保留比例。这个关系表示为：\n$$ E[N_{final}] = N_{initial} \\times (1 - a) $$\n\n问题的核心要求是确定初始招募人数 $N_{initial}$，使得预期的可分析参与者数量等于未经调整的样本量要求 $N_{unadj}$。我们可以建立以下等式：\n$$ E[N_{final}] = N_{unadj} $$\n\n代入 $E[N_{final}]$ 的表达式，我们得到：\n$$ N_{initial} \\times (1 - a) = N_{unadj} $$\n\n为了求出所需的初始参与者数量，我们可以解这个关于 $N_{initial}$ 的方程：\n$$ N_{initial} = \\frac{N_{unadj}}{1 - a} $$\n\n现在，我们将给定的数值代入这个公式：\n$$ N_{initial} = \\frac{300}{1 - 0.15} $$\n$$ N_{initial} = \\frac{300}{0.85} $$\n\n进行除法运算：\n$$ N_{initial} \\approx 352.941176... $$\n\n参与者的数量必须是整数，因为它代表个体的人数。问题规定，最终计划的计数应报告为不小于计算值的最小整数。这个数学运算是向上取整函数，表示为 $\\lceil \\cdot \\rceil$。因此，每组最终计划的参与者数量 $N_{planned}$ 是：\n$$ N_{planned} = \\lceil N_{initial} \\rceil = \\lceil 352.941176... \\rceil $$\n$$ N_{planned} = 353 $$\n\n为确保预期的可分析参与者数量至少为 $300$ 人，团队必须在试验的每组中招募 $353$ 名个体。",
            "answer": "$$\\boxed{353}$$"
        },
        {
            "introduction": "转化医学研究经常处理复杂的终点指标，例如事件发生次数，这类数据往往不遵循简单的概率分布。这项高级实践  旨在解决此类挑战，要求您为一个服从负二项分布的“过度离散”计数型数据设计研究。在这里，您将不再依赖简单的封闭式公式，而是通过编写一个数值搜索程序，在一个关键的“滋扰参数”（即离散度参数）的可能取值范围内，校准出能够保证最低统计功效的样本量。这种方法代表了现代生物统计学在面对不确定性时设计稳健研究的前沿技术。",
            "id": "5059803",
            "problem": "一项双臂随机转化医学研究将比较对照组与干预组之间的事件计数终点。已知每位参与者的事件计数相对于泊松模型存在过度离散现象。假设每位参与者的计数采用负二项分布（NB）进行建模，其特征为均值 $\\,\\mu\\,$ 和过度离散参数 $\\,k\\,$，使得方差满足 $\\,\\mathrm{Var}(Y)=\\mu+\\mu^2/k\\,$。设对照组均值为 $\\,\\mu_c\\,$，干预组均值为 $\\,\\mu_t=r\\mu_c\\,$（其中 $\\,r\\,$ 为指定的率比），每组分配 $\\,n\\,$ 名参与者。\n\n您必须设计一个程序来校准每组的样本量 $\\,n\\,$，使得在显著性水平为 $\\,\\alpha\\,$ 的组间均值相等的双边检验中，在过度离散参数 $\\,k\\,$ 的一个合理范围内，最小统计功效（以小数表示，而非百分号）能够达到或超过一个指定的目标值。$\\,k\\,$ 的合理范围由 $\\,k\\,$ 的对数正态分布定义，其中 $\\,\\log k\\,$ 服从均值为 $\\,\\mu_{\\log k}\\,$、标准差为 $\\,\\sigma_{\\log k}\\,$ 的正态分布。您不必对 $\\,k\\,$ 进行随机抽样，而是必须在一个由指定数量的网格点构成的 $\\,k\\,$ 值网格上评估功效，该网格跨越 $\\,k\\,$ 的对数正态分布的两个分位数 $\\,q_{\\mathrm{low}}\\,$ 和 $\\,q_{\\mathrm{high}}\\,$ 之间的区间。在该网格上，计算最小功效；校准后的样本量 $\\,n\\,$ 是在提供的搜索区间内，能够达到或超过目标最小功效的最小整数。\n\n您的检验构建应基于基本的大样本原理：使用中心极限定理（CLT）和负二项分布的方差性质来论证一个用于检验组间均值差异的双样本 Wald 型检验，而无需依赖特定于软件的负二项回归拟合。不要使用样本量计算的快捷公式；请从第一性原理出发，通过数值评估来演示功效的计算过程。\n\n您的程序必须为每个测试用例实现以下逻辑：\n- 构建一个在 $\\,q_{\\mathrm{low}}\\,$ 和 $\\,q_{\\mathrm{high}}\\,$ 之间均匀间隔的分位数水平网格。使用由 $\\,\\mu_{\\log k}\\,$ 和 $\\,\\sigma_{\\log k}\\,$ 指定的对数正态分布，将每个分位数水平映射到一个 $\\,k\\,$ 值。\n- 对于一个候选的每组样本量 $\\,n\\,$，使用显著性水平为 $\\,\\alpha\\,$ 的双边 Wald 型检验（$\\,H_0:\\mu_t=\\mu_c\\,$ vs. $\\,H_1:\\mu_t\\neq\\mu_c\\,$），计算在每个 $\\,k\\,$ 网格值处的功效。使用中心极限定理和负二项分布的方差来论证在备择假设 $\\,\\mu_t=r\\mu_c\\,$ 下检验统计量的分布。通过取最小值来汇总整个 $\\,k\\,$ 网格上的功效值。\n- 在指定的整数搜索区间内增加 $\\,n\\,$，直到 $\\,k\\,$ 网格上的最小功效达到或超过目标值。报告满足条件的最小 $\\,n\\,$。如果区间内没有 $\\,n\\,$ 满足目标，则报告该区间的上界。\n\n所有输出都必须是无单位的数字。功效以小数表示，而非百分比。\n\n测试套件：\n为以下四个测试用例提供解决方案。在每个用例中，输出必须是校准后的整数每组样本量 $\\,n\\,$。\n1. 案例 A（一般情况）：$\\,\\mu_c=1.5\\,$, $\\,r=0.7\\,$, $\\,\\alpha=0.05\\,$, 目标最小功效 $\\,=0.8\\,$, 对数正态分布参数 $\\,\\mu_{\\log k}=\\log(2.0)\\,$ 和 $\\,\\sigma_{\\log k}=0.5\\,$, 分位数区间 $\\,q_{\\mathrm{low}}=0.1\\,$ 和 $\\,q_{\\mathrm{high}}=0.9\\,$, 网格点数 $\\,=7\\,$, 搜索区间 $\\,n\\in\\{20,21,\\dots,150\\}\\,$。\n2. 案例 B（高过度离散压力）：$\\,\\mu_c=1.5\\,$, $\\,r=0.7\\,$, $\\,\\alpha=0.05\\,$, 目标最小功效 $\\,=0.8\\,$, 对数正态分布参数 $\\,\\mu_{\\log k}=\\log(0.6)\\,$ 和 $\\,\\sigma_{\\log k}=0.6\\,$, 分位数区间 $\\,q_{\\mathrm{low}}=0.1\\,$ 和 $\\,q_{\\mathrm{high}}=0.9\\,$, 网格点数 $\\,=7\\,$, 搜索区间 $\\,n\\in\\{20,21,\\dots,150\\}\\,$。\n3. 案例 C（低过度离散压力）：$\\,\\mu_c=1.5\\,$, $\\,r=0.7\\,$, $\\,\\alpha=0.05\\,$, 目标最小功效 $\\,=0.8\\,$, 对数正态分布参数 $\\,\\mu_{\\log k}=\\log(8.0)\\,$ 和 $\\,\\sigma_{\\log k}=0.4\\,$, 分位数区间 $\\,q_{\\mathrm{low}}=0.1\\,$ 和 $\\,q_{\\mathrm{high}}=0.9\\,$, 网格点数 $\\,=7\\,$, 搜索区间 $\\,n\\in\\{20,21,\\dots,150\\}\\,$。\n4. 案例 D（较小的效应量）：$\\,\\mu_c=1.0\\,$, $\\,r=0.8\\,$, $\\,\\alpha=0.05\\,$, 目标最小功效 $\\,=0.75\\,$, 对数正态分布参数 $\\,\\mu_{\\log k}=\\log(1.5)\\,$ 和 $\\,\\sigma_{\\log k}=0.5\\,$, 分位数区间 $\\,q_{\\mathrm{low}}=0.1\\,$ 和 $\\,q_{\\mathrm{high}}=0.9\\,$, 网格点数 $\\,=7\\,$, 搜索区间 $\\,n\\in\\{20,21,\\dots,150\\}\\,$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个案例校准后的每组样本量，形式为用方括号括起来的逗号分隔列表，例如“[$a_1$,$a_2$,$a_3$,$a_4$]”。实际输出必须是与上述四个案例顺序对应的校准后 $\\,n\\,$ 值的整数。",
            "solution": "问题陈述已经过严格验证，并被确定为有效。它具有科学依据，提法得当，客观且内部一致，构成一个正式的生物统计学样本量计算问题。每个测试用例都提供了所有必要的参数。\n\n解决方案将遵循指定的第一性原理方法进行开发。该过程涉及推导用于检验负二项分布均值差异的双样本 Wald 型检验的功效，通过确保在过度离散参数 $\\,k\\,$ 的一个合理范围内的最小功效来处理其不确定性，并实现数值搜索以找到所需的样本量 $\\,n\\,$。\n\n### 1. 统计模型与假设\n\n设 $\\,Y_{ci} \\sim \\mathrm{NB}(\\mu_c, k)\\,$（其中 $\\,i=1, \\dots, n\\,$）为对照组中 $\\,n\\,$ 名参与者的事件计数，$\\,Y_{ti} \\sim \\mathrm{NB}(\\mu_t, k)\\,$（其中 $\\,i=1, \\dots, n\\,$）为干预组中 $\\,n\\,$ 名参与者的计数。负二项（NB）分布由其均值 $\\,\\mu\\,$ 和一个共同的过度离散参数 $\\,k\\,$ 参数化。两组的均值分别为 $\\,E[Y_{ci}] = \\mu_c\\,$ 和 $\\,E[Y_{ti}] = \\mu_t = r\\mu_c\\,$。方差由 $\\,\\mathrm{Var}(Y) = \\mu + \\mu^2/k\\,$ 给出。\n\n每组中单个观测值的方差为：\n$$ \\sigma_c^2 = \\mathrm{Var}(Y_{ci}) = \\mu_c + \\frac{\\mu_c^2}{k} $$\n$$ \\sigma_t^2 = \\mathrm{Var}(Y_{ti}) = \\mu_t + \\frac{\\mu_t^2}{k} $$\n\n用于均值相等的双边检验的原假设和备择假设是：\n$$ H_0: \\mu_t = \\mu_c \\quad (\\text{或 } \\mu_t - \\mu_c = 0) $$\n$$ H_1: \\mu_t \\neq \\mu_c \\quad (\\text{或 } \\mu_t - \\mu_c \\neq 0) $$\n\n### 2. 大样本检验统计量与功效计算\n\n设 $\\,\\bar{Y}_c = \\frac{1}{n}\\sum_{i=1}^n Y_{ci}\\,$ 和 $\\,\\bar{Y}_t = \\frac{1}{n}\\sum_{i=1}^n Y_{ti}\\,$ 分别为对照组和干预组的样本均值。根据中心极限定理（CLT），对于足够大的样本量 $\\,n\\,$，样本均值的分布近似为正态分布：\n$$ \\bar{Y}_c \\dot\\sim N\\left(\\mu_c, \\frac{\\sigma_c^2}{n}\\right) $$\n$$ \\bar{Y}_t \\dot\\sim N\\left(\\mu_t, \\frac{\\sigma_t^2}{n}\\right) $$\n\n检验基于样本均值之差 $\\,D = \\bar{Y}_t - \\bar{Y}_c\\,$。其分布也近似为正态分布：\n$$ D \\dot\\sim N\\left(\\mu_t - \\mu_c, \\frac{\\sigma_t^2 + \\sigma_c^2}{n}\\right) $$\n设 $\\,\\mu_d = \\mu_t - \\mu_c\\,$ 为真实均值差，$\\,\\sigma_D^2 = \\frac{\\sigma_t^2 + \\sigma_c^2}{n}\\,$ 为差值的方差。\n\n一个 Wald 型检验统计量由 $\\,Z = \\frac{\\bar{Y}_t - \\bar{Y}_c}{\\widehat{SE}_D}\\,$ 给出，其中 $\\,\\widehat{SE}_D\\,$ 是差值的估计标准误。对于大样本，为了功效计算的目的，我们可以通过将估计标准误替换为备择假设下的真实标准误 $\\,\\sigma_D = \\sqrt{\\sigma_D^2}\\,$ 来近似该统计量的分布。\n\n在显著性水平 $\\,\\alpha\\,$ 下，如果 $\\,|\\frac{D}{\\sigma_D}|  z_{1-\\alpha/2}\\,$，我们拒绝 $\\,H_0\\,$，其中 $\\,z_{q}\\,$ 是标准正态分布的 $\\,q\\,$-分位数。请注意，这是一个轻微的简化；实际的检验统计量会使用估计方差，但对于大样本功效分析，使用 $\\,H_1\\,$ 下的真实方差是标准做法。\n\n统计功效是在 $\\,H_1\\,$ 为真的条件下拒绝 $\\,H_0\\,$ 的概率。\n$$ \\text{Power} = P\\left(\\frac{D}{\\sigma_D}  -z_{1-\\alpha/2} \\mid H_1\\right) + P\\left(\\frac{D}{\\sigma_D} > z_{1-\\alpha/2} \\mid H_1\\right) $$\n为了评估这些概率，我们在 $\\,H_1\\,$ 下对 $\\,D\\,$ 进行标准化：\n$$ \\frac{D - \\mu_d}{\\sigma_D} \\sim N(0, 1) $$\n将 $\\,D = Z_{std}\\sigma_D + \\mu_d\\,$ 代入，其中 $\\,Z_{std} \\sim N(0, 1)\\,$：\n$$ \\text{Power} = P\\left(\\frac{Z_{std}\\sigma_D + \\mu_d}{\\sigma_D}  -z_{1-\\alpha/2}\\right) + P\\left(\\frac{Z_{std}\\sigma_D + \\mu_d}{\\sigma_D} > z_{1-\\alpha/2}\\right) $$\n$$ \\text{Power} = P\\left(Z_{std}  -z_{1-\\alpha/2} - \\frac{\\mu_d}{\\sigma_D}\\right) + P\\left(Z_{std} > z_{1-\\alpha/2} - \\frac{\\mu_d}{\\sigma_D}\\right) $$\n使用标准正态分布的累积分布函数（CDF）$\\,\\Phi(z) = P(Z_{std} \\le z)\\,$：\n$$ \\text{Power} = \\Phi\\left(-z_{1-\\alpha/2} - \\frac{\\mu_d}{\\sigma_D}\\right) + \\left[1 - \\Phi\\left(z_{1-\\alpha/2} - \\frac{\\mu_d}{\\sigma_D}\\right)\\right] $$\n这是在给定一组参数 $\\,(\\mu_c, r, k, n, \\alpha)\\,$ 的情况下计算功效的核心公式。\n\n### 3. 滋扰参数网格的构建\n\n过度离散参数 $\\,k\\,$ 是一个其确切值未知的滋扰参数。问题指定通过假设 $\\,\\log k\\,$ 服从正态分布 $\\,\\log k \\sim N(\\mu_{\\log k}, \\sigma_{\\log k}^2)\\,$ 来对这种不确定性进行建模。必须保证功效在一个从该分布导出的 $\\,k\\,$ 值的合理范围内。\n\n构建 $\\,k\\,$ 值网格的算法如下：\n1.  定义一个从 $\\,q_{\\mathrm{low}}\\,$ 到 $\\,q_{\\mathrm{high}}\\,$ 的 $\\,m\\,$ 个均匀间隔的分位数水平 $\\,q_j\\,$ 的网格。\n2.  对于每个 $\\,q_j\\,$，计算标准正态分布的相应分位数 $\\,z_{q_j} = \\Phi^{-1}(q_j)\\,$。\n3.  将这些 $\\,z\\,$ 分数转换为 $\\,\\log k\\,$ 分布的分位数：$\\,(\\log k)_j = \\mu_{\\log k} + z_{q_j}\\sigma_{\\log k}\\,$。\n4.  取指数以获得 $\\,k\\,$ 值的网格：$\\,k_j = \\exp((\\log k)_j) = \\exp(\\mu_{\\log k} + z_{q_j}\\sigma_{\\log k})\\,$。\n\n由于方差与 $\\,k\\,$ 成反比，统计功效在网格中 $\\,k\\,$ 值最小时最低。问题要求计算每个 $\\,k_j\\,$ 处的功效并取最小值以确保稳健性。\n\n### 4. 样本量校准算法\n\n最后一步是在指定的搜索区间 $\\,[n_{\\min}, n_{\\max}]\\,$ 内找到每组的最小整数样本量 $\\,n\\,$，该样本量能够达到目标最小功效。\n\n完整的计算过程如下：\n1.  对于给定的测试用例，确定所有参数：$\\,\\mu_c, r, \\alpha\\,$、目标功效、$\\,\\mu_{\\log k}, \\sigma_{\\log k}, q_{\\mathrm{low}}, q_{\\mathrm{high}}\\,$、网格点数以及 $\\,n\\,$ 的搜索区间。\n2.  按照第 3 节所述构建 $\\,k\\,$ 值的网格。\n3.  从标准正态分布中确定临界值 $\\,z_{1-\\alpha/2}\\,$。\n4.  遍历候选样本量 $\\,n=n_{\\min}, n_{\\min}+1, \\dots, n_{\\max}\\,$。\n5.  对于每个 $\\,n\\,$：\n    a. 初始化一个空列表来存储功效值。\n    b. 对于网格中的每个值 $\\,k_j\\,$：\n        i.  计算组均值 $\\,\\mu_c\\,$ 和 $\\,\\mu_t = r\\mu_c\\,$。\n        ii. 计算组方差 $\\,\\sigma_c^2 = \\mu_c + \\mu_c^2/k_j\\,$ 和 $\\,\\sigma_t^2 = \\mu_t + \\mu_t^2/k_j\\,$。\n        iii. 计算均值之差 $\\,\\mu_d = \\mu_t - \\mu_c\\,$。\n        iv. 计算差值的标准误 $\\,\\sigma_D = \\sqrt{(\\sigma_c^2 + \\sigma_t^2)/n}\\,$。\n        v.  使用第 2 节的公式计算功效。\n        vi. 将计算出的功效附加到列表中。\n    c. 在列表中找到最小功效 $\\,\\text{power}_{\\min}\\,$。\n    d. 如果 $\\,\\text{power}_{\\min} \\ge \\text{target power}\\,$，则当前 $\\,n\\,$ 是所需的样本量。返回 $\\,n\\,$ 并终止此测试用例的搜索。\n6.  如果循环完成仍未达到功效目标，则根据问题规范返回 $\\,n_{\\max}\\,$。\n该过程将为四个测试用例中的每一个实施。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.stats import norm\n\ndef calculate_sample_size(\n    mu_c, r, alpha, target_power, mu_log_k, sigma_log_k, \n    q_low, q_high, grid_points, n_search_interval\n):\n    \"\"\"\n    Calculates the per-arm sample size n for a two-arm study with NB-distributed counts.\n\n    The function determines the smallest integer n in a search interval that achieves a target\n    minimum power across a grid of plausible over-dispersion parameter (k) values.\n    \"\"\"\n    # Step 1: Construct the grid of k values from its log-normal distribution.\n    # The grid spans from the q_low to q_high quantiles.\n    quantile_levels = np.linspace(q_low, q_high, grid_points)\n    z_quantiles = norm.ppf(quantile_levels)\n    log_k_values = mu_log_k + z_quantiles * sigma_log_k\n    k_grid = np.exp(log_k_values)\n    \n    # Step 2: Set up constants for the power calculation.\n    n_min, n_max = n_search_interval\n    # Two-sided test critical value from the standard normal distribution.\n    z_critical = norm.ppf(1 - alpha / 2.0)\n    mu_t = r * mu_c\n    mu_diff = mu_t - mu_c\n\n    # Step 3: Iterate through the sample size search interval.\n    for n in range(n_min, n_max + 1):\n        powers_at_n = []\n        # Step 4: For each candidate n, calculate power for each k in the grid.\n        for k in k_grid:\n            if k == 0: # Over-dispersion k must be positive.\n                continue\n            \n            # Variance for each arm, based on the NB model Var(Y) = mu + mu^2/k\n            var_c = mu_c + mu_c**2 / k\n            var_t = mu_t + mu_t**2 / k\n            \n            # Standard error of the difference in sample means\n            se_diff = np.sqrt((var_c + var_t) / n)\n            \n            # If standard error is zero (no variance), power is 1 if means differ.\n            if se_diff == 0:\n                power = 1.0 if mu_diff != 0 else 0.0\n                powers_at_n.append(power)\n                continue\n\n            # Core power formula for a two-sample Z-test\n            # Power = P(Z  -z_crit - mu_d/se_d) + P(Z  z_crit - mu_d/se_d)\n            # where Z ~ N(0,1)\n            arg1 = z_critical - mu_diff / se_diff\n            arg2 = -z_critical - mu_diff / se_diff\n            \n            power = norm.cdf(arg2) + (1.0 - norm.cdf(arg1))\n            powers_at_n.append(power)\n            \n        # Step 5: Check if the minimum power across the k-grid meets the target.\n        if powers_at_n:\n            min_power = min(powers_at_n)\n            if min_power = target_power:\n                return n\n    \n    # Step 6: If no n in the interval meets the target, return the upper bound.\n    return n_max\n\ndef solve():\n    \"\"\"\n    Defines and runs the test cases specified in the problem statement.\n    \"\"\"\n    test_cases = [\n        # Case A: General case\n        {'mu_c': 1.5, 'r': 0.7, 'alpha': 0.05, 'target_power': 0.8,\n         'mu_log_k': np.log(2.0), 'sigma_log_k': 0.5, 'q_low': 0.1, 'q_high': 0.9,\n         'grid_points': 7, 'n_search_interval': (20, 150)},\n        \n        # Case B: High over-dispersion stress (low k)\n        {'mu_c': 1.5, 'r': 0.7, 'alpha': 0.05, 'target_power': 0.8,\n         'mu_log_k': np.log(0.6), 'sigma_log_k': 0.6, 'q_low': 0.1, 'q_high': 0.9,\n         'grid_points': 7, 'n_search_interval': (20, 150)},\n\n        # Case C: Low over-dispersion stress (high k)\n        {'mu_c': 1.5, 'r': 0.7, 'alpha': 0.05, 'target_power': 0.8,\n         'mu_log_k': np.log(8.0), 'sigma_log_k': 0.4, 'q_low': 0.1, 'q_high': 0.9,\n         'grid_points': 7, 'n_search_interval': (20, 150)},\n\n        # Case D: Smaller effect size\n        {'mu_c': 1.0, 'r': 0.8, 'alpha': 0.05, 'target_power': 0.75,\n         'mu_log_k': np.log(1.5), 'sigma_log_k': 0.5, 'q_low': 0.1, 'q_high': 0.9,\n         'grid_points': 7, 'n_search_interval': (20, 150)},\n    ]\n\n    results = []\n    for case in test_cases:\n        result = calculate_sample_size(**case)\n        results.append(result)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        }
    ]
}