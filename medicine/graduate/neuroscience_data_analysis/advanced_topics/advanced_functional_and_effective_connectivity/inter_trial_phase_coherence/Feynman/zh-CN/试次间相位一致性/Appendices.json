{
    "hands_on_practices": [
        {
            "introduction": "要真正掌握跨试次相位一致性（ITPC）的含义，最有效的方法就是从其基本定义入手进行计算。这个练习将引导我们从第一性原理出发，将每个试次的相位看作是复平面上的一个单位向量，通过向量求和来直观地理解相位的集中趋势。通过这个基础计算，你不仅能够掌握ITPC的数学本质，还能建立起其几何直觉，这是后续所有复杂分析的基石。",
            "id": "4171087",
            "problem": "在一项视觉事件相关电位研究中，使用复时间-频率变换分析连续的颅内脑电图信号。在一个固定的时间-频率坐标 $(t^{\\ast}, f^{\\ast})$ 处，针对同一刺激的 $N$ 次独立试验，提取解析信号的瞬时相位。相位以弧度为单位，由多重集给出\n$$\n\\{\\phi_n\\}_{n=1}^{N}=\\{0,\\,0,\\,0,\\,0,\\,0,\\,\\pi,\\,\\pi,\\,\\pi,\\,\\tfrac{\\pi}{3},\\,\\tfrac{\\pi}{3},\\,-\\tfrac{\\pi}{3},\\,-\\tfrac{\\pi}{3}\\}.\n$$\n此处 $N=12$。仅从“每个相位 $\\phi_n$ 决定了复平面单位圆上的一个方向，并且跨试验的净方向趋势由这些单位方向的矢量和所捕捉”这一基本认识出发，从第一性原理推导试验间相位一致性（ITPC）和在 $(t^{\\ast}, f^{\\ast})$ 处的循环平均方向的定义。然后计算给定相位的这些值。\n\n将循环平均方向表示为弧度。将您的最终答案表示为一个单行矩阵，依次包含试验间相位一致性和循环平均方向。在最终的方框答案中不要包含单位。无需四舍五入；如果存在精确值，请报告精确值。",
            "solution": "问题要求从第一性原理推导试验间相位一致性（ITPC）和循环平均方向的定义，然后根据给定的相位数据集计算它们的值。所提供的基本原理是，将每个相位 $\\phi_n$ 表示为复平面上的单位长度向量，其净方向趋势由它们的矢量和给出。\n\n**1. 从第一性原理推导**\n\n设独立试验的次数为 $N$。在试验 $n$ 中，特定时间-频率点的信号相位为 $\\phi_n$，其中 $n \\in \\{1, 2, \\dots, N\\}$。根据问题的指导原则，每个相位 $\\phi_n$ 被表示为复平面单位圆上的一个单位向量。使用欧拉公式，这个向量可以写成复数 $z_n$：\n$$\nz_n = e^{i\\phi_n} = \\cos(\\phi_n) + i\\sin(\\phi_n)\n$$\n每个向量的模为 $|z_n| = \\sqrt{\\cos^2(\\phi_n) + \\sin^2(\\phi_n)} = 1$。\n\n问题指出，净方向趋势由这些单位方向的矢量和所捕捉。我们将这个合向量 $R$ 定义为所有单个复向量的和：\n$$\nR = \\sum_{n=1}^{N} z_n = \\sum_{n=1}^{N} e^{i\\phi_n}\n$$\n为了找到*平均*方向趋势，我们将这个和除以试验次数 $N$ 进行归一化。这得到了平均合向量 $\\bar{R}$：\n$$\n\\bar{R} = \\frac{1}{N} \\sum_{n=1}^{N} e^{i\\phi_n}\n$$\n这个平均合向量 $\\bar{R}$ 是一个复数，可以用极坐标形式表示为 $\\bar{R} = |\\bar{R}| e^{i\\bar{\\phi}}$，其中 $|\\bar{R}|$ 是它的模，$\\bar{\\phi}$ 是它的角（辐角）。\n\n模 $|\\bar{R}|$ 量化了跨试验的相位的一致性或聚集程度。如果所有相位都相同，即对所有 $n$ 都有 $\\phi_n = \\phi$，那么 $\\bar{R} = \\frac{1}{N} \\sum_{n=1}^{N} e^{i\\phi} = \\frac{1}{N}(N e^{i\\phi}) = e^{i\\phi}$，其模为 $|\\bar{R}| = 1$。这代表了完美的相位一致性。相反，如果相位在单位圆上均匀分布，矢量和趋于抵消，$\\sum e^{i\\phi_n} \\to 0$，所以 $|\\bar{R}| \\to 0$。这代表完全没有相位一致性。因此，平均合向量的模是**试验间相位一致性 (ITPC)** 的正式定义。\n$$\n\\text{ITPC} = \\left| \\frac{1}{N} \\sum_{n=1}^{N} e^{i\\phi_n} \\right|\n$$\nITPC 的值介于 $0$ 和 $1$ 之间。\n\n平均合向量的角度 $\\bar{\\phi} = \\arg(\\bar{R})$ 代表了相位分布的集中趋势。这个角度就是**循环平均方向**。它是向量和的辐角，因为除以正实数 $N$ 不会改变角度。\n$$\n\\bar{\\phi} = \\arg\\left( \\sum_{n=1}^{N} e^{i\\phi_n} \\right)\n$$\n为了计算这个值，我们可以先将和表示为笛卡尔形式：\n$$\n\\sum_{n=1}^{N} e^{i\\phi_n} = \\sum_{n=1}^{N} \\cos(\\phi_n) + i \\sum_{n=1}^{N} \\sin(\\phi_n)\n$$\n然后使用双参数反正切函数 $\\text{atan2}(y, x)$ 来找到辐角 $\\bar{\\phi}$：\n$$\n\\bar{\\phi} = \\text{atan2}\\left(\\sum_{n=1}^{N} \\sin(\\phi_n), \\sum_{n=1}^{N} \\cos(\\phi_n)\\right)\n$$\n\n**2. 针对给定数据的计算**\n\n问题提供了 $N=12$ 次试验，其相位（以弧度为单位）的多重集如下：\n$$\n\\{\\phi_n\\}_{n=1}^{12}=\\{0,\\,0,\\,0,\\,0,\\,0,\\,\\pi,\\,\\pi,\\,\\pi,\\,\\tfrac{\\pi}{3},\\,\\tfrac{\\pi}{3},\\,-\\tfrac{\\pi}{3},\\,-\\tfrac{\\pi}{3}\\}\n$$\n我们通过对相应的复指数求和来计算合向量 $R$。我们可以按相位值对各项进行分组：\n- $5$ 次试验的相位为 $\\phi = 0$\n- $3$ 次试验的相位为 $\\phi = \\pi$\n- $2$ 次试验的相位为 $\\phi = \\frac{\\pi}{3}$\n- $2$ 次试验的相位为 $\\phi = -\\frac{\\pi}{3}$\n\n和为：\n$$\nR = \\sum_{n=1}^{12} e^{i\\phi_n} = 5 \\cdot e^{i0} + 3 \\cdot e^{i\\pi} + 2 \\cdot e^{i\\pi/3} + 2 \\cdot e^{-i\\pi/3}\n$$\n我们计算复指数的值：\n- $e^{i0} = \\cos(0) + i\\sin(0) = 1$\n- $e^{i\\pi} = \\cos(\\pi) + i\\sin(\\pi) = -1$\n- $e^{i\\pi/3} = \\cos(\\pi/3) + i\\sin(\\pi/3) = \\frac{1}{2} + i\\frac{\\sqrt{3}}{2}$\n- $e^{-i\\pi/3} = \\cos(-\\pi/3) + i\\sin(-\\pi/3) = \\frac{1}{2} - i\\frac{\\sqrt{3}}{2}$\n\n将这些值代入 $R$ 的求和式中：\n$$\nR = 5(1) + 3(-1) + 2\\left(\\frac{1}{2} + i\\frac{\\sqrt{3}}{2}\\right) + 2\\left(\\frac{1}{2} - i\\frac{\\sqrt{3}}{2}\\right)\n$$\n$$\nR = 5 - 3 + (1 + i\\sqrt{3}) + (1 - i\\sqrt{3})\n$$\n分组实部和虚部：\n$$\nR = (5 - 3 + 1 + 1) + i(\\sqrt{3} - \\sqrt{3})\n$$\n$$\nR = 4 + i0 = 4\n$$\n现在我们计算平均合向量 $\\bar{R}$：\n$$\n\\bar{R} = \\frac{R}{N} = \\frac{4}{12} = \\frac{1}{3}\n$$\n**试验间相位一致性 (ITPC)** 是 $\\bar{R}$ 的模：\n$$\n\\text{ITPC} = |\\bar{R}| = \\left|\\frac{1}{3}\\right| = \\frac{1}{3}\n$$\n**循环平均方向** $\\bar{\\phi}$ 是 $\\bar{R}$ 的辐角：\n$$\n\\bar{\\phi} = \\arg(\\bar{R}) = \\arg\\left(\\frac{1}{3}\\right)\n$$\n因为 $\\frac{1}{3}$ 是一个正实数，所以它在复平面上的角度是 $0$。\n$$\n\\bar{\\phi} = 0 \\text{ 弧度}\n$$\n所求的值是 ITPC 为 $\\frac{1}{3}$，循环平均方向为 $0$ 弧度。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{1}{3}  0\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "在理想情况下计算ITPC是一回事，但从真实的神经信号中准确提取相位则充满了挑战。这个练习将我们带入数据分析的现实世界，探讨在有限长度的数据段（试次）上进行滤波和希尔伯特变换时不可避免会遇到的“边缘效应”。理解并妥善处理这些由信号处理流程引入的伪影，是确保ITPC估计结果可靠性和科学严谨性的关键一步。",
            "id": "4171053",
            "problem": "您正在分析一个多试次局部场电位数据集中的事件相关振荡。每个试次是一个长度为 $T$ 秒的片段，以每秒 $F_s$ 个样本的速率进行采样，每个试次产生 $N$ 个样本。对于每个试次 $k \\in \\{1,\\dots,K\\}$，您使用一个长度为 $L$ 个样本、实数冲激响应为 $h[n]$ 的线性时不变有限冲激响应滤波器，对分段信号 $x_k(t)$ 进行以中心频率 $f_0$ 为中心的带通滤波，然后通过希尔伯特变换获得解析信号，以计算瞬时相位 $\\phi_k(t)$。然后，您计划通过对所有试次的单位范数复相位向量 $e^{i\\phi_k(t)}$ 进行平均并取其模值，来计算每个时间点 $t$ 的试次间相位一致性 (ITPC)。\n\n从以下基本原理出发：\n- 线性时不变滤波是时域上的卷积：如果 $x(t)$ 与 $h(t)$ 进行卷积，则滤波后的信号在连续时间上是 $(x * h)(t) = \\int_{-\\infty}^{\\infty} x(\\tau) h(t - \\tau) d\\tau$，类似地，在离散时间上是 $(x * h)[n] = \\sum_{m=-\\infty}^{\\infty} x[m] h[n - m]$。\n- 希尔伯特变换是一种线性时不变操作，其冲激响应在连续时间上与 $1/(\\pi t)$ 成正比，并且在离散实现中具有很长的有效支撑域；基于快速傅里叶变换 (FFT) 的实现隐含地假设了对有限记录的周期性延拓。\n- 带通滤波器将信号限制在 $f_0$ 周围的一个窄谱带内，从而使解析相位 $\\phi(t)$ 具有意义；然而，滤波和希尔伯特变换在时间上都是非局域的。\n\n请根据这些原理进行推理，解释在使用所述的滤波和希尔伯特变换流程时，有限长度片段在 $t=0$ 和 $t=T$ 的边界如何影响边缘附近估计相位 $\\phi(t)$ 的可靠性，并确定一种科学合理的填充或处理策略，该策略能在计算 ITPC 时减轻这些边缘效应，而不会在试次间引入偏差。\n\n选择所有正确的选项。\n\nA. 边缘附近的卷积使用了 $h[n]$ 和 $x[n]$ 之间的不完全重叠，这实际上改变了滤波器并引发瞬态响应；希尔伯特变换具有长支撑域或通过 FFT 假定周期性延拓，这会进一步破坏 $t=0$ 和 $t=T$ 附近的样本。为减轻此问题，通过围绕其边界反射信号（对称镜像填充）来扩展每个片段，每侧至少扩展 $\\max\\{L, \\lceil M F_s / f_0 \\rceil\\}$ 个样本，其中 $M$ 为某个小整数（例如 $M \\in \\{3,4,5\\}$），在填充后的数据上计算带通和希尔伯特变换，然后在形成 $\\phi_k(t)$ 和 ITPC 之前丢弃填充的边缘部分。这样可以避免试次间的交叉污染，并减少边缘处的相位偏差。\n\nB. 在滤波和希尔伯特变换之前，在每个片段的两侧用 $L$ 个零进行零填充，然后保留所有样本，包括原始未填充的区间，用于 ITPC 计算。零填充不会改变相位，因为零没有相位，所以无需丢弃任何样本，边缘也是可靠的。\n\nC. 使用循环（环绕）填充，将片段的最后 $L$ 个样本附加到前面，将前 $L$ 个样本附加到末尾，然后计算希尔伯特变换；因为 FFT 假定周期性，这完全匹配计算模型，并允许使用所有样本而无需丢弃任何时间点，从而保留了 $t=0$ 附近的真实相位。\n\nD. 使用严格因果的带通滤波器以避免非因果污染；由于希尔伯特变换是在因果滤波之后计算的， $t=0$ 之后的样本不依赖于不可用的未来数据，从而消除了边缘效应，并且无需进行填充或丢弃任何样本。\n\nE. 将带通滤波器和希尔伯特变换应用于连续的、未分段的记录，然后对解析信号进行分段；这完全避免了 $t=0$ 和 $t=T$ 处的边缘伪影。如果只有分段数据可用，则在两侧构建长度至少为 $\\max\\{L, \\lceil M F_s / f_0 \\rceil\\}$ 个样本的对称镜像填充，处理填充后的片段，并在计算 $\\phi_k(t)$ 和 ITPC 之前丢弃填充的边缘部分。这两种方法都能防止 ITPC 估计中的偏差和试次间泄漏。",
            "solution": "问题陈述描述了从事件相关神经数据计算试次间相位一致性（ITPC）的标准流程，并要求解释处理引起的边缘伪影及有效的缓解策略。该问题提法明确，具有科学依据，并包含足够的信息以进行严谨的分析。\n\n问题的核心在于滤波和希尔伯特变换都是非局域操作。在数字信号处理的背景下，它们都以卷积的方式实现。\n\n1.  **有限冲激响应 (FIR) 滤波**：问题指出滤波是卷积，对于长度为 $L$ 的 FIR 滤波器 $h[n]$，在离散时间上表示为 $(x * h)[n] = \\sum_{m=0}^{L-1} h[m] x[n - m]$。我们考虑定义在 $n \\in \\{0, 1, \\dots, N-1\\}$ 上的信号片段 $x_k[n]$。为了计算滤波后信号的第一个输出样本 $y_k[0]$，卷积和为 $y_k[0] = \\sum_{m=0}^{L-1} h[m] x_k[-m]$。然而，由于片段从 $n=0$ 开始，信号样本 $x_k[-1], x_k[-2], \\dots, x_k[-(L-1)]$ 是未定义的。标准的卷积实现隐含地假设这些不可用的样本为零。在片段边缘，从信号的实际历史（非零）到零值的这种突然转变，会在滤波输出中引入瞬态伪影。在滤波器的整个长度 $L$ 完全位于定义的信号片段内之前，其响应都是不正确的。这会破坏前 $L-1$ 个输出样本。一个对称的论证也适用于片段末尾（$t=T$）的最后 $L-1$ 个样本。在这些边界区域，等效的滤波器形状被改变，从而扭曲了结果信号的幅度和相位。\n\n2.  **希尔伯特变换**：问题正确地指出，希尔伯特变换也是一种线性时不变操作，其冲激响应具有非常长的支撑域（理论上是无限的，与 $1/t$ 成正比）。当在有限数据段上实现时，这种非局域性比 FIR 滤波器带来了更严重的问题。一种常见的快速实现方法是使用快速傅里叶变换 (FFT)。如问题所述，基于 FFT 的方法隐含地假设数据段是一个无限重复信号的一个周期（周期性延拓）。这意味着变换会“环绕”，导致片段的末尾被视为紧接在片段的开头之前。对于典型的神经信号，其中 $x_k(0) \\neq x_k(T)$，这会在周期性表示的边界处产生一个剧烈的不连续。变换时，这种不连续性会将强烈的伪影扩散到整个信号中，这些伪影在边缘附近最为明显。这些伪影严重破坏了 $t=0$ 和 $t=T$ 附近的瞬时相位估计 $\\phi_k(t)$。\n\n一种科学合理的缓解策略必须为滤波和希尔伯特变换操作提供一个更真实的、超出片段边界的信号延续，然后丢弃受污染的部分。\n\n-   **理想策略**：如果原始的连续（未分段）记录可用，最佳程序是首先对这个长数据流应用带通滤波器和希尔伯特变换。然后，可以对得到的复值解析信号进行分段。在这种情况下，边缘伪影只出现在整个数小时记录的绝对开始和结束处，与任何单个试次片段的分析无关。\n\n-   **实用策略（针对已分段的数据）**：如果只有已分段的数据可用，则必须在处理前人工扩展每个片段。这被称为填充。填充方法的选择至关重要。\n    -   *对称（镜像）填充*是首选方法。信号通过围绕其端点进行反射来扩展。这在边界处创建了一个具有连续一阶导数的连续信号，从而最大限度地减少了后续卷积所看到的不连续性。\n    -   填充长度必须足以包含操作器的完整瞬态响应。这包括 FIR 滤波器的长度 $L$，以及希尔伯特变换伪影的时间范围，后者与信号中感兴趣的最低频率的周期有关。一个常见的经验法则是，填充的长度应为滤波器中心频率 $f_0$ 的几个周期。因此，一个安全的每侧填充长度至少是 $\\max\\{L, \\lceil M F_s / f_0 \\rceil\\}$，其中 $M$ 是某个小整数（例如 $M \\ge 3$）。\n    -   在对填充后的信号应用带通滤波器和希尔伯特变换之后，必须从得到的解析信号中丢弃填充部分，只保留与原始试次长度相对应的部分。这移除了瞬态伪影，因为它们现在被限制在被丢弃的边缘区域。\n\n这个独立应用于每个试次的程序，可以防止伪影造成的相位锁定污染 ITPC 计算，并确保即使在原始片段边界附近，$\\phi_k(t)$ 的估计也是可靠的。\n\n现在，我们评估每个选项。\n\n**A. 边缘附近的卷积使用了 $h[n]$ 和 $x[n]$ 之间的不完全重叠，这实际上改变了滤波器并引发瞬态响应；希尔伯特变换具有长支撑域或通过 FFT 假定周期性延拓，这会进一步破坏 $t=0$ 和 $t=T$ 附近的样本。为减轻此问题，通过围绕其边界反射信号（对称镜像填充）来扩展每个片段，每侧至少扩展 $\\max\\{L, \\lceil M F_s / f_0 \\rceil\\}$ 个样本，其中 $M$ 为某个小整数（例如 $M \\in \\{3,4,5\\}$），在填充后的数据上计算带通和希尔伯特变换，然后在形成 $\\phi_k(t)$ 和 ITPC 之前丢弃填充的边缘部分。这样可以避免试次间的交叉污染，并减少边缘处的相位偏差。**\n\n这个选项对问题和针对预分段数据的科学合理解决方案都给出了正确而详细的描述。关于卷积引起的瞬态和希尔伯特变换引起的伪影的解释是准确的。所提出的缓解策略——对称填充、合理的填充长度、处理填充后的数据以及丢弃边缘部分——是此场景下的标准最佳实践。其结果的描述也是正确的。\n**结论：正确。**\n\n**B. 在滤波和希尔伯特变换之前，在每个片段的两侧用 $L$ 个零进行零填充，然后保留所有样本，包括原始未填充的区间，用于 ITPC 计算。零填充不会改变相位，因为零没有相位，所以无需丢弃任何样本，边缘也是可靠的。**\n\n这个选项在多个方面都是错误的。首先，零填充引入了一个剧烈的不连续（从非零信号值到零），这在滤波时会引起显著的振铃伪影。这与选项中的说法相反，会破坏相位。“零没有相位”的说法不合逻辑；伪影是由滤波器对信号到零的不连续性的响应引起的。其次，不丢弃填充区域（以及过渡区域）意味着保留了信号中伪影最严重的部分。$L$ 的填充长度也可能不足以处理希尔伯特变换的伪影。\n**结论：不正确。**\n\n**C. 使用循环（环绕）填充，将片段的最后 $L$ 个样本附加到前面，将前 $L$ 个样本附加到末尾，然后计算希尔伯特变换；因为 FFT 假定周期性，这完全匹配计算模型，并允许使用所有样本而无需丢弃任何时间点，从而保留了 $t=0$ 附近的真实相位。**\n\n这个逻辑是有缺陷的。虽然循环填充符合 FFT 的隐含假设，但这个假设对于现实世界中的非周期性信号通常是无效的。环绕在信号的末尾值和起始值之间造成了巨大的不连续，导致严重的光谱泄漏和时间伪影，从而污染了相位估计。声称这能“保留真实相位”是错误的；它实际上会主动破坏相位。\n**结论：不正确。**\n\n**D. 使用严格因果的带通滤波器以避免非因果污染；由于希尔伯特变换是在因果滤波之后计算的， $t=0$ 之后的样本不依赖于不可用的未来数据，从而消除了边缘效应，并且无需进行填充或丢弃任何样本。**\n\n这是不正确的。因果滤波器仍然有启动瞬态。它在时间 $n=0$ 的输出依赖于过去的输入，而对于有限的片段来说，这些输入是不可用的，所以边缘效应仍然会发生。此外，因果滤波器会引入相位失真（非线性相位响应），这对于 ITPC 分析来说是极不希望的，因为精确的相位信息是分析的重点。零相位（非因果）滤波器是首选。最后，希尔伯特变换本身就是非因果的，所以无论如何，这个策略在第二步就会失败。\n**结论：不正确。**\n\n**E. 将带通滤波器和希尔伯特变换应用于连续的、未分段的记录，然后对解析信号进行分段；这完全避免了 $t=0$ 和 $t=T$ 处的边缘伪影。如果只有分段数据可用，则在两侧构建长度至少为 $\\max\\{L, \\lceil M F_s / f_0 \\rceil\\}$ 个样本的对称镜像填充，处理填充后的片段，并在计算 $\\phi_k(t)$ 和 ITPC 之前丢弃填充的边缘部分。这两种方法都能防止 ITPC 估计中的偏差和试次间泄漏。**\n\n这个选项描述了两种科学合理的策略。第一种——在分段前对连续记录进行滤波——是理想的“金标准”方法，它完全避免了试次边界伪影的问题。第二种描述了针对预分段数据的正确最佳实践替代方案，与选项 A 中的方法相同。两种策略都是有效的，并且能正确地防止所描述的问题。\n**结论：正确。**",
            "answer": "$$\\boxed{AE}$$"
        },
        {
            "introduction": "计算出一个ITPC值只是分析的开始，而非终点。一个核心的科学问题是：我们观测到的相位一致性是真实的神经现象，还是仅仅是随机波动的结果？本练习将指导你实现一种强大的非参数统计方法——置换检验（permutation testing），通过在试次内部随机循环移位相位时间序列来构建零假设分布。掌握此方法将使你能够严谨地评估ITPC结果的统计显著性，这是得出可靠科学结论的必要环节。",
            "id": "4171116",
            "problem": "给定单一频率下跨试验的相位时间序列，要求您使用通过试验内随机循环移位构建的基于置换的零假设来估计试验间相位一致性的统计显著性。试验间相位一致性量化了在给定时间和频率下跨试验的相位一致性程度。对于单个时间索引 $t^{\\star}$ 和频率索引 $f^{\\star}$，观测到的试验间相位一致性是根据该 $(t^{\\star}, f^{\\star})$ 点上跨试验的相位值计算得出的。所有相角均以弧度为单位。基于置换的零假设是通过以下方式构建的：将每个试验的相位时间序列沿时间轴独立地进行循环移位，移位量（延迟）是从 $\\{0,1,\\dots,T-1\\}$ 中均匀采样的随机值，其中 $T$ 是每个试验的时间样本数，然后重新计算 $(t^{\\star}, f^{\\star})$ 处的试验间相位一致性。重复此过程会产生一个零假设下的试验间相位一致性值分布，该分布保留了试验内的时间结构，同时破坏了在分析时间点的跨试验对齐。\n\n基本定义：设有 $N$ 个试验和每个试验 $T$ 个时间样本。在固定频率下，将试验 $n$ 在时间 $t$ 的相位表示为 $\\phi_{n}(t)$，其中 $n \\in \\{1,2,\\dots,N\\}$ 且 $t \\in \\{0,1,\\dots,T-1\\}$。定义与 $\\phi_{n}(t)$ 相关联的单位复相量为 $z_{n}(t) = e^{i \\phi_{n}(t)}$，其中 $i$ 是虚数单位。时间 $t$ 处的试验间相位一致性是该时间点上跨试验的平均单位相量的模，即\n$$\n\\mathrm{ITPC}(t) = \\left| \\frac{1}{N} \\sum_{n=1}^{N} z_{n}(t) \\right| = \\left| \\frac{1}{N} \\sum_{n=1}^{N} e^{i \\phi_{n}(t)} \\right|.\n$$\n\n基于置换的零假设构建：对于每次置换 $p \\in \\{1,2,\\dots,P\\}$，为每个试验 $n$ 独立地从 $\\{0,1,\\dots,T-1\\}$ 中采样一个循环移位延迟 $k_{n}^{(p)}$，并形成移位后的相位时间序列 $\\phi_{n}^{(p)}(t) = \\phi_{n}\\big((t - k_{n}^{(p)}) \\bmod T\\big)$。根据移位后的试验计算 $t^{\\star}$ 处的试验间相位一致性，\n$$\n\\mathrm{ITPC}^{(p)}(t^{\\star}) = \\left| \\frac{1}{N} \\sum_{n=1}^{N} e^{i \\phi_{n}^{(p)}(t^{\\star})} \\right|.\n$$\n集合 $\\{\\mathrm{ITPC}^{(p)}(t^{\\star})\\}_{p=1}^{P}$ 就是在 $(t^{\\star}, f^{\\star})$ 处的基于置换的零分布。\n\n统计评估：使用基于置换的零假设为观测到的试验间相位一致性 $\\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})$ 计算一个单侧 $p$-值，该 $p$-值等于零假设值中大于或等于观测值的比例，并采用标准的有限样本校正以避免零概率估计。\n\n您的任务是实现一个程序，该程序能够：\n1. 为下述每个测试用例构建指定的合成相位时间序列 $\\phi_{n}(t)$（以弧度为单位）。\n2. 计算观测到的试验间相位一致性 $\\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})$。\n3. 通过每次试验的随机循环移位生成 $P$ 个基于置换的零假设样本，并计算零分布 $\\{\\mathrm{ITPC}^{(p)}(t^{\\star})\\}_{p=1}^{P}$。\n4. 为每个测试用例计算单侧 $p$-值，结果为 $[0,1]$ 范围的小数，并四舍五入到六位小数。\n5. 生成单行输出，其中包含所有测试用例的 $p$-值，格式为用方括号括起来的逗号分隔列表。\n\n角度单位要求：所有相位均以弧度表示。不应使用度数值。\n\n测试套件和数据生成规范：\n- 对于每个用例，程序必须使用指定的随机数种子以确保可复现性。随机采样使用以给定种子初始化的伪随机数生成器执行。所有相位在构建后必须被包装到区间 $[-\\pi, \\pi]$ 内，以确保其为有效的角度值。\n\n- Case A (带有分析时间点部分对齐的理想路径):\n  - 试验数 $N = 24$，时间样本数 $T = 400$，置换次数 $P = 2000$，分析时间索引 $t^{\\star} = 200$，种子 $s = 42$。\n  - 数据构建：将 $\\phi_{n}(t)$ 初始化为 $\\mathcal{U}([-\\pi,\\pi])$ 的独立样本，适用于所有 $n$ 和 $t$。通过为所有 $n$ 设置 $\\phi_{n}(t^{\\star}) = \\theta + \\epsilon_{n}$ 来在 $t^{\\star}$ 处施加部分对齐，其中 $\\theta = 1.0$ 且 $\\epsilon_{n} \\sim \\mathcal{N}(0, \\sigma^{2})$，$\\sigma = 0.3$。将角度包装到 $[-\\pi,\\pi]$。\n\n- Case B (随机相位，无对齐):\n  - 试验数 $N = 24$，时间样本数 $T = 400$，置换次数 $P = 2000$，分析时间索引 $t^{\\star} = 123$，种子 $s = 123$。\n  - 数据构建：$\\phi_{n}(t)$ 是 $\\mathcal{U}([-\\pi,\\pi])$ 的独立样本，适用于所有 $n$ 和 $t$。将角度包装到 $[-\\pi,\\pi]$。\n\n- Case C (分析时间点完全对齐):\n  - 试验数 $N = 50$，时间样本数 $T = 300$，置换次数 $P = 2000$，分析时间索引 $t^{\\star} = 150$，种子 $s = 7$。\n  - 数据构建：将 $\\phi_{n}(t)$ 初始化为 $\\mathcal{U}([-\\pi,\\pi])$ 的独立样本，适用于所有 $n$ 和 $t$。通过为所有 $n$ 设置 $\\phi_{n}(t^{\\star}) = 0$ 来在 $t^{\\star}$ 处施加完全对齐。将角度包装到 $[-\\pi,\\pi]$。\n\n- Case D (具有退化时间轴的边界情况):\n  - 试验数 $N = 10$，时间样本数 $T = 1$，置换次数 $P = 1000$，分析时间索引 $t^{\\star} = 0$，种子 $s = 2024$。\n  - 数据构建：$\\phi_{n}(t)$ 是 $\\mathcal{U}([-\\pi,\\pi])$ 的独立样本，适用于所有 $n$ 和 $t$。将角度包装到 $[-\\pi,\\pi]$。\n\n答案规范：\n- 对于每个用例，程序必须计算单侧置换 $p$-值，定义为\n$$\np = \\frac{1 + \\sum_{p=1}^{P} \\mathbf{1}\\left\\{\\mathrm{ITPC}^{(p)}(t^{\\star}) \\ge \\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})\\right\\}}{P + 1},\n$$\n其中 $\\mathbf{1}\\{\\cdot\\}$ 是指示函数。\n- 最终程序输出必须是单行，格式为 $[\\text{p\\_A},\\text{p\\_B},\\text{p\\_C},\\text{p\\_D}]$，其中每个 $\\text{p\\_X}$ 是用例 $X$ 的 $p$-值，四舍五入到六位小数，并表示为 $[0,1]$ 范围内的十进制小数，不带百分号。\n\n您的程序应生成单行输出，其中包含用方括号括起来的逗号分隔列表形式的结果（例如，$[\\text{result1},\\text{result2},\\text{result3},\\text{result4}]$）。",
            "solution": "该问题要求实现一个基于置换的统计检验，以评估合成时间序列数据中试验间相位一致性（ITPC）的显著性。解决方案涉及数据生成、观测到的 ITPC 的计算、使用循环移位构建零分布以及 $p$-值的计算。该过程根据信号处理和神经科学中非参数统计的基本原则进行了验证。\n\n核心关注量是试验间相位一致性（Inter-Trial Phase Coherence），$\\mathrm{ITPC}(t)$。对于给定的时间点 $t$ 和固定频率，我们有跨越 $N$ 个试验的一组相角 $\\{\\phi_{n}(t)\\}_{n=1}^{N}$。每个相角 $\\phi_{n}(t)$ 可以在复平面中表示为一个单位向量或相量，$z_{n}(t) = e^{i \\phi_{n}(t)}$，其中 $i$ 是虚数单位。$\\mathrm{ITPC}(t)$ 定义为这些相量平均值的模：\n$$\n\\mathrm{ITPC}(t) = \\left| \\frac{1}{N} \\sum_{n=1}^{N} z_{n}(t) \\right| = \\left| \\frac{1}{N} \\sum_{n=1}^{N} e^{i \\phi_{n}(t)} \\right|\n$$\n该值范围为 $0$ 到 $1$。接近 $1$ 的 $\\mathrm{ITPC}$ 值表示跨试验的相角高度一致（即紧密聚集），表明对某个事件有很强的神经同步。相反，接近 $0$ 的 $\\mathrm{ITPC}$ 值表示相位在各试验中随机或均匀分布，表明缺乏一致的同步。\n\n要确定在特定时间 $t^{\\star}$ 观测到的 $\\mathrm{ITPC}_{\\mathrm{obs}}$ 是否具有统计显著性，我们必须将其与一个零假设进行比较。零假设 $H_0$ 假定在时间 $t^{\\star}$ 处，试验之间没有真正的相位一致性。任何观测到的一致性都仅仅是由于偶然。置换检验是一种在 $H_0$ 下生成分布的强大非参数方法。\n\n此处采用的具体置换策略是对每个试验的时间序列进行随机循环移位。对于 $P$ 次置换中的每一次，以及对于每个试验 $n \\in \\{1, 2, \\dots, N\\}$，整个相位时间序列 $\\phi_n(t)$ 会被一个从 $\\{0, 1, \\dots, T-1\\}$ 中均匀选择的随机延迟 $k_n^{(p)}$ 进行循环移位，其中 $T$ 是时间点的数量。这就创建了一组新的置换后的相位时间序列 $\\phi_n^{(p)}(t) = \\phi_n\\big((t - k_n^{(p)}) \\pmod T\\big)$。\n\n这个过程是合理的，因为它在保留每个试验内部的内在时间结构（如自相关）的同时，选择性地破坏了在分析时间 $t^{\\star}$ 处的跨试验时间对齐。通过从试验 $n$ 内部的随机时间点抽取该试验的相位，我们有效地模拟了零假设：试验 $n$ 在时间 $t^{\\star}$ 的相位与任何其他试验 $m \\neq n$ 在时间 $t^{\\star}$ 的相位无关。\n\n每个测试用例的算法步骤如下：\n\n1.  **数据生成**：根据每个用例的规范构建大小为 $N \\times T$ 的相位数据矩阵 $\\phi_{n}(t)$。为了可复现性，使用给定的种子 $s$ 初始化伪随机数生成器。对于所有用例，在生成初始值并施加特定对齐后，矩阵中的所有相角都将被包装到区间 $[-\\pi, \\pi]$ 以确保它们是有效值。这通过 `arctan2(sin(angle), cos(angle))` 函数实现。\n\n2.  **观测统计量计算**：使用在分析时间索引 $t^{\\star}$ 处的生成相位数据来计算观测到的试验间相位一致性 $\\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})$。从所有 $N$ 个试验中提取相位 $\\phi_n(t^{\\star})$，将其转换为复相量 $e^{i \\phi_n(t^{\\star})}$，求平均值，然后取该复数均值的绝对值。\n\n3.  **零分布构建**：执行一个循环 $P$ 次以生成零分布。在每次迭代 $p$ 中：\n    a. 从 $\\{0, 1, \\dots, T-1\\}$ 中均匀采样一个包含 $N$ 个随机整数延迟的向量 $\\{k_n^{(p)}\\}_{n=1}^N$。\n    b. 对于每个试验 $n$，从原始数据矩阵 $\\phi_n(t)$ 中检索移位后时间索引 $(t^{\\star} - k_n^{(p)}) \\pmod T$ 处的相位。这构成了本次迭代的置换相位集。\n    c. 根据这组置换后的相位计算零假设 ITPC，$\\mathrm{ITPC}^{(p)}(t^{\\star})$，计算方式与 $\\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})$ 相同。\n    d. 存储得到的值，形成零分布 $\\{\\mathrm{ITPC}^{(p)}(t^{\\star})\\}_{p=1}^{P}$。\n\n4.  **p-值计算**：计算单侧 $p$-值以评估 $\\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})$ 的显著性。它是零假设 ITPC 值中大于或等于观测值的比例。应用标准的有限样本校正以防止 $p$-值为 $0$ 并提供更保守的估计：\n    $$\n    p = \\frac{1 + \\sum_{p=1}^{P} \\mathbf{1}\\left\\{\\mathrm{ITPC}^{(p)}(t^{\\star}) \\ge \\mathrm{ITPC}_{\\mathrm{obs}}(t^{\\star})\\right\\}}{P + 1}\n    $$\n    其中 $\\mathbf{1}\\{\\cdot\\}$ 是指示函数，如果条件为真则为 $1$，否则为 $0$。最终值四舍五入到六位小数。\n\n将此完整过程系统地应用于问题中定义的四个测试用例，从而产生四个不同的 $p$-值。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef _wrap_to_pi(angles):\n    \"\"\"\n    Wraps angles to the interval [-pi, pi].\n    This is a robust way to handle angle wrapping for any real-valued input.\n    \"\"\"\n    return np.arctan2(np.sin(angles), np.cos(angles))\n\ndef calculate_itpc_p_value(N, T, P, t_star, seed, data_gen_params):\n    \"\"\"\n    Calculates the permutation-based p-value for inter-trial phase coherence (ITPC).\n\n    Args:\n        N (int): Number of trials.\n        T (int): Number of time samples per trial.\n        P (int): Number of permutations.\n        t_star (int): Analysis time index.\n        seed (int): Seed for the random number generator.\n        data_gen_params (dict): Parameters for data generation.\n\n    Returns:\n        float: The computed p-value.\n    \"\"\"\n    # 1. Initialization and RNG\n    rng = np.random.default_rng(seed)\n\n    # 2. Data Generation\n    # Initialize with uniform random phases\n    phi_nt = rng.uniform(-np.pi, np.pi, size=(N, T))\n\n    # Apply case-specific modifications\n    case_type = data_gen_params.get('type', 'random')\n    if case_type == 'partial_alignment':\n        theta = data_gen_params['theta']\n        sigma = data_gen_params['sigma']\n        noise = rng.normal(loc=0.0, scale=sigma, size=N)\n        phi_nt[:, t_star] = theta + noise\n    elif case_type == 'perfect_alignment':\n        phi_nt[:, t_star] = 0.0\n\n    # Wrap all generated phases to [-pi, pi] as per problem specification.\n    phi_nt = _wrap_to_pi(phi_nt)\n\n    # 3. Compute Observed ITPC\n    phases_obs = phi_nt[:, t_star]\n    itpc_obs = np.abs(np.mean(np.exp(1j * phases_obs)))\n\n    # 4. Generate Null Distribution\n    itpc_null = np.zeros(P)\n    \n    # Pre-generate all random shifts for efficiency\n    all_shifts = rng.integers(0, T, size=(P, N))\n\n    for p in range(P):\n        shifts = all_shifts[p, :]\n        permuted_time_indices = (t_star - shifts) % T\n\n        # Use fancy indexing to get all permuted phases for this iteration\n        permuted_phases = phi_nt[np.arange(N), permuted_time_indices]\n\n        itpc_null[p] = np.abs(np.mean(np.exp(1j * permuted_phases)))\n\n    # 5. Compute p-value\n    count = np.sum(itpc_null >= itpc_obs)\n    p_value = (1.0 + count) / (P + 1.0)\n\n    return p_value\n\ndef solve():\n    \"\"\"\n    Main function to run all test cases and print results.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        # Case A: happy path with partial alignment\n        {'N': 24, 'T': 400, 'P': 2000, 't_star': 200, 'seed': 42,\n         'data_gen_params': {'type': 'partial_alignment', 'theta': 1.0, 'sigma': 0.3}},\n        # Case B: random phases, no alignment\n        {'N': 24, 'T': 400, 'P': 2000, 't_star': 123, 'seed': 123,\n         'data_gen_params': {'type': 'random'}},\n        # Case C: perfect alignment\n        {'N': 50, 'T': 300, 'P': 2000, 't_star': 150, 'seed': 7,\n         'data_gen_params': {'type': 'perfect_alignment'}},\n        # Case D: boundary case with a degenerate time axis\n        {'N': 10, 'T': 1, 'P': 1000, 't_star': 0, 'seed': 2024,\n         'data_gen_params': {'type': 'degenerate'}}\n    ]\n\n    results = []\n    for case in test_cases:\n        p_val = calculate_itpc_p_value(**case)\n        results.append(f\"{p_val:.6f}\")\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(results)}]\")\n\nsolve()\n```"
        }
    ]
}