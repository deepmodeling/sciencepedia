{
    "hands_on_practices": [
        {
            "introduction": "The fundamental goal of quantitative calcium imaging is to convert a measured fluorescence signal, $F$, into an estimate of the underlying calcium concentration, $[Ca^{2+}]$. This conversion relies on a biophysical model of the indicator's binding properties, typically described by the Hill equation. In this exercise , you will derive the crucial inverse relationship to calculate $[Ca^{2+}]$ from $F$ and then use error propagation to analyze the model's sensitivity, revealing the critical loss of precision near the indicator's baseline and saturation levels.",
            "id": "4188020",
            "problem": "A ratiometric calcium indicator reports fluorescence intensity according to the fraction of indicator molecules bound to free calcium. Assume a well-mixed compartment and the following physical model based on mass-action binding and a Hill description of cooperativity: the fraction of bound indicator is given by $$\\theta = \\frac{([\\mathrm{Ca}]/K_{d})^{n}}{1 + ([\\mathrm{Ca}]/K_{d})^{n}},$$ where $[\\mathrm{Ca}]$ is the free calcium concentration, $K_{d}$ is the dissociation constant, and $n$ is the Hill coefficient. The measured fluorescence is a linear mixture of the unbound and bound states, $$F = F_{\\min} + (F_{\\max} - F_{\\min})\\,\\theta,$$ where $F_{\\min}$ and $F_{\\max}$ are the baseline and saturating fluorescence, respectively. Suppose $F_{\\min} = 120$ arbitrary units, $F_{\\max} = 1020$ arbitrary units, $K_{d} = 300$ nanomolar, and $n = 2$. Assume additive, zero-mean Gaussian measurement noise on fluorescence with standard deviation $ \\sigma_{F} = 15$ arbitrary units. Three fluorescence measurements are obtained: $F_{1} = 165$ arbitrary units, $F_{2} = 570$ arbitrary units, and $F_{3} = 975$ arbitrary units.\n\nUsing only the definitions above as your starting point:\n\n1. Derive a closed-form expression for $[\\mathrm{Ca}]$ as a function of $F$, $F_{\\min}$, $F_{\\max}$, $K_{d}$, and $n$.\n2. Using the derived expression, compute $[\\mathrm{Ca}]$ corresponding to $F_{1}$, $F_{2}$, and $F_{3}$ and express each in nanomolar.\n3. Using first-order error propagation, derive the local relative standard deviation of the inferred $[\\mathrm{Ca}]$ in terms of $F$, $F_{\\min}$, $F_{\\max}$, $n$, and $\\sigma_{F}$, and interpret identifiability near baseline and saturation in terms of this expression.\n4. Finally, compute the ratio of the relative standard deviation of the inferred $[\\mathrm{Ca}]$ at $F_{1}$ or $F_{3}$ (whichever is worse) to that at $F_{2}$. Express the ratio as a dimensionless decimal and round your answer to four significant figures.",
            "solution": "The problem statement provides a valid and well-posed set of questions based on standard biophysical models used in calcium imaging analysis. All necessary constants and data are provided, and there are no scientific or logical inconsistencies. I will therefore proceed with a full solution.\n\nThe problem is divided into four parts. I will address each in sequence.\n\nPart 1: Derivation of $[\\mathrm{Ca}]$ as a function of fluorescence $F$.\n\nWe are given two fundamental equations:\n1. The Hill equation for the fraction of bound indicator, $\\theta$:\n$$ \\theta = \\frac{([\\mathrm{Ca}]/K_{d})^{n}}{1 + ([\\mathrm{Ca}]/K_{d})^{n}} $$\n2. The linear model for fluorescence, $F$:\n$$ F = F_{\\min} + (F_{\\max} - F_{\\min})\\,\\theta $$\n\nOur goal is to derive a closed-form expression for the calcium concentration, $[\\mathrm{Ca}]$, in terms of $F$ and the known parameters $F_{\\min}$, $F_{\\max}$, $K_{d}$, and $n$.\n\nFirst, we solve the fluorescence equation for $\\theta$.\n$$ F - F_{\\min} = (F_{\\max} - F_{\\min})\\,\\theta $$\n$$ \\theta = \\frac{F - F_{\\min}}{F_{\\max} - F_{\\min}} $$\nThis expression represents the normalized fluorescence, which is equivalent to the fraction of bound indicator.\n\nNext, we equate this expression for $\\theta$ with the Hill equation:\n$$ \\frac{F - F_{\\min}}{F_{\\max} - F_{\\min}} = \\frac{([\\mathrm{Ca}]/K_{d})^{n}}{1 + ([\\mathrm{Ca}]/K_{d})^{n}} $$\nTo simplify the algebra, let us define a variable $X = ([\\mathrm{Ca}]/K_{d})^{n}$. The equation becomes:\n$$ \\frac{F - F_{\\min}}{F_{\\max} - F_{\\min}} = \\frac{X}{1 + X} $$\nNow, we solve for $X$:\n$$ (F - F_{\\min})(1 + X) = (F_{\\max} - F_{\\min})X $$\n$$ F - F_{\\min} + (F - F_{\\min})X = (F_{\\max} - F_{\\min})X $$\n$$ F - F_{\\min} = [(F_{\\max} - F_{\\min}) - (F - F_{\\min})]X $$\n$$ F - F_{\\min} = (F_{\\max} - F)X $$\n$$ X = \\frac{F - F_{\\min}}{F_{\\max} - F} $$\nNow, we substitute back $X = ([\\mathrm{Ca}]/K_{d})^{n}$:\n$$ \\left(\\frac{[\\mathrm{Ca}]}{K_{d}}\\right)^{n} = \\frac{F - F_{\\min}}{F_{\\max} - F} $$\nTo isolate $[\\mathrm{Ca}]$, we take the $n$-th root of both sides and multiply by $K_{d}$:\n$$ \\frac{[\\mathrm{Ca}]}{K_{d}} = \\left(\\frac{F - F_{\\min}}{F_{\\max} - F}\\right)^{1/n} $$\n$$ [\\mathrm{Ca}] = K_{d} \\left(\\frac{F - F_{\\min}}{F_{\\max} - F}\\right)^{1/n} $$\nThis is the required closed-form expression for $[\\mathrm{Ca}]$.\n\nPart 2: Calculation of $[\\mathrm{Ca}]$ for the given fluorescence values.\n\nWe use the derived expression with the provided constants: $F_{\\min} = 120$, $F_{\\max} = 1020$, $K_{d} = 300$ nanomolar (nM), and $n = 2$.\n\nFor $F_{1} = 165$:\n$$ [\\mathrm{Ca}]_{1} = 300 \\left(\\frac{165 - 120}{1020 - 165}\\right)^{1/2} = 300 \\left(\\frac{45}{855}\\right)^{1/2} = 300 \\left(\\frac{1}{19}\\right)^{1/2} = \\frac{300}{\\sqrt{19}} \\, \\mathrm{nM} \\approx 68.82 \\, \\mathrm{nM} $$\n\nFor $F_{2} = 570$:\n$$ [\\mathrm{Ca}]_{2} = 300 \\left(\\frac{570 - 120}{1020 - 570}\\right)^{1/2} = 300 \\left(\\frac{450}{450}\\right)^{1/2} = 300 \\left(1\\right)^{1/2} = 300 \\, \\mathrm{nM} $$\nThis result is expected, as $F_2 = 570$ is the midpoint of the fluorescence range, corresponding to $\\theta = 0.5$, which by definition of the Hill equation occurs when $[\\mathrm{Ca}] = K_{d}$.\n\nFor $F_{3} = 975$:\n$$ [\\mathrm{Ca}]_{3} = 300 \\left(\\frac{975 - 120}{1020 - 975}\\right)^{1/2} = 300 \\left(\\frac{855}{45}\\right)^{1/2} = 300 \\left(19\\right)^{1/2} = 300\\sqrt{19} \\, \\mathrm{nM} \\approx 1307.67 \\, \\mathrm{nM} $$\n\nPart 3: Derivation and interpretation of the relative standard deviation.\n\nWe use the first-order error propagation formula. For a function $y = f(x)$, the uncertainty $\\sigma_y$ is related to the uncertainty $\\sigma_x$ by $\\sigma_y \\approx |\\frac{dy}{dx}|\\sigma_x$.\nHere, our function is $[\\mathrm{Ca}](F)$ and the measurement uncertainty is $\\sigma_F$. The standard deviation of the inferred calcium concentration, $\\sigma_{[\\mathrm{Ca}]}$, is:\n$$ \\sigma_{[\\mathrm{Ca}]} \\approx \\left| \\frac{d[\\mathrm{Ca}]}{dF} \\right| \\sigma_{F} $$\nThe relative standard deviation is $\\frac{\\sigma_{[\\mathrm{Ca}]}}{[\\mathrm{Ca}]}$.\n$$ \\frac{\\sigma_{[\\mathrm{Ca}]}}{[\\mathrm{Ca}]} \\approx \\frac{1}{[\\mathrm{Ca}]} \\left| \\frac{d[\\mathrm{Ca}]}{dF} \\right| \\sigma_{F} $$\nLet's compute the derivative $\\frac{d[\\mathrm{Ca}]}{dF}$ using the expression from Part 1. For simplicity, let $C = [\\mathrm{Ca}]$ and use the chain rule.\n$$ C = K_{d} \\left(\\frac{F - F_{\\min}}{F_{\\max} - F}\\right)^{1/n} \\implies \\ln(C) = \\ln(K_{d}) + \\frac{1}{n}\\left[ \\ln(F - F_{\\min}) - \\ln(F_{\\max} - F) \\right] $$\nDifferentiating with respect to $F$:\n$$ \\frac{1}{C}\\frac{dC}{dF} = \\frac{1}{n} \\left[ \\frac{1}{F - F_{\\min}} - \\frac{-1}{F_{\\max} - F} \\right] = \\frac{1}{n} \\left[ \\frac{1}{F - F_{\\min}} + \\frac{1}{F_{\\max} - F} \\right] $$\n$$ \\frac{1}{C}\\frac{dC}{dF} = \\frac{1}{n} \\frac{(F_{\\max} - F) + (F - F_{\\min})}{(F - F_{\\min})(F_{\\max} - F)} = \\frac{1}{n} \\frac{F_{\\max} - F_{\\min}}{(F - F_{\\min})(F_{\\max} - F)} $$\nSince $\\frac{1}{[\\mathrm{Ca}]} \\frac{d[\\mathrm{Ca}]}{dF}$ is positive for $F_{\\min} < F < F_{\\max}$, we can drop the absolute value.\n$$ \\frac{\\sigma_{[\\mathrm{Ca}]}}{[\\mathrm{Ca}]} \\approx \\left( \\frac{1}{[\\mathrm{Ca}]} \\frac{d[\\mathrm{Ca}]}{dF} \\right) \\sigma_F = \\frac{1}{n} \\frac{F_{\\max} - F_{\\min}}{(F - F_{\\min})(F_{\\max} - F)} \\sigma_{F} $$\nThis is the derived expression for the local relative standard deviation of $[\\mathrm{Ca}]$.\n\nInterpretation: The relative standard deviation, which is the relative error of the calcium estimate, is inversely proportional to the product $(F - F_{\\min})(F_{\\max} - F)$. This product term is zero at the boundaries $F=F_{\\min}$ and $F=F_{\\max}$, and maximal at the center of the range, $F = (F_{\\min}+F_{\\max})/2$. Consequently, as the measured fluorescence $F$ approaches either the baseline ($F_{\\min}$) or saturation ($F_{\\max}$), the denominator approaches zero, and the relative error $\\frac{\\sigma_{[\\mathrm{Ca}]}}{[\\mathrm{Ca}]}$ diverges to infinity. This signifies a catastrophic loss of identifiability. Near baseline and saturation, the relationship between $[\\mathrm{Ca}]$ and $F$ is very flat, meaning a very large change in calcium concentration produces only a minuscule, noise-obscured change in fluorescence. Thus, the indicator is insensitive and measurements in these regimes are unreliable for quantifying $[\\mathrm{Ca}]$.\n\nPart 4: Calculation of the ratio of relative standard deviations.\n\nLet $RSD(F)$ denote the relative standard deviation at fluorescence $F$.\n$$ RSD(F) = \\frac{\\sigma_F}{n} \\frac{F_{\\max} - F_{\\min}}{(F - F_{\\min})(F_{\\max} - F)} $$\nWe need to compare $RSD(F_1)$, $RSD(F_2)$, and $RSD(F_3)$. The term \"worse\" implies a larger relative standard deviation.\nLet's evaluate the denominator term $(F - F_{\\min})(F_{\\max} - F)$ for each measurement point.\n$F_{\\min}=120$, $F_{\\max}=1020$.\n\nFor $F_{1} = 165$:\n$$ (165 - 120)(1020 - 165) = (45)(855) = 38475 $$\n\nFor $F_{2} = 570$:\n$$ (570 - 120)(1020 - 570) = (450)(450) = 202500 $$\n\nFor $F_{3} = 975$:\n$$ (975 - 120)(1020 - 975) = (855)(45) = 38475 $$\n\nSince the numerators of the $RSD$ expressions are identical, the largest $RSD$ will correspond to the smallest denominator. Here, $RSD(F_1) = RSD(F_3)$, and both are larger than $RSD(F_2)$. Thus, the \"worse\" case corresponds to either $F_1$ or $F_3$.\n\nWe need to compute the ratio of the worse $RSD$ to that at $F_2$.\n$$ \\frac{RSD(F_1)}{RSD(F_2)} = \\frac{\\frac{\\sigma_F}{n} \\frac{F_{\\max} - F_{\\min}}{(F_1 - F_{\\min})(F_{\\max} - F_1)}}{\\frac{\\sigma_F}{n} \\frac{F_{\\max} - F_{\\min}}{(F_2 - F_{\\min})(F_{\\max} - F_2)}} = \\frac{(F_2 - F_{\\min})(F_{\\max} - F_2)}{(F_1 - F_{\\min})(F_{\\max} - F_1)} $$\nPlugging in the calculated denominator values:\n$$ \\mathrm{Ratio} = \\frac{202500}{38475} $$\nTo simplify the fraction:\n$$ \\mathrm{Ratio} = \\frac{202500 \\div 25}{38475 \\div 25} = \\frac{8100}{1539} $$\n$$ \\mathrm{Ratio} = \\frac{8100 \\div 9}{1539 \\div 9} = \\frac{900}{171} $$\n$$ \\mathrm{Ratio} = \\frac{900 \\div 9}{171 \\div 9} = \\frac{100}{19} $$\nAs a decimal, this ratio is $100 \\div 19 \\approx 5.263157...$.\nRounding to four significant figures, the ratio is $5.263$.",
            "answer": "$$\\boxed{5.263}$$"
        },
        {
            "introduction": "A robust analysis of measurement uncertainty, as explored in the previous practice, requires a precise model of the noise sources within your imaging system. The fluorescence signal recorded by a digital camera is fundamentally limited by two components: photon shot noise, which is inherent to the quantum nature of light, and electronic read noise, which is added by the sensor's electronics. This practical exercise  will guide you through deriving the relationship between signal variance and mean, and then using this model to fit experimental data, allowing you to estimate your camera's key performance parameters—a foundational skill for any quantitative imaging study.",
            "id": "4188069",
            "problem": "You are analyzing fluorescence signals in calcium imaging using a photon-counting model and a camera with electronic readout. The foundational assumptions are: photon arrivals follow Poisson statistics with independent electronic read noise, and the camera response is linear. Start from the following base principles: (i) Poisson statistics imply that if the number of detected photoelectrons is denoted by $N$ with mean $E[N] = \\mu_e$, then $Var(N) = \\mu_e$, (ii) linear transformation of a random variable $X$ via $Y = a X$ scales the variance as $Var(Y) = a^2 Var(X)$, (iii) variances of independent random variables add, so if $X$ and $Z$ are independent, then $Var(X+Z) = Var(X) + Var(Z)$, and (iv) the camera read noise can be modeled as a zero-mean Gaussian random variable with variance $Var(R) = \\sigma_r^2$. Derive, in counts units, the functional relation linking the measured variance of counts to the measured mean counts under these assumptions and show how to infer the contribution attributable to shot noise and read noise from measured data. Then formulate the Fano factor, defined as the ratio of variance to mean, and use it to validate the model across brightness levels.\n\nYour program must do the following for each provided test dataset:\n- Estimate the effective gain $k$ (counts per electron) and the read noise standard deviation $\\sigma_r$ (counts) from measured mean counts and variance of counts by fitting a linear model to the variance–mean relation derived from first principles above, enforcing physical non-negativity of parameters.\n- Compute the measured Fano factor $F_i = Var_i / \\mu_i$ at each brightness level $\\mu_i$ (in counts), and compute the model-predicted Fano factor using your fitted parameters at the same brightness levels.\n- Report, for each dataset, the triplet consisting of the estimated effective gain $k$ (in counts per electron), the estimated read noise standard deviation $\\sigma_r$ (in counts), and the maximum absolute deviation between measured and predicted Fano factors across brightness levels (dimensionless).\n\nUse the following test suite of datasets, each specified by an array of measured mean counts and the corresponding measured variance of counts. All counts are in counts units and all variances are in counts squared. The brightness levels are typical for fluorescence calcium imaging measured with linear sensors.\n\n- Dataset $1$ (moderate brightness range, mixed noise contributions):\n  - Mean counts: $[\\;10,\\;30,\\;60,\\;120,\\;240,\\;480\\;]$\n  - Variance of counts: $[\\;19.25,\\;45.25,\\;84.25,\\;162.25,\\;318.25,\\;630.25\\;]$\n\n- Dataset $2$ (low brightness range, read noise more prominent):\n  - Mean counts: $[\\;2,\\;4,\\;8,\\;16,\\;32,\\;64\\;]$\n  - Variance of counts: $[\\;17.8,\\;19.6,\\;23.2,\\;30.4,\\;44.8,\\;73.6\\;]$\n\n- Dataset $3$ (high brightness range, shot noise dominates):\n  - Mean counts: $[\\;1000,\\;2000,\\;4000,\\;8000\\;]$\n  - Variance of counts: $[\\;1802.25,\\;3602.25,\\;7202.25,\\;14402.25\\;]$\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, where each element corresponds to one dataset and is itself a list in the form $[\\;k,\\;\\sigma_r,\\;d\\;]$, with $k$ in counts per electron, $\\sigma_r$ in counts, and $d$ the maximum absolute Fano factor deviation (dimensionless). For example, the output format must be $[\\;[k_1,\\sigma_{r,1},d_1],[k_2,\\sigma_{r,2},d_2],[k_3,\\sigma_{r,3},d_3]\\;]$.",
            "solution": "The problem requires the derivation of a functional relationship for camera noise and the application of this model to estimate key sensor parameters from experimental data. The derivation and analysis will be performed based on the provided first principles.\n\nFirst, we derive the functional relation between the measured variance and the measured mean of the fluorescence signal, expressed in camera counts. Let $N_e$ be the number of photoelectrons detected by a pixel in a given time interval. This is a random variable. According to principle (i), photon arrival is a Poisson process, so if the mean number of photoelectrons is $E[N_e] = \\mu_e$, then the variance is $Var(N_e) = \\mu_e$.\n\nThe camera electronics convert these photoelectrons into a digital signal, measured in counts. Let this conversion factor, or gain, be $k$ counts per electron. The camera response is stated to be linear. In addition to the signal generated from photons (shot noise), the camera introduces its own electronic read noise, which we denote by the random variable $R$. The total measured signal in counts, $C$, is the sum of these two components:\n$$C = k N_e + R$$\nThe read noise $R$ is assumed to be independent of the photoelectron signal $N_e$.\n\nWe first find the mean of the measured signal, $\\mu_c = E[C]$. Using the linearity of the expectation operator:\n$$\\mu_c = E[k N_e + R] = E[k N_e] + E[R] = k E[N_e] + E[R]$$\nFrom principle (iv), the read noise $R$ is a zero-mean process, so $E[R]=0$. Therefore, the mean measured signal is directly proportional to the mean number of photoelectrons:\n$$\\mu_c = k \\mu_e$$\nThis equation relates the mean signal in counts, $\\mu_c$, to the mean signal in photoelectrons, $\\mu_e$, via the gain $k$. We can express $\\mu_e$ in terms of the measurable quantity $\\mu_c$ as $\\mu_e = \\mu_c / k$.\n\nNext, we derive the variance of the measured signal, $Var_c = Var(C)$. As the signal component $k N_e$ and the read noise $R$ are independent, principle (iii) states that their variances add:\n$$Var_c = Var(k N_e + R) = Var(k N_e) + Var(R)$$\nThe variance of the read noise is given by principle (iv) as $Var(R) = \\sigma_r^2$, where $\\sigma_r$ is the read noise standard deviation in counts.\nFor the signal component, we use principle (ii) for the scaling of variance under a linear transformation:\n$$Var(k N_e) = k^2 Var(N_e)$$\nSubstituting the Poisson property from principle (i), $Var(N_e) = \\mu_e$:\n$$Var(k N_e) = k^2 \\mu_e$$\nThis term, $k^2 \\mu_e$, represents the shot noise variance. To express this in terms of the measured mean counts $\\mu_c$, we substitute $\\mu_e = \\mu_c / k$:\n$$Var(k N_e) = k^2 \\left(\\frac{\\mu_c}{k}\\right) = k \\mu_c$$\nCombining the shot noise and read noise variance components, we arrive at the final functional relation:\n$$Var_c = k \\mu_c + \\sigma_r^2$$\nThis equation is linear in the mean signal $\\mu_c$. It shows that the total measured variance $Var_c$ is the sum of the shot noise variance, which scales linearly with the mean signal, and the read noise variance, which is a constant offset. This is a fundamental model for the noise characteristics of many scientific imaging sensors.\n\nTo infer the parameters $k$ and $\\sigma_r^2$ from measured data pairs $(\\mu_{c,i}, Var_{c,i})$, one can perform a linear regression of $Var_c$ versus $\\mu_c$. The slope of the fitted line provides an estimate of the gain $k$, and the y-intercept provides an estimate of the read noise variance $\\sigma_r^2$. Both parameters must be physically non-negative, i.e., $k \\ge 0$ and $\\sigma_r^2 \\ge 0$. Therefore, a non-negative least-squares linear fit is the appropriate estimation method.\n\nThe Fano factor, defined as the ratio of variance to mean, is a useful tool for model validation. The measured Fano factor is $F_{meas} = Var_c / \\mu_c$. Using our derived model, the predicted Fano factor is:\n$$F_{pred} = \\frac{k \\mu_c + \\sigma_r^2}{\\mu_c} = k + \\frac{\\sigma_r^2}{\\mu_c}$$\nThis model predicts that the Fano factor is not constant but depends on the signal level $\\mu_c$. For high signal levels ($\\mu_c \\gg \\sigma_r^2/k$), the Fano factor approaches a constant value equal to the gain $k$. For low signal levels, the Fano factor is dominated by the read noise term and becomes large. The deviation between the measured and predicted Fano factors, $d = \\max_i |F_{meas,i} - F_{pred,i}|$, serves as a metric for the goodness-of-fit of the model to the data.\n\nThe algorithm to solve the problem is as follows:\n$1$. For each dataset of measured mean counts $(\\mu_{c,i})$ and variances $(Var_{c,i})$, construct a linear system $A \\mathbf{x} \\approx \\mathbf{b}$, where $\\mathbf{x} = [k, \\sigma_r^2]^T$, the design matrix $A$ has columns $[\\mu_{c,i}]$ and a column of ones, and $\\mathbf{b}$ is the vector $[Var_{c,i}]$.\n$2$. Solve for $\\mathbf{x}$ using a non-negative least-squares algorithm to find the estimated gain $k$ and read noise variance $\\sigma_r^2$, respecting the physical constraints $k \\ge 0$ and $\\sigma_r^2 \\ge 0$.\n$3$. Calculate the read noise standard deviation $\\sigma_r = \\sqrt{\\sigma_r^2}$.\n$4$. For each data point $i$, calculate the measured Fano factor $F_{meas,i} = Var_{c,i} / \\mu_{c,i}$ and the predicted Fano factor $F_{pred,i} = k + \\sigma_r^2 / \\mu_{c,i}$.\n$5$. Find the maximum absolute deviation $d = \\max_i |F_{meas,i} - F_{pred,i}|$.\n$6$. Report the triplet $[k, \\sigma_r, d]$ for each dataset.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.optimize import lsq_linear\n\ndef solve():\n    \"\"\"\n    Derives sensor parameters from noise measurements and validates the model.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    test_cases = [\n        (\n            np.array([10., 30., 60., 120., 240., 480.]),\n            np.array([19.25, 45.25, 84.25, 162.25, 318.25, 630.25])\n        ),\n        (\n            np.array([2., 4., 8., 16., 32., 64.]),\n            np.array([17.8, 19.6, 23.2, 30.4, 44.8, 73.6])\n        ),\n        (\n            np.array([1000., 2000., 4000., 8000.]),\n            np.array([1802.25, 3602.25, 7202.25, 14402.25])\n        )\n    ]\n\n    results = []\n    for mean_counts, var_counts in test_cases:\n        # The derived model is Var = k * mu + sigma_r^2.\n        # This is a linear model y = m*x + c, where:\n        # y = Var (variance of counts)\n        # x = mu (mean counts)\n        # m = k (effective gain, counts/electron)\n        # c = sigma_r^2 (read noise variance, counts^2)\n\n        # Set up the linear least-squares problem Ax = b.\n        # The design matrix A has the mean counts as the first column\n        # and a column of ones for the intercept term.\n        A = np.vstack([mean_counts, np.ones(len(mean_counts))]).T\n        b = var_counts\n\n        # We need to solve for x = [k, sigma_r^2] subject to non-negativity.\n        # We use scipy.optimize.lsq_linear for this constrained regression.\n        # The bounds are [0, inf] for both parameters.\n        bounds = ([0, 0], [np.inf, np.inf])\n        res = lsq_linear(A, b, bounds=bounds)\n        \n        # Extract the estimated parameters\n        k_est, sigma_r_sq_est = res.x\n        \n        # Calculate the read noise standard deviation\n        sigma_r_est = np.sqrt(sigma_r_sq_est)\n\n        # Compute the Fano factors and the maximum deviation\n        # Measured Fano factor: F_meas = Var_i / mu_i\n        fano_meas = var_counts / mean_counts\n        \n        # Predicted Fano factor from the model: F_pred = k + sigma_r^2 / mu_i\n        fano_pred = k_est + sigma_r_sq_est / mean_counts\n        \n        # Maximum absolute deviation between measured and predicted Fano factors\n        max_fano_dev = np.max(np.abs(fano_meas - fano_pred))\n\n        # Store the results for this dataset\n        results.append([k_est, sigma_r_est, max_fano_dev])\n\n    # Final print statement in the exact required format.\n    # The output format is a list of lists: [[k1, sr1, d1], [k2, sr2, d2], ...]\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "Modern neuroscience experiments often employ multiple fluorescent indicators simultaneously to monitor different aspects of neural activity, such as calcium and voltage. However, the overlapping emission spectra of these indicators lead to signal 'bleed-through' between detection channels, creating a linear mixing problem. This exercise  demonstrates the statistically optimal method for unmixing these signals using calibration data and shows how to properly propagate measurement noise through the unmixing process to quantify the final uncertainty in each estimated signal component.",
            "id": "4188056",
            "problem": "You are analyzing two genetically encoded calcium indicators with overlapping emission spectra recorded on two detection channels. Under low to moderate photon flux without detector saturation, the measured fluorescence is well approximated by a linear superposition of indicator contributions plus additive noise. The calibration uses pure samples: one containing only indicator $1$ and one containing only indicator $2$, each at known relative concentration $1$ (arbitrary units). Each calibration measurement provides a two-dimensional response vector in arbitrary fluorescence units (a.u.), one value per detection channel. A separate mixed sample provides a two-dimensional measurement in a.u. for the same channels. Channel noise is modeled as zero-mean Gaussian with known standard deviations per channel (a.u.), and the channel noise covariance matrix is diagonal.\n\nStarting from the linearity of detection and the superposition principle, and using the assumption of independent Gaussian noise across channels, derive the statistically optimal linear unmixing matrix that maps measured channel intensities to estimated indicator concentrations. Apply this matrix to the mixed sample to estimate the two indicator concentrations. Quantify the residual cross-talk after unmixing by computing the off-diagonal elements of the effective system obtained by composing the unmixing with the mixing estimated from calibration. Propagate measurement noise through the unmixing to compute the standard deviation (uncertainty) of each estimated concentration. All concentrations and uncertainties must be reported in the same arbitrary concentration units (a.u.). Cross-talk values must be reported as decimals (fractions), not with a percentage sign.\n\nYour program must implement this end-to-end procedure for the following test suite of three cases. For each case, you are given the two calibration vectors (indicator $1$ only and indicator $2$ only), the mixed-sample measurement vector, and the two channel noise standard deviations. All values are in arbitrary units (a.u.). The calibration vectors define the columns of the mixing matrix. For each case, output six floats in the following order: estimated concentration of indicator $1$, estimated concentration of indicator $2$, residual cross-talk from indicator $2$ into the estimate of indicator $1$, residual cross-talk from indicator $1$ into the estimate of indicator $2$, standard deviation of the estimate of indicator $1$, standard deviation of the estimate of indicator $2$.\n\nTest suite:\n- Case $1$ (well-conditioned overlap):\n  - Calibration (indicator $1$ only): channel $1$ $1200$, channel $2$ $300$.\n  - Calibration (indicator $2$ only): channel $1$ $400$, channel $2$ $1000$.\n  - Mixed sample: channel $1$ $1500$, channel $2$ $1100$.\n  - Channel noise standard deviations: channel $1$ $\\;20$, channel $2$ $\\;25$.\n- Case $2$ (stronger overlap, poorer conditioning):\n  - Calibration (indicator $1$ only): channel $1$ $1000$, channel $2$ $800$.\n  - Calibration (indicator $2$ only): channel $1$ $900$, channel $2$ $1100$.\n  - Mixed sample: channel $1$ $1600$, channel $2$ $1700$.\n  - Channel noise standard deviations: channel $1$ $\\;50$, channel $2$ $\\;50$.\n- Case $3$ (mixture dominated by indicator $1$):\n  - Calibration (indicator $1$ only): channel $1$ $800$, channel $2$ $200$.\n  - Calibration (indicator $2$ only): channel $1$ $300$, channel $2$ $900$.\n  - Mixed sample: channel $1$ $820$, channel $2$ $210$.\n  - Channel noise standard deviations: channel $1$ $\\;30$, channel $2$ $\\;30$.\n\nYour program should produce a single line of output containing the results as a comma-separated list enclosed in square brackets, ordered by case and flattened. For example, the output must have the form $[r_1,r_2,\\dots,r_{18}]$ with exactly $18$ floats corresponding to the six outputs per case, concatenated for the three cases in order. Express all outputs in arbitrary units (a.u.) except the cross-talk quantities, which are unitless decimals.",
            "solution": "The problem of estimating indicator concentrations from spectrally overlapping fluorescence signals is a classic linear unmixing problem. This solution first formalizes the physical model and then derives the optimal estimation procedure based on statistical principles.\n\n#### 1. System Modeling\nLet $\\mathbf{c} = \\begin{pmatrix} c_1 \\\\ c_2 \\end{pmatrix}$ be the vector of unknown indicator concentrations. Let $\\mathbf{m} = \\begin{pmatrix} m_1 \\\\ m_2 \\end{pmatrix}$ be the vector of measured fluorescence intensities. Based on the principle of linear superposition, the relationship between concentrations and ideal, noiseless measurements is:\n$$ \\mathbf{m}_{\\text{ideal}} = A \\mathbf{c} $$\nwhere $A$ is the $2 \\times 2$ mixing matrix. The columns of $A$ are the calibration vectors $\\mathbf{s}_1$ and $\\mathbf{s}_2$. The real measurements are corrupted by additive Gaussian noise, $\\mathbf{n}$, so the full model is:\n$$ \\mathbf{m} = A \\mathbf{c} + \\mathbf{n} $$\nThe noise vector $\\mathbf{n}$ has zero mean, $\\mathbb{E}[\\mathbf{n}] = \\mathbf{0}$, and a diagonal covariance matrix $\\Sigma_n$ since channel noises are independent:\n$$ \\Sigma_n = \\mathbb{E}[\\mathbf{n} \\mathbf{n}^T] = \\begin{pmatrix} \\sigma_1^2 & 0 \\\\ 0 & \\sigma_2^2 \\end{pmatrix} $$\nwhere $\\sigma_1$ and $\\sigma_2$ are the noise standard deviations in each channel.\n\n#### 2. Optimal Linear Unmixing\nWe seek an estimate $\\hat{\\mathbf{c}}$ that is a linear function of the measurements $\\mathbf{m}$, i.e., $\\hat{\\mathbf{c}} = W \\mathbf{m}$. For a linear model with Gaussian noise, the statistically optimal estimator is the maximum likelihood estimator (MLE), found by solving the Generalized Least Squares (GLS) problem:\n$$ \\min_{\\mathbf{c}} (\\mathbf{m} - A\\mathbf{c})^T \\Sigma_n^{-1} (\\mathbf{m} - A\\mathbf{c}) $$\nThe solution gives the estimated concentration vector $\\hat{\\mathbf{c}}$ and defines the optimal unmixing matrix $W$:\n$$ \\hat{\\mathbf{c}} = (A^T \\Sigma_n^{-1} A)^{-1} A^T \\Sigma_n^{-1} \\mathbf{m} = W \\mathbf{m} $$\n\n#### 3. Residual Cross-Talk\nThe effective system matrix $M_{eff} = WA$ maps true concentrations to estimated concentrations in the absence of noise. For the optimal estimator, this is the identity matrix:\n$$ M_{eff} = WA = \\left( (A^T \\Sigma_n^{-1} A)^{-1} A^T \\Sigma_n^{-1} \\right) A = (A^T \\Sigma_n^{-1} A)^{-1} (A^T \\Sigma_n^{-1} A) = I $$\nAn ideal unmixing results in an identity matrix, meaning the off-diagonal elements (residual cross-talk) are zero.\n\n#### 4. Uncertainty Propagation\nThe uncertainty in the estimate $\\hat{\\mathbf{c}}$ is due to the measurement noise $\\mathbf{n}$. The estimation error is $\\hat{\\mathbf{c}} - \\mathbf{c} = W\\mathbf{n}$. The covariance matrix of the estimate, $\\Sigma_{\\hat{\\mathbf{c}}}$, is found by propagating the noise covariance $\\Sigma_n$ through the unmixing matrix $W$:\n$$ \\Sigma_{\\hat{\\mathbf{c}}} = \\mathbb{E}[(\\hat{\\mathbf{c}} - \\mathbf{c})(\\hat{\\mathbf{c}} - \\mathbf{c})^T] = W \\mathbb{E}[\\mathbf{n}\\mathbf{n}^T] W^T = W \\Sigma_n W^T $$\nSubstituting the expression for $W$ and simplifying gives a remarkably compact result:\n$$ \\Sigma_{\\hat{\\mathbf{c}}} = (A^T \\Sigma_n^{-1} A)^{-1} $$\nThe standard deviation (uncertainty) of each estimated concentration, $\\sigma_{\\hat{c}_i}$, is the square root of the corresponding diagonal element of this covariance matrix:\n$$ \\sigma_{\\hat{c}_1} = \\sqrt{(\\Sigma_{\\hat{\\mathbf{c}}})_{11}} \\quad \\text{and} \\quad \\sigma_{\\hat{c}_2} = \\sqrt{(\\Sigma_{\\hat{\\mathbf{c}}})_{22}} $$\nThis framework provides both the best linear unbiased estimates of the concentrations and a principled quantification of their uncertainties.",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the linear unmixing problem for three test cases.\n    \"\"\"\n    \n    # Define the test cases from the problem statement.\n    # Each case is a tuple: (s1, s2, m, noise_std)\n    # s1: calibration vector for indicator 1\n    # s2: calibration vector for indicator 2\n    # m: mixed sample measurement vector\n    # noise_std: channel noise standard deviations\n    test_cases = [\n        (\n            np.array([1200.0, 300.0]),\n            np.array([400.0, 1000.0]),\n            np.array([1500.0, 1100.0]),\n            np.array([20.0, 25.0])\n        ),\n        (\n            np.array([1000.0, 800.0]),\n            np.array([900.0, 1100.0]),\n            np.array([1600.0, 1700.0]),\n            np.array([50.0, 50.0])\n        ),\n        (\n            np.array([800.0, 200.0]),\n            np.array([300.0, 900.0]),\n            np.array([820.0, 210.0]),\n            np.array([30.0, 30.0])\n        )\n    ]\n\n    results = []\n    \n    for s1, s2, m, noise_std in test_cases:\n        # Step 1: Construct the mixing matrix A and noise covariance matrix\n        # The mixing matrix A has the calibration vectors as its columns.\n        A = np.vstack((s1, s2)).T\n        \n        # The noise covariance matrix Sigma_n is diagonal with variances on the diagonal.\n        # Its inverse, Sigma_n_inv, is also diagonal with inverse variances.\n        noise_var = noise_std**2\n        Sigma_n_inv = np.diag(1.0 / noise_var)\n\n        # Step 2: Calculate the intermediate matrix F = A^T * Sigma_n_inv * A\n        # This is the Fisher Information Matrix for this model.\n        F = A.T @ Sigma_n_inv @ A\n\n        # Step 3: Calculate the covariance matrix of the estimated concentrations\n        # This is the inverse of F.\n        # Sigma_c_hat = inv(F)\n        Sigma_c_hat = np.linalg.inv(F)\n\n        # Step 4: Calculate the optimal unmixing matrix W\n        # W = (A^T * Sigma_n_inv * A)^-1 * A^T * Sigma_n_inv = Sigma_c_hat * A^T * Sigma_n_inv\n        W = Sigma_c_hat @ A.T @ Sigma_n_inv\n\n        # Step 5: Estimate the concentrations\n        # c_hat = W * m\n        c_hat = W @ m\n        c1_est, c2_est = c_hat\n\n        # Step 6: Compute residual cross-talk\n        # As derived in the solution, the effective system matrix WA = I.\n        # Thus, the off-diagonal elements (cross-talk) are identically zero.\n        crosstalk_21 = 0.0\n        crosstalk_12 = 0.0\n\n        # Step 7: Compute the standard deviations of the estimated concentrations\n        # These are the square roots of the diagonal elements of Sigma_c_hat.\n        std_c1 = np.sqrt(Sigma_c_hat[0, 0])\n        std_c2 = np.sqrt(Sigma_c_hat[1, 1])\n\n        # Append the six required values to the results list\n        results.extend([c1_est, c2_est, crosstalk_21, crosstalk_12, std_c1, std_c2])\n\n    # Final print statement in the exact required format.\n    # The format is a single line, comma-separated list of floats enclosed in brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n\n```"
        }
    ]
}