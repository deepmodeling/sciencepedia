{
    "hands_on_practices": [
        {
            "introduction": "同步EEG-fMRI记录虽然功能强大，但fMRI扫描仪的梯度磁场会在EEG信号中引入巨大的伪影，其幅度甚至远超真实的神经活动信号。最基础的校正方法是伪影平均减法（AAS），它利用了伪影的准周期性。本练习 () 将引导您从数学上推导并评估AAS方法的性能，通过分析校正后的残余伪影功率，您将深刻理解用于平均的周期数量和具体的平均策略如何影响伪影去除效果，这对于保证最终数据质量至关重要。",
            "id": "4179392",
            "problem": "给定一个在功能性磁共振成像 (fMRI) 期间记录的脑电图 (EEG) 的数学模型，其中磁共振 (MR) 梯度伪影在不同容积中重复出现。对于每个容积索引 $k$ 和离散时间索引 $t \\in \\{0,1,\\dots,T-1\\}$，伪影片段被建模为 $A_k(t) = \\mu(t) + \\epsilon_k(t)$，其中 $\\mu(t)$ 是一个确定性的伪影模板（在所有容积中都相同），而 $\\epsilon_k(t)$ 是一个跨容积的零均值随机偏差。假设对于每个固定的 $t$，集合 $\\{\\epsilon_k(t)\\}_{k}$ 是独立同分布的，方差为 $\\sigma_a^2$（在不同的 $t$ 之间不一定独立），并且 $\\epsilon_k(t)$ 独立于 $\\mu(t)$。每个片段的伪影功率定义为 $P_{\\text{pre}} = \\sum_{t=0}^{T-1} \\mathbb{E}\\big[A_k(t)^2\\big]$，而经过平均伪影减法后的残留伪影功率定义为 $P_{\\text{res}} = \\sum_{t=0}^{T-1} \\mathbb{E}\\big[R_k(t)^2\\big]$，其中 $R_k(t)$ 是减去一个由 $N$ 个容积计算出的平均模板后的残留伪影。\n\n平均伪影减法 (AAS) 使用观测到的伪影片段的经验平均值来估计模板。考虑用于从目标容积 $k^\\star$ 中减去的模板的两种估计器设计：\n\n- 包含式平均：$\\hat{\\mu}_N^{\\text{inc}}(t) = \\frac{1}{N}\\sum_{i=1}^{N} A_i(t)$，其中目标容积 $k^\\star$ 是用于计算平均值的 $N$ 个容积之一。残差为 $R_{k^\\star}^{\\text{inc}}(t) = A_{k^\\star}(t) - \\hat{\\mu}_N^{\\text{inc}}(t)$。\n\n- 留一法（排他式）平均：$\\hat{\\mu}_N^{\\text{exc}}(t) = \\frac{1}{N}\\sum_{i \\in \\mathcal{I}} A_i(t)$，其中 $\\mathcal{I}$ 是一个包含 $N$ 个容积且排除了目标 $k^\\star$ 的集合。残差为 $R_{k^\\star}^{\\text{exc}}(t) = A_{k^\\star}(t) - \\hat{\\mu}_N^{\\text{exc}}(t)$。\n\n从上述定义以及独立随机变量的期望和方差性质出发，推导两种设计下残留伪影功率 $P_{\\text{res}}$ 的表达式，并分析其随 $N$ 增大时的收敛性。具体来说，计算无量纲的残留伪影功率比 $R = P_{\\text{res}} / P_{\\text{pre}}$。在 $\\mu(t)$ 的任何正弦构造中使用的所有角度都必须以弧度为单位。所有功率都必须以平方微伏 ($\\mu\\text{V}^2$) 表示。\n\n对于数值评估，在样本数 $T$ 下，使用以下 $\\mu(t)$ 的确定性模板构造：\n- $\\mu(t) = A_1 \\sin\\left(2\\pi f_1 \\frac{t}{T}\\right) + A_2 \\cos\\left(2\\pi f_2 \\frac{t}{T}\\right)$，角度以弧度为单位。\n- 使用 $T = 256$，$A_1 = 50$ $\\mu\\text{V}$，$A_2 = 30$ $\\mu\\text{V}$，$f_1 = 5$ 和 $f_2 = 13$。\n- 对每个 $t$ 跨容积的随机偏差标准差使用 $\\sigma_a = 10$ $\\mu\\text{V}$，因此方差为 $\\sigma_a^2$。\n\n定义以下参数集测试套件，每个集合指定平均设计（包含式或排他式）、用于计算平均值的容积数 $N$ 以及模板 $\\mu(t)$ 的条件。在所有情况下，将残留伪影功率比 $R$ 报告为小数（无量纲）。对于最终输出，请按此处提供的确切顺序列出结果：\n\n1. 包含式设计，$N=1$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n2. 包含式设计，$N=5$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n3. 包含式设计，$N=20$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n4. 包含式设计，$N=100$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n5. 排他式设计，$N=1$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n6. 排他式设计，$N=5$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n7. 排他式设计，$N=20$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n8. 排他式设计，$N=100$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，$\\mu(t)$ 如上所述。\n9. 排他式设计，$N=5$，$T=256$，$\\sigma_a=10$ $\\mu\\text{V}$，且对于所有 $t$，$\\mu(t) = 0$（边界情况）。\n\n你的程序应生成单行输出，其中包含九个测试用例的残留伪影功率比，形式为方括号括起来的逗号分隔列表（例如 $[r_1,r_2,\\dots,r_9]$），其中每个 $r_i$ 都是一个小数。",
            "solution": "该问题被评估为有效，因为它基于信号处理原理，具有科学依据，内部一致，并且是适定的，提供了获得唯一解所需的所有信息。\n\n目标是为包含式和排他式两种平均设计推导出残留伪影功率比 $R = P_{\\text{res}} / P_{\\text{pre}}$，然后对一组给定的参数评估此比率。\n\n容积 $k$ 的伪影片段模型由下式给出：\n$$A_k(t) = \\mu(t) + \\epsilon_k(t)$$\n其中 $t \\in \\{0, 1, \\dots, T-1\\}$，$\\mu(t)$ 是一个确定性模板，而 $\\epsilon_k(t)$ 是一个随机偏差，满足 $\\mathbb{E}[\\epsilon_k(t)] = 0$ 和 $\\text{Var}(\\epsilon_k(t)) = \\sigma_a^2$。对于固定的时间 $t$，偏差 $\\{\\epsilon_k(t)\\}_{k}$ 是独立同分布的 (i.i.d.)。\n\n**步骤1：校正前功率 $P_{\\text{pre}}$ 的推导**\n每个片段的校正前功率定义为 $P_{\\text{pre}} = \\sum_{t=0}^{T-1} \\mathbb{E}[A_k(t)^2]$。\n为了求 $\\mathbb{E}[A_k(t)^2]$，我们使用关系式 $\\mathbb{E}[X^2] = \\text{Var}(X) + (\\mathbb{E}[X])^2$。\n$A_k(t)$ 的期望为：\n$$\\mathbb{E}[A_k(t)] = \\mathbb{E}[\\mu(t) + \\epsilon_k(t)] = \\mu(t) + \\mathbb{E}[\\epsilon_k(t)] = \\mu(t)$$\n$A_k(t)$ 的方差为：\n$$\\text{Var}(A_k(t)) = \\text{Var}(\\mu(t) + \\epsilon_k(t)) = \\text{Var}(\\epsilon_k(t)) = \\sigma_a^2$$\n因为 $\\mu(t)$ 是确定性的。\n因此，在时间 $t$ 的期望平方振幅是：\n$$\\mathbb{E}[A_k(t)^2] = \\text{Var}(A_k(t)) + (\\mathbb{E}[A_k(t)])^2 = \\sigma_a^2 + \\mu(t)^2$$\n对所有时间点 $t$ 从 $0$ 到 $T-1$求和：\n$$P_{\\text{pre}} = \\sum_{t=0}^{T-1} (\\mu(t)^2 + \\sigma_a^2) = \\left(\\sum_{t=0}^{T-1} \\mu(t)^2\\right) + T\\sigma_a^2$$\n令 $P_\\mu = \\sum_{t=0}^{T-1} \\mu(t)^2$ 为确定性模板的功率。\n$$P_{\\text{pre}} = P_\\mu + T\\sigma_a^2$$\n\n**步骤2：包含式设计下的残留功率 $P_{\\text{res}}^{\\text{inc}}$ 的推导**\n模板使用 $N$ 个容积进行估计，包括目标容积 $k^\\star$。令 $k^\\star$ 为 $\\{1, \\dots, N\\}$ 中的一个。\n$$\\hat{\\mu}_N^{\\text{inc}}(t) = \\frac{1}{N}\\sum_{i=1}^{N} A_i(t)$$\n目标容积 $k^\\star$ 的残差为 $R_{k^\\star}^{\\text{inc}}(t) = A_{k^\\star}(t) - \\hat{\\mu}_N^{\\text{inc}}(t)$。\n$$R_{k^\\star}^{\\text{inc}}(t) = A_{k^\\star}(t) - \\frac{1}{N}\\sum_{i=1}^{N} A_i(t) = \\left(1 - \\frac{1}{N}\\right)A_{k^\\star}(t) - \\frac{1}{N}\\sum_{i \\neq k^\\star} A_i(t)$$\n代入 $A_i(t) = \\mu(t) + \\epsilon_i(t)$：\n$$R_{k^\\star}^{\\text{inc}}(t) = \\left(1 - \\frac{1}{N}\\right)(\\mu(t) + \\epsilon_{k^\\star}(t)) - \\frac{1}{N}\\sum_{i \\neq k^\\star} (\\mu(t) + \\epsilon_i(t))$$\n包含 $\\mu(t)$ 的项相互抵消：$\\left(1 - \\frac{1}{N}\\right)\\mu(t) - \\frac{N-1}{N}\\mu(t) = 0$。\n$$R_{k^\\star}^{\\text{inc}}(t) = \\left(1 - \\frac{1}{N}\\right)\\epsilon_{k^\\star}(t) - \\frac{1}{N}\\sum_{i \\neq k^\\star} \\epsilon_i(t)$$\n由于对所有 $i$ 都有 $\\mathbb{E}[\\epsilon_i(t)] = 0$，我们得到 $\\mathbb{E}[R_{k^\\star}^{\\text{inc}}(t)] = 0$。\n在时间 $t$ 的期望平方残差即为其方差：\n$$\\mathbb{E}[(R_{k^\\star}^{\\text{inc}}(t))^2] = \\text{Var}(R_{k^\\star}^{\\text{inc}}(t))$$\n鉴于对于固定的 $t$，所有的 $\\epsilon_i(t)$ 都是独立的，我们有：\n$$\\text{Var}(R_{k^\\star}^{\\text{inc}}(t)) = \\left(1 - \\frac{1}{N}\\right)^2 \\text{Var}(\\epsilon_{k^\\star}(t)) + \\sum_{i \\neq k^\\star} \\left(-\\frac{1}{N}\\right)^2 \\text{Var}(\\epsilon_i(t))$$\n$$= \\left(\\frac{N-1}{N}\\right)^2 \\sigma_a^2 + (N-1) \\frac{1}{N^2} \\sigma_a^2 = \\frac{(N-1)^2 + (N-1)}{N^2} \\sigma_a^2 = \\frac{(N-1)N}{N^2} \\sigma_a^2 = \\frac{N-1}{N} \\sigma_a^2$$\n总残留功率是所有时间点上的总和：\n$$P_{\\text{res}}^{\\text{inc}} = \\sum_{t=0}^{T-1} \\frac{N-1}{N} \\sigma_a^2 = T\\sigma_a^2\\left(1 - \\frac{1}{N}\\right)$$\n\n**步骤3：排他式设计下的残留功率 $P_{\\text{res}}^{\\text{exc}}$ 的推导**\n模板使用不包含目标容积 $k^\\star$ 的 $N$ 个容积进行估计。\n$$\\hat{\\mu}_N^{\\text{exc}}(t) = \\frac{1}{N}\\sum_{i \\in \\mathcal{I}} A_i(t), \\quad k^\\star \\notin \\mathcal{I}$$\n残差为 $R_{k^\\star}^{\\text{exc}}(t) = A_{k^\\star}(t) - \\hat{\\mu}_N^{\\text{exc}}(t)$。\n$$R_{k^\\star}^{\\text{exc}}(t) = (\\mu(t) + \\epsilon_{k^\\star}(t)) - \\frac{1}{N}\\sum_{i \\in \\mathcal{I}} (\\mu(t) + \\epsilon_i(t))$$\n包含 $\\mu(t)$ 的项再次抵消：$\\mu(t) - \\frac{N}{N}\\mu(t) = 0$。\n$$R_{k^\\star}^{\\text{exc}}(t) = \\epsilon_{k^\\star}(t) - \\frac{1}{N}\\sum_{i \\in \\mathcal{I}} \\epsilon_i(t)$$\n和之前一样，$\\mathbb{E}[R_{k^\\star}^{\\text{exc}}(t)] = 0$，所以 $\\mathbb{E}[(R_{k^\\star}^{\\text{exc}}(t))^2] = \\text{Var}(R_{k^\\star}^{\\text{exc}}(t))$。\n因为 $k^\\star \\notin \\mathcal{I}$，所以 $\\epsilon_{k^\\star}(t)$ 与所有 $i \\in \\mathcal{I}$ 的 $\\epsilon_i(t)$ 独立。\n$$\\text{Var}(R_{k^\\star}^{\\text{exc}}(t)) = \\text{Var}(\\epsilon_{k^\\star}(t)) + \\text{Var}\\left(-\\frac{1}{N}\\sum_{i \\in \\mathcal{I}} \\epsilon_i(t)\\right) = \\sigma_a^2 + \\frac{1}{N^2} \\sum_{i \\in \\mathcal{I}} \\text{Var}(\\epsilon_i(t))$$\n$$= \\sigma_a^2 + \\frac{1}{N^2} (N \\sigma_a^2) = \\sigma_a^2\\left(1 + \\frac{1}{N}\\right)$$\n总残留功率为：\n$$P_{\\text{res}}^{\\text{exc}} = \\sum_{t=0}^{T-1} \\sigma_a^2\\left(1 + \\frac{1}{N}\\right) = T\\sigma_a^2\\left(1 + \\frac{1}{N}\\right)$$\n\n**步骤4：残留功率比 $R$ 与收敛性**\n当 $N \\to \\infty$ 时，$P_{\\text{res}}^{\\text{inc}}$ 和 $P_{\\text{res}}^{\\text{exc}}$ 都收敛于 $T\\sigma_a^2$，即噪声分量的总功率。对于有限的 $N$，包含式设计会轻微低估此残留噪声功率，而排他式设计则会高估它。\n\n比率 $R = P_{\\text{res}} / P_{\\text{pre}}$ 为：\n$$R^{\\text{inc}} = \\frac{T\\sigma_a^2(1 - 1/N)}{P_\\mu + T\\sigma_a^2}$$\n$$R^{\\text{exc}} = \\frac{T\\sigma_a^2(1 + 1/N)}{P_\\mu + T\\sigma_a^2}$$\n\n**步骤5：数值评估**\n参数为：$T=256$，$A_1=50$，$A_2=30$，$f_1=5$，$f_2=13$，$\\sigma_a=10$。这得出 $\\sigma_a^2=100$。\n首先计算模板功率 $P_\\mu$：\n$$P_\\mu = \\sum_{t=0}^{T-1} \\left( A_1 \\sin\\left(\\frac{2\\pi f_1 t}{T}\\right) + A_2 \\cos\\left(\\frac{2\\pi f_2 t}{T}\\right) \\right)^2$$\n由于对于给定的整数频率 $f_1, f_2$（其中 $f_1 \\neq f_2$ 且两者均不为 $0$ 或 $T/2$），正弦函数在区间 $[0, T-1]$ 上具有正交性，展开式中的交叉项求和为零，因此我们有：\n$$\\sum_{t=0}^{T-1} \\sin^2\\left(\\frac{2\\pi f t}{T}\\right) = \\sum_{t=0}^{T-1} \\cos^2\\left(\\frac{2\\pi f t}{T}\\right) = \\frac{T}{2}$$\n因此，$P_\\mu = A_1^2 \\frac{T}{2} + A_2^2 \\frac{T}{2} = \\frac{T}{2}(A_1^2 + A_2^2)$。\n$$P_\\mu = \\frac{256}{2}(50^2 + 30^2) = 128(2500 + 900) = 128(3400) = 435200 \\, \\mu\\text{V}^2$$\n噪声功率项为 $T\\sigma_a^2 = 256 \\times 100 = 25600 \\, \\mu\\text{V}^2$。\n总的校正前功率为 $P_{\\text{pre}} = 435200 + 25600 = 460800 \\, \\mu\\text{V}^2$。\n\n通过将分子和分母同时除以 $T$，可以简化比率公式：\n$$R = \\frac{\\sigma_a^2(1 \\pm 1/N)}{P_\\mu/T + \\sigma_a^2} = \\frac{\\sigma_a^2(1 \\pm 1/N)}{\\frac{1}{2}(A_1^2 + A_2^2) + \\sigma_a^2}$$\n分母项为 $\\frac{1}{2}(50^2 + 30^2) + 100 = 1700 + 100 = 1800$。\n通用公式变为：\n$$R^{\\text{inc}}(N) = \\frac{100(1 - 1/N)}{1800} = \\frac{1}{18}\\left(1 - \\frac{1}{N}\\right)$$\n$$R^{\\text{exc}}(N) = \\frac{100(1 + 1/N)}{1800} = \\frac{1}{18}\\left(1 + \\frac{1}{N}\\right)$$\n\n对于 $\\mu(t)=0$ 的特殊情况，$P_\\mu=0$。比率变为 $R^{\\text{exc}} = \\frac{T\\sigma_a^2(1+1/N)}{T\\sigma_a^2} = 1 + 1/N$。\n\n测试用例的计算：\n1. 包含式，$N=1$：$R = \\frac{1}{18}(1 - 1/1) = 0$\n2. 包含式，$N=5$：$R = \\frac{1}{18}(1 - 1/5) = \\frac{1}{18}(\\frac{4}{5}) = \\frac{4}{90} = \\frac{2}{45} \\approx 0.0444...$\n3. 包含式，$N=20$：$R = \\frac{1}{18}(1 - 1/20) = \\frac{1}{18}(\\frac{19}{20}) = \\frac{19}{360} \\approx 0.0527...$\n4. 包含式，$N=100$：$R = \\frac{1}{18}(1 - 1/100) = \\frac{1}{18}(\\frac{99}{100}) = \\frac{11}{200} = 0.055$\n5. 排他式，$N=1$：$R = \\frac{1}{18}(1 + 1/1) = \\frac{2}{18} = \\frac{1}{9} \\approx 0.1111...$\n6. 排他式，$N=5$：$R = \\frac{1}{18}(1 + 1/5) = \\frac{1}{18}(\\frac{6}{5}) = \\frac{6}{90} = \\frac{1}{15} \\approx 0.0666...$\n7. 排他式，$N=20$：$R = \\frac{1}{18}(1 + 1/20) = \\frac{1}{18}(\\frac{21}{20}) = \\frac{7}{120} \\approx 0.0583...$\n8. 排他式，$N=100$：$R = \\frac{1}{18}(1 + 1/100) = \\frac{101}{1800} \\approx 0.0561...$\n9. 排他式，$N=5$，$\\mu=0$：$R = 1 + 1/5 = 1.2$",
            "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the residual artifact power ratio for nine test cases based on\n    a model of EEG-fMRI artifacts.\n    \"\"\"\n    # Define the constants from the problem statement\n    A1 = 50.0  # microV\n    A2 = 30.0  # microV\n    sigma_a = 10.0 # microV\n\n    # Define the test cases from the problem statement\n    test_cases = [\n        # (design, N, mu_is_zero)\n        ('inclusive', 1, False),\n        ('inclusive', 5, False),\n        ('inclusive', 20, False),\n        ('inclusive', 100, False),\n        ('exclusive', 1, False),\n        ('exclusive', 5, False),\n        ('exclusive', 20, False),\n        ('exclusive', 100, False),\n        ('exclusive', 5, True),\n    ]\n\n    results = []\n\n    # Pre-calculate squared terms for efficiency and clarity\n    sigma_a_sq = sigma_a**2\n    A1_sq = A1**2\n    A2_sq = A2**2\n\n    # The denominator of the ratio R can be simplified from the full power expressions.\n    # The full ratio is R = (T*sigma_a^2 * F(N)) / (P_mu + T*sigma_a^2), where\n    # P_mu = T/2 * (A1^2 + A2^2).\n    # Dividing by T simplifies the ratio to R = (sigma_a^2 * F(N)) / (1/2*(A1^2+A2^2) + sigma_a^2).\n    # This avoids large numbers and dependence on T.\n    denominator_term_mu_present = 0.5 * (A1_sq + A2_sq) + sigma_a_sq\n\n    for design, N, mu_is_zero in test_cases:\n        if mu_is_zero:\n            # Special case 9: mu(t) = 0 for all t.\n            # R = (T*sigma_a^2 * (1 + 1/N)) / (0 + T*sigma_a^2) = 1 + 1/N\n            # This applies to the exclusive design as specified in the test case.\n            if design == 'exclusive':\n                R = 1.0 + 1.0 / N\n            else: # For completeness, if the design were inclusive\n                R = 1.0 - 1.0 / N\n        else:\n            # Cases 1-8 where mu(t) is defined by the sinusoidal formula\n            if design == 'inclusive':\n                # R_inc = (sigma_a^2 * (1 - 1/N)) / (1/2*(A1^2+A2^2) + sigma_a^2)\n                numerator = sigma_a_sq * (1.0 - 1.0 / N)\n                R = numerator / denominator_term_mu_present\n            elif design == 'exclusive':\n                # R_exc = (sigma_a^2 * (1 + 1/N)) / (1/2*(A1^2+A2^2) + sigma_a^2)\n                numerator = sigma_a_sq * (1.0 + 1.0 / N)\n                R = numerator / denominator_term_mu_present\n        \n        results.append(R)\n\n    # Format the output as a comma-separated list enclosed in square brackets.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```"
        },
        {
            "introduction": "在伪影校正之后，下一步是从EEG数据中提取有意义的特征，以便与BOLD信号相关联。为了将EEG频谱功率的动态变化（例如alpha或beta波段活动）与fMRI数据关联起来，EEG的分析窗口必须与fMRI缓慢得多的采样率（TR）在时间上兼容。本练习 () 聚焦于如何设计一个韦尔奇（Welch）功率谱估计器，其参数（如段长度和重叠率）需要与fMRI的TR同步，通过这项实践，您将掌握在多模态数据融合中协调不同时间尺度的关键技能。",
            "id": "4179418",
            "problem": "在一次同步脑电图 (EEG) 和功能性磁共振成像 (fMRI) 实验中，记录了单通道脑电图时间序列 $x[n]$ (单位: $\\mu\\mathrm{V}$)，与 fMRI 同步采集。EEG 采样率为 $f_{s} = 500$ Hz，总记录时长为 $T = 256$ s，因此总样本数为 $N = T f_{s}$。fMRI 的重复时间 (TR) 为 $\\mathrm{TR} = 2$ s。为了确保 EEG 频谱分析与 fMRI 采样在时间上兼容，您需要使用 Welch 方法估计 $x[n]$ 在频率区间 $[8,12)$ Hz 内的 alpha 波段功率，该方法的段边界需遵循 fMRI 的 TR。\n\n从功率谱密度 (PSD) 作为宽平穩离散时间过程自相关函数的傅里叶变换的定义，以及周期图作为有限长度傅里叶变换的幅值平方的定义出发，推导一个 Welch 波段功率估计器，该估计器：\n- 每段使用整数个 TR，使得段长度 $L$ (以样本数计) 满足 $L = q \\, f_{s} \\, \\mathrm{TR}$，其中 $q$ 为某个整数且 $q \\geq 1$，\n- 使用周期性汉宁窗 $w[n] = \\tfrac{1}{2} - \\tfrac{1}{2}\\cos\\!\\left(\\tfrac{2\\pi n}{L}\\right)$, $0 \\leq n \\leq L-1$，\n- 相邻段之间使用 $50\\%$ 的重叠，\n- 并且在对波段进行积分之前，对各段的修正周期图进行平均，以生成单边 PSD 估计。\n\n为了在保持平稳性的同时减小估计器方差，要求至少有 $M \\geq 15$ 个段。在 $50\\%$ 重叠的条件下，选择满足此要求的最大整数 $q$。然后，使用这个 $q$ 值，计算相应的段长度 $L$、跳跃尺寸 $D$ (以样本数计)、段数 $M$、离散频率仓宽度 $\\Delta f$ 以及离散频率索引集合 $\\mathcal{K} = \\{k : 8 \\le f_{k}  12\\}$，其中 $f_{k} = k \\Delta f$。令 $x_{r}[n]$表示第 $r$ 个加窗段，$X_{r}[k]$为其 $L$ 点离散傅里叶变换，定义为\n$$\nX_{r}[k] \\equiv \\sum_{n=0}^{L-1} w[n] \\, x_{r}[n] \\, \\exp\\!\\left(-j \\tfrac{2\\pi k n}{L}\\right), \\quad k = 0,1,\\dots,L-1.\n$$\n根据适用于实值信号 $x[n]$ 的单边 PSD 约定（即所有内部正频率仓的值加倍），并使用精确的窗功率归一化 $U \\equiv \\tfrac{1}{L}\\sum_{n=0}^{L-1} w^{2}[n]$，推导 Welch alpha 波段功率估计器 $\\widehat{P}_{[8,12)}$ 作为 $\\{X_{r}[k]\\}$ 的函数的闭式解析表达式，单位为平方微伏。用一个具有完全简化的数值常数和明确求和界限的显式双重求和来表示你的最终答案。\n\n最终结果以 $\\mu\\mathrm{V}^{2}$ 表示。不要在方框答案中包含单位。",
            "solution": "该问题要求针对一个 EEG 时间序列，在同步 fMRI 采集施加的约束条件下，推导 Welch alpha 波段功率估计器的解析表达式。推导将分三步进行：首先，根据给定约束确定信号处理参数；其次，推导 Welch 波段功率估计器的一般公式；第三，代入计算出的参数以获得最终的显式表达式。\n\n**1. 确定信号处理参数**\n\n给定参数如下：\n- EEG 采样率: $f_s = 500 \\, \\mathrm{Hz}$\n- 总记录时长: $T = 256 \\, \\mathrm{s}$\n- fMRI 重复时间: $\\mathrm{TR} = 2 \\, \\mathrm{s}$\n- alpha 波段: $[8, 12) \\, \\mathrm{Hz}$\n\nEEG 时间序列中的总样本数为 $N = f_s T = (500 \\, \\mathrm{Hz})(256 \\, \\mathrm{s}) = 128000$ 个样本。\n\n段长度 $L$ 被约束为一个 TR 内样本数的整数倍 $q$：\n$L = q \\cdot f_s \\cdot \\mathrm{TR} = q \\cdot (500) \\cdot (2) = 1000q$ 个样本，其中 $q$ 为某个整数且 $q \\ge 1$。\n\n各段之间有 $50\\%$ 的重叠，所以跳跃尺寸 $D$（连续段起始点之间的距离）为：\n$D = L \\cdot (1 - 0.5) = \\frac{L}{2} = \\frac{1000q}{2} = 500q$ 个样本。\n\n从长度为 $N$ 的信号中，以段长度 $L$ 和跳跃尺寸 $D$ 可提取的段数 $M$ 由公式 $M = \\lfloor \\frac{N-L}{D} \\rfloor + 1$ 给出。代入 $N$、$L$ 和 $D$ 的表达式：\n$$\nM = \\left\\lfloor \\frac{128000 - 1000q}{500q} \\right\\rfloor + 1 = \\left\\lfloor \\frac{256}{q} - 2 \\right\\rfloor + 1\n$$\n由于 $q$ 是整数，$2$ 也是整数，所以 $\\lfloor \\frac{256}{q} - 2 \\rfloor = \\lfloor \\frac{256}{q} \\rfloor - 2$。\n$$\nM = \\left\\lfloor \\frac{256}{q} \\right\\rfloor - 2 + 1 = \\left\\lfloor \\frac{256}{q} \\right\\rfloor - 1\n$$\n\n问题要求至少有 $M \\ge 15$ 个段，并要求找出满足此条件的最大整数 $q$。\n$$\n\\left\\lfloor \\frac{256}{q} \\right\\rfloor - 1 \\ge 15 \\implies \\left\\lfloor \\frac{256}{q} \\right\\rfloor \\ge 16\n$$\n由于 $q$ 必须是整数，该不等式成立当且仅当 $\\frac{256}{q} \\ge 16$。求解 $q$：\n$$\nq \\le \\frac{256}{16} \\implies q \\le 16\n$$\n满足条件的最大整数 $q$ 是 $q=16$。我们现在用这个值来确定最终的参数：\n- 段长度: $L = 1000 \\cdot 16 = 16000$ 个样本。\n- 跳跃尺寸: $D = 500 \\cdot 16 = 8000$ 个样本。\n- 段数: $M = \\lfloor \\frac{256}{16} \\rfloor - 1 = 16 - 1 = 15$。\n- 频率分辨率 (频率仓宽度): $\\Delta f = \\frac{f_s}{L} = \\frac{500}{16000} = \\frac{1}{32} \\, \\mathrm{Hz}$。\n\n离散频率由 $f_k = k \\cdot \\Delta f = \\frac{k}{32}$ 给出。我们需要找到整数索引集合 $\\mathcal{K}$，使得 $8 \\le f_k  12$。\n- 下界: $8 \\le \\frac{k}{32} \\implies k \\ge 8 \\cdot 32 = 256$。\n- 上界: $\\frac{k}{32}  12 \\implies k  12 \\cdot 32 = 384$。\n因此，alpha 波段的频率索引集合是 $\\mathcal{K} = \\{k \\in \\mathbb{Z} \\mid 256 \\le k  384\\}$。\n\n**2. 波段功率估计器公式的推导**\n\n使用 Welch 方法的功率谱密度 (PSD) 估计是所有段的修正周期图的平均值。第 $r$ 段的修正周期图 $\\widehat{P}^{(r)}_{xx}(f_k)$ 必须进行适当的归一化。\n\n令 $X_r[k]$ 为第 $r$ 个加窗段的 $L$ 点 DFT。对于一个实值信号 $x[n]$，在正频率 $f_k$ (其中 $0  k  L/2$) 处的单边 PSD 估计由下式给出：\n$$\n\\widehat{P}_{xx}(f_k) = \\frac{2}{M} \\sum_{r=0}^{M-1} \\frac{1}{f_s L U} |X_r[k]|^2\n$$\n此表达式提供了单位频率的功率（单位为 $\\mu\\mathrm{V}^2/\\mathrm{Hz}$）。因子 $U$ 是窗归一化常数，定义为窗样本平方的均值：$U = \\frac{1}{L} \\sum_{n=0}^{L-1} w^2[n]$。因子 $2$ 是为了解释单边谱中从负频率折叠到正频率的功率。\n\n波段功率 $\\widehat{P}_{[8,12)}$ 是 PSD 在该频率区间上的积分。对于离散谱，这个积分通过对波段内每个频率仓的功率求和来近似。单个频率仓 $k$ 中的功率是该仓频率处的 PSD 值 $\\widehat{P}_{xx}(f_k)$ 乘以频率仓宽度 $\\Delta f$。\n$$\n\\widehat{P}_{[8,12)} = \\sum_{k \\in \\mathcal{K}} \\widehat{P}_{xx}(f_k) \\Delta f\n$$\n代入 $\\widehat{P}_{xx}(f_k)$ 和 $\\Delta f = f_s/L$ 的表达式：\n$$\n\\widehat{P}_{[8,12)} = \\sum_{k \\in \\mathcal{K}} \\left( \\frac{2}{M f_s L U} \\sum_{r=0}^{M-1} |X_r[k]|^2 \\right) \\left( \\frac{f_s}{L} \\right)\n$$\n$f_s$ 项相互抵消，我们可以重新排列求和顺序：\n$$\n\\widehat{P}_{[8,12)} = \\frac{2}{M L^2 U} \\sum_{r=0}^{M-1} \\sum_{k \\in \\mathcal{K}} |X_r[k]|^2\n$$\n此表达式给出了波段内的总功率，单位为 $\\mu\\mathrm{V}^2$，符合要求。\n\n**3. 常数计算与最终表达式**\n\n我们需要计算周期性汉宁窗 $w[n] = \\frac{1}{2} - \\frac{1}{2}\\cos(\\frac{2\\pi n}{L})$ 的归一化常数 $U$。\n$$\nU = \\frac{1}{L} \\sum_{n=0}^{L-1} w^2[n] = \\frac{1}{L} \\sum_{n=0}^{L-1} \\left( \\frac{1}{4} - \\frac{1}{2}\\cos\\left(\\frac{2\\pi n}{L}\\right) + \\frac{1}{4}\\cos^2\\left(\\frac{2\\pi n}{L}\\right) \\right)\n$$\n使用恒等式 $\\cos^2(\\theta) = \\frac{1}{2}(1+\\cos(2\\theta))$：\n$$\nU = \\frac{1}{L} \\sum_{n=0}^{L-1} \\left( \\frac{1}{4} - \\frac{1}{2}\\cos\\left(\\frac{2\\pi n}{L}\\right) + \\frac{1}{8}\\left(1+\\cos\\left(\\frac{4\\pi n}{L}\\right)\\right) \\right) \\\\\n= \\frac{1}{L} \\sum_{n=0}^{L-1} \\left( \\frac{3}{8} - \\frac{1}{2}\\cos\\left(\\frac{2\\pi n}{L}\\right) + \\frac{1}{8}\\cos\\left(\\frac{4\\pi n}{L}\\right) \\right)\n$$\n对于整数 $m \\ne 0$，余弦函数在一个整数个完整周期上的和为零：$\\sum_{n=0}^{L-1} \\cos(\\frac{2\\pi m n}{L}) = 0$。因此，关于余弦项的求和为零。\n$$\nU = \\frac{1}{L} \\sum_{n=0}^{L-1} \\frac{3}{8} = \\frac{1}{L} \\left( L \\cdot \\frac{3}{8} \\right) = \\frac{3}{8}\n$$\n现在我们使用 $M=15$、$L=16000$ 和 $U=3/8$ 来计算总的缩放系数 $\\frac{2}{M L^2 U}$：\n$$\n\\frac{2}{M L^2 U} = \\frac{2}{15 \\cdot (16000)^2 \\cdot \\frac{3}{8}} = \\frac{16}{15 \\cdot 3 \\cdot (16000)^2} = \\frac{16}{45 \\cdot (16 \\times 10^3)^2}\n$$\n$$\n= \\frac{16}{45 \\cdot 16^2 \\cdot 10^6} = \\frac{1}{45 \\cdot 16 \\cdot 10^6} = \\frac{1}{720 \\cdot 10^6} = \\frac{1}{7.2 \\times 10^8}\n$$\n最后，将系数以及 $r$ 和 $k$ 的显式求和界限代入波段功率公式，得到估计器的最终表达式：\n$$\n\\widehat{P}_{[8,12)} = \\frac{1}{7.2 \\times 10^8} \\sum_{r=0}^{14} \\sum_{k=256}^{383} |X_r[k]|^2\n$$\n该表达式提供了 alpha 波段的估计功率，单位为 $\\mu\\mathrm{V}^2$，是加窗数据段的 DFT 的函数。",
            "answer": "$$\n\\boxed{\\frac{1}{7.2 \\times 10^8} \\sum_{r=0}^{14} \\sum_{k=256}^{383} |X_r[k]|^2}\n$$"
        },
        {
            "introduction": "在数据准备和时间对齐完成后，我们便可以执行真正的整合分析，将快速的神经电活动与缓慢的血流动力学信号联系起来。一种强大的方法是“EEG信息引导的fMRI分析”，即利用高时间分辨率的EEG事件来为fMRI的通用线性模型（GLM）构建回归量。在这个综合性练习中 ()，您将构建一个完整的分析流程：从EEG数据中识别微状态，基于其出现时间创建事件序列，然后与血流动力学响应函数（HRF）进行卷积，最终生成用于fMRI GLM分析的回归量。这项实践完美展示了如何利用EEG的快速动态信息来解释fMRI中较慢的血流动力学变化，体现了多模态融合的真正威力。",
            "id": "4179375",
            "problem": "给定一项正式任务，要求您使用脑电图（EEG）微状态信息，为功能性磁共振成像（fMRI）的通用线性模型（GLM）构建事件相关回归量。假设您具备以下信号处理和多模态融合的基础知识：向量间的离散空间相关性、指示函数、用于事件编码的离散时间脉冲序列、双伽马血流动力学响应函数（HRF）以及线性时不变卷积。您必须通过以下步骤计算特定于微状态的事件函数：基于与模板图的最大空间相关性，将每个EEG时间样本分配给单个微状态；然后将这些事件函数与一个标准的HRF进行卷积；最后在fMRI的重复时间（TR）对卷积后的信号进行采样以生成回归量。最终输出必须是一行字符串，其中包含所有测试用例的回归量，并严格遵循下述格式。\n\n定义和必要步骤：\n- 令 $X \\in \\mathbb{R}^{T \\times M}$ 为EEG头皮电位矩阵，包含 $T$ 个离散时间样本和 $M$ 个通道，采样频率为 $f_{\\mathrm{EEG}}$（单位 $\\mathrm{Hz}$），采样周期为 $dt = 1 / f_{\\mathrm{EEG}}$（单位 $\\mathrm{s}$）。令 $G \\in \\mathbb{R}^{K \\times M}$ 为 $K$ 个微状态模板图。\n- 对于每个时间样本 $t \\in \\{0,1,\\dots,T-1\\}$，通过减去其均值来定义均值中心化的EEG图 $\\tilde{x}_t \\in \\mathbb{R}^M$。对于每个模板 $k \\in \\{1,\\dots,K\\}$，通过减去其均值来定义均值中心化的模板 $\\tilde{g}_k \\in \\mathbb{R}^M$。计算空间相关性\n$$\nr_k(t) \\;=\\; \\frac{\\langle \\tilde{x}_t, \\tilde{g}_k \\rangle}{\\|\\tilde{x}_t\\|_2 \\, \\|\\tilde{g}_k\\|_2} \\, ,\n$$\n并通过下式分配微状态标签\n$$\n\\hat{z}(t) \\;=\\; \\underset{k \\in \\{1,\\dots,K\\}}{\\arg\\max}\\; r_k(t) \\, .\n$$\n将每个微状态 $k$ 的指示时间序列定义为\n$$\ns_k(t) \\;=\\; \\mathbb{I}\\big[\\hat{z}(t) = k\\big] \\, .\n$$\n- 令一个事件相关范式由EEG采样网格上的脉冲序列 $e(t)$ 编码，其定义为在事件索引 $t_j = \\lfloor \\tau_j / dt \\rfloor$ 处 $e(t_j) = 1$，其中 $\\tau_j$ 是以 $\\mathrm{s}$ 为单位的事件时间，在其他时间点 $e(t) = 0$。如果事件时间映射超出了最后一个EEG样本，则将其限制在 $t = T-1$。构建特定于微状态的事件函数\n$$\nu_k(t) \\;=\\; s_k(t) \\cdot e(t) \\, .\n$$\n- 使用一个在EEG网格上采样的标准双伽马血流动力学响应函数，其参数为 $\\alpha_1 = 6$, $\\beta_1 = 1$, $\\alpha_2 = 16$, $\\beta_2 = 1$, 和 $c = 1/6$。定义，对于 $t \\ge 0$：\n$$\n\\mathrm{GammaPDF}(t;\\alpha,\\beta) \\;=\\; \\frac{t^{\\alpha-1}\\, e^{-t/\\beta}}{\\beta^{\\alpha}\\, \\Gamma(\\alpha)} \\, ,\n$$\n和\n$$\nh(t) \\;=\\; \\mathrm{GammaPDF}(t;\\alpha_1,\\beta_1) \\;-\\; c \\cdot \\mathrm{GammaPDF}(t;\\alpha_2,\\beta_2) \\, .\n$$\n在 $t = 0, dt, 2dt, \\dots, L_{\\mathrm{HRF}}$ 上对 $h(t)$ 进行采样，其中 $L_{\\mathrm{HRF}} = 32$（单位 $\\mathrm{s}$）。通过强制 $\\sum_{m} h[m] \\cdot dt = 1$ 将 $h$ 归一化至单位面积。\n- 在离散时间内将每个 $u_k$ 与 $h$ 进行卷积得到 $c_k = u_k * h$，使用完全卷积。令fMRI的重复时间为 $TR$（单位 $\\mathrm{s}$），体（volume）的数量为 $N_{\\mathrm{vol}}$。在 $t_n = n \\cdot TR$（其中 $n \\in \\{0,1,\\dots,N_{\\mathrm{vol}}-1\\}$）处对卷积信号进行采样，通过最近向下取整索引 $y_k[n] = c_k[\\lfloor t_n / dt \\rfloor]$，前提是该索引在完全卷积的边界内；如果索引超出长度，则限制到最后一个可用索引。\n- 将每个回归量 $y_k$ 归一化为单位 $\\ell_2$ 范数，前提是其范数不为零；否则保持其为零向量。\n\n单位：所有时间量必须以 $\\mathrm{s}$（秒）为单位。不使用角度。不使用百分比。\n\n您的程序必须为以下测试套件精确实现上述定义。每个测试用例指定了 $(M,K,f_{\\mathrm{EEG}},TR,N_{\\mathrm{vol}},T,\\text{events},G,\\text{EEG generation})$。对于EEG生成，通过选择指定的微状态模板并添加具有给定标准差的独立高斯噪声来构建 $X$，使用提供的随机种子；即，对于与微状态 $k$ 相关的分段中的每个时间 $t$，设置 $x_{t} = g_k + \\epsilon_t$ 且 $\\epsilon_t \\sim \\mathcal{N}(0,\\sigma^2 I_M)$，然后在进行相关性计算之前进行均值中心化。所有模板图在使用前都必须进行均值中心化和 $\\ell_2$ 范数归一化。\n\n测试用例 1 (正常路径):\n- $M = 4$, $K = 4$, $f_{\\mathrm{EEG}} = 250$, $TR = 1$, $N_{\\mathrm{vol}} = 4$, $T = 1000$.\n- 事件时间 $\\tau = [0.5, 1.5, 2.5, 3.5]$.\n- 模板 $G$（均值中心化和归一化之前）：\n  $g_1 = [1, -1, 1, -1]$, $g_2 = [1, 1, -1, -1]$, $g_3 = [1, -1, -1, 1]$, $g_4 = [-1, 1, -1, 1]$.\n- EEG生成：分段 $[0,249] \\rightarrow k=1$, $[250,499] \\rightarrow k=2$, $[500,749] \\rightarrow k=3$, $[750,999] \\rightarrow k=4$；高斯噪声标准差 $\\sigma = 0.05$，随机种子 $42$。\n\n测试用例 2 (边界长度):\n- $M = 3$, $K = 3$, $f_{\\mathrm{EEG}} = 100$, $TR = 0.6$, $N_{\\mathrm{vol}} = 3$, $T = 120$.\n- 事件时间 $\\tau = [0.2, 0.8, 1.1]$.\n- 模板 $G$（均值中心化和归一化之前）：\n  $g_1 = [1, -1, 0]$, $g_2 = [-1, 1, 0]$, $g_3 = [0, 1, -1]$.\n- EEG生成：分段 $[0,39] \\rightarrow k=1$, $[40,79] \\rightarrow k=2$, $[80,119] \\rightarrow k=3$；高斯噪声标准差 $\\sigma = 0.05$，随机种子 $7$。\n\n测试用例 3 (边界事件):\n- $M = 2$, $K = 2$, $f_{\\mathrm{EEG}} = 200$, $TR = 0.75$, $N_{\\mathrm{vol}} = 4$, $T = 600$.\n- 事件时间 $\\tau = [0.0, 1.5, 3.0]$.\n- 模板 $G$（均值中心化和归一化之前）：\n  $g_1 = [1, -1]$, $g_2 = [-1, 1]$.\n- EEG生成：分段 $[0,299] \\rightarrow k=1$, $[300,599] \\rightarrow k=2$；高斯噪声标准差 $\\sigma = 0.02$，随机种子 $123$。\n\n最终输出格式要求：\n- 您的程序应生成单行输出，其中包含所有测试用例的回归量，其结构为测试用例的列表，每个测试用例是包含 $K$ 个长度为 $N_{\\mathrm{vol}}$ 的列表（在TR处采样的微状态回归量），且不含空格。例如，外部结构应如下所示\n$[[$reg\\_case1$],[ $reg\\_case2$],[ $reg\\_case3$]]$, 其中每个 $reg\\_case$ 本身是 $[y_1,y_2,\\dots,y_K]$，每个 $y_k$ 是一个长度为 $N_{\\mathrm{vol}}$ 的浮点数列表。打印的字符串在任何地方都不能包含空格。",
            "solution": "问题陈述已经过严格验证，被认为是有效的。它科学地基于脑电图-功能磁共振成像（EEG-fMRI）整合的既定原则，定义和参数完整一致，表述客观、形式化，是一个适定问题。任务是构建受EEG微状态动态调制的fMRI通用线性模型（GLM）回归量，这是神经影像数据分析中一种公认的先验方法。该问题是一个非平凡、多步骤的计算任务，其规定完整且计算上可行。我们将继续提供详细的解决方案。\n\n该解决方案遵循问题陈述中指定的步骤顺序实现。\n\n**1. 血流动力学响应函数（HRF）的生成**\n标准的双伽马血流动力学响应函数 $h(t)$，对于 $t \\ge 0$ 定义为两个伽马概率密度函数之差。伽马概率密度函数由下式给出：\n$$\n\\mathrm{GammaPDF}(t;\\alpha,\\beta) = \\frac{t^{\\alpha-1}\\, e^{-t/\\beta}}{\\beta^{\\alpha}\\, \\Gamma(\\alpha)}\n$$\n其中 $\\Gamma(\\alpha)$ 是伽马函数。HRF则为：\n$$\nh(t) = \\mathrm{GammaPDF}(t;\\alpha_1,\\beta_1) - c \\cdot \\mathrm{GammaPDF}(t;\\alpha_2,\\beta_2)\n$$\n提供的参数为 $\\alpha_1 = 6$, $\\beta_1 = 1$, $\\alpha_2 = 16$, $\\beta_2 = 1$, 和 $c = 1/6$。\n\n这个连续函数在EEG采样周期 $dt = 1/f_{\\mathrm{EEG}}$ 上进行采样，采样时长为 $L_{\\mathrm{HRF}} = 32$ s。得到的离散时间序列，我们称之为 $h_{samp}$，然后被归一化以具有单位面积，这在离散域中对应于确保其黎曼和近似于积分值1：\n$$\n\\sum_{i} h_{samp}[i] \\cdot dt = 1\n$$\n这通过将采样向量 $h_{samp}$ 除以其元素总和与 $dt$ 的乘积来实现。得到的向量 $h$ 用作卷积核。\n\n**2. 模板预处理与EEG数据生成**\n提供的微状态模板图 $G \\in \\mathbb{R}^{K \\times M}$ 首先进行预处理。对于每个原始模板向量 $g_{k,raw}$，我们计算其均值中心化版本 $g'_k$，然后将其归一化为单位 $\\ell_2$ 范数。\n$$\ng'_k = g_{k,raw} - \\text{mean}(g_{k,raw})\n$$\n$$\ng_k = \\frac{g'_k}{\\|g'_k\\|_2}\n$$\n这些处理后的模板 $g_k$ 用于两个目的：生成合成的EEG数据和后续的相关性分析。\n\nEEG数据矩阵 $X \\in \\mathbb{R}^{T \\times M}$ 是基于分段恒定的微状态序列合成的。对于每个时间样本 $t$，如果它落入分配给微状态 $k$ 的分段内，则相应的EEG头皮图 $x_t$ 通过取用处理后的模板 $g_k$ 并添加独立的高斯噪声来生成：\n$$\nx_t = g_k + \\epsilon_t \\quad \\text{where} \\quad \\epsilon_t \\sim \\mathcal{N}(0, \\sigma^2 I_M)\n$$\n指定的随机种子确保了可复现性。\n\n**3. 微状态分配**\n通过将每个时间点 $t$ 分配给 $K$ 个微状态中的一个来对生成的EEG时间序列进行标记。这是通过找到与EEG图 $x_t$ 具有最高空间相关性的模板图 $g_k$ 来实现的。空间相关性 $r_k(t)$ 计算为均值中心化的EEG图 $\\tilde{x}_t$ 和均值中心化的模板图 $\\tilde{g}_k$ 之间的余弦相似度。\n$$\n\\tilde{x}_t = x_t - \\text{mean}(x_t) \\quad , \\quad \\tilde{g}_k = g_k - \\text{mean}(g_k)\n$$\n由于模板 $g_k$ 在预处理期间已经进行了均值中心化，因此 $\\tilde{g}_k = g_k$。相关性为：\n$$\nr_k(t) = \\frac{\\langle \\tilde{x}_t, \\tilde{g}_k \\rangle}{\\|\\tilde{x}_t\\|_2 \\, \\|\\tilde{g}_k\\|_2}\n$$\n时间 $t$ 的微状态标签，表示为 $\\hat{z}(t)$，是具有最大相关性的模板索引：\n$$\n\\hat{z}(t) = \\underset{k \\in \\{1,\\dots,K\\}}{\\arg\\max}\\; r_k(t)\n$$\n\n**4. 特定于微状态的事件函数构建**\n首先，在EEG时间网格上创建一个脉冲序列 $e(t)$ 来表示实验事件的时间。对于每个事件时间 $\\tau_j$（秒），在对应的离散时间索引 $t_j = \\lfloor \\tau_j / dt \\rfloor$ 处放置一个脉冲。如果索引落在有效范围 $[0, T-1]$ 之外，则将其限制在最近的边界。\n$$\ne(t) = \\begin{cases} 1  \\text{if } t = \\min(\\lfloor \\tau_j / dt \\rfloor, T-1) \\text{ for some } j \\\\ 0  \\text{otherwise} \\end{cases}\n$$\n接着，为每个微状态 $k$ 定义一个指示时间序列 $s_k(t)$，如果在时间 $t$ 分配的标签是 $k$，则其值为1，否则为0：\n$$\ns_k(t) = \\mathbb{I}\\big[\\hat{z}(t) = k\\big]\n$$\n特定于微状态的事件函数 $u_k(t)$ 随后是该指示序列和事件脉冲序列的逐元素乘积。此函数仅标记在微状态 $k$ 激活期间发生的那些事件。\n$$\nu_k(t) = s_k(t) \\cdot e(t)\n$$\n\n**5. 卷积与降采样**\n每个特定于微状态的事件函数 $u_k(t)$ 与归一化后的HRF核 $h$ 进行卷积，以模拟预期的BOLD信号。使用‘完全’卷积：\n$$\nc_k = u_k * h\n$$\n得到的连续时间信号代理 $c_k(t)$ 在fMRI采集时间点进行采样。这些时间点由 $t_n = n \\cdot TR$ 给出，对应每个fMRI体 $n \\in \\{0, 1, \\dots, N_{\\mathrm{vol}}-1\\}$。采样是通过在EEG时间网格上取卷积信号在最近的向下取整索引处的值来执行的：\n$$\ny'_k[n] = c_k[\\lfloor n \\cdot TR / dt \\rfloor]\n$$\n应用索引限制规则：如果 $\\lfloor n \\cdot TR / dt \\rfloor$ 超过了卷积信号 $c_k$ 的长度，则使用 $c_k$ 的最后一个值。\n\n**6. 最终回归量归一化**\n作为最后一步，每个采样得到的回归量向量 $y'_k$ 被归一化为单位 $\\ell_2$ 范数。这是GLM分析中的常见做法，以确保回归量的尺度不会影响其对应贝塔系数的估计。如果一个回归量向量全为零（即其范数为零），则保持不变。\n$$\ny_k = \\begin{cases} \\frac{y'_k}{\\|y'_k\\|_2}  \\text{if } \\|y'_k\\|_2 > 0 \\\\ y'_k  \\text{if } \\|y'_k\\|_2 = 0 \\end{cases}\n$$\n这些向量 $y_k$ 就是最终的fMRI回归量。对每个测试用例重复此过程，并汇总结果。",
            "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy.special import gamma as gamma_func\n\ndef solve():\n    \"\"\"\n    Main function to solve the problem for all test cases.\n    \"\"\"\n    \n    test_cases = [\n        {\n            \"M\": 4, \"K\": 4, \"f_EEG\": 250, \"TR\": 1, \"N_vol\": 4, \"T\": 1000,\n            \"events\": [0.5, 1.5, 2.5, 3.5],\n            \"templates_raw\": np.array([\n                [1, -1, 1, -1], [1, 1, -1, -1],\n                [1, -1, -1, 1], [-1, 1, -1, 1]\n            ], dtype=float),\n            \"eeg_gen\": {\n                \"segments\": [\n                    (0, 249, 0), (250, 499, 1),\n                    (500, 749, 2), (750, 999, 3)\n                ],\n                \"sigma\": 0.05,\n                \"seed\": 42\n            }\n        },\n        {\n            \"M\": 3, \"K\": 3, \"f_EEG\": 100, \"TR\": 0.6, \"N_vol\": 3, \"T\": 120,\n            \"events\": [0.2, 0.8, 1.1],\n            \"templates_raw\": np.array([\n                [1, -1, 0], [-1, 1, 0], [0, 1, -1]\n            ], dtype=float),\n            \"eeg_gen\": {\n                \"segments\": [\n                    (0, 39, 0), (40, 79, 1), (80, 119, 2)\n                ],\n                \"sigma\": 0.05,\n                \"seed\": 7\n            }\n        },\n        {\n            \"M\": 2, \"K\": 2, \"f_EEG\": 200, \"TR\": 0.75, \"N_vol\": 4, \"T\": 600,\n            \"events\": [0.0, 1.5, 3.0],\n            \"templates_raw\": np.array([\n                [1, -1], [-1, 1]\n            ], dtype=float),\n            \"eeg_gen\": {\n                \"segments\": [\n                    (0, 299, 0), (300, 599, 1)\n                ],\n                \"sigma\": 0.02,\n                \"seed\": 123\n            }\n        }\n    ]\n\n    all_results = []\n    \n    for case in test_cases:\n        case_results = run_case(case)\n        all_results.append(case_results)\n    \n    # Custom formatter to produce a JSON-like string with no spaces\n    def format_no_space(obj):\n        if isinstance(obj, list) or isinstance(obj, tuple):\n            return '[' + ','.join(format_no_space(item) for item in obj) + ']'\n        elif isinstance(obj, np.ndarray):\n            return format_no_space(obj.tolist())\n        else:\n            return str(obj)\n\n    print(format_no_space(all_results))\n\ndef run_case(params):\n    \"\"\"\n    Processes a single test case.\n    \"\"\"\n    M, K, f_EEG, TR, N_vol, T = params[\"M\"], params[\"K\"], params[\"f_EEG\"], params[\"TR\"], params[\"N_vol\"], params[\"T\"]\n    event_times = params[\"events\"]\n    templates_raw = params[\"templates_raw\"]\n    eeg_gen = params[\"eeg_gen\"]\n    \n    dt = 1.0 / f_EEG\n\n    # 1. HRF Generation\n    def gamma_pdf(t, alpha, beta):\n        return (t**(alpha - 1) * np.exp(-t / beta)) / (beta**alpha * gamma_func(alpha))\n\n    L_HRF = 32\n    hrf_t = np.arange(0, L_HRF + dt, dt)\n    h_sampled = gamma_pdf(hrf_t, 6, 1) - (1/6) * gamma_pdf(hrf_t, 16, 1)\n    \n    h_norm_factor = np.sum(h_sampled) * dt\n    h = h_sampled / h_norm_factor if h_norm_factor != 0 else h_sampled\n\n    # 2. Template Pre-processing\n    templates = np.zeros_like(templates_raw)\n    for i in range(K):\n        g_raw = templates_raw[i]\n        g_mean_centered = g_raw - np.mean(g_raw)\n        norm = np.linalg.norm(g_mean_centered)\n        templates[i] = g_mean_centered / norm if norm  0 else g_mean_centered\n\n    # 3. EEG Data Generation\n    np.random.seed(eeg_gen[\"seed\"])\n    X = np.zeros((T, M))\n    for start, end, k_idx in eeg_gen[\"segments\"]:\n        num_samples = end - start + 1\n        noise = np.random.normal(0, eeg_gen[\"sigma\"], size=(num_samples, M))\n        X[start:end+1, :] = templates[k_idx] + noise\n\n    # 4. Microstate Assignment\n    z_hat = np.zeros(T, dtype=int)\n    g_tilde = templates # templates are already mean-centered and norm=1\n    g_tilde_norms = np.linalg.norm(g_tilde, axis=1)\n\n    for t in range(T):\n        x_t = X[t, :]\n        x_t_tilde = x_t - np.mean(x_t)\n        x_t_tilde_norm = np.linalg.norm(x_t_tilde)\n        \n        if x_t_tilde_norm == 0:\n            z_hat[t] = 0 # Default assignment if signal is flat\n            continue\n\n        corrs = np.dot(g_tilde, x_t_tilde) / (g_tilde_norms * x_t_tilde_norm)\n        z_hat[t] = np.argmax(corrs)\n\n    # 5. Microstate-Specific Event Functions\n    e = np.zeros(T)\n    for tau in event_times:\n        t_j = int(np.floor(tau / dt))\n        t_j = min(t_j, T - 1)\n        e[t_j] = 1\n\n    u = np.zeros((K, T))\n    for k in range(K):\n        s_k = (z_hat == k)\n        u[k, :] = s_k * e\n\n    # 6. Convolution and Downsampling\n    final_regressors = []\n    for k in range(K):\n        u_k = u[k, :]\n        \n        if np.sum(u_k) == 0:\n            final_regressors.append(np.zeros(N_vol).tolist())\n            continue\n\n        c_k = np.convolve(u_k, h, mode='full')\n        \n        y_k = np.zeros(N_vol)\n        for n in range(N_vol):\n            t_n = n * TR\n            idx = int(np.floor(t_n / dt))\n            # Clamp index to valid range for convolved signal\n            idx = min(idx, len(c_k) - 1)\n            y_k[n] = c_k[idx]\n\n        # 7. Final Normalization\n        norm_y_k = np.linalg.norm(y_k)\n        if norm_y_k  0:\n            y_k /= norm_y_k\n        \n        final_regressors.append(y_k.tolist())\n        \n    return final_regressors\n\nif __name__ == '__main__':\n    solve()\n```"
        }
    ]
}