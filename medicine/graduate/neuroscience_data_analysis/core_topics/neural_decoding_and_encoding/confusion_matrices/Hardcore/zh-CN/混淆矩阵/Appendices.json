{
    "hands_on_practices": [
        {
            "introduction": "在神经科学数据分析中，我们关注的事件（如癫痫发作或特定的神经元放电）通常是罕见的，这使得准确率（accuracy）这一指标变得具有欺骗性。本练习将引导你从第一性原理出发，推导并理解为什么在类别不平衡的数据集上准确率会产生误导，并学习如何构建一个更可靠的评估指标——平衡准确率（balanced accuracy）。",
            "id": "4147499",
            "problem": "一个研究团队正在分析一种用于颅内脑电图（EEG）数据的二元事件检测器，以在连续记录中标记癫痫发作。相对于基线活动，癫痫发作片段是罕见的。该检测器为每个片段输出一个二元标签 $\\hat{Y} \\in \\{0,1\\}$，而真实标签为 $Y \\in \\{0,1\\}$，其中 $Y=1$ 表示癫痫发作，$Y=0$ 表示非癫痫发作。令 $\\mathrm{TP}$、$\\mathrm{FP}$、$\\mathrm{FN}$ 和 $\\mathrm{TN}$ 表示混淆矩阵的条目。\n\n从分类器准确率是在经验数据分布下正确分类指示函数的期望值这一基本定义出发，即 $\\mathrm{Accuracy} = \\mathbb{E}[\\mathbf{1}\\{\\hat{Y} = Y\\}]$，请仅使用条件概率和混淆矩阵术语的核心定义来：\n- 将 $\\mathrm{Accuracy}$ 表示为各类别召回率的加权组合；\n- 通过在关于 $Y$ 的假设均匀类别先验下评估相同的期望，来定义一个与流行率无关的摘要指标；\n- 并仅根据这些推导来论证，为什么对于罕见事件，与流行率无关的摘要指标比 $\\mathrm{Accuracy}$ 更可取。\n\n然后，对于一个假设的数据集，其中 $\\mathrm{TP}=40$、$\\mathrm{FN}=10$、$\\mathrm{FP}=50$ 和 $\\mathrm{TN}=900$，计算上面推导出的与流行率无关的摘要指标。将最终值表示为小数，并四舍五入到四位有效数字。",
            "solution": "该问题是有效的，因为它在科学上基于统计学和机器学习的原理，提法明确且包含了所有必要信息，并且陈述客观。任务是执行一系列关于分类器评估指标的推导，然后计算一个特定值。\n\n分析始于准确率的形式化定义，即正确预测的指示函数 $\\mathbf{1}\\{\\hat{Y} = Y\\}$ 的期望值，其中期望是在经验数据分布上计算的。\n$$\n\\mathrm{Accuracy} = \\mathbb{E}[\\mathbf{1}\\{\\hat{Y} = Y\\}]\n$$\n这个期望等价于正确分类的概率 $P(\\hat{Y}=Y)$。我们可以使用全概率定律，以真实类别标签 $Y$ 为条件来展开这个概率：\n$$\nP(\\hat{Y}=Y) = P(\\hat{Y}=Y | Y=1)P(Y=1) + P(\\hat{Y}=Y | Y=0)P(Y=0)\n$$\n此表达式中的条件概率对应于各分类别的性能指标。\n项 $P(\\hat{Y}=Y | Y=1)$ 是在真实标签为 $1$ 的情况下，分类器正确预测标签为 $1$ 的概率。这是正类（类别 $1$）召回率的定义，也称为灵敏度或真阳性率 ($\\mathrm{TPR}$)。用混淆矩阵的组成部分表示为：\n$$\n\\mathrm{Recall}_{1} = P(\\hat{Y}=1 | Y=1) = \\frac{\\mathrm{TP}}{\\mathrm{TP}+\\mathrm{FN}}\n$$\n项 $P(\\hat{Y}=Y | Y=0)$ 是在真实标签为 $0$ 的情况下，分类器正确预测标签为 $0$ 的概率。这是负类（类别 $0$）召回率的定义，也称为特异度或真阴性率 ($\\mathrm{TNR}$)。它由以下公式给出：\n$$\n\\mathrm{Recall}_{0} = P(\\hat{Y}=0 | Y=0) = \\frac{\\mathrm{TN}}{\\mathrm{TN}+\\mathrm{FP}}\n$$\n概率 $P(Y=1)$ 和 $P(Y=0)$ 分别代表数据集中正类和负类的流行率。令 $p = P(Y=1)$ 为正类的流行率。那么 $P(Y=0) = 1-p$。将这些定义代回准确率的表达式中，我们得到：\n$$\n\\mathrm{Accuracy} = \\mathrm{Recall}_{1} \\cdot p + \\mathrm{Recall}_{0} \\cdot (1-p)\n$$\n这个表达式表明，准确率是各类别召回率的加权平均，其中权重是类别的流行率。\n\n接下来，我们通过在一个假设的均匀类别先验下评估相同的期望 $\\mathbb{E}[\\mathbf{1}\\{\\hat{Y} = Y\\}]$ 来定义一个与流行率无关的摘要指标。均匀先验意味着每个类别出现的可能性相同，因此我们设定 $P(Y=1) = P(Y=0) = \\frac{1}{2}$。让我们用 $S$ 表示这个摘要指标。将这些假设的流行率代入我们推导出的表达式中，得到：\n$$\nS = \\mathrm{Recall}_{1} \\cdot \\frac{1}{2} + \\mathrm{Recall}_{0} \\cdot \\frac{1}{2} = \\frac{1}{2}(\\mathrm{Recall}_{1} + \\mathrm{Recall}_{0})\n$$\n这个指标是每个类别召回率的算术平均值，通常被称为平衡准确率。\n\n现在我们可以使用这些推导来论证，为什么在评估包含罕见事件的数据集上的性能时，这个与流行率无关的摘要指标 $S$ 比准确率更可取。对于罕见事件，如癫痫发作，正类的流行率 $p = P(Y=1)$ 非常小 ($p \\ll 1$)。因此，负类的流行率 $1-p$ 非常接近 $1$。\n在准确率的表达式 $\\mathrm{Accuracy} = \\mathrm{Recall}_{1} \\cdot p + \\mathrm{Recall}_{0} \\cdot (1-p)$ 中，正类召回率 $\\mathrm{Recall}_{1}$ 的贡献被小因子 $p$ 所缩放，而负类召回率 $\\mathrm{Recall}_{0}$ 的贡献被一个接近 $1$ 的因子 $(1-p)$ 所缩放。因此，准确率主要由模型在多数（负）类上的性能决定：\n$$\n\\mathrm{Accuracy} \\approx \\mathrm{Recall}_{0}\n$$\n一个总是预测多数类（即对所有输入都预测 $\\hat{Y}=0$）的平凡分类器将有 $\\mathrm{TP}=0$ 和 $\\mathrm{FN}$ 等于正实例的总数，导致 $\\mathrm{Recall}_{1}=0$。然而，它将有 $\\mathrm{FP}=0$ 和 $\\mathrm{TN}$ 等于负实例的总数，从而产生 $\\mathrm{Recall}_{0}=1$。这个无用分类器的准确率将约为 $1-p$，如果 $p$ 很小，这个值会非常高。这表明，标准准确率对于罕见事件检测是一个误导性的指标，因为它未能惩罚在所关注的罕见类别上的糟糕表现。\n\n相比之下，与流行率无关的摘要指标 $S = \\frac{1}{2}(\\mathrm{Recall}_{1} + \\mathrm{Recall}_{0})$ 对正类和负类的召回率赋予相同的权重（$\\frac{1}{2}$），而不考虑它们在数据中的流行率。较低的 $\\mathrm{Recall}_{1}$ 将显著降低 $S$ 的值，从而正确反映分类器未能识别罕见事件。因此，在类别不平衡的场景中，$S$ 为分类器的效用提供了更平衡、更诚实的评估。\n\n最后，我们为给定的数据集计算这个与流行率无关的摘要指标的值：$\\mathrm{TP}=40$、$\\mathrm{FN}=10$、$\\mathrm{FP}=50$ 和 $\\mathrm{TN}=900$。\n首先，我们计算各类别召回率：\n$$\n\\mathrm{Recall}_{1} = \\frac{\\mathrm{TP}}{\\mathrm{TP}+\\mathrm{FN}} = \\frac{40}{40+10} = \\frac{40}{50} = 0.8\n$$\n$$\n\\mathrm{Recall}_{0} = \\frac{\\mathrm{TN}}{\\mathrm{TN}+\\mathrm{FP}} = \\frac{900}{900+50} = \\frac{900}{950} = \\frac{18}{19}\n$$\n现在，我们计算摘要指标 $S$：\n$$\nS = \\frac{1}{2}(\\mathrm{Recall}_{1} + \\mathrm{Recall}_{0}) = \\frac{1}{2}\\left(\\frac{4}{5} + \\frac{18}{19}\\right)\n$$\n为了对分数求和，我们找到一个公分母，即 $5 \\times 19 = 95$：\n$$\nS = \\frac{1}{2}\\left(\\frac{4 \\times 19}{95} + \\frac{18 \\times 5}{95}\\right) = \\frac{1}{2}\\left(\\frac{76}{95} + \\frac{90}{95}\\right) = \\frac{1}{2}\\left(\\frac{76+90}{95}\\right) = \\frac{1}{2}\\left(\\frac{166}{95}\\right) = \\frac{83}{95}\n$$\n将此分数转换为小数：\n$$\nS = \\frac{83}{95} \\approx 0.87368421...\n$$\n四舍五入到四位有效数字，我们得到 $0.8737$。",
            "answer": "$$\n\\boxed{0.8737}\n$$"
        },
        {
            "introduction": "虽然平衡准确率是一个显著的进步，但研究人员常常希望能用一个单一且稳健的指标来全面评估分类器的性能。本练习将深入探讨马修斯相关系数（Matthews Correlation Coefficient, MCC），并证明它并非一个随意构建的公式，而本质上是真实标签与预测标签之间的皮尔逊相关系数。通过这个推导，你将深刻理解为什么MCC被认为是二元分类任务中最具信息量的单一评估指标之一。",
            "id": "4147553",
            "problem": "一个实验室正在评估一个二进制检测器，该检测器用于标记局部场电位记录中的海马体尖波涟漪事件。对于 $n$ 个时间窗口中的每一个，记录了真实事件标签 $Y_{i} \\in \\{0,1\\}$ 和预测标签 $\\hat{Y}_{i} \\in \\{0,1\\}$，其中 $1$ 表示事件发生，$0$ 表示事件未发生。经验性 $2 \\times 2$ 混淆矩阵的计数定义如下：真正例 $TP$、假正例 $FP$、真负例 $TN$ 和假负例 $FN$，且 $n = TP + FP + TN + FN$。\n\n从两个随机变量之间皮尔逊积矩相关系数的基本定义出发，\n$$\nr = \\frac{\\sum_{i=1}^{n} \\left(X_{i} - \\bar{X}\\right)\\left(Z_{i} - \\bar{Z}\\right)}{\\sqrt{\\left(\\sum_{i=1}^{n} \\left(X_{i} - \\bar{X}\\right)^{2}\\right)\\left(\\sum_{i=1}^{n} \\left(Z_{i} - \\bar{Z}\\right)^{2}\\right)}},\n$$\n推导二进制真实标签 $Y_{i}$ 和二进制预测标签 $\\hat{Y}_{i}$ 之间相关性的闭式表达式，该表达式仅用混淆矩阵计数 $TP$、$FP$、$TN$ 和 $FN$ 表示。将所得表达式解释为马修斯相关系数 (MCC)，并解释为什么它可被视为预测二进制标签与真实二进制标签之间的相关性。将您的最终结果表示为仅包含 $TP$、$FP$、$TN$ 和 $FN$ 的单一符号表达式。",
            "solution": "该问题要求从皮尔逊积矩相关系数 $r$ 出发，推导马修斯相关系数 (MCC)，其中皮尔逊系数应用于两个二进制向量：真实标签 $Y_i \\in \\{0,1\\}$ 和预测标签 $\\hat{Y}_i \\in \\{0,1\\}$，其中 $i=1, \\dots, n$。\n\n首先，我们对问题陈述进行验证。\n\n### 第一步：提取已知条件\n- 真实事件标签：$Y_{i} \\in \\{0,1\\}$，其中 $i=1, \\dots, n$。值为 $1$ 表示事件发生，值为 $0$ 表示事件未发生。\n- 预测事件标签：$\\hat{Y}_{i} \\in \\{0,1\\}$，其中 $i=1, \\dots, n$。\n- 时间窗口总数（样本数）：$n$。\n- 混淆矩阵计数：真正例 ($TP$)、假正例 ($FP$)、真负例 ($TN$) 和假负例 ($FN$)。\n- 计数与总样本数之间的关系：$n = TP + FP + TN + FN$。\n- 两组观测值 $\\{X_i\\}$ 和 $\\{Z_i\\}$ 的皮尔逊积矩相关系数定义：\n$$\nr = \\frac{\\sum_{i=1}^{n} \\left(X_{i} - \\bar{X}\\right)\\left(Z_{i} - \\bar{Z}\\right)}{\\sqrt{\\left(\\sum_{i=1}^{n} \\left(X_{i} - \\bar{X}\\right)^{2}\\right)\\left(\\sum_{i=1}^{n} \\left(Z_{i} - \\bar{Z}\\right)^{2}\\right)}}\n$$\n\n### 第二步：使用提取的已知条件进行验证\n该问题具有科学依据，提法明确且客观。它要求在统计数据分析的背景下进行标准的数学推导，这是一个与神经科学高度相关的主题。其前提事实正确，定义标准，所要求的任务可以形式化并得出唯一解。该问题没有科学或事实上的不健全之处，不是隐喻性的，是完整的，不是不切实际的，是提法明确的，并且不是无足轻重的。\n\n### 第三步：结论与行动\n问题有效。我们将继续进行解答。\n\n为了推导真实标签 $Y_i$ 和预测标签 $\\hat{Y}_i$ 之间相关性的表达式，我们将使用皮尔逊相关系数的计算公式，该公式在代数上与所给公式等价：\n$$\nr = \\frac{n \\sum_{i=1}^{n} Y_i \\hat{Y}_i - \\left(\\sum_{i=1}^{n} Y_i\\right) \\left(\\sum_{i=1}^{n} \\hat{Y}_i\\right)}{\\sqrt{\\left[n \\sum_{i=1}^{n} Y_i^2 - \\left(\\sum_{i=1}^{n} Y_i\\right)^2\\right] \\left[n \\sum_{i=1}^{n} \\hat{Y}_i^2 - \\left(\\sum_{i=1}^{n} \\hat{Y}_i\\right)^2\\right]}}\n$$\n我们的任务是用混淆矩阵计数 $TP$、$FP$、$TN$ 和 $FN$ 来表示此公式中的每个求和项。\n\n1.  **表示涉及 $Y_i$ 和 $\\hat{Y}_i$ 的求和**：\n    求和 $\\sum_{i=1}^{n} Y_i$ 计算的是实际正例的总数（其中 $Y_i = 1$）。根据定义，这是真正例和假负例的总和。\n    $$ \\sum_{i=1}^{n} Y_i = TP + FN $$\n    类似地，求和 $\\sum_{i=1}^{n} \\hat{Y}_i$ 计算的是预测正例的总数（其中 $\\hat{Y}_i = 1$）。这是真正例和假正例的总和。\n    $$ \\sum_{i=1}^{n} \\hat{Y}_i = TP + FP $$\n\n2.  **表示平方和**：\n    由于 $Y_i$ 和 $\\hat{Y}_i$ 都是取值于 $\\{0,1\\}$ 的二进制变量，我们有 $Y_i^2 = Y_i$ 和 $\\hat{Y}_i^2 = \\hat{Y}_i$。\n    因此，平方和等于变量自身的和。\n    $$ \\sum_{i=1}^{n} Y_i^2 = \\sum_{i=1}^{n} Y_i = TP + FN $$\n    $$ \\sum_{i=1}^{n} \\hat{Y}_i^2 = \\sum_{i=1}^{n} \\hat{Y}_i = TP + FP $$\n\n3.  **表示乘积和**：\n    当且仅当 $Y_i=1$ 且 $\\hat{Y}_i=1$ 时，乘积 $Y_i \\hat{Y}_i$ 等于 $1$。这种情况对应于一个真正例。求和 $\\sum_{i=1}^{n} Y_i \\hat{Y}_i$ 计算的是此类实例的数量。\n    $$ \\sum_{i=1}^{n} Y_i \\hat{Y}_i = TP $$\n\n现在，我们将这些表达式代回 $r$ 的公式中。\n\n**分子**：\n分子是 $n \\sum Y_i \\hat{Y}_i - (\\sum Y_i)(\\sum \\hat{Y}_i)$。\n$$ \\text{分子} = n(TP) - (TP + FN)(TP + FP) $$\n代入 $n = TP + FP + TN + FN$：\n$$ \\text{分子} = (TP + FP + TN + FN)TP - (TP + FN)(TP + FP) $$\n$$ = (TP^2 + FP \\cdot TP + TN \\cdot TP + FN \\cdot TP) - (TP^2 + TP \\cdot FP + FN \\cdot TP + FN \\cdot FP) $$\n$$ = TP^2 + FP \\cdot TP + TN \\cdot TP + FN \\cdot TP - TP^2 - TP \\cdot FP - FN \\cdot TP - FN \\cdot FP $$\n消去各项后，我们得到：\n$$ \\text{分子} = TP \\cdot TN - FP \\cdot FN $$\n\n**分母**：\n分母是两项乘积的平方根。让我们分别计算每一项。\n\n被开方数中的第一项：$n \\sum Y_i^2 - (\\sum Y_i)^2$。\n$$ n(TP + FN) - (TP + FN)^2 = (TP + FN) [n - (TP + FN)] $$\n因为 $n = TP + FP + TN + FN$，所以我们有 $n - (TP + FN) = FP + TN$。\n$$ \\text{第一项} = (TP + FN)(FP + TN) $$\n\n被开方数中的第二项：$n \\sum \\hat{Y}_i^2 - (\\sum \\hat{Y}_i)^2$。\n$$ n(TP + FP) - (TP + FP)^2 = (TP + FP) [n - (TP + FP)] $$\n因为 $n = TP + FP + TN + FN$，所以我们有 $n - (TP + FP) = TN + FN$。\n$$ \\text{第二项} = (TP + FP)(TN + FN) $$\n\n完整的分母是这两项乘积的平方根：\n$$ \\text{分母} = \\sqrt{ (TP + FN)(FP + TN) \\cdot (TP + FP)(TN + FN) } $$\n\n**最后组合**：\n将分子和分母组合起来，得到相关系数 $r$ 的最终表达式：\n$$ r = \\frac{TP \\cdot TN - FP \\cdot FN}{\\sqrt{(TP + FP)(TP + FN)(TN + FP)(TN + FN)}} $$\n\n这个表达式正是马修斯相关系数 (MCC) 的定义。这一推导表明，MCC 不是一个随意的度量标准，而根本上是在真实标签和预测标签的二进制向量之间计算出的皮尔逊积矩相关系数。\n\n这个结果的解释是，MCC 直接以相关性的形式衡量了二元分类的质量。$r = MCC = +1$ 的值表示完美预测，即预测标签与真实标签完全相关。$r = MCC = -1$ 的值表示完全不一致，即预测与真实标签完全负相关。$r = MCC = 0$ 的值表示预测相对于真实标签而言不比随机猜测好。这种基于相关性理论的基础，使得 MCC 成为一个全面且平衡的度量标准，因为它考虑了混淆矩阵中的所有四个值，并且对类别不平衡具有鲁棒性。",
            "answer": "$$\n\\boxed{\\frac{TP \\cdot TN - FP \\cdot FN}{\\sqrt{(TP + FP)(TP + FN)(TN + FP)(TN + FN)}}}\n$$"
        },
        {
            "introduction": "在实际研究中，我们通常使用交叉验证等方法来评估模型，这会产生多个混淆矩阵。那么，我们应该如何汇总这些结果呢？本练习将探讨一个关键且易被误解的问题：对于$F1$分数这类非线性指标，宏平均（macro-averaging）与微平均（micro-averaging）之间的区别，并通过具体计算说明为什么对每个折叠（fold）的分数进行简单平均可能会得出错误的结论。",
            "id": "4147572",
            "problem": "一个神经科学实验室正在评估一个用于检测颅内脑电图 (EEG) 片段中癫痫样棘波的二元分类器。该分类器使用双折交叉验证 (CV) 进行评估。对于每一折，混淆矩阵的条目被记录为真阳性 ($\\mathrm{TP}$)、假阳性 ($\\mathrm{FP}$)、假阴性 ($\\mathrm{FN}$) 和真阴性 ($\\mathrm{TN}$) 的计数。记录的计数如下：\n- 折 $1$：$\\mathrm{TP}_1 = 90$, $\\mathrm{FP}_1 = 10$, $\\mathrm{FN}_1 = 90$, $\\mathrm{TN}_1 = 810$。\n- 折 $2$：$\\mathrm{TP}_2 = 10$, $\\mathrm{FP}_2 = 90$, $\\mathrm{FN}_2 = 10$, $\\mathrm{TN}_2 = 890$。\n\n研究人员考虑用两种方法来汇总各折的 $F1$ 分数：\n- 宏平均：计算每折的 $F1$ 分数，然后计算各折的非加权平均值。\n- 微平均：汇总各折的混淆矩阵计数，然后从汇总的计数中计算单个 $F1$ 分数。\n\n仅使用混淆矩阵、精确率、召回率和调和平均数的核心定义，并从第一性原理出发进行推理，判断关于为什么汇总每折的 $F1$ 分数通常不等同于从汇总的混淆矩阵计算 $F1$ 分数，以下哪些陈述是正确的。\n\nA. 无论各折之间是否存在类别不平衡，宏平均 $F1$ 分数都等于从汇总的混淆矩阵计算出的 $F1$ 分数。\n\nB. 因为 $F1$ 分数是混淆矩阵计数的非线性函数，所以每折 $F1$ 的非加权平均值（宏平均）通常不同于汇总计数后计算的 $F1$（微平均）；它们仅在特殊条件下才会一致。\n\nC. 如果对于每一折 $i$ 都存在常数 $a$ 和 $b$ 使得 $\\mathrm{FP}_i = a \\,\\mathrm{TP}_i$ 和 $\\mathrm{FN}_i = b \\,\\mathrm{TP}_i$，那么宏平均 $F1$ 分数等于从汇总计数计算出的 $F1$ 分数。\n\nD. 对于上面提供的折，宏平均 $F1$ 分数等于从汇总的混淆矩阵计算出的 $F1$ 分数。\n\nE. 根据 Jensen 不等式，在交叉验证设置中，宏平均 $F1$ 分数总是严格小于微平均 $F1$ 分数。\n\n选择所有正确选项。",
            "solution": "从核心定义开始。对于一个具有混淆矩阵条目 $\\mathrm{TP}$、$\\mathrm{FP}$、$\\mathrm{FN}$ 和 $\\mathrm{TN}$ 的二元分类器，将精确率 $P$ 和召回率 $R$ 定义为\n$$\nP = \\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FP}}, \\qquad R = \\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FN}}.\n$$\n$F1$ 分数被定义为精确率和召回率的调和平均数：\n$$\nF1 = \\frac{2 P R}{P + R}.\n$$\n直接用混淆矩阵计数来表示 $F1$。将 $P$ 和 $R$ 的定义代入调和平均数：\n$$\nF1 = \\frac{2 \\left( \\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FP}} \\right) \\left( \\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FN}} \\right)}{\\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FP}} + \\frac{\\mathrm{TP}}{\\mathrm{TP} + \\mathrm{FN}}}\n= \\frac{2 \\mathrm{TP}}{2 \\mathrm{TP} + \\mathrm{FP} + \\mathrm{FN}}.\n$$\n因此，对于单一一组计数，$F1$ 是 $\\mathrm{TP}$、$\\mathrm{FP}$ 和 $\\mathrm{FN}$ 的有理函数。\n\n考虑在各折 $i = 1,2,\\dots,k$ 上的两种汇总策略：\n- 宏平均（非加权）：计算每折的 $F1_i$ 并取平均 $F1_{\\text{macro}} = \\frac{1}{k} \\sum_{i=1}^k F1_i$。\n- 通过汇总的混淆矩阵进行微平均：计算\n$$\n\\mathrm{TP}_{\\text{agg}} = \\sum_{i=1}^k \\mathrm{TP}_i, \\quad \\mathrm{FP}_{\\text{agg}} = \\sum_{i=1}^k \\mathrm{FP}_i, \\quad \\mathrm{FN}_{\\text{agg}} = \\sum_{i=1}^k \\mathrm{FN}_i,\n$$\n然后\n$$\nF1_{\\text{micro}} = \\frac{2 \\,\\mathrm{TP}_{\\text{agg}}}{2 \\,\\mathrm{TP}_{\\text{agg}} + \\mathrm{FP}_{\\text{agg}} + \\mathrm{FN}_{\\text{agg}}}.\n$$\n一般来说，\n$$\n\\frac{1}{k} \\sum_{i=1}^k \\frac{2 \\,\\mathrm{TP}_i}{2 \\,\\mathrm{TP}_i + \\mathrm{FP}_i + \\mathrm{FN}_i}\n\\neq\n\\frac{2 \\sum_{i=1}^k \\mathrm{TP}_i}{2 \\sum_{i=1}^k \\mathrm{TP}_i + \\sum_{i=1}^k \\mathrm{FP}_i + \\sum_{i=1}^k \\mathrm{FN}_i},\n$$\n因为对一个非线性有理函数求平均，通常不等于在平均（或求和）后的参数上计算该函数的值。\n\n用提供的折进行演示。计算每折的精确率、召回率和 $F1$。\n\n折 $1$：\n$$\nP_1 = \\frac{90}{90 + 10} = \\frac{90}{100} = 0.9, \\qquad R_1 = \\frac{90}{90 + 90} = \\frac{90}{180} = 0.5,\n$$\n$$\nF1_1 = \\frac{2 \\cdot 0.9 \\cdot 0.5}{0.9 + 0.5} = \\frac{0.9}{1.4} \\approx 0.642857.\n$$\n或者通过计数计算，\n$$\nF1_1 = \\frac{2\\cdot 90}{2\\cdot 90 + 10 + 90} = \\frac{180}{280} = \\frac{9}{14} \\approx 0.642857.\n$$\n\n折 $2$：\n$$\nP_2 = \\frac{10}{10 + 90} = \\frac{10}{100} = 0.1, \\qquad R_2 = \\frac{10}{10 + 10} = \\frac{10}{20} = 0.5,\n$$\n$$\nF1_2 = \\frac{2 \\cdot 0.1 \\cdot 0.5}{0.1 + 0.5} = \\frac{0.1}{0.6} \\approx 0.1666667,\n$$\n等价地\n$$\nF1_2 = \\frac{2\\cdot 10}{2\\cdot 10 + 90 + 10} = \\frac{20}{120} = \\frac{1}{6} \\approx 0.166667.\n$$\n\n宏平均 $F1$：\n$$\nF1_{\\text{macro}} = \\frac{F1_1 + F1_2}{2} \\approx \\frac{0.642857 + 0.1666667}{2} \\approx 0.4047619.\n$$\n\n汇总计数：\n$$\n\\mathrm{TP}_{\\text{agg}} = 90 + 10 = 100, \\quad \\mathrm{FP}_{\\text{agg}} = 10 + 90 = 100, \\quad \\mathrm{FN}_{\\text{agg}} = 90 + 10 = 100,\n$$\n然后\n$$\nF1_{\\text{micro}} = \\frac{2\\cdot 100}{2\\cdot 100 + 100 + 100} = \\frac{200}{400} = 0.5.\n$$\n我们观察到 $F1_{\\text{macro}} \\approx 0.405 \\neq 0.5 = F1_{\\text{micro}}$，这证明了它们是不等价的。\n\n刻画等价的条件。假设对于每一折 $i$ 都存在与 $i$ 无关的常数 $a$ 和 $b$，使得\n$$\n\\mathrm{FP}_i = a \\,\\mathrm{TP}_i, \\qquad \\mathrm{FN}_i = b \\,\\mathrm{TP}_i.\n$$\n那么每折的 $F1$ 简化为\n$$\nF1_i = \\frac{2 \\,\\mathrm{TP}_i}{2 \\,\\mathrm{TP}_i + a \\,\\mathrm{TP}_i + b \\,\\mathrm{TP}_i} = \\frac{2}{2 + a + b},\n$$\n这在各折之间是恒定的。因此，\n$$\nF1_{\\text{macro}} = \\frac{1}{k} \\sum_{i=1}^k F1_i = \\frac{2}{2 + a + b}.\n$$\n汇总的计数满足\n$$\n\\mathrm{TP}_{\\text{agg}} = \\sum_i \\mathrm{TP}_i, \\quad \\mathrm{FP}_{\\text{agg}} = \\sum_i a \\,\\mathrm{TP}_i = a \\sum_i \\mathrm{TP}_i, \\quad \\mathrm{FN}_{\\text{agg}} = \\sum_i b \\,\\mathrm{TP}_i = b \\sum_i \\mathrm{TP}_i,\n$$\n因此\n$$\nF1_{\\text{micro}} = \\frac{2 \\sum_i \\mathrm{TP}_i}{2 \\sum_i \\mathrm{TP}_i + a \\sum_i \\mathrm{TP}_i + b \\sum_i \\mathrm{TP}_i} = \\frac{2}{2 + a + b} = F1_{\\text{macro}}.\n$$\n因此，在各折的错误计数相对于 $\\mathrm{TP}$ 存在特殊比例关系的条件下，等式成立；否则，非线性会导致差异。\n\n最后，讨论常见的错误陈述。Jensen 不等式为凸函数或凹函数的期望提供了界限；然而，作为计数的有理函数，$F1$ 在相关定义域上既不是全局凸的也不是全局凹的，并且此处的平均混合了各折不同的分母。因此，没有任何一般性的不等式能保证宏平均 $F1$ 总是小于微平均 $F1$；它可能小于、等于或大于微平均 $F1$，具体取决于计数的分布。\n\n逐项分析：\n\nA. 声称无论类别是否不平衡都相等。上面的演示表明，对于不平衡的折，$F1_{\\text{macro}} \\approx 0.405$ 且 $F1_{\\text{micro}} = 0.5$，所以等式通常不成立。结论：不正确。\n\nB. 陈述了正确的原因（非线性），并正确地区分了宏聚合与微聚合，指出了仅在特殊条件下才相等。结论：正确。\n\nC. 提供了一个具体的特殊条件，即对于所有折，$\\mathrm{FP}_i = a \\,\\mathrm{TP}_i$ 和 $\\mathrm{FN}_i = b \\,\\mathrm{TP}_i$，在该条件下宏平均和微平均 $F1$ 相等。上面的推导证明了这一点。结论：正确。\n\nD. 断言对于提供的折，两者相等。数值计算表明它们不同（$0.4047619$ 对比 $0.5$）。结论：不正确。\n\nE. 援引 Jensen 不等式来声称宏平均 $F1$ 总是严格小于微平均 $F1$。因为 $F1$ 在相关变量上不是全局凸或凹的，并且平均是跨越具有不同分母的比率进行的，所以不存在这样的普遍排序关系。结论：不正确。",
            "answer": "$$\\boxed{BC}$$"
        }
    ]
}