{
    "hands_on_practices": [
        {
            "introduction": "在应用任何时频分析工具之前，理解其背后的基本物理限制至关重要。本练习将引导你推导海森堡-加博尔不确定性原理，它为我们能同时确定信号时间和频率的精度设定了严格的数学下限。通过这个推导，你将深刻理解时频分辨率权衡的根本“原因”。",
            "id": "4200765",
            "problem": "您正在使用短时傅里叶变换（STFT; Short-Time Fourier Transform）分析一段来自皮层记录的局部场电位（LFP）片段。设连续时间信号为 $x(t)$，其连续时间傅里叶变换为 $X(f) = \\int_{-\\infty}^{\\infty} x(t)\\,\\exp(-\\mathrm{i}\\,2\\pi f t)\\,dt$。定义时间均值 $\\mu_{t}$ 和频率均值 $\\mu_{f}$，以及相应的标准差（二阶中心矩）$\\sigma_{t}$ 和 $\\sigma_{f}$ 如下：\n$$\\mu_{t} = \\frac{\\int_{-\\infty}^{\\infty} t\\,|x(t)|^{2}\\,dt}{\\int_{-\\infty}^{\\infty} |x(t)|^{2}\\,dt},\\quad \\sigma_{t}^{2} = \\frac{\\int_{-\\infty}^{\\infty} (t - \\mu_{t})^{2}\\,|x(t)|^{2}\\,dt}{\\int_{-\\infty}^{\\infty} |x(t)|^{2}\\,dt},$$\n$$\\mu_{f} = \\frac{\\int_{-\\infty}^{\\infty} f\\,|X(f)|^{2}\\,df}{\\int_{-\\infty}^{\\infty} |X(f)|^{2}\\,df},\\quad \\sigma_{f}^{2} = \\frac{\\int_{-\\infty}^{\\infty} (f - \\mu_{f})^{2}\\,|X(f)|^{2}\\,df}{\\int_{-\\infty}^{\\infty} |X(f)|^{2}\\,df},$$\n其中 $f$ 的单位是赫茲。从这些定义、连续时间傅里叶变换的性质以及平方可积函数的标准不等式（包括柯西-施瓦茨不等式和帕塞瓦尔恒等式）出发，推导乘积 $\\sigma_{t}\\,\\sigma_{f}$ 的一个基本下界。该下界反映了信号 $x(t)$ 在频率变量 $f$（单位为赫兹，而非角频率）上的时频分辨率权衡。然后，对于一个测得的STFT谱-时间片段，其边际二阶矩估计值为 $\\sigma_{t} = 50\\ \\mathrm{ms}$ 和 $\\sigma_{f} = 6\\ \\mathrm{Hz}$，计算无量纲比率\n$$R = \\frac{\\sigma_{t}\\,\\sigma_{f}}{\\text{推导出的下界}},$$\n评估测量值对是否与推导出的下界一致（一致性对应于 $R \\geq 1$），并解释如果在实际神经科学数据分析中观察到 $R < 1$ 的情况，可能的方法学原因，重点关注估计器的定义、采样和加窗。在所有计算中，时间单位使用 $\\mathrm{s}$，频率单位使用 $\\mathrm{Hz}$。将 $R$ 的最终答案表示为一个未经四舍五入的精确解析表达式。",
            "solution": "该问题要求完成三项任务：1) 推导连续时间信号的时间标准差和频谱标准差乘积 $\\sigma_{t}\\sigma_{f}$ 的基本下界；2) 对于给定的测量值对 $(\\sigma_{t}, \\sigma_{f})$，计算无量纲比率 $R$；3) 讨论在实际数据分析中出现明显违反此界限的可能原因。\n\n首先，我们推导时频不确定性原理。标准差 $\\sigma_{t}$ 和 $\\sigma_{f}$ 定义为方差的平方根：\n$$ \\sigma_{t}^{2} = \\frac{\\int_{-\\infty}^{\\infty} (t - \\mu_{t})^{2}\\,|x(t)|^{2}\\,dt}{\\int_{-\\infty}^{\\infty} |x(t)|^{2}\\,dt}, \\quad \\sigma_{f}^{2} = \\frac{\\int_{-\\infty}^{\\infty} (f - \\mu_{f})^{2}\\,|X(f)|^{2}\\,df}{\\int_{-\\infty}^{\\infty} |X(f)|^{2}\\,df} $$\n标准差 $\\sigma_t$ 和 $\\sigma_f$ 在信号 $x(t)$ 的时移和频移下是不变的。时移 $x(t) \\to x(t-t_0)$ 会使 $\\mu_t$ 移动 $t_0$，但不会改变 $\\sigma_t$。频率调制 $x(t) \\to x(t)\\exp(i2\\pi f_0 t)$ 会使频谱 $X(f) \\to X(f-f_0)$，这会使 $\\mu_f$ 移动 $f_0$，但不会改变 $\\sigma_f$。因此，不失一般性，我们可以将信号中心化，使其平均时间 $\\mu_t$ 和平均频率 $\\mu_f$ 均为零。设 $\\mu_t = 0$ 和 $\\mu_f = 0$。定义简化为：\n$$ \\sigma_{t}^{2} = \\frac{\\int_{-\\infty}^{\\infty} t^{2}\\,|x(t)|^{2}\\,dt}{E}, \\quad \\sigma_{f}^{2} = \\frac{\\int_{-\\infty}^{\\infty} f^{2}\\,|X(f)|^{2}\\,df}{E_{f}} $$\n其中 $E = \\int_{-\\infty}^{\\infty} |x(t)|^{2}\\,dt$ 是信号的能量。根据帕塞瓦尔定理，时域中的能量等于频域中的能量，$E_{f} = \\int_{-\\infty}^{\\infty} |X(f)|^{2}\\,df = E$。因此，\n$$ \\sigma_{t}^{2} = \\frac{1}{E} \\int_{-\\infty}^{\\infty} t^{2}\\,|x(t)|^{2}\\,dt, \\quad \\sigma_{f}^{2} = \\frac{1}{E} \\int_{-\\infty}^{\\infty} f^{2}\\,|X(f)|^{2}\\,df $$\n为了连接这两个表达式，我们使用傅里叶变换关于导数的性质。$x(t)$ 的导数的变换是 $\\mathcal{F}\\{\\frac{d}{dt}x(t)\\} = \\mathrm{i}\\,2\\pi f X(f)$。让我们将帕塞瓦尔定理应用于导数 $x'(t) = \\frac{d}{dt}x(t)$：\n$$ \\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt = \\int_{-\\infty}^{\\infty} |\\mathrm{i}\\,2\\pi f X(f)|^{2}\\,df = (2\\pi)^{2} \\int_{-\\infty}^{\\infty} f^{2}\\,|X(f)|^{2}\\,df $$\n由此，我们可以在时域中表示频率方差 $\\sigma_f^2$：\n$$ \\sigma_{f}^{2} = \\frac{(2\\pi)^{2}}{E} \\int_{-\\infty}^{\\infty} f^{2}\\,|X(f)|^{2}\\,df = \\frac{1}{4\\pi^2 E} \\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt $$\n那么方差的乘积是：\n$$ \\sigma_{t}^{2}\\,\\sigma_{f}^{2} = \\left(\\frac{1}{E} \\int_{-\\infty}^{\\infty} t^{2}\\,|x(t)|^{2}\\,dt\\right) \\left(\\frac{1}{4\\pi^2 E} \\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt\\right) = \\frac{1}{4\\pi^2 E^2} \\left(\\int_{-\\infty}^{\\infty} |t x(t)|^{2}\\,dt\\right) \\left(\\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt\\right) $$\n现在我们应用柯西-施瓦茨不等式，该不等式指出，对于任意两个平方可积的复函数 $g(t)$ 和 $h(t)$，都有 $|\\int g^{*}(t)h(t)\\,dt|^2 \\le (\\int |g(t)|^2\\,dt)(\\int |h(t)|^2\\,dt)$。令 $g(t) = t x(t)$ 和 $h(t) = x'(t)$。我们有：\n$$ \\left(\\int_{-\\infty}^{\\infty} |t x(t)|^{2}\\,dt\\right) \\left(\\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt\\right) \\ge \\left| \\int_{-\\infty}^{\\infty} (t x(t))^{*} x'(t)\\,dt \\right|^2 = \\left| \\int_{-\\infty}^{\\infty} t x^{*}(t) x'(t)\\,dt \\right|^2 $$\n为了计算右边的积分，考虑 $t|x(t)|^2$ 的导数：\n$$ \\frac{d}{dt}(t|x(t)|^2) = |x(t)|^2 + t \\frac{d}{dt}(x(t)x^{*}(t)) = |x(t)|^2 + t(x'(t)x^{*}(t) + x(t)(x'(t))^{*}) $$\n将此表达式从 $-\\infty$ 积分到 $\\infty$：\n$$ \\int_{-\\infty}^{\\infty} \\frac{d}{dt}(t|x(t)|^2)\\,dt = [t|x(t)|^2]_{-\\infty}^{\\infty} = 0 $$\n该积分为零，因为对于任何有限能量信号，$x(t)$ 在 $t \\to \\pm\\infty$ 时必须比 $1/\\sqrt{|t|}$ 更快地衰减到零。因此：\n$$ 0 = \\int_{-\\infty}^{\\infty} |x(t)|^2\\,dt + \\int_{-\\infty}^{\\infty} t(x'(t)x^{*}(t) + x(t)(x'(t))^{*})\\,dt $$\n$$ E + \\int_{-\\infty}^{\\infty} t x'(t)x^{*}(t)\\,dt + \\int_{-\\infty}^{\\infty} t x(t)(x'(t))^{*}\\,dt = 0 $$\n设 $I = \\int_{-\\infty}^{\\infty} t x^{*}(t) x'(t)\\,dt$。上述方程变为 $E + I + I^{*} = 0$，或 $E + 2\\,\\text{Re}(I) = 0$。这意味着 $\\text{Re}(I) = -E/2$。\n$I$ 的模的平方是 $|I|^2 = (\\text{Re}(I))^2 + (\\text{Im}(I))^2$。由于 $(\\text{Im}(I))^2 \\ge 0$，我们有 $|I|^2 \\ge (\\text{Re}(I))^2$。\n$$ |I|^2 \\ge \\left(-\\frac{E}{2}\\right)^2 = \\frac{E^2}{4} $$\n将此结果代回柯西-施瓦茨不等式的结果中：\n$$ \\left(\\int_{-\\infty}^{\\infty} |t x(t)|^{2}\\,dt\\right) \\left(\\int_{-\\infty}^{\\infty} |x'(t)|^{2}\\,dt\\right) \\ge \\frac{E^2}{4} $$\n最后，我们将此代入方差乘积的表达式中：\n$$ \\sigma_{t}^{2}\\,\\sigma_{f}^{2} \\ge \\frac{1}{4\\pi^2 E^2} \\left(\\frac{E^2}{4}\\right) = \\frac{1}{16\\pi^2} $$\n对两边取平方根，得到基本下界，即伽柏-海森堡不确定性原理：\n$$ \\sigma_{t}\\,\\sigma_{f} \\ge \\frac{1}{4\\pi} $$\n\n接下来，我们计算测量值 $\\sigma_{t} = 50\\ \\mathrm{ms}$ 和 $\\sigma_{f} = 6\\ \\mathrm{Hz}$ 的比率 $R$。首先，将 $\\sigma_t$ 转换为标准单位秒：$\\sigma_{t} = 50 \\times 10^{-3}\\ \\mathrm{s} = 0.05\\ \\mathrm{s}$。该乘积是无量纲的：\n$$ \\sigma_{t}\\,\\sigma_{f} = (0.05\\ \\mathrm{s}) \\times (6\\ \\mathrm{Hz}) = 0.05 \\times 6 = 0.3 $$\n比率 $R$ 是测量得到的乘积除以推导出的理论下界：\n$$ R = \\frac{\\sigma_{t}\\,\\sigma_{f}}{\\frac{1}{4\\pi}} = \\frac{0.3}{\\frac{1}{4\\pi}} = 0.3 \\times 4\\pi = 1.2\\pi = \\frac{12\\pi}{10} = \\frac{6\\pi}{5} $$\n$R$ 的值约为 $R \\approx \\frac{6 \\times 3.14159}{5} \\approx 3.77$。由于 $R > 1$，测量的 $(\\sigma_{t}, \\sigma_{f})$ 对与推导出的不确定性原理是一致的。\n\n最后，我们考虑在实际神经科学环境中出现明显违反（$R < 1$）的可能的方法学原因。理论推导假设信号是连续的、无限时长的、无噪声的，并且定义基于在 $(-\\infty, \\infty)$ 上的积分。实际分析涉及离散的、有限时长的、有噪声的信号，以及基于求和的估计器。\n明显的违反并非对数学原理的违反，而是估计方法存在缺陷的标志。\n\n$1$. **估计器偏差和定义不匹配**：最主要的原因是从频谱图估计 $\\sigma_t$ 和 $\\sigma_f$ 的方法。理论定义是对整个信号能量分布 $|x(t)|^2$ 和 $|X(f)|^2$ 进行积分。在实践中，分析人员通常会在频谱图 $S(t, f)$ 中分离出感兴趣的“特征”或“斑点”。这种分离通常涉及阈值处理，即把任何功率低于某一水平的谱-时间点设为零。这种截断通过移除特征在时间和频率维度上的低能量尾部，人为地锐化了特征。从这个截断的分布中计算二阶矩会产生有偏的估计值 $\\hat{\\sigma}_t < \\sigma_t$ 和 $\\hat{\\sigma}_f < \\sigma_f$。得到的乘积 $\\hat{\\sigma}_t \\hat{\\sigma}_f$ 很容易低于 $1/(4\\pi)$ 的界限，因为该估计器没有考虑理论所要求的完整能量分布。\n\n$2$. **加窗效应**：短时傅里叶变换 (STFT) 依赖于一个有限时长的窗函数 $w(t)$。分析窗本身的不确定性乘积 $\\sigma_{t,w} \\sigma_{f,w}$ 也必须遵守不确定性原理。测得的时间展宽 $\\sigma_t$ 主要由窗的持续时间决定，而测得的频谱展宽 $\\sigma_f$ 是信号真实频谱与窗频谱卷积的结果。虽然卷积通常会展宽一个特征，但如果估计过程（如第1点所述）不佳，未能捕捉到卷积后频谱的真实宽度（例如忽略了频谱泄漏或旁瓣），就可能导致对 $\\sigma_f$ 的低估。如果由于窗函数较短，$\\sigma_t$ 已经很小，这种综合的低估就可能导致明显的违反。\n\n$3$. **采样和离散化伪影**：连续时间的推导有其离散时间的对应版本。然而，将连续时间的界限 $1/(4\\pi)$ 应用于离散数据的估计值是一种近似。此外，对连续信号 $x(t)$ 的不当采样会引入混叠，即高频分量被折叠回基带。这会扭曲信号频谱，在特定情况下可能导致估计的频谱方差 $\\hat{\\sigma}_f^2$ 人为变窄，如果时间方差没有相应增加，就会导致明显的违反。\n\n总之，在实践中观察到 $R < 1$ 的最可能原因是使用了对 $\\sigma_t$ 和 $\\sigma_f$ 的有偏估计器。具体来说，在计算矩之前截断信号特征的时频能量分布的方法，很容易产生人为的小方差估计值，从而违反理论界限。",
            "answer": "$$\\boxed{\\frac{6\\pi}{5}}$$"
        },
        {
            "introduction": "短时傅里叶变换（STFT）是时频分析中的主力工具。本练习将展示理论极限如何在实际分析场景中体现。通过为STFT选择一个特定的窗长，我们就在时频分辨率的“跷跷板”上做出了明确的选择，而本练习将量化这一选择对频谱分辨率的具体影响。",
            "id": "4200751",
            "problem": "您正在使用短时傅里叶变换（STFT）分析一段稳态的脑电图（EEG）数据。信号的采样频率为 $F_s = 500\\ \\mathrm{Hz}$，您将使用时长为 $L = 1\\ \\mathrm{s}$ 的分析窗。STFT 采用汉宁窗（Hann window，也称 Hanning window），连续窗口之间的重叠率为 $50\\%$。考虑一段 $10\\ \\mathrm{s}$ 的记录。\n\n从离散时间傅里叶分析和加窗的基本定义出发，并利用窗函数主瓣宽度的公认特性，完成以下任务：\n\n- 推导离散傅里叶变换（DFT）的频率箱（frequency-bin）间距 $\\Delta f$ 作为 $F_s$ 和 $L$ 的函数。\n- 根据指定的重叠规则，计算该 $10\\ \\mathrm{s}$ 记录中可以容纳的 STFT 段数。假设窗口从记录开始处连续放置，且最后一个窗口必须完全位于记录之内。\n- 基于汉宁窗主瓣宽度的已知值（以“箱”为单位），严格论证在这些分析参数下，分辨位于 $9\\ \\mathrm{Hz}$ 和 $10\\ \\mathrm{Hz}$ 的两个窄带峰的能力。您的论证应围绕窗函数主瓣所隐含的瑞利分辨率（Rayleigh resolution）以及时频分辨率的权衡展开，明确将窗口时长 $L$ 与时间分辨率和频谱分辨率联系起来。\n\n提供 $\\Delta f$ 的数值（单位为 $\\mathrm{Hz}$）和分段计数的整数值。无需四舍五入。在最终答案框中，以不带单位的形式表达您的最终数值答案。",
            "solution": "该问题是有效的，因为它具有科学依据、问题明确且客观。它提出了一个标准的信号处理任务，涉及短时傅里叶变换（STFT）在神经科学数据分析中的应用，并使用了切合实际的参数。所有必要信息都已提供，问题有唯一且可推导的答案。\n\n该问题要求对 STFT 在脑电图数据上的应用进行三部分分析。我们将从基本原理出发，依次解决每个部分。给定参数为：采样频率 $F_s = 500\\ \\mathrm{Hz}$，窗口时长 $L = 1\\ \\mathrm{s}$，总记录时长 $T_{rec} = 10\\ \\mathrm{s}$，汉宁窗，以及 $50\\%$ 的重叠率。\n\n首先，我们推导在每个 STFT 段内使用的离散傅里叶变换（DFT）的频率箱间距。分析窗的时长为 $L$。给定采样频率 $F_s$，该窗口内的离散样本数 $N$ 由下式给出：\n$$N = L \\times F_s$$\n对于给定值，$N = 1\\ \\mathrm{s} \\times 500\\ \\mathrm{Hz} = 500$ 个样本。\n一个包含 $N$ 个样本的序列的 DFT 会产生一个由 $N$ 个复系数表示的频谱，这些系数对应于 $N$ 个等间距的频率箱。实值信号的 DFT 所覆盖的频率范围从 $0$ Hz 延伸到采样频率 $F_s$。因此，相邻频率箱之间的间距 $\\Delta f$ 为：\n$$\\Delta f = \\frac{F_s}{N}$$\n代入 $N$ 的表达式，我们发现频率箱间距和窗口时长之间的一般关系：\n$$\\Delta f = \\frac{F_s}{L \\times F_s} = \\frac{1}{L}$$\n对于指定的窗口时长 $L = 1\\ \\mathrm{s}$，频率箱间距为：\n$$\\Delta f = \\frac{1}{1\\ \\mathrm{s}} = 1\\ \\mathrm{Hz}$$\n\n其次，我们计算从 $10\\ \\mathrm{s}$ 记录中可以提取的 STFT 段数。窗口时长为 $L = 1\\ \\mathrm{s}$，重叠率为 $50\\%$。跳跃长度（hop size）或步长 $H$ 是连续窗口起始点之间的时间差，即窗口的非重叠部分：\n$$H = L \\times (1 - 0.50) = 0.5 \\times L = 0.5 \\times 1\\ \\mathrm{s} = 0.5\\ \\mathrm{s}$$\n设 $K$ 为分段数。第一个窗口从时间 $t_0 = 0$ 开始，覆盖区间 $[0, L]$。第 $k$ 个段（使用从1开始的索引）的起始时间是 $t_{k-1} = (k-1)H$。第 $k$ 个段覆盖的时间区间是 $[(k-1)H, (k-1)H + L]$。问题规定最后一个窗口必须完全位于记录时长 $T_{rec} = 10\\ \\mathrm{s}$ 之内。因此，对于最后一个段，即第 $K$ 段，其结束时间必须小于或等于 $T_{rec}$：\n$$(K-1)H + L \\le T_{rec}$$\n代入数值 $H = 0.5\\ \\mathrm{s}$，$L = 1\\ \\mathrm{s}$ 和 $T_{rec} = 10\\ \\mathrm{s}$：\n$$(K-1) \\times 0.5 + 1 \\le 10$$\n$$(K-1) \\times 0.5 \\le 9$$\n$$K-1 \\le \\frac{9}{0.5}$$\n$$K-1 \\le 18$$\n$$K \\le 19$$\n由于分段数 $K$ 必须是整数，因此最大分段数为 $19$。\n\n第三，我们评估分辨位于 $f_1 = 9\\ \\mathrm{Hz}$ 和 $f_2 = 10\\ \\mathrm{Hz}$ 的两个窄带频率分量的能力。这些分量之间的频率间隔是 $\\Delta f_{peaks} = |f_2 - f_1| = 1\\ \\mathrm{Hz}$。分辨两个紧密间隔的频率的能力不是由 DFT 频率箱间距 $\\Delta f$ 决定的，而是由分析窗的频谱分辨率决定的。频谱分辨率从根本上受限于窗函数傅里叶变换的主瓣宽度。这是时频不确定性原理的直接结果：更短的时间窗会导致更宽的频谱窗，意味着较差的频率分辨率。\n\n对于时长为 $L$ 的汉宁窗，其傅里叶变换呈现一个主瓣。瑞利判据（Rayleigh criterion）指出，如果一个分量的频谱峰值最大值与另一个分量的第一个最小值（零点）重合，那么这两个频率分量恰好可被分辨。对于一个经过汉宁窗加窗的正弦波，其频谱中第一个零点相对于正弦波真实频率的位置，其距离为 $\\frac{2}{L}$。因此，汉宁窗的最小可分辨频率间隔 $\\delta f_{res}$ 由下式给出：\n$$\\delta f_{res} = \\frac{2}{L}$$\n在给定的窗口时长 $L = 1\\ \\mathrm{s}$下，频谱分辨率为：\n$$\\delta f_{res} = \\frac{2}{1\\ \\mathrm{s}} = 2\\ \\mathrm{Hz}$$\n要分辨这两个峰，它们的间隔 $\\Delta f_{peaks}$ 必须大于或至少等于频谱分辨率 $\\delta f_{res}$。在本例中：\n$$\\Delta f_{peaks} = 1\\ \\mathrm{Hz} < \\delta f_{res} = 2\\ \\mathrm{Hz}$$\n由于信号的频率间隔（$1\\ \\mathrm{Hz}$）小于所选窗口能达到的频谱分辨率（$2\\ \\mathrm{Hz}$），因此位于 $9\\ \\mathrm{Hz}$ 和 $10\\ \\mathrm{Hz}$ 的两个分量无法被区分为两个独立的峰。相反，它们加窗后的频谱会显著重叠，并合并成一个更宽的单一峰，其中心位于 $9\\ \\mathrm{Hz}$ 和 $10\\ \\mathrm{Hz}$ 之间的某个位置。\n\n这说明了时频分辨率的权衡。所选的时间分辨率由窗口长度决定，即 $\\Delta t \\approx L = 1\\ \\mathrm{s}$。这一选择反过来将最佳频谱分辨率限制为 $\\delta f_{res} \\approx \\frac{2}{L} = 2\\ \\mathrm{Hz}$。为了分辨 $1\\ \\mathrm{Hz}$ 的间隔，需要将窗口时长 $L$ 增加到至少 $2\\ \\mathrm{s}$（因为 $L = 2/\\delta f_{res} = 2/1 = 2$），但这必然会使时间分辨率降低到 $\\Delta t \\approx 2\\ \\mathrm{s}$。\n\n所要求的数值答案是频率箱间距 $\\Delta f = 1\\ \\mathrm{Hz}$ 和分段数 $K = 19$。",
            "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n1 & 19\n\\end{pmatrix}\n}\n$$"
        },
        {
            "introduction": "小波分析提供了一种比固定分辨率的STFT更灵活的解决方案。本练习将从“分析”转向“设计”，要求你创建能够最优地检测不同特征（例如，慢速的θ波与快速的γ波）信号的小波。它展示了一种先进的方法，用以主动管理和适应神经信号中多尺度动态的时频分辨率需求。",
            "id": "4200814",
            "problem": "您的任务是设计并实现一个完整的程序，该程序执行基于原理的小波分析，以检测局部场电位（LFP）中的振荡事件。检测目标是 $4$ 到 $8$ Hz 范围内的 theta 爆发和 $70$ 到 $150$ Hz 范围内的高伽马事件。您的设计必须基于基本原理，通过选择每个中心频率的小波周期数，来明确地权衡时间-频率分辨率。\n\n使用复 Morlet 小波，其定义为一个中心频率的正弦波与一个时间上的高斯函数的乘积。设小波为\n$$\n\\psi(t; f_0, \\sigma_t) = \\exp(2\\pi i f_0 t)\\,\\exp\\!\\left(-\\frac{t^2}{2\\sigma_t^2}\\right),\n$$\n其中 $f_0$ 是中心频率，$\\sigma_t$ 是时间标准差。连续小波变换是信号与 $\\psi(t; f_0, \\sigma_t)$ 在适当的离散时间点上求值的卷积。通过关系式\n$$\n\\sigma_t = \\frac{n}{2\\pi f_0}.\n$$\n定义频率 $f_0$ 下的周期数 $n$。依赖高斯函数的傅里叶变换性质以及高斯窗的时频不确定性：如果 $\\sigma_t$ 是时间标准差，那么频域标准差 $\\sigma_f$ 满足\n$$\n\\sigma_f = \\frac{1}{2\\pi \\sigma_t},\n$$\n并且高斯函数在时间域和频率域的半峰全宽（FWHM）为\n$$\n\\mathrm{FWHM}_t = 2\\sqrt{2\\ln 2}\\,\\sigma_t,\\quad\n\\mathrm{FWHM}_f = 2\\sqrt{2\\ln 2}\\,\\sigma_f.\n$$\n这些关系是您必须用来推导小波设计所有约束的基础。\n\n您的程序必须：\n- 在给定的采样频率 $f_s$ 下，使用选定的中心频率 $f_0$ 的周期数 $n$，构建一个离散复 Morlet 小波。\n- 将小波与一个合成的 LFP 时间序列进行卷积。每个测试案例的该序列包含一个 theta 爆发和一个高伽马事件，每个事件都有指定的中心频率 $f_0$、持续时间和振幅。添加具有指定标准差的零均值高斯噪声。时间单位为秒，频率单位为赫兹，采样频率单位为赫兹。\n- 对复小波响应的绝对值使用幅度阈值检测器。从记录的前 $1$ 秒（不包含任何事件）估计基线均值和标准差。如果事件的真实窗口内的最大幅度超过基线均值加上 $k$ 倍基线标准差（$k=3$），则声明检测到事件。\n- 通过上述基础推导出的不等式来平衡时间和频率分辨率，从而分别为 theta 和高伽马波段选择周期数 $n$。施加以下设计约束：\n  - 时间分辨率约束：要求 $\\mathrm{FWHM}_t$ 小于或等于事件持续时间 $T$ 的一个分数 $r_t$，即 $\\mathrm{FWHM}_t \\le r_t\\,T$，其中 $r_t=0.8$。\n  - 频谱分辨率约束：要求 $\\mathrm{FWHM}_f$ 小于或等于带宽 $B$ 的一个分数 $r_f$（theta 带宽 $B_\\theta = 8-4 = 4$ Hz；高伽马带宽 $B_\\gamma = 150-70 = 80$ Hz），即 $\\mathrm{FWHM}_f \\le r_f\\,B$，其中 $r_f=0.5$。\n- 从基础公式推导出关于 $n$ 的相应边界，以 $f_0$、$T$ 和 $B$ 表示。如果约束产生一个可行的 $n$ 区间，则选择边界的算术平均值。如果区间不可行，则优先考虑可检测性，选择上界（这优先满足时间分辨率约束），并报告相应的 FWHM 值。\n\n信号构建要求：\n- 每个测试案例使用 $5$ 秒的总时长。\n- 将 theta 爆发放置在从 $t=1.5$ 秒开始到 $t=1.5+T_\\theta$ 秒结束。\n- 将高伽马事件放置在从 $t=3.0$ 秒开始到 $t=3.0+T_\\gamma$ 秒结束。\n- 将每个事件构建为其窗口内中心频率的纯正弦波，再乘以其振幅。\n- 向整个信号添加具有指定标准差的独立零均值高斯噪声。\n\n单位：\n- 时间量以秒表示，频率量以赫兹表示。您的程序必须计算并输出以秒为单位的 $\\mathrm{FWHM}_t$ 和以赫兹为单位的 $\\mathrm{FWHM}_f$。\n- 检测输出必须是整数 $0$ 或 $1$。\n\n测试套件：\n为以下所有参数集提供计算。每个元组为 $[f_\\theta, T_\\theta, A_\\theta, f_\\gamma, T_\\gamma, A_\\gamma, \\sigma_n, f_s]$，其中 $f_\\theta$ 是 theta 中心频率（赫兹），$T_\\theta$ 是 theta 持续时间（秒），$A_\\theta$ 是 theta 振幅（任意单位），$f_\\gamma$ 是 gamma 中心频率（赫兹），$T_\\gamma$ 是 gamma 持续时间（秒），$A_\\gamma$ 是 gamma 振幅（任意单位），$\\sigma_n$ 是噪声标准差， $f_s$ 是采样频率（赫兹）：\n- 案例 1：$[6.0, 1.0, 2.0, 100.0, 0.08, 1.5, 0.4, 1000.0]$。\n- 案例 2：$[5.0, 0.6, 1.5, 120.0, 0.02, 1.0, 0.6, 1000.0]$。\n- 案例 3：$[7.0, 0.3, 1.0, 90.0, 0.06, 1.2, 0.7, 1000.0]$。\n\n最终输出格式：\n对于每个案例，按以下顺序输出包含八个条目的列表：\n$[n_\\theta, n_\\gamma, \\mathrm{FWHM}_{t,\\theta}\\,(\\mathrm{s}), \\mathrm{FWHM}_{f,\\theta}\\,(\\mathrm{Hz}), d_\\theta, \\mathrm{FWHM}_{t,\\gamma}\\,(\\mathrm{s}), \\mathrm{FWHM}_{f,\\gamma}\\,(\\mathrm{Hz}), d_\\gamma]$，\n其中 $d_\\theta$ 和 $d_\\gamma$ 是分别表示 theta 和高伽马事件检测到 ($1$) 或未检测到 ($0$) 的整数。\n\n您的程序应生成单行输出，其中包含所有测试案例的结果，格式为一个用方括号括起来的逗号分隔列表，每个测试案例的列表都用方括号括起来，且没有空格。例如：$[[\\dots],[\\dots],[\\dots]]$。",
            "solution": "在进行求解之前，需要对用户提供的问题陈述进行验证。\n\n### 第 1 步：问题验证\n\n该问题要求设计并实现一个基于小波分析的程序，用于检测合成的局部场电位（LFP）数据中的振荡事件。任务的核心是基于有原理的约束，通过选择复 Morlet 小波的周期数 $n$ 来权衡时频分辨率。\n\n已知条件是：\n- 复 Morlet 小波的定义：$\\psi(t; f_0, \\sigma_t) = \\exp(2\\pi i f_0 t)\\,\\exp\\!\\left(-\\frac{t^2}{2\\sigma_t^2}\\right)$。\n- 周期数 $n$、中心频率 $f_0$ 和时间标准差 $\\sigma_t$ 之间的关系：$\\sigma_t = \\frac{n}{2\\pi f_0}$。\n- 高斯窗的时频不确定性关系：$\\sigma_f = \\frac{1}{2\\pi \\sigma_t}$。\n- 半峰全宽（FWHM）表达式：$\\mathrm{FWHM}_t = 2\\sqrt{2\\ln 2}\\,\\sigma_t$ 和 $\\mathrm{FWHM}_f = 2\\sqrt{2\\ln 2}\\,\\sigma_f$。\n- 选择 $n$ 的设计约束：$\\mathrm{FWHM}_t \\le r_t\\,T$ 和 $\\mathrm{FWHM}_f \\le r_f\\,B$，其中 $r_t, r_f, T,$ 和 $B$ 的值已指定。\n- 选择 $n$ 的规则：如果存在可行范围，则使用边界的算术平均值，否则使用应急规则。\n- 用于信号生成、检测和三个测试案例的具体参数。\n\n该问题在科学上基于标准信号处理理论，问题设定良好且客观。它是可形式化、完整且可验证的。然而，在约束条件冲突时选择 $n$ 的指令中存在一个微小但重要的逻辑不一致。问题陈述：“如果区间不可行，则优先考虑可检测性，选择上界（这有利于时间分辨率）”。该陈述包含一个科学上的不准确之处。周期数 $n$ 与时间标准差 $\\sigma_t$（即小波的持续时间）成正比，与频谱标准差 $\\sigma_f$ 成反比。因此，较大的 $n$ 会导致时间上更宽的小波，从而产生*较差*的时间分辨率，但*较好*的频谱分辨率。其理由“（这有利于时间分辨率）”错误地描述了选择较大 $n$ 的后果。\n\n这是一个缺陷。然而，它并不会使整个问题结构失效，因为问题结构在其他方面是合理的。其意图似乎是优先检测瞬态事件，而对此类事件，时间分辨率至关重要。良好的时间分辨率需要较小的 $n$。时间约束提供了 $n$ 的上界，$n \\le n_{max}$。满足此约束可确保小波不会因时间上过长而无法解析事件。因此，“选择上界”的指令被解释为选择 $n_{max}$，这在其极限处满足了时间约束。这一选择优先考虑了时间分辨率，代价是违反了频谱分辨率。这是对“优先考虑可检测性”这一目标（针对可能较短的事件）的合理解释。\n\n**结论：** 问题被判定为**有效**，但需进行纠正性解释：在不可行的情况下（$n_{min} > n_{max}$），选择值 $n=n_{max}$。尽管问题陈述中给出的理由有缺陷，但此选择满足了对检测至关重要的时间分辨率约束。\n\n### 第 2 步：基于原理的解决方案设计\n\n该解决方案是基于时频分析的基本原理和问题的具体要求而开发的。\n\n#### 周期数 $n$ 的约束推导\n\n设计的核心是基于原理选择小波周期数 $n$。此参数控制着时间分辨率和频谱分辨率之间的权衡。我们从给定的约束中推导出 $n$ 的边界。\n\n设 $C_{FWHM} = 2\\sqrt{2\\ln 2}$。\n时间和频率上的 FWHM 可以用 $n$ 和 $f_0$ 表示：\n$$ \\mathrm{FWHM}_t = C_{FWHM} \\sigma_t = C_{FWHM} \\frac{n}{2\\pi f_0} $$\n$$ \\mathrm{FWHM}_f = C_{FWHM} \\sigma_f = C_{FWHM} \\frac{1}{2\\pi \\sigma_t} = C_{FWHM} \\frac{2\\pi f_0}{2\\pi n} = C_{FWHM} \\frac{f_0}{n} $$\n\n1.  **时间分辨率约束：** 分析要求小波的时间宽度小于待检测事件的持续时间。\n    $$ \\mathrm{FWHM}_t \\le r_t\\,T $$\n    代入 $\\mathrm{FWHM}_t$ 的表达式：\n    $$ C_{FWHM} \\frac{n}{2\\pi f_0} \\le r_t\\,T \\implies n \\le \\frac{2\\pi r_t T f_0}{C_{FWHM}} $$\n    这定义了 $n$ 的上界：$n_{max} = \\frac{2\\pi r_t T f_0}{2\\sqrt{2\\ln 2}} = \\frac{\\pi r_t T f_0}{\\sqrt{2\\ln 2}}$。超过 $n_{max}$ 的 $n$ 值将导致小波在时间上过于弥散，无法解析持续时间为 $T$ 的事件。\n\n2.  **频谱分辨率约束：** 分析要求小波的频谱宽度足够窄，以区分目标频带。\n    $$ \\mathrm{FWHM}_f \\le r_f\\,B $$\n    代入 $\\mathrm{FWHM}_f$ 的表达式：\n    $$ C_{FWHM} \\frac{f_0}{n} \\le r_f\\,B \\implies n \\ge \\frac{C_{FWHM} f_0}{r_f B} $$\n    这定义了 $n$ 的下界：$n_{min} = \\frac{2\\sqrt{2\\ln 2} f_0}{r_f B}$。低于 $n_{min}$ 的 $n$ 值将导致小波的频率响应过宽，无法隔离感兴趣的频带 $B$。\n\n3.  **$n$ 的选择规则：**\n    - 如果 $n_{min} \\le n_{max}$，则存在一个可行的 $n$ 范围。问题指定选择算术平均值：$n = \\frac{n_{min} + n_{max}}{2}$。\n    - 如果 $n_{min} > n_{max}$，则约束条件相互排斥。根据我们验证过的解释，我们通过满足时间分辨率约束来优先考虑它。我们选择 $n = n_{max}$。这确保了小波在时间上足够尖锐，同时接受它在频谱上会比期望的更宽。\n\n#### 算法实现\n\n整个过程通过一个 Python 程序实现，该程序遍历所有提供的测试案例。\n\n1.  **信号生成：** 对于每个测试案例，在指定的采样频率 $f_s$ 下生成一个合成的 $5$ 秒 LFP 信号。该信号是 theta 爆发、高伽马爆发和高斯噪声的总和。\n    - 创建一个从 $0$ 到 $5$ 秒的时间向量 $t$，步长为 $1/f_s$。\n    - 用标准差为 $\\sigma_n$ 的零均值高斯噪声初始化信号。\n    - 在时间区间 $[1.5, 1.5+T_\\theta]$ 内，将频率为 $f_\\theta$、振幅为 $A_\\theta$ 的正弦波（即 theta 爆发）添加到信号中。\n    - 在时间区间 $[3.0, 3.0+T_\\gamma]$ 内，将频率为 $f_\\gamma$、振幅为 $A_\\gamma$ 的正弦波（即高伽马事件）添加到信号中。\n\n2.  **小波分析循环：** 对每个信号的 theta 和高伽马波段分别进行分析。\n    - **参数计算：** 对于每个波段（theta/gamma），使用相应的参数（$f_0, T, B$）计算 $n_{min}$ 和 $n_{max}$。然后根据上述规则选择 $n$ 的值。随后，使用选定的 $n$ 计算 $\\mathrm{FWHM}_t$ 和 $\\mathrm{FWHM}_f$。\n    - **小波构建：** 构建一个离散复 Morlet 小波。计算时间标准差 $\\sigma_t = n/(2\\pi f_0)$。在足够长的、以 $t=0$ 为中心的时间窗口（例如 $\\pm 4\\sigma_t$）上定义小波核，以捕捉其衰减。对于核窗口中的每个离散时间点 $t_k$，使用公式 $\\psi(t_k) = \\exp(2\\pi i f_0 t_k)\\,\\exp(-t_k^2 / (2\\sigma_t^2))$ 计算离散小波。\n    - **卷积：** 将合成的 LFP 信号与复 Morlet 小波进行卷积。这可以通过 `scipy.signal.convolve` 中提供的快速傅里叶变换（FFT）方法高效完成。`mode='same'` 参数确保输出与输入信号具有相同的长度。\n    - **幅度解调：** 通过取复值卷积结果的绝对值，获得滤波后信号的瞬时幅度。\n\n3.  **事件检测：** 应用幅度阈值法来检测事件。\n    - **基线估计：** 使用幅度信号的第一个秒（已知只包含噪声）来估计基线活动。计算此基线周期的均值 $\\mu_{base}$ 和标准差 $\\sigma_{base}$。\n    - **阈值设定：** 检测阈值设为 $Th = \\mu_{base} + k\\,\\sigma_{base}$，其中 $k=3$。\n    - **决策：** 识别 theta 和高伽马事件的真实时间窗口。如果相应窗口内的最大幅度超过阈值 $Th$，则将事件标记为已检测到（输出 $1$）。否则，标记为未检测到（输出 $0$）。\n\n4.  **输出格式化：** 对于每个测试案例，将所需的八个值（$n_\\theta, n_\\gamma, \\mathrm{FWHM}_{t,\\theta}, \\mathrm{FWHM}_{f,\\theta}, d_\\theta, \\mathrm{FWHM}_{t,\\gamma}, \\mathrm{FWHM}_{f,\\gamma}, d_\\gamma$）汇总到一个列表中。然后，根据规范，将所有测试案例的结果格式化为表示列表的列表的单个字符串，不含多余空格。\n\n这种基于原理的系统性方法确保分析能根据问题的约束正确地权衡时频，并为事件检测提供一个稳健的方法。",
            "answer": "```python\nimport numpy as np\nimport scipy.signal\n\ndef solve():\n    \"\"\"\n    Main function to run wavelet analysis on all test cases and print results.\n    \"\"\"\n    test_cases = [\n        # [f_theta, T_theta, A_theta, f_gamma, T_gamma, A_gamma, sigma_n, f_s]\n        [6.0, 1.0, 2.0, 100.0, 0.08, 1.5, 0.4, 1000.0],\n        [5.0, 0.6, 1.5, 120.0, 0.02, 1.0, 0.6, 1000.0],\n        [7.0, 0.3, 1.0, 90.0, 0.06, 1.2, 0.7, 1000.0],\n    ]\n\n    all_results = []\n\n    for case in test_cases:\n        f_theta, T_theta, A_theta, f_gamma, T_gamma, A_gamma, sigma_n, f_s = case\n        \n        # --- Signal Generation ---\n        total_duration = 5.0\n        t = np.arange(0, total_duration, 1.0 / f_s)\n        n_points = len(t)\n        \n        # Additive Gaussian noise\n        rng = np.random.default_rng(seed=42) # for reproducibility\n        signal = rng.normal(loc=0.0, scale=sigma_n, size=n_points)\n\n        # Add Theta burst\n        theta_start_t = 1.5\n        theta_start_idx = int(theta_start_t * f_s)\n        theta_end_idx = int((theta_start_t + T_theta) * f_s)\n        theta_t = t[theta_start_idx:theta_end_idx]\n        signal[theta_start_idx:theta_end_idx] += A_theta * np.sin(2 * np.pi * f_theta * theta_t)\n\n        # Add High-Gamma event\n        gamma_start_t = 3.0\n        gamma_start_idx = int(gamma_start_t * f_s)\n        gamma_end_idx = int((gamma_start_t + T_gamma) * f_s)\n        gamma_t = t[gamma_start_idx:gamma_end_idx]\n        signal[gamma_start_idx:gamma_end_idx] += A_gamma * np.sin(2 * np.pi * f_gamma * gamma_t)\n\n        # --- Analysis ---\n        B_theta = 4.0  # 8 - 4 Hz\n        B_gamma = 80.0 # 150 - 70 Hz\n\n        # Analyze Theta band\n        n_theta, fwhm_t_theta, fwhm_f_theta, d_theta = analyze_band(\n            signal, f_s, f_theta, T_theta, theta_start_idx, theta_end_idx, B_theta\n        )\n        \n        # Analyze Gamma band\n        n_gamma, fwhm_t_gamma, fwhm_f_gamma, d_gamma = analyze_band(\n            signal, f_s, f_gamma, T_gamma, gamma_start_idx, gamma_end_idx, B_gamma\n        )\n\n        case_result = [\n            n_theta, n_gamma, fwhm_t_theta, fwhm_f_theta, d_theta,\n            fwhm_t_gamma, fwhm_f_gamma, d_gamma\n        ]\n        all_results.append(case_result)\n\n    # Format the final output string to be a list of lists with no spaces.\n    results_str = [str(r).replace(\" \", \"\") for r in all_results]\n    print(f\"[{','.join(results_str)}]\")\n\n\ndef analyze_band(signal, f_s, f0, T, event_start_idx, event_end_idx, B):\n    \"\"\"\n    Performs wavelet analysis for a single frequency band.\n    \n    Returns:\n        tuple: (n, fwhm_t, fwhm_f, detection_flag)\n    \"\"\"\n    r_t = 0.8\n    r_f = 0.5\n    fwhm_const = 2 * np.sqrt(2 * np.log(2))\n\n    # --- Calculate n ---\n    # Temporal constraint gives n_max\n    n_max = (np.pi * r_t * T * f0) / np.sqrt(2 * np.log(2))\n    \n    # Spectral constraint gives n_min\n    n_min = (fwhm_const * f0) / (r_f * B)\n    \n    if n_min > n_max:\n        # Infeasible interval: prioritize temporal resolution by choosing n_max\n        n = n_max\n    else:\n        # Feasible interval: choose the arithmetic mean\n        n = (n_min + n_max) / 2.0\n\n    # --- Calculate FWHM values ---\n    sigma_t = n / (2 * np.pi * f0)\n    sigma_f = f0 / n\n    fwhm_t = fwhm_const * sigma_t\n    fwhm_f = fwhm_const * sigma_f\n\n    # --- Create Wavelet ---\n    # Kernel length chosen to be +/- 4 standard deviations\n    wavelet_half_len_s = 4 * sigma_t\n    wavelet_half_len_pts = int(np.ceil(wavelet_half_len_s * f_s))\n    wavelet_t = np.arange(-wavelet_half_len_pts, wavelet_half_len_pts + 1) / f_s\n    \n    gaussian_win = np.exp(-(wavelet_t**2) / (2 * sigma_t**2))\n    sinusoid = np.exp(1j * 2 * np.pi * f0 * wavelet_t)\n    wavelet = sinusoid * gaussian_win\n\n    # --- Convolution ---\n    # Use FFT-based convolution for efficiency\n    conv_result = scipy.signal.convolve(signal, wavelet, mode='same', method='fft')\n    analytic_amplitude = np.abs(conv_result)\n    \n    # --- Event Detection ---\n    # Baseline from first 1 second\n    baseline_pts = int(1.0 * f_s)\n    baseline_activity = analytic_amplitude[:baseline_pts]\n    baseline_mean = np.mean(baseline_activity)\n    baseline_std = np.std(baseline_activity)\n    \n    k = 3.0\n    threshold = baseline_mean + k * baseline_std\n    \n    # Check if max amplitude in event window exceeds threshold\n    max_event_amplitude = np.max(analytic_amplitude[event_start_idx:event_end_idx])\n    \n    detection_flag = 1 if max_event_amplitude > threshold else 0\n    \n    return n, fwhm_t, fwhm_f, detection_flag\n    \n\nif __name__ == '__main__':\n    solve()\n\n```"
        }
    ]
}