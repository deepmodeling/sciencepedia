{
    "hands_on_practices": [
        {
            "introduction": "A fundamental challenge in fMRI is that a 'volume' of data is not acquired instantaneously; each slice has a unique acquisition time within the repetition time ($T_R$). This exercise  provides practice in translating scanner acquisition details, such as the slice order and $T_R$, into a precise timing vector. Understanding how to construct this vector is the first step toward applying slice timing correction, which ensures that data from all slices are temporally aligned to a common reference point.",
            "id": "4163858",
            "problem": "A researcher is converting Digital Imaging and Communications in Medicine (DICOM) functional Magnetic Resonance Imaging (fMRI) data to Neuroimaging Informatics Technology Initiative (NIfTI) format. The data were acquired using Echo Planar Imaging (EPI) with interleaved ascending slice acquisition, single-band (no simultaneous multi-slice), and constant per-slice acquisition spacing across the repetition time. The scanner log indicates the following acquisition pattern: within each volume, slices with even index are acquired first in ascending order, followed by slices with odd index in ascending order. Consider the resulting NIfTI volume indexed by slice number from $0$ (inferior-most) to $N-1$ (superior-most). Assume the Blood Oxygenation Level Dependent (BOLD) signal is sampled once per repetition time with slice-dependent offsets, and that the total slice acquisition spans the entire repetition time.\n\nGiven:\n- Repetition time $T_R = 1.6$ seconds.\n- Number of slices $N = 16$.\n- Interleaved ascending order: $\\{0, 2, 4, \\dots, 14, 1, 3, 5, \\dots, 15\\}$ within each volume.\n\nTask:\n1. Compute the NIfTI SliceTiming vector of length $N$ in seconds, ordered by slice index from $0$ to $N-1$, where the $i$-th entry is the acquisition time offset (in seconds) of slice $i$ relative to the start of the volume.\n2. Briefly explain, starting from the definition of discrete-time sampling and the time-shift property of the Fourier transform, how slice timing correction algorithms use this vector to resample each slice’s time series to a common reference time.\n\nExpress the vector entries in seconds. Use exact values; do not round.",
            "solution": "The problem is valid as it is scientifically grounded, well-posed, objective, and contains sufficient, consistent information to derive a unique solution. The scenario described is a standard procedure in functional magnetic resonance imaging (fMRI) data preprocessing.\n\nThe overall task is to first compute the slice acquisition times for a given fMRI acquisition protocol and then explain the theoretical basis for slice timing correction.\n\n**Part 1: Computation of the SliceTiming Vector**\n\nThe problem specifies that $N=16$ slices are acquired within one repetition time, $T_R = 1.6$ seconds. The acquisition spans the entire repetition time with a constant per-slice acquisition spacing. This means the time between the acquisition of any two consecutive slices in the acquisition sequence is constant. This time interval, $\\Delta t$, can be calculated as:\n$$\n\\Delta t = \\frac{T_R}{N} = \\frac{1.6 \\, \\text{s}}{16} = 0.1 \\, \\text{s}\n$$\nThe acquisition order is specified as interleaved ascending, where all even-indexed slices are acquired first, followed by all odd-indexed slices. The slice indices range from $0$ to $N-1 = 15$. The explicit acquisition sequence, ordered by time, is therefore:\n$$\n\\{0, 2, 4, 6, 8, 10, 12, 14, 1, 3, 5, 7, 9, 11, 13, 15\\}\n$$\nThe acquisition time for a given slice is determined by its position in this sequence. Let the temporal position in the sequence be denoted by $p$, where $p$ ranges from $0$ to $N-1 = 15$. The acquisition time offset for the slice acquired at temporal position $p$ is $p \\times \\Delta t$.\n\nWe need to find the acquisition time for each slice, ordered by the slice index $i$ from $0$ to $15$. Let $t_i$ be the acquisition time for the slice with index $i$.\n\nFor even-indexed slices, $i = 2k$ where $k \\in \\{0, 1, \\dots, 7\\}$:\nThe slice with index $i=2k$ is the $(k+1)$-th slice to be acquired. Its temporal position is $p=k$.\nThus, its acquisition time is:\n$$\nt_{2k} = k \\times \\Delta t = k \\times 0.1 \\, \\text{s}\n$$\n\nFor odd-indexed slices, $i = 2k+1$ where $k \\in \\{0, 1, \\dots, 7\\}$:\nThese slices are acquired after all $N/2=8$ even slices have been acquired. The first odd slice in the sequence is index $1$ (corresponding to $k=0$), and its temporal position is $p=8$. The odd slice with index $i=2k+1$ is the $(k+1)$-th odd slice to be acquired. Its temporal position in the overall sequence is $p = (N/2) + k = 8 + k$.\nThus, its acquisition time is:\n$$\nt_{2k+1} = (8+k) \\times \\Delta t = (8+k) \\times 0.1 \\, \\text{s}\n$$\n\nUsing these formulae, we can compute the time for each slice index $i \\in \\{0, 1, \\dots, 15\\}$:\n$t_0 = 0 \\times 0.1 = 0.0$ s\n$t_1 = (8+0) \\times 0.1 = 0.8$ s\n$t_2 = 1 \\times 0.1 = 0.1$ s\n$t_3 = (8+1) \\times 0.1 = 0.9$ s\n$t_4 = 2 \\times 0.1 = 0.2$ s\n$t_5 = (8+2) \\times 0.1 = 1.0$ s\n$t_6 = 3 \\times 0.1 = 0.3$ s\n$t_7 = (8+3) \\times 0.1 = 1.1$ s\n$t_8 = 4 \\times 0.1 = 0.4$ s\n$t_9 = (8+4) \\times 0.1 = 1.2$ s\n$t_{10} = 5 \\times 0.1 = 0.5$ s\n$t_{11} = (8+5) \\times 0.1 = 1.3$ s\n$t_{12} = 6 \\times 0.1 = 0.6$ s\n$t_{13} = (8+6) \\times 0.1 = 1.4$ s\n$t_{14} = 7 \\times 0.1 = 0.7$ s\n$t_{15} = (8+7) \\times 0.1 = 1.5$ s\n\nThe NIfTI SliceTiming vector is the list of these acquisition times, ordered by slice index from $0$ to $15$.\n\n**Part 2: Principle of Slice Timing Correction**\n\nThe SliceTiming vector computed above provides the acquisition time offset $t_i$ for each slice $i$ relative to the start of the volume acquisition. Slice timing correction (STC) algorithms use this information to resample each slice's time series to a common reference time, thereby mitigating artifacts in subsequent analyses (e.g., event-related analysis) that assume all data within a volume were acquired simultaneously.\n\nThe underlying principle of STC is rooted in the concepts of discrete-time sampling and the time-shift property of the Fourier transform. The BOLD signal for any given voxel is a continuous function of time, $s(t)$. For a voxel in slice $i$, this signal is sampled at discrete time points corresponding to each volume acquisition, but with an offset $t_i$. The sampled time series for a voxel in slice $i$ across $M$ volumes is therefore $x_i[k] = s(k T_R + t_i)$, for $k=0, 1, \\dots, M-1$.\n\nThe goal of STC is to estimate the signal values as if they had been acquired at a common reference time for all slices. Let this reference time be an offset $t_{\\text{ref}}$ relative to the start of the volume (e.g., $t_{\\text{ref}}=0$ for the first slice, or $t_{\\text{ref}}=T_R/2$ for the middle of the acquisition window). We wish to find the values $x_i^{\\text{corr}}[k] = s(k T_R + t_{\\text{ref}})$. This is equivalent to shifting the original continuous signal $s(t)$ by a time $\\Delta t_i = t_{\\text{ref}} - t_i$.\n\nThe time-shift property of the continuous Fourier transform states that if a signal $f(t)$ has a Fourier transform $F(\\omega)$, then the time-shifted signal $f(t - \\tau)$ has the Fourier transform $F(\\omega) \\exp(-j\\omega\\tau)$. This property provides a direct method for performing non-integer time shifts, which are generally required for STC since the required shift $\\Delta t_i$ is not necessarily a multiple of the sampling interval $T_R$.\n\nThe STC algorithm proceeds as follows:\n1. For each voxel's time series $x_i[k]$, compute its Discrete Fourier Transform (DFT), yielding the frequency-domain representation $X_i[m]$, where $m$ is the frequency index.\n2. For each frequency component $m$, apply a phase shift. To shift the signal in time by $\\Delta t_i = t_{\\text{ref}} - t_i$, the complex value $X_i[m]$ is multiplied by a phase factor $\\exp(-j \\omega_m \\Delta t_i)$, where $\\omega_m = \\frac{2\\pi m}{M T_R}$ is the angular frequency corresponding to index $m$. The corrected frequency-domain signal is $X_i^{\\text{corr}}[m] = X_i[m] \\exp\\left(-j \\frac{2\\pi m}{M T_R} \\Delta t_i\\right)$.\n3. Compute the Inverse Discrete Fourier Transform (IDFT) of $X_i^{\\text{corr}}[m]$ to obtain the corrected time-domain signal $x_i^{\\text{corr}}[k]$. This new time series represents the BOLD signal resampled to the common reference time $t_{\\text{ref}}$.\n\nThis Fourier-based interpolation is theoretically equivalent to performing convolution with a sinc function in the time domain, which is the ideal method for resampling a band-limited signal. The SliceTiming vector is thus the critical input that specifies the required shift $\\Delta t_i$ for each slice.",
            "answer": "$$\n\\boxed{\\begin{pmatrix} 0.0 & 0.8 & 0.1 & 0.9 & 0.2 & 1.0 & 0.3 & 1.1 & 0.4 & 1.2 & 0.5 & 1.3 & 0.6 & 1.4 & 0.7 & 1.5 \\end{pmatrix}}\n$$"
        },
        {
            "introduction": "Echo Planar Imaging (EPI) is fast but suffers from geometric distortions due to magnetic field inhomogeneities, warping the brain's anatomy in the resulting images. This hands-on problem  delves into the physics of this artifact, guiding you to derive the mathematical link between off-resonance frequency ($\\Delta f$) and spatial displacement. By calculating parameters like `TotalReadoutTime` from basic sequence information, you will gain a first-principles understanding of how modern distortion correction algorithms work.",
            "id": "4163811",
            "problem": "A researcher is preparing a functional Magnetic Resonance Imaging (fMRI) dataset for susceptibility distortion correction using the Brain Imaging Data Structure (BIDS). The sequence is two-dimensional Echo Planar Imaging (EPI), and the DICOM (Digital Imaging and Communications in Medicine) header contains the following fields for a single run:\n\n- InPlanePhaseEncodingDirection = \"COL\"\n- Vendor-specific boolean field indicating blip polarity along the phase-encoding axis (negative)\n- ImageOrientationPatient direction cosines: row $(1, 0, 0)$, column $(0, 1, 0)$, slice $(0, 0, 1)$, for an axial acquisition\n- EffectiveEchoSpacing $t_{\\mathrm{esp}} = 5.8 \\times 10^{-4}$ s\n- ReconMatrixPE $N_{\\mathrm{PE}} = 96$\n- Voxel size along the phase-encoding direction $\\Delta y = 2.0$ mm\n\nAssume conversion to the Neuroimaging Informatics Technology Initiative (NIfTI) has been performed using the standard Right-Anterior-Superior (RAS) convention, where the voxel index axes $(i, j, k)$ correspond to Left–Right, Posterior–Anterior, and Inferior–Superior directions, respectively. The researcher also has an independently estimated off-resonance map providing a local frequency offset $\\Delta f$ (in hertz) due to static magnetic field inhomogeneity.\n\nStarting from first principles of EPI k-space sampling and magnetic resonance off-resonance physics, and using only the information above:\n\n1. Derive the expression for the BIDS field TotalReadoutTime $T_{\\mathrm{ro}}$ in terms of the EffectiveEchoSpacing $t_{\\mathrm{esp}}$ and the number of phase-encoding samples $N_{\\mathrm{PE}}$.\n2. Using the Fourier shift theorem and the definition of off-resonance frequency $\\Delta f$ as a constant additional angular frequency in the signal model, derive the relationship between $\\Delta f$, $T_{\\mathrm{ro}}$, and the displacement along the phase-encoding direction in voxels, and then in millimeters.\n3. Using the provided DICOM fields and orientation, justify the BIDS PhaseEncodingDirection value qualitatively (no need to report it; you must only use it to determine the axis along which displacement occurs), and explain why $T_{\\mathrm{ro}}$ and PhaseEncodingDirection are necessary and sufficient to estimate the susceptibility-induced displacement magnitude from $\\Delta f$.\n4. For a voxel with $\\Delta f = 120$ Hz, compute the displacement magnitude along the phase-encoding direction in millimeters using the derived expressions and the provided parameters. Round your final numerical answer to four significant figures. Express the final displacement in millimeters.",
            "solution": "The problem statement is scientifically grounded, well-posed, and contains sufficient, consistent information to derive the requested relationships and compute the final numerical answer. All provided parameters are physically realistic for an echo-planar imaging (EPI) sequence in fMRI. Therefore, the problem is valid and a solution can be formulated.\n\nThe solution is structured to address the four parts of the problem in sequence.\n\n## 1. Derivation of TotalReadoutTime ($T_{\\mathrm{ro}}$)\n\nThe `TotalReadoutTime`, denoted as $T_{\\mathrm{ro}}$, is a crucial parameter in the BIDS standard for describing susceptibility distortion. It is defined as the time elapsed between the acquisition of the center of the first echo and the center of the last echo in an EPI train.\n\nThe `EffectiveEchoSpacing`, denoted as $t_{\\mathrm{esp}}$, represents the time between the centers of two consecutive echoes in the phase-encoding direction. For a 2D EPI sequence, this is the time between sampling successive lines in k-space.\n\nThe `ReconMatrixPE`, denoted as $N_{\\mathrm{PE}}$, gives the total number of phase-encoding steps, which corresponds to the number of k-space lines acquired to form the image in that dimension.\n\nIf there are $N_{\\mathrm{PE}}$ echoes (or k-space lines), there are $N_{\\mathrm{PE}} - 1$ intervals between them. Since each interval has a duration of $t_{\\mathrm{esp}}$, the total time from the first to the last echo is the product of the number of intervals and the duration of each interval.\n\nTherefore, the expression for `TotalReadoutTime` is:\n$$T_{\\mathrm{ro}} = (N_{\\mathrm{PE}} - 1) \\times t_{\\mathrm{esp}}$$\n\n## 2. Derivation of the Displacement Relationship\n\nSusceptibility-induced distortion in EPI arises from local magnetic field inhomogeneities, quantified by an off-resonance frequency, $\\Delta f$. This off-resonance causes a time-dependent phase error in the measured MR signal. The signal $S$ from a spin at position $\\vec{r}$ with spin density $\\rho(\\vec{r})$ in the presence of an off-resonance $\\Delta f$ is modulated by a phase term $\\exp(-i 2\\pi \\Delta f t)$:\n$$S(t) \\propto \\rho(\\vec{r}) \\exp(-i \\phi_{\\text{spatial}}(t)) \\exp(-i 2\\pi \\Delta f t)$$\nwhere $\\phi_{\\text{spatial}}(t)$ is the phase imparted by the imaging gradients.\n\nIn EPI, k-space is traversed line by line. Let the phase-encoding direction be denoted by the $y$-axis. The time $t$ at which a k-space line is acquired is linearly proportional to its position $k_y$ along the phase-encoding axis. The phase error due to $\\Delta f$ therefore manifests as a linear phase ramp added along the $k_y$ direction in k-space.\n\nAccording to the Fourier shift theorem, a linear phase shift in the frequency domain (k-space) corresponds to a spatial shift in the image domain. Specifically, if a function $f(y)$ has a Fourier transform $F(k_y)$, then the function $f(y-y_0)$ has a Fourier transform $F(k_y) \\exp(-i k_y y_0)$.\n\nThe off-resonance term $\\exp(-i 2\\pi \\Delta f t)$ can be interpreted in this context. The time $t$ is coupled to $k_y$. Over the entire acquisition in the phase-encoding direction, which takes a total time of $T_{\\mathrm{ro}}$, the k-space is sampled. We can define a \"bandwidth per pixel\" in the phase-encoding direction, $BW_{\\mathrm{PE}}$. This is the frequency range that corresponds to the width of one voxel. $BW_{\\mathrm{PE}}$ is the reciprocal of the total time over which the phase-encoding is performed, which is the `TotalReadoutTime`:\n$$BW_{\\mathrm{PE}} = \\frac{1}{T_{\\mathrm{ro}}} = \\frac{1}{(N_{\\mathrm{PE}} - 1) t_{\\mathrm{esp}}}$$\nAn off-resonance frequency $\\Delta f$ is misinterpreted by the reconstruction algorithm as a shift. The magnitude of this shift, measured in units of voxels ($\\delta_{\\mathrm{vxl}}$), is the ratio of the off-resonance frequency to the bandwidth per pixel along that direction:\n$$\\delta_{\\mathrm{vxl}} = \\frac{\\Delta f}{BW_{\\mathrm{PE}}}$$\nSubstituting the expression for $BW_{\\mathrm{PE}}$, we get the displacement in voxels:\n$$\\delta_{\\mathrm{vxl}} = \\Delta f \\cdot T_{\\mathrm{ro}} = \\Delta f \\cdot (N_{\\mathrm{PE}} - 1) t_{\\mathrm{esp}}$$\nTo convert this displacement from voxels to a physical unit like millimeters, we multiply by the voxel size along the phase-encoding direction, $\\Delta y$:\n$$\\delta_{\\mathrm{mm}} = \\delta_{\\mathrm{vxl}} \\cdot \\Delta y = \\Delta f \\cdot T_{\\mathrm{ro}} \\cdot \\Delta y$$\nThis is the fundamental relationship between the off-resonance frequency $\\Delta f$, the total readout time $T_{\\mathrm{ro}}$, and the resulting spatial displacement in millimeters.\n\n## 3. Justification of BIDS Fields `PhaseEncodingDirection` and `TotalReadoutTime`\n\nThe problem states that the DICOM field `InPlanePhaseEncodingDirection` is `\"COL\"`. For a 2D acquisition, this means phase-encoding occurs along the columns of the image matrix. The `ImageOrientationPatient` cosines are given as row $(1, 0, 0)$ and column $(0, 1, 0)$ for an axial acquisition. In the standard NIfTI RAS (Right-Anterior-Superior) coordinate system, the image matrix axes $(i, j, k)$ typically correspond to the L-R, P-A, and I-S anatomical directions, respectively. The columns of the matrix correspond to the second dimension, the $j$-axis. Therefore, the phase-encoding is along the NIfTI $j$-axis, which aligns with the patient's Posterior-Anterior (P-A) axis. This justifies a BIDS `PhaseEncodingDirection` of `j` or `j-` (the sign depends on the blip polarity, which is given as negative, implying a `j-` direction, though the problem does not require reporting this value).\n\nThe necessity and sufficiency of `PhaseEncodingDirection` and `TotalReadoutTime` for estimating the displacement magnitude are explained as follows:\n\n- **Necessity of `PhaseEncodingDirection`**: The physical phenomenon of susceptibility-induced distortion in EPI causes pixel displacements *exclusively* along the phase-encoding direction. This is because the phase errors caused by $\\Delta f$ accumulate over the relatively long time it takes to sample the different k-space lines in the phase-encoding direction. The readout direction is sampled much faster, so time-dependent phase errors are negligible. Therefore, to model or correct this distortion, one must know the axis along which the displacements occur. `PhaseEncodingDirection` provides this critical information.\n\n- **Necessity of `TotalReadoutTime`**: As derived in Part 2, the magnitude of the displacement (in voxels) is directly proportional to $T_{\\mathrm{ro}}$. This parameter quantifies the total time window over which the off-resonance phase errors accumulate and are subsequently aliased into spatial misplacements by the Fourier transform during image reconstruction. Without $T_{\\mathrm{ro}}$, the mapping from a given off-resonance frequency $\\Delta f$ to a spatial displacement magnitude is indeterminate.\n\n- **Sufficiency**: For the purpose of *estimating the displacement magnitude*, these two parameters are sufficient. Given an off-resonance map that provides $\\Delta f$ for each voxel, `PhaseEncodingDirection` identifies the axis of displacement (e.g., the P-A axis), and `TotalReadoutTime` allows for the calculation of the magnitude of the displacement along that axis using the formula $\\delta_{\\mathrm{vxl}} = \\Delta f \\cdot T_{\\mathrm{ro}}$. This provides a complete voxel shift map, which is the basis for distortion correction.\n\n## 4. Calculation of Displacement Magnitude\n\nWe are asked to compute the displacement magnitude in millimeters for a voxel with a specific off-resonance frequency.\n\nThe given parameters are:\n- Off-resonance frequency, $\\Delta f = 120$ Hz\n- Effective echo spacing, $t_{\\mathrm{esp}} = 5.8 \\times 10^{-4}$ s\n- Number of phase-encoding steps, $N_{\\mathrm{PE}} = 96$\n- Voxel size along the phase-encoding direction, $\\Delta y = 2.0$ mm\n\nFirst, we calculate the `TotalReadoutTime`, $T_{\\mathrm{ro}}$:\n$$T_{\\mathrm{ro}} = (N_{\\mathrm{PE}} - 1) t_{\\mathrm{esp}} = (96 - 1) \\times (5.8 \\times 10^{-4} \\text{ s}) = 95 \\times 5.8 \\times 10^{-4} \\text{ s} = 0.0551 \\text{ s}$$\nNext, we use the derived relationship to calculate the displacement magnitude in millimeters, $\\delta_{\\mathrm{mm}}$:\n$$\\delta_{\\mathrm{mm}} = \\Delta f \\cdot T_{\\mathrm{ro}} \\cdot \\Delta y$$\nSubstituting the values:\n$$\\delta_{\\mathrm{mm}} = (120 \\text{ Hz}) \\cdot (0.0551 \\text{ s}) \\cdot (2.0 \\text{ mm})$$\nThe product of Hz (which is $s^{-1}$) and $s$ results in a dimensionless quantity, representing the shift in voxels:\n$$\\delta_{\\mathrm{vxl}} = 120 \\times 0.0551 = 6.612$$\nThe displacement in millimeters is then:\n$$\\delta_{\\mathrm{mm}} = 6.612 \\times 2.0 \\text{ mm} = 13.224 \\text{ mm}$$\nThe problem requires the final answer to be rounded to four significant figures.\n$$\\delta_{\\mathrm{mm}} \\approx 13.22 \\text{ mm}$$\nThis represents a significant spatial distortion of over $1.3$ cm, which is a realistic value for a region with high susceptibility gradients and a large off-resonance.",
            "answer": "$$ \\boxed{13.22} $$"
        },
        {
            "introduction": "While rigid-body realignment corrects for bulk head motion, it does not remove all motion-related artifacts from the BOLD signal, which can be non-linear and dynamic. This exercise  focuses on constructing an advanced nuisance regression model by expanding the six basic motion parameters into a 24-parameter set. This is a common and powerful technique to account for these residual effects, ensuring they are not later mistaken for task-related brain activity in your statistical model.",
            "id": "4163821",
            "problem": "You are given rigid-body head motion parameter time series extracted during functional Magnetic Resonance Imaging (fMRI) preprocessing. In standard fMRI nuisance regression, a $24$-parameter model is constructed from the original six motion parameters, their temporal derivatives, and the quadratic terms of both the original and derivative time series. Your task is to implement this construction precisely and compute the resulting design matrix for short runs, using backwards finite differences for temporal derivatives.\n\nFundamental base:\n- Motion correction estimates six parameters per volume: three translations and three rotations. Let the vector at time index $t$ (volume $t$) be $m(t) = [x(t), y(t), z(t), \\alpha(t), \\beta(t), \\gamma(t)]$, where $x$, $y$, $z$ are translations expressed in millimeters (mm) and $\\alpha$, $\\beta$, $\\gamma$ are rotations expressed in radians (rad).\n- The temporal derivative (finite difference) is defined as $\\Delta m(t) = m(t) - m(t-1)$ for $t \\ge 1$, and $\\Delta m(0) = 0$.\n- Quadratic terms are defined element-wise: for any scalar time series $u(t)$, its quadratic is $u^2(t) = (u(t))^2$.\n\nDesign matrix construction:\n- For each time index $t$, construct a row $X(t)$ of the design matrix by concatenating:\n  1. The original motion parameters $m(t)$ ($6$ regressors).\n  2. The temporal derivatives $\\Delta m(t)$ ($6$ regressors).\n  3. The element-wise squares of the original motion parameters $m^2(t)$ ($6$ regressors).\n  4. The element-wise squares of the temporal derivatives $(\\Delta m)^2(t)$ ($6$ regressors).\n- The resulting design matrix $X$ has shape $T \\times 24$ where $T$ is the number of time points (volumes).\n- Column ordering must be strictly: $[x, y, z, \\alpha, \\beta, \\gamma, \\Delta x, \\Delta y, \\Delta z, \\Delta \\alpha, \\Delta \\beta, \\Delta \\gamma, x^2, y^2, z^2, \\alpha^2, \\beta^2, \\gamma^2, (\\Delta x)^2, (\\Delta y)^2, (\\Delta z)^2, (\\Delta \\alpha)^2, (\\Delta \\beta)^2, (\\Delta \\gamma)^2]$.\n- Do not perform any centering, scaling, or normalization; keep all values in their original units (millimeters and radians).\n\nAngle units:\n- All rotational parameters must be treated in radians. No conversion is required; inputs are already specified in radians.\n\nTest suite:\nCompute $X$ for each of the following three cases. For each case, $m(t)$ is given explicitly by sequences for $x(t)$, $y(t)$, $z(t)$ in millimeters and $\\alpha(t)$, $\\beta(t)$, $\\gamma(t)$ in radians, ordered as $[x, y, z, \\alpha, \\beta, \\gamma]$ per time index $t$.\n\n- Case $1$ (happy path, $T = 5$):\n  - $x(t)$: $[0.0, 0.2, 0.4, 0.3, 0.1]$ mm\n  - $y(t)$: $[0.0, -0.1, -0.1, 0.0, 0.2]$ mm\n  - $z(t)$: $[0.0, 0.0, 0.05, 0.10, 0.10]$ mm\n  - $\\alpha(t)$: $[0.000, 0.005, 0.010, 0.010, 0.008]$ rad\n  - $\\beta(t)$: $[0.000, -0.004, -0.006, -0.005, -0.003]$ rad\n  - $\\gamma(t)$: $[0.000, 0.000, 0.001, 0.002, 0.002]$ rad\n\n- Case $2$ (boundary behavior with short run and a rotational spike, $T = 3$):\n  - $x(t)$: $[1.0, 1.5, 2.0]$ mm\n  - $y(t)$: $[0.0, 0.0, 0.0]$ mm\n  - $z(t)$: $[0.2, 0.2, 0.2]$ mm\n  - $\\alpha(t)$: $[0.01, 0.01, 0.05]$ rad\n  - $\\beta(t)$: $[0.00, 0.00, 0.00]$ rad\n  - $\\gamma(t)$: $[0.02, 0.02, 0.02]$ rad\n\n- Case $3$ (edge case, single volume $T = 1$):\n  - $x(t)$: $[0.3]$ mm\n  - $y(t)$: $[-0.2]$ mm\n  - $z(t)$: $[0.0]$ mm\n  - $\\alpha(t)$: $[0.005]$ rad\n  - $\\beta(t)$: $[-0.004]$ rad\n  - $\\gamma(t)$: $[0.0]$ rad\n\nAnswer specification:\n- For each case, compute the design matrix $X$ as specified, then flatten it in row-major order into a one-dimensional sequence of length $24 \\times T$.\n- Round each value to six decimal places.\n- Aggregate the flattened sequences for all cases by concatenation in the order Case $1$, Case $2$, Case $3$.\n- Your program should produce a single line of output containing the aggregated results as a comma-separated list enclosed in square brackets, for example, $[v_1, v_2, \\dots, v_N]$, where each $v_i$ is the rounded decimal representation of a matrix element. No additional text should be printed.\n\nAll outputs are pure numbers; translations are in millimeters and rotations are in radians as given. Angles are in radians, and no unit conversion is necessary. The final output is the concatenation of floats forming a single list.",
            "solution": "The user's problem has been validated and is determined to be a valid, well-posed problem.\n\n## Validation of the Problem Statement\n\n### Step 1: Extract Givens\n- **Motion Parameters**: Six rigid-body motion parameters are given as a time series vector $m(t) = [x(t), y(t), z(t), \\alpha(t), \\beta(t), \\gamma(t)]$ for each time index $t$, where $T$ is the total number of time points. The translations $x, y, z$ are in millimeters (mm), and the rotations $\\alpha, \\beta, \\gamma$ are in radians (rad).\n- **Temporal Derivative**: The temporal derivative is calculated using a backwards finite difference: $\\Delta m(t) = m(t) - m(t-1)$ for $t \\geq 1$.\n- **Derivative Boundary Condition**: The derivative at the first time point is defined as zero: $\\Delta m(0) = 0$.\n- **Quadratic Terms**: For any scalar time series $u(t)$, its quadratic term is defined as $u^2(t) = (u(t))^2$.\n- **Design Matrix Composition**: Each row $X(t)$ of the design matrix $X$ is formed by concatenating four sets of regressors:\n  1. Original motion parameters: $m(t)$ ($6$ regressors).\n  2. Temporal derivatives: $\\Delta m(t)$ ($6$ regressors).\n  3. Element-wise squares of original parameters: $m^2(t)$ ($6$ regressors).\n  4. Element-wise squares of temporal derivatives: $(\\Delta m)^2(t)$ ($6$ regressors).\n- **Design Matrix Structure**: The final matrix $X$ has dimensions $T \\times 24$.\n- **Column Ordering**: The $24$ columns are strictly ordered as $[x, y, z, \\alpha, \\beta, \\gamma, \\Delta x, \\Delta y, \\Delta z, \\Delta \\alpha, \\Delta \\beta, \\Delta \\gamma, x^2, y^2, z^2, \\alpha^2, \\beta^2, \\gamma^2, (\\Delta x)^2, (\\Delta y)^2, (\\Delta z)^2, (\\Delta \\alpha)^2, (\\Delta \\beta)^2, (\\Delta \\gamma)^2]$.\n- **Data Preprocessing**: No centering, scaling, or normalization is to be applied.\n- **Test Cases**: Three specific time series for $m(t)$ are provided for $T=5$, $T=3$, and $T=1$.\n- **Final Output Specification**: For each test case, the resulting design matrix $X$ must be flattened into a one-dimensional array in row-major order. The flattened arrays for all three cases must be concatenated, and each numerical value must be rounded to six decimal places. The final output is a single comma-separated list of these numbers enclosed in square brackets.\n\n### Step 2: Validate Using Extracted Givens\n- **Scientifically Grounded**: The problem is scientifically sound. The construction of a $24$-parameter head motion model is a standard and widely accepted technique in the field of fMRI data analysis for nuisance regression. This model, which includes the original motion parameters, their temporal derivatives, and the quadratic terms of both, is designed to capture a wider range of motion-related artifacts in the BOLD signal than the basic $6$-parameter model. The components account for linear displacement, dynamic \"spin-history\" effects, and non-linear relationships between motion and signal artifact. This is a core concept in fMRI preprocessing pipelines.\n- **Well-Posed**: The problem is precisely defined and admits a unique solution. The inputs, all necessary mathematical operations (finite difference, squaring), the specific boundary condition for the derivative at $t=0$, and the required structure of the output (matrix dimensions, column order, rounding, and formatting) are explicitly and unambiguously stated.\n- **Objective**: The problem is formulated in purely mathematical and computational terms, with no subjective, ambiguous, or opinion-based components.\n- **Conclusion**: A thorough check against the invalidity criteria reveals no flaws. The problem is valid.\n\n### Step 3: Verdict and Action\nThe problem is valid. A solution will be provided below.\n\n## Principle-Based Solution Design\n\nThe task is to construct a $24$-parameter design matrix for fMRI nuisance regression from a given $6$-parameter rigid-body motion time series. This process is a critical step in preprocessing fMRI data to mitigate the confounding effects of subject head motion on the blood-oxygen-level-dependent (BOLD) signal.\n\n### Theoretical Foundation\nThe BOLD signal is highly sensitive to head motion, which can introduce structured noise that may be mistaken for neural activity. A common mitigation strategy is to include estimates of head motion as regressors of no interest (nuisances) in a general linear model (GLM).\n\nThe $6$ fundamental motion parameters, $m(t)$, represent rigid-body transformations (translations and rotations) at each time point $t$. However, the relationship between motion and BOLD signal artifact is often non-linear and can depend on the motion's history. The $24$-parameter motion model expands on the basic $6$ parameters to better capture this complexity:\n1.  **Original Parameters $m(t)$**: These $6$ regressors model the direct, linear effect of head position at time $t$.\n2.  **Temporal Derivatives $\\Delta m(t)$**: These $6$ regressors, calculated as $\\Delta m(t) = m(t) - m(t-1)$, approximate the velocity of the motion. They help account for \"spin-history\" effects, where the signal at time $t$ is affected by motion in the recent past. The definition $\\Delta m(0)=0$ is a standard convention for the first time point where no prior data exists.\n3.  **Quadratic Terms $m^2(t)$**: These $6$ regressors account for non-linear relationships. For instance, motion can interact with magnetic field inhomogeneities, producing signal changes that are not linearly proportional to the displacement. Squaring the parameters provides a simple second-order model for these effects.\n4.  **Quadratic Terms of Derivatives $(\\Delta m)^2(t)$**: These final $6$ regressors model non-linear dynamic effects, capturing interactions between the velocity of motion and signal artifacts.\n\nThe resulting $24$ regressors form the columns of a design matrix $X$, where each row $X(t)$ corresponds to a time point.\n\n### Algorithmic Implementation\nThe construction of the design matrix $X$ proceeds as follows for a given motion time series spanning $T$ time points.\n\n1.  **Input Representation**: The $6$ motion parameter time series are organized into a $T \\times 6$ matrix, which we will denote as $M$. Each row $t$ of $M$ corresponds to the vector $m(t)$.\n    $$ M = \\begin{pmatrix} x(0) & y(0) & \\dots & \\gamma(0) \\\\ x(1) & y(1) & \\dots & \\gamma(1) \\\\ \\vdots & \\vdots & \\ddots & \\vdots \\\\ x(T-1) & y(T-1) & \\dots & \\gamma(T-1) \\end{pmatrix} $$\n\n2.  **Compute Temporal Derivatives**: A new $T \\times 6$ matrix, $\\Delta M$, is computed.\n    - The first row is set to zeros according to the boundary condition: $\\Delta M[0,:] = [0, 0, 0, 0, 0, 0]$.\n    - For all subsequent rows $t=1, \\dots, T-1$, the backward difference is computed: $\\Delta M[t,:] = M[t,:] - M[t-1,:]$.\n\n3.  **Compute Quadratic Terms**: Two additional $T \\times 6$ matrices are created.\n    - The matrix $M^2$ is computed by element-wise squaring of the original parameter matrix $M$.\n    - The matrix $(\\Delta M)^2$ is computed by element-wise squaring of the derivative matrix $\\Delta M$.\n\n4.  **Assemble the Design Matrix**: The final $T \\times 24$ design matrix $X$ is formed by concatenating the four $T \\times 6$ matrices column-wise in the specified order:\n    $$ X = [M \\ | \\ \\Delta M \\ | \\ M^2 \\ | \\ (\\Delta M)^2] $$\n    This assembly ensures that the columns of $X$ adhere to the strict ordering requirement provided in the problem statement.\n\n5.  **Final Output Formatting**: For each test case, the resulting $T \\times 24$ matrix $X$ is flattened into a one-dimensional vector of length $24 \\times T$ in row-major order. Each value in this vector is rounded to six decimal places. The vectors from all test cases are then concatenated sequentially to form a single, final list for output.\n\nThis procedure is applied to each of the three test cases provided.",
            "answer": "[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.2,-0.1,0.0,0.005,-0.004,0.0,0.2,-0.1,0.0,0.005,-0.004,0.0,0.04,0.01,0.0,2.5e-05,1.6e-05,0.0,0.04,0.01,0.0,2.5e-05,1.6e-05,0.0,0.4,-0.1,0.05,0.01,-0.006,0.001,0.2,0.0,0.05,0.005,-0.002,0.001,0.16,0.01,0.0025,0.0001,3.6e-05,1e-06,0.04,0.0,0.0025,2.5e-05,4e-06,1e-06,0.3,0.0,0.1,0.01,-0.005,0.002,-0.1,0.1,0.05,0.0,0.001,0.001,0.09,0.0,0.01,0.0001,2.5e-05,4e-06,0.01,0.01,0.0025,0.0,1e-06,1e-06,0.1,0.2,0.1,0.008,-0.003,0.002,-0.2,0.2,0.0,-0.002,0.002,0.0,0.01,0.04,0.01,6.4e-05,9e-06,4e-06,0.04,0.04,0.0,4e-06,4e-06,0.0,1.0,0.0,0.2,0.01,0.0,0.02,0.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.04,0.0001,0.0,0.0004,0.0,0.0,0.0,0.0,0.0,0.0,1.5,0.0,0.2,0.01,0.0,0.02,0.5,0.0,0.0,0.0,0.0,0.0,2.25,0.0,0.04,0.0001,0.0,0.0004,0.25,0.0,0.0,0.0,0.0,0.0,2.0,0.0,0.2,0.05,0.0,0.02,0.5,0.0,0.0,0.04,0.0,0.0,4.0,0.0,0.04,0.0025,0.0,0.0004,0.25,0.0,0.0,0.0016,0.0,0.0,0.3,-0.2,0.0,0.005,-0.004,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.09,0.04,0.0,2.5e-05,1.6e-05,0.0,0.0,0.0,0.0,0.0,0.0,0.0]"
        }
    ]
}